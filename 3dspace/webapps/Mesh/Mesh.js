var multiTabDecorations=function(){var t=null,e=[],i=0,r=0;this.addDecoration=function(n){t||(t=new Uint8Array(2048),e=[t]);var o=i;if(r+n.length>2048){var s=2048-r,a=r+n.length-2048;this.writeDecoration(n,0,s),r=0,t=new Uint8Array(2048),e.push(t),this.writeDecoration(n,s,a)}else this.writeDecoration(n,0,n.length);return i+=n.length,o+1},this.writeDecoration=function(e,i,n){for(var o=0;o<n;o++)t[r++]=e[i+o]},this.getConcatenatedBlocks=function(){if(0==i)return null;for(var t=new Uint8Array(i),r=0,n=0;n<e.length;n++)for(var o=0;o<2048;o++)t[r++]=e[n][o];return t}};define("DS/Mesh/Mesh",["DS/Mesh/ThreeJS_Base"],function(t){"use strict";var e=-2,i=i||{REVISION:"1"},r=new Set,n=null!=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),o=new RegExp("Edge","i").test(navigator.userAgent);i.VertexComponentEnum={POSITION:0,NORMAL:1,DIFFUSE_COLOR:2,TEX_COORD_0:3,TEX_COORD_1:4,TEX_COORD_2:5,TEX_COORD_3:6,TEX_COORD_4:7,TEX_COORD_5:8,TEX_COORD_6:9,TEX_COORD_7:10,USER_COMPONENT_0:11},i.DataTypeEnum={UCHAR:0,USHORT:1,UINT:2,CHAR:3,SHORT:4,INT:5,FLOAT:6,DOUBLE:7},i.GeomTypeString={},function(){var e,r,n=["EDGE","WIRE_EDGE","BOUNDARY_EDGE","SHARP_EDGE","SMOOTH_EDGE","HIDDEN_SEAM_EDGE","BOUNDARY_POINT","SHARP_POINT","SMOOTH_POINT","HIDDEN_SEAM_POINT","SURFACIC_POINT","FREE_POINT","INFINITE_FACE","FACE","UNKNOWN","AXIS_SYSTEM"];for(e=0;e<n.length;e++)r=n[e],i.GeomTypeString[t.GeomTypeEnum[r]]=r}(),i.sizeOfDataType=function(t){switch(t){case i.DataTypeEnum.FLOAT:case i.DataTypeEnum.INT:case i.DataTypeEnum.UINT:return 4;case i.DataTypeEnum.CHAR:case i.DataTypeEnum.UCHAR:return 1;case i.DataTypeEnum.SHORT:case i.DataTypeEnum.USHORT:return 2;case i.DataTypeEnum.DOUBLE:return 8;default:return 0}},i.ConnectivityTypeEnum={TRIANGLES:0,TRIANGLE_FAN:1,TRIANGLE_STRIP:2,LINES:3,LINE_STRIP:4,LINE_LOOP:5,POINTS:6},i.PointSymbolEnum={CROSS:0,PLUS:1,CONCENTRIC:2,COINCIDENT:3,FULLCIRCLE:4,FULLSQUARE:5,STAR:6,DOT:7,SMALLDOT:8},i.LinePatternEnum={UNKNOWN:0,SOLID:1,DOTTED:2,DASHED:3,DOTDASHED:4,PHANTOM:5,SMALLDOTTED:6,JISAXIS:7},i.NOPICKABLE=0,i.PICKABLE=1,i.PICKTHROUGH=2;var s=0;Object.defineProperty(i,"NODRAWHL",{get:function(){return s<20&&(t.getWebVisualizationLevel()>425?console.error("NODRAWHL deprecated, use PICKTHROUGH instead"):console.warn("NODRAWHL deprecated, use PICKTHROUGH instead"),s++),i.PICKTHROUGH},set:function(t){}}),i.INVISIBLE=2,i.PICK_NEVER=0,i.PICK_ALWAYS=1,i.PICK_VISIBLE=2,i.PICK_INVISIBLE=3,i.Color=function(t,e,i,r){this.r=t||0,this.g=e||0,this.b=i||0,this.a=null==r?1:r},i.Color.prototype={constructor:i.Color,setRGBA:function(t,e,i,r){this.r=t,this.g=e,this.b=i,this.a=r},copy:function(t){this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a},isEqual:function(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a},clone:function(){return new i.Color(this.r,this.g,this.b,this.a)}},i.FillAttributes=function(t,e,r){this.color=t||new i.Color,this.solid=e||this.solid||0,this.basic=r||this.basic||!1},i.FillAttributes.prototype={constructor:i.FillAttributes,isEqual:function(t){return null!==t&&this.color.isEqual(t.color)&&this.solid===t.solid&&this.basic===t.basic},clone:function(){return new i.FillAttributes(this.color.clone(),this.solid)}},i.LineAttributes=function(t,e,r){this.color=t||new i.Color,this.thickness=Math.round(e)>1?Math.round(e):1,this.pattern=r||i.LinePatternEnum.SOLID,this.forceMaterial=!1},i.LineAttributes.prototype={constructor:i.LineAttributes,isEqual:function(t){return null!==t&&this.color.isEqual(t.color)&&this.thickness===t.thickness&&this.pattern===t.pattern&&this.forceMaterial===t.forceMaterial&&(this.forceLineWidth===t.forceLineWidth||1==this.thickness)},clone:function(){return new i.LineAttributes(this.color.clone(),this.thickness,this.pattern)}},i.PointAttributes=function(t,e,r){this.color=t||new i.Color,this.size=e||1,this.symbol=r||i.PointSymbolEnum.CROSS,this.forceMaterial=!1},i.PointAttributes.prototype={constructor:i.PointAttributes,isEqual:function(t){return null!==t&&this.color.isEqual(t.color)&&this.size===t.size&&this.forceMaterial===t.forceMaterial&&this.symbol===t.symbol},clone:function(){return new i.PointAttributes(this.color.clone(),this.size,this.symbol)}};var a=new i.FillAttributes,u=new i.LineAttributes,l=new i.PointAttributes;i.PrimitiveGroup=function(t){this.identifier=0,this.nbPrimitives=0,this.primitives=[],this.nbBuffers=0,this.buffers=[],this.material=null,this.fillAttr=a,this.lineAttr=u,this.pointAttr=l,this.noz=!1,this.editable=!1,t&&(void 0!==t.fillGAS&&(this.fillAttr=t.fillGAS),void 0!==t.lineGAS&&(this.lineAttr=t.lineGAS),void 0!==t.pointGAS&&(this.pointAttr=t.pointGAS),void 0!==t.identifier&&(this.identifier=t.identifier),void 0!==t.editable&&(this.editable=t.editable),void 0!==t.noz&&(this.noz=t.noz))},i.PrimitiveGroup.prototype={constructor:i.PrimitiveGroup,addPrimitive:function(t){return this.primitives.push(t),this.nbPrimitives++,this},addBuffer:function(t,e){return this.buffers[t]=e,this.nbBuffers++,this},removeBuffer:function(t){this.buffers[t]=null,this.nbBuffers--},getBuffer:function(t){var e;for(e in this.buffers){var i=this.buffers[e];if(i.component===t)return i}return null},getBufferFromId:function(t){var e=this.buffers[t];return void 0!==e?e:null}},i.Buffer=function(t){this.indexBuffer=!1,this.size=0,this.component=i.VertexComponentEnum.POSITION,this.format=i.DataTypeEnum.FLOAT,this.dimension=3,this.data=null,t&&(t.indexBuffer&&(this.indexBuffer=!0),void 0!==t.component&&(this.component=t.component),void 0!==t.format&&(this.format=t.format),t.dimension&&(this.dimension=t.dimension),t.data&&(this.data=t.data))},i.Primitive=function(t){this.identifier=0,this.nbIndices=0,this.connectivity=i.ConnectivityTypeEnum.TRIANGLES,this.nbVertexComponents=0,this.geomType=null,this.vertexComponents=[],this.attr=null,this.material=null,t&&(void 0!==t.nbIndices&&(this.nbIndices=t.nbIndices),void 0!==t.connectivity&&(this.connectivity=t.connectivity),void 0!==t.geomType&&(this.geomType=t.geomType),void 0!==t.identifier&&(this.identifier=t.identifier),(t.fillGAS||t.lineGAS||t.pointGAS)&&(this.attr||(this.attr={fill:a,line:u,point:l}),t.fillGAS&&(this.attr.fill=t.fillGAS),t.lineGAS&&(this.attr.line=t.lineGAS),t.pointGAS&&(this.attr.point=t.pointGAS)))},i.Primitive.prototype={constructor:i.Primitive,addVertexComponent:function(t){return this.vertexComponents.push(t),this.nbVertexComponents++,this},_usedVertexColor:function(){for(var t=0;t<this.vertexComponents.length;t++)if(2==this.vertexComponents[t].component)return this.vertexComponents[t];return!1}},i.VertexComponent=function(t){this.component=i.VertexComponentEnum.POSITION,this.nbVertices=0,this.nbValuesPerVertex=0,this.format=i.DataTypeEnum.FLOAT,this.cardinality=0,this.bufferId="",this.offset=0,this.indices=null,t&&(void 0!==t.nbVertices&&(this.nbVertices=t.nbVertices),void 0!==t.cardinality&&(this.cardinality=t.cardinality),void 0!==t.bufferId&&(this.bufferId=t.bufferId),void 0!==t.indices&&(this.indices=t.indices),void 0!==t.offset&&(this.offset=t.offset))},i.IndexArray=function(t){this.format=i.DataTypeEnum.UINT,this.bufferId="",this.offset=0,t&&(void 0!==t.bufferId&&(this.bufferId=t.bufferId),void 0!==t.offset&&(this.offset=t.offset))},i.Material=function(){this.type="material",this.identifier=0,this.colorAmbient=[],this.colorDiffuse=[],this.colorSpecular=[],this.shininess=0,this.ambientCoef=0,this.diffuseCoef=0,this.specularCoef=0,this.transparent=0,this.reflectivityCoef=0,this.textureId=-1,this.textureImageNumberComposante=0,this.textureBlending=t.TextureBlendOperations.BLEND,this.magFilter=0,this.minFilter=0,this.mappingFunction=0,this.textureWrapS=0,this.textureWrapT=0,this.addedComposantInTexEnv=0,this.shaderMaterial=null},i.Material.prototype={constructor:i.Material,clone:function(){return new i.Material}},i.SGNode=function(t){this.type=0,this.modelIdentification=null,t?(this.cgmId=void 0!==t.cgmId?t.cgmId:-1,void 0!==t.parent?this.parents=[t.parent]:void 0!==t.parents?this.parents=t.parents.slice():this.parents=[],this.solid=void 0!==t.solid&&t.solid):(this.cgmId=-1,this.parents=[],this.solid=!1)},i.SGNode.prototype={constructor:i.SGNode,getModelIdentification:function(){return this.modelIdentification},setModelIdentification:function(t){this.modelIdentification=t},getIdentificationObject:function(){return this.modelIdentification},setIdentificationObject:function(t){this.modelIdentification=t}},Object.defineProperty(i.SGNode.prototype,"parent",{get:function(){return this.parents.length?this.parents[0]:null},set:function(t){this.parents[0]=t}}),i.ThicknessTable=[1,1,2,3,4,5,6,7,8],i.GraphicAttributeSet=function(t,e){this.set=t||0,this.rgba=e||0},i.GraphicAttributeSet.prototype={constructor:i.GraphicAttributeSet,setConnectivity:function(t){var e;switch(t){case i.ConnectivityTypeEnum.POINTS:this.set=4278194171&this.set,e=0;break;case i.ConnectivityTypeEnum.LINES:case i.ConnectivityTypeEnum.LINE_STRIP:case i.ConnectivityTypeEnum.LINE_LOOP:this.set=268435451&this.set,e=1;break;case i.ConnectivityTypeEnum.TRIANGLES:case i.ConnectivityTypeEnum.TRIANGLE_STRIP:case i.ConnectivityTypeEnum.TRIANGLE_FAN:case i.ConnectivityTypeEnum.TRIANGLE_FAN:e=2,this.set=251662335&this.set;break;default:e=2}this.set&=-4,this.set|=3&e},isEqual:function(t){return this.set==t.set&&this.rgba==t.rgba},getBlankingRep:function(){var t=this.getPriority();this.set=0,this.rgba=0,this.setConnectivity(2),this.setPriority(t),this.setBasic(),this.set&=-4194305,this.set|=1<<22},setColor:function(t){this.set&=~(15<<24),this.set|=(15&t)<<24},setSymbol:function(t){this.set&=268435455,this.set|=(15&t)<<28},setRGBAColorRGBChannel:function(t,e,i){this.rgba&=255,this.rgba|=(16777215&(t<<16|e<<8|i))<<8},setRGBAColorAlphaChannel:function(t){this.rgba&=-256,this.rgba|=255&t},setLinetype:function(t){this.set&=-3932161,this.set|=(15&t)<<18},setPriority:function(t){this.set&=-3841,this.set|=(15&t)<<8},setBasic:function(){this.set&=-5,this.set|=4},setVertexColor:function(){this.set&=-8388609,this.set|=1<<23},setType:function(t){this.set&=-49,this.set|=(3&t)<<4},setShowMode:function(t){this.set&=-9,this.set|=(1&t)<<3},setLineThickness:function(t){this.set&=-258049,this.set|=(63&t)<<12},getColor:function(){return this.set>>24&15},getSymbol:function(){return this.set>>28&15},getRGBAColor:function(){var t=[];return t[0]=this.rgba>>24&255,t[1]=this.rgba>>16&255,t[2]=this.rgba>>8&255,t[3]=255&this.rgba,t},getDisplayedColor:function(){if(15==this.getColor())return this.getRGBAColor();var t=[];switch(this.getColor()){case 14:case 13:t[0]=0,t[1]=0,t[2]=0,t[3]=255;break;case 12:t[0]=62,t[1]=102,t[2]=85,t[3]=255;break;case 11:case 10:t[0]=255,t[1]=128,t[2]=0,t[3]=255;break;case 9:t[0]=0,t[1]=0,t[2]=0,t[3]=255;break;case 8:t[0]=255,t[1]=255,t[2]=255,t[3]=255;break;case 7:t[0]=255,t[1]=0,t[2]=0,t[3]=255;break;case 6:t[0]=0,t[1]=255,t[2]=0,t[3]=255;break;case 5:t[0]=0,t[1]=0,t[2]=255,t[3]=255;break;case 4:t[0]=255,t[1]=255,t[2]=0,t[3]=255;break;case 3:t[0]=255,t[1]=0,t[2]=255,t[3]=255;break;case 2:t[0]=0,t[1]=255,t[2]=255,t[3]=255;break;case 1:t[0]=0,t[1]=255,t[2]=0,t[3]=255;break;case 0:t[0]=255,t[1]=0,t[2]=0,t[3]=255;break;default:t[0]=0,t[1]=0,t[2]=0,t[3]=255}return t},getAdvancedLinetype:function(){return 64*(this.set>>12&63)+(this.set>>18&63)},getLinetype:function(){return this.set>>18&15},getLineThickness:function(){var t=this.set>>12&63;return t=t>i.ThicknessTable.length?1:i.ThicknessTable[t]},isBackgroundColor:function(){return 14==(this.set>>24&15)},getType:function(){return this.set>>4&3},getPriority:function(){return this.set>>8&15},getSymbol:function(){return this.set>>28&15},isNoZ:function(){return 0==this.getType()},isSolid:function(){return 3==this.getType()?1:0},isHidden:function(){return this.set>>3&1},isTransparent:function(){return this.set>>7&1},clone:function(){return new i.GraphicAttributeSet(this.set,this.rgba)}},i.SGBag=function(t){i.SGNode.call(this,t),t=t||{},this.type=1,this.matrix=void 0!==t.matrix?t.matrix:null,this.children=void 0!==t.children?t.children:[],this.namingContext=void 0!==t.namingContext?t.namingContext:0,this.uuid_1=void 0!==t.uuid_1?t.uuid_1:null,this.uuid_2=void 0!==t.uuid_2?t.uuid_2:null,this.uuid_3=void 0!==t.uuid_3?t.uuid_3:null,this.uuid_4=void 0!==t.uuid_4?t.uuid_4:null,this.noShow=void 0!==t.noShow&&t.noShow},i.SGBag.prototype=Object.create(i.SGNode.prototype),i.SGBag.prototype.constructor=i.SGBag,i.SGBag.prototype.childClone=function(){var t=new Array;for(var e in this.children)t[e]="object"==typeof this.children[e]?this.children[e].clone():this.children[e];return t},i.SGBag.prototype.clone=function(){return new i.SGBag({cgmId:this.cgmId,type:this.type,children:this.childClone(),matrix:null!==this.matrix?this.matrix.clone():null,parents:this.parents,solid:this.solid,uuid_1:this.uuid_1,uuid_2:this.uuid_2,uuid_3:this.uuid_3,uuid_4:this.uuid_4,noShow:this.noShow})},i.SGBag.prototype.copyNoChildren=function(t){this.cgmId=t.cgmId,this.matrix=t.matrix,this.parents=t.parents.slice(),this.solid=t.solid,this.namingContext=t.namingContext,this.noShow=t.noShow,t.uuid_1&&(this.uuid_1=t.uuid_1,this.uuid_2=t.uuid_2,this.uuid_3=t.uuid_3,this.uuid_4=t.uuid_4)},i.SGBag.prototype.computeBoundingSphere=function(e){var i,r=new t.Sphere;for((e=e||new t.Sphere).reset(),i=0;i<this.children.length;i++)this.children[i].computeBoundingSphere(r),r.mergeWithSphere(e,e);return e},i.SGBag.prototype._computeOrientedBoundingBox=function(e,i,r,n,o){for(var s,a=new t.Box3,u=0;u<this.children.length;u++){(s=this.children[u]._computeOrientedBoundingBox(e,i,r,n,o))&&(a=a.union(s))}return a},i.UUID=function(){this.uuid_1=0,this.uuid_2=0,this.uuid_3=0,this.uuid_4=0},i.UUID.prototype={constructor:i.UUID,setFromUint32:function(t,e,i,r){this.uuid_1=t,this.uuid_2=e,this.uuid_3=i,this.uuid_4=r},toString:function(){return this.uuid_1.toString(16)+"_"+this.uuid_2.toString(16)+"_"+this.uuid_3.toString(16)+"_"+this.uuid_4.toString(16)},isEqual:function(t){return this.uuid_1===t.uuid_1&&this.uuid_2===t.uuid_2&&this.uuid_3===t.uuid_3&&this.uuid_4===t.uuid_4},clone:function(){var t=new i.UUID;return t.uuid_1=this.uuid_1,t.uuid_2=this.uuid_2,t.uuid_3=this.uuid_3,t.uuid_4=this.uuid_4,t}},i.SGRep=function(t){i.SGNode.call(this,t),this.type=2,t?(this.matrix=void 0!==t.matrix?t.matrix:null,this._primitives=void 0!==t.primitives?t.primitives:[],this.boundingSphere=void 0!==t.boundingSphere?t.boundingSphere:null,this.sag=void 0!==t.sag?t.sag:null,this.namingContext=void 0!==t.namingContext?t.namingContext:0):(this.matrix=null,this._primitives=[],this.boundingSphere=null,this.sag=null,this.namingContext=0),this._binary=!1},i.SGRep.prototype=Object.create(i.SGNode.prototype),Object.assign(i.SGRep.prototype,{constructor:i.SGRep,primitivesClone:function(){for(var t=[],e=0;e<this._primitives.length;e++){var i=this._primitives[e];i.clone?t.push(i.clone()):t.push(i)}return t},clone:function(){var t=new i.SGRep({cgmId:this.cgmId,type:this.type,primitives:this.primitivesClone(),matrix:this.matrix?this.matrix.clone():null,parent:this.parent,solid:this.solid,sag:this.sag,boundingSphere:this.boundingSphere?{radius:this.boundingSphere.radius,center:[this.boundingSphere.center[0],this.boundingSphere.center[1],this.boundingSphere.center[2]]}:null});return t._binary=this._binary,t},_getIndex:function(t){var e={ind:-1,subInd:-1};if(!this._binary)return e.ind=t,e;for(var i=0,r=0;r<this._primitives.length;r++){var n=this._primitives[r];if(t<i+n.count){e.ind=r,e.subInd=t-i+n.start;break}i+=n.count}return e},getPrimitiveCgmId:function(t){var e=this._getIndex(t),i=this._primitives[e.ind];return-1!==e.subInd?i.binary.getPrimitiveCgmId(e.subInd):i.cgmId},_setPrimitiveCgmId:function(t,e){var i=this._getIndex(e),r=this._primitives[i.ind];-1===i.subInd?r.cgmId=t:r.binary._setPrimitiveCgmId(t,i.subInd)},getPrimitiveType:function(t){var e=this._getIndex(t),i=this._primitives[e.ind];return-1!==e.subInd?i.binary.getPrimitiveType(e.subInd):i.type},_getSGPrimitive:function(t,e){var i=this._getIndex(t),r=this._primitives[i.ind];return-1!==i.subInd?r.binary._getSGPrimitive(i.subInd,e):e?r:r.clone()},_getPrimitiveInternalNode:function(t){var e=this._getIndex(t),i=this._primitives[e.ind];return-1!==e.subInd?i.binary._getPrimitiveInternalNode(e.subInd):i.internalNode},_setPrimitiveRep:function(t,e){var i=this._getIndex(e),r=this._primitives[i.ind];-1===i.subInd?r.rep=t:r.binary._setPrimitiveRep(t,i.subInd)},_setPrimitiveInternalNode:function(t,e){var i=this._getIndex(e),r=this._primitives[i.ind];-1===i.subInd?r.internalNode=t:r.binary._setPrimitiveInternalNode(t,i.subInd)},getPrimitiveRep:function(t){var e=this._getIndex(t),i=this._primitives[e.ind];return-1!==e.subInd?i.binary.getPrimitiveRep(e.subInd):i.rep},_setPrimitiveStart:function(t,e){var i=this._getIndex(e),r=this._primitives[i.ind];-1===i.subInd?r.start=t:r.binary._setPrimitiveStart(t,i.subInd)},_setPrimitiveCount:function(t,e){var i=this._getIndex(e),r=this._primitives[i.ind];-1===i.subInd?r.count=t:r.binary._setPrimitiveCount(t,i.subInd)},getPrimitiveStart:function(t){var e=this._getIndex(t),i=this._primitives[e.ind];return-1!==e.subInd?i.binary.getPrimitiveStart(e.subInd):i.start},getPrimitiveCount:function(t){var e=this._getIndex(t),i=this._primitives[e.ind];return-1!==e.subInd?i.binary.getPrimitiveCount(e.subInd):i.count},getPrimitiveGroup:function(t){var e=this._getIndex(t),i=this._primitives[e.ind];return-1!==e.subInd?i.binary.getPrimitiveGroup(e.subInd):i.group},getPrimitiveDecoration:function(t){var e=this._getIndex(t),i=this._primitives[e.ind];return-1!==e.subInd?i.binary.getPrimitiveDecoration(e.subInd):i.decoration},getPrimitiveBoundingSphere:function(t){var e=this._getIndex(t),i=this._primitives[e.ind];return-1!==e.subInd?i.binary.getPrimitiveBoundingSphere(e.subInd):i.boundingSphere},setPrimitiveBoundingSphere:function(t,e){var i=this._getIndex(t),r=this._primitives[i.ind];-1===i.subInd?r.boundingSphere=e:r.binary.setPrimitiveBoundingSphere(i.subInd,e)},getPrimitivesCount:function(){if(!this._binary)return this._primitives.length;for(var t=0,e=0;e<this._primitives.length;e++){t+=this._primitives[e].count}return t},getPrimitiveIdentificationObject:function(t){var e=this._getIndex(t),i=this._primitives[e.ind];return-1!==e.subInd?i.binary.getPrimitiveIdentificationObject(e.subInd):i.IdentObj},setPrimitiveIdentificationObject:function(t,e){var i=this._getIndex(e),r=this._primitives[i.ind];-1!==i.subInd&&r.binary.setPrimitiveIdentificationObject(t,i.subInd),r.IdentObj=t},computePrimitiveBoundingSphere:function(t){var e=this._getIndex(t),i=this._primitives[e.ind];return-1!==e.subInd?i.binary.computePrimitiveBoundingSphere(e.subInd):i.computeBoundingSphere()},startIteration:function(){return!0},endIteration:function(){return!0},computeBoundingSphere:function(e){if(!this.boundingSphere){this.boundingSphere=new t.Sphere;var i,r,n,o=new t.Sphere;for(i=0;i<this._primitives.length;i++)if(this._binary)for(n=(r=this._primitives[i]).start;n<r.start+r.count;n++)r.binary.computePrimitiveBoundingSphere(n,o),o.mergeWithSphere(this.boundingSphere,this.boundingSphere);else this._primitives[i].computeBoundingSphere(o),o.mergeWithSphere(this.boundingSphere,this.boundingSphere)}return e?(e.copy(this.boundingSphere),e):this.boundingSphere},_computeOrientedBoundingBox:function(e,i,r,n,o){var s,a,u,l,c=new t.Box3;for(s=0;s<this._primitives.length;s++)if(l=this._primitives[s],this._binary)for(a=l.start;a<l.start+l.count;a++)null!==(u=l.binary._computePrimitiveOrientedBoundingBox(a,e,i,r,n,o))&&(c=c.union(u));else null!==(u=l._computeOrientedBoundingBox(e,i,r,n,o))&&(c=c.union(u));return c},_computePrimitiveOrientedBoundingBox:function(t,e,i,r,n,o){var s=this._getIndex(t),a=this._primitives[s.ind];return-1!==s.subInd?a.binary._computePrimitiveOrientedBoundingBox(s.subInd,e,i,r,n,o):a._computeOrientedBoundingBox(e,i,r,n,o)}});var c=0;Object.defineProperty(i.SGRep.prototype,"primitives",{get:function(){if(c<10){var t=new Error,e="#PrimApi - SGRep.GetPrimitives - "+(t.stack?t.stack.split("\n")[1]+" - "+t.stack.split("\n")[2]:"");r.has(e.hashCode())||(r.add(e.hashCode()),console.error(e),c++)}return this._primitives},set:function(){throw"NO"}}),i.BinarySGPrimitiveArray=function(t,e,i,r,n){this.data=t,this.size=n,this.sgRep=i,this.dg=e,this.bSpheres=r||null,this.IdentObj=[],this.internalNodes=[]},i.BinarySGPrimitiveArray.prototype.constructor=i.BinarySGPrimitiveArray,i.BinarySGPrimitiveArray.prototype.clone=function(){return new i.BinarySGPrimitiveArray(this.data.slice(),this.dg,this.sgRep,this.bSpheres?this.bSpheres.slice():null,this.size)},i.BinarySGPrimitiveArray.prototype._compactArrays=function(){var t=this.IdentObj;this.IdentObj=new Array(t.length);for(var e=0;e<t.length;e++)this.IdentObj[e]=t[e];var i=this.internalNodes;this.internalNodes=new Array(i.length);for(e=0;e<i.length;e++)this.internalNodes[e]=i[e]},i.BinarySGPrimitiveArray.prototype._getSGPrimitive=function(t,e){var r=this.size*t,n=this.data,o=n[r]-1,s=this.getPrimitiveRep(t),a=n[r+2],u=n[r+3],l=n[r+4],c=this.getPrimitiveBoundingSphere(t),h=new i.SGPrimitive;return h.decoration=l,h.group=this.dg,h.rep=s,h.count=u,h.start=a,h.cgmId=o,h.boundingSphere=c,h},i.BinarySGPrimitiveArray.prototype.getPrimitiveCgmId=function(t){var e=this.size*t;return this.data[e]-1},i.BinarySGPrimitiveArray.prototype._setPrimitiveCgmId=function(t,e){if("number"!=typeof t)throw"Cgmid must be a number";var i=this.size*e;this.data[i]=t+1},i.BinarySGPrimitiveArray.prototype.getPrimitiveType=function(t){return 3},i.BinarySGPrimitiveArray.prototype._getPrimitiveInternalNode=function(t){return this.internalNodes[t]},i.BinarySGPrimitiveArray.prototype._setPrimitiveInternalNode=function(t,e){0===this.internalNodes.length&&(this.internalNodes=new Array(this.getPrimitivesCount())),this.internalNodes[e]=t},i.BinarySGPrimitiveArray.prototype._setPrimitiveRep=function(t,e){var i=this.sgRep.indexOf(t);i>=0?this.data[this.size*e+1]=i:(this.sgRep.push(t),this.data[this.size*e+1]=this.sgRep.length-1)},i.BinarySGPrimitiveArray.prototype.getPrimitiveRep=function(t){var e=this.data[this.size*t+1];return this.sgRep[e]},i.BinarySGPrimitiveArray.prototype.getPrimitiveStart=function(t){var e=this.size*t;return this.data[e+2]},i.BinarySGPrimitiveArray.prototype.getPrimitiveGroup=function(t){return this.dg},i.BinarySGPrimitiveArray.prototype._setPrimitiveStart=function(t,e){var i=this.size*e;this.data[i+2]=t},i.BinarySGPrimitiveArray.prototype.getPrimitiveCount=function(t){var e=this.size*t;return this.data[e+3]},i.BinarySGPrimitiveArray.prototype._setPrimitiveCount=function(t,e){var i=this.size*e;this.data[i+3]=t},i.BinarySGPrimitiveArray.prototype.getPrimitiveDecoration=function(t){var e=this.size*t;return this.data[e+4]},i.BinarySGPrimitiveArray.prototype.getPrimitiveBoundingSphere=function(e){if(null!==this.bSpheres){var i=new t.Sphere;return i.setSimple(this.bSpheres[4*e],this.bSpheres[4*e+1],this.bSpheres[4*e+2],this.bSpheres[4*e+3]),i.radius>=0?i:null}return null},i.BinarySGPrimitiveArray.prototype._computePrimitiveOrientedBoundingBox=function(t,e,i,r,n,o){return this.dg._computeOrientedBoundingBox(e,i,r,n,this.getPrimitiveStart(t),this.getPrimitiveCount(t),o)},i.BinarySGPrimitiveArray.prototype.setPrimitiveBoundingSphere=function(t,e){null===this.bSpheres&&(this.bSpheres=new Float32Array(4*this.getPrimitivesCount()),this.bSpheres.fill(-1)),null===e?(this.bSpheres[4*t]=-1,this.bSpheres[4*t+1]=-1,this.bSpheres[4*t+2]=-1,this.bSpheres[4*t+3]=-1):(this.bSpheres[4*t]=e.center.x,this.bSpheres[4*t+1]=e.center.y,this.bSpheres[4*t+2]=e.center.z,this.bSpheres[4*t+3]=e.radius)},i.BinarySGPrimitiveArray.prototype.getPrimitivesCount=function(){return this.data.length/this.size},i.BinarySGPrimitiveArray.prototype.getPrimitiveIdentificationObject=function(t){return this.IdentObj[t]},i.BinarySGPrimitiveArray.prototype.setPrimitiveIdentificationObject=function(t,e){0===this.IdentObj.length&&(this.IdentObj=new Array(this.getPrimitivesCount())),this.IdentObj[e]=t},i.BinarySGPrimitiveArray.prototype.computePrimitiveBoundingSphere=function(e,i){var r=this.getPrimitiveStart(e),n=this.getPrimitiveCount(e);if(0!=n){var o=this.dg.geometry,s=0,a=(e=o.vertexIndexArray[r],new t.Vector3);o.getVertexPosition(e,a);for(var u=a.x,l=a.y,c=a.z,h=u,p=l,d=c,m=1;m<n;++m){e=o.vertexIndexArray[r+m],o.getVertexPosition(e,a),(x=a.x)<u?u=x:x>h&&(h=x),(b=a.y)<l?l=b:b>p&&(p=b),(y=a.z)<c?c=y:y>d&&(d=y)}var g=(u+h)/2,v=(l+p)/2,f=(c+d)/2;for(s=0,m=0;m<n;++m){e=o.vertexIndexArray[r+m],o.getVertexPosition(e,a);var y,x=a.x,b=a.y,A=((y=a.z)-f)*(y-f)+(b-v)*(b-v)+(x-g)*(x-g);A>s&&(s=A)}return s=Math.sqrt(s),(i=i||new t.Sphere).setSimple(g,v,f,s),i}},i.SGPrimitive=function(t){this.type=3,this.IdentObj=null,this.internalNode=null,t?(this.cgmId=void 0!==t.cgmId?t.cgmId:-1,this.rep=void 0!==t.rep?t.rep:null,this.group=void 0!==t.group?t.group:null,this.start=void 0!==t.start?t.start:0,this.count=void 0!==t.count?t.count:0,this.boundingSphere=void 0!==t.boundingSphere?t.boundingSphere:void 0,this.decoration=void 0!==t.decoration?t.decoration:0):(this.cgmId=-1,this.rep=null,this.group=null,this.start=0,this.count=0,this.boundingSphere=void 0,this.decoration=0)},i.SGPrimitive.prototype={constructor:i.SGPrimitive,getIdentificationObject:function(){return this.IdentObj},setIdentificationObject:function(t){this.IdentObj=t},isEqual:function(t){return this.getGroup()===t.getGroup()&&this.getRep()===t.getRep()&&this.getStart()===t.getStart()&&this.getCount()===t.getCount()&&this.getCgmId()===t.getCgmId()},computeBoundingSphere:function(e){e=e||new t.Sphere;var i=this.start,r=this.count;if(0!=r){var n=this.group.geometry,o=n.vertexIndexArray,s=0,a=o[i],u=new t.Vector3;n.getVertexPosition(a,u);for(var l=u.x,c=u.y,h=u.z,p=l,d=c,m=h,g=1;g<r;++g){a=o[i+g],n.getVertexPosition(a,u),(b=u.x)<l?l=b:b>p&&(p=b),(A=u.y)<c?c=A:A>d&&(d=A),(x=u.z)<h?h=x:x>m&&(m=x)}var v=(l+p)/2,f=(c+d)/2,y=(h+m)/2;for(s=0,g=0;g<r;++g){a=o[i+g],n.getVertexPosition(a,u);var x,b=u.x,A=u.y,I=((x=u.z)-y)*(x-y)+(A-f)*(A-f)+(b-v)*(b-v);I>s&&(s=I)}return s=Math.sqrt(s),e.setSimple(v,f,y,s),e}},_computeOrientedBoundingBox:function(t,e,i,r,n){return this.group._computeOrientedBoundingBox(t,e,i,r,this.start,this.count,n)},getCgmId:function(){return this.cgmId},_setCgmId:function(t){this.cgmId=t},getType:function(){return this.type},_getInternalNode:function(){return this.internalNode},_setInternalNode:function(t){this.internalNode=t},getRep:function(){return this.rep},getStart:function(){return this.start},getCount:function(){return this.count},getGroup:function(){return this.group},getDecoration:function(){return this.decoration},getBoundingSphere:function(){return this.boundingSphere},startIteration:function(){return this.group.startIteration()},endIteration:function(){return this.group.endIteration()},_copyPrimitive:function(t){this.cgmId=t.cgmId,this.rep=t.rep,this.group=t.group,this.start=t.start,this.count=t.count,this.boundingSphere=t.boundingSphere?{radius:t.boundingSphere.radius,center:[t.boundingSphere.center[0],t.boundingSphere.center[1],t.boundingSphere.center[2]]}:void 0,this.decoration=t.decoration},clone:function(){var t=new i.SGPrimitive;return t._copyPrimitive(this),t}},i.SGPrimitiveHelper=function(){this.container=null,this.index=-1},i.SGPrimitiveHelper.prototype={constructor:i.SGPrimitiveHelper,clone:function(){var t=new i.SGPrimitiveHelper;return t.set(this.container,this.index),t},set:function(t,e){if(!t instanceof i.DrawingGroup||!t instanceof i.SGRep)throw"Error: container must be a Mesh.DrawingGroup or Mesh.SGRep";this.container=t,this.index=e},isEqual:function(t){return this.getGroup()===t.getGroup()&&this.getRep()===t.getRep()&&this.getStart()===t.getStart()&&this.getCount()===t.getCount()&&this.getCgmId()===t.getCgmId()},getCgmId:function(){return this.container.getPrimitiveCgmId(this.index)},_setCgmId:function(t){this.container._setPrimitiveCgmId(t,this.index)},getType:function(){return this.container.getPrimitiveType(this.index)},_getSGPrimitive:function(t){return this.container._getSGPrimitive(this.index,t)},_getInternalNode:function(){return this.container._getPrimitiveInternalNode(this.index)},_setInternalNode:function(t){this.container._setPrimitiveInternalNode(t,this.index)},_setRep:function(t){return this.container._setPrimitiveRep(t,this.index)},getRep:function(){return this.container.getPrimitiveRep(this.index)},getStart:function(){return this.container.getPrimitiveStart(this.index)},getCount:function(){return this.container.getPrimitiveCount(this.index)},getGroup:function(){return this.container.getPrimitiveGroup(this.index)},getDecoration:function(){return this.container.getPrimitiveDecoration(this.index)},getBoundingSphere:function(){return this.container.getPrimitiveBoundingSphere(this.index)},setBoundingSphere:function(t){this.container.setPrimitiveBoundingSphere(this.index,t)},getIdentificationObject:function(){return this.container.getPrimitiveIdentificationObject(this.index)},setIdentificationObject:function(t){this.container.setPrimitiveIdentificationObject(t,this.index)},computeBoundingSphere:function(t){return this.container.computePrimitiveBoundingSphere(this.index,t)},_computeOrientedBoundingBox:function(t,e,i,r,n){return this.container._computePrimitiveOrientedBoundingBox(this.index,t,e,i,r,n)},startIteration:function(){return this.container.startIteration()},endIteration:function(){return this.container.endIteration()}};var h=0;Object.defineProperty(i.SGPrimitiveHelper.prototype,"start",{get:function(){if(h<25){var t=new Error,e="#PrimApi - helper.GetStart - "+(t.stack?t.stack.split("\n")[1]+" - "+t.stack.split("\n")[2]:"");r.has(e.hashCode())||(r.add(e.hashCode()),console.error(e)),h++}return this.getStart()},set:function(){throw"NO"}}),Object.defineProperty(i.SGPrimitiveHelper.prototype,"count",{get:function(){if(h<25){var t=new Error,e="#PrimApi - helper.GetCount - "+(t.stack?t.stack.split("\n")[1]+" - "+t.stack.split("\n")[2]:"");r.has(e.hashCode())||(r.add(e.hashCode()),console.error(e)),h++}return this.getCount()},set:function(){throw"NO"}}),Object.defineProperty(i.SGPrimitiveHelper.prototype,"cgmId",{get:function(){if(h<25){var t=new Error,e="#PrimApi - helper.GetCgmId - "+(t.stack?t.stack.split("\n")[1]+" - "+t.stack.split("\n")[2]:"");r.has(e.hashCode())||(r.add(e.hashCode()),console.error(e)),h++}return this.getCgmId()},set:function(t){if(h<25){var e=new Error,i="#PrimApi - helper.SetCgmId - "+(e.stack?e.stack.split("\n")[1]+" - "+e.stack.split("\n")[2]:"");r.has(i.hashCode())||(r.add(i.hashCode()),console.error(i)),h++}this._setCgmId(t)}}),Object.defineProperty(i.SGPrimitiveHelper.prototype,"rep",{get:function(){if(h<25){var t=new Error,e="#PrimApi - helper.GetRep - "+(t.stack?t.stack.split("\n")[1]+" - "+t.stack.split("\n")[2]:"");r.has(e.hashCode())||(r.add(e.hashCode()),console.error(e)),h++}return this.getRep()},set:function(){throw"NO"}}),Object.defineProperty(i.SGPrimitiveHelper.prototype,"boundingSphere",{get:function(){if(h<25){var t=new Error,e="#PrimApi - helper.GetBS - "+(t.stack?t.stack.split("\n")[1]+" - "+t.stack.split("\n")[2]:"");r.has(e.hashCode())||(r.add(e.hashCode()),console.error(e)),h++}return this.getBoundingSphere()},set:function(){throw"NO"}}),Object.defineProperty(i.SGPrimitiveHelper.prototype,"type",{get:function(){if(h<25){var t=new Error,e="#PrimApi - helper.GetType - "+(t.stack?t.stack.split("\n")[1]+" - "+t.stack.split("\n")[2]:"");r.has(e.hashCode())||(r.add(e.hashCode()),console.error(e)),h++}return this.getType()},set:function(){throw"NO"}}),Object.defineProperty(i.SGPrimitiveHelper.prototype,"group",{get:function(){if(h<25){var t=new Error,e="#PrimApi - helper.GetGroup - "+(t.stack?t.stack.split("\n")[1]+" - "+t.stack.split("\n")[2]:"");r.has(e.hashCode())||(r.add(e.hashCode()),console.error(e)),h++}return this.getGroup()},set:function(){throw"NO"}}),Object.defineProperty(i.SGPrimitiveHelper.prototype,"decoration",{get:function(){if(h<25){var t=new Error,e="#PrimApi - helper.GetDeco - "+(t.stack?t.stack.split("\n")[1]+" - "+t.stack.split("\n")[2]:"");r.has(e.hashCode())||(r.add(e.hashCode()),console.error(e)),h++}return this.getDecoration()},set:function(){throw"NO"}});var p={EDGE:1,WIRE_EDGE:2,BOUNDARY_EDGE:3,SHARP_EDGE:4,SMOOTH_EDGE:5,BOUNDARY_POINT:6,SHARP_POINT:7,SMOOTH_POINT:8,SURFACIC_POINT:9,FREE_POINT:10,INFINITE_FACE:11,FACE:12,UNKNOWN:13};i.getConvertedVec3=function(e,i){var r=[e[i],e[i+1],e[i+2]];return new t.Vector3(r[0],r[1],r[2])},i.isEqualGAS=function(t,e){return null==t&&null==e||!(null==t&&null!=e||null!=t&&null==e)&&(t.fill.isEqual(e.fill)&&t.line.isEqual(e.line)&&t.point.isEqual(e.point))},i.isEqualMaterial=function(t,e){return null==t&&null==e||!(null==t&&null!=e||null!=t&&null==e)&&(t.id==e.id&&t.file==e.file)},i.convertToMaterial3js=function(e,i){if(null==e)return null;var r=null,n=1,o=null;switch(i){case 0:n=null==e.point.color.a?1:e.point.color.a,o=new t.Color,e.point.color&&(o.setRGB(e.point.color.r,e.point.color.g,e.point.color.b),r={color:o,opacity:n,symbol:e.point.symbol,pointsize:e.point.size},e.point.forceMaterial&&(r.forceMaterial=!0));break;case 1:n=null==e.line.color.a?1:e.line.color.a,o=new t.Color,e.line.color&&(o.setRGB(e.line.color.r,e.line.color.g,e.line.color.b),r={color:o,opacity:n,lineWidth:e.line.thickness,pattern:e.line.pattern},e.line.forceMaterial&&(r.forceMaterial=!0));break;case 2:n=null==e.fill.color.a?1:e.fill.color.a,o=new t.Color,e.fill.color&&(o.setRGB(e.fill.color.r,e.fill.color.g,e.fill.color.b),r={color:o,opacity:n,solid:e.fill.solid,basic:e.fill.basic})}return r},i.areEqualGraphicProperties=function(t,e){return null!=t.color&&null!=e.color&&(t.color.r==e.color.r&&t.color.g==e.color.g&&t.color.b==e.color.b&&((!t.thickness||!e.thickness||t.thickness==e.thickness)&&((!t.pointsize||!e.pointsize||t.pointsize==e.pointsize)&&t.opacity==e.opacity)))},i.validatePrimitiveGroup=function(t){var e,r;for(e=0;e<t.buffers.length;e++){(s=t.buffers[e])&&(s.size=s.data.byteLength/i.sizeOfDataType(s.format),s.indexBuffer&&(s.format=i.DataTypeEnum.UINT,s.dimension=1))}for(e=0;e<t.primitives.length;e++){var n=t.primitives[e];for(n.attr||(n.attr={fill:t.fillAttr,line:t.lineAttr,point:t.pointAttr}),r=0;r<n.nbVertexComponents;r++){var o=n.vertexComponents[r],s=t.getBufferFromId(o.bufferId);o.component=s.component,o.nbValuesPerVertex=s.dimension,o.format=s.format}}},i.checkMeshOptimizable=function(t){for(var e=null,r=[],n=0;n<t.buffers.length;n++){var o=t.buffers[n];if(o)if(o.indexBuffer){if(e)return!1;e=o}else{if(r[o.component])return!1;r[o.component]=o}}for(var s=0;s<t.primitives.length;s++){var a=t.primitives[s];if(a.connectivity===i.ConnectivityTypeEnum.TRIANGLE_STRIP||a.connectivity===i.ConnectivityTypeEnum.TRIANGLE_FAN||a.connectivity===i.ConnectivityTypeEnum.LINE_STRIP)return!1}return!0},i.createGeometryOptimized=function(e,r){var n=new i.Mesh;n.rep=r;for(var o=0;o<e.buffers.length;o++){var s=e.buffers[o],a=s.component,u=s.data;if(s.indexBuffer)n.vertexIndexArray=u;else switch(a){case i.VertexComponentEnum.POSITION:n.vertexPositionArray=u;break;case i.VertexComponentEnum.NORMAL:n.vertexNormalArray=u;break;case i.VertexComponentEnum.DIFFUSE_COLOR:n.vertexColorArray=u;break;case i.VertexComponentEnum.TEX_COORD_0:n.vertexUvArray=u;break;case i.VertexComponentEnum.TEX_COORD_1:n.vertexUv2Array=u;break;case i.VertexComponentEnum.TEX_COORD_2:n.vertexTangentArray=u;break;case i.VertexComponentEnum.TEX_COORD_3:n.vertexBinormalArray=u}}var l=[],c=[],h=e.nbPrimitives;for(o=0;o<h;o++){var d=e.primitives[o],m=!!d.vertexComponents[0].indices,g=0,v=l.length;if(m){for(g=0;g<v;g++){var f=l[g];if(f.connectivity==d.connectivity&&f.geomType==d.geomType&&i.isEqualGAS(f.gas,d.attr)&&(null==f.material&&null==d.material||f.material.id==d.material.id&&f.material.file==d.material.file)){f.set.push(d),f.nbIndices+=d.nbIndices;break}}if(g===l.length){var y={connectivity:d.connectivity,geomType:d.geomType,gas:d.attr,material:d.material,nbIndices:d.nbIndices,set:[d]};l.push(y)}}else c.push(d)}l.sort(function(t,e){if(t.connectivity<e.connectivity)return-1;if(t.connectivity>e.connectivity)return 1;if(t.geomType&&e.geomType){var i=p[t.geomType],r=p[e.geomType];if(i&&r)return i-r}return 0});for(o=0;o<l.length;o++)l[o].set.sort(function(t,e){var i=t.vertexComponents[0].indices,r=e.vertexComponents[0].indices;return i&&r?i.offset-r.offset:0});for(o=0;o<l.length;o++)for(var x=l[o],b=[],A=x.set[0].vertexComponents[0].indices.offset,I=x.set[0].vertexComponents[0].indices.offset,_=0,S=0;S<x.set.length;)for(g=S;g<x.set.length;g++){var P=x.set[g];if(!P.vertexComponents[0].indices||P.vertexComponents[0].indices.offset!==I||g===x.set.length-1){g===x.set.length-1?(b.push(P),_+=P.nbIndices,S=g+1):S=g;var w=4===(B=x.connectivity===i.ConnectivityTypeEnum.TRIANGLES?4:x.connectivity===i.ConnectivityTypeEnum.LINES?1:0)?2:B;(E=new i.DrawingGroup(i.convertToMaterial3js(x.gas,w),x.material,B,A,_,void 0,void 0,t.GeomTypeEnum[x.geomType]))._geomType=x.geomType?t.GeomTypeEnum[x.geomType]:0,n.drawingGroups.push(E);for(var T=0;T<b.length;T++){var G=b[T],C=new i.SGPrimitive({cgmId:G.identifier,rep:n.rep,group:E,start:G.vertexComponents[0].indices.offset,count:G.nbIndices});E._primitives.push(C),n.rep._primitives.push(C)}A=P.vertexComponents[0].indices.offset,I=P.vertexComponents[0].indices.offset,_=0,b.length=0;break}b.push(P),I+=P.nbIndices,_+=P.nbIndices}for(o=0;o<c.length;o++){var B,E;w=4===(B=(G=c[o]).connectivity===i.ConnectivityTypeEnum.TRIANGLES?4:G.connectivity===i.ConnectivityTypeEnum.LINES?1:0)?2:B;(E=new i.DrawingGroup(i.convertToMaterial3js(G.attr,w),G.material,B,G.vertexComponents[0].offset,G.nbIndices,void 0,void 0,t.GeomTypeEnum[G.geomType]))._geomType=G.geomType?t.GeomTypeEnum[G.geomType]:0,E.nonIndexed=!0,n.drawingGroups.push(E);C=new i.SGPrimitive({cgmId:G.identifier,rep:n.rep,group:E,start:G.vertexComponents[0].offset,count:G.nbIndices});E._primitives.push(C),n.rep._primitives.push(C)}var N=new t.Color,M=new t.Color,O=new t.Color;e.fillAttr.color&&N.setRGB(e.fillAttr.color.r,e.fillAttr.color.g,e.fillAttr.color.b),e.lineAttr.color&&M.setRGB(e.lineAttr.color.r,e.lineAttr.color.g,e.lineAttr.color.b),n.gas.fill={color:N,opacity:null==e.fillAttr.color.a?1:e.fillAttr.color.a,solid:e.fillAttr.solid},n.gas.line={color:M,opacity:null==e.lineAttr.color.a?1:e.lineAttr.color.a,lineWidth:e.lineAttr.thickness,pattern:e.lineAttr.pattern||1},e.pointAttr&&(e.pointAttr.color&&O.setRGB(e.pointAttr.color.r,e.pointAttr.color.g,e.pointAttr.color.b),n.gas.point={color:O,opacity:null==e.pointAttr.color.a?1:e.pointAttr.color.a,pointsize:e.pointAttr.size});var z=[0,0,0],D=[0,0,0];if(n.vertexPositionArray){const t=n.vertexPositionArray;var R=t.length;if(R>=3){z=[t[0],t[1],t[2]],D=[t[0],t[1],t[2]];for(var V=0;V<R;V+=3)t[V]<z[0]&&(z[0]=t[V]),t[V+1]<z[1]&&(z[1]=t[V+1]),t[V+2]<z[2]&&(z[2]=t[V+2]),t[V]>D[0]&&(D[0]=t[V]),t[V+1]>D[1]&&(D[1]=t[V+1]),t[V+2]>D[2]&&(D[2]=t[V+2])}}return n.AABB={min:z,max:D},n},i.convertToGeometry3js=function(e,r,n,o,s,a,u){var l=o,c=[],h=0,d=0,m=e.nbPrimitives,g=i.isEqualGAS;a&&(g=function(t,e){return t.set==e.set&&t.rgba==e.rgba});for(var v=0;v<m;v++){var f=e.primitives[v],y=0,x=c.length;for(y=0;y<x;y++){var b=c[y];if(b.connectivity==f.connectivity&&b.geomType==f.geomType&&g(b.gas,f.attr)&&(null==b.material&&null==f.material||b.material.id==f.material.id&&b.material.file==f.material.file)){switch(h+=f.nbIndices,b.connectivity){case i.ConnectivityTypeEnum.TRIANGLE_STRIP:case i.ConnectivityTypeEnum.TRIANGLE_FAN:d+=2*(f.nbIndices-3),b.more_indices+=2*(f.nbIndices-3);break;case i.ConnectivityTypeEnum.LINE_STRIP:d+=f.nbIndices-2,b.more_indices+=f.nbIndices-2}b.set.push(f),b.nbIndices+=f.nbIndices;break}}if(y==c.length)switch((I={}).connectivity=f.connectivity,I.geomType=f.geomType,I.gas=f.attr,I.material=f.material,I.nbIndices=f.nbIndices,I.more_indices=0,I.set=[],I.set.push(f),c.push(I),h+=f.nbIndices,c[y].connectivity){case i.ConnectivityTypeEnum.TRIANGLE_STRIP:case i.ConnectivityTypeEnum.TRIANGLE_FAN:d+=2*(f.nbIndices-3),I.more_indices=2*(f.nbIndices-3);break;case i.ConnectivityTypeEnum.LINE_STRIP:d+=f.nbIndices-2,I.more_indices=f.nbIndices-2}}c.sort(function(t,e){if(t.connectivity<e.connectivity)return-1;if(t.connectivity>e.connectivity)return 1;if(t.geomType&&e.geomType){var i=p[t.geomType],r=p[e.geomType];if(i&&r)return i-r}return 0});var A=[];for(y=0;y<c.length;y++){var I=c[y];for(v=0;v<I.set.length;v++)A.push(I.set[v])}var _=null;_=null==s||"multi"==s?void 0!==r?i.deMultiIndex(A,e.buffers,r,n):i.deMultiIndex(A,e.buffers):void 0!==r?i.monoIndex(A,e.buffers,r,n):i.monoIndex(A,e.buffers);var S=new i.Mesh;S.vertexPositionArray=_.VB[0],S.vertexNormalArray=_.VB[1],S.vertexColorArray=_.VB[2],S.vertexUvArray=_.VB[3],S.vertexUv2Array=_.VB[4],S.vertexTangentArray=_.VB[5],S.vertexBinormalArray=_.VB[6];for(var P=new Uint32Array(h+d),w=0,T=0,G=0;G<c.length;G++){var C,B=null==(I=c[G]).material?e.material:I.material;switch(I.connectivity){case i.ConnectivityTypeEnum.TRIANGLES:(z=I.gas)&&!z.set&&(z=i.convertToMaterial3js(I.gas,2)),(C=new i.DrawingGroup(z,B,4,T,I.nbIndices,void 0,void 0,t.GeomTypeEnum[I.geomType],void 0,u))._geomType=I.geomType?t.GeomTypeEnum[I.geomType]:0,S.drawingGroups.push(C);for(v=0;v<I.set.length;v++){f=I.set[v];var E=new i.MeshPrimitive(f.identifier,C,T,f.nbIndices);f.cgmId&&(E.cgmId=f.cgmId),f.decoration&&(E.decoration=f.decoration),f.boundingSphere&&(E.boundingSphere=f.boundingSphere),C._primitives.push(E);for(y=0;y<f.nbIndices;y++)P[T++]=_.IB[w++]}break;case i.ConnectivityTypeEnum.TRIANGLE_FAN:(z=I.gas)&&!z.set&&(z=i.convertToMaterial3js(I.gas,2)),(C=new i.DrawingGroup(z,B,4,T,I.nbIndices+I.more_indices,void 0,void 0,t.GeomTypeEnum[I.geomType],void 0,u))._geomType=I.geomType?t.GeomTypeEnum[I.geomType]:0,S.drawingGroups.push(C);for(v=0;v<I.set.length;v++){f=I.set[v];var N=T,M=w;for(y=0;y<f.nbIndices-2;y++)P[T++]=_.IB[M],P[T++]=_.IB[w+1],P[T++]=_.IB[w+2],w++;w+=2;E=new i.MeshPrimitive(f.identifier,C,N,T-N);f.cgmId&&(E.cgmId=f.cgmId),f.decoration&&(E.decoration=f.decoration),f.boundingSphere&&(E.boundingSphere=f.boundingSphere),C._primitives.push(E)}break;case i.ConnectivityTypeEnum.TRIANGLE_STRIP:(z=I.gas)&&!z.set&&(z=i.convertToMaterial3js(I.gas,2)),(C=new i.DrawingGroup(z,B,4,T,I.nbIndices+I.more_indices,void 0,void 0,t.GeomTypeEnum[I.geomType],void 0,u))._geomType=I.geomType?t.GeomTypeEnum[I.geomType]:0,S.drawingGroups.push(C);for(v=0;v<I.set.length;v++){f=I.set[v],N=T;var O=0;for(y=0;y<f.nbIndices-2;y++)P[T++]=_.IB[w],P[T++]=_.IB[w+1+O],P[T++]=_.IB[w+2-O],w++,O=1-O;w+=2;E=new i.MeshPrimitive(f.identifier,C,N,T-N);f.cgmId&&(E.cgmId=f.cgmId),f.decoration&&(E.decoration=f.decoration),f.boundingSphere&&(E.boundingSphere=f.boundingSphere),C._primitives.push(E)}break;case i.ConnectivityTypeEnum.LINES:B&&(B.shading="Basic"),(z=I.gas)&&!z.set&&(z=i.convertToMaterial3js(I.gas,1)),(C=new i.DrawingGroup(z,B,1,T,I.nbIndices,void 0,void 0,t.GeomTypeEnum[I.geomType],void 0,u))._geomType=I.geomType?t.GeomTypeEnum[I.geomType]:0,S.drawingGroups.push(C);for(v=0;v<I.set.length;v++){f=I.set[v],E=new i.MeshPrimitive(f.identifier,C,T,f.nbIndices);f.cgmId&&(E.cgmId=f.cgmId),f.decoration&&(E.decoration=f.decoration),f.boundingSphere&&(E.boundingSphere=f.boundingSphere),C._primitives.push(E);for(y=0;y<f.nbIndices;y++)P[T++]=_.IB[w++]}break;case i.ConnectivityTypeEnum.LINE_STRIP:B&&(B.shading="Basic"),(z=I.gas)&&!z.set&&(z=i.convertToMaterial3js(I.gas,1)),(C=new i.DrawingGroup(z,B,1,T,I.nbIndices+I.more_indices,void 0,void 0,t.GeomTypeEnum[I.geomType],void 0,u))._geomType=I.geomType?t.GeomTypeEnum[I.geomType]:0,S.drawingGroups.push(C);for(v=0;v<I.set.length;v++){for(f=I.set[v],N=T,y=0;y<f.nbIndices-1;y++)P[T++]=_.IB[w++],P[T++]=_.IB[w];w++;E=new i.MeshPrimitive(f.identifier,C,N,T-N);f.cgmId&&(E.cgmId=f.cgmId),f.decoration&&(E.decoration=f.decoration),f.boundingSphere&&(E.boundingSphere=f.boundingSphere),C._primitives.push(E)}break;case i.ConnectivityTypeEnum.POINTS:var z;(z=I.gas)&&!z.set&&(z=i.convertToMaterial3js(I.gas,0)),(C=new i.DrawingGroup(z,B,0,T,I.nbIndices,void 0,void 0,t.GeomTypeEnum[I.geomType],void 0,u))._geomType=I.geomType?t.GeomTypeEnum[I.geomType]:0,S.drawingGroups.push(C);for(v=0;v<I.set.length;v++){f=I.set[v],E=new i.MeshPrimitive(f.identifier,C,T,f.nbIndices);f.cgmId&&(E.cgmId=f.cgmId),f.decoration&&(E.decoration=f.decoration),f.boundingSphere&&(E.boundingSphere=f.boundingSphere),C._primitives.push(E);for(y=0;y<f.nbIndices;y++)P[T++]=_.IB[w++]}}}S.vertexIndexArray=P;var D=new t.Color,R=new t.Color,V=new t.Color;if(e.fillAttr.color&&D.setRGB(e.fillAttr.color.r,e.fillAttr.color.g,e.fillAttr.color.b),e.lineAttr.color&&R.setRGB(e.lineAttr.color.r,e.lineAttr.color.g,e.lineAttr.color.b),S.gas.fill={color:D,opacity:null==e.fillAttr.color.a?1:e.fillAttr.color.a,solid:e.fillAttr.solid},S.gas.line={color:R,opacity:null==e.lineAttr.color.a?1:e.lineAttr.color.a,lineWidth:e.lineAttr.thickness,pattern:e.lineAttr.pattern||1},e.pointAttr&&(e.pointAttr.color&&V.setRGB(e.pointAttr.color.r,e.pointAttr.color.g,e.pointAttr.color.b),S.gas.point={color:V,opacity:null==e.pointAttr.color.a?1:e.pointAttr.color.a,pointsize:e.pointAttr.size}),!l){var F=[0,0,0],k=[0,0,0];if(S.vertexPositionArray){const t=S.vertexPositionArray;var U=t.length;if(U>=3){F=[t[0],t[1],t[2]],k=[t[0],t[1],t[2]];for(var L=0;L<U;L+=3)t[L]<F[0]&&(F[0]=t[L]),t[L+1]<F[1]&&(F[1]=t[L+1]),t[L+2]<F[2]&&(F[2]=t[L+2]),t[L]>k[0]&&(k[0]=t[L]),t[L+1]>k[1]&&(k[1]=t[L+1]),t[L+2]>k[2]&&(k[2]=t[L+2])}}S.AABB={min:F,max:k}}return S},i.monoIndex=function(e,r,n,o){for(var s=0,a=0;a<e.length;a++)s+=e[a].nbIndices;var u=[];for(a=0;a<i.NumberOfComponents;a++)u[a]=[];var l=0;for(a=0;a<r.length;a++){if(null!=(f=r[a])&&(!(f.component>=i.NumberOfComponents)&&!f.indexBuffer&&f.data.length&&(void 0===f._isPlanar||!f._isPlanar))){var c=0;if(m=u[f.component].length){var h=u[f.component][m-1];c=h.offset+h.buffer.data.length/3}u[f.component].push({buffer:f,offset:c}),f._newOffset=c,c+f.data.length/3>l&&(l=c+f.data.length/3)}}for(a=0;a<r.length;a++){if(null!=(f=r[a])&&(!(f.component>=i.NumberOfComponents)&&!f.indexBuffer&&f.data.length&&null!=f._isPlanar&&f._isPlanar)){c=l;u[f.component].push({buffer:f,offset:c}),f._newOffset=c}}var p=new Uint32Array(s),d=[];for(a=0;a<i.NumberOfComponents;a++){var m;if(m=u[a].length){var g=u[a][m-1];d[a]=new Float32Array(3*g.offset+g.buffer.data.length);c=0;for(var v=0;v<m;v++){var f,y=(f=u[a][v]).buffer.data.length,x=f.buffer.data;if(c<3*f.offset){for(var b=c;b<3*f.offset;b++)d[a][b]=0;c=3*f.offset}if(null==n)d[a].set(x,c);else for(b=0;b<y;b+=3){var A=new t.Vector3(x[b],x[b+1],x[b+2]);1==a?A.applyMatrix4(o):0==a&&A.applyMatrix4(n),d[a][c+b]=A.x,d[a][c+b+1]=A.y,d[a][c+b+2]=A.z}c+=y}}else d[a]=null}var I=0;for(a=0;a<e.length;a++){var _=e[a],S=_.vertexComponents[0],P=r[S.bufferId];if(null!=P){var w=P._newOffset;if(null!=S.indices){var T=r[S.indices.bufferId];for(b=0;b<_.nbIndices;b++)p[I+b]=T.data[S.indices.offset+b]+S.offset+w}else for(b=0;b<_.nbIndices;b++)p[I+b]=w+S.offset+b;I+=_.nbIndices}}return{IB:p,VB:d}},i.deMultiIndex=function(e,r,n,o){null!=n&&null!=o||(n=null),void 0!==o&&o instanceof t.Matrix4&&((o=(new t.Matrix4).copy(o)).elements[12]=0,o.elements[13]=0,o.elements[14]=0);for(var s=0,a=0;a<e.length;a++)s+=e[a].nbIndices;var u=[],l=[],c=0;for(a=0;a<i.NumberOfComponents;a++)u[a]=null;for(a=0;a<e.length;a++){for(var h=e[a],p=0;p<h.nbVertexComponents;p++){var d=h.vertexComponents[p];if(null==u[d.component]){u[d.component]=[],l[d.component]=d.bufferId;for(var m=0;m<s;m++)u[d.component][m]=null}r[d.bufferId];var g=null;if(null!=d.indices&&(g=r[d.indices.bufferId]),null!=g)for(m=0;m<h.nbIndices;m++)u[d.component][c+m]={bufferId:d.bufferId,index:d.offset+g.data[d.indices.offset+m]};else for(m=0;m<h.nbIndices;m++)u[d.component][c+m]={bufferId:d.bufferId,index:d.offset+m}}c+=h.nbIndices}var v=[];for(p=0;p<s;p++){(I=new i.MultiIndexMultiBuffer).old_index=p;for(a=0;a<i.NumberOfComponents;a++)null!==u[a]&&(I.comp[a]=u[a][p]);v.push(I)}v.sort(function(t,e){for(var r=0,n=0,o=0;o<i.NumberOfComponents;o++)if(null!=t.comp[o]&&null!=e.comp[o]){if(t.comp[o].index<e.comp[o].index)return-1;if(t.comp[o].index>e.comp[o].index)return 1;if(t.comp[o].bufferId<e.comp[o].bufferId)return-1;if(t.comp[o].bufferId>e.comp[o].bufferId)return 1}else null==t.comp[o]&&r++,null==e.comp[o]&&n++;return r<n?-1:r>n?1:0});var f=new Uint32Array(s),y=[];for(a=0;a<i.NumberOfComponents;a++)if(null!==u[a]){var x=r[l[a]].dimension;y[a]=new Float32Array(x*s)}else y[a]=null;var b=-1,A=null;for(a=0;a<v.length;a++){var I,_=(I=v[a]).old_index;if(!a||!I.componentsEqual(A)){b++,A=I;for(p=0;p<i.NumberOfComponents;p++)if(null!=I.comp[p]){var S=r[I.comp[p].bufferId].data,P=r[I.comp[p].bufferId].dimension;if(null==n)for(m=0;m<P;m++)y[p][P*b+m]=S[P*u[p][I.old_index].index+m];else{var w=new t.Vector3(S[3*u[p][I.old_index].index],S[3*u[p][I.old_index].index+1],S[3*u[p][I.old_index].index+2]);1==p?(w.applyMatrix4(o),y[p][3*b]=w.x,y[p][3*b+1]=w.y,y[p][3*b+2]=w.z):0==p?(w.applyMatrix4(n),y[p][3*b]=w.x,y[p][3*b+1]=w.y,y[p][3*b+2]=w.z):(y[p][3*b]=w.x,y[p][3*b+1]=w.y,y[p][3*b+2]=w.z)}}}f[_]=b}var T=[];for(a=0;a<i.NumberOfComponents;a++){var G=y[a];if(null!==G){var C=r[l[a]].dimension*(b+1),B=new Float32Array(C);for(p=0;p<C;p++)B[p]=G[p];T[a]=B}else T[a]=null}return{IB:f,VB:T}},i.MeshContextEnum={UNKNOWN:0,DATA:1,FLOATBUFFER:2,INDEXBUFFER:3,COMPRESSEDBUFFER:4,PRIMITIVE:5,VERTEXCOMPONENT:6,GRAPHICPROPERTIES:7,APPEARANCE:8,BAG:9,MESH:10,TEXT:11},i.NumberOfComponents=7,i.MultiIndex=function(){this.old_index=0,this.comp=[],this.comp[0]=-1,this.comp[1]=-1,this.comp[2]=-1,this.comp[3]=-1,this.comp[4]=-1,this.comp[5]=-1,this.comp[6]=-1},i.MultiIndex.prototype={constructor:i.MultiIndex,componentsEqual:function(t){for(var e=0;e<i.NumberOfComponents;e++)if(-1!=this.comp[e]&&-1!=t.comp[e]&&this.comp[e]!=t.comp[e])return!1;return!0}},i.MultiIndexMultiBuffer=function(){this.old_index=0,this.comp=[];for(var t=0;t<i.NumberOfComponents;t++)this.comp[t]=null},i.MultiIndexMultiBuffer.prototype={constructor:i.MultiIndexMultiBuffer,componentsEqual:function(t){for(var e=0;e<i.NumberOfComponents;e++)if(null!=this.comp[e]&&null!=t.comp[e]){if(this.comp[e].bufferId!=t.comp[e].bufferId)return!1;if(this.comp[e].index!=t.comp[e].index)return!1}return!0}},i.Node=function(t,e,i,r,n,o,s){this.id=void 0!==t?t:"",this.type=void 0!==e?e:"Bag",this.childNodes=void 0!==i?i:[],this.matrix=void 0!==r?r:null,this.position=void 0!==n?n:{},this.rotation=void 0!==o?o:{},this.scale=void 0!==s?s:{}},i.Node.prototype={constructor:i.Node,add:function(t){null!=t&&this.childNodes.push(t)},childClone:function(){var t=new Array;for(var e in this.childNodes)t[e]="object"==typeof this.childNodes[e]?this.childNodes[e].clone():this.childNodes[e];return t},matrixClone:function(){if(this.matrix){var e=new t.Matrix4;return e.copy(this.matrix),e}},clone:function(){return new i.Node(this.id,this.type,this.childClone(),this.matrixClone(),this.position,this.rotation,this.scale)}},i.Mesh=function(t,e,r,n,o,s,a,u,l,c,h,p){this.id=void 0!==t?t:"",this.type=void 0!==e?e:"Mesh",this.vertexPositionArray=void 0!==r?r:null,this.vertexNormalArray=void 0!==n?n:null,this.vertexIndexArray=void 0!==o?o:null,this.vertexUvArray=void 0!==s?s:null,this.drawingGroups=void 0!==a?a:[],this.gas=void 0!==u?u:{fill:{},line:{}},this.AABB=void 0!==l?l:{},this._radius=0,this.material=void 0!==c?c:null,this.matrix=void 0!==p?p:null,this.rep=void 0!==h?new i.SGRep({cgmId:h.cgmId}):new i.SGRep},i.Mesh.prototype={constructor:i.Mesh,setMatrix:function(t){this.matrix=t},indexCopy:function(){if(this.vertexIndexArray instanceof Uint32Array)return new Uint32Array(this.vertexIndexArray)},tabCopy:function(t){if(t instanceof Float32Array)return new Float32Array(t)},gasCopy:function(){var t;return this.gas&&(t={fill:this.gas.fill,line:this.gas.line}),t},AABBCopy:function(){return this.AABB.min&&this.AABB.max?{min:[this.AABB.min[0],this.AABB.min[1],this.AABB.min[2]],max:[this.AABB.max[0],this.AABB.max[1],this.AABB.max[2]]}:{}},dGCopy:function(){var t=new Array;for(var e in this.drawingGroups)t[e]="object"==typeof this.drawingGroups[e]?this.drawingGroups[e].clone():this.drawingGroups[e];return t},clone:function(){var t=new i.Mesh(this.id,this.type,this.tabCopy(this.vertexPositionArray),this.tabCopy(this.vertexNormalArray),this.indexCopy(),this.tabCopy(this.vertexUvArray),this.dGCopy(),this.gasCopy(),this.AABBCopy(),this.material,this.rep);return this.vertexBinormalArray&&(t.vertexBinormalArray=this.tabCopy(this.vertexBinormalArray)),this.vertexTangentArray&&(t.vertexTangentArray=this.tabCopy(this.vertexTangentArray)),t}},i.MeshPrimitive=function(t,e,i,r,n){this.cgmId=t||0,this.groupIndex=e||0,this.start=i||0,this.count=r||0,this.boundingSphere=void 0,this.rep=0,this.decoration=n||0},i.MeshPrimitive.prototype={constructor:i.MeshPrimitive,clone:function(){if(this.boundingSphere){var t=new i.MeshPrimitive(this.cgmId,this.groupIndex,this.start,this.count,this.decoration);return t.boundingSphere={center:this.boundingSphere.center,radius:this.boundingSphere.radius},t}return this}},i.DrawingGroup=function(t,e,r,n,o,s,a,u,l,c){this.gas=t||null,this.material=e||null,this.glType=r,this._geomType=u||0,this.gasIndex=l,this.start=n||0,this.count=o||0,this._primitives=void 0!==s?s:[],this.geometry=null,this.vbStart=-1,this._noZPriority=void 0!==c?c:-1,this.ib=null,this.nonIndexed=!1,this.cullingData=null,this._nonBinary=!(this._primitives instanceof i.BinarySGPrimitiveArray),this._dimension=-1,this._instancingInfos=null,this._dependentDGs=null,this._updateLineWithShapes=null},i.DrawingGroup.prototype={constructor:i.DrawingGroup,clone:function(){var t=new i.DrawingGroup(this.gas,this.material,this.glType,this.start,this.count,void 0,void 0,this._geomType,this.gasIndex,this._noZPriority);if(t.copyPrimitives(this._primitives),t.geometry=this.geometry,t._dimension=this._dimension,t._instancingInfos=this._instancingInfos,t._instancingInfos){const e=t._instancingInfos.instanceAttribArrays;for(let t in e)"id"!==t&&(e[t].buffer=null)}return t._updateLineWithShapes=this._updateLineWithShapes,t},setInstancingParameters:function(i,r,n){let o={};if(null!==this._instancingInfos){let t=this._instancingInfos.instanceAttribArrays;for(let e in t)"id"!==e&&null!==t[e].buffer&&void 0!==t[e].buffer&&(o[e]=t[e].buffer)}e--,this._instancingInfos={nbInstances:i,instancingSelectionMode:n||"instance",instanceAttribArrays:{id:e},pickedInstanceId:-1,staleGLBuffers:[]};let s=this._instancingInfos.instanceAttribArrays,a=new Float32Array(i);for(var u=0;u<i;u++)a[u]=5+5*u;s.instanceId={},s.instanceId.array=a,s.instanceId.buffer=null,s.instanceId.itemSize=1,this.material.isInstancingMaterial=!0,this.material.attributes={instanceId:{type:"f"}};for(let t=0;t<r.length;t++){const e=r[t];switch(this.material.attributes[e.attribName]={type:e.type},s[e.attribName]={isMat4:!1,itemSize:0,array:e.isFlattened?new Float32Array(e.data):null,buffer:null},e.type){case"f":s[e.attribName].itemSize=1;break;case"v2":s[e.attribName].itemSize=2;break;case"v3":s[e.attribName].itemSize=3;break;case"v4":s[e.attribName].itemSize=4;break;case"m4":s[e.attribName].itemSize=4,s[e.attribName].isMat4=!0}if(!e.isFlattened)switch(e.type){case"v2":s[e.attribName].array=new Float32Array(2*i);for(var l=0;l<i;l++)s[e.attribName].array[2*l+0]=e.data[l].x,s[e.attribName].array[2*l+1]=e.data[l].y;break;case"v3":s[e.attribName].array=new Float32Array(3*i);for(l=0;l<i;l++)s[e.attribName].array[3*l+0]=e.data[l].x,s[e.attribName].array[3*l+1]=e.data[l].y,s[e.attribName].array[3*l+2]=e.data[l].z;break;case"v4":s[e.attribName].array=new Float32Array(4*i);for(l=0;l<i;l++)s[e.attribName].array[4*l+0]=e.data[l].x,s[e.attribName].array[4*l+1]=e.data[l].y,s[e.attribName].array[4*l+2]=e.data[l].z,s[e.attribName].array[4*l+3]=e.data[l].w;break;case"m4":s[e.attribName].array=new Float32Array(16*e.data.length);for(var c=0;c<e.data.length;c++){var h=new Float32Array(16);h=e.data[c].elements;for(u=0;u<16;u++)s[e.attribName].array[16*c+u]=h[u]}}}for(let t in o)void 0!==s[t]?(s[t].buffer=o[t],s[t].isDynamic=!0):this._instancingInfos.staleGLBuffers.push(o[t]);if(this.material._PDSFXData&&this.material._PDSFXData.PDSFX){let e="";for(let i=0;i<r.length;i++)e+="attribute "+t.ToGLSLTypes[r[i].type].t+" "+r[i].attribName+";\n";this.material._PDSFXData.pdsfxAttributesCode=e}},_compactArrays:function(){if(this._nonBinary){var t=this._primitives;this._primitives=new Array(t.length);for(var e=0;e<t.length;e++)this._primitives[e]=t[e]}else this._primitives._compactArrays()},_getDimension:function(t,e){var i=2,r=this;if(r._geomType)i=t[r._geomType];else switch(r.glType){case 0:i=0;break;case 1:i=1;break;default:i=2}return 2===i&&(i=e&&e._bodyDim>0?3===e._bodyDim?5:2:r.gas&&0===r.gas.side?5:2),this._dimension=i,i},copyPrimitives:function(t){var e=null;if(t instanceof i.BinarySGPrimitiveArray)return this._primitives=t.clone(),void(this._nonBinary=!1);this._nonBinary=!0,this._primitives=new Array(t.length);for(var r=0;r<t.length;r++)if((e=t[r])instanceof i.SGPrimitive)this._primitives[r]=e.clone();else{var n=new i.SGPrimitive;n.cgmId=e.cgmId,n.rep=e.rep,n.group=this,n.start=e.start,n.count=e.count,this._primitives[r]=n}},_computeOrientedBoundingBox:function(e,i,r,n,o,s,a){if(!e||this.isFiltered(i,a)||n&&r===t.FixedSizeFiltering.Exclude)return null;if(n&&r===t.FixedSizeFiltering.CenterOnly)return new t.Box3(new t.Vector3(0,0,0),new t.Vector3(0,0,0)).applyMatrix4(e);var u=new t.Vector3,l=new t.Vector3,c=new t.Vector3,h=new t.Vector3,p=null!==o?o:this.start,d=null!==s?s:this.count,m=this.geometry.vertexIndexArray;if(this.geometry.getVertexCount()){var g=m[p];this.geometry.getVertexPosition(g,h),l.set(h.x,h.y,h.z).applyMatrix4(e),c.set(h.x,h.y,h.z).applyMatrix4(e);for(var v=p+1;v<p+d;v++)g=m[v],this.geometry.getVertexPosition(g,h),u.set(h.x,h.y,h.z).applyMatrix4(e),u.x<l.x&&(l.x=u.x),u.y<l.y&&(l.y=u.y),u.z<l.z&&(l.z=u.z),u.x>c.x&&(c.x=u.x),u.y>c.y&&(c.y=u.y),u.z>c.z&&(c.z=u.z)}return new t.Box3(l,c)},_computePrimitiveOrientedBoundingBox:function(t,e,i,r,n,o){return this._nonBinary?this._primitives[t]._computeOrientedBoundingBox(e,i,r,n,o):this._primitives._computePrimitiveOrientedBoundingBox(t,e,i,r,n,o)},disabled:function(t,e,i){return console.warn("Deprecated, use isFiltered instead"),e=e||0,this.isFiltered(t&~e,i)},isFiltered:function(t,e){var i=e||this._geomType;return!(t<0||0===i)&&!((i&t)>0)},getPrimitiveCgmId:function(t){return this._nonBinary?this._primitives[t].cgmId:this._primitives.getPrimitiveCgmId(t)},_setPrimitiveCgmId:function(t,e){this._nonBinary?this._primitives[e].cgmId=t:this._primitives._setPrimitiveCgmId(t,e)},getPrimitiveType:function(t){return this._nonBinary?this._primitives[t].type:this._primitives.getPrimitiveType(t)},getPrimitiveRep:function(t){return this._nonBinary?this._primitives[t].rep:this._primitives.getPrimitiveRep(t)},_getSGPrimitive:function(t,e){return this._nonBinary?e?this._primitives[t]:this._primitives[t].clone():this._primitives._getSGPrimitive(t,e)},_getPrimitiveInternalNode:function(t){return this._nonBinary?this._primitives[t].internalNode:this._primitives._getPrimitiveInternalNode(t)},_setPrimitiveRep:function(t,e){this._nonBinary?this._primitives[e].rep=t:this._primitives._setPrimitiveRep(t,e)},_setPrimitiveInternalNode:function(t,e){this._nonBinary?this._primitives[e].internalNode=t:this._primitives._setPrimitiveInternalNode(t,e)},_setPrimitiveStart:function(t,e){this._nonBinary?this._primitives[e].start=t:this._primitives._setPrimitiveStart(t,e)},_setPrimitiveCount:function(t,e){this._nonBinary?this._primitives[e].count=t:this._primitives._setPrimitiveCount(t,e)},getPrimitiveStart:function(t){return this._nonBinary?this._primitives[t].start:this._primitives.getPrimitiveStart(t)},getPrimitiveCount:function(t){return this._nonBinary?this._primitives[t].count:this._primitives.getPrimitiveCount(t)},getPrimitiveGroup:function(t){return this._nonBinary?this._primitives[t].group:this._primitives.getPrimitiveGroup(t)},getPrimitiveDecoration:function(t){return this._nonBinary?this._primitives[t].decoration:this._primitives.getPrimitiveDecoration(t)},getPrimitiveBoundingSphere:function(t){return this._nonBinary?this._primitives[t].boundingSphere:this._primitives.getPrimitiveBoundingSphere(t)},setPrimitiveBoundingSphere:function(t,e){this._nonBinary?this._primitives[t].boundingSphere=e:this._primitives.setPrimitiveBoundingSphere(t,e)},getPrimitivesCount:function(){return this._nonBinary?this._primitives.length:this._primitives.getPrimitivesCount()},getPrimitiveIdentificationObject:function(t){return this._nonBinary?this._primitives[t].IdentObj:this._primitives.getPrimitiveIdentificationObject(t)},setPrimitiveIdentificationObject:function(t,e){this._nonBinary?this._primitives[e].IdentObj=t:this._primitives.setPrimitiveIdentificationObject(t,e)},computePrimitiveBoundingSphere:function(t,e){return this._nonBinary?this._primitives[t].computeBoundingSphere(e):this._primitives.computePrimitiveBoundingSphere(t,e)},startIteration:function(){return!0},endIteration:function(){return!0}},Object.defineProperty(i.DrawingGroup.prototype,"geomType",{get:function(){return console.warn("[Mesh.DrawingGroup] DOT NOT ACCESS geomType directly !\n"),i.GeomTypeString[this._geomType]},set:function(e){console.warn("[Mesh.DrawingGroup] DOT NOT ACCESS geomType directly !\n"),this._geomType=t.GeomTypeEnum[e]}});var d=0;Object.defineProperty(i.DrawingGroup.prototype,"primitives",{get:function(){if(d<10){var t=new Error,e="#PrimApi - DG.GetPrimitives - "+(t.stack?t.stack.split("\n")[1]+" - "+t.stack.split("\n")[2]:"");r.has(e.hashCode())||(r.add(e.hashCode()),console.error(e)),d++}return this._primitives},set:function(){throw"NO"}}),i.SelectionGroup=function(){this.geometries={}},i.SelectionGroup.prototype={constructor:i.SelectionGroup,contains:function(t){for(var e in this.geometries)for(var i=this.geometries[e],r=0;r<i.length;r++)for(var n=i[r].primitives,o=0;o<n.length;o++)if(n[o].isEqual(t))return!0;return!1},getFirstPrimitive:function(){for(var t in this.geometries){var e=this.geometries[t];if(e.length&&e[0].primitives.length)return e[0].primitives[0]}return null},getPrimitives:function(){var t=[];for(var e in this.geometries)for(var i=this.geometries[e],r=0;r<i.length;r++)for(var n=i[r].primitives,o=0;o<n.length;o++)t.push(n[o]);return t},addPrimitive:function(t){var e=0,i=t.getGroup(),r=i.geometry.id,n=this.geometries[r];for(n||(n=[],this.geometries[r]=n),e=0;e<n.length;e++)if(n[e].drawingGroup===i){n[e].primitives.push(t);break}e===n.length&&n.push({drawingGroup:i,primitives:[t]})},clone:function(){var t=new i.SelectionGroup;for(var e in this.geometries){var r=this.geometries[e];t.geometries[e]=[];for(var n=0;n<r.length;n++)t.geometries[e][n]={drawingGroup:r[n].drawingGroup,primitives:r[n].primitives.slice()}}return t},getIdentificationObject:function(){var t,e=this.getFirstPrimitive();return e&&e.getIdentificationObject&&(t=e.getIdentificationObject()),t},computeBoundingSphere:function(){for(var e=null,i=new t.Sphere,r=this.getPrimitives(),n=0;n<r.length;n++){r[n].computeBoundingSphere(i),e?i.mergeWithSphere(e,e):e=i.clone()}return e},_computeOrientedBoundingBox:function(e,i,r,n,o){for(var s,a=new t.Box3,u=this.getPrimitives(),l=0;l<u.length;l++){(s=u[l]._computeOrientedBoundingBox(e,i,r,n,o))&&(a=a.union(s))}return a}},i.processRepsCGR=function(e,r,n,o,s,a){var u=0,l=0,c=!r,h=[];a&&(h=a);for(var p=o||{},d=!1,m=!1,g=!1,v=!1,f=!1,y=!1,x=0;x<e.length;x++)u+=e[x].vertexPositionArray?e[x].vertexPositionArray.length:0,l+=e[x].vertexIndexArray.length,d||null===e[x].vertexNormalArray||(d=!0),m||null===e[x].vertexUvArray||(m=!0),!g&&e[x].vertexUv2Array&&(g=!0),!v&&e[x].vertexTangentArray&&(v=!0),!f&&e[x].vertexBinormalArray&&(f=!0),!y&&e[x].vertexColorArray&&(y=!0);var b,A=new Float32Array(u);b=u/3<65535?new Uint16Array(l):new Uint32Array(l);var I=d?new Float32Array(u):null,_=m?new Float32Array(u):null,S=g?new Float32Array(u):null,P=v?new Float32Array(u):null,w=f?new Float32Array(u):null,T=y?new Float32Array(4*u/3):null,G=0;for(x=0;x<e.length;x++){var C=e[x],B=C.vertexPositionArray;B&&(A.set(B,G),null!==I&&C.vertexNormalArray&&I.set(C.vertexNormalArray,G),null!==_&&C.vertexUvArray&&_.set(C.vertexUvArray,G),null!==S&&C.vertexUv2Array&&S.set(C.vertexUv2Array,G),null!==P&&C.vertexTangentArray&&P.set(C.vertexTangentArray,G),null!==w&&C.vertexBinormalArray&&w.set(C.vertexBinormalArray,G),null!==T&&C.vertexColorArray&&T.set(C.vertexColorArray,G));for(var E=0;E<C.drawingGroups.length;E++){(ot=C.drawingGroups[E]).vbStart=G/3,ot.ib=C.vertexIndexArray,ot.geometry=e[x],null==ot.gas&&(4==ot.glType||5==ot.glType?ot.gas=e[x].gas.fill:1==ot.glType?ot.gas=e[x].gas.line:0==ot.glType&&(ot.gas=e[x].gas.point));for(var N=0;N<ot._primitives.length;N++){if((nt=ot._primitives[N]).rep=C.rep,nt.boundingSphere){var M=new t.Vector3(nt.boundingSphere.center[0],nt.boundingSphere.center[1],nt.boundingSphere.center[2]);!!C.globalMatrix&&!C.globalMatrix.isIdentity()&&(M.applyMatrix4(e[x].globalMatrix),nt.boundingSphere.center=[M.x,M.y,M.z],nt.boundingSphere.radius*=e[x].globalMatrix.getMaxScaleOnAxis())}}o.withSceneGraphOrder||h.push(ot)}G+=B?B.length:0}o.withSceneGraphOrder||h.sort(function(t,e){if(t.glType<e.glType)return-1;if(t.glType>e.glType)return 1;if(null==t.material&&null!=e.material)return-1;if(null!=t.material&&null==e.material)return 1;if(null!=t.material&&null!=e.material){if(t.material.id<e.material.id)return-1;if(t.material.id>e.material.id)return 1;if(t.material.file<e.material.file)return-1;if(t.material.file>e.material.file)return 1}if(null==t.gas&&null!=e.gas)return-1;if(null!=t.gas&&null==e.gas)return-1;if(null!=t.gas&&null!=e.gas){if(t.gas.set<e.gas.set)return 1;if(e.gas.set<t.gas.set)return-1;if(t.gas.rgba<e.gas.rgba)return 1;if(e.gas.rgba<t.gas.rgba)return-1}if(t._geomType&&e._geomType){if(t._geomType<e._geomType)return-1;if(t._geomType>e._geomType)return 1;if(n){if(t.geometry._radius<e.geometry._radius)return 1;if(t.geometry._radius>e.geometry._radius)return-1}}if(n){if(t.geometry._radius<e.geometry._radius)return 1;if(t.geometry._radius>e.geometry._radius)return-1}return 0});var O=[],z=h.length>0?h[0].gas:null,D=h.length>0?h[0].material:null,R=h.length>0?h[0].glType:0,V=h.length>0?h[0]._geomType:0,F=0,k=0,U=0,L=0,j=z,H=[],q=[],W=p.withBoundingElement;for(x=0;x<h.length;x++){if((ot=h[x]).glType==R&&ot._geomType===V&&z.isEqual(ot.gas)&&(null==D&&null==ot.material||null!=D&&null!=ot.material&&D.id==ot.material.id&&D.file==ot.material.file)){n&&H.push({start:F,count:ot.count,radius:ot.geometry._radius,rep:ot.geometry.rep}),U+=ot.count,q.push(ot);for(E=0;E<ot.count;E++)b[F++]=ot.vbStart+ot.ib[ot.start+E]}else{var X=null;if(U>0){X=new i.DrawingGroup(z,h[x-1].material,R,k,U,void 0,void 0,V,L),n&&(X.cullingData=H);for(var K=0,Y=0;Y<q.length;++Y)K+=q[Y]._primitives.length;var J=new Uint32Array(5*K),Z=null;W&&X.glType>0&&(Z=new Float32Array(4*K));for(var Q=0,$=k,tt=[],et=0;et<q.length;++et){var it=q[et],rt=5*Q;if(it.geometry.noShow&&p.containNoShow)for(Y=0;Y<it._primitives.length;Y++){var nt=it._primitives[Y];if(tt.push(Q),J[rt++]=nt.cgmId+1,J[rt++]=nt.rep,J[rt++]=$,J[rt++]=nt.count,J[rt++]=nt.decoration,Z&&nt.boundingSphere)Z[st=4*Q]=nt.boundingSphere.center[0],Z[st+1]=nt.boundingSphere.center[1],Z[st+2]=nt.boundingSphere.center[2],Z[st+3]=nt.boundingSphere.radius;Q++,$+=nt.count}else for(Y=0;Y<it._primitives.length;Y++){nt=it._primitives[Y];if(J[rt++]=nt.cgmId+1,J[rt++]=nt.rep,J[rt++]=$,J[rt++]=nt.count,J[rt++]=nt.decoration,Z&&nt.boundingSphere)Z[st=4*Q]=nt.boundingSphere.center[0],Z[st+1]=nt.boundingSphere.center[1],Z[st+2]=nt.boundingSphere.center[2],Z[st+3]=nt.boundingSphere.radius;Q++,$+=nt.count}}X._primitives=Z?{prims:J,bs:Z}:J,tt.length&&(X.noShowPrim=tt),O.push(X)}q=[],H=[],j.isEqual(ot.gas)||(j=ot.gas,L++),R=ot.glType,V=ot._geomType,z=ot.gas,D=ot.material,k=F,U=ot.count,q.push(ot),n&&H.push({start:F,count:ot.count,radius:ot.geometry._radius,rep:ot.geometry.rep});for(E=0;E<ot.count;E++)b[F++]=ot.vbStart+ot.ib[ot.start+E]}}if(U>0){X=new i.DrawingGroup(z,h[h.length-1].material,R,k,U,void 0,void 0,V,L);n&&(X.cullingData=H);for(K=0,Y=0;Y<q.length;++Y)K+=q[Y]._primitives.length;J=new Uint32Array(5*K),Z=null;W&&X.glType>0&&(Z=new Float32Array(4*K));for($=k,Q=0,tt=[],et=0;et<q.length;++et){var ot;rt=5*Q;if((ot=q[et]).geometry.noShow&&p.containNoShow)for(Y=0;Y<ot._primitives.length;Y++){nt=ot._primitives[Y];if(tt.push(Q),J[rt++]=nt.cgmId+1,J[rt++]=nt.rep,J[rt++]=$,J[rt++]=nt.count,J[rt++]=nt.decoration,Z&&nt.boundingSphere)Z[st=4*Q]=nt.boundingSphere.center[0],Z[st+1]=nt.boundingSphere.center[1],Z[st+2]=nt.boundingSphere.center[2],Z[st+3]=nt.boundingSphere.radius;Q++,$+=nt.count}else for(Y=0;Y<ot._primitives.length;Y++){var st;nt=ot._primitives[Y];if(J[rt++]=nt.cgmId+1,J[rt++]=nt.rep,J[rt++]=$,J[rt++]=nt.count,J[rt++]=nt.decoration,Z&&nt.boundingSphere)Z[st=4*Q]=nt.boundingSphere.center[0],Z[st+1]=nt.boundingSphere.center[1],Z[st+2]=nt.boundingSphere.center[2],Z[st+3]=nt.boundingSphere.radius;Q++,$+=nt.count}}X._primitives=Z?{prims:J,bs:Z}:J,tt.length&&(X.noShowPrim=tt),O.push(X)}var at=new i.Mesh;if(at.vertexPositionArray=A,at.vertexNormalArray=I,at.vertexUvArray=_,at.vertexUv2Array=S,at.vertexTangentArray=P,at.vertexBinormalArray=w,at.vertexIndexArray=b,at.vertexColorArray=T,at.drawingGroups=O,void 0===e[0]){var ut=new t.Color;ut.setRGB(.5,.5,.5),at.gas.fill={color:ut,opacity:1,solid:0},at.gas.line={color:ut,opacity:1,lineWidth:1},at.gas.point={color:ut,opacity:1,pointsize:1}}else at.gas=e[0].gas;if(c){var lt=[0,0,0],ct=[0,0,0];if(u>=3){lt=[A[0],A[1],A[2]],ct=[A[0],A[1],A[2]];for(x=0;x<u;x+=3)A[x]<lt[0]&&(lt[0]=A[x]),A[x+1]<lt[1]&&(lt[1]=A[x+1]),A[x+2]<lt[2]&&(lt[2]=A[x+2]),A[x]>ct[0]&&(ct[0]=A[x]),A[x+1]>ct[1]&&(ct[1]=A[x+1]),A[x+2]>ct[2]&&(ct[2]=A[x+2])}at.AABB={min:lt,max:ct}}return at},i.processReps=function(e,r,n){for(var o=0,s=0,a=!r,u=[],l=!1,c=!1,h=!1,p=!1,d=!1,m=0;m<e.length;m++)o+=e[m].vertexPositionArray?e[m].vertexPositionArray.length:0,s+=e[m].vertexIndexArray.length,l||null===e[m].vertexNormalArray||(l=!0),c||null===e[m].vertexUvArray||(c=!0),!h&&e[m].vertexUv2Array&&(h=!0),!p&&e[m].vertexTangentArray&&(p=!0),!d&&e[m].vertexBinormalArray&&(d=!0);var g,v=new Float32Array(o);g=o/3<65535?new Uint16Array(s):new Uint32Array(s);var f=l?new Float32Array(o):null,y=c?new Float32Array(o):null,x=h?new Float32Array(o):null,b=p?new Float32Array(o):null,A=d?new Float32Array(o):null,I=0;for(m=0;m<e.length;m++){if(e[m].vertexPositionArray)for(var _=0;_<e[m].vertexPositionArray.length;_++)v[I+_]=e[m].vertexPositionArray[_],null!==f&&(f[I+_]=null!==e[m].vertexNormalArray?e[m].vertexNormalArray[_]:0),null!==y&&(y[I+_]=null!==e[m].vertexUvArray?e[m].vertexUvArray[_]:0),null!==x&&(x[I+_]=e[m].vertexUv2Array?e[m].vertexUv2Array[_]:0),null!==b&&(b[I+_]=e[m].vertexTangentArray?e[m].vertexTangentArray[_]:0),null!==A&&(A[I+_]=e[m].vertexBinormalArray?e[m].vertexBinormalArray[_]:0);for(_=0;_<e[m].drawingGroups.length;_++){(V=e[m].drawingGroups[_]).vbStart=I/3,V.ib=e[m].vertexIndexArray,V.geometry=e[m],null==V.gas&&(4==V.glType||5==V.glType?V.gas=e[m].gas.fill:1==V.glType?V.gas=e[m].gas.line:0==V.glType&&(V.gas=e[m].gas.point));for(var S=0;S<V._primitives.length;S++){if((U=V._primitives[S]).rep=e[m].rep,U.boundingSphere){var P=new t.Vector3(U.boundingSphere.center[0],U.boundingSphere.center[1],U.boundingSphere.center[2]);!!e[m].globalMatrix&&!e[m].globalMatrix.isIdentity()&&(P.applyMatrix4(e[m].globalMatrix),U.boundingSphere.center=[P.x,P.y,P.z],U.boundingSphere.radius*=e[m].globalMatrix.getMaxScaleOnAxis())}}u.push(V)}I+=e[m].vertexPositionArray?e[m].vertexPositionArray.length:0}u.sort(function(t,e){if(t.glType<e.glType)return-1;if(t.glType>e.glType)return 1;if(null==t.material&&null!=e.material)return-1;if(null!=t.material&&null==e.material)return 1;if(null!=t.material&&null!=e.material){if(t.material.id<e.material.id)return-1;if(t.material.id>e.material.id)return 1;if(t.material.file<e.material.file)return-1;if(t.material.file>e.material.file)return 1}if(null==t.gas&&null!=e.gas)return-1;if(null!=t.gas&&null==e.gas)return-1;if(null!=t.gas&&null!=e.gas){var r=i.compareGASMaterial(t.gas,e.gas);if(r)return r}if(t._geomType&&e._geomType){if(t._geomType<e._geomType)return-1;if(t._geomType>e._geomType)return 1;if(t.geometry._radius<e.geometry._radius)return 1;if(t.geometry._radius>e.geometry._radius)return-1}return t.geometry._radius<e.geometry._radius?1:t.geometry._radius>e.geometry._radius?-1:0});var w=[],T=[],G=u.length>0?u[0].gas:null,C=u.length>0?u[0].material:null,B=u.length>0?u[0].glType:0,E=u.length>0?u[0]._geomType:0,N=0,M=0,O=0,z=0,D=G,R=[];for(m=0;m<u.length;m++){var V;if((V=u[m]).glType==B&&V._geomType===E&&!i.compareGASMaterial(G,V.gas)&&(null==C&&null==V.material||null!=C&&null!=V.material&&C.id==V.material.id&&C.file==V.material.file)){n&&R.push({start:N,count:V.count,radius:V.geometry._radius,rep:V.geometry.rep}),O+=V.count;for(var F=N,k=0;k<V._primitives.length;k++){var U=V._primitives[k],L=new i.SGPrimitive({cgmId:U.cgmId,rep:U.rep,start:F,count:U.count});U.decoration&&(L.decoration=U.decoration),U.boundingSphere&&(L.boundingSphere=U.boundingSphere),T.push(L),U.rep._primitives.push(L),F+=U.count}for(_=0;_<V.count;_++)g[N++]=V.vbStart+V.ib[V.start+_]}else{var j=null;if(O>0){(j=new i.DrawingGroup(G,C,B,M,O,void 0,void 0,E,z))._primitives=T,n&&(j.cullingData=R);for(var H=0;H<T.length;H++)T[H].group=j;w.push(j)}T=[],R=[],0!==i.compareGASMaterial(D,V.gas)&&(D=V.gas,z++),B=V.glType,E=V._geomType,G=V.gas,C=V.material,M=N,O=V.count,n&&R.push({start:N,count:V.count,radius:V.geometry._radius,rep:V.geometry.rep});for(F=N,k=0;k<V._primitives.length;k++){U=V._primitives[k],L=new i.SGPrimitive({cgmId:U.cgmId,rep:U.rep,start:F,count:U.count});U.decoration&&(L.decoration=U.decoration),U.boundingSphere&&(L.boundingSphere=U.boundingSphere),T.push(L),U.rep._primitives.push(L),F+=U.count}for(_=0;_<V.count;_++)g[N++]=V.vbStart+V.ib[V.start+_]}}if(O>0){(j=new i.DrawingGroup(G,C,B,M,O,void 0,void 0,E,z))._primitives=T,n&&(j.cullingData=R);for(H=0;H<T.length;H++)T[H].group=j;w.push(j)}var q=new i.Mesh;if(q.vertexPositionArray=v,q.vertexNormalArray=f,q.vertexUvArray=y,q.vertexUv2Array=x,q.vertexTangentArray=b,q.vertexBinormalArray=A,q.vertexIndexArray=g,q.drawingGroups=w,void 0===e[0]){var W=new t.Color;W.setRGB(.5,.5,.5),q.gas.fill={color:W,opacity:1,solid:0},q.gas.line={color:W,opacity:1,lineWidth:1},q.gas.point={color:W,opacity:1,pointsize:1}}else q.gas=e[0].gas;if(a){var X=[0,0,0],K=[0,0,0];if(o>=3){X=[v[0],v[1],v[2]],K=[v[0],v[1],v[2]];for(m=0;m<o;m+=3)v[m]<X[0]&&(X[0]=v[m]),v[m+1]<X[1]&&(X[1]=v[m+1]),v[m+2]<X[2]&&(X[2]=v[m+2]),v[m]>K[0]&&(K[0]=v[m]),v[m+1]>K[1]&&(K[1]=v[m+1]),v[m+2]>K[2]&&(K[2]=v[m+2])}q.AABB={min:X,max:K}}return q},i.divideRep=function(t,e,r){var n=t.vertexPositionArray?t.vertexPositionArray.length:0,o=(t.vertexIndexArray.length,[]),s=r||{};if(e)for(var a=0,u=(s=r||{}).withBoundingElement,l=0;l<t.drawingGroups.length;l++){null==(y=t.drawingGroups[l]).gas&&(4==y.glType||5==y.glType?y.gas=t.gas.fill:1==y.glType?y.gas=t.gas.line:0==y.glType&&(y.gas=t.gas.point)),a=y._primitives.length;var c=new Uint32Array(5*a),h=null;u&&y.glType>0&&(h=new Float32Array(4*a));var p=0,d=0;if(t.noShow&&s.containNoShow)for(var m=0;m<y._primitives.length;m++){var g=y._primitives[m];noShowPrim.push(m),c[p++]=g.cgmId+1,c[p++]=t.rep,c[p++]=g.start,c[p++]=g.count,c[p++]=g.decoration,h&&g.boundingSphere&&(h[d++]=g.boundingSphere.center[0],h[d++]=g.boundingSphere.center[1],h[d++]=g.boundingSphere.center[2],h[d++]=g.boundingSphere.radius)}else for(m=0;m<y._primitives.length;m++){g=y._primitives[m];c[p++]=g.cgmId+1,c[p++]=t.rep,c[p++]=g.start,c[p++]=g.count,c[p++]=g.decoration,h&&g.boundingSphere&&(h[d++]=g.boundingSphere.center[0],h[d++]=g.boundingSphere.center[1],h[d++]=g.boundingSphere.center[2],h[d++]=g.boundingSphere.radius)}y._primitives=h?{prims:c,bs:h}:c}else for(m=0;m<t.drawingGroups.length;m++){null==(y=t.drawingGroups[m]).gas&&(4==y.glType||5==y.glType?y.gas=t.gas.fill:1==y.glType?y.gas=t.gas.line:0==y.glType&&(y.gas=t.gas.point));for(l=0;l<y._primitives.length;l++){g=y._primitives[l];var v=new i.SGPrimitive({cgmId:g.cgmId,rep:t.rep,group:y,start:g.start,count:g.count});g.decoration&&(v.decoration=g.decoration),g.boundingSphere&&(v.boundingSphere=g.boundingSphere),y._primitives[l]=v,t.rep._primitives.push(v)}}var f,y,x=t.vertexIndexArray;f=n/3<65535?new Uint16Array(x.length):new Uint32Array(x.length);for(var m=0;m<x.length;m++)f[m]=x[m];return t.vertexIndexArray=f,i.unindexPoints(t),o.push(t),o},i.unindexPoints=function(t){if(!n&&!o)return!1;if(!t.vertexPositionArray)return!1;var e,i,r=!1,s=t.vertexPositionArray.length/3,a=new Int32Array(s);for(e=0;e<s;e++)a[e]=-1;var u=0;for(e=0;e<t.drawingGroups.length;e++){if(!((c=t.drawingGroups[e]).glType>0)){for(r=!0,i=c.start;i<c.start+c.count;i++){-1===a[h=t.vertexIndexArray[i]]?(t.vertexIndexArray[i]=u,a[h]=u,u++):t.vertexIndexArray[i]=a[h]}c.nonIndexed=!0,c.start=t.vertexIndexArray[c.start]}}if(!r)return!1;var l=u;for(e=0;e<u;e++)if(-1===a[e])for(;l<s;){if(-1!==a[l]){a[e]=l,l++;break}a[l]=l,l++}for(;l<s;)-1===a[l]&&(a[l]=l),l++;for(e=0;e<t.drawingGroups.length;e++){var c;if(0!==(c=t.drawingGroups[e]).glType)for(i=c.start;i<c.start+c.count;i++){var h=t.vertexIndexArray[i];t.vertexIndexArray[i]=a[h]}}var p=[];t.vertexPositionArray&&p.push(t.vertexPositionArray),t.vertexNormalArray&&p.push(t.vertexNormalArray),t.vertexUvArray&&p.push(t.vertexUvArray),t.vertexUv2Array&&p.push(t.vertexUv2Array),t.vertexTangentArray&&p.push(t.vertexTangentArray),t.vertexBinormalArray&&p.push(t.vertexBinormalArray);var d=new Float32Array(3*p.length),m=new Float32Array(3*p.length);for(e=0;e<s;e++){var g=e,v=a[g];if(v!==g&&-1!==v){for(i=0;i<p.length;i++){var f=p[i];d[3*i]=f[3*g],d[3*i+1]=f[3*g+1],d[3*i+2]=f[3*g+2]}for(;-1!==v;){for(i=0;i<p.length;i++){f=p[i];m[3*i]=f[3*v],m[3*i+1]=f[3*v+1],m[3*i+2]=f[3*v+2],f[3*v]=d[3*i],f[3*v+1]=d[3*i+1],f[3*v+2]=d[3*i+2],d[3*i]=m[3*i],d[3*i+1]=m[3*i+1],d[3*i+2]=m[3*i+2]}a[g]=-1,v=a[g=v]}}}return!0},i.compareGASMaterial=function(t,e){if(t.opacity<e.opacity)return-1;if(t.opacity>e.opacity)return 1;if(t.color.r<e.color.r)return-1;if(t.color.r>e.color.r)return 1;if(t.color.g<e.color.g)return-1;if(t.color.g>e.color.g)return 1;if(t.color.b<e.color.b)return-1;if(t.color.b>e.color.b)return 1;if(t.thickness&&e.thickness){if(t.thickness<e.thickness)return-1;if(t.thickness>e.thickness)return 1}if(t.lineWidth&&e.lineWidth){if(t.pattern<e.pattern)return-1;if(t.pattern>e.pattern)return 1;if(t.lineWidth<e.lineWidth)return-1;if(t.lineWidth>e.lineWidth)return 1;if((t.forceMaterial||e.forceMaterial)&&(!t.forceMaterial||!e.forceMaterial))return t.forceMaterial?-1:1}if(t.pointsize&&e.pointsize){if(t.pointsize<e.pointsize)return-1;if(t.pointsize>e.pointsize)return 1;if((t.forceMaterial||e.forceMaterial)&&(!t.forceMaterial||!e.forceMaterial))return t.forceMaterial?-1:1}if(t.symbol&&e.symbol){if(t.symbol<e.symbol)return-1;if(t.symbol>e.symbol)return 1;if(t.symbol.id<e.symbol.id)return-1;if(t.symbol.id>e.symbol.id)return 1}if(null!=t.solid&&null!=e.solid){if(t.solid<e.solid)return-1;if(t.solid>e.solid)return 1}return 0},i.applyMat=function(e,i,r,n){if(null!=i){if(e.vertexNormalArray)for(var o=0;o<e.vertexNormalArray.length;o+=3){(s=new t.Vector3(e.vertexNormalArray[o],e.vertexNormalArray[o+1],e.vertexNormalArray[o+2])).applyMatrix4(n),e.vertexNormalArray[o]=s.x,e.vertexNormalArray[o+1]=s.y,e.vertexNormalArray[o+2]=s.z}if(e.vertexPositionArray){for(o=0;o<e.vertexPositionArray.length;o+=3){var s;(s=new t.Vector3(e.vertexPositionArray[o],e.vertexPositionArray[o+1],e.vertexPositionArray[o+2])).applyMatrix4(i),e.vertexPositionArray[o]=s.x,e.vertexPositionArray[o+1]=s.y,e.vertexPositionArray[o+2]=s.z}var a=e.drawingGroups;for(o=0;o<a.length;++o){var u=(d=a[o]).material;if(!(!u||u.id<0||!r[u.id].physicalMaterial||!r[u.id].physicalMaterial.PhysicalMaterial.MappingOperator&&!r[u.id].mapping||r[u.id].physicalMaterial.PhysicalMaterial.MappingOperator&&"None"==r[u.id].physicalMaterial.PhysicalMaterial.MappingOperator.Type||r[u.id].mapping&&r[u.id].mapping.type<0)){var l=(new t.Matrix4).getInverse(i),c=JSON.parse(JSON.stringify(r[u.id])),h=c.physicalMaterial.PhysicalMaterial.MappingOperator;h||(h=c.mapping),h&&h.UvTransformation&&(h.UvTransformation=h.UvTransformation.slice(0));var p=new t.Matrix4;h&&h.ObjectTransformation&&(p.elements=h.ObjectTransformation.slice(0)),p.multiply(l),h.ObjectTransformation=p.elements,d.material.id=r.length,r.push(c)}}if(i.determinant()<0)for(o=0;o<a.length;++o){var d;if(4==(d=a[o]).glType)for(var m=d.count/3,g=0;g<m;g++){var v=e.vertexIndexArray[d.start+3*g],f=e.vertexIndexArray[d.start+3*g+1];e.vertexIndexArray[d.start+3*g]=f,e.vertexIndexArray[d.start+3*g+1]=v}}}}},i.computeBB=function(t){var e=[0,0,0],i=[0,0,0];if(t.vertexPositionArray){var r=t.vertexPositionArray.length;if(r>=3){e=[t.vertexPositionArray[0],t.vertexPositionArray[1],t.vertexPositionArray[2]],i=[t.vertexPositionArray[0],t.vertexPositionArray[1],t.vertexPositionArray[2]];for(var n=0;n<r;n+=3)t.vertexPositionArray[n]<e[0]&&(e[0]=t.vertexPositionArray[n]),t.vertexPositionArray[n+1]<e[1]&&(e[1]=t.vertexPositionArray[n+1]),t.vertexPositionArray[n+2]<e[2]&&(e[2]=t.vertexPositionArray[n+2]),t.vertexPositionArray[n]>i[0]&&(i[0]=t.vertexPositionArray[n]),t.vertexPositionArray[n+1]>i[1]&&(i[1]=t.vertexPositionArray[n+1]),t.vertexPositionArray[n+2]>i[2]&&(i[2]=t.vertexPositionArray[n+2])}}t.AABB={min:e,max:i}},i._getCurrentSag=function(t,e){if(!t)return console.warn("No sag setting"),.2;let i=.2,r=t.scale?t.scale:1;switch(t.sagMode){case 0:e>0&&(i=.01*e*t.sag);break;case 1:i=t.sag*r;break;case 2:i=.2*r;break;case 3:i=.4*r}return i<.01&&(i=.01),e>0&&i>.1*e&&(i=.1*e),i},i._computeMaxAngleStep=function(t,e){let i=2*Math.acos(1-t/e);return i<.001&&(i=.001),i},i._computeAngleStep=function(t,e){return t/e},i._computeNbCirclePoints=function(t,e){let i=Math.PI/4;e>i&&(e=i);let r=Math.ceil(t/e);return r<3&&(r=3),[r,e=this._computeAngleStep(t,r)]},i._createCustomCylindricalMesh=function(e,r,n,o,s,a,u,l,c,h){var p=o>0,d=n>0,m=new t.Vector3(r[0],r[1],r[2]),g=new t.Vector3(e[0],e[1],e[2]),x=new t.Vector4;x.subVectors(m,g),x.w=0,x.normalize();var b=new t.Matrix4;0===x.x&&0===x.y?b.identity():b.set(x.x/Math.sqrt(x.x*x.x+x.y*x.y),x.y/Math.sqrt(x.x*x.x+x.y*x.y),0,0,-x.y/Math.sqrt(x.x*x.x+x.y*x.y),x.x/Math.sqrt(x.x*x.x+x.y*x.y),0,0,0,0,1,0,0,0,0,1);var A=new t.Matrix4;0===x.x&&0===x.y&&0===x.z?A.identity():A.set(x.z/Math.sqrt(x.x*x.x+x.y*x.y+x.z*x.z),0,-Math.sqrt(x.x*x.x+x.y*x.y)/Math.sqrt(x.x*x.x+x.y*x.y+x.z*x.z),0,0,1,0,0,Math.sqrt(x.x*x.x+x.y*x.y)/Math.sqrt(x.x*x.x+x.y*x.y+x.z*x.z),0,x.z/Math.sqrt(x.x*x.x+x.y*x.y+x.z*x.z),0,0,0,0,1);var I=new t.Matrix4;I.multiplyMatrices(A,b),I.transpose();var _=new t.Vector3(g.x,g.y,g.z),S=I.clone();I.elements[12]=_.x,I.elements[13]=_.y,I.elements[14]=_.z;var P=Math.sqrt((g.x-m.x)*(g.x-m.x)+(g.y-m.y)*(g.y-m.y)+(g.z-m.z)*(g.z-m.z));let w=Math.max(n,o),T=this._getCurrentSag(u,w),G=this._computeMaxAngleStep(T,w),C=0;[C,G]=this._computeNbCirclePoints(2*Math.PI,G);var B=(n-o)/P,E=6*C,N=2*C,M=2*C;p&&(E+=3*(C-2)+2*C,C,M+=C,N+=C),d&&(E+=3*(C-2)+2*C,C,M+=C,N+=C);for(var O=6*C+(p?3*(C-2):0)+(d?3*(C-2):0),z=(p?2*C:0)+(d?2*C:0),D=new Uint16Array(E),R=D,V=0,F=0;F<C-1;++F){var k=F+1;R[V++]=F,R[V++]=k,R[V++]=C+k,R[V++]=F,R[V++]=C+k,R[V++]=C+F}k=0;if(R[V++]=C-1,R[V++]=k,R[V++]=C+k,R[V++]=C-1,R[V++]=C+k,R[V++]=C+C-1,p)for(F=0;F<C-2;F++)R[V++]=2*C,R[V++]=2*C+F+1,R[V++]=2*C+F+2;if(d)if(p)for(F=0;F<C-2;F++)R[V++]=3*C,R[V++]=3*C+F+2,R[V++]=3*C+F+1;else for(F=0;F<C-2;F++)R[V++]=2*C,R[V++]=2*C+F+2,R[V++]=2*C+F+1;if(p){for(F=0;F<C-1;++F)R[V++]=C+F,R[V++]=C+F+1;R[V++]=C+C-1,R[V++]=C}if(d){for(F=0;F<C-1;++F)R[V++]=F,R[V++]=F+1;R[V++]=C-1,R[V++]=0}var U=new Float32Array(3*N),L=new Float32Array(3*N),j=U,H=L,q=0;for(F=0;F<C;F++,q+=3){var W=F/C*2*Math.PI;j[q]=n*Math.cos(W),j[q+1]=n*Math.sin(W),j[q+2]=0,H[q]=F/C,H[q+1]=1,H[q+2]=0}q=3*C;for(F=0;F<C;F++,q+=3){W=F/C*2*Math.PI;j[q]=o*Math.cos(W),j[q+1]=o*Math.sin(W),j[q+2]=P,H[q]=F/C,H[q+1]=0,H[q+2]=0}if(p){W=0;for(var X=0;X<C;X++)W=X/C*2*Math.PI,j[q]=j[3*(C+X)],H[q++]=(Math.cos(W)+1)/2,j[q]=j[3*(C+X)+1],H[q++]=1-(Math.sin(W)+1)/2,j[q]=j[3*(C+X)+2],H[q++]=0}if(d)for(W=0,X=0;X<C;X++)W=X/C*2*Math.PI,j[q]=j[3*X],H[q++]=(Math.cos(W)+1)/2,j[q]=j[3*X+1],H[q++]=1-(Math.sin(W)+1)/2,j[q]=j[3*X+2],H[q++]=0;var K=new Float32Array(3*M);j=K;q=0;for(var Y=0;Y<2;Y++)for(F=0;F<C;F++){W=F/C*2*Math.PI;(J=new t.Vector3).x=U[3*F],J.y=U[3*F+1],J.z=U[3*F+2],J.z=Math.sqrt(J.x*J.x+J.y*J.y)*B,J.normalize(),j[q++]=J.x,j[q++]=J.y,j[q++]=J.z}if(p)for(Y=0;Y<C;Y++)j[q++]=0,j[q++]=0,j[q++]=1;if(d)for(Y=0;Y<C;Y++)j[q++]=0,j[q++]=0,j[q++]=-1;for(X=0;X<N;X++){(J=new t.Vector3).x=U[3*X],J.y=U[3*X+1],J.z=U[3*X+2],J.applyMatrix4(I),U[3*X]=J.x,U[3*X+1]=J.y,U[3*X+2]=J.z}for(X=0;X<M;X++){var J;(J=new t.Vector3).x=K[3*X],J.y=K[3*X+1],J.z=K[3*X+2],J.applyMatrix4(S),K[3*X]=J.x,K[3*X+1]=J.y,K[3*X+2]=J.z}var Z,Q=new i.Mesh;Q.vertexPositionArray=U,Q.vertexNormalArray=K,Q.vertexUVArray=L,Q.vertexIndexArray=D,Q.gas=s,Q.matId=a,l?(s.setConnectivity(0),(Z=h).setConnectivity(3)):Z=s.line?s.line:s;var $=new i.DrawingGroup(s,a,4,0,O,[],null,t.GeomTypeEnum.FACE),tt=new i.DrawingGroup(Z,a,1,O,z,[],null,t.GeomTypeEnum.SHARP_EDGE);O=6*C+(p?3*(C-2):0)+(d?3*(C-2):0),z=(p?2*C:0)+(d?2*C:0);let et=0,it=[r[0]-e[0],r[1]-e[1],r[2]-e[2]];if(p||d){let t=new i.SGPrimitive({cgmId:et++,group:tt,start:O,count:2*C});if(tt._primitives.push(t),c){let i;i=p?y(r,it,o):y(e,it,n),t.decoration=c.addDecoration(i)}}if(p&&d){let t=new i.SGPrimitive({cgmId:et++,group:tt,start:O+2*C,count:2*C});if(tt._primitives.push(t),c){let i=y(e,it,n);t.decoration=c.addDecoration(i)}}var rt=new i.SGPrimitive({cgmId:et++,group:$,start:0,count:6*C});if($._primitives.push(rt),c)if(o==n){let t=v(e,it,o);rt.decoration=c.addDecoration(t)}else{if(o>n){let t=e;e=r,r=t,t=n,n=o,o=t}let i=[e[0]-r[0],e[1]-r[1],e[2]-r[2]],s=new t.Vector3(i[0],i[1],i[2]).length(),a=s/(1-o/n);i[0]*=a/s,i[1]*=a/s,i[2]*=a/s;let u=[e[0]-i[0],e[1]-i[1],e[2]-i[2]],l=180*Math.atan(n/a)/Math.PI,h=f(u,i,l);rt.decoration=c.addDecoration(h)}return(p||d)&&(rt=new i.SGPrimitive({cgmId:et++,group:$,start:6*C,count:3*(C-2)}),$._primitives.push(rt)),p&&d&&(rt=new i.SGPrimitive({cgmId:et++,group:$,start:6*C+3*(C-2),count:3*(C-2)}),$._primitives.push(rt)),Q.drawingGroups.push($),Q.drawingGroups.push(tt),i.computeBB(Q),Q},i._createCustomSphereMesh=function(e,r,n,o,s,a,u,l,c,h,p,d){var g=new t.Vector3(a[0],a[1],a[2]),v=new t.Vector3(u[0],u[1],u[2]),f=g.length();e<-Math.PI/2&&(e=-Math.PI/2),e>Math.PI/2&&(e=Math.PI/2),r<-Math.PI/2&&(r=-Math.PI/2),r>Math.PI/2&&(r=Math.PI/2);var y=r-e;y<0&&(y=0),n<0&&(n=0),n>2*Math.PI&&(n=2*Math.PI),o<0&&(o=0),o>2*Math.PI&&(o=2*Math.PI);var x=o-n;x<0&&(x=0);let b=this._getCurrentSag(h,f),A=this._computeMaxAngleStep(b,f),I=0,_=0,S=0,P=0;[I,S]=this._computeNbCirclePoints(x,A),[_,P]=this._computeNbCirclePoints(2*y,A),I+=1,_+=1;this._computeAngleStep(x,I-1),this._computeAngleStep(y,_-1);for(var w=3*(I+1)*_,T=6*I*(_-1),G=new Float32Array(w),C=new Float32Array(w),B=new Float32Array(w),E=new Uint16Array(T),N=G,M=C,O=B,z=g.normalize(),D=v.normalize(),R=(new t.Vector3).crossVectors(z,D),V=E,F=0,k=0;k<_-1;k++)for(K=0;K<I;K++)V[F++]=k*(I+1)+K,V[F++]=(k+1)*(I+1)+K+1,V[F++]=(k+1)*(I+1)+K,V[F++]=k*(I+1)+K,V[F++]=k*(I+1)+K+1,V[F++]=(k+1)*(I+1)+K+1;F=0;var U=1/(_-1),L=(new t.Vector3,new t.Vector3),j=new t.Vector3,H=new t.Vector3;for(k=0;k<_;k++)for(var q=k*U,W=Math.sin(e+q*y),X=Math.cos(e+q*y),K=0;K<=I;K++,F+=3){var Y=K/I,J=Math.sin(n+Y*x),Z=Math.cos(n+Y*x);L.copy(z),L.multiplyScalar(Z),j.copy(D),j.multiplyScalar(J),H.copy(R),H.multiplyScalar(W),L.add(j),L.multiplyScalar(X),L.add(H);var Q=L;M[F]=Q.x,N[F]=s[0]+Q.x*f,O[F]=Y,M[F+1]=Q.y,N[F+1]=s[1]+Q.y*f,O[F+1]=k/_,M[F+2]=Q.z,N[F+2]=s[2]+Q.z*f,O[F+2]=0}var $=new i.Mesh;$.vertexPositionArray=G,$.vertexNormalArray=C,$.vertexUVArray=B,$.vertexIndexArray=E,$.gas=l,$.matId=c,p&&l.setConnectivity(0);var tt=new i.DrawingGroup(l,c,4,0,T,[],null,t.GeomTypeEnum.FACE),et=new i.SGPrimitive({cgmId:0,group:tt,start:0,count:T});if(d){let t=m(s,f);et.decoration=d.addDecoration(t)}return tt._primitives.push(et),$.drawingGroups.push(tt),i.computeBB($),$},i._buildCurvedPipeDataFromTorus=function(e,i,r,n,o,s){var a=[],u=(new t.Vector3).copy(i),l=(new t.Vector3).copy(r);let c=u.length();s&&(c+=s);let h=this._getCurrentSag(o,c),p=this._computeMaxAngleStep(h,c),d=0;[d,p]=this._computeNbCirclePoints(n,p);for(var m=0,g=0;g<d+1;g++){var v=Math.cos(m),f=Math.sin(m);u.copy(i).multiplyScalar(v),l.copy(r).multiplyScalar(f),u.add(l).add(e),a.push(u.x),a.push(u.y),a.push(u.z),m+=p}if(i.normalize(),r.normalize(),n==2*Math.PI){a.push(a[0]),a.push(a[1]),a.push(a[2]);var y=[-r.x,-r.y,-r.z],x=[r.x,r.y,r.z]}else{y=[-r.x,-r.y,-r.z];u.crossVectors(i,r);var b=a.length;l.set(a[b-3],a[b-2],a[b-1]).sub(e).normalize(),u.cross(l).normalize();x=[u.x,u.y,u.z]}return{centers:a,startNormal:y,endNormal:x}},i._createTorusMesh=function(e,r,n,o,s,a,u,l,c){var h=new t.Vector3,p=new t.Vector3;h.subVectors(r[0],e);let d=h.length();p.crossVectors(h,o).normalize();let m=this._getCurrentSag(u,n[0]),v=this._computeMaxAngleStep(m,n[0]),f=0;[f,v]=this._computeNbCirclePoints(2*Math.PI,v);for(var y=3*r.length*f,x=6*f*(r.length-1),b=new Float32Array(y),A=new Float32Array(y),I=new Float32Array(y),_=new Uint16Array(x),S=b,P=A,w=I,T=_,G=new t.Vector3,C=new t.Vector3,B=new t.Vector3,E=new t.Vector3,N=0,M=0;M<r.length;M++){0==M||M==r.length-1?G.copy(o).negate():(B.subVectors(r[M],r[M-1]),G.subVectors(r[M+1],r[M]),G.add(B)),G.normalize(),C.crossVectors(G,p),C.normalize();for(var O=0,z=0;z<f;z++)B.copy(C).multiplyScalar(Math.cos(O)),E.copy(p).multiplyScalar(Math.sin(O)),B.add(E),P[N]=B.x,P[N+1]=B.y,P[N+2]=B.z,B.multiplyScalar(n[M]),B.add(r[M]),S[N]=B.x,S[N+1]=B.y,S[N+2]=B.z,w[N++]=z/f,w[N++]=M/r.length,w[N++]=0,O+=v}N=0;for(M=0;M<r.length-1;M++)for(z=0;z<f;z++){var D=(z+1)%f;T[N++]=M*f+z,T[N++]=(M+1)*f+z,T[N++]=(M+1)*f+D,T[N++]=M*f+z,T[N++]=(M+1)*f+D,T[N++]=M*f+D}var R=new i.Mesh;R.vertexPositionArray=b,R.vertexNormalArray=A,R.vertexUVArray=I,R.vertexIndexArray=_,R.gas=s,R.matId=a,l&&s.setConnectivity(0);var V=new i.DrawingGroup(s,a,4,0,x,[],null,t.GeomTypeEnum.FACE),F=new i.SGPrimitive({cgmId:0,group:V,start:0,count:6*f*(r.length-1)});if(V._primitives.push(F),c){let t=g(e,p,n[0],d);F.decoration=c.addDecoration(t)}return R.drawingGroups.push(V),i.computeBB(R),R},i._createCurvedPipeMesh=function(e,r,n,o,s,a,u,l,c,h,p,d){let m=r[0];for(let t=1;t<r.length;t++)r[t]>m&&(m=r[t]);let v=this._getCurrentSag(l,m),f=this._computeMaxAngleStep(v,m),y=0;[y,f]=this._computeNbCirclePoints(2*Math.PI,f);var x=3*e.length*y,b=6*y*(e.length-1),A=0;s&&(x+=6*y,b+=6*(y-2),A=4*y);var I=new Float32Array(x),_=new Float32Array(x),S=new Float32Array(x),P=new Uint16Array(b+A),w=I,T=_,G=S,C=P,B=new t.Vector3,E=new t.Vector3,N=new t.Vector3,M=new t.Vector3,O=new t.Vector3;if(e.length>=3)M.subVectors(e[1],e[0]),N.subVectors(e[2],e[1]),B.crossVectors(M,N).normalize(),M.copy(n).negate(),N.crossVectors(M,B);else{M.copy(n).negate();var z=Math.abs(M.x),D=Math.abs(M.y),R=Math.abs(M.z),V=.001;z>D?D>R?O.set(0,D+V,R+V):z>R?O.set(0,D+V,R+V):O.set(z+V,D+V,0):z>R?O.set(z+V,0,R+V):D>R?O.set(z+V,0,R+V):O.set(z+V,D+V,0),N.crossVectors(M,O)}for(var F=0,k=0;k<e.length;k++){N.normalize(),0==k?E.copy(n).negate():k==e.length-1?E.copy(o):(M.subVectors(e[k],e[k-1]),E.subVectors(e[k+1],e[k]),E.add(M)),E.normalize(),B.crossVectors(N,E),B.normalize(),k>0&&N.crossVectors(E,B);for(var U=0,L=0;L<y;L++)M.copy(N).multiplyScalar(Math.cos(U)),O.copy(B).multiplyScalar(Math.sin(U)),M.add(O),T[F]=M.x,T[F+1]=M.y,T[F+2]=M.z,M.multiplyScalar(r[k]),M.add(e[k]),w[F]=M.x,w[F+1]=M.y,w[F+2]=M.z,G[F++]=L/y,G[F++]=k/e.length,G[F++]=0,U+=f}if(s){for(L=0;L<y;L++)T[F]=n.x,T[F+1]=n.y,T[F+2]=n.z,w[F++]=w[3*L],w[F++]=w[3*L+1],w[F++]=w[3*L+2];var j=y*(e.length-1)*3;for(L=0;L<y;L++)T[F]=o.x,T[F+1]=o.y,T[F+2]=o.z,w[F++]=w[j+3*L],w[F++]=w[j+3*L+1],w[F++]=w[j+3*L+2]}F=0;for(k=0;k<e.length-1;k++)for(L=0;L<y;L++){var H=(L+1)%y;C[F++]=k*y+L,C[F++]=(k+1)*y+L,C[F++]=(k+1)*y+H,C[F++]=k*y+L,C[F++]=(k+1)*y+H,C[F++]=k*y+H}if(s){for(k=0;k<y-2;k++)C[F++]=e.length*y,C[F++]=e.length*y+k+1,C[F++]=e.length*y+k+2;for(k=0;k<y-2;k++)C[F++]=(e.length+1)*y,C[F++]=(e.length+1)*y+k+2,C[F++]=(e.length+1)*y+k+1;for(k=0;k<y;k++)C[F++]=e.length*y+k,C[F++]=e.length*y+(k+1)%y;for(k=0;k<y;k++)C[F++]=(e.length+1)*y+k,C[F++]=(e.length+1)*y+(k+1)%y}var q=new i.Mesh;q.vertexPositionArray=I,q.vertexNormalArray=_,q.vertexUVArray=S,q.vertexIndexArray=P,q.gas=a,q.matId=u,c&&a.setConnectivity(0);var W=new i.DrawingGroup(a,u,4,0,b,[],null,t.GeomTypeEnum.FACE);let X=0;var K=new i.SGPrimitive({cgmId:X++,group:W,start:0,count:6*y*(e.length-1)});if(W._primitives.push(K),h&&p){let e=new t.Vector3(p.center[0],p.center[1],p.center[2]),i=new t.Vector3(p.firstAxis[0],p.firstAxis[1],p.firstAxis[2]),n=i.length(),o=new t.Vector3(p.secondAxis[0],p.secondAxis[1],p.secondAxis[2]),s=(new t.Vector3).crossVectors(i.normalize(),o.normalize()),a=g(e,s,r[0],n);K.decoration=h.addDecoration(a)}if(K=new i.SGPrimitive({cgmId:X++,group:W,start:6*y*(e.length-1),count:3*(y-2)}),W._primitives.push(K),K=new i.SGPrimitive({cgmId:X++,group:W,start:6*y*(e.length-1)+3*(y-2),count:3*(y-2)}),W._primitives.push(K),q.drawingGroups.push(W),A){var Y;c?(Y=d).setConnectivity(3):Y=a.line?a.line:a;var J=new i.DrawingGroup(Y,u,1,b,A,[],null,t.GeomTypeEnum.SHARP_EDGE);K=new i.SGPrimitive({cgmId:X++,group:J,start:b,count:A/2}),J._primitives.push(K),K=new i.SGPrimitive({cgmId:X++,group:J,start:b+A/2,count:A/2}),J._primitives.push(K),q.drawingGroups.push(J)}return i.computeBB(q),q},i._createCuboidMesh=function(e,r,n,o,s,a,u,l,c){var h=new i.Mesh;h.gas=s,h.matId=a;var p=new t.Vector3(e[0],e[1],e[2]),d=new t.Vector3(r[0],r[1],r[2]),m=new t.Vector3(n[0],n[1],n[2]),g=(new t.Vector3).crossVectors(d,m).normalize().multiplyScalar(o);h.vertexPositionArray=new Float32Array(72),h.vertexNormalArray=new Float32Array(72),h.vertexUVArray=new Float32Array(72);var v=h.vertexPositionArray,f=h.vertexNormalArray,y=h.vertexUVArray,x=new t.Vector3,b=new t.Vector3;b.copy(g).normalize();var A=new t.Vector3;A.copy(b).negate();var I=new t.Vector3;I.copy(m).normalize();var _=new t.Vector3;_.copy(I).negate();var S=new t.Vector3;S.copy(d).normalize();var P=new t.Vector3;P.copy(S).negate();var w=new t.Vector3(p.x,p.y,p.z),T=new t.Vector3(p.x,p.y,p.z),G=new t.Vector3(0,0,0),C=new t.Vector3(1,0,0),B=new t.Vector3(1,1,0),E=new t.Vector3(0,1,0);x.addVectors(p,g),w.min(x),T.max(x),v[9]=x.x,v[10]=x.y,v[11]=x.z,v[24]=x.x,v[25]=x.y,v[26]=x.z,v[48]=x.x,v[49]=x.y,v[50]=x.z,f[9]=b.x,f[10]=b.y,f[11]=b.z,f[24]=_.x,f[25]=_.y,f[26]=_.z,f[48]=P.x,f[49]=P.y,f[50]=P.z,y[9]=E.x,y[10]=E.y,y[11]=E.z,y[24]=G.x,y[25]=G.y,y[26]=G.z,y[48]=G.x,y[49]=G.y,y[50]=G.z,x.add(d),w.min(x),T.max(x),v[6]=x.x,v[7]=x.y,v[8]=x.z,v[27]=x.x,v[28]=x.y,v[29]=x.z,v[60]=x.x,v[61]=x.y,v[62]=x.z,f[6]=b.x,f[7]=b.y,f[8]=b.z,f[27]=_.x,f[28]=_.y,f[29]=_.z,f[60]=S.x,f[61]=S.y,f[62]=S.z,y[6]=B.x,y[7]=B.y,y[8]=B.z,y[27]=C.x,y[28]=C.y,y[29]=C.z,y[60]=G.x,y[61]=G.y,y[62]=G.z,x.add(m),w.min(x),T.max(x),v[3]=x.x,v[4]=x.y,v[5]=x.z,v[36]=x.x,v[37]=x.y,v[38]=x.z,v[63]=x.x,v[64]=x.y,v[65]=x.z,f[3]=b.x,f[4]=b.y,f[5]=b.z,f[36]=I.x,f[37]=I.y,f[38]=I.z,f[63]=S.x,f[64]=S.y,f[65]=S.z,y[3]=C.x,y[4]=C.y,y[5]=C.z,y[36]=G.x,y[37]=G.y,y[38]=G.z,y[63]=C.x,y[64]=C.y,y[65]=C.z,x.addVectors(p,g),x.add(m),w.min(x),T.max(x),v[0]=x.x,v[1]=x.y,v[2]=x.z,v[39]=x.x,v[40]=x.y,v[41]=x.z,v[57]=x.x,v[58]=x.y,v[59]=x.z,f[0]=b.x,f[1]=b.y,f[2]=b.z,f[39]=I.x,f[40]=I.y,f[41]=I.z,f[57]=P.x,f[58]=P.y,f[59]=P.z,y[0]=G.x,y[1]=G.y,y[2]=G.z,y[39]=C.x,y[40]=C.y,y[41]=C.z,y[57]=E.x,y[58]=E.y,y[59]=E.z,x.addVectors(p,m),w.min(x),T.max(x),v[21]=x.x,v[22]=x.y,v[23]=x.z,v[42]=x.x,v[43]=x.y,v[44]=x.z,v[54]=x.x,v[55]=x.y,v[56]=x.z,f[21]=A.x,f[22]=A.y,f[23]=A.z,f[42]=I.x,f[43]=I.y,f[44]=I.z,f[54]=P.x,f[55]=P.y,f[56]=P.z,y[21]=E.x,y[22]=E.y,y[23]=E.z,y[42]=B.x,y[43]=B.y,y[44]=B.z,y[54]=B.x,y[55]=B.y,y[56]=B.z,x.add(d),w.min(x),T.max(x),v[18]=x.x,v[19]=x.y,v[20]=x.z,v[45]=x.x,v[46]=x.y,v[47]=x.z,v[66]=x.x,v[67]=x.y,v[68]=x.z,f[18]=A.x,f[19]=A.y,f[20]=A.z,f[45]=I.x,f[46]=I.y,f[47]=I.z,f[66]=S.x,f[67]=S.y,f[68]=S.z,y[18]=B.x,y[19]=B.y,y[20]=B.z,y[45]=E.x,y[46]=E.y,y[47]=E.z,y[66]=B.x,y[67]=B.y,y[68]=B.z,x.addVectors(p,d),w.min(x),T.max(x),v[15]=x.x,v[16]=x.y,v[17]=x.z,v[30]=x.x,v[31]=x.y,v[32]=x.z,v[69]=x.x,v[70]=x.y,v[71]=x.z,f[15]=A.x,f[16]=A.y,f[17]=A.z,f[30]=_.x,f[31]=_.y,f[32]=_.z,f[69]=S.x,f[70]=S.y,f[71]=S.z,y[15]=C.x,y[16]=C.y,y[17]=C.z,y[30]=B.x,y[31]=B.y,y[32]=B.z,y[69]=E.x,y[70]=E.y,y[71]=E.z,v[12]=p.x,v[13]=p.y,v[14]=p.z,v[33]=p.x,v[34]=p.y,v[35]=p.z,v[51]=p.x,v[52]=p.y,v[53]=p.z,f[12]=A.x,f[13]=A.y,f[14]=A.z,f[33]=_.x,f[34]=_.y,f[35]=_.z,f[51]=P.x,f[52]=P.y,f[53]=P.z,y[12]=G.x,y[13]=G.y,y[14]=G.z,y[33]=E.x,y[34]=E.y,y[35]=E.z,y[51]=C.x,y[52]=C.y,y[53]=C.z,h.vertexIndexArray=new Uint16Array(60);for(var N=h.vertexIndexArray,M=0,O=0;O<6;O++)N[M++]=4*O,N[M++]=4*O+2,N[M++]=4*O+1,N[M++]=4*O,N[M++]=4*O+3,N[M++]=4*O+2;for(O=0;O<2;O++)N[M++]=4*O,N[M++]=4*O+1,N[M++]=4*O+1,N[M++]=4*O+2,N[M++]=4*O+2,N[M++]=4*O+3,N[M++]=4*O+3,N[M++]=4*O;N[M++]=0,N[M++]=7,N[M++]=1,N[M++]=6,N[M++]=2,N[M++]=5,N[M++]=3,N[M++]=4,u&&s.setConnectivity(0);var z,D=new i.DrawingGroup(s,a,4,0,36,[],null,t.GeomTypeEnum.FACE);u?(z=c).setConnectivity(3):z=s.line?s.line:s;var R=new i.DrawingGroup(z,a,1,36,24,[],null,t.GeomTypeEnum.SHARP_EDGE);let V=0;for(O=0;O<6;O++){var F=new i.SGPrimitive({cgmId:V++,cgmId:O,group:D,start:6*O,count:6});D._primitives.push(F)}for(O=0;O<12;O++){F=new i.SGPrimitive({cgmId:V++,cgmId:O,group:R,start:36+2*O,count:2});R._primitives.push(F)}h.drawingGroups.push(D),h.drawingGroups.push(R);var k=[w.x,w.y,w.z],U=[T.x,T.y,T.z];return h.AABB={min:k,max:U},h};let m=function(t,e){let i=[0,52,53];return A(i,t[0]),A(i,t[1]),A(i,t[2]),A(i,e),i[0]=i.length,i},g=function(t,e,i,r){let n=[0,52,56];return A(n,t.x),A(n,t.y),A(n,t.z),A(n,e.x),A(n,e.y),A(n,e.z),A(n,r),A(n,i),n[0]=n.length,n},v=function(t,e,i){let r=[0,52,51];return A(r,t[0]),A(r,t[1]),A(r,t[2]),A(r,e[0]),A(r,e[1]),A(r,e[2]),A(r,i),r[0]=r.length,r},f=function(t,e,i){let r=[0,52,52];return A(r,t[0]),A(r,t[1]),A(r,t[2]),A(r,e[0]),A(r,e[1]),A(r,e[2]),A(r,i),r[0]=r.length,r},y=function(t,e,i){let r=[0,52,55];return A(r,t[0]),A(r,t[1]),A(r,t[2]),A(r,e[0]),A(r,e[1]),A(r,e[2]),A(r,i),r[0]=r.length,r},x=new Uint8Array(8),b=new DataView(x.buffer,0,8),A=function(t,e){b.setFloat64(0,e),t.push(x[0]),t.push(x[1]),t.push(x[2]),t.push(x[3]),t.push(x[4]),t.push(x[5]),t.push(x[6]),t.push(x[7])},I=new Uint8Array(4);new DataView(I.buffer,0,4);return i}),define("Mesh/Mesh",["DS/Mesh/Mesh","DS/DSMigration/DSMigration"],function(t,e){return e.deprecateModule("Mesh/Mesh"),t});