define("DS/Mesh/MeshUtils",["DS/Mesh/Mesh","DS/Visualization/ThreeJS_DS","DS/Visualization/MaterialManager","DS/Visualization/GraphicAttributeSet"],function(e,r,a,t){"use strict";return e.convertTo3jsGeometry=function(e,a){if(e.length){for(var t=[],n=null,o=null,l=new r.Sphere,i=new r.Box3,s=0;s<e.length;s++){var u=e[s],v=new r.BufferGeometryDS,y=new r.Vector3(u.AABB.min[0],u.AABB.min[1],u.AABB.min[2]),c=new r.Vector3(u.AABB.max[0],u.AABB.max[1],u.AABB.max[2]);null==n&&(n=y),null==o&&(o=c),y.x<n.x&&(n.x=y.x),y.y<n.y&&(n.y=y.y),y.z<n.z&&(n.z=y.z),c.x>o.x&&(o.x=c.x),c.y>o.y&&(o.y=c.y),c.z>o.z&&(o.z=c.z),i.set(n,o),l.radius=o.clone().sub(n).multiplyScalar(.5).length(),l.center=o.clone().add(n).multiplyScalar(.5);for(var g=0;g<u.drawingGroups.length;g++)u.drawingGroups[g].geometry=v;v.drawingGroups=u.drawingGroups,v.vertexPositionArray=u.vertexPositionArray,null!==u.vertexNormalArray&&(v.vertexNormalArray=u.vertexNormalArray),null!==u.vertexUvArray&&(v.vertexUvArray=u.vertexUvArray),u.vertexUv2Array&&(v.vertexUv2Array=u.vertexUv2Array),u.vertexTangentArray&&(v.vertexTangentArray=u.vertexTangentArray),u.vertexBinormalArray&&(v.vertexBinormalArray=u.vertexBinormalArray),v.vertexIndexArray=u.vertexIndexArray,t.push(v)}return t.boundingSphere=l,t.boundingBox=i,t}},e.convertTo3jsMesh=function(n,o,l,i,s,u){if(n.length){for(var v=window.newMaterialInheritance,y=null,c=[],g=null,d=null,A=new r.Sphere,x=new r.Box3,h=new a,m=!1,p=0;p<n.length;p++){var w=n[p],f=new r.BufferGeometryDS;f.editable=w.editable,void 0!==i&&(f.sharedBuffers=i),void 0!==s&&(f.noMeshInRAM=s);var B=new r.Vector3(w.AABB.min[0],w.AABB.min[1],w.AABB.min[2]),M=new r.Vector3(w.AABB.max[0],w.AABB.max[1],w.AABB.max[2]);null==g&&(g=B),null==d&&(d=M),B.x<g.x&&(g.x=B.x),B.y<g.y&&(g.y=B.y),B.z<g.z&&(g.z=B.z),M.x>d.x&&(d.x=M.x),M.y>d.y&&(d.y=M.y),M.z>d.z&&(d.z=M.z),x.set(g,d),A.radius=d.clone().sub(g).multiplyScalar(.5).length(),A.center=d.clone().add(g).multiplyScalar(.5);for(var S=0;S<w.drawingGroups.length;S++){var T=w.drawingGroups[S];if(m||0!==T._geomType&&(m=!0),T.geometry=f,void 0!==l&&l){var G=null,b=null,N=T.gas,C=T.material;if(C)T.gas=C;else if(null!==N)if(null!=b&&e.areEqualGraphicProperties(b,N))T.gas=G;else{var U=new r.Color;U.setRGB(N.color.r,N.color.g,N.color.b);var z={color:U,opacity:N.opacity};N.linewidth&&(console.warn("DEPRECATED : Use lineWidth (cameCase) instead of linewidth."),N.lineWidth=N.linewidth),N.lineWidth?(z.lineWidth=N.lineWidth,N.pattern&&(z.pattern=N.pattern)):N.pointsize?(z.symbol=0,z.size=N.pointsize):z.solid=N.solid,T.gas=v?t._createFromGASAttributes(z):h.getMaterialFromGAS(z),G=T.gas,b=N}}}f.drawingGroups=w.drawingGroups,u&&(f.decorations=u),f.vertexPositionArray=w.vertexPositionArray,null!==w.vertexNormalArray&&(f.vertexNormalArray=w.vertexNormalArray),null!==w.vertexColorArray&&(f.vertexColorArray=w.vertexColorArray),null!==w.vertexUvArray&&(f.vertexUvArray=w.vertexUvArray),w.vertexUv2Array&&(f.vertexUv2Array=w.vertexUv2Array),w.vertexTangentArray&&(f.vertexTangentArray=w.vertexTangentArray),w.vertexBinormalArray&&(f.vertexBinormalArray=w.vertexBinormalArray),f.vertexIndexArray=w.vertexIndexArray,o&&(o.isDashedLine||o.backMaterial&&o.backMaterial.isDashedLine)&&f.computeLineDistances(n.patternOffsets),c.push(f)}A.radius||(A.radius=.1),x.min.distanceToSquared(x.max)||x.expandByScalar(.1),c.boundingSphere=A,c.boundingBox=x,(y=new r.Mesh(c,o)).matrixAutoUpdate=!1,y.castShadow=!0,y.receiveShadow=!0;var D=new e.SGBag;return D.children.push(n[0].rep),n[0].rep.parents.push(D),y.sceneGraph=D,y.fromLoadedModel=m,y}},e.createEmptyMesh=function(){var e=new r.BufferGeometryDS;e.boundingSphere=new r.Sphere(new r.Vector3,0),e.boundingBox=new r.Box3;var a=r.MaterialUtils.createShinyFaceMaterial();return mesh=new r.Mesh(e,a),mesh.matrixAutoUpdate=!1,mesh.castShadow=!0,mesh.receiveShadow=!0,new THREEDS.Nodes.Mesh(mesh)},e.convertTo3js=function(e,a,t,n){var o,l=null,i=[],s=null,u=null,v=new r.Sphere,y=new r.Box3,c=new THREEDS.MaterialManager;c.cleanResources();for(var g=0;g<e.length;g++){var d=e[g],A=new r.BufferGeometryDS,x=new r.Vector3(d.AABB.min[0],d.AABB.min[1],d.AABB.min[2]),h=new r.Vector3(d.AABB.max[0],d.AABB.max[1],d.AABB.max[2]);null==s&&(s=x),null==u&&(u=h),x.x<s.x&&(s.x=x.x),x.y<s.y&&(s.y=x.y),x.z<s.z&&(s.z=x.z),h.x>u.x&&(u.x=h.x),h.y>u.y&&(u.y=h.y),h.z>u.z&&(u.z=h.z),y.set(s,u),v.radius=u.clone().sub(s).multiplyScalar(.5).length(),v.center=u.clone().add(s).multiplyScalar(.5);for(var m=0;m<d.drawingGroups.length;m++){d.drawingGroups[m].geometry=A;var p=d.drawingGroups[m].gas,w=d.drawingGroups[m].material;if(n&&null!==w&&!w.file&&-1!==w.id)null!=n[w.id]?o=n[w.id]:(o=c.getMaterialCgr(a[w.id],void 0,"CGR",t,d.drawingGroups[m]),n[w.id]=o),d.drawingGroups[m].gas=o;else if(null!==p&&p.color){var f=new r.Color;f.setRGB(p.color.r,p.color.g,p.color.b),d.drawingGroups[m].gas=c.getMaterialFromGAS({color:f,opacity:p.opacity,lineWidth:p.lineWidth?p.lineWidth:p.linewidth,solid:p.solid,symbol:p.symbol,basic:p.basic,resource:t})}}A.drawingGroups=d.drawingGroups,A.vertexPositionArray=d.vertexPositionArray,null!==d.vertexNormalArray&&(A.vertexNormalArray=d.vertexNormalArray),null!==d.vertexUvArray&&(A.vertexUvArray=d.vertexUvArray),d.vertexUv2Array&&(A.vertexUv2Array=d.vertexUv2Array),d.vertexTangentArray&&(A.vertexTangentArray=d.vertexTangentArray),d.vertexBinormalArray&&(A.vertexBinormalArray=d.vertexBinormalArray),A.vertexIndexArray=d.vertexIndexArray,i.push(A)}var B=new r.Color;B.setRGB(e[0].gas.fill.color.r,e[0].gas.fill.color.g,e[0].gas.fill.color.b);var M=new r.Color;return M.setRGB(e[0].gas.line.color.r,e[0].gas.line.color.g,e[0].gas.line.color.b),(w=c.getMaterialFromGAS({color:B,opacity:e[0].gas.fill.opacity,solid:e[0].gas.fill.solid,basic:e[0].gas.fill.basic})).line=c.getMaterialFromGAS({color:M,opacity:e[0].gas.line.opacity,lineWidth:e[0].gas.line.lineWidth?e[0].gas.line.lineWidth:e[0].gas.line.linewidth}),i.boundingSphere=v,i.boundingBox=y,(l=new r.Mesh(i,w)).matrixAutoUpdate=!1,l.castShadow=!0,l.receiveShadow=!0,e.length&&(l.sceneGraph=e[0].sceneGraph),new THREEDS.Nodes.Mesh(l)},e.mergeGeometries=function(r,a){if(!a)throw new"no clone link";r.invalidRatio=r.invalidRatio||0;for(var t=0,n=0,o=[],l=0,i=!1,s=!1,u=!1,v=!1,y=!1,c=!1,g=0;g<r.layers.length;g++){(x=r.layers[g].drawableInterval).layerNum<=0&&(l+=x.count)}for(g=0;g<r.geometries.length;g++){t+=(H=r.geometries[g]).vertexIndexArray.length,n+=H.vertexPositionArray.length,o[g]=H.vertexPositionArray.length,i=null!==H.vertexNormalArray,s=null!==H.vertexUvArray,u=null!==H.vertexUv2Array,v=null!==H.vertexColorArray,y=null!==H.vertexTangentArray,c=null!==H.vertexBinormalArray}if(!l&&!r.force)return null;if(!r.force&&l/t<r.invalidRatio)return null;var d=new e.SGPrimitiveHelper,A=[];for(g=0;g<r.layers.length;g++){var x,h=r.layers[g].drawableGroup;if(a.has(h)||a.set(h,new Map),(x=r.layers[g].drawableInterval).layerNum>0)for(var m=x.primitiveStart;m<x.primitiveStart+x.primitiveCount;m++)d.set(h,m),A.push(d.clone())}A.sort(function(e,r){var a=e.getGroup(),t=r.getGroup();return a.glType<t.glType?-1:a.glType>t.glType?1:a._geomType<t._geomType?-1:a._geomType>t._geomType?1:null===a.gas?-1:null===t.gas?1:a.gas.id<t.gas.id?-1:a.gas.id>t.gas.id?1:0});var p=[];for(g=0;g<o.length;g++){p[g]=new Int32Array(o[g]/3);for(m=0;m<p[g].length;m++)p[g][m]=-1}var w=[],f=[],B=[],M=[],S=[],T=[],G=[],b=[],N=[],C=[],U=Math.min(n,196608),z=Math.min(4*n/3,262144);f[0]=new Float32Array(U),B[0]=i?new Float32Array(U):null,M[0]=s?new Float32Array(U):null,S[0]=u?new Float32Array(U):null,T[0]=v?new Float32Array(z):null,G[0]=y?new Float32Array(U):null,b[0]=c?new Float32Array(U):null,N[0]=new Uint16Array(t);var D=(ee=A[0].getGroup()).glType,F=ee._geomType,V=ee.gas,_=[],P=[],R=[],I=0,E=0,j=0,W=0,k=0;for(g=0;g<A.length;g++){var L=A[g],H=(h=L.getGroup()).geometry,q=r.geometries instanceof Array?r.geometries.indexOf(H):0,O=H.vertexPositionArray,J=H.vertexNormalArray,K=H.vertexUvArray,Q=H.vertexUv2Array,X=H.vertexColorArray,Y=H.vertexTangentArray,Z=H.vertexBinormalArray,$=H.vertexIndexArray;if(E+L.getCount()>=65536){var ee=new e.DrawingGroup(V,V,D,j,k-j,void 0,void 0,F);_.push(ee);for(m=0;m<P.length;m++){var re=R[m];d.set(ee,ee._primitives.length),P[m].group=ee,ee._primitives.push(P[m]),a.get(re.container).set(re.index,d.clone())}P=[],R=[],C[I]=_,w[I]={index:k,data:E},D=h.glType,F=h._geomType,V=h.gas,_=[],E=0,j=0,W=0,k=0,U=196608,z=262144,f[++I]=new Float32Array(U),B[I]=i?new Float32Array(U):null,M[I]=s?new Float32Array(U):null,S[I]=u?new Float32Array(U):null,T[I]=v?new Float32Array(z):null,G[I]=y?new Float32Array(U):null,b[I]=c?new Float32Array(U):null,N[I]=new Uint16Array(t);for(var ae=0;ae<o.length;ae++)for(m=0;m<p[ae].length;m++)p[ae][m]=-1}else if(h.glType!==D||h.gas!==V||h._geomType!==F){ee=new e.DrawingGroup(V,V,D,j,k-j,void 0,void 0,F);D=h.glType,F=h._geomType,V=h.gas,_.push(ee),j=k;for(m=0;m<P.length;m++){re=R[m];d.set(ee,ee._primitives.length),P[m].group=ee,ee._primitives.push(P[m]),a.get(re.container).set(re.index,d.clone())}P=[],R=[]}W=k;for(m=0;m<L.getCount();m++){var te=$[L.getStart()+m],ne=p[q][te];if(-1===ne){for(var oe=0;oe<3;oe++)f[I][3*E+oe]=O[3*te+oe],i&&(B[I][3*E+oe]=J[3*te+oe]),s&&(M[I][3*E+oe]=K[3*te+oe]),u&&(S[I][3*E+oe]=Q[3*te+oe]),y&&(G[I][3*E+oe]=Y[3*te+oe]),c&&(b[I][3*E+oe]=Z[3*te+oe]);if(v)for(oe=0;oe<4;oe++)T[I][4*E+oe]=X[4*te+oe];p[q][te]=E,N[I][k++]=E,E++}else N[I][k++]=ne}var le=L._getSGPrimitive();le.start=W,P.push(le),R.push(L)}if(P.length>0){ee=new e.DrawingGroup(V,V,D,j,k-j,void 0,void 0,F);_.push(ee);for(m=0;m<P.length;m++){re=R[m];d.set(ee,ee._primitives.length),P[m].group=ee,ee._primitives.push(P[m]),a.get(re.container).set(re.index,d.clone())}P=[],R=[],C[I]=_,w[I]={index:k,data:E}}var ie=I+1,se=null;for(g=0;g<ie;g++){U=w[g];var ue=N[g],ve=f[g],ye=B[g],ce=(K=M[g],Q=S[g],T[g]),ge=G[g],de=b[g];if(U.index<ue.length){se=new Uint16Array(U.index);for(m=0;m<U.index;m++)se[m]=ue[m];N[g]=se}if(3*U.data<ve.length){var Ae=3*U.data,xe=4*U.data;se=new Float32Array(Ae);for(m=0;m<Ae;m++)se[m]=ve[m];if(f[g]=se,i){se=new Float32Array(Ae);for(m=0;m<Ae;m++)se[m]=ye[m];B[g]=se}if(s){se=new Float32Array(Ae);for(m=0;m<Ae;m++)se[m]=K[m];M[g]=se}if(u){se=new Float32Array(Ae);for(m=0;m<Ae;m++)se[m]=Q[m];S[g]=se}if(v){se=new Float32Array(xe);for(m=0;m<xe;m++)se[m]=ce[m];T[g]=se}if(y){se=new Float32Array(Ae);for(m=0;m<Ae;m++)se[m]=ge[m];G[g]=se}if(c){se=new Float32Array(Ae);for(m=0;m<Ae;m++)se[m]=de[m];b[g]=se}}}var he=[];for(g=0;g<ie;g++){var me=new e.Mesh;me.vertexPositionArray=f[g],me.vertexNormalArray=B[g],me.vertexUvArray=M[g],me.vertexUv2Array=S[g],me.vertexColorArray=T[g],me.vertexTangentArray=G[g],me.vertexBinormalArray=b[g],me.vertexIndexArray=N[g],me.drawingGroups=C[g];var pe=[0,0,0],we=[0,0,0];if(f[g].length>=3){pe=[f[g][0],f[g][1],f[g][2]],we=[f[g][0],f[g][1],f[g][2]];for(var fe=0;fe<f[g].length;fe+=3)f[g][fe]<pe[0]&&(pe[0]=f[g][fe]),f[g][fe+1]<pe[1]&&(pe[1]=f[g][fe+1]),f[g][fe+2]<pe[2]&&(pe[2]=f[g][fe+2]),f[g][fe]>we[0]&&(we[0]=f[g][fe]),f[g][fe+1]>we[1]&&(we[1]=f[g][fe+1]),f[g][fe+2]>we[2]&&(we[2]=f[g][fe+2])}me.AABB={min:pe,max:we},he.push(me)}return e.convertTo3jsGeometry(he,null)},e.createCuboidMesh=function(r,a,t,n,o){var l=e._createCuboidMesh(r.corner,r.firstAxis,r.secondAxis,r.thirdLength,a,null);return e.convertTo3jsMesh([l],t,!1,n,o)},e.createCustomCylinderMesh=function(r,a,t,n,o){var l=new multiTabDecorations,i=e._createCustomCylindricalMesh(r.bottomCenter,r.topCenter,r.bottomRadius,r.topRadius,a,null,r.sag,!1,l);return e.convertTo3jsMesh([i],t,!1,n,o,l.getConcatenatedBlocks())},e.createCustomSphereMesh=function(r,a,t,n,o){var l=new multiTabDecorations,i=e._createCustomSphereMesh(r.parallelStart,r.parallelEnd,r.meridianStart,r.meridianEnd,r.center,r.firstAxis,r.secondAxis,a,null,r.sag,!1,l);return e.convertTo3jsMesh([i],t,!1,n,o,l.getConcatenatedBlocks())},e.createCurvedPipeMesh=function(a,t,n,o,l){for(var i=[],s=[],u=0,v=0;v<a.centers.length/3;v++)s.push(a.radius),i.push(new r.Vector3(a.centers[u++],a.centers[u++],a.centers[u++]));var y=new r.Vector3(a.startN[0],a.startN[1],a.startN[2]),c=new r.Vector3(a.endN[0],a.endN[1],a.endN[2]),g=e._createCurvedPipeMesh(i,s,y,c,!0,t,null,a.sag);return e.convertTo3jsMesh([g],n,!1,o,l)},e.createTorusMesh=function(a,t,n,o,l){var i=new multiTabDecorations,s=new r.Vector3(a.planeNormal[0],a.planeNormal[1],a.planeNormal[2]),u=s.length();s.normalize();var v=new r.Vector3(-a.planeNormal[2],a.planeNormal[0],-a.planeNormal[1]),y=new r.Vector3;y.crossVectors(s,v),y.normalize();var c=new r.Vector3;c.crossVectors(s,y),c.normalize(),y.multiplyScalar(u),c.multiplyScalar(u);for(var g=new r.Vector3(a.center[0],a.center[1],a.center[2]),d=e._buildCurvedPipeDataFromTorus(g,y,c,2*Math.PI,a.sag),A=[],x=[],h=0,m=0;m<d.centers.length/3;m++)x.push(a.minorRadius),A.push(new r.Vector3(d.centers[h++],d.centers[h++],d.centers[h++]));var p=new r.Vector3(d.startNormal[0],d.startNormal[1],d.startNormal[2]),w=e._createTorusMesh(g,A,x,p,t,null,a.sag,!1,i);return e.convertTo3jsMesh([w],n,!1,o,l,i.getConcatenatedBlocks())},e.createPartialTorusMesh=function(a,t,n,o,l){for(var i=new multiTabDecorations,s=new r.Vector3(a.center[0],a.center[1],a.center[2]),u=e._buildCurvedPipeDataFromTorus(s,new r.Vector3(a.firstAxis[0],a.firstAxis[1],a.firstAxis[2]),new r.Vector3(a.secondAxis[0],a.secondAxis[1],a.secondAxis[2]),a.majorAngle,a.sag),v=[],y=[],c=0,g=0;g<u.centers.length/3;g++)y.push(a.minorRadius),v.push(new r.Vector3(u.centers[c++],u.centers[c++],u.centers[c++]));var d=new r.Vector3(u.startNormal[0],u.startNormal[1],u.startNormal[2]),A=new r.Vector3(u.endNormal[0],u.endNormal[1],u.endNormal[2]),x=e._createCurvedPipeMesh(v,y,d,A,!0,t,null,a.sag,!1,i,a);return e.convertTo3jsMesh([x],n,!1,o,l,i.getConcatenatedBlocks())},e}),define("Mesh/MeshUtils",["DS/Mesh/MeshUtils","DS/DSMigration/DSMigration"],function(e,r){return r.deprecateModule("Mesh/MeshUtils"),e});