define("DS/UrbanFeature/PointOfInterest3D",["DS/XCityModel/Location","DS/XCityModel/Item","DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PointOfInterest3DSet","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityTools/Debug","DS/XCityRendering/RenderingHandlerPOI3D","DS/XCityRendering/RenderingHandlerPOI3DBillboard","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher"],function(e,t,i,n,r,s,o,a,h,d,l){"use strict";var u=e.extend({defaults:{styleClass:"",shapeType:"pyramid",nbVertices:3,shadingMode:"flat",_renderMode:"occluded",renderType:"icon",opacityFactor:.5,altitude:0,height:0,switchDistance:0,samplingFactor:1,renderAnchor:!1,anchorLineWidth:1,scale:1,orientation:0,renderID:"",Rendering:null},metaData:{type:"Location",className:"PointOfInterest3D"},setup:function(){this._parent(),this._poi=void 0,this._scaleZ=!0,this._node=new r,this._node.name="poi3DFeature"},destroy:function(e){e.getNode3D().remove(this._node),this._parent(e)},create:function(e){var t;if(!this._parent(e))return l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;e.getNode3D().add(this._node),this.urban=e._urban,this.renderingProfileManager=this.urban.getRenderingProfileManager(),this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,t="billboard"===this.get("shapeType")?new h(this.urban,this._attributes):new a(this.urban,this._attributes),this._rendering=t;var r={shapeType:this.get("shapeType"),shadingMode:this.get("shadingMode"),renderType:this.get("renderType"),renderMode:this.get("renderMode"),samplingFactor:this.get("samplingFactor"),opacityFactor:this.get("opacityFactor"),switchDistance:this.get("switchDistance"),renderAnchor:this.get("renderAnchor"),anchorLineWidth:this.get("anchorLineWidth"),nbVertices:this.get("nbVertices"),isSingleFeature:!0,rendering:this._rendering};this.renderingProfileManager.initRendering(this);var d=this.get("scale");"number"==typeof d&&(d=new i.Vector3(d,d,d));var u={color:new i.Color,name:this._itemParent.get("name"),strid:this._itemParent.get("id"),styleClass:this.get("styleClass"),altitude:this.get("altitude"),height:this.get("height"),opacity:1,localScale:[d.x,d.y,d.z],orientation:[this.get("orientation")]},c=this.getLocalPosition(),g=function(){this.poiSet=new n(this.urban,r,{posTile:new i.Vector2(0,0),tile:{LOD:0,I:0,J:0}}),this.poiSet.addPointOfInterest(new i.Vector3,u),this._poi=this.poiSet.getMesh();var e=(new i.Matrix4).identity().setPosition(new i.Vector3(c.x,c.y,0));this._node.setMatrix(e),this._node.addChild(this._poi),this._node.userData=this._itemParent,this._poi.children[0].isInstanceNode3D&&(this._node.instanceId=5),this._setVisible(this._itemParent)}.bind(this);if(this._isReady=!1,void 0!==r.shapeType){var f=r.shapeType.toLowerCase();"billboard"===f||"disc"===f||"sphere"===f||"tube"===f||"pyramid"===f?(r.shapeType=f,g(),l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})):this.urban.USR.hwInstancing?(r._posSize={},this.urban.modelLoader.load({url:r.shapeType},function(e,t,i){r._posSize.center=e.bSphere.center.clone(),r._posSize.radius=e.bSphere.radius,r._posSize.altitude=e.bBox.min.z,r._posSize.height=e.bBox.max.z-e.bBox.min.z,r._posSize.width=e.bBox.max.y-e.bBox.min.y,r._posSize.length=e.bBox.max.x-e.bBox.min.x,e.traverse(function(e){e instanceof s&&(r.modelMesh3d=e,g())}.bind(this)),l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})}.bind(this))):(o.warn("Unable to load the model or hw instancing is not activated..."),l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}))}return!0},getRendering:function(){return this._rendering},redraw:function(){var e=this.getRendering();d.is(e)&&(e._needRebuild&&this._node.children.length>0&&(this._node.removeChildren(),this.create(this.getRoot())),e.applyRendering(this._poi))},setItemParent:function(e){this._itemParent&&(this._itemParent.removeEvent("onChange:name",this._updateName),this._itemParent.removeEvent("onChange:selected",this._select),this._itemParent.removeEvent("onChange:visible",this._setVisible)),this._itemParent=e,e&&(this._itemParent.addEvent("onChange:name",this._updateName,this),this._itemParent.addEvent("onChange:selected",this._select,this),this._itemParent.addEvent("onChange:visible",this._setVisible,this))},_updatePosition:function(){this._parent();var e=this.getLocalPosition();if(this._poi){var t=(new i.Matrix4).identity().setPosition(new i.Vector3(e.x,e.y,e.z));this._poi.setMatrix(t)}},_updateName:function(){},_setVisible:function(e){var t=!!e.get("visible");this._poi&&(t?this._node.addChild(this._poi):this._node.removeChild(this._poi))},_select:function(e){var t;if(this._poi)if(e.get("selected")){var r={styleClass:this.get("styleClass"),pClass:"poiText",samplingFactor:this.get("samplingFactor")};(t=n.generateTextNode(this.urban,this._itemParent.get("name"),r))._excludeFromCSO=!0,t._excludeFromHSO=!0,t._excludeFromHL=!0,t._excludeFromPSO=!0,t._excludeFromPreHL=!0;var s=e.getContent().get("position");t.setMatrix((new i.Matrix4).translate(new i.Vector3(s.x,s.y,s.z))),this._node.addChild(t)}else(t=this._node.getChildByName("text"))&&this._node.removeChild(t)},get:function(e){var t,i,n=this.getRendering();return this.renderingProfileManager&&d.is(n)&&n.hasAttribute(e)?(i=this.getMaterial(),d.is(i)&&(t=i[e])):t=this._parent(e),t},set:function(e,t){var i={},n=this.getRendering();this.renderingProfileManager&&d.is(n)&&n.hasAttribute(e)?(i[e]=t,this.setMaterial(i)):this._parent(e,t)},setMaterial:function(e){return this.renderingProfileManager.addRendering(this.parentFeatureID,e),this},getMaterial:function(){var e=this.getRendering();return d.is(e)?e.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},getBoundingSphere:function(){if(this._localPosition&&this._node){var e=this.poiSet.minMaxOrig,t=this._localPosition;t.z=this._node.bSphere.center.z;var n=Math.sqrt(Math.pow(e.maxX-e.minX,2)+Math.pow(e.maxY-e.minY,2)+Math.pow(e.maxZ-e.minZ,2))/2;return new i.Sphere(t,n)}},addUserDataProperty:function(e,t,i){if(d.is(e)){var n=this.get("geojson"),r=n.features[0];if(d.is(i))for(var s=0;s<n.features.length;s++){var o=n.features[s];if(o&&o.properties&&o.properties.STRID===i){r=o;break}}r.properties||(r.properties={}),r.properties[e]=t;var a=this.get("userData");return a||(a={},this.set("userData",a)),a[e]=t,!0}return!1},removeUserDataProperty:function(e,t){if(d.is(e)){var i=this.get("geojson"),n=i.features[0];if(d.is(t))for(var r=0;r<i.features.length;r++){var s=i.features[r];if(s&&s.properties&&s.properties.STRID===t){n=s;break}}d.is(n.properties[e])&&delete n.properties[e];var o=this.get("userData");return d.is(o[e])&&delete o[e],!0}return!1}});return t.ObjectContructor.PointOfInterest3D=u}),define("DS/UrbanFeature/ViewshedCamera",["DS/XCityModel/Item","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i=e.extend({defaults:{near:null,fov:50,far:1e3,aspect:1.5,bias:1e-6},metaData:{type:"ViewshedCamera",className:"ViewshedCamera"},setup:function(){this._parent(),this._vse=null,this._urban=null},create:function(e){if(!this._parent(e))return!1;Utils.is(this.get("near"))||this.set("near",this.getRoot()._urban.getViewpoint().camera.near),this._itemParent.addEvent("onChange:visible",this._visible,this),this.addEvent("onChange:near",this._updateCameraParameters,this),this.addEvent("onChange:far",this._updateCameraParameters,this),this.addEvent("onChange:fov",this._updateCameraParameters,this),this.addEvent("onChange:aspect",this._updateCameraParameters,this),this.addEvent("onChange:bias",this._updateCameraParameters,this),this._itemParent.addEvent("onChange:PointOfView",this._updatePointOfView.bind(this)),this._urban=this.getRoot()._urban,this._usr=this._urban.getView3D(),this._vse=this._usr.getViewshedEffect(),!0===this._itemParent.get("visible")&&this._addViewshedCamera()},_updatePointOfView:function(){this._vse.removeCamera(this.camID),this._addViewshedCamera()},_updateCameraParameters:function(){this._vse.changeNear(this.get("near"),this.camID),this._vse.changeFar(this.get("far"),this.camID),this._vse.changeFov(this.get("fov"),this.camID),this._vse.changeAspect(this.get("aspect"),this.camID),this._vse.changeBias(this.get("bias"),this.camID)},_addViewshedCamera:function(){var e={};e.pov=this._itemParent.get("PointOfView"),e.near=this.get("near"),e.far=this.get("far"),e.fov=this.get("fov"),e.aspect=this.get("aspect"),e.bias=this.get("bias");var i=this._urban,n=this._vse,r=(this._usr,this._usr.viewpoint),s=new t.PerspectiveCamera(e.fov,e.aspect,e.near,e.far),o=e.pov.getLocalPosition(i).clone(),a=e.pov.get("rotation").clone().multiplyScalar(Math.PI/180),h=e.pov.get("length");s.quaternion=function(e,i,n){var r=new t.Vector3(0,0,-1),s=new t.Vector3(1,0,0),o=new t.Vector3(0,-1,0),a=new t.Quaternion,h=new t.Quaternion,d=new t.Quaternion;a.setFromAxisAngle(r,e),h.setFromAxisAngle(s,i),d.setFromAxisAngle(o,n);var l=a.multiply(h);return l=l.multiply(d)}(a.x,a.y,a.z);var d=new t.Vector3(-Math.sin(a.x)*Math.sin(a.y),-Math.cos(a.x)*Math.sin(a.y),Math.cos(a.y)).normalize().multiplyScalar(h).negate();s.fposition=o.clone().sub(d.normalize().multiplyScalar(h)),s.orientation=1,s.useQuaternion=!0,s.up.applyQuaternion(s.quaternion),s.up.normalize();var l=function(){s.position=r._translateToRelativePosition(s.fposition.clone(),!1),s.matrix.compose(s.position,s.quaternion,s.scale),s.updateMatrixWorld(!0),s.matrixWorldInverse.getInverse(s.matrixWorld),s.updateProjectionMatrix()};l(),s.bias=e.bias,this.camID=n.addCamera(s,void 0,e.near,e.far,e.aspect,e.fov,e.bias);var u=this.camID;r.addEvent("onCameraShift",function(){l(),n.updateCamera(u,s)}),this._updateCameraParameters()},_visible:function(e){this._itemParent.get("visible")?this._addViewshedCamera():this._vse.removeCamera(this.camID)},getPointOfView:function(){return this.get("PointOfView")},setPointOfView:function(e){return this.set("PointOfView",e)},destroy:function(e){this._parent(e),this._vse&&this._vse.removeCamera(this.camID)}});return e.ObjectContructor.ViewshedCamera=i}),define("DS/UrbanFeature/DataModelSelection",["UWA/Class","UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Selection/CSOManager","DS/XCityTools/EventDispatcher"],function(e,t,i,n,r,s){"use strict";return e.extend(t,{init:function(e){this.urban=e,this.selection={},this.hoveredFeature=void 0,this._selectBind=this.select.bind(this),this._hoverBind=this.hover.bind(this)},addDataModel:function(e){e.addEvent("onAddTree",this.initSelection,this),e.addEvent("onRemoveTree",this.delistenSelection,this),e.addEvent("onAddTree",this.listenHovering,this),e.addEvent("onRemoveTree",this.delistenHovering,this)},initSelection:function(e){this.listenSelection(e),e.get("selected")&&this.select(e)},listenSelection:function(e){e.addEvent("onChange:selected",this._selectBind),e.addEvent("onDestroy",this.delistenSelection.bind(this))},delistenSelection:function(e){e.removeEvent("onChange:selected",this._selectBind)},listenHovering:function(e){e.get("hoverable")&&e.setPrepicking(),e.addEvent("onChange:hovered",this._hoverBind),e.addEvent("onDestroy",this.delistenHovering.bind(this))},delistenHovering:function(e){e.removeEvent("onChange:hovered",this._hoverBind)},getSelection:function(){for(var e=[],t=Object.keys(this.selection),i=0,n=t.length;i<n;i++)e.push(this.selection[t[i]]);return e},getHovered:function(){return this.hoveredFeature},select:function(e,t,i){return e.get("selected")?void 0===this.selection[e.id]&&(this.selection[e.id]=e,r.add({model:e}),this.dispatchEvent("onSelect",[e,i]),s.publish(s.eventsList.onSelect,e,i),this.dispatchEvent("onChange:selection",e)):void 0!==this.selection[e.id]&&(this.dispatchEvent("onChange:selection",e),this.dispatchEvent("onDeselect",e),s.publish(s.eventsList.onDeselect,e),r.remove({model:e}),delete this.selection[e.id],0===Object.keys(this.selection).length&&this.urban.getView3D().activateHighlightSet(),this.hoveredFeature!==e&&e.temporary&&(e.isIndexablePrimitive()?e.getContent()._layer.getItemParent().removeChild(e):this.urban._dataModelPrivate.removeChild(e)),e._itemParent||e.destroy(this.urban)),this},hover:function(e){return e.get("hovered")?void 0===this.hoveredFeature&&(this.hoveredFeature=e,this.dispatchEvent("onHover",e),this.dispatchEvent("onChange:hovering",e)):this.hoveredFeature===e&&(this.dispatchEvent("onChange:hovering",e),this.dispatchEvent("onDehover",e),void 0===this.selection[e.id]&&this.urban._dataModelPrivate.removeChild(this.hoveredFeature),delete this.hoveredFeature,e._itemParent||e.destroy(this.urban)),this},clear:function(){var e,t=this.getSelection();for(e=0;e<t.length;e++)t[e].set("selected",!1),this.dispatchEvent("onDeselect",t[e]);return this.dispatchEvent("onClear",t),this.selection={},this},clearHover:function(){return void 0!==this.hoveredFeature&&this.hoveredFeature.set("hovered",!1),this.dispatchEvent("onClearHover",this.hoveredFeature),this}})}),define("DS/UrbanFeature/Annotation",["DS/XCityModel/Marker","DS/XCityModel/Item","DS/xCityBasicUtils/Utils"],function(e,t,i){"use strict";var n=e.extend({defaults:{classStyle:"annotation",listenToDateUpdate:!1,upTime:"",downTime:""},metaData:{type:"Marker",className:"Annotation"},create:function(e){this._parent(e),this.geometryMarker._markerContainer.addClassName(this.defaults.classStyle)},_initRenderingProfile:function(){this._parent(),this._rendering.defaultRendering.renderingData.style="annotationIconAdvanced",this._rendering.defaultRendering.renderingData.iconName="text"},addUserDataProperty:function(e,t){if(i.is(e)){var n=this.get("geojson");i.is(n)&&(n.features[0].properties||(n.features[0].properties={}),n.features[0].properties[e]=t);var r=this.get("userData");return r||(r={},this.set("userData",r)),r[e]=t,!0}return!1},removeUserDataProperty:function(e){if(i.is(e)){var t=this.get("geojson");i.is(t)&&i.is(t.features[0].properties[e])&&delete t.features[0].properties[e];var n=this.get("userData");return i.is(n[e])&&delete n[e],!0}return!1}});return t.ObjectContructor.Annotation=n}),define("DS/UrbanFeature/Coordinate",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/XCityModel/Item","DS/XCityModel/Location","DS/XCityTools/Geocoder","DS/xCityBasicUtils/Utils"],function(e,t,i,n,r,s){"use strict";var o=n.extend({defaults:e.merge({rotation:null,initialOffset:null,initialRotation:null,isCreatedShape:!1},n.defaults),metaData:{type:"Location",className:"Coordinate"},loaderJSON:e.merge({rotation:"loadJSONVector3",initialOffset:"loadJSONVector3",initialRotation:"loadJSONVector3"},n.loaderJSON),setup:function(){this._parent()},create:function(e){this._parent(e),this._updateRotation(),this.addEvent("onChange:rotation",this._updateRotation,this)},_updateRotation:function(){if(null!==this.get("rotation")){var e,t,i=this._matrix.decompose();e=i[0],t=i[2];var n=s.quaternionFromEulerAngles(s.toRad(this.get("rotation").x),s.toRad(this.get("rotation").y),s.toRad(this.get("rotation").z));this._matrix.identity(),this._matrix.compose(e,n,t)}this.dispatchEvent("onChange:matrix",this._matrix.clone())},_shouldApplyScale:function(){return!this._attributes||!this._attributes.isCreatedShape},_updatePosition:function(){if(this._created){if(this._oldscale=this._scale,this._scale=1,!this._shouldApplyScale()||"EPSG:3857"!==r.getDefaultProjection()&&"EPSG:900913"!==r.getDefaultProjection()||(this._scale=r.computeMercatorScaleFactor(this.get("position").x,this.get("position").y,this.get("projection"))),this._scale!==this._oldscale){var e=this._scale/this._oldscale;this._matrix.scale({x:e,y:e,z:1})}var t=this.get("position").clone();if(this._localPosition&&this._lastPosition){var i=this._localPosition.z-this._lastPosition.z;t.z+=i}if(this._localPosition=t,this.get("shifted")&&this.getRoot()&&this._localPosition.add(this.getRoot()._urban.shiftedPosition),this.get("projection")||this.getRoot()&&this.getRoot()._urban.getProjectProjection()!==this.getRoot()._urban.getUserDefaultProjection()){var n=r.proj(this.get("position"),this.get("projection"));this._localPosition.set(n.x,n.y,this.get("position").z)}this._matrix.setPosition(this._localPosition),this._lastPosition=this.get("position").clone(),this.dispatchEvent("onChange:matrix",this._matrix.clone())}},setMatrix:function(e){this._parent(e);var t=this._matrix.decompose()[1],i=s.eulerAnglesFromQuaternion(t);i.x=s.toDeg(i.x),i.y=s.toDeg(i.y),i.z=s.toDeg(i.z),this.set("rotation",i)},getMatrix:function(){return this._matrix.clone()},reset:function(){this.setMatrix((new t.Matrix4).identity())},setOffsetToRobotCenter:function(e,t,i,n){this.initialTargetWorldMatrix=e,this.initialMatrix=t,this.target=i,this.fatherWorldMatrix=n},getCentralTranslation:function(){if(s.is(this.initialTargetWorldMatrix)){var e=(new t.Matrix4).copy(this.initialTargetWorldMatrix),i=this.initialMatrix.clone(),n=(new t.Matrix4).getInverse(e).multiply(i),r=(new t.Vector3).getPositionFromMatrix(n),o=new t.Matrix4;o.getInverse(this.fatherWorldMatrix),o.multiply(this.initialMatrix);var a=(new t.Vector3).getPositionFromMatrix(o).clone().sub(r);return a=this.fromAbsoluteToRelativeTranslation(a)}return new t.Vector3},fromAbsoluteToRelativeTranslation:function(e){var t=e.clone();if(!this.get("initialOffset")){var i=e.clone();if(this.get("projection")||this.getRoot()&&this.getRoot()._urban.getProjectProjection()!==this.getRoot()._urban.getUserDefaultProjection()){var n=r.proj(e.clone(),"",this.get("projection"));i.x=n.x,i.y=n.y}this.set("initialOffset",i.clone())}var s,o=this.get("initialOffset");if(this.get("projection")||this.getRoot()&&this.getRoot()._urban.getProjectProjection()!==this.getRoot()._urban.getUserDefaultProjection()){n=r.proj(o.clone(),this.get("projection"));(s=this.get("initialOffset").clone()).x=n.x,s.y=n.y}else s=this.get("initialOffset").clone();return t.sub(s),t},setCentralTranslation:function(e){if(s.is(this.initialTargetWorldMatrix)){var t=this.getCentralTranslation(),i=e.clone().sub(t),n=this.get("position").clone();n.add(i),this.set("position",n)}},getCentralRotation:function(){var e=this.get("rotation");if(e){this.get("initialRotation")||this.set("initialRotation",e.clone());var t=this.get("initialRotation");return e=e.z-t.z}return 0},setCentralRotation:function(e){var i=0,n=this.get("rotation");if(s.is(n)&&(i=n.z),n=this.get("initialRotation"),s.is(n)&&(i-=n.z),!(Math.abs(i-e)<.001)&&this.initialTargetWorldMatrix){var r=(new t.Matrix4).copy(this.initialTargetWorldMatrix),o=new t.Vector3(0,0,1),a=(new t.Matrix4).makeRotationAxis(o,s.toRad(e-i)),h=(new t.Matrix4).setPosition((new t.Vector3).getPositionFromMatrix(this.initialMatrix)),d=(new t.Matrix4).getInverse(h).multiply(r),l=(new t.Matrix4).copy(a).multiply(d),u=(new t.Matrix4).copy(h).multiply(l),c=new t.Matrix4;c.getInverse(this.fatherWorldMatrix);var g=c.multiply(u);this.setMatrix(g)}}});return i.ObjectContructor.Coordinate=o}),define("DS/UrbanFeature/Bookmark",["DS/XCityModel/Item"],function(e){"use strict";var t=e.extend({defaults:{renderProfile:"",perfProfile:"",thumbnail:"",visibility:[]},metaData:{type:"Bookmark",className:"Bookmark"},setup:function(){this._parent()},_visible:function(e){var t=this.getRoot();if(void 0!==t&&this._itemParent.get("visible")){null!==this._itemParent.get("PointOfView")&&t._urban.getView3D().getControl().moveToFeature(this._itemParent);for(var i=this.get("visibility"),n=0;n<i.length;n++){var r=t.findChildById(i[n].id,!0);void 0!==r&&r.set("visible",i[n].visible)}}},getPointOfView:function(){return this.get("PointOfView")},setPointOfView:function(e){return this.set("PointOfView",e)},setItemParent:function(e){this._itemParent&&this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._parent(e),this._itemParent&&this._itemParent.addEvent("onChange:visible",this._visible,this)}});return e.ObjectContructor.Bookmark=t}),define("DS/UrbanFeature/ObjectSelection",["UWA/Class","UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Selection/CSOManager","DS/XCityTools/EventDispatcher"],function(e,t,i,n,r,s){"use strict";return e.extend(t,{init:function(e){this.urban=e,this.selected=[],this.hovered=[],this.hso=WUX.Selection.HSOManager,this.pso=WUX.Selection.PSOManager},select:function(e,t){this.selected.push(e),e.XSOnode={pathElement:e.path},this.hso.isIn(e.XSOnode)&&this.hso.remove(e.XSOnode),this.dispatchEvent("onObjectSelect",[e,t])},hover:function(e){},clear:function(e){for(var t=0,i=this.selected.length;t<i;t++){var n=this.selected.pop();this.hso.isIn(n.XSOnode)&&this.hso.remove(n.XSOnode),this.dispatchEvent("onObjectDeselect",n)}this.selected=[],this.dispatchEvent("onClearSelection",e)},clearHovered:function(){},emptySelect:function(e){this.dispatchEvent("onEmptySelect",e)}})}),define("DS/UrbanFeature/R2VFeatureState",["DS/XCityModel/Item","DS/WAFData/WAFData","DS/3DXMTiles/OOCTileSetHandler","DS/3DXMTiles/OOCManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/WebappsUtils/WebappsUtils"],function(e,t,i,n,r,s,o){"use strict";var a=e.extend({defaults:{config:null,Coordinate:null,loadInfo:{loaded:1,total:1}},metaData:{type:"Geometry",className:"R2VFeatureState"},loaderJSON:{config:"loadJSONObject"},setup:function(){this._parent(),this._tileSetRootId=null,this._node=new s,this._node.name="TileSetFeature"},setPointOfView:function(e){return this.set("PointOfView",e)},getPointOfView:function(){return this.get("PointOfView")},create:function(e){var t=this;if(!this._parent(e))return!1;var s=e._urban;if(this._urban=s,this.getItemParent().get("visible")){var a=this.get("config"),h=a.objectId,d=a.displayName,l=a.urlR2VSurvey;if(!0===window.URBANODT&&(l=o.getWebappsBaseUrl()+"Web3DXCityVisuTests/assets/data/dataserver/"),null===this._urban.oocManager){var u=this._urban.USR.webGLV6Viewer;this._urban.oocTileSetHandler=new i({sortingMetric:"pixelError",triggerMetric:"pixelError"}),this._urban.oocManager=new n(u,{getServiceUrlCB:function(e){return l}})}var c=this;this.oocManager=this._urban.oocManager,this.oocTileSetHandler=this._urban.oocTileSetHandler,this.oocManager.setOnStartLoadingCB(function(e){if(!0===e.isLoading){let e=c.get("loadInfo"),t={loaded:e.loaded,total:e.total+1};c.set("loadInfo",t)}}),this.oocManager.setOnEndLoadingCB(function(e,t,i,n){if(console.log("End loading status :"+e),!1===e.isLoading){let e=c.get("loadInfo"),t={loaded:e.total,total:e.total};c.set("loadInfo",t)}}),this._root=e,e.getNode3D().add(this._node),this.oocManager.setTargetNode(this._node);var g={handler:t.oocTileSetHandler,tileSet:{sourceId:"r2vsurvey",resourceId:h}};if(window.URBANODT){let e=0,t={rootId:"/9298F6E6CB2D00006243FC06000A51CA/9298F6E6CB2D00006243FC5C0016D3B8",matrix:[e,e,e],boundingBox:[-150.734,-174.25,-27.84,150.734,174.25,27.84],viewpoint:{target:{x:e+31.716767607812685,y:e-26.720141993690476,z:e-32.41799467378662},orientation:{x:.28749440096583273,y:.1570952102050275,z:.4530472117035139,w:.8291057160046641},distanceToTarget:616.3068240696448},baseTileURL:"/debug_visu/assets/ooc/r2v/stadium/tile",baseContentURL:"/debug_visu/assets/ooc/r2v/stadium/tileContent/",tilesExtension:".json"};g.tileSet={rootURI:t.rootId,baseTileURL:t.baseTileURL,baseContentURL:t.baseContentURL,tilesExtension:t.tilesExtension}}this.oocManager.registerReference(d,g),this._tileSetRootId=this.oocManager.addRoot(d,{onLoadedCB:function(e){console.log("oocManager onLoadedCB, bbox : ");var i=t.oocManager.getReferenceBoundingBox(e);if(console.log(i),t._itemParent&&null!==t._itemParent.get("PointOfView")){console.log("updating featurestate POV...");var n=t._itemParent.get("PointOfView");n.toJSON();n.set("position",new r.Vector3(.5*(i.min.x+i.max.x),.5*(i.min.y+i.max.y),i.max.z));let e=i.max.x-i.min.x,s=i.max.y-i.min.y,o=i.max.z-i.min.z,a=Math.max(e,s,o);n.set("length",1.5*a)}}});this._urban.USR.viewpoint.addEvent("onCameraShift",function(){var e=t.oocManager.getTileSet(d);null!==e&&e.refreshWorldMatrix()})}this._node.userData=this._itemParent},destroy:function(){console.log("destroy");this.get("config").displayName;null!==this._tileSetRootId&&this.oocManager.removeRoot(this._tileSetRootId),this._root.getNode3D().remove(this._node),this._node=new s,this._node.name="TileSetFeature"},_itemParentVisible:function(e){this._created&&this._node.setVisibility(e.get("visible"))},setItemParent:function(e){this._itemParent&&this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._itemParent=e,this._itemParent&&this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this)}});return e.ObjectContructor.R2VFeatureState=a}),define("DS/UrbanFeature/View3DHighlighter",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/XCityTools/EventDispatcher","DS/XCityModel/GeometrySet","DS/xCityBasicUtils/Utils"],function(e,t,i,n,r,s,o){"use strict";return e.extend({init:function(e,t){this._renderer=e,this.hso=WUX.Selection.HSOManager,this.pso=WUX.Selection.PSOManager,this._dataModelSelection=t,t.addEvent("onSelect",this.highlight,this),t.addEvent("onDeselect",this.unhighlight,this),t.addEvent("onHover",this.highlight,this),t.addEvent("onDehover",this.unhighlight,this)},_highlightElement:function(e,t,i,s){if(!(s&&s.fromNode&&t&&t.id!==s.fromNode.id)||o.isParent(s.fromNode,t)){var a=new n,h=t;if(o.is(s)&&o.is(s.toNode)){if(!o.is(s.eventType)||"ADD"!==s.eventType)return;if(o.isParent(t,s.toNode))h=s.toNode;else{if(t.hlStoreKey!==s.toNode.storeKey||t.hlIdDataSource!==s.toNode.parents[0].idDataSource)return;h=t}}if(void 0!==t.instanceId&&""!==t.instanceId?(a.setFromArray([h]),a.instanceId=t.instanceId):i?a.setFromArray([h],[i]):(t.hwInstancing&&t.traverse(function(e){if(void 0!==e.mesh3js&&"instance"===e.mesh3js.instancingSelectionMode){e.mesh3js.instancingSelectionMode="mesh";for(var t=0;t<e._occurrences.length;++t)e._occurrences[t].renderable.instancingSelectionMode="mesh"}}),a.setFromArray([h])),e&&void 0===t.hl){t.hl=r.subscribeTo("/VISU/onSceneGraphUpdate",this._highlightElement.bind(this,e,t,i));for(var d=!1,l=t;!d&&l;)void 0!==l.storeKey&&void 0!==l.idDataSource&&(d=!0,t.hlStoreKey=l.storeKey,t.hlIdDataSource=l.idDataSource),l=l.parents?l.parents[0]:void 0;if(t.clusterInfo&&(t.clusterInfo.isLeaf||void 0!==t.clusterInfo.rtree)&&(t.hlCluster=r.subscribeTo("/3DEXPERIENCity/onClusterUpdate",this._highlightElement.bind(this,e,t,i)),t.leafStrid=t._occurrences[0].renderable.userData.cgmIds[(t.instanceId-5)/5],!t.clusterInfo.isLeaf)){l=t.clusterInfo.rtree.getNodeByInstanceId((t.instanceId-5)/5);t.leafNbInstances=l.nHits}}var u={pathElement:a},c=this._renderer.getCurrentHighlightColor();if(o.is(c)&&(u.parameters=c),e){if(this.hso.isIn(u)&&this.hso.remove(u),this.hso.add(u),t.clusterInfo&&(t.clusterInfo.isLeaf||void 0!==t.clusterInfo.rtree))if(0===t.nbInstances)this.hso.remove(u);else{t.instanceId;for(var g=-1,f=0;f<t.nbInstances;++f)if(t.leafStrid===t._occurrences[0].renderable.userData.cgmIds[f]){g=5*f+5;break}g!==t.instanceId&&this.hso.remove(u),g>-1&&g!==t.instanceId&&(t.instanceId=g,a.instanceId=t.instanceId,u={pathElement:a},this.hso.add(u))}}else if(this.pso.add(u),this.hso.remove(u),t.clusterInfo&&(t.clusterInfo.isLeaf||void 0!==t.clusterInfo.rtree))if(0===t.nbInstances)this.pso.remove(u);else{for(t.instanceId,g=-1,f=0;f<t.nbInstances;++f)if(t.leafStrid===t._occurrences[0].renderable.userData.cgmIds[f]){g=5*f+5;break}g!==t.instanceId&&this.pso.remove(u),g>-1&&g!==t.instanceId&&(t.instanceId=g,a.instanceId=t.instanceId,u={pathElement:a},this.pso.add(u))}}},highlightPrimitive:function(e){var t=e.get("Content");if(t&&t._subMeshes){if(""!==t.get("instanceId")){var i=0;for(i=0;i<t._subMeshes.length;i++)t._subMeshes[i].mesh.instanceId=t.get("instanceId")}t.traverse(this._highlightElement.bind(this,e.get("selected"))),o.getComposedProperty(this,"_renderer.urban.showPrimBbox")&&t.drawDebugBbox()}},highlightGeometry:function(e){let t=e.getContent()._layer.createPrimitive(e.getContent()._getStrid());e.set("Content",t),this.highlightPrimitive(e),o.is(this.highlightGeometryOnLoadedTokken)&&r.unsubscribe(this.highlightGeometryOnLoadedTokken)},highlight:function(e){var t=e.get("Content");if(t){if(t.highlight&&t.highlight(),t._node)this._highlightElement(e.get("selected"),t._node);else if(t._subMeshes)if(!t._layer._patch&&t._layer instanceof s){let i=e.getContent()._layer.get("loadInfo");i&&3===i.total&&i.total===i.loaded?this.highlightGeometry(e):this.highlightGeometryOnLoadedTokken=r.subscribeTo(r.eventsList.onLoaded+":"+t._layer.get("id"),this.highlightGeometry.bind(this,e))}else t._layer._patch.register(t.get("strid"),this.highlightPrimitive.bind(this,e));e.addEvent("onDestroy",this.unhighlight,this)}},_unhighlightElement:function(e,t,i){var s=new n;void 0!==t.instanceId&&""!==t.instanceId?(s.setFromArray([t]),s.instanceId=t.instanceId):i?s.setFromArray([t],[i]):(t.hwInstancing&&t.traverse(function(e){if(void 0!==e.mesh3js&&"mesh"===e.mesh3js.instancingSelectionMode){e.mesh3js.instancingSelectionMode="instance";for(var t=0;t<e._occurrences.length;++t)e._occurrences[t].renderable.instancingSelectionMode="instance"}}),s.setFromArray([t])),e&&void 0!==t.hl&&(r.unsubscribe(t.hl),t.hl=void 0,t.clusterInfo&&(t.clusterInfo.isLeaf||void 0!==t.clusterInfo.rtree)&&(r.unsubscribe(t.hlCluster),t.hlCluster=void 0,t.leafStrid=void 0));var a,h,d={pathElement:s},l=this._renderer.getCurrentHighlightColor();if(o.is(l)&&(d.parameters=l),e?this.hso.remove(d):this.pso.remove(d),void 0!==t.instanceId&&""!==t.instanceId&&o.is(t.parents)&&t.parents.length>0&&o.is(t.parents[0].parents)){var u=this.getFactoryNode(t);if(u){var c=u.id;if(c)for(a=0;a<this.hso._items.length;++a)this.hso._items[a].pathElement.externalPath[0].id===c&&this._highlightElement(!0,u)}}var g=[];for(a=0;a<this.hso._items.length;++a){var f=this.hso._items[a].pathElement;o.is(f)&&o.is(f.externalPath)&&f.externalPath[0]&&(h=f.externalPath[0],o.isParent(t,h)&&g.push(f))}for(a=0;a<g.length;++a)d={pathElement:h=g[a]},o.is(l)&&(d.parameters=l),this.hso.remove(d)},unhighlight:function(e){var t=e.get("Content");t&&(void 0!==t.unhighlight&&t.unhighlight(),t._node?this._unhighlightElement(void 0!==e._changed.selected,t._node):t._subMeshes&&(t.traverse(this._unhighlightElement.bind(this,void 0!==e._changed.selected)),t._layer._patch?t._layer._patch.unregister(t.get("strid"),this.highlightPrimitive.bind(this,e)):this.highlightGeometryOnLoadedTokken&&r.unsubscribe(this.highlightGeometryOnLoadedTokken),o.getComposedProperty(this,"_renderer.urban.showPrimBbox")&&t.eraseDebugBbox&&t.eraseDebugBbox()),e.removeEvent("onDestroy",this.unhighlight,this))},rehighlight:function(){var e=this.hso.get();this.addToHSO(e)},emptyHSO:function(){for(var e=this.hso.get(),t=[],i=0;i<e.length;i++)t.push(e[i]);return this.hso.empty(),t},addToHSO:function(e){for(var t=this._renderer.getCurrentHighlightColor(),i=0;i<e.length;i++){o.is(t)&&(e[i].parameters=t);var n=e[i];this.hso.remove(n),this.hso.add(n)}},clear:function(e){if(e){for(var t=0;t<e.length;t++)this.unhighlight(e[t]);this.hso.empty()}},getFactoryNode:function(e){for(var t=e,i=t.parents[0];"VisuQuadTreeSirocco_PointObjects"!=i.name;){if(!(t=i).parents||!t.parents[0]){t=null;break}i=t.parents[0]}return t}})}),define("DS/UrbanFeature/View3DPicker",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/XCityModel/Feature","DS/XCityModel/Item","DS/Visualization/PathElement","DS/XCityTools/EventDispatcher","DS/XCityTools/Debug","DS/UrbanFeature/ObjectSelection","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/xCityBasicUtils/Utils","DS/XCityModel/GeometrySet","DS/XCityTools/Geocoder"],function(e,t,i,n,r,s,o,a,h,d,l,u,c,g,f){"use strict";return UWA.Class.extend({init:function(e,t){this._urban=e,this._renderer=this._urban.getView3D(),this._eventsListeners={},this._dataModelSelection=t,this._objectSelection=new h(e),this.addEventListener("onLeftDoubleClick",this.selectAndMoveTo.bind(this)),this.addEventListener("onLeftClick",this.select.bind(this)),this.addEventListener("onTap",this.select.bind(this)),this.addEventListener("onDoubleTap",this.selectAndMoveTo.bind(this)),this._urban.poiManager.addEvent("onMouseDown",this._mouseDownPoi.bind(this)),this._urban.poiManager.addEvent("onMouseDblClick",this._mouseDblClickPoi.bind(this)),this.disabled=!1,this.leftClickDone=!1,this.nbFeatureHoverable=0,this.hoverFnBind=this.hover.bind(this)},disable:function(){this.disabled=!0},enable:function(){this.disabled=!1},getObjectSelection:function(){return this._objectSelection},setPrepicking:function(e){e?this.nbFeatureHoverable++:this.nbFeatureHoverable--,1===this.nbFeatureHoverable&&e?this.addEventListener("onMouseMove",this.hoverFnBind):0===this.nbFeatureHoverable&&this.removeEventListener("onMouseMove",this.hoverFnBind)},addEventListener:function(e,t){if(e){var i=this._eventsListeners[e];if(i)i.callbacks.push(t);else{var n=[];n.push(t),this._eventsListeners[e]={token:o.subscribeTo("/VISU/"+e,this._picking.bind(this,n)),callbacks:n}}}return this},removeEventListener:function(e,t){var i=this._eventsListeners[e];if(i)for(var n=0;n<i.callbacks.length;n++)if(i.callbacks[n]===t)return i.callbacks.splice(n,1),0===i.callbacks.length&&(o.unsubscribe(i.token),delete this._eventsListeners[e]),!0;return!1},clearEventListener:function(){return this._eventsListeners={},this},selectAndMoveTo:function(e,t,i){return this.select(e,t,i),t._movetoFeatureLaunched=!0,e instanceof r&&this._urban.getView3D().getControl().moveToFeature(e),!0},select:function(e,t,i){if(!e)return!1;if(e instanceof r){var n=e.get("selected"),s=this._renderer.webGLV6Viewer.forceMultiSel;if(t&&t.event?s=s||t.event.ctrlKey:t&&(s=t.ctrlKey),s||this._dataModelSelection.clear(),e.get("selectable"))return e._folderParent||(this._dataModelSelection.getSelection().forEach(function(t){t.id===e.id&&(e=t,n=!0)}),n||(this._dataModelSelection.listenSelection(e),e.get("hovered")&&e.set("hovered",!1))),n?a.log("Deselect",e.id):a.log("Select",e.id),e.getContent()._layer&&e.getContent()._layer.isLayer&&e.getContent()._layer.isWFS&&(e.userData={fromWFS:!0,type:e.getContent()._subMeshes[0].mesh.parents[0].indexMesh||e.getContent()._subMeshes[0].mesh.parents[0].parents[0].indexMesh}),e.set("selected",!s||!n,t),!0}else this._objectSelection.select(e,i);return!1},hover:function(e,t){if(!e)return!1;if(e instanceof r){var i=e.get("hovered"),n=e.get("selected");if(!i&&!n)return this._dataModelSelection.clearHover(),e._folderParent||i||this._dataModelSelection.listenHovering(e),i?a.log("Dehover",e.id):a.log("Hover",e.id),e.set("hovered",!0),!0}return!1},_emptyPick:function(e){this._objectSelection.emptySelect(e)},_emptyHover:function(e){},_launch:function(e,t,i,n){for(var r=0;r<e.length;r++)e[r](t,i,n)},_mouseDownPoi:function(e,t){if(e.userData instanceof n){var i="";if(1===t.which?i="onLeftClick":2===t.which?i="onMiddleClick":3===t.which&&(i="onRightClick"),i.length>0){var r=this._eventsListeners[i];r&&this._launch(r.callbacks,e.userData,t)}}a.log("_pickPOI")},_mouseDblClickPoi:function(e,t){if(e.userData instanceof n&&1===t.which){var i=this._eventsListeners.onLeftDoubleClick;i&&this._launch(i.callbacks,e.userData,t)}a.log("_mouseDblClickPoi")},getClosestObject:function(e){if(!e)return 0;if(!Array.isArray(e))return 0;var t,i,n=0,r=e[0];if(void 0===r.distance)return 0;if(e.length>1)for(t=1;t<e.length;t++)if(i=e[t]){if(i.distance>r.distance)break;n++}return n},_isNotFromCityViewer:function(e){var t=!0;if(e.event.path)"xCityViewer"===e.event.path[1].id?t=!1:"xCityViewer"===e.event.path[0].id&&(t=!1);else if(e.event.target)if("xCityViewer"===e.event.target.id)t=!1;else{var i=e.event.target.parentElement;i&&("xCityViewer"===i.id?t=!1:i.parentElement&&"xCityViewer"===i.parentElement.id&&(t=!1))}return t},_manualPrimPicking:function(e,t,i,n,o){let a=this,h=function(){d&&d[0]&&d[0].path&&(d[0].path=null),a._emptyPick(e)},d=i.computeIntersection(n,i.picking.gpu,!1,!1,o),l=!1;for(let e=0;e<d[0].object.geometry[0].drawingGroups[0].primitives.length&&!l;e++){let i;d[0].primitive=d[0].object.geometry[0].drawingGroups[0].primitives[e],d[0].path=new s,d[0].path.setFromOccurrence(d[0].object._occurrence,THREEDS.SubElement.getFromSGNode(d[0].primitive)),void 0!==d[0].instanceId&&(d[0].path.instanceId=d[0].instanceId);for(let e=0;e<d[0].path.externalPath.length&&!i;++e)d[0].path.externalPath[e].userData instanceof r&&(i=d[0].path.externalPath[e].userData);if(!i.get("Content").getRendering().getRenderingValues().polyExtruOptim)return h();let n=this._urban.baseProjection,o=function(e,t){if("WGS84"!==n){let i=f.proj(e,t,"WGS84");e[0]=i.x,e[1]=i.y}},a=this._urban.USR.getViewpoint().exactPick(t.currentPosition);o(a,n);let u=[a[0],a[1]],g=i._attributes.Content._factory.geoJSON[d[0].primitive.cgmId],p=c.structuredClone(g.features[0].geometry),m=p.coordinates,v=[];if(p.type&&"Polygon"===p.type){let e=p.coordinates;for(let t=0;t<e.length;++t){let i=e[t];for(let e=0;e<i.length;++e)o(i[e],n)}v.push(c.coordinatesToTurfPolygon(m))}else{if(!p.type||"MultiPolygon"!==p.type)return h();{let e=p.coordinates;for(let t=0;t<e.length;++t){let i=e[t][0];for(let e=0;e<i.length;++e){o(i[e],n)}v.push(c.coordinatesToTurfPolygon(e[t]))}}}let _=c.coordinatesToTurfPoint(u);l=!1;for(let e=0;e<v.length&&!l;e++){l=c.turfBooleanContains(v[e],_);const t=Math.max(.1,xCity._urbanImpl.USR.viewpoint.getTargetDistance()/1e3),i={units:"meters",method:"planar"};let n=!1;for(let r=0;r<v[e].geometry.coordinates.length&&!l;r++){let s=c.coordinatesToTurfLineString(v[e].geometry.coordinates[r]);(n=c.turfPointToLineDistance(_,s,i)<t)&&(l=!0)}}}return l?d:(d=[],h())},_picking:function(e,t){if(!this.disabled){var o=function(e){return e.ctrlKey},a=this._renderer.webGLV6Viewer,h=t.from&&t.from.length?t.from[0]:null;if(!this._isNotFromCityViewer(h)){var d=!1;if("@onMouseMoveEvent"===t.eventType){if(this.leftClickDone)return void(this.leftClickDone=!1);d=!0}if(this.leftClickDone=!0,a.picking.activated&&null!=h){var l=a.getMousePosition(h.currentPosition),u={ray:null};a.forceMultiSel||void 0!==o&&o(h.event)||d||(this._dataModelSelection.clear(),this._objectSelection.clear(t));var f,p,m,v=a.computeIntersection(l,a.picking.gpu,a.picking.primitive,!1,u),_=v[0].object;if(_&&_.geometry.length>0){var b=_.geometry[0];if(b.drawingGroups.length>1)a.picking.primitive=!0,v=a.computeIntersection(l,a.picking.gpu,a.picking.primitive,!1,u),a.picking.primitive=!1;else if(1===b.drawingGroups.length){var y=b.drawingGroups[0].getPrimitivesCount();if(y>1){a.picking.primitive=!0,v=a.computeIntersection(l,a.picking.gpu,a.picking.primitive,!1,u),a.picking.primitive=!1;const e=!0;if(0===Object.keys(v[0]).length&&e&&!(v=this._manualPrimPicking(t,h,a,l,u)))return}else 1===y&&(v[0].primitive=v[0].object.geometry[0].drawingGroups[0].primitives[0])}let e=_.geometry[0].meshList[0].getNode();if(e.name.startsWith("textNode_")){let t=e.name.split("textNode_")[1],i=e.parents[0].parents[0].children[0];if(i.mesh3js)_=i.mesh3js,v[0].primitive=i.mesh3js.geometry[0].drawingGroups[0].primitives.find(e=>e.cgmId.toString()===t).internalNode.sgNode;else{_=i.children[0].mesh3js,v[0].primitive=_.geometry[0].drawingGroups[0].primitives[0].internalNode.sgNode;let e=_.userData.instanceIds.findIndex(e=>e.toString()===t);v[0].instanceId=_.instanceAttribArrays.instanceId.array[e]}v[0].object=_}}if(v.length){if(f=0,v.length>1&&(f=this.getClosestObject(v)),void 0===v[f].object||null===v[f].object||"XCitySlabCube"===v[f].object.name||"XCityInfinitePlane"===v[f].object.name)return v[f].path=null,void this._emptyPick(t);if(v[f].primitive&&v[f].object._occurrence){if(v[f].primitive.userData)return m=v[f].primitive.userData,this._launch(e,m,t.from[0],t),m;var S;for(v[f].path=new s,v[f].path.setFromOccurrence(v[f].object._occurrence,THREEDS.SubElement.getFromSGNode(v[f].primitive)),void 0!==v[f].instanceId&&(v[f].path.instanceId=v[f].instanceId),p=0;p<v[f].path.externalPath.length&&!S;++p)v[f].path.externalPath[p].userData instanceof r&&(S=v[f].path.externalPath[p].userData);if(S){if(!S.get("selectable"))return v[f].path=null,void this._emptyPick(t);if(d&&!S.get("hoverable"))return v[f].path=null,void this._emptyPick(t);var D;if(!S.get("Content").isLayer&&!S.get("Content")._factory)return v[f].instanceId&&(S.get("Content")._node.instanceId=v[f].instanceId),this._launch(e,S,t.from[0],t),S;if("BuildingSet"===(D=S.get("Content")).metaData.className&&(m=S),D){var C=D.id,P=v[f].path.getLastElement(!0);if(P instanceof i){P.show();var M=v[f].primitive.getCgmId();if(void 0!==v[f].instanceId&&(M=v[f].object.userData.cgmIds[(v[f].instanceId-5)/5]),S.findChildrenByName&&(m=S.findChildrenByName(M,!0)[0]),void 0===m&&(void 0===(m=this._urban._dataModelPrivate.findChildrenByName(M,!0)[0])||m.getContent().get("dataSourceId")!==C)){var x;if(m=new n({name:M}),void 0!==P.clusterInfo)if(P.clusterInfo.isLeaf){x=D.createPrimitive(M,v[f].instanceId);for(var I=[],w=0;w<x._subMeshes.length;++w)x._subMeshes[w].mesh.clusterInfo&&x._subMeshes[w].mesh.clusterInfo.isLeaf&&I.push(x._subMeshes[w]);x._subMeshes=I}else x=D.createCluster(M,v[f].instanceId,P.clusterInfo);else x=D.createPrimitive(M,v[f].instanceId);m.set("Content",x),m.create(D.getRoot()),m.temporary=!0,m.isIndexablePrimitive()?m.getContent()._layer.getItemParent().addChild(m):this._urban._dataModelPrivate.addChild(m)}if(m&&m.getContent()._layer instanceof g&&D.createPrimitive(M,v[f].instanceId),void 0!==v[f].instanceId){m.get("Content")._attributes.instanceId=v[f].instanceId;var O=m.get("Content")._subMeshes;for(p=O.length-1;p>=0;--p)O[p].mesh.instanceId=v[f].instanceId}return this._launch(e,m,t.from[0],t),m}}}else if("terrainGenericMesh"===v[f].primitive.cgmId)return v[f].path=null,void this._emptyPick(t)}else if(v[f].object&&v[f].object.pickable)for(v[f].path=new s,v[f].path.setFromOccurrence(v[f].object._occurrence),p=0;p<v[f].path.externalPath.length;++p)if(v[f].path.externalPath[p].userData instanceof r)return m=v[f].path.externalPath[p].userData,this._launch(e,m,t.from[0],t),m}return this._dataModelSelection.clearHover(),c.is(v[f])&&c.is(v[f].object)?this._launch(e,v[f],t.from[0],t):this._emptyPick(t),v[f]}}}},_hovering:function(e,t){var o=this._renderer.webGLV6Viewer,a=t.from&&t.from.length?t.from[0]:null;if(!this._isNotFromCityViewer(a)){var h,d,l,u=o.getMousePosition(a.currentPosition),c={ray:null},g=o.computeIntersection(u,o.pPicking.gpu,o.pPicking.primitive,!1,c),f=g[0].object;if(f&&f.geometry.length>0){var p=f.geometry[0];if(p.drawingGroups.length>1)o.picking.primitive=!0,g=o.computeIntersection(u,o.picking.gpu,o.picking.primitive,!1,c),o.picking.primitive=!1;else if(1===p.drawingGroups.length){var m=p.drawingGroups[0].primitives;m.length>1?(o.picking.primitive=!0,g=o.computeIntersection(u,o.picking.gpu,o.picking.primitive,!1,c),o.picking.primitive=!1):1===m.length&&(g[0].primitive=g[0].object.geometry[0].drawingGroups[0].primitives[0])}}if(g.length)if(g[h=0].primitive&&g[h].object._occurrence){if(g[h].primitive.userData)return l=g[h].primitive.userData,this._launch(e,l,t.from[0],t),l;var v;for(g[h].path=new s,g[h].path.setFromOccurrence(g[h].object._occurrence,THREEDS.SubElement.getFromSGNode(g[h].primitive)),void 0!==g[h].instanceId&&(g[h].path.instanceId=g[h].instanceId),d=0;d<g[h].path.externalPath.length&&!v;++d)g[h].path.externalPath[d].userData instanceof r&&(v=g[h].path.externalPath[d].userData);if(v){if(!v.get("hoverable"))return this._dataModelSelection.clearHover(),g[h].path=null,void this._emptyHover(t);var _;if(!v.get("Content").isLayer)return this._launch(e,v,t.from[0],t),v;if(_=v.get("Content")){var b=_.id,y=g[h].path.getLastElement(!0);if(y instanceof i){y.show();var S=g[h].primitive.cgmId;if(void 0!==g[h].instanceId&&(S=g[h].object.userData.cgmIds[(g[h].instanceId-5)/5]),void 0===(l=this._urban.getLayerRoot().findChildById(S,!0))&&(void 0===(l=this._urban._dataModelPrivate.findChildById(S,!0))||l.getContent().get("dataSourceId")!==b)){l=new n({name:v.get("name")+"_"+S,id:S,hoverable:!0});var D=_.createPrimitive(S);if(l.set("Content",D),l.create(_.getRoot()),void 0!==g[h].instanceId){var C=l.get("Content")._subMeshes;for(d=C.length-1;d>=0;--d)C[d].mesh.instanceId=g[h].instanceId}this._urban._dataModelPrivate.addChild(l)}return this._launch(e,l,t.from[0],t),l}}}}else if(g[h].object&&g[h].object.pickable)for(g[h].path=new s,g[h].path.setFromOccurrence(g[h].object._occurrence),d=0;d<g[h].path.externalPath.length;++d)if(g[h].path.externalPath[d].userData instanceof r)return l=g[h].path.externalPath[d].userData,this._launch(e,l,t.from[0],t),l;this._dataModelSelection.clearHover(),g[h].path=null,this._emptyHover(t)}},clearAllSelection:function(e){this._dataModelSelection.clear(),this._objectSelection.clear(e)}})}),define("DS/UrbanFeature/Geometry",["DS/XCityModel/Item","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityTools/ShaderTools","DS/XCityRendering/RenderingHandlerGeometry","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/xCityPlatformUtils/xCityDocumentManagement","DS/xCityPlatformUtils/xCityPlatformIntegration","DS/xCityPlatformUtils/xCityCredentials","DS/XCityTools/RenderingTools","DS/UrbanFeature/Coordinate"],function(e,t,i,n,r,s,o,a,h,d,l,u){"use strict";var c=e.extend({defaults:{url:"",spec:null,scale:null,Coordinate:null,Shader:null,shadow:!0,extension:"",renderID:"",Rendering:null,objectId:"",fileId:"",serviceId:"",objectType:"",loadInfo:{loaded:1,total:1}},metaData:{type:"Geometry",className:"Geometry"},loaderJSON:{Shader:"loadJSONObject",spec:"loadJSONObject"},setup:function(){this._parent(),this._node=new i,this._node.name="geometryFeature",this.loaderJSON||(this.loaderJSON={}),this.addEvent("onChange:Coordinate",this._updateCoordinate,this)},destroy:function(e){e.getNode3D().remove(this._node),this._parent(e)},create:function(e){var t=this._parent(e);if(this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,!t)return!1;var i=e._urban;this._urban=i,this.renderingProfileManager=i.getRenderingProfileManager(),this._node.userData=this._itemParent,this._itemParentVisible(this._itemParent);var n;this._rendering=new r(i),this._rendering.addDefaultScaleFromAttributes("scale"),this._loaded=!1,this.renderingProfileManager.initRendering(this),this.getItemParent().get("visible")&&(n=this._loadModel(),s.is(n)&&(this._loaded=!0,this._initScale(n),this._node.addChild(n))),this._updateGeometryTags(),e.getNode3D().add(this._node)},_updateGeoloc:function(){var e=this;h.retrieveModelGeolocAttributes(h.url3DSpace,this.get("objectId"),d.preferredCredentials).then(function(i){var n=h.getCoordinateFromGeoloc(i),r=n.position;r=new t.Vector3(r[0],r[1],r[2]);var o=n.rotation,a=new t.Vector3(o[0],o[1],o[2]),d=e.get("Coordinate");if(d){n.projection,n.shifted,n.altitudeMode;var l=d.get("initialOffset");s.is(l)?l.equals(r)||(l.equals(d.get("position"))&&d.set("position",r.clone()),d.set("initialOffset",r.clone())):d.set("initialOffset",r.clone());var c=d.get("initialRotation");s.is(c)?c.equals(a)||(c.equals(d.get("rotation"))&&d.set("rotation",a.clone()),d.set("initialRotation",a.clone())):d.set("initialRotation",a.clone())}else n.position=r.clone(),n.rotation=a.clone(),d=new u(n),e.set("Coordinate",d)})},_loadModel:function(){var e,t=this.get("objectType"),i=this;if("Document"!==t&&""!==t)""!==this.get("objectId")&&(this._updateGeoloc(),e=this._urban.modelLoader.load({spec:{provider:"EV6",serverurl:h.url3DSpace,tenant:h.getTenantId(),dtype:t,requiredAuth:"passport",physicalid:this.get("objectId")},rendering:this._rendering},this.modelLoaded.bind(this),this.modelProgressed.bind(this)));else if(""!==this.get("objectId")&&""!==this.get("fileId")){var n=this.get("serviceId");""!==n&&null!=n||(n="3DSpace"),a.retrieveDocumentUrl(this.get("objectId"),this.get("fileId"),n).then(function(t){var n=i.get("extension");e="3dxc"===n||"3dx"===n||"dae"===n?i._urban.modelLoader.load({url:t,extension:i.get("extension"),shader:i.get("Shader"),shadow:i.get("shadow"),rendering:i._rendering},i.modelLoaded.bind(i),i.modelProgressed.bind(i)):i._urban.modelLoader.load({spec:{provider:"FILE",tenant:h.getTenantId(),filename:t,url:t,requestsOptions:{authentication:"passport",proxy:"none",method:"POST"},format:i.get("extension")},rendering:i._rendering},i.modelLoaded.bind(i),i.modelProgressed.bind(i)),s.is(e)&&(i._loaded=!0,i._initScale(e),i._node.addChild(e))})}else""!==this.get("url")?e=this._urban.modelLoader.load({url:this.get("url"),extension:this.get("extension"),shader:this.get("Shader"),shadow:this.get("shadow"),rendering:this._rendering},this.modelLoaded.bind(this),this.modelProgressed.bind(this)):null!==this.get("spec")&&(e=this._urban.modelLoader.load({spec:this.get("spec"),scale:this.get("scale"),rendering:this._rendering},this.modelLoaded.bind(this),this.modelProgressed.bind(this)));return e},redraw:function(){var e=this.getRendering();s.is(e)&&e.updateSpecificRendering()},modelLoaded:function(e,t){if(o.publish(o.eventsList.onLoaded+":"+this.get("id"),{success:t,item:this.getItemParent()}),!1===t)this.set("loadInfo",{loaded:1,total:1,success:!1});else{var i=this.get("loadInfo"),n={loaded:i.total,total:i.total};this.set("loadInfo",n)}this._itemParent.get("selected")&&this._urban.USR.setRobotTarget(this._itemParent,!0)},_isModelInMillimeters:function(e,t,i){return!(!e.name||!e.name.includes(".3dxml")&&!e.name.includes(".cgr"))||(!(!t||"Document"===t||""===t)||!!i)},_initScale:function(e){var i=this._rendering.getCompleteMaterialInfo(this.id,this._attributes).scale,n=new t.Vector3(0,0,0);if(i.equals(n)){if(this._isModelInMillimeters(e.name,this.get("objectType"),this.get("spec"))){o=l._initVector3(.001);this.setScale(e,o),(r=this._attributes.Coordinate._scale)&&!s.is(e.parents[0])&&this.applyScale(e,l._initVector3(r))}}else{var r,o=i;this.setScale(e,o),(r=this._attributes.Coordinate._scale)&&!s.is(e.parents[0])&&this.applyScale(e,l._initVector3(r))}this._rendering.currentRendering.renderingData.scale=o||l._initVector3(1)},setScale:function(e,i){if(e._matrix){var n=i.x/e._matrix.elements[0],r=i.y/e._matrix.elements[5],s=i.z/e._matrix.elements[10],o=new t.Vector3(n,r,s);e.setMatrix(e.getMatrix().scale(o))}else e.setMatrix((new t.Matrix4).makeScale(i.x,i.y,i.z))},applyScale:function(e,i){e._matrix?e.setMatrix(e.getMatrix().scale(i)):e.setMatrix((new t.Matrix4).makeScale(i.x,i.y,i.z))},modelProgressed:function(e){this.set("loadInfo",e)},getLocalPosition:function(){var e=this._node.getBoundingSphere().center;return this.get("Coordinate")&&e.add(this.get("Coordinate").getLocalPosition()),e},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},_updateCoordinate:function(){var e=this.previous("Coordinate");e&&e.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")&&(this.get("Coordinate").setItemParent(this),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this))},setColor:function(e){return!e||e instanceof t.Color||(e=new t.Color(e)),void 0===e&&(e=new t.Color),this.renderingProfile&&this.renderingProfileManager.addRendering(this.parentFeatureID,{color:e,ambient:e}),this},removeColor:function(){return void 0!==this._node&&void 0!==this.get("color")&&this.setColor(void 0),this},setOpacity:function(e){return this.opacity=e,this.renderingProfile&&this.renderingProfileManager.addRendering(this.parentFeatureID,{opacity:e}),this},_setMeshColor:function(e,t){var i=t.mesh3js,r=i.material,o=i.geometry;if(void 0!==r){var a=!1;if(s.is(o)&&o.length>0&&(o=o[0],s.is(o.drawingGroups)&&o.drawingGroups.length>0))for(var h=0;h<o.drawingGroups.length;h++)o.drawingGroups[h].gas.color=e,a=!0,n.updateCommonUniforms(o.drawingGroups[h].gas);a||(r.color=e,n.updateCommonUniforms(r)),t.setMaterial(r)}else void 0!==o&&o.faces&&this._setGeometryColor(e,o,0,o.faces.length,r)},_setGeometryColor:function(e,i,n,r,s){void 0===s||s.vertexColors!==t.VertexColors?this._setFaceColors(i,e,n,r):this._setVertexColors(i,e,n,r)},_setFaceColors:function(e,t,i,n){for(var r=e.faces,s=0;s<n;s++)r[i+s].color=t;e.colorsNeedUpdate=!0},_setVertexColors:function(e,t,i,n){for(var r=e.faces,s=0;s<n;s++){var o=r[i+s].vertexColors;r[i+s].color&&(r[i+s].color=t);for(var a=o.length,h=0;h<a;h++)o[h]=t}e.colorsNeedUpdate=!0},_itemParentVisible:function(e){if(this._created){if(e.get("visible")&&!1===this._loaded){var t=this._loadModel();s.is(t)&&(this._loaded=!0,this._initScale(t),this._node.addChild(t))}this._node.setVisibility(e.get("visible"))}},setItemParent:function(e){this._itemParent&&(this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._itemParent.removeEvent("onChange:tags",this._updateGeometryTags,this)),this._parent(e),this._itemParent&&(this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this),this._itemParent.addEvent("onChange:tags",this._updateGeometryTags,this))},_updateMatrix:function(e){this._node.setMatrix(e)},_updateGeometryTags:function(){if(void 0!==this._itemParent&&void 0!==this._node){var e=this._itemParent.get("tags");e&&-1!==e.indexOf("UNDERGROUND")?this._node.setRenderPasses(["UNDERGROUND_PREPASS","UNDERGROUND_POSTPASS"]):this._node.setRenderPasses(["main"]),o.publish("/xCity/needRender",this)}},getRendering:function(){return this._rendering},get:function(e){var t,i,n=this.getRendering();return this.renderingProfileManager&&s.is(n)&&n.hasAttribute(e)?(i=this.getMaterial(),s.is(i)&&(t=i[e],"scale"===e&&t.x&&(t=[t.x,t.y,t.z]))):t=this._parent(e),t},set:function(e,t){var i={},n=this.getRendering();this.renderingProfileManager&&s.is(n)&&n.hasAttribute(e)?(i[e]=t,this.setMaterial(i)):this._parent(e,t)},setMaterial:function(e){if(e.scale)for(var t in this._node.children)this.setScale(this._node.children[t],l._initVector3(e.scale));return this.renderingProfileManager.addRendering(this.parentFeatureID,e),this},getMaterial:function(){var e=this.getRendering();return s.is(e)?e.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)}});return e.ObjectContructor.Model=e.ObjectContructor.Geometry=c}),define("DS/UrbanFeature/Polygon",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityModel/Item","DS/XCityGeometry/Polygon","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/VectorLoaderEnovia","DS/XCityLayer/Vector","DS/UrbanTool/Utils","DS/XCityRendering/RenderingHandlerPolygon","DS/XCityTools/EventDispatcher","DS/UrbanFeature/Coordinate"],function(e,t,i,n,r,s,o,a,h,d,l){"use strict";var u=i.extend({defaults:{url:"",geojson:null,Coordinate:null,renderID:"",Rendering:null},metaData:{type:"Geometry",className:"Polygon"},loaderJSON:{geojson:"loadJSONObject"},setup:function(){this._parent(),this._node=new t,this._node.name="polygonFeature",this.loaderJSON||(this.loaderJSON={}),this.heightMatrix=new e.Matrix4,this.addEvent("onChange:Coordinate",this._updateCoordinate,this)},destroy:function(e){e.getNode3D().remove(this._node),this._parent(e)},create:function(t){if(!this._parent(t))return!1;var i=t._urban;this.renderingProfileManager=i.getRenderingProfileManager(),this._rendering=new h(i),this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this._node.userData=this._itemParent,this._itemParentVisible(this._itemParent),t.getNode3D().add(this._node),this.setColor(this.get("color")),this._updateCoordinate();var l=function(t,r,s,o){var h;if(a.is(t)){var d={x:t[0].x,y:t[0].y,z:0},l=a.offsetVerticesXY(t,d);h=new n(i,{shape:l,holes:r,geometricMode:o.get("geometricMode"),renderMode:o.get("renderMode"),color:o.get("color"),opacity:o.get("opacity"),opacityFactor:o.get("opacityFactor"),lineWidth:o.get("lineWidth"),rendering:o.getRendering(),attributes:s.attributes});var u=(new e.Matrix4).identity().setPosition(d);h.setMatrix(u)}return h},u=function(e,t,i){var n;if(!1!==t)if(void 0===this.geojson?(n=(-1!==e.indexOf("FeatureCollection")?new r:new s).loadDataSource(e),this.set("geojson",JSON.parse(e))):(n=("FeatureCollection"===e.type?new r:new s).loadDataSourceFromObject(e),this.geojson=void 0,this.set("geojson",e)),0!==n.count){for(var h,u,c,g=new o.Feature;null!==(g=n.getNextFeature(g));){var f=g.getGeometry();if(f){var p,m=null,v=[],_=[];if(f.type===o.Type.LINESTRING&&void 0!==f.vertexList)m=f.vertexList,h=l(m,v,g,this),_.push(h);else if(f.type===o.Type.POLYGON&&void 0!==f.geometryList&&f.geometryList.length>0){for(p={x:(m=f.geometryList[0].vertexList)[0].x,y:m[0].y,z:0},u=1;u<f.geometryList.length;u++)v.push(a.offsetVerticesXY(f.geometryList[u].vertexList,p));h=l(m,v,g,this),_.push(h)}else if(f.type===o.Type.MULTIPOLYGON){var b=f.geometryList.length;for(c=0;c<b;c++){var y=f.geometryList[c];for(p={x:(m=y.geometryList[0].vertexList)[0].x,y:m[0].y,z:0},u=1;u<y.geometryList.length;u++)v.push(a.offsetVerticesXY(y.geometryList[u].vertexList,p));h=l(m,v,g,this),_.push(h)}}if(void 0!==h){for(c=0;c<_.length;c++)h=_[c],this._node.addChild(h);var S=g.getAttributeKeys(),D=S.length;for(D>0&&(void 0===this.userData||null===this.userData)&&(this.userData={});D--;)this.userData[S[D]]=g.getAttribute(S[D])}}}d.publish(d.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})}else d.publish(d.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()});else d.publish(d.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()})}.bind(this);if(""!==this.get("url")){var c=this.get("url");a.download(void 0,i,u,c)}else""!==this.get("geojson")&&(this.geojson=!0,u(this.get("geojson")));i.getRenderingProfileManager().initRendering(this)},getLocalPosition:function(){var e=this._node.getBoundingSphere().center;return this.get("Coordinate")&&e.add(this.get("Coordinate").getCentralTranslation()),e},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},_updateCoordinate:function(){var e=this.previous("Coordinate");e&&e.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")?(this.get("Coordinate").setItemParent(this),this._updateMatrix(this.get("Coordinate")._matrix),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this)):this._updateMatrix()},setColor:function(t){return!t||t instanceof e.Color||(t=new e.Color(t)),void 0===t&&(t=new e.Color),this._setGeometryProperty("setColor",t),this},removeColor:function(){return void 0!==this.get("color")&&this.setColor(void 0),this},setOpacity:function(e){return this._setGeometryProperty("setOpacity",e),this},setOpacityFactor:function(e){return this._setGeometryProperty("setOpacityFactor",e),this},setLineWidth:function(e){return this._setGeometryProperty("setLineWidth",e),this},setGeometricMode:function(e){return this._setGeometryProperty("setGeometricMode",e),this},setRenderMode:function(e){return this._setGeometryProperty("setRenderMode",e),this},_setGeometryProperty:function(e,t){void 0!==this._node&&this._node.traverse(function(i){i instanceof n&&i[e](t)})},_itemParentVisible:function(e){this._created&&this._node.setVisibility(e.get("visible"))},setItemParent:function(e){this._itemParent&&this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._parent(e),this._itemParent&&this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this)},_updateMatrix:function(e){this.heightMatrix.identity(),e&&this.heightMatrix.multiply(e),this._node.setMatrix(this.heightMatrix)},redraw:function(){if(void 0!==this._node){var e=this._rendering._needRebuild;this._node.traverse(function(t){t instanceof n&&(t._applyMaterial(),!0===e&&t.rebuild())}),this._rendering._needRebuild=!1}},getRendering:function(){return this._rendering},get:function(e){var t,i,n=this.getRendering();return this.renderingProfileManager&&a.is(n)&&n.hasAttribute(e)?(i=this.getMaterial(),a.is(i)&&(t=i[e])):t=this._parent(e),t},set:function(e,t){var i={},n=this.getRendering();this.renderingProfileManager&&a.is(n)&&n.hasAttribute(e)?(i[e]=t,this.setMaterial(i)):this._parent(e,t)},setMaterial:function(e){return this.renderingProfileManager.addRendering(this.parentFeatureID,e),this},getMaterial:function(){var e=this.getRendering();return a.is(e)?e.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)},addUserDataProperty:function(e,t,i){if(a.is(e)){var n=this.get("geojson"),r=n.features[0];if(a.is(i))for(var s=0;s<n.features.length;s++){var o=n.features[s];if(o&&o.properties&&o.properties.STRID===i){r=o;break}}r.properties||(r.properties={}),r.properties[e]=t;var h=this.getUserData();return h||(h={},this.userData=h),h[e]=t,!0}return!1},removeUserDataProperty:function(e,t){if(a.is(e)){var i=this.get("geojson"),n=i.features[0];if(a.is(t))for(var r=0;r<i.features.length;r++){var s=i.features[r];if(s&&s.properties&&s.properties.STRID===t){n=s;break}}a.is(n.properties[e])&&delete n.properties[e];var o=this.getUserData();return a.is(o[e])&&delete o[e],!0}return!1},getTransformedGeoJSON:function(){var t=this.get("Coordinate"),i=this.get("geojson");if(!a.is(t))return i;var n=t.getMatrix();if(n.isIdentity())return i;for(var r=i.features[0].geometry.coordinates[0],s=[],o=0;o<r.length;o++){var h=new e.Vector3(r[o][0],r[o][1],0);h.applyMatrix4(n),s.push(h.toArray())}var d=a.clone(i);return d.features[0].geometry.coordinates[0]=s,d},toJSON:function(){var e=this._parent(),t=this.get("Coordinate");if(a.is(t)){var i=this.getTransformedGeoJSON();e.geojson=i}return e}});return i.ObjectContructor.Polygon=u}),define("DS/UrbanFeature/PointCloud",["DS/XCityModel/Item","DS/UrbanFeature/Geometry","DS/XCityLoaders/ReloadSceneCommand"],function(e,t,i){"use strict";var n=t.extend({metaData:{type:"PointCloud",className:"PointCloud"},init:function(e){this._parent(e)},destroy:function(){var e=new i;e.begin(),e.setCallbackOnfinish(this._parent().bind(this))}});return e.ObjectContructor.PointCloud=n}),define("DS/UrbanFeature/KeyFrameAnimation",["DS/UrbanFeature/Geometry","DS/XCityModel/Item"],function(e,t){"use strict";var i=e.extend({metaData:{type:"KeyFrameAnimation",className:"KeyFrameAnimation"},destroy:function(e){this._parent(e)}});return t.ObjectContructor.KeyFrameAnimation=i}),define("DS/UrbanFeature/Line",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityModel/Item","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/VectorLoaderEnovia","DS/XCityLayer/Vector","DS/UrbanTool/Utils","DS/XCityGeometry/LineBuilder","DS/XCityTools/EventDispatcher","DS/UrbanFeature/Coordinate"],function(e,t,i,n,r,s,o,a,h,d){"use strict";var l=i.extend({defaults:{url:"",geojson:null,Coordinate:null,renderID:"",Rendering:null,stridAttribute:"STRID"},metaData:{type:"Geometry",className:"Line"},loaderJSON:{geojson:"loadJSONObject",animation:"loadJSONObject"},setup:function(){this._parent(),this._node=new t,this._node.name="lineFeature",this.loaderJSON||(this.loaderJSON={}),this.heightMatrix=new e.Matrix4},destroy:function(e){h.unsubscribe(this.builder.tokenUpdateEvent),e.getNode3D().remove(this._node),this._parent(e)},create:function(i){var d,l;if(!this._parent(i))return!1;this.urban=i._urban,this.renderingProfileManager=this.urban.getRenderingProfileManager(),this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this._node.userData=this._itemParent,this._itemParentVisible(this._itemParent),i.getNode3D().add(this._node),this._updateCoordinate(),this.builder=new a(this.urban);var u=function(i,a){if(!1!==a)if(void 0===this.geojson?(l=-1!==i.indexOf("FeatureCollection")?new n:new r,d=l.loadDataSource(i),this.set("geojson",JSON.parse(i))):(l="FeatureCollection"===i.type?new n:new r,d=l.loadDataSourceFromObject(i),this.geojson=void 0,this.set("geojson",i)),0!==d.count){for(var u,c,g=function(e,t,i,n,r){var s=e.getVertices();if(void 0!==s){0===r.x&&0===r.y&&(r.x=Math.round(s[0].x),r.y=Math.round(s[0].y));for(var o=0;o<e.getVertices().length;o++)e.getVertices()[o].z=f(t,e.getVertices()[o]),e.getVertices()[o].x=e.getVertices()[o].x-r.x,e.getVertices()[o].y=e.getVertices()[o].y-r.y;var a=i.getAttribute(n.get("stridAttribute")),h=!1;return void 0===a&&(a=n.get("id"),h=!0),n.builder.buildOne(a,e,n.get("Coordinate"),h,i.attributes)}},f=function(e,t){var i=0;return i=o.is(t.z)&&"geometry"===e.elevationMode?t.z:"advanced"===e.elevationMode||"geometry"===e.elevationMode?e.elevation:this.urban.USR.getGroundHeight(t.x,t.y),e.elevationOffset&&(i+=e.elevationOffset),i},p=new s.Feature,m={},v=new e.Vector2,_=void 0;null!==(p=d.getNextFeature(p));){var b=p.getGeometry();if(b){var y=this.getRendering().getCompleteMaterialInfo(this.get("id"),p.attributes);if(b.type===s.Type.LINESTRING&&void 0!==b.vertexList)u=g(b,y,p,this,v),o.is(m[u.lineId])||(m[u.lineId]=[]),m[u.lineId].push(u),u.isTransparent&&(_=!0);else if(b.type===s.Type.MULTILINESTRING){var S=b.geometryList.length;for(c=0;c<S;c++){u=g(b.geometryList[c],y,p,this,v),o.is(m[u.lineId])||(m[u.lineId]=[]),m[u.lineId].push(u),u.isTransparent&&(_=!0)}}var D=p.getAttributeKeys(),C=D.length;for(C>0&&(void 0===this.userData||null===this.userData)&&(this.userData={});C--;)this.userData[D[C]]=p.getAttribute(D[C])}}var P=new t,M=new e.Vector3(v.x,v.y,0),x=(new e.Matrix4).identity().setPosition(M);P.setMatrix(x),this._node.addChild(P),this.builder.getData(m,P,_),h.publish(h.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})}else h.publish(h.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()});else h.publish(h.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()})}.bind(this);if(""!==this.get("url")){var c=this.get("url");o.download(void 0,this.urban,u,c)}else null!==this.get("geojson")&&(this.geojson=!0,u(this.get("geojson"),!0));this.renderingProfileManager.initRendering(this)},_addListeners:function(){var e=this;a.getSettableAttributes().forEach(function(t){e.addEvent("onChange:"+t,function(){e.setAttribute(t,e.get(t))},e)})},setAttributeGeom:function(e,t){void 0!==this._node&&("renderMode"===e?this.builder.setRenderMode(t):"animation"===e?this.builder.setAnimation(t,this._node.children[0]):"dynamicUpdate"===e&&this.builder.setDynamicUpdate(t),this._node.traverse(function(i){o.is(i.setAttribute)&&i.setAttribute(e,t)}))},setAttribute:function(e,t){var i={};return void 0!==this._node&&(i[e]=t,this.setMaterial(i)),this},setMaterial:function(e){return this.renderingProfileManager.addRendering(this.parentFeatureID,e),this},getMaterial:function(){var e=this.getRendering();return o.is(e)?e.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)},get:function(e){var t,i,n=this.getRendering();return this.renderingProfileManager&&o.is(n)&&n.hasAttribute(e)?(i=this.getMaterial(),o.is(i)&&(t=i[e])):t=this._parent(e),t},getLocalPosition:function(){var e=this._node.getBoundingSphere().center;return this.get("Coordinate")&&e.add(this.get("Coordinate").getCentralTranslation()),e},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},_updateCoordinate:function(){var e=this.previous("Coordinate");e&&e.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")?(this.get("Coordinate").setItemParent(this),this._updateMatrix(this.get("Coordinate")._matrix),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this)):this._updateMatrix()},_itemParentVisible:function(e){this._created&&this._node.setVisibility(e.get("visible"))},setItemParent:function(e){this._itemParent&&this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._parent(e),this._itemParent&&this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this)},_updateMatrix:function(e){this._node.setMatrix(e)},redraw:function(){var e=this.getRendering();this._node.children.length>0&&this._node.children[0].children.length>0&&this._node.traverse(function(t){return!!t.lineBuilder&&(e.applyRendering(t),!0)})},getRendering:function(){return o.is(this.builder)?this.builder._rendering:null},set:function(e,t){var i=this.getRendering();this.renderingProfileManager&&o.is(i)&&i.hasAttribute(e)?(this.setAttribute(e,t),this.getRendering().initMesh(this._node.children[0])):this._parent(e,t)},addUserDataProperty:function(e,t,i){if(o.is(e)){var n=this.get("geojson"),r=n.features[0];if(o.is(i))for(var s=0;s<n.features.length;s++){var a=n.features[s];if(a&&a.properties&&a.properties.STRID===i){r=a;break}}r.properties||(r.properties={}),r.properties[e]=t;var h=this.getUserData();return h||(h={},this.userData=h),h[e]=t,!0}return!1},removeUserDataProperty:function(e,t){if(o.is(e)){var i=this.get("geojson"),n=i.features[0];if(o.is(t))for(var r=0;r<i.features.length;r++){var s=i.features[r];if(s&&s.properties&&s.properties.STRID===t){n=s;break}}o.is(n.properties[e])&&delete n.properties[e];var a=this.getUserData();return o.is(a[e])&&delete a[e],!0}return!1},getTransformedGeoJSON:function(){var t=this.get("Coordinate"),i=this.get("geojson");if(!o.is(t))return i;var n=t.getMatrix();if(n.isIdentity())return i;for(var r=i.features[0].geometry.coordinates,s=[],a=0;a<r.length;a++){var h=new e.Vector3(r[a][0],r[a][1],r[a][2]);h.applyMatrix4(n),s.push(h.toArray())}var d=o.clone(i);return d.features[0].geometry.coordinates=s,d},getBaseAltitude:function(){var e=this.get("Coordinate").get("position").z,t=this.get("geojson");if(!o.is(t))return e;for(var i=t.features[0].geometry.coordinates,n=i[0][2],r=1;r<i.length;r++)n=Math.min(n,i[r][2]);return e+=n},toJSON:function(){var e=this._parent(),t=this.get("Coordinate");if(o.is(t)){var i=this.getTransformedGeoJSON();e.geojson=i,e.Coordinate=new d}return e}});return i.ObjectContructor.Line=l}),define("DS/UrbanFeature/BuildingSet",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityModel/Item","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/VectorLoaderEnovia","DS/XCityLayer/Vector","DS/UrbanTool/Utils","DS/XCityGeometry/PatchVectorFactoryBuilding","DS/XCityModel/LayerVectorPrimitive","DS/XCityTools/EventDispatcher","DS/XCityTools/Geocoder","DS/UrbanFeature/Coordinate","DS/XCityTools/Disposer"],function(e,t,i,n,r,s,o,a,h,d,l,u,c,g){"use strict";var f,p=["floorsNumber","HEIGHT","ALTITUDE","floorHeight","groundFloorHeight","roofShape","ROOFHGT","ROOFANGLE"],m={floors:"FLOORS",height:"HEIGHT",altitude:"ALTITUDE",floorHeight:"FLOORHEIGHT",groundFloorHeight:"GROUNDFLOORHEIGHT",roofShape:"ROOFSHAPE",roofHeight:"ROOFHGT",roofAngle:"ROOFANGLE"},v=n.extend({defaults:{url:"",geojson:null,type:"json",renderMode:"occluded",Coordinate:null,renderID:"",Rendering:null,stridAttribute:"STRID",objectId:"",asynchronous:!0,lines:!0,Floor:!0,Roof:!0,Dimensions:!0,floors:1,floorHeight:2.7,groundFloorHeight:2.7,roofHeight:2,roofAngle:45,roofShape:"MANSARD",length:5,width:10,rectangleBase:null},metaData:{type:"Geometry",className:"BuildingSet"},loaderJSON:{geojson:"loadJSONObject"},setup:function(){this._parent(),this._node=new t,this._node.name="BuildingSetFeature",this.loaderJSON||(this.loaderJSON={}),this.heightMatrix=new e.Matrix4,this.addEvent("onChange:Coordinate",this._updateCoordinate,this),this.addEvent("onChange:geojson",this._updateValues,this)},destroy:function(e){e.getNode3D().remove(this._node),g.disposeV6(this._node),this._parent(e)},getNode3D:function(){return this._node},create:function(e,t){if(this.urban=e._urban,!this._parent(e))return l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this.renderingProfileManager=this.urban.getRenderingProfileManager(),e.getNode3D().add(this._node),this._node.userData=this._itemParent,this._itemParentVisible(this._itemParent),this._updateCoordinate();var i={stridAttribute:this.get("stridAttribute")};if(this._factory=new h(this.urban,i),a.is(this._rendering)&&(this._factory._rendering=this._rendering),this.nbPolygon=0,this.nbMultiPolygon=0,this._rendering=this._factory._rendering,""!==this.get("url")){var n=this.get("url");a.download(void 0,this.urban,this._createBuildingSet.bind(this),n)}else null!==this.get("geojson")&&(this.geojson=!0,this._createBuildingSet(this.get("geojson"),!0));return!0!==this._renderingInitialized&&(this._renderingInitialized=!0,this.renderingProfileManager.initRendering(this)),!0},_createBuildingSet:function(n,h){if(!1!==h){var d,c,g,f=this.get("type");"json"===f?d=new r:"gml"===f?d=new VectorLoaderGML:"enovia"===f&&(d=new s(urban)),void 0===this.geojson?(c=d.loadDataSource(n),g=JSON.parse(n)):(c=d.loadDataSourceFromObject("string"==typeof n?JSON.parse(n):n),g="string"==typeof n?JSON.parse(n):n);var p=c.count;if(0!==p){for(var m=new o.Feature,v=Math.ceil(p/5e3),_=[],b=0;b<v;++b)_[b]={tile:{LOD:0,I:0,J:0},infos:{},ltileGeoms:{}};var y=[],S=g.crs&&g.crs.properties&&g.crs.properties.name?g.crs.properties.name:"WGS84",D=S.indexOf("EPSG");D>0&&(S=S.slice(D)),S=S.replace("::",":"),this.registerPrimitive=function(e){if(a.is(this._patch)){var t=this.getRendering();a.is(t)&&(t.isPrimitiveRegistered(e)||t.registerPrimitive(this._patch,e))}}.bind(this),this.registerPrimitives=function(e){var t,i,n=Object.keys(e),r=n.length;for(t=0;t<r;t++)i=n[t],this.registerPrimitive(i)}.bind(this);var C=0;this._polygons=new t,this.primInfos={},this._node.addChild(this._polygons),this._node.userData=this._itemParent;var P=function(){var e=C;if(this._polygons.addChild(this._factory.getData(_[e])),Object.assign(this.primInfos,_[e].infos),e===v-1){this._patch={register:function(e,t){t(this.primInfos[e])}.bind(this),unregister:function(e,t){},previewMode:!0,_uidListeners:this.primInfos};var t=function(e){if(e instanceof i&&!0===e.pickable){e.show();var t,n,r,s=e.getPrimitives();if(!1===e.isInstanceNode3D)for(t=0;t<s.length;t++){n=s[t].sgNode;for(var o=0;o<v;++o)(r=_[o].infos[n.getCgmId()])&&(r.geom?r.geom.push({subElement:n,mesh:e}):r.geom=[{subElement:n,mesh:e}])}}}.bind(this);this._polygons.traverse(t.bind(this)),this._polygons.children[0].userData={records:y},this.userData=a.clone(this.userData),l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})}}.bind(this),M=0,x=0,I=function(){for(var t=0,i=!1,n=M;n<p;++n){if(50===t){M=n,l.subscribeTo("/3DEXPERIENCity/onPostUpdate",I,!0);break}n===p-1&&(i=!0),c.getNextFeature(m);var r=m.getGeometry();if(r.type===o.Type.MULTIPOLYGON)if(this.nbMultiPolygon++,S===this.urban.baseProjection);else for(var s=r.geometryList,a=0;a<s.length;++a)for(var h=s[a].geometryList,d=0;d<h.length;++d)for(var g=h[d].vertexList,f=0;f<g.length;++f){var b=g[f],D=u.proj(b,S,this.urban.baseProjection);b.x=D.x,b.y=D.y}else{if(r.type!==o.Type.POLYGON)continue;if(this.nbPolygon++,S===this.urban.baseProjection);else for(s=r.geometryList,a=0;a<s.length;++a)for(g=s[a].vertexList,f=0;f<g.length;++f){b=g[f],D=u.proj(b,S,this.urban.baseProjection);b.x=D.x,b.y=D.y}}var w={strid:m.getAttribute(this._factory.stridAttribute),tile:{LOD:0,I:0,J:0},posSize:{center:new e.Vector3,altitude:0,height:0,width:0,length:0},userData:{}};if(void 0===w.strid&&(w.strid=this.get("id")+"_"+(this.nbPolygon+this.nbMultiPolygon),m.attributes[this._factory.stridAttribute]=w.strid),r){var O,R;for(R=(O=m.getAttributeKeys()).length;R--;)w.userData[O[R]]=m.getAttribute(O[R]);y.push(w);var V=Math.floor(x/5e3);_[V].infos[w.strid]=w;var F=this._rendering.getStrokeHandler();this._rendering.defaultRendering.addOver({stroke:{enable:!0,lineWidth:2,renderMode:"occluded",minWidth:0,maxDist:2500,minDist:300,dynamicUpdate:!0,minOpacity:0},elevationMode:"advanced",elevation:0}),F.defaultRendering.addOver({lineWidth:2,renderMode:"occluded"}),this._factory.buildOne(m,_[V],w),5e3===_[V].nbFeature&&(C=V,l.subscribeTo("/3DEXPERIENCity/onPostUpdate",P,!0))}t++,x++}i&&(C=v-1,this.get("asynchronous")?l.subscribeTo("/3DEXPERIENCity/onPostUpdate",P,!0):P())}.bind(this);this.get("asynchronous")?l.subscribeTo("/3DEXPERIENCity/onPostUpdate",I,!0):I()}else l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()})}else l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()})},isDataAttribute:function(e){return this.getAttributeListImpactingGeoJSON().indexOf(e)>=0},get:function(e){var t,i,n=this.getRendering();if("length"===e)return this.getLength();if("width"===e)return this.getWidth();if("lines"===e){var r=this.getMaterial();r&&r.stroke&&(t=r.stroke.enable)}else if(this.isDataAttribute(e)){var s=this.getUserData();a.is(s)&&(a.is(f)||(f=a.getBuildingGISPropertiesMap()),t=s[f[e]],"groundFloorHeight"!==e||a.is(t)||(t=this.get("floorHeight")))}else this.renderingProfileManager&&a.is(n)&&n.hasAttribute(e)?(i=this.getMaterial(),a.is(i)&&(t=i[e])):t=this._parent(e);return t},set:function(e,t){var i={},n=this.getRendering();return"length"===e?t===this.get("length")?this._parent(e,t):this.setLength(t):"width"===e?t===this.get("width")?this._parent(e,t):this.setWidth(t):void("lines"===e?(i.stroke={enable:t},this.setMaterial(i),this._parent(e,t)):this.isDataAttribute(e)?a.is(t)&&(a.is(f)||(f=a.getBuildingGISPropertiesMap()),this.addUserDataProperty(f[e],t),this._parent(e,t)):this.renderingProfileManager&&a.is(n)&&n.hasAttribute(e)?(i[e]=t,this.setMaterial(i)):this._parent(e,t))},setMaterial:function(e){return a.is(this.renderingProfileManager)&&this.renderingProfileManager.addRendering(this.parentFeatureID,e),this},getMaterial:function(){var e=this.getRendering();return a.is(e)?e.getCompleteMaterialInfo():a.is(this.renderingProfileManager)?this.renderingProfileManager.getRenderingData(this.parentFeatureID):null},getLocalPosition:function(){var e=this._node.getBoundingSphere().center;return this.get("Coordinate")&&e.add(this.get("Coordinate").getLocalPosition()),e},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},getBoundingSphere:function(){if(this._node){if(this._localPosition&&a.is(this._factory)&&a.is(this._factory.rtrees)){var t={minX:this._factory.rtrees[0]._root.boundingBox.min.x,minY:this._factory.rtrees[0]._root.boundingBox.min.y,minZ:this._factory.rtrees[0]._root.boundingBox.min.z,maxX:this._factory.rtrees[0]._root.boundingBox.max.x,maxY:this._factory.rtrees[0]._root.boundingBox.max.y,maxZ:this._factory.rtrees[0]._root.boundingBox.max.z},i=this._localPosition;i.z=this._node.bSphere.center.z;var n=Math.sqrt(Math.pow(t.maxX-t.minX,2)+Math.pow(t.maxY-t.minY,2)+Math.pow(t.maxZ-t.minZ,2))/2;return new e.Sphere(i,n)}return this._node.getBoundingSphere()}},_updateCoordinate:function(){var e=this.previous("Coordinate");e&&e.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")?(this.get("Coordinate").setItemParent(this),this._updateMatrix(this.get("Coordinate")._matrix),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this)):this._updateMatrix()},_updateDimensions:function(){var e=this.getLength(),t=this.getWidth();this.set("length",e),this.set("width",t)},_updateValues:function(){var e,t,i=this.get("geojson"),n=i.features[0].properties,r=a.clone(n);a.is(f)||(f=a.getBuildingGISPropertiesMap());for(var s=this.toJSON(),o={},h=Object.keys(f),d=0;d<h.length;d++){e=h[d];var l=f[e];(t=n[l])||(t=n[l=m[e]])&&(i.features[0].properties[f[e]]=t);var u=s[e];a.is(t)&&u!==t&&(o[e]=t,r[l]=t)}var c=n,g=f.floors,p=f.height,v=f.floorHeight,_=f.groundFloorHeight,b=c[p];if(b&&b>0){var y=c[g],S=c[v],D=S;c[_]&&(D=c[_]),S||(S=y?b/y:2.7),D||(D=S),y||(y=(b-D)/S+1),o.floors=y,r[g]=y,o.floorHeight=S,r[v]=S,o.groundFloorHeight=D,r[_]=D}var C=this.getUserData();C||(C=a.clone(n),this.userData=C),C=Object.assign(r),a.is(C.ROOFANGLE)&&0!==C.ROOFANGLE||(C.ROOFANGLE=this.defaults.roofAngle),a.is(C.roofShape)||(C.roofShape=this.defaults.roofShape),i.features[0].properties=Object.assign(i.features[0].properties,C),this.set("userData",C),this.userData=C,this.set(o),this._updateDimensions(),this.askForRebuild()},_itemParentVisible:function(e){this._created&&this._node.setVisibility(e.get("visible"))},setItemParent:function(e){this._itemParent&&this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._parent(e),this._itemParent&&this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this)},_updateMatrix:function(e){this._node.setMatrix(e)},_setVisible:function(e){var t=!!e.get("visible");this._polygons&&(t?this._node.addChild(this._polygons):this._node.removeChild(this._polygons))},createPrimitive:function(e,t){var i;this._factory&&this._factory.getGeoJSON&&(i=this._factory.getGeoJSON(e));var n=new d({strid:e,geojson:i,instanceId:t});return n.setLayerVector(this),n.create(this.getRoot()),n.addSubElements(this.primInfos[e]),n},register:function(){},unregister:function(){},redrawPrimitive:function(e){if(a.is(this._patch)){var t=this.getRendering();a.is(t)&&(t.isPrimitiveRegistered(e)?t._renderprimitive(e):this.registerPrimitive(e))}},registerPrimitive:function(e){if(a.is(this._patch)){var t=this.getRendering();a.is(t)&&(t.isPrimitiveRegistered(e)||t.registerPrimitive(this._patch,e))}},registerPrimitives:function(e){var t,i,n=Object.keys(e),r=n.length;for(t=0;t<r;t++)i=n[t],this.registerPrimitive(i)},recalculateAttributes:function(e){a.is(f)||(f=a.getBuildingGISPropertiesMap());var t=f.floors,i=f.height,n=f.floorHeight,r=f.groundFloorHeight,s=e[t],o=e[n],h=o;e[r]&&(h=e[r]),a.is(h)&&a.is(s)&&a.is(o)&&(e[i]=h+(s-1)*o)},addUserDataProperty:function(e,t,i){if(a.is(e)){var n=a.clone(this.get("geojson")),r=n.features[0];if(a.is(i))for(var s=0;s<n.features.length;s++){var o=n.features[s];if(o&&o.properties&&o.properties.STRID===i){r=o;break}}r.properties||(r.properties={}),r.properties[e]=t,this.recalculateAttributes(r.properties);var h=this.getUserData();return h||(h=a.clone(r.properties),this.userData=h),h[e]=t,this.recalculateAttributes(h),this.set("userData",h),this.set("geojson",n),this.updateBuildFromAttributes(e),!0}return!1},updateBuildFromAttributes:function(e){this.isGeometryAttribute(e)&&this.askForRebuild()},isGeometryAttribute:function(e){return p.indexOf(e)>=0},removeUserDataProperty:function(e,t){if(a.is(e)){var i=a.clone(this.get("geojson")),n=i.features[0];if(a.is(t))for(var r=0;r<i.features.length;r++){var s=i.features[r];if(s&&s.properties&&s.properties.STRID===t){n=s;break}}a.is(n.properties[e])&&delete n.properties[e],this.recalculateAttributes(n.properties);var o=this.getUserData();return a.is(o[e])&&delete o[e],this.recalculateAttributes(o),this.set("userData",o),this.set("geojson",i),this.updateBuildFromAttributes(e),!0}return!1},redraw:function(){var e=this.getRendering();if(a.is(e)){if(e._needRebuild&&this._node.children.length>0&&(this._node.removeChildren(),this._createBuildingSet(this.get("geojson"),!0)),this._polygons)for(var t=0;t<this._polygons.children.length;++t)e.applyRendering(this._polygons.children[t]);e._needRebuild=!1}},getRendering:function(){return this._rendering},rebuild:function(){if(this.get("id")){var e=this.getRendering();a.is(e)&&(e._needRebuild=!0,this.redraw(),l.unsubscribe(this.rebuildToken),this.rebuildToken=null)}},askForRebuild:function(){a.is(this.rebuildToken)||(this.rebuildToken=l.subscribeTo("/3DEXPERIENCity/onPostUpdate",this.rebuild.bind(this)))},findChildrenByName:function(){return this},isHouse:function(){var e=this.get("rectangleBase");if(!0===e)return!0;if(!1===e)return!1;var t=this.get("geojson");if(t)if(e=!1,5!=t.features[0].geometry.coordinates[0].length)e=!1;else{var i=t.features[0].properties;e=!(!a.is(i.ROOFSHAPE)||"GABLE"!==i.ROOFSHAPE)}return this.set("rectangleBase",e),e},getWidth:function(){if(this.isHouse()){var t=this.get("geojson").features[0].geometry.coordinates[0],i=new e.Vector2(t[0][0],t[0][1]);return new e.Vector2(t[1][0],t[1][1]).clone().sub(i).length()}return null},getLength:function(){if(this.isHouse()){var t=this.get("geojson").features[0].geometry.coordinates[0],i=new e.Vector2(t[0][0],t[0][1]);return new e.Vector2(t[3][0],t[3][1]).clone().sub(i).length()}return null},setWidth:function(t){if(this.isHouse()&&a.is(t)){var i=this.get("geojson"),n=i.features[0].geometry.coordinates[0],r=new e.Vector2(n[0][0],n[0][1]),s=new e.Vector2(n[1][0],n[1][1]),o=new e.Vector2(n[2][0],n[2][1]),h=new e.Vector2(n[3][0],n[3][1]),d=s.clone().sub(r);d.setLength(t),d.add(r);var l=o.clone().sub(h);return l.setLength(t),l.add(h),i.features[0].geometry.coordinates[0][1][0]=d.x,i.features[0].geometry.coordinates[0][1][1]=d.y,i.features[0].geometry.coordinates[0][2][0]=l.x,i.features[0].geometry.coordinates[0][2][1]=l.y,i.features[0].geometry.coordinates[0][4]=i.features[0].geometry.coordinates[0][0],this.set("geojson",i),this.rebuild(),!0}return!1},setLength:function(t){if(this.isHouse()&&a.is(t)){var i=this.get("geojson"),n=i.features[0].geometry.coordinates[0],r=new e.Vector2(n[0][0],n[0][1]),s=new e.Vector2(n[1][0],n[1][1]),o=new e.Vector2(n[2][0],n[2][1]),h=new e.Vector2(n[3][0],n[3][1]).clone().sub(r);h.setLength(t),h.add(r);var d=o.clone().sub(s);d.setLength(t),d.add(s),i.features[0].geometry.coordinates[0][2][0]=d.x,i.features[0].geometry.coordinates[0][2][1]=d.y,i.features[0].geometry.coordinates[0][3][0]=h.x,i.features[0].geometry.coordinates[0][3][1]=h.y,i.features[0].geometry.coordinates[0][4]=i.features[0].geometry.coordinates[0][0],this.set("geojson",i),this.rebuild()}},getTransformedGeoJSON:function(){var t=this.get("Coordinate"),i=a.clone(this.get("geojson"));if(!a.is(t))return i;var n=t.getMatrix();if(n.isIdentity())return i;for(var r=i.features[0].geometry.coordinates[0],s=[],o=0;o<r.length;o++){var h=new e.Vector3(r[o][0],r[o][1],r[o][2]);h.applyMatrix4(n),s.push(h.toArray())}var d=i;return d.features[0].geometry.coordinates[0]=s,d},toJSON:function(){var e=this._parent(),t=this.get("Coordinate");if(a.is(t)){var i=this.getTransformedGeoJSON();e.geojson=i,e.Coordinate=(new c).toJSON()}return e},getConstructionAttributes:function(){return p},getAttributeListImpactingGeoJSON:function(){return a.is(f)||(f=a.getBuildingGISPropertiesMap()),Object.keys(f)},getBaseAltitude:function(){var e=this.get("Coordinate").get("position").z,t=this.get("geojson");return a.is(t)?e+=t.features[0].geometry.coordinates[0][0][2]:e}});return n.ObjectContructor.BuildingSet=v}),define("DS/UrbanFeature/SimplePointOfInterest3D",["DS/XCityModel/Location","DS/XCityModel/Item","DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PointOfInterest3DSet","DS/XCityGeometry/PatchVectorFactoryPointOfInterest3D","DS/XCityModel/LayerVectorPrimitive","DS/XCityModel/LayerVectorCluster","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityTools/Debug","DS/XCityRendering/RenderingHandlerPOI3D","DS/XCityRendering/RenderingHandlerPOI3DBillboard","DS/xCityBasicUtils/Utils","DS/UrbanTool/Utils","DS/XCityTools/EventDispatcher","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/Vector","DS/XCityTools/RTree","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Disposer","DS/XCityTools/Downloader","DS/XCityTools/Geocoder","DS/UrbanFeature/Coordinate"],function(e,t,i,n,r,s,o,a,h,d,l,u,c,g,f,p,m,v,_,b,y,S,D,C){"use strict";var P=e.extend({defaults:{url:"",geojson:"",type:"json",styleClass:"",shapeType:"sphere",nbVertices:15,shadingMode:"smooth",_renderMode:"occluded",renderType:"icon",opacityFactor:.3,altitude:0,height:10,switchDistance:500,samplingFactor:1,renderAnchor:!0,anchorLineWidth:1,scale:8,orientation:0,renderID:"",Rendering:null,nameAttribute:"NAME",stridAttribute:"STRID",styleClassAttribute:"STYLECLASS",altitudeAttribute:"ALTITUDE",heightAttribute:"HEIGHT",orientationAttribute:"ORIENTATION",rtreeMin:5,rtreeMax:10,rtreeCoverageFactor:2,magnitude:null,Coordinate:null},metaData:{type:"Location",className:"SimplePointOfInterest3D"},loaderJSON:{geojson:"loadJSONObject"},setup:function(){this._parent(),this._poi=void 0,this._scaleZ=!0,this._node=new a,this._node.name="poi3DSetFeature",this._node.hwInstancing=!0,this.addEvent("onChange:Coordinate",this._updateCoordinate,this)},destroy:function(e){e.getNode3D().remove(this._node),this._parent(e)},getMesh:function(){return new a},create:function(e){if(!this._parent(e))return f.publish(f.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;e.getNode3D().add(this._node),this.urban=e._urban,this._updateCoordinate();var t={nameAttribute:this.get("nameAttribute"),stridAttribute:this.get("stridAttribute"),styleClassAttribute:this.get("styleClassAttribute"),altitudeAttribute:this.get("altitudeAttribute"),heightAttribute:this.get("heightAttribute"),orientationAttribute:this.get("orientationAttribute"),scale:this.get("scale"),shapeType:this.get("shapeType"),shadingMode:this.get("shadingMode"),renderType:this.get("renderType"),renderMode:this.get("renderMode"),samplingFactor:this.get("samplingFactor"),opacityFactor:this.get("opacityFactor"),switchDistance:this.get("switchDistance"),renderAnchor:this.get("renderAnchor"),anchorLineWidth:this.get("anchorLineWidth"),nbVertices:this.get("nbVertices"),alwaysDisplayText:this.get("alwaysDisplayText")};this._myFactory=new r(this.urban,t),this._myFactory.eventOnVisibilityParent=!0,this._myFactory.rdblink=!1,this.renderingProfileManager=this.urban.getRenderingProfileManager(),this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this._rendering=this._myFactory._rendering,this.renderingProfileManager.initRendering(this);var n=this.get("scale");"number"==typeof n&&(n=new i.Vector3(n,n,n));var s=function(e,t){if(!1!==t){var n,r,s,o=this.get("type");if("json"===o?n=new p:"gml"===o?n=new VectorLoaderGML:"enovia"===o&&(n=new VectorLoaderEnovia(urban)),void 0===this.geojson?(r=n.loadDataSource(e),s=JSON.parse(e),this.set("geojson",s)):(r=n.loadDataSourceFromObject("string"==typeof e?JSON.parse(e):e),this.geojson=void 0,s="string"==typeof e?JSON.parse(e):e,this.set("geojson",e)),0!==(a=r.count)){var a=r.count,d=new m.Feature;this.clusteringMode=!1;for(var l={tile:{LOD:0,I:0,J:0},infos:{}},u=[],g=0;g<a;++g){var v;r.getNextFeature(d),!s.crs||s.crs&&"WGS84"!==s.crs.properties.name?v={x:d.geometry.x,y:d.geometry.y}:(v=D.proj(d.geometry,"WGS84",this.urban.baseProjection),d.geometry.x=v.x,d.geometry.y=v.y);var _,b,y={strid:d.getAttribute(this._myFactory.stridAttribute),tile:{LOD:0,I:0,J:0},posSize:{center:new i.Vector3,altitude:0,height:0,width:0,length:0},userData:{}};for(b=(_=d.getAttributeKeys()).length;b--;)y.userData[_[b]]=d.getAttribute(_[b]);this.userData=y.userData,u.push(y),l.infos[y.strid]=y,this._myFactory.buildOne(d,l,y)}this._poi=this._myFactory.getData(l),this._node.addChild(this._poi),this._node.userData=this._itemParent,this.primInfos=l.infos,this.registerPrimitive=function(e){if(c.is(this._patch)){var t=this.getRendering();c.is(t)&&(t.isPrimitiveRegistered(e)||t.registerPrimitive(this._patch,e))}}.bind(this),this.registerPrimitives=function(e){var t,i,n=Object.keys(e),r=n.length;for(t=0;t<r;t++)i=n[t],this.registerPrimitive(i)}.bind(this),this._patch={register:function(e,t){t(this.primInfos[e])}.bind(this),unregister:function(e,t){},previewMode:!0,_uidListeners:l.infos};var S=function(e){if(e instanceof h&&!0===e.pickable){e.show();var t=e.getPrimitives();if(e.isInstanceNode3D){var i=e.mesh3js.userData.cgmIds;if(void 0!==i)for(var n=i.length-1;n>=0;--n){var r;(r=l.infos[i[n]])&&(r.geom?r.geom.push({mesh:e,subElement:t[0].sgNode}):r.geom=[{mesh:e,subElement:t[0].sgNode}])}}}}.bind(this);this._poi.traverse(S.bind(this)),this._poi.children[0].children[0].userData={records:u},this._setVisible(this._itemParent),f.publish(f.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})}else f.publish(f.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()})}else f.publish(f.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()})}.bind(this),o=function(){if(this._myFactory.isReady&&this._myFactory.isReady()){var e=this.get("url");if(c.is(e)&&""!==e)g.download(void 0,this.urban,s,e);else{var t=this.get("geojson");c.is(t)&&(this.geojson=!0,s(this.get("geojson"),!0))}}else f.subscribeTo("/3DEXPERIENCity/onPostUpdate",o,!0)}.bind(this);return o(),!0},getRendering:function(){return this._rendering},redraw:function(){var e=this.getRendering();c.is(e)&&(e._needRebuild&&this._node.children.length>0&&(this._node.removeChildren(),this.create(this.getRoot())),e.applyRendering(this._poi),e._needRebuild=!1)},setItemParent:function(e){this._itemParent&&(this._itemParent.removeEvent("onChange:name",this._updateName),this._itemParent.removeEvent("onChange:visible",this._setVisible)),this._itemParent=e,e&&(this._itemParent.addEvent("onChange:name",this._updateName,this),this._itemParent.addEvent("onChange:visible",this._setVisible,this))},_updatePosition:function(){this._parent()},_updateName:function(){},_setVisible:function(e){var t=!!e.get("visible");this._poi&&(t?this._node.addChild(this._poi):this._node.removeChild(this._poi))},_select:function(e){var t;if(this._poi)if(e.get("selected")){var r=e.getContent()._node.instanceId,s=e.getContent()._node.children[0].children[0].children[0].mesh3js.userData.cgmIds[(r-5)/5],o=this.bboxes[s];new i.MeshLambertMaterial({color:16777215,side:i.DoubleSide}).force=!0;var h=o.min,d=o.max,l=new i.Vector3;l.subVectors(d,h),l.add(d);var u=b.createRectangleNode({width:d.x-h.x,height:d.y-h.y,fill:!0,color:new _.Color(.5,.2,.5,1)}),c=new a;c.addChild(u),c.setMatrix((new i.Matrix4).setPosition(h)),c.setPickable(_.NOPICKABLE),c.isAreaCluster=!0,this._node.addChild(c),this._bboxNode=c;var g={styleClass:this.get("styleClass"),pClass:"poiText",samplingFactor:this.get("samplingFactor")};(t=n.generateTextNode(this.urban,this._itemParent.get("name"),g))._excludeFromCSO=!0,t._excludeFromHSO=!0,t._excludeFromHL=!0,t._excludeFromPSO=!0,t._excludeFromPreHL=!0;var f=e.getContent().get("position");t.setMatrix((new i.Matrix4).translate(new i.Vector3(f.x,f.y,f.z))),this._node.addChild(t)}else(t=this._node.getChildByName("text"))&&this._node.removeChild(t),this._node.removeChild(this._bboxNode)},get:function(e){var t,i,n=this.getRendering();return this.renderingProfileManager&&c.is(n)&&n.hasAttribute(e)?(i=this.getMaterial(),c.is(i)&&(t=i[e])):t=this._parent(e),t},set:function(e,t){var i={},n=this.getRendering();this.renderingProfileManager&&c.is(n)&&n.hasAttribute(e)?(i[e]=t,this.setMaterial(i)):this._parent(e,t)},setMaterial:function(e){return this.renderingProfileManager.addRendering(this.parentFeatureID,e),this},getMaterial:function(){var e=this.getRendering();return c.is(e)?e.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},getBoundingSphere:function(){if(this._localPosition&&this._node){if(c.is(this._myFactory)&&c.is(this._myFactory.maxMinMax)){var e=this._myFactory.maxMinMax,t=this._node.bSphere.center,n=Math.sqrt(Math.pow(e.maxX-e.minX,2)+Math.pow(e.maxY-e.minY,2)+Math.pow(e.maxZ-e.minZ,2))/2;return new i.Sphere(t,n)}return this._node.getBoundingSphere()}},createPrimitive:function(e,t){var i;this._myFactory&&this._myFactory.getGeoJSON&&(i=this._myFactory.getGeoJSON(e));var n=new s({strid:e,geojson:i,instanceId:t});return n.setLayerVector(this),n.create(this.getRoot()),n.addSubElements(this.primInfos[e]),n},createCluster:function(e,t,n){var r;this._myFactory&&this._myFactory.getGeoJSON&&(r=this._myFactory.getGeoJSON(e));var s=new o({strid:e,geojson:r,instanceId:t,clusterInfo:n});s.setLayerVector(this),s._localPosition=new i.Vector3,s.create(this.getRoot());var a=this._node.children[0].children[0].children[0];return s._subMeshes.push({mesh:a,subElement:a.getPrimitives()}),s._subMeshes.instanceId=t,s},register:function(e){},unregister:function(e){},redrawPrimitive:function(e){if(c.is(this._patch)){var t=this.getRendering();c.is(t)&&(t.isPrimitiveRegistered(e)?t._renderprimitive(e):this.registerPrimitive(e))}},registerPrimitive:function(e){if(c.is(this._patch)){var t=this.getRendering();c.is(t)&&(t.isPrimitiveRegistered(e)||t.registerPrimitive(this._patch,e))}},addUserDataProperty:function(e,t,i){if(c.is(e)){var n=this.get("geojson"),r=n.features[0];if(c.is(i))for(var s=0;s<n.features.length;s++){var o=n.features[s];if(o&&o.properties&&o.properties.STRID===i){r=o;break}}r.properties||(r.properties={}),r.properties[e]=t;var a=this.getUserData();return a||(a={},this.userData=a),a[e]=t,!0}return!1},removeUserDataProperty:function(e,t){if(c.is(e)){var i=this.get("geojson"),n=i.features[0];if(c.is(t))for(var r=0;r<i.features.length;r++){var s=i.features[r];if(s&&s.properties&&s.properties.STRID===t){n=s;break}}c.is(n.properties[e])&&delete n.properties[e];var o=this.getUserData();return c.is(o[e])&&delete o[e],!0}return!1},getTransformedGeoJSON:function(){var e=this.get("Coordinate"),t=this.get("geojson");if(!c.is(e))return t;var n=e.getMatrix();if(n.isIdentity())return t;var r,s=t.features[0].geometry.coordinates,o=new i.Vector3(s[0],s[1],s[2]);o.applyMatrix4(n),r=o.toArray();var a=c.clone(t);return a.features[0].geometry.coordinates=r,a},getBaseAltitude:function(){var e=0,t=this.get("Coordinate");t&&(e+=t.get("position").z);var i=this.get("geojson");return c.is(i)?e+=i.features[0].geometry.coordinates[2]:e},_updateCoordinate:function(){var e=this.previous("Coordinate");e&&e.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")?(this.get("Coordinate").setItemParent(this),this._updateMatrix(this.get("Coordinate")._matrix),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this)):this._updateMatrix()},_updateMatrix:function(e){this._node.setMatrix(e)},toJSON:function(){var e=this._parent(),t=this.get("Coordinate");if(c.is(t)){var i=this.getTransformedGeoJSON();e.geojson=i,e.Coordinate=(new C).toJSON()}return e}});return t.ObjectContructor.SimplePointOfInterest3D=P}),define("DS/UrbanFeature/PointOfView",["UWA/Core","DS/UrbanFeature/Coordinate","DS/XCityModel/Item","DS/Visualization/ThreeJS_DS"],function(e,t,i,n){"use strict";var r=t.extend({defaults:e.merge({length:100,thumbnail:""},t.defaults),metaData:{type:"Location",className:"PointOfView"}});return i.ObjectContructor.PointOfView=r}),define("DS/UrbanFeature/Viewshed",["DS/XCityModel/Item","DS/XCityModel/Folder","DS/UrbanFeature/ViewshedCamera","DS/XCityTools/EventDispatcher"],function(e,t,i,n){"use strict";var r=t.extend({defaults:{colorVisible:"#00ff00",colorNotVisible:"#ff0000",colorOutFrustum:"#ffffff",resolution:4096},metaData:{type:"Viewshed",className:"Viewshed"},setup:function(){this._parent()},create:function(e){if(this.addEvent("onChange:visible",this._visible,this),this.addEvent("onChange:colorVisible",this._updateColors,this),this.addEvent("onChange:colorNotVisible",this._updateColors,this),this.addEvent("onChange:colorOutFrustum",this._updateColors,this),this.addEvent("onChange:resolution",this._updateResolution,this),!this._parent(e))return!1;this._urban=this.getRoot()._urban,this._vse=this._urban.getView3D().getViewshedEffect(),this._updateColors(),this._updateResolution()},_updateResolution:function(){this.get("visible")&&(this._vse.setSize(this.get("resolution"),this.get("resolution"),!0,!0),n.publish("/xCity/needRender",this))},_updateColors:function(){this.get("visible")&&(this._vse.setColors(this.get("colorVisible"),this.get("colorNotVisible"),this.get("colorOutFrustum")),n.publish("/xCity/needRender",this))},getPointOfView:function(){return this.get("PointOfView")},setPointOfView:function(e){return this.set("PointOfView",e)},_visible:function(e){this.get("visible")&&(this._updateColors(),this._updateResolution())}});return e.ObjectContructor.Viewshed=r}),define("DS/UrbanFeature/DataModel",["UWA/Class/Model","UWA/Class","UWA/Ajax","DS/Visualization/Node3D","DS/XCityModel/Item","DS/XCityModel/Folder","DS/XCityModel/RdbLink","DS/UrbanFeature/PointOfView","DS/UrbanFeature/Geometry","DS/XCityModel/GeometrySet","DS/UrbanFeature/Line","DS/XCityModel/LineSet","DS/UrbanFeature/Polygon","DS/XCityModel/PolygonSet","DS/UrbanFeature/BuildingSet","DS/XCityModel/PointOfInterest","DS/UrbanFeature/PointOfInterest3D","DS/XCityModel/PointOfInterest3DSet","DS/UrbanFeature/SimplePointOfInterest3D","DS/UrbanFeature/Coordinate","DS/XCityModel/Feature","DS/UrbanFeature/Bookmark","DS/UrbanFeature/Viewshed","DS/UrbanFeature/ViewshedCamera","DS/UrbanFeature/Annotation","DS/XCityModel/Marker","DS/XCityModel/Terrain","DS/XCityModel/RasterOverlay","DS/XCityModel/Light","DS/UrbanFeature/PointCloud","DS/UrbanFeature/KeyFrameAnimation","DS/UrbanFeature/R2VFeatureState","DS/XCityTools/Debug"],function(e,t,i,n,r,s,o,a,h,d,l,u,c,g,f,p,m,v,_,b,y,S,D,C,P,M,x,I,w,O,R,V,F){"use strict";var L=UWA.Class.extend({init:function(e){this._urban=e},load:function(e,t){if(void 0!==e.pointObjects)for(var i=Object.keys(e.pointObjects),n=0,r=i.length;n<r;n++)this.addPointObjectsLayer(i[n],e.pointObjects[i[n]],t);for(var s=Object.keys(e.models),o=0,a=s.length;o<a;o++)this.addModel(s[o],e.models[s[o]],t)},addModel:function(e,t,i){var n=new b({shifted:t.shifted});t.position&&n.loadJSONVector3(this._urban,"position",t.position);var r=new h(t);r.set("Coordinate",n);var s=new y(t);s.set("name",e),s.set("Content",r),i.addChild(s)},addPointObjectsLayer:function(e,t,i){t.name=e;var n=new y({name:e,id:e}),r=new o;r.loadJSONFactory(this._urban,"factory",t,t),r.loadJSON(this._urban,t,n),void 0!==t.credits&&this._urban.creditor.addCredit("Vectors",t.credits.name,t.credits.providers,t.credits.year),n.set("Content",r),i.addChild(n)}});return s.extend({defaults:s.prototype.defaults,init:function(e){this._parent({id:"_root",name:"Root"}),this._urban=e,this._node3D=new n,this._node3D.name="DataModel",this._root=this,this.create(this._root),this._defaultPath=""},_childAdded:function(e,t){this.dispatchEvent("onAddTree",t);var i=this;t.traverse&&t.traverse(function(e){i.dispatchEvent("onAddTree",e)},!0)},_childRemoved:function(e,t){this.dispatchEvent("onRemoveTree",t);var i=this;t.traverse&&t.traverse(function(e){i.dispatchEvent("onRemoveTree",e)},!0)},loadJSONUrl:function(e,t){var i=this;UWA.Ajax.request(e,{crossDomain:!0,onComplete:function(e){i.loadJSONFile(e),t&&t(e)}})},loadJSONFile:function(e){var t=JSON.parse(e);this.loadJSON(this._urban,t,void 0)},loadJSONList:function(e){new L(this._urban).load(e,this)},getNode3D:function(){return this._node3D},getRoot:function(){return this},addCurrentPointOfView:function(e){var t=this._urban.getViewpoint();t.logPOV(),t=t.get();var i=new y({name:void 0!==e?e:"Point of view",PointOfView:new a({position:t.target,length:t.length,rotation:t.angle})});return this.addChild(i),i},loadModelUrl:function(e,t,i){var n=new h({url:e,extension:i,Shader:{name:"building",uniforms:{normalMap:!0,specularMap:!0}}}),r=new y({name:e});r.set("Content",n),t&&t([r]),this.addChild(r)},createFeaturePrimitive:function(e,t){var i=this.findChildById(e,!0);if(i){var n=new y({name:i.get("name")+" "+t,id:i.get("id")+"_"+t});return n.set("Content",i.get("Content").createPrimitive(t)),n.create(this._urban),n}},addUserEditedFeature:function(e){var t=this.findChildById("user_edited_features");return void 0===t&&(t=new s({name:"User Edited Features",description:"User Edited Features",id:"user_edited_features",visible:!0,opened:!1}),this.addChild(t)),t.addChild(e)}})});