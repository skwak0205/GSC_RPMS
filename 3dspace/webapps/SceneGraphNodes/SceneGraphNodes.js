define("DS/SceneGraphNodes/FixedSizeArrowNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory","DS/Visualization/MaterialApplication"],function(e,t,i,a,r,n,s,o){"use strict";var h=[],d={},l={},c=t.extend({init:function(i){this._parent(i.name),this.matInherit=window.newMaterialInheritance,this._arrowWidth=i.arrowWidth,this._arrowLength=i.arrowLength,this._headLength=i.headLength?i.headLength:this._arrowLength/8,this._headWidth=i.headWidthToHeightRatio?i.headWidthToHeightRatio*this._headLength:this._headLength,this.globalSelection=i.globalSelection,this._color=i.color,this._threeColor=(new e.Color).setRGB(this._color.r,this._color.g,this._color.b),this._head=i.head,this._noZ=!i.removeNoZ,this._pickable=!!i.pickable;new n;var d=new e.Vector3(0,0,1),l=this._noZ?1:0,c=this._arrowLength-this._headLength,u=new t("myFixedSizeNodeG");if(this.globalSelection&&u.setPickParent(!0),this._head){var p=h[this._head],_=a.getWebappsAssetUrl("SceneGraphNodes",""),m=1===this._head?2:1,f=null,g=null,v=function(){};1===this._head?(f=d,g=(new e.Matrix4).rotateX(.5*Math.PI),p||(p=new e.ImageUtils.loadTexture(_+"models/textures/head.png",void 0,v,v,e.ImageUtils.crossOriginPolicy))):3===this._head?p||(p=new e.ImageUtils.loadTexture(_+"models/textures/headSquare.png",void 0,v,v,e.ImageUtils.crossOriginPolicy)):4===this._head?p||(p=new e.ImageUtils.loadTexture(_+"models/textures/headCross.png",void 0,v,v,e.ImageUtils.crossOriginPolicy)):2===this._head&&(p||(p=new e.ImageUtils.loadTexture(_+"models/textures/headDisk.png",void 0,v,v,e.ImageUtils.crossOriginPolicy))),h[this._head]=p,this._updateHeadMaterial();var S={width:this._headWidth,height:this._headLength,fill:!0,color:this._color,noEdge:!0,layerNb:l,material:this._headMaterial,cornerPoint:this._head>=2?new e.Vector2(-this._headWidth/2,-this._headLength/2):new e.Vector2(-this._headWidth/2,0)},x=s.createRectangleNode(S);x.setShadow(!1),x.setFrustumCulled(!1),this.matInherit&&(this._renderableHead=x._occurrences[0].renderable,this._gasHead=this._renderableHead.geometry[0].drawingGroups[0].gas,x.setMaterialApplication(new o({faceMaterial:this._headMaterial,layer:0})),this._headMaterial.useGASColor=!0,this._headMaterial.useGASOpacity=!0,x.setMaterialMode(!0)),this._pickable||x.setPickable(r.NOPICKABLE),this.globalSelection&&x.setPickParent(!0),x.name="Arrow's head";var w=new t("billBoardNode");this.globalSelection&&w.setPickParent(!0),w.addChild(x),w._setBillboardData(m,f,g);var M=new t("myFixedSizeNode");this.globalSelection&&M.setPickParent(!0),M.addChild(w),M._setFixedSizeCenter((new e.Vector3).copy(d).multiplyScalar(c/d.length()),1),u.addChild(M)}else c=this._arrowLength;this._updateBodyMaterial();var b={points:[new e.Vector3(0,0,0),new e.Vector3(0,0,c)],color:this._color,material:this._bodyMaterial,layerNb:l,width:this._arrowWidth},y=s.createLineNode(b);return y.setShadow(!1),y.setFrustumCulled(!1),this.globalSelection&&y.setPickParent(!0),this.matInherit&&(this._renderableBody=y._occurrences[0].renderable,this._gasBody=this._renderableBody.geometry[0].drawingGroups[0].gas,y.setMaterialMode(!1)),this._pickable||y.setPickable(r.NOPICKABLE),y.name="Arrow's body",u.addChild(y),u._setRatio(1),this.addChild(u),this},_updateHeadMaterial:function(){var t=this._threeColor.getHexString()+"_"+this._head;this._headMaterial=d[t],this._headMaterial||(this._headMaterial=new e.MeshBasicMaterial({map:h[this._head],side:e.DoubleSide,transparent:!0,alphaTest:.05,color:this._threeColor,force:!this.matInherit}),d[t]=this._headMaterial)},_updateBodyMaterial:function(){var t=this._threeColor.getHexString()+"_"+this._head+"_"+this._arrowWidth;this._bodyMaterial=l[t],this._bodyMaterial||(this._bodyMaterial=new e.LineBasicMaterial({side:e.DoubleSide,color:this._threeColor,force:!this.matInherit,linecap:"butt",lineWidth:this._arrowWidth}),l[t]=this._bodyMaterial)},setColor:function(e){this._color.copy(e),this._threeColor.setRGB(e.r,e.g,e.b),this._updateHeadMaterial(),this._updateBodyMaterial(),this.matInherit&&(this._gasHead.setParameters({colorRGB:this._threeColor}),this._gasBody.setParameters({colorRGB:this._threeColor}),this._renderableHead._flagAsGSSOInvalidated(),this._renderableBody._flagAsGSSOInvalidated())},setName:function(e){this._name=e},getNodeType:function(){return"FixedSizeArrowNode"}});return c.types={NONE:null,ARROW:1,DISK:2,SQUARE:3,CROSS:4},UWA.namespace("THREEDS/Nodes/FixedSizeArrowNode",c)}),define("SceneGraphNodes/FixedSizeArrowNode",["DS/SceneGraphNodes/FixedSizeArrowNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/FixedSizeArrowNode"),e}),define("DS/SceneGraphNodes/SphereLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var a=new e.SphereLight(t.color,t.intensity,t.radius,t.mode);return this._radius=a.radius,this._parent(a,i),this},setRadius:function(e){e&&(this._radius=e),this._updateRadius()},_updateRadius:function(){var e;this.light3js.radius=this._radius,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.radius=this._radius},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"SphereLightNode3D"}});return UWA.namespace("THREEDS/Nodes/SphereLight",i)}),define("SceneGraphNodes/SphereLightNode",["DS/SceneGraphNodes/SphereLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/SphereLightNode"),e}),define("DS/SceneGraphNodes/CSSSVGNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/SVGLoader/SVGToNode3D","DS/Visualization/GetSVGMode"],function(e,t,i,a,r){"use strict";return t.extend({init:function(e,t,n){if(this._parent(t),this._webGLMode=r.getWebGLMode(),this._webGLMode){var s=new a(e).buildNode3D();this.addChild(s),this._cssSVGNode=!0,this.setPickable(i.PICKTHROUGH)}else{this._gNode=document.createElementNS(n.getSvgNS(),"g"),this._gNode.svgV6Node=this,this._gNode.appendChild(e),this.exludeFromBounding(!0),this.forbidChildren=!0;var o=this._occurrences[0],h=this.createRenderable();o.renderable=h,o.renderable.name=this.name,o.renderable._occurrence=o,this._cssSVGNode=!0,this.viewer=n,this._updateSVGVisibility()}},setVisibility:function(e){if(this._webGLMode)return this._parent.apply(this,arguments);this._setVisible(!!e),this._updateSVGVisibility()},setVisibilityFree:function(e){if(this._webGLMode)return this._parent.apply(this,arguments);this._setVisibilityFree(!!e),this._updateSVGVisibility()},getNodeType:function(){return this._webGLMode?this._parent.apply(this,arguments):"CSSSVGNode"},createRenderable:function(){if(this._webGLMode)return this._parent.apply(this,arguments);var t=new e.CSSSVGNode(this._gNode);return t.matrixAutoUpdate=!1,t.matrixWorldNeedsUpdate=!1,t.pickable=!1,t},addChild:function(){if(this._webGLMode)return this._parent.apply(this,arguments)},_updateSVGVisibility:function(){var e;this._webGLMode||(e=this._getVisibilityFree()?this._getVisible():this.viewer.visibleSpace?this._getVisible():!this._getVisible(),this._gNode.setAttributeNS(null,"visibility",e?"visible":"hidden"))},_onLinkedToSceneGraph:function(){if(this._webGLMode)return this._parent.apply(this,arguments);this.viewer.svgRoot.appendChild(this._gNode)},_onUnlinkedToSceneGraph:function(){if(this._webGLMode)return this._parent.apply(this,arguments);this.viewer.svgRoot.removeChild(this._gNode)}})}),define("DS/SceneGraphNodes/InstancedCylinderImpostorsNode",["DS/AdvancedSceneGraphNodes/InstancedCylinderImpostorsNode","DS/DSMigration/DSMigration"],function(e,t){return e}),define("DS/SceneGraphNodes/InstancedSphereImpostorsNode",["DS/AdvancedSceneGraphNodes/InstancedSphereImpostorsNode","DS/DSMigration/DSMigration"],function(e,t){return e}),define("DS/SceneGraphNodes/CSS3DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i,a){this._parent(a),this.scale=i||1,this.css3DNode=new e.CSS3DNode(t);var r=this.createRenderable(),n=t.style.width;n=n.substring(0,n.length-2);var s=t.style.height;s=s.substring(0,s.length-2);var o=.5*i*Math.sqrt(n*n+s*s);this.hasExplicitBE=!0,this.explicitBSphere=new e.Sphere(new e.Vector3(0,0,0),o),this.explicitBBox=null,r.matrixAutoUpdate=!1,r.visible=this.css3DNode.visible;var h=this._occurrences[0];return h.renderable=r,h.renderable.name=this.name,h.renderable._occurrence=h,h.renderable.scaleCSS=(new e.Matrix4).scale(new e.Vector3(this.scale,this.scale,this.scale)),document.getElementById("camera")&&document.getElementById("camera").appendChild(this.css3DNode.element),this},createRenderable:function(){var t=new e.CSS3DNode(this.css3DNode.element);return t.matrixAutoUpdate=!1,t.matrixWorldNeedsUpdate=!1,t.pickable=!0,t.visible=this.css3DNode.visible,t},setPickability:function(e){this.css3DNode.element.style.pointerEvents=e?"auto":"none"},add:function(){return!1},getNodeType:function(){return"CSS3DNode"},clone:function(){var t=new e.CSS3DNode(this.css3DNode.element);return new THREEDS.Nodes.CSS3DNode(t.element,this.name)}});return UWA.namespace("THREEDS/Nodes/CSS3DNode",i)}),define("SceneGraphNodes/CSS3DNode",["DS/SceneGraphNodes/CSS3DNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/CSS3DNode"),e}),define("DS/SceneGraphNodes/DirectionalLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){t||(t={});var a=new e.DirectionalLight(t.color,t.intensity);return a._sceneShadow=null==t.sceneShadow||t.sceneShadow,t.target?(a.target=new e.Object3D,a.target.position=t.target,a._sceneShadow=!1):a.target=null,this._previousTarget=a.target,this._parent(a,i,null),this},castShadows:function(e,t){var i=this._occurrences.length;if(e){if(this.light3js.castShadow=!0,t){var a=!1,r=null!=t.sceneShadow?t.sceneShadow:this.light3js._sceneShadow;t.bias&&(this.light3js.shadowBias=t.bias),t.left&&(this.light3js.shadowCameraLeft=t.left,r=!1),t.right&&(this.light3js.shadowCameraRight=t.right,r=!1),t.bottom&&(this.light3js.shadowCameraBottom=t.bottom,r=!1),t.top&&(this.light3js.shadowCameraTop=t.top,r=!1),t.near&&(this.light3js.shadowCameraNear=t.near,r=!1),t.far&&(this.light3js.shadowCameraFar=t.far,r=!1),t.darkness&&(this.light3js.shadowDarkness=t.darkness),t.mapWidth&&(this.light3js.shadowMapWidth=t.mapWidth,a=!0),t.mapHeight&&(this.light3js.shadowMapHeight=t.mapHeight,a=!0),this.light3js._sceneShadow=r,this.light3js.shadowMap&&a&&(this.light3js.shadowMap.dispose(),this.light3js.shadowMap=null,this.light3js.updateShadowMap=!0)}for(var n=0;n<i;n++){var s=this._occurrences[n].renderable;if(s.castShadow=!0,t){a=!1;t.bias&&(s.shadowBias=t.bias),t.left&&(s.shadowCameraLeft=t.left),t.right&&(s.shadowCameraRight=t.right),t.bottom&&(s.shadowCameraBottom=t.bottom),t.top&&(s.shadowCameraTop=t.top),t.near&&(s.shadowCameraNear=t.near),t.far&&(s.shadowCameraFar=t.far),t.darkness&&(s.shadowDarkness=t.darkness),t.mapWidth&&(s.shadowMapWidth=t.mapWidth,a=!0),t.mapHeight&&(s.shadowMapHeight=t.mapHeight,a=!0),s._sceneShadow=this.light3js._sceneShadow,s.shadowMap&&a&&(s.shadowMap.dispose(),s.shadowMap=null,s.updateShadowMap=!0)}}}else{this.light3js.castShadow=!1;for(n=0;n<i;n++)this._occurrences[n].renderable.castShadow=!1}},attachToViewpoint:function(e){if(this._attachedToVpt!=e){var t=this._occurrences.length;if(e){this.light3js.target=null;for(i=0;i<t;i++)this._occurrences[i].renderable.target=null}else{this.light3js.target=this._previousTarget;for(var i=0;i<t;i++)this._occurrences[i].renderable.target=this._previousTarget}}this._attachedToVpt=e},setTarget:function(t){var i=null;t&&((i=new e.Object3D).position=t);if(this.light3js.target=i,this._previousTarget=i,!this._attachedToVpt)for(var a=this._occurrences.length,r=0;r<a;r++)this._occurrences[r].renderable.target=i},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"DirectionalLightNode3D"}});return UWA.namespace("THREEDS/Nodes/DirectionalLight",i)}),define("SceneGraphNodes/DirectionalLightNode",["DS/SceneGraphNodes/DirectionalLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/DirectionalLightNode"),e}),define("DS/SceneGraphNodes/PolyLineSectionUtils",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t={makeClosedPolyLine:function(t,i,a){var r=new e.Vector3;r.subVectors(i.center,t.planeOrigin);var s,o,h=new e.Vector2(r.dot(t.planeU),r.dot(t.planeV)),d={xmin:h.x-i.radius,ymin:h.y-i.radius,xmax:h.x+i.radius,ymax:h.y+i.radius};for(s=0;s<t.polyLinePoints.length;s++)(o=t.polyLinePoints[s]).x<d.xmin&&(d.xmin=o.x),o.x>d.xmax&&(d.xmax=o.x),o.y<d.ymin&&(d.ymin=o.y),o.y>d.ymax&&(d.ymax=o.y);return new n(d,t,a).buildPolyLine()}};function i(t,i,a,r){var n=new e.Vector2;n.subVectors(i,t);var s=new e.Vector2;return s.subVectors(a,r),function(t,i,a,r){var n=i.y,s=-i.x,o=i.x*t.y-i.y*t.x,h=r.y,d=-r.x,l=r.x*a.y-r.y*a.x,c=n*d-s*h;if(0===c)return null;var u=(s*l-o*d)/c,p=-(n*l-o*h)/c;return new e.Vector2(u,p)}(t,n,a,s)}function a(t,i,a){var r=new e.Vector2;r.subVectors(i,t);var n=new e.Vector2;return n.subVectors(a,t),r.dot(n)>=0}function r(t,i,a){var r=new e.Vector2;r.subVectors(i,t);var n=new e.Vector2;n.subVectors(a,t);var s=r.dot(n),o=r.lengthSq();return s>=0||s<=o}var n=function(t,i,a){this.bounds=t,this.points=[],this.normalExtrapolation=a,this.center=new e.Vector2((this.bounds.xmin+this.bounds.xmax)/2,(this.bounds.ymin+this.bounds.ymax)/2),this.polyLine=i;var r,n=[new e.Vector2(this.bounds.xmin,this.bounds.ymin),new e.Vector2(this.bounds.xmin,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymin)];for(r=0;r<n.length;r++)this.addPoint(n[r],"corner")};return n.prototype.addPointFromLine=function(t,n,s,o,h){var d=t,l=n;o&&(d=n,l=new e.Vector2(n.x+h*(t.y-n.y),n.y-h*(t.x-n.x)));var c,u=!1,p=null,_=[new e.Vector2(this.bounds.xmin,this.bounds.ymin),new e.Vector2(this.bounds.xmin,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymin),new e.Vector2(this.bounds.xmin,this.bounds.ymin)];for(c=0;c<_.length-1&&!u;c++)(p=i(d,l,_[c],_[c+1]))&&a(d,l,p)&&r(_[c],_[c+1],p)&&(this.addPoint(p,s),u=!0)},n.prototype.addPoint=function(t,i){var a,r,n,s=new e.Vector2;s.subVectors(t,this.center),s.normalize();var o={point:t,angle:a=(s.y>=0?-1:1)*Math.acos(s.x),tag:i};for(r=0;r<this.points.length&&!n;r++)this.points[r].angle<a&&(this.points.splice(r,0,o),n=!0);n||this.points.push(o)},n.prototype.buildPolyLine=function(){var t=this.polyLine;this.addPointFromLine(new e.Vector2(t.polyLinePoints[1].x,t.polyLinePoints[1].y),new e.Vector2(t.polyLinePoints[0].x,t.polyLinePoints[0].y),"start",this.normalExtrapolation,-1);var i=t.polyLinePoints.length;this.addPointFromLine(new e.Vector2(t.polyLinePoints[i-2].x,t.polyLinePoints[i-2].y),new e.Vector2(t.polyLinePoints[i-1].x,t.polyLinePoints[i-1].y),"end",this.normalExtrapolation,1);var a,r=-1,n=-1;for(a=0;a<this.points.length&&(r<0||n<0);a++)"start"===this.points[a].tag&&(r=a),"end"===this.points[a].tag&&(n=a);if(r<0||n<0)return null;var s={polyLinePoints:[],planeOrigin:t.planeOrigin,planeU:t.planeU,planeV:t.planeV};s.polyLinePoints.push(this.points[r].point);var o=this.normalExtrapolation?0:1;for(a=o;a<t.polyLinePoints.length-o;a++)s.polyLinePoints.push(new e.Vector2(t.polyLinePoints[a].x,t.polyLinePoints[a].y));s.polyLinePoints.push(this.points[n].point);var h=r<n?r+this.points.length:r;for(a=n+1;a<h;a++)s.polyLinePoints.push(this.points[a%this.points.length].point);return s},UWA.namespace("THREEDS/Nodes/PolyLineSectionUtils",t)}),define("DS/SceneGraphNodes/PointLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){t||(t={});var a=t.intensity;void 0===a&&(a=t.power?t.power/(4*Math.PI):1);var r=new e.PointLight(t.color,a,t.distance);return t.physicalAttenuation&&(r.isPhysicallyAttenuated=!0,r.attenuationScale=t.attenuationScale?t.attenuationScale:1e-6),this._parent(r,i,null),this},setPower:function(e){var t=e/(4*Math.PI);this.setIntensity(t)},setPhysicalAttenuation:function(e){this.light3js.isPhysicallyAttenuated=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.isPhysicallyAttenuated=e},setPhysicalAttenuationScale:function(e){this.light3js.attenuationScale=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.attenuationScale=e},castShadows:function(e,t){var i=this._occurrences.length;if(e){if(this.light3js.castShadow=!0,t){var a=!1;t.bias&&(this.light3js.shadowBias=t.bias),t.near&&(this.light3js.shadowCameraNear=t.near),t.far&&(this.light3js.shadowCameraFar=t.far),t.darkness&&(this.light3js.shadowDarkness=t.darkness),t.mapWidth&&(this.light3js.shadowMapWidth=t.mapWidth,a=!0),t.mapHeight&&(this.light3js.shadowMapHeight=t.mapHeight,a=!0),this.light3js.shadowMap&&a&&(this.light3js.shadowMap.dispose(),this.light3js.shadowMap=null,this.light3js.updateShadowMap=!0)}for(var r=0;r<i;r++){var n=this._occurrences[r].renderable;if(n.castShadow=!0,t){a=!1;t.bias&&(n.shadowBias=t.bias),t.near&&(n.shadowCameraNear=t.near),t.far&&(n.shadowCameraFar=t.far),t.darkness&&(n.shadowDarkness=t.darkness),t.mapWidth&&(n.shadowMapWidth=t.mapWidth,a=!0),t.mapHeight&&(n.shadowMapHeight=t.mapHeight,a=!0),n.shadowMap&&a&&(n.shadowMap.dispose(),n.shadowMap=null,n.updateShadowMap=!0)}}}else{this.light3js.castShadow=!1;for(r=0;r<i;r++)this._occurrences[r].renderable.castShadow=!1}},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"PointLightNode3D"}});return UWA.namespace("THREEDS/Nodes/PointLight",i)}),define("SceneGraphNodes/PointLightNode",["DS/SceneGraphNodes/PointLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/PointLightNode"),e}),define("DS/SceneGraphNodes/VoxelVolumeNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";return t.extend({init:function(e,t){return this._parent(t),this.debugMode=!0,e&&this.build(e),this},add:function(){return!1},_nextPowerOf2:function(e,t){for(var i=t||1;i<e;)i*=2;return i},build:function(t){var i,a,r=t.voxelRep,n=(performance.now(),[r.width,r.height,r.depth]),s=new e.Vector3(n[0],n[1],n[2]),o=Math.max(s.x,Math.max(s.y,s.z)),h=this._nextPowerOf2(o,4),d=this._nextPowerOf2(Math.ceil(Math.sqrt(h))),l=h*d,c=null,u=r.bufferData,p=n[0]*n[1]*n[2],_=p%8?Math.floor(p/8)+1:p/8,m=_+(4-_%4)%4;i=(a=new Uint8Array(u.buffer,u.byteOffset+m))[0];var f=0,g=null;if(this.debugMode){g=new Uint32Array(256);for(var v=0;v<256;v++)g[v]=0}c=new Uint8Array(l*l);for(var v=0;v<l*l;v++)c[v]=i;var S=0,x=0,w=0,M=0,b=0,y=[1,2,4,8,16,32,64,128],D=i>0?i:Number.MAX_SAFE_INTEGER,T=i>0?i:0;for(v=0;v<_/4;v++)for(var N=3;N>=0;N--)for(var P=u[4*v+N],A=7;A>=0;A--){if(P&y[A]){var C=a[1+b++],V=(Math.floor(w/d)*h+x)*h*d+w%d*h+S;c[V]=C,C>0&&(C<D&&(D=C),C>T&&(T=C)),this.debugMode&&(g[C]++,f++)}if(++M>=p)break;++S>=n[0]&&(S=0,++x>=n[1]&&(x=0,w++))}this.debugMode&&(g[i]+=n[0]*n[1]*n[2]-f),this.volumeData={tileSetRange:{min:0,max:1},valueRange:{min:D/255,max:T/255},voxelRepartition:g,mapData:{type:"uint8",data:c,width:l,height:l},chunkSize:h,nbCol:d,mapDim:s,_voxelDensity:0}},getNodeType:function(){return"VoxelVolumeNode"}})}),define("DS/SceneGraphNodes/AreaLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var a=new e.AreaLight(t.color,t.intensity,t.width,t.height,t.mode);return this._areaWidth=a.width,this._areaHeight=a.height,this._parent(a,i),this},attachToViewpoint:function(e){return null},setAreaSize:function(e,t){e&&(this._areaWidth=e),t&&(this._areaHeight=t),this._updateAreaSize()},_updateAreaSize:function(){var e,t;this.light3js.width=this._areaWidth,this.light3js.height=this._areaHeight,e=this._occurrences.length;for(var i=0;i<e;i++)(t=this._occurrences[i]).renderable.width=this._areaWidth,t.renderable.height=this._areaHeight},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"AreaLightNode3D"}});return UWA.namespace("THREEDS/Nodes/AreaLight",i)}),define("SceneGraphNodes/AreaLightNode",["DS/SceneGraphNodes/AreaLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/AreaLightNode"),e}),define("DS/SceneGraphNodes/BillBoardNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],function(e,t,i){"use strict";var a,r,n,s,o,h,d,l=new e.Projector,c=new e.Vector3,u=new e.Matrix4,p=new e.Matrix4,_=new e.Matrix4,m=e.__visibleInCurrentSpace,f=t.extend({init:function(t){this._parent(t.name),this._isDynamic=!0,this.BillBoardType=t.type,this.constraintAxis=null,t.constraintAxis&&(this.constraintAxis=t.constraintAxis.clone()),t.attachedPoint&&(this.attachedPoint=t.attachedPoint.clone());var i=this,a=e.NoOccurrences;return this.cbChange=function(e){var t;if(!a)if(i.isInstance())for(var r=0;r<i._occurrences.length;r++){var n=(l=i._occurrences[r]).parent;if(l.scene3js){var s=l.scene3js.viewer;if(m(l._getVisible(),l._getVisibilityFree(),s.getVisibleSpace(),null,l)){if(e&&e.viewpoint&&e.viewpoint.viewer&&s!==e.viewpoint.viewer)continue;var o=s.currentViewpoint;t=i._getDynamicMatrix(n.matrix,e,o),l.matrix.multiplyMatrices(n.matrix,t);for(var h=0;h<l.children.length;h++)i._updateOccurrences(l,l.children[h],!0)}}}else{var d=i.parents[0];if(d){var l;if(!(l=d._occurrences[0]).scene3js)return;s=l.scene3js.viewer;if(m(l._getVisible(),l._getVisibilityFree(),s.getVisibleSpace(),null,l)){if(e&&e.viewpoint&&e.viewpoint.viewer&&s!==e.viewpoint.viewer)return;o=s.currentViewpoint;t=i._getDynamicMatrix(d.getMatrixWorld(),e,o),i.setMatrix(t)}}}},this.tokenChange=null,this},isPointOfViewDependant:function(){return!0},_onLinkedToSceneGraph:function(){var e=this;this.tokenChange=i.subscribe({event:"/VISU/"},function(t){"@onViewpointChange"===t.eventType&&e.cbChange(t)})},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenChange)},setBillboardType:function(e){this.BillBoardType=e,this.cbChange()},getNodeType:function(){return"BillBoardNode3D"},_getDynamicMatrix:function(e,t,i){e||(u.identity(),e=u);var a=(i||t.viewpoint).camera,r=a.getLookAt();return r.add(a.position),_.identity(),_.extractRotation(e),"Spherical"===this.BillBoardType?(p.identity(),p.lookAt(a.position,r,a.up)):this._ComputeCylindricalTransform(a,a.position,r,e,"PseudoSpherical"===this.BillBoardType),u.getInverse(_),_.multiplyMatrices(u,p),this._matrix&&_.setPosition(c.getPositionFromMatrix(this._matrix)),_},_ComputeCylindricalTransform:(a=new e.Vector3,r=new e.Vector3,n=new e.Vector3,s=new e.Vector3,o=new e.Vector3,h=new e.Vector3,d=new e.Vector3,function(e,t,i,c,u){if(this.constraintAxis?r.copy(this.constraintAxis).transformDirection(c).normalize():r.set(c.elements[8],c.elements[9],c.elements[10]).normalize(),u){d.getPositionFromMatrix(c),a.subVectors(d,t),h.addVectors(d,r);var _=d.clone();l.projectVector(_,e),l.projectVector(h,e),h.z=_.z,l.unprojectVector(h,e),h.sub(d),h.normalize(),r.copy(h)}else a.subVectors(i,t);if(a.normalize(),n.crossVectors(a,r),n.lengthSq()<1e-10){var m=Math.abs(a.z)<.999?o.set(0,0,1):o.set(1,0,0);n.crossVectors(m,a)}return n.normalize(),s.crossVectors(r,n),s.normalize(),p.set(n.x,s.x,r.x,0,n.y,s.y,r.y,0,n.z,s.z,r.z,0,0,0,0,1),p}),setConstraintAxis:function(e){this.constraintAxis=e}});return UWA.namespace("THREEDS/Nodes/BillBoard",f)}),define("SceneGraphNodes/BillBoardNode3D",["DS/SceneGraphNodes/BillBoardNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/BillBoardNode3D"),e}),define("DS/SceneGraphNodes/CanvasNodeTexture",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils"],function(e,t,i,a){"use strict";var r=["map","transparent","alphaTest","force","canvasNodeTextureSize","canvasNodeTextureSaveParams"],n=!0,s=t.extend({init:function(e){this.width=e.width,this.height=e.height,this.longestEdge=this.width>=this.height?"width":"height",this.maxZoom=e.maxZoom||null,this.maxPow=this.maxZoom?Math.floor(Math.log(this.maxZoom)/Math.log(2)):null,this.drawCB=e.drawCB,this.rectangleTexture=e.rectangleTexture||!1,this.viewer=e.webGLV6Viewer,this.alphaTest=e.alphaTest,this.depthWrite=e.depthWrite,this.tick=0,this.materials={},this.lastTexture=null,this._canvas2DTexture=null,this._canvas2DCanvas=null,this.setMaterialParams(e.materialParams)},setMaterialParams:function(e){var t;for(t in this.materialParams=e||{},this.materials)this._updateMaterialWithParams(this.materials[t].material,this.materialParams)},requestRedraw:function(){this._requestRedraw()},_updateMaterialWithParams:function(e,t){var i;if(e.canvasNodeTextureSaveParams)for(i in e.canvasNodeTextureSaveParams)e[i]=e.canvasNodeTextureSaveParams[i];for(i in t)-1===r.indexOf(i)&&(e.canvasNodeTextureSaveParams||(e.canvasNodeTextureSaveParams={}),e.canvasNodeTextureSaveParams[i]=e[i],e[i]=t[i])},startAnimation:function(e,t){this.animationDeltaTime=e,this.tick=-1,this._animationStep(t)},_animationStep:function(e){this.tick++,this.requestRedraw(),e&&e.render(),setTimeout(this._animationStep.bind(this,e),this.animationDeltaTime)},_requestRedraw:function(){var e;for(e in this.materials)this.materials[e].redrawRequested=!0;this._canvas2DTexture&&(this._canvas2DTexture.redrawRequested=!0)},_getCanvas2DTexture:function(){if(!this._canvas2DTexture){var t=document.createElement("canvas");t.width=this.width,t.height=this.height,this._canvas2DTexture=new e.Texture(t,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter),this._canvas2DCanvas=t,this._redrawCanvas2DTexture()}return this._canvas2DTexture},_redrawCanvas2DTexture:function(){this._drawToCanvas(this._canvas2DCanvas,this.width,this.height),this._canvas2DTexture.needsUpdate=!0,this._canvas2DTexture.redrawRequested=!1},_buildMaterial:function(t,i,a,r){var n={};return n.canvas=document.createElement("canvas"),n.canvas.width=i,n.canvas.height=a,s.totalAllocatedTextures+=n.canvas.width*n.canvas.height,n.useCount=0,this._drawToCanvas(n.canvas,i,a),n.texture=new e.Texture(n.canvas,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearMipMapLinearFilter),n.texture.anisotropy=16,n.texture.needsUpdate=!0,r?(r.map=n.texture,e.cleanDeferredCache(r.id),r.updateDeferredMaterials(),n.material=r):n.material=new e.MeshBasicMaterial({transparent:!0,force:!0,map:n.texture}),void 0!==this.alphaTest&&(n.material.alphaTest=this.alphaTest),void 0!==this.depthWrite&&(n.material.depthWrite=this.depthWrite),n.material.canvasNodeTextureSize=t,this._updateMaterialWithParams(n.material,this.materialParams),n.redrawRequested=!1,n},_drawToCanvas:function(e,t,i){var a=e.getContext("2d");a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,t,i),a.globalAlpha=1;var r=Math.max(t,i)/Math.max(this.width,this.height);a.scale(r,r);var n=null;this.viewer&&this.viewer.renderer&&this.viewer.renderer.renderer&&(n=this.viewer.renderer.renderer),this.drawCB(this,a,this.tick,r,n)},_getNewMaterial:function(e,t){var i=t&&t.canvasNodeTextureSize?t:null,a=e,r=11;null!==this.maxPow&&(r=this.maxPow);if(this.rectangleTexture&&(a=e/this[this.longestEdge],null===this.maxPow)){var o=Math.ceil(Math.log(this[this.longestEdge])/Math.log(2)+.01024);r=Math.max(0,r-o)}var h=Math.ceil(Math.log(a)/Math.log(2)+.01024);h=Math.min(h,r);var d=Math.pow(2,h),l=this.rectangleTexture?Math.floor(d*this.width):d,c=this.rectangleTexture?Math.floor(d*this.height):d;0!==l&&0!==c||(l=16,c=16);var u=i?this.materials[i.canvasNodeTextureSize]:null,p=u?u.canvas.width:0,_=u?u.canvas.height:0;!this.materials[d]&&s.totalAllocatedTextures+l*c-p*_>s.maxAllocatedTextures&&(n&&console.warn("CanvasNodeTexture: max amount of allowed texture allocation has been exceeded"),u?(d=i.canvasNodeTextureSize,l=u.canvas.width,c=u.canvas.height):(d=this.rectangleTexture?1:512,l=this.rectangleTexture?this.width:d,c=this.rectangleTexture?this.height:d));var m,f=this.materials[d];return i&&i.canvasNodeTextureSize===d||(i&&(m=this._releaseMaterial(i)),f||(this.materials[d]=this._buildMaterial(d,l,c,m),f=this.materials[d]),f.useCount++,m&&f.material!==m&&m.dispose()),f&&f.redrawRequested&&(this._drawToCanvas(f.canvas,l,c),f.texture.needsUpdate=!0,f.redrawRequested=!1),f?f.material:null},_releaseMaterial:function(e){if(e.canvasNodeTextureSize){var t=e?this.materials[e.canvasNodeTextureSize]:null;if(t)if(t.useCount--,t.useCount<=0)return s.totalAllocatedTextures-=t.canvas.width*t.canvas.height,(e=this.materials[e.canvasNodeTextureSize].material).map&&(e.map.dispose(),e.map=null),delete this.materials[e.canvasNodeTextureSize],e}return null}});return s.totalAllocatedTextures=0,s.maxAllocatedTextures=16777216,s.enableMemoryWarning=function(e){n=e},s}),define("DS/SceneGraphNodes/Canvas2DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils"],function(e,t,i,a){"use strict";var r=t.extend({init:function(t,i){this._parent(t.name),this.hotspot=t.hotspot||new e.Vector2(0,0),this.canvasNodeTexture=t.canvasNodeTexture;var a=this.canvasNodeTexture._getCanvas2DTexture(),n=new e.MeshBasicMaterial({transparent:!0,side:e.DoubleSide,force:!0});this.canvas2DMaterial=n,n.activatePDSFX();var s={hotspot:{type:"v2",value:this.hotspot},pixelSize:{type:"v2",value:new e.Vector2(.005,.005)},size:{type:"v2",value:new e.Vector2(this.canvasNodeTexture.width,this.canvasNodeTexture.height)},canvas2DTexture:{type:"t2",value:a},highlight:{type:"b",value:!1,stage:e.FragmentStage},angle:{type:"f",value:t.angle||0},alphaTest:{type:"f",value:this.canvasNodeTexture.alphaTest||-1}};n.setPDSFXUniforms(s);n.setPDSFXVaryings({_uv:{type:"v2"},screenPosition:{type:"v2"}});var o={ProcessClipSpacePosition:["void ProcessClipSpacePosition(inout vec4 ioPosition) { ","  _uv = vGetAttribTexCoord0().xy;","  float dx, dy;","  dx = ioPosition.w * (pixelSize.x*(-hotspot.x + _uv.x*size.x));","  dy = ioPosition.w * (pixelSize.y*(-hotspot.y + _uv.y*size.y));;","  float ratio = pixelSize.x / pixelSize.y;","  ioPosition.x += cos(angle)*dx - sin(angle)*dy*ratio;","  ioPosition.y += sin(angle)*dx/ratio + cos(angle)*dy;","}"].join("\n")},h={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = texture2D(canvas2DTexture, _uv);","if (highlight) {","  float norm = length(ioFinalColor.xyz);","  ioFinalColor.xyz = (norm/1.73205)*vec3(0.0, 0.6, 1.0);","}","}"].join("\n"),ComputeDiscard:["bool ComputeDiscard() {","  vec4 color = texture2D(canvas2DTexture, _uv);","  return color.a <= alphaTest;","}"].join("\n"),ComputeViewNormal:"vec3 ComputeViewNormal() { return vec3(0.0,0.0,1.0); }"};n.setPDSFXOverridableFunctions(o,h),this.rectangle=r._createRectangle(n,i);this.rectangle._occurrences[0].renderable;n._refreshPDSFXUniforms_private=function(t,i){var a;if(!t._smallTargetPicking||t.materialToUse!==e.MaterialToUse.pickingMaterial&&t.materialToUse!==e.MaterialToUse.pickingMaterialInstancing&&t.materialToUse!==e.MaterialToUse.normalMaterial&&t.materialToUse!==e.MaterialToUse.depthMaterial)a=new e.Vector2(2/t.domElement.width,2/t.domElement.height);else{var r=2*t._gpuPickingTolerance+1;a=new e.Vector2(2/r,2/r)}this.updatePDSFXUniform("pixelSize",a)},this.rectangle.setFrustumCulled(!1),this.rectangle.setMirror(!1),this.rectangle.setShadow(!1,!1),this.addChild(this.rectangle),this.rectangle.setRenderPasses(["canvas2D"]),this.exludeFromBounding(!0);var d=this;return this.rectangle._setBeforeRenderCB(function(e,t){a.redrawRequested&&d.canvasNodeTexture._redrawCanvas2DTexture()}),this},excludeFromHighlight:function(e,t){this.rectangle.excludeFromHighlight(e,t)},setHotspot:function(e){e&&this.canvas2DMaterial.updatePDSFXUniform("hotspot",e.clone())},getHotspot:function(){return this.canvas2DMaterial.getPDSFXUniform("hotspot").value.clone()},setAngle:function(e){this.canvas2DMaterial.updatePDSFXUniform("angle",e)},getAngle:function(){return this.canvas2DMaterial.getPDSFXUniform("angle").value}});return r._createRectangle=function(e,t){var i,r,n,s,o,h,d,l,c,u,p,_,m,f,g;for(10,(i=new a.PrimitiveGroup).fillAttr=new a.FillAttributes,i.lineAttr=new a.LineAttributes,i.pointAttr=new a.PointAttributes,(r=new a.Buffer).size=12,r.component=a.VertexComponentEnum.POSITION,r.format=a.DataTypeEnum.FLOAT,r.dimension=3,r.data=new Float32Array(r.size),(n=new a.Buffer).size=3,n.component=a.VertexComponentEnum.NORMAL,n.format=a.DataTypeEnum.FLOAT,n.dimension=3,n.data=new Float32Array(n.size),(s=new a.Buffer).size=12,s.component=a.VertexComponentEnum.TEX_COORD_0,s.format=a.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(s.size),(o=new a.Buffer).indexBuffer=!0,o.size=4,o.format=a.DataTypeEnum.UINT,o.dimension=1,o.data=new Uint16Array(o.size),(h=new a.Buffer).indexBuffer=!0,h.size=4,h.format=a.DataTypeEnum.UINT,h.dimension=1,h.data=new Uint16Array(h.size),(d=new a.Buffer).indexBuffer=!0,d.size=4,d.format=a.DataTypeEnum.UINT,d.dimension=1,d.data=new Uint16Array(d.size),i.addBuffer(0,r),i.addBuffer(1,n),i.addBuffer(2,o),i.addBuffer(3,h),i.addBuffer(4,s),i.addBuffer(5,d),m=0,(g=o.data)[m++]=0,g[m++]=1,g[m++]=3,g[m++]=2,g=h.data,m=0,f=0;f<1;f++)g[m++]=f,g[m++]=f,g[m++]=f,g[m++]=f;for(m=0,(g=d.data)[m++]=0,g[m++]=1,g[m++]=3,g[m++]=2,g=r.data,m=0,m=0;m<12;m++)g[m]=0;for(m=0,(g=n.data)[m++]=0,g[m++]=0,g[m++]=1,m=0,(g=s.data)[m++]=0,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=1,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=0,f=0;f<1;f++)(l=new a.Primitive).nbIndices=4,l.connectivity=a.ConnectivityTypeEnum.TRIANGLE_STRIP,l.attr={fill:new a.FillAttributes(new a.Color(1-f/6,0,f/6,1),1),line:new a.LineAttributes,point:new a.PointAttributes},(c=new a.VertexComponent).component=a.VertexComponentEnum.POSITION,c.nbVertices=4,c.nbValuesPerVertex=3,c.format=a.DataTypeEnum.FLOAT,c.cardinality=0,c.bufferId=0,c.indices=new a.IndexArray,c.indices.format=a.DataTypeEnum.UINT,c.indices.bufferId=2,c.indices.offset=4*f,(u=new a.VertexComponent).component=a.VertexComponentEnum.NORMAL,u.nbVertices=4,u.nbValuesPerVertex=3,u.format=a.DataTypeEnum.FLOAT,u.cardinality=0,u.bufferId=1,u.indices=new a.IndexArray,u.indices.format=a.DataTypeEnum.UINT,u.indices.bufferId=3,u.indices.offset=4*f,(p=new a.VertexComponent).component=a.VertexComponentEnum.TEX_COORD_0,p.nbVertices=4,p.nbValuesPerVertex=3,p.format=a.DataTypeEnum.FLOAT,p.cardinality=0,p.bufferId=4,p.indices=new a.IndexArray,p.indices.format=a.DataTypeEnum.UINT,p.indices.bufferId=5,p.indices.offset=0,l.addVertexComponent(c),l.addVertexComponent(u),l.addVertexComponent(p),i.addPrimitive(l);return(_=t.createMeshNode(i,e)).setShadow(!1),_},UWA.namespace("THREEDS/Nodes/Canvas2DNode",r)}),define("DS/SceneGraphNodes/TubeLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var a=new e.TubeLight(t.color,t.intensity,t.radius,t.width,t.mode);return this._radius=a.radius,this._width=a.width,this._parent(a,i),this},setRadius:function(e){e&&(this._radius=e),this._updateRadius()},_updateRadius:function(){var e;this.light3js.radius=this._radius,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.radius=this._radius},setWidth:function(e){e&&(this._width=e),this._updateWidth()},_updateWidth:function(){var e;this.light3js.width=this._width,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.width=this._width},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"TubeLightNode3D"}});return UWA.namespace("THREEDS/Nodes/TubeLight",i)}),define("SceneGraphNodes/TubeLightNode",["DS/SceneGraphNodes/TubeLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/TubeLightNode"),e}),define("DS/SceneGraphNodes/CSS2DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";var i=t.extend({defaultOptions:{},init:function(t,i,a,r){var n=null,s=null,o=null,h=null;t.hasOwnProperty("html")?(n=t.html,s=t.position,o=t.name,h=t.offset):(console.warn("DEPRECATED : create your CSS2DNode with a litteral object"),n=t,s=i,o=a,h=r),s||(s=new e.Vector3),this._parent(o),this._element=n;var d=document.createElement("div");d.appendChild(n),d.style.display="none",d.ondragstart=function(){return!1},this.css2DNode=new e.CSS2DNode(d,s,h),this.hasExplicitBE=!0,this.explicitBSphere=new e.Sphere(new e.Vector3(0,0,0),1),this.explicitBBox=null,this.css2DNode.matrixAutoUpdate=!1,this.css2DNode.applyMatrix((new e.Matrix4).setPosition(s)),this._alwaysOnTopIndex=null;var l=this._occurrences[0];return l.renderable=this.css2DNode,l.renderable.name=this.name,l.renderable._occurrence=l,document.getElementById("divCss2DElement")&&document.getElementById("divCss2DElement").appendChild(this.css2DNode.element),this.setMatrix(this.css2DNode.matrix),this.rank=0,this.vanish=!1,this},setPickability:function(e){this.css2DNode.element.style.pointerEvents=e?"auto":"none"},getElement:function(){return this._element},add:function(){return!1},getNodeType:function(){return"CSS2DNode"},setOffset:function(t){t instanceof e.Vector2&&(this.css2DNode.offset=t.clone(),this._occurrences[0].node.css2DNode.offset=this.css2DNode.offset)},getOffset:function(){return this.css2DNode.offset},setAlwaysOnTopIndex:function(e){this._alwaysOnTopIndex=e},getAlwaysOnTopIndex:function(){return this._alwaysOnTopIndex},updatePosition:function(){var t=this._getViewer();if(t){var i=this.css2DNode,a=t.canvas,r=t.currentViewpoint.camera,n=new e.Vector3;if(n.copy(this.css2DNode.position),r.getLookAt().dot(r.position.clone().sub(n))<0){(new e.Projector).projectVector(n,r),i.element.style.display="block";var s=e.getDevicePixelRatio()||1,o=i.offset.x/s,h=i.offset.y/s;i.element.style.left=o+.5*(n.x+1)*a.clientWidth+"px",i.element.style.top=h-.5*(n.y-1)*a.clientHeight+"px"}else i.element.style.display="none"}},clone:function(){return new THREEDS.Nodes.CSS2DNode(this.css2DNode.element,this.css2DNode.position,this.name)}});return UWA.namespace("THREEDS/Nodes/CSS2DNode",i)}),define("SceneGraphNodes/CSS2DNode",["DS/SceneGraphNodes/CSS2DNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/CSS2DNode"),e}),define("DS/SceneGraphNodes/FixedSizeNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],function(e,t,i){"use strict";var a=new e.Vector3,r=new e.Matrix4,n=new e.Matrix4,s=e.__visibleInCurrentSpace,o=t.extend({init:function(t){var i;arguments.length>1?(console.error("[WARNING] DEPRECATED FixedSizeNode3D construction: "+(new Error).stack),i={name:arguments[0],ratio:arguments[1],cameraName:arguments[3]}):i=t||{},this._parent(i.name),this.cameraName=i.cameraName||"camera",this._isDynamic=!0,this._autoUpdate=!0,this.invariantPoint=i.invariantPoint||null,this.ratio=i.ratio,this.scaleFactor=1,this.scaleFactorPerOcc=[];var a=this,r=e.NoOccurrences;return this.cbChange=function(e){if(!r)if(a.isInstance())for(var t=0;t<a._occurrences.length;t++){var i=(l=a._occurrences[t]).parent;if(l.scene3js&&i){var n=l.scene3js.viewer;if(s(l._getVisible(),l._getVisibilityFree(),n.getVisibleSpace(),null,l)){if(e&&e.viewpoint&&e.viewpoint.viewer&&n!==e.viewpoint.viewer)continue;var o=n.currentViewpoint,h=a._getDynamicMatrix(i.matrix,e,o,t);l.matrix.multiplyMatrices(i.matrix,h);for(var d=0;d<l.children.length;d++)a._updateOccurrences(l,l.children[d],!0,!0)}}}else{var l,c=a.parents[0];if(!c)return;if(!(l=this._occurrences[0]).scene3js)return;n=l.scene3js.viewer;if(s(l._getVisible(),l._getVisibilityFree(),n.getVisibleSpace(),null,l)){if(e&&e.viewpoint&&e.viewpoint.viewer&&n!==e.viewpoint.viewer)return;o=n.currentViewpoint,h=a._getDynamicMatrix(c.getMatrixWorld(),e,o,0);a.setMatrix(h,!0)}}},this.tokenChange=null,this},setRatio:function(e){e!==this.ratio&&this._invalidateBoundingElements(),this.ratio=e,this.cbChange()},getRatio:function(){return this.ratio},setInvariantPoint:function(e){this.invariantPoint=e,this.cbChange()},getInvariantPoint:function(){return this.invariantPoint},getScaleFactor:function(e){return e>=0?this.scaleFactorPerOcc[e]:this.scaleFactor},isPointOfViewDependant:function(){return!0},_onLinkedToSceneGraph:function(){this.tokenChange=i.subscribe({event:"/VISU/"},e=>{this._autoUpdate&&"@onViewpointChange"===e.eventType&&this.cbChange(e)})},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenChange)},_getDynamicMatrix:function(e,t,i,s){e||(r.identity(),e=r);var o=i||t.viewpoint,h=o[this.cameraName];this._matrix?n.multiplyMatrices(e,this._matrix):n.copy(e);var d=n.getMaxScaleOnAxis();this.invariantPoint?a.copy(this.invariantPoint):a.getPositionFromMatrix(n);var l=d/h.getWorldSizeFromPixelSize(1,a,o.viewer._getDivClientHeight())/this.ratio,c=0!==l?1/l:1;return c||(c=1),h.fullWidth&&(c*=h.height/h.fullHeight),r.makeScale(c,c,c),this.scaleFactor=(this._matrix?this._matrix.getMaxScaleOnAxis():1)*c,this.scaleFactorPerOcc[s||0]=this.scaleFactor,this._matrix?(n.multiplyMatrices(this._matrix,r),n):r},setCameraName:function(e){this.cameraName=e||"camera"}});return UWA.namespace("THREEDS/Nodes/FixedSizeNode3D",o)}),define("SceneGraphNodes/FixedSizeNode3D",["DS/SceneGraphNodes/FixedSizeNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/FixedSizeNode3D"),e}),define("DS/SceneGraphNodes/InstancedCurvedPipeManager",["DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],function(e,t){"use strict";var i,a,r={maxTextureSize:-1,maxTextureTotalSize:-1,isInit:!1,init:function(){if(!this.isInit){var e=debugWebGLV6Viewer.renderer.renderer.context;this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxTextureTotalSize=this.maxTextureSize*this.maxTextureSize,this.isInit=!0}}},n=function(e,t){for(var i=t||1;i<e;)i*=2;return i},s=(i=new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0]),(a=new e.DataTexture(i,3,1,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,a.magFilter=e.NearestFilter,a.generateMipmaps=!1,a.flipY=!1,a.needsUpdate=!0,a),o=function(e){var t=e.x,i=e.y,a=e.z,r=Math.abs(t)+Math.abs(i)+Math.abs(a),n=t/r,s=i/r;if(a<0){var o=(1-Math.abs(s))*(n>=0?1:-1),h=(1-Math.abs(n))*(s>=0?1:-1);n=o,s=h}return 4096*(n=Math.round(4095*(.5*n+.5)))+(s=Math.round(4095*(.5*s+.5)))},h=0,d=1,l=2,c={_VSGlobal:["#define NB_CURVES_MAPS_MAX 2","#define NB_CURVES_MAPS 1","#define NB_MATRICES_MAPS 1","#define PI2 6.28318530718","vec3 cp_objectPosition;","vec3 cp_objectNormal;","vec3 cp_infosUV;","mat4 _curveModelMatrix;","float cp_radius;","vec3 decompressVector(in float iVec) {","return decodeOct24Normal(iVec);","}","vec4 getCurveData(float iId, float iMaxMapTotalSize, float iLAST_CURVES_MAP_SIZE_X, float iLAST_CURVES_MAP_SIZE_Y) {","int texId = int(floor(iId/iMaxMapTotalSize));","float idInTexture = iId - float(texId)*iMaxMapTotalSize;","float dx, dy, x, y;","if (texId == int(NB_CURVES_MAPS) - 1) {","dx = 1.0 / iLAST_CURVES_MAP_SIZE_X;","dy = 1.0 / iLAST_CURVES_MAP_SIZE_Y;","y = floor(idInTexture/iLAST_CURVES_MAP_SIZE_X);","x = idInTexture - y*iLAST_CURVES_MAP_SIZE_X;","} else {","dx = 1.0 / MAX_TEXTURE_SIZE;","dy = 1.0 / MAX_TEXTURE_SIZE;","y = floor(idInTexture/MAX_TEXTURE_SIZE);","x = idInTexture - y*MAX_TEXTURE_SIZE;","}","vec2 xy = vec2( dx * ( x + 0.5 ), dy * ( y + 0.5 ) );","vec4 curveData;","for (int i = 0; i < NB_CURVES_MAPS; i++) {","if (texId == i) {","curveData = texture2D( curvesMaps[i], xy);","}","}","return curveData;","}","","void computeMatrixAndRadius() {","float _idInMatricesMap = specialMeshIds.x;","float LAST_MATRICES_MAP_SIZE_X = curvesMatricesProperties.x;","float LAST_MATRICES_MAP_SIZE_Y = curvesMatricesProperties.y;","float maxMapTotalSize = MAX_TEXTURE_SIZE*MAX_TEXTURE_SIZE;","int texId = int(floor(_idInMatricesMap/maxMapTotalSize));","float idInTexture = _idInMatricesMap - float(texId)*maxMapTotalSize;","float dx, dy, x, y;","if (texId == int(NB_MATRICES_MAPS) - 1) {","dx = 1.0 / LAST_MATRICES_MAP_SIZE_X;","dy = 1.0 / LAST_MATRICES_MAP_SIZE_Y;","y = floor(idInTexture/LAST_MATRICES_MAP_SIZE_X);","x = idInTexture - y*LAST_MATRICES_MAP_SIZE_X;","} else {","dx = 1.0 / MAX_TEXTURE_SIZE;","dy = 1.0 / MAX_TEXTURE_SIZE;","y = floor(idInTexture/MAX_TEXTURE_SIZE);","x = idInTexture - y*MAX_TEXTURE_SIZE;","}","vec2 xy = vec2( dx * ( x + 0.5 ), dy * ( y + 0.5 ) );","_curveModelMatrix[3].w = 1.0;","for (int i = 0; i < NB_MATRICES_MAPS; i++) {","if (texId == i) {","vec4 tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 0.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[0].xyz = tmp.xyz;","tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 1.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[1].xyz = tmp.xyz;","tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 2.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[2].xyz = tmp.xyz;","tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 3.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[3].xyz = tmp.xyz;","cp_radius = tmp.w;","}","}","}"].join("\n"),_VSOverridables:{ComputeCommonValues:["void ComputeCommonValues() {","vec3 infos = vGetAttribPosition();","cp_infosUV = infos;","float LAST_CURVES_MAP_SIZE_X = curvesMapsProperties.x;","float LAST_CURVES_MAP_SIZE_Y = curvesMapsProperties.y;","float _idInCurvesMaps = specialMeshIds.y;","float curvePointId = _idInCurvesMaps + infos.x;","float nextCurvePointId = curvePointId + 1.0;","float precCurvePointId = curvePointId - 1.0;","float maxMapTotalSize = MAX_TEXTURE_SIZE*MAX_TEXTURE_SIZE;","vec4 curveData = getCurveData(curvePointId, maxMapTotalSize, LAST_CURVES_MAP_SIZE_X, LAST_CURVES_MAP_SIZE_Y);","vec4 nextCurveData = getCurveData(nextCurvePointId, maxMapTotalSize, LAST_CURVES_MAP_SIZE_X, LAST_CURVES_MAP_SIZE_Y);","vec4 precCurveData = getCurveData(precCurvePointId, maxMapTotalSize, LAST_CURVES_MAP_SIZE_X, LAST_CURVES_MAP_SIZE_Y);","vec3 curvePoint = curveData.xyz;","vec3 u = decompressVector(curveData.w);","vec3 nextCurvePoint = nextCurveData.xyz;","vec3 precCurvePoint = precCurveData.xyz;","computeMatrixAndRadius();","float angle = infos.y;","vec3 localPosition = vec3(cos(angle), sin(angle), 0.0);","vec3 t = normalize(nextCurvePoint - precCurvePoint);","vec3 v = cross(t, u);","cp_objectPosition = curvePoint + cp_radius*normalize(localPosition.x*u + localPosition.y*v);","bool isCap = infos.z > 0.3;","float isFirstSign = infos.z > 0.7 ? 1.0 : -1.0;","cp_objectNormal = isCap ? isFirstSign*t : normalize(cp_objectPosition - curvePoint);","}"].join("\n"),ProcessViewTangentSpace:["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","mat4 curveMVMatrix = vGetViewMatrix()*_curveModelMatrix;","ioWorldViewTS.Position = vec3(curveMVMatrix*vec4(cp_objectPosition, 1.0));","ioWorldViewTS.Normal = vec3(curveMVMatrix*vec4(cp_objectNormal, 0.0));","}"].join("\n"),ComputeObjectTexCoord0:["vec4 ComputeObjectTexCoord0() {","return vec4(cp_infosUV.x / 16.0, cp_infosUV.y / PI2, 0.0, 0.0);","}"].join("\n")}},u=function(){this._ranges=[]};u.prototype.addID=function(e){if(!(e<0)){var t=this._ranges;if(0!==t.length){for(var i=t.length,a=null,r=0;r<i;){if(e>=(a=t[r]).min&&e<=a.max)return;if(e===a.min-1)return a.min=e,void(r>0&&t[r-1].max===e-1&&(t[r-1].max=a.max,t.splice(r,1)));if(e===a.max+1)return a.max=e,void(r<i-1&&t[r+1].min===e+1&&(a.max=t[r+1].max,t.splice(r+1,1)));r++}if(e<t[0].min)t.splice(0,0,{min:e,max:e});else if(e>t[i-1].max)t.splice(i,0,{min:e,max:e});else for(var n=0;n<i;n++)if(e<(a=t[n]).min)return void t.splice(n,0,{min:e,max:e})}else t.push({min:e,max:e})}},u.prototype.getAvailableID=function(){var e=this._ranges;if(0===e.length)return 0;var t=e[0];return t.min>0?t.min-1:t.max+1},u.prototype.getTotalNumberOfIDs=function(){var e=this._ranges;return 0===e.length?0:e[e.length-1].max+1},u.prototype.getTotalNumberOfIDsNextPowerOfTwo=function(){return n(this.getTotalNumberOfIDs())},u.prototype.removeID=function(e){var t=this._ranges;if(0!==t.length)for(var i=t.length,a=null,r=0;r<i;r++){if(e===(a=t[r]).min)return void(a.min===a.max?t.splice(r,1):a.min++);if(e===a.max)return void a.max--;if(e>a.min&&e<a.max){var n={min:e+1,max:a.max};return a.max=e-1,void t.splice(r+1,0,n)}}},u.prototype.getNbRanges=function(){return this._ranges.length};var p=function(t,i,a,r){this._LODSags=r,this._nbLODs=this._LODSags.length,this._nbCurvePoints=0===t?2:Math.pow(2,t-1)+1,this._nbCurvePointsPlus2=2+this._nbCurvePoints,this._sag=a,this._isCaps=i,this._LODGeometries=[];for(var n=0;n<this._nbLODs;n++)this._LODGeometries.push(this._buildLODGeometry(this._LODSags[n]));var s=Math.random(),o=Math.random(),d=Math.random();this._debugColor=(new e.Color).setRGB(s,o,d),this._nbUsed=0,this._curvesData=new Float32Array(1024),this._curvesMaps=[],this._realMaps=[],this._curvesMapsProperties=new e.Vector3(128,2,1),this._updateCurvesMapsStatus=h,this._idsRanges=new u,this.materials={}};p.prototype._buildLODGeometry=function(i){var a=new e.BufferGeometryDS;a.sharedBuffers=!0;var r=i,n=this._nbCurvePoints;a.drawingGroups=[];for(var s=this._isCaps?6*(r-2):6*r*(n-1),o=this._isCaps?1:0,h=n*r,d=new Float32Array(3*h),l=0,c=1,u=0;u<n;u++){for(var p=0;p<r;p++)d[l++]=c,d[l++]=p/r*2*Math.PI,d[l++]=o?u>0?1:.5:0;c++}a.vertexPositionArray=d;var _=new Uint16Array(s),m=0;if(this._isCaps){for(p=0;p<r-2;p++)_[m++]=0,_[m++]=p+2,_[m++]=p+1;for(p=0;p<r-2;p++)_[m++]=r,_[m++]=r+p+1,_[m++]=r+p+2}else{var f=0,g=0,v=0,S=0,x=0;for(p=0;p<r;p++)for(u=0;u<n-1;u++)f=(x=u*r)+p,g=x+(p+1)%r,v=x+p+r,S=p===r-1?x+r:(x+p+r+1)%h,_[m++]=f,_[m++]=g,_[m++]=v,_[m++]=g,_[m++]=S,_[m++]=v}a.vertexIndexArray=_;var w=new t.DrawingGroup(null,null,4,0,s);return w._geomType=e.GeomTypeEnum.FACE,w.geometry=a,a.drawingGroups.push(w),a};new e.Vector3;var _=new e.Vector3,m=new e.Vector3;new e.Vector3;p.prototype._addCurvedPipe=function(t,i,a,r,n,s,o){var h=e.InstancedCurvedPipeManager;0===r?_.set(a[r+3]+s.x,a[r+4]+s.y,a[r+5]+s.z):_.set(a[r-3],a[r-2],a[r-1]),n===a.length?m.set(a[n-6]+o.x,a[n-5]+o.y,a[n-4]+o.z):m.set(a[n],a[n+1],a[n+2]);var d=this._idsRanges.getAvailableID();this._idsRanges.addID(d);var l=4*d*(2+this._nbCurvePoints),c=this._updateMapSize();this._curvesData[l++]=_.x,this._curvesData[l++]=_.y,this._curvesData[l++]=_.z,this._curvesData[l++]=r>0?h._compressedSideVectors_tmp[(r-3)/3]:0;for(var u=r;u<n;u+=3)this._curvesData[l++]=a[u],this._curvesData[l++]=a[u+1],this._curvesData[l++]=a[u+2],this._curvesData[l++]=h._compressedSideVectors_tmp[u/3];return this._curvesData[l++]=m.x,this._curvesData[l++]=m.y,this._curvesData[l++]=m.z,this._curvesData[l++]=n<a.length?h._compressedSideVectors_tmp[(n+3)/3]:0,this._updateMapData(c),d},p.prototype._removeCurvedPipe=function(e){if(0!==this._idsRanges.getNbRanges()){this._updateCurvesMapsStatus=d;var t=this._idsRanges.getTotalNumberOfIDs();this._idsRanges.removeID(e),t!==this._idsRanges.getTotalNumberOfIDs()&&(this._updateCurvesMapsStatus=h),this._nbUsed--}},p.prototype._resetMapsInfos=function(){this._curvesData=new Float32Array(1024),this._curvesMaps=[],this._curvesMapsProperties.set(128,2,1)},p.prototype._updateMapSize=function(){var e=this._idsRanges.getTotalNumberOfIDs()*(this._nbCurvePoints+2),t=Math.sqrt(e),i=n(t,128),a=n(e/i,2),r=this._reallocateMap(i,a);return this._curvesMapsProperties.x=i,this._curvesMapsProperties.y=a,r},p.prototype._updateMapData=function(t){this._curvesMaps=[],this._curvesMapsProperties.z=1;var i=this._realMaps[0];i?(i.image.width=this._curvesMapsProperties.x,i.image.height=this._curvesMapsProperties.y,t&&(i.image.data=this._curvesData)):((i=new e.DataTexture(this._curvesData,this._curvesMapsProperties.x,this._curvesMapsProperties.y,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,i.magFilter=e.NearestFilter,i.generateMipmaps=!1,i.flipY=!1,this._realMaps.push(i)),this._curvesMaps.push(i),i.needsUpdate=!0;for(var a=2-this._curvesMaps.length,r=0;r<a;r++)this._curvesMaps.push(s)},p.prototype._reallocateMap=function(e,t){if(e>this._curvesMapsProperties.x||t>this._curvesMapsProperties.y){for(var i=4*this._curvesMapsProperties.x*this._curvesMapsProperties.y,a=new Float32Array(4*e*t),r=0;r<i;r++)a[r]=this._curvesData[r];return this._curvesData=a,!0}return!1},p.prototype._initCurvesMaps=function(e){return!0};var f=function(){this._LODSags=[6,8,10,12,14,16],this._nbLODs=this._LODSags.length,this._instancingGroups=[];for(var t=0;t<33;t++)this._instancingGroups.push(null);this._perRenderableData=new Map,this._geometryToInstancingGroup=new Map,this._matricesJSArray=[],this._matricesFloat32Array=null,this._curvesMatricesProperties=new e.Vector3,this._matrixRanges=new u,this._matricesMaps=[],this._realMaps=[],this._updateMatricesMapsStatus=h,this._compressedSideVectors_tmp=[],this._capsPoints_tmp=new Array(6),this.pipesToRemove=[],this._debugNbPipes=0,this.debugNbCreatedTextures=0};f.prototype._changeMatricesMapStatus=function(e){this._updateMatricesMapsStatus!==h&&(this._updateMatricesMapsStatus=e)},f.prototype._initMatricesMap=function(){if(this._updateMatricesMapsStatus!==l){if(this._updateMatricesMapsStatus===h){r.init(),this._matricesMaps=[];var t=4*this._matrixRanges.getTotalNumberOfIDs(),i=t-Math.floor(t/r.maxTextureTotalSize)*r.maxTextureTotalSize,a=Math.sqrt(i),o=n(a,128),c=n(i/o,2);this._curvesMatricesProperties.x=o,this._curvesMatricesProperties.y=c;var u=Math.max(1,Math.ceil(t/r.maxTextureTotalSize));this._curvesMatricesProperties.z=u;var p=r.maxTextureTotalSize,_=r.maxTextureSize,m=4*((u-1)*p+o*c);this._matricesFloat32Array=new Float32Array(m),this._matricesFloat32Array.set(this._matricesJSArray,0);for(var f,g=this._matricesFloat32Array,v=0,S=0;S<u-1;S++)(f=this._realMaps[v])?(f.image.width=_,f.image.height=_,f.image.data=g.subarray(S*p*4,(S+1)*p*4)):((f=new e.DataTexture(g.subarray(S*p*4,(S+1)*p*4),_,_,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,f.magFilter=e.NearestFilter,f.generateMipmaps=!1,f.flipY=!1,this.debugNbCreatedTextures++,this._realMaps.push(f)),this._matricesMaps.push(f),f.needsUpdate=!0,v++;(f=this._realMaps[v])?(f.image.width=o,f.image.height=c,f.image.data=g.subarray((u-1)*p*4,m)):((f=new e.DataTexture(g.subarray((u-1)*p*4,m),o,c,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,f.magFilter=e.NearestFilter,f.generateMipmaps=!1,f.flipY=!1,this.debugNbCreatedTextures++,this._realMaps.push(f)),this._matricesMaps.push(f),f.needsUpdate=!0;for(var x=2-this._matricesMaps.length,w=0;w<x;w++)this._matricesMaps.push(s);return this._updateMatricesMapsStatus=l,!0}if(this._updateMatricesMapsStatus===d){this._matricesFloat32Array.set(this._matricesJSArray,0);for(var M=this._matricesFloat32Array,b=this._matricesMaps.length,y=0,D=0;D<b;D++){var T=this._matricesMaps[D].image,N=T.width*T.height;y+N>M.length||T.data.set(M.subarray(y,N),0),y+=N,this._matricesMaps[D].needsUpdate=!0}this._updateMatricesMapsStatus=l}}return!1},f.prototype.addCurvedPipe=function(e,t,i,a,r,n,s){var o=this._LODSags[this._LODSags.length-1],l=e.id+"_"+t;this._debugNbPipes++,this.computeCompressedSideVectors(a,s,n);var c=4*this._matrixRanges.getAvailableID(),u=this._perRenderableData.get(l);u||(u=[],this._perRenderableData.set(l,u));for(var _=this._instancingGroups,m=a.length/3,f=m-1,g=1,v=0,S=this._LODSags.length;0!==f;){if(f%2==1){if(!_[g]){_[g]=new p(g,!1,o,this._LODSags);for(var x=0;x<S;x++)this._geometryToInstancingGroup.set(_[g]._LODGeometries[x].id,_[g])}_[g]._nbUsed++;var w=3*(Math.pow(2,g-1)+1),M=_[g]._addCurvedPipe(l,i,a,v,v+w,r,n);u.push({idInMaps:M,matrixId4:c,bin:g}),v+=w-3}g++,f>>=1}if(!_[g=0]){_[g]=new p(g,!0,o,this._LODSags);for(x=0;x<S;x++)this._geometryToInstancingGroup.set(_[g]._LODGeometries[x].id,_[g])}_[g]._nbUsed++;w=6;this._capsPoints_tmp[0]=a[0],this._capsPoints_tmp[1]=a[1],this._capsPoints_tmp[2]=a[2],this._capsPoints_tmp[3]=a[3*(m-1)],this._capsPoints_tmp[4]=a[3*(m-1)+1],this._capsPoints_tmp[5]=a[3*(m-1)+2],this._compressedSideVectors_tmp[1]=this._compressedSideVectors_tmp[m-1];M=_[g]._addCurvedPipe(l,i,this._capsPoints_tmp,0,w,r,n);u.push({idInMaps:M,matrixId4:c,bin:g});var b=this._matricesJSArray,y=e.matrixWorld.elements,D=4*c;b[D]=y[0],b[D+1]=y[1],b[D+2]=y[2],b[D+3]=0,b[D+4]=y[4],b[D+5]=y[5],b[D+6]=y[6],b[D+7]=0,b[D+8]=y[8],b[D+9]=y[9],b[D+10]=y[10],b[D+11]=0,b[D+12]=y[12],b[D+13]=y[13],b[D+14]=y[14],b[D+15]=i,this._matrixRanges.addID(c/4);var T=this._matrixRanges.getTotalNumberOfIDs();!this._matricesFloat32Array||16*T>this._matricesFloat32Array.length?this._changeMatricesMapStatus(h):this._changeMatricesMapStatus(d)},f.prototype.addHLCurvedPipe=function(e,t){for(var i=0;i<t.geometry.drawingGroups.length;i++){var a=this._perRenderableData.get(t.id+"_"+i);a&&this._perRenderableData.set(e.id+"_"+i,a)}},f.prototype.removeCurvedPipe=function(e,t){e&&this.pipesToRemove.push(e);for(var i=[],a=0;a<this.pipesToRemove.length;a++){var r=this.pipesToRemove[a];if(0===Object.keys(r._tokens).length){this._debugNbPipes-=t._pipes.length;for(var n=0;n<r.geometry.drawingGroups.length;n++){var s=r.id+"_"+n,o=this._perRenderableData.get(s);o&&this._removeCurvedPipe(o,s)}r._flagAsGSSOInvalidated()}else i.push(r)}this.pipesToRemove=i},f.prototype._removeCurvedPipe=function(e,t){for(var i=this._instancingGroups,a=this._matrixRanges.getTotalNumberOfIDs(),r=e.length,n=this._nbLODs,s=0;s<r;s++){var o=e[s],l=o.bin;if(i[l]&&(i[l]._removeCurvedPipe(o.idInMaps),0===i[l]._nbUsed)){for(var c=0;c<n;c++)this._geometryToInstancingGroup.delete(i[l]._LODGeometries[c].id);i[l]=null}this._matrixRanges.removeID(o.matrixId4/4)}if(this._perRenderableData.delete(t),this._changeMatricesMapStatus(d),0!==this._matrixRanges.getNbRanges()){var u=this._matrixRanges.getTotalNumberOfIDs();a!==u&&(this._changeMatricesMapStatus(h),this.resetMapsInfos()),this._matricesJSArray.length=16*u}},f.prototype.resetMapsInfos=function(){this._matricesJSArray=[],this._matricesFloat32Array=null,this._curvesMatricesProperties.set(0,0,0),this._matricesMaps=[]},f.prototype.computeCompressedSideVectors=function(t,i,a){var r=0,n=(new e.Vector3).copy(i),s=o(n);this._compressedSideVectors_tmp[r++]=s;for(var h=new e.Vector3,d=new e.Vector3,l=new e.Vector3,c=new e.Vector3,u=t.length/3,p=1;p<u;p++){p===u-1?h.copy(a).normalize():(l.set(t[3*(p-1)],t[3*(p-1)+1],t[3*(p-1)+2]),c.set(t[3*(p+1)],t[3*(p+1)+1],t[3*(p+1)+2]),h.subVectors(c,l).normalize());var _=n.dot(h);h.multiplyScalar(_),d.subVectors(n,h).normalize(),this._compressedSideVectors_tmp[r++]=o(d),n=d}};e.glStates;return f.prototype.setMatrixOnCurvedPipe=function(e){for(var t=0;t<e.geometry.drawingGroups.length;t++){var i=e.id+"_"+t,a=this._perRenderableData.get(i);a&&this._setMatrixOnCurvedPipe(a,e)}},f.prototype._setMatrixOnCurvedPipe=function(e,t){var i=e[0].matrixId4,a=this._matricesJSArray,r=t.matrixWorld.elements,n=4*i;a[n]=r[0],a[n+1]=r[1],a[n+2]=r[2],a[n+4]=r[4],a[n+5]=r[5],a[n+6]=r[6],a[n+8]=r[8],a[n+9]=r[9],a[n+10]=r[10],a[n+12]=r[12],a[n+13]=r[13],a[n+14]=r[14],this._changeMatricesMapStatus(d)},f.prototype.setPDSFXParamsOnMaterial=function(e){e.activatePDSFX(),e.setPDSFXGlobalShaderCode(c._VSGlobal,"");var t={curvesMaps:{type:"t2v",value:null,length:2},curvesMapsProperties:{type:"v3",value:null},curvesMatrices:{type:"t2v",value:null,length:2},curvesMatricesProperties:{type:"v3",value:null}};e.setPDSFXUniforms(t);e.setPDSFXVaryings({debugColor:{type:"v3"}}),e._PDSFXData.pdsfxAttributesCode="attribute vec2 specialMeshIds;\n attribute vec3 specialMeshPicking;",e.setPDSFXOverridableFunctions(c._VSOverridables,{})},e.InstancedCurvedPipeManager=new f,e.InstancedCurvedPipeManager}),define("SceneGraphNodes/InstancedCurvedPipeManager",["DS/SceneGraphNodes/InstancedCurvedPipeManager","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/InstancedCurvedPipeManager"),e}),define("DS/SceneGraphNodes/DiskLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var a=new e.DiskLight(t.color,t.intensity,t.radius,t.mode);return this._radius=a.radius,this._parent(a,i),this},setRadius:function(e){e&&(this._radius=e),this._updateRadius()},_updateRadius:function(){var e;this.light3js.radius=this._radius,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.radius=this._radius},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"DiskLightNode3D"}});return UWA.namespace("THREEDS/Nodes/DiskLightNode",i)}),define("SceneGraphNodes/DiskLightNode",["DS/SceneGraphNodes/DiskLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/DiskLightNode"),e}),define("DS/SceneGraphNodes/SpotLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var a,r;t||(t={}),a=void 0!==t.outerAngle&&null!==t.outerAngle?Math.max(Math.min(t.outerAngle,Math.PI),0):Math.PI/2,r=void 0!==t.innerAngle&&null!==t.innerAngle?Math.max(Math.min(t.innerAngle,a-.001),0):a-.001,this._outerAngle=a,this._innerAngle=r;var n=t.intensity;void 0===n&&(n=t.power?t.power/(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle)))):1);var s=new e.SpotLight(t.color,n,t.distance,a,r);return t.target?(s.target=new e.Object3D,s.target.position=t.target):s.target=null,this._previousTarget=s.target,t.physicalAttenuation&&(s.isPhysicallyAttenuated=!0,s.attenuationScale=t.attenuationScale?t.attenuationScale:1e-6),this._parent(s,i,null),this},attachToViewpoint:function(t){if(this._attachedToVpt!=t){var i=this._occurrences.length;if(t){this.light3js.target=new e.Object3D,this.light3js.target.position=new e.Vector3(0,0,0);for(a=0;a<i;a++)this._occurrences[a].renderable.target=new e.Object3D,this._occurrences[a].renderable.target.position=new e.Vector3(0,0,0)}else{this.light3js.target=this._previousTarget;for(var a=0;a<i;a++)this._occurrences[a].renderable.target=this._previousTarget}}this._attachedToVpt=t},setTarget:function(t){var i=null;t&&((i=new e.Object3D).position=t);if(this.light3js.target=i,this._previousTarget=i,!this._attachedToVpt)for(var a=this._occurrences.length,r=0;r<a;r++)this._occurrences[r].renderable.target=i},castShadows:function(e,t){var i=this._occurrences.length;if(e){if(this.light3js.castShadow=!0,this.light3js.shadowCameraFov=180*this.light3js.angle/Math.PI*2,t){var a=!1;t.bias&&(this.light3js.shadowBias=t.bias),t.near&&(this.light3js.shadowCameraNear=t.near),t.far&&(this.light3js.shadowCameraFar=t.far),t.darkness&&(this.light3js.shadowDarkness=t.darkness),t.mapWidth&&(this.light3js.shadowMapWidth=t.mapWidth,a=!0),t.mapHeight&&(this.light3js.shadowMapHeight=t.mapHeight,a=!0),this.light3js.shadowMap&&a&&(this.light3js.shadowMap.dispose(),this.light3js.shadowMap=null,this.light3js.updateShadowMap=!0)}for(var r=0;r<i;r++){var n=this._occurrences[r].renderable;if(n.castShadow=!0,n.shadowCameraFov=180*n.angle/Math.PI*2,t){a=!1;t.bias&&(n.shadowBias=t.bias),t.near&&(n.shadowCameraNear=t.near),t.far&&(n.shadowCameraFar=t.far),t.darkness&&(n.shadowDarkness=t.darkness),t.mapWidth&&(n.shadowMapWidth=t.mapWidth,a=!0),t.mapHeight&&(n.shadowMapHeight=t.mapHeight,a=!0),n.shadowMap&&a&&(n.shadowMap.dispose(),n.shadowMap=null,n.updateShadowMap=!0)}}}else{this.light3js.castShadow=!1;for(r=0;r<i;r++)this._occurrences[r].renderable.castShadow=!1}},setAngles:function(e,t,i){if(i)var a=this._intensity*(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle))));e=null!=e?Math.max(Math.min(e,Math.PI/2),0):Math.PI/2,t=null!=t?Math.max(Math.min(t,e-.001),0):e-.001,this._outerAngle=e,this._innerAngle=t,i&&this.setIntensity(a/(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle))))),this._updateAngles(),this.updateShadowMap()},_updateAngles:function(){var e,t;this.light3js.angle=this._outerAngle,this.light3js.innerAngle=this._innerAngle,e=this._occurrences.length;for(var i=0;i<e;i++)(t=this._occurrences[i]).renderable.angle=this._outerAngle,t.renderable.innerAngle=this._innerAngle},setPower:function(e){var t=e/(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle))));this.setIntensity(t)},setPhysicalAttenuation:function(e){this.light3js.isPhysicallyAttenuated=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.isPhysicallyAttenuated=e},setPhysicalAttenuationScale:function(e){this.light3js.attenuationScale=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.attenuationScale=e},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"SpotLightNode3D"}});return UWA.namespace("THREEDS/Nodes/SpotLight",i)}),define("SceneGraphNodes/SpotLightNode",["DS/SceneGraphNodes/PointLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/SpotLightNode"),e}),define("DS/SceneGraphNodes/IESLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var a=new e.IESLight(t.color,t.intensity,t.distance,t.texture);return this._texture=t.texture,this._parent(a,i),this},setIESTexture:function(e){this._texture=e,this._updateTexture()},_updateTexture:function(){var e;this.light3js.iesTexture=this._texture,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.iesTexture=this._texture},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"IESLightNode3D"}});return UWA.namespace("THREEDS/Nodes/IESLight",i)}),define("SceneGraphNodes/IESLightNode",["DS/SceneGraphNodes/IESLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/IESLightNode"),e}),define("DS/SceneGraphNodes/Canvas2DInstancingNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/SceneGraphNodes/Canvas2DNode"],function(e,t,i,a,r){"use strict";var n=t.extend({init:function(t,i){this._parent(t.name),this.hotspot=t.hotspot||new e.Vector2(0,0),this.canvasNodeTexture=t.canvasNodeTexture,this.texture=this.canvasNodeTexture._getCanvas2DTexture(),this.rectangle=r._createRectangle(null,i),this.rectangle.setFrustumCulled(!1),this.rectangle.setMirror(!1),this.rectangle.setShadow(!1,!1),this.setInstancingParams(t,this.texture),this.addChild(this.rectangle),this.rectangle.setRenderPasses(["canvas2D"]),void 0!==t.excludeFromBounding?this.excludeFromBounding=!!t.excludeFromBounding:this.excludeFromBounding=!0,this.excludeFromBounding?this.exludeFromBounding(!0):this._setupBoundingSphere(t.matrices);var a=this;return this.rectangle._setBeforeRenderCB(function(e,t){a.texture.redrawRequested&&a.canvasNodeTexture._redrawCanvas2DTexture()}),this},excludeFromHighlight:function(e,t){this.rectangle.excludeFromHighlight(e,t)},setInstancingParams:function(e){this.material=this._buildInstancingMaterial(this.texture),this.material.force=!0,this.rectangle.setMaterial(this.material),this._setUpMeshInstancingParameters(this.rectangle,e.nbInstances,e.matrices,e.colors),this.excludeFromBounding||this._setupBoundingSphere(e.matrices)},_buildInstancingMaterial:function(t){var i=new e.MeshBasicMaterial({force:!0,transparent:!0,side:e.DoubleSide});i.activatePDSFX();var a={ComputeObjectPosition:["vec3 ComputeObjectPosition() {","vec4 localPosition = vec4(vGetAttribPosition(), 1.0);","vec4 newPosition = instanceMatrix*localPosition;","return newPosition.xyz;","}"].join("\n"),ProcessClipSpacePosition:["void ProcessClipSpacePosition(inout vec4 ioPosition) {","vec2 myUv = vGetAttribTexCoord0().xy;","ioPosition.x += ioPosition.w * (pixelSize.x*(-hotspot.x + myUv.x*size.x));","ioPosition.y += ioPosition.w * (pixelSize.y*(-hotspot.y + myUv.y*size.y));","}"].join("\n"),ComputeVaryingValues:["void ComputeVaryingValues() {","vColor = instanceColor;","vTex = vGetAttribTexCoord0().xy;","}"].join("\n")},r={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","vec4 color = texture2D(map, vTex);","ioFinalColor = vec4(color.r*vColor.r, color.g*vColor.g, color.b*vColor.b, color.a);","}"].join("\n"),ComputeViewNormal:"vec3 ComputeViewNormal() { return vec3(0.0,0.0,1.0); }",ComputeDiscard:["bool ComputeDiscard() {","  vec4 color = texture2D(map, vTex);","  return color.a <= alphaTest;","}"].join("\n")},n={hotspot:{type:"v2",value:this.hotspot},pixelSize:{type:"v2",value:new e.Vector2(.005,.005)},size:{type:"v2",value:new e.Vector2(this.canvasNodeTexture.width,this.canvasNodeTexture.height)},map:{type:"t2",value:t},alphaTest:{type:"f",value:this.canvasNodeTexture.alphaTest||-1}};return i.setPDSFXVaryings({vColor:{type:"v3"},vTex:{type:"v2"}}),i.setPDSFXUniforms(n),i.setPDSFXOverridableFunctions(a,r),i.refreshUniforms=function(t,i){var a;if(!t._smallTargetPicking||t.materialToUse!==e.MaterialToUse.pickingMaterial&&t.materialToUse!==e.MaterialToUse.pickingMaterialInstancing&&t.materialToUse!==e.MaterialToUse.normalMaterial&&t.materialToUse!==e.MaterialToUse.depthMaterial)a=new e.Vector2(2/t.domElement.width,2/t.domElement.height);else{var r=2*t._gpuPickingTolerance+1;a=new e.Vector2(2/r,2/r)}this.updatePDSFXUniform("pixelSize",a)},i},_setUpMeshInstancingParameters:function(t,i,a,r){var n,s,o,h,d,l,c=new Float32Array(16*i),u=new Float32Array(3*i),p=new e.Matrix4;for(n=0;n<i;n++){for(s=a[n],p.copy(s),o=16*n,h=s.elements,l=0;l<16;l++)c[o+l]=h[l];o=3*n,d=r[n],u[o]=d.r,u[o+1]=d.g,u[o+2]=d.b}var _={data:c,type:"m4",attribName:"instanceMatrix",isFlattened:!0},m={data:u,type:"v3",attribName:"instanceColor",isFlattened:!0};t.setInstancingParameters(i,[_,m])},_setupBoundingSphere:function(t){var i,a,r,n,s,o=new e.Vector3(-1/0,-1/0,-1/0),h=new e.Vector3(1/0,1/0,1/0),d=new e.Vector3(0,0,0);for(i=0;i<t.length;i++)r=(a=t[i]).elements[12],n=a.elements[13],s=a.elements[14],r<h.x&&(h.x=r),n<h.y&&(h.y=n),s<h.z&&(h.z=s),r>o.x&&(o.x=r),n>o.y&&(o.y=n),s>o.z&&(o.z=s);d.x=(h.x+o.x)/2,d.y=(h.y+o.y)/2,d.z=(h.z+o.z)/2;var l,c=new e.Vector3,u=0;for(i=0;i<t.length;i++)r=(a=t[i]).elements[12],n=a.elements[13],s=a.elements[14],c.set(r,n,s),(l=d.distanceTo(c))>u&&(u=l);var p=new e.Sphere(d,u);this.rectangle.forceBoundingSphere(p)}});return UWA.namespace("THREEDS/Nodes/Canvas2DInstancingNode",n)}),define("DS/SceneGraphNodes/RefPlaneNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory","DS/Visualization/TextNode","DS/Visualization/MaterialApplication"],function(e,t,i,a,r,n,s,o,h,d){"use strict";var l=new e.MeshBasicMaterial({force:!1}),c=new e.Matrix4,u=new e.Vector3(0,0,1),p=new e.Vector3,_=new e.Vector3,m=new e.Vector3,f=new e.Vector3,g=new e.Vector3,v=new e.Vector3,S=new e.Vector3,x=new e.Vector3,w=new e.Vector3,M=new e.Vector3,b=new e.Vector3,y=new Map,D=new Map,T=new Map,N=e.__visibleInCurrentSpace,P=function(){this._backBorderMaterial=null,this._frontPlaneMaterial=null,this._backPlaneMaterial=null,this._xIndicatorMaterial=null,this._margin=null,this._frontText=null,this._backText=null,this._frontPlane=null,this._frontPlaneGAS=null,this._frontPlaneMatApp=null,this._backPlane=null,this._backPlaneGAS=null,this._backPlaneMatApp=null,this._backBorder=null,this._backBorderGAS=null,this._backBorderMatApp=null,this._frontTextNode=null,this._backTextNode=null,this._fixedSizeFrontText=null,this._fixedSizeBackText=null,this._xArrowIndicator=null,this._xArrowIndicatorGAS=null,this._xIndicatorMatApp=null},A=t.extend({init:function(i){this._parent(i.name),this._isDynamic=!0,this.matInherit=window.newMaterialInheritance,this.fixedSize=i.fixedSize;var a=this;return this.cbChange=function(e){if(this._newLook){for(var t={},i=0;i<a._occurrences.length;i++){var r=a._occurrences[i],n=r.parent;if(r.scene3js&&n){var s=r.scene3js.viewer;if(N(r._getVisible(),r._getVisibilityFree(),s.getVisibleSpace(),null,r)){if(e&&e.viewpoint&&e.viewpoint.viewer&&s!==e.viewpoint.viewer)continue;if(t[s.id]||(t[s.id]={viewer:s,count:0}),t[s.id].count++,s._refPlaneCounter>100){a.setNewLook(!1);continue}var o=s.currentViewpoint;a._updateNode(r,i,e,o)}}}a._updateViewersCount(t)}},this.tokenChange=null,this._length=new e.Vector2(10,10),this._frontBorderMaterial=this._getBorderMaterial({color:new e.Color("green"),opacity:.7,lineWidth:2,force:!this.matInherit}),this._frontBorder=this._buildEditableRectangle(!0,this._frontBorderMaterial.color,this._frontBorderMaterial.opacity),this._frontBorderGAS=this._frontBorder._occurrences[0].renderable.geometry[0].drawingGroups[0].gas,this.matInherit?(this._frontBorderMatApp=new d({lineMaterial:this._frontBorderMaterial,layer:0}),this._frontBorder.setMaterialApplication(this._frontBorderMatApp),this._frontBorder.setMaterialMode(!0)):this._frontBorder.setMaterial(this._frontBorderMaterial),this._frontBorder.setShadow(!1),this._frontBorder.setSSAO(!1),this._frontBorder.setFrustumCulled(!1),this._frontBorder.setPickParent(!0),this._frontBorder.setPickingPriorityId({edges:"RefPlaneEdges"}),this._mainNode=new t("RefPlaneNode"),this._mainNode.setPickParent(!0),this._advanced=null,this._newLook=void 0===i.newLook||i.newLook,this._setNewLook(this._newLook),this._currentParams=null,this.setParameters(i),this._mainNode.addChild(this._frontBorder),this.fixedSize&&(this._frontBorder._setRatio(1),this._newLook&&(this._advanced._frontPlane._setRatio(1),this._advanced._backPlane._setRatio(1),this._advanced._backBorder._setRatio(1))),this.addChild(this._mainNode),this},_createTextNodes:function(e){e._frontTextNode=new t,e._backTextNode=new t,e._fixedSizeFrontText=new a({name:"fixedSizeNodeFrontText",ratio:1}),e._fixedSizeFrontText._autoUpdate=!1,e._fixedSizeBackText=new a({name:"fixedSizeNodeBackText",ratio:1}),e._fixedSizeBackText._autoUpdate=!1,e._fixedSizeFrontText.setPickable(n.NOPICKABLE),e._fixedSizeBackText.setPickable(n.NOPICKABLE),this.fixedSize?(e._subNode=new a({name:"FixedSizeForText",ratio:1}),e._subNode.addChild(e._frontTextNode),e._frontTextNode.addChild(e._fixedSizeFrontText),e._subNode.addChild(e._backTextNode),e._backTextNode.addChild(e._fixedSizeBackText),this._mainNode.addChild(e._subNode)):(this._mainNode.addChild(e._frontTextNode),this._mainNode.addChild(e._backTextNode),e._frontTextNode.addChild(e._fixedSizeFrontText),e._backTextNode.addChild(e._fixedSizeBackText))},_removeTextNodes:function(e){this.fixedSize?(e._subNode.removeChild(e._frontTextNode),e._frontTextNode.removeChild(e._fixedSizeFrontText),e._subNode.removeChild(e._backTextNode),e._backTextNode.removeChild(e._fixedSizeBackText),this._mainNode.removeChild(e._subNode)):(this._mainNode.removeChild(e._frontTextNode),this._mainNode.removeChild(e._backTextNode),e._frontTextNode.removeChild(e._fixedSizeFrontText),e._backTextNode.removeChild(e._fixedSizeBackText)),e._subNode=null,e._frontTextNode=null,e._backTextNode=null,e._fixedSizeFrontText=null,e._fixedSizeBackText=null},_initAdvancedNodes:function(t){this._mainNode.addChild(t._frontPlane),this._mainNode.addChild(t._backPlane),this._mainNode.addChild(t._backBorder),this._mainNode.addChild(t._xArrowIndicator),t._xArrowIndicator.setRatio(20),this.fixedSize?t._xArrowIndicator.setFixedSizeCenter(new e.Vector3(.5*this._length.x,0,0)):t._xArrowIndicator.setMatrix((new e.Matrix4).makeTranslation(.5*this._length.x,0,0))},_initAdvancedParameters:function(t){t._frontPlaneMaterial=this._getPlaneMaterial({color:new e.Color("green"),opacity:.2,side:0,force:!this.matInherit});var i=t._frontPlaneMaterial.color.getHSL();r=i.h+20/255,n=Math.min(1,1.3*i.l),t._backPlaneMaterial=this._getPlaneMaterial({color:(new e.Color).setHSL(r,i.s,n),opacity:.2,side:1,force:!this.matInherit});var a=this._frontBorderMaterial.color.getHSL(),r=a.h+20/255,n=Math.min(1,1.3*a.l);t._backBorderMaterial=this._getBorderMaterial({color:(new e.Color).setHSL(r,a.s,n),opacity:.7,lineWidth:2,force:!this.matInherit}),t._xIndicatorMaterial=this._getXIndicatorMaterial({color:new e.Color("green"),force:!this.matInherit}),t._margin=.02,t._frontText={data:"",color:new e.Color("green"),opacity:.7,size:.5,token:null},t._backText={data:"",color:new e.Color("green"),opacity:.7,size:.5,token:null},t._frontPlane=this._buildEditableRectangle(!1,t._frontPlaneMaterial.color,t._frontPlaneMaterial.opacity),t._frontPlaneGAS=t._frontPlane._occurrences[0].renderable.geometry[0].drawingGroups[0].gas,this.matInherit?(t._frontPlaneMatApp=new d({faceMaterial:t._frontPlaneMaterial,layer:0}),t._frontPlane.setMaterialApplication(t._frontPlaneMatApp),t._frontPlane.setMaterialMode(!0)):t._frontPlane.setMaterial(t._frontPlaneMaterial),t._frontPlane.setShadow(!1),t._frontPlane.setSSAO(!1),t._frontPlane.setFrustumCulled(!1),t._frontPlane.setPickParent(!0),t._frontPlane.excludeFromHighlight(!0,!0),t._backPlane=this._buildEditableRectangle(!1,t._backPlaneMaterial.color,t._backPlaneMaterial.opacity),t._backPlaneGAS=t._backPlane._occurrences[0].renderable.geometry[0].drawingGroups[0].gas,this.matInherit?(t._backPlaneMatApp=new d({faceMaterial:t._backPlaneMaterial,layer:0}),t._backPlane.setMaterialApplication(t._backPlaneMatApp),t._backPlane.setMaterialMode(!0)):t._backPlane.setMaterial(t._backPlaneMaterial),t._backPlane.setShadow(!1),t._backPlane.setSSAO(!1),t._backPlane.setFrustumCulled(!1),t._backPlane.setPickParent(!0),t._backPlane.excludeFromHighlight(!0,!0),t._backBorder=this._buildEditableRectangle(!0,t._backBorderMaterial.color,t._backBorderMaterial.opacity),t._backBorderGAS=t._backBorder._occurrences[0].renderable.geometry[0].drawingGroups[0].gas,this.matInherit?(t._backBorderMatApp=new d({lineMaterial:t._backBorderMaterial,layer:0}),t._backBorder.setMaterialApplication(t._backBorderMatApp),t._backBorder.setMaterialMode(!0)):t._backBorder.setMaterial(t._backBorderMaterial),t._backBorder.setShadow(!1),t._backBorder.setSSAO(!1),t._backBorder.setFrustumCulled(!1),t._backBorder.setPickParent(!0),t._backBorder.setPickingPriorityId({edges:"RefPlaneEdges"}),t._xArrowIndicator=this._buildXIndicator(t._xIndicatorMaterial.color,t._xIndicatorMaterial.opacity),t._xArrowIndicator.setShadow(!1),t._xArrowIndicator.setSSAO(!1),t._xArrowIndicatorGAS=t._xArrowIndicator._occurrences[0].renderable.geometry[0].drawingGroups[0].gas,t._displayArrowOrientation=!0,this.matInherit?(t._xIndicatorMatApp=new d({faceMaterial:t._xIndicatorMaterial,layer:0}),t._xArrowIndicator.setMaterialApplication(t._xIndicatorMatApp),t._xArrowIndicator.setMaterialMode(!0)):t._xArrowIndicator.setMaterial(t._xIndicatorMaterial),t._xArrowIndicator.excludeFromHighlight(!0,!0)},_setNewLook:function(e){var t=this._advanced;e&&!t&&(t=new P,this._advanced=t,this._initAdvancedParameters(t),this._initAdvancedNodes(t)),this._resetOccurrenceVisibility(this._frontBorder),this._frontBorder.setVisibility(!0),t&&(this._resetOccurrenceVisibility(t._backBorder),t._frontTextNode&&this._resetOccurrenceVisibility(t._frontTextNode),t._backTextNode&&this._resetOccurrenceVisibility(t._backTextNode),this._resetOccurrenceVisibility(t._xArrowIndicator),t._frontPlane.setVisibility(e),t._backPlane.setVisibility(e),t._backBorder.setVisibility(e)),this.fixedSize?this._subNode&&this._subNode.setVisibility(e):t&&(t._frontTextNode&&t._frontTextNode.setVisibility(e),t._backTextNode&&t._backTextNode.setVisibility(e),t._xArrowIndicator.setVisibility(e)),e&&this._currentParams&&(this.setParameters(this._currentParams),this._currentParams=null)},setNewLook:function(e){this._newLook!==e&&(this._newLook=e,this._setNewLook(e))},getNewLook:function(){return this._newLook},_getBorderMaterial:function(t){var i=t.color.getHexString()+"-"+t.opacity+"-"+t.lineWidth+"-"+t.force;if(y.has(i))return y.get(i);var a=new e.LineBasicMaterial({color:t.color,opacity:t.opacity,lineWidth:t.lineWidth,side:2,polite:!0,force:t.force,forceSide:!0,enableClipPlanes:!1});return a.line=a,y.set(i,a),a},_getPlaneMaterial:function(t){var i=t.color.getHexString()+"-"+t.opacity+"-"+t.side+"-"+t.force;if(D.has(i))return D.get(i);var a=new e.MeshBasicMaterial({color:t.color,opacity:t.opacity,side:t.side,polygonOffset:!0,polygonOffsetFactor:.5,force:t.force,forceSide:!0,enableClipPlanes:!1});return D.set(i,a),a},_getXIndicatorMaterial:function(t){var i=t.color.getHexString()+"-"+t.force;if(T.has(i))return T.get(i);var a=new e.MeshBasicMaterial({color:t.color,opacity:.5,side:2,force:t.force,forceSide:!0,depthTest:!1,enableClipPlanes:!1});return T.set(i,a),a},_updateTextPosition:function(e,t,i,a){var r=void 0===t,n=!r&&t,s=0;if(e){var o=e.camera,h=this._subNode?this._subNode._occurrences[a].matrix:this._occurrences[a].matrix;h.extractBasis(p,_,m),p.multiplyScalar(.5*this._length.x),_.multiplyScalar(.5*this._length.y),f.getPositionFromMatrix(h),g.addVectors(p,_),g.negate(),g.addVectors(g,f),v.subVectors(p,_),v.addVectors(v,f),S.addVectors(p,_),S.addVectors(S,f),x.subVectors(_,p),x.addVectors(x,f);var d=e.project(g,o),l=e.project(v,o),w=e.project(S,o),M=e.project(x,o),b=0,y=l.x-d.x;y>0&&(s=0,b=y),(y=w.x-l.x)>0&&y>b&&(b=y,s=1),(y=M.x-w.x)>0&&y>b&&(b=y,s=2),(y=d.x-M.x)>0&&y>b&&(b=y,s=3)}var D=s%2?this._length.y:this._length.x,T=s%2?this._length.x:this._length.y;if(r||n){c.makeRotationAxis(u,.5*Math.PI*s),c.translate(f.set(-(.5-this._advanced._margin)*D,-(.5-this._advanced._margin)*T,0));var N=this._advanced._frontTextNode._occurrences[a];N._relativeMatrix?N._relativeMatrix.copy(c):N._relativeMatrix=c.clone()}if(r||!n){c.makeRotationAxis(u,Math.PI+.5*Math.PI*s),c.rotateY(Math.PI),c.translate(f.set(-(.5-this._advanced._margin)*D,-(.5-this._advanced._margin)*T,0));var P=this._advanced._backTextNode._occurrences[a];P._relativeMatrix?P._relativeMatrix.copy(c):P._relativeMatrix=c.clone()}},_setParametersOld:function(e){e.size&&(this._length.copy(e.size),this._updateRectangleSize(this._frontBorder));var t=e.borderAttributes;if(t&&t.front){var i=void 0!==t.front.color?t.front.color:this._frontBorderMaterial.color,a=void 0!==t.front.opacity?t.front.opacity:this._frontBorderMaterial.opacity,r=void 0!==t.front.width?t.front.width:this._frontBorderMaterial.lineWidth;this._frontBorderMaterial=this._getBorderMaterial({color:i,opacity:a,lineWidth:r,force:!this.matInherit}),this.matInherit?(this._frontBorderMatApp.setParameters({lineMaterial:this._frontBorderMaterial}),this._frontBorderGAS._color.copy(i),this._frontBorderGAS._alpha=a):this._frontBorder.setMaterial(this._frontBorderMaterial)}},setParameters:function(t){if(this._currentParams=t,this._newLook){var i=this._advanced;t.size&&(this._length.copy(t.size),this._updateRectangleSize(i._frontPlane),this._updateRectangleSize(i._backPlane),this._updateRectangleSize(this._frontBorder),this._updateRectangleSize(i._backBorder),this.fixedSize?i._xArrowIndicator.setFixedSizeCenter(new e.Vector3(.5*this._length.x,0,0)):i._xArrowIndicator.setMatrix((new e.Matrix4).makeTranslation(.5*this._length.x,0,0)));var a=t.planeAttributes;if(a){if(a.front){var r=void 0!==a.front.color?a.front.color:i._frontPlaneMaterial.color,n=void 0!==a.front.opacity?a.front.opacity:i._frontPlaneMaterial.opacity;if(i._frontPlaneMaterial=this._getPlaneMaterial({color:r,opacity:n,side:0,force:!this.matInherit}),i._xIndicatorMaterial=this._getXIndicatorMaterial({color:r,force:!this.matInherit}),this.matInherit?(i._frontPlaneMatApp.setParameters({faceMaterial:i._frontPlaneMaterial}),i._xIndicatorMatApp.setParameters({faceMaterial:i._xIndicatorMaterial}),i._frontPlaneGAS._color.copy(r),i._xArrowIndicatorGAS._color.copy(r),i._frontPlaneGAS._alpha=n):(i._frontPlane.setMaterial(i._frontPlaneMaterial),i._xArrowIndicator.setMaterial(i._xIndicatorMaterial)),!a.back||!a.back.color){var s=r.getHSL(),h=s.h+20/255,d=Math.min(1,1.3*s.l),l=(new e.Color).setHSL(h,s.s,d);i._backPlaneMaterial=this._getPlaneMaterial({color:l,opacity:i._backPlaneMaterial.opacity,side:1,force:!this.matInherit}),this.matInherit?(i._backPlaneMatApp.setParameters({faceMaterial:i._backPlaneMaterial}),i._backPlaneGAS._color.copy(l)):i._backPlane.setMaterial(i._backPlaneMaterial)}}if(a.back){r=void 0!==a.back.color?a.back.color:i._backPlaneMaterial.color,n=void 0!==a.back.opacity?a.back.opacity:i._backPlaneMaterial.opacity;i._backPlaneMaterial=this._getPlaneMaterial({color:r,opacity:n,side:1,force:!this.matInherit}),this.matInherit?(i._backPlaneMatApp.setParameters({faceMaterial:i._backPlaneMaterial}),i._backPlaneGAS._color.copy(r),i._backPlaneGAS._alpha=n):i._backPlane.setMaterial(i._backPlaneMaterial)}}var c=t.borderAttributes;if(c){if(c.front){r=void 0!==c.front.color?c.front.color:this._frontBorderMaterial.color,n=void 0!==c.front.opacity?c.front.opacity:this._frontBorderMaterial.opacity;var u=void 0!==c.front.width?c.front.width:this._frontBorderMaterial.lineWidth;if(this._frontBorderMaterial=this._getBorderMaterial({color:r,opacity:n,lineWidth:u,force:!this.matInherit}),this.matInherit?(this._frontBorderMatApp.setParameters({lineMaterial:this._frontBorderMaterial}),this._frontBorderGAS._color.copy(r),this._frontBorderGAS._alpha=n):this._frontBorder.setMaterial(this._frontBorderMaterial),!c.back||!c.back.color){var p=r.getHSL();h=p.h+20/255,d=Math.min(1,1.3*p.l),l=(new e.Color).setHSL(h,p.s,d);i._backBorderMaterial=this._getBorderMaterial({color:l,opacity:i._backBorderMaterial.opacity,lineWidth:i._backBorderMaterial.lineWidth,force:!this.matInherit}),this.matInherit?(i._backBorderMatApp.setParameters({lineMaterial:i._backBorderMaterial}),i._backBorderGAS._color.copy(l)):i._backBorder.setMaterial(i._backBorderMaterial)}}if(c.back){r=void 0!==c.back.color?c.back.color:i._backBorderMaterial.color,n=void 0!==c.back.opacity?c.back.opacity:i._backBorderMaterial.opacity,u=void 0!==c.back.width?c.back.width:i._backBorderMaterial.lineWidth;i._backBorderMaterial=this._getBorderMaterial({color:r,opacity:n,lineWidth:u,force:!this.matInherit}),this.matInherit?(i._backBorderMatApp.setParameters({lineMaterial:i._backBorderMaterial}),i._backBorderGAS._color.copy(r),i._backBorderGAS._alpha=n):i._backBorder.setMaterial(i._backBorderMaterial)}}var _=""!==i._frontText.data||""!==i._backText.data,m=t.textAttributes;if(m){m.front&&(m.front.data&&(i._frontText.data=m.front.data),m.front.size&&(i._frontText.size=m.front.size),m.front.opacity&&(i._frontText.opacity=m.front.opacity),m.front.color&&i._frontText.color.copy(m.front.color)),m.back&&(m.back.data&&(i._backText.data=m.back.data),m.back.size&&(i._backText.size=m.back.size),m.back.opacity&&(i._backText.opacity=m.back.opacity),m.back.color&&i._backText.color.copy(m.back.color)),_&&(i._frontText&&i._frontText.token&&i._fixedSizeFrontText.removeChild(i._frontText.token),i._backText&&i._backText.token&&i._fixedSizeBackText.removeChild(i._backText.token));var f=""!==i._frontText.data||""!==i._backText.data;!_&&f&&this._createTextNodes(i),_&&!f&&this._removeTextNodes(i),""!==i._frontText.data&&(i._frontText.token=o.createTextNode({name:"_refplaneitem_",text:i._frontText.data,font:"Trebuchet MS",fontSize:i._frontText.size,color:i._frontText.color,depthWrite:!1}),i._frontText.token.children[0].excludeFromHighlight(!0,!0),i._fixedSizeFrontText.addChild(i._frontText.token)),""!==i._backText.data&&(i._backText.token=o.createTextNode({name:"_refplaneitem_",text:i._backText.data,font:"Trebuchet MS",fontSize:i._backText.size,color:i._backText.color,depthWrite:!1}),i._backText.token.children[0].excludeFromHighlight(!0,!0),i._fixedSizeBackText.addChild(i._backText.token))}void 0!==t.orientationArrow&&i._displayArrowOrientation!==t.orientationArrow&&(t.orientationArrow?this._mainNode.addChild(i._xArrowIndicator):this._mainNode.removeChild(i._xArrowIndicator),i._displayArrowOrientation=t.orientationArrow)}else this._setParametersOld(t)},_updateViewersCount:function(e){for(var t in e){var i=e[t],a=i.viewer._refPlaneMap.get(this.id);void 0===a&&(a=0),i.viewer._refPlaneMap.set(this.id,i.count),i.viewer._refPlaneCounter+=i.count-a}},_updateCount:function(e){for(var t={},i=0;i<this._occurrences.length;i++){var a=this._occurrences[i],r=a.parent;if(a.scene3js&&r){var n=a.scene3js.viewer;n&&(t[n.id]||(t[n.id]={viewer:n,count:0}),e?t[n.id].count=0:t[n.id].count++)}}this._updateViewersCount(t)},_onLinkedToSceneGraph:function(){var e=this;this.tokenChange=i.subscribe({event:"/VISU/"},function(t){"@onViewpointChange"===t.eventType&&e.cbChange(t)}),this.cbChange()},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenChange),this._updateCount(!0)},_getDynamicMatrix:function(){return null},_resetOccurrenceVisibility:function(e){for(var t=0;t<e._occurrences.length;t++){var i=e._occurrences[t];i._relativeVisibility=null,i.parent&&this._updateOccurrences(i.parent,i,!0,!0,!0)}},_setOccurrenceVisibility:function(e,t,i,a){var r=t?1:0;if(i||e._relativeVisibility!==r){e._relativeVisibility=r;var n=a||e;this._updateOccurrences(n.parent,n,!0,!0,!0)}},_updateNode:function(e,t,i,a){var r=this._advanced,n=a||i.viewpoint,s=n.getEyePosition(),o=e.matrix.elements;w.set(o[12],o[13],o[14]),M.subVectors(s,w),M.normalize(),b.set(o[8],o[9],o[10]);var h=M.dot(b)>0,d=""!==r._frontText.data||""!==r._backText.data;d&&this._updateTextPosition(n,h,e,t),this._setOccurrenceVisibility(this._frontBorder._occurrences[t],h),this._setOccurrenceVisibility(r._backBorder._occurrences[t],!h);var l=!1;if(d){var c=h?r._fixedSizeFrontText:r._fixedSizeBackText,u=h?r._backText.token:r._frontText.token,p=h?r._frontText.token:r._backText.token,_=h?r._backTextNode:r._frontTextNode,m=h?r._frontTextNode:r._backTextNode,f=(u._occurrences[t],p._occurrences[t]),g=_._occurrences[t],v=m._occurrences[t];this._setOccurrenceVisibility(g,!1,!1,g),c.cbChange();var S=!1;if(c._bsShow||c.getBoundingSphere(),this.fixedSize)S=1.414*(c._bsShow?c._bsShow.radius*c.getRatio():0)<=(r._frontPlane.explicitBSphere?r._frontPlane.explicitBSphere.pixelRadius:0);else S=!c._bsShow||2*c._bsShow.radius*c.getScaleFactor(t)<.9*Math.min(this._length.x,this._length.y);v._relativeVisibility=1,this._setOccurrenceVisibility(f,S,!0,v),l=l||S}if(r._displayArrowOrientation){var x=1;this.fixedSize||(x=n.camera.getWorldSizeFromPixelSize(1,w,n.viewer._getDivClientHeight()));var y=20*x<.3*Math.min(this._length.x,this._length.y);this._setOccurrenceVisibility(r._xArrowIndicator._occurrences[t],y)}this._subNode&&this._subNode.setVisibility(l)},_buildXIndicator:function(){var e=new n.PrimitiveGroup;e.fillAttr=new n.FillAttributes;var t=new n.Buffer({component:n.VertexComponentEnum.POSITION,data:new Float32Array(9)}),i=new n.Buffer({component:n.VertexComponentEnum.NORMAL,data:new Float32Array(9)});e.addBuffer(0,t),e.addBuffer(1,i);var a=t.data,r=0;a[r++]=-1,a[r++]=-.3,a[r++]=0,a[r++]=-.25,a[r++]=0,a[r++]=0,a[r++]=-1,a[r++]=.3,a[r++]=0,a=i.data,r=0;for(var s=0;s<3;s++)a[r++]=0,a[r++]=0,a[r++]=1;var h=new n.Primitive({nbIndices:3,connectivity:n.ConnectivityTypeEnum.TRIANGLES,fillGAS:new n.FillAttributes}),d=new n.VertexComponent({nbVertices:3,bufferId:0}),c=new n.VertexComponent({nbVertices:3,bufferId:1});h.addVertexComponent(d),h.addVertexComponent(c),e.addPrimitive(h);var u=o.createMeshNode(e,l);return u.name="_refplaneitem_",u},_buildEditableRectangle:function(e,t,i){var a=new n.PrimitiveGroup;a.editable=!0,a.fillAttr=new n.FillAttributes,a.lineAttr=new n.LineAttributes,a.pointAttr=new n.PointAttributes;var r=new n.Buffer({component:n.VertexComponentEnum.POSITION,data:new Float32Array(12)}),s=new n.Buffer({component:n.VertexComponentEnum.NORMAL,data:new Float32Array(12)}),h=new n.Buffer({indexBuffer:!0,data:new Uint16Array(e?8:6)});a.addBuffer(0,r),a.addBuffer(1,s),a.addBuffer(2,h);var d=h.data,c=0;e?(d[0]=0,d[1]=1,d[2]=1,d[3]=2,d[4]=2,d[5]=3,d[6]=3,d[7]=0):(d[c++]=0,d[c++]=1,d[c++]=2,d[c++]=0,d[c++]=2,d[c++]=3),c=0,(d=r.data)[c++]=.5*this._length.x,d[c++]=-.5*this._length.y,d[c++]=0,d[c++]=.5*this._length.x,d[c++]=.5*this._length.y,d[c++]=0,d[c++]=-.5*this._length.x,d[c++]=.5*this._length.y,d[c++]=0,d[c++]=-.5*this._length.x,d[c++]=-.5*this._length.y,d[c++]=0,d=s.data,c=0;for(var u=0;u<4;u++)d[c++]=0,d[c++]=0,d[c++]=1;var p=new n.Primitive({nbIndices:e?8:6,connectivity:e?n.ConnectivityTypeEnum.LINES:n.ConnectivityTypeEnum.TRIANGLES,fillGAS:new n.FillAttributes(new n.Color(t.r,t.g,t.b,i)),lineGAS:new n.LineAttributes(new n.Color(t.r,t.g,t.b,i))}),_=new n.VertexComponent({nbVertices:4,bufferId:0,indices:new n.IndexArray({bufferId:2,offset:0})}),m=new n.VertexComponent({nbVertices:4,bufferId:1,indices:new n.IndexArray({bufferId:2,offset:0})});p.addVertexComponent(_),p.addVertexComponent(m),a.addPrimitive(p);var f=o.createMeshNode(a,l);return f.name="_refplaneitem_",f},_updateRectangleSize:function(t){var i=t.getBuffer(n.VertexComponentEnum.POSITION);i[0]=.5*this._length.x,i[1]=-.5*this._length.y,i[3]=.5*this._length.x,i[4]=.5*this._length.y,i[6]=-.5*this._length.x,i[7]=.5*this._length.y,i[9]=-.5*this._length.x,i[10]=-.5*this._length.y,t.updateBuffer(n.VertexComponentEnum.POSITION,0,4);var a=Math.sqrt(.25*this._length.x*this._length.x+.25*this._length.x*this._length.x),r=new e.Sphere(new e.Vector3(0,0,0),a),s=new e.Box3(new e.Vector3(-.5*this._length.x,-.5*this._length.y,0),new e.Vector3(.5*this._length.x,.5*this._length.y,0));t.forceBoundingElements(!0,{sphere:r,box:s})}});return UWA.namespace("THREEDS/Nodes/RefPlaneNode",A)}),define("DS/SceneGraphNodes/CanvasNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/SceneGraphNodes/CanvasNodeTexture"],function(e,t,i,a,r){"use strict";var n=t.extend({init:function(t,i){this._parent(t.name),this._isDynamic=!0,this.bottomLeftCorner=t.bottomLeftcorner,this.vectors={},this.vectors.width=t.widthVector,this.vectors.height=t.heightVector,this.canvasNodeTexture=t.canvasNodeTexture,this.requestTextureUpdate=!0;var r=t.side?t.side:e.FrontSide,n=t._noZPriority?t._noZPriority:-1;this.rectangle=function(t,i,r,n,s,o,h,d){var l,c,u,p,_,m,f,g,v,S,x,w,M,b,y;for(10,(l=new a.PrimitiveGroup).fillAttr=new a.FillAttributes,l.lineAttr=new a.LineAttributes,l.pointAttr=new a.PointAttributes,(c=new a.Buffer).size=12,c.component=a.VertexComponentEnum.POSITION,c.format=a.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(c.size),(u=new a.Buffer).size=3,u.component=a.VertexComponentEnum.NORMAL,u.format=a.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(u.size),(p=new a.Buffer).size=12,p.component=a.VertexComponentEnum.TEX_COORD_0,p.format=a.DataTypeEnum.FLOAT,p.dimension=3,p.data=new Float32Array(p.size),(_=new a.Buffer).indexBuffer=!0,_.size=4,_.format=a.DataTypeEnum.UINT,_.dimension=1,_.data=new Uint16Array(_.size),(m=new a.Buffer).indexBuffer=!0,m.size=4,m.format=a.DataTypeEnum.UINT,m.dimension=1,m.data=new Uint16Array(m.size),(f=new a.Buffer).indexBuffer=!0,f.size=4,f.format=a.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(f.size),l.addBuffer(0,c),l.addBuffer(1,u),l.addBuffer(2,_),l.addBuffer(3,m),l.addBuffer(4,p),l.addBuffer(5,f),y=_.data,M=0,y[M++]=0,y[M++]=1,y[M++]=3,y[M++]=2,y=m.data,M=0,b=0;b<1;b++)y[M++]=b,y[M++]=b,y[M++]=b,y[M++]=b;y=f.data,M=0,y[M++]=0,y[M++]=1,y[M++]=3,y[M++]=2,y=c.data,M=0,y[M++]=i.x,y[M++]=i.y,y[M++]=i.z,y[M++]=i.x+r.x,y[M++]=i.y+r.y,y[M++]=i.z+r.z,y[M++]=i.x+r.x+n.x,y[M++]=i.y+r.y+n.y,y[M++]=i.z+r.z+n.z,y[M++]=i.x+n.x,y[M++]=i.y+n.y,y[M++]=i.z+n.z,y=u.data,M=0;var D=(new e.Vector3).crossVectors(r,n).normalize();y[M++]=D.x,y[M++]=D.y,y[M++]=D.z;var T=s?1:n.length()/r.length();y=p.data,M=0,y[M++]=0,y[M++]=1-T,y[M++]=0,y[M++]=1,y[M++]=1-T,y[M++]=0,y[M++]=1,y[M++]=1,y[M++]=0,y[M++]=0,y[M++]=1,y[M++]=0;var N=o==e.DoubleSide?0:1;for(b=0;b<1;b++)(g=new a.Primitive).nbIndices=4,g.connectivity=a.ConnectivityTypeEnum.TRIANGLE_STRIP,g.attr={fill:new a.FillAttributes(new a.Color(1-b/6,0,b/6,1),N),line:new a.LineAttributes,point:new a.PointAttributes},(v=new a.VertexComponent).component=a.VertexComponentEnum.POSITION,v.nbVertices=4,v.nbValuesPerVertex=3,v.format=a.DataTypeEnum.FLOAT,v.cardinality=0,v.bufferId=0,v.indices=new a.IndexArray,v.indices.format=a.DataTypeEnum.UINT,v.indices.bufferId=2,v.indices.offset=4*b,(S=new a.VertexComponent).component=a.VertexComponentEnum.NORMAL,S.nbVertices=4,S.nbValuesPerVertex=3,S.format=a.DataTypeEnum.FLOAT,S.cardinality=0,S.bufferId=1,S.indices=new a.IndexArray,S.indices.format=a.DataTypeEnum.UINT,S.indices.bufferId=3,S.indices.offset=4*b,(x=new a.VertexComponent).component=a.VertexComponentEnum.TEX_COORD_0,x.nbVertices=4,x.nbValuesPerVertex=3,x.format=a.DataTypeEnum.FLOAT,x.cardinality=0,x.bufferId=4,x.indices=new a.IndexArray,x.indices.format=a.DataTypeEnum.UINT,x.indices.bufferId=5,x.indices.offset=0,g.addVertexComponent(v),g.addVertexComponent(S),g.addVertexComponent(x),l.addPrimitive(g);return(w=h.createMeshNode(l,t,void 0,void 0,d)).setShadow(!1),w}(null,this.bottomLeftCorner,this.vectors.width,this.vectors.height,t.canvasNodeTexture.rectangleTexture,r,i,n),this.rectangle.name=void 0!==t.name?t.name:"";var s=this;return this.rectangle._setBeforeRenderCB(function(e,t){s.requestTextureUpdate&&t.viewpoint&&s._textureUpdate(e,t.viewpoint,t.camera)}),this.rectangle.setSSAO(!1),this.rectangle.setMirror(!1),this.addChild(this.rectangle),this.cbChange=function(e){"@onViewpointChange"===e.eventType&&s._onViewpointChange()},this.tokenChange=null,this},setFrustumCulled:function(){this.rectangle.setFrustumCulled.apply(this.rectangle,arguments)},_onLinkedToSceneGraph:function(){this.tokenChange=i.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){var e;for(i.unsubscribe(this.tokenInit),i.unsubscribe(this.tokenChange),e=0;e<this.rectangle._occurrences.length;e++){var t=this.rectangle._occurrences[e].renderable;if(t.material){var a;if(this.canvasNodeTexture._releaseMaterial(t.material),t.material=null,t.highlightMeshes)for(a=0;a<t.highlightMeshes.length;a++)t.highlightMeshes[a].renderable.material=null;t.preHighlight&&(t.preHighlight.material=null)}}},_getDynamicMatrix:function(e,t,i){return this._onViewpointChange(),this.getMatrix()},_onViewpointChange:function(){this.requestTextureUpdate=!0},_textureUpdate:function(t,i,a){a.position;var r=this.bottomLeftCorner.clone(),n=this.vectors[this.canvasNodeTexture.longestEdge],s=new e.Vector3(r.x+n.x,r.y+n.y,r.z+n.z),o=t._getMMMatrix();r.applyMatrix4(o),s.applyMatrix4(o);var h=i.project(r,a),d=i.project(s,a),l=h.distanceTo(d),c=t.material,u=this.canvasNodeTexture._getNewMaterial(l,c);if(u){var p;if(t.material=u,t.highlightMeshes)for(p=0;p<t.highlightMeshes.length;p++)t.highlightMeshes[p].renderable.material=u;t.preHighlight&&(t.preHighlight.material=u),t._flagAsGSSOInvalidated()}}});return UWA.namespace("THREEDS/Nodes/CanvasNode",n)}),define("DS/SceneGraphNodes/CurvedPipeBatchDummyNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/SceneGraphNodes/InstancedCurvedPipeManager"],function(e,t,i,a){"use strict";var r=t.extend({init:function(t){this._name=t.name||"curvedPipeBatchDummy",this._pipes=[],this._maxRadius=0,this.dummyGeom=new e.BufferGeometryDS;for(var r=0,n=new Map,s=0;s<t.curvedPipes.length;s++){var o=t.curvedPipes[s],h=!!o.material,d=o.gas.id;h&&(d+="_"+o.material.id);var l=n.get(d);if(void 0===l){l=r,n.set(d,r++);var c=new i.DrawingGroup(o.gas,h?o.material:null,4);this.dummyGeom.drawingGroups.push(c)}this._pipes.push({curvePoints:o.curvePoints,radius:o.radius,baseNormal:o.baseNormal.normalize(),endNormal:o.endNormal.normalize(),baseSideVector:o.baseSideVector.normalize(),material:h?o.material:null,gas:o.gas,dgId:l}),o.radius>this._maxRadius&&(this._maxRadius=o.radius)}var u=new e.CurvedPipeMesh(this.dummyGeom);u.castShadow=!0,u._capWorldRadius=this._maxRadius,u._nbLODsMinusOne=a._nbLODs-1,this._parent(u);var p=this._curvedPipeBBox();return this.forceBoundingBox(p),this},createRenderable:function(){var e=this._parent();return e.isCurvedPipe=!0,e},setMaterial:function(e,t){this._parent(t);for(var i=this._occurrences.length,a=0;a<i;a++)this._occurrences[a].renderable.material=t},setMatrix:function(e){this._parent(e);for(var t=this._occurrences.length,i=null,r=0;r<t;r++)i=this._occurrences[r].renderable,a.setMatrixOnCurvedPipe(i),i._capWorldRadius=this._maxRadius*i.matrixWorld.getMaxScaleOnAxis()},_curvedPipeBBox:function(){for(var t=new e.Vector3(1/0,1/0,1/0),i=new e.Vector3(-1/0,-1/0,-1/0),a=new e.Vector3,r=new e.Vector3,n=new e.Vector3,s=new e.Vector3,o=new e.Vector3,h=new e.Vector3,d=new e.Vector3,l=new e.Vector3,c=null,u=0;u<this._pipes.length;u++)for(var p=this._pipes[u].curvePoints,_=this._pipes[u].radius,m=p.length/3-1,f=0;f<m;f++){r.set(p[3*f],p[3*f+1],p[3*f+2]),n.set(p[3*f+3],p[3*f+4],p[3*f+5]),a.subVectors(n,r);var g=a.dot(a);s.set(_*Math.sqrt(1-a.x*a.x/g),_*Math.sqrt(1-a.y*a.y/g),_*Math.sqrt(1-a.z*a.z/g)),o.subVectors(r,s),d.subVectors(n,s),o.min(d),h.addVectors(r,s),l.addVectors(n,s),h.max(l),c=new e.Box3(o,h),t.min(c.min),i.max(c.max)}var v=(new e.Vector3).addVectors(t,i).multiplyScalar(.5),S=(new e.Vector3).addVectors(v,(new e.Vector3).subVectors(t,v).multiplyScalar(1.05)),x=(new e.Vector3).addVectors(v,(new e.Vector3).subVectors(i,v).multiplyScalar(1.05));return new e.Box3(S,x)},_onLinkedToSceneGraph:function(){this._parent();for(var e=this._occurrences,t=e.length,i=null,r=0;r<t;r++){i=e[r].renderable;for(var n=0;n<this._pipes.length;n++){var s=this._pipes[n];a.addCurvedPipe(i,s.dgId,s.radius,s.curvePoints,s.baseNormal,s.endNormal,s.baseSideVector)}}},_onUnlinkedToSceneGraph:function(){this._parent();for(var e=this._occurrences,t=e.length,i=null,r=0;r<t;r++)i=e[r].renderable,a.removeCurvedPipe(i,this)},setName:function(e){this._name=e},getNodeType:function(){return"Mesh3D"}});return UWA.namespace("THREEDS/Nodes/CurvedPipeBatchDummyNode",r)}),define("DS/SceneGraphNodes/ArrowNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory"],function(e,t,i,a,r,n,s,o,h){"use strict";var d=new e.Vector3,l=new e.Matrix4,c=new e.Matrix4,u=new e.Matrix4,p=t.extend({init:function(i){this._parent(i.name),this._isDynamic=!0,this._headLength=i.headLength?i.headLength:20,this.viewpoint=i.viewpoint,this._initialPoint=i.initialPoint,this._finalPoint=i.finalPoint,this._head=i.head?i.head:0,this._noZ=!i.removeNoZ,this.direction=(new e.Vector3).subVectors(this._finalPoint,this._initialPoint),this.constraintAxis=(new e.Vector3).copy(this.direction).normalize(),this.arrowLength=this.direction.length();var a=n.getWebappsAssetUrl("SceneGraphNodes","");this.mapHead=new e.ImageUtils.loadTexture(a+"models/textures/head.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHeadDisk=new e.ImageUtils.loadTexture(a+"models/textures/headDisk.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHeadSquare=new e.ImageUtils.loadTexture(a+"models/textures/headSquare.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHeadCross=new e.ImageUtils.loadTexture(a+"models/textures/headCross.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHead.anisotropy=8,this.materialArrow=new e.LineBasicMaterial({side:e.DoubleSide,color:i.color,scale:i.arrowScale?i.arrowScale:6.666,lineWidth:i.arrowWidth?i.arrowWidth:1,dashType:i.arrowDashType?i.arrowDashType:"None",linecap:"butt",transparent:!0,isCPUPattern:!0,alphaTest:.05}),this.materialArrow.force=!0,this.materialHead=new e.MeshBasicMaterial({map:null,side:e.DoubleSide,color:i.color,transparent:!0,alphaTest:.05}),this.materialHead.force=!0;var s=new o;this.nodeArrowBody=h.createLineNode({points:[new e.Vector3(0,0,0),new e.Vector3(0,0,1)],material:this.materialArrow,layerNb:this._noZ?1:0}),this.nodeArrowBody.setShadow(!1),this.nodeArrowBody.setFrustumCulled(!1),this.nodeArrowBody.setPickParent(!0),this.nodeArrowBody.name="tronc de la flèche";var d={constraintAxis:this.constraintAxis,name:"billBoardNode_body",type:"Cylindrical",viewpoint:this.viewpoint};this.billBoardArrowBody=new r(d),this.billBoardArrowBody.addChild(this.nodeArrowBody),this.billBoardArrowBody.setPickParent(!0),this.addChild(this.billBoardArrowBody);var l=s.createRectangle({width:1,height:1,fill:!0,fillColor:null,noEdge:!0,layerNb:this._noZ?1:0});this.nodeArrowHead=h.createMeshNode(l,this.materialHead),this.nodeArrowHead.setShadow(!1),this.nodeArrowHead.setFrustumCulled(!1),this.nodeArrowHead.setPickParent(!0),this.nodeArrowHead.name="tête de la flèche",this.billBoardArrowHead=new r({name:"billBoardNode_head",viewpoint:this.viewpoint}),this.billBoardArrowHead.addChild(this.nodeArrowHead),this.billBoardArrowHead.setPickParent(!0),this.nodeArrowHeadParent=new t,this.nodeArrowHeadParent.setPickParent(!0),this.addChild(this.nodeArrowHeadParent),this.nodeArrowHeadParent.addChild(this.billBoardArrowHead),this._updateData(),this.setMatrix((new e.Matrix4).setPosition(this._initialPoint)),this.name="CustomizableArrow";var c=this;return this.cbChange=function(e){c.viewpoint&&c.viewpoint!==e.viewpoint||"@onViewpointChange"===e.eventType&&c._CallBackEventHandler(e)},this.tokenChange=null,this},_onLinkedToSceneGraph:function(){this.tokenChange=i.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenChange)},_getDynamicMatrix:function(e,t,i){return this._CallBackEventHandler(t,i),this.getMatrix()},_CallBackEventHandler:function(e,t){var i=this.getMatrixWorld().getMaxScaleOnAxis();d.getPositionFromMatrix(this.nodeArrowHead.getMatrixWorld());var a=t||e.viewpoint,r=1/(i/a.camera.getWorldSizeFromPixelSize(1,d,a.viewer._getDivClientHeight()))*(this._head?this._headLength:0),n=this._head>=2?this.arrowLength:this.arrowLength-r;l.makeScale(r,r,r),c.makeScale(1,1,n),1===this._head?(this.nodeArrowHeadParent.setMatrix(u),d.set(-r/2,0,0),this.nodeArrowHead.setMatrix(l.rotateX(.5*Math.PI).setPosition(d)),d.copy(this.constraintAxis).multiplyScalar(n),l.identity(),this.nodeArrowHeadParent.setMatrix(l.setPosition(d))):2!==this._head&&3!==this._head&&4!==this._head||(d.set(-r/2,-r/2,0),this.nodeArrowHead.setMatrix(l.setPosition(d)),d.copy(this.constraintAxis).multiplyScalar(n),l.identity(),this.nodeArrowHeadParent.setMatrix(l.setPosition(d))),this.nodeArrowBody.setMatrix(c),this.billBoardArrowBody.cbChange(e),this.billBoardArrowHead.cbChange(e)},updateInitialPosition:function(t){this._initialPoint=t,this.setMatrix((new e.Matrix4).setPosition(this._initialPoint)),this._updateData(),this._CallBackEventHandler({viewpoint:this.viewpoint})},updateFinalPosition:function(e){this._finalPoint=e,this._updateData(),this._CallBackEventHandler({viewpoint:this.viewpoint})},updateColor:function(e){this.materialArrow.color=e,this.materialHead.color=e},setArrowWidth:function(e){this.materialArrow.setLineWidth(e),this._CallBackEventHandler({viewpoint:this.viewpoint})},setArrowPattern:function(e){this.materialArrow.setDashPatternType(e),this._CallBackEventHandler({viewpoint:this.viewpoint})},setArrowPatternScale:function(e){this.materialArrow.setScale(e),this._CallBackEventHandler({viewpoint:this.viewpoint})},setHeadSize:function(e){this._headLength=e,this._CallBackEventHandler({viewpoint:this.viewpoint})},setHeadType:function(e){this._head=e,this._updateData(),this._CallBackEventHandler({viewpoint:this.viewpoint})},getNodeType:function(){return"ArrowNode"},_updateData:function(){switch(this.direction.subVectors(this._finalPoint,this._initialPoint),this.constraintAxis.copy(this.direction).normalize(),this.arrowLength=this.direction.length(),this.billBoardArrowBody.setConstraintAxis(this.constraintAxis),this._head){case 0:this.billBoardArrowHead.setVisibility(!1),this.billBoardArrowHead.setVisibilityFree(!0);break;case 1:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setConstraintAxis(this.constraintAxis),this.billBoardArrowHead.setBillboardType("PseudoSpherical"),this.materialHead.map=this.mapHead;break;case 2:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setBillboardType("Spherical"),this.materialHead.map=this.mapHeadDisk;break;case 3:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setBillboardType("Spherical"),this.materialHead.map=this.mapHeadSquare;break;case 4:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setBillboardType("Spherical"),this.materialHead.map=this.mapHeadCross}this.materialHead._invalidateDisplayRangeLists(),this.materialHead.updateDeferredMaterials()}});return p.types={NONE:0,ARROW:1,DISK:2,SQUARE:3,CROSS:4},UWA.namespace("THREEDS/Nodes/ArrowNode",p)}),define("SceneGraphNodes/ArrowNode",["DS/SceneGraphNodes/ArrowNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/ArrowNode"),e}),define("DS/SceneGraphNodes/CSS2DNodeManager",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/SceneGraphNodes/CSS2DNode"],function(e,t,i,a,r){"use strict";return e.extend({options:{},init:function(e){this.billboards=[],this._divLayers=[],this.mainLayer=document.createElement("div"),this.mainLayer.id="HTMLBillboards",e.divCss2DElement.appendChild(this.mainLayer),this.viewer=e,this.rank=4,this._subscribe(),this.update()},add:function(e,t){if(!(e instanceof r))return error.log("This is not a CSS2DNode");e.rank=t&&t.rank||0,e.vanish=t&&t.vanish||!1,this.billboards.push(e),this._divLayers[e.rank]||(this._divLayers[e.rank]=document.createElement("div"),this._divLayers[e.rank].id="layer-"+e.rank,this.mainLayer.appendChild(this._divLayers[e.rank])),this._divLayers[e.rank].appendChild(e.css2DNode.element),this.update()},remove:function(e){-1!==this.billboards.indexOf(e)&&this.billboards.splice(this.billboards.indexOf(e),1)},update:function(){this.cameraPosition=this.viewer.viewpoints[0].camera.position;var e=this.viewer.getSceneBoundingSphere();this.centerScene=e.center,this.fadingDistance=e.radius;var t=0,i=this.billboards.length;for(t=0;t<i;++t)this._follow3D(this.billboards[t]);this._zIndexManager()},_subscribe:function(){var e=this;t.subscribe({event:"/VISU/"},function(t){"@onViewpointChange"===t.eventType&&e.update.call(e)}),t.subscribe({event:"/VISU/onWindowResized"},function(t){e.update.call(e)})},_follow3D:function(e){if(e.css2DNode.visible){if(e.css2DNode.element.style.display="initial",e.rank>this.rank)return void(e.css2DNode.element.style.display="none");if(e.vanish){var t=1-(e.css2DNode.position.clone().distanceTo(this.cameraPosition)-5*this.fadingDistance)/(15*this.fadingDistance-5*this.fadingDistance);t<0?e.css2DNode.element.style.display="none":t<1&&(e.css2DNode.element.style.opacity=t)}}},_zIndexManager:function(){var e=this.cameraPosition;this.billboards.sort(function(t,i){return e.distanceTo(i.css2DNode.position)-e.distanceTo(t.css2DNode.position)});var t=0,i=this.billboards.length;for(t=0;t<i;++t)this.billboards[t].css2DNode.element.style["z-index"]=t}})}),define("SceneGraphNodes/CSS2DNodeManager",["DS/SceneGraphNodes/CSS2DNodeManager","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/CSS2DNodeManager"),e}),define("DS/SceneGraphNodes/AxisSystemNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/FixedSizeArrowNode","DS/SceneGraphNodes/ArrowNode"],function(e,t,i,a,r,n,s,o,h,d){"use strict";var l=t.extend({init:function(t){this._parent(t.name),this._sgRep=t.sgRep?t.sgRep:null,this.headLength=t.headLength,this.arrowLength=t.arrowLength,this.arrowWidth=t.arrowWidth,this.sceneGraph=t.sceneGraph,this.viewpoint=t.viewpoint,this.zoomable=t.zoomable||!1,this._colorX=new s.Color(1,0,0),this._colorY=new s.Color(0,1,0),this._colorZ=new s.Color(0,0,1),t.colors&&(this._colorX=t.colors.colorX?t.colors.colorX:this._colorX,this._colorY=t.colors.colorY?t.colors.colorY:this._colorY,this._colorZ=t.colors.colorZ?t.colors.colorZ:this._colorZ),this._nameX="X",this._nameY="Y",this._nameZ="Z",t.names&&(this._nameX=t.names.nameX?t.names.nameX:this._nameX,this._nameY=t.names.nameY?t.names.nameY:this._nameY,this._nameZ=t.names.nameZ?t.names.nameZ:this._nameZ),this.head=t.head;var i={sceneGraph:this.sceneGraph,headLength:this.headLength,color:this._colorZ,arrowLength:this.arrowLength,arrowWidth:this.arrowWidth,head:this.head,name:this._nameZ,pickable:!0,viewpoint:this.viewpoint,removeNoZ:!0},a=null;this.zoomable?(i.initialPoint=new e.Vector3,i.finalPoint=new e.Vector3(0,0,this.arrowLength),a=new d(i)):a=new h(i);var r={sceneGraph:this.sceneGraph,headLength:this.headLength,direction:new e.Vector3(1,0,0),color:this._colorX,arrowLength:this.arrowLength,arrowWidth:this.arrowWidth,head:this.head,name:this._nameX,pickable:!0,viewpoint:this.viewpoint,removeNoZ:!0},n=null;this.zoomable?(r.initialPoint=new e.Vector3,r.finalPoint=new e.Vector3(this.arrowLength,0,0),n=new d(r)):(n=new h(r)).setMatrix((new e.Matrix4).rotateY(Math.PI/2));var o={sceneGraph:this.sceneGraph,headLength:this.headLength,color:this._colorY,arrowLength:this.arrowLength,arrowWidth:this.arrowWidth,head:this.head,name:this._nameY,pickable:!0,viewpoint:this.viewpoint,removeNoZ:!0},l=null;return this.zoomable?(o.initialPoint=new e.Vector3,o.finalPoint=new e.Vector3(0,this.arrowLength,0),l=new d(o)):(l=new h(o)).setMatrix((new e.Matrix4).rotateX(-Math.PI/2)),this.addChild(l),this.addChild(n),this.addChild(a),this.setNoZ(!0),this},getNodeType:function(){return"AxisSystemNode"},getSGRep:function(){return this._sgRep}});return l.types={NONE:null,ARROW:1,DISK:2},UWA.namespace("THREEDS/Nodes/AxisSystemNode",l)}),define("SceneGraphNodes/AxisSystemNode",["DS/SceneGraphNodes/AxisSystemNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/AxisSystemNode"),e}),define("DS/SceneGraphNodes/FixedSizePlaneNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory"],function(e,t,i,a,r,n,s,o,h){"use strict";var d=t.extend({init:function(i){this._parent(i.name),this.setColor(i.color),this.setName(i.name);var a=i.length1?i.length1:10,r=i.length2?i.length2:10,n=i.origin?i.origin:new e.Vector3,s=i.direction1?i.direction1.normalize():new e.Vector3(0,1,0),o=i.direction2?i.direction2.normalize():new e.Vector3(1,0,0),d=(new e.Vector3).crossVectors(s,o),l=h.createRectangleNode({color:this._color,width:a,height:r,fill:i.fill,sharing:i.sharing,cornerPoint:new e.Vector2(-a/2,-r/2)});l.setShadow(!1),l.setFrustumCulled(!1);var c=new e.Matrix4;c.makeBasis(s,o,d),c.setPosition(n);var u=new t("NodeForPlane");return u.setMatrix(c),u.addChild(l),this.addChild(u),u._setRatio(1),this},setColor:function(e){this._color=e},setName:function(e){this._name=e}});return UWA.namespace("THREEDS/Nodes/FixedSizePlaneNode",d)});