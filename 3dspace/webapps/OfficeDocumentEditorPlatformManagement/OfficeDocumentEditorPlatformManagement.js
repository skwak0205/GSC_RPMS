define("DS/OfficeDocumentEditorPlatformManagement/OfficeDocumentEditorPlatformManagement",["UWA/Core","UWA/Utils","UWA/Event","DS/UWPClientCode/Navigation","DS/UIKIT/Spinner","DS/UIKIT/Input/Button","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/File","DS/UIKIT/Alert","DS/UIKIT/Form","DS/OfficeDocumentEditorClient/Utils","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI","i18n!OfficeDocumentEditorPlatformManagement/assets/nls/widget","css!OfficeDocumentEditorPlatformManagement/OfficeDocumentEditorPlatformManagement"],function(e,t,n,r,o,a,i,s,l,c,p,d,m,u){"use strict";const f="ode-spinner-"+t.getUUID(),b=t=>{const n=e.createElement("div",{styles:{position:"absolute",top:"0",bottom:"0",right:"0",left:"0",background:"rgba(255,255,255,0.6)"}});n.inject(t);const r=new o;return r.elements.container.setStyles({position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:1}),r.elements.container.set("id",f),r.inject(n),r.show(),n},E=e=>{e&&null!==e.elements&&e.destroy()},h=e.createElement("div",{class:"alert-container"}),g=["word","spreadsheet","presentation"];let y="";const O=top.require("DS/Dashboard/PublicAPI")._getGlobalPlatformId(),D="true"===m.getApplicationConfiguration("app.ode.tenant_templates.enabled"),j={load:function(){widget.body.empty(),widget.setTitle(u.widget_title),h.inject(widget.body);const e=[],n={nbOnCompleted:0,nbError:0},r={},o=()=>{if(!(n.nbOnCompleted<e.length)){if(n.nbError>0)return E(a),void j.notify(u["error.UNKNOWN"]);E(a),j.displayContent(r.tenantGranted,r.templates||[])}},a=b(widget.body);p.getOfficeDocumentEditorServiceUrl(O).then(a=>{y=a,e.push(()=>{((e,n)=>{const r=t.parseUrl(e);return r.path="/acl/get.json",r.query=`tenant=${n}`,new Promise((e,n)=>{d.handleRequest(t.composeUrl(r),{method:"GET",type:"json",responseType:"json",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:(t,r)=>{t&&t.data?t.error?n(new Error(JSON.stringify(t.error))):e(t):n(new Error("unexpected response"))},onFailure:n,onTimeout:n,authentication:"passport"})})})(y,O).then(e=>{if(e&&e.error)return void(n.nbError=n.nbError+1);let t={};e&&e.data&&(t=e.data),r.tenantGranted=t}).catch(()=>{n.nbError=n.nbError+1}).finally(()=>{n.nbOnCompleted=n.nbOnCompleted+1,o()})}),D&&e.push(()=>{((e,n)=>{const r=t.parseUrl(e);return r.path="/template/get.json",r.query=`tenant=${n}`,new Promise((e,n)=>{d.handleRequest(t.composeUrl(r),{method:"GET",type:"json",responseType:"json",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:(t,r)=>{t&&t.data?t.error?n(new Error(JSON.stringify(t.error))):e(t):n(new Error("unexpected response"))},onFailure:n,onTimeout:n,authentication:"passport"})})})(y,O).then(e=>{if(e&&e.error)return void(n.nbError=n.nbError+1);let t={};e&&e.data&&(t=e.data),r.templates=t}).catch(()=>{n.nbError=n.nbError+1}).finally(()=>{n.nbOnCompleted=n.nbOnCompleted+1,o()})}),e.forEach(e=>{e()})}).catch(e=>{E(a);let t=e;p.isErrorSupported(t)||(t=p.ERROR.UNKNOWN),t!==p.ERROR.SERVICE_NOT_FOUND?j.notify(u[`error.${t}`]||u["error.UNKNOWN"]):j.displayErrorContent(u.access_denied)})},notify:function(t,n){let r="error";["warning","error"].indexOf(n)>-1?r=n:"success"===n&&(r=n),new l({closable:!0,className:"officedocumenteditor-notify",visible:!0,autoHide:!0,hideDelay:3e3,messages:[{message:e.createElement("div",{html:[e.createElement("span",{text:t})]}),className:r}]}).inject(h)},displayErrorContent:t=>{const n=e.createElement("div",{styles:{height:"100%",display:"flex","flex-direction":"column","align-items":"stretch"}});n.setText(t),n.inject(widget.body)},displayContent:(t,n)=>{let r=!1;t&&t.tenant&&!t.tenant.startsWith("denied")&&(r=!0);const o={enableODEIntegration:r},l=e.createElement("div",{styles:{height:"100%",display:"flex","flex-direction":"column","align-items":"stretch"}});l.inject(widget.body);const c=e.createElement("form",{events:{submit:function(e){e.preventDefault();const t={};return this.enableODEIntegration.checked!==o.enableODEIntegration&&(t.enableODEIntegration=this.enableODEIntegration.checked),g.forEach(e=>{const n=document.querySelector(`[name=ode_${e}_template]`);null!=n&&n.files.length>0&&n.files[0].size>0&&(t[`ode_${e}_template`]=n.files[0])}),0!==Object.keys(t).length&&(j.onSubmit(t,o),!1)}}});c.inject(l);const p=new i({type:"checkbox",value:"enabled",name:"enableODEIntegration",className:"primary",label:u.enable_or_disable_ode});if(p.inject(c),o.enableODEIntegration&&p.check(),D){const t=e.createElement("div",{styles:{margin:"15px 0"}});t.inject(c),g.forEach(r=>{const o=e.createElement("div",{styles:{marginTop:"20px",fontWeight:"bold"}});o.setText(u[`form_file_${r}_title`]),o.inject(t);const a=n.find(e=>e.kind===r);if(a){const n=e.createElement("a",{href:a.template_url,target:"_blank",rel:"noopener",styles:{paddingBottom:"10px"}});n.setText(a.original_filename),n.inject(t)}new s({multiple:!1,name:`ode_${r}_template`}).inject(t);const i=e.createElement("div",{styles:{color:"#77797c"}});i.setText(u[`form_file_${r}_helper`]),i.inject(t)})}new a({value:u.form_submit,className:"primary",attributes:{type:"submit"},disabled:!1}).inject(c)},onSubmit:(e,n)=>{const r=[],o={nbOnCompleted:0,nbError:0},a=()=>{if(!(o.nbOnCompleted<r.length)){if(o.nbError>0)return E(i),void j.notify(u.save_error);E(i),j.notify(u.save_success,"success"),setTimeout(j.load,700)}};if(void 0!==e.enableODEIntegration&&r.push(()=>{((e,n,r)=>{const o=t.parseUrl(e);o.path="/acl/add.json";const a=Object.assign({tenant:n},r);return new Promise((e,n)=>{d.handleRequest(t.composeUrl(o),{method:"POST",data:JSON.stringify(a),type:"json",responseType:"json",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:(t,r)=>{t&&t.success?t.error?n(new Error(JSON.stringify(t.error))):e(t):n(new Error("unexpected response"))},onFailure:n,onTimeout:n,authentication:"passport"})})})(y,O,{rights:!0===e.enableODEIntegration?1:0}).then(t=>{t&&t.error?o.nbError=o.nbError+1:n.enableODEIntegration=e.enableODEIntegration}).catch(()=>{o.nbError=o.nbError+1}).finally(()=>{o.nbOnCompleted=o.nbOnCompleted+1,a()})}),g.forEach(n=>{void 0!==e[`ode_${n}_template`]&&r.push(()=>{const r=new FormData;r.append("tenant",O),r.append("file",e[`ode_${n}_template`]),r.append("kind",n),((e,n,r)=>{const o=t.parseUrl(e);return o.path="/template/add.json",new Promise((e,n)=>{d.handleRequest(t.composeUrl(o),{method:"POST",data:r,responseType:"json",headers:{Accept:"application/json"},onComplete:(t,r)=>{t&&t.success?t.error?n(new Error(JSON.stringify(t.error))):e(t):n(new Error("unexpected response"))},onFailure:n,onTimeout:n,authentication:"passport"})})})(y,0,r).then(e=>{e&&e.error&&(o.nbError=o.nbError+1)}).catch(()=>{o.nbError=o.nbError+1}).finally(()=>{o.nbOnCompleted=o.nbOnCompleted+1,a()})})}),0===r.length)return;const i=b(widget.body);r.forEach(e=>{e()})}};return j});