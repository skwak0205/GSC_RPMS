/*!  Copyright 2022 Dassault Systemes. All rights reserved. */
define("DS/SPYUtils/TrackingManager",["UWA/Core","UWA/Class","DS/Usage/TrackerAPI","DS/WebSystem/Environment"],function(e,t,n,i){"use strict";var r=i.isSet("MSR_EC.Tracker.CategTest")?"-categoryTest":"",a=i.isSet("MSR_EC.Tracker.ActionTest")?"-actionTest":"",s={providerType:"UnknownProviderType",assetType:"UnknownAssetType",origin:"UnkownOrigin",sequenceType:"UnknownSequenceType",sequenceSubTypes:"UnknownSequenceSubTypes",contentType:"UnknownContentType"},o=Object.assign({providerType:"pd2",assetType:"pd3",origin:"pd4",simulationOrigin:"pd4",sequenceType:"pd5",sequenceSubTypes:"pd6",contentType:"pd7"},{chartType:"pd8"}),u={dataSize:"pv1",streamingTime:"pv2",extractionTime:"pv3",dataModelCreationTime:"pv4",visuCreationTime:"pv5"},p=Object.assign(u,{numberOfSequences:"pv6"},{numberOfContents:"pv7"},{numberOf3DElements:"pv8",numberOfDisplayGroups:"pv9",numberOfParts:"pv10",numberOfStreamlines:"pv11",numberOfCameras:"pv12",numberOfImages:"pv16",numberOfVideos:"pv17",numberOfCharts:"pv18"},{numberOfFrames:"pv13"},{firstFrameIndex:"pv14",lastFrameIndex:"pv15"},{numberOfCurves:"pv19",numberOfPointsPerCurve:"pv20"}),c=function(e,t){return"string"==typeof e&&e.length>0?e:t},d=function(e,t){return c(e,s[t])},v=function(e,t,n,i){var r=function(e,t){return i?i(e,t):e};for(var a in e)n[a]&&(Array.isArray(e[a])?e[a].length>0&&(e[a].length>1?t[n[a]]=e[a].reduce(function(e,t){return e+","+r(t,a)}):t[n[a]]=r(e[a][0],a)):t[n[a]]=r(e[a],a))},g=function(e,t){v(e,t,o,d)};return t.singleton({_eventsMap:new Map,_appId:void 0,_prefix:"MSR_EC",_suffix:r,_getEventCategory:function(e){return this._prefix+"-"+e+this._suffix},_getLoadingEventCategory:function(){return this._getEventCategory("loading")},_getErrorEventCategory:function(){return this._getEventCategory("error")},_trackPageEvent:function(e){e.appID=this.getAppId(),e.tenant=this.getTenant(),e.persDim.pd1="undefined"!=typeof widget?widget.id:"default-widget-id",e.persDim.pd20="1",n.trackPageEvent(e)},_initErrorEventParams:function(e,t,n){var i={};return g(n,i),{eventCategory:this._getErrorEventCategory(),eventAction:e,eventLabel:c(t,"UnknownDomain"),persDim:i}},_addPersDimFromData:function(e,t){var n=this._eventsMap.get(e);return n&&g(t,n.persDim),n},_addPersValFromData:function(e,t){var n=this._eventsMap.get(e);return n&&function(e,t){v(e,t,p)}(t,n.persVal),n},_createLoadingTracker:function(e,t,n,i){var r={id:e,eventCategory:this._getLoadingEventCategory(),eventAction:t,eventLabel:c(n,"UnknownDomain"),persDim:{},persVal:{},setTypingInfo:function(e){e&&(g(e,this.persDim),this.eventLabel=c(e.sequenceType,"UnknownDomain"))}};return r.setTypingInfo(i),this._eventsMap.set(e,r),r},clean:function(){this._eventsMap.clear()},setTenant:function(e){this._tenant=e},getTenant:function(){return this._tenant||"undefined"!=typeof widget&&(this._tenant=widget.getValue("x3dPlatformId")),this._tenant},setAppId:function(e){this._appId=e},getAppId:function(){return this._appId||("undefined"!=typeof widget?(this._appId=widget.getValue("appId"),this._appId||(this._appId="WidgetWithoutAppId")):this._appId="NoWidgetDefined"),this._appId},setPrefix:function(e){this._prefix=e},setSuffix:function(e){this._suffix=e},addTypingData:function(e,t){var n=this._addPersDimFromData(e,t);n&&(n.eventLabel=c(n.persDim.sequenceType,"UnknownDomain"))},addLoadingData:function(e,t){var n=this._addPersValFromData(e,t);if(n){var i=0,r=n.persVal;if(r){var a=function(e){var t=r[u[e]];i+=isNaN(t)?0:t};a("streamingTime"),a("extractionTime"),a("dataModelCreationTime"),a("visuCreationTime")}n.eventValue=i}},overrideLoadingTime:function(e,t){var n=this._eventsMap.get(e);n&&!isNaN(t)&&(n.eventValue=t)},addDetailsData:function(e,t){this._addPersDimFromData(e,t)},publishTracker:function(e){var t=this._eventsMap.get(e);t&&(this._trackPageEvent(t),this._eventsMap.delete(e))},createSimulationECLoaded:function(e,t){var n;if(t){for(var i in n={providerType:t.providerType,assetType:t.assetType,sequenceType:"",sequenceSubTypes:[],origin:""},t){var r=t[i];"object"==typeof r&&(r.origin&&(n.origin+=(n.origin.length>0?",":"")+r.origin),r.sequenceType&&(n.sequenceType+=(n.sequenceType.length>0?",":"")+r.sequenceType),Array.isArray(r.sequenceSubTypes)&&(n.sequenceSubTypes=n.sequenceSubTypes.concat(r.sequenceSubTypes)))}""===n.origin&&t.simulationOrigin&&t.simulationOrigin.length>0&&(n.origin=t.simulationOrigin)}return this._createLoadingTracker(e,"simulationAssetLoaded"+a,void 0,n)},createSequenceECLoaded:function(e,t,n,i){return this._createLoadingTracker(e,"sequenceLoaded"+a,n,i)},createECContentLoaded:function(e,t,n){return this._createLoadingTracker(e,"contentLoaded"+a,t,n)},createECFrameLoaded:function(e,t,n){var i="frame_"+e.toString();return this._createLoadingTracker(i,"frameLoaded"+a,t,n)},createECAnimationLoaded:function(e,t,n){var i="anim_"+e.toString();return this._createLoadingTracker(i,"animationLoaded"+a,t,n)},createECChartLoaded:function(e,t,n){return this._createLoadingTracker(e,"chartLoaded"+a,t,n)},trackInvalidAssetType:function(e,t){var n=this._initErrorEventParams("invalidTypeForEC"+a,e,t);this._trackPageEvent(n)},trackNoAccess:function(e,t){var n=this._initErrorEventParams("noAcessToEC"+a,e,t);this._trackPageEvent(n)},trackNoSimulationEC:function(e,t){var n=this._initErrorEventParams("noSimulationEC"+a,e,t);this._trackPageEvent(n)},trackECLoadingTimeOut:function(e,t,n){var i=this._initErrorEventParams("loadingTimeOut"+a,e,t);i.value=n,this._trackPageEvent(i)},trackInvalidStreamContent:function(e,t){var n=this._initErrorEventParams("invalidStreamContent"+a,e,t);this._trackPageEvent(n)},trackAllContentsFiltered:function(e,t){var n=this._initErrorEventParams("filteredAllStreamContents"+a,e,t);this._trackPageEvent(n)}})});