define("DS/CAT3DWVisu/CAT3DWISOViewService",["UWA/Class","DS/ApplicationFrame/FrameWindowsManager","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/Visualization/Ambience"],function(e,t,i,n,o,r){"use strict";var a=e.extend({init:function(){this._parent(),this._frameWindow=t.getFrameWindow(),this._viewpoint=this._frameWindow.getViewpoint(),this._viewer=this._frameWindow.getViewer(),this._animationTime=150,a.prototype._savedCamera||(a.prototype._savedCamera={eyePos:(new n.Vector3).copy(this._viewpoint.getEyePosition()),targetDistance:this._viewpoint.getTargetDistance(),quaternion:(new n.Quaternion).setFromRotationMatrix((new n.Matrix4).copy(this._viewpoint.getCamera().matrix)),sightDirection:this._viewpoint.getSightDirection().clone()})},_isISOViewMode:function(){return this._viewpoint.getProjectionType()===a.ORTHOGRAPHIC},setISOViewMode:function(e,t){var r=this._animationTime;if(void 0!==t&&(r=t),!this._isISOViewMode()){var s=this._viewer.onPostRender(function(){this._viewer._modelEvent.unsubscribe(s),i.publish({event:"CATLSSetISOView",data:null}),this._viewer.render()}.bind(this));a.prototype._savedCamera={eyePos:(new n.Vector3).copy(this._viewpoint.getEyePosition()),targetDistance:this._viewpoint.getTargetDistance(),quaternion:(new n.Quaternion).setFromRotationMatrix((new n.Matrix4).copy(this._viewpoint.getCamera().matrix)),sightDirection:this._viewpoint.getSightDirection().clone()},this._viewpoint.setProjectionType(a.ORTHOGRAPHIC);var p=e.getMatrix().clone(),l=p.decompose()[0],u=(new n.Vector3).copy(this._viewpoint.getEyePosition()).clone().distanceTo(l),c=new n.Vector3,h=new n.Vector3,d=new n.Vector3;p.extractBasis(c,h,d);var g=new n.Vector3,f=new n.Vector3,_=d;this._viewpoint.getSightDirection().dot(d)>0&&_.multiplyScalar(-1);var v=this._viewpoint.camera.up.dot(c),w=this._viewpoint.camera.up.dot(h);Math.abs(v)>Math.abs(w)?(g=c,v<0&&g.multiplyScalar(-1)):(g=h,w<0&&g.multiplyScalar(-1));for(var m=[new n.Vector3(1,0,0),new n.Vector3(0,1,0),new n.Vector3(0,0,1)],P=0,T=0,y=new n.Vector3(1,0,0),S=0;S<m.length;S++)T=g.dot(m[S]),Math.abs(T)>=Math.abs(P)&&Math.abs(T)>Math.abs(_.dot(m[S]))&&(P=T,y=m[S].multiplyScalar(P<0?-1:1));f.crossVectors(y,_),g.crossVectors(_,f),f.normalize(),g.normalize(),_.normalize();var V={target:l,orientation:(new n.Matrix4).set(f.x,g.x,_.x,0,f.y,g.y,_.y,0,f.z,g.z,_.z,0,0,0,0,1).decompose()[1],distanceToTarget:u},E=new n.Vector3(0,0,-1);E.applyQuaternion(V.orientation),E.normalize(),!0===o.getPreferenceValue("R2VPerspectiveModeOn")&&(this._viewer.currentViewpoint.control.setActive(!0),this._viewer.currentViewpoint.control.setZoomActive(!0),this._viewer.currentViewpoint.control.setPanActive(!0),this._viewpoint.getControl().setRotationActive(!1)),this._viewpoint.moveTo({orientation:V.orientation,eyePosition:(new n.Vector3).addVectors(V.target,E.clone().multiplyScalar(-V.distanceToTarget)),distanceToTarget:V.distanceToTarget,duration:r})}},exitISOViewMode:function(e){if(this._isISOViewMode()){var t=this._animationTime;void 0!==e&&(t=e);var s=this._viewer.onPostRender(function(){this._viewer._modelEvent.unsubscribe(s),i.publish({event:"CATLSExitISOView",data:null}),this._viewer.render()}.bind(this));if(this._viewpoint.moveTo({eyePosition:a.prototype._savedCamera.eyePos,orientation:a.prototype._savedCamera.quaternion,distanceToTarget:a.prototype._savedCamera.targetDistance,duration:t}),this._viewpoint.setProjectionType(a.PERSPECTIVE),!0===o.getPreferenceValue("R2VOrthogonalViewWasInCalibratedMode")){o.setPreferenceValue("R2VOrthogonalViewWasInCalibratedMode",!1),o.setPreferenceValue("R2VCalibratedMode",!0);var p=new r({viewer:this._viewer});this._viewer.setAmbience(p);var l=o.getPreferenceValue("ambienceImageUrl");p.setBackGroundMap({url:l,mapping:new n.SimpleEnvMappingFit,hdr:!1}),this._viewer.render();var u=o.getPreferenceValue("R2VPosition"),c=o.getPreferenceValue("R2VQuaternion");this._viewpoint.moveTo({eyePosition:u,orientation:c,duration:10}),console.log("cam pos: "+u.x+" , "+u.y+" , "+u.z),console.log("cam quat: "+c.x+" , "+c.y+" , "+c.z+" , "+c.w);var h=o.getPreferenceValue("R2VCameraSetAngle");this._viewpoint.setAngle(h),this._viewer.currentViewpoint.control.setRotationActive(!1),this._viewer.currentViewpoint.control.setTouchRotationActive(!1),this._viewer.currentViewpoint.control.setZoomActive(!1),this._viewer.currentViewpoint.control.setPanActive(!1),this._viewer.currentViewpoint.control.setActive(!1)}}},updateSavedCameraTargetDistance:function(e){e&&(a.prototype._savedCamera.targetDistance=e,a.prototype._savedCamera.eyePos=(new n.Vector3).addVectors(this._viewpoint.target,a.prototype._savedCamera.sightDirection.clone().multiplyScalar(-e)))}});return a.PERSPECTIVE=0,a.ORTHOGRAPHIC=1,a}),define("DS/CAT3DWVisu/CAT3DWSession",["DS/CoreEvents/Events","UWA/Class"],function(e,t){"use strict";return t.singleton({init:function(){},initialize:function(t){t?(this._lsSession=t,this.getDrawingPlane=function(){return this._lsSession.getDrawingPlane()},this.setDrawingPlane=function(e,t){this._lsSession.setDrawingPlane(e,t)},this.getChangeDrawingPlaneEvent=function(){return this._lsSession.getChangeDrawingPlaneEvent()},this.getSnapOnGrid=function(){return this._lsSession.getSnapOnGrid()},this.setSnapOnGrid=function(e){this.setSnapOnGrid(e)},this.getChangeSnapOnGridEvent=function(){return this._lsSession.getChangeSnapOnGridEvent()}):(this._drawingPlane=null,this.getDrawingPlane=function(){var e={plane:null,direction:null,isFloor:!1};return this._drawingPlane&&(e.plane=this._drawingPlane,e.direction=this._drawingPlane.normal),e},this.setDrawingPlane=function(t,i){this._drawingPlane=t,i||e.publish({event:this.getChangeDrawingPlaneEvent(),data:this.getDrawingPlane()})},this.getChangeDrawingPlaneEvent=function(){return"CAT3DWChangeDrawingPlaneEvent"},this._bSnapOnGrid=!1,this.getSnapOnGrid=function(){return this._bSnapOnGrid},this.setSnapOnGrid=function(t){this._bSnapOnGrid=t,e.publish({event:this.getChangeSnapOnGridEvent(),data:this._bSnapOnGrid})},this.getChangeSnapOnGridEvent=function(){return"CAT3DWSnapOnGridEvent"})}})}),define("DS/CAT3DWVisu/CAT3DWDataFactory",["UWA/Core"],function(e){"use strict";function t(){this.eventData=null,this.pickingData=null}function i(){this.eventData=null,this.gestureData=null,this.pickingData=null}function n(){this.visuEventData=null,this.path=[],this.position=null,this.normal=null,this.tangent=null,this.tangents=null,this.uv=null,this.ray=null,this.plane=null,this.matrix=null,this.snapped=!1}function o(){this.gestureTypeList={NONE:"None",PREVIEW_GESTURE:"PreviewGesture",ACQUISITION_GESTURE:"AcquisitionGesture"},this.gestureSubTypeList={UNKNOWN:0,AFTER_BEGIN_MOVE:1,AFTER_UP:2},this.nativeEventData=null,this.gestureType=null,this.gestureSubtype=null}function r(){this.createModelingGestureData=function(){return new o},this.createPickingData=function(){return new n},this.createUIData=function(){return new i},this.createSelectionData=function(){return new t}}return r.SupportTypes={NONE:0,WORKING_PLANE:1,PICKING_AREA:2,IMAGE:4,TEXT:8,FACE:16,IMAGE_MAGNET:32,AR_LINE_MAGNET:64,WEB_LINE_MAGNET:128,LINE_MAGNET:256,EDGE:512,ANNOTATION:1024,AR_POINT_MAGNET:2048,WEB_POINT_MAGNET:4096,POINT_MAGNET:8192,VERTEX:16384,PREVIEW_ITEM:32768},r.SupportTypes.GEOMETRY=r.SupportTypes.VERTEX|r.SupportTypes.EDGE|r.SupportTypes.FACE,r.SupportTypes.GEOMETRY_MAGNET=r.SupportTypes.POINT_MAGNET|r.SupportTypes.LINE_MAGNET,r.SupportTypes.MAGNET=r.SupportTypes.GEOMETRY_MAGNET|r.SupportTypes.WEB_POINT_MAGNET|r.SupportTypes.WEB_LINE_MAGNET,r.SupportTypes.AR_MAGNET=r.SupportTypes.AR_POINT_MAGNET|r.SupportTypes.AR_LINE_MAGNET,r.SupportTypes.ALL=r.SupportTypes.WORKING_PLANE|r.SupportTypes.IMAGE|r.SupportTypes.GEOMETRY|r.SupportTypes.MAGNET|r.SupportTypes.IMAGE_MAGNET|r.SupportTypes.PREVIEW_ITEM|r.SupportTypes.PICKING_AREA|r.SupportTypes.ANNOTATION,Object.freeze(r.SupportTypes),r.getLabelOf=function(e){switch(e){case r.SupportTypes.VERTEX:case r.SupportTypes.EDGE:case r.SupportTypes.FACE:case r.SupportTypes.POINT_MAGNET:case r.SupportTypes.LINE_MAGNET:case r.SupportTypes.WEB_POINT_MAGNET:case r.SupportTypes.WEB_LINE_MAGNET:case r.SupportTypes.AR_POINT_MAGNET:case r.SupportTypes.AR_LINE_MAGNET:case r.SupportTypes.IMAGE_MAGNET:case r.SupportTypes.IMAGE:case r.SupportTypes.ANNOTATION:case r.SupportTypes.PREVIEW_ITEM:case r.SupportTypes.PICKING_AREA:for(var t in r.SupportTypes)if(r.SupportTypes[t]===e)return t;break;default:return""}},r.PickingData=function(){this.ray=null,this.path=null,this.plane=null,this.tangent=null,this.tangent=null,this.point={position:null,supportType:r.SupportTypes.NONE,supportData:null,isSnapped:function(){return this.supportType>r.SupportTypes.WORKING_PLANE}}},e.namespace("DS/CAT3DWVisu/CAT3DWDataFactory",r)}),define("DS/CAT3DWVisu/CAT3DWViewSettings",["UWA/Class","DS/Plugins/UserRenderList","DS/ApplicationFrame/FrameWindowsManager"],function(e,t,i){"use strict";var n=e.extend({init:function(){this._frameWindow=i.getFrameWindow(),this._viewer=this._frameWindow.getViewer(),this._touchMode=!1,this._pickingTolerance=2,this._beforeNoZPass=null,this._beforeMainPass=null},setTouchMode:function(e){this._touchMode=e,this._pickingTolerance=this._touchMode?9:2},getTouchMode:function(){return this._touchMode},applyDefaultPickingSettings:function(){this._viewer.setPicking({activated:!0,displayHL:!0,gpu:!0,computeNormalDepth:!0,primitive:!0,pickingTolerance:this._pickingTolerance}),this._viewer.setPrePicking({activated:!0,displayHL:!0,gpu:!0,computeNormalDepth:!0,primitive:!0,pickingTolerance:this._pickingTolerance})},deactivateHighlights:function(){this._viewer.setPicking({displayHL:!1}),this._viewer.setPrePicking({displayHL:!1})},activatePicking:function(){this._viewer.setPicking({activated:!0})},deactivatePicking:function(){this._viewer.setPicking({activated:!1})},activatePrePicking:function(){this._viewer.setPicking({activated:!0})},deactivatePrePicking:function(){this._viewer.setPrePicking({activated:!1})},activateManipulators:function(){this._viewer.setManipulators({activated:!0})},deactivateManipulators:function(){this._viewer.setManipulators({activated:!1})},applyDefaultViewerSettings:function(){this._viewer.setBackgroundColor("white"),this._viewer.displayInfinitePlane(!0),this._viewer.setGrid(!0,!0),this._viewer.displayPoints(!0),this._viewer.setDOF(!1),this._viewer.showEnvMap(!0),this._viewer.setShadowPlane(!0),this._touchMode?(this._viewer.setSSAO(!1),this._viewer.setAntiAliasing("NoAA"),this._viewer.setShadow(!1),this._viewer.setMirror(!1,!1)):(this._viewer.setSSAO(!0),this._viewer.setAntiAliasing("SMAA"),this._viewer.setShadow(!1),this._viewer.setMirror(!0,!0))},applyLightViewerSettingsWithoutEnvMap:function(){this._viewer.setShadow(!1),this._viewer.setMirror(!1),this._viewer.setGrid(!1),this._viewer.displayInfinitePlane(!1),this._viewer.setShadowPlane(!1),this._viewer.showEnvMap(!1)},applyLightViewerSettingsWithEnvMap:function(){this.applyLightViewerSettingsWithoutEnvMap(),this._viewer.showEnvMap(!0),this._viewer.setBackgroundColor("white")},getBeforeNoZPass:function(){if(null===this._beforeNoZPass){var e=this._viewer.getUserPassManager();this._beforeNoZPass=new t("BeforeNoZ");var i=e.createUserClearPass("userClearPass",this._beforeNoZPass);i.setClearDepth(!0);var n=e.createUserRenderPass("userRenderPass",this._beforeNoZPass),o=e.getSystemPass("noz");e.insertUserPassBeforePass(i,o),e.insertUserPassAfterPass(n,i)}return this._beforeNoZPass},getBeforeMainPass:function(){if(null===this._beforeMainPass){var e=this._viewer.getUserPassManager();this._beforeMainPass=new t("BeforeMain");var i=e.createUserClearPass("userClearPass",this._beforeMainPass);i.setClearDepth(!0);var n=e.createUserRenderPass("userRenderPass",this._beforeMainPass),o=e.getSystemPass("main");e.insertUserPassBeforePass(i,o),e.insertUserPassBeforePass(n,i)}return this._beforeMainPass},getDrawColor:function(){return"#42a2da"},setViewerSize:function(e){var t=this._frameWindow.getContent();t.removeAttribute("style"),t.dataset.x3dphotomode=e}});return n.DEFAULT="default",n.WIZARD_WITHOUT_BORDERS="wizard",n.WIZARD_WITH_BORDERS="wizard-borders",UWA.namespace("DS/CAT3DWVisu/CAT3DWViewSettings",n)}),define("DS/CAT3DWVisu/CAT3DWTolerance",["UWA/Core"],function(e){"use strict";var t=function(){};return t.tolerance=1e-5,t.toleranceForEdgesAndPoints=1e-4,t.toleranceForUnitaryVectors=1-t.tolerance,t.toleranceForAlignments=.99,t.toleranceForPerpendicular=.2,t.toleranceForParallel=.8,t.squareTolerance=t.tolerance*t.tolerance,t.squareToleranceForUnitaryVectors=t.toleranceForUnitaryVectors*t.toleranceForUnitaryVectors,t.areAlmostEqual=function(e,t,i){return Math.pow(e-t,2)<Math.pow(i,2)},e.namespace("DS/CAT3DWVisu/CAT3DWTolerance",t)}),define("DS/CAT3DWVisu/CAT3DWReframeServices",["DS/ApplicationFrame/FrameWindowsManager","DS/Visualization/ThreeJS_DS","UWA/Class"],function(e,t,i){"use strict";var n=i.extend({init:function(){this._frameWindow=e.getFrameWindow(),this._viewer=this._frameWindow.getViewer(),this._viewpoint=this._frameWindow.getViewpoint()},reframeOnImage:function(e,i){void 0===i&&(i={});var o=e.getBoundingSphere(),r=e.getCenter(),a=e.getNormal(),s=e.getDimensions(),p=e.getCorners();o.center=r,o.radius=.5*s.height;var l=s.width/s.height,u=this._viewer.viewpoints[0].camera.aspect;l>u&&(o.radius=.5*s.width/u);var c=e.getMatrix().decompose();this._viewpoint.moveTo({orientation:c[1]});var h=(new t.Vector3).subVectors(p.bottomLeft,p.bottomRight);h.normalize(),h.applyAxisAngle(a,Math.PI),this._viewpoint.setUpDirection(h);var d=(new t.Vector3).subVectors(p.bottomLeft,p.topLeft);d.normalize(),d.applyAxisAngle(a,Math.PI),this._viewpoint.setUpDirection(d),this._viewpoint.setProjectionType(n.PERSPECTIVE);var g=this._viewer.onPostRender(function(){this._viewer._modelEvent.unsubscribe(g),setTimeout(function(){i.callback&&i.callback()},i.time)}.bind(this)),f=i.fullSize?1:1.02;this._viewpoint.onReframe(function(e,i,n,o){var r=function(e){var t=f*e.radius/Math.tan(this._viewpoint.camera.fov*Math.PI/360);return{target:e.center.clone(),orientation:this._viewpoint.control.orientation.clone(),distanceToTarget:t}}.bind(this)(n);if(r){var a=new t.Vector3(0,0,-1);a.applyQuaternion(r.orientation),a.normalize(),this._viewpoint.moveTo({orientation:r.orientation,eyePosition:(new t.Vector3).addVectors(r.target,a.clone().multiplyScalar(-r.distanceToTarget)),distanceToTarget:r.distanceToTarget})}}.bind(this)),this._viewpoint.reframe(null,i.time,o),this._viewpoint.onReframe(null)},reframeOnNode:function(e,t,i){var o=i||null,r=this._viewer.onPostRender(function(){this._viewer._modelEvent.unsubscribe(r),setTimeout(function(){t&&t()},o)}.bind(this)),a=e.getBoundingSphere("visibleSpace");a=a.radius>0?a:null,this._viewpoint.setProjectionType(n.PERSPECTIVE),this._viewpoint.resetCameraOrientation(),this._viewpoint.reframe(null,o,a)}});return n.PERSPECTIVE=0,n.ORTHOGRAPHIC=1,UWA.namespace("DS/CAT3DWVisu/CAT3DWReframeServices",n)}),define("DS/CAT3DWVisu/CAT3DWPanAndZoomService",["UWA/Class","DS/ApplicationFrame/FrameWindowsManager","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/TrackballControls"],function(e,t,i,n,o){"use strict";var r=e.extend({init:function(){this._parent(),this._frameWindow=t.getFrameWindow(),this._webGLV6Viewer=this._frameWindow.getViewer(),this._viewpoint=this._frameWindow.getViewpoint()},setViewerZommable:function(e){this.resetZoom(),e?(this.restoreNativePanAndZoom(),this._viewpoint.setControlActive({viewpoint:!0,picking:!0}),this._rotationEnabled=!1,this.overloadPanAndZoom({overrideOnReframe:!1})):(this._viewpoint.setControlActive({viewpoint:!1,picking:!0}),this.restoreNativePanAndZoom())},resetZoom:function(){this._zoom=1,i.publish({event:"hideFitAllBtn",data:null}),this._viewpoint.setViewOffset()},getZoom:function(){return this._zoom},restoreNativePanAndZoom:function(){this._webGLV6Viewer&&this._webGLV6Viewer.currentViewpoint&&this._webGLV6Viewer.currentViewpoint.control&&(this._webGLV6Viewer.currentViewpoint.control.onPan(null),this._webGLV6Viewer.currentViewpoint.control.onRotate(null),this._webGLV6Viewer.currentViewpoint.control.onZoom(null),this._webGLV6Viewer.currentViewpoint.onReframe(null),this._webGLV6Viewer.currentViewpoint.onCenterCamera(null))},overloadPanAndZoom:function(e){if(this._zoom=1,this._panCenter=new n.Vector2(Math.floor(this._webGLV6Viewer.div.clientWidth/2),Math.floor(this._webGLV6Viewer.div.clientHeight/2)),!this._webGLV6Viewer)return!1;var t=this._webGLV6Viewer.currentViewpoint;if(!t||!t.control)return!1;this._webGLV6Viewer.currentViewpoint.control.onPan(function(e){e.defaultBehavior=!1;var i=e.gesture.events,n=e.gesture.view[0],o=i[0].getCurrentPosition(n),r=i[0].getLastPosition(n);if(o&&r){if(i[0]&&i[1]){var a=i[0].getCurrentPosition(),s=i[1].getCurrentPosition(),p=i[0].getLastPosition(),l=i[1].getLastPosition(),u=a.distanceTo(s),c=p.distanceTo(l);if(Math.abs(c-u)>=this._webGLV6Viewer.div.clientWidth/400)return}this._panCenter=this._panCenter.add(r.sub(o)),this._applyViewOffset(t)}}.bind(this)),this._webGLV6Viewer.currentViewpoint.control.onZoom(function(e){if(e.defaultBehavior=!1,!e||!e.gesture||"MouseMove"!=e.gesture.name){var r,a,s,p,l,u=this._webGLV6Viewer.currentViewpoint.control.getManipulationState();if(null!=this._xOffset&&null!=this._yOffset||(this._xOffset=0,this._yOffset=0),e.factor)if(u==o.State.ZOOM_PAN_ROTATE){r=e.factor<1?.97:1.03;var c=e.gesture.touches[0].getCurrentPosition(),h=e.gesture.touches[1].getCurrentPosition(),d=e.gesture.touches[0].getLastPosition(),g=e.gesture.touches[1].getLastPosition(),f=c.distanceTo(h),_=d.distanceTo(g);if(Math.abs(_-f)<=this._webGLV6Viewer.div.clientWidth/400)return;var v=(c.x+h.x)/2,w=(c.y+h.y)/2;a=new n.Vector2(v,w),s=this._xOffset+this._zoom*a.x,p=this._yOffset+this._zoom*a.y,a=new n.Vector2(s,p),l=(new n.Vector2).subVectors(this._panCenter,a),this._panCenter=(new n.Vector2).addVectors(l.multiplyScalar(r),a)}else r=e.factor>0?.9:1.1,a=e.evt.getCurrentPosition(P),s=this._xOffset+this._zoom*a.x,p=this._yOffset+this._zoom*a.y,a=new n.Vector2(s,p),l=(new n.Vector2).subVectors(this._panCenter,a),this._panCenter=(new n.Vector2).addVectors(l.multiplyScalar(r),a);else{var m=e.gesture.events,P=e.gesture.view[0];a=m[0].getCurrentPosition(P);var T=m[0].getLastPosition(P);r=1+.5*(a.y-T.y)/this._webGLV6Viewer.currentViewpoint.control.radiusZoom*this._webGLV6Viewer.currentViewpoint.control.zoomSpeed,l=(new n.Vector2).subVectors(T,this._panCenter).multiplyScalar(this._zoom),this._panCenter=this._panCenter.add(l)}this._zoom*=r,this._zoom>=1?(this._zoom=1,this._viewpoint.getControl().setRotationActive(this._rotationEnabled),i.publish({event:"hideFitAllBtn",data:null})):(this._viewpoint.getControl().setRotationActive(!1),i.publish({event:"showFitAllBtn",data:null})),this._applyViewOffset(t)}}.bind(this)),e.overrideOnReframe&&this._webGLV6Viewer.currentViewpoint.onReframe(function(){this._panCenter=new n.Vector2(Math.floor(this._webGLV6Viewer.div.clientWidth/2),Math.floor(this._webGLV6Viewer.div.clientHeight/2)),this._zoom=1,this._applyViewOffset(t)}.bind(this)),this._webGLV6Viewer.currentViewpoint.onCenterCamera(function(){this._panCenter=new n.Vector2(Math.floor(this._webGLV6Viewer.div.clientWidth/2),Math.floor(this._webGLV6Viewer.div.clientHeight/2)),this._zoom=1,this._applyViewOffset(t)}.bind(this))},_applyViewOffset:function(e){var t=this._webGLV6Viewer.div.clientWidth*this._zoom,i=this._webGLV6Viewer.div.clientHeight*this._zoom;t<=1||i<=1||(this._panCenter.x+t/2>this._webGLV6Viewer.div.clientWidth&&(this._panCenter.x=this._webGLV6Viewer.div.clientWidth-t/2),this._panCenter.x-t/2<0&&(this._panCenter.x=t/2),this._panCenter.y+i/2>this._webGLV6Viewer.div.clientHeight&&(this._panCenter.y=this._webGLV6Viewer.div.clientHeight-i/2),this._panCenter.y-i/2<0&&(this._panCenter.y=i/2),this._xOffset=this._panCenter.x-t/2,this._yOffset=this._panCenter.y-i/2,e.setViewOffset({fullWidth:this._webGLV6Viewer.div.clientWidth,fullHeight:this._webGLV6Viewer.div.clientHeight,x:this._xOffset,y:this._yOffset,width:t,height:i}),this._webGLV6Viewer.render())}});return UWA.namespace("DS/CAT3DWVisu/CAT3DWPanAndZoomService",r)}),define("DS/CAT3DWVisu/CAT3DWNode3D",["DS/Mesh/Mesh","DS/Visualization/Node3D","DS/Visualization/Mesh3D"],function(e,t,i){"use strict";return t.extend({init:function(e){this._parent(e)},addChild:function(e){this._parent(e),e instanceof i&&(e.excludeFromCSO(!0),e.excludeFromHighlight(!0,!0),e.setSSAO(!1),e.setShadow(!1,!1))},setPickable:function(t){this._parent(t?e.PICKABLE:e.NODRAWHL)}})}),define("DS/CAT3DWVisu/CAT3DWGeomFactory",["DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i=function(){};return i.createCube=function(i){if(!i||!i.center||!i.size)return null;var n={cornerPoint:i.center.clone().addScalar(.5*-i.size),firstAxis:new t.Vector3(i.size,0,0),secondAxis:new t.Vector3(0,i.size,0),thirdAxis:new t.Vector3(0,0,i.size),fill:void 0===i.fill||i.fill,material:i.material},o=e.createCuboidNode(n);return i.node&&i.node.addChild(o),o},i.DiscretizedArc=function(e,i){if(!e||!i)return;if(3!==e.length)return;let n=e[0],o=e[1],r=e[2],a=0,s=0,p=0,l=0,u=0,c=0,h=new t.Vector2,d=new t.Vector2,g=new t.Vector2,f=new t.Vector2,_=new t.Vector2,v=new t.Vector2;f.copy(n),_.copy(o),v.copy(r),h.copy(_.sub(f)),_.copy(o),d.copy(_.sub(v)),g.copy(v.sub(f)),p=.5*Math.sqrt(Math.abs(h.x*g.y-h.y*g.x)/(h.length()*i)),l=.5*Math.sqrt(Math.abs(d.x*g.y-d.y*g.x)/(h.length()*i)),s=Math.max(p,l)+1;var w=[];if(w.push(new t.Vector3(n.x,n.y,50)),s<=2){let e=new t.Vector3(r.x,r.y,50);w.push(e)}else{f.copy(n),_.copy(o),v.copy(r),h.copy(f.sub(_).add(v.sub(o))),f.copy(n),_.copy(o),v.copy(r),d.copy(_.sub(f).multiplyScalar(2)),c=u=1/s;let e=new t.Vector2;e.copy(d);let i=new t.Vector2;for(i.copy(h),a=2;a<=s+1;a++){f.copy(n),e.copy(d),i.copy(h);let o=new t.Vector2;o.copy(f.add(e.add(i.multiplyScalar(c)).multiplyScalar(c)));let r=new t.Vector3(o.x,o.y,50);w.push(r),c+=u}}return w.push(new t.Vector3(r.x,r.y,50)),w},i.GetControlPoint=function(e,i,n){let o,r,a;switch(i){case"top":a=Math.abs(n.x-e.x)/2.5,o=e.x-a,r=e.y;break;case"bottom":a=Math.abs(n.x-e.x)/2.5,o=e.x+a,r=e.y;break;case"left":a=Math.abs(n.y-e.y)/2.5,o=e.x,r=e.y-a;break;case"right":a=Math.abs(n.y-e.y)/2.5,o=e.x,r=e.y+a;break;default:return void console.log("Wrong orientation no curve computation is possible")}return new t.Vector2(o,r)},i.ComputeBezierCurve=function(e,t,i,n){if(!(e&&t&&i&&n))return;if(3!==e.length)return;let o=e[0],r=e[1],a=e[2];var s=[];let p=[o,this.GetControlPoint(o,i,a),r],l=[r,this.GetControlPoint(a,n,o),a];return s=(s=s.concat(this.DiscretizedArc(p,t))).concat(this.DiscretizedArc(l,t))},i.ComputeLine=function(e){if(e){var i=[];for(let n=0;n<e.length;n++)i.push(new t.Vector3(e[n].x,e[n].y,50));return i}},i}),define("DS/CAT3DWVisu/CAT3DWGrid",["DS/ApplicationFrame/FrameWindowsManager","DS/Mesh/MeshUtils","DS/Visualization/MaterialApplication","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS"],function(e,t,i,n,o,r){"use strict";return n.extend({init:function(t){var i=t||{};this._parent(i.name?i.name:"CAT3DWGrid");var n=e.getFrameWindow();this._viewer=n.getViewer(),this._viewpoint=n.getViewpoint(),this._size=void 0!==i.size?i.size:200,this._baseSize=this._size,this.displayGrid=void 0!==i.displayGrid?i.displayGrid:1,this.displayGridFromBelow=void 0!==i.displayGridFromBelow?i.displayGridFromBelow:1,this.gridScreenSize=void 0!==i.gridScreenSize?i.gridScreenSize:50,this.gridNbSteps=void 0!==i.gridNbSteps?i.gridNbSteps:5,this.gridUnit=void 0!==i.gridUnit?i.gridUnit:1,this.gridOffset=void 0!==i.gridOffset?i.gridOffset:new r.Vector2,this.gridCoeff=void 0!==i.gridCoeff?i.gridCoeff:1,this.gridFalloff=void 0!==i.gridFalloff?i.gridFalloff:1,this.gridColor=new r.Color(void 0!==i.gridColor?i.gridColor:"#3d3d3d"),this.displayPlane=void 0!==i.displayPlane?i.displayPlane:1,this.planeFalloff=void 0!==i.planeFalloff?i.planeFalloff:1,this.planeColor=new r.Color(void 0!==i.planeColor?i.planeColor:"#f1f1f1"),this.planeOpacity=void 0!==i.planeOpacity?i.planeOpacity:.5,this.planeTexture=void 0!==i.planeTexture?i.planeTexture:null,this.planeTextureScale=void 0!==i.planeTextureScale?i.planeTextureScale:1,this.planeBorder=!1,this.edgeColor=new r.Color,this.gridTextures={},this._position=new r.Vector3(0,0,0),this._orientation=new r.Matrix4,this._createPlaneGrid()},_createPlaneGrid:function(){this._planeNode=o.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0}),this.addChild(this._planeNode),this.setPickable(t.NOPICKABLE),this.exludeFromBounding(!0),this.setPositionAndOrientation({position:this._position,orientation:this._orientation})},setPositionAndOrientation:function(e){this._position=e.position?e.position:this._position,this._orientation=e.orientation?e.orientation:this._orientation;var t=(new r.Matrix4).copy(this._orientation);t.setPosition(this._position),this.setMatrix(t),this.isVisible()&&this._update()},show:function(){this._update(),this.setVisibility(!0),this._subscribeToViewpointMove(),this._viewer.render()},hide:function(){this.setVisibility(!1),this._unsubscribeToViewpointMove(),this._planeNode.removeMaterialApplication(),this._viewer.render()},_onViewpointMove:function(){this._update()},_update:function(){if(this._baseTargetDistance){var e=this._viewpoint.getTargetDistance();this._size=e*this._baseSize/this._baseTargetDistance;var t=this._planeNode.getMatrix().decompose(),i=(new r.Matrix4).compose(new r.Vector3(-.5*this._size,-.5*this._size,0),t[1],new r.Vector3(this._size,this._size,this._size));this._planeNode.setMatrix(i),this._planeNode.removeMaterialApplication(),this._planeNode.setMaterialApplication(this._getPlaneMaterialApplication()),this._viewer.render()}else this._baseTargetDistance=this._viewpoint.getTargetDistance()},clean:function(){this._unsubscribeToViewpointMove()},_subscribeToViewpointMove:function(){this._onMoveToken||(this._onMoveToken=this._viewpoint.onMove(this._onViewpointMove.bind(this)))},_unsubscribeToViewpointMove:function(){this._viewpoint.unsubscribe(this._onMoveToken),this._onMoveToken=void 0},_getPlaneMaterialApplication:function(){var e=this._viewpoint.getWorldOrientation(),t=e.upVector,n="zup"===e._woName;this._computeGridUnit(this._viewpoint.camera,Math.abs(this._viewpoint.camera.position.dot(t)-this._position.dot(t)));var o=this.gridNbSteps*this.gridUnit;this.gridOffset.x=this._position.x-o*Math.floor(this._position.x/o),n?this.gridOffset.y=this._position.y-o*Math.floor(this._position.y/o):this.gridOffset.z=this._position.z-o*Math.floor(this._position.z/o);var a=r.InfinitePlaneShader,s={defines:{PLANE_V2:!0},fragmentShader:a.fragmentShader,vertexShader:a.vertexShader,uniforms:r.UniformsUtils.clone(a.uniforms)},p=new r.ShaderMaterial(s);p.lights=!0,p.depthTest=!0,p.depthWrite=!0,p.transparent=!0,p.enableClipPlanes=!1,p.side=r.DoubleSide,p.uniforms.ambient.value.copyGammaToLinear(new r.Color(328965)),p.force=!0,p.uniforms.displayPlane.value=this.displayPlane,p.uniforms.displayGrid.value=this.displayGrid,p.uniforms.gridFromBelow.value=this.displayGridFromBelow,p.uniforms.diffuse.value.copyGammaToLinear(this.planeColor),p.uniforms.planeOpacity.value=this.planeOpacity,(p.map&&!this.planeTexture||!p.map&&this.planeTexture)&&(p.needsUpdate=!0),p.map=this.planeTexture,p.uniforms.map.value=this.planeTexture,p.uniforms.uvScale.value=this.planeTextureScale,p.uniforms.border.value.copyGammaToLinear(this.edgeColor),p.uniforms.attenuation.value=this._viewer.planeAttenuation?1:0,p.uniforms.planeBorder.value=this.planeBorder?1:0,p.uniforms.planeFalloff.value=this.planeFalloff,p.uniforms.gridFalloff.value=this.gridFalloff,p.uniforms.gridUnit.value=this.gridUnit,p.uniforms.gridOffset.value.copy(this.gridOffset),p.uniforms.gridCoeff.value=this.gridCoeff,p.uniforms.gridColor.value.copyGammaToLinear(this.gridColor),p.uniforms.planeSize.value=this._size,p.uniforms.nbSteps.value=this.gridNbSteps;var l=function(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.round(t))},u=this.gridNbSteps/2,c=l(64*u),h=l(64*u*u),d=Math.min(l(64*u*u*u),4096);return p.uniforms.gridTexture.value=this._getUnitGridTexture(64),p.uniforms.gridTexture2.value=this._getUnitGridTexture(c),p.uniforms.gridTexture3.value=this._getUnitGridTexture(h),p.uniforms.gridTexture4.value=this._getUnitGridTexture(d),new i({faceMaterial:p})},_getUnitGridTexture:function(e){if(this.gridTextures[e])return this.gridTextures[e];for(var t=new Uint8Array(e*e),i=0;i<e;++i)t[i]=255,t[e*(e-1)+i]=255,t[e*i]=255,t[e*i+e-1]=255;var n=new r.DataTexture(t,e,e,r.AlphaFormat,r.UnsignedByteType,new r.UVMapping,r.RepeatWrapping,r.RepeatWrapping,r.LinearFilter,r.LinearMipMapLinearFilter,16);return n.needsUpdate=!0,this.gridTextures[e]=n,n},_computeGridUnit:function(e,t){var i=1;e instanceof r.PerspectiveCamera?i=2*this.gridScreenSize*Math.tan(Math.PI*e.fov/360)*t/this._viewer.div.clientHeight:e instanceof r.OrthographicCamera&&(i=this.gridScreenSize*(e.top-e.bottom)/this._viewer.div.clientHeight);for(var n=1/(this.gridNbSteps*this.gridNbSteps);n<i;)1===this.gridNbSteps?n++:n*=this.gridNbSteps;this.gridUnit=n,1===this.gridNbSteps?this.gridCoeff=i-n-1:this.gridCoeff=(i-n/this.gridNbSteps)/(n-n/this.gridNbSteps)}})}),define("DS/CAT3DWVisu/CAT3DWVisuEvents",["DS/CoreEvents/Events","DS/VisuEvents/EventsManager"],function(e,t){"use strict";var i=function(){var i=null,n=null,o=0,r=null,a=void 0,s=void 0,p=void 0,l=void 0,u=void 0,c=function(){};c.prototype.init=function(e,o){i=e,n=o,t.addEvent(i,"onLeftMouseDown",d),t.addEvent(i,"onLeftMouseUp",g),t.addEvent(i,"onRightMouseDown",f),t.addEvent(i,"onRightMouseUp",_),t.addEvent(i,"onMouseMove",v),t.addEvent(i,"onTouch",d),t.addEvent(i,"onRelease",g),t.addEvent(i,"onSwipe",v)},c.prototype.clear=function(){t.removeEvent(i,"onLeftMouseDown",d),t.removeEvent(i,"onLeftMouseUp",g),t.removeEvent(i,"onMouseMove",v),t.removeEvent(i,"onRightMouseDown",f),t.removeEvent(i,"onRightMouseUp",_),t.removeEvent(i,"onTouch",d),t.removeEvent(i,"onRelease",g),t.removeEvent(i,"onSwipe",v)},c.prototype.getClickEvent=function(){return"CATLSVisuClickEvent"},c.prototype.getRightClickEvent=function(){return"CATLSVisuRightClickEvent"},c.prototype.getHoldEvent=function(){return"CATLSVisuHoldEvent"},c.prototype.getLongHoldEvent=function(){return"CATLSVisuLongHoldEvent"},c.prototype.getDragEvent=function(){return"CATLSVisuDragEvent"},c.prototype.getDoubleClickEvent=function(){return"CATLSVisuDoubleClickEvent"},c.prototype.getUpEvent=function(){return"CATLSVisuUpEvent"},c.prototype.getPalmThreshold=function(){return 30};var h=function(){w(),o=0,r=null},d=function(e){o|=c.Down,m(e),T(e),e.from.length&&e.from[0].event.preventDefault(),r=new c.EventData(e)},g=function(t){if(e.publish({event:c.prototype.getUpEvent(),data:new c.EventData(t)}),a){if(n.isMoving())return void h();if(o&c.Click)Date.now()-l>50&&(h(),e.publish({event:c.prototype.getDoubleClickEvent(),data:new c.EventData(t)}));else h(),o|=c.Click,S(t),A(t)}else h()},f=function(){V()},_=function(t){if(u){if(n.isMoving())return void h();e.publish({event:c.prototype.getRightClickEvent(),data:new c.EventData(t)})}else h()},v=function(t){o&c.Down&&r.position.distanceTo(t.from[0].getCurrentPosition(i))>10&&(w(),e.publish({event:c.prototype.getDragEvent(),data:new c.EventData(t)}))},w=function(){P(),y(),E(),C(),D()},m=function(t){M(t)>1?h():N(t)?h():a=setTimeout(function(){e.publish({event:c.prototype.getHoldEvent(),data:new c.EventData(t)}),a=void 0},300)},P=function(){a&&(clearTimeout(a),a=void 0)},T=function(t){M(t)>1?h():N(t)?h():s=setTimeout(function(){e.publish({event:c.prototype.getLongHoldEvent(),data:new c.EventData(t)}),s=void 0},600)},y=function(){s&&(clearTimeout(s),s=void 0)},S=function(t){p=setTimeout(function(){e.publish({event:c.prototype.getClickEvent(),data:new c.EventData(t)}),p=void 0,h()},300)},V=function(){u=setTimeout(function(){u=void 0,h()},300)},E=function(){p&&(clearTimeout(p),p=void 0)},A=function(e){l=Date.now()},C=function(){l&&(clearTimeout(l),l=void 0)},D=function(){u&&(clearTimeout(u),u=void 0)},M=function(e){var t=0,i=e.gesture.events[0];return i&&i.event&&i.event.touches&&(t=i.event.touches.length),t},N=function(e){if(n=navigator.userAgent,!new RegExp("Mobile").test(n)){var t=e.gesture.events[0];if(t&&t.event&&t.event.touches){var i=t.event.touches[0];if(i.radiusX>30||i.radiusY>30)return!0}}var n;return!1};return c.EventData=function(e){this.name=e.gesture.name,this.position=e.from[0].getCurrentPosition(i),this.isTouch=M(e)>0},c.Down=1,c.Click=2,c}();return UWA.namespace("DS/CAT3DWVisu/CAT3DWVisuEvents",i)}),define("DS/CAT3DWVisu/CAT3DWThreeJsExtender",["DS/Visualization/ThreeJS_DS","UWA/Core"],function(e,t){"use strict";var i;e.ImageUtils.loadTexture3DWhiteboard=function(i,n,o,r,a,s,p,l){var u=document.createElement("canvas");u.width=16,u.height=16;var c=l;c?(c.image=u,c.mapping=n):c=new e.Texture(u,n),c.loadEndStatus=e.AssetLoadingStatus.LOADING;var h=null!==new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),d=!i.startsWith("data:");if(h&&d&&(void 0===a||!1===a)){var g={headers:{},method:"GET",authentication:"ajax",timeout:36e5,async:!0,type:"blob",onComplete:t=>{var i=URL.createObjectURL(t),n=new Image,a=new e.ImageLoader;a.addEventListener("load",()=>{var t,i;c.needsUpdate=!0,c.loadEndStatus=e.AssetLoadingStatus.READY,!s||this.is_pow2(n.width)&&this.is_pow2(n.height)?c.image=n:(t=this.nearest_pow2(n.width),i=this.nearest_pow2(n.height),c.image.originalWidth=n.width,c.image.originalHeight=n.height,c.image.width=t,c.image.height=i,c.image.getContext("2d").drawImage(n,0,0,t,i)),o&&o(c);for(var r=0;r<c.onLoadCallbacks.length;r++)c.onLoadCallbacks[r](c)}),a.addEventListener("error",t=>{r&&r(t.message),c.loadEndStatus=e.AssetLoadingStatus.ERROR}),a.load(i,n)},onFailure:t=>{r&&r(t.message),c.loadEndStatus=e.AssetLoadingStatus.ERROR},onTimeout:t=>{r&&r(t.message),c.loadEndStatus=e.AssetLoadingStatus.ERROR}};t.Data.request(i,g)}else{var f=new Image;null!==a&&(f.crossOrigin=a?"use-credentials":"anonymous");var _=new e.ImageLoader;_.addEventListener("load",()=>{var t,i;c.needsUpdate=!0,c.loadEndStatus=e.AssetLoadingStatus.READY,!s||this.is_pow2(f.width)&&this.is_pow2(f.height)?c.image=f:(t=this.nearest_pow2(f.width),i=this.nearest_pow2(f.height),c.image.originalWidth=f.width,c.image.originalHeight=f.height,c.image.width=t,c.image.height=i,c.image.getContext("2d").drawImage(f,0,0,t,i)),o&&o(c);for(var n=0;n<c.onLoadCallbacks.length;n++)c.onLoadCallbacks[n](c)}),_.addEventListener("error",t=>{r&&r(t.message),c.loadEndStatus=e.AssetLoadingStatus.ERROR}),f.crossOrigin&&(_.crossOrigin=f.crossOrigin),p?(c.loadEndStatus=e.AssetLoadingStatus.PAUSED,c.onRequest=function(){c.loadEndStatus=e.AssetLoadingStatus.LOADING,_.load(i,f),c.onRequest=null}):_.load(i,f),c.sourceFile=i}return c},e.Quaternion.prototype.setFromUnitVectors=(i=new e.Vector3,function(e,t){return this.w=1+e.dot(t),this.w<1e-6?(this.w=0,Math.abs(e.x)>Math.abs(e.z)?(this.x=-e.y,this.y=e.x,this.z=0):(this.x=0,this.y=-e.z,this.z=e.y)):(i.crossVectors(e,t),this.x=i.x,this.y=i.y,this.z=i.z),this.normalize()})}),define("DS/CAT3DWVisu/CAT3DWVisuServices",["DS/ApplicationFrame/FrameWindowsManager","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWVisu/CAT3DWDataFactory","DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","UWA/Class","UWA/Core"],function(e,t,i,n,o,r,a){"use strict";var s=r.extend({isRayCrossingNode:function(e,t){var i=!1;if(e.from){var n=e.from.externalPath;if(n)for(var o=n.length-1;!i&&o>=0;o--)n[o].name==t&&(i=!0)}return i},isPathElemCrossingNode:function(e,t){var i=!1;if(e){var n=e.externalPath;if(n)for(var o=n.length-1;!i&&o>=0;o--)n[o].name==t&&(i=!0)}return i},pick:function(t,i,n){var o=null,r=e.getFrameWindow().getViewer();if(r){var a=r.getMousePosition(t);o=r.pick(a,i,n)}return o},computePickingDataFromScreenEvent:function(t){var r=null;if(t instanceof o){var a=e.getFrameWindow().getViewer().canvas,s=t.getCurrentPosition(a),p=this.pick(s,"primHybrid",!0);(r=(new i).createPickingData())&&(r.visuEventData=t,r.path=p.path&&p.path.length?p.path[0]:null,r.position=p.position,r.normal=p.normal,r.tangent=p.tangent,r.uv=p.uv,r.ray=p.ray,r.position&&r.normal&&(r.plane=(new n.Plane).setFromNormalAndCoplanarPoint(p.normal,p.position)))}return r},computePickingDataFromOldVisuEvent:function(e){var t=null;e&&((t=(new i).createPickingData()).visuEventData=e,t.path=e.path,t.position=e.point,t.normal=e.normal,t.tangent=e.tangent,t.uv=e.uv,t.ray=e.ray,e.position&&e.normal&&(t.plane=(new n.Plane).setFromNormalAndCoplanarPoint(e.normal,e.position)));return t},computePickingDataFromEvent:function(e){var t=null,i=!1;if(e){if(e.from){var n=e.from[0];n instanceof o&&(i=!0,t=this.computePickingDataFromScreenEvent(n))}i||(t=this.computePickingDataFromOldVisuEvent(e))}return t},getMousePositionFromEvent:function(e,t){if(e&&e.from){var i=e.from[0];if(i instanceof o)return i.getCurrentPosition(t.canvas)}},computeBoundingBox:function(e){if(!e)return null;var t,i,n,o=e.getLastElement().sgNode,r=o.count,a=o.start,s=o.group.geometry,p=s.vertexIndexArray,l=s.vertexPositionArray,u=3*p[a],c=[];c[0]=l[u],c[1]=l[u+1],c[2]=l[u+2],c[3]=c[0],c[4]=c[1],c[5]=c[2];for(var h=1;h<r;h++)t=l[u=3*p[a+h]],i=l[u+1],n=l[u+2],t<c[0]?c[0]=t:t>c[3]&&(c[3]=t),i<c[1]?c[1]=i:i>c[4]&&(c[4]=i),n<c[2]?c[2]=n:n>c[5]&&(c[5]=n);return c}}),p=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return window.setTimeout(e,1e3/60,performance.now())};s.requestAnimationFrame=function(e){return p(e)};var l=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(e){window.clearTimeout(e)};s.cancelAnimationFrame=function(e){l(e)},s.getGrid=function(){return e.getFrameWindow().getViewer()?e.getFrameWindow().getViewer():null},s.getViewpoint=function(){return e.getFrameWindow().getViewpoint()?e.getFrameWindow().getViewpoint():null},s.getBestVectorDirection=function(e,t){var i=s.getViewpoint();if(!i)return null;var o=t.clone(),r=(new n.Vector3).subVectors(i.getEyePosition(),e);return o.dot(r)<0&&o.negate(),o},s.getMaxWidthValueAtPoint=function(e){var t=s.getViewpoint();return t?new u(t).getMaxWidthValueAtPoint(e):0},s.getMaxHeightValueAtPoint=function(e){var t=s.getViewpoint();return t?new u(t).getMaxHeightValueAtPoint(e):0},s.getDefaultTranslationValue=function(e,t){var i=s.getViewpoint();return i?new u(i).getDefaultTranslationValue(e,t):0},s.compute2DPointFrom3DPoint=function(t,i){i||(i=e.getFrameWindow().getViewer());var o=i.currentViewpoint.project(t);return new n.Vector2(o.x,o.y)},s.compute3DPointFrom2DPoint=function(t,i,o){return o||(o=e.getFrameWindow().getViewer()),o.currentViewpoint.create3DRayFrom2DPoint(new n.Vector3(t.x,t.y,0),o.currentViewpoint.camera).intersectPlane(i)},s.reframe=function(i){var o=i||0,r=e.getFrameWindow().getViewer();if("whiteboard"===t.getPreferenceValue("appMode")){let e=r.getRootNode().getBoundingBox(),t=e.max.clone().sub(e.min),i=e.min.clone().add(t.multiplyScalar(.5)),a=r.currentViewpoint.getCamera().aspect,s=e.max.x-e.min.x,p=e.max.y-e.min.y,l=Math.max(s,p/a);0===l&&(l=200);let u=new n.Sphere(i,l/2);r.currentViewpoint.reframe(null,o,u)}else r.currentViewpoint.reframe(null,o)};var u=function(e){var t=e.getSightDirection(),i=e.getUpDirection(),o=(new n.Vector3).crossVectors(t,i).normalize();this.rotationMatrix=new n.Matrix4,this.rotationMatrix.set(o.x,o.y,o.z,0,t.x,t.y,t.z,0,i.x,i.y,i.z,0,0,0,0,1),this.invRotationMatrix=(new n.Matrix4).getInverse(this.rotationMatrix),this.translationVector=e.getEyePosition().clone().negate(),this.near=e.camera.near,this.far=e.camera.far;var r=.5*Math.PI/180,a=Math.tan(e.camera.fov*r),s=a*this.near,p=e.camera.aspect*s;this.cameraPos=e.getEyePosition();var l=this.cameraPos.clone().add(t.clone().multiplyScalar(this.near));this.vUp=l.clone().add(i.clone().multiplyScalar(s)).sub(this.cameraPos).normalize(),this.vUp=this._getVectorInViewpointRef(this.vUp),this.vRight=l.clone().add(o.clone().multiplyScalar(p)).sub(this.cameraPos).normalize(),this.vRight=this._getVectorInViewpointRef(this.vRight),this.u=new n.Vector3(1,0,0),this.v=new n.Vector3(0,1,0),this.w=new n.Vector3(0,0,1),this.maxHeight=a*this.far,this.maxWidth=e.camera.aspect*this.maxHeight};return u.prototype.getMaxHeightValueAtPoint=function(e){return(new n.Vector3).subVectors(this.cameraPos,e).length()/this.far*this.maxHeight},u.prototype.getMaxWidthValueAtPoint=function(e){return(new n.Vector3).subVectors(this.cameraPos,e).length()/this.far*this.maxWidth},u.prototype.getDefaultTranslationValue=function(e,t){var i=this._getVectorInViewpointRef(t);if(i.normalize(),Math.abs(i.y)>.9)return 0;var o=this._getPointInViewpointRef(e);if(!this._isPointVisible(o))return 0;var r=(new n.Plane).setFromNormalAndCoplanarPoint(this.v,o),a=new n.Ray(new n.Vector3,this.vUp),s=a.intersectPlane(r),p=.2*s.z,l=.05*s.z,u=(s.z-o.z)/s.z,c=(u=u>1?1:u)*p,h=!1;c<l&&(c=l,h=!0),(c=Math.floor(c))<1&&(c=1,h=!0),r=(new n.Plane).setFromNormalAndCoplanarPoint(this.v,o);var d=(a=new n.Ray(new n.Vector3,this.vRight)).intersectPlane(r);p=.2*d.z,l=.05*d.z;var g=(u=(u=(d.z-o.z)/d.z)>1?1:u)*p;if(g<l&&(g=l,h=!0),(g=Math.floor(g))<1&&(g=1,h=!0),c=Math.max(c,g),h){var f=o.clone().add(i.multiplyScalar(c));if(!this._isPointVisible(f))return 0}return c},u.prototype._isPointVisible=function(e){if(e.y<=this.near||e.y>=this.far)return!1;var t=e.clone().normalize();return!(Math.abs(t.dot(this.w))>Math.abs(this.vUp.dot(this.w)))&&!(Math.abs(t.dot(this.u))>Math.abs(this.vRight.dot(this.u)))},u.prototype._getVectorInViewpointRef=function(e){var t=e.clone();return t.applyMatrix4(this.rotationMatrix),t},u.prototype._getVectorInWorldRef=function(e){var t=e.clone();return t.applyMatrix4(this.invRotationMatrix),t},u.prototype._getPointInViewpointRef=function(e){var t=e.clone();return t.add(this.translationVector),t.applyMatrix4(this.rotationMatrix),t},u.prototype._getPointInWorldRef=function(e){var t=e.clone();return t.applyMatrix4(this.invRotationMatrix),t.sub(this.translationVector),t},a.namespace("DS/CAT3DWVisu/CAT3DWVisuServices",s)}),define("DS/CAT3DWVisu/CAT3DWDrawPlaneServices",["DS/CAT3DWVisu/CAT3DWSession","DS/CAT3DWVisu/CAT3DWTolerance","DS/Visualization/ThreeJS_DS"],function(e,t,i){"use strict";var n=function(){};return n._u=new i.Vector3(1,0,0),n._v=new i.Vector3(0,1,0),n._w=new i.Vector3(0,0,1),n.getMostSeenVecticalPlane=function(e,t){if(!t||!t.getSightDirection)return null;var o=null,r=t.getSightDirection(),a=Math.abs(n._u.dot(r)),s=Math.abs(n._v.dot(r));return s&&(!a||a<s)?(o=new i.Plane).setFromNormalAndCoplanarPoint(n._v,e):a&&(o=new i.Plane).setFromNormalAndCoplanarPoint(n._u,e),o},n.getMostSeenPlane=function(e,t,o){var r=new i.Ray(o.getEyePosition(),o.getSightDirection()),a=r.intersectPlane(e),s=r.intersectPlane(t),p=void 0!==a&&n.isInFront(a,r,o.getEyePosition()),l=void 0!==s&&n.isInFront(s,r,o.getEyePosition());if(p){if(l){var u=e.normal.dot(o.getSightDirection()),c=t.normal.dot(o.getSightDirection());return Math.abs(u)>=Math.abs(c)?e:t}return e}return l?t:null},n.isInFront=function(e,t,n){var o=new i.Vector3,r=n||t.origin;return o.subVectors(e,r).normalize(),o.dot(t.direction)>0},n.computeBestDrawPlane=function(o,r,a,s){if(!(o&&o instanceof i.Vector3&&r&&r instanceof i.Vector3))return null;var p=new i.Vector3;if(p.subVectors(r,o),p.normalize(),s&&Math.abs(p.dot(s.normal))<t.tolerance)return s;var l=e.getDrawingPlane();if(l&&l.plane&&Math.abs(p.dot(l.plane.normal))<t.tolerance)return l.plane;var u=null,c=p.dot(n._w),h=new i.Vector3;return h.crossVectors(p,n._w),Math.abs(c)<t.tolerance?((u=new i.Plane).setFromNormalAndCoplanarPoint(n._w,o),u.projectPoint(r),u):h.length()<t.tolerance?(u=n.getMostSeenVecticalPlane(o,a))?(u.projectPoint(r),u):void 0:(u=new i.Plane,h.normalize(),u.setFromNormalAndCoplanarPoint(h,o),u)},n.getDrawPlaneFrom3Points=function(e,t,n){return(new i.Plane).setFromCoplanarPoints(e,t,n)},n.getDrawPlaneFrom2Points=function(e,o){var r=(new i.Vector3).subVectors(o,e).normalize(),a=n._w,s=a.dot(r);s*s<t.squareTolerance&&(a=n._u);var p=(new i.Vector3).crossVectors(a,r).normalize(),l=r.clone().cross(p);return(new i.Plane).setFromNormalAndCoplanarPoint(l,e)},n}),define("DS/CAT3DWVisu/CAT3DWWorkingPlane",["DS/CAT3DWVisu/CAT3DWDataFactory","DS/CAT3DWVisu/CAT3DWDrawPlaneServices","DS/CAT3DWVisu/CAT3DWTolerance","DS/Visualization/ThreeJS_DS","UWA/Class"],function(e,t,i,n,o){"use strict";var r=o.extend({init:function(e){this._bSnapOnGrid=!0,this._viewer=e,this._chosenImpl=r.ImplEnum.FREE,this._impl=new r._implementations[this._chosenImpl](this._viewer,this._bSnapOnGrid),this._impl.set()},setMode:function(e,t){this._chosenImpl!==e&&(this._chosenImpl=e,this._impl=new r._implementations[e](this._viewer,this._bSnapOnGrid)),this._impl.set(t)},getMode:function(){return this._chosenImpl},reset:function(){this._impl.reset()},pick:function(e){return this._impl.pick(e)},setSnapOnGridValues:function(e){this._bSnapOnGrid=e,this._impl.setSnapOnGridValues(this._bSnapOnGrid)},setCustomSnappingAlgo:function(e){this._impl.setCustomSnappingAlgo(e)},removeCustomSnappingAlgo:function(){this._impl.removeCustomSnappingAlgo()},getPlane:function(){return this._impl.getPlane()}});r._floorPlane=new n.Plane(new n.Vector3(0,0,1)),r.ImplEnum=Object.freeze({FREE:0,LOCKEDPLANE:1}),r._implementations=[];var a=o.extend({init:function(e,t){this._wOffset=e.internalSceneGraph.getSceneMin(),null===this._wOffset&&(this._wOffset=0),this._uNormal=new n.Vector3(1,0,0),this._vNormal=new n.Vector3(0,1,0),this._wNormal=new n.Vector3(0,0,1),this._uPlane=new n.Plane(this._uNormal),this._vPlane=new n.Plane(this._vNormal),this._wPlane=new n.Plane(this._wNormal,-this._wOffset),this._plane=this._wPlane,this._floor=null,this._viewpoint=null,this._gridSnapAlgo=function(){},this._customSnapAlgo=null,this.setSnapOnGridValues(t)},reset:function(){this._plane=r._floorPlane,this._floor=null,this._customSnapAlgo=null},setSnapOnGridValues:function(e){this._gridSnapAlgo=e?this._snapOnGrid:function(){}},setCustomSnappingAlgo:function(e){this._customSnapAlgo=e},removeCustomSnappingAlgo:function(){this._customSnapAlgo=null},_snapOnGrid:function(e){if(e.point.position&&e.plane){var t=null;this._customSnapAlgo&&(t=this._customSnapAlgo(e)),t||(t=this._snapOnTheFloor(e)),t||(t=this._snapOnGridValues(e)),t&&(e.point.position=t)}},_snapOnTheFloor:function(e){var t=null,i=.25*this._floor.getGridUnit();if(Math.abs(e.point.position.z)<i&&!l(e.plane.normal.z,1)&&!l(e.point.position.z,this._wOffset)){var o=new n.Vector3(e.point.position.x,e.point.position.y,this._wOffset),a=(new n.Vector3).subVectors(o,e.point.position).normalize();a.projectOnPlane(e.plane.normal),a.normalize();var s=new n.Ray(e.point.position,a).intersectPlane(r._floorPlane);if(void 0!==s)if(s.distanceTo(e.point.position)<i){var p=.5*this._floor.getGridUnit(),u=Math.floor(s.x/p)*p,c=Math.floor(s.y/p)*p,h=u+p,d=c+p,g=(new n.Vector3).crossVectors(e.plane.normal,new n.Vector3(0,0,1)).normalize(),f=[],_=0;if(l(g.x,0))l(g.y,0)||(f[_++]=new n.Vector3(s.x,c,this._wOffset),f[_++]=new n.Vector3(s.x,d,this._wOffset));else if(l(g.y,0))f[_++]=new n.Vector3(u,s.y,this._wOffset),f[_++]=new n.Vector3(h,s.y,this._wOffset);else{var v=g.x/g.y,w=s.y-v*s.x,m=v*u+w;m>=c&&m<=d&&(f[_++]=new n.Vector3(u,m,this._wOffset)),(m=v*h+w)>=c&&m<=d&&(f[_++]=new n.Vector3(h,m,this._wOffset));var P=(v=g.y/g.x)*c+(w=s.x-v*s.y);P>u&&P<h&&(f[_++]=new n.Vector3(P,c,this._wOffset)),(P=v*d+w)>u&&P<h&&(f[_++]=new n.Vector3(P,d,this._wOffset))}t=f[0];for(var T=s.distanceTo(f[0]),y=f.length,S=1;S<y;S++)T>s.distanceTo(f[S])&&(t=f[S]);t.z=this._wOffset}}return t},_snapOnGridValues:function(e){if(e.point.position&&e.plane){var t=e.plane.normal,i=Math.abs(this._uNormal.dot(t)),n=Math.abs(this._vNormal.dot(t)),o=Math.abs(this._wNormal.dot(t));return i<n?n<o?this._snapOnWGrid(e):this._snapOnVGrid(e):i<o?this._snapOnWGrid(e):this._snapOnUGrid(e)}},_snapOnUGrid:function(e){e.point.position=this._uPlane.projectPoint(e.point.position);var t=.5*this._floor.getGridUnit(),i=Math.round(e.point.position.y/t)*t,o=Math.round(e.point.position.z/t)*t,r=new n.Vector3(e.point.position.x,i,o);return new n.Ray(r,this._uNormal).intersectPlane(e.plane)},_snapOnVGrid:function(e){e.point.position=this._vPlane.projectPoint(e.point.position);var t=.5*this._floor.getGridUnit(),i=Math.round(e.point.position.x/t)*t,o=Math.round(e.point.position.z/t)*t,r=new n.Vector3(i,e.point.position.y,o);return new n.Ray(r,this._vNormal).intersectPlane(e.plane)},_snapOnWGrid:function(e){e.point.position=this._wPlane.projectPoint(e.point.position);var t=.5*this._floor.getGridUnit(),i=Math.round(e.point.position.x/t)*t,o=Math.round(e.point.position.y/t)*t,r=new n.Vector3(i,o,e.point.position.z);return new n.Ray(r,this._wNormal).intersectPlane(e.plane)}});function s(t,i,n,o){return t.path=i.path,t.ray=i.ray,t.plane=o?o.clone():null,t.point.position=n,t.point.supportType=e.SupportTypes.WORKING_PLANE,t.point.supportData=null,t}function p(e,t,i,n){var o=i.getEyePosition(),r=t.projectPoint(o);return e.distanceTo(r)<.25*n}function l(e,t){return(i=Math.abs(e)-Math.abs(t))*i<u;var i}r._implementations[r.ImplEnum.FREE]=a.extend({init:function(e,t){this._parent(e,t),this._point1=null,this._point2=null,this._plane1=null,this._plane2=null,this._pickingAlgo=this._algo0or1Point},set:function(e){if(this.reset(),e&&(e.viewpoint&&e.viewpoint.getEyePosition&&e.viewpoint.getSightDirection&&(this._viewpoint=e.viewpoint),e.floor&&e.floor.planeSize&&"number"==typeof e.floor.planeSize&&void 0!==e.floor.getGridUnit&&(this._floor=e.floor),e.point1&&e.point1 instanceof n.Vector3&&(this._point1=(new n.Vector3).copy(e.point1),this._uPlane.setFromNormalAndCoplanarPoint(this._uNormal,this._point1),this._vPlane.setFromNormalAndCoplanarPoint(this._vNormal,this._point1),l(this._point1.z,this._wOffset)||(this._pickingAlgo=this._algoVerticalOnly),e.point2&&e.point2 instanceof n.Vector3&&this._viewpoint&&(this._point2=(new n.Vector3).copy(e.point2),this._plane1=t.computeBestDrawPlane(this._point1,this._point2,this._viewpoint),this._plane1)))){var i=(new n.Vector3).subVectors(this._point2,this._point1).normalize(),o=this._plane1.normal,r=(new n.Vector3).crossVectors(i,o).normalize();this._plane2=(new n.Plane).setFromNormalAndCoplanarPoint(r,this._point1),this._pickingAlgo=this._algo2Points}},reset:function(){this._parent(),this._viewpoint=null,this._uPlane=new n.Plane(this._uNormal),this._vPlane=new n.Plane(this._vNormal),this._point1=null,this._point2=null,this._pickingAlgo=this._algo0or1Point},pick:function(t){this._plane=null;var i=new e.PickingData;return t&&t.ray&&this._floor&&this._viewpoint&&this._pickingAlgo(i,t)&&this._gridSnapAlgo(i),i},_algo0or1Point:function(e,i){var n=i.ray.intersectPlane(this._wPlane);if(n&&t.isInFront(n,i.ray,this._viewpoint.getEyePosition())){if(p(n,this._wPlane,this._viewpoint,this._floor.planeSize))return this._plane=this._wPlane,s(e,i,n,this._plane),!0}else n=null;return!!this._algoVerticalOnly(e,i)||(n?(this._plane=this._wPlane,s(e,i,n,this._plane),!0):(s(e,i,null,null),!1))},_algoVerticalOnly:function(e,i){var n=this._viewpoint.getSightDirection(),o=Math.abs(this._uPlane.normal.dot(n)),r=Math.abs(this._vPlane.normal.dot(n));if(r&&(!o||o<r)){var a=i.ray.intersectPlane(this._vPlane);if(a&&t.isInFront(a,i.ray,this._viewpoint.getEyePosition()))return this._plane=this._vPlane,s(e,i,a,this._plane),!0}else if(o){var p=i.ray.intersectPlane(this._uPlane);if(p&&t.isInFront(p,i.ray,this._viewpoint.getEyePosition()))return this._plane=this._uPlane,s(e,i,p,this._plane),!0}return s(e,i,null,null),!1},_algo2Points:function(e,i){var n=i.ray.intersectPlane(this._plane1);if(n&&t.isInFront(n,i.ray,this._viewpoint.getEyePosition())){if(p(n,this._plane1,this._viewpoint,this._floor.planeSize))return this._plane=this._plane1,s(e,i,n,this._plane),!0}else n=null;var o=i.ray.intersectPlane(this._plane2);return o&&t.isInFront(o,i.ray,this._viewpoint.getEyePosition())?(this._plane=this._plane2,s(e,i,o,this._plane),!0):n?(this._plane=this._plane1,s(e,i,n,this._plane),!0):(s(e,i,null,null),!1)},getPlane:function(){return this._plane.clone()}}),r._implementations[r.ImplEnum.LOCKEDPLANE]=a.extend({init:function(e,t){this._parent(e,t)},set:function(e){this.reset(),e&&(e.viewpoint&&e.viewpoint.getEyePosition&&e.viewpoint.getSightDirection&&(this._viewpoint=e.viewpoint),e.plane&&e.plane instanceof n.Plane?this._plane=new n.Plane(e.plane.normal,e.plane.constant):e.normal&&e.normal instanceof n.Vector3&&(e.point&&e.point instanceof n.Vector3?(this._plane=new n.Plane,this._plane.setFromNormalAndCoplanarPoint(e.normal,e.point)):this._plane=new n.Plane(e.normal)),e.floor&&void 0!==e.floor.getGridUnit&&(this._floor=e.floor))},reset:function(){this._parent()},pick:function(i){var n=new e.PickingData;if(i){var o=i.ray.intersectPlane(this._plane);o&&t.isInFront(o,i.ray,this._viewpoint.getEyePosition())&&(s(n,i,o,this._plane),this._floor&&this._gridSnapAlgo(n))}return n},getPlane:function(){return this._plane.clone()}});var u=i.tolerance*i.tolerance;return r}),define("DS/CAT3DWVisu/CAT3DWWorkingPlaneController",["DS/CAT3DWVisu/CAT3DWWorkingPlane","DS/CAT3DWVisu/CAT3DWSession","DS/CAT3DWVisu/CAT3DWTolerance","DS/CAT3DWVisu/CAT3DWVisuServices","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","UWA/Class"],function(e,t,i,n,o,r,a){"use strict";return a.singleton({init:function(){},initialize:function(i,r){this._viewpoint=n.getViewpoint(),this._workingPlane=new e(i),this._isPlaneLocked=!1,this._forcePicking=!1;var a=t.getSnapOnGrid();if(this._workingPlane.setSnapOnGridValues(a),this._snapEventToken=o.subscribe({event:t.getChangeSnapOnGridEvent()},this._onSnapEvent.bind(this),!1),!r){this._planeEventToken=o.subscribe({event:t.getChangeDrawingPlaneEvent()},this._onPlaneEvent.bind(this),!1);var s=t.getDrawingPlane();if(s.plane)return void this.lockPlane(s.plane,!s.isFloor)}this._workingPlane.setMode(e.ImplEnum.FREE,{floor:n.getGrid(),viewpoint:this._viewpoint})},_onSnapEvent:function(e){this._workingPlane.setSnapOnGridValues(e)},_onPlaneEvent:function(e){e&&(e.plane?this.lockPlane(e.plane,!e.isFloor):this.unlockPlane())},pick:function(e){return this._workingPlane.pick(e)},reset:function(){return this._snapEventToken&&(o.unsubscribe(this._snapEventToken),this._snapEventToken=void 0),this._planeEventToken&&(o.unsubscribe(this._planeEventToken),this._planeEventToken=void 0),this._workingPlane.reset()},isPickedPointAuthorized:(s=.1*i.tolerance,s*=s,function(e){if(!this._isPlaneLocked||!this._forcePicking)return!0;var t=this._workingPlane.getPlane();if(t&&e){var i=t.distanceToPoint(e)/this._viewpoint.getEyePosition().distanceTo(e);if(i*i<s)return e=t.projectPoint(e),!0}return!1}),lockPoint:function(t){if(!this._isPlaneLocked&&t&&t instanceof r.Vector3){var i={floor:n.getGrid(),viewpoint:this._viewpoint,point1:t};this._workingPlane.setMode(e.ImplEnum.FREE,i)}},lockSegment:function(t,i){if(!this._isPlaneLocked&&t&&i&&t instanceof r.Vector3&&i instanceof r.Vector3){var o={floor:n.getGrid(),viewpoint:this._viewpoint,point1:t,point2:i};this._workingPlane.setMode(e.ImplEnum.FREE,o)}},unlockPoints:function(){if(!this._isPlaneLocked){var t={floor:n.getGrid(),viewpoint:this._viewpoint};this._workingPlane.setMode(e.ImplEnum.FREE,t)}},lockPlane:function(t,i){if(t){var o={plane:t,floor:n.getGrid(),viewpoint:this._viewpoint};this._isPlaneLocked=!0,this._workingPlane.setMode(e.ImplEnum.LOCKEDPLANE,o)}i?this._forcePicking=!0:!1===i&&(this._forcePicking=!1)},unlockPlane:function(){this._isPlaneLocked=!1,this._forcePicking=!1,this._workingPlane.setMode(e.ImplEnum.FREE,{floor:n.getGrid(),viewpoint:this._viewpoint})},isPlaneLocked:function(){return this._workingPlane.getMode()===e.ImplEnum.LOCKEDPLANE},getLockedPlane:function(){var e=null;return this.isPlaneLocked()&&(e=this._workingPlane.getPlane()),e},setCustomSnappingAlgo:function(e){this._workingPlane.setCustomSnappingAlgo(e)},removeCustomSnappingAlgo:function(){this._workingPlane.removeCustomSnappingAlgo()},setSnapOnGrid:function(e){this._workingPlane.setSnapOnGridValues(e)}});var s}),define("DS/CAT3DWVisu/CAT3DWPickingController",["DS/ApplicationFrame/FrameWindowsManager","DS/CAT3DWVisu/CAT3DWDataFactory","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWVisu/CAT3DWVisuServices","DS/CAT3DWVisu/CAT3DWWorkingPlaneController","DS/Visualization/ThreeJS_DS","DS/WebUtils/ContextedSingleton"],function(e,t,i,n,o,r,a){"use strict";return function(){var s=null,p=null,l="",u="",c="",h=null,d=null,g=null,f=null,_=null,v="primHybrid",w=4294967295,m=[],P=null,T=null,y=function(e,t){T=i.getPreferenceValue("PickingDebug")?B:U,e&&(l=(f=e).getMagnetsRootName()),t&&(u=t.getImageMagnetsRootName(),_=t)};y.prototype.sceneUINodeName="sceneUINode",y.prototype.pickingAreaRootNodeName="pickingAreaRootNode",y.prototype.annotationGroupNodeName="annotGroupNode",y.prototype.rootImageNodeName="images",y.prototype.rootModelNodeName="model3DNode",y.prototype.rootTextNodeName="texts",y.prototype.rootConnectionNodeName="connections",y.prototype.init=function(i,r){if(p=e.getFrameWindow().getViewer(),s=new n,w=i||t.SupportTypes.ALL,(g=o).initialize(p,r),f&&f.start(),w&t.SupportTypes.IMAGE_MAGNET&&_){var a=g.getLockedPlane();_.initialize(a)}w&t.SupportTypes.AR_MAGNET&&(c="ARPolylineRootNode"),S(),this.addPickingPriority(t.getLabelOf(t.SupportTypes.PICKING_AREA),Number.MIN_SAFE_INTEGER),this.addPickingPriority(t.getLabelOf(t.SupportTypes.IMAGE),-2),this.addPickingPriority(t.getLabelOf(t.SupportTypes.FACE),0),this.addPickingPriority(t.getLabelOf(t.SupportTypes.IMAGE_MAGNET),1),this.addPickingPriority(t.getLabelOf(t.SupportTypes.AR_LINE_MAGNET),2),this.addPickingPriority(t.getLabelOf(t.SupportTypes.WEB_LINE_MAGNET),3),this.addPickingPriority(t.getLabelOf(t.SupportTypes.LINE_MAGNET),4),this.addPickingPriority(t.getLabelOf(t.SupportTypes.EDGE),5),this.addPickingPriority(t.getLabelOf(t.SupportTypes.ANNOTATION),6),this.addPickingPriority(t.getLabelOf(t.SupportTypes.AR_POINT_MAGNET),7),this.addPickingPriority(t.getLabelOf(t.SupportTypes.WEB_POINT_MAGNET),8),this.addPickingPriority(t.getLabelOf(t.SupportTypes.POINT_MAGNET),9),this.addPickingPriority(t.getLabelOf(t.SupportTypes.VERTEX),10),this.addPickingPriority(t.getLabelOf(t.SupportTypes.PREVIEW_ITEM),11)},y.prototype.setHybridPicking=function(){v="primHybrid"},y.prototype.setCPUPicking=function(){v="prim"},y.prototype.clear=function(){g&&g.reset(),f&&f.stop(),_&&_.clear(),V(),m=[]},y.prototype.reset=function(){g.reset()},y.prototype.resetHighlights=function(){f&&f.preHandlePickedElement(),_&&_.preHandlePickedElement()},y.prototype.getMagnetsController=function(){var e=null;return f&&(e=f.getMagnetsController()),e},y.prototype.setPickingMask=function(e){w=e},y.prototype.getPickingMask=function(){return w},y.prototype.lockPoint=function(e){g.lockPoint(e),h=e},y.prototype.lockSegment=function(e,t){g.lockSegment(e,t),h=e,d=(new r.Vector3).subVectors(t,e).normalize()},y.prototype.unlockPoints=function(){g.unlockPoints(),h=null,d=null},y.prototype.lockPlane=function(e,t){void 0===t&&(t=!0),g.lockPlane(e,t)},y.prototype.unlockPlane=function(){g.unlockPlane()},y.prototype.isPlaneLocked=function(){return g.isPlaneLocked()},y.prototype.setCustomSnappingAlgo=function(e){g.setCustomSnappingAlgo(e)},y.prototype.removeCustomSnappingAlgo=function(){g.removeCustomSnappingAlgo()},y.prototype.addPickingPriority=function(e,t){m.push({id:e,priority:t}),p.setPickingPriority(m)};var S=function(){p&&(P=p.pickingPriorityMapping)&&(m=P.slice())},V=function(){p&&p.setPickingPriority(P)},E=null;y.prototype.decodeNotification=function(e,t){return E=s.getMousePositionFromEvent(e,p),E=p.getMousePosition(E),T(E,t)},y.prototype.pick=function(e,t,i){return E=p.getMousePosition(e),T(E,t,i)};var A,C,D,M,N,b,G,O,k,x,I,W,R,L,F,z,U=(A=0,C=null,D=0,M=0,N=0,b=!1,G=null,O=new r.Vector3,k=null,x={intersectFaces:!0,intersectEdges:!0,intersectPoints:!0},I=null,W=null,R=null,L=new r.Vector3,F=new r.Plane,z=null,function(e,i,n){if(f&&f.preHandlePickedElement(),_&&_.preHandlePickedElement(),!(C=p.pick(e,n?"prim":v,!0)))return null;if(C.normal&&C.position&&(C.plane=(new r.Plane).setFromNormalAndCoplanarPoint(C.normal,C.position)),z=new t.PickingData,C.path&&C.path[0]){if(b=!1,D=C.path[0],!(M=H(C.path[0])))for(A=1;A<C.path.length;A++)if(C.path[A]&&(N=H(C.path[A]))){(N&t.SupportTypes.GEOMETRY||N&t.SupportTypes.IMAGE)&&(b=!0),D=C.path[A],M=N;break}if(M&t.SupportTypes.MAGNET){for(A=1;A<C.path.length;A++)if(C.path[A])if((N=H(C.path[A]))>M)D=C.path[A],M=N,b=!0;else if(N<M&&N&t.SupportTypes.GEOMETRY)break}else if(M&t.SupportTypes.IMAGE||M&t.SupportTypes.ANNOTATION)for(A=1;A<C.path.length;A++)C.path[A]&&(N=H(C.path[A]))>M&&(D=C.path[A],M=N,b=!0);if(b&&(G=D.externalPath[D.externalPath.length-1].mesh3js,O.copy(G.geometry.boundingSphere.center),O.applyMatrix4(G.matrixWorld),x.edgeTolerance=p.currentViewpoint.camera.getWorldSizeFromPixelSize(p.picking.tolerance,O,p.renderer.deviceHeight),x.pointTolerance=x.edgeTolerance,M&t.SupportTypes.GEOMETRY?M===t.SupportTypes.FACE?(x.intersectFaces=!0,x.intersectEdges=!1,x.intersectPoints=!1):M===t.SupportTypes.EDGE?(x.intersectFaces=!1,x.intersectEdges=!0,x.intersectPoints=!1):(x.intersectFaces=!1,x.intersectEdges=!1,x.intersectPoints=!0):M&t.SupportTypes.MAGNET?(x.intersectFaces=!0,x.intersectEdges=!0,x.intersectPoints=!1):(x.intersectFaces=!0,x.intersectEdges=!0,x.intersectPoints=!0),(G=p.castRay(C.ray,D.externalPath[D.externalPath.length-1],"prim",x))&&G.length))for(A=0;A<G.length;A++)if(G[A].pathElement.internalPath[G[A].pathElement.internalPath.length-1].id===D.internalPath[D.internalPath.length-1].id&&G[A].primitive&&(!(k=G[A].primitive.getIdentificationObject())||!k.isTemporary())){C.position=G[A].point,C.tangent=G[A].tangent,G[A].normal&&G[A].point&&(C.plane=(new r.Plane).setFromNormalAndCoplanarPoint(G[A].normal,G[A].point));break}if(M){if(M&t.SupportTypes.GEOMETRY){if(i||g.isPickedPointAuthorized(C.position)){if(z.ray=C.ray,z.path=D,z.plane=C.plane,z.tangent=C.tangent,z.point.position=C.position,z.point.supportData=null,z.point.supportType=M,M===t.SupportTypes.VERTEX)return f.handleVertex(z),z;if(M===t.SupportTypes.EDGE)return f.handleEdge(z),z;if(M===t.SupportTypes.FACE)return f.handleFace(z),z}}else if(M&t.SupportTypes.MAGNET){if((W=D.externalPath[1])&&(W.snapPosition||(W=D.externalPath[2])&&W.snapPosition||(W=null)),W&&(R=W.snapPosition(C.position,h,d),i||g.isPickedPointAuthorized(R)))return z.ray=C.ray,z.path=D,z.plane=C.plane,W.getTangents&&(z.tangents=W.getTangents(R)),z.point.position=R,z.point.supportType=M,z.point.supportData={id:W.name,node:W},f.handleMagnet(z),z}else{if(M&t.SupportTypes.PREVIEW_ITEM)return z.point.supportType=t.SupportTypes.PREVIEW_ITEM,z.point.supportData=null,(W=D.externalPath[1]).isVertexManipulator&&W.getMatrix?(L.getPositionFromMatrix(W.getMatrix()),(i||g.isPickedPointAuthorized(L))&&(z.ray=C.ray,z.path=D,z.plane=C.plane,z.tangent=C.tangent,z.point.position=L.clone(),W.getAllowedForOnDemand()&&(z.point.supportData=W.getID(),f.handleManipulator(z)))):W.isGroupManipulator&&W.getMatrix&&(i||g.isPickedPointAuthorized(C.position))&&(z.ray=C.ray,z.path=D,z.plane=C.plane,z.tangent=C.tangent,z.point.position=C.position.clone()),z;if(M&t.SupportTypes.IMAGE_MAGNET){if(I=D.externalPath[1],W=D.externalPath[2],I&&W&&(L.getPositionFromMatrix(W.getMatrixWorld()),i||g.isPickedPointAuthorized(L)))return F.setFromNormalAndCoplanarPoint(I.imageNormal,L),z.ray=C.ray,z.path=D,z.plane=F.clone(),z.point.position=L.clone(),z.point.supportType=t.SupportTypes.IMAGE_MAGNET,z.point.supportData={type:1},_.handleImageMagnet(z),z}else if(M&t.SupportTypes.IMAGE){if(i||g.isPickedPointAuthorized(C.position))return z.point.supportType=t.SupportTypes.IMAGE,z.point.supportData=null,z.ray=C.ray,z.path=D,z.plane=C.plane,z.tangent=C.tangent,z.point.position=C.position,z}else if(M&t.SupportTypes.ANNOTATION){if(i||g.isPickedPointAuthorized(C.position)){z.point.supportType=t.SupportTypes.ANNOTATION,z.point.supportData=null,z.ray=C.ray,z.path=D,z.tangent=C.tangent,z.point.position=C.position;var o=z.path.externalPath[2].annotID,s=a.get(null,"ANNOTATION_MANAGER"),l=s.getPlaneAndTypeFromAnnotId(o);return l&&(z.plane=l.annotPlane,z.type=l.annotType,z.point.supportData=s.getAnnotationFromAnnotId(o)),z}}else if(M&t.SupportTypes.PICKING_AREA)return z.point.supportType=t.SupportTypes.PICKING_AREA,z.point.supportData=null,W=D.externalPath[1],(i||g.isPickedPointAuthorized(L))&&(z.ray=C.ray,z.path=D,z.plane=C.plane,z.tangent=C.tangent,z.point.position=L.clone()),z}if(M&t.SupportTypes.AR_POINT_MAGNET&&(W=D.externalPath[2].getChildByName("billBoardNode"),(i||g.isPickedPointAuthorized(C.position))&&(z.ray=C.ray,z.path=D,z.plane=C.plane,z.tangent=C.tangent,z.point.position=C.position,z.point.supportData={id:W.parents[0].name,node:W},z.point.supportType=M,M===t.SupportTypes.AR_POINT_MAGNET||M===t.SupportTypes.AR_LINE_MAGNET)))return z}}return w&t.SupportTypes.WORKING_PLANE&&(z=g.pick(C))?z:null}),B=function(e){var i=U(e);if(i&&i.point&&i.point.supportType)switch(i.point.supportType){case t.SupportTypes.VERTEX:console.log("vertex");break;case t.SupportTypes.EDGE:console.log("edge");break;case t.SupportTypes.FACE:console.log("face");break;case t.SupportTypes.POINT_MAGNET:console.log("point magnet");break;case t.SupportTypes.LINE_MAGNET:console.log("line magnet");break;case t.SupportTypes.WEB_POINT_MAGNET:console.log("web point magnet");break;case t.SupportTypes.WEB_LINE_MAGNET:console.log("web line magnet");break;case t.SupportTypes.PREVIEW_ITEM:console.log("preview item");break;case t.SupportTypes.IMAGE_MAGNET:console.log("image magnet");break;case t.SupportTypes.AR_POINT_MAGNET:console.log("ar point magnet");break;case t.SupportTypes.WORKING_PLANE:console.log("working plane");break;case t.SupportTypes.IMAGE:console.log("image");break;case t.SupportTypes.ANNOTATION:console.log("annotation")}return i},H=function(){var e=0,i="",n=null;return function(o){if(o.internalPath.length>1&&(o.internalPath[1].sgNode.getCgmId?o.internalPath[1].sgNode.getCgmId():o.internalPath[1].sgNode.cgmId)>0){if((n=o.internalPath[1].sgNode.getIdentificationObject())&&!0===n.isTemporary())return t.SupportTypes.NONE;if((e=o.internalPath[1].sgNode.getGroup().glType)>3&&w&t.SupportTypes.FACE)return t.SupportTypes.FACE;if(e>0&&w&t.SupportTypes.EDGE)return t.SupportTypes.EDGE;if(w&t.SupportTypes.VERTEX)return t.SupportTypes.VERTEX}else{if(!(i=o.externalPath[0].name))return"";if(i===l){if(e=o.externalPath[1].getType(),w&e)return e}else if(""===c||i!==c&&"ARShapesNode"!==i){if(i===y.prototype.sceneUINodeName&&w&t.SupportTypes.PREVIEW_ITEM)return t.SupportTypes.PREVIEW_ITEM;if(i===y.prototype.pickingAreaRootNodeName&&w&t.SupportTypes.PICKING_AREA)return t.SupportTypes.PICKING_AREA;if(i===u){if(o.externalPath[1].imageNormal&&w&t.SupportTypes.IMAGE_MAGNET)return t.SupportTypes.IMAGE_MAGNET;if(w&t.SupportTypes.IMAGE)return t.SupportTypes.IMAGE}else if(i===y.prototype.annotationGroupNodeName){if(w&t.SupportTypes.ANNOTATION)return t.SupportTypes.ANNOTATION}else if("planeChoiceNode"===i){if(o.externalPath[2].getType&&(e=o.externalPath[2].getType(),w&e))return e}else if(i===y.prototype.rootImageNodeName||i===y.prototype.rootTextNodeName){if(w&t.SupportTypes.IMAGE)return t.SupportTypes.IMAGE}else if("model3DNode"===i){if((e=o.externalPath[o.externalPath.length-1].getPrimitive().sgNode.getGroup().glType)>3&&w&t.SupportTypes.FACE)return t.SupportTypes.FACE;if(e>0&&w&t.SupportTypes.EDGE)return t.SupportTypes.EDGE;if(w&t.SupportTypes.VERTEX)return t.SupportTypes.VERTEX}}else if(e=o.externalPath[2].getType(),w&e)return e}return t.SupportTypes.NONE}}();return y}()}),define("DS/CAT3DWVisu/CAT3DWPickingControllerFactory",["UWA/Class","DS/CAT3DWVisu/CAT3DWPickingController"],function(e,t){"use strict";return e.singleton({init:function(){},createPickingController:function(e,i){this._pickingController&&(this._pickingController.clear(),this._pickingController=null),this._pickingController=new t(e,i)},clearPickingController:function(){this._pickingController&&(this._pickingController.clear(),this._pickingController=null)},getPickingController:function(){return this._pickingController},getMagnetsController:function(){var e=null;return this._pickingController&&(e=this._pickingController.getMagnetsController()),e},getAnnotationGroupNodeName:function(){return t.prototype.annotationGroupNodeName},getSceneUINodeName:function(){return t.prototype.sceneUINodeName},getRootImageNodeName:function(){return t.prototype.rootImageNodeName},getRootModelNodeName:function(){return t.prototype.rootModelNodeName},getRootTextNodeName:function(){return t.prototype.rootTextNodeName},getRootConnectionNodeName:function(){return t.prototype.rootConnectionNodeName}})});