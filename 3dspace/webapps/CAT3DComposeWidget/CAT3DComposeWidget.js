window.top.performance.mark("C3D_jsAppLoad"),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CAT3DComposeRobotSnapMove",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/CATW3DRobot/CATW3DRobot","DS/PADUtils/PADContext","DS/CATW3DRobot/CATC3DRobotSnapPanel"],function(e,t,n,i,o){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0});var a=i.get(),r=this;this.execute=function(){var e,i=n.getMove3DRobot({context:a}),s=t.get();1===s.length&&(s[0].event&&(e=t._items[0].pathElement.getBoundingSphere().center),i.modifyTargetAndPosition({pathElement:s[0].pathElement,robotPosition:e}),r._panel=new o({immersiveFrame:a.getFrameWindow().getImmersiveFrame(),controller:r,_robot:i,robotP:e}))}}})}),function(){"use strict";var e=[];e.giveNavigationObject=function(t){var n;return t&&t.context&&(n=null,e.some(function(e){return e.context===t.context&&(n=e,!0)})),n},e.getNavigationObject=function(t){var n=this.giveNavigationObject(t);return null===n&&(n={context:t.context,onStart:null,onExit:null,controller:null,activated:!1},e.push(n)),n},define("DS/CATC3DNavigation/CATD3CBoxNavigation",["UWA/Core","UWA/Class","DS/VisuEvents/EventsManager","DS/Visualization/PathElement","DS/CATW3DAnims/CATW3DAnimation3D","DS/PADUtils/PADWSAccess","DS/Visualization/ThreeJS_DS","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/WebappsUtils/WebappsUtils","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/SceneGraphNodes/FixedSizeNode3D","DS/CATC3DNavigation/CATBreadCrumbs","DS/ApplicationFrame/CommandsManager","DS/CATWebUXTooltipManager/CATWebUXTooltipManager","DS/CAT3DComposeUtils/CATC3DDropManager","DS/SceneGraphNodes/AxisSystemNode","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CAT3DComposeUI/CAT3DComposeWidgetOptions","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,n,i,o,a,r,s,l,c,u,d,m,p,g,h,v,f,C,E,S,A,D){function y(e){this.pts=[new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3],this.vecU=new r.Vector3,this.vecV=new r.Vector3,this.vecW=new r.Vector3,e&&(this.pts[0].set(e.min.x,e.min.y,e.min.z),this.pts[1].set(e.max.x,e.min.y,e.min.z),this.pts[2].set(e.min.x,e.max.y,e.min.z),this.pts[3].set(e.max.x,e.max.y,e.min.z),this.pts[4].set(e.min.x,e.min.y,e.max.z),this.pts[5].set(e.max.x,e.min.y,e.max.z),this.pts[6].set(e.min.x,e.max.y,e.max.z),this.pts[7].set(e.max.x,e.max.y,e.max.z),this.vecU.subVectors(this.pts[1],this.pts[0]),this.vecV.subVectors(this.pts[2],this.pts[0]),this.vecW.subVectors(this.pts[4],this.pts[0]))}function x(){var e,t,n,i,o,a;this.store=function(s,l){var c=l?(new r.Matrix4).getInverse(l):null,u=c?(new r.Matrix4).extractRotation(c):null;e=s.getEyePosition(),c&&e.applyMatrix4(c),t=s.getUpDirection(),u&&t.applyMatrix4(u),n=s.getSightDirection(),u&&n.applyMatrix4(u),i=s.getTargetDistance(),o=s.getProjectionType(),a=s.getAngle()},this.restore=function(s,l){if(e){var c=l?(new r.Matrix4).extractRotation(l):null;s.moveTo({eyePosition:l?e.applyMatrix4(l):e,upDirection:c?t.applyMatrix4(c):t,sightDirection:c?n.applyMatrix4(c):n,distanceToTarget:i}),s.setProjectionType(o),s.setAngle(a)}}}function T(e){var t,n,i,o,a=e&&e.externalPath.length>1;for(t=0,n=e.externalPath.length-1;a&&t<n;++t)i=e.externalPath[t],o=e.externalPath[t+1],i.children.indexOf(o)<0&&(a=!1);return a}function b(e){if(!e)return!1;if(D.isReference(e))return!0;var t=D.getNodeType(e);return"CATDrawing"===t||"Drawing"===t||"CATAnalysis"===t||"PPRContext"===t}function P(e){if(!e)return!1;if(D.isInstance(e))return!0;var t=D.getNodeType(e);return"CatDrawing"===t||"CatAnalysis"===t||"CatProcess"===t}function M(e){return!e||e.empty()||e.isNaN()||e.min.distanceTo(e.max)<=0}y.prototype={constructor:y,copy:function(e){for(var t=0;t<8;++t)this.pts[t].copy(e.pts[t]);return this.vecU.copy(e.vecU),this.vecV.copy(e.vecV),this.vecW.copy(e.vecW),this},clone:function(){return(new this.constructor).copy(this)},center:function(e){return(e||new r.Vector3).set(.5*(this.pts[0].x+this.pts[7].x),.5*(this.pts[0].y+this.pts[7].y),.5*(this.pts[0].z+this.pts[7].z))},applyMatrix4:function(e){for(var t=0;t<8;++t)this.pts[t].applyMatrix4(e);var n=(new r.Matrix4).extractRotation(e);return this.vecU.applyMatrix4(n),this.vecV.applyMatrix4(n),this.vecW.applyMatrix4(n),this},containsPoint:function(e){return!(e.x<this.pts[0].x||e.x>this.pts[7].x||e.y<this.pts[0].y||e.y>this.pts[7].y||e.z<this.pts[0].z||e.z>this.pts[7].z)},minX:function(){for(var e=this.pts[0].x,t=1;t<8;++t)e=Math.min(e,this.pts[t].x);return e},maxX:function(){for(var e=this.pts[0].x,t=1;t<8;++t)e=Math.max(e,this.pts[t].x);return e},minY:function(){for(var e=this.pts[0].y,t=1;t<8;++t)e=Math.min(e,this.pts[t].y);return e},maxY:function(){for(var e=this.pts[0].y,t=1;t<8;++t)e=Math.max(e,this.pts[t].y);return e},minZ:function(){for(var e=this.pts[0].z,t=1;t<8;++t)e=Math.min(e,this.pts[t].z);return e},maxZ:function(){for(var e=this.pts[0].z,t=1;t<8;++t)e=Math.max(e,this.pts[t].z);return e},min:function(){for(var e=(new r.Vector3).copy(this.pts[0]),t=1;t<8;++t)e.x=Math.min(e.x,this.pts[t].x),e.y=Math.min(e.y,this.pts[t].y),e.z=Math.min(e.z,this.pts[t].z);return e},max:function(){for(var e=(new r.Vector3).copy(this.pts[0]),t=1;t<8;++t)e.x=Math.max(e.x,this.pts[t].x),e.y=Math.max(e.y,this.pts[t].y),e.z=Math.max(e.z,this.pts[t].z);return e}},x.prototype={constructor:x},Object.freeze(x);var I,R,w=-1,N=144,L=108,_=1e-6,F=A.getOption("C3DSTR"),O=new r.Vector3(0,0,1),W=new r.Vector3(1,0,0),U=new r.Vector3(-1,0,0),V=Math.PI,k=.5*Math.PI,G=.25*Math.PI,B=.75*Math.PI,X=new r.Color("rgb(202,202,202)").getHex(),H=new r.Color("rgb(54,142,196)").getHex(),Y=0,j={},q=new r.MeshBasicMaterial({map:new r.ImageUtils.loadTexture(u.getWebappsAssetUrl("CATC3DNavigation","icons")+"/iconLargeDefault.png",void 0,null,null,!0),side:r.DoubleSide,force:!0,transparent:!0}),z=new r.MeshBasicMaterial({map:new r.ImageUtils.loadTexture(u.getWebappsAssetUrl("CATC3DNavigation","icons")+"/iconLargeDefault.png",void 0,null,null,!0),side:r.DoubleSide,force:!0,transparent:!0});function K(){I=new r.MeshBasicMaterial({color:X,opacity:.95}),R=new r.MeshBasicMaterial({color:H,opacity:.95}),I.line=R.line=new r.LineBasicMaterial({color:Y,opacity:.95}),I.force=R.force=!0}return K(),t.extend({init:function(t){var u,A,X,H,J,Z,Q,$,ee,te,ne,ie,oe,ae,re,se,le,ce,ue=t.context,de=ue.getController(),me=ue.getViewer(),pe=me.getSceneGraphOverrideSetManager(),ge=!1,he=[],ve=ue.getRootBagPath().getLastElement(!0),fe=o.getAnimation3DEngine({viewer:me}),Ce={},Ee=[],Se=[];function Ae(t,n,o){var a=t.pathElement.getLastElement(!0);if(a&&a.navigationAssociatedPath)t.pathElement=2===n?a.navigationAssociatedPath.clone():new i(t.pathElement.externalPath.slice(0,3));else if(t.pathElement.externalPath[0]===ve){if(1===n&&o){var r=Ce.levels[Ce.levels.length-1].node.getChildByName("EmptyNodes");r&&r.getChildren().some(function(n){if(n.children.length&&t.pathElement.isAParentOf(n.navigationAssociatedPath)){var o=e.extend({},t,!1);return o.pathElement=new i([Ce.levels[Ce.levels.length-1].node,r,n,n.children[0]]),l.isIn(o)||l.add(o),!0}return!1})}var s=H.clone(),c=H.getLastElement(!0);t.pathElement.externalPath.length>s.externalPath.length&&(s.addElement(t.pathElement.externalPath[s.externalPath.length]),c!==ve&&t.pathElement.externalPath.length>s.externalPath.length&&s.addElement(t.pathElement.externalPath[s.externalPath.length]),t.pathElement=s)}return t}function De(e,t,n){Array.isArray(e)?e.forEach(function(e){Ae(e,t,n)}):Ae(e,t,n)}function ye(e){De(e,0,!0)}function xe(e){De(e,1,!0)}function Te(e){De(e,2,!0)}function be(e){De(e,1,!1)}function Pe(e){return Ae({pathElement:e},2,!0).pathElement}function Me(t){if(t&&t.completed)if(t.arrayPath&&1===t.arrayPath.length&&t.token){var n=Pe(t.arrayPath[0]);if(n){var i,o=n.getLastElement(!0),a=o?D.getNodeID(o):void 0;if(a){n.externalPath.length>1&&D.isInstance(n.externalPath[n.externalPath.length-2])&&(i=D.getNodeID(n.externalPath[n.externalPath.length-2]));var r=[a];i&&r.push(i),ue.getController().getAttributes({ids:r,attributes:["ds6w:label","type_icon_url"],callbacks:{onComplete:function(n){var o,r=n[a]?n[a]["ds6w:label"]:"";if(i&&n[i]&&n[i]["ds6w:label"]&&(r+=" ("+n[i]["ds6w:label"]+")"),r&&"string"==typeof r&&0!==r.trim().length){(o=e.createElement("div")).setText(r);var s=n[a].type_icon_url;s&&"string"==typeof s&&s.length>0&&(o.setStyles({"background-image":"url("+s+")","background-repeat":"no-repeat","background-position-y":"center"}),o.setStyle("padding-left","21px"))}t.completed({token:t.token,div:o})},onFailure:function(){t.completed({token:t.token})}}})}else t.completed()}else t.completed()}else t.completed()}function Ie(){$?$.restore(ue.getFrameWindow().getViewpoint(),H.getWorldMatrix()):($=new x,ue.getFrameWindow().getViewpoint().reframe(null))}function Re(e,t){var n=u.createOverride({pathes:e});return t.push(n),n}function we(t){var n=t.getLastElement(!0),i=!0===pe.getCurrentVisibility(t)?0:!0===pe.getCurrentVisibilityFree(t)?-1:1;if(b(n)||D.is3DLeaf(n))return i;var o=n.getChildren();if(1!==o.length)return e.log("Instance or RepInstance with no or more than one Reference or RepReference"),i;var a=t.clone();return a.addElement(o[0]),!0===pe.getCurrentVisibility(a)?0:!0===pe.getCurrentVisibilityFree(a)?-1:1}function Ne(e,t){if(e){var n=null,i=e.angleTo(t);return i>_&&V-i>_&&(n=new r.Matrix4,i<=k||i-k<_?n.makeRotationAxis((new r.Vector3).crossVectors(e,t).normalize(),i):n.makeRotationAxis((new r.Vector3).crossVectors(e,t).normalize().negate(),V-i)),n}}function Le(e,t,n){if(F){var i,o,a,s,l=e.clone(),c=l.vecU.length(),u=l.vecV.length(),d=l.vecW.length(),m=l.vecU,p=l.vecV,g=l.vecW;return n?((s=g.angleTo(O))>_&&(i=(new r.Matrix4).makeRotationAxis((new r.Vector3).crossVectors(g,O).normalize(),s),l.applyMatrix4(i)),(s=m.angleTo(W))>_&&V-s>_&&Math.abs(s-k)>_&&(o=new r.Matrix4,s<=G?o.makeRotationAxis((new r.Vector3).crossVectors(m,W).normalize(),s):s>=B?o.makeRotationAxis((new r.Vector3).crossVectors(m,U).normalize(),V-s):(s=p.angleTo(W))<=G?o.makeRotationAxis((new r.Vector3).crossVectors(p,W).normalize(),s):o.makeRotationAxis((new r.Vector3).crossVectors(p,U).normalize(),V-s),i=i?o.multiply(i):o)):(d<=c&&d<=u?(m=l.vecU,p=l.vecV,a=l.vecW):c<=u&&c<d?(m=l.vecV,p=l.vecW,a=l.vecU):(m=l.vecW,p=l.vecU,a=l.vecV),(i=Ne(a,O))&&l.applyMatrix4(i),t&&(o=Ne(a=(c=m.length())===(u=p.length())?t.x?m:p:c>u?m:p,t))&&(i=i?o.multiply(i):o)),i}}function _e(e,t,n){var i=(new r.Matrix4).setPosition(e),o=(new r.Matrix4).copy(t).multiply((new r.Matrix4).getInverse(i).multiply(n));return i.multiply(o)}function Fe(e,t){var n=new r.Vector3(0,0,0);return n.applyMatrix4(t),e.containsPoint(n)||e.center(n),n}function Oe(e,t,n){return e.setSSAO(!1),e.setShadow(!1,!1),e.setRenderDepth(1),t||(e.excludeFromCSO(!0),e.excludeFromHighlight(!0,!0),e.exludeFromBounding(!0)),n&&(e.name=n),e}function We(e){if(e.box){var t=!1;if(1===e.node.children.length){var n=e.node.children[0];(D.is3DLeaf(n)||D.is3DLeaf(e.node)||P(e.node)&&!b(n)||b(e.node)&&!P(n))&&(t=!0)}var i=e.box,o=i.minX(),a=i.maxX(),s=i.minY(),l=i.maxY(),c=i.minZ();if(a-o>0&&l-s>0){var u=m.createRectangleNode({width:a-o,height:l-s,fill:!0,material:t?R:I});u.setMatrix((new r.Matrix4).setPosition(new r.Vector3(o,s,c))),Ce.levels[Ce.levels.length-1].node.addChild(Oe(u))}}}function Ue(t,n,i){if(t.length){var o=new g({name:"EmptyNodes",ratio:1});o.setMatrix((new r.Matrix4).setPosition(new r.Vector3(i.max.x,(n.minY()+n.maxY())/2,i.min.z))),Ce.levels[Ce.levels.length-1].node.addChild(o);for(var s,l={},c={},u=t.length>3?(T=t.length,P=Math.sqrt(T),M=Math.floor(P),P-M<.5?M:M+1):1,d=t.length>3?function(e){return Math.ceil(Math.sqrt(e))}(t.length):t.length,p=(.5*u-1)*(L+10),h=0,v=0;v<u;++v){for(var f=0,C=0;C<d;++C){var E=t[h].node,S=!1;0===E.children.length?b(E)||(e.log("Inst or RepInst with no Ref or RepRef"),S=!0):1===E.children.length||b(E)?D.isRepInstance(E)||D.is3DLeaf(E.children[0])?S=!0:D.is3DLeaf(E)&&(S=!0):(e.log("Inst or RepInst with more than one Ref or RepRef"),S=!1);var A=m.createRectangleNode({width:N+10,height:L+10,fill:!0,material:S?R:I});A.setMatrix((new r.Matrix4).setPosition(new r.Vector3(f,p,0))),o.addChild(Oe(A,!1,"Node_"+t[h].id)),A.navigationAssociatedPath=t[h].pathElement,(s=j[t[h].type])||(s=S?q:z,l[t[h].type]||(l[t[h].type]=t[h].id),c[t[h].id]=t[h].type);var y=m.createRectangleNode({width:N,height:L,fill:!0,noEdge:!0,material:s});if(y.setMatrix((new r.Matrix4).setPosition(new r.Vector3(5,5,5))),f+=N+10,A.addChild(Oe(y,!0,"Texture_"+t[h].id)),y.navigationAssociatedPath=t[h].pathElement,++h>=t.length)break}if(p-=L+10,h>t.length)break}var x=Object.keys(l).map(function(e){return l[e]});if(!x.length)return;a.fetch({enopad_webapis:require("DS/PADUtils/PADSettingsMgt").getSetting("enopad_webapis"),data:{intent:"explore_2D",select_file:["preview_url","thumbnail_2d"],select_predicate:["physicalid"]},pids:x,onComplete:function(e){var t=JSON.parse(e),n={};(t&&t.results||[]).forEach(function(e){if(e.attributes){for(var t,i,o=0,a=e.attributes.length;o<a&&(!t||!i);++o){var r=e.attributes[o];t||"ds6w:type"!==r.name?i||"preview_url"!==r.name&&"thumbnail_2d"!==r.name||(i=r.value):t=r.value}t&&i&&(n[t]=i)}}),o.getChildren().forEach(function(e){var t=e.getChildren();if(t&&t.length){var i,o,a=t[0].name.replace("Texture_","");c[a]&&(!(i=j[c[a]])&&n[c[a]]&&(o=new r.ImageUtils.loadTexture(n[c[a]],void 0,function(){j[c[a]]?i=j[c[a]]:j[c[a]]=i=new r.MeshBasicMaterial({map:o,side:r.DoubleSide,force:!0,transparent:!0}),t[0].setMaterial(i)},function(){},!0)),i&&t[0].setMaterial(i))}}),me.render()},onFailure:function(){}})}var T,P,M}function Ve(e,t){var n,i,o,a=null;return b(e)||D.is3DLeaf(e)?((a=t.clone()).addElement(e),i=D.getNodeID(e),o=D.getNodeType(e)):1===(n=e.getChildren()).length&&((a=t.clone()).addElement(e),a.addElement(n[0]),i=D.getNodeID(n[0]),o=D.getNodeType(n[0])),{id:i,node:e,pathElement:a,type:o}}function ke(e,t){return e.valueForSort<t.valueForSort?-1:e.valueForSort>t.valueForSort?1:0}function Ge(e,t){return e.valueForSort>t.valueForSort?-1:e.valueForSort<t.valueForSort?1:0}function Be(e,t){var n=new r.Box3;e.forEach(function(e){n.union(new r.Box3(e.box.min(),e.box.max()))}),e.delta=0,t.min.y>n.min.y&&(e.delta=t.min.y-n.min.y),t.max.y<n.max.y&&(e.delta=Math.min(e.delta,n.max.y-t.max.y))}function Xe(e,t){var n=new r.Box3;e.forEach(function(e){n.union(new r.Box3(e.box.min(),e.box.max()))}),e.delta=0,t.min.x>n.min.x&&(e.delta=t.min.x-n.min.x),t.max.x<n.max.x&&(e.delta=Math.min(e.delta,n.max.x-t.max.x))}function He(e,t,n,i,o){var a=(new r.Matrix4).setPosition((new r.Vector3).copy(i.dir).multiplyScalar(o));return n.box.applyMatrix4(a),n.worldMatrixTarget=n.worldMatrixSource.multiplyMatrices(a,n.worldMatrixSource),n.matrixTarget=(new r.Matrix4).multiplyMatrices(e,n.worldMatrixTarget),delete n.worldMatrixSource,n.centerRotation&&n.centerRotation.applyMatrix4(a),t.union(new r.Box3(n.box.min(),n.box.max())),t}function Ye(){var e=ue.getFrameWindow();e&&e.removeReviewModel&&e.removeReviewModel()}function je(t){if(fe.forward(),ue.getFrameWindow().getContextualUIManager().hideContextualMenus(),t.div!==Ce.levels[Ce.levels.length-1].button){for(var n,i,o,a,r=[],s=[],l=[],c=[];Ce.levels.length;){var d,m=Ce.levels.pop();if(m.button===t.div){Ce.levels.push(m),H=m.path,ee&&ee.setCurrentPath(H);break}if(1===Ce.levels.length)for(n=Ce.levels[0].overridesMove.length-1;n>=0;--n)if(1!==(a=(o=Ce.levels[0].overridesMove[n]).getPathes()).length&&e.log("More than one path in override, not expected"),a[0].isEqual(m.path)){d=o.getPosition();break}for(n=0,i=m.overridesMove?m.overridesMove.length:0;n<i;++n){o=m.overridesMove[n],r.push(o),1!==(a=o.getPathes()).length&&e.log("More than one path in override, not expected");var p=a[0].getLastElement(!0).getMatrix();d&&a[0].isEqual(m.path)&&(p=d,d=null),c.push({override:o,matrixSource:o.getPosition(),matrixTarget:p})}for(n=0;n<(m.overridesHide?m.overridesHide.length:0);++n)r.push(m.overridesHide[n]),s.push({override:m.overridesHide[n]});Ce.mainDiv.removeBreadCrumb(m.button.idthumb),me.removeNode(m.node),Ee.push({path:m.path,pathReference:m.pathReference})}Ye(),fe.addAnimation({animationType:"unmask",objectListToAnimate:s,duration:1e3}),fe.addAnimation({animationType:"move",objectListToAnimate:c,duration:1e3,callBackFct:function(){u.deleteOverrides(r),u.deleteOverrides(l),me.addNode(Ce.levels[Ce.levels.length-1].node),me.render({updateInfinitePlane:!0})}}),fe.startAnimation(),me.render({updateInfinitePlane:!0})}}function qe(e,t){H=e,ee&&ee.setCurrentPath(H);var n=me.getVisibleSpace(),i={button:Ce.mainDiv.addHomeBreadCrumb({cb:je}),path:e};i.node=new d("Navigation_"+Ce.levels.length),i.node.setVisibility(1===me.getVisibleSpace()),i.node.setVisibilityFree(!1),i.node.setVisibilityInTree(!1),me.addNode(i.node),Ce.levels.push(i);var o,a,s,l,c,u=[],m=[],p=[],g=e.getLastElement(!0);Ce.levels[Ce.levels.length-1].overridesMove=u,g.getChildren().forEach(function(t){var i=e.clone();i.addElement(t);var d=we(i);if(-1!==d)if(a=i.getBoundingBox(null,me,"visibleSpace"),s=i.getBoundingBox(null,me,"invisibleSpace"),M(a)&&M(s))(0===d&&n||1===d&&!n)&&p.push(Ve(t,e));else if(!M(o=n?a:s)){o=new y(o);var g=e.clone();g.addElement(t);var h=g.getMatrix(),v=(new r.Matrix4).copy(h),f=g.getWorldMatrix();o.applyMatrix4(f);var C=o.center(),E=Le(o,null,!0);if(E&&(f=v=_e(C,E,f),(o=new y(i.getBoundingBox(null,me,n?"visibleSpace":"invisibleSpace"))).applyMatrix4(v),C=o.center()),l){var S=o.min(),A=new r.Vector3;A.x=C.x<c.x?l.min.x-Math.abs(C.x-S.x):l.max.x+Math.abs(C.x-S.x),A.y=c.y,A.z=l.min.z+(C.z-S.z);var D=(new r.Matrix4).setPosition(A.sub(C));o.applyMatrix4(D),v=(new r.Matrix4).copy(D).multiply(v),m.push({override:Re(g,u),matrixSource:h,matrixTarget:v,box:o,node:t}),l.union(new r.Box3(o.min(),o.max()))}else c=(new r.Vector3).copy(C),l=new r.Box3(o.min(),o.max()),m.push({override:Re(g,u),matrixSource:h,matrixTarget:v,box:o,node:t})}}),l||(l=new r.Box3(new r.Vector3,new r.Vector3)),!$&&t&&ue.getFrameWindow().getViewpoint().reframe("iso",0),fe.addAnimation({animationType:"move",objectListToAnimate:m,duration:t?1e3:0,callBackFct:function(){t&&(me.render({updateInfinitePlane:!0}),$||Ie())}}),fe.startAnimation(),Ue(p,new y(l),l),m.forEach(We)}function ze(t,n,i,o){fe.forward();var a=[],s=[],l=t.getLastElement(!0),c=!1;if(b(l)&&!D.is3DLeaf(l)){c=!0;var u=de.createReferenceIterator(D.getNodeID(l)),m=l.getChildren().map(D.getNodeID,D),g=u.getChildren().map(function(e){return-1===m.indexOf(e.getInstanceId())?e.getReferenceIterator().getReferenceId():null}).filter(function(e){return e&&-1===he.indexOf(e.refID)});g.length&&(he=he.concat(g),de.lockNodes({ids:g})),l.children.forEach(function(e){var n=t.clone();n.addElement(e),-1!==we(n)&&a.push(n)})}else if(P(l)){var h=t.clone();h.addElement(l.children[0]),ze(h,n,i,o)}if(a.length||c){H=t,Ye(),ee&&ee.setCurrentPath(H),Ce.levels&&Ce.levels.length&&Ce.levels[Ce.levels.length-1].node&&me.removeNode(Ce.levels[Ce.levels.length-1].node);var v=[],f=H.externalPath.length>1?H.externalPath[H.externalPath.length-2]:null;P(f)&&1===f.parents.length?s=s.concat(H.getParentPath().getSiblingsPathes()):f&&f===ve&&(s=s.concat(H.getSiblingsPathes())),s.length&&fe.addAnimation({animationType:"mask",objectListToAnimate:[{override:Re(s,v),duration:i?1e3:0}]});var C={path:H,node:new d("Navigation_"+Ce.levels.length),overridesHide:v,pathReference:n};C.node.setVisibility(1===me.getVisibleSpace()),C.node.setVisibilityFree(!1),C.node.setVisibilityInTree(!1),Ce.levels.push(C);var S=l.getChildren().every(function(t){var n=t.getChildren();return 0===n.length||(1!==n.length?(e.log("Instance or RepInstance with no or more than one Reference or RepReference"),!1):D.isPLMNode(n[0])?!!D.is3DLeaf(n[0]):(e.log("Navigation to a non PAD3DViewer node should not be possible"),!0))}),A=D.getNodeID(l),x=[A],T=D.getNodeID(H.externalPath[H.externalPath.length-2]);T&&x.push(T),C.button||(C.button=Ce.mainDiv.addBreadCrumb({cb:je,lastBreadCrumb:S})),ue.getController().getAttributes({ids:x,attributes:["ds6w:label"],callbacks:{onComplete:function(e){var t=e[A]?e[A]["ds6w:label"]:"";T&&e[T]&&e[T]["ds6w:label"]&&(t+=" ("+e[T]["ds6w:label"]+")"),Ce.mainDiv&&Ce.mainDiv.setLabel(C.button.idthumb,t)},onFailure:function(){}}}),a.length?function(t){var n,i,o=t.path.getWorldMatrix(),a=(new r.Matrix4).getInverse(o),s=me.getVisibleSpace(),l=t.pathReference?t.pathReference.getLastElement(!0):null,c=[];if(!l){var u=0;t.pathsToExplode.forEach(function(e){var n,i=e.getBoundingBox(null,me,"visibleSpace"),a=e.getBoundingBox(null,me,"invisibleSpace");M(i)&&M(a)||(M(i)?n=0:((i=new y(i)).applyMatrix4(o),n=(i.maxX()-i.minX())*(i.maxY()-i.minY())),n>u&&(u=n,t.pathReference=e,l=e.getLastElement(!0)))})}if(!$&&t.applyViewpoint&&ue.getFrameWindow().getViewpoint().reframe("iso",0),!t.pathReference){var d=Ce.levels[Ce.levels.length-2].node.getChildByName("EmptyNodes");t.pathsToExplode.forEach(function(e){c.push(Ve(e.getLastElement(!0),t.path))});var m=(new r.Vector3).getPositionFromMatrix(d?d.getMatrix():o);return n=new y(i=new r.Box3(new r.Vector3(m.x-N,m.y-L/2,m.z),new r.Vector3(m.x,m.y+L/2,m.z))),fe.startAnimation(),Ue(c,n,i),t.startAnimation&&(me.addNode(Ce.levels[Ce.levels.length-1].node),me.render({updateInfinitePlane:!0})),void(t.applyViewpoint&&Ie())}var p=[];Ce.levels[Ce.levels.length-1].overridesMove=p;var g=t.pathReference.getMatrix(),h=(new r.Matrix4).multiplyMatrices(o,g);M(n=t.pathReference.getBoundingBox(null,me,s?"visibleSpace":"invisibleSpace"))&&(n=new r.Box3(new r.Vector3,new r.Vector3)),(n=new y(n)).applyMatrix4(h);var v=Fe(n,h),f=Le(n,null,!1);if(f){var C={override:Re(t.path,p),matrixSource:o,matrixRotation:f,centerRotation:v,matrixParentInv:(new r.Matrix4).getInverse(t.path.getParentPath().getWorldMatrix())};fe.addAnimation({animationType:"rotate",objectListToAnimate:[C],duration:t.startAnimation?500:0,callBackFct:function(){t.startAnimation&&me.render({updateInfinitePlane:!0})}}),o=_e(v,f,o),a=(new r.Matrix4).getInverse(o),h=(new r.Matrix4).multiplyMatrices(o,g),(n=new y(t.pathReference.getBoundingBox(null,me,s?"visibleSpace":"invisibleSpace"))).applyMatrix4(h),v=Fe(n,h)}var E=n.minZ();if(!F){var S=t.path.getBoundingBox(null,me,s?"visibleSpace":"invisibleSpace");S&&(S.applyMatrix4(o),E=S.min.z)}var A={path:t.pathReference,override:Re(t.pathReference,p),node:l,matrixSource:g,matrixTarget:g,worldMatrixTarget:h,box:n};A.vectorZMatrix=(new r.Matrix4).setPosition(new r.Vector3(0,0,E-n.minZ())),n.applyMatrix4(A.vectorZMatrix);var D=[A],x={min:[],max:[]},T={min:[],max:[]};x.min.dir=new r.Vector3(-1,0,0),x.max.dir=new r.Vector3(1,0,0),T.min.dir=new r.Vector3(0,-1,0),T.max.dir=new r.Vector3(0,1,0),t.pathsToExplode.forEach(function(e){if(!e.isEqual(t.pathReference)){var n=e.getBoundingBox(null,me,"visibleSpace"),i=e.getBoundingBox(null,me,"invisibleSpace");if(M(n)&&M(i))c.push(Ve(e.getLastElement(!0),t.path));else{var l=s?n:i;if(!M(l)){l=new y(l);var u={path:e,node:e.getLastElement(!0)};D.push(u),u.override=Re(u.path,p),u.matrixSource=u.path.getMatrix();var d,m=(new r.Matrix4).multiplyMatrices(o,u.matrixSource),g=(new r.Matrix4).getInverse(m);l.applyMatrix4(m),u.worldMatrixSource=m.clone();var h=new r.Vector3;l.center(h),Math.abs(l.maxX()-l.minX())>Math.abs(l.maxY()-l.minY())?(u.valueForSort=h.y,h.y<v.y?T.min.push(u):T.max.push(u),d=(new r.Vector3).copy(x.max.dir)):(u.valueForSort=h.x,h.x<v.x?x.min.push(u):x.max.push(u),d=(new r.Vector3).copy(T.max.dir));var f=Le(l,d,!1);f&&(u.matrixRotation=f,u.centerRotation=h,u.matrixParent=o,u.matrixParentInv=a,m=_e(h,f,m),l.applyMatrix4(g),l.applyMatrix4(m),g.getInverse(m)),u.vectorZMatrix=(new r.Matrix4).setPosition(new r.Vector3(0,0,E-l.minZ())),l.applyMatrix4(u.vectorZMatrix),u.box=l}}}}),x.min.sort(Ge),x.max.sort(ke),T.min.sort(Ge),T.max.sort(ke);var b=0;b+=x.min.length?0:1,b+=x.max.length?0:1,b+=T.min.length?0:1,3===(b+=T.max.length?0:1)&&(x.min.length||x.max.length?v.x=x.min.length?x.min[0].box.maxX():x.max[0].box.minX():v.y=T.min.length?T.min[0].box.maxY():T.max[0].box.minY()),i=new r.Box3(new r.Vector3(n.minX(),n.minY(),n.minZ()),new r.Vector3(n.maxX(),n.maxY(),n.maxZ())),Be(x.min,i),Be(x.max,i),Xe(T.min,i),Xe(T.max,i);var P=[x.min,x.max,T.min,T.max];P.sort(function(e,t){return e.delta-t.delta}),P.forEach(function(e){e===x.min?x.min.forEach(function(e,t,n){i=He(a,i,e,n,-1*((i?i.min.x:v.x)-e.box.maxX()))}):e===x.max?x.max.forEach(function(e,t,n){i=He(a,i,e,n,(i?i.max.x:v.x)-e.box.minX())}):e===T.min?T.min.forEach(function(e,t,n){i=He(a,i,e,n,-1*((i?i.min.y:v.y)-e.box.maxY()))}):e===T.max&&T.max.forEach(function(e,t,n){i=He(a,i,e,n,(i?i.max.y:v.y)-e.box.minY())})});var I,R=[],w=[];D.forEach(function(t){t.matrixRotation&&(I=e.extend({},t),w.push(I),I.matrixSource=t.matrixTarget,I.worldMatrixTarget=_e(t.centerRotation,t.matrixRotation,t.worldMatrixTarget),t.centerRotation.applyMatrix4(a),I.matrixTarget=(new r.Matrix4).multiplyMatrices(a,I.worldMatrixTarget),t=I),I=e.extend({},t),R.push(I),I.matrixSource=t.matrixTarget,I.worldMatrixTarget.multiplyMatrices(t.vectorZMatrix,t.worldMatrixTarget),I.matrixTarget=(new r.Matrix4).multiplyMatrices(a,I.worldMatrixTarget)}),fe.addAnimation({animationType:"move",objectListToAnimate:D,duration:t.startAnimation?300:0,offsetTime:f?500:0}),fe.addAnimation({animationType:"rotate",objectListToAnimate:w,duration:t.startAnimation?400:0,offsetTime:f?800:300}),fe.addAnimation({animationType:"move",objectListToAnimate:R,duration:t.startAnimation?300:0,offsetTime:f?w.length?1200:800:w.length?700:300,callBackFct:function(){t.startAnimation&&(me.addNode(Ce.levels[Ce.levels.length-1].node),me.render({updateInfinitePlane:!0})),t.applyViewpoint&&Ie()}}),fe.startAnimation(),me.render({updateInfinitePlane:!0}),Ue(c,n,i),D.forEach(We)}({path:C.path,pathsToExplode:a,pathReference:C.pathReference,startAnimation:i,applyViewpoint:o}):function(e,t,n){!$&&n&&ue.getFrameWindow().getViewpoint().reframe("iso",0);var i=new E({headLength:10,arrowLength:50,arrowWidth:2,head:E.types.ARROW});i.exludeFromBounding(!0),i.setVisibilityInTree(!1),i.setPickable(p.PICKTHROUGH);var o=Ce.levels[Ce.levels.length-2].node.getChildByName("EmptyNodes");o&&i.setMatrix(o.getMatrix()),Ce.levels[Ce.levels.length-1].node.addChild(i),fe.axisSystemVisibility({objectListToAnimate:[i],visibility:!0,pickability:!1,callBackFct:function(){me.addNode(Ce.levels[Ce.levels.length-1].node),$||Ie()}}),fe.startAnimation()}()}}function Ke(e){var t=e.gesture?e.gesture.getEvents()[0]:e.from[0],n=me.pick(me.getMousePosition(t.getCurrentPosition(me.canvas)),"mesh",!1);if(n.path&&n.path.length&&H){var i=n.path[0].getLastElement(!0);i.navigationAssociatedPath&&(n.path[0]=i.navigationAssociatedPath);var o=H.clone();if(n.path[0].externalPath.length>o.externalPath.length){o.addElement(n.path[0].externalPath[o.externalPath.length]);var a,r=P(o.externalPath[o.externalPath.length-1])?[0,1]:[0];n.path[0].externalPath.length>=o.externalPath.length+r.length&&(a=o.clone(),r.forEach(function(e){a.addElement(n.path[0].externalPath[o.externalPath.length+e])})),l.empty(),c.empty(),Ee=[],ze(o,a,!0,!1)}}}function Je(e){if("ArrowLeft"===e.key||37===e.keyCode||"ArrowUp"===e.key||38===e.keyCode)Ce.levels.length>1&&(document.removeEventListener("keydown",Je),Ce.mainDiv.activate(Ce.levels[Ce.levels.length-2].button.idthumb),document.addEventListener("keydown",Je));else if(("ArrowRight"===e.key||39===e.keyCode||"ArrowDown"===e.key||40===e.keyCode)&&Ee.length>0){var t=Ee.pop();document.removeEventListener("keydown",Je),ze(t.path,t.pathReference,!0,!1),document.addEventListener("keydown",Je)}}function Ze(){!te&&(te=D.getRoots(ue).map(D.getNodeID,D).some(de.isLargeDataStructure,de))&&(ue.freezeProgressiveLoading?ue.freezeProgressiveLoading():de.pauseProgressiveLoading())}function Qe(){te&&(ue.unfreezeProgressiveLoading?ue.unfreezeProgressiveLoading():de.resumeProgressiveLoading()),te=!1}var $e,et=function(e,t){var n,i,o,a,r,s;if(t===Se[0]?Ze():t===Se[1]&&(Qe(),Ze()),t===Se[2]){for($e=!0,Ce.levels.forEach(function(e){me.removeNode(e.node),e.node=null}),i=Ce.levels.length-1;i>0;--i)Ce.mainDiv.removeBreadCrumb(i-1);return he.length&&de.unlockNodes({ids:he}),void(he=[])}if($e&&t===Se[3]){$e=!1;var l=ue.getController();Ce.levels.forEach(function(e,t,i){if(0!==t){var s=e.path,c=i[t-1].path.clone();for(o=c.externalPath.length,a=s.externalPath.length;o<a&&(n=D.getNodeID(s.externalPath[o]),r=l.getNode({id:n}));++o)c.addElement(r);var u=e.pathReference,d=u?c.clone():void 0;if(d)for(o=d.externalPath.length,a=u.externalPath.length;o<a&&(n=D.getNodeID(u.externalPath[o]),r=l.getNode({id:n}));++o)d.addElement(r);e.path=c,e.pathReference=d}})}if(!$e){fe.forward(),pe.removeSceneGraphOverrideSet(u),u=null,Ce.mainDiv.destroy(),J=[],Ce.levels.forEach(function(e){me.removeNode(e.node),e.node=null,J.push({path:e.path,pathReference:e.pathReference})}),Ce.mainDiv=new h({parentFrame:ue.getFrameWindow().getUIFrame()}),Ce.levels=[],u=new S(ue.getRootBagPath().externalPath[0]),pe.pushSceneGraphOverrideSet(u);var c,d=J;for(t===Se[0]&&(c=D.getRoots(ue))&&1===c.length&&!D.is3DLeaf(c[0])&&(1===d.length||d.length>1&&!T(d[1].path))?((s=d[0].path.clone()).addElement(c[0]),d.length=1,d.push({path:s})):t===Se[1]&&d.length>1&&!T(d[1].path)&&(c=D.getRoots(ue))&&1===c.length&&!D.is3DLeaf(c[0])&&((s=d[0].path.clone()).addElement(c[0]),d.length=1,d.push({path:s})),ee&&ee.setCurrentPath(H=null),i=0;i<d.length;++i)if(0===i)qe(d[i].path,d.length-1===i);else{if(!T(s=d[i].path)||-1===we(s)){fe.startAnimation(),me.addNode(Ce.levels[Ce.levels.length-1].node),me.render({updateInfinitePlane:!0});break}ze(s,d[i].pathReference,d.length-1===i,!1)}fe.forward()}};function tt(){ue.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(e,t){var n=c.get();if(0!==n.length){var i=D.getRoots(ue),o=[],a=!1,s=n.some(function(e){var t=e.pathElement.getLastElement(!0);return i.some(function(n){var i=n!==t,o=e.pathElement.externalPath.some(function(e){return n===e});return!a&&o&&(a=!0),i&&o})});if(a&&t&&t.withContextMenu&&"number"==typeof t.XmousePosition&&"number"==typeof t.YmousePosition)0===me.pick(me.getMousePosition(new r.Vector2(t.XmousePosition,t.YmousePosition)),"mesh",!1).path.length&&(s=a=!1);return s&&v.getCommand("CAT3DComposeExamineSelectionHdr",ue.getCommandContext?ue.getCommandContext():null).canBeEnabled(n)&&o.push({name:"CATC3DNavigationExamineSelectionStr",line:1,hdr_list:["CAT3DComposeExamineSelectionHdr"]}),F||!a||1!==n.length||D.is3DLeaf(n[0].pathElement.getLastElement(!0))||o.push({name:"CATC3DNavigationOnChildStr",line:1,hdr_list:["CATC3DNavigationOnChildHdr"]}),o.length?{cmdList:o}:void 0}},context:ue.getCommandContext?ue.getCommandContext():null,workbenchName:"CATC3DNavigation",module:"CATC3DNavigation",cmdPrefix:"",merge:!0,subscriberId:"CATC3DNavigation_"+ ++w})}this.start=function(){ge=!0,Ze(),(Q=new x).store(ue.getFrameWindow().getViewpoint()),Y=me.backgroundColor,K(),ne=ue.isRobotVisible(),ue.setRobotVisibility(!1),ue.setDefaultContextualBarVisibility(!1),X=me.picking.primitive,A=me.pPicking.primitive,me.setPrePicking({primitive:0}),me.setPicking({primitive:0}),ie=s.onPreAdd(ye),oe=l.onPreAdd(xe),ae=l.onRemove(be),re=c.onPreAdd(Te),Z=f.getTooltipManager({context:ue}),se=Z.register({onTooltipReady:Me,filterPath:Pe}),Se.push(ue.subscribe({event:"onLoadingComplete"},et)),Se.push(ue.subscribe({event:"onEndRootRemoved"},et)),Se.push(ue.subscribe({event:"onRefreshBegin"},et)),Se.push(ue.subscribe({event:"onEndProgressiveLoad"},et)),Se.push(ue.subscribe({event:"onRootDetached"},et)),Se.push(ue.subscribe({event:"onRootAttached"},et)),Se.push(ue.subscribe({event:"onAuthoringTransactionEnd"},et)),Se.push(ue.subscribe({event:"onShow"},et)),Se.push(ue.subscribe({event:"onHide"},et)),Se.push(ue.subscribe({event:"onEndDelete"},et)),Se.push(ue.subscribe({event:"onEndMatriceUpdate"},et)),ce=me.onSwapVisibleSpace?me.onSwapVisibleSpace(et):null,(ee=C.getDropManager({context:ue})).connect(),le=ee.subscribe({event:"onEndInsertDrop3D"},et),u=new S(ue.getRootBagPath().externalPath[0]),pe.pushSceneGraphOverrideSet(u),n.addEvent(me.canvas,"onLeftDoubleClick",Ke),n.addEvent(me.canvas,"onDoubleTap",Ke),Ce.mainDiv=new h({parentFrame:ue.getFrameWindow().getUIFrame()}),Ce.levels=[];var e,t=[];if(H&&T(H)&&J&&0!==J.length)t=J;else{t.push({path:ue.getRootBagPath()});var i=D.getRoots(ue);1!==i.length||D.is3DLeaf(i[0])||((e=t[0].path.clone()).addElement(i[0]),t.push({path:e})),$=null}H=null,ee&&ee.setCurrentPath(H);for(var o=0;o<t.length;++o)if(0===o)qe(t[o].path,t.length-1===o);else{if(!T(e=t[o].path)||-1===we(e)){fe.startAnimation(),me.addNode(Ce.levels[Ce.levels.length-1].node),me.render({updateInfinitePlane:!0}),Ie();break}ze(e,t[o].pathReference,t.length-1===o,t.length-1===o)}document.addEventListener("keydown",Je),tt()},this.end=function(){ge=!1,fe.stop(),ue.getFrameWindow().getContextualUIManager().unregister("CATC3DNavigation_"+w),document.removeEventListener("keydown",Je),Ye(),ue.setRobotVisibility(ne),ue.setDefaultContextualBarVisibility(!1),me.setPicking({primitive:X}),me.setPrePicking({primitive:A}),ee.disconnect(),ee.unsubscribe(le),s.unsubscribe(ie),l.unsubscribe(oe),c.unsubscribe(re),l.unsubscribe(ae),Z.unregister(se),f.unreferenceTooltipManager({context:ue}),ie=oe=re=ae=se=ee=le=null;for(var e=l.get(),t=e.length-1;t>=0;--t){var i=e[t];i&&i.pathElement.externalPath[0]!==ve&&i.pathElement.getLastElement(!0).navigationAssociatedPath&&(l.remove(i),i.pathElement=i.pathElement.getLastElement(!0).navigationAssociatedPath.clone(),l.isIn(i)||l.add(i))}he.length&&de.unlockNodes({ids:he}),he=[],Se.forEach(function(e){ue.unsubscribe(e)}),Se=[],me.unsubscribe(ce),ce=null;var o=ue.getFrameWindow().getViewpoint();$&&$.store(o,T(H)?H.getWorldMatrix():null),Q.restore(o),pe.removeSceneGraphOverrideSet(u),u=null,n.removeEvent(me.canvas,"onLeftDoubleClick",Ke),n.removeEvent(me.canvas,"onDoubleTap",Ke),Ce.mainDiv.destroy(),J=[],Ce.levels.forEach(function(e){me.removeNode(e.node),J.push({path:e.path,pathReference:e.pathReference})}),Ce={},Ee=[],Qe(),me.render({updateInfinitePlane:!0})},this.pause=function(){ie&&ge&&(document.removeEventListener("keydown",Je),me.setPicking({primitive:X}),me.setPrePicking({primitive:A}),s.unsubscribe(ie),ie=void 0,l.unsubscribe(oe),oe=void 0,l.unsubscribe(ae),ae=void 0,c.unsubscribe(re),re=void 0,Z.unregister(se),se=void 0,n.removeEvent(me.canvas,"onLeftDoubleClick",Ke),n.removeEvent(me.canvas,"onDoubleTap",Ke),ue.getFrameWindow().getContextualUIManager().unregister("CATC3DNavigation_"+w),Ce.mainDiv.hide(),Ce.levels[Ce.levels.length-1].node&&me.removeNode(Ce.levels[Ce.levels.length-1].node))},this.resume=function(){!ie&&ge&&(X=me.picking.primitive,A=me.pPicking.primitive,me.setPrePicking({primitive:0}),me.setPicking({primitive:0}),ie=s.onPreAdd(ye),oe=l.onPreAdd(xe),ae=l.onRemove(be),re=c.onPreAdd(Te),se=Z.register({onTooltipReady:Me,filterPath:Pe}),n.addEvent(me.canvas,"onLeftDoubleClick",Ke),n.addEvent(me.canvas,"onDoubleTap",Ke),document.addEventListener("keydown",Je),tt(),Ce.mainDiv.show(),Ce.levels[Ce.levels.length-1].node&&me.addNode(Ce.levels[Ce.levels.length-1].node))},this.navigateOnChild=function(e){var t=e&&e.pathToExplode?e.pathToExplode:null;[1,2].some(function(){return(t=t?t.getParentPath():null)?t.isEqual(H):null})&&(l.empty(),c.empty(),Ee=[],ze(e.pathToExplode,null,!0,!1))}}})}),define("DS/CATC3DNavigation/CATC3DNavigationStartCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/ApplicationFrame/CommandsManager","DS/CATC3DNavigation/CATD3CBoxNavigation","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(t,n,i,o,a){return t.extend({init:function(t){var r=this;this._parent(t,{mode:"exclusive",isAsynchronous:!1}),this.setRepeatMode(!1),this.execute=function(){var t=e.getNavigationObject({context:n.get()}),a=this._ctx;t.onExit&&t.onExit.actionBar&&t.onExit.actionBar.length&&t.onStart&&t.onStart.onStart&&(t.done=function(){delete t.done;var e=t.context.subscribe({event:"onActionBarReady"},function(){t.context.unsubscribe(e),i.setDefaultCommand({ID:"CATD3CNavigationDefaultHdr",className:"DS/CATC3DNavigation/CATC3DNavigationDefaultCmd",context:a}),t.activated=!0,t.controller||(t.controller=new o({context:t.context})),t.controller.start()});t.context.loadActionBar({merge:!1,file:"CATC3DNavigation.xml",module:"CATC3DNavigation"})},t.onStart.onStart(t)),require(["DS/CAT3DComposeUtils/CATC3DUtils"],function(e){e._sendUsageProbe("command","StructureMode")})},this.onNavigationStart=function(t){var i=e.getNavigationObject({context:n.get()});i.activated||(i.onStart=t)},this.onNavigationExit=function(t){var i=e.getNavigationObject({context:n.get()});i.activated||(i.onExit=t)};var s=n.get(),l=s.subscribe({event:"onRootAdded"},function(){1===a.getRoots(s).length&&r.enable()}),c=s.subscribe({event:"onEndRootRemoved"},function(){0===a.getRoots(s).length&&r.disable()});0===a.getRoots(s).length&&this.disable(),this._destroy=function(){s.unsubscribe(l),l=null,s.unsubscribe(c),c=null,Object.getPrototypeOf(this)._destroy.apply(this,arguments),r=null}}})});var t=function(e,t,n){["_commands","_cmdCheckHeader"].forEach(function(i){var o=n?e[i][n]:e[i];o[t]&&(o[t]._destroy&&o[t]._destroy(),delete o[t])})};define("DS/CATC3DNavigation/CATC3DNavigationEndCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/ApplicationFrame/CommandsManager"],function(n,i,o){var a,r="CATC3DNavigation";return r+=require("DS/CAT3DComposeUI/CAT3DComposeWidgetOptions").getOption("authoring3d")?"Next":"",require(["text!DS/CATC3DNavigation/assets/afr/"+r+".xml"],function(e){a=e}),n.extend({init:function(n){this._parent(n,{mode:"exclusive",isAsynchronous:!1}),this.setRepeatMode(!1),this.execute=function(){var n=e.getNavigationObject({context:i.get()});n.activated=!1,n.controller&&n.controller.end();var r={lastCommand:[],currentCommand:null,defaultCommand:null};this._ctx?o._commandsState[this._ctx]=r:o._commandsState=r,o.resetDefaultCommand(this._ctx),t(o,"CATD3CNavigationDefaultHdr",this._ctx);for(var s=(new DOMParser).parseFromString(a,"text/xml").getElementsByTagName("CATCommandHeader"),l=s.length-1;l>=0;--l){var c=s[l].attributes.getNamedItem("ClassName").value;if(!c.startsWith("DS/ViewerCommands")&&!c.startsWith("DS/ENOPAD3DViewer")&&!c.startsWith("DS/PADUtils")){var u=s[l].attributes.getNamedItem("ID").value;"CAT3DComposeExamineSelectionHdr"!==u&&t(o,u,this._ctx)}}var d=0,m=n.context.subscribe({event:"onActionBarReady"},function(){n.onExit.actionBar[d-1].onActionBarReady&&n.onExit.actionBar[d-1].onActionBarReady(),d<n.onExit.actionBar.length?(n.context.loadActionBar({merge:!0,file:n.onExit.actionBar[d].file,module:n.onExit.actionBar[d].module}),d++):n.context.unsubscribe(m)});n.context.loadActionBar({merge:!1,file:n.onExit.actionBar[0].file,module:n.onExit.actionBar[0].module}),d++}}})}),define("DS/CATC3DNavigation/CATC3DNavigationOnChildCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/Selection/CSOManager"],function(t,n,i){return t.extend({init:function(t){this._parent(t,{mode:"exclusive",isAsynchronous:!1}),this.setRepeatMode(!1),this.execute=function(){var t=n.get(),o=i.get(),a=1===o.length?o[0].pathElement:null,r=a?e.giveNavigationObject({context:t}):null;t.getFrameWindow().getContextualUIManager().hideContextualMenus(),r&&setTimeout(function(){r.controller.navigateOnChild({pathToExplode:a})},0)}}})}),define("DS/CATC3DNavigation/CATC3DNavigationContoller",["UWA/Class"],function(t){return t.singleton({init:function(){},getNavigationContoller:function(t){return e.getNavigationObject({context:t.context}).controller},isNavigationActivated:function(t){var n=e.giveNavigationObject({context:t.context});return!!n&&n.activated}})})}(),define("DS/CAT3DComposeCommands/CATC3DPasteAtLocalCoordinatesCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/ApplicationFrame/CommandsManager","DS/CATW3DMoveManager/CATW3DMoveManager"],function(e,t,n,i,o,a){"use strict";var r=new i.Matrix4;return e.extend({init:function(e){this._parent(e);var i=this,s=a.giveMoveManager({context:n.get()});this.onStateChange(function(){if(i.getState()){var e=[];t.get().forEach(function(t){e.push({path:t.pathElement})}),e.length&&(s.onMoveBegin({objectsMoved:e,from:i,moveMode:"Persistent"}),s.onMove({objectsMoved:e,from:i,leafMatrix:r}),s.onMoveEnd({from:i,status:"Moved"}),n.get().getViewer().render());var a=n.get();o.getCommandCheckHeader("CATC3DPasteAtOriginalPositionHdr",a.getCommandContext?a.getCommandContext():null).setState(!1)}}),this.toggleState=function(){i.getState()||i.setState(!0)},this._destroy=function(){Object.getPrototypeOf(this)._destroy&&Object.getPrototypeOf(this)._destroy.apply(this,arguments),i=void 0}}})}),define("DS/CAT3DComposeCommands/CATC3DPasteAtOriginalPositionCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CATW3DMoveManager/CATW3DMoveManager","DS/ApplicationFrame/CommandsManager"],function(e,t,n,i,o,a,r){"use strict";var s=new o.Matrix4;return e.extend({init:function(e){this._parent(e);var n,o=this,l=!1,c=[],u=i.get().getFrameWindow().getContextualUIManager(),d=a.giveMoveManager({context:i.get()}),m=function(){n=[],u.hideContextualMenus(),t.get().forEach(function(e){var t=d.getSubPathToMovable(e.pathElement);if(t){var i=t.getMatrix();i.equals(s)||n.push({pathElement:e.pathElement,path:t,matrix:i})}}),n.length>0&&(u.showContextualBar({x:i.get().getViewer().SCREEN_WIDTH/2,y:i.get().getViewer().SCREEN_HEIGHT/2,hideWithDistance:!1,fillingList:[{onContextualBarReady:function(){return{cmdList:[{name:"CATC3DPasteAtOriginalPositionStr",line:1,hdr_list:["CATC3DPasteAtOriginalPositionHdr"]},{name:"CATC3DPasteAtLocalCoordinatesStr",line:1,hdr_list:["CATC3DPasteAtLocalCoordinatesHdr"]}]}},context:i.get().getCommandContext?i.get().getCommandContext():null,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:""}]}),l=!0,o.setState(!0))},p=i.get().subscribe({event:"onAuthoringTransactionEnd"},m);require(["DS/CAT3DComposeUtils/CATC3DDropManager"],function(e){var t=e.getDropManager({context:i.get()});c.push(t.subscribe({event:"onBeginInsertDrop3D"},function(){i.get().unsubscribe(p)})),c.push(t.subscribe({event:"onEndInsertDrop3D"},function(e){e&&"inPosition"===e.type&&m(),p=i.get().subscribe({event:"onAuthoringTransactionEnd"},m)}))}),this.onStateChange(function(){if(o.getState()){l?l=!1:n.length>0&&(d.onMoveBegin({objectsMoved:n,from:o,moveMode:"Persistent"}),n.forEach(function(e){!e.path.getMatrix().equals(e.matrix)&&t.isIn(e)&&d.onMove({objectsMoved:[e],from:o,leafMatrix:e.matrix})}),d.onMoveEnd({from:o,status:"Moved"}),i.get().getViewer().render());var e=i.get();r.getCommandCheckHeader("CATC3DPasteAtLocalCoordinatesHdr",e.getCommandContext?e.getCommandContext():null).setState(!1)}}),this.toggleState=function(){this.getState()||o.setState(!0)},this._destroy=function(){i.get().unsubscribe(p),require(["DS/CAT3DComposeUtils/CATC3DDropManager"],function(e){var t=e.getDropManager({context:i.get()});t&&c.forEach(function(e){t.unsubscribe(e)}),c=[]}),Object.getPrototypeOf(this)._destroy&&Object.getPrototypeOf(this)._destroy.apply(this,arguments),d=n=l=p=u=m=o=void 0}}})}),define("DS/CAT3DComposeCommands/CATC3DSwitchAxisCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/ApplicationFrame/CommandsManager","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,n,i,o,a,r,s,l,c){"use strict";var u=l.GeometryType;return e.extend({init:function(e){var l,d;switch(this._parent(e),e.ID){case"CATC3DSwitchAxisXHdr":l=u.AXISX,d=["CATC3DSwitchAxisYHdr","CATC3DSwitchAxisZHdr"];break;case"CATC3DSwitchAxisYHdr":l=u.AXISY,d=["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisZHdr"];break;default:l=u.AXISZ,d=["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisYHdr"]}var m=this.onStateChange(function(){if(this.getState()){var e,u,m=a.giveConstraintsController({context:i.get()}),p=s.giveMoveManager({context:i.get()}),g=r.getMoveReferentManager({context:i.get()}),h=n.get();if(h.some(function(t){var n;return u=g.getMoveReferent(t.pathElement),!!(m&&u&&(n=u.getLastElement(!0))&&c.isInstance(n)&&n.children.length>0)&&(u.addElement(n.children[0]),e=m.getAxisTypeIfCstOnProductAxis(u))}),m&&e&&e!==l&&u){var v=m.simulateSwitchAxis(u,l)||{},f=v.matrix||new o.Matrix4,C=new o.Matrix4,E=v.rc,S=v.redundancy;0!==E||S||(p.onMoveBegin({objectsMoved:h,from:this,moveMode:"Persistent"}),h.forEach(function(e){p.onMove({objectsMoved:[{path:e.pathElement}],from:this,worldMatrix:C.multiplyMatrices(f,e.pathElement.getWorldMatrix())})},this),p.onMoveEnd({from:this,status:"Moved"}),m.setProductAxisForConstraint(l))}var A=i.get();d.forEach(function(e){t.getCommandCheckHeader(e,A.getCommandContext?A.getCommandContext():null).setState(!1)})}});this._destroy=function(){this._modelEvents.unsubscribe(m),Object.getPrototypeOf(this)._destroy.call(this),m=d=null}},toggleState:function(){this.getState()||this.setState(!0,!0)},_destroy:function(){this._parent()}})}),define("DS/CAT3DComposeCommands/CATC3DAxisSystemDisplayAgent",["UWA/Class","DS/Visualization/PathElement","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CATW3DAnims/CATW3DAnimation3D","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/RenderStyle","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,n,i,o,a,r,s,l){"use strict";var c="AxisSystems";return e.extend({init:function(e){var u,d,m,p,g,h,v,f=e.context,C=f.getViewer().getSceneGraphOverrideSetManager();function E(e,t){return e&&t&&e.isEqual(t)}function S(e){for(var n,i=e?new t(e.externalPath):null;i&&(!(n=i.getLastElement())||!l.is3DLeaf(n));)i=i.getParentPath();return i}function A(e){var t,n,i,o,a=S(e),r=null;if(a&&(i=[],n=(t=a.getLastElement(!0)).getChildByName(c))){for(o=n.getParents();o&&o[0]&&o[0]!==t;)i.unshift(o[0]),o=o[0].getParents();i.push(n),r=a,i.forEach(function(e){r.addElement(e)})}if(r){var s=r.getChildrenPathes(),l=[];return s.forEach(function(e){var t={paths:[]};!function e(t,n){var i=null;n.push(t),(i=t.getChildrenPathes())&&i.length>0&&i.forEach(function(t){e(t,n)})}(e,t.paths),l.push(t)}),{axisBagPath:r,axisSystems:l}}return null}function D(e){if(!e||!e.pathElement)return null;if(f.getViewer().getAxisFilter())return v&&(C.removeSceneGraphOverrideSet(v),v=null,f.getViewer().render()),null;v&&-1===C.getSceneGraphOverrideSetIndex(v)&&C.pushSceneGraphOverrideSet(v);var t=A(e.pathElement);if(t&&t.axisSystems&&t.axisSystems.length>0){var n=[];t.axisSystems.forEach(function(e){var t;t=e.paths[0],p&&!p.get().some(function(e){return e.pathElement.getLastElement(!0)===t.getLastElement(!0)})&&(e.node=e.paths[0].getLastElement(!0),n.push(e))}),n.length===t.axisSystems.length&&n.push({paths:[t.axisBagPath]}),n.length>0&&n.forEach(function(e){v||(v=new r(f.getRootBagPath().externalPath[0]),C.pushSceneGraphOverrideSet(v));var t,n=v.getUniqueOverrideFromPathElement(e.paths[0]);n||(n=v.createOverride({pathes:e.paths}),(t=new s).setRenderMode("AxisSystem",!0),n.setRenderStyle(t)),e.override=n}),a.getAnimation3DEngine({viewer:f.getViewer()}).axisSystemVisibility({objectListToAnimate:n,visibility:e.visibility,pickability:e.pickability})}return e.pathElement}function y(e){var t=S(e.pathElement);E(g,t)||(D({pathElement:g,visibility:!1,pickability:!1}),g=D({pathElement:t,visibility:!0,pickability:!0}))}function x(){var e=n.get();clearTimeout(h),h=null,1===e.length?y({pathElement:e[0].pathElement?e[0].pathElement:e[0].originalPathElement}):D({pathElement:g,visibility:!1,pickability:!1})}function T(e){var t=S(e.pathElement?e.pathElement:e.originalPathElement);t&&(h=setTimeout(function(){D({pathElement:t,visibility:!1,pickability:!1}),g=null},1e3))}function b(e){var t=S(e.pathElement);(!g||g&&t&&!E(t,g))&&D({pathElement:e.pathElement,visibility:!1,pickability:!1})}f.getViewer().onAxisFilterChange(function(){v&&(C.removeSceneGraphOverrideSet(v),v=null,f.getViewer().render())}),this.activate=function(e){p||(v&&(C.pushSceneGraphOverrideSet(v),f.getViewer().render()),u=n.onPostAdd(x),d=n.onRemove(T),p=e&&"HSO"===e.type?i:o,m=p.onRemove(b))},this.analyze=y,this.deactivate=function(){p&&(v&&(C.removeSceneGraphOverrideSet(v),f.getViewer().render()),n.unsubscribe(u),n.unsubscribe(d),p.unsubscribe(m),u=d=m=p=null)}}})}),define("DS/CAT3DComposeWidget/CATC3DAppInit",["DS/WAfrContainer/App"],function(e){"use strict";var t;return e.extend({setUp:function(e){var n=this;if(e.sourceApp){if(!e.sourceApp.pad3DViewer)return window.console.log("pad3DViewer property must be valuated"),void e.done();this.pad3DViewer=e.sourceApp.pad3DViewer,this.appMainDiv=e.sourceApp.appMainDiv,new Promise(function(n){t?n():require(["DS/CAT3DComposeWidget/CAT3DComposeWidgetMain"],function(i){t=i.getApp({widget:window.widget,pad3DViewer:e.sourceApp.pad3DViewer,appMainDiv:e.sourceApp.appMainDiv}),n()})}).then(function(){e.sourceApp&&!e.sourceApp.isDisposeCalled()&&e.sourceApp.dispose();var i=e.done;e.done=function(t){n.appMainDiv||(n.appMainDiv=t.appMainDiv),e.done=i,e.done()},t.setUp(e)})}else require(["DS/CAT3DComposeWidget/CAT3DComposeWidgetMain"],function(i){t=i.getApp({widget:window.widget,viewerAttachment:e.done,done:function(e){n.pad3DViewer=e.pad3DViewer,n.appMainDiv=e.appMainDiv}})})},dispose:function(e){t.dispose(e),this._parent(e)},onWillEnter:function(e){return require(["DS/CAT3DComposeUtils/CATC3DUtils"],function(t){t._sendUsageProbe("appTransitionFrom",e.options.id,"resolved")}),this._parent(e)},onWillLeave:function(e){return t&&t.onWillLeave&&t.onWillLeave(e),require(["DS/CAT3DComposeUtils/CATC3DUtils"],function(t){t._sendUsageProbe("appTransitionTo",e.options.id,"resolved")}),this._parent(e)}})}),define("DS/CAT3DComposeCommands/CATC3DReverseDirectionCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/PADUtils/PADContext","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DMoveManager/CATW3DMoveManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,n,i,o,a,r,s){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!1}),this.setRepeatMode(!1),this.execute=function(){var e=t.get();if(e.length){var l,c=i.get(),u=r.giveMoveManager({context:c}),d=o.getMoveReferentManager({context:c}),m=a.giveConstraintsController({context:c});if(e.some(function(e){var t;return l=d.getMoveReferent(e.pathElement),!!(m&&l&&(t=l.getLastElement(!0))&&s.isInstance(t)&&t.children.length>0)&&(l.addElement(t.children[0]),m.isThereACstSuppportingReverseDirection(l))})&&l&&m){var p=m.simulateReverseDirection(l)||{},g=p.matrix||new n.Matrix4,h=new n.Matrix4,v=p.rc,f=p.redundancy;0!==v||f||(u.onMoveBegin({objectsMoved:e,from:this,moveMode:"Persistent"}),e.forEach(function(e){u.onMove({objectsMoved:[{path:e.pathElement}],from:this,worldMatrix:h.multiplyMatrices(g,e.pathElement.getWorldMatrix())})},this),u.onMoveEnd({from:this,status:"Moved"}))}}}}})}),define("DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent",["UWA/Class","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/ApplicationFrame/CommandsManager","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,n,i,o,a,r,s){"use strict";var l=0;return e.extend({init:function(e){this._parent(e);var c,u,d=e.context,m=d.getCommandContext?d.getCommandContext():null,p=[];this.activate=function(){0===p.length&&(c=d.getViewer(),u=r.getMoveReferentManager({context:d}),p=["CAT3DComposeCtxMenuAgent_"+l++,"CAT3DComposeCtxMenuAgent_"+l++],d.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(e,r){var l=t.get();if(0!==l.length){var p=s.getRoots(d),g=[],h=!1,v=!1,f=a.giveConstraintsController({context:d});l.some(function(e){var t,n=u.getMoveReferent(e.pathElement);if(n&&(t=n.getLastElement(!0))&&s.isInstance(t)&&t.children.length>0){n.addElement(t.children[0]),f&&f.isThereACstSuppportingReverseDirection(n)&&(h=!0);var a=f?f.getAxisTypeIfCstOnProductAxis(n):null;return a&&(v=!0,a===o.GeometryType.AXISX?i.getCommandCheckHeader("CATC3DSwitchAxisXHdr",m).setState(!0):a===o.GeometryType.AXISY?i.getCommandCheckHeader("CATC3DSwitchAxisYHdr",m).setState(!0):i.getCommandCheckHeader("CATC3DSwitchAxisZHdr",m).setState(!0)),h&&v}return!1}),v&&g.push({name:"CATC3DSwitchAxisIcb",line:1,hdr_list:["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisYHdr","CATC3DSwitchAxisZHdr"]}),h&&g.push({name:"CATC3DReverseDirectionStr",line:1,hdr_list:["CATC3DReverseDirectionHdr"]});var C=l.some(function(e){var t=e.pathElement.getLastElement(!0);return p.some(function(n){var i=n!==t,o=e.pathElement.externalPath.some(function(e){return n===e});return i&&o})});if(C&&r&&r.withContextMenu&&"number"==typeof r.XmousePosition&&"number"==typeof r.YmousePosition)0===c.pick(c.getMousePosition(new n.Vector2(r.XmousePosition,r.YmousePosition)),"mesh",!1).path.length&&(C=!1);return C&&(i.getCommand("CAT3DComposeExamineSelectionHdr",m).canBeEnabled(l)&&g.push({name:"CAT3DComposeExamineSelectionStr",line:1,hdr_list:["CAT3DComposeExamineSelectionHdr"]}),1===l.length&&(g.push({name:"RobotSnapMove",line:1,hdr_list:["CAT3DComposeRobotSnapMoveHdr"]}),g.push({name:"LevelSelector",line:1,hdr_list:["LevelSelectorHdr"]}))),g.length?{cmdList:g}:void 0}},context:m,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:"",merge:!0,subscriberId:p[0]}),d.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(e,i){var o=[],a=t.get();if(1===a.length){var r=a[0].pathElement.getLastElement(!0);s.getRoots(d).some(function(e){return e===r})&&o.push({name:"RemoveRoot",line:1,hdr_list:["RemoveRootHdr"]})}if(i&&i.withContextMenu&&"number"==typeof i.XmousePosition&&"number"==typeof i.YmousePosition&&0===c.pick(c.getMousePosition(new n.Vector2(i.XmousePosition,i.YmousePosition)),"mesh",!1).path.length)return;return o.length?{cmdList:o}:void 0},context:m,workbenchName:"ENOPAD3DViewerContextualBar",module:"ENOPAD3DViewer",cmdPrefix:"",merge:!0,subscriberId:p[1]}))},this.deactivate=function(){c=u=null,p.forEach(function(e){d.getFrameWindow().getContextualUIManager().unregister(e)}),p=[]}}})}),define("DS/CAT3DComposeUI/CAT3DComposeWidgetOptions",["UWA/Core","UWA/Class","UWA/Class/Options","UWA/Utils"],function(e,t,n,i){"use strict";return t.singleton(n,{init:function(){var t={};window.c3dUrlComplementForODT&&(t=i.parseQuery(window.c3dUrlComplementForODT)),""!==window.location.search&&(e.extend(t,i.parseQuery(window.location.search)),t.widgetDomain&&e.extend(t,i.parseQuery(t.widgetDomain)));var n={};"c3dAnim"in t&&(n.animationOff="no"===t.c3dAnim),"C3DSTR"in t&&(n.C3DSTR=!0),"debug_me"in t&&(n.debug=!0),"testWkb"in t&&(n.testWkb=!0),"authoring3d"in t&&(n.authoring3d=!0),this.setOptions(n)}})}),define("DS/CATC3DNavigation/CATBreadCrumbs",["UWA/Core","UWA/Class","DS/CoreEvents/Events","css!DS/CATC3DNavigation/CATC3DNavigation.css"],function(e,t,n){"use strict";return t.extend({init:function(t){var i,o,a,r,s=[],l=t.parentFrame,c=null,u=function(){for(var e=0;e<s.length;e++)s[e].div.removeClassName("first-crumb"),s[e].div.removeClassName("crumbs-with-home"),s[e].div.removeClassName("last-crumb"),0===e&&(s[e].div.addClassName("first-crumb"),o&&s[e].div.addClassName("crumbs-with-home")),s[e].lastBreadCrumb&&s[e].div.addClassName("last-crumb"),s[e].div.setStyle("z-index",1e4-e);o&&(o.div.setStyle("z-index",10001),s.length?(o.div.setStyle("border-top-right-radius","0px"),o.div.setStyle("border-bottom-right-radius","0px")):(o.div.setStyle("border-top-right-radius","5px"),o.div.setStyle("border-bottom-right-radius","5px")))},d=function(e){var t=null,n=e.changedTouches[0].clientX,o=e.changedTouches[0].clientY,a=i.getPosition();return i.getChildren().some(function(e){var i=e.getPosition(),r=e.getDimensions(),l=i.x+a.x,c=l+r.width,u=i.y+a.y,d=u+r.height;return"number"==typeof e.idthumb&&e.idthumb<s.length-1&&(c+=16),l<=n&&n<=c&&u<=o&&o<=d&&(t=e,!0)}),t},m=function(e){e&&a===e&&e.addClassName("navigationBreadCrumbActivated"),e&&"Home"!==e.idthumb&&!c&&(c=setTimeout(function(){e.querySelector("p").addClassName("navigationBreadCrumbExpand"),c=null},1e3))},p=function(e){e&&e.removeClassName("navigationBreadCrumbActivated"),e&&"Home"!==e.idthumb&&(c?(clearTimeout(c),c=null):a&&a===e||e.querySelector("p").removeClassName("navigationBreadCrumbExpand"))},g=function(e){a&&e&&a===e.div&&(a.removeClassName("navigationBreadCrumbActivated"),e.cb()),a=null},h=function(e){1===e.touches.length&&(e.preventDefault(),e.stopPropagation(),m(a=r=d(e)))},v=function(e){if(1===e.touches.length){e.preventDefault(),e.stopPropagation();var t=d(e);t!==r&&(p(r),m(t),r=t)}},f=function(e){e.preventDefault(),e.stopPropagation();var t=d(e);g(t?"Home"===t.idthumb?o:s[t.idthumb]:null),p(t)},C=function(e){var t=e.target.idthumb;m("Home"===t?o.div:s[t].div)},E=function(e){var t=e.target.idthumb;p("Home"===t?o.div:s[t].div)},S=function(e){if(0===e.button&&1===e.buttons){var t=e.target.idthumb;m(a="Home"===t?o.div:s[t].div);var i=n.subscribe({event:"/VISU/onLeftMouseUp"},function(e){n.unsubscribe(i),i=void 0,("Home"===(t=e.from[0].event.target.idthumb)?o.div:"number"==typeof t?s[t].div:null)!==a&&(a.querySelector("p").removeClassName("navigationBreadCrumbExpand"),a=null)})}},A=function(e){if(a&&0===e.button&&0===e.buttons){var t=e.target.idthumb;g("Home"===t?o:s[t])}};function D(){i||(i=e.createElement("ul",{class:"navigationBreadCrumb"}).inject(l))}function y(){i&&(0!==s.length||o?u():(i.destroy(),i=null))}function x(e,t){i&&(s[e].div.setStyle("opacity","0"),s[e].div.setStyle("right","25px"),s[e].div.removeEvents(),i.removeChild(s[e].div),s.splice(e,1)),t&&y()}this.activate=function(e){i&&("Home"!==e?s[e].cb():o.cb())},this.addHomeBreadCrumb=function(t){if(t&&!o)return D(),(o={}).div=e.createElement("li",{class:"navigationBreadCrumb homeBreadCrumb"}),e.createElement("span",{class:"homeBreadCrumb fonticon fonticon-home"}).inject(o.div).idthumb="Home",0===s.length?i.appendChild(o.div):i.insertBefore(o.div,s[0].div),o.cb=function(){return t.cb?t.cb({div:o.div}):void 0},o.div.setStyle("opacity","1"),o.div.setStyle("right","0px"),o.div.idthumb="Home",o.div.addEvents({mousedown:S,mouseup:A,mouseenter:C,mouseleave:E}),o.div.addEvents({touchstart:h,touchmove:v,touchend:f}),u(),o.div},this.removeHomeBreadCrumb=function(){i&&o&&(o.div.removeEvents(),i.removeChild(o.div),o=null),y()},this.addBreadCrumb=function(t){D();var n=e.createElement("li",{class:"navigationBreadCrumb"}).inject(i);n.idthumb=s.length;var o=e.createElement("p").inject(n);return o.idthumb=s.length,o.innerHTML=e.is(t.label)&&e.is(t.label,"string")?t.label:"",e.createElement("span").inject(n).idthumb=s.length,s.push({div:n,cb:function(){return t.cb?t.cb({div:n}):void 0},lastBreadCrumb:t.lastBreadCrumb}),n.addEvents({mousedown:S,mouseup:A,mouseenter:C,mouseleave:E}),n.addEvents({touchstart:h,touchmove:v,touchend:f}),u(),setTimeout(function(){n.setStyle("opacity","1"),n.setStyle("right","0px")},10),n},this.removeBreadCrumb=function(e){x(e,!0)},this.setLabel=function(e,t){i&&"Home"!==e&&e<s.length&&(s[e].div.querySelector("p").innerHTML=t)},this.destroy=function(){for(var e=s.length-1;e>=0;e--)x(e,!1);this.removeHomeBreadCrumb()},this.show=function(){i&&i.show()},this.hide=function(){i&&i.hide()}}})}),define("DS/CAT3DComposeUtils/CATC3DUtils",[],function(){"use strict";var e,t,n;function i(e,t,n,i){var o,a,r=n.length,s=e.getFrameWindow().getViewpoint().reframe,l=!0===require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_lightNodeModel"),c=function(){0===--r&&(e.unsubscribe(o),e.unsubscribe(a),e.getFrameWindow().getViewpoint().reframe=s,l&&e.getController().forceRefresh(),i(n))};o=e.subscribe({event:"onInsertExisting"},c),a=e.subscribe({event:"onInsertExistingFailure"},c),e.getFrameWindow().getViewpoint().reframe=function(){},n.forEach(function(n){n.instID?(e.getController().switchAuthoringMode(!0,!0,"PADSession_disabling_index_authoring"),e.getController().insertExisting({created:[n.instID],inserted:[[t,n.instID,n.childID]],modified:[t],matrix:n.matrix})):c()})}return Object.freeze({insertExisting:function n(o){if("string"==typeof o.parentID&&o.children instanceof Array&&"function"==typeof o.onCompleted&&o.context)if(e){var a=o.parentID,r=[];o.children.forEach(function(n){e.insertExisting({modeler:"product",data:{version:"1.0",hasParent:a,children:[{isInstanceOf:n.id}]},onComplete:function(e){var s="string"==typeof e?JSON.parse(e):null;if(s&&"success"===s.status){var l=s.results[0].instance;!function(e,n,i){if(n){var o={onComplete:function(){i()},onFailure:function(){i(),window.console.log("Unable to store matrix")}};o.instances=[{instance:e,hasPositioningMatrix:[0,1,2,4,5,6,8,9,10,12,13,14].map(function(e){return n.elements[e]})}],t?t.move3D(o):i()}else i()}(l,n.matrix,function(){r.push({instID:l,childID:n.id,matrix:n.matrix}),o.children.length===r.length&&i(o.context,a,r,o.onCompleted)})}else r.push({instID:null,matrix:null,childID:n.id,message:s&&s.message?s.message:void 0}),o.children.length===r.length&&i(o.context,a,r,o.onCompleted)},onFailure:function(e){var t="string"==typeof e?JSON.parse(e):null;r.push({instID:null,matrix:null,childID:n.id,message:t&&t.message?t.message:void 0}),o.children.length===r.length&&i(o.context,a,r,o.onCompleted)}})})}else require(["DS/AuthGenericCommands/AuthGenericCmdWSAccess","DS/UPSCommands/UPSCmdUtils"],function(i,a){e=i,t=a,n(o)})},_sendUsageProbe:function(e,t,i){if(n){var o=n.getPADTracker({eventCategory:"usage",eventAction:e}),a={eventLabel:t};void 0!==i&&(a.eventValue=i),o.setEventData(a),o.trackPageEvent()}else require(["DS/PADServices/utils/PADTrackerManager"],function(e,t,i,o){n=o,this._sendUsageProbe(e,t,i)}.bind(this,e,t,i))}})}),define("DS/CAT3DComposeWidget/CAT3DComposeWidgetMain",["UWA/Core","DS/CAT3DComposeUI/CAT3DComposeWidgetOptions","DS/CATWebUXSlideDrop/CATWebUXSlideDropServices"],function(e,t,n){"use strict";var i,o;function a(e){this.isAppReady=!1,this.params=e,this.welcomePanel=this.pad3DViewer=null,this.tokensWelcomePanel=[]}return a.prototype={constructor:a,initialize:function(){return new Promise(function(e){require(["DS/PADServices/views/LandingPage","DS/PADServices/utils/GlobalModelEvents","i18n!DS/CAT3DComposeWidget/assets/nls/CAT3DComposeWidget"],function(t,n,o){i=n,this.tokensWelcomePanel.push(i.subscribe({event:"ENXViews/WelcomePanel/action/welcomPanelPrefCmd"},function(){require(["DS/CATWebUXPreferences/CATWebUXPreferencesManager"],function(e){var t=e.givePreferenceManager({context:this.pad3DViewer.getFrameWindow()});if(t){var n=t.subscribe("onPreferencesPanelDestroyed",function(){t.unsubscribe(n),this.showWelcomePanel(!0)}.bind(this));this.showWelcomePanel(!1),t.displayPreferencePanel(this.pad3DViewer.getFrameWindow())}}.bind(this))}.bind(this)));var a=t.getDefaultActivities();a.activities.push({section:{id:"customizeAppSection",title:o.customApp,actions:[{id:"welcomPanelPrefCmd",title:o.prefs,icon:"cog"}]}}),this.welcomePanel=new t({widget:this.params.widget,readOnlyApp:!1,renderDiv:this.params.renderDiv,externalViewerMgt:!0,externalViewerMgtCB:function(e,t){!0!==t&&this.showWelcomePanel("viewer"!==e)}.bind(this),defaultActionId:a.defaultActionId,activities:a.activities,onLandingPageReady:this.params.onLandingPageReady}),this.welcomePanel.initialize().then(e)}.bind(this))}.bind(this))},setViewer:function(e){this.pad3DViewer=e,!this.params.initApp&&this.showWelcomePanel(!1);var t=e.render().getContent(),n=t.parentNode;t.style.position="relative",!this.params.renderDiv.parentNode&&n&&n!==this.params.renderDiv&&n.insertBefore(this.params.renderDiv,n.firstChild),this.params.renderDiv.insertBefore(t,this.params.renderDiv.firstChild),this.params.renderDiv.insertBefore(this.welcomePanel.elements.mainBody,this.params.renderDiv.firstChild),this.welcomePanel.setViewer(e,!this.params.initApp)},appReady:function(){if(this.isAppReady=!0,this.params.initApp){var e=this.params.widget.getValue("X3DContentId");this.params.widget.deleteValue("X3DContentId"),e&&setTimeout(function(t){t.addRootNodesFromContent({json3DXContent:JSON.parse(e),dispatch:!1})},0,this.pad3DViewer)}var t=this.welcomePanel.appReady();return this.welcomePanel.redraw(),t},dispose:function(){if(this.showWelcomePanel(!1),this.welcomePanel)return this.pad3DViewer=this.params=null,this.tokensWelcomePanel.forEach(i.unsubscribe,i),this.tokensWelcomePanel.length=0,this.welcomePanel.dispose()},showWelcomePanel:function(e){this.welcomePanel&&(this.welcomePanel.elements.mainBody.style.position="relative",this.welcomePanel.elements.mainBody.style.display=e?"":"none",e&&this.welcomePanel.redraw())}},Object.freeze({getApp:function(i){if(o||null===o)return o;var r,s,l,c,u,d,m,p,g,h,v,f=i.widget,C=i.pad3DViewer,E=i.appMainDiv,S=C?C.getCommandContext():null,A=t.getOption("testWkb")?{module:"CAT3DComposeWebUXTstUtils",file:"CAT3DComposeWidgetWkb_TST.xml",xmlPath:"text!DS/CAT3DComposeWebUXTstUtils/assets/afr/CAT3DComposeWidgetWkb_TST.xml"}:t.getOption("authoring3d")?{module:"CAT3DComposeWidget",file:"CAT3DComposeWidgetNextWkb.xml",xmlPath:"text!DS/CAT3DComposeWidget/assets/afr/CAT3DComposeWidgetNextWkb.xml"}:{module:"CAT3DComposeWidget",file:"CAT3DComposeWidgetWkb.xml",xmlPath:"text!DS/CAT3DComposeWidget/assets/afr/CAT3DComposeWidgetWkb.xml"};function D(e,t,n){window.top.performance.measure(f.id+e,n?f.id+t:t)}function y(e){window.top.performance.mark(f.id+e)}function x(){C&&C.getContentName({callbacks:{onComplete:function(e){f.setTitle(e.contentName)},onFailure:function(){}}})}function T(e,t){["_commands","_cmdCheckHeader"].forEach(function(n){var i=S?e[n][S]:e[n];i[t]&&(i[t]._destroy&&i[t]._destroy(),delete i[t])})}function b(e,t,n){var i=e.getCommand("CATC3DNavigationStartHdr",S);i&&(i.onNavigationStart({onStart:function(n){var i={lastCommand:[],currentCommand:null,defaultCommand:null};S?e._commandsState[S]=i:e._commandsState=i,e.resetDefaultCommand(S),t.getDropManager({context:C}).disconnect();var o=h.giveMove3DRobot({context:C});o&&o.unreference(),s=n,T(e,"CAT3DComposeWidgetDefaultHdr");for(var a=A.xml?(new DOMParser).parseFromString(A.xml,"text/xml").getElementsByTagName("CATCommandHeader"):[],r=a.length-1;r>=0;--r){var l=a[r].attributes.getNamedItem("ClassName").value;if(!l.startsWith("DS/ViewerCommands")&&!l.startsWith("DS/ENOPAD3DViewer")&&!l.startsWith("DS/PADUtils")){var c=a[r].attributes.getNamedItem("ID").value;"CAT3DComposeExamineSelectionHdr"!==c&&T(e,c)}}n.done()}}),i.onNavigationExit({actionBar:[{file:A.file,module:A.module,onActionBarReady:function(){e.setDefaultCommand({ID:"CAT3DComposeWidgetDefaultHdr",className:"DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",context:S}),n.getMove3DRobot({context:C}),s=null,C.setDefaultContextualBarVisibility(!1),C.setDefaultContextualMenuVisibility(!0),C.setOpenWithMenuAvailability(!0),t.getDropManager({context:C}).connect()}}]}))}function P(e){m&&h&&g&&p&&!l&&(b(p,g,h),r&&r(E),r=null,d.appReady(),D("_C3D_Global widget creation time","C3D_jsAppLoad",!1),f.dispatchEvent("onWidgetAndAppReady","1"===f.getValue("widgetForODTReplay")?[{pad3DViewer:e}]:void 0))}require([A.xmlPath],function(e){A.xml=e});var M,I,R,w=function(){require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext","DS/PADUtils/PADCommandProxy"],function(e,t){(M=e).renderDiv||M.initialize2(C.getFrameWindow().getViewerFrame(),t.appId(),f.getValue("changeControlActivation")?"show":"hide","top-right",function(){M.addEvent("onAuthoringCtxVisible",function(e){e.showAuthoringContext&&f.setValue("changeControlActivation",!0)})})})},N=function(e){require(["DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADCommandProxy","DS/PADUtils/PADSharedSettings","i18n!DS/PADUtils/assets/nls/PADUtils"],function(n,i,o,a){var r,s=[],l=[];R=function(){f.setPreferences([]),r.destroy(),s.forEach(function(e){e.cb&&n.removeEvent(e.cb,e.padFct)}),R=function(){}},I=function(){s.forEach(function(e){var t=e.preference.name,i=f.getValue(t),o=n.getSetting(t);(i="boolean"===e.preference.type&&"boolean"!=typeof i?"true"===i:i)!==o&&n.setSetting(t,i),e.fct&&e.fct(i)}),n.updateWidgetPreferences(),!r&&s.length&&(r=i.create({events:{onPreferenceModification:function(e){s.some(function(t){if(e.name===t.preference.name){if("boolean"!=typeof e.value&&"string"!=typeof e.value)throw new Error("Value must be a string or a boolean");if(n.getSetting(e.name)!==e.value){if("boolean"===t.preference.type&&"boolean"!=typeof e.value)throw new Error("Preference is a boolean type so value must be a boolean");t.debounce=!0,f.setValue(e.name,e.value),n.setSetting(e.name,e.value)}return t.fct&&t.fct(e.value),!0}})}}}),s.forEach(function(e){e.cb&&n.addEvent(e.cb,e.padFct=function(t){e.debounce?e.debounce=!1:r.preferenceModification({name:e.preference.name,value:t})})}))},f.setPreferences([]),n.setSetting("syncAutoReload",!0),o.destroy(),o.addSharedSettings(f),s.push({preference:{name:"changeControlActivation",type:"boolean",label:a.changeControlActivation_label,defaultValue:!0},fct:function(e){M&&M[e?"show":"hide"]()},cb:"onChangeControlActivation",debounce:!1}),s.push({preference:{name:"changeControlPosition",type:"list",label:a.changeControlPosition_label,defaultValue:"top-right",options:[{label:a["top-right_label"],value:"top-right"},{label:a["top-left_label"],value:"top-left"},{label:a["bottom-left_label"],value:"bottom-left"},{label:a["bottom-right_label"],value:"bottom-right"}]},fct:function(e){M&&M.setPosition(e)}}),n.setSetting("authorizeChangeControl",!0),e&&w(),t.getOption("debug")?s.push({preference:{name:"webapi_timeout",type:"text",label:"Query timeout",defaultValue:"60000"}}):l=["webapi_timeout"],l.forEach(function(e){f.deleteValue(e)}),l.length=0,s.forEach(function(e){f.mergePreferences([e.preference])}),I(),f.addEvent("endEdit",I)})};function L(e){e.unsubscribe(c),c=null,x(),w(),require("DS/PADUtils/PADUtilsServices").isCloud()&&!window.__preventPrefPanel&&e.getViewer().displayIntroductoryControlPreferencePanel(),y("_C3D_beforeRobotAndDirectMoveLoad"),require(["DS/CATW3DRobot/CATW3DRobot","DS/CAT3DComposeUtils/CATC3DDropManager"],function(t,n){D("_C3D_Applicative Init JS Loading","_C3D_beforeRobotAndDirectMoveLoad",!0),y("_C3D_afterRobotAndDirectMoveLoad"),(h=t).getMove3DRobot({context:e}),e.getFrameWindow().getContextualUIManager().activateContextualBarOnLeftClicAfterCSOChange(),D("_C3D_Applicative Init","_C3D_afterRobotAndDirectMoveLoad",!0),(g=n).getDropManager({context:e}).connect(),P(e)})}function _(e){e.unsubscribe(u),u=null,y("_C3D_ownCommands"),D("_C3D_Action Bar merge app commands","_C3D_ownCommands",!0),y("_C3D_beforeDefaultCmdLoad"),S=C.getCommandContext(),(p=require("DS/ApplicationFrame/CommandsManager")).setDefaultCommand({ID:"CAT3DComposeWidgetDefaultHdr",className:"DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",context:S}),D("_C3D_Default Cmd Init","_C3D_beforeDefaultCmdLoad",!0),P(e)}function F(e){D("_C3D_PAD3DViewer creation","_C3D_PAD3DViewerReady",!0),e.unsubscribe(l),l=null,P(e)}function O(t){return E||(E=e.createElement("div",{class:"appMain",styles:{width:"auto",height:"100%"}})),(d=new a({widget:f,readOnlyApp:!1,renderDiv:E,initApp:t&&t.initApp,onLandingPageReady:t&&t.onLandingPageReady})).initialize()}function W(){if(!C){D("_C3D_UWA widget loading","_C3D_widgetLoad",!0),y("_C3D_LoadJSPAD3DViewer");var t=new Promise(function(e){O({initApp:!0,onLandingPageReady:function(){r(E),r=null}}).then(e)}),o=new Promise(function(e){require(["DS/ENOPAD3DViewer/PAD3DViewer","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager","text!DS/CAT3DComposeWidget/assets/json/CATC3DWindowOptions.json"],function(t,n,i,o){D("_C3D_PAD3DViewer load JS","_C3D_LoadJSPAD3DViewer",!0),y("_C3D_PAD3DViewerReady"),m=n,v=i,f.setValue("tenantAware",!0),e([t,o])})}),a=new Promise(e=>{f.data.x3dShareId?e():require(["DS/ENOXInterWdgCom/LinkManager"],t=>{t.initializeWidgetLink(f,{appIds:[],uses:["ENXContent"],implements:["ENXContent"],open:!0}).then(e)})});Promise.all([t,o,a]).then(function(t){var o=require("DS/PADUtils/PADSettingsMgt"),a=e.extend({context:"Default",workbench:A.file,workbenchModule:A.module},JSON.parse(t[1][1])),r={widget:f,windowOptions:a,enableFiltering:!0,binaryPrimitives:!0,enableSidePanel:!0,visuProgressiveTileModel:!0,readyCB:N};a.mouseProfile=require("DS/PADUtils/PADUtilsServices").isCloud()?window.__mouseProfile:"CATIA",C=new t[1][0](r),a.mouseProfile&&C.getViewpoint().setDefaultController(!0,a.mouseProfile),m.getMoveManager({context:C,saveToDatabase:!0}),v.getPreferenceManager({context:C.getFrameWindow()}).removeAllPreferences(),d.setViewer(C),C.setOption("propertiesFacet",o.getSetting("propertiesFacet")),C.setAuthorizedRootTypes(o.getSetting("ups_authorized_root_types")),C.setDefaultContextualBarVisibility(!1),C.setDefaultContextualMenuVisibility(!0),C.setOpenWithMenuAvailability(!0),c=C.subscribe({event:"onViewerReady"},L),u=C.subscribe({event:"onActionBarReady"},_),l=C.subscribe({event:"onReady"},F),C.subscribe({event:"onRootAdded"},x),C.subscribe({event:"onRootRemoved"},x),C.subscribe({event:"onRootAttached"},x),C.subscribe({event:"onRootDetached"},x),C.subscribe({event:"onContentNameModified"},x),C.setupWidgetLink(),C.setLoadingDelegations(n.getDelegation(C)),o.setSetting("settypes",!0),"1"===f.getValue("widgetForODTReplay")&&f.dispatchEvent("onPAD3DViewerCreated",[{pad3DViewer:C}]),i.done&&i.done({appMainDiv:E,pad3DViewer:C})})}}function U(){C&&C.refresh()}function V(){if(d&&d.dispose(),d=null,g&&g.unreferenceDropManager({context:C}),m&&m.unreferenceMoveManager({context:C}),h){var e=h.giveMove3DRobot({context:C});e&&e.unreference()}o=f=C=S=r=E=s=m=p=g=h=A=null}function k(e){C&&C.search({searchQuery:e})}return C?f.addEvent("onDestroy",V):(D("_C3D_JS dependencies loading","C3D_jsAppLoad",!1),y("_C3D_widgetLoad"),i.viewerAttachment?(r=i.viewerAttachment,W()):(r=function(e){f.setBody(e)},f.addEvent("onLoad",W)),f.addEvent("onRefresh",U),f.addEvent("onDestroy",function(){var e=C;V(),e&&e.destroy()}),f.addEvent("onSearch",k),f.setMetas({helpPath:"CAT3DComposeWidget/assets/help"})),o=Object.freeze({setUp:function(e){Promise.all([p?Promise.resolve():new Promise(function(e){require(["DS/ApplicationFrame/CommandsManager"],function(t){p=t,e()})}),m?Promise.resolve():new Promise(function(e){require(["DS/CATW3DMoveManager/CATW3DMoveManager"],function(t){m=t,e()})}),v?Promise.resolve():new Promise(function(e){require(["DS/CATWebUXPreferences/CATWebUXPreferencesManager"],function(t){v=t,e()})})]).then(function(){f.addEvent("onRefresh",U),f.addEvent("onSearch",k),f.setMetas({helpPath:"CAT3DComposeWidget/assets/help"});var t={lastCommand:[],currentCommand:null,defaultCommand:null};if(S?p._commandsState[S]=t:p._commandsState=t,p.resetDefaultCommand(S),p._isCommandEnding=!1,p._ignoreCommandBeginWhileEndingCommand=!1,["_commands","_cmdCheckHeader"].forEach(function(e){var t=S?p[e][S]:p[e];Object.keys(t).forEach(function(e){var n=t[e];n&&n._destroy&&n._destroy(),delete t[e]})}),e.sourceApp&&e.sourceApp.pad3DViewer!==C){if(g&&g.unreferenceDropManager({context:C}),g=null,m&&m.unreferenceMoveManager({context:C}),m=null,h){var n=h.giveMove3DRobot({context:C});n&&n.unreference()}h=null,C=e.sourceApp.pad3DViewer}C.setOption("propertiesFacet",require("DS/PADUtils/PADSettingsMgt").getSetting("propertiesFacet")),C.getBIController().toggleBetweenStandaloneAndSlaveMode("DUAL"),N(C),C.getFrameWindow().getContextualUIManager().activateContextualBarOnLeftClicAfterCSOChange(),C.setDefaultContextualBarVisibility(!1),C.setDefaultContextualMenuVisibility(!0),C.setOpenWithMenuAvailability(!0),C.getViewer().updateViewPanelUIConfiguration&&C.getViewer().updateViewPanelUIConfiguration({useShadingIllustration:!1,useOutline:!1}),x(),m.unreferenceMoveManager({context:C}),m.getMoveManager({context:C,saveToDatabase:!0}),v.getPreferenceManager({context:C.getFrameWindow()}).removeAllPreferences();var i=C.subscribe({event:"onActionBarReady"},function(){C.unsubscribe(i),p.setDefaultCommand({ID:"CAT3DComposeWidgetDefaultHdr",className:"DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",context:S}),require(["DS/CATW3DRobot/CATW3DRobot","DS/CAT3DComposeUtils/CATC3DDropManager"],function(t,n){(h=t).getMove3DRobot({context:C}),(g=n).getDropManager({context:C}).connect(),b(p,g,h),e.done({appMainDiv:E,pad3DViewer:C})})});C.loadActionBar({merge:!1,file:A.file,module:A.module}),O().then(function(){d.setViewer(C),d.appReady()})})},dispose:function(){if(f.removeEvent("onRefresh",U),f.removeEvent("onSearch",k),f.removeEvent("endEdit",I),R(),d&&d.dispose(),d=null,s&&s.controller&&(s.activated=!1,s.controller.end(),s=null),h){var e=h.giveMove3DRobot({context:C});e&&e.unreference()}m&&m.unreferenceMoveManager({context:C}),C&&(C.setDefaultContextualBarVisibility(!0),C.setDefaultContextualMenuVisibility(!0),C.setOpenWithMenuAvailability(!1)),g&&g.getDropManager({context:C}).disconnect();var t=v.givePreferenceManager({context:C.getFrameWindow()});t&&t.removeAllPreferences(),v.unreferencePreferenceManager({context:C.getFrameWindow()})},onWillLeave:function(){}})}})}),define("DS/CATC3DNavigation/CATC3DNavigationDefaultCmd",["DS/ApplicationFrame/Command","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/PADUtils/PADContext","DS/CATC3DNavigation/CATC3DNavigationContoller","DS/ApplicationFrame/CommandsManager"],function(e,t,n,i,o){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),this.setRepeatMode(!1);var a=n.get(),r=a.getCommandContext?a.getCommandContext():null,s=i.getNavigationContoller({context:a});this.beginExecute=function(){var e=t.giveDataLauncherController({context:a});e&&e.setActiveState(!0),o.getCommand("CAT3DComposeExamineSelectionHdr",r).activate(),s&&s.resume()},this.endExecute=function(){var e=t.giveDataLauncherController({context:a});e&&e.setActiveState(!1);var n=o.getCommand("CAT3DComposeExamineSelectionHdr",r);n&&n.deactivate(),s&&s.pause()},this.pauseExecute=function(){var e=t.giveDataLauncherController({context:a});e&&e.setActiveState(!1);var n=o.getCommand("CAT3DComposeExamineSelectionHdr",r);n&&n.deactivate(),s&&s.pause()},this.resumeExecute=function(){var e=t.giveDataLauncherController({context:a});e&&e.setActiveState(!0);var n=o.getCommand("CAT3DComposeExamineSelectionHdr",r);n&&n.activate(),s&&s.resume()}}})}),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove",["UWA/Core","UWA/Class","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/Manipulators/ScreenPlaneManipulator","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/SceneGraphNodes/AxisSystemNode","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DUtils/CATW3DUtils","DS/CATW3DAnims/CATW3DAnimation3D","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CAT3DComposeUI/CAT3DComposeWidgetOptions","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/Visualization/IdPath","DS/CoreEvents/ModelEvents","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/ApplicationFrame/CommandsManager","css!DS/CAT3DComposeUI/CAT3DComposeUI.css"],function(e,t,n,i,o,a,r,s,l,c,u,d,m,p,g,h,v,f,C,E,S,A,D,y){"use strict";var x,T=t.extend({init:function(){var t,x,T=!1,b=null,P=null,M=null,I=this,R={},w=[],N="",L=!0,_=null,F=null,O={},W=3394815,U=!1,V={},k=[],G=null,B=null,X=null,H=null,Y=null,j=null,q=null,z=!g.getOption("animationOff"),K=!1,J={},Z=!1,Q=null,$=!1,ee=null,te=null,ne=new E,ie=function(){var e=t.getRootBagPath();return e?e.getLastElement(!0):null},oe=function(e){return t.getRootBagPath().isAParentOf(e)},ae=new s("LocalAxisSystemNode");ae.exludeFromBounding(!0),ae.setVisibilityInTree(!1),ae.setPickable(l.PICKTHROUGH),ae.setVisibility(!1),ae.setVisibilityFree(!0),ae.updateDisplay=function(e){0===ae.parents.length&&M.addNode(ae),e.visibility&&e.pathElement&&ae.pathElement!==e.pathElement&&(ae.pathElement=e.pathElement,ae.setMatrix(e.pathElement.getWorldMatrix()),ae.setVisibility(!0)),e.visibility||(ae.pathElement=null,ae.setVisibility(!1))};var re=new s("MovePrevisuNode");re.exludeFromBounding(!0),re.setVisibilityFree(!0),re.setVisibilityInTree(!1),re.setPickable(l.PICKTHROUGH),re.setNoZ(!0),re.updateDisplay=function(e,t,n){0===re.parents.length&&M.addNode(re),re.removeChildren(),e&&e.equivalentGeometry&&e.equivalentGeometry.getPrevisuNode&&re.addChild(e.equivalentGeometry.getPrevisuNode(t,n))};var se=function(e){if(e.color){var t=new r.MeshBasicMaterial({side:2,forceSide:!0,color:e.color,transparent:!0,depthWrite:!1,depthTest:!1,opacity:.6,overridable:!1});A.applyMaterialToPath(e.path,t)}else A.applyMaterialToPath(e.path,null)},le=function(e){e.objectToMove.override.setColor("#FFFFFF",!1);var t=function(t){e.objectToMove&&q&&!Z&&t&&M.render()},n=b.isPathLocked({pathElement:e.objectToMove.path,onCompleted:function(e){J.isRunning()||t(e.isLocked)}});0===n.returnCode&&n.hasOwnProperty("isLocked")&&(t(n.isLocked),t=function(){})};function ce(){q&&M.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(q),q=null,G=null,T=!1,R={},U=!1,V={},F=null,O={},N="",k=[],w.forEach(function(e){e.lockedID&&t.getController().unlockNodes({ids:[e.lockedID]})}),w=[],Z=!1,z&&(K=!1,$=!1)}var ue,de=function(){if(q&&M.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(q),q=null,U)k.forEach(function(e){e.path&&n.add({pathElement:e.path})}),b.onMoveEnd({from:I,status:N}),"Moved"===N&&i.get().some(function(e){if(e.pathElement.isEqual(R.pathElement))return e.position=R.beginPosLocal.clone().applyMatrix4(R.pathElement.getWorldMatrix()),!0}),_&&(_.simulateReverseDirection(R.pathElement)||_.getAxisTypeIfCstOnProductAxis(R.pathElement))&&t.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:!0});else if(R.pathElement&&!V.partIsInCSO){var e=R.pathElement;i.add({pathElement:e,event:R.beginEvent,position:R.beginPosLocal.clone().applyMatrix4(e.getWorldMatrix())}),t.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:!0})}ce(),ne.publish({event:"onDirectMoveEnd"})},me={panInterval:void 0,viewpoint:void 0,panDuration:100,x:void 0,y:void 0},pe=function(){me.panInterval&&clearInterval(me.panInterval),me.panInterval=void 0,me.viewpoint=void 0,me.x=void 0,me.y=void 0,me.div=me.div?me.div.destroy():void 0,me.divL=me.divT=me.divR=me.divB=void 0},ge=function(n){function i(){if(me.viewpoint||(me.viewpoint=M.currentViewpoint),me.viewpoint&&me.viewpoint.control&&void 0!==me.x&&void 0!==me.y){var n,i,o=new r.Vector3(me.x,me.y,0);if(o.applyQuaternion(me.viewpoint.control.orientation),o.setLength(.05*me.viewpoint.control.distanceToTarget),n=me.viewpoint.target.clone().add(o),i=me.viewpoint.control.distanceToTarget,me.viewpoint.moveTo({eyePosition:n.add(me.viewpoint.getCamera().getLookAt().normalize().multiplyScalar(-i)),duration:z?me.panDuration:0}),!me.div){var a=t.getFrameWindow().getUIFrame();me.div=e.createElement("div",{id:"C3D-viewpoint",styles:{top:M.SCREEN_HEIGHT/2+"px",left:M.SCREEN_WIDTH/2+"px"}}).inject(a);var s=function(t){var n=e.createElement("div",{class:t.side}).inject(me.div);n.setStyle(t.posKey,t.posValue+"px");var i=e.createElement("div",{class:"arrow"}).inject(n);return e.createElement("div",{class:"borderBottom"}).inject(i),e.createElement("div",{class:"borderRight"}).inject(i),n},l=Math.min(M.SCREEN_WIDTH/10,M.SCREEN_HEIGHT/10);me.divL=s({side:"left",posKey:"left",posValue:-l}),me.divT=s({side:"top",posKey:"top",posValue:-l}),me.divR=s({side:"right",posKey:"left",posValue:l}),me.divB=s({side:"bottom",posKey:"top",posValue:l})}me.x<0?me.divL.addClassName("active"):me.divL.removeClassName("active"),me.x>0?me.divR.addClassName("active"):me.divR.removeClassName("active"),me.y<0?me.divB.addClassName("active"):me.divB.removeClassName("active"),me.y>0?me.divT.addClassName("active"):me.divT.removeClassName("active")}}var o=(n.event.gesture?n.event.gesture.getEvents()[0]:n.event.from[0]).getCurrentPosition(t.getViewer().canvas);return me.x=o.x<=9?-1:o.x>=M.SCREEN_WIDTH-10-1?1:0,me.y=o.y<=9?1:o.y>=M.SCREEN_HEIGHT-10-1?-1:0,0===me.x&&me.y?me.x=o.x<M.SCREEN_WIDTH/3?-1:o.x>2*M.SCREEN_WIDTH/3?1:0:0===me.y&&me.x&&(me.y=o.y<M.SCREEN_HEIGHT/3?1:o.y>2*M.SCREEN_HEIGHT/3?-1:0),me.x||me.y?(clearInterval(me.panInterval),me.panInterval=setInterval(function(){i()},me.panDuration),i(),1):(pe(),0)};function he(e){if(x&&x.cancel&&x.cancel(),x=null,pe(),e&&!L?(L=!1,N="Moved"):N="Cancelled",ae&&ae.updateDisplay({visibility:!1}),U)if(z){if(Q&&(clearTimeout(Q),Q=null),J.forward(),J.addAnimation({animationType:"opacityOff",objectListToAnimate:w,callBackFct:function(){w.forEach(function(e){e.override.setColor(null,!1)}),R.equivalentGeometry&&se({path:R.pathElement})}}),"Cancelled"===N){var o=M.getSceneGraphOverrideSetManager();w.forEach(function(e){e.currentMatrix=o.computeAppliedPosition(e.path)}),J.addAnimation({animationType:"cancel",objectListToAnimate:w,callBackFct:function(){de()}})}else Z?de():K?$=!0:($=!0,J.addAnimation({animationType:"snap",objectListToAnimate:w,callBackFct:function(){Z=!0,Q=!1,$&&de()}}));J.startAnimation()}else de();else k.forEach(function(o){if(o.path)if(o.path.isEqual(R.pathElement))if(V.partIsInCSO)if(T)i.remove({pathElement:R.pathElement,event:e.event}),n.remove({pathElement:R.pathElement});else{var a=R.pathElement;i.remove({pathElement:a}),i.add({pathElement:a,event:R.beginEvent,position:R.beginPosLocal.clone().applyMatrix4(a.getWorldMatrix())}),t.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:!0})}else n.add({pathElement:R.pathElement});else o.path.isAParentOf(R.pathElement)&&T&&V.partIsInCSO&&(i.remove({pathElement:R.pathElement,event:e.event}),n.remove({pathElement:R.pathElement}))}),de();M.render()}function ve(){pe(),ee&&(b.unsubscribe(ee),ee=null),te&&(b.unsubscribe(te),te=null),B&&(B.unsubscribe(H),B.unsubscribe(Y),B.unsubscribe(j),B.unlink(X),B=H=Y=j=X=null),ae&&ae.removeChildren(),re&&re.removeChildren()}this.activate=function(e){t=e.context,ue=!0,function(e,s){if(ue&&!B){var l=t.getFrameWindow();if(b=f.giveMoveManager({context:t}),P=v.getMoveReferentManager({context:t}),_||(_=u.getConstraintsController({context:t})),ee=b?b.subscribe("onValidateMove",function(){_&&_.deleteAllCst()}):null,te=b?b.subscribe("onCancelMove",function(e){_&&e.objectsCancelled.some(function(e){return _.isLevelConstrained(e.path)})&&_.deleteAllCst()}):null,l)if(b)if(P){if(M=l.getViewer(),J=m.getAnimation3DEngine({viewer:M}),(B=new a).setDynamic(!0),B.setPrePickingDuringManipulation(!0),B.setPreActivationDuringManipulation(!0),B.setPickingDuringManipulation(!0),B.setExclusive(!0),X=B.linkToNode(ie()),B.HandleLongHold=function(){return ce(),!0},H=B.subscribe("BeginManipulate",function(e){if(!J.isRunning()){var a,l=t.getController(),c=l.getRootBagId();if(q=new S(l.getRootBag(),c),M.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(q),M.setCursor("pointer"),T=e.event.gesture.events[0].event.ctrlKey,R={},s&&s.isActive())a=M.pick(M.getMousePosition(e.event.from[0].currentPosition),"primHybrid",!1),(R=s.filterPath({pathElement:a.path[0]})).pathReferent=P.getMoveReferent(a.path[0]);else{var u=p.giveSelectionManager({context:t});u&&((a=M.pick(M.getMousePosition(e.event.from[0].currentPosition),u.getPicking()?"mesh":"primHybrid",!1)).path[0]=u.getTruncatedPath(a.path[0]),R.pathElement=a.path[0],R.pathReferent=P.getMoveReferent(a.path[0]),R.equivalentGeometry=o.getEquivalentGeometry({pathElement:a.path[0],viewer:M,nonCanonicGeometry:!0}))}R.pathElement&&(R.beginEvent=e.event,R.beginPosLocal=e.position.clone().applyMatrix4((new r.Matrix4).getInverse(R.pathElement.getWorldMatrix())),k.push({path:R.pathElement}),e&&e.event&&e.event.from&&e.event.from&&e.event.from.length&&"Touch"!==e.event.from[0].type&&i.get().slice(0).forEach(function(t){t.pathElement&&(t.pathElement.isEqual(R.pathElement)?V.partIsInCSO=!0:T?(t.pathElement.isAParentOf(R.pathElement)&&(V.fatherIsInCSO=!0),k.push({path:t.pathElement})):(i.remove({pathElement:t.pathElement,event:e.event}),n.remove({pathElement:t.pathElement})))}),k.forEach(function(e){if(e.path){var n,i=w.slice(0).some(function(t){if(t.path&&(!t.path.isEqual(e.path)&&t.path.isAParentOf(e.path)||!oe(e.path)))return!0});if(!v.getPreferencesDefinition()[0].preferences[0].getValue()){var o=y.getCommand("CAT3DComposeMoveHdr",t.getCommandContext());o&&!o.isRunning()&&(i=!0)}if(i||!(n=P.getMoveReferent(e.path)))return;for(var a,r=n.externalPath.map(function(e){return h.getNodeID(e)}).filter(function(e){return e}),s=e.path.externalPath.length-1;s>0;--s)if(h.isRepReference(e.path.externalPath[s])){a=h.getNodeID(e.path.externalPath[s]);break}a&&l.lockNodes({ids:[a]}),r.unshift(c),w.push({path:n,lockedID:a,override:q.createIdPathOverride({idPathes:[new C(r)]}),initWorldMatrix:n.getWorldMatrix(),initMatrix:n.getLastElement(!0).getMatrix(),selectionWorldMatrix:R.pathElement.getWorldMatrix(),isAxisSystem:R.pathElement.externalPath.some(function(e){return"AxisSystems"===e.name})})}}))}}),Y=B.subscribe("Manipulate",function a(l,c){if(x&&x.cancel&&x.cancel(),x=null,!J.isRunning()&&(M.setCursor("pointer"),!l.event.from[0].currentPosition.equals(l.event.from[0].lastPosition)&&w.length)){var u=e?l.intersection.path[0]:null;if(!U){if(l&&l.event&&l.event.from&&l.event.from&&l.event.from.length&&"Touch"===l.event.from[0].type&&i.get().slice(0).forEach(function(e){e.pathElement&&(e.pathElement.isEqual(R.pathElement)?V.partIsInCSO=!0:T?(e.pathElement.isAParentOf(R.pathElement)&&(V.fatherIsInCSO=!0),k.push({path:e.pathElement})):(i.remove({pathElement:e.pathElement,event:l.event}),n.remove({pathElement:e.pathElement})))}),ne.publish({event:"onDirectMoveBegin"}),!V.partIsInCSO){var m=R.pathElement;i.add({pathElement:m,event:R.beginEvent,position:R.beginPosLocal.clone().applyMatrix4(m.getWorldMatrix())})}k.forEach(function(e){e.path&&n.remove({pathElement:e.path})}),b.onMoveBegin({objectsMoved:w,from:I,moveMode:"Transient"}),w.forEach(function(e){e.path&&e.override.setPickability("IGNORED")}),M.render(),R.equivalentGeometry||(R.equivalentGeometry=o.getEquivalentGeometry({pathElement:R.pathReferent,axis:_.getProductAxisForConstraint(),viewer:M})),z?(J.addAnimation({animationType:"opacityOn",objectListToAnimate:w,callBackFct:function(){R.equivalentGeometry&&R.equivalentGeometry.getMode()===D.GeometryMode.REAL&&se({path:R.pathElement,color:W}),w.forEach(function(e){e.path&&le({objectToMove:e})})}}),J.startAnimation()):(R.equivalentGeometry&&R.equivalentGeometry.getMode()===D.GeometryMode.REAL&&se({path:R.pathElement,color:W}),w.forEach(function(e){e.path&&(e.override.setOpacity(.35,!1),le({objectToMove:e}))})),_&&(_.count()>0&&!R.equivalentGeometry||_.count()>0&&!_.isLevelConstrained(R.pathReferent))&&_.deleteAllCst(),U=!0}if(!ge({event:l.event})){var p=e?M.pick(M.getMousePosition(l.event.from[0].currentPosition),"primHybrid",!1):{path:[]};p.path[0]&&!h.isAModelPath(p.path[0])&&(p.path[0]=null);var g={pathElement:p.path[0]};!(x=d.switchToAV1withMesh({pathElement:g.pathElement,pad3DViewer:t,selectionFilter:s?s.getFiltersState():null,onComplete:function(){a(l,!0),x=null},onFailure:function(){x=null}}))||"filtered"!==x.status&&"done"!==x.status||(x=null),s&&s.filterPath(g);var v=!1;g.pathElement&&O.pathElement&&(v=O.pathElement.isEqual(g.pathElement)),O=g,F&&!v&&(_.deleteLastCst(),F=null);var f={},C=null,E=null;if(g.pathElement&&u&&!R.pathReferent.isAParentOf(u)){var S=R.equivalentGeometry&&R.equivalentGeometry.getType(),A=g.equivalentGeometry&&g.equivalentGeometry.getType();if(C=S&&S!==D.GeometryType.AXISSYSTEM&&S!==D.GeometryType.SURFACE,E=A&&A!==D.GeometryType.AXISSYSTEM&&A!==D.GeometryType.SURFACE,g.pathElement&&!R.pathReferent.isAParentOf(g.pathElement)&&E&&C){if(!v){F=_.createCst({movable:R,fixed:g});var y=_.simulateSolveCst();if(y){var P=y.matrix;f.rc=y.rc,f.redundancy=y.redundancy,0===f.rc&&P&&!f.redundancy?f.matrix=P.multiply(R.pathReferent.getWorldMatrix()):(0!==f.rc||f.redundancy)&&(_.deleteLastCst(),F=null),O=g}else O={}}}else g&&g.pathElement&&(f.matrix=g.pathElement.getWorldMatrix(),g.pathElement.externalPath.some(function(e){return"AxisSystems"===e.name})?(f.isAxisSystem=!0,ae.updateDisplay({visibility:!1})):ae.updateDisplay({pathElement:g.pathElement,visibility:!0}))}if(f.matrix){var N;if(f.isAxisSystem&&w[0].isAxisSystem){var X=(new r.Matrix4).copy(f.matrix);X.multiply((new r.Matrix4).getInverse(w[0].selectionWorldMatrix)),X.multiply(w[0].initWorldMatrix),N=(new r.Matrix4).getInverse(w[0].initWorldMatrix).multiply(X)}else(N=(new r.Matrix4).getInverse(w[0].initWorldMatrix).multiply(f.matrix)).multiply((new r.Matrix4).getInverse(R.pathElement.getLastElement(!0).getMatrix()));w.forEach(function(e,t){var n=(new r.Matrix4).copy(e.initWorldMatrix).multiply(N);if(e.path){var i=(new r.Matrix4).getInverse(e.path.getParentPath().getWorldMatrix()),o=(new r.Matrix4).copy(i).multiply(n),a=null;e.snappedPosition&&(a=(new r.Matrix4).copy(e.snappedPosition));var s=a&&a.equals(o);if(e.snappedPosition=(new r.Matrix4).copy(o),z){var u=(new r.Matrix4).copy(e.initWorldMatrix),d=(new r.Vector3).getPositionFromMatrix(e.initWorldMatrix).add(l.translationVector);u.setPosition(d);var m=(new r.Matrix4).copy(i).multiply(u);Z?s||(e.currentPosition=o):(e.currentPosition=(new r.Matrix4).copy(m),(_&&_.count()<=1&&E&&C||!E&&!C||E&&!C)&&e.override.setPosition(m)),0===t&&(e.snappedTarget=g.pathElement,s||!g.pathElement||e.snappedTarget.isEqual(g.pathElement)||(clearTimeout(Q),Q=null),Q||s&&Z||x||(Q=setTimeout(function(){J.addAnimation({animationType:"snap",objectListToAnimate:w,callBackFct:function(){Z=!0,Q=null,$&&de()}}),J.addAnimation({animationType:"opacityOff",offsetTime:J.getDefaultDuration("snap"),objectListToAnimate:w,callBackFct:function(){w.forEach(function(e){e.override.setColor(null,!1)}),R.equivalentGeometry&&se({path:R.pathElement})}}),J.startAnimation()},c?0:500)))}else e.override.setPosition(o),Z=!0}}),L=!1,b.onMove({objectsMoved:w,transformation:N,from:I})}else if(ae&&ae.updateDisplay({visibility:!1}),void 0===g.pathElement||null===g.pathElement||f.rc&&0!==f.rc||f.redundancy?(L=!0,b.onMove({objectsMoved:w,vector:l.translationVector,from:I})):E&&C&&0===f.rc&&(L=!1),void 0!==g.pathElement||null!==g.pathElement){var H=null;w.forEach(function(e,t){if(e.path){var n=null;if(0===_.count()||1===_.count()&&F){var i=(new r.Matrix4).copy(e.initWorldMatrix),o=(new r.Vector3).getPositionFromMatrix(e.initWorldMatrix).add(l.translationVector);i.setPosition(o);var a=e.path.getParentPath().getWorldMatrix();n=(new r.Matrix4).getInverse(a).multiply(i),Z||e.override.setPosition(n),e.currentPosition=(new r.Matrix4).copy(n)}else{if(0===t){H=null,F&&_.deleteLastCst();var s=(new r.Vector3).addVectors(l.translationVector,B.initial3dIntersectionPoint),c=null;c=G?(new r.Vector3).subVectors(l.translationVector,G):l.translationVector,G=l.translationVector;var u=_.simulateMoveWithCst({movableReference:s,translation:c});u&&0===u.rc&&u.matrix&&(H=u.matrix.multiply(R.pathReferent.getWorldMatrix())),F&&_.restoreLastDeletedCst()}if(H){var d=(new r.Matrix4).getInverse(w[0].initWorldMatrix).multiply(H),m=(new r.Matrix4).copy(e.initWorldMatrix).multiply(d),p=(new r.Matrix4).getInverse(e.path.getParentPath().getWorldMatrix());n=(new r.Matrix4).copy(p).multiply(m),Z||e.override.setPosition(n)}e.currentPosition=(new r.Matrix4).copy(e.initMatrix)}}}),z?v||(Q&&(clearTimeout(Q),Q=null),Z&&L&&(J.addAnimation({animationType:"unsnap",objectListToAnimate:w,callBackFct:function(){Z=!1,w.forEach(function(e){e.snappedPosition=null})}}),J.addAnimation({animationType:"opacityOn",objectListToAnimate:w,offsetTime:J.getDefaultDuration("unsnap"),callBackFct:function(){R.equivalentGeometry&&se({path:R.pathElement,color:W}),w.forEach(function(e){e.path&&le({objectToMove:e})})}}),J.startAnimation())):Z&&L&&(w.forEach(function(e){e.path&&e.currentPosition&&e.override.setPosition(e.currentPosition)}),Z=!1)}re.updateDisplay(g,l.intersection.position,l.intersection.normal),M.render()}}}),j=B.subscribe("EndManipulate",he),0===ae.getChildren().length){var g=new c({headLength:10,arrowLength:50,arrowWidth:2,head:c.types.ARROW});ae.addChild(g)}ae.updateDisplay({visibility:!1}),M.render({updateInfinitePlane:!0})}else window.console.log("A move referent component must be defined");else window.console.log("A move manager component must be defined");else window.console.log("A frame window must be defined")}}(e.withSnap,e.selectionFilter)},this.deactivate=function(){ve(),ue=!1},this.unreference=function(){ve(),_&&(_.deleteAllCst(),_.unreference()),ae&&M.removeNode(ae),ae=null,re&&M.removeNode(re),re=null,t=null,ne=null,ue=!1},this.subscribe=function(e,t){return"onDirectMoveBegin"===e||"onDirectMoveEnd"===e?ne.subscribe({event:e},t):void 0},this.unsubscribe=function(e){return ne.unsubscribe(e)}}});return t.singleton({init:function(){},activate:function(e){e&&e.context&&"ENOPAD3DViewer"===e.context.name&&(x||(x=new T),x.activate(e))},deactivate:function(e){e&&e.context&&"ENOPAD3DViewer"===e.context.name&&x&&x.deactivate()},unreference:function(e){e&&e.context&&"ENOPAD3DViewer"===e.context.name&&(x&&x.unreference(),x=null)},subscribe:function(e,t){return x?x.subscribe(e,t):null},unsubscribe:function(e){return x?x.unsubscribe(e):null}})}),define("DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter",["UWA/Class","DS/Visualization/PathElement","DS/Selection/PSOManager","DS/WebappsUtils/WebappsUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CAT3DComposeCommands/CATC3DAxisSystemDisplayAgent","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/CATW3DUtils/CATW3DUtils"],function(e,t,n,i,o,a,r,s,l){"use strict";var c={};require(["i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],function(e){c.point=e.point,c.center=e.center,c.axisSystem=e.axisSystem,c.line=e.line,c.plane=e.plane,c.cylinder=e.cylinder,c.surface=e.surface,c.product=e.product});var u,d,m=i.getWebappsAssetUrl("DMUMeasure","icons/32/"),p=i.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/"),g=function(e){u?e():d||(d=!0,require(["DS/Web3DUXFilterBar/Web3DUXFilterBar"],function(t){d=!1,u=t,e()}))},h=e.extend({init:function(e){var i,d,h,v,f,C,E,S,A=e.context,D=!0,y=A.getViewer(),x={none:0,point:0,center:0,axisSystem:1,line:0,plane:1,cylinder:1,surface:0,product:1},T=localStorage.getItem("C3DSelectionFilter"),b=new a({context:A}),P=function(){x={none:1,point:0,center:0,axisSystem:0,line:0,plane:0,cylinder:0,surface:0,product:0},f.getActiveState("point")&&(x.none=0,x.point=1),f.getActiveState("center")&&(x.none=0,x.center=1),f.getActiveState("axisSystem")&&(x.none=0,x.axisSystem=1),f.getActiveState("line")&&(x.none=0,x.line=1),f.getActiveState("plane")&&(x.none=0,x.plane=1),f.getActiveState("cylinder")&&(x.none=0,x.cylinder=1),f.getActiveState("surface")&&(x.none=0,x.surface=1),f.getActiveState("product")&&(x.none=0,x.product=1);var e="1-"+x.point+x.center+x.axisSystem+x.line+x.plane+x.cylinder+x.surface+x.product+"-"+(D?1:0);localStorage.setItem("C3DSelectionFilter",e),x.axisSystem?b.activate():b.deactivate()},M=function(){var e;function t(t){if(!t)return e=!1,void(f&&f.setVisibleFlag(!1));e=!0,D?f?f.setVisibleFlag(!0):g(function(){(f=new u({body:A.getFrameWindow().getUIFrame(),frmWindow:A.getFrameWindow(),Idpanel:"c3dSelectionFilter",classpanel:"c3dSelectionFilter",typeSeparator:"bubble",lJsonElement:[{type:"element",id:"point",nls:c.point,url:m+"I_Meas_Point.png",callback:P,bexclude:!1,bstateActif:x.point},{type:"element",id:"center",nls:c.center,url:m+"I_Meas_PointCircle.png",callback:P,bexclude:!1,bstateActif:x.center},{type:"element",id:"axisSystem",nls:c.axisSystem,url:p+"I_3DComposeAxisSystem.png",callback:P,bexclude:!1,bstateActif:x.axisSystem},{type:"element",id:"line",nls:c.line,url:m+"I_Meas_Line.png",callback:P,bexclude:!1,bstateActif:x.line},{type:"element",id:"plane",nls:c.plane,url:m+"I_Meas_Plane.png",callback:P,bexclude:!1,bstateActif:x.plane},{type:"element",id:"cylinder",nls:c.cylinder,url:m+"I_Meas_Cylinder.png",callback:P,bexclude:!1,bstateActif:x.cylinder},{type:"element",id:"surface",nls:c.surface,url:m+"I_Meas_Surface.png",callback:P,bexclude:!1,bstateActif:x.surface},{type:"element",id:"product",nls:c.product,url:m+"I_Meas_Product.png",callback:P,bexclude:!1,bstateActif:x.product}]})).build();var t=document.querySelector(".c3dSelectionFilter");t&&(t.style.position="absolute"),f.setVisibleFlag(!1),e&&D&&f.setVisibleFlag(!0)}):f&&f.setVisibleFlag(!1)}return function(){t(!!C&&(A&&o.getRoots(A).length>0))}}();if(T&&T.length>8){var I=2,R=parseInt(T.split("-")[0]);x.point="1"===T.charAt(I++)?1:0,x.center="1"===T.charAt(I++)?1:0,x.axisSystem="1"===T.charAt(I++)?1:0,x.line="1"===T.charAt(I++)?1:0,x.plane="1"===T.charAt(I++)?1:0,x.cylinder="1"===T.charAt(I++)?1:0,R&&(x.surface="1"===T.charAt(I++)?1:0),x.product="1"===T.charAt(I++)?1:0,x.point||x.center||x.axisSystem||x.line||x.plane||x.cylinder||x.surface||x.product||(x.none=1),T.length>I&&"-"===T.charAt(I++)&&(D="1"===T.charAt(I))}function w(e){var n=e.pathElement;return e.pathElement=new t,n.externalPath.some(function(t){return e.pathElement.addElement(t),t&&o.is3DLeaf(t)}),n.internalPath.length>0&&(e.originalPathElement=n),e}function N(e){if(!(e&&e.pathElement&&e.pathElement.externalPath.length&&o.isAModelPath(e.pathElement)))return e;if(!C||x.none)return w(e);if(x.axisSystem||x.point||x.center||x.line||x.plane||x.cylinder||x.surface){var t=r.getEquivalentGeometry({pathElement:e.pathElement,viewer:y,nonCanonicGeometry:Boolean(x.surface)}),n=t?t.getType():null;if(x.axisSystem&&n===s.GeometryType.AXISSYSTEM)return e.originalPathElement=e.pathElement,e.pathElement=t.getPathElement(),e.equivalentGeometry=t,e;if(x.point&&n===s.GeometryType.POINT||x.center&&(n===s.GeometryType.CIRCLE||n===s.GeometryType.SPHERE)||x.line&&n===s.GeometryType.LINE||x.plane&&(n===s.GeometryType.PLANE||n===s.GeometryType.REFPLANE)||x.cylinder&&(n===s.GeometryType.CYLINDER||n===s.GeometryType.CONE)||x.surface&&n===s.GeometryType.SURFACE)return e.equivalentGeometry=t,e;if(x.surface&&(n===s.GeometryType.PLANE||n===s.GeometryType.CYLINDER||n===s.GeometryType.CONE||n===s.GeometryType.SPHERE)&&(n=(t=r.getEquivalentGeometry({pathElement:e.pathElement,viewer:y,canonicGeometry:!1,nonCanonicGeometry:!0}))?t.getType():null)===s.GeometryType.SURFACE)return e.equivalentGeometry=t,e}if(x.surface){for(var i,a=e.pathElement.externalPath.length-1;a>=0&&!i;a--)o.isRepReference(e.pathElement.externalPath[a])&&(i=e.pathElement.externalPath[a]);if(i&&!A.getController().hasMeshInRAM(o.getNodeID(i)))return w(e)}return x.product?w(e):(e.originalPathElement=e.pathElement,e.pathElement=null,e)}function L(e){Array.isArray(e)?e.forEach(N):N(e)}function _(){return{point:x.point,center:x.center,line:x.line,axisSystem:x.axisSystem,plane:x.plane,cylinder:x.cylinder,surface:x.surface,product:x.product}}function F(e){d&&d.cancel&&d.cancel(),d=null,e&&e.pickingResult&&e.pickingResult.path&&e.pickingResult.path.length&&(d=l.switchToAV1withMesh({pathElement:e.pickingResult.path[0],pad3DViewer:A,selectionFilter:_(),onComplete:function(){d=null},onFailure:function(){d=null}}))}function O(){if(C){var e=A.getViewer();e.setPicking(v),e.setPrePicking({primitive:h}),i&&e.unsubscribe(i),i=null,n.unsubscribe(C),A.unsubscribe(E),A.unsubscribe(S),C=E=S=null,M(),b.deactivate()}}this.filter={activate:function(e){if(!C){var t=A.getViewer();v={primitive:t.picking.primitive,trapSelection:t.picking.trapSelection,trapPrimitive:t.picking.trapPrimitive,trapGPU:t.picking.trapGPU},h=t.pPicking.primitive,t.setPicking({primitive:1,trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),t.setPrePicking({primitive:1}),e&&e.switchToAV1withMesh&&(i=t.onPreactivate(F)),C=n.onPreAdd(L),E=A.subscribe({event:"onRootAdded"},M),S=A.subscribe({event:"onRootRemoved"},M),M(),x.axisSystem&&b.activate()}},deactivate:O,isActive:function(){return Boolean(C)},display:function(e){"boolean"==typeof e&&e!==D&&(D=e,M())},filterPath:N,switchToAV1withMesh:F,getFiltersState:_},Object.freeze(this.filter),this.unreference=function(){O(),f&&f.clear(),b=f=A=null}}}),v=[];return e.singleton({init:function(){},giveDefaultSelectionFilter:function(e){var t;return e&&e.context&&"ENOPAD3DViewer"===e.context.name&&v.some(function(n){return n.context===e.context&&(t=n.mng.filter,!0)}),t},getDefaultSelectionFilter:function(e){var t;if(e&&e.context&&"ENOPAD3DViewer"===e.context.name&&(v.some(function(n){return n.context===e.context&&(t=n.mng.filter,!0)}),!t)){var n=new h({context:e.context});v.push({context:e.context,mng:n}),t=n.filter}return t},unreferenceDefaultSelectionFilter:function(e){e&&e.context&&v.some(function(t,n){return t.context===e.context&&(t.mng.unreference(),v.splice(n,1),!0)})}})}),define("DS/CAT3DComposeCommands/CAT3DComposeMoveCmd",["DS/ApplicationFrame/Command","DS/Visualization/SceneGraphUtils","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATW3DAnims/CATW3DAnimation3D","DS/CATW3DBoxes/CATW3DBoxController","DS/ApplicationFrame/CommandsManager","DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent","DS/PADUtils/PADContext","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATW3DCommands/CATW3DCmdsUtils","DS/CATW3DCommands/CATW3DMoveBarUX"],function(e,t,n,i,o,a,r,s,l,c,u,d){"use strict";var m,p,g,h,v,f;return require(["i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],function(e){m=e.PositionModifiedSaveOK,p=e.PositionModifiedSaveKO,g=e.singleSplitInstance,h=e.multipleSplitInstance}),require(["DS/Selection/CSOManager"],function(e){v=e}),e.extend({init:function(C){this._parent(C,{mode:"exclusive",isAsynchronous:!0}),this.setRepeatMode(!1);var E,S,A,D=this,y=!0,x=!1,T=l.get(),b=T.getCommandContext(),P=c.giveMoveManager({context:T}),M=new s({context:T}),I=i.getDefaultSelectionFilter({context:T}),R=function(){x=!0,y=!1,P.terminateMove({save:!1}),D.end()},w=function(){x=!0,y=!1,P.terminateMove({save:!0}),D.end()},N=function(){P.cancelLocked()},L=!1,_=new e({ID:"CAT3DComposeFakeMoveHdr",mode:"shared",isAsynchronous:!1,context:b}),F=P.subscribe("MoveBegin",function(){if(D.isRunning()){r.getCommand("CAT3DComposeExamineSelectionHdr",b).deactivate();var e=n.give3DGridController({context:T});e&&e.hide3DGrids()}}),O=P.subscribe("Move",function(e){e.objectsMoved.length>0&&"Persistent"===e.moveMode&&e.objectsMoved.forEach(function(e){var t=e.path.getLastElement(!0);u.isPLMInstanceNode(t)&&(D._isRunning||(L=!0,D.begin()),E.showSpinner(),P.isPathLocked({pathElement:e.path,onCompleted:function(e){E&&(E.hideSpinner(),e.isLocked?E.showLock():E.showSave())}}))})}),W=P.subscribe("MoveEnd",function(){if(D.isRunning()){var e=a.getBoxController({context:T});e&&e.setActiveState(!0),r.getCommand("CAT3DComposeExamineSelectionHdr",b).activate();var t=n.give3DGridController({context:T});t&&t.display3DGrids()}L=!1}),U=function(e){var n="success"===e.eventID&&e.objectsMoved.length>0?m:"error"===e.eventID&&e.objectsCancelled.length>0?p:null;n&&T.displayNotification({eventID:e.eventID,msg:n});var i=o.getAnimation3DEngine({viewer:T.getViewer()});if(e&&e.splitInstances&&e.splitInstances.length){T.displayNotification({eventID:"info",msg:e.splitInstances.length>1?h:g});var a=[],r=T.getController(),s=T.getRootBagPath().getLastElement(!0);if(e.splitInstances.forEach(function(e){a=a.concat(t.buildPathesLeadingToNode(r.getNode({id:e.newId}),s).map(function(e){return{path:e}}))}),i.addAnimation({animationType:"opacityOnOff",objectListToAnimate:a,duration:1e3,createOverrideSet:!0}),i.addAnimation({animationType:"color",objectListToAnimate:a,duration:1e3,createOverrideSet:!0,color:"#ff821e"}),v){var l=v.get();l.length&&v.empty(),a.length&&v.add(a.map(function(e){return{pathElement:e.path}})),l.length&&v.empty(),v.add(l)}}e.objectsCancelled&&e.objectsCancelled.length>0&&i.addAnimation({animationType:"cancel",objectListToAnimate:e.objectsCancelled,callBackFct:function(){setTimeout(function(){_.begin()},0)},createOverrideSet:!0}),i.startAnimation(),x&&(P.unsubscribe(S),P.unsubscribe(A))},V=function(e){if(E&&!0===e.bEmptyMove?(E.hideSave(),E.hideLock()):E&&!e.someMovedObjectsAreLocked&&E.hideLock(),e.objectsCancelled&&e.objectsCancelled.length>0){var t=o.getAnimation3DEngine({viewer:T.getViewer()}),n={animationType:"cancel",objectListToAnimate:e.objectsCancelled,callBackFct:function(){setTimeout(function(){_.begin()},0)},createOverrideSet:!0};t.addAnimation(n),t.startAnimation()}else T.getViewer().render();x&&(P.unsubscribe(S),P.unsubscribe(A))},k=function(e){"Enter"!==e.key&&13!==e.keyCode||!1===e.ctrlKey&&!1===e.altKey&&!1===e.shiftKey&&!1===e.metaKey&&(w(),document.removeEventListener("keydown",k))};f||require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],function(e){f=e,D.isRunning()&&f.activate({context:T,withSnap:!0,selectionFilter:I})}),this.beginExecute=function(){y=!0,x=!1,(E=new d({uiFrame:T.getFrameWindow().getUIFrame(),onSave:w,onCancel:R,onCancelLocked:N})).show(),M.activate();var e=a.getBoxController({context:T});e&&e.setActiveState(!L);var t=n.give3DGridController({context:T});(t&&t[L?"hide3DGrids":"display3DGrids"](),L)||r.getCommand("CAT3DComposeExamineSelectionHdr",b).activate();f&&f.activate({context:T,withSnap:!0,selectionFilter:I}),I.activate({switchToAV1withMesh:!0}),document.addEventListener("keydown",k),S=P.subscribe("onValidateMove",U),A=P.subscribe("onCancelMove",V)},this.endExecute=function(){document.removeEventListener("keydown",k),require(["DS/CAT3DComposeUtils/CATC3DUtils"],function(e){e._sendUsageProbe("command",y?"MoveCancel":"MoveOK")}),y&&(x=!0,P.terminateMove({save:!1})),E.destroy(),E=null,M.deactivate(),I&&I.deactivate();var e=a.getBoxController({context:T});e&&e.setActiveState(!1);var t=r.getCommand("CAT3DComposeExamineSelectionHdr",b);t&&t.deactivate(),T.getFrameWindow().getContextualUIManager().hideContextualMenus(),f&&f.deactivate({context:T})},this.pauseExecute=function(){var e=a.getBoxController({context:T});e&&e.setActiveState(!1),E.hide(),M.deactivate(),I.deactivate(),r.getCommand("CAT3DComposeExamineSelectionHdr",b).deactivate(),f&&f.deactivate({context:T}),document.removeEventListener("keydown",k)},this.resumeExecute=function(){var e=a.getBoxController({context:T});e&&e.setActiveState(!0),E.show(),M.activate(),I.activate({switchToAV1withMesh:!0}),r.getCommand("CAT3DComposeExamineSelectionHdr",b).activate(),f&&f.activate({context:T,withSnap:!0,selectionFilter:I}),document.addEventListener("keydown",k)},this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this._destroy=function(){Object.getPrototypeOf(this)._destroy.apply(this,arguments),P.unsubscribe(F),P.unsubscribe(O),P.unsubscribe(W),P.unsubscribe(S),P.unsubscribe(A),f&&f.unreference({context:T}),T=P=M=E=S=A=F=O=W=D=null}}})}),define("DS/CAT3DComposeCommands/CAT3DComposeExamineSelection",["UWA/Core","DS/ApplicationFrame/Command","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/CATW3DAnims/CATW3DAnimation3D","DS/PADUtils/PADContext","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/PathElement","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/LevelSelector/LevelSelector","DS/CATW3DCommands/CATW3DCmdsUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","css!DS/CAT3DComposeUI/CAT3DComposeUI.css"],function(e,t,n,i,o,a,r,s,l,c,u,d,m,p,g,h){"use strict";var v=Math.PI/4;function f(e){var t,n,i,o=e&&e.externalPath.length>1;for(t=0;o&&t<e.externalPath.length-1;++t)n=e.externalPath[t],i=e.externalPath[t+1],n.children.indexOf(i)<0&&(o=!1);return o}var C,E,S=function(){var e,t,n,i,o,r;this.store=function(s,l){e=t=n=i=o=r=void 0;var c=l?(new a.Matrix4).extractRotation(l):null;e=s.getEyePosition(),l&&e.applyMatrix4(l),t=s.getUpDirection(),c&&t.applyMatrix4(c),n=s.getSightDirection(),c&&n.applyMatrix4(c),i=s.getTargetDistance(),o=s.getProjectionType(),r=s.getAngle()},this.restore=function(s,l){if(e){var c=l?(new a.Matrix4).extractRotation(l):null;s.moveTo({eyePosition:l?e.applyMatrix4(l):e,upDirection:c?t.applyMatrix4(c):t,sightDirection:c?n.applyMatrix4(c):n,distanceToTarget:i}),s.setProjectionType(o),s.setAngle(r)}}};return S.prototype={constructor:S},Object.freeze(S),t.extend({init:function(t){this._parent(t,{mode:"shared",isAsynchronous:!0}),this.setRepeatMode(!1);var A,D,y,x,T,b,P,M,I,R,w,N,L,_,F,O,W,U,V,k=this,G=s.get(),B=G.getViewer(),X=G.getController(),H=B.getSceneGraphOverrideSetManager(),Y=d.giveMoveManager({context:G}),j=[],q=[],z=[],K={},J=u.getMoveReferentManager({context:G});function Z(){k.canBeEnabled()?k.isEnabled()||k.enable():k.isEnabled()&&!k.isRunning()&&k.disable()}function Q(){q.some(function(e){return"boolean"!=typeof H.getCurrentVisibility(e.path)})&&k.end()}function $(){A=null}function ee(e){if(e&&e.from&&e.from.some(function(e){return e.view.id===B.canvas.id})){var t=e.gesture?e.gesture.getEvents()[0]:e.from[0];if(t&&t.event&&0===t.event.button&&0===t.event.buttons){var n=B.pick(B.getMousePosition(t.getCurrentPosition(B.canvas)),"mesh",!1);n&&n.path&&0!==n.path.length||($(),k.end())}}}require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext"],function(e){W=e}),C||require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],function(e){if(C=e,k.isRunning()){var t=h.giveDefaultSelectionFilter({context:G});t&&C.activate({context:G,withSnap:!0,selectionFilter:t})}}),E||require(["DS/CATC3DNavigation/CATC3DNavigationContoller"],function(e){E=e}),this.canBeEnabled=function(){var e=i.get();return!!(k&&e&&Array.isArray(e))&&(e.length>50||e.some(function(e){if(!e||!e.pathElement||e.pathElement.externalPath.length<2||!g.isAModelPath(e.pathElement))return!1;var t=e.pathElement,n=H.getCurrentVisibilityFree(t);return"boolean"==typeof n&&((!0!==n||H.getCurrentVisibility(t))&&(!t.getBoundingBox(null,B,"visibleSpace").isNaN()||!t.getBoundingBox(null,B,"invisibleSpace").isNaN()))}))};var te,ne=function(){var e=G.getFrameWindow().getViewpoint(),t=new a.Matrix4,n=e.getUpDirection(),i=e.getSightDirection();this.className.search("right")>=0?t.makeRotationAxis(n,v):this.className.search("left")>=0?t.makeRotationAxis(n,-v):this.className.search("top")>=0?t.makeRotationAxis(i.cross(n),-v):t.makeRotationAxis(i.cross(n),v),q.forEach(function(e){e.matrixRotation=t}),y.addAnimation({animationType:"rotate",objectListToAnimate:q.filter(function(e){return e.rotate}),callBackFct:function(){q.forEach(function(e){e.matrixSource=e.override.getPosition()})}}),y.startAnimation()},ie=function(e,t,n,i){var o=[];if(e){var a=e.getKey();-1!==n.indexOf(a)||!0===i.getCurrentVisibilityFree(e)&&!i.getCurrentVisibility(e)||(t.some(function(t){return e.isAParentOf(t)})?e.getChildrenPathes().forEach(function(e){o=o.concat(ie(e,t,n,i))}):o.push(e))}return o},oe=(te=new a.Color,function(){return te.set(B.backgroundColor),255*te.getHSL().l>120?"black":"white"});function ae(){var e=60*Math.sqrt(2),t=G.getViewer(),n=t.SCREEN_WIDTH/2,i=t.SCREEN_HEIGHT/2;K.main.setStyles({top:i+"px",left:n+"px"}),K.right.setStyle("left",n-e-10+"px"),K.left.setStyle("left",-1*n+e+10+"px"),K.top.setStyle("top",-1*i+e+10+"px");var o="true"===G.getFrameWindow().getActionBar().elements.container.getAttribute("data-open")?73:30;K.bottom.setStyle("top",i-e-o+"px")}function re(e){var t;y.forward(),"ArrowLeft"===e.key||37===e.keyCode?t=K.left:"ArrowUp"===e.key||38===e.keyCode?t=K.top:"ArrowRight"===e.key||39===e.keyCode?t=K.right:"ArrowDown"!==e.key&&40!==e.keyCode||(t=K.bottom),t&&(t.addClassName("active"),ne.call(t))}function se(e){var t;"ArrowLeft"===e.key||37===e.keyCode?t=K.left:"ArrowUp"===e.key||38===e.keyCode?t=K.top:"ArrowRight"===e.key||39===e.keyCode?t=K.right:"ArrowDown"!==e.key&&40!==e.keyCode||(t=K.bottom),t&&t.removeClassName("active")}function le(){q.length&&(_||(_=new c(q[0].path.externalPath)),f(_)?(O=new S).store(G.getFrameWindow().getViewpoint(),(new a.Matrix4).getInverse(_.getWorldMatrix())):_=O=null)}function ce(e){k.deactivate();var t=h.giveDefaultSelectionFilter({context:G});t&&(C&&!e&&C.deactivate({context:G}),e||t.deactivate()),G.setRobotVisibility(D),W&&window.widget&&"true"===window.widget.getValue("changeControlActivation")&&W.show(),o.removeEvent(B.canvas,"onPrimaryPointerClick",ee),M&&(Y.unsubscribe(M),M=void 0),!e&&P&&(Y.unsubscribe(P),P=void 0),z.forEach(function(e){G.unsubscribe(e)}),z=[],m.destroyView(),K.main&&K.main.hide(),w&&G.getViewer().unsubscribe(w);var n=G.getFrameWindow().getActionBar();N&&n.removeCallback(N),L&&n.removeCallback(L),w=N=L=void 0,document.removeEventListener("keydown",re),document.removeEventListener("keyup",se)}function ue(){le(),q=[],$(),ce(!0);var e=G.getViewer();e.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(x),x=T=null,e.render(),F.restore(G.getFrameWindow().getViewpoint())}function de(){k.activate();var e=h.giveDefaultSelectionFilter({context:G});e&&C&&E&&!E.isNavigationActivated({context:G})&&C.activate({context:G,withSnap:!0,selectionFilter:e}),e&&e.activate({switchToAV1withMesh:!0}),G.getFrameWindow().getContextualUIManager().hideContextualMenus(),D=G.isRobotVisible(),G.setRobotVisibility(!1),W&&W.hide(),o.addEvent(B.canvas,"onPrimaryPointerClick",ee),M=Y.subscribe("Move",ue),P=Y.subscribe("MoveEnd",k.end.bind(k)),["onRootRemoved","onRootDetached","onAuthoringTransactionEnd","onEndDelete"].forEach(function(e){z.push(G.subscribe({event:e},Q))}),function(e){if(e){var t,o=J.getMoveReferent(e)||e,a=o.getLastElement(!0);if(p.isPLMInstanceNode(a)){a&&a.children.length&&o.addElement(a.children[0]);var r={display:{type:"docked",marginW:10,marginH:10},background:B,disableKeyboard:!0,displayWhileViewpointIsManipulated:!0,uiFrame:G.getFrameWindow().getUIFrame(),getLevels:function(t){var n=p.getLevelSelectorLevels({pathElement:e,pathElementCurrent:o,onInfoCompleted:t,context:G});if(n){n.selectColor="#ff821e",n.selectOverColor="#ffb477";for(var i=n.levels.length-1;i>=0;--i){var a=n.levels[i];p.isPLMReferenceNode(a.pathElement.getLastElement(!0))&&J.getMoveReferent(a.pathElement)||(a.selection="notSelectable")}}return n},onHover:function(e){T&&(T.setColor(oe(),!1),T.setOpacity(.05,!1),T.setVisibility(!0),T.setVisibilityFree(null)),(t=x.createOverride({pathes:[o]})).setColor(16744448,!0),t.setOpacity(1,!0),B.render(),n.empty(),n.add(e)},onLeave:function(){T&&(T.setColor(null,null),T.setOpacity(null,null),T.setVisibility(!1),T.setVisibilityFree(!0)),x.deleteOverride(t),t=null,B.render(),n.empty(),n.add(i.get())},onSelect:function(n){if(n&&n.pathElement&&J){if(J.addMoveReferent(n.pathElement),x.deleteOverride(t),t=null,!(o=J.getMoveReferent(e)))return;(a=o.getLastElement(!0))&&a.children.length&&o.addElement(a.children[0]),(t=x.createOverride({pathes:[o]})).setColor(16744448,!0),t.setOpacity(1,!0),B.render()}}};m.createView(r)}}}(1===q.length?q[0].path:null),K.main.show(),ae(),w=B.onViewerResize(ae);var t=G.getFrameWindow().getActionBar();N=t.onActionBarOpen(ae),L=t.onActionBarClose(ae),document.addEventListener("keydown",re),document.addEventListener("keyup",se)}U=function(e){" "!==e.key&&"Spacebar"!==e.key&&32!==e.keyCode||!1===e.ctrlKey&&!1===e.altKey&&!1===e.shiftKey&&!1===e.metaKey&&(document.removeEventListener("keypress",U),document.addEventListener("keyup",V),0===q.length?k.begin():k.end())},V=function(e){" "!==e.key&&"Spacebar"!==e.key&&32!==e.keyCode||(document.removeEventListener("keyup",V),document.addEventListener("keypress",U))},this.execute=function(){(b=g.getRoots(G).map(g.getNodeID,g).some(X.isLargeDataStructure,X))&&X.pauseProgressiveLoading(),(F=new S).store(G.getFrameWindow().getViewpoint()),G.getFrameWindow().getActionBar().close(),y=r.getAnimation3DEngine({viewer:B}),q=[],x=new l(G.getRootBagPath().externalPath[0]),H.pushSceneGraphOverrideSet(x);var t=[],o=[],s=new a.Box3,u=B.getVisibleSpace();if(A=[],i.get().forEach(function(e){A.push(e);for(var n=new c(e.pathElement.externalPath);n&&!p.isPLMNode(n.getLastElement(!0));)n=n.getParentPath();if(n&&n.externalPath.length&&(!1===H.getCurrentVisibilityFree(n)||"boolean"==typeof H.getCurrentVisibility(n))){var i=n.getParentPath().getWorldMatrix(),r=(new a.Matrix4).getInverse(i),l=n.getMatrix(),d={path:n,override:x.createOverride({pathes:[n]}),matrixSource:l,matrixParent:i,matrixParentInv:r,rotate:!0},m=u?n.getBoundingBox(null,B,"visibleSpace"):n.getBoundingBox(null,B,"invisibleSpace");m&&!m.isNaN()?(m.applyMatrix4(n.getWorldMatrix()),s.union(m)):d.rotate=!1,q.push(d),t.push(n),o.push(n.getKey())}}),t.length>0){var d=s.center();q.forEach(function(e){e.centerRotation=(new a.Vector3).copy(d).applyMatrix4(e.matrixParentInv)});var m=!1;_&&(_.isEqual(new c(t[0].externalPath))&&f(_)||(O=_=null)),O||(m=!0);var h=ie(G.getRootBagPath(),t,o,H);T=x.createOverride({pathes:h}),y.addAnimation({animationType:"mask",objectListToAnimate:[{override:T}],callBackFct:function(){m?G.getFrameWindow().getViewpoint().reframe(null,0,s.getBoundingSphere()):O&&(O.restore(G.getFrameWindow().getViewpoint(),_.getWorldMatrix()),O=null)}}),y.startAnimation();K.main=e.createElement("div",{id:"C3D-viewpoint"}).inject(G.getFrameWindow().getUIFrame()),["left","top","right","bottom"].forEach(function(t){var n=new e.createElement("div",{class:t}).inject(K.main);n.addEvents({click:ne}),new e.createElement("div",{class:"background"}).inject(n);var i=new e.createElement("div",{class:"arrow"}).inject(n);new e.createElement("div",{class:"borderBottom"}).inject(i),new e.createElement("div",{class:"borderRight"}).inject(i),K[t]=n}),de(),n.empty(),i.empty(),require(["DS/CAT3DComposeUtils/CATC3DUtils"],function(e){e._sendUsageProbe("command","ExamineSelection")})}else k.end()},this.endExecute=function(){if(le(),q=[],ce(),K.main&&K.main.destroy(),K={},x){var e=G.getViewer();e.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(x),x=T=null,e.render(),G.getFrameWindow().getActionBar().open(),F.restore(G.getFrameWindow().getViewpoint())}A&&A.length&&0===i.get().length&&(n.empty(),i.empty(),A.filter(function(e){return"boolean"==typeof H.getCurrentVisibility(e.pathElement)}).length&&(n.add(A),i.add(A)));$(),b&&X.resumeProgressiveLoading(),b=!1},this.pauseExecute=function(){ce(!1)},this.resumeExecute=function(){de(),n.empty(),i.empty();var e=new a.Box3,t=B.getVisibleSpace();q.forEach(function(n){var i=n.path,o=t?i.getBoundingBox(null,B,"visibleSpace"):i.getBoundingBox(null,B,"invisibleSpace");o&&!o.isNaN()?(o.applyMatrix4(i.getWorldMatrix()),e.union(o),n.rotate=!0):n.rotate=!1});var o=e.center();q.forEach(function(e){e.centerRotation=(new a.Vector3).copy(o).applyMatrix4(e.matrixParentInv)})},this.activate=function(){k&&(k.enable(),document.addEventListener("keypress",U),0===j.length&&(j.push(i.onPostAdd(Z)),j.push(i.onPostRemove(Z))),I||(I=G.subscribe({event:"onShow"},Z)),R||(R=G.subscribe({event:"onHide"},Z)),Z())},this.deactivate=function(){k&&(document.removeEventListener("keypress",U),document.removeEventListener("keyup",V),j.forEach(function(e){i.unsubscribe(e)}),G.unsubscribe(I),G.unsubscribe(R),j.length=0,I=R=null,this.isRunning()||this.disable())},this.disable(),this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this._destroy=function(){k&&(k.deactivate(),C&&C.unreference({context:G}),Object.getPrototypeOf(this)._destroy.apply(this,arguments),k=G=X=B=H=null)}}})}),define("DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",["DS/ApplicationFrame/Command","DS/ApplicationFrame/CommandsManager","DS/CATW3DBoxes/CATW3DBoxController","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent","DS/PADUtils/PADContext","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATW3DRobot/CATW3DRobot","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXSelectionManager/CATWebUXSelectionManager"],function(e,t,n,i,o,a,r,s,l,c,u,d,m,p){"use strict";var g;return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),this.setRepeatMode(!1);var h=this,v=!1,f=s.get(),C=f.getCommandContext(),E=new r({context:f}),S=n.getBoxController({context:f}),A=l.giveMoveManager({context:f}),D=p.getSelectionManager({context:f}),y=c.getDefaultSelectionFilter({context:f}),x=u.getMove3DRobot({context:f}),T=[],b=[];function P(){if(h.isRunning()){var e=i.give3DGridController({context:f});e&&e.hide3DGrids(),h&&h.isRunning()&&(y&&y.activate(),D&&D.setActiveState(!1)),S&&S.setActiveState(!1)}}function M(){if(h.isRunning()){var e=i.give3DGridController({context:f});e&&e.display3DGrids(),h&&h.isRunning()&&y&&!x.hasTarget()&&(y.deactivate(),D&&D.setActiveState(!0)),S&&S.setActiveState(!0)}}g||require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],function(e){g=e,h.isRunning()&&(g.activate({context:f,withSnap:!0,selectionFilter:y}),b.length||(b.push(g.subscribe("onDirectMoveBegin",P)),b.push(g.subscribe("onDirectMoveEnd",M))))}),x.setSelectionFilter(y),y.deactivate(),T.push(x.subscribe("onRobotMoveBegin",P)),T.push(x.subscribe("onRobotMoveEnd",M));var I=[];function R(){I.length>0||(I.push(A.subscribe("MoveBegin",function(){t.getCommand("CAT3DComposeExamineSelectionHdr",C).deactivate()})),I.push(A.subscribe("Move",function(){var e=a.giveDataLauncherController({context:f});e&&e.setVisibility(!1)})),I.push(A.subscribe("MoveEnd",function(){var e=a.giveDataLauncherController({context:f});e&&e.setVisibility(!0),t.getCommand("CAT3DComposeExamineSelectionHdr",C).activate()})))}function w(){I.forEach(function(e){A.unsubscribe(e)}),I=[]}var N=d.givePreferenceManager({context:f.getFrameWindow()}),L=[];N.addPreferences(o.getPreferencesDefinition()),N.setUnitsPreferencesDisplayFlag(!0),N.setDisplayPreferencesDisplayFlag(!0),N.set3DSelectionPreferencesDisplayFlag(!0),N.setPreferredPreferenceContainersOrder(["W3MprefMove","MeasurePreferences","SectionPreferences"]),L.push(N.subscribe("CATWebUXPreferences_GravitationalEffects",function(e){var t=f?f.getViewer():null;t&&t.currentViewpoint&&t.currentViewpoint.control&&(t.currentViewpoint.getControl().setRotationRolling(!e),t.currentViewpoint.getControl().setRollingForTouchAvailable(!e))})),L.push(N.subscribe("CATWebUXPreferences_ProjectionType",function(e){var t=f?f.getViewer():null;t&&t.currentViewpoint&&t.currentViewpoint.setProjectionType(e)})),L.push(N.subscribe("CATWebUXPreferences_Select3DGeometry",function(e){D.setPicking(e?0:1)})),L.CATWebUXPreferences_SelectParentReferenceOr3DShape=N.subscribe("CATWebUXPreferences_SelectParentReferenceOr3DShape",function(e){D&&D.selectParentReference("select3DShape"!==e)});var _=m.getPreference("CATWebUXPreferences_GravitationalEffects","boolean");"boolean"==typeof _&&(f.getViewer().currentViewpoint.getControl().setRotationRolling(!_),f.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!_));var F=m.getPreference("CATWebUXPreferences_ProjectionType","int");0!==F&&1!==F||f.getViewer().currentViewpoint.setProjectionType(F),D.setPicking(m.getPreference("CATWebUXPreferences_Select3DGeometry","boolean")?0:1);let O=m.getPreference("CATWebUXPreferences_SelectParentReferenceOr3DShape","string");D&&D.selectParentReference("select3DShape"!==O),this.execute=function(){if(f&&!v){E.activate(),S.setActiveState(!0);var e=a.giveDataLauncherController({context:f});e&&e.setActiveState(!0),g&&g.activate({context:f,withSnap:!0,selectionFilter:y}),y&&y.deactivate(),t.getCommand("CAT3DComposeExamineSelectionHdr",C).activate(),R()}},this.beginExecute=function(){f&&(D.setActiveState(!0),f.getViewer().setPicking({trapSelection:!0,trapPrimitive:!1,trapGPU:!0}))},this.endExecute=function(){if(f){E.deactivate(),S.setActiveState(!1);var e=a.giveDataLauncherController({context:f});e&&e.setActiveState(!1),g&&g.deactivate({context:f}),D.setActiveState(!1);var n=t.getCommand("CAT3DComposeExamineSelectionHdr",C);n&&n.deactivate(),w()}},this.pauseExecute=function(){E.deactivate(),S.setActiveState(!1);var e=a.giveDataLauncherController({context:f});e&&e.setActiveState(!1),g&&g.deactivate({context:f}),y&&y.deactivate(),D.setActiveState(!1),t.getCommand("CAT3DComposeExamineSelectionHdr",C).deactivate(),w()},this.resumeExecute=function(){if(f){y&&x.hasTarget()?(y.activate(),D.setActiveState(!1)):D.setActiveState(!0),f.getViewer().setPicking({trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),E.activate(),S.setActiveState(!0);var e=a.giveDataLauncherController({context:f});e&&e.setActiveState(!0),g&&g.activate({context:f,withSnap:!0,selectionFilter:y}),t.getCommand("CAT3DComposeExamineSelectionHdr",C).activate(),R()}},this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this._destroy=function(){w(),T.forEach(x.unsubscribe,x),b.forEach(x.unsubscribe,b),g&&(b.forEach(g.unsubscribe,b),g.unreference({context:f})),v=!0,L.forEach(N.unsubscribe,N),c.unreferenceDefaultSelectionFilter({context:f}),p.unreferenceSelectionManager({context:f}),Object.getPrototypeOf(this)._destroy.apply(this,arguments),h=y=f=E=S=A=x=N=L=D=null}}})}),define("DS/CAT3DComposeUtils/CATC3DDropManager",["UWA/Class","DS/PADUtils/PADTypesMgt","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeUI/CAT3DComposeWidgetOptions","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/PADUtils/PADUtilsServices","DS/CoreEvents/ModelEvents","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/ApplicationFrame/Command","DS/CAT3DComposeUtils/CATC3DUtils","i18n!DS/PADUtils/assets/nls/PADUtils.json","i18n!DS/CAT3DComposeUtils/assets/nls/CATC3DDropManager.json"],function(e,t,n,i,o,a,r,s,l,c,u,d,m,p,g,h,v){"use strict";var f=i.getOption("authoring3d"),C=["CATProduct","CATPart","VPMReference","3DShape"],E=["CATProduct","VPMReference"],S=e.extend({init:function(e){var i,S,A,D,y=e.context,x=y.getViewer(),T=this,b=new p({ID:"CATC3DDropMngFakeCmdHdr",context:y.getCommandContext?y.getCommandContext():null});function P(e){var t=a.get(),n=!((t.length?t[0].pathElement:null)&&t[0].equivalentGeometry);return e?!n:n}function M(){var e=o.getRoots(y);if(!e.length)return!0;if(!e.some(function(e){return e&&!o.is3DLeaf(e)}))return!0;var t=i?i.getLastElement(!0):null;return!(!t||"RootBag"!==t.name)||!(!t||o.isPLMNode(t)&&-1!==E.indexOf(o.getNodeType(t)))}function I(e){if(!M()){if(S){var t=S.getPosition(),r=S.getSize();if(0===t.x&&0===t.y&&(t.x=x.SCREEN_WIDTH/2-r.width/2,t.y=x.SCREEN_HEIGHT/2-r.height/2),t.x<=e.offsetX&&e.offsetX<=t.x+r.width&&t.y<=e.offsetY&&e.offsetY<=t.y+r.height)S.setOpacity(0);else{var s=Math.max(Math.min(e.offsetX,t.x+r.width),t.x),l=Math.max(Math.min(e.offsetY,t.y+r.height),t.y),c=Math.sqrt((e.offsetX-s)*(e.offsetX-s)+(e.offsetY-l)*(e.offsetY-l));c<200?S.setOpacity(c/200):S.setOpacity(1)}}var u=function(e){if(i)return{pathElement:i.clone()};var t=x.pick(x.getMousePosition(new n.Vector2(e.offsetX,e.offsetY)),"primHybrid",!0);if(t&&t.path&&0!==t.path.length){var a=t.path[0];if(a&&a.externalPath&&!(a.externalPath.length<2)&&o.isAModelPath(a))return o.is3DLeaf(a.externalPath[1])&&a.externalPath.length>2&&(a.externalPath.splice(2),a.internalPath=[]),{pathElement:a,position:t.position}}}(e);if(u)a.unique(u),a.get()[0].position=u.position;else if(a.empty(),!i)return;e.preventDefault(),e.stopPropagation(),y.addWidgetBorder(),document.querySelector(".paddnd_invite_display.insert .paddnd_invite_txt").setText(P(e.shiftKey)?"Insert object in position":"Insert"),y._dropZoneContainer.show("insert")}}function R(e){return a.empty(),r.empty(),s.empty(),S=document.querySelector(".paddnd_invite_container"),I(e)}function w(){S&&S.setOpacity(1)}function N(e){return a.empty(),w()}function L(e){if(!M()){S&&S.setOpacity(1),y._dropZoneContainer.hide(),y.clearWidgetBorder();for(var u=a.get().slice(),p=i?i.clone():u.length?u[0].pathElement:null;p;){var f=p.getLastElement(!0);if(f&&o.isReference(f)&&!o.is3DLeaf(f))break;p=p.getParentPath()}p&&(e.preventDefault(),e.stopPropagation(),function(e,n){try{t.retrieveAuthorizedObjects({displayNotif:!1,dnd_event:e,version:"2.0",callback:function(e){var t={unauthorized:[],add:[],insert:[]};e.unauthorized_objects&&e.unauthorized_objects.length&&(t.unauthorized=e.unauthorized_objects),Object.keys(e.authorizedWithKind).forEach(function(n){"Product"===n?e.authorizedWithKind.Product.forEach(function(e){-1===C.indexOf(e.objectType)?t.add.push(e):t.insert.push(e)}):e.authorizedWithKind[n].forEach(function(e){t.add.push(e)})}),n(t)}})}catch(e){window.console.log("")}}(e,function(t){if(t.unauthorized.length&&t.unauthorized.forEach(function(e){y.displayNotification({msg:h.replace(h.get("unsupported_type"),{type:e.objectType,name:e.displayName}),eventID:"warning"})}),t.insert.length){var i,a=!1,f=c.getPlatformId();for(i=0;i<t.insert.length;i++)f!==t.insert[i].envId&&(t.insert.splice(i,1),a=!0,i--),a&&y.displayNotification({msg:v.Tenant_InsertInfo,eventID:"warning"});if(t.insert.length){var C=o.getNodeID(p.getLastElement(!0)),E=P(e.shiftKey),S=[];A&&A.publish({event:"onBeginInsertDrop3D",data:{type:E?"inPosition":""}}),r.empty(),s.empty(),t.insert.forEach(function(i){var o=E?i.path?i.path.map(function(e){return e.resourceid}):[i.objectId]:null,a=i.objectId;!function(e,t,i,o){function a(e){var t=new n.Matrix4;return e.externalPath.forEach(function(e){t.multiply(e.getMatrix())}),t}if(i){if(1===i.length)return void o();var r=a(t),s=i.filter(function(e,t){return t%2});y.getController().getAttributes({ids:s,attributes:["matrixtxt"],callbacks:{onComplete:function(e){var t=new n.Matrix4,i=new n.Matrix4;s.forEach(function(n){if(e[n]&&e[n].matrixtxt){var o=e[n].matrixtxt.replace(/^\[?|\]?$/g,"").split(",").map(parseFloat);i.set(o[0],o[3],o[6],o[9],o[1],o[4],o[7],o[10],o[2],o[5],o[8],o[11],0,0,0,1),t.multiply(i)}}),o(i.getInverse(r).multiply(t))},onFailure:function(){o()}}})}else{var c,u=a(t),d=u.clone();switch(e.equivalentGeometry?e.equivalentGeometry.getType():null){case l.GeometryType.POINT:c=e.equivalentGeometry.getPoint();break;case l.GeometryType.LINE:case l.GeometryType.CYLINDER:case l.GeometryType.CONE:var m=e.equivalentGeometry.getEndPoints(),p=new n.Line3(m.beginPoint,m.endPoint);if(c=e.position?e.position.clone():null){var g=p.closestPointToPointParameter(c,!0);c=p.at(g>=.5?1:0)}break;case l.GeometryType.CIRCLE:case l.GeometryType.SPHERE:c=e.equivalentGeometry.getCenter();break;case l.GeometryType.AXISSYSTEM:u=a(e.pathElement);break;default:c=e.position?e.position.clone():null}c&&u.setPosition(c),o((new n.Matrix4).getInverse(d).multiply(u))}}(u[0],p,o,function(i){S.push({id:a,matrix:i}),S.length===t.insert.length&&(b.begin(),g.insertExisting({parentID:C,children:S,context:y,onCompleted:function(t){var i=0,o=s.get();t.forEach(function(e){e.instID||(e.message?y.displayNotification({msg:e.message,eventID:"error"}):i++)}),i&&y.displayNotification({msg:"Insertion failed",eventID:"error"});var a=m.giveMoveManager({context:y}),r=d.getMoveReferentManager({context:y});o.forEach(function(e){r.addMoveReferent(e.pathElement)});var c=u.length?u[0].equivalentGeometry:null,p=c?c.getType():null;!o.length||p!==l.GeometryType.LINE&&p!==l.GeometryType.CYLINDER&&p!==l.GeometryType.CONE&&p!==l.GeometryType.PLANE&&p!==l.GeometryType.REFPLANE?(o.length&&require(["DS/CATW3DBoxes/CATW3DBoxController"],function(e){e.getBoxController({context:y}).refreshBoxes()}),A&&A.publish({event:"onEndInsertDrop3D",data:{type:o.length?E?"inPosition":"":"cancelled"}})):require(["DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DGeometry/CATW3DEquivalentGeometry"],function(t,i){D||(D=t.getConstraintsController({context:y})),D.deleteAllCst();var r=i.getEquivalentGeometry({pathElement:o[0].pathElement,axis:D.getProductAxisForConstraint(),viewer:y.getViewer()});D.createCst({movable:{equivalentGeometry:r},fixed:{equivalentGeometry:c}});var s=D.simulateSolveCst()||{},l=s.matrix||new n.Matrix4,u=new n.Matrix4,d=s.rc,m=s.redundancy;0!==d||m||(a.onMoveBegin({objectsMoved:o,from:T,moveMode:"Persistent"}),o.forEach(function(e){a.onMove({objectsMoved:[{path:e.pathElement}],from:T,worldMatrix:u.multiplyMatrices(l,e.pathElement.getWorldMatrix())})}),a.onMoveEnd({from:T,status:"Moved"}),y.getFrameWindow().getContextualUIManager().showContextualBar({x:e.offsetX+45,y:e.offsetY-45,hideWithDistance:!0})),o.length&&require(["DS/CATW3DBoxes/CATW3DBoxController"],function(e){e.getBoxController({context:y}).refreshBoxes()}),A&&A.publish({event:"onEndInsertDrop3D",data:{type:o.length?E?"inPosition":"":"cancelled"}})})}}))})})}}else t.add.length&&y.addRootNodesFromContent({json3DXContent:{data:{items:t.add}},dispatch:!0,inContext:!e.shiftKey})}))}}this.connect=function(){f&&(x.canvas.addEventListener("dragenter",R),x.canvas.addEventListener("dragover",I),x.canvas.addEventListener("dragleave",N),x.canvas.addEventListener("dragend",w),x.canvas.addEventListener("drop",L),i=null)},this.disconnect=function(){f&&(D&&D.unreference(),x.canvas.removeEventListener("dragenter",R),x.canvas.removeEventListener("dragover",I),x.canvas.removeEventListener("dragleave",N),x.canvas.removeEventListener("dragend",w),x.canvas.removeEventListener("drop",L),i=null)},this.setCurrentPath=function(e){i=e?e.clone():null},this.subscribe=function(e,t){return A||(A=new u),A.subscribe(e,t)},this.unsubscribe=function(e){return A?A.unsubscribe(e):this}}}),A=[];return e.singleton({init:function(){},getDropManager:function(e){var t;return e&&e.context&&"ENOPAD3DViewer"===e.context.name&&(A.some(function(n){return n.context===e.context&&(t=n.dropMng,!0)}),t||(t=new S({context:e.context}),A.push({context:e.context,dropMng:t}))),t},unreferenceDropManager:function(e){e&&e.context&&"ENOPAD3DViewer"===e.context.name&&A.some(function(t,n){return t.context===e.context&&(A.splice(n,1),!0)})}})}),
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CATC3DPathElementAgentWithFilter",["DS/StateCommandEngine/PathElementAgent","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/Web3DUXFilterBar/Web3DUXFilterBar","DS/CAT3DComposeCommands/CATC3DAxisSystemDisplayAgent","DS/WebappsUtils/WebappsUtils","DS/Selection/CSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],function(e,t,n,i,o,a,r,s,l){"use strict";var c;return e.extend({_frameWindow:null,_filterUI:null,_activeFilters:null,_filtersEnum:null,_postFilter:null,_axisAgent:null,geometryTypesEnum:{POINT:n.GeometryType.POINT,LINE:n.GeometryType.LINE,CIRCLE:n.GeometryType.CIRCLE,PLANE:n.GeometryType.PLANE,CYLINDER:n.GeometryType.CYLINDER,CONE:n.GeometryType.CONE,SPHERE:n.GeometryType.SPHERE,REFERENCE:10,AXISSYSTEM:n.GeometryType.AXISSYSTEM,AXISSYSTEMAXIS:n.GeometryType.AXISSYSTEMAXIS,AXISSYSTEMORIGIN:n.GeometryType.AXISSYSTEMORIGIN},init:function(e){var i,r=a.getWebappsAssetUrl("DMUBaseCommands","icons/32/"),u=a.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/");return this._preselection=!0,c=this,e.context?(this._frameWindow=e.context.getFrameWindow(),this._axisAgent=new o({context:e.context}),this._activeFilters=e.activeFilters||{POINT:1,CENTER:1,CIRCLE:1,AXISSYSTEM:1,AXISSYSTEMAXIS:1,AXISSYSTEMORIGIN:1,LINE:1,PLANE:1,CYLINDER:1,REFERENCE:1},this._postFilter=e.postFilter,this._filtersEnum={POINT:{type:"element",id:"POINT",nls:l.point,url:r+"I_Meas_Point.png",callback:function(){c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.POINT},CENTER:{type:"element",id:"CENTER",nls:l.center,url:r+"I_Meas_PointCircle.png",callback:function(){c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.CENTER},CIRCLE:{type:"element",id:"CIRCLE",nls:l.circle,url:r+"I_WebMarkerCircle.png",callback:function(){c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.CIRCLE},AXISSYSTEM:{type:"element",id:"AXISSYSTEM",nls:l.axisSystem,url:u+"I_3DComposeAxisSystem.png",callback:function(){c._lastClicked="AXISSYSTEM",c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.AXISSYSTEM},AXISSYSTEMAXIS:{type:"element",id:"AXISSYSTEMAXIS",nls:l.axisSystemAxis,url:u+"I_C3DAxisAxis.png",callback:function(){c._lastClicked="AXISSYSTEMAXIS",c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.AXISSYSTEMAXIS},AXISSYSTEMORIGIN:{type:"element",id:"AXISSYSTEMORIGIN",nls:l.axisSystemOrigin,url:u+"I_C3DAxisOrigin.png",callback:function(){c._lastClicked="AXISSYSTEMORIGIN",c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.AXISSYSTEMORIGIN},LINE:{type:"element",id:"LINE",nls:l.line,url:r+"I_Meas_Line.png",callback:function(){c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.LINE},PLANE:{type:"element",id:"PLANE",nls:l.plane,url:r+"I_Meas_Plane.png",callback:function(){c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.PLANE},CYLINDER:{type:"element",id:"CYLINDER",nls:l.cylinder,url:r+"I_Meas_Cylinder.png",callback:function(){c.updateFilters()},bexclude:!1,bstateActif:c._activeFilters.CYLINDER},REFERENCE:{type:"element",id:"REFERENCE",nls:l.reference,url:r+"I_Meas_Product.png",callback:function(){c.updateFilters()},bexclude:!0,bstateActif:c._activeFilters.REFERENCE}},(i={agentId:"CAT3DComposeAssemblyPatternSelect",frameWindow:this._frameWindow,withPrevaluation:!1,engWithPSOHSO:!1,withPSO:!0,withHSO:!1,valuedFromCSO:!1,saveToCSO:!1,multiAcquisition:!1,multiAcquisitionCtrl:!1,pickingMode:"primHybrid",prePickingMode:"primHybrid",withUndoStep:!1}).prePickingFilter=i.pickingFilter=function(i){var o,a,r=!1,l=0,u=t.getEquivalentGeometry({pathElement:i,axisSystemSub:!c._activeFilters.AXISSYSTEM,axisSystemOrigin:!c._activeFilters.AXISSYSTEMORIGIN,viewer:e.context.getViewer()}),d=u?u.getType():null;if((c._activeFilters.AXISSYSTEM||c._activeFilters.AXISSYSTEMAXIS||c._activeFilters.AXISSYSTEMORIGIN)&&c._axisAgent.analyze({pathElement:i}),(1===c._activeFilters.AXISSYSTEM&&d===c.geometryTypesEnum.AXISSYSTEM||1===c._activeFilters.AXISSYSTEMAXIS&&d===c.geometryTypesEnum.AXISSYSTEMAXIS||1===c._activeFilters.AXISSYSTEMORIGIN&&d===c.geometryTypesEnum.AXISSYSTEMORIGIN)&&(u&&(a=u.getPathElement())&&(i.internalPath=a.internalPath,i.externalPath=a.externalPath),r=!0),!r&&(1===c._activeFilters.POINT&&d===c.geometryTypesEnum.POINT||1===c._activeFilters.CENTER&&(d===c.geometryTypesEnum.CIRCLE||d===c.geometryTypesEnum.SPHERE)||1===c._activeFilters.CIRCLE&&d===c.geometryTypesEnum.CIRCLE||1===c._activeFilters.LINE&&d===c.geometryTypesEnum.LINE||1===c._activeFilters.PLANE&&(d===c.geometryTypesEnum.PLANE||n.GeometryType.REFPLANE)||1===c._activeFilters.CYLINDER&&(d===c.geometryTypesEnum.CYLINDER||d===c.geometryTypesEnum.CONE))&&(r=!0),!r&&1===c._activeFilters.REFERENCE)for(l=i.externalPath.length-1;l>=0;--l)if((o=i.externalPath[l])&&s.isReference(o)){i.setFromArray(i.externalPath.slice(0,l+1)),r=!0;break}return r&&"function"==typeof c._postFilter&&(r=c._postFilter(i)),r},this._parent(i),this.updateFilters(),null):null},activate:function(){var e=r.get();this._parent(),this._preselection&&e.length>0&&(this._preselection=!1,this.object3D=[],this.options.pickingFilter(e[0].pathElement)&&(this.object3D.push(e[0]),this._modelEvents.publish({event:this._agentId,data:this.object3D}))),this.updateFilters()},deactivate:function(){this._filterUI&&(this._filterUI.clear(),this._filterUI.destroy(),this._filterUI=null),c._axisAgent.deactivate(),this._parent()},getSelType:function(e){var n=t.getEquivalentGeometry({pathElement:e,axisSystemSub:!c._activeFilters.AXISSYSTEM}),i=n?n.getType():null;return e&&e.externalPath&&s.isAModelPath(e)?!i&&0===e.internalPath.length&&e.externalPath.some(function(e){return e&&s.isReference(e)})?this.geometryTypesEnum.REFERENCE:"number"==typeof i?i:null:null},getActiveFilters:function(){return this._activeFilters},updateFilters:function(e,t){var n,o,a,r=!1,s=[];if("boolean"!=typeof t&&(t=!0),e&&"object"==typeof e){for(n in c._activeFilters={},e)e.hasOwnProperty(n)&&c._filtersEnum.hasOwnProperty(n)&&(c._activeFilters[n]=e[n],1!==c._activeFilters[n]&&(c._activeFilters[n]=0));r=!0}if(c._filterUI&&t)for(o in c._activeFilters)c._activeFilters.hasOwnProperty(o)&&(c._activeFilters[o]=c._filterUI.getActiveState(o)?1:0);if(c._lastClicked&&1===c._activeFilters[c._lastClicked]&&(c._activeFilters.AXISSYSTEM&&(c._activeFilters.AXISSYSTEM=0),c._activeFilters.AXISSYSTEMAXIS&&(c._activeFilters.AXISSYSTEMAXIS=0),c._activeFilters.AXISSYSTEMORIGIN&&(c._activeFilters.AXISSYSTEMORIGIN=0),c._activeFilters[c._lastClicked]=1,r=!0),c._lastClicked=null,c._activeFilters.AXISSYSTEM||c._activeFilters.AXISSYSTEMAXIS||c._activeFilters.AXISSYSTEMORIGIN?c._axisAgent.activate({type:"HSO",noPSOcb:!0}):c._axisAgent.deactivate(),r&&c._filterUI&&(c._filterUI.clear(),c._filterUI.destroy(),c._filterUI=null),!c._filterUI){for(o in c._activeFilters)c._activeFilters.hasOwnProperty(o)&&c._filtersEnum.hasOwnProperty(o)&&((a=c._filtersEnum[o]).bstateActif=c._activeFilters[o],s.push(a));c._filterUI=new i({body:c._frameWindow.getUIFrame(),frmWindow:c._frameWindow,Idpanel:"c3dPatternSelectionFilter",typeSeparator:"bubble",lJsonElement:s}),c._filterUI.build(),c._viewer.render()}}})}),
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CAT3DComposeAssemblyPatternCmd",["DS/StateCommandEngine/StateCommand","DS/CoreEvents/Events","DS/CATWebUXComponents/CATWebUXNotifBar","DS/FlagPanel/FlagPanel","DS/FlagPanel/FlagPanelEnums","DS/FlagPanel/FlagPanelManager","DS/PADUtils/PADContext","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/CAT3DComposeCommands/CATC3DPathElementAgentWithFilter","DS/Selection/HSOManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CAT3DComposeUtils/CATC3DUtils","DS/WebappsUtils/WebappsUtils","DS/SceneGraphNodes/AxisSystemNode","DS/CATW3DAnims/CATW3DAnimation3D","DS/Mesh/Mesh","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeAssemblyPatternCmd","css!DS/UIKIT/UIKIT"],function(e,t,n,i,o,a,r,s,l,c,u,d,m,p,g,h,v,f,C,E){"use strict";return e.extend({init:function(e){var S,A,D,y,x,T,b,P,M,I=this,R=this.beginExecute,w=this.endExecute,N=0,L=r.get(),_=L.getFrameWindow(),F=L.getViewer(),O=!1,W=!1,U={},V={},k="NOPATTERN",G=!0,B="LINEAR",X="LINEAR",H={count:2,spacing:50,angle:30,reverse:!1},Y={count:2,spacing:50,angle:30,reverse:!1},j={NOPATTERN:{REFERENCE:1,POINT:0,CENTER:0,LINE:0,CYLINDER:0,AXISSYSTEM:0,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:0},NOPATTERN_LINEAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_RECTANGULAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_CIRCULAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_USERDEFINED:{POINT:1,CENTER:1,AXISSYSTEM:1},LINEAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},RECTANGULAR:{POINT:1,CENTER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},CIRCULAR:{POINT:1,CENTER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},USERDEFINED:{POINT:1,CENTER:1,AXISSYSTEM:1}},q={NOPATTERN:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEM","AXISSYSTEMORIGIN","AXISSYSTEMAXIS","REFERENCE"],NOPATTERN_LINEAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_RECTANGULAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_CIRCULAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_USERDEFINED:["POINT","CENTER","AXISSYSTEM"],LINEAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],RECTANGULAR:["POINT","CENTER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],CIRCULAR:["POINT","CENTER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],USERDEFINED:["POINT","CENTER","AXISSYSTEM"]},z=new a(F),K=function(e){return e===b.geometryTypesEnum.POINT||e===b.geometryTypesEnum.CIRCLE||e===b.geometryTypesEnum.AXISSYSTEM||e===b.geometryTypesEnum.AXISSYSTEMORIGIN},J=function(){var e={version:3,reuse:G,radioPattern:X,direction1:H,direction2:Y,filters:j};e.reuse=!0,localStorage.setItem("CAT3DComposeAssemblyPatternCmd",JSON.stringify(e))},Z=function(e,n,i,o){var a;i=void 0===i||i,o=void 0===o||o,z.removeFlag(A[e]),A[e].destroy(),delete A[e],e!==W&&o&&delete U[e],e===y?(y=null,x&&(H.count=Y.count,H.spacing=Y.spacing,H.reverse=Y.reverse,A[x].destroy(),delete A[x],y=x,x=null)):e===x?x=null:e===O&&(n&&"NOPATTERN"===n&&(a="NOPATTERN",W&&(a=a+"_"+X),j[a]=b.getActiveFilters(),k=null),F.removeNode(T),O=null),b.object3D[0]=null,i&&t.publish({event:"C3D_UNSELECT_EVT"})},Q=function(e){var t,n,i,o,a,r,s=0,l=function(e){var t,n,i={bReference:Boolean(W),bOrigin:Boolean(O),typesCount:{}};for(t in b.geometryTypesEnum)b.geometryTypesEnum.hasOwnProperty(t)&&(i.typesCount[b.geometryTypesEnum[t]]=0);for(t in U)U.hasOwnProperty(t)&&t!==O&&t!==W&&i.typesCount[U[t].type]++;return b.object3D[0]&&!U[b.object3D[0].pathElement.getKey()]&&(n=b.getSelType(b.object3D[0].pathElement),W||n!==b.geometryTypesEnum.REFERENCE?!O&&K(n)?i.bOrigin=!0:!O&&e!==P.USERDEFINED.id&&K(n)||i.typesCount[n]++:i.bReference=!0),i}(e.stateID);if(!l||!l.bReference)return!1;for(s=0,a=(o=Object.keys(l.typesCount)).length,i=e.validTypes.length,t=0;t<a;++t)if(l.typesCount[o[t]]>0){for(r=!1,n=0;n<i;++n)if(o[t]===e.validTypes[n].type.toString()&&!(e.validTypes[n].maxcount&&l.typesCount[o[t]]>e.validTypes[n].maxcount)){s+=l.typesCount[o[t]],r=!0;break}if(!r)return!1}return e.stateID===P.USERDEFINED.id&&l.bOrigin&&s++,e.stateID===P.CIRCULAR.id&&l.bOrigin&&0===s&&s++,e.validSelCount>-1&&s===e.validSelCount||-1===e.validSelCount&&s>0},$=function(e,t,n){var i=new u.Vector3;return e.type===b.geometryTypesEnum.POINT?i.subVectors(e.canonicGeom.getPoint(),t.position):e.type===b.geometryTypesEnum.LINE?i.subVectors(e.canonicGeom.getEndPoints().endPoint,e.canonicGeom.getEndPoints().beginPoint):e.type===b.geometryTypesEnum.CIRCLE?i.subVectors(e.canonicGeom.getCenter(),t.position):e.type===b.geometryTypesEnum.CYLINDER?i.subVectors(e.canonicGeom.getEndPoints().endPoint,e.canonicGeom.getEndPoints().beginPoint):e.type===b.geometryTypesEnum.AXISSYSTEM||e.type===b.geometryTypesEnum.AXISSYSTEMORIGIN?i.subVectors(e.position,t.position):e.type===b.geometryTypesEnum.AXISSYSTEMAXIS&&(i=e.canonicGeom.getDirection()),n?i.normalize():i},ee=function(e){var t,n,i;if(!e.getParentPath)return null;for(i=(n=e.getParentPath().clone()).getLength()-1;i>=0;--i)if((t=n.externalPath[i])&&C.isReference(t))return n.setFromArray(n.externalPath.slice(0,i+1)),n;return null},te=function(e){V.hasOwnProperty(e)&&(V[e].pRefParent.getLastElement().removeChild(V[e].node),delete V[e],N--),F.render()},ne=function(){var e;if(V)for(e in V)V.hasOwnProperty(e)&&te(e)},ie=function(e,t,n){var i,o,a,r,s;return a=t.clone(),(s=t.getWorldMatrix()).getInverse(s),(i=new u.Matrix4).multiplyMatrices(s,n),(o=new d("PreviewNode"+ ++N)).setMatrix(i),o.addChild(e.pathElement.getLastElement()),t.getLastElement().addChild(o),a.addElement(o),r=a.getKey(),V[r]={node:o,activated:!0,pathElement:a,pRefParent:t},r},oe=function(e,t,n){var o={position:(new u.Matrix4).setPosition(U[e].position),iconUrl:U[e].iconUrl?U[e].iconUrl:"",closeButton:!0,closeCB:function(){Z(e,n)}};A[e]=new i(F,o),t&&A[e].setOffset(t),z.addFlag(A[e])},ae=function(e,n,a,r,s){var l={position:U[n].clickPos?(new u.Matrix4).setPosition(U[n].clickPos):new u.Matrix4,label:a,iconUrl:U[n].iconUrl?U[n].iconUrl:"",closeButton:!0,closeCB:function(){Z(n,e)},dialogs:[{type:o.fieldsTypeEnum.INTEGER,value:r.count,suffix:E.SUFFIX_INSTANCES,fnCallback:function(e){r.count=parseInt(e),t.publish({event:"C3D_PARAMETERS_CHG"})}},{type:o.fieldsTypeEnum.DOUBLE,prefix:E.PREFIX_SPACING,value:"CIRCULAR"===e?r.angle:r.spacing,suffix:"CIRCULAR"===e?"":"mm",fnCallback:function(n){"CIRCULAR"===e?r.angle=parseInt(n):r.spacing=parseInt(n),t.publish({event:"C3D_PARAMETERS_CHG"})}},{type:o.fieldsTypeEnum.BOOLEAN,iconUrl:g.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/")+"I_C3DReverseDirection.png",value:r.reverse,fnCallback:function(e){r.reverse=e,t.publish({event:"C3D_PARAMETERS_CHG"})}}]};A[n]=new i(F,l),s&&A[n].setOffset(s),z.addFlag(A[n])},re=function(e){var n,a,r,s,l,c,d,m,p,C,S,D,M="NOPATTERN"===e?X:e,I={};for(a in A)A.hasOwnProperty(a)&&(I[a]=A[a].getOffset(),z.removeFlag(A[a]),A[a].destroy(),delete A[a]);if(T&&F.removeNode(T),W){for(c=function(){var e,t=[];for(e in P)(P[e].conditions&&Q(P[e].conditions)||W&&O&&2===Object.keys(U).length&&-1!==["LINEAR","CIRCULAR","USERDEFINED"].indexOf(e))&&t.push(e);return 0===t.length&&(t=["LINEAR","CIRCULAR","USERDEFINED"]),t}(),n=[{value:M,iconUrl:P[M].iconUrl,label:E["LABEL_"+M],isdefault:!0}],l=c.length||0,s=0;s<l;++s)c[s]!==M&&n.push({value:c[s],iconUrl:P[c[s]].iconUrl,label:E["LABEL_"+c[s]]});d={position:U[W].clickPos?(new u.Matrix4).setPosition(U[W].clickPos):(new u.Matrix4).setPosition(U[W].position),label:E.FLAG_REF_LABEL,iconUrl:U[W].iconUrl?U[W].iconUrl:"",closeButton:!0,closeCB:function(){z.removeFlag(A[W+"ref"]),A[W+"ref"].destroy(),delete A[W+"ref"],W!==O&&delete U[W],"NOPATTERN"===e&&(m="NOPATTERN",W&&(m=m+"_"+X),j[m]=b.getActiveFilters(),k=null),W=null,b.object3D[0]=null,t.publish({event:"C3D_UNSELECT_EVT"})},dialogs:[{type:o.fieldsTypeEnum.RADIO,radios:n,fnCallback:function(e){B=X,re(X=e),t.publish({event:"C3D_PATTERN_CHG"})}},{type:o.fieldsTypeEnum.BOOLEAN,iconUrl:g.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/")+"I_C3DReuse.png",value:G}]},A[W+"ref"]=new i(F,d),A[W+"ref"].setOffset(I[W+"ref"]),(p=A[W+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1]).style.width=0,p.style.border=0,p.style.padding=0,p.style.margin=0,z.addFlag(A[W+"ref"])}if(W&&A[W+"ref"]&&W!==O?A[W+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1].removeClassName("hidden"):W&&A[W+"ref"]&&A[W+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1].addClassName("hidden"),O&&e!==P.USERDEFINED.id&&M!==P.USERDEFINED.id&&(C=U[O].worldMatrix.clone().setPosition(U[O].position),S=v.getAnimation3DEngine({viewer:F}),(D=new h({headLength:10,arrowLength:50,arrowWidth:2,colors:{colorX:new f.Color(.25,.63,.85,1),colorY:new f.Color(.25,.63,.85,1),colorZ:new f.Color(.25,.63,.85,1)},head:h.types.ARROW})).exludeFromBounding(!0),D.setVisibilityInTree(!1),D.setPickable(f.PICKTHROUGH),D.setMatrix(C),F.addNode(D),S.axisSystemVisibility({objectListToAnimate:[D],visibility:!0,pickability:!1}),S.startAnimation(),T=D,e!==P.CIRCULAR.id||y||x?(d={position:(new u.Matrix4).setPosition(U[O].position),label:E.FLAG_ORIGIN_LABEL,iconUrl:U[O].iconUrl?U[O].iconUrl:"",closeButton:!0,closeCB:function(){Z(O,e)}},O===W&&(d.offset=new u.Vector2(0,50)),A[O]=new i(F,d),A[O].setOffset(I[O]),z.addFlag(A[O])):ae(e,O,E.LABEL_AXIS,H,I[O])),e===P.USERDEFINED.id||M===P.USERDEFINED.id)for(r in U)U.hasOwnProperty(r)&&r!==W&&oe(r,I[r],e);else y&&ae(e,y,E.LABEL_DIR1,H,I[y]),x&&ae(e,x,E.LABEL_DIR2,Y,I[x])},se=function(e){var t,n,i,o,a,r,s,l,c,d,p,g,h,v,f,C,E,S,A,T,M=[],I=F.getSceneGraphOverrideSetManager();for(t in D&&(I.removeSceneGraphOverrideSet(D),D=null),D=new m(L.getRootBagPath().externalPath[0]),V)V.hasOwnProperty(t)&&te(t);if(W)switch(M.push(U[W].pathElement),i=O&&U.hasOwnProperty(O)?U[O]:null,"USERDEFINED"!==e&&"USERDEFINED"!==X&&(O&&(s=O),y&&(v=$(U[y],i,!0),s=y,E=v.clone().setLength((H.reverse?-1:1)*H.spacing),f=(new u.Matrix4).makeTranslation(E.x,E.y,E.z)),x&&(E=$(U[x],i,!0).clone().setLength((Y.reverse?-1:1)*Y.spacing),C=(new u.Matrix4).makeTranslation(E.x,E.y,E.z))),h=U[W],(g=(p=ee(h.pathElement)).getWorldMatrix()).getInverse(g),S=G?h.worldMatrix.clone().setPosition(h.position):h.worldMatrix.clone().setPosition(i.position),e){case P.LINEAR.id:if(y)for(o=0;o<H.count;++o)(0!==o||G)&&o>0&&(S=f.clone().multiply(S),A=ie(h,p,S),M.push(V[A].pathElement));break;case P.RECTANGULAR.id:if(y&&x)for(d=S.clone(),c=0;c<Y.count;++c)for(c>0&&(d=C.clone().multiply(d)),S=d.clone(),o=0;o<H.count;++o)0===o&&(c>0||!G)?(A=ie(h,p,S),M.push(V[A].pathElement)):o>0&&(S=f.clone().multiply(S),A=ie(h,p,S),M.push(V[A].pathElement));break;case P.CIRCULAR.id:if(s)for(r=v||U[s].canonicGeom.getNormal().clone(),n=(new u.Matrix4).makeRotationAxis(r,(H.reverse?-1:1)*H.angle*Math.PI/180),l=(new u.Matrix4).setPosition(U[s].position),o=0;o<H.count;++o)(0!==o||G)&&o>0&&(S=l.clone().multiply(n.clone().multiply((new u.Matrix4).getInverse(l).multiply(S))),A=ie(h,p,S),M.push(V[A].pathElement));break;case P.USERDEFINED.id:for(a in U)U.hasOwnProperty(a)&&a!==W&&(S=U[a].type===b.geometryTypesEnum.AXISSYSTEM?U[a].worldMatrix.clone():h.worldMatrix.clone().setPosition(U[a].position),A=ie(h,p,S),M.push(V[A].pathElement))}D&&((T=D.createOverride({pathes:M}))&&(T.setOpacity(.5),T.setPickability("IGNORED")),I.pushSceneGraphOverrideSet(D))},le=function(){var e;for(e in c.empty(),U)U.hasOwnProperty(e)&&c.add(U[e]);for(e in V)V.hasOwnProperty(e)&&c.add(V[e])},ce=function(e){O=e},ue=function(e){var t,n,i,o,a=e;for(k&&(j[k]=b.getActiveFilters()),W&&a===P.NOPATTERN.id&&(a=a+"_"+X),o=j[a],W&&o.REFERENCE&&delete o.REFERENCE,n=0,i=q[a].length;n<i;++n)o.hasOwnProperty(q[a][n])||(o[q[a][n]]=0);for(t in o)o.hasOwnProperty(t)&&-1===q[a].indexOf(t)&&delete o[t];e===P.CIRCULAR.id&&y&&(o={}),b.updateFilters(o,!1)},de=function(e){var t,n=Object.keys(U),i=n.length;for(O||(x&&K(U[x].type)&&Z(x,e,!1,!1),y&&K(U[y].type)&&Z(y,e,!1,!1)),t=0;t<i;++t)if(K(U[n[t]].type)){if(!O&&n[t]!==y&&n[t]!==x){ce(n[t]);continue}if(!y&&n[t]!==O&&n[t]!==x){y=n[t];continue}if(!x&&n[t]!==y&&n[t]!==O){x=n[t];continue}}re(e)},me=function(e,n,i){var o,a,r,l,c,d,m=null,p=new u.Vector3;b.object3D[0]&&b.object3D[0].pathElement&&(m=b.object3D[0].pathElement),m&&!U[m.getKey()]&&(r=(o=s.getEquivalentGeometry({pathElement:m,axisSystemSub:!0,viewer:F}))?o.getType():b.geometryTypesEnum.REFERENCE,l=m.getWorldMatrix(),a=m.getKey(),r===b.geometryTypesEnum.REFERENCE||r===b.geometryTypesEnum.AXISSYSTEM||r===b.geometryTypesEnum.AXISSYSTEMAXIS?p.getPositionFromMatrix(l):p=function(e){var t=null,n=e.getType();if(void 0===n)return null;switch(n){case b.geometryTypesEnum.POINT:t=e.getPoint();break;case b.geometryTypesEnum.LINE:case b.geometryTypesEnum.CYLINDER:t=e.getEndPoints().beginPoint;break;case b.geometryTypesEnum.CIRCLE:case b.geometryTypesEnum.CENTER:t=e.getCenter()}return t}(o),U[a]={pathElement:m,type:r,worldMatrix:l,position:p,clickPos:b.object3D[0].position,canonicGeom:o,iconUrl:function(e){var t=null,n=g.getWebappsAssetUrl("DMUBaseCommands","icons/32/"),i=g.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/");switch(e){case b.geometryTypesEnum.POINT:t=n+"I_Meas_Point.png";break;case b.geometryTypesEnum.CENTER:case b.geometryTypesEnum.CIRCLE:t=n+"I_Meas_PointCircle.png";break;case b.geometryTypesEnum.AXISSYSTEM:t=i+"I_3DComposeAxisSystem.png";break;case b.geometryTypesEnum.AXISSYSTEMORIGIN:t=i+"I_C3DAxisOrigin.png";break;case b.geometryTypesEnum.AXISSYSTEMAXIS:t=i+"I_C3DAxisAxis.png";break;case b.geometryTypesEnum.PLANE:t=n+"I_Meas_Plane.png";break;case b.geometryTypesEnum.CYLINDER:t=n+"I_Meas_Cylinder.png";break;case b.geometryTypesEnum.LINE:t=n+"I_Meas_Line.png"}return t}(r)},r===b.geometryTypesEnum.AXISSYSTEM&&(U[a].clickPos=p),W||r!==b.geometryTypesEnum.REFERENCE?!O&&e.id!==P.USERDEFINED.id&&K(r)?ce(a):a!==O&&a!==W&&(y?x||(x=a,!O||r!==b.geometryTypesEnum.POINT&&r!==b.geometryTypesEnum.CIRCLE&&r!==b.geometryTypesEnum.AXISSYSTEM||(Y.spacing=Math.round(1e3*U[O].position.distanceTo(p))/1e3)):(y=a,!O||r!==b.geometryTypesEnum.POINT&&r!==b.geometryTypesEnum.CIRCLE&&r!==b.geometryTypesEnum.AXISSYSTEMORIGIN||(H.spacing=Math.round(1e3*U[O].position.distanceTo(p))/1e3))):(c=a,d=C.getNodeID(U[c].pathElement.getLastElement(!0)),W=c,U[c].iconUrl="",L.getController().getAttributes({ids:[d],attributes:["type_icon_url"],callbacks:{onComplete:function(e){U[c].iconUrl=e[d]?e[d].type_icon_url:"",A[c+"ref"]&&A[c+"ref"].setIcon(U[c].iconUrl)},onFailure:function(){}}})),b.object3D=[]),re(e.id),ue(e.id),J(),se(e.id),e.id!==P.NOPATTERN.id?S.removeAll(function(){S.add({message:E["LABEL_"+e.id],closable:!1,buttons:[{label:E.SAVEBTN,className:"primary",onClick:function(){t.publish({event:"C3D_SAVE_CLICK"})},doClose:!0},{label:E.CANCELBTN,className:"default",onClick:function(){t.publish({event:"C3D_CANCEL_CLICK"})},doClose:!0}]})}):S.removeAll(function(){var n=0;W&&(n=1),S.add({message:E["LABEL_"+e.id+"_"+n],closable:!1,buttons:[{label:E.CANCELBTN,className:"default",onClick:function(){t.publish({event:"C3D_CANCEL_CLICK"})},doClose:!0}]})}),i(),le()},pe=function(e,t,n){se(e.id),ue(e.id),J(),n(),le()},ge=function(){return!!W||(S.add({message:E.NOREFERROR,msgType:"warning",autoHide:!0,closable:!0}),!1)},he=function(e){var t,n,i,o=F,a={context:L,parentID:null,children:[],onCompleted:function(t){var n=t.length||0;0!==n?t.forEach(function(t){n--,!t.instID&&t.message&&S.add({message:t.message,msgType:"error",autoHide:!0,closable:!0}),0===n&&e()}):e()}};if(V&&U){for(t in n=U[W],i=C.getNodeID(n.pathElement.getLastElement()),a.parentID=C.getNodeID(ee(n.pathElement).getLastElement()),V)V.hasOwnProperty(t)&&V[t].activated&&a.children.push({id:i,matrix:V[t].pathElement.getMatrix(o)});p.insertExisting(a)}},ve=function(e){e()};this.beginExecute=function(){O=null,W=null,y=null,x=null,U={},S=(new n).inject(_.getUIFrame()),A=[],c.isEmpty()&&S.add({message:E.LABEL_NOPATTERN_0,closable:!1,buttons:[{label:E.CANCELBTN,className:"default",onClick:function(){t.publish({event:"C3D_CANCEL_CLICK"})},doClose:!0}]}),F.setDefaultPicking(!1),R.call(I)},this.endExecute=function(){var e;for(e in J(),c.empty(),O=null,W=null,y=null,x=null,V&&ne(),D&&(F.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(D),D=null),F.setDefaultPicking(!0),b&&b.deactivate(),ne(),S&&(S.destroy(),S=null),T&&F.removeNode(T),A)A.hasOwnProperty(e)&&(z.removeFlag(A[e]),A[e].destroy(),delete A[e]);A.length=0,w.call(I)},this.buildGraph=function(){var e=g.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/"),t=this.createInitialState("NoPatternState"),n=this.createState("LinearState"),i=this.createState("RectangularState"),o=this.createState("CircularState"),a=this.createState("UserDefineState"),r=this.getFinalState(),s=j.NOPATTERN;W||(s={POINT:0,CENTER:0,LINE:0,CYLINDER:0,AXISSYSTEM:0,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:0,REFERENCE:1}),b=new l({context:L,activeFilters:s,postFilter:function(e){var t=C.getRoots(L);return!!C.isAModelPath(e)&&(!Array.isArray(t)||-1===t.indexOf(e.getLastElement()))}}),P={NOPATTERN:{id:"NOPATTERN",iconUrl:"",chkConditions:function(){return!0},actions:function(e){me(P.NOPATTERN,0,e)}},LINEAR:{id:"LINEAR",iconUrl:e+"I_C3DRectangularPattern.png",chkConditions:function(){return("LINEAR"===X||"RECTANGULAR"===X)&&Q(P.LINEAR.conditions)},conditions:{stateID:"LINEAR",debugTxt:"Linear pattern condition",validSelCount:1,validTypes:[{type:b.geometryTypesEnum.POINT},{type:b.geometryTypesEnum.CIRCLE},{type:b.geometryTypesEnum.LINE},{type:b.geometryTypesEnum.AXISSYSTEM},{type:b.geometryTypesEnum.AXISSYSTEMAXIS},{type:b.geometryTypesEnum.CYLINDER}]},actions:function(e){me(P.LINEAR,0,e)}},RECTANGULAR:{id:"RECTANGULAR",iconUrl:e+"I_C3DRectangularPattern.png",chkConditions:function(){return!("LINEAR"!==X&&"RECTANGULAR"!==X||!y)&&Q(P.RECTANGULAR.conditions)},conditions:{stateID:"RECTANGULAR",debugTxt:"Rectangular pattern condition",validSelCount:2,validTypes:[{type:b.geometryTypesEnum.POINT},{type:b.geometryTypesEnum.CIRCLE},{type:b.geometryTypesEnum.LINE},{type:b.geometryTypesEnum.CYLINDER},{type:b.geometryTypesEnum.AXISSYSTEM},{type:b.geometryTypesEnum.AXISSYSTEMAXIS}]},actions:function(e){me(P.RECTANGULAR,0,e),F.setDefaultPicking(!1)}},CIRCULAR:{id:"CIRCULAR",iconUrl:e+"I_C3DCircularPattern.png",chkConditions:function(){return"CIRCULAR"===X&&Q(P.CIRCULAR.conditions)},conditions:{stateID:"CIRCULAR",debugTxt:"Circular pattern condition",validSelCount:1,validTypes:[{type:b.geometryTypesEnum.POINT},{type:b.geometryTypesEnum.CIRCLE},{type:b.geometryTypesEnum.CYLINDER},{type:b.geometryTypesEnum.LINE},{type:b.geometryTypesEnum.AXISSYSTEM},{type:b.geometryTypesEnum.AXISSYSTEMAXIS}]},actions:function(e){me(P.CIRCULAR,0,e)}},USERDEFINED:{id:"USERDEFINED",iconUrl:e+"I_C3DUserPattern.png",chkConditions:function(){return"USERDEFINED"===X&&Q(P.USERDEFINED.conditions)},conditions:{stateID:"USERDEFINED",debugTxt:"User defined pattern condition",validSelCount:-1,validTypes:[{type:b.geometryTypesEnum.POINT},{type:b.geometryTypesEnum.CIRCLE},{type:b.geometryTypesEnum.AXISSYSTEM}]},actions:function(e){me(P.USERDEFINED,0,e)}}},this.addTransition({iInitialState:t,iFinalState:n,iEvent:b,iCondition:function(){return P.LINEAR.chkConditions()},iAction:function(e){k="NOPATTERN_LINEAR",P.LINEAR.actions(e)},iSender:I}),this.addTransition({iInitialState:t,iFinalState:i,iEvent:b,iCondition:function(){return P.RECTANGULAR.chkConditions()},iAction:function(e){k="NOPATTERN_LINEAR",P.RECTANGULAR.actions(e)},iSender:I}),this.addTransition({iInitialState:t,iFinalState:o,iEvent:b,iCondition:function(){return P.CIRCULAR.chkConditions()},iAction:function(e){k="NOPATTERN_CIRCULAR",P.CIRCULAR.actions(e)},iSender:I}),this.addTransition({iInitialState:t,iFinalState:a,iEvent:b,iCondition:function(){return P.USERDEFINED.chkConditions()},iAction:function(e){k="NOPATTERN_USERDEFINED",P.USERDEFINED.actions(e)},iSender:I}),this.addTransition({iInitialState:t,iFinalState:r,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){k="NOPATTERN",W&&(k=k+"_"+X),ve(e)}}),this.addTransition({iInitialState:t,iFinalState:t,iEvent:b,iCondition:function(){return P.NOPATTERN.chkConditions()},iAction:function(e){k="NOPATTERN",W&&(k=k+"_"+X),P.NOPATTERN.actions(e)},iSender:I}),this.addTransition({iInitialState:n,iFinalState:n,iEvent:b,iCondition:function(){return P.LINEAR.chkConditions()},iAction:function(e){k="LINEAR",P.LINEAR.actions(e)},iSender:I}),this.addTransition({iInitialState:n,iFinalState:n,iEvent:"C3D_PARAMETERS_CHG",iAction:function(e){k="LINEAR",pe(P.LINEAR,0,e)}}),this.addTransition({iInitialState:n,iFinalState:i,iEvent:b,iCondition:function(){return P.RECTANGULAR.chkConditions()},iAction:function(e){k="LINEAR",P.RECTANGULAR.actions(e)},iSender:I}),this.addTransition({iInitialState:n,iFinalState:r,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){k="LINEAR",ve(e)}}),this.addTransition({iInitialState:n,iFinalState:r,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return ge()},iAction:function(e){k="LINEAR",he(e)}}),this.addTransition({iInitialState:i,iFinalState:i,iEvent:"C3D_PARAMETERS_CHG",iAction:function(e){k="RECTANGULAR",pe(P.RECTANGULAR,0,e)}}),this.addTransition({iInitialState:i,iFinalState:r,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){k="RECTANGULAR",ve(e)}}),this.addTransition({iInitialState:i,iFinalState:r,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return ge()},iAction:function(e){k="RECTANGULAR",he(e)}}),this.addTransition({iInitialState:o,iFinalState:o,iEvent:b,iCondition:function(){return P.CIRCULAR.chkConditions()},iAction:function(e){k="CIRCULAR",P.CIRCULAR.actions(e)},iSender:I}),this.addTransition({iInitialState:o,iFinalState:o,iEvent:"C3D_PARAMETERS_CHG",iAction:function(e){k="CIRCULAR",pe(P.CIRCULAR,0,e)}}),this.addTransition({iInitialState:o,iFinalState:r,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){k="CIRCULAR",ve(e)}}),this.addTransition({iInitialState:o,iFinalState:r,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return ge()},iAction:function(e){k="CIRCULAR",he(e)}}),this.addTransition({iInitialState:a,iFinalState:a,iEvent:b,iCondition:function(){return P.USERDEFINED.chkConditions()},iAction:function(e){k="USERDEFINED",P.USERDEFINED.actions(e)},iSender:I}),this.addTransition({iInitialState:a,iFinalState:r,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){k="USERDEFINED",ve(e)}}),this.addTransition({iInitialState:a,iFinalState:r,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return ge()},iAction:function(e){k="USERDEFINED",he(e)}}),this.addTransition({iInitialState:n,iFinalState:o,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return P.CIRCULAR.chkConditions()},iAction:function(e){k="LINEAR",P.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:n,iFinalState:a,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return P.USERDEFINED.chkConditions()},iAction:function(e){k="LINEAR",P.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:o,iFinalState:n,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return P.LINEAR.chkConditions()},iAction:function(e){k="CIRCULAR",P.LINEAR.actions(e)}}),this.addTransition({iInitialState:o,iFinalState:a,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return P.USERDEFINED.chkConditions()},iAction:function(e){k="CIRCULAR",P.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:a,iFinalState:o,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return P.CIRCULAR.chkConditions()},iAction:function(e){de(P.CIRCULAR.id),k="USERDEFINED",P.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:a,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return P.USERDEFINED.chkConditions()},iAction:function(e){k="RECTANGULAR",P.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:a,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return P.RECTANGULAR.chkConditions()},iAction:function(e){de(P.RECTANGULAR.id),k="USERDEFINED",P.RECTANGULAR.actions(e)}}),this.addTransition({iInitialState:a,iFinalState:n,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return P.LINEAR.chkConditions()},iAction:function(e){de(P.LINEAR.id),k="USERDEFINED",P.LINEAR.actions(e)}}),this.addTransition({iInitialState:n,iFinalState:t,iEvent:"C3D_PATTERN_CHG",iAction:function(e){k="LINEAR",P.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:t,iEvent:"C3D_PATTERN_CHG",iAction:function(e){k="RECTANGULAR",P.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:o,iFinalState:t,iEvent:"C3D_PATTERN_CHG",iAction:function(e){k="CIRCULAR",P.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:a,iFinalState:t,iEvent:"C3D_PATTERN_CHG",iAction:function(e){k="USERDEFINED",P.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:t,iFinalState:n,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return P.LINEAR.chkConditions()},iAction:function(e){k="NOPATTERN",P.LINEAR.actions(e)}}),this.addTransition({iInitialState:t,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return P.RECTANGULAR.chkConditions()},iAction:function(e){k="NOPATTERN",P.RECTANGULAR.actions(e)}}),this.addTransition({iInitialState:t,iFinalState:o,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return P.CIRCULAR.chkConditions()},iAction:function(e){k="NOPATTERN",P.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:t,iFinalState:a,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return P.USERDEFINED.chkConditions()},iAction:function(e){k="NOPATTERN",P.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:t,iFinalState:t,iEvent:"C3D_PATTERN_CHG",iAction:function(e){k="NOPATTERN",W&&(k=k+"_"+B),P.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:n,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return P.LINEAR.chkConditions()},iAction:function(e){k="RECTANGULAR",P.LINEAR.actions(e)}}),this.addTransition({iInitialState:a,iFinalState:a,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return P.USERDEFINED.chkConditions()},iAction:function(e){P.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:n,iFinalState:t,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){k="LINEAR",P.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:o,iFinalState:o,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return P.CIRCULAR.chkConditions()},iAction:function(e){k="CIRCULAR",P.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:o,iFinalState:t,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){k="CIRCULAR",P.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:a,iFinalState:t,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){k="USERDEFINED",P.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:t,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){k="RECTANGULAR",P.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:t,iFinalState:t,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){P.NOPATTERN.actions(e)}})},(M=JSON.parse(localStorage.getItem("CAT3DComposeAssemblyPatternCmd")))&&3===M.version&&(G="object"==typeof M.reuse?M.reuse:G,X="object"==typeof M.radioPattern?M.radioPattern:X,H="object"==typeof M.direction1?M.direction1:H,Y="object"==typeof M.direction2?M.direction2:Y,j="object"==typeof M.filters?M.filters:j),this._parent(e,{mode:"exclusive",isAsynchronous:!0,doServerCall:!1}),this.odtUtilsSetDefaultNbInstances=function(e){H.count=e,Y.count=e}}})});