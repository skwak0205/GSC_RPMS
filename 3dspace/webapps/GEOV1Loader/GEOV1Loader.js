/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/GEOV1Loader/GEOConvertLength",function(){"use strict";return{convertToMM:function(e){var r=void 0;if(""==e)return r;var t=e.toLowerCase();"yard"==t?t="yd":"foot"==t&&(t="ft");var n={mm:1,cm:10,m:1e3,km:1e6,inch:25.4,ft:304.8,yd:914.4,mile:1609344,nauticalmile:1852e3};return void 0!==(r=n[t])?r:("meter"==t||"metre"==t?t="m":"kilometer"==t||"kilometre"==t?t="km":"centimeter"==t||"centimetre"==t?t="cm":"millimeter"!=t&&"millimetre"!=t||(t="mm"),n[t])}}}),define("DS/GEOV1Loader/GEOStyleServices",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return function(){function r(e,r,t){this._min=e,this._max=r,this._modulo=t,this.print=function(){console.log("propertiesRange print: min="+this._min+" max="+this._max+" modulo="+this._modulo+"\n")}}function t(e,r,t,n){this._dashSize=e,this._gapSize=r,this._lineWidth=t,this._patternNumber=n,this.print=function(){console.log("line type print: dashSize="+this._dashSize+" gapSize="+this._gapSize+" lineWidth="+this._lineWidth+"\n")},this.printPattern=function(){console.log("line pattern: "+["solid","dashed","dotted","dashes and dots alternating","dashes and double-dot alternating","dashes and triple dots alternating","long dashes","very long dash and short dash alternating","very long dash and double short dash alternating","very fine dotted line"][this._patternNumber]+"\n")}}this._parseSsi_lines=function(r,t,n,i,o){i[0]=new e.LineBasicMaterial({color:8806,lineWidth:1});for(var a=t.length,s=[],l=0;l<a;l++)s[l]=new Array(t[l],l,0);for(var u=s.length,h=r.split("STRINGS"),d=h.length,c=[],f=[],g=!1,p=!1,v=1;v<d;v++){var b=h[v].split("\n"),m=b.length;for(l=1;l<m;l++){var _=b[l],S=(_=_.trim()).split(",");if(0!=S.length){var y=parseInt(S[0]);if(isNaN(y)){if(0!=S[0].indexOf("default")){if(0==S[0].indexOf("TRIOBJECTS"))break;console.log("_parseSsi irrelevant line ="+_+"\n");continue}g=!0,p=!0}var O=this._getLineColor(_),C=this._getLineType(_),D=this._buildGraphicProperty(O,C);if(1!=g){var N=[],w=[];this._getPropertyObjectIndex(_,N,w);for(var L=N.length,E=0,x=0;x<L;x++)if(!(N[x]._min>n[1]||N[x]._max<n[0])){E=0,u=s.length;for(var A=N[x]._min%N[x]._modulo,T=0;T<u;T++)s[T][0]%N[x]._modulo==A&&(E++,s[T][2]=1,o[s[T][1]]=D);E>0&&(s=this._resizeProcessTable(s,n))}var I=w.length,F=0;for(x=0;x<I;x++)f.push(w[x]),c.push(D)}else i[0]=D,g=!1}}for(I=f.length,u=s.length,F=0,x=0;x<I;x++)for(T=0;T<u;T++)s[T][0]==f[x]&&(s[T][2]=1,F++,o[s[T][1]]=c[x]);F>0&&(s=this._resizeProcessTable(s,n))}if((u=s.length)>0)if(p)for(l=0;l<u;l++)o[s[l][1]]=i[0];else for(l=0;l<u;l++)o[s[l][1]]=this._getLineDefault(s[l][0])},this._parseSsi_triObjects=function(e,r,t,n){for(var i=this._getFaceColorDefault(0),o=r.length,a=[],s=0;s<o;s++)a[s]=new Array(r[s],s,0);for(var l=a.length,u=e.split("TRIOBJECTS"),h=u.length,d=[],c=[],f=!1,g=!1,p=1;p<h;p++){var v=u[p].split("\n"),b=v.length;for(s=1;s<b;s++){var m=v[s],_=(m=m.trim()).split(",");if(0!=_.length){var S=parseInt(_[0]);if(isNaN(S)){if(0!=_[0].indexOf("default")){if(0==_[0].indexOf("STRINGS"))break;console.log("_parseSsi_triObjects irrelevant line ="+m+"\n");continue}f=!0,g=!0}var y=this._getFaceColor(m);if(1!=f){var O=[],C=[];this._getPropertyObjectIndex(m,O,C);for(var D=O.length,N=0,w=0;w<D;w++)if(!(O[w]._min>t[1]||O[w]._max<t[0])){N=0,l=a.length;for(var L=O[w]._min%O[w]._modulo,E=0;E<l;E++)a[E][0]%O[w]._modulo==L&&(N++,a[E][2]=1,n[a[E][1]]=y);N>0&&(a=this._resizeProcessTable(a,t))}var x=C.length,A=0;for(w=0;w<x;w++)c.push(C[w]),d.push(y)}else i=y,f=!1}}for(x=c.length,l=a.length,A=0,w=0;w<x;w++)for(E=0;E<l;E++)a[E][0]==c[w]&&(a[E][2]=1,A++,n[a[E][1]]=d[w]);A>0&&(a=this._resizeProcessTable(a,t))}if((l=a.length)>0)if(g)for(s=0;s<l;s++)n[a[s][1]]=i;else for(s=0;s<l;s++)n[a[s][1]]=this._getFaceColorDefault(a[s][0])},this._computeColor=function(r){var t=new e.Color,n=.5,i=.5,o=.5;if(t.setRGB(n,i,o),r.trim().toLowerCase(),-1!=r.indexOf("r=")){var a=r.split(" ");if(3!=(m=a.length))return t;for(var s,l,u,h=.5,d=.5,c=.5,f=!1,g=0;g<m;g++){var p=a[g].indexOf("r=");-1!=p&&(s=a[g].substr(p+2,a[g].length-1),h=parseFloat(s),isNaN(h)||(l=!0)),-1!=(p=a[g].indexOf("g="))&&(s=a[g].substr(p+2,a[g].length-1),d=parseFloat(s),isNaN(d)||(u=!0)),-1!=(p=a[g].indexOf("b="))&&(s=a[g].substr(p+2,a[g].length-1),c=parseFloat(s),isNaN(c)||(f=!0))}return 0==l||0==u||0==f?(console.log("_computeColor  rgb syntax error\n"),t):(t.setRGB(h,d,c),t)}var v=[],b=[];v.push(["apricot","aquamarine"]),b.push([255,194,166,0,242,214]),v.push(["bittersweet","black","blue","blue green","blue grey","blue violet","brick red","brown","burnt orange","burnt sienna"]),b.push([207,10,0,0,0,0,0,0,255,0,181,168,41,117,166,25,0,64,163,3,0,51,8,0,181,79,0,143,25,13]),v.push(["cadet blue","cerulean","copper","cornflower","cyan"]),b.push([79,79,143,0,82,102,133,54,0,107,107,255,0,255,255]),v.push(["dandelion"]),b.push([230,191,0]),v.push(["forest green","fuchsia"]),b.push([0,92,23,166,0,102]),v.push(["gold","goldenrod","green","green blue","green yellow","grey"]),b.push([173,94,0,255,92,0,0,255,0,0,148,204,230,255,0,128,128,128]),v.push(["indian red"]),b.push([128,0,0]),v.push(["jungle green"]),b.push([0,166,102]),v.push(["lavender","lemon yellow"]),b.push([255,143,199,255,219,10]),v.push(["magenta","mahogany","maize","maroon","melon","midnight blue","mulberry"]),b.push([255,0,156,135,0,0,255,171,0,128,0,59,245,94,77,0,0,92,194,0,120]),v.push(["navy blue"]),b.push([0,0,122]),v.push(["olive green","orange","orange red","orange yellow","orchid"]),b.push([125,125,0,255,31,0,191,8,0,255,128,0,242,56,207]),v.push(["peach","periwinkle","pine green","pink","plum","purple"]),b.push([255,163,125,173,191,255,0,92,69,255,89,133,138,0,112,23,0,31]),v.push(["raw sienna","raw umber","red","red orange","red violet","royal purple"]),b.push([148,56,3,82,38,0,255,0,0,255,10,0,158,0,140,64,0,102]),v.push(["salmon","sea green","sepia","silver","sky blue","spring green","strawberry"]),b.push([255,125,94,41,255,41,41,8,0,184,184,184,112,217,255,189,255,66,204,0,51]),v.push(["tan","tangerine","teal","teal blue","thistle","turquoise blue"]),b.push([181,41,0,255,102,0,0,102,82,209,10,168,0,143,163]),v.push(["violet red"]),b.push([163,0,64]),v.push(["white"]),b.push([255,255,255]),v.push(["yellow","yellow green","yellow orange"]),b.push([255,255,0,125,255,0,255,59,0]);var m=v.length,_=r.charAt(0);e:for(g=0;g<m;g++)if(_==v[g][0].charAt(0))for(var S=v[g].length,y=0;y<S;y++)if(r==v[g][y]){n=b[g][3*y]/255,i=b[g][3*y+1]/255,o=b[g][3*y+2]/255;break e}return t.setRGB(n,i,o),t},this._getLineColor=function(r){var t=new e.Color;t.setRGB(1,0,0);for(var n=r.split("HGS_color="),i=n.length,o=1;o<i;o++){var a,s=n[o].split(",");if(s[0].indexOf("lines=")>=0){if(-1!=s[0].indexOf(" g=")||-1!=s[0].indexOf(" b=")||-1!=s[0].indexOf(" r=")){var l=s[0].lastIndexOf("=");if(-1==(l=(a=s[0].substring(0,l)).lastIndexOf("=")))return console.log("_getLineColor rgb syntax error.\n"),t;if(-1==(l=(a=s[0].substring(0,l)).lastIndexOf("=")))return console.log("_getLineColor rgb syntax error.\n"),t;a=s[0].substring(l-1,u)}else{var u=s[0].length;if(!(u>(l=s[0].lastIndexOf("="))+1))return console.log("_getLineColor color name error.\n"),t;a=s[0].substring(l+1,u)}return this._computeColor(a)}}return t},this._getFaceColor=function(r){var t=new e.Color;t.setRGB(.349,1,.349);for(var n=r.split("faces"),i=n.length,o=1;o<i;o++){var a,s=n[o].split(","),l=s[0].indexOf("diffuse=");if(-1==l&&(l=s[0].lastIndexOf("=")),l>=0){if(-1!=s[0].indexOf(" g=")||-1!=s[0].indexOf(" b=")||-1!=s[0].indexOf(" r=")){var u=s[0].lastIndexOf("=");if(-1==(u=(a=s[0].substring(0,u)).lastIndexOf("=")))return console.log("_getFaceColor rgb syntax error.\n"),t;if(-1==(u=(a=s[0].substring(0,u)).lastIndexOf("=")))return console.log("_getFaceColor rgb syntax error.\n"),t;a=s[0].substring(u-1,h)}else{var h=s[0].length;if(!(h>(u=s[0].lastIndexOf("="))+1))return console.log("_getFaceColor color name error.\n"),t;a=s[0].substring(u+1,h)}return this._computeColor(a)}}return t},this._getLineType=function(e){var r=1,n=new t(0,0,r,0),i=e.split("HGS_line_weight=");if(i.length<2)return n;var o=i[1].split(",");r=o.length>0?parseInt(o[0]):parseInt(i[1]),isNaN(r)||(n._lineWidth=r);var a=["-","- -",".","-.","-..","-...","-- --","center","phantom","finedot"];if((i=e.split("HGS_line_pattern=")).length<2)return n;var s,l=i[1].split(",");if((s=l.length>0?l[0]:i[1]).trim(),0==s.length)return n;var u=s.charAt(0),h=s.length;"."!=u&&"-"!=u&&"c"!=u&&"p"!=u&&"f"!=u&&h>1&&(s=s.substring(1,h)),h=s.length,"."!=(u=s.charAt(h-1))&&"-"!=u&&"r"!=u&&"m"!=u&&"e"!=u&&"t"!=u&&h>1&&(s=s.substring(0,h-1));var d=s.split(" ");if(1==d.length){if(-1!=s.indexOf(a[0])){if(-1==s.indexOf(a[2]))return n._patternNumber=0,n;if(s==a[3])return n._patternNumber=3,n;if(s==a[4])return n._patternNumber=4,n;if(s==a[5])return n._patternNumber=5,n}return s==a[7]?(n._patternNumber=7,n):s==a[8]?(n._patternNumber=8,n):s==a[9]||"...fine"==s?(n._patternNumber=9,n):-1!=s.indexOf(a[2])?(n._patternNumber=2,n):n}if(2==d.length){if(0==s.localeCompare(a[1]))return n._patternNumber=1,n;if(0==s.localeCompare(a[6]))return n._patternNumber=6,n}return n},this._buildGraphicProperty=function(r,t){return 0==t._patternNumber?new e.LineBasicMaterial({color:r,lineWidth:t._lineWidth}):1==t._patternNumber?new e.LineBasicMaterial({color:r,dashSize:1,gapSize:1,lineWidth:1}):6==t._patternNumber?new e.LineBasicMaterial({color:r,dashSize:2,gapSize:1,lineWidth:t._lineWidth}):7==t._patternNumber||8==t._patternNumber?new e.LineBasicMaterial({color:r,dashSize:3,gapSize:1,lineWidth:t._lineWidth}):2==t._patternNumber||3==t._patternNumber||4==t._patternNumber||5==t._patternNumber||9==t._patternNumber?new e.LineBasicMaterial({color:r,dashSize:1,gapSize:1,lineWidth:t._lineWidth}):new e.LineBasicMaterial({color:r,lineWidth:t._lineWidth})},this._getLineColorDefault=function(r){var t=this._getLineDefault(r),n=new e.Color,i=t.color.r,o=t.color.g,a=t.color.b;return n.setRGB(i,o,a),n},this._getLineDefault=function(r){var t=new e.Color,n=1,i=1,o=0;t.setRGB(n,i,o);var a=new e.LineBasicMaterial({color:t,lineWidth:1});if(r<1)return a;if(r>99&&r<3e4)return a;if(r>30008)return a;var s=[1,1,1,0,0,1,0,.6,.8,.478,.819,.478,.349,1,.349,1,1,0,1,.6,.2,1,0,0,1,.4,1];if(r<10)return n=s[3*(u=r-1)],i=s[3*u+1],o=s[3*u+2],t.setRGB(n,i,o),new e.LineBasicMaterial({color:t,lineWidth:1});if(r<100)return n=s[3*(u=r%10)],i=s[3*u+1],o=s[3*u+2],t.setRGB(n,i,o),new e.LineBasicMaterial({color:t,lineWidth:1});var l=[.5,.5,.5,.698,.584,.29,0,1,1,.803,.6,.596,0,0,0,1,.761,.651,0,.949,.839,.8,0,.8,.709,.541,.521];if(r<30009){var u;if(4==(u=r-3e4))return a;n=l[3*u],i=l[3*u+1],o=l[3*u+2],t.setRGB(n,i,o);var h=1;return 3e4!=r&&30001!=r||(h=3),30002!=r&&30006!=r||(h=2),30001==r?new e.LineBasicMaterial({color:t,dashSize:1,gapSize:1,lineWidth:h}):new e.LineBasicMaterial({color:t,lineWidth:h})}return a},this._getFaceColorDefault=function(r){r>10&&(r=r<20001?10+r%10:r<20009?r-20001+20:0);var t=new e.Color;return t.setRGB([89,173,0,0,45,89,255,255,255,255,173,0,0,45,89,255,255,255,255,172,148,0,51,255,204,153,0,55][r]/255,[255,94,0,153,204,255,255,153,0,102,94,0,153,204,255,255,153,0,102,172,56,51,255,163,0,0,255,163][r]/255,[89,0,255,204,147,89,0,51,0,255,0,255,204,147,89,0,51,0,255,172,3,255,51,125,255,153,255,125][r]/255),t.r,t.g,t.b,t},this._getPropertyObjectIndex=function(e,t,n){for(var i=0,o=e.split("=ssi_label")[0].split(";"),a=o.length,s=0;s<a;s++){var l=o[s].split(",");if(1==l.length)o[s].trim(),n[i]=parseInt(o[s]),i++;else if(2==l.length)(u=new r(0,0,0))._min=parseInt(l[0]),u._max=parseInt(l[1]),u._modulo=1,t.push(u);else if(3==l.length){var u;(u=new r(0,0,0))._min=parseInt(l[0]),u._max=parseInt(l[1]),u._modulo=parseInt(l[2]),t.push(u)}else console.log("_getPropertyObjectIndex index syntax error\n")}},this._resizeProcessTable=function(e,r){for(var t=[],n=e.length,i=0,o=0,a=0;a<n;a++)0==e[a][2]&&t.push(new Array(e[a][0],e[a][1],0));if(t.length==n)return e;if(0==(n=t.length))return t;for(o=i=e[0][0],a=0;a<n;a++)t[a][0]<i?i=t[a][0]:t[a][0]>o&&(o=t[a][0]);return r[0]=i,r[1]=o,t}}}),define("DS/GEOV1Loader/GEOdtmServices",["DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/Utils","DS/GEONavDriveAPI/GEOdriveServices","DS/GEOV1Loader/GEOstrServices","DS/GEOV1Loader/GEOStyleServices","DS/WebInfraUI/Notification","DS/WebSystem/Nls"],function(e,r,t,n,i,o,a,s,l,u){"use strict";return function(){this.debug=!1,this.method_debug="",this.vertexCoords=[],this.errorCallbackFunc=null,this.renderCallbackFunc=null,this._multiLoad=!1,this._dtmPath="",this.load=function(e,r,t,i,a,s,l){var u=this;u.errorCallbackFunc=void 0!==s?s:null,u.renderCallbackFunc=void 0!==l?l:null;var h=new n;h.productType="Reference3D";var d=[],c=[];u.endReader=function(){if(r.multiLoad)r.itemDoneCB(d);else{for(var e=d.length,t=0;t<e;t++)d[t].mesh3js.sceneGraph.children[0].solid=1,h.addChild(d[t]);l&&l({hack:!0,updateInfinitePlane:!0}),a&&a()}};var f="";if(1==r.multiLoad&&(f=r.path).length){var g,p=f.lastIndexOf("/");-1!=p?(p<(g=f.lastIndexOf("\\"))&&(p=g),u._dtmPath=f.substring(0,p)):-1!=(g=f.lastIndexOf("\\"))&&(u._dtmPath=f.substring(0,g))}o.load(e,f,function(r){1==u.debug&&(u.method_debug="handleAnswerObj  ");try{u._parse(r,e,d,c)}catch(r){u._errorLoader(r.message,e,!1)}},function(r){console.log(r.message),u._errorLoader("LOAD_DTM",e,!1)}),t&&!r.multiLoad&&t(h)},this._parse=function(e,r,t,n){1==this.debug&&(this.method_debug="_parse  ");var i=this,l=[],u=[],h=[],d=this._decodeHeader(e,0),c=d.length;if(0==c)return console.log(this.method_debug+"Error: invalid dtm file, no header.\n"),i._errorLoader("PARSE_DTM",r,!0),!1;d.trim();var f=d.indexOf(".str");if(-1==f)return console.log(this.method_debug+"Error: invalid dtm file, no str file.\n"),i._errorLoader("PARSE_DTM",r,!0),!1;var g=d.substring(0,f)+".str",p=f,v=!1;f=c-1,"\0"===d.charAt(f)&&(v=!0);var b=!1,m=[0,0];if(v?(f+=1,b=this._parseDTM_binary(e,f,u,h,l,m)):b=this._parseDTM_ascii(this._ensureString(e),u,h,l,m),!b)return console.log(this.method_debug+"Error: parsing dtm file failed.\n"),i._errorLoader("PARSE_DTM",r,!0),!1;var _=function(){for(var e,r,o,a,s,l=u.length,h=0;h<l;h++){for(var d,c,f,g,p,v,b,m,_,S,y,O,C,D=u[h],N=D.length/3,w=new Float32Array(3*N*3),L=new Float32Array(3*N*3),E=0,x=0,A=0,T=0;T<N;T++)A=D[x]-1,w[E]=1e3*i.vertexCoords[3*A],w[E+1]=1e3*i.vertexCoords[3*A+1],w[E+2]=1e3*i.vertexCoords[3*A+2],E+=3,A=D[x+1]-1,w[E]=1e3*i.vertexCoords[3*A],w[E+1]=1e3*i.vertexCoords[3*A+1],w[E+2]=1e3*i.vertexCoords[3*A+2],E+=3,A=D[x+2]-1,w[E]=1e3*i.vertexCoords[3*A],w[E+1]=1e3*i.vertexCoords[3*A+1],w[E+2]=1e3*i.vertexCoords[3*A+2],E+=3,x+=3;for(E=0,T=0;T<N;T++)d=w[E],g=w[E+1],b=w[E+2],c=w[E+3],p=w[E+4],m=w[E+5],f=w[E+6],v=w[E+7],_=w[E+8],a=void 0,s=void 0,s=(e=S=(p-g)*(_-b)-(m-b)*(v-g))*e+(r=y=(m-b)*(f-d)-(c-d)*(_-b))*r+(o=O=(c-d)*(v-g)-(p-g)*(f-d))*o,Math.abs(s-1)<1e-6?a=1:s>1e-6&&(a=Math.sqrt(s)),C=a,L[E]=S/C,L[E+1]=y/C,L[E+2]=O/C,L[E+3]=L[E],L[E+4]=L[E+1],L[E+5]=L[E+2],L[E+6]=L[E],L[E+7]=L[E+1],L[E+8]=L[E+2],E+=9;t.push(i._createMeshNode(N,w,L,n[h]))}};return i._dtmPath.length&&(g=i._dtmPath+"/"+g),o.load(r,g,function(e){1==i.debug&&(i.method_debug="handleAnswerStr  ");var t=[],u=new a;if(u.parseStrVertex(e,i.vertexCoords,t)){if(!i._SurpacCheckSum(d,p,i.vertexCoords,t))return console.log(i.method_debug+"Error: dtm and str files are not compatible.\n"),void i._errorLoader("LOAD_DTM_MISMATCH",r,!0);var h=u.hasStyle(),c=u.getStylePathName();if(h){i._dtmPath.length&&(c=i._dtmPath+"/"+c);try{o.load(r,c,function(e){(new s)._parseSsi_triObjects(i._ensureString(e),l,m,n),_(),i.endReader()},function(e){console.log(e.message);for(var r=new s,t=l.length,o=0;o<t;o++)n[o]=r._getFaceColorDefault(l[o]);_(),i.endReader()})}catch(e){h=!1}}if(!h){for(var f=new s,g=l.length,v=0;v<g;v++)n[v]=f._getFaceColorDefault(l[v]);_(),i.endReader()}}else i._errorLoader("PARSE_DTM_STR",r,!0)},function(e){console.log("Error: load str file failed.\n"),console.log(e.message),i._errorLoader("LOAD_DTM_STR",r,!1)}),!0},this._parseDTM_ascii=function(e,r,t,n,i){var o=!0,a=0,s=0,l=e.indexOf("OBJECT");if(-1!=l){var u=Math.min(e.length-l,1024);(v=e.substring(l+6,l+u).split(",")).length>1&&(s=parseInt(v[1]),isNaN(s)&&(s=0))}for(var h=e.split("TRISOLATION"),d=1;d<h.length;d++){a=s;var c=[],f=[],g=h[d].split("\n");if(g[0].split(",").length<2)return!1;for(var p=1;p<g.length-1;p++){var v,b=g[p],m=(v=(b=b.trim()).split(",")).length;if(0!=m&&0!=parseInt(v[0])){if(m<8){if("END"===v[0])break;if("OBJECT"===v[0]){m>2?(s=parseInt(v[1]),isNaN(s)&&(s=0)):s=0;break}o=!1,console.log("_parseDTM Error: invalid triangle data\n"),console.log("_parseDTM  triangle="+d+" line ="+b+"\n");break}if("OBJECT"===v[0]){m>2&&(s=parseInt(v[1]),isNaN(s)&&(s=0));break}for(var _=1;_<=3;_++)c.push(parseInt(v[_]));for(_=4;_<=6;_++)f.push(parseInt(v[_]))}}if(c.length<3)return!1;r.push(c),t.push(f),n.push(a);var S=a;isNaN(S)&&(S=-1),-1!=S&&(0==i[0]&&0==i[1]?(i[0]=S,i[1]=S):S<i[0]?i[0]=S:S>i[1]&&(i[1]=S))}return o},this._parseDTM_binary=function(e,r,t,n,i,o){1==this.debug&&(this.method_debug="_parseDTM_binary  ");var a=new DataView(e,r),s=a.byteLength,l=a.byteOffset,u=this._readDMTFirstBinaryBlock(a,s,l);if(-1===u)return console.log(this.method_debug+"Error : invalid first block\n"),!1;var h=0,d=0,c=0;r=u;var f=[],g=[];do{if(s<r+4)return!1;var p=a.getInt32(r,!1);if(r+=4,-1==p);else if(1==p);else if(2==p);else if(3!=p)return console.log(this.method_debug+"Error: invalid dtm file.\n"),!1;if(-1!=p){if(s<r+4)return!1;c=a.getInt32(r,!1),r+=4}if(3==p){if(s<r+24)return!1;for(var v=0;v<3;v++)f.push(a.getInt32(r,!1)),r+=4;for(v=0;v<3;v++)g.push(a.getInt32(r,!1)),r+=4}if(-1!=p&&-1==(r=this._skipDescription(a,s,l,r)))return!1;2==p&&(0!=f.length&&(t.push(f),n.push(g)),f=[],g=[],d=h,i.push(d),0==o[0]&&0==o[1]?(o[0]=c,o[1]=c):c<o[0]?o[0]=c:c>o[1]&&(o[1]=c)),1==p&&(h=c)}while(-1!=p);return 0!=f.length&&t.push(f),0!=g.length&&n.push(g),!0},this._readDMTFirstBinaryBlock=function(e,r,t){var n=-1;if(r<33)return n;var i=0,o=0;for(e.getInt32(i,!1),i+=4;;){o=0;do{if(r<i+28)return-1;var a=e.getInt32(i,!1);if(i+=4,e.getFloat64(i,!1),i+=8,e.getFloat64(i,!1),i+=8,e.getFloat64(i,!1),i+=8,-1==(n=this._skipDescription(e,r,t,i)))return n;i=n,o++}while(0!=a);if(1==o)break}return n},this._skipDescription=function(e,r,t,n){var i=-1,o=0,a=Math.min(r-n-1,1024);if(0==a)return i;var s=new Uint8Array(e.buffer,t+n,a);for(o=0;o<a;o++){if(0==s[o]){i=n+1;break}if(++n>r){console.log("_skipDescription error end line ="+o+"\n"),i=-1;break}}return o==a&&(n!=r-1&&console.log("_skipDescription error no end line \n"),i=-1),i},this._END_Description=function(e,r,t,n){n-=4;for(var i=new Uint8Array(e.buffer,t+n,3),o="",a=0;a<3;a++)o+=255&i[a];return"END"==o},this._createMeshNode=function(e,n,i,o){var a=new r.PrimitiveGroup;a.fillAttr=new r.FillAttributes,a.lineAttr=new r.LineAttributes,a.pointAttr=new r.PointAttributes;var s=new r.Buffer;s.size=9*e,s.component=r.VertexComponentEnum.POSITION,s.format=r.DataTypeEnum.FLOAT,s.dimension=3,s.data=n;var l=new r.Buffer;l.size=3*e,l.component=r.VertexComponentEnum.NORMAL,l.format=r.DataTypeEnum.FLOAT,l.dimension=3,l.data=i,a.addBuffer(0,s),a.addBuffer(1,l);var u=new r.Primitive;u.geomType="FACE",u.nbIndices=3*e,u.connectivity=r.ConnectivityTypeEnum.TRIANGLES,u.attr={fill:new r.FillAttributes(new r.Color(o.r,o.g,o.b,1)),line:new r.LineAttributes,point:new r.PointAttributes};var h=new r.VertexComponent;h.component=r.VertexComponentEnum.POSITION,h.nbVertices=3*e,h.nbValuesPerVertex=3,h.format=r.DataTypeEnum.FLOAT,h.cardinality=0,h.bufferId=0,h.indices=null;var d=new r.VertexComponent;d.component=r.VertexComponentEnum.NORMAL,d.nbVertices=3*e,d.nbValuesPerVertex=3,d.format=r.DataTypeEnum.FLOAT,d.cardinality=0,d.bufferId=1,d.indices=null,u.addVertexComponent(h),u.addVertexComponent(d),a.addPrimitive(u);var c=t.createMeshNode(a);c.mesh3js.sceneGraph.children[0].solid=1;for(var f=c.getPrimitives(),g=0;g<f.length;g++)f[g].sgNode._bNotRecognized=!0;return c},this._decodeHeader=function(e,r){1==this.debug&&(this.method_debug="_decodeHeader  ");var t="";if("string"!=typeof e){for(var n,i=Math.min(e.byteLength-r-1,1025),o=new Uint8Array(e,r,i),a=0;a<i;a++)if(t+=n=String.fromCharCode(o[a]),"\n"==n){if(i==a+1)return console.log(this.method_debug+"Error : invalid dtm file. \n"),"";t+=String.fromCharCode(o[a+1]);break}return a==i?(console.log(this.method_debug+"Error : dtm header is too long. \n"),""):t}for(i=e.length,a=r;a<i;a++)if(t+=n=e[a],"\n"==n){if(i==a+1)return console.log(this.method_debug+"Error : invalid dtm file. \n"),"";t+=e[a+1];break}return t},this._ensureString=function(e){if("string"!=typeof e){for(var r,t=new Uint8Array(e),n=0,i=t.length,o="";n<i;)r=t.subarray(n,Math.min(n+32768,i)),o+=String.fromCharCode.apply(null,r),n+=32768;return o}return e},this._ensureBinary=function(e){if("string"==typeof e){for(var r=new Uint8Array(e.length),t=0;t<e.length;t++)r[t]=255&e.charCodeAt(t);return r.buffer||r}return e},this._SurpacCheckSum=function(e,r,t,n){var i=!1;if(","!=e.charAt(r+4))return!0;if(e.length<r+15)return!0;var o=e.substr(r+5,8),a=e.replace(/;/gi,"|"),s="standard",l=a.indexOf("algorithm");if(-1!=l&&l>14){var u=e.substr(r+13,1);if("|"!==u){if("0"!==u)return!1;if("0"!=e.substr(r+14,1))return!1}var h=(g=a.substring(l+9,a.length)).indexOf("="),d=g.length;if(-1==h||h+1==d)return!1;if((s=-1!=(h=(g=g.substring(h+1,d)).indexOf("|"))?g.substring(0,h):g).trim(),"none"!=s&&"standard"!=s)return!1;if("none"==s)return!0}var c=[],f=a.indexOf("fields");if(-1==f)c.push("y"),c.push("x");else{var g;if(h=(g=a.substring(f+6,a.length-2)).indexOf("="),d=g.length,-1==h||h+1==d)return!1;d=(g=g.substring(h+1,d)).length,h=g.indexOf(",");for(var p="0";-1!=h;)(p=g.substring(0,h)).trim(),"x"!=p&&"y"!=p&&"z"!=p?c.push("0"):c.push(p),d=g.length,h=(g=g.substring(h+1,d)).indexOf(",");d=g.length,"\r"==g.charAt(d-1)&&(d-=1),(p=g.substring(0,d)).trim(),"x"!=p&&"y"!=p&&"z"!=p?c.push("0"):c.push(p)}var v,b,m,_,S,y,O,C=t.length/3,D=c.length,N="00000000",w=[48,48,48,48,48,48,48,48],L="0".charCodeAt(0),E=-1,x=n.length,A=0;n.length>0&&(E=n[0]);for(var T=0;T<C;T++)if(v=t[3*T],b=t[3*T+1],m=t[3*T+2],T!=E)for(var I=0;I<D;I++){for(S=(_=(_=(_=(_=("x"==c[I]?v:"y"==c[I]?b:"z"==c[I]?m:0).toFixed(3)).replace(".","9")).replace("-","9")).replace(",","9")).length;S<8;)S=(_="9"+_).length;for(var F=0;F<8;F++)y=_.charCodeAt(F),O=w[F],w[F]=(O-L+y-L)%10+L;N=String.fromCharCode(w[0],w[1],w[2],w[3],w[4],w[5],w[6],w[7])}else E=++A<x?n[A]:-1;return o==N&&(i=!0),i},this._errorLoader=function(e,r,t){var n=this,i=e;console.log("error message="+i+"\n"),u.nls("GEOV1Loader/GEOV1Loader_errors",i,function(e){void 0===e&&(i="INTERNAL_ERROR"),n.errorCallbackFunc&&n.errorCallbackFunc({type:[i],url:[JSON.stringify(r)],rsc:"GEOV1Loader/GEOV1Loader_errors",level:l.error}),1==t&&n.renderCallbackFunc&&n.renderCallbackFunc({hack:!0,updateInfinitePlane:!0})})}}}),define("DS/GEOV1Loader/GEOMineSchedAnimation2JSON",["DS/ZipJS/zip"],function(e){"use strict";return function(){this.load=function(e,r,t,n){var i=e;this._readMineSchedAnimation(i,r,t)};this._readMineSchedAnimation=function(r,t,n){!function(r,t,n,i){e.createReader(new e.HttpReader(r),function(r){r.getEntries(function(o){if(o.length){for(var a,s=0;s<o.length;s++)o[s].filename.includes(t)&&(a=o[s]);a.getData(new e.TextWriter,function(e){n(e.currentTarget.result,i),r.close(function(){})},function(e,r){})}})},function(e){console.log("erreur dans createReader")})}(r,"results3d.xml",function(e){!function(e,r,t){for(var n,i={Periods:{0:{}}},o=(new DOMParser).parseFromString(e,"text/xml"),a=o.evaluate("/results3d/period",o,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),s=[29.9,71.5,106.4,129.2,144,176,135.6,148.5,216.4,194.1,95.6,54.4,29.9,71.5,106.4,129.2,144,176,135.6,148.5,216.4],l=0;l<a.snapshotLength;l++){n=a.snapshotItem(l);var u=o.evaluate("./number",n,null,XPathResult.ANY_TYPE,null),h=o.evaluate("./start",n,null,XPathResult.ANY_TYPE,null),d=o.evaluate("./end",n,null,XPathResult.ANY_TYPE,null),c=u.iterateNext().textContent,f=h.iterateNext(),g=d.iterateNext(),p=new Date(f.attributes.year.value,f.attributes.month.value,f.attributes.day.value),v=new Date(g.attributes.year.value,g.attributes.month.value,g.attributes.day.value);i.Periods[c]={startDate:p,endDate:v,data:s[l]}}r(i)}(e,n)},t)}}}),define("DS/GEOV1Loader/GEOsdmServices",["DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/Utils","DS/GEONavDriveAPI/GEOdriveServices","DS/GEOV1Loader/GEOStyleServices","DS/WebInfraUI/Notification","DS/WebSystem/Nls","DS/GEOV1Loader/GEOConvertLength","DS/WebSystem/Environment"],function(e,r,t,n,i,o,a,s,l,u,h){"use strict";return function(){this.debug=!0,this.method_debug="",this.stringsObj3D=[],this.parseTriangulationObjects=function(r,t){var n=this;1==n.debug&&(n.method_debug="parseTriangulationObjects  ");var i=!0,o=[],s=[],l=[],u=[],h=[],d=[];if(new a,null==r.TriangulationObjects)try{return i=n.parseStringObjects(r,h,d,n.stringsObj3D)}catch(f){throw f}var c=0,f=!1;r.TriangulationObjects.forEach(function(r){c++;var t=void 0!==r.Name?r.Name:"",a=n.readFaceStyle(r,t),h=new e.Color;h.setRGB(a.color_R,a.color_G,a.color_B);var d=[],f=[],g=[];null!=r.Attributes&&(n.readAttributesFormat(r,d,f,g)||(d=[],f=[],g=[]));var p=[],v=[],b=0;null!=r.Triangulations&&r.Triangulations.forEach(function(e){b++;var r=parseInt(e.Name);isNaN(r)&&(r=0);var m=[],_=[],S=[];if(null==e.Attributes){var y=d.length;if(0==y)return void(i=!1);for(var O=0;O<y;O++)m[O]=d[O],_[O]=f[O],S[O]=g[O]}else if(!n.readAttributesFormat(e,m,_,S))return void(i=!1);if(c<2&&b<2){var C=m.length;for(console.log("TriangulationObject nbAtts="+C+"\n"),O=0;O<C;O++)console.log("Triangulation attribute "+m[O]+" format:"+_[O]+"\n")}var D=[];try{D=n.readAttributes(e.Data,m,_)}catch(e){return console.log("Error attributes TriangulationObject "+c+", Triangulations "+b+".\n"),void(i=!1)}var N=D.length;for(c<2&&b<2&&console.log("Triangulation number of data packages= "+N+"\n"),N&&c<2&&b<2&&console.log("Triangulation attributes "+JSON.stringify(D[0])+"\n"),O=0;O<N;O++)p.push(D[O].V1),p.push(D[O].V2),p.push(D[O].V3);a.visible&&(o.push(t),s.push(p),l.push(v),u.push(h)),console.log(n.method_debug+"object,Triangulation,nVertices="+c+","+b+","+p.length/3+"\n")}),console.log(n.method_debug+"object,nbTriangulations="+c+","+b+"\n")}),console.log(n.method_debug+"countTriangulationObjects="+c+"\n"),console.log(n.method_debug+"Trisolation_V.length="+s.length+"\n");try{if(!(i=n.parseStringObjects(r,h,d,n.stringsObj3D)))return i}catch(f){throw f}return n.buildfaces(s,h,u,t),i},this.buildfaces=function(e,r,t,n){for(var i,o,a,s,l,u=e.length,h=0;h<u;h++){for(var d,c,f,g,p,v,b,m,_,S,y,O,C,D=e[h],N=D.length/3,w=new Float32Array(3*N*3),L=new Float32Array(3*N*3),E=0,x=0,A=0,T=0;T<N;T++)A=D[x],w[E]=r[3*A],w[E+1]=r[3*A+1],w[E+2]=r[3*A+2],E+=3,A=D[x+1],w[E]=r[3*A],w[E+1]=r[3*A+1],w[E+2]=r[3*A+2],E+=3,A=D[x+2],w[E]=r[3*A],w[E+1]=r[3*A+1],w[E+2]=r[3*A+2],E+=3,x+=3;for(E=0,T=0;T<N;T++)d=w[E],g=w[E+1],b=w[E+2],c=w[E+3],p=w[E+4],m=w[E+5],f=w[E+6],v=w[E+7],_=w[E+8],s=void 0,l=void 0,l=(i=S=(p-g)*(_-b)-(m-b)*(v-g))*i+(o=y=(m-b)*(f-d)-(c-d)*(_-b))*o+(a=O=(c-d)*(v-g)-(p-g)*(f-d))*a,Math.abs(l-1)<1e-6?s=1:l>1e-6&&(s=Math.sqrt(l)),C=s,L[E]=S/C,L[E+1]=y/C,L[E+2]=O/C,L[E+3]=L[E],L[E+4]=L[E+1],L[E+5]=L[E+2],L[E+6]=L[E],L[E+7]=L[E+1],L[E+8]=L[E+2],E+=9;n.push(this._createMeshNode(N,w,L,t[h]))}},this._createMeshNode=function(e,n,i,o){var a=new r.PrimitiveGroup;a.fillAttr=new r.FillAttributes,a.lineAttr=new r.LineAttributes,a.pointAttr=new r.PointAttributes;var s=new r.Buffer;s.size=9*e,s.component=r.VertexComponentEnum.POSITION,s.format=r.DataTypeEnum.FLOAT,s.dimension=3,s.data=n;var l=new r.Buffer;l.size=3*e,l.component=r.VertexComponentEnum.NORMAL,l.format=r.DataTypeEnum.FLOAT,l.dimension=3,l.data=i,a.addBuffer(0,s),a.addBuffer(1,l);var u=new r.Primitive;u.geomType="FACE",u.nbIndices=3*e,u.connectivity=r.ConnectivityTypeEnum.TRIANGLES,u.attr={fill:new r.FillAttributes(new r.Color(o.r,o.g,o.b,1)),line:new r.LineAttributes,point:new r.PointAttributes};var h=new r.VertexComponent;h.component=r.VertexComponentEnum.POSITION,h.nbVertices=3*e,h.nbValuesPerVertex=3,h.format=r.DataTypeEnum.FLOAT,h.cardinality=0,h.bufferId=0,h.indices=null;var d=new r.VertexComponent;d.component=r.VertexComponentEnum.NORMAL,d.nbVertices=3*e,d.nbValuesPerVertex=3,d.format=r.DataTypeEnum.FLOAT,d.cardinality=0,d.bufferId=1,d.indices=null,u.addVertexComponent(h),u.addVertexComponent(d),a.addPrimitive(u);var c=t.createMeshNode(a);c.mesh3js.sceneGraph.children[0].solid=1;for(var f=c.getPrimitives(),g=0;g<f.length;g++)f[g].sgNode._bNotRecognized=!0;return c},this.parseStringObjects=function(i,o,s,l){var d=this;1==d.debug&&(d.method_debug="parseStringObjects  ");var c=!0,f=(new a,!1),g=0;return i.StringObjects.forEach(function(i){var a=[],s=[],p=0;g++;var v=void 0!==i.Name?i.Name:"",b=d.readLineStyle(i,v),m=new e.Color;m.setRGB(b.color_R,b.color_G,b.color_B);var _=new r.Color(b.color_R,b.color_G,b.color_B);f=b.visible;var S=b.width,y=[],O=[],C=[];if(null!=i.Attributes&&(d.readAttributesFormat(i,y,O,C)||(y=[],O=[],C=[])),i.Segments.forEach(function(r){p++;var t=parseInt(r.Name);isNaN(t)&&(t=0);var n=[],i=[],l=[];if(null==r.Attributes){var v=y.length;if(0==v)return void(c=!1);for(var b=0;b<v;b++)n[b]=y[b],i[b]=O[b],l[b]=C[b]}else if(!d.readAttributesFormat(r,n,i,l))return void(c=!1);if(g<2&&p<2){var _=n.length;for(b=0;b<_;b++)console.log("Segment attribute "+n[b]+" format:"+i[b]+"\n")}var D="",N=!1;for(b=0;b<n.length;b++)if("X"==n[b]||"Y"==n[b]||"Z"==n[b]){if(N){if(l[b]==D)continue;throw new Error("PARSE_UNITS")}N=!0,D=l[b]}var w=[],L=[];try{L=d.readAttributes(r.Data,n,i)}catch(e){return console.log("Error attributes StringObject "+g+", segment "+p+".\n"),void(c=!1)}var E=L.length;g<2&&p<2&&console.log("Segment number of data packages= "+E+"\n"),E&&g<2&&p<2&&console.log("Segment attributes "+JSON.stringify(L[0])+"\n");var x=1e3;if(N&&D.length&&null==(x=u.convertToMM(D)))throw console.log("Error: convert unit "+D+"\n"),new Error("UNITS_ERROR");for(b=0;b<E;b++){var A=L[b].X*x,T=L[b].Y*x,I=L[b].Z*x;f&&w.push(new e.Vector3(A,T,I)),o.push(A),o.push(T),o.push(I)}if(1==g&&1==p&&E){var F=h.get("ODT_GEOLOADER_mmValue");if(""!==F&&void 0!==F){var R=o[0].toString().substring(0,7);if(R!==F)throw console.log("Parse StringObjects- conversion error: unit="+D+" scaleToMM="+x+" , wrong value="+R+" , expected value="+F+"\n"),new Error("UNITS_ERROR");console.log("Parse StringObjects- unit checker is successful ("+D+").\n")}}f&&(a.push(w),s.push(new e.LineBasicMaterial({color:m,lineWidth:S})))}),c&&f){var D=a.length,N=new n;N.productType="Reference3D";for(var w=[],L=[],E=0,x=0;x<D;x++){var A=a[x];if(A.length>1)s[x].force=!0,(I=(T=t.createLineNode({points:a[x],material:s[x]})).mesh3js.sceneGraph.children[0]).getPrimitivesCount()&&(I.getPrimitiveGroup(0).glType=1),l.push(T);else{L=[],E=0;var T,I,F=A[0];L[E++]=F.x,L[E++]=F.y,L[E++]=F.z,(T=t.createPointsNode({positions:L,color:_,size:3})).setPickParent(!0),(I=T.mesh3js.sceneGraph.children[0]).getPrimitivesCount()&&(I.getPrimitiveGroup(0).gas.size=3,I.getPrimitiveGroup(0).glType=0),w.push(T)}}if(0!=w.length){for(var R=0;R<w.length;R++)N.addChild(w[R]);l.push(N)}}}),c},this._ensureString=function(e){if("string"!=typeof e){for(var r=new Uint8Array(e),t="",n=0;n<e.byteLength;n++)t+=String.fromCharCode(r[n]);return t}return e},this.load=function(e,r,t,i,a,s,l){var u=this;u.errorCallbackFunc=void 0!==s?s:null,u.renderCallbackFunc=void 0!==l?l:null;var h=new n;h.productType="Reference3D";var d=[],c=[],f=[],g=[];u.endReader=function(){console.log("GEOVIA loader: number of Triangulations="+d.length+"\n"),console.log("GEOVIA loader: number of Strings="+u.stringsObj3D.length+"\n");var e=u.stringsObj3D.length;if(e)for(var t=0;t<e;t++)d.push(u.stringsObj3D[t]);if(r.multiLoad)r.itemDoneCB(d);else{var n=d.length;for(t=0;t<n;t++)h.addChild(d[t]);l&&l({hack:!0,updateInfinitePlane:!0}),a&&a()}};var p="";if(1==r.multiLoad&&(p=r.path),p.length){var v,b=p.lastIndexOf("/");-1!=b?(b<(v=p.lastIndexOf("\\"))&&(b=v),u._strPath=p.substring(0,b)):-1!=(v=p.lastIndexOf("\\"))&&(u._strPath=p.substring(0,v))}o.load(e,p,function(r){try{u._parse(r,e,d,c,g,f)||u._errorLoader("PARSE_SDM",e,!1)}catch(r){u._errorLoader(r.message,e,!1)}},function(r){console.log(r.message),u._errorLoader("LOAD_SDM",e,!1)}),t&&!r.multiLoad&&t(h)},this._parse=function(e,r,t,n,i,o){var a;1==this.debug&&(this.method_debug="_parse  ");try{a=JSON.parse(this._ensureString(e))}catch(e){return console.log("Error JSON.parse\n"),console.log(e+"\n"),!1}try{if(!this.parseTriangulationObjects(a,t))return!1}catch(e){throw e}return this.endReader(),!0},this._errorLoader=function(e,r,t){var n=this,i=e;console.log("error message="+i+"\n"),l.nls("GEOV1Loader/GEOV1Loader_errors",i,function(e){void 0===e&&(i="INTERNAL_ERROR"),n.errorCallbackFunc&&n.errorCallbackFunc({type:[i],url:[JSON.stringify(r)],rsc:"GEOV1Loader/GEOV1Loader_errors",level:s.error}),t&&n.renderCallbackFunc&&n.renderCallbackFunc({hack:!0,updateInfinitePlane:!0})})},this.readAttributesFormat=function(e,r,t,n){var i=!1;return null==e.Attributes?(console.log("Attributes format error \n"),!1):(e.Attributes.forEach(function(e){if(null==e.Name||null==e.Format)i=!0;else{r.push(e.Name);var o=e.Format.trim();t.push(o),"int4"==o||("real8"==o||("text"==o||(i=!0)));var a="";null!=e.Units&&(a=e.Units.trim()),n.push(a)}}),!i||(console.log("readAttributesFormat error \n"),!1))},this.readAttributes=function(e,r,t){var n=[],i=r.length;if(0==i)return n;try{var o=atob(e)}catch(e){throw console.log("Error Attributes\n"),console.log(e+"\n"),e}for(var a=o.length,s=new Uint8Array(a),l=0;l<a;l++)s[l]=o.charCodeAt(l);for(var u=new DataView(s.buffer),h=0,d=!1;!(a<h+1||d);){var c=[];for(l=0;l<i;l++)if("int4"==t[l])try{if(a<h+4){console.log("readAttributes int4 error: data overflow \n"),d=!0;break}c.push(u.getInt32(h,!0)),h+=4}catch(e){console.log("readAttributes int4 attpack,i="+n.length+", "+l+"\n"),console.log("read error: "+d+"\n"),d=!0;break}else if("real8"==t[l])try{if(a<h+8){console.log("readAttributes real8 error: data overflow \n"),d=!0;break}c.push(u.getFloat64(h,!0)),h+=8}catch(e){console.log("readAttributes real8 attpack,i="+n.length+", \n"),console.log("read error: "+e+"\n"),d=!0;break}else{if("text"!=t[l]){console.log("readAttributes error format="+t[l]+"\n"),d=!0;break}if(h==a)break;for(;!(a<h+1);){var f=s[h++];if("0"==f)break}c.push("empty")}if(d)break;var g='{"',p=i-1;for(l=0;l<p;l++)g+=r[l]+'":',"text"==t[l]?g+='"'+c[l]+'","':g+=c[l]+',"';g+=r[p]+'":',"text"==t[p]?g+='"'+c[p]+'"}':g+=c[p]+"}",n.push(JSON.parse(g))}return n},this.readFaceStyle=function(e,r){var t=!0,n="solid",i=!1,o=e.Style;if(null==o?(console.log("No Style description.\n"),i=!0):null==o.FaceStyle&&(console.log("No FaceStyle description.\n"),i=!0),i){var s,l=parseInt(r);return isNaN(l)&&(l=0),{visible:t,pattern:n,color_R:(s=(new a)._getFaceColorDefault(l)).r,color_G:s.g,color_B:s.b,edgeVisible:!1}}return null!=o.FaceStyle.Visible&&(t=o.FaceStyle.Visible),null!=o.FaceStyle.FacePattern&&(n=o.FaceStyle.FacePattern),{visible:t,pattern:n,color_R:(s=this.readColor(o.FaceStyle,"FaceStyle",r)).r,color_G:s.g,color_B:s.b,edgeVisible:!1}},this.readLineStyle=function(e,r){var t,n=!1,i="---",o=1,s=!1;if(null==e.Style?(console.log("No Style desciption.\n"),s=!0):null==e.Style.LineStyle&&(console.log("No LineStyle description.\n"),s=!0),s){var l=parseInt(r);return isNaN(l)&&(l=0),{visible:n,pattern:i,width:o,color_R:(t=(new a)._getLineColorDefault(l)).r,color_G:t.g,color_B:t.b}}return null!=e.Style.LineStyle.Visible&&(n=e.Style.LineStyle.Visible),null!=e.Style.LineStyle.Pattern&&(i=e.Style.LineStyle.Pattern),o=1,null!=e.Style.LineStyle.Width&&(o=e.Style.LineStyle.Width),{visible:n,pattern:i,width:o,color_R:(t=this.readColor(e.Style.LineStyle,"LineStyle",r)).r,color_G:t.g,color_B:t.b}},this.readColor=function(r,t,n){var i=!1,o=!1,s=0,l=0,u=0,h=0,d=new a;if("LineStyle"==t&&(i=!0),"FaceStyle"==t&&(o=!0),!i&&!o)return(p=new e.Color).setRGB(s,l,u),console.log("readColor error style\n"),p;var c=r.Colour;if(null==r.Colour)return console.log("No Colour desciption.\n"),h=parseInt(n),isNaN(h)&&(h=0),i?d._getLineColorDefault(h):d._getFaceColorDefault(h);var f,g,p,v=!0,b=0;return null==r.Colour.R&&(v=!1),v?(f=c.R/255,void 0!==r.Colour.G?(g=r.Colour.G/255,void 0!==r.Colour.B?b=r.Colour.B/255:v=!1):v=!1,v?(s=f,l=g,u=b,(p=new e.Color).setRGB(s,l,u),p):(h=parseInt(n),isNaN(h)&&(h=0),i?d._getLineColorDefault(h):d._getFaceColorDefault(h))):(c=c.toLowerCase(),d._computeColor(c))}}}),define("DS/GEOV1Loader/GEOstrServices",["DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/Utils","DS/GEONavDriveAPI/GEOdriveServices","DS/GEOV1Loader/GEOStyleServices","DS/WebInfraUI/Notification","DS/WebSystem/Nls"],function(e,r,t,n,i,o,a,s,l){"use strict";return function(){this.debug=!0,this.method_debug="",this._hasStyle=!1,this._ssiFileName="",this._multiLoad=!1,this._strPath="",this.parseStrVertex=function(e,r,t){1==this.debug&&(this.method_debug="parseStr  ");var n=this._decodeHeader(e,0),i=n.length;if(0==i)return!1;var o=n.lastIndexOf(".ssi");if(-1!=o){var a=n.lastIndexOf(",");this._ssiFileName=n.substring(a+1,o+4),this._hasStyle=!0}var s=(n=this._decodeHeader(e,i-1)).length;if(0==s)return!1;var l=!1;return a=s-1,"\0"===n.charAt(a)&&(l=!0),l?this.parseStrVertex_binary(e,i+s-1,r,t):this.parseStrVertex_ascii(this._ensureString(e),r,t)},this.parseStrVertex_binary=function(e,r,t,n){1==this.debug&&(this.method_debug="parseStr_binary  ");var i=new DataView(e,r),o=i.byteLength,a=i.byteOffset;if(o<33)return!1;var s=0;i.getInt32(s,!1),s+=4;for(var l=0,u=0,h=0,d=0;!(o<s+28||(l=i.getInt32(s,!1),s+=4,h=i.getFloat64(s,!1),s+=8,u=i.getFloat64(s,!1),s+=8,d=i.getFloat64(s,!1),s+=8,-1==(s=this._skipDescription(i,o,a,s)))||this._END_Description(i,o,a,s));)0==l?(t.push(0),t.push(0),t.push(0),n.push(t.length/3-1)):(t.push(u),t.push(h),t.push(d));return!0},this.parseStrVertex_ascii=function(e,r,t){1==this.debug&&(this.method_debug="parseStrVertex_ascii  ");for(var n=e.split("\n"),i=2;i<n.length;i++){var o=n[i];if("END"===(o=o.trim()))break;var a=o.split(",");if(0!==parseInt(a[0]))a.length<5?console.log(this.method_debug+" Error: invalid vertex data\n"):(r.push(parseFloat(a[2])),r.push(parseFloat(a[1])),r.push(parseFloat(a[3])));else{if(o.endsWith("END"))break;r.push(0),r.push(0),r.push(0),t.push(r.length/3-1)}}return!0},this._decodeHeader=function(e,r){1==this.debug&&(this.method_debug="_decodeHeader  ");var t="";if("string"!=typeof e){for(var n,i=Math.min(e.byteLength-r-1,1025),o=new Uint8Array(e,r,i),a=0;a<i;a++)if(t+=n=String.fromCharCode(o[a]),"\n"==n){if(i==a+1)return console.log(this.method_debug+"Error : invalid str file. \n"),"";t+=String.fromCharCode(o[a+1]);break}return a==i?(console.log(this.method_debug+"Error : invalid str file header. \n"),""):t}for(i=e.length,a=r;a<i;a++)if(t+=n=e[a],"\n"==n){if(i==a+1)return console.log(this.method_debug+"Error : invalid str file. \n"),"";t+=e[a+1];break}return t},this._skipDescription=function(e,r,t,n){var i=-1,o=0,a=Math.min(r-n-1,1024);if(0==a)return i;var s=new Uint8Array(e.buffer,t+n,a);for(o=0;o<a;o++){if(0==s[o]){i=n+1;break}if(++n>r){console.log("_skipDescription error end line ="+o+"\n"),i=-1;break}}return o==a&&(n!=r-1&&console.log("_skipDescription error no end line \n"),i=-1),i},this._END_Description=function(e,r,t,n){n-=4;for(var i=new Uint8Array(e.buffer,t+n,3),o="",a=0;a<3;a++)o+=255&i[a];return"END"==o},this._ensureBinary=function(e){if("string"==typeof e){for(var r=new Uint8Array(e.length),t=0;t<e.length;t++)r[t]=255&e.charCodeAt(t);return r.buffer||r}return e},this._ensureString=function(e){if("string"!=typeof e){for(var r,t=new Uint8Array(e),n=0,i=t.length,o="";n<i;)r=t.subarray(n,Math.min(n+32768,i)),o+=String.fromCharCode.apply(null,r),n+=32768;return o}return e},this.hasStyle=function(){return this._hasStyle},this.getStylePathName=function(){return this._ssiFileName},this.load=function(e,i,a,s,l,u,h){var d=this;d.errorCallbackFunc=void 0!==u?u:null,d.renderCallbackFunc=void 0!==h?h:null;var c=new n;c.productType="Reference3D";var f=[],g=[],p=[],v=[];d.endReader=function(){for(var e=[],o=f.length,a=0,s=[],u=0;u<o;u++){var d=f[u];if(d.length>1)p[u-a].force=!0,i.multiLoad?e.push(t.createLineNode({points:f[u],material:p[u-a]})):c.addChild(t.createLineNode({points:f[u],material:p[u-a]}));else if(-1!=d){var g=[],v=d[0];g[0]=v.x,g[1]=v.y,g[2]=v.z;var b=t.createPointsNode({positions:g,color:new r.Color(255,0,0),size:3}),m=b.mesh3js.sceneGraph.children[0];m.getPrimitivesCount()&&(m.getPrimitiveGroup(0).gas.size=3),b.setPickParent(!0),s.push(b)}else if(a++,0!=s.length){var _=new n;_.productType="Reference3D";for(var S=0;S<s.length;S++)_.addChild(s[S]);c.addChild(_),s=[]}}i.multiLoad?i.itemDoneCB(e):(h&&h({hack:!0,updateInfinitePlane:!0}),l&&l())};var b="";if(1==i.multiLoad&&(b=i.path),b.length){var m,_=b.lastIndexOf("/");-1!=_?(_<(m=b.lastIndexOf("\\"))&&(_=m),d._strPath=b.substring(0,_)):-1!=(m=b.lastIndexOf("\\"))&&(d._strPath=b.substring(0,m))}o.load(e,b,function(r){try{d._parse(r,e,f,g,v,p)||d._errorLoader("PARSE_STR",e,!1)}catch(r){d._errorLoader(r.message,e,!1)}},function(r){console.log(r.message),d._errorLoader("LOAD_STR",e,!1)}),a&&!i.multiLoad&&a(c)},this._parse=function(e,r,t,n,i,s){var l=this;1==this.debug&&(this.method_debug="parseStr  ");var u,h=!1,d=this._decodeHeader(e,0),c=d.length;if(0==c)return!1;var f=d.lastIndexOf(".ssi");if(-1!=f){var g=d.lastIndexOf(",");u=d.substring(g+1,f+4),h=!0}var p=(d=this._decodeHeader(e,c-1)).length;if(0==p)return!1;var v=!1;"\0"===d.charAt(p-1)&&(v=!0);var b=[0,0],m=!0;if(m=v?this._parseBinarySTR(l._ensureBinary(e),c+p-1,t,n,b,i,s):this._parseAsciiSTR(l._ensureString(e),t,n,b,i,s),h){l._strPath.length&&(u=l._strPath+"/"+u);try{o.load(r,u,function(e){l._parseSsi(l._ensureString(e),n,b,i,s),l.endReader()},function(e){console.log(e.message);for(var r=new a,t=n.length,i=0;i<t;i++)s[i]=r._getLineDefault(n[i]);l.endReader()})}catch(e){h=!1}}if(!h){for(var _=new a,S=n.length,y=0;y<S;y++)s[y]=_._getLineDefault(n[y]);l.endReader()}return m},this._parseSsi=function(e,r,t,n,i){(new a)._parseSsi_lines(e,r,t,n,i)},this._parseBinarySTR=function(r,t,n,i,o,a,s){var l=0,u=0,h=0,d=[],c=new DataView(r,t),f=c.byteLength,g=c.byteOffset;if(f<33)return!1;var p=0;c.getInt32(p,!1),p+=4;for(var v=0,b=0,m=0;!(f<p+28||(u=c.getInt32(p,!1),p+=4,b=c.getFloat64(p,!1),p+=8,v=c.getFloat64(p,!1),p+=8,m=c.getFloat64(p,!1),p+=8,-1==(p=this._skipDescription(c,f,g,p)))||this._END_Description(c,f,g,p));)0!=u?(l=u,d.push(new e.Vector3(1e3*v,1e3*b,1e3*m))):(n.push(d),i.push(l),d=[],1==++h?(o[0]=l,o[1]=l):l<o[0]?o[0]=l:l>o[1]&&(o[1]=l));return!0},this._parseAsciiSTR=function(r,t,n,i,o,a){for(var s=r.split("\n"),l=0,u=0,h=[],d=s.length,c=-1,f=-1,g=2;g<d;g++){var p=s[g];if("END"===(p=p.trim()))break;var v=p.split(",");if(0!=parseInt(v[0]))-1===c&&(c=parseInt(v[0])),f=parseInt(v[0]),l=parseInt(v[0]),v.length<4?(console.log("_parseAsciiSTR  "+g+" line="+p+"\n"),console.log("_parseAsciiSTR Parse str file Error: invalid vertex data\n")):h.push(new e.Vector3(1e3*parseFloat(v[2]),1e3*parseFloat(v[1]),1e3*parseFloat(v[3])));else{if(p.endsWith("END"))break;f!==c&&(t.push([-1]),c=f),t.push(h),n.push(l),h=[],1==++u?(i[0]=l,i[1]=l):l<i[0]?i[0]=l:l>i[1]&&(i[1]=l)}}return t.push([-1]),!0},this._errorLoader=function(e,r,t){var n=this,i=e;console.log("GEOstrService error message="+i+"\n"),l.nls("GEOV1Loader/GEOV1Loader_errors",i,function(e){void 0===e&&(i="INTERNAL_ERROR"),n.errorCallbackFunc&&n.errorCallbackFunc({type:[i],url:[JSON.stringify(r)],rsc:"GEOV1Loader/GEOV1Loader_errors",level:s.error}),t&&n.renderCallbackFunc&&cope.renderCallbackFunc({hack:!0,updateInfinitePlane:!0})})}}});