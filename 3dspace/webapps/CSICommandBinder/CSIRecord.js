"undefined"==typeof define&&(define=function(e,r,t){CSIRecord=t(Parameters),define=void 0}),define("DS/CSICommandBinder/CSIRecord",["DS/ExperienceKernel/ExperienceKernel","DS/CSICommandBinder/CSIParameters","DS/ExperienceKernel/EKBinaryHelpers","DS/CSICommandBinder/CSIValueType"],function(e,r,t,o){"use strict";var i={sessionCheckerTimer_:5e3,recordForwardedToPools_:[],csiRecordClientList_:[],setCSIRecordLoggingFunctions:function(e,r,t){void 0===e?"object"==typeof console?i.log=function(e){console.log(e)}:i.log=function(){}:i.log=function(r){e(r)},void 0===r?"object"==typeof console?i.warn=function(e){console.warn(e)}:i.warn=function(){}:i.warn=function(e){r(e)},void 0===t?"object"==typeof console?i.error=function(e){console.error(e)}:i.error=function(){}:i.error=function(e){t(e)}}},n={checkSessionOnStart:function(){f.csiRecordStartUsed||this.setTimer()},checkSessionOnTimer:function(){return"undefined"!=typeof sessionStorage&&!!sessionStorage.getItem("CSI_RECORD")},onTimer:function(){n.checkSessionOnTimer()||(clearInterval(n.timeoutVar_),n.timeoutVar_=void 0,i.stop())},setTimer:function(){this.timeoutVar_=setInterval(this.onTimer,i.sessionCheckerTimer_)}},s=function(i,n,s,a,c,d){var l=function(e,r,i){var n=78+e.length,s=void 0;i&&!i.isEmpty()&&(n+=19+(s=i.toBinary()).byteLength);var a=new t.BinaryWriter(n);return a.writeUint32(o.CSIParametersGuid),a.writeString("Parameters"),a.writeUint32(82516),a.writeString("msgType"),a.writeUint8(o.uint8Type),a.writeUint8(10),a.writeString("protocol"),a.writeUint8(o.uint8Type),a.writeUint8(2),a.writeString("name"),a.writeUint8(o.stringType),a.writeString(e),a.writeString("version"),a.writeUint8(o.uint32Type),a.writeUint32(r),s&&(a.writeString("Params"),a.writeUint8(o.binaryType),a.writeUint64(s.byteLength),a.writeArrayBuffer(s)),a.createArrayBuffer()}(s,a,c),f={onBinary:function(e){if(d){var t=new r;t.fromBinary(e)&&d(t,void 0)}},onText:function(e){d&&d(void 0,e)},join:function(){}},u=new e.Multiplexer(i.eknode_,f);u.sendBinary(n,l),u.close()},a=function(){this.recorderName_="",this.targetPoolNameArray_=[]};a.prototype.clearSessionStorage=function(){sessionStorage.removeItem("CSI_RECORD"),this.recorderName_="",this.targetPoolNameArray_=[],this.csiRecordStartUsed=!1},a.prototype.setValue=function(e,r,t){return this.recorderName_=r,this.targetPoolNameArray_=e||[],this.csiRecordStartUsed=t||!1,!0},a.prototype.writeToSession=function(){var e=JSON.stringify({recorderName:this.recorderName_,poolsFilter:this.targetPoolNameArray_,csiRecordStartUsed:this.csiRecordStartUsed});sessionStorage.setItem("CSI_RECORD",e)},a.prototype.loadFromSession=function(){if("undefined"==typeof sessionStorage)return!1;var e=sessionStorage.getItem("CSI_RECORD");if(e&&"string"==typeof e){if("{"===e[0]){var r=JSON.parse(e),t=r.targetPools?r.targetPools:r.poolsFilter;return this.setValue(t,r.recorderName,r.csiRecordStartUsed)}if("true"===e)return this.setValue(void 0,"ExecGraph")}return!1};var c=function(e,r,t){this.csiNode_=e,this.nodeId_=r,this.serverPool_=t,this.started_=!1,this.recordResults_={infoPaths:[],recordPaths:[],warnings:[]}};c.prototype.callCsiRecordStart=function(e){if(!this.started_&&f.loadFromSession()){var t=new r;t.writeStringArray("targetPools",f.targetPoolNameArray_),t.writeString("recorder",f.recorderName_);var o=this;s(this.csiNode_,this.nodeId_,"recordStart",1,t,function(r){if(r){var t=r.readString("key"),n=r.readString("value");"infoPath"===t&&(o.recordResults_.infoPaths.push(n),i.log("CSIRecord activated on server, info path : "+n),e&&e(t,n)),"recordPath"===t&&(o.recordResults_.recordPaths.push(n),i.log("CSIRecord new record path : "+n),e&&e(n)),"warning"===t&&(o.recordResults_.warnings.push(n),i.log("CSIRecord warning : "+n),e&&e(n))}}),this.started_=!0}},c.prototype.callCsiRecordStop=function(e){this.started_&&(this.started_=!1,s(this.csiNode_,this.nodeId_,"recordStop",1,void 0,e))},i.start=function(e,r,t){if(i.recordResults=void 0,f.loadFromSession())i.warn("CSIRecord.start() already activated");else if("ExecGraph"===(r=r||"ExecGraph")||"JavaScript"===r)if(void 0===e||e instanceof Array)if(f.setValue(e,r,!0),f.writeToSession(),l.forwardRecordFunction_=d,0===i.csiRecordClientList_.length)i.log("CSIRecord.start() waiting for select()");else for(var o=0;o<i.csiRecordClientList_.length;++o)i.csiRecordClientList_[o].callCsiRecordStart(t);else i.error("CSIRecord.start() invalid 1st argument, targetPools must be undefined or an Array of string");else i.error("CSIRecord.start() invalid 2nd argument, recorderName must be undefined or 'ExecGraph' or 'JavaScript'")},i.stop=function(e){if(0===i.csiRecordClientList_.length)return i.log("CSIRecord.stop() no recording in progress"),void i.clear();var r={infoPaths:[],recordPaths:[],warnings:[]},t=i.csiRecordClientList_.length;i.csiRecordClientList_.forEach(function(o){o.callCsiRecordStop(function(n,s){"ok"===s&&(r.infoPaths=r.infoPaths.concat(o.recordResults_.infoPaths),r.recordPaths=r.recordPaths.concat(o.recordResults_.recordPaths),r.warnings=r.warnings.concat(o.recordResults_.warnings),0==--t&&(i.recordResults=r,i.log("CSIRecord.stop() success"),r.infoPaths.length>0&&(i.log("CSIRecord infoPaths:"),r.infoPaths.forEach(function(e){i.log(e)})),r.recordPaths.length>0&&(i.log("CSIRecord recordPaths:"),r.recordPaths.forEach(function(e){i.log(e)})),r.warnings.length>0&&(i.log("CSIRecord warnings:"),r.warnings.forEach(function(e){i.log(e)})),void 0!==e&&e(r)))})}),i.clear()},i.clear=function(){f.clearSessionStorage(),i.csiRecordClientList_=[],i.recordForwardedToPools_=[],l.forwardRecordFunction_=function(){}};var d=function(e,r,t){if(-1===i.recordForwardedToPools_.indexOf(t)){i.recordForwardedToPools_.push(t);var o=new c(e,r,t);i.csiRecordClientList_.push(o),o.callCsiRecordStart()}};i.initRecorder=function(e){l=e,f.loadFromSession()&&(n.checkSessionOnStart(),l.forwardRecordFunction_=d)};var l=void 0,f=new a;return i.setCSIRecordLoggingFunctions(),"object"==typeof window&&(window.csiRecordStart=function(){return i.start.apply(i,arguments)},window.csiRecordStop=function(){return i.stop.apply(i,arguments)}),i});