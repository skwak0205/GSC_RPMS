"undefined"==typeof define&&(define=function(e,t,n){CSICommandBinder=n(EK,AsyncType,Parameters,ErrorReport,ArgumentCheck,CSIRecord),define=void 0}),define("DS/CSICommandBinder/CSICommandBinder",["DS/ExperienceKernel/ExperienceKernel","DS/CSICommandBinder/CSIAsyncType","DS/CSICommandBinder/CSIParameters","DS/CSICommandBinder/CSIErrorReport","DS/CSICommandBinder/CSIArgumentCheck","DS/CSICommandBinder/CSIRecord"],function(e,t,n,r,o,i){"use strict";var s=2,a=Object.freeze({select:0,functionCall:1,functionSuccess:2,functionError:3,functionProgress:4,commandBegin:5,commandDo:6,commandEnd:7,commandSuccess:8,commandError:9,commandTerminate:10,interrupt:11,event:12}),d=function(){},m=0,c={},u={defaultsOptions:e.defaultsOptions,Parameters:n,poolMap_:{},forwardRecordFunction_:function(){}},p=Object.freeze({clientToServer:0,serverToClient:1,clientDisconnected:2,emit:3,serverCommandPostDelete:4,clientCommandInstanceDeleted:5,onNodeCreated:6,serverCommandPostDeleteReplayedCommand:7,clientFunctionCall:9});u.declareType=function(e){return n.prototype.declareType(e)},u.getPool=function(e){return void 0===this.poolMap_[e]&&(this.poolMap_[e]=new _(e)),this.poolMap_[e]},u.createNode=function(e,t){return this.getPool(e).createNode(t)};var l=function(e,t,n){var r=e.readString("error");return void 0===r&&(r=JSON.stringify(e.toJSObject())),t+" version "+n+" returned an error: "+r};u.createParameters=function(e,t){var r=new n;if(void 0===e&&void 0===t)return r;if("string"==typeof e&&void 0!==t){var o=n.prototype.serializeMap_[e];if(void 0!==o&&o(r,t))return r.typeName_=e,r}};var _=function(e){this.pool_=e,this.nodeCount_=1};_.prototype.createNode=function(e){(e=e||{}).pool=this.pool_;var t=new h(e);//!< each node has its own index to generate guid for commands
return t.index_=this.nodeCount_++,t};var h=function(t){"boolean"==typeof t.rdf_bypass_getActiveTypes&&(this.rdf_bypass_getActiveTypes_=t.rdf_bypass_getActiveTypes,delete t.rdf_bypass_getActiveTypes),"boolean"==typeof t.replayMode&&(this.replayMode_=t.replayMode,delete t.replayMode),this.monitorIndex_=1,this.monitorCallback_=d,this.monitorCallbackOverrideInterrupt_=function(){};var o=this;t.onBinary=function(e,t){var i=new n;if(!i.fromBinary(e))return!1;var d=i.readUint8("protocol");if(d!==s)return r.warning("CSI Web Client (version "+s+") received a message with an unsupported version "+d+"\n"),!1;if(i.readUint8("msgType")===p.emit){var m=i.readString("emit"),u=i.readParameters("Params","Parameters");return o.monitorCallback_(a.event,void 0,m,void 0,u),c[m].forEach(function(e){e.nodeId.equals(t)&&(e.callback instanceof Function?e.callback(u):e.callback instanceof y&&e.callback.callDomains(u))}),!0}return!1},this.eknode_=new e.Node(t)};function f(e,t){var o=new n;if(o.fromBinary(e)){var i=o.readUint8("protocol");if(i===s){var a=o.readUint8("msgType");return a!==p.serverToClient?a===p.clientCommandInstanceDeleted?"commandTerminated":void r.warning(t+"received unexpected callback -bad msgType- "+o.exportToString()):o}r.warning(t+"CSI Web Client (version "+s+") received a message with an unsupported version "+i)}else r.warning(t+"parameters.fromBinary() error")}function v(e,t){var n,o=e.onAnswer?e.onAnswer:e.onComplete;n=o instanceof Function?o:o instanceof y?function(e){o.callDomains(e)}:function(){};var i=e.onError;i instanceof Function||(i=function(t){r.error(l(t,e.command,e.version))});var s=e.onTerminate instanceof Function?e.onTerminate:function(){},d="command: "+e.command+"_v"+e.version+" ";return function(r){var o=f(r,d);if(void 0===o)return!1;if("string"==typeof o)return t(a.commandTerminate,e.index_,e.command,e.version),s(),!0;var m=o.readParameters("error","Parameters");return m?(t(a.commandError,e.index_,e.command,e.version,m),i(m),!0):(m=o.readParameters("Params","Parameters"))?(t(a.commandSuccess,e.index_,e.command,e.version,m),n(m),!0):void 0}}h.prototype.setMonitorCallback=function(t){t?(this.monitorCallback_=function(e,n,r,o,i){t({eventType:e,index:n,name:r,version:o,parameters:i})},this.monitorCallbackOverrideInterrupt_=function(t,n,r,o){o.interrupt=function(){e.Interruption.prototype.interrupt.apply(o,arguments),t.monitorCallback_(a.interrupt,r,n.name,n.version,n.parameters)}}):(this.monitorCallback_=d,this.monitorCallbackOverrideInterrupt_=function(){})},h.prototype.stop=function(){if(void 0!==this.eknode_)return this.eknode_.stop()},h.prototype.isPoolSelectable=function(e,t){if(void 0!==this.eknode_)return this.eknode_.isPoolSelectable(e,t)},h.prototype.createIterativeRequest=function(e){return o.check(e,"createIterativeRequest"),new C(this,e)},h.prototype.createRequest=function(e){return o.check(e,"createRequest"),new I(this,e)},h.prototype.call=function(e,r){if(!o.check(e,"callFunction"))return!1;var i=this.monitorIndex_++,a=new n;return a.writeUint8("protocol",s),a.writeUint8("msgType",p.clientFunctionCall),a.writeString("name",e.name),a.writeInt32("version",e.version),a.writeUint64("guid",i),this.replayMode_&&a.writeUint8("replay",1),e.debug&&a.writeBool("dbgMode",!0),e.parameters instanceof n?e.parameters.isEmpty()||a.writeParameters("callArgs","Parameters",e.parameters):e.parameters instanceof Object&&a.writeJSONInternal("callArgs",e.parameters),!!t.storeFunction({functionRequest:e,functionGuid:i,node:this,parameters:[a],interruption:r})||this.callInternal(e,i,a,r)},h.prototype.callInternal=function(t,r,o,i){this.monitorCallback_(a.functionCall,r,t.name,t.version,t.parameters);var s=function(e,t,r){var o=e.onSuccess instanceof Function?e.onSuccess:function(){},i=e.onError instanceof Function?e.onError:function(t){throw new Error(l(t,e.name,e.version))},s=e.onProgress instanceof Function?e.onProgress:function(){},d=!1;return{onBinary:function(n){var m=f(n,"function: "+e.name+"_v"+e.version+" ");if(void 0===m)return!1;var c=m.readParameters("Params","Parameters");return c?(d=!0,t(a.functionSuccess,r,e.name,e.version,c),o(c),!0):(c=m.readParameters("error","Parameters"))?(d=!0,t(a.functionError,r,e.name,e.version,c),i(c),!0):(c=m.readParameters("progress","Parameters"))?(t(a.functionProgress,r,e.name,e.version,c),s(c),!0):void 0},join:function(){if(!d&&"csiGetActiveTypes"!==e.name){var t=new n;t.writeInt32("errorCode",500),t.writeString("error","The connection with the server node has been closed before any success or error answer"),t.declareType("CSISystemError"),i(t)}}}}(t,this.monitorCallback_,r),d=new e.Multiplexer(this.eknode_,s);return i?(this.monitorCallbackOverrideInterrupt_(this,t,r,i),d.sendBinaryWithInterrupt(t.destinationNodeId,o.toBinary(),i)):d.sendBinary(t.destinationNodeId,o.toBinary()),d.close(),!0},h.prototype.select=function(e,r){if(this.monitorCallback_(a.select,0,e),0!==e.length){var o=void 0;o=void 0===r?this.eknode_.connect(e).select():this.eknode_.connect(e).select(r);var i=new n;return i.writeUint8("msgType",p.clientDisconnected),i.writeUint8("protocol",s),this.eknode_.sendBinaryOnDisconnection(o,i.toBinary()),!0!==this.rdf_bypass_getActiveTypes_&&t.getActiveTypes(u,this,o,e),u.forwardRecordFunction_(this,o,e),o}},h.prototype.subscribe=function(e,t,n){return null==e?r.error("INVALID USE of Node.subscribe(); the target node id is invalid."):"string"!=typeof t||""===t?r.error("INVALID USE of Node.subscribe(); the event name must be a non-null string."):n instanceof y||n instanceof Function?(this.eknode_.subscribe(e,t),c[t]=[{id:++m,nodeId:e,callback:n}],!0):r.error("INVALID USE of Node.subscribe(); the subscribe object must be a function or a response.")},h.prototype.unsubscribe=function(e,t){return null==e?r.error("INVALID USE of Node.unsubscribe(); the target node id is invalid."):"string"!=typeof t||""===t?r.error("INVALID USE of Node.unsubscribe(); the event name must be a non-null string."):(c[t]&&(this.eknode_.unsubscribe(e,t),c[t]=[]),!0)},h.prototype.subscribeToEvent=function(e,t,n){if(null==e)return r.error("INVALID USE of Node.subscribeToEvent(); the target node id is invalid."),-1;if("string"!=typeof t||""===t)return r.error("INVALID USE of Node.subscribeToEvent(); the event name must be a non-null string."),-1;if(!(n instanceof Function))return r.error("INVALID USE of Node.subscribeToEvent(); functionCB must be a Function."),-1;this.eknode_.subscribe(e,t),t in c||(c[t]=[]);var o=++m;return c[t].push({id:o,nodeId:e,callback:n}),o},h.prototype.subscribeToEventWithSubject=function(e,t,n,o){return"string"!=typeof n||""===n?(r.error("INVALID USE of Node.subscribeToEventWithSubject(); the subject name must be a non-null string."),-1):this.subscribeToEvent(e,t+"/"+n,o)},h.prototype.unsubscribeFromEvent=function(e){var t=!1,n=null,r=null;for(var o in c)if(Object.prototype.hasOwnProperty.call(c,o)){var i,s=c[o];for(i=s.length-1;i>=0;--i)if(s[i].id===e){r=o,n=s[i].nodeId,s.splice(i,1),t=!0;break}if(t){var a=!0;for(i=0;i<s.length;++i)if(n.equals(s[i].nodeId)){a=!1;break}return a&&this.eknode_.unsubscribe(n,r),!0}}return!1};var y=function(){this.domainMap_={}};y.prototype.onAnswerDomain=function(e,t){this.domainMap_[e]=t},y.prototype.hasDomain=function(e){return this.domainMap_.hasOwnProperty(e)},y.prototype.getDomainCallback=function(e){if(this.domainMap_.hasOwnProperty(e))return this.domainMap_[e]},y.prototype.getDomains=function(){return Object.keys(this.domainMap_).sort()},y.prototype.callDomains=function(e){var t=e.readStringArray("domainNames"),n=e.readParameters("domains","Parameters");if(void 0!==n&&t instanceof Array&&t.length)for(var r=0;r<t.length;r++){var o=t[r],i=n.readParameters(o,"Parameters");this.domainMap_.hasOwnProperty(o)&&i&&this.domainMap_[o](i)}};var b=function(){this.EKInterruptions_=[]};b.prototype.interrupt=function(){return this.EKInterruptions_.forEach(function(e){e.interrupt()}),this.EKInterruptions_=[],!0},b.prototype.sendBinary=function(t,n,r){var o=new e.Interruption;return this.EKInterruptions_.push(o),t.sendBinaryWithInterrupt(n,r,o)};var g=function(e,t){t.index_=e.monitorIndex_++,this.node_=e,this.commandRequest_=t,this.beginHasBeenCalled_=!1,this.csiInterruption_=new b,void 0===this.commandRequest_.destinationNodeId&&(this.commandRequest_.destinationNodeId=e.select(t.destinationPool)),this.messageHeader_=new n,this.messageHeader_.writeUint8("msgType",p.clientToServer),this.messageHeader_.writeString("command",t.command),this.messageHeader_.writeInt32("version",t.version),this.messageHeader_.writeUint8("protocol",s),this.messageHeader_.writeUint64("guid",t.index_),t.debug&&this.messageHeader_.writeBool("dbgMode",!0),e.replayMode_&&this.messageHeader_.writeUint8("replay",1)};(g.prototype={eBegin:0,eSend:1,eEnd:2}).setHeaderParameters=function(e,t){var n=void 0;if(e===g.prototype.eBegin){if(this.beginHasBeenCalled_)return r.error("INVALID USE of IterativeRequest.begin(parameters); has already been called and cannot be called anymore.");n="beginParameters",this.beginHasBeenCalled_=!0}else n=e===g.prototype.eSend?"sendParameters":"endParameters";return null==t||t.isEmpty()?this.messageHeader_.writeUint8(n,1):this.messageHeader_.writeParameters(n,"Parameters",t),!0},g.prototype.clearHeader=function(){this.messageHeader_.removeProperty("beginParameters"),this.messageHeader_.removeProperty("sendParameters"),this.messageHeader_.removeProperty("endParameters")},g.prototype.interrupt=function(){return this.node_.monitorCallback_(a.interrupt,this.commandRequest_.index_,this.commandRequest_.command,this.commandRequest_.version),this.csiInterruption_.interrupt()},g.prototype.sendEKResult=function(){var t={onBinary:v(this.commandRequest_,this.node_.monitorCallback_)},n=new e.Multiplexer(this.node_.eknode_,t);return n.sendBinary(this.commandRequest_.destinationNodeId,this.messageHeader_.toBinary()),n.close(),this.clearHeader(),!0},g.prototype.sendEKResultWithInterruption=function(){var t={onBinary:v(this.commandRequest_,this.node_.monitorCallback_)},n=new e.Interruption;this.csiInterruption_.EKInterruptions_.push(n);var r=new e.Multiplexer(this.node_.eknode_,t);return r.sendBinaryWithInterrupt(this.commandRequest_.destinationNodeId,this.messageHeader_.toBinary(),n),r.close(),this.clearHeader(),!0},g.prototype.sendMsgOnDisconnection=function(){var e=this.node_.eknode_.sendBinaryOnDisconnection(this.commandRequest_.destinationNodeId,this.messageHeader_.toBinary());return this.clearHeader(),e};var I=function(e,t){this.impl_=new g(e,t),this.command_=t.command};I.prototype.interrupt=function(){return this.impl_.interrupt()},I.prototype.send=function(e,n,o){if(3!==arguments.length&&0!==arguments.length)return r.error("INVALID USE of Request.send(beginParameters, doParameters, endParameters); requires 3 arguments (null or undefined accepted as empty parameters).");if(this.used_)return r.error("INVALID USE of Request.send(beginParameters, doParameters, endParameters); has already been called and cannot be called anymore on this one shot request.");if(t.storeFunction({commandRequest:this,userCommandRequest:this.impl_.commandRequest_,node:this.impl_.node_,parameters:[e,n,o]}))return!0;this.used_=!0,this.impl_.setHeaderParameters(g.prototype.eBegin,e),this.impl_.setHeaderParameters(g.prototype.eSend,n),this.impl_.setHeaderParameters(g.prototype.eEnd,o);var i=this.impl_.node_.monitorCallback_,s=this.impl_.commandRequest_.index_,d=this.impl_.commandRequest_.command,m=this.impl_.commandRequest_.version;return i(a.commandBegin,s,d,m,e),i(a.commandDo,s,d,m,n),i(a.commandEnd,s,d,m,o),this.impl_.sendEKResultWithInterruption()},I.prototype.sendOnDisconnection=function(e,t,n){return this.impl_.setHeaderParameters(g.prototype.eBegin,e),this.impl_.setHeaderParameters(g.prototype.eSend,t),this.impl_.setHeaderParameters(g.prototype.eEnd,n),this.impl_.sendMsgOnDisconnection(),!0};var C=function(e,t){this.impl_=new g(e,t)};return C.prototype.interrupt=function(){return this.impl_.interrupt()},C.prototype.begin=function(e){return!!t.storeFunction({iterativeCommandRequest:this,userCommandRequest:this.impl_.commandRequest_,node:this.impl_.node_,parameters:[e],iterative:0})||!!this.impl_.setHeaderParameters(g.prototype.eBegin,e)&&(this.impl_.node_.monitorCallback_(a.commandBegin,this.impl_.commandRequest_.index_,this.impl_.commandRequest_.command,this.impl_.commandRequest_.version,e),this.impl_.sendEKResult())},C.prototype.send=function(e){return!!t.storeFunction({iterativeCommandRequest:this,userCommandRequest:this.impl_.commandRequest_,node:this.impl_.node_,parameters:[e],iterative:1})||(this.impl_.setHeaderParameters(g.prototype.eSend,e),this.impl_.node_.monitorCallback_(a.commandDo,this.impl_.commandRequest_.index_,this.impl_.commandRequest_.command,this.impl_.commandRequest_.version,e),this.impl_.sendEKResultWithInterruption())},C.prototype.end=function(e){return!!t.storeFunction({iterativeCommandRequest:this,userCommandRequest:this.impl_.commandRequest_,node:this.impl_.node_,parameters:[e],iterative:2})||(this.impl_.setHeaderParameters(g.prototype.eEnd,e),this.impl_.node_.monitorCallback_(a.commandEnd,this.impl_.commandRequest_.index_,this.impl_.commandRequest_.command,this.impl_.commandRequest_.version,e),this.impl_.sendEKResult())},u.defaultResponse_=new y,u.getDefaultResponse=function(){return this.defaultResponse_},u.Response=y,u.Private={Node:h,Request:I,IterativeRequest:C},u.MonitorEventType=a,i.initRecorder(u),u});