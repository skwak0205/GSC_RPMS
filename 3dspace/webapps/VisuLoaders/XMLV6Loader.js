define("DS/VisuLoaders/XMLV6Loader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager"],function(e,t,n,a,r){"use strict";return function(o,i,l,s){var d,m,c,u=void 0!==i?i:null,p=null,f=null,h=null,x=null,g=0,v=0,N=0,y=[],w=[],M=[],A=[],b=[],C=[],S=[],B=[],k=null,L=[],G=s;function R(e){e<b.length?function(e){var t=d+"/"+b[e];if(document.implementation&&document.implementation.createDocument){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===n.readyState&&(0===n.status||200===n.status))if(n.responseXML){var a=n.responseXML.firstChild;if(a&&a.childNodes){for(var r=0;r<a.childNodes.length;){if("Links"===a.childNodes[r].nodeName){a=a.childNodes[r];break}r++}if(a&&a.childNodes)for(var r=0;r<a.childNodes.length;r++){var o=a.childNodes[r];if("Link"===o.nodeName){var i=o.getAttribute("Source"),l=o.getAttribute("Target"),s=o.getAttribute("id");C[s]={source:i,target:l}}}}R(e+1)}else console.error("XMLV6Loader: Empty or non-existing file ("+t+")")},n.open("GET",t,!0),n.overrideMimeType&&n.overrideMimeType("text/xml"),n.send(null)}else alert("Don't know how to parse XML!")}(e):D(0)}function D(o){o<S.length?function(e){var t=d+"/"+S[e];if(document.implementation&&document.implementation.createDocument){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===n.readyState&&(0===n.status||200===n.status))if(n.responseXML){var a=n.responseXML.firstChild;if(a&&a.childNodes){for(var o=0;o<a.childNodes.length;){if("AppliedAppearanceGroup"===a.childNodes[o].nodeName){a=a.childNodes[o];break}o++}if(a&&a.childNodes)for(var i=new r,o=0;o<a.childNodes.length;o++){var l=a.childNodes[o];if("AppliedAppearance"===l.nodeName){var s=l.getAttribute("id"),m=F(l);B[s]=i.createMaterial(m,d+"/resources","XMLV6")}}}D(e+1)}else console.error("XMLV6Loader: Empty or non-existing file ("+t+")")},n.open("GET",t,!0),n.overrideMimeType&&n.overrideMimeType("text/xml"),n.send(null)}else alert("Don't know how to parse XML!")}(o):function(){if(m=d+"/"+m,document.implementation&&document.implementation.createDocument){var o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===o.readyState&&(0===o.status||200===o.status)){if(o.responseXML){var i=o.responseXML.firstChild;if(i&&i.childNodes){for(var l=0;l<i.childNodes.length;l++){var s=i.childNodes[l];if("Product"===s.nodeName||"ProductInst"===s.nodeName||"RepUsage"===s.nodeName){var y=s.getAttribute("id"),b=new n;switch(b.name=y,b.getPersistentId=function(){return this.name},s.nodeName){case"Product":L[y]=b,null===k&&(k=b);break;case"ProductInst":L[y]=b;for(var S="",R="",D=null,F=0;F<s.childNodes.length;F++){var W=s.childNodes[F];if("Owned"===W.nodeName)S=W.getAttribute("idref");else if("Instancing"===W.nodeName)R=W.getAttribute("idref");else if("RelativeTransformation3D"===W.nodeName)for(var V=0;V<W.childNodes.length;V++){var T=W.childNodes[V];if("Translation3D"===T.nodeName){var P=X(T.textContent);3===P.length&&(null===D&&(D=new e.Matrix4),D.setPosition(new e.Vector3(1e3*P[0],1e3*P[1],1e3*P[2])))}else if("Rotation3D"===T.nodeName){var P=X(T.textContent);if(9===P.length){null===D&&(D=new e.Matrix4);var U=[P[0],P[3],P[6],P[1],P[4],P[7],P[2],P[5],P[8]];D.setRotation(U)}}}}null!==D&&b.setMatrix(D),""!==S&&""!==R&&(L[S].addChild(b),b.addChild(L[R]));break;case"RepUsage":L[y]=b;for(var S="",R="",z={},F=0;F<s.childNodes.length;F++){var W=s.childNodes[F];if("Owned"===W.nodeName)S=W.getAttribute("idref");else if("Instancing"===W.nodeName)R=W.getAttribute("linkidref");else if("BoundingBox"===W.nodeName)for(var V=0;V<W.childNodes.length;V++){var I=W.childNodes[V];"MinPoint"===I.nodeName?z.min=X(I.textContent):"MaxPoint"===I.nodeName&&(z.max=X(I.textContent))}}if(""!==S&&""!==R){L[S].addChild(b);var $=C[R].target;w[$]=b,void 0!==z.min?M[b.name]=$:A.push($),v++,N++}if(void 0!==z.min&&void 0!==z.max){var H=E(z);b.addChild(H)}}}}null!==k&&c.addChild(k)}}else console.error("XMLV6Loader: Empty or non-existing file ("+m+")");!function(){null!==x&&(x.terminate(),x=null),null===x&&((x="3dxmlgeometry"===G?new Worker(t.getWebappsBaseUrl()+"Workers/XMLV6Worker.js"):new Worker(t.getWebappsBaseUrl()+"Workers/CGRWorker.js")).onmessage=function(t){var n=t.data,o=w[n.node];if(g--,v--,o){var i=null;i=n.rep.length>0?function(t){for(var n=null,o=[],i=null,l=null,s=new e.Sphere,d=new e.Box3,m=new r,c=0;c<t.length;c++){var u=t[c],p=new e.BufferGeometryDS,f=new e.Vector3(u.AABB.min[0],u.AABB.min[1],u.AABB.min[2]),h=new e.Vector3(u.AABB.max[0],u.AABB.max[1],u.AABB.max[2]);null===i&&(i=f),null===l&&(l=h),f.x<i.x&&(i.x=f.x),f.y<i.y&&(i.y=f.y),f.z<i.z&&(i.z=f.z),h.x>l.x&&(l.x=h.x),h.y>l.y&&(l.y=h.y),h.z>l.z&&(l.z=h.z),d.set(i,l),s.radius=l.clone().sub(i).multiplyScalar(.5).length(),s.center=l.clone().add(i).multiplyScalar(.5);for(var x=0;x<u.drawingGroups.length;x++){u.drawingGroups[x].geometry=p;var g=u.drawingGroups[x].gas,v=u.drawingGroups[x].material;if(null!==v&&(v=v.id),null!==v&&C[v]){var N=C[v].target,y=[];y=N.split("#"),u.drawingGroups[x].gas=B[y[1]]}else if(null!==g){var w=new e.Color;w.setRGB(g.color.r,g.color.g,g.color.b),u.drawingGroups[x].gas=m.getMaterialFromGAS({color:w,opacity:g.opacity,lineWidth:g.lineWidth?g.lineWidth:g.linewidth,solid:g.solid})}}p.drawingGroups=u.drawingGroups,p.vertexPositionArray=u.vertexPositionArray,null!==u.vertexNormalArray&&(p.vertexNormalArray=u.vertexNormalArray),null!==u.vertexUvArray&&(p.vertexUvArray=u.vertexUvArray),p.vertexIndexArray=u.vertexIndexArray,o.push(p)}var M=new e.Color;M.setRGB(t[0].gas.fill.color.r,t[0].gas.fill.color.g,t[0].gas.fill.color.b);var A=new e.Color;return A.setRGB(t[0].gas.line.color.r,t[0].gas.line.color.g,t[0].gas.line.color.b),(v=m.getMaterialFromGAS({color:M,opacity:t[0].gas.fill.opacity,solid:t[0].gas.fill.solid})).line=m.getMaterialFromGAS({color:A,opacity:t[0].gas.line.opacity,lineWidth:t[0].gas.line.lineWidth?t[0].gas.line.lineWidth:t[0].gas.line.linewidth}),o.boundingSphere=s,o.boundingBox=d,(n=new e.Mesh(o,v)).matrixAutoUpdate=!1,n.castShadow=!0,n.receiveShadow=!0,new a(n)}(n.rep):function(){var t=new e.BufferGeometryDS;t.boundingSphere=new e.Sphere,t.boundingBox=new e.Box3;var n=e.MaterialUtils.createShinyFaceMaterial(),r=new e.Mesh(t,n);return r.matrixAutoUpdate=!1,r.castShadow=!0,r.receiveShadow=!0,new a(r)}(),o.removeChild(o.getChildByName("BBox")),o.addChild(i),o.setVisibility(!0)}null!==h&&h({loaded:N-v,total:N}),null!==u&&u({hack:!0,updateInfinitePlane:!0}),v||null===f||f()}),g+=A.length;for(var n=0;n<A.length;n++){var o=A[n];if(void 0!==o){var i=d+"/3dxmlcontent/"+o;""!==o&&x&&x.postMessage({path:i,node:o})}}p&&p(c)}()}},o.open("GET",m,!0),o.overrideMimeType&&o.overrideMimeType("text/xml"),o.send(null)}else alert("Don't know how to parse XML!")}()}function F(e){for(var t={},n=null,a=0;a<e.childNodes.length;a++)if("ShadingModel"===e.childNodes[a].nodeName){n=e.childNodes[a];break}if(n)for(a=0;a<n.childNodes.length;a++){var r=n.childNodes[a];switch(r.nodeName){case"IlluminationModel":"PHONG"===r.textContent&&(t.shading="Phong");break;case"DiffuseColor":t.colorDiffuse=W(r.textContent);break;case"SpecularColor":t.colorSpecular=W(r.textContent);break;case"AmbientColor":t.colorAmbient=W(r.textContent);break;case"SpecularCoefficient":t.specularCoef=parseFloat(r.textContent);break;case"SpecularExponent":t.shininess=128*parseFloat(r.textContent);break;case"ReflectivityCoefficient":t.reflectivityCoef=parseFloat(r.textContent);break;case"TransparencyCoefficient":t.transparency=parseFloat(r.textContent),t.transparent=t.transparency>0;break;case"DiffuseMap":case"ReflectionMap":var o=-1,i=-1,l=-1,s=-1,d=1,m=1;t[r.nodeName+"Wrap"]=[];for(var c=0;c<r.childNodes.length;c++){var u=r.childNodes[c];switch(u.nodeName){case"WrappingU":o="REPEAT"===u.textContent?1:0;break;case"WrappingV":i="REPEAT"===u.textContent?1:0;break;case"FlipU":l="true"===u.textContent?1:-1;break;case"FlipV":s="true"===u.textContent?1:-1;break;case"ScaleU":d=parseFloat(u.textContent);break;case"ScaleV":m=parseFloat(u.textContent);break;case"MapFile":t[r.nodeName]=C[u.textContent].target}}(o>=0||i>=0)&&(1===o&&(t[r.nodeName+"Wrap"][0]="repeat"),1===i&&(t[r.nodeName+"Wrap"][1]="repeat"),t[r.nodeName+"Repeat"]=[o,i],1!==d&&(t[r.nodeName+"Repeat"][0]=d),1!==m&&(t[r.nodeName+"Repeat"][1]=m)),1===l&&(t[r.nodeName+"Wrap"][0]="mirror"),1===s&&(t[r.nodeName+"Wrap"][1]="mirror")}}return t}function W(e){var t=[],n=new RegExp(/RGB\(\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*\)/i),a=n.exec(e);return null!==a?(t[0]=parseFloat(RegExp.$1),t[1]=parseFloat(RegExp.$2),t[2]=parseFloat(RegExp.$3)):null!==(a=(n=new RegExp(/RGBA\(\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*\)/i)).exec(e))&&(t[0]=parseFloat(RegExp.$1),t[1]=parseFloat(RegExp.$2),t[2]=parseFloat(RegExp.$3),t[3]=parseFloat(RegExp.$4)),t}function X(e){for(var t=function(e){return e.length>0?function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}(e).split(/\s+/):[]}(e),n=[],a=0,r=t.length;a<r;a++)n.push(parseFloat(t[a]));return n}function E(t){for(var n=new e.BufferGeometryDS,o=new Float32Array(72),i=new Float32Array(72),l=new Uint16Array(36),s=0,d=0,m=0,c=0;c<6;c++)l[d++]=m,l[d++]=m+1,l[d++]=m+2,l[d++]=m,l[d++]=m+2,l[d++]=m+3,m+=4;for(var u=0;u<12;u+=3)i[s+u]=0,i[s+u+1]=-1,i[s+u+2]=0;for(o[s++]=t.min[0],o[s++]=t.min[1],o[s++]=t.min[2],o[s++]=t.max[0],o[s++]=t.min[1],o[s++]=t.min[2],o[s++]=t.max[0],o[s++]=t.min[1],o[s++]=t.max[2],o[s++]=t.min[0],o[s++]=t.min[1],o[s++]=t.max[2],u=0;u<12;u+=3)i[s+u]=0,i[s+u+1]=1,i[s+u+2]=0;for(o[s++]=t.min[0],o[s++]=t.max[1],o[s++]=t.min[2],o[s++]=t.min[0],o[s++]=t.max[1],o[s++]=t.max[2],o[s++]=t.max[0],o[s++]=t.max[1],o[s++]=t.max[2],o[s++]=t.max[0],o[s++]=t.max[1],o[s++]=t.min[2],u=0;u<12;u+=3)i[s+u]=0,i[s+u+1]=0,i[s+u+2]=1;for(o[s++]=t.max[0],o[s++]=t.max[1],o[s++]=t.max[2],o[s++]=t.min[0],o[s++]=t.max[1],o[s++]=t.max[2],o[s++]=t.min[0],o[s++]=t.min[1],o[s++]=t.max[2],o[s++]=t.max[0],o[s++]=t.min[1],o[s++]=t.max[2],u=0;u<12;u+=3)i[s+u]=0,i[s+u+1]=0,i[s+u+2]=-1;for(o[s++]=t.min[0],o[s++]=t.min[1],o[s++]=t.min[2],o[s++]=t.min[0],o[s++]=t.max[1],o[s++]=t.min[2],o[s++]=t.max[0],o[s++]=t.max[1],o[s++]=t.min[2],o[s++]=t.max[0],o[s++]=t.min[1],o[s++]=t.min[2],u=0;u<12;u+=3)i[s+u]=1,i[s+u+1]=0,i[s+u+2]=0;for(o[s++]=t.max[0],o[s++]=t.min[1],o[s++]=t.min[2],o[s++]=t.max[0],o[s++]=t.max[1],o[s++]=t.min[2],o[s++]=t.max[0],o[s++]=t.max[1],o[s++]=t.max[2],o[s++]=t.max[0],o[s++]=t.min[1],o[s++]=t.max[2],u=0;u<12;u+=3)i[s+u]=-1,i[s+u+1]=0,i[s+u+2]=0;o[s++]=t.min[0],o[s++]=t.min[1],o[s++]=t.max[2],o[s++]=t.min[0],o[s++]=t.max[1],o[s++]=t.max[2],o[s++]=t.min[0],o[s++]=t.max[1],o[s++]=t.min[2],o[s++]=t.min[0],o[s++]=t.min[1],o[s++]=t.min[2];var p=(new r).getMaterialFromGAS({color:new e.Color(16729156),opacity:0});n.drawingGroups=[],n.drawingGroups.push({start:0,count:36,glType:4,gas:p});var f=new e.Vector3(t.min[0],t.min[1],t.min[2]),h=new e.Vector3(t.max[0],t.max[1],t.max[2]),x=h.clone().sub(f).multiplyScalar(.5).length(),g=h.clone().add(f).multiplyScalar(.5);n.boundingSphere=new e.Sphere(g,x),n.boundingBox=new e.Box3(f,h),n.vertexPositionArray=o,n.vertexNormalArray=i,n.vertexIndexArray=l;var v=new e.Mesh(n,p);return v.matrixAutoUpdate=!1,new a(v,"BBox")}this.setGeometryMode=function(e){G=e},this.load=function(e,t,a,r){p=null,f=null,h=null,d="",g=0,v=0,N=0,y=[],w=[],M=[],A=[],b=[],C=[],S=[],B=[],m="",k=null,L=[],c=null,d=e;var o=e+"/Manifest.3dxml";if(document.implementation&&document.implementation.createDocument){var i=new XMLHttpRequest;i.onreadystatechange=function(){4===i.readyState&&(0!==i.status&&200!==i.status||(i.responseXML?(p=t,f=r,h=a,function(e){var t=e.firstChild;if(t&&t.childNodes)for(var a=0;a<t.childNodes.length;a++){var r=t.childNodes[a];switch(r.nodeName){case"XMLContent":var o=r.getAttribute("Domain"),i=r.getAttribute("Location"),l=r.getAttribute("Name");"Geometry"===o?y.push({path:i,filename:l}):"Material"===o?S.push(i+"/"+l):"Link"===o?b.push(i+"/"+l):"Product3D"===o&&"Product.3dxmlproduct3d"===l&&(m=i+"/"+l)}}c=new n,b.length&&R(0)}(i.responseXML)):console.error("XMLV6Loader: Empty or non-existing file ("+o+")")))},i.open("GET",o,!0),i.overrideMimeType&&i.overrideMimeType("text/xml"),i.send(null)}else alert("Don't know how to parse XML!")},this.loadGeometryFiles=function(e){var t=Math.min(e.length,1);g+=t;for(var n=0;n<t;n++){var a=M[e[n].name];if(void 0!==a){var r=d+"/3dxmlcontent/"+a;""!==a&&x&&x.postMessage({path:r,node:a}),delete M[e[n].name]}}},this.isWebWorkerBusy=function(){return g>0}}});