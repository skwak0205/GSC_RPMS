define("DS/VisuLoaders/ParticlesLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/Visualization/GeometryHelper","DS/Visualization/Utils","DS/Visualization/ProxyAbstraction","DS/Animation/PropertyAnimation","DS/Visualization/SceneGraphFactory"],function(e,o,a,t,r,i,n,l){"use strict";return function(o,a){var s=void 0!==a?a:null,p=[],m=null;this.load=function(o,a,c,f){var u=new i;r.setProxyFromSpec(o,u);var v=o.serverurl?o.serverurl:"";v+=o.filename?o.filename:"",u.executeGetHttpRequest(v,"text",null,function(o){var r=JSON.parse(o),i=new e.MeshBasicMaterial({side:e.FrontSide,transparent:!0,blending:e.NormalBlending,defines:{MAX_STEPS:256,TM_MIN:.05,EPS:1e-4,PI:3.14159265,HALFPI:1.57079633,ROOTTHREE:1.73205081}});i.activatePDSFX();var c={nbCol:{type:"i",value:0,stage:e.FragmentStage},map0:{type:"t2",value:null},mapDim:{type:"v3",value:new e.Vector3},uTMK:{type:"f",value:16},modelMatrixInv:{type:"m4",value:new e.Matrix4}};i.setPDSFXUniforms(c),i.setPDSFXVaryings({worldPos:{type:"v3"},objPos:{type:"v3"},camPosLocal:{type:"v3"}});var u=["#define MAX_STEPS 256","#define TM_MIN 0.05","#define EPS 0.0001","#define PI 3.14159265","#define HALFPI 1.57079633","#define ROOTTHREE 1.73205081"].join("\n"),v={ComputeVaryingValues:["void ComputeVaryingValues() {","objPos = vGetAttribPosition();","worldPos = ( modelMatrix * vec4(objPos, 1.0) ).xyz;","vec3 camPos = vGetWorldEyePos();","camPosLocal = (modelMatrixInv * vec4(camPos, 1.0)).xyz;","}"].join("\n")},d=u,x=[u,"float stepSize;","float nbTexelsX;","float nbTexelsY;","const vec3 weight = vec3(1.0, 0.04, 0.01);","vec4 sampleVolTex(vec3 pos) {","float rowID = floor(pos.z / float(nbCol));","float rowID2 = rowID;","float colID = mod(floor(pos.z), float(nbCol));","float colID2 = mod(ceil(pos.z), float(nbCol));","if (colID2 == 0.0) { rowID2 = rowID2 + 1.0; }","float x1 = colID  * mapDim.x + pos.x;","float x2 = colID2 * mapDim.x + pos.x;","float y1 = rowID  * mapDim.y + pos.y;","float y2 = rowID2 * mapDim.y + pos.y;","vec2 mapUV  = vec2(x1 / nbTexelsX, 1.0 - y1 / nbTexelsY);","vec2 mapUV2 = vec2(x2 / nbTexelsX, 1.0 - y2 / nbTexelsY);","vec4 alpha1 = texture2D(map0, mapUV);","vec4 alpha2 = texture2D(map0, mapUV2);","return mix(alpha1, alpha2, fract(pos.z));","}","vec4 raymarchNoLight(vec3 ro, vec3 rd) {","vec3 step = rd * stepSize;","vec3 pos = ro;","vec3 col = vec3(0.0);","float tm = 1.0;","for (int i=0; i<MAX_STEPS; ++i) {","vec4 rgba = sampleVolTex(pos);","float dtm = exp( -uTMK * stepSize * dot(rgba.rgb, weight) * 0.01 );","tm *= dtm;","col += (1.0 - 0.995*dtm) * rgba.rgb * rgba.rgb * tm;","pos += step;","if (tm < 0.0 || pos.x > mapDim.x - 1.0 || pos.x < 0.0 || pos.y > mapDim.y - 1.0 || pos.y < 0.0 || pos.z > mapDim.z - 1.0 || pos.z < 0.0)","break;","}","float alpha = 1.0 - tm;","return vec4(col / alpha, alpha);","}"].join("\n"),y={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","vec3 ro = objPos;","vec3 rd = normalize(ro - camPosLocal);","stepSize = max(mapDim.x, max(mapDim.y, mapDim.z)) * ROOTTHREE / float(MAX_STEPS);","nbTexelsX = float(nbCol) * mapDim.x;","nbTexelsY = float(nbCol) * mapDim.y;","ioFinalColor = raymarchNoLight(ro, rd);","}"].join("\n")};i.setPDSFXGlobalShaderCode(d,x),i.setPDSFXOverridableFunctions(v,y),i.force=!0;for(var D=r.results.length,h=new e.Vector3(1e4,1e4,1e4),S=new e.Vector3(-1e4,-1e4,-1e4),b=0;b<D;b++)for(var P=r.results[b].positions,g=0;g<P.length;g++)P[g].X<h.x&&(h.x=P[g].X),P[g].Y<h.y&&(h.y=P[g].Y),P[g].Z<h.z&&(h.z=P[g].Z),P[g].X>S.x&&(S.x=P[g].X),P[g].Y>S.y&&(S.y=P[g].Y),P[g].Z>S.z&&(S.z=P[g].Z);var w=new e.Vector3(S.x-h.x+1,S.y-h.y+1,S.z-h.z+1),M=Math.ceil(Math.sqrt(w.z));for(p=[],b=0;b<D;b++){for(p[b]=new Uint8Array(4*M*M*w.x*w.y),g=0;g<M*M*w.x*w.y;g++)p[b][4*g]=0,p[b][4*g+1]=0,p[b][4*g+2]=0,p[b][4*g+3]=0;for(P=r.results[b].positions,g=0;g<P.length;g++){var z=P[g].X-h.x,T=P[g].Y-h.y,V=P[g].Z-h.z,F=V%M,I=(Math.floor(V/M)*w.y+T)*(M*w.x)+F*w.x+z;p[b][4*I]=255*P[g].R,p[b][4*I+1]=255*P[g].G,p[b][4*I+2]=255*P[g].B,p[b][4*I+3]=Math.min(128,255*Math.pow(2*P[g].V,.8))}}(m=new e.DataTexture(p[0],M*w.x,M*w.y,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter)).generateMipmaps=!1,m.needsUpdate=!0;var X=null,C=new function(){this._nbLoops=5,this._duration=5e4,this.duration=function(){return this._duration},this.valueAt=function(e){var o=this._duration/this._nbLoops;return e%o/o}},A=new n({map:m,buffer:p,animate:function(o){var a=Math.floor(o*this.buffer.length);if(this.map.image.data=this.buffer[a],this.map.needsUpdate=!0,X){var t=new e.Matrix4;t.getInverse(X._occurrences[0].renderable.matrixWorld),i.updatePDSFXUniform("modelMatrixInv",t)}null!==s&&s()}},"animate",C);A.setLoop(1),A.start(),i.updatePDSFXUniform("nbCol",M),i.updatePDSFXUniform("map0",m),i.updatePDSFXUniform("mapDim",(new e.Vector3).copy(w));var L=(new t).CreateVis3DCuboid({cornerPoint:new e.Vector3,firstAxis:new e.Vector3(w.x-1,0,0),secondAxis:new e.Vector3(0,w.y-1,0),thirdAxis:new e.Vector3(0,0,w.z-1)});X=l.createMeshNode(L);var E=(new e.Matrix4).makeTranslation(h.x,h.y,h.z);return X.setSSAO(!1),X.setMatrix(E),X.setMaterial(i),a&&a(X),void(f&&f())})}}});