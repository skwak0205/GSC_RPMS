define("DS/VisuLoaders/ThreeDXLoader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Visualization/MaterialApplication","DS/Visualization/LightNode3D","DS/SceneGraphNodes/DirectionalLightNode","DS/SceneGraphNodes/SpotLightNode","DS/SceneGraphNodes/PointLightNode","DS/Visualization/Viewpoint","DS/Visualization/Ambience","DS/ZipJS2/ZipJS2","DS/Visualization/KDTree"],function(e,t,i,a,r,o,s,n,l,p,u,c,d,h,f,m){"use strict";var g=e.NoOccurrences,v=window.newMaterialInheritance,b=!1,y=!1;window.displayDebugThreeDXLoader=function(e,t){b=e,y=t};var x=function(e){b&&console.log("3DX Loader >> "+e)},M=function(e,t){y&&console.log("3DX Loader texture not supported >> component: "+e+" format: "+t)},w={indexMap:null,indices:null,positions:null,normals:null},T={1:"vertexPositionArray",2:"vertexNormalArray",4:"vertexUvArray",8:"vertexUv2Array",16:"vertexColorArray",32:"vertexTangentArray",64:"vertexBinormalArray"},A={1:3,2:3,4:2,8:2,16:4,32:3,64:3},S={1:0,2:3,4:6,8:8,16:10,32:14,64:17},C={NEAREST:e.NearestFilter,NEAREST_MIPMAP_NEAREST:e.NearestMipMapNearestFilter,NEAREST_MIPMAP_LINEAR:e.NearestMipMapLinearFilter,LINEAR:e.LinearFilter,LINEAR_MIPMAP_NEAREST:e.LinearMipMapNearestFilter,LINEAR_MIPMAP_LINEAR:e.LinearMipMapLinearFilter},O={REPEAT:e.RepeatWrapping,CLAMP_TO_EDGE:e.ClampToEdgeWrapping,CLAMP_TO_BORDER:e._ClampToBorderWrapping,MIRRORED_REPEAT:e.MirroredRepeatWrapping},G={POINTS:0,LINES:1,TRIANGLES:4},D={Physical:"PhysicalMaterial",Phong:"MeshPhongMaterial",PointBasic:"ParticleBasicMaterial",LineBasic:"LineBasicMaterial",MeshBasic:"MeshBasicMaterial",Visu_Basic:"_CATGraphicalMaterial",DSPBR:"DSPBR19xMaterial",EVisuPBR:"DSPBR19xMaterial",DSPBR2021x:"DSPBR21xMaterial","DSPBR 2021x":"DSPBR21xMaterial","DSPBR 2022x":"DSPBR22xMaterial","DSPBR 2023x":"DSPBR23xMaterial",PDSFX:"DSPBR19xMaterial"},B={NO_INHERIT:0,INHERIT:1,FORCE_INHERIT:2},R=e.MappingType,L=new e.Matrix3,P=function(t){var i=null;return 16==t.length?i=new e.Matrix3(t[0],t[4],t[12],t[1],t[5],t[13],t[3],t[7],t[15]):9==t.length&&(i=new e.Matrix3(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8])),i.isIdentity()?L:i},I={diffuse:"diffuse",emissive:"emissionColor",specular:"specular",opacity:"opacity",glossiness:"roughness",anisotropy:"anisotropy",anisotropyAngle:"anisotropyAngle",metalness:"metalness",fresnelTransparency:"transparency",coatingSpecular:"clearCoatColor",coatingNormalMap:"clearCoatNormal",normalMap:"normal",normalScale:"normalScale",bumpMap:"bump",bumpScale:"bumpScale",displacement:"displacement"},N={normal:"normal",opacity:"opacity",anisotropy:"anisotropy",anisotropyRotation:"anisotropyAngle",displacement:"displacement",thickness:"thickness",albedo:"diffuse",metallic:"metalness",roughness:"roughness",transparency:"transparency",cutoutOpacity:"opacity",translucency:"translucency",translucencyColor:"translucencyColor",sheen:"sheen",sheenColor:"sheenColor",sheenRoughness:"sheenRoughness",specularTint:"specular",specular:"specularContrib",clearcoat:"clearCoat",clearcoatRoughness:"clearCoatRoughness",clearcoatNormal:"clearCoatNormal",emissionColor:"emissionColor",flakeColor:"flakesColor",flakeSize:"flakesSize",flakeCoverage:"flakesCoverage",flakeRoughness:"flakesRoughness",flipFlopColor:"flipFlopColor",flipFlop:"flipFlop",iridescence:"iridescence",iridescenceThickness:"iridescenceThickness"},F=function(e){this.options={},this.isGAS=!0,this.id="",this.data=e};F.prototype.read=function(e,t,i){this.options={visible:e.visible,force:!0,side:e.side,transparent:e.transparent,depthTest:e.depthTest,depthWrite:e.depthWrite},this.id="VIS"+this.options.visible+"S"+this.options.side+"T"+this.options.transparent,this.id+="DT"+this.options.depthTest+"DW"+this.options.depthWrite,void 0!==e.NRECompatibility&&(this.options.NRECompatibility=e.NRECompatibility),e.needTangentBinormal&&(this.options.needTangentBinormal=e.needTangentBinormal),e.alphatTest&&(e.alphaTest=e.alphatTest),e.alphaTest&&(!0===e.alphaTest?this.options.alphaTest=.5:this.options.alphaTest=e.alphaTest),e.vertexColors&&(this.options.vertexColors=e.vertexColors),void 0!==e.iterative&&(this.options.iterative=e.iterative),void 0!==e.sslr&&(this.options.sslr=e.sslr),void 0!==e.useGASColor&&(this.options.useGASColor=!!e.useGASColor)};var U=function(e){this.options={force:!0},this.isGAS=!1,this.data=e,this.id=""};U.prototype.read=function(e,t,i){if(void 0!==e.useGASColor&&(this.options.useGASColor=!!e.useGASColor),void 0!==e.shaderName&&(this.options.shaderName=e.shaderName),void 0!==e.baseMaterial&&(this.options.baseMaterial=e.baseMaterial,this.options.useBaseMaterial=!0),void 0!==e.activeTechnique&&(this.options.activeTechnique=!!e.activeTechnique),void 0!==e.shaderParameters){var a=e.shaderParameters;this.options.shaderParameters={};for(var r=0;r<a.length;r++)if(a[r]&&a[r].parameterName&&a[r].parameterValue)if(a[r].parameterType&&"ParamTypeTexture"===a[r].parameterType){this.data.textures[a[r].parameterValue].texture;this.options.shaderParameters[a[r].parameterName]=valuee}else this.options.shaderParameters[a[r].parameterName]=a[r].parameterValue}};var _=function(e){F.call(this,e)};(_.prototype=Object.create(F.prototype)).buildGenericColor=function(t,i,a,r){if(void 0!==t[i]){var o=t[i];this.options[a]=(new e.Color).setRGB(o[0],o[1],o[2]),null!==r&&(this.id+=r+this.options[a].getStyle())}},_.prototype.buildGenericFloat=function(e,t,i,a){if(void 0!==e[t]){var r=e[t];"shininess"===t&&r<1&&0===(r*=255)&&(r=30),this.options[i]=r,null!==a&&(this.id+=a+this.options[i])}},_.prototype.buildGenericMap=function(e,t,i,a){if(void 0!==e[t]){this.isGAS=!1;var r=this.data.textures[e[t]].texture;this.options[i]=r,this.options.transparent=this.options.transparent||"opacityMap"===i,a&&(this.options[i+"Linear"]=!this.options[i].sRGB)}},_.prototype.read=function(t,i,a){if(F.prototype.read.apply(this,arguments),this.buildGenericFloat(t,"opacity","opacity","O"),this.buildGenericColor(t,"color","color","C"),this.buildGenericColor(t,"ambient","ambient","A"),this.buildGenericColor(t,"emissive","emissive","E"),this.buildGenericColor(t,"specular","specular","SP"),this.buildGenericFloat(t,"shininess","shininess","SH"),this.buildGenericMap(t,"specularMap","specularMap",!0),this.buildGenericMap(t,"opacityMap","opacityMap",!1),void 0!==t.diffuseMap){this.isGAS=!1;var r=this.data.textures[t.diffuseMap];if(this.options.map=r.texture,void 0!==t.diffuseMapBlendFunc?this.options.textureBlending=e.TextureBlendOperations[t.diffuseMapBlendFunc]:this.options.color&&"material"===i.content&&this.options.color.setRGB(1,1,1),r.lods){this.options.map.setAsLOD(i.switchLODTextureCB?i.switchLODTextureCB:a);for(var o=0;o<r.lods.length;o++)this.options.map.lods.push(new e.LODTextureData(r.lods[o].textureData,null,r.lods[o].loadCB,r.lods[o].format,r.lods[o].basisUsage))}}if(void 0!==t.normalMap&&(this.options.normalMap=this.data.textures[t.normalMap].texture,this.options.needTangentBinormal=!0,void 0!==t.needTangentBinormal&&(this.options.needTangentBinormal=t.needTangentBinormal),this.isGAS=!1),void 0!==t.normalMapFlipY&&(this.options.normalMapFlipY=t.normalMapFlipY),void 0!==t.bumpMap&&(this.options.bumpMap=this.data.textures[t.bumpMap].texture,this.isGAS=!1),void 0!==t.normalMapScale&&(this.options.normalScale=t.normalMapScale),void 0!==t.bumpMapScale&&(this.options.bumpScale=t.bumpMapScale),void 0!==t.size&&(this.options.size=t.size),void 0!==t.sizeAttenuation&&(this.options.sizeAttenuation=t.sizeAttenuation),void 0!==t.lineWidth&&(this.options.lineWidth=t.lineWidth),void 0!==t.envMap&&(this.options.envMap=this.data.textures[t.envMap].texture,this.isGAS=!1),void 0!==t.refractionRatio&&(this.options.refractionRatio=t.refractionRatio,this.isGAS=!1),void 0!==t.refractionRatioMap&&(this.options.refractionRatioMap=this.data.textures[t.refractionRatioMap].texture,this.isGAS=!1),this.options.useGASColor=!1,void 0!==t.uv0Transform){this.options.mappingType||(this.options.mappingType=0);var s=t.uv0Transform;this.options.mappingUVTransformation=new e.Matrix3(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8])}};var k=function(e){_.call(this,e),this.isGAS=!1};(k.prototype=Object.create(_.prototype))._startread=function(e,t,i){F.prototype.read.call(this,e,void 0,void 0),this.options.NRECompatibility=!0,this.options.useAlphaFromDiffuseMap=!1},k.prototype.read=function(t,i,a){this._startread(t,i,a);var r=i.version>=4;this.buildGenericColor(t,"DiffuseColor","color",null),this.buildGenericColor(t,"SpecularColor","specular",null),void 0!==t.DiffuseCoeff&&this.options.color.multiplyScalar(t.DiffuseCoeff),void 0!==t.SpecularCoeff&&this.options.specular.multiplyScalar(t.SpecularCoeff),this.buildGenericFloat(t,"TransparencyCoeff","opacity",null),void 0!==this.options.opacity&&(this.options.opacity=1-this.options.opacity,this.options.transparent=this.options.transparent||this.options.opacity<.999),this.buildGenericFloat(t,"ReflectionCoeff","reflectivity",null);var o=e.MaterialUtils.convertShininessToIoRRoughness(t.ShininessCoeff?t.ShininessCoeff:0);if(Object.assign(this.options,o),void 0!==t.UseAlphaChannel&&(this.options.useAlphaFromDiffuseMap=!!t.UseAlphaChannel,this.options.transparent=this.options.transparent||this.options.useAlphaFromDiffuseMap),this.buildGenericMap(t,"Texture","map",null),this.options.textureBlending=e.TextureBlendOperations.REPLACE,this.options.map){var s=this.data.textures[t.Texture];if(s.mapping&&!r){var n=s.mapping;if(n.uvTransform&&(this.options.diffuseUvTransform=P(n.uvTransform)),n.operator){var l=n.operator;this.options.mappingUseFragment=!0,this.options.mappingType=R[l.type],this.options.mappingObjTransformation=new e.Matrix4,l.transform&&(this.options.mappingObjTransformation.elements=l.transform)}n.slot&&(this.options.diffuseUvSlot="TEX_COORD_1"===n.slot?2:1)}void 0!==t.TextureMapping&&(this.options.textureMapping=t.TextureMapping,void 0!==typeof t.ProjectionPlaneS&&(this.options.projectionPlaneS=t.ProjectionPlaneS),void 0!==typeof t.ProjectionPlaneT&&(this.options.projectionPlaneT=t.ProjectionPlaneT)),void 0!==t.TextureFunction&&(this.options.textureBlending=e.TextureBlendOperations[t.TextureFunction])}};var E=function(e){F.call(this,e),this.isGAS=!1};(E.prototype=Object.create(F.prototype)).buildGenericPhysicalColorOptions=function(t,i,a,r,o){if(void 0!==t[i]){var s=t[i];if(s.length)return void(this.options[a]=(new e.Color).setRGB(s[0],s[1],s[2]));if(void 0!==s.value){var n=s.value;this.options[a]=(new e.Color).setRGB(n[0],n[1],n[2])}else null!==o&&(this.options[a]=o);if(void 0!==s.texture){var l=s.texture;void 0===s.value&&(this.options[a]=(new e.Color).setRGB(1,1,1));var p=this.data.textures[l];if(this.options[a+"Map"]=p.texture,!p.isSupported&&M(i,p.format),r&&p.mapping){var u=p.mapping;if(u.uvTransform&&(this.options[a+"UvTransform"]=P(u.uvTransform)),u.operator){var c=u.operator;this.options.mappingUseFragment=!0,this.options.mappingType=R[c.type],this.options.mappingObjTransformation=new e.Matrix4,c.transform&&(this.options.mappingObjTransformation.elements=c.transform)}u.slot&&(this.options[a+"UvSlot"]="TEX_COORD_1"===u.slot?2:1)}}if(void 0!==s.MADCoefficients){var d=s.MADCoefficients;this.options[a+"MulCoef"]=new e.Vector3(d[0],d[1],d[2]),this.options[a+"AddCoef"]=new e.Vector3(d[3],d[4],d[5])}}else null!==o&&(this.options[a]=o)},E.prototype.buildGenericPhysicalFloatOptions=function(t,i,a,r,o){if(void 0!==t[i]){var s=t[i];if("object"!=typeof s)return void(this.options[a]=s);if(void 0!==s.value){var n=s.value;this.options[a]=n}else null!==o&&(this.options[a]=o);if(void 0!==s.texture){var l=s.texture;void 0===s.value&&(this.options[a]=1),this.options.transparent=this.options.transparent||"opacity"===a||"transparency"===a;var p=this.data.textures[l];if(this.options[a+"Map"]=p.texture,!p.isSupported&&M(i,p.format),r&&p.mapping){var u=p.mapping;if(u.uvTransform&&(this.options[a+"UvTransform"]=P(u.uvTransform)),u.operator){var c=u.operator;this.options.mappingUseFragment=!0,this.options.mappingType=R[c.type],this.options.mappingObjTransformation=new e.Matrix4,c.transform&&(this.options.mappingObjTransformation.elements=c.transform)}u.slot&&(this.options[a+"UvSlot"]="TEX_COORD_1"===u.slot?2:1)}}if(void 0!==s.MADCoefficients){var d=s.MADCoefficients;this.options[a+"MulCoef"]=d[0],this.options[a+"AddCoef"]=d[1]}}else null!==o&&(this.options[a]=o)},E.prototype.buildGenericPhysicalFloat2Options=function(t,i,a,r,o){if(void 0!==t[i]){var s=t[i];if(void 0!==s.value){var n=s.value;this.options[a]="number"==typeof n?new e.Vector2(n,n):new e.Vector2(n[0],n[1])}else null!==o&&(this.options[a]=o);if(void 0!==s.texture){var l=s.texture;void 0===s.value&&(this.options[a]=new e.Vector2(1,1));var p=this.data.textures[l];if(this.options[a+"Map"]=p.texture,!p.isSupported&&M(i,p.format),r&&p.mapping){var u=p.mapping;if(u.uvTransform&&(this.options[a+"UvTransform"]=P(u.uvTransform)),u.operator){var c=u.operator;this.options.mappingUseFragment=!0,this.options.mappingType=R[c.type],this.options.mappingObjTransformation=new e.Matrix4,c.transform&&(this.options.mappingObjTransformation.elements=c.transform)}u.slot&&(this.options[a+"UvSlot"]="TEX_COORD_1"===u.slot?2:1)}}if(void 0!==s.MADCoefficients){var d=s.MADCoefficients;this.options[a+"MulCoef"]=d[0],this.options[a+"AddCoef"]=d[1]}}else null!==o&&(this.options[a]=o)},E.prototype.buildGenericPhysicalMapOptions=function(t,i,a,r){var o=i+"Map";if(void 0!==t[o]){var s=t[o],n=this.data.textures[s];if(this.options[a+"Map"]=n.texture,!n.isSupported&&M(i,n.format),r&&n.mapping){var l=n.mapping;if(l.uvTransform&&(this.options[a+"UvTransform"]=P(l.uvTransform)),l.operator){var p=l.operator;this.options.mappingUseFragment=!0,this.options.mappingType=R[p.type],this.options.mappingObjTransformation=new e.Matrix4,p.transform&&(this.options.mappingObjTransformation.elements=p.transform)}l.slot&&(this.options[a+"UvSlot"]="TEX_COORD_1"===l.slot?2:1)}}void 0!==t[i+"MapFlipY"]&&(this.options[i+"MapFlipY"]=t[i+"MapFlipY"])},E.prototype._startread=function(e,t,i){var a=t.version>=4;F.prototype.read.call(this,e,void 0,void 0),this.options.NRECompatibility=!0,this.options.useAlphaFromDiffuseMap=!1,this.buildGenericPhysicalMapOptions(e,"normal","normal",!a)},E.prototype._endread=function(t,i,a){if(void 0!==t.uv0Transform){var r=t.uv0Transform;this.options.mappingUVTransformation=new e.Matrix3(r[0],r[3],r[6],r[1],r[4],r[7],r[2],r[5],r[8])}},E.prototype.read=function(t,i,a){var r=i.version>=4;if(this._startread(t,i,a),void 0!==t.useAlphaDiffuseChannel&&(this.options.useAlphaFromDiffuseMap=t.useAlphaDiffuseChannel,this.options.transparent=this.options.transparent||this.options.useAlphaFromDiffuseMap),this.options.color=(new e.Color).setRGB(0,0,0),void 0!==t.diffuse){void 0!==t.diffuse.value&&(this.options.color=(new e.Color).setRGB(t.diffuse.value[0],t.diffuse.value[1],t.diffuse.value[2]));var o=t.diffuse.texture;if(void 0!==o){var s=this.data.textures[o];if(!s.isSupported&&M("diffuse",s.format),this.options.map=s.texture,s.lods){this.options.map.setAsLOD(i.switchLODTextureCB?i.switchLODTextureCB:a);for(var n=0;n<s.lods.length;n++)this.options.map.lods.push(new e.LODTextureData(s.lods[n].textureData,null,s.lods[n].loadCB,s.lods[n].format,s.lods[n].basisUsage))}var l=this.data.textures[o].mapping;l&&!r&&(l.uvTransform&&(this.options.diffuseUvTransform=P(l.uvTransform)),l.operator&&(this.options.mappingUseFragment=!0,this.options.mappingType=R[l.operator.type],this.options.mappingObjTransformation=new e.Matrix4,l.operator.transform&&(this.options.mappingObjTransformation.elements=l.operator.transform)),l.slot&&(this.options.diffuseUvSlot="TEX_COORD_1"===l.slot?2:1))}void 0!==t.diffuse.MADCoefficients&&(this.options.diffuseMulCoef=new e.Vector3(t.diffuse.MADCoefficients[0],t.diffuse.MADCoefficients[1],t.diffuse.MADCoefficients[2]),this.options.diffuseAddCoef=new e.Vector3(t.diffuse.MADCoefficients[3],t.diffuse.MADCoefficients[4],t.diffuse.MADCoefficients[5]))}this.buildGenericPhysicalColorOptions(t,"emissive","emissionColor",!r,(new e.Color).setRGB(0,0,0)),this.options.emissionValue=1,this.buildGenericPhysicalColorOptions(t,"specular","specular",!r,(new e.Color).setRGB(.04,.04,.04)),this.buildGenericPhysicalColorOptions(t,"coatingSpecular","clearCoatColor",!r,(new e.Color).setRGB(.04,.04,.04)),this.buildGenericPhysicalColorOptions(t,"flakesColor","flakesColor",!1,(new e.Color).setRGB(0,0,0)),this.options.flakesColorMulCoef=new e.Vector3(.12,.12,.12),this.options.flakesColorAddCoef=new e.Vector3(0,0,0),this.buildGenericPhysicalColorOptions(t,"pearlFlakesColor","pearlFlakesColor",!1,(new e.Color).setRGB(0,0,0)),this.options.pearlFlakesColorMulCoef=new e.Vector3(.08,.08,.08),this.options.pearlFlakesColorAddCoef=new e.Vector3(0,0,0),this.buildGenericPhysicalFloatOptions(t,"opacity","opacity",!r,1),this.buildGenericPhysicalFloatOptions(t,"glossiness","glossiness",!r,1),this.buildGenericPhysicalFloatOptions(t,"anisotropy","anisotropy",!r,0),this.buildGenericPhysicalFloatOptions(t,"anisotropyAngle","anisotropyAngle",!r,0),this.buildGenericPhysicalMapOptions(t,"bump","bump",!r),this.buildGenericPhysicalFloatOptions(t,"bumpScale","bumpScale",!r,1),this.buildGenericPhysicalFloatOptions(t,"metalness","metalness",!r,0),this.options.specGlossNRE=this.options.metalness<1e-6,this.buildGenericPhysicalFloatOptions(t,"fresnelTransparency","transparency",!r,0),this.buildGenericPhysicalFloatOptions(t,"coating","clearCoat",!1,!1),this.buildGenericPhysicalMapOptions(t,"coatingNormal","clearCoatNormal",!r),this.buildGenericPhysicalFloatOptions(t,"coatingGlossiness","coatingGlossiness",!1,1),this.buildGenericPhysicalFloatOptions(t,"proceduralCoating","orangePeel",!1,!1),this.buildGenericPhysicalFloatOptions(t,"coatingNormalBump","clearCoatNormalScale",!1,0),this.buildGenericPhysicalFloatOptions(t,"coatingNormalScale","orangePeelScale",!1,0),this.buildGenericPhysicalFloatOptions(t,"flakes","flakes",!1,!1),this.buildGenericPhysicalFloatOptions(t,"flakesScale","flakesScale",!1,.5),this.buildGenericPhysicalFloatOptions(t,"flakesBump","flakesBump",!1,1),this.buildGenericPhysicalFloatOptions(t,"flakesRoughness","flakesRoughness",!1,.25),this.buildGenericPhysicalFloatOptions(t,"flakesDensity","flakesDensity",!1,1),this.buildGenericPhysicalFloatOptions(t,"pearlFlakesBump","pearlFlakesBump",!1,1),this.buildGenericPhysicalFloatOptions(t,"pearlFlakesDensity","pearlFlakesDensity",!1,1),this.buildGenericPhysicalFloat2Options(t,"normalScale","normalScale",!r,null),this.buildGenericPhysicalFloatOptions(t,"diffuseAlpha","alphaToCoverage",!1,null),this.buildGenericPhysicalFloatOptions(t,"displacement","displacement",!r,null);var p=t.displacement;if(p&&void 0!==p.MADCoefficients){var u=p.MADCoefficients;this.options.displacementScale=u[0],this.options.displacementBias=u[1]}this._endread(t,i,a)};var V=function(e,t){E.call(this,e),this.is19x=t.is19x,this.is21x=t.is21x,this.is22x=t.is22x,this.is23x=t.is23x};(V.prototype=Object.create(E.prototype)).buildGenericPhysicalMapOptions=function(t,i,a,r){if(void 0!==t[i]){var o=t[i];if(void 0!==o.texture){var s=o.texture,n=this.data.textures[s];if(this.options[a+"Map"]=n.texture,!n.isSupported&&M(i,n.format),r&&n.mapping){var l=n.mapping;if(l.uvTransform&&(this.options[a+"UvTransform"]=P(l.uvTransform)),l.operator){var p=l.operator;this.options.mappingUseFragment=!0,this.options.mappingType=R[p.type],this.options.mappingObjTransformation=new e.Matrix4,p.transform&&(this.options.mappingObjTransformation.elements=p.transform)}l.slot&&(this.options[a+"UvSlot"]="TEX_COORD_1"===l.slot?2:1)}}if(void 0!==o.MADCoefficients){var u=o.MADCoefficients;this.options[a+"MulCoef"]=new e.Vector3(u[0],u[1],u[2]),this.options[a+"AddCoef"]=new e.Vector3(u[3],u[4],u[5])}void 0!==t[i+"MapFlipY"]&&(this.options[i+"MapFlipY"]=t[i+"MapFlipY"])}},V.prototype.read=function(t,i,a){var r=i.version>=4;if(this._startread(t,i,a),void 0!==t.cutoutFromAlbedoAlpha?(this.options.useAlphaFromDiffuseMap=t.cutoutFromAlbedoAlpha,this.options.transparent=this.options.transparent||this.options.useAlphaFromDiffuseMap):this.options.useAlphaFromDiffuseMap=!1,void 0!==t.albedo){void 0!==t.albedo.value&&(this.options.color=(new e.Color).setRGB(t.albedo.value[0],t.albedo.value[1],t.albedo.value[2]));var o=t.albedo.texture;if(void 0!==o){var s=this.data.textures[o];!s.isSupported&&M("albedo",s.format),this.options.map=s.texture;var n=s.mapping;n&&!r&&(n.uvTransform&&(this.options.diffuseUvTransform=P(n.uvTransform)),n.operator&&(this.options.mappingUseFragment=!0,this.options.mappingType=R[n.operator.type],this.options.mappingObjTransformation=new e.Matrix4,n.operator.transform&&(this.options.mappingObjTransformation.elements=n.operator.transform)),n.slot&&(this.options.diffuseUvSlot="TEX_COORD_1"===n.slot?2:1))}void 0!==t.albedo.MADCoefficients&&(this.options.diffuseMulCoef=new e.Vector3(t.albedo.MADCoefficients[0],t.albedo.MADCoefficients[1],t.albedo.MADCoefficients[2]),this.options.diffuseAddCoef=new e.Vector3(t.albedo.MADCoefficients[3],t.albedo.MADCoefficients[4],t.albedo.MADCoefficients[5]))}this.buildGenericPhysicalFloatOptions(t,"metallic","metalness",!r,null),this.buildGenericPhysicalFloatOptions(t,"roughness","roughness",!r,0),this.buildGenericPhysicalFloatOptions(t,"anisotropy","anisotropy",!r,0),this.buildGenericPhysicalFloatOptions(t,"anisotropyRotation","anisotropyAngle",!r,0),this.buildGenericPhysicalFloatOptions(t,"transparency","transparency",!r,0),this.buildGenericPhysicalFloatOptions(t,"cutoutOpacity","opacity",!r,1),this.buildGenericPhysicalFloatOptions(t,"thickness","thickness",!r,0),(this.is19x||this.is21x)&&this.buildGenericPhysicalFloatOptions(t,"sheen","sheen",!r,0),this.is19x?void 0!==t.sheenMode&&(this.options.sheenMode=t.sheenMode):(this.buildGenericPhysicalFloatOptions(t,"translucency","translucency",!r,0),this.buildGenericPhysicalMapOptions(t,"displacement","displacement",!r),this.buildGenericPhysicalFloatOptions(t,"subsurfaceAnisotropy","subsurfaceAnisotropy",!1,0),this.is21x?(this.buildGenericPhysicalColorOptions(t,"sheenColor","sheenColor",!0,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalFloatOptions(t,"sheenRoughness","sheenRoughness",!0,.3)):(this.buildGenericPhysicalColorOptions(t,"sheenColor","sheenColor",!r,(new e.Color).setRGB(0,0,0)),this.buildGenericPhysicalFloatOptions(t,"sheenRoughness","sheenRoughness",!r,.5),this.buildGenericPhysicalColorOptions(t,"flipFlopColor","flipFlopColor",!r,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalFloatOptions(t,"flipFlop","flipFlop",!r,0),void 0!==t.subtype&&(this.options._subtype=e.DSPBRSubTypes[t.subtype]),this.is22x||(this.buildGenericPhysicalColorOptions(t,"translucencyColor","translucencyColor",!r,(new e.Color).setRGB(0,0,0)),this.buildGenericPhysicalFloatOptions(t,"iridescence","iridescence",!r,0),this.buildGenericPhysicalFloatOptions(t,"iridescenceThickness","iridescenceThickness",!r,1),this.buildGenericPhysicalFloatOptions(t,"iridescenceIoR","iridescenceIoR",!1,1.5)))),this.buildGenericPhysicalFloatOptions(t,"specular","specularContrib",!r,1),this.buildGenericPhysicalColorOptions(t,"specularTint","specular",!r,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalFloatOptions(t,"clearcoat","clearCoat",!r,0),this.buildGenericPhysicalFloatOptions(t,"clearcoatRoughness","clearCoatRoughness",!r,0),this.buildGenericPhysicalMapOptions(t,"clearcoatNormal","clearCoatNormal",!r),void 0!==t.orangePeel&&(this.options.orangePeel=t.orangePeel),this.buildGenericPhysicalFloatOptions(t,"orangePeelScale","orangePeelScale",!1,0),this.buildGenericPhysicalColorOptions(t,"emissionColor","emissionColor",!r,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalFloatOptions(t,"emissionValue","emissionValue",!1,0),this.options.emissionNormalized=!1,void 0!==t.emissionEnergyNormalization&&(this.options.emissionNormalized=t.emissionEnergyNormalization),this.options.thinWalled=!0,void 0!==t.thinWalled&&(this.options.thinWalled=t.thinWalled),this.buildGenericPhysicalFloatOptions(t,"ior","ior",!1,1.5),this.buildGenericPhysicalColorOptions(t,"attenuationColor","attenuationColor",!1,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalColorOptions(t,"subsurfaceColor","subsurfaceColor",!1,(new e.Color).setRGB(0,0,0)),this.buildGenericPhysicalFloatOptions(t,"attenuationDistance","attenuationDistance",!1,1e6),this.buildGenericPhysicalColorOptions(t,"flakeColor","flakesColor",!r,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalFloatOptions(t,"flakeSize","flakesSize",!r,.5),this.buildGenericPhysicalFloatOptions(t,"flakeCoverage","flakesCoverage",!r,0),this.buildGenericPhysicalFloatOptions(t,"flakeRoughness","flakesRoughness",!r,0),this._endread(t,i,a)},V.prototype._endread=function(t,i,a){if(void 0!==t.uv0Transform){this.options.mappingType||(this.options.mappingType=0);var r=t.uv0Transform;this.options.mappingUVTransformation=new e.Matrix3(r[0],r[3],r[6],r[1],r[4],r[7],r[2],r[5],r[8])}};return function(t){var m=performance.now();this.mode=void 0,this.sharedBuffers=!1,this.noMeshInRAM=!1,this.baseUrl="",this.modelsToLoad={},this.loadIndex=0,this.nbModelsToLoad=0,this.extensionsRequired=new Set,this.extensionsUsed=new Set,this.globalOldFlipTexture=!1,this.SSBMinNbReps=1,this.SSBMinNbTriangles=1e3,this.capture=!1,this.warnCount=0;var b=this,y=e.MaterialUtils.createShinyFaceMaterial({side:e.DoubleSide,color:new e.Color(16777215)}),M=new e.MeshBasicMaterial({color:new e.Color(16777215)});this._zipReaders=[],this.getURI=function(e,t){var i="";if("http://"===e.substring(0,7))i=e;else if("https://"===e.substring(0,8))i=e;else if("/"===e.substring(0,1))i=e;else{var a=t;if("blob:"===t.substring(0,5)||"/"===t){var r=(a=location.href).indexOf("?");-1!==r&&(a=a.substring(0,r));var o=a.lastIndexOf("/");-1!==o&&(a=a.substring(0,o+1))}i=a+e}return i},this.getEntryFile=function(e,t,i){"blob"===t?e.getData(new f.BlobWriter).then(i):"arraybuffer"===t?e.getData(new f.Uint8ArrayWriter).then(i):e.getData(new f.TextWriter).then(i)},this.createAmbience=function(t,i,a){var r=["WhiteDesign","BlueDesign","DarkDesign","Studio","PureWhite","WhiteMirror","WhiteReview","DarkMirror","DarkReview","Outdoor","Indoor","City","Road","NeoPureWhite"],o=t.ambiance,s=null;if(!o)return!0;if(i.destinationNode)for(var n=i.destinationNode,l=0;l<n._occurrences.length;l++){var p=n._occurrences[l];p.parent,p.scene3js&&(s=p.scene3js.viewer)}if(o.name&&-1===r.indexOf(o.name)&&o.directionalLights)for(l=0;l<o.directionalLights.length;l++)t.lightInstances&&t.lightInstances.length||(t.lightInstances=[]),o.directionalLights[l].castShadows=o.directionalLights[l].castShadows&&!g,o.directionalLights[l].ambianceTransform=o.transform,t.lightInstances.push(o.directionalLights[l]);if(s&&(s.setAmbientLight(0),s.setIntensityCorrection(!0),s.useDefaultLights&&(s.setTriLights(!1),s.directionalLight.intensity=0,s.directionalLight2.intensity=0),s.renderer.ToneMappingEffect&&s.renderer.ToneMappingEffect.setToneMapping(2),o.name&&-1!==r.indexOf(o.name))){var u=s.setVisuEnvOCA(o.name,a,{from3dx:!0});return o.backgroundGeometry&&o.backgroundGeometry.size&&s.ambience.getBackgroundGeometry().setSize(o.backgroundGeometry.size),u}var c,d=null,f=null;if(o.background&&"gradient"==o.background.type){var m=o.background.colors[0];o.background.colors[0]=o.background.colors[1],o.background.colors[1]=m}o.background&&void 0!==o.background.image&&(y=i.data.images[o.background.image]).data&&(d={data:window.URL.createObjectURL(y.data),format:y.format});var g=!1,v=a;if(o.unitScale=i.rootMatrix?i.rootMatrix.getMaxScaleOnAxis():1,o.environmentLight&&void 0!==o.environmentLight.light){var b;o.environmentLight.matrix&&(b=o.environmentLight.matrix);var y,x=i.json.lights[o.environmentLight.light],M=x.image;(y=i.data.images[M])&&y.data&&(f={data:window.URL.createObjectURL(y.data),format:y.format}),o.environmentLight=x,b&&(o.environmentLight.matrix=b),g=!0;var w=this.extensionsRequired.has("EXT_IBL_Preconvolved")&&this.extensionsUsed.has("EXT_IBL_Preconvolved")&&t.extensions.EXT_IBL_Preconvolved;if(w&&s){c=new e.Texture;var T=w.GGX,A=w.Lambert;if(!T||!A)throw"Invalid EXT_IBL_Preconvolved extension usage: missing brdf";if(A.image=i.data.images[A.image],"hdr"!==A.image.format)throw"Invalid EXT_IBL_Preconvolved extension usage: not hdr";var S={textures:[],ggxMapping:T.roughnessMapping,ggx0:T.useOriginalAsZero};if(6!==T.mips.length)throw"Invalid EXT_IBL_Preconvolved extension usage: missing mips";for(l=0;l<T.mips.length;l++){if(T.mips[l].image=i.data.images[T.mips[l].image],"hdr"!==T.mips[l].image.format)throw"Invalid EXT_IBL_Preconvolved extension usage: not hdr";S.textures.push(T.mips[l].image)}S.textures.push(A.image),v=function(){for(var t=0,i=function(){7==++t&&s.ambience._solveSceneRoughnessMap(S,a)},r=0;r<S.textures.length;r++){var o=window.URL.createObjectURL(S.textures[r].data),n=e.ImageUtils.loadHDRTexture(o,new e.LatLongEnvMapping,i,null,!1,!1);n.minFilter=e.NearestFilter,n.magFilter=e.NearestFilter,S.textures[r]=n}}}}o.ground&&"physical"==o.ground.type&&void 0!==o.ground.material&&void 0!==i.data.materials[l]&&(o.ground.material=i.data.materials[l]);var C=o.renderSettings;s&&C&&(void 0===C.type||"rasterizer"===C.type)&&(C.ambientOcclusion&&C.ambientOcclusion.activation&&(s.setSSAOParameters({dynamicRadius:!1,adaptativeRadius:!0,radius:C.ambientOcclusion.radius?C.ambientOcclusion.radius:100,radiusMin:.005,radiusMax:.12,minPixelRadius:14,attenuation:.984,contrast:C.ambientOcclusion.intensity?C.ambientOcclusion.intensity:1,power:1,thresholdAngle:1.32645023152}),s.setSSAO(!0)),C.reflection&&C.reflection.activation&&s.setSSLR(!0));var O=new h({viewer:s,ambiance:o,images:{background:d,environmentLight:f},from3DX:!0,doneCallback:v,roughnessMap:c});return s&&s.setAmbience(O),!O.isTextureLoading()},this.createImages=function(e,t,i,a){var r=this;if(!e||t>=e.length)a&&a(i);else{var o=e[t],s=o.format?o.format.toLowerCase():"",n=o.usage?o.usage:"NOT_BASIS";if("png"===s||"jpeg"===s||"jpg"===s||"dds"===s||"hdr"===s||"basis"===s||"ktx2"===s||""===s&&o.uid){var l="image/"+s;"dds"!==s&&"hdr"!==s&&"basis"!==s&&"ktx2"!==s||(l="arraybuffer");var p=i.json.binaries?i.json.binaries[o.binary]:null,u=i.data.chunks[o.binary];if(u){var c=u.buffer?u.buffer:u,d=u.byteOffset?u.byteOffset:0,h=new Uint8Array(c,d+o.byteOffset,o.byteLength),f=new Blob([h],{type:l});i.data.images.push({uri:p.extUri?p.extUri:p.uri,uid:o.uid,data:f,format:s,usage:n}),this.createImages(e,t+1,i,a.bind(this))}else if(p){var m={uri:p.extUri?p.extUri:p.uri,width:o.width,height:o.height,format:s,usage:n};i.data.images.push(m),i.binaryCallback?i.binaryCallback(m.uri,function(o,s){s&&(l="image/"+s,"dds"!==s&&"hdr"!==s&&"basis"!==s&&"ktx2"!==s||(l="arraybuffer"),m.format=s);var n=new Blob([o],{type:l});m.data=n,r.createImages(e,t+1,i,a.bind(this))}):this.createImages(e,t+1,i,a.bind(this))}else m={uri:null,format:s,usage:n},o.uid&&i.resourcesLibrary?m.uid=o.uid:(this.warnCount<5&&(console.warn("bad 3dx file"),this.warnCount++),h=new Uint8Array,f=new Blob([h],{type:"image/png"}),m.data=f),i.data.images.push(m),this.createImages(e,t+1,i,a.bind(this))}}},this.createBuffers=function(e,t){if(e)for(var i=0;i<e.length;i++){var a=e[i],r=t.data.chunks[a.binary],o=r.buffer?r.buffer:r,s=r.buffer?r.byteOffset+a.byteOffset:a.byteOffset;if(a.format){if("UNSIGNED_SHORT"===a.format)u=new Uint16Array(o,s,a.byteLength/2);else if("UNSIGNED_INT"===a.format)u=new Uint32Array(o,s,a.byteLength/4);else if("UNSIGNED_BYTE"===a.format){var n=new Uint8Array(o,s,a.byteLength);u=new Uint16Array(a.byteLength);for(var l=0;l<a.byteLength;l++)u[l]=n[l]}t.data.buffers.push(u)}else if(a.attributes){var p=T[a.attributes];if(p){var u=new Float32Array(o,s,a.byteLength/4);t.data.buffers.push({attribute:p,buffer:u})}else{n=new Float32Array(o,s,a.byteLength/4);var c=[];t.data.buffers.push(c);var d=0;for(var l in T)a.attributes&l&&(d+=A[l]);var h=n.length/d;for(var l in T)if(a.attributes&l){for(var f=A[l],m=(u=new Float32Array(h*f),{attribute:T[l],buffer:u}),g=S[l],v=0;v<h;v++){for(var b=0;b<f;b++)u[v++]=n[g+b];g+=d}c.push(m)}}}else a.geometricType?(u=new Uint32Array(o,s,a.byteLength/4),t.data.buffers.push({geometricType:a.geometricType,buffer:u})):(u=new Uint8Array(o,s,a.byteLength),t.data.buffers.push({buffer:u}))}},this.getBuffers=function(e,t,i,a,r){if(e){var o=e[i],s=t.data.chunks[o.binary],n=s.buffer?s.buffer:s,l=s.buffer?s.byteOffset+o.byteOffset:o.byteOffset;if(o.format){if("UNSIGNED_SHORT"===o.format)c=new Uint16Array(n,l,o.byteLength/2);else if("UNSIGNED_INT"===o.format)c=new Uint32Array(n,l,o.byteLength/4);else if("UNSIGNED_BYTE"===o.format){var p=new Uint8Array(n,l,o.byteLength);c=new Uint16Array(o.byteLength);for(var u=0;u<o.byteLength;u++)c[u]=p[u]}return c}if(a){if(1==a.length){if("UNSIGNED_SHORT"===(m=a[0]).format)c=new Uint16Array(n,l,o.byteLength/2);else if("UNSIGNED_INT"===m.format)c=new Uint32Array(n,l,o.byteLength/4);else if("UNSIGNED_BYTE"===m.format)for(p=new Uint8Array(n,l,o.byteLength),c=new Uint16Array(o.byteLength),u=0;u<o.byteLength;u++)c[u]=p[u];else c=new Float32Array(n,l,o.byteLength/4);return c}var c=new Float32Array(n,l,o.byteLength/4),d=[],h=0;for(var u in a)h+=a[u].dimension;var f=c.length/h;for(var u in a){var m=a[u];d[u]=new Float32Array(f*m.dimension)}var g=0;for(var u in a){i=0,m=a[u];for(var v=0;v<f;v++)for(var b=0;b<m.dimension;b++)d[u][i++]=c[v*h+g+b];g+=m.dimension}return d}return r?{geometricType:r,buffer:c=new Uint32Array(n,l,o.byteLength/4)}:c=new Uint8Array(n,l,o.byteLength)}},this.getGenericBuffer=function(e,t,i,a){if(e){var r,o=e[i],s=t.data.chunks[o.binary],n=s.buffer?s.buffer:s,l=s.buffer?s.byteOffset+o.byteOffset:o.byteOffset;switch(a){case"Float32":r=new Float32Array(n,l,o.byteLength/4);break;case"Uint32":r=new Uint32Array(n,l,o.byteLength/4);break;default:r=new Uint8Array(n,l,o.byteLength)}return r}},this.onImageLoaded=function(e){e.data.nbImagesToLoad--,!e.data.nbImagesToLoad&&e.onTexturesLoadedCB&&e.onTexturesLoadedCB()},this._createTemporaryMap=function(t){var i;switch(t){case"dds":case"basis":case"ktx2":i=new e.CompressedTexture;break;case"hdr":i=new e.DataTexture;break;default:i=new e.Texture}return i.loadEndStatus=e.AssetLoadingStatus.LOADING,i},this._loadGenericTexture=function(t,i,a,r,o,s,n){var l=n;return"dds"===t?l=e.ImageUtils.loadCompressedTexture(a,null,o(s,r?a:null),o(s,r?a:null),!0,!1,n):"hdr"===t?l=e.ImageUtils.loadHDRTexture(a,null,o(s,r?a:null),o(s,r?a:null),!0,!1,!0,!1,!1,n):"basis"===t?l=e.ImageUtils.loadBasisTexture(a,null,o(s,r?a:null),o(s,r?a:null),!0,e.BasisUsage[i],!1,n):"ktx2"===t?l=e.ImageUtils.loadKTX2Texture(a,null,o(s,r?a:null),o(s,r?a:null),!0,e.BasisUsage[i],!1,n):(l=e.ImageUtils.loadTexture(a,null,o(s,r?a:null),o(s,r?a:null),void 0,!s||s&&s.forcePowerOfTwo,!1,n)).flipY=!0,l},this._loadImage=function(t,i,a,r){var o,s,n,l=t.data.images[a],p=l.format,u=!1,c=null;return i?(c=l.uri,s=l.width,n=l.height):((l.uri||l.uid)&&t.resourcesLibrary&&(c=t.resourcesLibrary.getImage(l.uid?l.uid:l.uri)),c||(l.data?(o=window.URL.createObjectURL(l.data),u=!0):l.uri?o=l.uri:(this.warnCount<5&&(console.warn("3DSync: uid not in cache and no binary buffer attached"),this.warnCount++),t.resourcesLibrary&&l.uid&&(c=this._createTemporaryMap(p),t.resourcesLibrary.addImageToRequest(l.uid,c,p))),c||(c=this._loadGenericTexture(p,l.usage,o,u,r,t)),c._source=e.AssetSource.MATERIAL_MANAGER,(l.uri||l.uid)&&t.resourcesLibrary&&t.resourcesLibrary.addImage(l.uid?l.uid:l.uri,c))),{uri:l.uri,uid:l.uid,isSupported:"png"===p||"jpeg"===p||"jpg"===p||"dds"===p||"hdr"===p||"basis"===p||"ktx2"===p,map:c,width:s,height:n,format:p,basisUsage:l.usage?e.BasisUsage[l.usage]:-1}},this.createTextures=function(t,i){if(t){for(var a=this,r={},o=0;o<t.length;o++)if(r[(x=t[o]).image]||(r[x.image]=[],!i.imagesCallback&&i.data.images[x.image]&&i.data.nbImagesToLoad++),r[x.image].push({texture:o,lod:-1}),x.lods)for(var s=0;s<x.lods.length;s++){var n=x.lods[s];r[n]||(r[n]=[]),r[n].push({texture:o,lod:s})}for(var l in r){var p,u,c=!0,d="",h=null,f=null,m=null,g=-1;if(i.imagesCallback)h=i.imagesCallback(x,i);else{var v=r[l][0].lod>=0,b=this._loadImage(i,v,l,function(e,t){return function(){a.onImageLoaded(e),t&&window.URL.revokeObjectURL(t)}});c=b.isSupported,d=b.format,h=b.map,f=b.uri,m=b.uid,p=b.width,u=b.height,g=b.basisUsage}var y=r[l];for(s=0;s<y.length;s++){var x=t[y[s].texture],M=h;if(-1===y[s].lod){var w=O[x.uWrap]||1e3,T=O[x.vWrap]||1e3,A="CLAMP_TO_BORDER"===x.uWrap||"CLAMP_TO_BORDER"===x.vWrap,S=x.anisotropy||8,G=C[x.minFilter]||1008,D=C[x.magFilter]||1006,B=x.borderColor,R=null;A&&(R=B?new e.Vector4(B[0],B[1],B[2],B[3]):new e.Vector4(0,0,0,1)),1003!==D&&1006!==D&&(D=1006);var L=x.repeat||{x:1,y:1},P=(d=i.json.images[x.image].format,"jpg"===x.format||"jpeg"===x.format);P||"jpg"!==d&&"jpeg"!==d||(P=!0);var I=e.AssetSource.MATERIAL_MANAGER,N=null;(f||m)&&i.resourcesLibrary&&(N=i.resourcesLibrary.getTexture(m||f,{wrapS:w,wrapT:T,anisotropy:S,minFilter:G,magFilter:D,borderColor:R,repeat:L,sRGB:P,source:I})),N?M=N:((f||m)&&i.resourcesLibrary&&void 0===(M=h.clone()).data&&(M.needsUpdate=!1),M.wrapS=w,M.wrapT=T,M.anisotropy=S,M.minFilter=G,M.magFilter=D,M.borderColor=R,M.repeat=L,M.sRGB=P,M._source=I,(f||m)&&i.resourcesLibrary&&i.resourcesLibrary.addTexture(m||f,M,{wrapS:w,wrapT:T,anisotropy:S,minFilter:G,magFilter:D,borderColor:R,repeat:L,sRGB:P,source:I}));var F={isSupported:c,format:d,texture:M,mapping:x.mapping};i.data.textures[y[s].texture]=F}else(F=i.data.textures[y[s].texture]).lods||(F.lods=[]),F.lods.push({textureData:{texture:M,width:p,height:u,format:d,basisUsage:g},loadCB:this.loadLODTextureCB})}}}},this.loadLODTextureCB=function(t){var a,r=i.parseUrl(this.imageData.texture);switch(r=""===r.protocol?b.baseUrl+r.source:r.source,this.imageData.format){case"basis":a=e.ImageUtils.loadBasisTexture(r,null,null,null,!0,this.imageData.basisUsage);break;case"ktx2":a=e.ImageUtils.loadKTX2Texture(r,null,null,null,!0,this.imageData.basisUsage);default:(a=e.ImageUtils.loadTexture(r,null,void 0,void 0,!0,!0)).flipY=!0}return a._source=e.AssetSource.MATERIAL_MANAGER,t&&(a.wrapS=t.wrapS,a.wrapT=t.wrapT,a.anisotropy=t.anisotropy,a.minFilter=t.minFilter,a.magFilter=t.magFilter,a.borderColor=t.borderColor?t.borderColor.clone():null,a.repeat=t.repeat,a.sRGB=t.sRGB),a},this.switchLODTextureCB=function(t){var i=t.matrix,a=t.bSphere,r=a.radius*i.getMaxScaleOnAxis(),o=new e.Vector3;a?o.copy(a.center):o.set(0,0,0),o.applyMatrix4(i);var s,n,l=t.camera.matrixWorldInverse.elements,p=Math.abs(l[2]*o.x+l[6]*o.y+l[10]*o.z+l[14])-r,u=e.glStates.currentHeight/Math.tan(.5*t.camera.fov*Math.PI/180)*r/Math.abs(p);if(u<Math.min(t.texture.image.width,t.texture.image.height))return-1;for(s=0;s<t.lods.length&&(n=t.lods[s],!(u<Math.min(n.imageData.width,n.imageData.height)));s++);return s===t.lods.length?s-1:s},this.createMappingDescriptions=function(t,i,a){if(t)for(var r=0;r<t.length;r++){var o=t[r],s={hasOperator:!1};if(o.uvTransform&&(s.uvTransform=P(o.uvTransform)),o.operator){var n=o.operator;s.hasOperator=!0,s.mappingUseFragment=!0,s.mappingType=R[n.type],s.mappingObjTransformation=new e.Matrix4,n.transform&&(s.mappingObjTransformation.elements=n.transform)}o.slot&&(s.slot="TEX_COORD_1"===o.slot?2:1),i.mappingDescriptions[r]=s}},this.createMaterialApplications=function(t,i,a,r){if(t)for(var o=0;o<t.length;o++){var s=t[o],l=!1;void 0!==s.decalProjector&&(l=!0);var p=a.materials[s.material];if(p){var u={faceMaterial:p,geometricalFaceMaterial:p,inheritance:B[s.inheritance],layer:s.layer},c=null;switch(p.getType()){case"SpecGloss":c=I;break;case"DSPBR19x":case"DSPBR21x":case"DSPBR22x":case"DSPBR23x":c=N;break;case"CATGraphicalMaterial":c=null;break;default:e.VisualizationTraces.info(p.getType()+" unknown material application matching")}var d=s.textureMappings;if(d&&c){for(var h={textureUVSlots:{},textureUVTransforms:{}},f=0;f<d.length;f++){var m=a.mappingDescriptions[d[f].mapping];m.hasOperator&&(h.mappingUseFragment=m.mappingUseFragment,h.mappingType=m.mappingType,h.mappingObjTransformation=m.mappingObjTransformation);var g=d[f].parameter,v=c[g];v?(m.slot&&(h.textureUVSlots[v+"UvSlot"]=m.slot),m.uvTransform&&(h.textureUVTransforms[v+"UvTransform"]=m.uvTransform)):e.VisualizationTraces.info(g+" unknown attribute for material application matching")}u.mappingOperator=h}var b=null,y=!1;l&&(y=!!(b=i[s.decalProjector]).mode&&"EXPLICIT"===b.mode,u.mappingOperator?(u.mappingOperator.mappingObjTransformation=null,u.mappingOperator.mappingType=R[b.operator.type]):u.mappingOperator={mappingUseFragment:!0,mappingType:R[b.operator.type]},b.implicitScale||(b.implicitScale=[1,1]),b.implicitScale&&b.implicitScale&&(u.mappingOperator.mappingUVTransformation=new e.Matrix3(b.implicitScale[0],0,y?0:.5,0,b.implicitScale[1],y?0:.5,0,0,1)));var x=new n(u);if(l){var M=new e.Matrix4;b.operator.transform&&(M.elements=b.operator.transform),u={materialApplication:x,matrix:M,explicitUv:y},a.materialApplications[o]={isDecal:!0,decal:e.DecalManager.createDecal(u),apply:s.isDecalApplied,attach:s.isDecalAttached,uid:b.uid}}else a.materialApplications[o]=x}}},this.createMaterialsV2=function(t,i,a){if(t)for(var r=new s,o=0;o<t.length;o++){var n=t[o],l=null;if(a.materialsCallback)l=a.materialsCallback(n,a);else{if("External"===n.type){var p={uri:n.uri,destinationNodes:[],destinationDGforGAS:[],destinationDGforMaterial:[]};a.data.modelsToLoad.push(p),i.materials[o]=p;continue}var u={visible:n.visible,force:n.force,side:n.side,transparent:n.transparent,opacity:n.opacity,depthTest:n.depthTest,depthWrite:n.depthWrite},c=!0,d="VIS"+u.visible+"S"+u.side+"T"+u.transparent;d+="O"+u.opacity,d+="DT"+u.depthTest+"DW"+u.depthWrite,n.forceSide&&(u.forceSide=n.forceSide,l+="FS"+u.forceSide),void 0!==n.NRECompatibility&&(u.NRECompatibility=n.NRECompatibility),n.needTangentBinormal&&(u.needTangentBinormal=n.needTangentBinormal),n.alphaTest&&(!0===n.alphaTest?u.alphaTest=.5:u.alphaTest=n.alphaTest),n.color&&(u.color=(new e.Color).setRGB(n.color[0],n.color[1],n.color[2]),d+="C"+u.color.getStyle()),n.ambient&&(u.ambient=(new e.Color).setRGB(n.ambient[0],n.ambient[1],n.ambient[2]),d+="A"+u.ambient.getStyle()),n.emissive&&(u.emissive=(new e.Color).setRGB(n.emissive[0],n.emissive[1],n.emissive[2]),d+="E"+u.emissive.getStyle()),n.specular&&(u.specular=(new e.Color).setRGB(n.specular[0],n.specular[1],n.specular[2]),d+="SP"+u.specular.getStyle()),n.shininess&&(u.shininess=n.shininess,d+="SH"+u.shininess),n.vertexColors&&(u.vertexColors=n.vertexColors),void 0!==n.diffuseMap&&(c=!1,u.map=i.textures[n.diffuseMap].texture),void 0!==n.opacityMap&&(c=!1,u.opacityMap=i.textures[n.opacityMap].texture,u.transparent=!0),void 0!==n.normalMap&&(c=!1,u.normalMap=i.textures[n.normalMap].texture,u.needTangentBinormal=!0,void 0!==n.needTangentBinormal&&(u.needTangentBinormal=n.needTangentBinormal)),void 0!==n.normalMapScale&&(u.normalScale=new e.Vector2(n.normalMapScale.x,n.normalMapScale.y)),void 0!==n.normalMapFlipY&&(u.normalMapFlipY=n.normalMapFlipY),void 0!==n.bumpMap&&(c=!1,u.bumpMap=i.textures[n.bumpMap].texture),void 0!==n.bumpMapScale&&(u.bumpScale=n.bumpMapScale),void 0!==n.glossiness&&(u.glossiness=n.glossiness,d+="G"+u.glossiness),void 0!==n.glossinessMap&&(c=!1,u.glossinessMap=i.textures[n.glossinessMap].texture),void 0!==n.specularMap&&(c=!1,u.specularMap=i.textures[n.specularMap].texture),"Physical"===n.type&&(c=!1,void 0!==n.emissiveMap&&(u.emissiveMap=i.textures[n.emissiveMap].texture),void 0!==n.metalnessMap&&(void 0===n.metalness&&(n.metalness=1),u.metalnessMap=i.textures[n.metalnessMap].texture),void 0!==n.metalness&&(u.metalness=n.metalness),void 0!==n.coating&&(u.coating=n.coating),void 0!==n.coatingGlossiness&&(u.coatingGlossiness=n.coatingGlossiness)),void 0!==n.iterative&&(u.iterative=n.iterative),void 0!==n.sslr&&(u.sslr=n.sslr);var h=D[n.type];d="id"+d.hashCode(),c&&a.gasSharing&&(l=r.get3DXSharedGas(d)),!l&&h&&((l=new e[h](u))._source=e.AssetSource.MATERIAL_MANAGER,c&&a.gasSharing&&r.set3DXSharedGas(d,l))}i.materials[o]=l}},this.createMaterials=function(t,i,a){if(t){for(var r=new s,o=this.extensionsRequired.has("EXT_Material_PBR")||this.extensionsUsed.has("EXT_Material_PBR"),n=[],l=0;l<t.length;l++){var p=t[l],u=null,c="DSPBR"===p.type||"EVisuPBR"===p.type,d="DSPBR 2021x"===p.type||"DSPBR2021x"===p.type,h="DSPBR 2022x"===p.type,f="DSPBR 2023x"===p.type,m=c||d||h||f,g=!1;if(!m&&p.extensions&&p.extensions.EXT_Material_PBR&&((p=p.extensions.EXT_Material_PBR).type="EVisuPBR",m=o,c=!0),a.materialsCallback)u=a.materialsCallback(p,a);else{if("External"===p.type){var v={uri:p.uri,destinationNodes:[],destinationDGforGAS:[],destinationDGforMaterial:[]};a.data.modelsToLoad.push(v),i.materials[l]=v;continue}var b=null,y=D[p.type];m?b=new V(i,{is19x:c,is21x:d,is22x:h,is23x:f}):"Visu_Basic"===p.type?b=new k(i):"Physical"===p.type?b=new E(i):"PDSFX"===p.type?(b=new U(i),g=!0):b=new _(i),b.read(p,a,this.switchLODTextureCB);var x="id"+b.id.hashCode();if(b.isGAS&&a.gasSharing&&(u=r.get3DXSharedGas(x)),g&&(b.options.id=l,n.push(b.options),b.options.useBaseMaterial)){i.materials[l]=null;continue}!u&&y&&((u=new e[y](b.options))._source=e.AssetSource.MATERIAL_MANAGER,b.isGAS&&a.gasSharing&&r.set3DXSharedGas(x,u))}i.materials[l]=u}if(n.length)for(l=0;l<n.length;l++){var M=n[l];if(M.useBaseMaterial){var w=i.materials[M.baseMaterial].clone();i.materials[M.id]=w,r.getPDSFX({material:w,parameters:M.shaderParameters,name:M.shaderName})}else r.getPDSFX({material:i.materials[M.id],parameters:M.shaderParameters,name:M.shaderName})}}},this.createGeometriesV2=function(t,i){if(t)for(var r=i.data,o=0;o<t.length;o++){var s=t[o],n=new e.BufferGeometryDS;r.geometries[o]=n,n.sharedBuffers=this.sharedBuffers,n.noMeshInRAM=this.noMeshInRAM,n.vertexIndexArray=r.buffers[s.indexBuffer];for(var l=0;l<s.vertexBuffers.length;l++){var p=r.buffers[s.vertexBuffers[l]];if(p.attribute)n[p.attribute]=p.buffer;else if(p.length)for(var u=0;u<p.length;u++)n[p[u].attribute]=p[u].buffer}for(l=0;l<s.drawingGroups.length;l++){var c,d=s.drawingGroups[l],h=void 0!==d.primitives,f=void 0!==d.canonicals,m=n.vertexNormalArray?y:M,g=[],v=new a.DrawingGroup(m,null,G[d.mode],d.start,d.count,g,void 0,e.GeomTypeEnum.UNKNOWN,0);if(v.geometry=n,n.drawingGroups.push(v),void 0!==d.graphicAttributes&&r.materials[d.graphicAttributes]&&((c=r.materials[d.graphicAttributes]).uri?c.destinationDGforGAS.push(v):v.gas=c),void 0!==d.material&&r.materials[d.material]&&((c=r.materials[d.material]).uri?c.destinationDGforMaterial.push(v):v.material=c),h){var b=r.buffers[d.primitives],x=b.buffer,w=0,T=f?r.buffers[d.canonicals].buffer:null;for(v._geomType=e.GeomTypeEnum[b.geometricType],u=0;u<x.length;u+=4){var A=new a.SGPrimitive({cgmId:x[u],group:v,start:x[u+2],count:x[u+3]});if(i.unstreamReps){var S=x[u+1],C=r.reps[S];C||(C=new a.SGRep({cgmId:S}),r.reps[S]=C),A.rep=C,C._primitives.push(A)}if(f){var O=T[w++];if(O){A.decoration=new Array;for(var D=0;D<O;D++)A.decoration.push(T[w++])}}g.push(A)}}else A=new a.SGPrimitive({cgmId:0,group:v,start:d.start,count:d.count}),g.push(A)}}},this.getInternalDimensionBuffer=function(e,t,i){var a=t;if("POSITION"==i?a=t:"NORMAL"==i?a=t:"TEX_COORD_0"==i?a=3:"TEX_COORD_1"==i?a=3:"COLOR"==i?a=4:"TANGENT"==i?a=3:"BINORMAL"==i&&(a=3),a==t)return e;if(t>0){var r=e.length/t,o=new Float32Array(r*a);if(t<a)for(var s=0;s<r;s++){for(var n=0;n<t;n++)o[s*a+n]=e[s*t+n];for(n=t;n<a;n++)o[s*a+n]=0}else for(s=0;s<r;s++)for(n=0;n<a;n++)o[s*a+n]=e[s*t+n];return o}return console.log("wrong definition of buffer dimension"),e},this.createGeometries=function(t,i,r,o){if(t)for(var s=o.data,n=0;n<t.length;n++){var l,p,u=t[n],c={},d=0,h=u.reps&&!(u.reps instanceof Object);if(h){var f=this.getGenericBuffer(i,o,u.reps,"Uint8");l=new Uint32Array(f.buffer,f.byteOffset);var m=4*f.byteLength/9;p=new Float32Array(f.buffer,f.byteOffset+m)}var g=r[u.vertexLayout],v=new e.BufferGeometryDS;if(v.compressedNormals=u.compressedNormals||void 0!==u.normalCompression&&"OCT_24"===u.normalCompression,v.compressedVertices=u.compressedVertices||void 0!==u.positionCompression&&"BBOX_QUANTIZATION_16_16_16"===u.positionCompression,v.compressedUVs=u.compressedUVs||void 0!==u.uvCompression&&"UV_SHORT"===u.uvCompression,v.compressedColors=u.compressedColors||void 0!==u.colorCompression&&"COLOR_BYTE"===u.colorCompression,s.geometries[n]=v,v.sharedBuffers=this.sharedBuffers,v.noMeshInRAM=this.noMeshInRAM,void 0===u.indexBuffer){if(u.drawingGroups&&u.drawingGroups[0].count){v.vertexIndexArray=new Uint32Array(u.drawingGroups[0].count);for(var b=0;b<u.drawingGroups[0].count;b++)v.vertexIndexArray[b]=b}}else v.vertexIndexArray=this.getBuffers(i,o,u.indexBuffer);if(u.boundingSphere){var x=u.boundingSphere.center,T=u.boundingSphere.radius;v.boundingSphere=new e.Sphere(new e.Vector3(x[0],x[1],x[2]),T)}if(u.boundingBox){var A=u.boundingBox.min,S=u.boundingBox.max;v.compressedVertices&&(v.quantizedVector=new e.Vector3(Math.max(S[0]-A[0],1e-6),Math.max(S[1]-A[1],1e-6),Math.max(S[2]-A[2],1e-6)),v.quantizedVector.multiplyScalar(1/65535),v.offsetVector=new e.Vector3(A[0],A[1],A[2]),v.offsetVector.x/=v.quantizedVector.x,v.offsetVector.y/=v.quantizedVector.y,v.offsetVector.z/=v.quantizedVector.z,v.offsetVector.x=Math.floor(v.offsetVector.x),v.offsetVector.y=Math.floor(v.offsetVector.y),v.offsetVector.z=Math.floor(v.offsetVector.z))}if(1===g[0].length)for(var C=0;C<u.vertexBuffers.length;C++){var O=g[C],D=this.getBuffers(i,o,u.vertexBuffers[C],O);if("POSITION"==(J=O[0]).attribute){if(v.vertexPositionArray=this.getInternalDimensionBuffer(D,J.dimension,J.attribute),v.compressedVertices){var B=v.vertexPositionArray,R=B.length/3;for(v.vertexPositionArray=new Float32Array(2*R),b=0;b<R;b++){var L=B[3*b],P=B[3*b+1],I=Math.floor(P/256),N=P%256,F=B[3*b+2];v.vertexPositionArray[2*b]=256*L+I,v.vertexPositionArray[2*b+1]=256*F+N}}}else if("NORMAL"==J.attribute){if(v.vertexNormalArray=this.getInternalDimensionBuffer(D,J.dimension,J.attribute),v.compressedNormals){var U=(j=v.vertexNormalArray).length/3;for(v.vertexNormalArray=new Float32Array(U),b=0;b<U;b++){L=j[3*b],P=j[3*b+1],F=j[3*b+2];var _=16*L+Math.floor(P/16),k=P%16*256+F;v.vertexNormalArray[b]=4096*_+k}}}else if("TEX_COORD_0"==J.attribute){if(v.vertexUvArray=this.getInternalDimensionBuffer(D,J.dimension,J.attribute),v.compressedUVs){var E=(V=v.vertexUvArray).length/3;for(v.vertexUvArray=new Float32Array(2*E),b=0;b<E;b++)L=V[3*b],P=V[3*b+1],I=Math.floor(P/256),N=P%256,F=B[3*b+2],v.vertexUvArray[2*b]=256*L+I,v.vertexUvArray[2*b+1]=256*F+N}}else if("TEX_COORD_1"==J.attribute){if(v.vertexUv2Array=this.getInternalDimensionBuffer(D,J.dimension,J.attribute),v.compressedUVs){var V;for(E=(V=v.vertexUv2Array).length/3,v.vertexUv2Array=new Float32Array(2*E),b=0;b<E;b++)L=V[3*b],P=V[3*b+1],I=Math.floor(P/256),N=P%256,F=B[3*b+2],v.vertexUv2Array[2*b]=256*L+I,v.vertexUv2Array[2*b+1]=256*F+N}}else if("COLOR"==J.attribute){if(v.vertexColorArray=this.getInternalDimensionBuffer(D,J.dimension,J.attribute),v.compressedColors){var j,z=(j=v.vertexColorArray).length/4;for(v.vertexColorArray=new Float32Array(2*z),b=0;b<z;b++){var W=j[4*b],X=j[4*b+1],H=j[4*b+2],q=j[4*b+3];v.vertexColorArray[2*b]=65536*W+256*X+H,v.vertexColorArray[2*b+1]=q}}}else"TANGENT"==J.attribute?v.vertexTangentArray=this.getInternalDimensionBuffer(D,J.dimension,J.attribute):"BINORMAL"==J.attribute?v.vertexBinormalArray=this.getInternalDimensionBuffer(D,J.dimension,J.attribute):v[J.attribute]=D}else{O=g[0];var Y=this.getBuffers(i,o,u.vertexBuffers[0],O);for(C=0;C<O.length;C++){var J;"POSITION"==(J=O[C]).attribute?v.vertexPositionArray=this.getInternalDimensionBuffer(Y[C],J.dimension,J.attribute):"NORMAL"==J.attribute?v.vertexNormalArray=this.getInternalDimensionBuffer(Y[C],J.dimension,J.attribute):"TEX_COORD_0"==J.attribute?v.vertexUvArray=this.getInternalDimensionBuffer(Y[C],J.dimension,J.attribute):"TEX_COORD_1"==J.attribute?v.vertexUv2Array=this.getInternalDimensionBuffer(Y[C],J.dimension,J.attribute):"COLOR"==J.attribute?v.vertexColorArray=this.getInternalDimensionBuffer(Y[C],J.dimension,J.attribute):"TANGENT"==J.attribute?v.vertexTangentArray=this.getInternalDimensionBuffer(Y[C],J.dimension,J.attribute):"BINORMAL"==J.attribute?v.vertexBinormalArray=this.getInternalDimensionBuffer(Y[C],J.dimension,J.attribute):v[J.attribute]=Y[C]}}for(C=0;C<u.drawingGroups.length;C++){var Z,K=u.drawingGroups[C],Q=void 0!==K.repRanges,$=void 0!==K.primitives,ee=void 0!==K.canonicals,te=void 0!==K.cullingData,ie=v.vertexNormalArray?y:M,ae=[],re=new a.DrawingGroup(ie,null,G[K.mode],K.start,K.count,ae,void 0,e.GeomTypeEnum.UNKNOWN,0);if(re.geometry=v,re._geomType=e.GeomTypeEnum[K.geometricType],v.drawingGroups.push(re),void 0!==K.graphicAttributes&&s.materials[K.graphicAttributes]&&((Z=s.materials[K.graphicAttributes]).uri?Z.destinationDGforGAS.push(re):re.gas=Z),void 0!==K.material&&s.materials[K.material]&&((Z=s.materials[K.material]).uri?Z.destinationDGforMaterial.push(re):re.material=Z),te){re.cullingData=[];var oe=this.getGenericBuffer(i,o,K.cullingData.start,"Uint32"),se=this.getGenericBuffer(i,o,K.cullingData.radius,"Float32");for(b=0;b<oe.length;b++)re.cullingData.push({start:oe[b],radius:se[b]})}if(Q&&!$){var ne=this.getGenericBuffer(i,o,K.repRanges,"Uint32"),le=K.start;for(b=0;b<ne.length;b+=2){var pe=new a.SGPrimitive({cgmId:0,group:re,start:le,count:ne[b+1]});if(le+=pe.count,o.unstreamReps&&u.reps){var ue=l[4*(ge=ne[b])];(me=s.reps[ue])||(me={rep:new a.SGRep({cgmId:l[4*ge+1],solid:l[4*ge+2],sag:p[5*ge+4]}),bsphere:[p[5*ge],p[5*ge+1],p[5*ge+2],p[5*ge+3]],nbTriangles:l[4*ge+3]},c[ge]=me,s.reps[ue]=me,d++),pe.rep=me.rep,me.rep._primitives.push(pe)}ae.push(pe)}}else if($&&o.unstreamPrimitives){var ce=this.getBuffers(i,o,K.primitives,void 0,K.geometricType).buffer,de=0,he=ee?this.getBuffers(i,o,K.canonicals).buffer:null;for(b=0;b<ce.length;b+=4){var fe=new a.SGPrimitive({cgmId:ce[b],group:re,start:ce[b+2],count:ce[b+3]});if(o.unstreamReps&&u.reps){var me,ge=ce[b+1];if(ue=h?l[4*ge]:0,!(me=h?s.reps[ue]:c[ge])){if(h)me={rep:new a.SGRep({cgmId:l[4*ge+1],solid:l[4*ge+2],sag:p[5*ge+4]}),bsphere:[p[5*ge],p[5*ge+1],p[5*ge+2],p[5*ge+3]],nbTriangles:l[4*ge+3]},s.reps[ue]=me;else{var ve=u.reps[ge];me={rep:new a.SGRep({cgmId:ve.cgmId,solid:ve.solid,sag:ve.sag}),bbox:ve.bbox,nbTriangles:ve.nbTriangles}}c[ge]=me,d++}fe.rep=me.rep,me.rep._primitives.push(fe)}if(ee){var be=he[de++];if(be){fe.decoration=new Array;for(var ye=0;ye<be;ye++)fe.decoration.push(he[de++])}}ae.push(fe)}}else fe=new a.SGPrimitive({cgmId:0,group:re,start:K.start,count:K.count}),ae.push(fe)}if(o.unstreamSSB&&d>this.SSBMinNbReps){var xe=performance.now(),Me=[],we=0,Te=null,Ae=new e.Sphere,Se=new e.Sphere;for(var Ce in c){var Oe=c[Ce].bsphere;Se.center.set(Oe[0],Oe[1],Oe[2]),Se.radius=Oe[3],Te?(Ae.copy(Te),Ae.mergeWithSphere(Se,Te)):Te=Se.clone(),c[Ce].rep.boundingSphere={center:[Se.center.x,Se.center.y,Se.center.z],radius:Se.radius},we+=c[Ce].nbTriangles,Me.push(c[Ce])}we>this.SSBMinNbTriangles&&(v.bvhCells=[],xe=performance.now(),w.indexMap=new Uint32Array(v.vertexIndexArray.length),(!w.positions||w.positions.length<v.vertexPositionArray.length)&&(w.positions=new Float32Array(v.vertexPositionArray.length)),(!w.normals||w.normals.length<v.vertexNormalArray.length)&&(w.normals=new Float32Array(v.vertexNormalArray.length)),console.log("allocate indexMap/positions/normals in "+(performance.now()-xe)+" ms."),v.bvhCells.push(this.batchBVHCell({objects:Me},v,w,Te)))}}},this.batchBVHCell=function(t,i,r,o){var s=performance.now(),n=new e.BufferGeometryDS;n.sharedBuffers=this.sharedBuffers,n.noMeshInRAM=this.noMeshInRAM,o?(n.boundingSphere=o,n.boundingBox=n.boundingSphere.getBoundingBox()):(n.boundingBox=new e.Box3(t.bbox.min,t.bbox.max),n.boundingSphere=n.boundingBox.getBoundingSphere()),n.compressedVertices=i.compressedVertices,n.compressedNormals=i.compressedNormals,n.compressedUVs=i.compressedUVs,n.compressedColors=i.compressedColors,n.quantizedVector=i.quantizedVector,n.offsetVector=i.offsetVector;var l=r.indexMap,p=r.positions,u=r.normals;performance.now()-s,s=performance.now();for(var c=0,d=0,h=[],f=0,m=0;m<t.objects.length;m++)for(var g=t.objects[m],v=0;v<g.rep.primitives.length;v++)f+=(x=g.rep.primitives[v]).count,h.push(x);performance.now()-s,s=performance.now();var b,y,x,M=new Uint32Array(f);for(h.sort(function(e,t){if(e.group.glType<t.group.glType)return-1;if(e.group.glType>t.group.glType)return 1;if(e.group._geomType<t.group._geomType)return-1;if(e.group._geomType>t.group._geomType)return 1;if(e.group.gas.id<t.group.gas.id)return-1;if(e.group.gas.id>t.group.gas.id)return 1;if(e.group.material&&!t.group.material)return-1;if(!e.group.material&&t.group.material)return 1;if(e.group.material&&t.group.material){if(e.group.material.id<t.group.material.id)return-1;if(e.group.material.id>t.group.material.id)return 1}return e.rep.boundingSphere.radius>t.rep.boundingSphere.radius?-1:e.rep.boundingSphere.radius<t.rep.boundingSphere.radius?1:0}),performance.now()-s,s=performance.now(),v=0;v<h.length;v++){(x=h[v]).group!==b&&(b=x.group,(y=new a.DrawingGroup(x.group.gas,x.group.material,x.group.glType,d,0,[],void 0,x.group._geomType,0)).geometry=n,n.drawingGroups.push(y),g=null,y.cullingData=[]),x.rep!==g&&(g=x.rep,y.cullingData.push({start:d,radius:g.boundingSphere.radius}));for(var w=d,T=0;T<x.count;T++){var A=i.vertexIndexArray[x.start+T];0===l[A]&&(l[A]=c+1,i.compressedVertices?(p[2*c]=i.vertexPositionArray[2*A],p[2*c+1]=i.vertexPositionArray[2*A+1]):(p[3*c]=i.vertexPositionArray[3*A],p[3*c+1]=i.vertexPositionArray[3*A+1],p[3*c+2]=i.vertexPositionArray[3*A+2]),i.compressedNormals?u[c]=i.vertexNormalArray[A]:(u[3*c]=i.vertexNormalArray[3*A],u[3*c+1]=i.vertexNormalArray[3*A+1],u[3*c+2]=i.vertexNormalArray[3*A+2]),c++),M[d]=l[A]-1,d++}x.start=w,x.group=y,y.count+=x.count,y.primitives.push(x)}return performance.now()-s,s=performance.now(),n.vertexIndexArray=M,n.vertexPositionArray=new Float32Array(p.buffer.slice(0,4*(i.compressedVertices?2:3)*c)),n.vertexNormalArray=new Float32Array(u.buffer.slice(0,4*(i.compressedNormals?1:3)*c)),performance.now()-s,n},this.createNodes=function(t,i){if(t){i.data.children||(i.data.children=[]);for(var a=i.data,s=0;s<t.length;s++){var n=t[s],l=null;if("External"===n.type)l=new r,i.data.modelsToLoad.push({destinationNode:l,uri:n.uri});else if("Node3D"===n.type)l=new r,i.data.children[s]=n.children;else{var p=null,u=null;if(n.boundingSphere){var c=n.boundingSphere.center,d=n.boundingSphere.radius;p=new e.Sphere(new e.Vector3(c[0],c[1],c[2]),d)}if(n.boundingBox){var h=n.boundingBox.min,f=n.boundingBox.max;u=new e.Box3(new e.Vector3(h[0],h[1],h[2]),new e.Vector3(f[0],f[1],f[2]))}var m=[];if(n.geometries)for(var v=0;v<n.geometries.length;v++){var b=a.geometries[n.geometries[v]];if(b.bvhCells)for(var x=0;x<b.bvhCells.length;x++)m.push(b.bvhCells[x]);else m.push(b)}u||(m[0].computeBoundingBox(),u=m[0].boundingBox),m.boundingBox=u,p||(m[0].computeBoundingSphere(),p=m[0].boundingSphere),m.boundingSphere=p;var w=m.length&&m[0].vertexNormalArray?y:M,T=new e.Mesh(m,w);if(T.fromLoadedModel=!0,T.castShadow=void 0===n.castShadow||n.castShadow,T.receiveShadow=void 0===n.receiveShadow||n.receiveShadow,T.enableNormalDepth=void 0===n.enableNormalDepth||n.enableNormalDepth,n.lightmaps&&n.lightmaps.length){var A=a.textures[n.lightmaps[0]];T.lightMapData={lightMapLinear:!0,lightMapMode:i.lightMapAsIrradiance?1:0,lightMapUvTransform:null,lightMapUvSlot:1};var S=A.mapping;for(S&&(S.uvTransform&&(T.lightMapData.lightMapUvTransform=P(S.uvTransform)),S.slot&&(T.lightMapData.lightMapUvSlot="TEX_COORD_1"===S.slot?2:1)),T._programID|=e.ProgramIDs.LIGHT_MAP,v=0;v<n.lightmaps.length;v++)A=a.textures[n.lightmaps[v]],m[v].lightMap=A.texture}l=new o(T),i.accelStruct&&!g&&l._occurrences[0].renderable.computeKDTree(!1)}if(i.version>=4){if(void 0!==n.materialApplication){var C=a.materialApplications[n.materialApplication];l.setMaterialApplication(C)}if(void 0!==n.decalApplications)for(s=n.decalApplications.length;s>0;s--){var O=a.materialApplications[n.decalApplications[s-1]],G=O.decal;O.apply&&G.applyOn(l),O.attach&&G.attachTo(l)}}else if(void 0!==n.material){var D=a.materials[n.material];D.uri?D.destinationNodes.push(l):l.setMaterial(D)}if(a.nodes[s]=l,n.matrix){var B=(new e.Matrix4).setFromArray(n.matrix);l.setMatrix(B)}n.name&&l.setName(n.name),i.nodeCallback&&i.nodeCallback(n,i,l)}}},this.createLayers=function(t,i){var a=i.data;for(var r in a.nodes){var o=a.nodes[r],s=t[r];for(var l in s.occurrences){var p=s.occurrences[l].index,u=s.occurrences[l];if(u.layers.length){o._occurrences[p].renderable.layer=new e.BufferLayer(o._occurrences[p].renderable);for(var c=0;c<u.layers.length;c++){var d=u.layers[c],h=a.geometries[d.geometry],f=a.materials[d.drawableInterval.material];v&&(f=new n({faceMaterial:f,inheritance:2,layer:0}));var m=new e.DrawableInterval(d.drawableInterval.layerNum,d.drawableInterval.start,d.drawableInterval.count,f);m.primitiveStart=d.drawableInterval.primitiveStart,m.primitiveCount=d.drawableInterval.primitiveCount;var g=new e.LayerInterval(h,h.drawingGroups[d.drawableGroup],m);o._occurrences[p].renderable.layer.addLayerInterval(g)}}}}};var L=function(t,i){var a=null,r=t.emissionColor?t.emissionColor:t.color;if(t.energyNormalization){var o=.2126*r[0]+.7152*r[1]+.0722*r[2];r[0]=r[0]/o,r[1]=r[1]/o,r[2]=r[2]/o}var s=(new e.Color).setRGB(r[0],r[1],r[2]),n="rgb("+255*r[0]+","+255*r[1]+","+255*r[2]+")",d=void 0!==t.emissionValue?t.emissionValue:t.value;if("directional"==t.type)a=new p({color:s,intensity:d=d/=i*i,sceneShadow:!0});else if("point"==t.type)t.emissionMode&&"LUMINOUS_POWER"!=t.emissionMode||(d/=4*Math.PI),a=new c({color:s,intensity:d,physicalAttenuation:!0,attenuationScale:1e-6,sceneShadow:!0});else if("spot"==t.type){var h=t.cutoffAngle*Math.PI/180,f=t.falloffAngle*Math.PI/180;t.emissionMode&&"LUMINOUS_POWER"!=t.emissionMode||(d/=Math.PI*(1-Math.cos(h)+(1-Math.cos(f)))),a=new u({color:s,intensity:d,physicalAttenuation:!0,attenuationScale:1e-6,outerAngle:h,innerAngle:f,sceneShadow:!0})}else"rectangle"==t.type?(t.emissionMode||(t.emissionMode="LUMINOUS_POWER"),(a=new e.AreaLight(n,d,t.width,t.height,e.AreaLightUnits[t.emissionMode])).color=s,a._internalScale=i,a=new l(a)):"disk"==t.type?(t.emissionMode||(t.emissionMode="LUMINOUS_POWER"),(a=new e.DiskLight(n,d,t.radius,e.AreaLightUnits[t.emissionMode])).color=s,a._internalScale=i,a=new l(a)):"sphere"==t.type?(t.emissionMode||(t.emissionMode="LUMINOUS_POWER"),(a=new e.SphereLight(n,d,t.radius,e.AreaLightUnits[t.emissionMode])).color=s,a._internalScale=i,a=new l(a)):"tube"==t.type?(t.emissionMode||(t.emissionMode="LUMINOUS_POWER"),(a=new e.TubeLight(n,d,t.radius,t.width,e.AreaLightUnits[t.emissionMode])).color=s,a._internalScale=i,a=new l(a)):a={};return a};this.applyLights=function(t){var i=t.json.lightInstances;if(i&&i.length){var a=null,r=t.destinationNodes?t.destinationNodes[0]:t.destinationNode;!g&&r._occurrences[0].scene3js&&((a=r._occurrences[0].scene3js.viewer).setAmbientLight(0),a.setIntensityCorrection(!0),a.useDefaultLights&&(a.setTriLights(!1),a.directionalLight.intensity=0,a.directionalLight2.intensity=0),a.renderer.ToneMappingEffect&&a.renderer.ToneMappingEffect.setToneMapping(2));var o=1;t.rootMatrix&&(o=t.rootMatrix.getMaxScaleOnAxis()),r._updateBoundingElements();for(var s=t.json.lights,n=0;n<i.length;n++){var l=i[n];if("environment"!=s[l.light].type){var u=L(s[l.light],o);if(l.castShadows&&u.castShadows){var c=u instanceof p?null:1e4;u.castShadows(!0,{bias:-.005,darkness:1/i.length,far:c,mapWidth:1024,mapHeight:1024})}l.cameraAligned&&u.attachToViewpoint&&u.attachToViewpoint(l.cameraAligned);var d=new e.Matrix4;l.matrix&&d.setFromArray(l.matrix);var h=new e.Matrix4;l.ambianceTransform&&h.setFromArray(l.ambianceTransform),d=(new e.Matrix4).multiplyMatrices(h,d),t.rootMatrix&&(d=(new e.Matrix4).multiplyMatrices(t.rootMatrix,d)),u.setMatrix(d),t.data.lights||(t.data.lights=[]),t.data.lights.push(u),r.add(u)}}}},this.retrieveViewpoints=function(t,i,a,r){let o=[],s=null;if(a){if(!t.json.cameras)return o;s=[];for(let e=0;e<t.json.cameras.length;e++)s[e]={camera:e}}else if(!(s=t.json.renderFrames)||!s.length)return o;for(var n=0;n<s.length;n++){var l=s[n],p=t.json.cameras[l.camera];if(l.resolution,p.type&&"2DCamera"==p.type){let t=new e.Vector3(p.origin[0],p.origin[1],1);var u=p.zoom,c=p.zoomType,h=p.zoomRatio;(O=new d({viewer:i,projectionType:d.ORTHOGRAPHIC,defaultController:!0,inactive:r}))._set2DMode(!0,"COMBINED"),O.setNative2DZoomType(c,h),O._nativeZoom=u,O.onMove(i.render),O.moveTo({eyePosition:t})}else{var f=(new e.Matrix4).setFromArray(p.matrix),m=new e.Vector3,g=new e.Quaternion,v=new e.Vector3;f.decompose(m,g,v);var b=10,y=2500,x=1;t.rootMatrix&&(x=t.rootMatrix.getMaxScaleOnAxis()),m.multiplyScalar(x);var M=p.focusDistance?p.focusDistance*x:null;!p.autoNearFar&&p.nearFar&&(b=p.nearFar[0],y=p.nearFar[1],b*=x,y*=x);var w,T=p.sensorSize?p.sensorSize:[36,24];if(T[0]*=x,T[1]*=x,p.type&&"orthographic"==p.type)w=d.ORTHOGRAPHIC;else{w=d.PERSPECTIVE;var A=50;p.focalLength&&(A=p.focalLength,A*=x);var S=p.aperture?p.aperture:1,C=p.blades?p.blades:0}var O=new d({viewer:i,projectionType:w,near:b,far:y,defaultController:!0,inactive:r});if(w==d.PERSPECTIVE?(O.camera.setLens(A,T,!0),O.camera.setAperture(S,C)):(p.scale&&(T[0]*=p.scale[0],T[1]*=p.scale[1]),M=T[1]/(2*Math.tan(Math.PI*O.camera.fov/360))),O.onMove(i.render),O.moveTo({eyePosition:m,orientation:g,distanceToTarget:M}),p.projectionDir){let t=O.getSightDirection(),i=new e.Vector3(p.projectionDir[0],p.projectionDir[1],p.projectionDir[2]),a=t.dot(i),r=i.setLength(1/a);r.sub(t),r.applyMatrix4(O.camera.matrixWorldInverse),O._nativeTranslationOffset=new e.Vector2(r.x,r.y),O.camera.updateProjectionMatrix()}}o.push(O)}return o},this.applyCamera=function(t){var i=t.destinationNodes?t.destinationNodes[0]:t.destinationNode;if(g||!i._occurrences[0].scene3js)return;var a=i._occurrences[0].scene3js.viewer,r=t.json.currentRenderFrame?t.json.currentRenderFrame:0;let o=this.retrieveViewpoints(t,a);if(0!=o.length){for(let e=0;e<o.length;e++)a.addViewpoint(o[e]);var s=t.json.renderFrames,n=t.json.cameras[s[r].camera];if(n.bloom){a.setBloom(!0);var l=a.getEffect("Bloom");l&&(l.setBloomThreshold(n.bloom.lightThreshold),l.setBloomFactor(n.bloom.intensity))}var p=a.getEffect("ToneMapping");a.renderer.renderer.resetInlinedPostProcess();var u=a.renderer.renderer.inlinedPostProcess;if(n.exposure&&(p?p.setBrightness(n.exposure):(u.activated=!0,u.brightness=n.exposure)),n.autoexposure&&p){var c=n.autoexposure,d=null;null!=c.regionOfInterest&&(d=data.textures[c.regionOfInterest].texture),p.setAutoExposure(!!c.autoexposure,d,c.clampMin,c.clampMax)}if(n.toneMapper)if("Filmic"===n.toneMapper.type)p?p.setToneMapping(4):(u.activated=!0,u.tonemapping=4);else if("Photographic"===n.toneMapper.type){var h=n.toneMapper.colorCorrection;p?p.setToneMapping(6,{crushblacks:n.toneMapper.crushBlack,burnhighlights:n.toneMapper.burnHighlight,saturation:n.toneMapper.saturation,colorCorrection:new e.Vector3(h[0],h[1],h[2])}):(u.activated=!0,u.tonemapping=6,u.crushblacks=n.toneMapper.crushBlack,u.burnhighlights=n.toneMapper.burnHighlight)}if(n.gammaCorrection&&p&&p.setGamma(n.gammaCorrection),n.vignetting){a.setVignetting(!0);let e=a.getEffect("Vignetting");null!=n.vignetting.power&&e&&e.setVignettingPower(n.vignetting.power)}if(null!=n.colorGrading&&p){var f=null,m=this._loadImage(t,!1,n.colorGrading,function(e){return function(){p.setColorGrading(f)}});(f=m.map).flipY=!1,f.wrapS=1001,f.wrapT=1001,f.anisotropy=1,f.minFilter=1006,f.magFilter=1006,f.generateMipmaps=!1}var v=a.getViewpoints().length-s.length;a.selectViewpoint(v+r),this.capture&&(a.ambience,function(){var e=window._shootW?window._shootW:a.SCREEN_WIDTH,i=window._shootH?window._shootH:a.SCREEN_HEIGHT,r=function(e,t,i,a,r){return r?(t=a-t,i*Math.floor(t-1)+Math.floor(e)):i*Math.floor(t)+Math.floor(e)},o={data:null,width:e,height:i};a.renderToTarget(o,a.currentViewpoint,!1,{AntiAliasing:"FSAA"});var s=document.createElement("canvas");s.width=e,s.height=i;for(var n=s.getContext("2d"),l=n.createImageData(o.bufferWidth,o.bufferHeight),p=0;p<l.height;p++)for(var u=0;u<l.width;u++){var c=r(u,p,l.width,l.height,!1),d=r(u,p,o.bufferWidth,o.bufferHeight,!0);l.data[4*c]=o.data[4*d],l.data[4*c+1]=o.data[4*d+1],l.data[4*c+2]=o.data[4*d+2],l.data[4*c+3]=o.data[4*d+3]}createImageBitmap(l).then(a=>{n.drawImage(a,0,0,e,i);var r=document.createElement("a"),o=t.url.lastIndexOf("/"),s=t.url.lastIndexOf("."),l=window._shoot?window._shoot:t.url.substr(o+1,s-o-1);void 0!==window._currentShootIndex&&(l+="_"+window._currentShootIndex),r.download=l+".png",n.canvas.toBlob(function(e){r.href=URL.createObjectURL(e),r.click()})})}())}},this.parseHeader=function(t){var i=t.json.header;if(!i||!i.version)return!1;if(2!==parseFloat(i.version)&&3!==parseFloat(i.version)&&3.1!==parseFloat(i.version)&&3.2!==parseFloat(i.version)&&4!==parseFloat(i.version))return!1;t.version=parseFloat(i.version),"material"!==i.content&&"ambiance"!==i.content&&"light"!==i.content||(t.content=i.content),"materialApplication"===i.content&&(t.content="material");var a=new e.Matrix4;return"m"===i.unit||"meter"===i.unit||"meters"===i.unit?a.makeScale(1e3,1e3,1e3):"inch"!==i.unit&&"inches"!==i.unit||a.makeScale(25.4,25.4,25.4),"Y"===i.upAxis?a.rotateX(.5*Math.PI):"X"===i.upAxis&&a.rotateY(.5*Math.PI),a.isIdentity()||(t.rootMatrix=a),!0},this.processJSON=function(e){this.parseHeader(e)&&(e.data.chunks.length||!e.json.binaries||e.json.binaries.flag?this.processChunks(e):this.getChunks(e.json.binaries.length,e,this.processChunks))},this.processChunks=function(e){m=performance.now();var t=e.json;if(void 0!==t.extensionsUsed)for(var i=0;i<t.extensionsUsed.length;i++)this.extensionsUsed.add(t.extensionsUsed[i]);if(void 0!==t.extensionsRequired)for(i=0;i<t.extensionsRequired.length;i++)this.extensionsRequired.add(t.extensionsRequired[i]);this.createImages(t.images,0,e,this.onImagesReady.bind(this))},this.onImagesReady=function(t){var i=t.json,a=this;t.ambianceLoaded=!0;var r=function(e){var i={nbTextures:0};e&&e.ambiance&&(t.results.ambiance=e.ambiance,t.ambianceLoaded=!0),t.ambianceLoaded&&t.geometryLoaded&&(i.isLast=!a.nbModelsToLoad,"ambiance"==t.content&&(i.ambiance=t.results.ambiance,t.json.ambiance&&t.json.ambiance.renderSettings&&(i.renderSettings=t.json.ambiance.renderSettings)),"light"==t.content&&(i.lights=t.results.lights),"material"===t.content&&(t.data.materials.length>0&&(i.material=t.results.materials[0],i.materials=t.results.materials.slice()),t.data.materialApplications.length>0&&(i.materialApplications=t.results.materialApplications.slice()),i.json=t.json,0==t.data.textures.length&&t.onTexturesLoadedCB&&t.onTexturesLoadedCB(null)),i.nbTextures=t.data.nbImagesToLoad||0,t.doneCallback&&t.doneCallback(i),delete a.modelsToLoad[t.loadIndex])};if(this.createTextures(i.textures,t),2===t.version?this.createMaterialsV2(i.materials,t.data,t):this.createMaterials(i.materials,t.data,t),t.version>=4&&(this.createMappingDescriptions(i.mappingDescriptions,t.data),this.createMaterialApplications(i.materialApplications,i.decalProjectors,t.data,t)),"material"!==t.content&&(t.ambianceLoaded=this.createAmbience(i,t,r),2===t.version&&this.createBuffers(i.buffers,t)),"material"!==t.content){if(void 0!==i.root){2===t.version?this.createGeometriesV2(i.geometries,t):this.createGeometries(i.geometries,i.buffers,i.vertexLayouts,t),this.createNodes(i.nodes,t),x("processed data in "+(performance.now()-m)+" ms."),m=performance.now();for(var o=0;o<t.data.nodes.length;o++){var s=t.data.nodes[o],n=t.data.children;if(n[o])for(var l=0;l<n[o].length;l++)s.add(t.data.nodes[n[o][l]],!0);if(s.__representations)for(l=0;l<s.__representations.length;l++){var p,u=[];for(p=0;p<s.__representations[l].length;p++)u.push(t.data.nodes[s.__representations[l][p]]);s._pushRepresentation(u)}}t.unstreamLayers&&this.createLayers(i.nodes,t),x("Created links between nodes in "+(performance.now()-m)+" ms."),m=performance.now();var c=t.data.nodes[i.root];if(t.rootMatrix){var d=(new e.Matrix4).multiplyMatrices(t.rootMatrix,c.getMatrix());c.setMatrix(d)}if(t.destinationNodes)for(o=0;o<t.destinationNodes.length;o++)t.destinationNodes[o].add(c);else t.destinationNode.add(c);x("Attached to scenegraph in "+(performance.now()-m)+" ms.")}else if(1===t.data.materials.length){for(o=0;o<t.destinationNodes.length;o++)t.destinationNodes[o].setMaterial(t.data.materials[0]);for(o=0;o<t.destinationDGforGAS.length;o++)t.destinationDGforGAS[o].gas=t.data.materials[0];for(o=0;o<t.destinationDGforMaterial.length;o++)t.destinationDGforMaterial[o].material=t.data.materials[0]}this.applyLights(t),this.applyCamera(t)}var h=t.data.modelsToLoad.length;if(h){var f=0;for(o=0;o<h;o++){var g=t.data.modelsToLoad[o];this.load({url:this.getURI(g.uri,t.path),destinationNode:g.destinationNode,destinationNodes:g.destinationNodes,destinationDGforGAS:g.destinationDGforGAS,destinationDGforMaterial:g.destinationDGforMaterial,zipped:!0,layers:t.unstreamLayers,reps:t.unstreamReps,doneCallback:function(){++f===h&&t.doneCallback&&t.doneCallback()}})}t.readyCallback&&t.readyCallback(),delete this.modelsToLoad[t.loadIndex]}else{if(this.nbModelsToLoad--,"material"===t.content&&t.data.materials.length>0&&(t.results.material=t.data.materials[0],t.results.materials=t.data.materials.slice()),"material"===t.content&&t.data.materialApplications.length>0&&(t.results.materialApplications=t.data.materialApplications.slice()),"light"===t.content&&(t.results.lights=t.data.lights),t.readyCallback&&t.readyCallback(),t.geometryLoaded=!0,0===this.nbModelsToLoad)for(o=0;o<this._zipReaders.length;o++)this._zipReaders[o].close();this._zipReaders=[],r()}},this.internalLoad=function(e){var t=this,i=this.modelsToLoad[e];if(m=performance.now(),i.json)"string"==typeof i.json&&(i.json=JSON.parse(i.json)),this.processJSON(i);else{var a=i.url,r="text";i.zipped&&(r="blob"),i.concat&&(r="arraybuffer");var o=function(e){if(x("file downloaded in "+(performance.now()-m)+" ms."),m=performance.now(),i.zipped){const a=new f.ZipReader(new f.BlobReader(e));t._zipReaders.push(a),a.getEntries().then(function(e){x("zip file reader created in "+(performance.now()-m)+" ms."),i.zipEntries=e;for(var a=null,r=0;r<e.length;r++)"manifest.json"===e[r].filename&&(a=e[r]);m=performance.now(),t.getEntryFile(a,"text",function(e){x("unzipped JSON file in "+(performance.now()-m)+" ms."),m=performance.now(),i.json=JSON.parse(e),x("parsed JSON file in "+(performance.now()-m)+" ms."),t.processJSON(i)})}).catch(i.errorCallback)}else if(i.concat){for(var a=new Uint8Array(e),r=new Uint32Array(e,0,1)[0],o=new Uint16Array(a.buffer,4,r/2),s=[],n=0;65535*n<o.length;n++)s.push(String.fromCharCode.apply(null,o.subarray(65535*n,65535*(n+1))));var l=s.join("");x("unbinarized JSON file in "+(performance.now()-m)+" ms."),m=performance.now(),i.json=JSON.parse(l),x("parsed JSON file in "+(performance.now()-m)+" ms."),i.concatBinaries={data:a,offset:a.byteLength},t.processJSON(i)}else x("JSON file downloaded in "+(performance.now()-m)+" ms."),m=performance.now(),i.json=JSON.parse(e),x("parsed JSON file in "+(performance.now()-m)+" ms."),t.processJSON(i)};if("file:"==a.slice(0,5)){var s=new XMLHttpRequest;s.open("GET",a,!0),s.responseType=r,s.withCredentials=!0,s.onreadystatechange=function(e){4===s.readyState&&(0===s.status||200===s.status?o(s.response):i.errorCallback())},s.send(null)}else UWA.Ajax.request(a,{async:!0,cors:!0,withCredentials:!0,responseType:r,onComplete:o,onFailure:i.errorCallback})}},this.getChunks=function(e,t,i){var a=this;if(!e)return t.concatBinaries&&(t.concatBinaries.data=null),void i.call(this,t);if(e--,m=performance.now(),t.zipped){for(var r=null,o=0;o<t.zipEntries.length;o++)t.zipEntries[o].filename===t.json.binaries[e].uri&&(r=t.zipEntries[o]);r?this.getEntryFile(r,"arraybuffer",function(r){x("unzipped binary file "+e+" in "+(performance.now()-m)+" ms."),t.data.chunks[e]=r,a.getChunks(e,t,i)}):a.getChunks(e,t,i)}else if(t.concat){m=performance.now();var s=t.json.binaries[e];if(!1===s.concatenated)return void a.getChunks(e,t,i);var n=s.byteLength;if(n%4&&(n+=4-n%4),t.concatBinaries.offset-=n,t.concatBinaries.data.buffer.slice){var l=t.concatBinaries.data.buffer.slice(t.concatBinaries.offset,t.concatBinaries.offset+s.byteLength);t.data.chunks[e]=new Uint8Array(l)}else{l=new Uint8Array(t.concatBinaries.data.buffer,t.concatBinaries.offset,s.byteLength);for(var p=new Uint8Array(s.byteLength),u=0;u<s.byteLength;u++)p[u]=l[u];t.data.chunks[e]=p}x("splitted binary file "+e+" in "+(performance.now()-m)+" ms."),a.getChunks(e,t,i)}else{var c=new XMLHttpRequest;c.open("GET",t.path+t.json.binaries[e].uri,!0),c.responseType="arraybuffer",c.withCredentials=!0,c.onreadystatechange=function(r){4===c.readyState&&(0!==c.status&&200!==c.status||(x("xhr binary file "+e+" in "+(performance.now()-m)+" ms."),t.data.chunks[e]=this.response,a.getChunks(e,t,i)))},c.send(null)}},this.setMode=function(e){this.mode=e},this.setSharedBuffers=function(e){this.sharedBuffers=e},this.setNoMeshInRAM=function(e){this.noMeshInRAM=e},this.setBaseUrl=function(e){this.baseUrl=e},this.load=function(e){var t={version:3,content:"sceneGraph",url:e.url,path:e.url?i.parseUrl(e.url+".json").directoryPath:null,zipped:void 0!==e.zipped?e.zipped:void 0===this.mode||"zipped"===this.mode,concat:void 0!==e.concat?e.concat:"concat"===this.mode,json:e.json,resourcesLibrary:e.resourcesLibrary,ambianceLoaded:!1,geometryLoaded:!1,forcePowerOfTwo:void 0===e.forcePowerOfTwo||e.forcePowerOfTwo,results:{ambiance:null,material:null,materials:null,materialApplications:null,lights:null},readyCallback:e.readyCallback,progressCallback:e.progressCallback,doneCallback:e.doneCallback,errorCallback:e.errorCallback,imagesCallback:e.imageCallback,binaryCallback:e.binaryCallback,materialsCallback:e.materialCallback,nodeCallback:e.nodeCallback,switchLODTextureCB:e.switchLODTextureCallback,onTexturesLoadedCB:e.onTexturesLoadedCallback,destinationNode:e.destinationNode,destinationNodes:e.destinationNodes,destinationDGforGAS:e.destinationDGforGAS,destinationDGforMaterial:e.destinationDGforMaterial,unstreamLayers:void 0!==e.layers&&e.layers,unstreamReps:void 0!==e.reps&&e.reps,unstreamPrimitives:void 0!==e.primitives&&e.primitives,unstreamSSB:void 0!==e.ssb&&e.ssb,accelStruct:void 0!==e.accelStruct&&e.accelStruct,gasSharing:void 0!==e.gasSharing&&e.gasSharing,lightMapAsIrradiance:void 0!==e.lightMapAsIrradiance&&e.lightMapAsIrradiance,loadIndex:this.loadIndex,data:{chunks:e.chunks?e.chunks:[],header:{},nodes:[],children:[],buffers:[],geometries:[],images:[],textures:[],materials:[],mappingDescriptions:[],materialApplications:[],reps:{},modelsToLoad:[],nbImagesToLoad:0}};this.modelsToLoad[this.loadIndex]=t,this.nbModelsToLoad++,this.internalLoad(this.loadIndex),this.loadIndex++},this.loadMaterial=function(e){if(!e.json)return!1;e.zipped=!1,e.chunks=[];var t=0;if(e.json.binaries&&e.binaries)for(var i=0;i<e.json.binaries.length;i++)e.json.binaries[i].extUri||(e.chunks.push(e.binaries[t]),t++);this.load(e)}}});