define("DS/VisuLoaders/StreamVisuLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager"],function(e,a,r,s,t,n){"use strict";return function(n){performance.now();this.modelsToLoad={},this.loadIndex=0;var i=e.MaterialUtils.createShinyFaceMaterial({side:e.DoubleSide,color:new e.Color(16777215)}),o=new e.MeshBasicMaterial({color:new e.Color(16777215)}),l={};this.createTextures=function(r,s){var t;for(t in r){var n=r[t],i=null;if(s.imagesCallback)i=s.imagesCallback(n,s);else{var o=n.format;o||(o=a.getExtension(n.path)),(i="hdr"===o?e.ImageUtils.loadHDRTexture(s.path+n.path+s.urlOptions):"dds"===o?e.ImageUtils.loadCompressedTexture(s.path+n.path+s.urlOptions,void 0,null,null,!1):e.ImageUtils.loadTexture2(s.path+n.path+s.urlOptions)).wrapS=n.wrapS||1e3,i.wrapT=n.wrapT||1e3,i.anisotropy=n.anisotropy||8,i.minFilter=n.minFilter||1008,i.magFilter=n.magFilter||1006,i.repeat=n.repeat||{x:1,y:1},i.sRGB="jpg"===o||"jpeg"===o}s.data.textures[n.id]=i}},this.createMaterials=function(a,r,s){var t;for(t in a){var n=a[t],i=null;if(s.materialsCallback)i=s.materialsCallback(n,s);else{var o={visible:n.visible,force:n.force,side:n.side,enableClipPlanes:n.enableClipPlanes,transparent:n.transparent,opacity:n.opacity,depthTest:n.depthTest,depthWrite:n.depthWrite};n.forceSide&&(o.forceSide=n.forceSide),void 0!==n.NRECompatibility&&(o.NRECompatibility=n.NRECompatibility),n.needTangentBinormal&&(o.needTangentBinormal=n.needTangentBinormal),n.alphaTest&&(o.alphaTest=n.alphaTest),n.color&&(o.color=(new e.Color).setRGB(n.color.r,n.color.g,n.color.b)),n.ambient&&(o.ambient=(new e.Color).setRGB(n.ambient.r,n.ambient.g,n.ambient.b)),n.emissive&&(o.emissive=(new e.Color).setRGB(n.emissive.r,n.emissive.g,n.emissive.b)),n.specular&&(o.specular=(new e.Color).setRGB(n.specular.r,n.specular.g,n.specular.b)),n.shininess&&(o.shininess=n.shininess),n.vertexColors&&(o.vertexColors=n.vertexColors),void 0!==n.diffuseMap&&(o.map=r.textures[n.diffuseMap]),void 0!==n.opacityMap&&(o.opacityMap=r.textures[n.opacityMap],o.transparent=!0),void 0!==n.normalMap&&(o.normalMap=r.textures[n.normalMap],o.needTangentBinormal=!0,void 0!==n.needTangentBinormal&&(o.needTangentBinormal=n.needTangentBinormal)),void 0!==n.normalMapScale&&(o.normalScale=new e.Vector2(n.normalMapScale.x,n.normalMapScale.y)),void 0!==n.normalMapFlipY&&(o.normalMapFlipY=n.normalMapFlipY),void 0!==n.bumpMap&&(o.bumpMap=r.textures[n.bumpMap]),void 0!==n.bumpScale&&(o.bumpScale=n.bumpScale),void 0!==n.glossiness&&(o.glossiness=n.glossiness),void 0!==n.glossinessMap&&(o.glossinessMap=r.textures[n.glossinessMap]),void 0!==n.roughnessMap&&(o.roughnessMap=r.textures[n.roughnessMap]),void 0!==n.specularMap&&(o.specularMap=r.textures[n.specularMap]),void 0!==n.specularMap&&(o.specularMap=r.textures[n.specularMap],o.specularMapLinear=!o.specularMap.sRGB),"Physical"==n.type&&(void 0!==n.emissiveMap&&(o.emissiveMap=r.textures[n.emissiveMap]),void 0!==n.metalnessMap&&(void 0===n.metalness&&(n.metalness=1),o.metalnessMap=r.textures[n.metalnessMap]),void 0!==n.metalness&&(o.metalness=n.metalness),void 0!==n.coating&&(o.coating=n.coating),void 0!==n.coatingGlossiness&&(o.coatingGlossiness=n.coatingGlossiness)),void 0!==n.iterative&&(o.iterative=n.iterative),void 0!==n.sslr&&(o.sslr=n.sslr),i=new e[n.type+"Material"](o)}r.materials[n.id]=i}},this.createGeometries=function(a,s){var t,n=s.data;for(t in a){var l=a[t],d=new e.BufferGeometryDS;for(var p in n.geometries[l.id]=d,l){var c=l[p];"vertexPositionArray"!==p&&"vertexIndexArray"!==p&&"vertexColorArray"!==p&&"vertexNormalArray"!==p&&"vertexBinormalArray"!==p&&"vertexTangentArray"!==p&&"vertexUvArray"!==p&&"vertexUv2Array"!==p||null===c||("vertexIndexArray"===p?4===c.bpe?d[p]=new Uint32Array(n.chunks[c.chunk],c.offset,c.byteLength/c.bpe):d[p]=new Uint16Array(n.chunks[c.chunk],c.offset,c.byteLength/c.bpe):d[p]=new Float32Array(n.chunks[c.chunk],c.offset,c.byteLength/c.bpe))}for(var u=0;u<l.dgs.length;u++){var m=l.dgs[u],h=m.primitives;h=new Uint32Array(n.chunks[h.chunk],h.offset,h.byteLength/h.bpe);var v=m.canonicals,b=null!=v,g=null;b&&(g=new Uint8Array(n.chunks[v.chunk],v.offset,v.byteLength/v.bpe));var f=0,y=d.vertexNormalArray?i:o,w=[];void 0!==m.gas&&n.materials[m.gas]&&(y=n.materials[m.gas]);var M=new r.DrawingGroup(y,null,m.glType,m.start,m.count,w,void 0,e.GeomTypeEnum[m.geomType],0);M.geometry=d,d.drawingGroups.push(M);for(var x=0;x<h.length;x+=4){var C=new r.SGPrimitive({cgmId:h[x],group:M,start:h[x+2],count:h[x+3]});if(s.unstreamReps){var S=h[x+1],k=n.reps[S];k||(k=new r.SGRep({cgmId:S}),n.reps[S]=k),C.rep=k,k.primitives.push(C)}if(b){var T=g[f++];if(T){C.decoration=new Array;for(var j=0;j<T;++j)C.decoration.push(g[f++])}}w.push(C)}}}},this.createNodes=function(a,r){var n,d=r.data;for(n in a){var p,c=null;if("Node3D"===(p=a[n]).type)c=new s,l[c.id]=p.children;else{var u=p.mesh3js.bs.c,m=p.mesh3js.bs.r,h=p.mesh3js.bbox.min,v=p.mesh3js.bbox.max,b=new e.Box3(new e.Vector3(h[0],h[1],h[2]),new e.Vector3(v[0],v[1],v[2])),g=new e.Sphere(new e.Vector3(u[0],u[1],u[2]),m),f=[];f.boundingSphere=g,f.boundingBox=b;for(var y=0;y<p.mesh3js.geometries.length;y++)f.push(d.geometries[p.mesh3js.geometries[y]]);var w=f.length&&f[0].vertexNormalArray?i:o;void 0!==p.mesh3js.material&&(w=d.materials[p.mesh3js.material]);var M=new e.Mesh(f,w);M.castShadow=void 0===p.mesh3js.castShadow||p.mesh3js.castShadow,M.receiveShadow=void 0===p.mesh3js.receiveShadow||p.mesh3js.receiveShadow,M.enableNormalDepth=void 0===p.mesh3js.enableNormalDepth||p.mesh3js.enableNormalDepth,c=new t(M)}if(c.name=p.id,void 0!==p.material&&c.setMaterial(d.materials[p.material]),d.nodes[p.id]=c,d.root||(d.root=c),p.matrix){var x=(new e.Matrix4).setFromArray(p.matrix);c.setMatrix(x)}r.nodeCallback&&r.nodeCallback(p,r,c)}},this.createLayers=function(a,r){var s=r.data;for(var t in s.nodes){var n=s.nodes[t],i=a[t];for(var o in i.occurrences){var l=i.occurrences[o].index,d=i.occurrences[o];if(d.layers.length){n._occurrences[l].renderable.layer=new e.BufferLayer(n._occurrences[l].renderable);for(var p=0;p<d.layers.length;p++){var c=d.layers[p],u=s.geometries[c.geometry],m=new e.DrawableInterval(c.drawableInterval.layerNum,c.drawableInterval.start,c.drawableInterval.count,s.materials[c.drawableInterval.material]);m.primitiveStart=c.drawableInterval.primitiveStart,m.primitiveCount=c.drawableInterval.primitiveCount;var h=new e.LayerInterval(u,u.drawingGroups[c.drawableGroup],m);n._occurrences[l].renderable.layer.addLayerInterval(h)}}}}},this.processJSON=function(e){e.data.nbChunks=e.json.nbChunks;var a=e.json.zbin?"zbin":"bin";e.data.chunks.length?this.processChunks(e):this.getChunks(e.data.nbChunks,e,this.processChunks,a)},this.processChunks=function(e){performance.now();var a=e.json;for(var r in this.createTextures(a.textures,e),this.createMaterials(a.materials,e.data,e),this.createGeometries(a.geometries,e),this.createNodes(a.nodes,e),performance.now(),e.data.nodes){var s=e.data.nodes[r],t=l[s.id];if(t)for(var n=0;n<t.length;n++)s.add(e.data.nodes[t[n]]);l[s.id]=null}e.unstreamLayers&&this.createLayers(a.nodes,e),performance.now(),e.destinationNode.add(e.data.root),e.doneCallback&&e.doneCallback(),e.readyCallback&&e.readyCallback(),delete this.modelsToLoad[e.loadIndex]},this.internalLoad=function(e){var a=this,r=this.modelsToLoad[e];performance.now(),r.json?this.processJSON(r):UWA.Ajax.request(r.url+".json"+r.urlOptions,{async:!0,cors:!0,withCredentials:!0,onComplete:function(e){performance.now(),r.json=JSON.parse(e),a.processJSON(r)}})},this.getChunks=function(e,a,r,s){var t=this;if(e){e--;var n=new XMLHttpRequest;n.open("GET",a.url+"__"+e+"__."+s+a.urlOptions,!0),n.responseType="arraybuffer",n.withCredentials=!0,n.onreadystatechange=function(i){4===n.readyState&&(0!==n.status&&200!==n.status||(a.data.chunks[e]=this.response,t.getChunks(e,a,r,s)))},n.send(null)}else r.call(this,a)},this.load=function(e,r,s,t,n){var i=e,o="",l=null,d=[],p=r,c=s,u=t,m=null,h=null,v=null,b=n,g=!1,f=!1;e.destinationNode&&(i=e.url,o=e.urlOptions?e.urlOptions:"",l=e.json,d=e.chunks?e.chunks:[],p=e.readyCallback,c=e.progressCallback,u=e.doneCallback,m=e.nodeCallback,h=e.imageCallback,v=e.materialCallback,b=e.destinationNode,g=!!e.layers,f=!!e.reps);var y={url:i,urlOptions:o,path:i?a.parseUrl(i+".json").directoryPath:null,json:l,readyCallback:p,progressCallback:c,doneCallback:u,imagesCallback:h,materialsCallback:v,nodeCallback:m,destinationNode:b,unstreamLayers:g,unstreamReps:f,loadIndex:this.loadIndex,data:{nbChunks:d?d.length:0,chunks:d,root:null,nodes:{},geometries:{},textures:{},materials:{},reps:{}}};this.modelsToLoad[this.loadIndex]=y,this.internalLoad(this.loadIndex),this.loadIndex++}}}),define("Visualization/StreamVisuLoader",["DS/Visualization/StreamVisuLoader","DS/DSMigration/DSMigration"],function(e,a){return a.deprecateModule("Visualization/StreamVisuLoader"),e});