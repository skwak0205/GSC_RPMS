define("DS/VCXWebLevelExploderGUI/VCXPartSlider",["UWA/Class","UWA/Core","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Core/PointerEvents","DS/RuntimeView/NLSManager","DS/Visualization/ThreeJS_DS","DS/VisuEvents/EventsManager","DS/WebappsUtils/WebappsUtils"],function(e,t,i,r,s,n,o,a,h){"use strict";var l=["back","restore"],d={},c=!1;return e.extend({init:function(e,t){this._modelEvent=new r,this._experienceBase=e,this._cursorColor=null,this._sliderColor=null,this._sliderLightColor=null,this._nbStages=null,this._ticks=null,this._tickColor=null,this._tickWidth=null,this._tickHeight=null,this._width=null,this._defaultWidth=400,this._sliderWidth=null,this._height=null,this._defaultHeight={classic:30,mab:26},this._defaultBottom=65,this._buttonWidth=32,this._defaultButtonWidth=32,this._padding=15,this._defaultPadding=15,this._divsGap=20,this._gapLength=null,this._defaultGapLength=10,this._cursorSize={width:6,height:7},this._defaultCursorSize={classic:{width:6,height:7},mab:{width:12,height:14}},this._ratio=null,this._widthStage=null,this._cursorBottomAt0=1;var s=this._experienceBase.getManager("VCXContextManager").getFrameWindow(),n=s.getActionBar()&&s.getActionBar().MAB;n&&(this._mabIsVisible=n.state.visible,n.onVisibilityChangeSubscribe("ExplodePartSlider",this._switchMABDisplay.bind(this))),this._events={stages:{},ticks:{}};for(var o=0;o<l.length;++o){var h=l[o];d[h]||(d[h]={msg:null,msgFound:!1}),d[h].msgFound||(d[h].msg=this._getButtonString(h))}this._initOptions=this._getSliderParameters(t),this._currentPos=0,this._onDragEventAvailable=a.GESTURES_MAP.onDrag,this._containerDiv=null,this._triangle=null;var u=this;this._build(),this._buildCursor(),this._subscribeToGestureEvents(),this.setRestoreButton(function(){u.setCursorPosWithTransition(0)}),this._adaptSliderDimensionsToContext(),this._cursorTransi=null,this.onResizeToken=i.subscribe({event:"/VISU/onWindowResized"},function(){u._adaptSliderDimensionsToContext()}),c||(this._experienceBase.getManager("VCXContextManager").loadCssFile("VCXWebLevelExploderGUI/VCXWebLevelExploderGUI.css",1),c=!0)},_switchMABDisplay:function(e){"string"==typeof e?this._currentMabVisibility!==e&&(this._currentMabVisibility=e,"stamp"===e?(this._mabIsVisible=!1,this._containerDiv&&(this._containerDiv.style.display="none")):(this._mabIsVisible="mobile"===e,this._containerDiv&&(this._containerDiv.style.display=null,this._adaptSliderDimensionsToContext()))):console.warn("Typeof MAB Visibility has changed !!")},_getSliderParameters:function(e){var t=function(e){return"string"==typeof e&&(/^rgb\(\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*\)$/.test(e)||/^rgba\(\s*\d{1,3},\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*\)$/.test(e)||/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(e))};if(Number.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},this._cursorColor=t(e.cursorColor)?e.cursorColor:"rgb(232, 123, 0)",this._sliderColor=t(e.sliderColor)?e.sliderColor:"rgb(66, 162, 218)",this._sliderLightColor=t(e.sliderLightColor)?e.sliderLightColor:"rgb(213, 232, 242)",this._nbStages=Number.isInteger(e.stagesNb)?e.stagesNb:1,1===this._nbStages){this._ticks=Array.isArray(e.ticks)?e.ticks.sort().filter(function(e,t,i){return(!t||e!==i[t-1])&&e>=0&&e<=1}):[],this._tickColor=t(e.tickColor)?e.tickColor:"rgb(0, 21, 255)",this._tickWidth=Number.isInteger(e.tickWidth)?e.tickWidth:2,this._tickHeight=Number.isInteger(e.tickHeight)?e.tickHeight:5}return this._width=Number.isInteger(e.width)?e.width:this._defaultWidth,this._height=this._mabIsVisible?this._defaultHeight.mab:Number.isInteger(e.height)?e.height:this._defaultHeight.classic,this._gapLength=Number.isInteger(e.gapLength)?e.gapLength:this._defaultGapLength,this._sliderWidth=this._width-(this._buttonWidth+this._divsGap),this._ratio=this._height/this._sliderWidth,this._widthStage=Math.floor((this._sliderWidth-(this._nbStages-1)*this._gapLength)/this._nbStages),{stages:this._nbStages,ticks:this._ticks,tickColor:this._tickColor,tickWidth:this._tickWidth,tickHeight:this._tickHeight,width:this._width,sliderWidth:this._sliderWidth,height:Number.isInteger(e.height)?e.height:this._defaultHeight.classic,gapLength:this._gapLength,cursorColor:this._cursorColor,sliderColor:this._sliderColor}},remove:function(){for(var e=0;e<this._nbStages;e++){var t=document.getElementById("VCXPartSliderStage"+e);t&&(this._events.stages[e]&&t.removeEventListener(this._events.stages[e].evtType,this._events.stages[e].callback),t.remove())}this.onResizeToken&&i.unsubscribe(this.onResizeToken),this.onResizeToken=null,this._onDragToken&&a.removeEventFromToken(this._onDragToken),this._onDragToken=null,this._onSpreadToken&&a.removeEventFromToken(this._onSpreadToken),this._onSpreadToken=null;var r=this._experienceBase.getManager("VCXContextManager").getFrameWindow().getActionBar().MAB;r&&(r.onVisibilityChangeUnsubscribe("ExplodePartSlider"),r.showFlyout(0)),this.button.remove(),this.button=null,this.partSliderStages.remove(),this.partSliderStages=null,this._containerDiv.remove(),this._containerDiv=null,this._triangle=null},_adaptSliderDimensionsToContext:function(){if(this._initOptions&&this._containerDiv){var e=this._experienceBase.getManager("VCXContextManager").getMainViewer().div.clientWidth;this._updateContainerDimsGivenWidth(e>600?this._initOptions.width:.6*e)}},_updateContainerDimsGivenWidth:function(e){e&&(this._width=Math.min(e,this._initOptions.width)),this._padding=this._mabIsVisible?0:this._defaultPadding;var t=this._containerDiv.parentElement,i=this._experienceBase.getManager("VCXContextManager"),r=i.getFrameWindow().getActionBar().MAB,n=i.getUIFrame(),o=0;if(this._mabIsVisible){t===n&&(this.button.classList.contains("wux-afr-cmdstarter")&&this.button.classList.remove("wux-afr-cmdstarter"),this._containerDiv.removeAttribute("style"),r.showCustomFlyout(1,this._containerDiv)),this._containerDiv.parentElement.className.includes("PlayWeb-MAB-flyout")&&"visible"!==this._containerDiv.parentElement.style.overflowX&&(this._containerDiv.parentElement.style.overflowX="visible",this._containerDiv.parentElement.style.overflowY="visible");var a=parseFloat(window.getComputedStyle(this._containerDiv.parentElement).getPropertyValue("width")),h=window.getComputedStyle(this._containerDiv).getPropertyValue("max-width"),l=430;h.includes("px")&&(l=parseInt(h.replace("px",""))),o=Math.min(l,a),this._sliderWidth=o-(this._buttonWidth+2*this._divsGap),this._height=this._defaultHeight.mab,this._gapLength=0}else{t!==n&&(t.className.includes("PlayWeb-MAB-flyout")&&(this._containerDiv.parentElement.style.overflowX=null,this._containerDiv.parentElement.style.overflowY=null),this.button.classList.contains("wux-afr-cmdstarter")||this.button.classList.add("wux-afr-cmdstarter"),this._containerDiv.removeAttribute("style"),n.appendChild(this._containerDiv));var d=this._width+2*this._padding;this._containerDiv.set({styles:{width:d+"px",marginLeft:.5*(i.getMainViewer().div.clientWidth-d)+"px"}}),o=this._width,this._sliderWidth=o-(this._buttonWidth+this._divsGap),this._height=this._initOptions.height;var c=this._sliderWidth/this._initOptions.sliderWidth;this._gapLength=Math.round(this._initOptions.gapLength*c)}c=this._sliderWidth/this._initOptions.sliderWidth;if(this._widthStage=Math.floor((this._sliderWidth-(this._nbStages-1)*this._gapLength)/this._nbStages),this._ratio=this._height/this._sliderWidth,this.partSliderStages){var u;for(u=0;u<this._nbStages;++u){var _=document.getElementById("VCXPartSliderStage"+u);_&&(this._events.stages[u]&&_.removeEventListener(this._events.stages[u].evtType,this._events.stages[u].callback),_.remove())}var g=0,v=0;for(u=0;u<this._nbStages;++u){var p=0===u?0:.5*this._gapLength,S=u===this._nbStages-1?0:.5*this._gapLength;v=(g=0===u?0:g+Math.floor((this._widthStage+2*p)*this._ratio))+Math.floor(this._widthStage*this._ratio);var f=this._buildStage(u,this._height-v,v-g,g,this._widthStage,p,S);f.inject(this.partSliderStages),this._fctPickStage=1===this._nbStages||this._mabIsVisible?this._onPickUniqueStage():this._onPickStage(u),f.addEventListener(s.POINTERDOWN,this._fctPickStage),this._events.stages[u]={evtType:s.POINTERDOWN,callback:this._fctPickStage}}this.partSliderStages.setStyle("width",this._sliderWidth+"px"),this.partSliderStages.setStyle("height",this._height+"px");var P=this._mabIsVisible?"mab":"classic";this._cursorSize.width=this._defaultCursorSize[P].width,this._cursorSize.height=this._defaultCursorSize[P].height;var m=this._cursorPos2PixelInSlider(this._currentPos)/this._sliderWidth,x=this._cursorBottomAt0+m*this._height,E=100*m+"%";this._triangle.set({styles:{borderWidth:this._cursorSize.height+"px "+this._cursorSize.width+"px 0px "+this._cursorSize.width+"px",marginLeft:"-"+this._cursorSize.width+"px",bottom:x+"px",left:E+"px"}})}},getCursorPos:function(){return this._currentPos},setCursorPos:function(e){this._onChangeCursorPos(this._cursorPos2PixelInSlider(e))},setCursorPosWithTransition:function(e){this._onChangeCursorPosWithTransi(this._cursorPos2PixelInSlider(e))},addElementToSliderDiv:function(e){e.inject(this._containerDiv)},subscribe:function(e,t){return this._modelEvent.subscribe({event:e},t)},unsubscribe:function(e){this._modelEvent.unsubscribe(e)},_buildCursor:function(){this._mabIsVisible?(this._cursorSize.width=this._defaultCursorSize.mab.width,this._cursorSize.height=this._defaultCursorSize.mab.height):(this._cursorSize.width=this._defaultCursorSize.classic.width,this._cursorSize.height=this._defaultCursorSize.classic.height),this._triangle=t.createElement("div",{html:"",id:"partSliderCursor",styles:{bottom:"4px",borderWidth:this._cursorSize.height+"px "+this._cursorSize.width+"px 0px "+this._cursorSize.width+"px",borderColor:this._cursorColor+"transparent transparent transparent",marginLeft:"-"+this._cursorSize.width+"px"}}),this._triangle.inject(this.partSliderStages)},setRestoreButton:function(e){return this._setButton(e,"restore","icons/32/I_VCX_ExplLvlRestoreButton.png")},setBackButton:function(e){return this._setButton(e,"back","icons/32/I_VCX_ExplLvlBackButton.png")},_setButton:function(e,t,i){this.button.removeEvent(s.POINTERDOWN),this._buttonWidth=this._defaultButtonWidth,this.button.set({class:t+"Button",title:this._getButtonString(t),styles:{height:this._buttonWidth+"px"}});var r=this;if(d[t].imgLoaded)r.button.set({styles:{backgroundImage:"url("+h.getWebappsAssetUrl("VCXWebLevelExploderGUI",i)+")"}});else{var n=new Image;n.onload=function(){r.button&&(r.button.set({styles:{backgroundImage:"url("+this.src+")"}}),d[t].imgLoaded=!0,r._updateContainerDimsGivenWidth(r._width))},n.src=h.getWebappsAssetUrl("VCXWebLevelExploderGUI",i)}return this.button.classList.add("wux-afr-cmdstarter"),this.button.addEvent(s.POINTERDOWN,e),this.button},_getButtonString:function(e){var t,i,r="VCXWebLevelExploderGUI/VCXWebLevelExploderGUI";if("back"===e)t="PreviousLevelButton",i="Go back to last exploded view.";else{if("restore"!==e)return null;t="RestoreModelButton",i="Restore exploded model to its original state."}if(!d[e].msgFound){var s=null;n.onResourceLoaded({resourceFile:r},function(){s=this.getTitle({key:t})}),n.loadResource({resourceFile:r}),s?(d[e].msg=s,d[e].msgFound=!0):(d[e].msg=i,d[e].errorDisplayed||(console.log("VCXPartSlider: Could not recover a string for a text in the current language."),d[e].errorDisplayed=!0))}return d[e].msg},_subscribeToGestureEvents:function(){var e=this,t=this._experienceBase.getManager("VCXContextManager").getMainViewer();this._onDragEventAvailable?(this._ondragCB=function(t){e._stopCursorAnimation();var i=t.from[0].type,r="Mouse"===i?t.from[0].event:"Touch"===i?t.from[0].event.changedTouches[0]:null,s=new o.Vector2(r.pageX,r.pageY),n=e._getSliderPositionLeft(),a=s.x-n,h="end"===t.state;e._onChangeCursorPos(a,h)},this._onDragToken=a.addEvent(this.partSliderStages,"onDrag",this._ondragCB)):this._triangle.addEvent(s.POINTERDOWN,function(){e._fctDragEnd=e.onDragEnd(e),e._fctDrag=function(t){t.preventDefault();var i=e._getSliderPositionLeft(),r=t.pageX-i;e._onChangeCursorPos(r)},document.removeEventListener(s.POINTERMOVE,e._fctDrag),document.removeEventListener(s.POINTERUP,e._fctDragEnd),document.addEventListener(s.POINTERMOVE,e._fctDrag),document.addEventListener(s.POINTERUP,e._fctDragEnd)}),this._onSpreadCB=function(t){var i=(t.gesture.distance-t.gesture.lastDistance)*e._nbStages/600+e._currentPos;e._onChangeCursorPos(e._cursorPos2PixelInSlider(i))},this._onSpreadToken=a.addEvent(t.canvas,"onSpread",this._onSpreadCB)},_stopCursorAnimation:function(){null!==this._cursorTransi&&(clearInterval(this._cursorTransi),this._cursorTransi=null)},_buildStage:function(e,i,r,s,n,o,a){var h=t.createElement("div",{id:"VCXPartSliderStage"+e,class:"stage",styles:{marginLeft:o+"px",marginRight:a+"px",width:n+"px"}}),l=h.getStyleName("float");(h.setStyle(l,"left"),0!==i)&&t.createElement("div",{class:"blankSpace",styles:{height:i+"px"}}).inject(h);for(var d=this,c=function(e,i){var s=i;"number"!=typeof s&&(s=parseInt(i));var o,a,h,l,c=0===s,u=s===d._nbStages-1;switch(e){case"border":case"filler":if("border"===e)l=n+"px",h=r+"px";else if("filler"===e){var _=Math.floor(d._currentPos);_>i?(l=n+"px",h=r+"px"):_<i?(l="0px",h="0px"):(l=d._currentPos%1*n+"px",h=d._currentPos%1*r+"px")}break;case"background":a="1px",h=(c?r-2:r)+"px",d._mabIsVisible&&1!==d._nbStages?(o=c?Math.floor(2/d._ratio)+"px":"0px",l=(c?n-Math.floor(2/d._ratio):u?n-1:n)+"px"):(o=c?Math.floor(2/d._ratio)-1+"px":"1px",l=(c?n-Math.floor(2/d._ratio):n-2)+"px")}var g=t.createElement("div",{class:"triangle",styles:{left:o,borderWidth:h+" "+l+" 0 0"}});return a&&(g.style.top=a),g},u=function(i,r){var o,a,h,l=e===d._nbStages-1;switch(i){case"border":case"filler":if(o=d._sliderColor,a=s+"px","border"===i)h=n+"px";else if("filler"===i){var c=Math.floor(d._currentPos);h=c>r?n+"px":c<r?"0px":d._currentPos%1*n+"px"}break;case"background":o=d._sliderLightColor,a=s-2+"px",h=d._mabIsVisible&&1!==d._nbStages?(l?n-1:n)+"px":n-2+"px"}return t.createElement("div",{class:"base",styles:{background:o,width:h,height:a}})},_=["border","background","filler"],g=0;g<_.length;++g){var v=_[g],p=t.createElement("div",{class:v,styles:{width:n+"px"}});if("filler"===v&&(p.style.bottom="0px"),c(v,e).inject(p),0!==s)u(v,e).inject(p);p.inject(h)}return h},_build:function(){this._containerDiv||(this._containerDiv=t.createElement("div",{html:"",id:"partSliderContainer"})),this.partSliderStages=t.createElement("div",{html:"",id:"partSliderStages",styles:{width:this._sliderWidth+"px",height:this._height+"px"}}),this.partSliderStages.inject(this._containerDiv);var e={id:"partSliderButton",class:"wux-afr-cmdstarter",title:this._getButtonString("restore"),styles:{height:this._defaultButtonWidth+"px"}};this.button=t.createElement("div",e),this.button.inject(this._containerDiv),1===this._nbStages&&this._ticks.length>0&&this._buildTicks(this._ticks);var i,r=0,n=0;for(i=0;i<this._nbStages;++i){var o=0===i?0:.5*this._gapLength,a=i===this._nbStages-1?0:.5*this._gapLength;n=(r=n+Math.floor(2*o*this._ratio))+Math.floor(this._widthStage*this._ratio),this._buildStage(i,this._height-n,n-r,r,this._widthStage,o,a).inject(this.partSliderStages)}var h=null;if(1===this._nbStages&&this._ticks.length>0)for(i=0;i<this._ticks.length;++i)(h=document.getElementById("VCXPartSliderTickContainer"+i))&&(this._fctPickStage=this._onPickTick(h,i),h.addEventListener(s.POINTERDOWN,this._fctPickStage),this._events.ticks[i]={evtType:s.POINTERDOWN,callback:this._fctPickStage});for(i=0;i<this._nbStages;++i)(h=document.getElementById("VCXPartSliderStage"+i))&&(this._fctPickStage=1===this._nbStages||this._mabIsVisible?this._onPickUniqueStage():this._onPickStage(i),h.addEventListener(s.POINTERDOWN,this._fctPickStage),this._events.stages[i]={evtType:s.POINTERDOWN,callback:this._fctPickStage});var l=this._experienceBase.getManager("VCXContextManager"),d=l.getUIFrame();if(this._mabIsVisible){l.getFrameWindow().getActionBar().MAB.showCustomFlyout(1,this._containerDiv)}else{var c=this._width+2*this._padding;this._containerDiv.set({styles:{width:c+"px",bottom:this._defaultBottom+"px",marginLeft:.5*(l.getMainViewer().div.clientWidth-c)+"px",padding:this._padding+"px"}}),this._containerDiv.inject(d)}},_buildTicks:function(e){for(var i=Math.max(20,this._tickWidth),r=0;r<e.length;++r){var s=t.createElement("div",{id:"VCXPartSliderTickContainer"+r,class:"tickContainer",styles:{left:e[r]*this._sliderWidth-1+"px",width:i+"px",marginLeft:"-"+.5*i+"px"}});if(0!==e[r]&&1!==e[r])t.createElement("div",{id:"VCXPartSliderInnerTick"+r,class:"innerTick",styles:{marginTop:(1-e[r])*this._height+"px",height:Math.min(this._tickHeight,e[r]*this._height)+"px",width:this._tickWidth+"px",marginLeft:.5*(i-this._tickWidth)+"px",backgroundColor:this._tickColor}}).inject(s);s.inject(this.partSliderStages)}},_onPickStage:function(e){var t=this,i=function(i){i.preventDefault();var r=e+.5;t._onChangeCursorPosWithTransi(t._cursorPos2PixelInSlider(r))};return this._fctPickStage=i,i},_onPickUniqueStage:function(){var e=this,t=function(t){t.preventDefault();var i=e._getSliderPositionLeft();if(i){var r=t.pageX-i;e._onChangeCursorPosWithTransi(r)}};return this._fctPickStage=t,t},_onPickTick:function(e){var t=this,i=function(i){i.preventDefault();var r=e.style.left.length,s=t._pixelInSlider2CursorPos(parseInt(e.style.left.substr(0,r-2),10));t._onChangeCursorPosWithTransi(t._cursorPos2PixelInSlider(s))};return this._fctPickStage=i,i},_getContainerPositionLeft:function(){var e=document.getElementById("partSliderContainer");return e?e.getBoundingClientRect().left:null},_getSliderPositionLeft:function(){var e=document.getElementById("partSliderStages");return e?e.getBoundingClientRect().left:null},onDrag:function(e){var t=function(t){t.preventDefault();var i=e._getSliderPositionLeft();if(i){var r=e._experienceBase.getManager("VCXContextManager").getMainViewer().canvas.getBoundingClientRect(),s=t.pageX-(r.left+i);e._onChangeCursorPos(s)}};return e._fctDrag=t,t},onDragEnd:function(e){return function(){document.removeEventListener(s.POINTERMOVE,e._fctDrag),document.removeEventListener(s.POINTERUP,e._fctDragEnd),e._modelEvent.publish({event:"onChangeCursorPos",data:{eventChannel:"onChangeCursorPos",newCursorPos:e._currentPos,bReleased:!0,end:!0}})}},_getRealPos:function(e){if(e<0)return 0;if(e>this._sliderWidth)return this._sliderWidth;var t=Math.floor(e/(this._widthStage+this._gapLength))*(this._widthStage+this._gapLength)+this._widthStage,i=t+this._gapLength;return e<=t?e:e-t<i-e?t:i},_cursorPos2PixelInSlider:function(e){var t=Math.floor(e),i=e-t;return t*(this._widthStage+this._gapLength)+i*this._widthStage},_pixelInSlider2CursorPos:function(e){var t=Math.floor(e/(this._widthStage+this._gapLength)),i=t*(this._widthStage+this._gapLength);return t+Math.min((e-i)/this._widthStage,.999999)},_onChangeCursorPos:function(e,t){var i=(e=this._getRealPos(e))/this._sliderWidth,r=document.getElementById("partSliderCursor");if(r){var s=this._cursorBottomAt0;s+=i*this._height,r.style.left=100*i+"%",r.style.bottom=s+"px"}this._currentPos=this._pixelInSlider2CursorPos(e);for(var n=Math.floor(this._currentPos),o=document.getElementsByClassName("filler"),a=0;a<o.length;++a){var h=o[a],l=h.parentNode.id,d=parseInt(l.replace("VCXPartSliderStage","")),c=0,u=0,_=Math.floor(this._widthStage*this._ratio);n===d?(c=this._currentPos%1*(this._widthStage+1),u=this._currentPos%1*_):this._currentPos>a&&(c=this._widthStage,u=_);for(var g=h.childNodes,v=0;v<g.length;++v){var p=g[v];"triangle"===p.className?(p.style.borderRightWidth=c+"px",p.style.borderTopWidth=u+"px"):"base"===p.className&&(p.style.width=c+"px")}}this._modelEvent.publish({event:"onChangeCursorPos",data:{eventChannel:"onChangeCursorPos",newCursorPos:this._currentPos,bReleased:!1,end:"boolean"==typeof t&&t}})},_onChangeCursorPosWithTransi:function(e){this._stopCursorAnimation();var t=this,i=0,r=t._cursorPos2PixelInSlider(this._currentPos),s=new o.Clock;this._cursorTransi=setInterval(function(n,o){var a=Math.floor(n*o),h=s.getDelta();(i+=h*n)>=a&&(i=a,clearInterval(t._cursorTransi),t._cursorTransi=null,s.stop());var l=i/a,d=r+(e-r)*l,c=1===l;t._onChangeCursorPos(d,c)},1e3/60,60,.5)}})}),define("DS/VCXWebLevelExploderGUI/VCXLevelExploderManager",["DS/ApplicationFrame/CommandsManager","DS/CoreEvents/ModelEvents","UWA/Class"],function(e,t,i){"use strict";var r=i.extend({init:function(){this._tokens={},this._setExplodeStateAllowed=!0},initialize:function(){this._parent(),this._levelExploderStruct={},this._rootPathsStack=[]},postInitialize:function(){this._parent(),this._modelEvent=new t},unInitialize:function(){this._parent(),this._levelExploderStruct=null,this._rootPathsStack=null,this._explodeLvlCmd=null},setLoadHandling:function(e){"boolean"==typeof e&&(this._setExplodeStateAllowed=e)},getLoadHandling:function(){return this._setExplodeStateAllowed},getExplodeLevelState:function(){if(0===this._rootPathsStack.length)return console.log("No cache available in LevelExploderManager yet."),null;var e=this._cloneLevelExploderStruct(this._levelExploderStruct),t=this._cloneRootPathsStack(this._rootPathsStack),i=t.length-1,r=t[i];return{basicInfos:{level:i,nodeRoot:r.relativeRootPath&&r.relativeRootPath.getLastElement(),cursorPosition:r.cursorPosition},completeInfos:{structure:e,rootPathsStack:t}}},setExplodeLevelState:function(t){if(this._setExplodeStateAllowed){var i=this._experienceBase.getManager("VCXContextManager"),r=i&&i.getContext();if(this._explodeLvlCmd=e.getCommand("EnhancedExplode",r)||e.getCommand("VCXLevelExploderGUICmd",r),this._explodeLvlCmd){var s=t;s.completeInfos&&(s=s.completeInfos),"object"==typeof s&&s.structure&&s.rootPathsStack?(this._levelExploderStruct=this._cloneLevelExploderStruct(s.structure),this._rootPathsStack=this._cloneRootPathsStack(s.rootPathsStack),this._explodeLvlCmd.restoreSetState(s.structure,s.rootPathsStack,!1)):console.warn("Issue: VCXLevelExploderManager.setExplodeLevelState() method needs an object as parameter, in the same form as the one given by a call to VCXLevelExploderManager.getExplodeLevelState() method.")}else console.warn("Issue: No LevelExploder command has been found for this app.")}else console.warn("Currently using the original design of LevelExploder, thus setting of specific explode state currently denied.\nUse a call to VCXLevelExploderManager.setLoadHandling(true) to enable it.")},subscribeToStateChanges:function(e){return this._modelEvent.subscribe({event:"LevelExplodeChanges"},e)},unsubscribeFromStateChanges:function(e){this._modelEvent.unsubscribe(e)},bothStatesAreTheSame:function(e,t){if(!e||!t)return!1;var i=e.completeInfos.rootPathsStack,r=t.completeInfos.rootPathsStack;if(!i||!r)return!1;if(i.length!==r.length)return!1;for(var s=0;s<i.length;++s){var n=i[s],o=r[s],a=n.relativeRootPath,h=o.relativeRootPath;if(!a.isEqual(h))return!1;if(n.cursorPosition!==o.cursorPosition)return!1}return!0},bothStatesShareCurrentSubExplode:function(e,t){if(!e||!t)return!1;var i=e.completeInfos.rootPathsStack,r=i[i.length-1],s=t.completeInfos.rootPathsStack,n=s[s.length-1],o=r.relativeRootPath,a=n.relativeRootPath;return!!o.isEqual(a)&&r.cursorPosition===n.cursorPosition},recordState:function(e){if(e){var t=!1;if(e.levelExploderStruct)for(var i in e.levelExploderStruct)if(e.levelExploderStruct.hasOwnProperty(i)){var r=e.levelExploderStruct[i];this._levelExploderStruct[i]||(this._levelExploderStruct[i]={});for(var s=Object.keys(r).length-1;s>=0&&!this._levelExploderStruct[i][s];--s)this._levelExploderStruct[i][s]=r[s]}if(e.rootPathsStack){var n=null;if(e.cursorChangeOnly)n=e.rootPathsStack[e.rootPathsStack.length-1].cursorPosition,this._rootPathsStack[this._rootPathsStack.length-1].cursorPosition=n,t=!0;else{this._rootPathsStack=[];for(var o=0;o<e.rootPathsStack.length;++o){var a=e.rootPathsStack[o].relativeRootPath;n=e.rootPathsStack[o].cursorPosition,this._rootPathsStack.push({relativeRootPath:a,cursorPosition:n})}t=!0}}if(t){var h={eventChannel:"LevelExplodeChanges",isManualManipulation:!1,cursorPosition:this._rootPathsStack[this._rootPathsStack.length-1].cursorPosition};e.cursorChangeOnly||(h.rootPath=this._rootPathsStack[this._rootPathsStack.length-1].relativeRootPath),this._modelEvent.publish({event:"LevelExplodeChanges",data:h})}}},_publishVolatileManipEvent:function(e,t){var i={eventChannel:"LevelExplodeChanges",isManualManipulation:!0,nodePath:e,localPosition:t};this._modelEvent.publish({event:"LevelExplodeChanges",data:i})},_cloneLevelExploderStruct:function(e){var t={};for(var i in e)if(e.hasOwnProperty(i))for(var r in t[i]={},e[i])if(e[i].hasOwnProperty(r)){if(!e[i][r]){console.warn("There should be a true boolean-evaluated-value here, either number or object");continue}var s="number"==typeof e[i][r]?e[i][r]:Object.keys(e[i][r]).length;t[i][r]=s}return t},_cloneRootPathsStack:function(e){for(var t=[],i=0;i<e.length;++i){var r=e[i],s=r.relativeRootPath.clone(),n=r.cursorPosition;t.push({relativeRootPath:s,cursorPosition:n})}return t}});return Object.defineProperty(r.prototype,"componentType",{enumerable:!0,get:function(){return"VCXLevelExploderManager"}}),r}),define("DS/VCXWebLevelExploderGUI/VCXLevelExploderGUICmd",["UWA/Core","DS/Core/PointerEvents","DS/CoreEvents/Events","DS/ApplicationFrame/Command","DS/ApplicationFrame/CommandsManager","DS/ApplicationFrame/FrameWindowsManager","DS/Manipulators/ScreenPlaneManipulator","DS/VCXWebExperienceBase/VCXSceneGraphOverridesServices","DS/VCXWebExperienceBase/VCXOverridesChangeServices","DS/VCXWebExperienceBase/VCXPathElementTools","DS/VCXWebLevelExploderKernel/VCXLevelExploderKernelServices","DS/VCXWebLevelExploderGUI/VCXPartSlider","DS/VCXWebModifiablesServices/VCXModifiablesAccess","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/VisuEvents/EventsManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i,r,s,n,o,a,h,l,d,c,u,_,g,v,p){"use strict";return r.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),this._explodeDisabledLogDisplayed=!1,this.neverLaunched=!0,this._largeSession=null,this._cmdAlreadyActivated=!1,this._loadingFinished=!1,this._experienceBase=null,this._vcxPartSlider=null,this._levelExploderStruct=null,this._rootPathsStack=null,this._overrideSetStack=null,this._manipulationOverrideSet=null,this._moveableElManipulators=null,this._elementInfoBeforeManip=null,this._pathesInitFrames={},this.PRODUCT_TYPES=d.PRODUCT_TYPES,this._tokenBackTrigger=null,this._tokenCursorPosUpdate=null;var t=this.getFrameWindow()||n.getFrameWindow(e.context),r=t&&t.getViewer(),o=this;if(r&&r.canvas){this._onSpreadToken=v.addEvent(t.getViewer().canvas,"onSpread",function(){var t=s._getCurrent(e.context);null!=t&&"myDefaultCmd"!=t||o.isRunning()||o.begin()})}else console.warn("Feature to execute levelExploder cmd from onSpread gesture could not be initialized...");var a=function(){if(!o._cmdAlreadyActivated){o._experienceBase=t._experienceBase;var e=o._experienceBase&&o._experienceBase.getManager("VCXContextManager");if(e&&e.frameWindow){var i=e&&e.getRootPathElement().clone();if(i){var r=i&&o._getExplodeRootPath(i);if(r){o.isEnabled()||(o.enable(),o._cmdAlreadyActivated=!0,console.log("Model compatible for explode: explode cmd enabled!"));var s=o._experienceBase&&o._experienceBase.getManager("VCXLevelExploderManager");if(!s)return;o.neverLaunched=!0,o._rootPathsStack=[];var n={relativeRootPath:r,cursorPosition:0};o._rootPathsStack.push(n),o._levelExploderStruct={};var a=r.getLastElement(),h=d._getStagesInfo(a);o._ignoredStagesIdxs=h.discardedStagesIdxs,o._levelExploderStruct[a.id]=[o._getStage(r,0)],s.recordState({rootPathsStack:o._rootPathsStack,levelExploderStruct:o._levelExploderStruct})}else o.disable(),o._levelExploderStruct=null,o._rootPathsStack=null,o._overrideSetStack=null}}}};this._tokenSceneGraphUpdated=i.subscribe({event:"/VISU/onSceneGraphUpdate"},function(e){!o._cmdAlreadyActivated&&o._loadingFinished&&a()});var h=t.experience;h||console.warn("Can't find current experience for explode command initialization."),this._tokenModelLoadingStarted=h&&h.subscribe("ASSET/LOADINGSTARTED",function(){o._cmdAlreadyActivated=!1,o._loadingFinished=!1},!0),this._tokenModelLoaded=h&&h.subscribe("ASSET/LOADINGFINISHED",function(){o._loadingFinished=!0,a()}),h&&h.isLoadingFinished&&h.isLoadingFinished()&&(o._loadingFinished=!0,a())},destroy:function(){var e=this.getFrameWindow(),t=e&&e.experience;t&&(this.isRunning()&&this.endExecute(),this._tokens=null,this._tokenSceneGraphUpdated&&(i.unsubscribe(this._tokenSceneGraphUpdated),this._tokenSceneGraphUpdated=null),this._tokenChangeCurrentModel&&(i.unsubscribe(this._tokenChangeCurrentModel),this._tokenChangeCurrentModel=null),this._tokenModelLoaded&&t.unsubscribe(this._tokenModelLoaded),this._onSpreadToken&&v.removeEventFromToken(this._onSpreadToken),this._tokenModelLoaded=null,this._onSpreadToken=null)},_generateSceneGraphFromGraphCandidates:function(){var e=this.getFrameWindow().experience,t=e&&e.pad3DViewer&&e.pad3DViewer.getController();if(t){var i=e.getRootBag(),r=p.getReferences(i);if(0===r.length){var s=i.children;s&&s.length>0&&(1===s.length?0===(r=p.getReferences(s[0])).length&&d.doesNodeHasProductTypeValue(s[0],this.PRODUCT_TYPES.REFERENCE)&&(r=s):s.length>1&&console.warn("ExplodeLevel: Need to consider more than one element under rootBag !!"))}1!==r.length&&console.warn("Check the other references for the referenceIterator"),i=r[0];var n=t.createReferenceIterator(i.modelIdentification);return this._getLeavesRefIterators([n]).map(function(e){return e.getReferenceId()})}console.warn("Can't find a Pad3DViewerController !!")},_getLeavesRefIterators:function(e){if(Array.isArray(e)){for(var t=[],i=0;i<e.length;++i){var r=e[i],s=r.getChildren();if(s.length>0){var n=s.map(function(e){return e.getReferenceIterator()});t=t.concat(this._getLeavesRefIterators(n))}else t.push(r)}return t}},execute:function(){this._parent();var e=this.getFrameWindow();this._experienceBase=e._experienceBase;var t=this._experienceBase.getManager("VCXContextManager");this._viewer=t.getMainViewer();var i=this.getFrameWindow().experience;this._pad3DViewerController=i&&i.pad3DViewer&&i.pad3DViewer.getController();var r=i.getRootBag();if(this._pad3DViewerController&&this._pad3DViewerController.isLargeSession){this._largeSession=this._pad3DViewerController.isLargeSession(),this._largeSession=!0;var s=r.children[0];s&&s.modelIdentification&&(this._largeSession?(this._pad3DViewerController.pauseProgressiveLoading(),i.DynamicProgressUI&&i.DynamicProgressUI.pause()):(this._leavesRefIDS=null,this._leavesRefIDS=this._generateSceneGraphFromGraphCandidates(),this._pad3DViewerController.lockNodes({ids:this._leavesRefIDS}))),this._initExplodeCmd()}else this._initExplodeCmd()},_initExplodeCmd:function(){var e=this,t=this._experienceBase.getManager("VCXContextManager");this._levelExploderManager=this._experienceBase.getManager("VCXLevelExploderManager"),this._overrideSetStack=[];var i=this._levelExploderManager&&this._levelExploderManager.getLoadHandling()?this._levelExploderManager.getExplodeLevelState():null;if(i&&i.completeInfos&&(i=i.completeInfos),!this.neverLaunched&&i&&i.rootPathsStack.length>0)this.restoreSetState(i.structure,i.rootPathsStack,!0),this._subscribeToSliderEvents();else{var r=t.getRootPathElement().clone(),s=this._getExplodeRootPath(r);if(!s)return void this.end();this._rootPathsStack=[];var n={relativeRootPath:s,cursorPosition:.5};this._rootPathsStack.push(n);var o=s.getLastElement();if(null===this._vcxPartSlider){var h=d._getStagesInfo(o),l=h.nbOfStages;if(0===l)return console.warn("No stages found. End of the command."),void this.end();this._ignoredStagesIdxs=h.discardedStagesIdxs;var _={stagesNb:l};this._vcxPartSlider=new c(this._experienceBase,_),this._subscribeToSliderEvents()}var g=a.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer);g.name="SGOverrideSet ExplodeLvl0",g.explodeRootPath=s,this._overrideSetStack.push(g),this._levelExploderManager&&this._levelExploderManager.recordState({rootPathsStack:this._rootPathsStack}),this.initializeFirstExplode()}this._doublePointerClickCB=function(t){var i=u.GetPathElementFromEvent(t,e._experienceBase);i&&e._onChangeLevelCB(i)},v.addEvent(this._viewer.canvas,"onPrimaryPointerDoubleClick",this._doublePointerClickCB),this.neverLaunched=!1,this._tokens||(this._tokens={}),this._tokens.lmdToken=v.addEvent(this._viewer.canvas,"onLeftMouseDown",this._onPointerDownCB.bind(this)),this._tokens.touchToken=v.addEvent(this._viewer.canvas,"onTouch",this._onPointerDownCB.bind(this))},initializeFirstExplode:function(){if(this._vcxPartSlider){var e=this._rootPathsStack[0].relativeRootPath;this._updateExplode(.5,!0);var t=e.getBoundingSphere(this._viewer);this._updateExplode(0,!0),this._vcxPartSlider.setCursorPosWithTransition(.5),this.getFrameWindow().getViewpoint().reframe(null,500,t)}},restoreSetState:function(e,t,i){if(e&&t){var r,s;for(r=0;r<t.length;++r){if(!e[(s=t[r].relativeRootPath).getLastElement().id])return void console.warn("Something has wrong with the consistency of the infos given in parameter of the current method...")}i||this._resetExplode(),this._levelExploderStruct={};var n=t.slice();this._overrideSetStack=[];for(var o=this._viewer.getSceneGraphOverrideSetManager(),h=o.getNumberOfSceneGraphOverrideSets()-1;h>=0;--h){var l=o.getSceneGraphOverrideSetAt(h);l&&l.name&&l.name.includes("SGOverrideSet Explode")&&o.removeSceneGraphOverrideSet(l)}for(this._rootPathsStack=[],r=0;r<n.length;++r){s=n[r].relativeRootPath;var c=n[r].cursorPosition;this._rootPathsStack[r]={relativeRootPath:s,cursorPosition:0};var u=s&&s.getLastElement(),_=d._getStagesInfo(u),g=_.nbOfStages;this._ignoredStagesIdxs=_.discardedStagesIdxs;var v=a.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer);if(v.name="SGOverrideSet ExplodeLvl"+r,v.explodeRootPath=s,this._overrideSetStack.push(v),this.isRunning()&&this._isolate(s,0!==r?this._rootPathsStack[r-1].relativeRootPath:null),this._updateExplode(c),this.isRunning())r===n.length-1&&this._updateSlider(g,c)}this.neverLaunched=!1}},isExplodable:function(e){return Boolean(this._getExplodeRootPath(e))},_getExplodeRootPath:function(e){var t=e.clone(),i=e.getLastElement(),r=d.doesNodeHasProductTypeValue(i)?i:null,s=null,n=null;if(!r){for(n=[i];!r&&0!==n.length;){for(var o=[],a=[],h=0;h<n.length;++h){for(var l=n[h],c=0;c<l.children.length;++c)s=l.children[c],d.doesNodeHasProductTypeValue(s)&&((d.doesNodeHasProductTypeValue(s,this.PRODUCT_TYPES.INSTANCE)||d.doesNodeHasProductTypeValue(s,this.PRODUCT_TYPES.REFERENCE))&&a.push(s),o.push(s));1===a.length?r?console.log("explodeRootNode already found on another branch from root.. the case of multi-explodeRoot nodes is not supported"):r=a[0]:a.length>1&&(r?console.log("explodeRootNode already found on another branch from root.. the case of multi-explodeRoot nodes is not supported"):r=l)}n=o}if(0===n.length)return console.warn("No node has been found as decent candidate for the root of the explode for current model."),null}if(0===r.children.length)return this._explodeDisabledLogDisplayed||(console.log("Nothing to explode under the root of the current model: explode cmd disabled for now.."),this._explodeDisabledLogDisplayed=!0),null;for(var u=!1;!u&&r.children.length>0;){n=r.children;var _=[];s=null,d.doesNodeHasProductTypeValue(n[0],this.PRODUCT_TYPES.REFERENCE)&&(n=r.children[0].children);for(var g=0;g<n.length;++g){s=n[g];var v=d.doesNodeHasProductTypeValue(s,this.PRODUCT_TYPES.INSTANCE),p=d.doesNodeHasProductTypeValue(s,this.PRODUCT_TYPES.INSTANCE_REP);(v||p)&&_.push(s)}if(1===_.length)r=_[0];else{if(0===_.length)return null;u=!0}}for(var S=r,f=[];S!==i;)f.push(S),S=S.parents[0];for(;0!==f.length;)t.addElement(f.pop());return t},pauseExecute:function(){},resumeExecute:function(){},endExecute:function(){this._parent(),this._unsubscribeToSliderEvents(),v.removeEvent(this._viewer.canvas,"onPrimaryPointerDoubleClick",this._doublePointerClickCB),this._removeTemporaryChanges();var e=this._experienceBase.getManager("VCXLevelExploderManager");e?(e.recordState({rootPathsStack:this._rootPathsStack,levelExploderStruct:this._levelExploderStruct}),e.getLoadHandling()?this._unghostAll():this._resetExplode()):this._resetExplode(),null!==this._vcxPartSlider&&(this._vcxPartSlider.remove(),this._vcxPartSlider=null);var t=this.getFrameWindow().experience,r=t.getRootBag(),s=r&&r.children[0];this._pad3DViewerController&&s&&s.modelIdentification&&(this._largeSession?(this._pad3DViewerController.resumeProgressiveLoading(),t.DynamicProgressUI&&t.DynamicProgressUI.play()):this._pad3DViewerController.unlockNodes({ids:this._leavesRefIDS}),this._leavesRefIDS=null,this._largeSession=null,this._pad3DViewerController=null,this._levelExploderStruct=null),this._tokens&&(this._tokens.pointerDownToken&&(i.unsubscribe(this._tokens.pointerDownToken),this._tokens.pointerDownToken=null),(this._tokens.lmdToken||this._tokens.touchToken)&&(this._tokens.lmdToken&&v.removeEventFromToken(this._tokens.lmdToken),this._tokens.lmdToken=null,this._tokens.touchToken&&v.removeEventFromToken(this._tokens.touchToken),this._tokens.touchToken=null))},_resetExplode:function(){if(this._overrideSetStack&&this._overrideSetStack.length>0){this._removeTemporaryChanges();for(var e=this._rootPathsStack.length-1;e>0;--e){this._onBackTriggerCB(!0)}if(this._overrideSetStack)if(1!==this._overrideSetStack.length)console.warn("Something has gone wrong with the _overrideSetStack member");else{var t=this._overrideSetStack.pop();!a.removeSceneGraphOverrideSet(this._experienceBase,t,this._viewer)&&console.warn("Something has gone wrong with the removal of exec overrideSet")}this._rootPathsStack&&this._rootPathsStack.length>0||console.warn("There should have been a path available in this array.."),this._updateGroundIfExistsAndRender()}},_updateLvlExplStruct:function(e,t){var i=e;i||(i=this._rootPathsStack[this._rootPathsStack.length-1].relativeRootPath);var r=i.getLastElement(),s=t;s||(s=0),this._levelExploderStruct||(this._levelExploderStruct={}),this._levelExploderStruct[r.id]||(this._levelExploderStruct[r.id]=[]),this._levelExploderStruct[r.id][s]=this._getStage(i,s),this._levelExploderManager&&this._levelExploderManager.recordState({levelExploderStruct:this._levelExploderStruct})},_getStage:function(e,t){for(var i,r=this,s=0,n=0;n<this._ignoredStagesIdxs.length&&this._ignoredStagesIdxs[n]<=t;++n)++s;return function e(n,o,a){for(var h=n.children.filter(function(e){return d.doesNodeHasProductTypeValue(e,r.PRODUCT_TYPES.INSTANCE)||d.doesNodeHasProductTypeValue(e,r.PRODUCT_TYPES.INSTANCE_REP)}).length>0,l=0;l<n.children.length;l++){var c=n.children[l],u=d.doesNodeHasProductTypeValue(c,r.PRODUCT_TYPES.INSTANCE_REP);if(h||!u){var _=o.clone();_.addElement(c);var g=a;(d.doesNodeHasProductTypeValue(c,r.PRODUCT_TYPES.INSTANCE)||h&&u)&&(g-s===t&&(r.saveInitPositionWithOverrideSet(_),void 0===i&&(i={}),i[_.getUID()]={pathElement:_,initCenterPosInWCS:_.getBoundingSphere(r._viewer).center,maxTranslationVect:null}),++g),e(c,_,g)}}}(e.getLastElement(),e,0),d.updateMapWithTranslationsVectors(i,this._viewer),i},_updateExplode:function(e,t){var i=this,r=-1,s=this._rootPathsStack[this._rootPathsStack.length-1].cursorPosition,n=Math.floor(e),o=e-n,a=Math.floor(s),h=s-a;this._removeTemporaryChanges();var l=this._rootPathsStack[this._rootPathsStack.length-1].relativeRootPath,d=l.getLastElement();this._levelExploderStruct&&this._levelExploderStruct[d.id]||this._updateLvlExplStruct(l);var c=function(e,t){var r,s;i._levelExploderStruct[d.id][e]||i._updateLvlExplStruct(l,e),r=e===a?h:t?0:1,e===n?(s=o,e!==a&&!0):s=t?1:0,i._updateStageExplode(e,r,s)};if(s<e)for(r=a;r<=n;++r)c(r,!0);else if(s>e)for(r=a;r>=n;--r)c(r,!1);this._rootPathsStack[this._rootPathsStack.length-1].cursorPosition=e,this._levelExploderManager&&this._levelExploderManager.recordState({rootPathsStack:this._rootPathsStack,cursorChangeOnly:!0}),t||this._updateGroundIfExistsAndRender()},_updateStageExplode:function(e,t,i){var r=this._rootPathsStack[this._rootPathsStack.length-1].relativeRootPath.getLastElement(),s=this._levelExploderStruct[r.id][e];for(var n in s)if(s.hasOwnProperty(n)){var o=s[n].pathElement,a=this._overrideSetStack[this._overrideSetStack.length-1],h=s[n].maxTranslationVect.clone().clone().multiplyScalar(i);this.restoreInitPositionWithOverrideSet(o,a),this.translateWithOverrideSet(o,h,a)}},_onChangeCursorPosCB:function(e){this._updateExplode(e.newCursorPos)},_removeTemporaryChanges:function(){this._manipulationOverrideSet&&(a.removeSceneGraphOverrideSet(this._experienceBase,this._manipulationOverrideSet,this._viewer)&&(this._manipulationOverrideSet=null))},_subscribeToSliderEvents:function(){if(null!==this._vcxPartSlider){var e=this;this._tokenCursorPosUpdate=this._vcxPartSlider.subscribe("onChangeCursorPos",function(t){e._onChangeCursorPosCB(t)})}},_unsubscribeToSliderEvents:function(){if(null===this._vcxPartSlider)return this._tokenCursorPosUpdate=null,void(this._tokenBackTrigger=null);null!==this._tokenCursorPosUpdate&&(this._vcxPartSlider.unsubscribe(this._tokenCursorPosUpdate),this._tokenCursorPosUpdate=null)},_onChangeLevelCB:function(e){for(var t=this,i=this._rootPathsStack[this._rootPathsStack.length-1].relativeRootPath.getLastElement(),r=this._rootPathsStack[this._rootPathsStack.length-1].cursorPosition,s=Math.floor(r),n=0;n<this._ignoredStagesIdxs.length&&s>=this._ignoredStagesIdxs[n];++n)++s;++s;var o=this._viewer.getRootNode(),h=e.getSubPath(function(e){if(0===e.id||1===e.id)return!1;for(var r=e,n=0;n<s;++n)if(r&&d.doesNodeHasProductTypeValue(r,t.PRODUCT_TYPES.INSTANCE)&&(d.doesNodeHasProductTypeValue(r.parents[0],t.PRODUCT_TYPES.INSTANCE)||r.parents[0].parents[0]===o)?r=r.parents[0]:r&&(d.doesNodeHasProductTypeValue(r,t.PRODUCT_TYPES.REFERENCE)||d.doesNodeHasProductTypeValue(r.parents[0],t.PRODUCT_TYPES.REFERENCE))&&r.parents[0]&&(r=r.parents[0].parents[0]),!r||0===r.id||1===r.id)return!1;return!!r&&r.id===i.id}),l=h&&this._getExplodeRootPath(h);if(l){var c=l.getLastElement(),u=d._getStagesInfo(c),_=u.nbOfStages;if(0!==_){this._ignoredStagesIdxs=u.discardedStagesIdxs;var g=a.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer);g.name="SGOverrideSet ExplodeLvl"+this._rootPathsStack.length,g.explodeRootPath=l,this._overrideSetStack.push(g),this._updateExplode(r);var v={relativeRootPath:l,cursorPosition:0};this._rootPathsStack.push(v),this._levelExploderManager&&this._levelExploderManager.recordState({rootPathsStack:this._rootPathsStack}),this._isolate(l,this._rootPathsStack[this._rootPathsStack.length-2].relativeRootPath),this._updateSlider(_,0),this._reframeWithPath(l)}else console.warn("No stages found. Diving cancelled.")}else console.warn("No new root found. Diving cancelled.")},_onBackTriggerCB:function(e){var t=this._overrideSetStack.pop();!a.removeSceneGraphOverrideSet(this._experienceBase,t,this._viewer)&&console.warn("Something has gone wrong with the removal of exec overrideSet");var i=this._rootPathsStack.pop().relativeRootPath.getLastElement();if(delete this._levelExploderStruct[i.id],this.isRunning()){var r=this._rootPathsStack[this._rootPathsStack.length-1].relativeRootPath,s=r.getLastElement(),n=this._rootPathsStack[this._rootPathsStack.length-1].cursorPosition,o=d._getStagesInfo(s),h=o.nbOfStages;this._ignoredStagesIdxs=o.discardedStagesIdxs,this._updateSlider(h,n,!1),e||this._reframeWithPath(r),this._levelExploderManager&&this._levelExploderManager.recordState({rootPathsStack:this._rootPathsStack})}},_onRestoreTriggerCB:function(){0!==this._rootPathsStack[this._rootPathsStack.length-1].cursorPosition&&this._vcxPartSlider.setCursorPosWithTransition(0)},_isolate:function(e,t){var i=t||this._rootPathsStack[0].relativeRootPath,r=this._overrideSetStack[this._overrideSetStack.length-1],s=a.getSceneGraphOverride(r,i);s&&s.setOpacity(.1,!0);var n=a.getSceneGraphOverride(r,e);n&&n.resetOpacity(),this._experienceBase.getManager("VCXContextManager").renderAll()},_unghostAll:function(){for(var e=this._overrideSetStack.length-1;e>0;--e){var t=this._overrideSetStack[e],i=this._rootPathsStack[e].relativeRootPath,r=this._rootPathsStack[e-1].relativeRootPath,s=a.getSceneGraphOverride(t,i);s&&s.resetOpacity();var n=a.getSceneGraphOverride(t,r);n&&n.resetOpacity()}this._experienceBase.getManager("VCXContextManager").renderAll()},_reframeWithPath:function(e,t){var i=t;(!i||"number"!=typeof i||i<0)&&(i=200),this._viewpoint=this.getFrameWindow().getViewpoint().reframe(null,i,e.getBoundingSphere(this._viewer))},_updateSlider:function(e,t){var i=t;"number"!=typeof i&&(i=0),this._vcxPartSlider&&(this._unsubscribeToSliderEvents(),this._vcxPartSlider.remove());var r=this._rootPathsStack.length>1,s={stagesNb:e};this._vcxPartSlider=new c(this._experienceBase,s),this._subscribeToSliderEvents(),r?this._vcxPartSlider.setBackButton(this._onBackTriggerCB.bind(this,!1)):this._vcxPartSlider.setRestoreButton(this._onRestoreTriggerCB.bind(this)),this._vcxPartSlider.setCursorPos(i)},_onPointerDownCB:function(e){if(this._vcxPartSlider&&e&&e.from[0]&&e.from[0].event&&e.from[0].event.target&&"CANVAS"===e.from[0].event.target.nodeName)if(this._tokens.pointerUpToken)this._disposeEvents(e);else{if(!this._tokens.pointerUpToken){this._tokens.pointerUpToken=v.addEvent(this._viewer.canvas,"onPrimaryPointerUpUnique",this._disposeEvents.bind(this))}var t,i=this._viewer.getMousePosition(e.from[0].getCurrentPosition(this._viewer.canvas)),r=this._viewer.pick(i,"mesh",!0);if(r&&r.path&&r.path.length>0&&(t=r.path[0].clone()),t){this._viewer.currentViewpoint.setControlActive({viewpoint:!1}),null===this._manipulationOverrideSet&&(this._manipulationOverrideSet=a.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer),this._manipulationOverrideSet.name="SGOverrideSet ExplodeManualManip"),this.viewerPrePicking=this._viewer.pPicking.activated,this._viewer.setPrePicking({activated:!1});var s=null,n=Math.floor(this._vcxPartSlider.getCursorPos()),o=this._rootPathsStack[this._rootPathsStack.length-1].relativeRootPath.getLastElement(),h=this._levelExploderStruct[o.id][n];for(var l in h)if(h.hasOwnProperty(l)&&h[l].pathElement.isAParentOf(t)){s=h[l].pathElement;break}s||(s=t);var d=r.position.clone(),c=(new _.Vector3).subVectors(this._viewer.currentViewpoint.target,this._viewer.currentViewpoint.position).normalize(),u=new _.Plane(c,0).setFromNormalAndCoplanarPoint(c,d);this._initInfos={data:e,pickInfo:r,pathElementToMove:s,plane3D:u,mousePos:i},this._isDragging=!1,this._lastPosition=d,this._tokens.pointerDragToken||(this._tokens.pointerDragToken=v.addEvent(this._viewer.canvas,"onPrimaryPointerMoveUnique",this._translate()))}}},_translate:function(){var e=this;return function(t){if(e._initInfos&&e._lastPosition){var i=e._viewer.getMousePosition(t.from[0].getCurrentPosition(e._viewer.canvas));if(!e._isDragging){var r=e._initInfos.mousePos;if(Math.max(Math.abs(i.xPix-r.xPix),Math.abs(i.yPix-r.yPix))<3)return;e._isDragging=!0}var s=e._viewer.pick(i,"mesh",!1).ray.intersectPlane(e._initInfos.plane3D),n=e._initInfos.pathElementToMove,o=(new _.Vector3).subVectors(s,e._lastPosition);e.translateWithOverrideSet(n,o,e._manipulationOverrideSet),e._lastPosition=s.clone()}}},_disposeEvents:function(e){this._tokens.pointerDragToken&&v.removeEventFromToken(this._tokens.pointerDragToken),this._tokens.pointerDragToken=null,this._tokens.pointerUpToken&&v.removeEventFromToken(this._tokens.pointerUpToken),this._tokens.pointerUpToken=null,this._viewer.currentViewpoint.setControlActive({viewpoint:!0}),this.viewerPrePicking&&this._viewer.setPrePicking({activated:this.viewerPrePicking}),delete this.viewerPrePicking,this._initInfos=null,this._translateCB=null,this._disposeCB=null,this._isDragging=!1},saveInitPositionWithOverrideSet:function(e){var t=e.getMatrix(this.viewer);this._pathesInitFrames[e.getUID()]=t},restoreInitPositionWithOverrideSet:function(e,t){var i=this._pathesInitFrames[e.getUID()];a.getSceneGraphOverride(t,e).setPosition(i)},translateWithOverrideSet:function(e,t,i){var r=e,s=r.getParentPath().getWorldMatrix(this._viewer),n=(new _.Matrix4).getInverse(s),o=(new _.Matrix4).extractRotation(n),h=(new _.Vector3).copy(t).applyMatrix4(o),l=r.getMatrix(this._viewer);if(l){var d=(new _.Vector3).getPositionFromMatrix(l).add(h);l.setPosition(d);var c=a.getSceneGraphOverride(i,r);c&&(c.setPosition(l),this._levelExploderManager&&"SGOverrideSet ExplodeManualManip"===i.name&&this._levelExploderManager._publishVolatileManipEvent(r,d),this._updateGroundIfExistsAndRender())}},_updateGroundIfExistsAndRender:function(){this._experienceBase.getManager("VCXContextManager").renderAll({updateInfinitePlane:!0})}})});