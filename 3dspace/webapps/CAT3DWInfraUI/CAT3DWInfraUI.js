define("DS/CAT3DWInfraUI/CAT3DWHandleManipulator",["UWA/Core","DS/CAT3DWVisu/CAT3DWDataFactory","DS/CAT3DWVisu/CAT3DWVisuServices","DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/Manipulators/PointHandle","DS/Visualization/SceneGraphFactory","DS/CoreEvents/Events"],function(t,e,i,n,o,a,s,r){"use strict";var c=a.extend({init:function(t){if(!t.media&&!t.multiSelObject)throw Error('"DS/CAT3DWInfraUI/CAT3DWHandleManipulator" constructor missing config parameter "media" or "objects"');if(!t.planeChoiceNode)throw Error('"DS/CAT3DWInfraUI/CAT3DWHandleManipulator" constructor missing config parameter "planeChoiceNode"');this._parent(t),this.name=t.name||"",this._viewer=t.viewer,this._renderPass=t.renderPass,this._pickingAreaRootNode=t.pickingAreaRootNode,this._planeChoiceNode=t.planeChoiceNode,this._refPlane=new n.Plane,this._setReferencePlane(),this._mediaController=t.mediaController,t.media?this.objects=[t.media]:t.multiSelObject&&this.setNewMultiSelObject(t.multiSelObject),this.objects.length>1?(this._displaySelectionBox=!0,this._drawMultiSelectionBox()):this._displaySelectionBox=!1,this.setMatrix((new n.Matrix4).setPosition(this._getPosition())),this._isRotationActivated=!0,this._isScaleActivated=!0,this._isSnappingForImageActivated=!0,this._maxSuccessfulScaleRatio=1,this._authorizeTextScaling=!0,this._onBeginPreactivateCB=this._onBeginPreactivate.bind(this),this.subscribe("BeginPreactivate",this._onBeginPreactivateCB),this._onEndPreactivateCB=this._onEndPreactivate.bind(this),this.subscribe("EndPreactivate",this._onEndPreactivateCB),this._onBeginManipulateCB=this._onBeginManipulate.bind(this),this.subscribe("BeginManipulate",this._onBeginManipulateCB),this._onManipulateCB=this._onManipulate.bind(this),this.subscribe("Manipulate",this._onManipulateCB),this._onEndManipulateCB=this._onEndManipulate.bind(this),this.subscribe("EndManipulate",this._onEndManipulateCB),this._onViewpointToken=r.subscribe({event:"/VISU/"},function(t){"@onViewpointChange"===t.eventType?this.update():"@onViewpointEndMove"===t.eventType&&this.update()}.bind(this))},dispose:function(){if(this._multiSelectionObject&&(this._multiSelectionObject=null),this._selectionBoxNode&&(this.sceneGraph.removeChild(this._selectionBoxNode),this._selectionBoxNode=null),this._pickableRectangleNode&&(this._pickingAreaRootNode.removeChild(this._pickableRectangleNode),this._pickableRectangleNode=null),this._manipulator&&(this.sceneGraph.add(this),this._manipulator=null),this.unsubscribe("BeginPreactivate",this._onBeginPreactivateCB),this.unsubscribe("EndPreactivate",this._onEndPreactivateCB),this.unsubscribe("BeginManipulate",this._onBeginManipulateCB),this.unsubscribe("Manipulate",this._onManipulateCB),this.unsubscribe("EndManipulate",this._onEndManipulateCB),this._viewer.currentViewpoint.setControlActive(!0),this._objectsPickability){for(var t=0;t<this.objects.length;t++)this._objectsPickability[t]&&this.objects[t].setPickable(o.PICKABLE);this._objectsPickability=null}this.objects=null,this._viewer=null,this._onViewpointToken&&r.unsubscribe(this._onViewpointToken),this._onViewpointToken=null,this._parent()},setNewMultiSelObject:function(t){this._multiSelectionObject=t,this._multiSelectionObject.handle=this,this.objects=this._multiSelectionObject.getObjects(),this._createPickableRectangle(),this.update()},hideManipulator:function(){this.setVisibility(!1)},showManipulator:function(){this._multiSelectionObject&&this._multiSelectionObject.isLocked()||this.setVisibility(!0)},isActivated:function(){return this._activated||this._manipulating},setReferencePlane:function(t){this._refPlane=t},setRotationActivation:function(t){this._isRotationActivated=t},isRotationActivated:function(){return this._isRotationActivated},setScaleActivation:function(t){this._isScaleActivated=t},isScaleActivated:function(){return this._isScaleActivated},setSnappingForImageActivation:function(t){this._isSnappingForImageActivated=t},isSnappingForImageActivated:function(){return this._isSnappingForImageActivated},update:function(){this.isPaused()||(this._displaySelectionBox&&this._drawMultiSelectionBox(),this._multiSelectionObject?this._multiSelectionObject.isLocked()?this.hideManipulator():this.showManipulator():this.objects&&1===this.objects.length&&(this.objects[0].isLocked()?this.hideManipulator():this.showManipulator()),this.setMatrix((new n.Matrix4).setPosition(this._getPosition())),this._viewer.render())},pause:function(){this._manipulator||(this._manipulator=this,this.sceneGraph.remove(this)),this._selectionBoxNode&&this._selectionBoxNode.setVisibility(!1),this._pickableRectangleNode&&this._pickableRectangleNode.setVisibility(!1),this._viewer.render()},isPaused:function(){return!!this._manipulator},resume:function(){this._manipulator&&(this._manipulator=null,this.sceneGraph.add(this),this.update()),this._selectionBoxNode&&this._selectionBoxNode.setVisibility(!0),this._pickableRectangleNode&&this._pickableRectangleNode.setVisibility(!0),this._viewer.render()},move:function(t){var e=this.getMatrix(),i=(new n.Vector3).getPositionFromMatrix(e);i.add(t),e.setPosition(i),this.setMatrix(e)},getScreenPosition:function(){return i.compute2DPointFrom3DPoint(this._getPosition(),this._viewer)},_onBeginPreactivate:function(){if(!this._manipulating){this._objectsPickability=[];for(var t=0;t<this.objects.length;t++)this._objectsPickability[t]=this.objects[t].getPickable(),this.objects[t].setPickable(o.NOPICKABLE)}this.update(),this._activated=!0},_onEndPreactivate:function(){if(!this._manipulating&&this._objectsPickability){for(var t=0;t<this.objects.length;t++)this._objectsPickability[t]&&this.objects[t].setPickable(o.PICKABLE);this._objectsPickability=null}this._activated=!1},_onBeginManipulate:function(){var t=this._getPosition(),e=i.compute2DPointFrom3DPoint(t,this._viewer);if(this._planeChoiceNode)this._refPlane.setFromNormalAndCoplanarPoint(this._planeChoiceNode.getNormal().negate(),this._planeChoiceNode.getCenter()),this._refPlaneU=this._planeChoiceNode.getUDirection();else{this._refPlane||(this._refPlane=(new n.Plane).setFromNormalAndCoplanarPoint((new n.Vector3).subVectors(this._viewer.currentViewpoint.target,this._viewer.currentViewpoint.camera.position).normalize(),new n.Vector3(0,0,0)));var o=this._viewer.currentViewpoint.getUpDirection(),a=this._refPlane.normal;this._viewer.currentViewpoint.getSightDirection().dot(a)>0&&a.negate(),this._refPlaneU=(new n.Vector3).crossVectors(o,a),this._refPlaneU.normalize()}var s=null;if(1===this.objects.length){this._originalMatrix=this.objects[0].getMatrix();var r=(new n.Vector3).getPositionFromMatrix(this._originalMatrix);this._originalTranslationMatrix=(new n.Matrix4).makeTranslation(r.x,r.y,r.z),this._originalRotation=(new n.Matrix4).extractRotation(this._originalMatrix),this._originalMatrix.setPosition(new n.Vector3(0,0,0)),s=this.objects[0].getCenter()}else this._originalMatrix=this._multiSelectionObject.getMatrix(),this._originalRotation=(new n.Matrix4).extractRotation(this._originalMatrix),s=this._multiSelectionObject.getCenter();this._refOrigin2D=i.compute2DPointFrom3DPoint(s,this._viewer),this._scaleDistance=this._refOrigin2D.distanceTo(e),this._centerOnRefPlane=this._refPlane.projectPoint(s),this._rotationVector=(new n.Vector3).subVectors(this._refPlane.projectPoint(t),this._centerOnRefPlane).normalize(),this._angleConeHeigth=180*new n.Vector3(1,0,0).angleTo(new n.Vector3(e.x,e.y,0).sub(new n.Vector3(this._refOrigin2D.x,this._refOrigin2D.y,0)))/Math.PI,this._rotationActivated=!1;var c=new n.Vector3,l=new n.Vector3,h=new n.Vector3;this._originalRotation.extractBasis(c,l,h);var d=c.dot(this._refPlaneU),u=new n.Vector3;Math.abs(d)>.5?(u.copy(c),this._originalRight=new n.Vector3(1,0,0)):(d=l.dot(this._refPlaneU),Math.abs(d)>.5?(u.copy(l),this._originalRight=new n.Vector3(0,1,0)):(u.copy(h),this._originalRight=new n.Vector3(0,0,1))),d<0&&(u.negate(),this._originalRight.negate());var p=(new n.Vector3).crossVectors(this._refPlane.normal,u),g=this._refPlaneU.dot(p)>0?1:-1;this._snapMatrix=(new n.Matrix4).makeRotationAxis(this._refPlane.normal,g*u.angleTo(this._refPlaneU)),this._manipulating=!0},_onManipulate:function(t){var e=t.event.from[0].getCurrentPosition(),o=i.compute3DPointFrom2DPoint(e,this._refPlane,this._viewer);if(this.isRotationActivated()&&!this._rotationActivated){var a=180*new n.Vector3(1,0,0).angleTo(new n.Vector3(e.x,e.y,0).sub(new n.Vector3(this._refOrigin2D.x,this._refOrigin2D.y,0)))/Math.PI;this._rotationActivated=Math.abs(this._angleConeHeigth-a)>5}var s=new n.Matrix4;if(this._rotationActivated){var r=(new n.Vector3).subVectors(o,this._centerOnRefPlane).normalize(),c=(new n.Vector3).crossVectors(this._rotationVector,r),l=this._rotationVector.dot(r),h=1/(1+l);if(s.set(c.x*c.x*h+l,c.y*c.x*h-c.z,c.z*c.x*h+c.y,0,c.x*c.y*h+c.z,c.y*c.y*h+l,c.z*c.y*h-c.x,0,c.x*c.z*h-c.y,c.y*c.z*h+c.x,c.z*c.z*h+l,0,0,0,0,1),this.isSnappingForImageActivated()&&(this.objects.length>1||!this.objects[0].parents||"images"===this.objects[0].parents[0].name||"texts"===this.objects[0].parents[0].name)){var d=s.clone().multiply(this._originalRotation),u=this._originalRight.clone().applyMatrix4(d),p=180*u.angleTo(this._refPlaneU)/Math.PI;if(p<=5||p>=85&&p<=95||p>=175&&p<=185){var g=(new n.Vector3).crossVectors(this._refPlane.normal,u),_=this._refPlaneU.dot(g)>0?-1:1;p=p>=85&&p<=95?90*_:p<=5?0:180,d.makeRotationAxis(this._refPlane.normal,p*Math.PI/180),d.multiply(this._snapMatrix),s.copy(d)}}}var m=1;if(this.isScaleActivated()){m=this._refOrigin2D.distanceTo(t.event.from[0].getCurrentPosition())/this._scaleDistance,f=this._authorizeTextScaling?(new n.Matrix4).makeScale(m,m,m):(new n.Matrix4).makeScale(this._maxSuccessfulScaleRatio,this._maxSuccessfulScaleRatio,this._maxSuccessfulScaleRatio)}else f=new n.Matrix4;var f=(new n.Matrix4).makeScale(m,m,m);s.multiply(f);var D=new n.Matrix4;1===this.objects.length?(D.copy(this._originalTranslationMatrix),D.multiply(s),D.multiply(this._originalMatrix),this.objects[0].setMatrix(D),this.objects[0].parents&&"bbox"===this.objects[0].parents[0].name&&this.objects[0].updateShadowNode(this._refPlane)):(D.copy(this._originalMatrix),D.multiply(s),this._multiSelectionObject.setMatrix(D)),this.update(),this._viewer.render()},_onEndManipulate:function(){var t=0;if(!this._activated&&(this._viewer.currentViewpoint.setControlActive(!0),this._objectsPickability)){for(t=0;t<this.objects.length;t++)this._objectsPickability[t]&&this.objects[t].setPickable(o.PICKABLE);this._objectsPickability=null}for(this._mediaController.redrawSelectedTextCanvas(),this._manipulating=!1,t=0;t<this.objects.length;t++)this.objects[t].parents?"images"===this.objects[t].parents[0].name?r.publish({event:"CAT3DSKEndManipulationMediaEvent",data:{mediaID:this.objects[t].getMediaObj().getID(),matrix:JSON.stringify(this.objects[t].getMatrix()),type:"image"}}):"bbox"===this.objects[t].parents[0].name&&"model3DNode"===this.objects[t].parents[0].parents[0].name?r.publish({event:"CAT3DSKEndManipulationMediaEvent",data:{mediaID:this.objects[t].getMediaObj().getID(),matrix:JSON.stringify(this.objects[t].getMatrix()),type:"model3D"}}):"texts"===this.objects[t].parents[0].name&&r.publish({event:"CAT3DSKEndManipulationMediaEvent",data:{mediaID:this.objects[t].getMediaObj().getID(),matrix:JSON.stringify(this.objects[t].getMatrix()),type:"text"}}):r.publish({event:"CAT3DSKEndManipulationMediaEvent",data:{mediaID:this.objects[t].id,matrix:JSON.stringify(this.objects[t].getMatrix()),type:"annotation"}})},_getReferenceCorner:function(){return this._multiSelectionObject?this._multiSelectionObject.getCorners().bottomRight:"CAT3DWModel"===this.objects[0].getType()?this.objects[0].getBboxViewCorner():this.objects[0].getCorners().bottomRight},_getPosition:function(){return this._getReferenceCorner()},_setReferencePlane:function(){this._planeChoiceNode&&(this._refPlane.setFromNormalAndCoplanarPoint(this._planeChoiceNode.getNormal().negate(),this._planeChoiceNode.getCenter()),this._refPlaneU=this._planeChoiceNode.getUDirection())},_drawMultiSelectionBox:function(){var t,e,i=this._multiSelectionObject.getCorners();if(this._selectionBoxNode){if(this._positionArray){var a=0;this._positionArray[a++]=i.topLeft.x,this._positionArray[a++]=i.topLeft.y,this._positionArray[a++]=i.topLeft.z,this._positionArray[a++]=i.topRight.x,this._positionArray[a++]=i.topRight.y,this._positionArray[a++]=i.topRight.z,this._positionArray[a++]=i.bottomRight.x,this._positionArray[a++]=i.bottomRight.y,this._positionArray[a++]=i.bottomRight.z,this._positionArray[a++]=i.bottomLeft.x,this._positionArray[a++]=i.bottomLeft.y,this._positionArray[a++]=i.bottomLeft.z,this._positionArray[a++]=i.topLeft.x,this._positionArray[a++]=i.topLeft.y,this._positionArray[a++]=i.topLeft.z}this._selectionBoxNode.updateBuffer(o.VertexComponentEnum.POSITION,0,5),this._selectionBoxNode.computeBoundingElements();var r=this._multiSelectionObject.getMatrix();this._pickableRectangleNode.setMatrix(r)}else{var c=new n.LineBasicMaterial({color:new n.Color("#42A2DA"),force:!0,transparent:!0,opacity:1,lineWidth:2});e=.15,(t=c).depthTest=!0,t.depthWrite=!1,t.polite=!0,t.politeMaterial=t.clone(),t.politeMaterial.opacity=e||.3,t.politeMaterial.depthTest=!1,t.politeMaterial.depthWrite=!1,t.politeMaterial instanceof n.ShaderMaterial&&(t.politeMaterial.transparent=!0,t.politeMaterial.uniforms.opacity.value=.3),this._selectionBoxNode=s.createLineNode({points:[i.topLeft,i.topRight,i.bottomRight,i.bottomLeft,i.topLeft],material:c,drawMode:o.ConnectivityTypeEnum.LINES,editable:!0}),this._selectionBoxNode.name="handleManipulatorSelectFeedback",this._selectionBoxNode.setShadow(!1,!1),this._selectionBoxNode.setVisibility(!0),this._selectionBoxNode.setPickable(o.NOPICKABLE),this.sceneGraph.add(this._selectionBoxNode),this._positionArray=this._selectionBoxNode.getBuffer(o.VertexComponentEnum.POSITION),this._createPickableRectangle()}},_createPickableRectangle:function(){if(this._pickingAreaRootNode){this._pickableRectangleNode&&(this._pickingAreaRootNode.removeChild(this._pickableRectangleNode),this._pickableRectangleNode=null);var t=this._multiSelectionObject.getMatrix(),i=(new n.Matrix4).getInverse(t),o=this._multiSelectionObject.getCorners(),a={topLeft:o.topLeft.clone().applyMatrix4(i),topRight:o.topRight.clone().applyMatrix4(i),bottomLeft:o.bottomLeft.clone().applyMatrix4(i)},r=a.topLeft.distanceTo(a.topRight),c=a.topLeft.distanceTo(a.bottomLeft);this._pickableRectangleNode=s.createRectangleNode({width:r,height:c,cornerPoint:new n.Vector2(-r/2,-c/2),color:"black",fill:!0,material:new n.MeshBasicMaterial({color:new n.Color(255),transparent:!0,opacity:0,force:!0}),noEdge:!0}),this._pickableRectangleNode.name="handleManipulatorPickingNode",this._pickableRectangleNode.setMatrix(t),this._pickableRectangleNode.isGroupManipulator=!0,this._pickableRectangleNode.multiSelObject=this._multiSelectionObject,this._renderPass&&this._pickableRectangleNode.setRenderPasses([this._renderPass]),this._pickableRectangleNode.setPickingPriorityId(e.getLabelOf(e.SupportTypes.PICKING_AREA)),this._pickingAreaRootNode.add(this._pickableRectangleNode)}}});return t.namespace("DS/CAT3DWInfraUI/CAT3DWHandleManipulator",c)}),define("DS/CAT3DWInfraUI/CAT3DWRenameReplaceDialog",["UWA/Core","UWA/Class","DS/Windows/Dialog","DS/Controls/Button","DS/Controls/Toggle","DS/Controls/LineEditor","DS/ApplicationFrame/FrameWindowsManager","i18n!DS/CAT3DWInfraUI/assets/nls/CAT3DWRenameReplaceDialog"],function(t,e,i,n,o,a,s,r){"use strict";function c(t,e,i){return(t.replace(/\.[^.]*$/,"")||e)+"."+i}return{generateRenameReplaceDialog:function(e,l,h,d,u){var p="replace",g=new o({type:"radio",label:r.get("ReplaceOption"),checkFlag:!0}),_=new o({type:"radio",label:r.get("RenameOption")}),m=new a({sizeInCharNumber:40,value:d+"."+u,disabled:!0}),f=new t.createElement("div",{styles:{"margin-left":"22px","margin-top":"5px"},html:'<p style="margin-bottom:4px;">'+r.get("RenameDescription")+"</p>"});m.inject(f);var D=new t.createElement("div",{styles:{"margin-left":"10px","margin-top":"7px","margin-bottom":"15px"}});t.createElement("div",{styles:{"margin-bottom":"7px"}}).inject(D).textContent=h+"."+u,g.inject(D),_.inject(D),f.inject(D);var b=new t.createElement("div",{styles:{width:350,"margin-top":"10px","margin-left":"7px"},html:"<p>"+r.get("ReplaceDialogMessage")+"</p>"});D.inject(b);var v=s.getFrameWindow(),I=new i({immersiveFrame:v.getImmersiveFrame(),title:r.get("ReplaceDialogTitle"),closeButtonFlag:!1,content:b,buttons:{Ok:new n({label:r.get("ReplaceDialogAccept"),onClick:function(t){m.value=c(m.value,d,u);var i={type:p,newFilename:m.value};e(i)}}),Cancel:new n({onClick:function(t){l()}})}});return _.addEventListener("change",function(t){m.disabled=!_.checkFlag,p=_.checkFlag?"rename":"replace"}),m.addEventListener("blur",function(t){m.value=c(m.value,d,u)}),I}}}),define("DS/CAT3DWInfraUI/CAT3DWAssistantTool",["DS/Manipulators/Manipulator","DS/Web3DUXAssistantTools/Web3DUXAssistantTools","UWA/Core"],function(t,e,i){"use strict";var n=e.extend({init:function(t,e,i,n){i||(i=e.getUIFrame());var o={body:i,viewer:t,frmWindow:e,heightElem:"28",widthElem:"28",offset:(n=n||{}).offset?n.offset:{x:-9,y:10},title:"Assistant tools Control",mode:n.mode?n.mode:"horizontal",dir:"left",lJsonElement:[]};this._parent(o),this.setVisibleFlag(!1)}});return i.namespace("DS/CAT3DWInfraUI/CAT3DWAssistantTool",n)}),define("DS/CAT3DWInfraUI/CAT3DWCopyLinkDialog",["UWA/Core","DS/Windows/Dialog","DS/ApplicationFrame/FrameWindowsManager","i18n!DS/CAT3DWInfraUI/assets/nls/CAT3DWCopyLinkDialog","css!DS/CAT3DWInfraUI/CAT3DWInfraUI"],function(t,e,i,n){"use strict";return{generateCopyLinkDialog:function(o,a){var s=a?n.get("RootFolderErrorMsg"):n.get("MainMsg"),r=new t.createElement("div",{class:"copylinkdialog-maindiv",html:"<p>"+s+"</p>"}),c=new t.createElement("div",{class:"copylinkdialog-copylinkdiv"});c.inject(r);var l=new t.createElement("input",{class:"copylinkdialog-sharebylinkinput"});l.value=o,l.disabled=!0,l.inject(c);var h=new t.createElement("button",{class:"copylinkdialog-copylinkbtn"});h.onclick=function(e){!function(e){var i=document.createElement("textarea");if(i.value=e,document.body.appendChild(i),t.Utils.Client.Platform.ios||t.Utils.Client.Platform.ipad){i.contentEditable=!0,i.readOnly=!0;var n=document.createRange();n.selectNodeContents(i);var o=window.getSelection();o.removeAllRanges(),o.addRange(n),i.setSelectionRange(0,i.value.length)}else i.select();document.execCommand("copy"),document.body.removeChild(i)}(o)},h.inject(c),new t.createElement("i",{class:"fonticon fonticon-link"}).inject(h),new t.createElement("span",{html:"  "+n.get("CopyLinkBtn")}).inject(h);var d=new t.createElement("div",{class:"copylinkdialog-openlinkdiv",html:"<p>"+n.get("OpenLinkMsg")+"</p>"});d.inject(r);var u=new t.createElement("button",{class:"copylinkdialog-openlinkbutton"});u.onclick=function(t){u.blur(),window.open(o,"_blank")},u.inject(d),new t.createElement("i",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-open-in-a-new-window"}).inject(u),new t.createElement("span",{html:"  "+n.get("OpenLinkBtn")}).inject(u);var p=i.getFrameWindow();return new e({immersiveFrame:p.getImmersiveFrame(),title:n.get("CopyLinkDialogTitle"),modalFlag:!0,content:r})}}}),define("DS/CAT3DWInfraUI/CAT3DSKHistoryManager",["UWA/Class","DS/ApplicationFrame/CommandsManager","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CoreEvents/Events"],function(t,e,i,n){"use strict";var o=t.extend({init:function(t){this._annotationManager=t.annotationManager,this._mediaController=t.mediaController,this._objectsStateID={},this._actionsHistory=[],this._undoableActions=[],this._redoableActions=[],this._isCurrentActionUndoable=!0,this._objectActionList=[],this._idList=[],this._objectList=[],this._actionList=[],this._isWhiteboard="whiteboard"===i.getPreferenceValue("appMode"),this._selectionCmd=e.getCommand("SelectionCmd"),this._groupsMoved=[],this._debugTraces=!1},registerAction:function(t,e,i,n){this._isCurrentActionUndoable=!0,this._objectActionList=[],this._idList=[],this._objectList=[],this._actionList=[],this._groupsMoved=[];for(let n=0;n<t.length;n++)this._addObjectAndUpdateStateID(t[n],e,i);n&&(this._isCurrentActionUndoable=!1),i===o.DATA_TYPE.MEDIA&&e===o.ACTION.CREATED?(this._actionList=new Array(t.length),this._actionList.fill(e),this._registerLayersChange(),this._registerNewAction(o.UPDATE_TYPE.NEW_COMPLEX_ACTION)):this._registerNewAction(o.UPDATE_TYPE.NEW_ACTION,e)},registerComplexAction:function(t,e,i,n){this._isCurrentActionUndoable=!0,this._objectActionList=[],this._idList=[],this._objectList=[],this._actionList=[],this._groupsMoved=[];for(var a=0;a<t.length;a++)this._addObjectAndUpdateStateID(t[a],e[a],i[a]);this._actionList=e,n&&(this._isCurrentActionUndoable=!1),this._registerNewAction(o.UPDATE_TYPE.NEW_COMPLEX_ACTION)},registerLayersChange:function(){this._isCurrentActionUndoable=!1,this._objectActionList=[],this._idList=[],this._objectList=[],this._actionList=[],this._groupsMoved=[],this._registerLayersChange()&&this._registerNewAction(o.UPDATE_TYPE.NEW_COMPLEX_ACTION)},_registerLayersChange:function(){let t=this._mediaController.getDepthOrder();if(!t.length)return!1;var e,i=void 0,n=null,a=t,s=this._objectsStateID.LAYERS;return s?(i=s.updateID,s.updateID++,n=o.ACTION.EDITED):((s={object:this._mediaController,objectType:o.DATA_TYPE.LAYERS,updateID:0,actions:{}}).actions[o.ACTION.EDITED]=[{actionsIndex:this._actionsHistory.length,objectsIndex:this._objectActionList.length}],this._objectsStateID.LAYERS=s,n=o.ACTION.CREATED),e=s.updateID,this._objectActionList.push({id:"LAYERS",type:o.DATA_TYPE.LAYERS,precedentUpdateID:i,newUpdateID:e,action:n,actionData:a}),this._idList.push("LAYERS"),this._objectList.push(this._mediaController),!0},registerThirdPartyAction:function(t,e,i){this._isCurrentActionUndoable=!1,this._objectActionList=[],this._idList=[],this._objectList=[],this._actionList=[],this._groupsMoved=[];for(var n=0;n<t.length;n++)this._addObjectAndUpdateStateID(t[n],e[n],i[n]);this._actionList=e,this._registerNewThirdPartyAction(o.UPDATE_TYPE.NEW_COMPLEX_ACTION)},addActionToStack:function(t,e,i){this._actionList.push(e),this._addObjectAndUpdateStateID(t,e,i)},logStackInHistory:function(){this._registerNewAction(o.UPDATE_TYPE.NEW_COMPLEX_ACTION)},_addObjectAndUpdateStateID:function(t,e,i){var n=void 0,a=void 0;if((e===o.ACTION.MOVED||e===o.ACTION.EDITED)&&t.selectionGroupID){if(this._groupsMoved.indexOf(t.selectionGroupID)>-1)return;this._groupsMoved.push(t.selectionGroupID),t=t.multiSelObject,i=o.DATA_TYPE.GROUP}var s=null,r=t.getID(),c=this._objectsStateID[r];if(c?(n=c.updateID,c.updateID++):((c={object:t,objectType:i,updateID:0,actions:{}}).actions[o.ACTION.MOVED]=[],c.actions[o.ACTION.EDITED]=[],this._objectsStateID[r]=c,e!==o.ACTION.CREATED&&(this._objectsStateID[r].actions[o.ACTION.MOVED].push({actionsIndex:this._actionsHistory.length,objectsIndex:this._objectActionList.length}),this._objectsStateID[r].actions[o.ACTION.EDITED].push({actionsIndex:this._actionsHistory.length,objectsIndex:this._objectActionList.length}),e!==o.ACTION.DISCARDED&&(s=t.getCreationData()))),a=c.updateID,e===o.ACTION.MOVED?(s=t.getMoveData(),this._objectsStateID[r].actions[e].push({actionsIndex:this._actionsHistory.length,objectsIndex:this._objectActionList.length})):e===o.ACTION.EDITED?(s=t.getEditData(),this._objectsStateID[r].actions[e].push({actionsIndex:this._actionsHistory.length,objectsIndex:this._objectActionList.length})):e===o.ACTION.DISCARDED?i===o.DATA_TYPE.MEDIA?(this._undoableActions=[],c.object=null,c.actions[o.ACTION.MOVED]=null,c.actions[o.ACTION.EDITED]=null,delete this._objectsStateID[r],this._isCurrentActionUndoable=!1,a=void 0):i===o.DATA_TYPE.GROUP&&(c.object=null):e===o.ACTION.CREATED&&(s=t.getCreationData(),this._objectsStateID[r].actions[o.ACTION.MOVED].push({actionsIndex:this._actionsHistory.length,objectsIndex:this._objectActionList.length}),this._objectsStateID[r].actions[o.ACTION.EDITED].push({actionsIndex:this._actionsHistory.length,objectsIndex:this._objectActionList.length}),i===o.DATA_TYPE.MEDIA&&(this._isCurrentActionUndoable=!1)),this._objectActionList.push({id:r,type:i,precedentUpdateID:n,newUpdateID:a,action:e,actionData:s}),this._idList.push(r),this._objectList.push(t),this._debugTraces){var l="";e===o.ACTION.CREATED&&(l="CREATED"),e===o.ACTION.MOVED&&(l="MOVED"),e===o.ACTION.DISCARDED&&(l="ERASED");var h="";i===o.DATA_TYPE.SKETCH?h="sketch":i===o.DATA_TYPE.MEDIA?h="media":i===o.DATA_TYPE.GROUP&&(h="group"),console.log(h+" "+l+" "+r+" "+a)}},_registerNewAction:function(t,e){var i={timestamp:Date.now(),objectActionList:this._objectActionList};this._actionsHistory.push(i),this._isCurrentActionUndoable&&this._undoableActions.push(i),this._redoableActions.length&&(this._redoableActions=[]);var o={objects:this._objectList,updateType:t,isEmpty:this._isUndoEmpty(),isRedoEmpty:this._isRedoEmpty(),action:i};void 0!==e?o.state=e:o.states=this._actionList,n.publish({event:"CAT3DSKUpdateAnnotationHistoryEvent",data:o}),this._isCurrentActionUndoable=!0,this._objectActionList=[],this._idList=[],this._objectList=[],this._actionList=[],this._groupsMoved=[]},_registerNewThirdPartyAction:function(){var t={timestamp:Date.now(),objectActionList:this._objectActionList};this._actionsHistory.push(t),this._isCurrentActionUndoable=!0,this._objectActionList=[],this._idList=[],this._objectList=[],this._actionList=[],this._groupsMoved=[],n.publish({event:"CAT3DSKUpdateAnnotationHistoryEvent",data:{objects:this._objectList,updateType:o.UPDATE_TYPE.NEW_ACTION,isEmpty:this._isUndoEmpty(),isRedoEmpty:this._isRedoEmpty(),action:t}})},dumpHistoryStackToJson:function(){return JSON.stringify(this._actionsHistory)},restoreHistoryStackFromJson:function(t){this._actionsHistory=JSON.parse(t)},_isUndoEmpty:function(){return 0===this._undoableActions.length},_isRedoEmpty:function(){return 0===this._redoableActions.length},undo:function(){var t=this._undoableActions.pop();if(t){var e,i,a,s=[],r=null,c=null,l=null,h=null;this._selectionCmd._removeAllSelections();for(var d=t.objectActionList.length-1;d>-1;d--)if(c=null,l=null,(r=t.objectActionList[d]).action===o.ACTION.CREATED?(r.type===o.DATA_TYPE.SKETCH?(this._objectsStateID[r.id].updateID=r.precedentUpdateID,this._annotationManager.changeAnnotationIsOnSceneGraphWithId(r.id,!1,!1,!0)):r.type===o.DATA_TYPE.GROUP&&(this._objectsStateID[r.id].updateID=r.precedentUpdateID,this._selectionCmd.selectObjects(r.actionData.objects),this._selectionCmd.ungroup(r.actionData.objects[0].selectionGroupID.toString(),!0),this._objectsStateID[r.id].object=null),c=o.ACTION.DISCARDED):r.action===o.ACTION.DISCARDED?(r.type===o.DATA_TYPE.SKETCH?(this._objectsStateID[r.id].updateID=r.precedentUpdateID,this._annotationManager.changeAnnotationIsOnSceneGraphWithId(r.id,!0,!1,!0),this._isWhiteboard&&this._selectionCmd.selectObject(this._objectsStateID[r.id].object)):r.type===o.DATA_TYPE.GROUP&&(this._objectsStateID[r.id].updateID=r.precedentUpdateID,i=(e=this._objectsStateID[r.id].actions[o.ACTION.EDITED])[e.length-1],h=this._actionsHistory[i.actionsIndex].objectActionList[i.objectsIndex],this._objectsStateID[h.id].object=this._selectionCmd.groupObjects(h.actionData.objects,h.id,!0),this._selectionCmd.selectObject(this._objectsStateID[h.id].object)),c=o.ACTION.CREATED):r.action===o.ACTION.MOVED&&(this._objectsStateID[r.id].updateID=r.precedentUpdateID,(e=this._objectsStateID[r.id].actions[r.action]).pop(),i=e[e.length-1],(h=this._actionsHistory[i.actionsIndex].objectActionList[i.objectsIndex])&&this._objectsStateID[r.id].object.setMoveData(h.actionData),c=o.ACTION.MOVED,l=r.actionData,(a=this._objectsStateID[r.id].object).getView&&(a=a.getView(),this._selectionCmd._updateShadowNode(a)),this._isWhiteboard&&this._selectionCmd.selectObject(this._objectsStateID[r.id].object)),null!==c&&s.push({id:r.id,type:r.type,precedentUpdateID:r.newUpdateID,newUpdateID:r.precedentUpdateID,action:c,actionData:l}),this._debugTraces){var u="";t===o.ACTION.CREATED&&(u="CREATED"),t===o.ACTION.MOVED&&(u="MOVED"),t===o.ACTION.DISCARDED&&(u="ERASED");var p="";r.type===o.DATA_TYPE.SKETCH?p="sketch":r.type===o.DATA_TYPE.MEDIA&&(p="media"),console.log("UNDO "+p+" "+u+" "+r.id+" "+r.newUpdateID+" -> "+r.precedentUpdateID)}s.length&&this._actionsHistory.push({timestamp:Date.now(),objectActionList:s}),this._redoableActions.push(t),n.publish({event:"CAT3DSKUpdateAnnotationHistoryEvent",data:{isEmpty:this._isUndoEmpty(),isRedoEmpty:this._isRedoEmpty(),updateType:o.UPDATE_TYPE.UNDO,action:{timestamp:Date.now(),objectActionList:s}}})}},redo:function(){var t=this._redoableActions.pop();if(t){this._selectionCmd._removeAllSelections();for(var e=null,i=null,a=[],s=0;s<t.objectActionList.length;s++){if((e=t.objectActionList[s]).action===o.ACTION.CREATED)e.type===o.DATA_TYPE.SKETCH?(this._objectsStateID[e.id].updateID=e.newUpdateID,this._annotationManager.changeAnnotationIsOnSceneGraphWithId(e.id,!0,!1,!0),this._isWhiteboard&&a.push(this._objectsStateID[e.id].object)):e.type===o.DATA_TYPE.GROUP&&(this._objectsStateID[e.id].updateID=e.newUpdateID,this._objectsStateID[e.id].object=this._selectionCmd.groupObjects(e.actionData.objects,e.id,!0),a.push(this._objectsStateID[e.id].object));else if(e.action===o.ACTION.DISCARDED){if(e.type===o.DATA_TYPE.SKETCH)this._objectsStateID[e.id].updateID=e.newUpdateID,this._annotationManager.changeAnnotationIsOnSceneGraphWithId(e.id,!1,!1,!0);else if(e.type===o.DATA_TYPE.GROUP){let t=this._objectsStateID[e.id].actions[o.ACTION.EDITED],i=t[t.length-1],n=this._actionsHistory[i.actionsIndex].objectActionList[i.objectsIndex];a.push(...n.actionData.objects),this._selectionCmd.ungroup(n.actionData.objects[0].selectionGroupID.toString(),!0),this._objectsStateID[n.id].object=null}let t=a.findIndex(function(t,e){return e.getID()===t}.bind(this,e.id));t>-1&&a.splice(t,1)}else e.action===o.ACTION.MOVED&&(this._objectsStateID[e.id].updateID=e.newUpdateID,this._objectsStateID[e.id].actions[e.action].push({actionsIndex:this._actionsHistory.length,objectsIndex:s}),this._objectsStateID[e.id].object.setMoveData(e.actionData),(i=this._objectsStateID[e.id].object).getView&&(i=i.getView(),this._selectionCmd._updateShadowNode(i)),this._isWhiteboard&&a.push(this._objectsStateID[e.id].object));if(this._debugTraces){var r="";t===o.ACTION.CREATED&&(r="CREATED"),t===o.ACTION.MOVED&&(r="MOVED"),t===o.ACTION.DISCARDED&&(r="ERASED");var c="";e.type===o.DATA_TYPE.SKETCH?c="sketch":e.type===o.DATA_TYPE.MEDIA&&(c="media"),console.log("REDO "+c+" "+r+" "+e.id+" "+e.precedentUpdateID+" -> "+e.newUpdateID)}}a.length>0&&this._selectionCmd.selectObjects(a),this._actionsHistory.push(t),this._undoableActions.push(t),n.publish({event:"CAT3DSKUpdateAnnotationHistoryEvent",data:{isEmpty:this._isUndoEmpty(),isRedoEmpty:this._isRedoEmpty(),updateType:o.UPDATE_TYPE.REDO,action:t}})}},clear:function(){this._actionsHistory=[],this._undoableActions=[],this._redoableActions=[],n.publish({event:"CAT3DSKUpdateAnnotationHistoryEvent",data:{isEmpty:this._isUndoEmpty(),isRedoEmpty:this._isRedoEmpty(),updateType:o.UPDATE_TYPE.CLEAR}})}});return o.ACTION={CREATED:0,DISCARDED:1,MOVED:2,EDITED:3},o.UPDATE_TYPE={NEW_ACTION:0,NEW_COMPLEX_ACTION:1,UNDO:2,REDO:3,CLEAR:4},o.DATA_TYPE={SKETCH:0,MEDIA:1,GROUP:2,LAYERS:3,CONNECTION:4},o}),define("DS/CAT3DWInfraUI/CAT3DWCanvasLimits",["DS/CAT3DWInfra/CAT3DWPreferenceManager"],function(t){"use strict";const e={get MPLimit(){return t.getPreferenceValue("R2VPerspectiveModeOn")?2e6:5e6},areDimensionsWithinLimits:(t,i)=>t*i<e.MPLimit};return e}),define("DS/CAT3DWInfraUI/CAT3DWLoader",["UWA/Class","DS/Controls/Loader","i18n!DS/CAT3DWInfraUI/assets/nls/CAT3DWLoader","css!DS/CAT3DWInfraUI/CAT3DWInfraUI"],function(t,e,i){var n=t.extend({init:function(){this._loaderDiv=null,this._loader=null,this._container=null,this._defaultText=i.get("defaultLoader"),this._defaultFadeDuration=500},initialize:function(t){this._container=t},show:function(t,e){document.getElementById("x3DPhotoLoader")?this.reset():this._createLoader(),t&&(this._loader.text=t),null!=e&&(this._loader.fadeDuration=e),this._loader.on(),this._loaderDiv.show()},update:function(t){document.getElementById("x3DPhotoLoader")||this.show(),this._loader.update(t)},on:function(t){this._loader.on(t)},showSuccessAndhide:function(){document.getElementById("x3DPhotoLoader")&&(this._successDiv.show(),this._loader.elements.progressBar.emphasize="success",this._loader.text="",this._loaderDiv.hide(),setTimeout(function(){this._successDiv.hide(),this.reset()}.bind(this),1500))},showFailureAndhide:function(){document.getElementById("x3DPhotoLoader")&&(this._failureDiv.show(),this._loader.elements.progressBar.emphasize="high-attention",this._loader.text="",this._loaderDiv.hide(),setTimeout(function(){this._loaderDiv.hide(),this.reset()}.bind(this),1500))},hide:function(){document.getElementById("x3DPhotoLoader")&&(this._loaderDiv.hide(),this.reset())},reset:function(){this._loader.text=this._defaultText,this._loader.fadeDuration=this._defaultFadeDuration,this._loader.elements.progressBar.statusFlag=!1,this._loader.elements.progressBar.infiniteFlag=!0},remove:function(){this._loaderDiv.empty(),this._loaderDiv=null,this._loader=null},_createLoader:function(){this._loaderDiv=new UWA.Element("div",{class:"loader",id:"x3DPhotoLoader"}).inject(this._container);var t=new UWA.Element("div",{class:"loader-wrapper"}).inject(this._loaderDiv),i=new UWA.Element("div",{class:"loader-content"}).inject(t);this._loader=new e({text:this._defaultText,fadeDuration:this._defaultFadeDuration}).inject(i),this._successDiv=new UWA.Element("div",{class:"loader loaderSuccessOrFailure"}).inject(this._container);var n=new UWA.Element("div",{class:"loader-wrapper"}).inject(this._successDiv),o=new UWA.Element("div",{class:"loader-content"}).inject(n);o.classList.add("wux-ui-3ds","wux-ui-3ds-5x","wux-ui-3ds-check"),o.style="color:green;",this._successDiv.hide(),this._failureDiv=new UWA.Element("div",{class:"loader loaderSuccessOrFailure"}).inject(this._container);var a=new UWA.Element("div",{class:"loader-wrapper"}).inject(this._failureDiv),s=new UWA.Element("div",{class:"loader-content"}).inject(a);s.classList.add("wux-ui-3ds","wux-ui-3ds-5x","wux-ui-3ds-attention"),s.style="color:red;",this._failureDiv.hide()}});return UWA.namespace("DS/CAT3DWInfraUI/CAT3DWLoader",n.singleton())}),define("DS/CAT3DWInfraUI/CAT3DWInternalClipboard",["UWA/Class","UWA/Promise","UWA/Utils/Client"],function(t,e,i){"use strict";var n=UWA.Class.extend({init:function(t){this._debugMode=t,this._mediaToCopy=null},isEmpty:function(){return!this.mediaToCopy},writeText:function(t,e,i){var n={};n.type=t.getType(),n.text=t.getDataService().getValue("text"),n.textColor=t.getDataService().getValue("textColor"),n.backgroundColor=t.getDataService().getValue("backgroundColor"),n.inputDimensions=t.getDataService().getValue("inputDimensions"),n.previousPosition=t.getView().getMatrix().clone(),n.mediaOccId=t.getMediaOccId(),n.previousID=t.getID(),n.previousGroupID=i,n.depth=t.getView().getDepth(),e?this._mediaToCopy.objects.push(n):(this.empty(),this._mediaToCopy=n)},writeImage:function(t,e,i){var n={},o=t.getTextureClone();n.type=t.getType(),n.title=t.getDataService().getData().title,n.extension=t.getDataService().getData().extension,n.mediaType=t.getDataService().getData().mediaType,n.filetype=t.getDataService().getData().filetype,n.file=t.getFile(),n.url=o.image.currentSrc,n.previousPosition=t.getView().getMatrix().clone(),n.isVideo=!1,n.published=t.isPublished(),n.mediaOccId=t.getMediaOccId(),n.previousID=t.getID(),n.previousGroupID=i,n.mediaId=t.getDataService().getData().mediaId,n.depth=t.getView().getDepth(),e?this._mediaToCopy.objects.push(n):(this.empty(),this._mediaToCopy=n)},empty:function(){this._mediaToCopy=null},writeVideo:function(t,e,i){var n={};n.type=t.getType(),n.title=t.getDataService().getData().title,n.extension=t.getDataService().getData().extension,n.mediaType=t.getDataService().getData().mediaType,n.filetype=t.getDataService().getData().filetype,n.file=t.getFile(),n.url=t.getVideoData().getSrc(),n.previousPosition=t.getView().getMatrix().clone(),n.isVideo=!0,n.published=t.isPublished(),n.mediaOccId=t.getMediaOccId(),n.previousID=t.getID(),n.previousGroupID=i,n.mediaId=t.getDataService().getData().mediaId,n.depth=t.getView().getDepth(),e?this._mediaToCopy.objects.push(n):(this.empty(),this._mediaToCopy=n)},writeModel:function(t,e,i){var n={};n.type=t.getType(),n.previousPosition=t.getView().getMatrix().clone(),n.file=t.getFile(),n.title=t.getDataService().getData().title,n.extension=t.getDataService().getData().extension,n.mediaType=t.getDataService().getData().mediaType,n.filetype=t.getDataService().getData().filetype,n.url=t.getDataService().getData().url,n.published=t.isPublished(),n.mediaOccId=t.getMediaOccId(),n.previousID=t.getID(),n.previousGroupID=i,n.mediaId=t.getDataService().getData().mediaId,e?this._mediaToCopy.objects.push(n):(this.empty(),this._mediaToCopy=n)},writeAnnot:function(t,e,i){var n={type:"CAT3DSKAnnotationShapes"};n.id=t.id,n.previousPosition=t.getMatrix().clone(),n.previousGroupID=i,e?this._mediaToCopy.objects.push(n):(this.empty(),this._mediaToCopy=n)},getCopiedMedia:function(){if(!this._mediaToCopy)return null;var t={};if("MultiSelection"==this._mediaToCopy.type){(t={type:"MultiSelection"}).objects=[],t.previousPosition=this._mediaToCopy.previousPosition.clone();for(var e=0;e<this._mediaToCopy.objects.length;e++){var i=JSON.parse(JSON.stringify(this._mediaToCopy.objects[e]));i.previousPosition=this._mediaToCopy.objects[e].previousPosition.clone(),i.file=this._mediaToCopy.objects[e].file,t.objects.push(i)}}else(t=JSON.parse(JSON.stringify(this._mediaToCopy))).previousPosition=this._mediaToCopy.previousPosition.clone(),t.file=this._mediaToCopy.file;return t},writeMultiSelection:function(t){this.empty(),this._mediaToCopy={},this._mediaToCopy.type="MultiSelection",this._mediaToCopy.objects=[],this._mediaToCopy.previousPosition=t.getMatrix().clone()}});return UWA.namespace("DS/CAT3DWInfra/CAT3DWInternalClipboard",n)}),define("DS/CAT3DWInfraUI/CAT3DW3DDriveDialog",["UWA/Core","DS/Windows/Dialog","DS/Controls/Button","DS/Controls/ComboBox","DS/Tree/TreeNodeModel","DS/Tree/FileTreeView","DS/Tree/TreeDocument","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/CAT3DWInfra/CAT3DW3DDriveUtils","i18n!DS/CAT3DWInfraUI/assets/nls/CAT3DW3DDriveDialog"],function(t,e,i,n,o,a,s,r,c,l){"use strict";var h=0,d=null,u=null,p=new Map,g=null,_=null,m=null,f=[],D=0,b=function(t,e){this.service=t,this.name=e,this.folderList=new Map},v=function(t,e,i,n,o){this.title=t,this.extension=o,this.path=n,this.id=e,this.node=i,this.children=[]};function I(t,e,i,n){var a=new o({label:t,icons:e?[{iconName:"3dpart"}]:"folder",children:e?null:[]});n?n.addChild(a):u.addRoot(a);var s=f[h].folderList.get(i);if(s)s.node=a;else{var r=n?p.get(n).path+"\\"+t:t;s=new v(t,i,a,r,e),f[h].folderList.set(i,s),n&&p.get(n).children.push(s)}p.set(a,s)}function A(){u.removeRoots(),p.clear(),I(l.get("myfiles"),null,"DSROOT",null),I(l.get("sharedwithme"),null,"sharedwithme",null)}function T(t,e){var i=[],n=[];e.forEach(function(t){if(null!==t.extension&&""!==t.extension){var e="."+t.extension;null!=m&&m.includes(e)&&n.push(t)}else i.push(t)}),i.sort(function(t,e){return t.title>e.title?1:-1}),i.forEach(function(e){I(e.title,null,e.id,t)}),n.sort(function(t,e){return t.title>e.title?1:-1}),n.forEach(function(e){I(e.title,e.extension,e.id,t)})}function E(){var e=new t.createElement("div",{class:"3ddrivebrowser-treediv"});return u=new s({useAsyncPreExpand:!0}),(d=new a({treeDocument:u})).inject(e),u.onPreExpand(function(t){t&&function(t){if(t&&t.data&&t.data.nodeModel){var e=t.data.nodeModel,i=p.get(e);if(i&&t.target){var n=i.id,o=f[h].service;if(Array.isArray(e.options.children)&&e.options.children.length<1){var a=p.get(e);if(!(a.children.length>0))return c.getFolderContentsInTenant(n,o).then(function(i){Array.isArray(i.items)&&i.items.length>0&&T(e,i.items),t.target.preExpandDone()}).catch(function(){return t.target.preExpandDone(),!1});T(e,a.children),t.target.preExpandDone()}else t.target.preExpandDone()}else t.target.preExpandDone()}}(t)}),d.onNodeClick(function(t){t&&t.nodeModel&&function(t){if(t){var e=p.get(t);e&&(console.log(e.path),t.isSelected()?(g.disabled=!1,_=t):(g.disabled=!0,_=null))}}(t.nodeModel)}),u.getXSO().onEmpty(function(){_=null,g.disabled=!0}),e}function C(o,a){var s=new t.createElement("div");(function(){for(var e=0;e<f.length;++e)if(f[e].service.platformId===widget.getValue("x3dPlatformId")){h=e;break}var i=new t.createElement("div",{styles:{padding:"10px"}});new t.createElement("img",{styles:{width:"25px"},src:require.toUrl("DS/SWXWebUI/assets/icons/32/SWXWeb3DDriveIcon.png")}).inject(i);var o=new n({domId:"3ddrivebrowser-combo",elementsList:f.map(t=>t.name),selectedIndex:h,enableSearchFlag:!1});return o.addEventListener("change",function(t){t&&t.dsModel&&(h=t.dsModel.selectedIndex,A())}),o.inject(i),i})().inject(s),E().inject(s),A(),g=new i({label:l.get("OKButton"),disabled:!0,onClick:function(t){var e=null;if(_){var i=p.get(_);e={fileId:i.id,filePath:i.path,fileName:i.title,tenant:f[h].service}}a(e)}});var r=new e({immersiveFrame:o,title:l.get("BrowseDialogTitle"),closeButtonFlag:!1,resizableFlag:!0,touchMode:!0,minWidth:300,width:300,modalFlag:!0,content:s,buttons:{Cancel:new i({onClick:function(t){a()}}),Ok:g}});return r.addEventListener("startResize",function(t){t&&(D=t.srcElement.clientHeight)}),r.addEventListener("stopResize",function(t){if(t){var e=t.srcElement.clientHeight-D;r.height-=e}}),r}return{generate3DDriveBrowser:async function(t,e,i){f=[];for(var n=await async function(){return new Promise(function(t){r.getServiceUrl({serviceName:"3DDrive",onComplete:function(e){t(e)}})})}(),o=await async function(){return new Promise(function(t){return r.getPlatformServices({onComplete:function(e){t(e),console.log("data "+e)}})}).then(function(t){return t.map(function(t){return t.displayName})})}(),a=0;a<n.length;++a)if("url"in n[a]){var s=new b(n[a],o[a]);f.push(s)}m=i;var c=C(t,e);return document.getElementById("3ddrivebrowser-combo").style.width="250px",Promise.resolve(c)}}}),define("DS/CAT3DWInfraUI/CAT3DWPublishServices",["UWA/Class","UWA/Core","DS/ApplicationFrame/FrameWindowsManager","DS/ZipJS/zip","UWA/Promise"],function(t,e,i,n,o){"use strict";var a=t.extend({getScreenShot:function(t){var e;i.getFrameWindow().getViewer()&&(e=i.getFrameWindow().getViewer());var n=e.currentViewpoint,o=null;if(t.width&&t.height){let e=t.width,i=t.height,n=e*i,a=Math.sqrt(16777216/n);a<1&&(e*=a,i*=a),o={width:e,height:i}}else{let t=e.SCREEN_WIDTH*window.devicePixelRatio,i=e.SCREEN_HEIGHT*window.devicePixelRatio,n=t*i,a=Math.sqrt(16777216/n);a>1&&(a=Math.floor(a)),o={width:Math.floor(t*a),height:Math.floor(i*a)}}o.data=new Uint8ClampedArray(4*o.width*o.height),o.bufferWidth=o.width,o.bufferHeight=o.height,n.getControl().update(),e.renderToTarget(o,n);var a,s,r,c,l=new Uint8ClampedArray(4*o.width*o.height),h=o.height,d=o.width,u=4*d;for(s=0;s<h;s++)for(r=s*d*4,c=(h-s)*d*4,a=u;a--;)l[r+a]=o.data[c+a];var p=document.createElement("canvas");p.width=o.width,p.height=o.height;var g=p.getContext("2d"),_=new ImageData(l,p.width,p.height);g.putImageData(_,0,0),t.onSuccess(p)},zip:function(t){return new o(function(e,i){var o=null,a=function(t){if(0===t.length)o.close(function(t){e(t)});else{var i=t.shift(),s=null;"text"===i.type?s=new n.TextReader(i.data):"blob"===i.type&&(s=new n.BlobReader(i.data)),o.add(i.filename,s,function(){a(t)})}},s=new n.BlobWriter;n.createWriter(s,function(e){o=e,a(t)},function(){console.log("zip creation error"),i()})})},unzip:function(t,e){return new o(function(i){var o=new n.BlobReader(t);n.createReader(o,function(t){var o=t;o.getEntries(function(t){var a=t.find(function(t){return t.filename===e});a&&a.getData(new n.TextWriter,function(t){var e=t.target.result;o.close(function(){i(e)})})})},function(){console.log("zip error")})})}});return e.namespace("DS/CAT3DWInfraUI/CAT3DWPublishServices",a)}),define("DS/CAT3DWInfraUI/CAT3DWPointerEvents",["UWA/Class","DS/Core/PointerEvents"],function(t,e){"use strict";var i=t.extend({init:function(){this._palmThreshold=30},initialize:function(){document.addEventListener(e.POINTERDOWN,this._onPointerDown.bind(this)),document.addEventListener(e.POINTERMOVE,this._onPointerMove.bind(this)),document.addEventListener(e.POINTERUP,this._onPointerUp.bind(this)),document.addEventListener(e.POINTERHIT,this._onPointerHit.bind(this))},getPalmThreshold:function(){return this._palmThreshold},_onPointerDown:function(t){if(!this._isPalm(t)){var e=this._createEvent(i.POINTERSDOWN,t);if(e.nbFingers=this._getNbFingers(t),t.target.dispatchEvent(e),!(this._getNbFingers(t)>1)){var n=this._createEvent(i.POINTERDOWN,t);t.target.dispatchEvent(n)}}},_onPointerMove:function(t){if(!this._isPalm(t)){var e=this._createEvent(i.POINTERSMOVE,t);if(e.nbFingers=this._getNbFingers(t),t.target.dispatchEvent(e),!(this._getNbFingers(t)>1)){var n=this._createEvent(i.POINTERMOVE,t);t.target.dispatchEvent(n)}}},_onPointerUp:function(t){if(!this._isPalm(t)){var e=this._createEvent(i.POINTERSUP,t);if(e.nbFingers=this._getNbFingers(t),t.target.dispatchEvent(e),!(this._getNbFingers(t)>1)){var n=this._createEvent(i.POINTERUP,t);t.target.dispatchEvent(n)}}},_onPointerHit:function(t){if(!(this._isPalm(t)||this._getNbFingers(t)>1)){var e=this._createEvent(i.POINTERHIT,t);t.target.dispatchEvent(e)}},_isMobile:function(){var t=navigator.userAgent;return!!new RegExp("Mobile").test(t)},_isPalm:function(t){if(this._isMobile()||!t.touches||!t.touches.length)return!1;for(var e=!1,i=0;i<t.touches.length;i++){var n=t.touches[0];(n.radiusX>this._palmThreshold||n.radiusY>this._palmThreshold)&&(e=!0)}return e},_getNbFingers:function(t){return t.touches?t.touches.length:0},_createEvent:function(t,e){var i=new MouseEvent(t,e);return i.oldPreventDefault=i.preventDefault,i.oldStopPropagation=i.stopPropagation,i.oldStopImmediatePropagation=i.stopImmediatePropagation,i.touchFlag=e.touchFlag,i.preventDefault=function(t){i.oldPreventDefault(),e.preventDefault()},i.stopPropagation=function(t){i.oldStopPropagation(),e.stopPropagation()},i.stopImmediatePropagation=function(t){i.oldStopImmediatePropagation(),e.stopImmediatePropagation()},i}});return i.POINTERDOWN="CAT3DWPointerDown",i.POINTERSDOWN="CAT3DWPointersDown",i.POINTERMOVE="CAT3DWPointerMove",i.POINTERSMOVE="CAT3DWPointersMove",i.POINTERUP="CAT3DWPointerUp",i.POINTERSUP="CAT3DWPointersUp",i.POINTERHIT="CAT3DWPointerHit",UWA.namespace("DS/CAT3DWInfraUI/CAT3DWPointerEvents",i)}),define("DS/CAT3DWInfraUI/CAT3DWHandleResources",["UWA/Class","UWA/Promise","DS/RuntimeView/NLSManager"],function(t,e,i){"use strict";var n=t.extend({load:function(t,n){return new e(function(e,o){t||(console.warn("Using a invalid syntax... Should specify the module."),o());var a=t+"/"+n;i.onResourceLoaded({resourceFile:a},function(){if(this._manager&&this._manager._listOfResources){var t=this._manager._listOfResources;e(t[a][n])}else o()}),i.loadResource({resourceFile:a,resourceConverter:function(t){return t='{"'+(t=(t=(t=(t=t.replace(/(\/\*([\s\S]*?)\*\/)|(\/\/(.*)$)/gm,"")).replace(/(\r\n|\r|\n|\u0085|\u000C|\u2028|\u2029)/g,"")).replace(/\s+(?=([^"]*"[^"]*")*[^"]*$)/g,"")).replace(/[=]/g,'":').replace(/;/g,',"')).substring(0,t.length-2)+"}",function(t){var e,i,n,o={};for(var a in t){e=o;for(var s=(i=a.split(".")).pop();i.length;){n=i.shift();var r=UWA.typeOf(e[n]);r&&"object"!==r&&"array"!==r&&(e[n]={_value:e[n]}),"Case"===n&&(isNaN(s)||(s=parseInt(s)),"array"!==r&&(e[n]=[])),e=e[n]=e[n]||{}}"array"==UWA.typeOf(e)?e.push({id:"True"===s||"False"===s?Boolean("True"===s):s,_value:t[a]}):e[s]?e[s]._value=t[a]:e[s]=t[a]}return o}(UWA.Json.decode(t))}})})}});return UWA.namespace("DS/CAT3DWInfraUI/CAT3DWHandleResources",n.singleton())}),define("DS/CAT3DWInfraUI/CATLSLadibug",["UWA/Core","UWA/Class","WebappsUtils/WebappsUtils"],function(t,e,i){"use strict";var n=e.singleton({init:function(){this._logList=[],this._initialized=!1},initialize:function(){this._initialized||(this._initialized=!0,this._createUI(),this._createButton(),this._rewriteConsoleLog())},log:function(e,i){void 0===e?e="undefined":null===e?e="null":"string"!=typeof e&&(e=JSON.stringify(e)),this._logList.push(e);for(var n=e.indexOf("error")>0?"error":i,o=e.split("\n"),a=[],s={},r=0;r<o.length;r++)s={tag:"div"},r>0&&"error"===n&&!o[r].match(/^\s{0,}at\s/)?s.text="at "+o[r]:s.text=o[r],r>0&&(s.styles={marginLeft:"25px"}),a.push(s);new t.Element("div",{class:"ladibug-log "+n,html:a}).inject(this._content,"bottom"),this._content.scrollTop=this._content.scrollHeight},displayImage:function(e){new t.Element("div",{class:"ladibug-log image",html:[{tag:"img",src:e}]}).inject(this._content,"bottom"),this._content.scrollTop=this._content.scrollHeight},toggle:function(){this._body.hasClassName("hide")?(this._body.removeClassName("hide"),this._content.scrollTop=this._content.scrollHeight):this._body.addClassName("hide")},isVisible:function(){return this._button&&!this._button.hasClassName("hide")},show:function(){this.initialize(),this._body.removeClassName("hide"),this._button.removeClassName("hide"),this._content.scrollTop=this._content.scrollHeight},hide:function(){this.initialize(),this._body.addClassName("hide"),this._button.addClassName("hide")},_rewriteConsoleLog:function(){console.log=function(t){this.log(t)}.bind(this),console.error=function(t){var e=t;"string"!=typeof t&&(e=t.stack),this.log(e,"error")}.bind(this),console.warn=function(t){this.log(t,"warn")}.bind(this),console.time=function(t){this.log(t,"time")}.bind(this),console.timeEnd=function(t){this.log(t,"time")}.bind(this),console.info=function(t){this.log(t)}.bind(this),window.addEventListener("error",function(t){var e=t.error;"string"==typeof e?this.log(e,"error"):e.stack&&(e.message&&-1===e.stack.indexOf(e.message)&&this.log(e.constructor.name+": "+e.message,"error"),this.log(e.stack,"error"))}.bind(this)),console.image=function(t){this.displayImage(t)}.bind(this)},_createUI:function(){this._body=new t.Element("div",{id:"ladibug-body",class:"hide"}).inject(document.body),this._topBar=new t.Element("div",{id:"ladibug-topbar"}).inject(this._body),new t.Element("span",{class:"ladibug-title",text:"Lad'iBug"}).inject(this._topBar),this._content=new t.Element("div",{class:"ladibug-content"}).inject(this._body),this._dragElement()},_createButton:function(){this._button=new t.Element("div",{id:"ladibug-button",html:{tag:"img",src:i.getWebappsAssetUrl("CAT3DWInfraUI","icons/CAT3DWLadibug.png")},events:{click:this.toggle.bind(this)}}).inject(document.body)},_dragElement:function(){this._pos1=0,this._pos2=0,this._pos3=0,this._pos4=0,this._topBar.onmousedown=this._dragDown.bind(this),this._topBar.ontouchstart=this._dragDown.bind(this)},_dragDown:function(t){var e,i;(t=t||window.event).preventDefault(),t.changedTouches?(e=t.changedTouches[0].clientX,i=t.changedTouches[0].clientY):(e=t.clientX,i=t.clientY),this._pos3=e,this._pos4=i,document.onmouseup=this._closeDragElement.bind(this),document.ontouchend=this._closeDragElement.bind(this),document.onmousemove=this._elementDrag.bind(this),document.ontouchmove=this._elementDrag.bind(this)},_elementDrag:function(t){var e,i;(t=t||window.event).preventDefault(),t.changedTouches?(e=t.changedTouches[0].clientX,i=t.changedTouches[0].clientY):(e=t.clientX,i=t.clientY),this._pos1=this._pos3-e,this._pos2=this._pos4-i,this._pos3=e,this._pos4=i,this._body.style.top=this._body.offsetTop-this._pos2+"px",this._body.style.left=this._body.offsetLeft-this._pos1+"px"},_closeDragElement:function(){document.onmouseup=null,document.onmousemove=null,document.ontouchend=null,document.ontouchmove=null}});return t.namespace("DS/CAT3DPhotoNR/CATLSLadibug",n)}),define("DS/CAT3DWInfraUI/CAT3DWProgressBar",["UWA/Class","UWA/Core","DS/Controls/ProgressBar","i18n!DS/CAT3DWInfraUI/assets/nls/CAT3DWProgressBar","css!DS/CAT3DWInfraUI/CAT3DWInfraUI"],function(t,e,i,n){"use strict";var o=t.extend({init:function(t){this._parentContainer=t.container,this._id=t.id?t.id:this._getUniqueId(),this._container=null,this._overlay=null,this._label=t.label?t.label:n.get("defaultLabel"),this._hideTimeouts=[]},show:function(){if(this._clearTimeouts(),this._container)return this._container.setStyle("opacity",1),void this._container.show();this._container=new e.Element("div",{id:this._id,class:"CAT3DWProgressBar"}).inject(this._parentContainer),this._overlay||(this._overlay=new e.Element("div",{class:"CAT3DWProgressBar-overlay"}).inject(this._parentContainer));var t=new e.Element("div",{class:"progressBar-container"}).inject(this._container),n=new e.Element("div",{class:"progressBar-wrap"}).inject(t);new e.Element("span",{class:"progressBar-label",text:this._label}).inject(n),new i({displayStyle:"lite",infiniteFlag:!0,emphasize:"info"}).inject(n)},hide:function(){this._clearTimeouts(),this._hideTimeouts.push(setTimeout(function(){this._container&&(this._container.setStyle("opacity",0),this._hideTimeouts.push(setTimeout(function(){this._container&&(this._container.destroy(),this._container=null)}.bind(this),200))),this._overlay&&this._hideTimeouts.push(setTimeout(function(){this._overlay&&(this._overlay.destroy(),this._overlay=null)}.bind(this),200))}.bind(this),400))},_clearTimeouts:function(){for(;this._hideTimeouts.length>0;)clearTimeout(this._hideTimeouts.shift())},_getUniqueId:function(){var t="CAT3DWPB_";return t+=(new Date).getUTCMilliseconds()}});return e.namespace("DS/CAT3DWInfraUI/CAT3DWProgressBar",o)}),define("DS/CAT3DWInfraUI/CAT3DWHandleErrors",["UWA/Class","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/Notifications/NotificationsManagerViewOnConsole","DS/CAT3DWInfraUI/CAT3DWHandleResources","css!DS/CAT3DWInfraUI/CAT3DWInfraUI"],function(t,e,i,n,o){"use strict";var a,s=t.extend({SUCCESS:"success",INFORMATION:"info",WARNING:"warning",ERROR:"error",init:function(){this._notificationsList=[]},initialize:function(){a={},o.load("CAT3DWInfraUI","CAT3DWHandleErrors").then(function(t){return a=t,1},function(){}),void 0===window.notifs&&(window.notifs=e),void 0===window.notifsDisp&&(window.notifsDisp=n),i.setNotificationManager(window.notifs)},DisplayGeneralMessage:function(t){this.DisplayMessage(this.getResource(t),this.getSeverity(t))},setGeneralErrorMessage:function(t,e,n,o){switch(o=o.toLowerCase()){case this.SUCCESS:case this.INFORMATION:case this.WARNING:case this.ERROR:break;default:o=this.ERROR}var a={level:o,title:t,subtitle:e,message:n,sticky:!1},s=window.notifs.addNotif(a);this._notificationsList.push(s),o===this.ERROR?setTimeout(function(t){i.removeNotification(t)}.bind(this,s),6e3):o===this.WARNING&&setTimeout(function(t){i.removeNotification(t)}.bind(this,s),4e3)},modifyErrorMessage:function(t,e,i,n,o){switch(o){case this.SUCCESS:case this.INFORMATION:case this.WARNING:case this.ERROR:break;default:o=this.ERROR}var a={level:o,title:e,subtitle:i,message:n,sticky:!1};window.notifs.modifyNotif(t,a)},DisplayMessage:function(t,e){switch(e){case this.SUCCESS:case this.INFORMATION:case this.WARNING:case this.ERROR:break;default:e=this.ERROR}var i={level:e,title:a.Title[e],message:t,sticky:!1};window.notifs.addNotif(i)},clearAllErrors:function(){for(var t=this._notificationsList.length,e=0;e<t;e++)i.removeNotification(this._notificationsList[e])},getSeverityFromInt:function(t){var e=this.ERROR;switch(t){case 0:e=this.SUCCESS;break;case 1:case 2:e=this.ERROR;break;case 3:e=this.WARNING;break;case 4:e=this.INFORMATION;break;default:t=this.ERROR}return e},getSeverity:function(t){"string"!=typeof t&&(t=t._value);var e=t.split(".");if(e.length<2)return this.ERROR;switch(e[1].toUpperCase()){case"SUCCESS":return this.SUCCESS;case"INFO":return this.INFORMATION;case"WARNING":return this.WARNING;case"ERROR":default:return this.ERROR}},getResource:function(t){"string"!=typeof t&&(t=t._value);var e='Unknown resource id "'+t+'"',i=t.split(".");if(i.length<2)return e;for(var n=a,o=1;o<i.length;o++){if(!n.hasOwnProperty(i[o]))return e;n=n[i[o]]}return n}});return UWA.namespace("DS/CAT3DWInfraUI/CAT3DWHandleErrors",s.singleton())}),define("DS/CAT3DWInfraUI/CAT3DWCanvasServices",["UWA/Class","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWInfraUI/CAT3DWCanvasLimits"],function(t,e,i){"use strict";return t.extend({loadImage:function(t,i,n,o){var a=new Image;a.onload=function(){n&&n(a)},a.onerror=function(e){console.error("Failed to load image "+t),o&&o(e)},a.crossOrigin=i?"anonymous":e.getPreferenceValue("CrossOrigin"),a.src=t},loadVideo:function(t,i,n,o){var a=document.createElement("video");a.addEventListener("loadedmetadata",function(){n&&n(a)}),a.onerror=function(e){console.error("Failed to load video "+t),o&&o(e)},a.crossOrigin=i?"anonymous":e.getPreferenceValue("CrossOrigin"),a.src=t},getOptimizedDataUrlFromUrl:function(t,e,i,n,o){this.loadImage(t,!1,function(t){var a=this.getOptimizedDataUrlFromImg(t,e,i,o);n&&n(a)}.bind(this))},getOptimizedDataUrlFromImg:function(t,e,i,n){var o=e||2e3,a=i||1500,s=this._getNewDimensions(t,o,a),r=document.createElement("canvas");r.width=s.width,r.height=s.height;var c=r.getContext("2d");c.fillStyle="white",c.fillRect(0,0,s.width,s.height),c.drawImage(t,0,0,s.width,s.height);var l=r.toDataURL(n||"image/jpeg");return r=null,c=null,l},getDataUrlFromImg:function(t,e){var n,o=document.createElement("canvas");if(i.areDimensionsWithinLimits(t.width,t.height))o.height=t.height,o.width=t.width,o.getContext("2d").drawImage(t,0,0,t.width,t.height);else{var a=t.width/t.height,s=Math.floor(Math.sqrt(i.MPLimit/a)),r=Math.floor(a*s);o.height=s,o.width=r,o.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,r,s)}return n=o.toDataURL(e||"image/jpeg"),o=null,null,n},getDataUrlFromImgArray:function(t,e,i,n){var o,a=document.createElement("canvas");a.height=i,a.width=e;var s=a.getContext("2d"),r=s.createImageData(e,i);if(t.length===e*i*4)for(let e=0;e<t.length;e++)r.data[e]=t[e];else if(t.length===e*i*3){var c=e*i*4,l=0;for(let e=0;e<c;e+=4)r.data[e]=t[l],r.data[e+1]=t[l+1],r.data[e+2]=t[l+2],r.data[e+3]=255,l+=3}return s.putImageData(r,0,0),o=a.toDataURL(n||"image/jpeg"),a=null,s=null,o},getImgDataFromUrl:function(t,e){t?this.loadImage(t,!1,function(t){var i=document.createElement("canvas");i.height=t.height,i.width=t.width;var n=i.getContext("2d");n.drawImage(t,0,0,t.width,t.height);var o=n.getImageData(0,0,t.width,t.height);i=null,n=null,e(o)}):e(null)},getImgDataFromImg:function(t){var e=document.createElement("canvas");e.height=t.height,e.width=t.width;var i=e.getContext("2d");i.drawImage(t,0,0,t.width,t.height);var n=i.getImageData(0,0,t.width,t.height);return e=null,i=null,n},getBlobUrlFromImg:function(t,e,i,n){this.getDataUrlFromImgSrc(t,function(t,i){var o=this.getBlobUrlFromDataUrl(t,n);e(o,i)}.bind(this),n,i)},getBlobUrlFromCanvas:function(t,e){if(!t)return null;var i=e||"image/jpg",n=t.toDataURL(i);return this.getBlobUrlFromDataUrl(n,i)},getBlobUrlFromDataUrl:function(t,e){if(!t)return"";var i=this._fromBase64ToBlob(t,e);return this._fromBlobToImage(i)},getBlobFromDataUrl:function(t,e){return t?this._fromBase64ToBlob(t,e):""},getBlobFromImageSrc:function(t,e,i,n){this.getDataUrlFromImgSrc(t,function(t){var n=this.getBlobFromDataUrl(t,i);e(n)}.bind(this),i,n)},getDataUrlFromImgSrc:function(t,e,i,n){this.loadImage(t,!1,function(t){var n=this.getDataUrlFromImg(t,i);e(n,{width:t.width,height:t.height}),t=null}.bind(this),n)},getBlobFromVideoSrc:function(t,e,i,n){this.getDataUrlFromVideoSrc(t,function(t){var n=this.getBlobFromDataUrl(t,i);e(n)}.bind(this),i,n)},getDataUrlFromVideoSrc:function(t,e,i,n){this.loadVideo(t,!1,function(t){var n=this.getDataUrlFromImg(t,i);e(n,{width:t.width,height:t.height}),t=null}.bind(this),n)},_fromBase64ToBlob:function(t,e){return this._b64toBlob(t.split(",")[1],e)},_fromBlobToImage:function(t){return URL.createObjectURL(t)},_b64toBlobNoType:function(t){for(var e=atob(t),i=e.length,n=new Uint8Array(i),o=0;o<i;o++)n[o]=e.charCodeAt(o);return new Blob([n],{type:""})},_b64toBlob:function(t,e){for(var i=e||"image/jpeg",n=atob(t),o=n.length,a=new Uint8Array(o),s=0;s<o;s++)a[s]=n.charCodeAt(s);return new Blob([a],{type:i})},_getNewDimensions:function(t,e,i){var n=t.width,o=t.height;return n>o?n>e&&(o*=e/n,n=e):o>i&&(n*=i/o,o=i),{width:n,height:o}},StringToArrayBuffer:function(t){return this.StringToUint8Array(t).buffer},StringToBinary:function(t){var e,i,n,o,a,s;for(a=t.length,e=[],o=!1,n=s=0;0<=a?s<a:s>a;n=0<=a?++s:--s){if((i=String.prototype.charCodeAt.call(t,n))>255){o=!0,e=null;break}e.push(i)}return!0===o?unescape(encodeURIComponent(t)):String.fromCharCode.apply(null,Array.prototype.slice.apply(e))},StringToUint8Array:function(t){var e,i,n,o,a,s;for(i=(e=this.StringToBinary(t)).length,n=new ArrayBuffer(i),o=new Uint8Array(n),a=s=0;0<=i?s<i:s>i;a=0<=i?++s:--s)o[a]=String.prototype.charCodeAt.call(e,a);return o}})}),define("DS/CAT3DWInfraUI/CAT3DWClipboard",["UWA/Class","UWA/Promise","DS/CAT3DWInfraUI/CAT3DWCanvasServices","UWA/Utils/Client","DS/WAFData/WAFData"],function(t,e,i,n,o){"use strict";var a=UWA.Class.extend({init:function(t,e){this._debugMode=t,this._isODT=e,this._canvasServices=new i},writeText:function(t,i){return new e(function(e,o){if(this._isODT&&(console.warn("Dont write text in the clipboard in ODT context"),e()),navigator.clipboard&&navigator.clipboard.writeText&&!i)navigator.clipboard.writeText(t).then(function(){this._debugMode&&console.log("%c SUCCESS - Text copied to clipboard : "+t,"background-color:rgba(0, 255, 0, 0.1);color: green"),e()}.bind(this)).catch(function(t){this._debugMode&&(console.error("FAILED to write text in the clipboard"),t&&console.error(t)),o({error:t,errortype:a.ERRORWRITETEXT})}.bind(this));else if(navigator.clipboard&&navigator.clipboard.write&&i){var s=new Blob([i.outerHTML],{type:"text/html"}),r=new Blob([t],{type:"text/plain"}),c=[n.Platform.android?new ClipboardItem({"text/plain":r}):new ClipboardItem({"text/plain":r,"text/html":s})];navigator.clipboard.write(c).then(function(){this._debugMode&&console.log("%c SUCCESS - Text copied to clipboard","background-color:rgba(0, 255, 0, 0.1);color: green"),e()}.bind(this)).catch(function(t){this._debugMode&&(console.error("FAILED to write text in the clipboard"),t&&console.error(t)),o({error:t,errortype:a.ERRORWRITETEXT})}.bind(this))}else{this._debugMode&&console.error("FAILED to write image in the clipboard due to navigator/OS incompatibility reason"),n.Engine.firefox&&i&&console.warn("Set to true dom.events.asyncClipboard.clipboardItem, dom.events.asyncClipboard.read, dom.events.testing.asyncClipboard preferences in about:config");var l=a.ERRORCOMPATIBILITYWRITE;n.Engine.firefox&&i&&(l=a.ERRORCOMPATIBILITYFIREFOXWRITE),o({error:null,errortype:l})}}.bind(this))},writeImage:function(t){return new e(function(e,i){if(this._isODT&&(console.warn("Dont write image in the clipboard in ODT context"),e()),navigator.clipboard&&navigator.clipboard.write){var o=new Blob([t.outerHTML],{type:"text/html"}),s=this._canvasServices.getDataUrlFromImg(t,"image/png"),r=this._canvasServices.getBlobFromDataUrl(s,"image/png"),c=[n.Platform.android?new ClipboardItem({"image/png":r}):new ClipboardItem({"image/png":r,"text/html":o})];navigator.clipboard.write(c).then(function(){this._debugMode&&console.log("%c SUCCESS - Image copied to clipboard","background-color:rgba(0, 255, 0, 0.1);color: green"),e()}.bind(this)).catch(function(t){this._debugMode&&(console.error("FAILED to write image in the clipboard"),t&&console.error(t)),i({error:t,errortype:a.ERRORWRITEIMAGE})}.bind(this))}else if("http:"===document.location.protocol)this._debugMode&&console.error("FAILED to write image in the clipboard due to security reason"),i({error:new Error("Run app in secure context"),errortype:a.ERRORPERMISSIONDENIED});else{this._debugMode&&console.error("FAILED to write image in the clipboard due to navigator/OS incompatibility reason"),n.Engine.firefox&&console.warn("Set to true dom.events.asyncClipboard.clipboardItem, dom.events.asyncClipboard.read, dom.events.testing.asyncClipboard preferences in about:config");var l=a.ERRORCOMPATIBILITYWRITE;n.Engine.firefox&&(l=a.ERRORCOMPATIBILITYFIREFOXWRITE),i({error:null,errortype:l})}}.bind(this))},read:function(){return new e(function(t,e){this.readText().then(function(i){i&&" "===i?e({error:null,errortype:a.ERROREMPTY}):this.readData().then(function(i){if(i&&i.length){var n=i[0],o={},s=0,r=function(){++s===n.types.length&&(o.type&&o.data?t(o):e({error:null,errortype:a.ERRORINVALIDDATA}))};n.types&&n.types.length||e({error:null,errortype:a.ERRORINVALIDDATA});for(var c=0;c<n.types.length;c++)"image/png"===n.types[c]?n.getType(n.types[c]).then(function(t){o.data=URL.createObjectURL(t),o.type=a.TYPEIMAGE,r()}).catch(function(){r()}):"text/plain"===n.types[c]?n.getType(n.types[c]).then(function(t){t.text().then(function(t){o.data=t,o.type=a.TYPETEXT,r()}).catch(function(){r()})}).catch(function(){r()}):"text/html"===n.types[c]?n.getType(n.types[c]).then(function(t){t.text().then(function(t){var e=document.createRange().createContextualFragment(t);o.html=e;var i=e.querySelectorAll("img");!o.type&&i.length?this._requestImage(i[0].src).then(function(t){o.data=t,o.type=a.TYPEIMAGE,r()}).catch(function(){r()}):r()}.bind(this)).catch(function(){r()})}.bind(this)).catch(function(){r()}):"text/uri-list"===n.types[c]?n.getType(n.types[c]).then(function(t){t.text().then(function(t){o.type?r():this._requestImage(t).then(function(t){o.data=t,o.type=a.TYPEIMAGE,r()}).catch(function(){r()})}.bind(this)).catch(function(){r()})}.bind(this)).catch(function(){r()}):r()}else e({error:null,errortype:a.ERROREMPTY})}.bind(this)).catch(function(t){e(t)})}.bind(this)).catch(function(t){e(t)})}.bind(this))},readText:function(){return new e(function(t,e){navigator.clipboard&&navigator.clipboard.readText&&!this._isSamsungBrowser()?navigator.clipboard.readText().then(function(e){this._debugMode&&console.log("%c SUCCESS - Text read in the clipboard : "+e,"background-color:rgba(0, 255, 0, 0.1);color: green"),t(e)}.bind(this)).catch(function(t){this._debugMode&&(console.error("FAILED to read text in the clipboard"),t&&console.error(t)),e({error:t,errortype:a.ERRORREADTEXT})}.bind(this)):n.Engine.firefox?this.readData().then(function(e){for(var i=e[0],n=0;n<i.types.length;n++)if("text/plain"===i.types[n]){i.getType(i.types[n]).then(function(e){e.text().then(function(e){this._debugMode&&console.log("%c SUCCESS - Text read in the clipboard : "+e,"background-color:rgba(0, 255, 0, 0.1);color: green"),t(e)}.bind(this))});break}}).catch(function(t){this._debugMode&&(console.error("FAILED to read text in the clipboard"),t.error&&console.error(t.error)),e({error:t.error,errortype:t.errortype})}.bind(this)):"http:"===document.location.protocol?(this._debugMode&&console.error("FAILED to read text in the clipboard due to security reason"),e({error:new Error("Run app in secure context"),errortype:a.ERRORPERMISSIONDENIED})):(this._debugMode&&console.error("FAILED to read text in the clipboard due to navigator/OS incompatibility reason"),e({error:null,errortype:a.ERRORCOMPATIBILITYREAD}))}.bind(this))},readData:function(){return new e(function(t,e){if(navigator.clipboard&&navigator.clipboard.read&&!this._isSamsungBrowser())navigator.clipboard.read().then(function(e){this._debugMode&&console.log("%c SUCCESS - Data read in the clipboard","background-color:rgba(0, 255, 0, 0.1);color: green"),t(e)}.bind(this)).catch(function(t){this._debugMode&&(console.error("FAILED to read data in the clipboard"),t&&console.error(t)),e({error:t,errortype:a.ERRORREADDATA})}.bind(this));else if("http:"===document.location.protocol)this._debugMode&&console.error("FAILED to read data in the clipboard due to security reason"),e({error:new Error("Run app in secure context"),errortype:a.ERRORPERMISSIONDENIED});else{this._debugMode&&console.error("FAILED to read data in the clipboard due to navigator/OS incompatibility reason"),n.Engine.firefox&&console.warn("Set to true dom.events.asyncClipboard.clipboardItem, dom.events.asyncClipboard.read, dom.events.testing.asyncClipboard preferences in about:config");var i=a.ERRORCOMPATIBILITYREAD;n.Engine.firefox&&(i=a.ERRORCOMPATIBILITYFIREFOXREAD),e({error:null,errortype:i})}}.bind(this))},_requestImage:function(t){return new e(function(e,i){o.proxifiedRequest(t,{method:"GET",type:"blob",onComplete:function(t){if(t.type.includes("image/")){var n=URL.createObjectURL(t);e(n)}else i()},onFailure:function(t){t&&console.error(t),i()}})})},writeTextInCPD:function(t,e,i){e?(e.setData("text/plain",t),i&&e.setData("text/html",i.outerHTML),this._debugMode&&console.log("%c SUCCESS - Text copied to clipboard : "+t,"background-color:rgba(0, 255, 0, 0.1);color: green")):this._debugMode&&console.warn("An event.clipboardData must be provided")},writeImageInCPD:function(t,e){if(e){var i=this._canvasServices.getDataUrlFromImg(t,"image/png"),n=this._canvasServices.getBlobFromDataUrl(i,"image/png");e.setData("image/png",n),e.setData("text/html",t.outerHTML),this._debugMode&&console.log("%c SUCCESS - Image copied to clipboard","background-color:rgba(0, 255, 0, 0.1);color: green")}else this._debugMode&&console.warn("An event.clipboardData must be provided")},readInCPD:function(t){if(!t)return this._debugMode&&console.warn("An event.clipboardData must be provided"),{error:null,errortype:a.ERROREMPTY};var e=this.readTextInCPD(t);if(e&&" "===e)return{error:null,errortype:a.ERROREMPTY};var i=this.readDataInCPD(t);if(!i||!i.length)return{error:null,errortype:a.ERROREMPTY};for(var n={},o=0;o<i.length;o++)if("file"===i[o].kind&&"image/png"===i[o].type){var s=i[o].getAsFile();n.type=a.TYPEIMAGE,s&&(n.data=URL.createObjectURL(s))}else if("string"===i[o].kind&&"text/plain"===i[o].type)n.data=t.getData("text/plain"),n.type=a.TYPETEXT;else if("string"===i[o].kind&&"text/html"===i[o].type){var r=t.getData("text/html"),c=document.createRange().createContextualFragment(r);n.html=c}else"string"===i[o].kind&&"text/uri-list"===i[o].type&&(n.type||(n.type=a.TYPELINK,n.data=t.getData("text/uri-list")));if(n.type===a.TYPEIMAGE&&!n.data&&n.html){var l=n.html.querySelector("img");n.data=l.src}return n.type&&n.data?n:{error:null,errortype:a.ERRORINVALIDDATA}},readTextInCPD:function(t){return t.getData("text")},readDataInCPD:function(t){return t.items},empty:function(){return this.writeText(" ")},_isSamsungBrowser:function(){return navigator.userAgent.match(/SamsungBrowser/i)}});return a.TYPETEXT="typetext",a.TYPEIMAGE="typeimage",a.TYPELINK="typelink",a.ERROREMPTY="errorempty",a.ERRORINVALIDDATA="errorinvaliddata",a.ERRORREADTEXT="errorreadtext",a.ERRORWRITETEXT="errorwritetext",a.ERRORWRITEIMAGE="errorwriteimage",a.ERRORREADDATA="errorreaddata",a.ERRORCOMPATIBILITYFIREFOXWRITE="errorcompatibilityfirefoxwrite",a.ERRORCOMPATIBILITYFIREFOXREAD="errorcompatibilityfirefoxread",a.ERRORPERMISSIONDENIED="errorpermissiondenied",a.ERRORCOMPATIBILITYWRITE="errorcompatibilitywrite",a.ERRORCOMPATIBILITYREAD="errorcompatibilityread",UWA.namespace("DS/CAT3DWInfraUI/CAT3DWClipboard",a)});