define("DS/WebConnector2D/Loader",["UWA/Core","UWA/Class","DS/WebViewer2D/ViewerError"],function(e,t,i){"use strict";return t.extend({init:function(e){this._parent(e),this._type="none",this.aborted=!1},load:function(e,t){this.aborted=!1,this._load(t,e)},createViewers:function(e,t){console.warn("3DPlay/WebConnector2D/Loader - deprecated creation of 2D viewer please migrate to load function"),this._load(t,e)},_createErrorViewer:function(e,t){e.push(new i({sheet:0,viewer:t.viewer,asset:t.asset}))},_load:function(e,t){this._createErrorViewer(t,e)},getLoaderType:function(){return this._type},abort:function(){this.aborted=!0},isAborted:function(){return this.aborted}})}),define("DS/WebConnector2D/LoaderSvg",["UWA/Core","UWA/Class","DS/WebConnector2D/Loader","DS/WebViewer2D/ViewerSvg","DS/WebSystem/Environment","DS/WAFData/WAFData","DS/WebSystem/Nls","DS/WebSystem/DetectBrowser","i18n!DS/WebConnector2D/assets/nls/WebConnector2D"],function(e,t,i,s,r,a,n,h,o){"use strict";return t.singleton(i,{init:function(e){this._parent(e),this._type="svg",this._isGeneratingThumb=!1,this._thumbToUpdate=[];require(["i18n!DS/3DPlay/assets/nls/3DPlay"],function(e){this.nls3DPlay=e}.bind(this))},_load:function(e,t){this.inputs=e,this.viewerTab=t,this._isGeneratingThumb=!1,this._thumbToUpdate=[];var i=this.inputs.asset.filename||this.inputs.asset;void 0===this.inputs.asset.provider||"FILE"===this.inputs.asset.provider?this._loadFile(i):"EV6"===this.inputs.asset.provider?"Drawing"===this.inputs.asset.dtype?this._getSvgFromV6Drawing(i,this._loadFile.bind(this),this._displayError.bind(this)):this._getSvgFromCATDrawing(i,this._loadFile,this._displayError):"BUFFER"===this.inputs.asset.provider?this.inputs.asset.data?(this.rawSVG=this.inputs.asset.data,this._createViewersFromText(this.inputs.asset.data)):this._displayError({errorID:"NO_2D_GEOMETRY"}):"STREAM"===this.inputs.asset.provider?this._createViewersFromStream(this.inputs.asset.data):this._displayError()},_clean:function(){this.inputs=void 0,this.viewerTab=void 0},_displayError:function(e){e&&e.errorID?"NO_2D_GEOMETRY"===e.errorID?SHARE.Core.displayNotification({ctx:this.inputs.ctx,msg:this.nls3DPlay.LoadingError_NO_2D_GEOMETRY,error:e.errorID}):SHARE.Core.displayFatalError({ctx:this.inputs.ctx,msg:this.nls3DPlay[e.errorID],error:e.errorID}):SHARE.Core.displayFatalError({ctx:this.inputs.ctx,msg:this.nls3DPlay.LoadingDocumentError+this.inputs.asset.physicalid,error:"LoadingDocumentError"}),this.inputs.progress.hide(),this._clean()},_loadFile:function(t,i){var s=this,r={type:"text",cache:3600,timeout:72e5,onComplete:function(e){s._createViewersFromText(e),s=void 0},onCancel:function(e){s._displayError(e),s=void 0},onFailure:function(e){s._displayError(e),s=void 0}};e.is(i,"object")&&e.merge(r,i),a.handleRequest(t,r)},_createViewersFromText:function(e){var t=(new DOMParser).parseFromString(e,"application/xml");this._createViewersFromXML(t)},_getSVGSheet:function(e,t){var i=e.outerHTML;(t&&!0===t.isIE||null==i)&&(i=(new XMLSerializer).serializeToString(e));var s,r=null,a=null;if(e.width.baseVal.unitType>=0&&e.width.baseVal.unitType<11&&e.height.baseVal.unitType>=0&&e.height.baseVal.unitType<11&&(2===e.height.baseVal.unitType&&e.viewBox&&e.viewBox.baseVal.width>0&&e.viewBox.baseVal.height>0?(r=e.viewBox.baseVal.width,a=e.viewBox.baseVal.height,i=i.replace(new RegExp("<svg ",""),'<svg height="'+a+'px" width="'+r+'px" ')):e.width.baseVal.valueInSpecifiedUnits&&e.height.baseVal.valueInSpecifiedUnits&&(r=e.width.baseVal.valueInSpecifiedUnits,a=e.height.baseVal.valueInSpecifiedUnits,i=(i=i.replace(new RegExp('height="'+e.height.baseVal.valueAsString+'"',""),'height="'+a+'px"')).replace(new RegExp('width="'+e.width.baseVal.valueAsString+'"',""),'width="'+r+'px"'))),null===r||null===a)return this._displayError({errorID:"LoadingError_BAD_SIZE"}),{asset:"",title:"",width:0,height:0};var n=e.getElementsByTagName("title");return n&&n.item(0)&&(s=n.item(0).textContent),{asset:i,title:s,width:r,height:a}},_getSVGSheets:function(e){var t,i,s,r=[];if(e.children&&e.children[0]&&e.children[0].children[0])for(s="parsererror"===e.children[0].children[0].tagName||"svg"===e.children[0].children[0].tagName?e.children[0].children:e.children,i=0;i<s.length;++i)"svg"===(t=s[i]).tagName&&r.push(this._getSVGSheet(t,{isIE:!1}));else if(e.childNodes)for(i=0;i<e.childNodes.length;++i){var a=e.childNodes[i],n=r.length;if(a.childNodes&&a.childNodes.length>0){for(var h=0;h<a.childNodes.length;++h)"parsererror"===(t=a.childNodes[h]).localName||"parsererror"!==t.tagName&&"svg"!==t.tagName||r.push(this._getSVGSheet(t,{isIE:!0}));n!==r.length||"parsererror"===a.localName||"parsererror"!==a.tagName&&"svg"!==a.tagName||r.push(this._getSVGSheet(a,{isIE:!0}))}}return r},_createViewersFromXML:function(e){var t=this._getSVGSheets(e);if(t){this.inputs.loadCB.setNbSheet(t.length),this._viewer||(this._viewer=new s({viewer:document.createElement("div"),asset:null,defaultTitle:"this.title",typeOfDoc:this._type}));var i=this;this._loadQueue=[];for(var r=function(e){i._viewer.loadAsset({asset:i.viewerTab[e].content,doneCB:function(t,s){if(i.viewerTab[e].thumbnail=s,i.viewerTab[e].thumbIsGenerated=!0,i.viewerTab[e].content.image=t,i.viewerTab[e].content.pageIndex=e,i.viewerTab[e].status={loaded:!0,failed:!1},i.inputs.loadCB.done(e),i._loadQueue.length>0){var a=i._loadQueue.shift();r(a.idx)}else i._isGeneratingImage=!1,i._viewer=null}})},a=0;a<t.length;a++){var n=t[a].height,h=t[a].width;t[a].aspectRatio=t[a].width/t[a].height,t[a].height<.5*t[0].height&&(n=t[a].height=t[0].height,h=t[a].width=t[0].height*t[a].aspectRatio),this.viewerTab[a]={content:t[a],realSizeHeight:n,realSizeWidth:h,format:"svg",status:{loaded:!1,failed:!1}},this._isGeneratingImage?this._loadQueue.push({idx:a}):(this._isGeneratingImage=!0,r(a))}t=void 0}else{var o={svg:!0,url:this.inputs.asset};this.inputs.loadCB.failed(0,o)}},_cleanBufferAndParse:function(e){var t=/(<svg[\w\W]*svg>)/.exec(e);null!=t&&(t=t[1]);var i=document.createElement("div");return i.innerHTML=t,i.children[0]},_createViewersFromStream:function(e){var t=this;this._loadQueue=[],this.inputs.loadCB.setNbSheet(e.length);for(var i=0;i<e.length;i++)t.viewerTab[i]={status:{failed:!1,loaded:!1},format:"svg"};var r=function(e){t._viewer||(t._viewer=new s({viewer:document.createElement("div"),asset:null,defaultTitle:"this.title",typeOfDoc:t._type})),t._viewer.loadAsset({asset:t.viewerTab[e].content,status:t.viewerTab[e].status,doneCB:function(i,s){if(t.viewerTab[e].status.loaded=!0,t.viewerTab[e].thumbnail=s,t.viewerTab[e].thumbIsGenerated=!0,t.viewerTab[e].content.image=i,t.viewerTab[e].content.pageIndex=e,t.inputs.loadCB.done(e),t._loadQueue.length>0){var a=t._loadQueue.shift();r(a.idx)}else t._isGeneratingImage=!1,t._viewer=null}})},a=function(e){t._isGeneratingImage?t._loadQueue.push({idx:e}):(t._isGeneratingImage=!0,r(e))};e.forEach(function(e,i){e.getData(function(e){var s=t._cleanBufferAndParse(e);if(null==s)var r=setInterval(function(){t.sheetInfo&&t.sheetInfo.height&&t.sheetInfo.width&&(s='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="',s+=t.sheetInfo.width,s+='px" height="',s+=t.sheetInfo.height,s+='px" viewBox="0 0 ',s+=t.sheetInfo.width+" "+t.sheetInfo.height,s+='"><image xlink:href="data:image/png;base64,',s+="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",s+='" height="150" width="150" ',s+='x="'+Math.floor(t.sheetInfo.width/2-75)+'"',s+=' y="'+Math.floor(t.sheetInfo.height/2-85)+'"/>',s+="<text ",s+='x="'+Math.floor(t.sheetInfo.width/2)+'"',s+=' y="'+Math.floor(t.sheetInfo.height/2+105)+'"',s+=' text-anchor="middle" textLength="350" lengthAdjust="spacingAndGlyphs" font-family="3ds" font-size="40" fill="#bfbfbf">',s+=o.LoadingErrorSheet,s+="</text>",s+="</svg>",s=t._cleanBufferAndParse(s),s=t._getSVGSheet(s),t.viewerTab[i].content=s,t.viewerTab[i].status={loaded:!0,failed:!0},t.viewerTab[i].format="svg",clearInterval(r),t.viewerTab[i].status.sheetInfo={height:t.sheetInfo.height,width:t.sheetInfo.width},a(i))},200);else{var n=t._getSVGSheet(s);t.viewerTab[i].content=n,t.viewerTab[i].realSizeHeight=n.height,t.viewerTab[i].realSizeWidth=n.width,t.viewerTab[i].status={loaded:!0,failed:!1},t.viewerTab[i].format="svg",t.sheetInfo&&t.sheetInfo.height&&t.sheetInfo.width||(t.sheetInfo={height:n.height,width:n.width}),a(i)}})})},_getSvgFromCATDrawing:function(e,t,i){var s={query:"physicalid:"+e.physicalid,intent:"explore_3D",order_by:"asc",nresults:2,tenant_id:"OnPremise",authored:!0},r=e.serverurl+"/resources/enopad/lwc/fetch",n={headers:{Accept:"application/json","Accept-Language":"en","Content-Type":"application/json",authored:!1,nresults:1,order_by:"asc",tenant_id:"OnPremise"},onComplete:t,onCancel:i,onFailure:i};n.data=JSON.stringify(s),n.method="POST",n.proxy="passport",a.handleRequest(r,n)},_getSvgFromV6Drawing:function(e,t,i){e.dtype="Drawing";var s={method:"POST",authentication:"passport",proxy:"none"},r={label:"3DPlay_"+Date.now(),physicalid:[e.physicalid],select_file:["svg"]},n=e.serverurl+"/cvservlet/fetch/v2?SecurityContext=preferred",h={headers:{"Content-Type":"application/json"},onComplete:function(e){t(e,s)},onCancel:i,onFailure:i};e&&e.requestsOptions&&e.requestsOptions.authentication?h.authentication=e.requestsOptions.authentication:h.proxy=e.requiredAuth,h.data=JSON.stringify(r),h.method="POST";try{a.handleRequest(n,h)}catch(e){console.error("ERROR: WAFData.handleRequest failed. "+e),i()}},generateThumb:function(e,t){if("ie"===h().browser.name)iAssetContent.isEmpty?onDone("../3DPlay2DExperience/assets/images/sheet_failed.png"):t("data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e.asset))));else if(this._viewerThumb||(this._viewerThumb=new s({viewer:document.createElement("div"),asset:null,defaultTitle:"this.title",typeOfDoc:this._type})),this._isGeneratingThumb)this._thumbToUpdate.unshift({content:e,onDone:t});else{this._isGeneratingThumb=!0;var i=this,r=function(e,t){i._viewerThumb.loadAsset({asset:e,doneCB:function(){if(e.isEmpty?t("../3DPlay2DExperience/assets/images/sheet_failed.png"):t(i._viewer.canvas.toDataURL("image/png")),i._thumbToUpdate.length>0){var s=i._thumbToUpdate.shift();r(s.content,s.onDone)}else i._isGeneratingThumb=!1,i._viewerThumb=null}})};r(e,t)}},getSource:function(){return this.rawSVG}})});