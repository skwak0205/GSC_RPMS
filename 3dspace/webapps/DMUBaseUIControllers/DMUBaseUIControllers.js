define("DS/DMUBaseUIControllers/DMUSceneDisplayController",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUCompareVisu/DMUBaseCompareServices","DS/DMUControls/DMUBaseSlider","DS/DMUControls/EXPNotify","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s){"use strict";var d=e.extend({init:function(e){this._parent(e);let d=null,g=e.context,u=r.createSceneGraphOverrideSet(g.getViewer()),c=r.createSceneGraphOverrideSet(g.getViewer()),p=new o(g.getFrameWindow(),{ctxViewer:g});p.setLegendVisibleFlag(!1);let m,f,h,v,D,C,b,M,S,w,y,U,x,E,O=null,P=null,I=this,A=0,R=0,k=50,V="unset",T=!0,F=[],j=!1,N=null,L=null,B=null,W=!1,H=!1,q=!1;function _(e,t){var i,o,a=[];if(e&&e.length)for(i=0;i<e.length;i++)if(e[i]&&e[i].getLastElement){var l=e[i].clone();if(r.isAModelPath(l)){for(;l&&!r.isPLMNode(l.getLastElement(!0));)l=l.getParentPath();l&&l.externalPath.length>1&&(o=r.getIdPath(l),a.push(o))}}else o=e[i].ids?e[i].ids.slice():e[i],a.push(o);if(d&&g&&a.length){var s=n.getReviewContext({viewer:g.getViewer()});if(s&&s.getActiveFlag()){var c=!1,p=s.getCurrentSessionMarkup();if(s&&p&&p.getActiveFlag()&&p.isVisible()&&!s.isReadOnly()&&!p.isReadOnly()){for(i=0;i<a.length;i++)if(a[i][0]===f){var m=p.getOrCreateOccurrenceOverloader({idPath:a[i]},!0);if(!m)continue;var h=r.getOverrides(u,{idPaths:[m.getOccurrenceIDPath()]});h&&1===h.length&&h[0].setVisibility(void 0===t?null:t),t!==m.getAttribute("bVisible")&&(c=!0,m.setAttribute("bVisible",t))}c&&p.fireEvent("onSaveRequested",{}),p.fireEvent("onOccurenceVisibleFlagChanged"),g.getViewer().render()}}}}function z(e,t){h&&(h.destroy(),h=null),h=new l({body:g.getFrameWindow().getUIFrame(),type:e,message:t})}function X(e,n){if(u&&e&&e.length){var i=[],o=[];r.ensurePriorityOfSceneGraphOverrideSet(g.getViewer(),u),e.forEach(function(e){var a=e.target;if(a){var l=a.getOccurrenceIDPath();if(l){var s=r.getOverrides(u,{idPaths:[l]},!0);if(e.state&&a.getActiveFlag()&&a.isVisible()){if(s.length||(s=r.getOverrides(u,{idPaths:[l]})),s&&1===s.length){s=s[0];var d=e.state.bVisible;if(n||void 0!==d){s.setVisibility(void 0===d?null:d);var g=l.slice();!1===d?i.push(g):o.push(g)}if(d=e.state.fOpacity,(n||void 0!==d)&&s.setOpacity(void 0===d?null:d,!0),d=e.state.cColor,(n||void 0!==d)&&s.setColor(d&&d.getHexString?"#"+d.getHexString():null,!0),void 0!==(d=e.state.mTransfoMatrix))s.setPosition(d);else if(void 0!==(d=e.state.mPosition)){if(d){var c=e.target.getOccurrencePathElement(),p=c&&c.getParentPath()?c.getParentPath().getWorldMatrix():null;if(p){var m=(new t.Matrix4).getInverse(p);d=(new t.Matrix4).multiplyMatrices(m,d)}}s.setPosition(d)}}}else s&&1===s.length&&!1===s[0].getVisibility()&&o.push(l),r.removeOverride(u,{idPath:l})}}}),o.length&&(A++,g.getHideShowController().show({idPaths:o,dispatch:!0})),i.length&&(R++,g.getHideShowController().hide({idPaths:i,dispatch:!0})),g.getViewer().render()}}function G(){if(f){var e=g.getHideShowController().getSGOverrideSet();if(e){var t,n=[],i=[],r=[],o=e.getOverrides();for(t=0;t<o.length;t++){let e=o[t].getIdPathes();if(e&&e.length)for(var a=0;a<e.length;a++)e[a].getElement(1)===f&&r.push(e[a])}for(g.getHideShowController().clearOverrides(f),t=0;t<r.length;t++){var l=r[t].buildPathElement(g.getViewer().getIdPathMatcher());l&&(g.getHideShowController().isVisible(l)?i.push(r[t].ids.slice(1,r[t].ids.length)):n.push(r[t].ids.slice(1,r[t].ids.length)))}n.length&&(R++,g.getHideShowController().publish({event:"onHide",data:{paths:n,dispatch:!0}}),g.getHideShowController()._commandProxy&&g.getHideShowController()._commandProxy.hide({paths:n})),i.length&&(A++,g.getHideShowController().publish({event:"onShow",data:{paths:i,dispatch:!0}}),g.getHideShowController()._commandProxy&&g.getHideShowController()._commandProxy.show({paths:i}))}}}function J(e){let t=[],n=[];if(e&&e.getObjectOverloads){if(e.getObjectOverloads()&&e.getObjectOverloads().length){let i=e.getObjectOverloads();for(let e=0;e<i.length;e++){let r=i[e].target.getOccurrenceIDPath();n.push(JSON.stringify(r)),t.push(i[e])}}e.getPointedFormats&&e.getPointedFormats().length&&e.getPointedFormats().forEach(function(e){if(e.getObjectOverloads()&&e.getObjectOverloads().length){let i=e.getObjectOverloads();for(let e=0;e<i.length;e++){let r=i[e].target.getOccurrenceIDPath();n.includes(JSON.stringify(r))||t.push(i[e])}}})}return t}function K(){if(F.length&&(g.getController().unlockNodes({ids:F}),F.length=0),E=!1,C&&C.fireEvent("onComparisonEnded",{dmuObject:C}),p&&p.clean(),v&&v.clean(),c&&c.deleteOverrides(c.getOverrides()),j&&U&&U.setNavBarVisibleFlag(!0),!j&&g&&g.getHideShowController()&&w&&g.getHideShowController().hide({paths:[w],dispatch:!0}),g&&C&&!W&&!H&&j&&M&&M.length){x=null;let e=g.getRoots();for(let t=0;t<e.length;t++)r.getNodeID(e[t])===M[0]&&(e[t].isBeingRemoved=!0);let t=[M[0]];g.getStatusBar()&&g.getStatusBar().clearFilter({ids:t}),g.getController().removeRoots({pids:t},!0,!1)}b=null,M=null,j=!1,C=null,S=null,w=null,v=null}function Z(e){var t=[];return void 0===e&&(t=[1,1]),e>=50?(t.push(1),t.push(1-.02*(e-50))):(t.push(1-.02*(50-e)),t.push(1)),t}function Y(){if(g){let e=n.getReviewContext({viewer:g.getViewer()});if(e&&e.getTransientReviewBag()&&e.getTransientReviewBag().getDMUObjects(j?"DMUCompare2D":"DMUCompare3D").length){W=!1;let t=j;K(),e.getTransientReviewBag().removeDMUObjects(t?"DMUCompare2D":"DMUCompare3D")}}}function Q(e){if(c&&c.deleteOverrides(c.getOverrides()),C&&S&&(void 0===(T=e)&&(T=!0),T)){let e=C.getAttribute("oSelections");if(e&&2===e.length&&e[1].id){let i=C.getParent().getAttribute("oLinksManager");var n=i.getChildWithID(e[1].id);if(n){let e=n.path?i.getOccurrenceIdPath(n.path):n.identifier?[n.identifier]:null;if(e&&1===e.length){let n=S&&S.getParentPath()?S.getParentPath().getWorldMatrix():null;if(n){let i=g.getController().createReferenceIterator(e[0]),o=[];i&&i.isRepRef()?o.push({idPath:e,matrix:new t.Matrix4}):i.getChildren().forEach(function(n){n.getInstanceId&&n.getInstanceId()&&o.push({idPath:[].concat(e).concat(n.getInstanceId()),matrix:n.getMatrix&&n.getMatrix()?n.getMatrix():new t.Matrix4})}),o&&o.length&&o.forEach(e=>{let i=r.getOverrides(c,{idPaths:[e.idPath]});i&&i.length&&i.forEach(i=>{i.setPosition((new t.Matrix4).multiplyMatrices(n,e.matrix))})})}}}}}g.getViewer().render()}function $(){let e=[];if(!j&&b&&b[0]&&M&&M[0]){let t=I.getDisplayedAndHiddenOccurrences(b[0]);t&&t.hidden&&t.hidden.idPaths&&(e=e.concat(t.hidden.idPaths)),(t=I.getDisplayedAndHiddenOccurrences(M[0]))&&t.hidden&&t.hidden.idPaths&&(e=e.concat(t.hidden.idPaths))}return e}function ee(e,t){if(v&&"number"==typeof e){k=e;let n,i=Z(e),o=localStorage.getItem("DMUCompareFirstColor")?"#"+localStorage.getItem("DMUCompareFirstColor"):"#FF0000",a=localStorage.getItem("DMUCompareSecondColor")?"#"+localStorage.getItem("DMUCompareSecondColor"):"#00FF00";n=j?localStorage.getItem("DMUCompare2DCommonColor")?"#"+localStorage.getItem("DMUCompare2DCommonColor"):"#000000":localStorage.getItem("DMUCompare3DCommonColor")?"#"+localStorage.getItem("DMUCompare3DCommonColor"):"#D3D3D3",p.updateCompareModel({Old:{color:a,pathElements:[w],opacity:i[0]},New:{color:o,pathElements:[S],opacity:i[1]},Common:{color:n},compareMode:j?"2D":"3D",noAutomaticReframe:!0,hideAllOtherGeometries:!0,listOfIDPathsToNotOverload:$()}),t&&v.update({leftButton:{color:o},rightButton:{color:a},value:k});let l=r.getOverrides(c,{idPaths:[b,M]});l&&l.length&&l.forEach(e=>{e.setPickability("PICKABLE")}),0!==e&&100!==e||(l=r.getOverrides(c,{idPaths:[100===e?b:M]}))&&l.length&&l.forEach(e=>{e.setPickability("IGNORED")})}}async function te(){if(y=null,!(C&&C.getParent()&&g&&d&&b&&b.length&&M&&M.length))return K();let e=C.getAttribute("oSelections");if(e&&2===e.length){let n=C.getParent().getAttribute("oLinksManager");if(n){if(!(S=n.getOccurrencePathElement(e[0].id)))return h=z("info",s.comparisonFailed),void K();if(!(w=n.getOccurrencePathElement(e[1].id)))return h=z("info",s.comparisonFailed),void K();if(j){let e=C.getAttribute("oSheetIDs");if(e&&e.length&&(B=e[1].id,U)){let e=U.getDocumentData(M[0]);e&&(N=e.sheetNames,L=e.sheetIDList.indexOf(B),U.setCurrentSheet({parentID:M[0],sheet:B}))}}let i=S.getLastElement(!0),o=w.getLastElement(!0),l=[];r.isRepReference(i)&&l.push(i),r.isRepReference(o)&&l.push(o);try{await(t=l,t&&t.length?new Promise((e,n)=>{var i=[],o=[],a=g.getController();t.forEach(function(e){if("cgr"!==a.getLoadedStream(e)){o.push({node:e,stream:"cgr"});let t=r.getNodeID(e);F.includes(t)||i.push(t)}}),i.length?(F=F.concat(i),a.lockNodes({ids:i}),a.setForceReferencesLoad({data:i.map(function(e){return{id:e,state:!0}}),callback:()=>{o.length?a.switchNodeVisuStreamOnDemand({data:o,callbacks:{onComplete:e,onFailure:n}}):e()}})):e()}):Promise.resolve())}catch(e){window.console.error("Error Locking Nodes",e)}finally{let e=[],t=g.getHideShowController();t&&(t.isVisible(S)||e.push(S),t.isVisible(w)||e.push(w),e.length&&t.show({paths:e,dispatch:!0})),j||Q(C.getAttribute("bLocalAxis")),void 0===(k=C.getAttribute("fBalance"))&&(k=50);let n,i=Z(k),r=localStorage.getItem("DMUCompareFirstColor")?"#"+localStorage.getItem("DMUCompareFirstColor"):"#FF0000",o=localStorage.getItem("DMUCompareSecondColor")?"#"+localStorage.getItem("DMUCompareSecondColor"):"#00FF00";n=j?localStorage.getItem("DMUCompare2DCommonColor")?"#"+localStorage.getItem("DMUCompare2DCommonColor"):"#000000":localStorage.getItem("DMUCompare3DCommonColor")?"#"+localStorage.getItem("DMUCompare3DCommonColor"):"#D3D3D3",p.compare({Old:{color:o,pathElements:[w],opacity:i[0]},New:{color:r,pathElements:[S],opacity:i[1]},Common:{color:n},noAutomaticReframe:!0,hideAllOtherGeometries:!0,listOfIDPathsToNotOverload:$(),compareMode:j?"2D":"3D"}),E=!0,C.fireEvent("onComparisonDisplayed",{is2DCompare:j});let l,d,u=[b[b.length-1],M[M.length-1]];"DMUTemporaryBag"===C.getParent().getType()&&(l={icon:s.compareLastButtonTitle,iconClassName:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-close",title:s.compareLastButtonTitle,callBack:Y},S.externalPath.length>2&&(d=[{type:"checkbox",label:s.localAxisTitle,checkFlag:C.getAttribute("bLocalAxis"),callBack:Q}]),j&&N&&N.length>1&&-1!==L&&(d=[{type:"combo",elementList:N,enableSearchFlag:!0,value:N[L],callBack:e=>{if(-1!==(L=N.indexOf(e))){let e=U.getDocumentData(M[0]);if(e&&e.sheetIDList&&e.sheetIDList.length){let t=e.sheetIDList[L];if(U){U.setCurrentSheet({parentID:M[0],sheet:t});let e=C.getAttribute("oSheetIDs");e&&e.length>1&&(e[1].id=t,C.setAttribute("oSheetIDs",e))}}}}}])),v&&v.clean(),(v=new a(g.getFrameWindow())).build({viewerCanvas:g.getViewer().canvas,value:k,minValue:0,maxValue:100,stepValue:5,onChangeCB:ee,leftButton:{color:r},rightButton:{color:o},lastButton:l,subMenuItems:d}),g.getController().getAttributes({ids:u,attributes:["ds6w:label","ds6wg:revision"],callbacks:{onComplete:function(e){let t=e[u[0]]?e[u[0]]["ds6w:label"]:"",n=e[u[0]]?e[u[0]]["ds6wg:revision"]:"";n&&(t=t+" "+n);let i=e[u[0]]?e[u[1]]["ds6w:label"]:"",r=e[u[0]]?e[u[1]]["ds6wg:revision"]:"";r&&(i=i+" "+r),v&&v.update({leftButton:{title:t||""},rightButton:{title:i||""}})},onFailure:function(){}}})}}}var t}function ne(){let e=g.getRoots(),t=[];for(let n=0;n<e.length;n++)t.push(r.getNodeID(e[n]));M&&M.length&&-1!==t.indexOf(M[0])&&(y&&clearTimeout(y),y=setTimeout(te))}function ie(e){let t,n=!0;if(e.slide){var i=e.slide.getDMUObjects();for(let e=0;e<i.length;e++)-1!==i[e].getType().indexOf("DMUCompare")&&(t=i[e]);if(!t&&e.slide.getPointedFormats&&e.slide.getPointedFormats().length){i=e.slide.getPointedFormats()[0].getDMUObjects();for(let e=0;e<i.length;e++)-1!==i[e].getType().indexOf("DMUCompare")&&(t=i[e])}}else t=e.compare;if(t){if(t===C)return!1;let e,i,o,a=t.getParent()?t.getParent().getAttribute("oLinksManager"):null;if(a&&(e=t.getAttribute("oSelections")),e&&2===e.length&&(i=a.getChildWithID(e[1].id)),i&&(o=i.idPath&&i.idPath.length?i.idPath:a.getOccurrenceIdPath(i.path)),o=o&&o.length?o[0]:null){let e=g.getRoots();for(let t=0;t<e.length;t++)r.getNodeID(e[t])===o&&(n=!1)}}return n}function re(){"DIFSheet"===x||"DIFLayout"===x?m&&m.fireEvent("on2DDocumentLoadRequired",{documentType:x,rootID:M[0],isATemporaryRoot:!0}):g.addRoots({objects:[{path:[M[0]]}]})}function oe(e){if(h&&h.destroy(),j&&e===C)return;let t=function(e){let t={};if(!e)return t;var n=e.getAttribute("oSelections");if(!n||2!==n.length)return t;let i=e.getParent()?e.getParent().getAttribute("oLinksManager"):null;if(i){let e=i.getChildWithID(n[0].id);e&&(t.firstCompareRootID=e.idPath&&e.idPath.length?e.idPath:i.getOccurrenceIdPath(e.path)),(e=i.getChildWithID(n[1].id))&&(t.secondCompareRootID=e.idPath&&e.idPath.length?e.idPath:i.getOccurrenceIdPath(e.path))}return t}(e);if(e&&"DMUCompare2D"===e.getType()&&!W&&(W=t&&M&&t.secondCompareRootID&&t.secondCompareRootID[0]&&t.secondCompareRootID[0]===M[0]),K(),!g||!e||!e.getParent()||!e.getType||"DMUCompare3D"!==e.getType()&&"DMUCompare2D"!==e.getType())return;if(j="DMUCompare2D"===(C=e).getType(),C.fireEvent("onComparisonStarted",{is2DCompare:j}),j&&(U||(U=i.getManager({name:"DMU2DSheetManager",context:g.getFrameWindow()})),U.setNavBarVisibleFlag(!1)),!(t&&t.firstCompareRootID&&t.firstCompareRootID.length&&t.secondCompareRootID&&t.secondCompareRootID.length))return h=z("info",s.comparisonFailed),void K();b=t.firstCompareRootID.slice(),M=t.secondCompareRootID.slice();let n=g.getRoots().map(e=>e.isBeingRemoved?"":r.getNodeID(e));n&&-1===n.indexOf(M[0])?(D=g.getAutomaticReframePolicy(),V=window.ENOPADNoReframe,window.ENOPADNoReframe=!0,g.setAutomaticReframePolicy(!1),j&&!x?g.getController().getAttributes({ids:[M[0]],attributes:["ds6w:type"],callbacks:{onComplete:function(e){M&&M.length&&e[M[0]]&&(x=e[M[0]]["ds6w:type"],re())},onFailure:K}}):re()):ne()}this.getCurrentComparedObjectIDPaths=function(){return C?{feature:C,firstObject:b?b.slice():null,secondObject:M?M.slice():null}:null},this.getCurrentCompareBalance=function(){return k},this.getCurrentLocalAxisValue=function(){return T},this.setActiveState=function(e){if(e!==d){var t,i;if(d=e){m=n.giveEventsController({viewer:g.getViewer()}),(P={}).onDMUOverloadPropertiesChanged=m.addEvent("onDMUOverloadPropertiesChanged",function(e){e&&e.overloads&&e.overloads.length&&X(e.overloads)}),P.onDMUObjectDeleted=m.addEvent("onDMUObjectDeleted",function(e){u&&e&&e.dmuObject&&e.dmuObject.getOccurrenceIDPath&&e.dmuObject.getOccurrenceIDPath()?X([{target:e.dmuObject}]):e&&e.dmuObject&&e.dmuObject===C&&K()}),P.onDMUOccOverloadRemoved=m.addEvent("onDMUOccOverloadRemoved",function(e){u&&e&&e.length&&X(e)});var r=function(e){if(e&&e.getOccurrenceOverloaders&&g){var t;if(e.getOccurrenceOverloaders().length&&e.getOccurrenceOverloaders()[0].getOccurrenceIDPath()&&e.getOccurrenceOverloaders()[0].getOccurrenceIDPath().length)t=e.getOccurrenceOverloaders()[0].getOccurrenceIDPath()[0];else{var i=n.getReviewContext({viewer:g.getViewer()});if(i){var r=i.getReviewCtxInformation();r&&r.contextId&&(t=r.contextId)}}f&&t!==f&&G(),g.getController().isFilterOpen(e=>{e&&e.filterAvailable?g.getController().getPrdIdFromFilterId([t]).then(e=>{f&&e!==f&&G(),f=e},()=>{f&&t!==f&&G(),f=t}):(f&&t!==f&&G(),f=t)})}};P.onDMUMarkupLoaded=m.addEvent("onDMUMarkupLoaded",function(e){r(e.dmuObject)}),P.onDMUMarkupCreationSucceeded=m.addEvent("onDMUMarkupCreationSucceeded",function(e){r(e.dmuObject)}),P.onReviewCtxInformationChanged=m.addEvent("onReviewCtxInformationChanged",function(e){e&&e.contextId&&e.contextId!==f&&(G(),g.getController().isFilterOpen(t=>{t&&t.filterAvailable?g.getController().getPrdIdFromFilterId([e.contextId]).then(e=>{f=e},()=>{f&&e.contextId!==f&&G(),f=e.contextId}):f=e.contextId}))});var o=function(e){e&&e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&(e.dmuObject.getActiveFlag()&&e.dmuObject.isVisible()?e.dmuObject.getCurrentSlide()&&(u&&u.deleteOverrides(u.getOverrides()),G(),X(J(e.dmuObject.getCurrentSlide()),!0)):(u&&u.deleteOverrides(u.getOverrides()),G()))};P.onDMUObjectVisibleFlagChanged=m.addEvent("onDMUObjectVisibleFlagChanged",o),P.onDMUObjectActiveFlagChanged=m.addEvent("onDMUObjectActiveFlagChanged",o),P.onDMUSlideOrFormatRefreshRequired=m.addEvent("onDMUSlideOrFormatOverloadsRefreshRequired",function(e){e&&e.dmuObject&&e.dmuObject.getParent()&&e.dmuObject.getParent().isVisible()&&e.dmuObject.getParent().getCurrentSlide&&e.dmuObject.getParent().getCurrentSlide()===e.dmuObject&&(u.deleteOverrides(u.getOverrides()),X(J(e.dmuObject),!0))}),P.onDMUSlideFormatListModified=m.addEvent("onDMUSlideFormatListModified",function(e){e&&e.dmuObject&&e.dmuObject.getParent()&&e.dmuObject.getParent().isVisible()&&e.dmuObject.getParent().getCurrentSlide&&e.dmuObject.getParent().getCurrentSlide()===e.dmuObject&&(u.deleteOverrides(u.getOverrides()),G(),X(J(e.dmuObject),!0))}),P.onDMUSlideStartDisplay=m.addEvent("onDMUSlideStartDisplay",function(e){q=!0,W=!ie({slide:e.dmuObject}),K(),u&&d&&(u.deleteOverrides(u.getOverrides()),G())}),P.onDMUSlideCompareDisplayRequired=m.addEvent("onDMUSlideCompareDisplayRequired",function(e){if(e.dmuObject){let n;var t=e.dmuObject.getDMUObjects();for(let e=0;e<t.length;e++)-1!==t[e].getType().indexOf("DMUCompare")&&(n=t[e]);if(!n&&e.dmuObject.getPointedFormats&&e.dmuObject.getPointedFormats().length){t=e.dmuObject.getPointedFormats()[0].getDMUObjects();for(let e=0;e<t.length;e++)-1!==t[e].getType().indexOf("DMUCompare")&&(n=t[e])}n&&oe(n)}}),P.onDMUSlideDisplayed=m.addEvent("onDMUSlideDisplayed",function(){q=!1}),P.onDMUObjectInitialized=m.addEvent("onDMUObjectInitialized",function(e){e&&e.dmuObject&&e.dmuObject.getParent()&&"DMUTemporaryBag"===e.dmuObject.getParent().getType()&&e.dmuObject.getAttribute("bVisible")&&e.dmuObject.isDisplayed()&&e.dmuObject.isVisible()&&e.dmuObject.getActiveFlag()&&-1!==e.dmuObject.getType().indexOf("Compare")&&(W=!ie({compare:e.dmuObject}),oe(e.dmuObject))}),P.onDMUPreferencesChanged=m.addEvent("onDMUPreferencesChanged",function(e){e&&(e.DMUCompareFirstColor||e.DMUCompareSecondColor||e.DMUCompare3DCommonColor||e.DMUCompare2DCommonColor)&&ee(k,!0)}),P.onDMUAdd2DCompareRoot=m.addEvent("onDMUAdd2DCompareRoot",function(e){e&&e.documentType&&e.compare2DSecondRoot&&g&&("Drawing"===(x=e.documentType)?g.addRoots({objects:[{path:[e.compare2DSecondRoot]}]}):m&&m.fireEvent("on2DDocumentLoadRequired",{documentType:e.documentType,rootID:e.compare2DSecondRoot,isATemporaryRoot:!0}))}),P.on2DDocumentLoadSuccess=m.addEvent("on2DDocumentLoadSuccess",function(){j&&M&&M[0]&&ne()}),P.onDMUCompareRefreshRequired=m.addEvent("onDMUCompareRefreshRequired",function(e){q||e&&e.dmuObject&&(e.dmuObject.getParent()&&("DMUTemporaryBag"===e.dmuObject.getParent().getType()||!e.dmuObject.getParent().isImporting())&&e.dmuObject.getAttribute("bVisible")&&e.dmuObject.isDisplayed()&&e.dmuObject.isVisible()&&e.dmuObject.getActiveFlag()?j||oe(e.dmuObject):C&&C===e.dmuObject&&(W=!1,K()))}),P.onTransientCompareRemoved=m.addEvent("onTransientCompareRemoved",Y),P.onBeginDMUObjectDuplication=m.addEvent("onBeginDMUObjectDuplication",function(){let e=n.getReviewContext({viewer:g.getViewer()});if(e){let t=e.getTransientReviewBag().getDMUObjects("DMUCompare2D");H=!!t.length}else H=!1}),P.onDMUObjectDuplicated=m.addEvent("onDMUObjectDuplicated",function(){H=!1}),(O={}).onHide=g.subscribe({event:"onHide"},function(e){d&&e&&e.paths instanceof Array&&!R&&_(e.paths,!1),R>0&&R--}),O.onShow=g.subscribe({event:"onShow"},function(e){d&&e&&e.paths instanceof Array&&!A&&_(e.paths,!0),A>0&&A--}),O.onExclusiveShow=g.subscribe({event:"onExclusiveShow"},function(){var e=I.getDisplayedAndHiddenOccurrences();e&&(_(e.shown.paths,!0),_(e.shown.idPaths,!0),_(e.hidden.paths,!1),_(e.hidden.idPaths,!1))}),O.onRefreshBegin=g.subscribe({event:"onRefreshBegin"},function(){j&&"Drawing"===x&&sessionStorage.setItem("DMU2DCompareTempRoot",M[0])}),O.onRootAdded=g.subscribe({event:"onRootAdded"},function(e){"unset"!==V&&(window.ENOPADNoReframe=V),V="unset",void 0!==D&&D!==g.getAutomaticReframePolicy()&&g.setAutomaticReframePolicy(D),D=void 0,!j&&e&&M&&e.id===M[0]&&(O.onLoadingComplete=g.subscribe({event:"onLoadingComplete"},function(){if(!M||!M.length)return g.unsubscribe(O.onLoadingComplete),O.onLoadingComplete=null,void K();let e=g.getController().createReferenceIterator(M[0]);e&&(e.isRepRef()||e.getChildren().length)&&(g.unsubscribe(O.onLoadingComplete),O.onLoadingComplete=null,ne())}))}),O.onRootRemoved=g.subscribe({event:"onRootRemoved"},function(e){var t=n.getReviewContext({viewer:g.getViewer()});M&&M[0]===e.id&&C&&"DMUTemporaryBag"===C.getParent().getType()&&t.getTransientReviewBag()&&(t.getTransientReviewBag().removeDMUObjects(j?"DMUCompare2D":"DMUCompare3D"),K())})}else{if(void 0!==D&&D!==g.getAutomaticReframePolicy()&&g.setAutomaticReframePolicy(D),"unset"!==V&&(window.ENOPADNoReframe=V),V="unset",D=void 0,O){for(t=Object.keys(O),i=0;i<t.length;i++)g.unsubscribe(O[t[i]]);O=null}if(m&&P){for(t=Object.keys(P),i=0;i<t.length;i++)m.removeEvent(P[t[i]]);P=null}u.deleteOverrides(u.getOverrides()),G(),K(),m=null,h&&(h.destroy(),h=null)}A=0,R=0}},this.getDisplayedAndHiddenOccurrences=function(e){let t=e||f;var n,i={shown:{idPaths:[],paths:[]},hidden:{idPaths:[],paths:[]}};if(g&&d){var o=g.getHideShowController().getSGOverrideSet();if(o)for(var a=o.getOverrides(),l=0;l<a.length;l++)if(null!==a[l].getVisibility())if(n=a[l].getVisibility()?i.shown:i.hidden,a[l].isIdPathOverride()){let e=a[l].getIdPathes()||[];e=e.map(e=>e.ids.slice(1,e.ids.length)),n.idPaths=n.idPaths.concat(e.filter(e=>e[0]===t))}else n.paths=n.paths.concat(a[l].getPathes().filter(e=>r.getNodeID(e.externalPath[1])===t))}return i},this.isAComparisonDisplayed=(()=>E),this.toggleVisibility=function(e){if(e&&e.length&&d&&g&&g.getHideShowController()){var t=g.getHideShowController(),n=[],i=[];if(e.forEach(function(e){t.isVisible(e)?n.push(e):i.push(e)}),n.length)return void t.hide({paths:n,dispatch:!0});i.length&&t.show({paths:i,dispatch:!0})}},this.clear=function(){this.setActiveState(!1),g&&u&&r.removeSceneGraphOverrideSet(g.getViewer(),u),g&&c&&r.removeSceneGraphOverrideSet(g.getViewer(),c),g=u=c=p=null}}}),g=[];return e.singleton({init:function(){},getDMUSceneDisplayController:function(e){if(e&&e.context){for(var t=!1,n=0;n<g.length;n++)if(g[n].context===e.context){g[n].counter++,t=!0;break}if(!t){var i=new d(e);i.setActiveState(!0),g.push({counter:1,context:e.context,ctrl:i})}return this.giveDMUSceneDisplayController(e)}},giveDMUSceneDisplayController:function(e){if(e&&e.context){for(var t,n=0;n<g.length;n++)if(g[n].context===e.context){t=g[n].ctrl;break}if(t)return Object.freeze({isAComparisonDisplayed:function(){return t?t.isAComparisonDisplayed():null},getCurrentComparedObjectIDPaths:function(){return t?t.getCurrentComparedObjectIDPaths():null},getCurrentCompareBalance:function(){return t?t.getCurrentCompareBalance():[]},getCurrentLocalAxisValue:function(){return!t||t.getCurrentLocalAxisValue()},getDisplayedAndHiddenOccurrences:function(e){return t?t.getDisplayedAndHiddenOccurrences(e):{}},toggleVisibility:function(e){return t?t.toggleVisibility(e):{}}})}},unreferenceDMUSceneDisplayController:function(e){if(e&&e.context)for(var t=0;t<g.length;t++)if(g[t].context===e.context)return g[t].counter--,void(g[t].counter<=0&&(g[t].ctrl&&g[t].ctrl.clear(),g.splice(t,1)))}})}),define("DS/DMUBaseUIControllers/DMUCommentsController",["require","exports","DS/CATWebUXComponents/CATWebUXPanel","DS/ApplicationFrame/CommandsManager","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/EXPManagerSet","DS/CATWebUXComponents/CATWebUXComment","DS/DMUControls/EXPNotify","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/CoreEvents/Events","UWA/Core","UWA/Utils","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseUI/DMUToolsUsers","DS/WebappsUtils/WebappsUtils","DS/DMUControls/panels/DMUCommentsPanel","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,g,u,c,p,m,f,h,v,D,C,b,M){"use strict";class S{constructor(e){let t,S,w,y,U,x,E,O,P,I,A,R,k,V,T,F,j=this,N=new Map,L=e.context,B=!1,W=!0,H=!1,q=!0,_=!0,z=!0,X={},G=!1,J=s.getContextViewer({viewer:L.getViewer()}),K=s.giveEventsController({viewer:L.getViewer()}),Z=o.getManager({name:"DMU2DSheetManager",context:L}),Y=!0,Q=[];function $(e){if(e.flag===z)return;let n,i=d.get();for(n=i.length-1;n>=0;n--)i[n].pathElement.getLastElement(!0).getDMUType&&d.remove(i[n]);for(n=(i=g.get()).length-1;n>=0;n--)i[n].pathElement.getLastElement(!0).getDMUType&&g.remove(i[n]);let r=s.getReviewContext({viewer:L.getViewer()});r&&(r.getTransientReviewBag().removeDMUObjects(),z=e.flag,r.getUIManager().setMarkupVisualizationActiveState(z),j.setGuidelineVisibility(e.flag),t&&t.setCurrentMarkup(e.flag?T:null))}function ee(){z||(t&&t.restoreCommentSelection(),$({flag:!z}),t&&t.setReviewVisuCheckFlag(!0))}function te(){t&&t.resetCommentDisplayHistory(),U&&U.destroy(),U=new l({body:L.getUIFrame(),type:"info",message:M.resetDisplayHistoryLabel}),d.empty(),g.empty()}function ne(){let t=[],n=s.getReviewContext({viewer:L.getViewer()});if(!(n?n.getCurrentSessionMarkup():null))return t;if(B)t.push({id:"DMUResetDisplayHistory",type:"button",nls:M.resetDisplayHistoryLabel,icon:C.getWebappsAssetUrl("DMUControls","icons/22/I_ResetDisplayHistoryCmd.png"),cb:te});else{let n=i.getCommand("DMUEditPropertiesHdr",e.commandContext);n&&t.push({id:"DMUEditProperties",type:"button",nls:M.launchEditProperties,icon:C.getWebappsAssetUrl("DMUControls","icons/22/")+"I_DMUEditProperties.png",cb:function(){ee(),(n=i.getCommand("DMUEditPropertiesHdr",e.commandContext))&&n.begin()}}),(n=i.getCommand("DMUExportReviewAsPdfHdr",e.commandContext))&&t.push({id:"DMUExportReviewAsPdf",type:"button",nls:M.launchExportAsPDF,icon:C.getWebappsAssetUrl("DMUPersistence","icons/32/")+"I_DMUExportAsPDF.png",cb:function(){(n=i.getCommand("DMUExportReviewAsPdfHdr",e.commandContext))&&n.begin()}})}return t}function ie(){let t=s.getReviewContext({viewer:L.getViewer()}),n=t?t.getCurrentSessionMarkup():null,r=[];return r.push({id:"nextButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-chevron-right",title:M.nextComment,cb:function(){i.getCommand("DMUNextCommentCmdHdr",e.commandContext).begin()}}),r.push({id:"previousButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-chevron-left",title:M.previousComment,cb:function(){i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext).begin()}}),n&&!B&&(r.push({id:"switchReviewVisibilityBtn",checkFlag:!0,type:"switch",title:M.switchMarkupVisibility,cb:function(e){$({flag:e.dsModel.checkFlag}),S&&S.isSmallWidth()&&S.collapsePanel()}}),r.push({id:"newCommentButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-plus",title:M.newComment,cb:function(){let t=i.getCommand("DMUCommentCmdHdr",e.commandContext);t.isRunning()?t.end():t.begin(),S&&S.isSmallWidth()&&S.collapsePanel()}})),r}function re(){!I&&t&&(I=setInterval(function(){if(t){if(!L)return I&&clearInterval(I),void(I=null);if(S&&J&&J.getRootBagPath().getChildrenPathes().length){let n=i.getCommand("DMUNextCommentCmdHdr",e.commandContext);if(n&&Z&&Z.isADocumentDisplayed()&&!Z.isRunning()){I&&clearInterval(I),I=null;let r=s.getReviewContext({viewer:L.getViewer()}),o=M.commentsPanelTitle,a=r?r.getValidation():null;if(a)o=a.getName();else{let e=r?r.getCurrentSessionMarkup():null;e&&(o=e.getAttribute("sName"))}t.updatePanelHeader({panelTitle:o,contextualCmdList:ne(),quickAccessBtnList:ie(),headerDrag:Boolean(P)}),n=i.getCommand("DMUNextCommentCmdHdr",e.commandContext),t.updatePanelHeader({quickAccessBtnAvailability:{flag:n&&n.isEnabled(),id:"nextButton"}}),n=i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext),t.updatePanelHeader({quickAccessBtnAvailability:{flag:n&&n.isEnabled(),id:"previousButton"}})}}}},500))}function oe(e){if(e){let t=s.getReviewContext({viewer:L.getViewer()}),n=t?t.getValidation():null;if(n){let t=n.getMarkups();if(t){let n=t.find(t=>{let n=t.getRepRef();if(n){if(n.getMarkupContent()===e)return!0;let i=t.getReplies();return i&&i.find(t=>{let n=t.getRepRef();return n&&n.getMarkupContent()===e})}});if(n)return{id:n.getRepRef().getPlmID(),name:n.getName()}}}}return{id:"default"}}function ae(e){if(!t)return;if(t.restoreCommentPreSelection(),!e||!e.length)return;e.forEach(e=>{if(!t)return;let n=N.get(e);if(n){if(F&&F.has(n.uuid)){let e=F.get(n.uuid);e&&e.forEach(e=>{n&&e.updateDate(D.formatDate(n.dateInMs))})}t.preSelectComment(n.uuid),function(e){if(e){let t=r.buildPathElement(e.getNode());u.add({pathElement:t})}}(n.parentObject)}}),q=!0}function le(e){if(ee(),e&&e!==T){T=e;let t=s.getReviewContext({viewer:L.getViewer()});if(t){t.getTransientReviewBag().removeDMUObjects();let e=t?t.getValidation():null;e&&e.setCurrentMarkup(e.getRepRef(T))}}}function se(e){if(!e)return;if(e.isReply()&&V){let t=e.getAttribute("sParentCommentId");const n=N.get(t);return n?n.dmuObject:void 0}let t=e.getNode().getParents();if(!t||!t.length)return;let n=s.getReviewContext({viewer:L.getViewer()}),i=r.buildPathElement(t[0]);return n.getDMUObjectFromPathElement(i)}function de(e,n){if(!R||!k||G||!S.getContentVisibleState()||!z||!J.getViewer().getVisibleSpace())return;if(!(e&&e.length||n&&n.length))return void R.setStyle("display","none");"none"===R.getStyle("display")&&R.setStyle("display","block");let i=function(e){var n;if(!t)return;const i="string"==typeof e?N.get(e):N.get(e.getAttribute("sUuid"));if(i&&!i.hasAlertFlag()&&(!i.parentObject.hasAttribute("bVisible")||i.parentObject.getAttribute("bVisible"))){let e=Z.getElementMatrix("Document"===Z.getDocumentType()?i.pointedPage:null===(n=i.pointedElement)||void 0===n?void 0:n.id),r=v.getViewerPositionFromPoint(J.getViewer(),i.pointedPosition.clone().applyMatrix4(e));if(r){let e=S.getAbsolutePosition().x<r.left,n=t.getDivPositionFrom(i.uuid,J.getViewer().canvas,e);k&&(k.moveTo(r.left,r.top),k.lineTo(n.x+(e?45:-45),r.top),k.lineTo(n.x+(e?-10:-20),n.y),k.lineTo(n.x+(e?-25:-7),n.y))}}};k.clearRect(0,0,R.width,R.height),e&&e.length&&(k.setLineDash([]),k.strokeStyle="#368EC4",k.beginPath(),e.forEach(i),k.stroke()),n&&n.length&&(k.setLineDash([5,5]),k.strokeStyle="#78BEFA",k.beginPath(),n.forEach(i),k.stroke())}function ge(){let e=u.get(),t=[],n=s.getReviewContext({viewer:L.getViewer()});for(let i=0;i<e.length;i++){if(!e[i].pathElement)continue;let r;if(n&&(r=n.getDMUObjectFromPathElement(e[i].pathElement)),r||(r=j.getDMUObjectFromPathElement(e[i].pathElement)),r){if("DMUComment"!==r.getType()||r.isReply()&&V){if(r.getDMUComments&&q){let e=r.getDMUComments();t=t.concat(e.map(e=>e.getAttribute("sUuid")))}}else t.push(r.getAttribute("sUuid"))}}de(A,t),ae(t)}function ue(){let e=d.get();A||(A=[]),A.length=0;let n=s.getReviewContext({viewer:L.getViewer()});for(let t=0;t<e.length;t++){let i;if(n&&(i=n.getDMUObjectFromPathElement(e[t].pathElement)),i||(i=j.getDMUObjectFromPathElement(e[t].pathElement)),i){if("DMUComment"===i.getType())A.push(i);else if(i.getDMUComments){let e=i.getDMUComments();A=A.concat(e),Z.fireCrossWidgetSelection(i.getAttribute("sPointedElementID"))}}}de(A),function(e){if(!t)return;if(t.restoreCommentSelection(),!e||!e.length)return;x=null;let n=function(e){if(e){let t=r.buildPathElement(e.getNode());d.isIn({pathElement:t})||g.add({pathElement:t})}};e.forEach(e=>{var i;if(e.isReply()&&V){let i=e.getAttribute("sParentCommentId");const r=N.get(i);if(r&&r.replies&&t){const i=r.replies.find(t=>t.dmuObject===e);i&&(t.selectReply(i.uuid,r.uuid),x=r.uuid,n(r.parentObject))}}else{const r=N.get(e.getAttribute("sUuid"));if(r){let e;if(W&&S){let t=Z.getElementMatrix("Document"===Z.getDocumentType()?r.pointedPage:null===(i=r.pointedElement)||void 0===i?void 0:i.id),n=v.getViewerPositionFromPoint(J.getViewer(),r.pointedPosition.clone().applyMatrix4(t));n&&(e=n.top-S.getAbsolutePosition().y)}t&&t.selectComment(r.uuid,e,H),H=!1,x=r.uuid,n(r.parentObject)}}})}(A)}function ce(e,t){let n,i=e.isReply()&&V;if(t=t||se(e),!i){let t=function(e){let t=s.getReviewContext({viewer:L.getViewer()}),n=t?t.getValidation():null;if(!n)return;let i=[];return n.getAllRepRefs().forEach(t=>{let n=t.getMarkupContent();if(n){let t=n.getComments();t&&t.forEach(t=>{t.getAttribute("sParentCommentId")===e&&i.push(t)})}}),i}(e.getAttribute("sUuid")||"");t&&t.length&&(n=[],t.forEach(function(t){let i=ce(t,e);i.uuid&&n.push(i)}))}let r=t?Z.getElementInfo(t.getAttribute("sPointedElementID")):null;const o=oe(e.getParent());return{parentObject:t,markupId:e.isExternal()?"externalCommentsBag":o.id,markupName:e.isExternal()?void 0:o.name,dmuObject:e,uuid:e.getAttribute("sUuid")||"",isReply:i,owner:{login:e.getAttribute("sOwner")||""},dateInMs:e.getAttribute("fLastModificationDate")||0,replies:n,content:function(e){if(!Array.isArray(e)||!e.length)return"";let t="";for(let n=0;n<e.length;n++)t+=e[n],n<e.length-1&&(t+="\n");return t}(e.getAttribute("sTextContents")),isReadOnly:e.isReadOnly,isExternal:e.isExternal(),hasAlertFlag:e.hasAlertFlag,pointedPage:t?t.getAttribute("fPointedPageNumber"):void 0,pointedElement:t&&t.getAttribute("sPointedElementID")?{id:t.getAttribute("sPointedElementID"),title:r?r.title:null,index:r?r.index:null}:void 0,pointedPosition:t&&t.getPointedPosition?t.getPointedPosition():void 0}}function pe(){Q.length&&Q.sort(function(e,t){const n=N.get(e),i=N.get(t);return n?i?n.pointedElement&&i.pointedElement?n.pointedElement.index<i.pointedElement.index?-1:n.pointedElement.index>i.pointedElement.index?1:0:void 0===n.pointedPage?-1:void 0===i.pointedPage?1:n.pointedPage<i.pointedPage?-1:n.pointedPage>i.pointedPage?1:n.pointedPosition?i.pointedPosition?n.pointedPosition.y>i.pointedPosition.y?-1:n.pointedPosition.y<i.pointedPosition.y?1:0:1:-1:1:-1})}function me(){if(!t)return;let n=i.getCommand("DMUNextCommentCmdHdr",e.commandContext),r=i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext);N&&0!==N.size?(n&&!n.isEnabled()&&(t.updatePanelHeader({quickAccessBtnAvailability:{flag:!0,id:"nextButton"}}),n.enable()),r&&!r.isEnabled()&&(t.updatePanelHeader({quickAccessBtnAvailability:{flag:!0,id:"previousButton"}}),r.enable())):(n&&n.isEnabled()&&(t.updatePanelHeader({quickAccessBtnAvailability:{flag:!1,id:"nextButton"}}),n.disable()),r&&r.isEnabled()&&(t.updatePanelHeader({quickAccessBtnAvailability:{flag:!1,id:"previousButton"}}),r.disable()))}function fe(e,n){if(e.isTemporary()||!t)return;S.ensureVisible(),ee();let i=s.getReviewContext({viewer:L.getViewer()});if(e&&(e.isExternal()||i&&i.getCurrentSessionMarkup())&&!N.has(e.getAttribute("sUuid"))){let i=ce(e,n);i.uuid&&(Q.push(i.uuid),t.addComment(i),N.set(e.getAttribute("sUuid"),i),pe(),me())}}function he(e,n,i){var r;if(N&&t){let o=i||ce(e,n);const a=N.get(e.getAttribute("sUuid"));if(a){let e=Object.keys(o),n=!1;for(let t=0;t<e.length;t++){const i=e[t],l=o[i];l?("pointedPage"===i&&l!==a[i]?n=!0:"pointedElement"===i&&l.id!==(null===(r=a[i])||void 0===r?void 0:r.id)?n=!0:"pointedPosition"===i&&l&&a[i]&&!l.equals(a[i])&&(n=!0),"owner"===i?a[i].login=l.login:a[i]=l):"highlightData"===i&&(a[i]=void 0)}F&&(F.has(a.uuid)&&F.get(a.uuid).forEach(e=>e.update(a)),F.has(a.uuid+"-tooltip")&&F.get(a.uuid+"-tooltip").update(a)),t.updateComment(a),n&&pe()}}}function ve(e,n){ee();let i=s.getReviewContext({viewer:L.getViewer()});if(!(i&&i&&i.getCurrentSessionMarkup()&&e))return;const r=N.get(n.getAttribute("sUuid"));if(r&&t){let i=ce(e,n);if(i.uuid){if(-1===(r.replies?r.replies.findIndex(function(e){return e.uuid===i.uuid}):-1)){t.addReply(i,r.uuid);let e=r.replies||[];e.push(i),r.replies=e}}}}function De(e,n){ee(),d.empty();let i=s.getReviewContext({viewer:L.getViewer()}),o=i?i.getCurrentSessionMarkup():null;if(!i||!e||!o)return;let a=n||se(e);if(a){const n=N.get(a.getAttribute("sUuid"));if(n&&n&&n.replies&&n.replies.length){let i=n.replies.findIndex(function(t){return t.dmuObject===e});if(i>=0){t&&t.removeReply(n.replies[i].uuid,n.uuid),n.replies.splice(i,1),e.getParent().removeComment(e);let o=r.buildPathElement(n.dmuObject.getNode());d.add({pathElement:o})}}}}function Ce(e){if(!e||!e.target||!e.target.dmuObject)return;ee(),W=!1,H=!0;let t=r.buildPathElement(e.target.dmuObject.getNode());d.empty(),d.add({pathElement:t}),Z.centerViewpointAtElementPosition({elementID:(e.target.pointedElement?e.target.pointedElement.id:null)||e.target.pointedPage,position:e.target.pointedPosition,offsetYPix:0})}function be(e){if(!e||!e.target||!e.target.dmuObject)return;let t=e.target.isReply?null:r.buildPathElement(e.target.dmuObject.getNode());u.empty(),t&&e.prehighlightedFlag&&(q=!1,u.add({pathElement:t}))}function Me(e){if(!e||!e.target||!e.target.dmuObject)return;ee(),W=!1;let t=!0;if(e.selected){let n=r.buildPathElement(e.target.dmuObject.getNode());if(e.event.from[0].event.ctrlKey)if(d.isIn({pathElement:n})){if(e.target.parentObject){let t=r.buildPathElement(e.target.parentObject.getNode());g.remove({pathElement:t})}d.remove({pathElement:n}),t=!1}else d.add({pathElement:n});else d.empty(),g.empty(),d.add({pathElement:n})}let n=J.getViewer();if(n.getVisibleSpace()||(n.swapVisibleSpace(),n.render()),t&&e.target.pointedPosition){let t=e.div.getPosition(n.canvas);Z.centerViewpointAtElementPosition({elementID:(e.target.pointedElement?e.target.pointedElement.id:null)||e.target.pointedPage,position:e.target.pointedPosition,offsetYPix:n.SCREEN_HEIGHT/2-t.y-30})}e.selected&&!e.isEnableEdition&&S.isSmallWidth()&&S.collapsePanel()}function Se(e){if(e&&e.target&&e.target.dmuObject){let t=e.value.split(/(?:\r\n|\r|\n)/g);const n=e.target.dmuObject.getAttribute("sTextContents");Array.isArray(n)&&n.length===t.length&&!n.some((e,n)=>e!==t[n])||(t.find(e=>e)&&e.target.dmuObject.setAttributes([{name:"sTextContents",value:e.value.split(/(?:\r\n|\r|\n)/g)},{name:"fLastModificationDate",value:Date.now()}]),e.target.dmuObject.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:e.target.dmuObject}),S&&S.isSmallWidth()&&S.collapsePanel())}}function we(t){if(t&&t.target&&t.target.dmuObject){let n=r.buildPathElement(t.target.isReply?t.target.parentObject.getNode():t.target.dmuObject.getNode());d.empty(),W=!1,d.add({pathElement:n});let o=i.getCommand("DMUReplyCmdHdr",e.commandContext);o&&o.begin()}}function ye(e){if(!e||!e.target.dmuObject)return;let t=r.buildPathElement(e.target.dmuObject.getNode());e.shiftKeyPressed||e.ctrlKeyPressed||(d.empty(),g.empty()),W=!1,d.add({pathElement:t}),L.getContextualUIManager()._showContextualMenu(e.position.clone())}function Ue(e){if(!R||!k)return;let t=e.eventType||e.event||e.type;"scroll"!==t&&"@onViewpointBeginMove"!==t||k.clearRect(0,0,R.width,R.height),"scroll"!==t&&"@onViewpointEndMove"!==t||de(A)}function xe(e){if("freeZoneResize"!==e.type&&"move"!==e.type&&R){let e=L.getViewerFrame().getDimensions();R.width=e.width,R.height=e.height}de(A)}function Ee(t){let n;s.getReviewContext({viewer:L.getViewer()})&&(!t.target||"textarea"!==t.target.type&&"input"!==t.target.type&&"P"!==t.target.tagName)&&(!t.ctrlKey||"ArrowRight"!==t.key&&39!==t.keyCode?!t.ctrlKey||"ArrowLeft"!==t.key&&37!==t.keyCode||(n=i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext))&&n.isEnabled()&&n.begin():(n=i.getCommand("DMUNextCommentCmdHdr",e.commandContext))&&n.isEnabled()&&n.begin())}function Oe(e){let t=s.getReviewContext({viewer:L.getViewer()});if(!t)return;let n=t.getValidation();n&&n.getMarkups().some(t=>{let n=t.getRepRef();if(n.getPlmID&&n.getPlmID()===e.id)return K&&K.fireEvent("onValidationObjectAttributesModificationRequest",{dmuObject:n,attr:{key:"name",value:e.title}}),!0})}function Pe(e){let t=s.getReviewContext({viewer:L.getViewer()}),n=t?t.getValidation():null;if(n){let t=n.getMarkups().find(t=>{let n=t.getRepRef();return n.getPlmID&&n.getPlmID()===e.id}).getRepRef().getMarkupContent();if(t){let n=r.buildPathElement(t.getNode());d.empty(),g.empty(),d.add({pathElement:n}),u.add({pathElement:n}),L.getContextualUIManager()._showContextualMenu(e.position.clone())}}}function Ie(e){j.setGuidelineVisibility(e.dsModel.contentVisibleState)}function Ae(){if(!_)return;if(t||(t=new b,w={onCommentSelected:t.subscribe("onCommentSelected",Me),onCommentEditionEnd:t.subscribe("onCommentEditionEnd",Se),onCommentReply:t.subscribe("onCommentReply",we),onCommentCtxMenuRequired:t.subscribe("onCommentCtxMenuRequired",ye),onCommentPreselected:t.subscribe("onCommentPreselected",be),onPanelScroll:t.subscribe("onPanelScroll",Ue),onMarkupRenamed:t.subscribe("onMarkupRenamed",Oe),onSetCurrentMarkup:t.subscribe("onSetCurrentMarkup",le),onMarkupCtxMenuRequired:t.subscribe("onMarkupCtxMenuRequired",Pe),onNewCommentCreated:t.subscribe("onNewCommentCreated",()=>{let t=i.getCommand("DMUCommentCmdHdr",e.commandContext);t&&(t.isRunning()?t.end():t.begin(),S&&S.isSmallWidth()&&S.collapsePanel())})},(y={}).onPSOEmpty=u.onEmpty(ge),y.onPSORemove=u.onRemove(ge),y.onPSOAdd=u.onAdd(ge),y.onCSOEmpty=d.onEmpty(ue),y.onCSORemove=d.onRemove(ue),y.onCSOAdd=d.onAdd(ue),t.setReadOnlyFlag(B)),!S){let e=s.getReviewContext({viewer:L.getViewer()}),i=M.commentsPanelTitle,r=e?e.getValidation():null;if(r)i=r.getName();else{let t=e?e.getCurrentSessionMarkup():null;t&&(i=t.getAttribute("sName"))}let o=t.buildPanel({allowReplies:Boolean(e&&e.getValidation()),panelTitle:i,contextualCmdList:ne(),quickAccessBtnList:ie()});P&&t.setDragContent(P),re();let a=300,l=160,d=250;S=new n({id:"DMUCommentsPanel",className:"DMUCommentsPanel",showTitleFlag:!1,autoCloseFlag:!1,closeButtonFlag:!1,icon:"fonticon wux-ui-3ds-comment",immersiveFrame:L.getImmersiveFrame(),viewerFrame:L.getViewerFrame(),content:o,minWidth:d,width:a,minHeight:l,height:l,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.RightDockArea}),j.setVisibleFlag(Y),!Z||!Z.isRunning()&&Z.isADocumentDisplayed()||S.setEnableFlag(!1)}let r=L.getUIFrame();if(r){R=new f.Element("canvas",{id:"DMUCommentGidelineCanvas",styles:{height:"100%",width:"100%",pointerEvents:"none",float:"left"}}).inject(r);let e=L.getViewerFrame(),t=e.getDimensions();R&&(R.width=t.width,R.height=t.height,k=R.getContext("2d")),e.addEvent("resize",xe),L.getImmersiveFrame().addEventListener("freeZoneResize",xe)}O=m.subscribe({event:"/VISU/"},Ue),S.addEventListener("move",xe),S.addEventListener("contentVisibleStateChange",Ie),document.addEventListener("keyup",Ee)}function Re(){let e=s.getReviewContext({viewer:L.getViewer()}),t=e?e.getCurrentSessionMarkup():null;if(t&&!t.isReadOnly()){let e=o.getManager({name:"DMUUserExperienceManager",context:L});e&&(e.registerContextualBar({type:"DMUMarker",module:"DMUMarker",workbenchName:"DMUMarkerContextHdr"}),e.registerContextualMenu({type:"DMUMarker",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"}))}}if(K){let e=function(e){e&&e.reviewId&&e.reviewType&&e.reviewName&&(P=JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:c.getPlatformId(),serviceId:"3DSpace",contextId:p.getSetting("pad_security_ctx")?p.getSetting("pad_security_ctx"):void 0,objectId:e.reviewId,objectType:e.reviewType,displayName:e.reviewName}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}),t&&t.setDragContent(P))},n=s.getReviewContext({viewer:L.getViewer()});n&&e(n.getReviewCtxInformation()),X.onReviewCtxInformationChanged=K.addEvent("onReviewCtxInformationChanged",e),X.onDMUObjectActiveFlagChanged=K.addEvent("onDMUObjectActiveFlagChanged",function(e){!((n=s.getReviewContext({viewer:L.getViewer()}))&&t&&e)||e&&!e.dmuObject||e&&e.dmuObject&&!e.dmuObject.isVisible()||n.getValidation()||"DMUMarkup"!==e.dmuObject.getType()||ee()}),X.onDMUCommentEditionRequired=K.addEvent("onDMUCommentEditionRequired",function(e){e&&e.dmuObject&&"DMUComment"===e.dmuObject.getType()&&function(e,n){if(!t)return;let i=0;N.size||(i=500),setTimeout(()=>{t&&t.enableContentEdition(e.getAttribute("sUuid"),n?n.getAttribute("sUuid"):void 0)},i)}(e.dmuObject,e.parentObject)}),X.onDMUObjectInitialized=K.addEvent("onDMUObjectInitialized",function(e){let n=s.getReviewContext({viewer:L.getViewer()}),i=n?n.getCurrentSessionMarkup():null;if(e&&e.dmuObject){let n=e.dmuObject.getType();i?"DMUComment"===n?e.dmuObject.isReply()&&V?ve(e.dmuObject,e.parentObject):(t||Ae(),fe(e.dmuObject,null),de(A)):"DMUMarkup"!==n&&"ReviewMarkup"!==n||(Re(),t&&re()):"DMUValidationValidation"===n&&re()}}),X.onCurrentSessionMarkupChanged=K.addEvent("onCurrentSessionMarkupChanged",function(e){let n=s.getReviewContext({viewer:L.getViewer()});if(V=Boolean(n&&n.getValidation()),e&&e.currentMarkup){let i=oe(e.currentMarkup).id;if(T=i,n&&!n.getValidation()){let n=e.currentMarkup.getSlides()[0];if(n){n.getDMUObjects().filter(function(e){return e.getDMUComments&&e.getDMUComments().length}).forEach(function(e){e.getDMUComments().forEach(function(n){t||Ae(),fe(n,e)})}),de(A),t&&re()}}t&&(t.setCurrentMarkup(T),t.setAllowReplies(Boolean(n&&n.getValidation())))}}),X.onDMUObjectVisuRefreshRequired=K.addEvent("onDMUObjectVisuRefreshRequired",function(e){if(e&&e.dmuObject){let n=e.dmuObject.getType();if("DMUSlide"===n&&(E&&E.forEach(function(e){e.refreshNode()}),L.getViewer().render()),"DMUComment"===n)e.dmuObject.isReply()&&V?function(e,n,i){if(!N||!e)return;let r=n||se(e),o=i||ce(e,r);if(r&&o){const n=N.get(r.getAttribute("sUuid"));if(n&&n.replies&&t&&n.replies){let i=n.replies.find(t=>t.dmuObject===e),r=Object.keys(o);for(let e=0;e<r.length;e++)o[r[e]]&&(i[r[e]]=o[r[e]]);F&&F.has(i.uuid+"-tooltip")&&F.get(i.uuid+"-tooltip").update(i),t.updateComment(n)}}}(e.dmuObject):he(e.dmuObject);else if(e.dmuObject.getDMUComments){e.dmuObject.getDMUComments().forEach(function(t){he(t,e.dmuObject)})}}}),X.onDMUObjectsVisuRefreshRequired=K.addEvent("onDMUObjectsVisuRefreshRequired",function(){let e=s.getReviewContext({viewer:L.getViewer()}),t=e?e.getVisibleMarkups():null;if(t){t.map(e=>e.getCurrentSlide()).forEach(e=>{e&&e.refreshNode()})}E&&E.forEach(function(e){e.refreshNode()}),L.getViewer().render()}),X.onDMUObjectDeleted=K.addEvent("onDMUObjectDeleted",function(e){if(e&&e.dmuObject){let n=e.dmuObject.getType();if("DMUComment"===n)e.dmuObject.isReply()&&V?De(e.dmuObject):j.removeComment(e.dmuObject);else if("DMUMarkup"===n&&t){let n=oe(e.dmuObject).id;t.removeMarkup(n),me()}}}),X.onCurrentElementChanged=K.addEvent("onCurrentElementChanged",function(e){e&&e.currentElement&&t&&(W&&t.scrollPanelToContainer(e.currentElement),e.endMove&&(W=!0))}),X.onDMUObjectReadOnlyFlagChanged=K.addEvent("onDMUObjectReadOnlyFlagChanged",function(e){var n;e&&e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&((n=e.dmuObject.isReadOnly())!==B&&(B=n,ee(),re(),t&&(t.resetCommentDisplayHistory(),t.setReadOnlyFlag(n))))}),X.on2DDocumentLoadSuccess=K.addEvent("on2DDocumentLoadSuccess",()=>{E&&E.length||function(){if(Re(),Z.isADocumentDisplayed()&&"Document"===Z.getDocumentType()){let e=Z?Z.getExternalComments():null;if(e&&e.length){let n=["DS/DMUPlayComment/DMUComment","DS/DMUPlayMarker/DMUCommentHighlight"];window.require(n,function(n,i){let r;E||(E=[]),t||Ae();let o=L.getViewer().getNodes();for(let e=0;e<o.length;e++)if("DecorationBag"===o[e].name){r=o[e];break}e.forEach(function(e){let t=new n(J.getViewer(),null,!0);t.setAttributes([{name:"sUuid",value:h.getUUID()},{name:"sOwner",value:e.owner.name},{name:"sTextContents",value:e.content}]);let o=new i(J.getViewer(),null,!0);o.setAttributes([{name:"sUuid",value:h.getUUID()},{name:"vPosition",value:e.pointedPosition},{name:"fPointedPageNumber",value:e.pointedPage},{name:"oSelection",value:[{page:e.pointedPage,rects:[e.rect]}]}]),o.addDMUComment(t),fe(t,o),r&&r.addChild(o.getNode()),E&&E.push(o),o.refreshNode()}),L.getViewer().render()})}}}(),S&&S.setEnableFlag(!0)}),X.OnReviewMarkupLoaded=K.addEvent("OnReviewMarkupLoaded",function(){let e=s.getReviewContext({viewer:L.getViewer()}),n=e?e.getValidation():null;if(n){let e=n.getAllRepRefs(),i=[],r=[];for(let t=0;t<e.length;t++){let n=e[t],o=n.getParent().getValType();"Markup"===o?i.push({title:n.getParent().getName(),content:n,id:n.getPlmID()}):"Reply"===o&&r.push({title:n.getParent().getName(),content:n,id:n.getPlmID(),parentID:n.getParentRepRef().getPlmID()})}let o={};i.forEach(e=>{j.addMarkup(e);let t=e.content.getMarkupContent(),n=t.getSlides()[0];if(n){t.setCurrentSlide(n);let e=n.getDMUObjects();e&&e.forEach(e=>{if(e.getDMUComments){let t=e.getDMUComments();t&&t.forEach(t=>{fe(t,e),o[t.getAttribute("sUuid")]=t})}})}}),r.forEach(e=>{let t=e.content.getMarkupContent().getComments();t&&t.forEach(e=>{let t=e.getAttribute("sParentCommentId");o[t]&&ve(e,o[t])})});let a=n.getCurrentMarkup();a&&t&&(T=a.getRepRef().getPlmID(),t.setCurrentMarkup(T))}}),X.onDMURemoveSessionReview=K.addEvent("onDMURemoveSessionReview",function(){t&&N&&(E&&E.length?(N.forEach((e,t)=>{e.isExternal||N.delete(t)}),me(),re()):j.cleanCommentsPanel())}),X.onDMUCommentAssociatedToHighlight=K.addEvent("onDMUCommentAssociatedToHighlight",function(e){e&&e.dmuObject&&he(e.dmuObject,null,{highlightData:e.highlightData})})}this.addMarkup=function(e){let n=s.getReviewContext({viewer:L.getViewer()}),i=n?n.getValidation():null;e&&i&&Z&&(t||Ae(),t&&(t.addMarkup({id:e.id,owner:e.content.getOwner(),title:e.title,parentID:e.parentID}),t.setCurrentMarkup(e.id)))},this.editMarkupName=function(e){t&&e&&e.getPlmID&&t.editMarkupName(e.getPlmID())},this.getSelectedComments=function(){return A&&A.filter(e=>!e.isExternal())},this.getCommentTooltip=function(e){if(!G)return null;const t=[];if(N.forEach(n=>{n.parentObject.getNode()===e&&t.push(n)}),t.length){F||(F=new Map);let e=f.createElement("div",{class:"DMUCommentTooltipMainDiv"});return t.forEach(t=>{if(!F)return;const n=F.get(t.uuid+"-tooltip");let i=n?n.getCommentDiv():null;if(!i){let e=new a({disableEdition:!0,commentData:t});F.set(t.uuid+"-tooltip",e),i=e.getCommentDiv()}e.appendChild(i),t.replies&&t.replies.forEach(function(e){if(!F)return;const t=F.get(e.uuid+"-tooltip");let n=t?t.getCommentDiv():null;if(!n){let t=new a({disableEdition:!0,commentData:e,allowReplies:V});F.set(e.uuid+"-tooltip",t),n=t.getCommentDiv()}i.appendChild(n)})}),e}},this.getCommentRepresentation=function(e,t){const n=N.get(e);if(n){F||(F=new Map);let i=new a({displayMode:t,disableEdition:!0,commentData:n,onClickCB:Ce,onEnterCB:be,onLeaveCB:be});return F.has(e)?F.get(e).push(i):F.set(e,[i]),{getDiv:i.getCommentDiv,updateDisplayMode:i.updateDisplayMode,remove:()=>{if(F){let t=F.get(e);t&&(t.splice(t.indexOf(i),1),0===t.length&&F.delete(e)),i.remove()}}}}},this.hasComments=function(){return Boolean(N&&N.size)},this.applyComment=function(e){if(!e.commentId)return;const t=N.get(e.commentId);t&&Ce({target:t})},this.setVisibleFlag=function(e){Y=e,S&&S.setPanelVisibilityFlag(e),R&&R.setStyle("display",e?"block":"none")},this.setPresentationModeFlag=function(e){G=e},this.removeComment=function(e,n){if(!e)return;if(e.isReply()&&V)return void De(e);ee();const i=N.get(e.getAttribute("sUuid"));if(i){i.replies&&i.replies.slice().forEach(function(t){De(t.dmuObject,e)}),Q.splice(Q.indexOf(i.uuid),1),t&&t.removeComment(i.uuid),N.delete(i.uuid);let r=i.parentObject;me();let o=s.getReviewContext({viewer:L.getViewer()}),a=o?o.getCurrentSessionMarkup():null;if(r&&a){let t;if(g.empty(),n)(t=a.getSlides()[0])&&t.removeDMUObject(r),L.getViewer().render();else{r.removeDMUComment(e);let n=r.getType();if("DMUCommentHighlight"===n||"DMUCommentPositioned"===n){let n=r.getAttribute("lComments");n&&n.length&&(1!==n.length||-1===n.indexOf(e))||((t=a.getSlides()[0])&&t.removeDMUObject(r),L.getViewer().render())}}}}},this.selectNextOrPreviousComment=function(e){ee();const t=e?1:-1;let n=((x?Q.indexOf(x):-1)+t)%Q.length;n<0&&(n=Q.length-1),d.empty(),g.empty();const i=Q[n],o=N.get(i);if(o){let e=r.buildPathElement(o.dmuObject.getNode());W=!1,H=!0,d.add({pathElement:e}),Z.centerViewpointAtElementPosition({elementID:(o.pointedElement?o.pointedElement.id:null)||o.pointedPage,position:o.pointedPosition}),S&&S.isSmallWidth()&&S.collapsePanel()}},this.getDMUObjectFromPathElement=function(e){if(!e)return;let t=e.getLastElement(!0),n=t.getDMUType?t.getDMUType():null;if(n){let e;if("DMUComment"===n){let e=N.values();for(let n=0;n<N.size;n++){let n=e.next().value;if(n.dmuObject.getNode()===t)return n.dmuObject}}else if(E&&(e=E.findIndex(function(e){return e.getNode()===t}))>=0)return E[e]}},this.setGuidelineVisibility=function(e){k&&R&&(e?(R.setStyle("display","block"),de(A)):R.setStyle("display","none"))},this.cleanCommentsPanel=function(){let e;ee(),document.removeEventListener("keyup",Ee),me();let n=L.getViewer().getNodes();if(E&&E.length){for(let t=0;t<n.length;t++)if("DecorationBag"===n[t].name){e=n[t];break}E.forEach(function(t){e&&e.removeChild(t.getNode())})}if(t){let e=Object.keys(w);for(let n=0;n<e.length;n++)t.unsubscribe(w[e[n]]||"");w={},t.clear()}y&&(u.unsubscribe(y.onPSOEmpty),u.unsubscribe(y.onPSORemove),u.unsubscribe(y.onPSOAdd),d.unsubscribe(y.onCSOEmpty),d.unsubscribe(y.onCSORemove),d.unsubscribe(y.onCSOAdd)),R&&k&&(L.getViewerFrame().removeEvent("resize",xe),L.getImmersiveFrame().removeEventListener("freeZoneResize",xe),k.clearRect(0,0,R.width,R.height),k=null,R.remove()),O&&m.unsubscribe(O),U&&U.destroy(),I&&clearInterval(I),S&&(S.removeEventListener("move",xe),S.removeEventListener("contentVisibleStateChange",Ie),S.setPanelVisibilityFlag(!1),S.clean()),N.clear(),B=!1,P=R=U=t=S=E=I=y=null},this.clear=function(){j.cleanCommentsPanel();let e,n,i=o.getManager({name:"DMUUserExperienceManager",context:L});if(i&&(i.unregisterContextualBar({type:"DMUMarker",module:"DMUMarker",workbenchName:"DMUMarkerContextHdr"}),i.unregisterContextualMenu({type:"DMUMarker",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"})),K)for(n=Object.keys(X),e=0;e<n.length;e++)K.removeEvent(X[n[e]]||"");F&&F.clear(),X={},U&&U.destroy(),U=null,I&&clearInterval(I),N.clear(),Q.length=0,F=K=t=I=x=null}}}let w=[];return class{static getDMUCommentsController(e){let t;for(let n=0;n<w.length;n++)if(w[n].context===e.context)return t=w[n].controller,w[n].count++,t;let n=new S(e);return t=Object.freeze({addMarkup:function(e){n&&n.addMarkup(e)},editMarkupName:function(e){n&&n.editMarkupName(e)},setVisibleFlag:function(e){n&&n.setVisibleFlag(e)},setPresentationModeFlag:function(e){n&&n.setPresentationModeFlag(e)},getCommentTooltip:function(e){if(n)return n.getCommentTooltip(e)},getCommentRepresentation:function(e,t){if(n)return n.getCommentRepresentation(e,t)},getSelectedComments:function(){if(n)return n.getSelectedComments()},hasComments:function(){return!!n&&n.hasComments()},applyComment:function(e){if(n)return n.applyComment(e)},removeComment:function(e,t){n&&n.removeComment(e,t)},setGuidelineVisibility:function(e){n&&n.setGuidelineVisibility(e)},selectNextOrPreviousComment:function(e){n&&n.selectNextOrPreviousComment(e)},getDMUObjectFromPathElement:function(e){if(n)return n.getDMUObjectFromPathElement(e)},cleanCommentsPanel:function(){if(n)return n.cleanCommentsPanel()},clear:function(){if(n)return n.clear()}}),w.push({context:e.context,controller:t,count:1}),t}static giveDMUCommentsController(e){if(e&&e.context)for(let t=0;t<w.length;t++)if(w[t].context===e.context)return w[t].controller}static unreferenceDMUCommentsController(e){if(e&&e.context)for(let t=0;t<w.length;t++)if(w[t].context===e.context){w[t].count--,0===w[t].count&&(w[t].controller.clear(),w.splice(t,1));break}}}}),define("DS/DMUBaseUIControllers/DMUGraphicPropertiesCtr",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/CATWebUXComponents/CATWebUXPanel","DS/DMUControls/panels/DMUGraphicPropertiesPanel","DS/DMUControls/panels/DMUCustomColorPanel","DS/DMUBaseExperience/DMUContextManager","DS/Utilities/TouchUtils","DS/DMUBaseUIServices/DMUObjectsServices","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d){"use strict";var g=e.extend({init:function(e){this._parent(e);var g,u,c,p,m,f,h=!1,v=(e||{}).ctxViewer,D=this,C=[];function b(){u&&u.clean(),u=null,c&&c.clean(),c=null,p&&p.clean(),p=null,m&&m.clean(),m=null}function M(e,t,n){var i,r;for(let o=0;o<t.length;o++)if(t[o].hasAttribute(e)&&!t[o].isAttributeReadOnly(e)&&(void 0===r&&(r=t[o].getAttribute(e)),void 0===r&&void 0!==n&&(r=n),i=t[o].getAttribute(e),JSON.stringify(i)!==JSON.stringify(r)))return null;return i}function S(){v.render();var e=a.getReviewContext({viewer:v.getViewer()});e&&e.getCurrentSessionMarkup()&&e.getCurrentSessionMarkup().isVisible()&&e.getCurrentSessionMarkup().getCurrentSlide()&&e.getCurrentSessionMarkup().getCurrentSlide().fireEvent("onSlidePreviewRefreshRequired",{dmuObject:e.getCurrentSessionMarkup().getCurrentSlide()})}function w(){p&&(p.clean(),m.clean(),m=p=null)}function y(e){localStorage.setItem("DMUGraphicPropertiesCustomColors",JSON.stringify(e.customColors)),u.setCustomColors(e.customColors),e.selectedColor&&u.setCurrentColor(e.selectedColor),w()}function U(e){if(p)w();else{p=new o({touchMode:l.getTouchMode()});var t=localStorage.getItem("DMUGraphicPropertiesCustomColors"),n=[];t&&(n=JSON.parse(t));let a=l.getTouchMode()?405:365;var r={id:"DMUCustomColorPanel",className:"DMUCustomColorPanel",title:d.grpCustomColorPanel,showTitleFlag:!0,frameWindow:v.getFrameWindow(),immersiveFrame:v.getFrameWindow().getImmersiveFrame(),content:p.build(n),minWidth:a,width:a,allowedDockAreas:WUXDockAreaEnum.NoneDockArea,currentDockArea:WUXDockAreaEnum.NoneDockArea,closeButtonFlag:!0,resizableFlag:!1,maximizeButtonFlag:!1,allowMaximizeFlag:!1,closePanelCB:w};(m=new i(r)).setPanelPosition({offsetX:window.innerWidth/2,offsetY:window.innerHeight/2-100}),p.setCurrentCustomColor(e),p.subscribe("onCustomColorPanelOk",y),p.subscribe("onCustomColorPanelCancel",w)}}function x(e){for(var t=0;t<C.length;t++)C[t].isAttributeReadOnly("bIsFilled")||(C[t].setAttribute("bIsFilled",e),C[t].refreshNode());u.update({hasBorder:M("bHasBorder",C)}),S()}function E(e,n){for(var i=0;i<C.length;i++)C[i].isAttributeReadOnly(e)||(C[i].setAttribute(e,new t.Color(n)),C[i].refreshNode());S()}function O(e){for(var t=0;t<C.length;t++)C[t].isAttributeReadOnly("fOpacity")||(C[t].setAttribute("fOpacity",e),C[t].refreshNode());S()}function P(e){for(var t=0;t<C.length;t++)C[t].isAttributeReadOnly("bHasBorder")||(C[t].setAttribute("bHasBorder",e),C[t].refreshNode());u.update({isFilled:M("bIsFilled",C)}),S()}function I(e){for(var t=0;t<C.length;t++)C[t].isAttributeReadOnly("sLineStylePattern")||(C[t].setAttribute("sLineStylePattern",e),C[t].setAttribute("sLeaderStylePattern",e),C[t].refreshNode());S()}function A(e){for(var t=0;t<C.length;t++)C[t].isAttributeReadOnly("fLineStyleThicknessIndex")||(C[t].setAttribute("fLineStyleThicknessIndex",e),C[t].setAttribute("fLeaderStyleThicknessIndex",e),C[t].refreshNode());S()}function R(e){for(var t=0;t<C.length;t++)C[t].isAttributeReadOnly("fLineStyleOpacity")||(C[t].setAttribute("fLineStyleOpacity",e),C[t].refreshNode());S()}function k(e){for(var t=0;t<C.length;t++)C[t].setAttribute("fFontSize",e),C[t].refreshNode();S()}function V(e){for(var t=0;t<C.length;t++)C[t].setAttribute("sFontStyle",e),C[t].refreshNode();S()}function T(e){if(b(),!h)return;let t=M("sLineStylePattern",C);t&&(t=parseFloat(t));let n=M("fLineStyleThicknessIndex",C);var o={isFilled:M("bIsFilled",C),hasBorder:M("bHasBorder",C),fillColor:M("cFillStyleColor",C),lineColor:M("cLineStyleColor",C),fillOpacity:M("fOpacity",C,0),thickness:void 0!==n?n:s.getLineThicknessIndex(M("fLineStyleThickness",C)),lineOpacity:M("fLineStyleOpacity",C,0),pattern:t,fontColor:M("cFontColor",C),fontStyle:M("sFontStyle",C),fontSize:M("fFontSize",C)};let a=localStorage.getItem("DMUGraphicPropertiesCustomColors");u||(u=new r({touchMode:l.getTouchMode()})),u.subscribe("onFilledPropertyChanged",x),u.subscribe("onFillColorChanged",function(e){E("cFillStyleColor",e)}),u.subscribe("onLineColorChanged",function(e){E("cLineStyleColor",e),E("cLeaderStyleColor",e)}),u.subscribe("onTextColorChanged",function(e){E("cFontColor",e)}),u.subscribe("onFillOpacityChanged",O),u.subscribe("onHasBorderPropertyChanged",P),u.subscribe("onLineTypeChanged",I),u.subscribe("onLineThicknessChanged",A),u.subscribe("onLineOpacityChanged",R),u.subscribe("onFontSizeChanged",k),u.subscribe("onFontStyleChanged",V),u.subscribe("onCustomColorPanelRequired",U),u.subscribe("onActiveTabChanged",function(e){localStorage.setItem("DMUGraphicPropsPanelActiveTab",e.activeTab)});var g=u.build({values:o,activeTab:localStorage.getItem("DMUGraphicPropsPanelActiveTab"),customColors:a?JSON.parse(a):[]});if(!c&&g){var p={id:"DMUGraphicPropsPanel",className:"DMUGraphicPropsPanel",title:d.grpPanel,showTitleFlag:!0,frameWindow:v.getFrameWindow(),immersiveFrame:v.getFrameWindow().getImmersiveFrame(),content:g,allowedDockAreas:WUXDockAreaEnum.NoneDockArea,currentDockArea:WUXDockAreaEnum.NoneDockArea,closeButtonFlag:!0,resizableFlag:!1,maximizeButtonFlag:!1,allowMaximizeFlag:!1,closePanelCB:function(){D&&D.setActiveState(!1)}};if(c=new i(p),e)c.setPanelPosition({offsetX:e.x,offsetY:e.y});else{var m=v.getFrameWindow().getContextualUIManager().getContextualBar(),f=m?m.getPosition():null,S=l.getTouchMode()?300:200;f?c.setPanelPosition({offsetX:f.x+m.elements.container.getDimensions().width/2-S/2,offsetY:f.y-S/2}):c.setPanelPosition({offsetX:window.innerWidth/2,offsetY:window.innerHeight/2-S/2}),m&&m.hide()}}}function F(){h&&(f&&(clearTimeout(f),f=null),f=setTimeout(()=>{C.length=0;let e=n.get();if(e&&e.length){var t=a.getReviewContext({viewer:v.getViewer()}),i=t.getCurrentSessionMarkup();if(i&&i.getActiveFlag()&&(i.isReadOnly()||i.getCurrentSlide())||(i=t.getTransientReviewBag()),e.forEach(function(e){var t=i.getDMUObjectFromPathElement(e.pathElement);t&&C.push(t)}),C.length)return void T(c?c.getAbsolutePosition():void 0)}D.setActiveState(!1)}))}this.setActiveState=function(e){if(h!==e)if(h=e,C.length=0,h){g||((g={}).onAdd=n.onAdd(F),g.onRemove=n.onRemove(F),g.onEmpty=n.onEmpty(F));var t=a.getReviewContext({context:v});if(t){var i=t.getCurrentSessionMarkup();if(i&&i.getActiveFlag()&&(i.isReadOnly()||i.getCurrentSlide())||(i=t.getTransientReviewBag()),!i)return void(h=!1);if(n.get().forEach(function(e){var t=i.getDMUObjectFromPathElement(e.pathElement);t&&C.push(t)}),!C.length)return void D.setActiveState(!1);T()}}else g&&(n.unsubscribe(g.onAdd),n.unsubscribe(g.onRemove),n.unsubscribe(g.onEmpty),g=null),b();else if(h){let e=v.getFrameWindow().getContextualUIManager().getContextualBar();e&&e.hide()}},this.getActiveState=function(){return h},this.clearController=function(){D.setActiveState(!1),f&&(clearTimeout(f),f=null),c=u=v=D=null}}}),u=[];return e.singleton({init:function(){},getDMUGraphicPropsController:function(e){var t=this.giveDMUGraphicPropsController(e);if(!t&&e&&e.context){var n=new g({ctxViewer:e.context});t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){if(n)return n.getActiveState()},clearController:function(){n&&(n.clearController(),n=null)}}),u.push({context:e.context,graphicPropsController:t})}return t},giveDMUGraphicPropsController:function(e){if(e&&e.context)for(var t=0;t<u.length;t++)if(u[t].context===e.context)return u[t].graphicPropsController},unreferenceDMUGraphicPropsController:function(e){if(e&&e.context)for(var t=0;t<u.length;t++)if(u[t].context===e.context){u[t].graphicPropsController.clearController(),u.splice(t,1);break}}})}),define("DS/DMUBaseUIControllers/DMUMarkupsController",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/CoreEvents/Events","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/DMUBaseExperience/EXPControllerEvents","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUMeasurable/DMUToolsSceneGraph","DS/CATWebUXPreferences/CATWebUXPreferencesManager"],function(e,t,n,i,r,o,a,l,s){"use strict";var d=t.extend({init:function(t){this._parent(t);var d,g,u=null,c=[],p=t.context,m=t.frmWindow,f=null,h=null,v=null,D=null,C=null,b=null,M=!1,S="true"===localStorage.getItem("DMU3DMarkersResponsiveDisplay");function w(t){if(!u||M)return;if(!d){var n=p.getSceneGraphOverrideSetManager();n&&p.getRootNode().getChildByName("DMUReviewBag")&&(d=new i(p.getRootNode().getChildByName("DMUReviewBag")),n.pushSceneGraphOverrideSet(d))}let r=o.getReviewContext({viewer:p}),s=r?r.getCurrentSessionMarkup():null,g=s?s.getCurrentSlide():null;if(!g||!d)return;d&&d.deleteOverrides(d.getOverrides());let c=g.get3DMarkers(),m=g.get2DMarkers();if(g.getPointedFormats&&g.getPointedFormats().forEach(e=>{c=c.concat(e.get3DMarkers()),m=m.concat(e.get2DMarkers())}),c.length){let n=function(){let t=a.getViewpointInfo(p.currentViewpoint);var n=1;if(1===p.getVisibleSpace()&&b&&b.vViewpointPosition&&b.vViewpointSight&&b.fViewpointTargetDistance){let i=(new e.Vector3).addVectors(b.vViewpointPosition,b.vViewpointSight.clone().multiplyScalar(b.fViewpointTargetDistance)),r=t.position.distanceTo(i),o=b.fViewpointTargetDistance;n=o&&r>o?1-3*Math.abs(r-o)/r:1,(n=Math.max(n,0))>.5?n=1:n*=2,n=Math.round(10*n)/10}return n}(),i={};c.forEach(e=>{let r=!S||e.isInEdition()?1:n;if(e.getNode()._updateVisibility(r,t),r){i[r]||(i[r]={opacity:r,paths:[]});let t=e.getNode().getRepNode(),n=[],o=Object.keys(t);if(-1!==o.indexOf("box"))for(let i=0;i<o.length;i++)"box"===o[i]&&e.getNode().hasTessellatedRepresentation&&!e.getNode().hasTessellatedRepresentation()||n.push(t[o[i]]);else n.push(e.getNode());n.forEach(e=>{i[r].paths.push(l.buildPathElement(e))})}});let r=Object.keys(i);if(r.length){let e;for(let t=0;t<r.length;t++)1!==i[r[t]].opacity&&i[r[t]]&&i[r[t]].paths&&i[r[t]].paths.length&&(e=d.createOverride({pathes:i[r[t]].paths}))&&e.setOpacity(i[r[t]].opacity)}}m&&m.length&&m.forEach(function(e){e.getNode().updateScreenPosition()}),p.render()}var y=function(e){if(c&&(!c||c.length)){var t,n=e.eventType||e.event,i=!1,r=!1,a=e;if("@onWindowResized"===n||"@onViewpointEndMove"===n||"@onViewpointBeginMove"===n||"@onPinchPanRotate"===n||"beginExplodeCmd"===n||"endExplodeCmd"===n||"onSwapVisibleSpace"===n||"onPreferenceModified"===n||"onDMUSlideStartDisplay"===n||"onDMUSlideDisplayed"===n)i=!0;else if("@onViewpointChange"===n&&e.viewpoint.isMoving()||"EXPEndProgressiveLoad"===n||"onRepresentationLoaded"===n)r=!0;else if("EXPHideShowEvent"===n&&(e&&e.occurrence||e.paths))if(i=!0,a={eventType:"onHideShow",flag:e.flag,paths:[]},e.occurrence){var l=o.getReviewContext({viewer:p});if(l){var s=l.getCurrentSessionMarkup(),d=s?s.getAttribute("oLinksManager"):null;if(d){var g=d.getOccurrencePathElement(e.occurrence.id);g&&a.paths.push(g.clone())}}}else if(e.areIdPaths)a.idPaths=a.paths.slice();else for(t=0;t<e.paths.length;t++)a.paths.push(e.paths[t].clone());if(("@onViewpointChange"===n&&e.viewpoint.isMoving()||"@onViewpointEndMove"===n||"onDMUSlideEnvironmentOverloadChanged"===n||"onSwapVisibleSpace"===n||"@onWindowResized"===n)&&w("@onViewpointChange"===n),i||r)for(t=0;t<c.length;t++)c[t]&&c[t].onViewerEventCB&&(i||r&&c[t].isDisplayed())&&c[t].onViewerEventCB(a)}};this.setResponsiveDisplayFlag=function(e){S=e,w()},this.getResponsiveDisplayFlag=function(){return S},this.setActiveState=function(e){if(e!==u){u=e;var t=o.giveEventsController({viewer:p}),i=o.getContextViewer({viewer:p}),a=s.getPreferenceManager({context:m});if(u){var l;if(a&&(D||(D=a.subscribe("CATWebUXPreferences_UnitsAndDecimalPlace",function(){y({eventType:"onPreferenceModified"})})),C||(C=a.subscribe("CATWebUXPreferences_TrailingZeros",function(){y({eventType:"onPreferenceModified"})}))),t)(v={}).OnHideShow=t.addEvent(r.Events.EXPHideShowEvent,function(e){e.eventType="EXPHideShowEvent",y(e)}),v.EndProgressiveLoad=t.addEvent(r.Events.EXPEndProgressiveLoad,function(e){e.eventType="EXPEndProgressiveLoad",y(e)}),v.onDMUSlideEnvironmentOverloadChanged=t.addEvent("onDMUSlideEnvironmentOverloadChanged",function(){let e=o.getReviewContext({viewer:p});e&&e.getEnvironment()&&(b=e.getEnvironment().getCurrentSlideEnvironmentInfo(),w())}),v.onDMUSlideStartDisplay=t.addEvent("onDMUSlideStartDisplay",function(e){if(M=!0,e&&e.dmuObject){let t=e.dmuObject.get2DMarkers(),n=1;if(e.dmuObject.getPointedFormats&&e.dmuObject.getPointedFormats().forEach(e=>{t=t.concat(e.get2DMarkers())}),t&&t.length){let e;for(let i=0;i<t.length;i++)(e=t[i].getMaximumProportionalWidth?t[i].getMaximumProportionalWidth():-1)>n&&(n=e)}n>1&&t.forEach(function(e){e.setMaximalProportionalZoneWidth(n)})}y({eventType:"onDMUSlideStartDisplay"})}),v.onDMUSlideDisplayed=t.addEvent("onDMUSlideDisplayed",function(e){if(M=!1,b=null,y({eventType:"onDMUSlideDisplayed"}),e&&e.dmuObject){let e=o.getReviewContext({viewer:p});b=e.getEnvironment().getCurrentSlideEnvironmentInfo()}w()}),v.onDMUObjectEdited=t.addEvent("onDMUObjectEdited",function(){l&&clearInterval(l),l=setTimeout(()=>{w(),l=null})});g=i.subscribe({event:"onRepresentationLoaded"},function(){y({eventType:"onRepresentationLoaded"})}),f||((f={}).onVISUEvents=n.subscribe({event:"/VISU/"},y),f.onResize=n.subscribe({event:"/VISU/onWindowResized"},function(){y({eventType:"@onWindowResized"})}),f.onExplodeStart=n.subscribe({event:"3DPLAY/EXPLODE/START"},function(){y({eventType:"beginExplodeCmd"})}),f.onExplodeEnd=n.subscribe({event:"3DPLAY/EXPLODE/END"},function(){y({eventType:"endExplodeCmd"})})),h||(h=p.onSwapVisibleSpace(function(){y({eventType:"onSwapVisibleSpace"})}));let e=o.getReviewContext({viewer:p});e&&(b=e.getEnvironment().getCurrentSlideEnvironmentInfo())}else{let e,r;if(b=null,d&&(p.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(d),d=null),c.length=0,t&&v){for(e=Object.keys(v),r=0;r<e.length;r++)t.removeEvent(v[e[r]]);v=null}if(i.unsubscribe(g),a&&D&&(a.unsubscribe(D),D=null),a&&C&&(a.unsubscribe(C),C=null),f){for(e=Object.keys(f),r=0;r<e.length;r++)n.unsubscribe(f[e[r]]);f=null}h&&(p.unsubscribe(h),h=null)}}},this.clear=function(){this.setActiveState(!1),c=p=null},this.registerMarker=function(e){c.push(e)},this.unregisterMarker=function(e){for(var t=c.length-1;t>=0;t--)if(c[t]===e){c.splice(t,1);break}}}}),g=[];return t.singleton({init:function(){},getDMUMarkupsController:function(e){if(e&&e.context){for(var t=!1,n=0;n<g.length;n++)if(g[n].context===e.context){g[n].counter++,t=!0;break}if(!t){var i=new d(e);i.setActiveState(!0),g.push({counter:1,context:e.context,markersController:i})}return this.giveDMUMarkupsController(e)}},giveDMUMarkupsController:function(e){if(e&&e.context){for(var t,n=0;n<g.length;n++)if(g[n].context===e.context){t=g[n].markersController;break}if(t)return Object.freeze({setResponsiveDisplayFlag:function(e){t&&t.setResponsiveDisplayFlag(e)},getResponsiveDisplayFlag:function(){return t?t.getResponsiveDisplayFlag():void 0},registerMarker:function(e){if(t)return t.registerMarker(e)},unregisterMarker:function(e){t&&t.unregisterMarker(e)}})}},unreferenceDMUMarkupsController:function(e){if(e&&e.context)for(var t=0;t<g.length;t++)if(g[t].context===e.context)return g[t].counter--,void(g[t].counter<=0&&(g[t].markersController&&g[t].markersController.clear(),g.splice(t,1)))}})}),define("DS/DMUBaseUIControllers/DMUApplicativeContextManager",["UWA/Class","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager","text!DS/DMUBaseUIControllers/assets/config/DMUApplicativeContextManager.json"],function(e,t,n,i,r){"use strict";var o=[{wkbID:"3D",module:"DS/CAT3DAnnotControllerForReview/CAT3DAnnotControllerForReview"},{wkbID:"3D",module:"DS/DMUBaseUIControllers/DMUEnrichApplicativeController"},{wkbID:"ITF",module:"DS/PIMwebViewController/PIMwebItfCtrl"},{wkbID:"MSR",module:"DS/SMAMpw3DMarkupImpl/SMAMpwMSRAppCtrl"}],a=["ITF","MSR"],l=["FTA"],s=e.extend({init:function(e){var s;this._parent(e);var d,g=[],u=e.context,c={},p=t.getEventsController({viewer:u.getViewer()}),m=i.getPreferenceManager({context:u.getFrameWindow()}),f=[],h=this,v=JSON.parse(r),D={};let C=[];function b(e){if(!e)return[];let t=e.getValidation?e.getValidation():null,n=[];if(t){let e=t.getMarkups();for(let t=0;t<e.length;t++){let i=e[t].getMarkupContent();!i&&e[t].getRepRef()&&(i=e[t].getRepRef().getMarkupContent()),i&&(n=n.concat(i.getSlides()))}}else n=e.getCurrentSessionMarkup&&e.getCurrentSessionMarkup()?e.getCurrentSessionMarkup().getSlides():[];return n}function M(e,n){var i=t.getReviewContext({context:u}),r=[],o=n||b(i);if(o.length&&i&&i.getUIManager()&&!i.getUIManager().getFormatEditionModeFlag()){let t;for(var a=0;a<o.length;a++)(t=o[a].getSlideApplicativeContext(e))&&r.push({state:t})}return r}function S(){D={},d&&(clearTimeout(d),d=0),d=setTimeout(function(){if(d=null,!g)return;let e=t.getReviewContext({context:u}),n=e?e.getCurrentSessionMarkup():null;for(var i=0;i<g.length;i++)if(g[i].controller){let e=M(g[i].controller.getApplicativeContainerID());g[i].controller.updateAppContainer({slidesEditableFlag:Boolean(n&&!n.isReadOnly()),slidesAppData:e})}},100)}function w(e,t,n){return e===t||!n||!(!e&&t||e&&!t)&&(e.version===t.version&&function e(t,n,i){if(t===n)return null!=t||!i.mandatory;var r=typeof t;if(r!==typeof n)return!1;if(!("array"!==i.type||Array.isArray(t)&&Array.isArray(n)))return!1;if("array"!==i.type&&r!==i.type)return!1;var o,a=!0;switch(i.type){case"object":var l=Object.keys(i.attributes);for(o=0;o<l.length;o++)if(!(a=e(t[l[o]],n[l[o]],i.attributes[l[o]])))return a;break;case"array":if(i.partialContentAllowed){if(t.length>n.length)return!1;for(o=0;o<t.length;o++){a=!1;for(var s=0;s<n.length;s++)if(e(t[o],n[s],i.childStructure)){a=!0;break}if(!a)return a}a=!0}else{if(t.length!==n.length)return!1;for(o=0;o<t.length;o++)if(!(a=e(t[o],n[o],i.childStructure)))return a}break;case"string":case"boolean":case"number":a=t===n}return a}(e.context,t.context,n.attributes.context))}var y=function(){setTimeout(function(){if(u){var e=[],n=!1;if(1===h.getApplicativeControllers().length&&h.getApplicativeControllers()[0].getActiveState()){var i=h.getApplicativeControllers()[0].getApplicativeContainerID();if(-1!==a.indexOf(i)){n=!0;var r=t.getReviewContext({context:u}),o=h.getApplicativeControllers()[0].getCurrentAppContainerState();if(r&&r.getUIManager()){let t=b(r);if(t.length)for(var l,d=0;d<t.length;d++)(l=t[d].getSlideApplicativeContext(i))&&w(o,l,v[i])&&e.push(t[d])}}}if(s){var g=s.giveDMUSlidesController({context:u.getFrameWindow()});g&&n&&(g.setSlideFilteringAvailability(!0),g.setListOfFilteredSlides(e))}}},10)};c.onLeavingR3DApp=p.addEvent("onLeavingR3DApp",function(e){g.forEach(function(t){t&&t.controller&&t.controller.onLeavingApp&&t.controller.onLeavingApp(e)})}),c.onComparisonStarted=p.addEvent("onComparisonStarted",function(){g.forEach(function(e){e&&-1===l.indexOf(e.id)&&e.controller&&e.controller.getActiveState()&&(e.controller.setActiveState(!1),C.push(e))})}),c.onComparisonEnded=p.addEvent("onComparisonEnded",function(){C.forEach(function(e){e&&e.controller&&!e.controller.getActiveState()&&e.controller.setActiveState(!0)}),C.length=0}),c.onDMUObjectInitialized=p.addEvent("onDMUObjectInitialized",function(e){e&&e.dmuObject&&("DMUSlide"===e.dmuObject.getType()||"DMUMarkup"===e.dmuObject.getType())&&(S(),y())}),c.onDMUObjectDeleted=p.addEvent("onDMUObjectDeleted",function(e){e&&e.dmuObject&&"DMUSlide"===e.dmuObject.getType()&&(S(),y())}),c.onDMUSlideDisplayed=p.addEvent("onDMUSlideDisplayed",function(e){e&&e.dmuObject&&"DMUSlide"===e.dmuObject.getType()&&y()}),c.onDMUObjectActiveFlagChanged=p.addEvent("onDMUObjectVisibleFlagChanged",function(e){e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&S()});var U=function(e){if(null===e&&n.empty(),s){var t=s.giveDMUSlidesController({context:u.getFrameWindow()});t&&t.setActiveSlide(e)}};let x=function(){let e;return function(t,n){return e=t&&t.version?t.version:0,function t(n,i){if(!i)return!0;Array.isArray(i)&&[].concat(i).some(t=>"fromVersion"in t?e>=t.fromVersion&&(i=t):"toVersion"in t?e<=t.toVersion&&(i=t):i=t);var r=typeof n;if("fromVersion"in i&&e<i.fromVersion)return void 0===n;if("toVersion"in i&&e>i.toVersion)return void 0===n;if(void 0===n)return!i.mandatory;if("array"===i.type&&!Array.isArray(n))return!1;if("array"!==i.type&&r!==i.type)return!1;var o,a=!0;switch(i.type){case"object":var l,s,d=Object.keys(i.attributes);for(o=0;o<d.length;o++){if((s=d[o].split("|")).length>1){let e=0;l=null;for(let t=0;t<s.length;++t)n[s[t]]&&(e++,l||(l=s[t]));if(1!==e)return!1}else l=d[o];if(!(a=t(n[l],i.attributes[d[o]])))return a}break;case"array":if(void 0!==i.minimal&&n.length<i.minimal)return!1;if(void 0!==i.maximal&&n.length>i.maximal)return!1;for(o=0;o<n.length;o++)if(!(a=t(n[o],i.childStructure)))return a}return a}(t,n)}}();this.initApplicativeContainer=function(e,n){var i=[];o.forEach(function(t){t.wkbID===e&&i.push(t.module)}),i.length&&require(["DS/DMUBaseUIControllers/DMUSlidesController"].concat(i),function(e,...i){s=e,i.forEach(e=>{if(u&&e.getApplicativeController){var i=e.getApplicativeController({context:u});i&&(g.push({id:i.getApplicativeContainerID(),controller:i,lib:e}),i.initializeAppContainer({onApplicativeControllerInitialized:function(){let e=t.getReviewContext({context:u}),r=e?e.getCurrentSessionMarkup():null;if(i.updateAppContainer({slidesEditableFlag:Boolean(r&&!r.isReadOnly()),slidesAppData:M(i.getApplicativeContainerID())}),n&&n.onReady){var o=[];g.forEach(function(e){o.push(e.controller)}),n.onReady(o)}y()},onDataWorkbenchReadyCB:function(e){p&&e&&p.fireEvent("onApplicativeContextCommandsRequired",e)},onPreferencesReadyCB:function(e){m&&e&&e.length&&(e.forEach(function(e){f.push(e.id)}),m.addPreferences(e))},options:n}),i.subscribe("onApplicativeContextActiveStateModified",function(e){if(D={},u&&e&&e.id&&(y(),e.state)){var n=t.getReviewContext({context:u});n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getCurrentSlide()&&U(n.getCurrentSessionMarkup().getCurrentSlide())}}),i.subscribe("onApplicativeContentChanged",function(e){if(u&&e&&e.id){var n,i=t.getReviewContext({context:u});if(g.some(function(t){if(t.id===e.id)return n=t.controller,!0}),n&&i&&i.getCurrentSessionMarkup()&&!i.getCurrentSessionMarkup().isReadOnly()&&i.getCurrentSessionMarkup().isVisible()&&i.getCurrentSessionMarkup().getCurrentSlide()&&i.getCurrentSessionMarkup().getCurrentSlide().isVisible()){var r=h.getVerifiedApplicativeContainerState(e.id);if(r){var o=i.getCurrentSessionMarkup().getCurrentSlide().getSlideApplicativeContext(e.id);o&&("FTA"===e.id&&o&&"number"!=typeof o.version?i.getCurrentSessionMarkup().getCurrentSlide().setSlideApplicativeContext(e.id,r):(o.content=r.content,i.getCurrentSessionMarkup().getCurrentSlide().setSlideApplicativeContext(e.id,o)),i.getCurrentSessionMarkup().getCurrentSlide().fireEvent("onSlideApplicativeContextModified",{dmuObject:i.getCurrentSessionMarkup().getCurrentSlide()}))}}}}),i.subscribe("onApplicativeContextRequested",function(e){if(!u||!e||!e.id)return;y();let n=t.getReviewContext({context:u});if(n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getActiveFlag()&&(n.getCurrentSessionMarkup().isVisible()||e.data&&e.data.forceDisplay)){var r=null;if(n.getUIManager().getFormatEditionModeFlag())return;let t=b(n);if(t.length){let n,a=[],l=[];for(let i=0;i<t.length;i++)(n=t[i].getSlideApplicativeContext(e.id))&&(l.push(n),a.push(t[i]));if(l.length){var o=i.getOrderedAppContainerStates(l,e.data);o&&o.length&&(D.id===e.id&&e.data&&JSON.stringify(e.data)===D.data?D.counter=D.counter+1:e.data&&(D={id:e.id,data:JSON.stringify(e.data),counter:0}),D.counter=D.counter%o.length,o&&o.length&&-1!==l.indexOf(o[0])&&(r=a[l.indexOf(o[D.counter])]))}}r?U(r):e.data&&e.data.selectedFeature&&p?p.fireEvent("onNewSlideCreationRequest"):U(null)}}),i.subscribe("onApplicativeContextChanged",function(e){if(D={},u&&e&&e.id){y();var n=t.getReviewContext({context:u});if(n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getActiveFlag()&&n.getCurrentSessionMarkup().getCurrentSlide()&&n.getCurrentSessionMarkup().getCurrentSlide().isVisible()){if(n.getUIManager().getFormatEditionModeFlag())return;if(v[e.id]&&w(i.getCurrentAppContainerState(),n.getCurrentSessionMarkup().getCurrentSlide().getSlideApplicativeContext(e.id),v[e.id]))return;U(null)}}}))}})})},this.removeApplicativeContainer=function(e){D.id===e&&(D={});for(var t=g.length-1;t>=0;t--)g[t]&&g[t].id===e&&(g[t].lib.unreferenceApplicativeController({context:u}),g.splice(t,1))},this.clear=function(){D={},C.length=0;for(var e=Object.keys(c),n=0;n<e.length;n++)p.removeEvent(c[e[n]]);t.unreferenceEventsController({viewer:u.getViewer()}),m&&(m.removePreferences(f),i.unreferencePreferenceManager({context:u.getFrameWindow()})),g.forEach(function(e){e.lib.unreferenceApplicativeController({context:u})}),u=m=null,f=[],g=[]},this.getVerifiedApplicativeContainerState=function(e){for(var t=0;t<g.length;t++)if(g[t].controller.getActiveState()&&g[t].controller.getApplicativeContainerID()===e){var n=g[t].controller.getCurrentAppContainerState();return v[e]&&!x(n,v[e])?void window.console.error("ERROR: the provided applicative container state does not match its structure."):n}},this.getApplicativeControllers=function(){var e=[];return g.forEach(function(t){t.controller.getActiveState()&&e.push(t.controller)}),e},this.getApplicativeContainersTICInfo=function(e,t){if(!e||"Issue"!==e&&"CA"!==e)return;var i,r=[],o=0,a=0,l=function(e){o++,e&&r.push(e),o===a&&t(r)};let s=[];n.get().map(e=>e.pathElement).forEach(e=>{if(e.getLastElement()&&e.getLastElement().getDMUType&&"DMUValidationExposedPresentation"===e.getLastElement().getDMUType()){let n=e.getLastElement().getOwner(),i=n.getParent();if(n&&i){let e=n.getPresentationSlideID(),r=i.getRepRef(n.getAttribute("sRepRefMarkupID"));var t=r?r.getMarkupContent():null;if(t&&e){let n=t.getSlides();for(let t=0;t<n.length;t++)if(n[t].getAttribute("sUuid")===e){s.push(n[t]);break}}}}});for(var d=0;d<g.length;d++)g[d].controller.getAppContainerTICInfo&&(i=M(g[d].controller.getApplicativeContainerID(),s.length?s:null))&&(a++,g[d].controller.getAppContainerTICInfo(e,i,l));a||t(r)}}}),d=[];return e.singleton({init:function(){},getDMUApplicativeContextManager:function(e){if(e&&e.context){for(var t=!1,n=0;n<d.length;n++)if(d[n].context===e.context){t=!0;break}if(!t){var i=new s(e);d.push({context:e.context,appController:i})}return this.giveDMUApplicativeContextManager(e)}},giveDMUApplicativeContextManager:function(e){if(e&&e.context){for(var t,n=0;n<d.length;n++)if(d[n].context===e.context){t=d[n].appController;break}if(t)return Object.freeze({initApplicativeContainer:function(e,n){t&&t.initApplicativeContainer(e,n)},getVerifiedApplicativeContainerState:function(e){return t?t.getVerifiedApplicativeContainerState(e):void 0},getApplicativeContainersTICInfo:function(e,n){return t?t.getApplicativeContainersTICInfo(e,n):void 0},removeApplicativeContainer:function(e){t&&t.removeApplicativeContainer(e)},getApplicativeControllers:function(){return t?t.getApplicativeControllers():void 0}})}},unreferenceDMUApplicativeContextManager:function(e){if(e&&e.context)for(var t=0;t<d.length;t++)if(d[t].context===e.context)return d[t].appController&&d[t].appController.clear(),void d.splice(t,1)}})}),define("DS/DMUBaseUIControllers/DMUEnrichApplicativeController",["require","exports","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUControls/EXPNotify","DS/CoreEvents/ModelEvents","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o){"use strict";class a{constructor(e){const t=this,a="POI",l=["ENO3DViewer_POI","ENO3DViewer_ZOI","ENO3DViewer_GP"];let s,d,g,u=!1,c=new r,p={},m=[],f=!1,h=[],v=!1;function D(e,t){c.publish({event:e,data:t})}function C(n,r){t&&(d&&(d.destroy(),d=null),d=new i({body:e.context.getFrameWindow().getUIFrame(),type:n,message:r}))}function b({id:e}){u||t.setActiveState(!0),m.includes(e)||(m.push(e),h.includes(e)?(h.splice(h.indexOf(e),1),0===h.length&&g&&g()):D("onApplicativeContextChanged",{id:a}))}function M({id:e}){const t=m.indexOf(e);-1!==t&&(m.splice(t,1),f||D("onApplicativeContextChanged",{id:a}))}function S({id:e}){!f&&m.includes(e)&&D("onApplicativeContentChanged",{id:a})}this.setActiveState=(t=>{if(t!==u){if(u=t)p.layerModified=e.context.getController().get3DLayerController().subscribe({event:"layerModified"},S),p.layerDeleted=e.context.getController().get3DLayerController().subscribe({event:"layerDeleted"},M);else{const t=Object.keys(p);for(let n=0;n<t.length;n++)e.context.getController().get3DLayerController().unsubscribe(p[t[n]]);p={}}D("onApplicativeContextActiveStateModified",{id:a,state:u})}}),this.getActiveState=(()=>u),this.subscribe=((e,t)=>c.subscribe({event:e},t)),this.unsubscribe=(e=>{c.unsubscribe(e)}),this.initializeAppContainer=(({onApplicativeControllerInitialized:n})=>{s=e.context.getController().get3DLayerController().subscribe({event:"layerCreated"},b);const i=e.context.getController().streamLayers();i&&i.length&&(m=i.map(e=>e.id),t.setActiveState(!0)),n()}),this.updateAppContainer=(e=>{e.slidesAppData.length&&e.slidesAppData.some(e=>e.state&&e.state.context&&e.state.context.layerIds&&e.state.context.layerIds.length)&&t.setActiveState(!0)}),this.onLeavingApp=(e=>{"X3DPLAW_AP"===e.targetApp&&t.setActiveState(!1)}),this.displayAppContainerState=(t=>{if(t.state&&t.state.context&&t.state.context.layerIds&&t.state.context.layerIds.length)if(h=t.state.context.layerIds.filter(e=>!m.includes(e)),m.length!==t.state.context.layerIds.length||h.length){m.length=0;const n=()=>{g=void 0,C("info",o.noWidgetLinkedToEnrichView),f=!1,t.callback()};try{const i="DS/WidgetLink/WidgetLink";parent.require([i],i=>{try{let r=i.get(window.widget);if(!r||!r.getLinked().length)return void n();const a="DS/ENOXInterWdgCom/LinkManager";window.require([a],n=>{f=!0,n.publish("DS/ExternalWdgtCom/RestoreLayers",{layerIds:t.state.context.layerIds});let i=setTimeout(()=>{t.callback(),setTimeout(()=>{t.state.content&&e.context.getController().setLayersProperties({layers:t.state.content.layerOverloads}),f=!1}),C("warning",o.layersMayBeMissing)},5e3);g=(()=>{g=void 0,clearTimeout(i),t.callback(),setTimeout(()=>{t.state.content&&e.context.getController().setLayersProperties({layers:t.state.content.layerOverloads}),f=!1})})})}catch(e){n()}})}catch(e){n()}}else setTimeout(()=>{t.state.content&&e.context.getController().setLayersProperties({layers:t.state.content.layerOverloads}),t.callback()});else m.length&&n.getPreference("DMUCaptureSpecLayers","boolean")?(m.length=0,e.context.getController().enrich3D({}).then(t.callback)):t.callback()}),this.getCurrentAppContainerState=(()=>{if(n.getPreference("DMUCaptureSpecLayers","boolean")){const t=[],n=[];return(e.context.getController().streamLayers()||[]).forEach(e=>{l.includes(e.kind)&&(t.push(e.id),n.push({id:e.id,visible:e.visible,clustered:e.clustered,color:e.color}))}),{version:1,context:{layerIds:t},content:{layerOverloads:n}}}return{version:1,context:{},content:{}}}),this.getApplicativeContainerID=(()=>a),this.getOrderedAppContainerStates=(()=>{}),this.getCurrentAppContainerStateTitle=(()=>void 0),this.setMinimalUIFlag=(e=>{v=e}),this.getMinimalUIFlag=(()=>v),this.clean=function(){t.setActiveState(!1),s&&(e.context.getController().get3DLayerController().unsubscribe(s),s=null)}}}let l=[];return class{static getApplicativeController(e){let t;for(let n=0;n<l.length;n++)if(l[n].context===e.context)return t=l[n].controller,l[n].count++,t;let n=new a(e);return t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){return!!n&&n.getActiveState()},subscribe:function(e,t){return n?n.subscribe(e,t):""},unsubscribe:function(e){n&&n.unsubscribe(e)},initializeAppContainer:function(e){n&&n.initializeAppContainer(e)},updateAppContainer:function(e){n&&n.updateAppContainer(e)},onLeavingApp:function(e){n&&n.onLeavingApp(e)},displayAppContainerState:function(e){n&&n.displayAppContainerState(e)},getCurrentAppContainerState:function(){return n?n.getCurrentAppContainerState():null},getApplicativeContainerID:function(){return n?n.getApplicativeContainerID():null},getOrderedAppContainerStates:function(e,t){return n?n.getOrderedAppContainerStates(e,t):null},getCurrentAppContainerStateTitle:function(){return n?n.getCurrentAppContainerStateTitle():void 0},setMinimalUIFlag:function(e){n&&n.setMinimalUIFlag(e)},getMinimalUIFlag:function(){return!!n&&n.getMinimalUIFlag()},clean:function(){n&&n.clean()}}),l.push({context:e.context,controller:t,count:1}),t}static giveApplicativeController(e){if(e&&e.context)for(let t=0;t<l.length;t++)if(l[t].context===e.context)return l[t].controller}static unreferenceApplicativeController(e){if(e&&e.context)for(let t=0;t<l.length;t++)if(l[t].context===e.context){l[t].count--,0===l[t].count&&(l[t].controller.clean(),l.splice(t,1));break}}}}),define("DS/DMUBaseUIControllers/DMUSlidesController",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/DMUControls/panels/DMUSlidesPanel","DS/CoreEvents/Events","DS/Core/ModelEvents","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUBaseUIServices/DMUObjectsServices","DS/CATWebUXComponents/CATWebUXPanel","DS/CATWebUXComponents/CATWebUXThumbnail","DS/ApplicationFrame/CommandsManager","DS/ApplicationFrame/ContextualMenu","DS/ApplicationFrame/ContextualBar","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/EXPManagerSet","DS/DMUControls/EXPNotify","DS/WebappsUtils/WebappsUtils","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/DMUBaseUI/DMUToolsUsers","DS/DMUBaseExperience/EXPUtils","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,g,u,c,p,m,f,h,v,D,C,b,M,S,w,y,U,x,E){"use strict";let O=e=>{if(!e||!e.context)return;let n=e.opts&&"number"==typeof e.opts.duration?e.opts.duration:400,i=o.getReviewContext({context:e.context}),r=i?i.getCurrentSessionMarkup():null;if(r){let a=r.getCurrentSlide();if(e.onBeforeApplySlide&&e.onBeforeApplySlide({previousSlide:a,nextSlide:e.slide}),r.setCurrentSlide(e.slide),a&&a.refreshNode(),e.slide){e.context.getViewer().getVisibleSpace()||(e.context.getViewer().swapVisibleSpace(),e.context.getViewer().render());let r,a=e.slide,l=e.viewpoint,s=a.getAttribute("mRelativePosMatrix");if(s){let e=a.getAttribute("sPointedReference"),n=i.getEnvironment(),o=g.getAbsolutePositionMatrix(a,s,e);if(o){let e=new t.Vector3,i=new t.Vector3;o.extractBasis(new t.Vector3,i,e);let a=(new t.Vector3).getPositionFromMatrix(o);r={vViewpointPosition:a,vViewpointSight:e,vViewpointUp:i,iViewpointType:n.getAttribute("iViewpointType"),fViewpointFieldOfView:n.getAttribute("fViewpointFieldOfView"),fViewpointTargetDistance:n.getAttribute("fViewpointTargetDistance")}}}let d,u=function(){a.refreshNode(),setTimeout(()=>{e.onSlideActivated&&e.onSlideActivated({slide:a})},n)},c=()=>{i.getEnvironment().refresh({duration:n,viewpoint:l,envInfos:r}),e.context.getController&&e.context.getController().forceRefresh();let t=M.giveDMUApplicativeContextManager({context:e.context}),o=t?t.getApplicativeControllers():[];if(o&&o.length){let e=0,t=function(){++e===o.length&&u()};for(let e=0;e<o.length;e++)o[e].displayAppContainerState({state:a.getSlideApplicativeContext(o[e].getApplicativeContainerID()),callback:t,noCtxChangedEvt:!0})}else u()},p=a.getDMUObjects();for(let e=0;e<p.length;e++)-1!==p[e].getType().indexOf("DMUCompare")&&(d=p[e]);if(!d&&a.getPointedFormats&&a.getPointedFormats().length){p=a.getPointedFormats()[0].getDMUObjects();for(let e=0;e<p.length;e++)-1!==p[e].getType().indexOf("DMUCompare")&&(d=p[e])}if(d){let t,n,i=o.giveEventsController({viewer:e.context.getViewer()});if(!i)return;n=i.addEvent("onComparisonDisplayed",()=>{i.removeEvent(n),i.removeEvent(t),c()}),t=i.addEvent("onComparisonEnded",()=>{i.removeEvent(n),i.removeEvent(t),c()}),a.fireEvent("onDMUSlideCompareDisplayRequired",{dmuObject:a})}else c()}else e.onSlideActivated&&e.onSlideActivated({slide:e.slide});e.context.getViewer().render()}};var P=e.extend({init:function(e){this._parent(e);var g,P,I,A,R,k,V,T,F,j,N,L,B,W,H,q,_,z,X,G=e||{},J=this,K=!1,Z=[],Y=[],Q=[],$=[],ee=G.context,te=!0,ne=!0,ie=new r,re=x.getPreference("DMUDisplaySlideTitle","boolean"),oe=!1,ae=[],le=null,se=!1,de=!0,ge=new t.Vector2,ue=!1,ce=[],pe=!0,me={},fe={},he=o.getContextViewer({viewer:ee.getViewer()}),ve=!1,De=o.giveEventsController({viewer:ee.getViewer()});let Ce,be=1,Me="1"===x.getPreference("DMUEnableSlideDragContent");function Se(){var e=o.getReviewContext({viewer:ee.getViewer()}),t=e&&!e.getValidation()?e.getCurrentSessionMarkup():null;if(t){var n=t.getSlides(),i=t.getAttribute("sCurrentSlideId");if("string"==typeof i){for(var r=0;r<n.length;r++)if(n[r].getAttribute("sID")===i){J.setActiveSlide(n[r]);break}}else n.length&&J.setActiveSlide(n[0])}}function we(e,t){return!(e&&!t)&&(!(!e&&t)&&(Math.round(1e3*e.x)/1e3==Math.round(1e3*t.x)/1e3&&(Math.round(1e3*e.y)/1e3==Math.round(1e3*t.y)/1e3&&Math.round(1e3*e.z)/1e3==Math.round(1e3*t.z)/1e3)))}function ye(e,t){return!(we(e.vViewpointSight,t.vViewpointSight)&&we(e.vViewpointUp,t.vViewpointUp)&&we(e.vViewpointPosition,t.vViewpointPosition)&&Math.round(1e3*e.fViewpointTargetDistance)/1e3==Math.round(1e3*t.fViewpointTargetDistance)/1e3&&e.iViewpointType===t.iViewpointType)}function Ue(e){if(!e)return"";let t=e.getAttribute("sUuid");return t||(t="MarkupID_"+e.parentID+"_SlideID_"+e.getAttribute("sID")),t}async function xe(){if(K&&ne&&ee.getViewer().getVisibleSpace()&&le&&le.isDisplayed()){var e=o.getReviewContext({viewer:ee.getViewer()}),t=e?e.getCurrentSessionMarkup():null;if(!(!t||t&&!t.getActiveFlag()||t&&t.getActiveFlag()&&!t.isVisible()||t&&t.getActiveFlag()&&t.isVisible()&&t.isImporting())){var n=e.getEnvironment().getEnvironmentInfo(),i=ye(n,e.getEnvironment().getCurrentSlideEnvironmentInfo());i&&(e.getEnvironment().refresh({duration:0}),ee.getViewer().render());var r,a,l=await b.computeImage({viewer:ee.getViewer(),width:200,height:113});if(g){let e=Ue(le);g.updateSlide(e,{img:l.src}),X&&X.has(e)&&X.get(e).forEach(e=>e.setPreview(l.src)),r="onSlidePreviewUpdated",a={slide:le,img:l.src},ie.publish({event:r,data:a,context:J})}if(!le.isReadOnly()){let e=U.convertImageDataUrl(l.src);e&&(le.setAttribute("sImageType",e.type),le.setAttribute("sImageData",e.data))}i&&(e.getEnvironment().refresh({envInfos:n,duration:0}),ee.getViewer().render())}}}var Ee,Oe;function Pe(){ne&&(H&&(clearInterval(H),H=null),Ee&&clearTimeout(Ee),Ee=setTimeout(function(){Ee=null,K&&"false"!==localStorage.getItem("DMUAutomaticThumbnailRefresh")&&(H=setInterval(function(){if(!ve&&!f._isShown&&!m._isShown){var e=o.getReviewContext({viewer:ee.getViewer()}),t=e?e.getUIManager():null,n=t?t.getSelectedObjects():void 0;if(t&&n){for(var i=0;i<n.length;i++)if("DMUSlide"!==n[i].getType()&&"DMUFormat"!==n[i].getType())return;clearInterval(H),H=null,xe()}}},100))},100))}function Ie(e){ee&&(Oe&&clearTimeout(Oe),Oe=setTimeout(function(){Oe=null;var t,n,i=o.getReviewContext({viewer:ee.getViewer()});if(i){var r,a=i.getCurrentSessionMarkup();if(r=!a||a&&!a.getActiveFlag()||a&&a.getActiveFlag()&&!a.isVisible()||a&&a.getActiveFlag()&&a.isVisible()&&!a.getCurrentSlide()?i.getTransientReviewBag():a.getCurrentSlide()){var l=r.areSectionPlanesDisplayed?!r.areSectionPlanesDisplayed():0===r.getDMUObjects("DMUSection").length;t=he,n=l,window.require(["DS/CAT3DAnnotControllerForReview/CAT3DAnnotationSectionHideShowController"],e=>{e&&he&&e.setSectionVisibilityFlag(t,n)});var s,d=M.giveDMUApplicativeContextManager({context:he}),g=d?d.getApplicativeControllers():[];if(g&&g.length)for(s=0;s<g.length;s++)g[s].setAppSectionPlanesVisibleFlag&&g[s].setAppSectionPlanesVisibleFlag(l)}}e&&Pe()},10))}function Ae(){if(g&&(g.setSlideTitleVisibleFlag(!!oe||(void 0!==F?F:re)),X)){let e=X.keys();for(let t=0;t<X.size;t++){let t=e.next().value,n=X.get(t);for(let e=0;e<n.length;e++)n[e].setTitleAndIconSectionVisibleFlag(re)}}X&&X.clear()}function Re(e){let t=v.getManager({name:"DMU2DSheetManager",context:ee});if(t&&t.isADocumentDisplayed())return;let n=e.slide.getEnvironmentOverload();if(n){let t=n.state;if(!(t&&t.vViewpointPosition&&t.vViewpointRight&&t.vViewpointSight&&t.vViewpointUp))return void window.console.error("State overload is not defined");let i={protocol:"3DXContent",version:"2.0",data:{items:[{serviceId:"3DSpace",envId:S.getPlatformId(),contextId:w.getSetting("pad_security_ctx")?w.getSetting("pad_security_ctx"):void 0,objectId:"",objectType:"DMUSlideView",objectOverloads:[],dmuObjects:[],environmentOverload:{targetDistance:t.fViewpointTargetDistance,viewpointAngle:t.fViewpointFieldOfView||he.getViewpoint().getAngle(),viewpointPosition:{x:t.vViewpointPosition.x,y:t.vViewpointPosition.y,z:t.vViewpointPosition.z},viewpointRight:{x:t.vViewpointRight.x,y:t.vViewpointRight.y,z:t.vViewpointRight.z},viewpointSight:{x:t.vViewpointSight.x,y:t.vViewpointSight.y,z:t.vViewpointSight.z},viewpointUp:{x:t.vViewpointUp.x,y:t.vViewpointUp.y,z:t.vViewpointUp.z}}}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0},r=[],o=e.slide.getObjectOverloads();if(o)for(let e=0;e<o.length;e++)if(o[e].state.hasOwnProperty("bVisible")){let t=o[e].target.getOccurrenceIDPath();i.data.items[0].objectOverloads.push({data:{type:"Visible",value:o[e].state.bVisible},targetPath:t}),r.push(JSON.stringify(t))}let a=e.slide.getPointedFormats();if(a&&a.length){let e=a[0].getObjectOverloads();if(e&&e.length)for(let t=0;t<e.length;t++)if(e[t].state.hasOwnProperty("bVisible")){let n=e[t].target.getOccurrenceIDPath();r.includes(JSON.stringify(n))||i.data.items[0].objectOverloads.push({data:{type:"Visible",value:e[t].state.bVisible},targetPath:n})}}let l=e.slide.getDMUObjects("DMUSection");if(l&&l.length){let e=[];l[0].getAttribute("mPlaneReferential")&&(e=l[0].getAttribute("mPlaneReferential").elements),l[0].getAttribute("bVisible")&&i.data.items[0].dmuObjects.push({type:"Section",data:{offset:l[0].getAttribute("fSliceOffset"),xDirSize:l[0].getAttribute("fXDirSize"),yDirSize:l[0].getAttribute("fYDirSize"),planeBoxMode:l[0].getAttribute("sPlaneBoxMode"),planeReferential:e}})}if(a&&a.length&&0===i.data.items[0].dmuObjects.length){let e=a[0].getDMUObjects("DMUSection");if(e&&e[0]){let t=[];e[0].getAttribute("mPlaneReferential")&&(t=e[0].getAttribute("mPlaneReferential").elements),e[0].getAttribute("bVisible")&&i.data.items[0].dmuObjects.push({type:"Section",data:{offset:e[0].getAttribute("fSliceOffset"),xDirSize:e[0].getAttribute("fXDirSize"),yDirSize:e[0].getAttribute("fYDirSize"),planeBoxMode:e[0].getAttribute("sPlaneBoxMode"),planeReferential:t}})}}let s={id:e.id,parentSlideId:e.parentSlideID,data:JSON.stringify(i)};g&&g.setSlideDragContent(s)}}function ke(e){if(e)for(let t=0;t<Z.length;t++)if(Z[t].id===e){Re(Z[t]);break}}function Ve(){if(!g)return;let e=!g.getPanelActiveFlag();g&&g.setPanelActiveFlag(e);var t,n=a.get();for(t=n.length-1;t>=0;t--)n[t].pathElement.getLastElement(!0).getDMUType&&a.remove(n[t]);for(t=(n=l.get()).length-1;t>=0;t--)n[t].pathElement.getLastElement(!0).getDMUType&&l.remove(n[t]);var i=o.getReviewContext({viewer:ee.getViewer()});i&&(i.getTransientReviewBag().removeDMUObjects(),i.getUIManager().setMarkupVisualizationActiveState(Boolean(e&&i.getCurrentSessionMarkup())))}function Te(){g&&K&&!g.getPanelActiveFlag()&&Ve()}function Fe(){return g?g.getColumnMinimumWidth():250}function je(){return g?g.getColumnWidthStep():233}function Ne(){if(P){if(sessionStorage)if("true"===sessionStorage.getItem("DMUSlidesExpFlag_"+widget.id))sessionStorage.setItem("DMUSlidesExpFlag_"+widget.id,"false"),P.setWidth(Fe());else{var e=parseFloat(sessionStorage.getItem("DMUSlidesWidth_"+widget.id));e&&e!==Fe()&&(sessionStorage.setItem("DMUSlidesExpFlag_"+widget.id,"true"),P.setWidth(e))}g&&g.resizePanel({width:P.getWidth(),height:P.getHeight()})}}function Le(){g&&(g.resetSlideDisplayHistory(),le&&g.setActiveSlide(Ue(le))),L&&L.destroy(),L=new D({body:ee.getUIFrame(),type:"info",message:E.displayHistoryRemoved})}function Be(e){if(Te(),e&&e.id){g&&g.setActiveSlide(e.id);for(var t=0;t<Z.length;t++)if(Z[t].isActiveSlide=Z[t].id===e.id,Z[t].id===e.id){J.setActiveSlide(Z[t].slide);break}}P&&P.isSmallWidth()&&P.collapsePanel()}function We(e){if(!A)for(var t=0;t<Z.length;t++)if(Z[t].id===e.id){var n=h.buildPathElement(Z[t].slide.getNode());e.prehighlightedFlag?s.add({pathElement:n}):s.remove({pathElement:n})}}function He(e){if(!A)for(var t=0;t<Z.length;t++)if(Z[t].id===e.id){var n=h.buildPathElement(Z[t].slide.getNode());e.checkFlag?a.add({pathElement:n}):a.remove({pathElement:n})}}function qe(e){for(let t=0;t<Z.length;t++)Z[t].id===e.id&&(z=Z[t].slide);p.getCommand("DMUCreateSlideReplyHdr",G.commandContext).begin(),P&&P.isSmallWidth()&&P.collapsePanel()}function _e(e){var t,n=o.getReviewContext({viewer:ee.getViewer()}),i=n?n.getValidation():null;if(i){let n=i.getRepRef(e.markupID);t=n?n.getMarkupContent():null}else t=n?n.getCurrentSessionMarkup():null;if(t&&e.orderedSlideIDs&&e.orderedSlideIDs.length){let n=oe?t.getFormats():t.getSlides();e.orderedSlideIDs.forEach(function(e){let t=n.findIndex(t=>t.getAttribute("sUuid")===e);if(t>=0){let e=n.splice(t,1)[0];n.push(e)}}),t.setAttribute(oe?"lFormats":"lSlides",n),De&&De.fireEvent("onSaveRequested")}}function ze(e){var t=o.getReviewContext({viewer:ee.getViewer()}),n=t?t.getValidation():null;n&&e.orderedMarkupIDs&&n.reorderMarkups(e.orderedMarkupIDs)}function Xe(){pe&&(q||(q=setInterval(function(){if(!_&&!ve){if(clearInterval(q),q=null,g&&g.removeSlideUpdateRequiredFlags(),!K||A||!g||ae.length||se||!g.getPanelActiveFlag()||!pe||!ee)return;if(le&&!le.isReadOnly()&&le.getActiveFlag()&&o.getReviewContext({viewer:ee.getViewer()})){var e=le.getEnvironmentOverload();if(e)ye(e=e.state,o.getReviewContext({viewer:ee.getViewer()}).getEnvironment().getEnvironmentInfo())&&g.setSlideUpdateRequiredFlag(Ue(le),!0)}}},100)))}function Ge(e){for(var t=0;t<Z.length;t++)if(Z[t].id===e.id){var n=p.getCommand("DMUUpdateFormatSessionOverloadHdr",G.commandContext);return n&&n.begin(),void Xe()}}function Je(){Te();var e=p.getCommand(oe?"DMUExitFormatsHdr":"DMUEditFormatsHdr",G.commandContext);e&&e.begin()}function Ke(){Te(),a.empty();var e=p.getCommand("DMUEditPropertiesHdr",G.commandContext);e&&e.begin()}function Ze(e){Te();for(var t=0;t<Z.length;t++)if(Z[t].id===e.id)return Z[t].slide.setAttribute("sName",e.title),X&&X.has(e.id)&&X.get(e.id).forEach(t=>t.setThumbnailTexts({title:e.title})),De&&De.fireEvent("onDMUSlideNameChanged",{dmuObject:Z[t].slide,value:e.title}),void(Z[t].title=e.title)}function Ye(e){for(var t=0;t<Q.length;t++)if(Q[t].id===e.id&&Q[t].content){let i=Q[t].content.getMarkupContent();if(i){var n=h.buildPathElement(i.getNode());a.empty(),l.empty(),a.add({pathElement:n}),s.add({pathElement:n}),ge=e.position.clone(),ee.getContextualUIManager()._showContextualMenu(ge)}}}function Qe(e){if(De){let i=!1;for(var t=0;t<Q.length;t++)if(Q[t].id===e.id){i=!0;break}if(i){var n=o.getReviewContext({viewer:ee.getViewer()});if(!n)return;let t=n.getValidation();if(!t)return;t&&t.getMarkups().some(t=>{let n=t.getRepRef();if(n.getPlmID&&n.getPlmID()===e.id)return De.fireEvent("onValidationObjectAttributesModificationRequest",{dmuObject:n,attr:{key:"name",value:e.title}}),!0})}}}function $e(e){for(var t=0;t<Z.length;t++)if(Z[t].id===e.id){var n=h.buildPathElement(Z[t].slide.getNode());e.shiftKeyPressed||e.ctrlKeyPressed||e.openFromButton||(a.empty(),l.empty()),a.add({pathElement:n}),ge=e.position.clone();var i=v.getManager({name:"DMUUserExperienceManager",context:ee});i&&i.setCCPTarget(Z[t].slide),ee.getContextualUIManager()._showContextualMenu(ge)}}function et(e){e?be++:be--,P&&P.setEnableFlag(be>0)}function tt(){if(ee&&J){var e=v.getManager({name:"DMU2DSheetManager",context:ee});!e||!e.isADocumentDisplayed()&&!e.isRunning()||"Document"!==e.getDocumentType()&&"Requirement"!==e.getDocumentType()?J.setVisibleFlag(!0):J.setVisibleFlag(!1)}}function nt(){P&&P.setPanelVisibilityFlag((Q&&Q.length||Z&&Z.length>0)&&ne)}if(this.subscribe=function(e,t){if(e&&t)return ie.subscribe({event:e},t)},this.unsubscribe=function(e){null!=e&&ie.unsubscribe(e)},De){var it=function(e){e&&e.reviewId&&e.reviewType&&e.reviewName&&(B=JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:S.getPlatformId(),serviceId:"3DSpace",contextId:w.getSetting("pad_security_ctx")?w.getSetting("pad_security_ctx"):void 0,objectId:e.reviewId,objectType:e.reviewType,displayName:e.reviewName}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}),g&&g.setDragContent(B))},rt=o.getReviewContext({viewer:ee.getViewer()});rt&&it(rt.getReviewCtxInformation()),me.onReviewCtxInformationChanged=De.addEvent("onReviewCtxInformationChanged",it),me.onDMUSlidePreferencesChanged=De.addEvent("onDMUSlidePreferencesChanged",function(){var e=d.getSlidePreferences({context:ee});e&&e.panelTitle&&"string"==typeof e.panelTitle&&k!==e.panelTitle&&(k=e.panelTitle,!R&&g&&g.setPanelTitle(k))}),me.onDMUSlideAssociatedToHighlight=De.addEvent("onDMUSlideAssociatedToHighlight",function(e){e&&e.dmuObject&&e.dmuObject.getAssociatedHighlightData&&J.updateSlide(e.dmuObject,{highlight:e.dmuObject.getAssociatedHighlightData()})}),me.onApplyingSlideView=De.addEvent("onApplyingSlideView",function(){let e=o.getReviewContext({viewer:ee.getViewer()});if(e){e.getUIManager().setMarkupVisualizationActiveState(!1);let t=e.getTransientReviewBag();t&&t.removeDMUObjects("DMUSection")}}),me.onDMUPreferencesChanged=De.addEvent("onDMUPreferencesChanged",function(e){if(e&&void 0!==e.DMUDisplaySlideTitle&&(re=e.DMUDisplaySlideTitle,Ae()),e&&e.DMUEnableSlideDragContent){Me="1"===e.DMUEnableSlideDragContent;let t=v.getManager({name:"DMU2DSheetManager",context:ee});g&&(t&&t.isADocumentDisplayed()?g.enableDragContent(!1):g.enableDragContent(Me))}}),me.onDMUObjectActiveFlagChanged=De.addEvent("onDMUObjectActiveFlagChanged",function(e){var t=o.getReviewContext({viewer:ee.getViewer()});!(t&&g&&e)||e&&!e.dmuObject||e&&e.dmuObject&&!e.dmuObject.isVisible()||(!t.getValidation()&&"DMUMarkup"===e.dmuObject.getType()||t.getValidation()&&"DMUValidationValidation"===e.dmuObject.getType())&&Te()}),me.onDMUMarkupLoaded=De.addEvent("onDMUMarkupLoaded",function(){W||(et(!1),W=setInterval(function(){if(!K||!ee)return clearInterval(W),void(W=null);if(P&&he&&he.getRootBagPath().getChildrenPathes().length){var e=v.getManager({name:"DMU2DSheetManager",context:ee});(e&&e.isADocumentDisplayed()&&!e.isRunning()||!e||e&&!e.isADocumentDisplayed()&&"Document"!==e.getDocumentType()&&"Requirement"!==e.getDocumentType())&&(clearInterval(W),W=null,et(!0),me.onDMUMarkupApplicativeContextLoaded||Se())}},100))}),me.onDMUMarkupApplicativeContextLoadBegin=De.addEvent("onDMUMarkupApplicativeContextLoadBegin",function(){me.onDMUMarkupApplicativeContextLoaded=De.addEvent("onDMUMarkupApplicativeContextLoaded",function(){Se(),De.removeEvent(me.onDMUMarkupApplicativeContextLoaded),me.onDMUMarkupApplicativeContextLoaded=null})}),me.onDMUObjectInitialized=De.addEvent("onDMUObjectInitialized",function(e){if(e&&e.dmuObject&&(!le||e.dmuObject!==le&&-1===le.getDMUObjects().indexOf(e.dmuObject)||Pe(),le&&"DMUFormat"!==le.getType()&&"DMUSection"===e.dmuObject.getType())){ke(Ue(le))}}),me.onFormatsEditionModeEnded=De.addEvent("onFormatsEditionModeEnded",function(){for(let e=0;e<Z.length;e++){ke(Z[e].id)}}),me.onSaveRequested=De.addEvent("onSaveRequested",Pe),me.onEndSectionManipulation=De.addEvent("onEndSectionManipulation",function(e){if(e&&e.dmuObject&&le&&"DMUFormat"!==le.getType()&&"DMUSection"===e.dmuObject.getType()){ke(Ue(le))}}),me.onDMUObjectDeleted=De.addEvent("onDMUObjectDeleted",function(e){if(e&&e.dmuObject&&e.dmuObject.getType){if("DMUSlide"===e.dmuObject.getType()||"DMUFormat"===e.dmuObject.getType()){var t=o.getReviewContext({viewer:ee.getViewer()});t&&t.getValidation()&&e.dmuObject===le&&J.setActiveSlide(null),J.removeSlide(e.dmuObject)}else if("DMUMarkup"===e.dmuObject.getType()){for(let t=Q.length-1;t>=0;t--)if(Q[t].content&&Q[t].content.getMarkupContent()===e.dmuObject){for(let e=$.length-1;e>=0;e--)$[e].parentID===Q[t].id&&(g&&g.removeReply($[e].id),$.splice(e,1));g&&g.removeMarkup(Q[t].id),Q.splice(t,1);break}}else if(le&&"DMUFormat"!==le.getType()&&"DMUSection"===e.dmuObject.getType()){ke(Ue(le))}else"DMUMarker3DPoint"!==e.dmuObject.getType()&&"DMUMarker2DPoint"!==e.dmuObject.getType()&&Pe();nt()}}),me.onDMUSlideSessionInfoChanged=De.addEvent("onDMUSlideSessionInfoChanged",function(e){if(e&&e.dmuObject&&"DMUSlide"===e.dmuObject.getType()){ke(Ue(e.dmuObject))}Pe()}),me.onSlidePreviewRefreshRequired=De.addEvent("onSlidePreviewRefreshRequired",function(e){e&&e.dmuObject===le&&Pe()}),me.onDMUSlideOrFormatRefreshRequired=De.addEvent("onDMUSlideOrFormatRefreshRequired",function(e){e&&e.dmuObject===le&&Pe()}),me.onDMUOverloadPropertiesChanged=De.addEvent("onDMUOverloadPropertiesChanged",Pe),me.onOccurenceVisibleFlagChanged=De.addEvent("onOccurenceVisibleFlagChanged",function(){if(le&&"DMUFormat"!==le.getType()){ke(Ue(le))}}),me.onDMUOccOverloadRemoved=De.addEvent("onDMUOccOverloadRemoved",function(){if(Pe(),le&&"DMUFormat"!==le.getType()){ke(Ue(le))}}),me.onDMUObjectAddedInObject=De.addEvent("onDMUObjectAddedInObject",function(e){e&&e.dmuObject&&"DMUSection"===e.dmuObject.getType()&&Ie()}),me.onDMUObjectRemovedFromObject=De.addEvent("onDMUObjectRemovedFromObject",function(e){if(e&&e.dmuObject&&"DMUSection"===e.dmuObject.getType()){if(le&&"DMUFormat"!==le.getType()){ke(Ue(le))}Ie()}}),me.onDMUFormatAssociatedListeModified=De.addEvent("onDMUSlideFormatListModified",function(e){if(e&&e.dmuObject&&e.dmuObject.isDisplayed()&&(Ie(),"DMUFormat"!==e.dmuObject.getType())){ke(Ue(e.dmuObject))}}),me.onDMUObjectVisibleFlagChanged=De.addEvent("onDMUObjectVisibleFlagChanged",function(e){e&&e.dmuObject&&("DMUSlide"===e.dmuObject.getType()||"DMUFormat"===e.dmuObject.getType())&&Ie()}),me.onContextVisuChangeEnd=De.addEvent("onContextVisuChangeEnd",Pe),me.onNewSlideCreationRequest=De.addEvent("onNewSlideCreationRequest",lt);let e=!1;me.onDMUSlideCompareDisplayRequired=De.addEvent("onDMUSlideCompareDisplayRequired",()=>{et(!1),e=!0}),me.onComparisonDisplayed=De.addEvent("onComparisonDisplayed",()=>{e&&et(!0),e=!1}),me.onComparisonEnded=De.addEvent("onComparisonEnded",()=>{e&&et(!0),e=!1}),me.on2DDocumentLoadStarted=De.addEvent("on2DDocumentLoadStarted",()=>{let e=v.getManager({name:"DMU2DSheetManager",context:ee});J.setVisibleFlag(!(e&&!e.getLoadedDocuments().length))}),me.on2DDocumentLoadError=De.addEvent("on2DDocumentLoadError",()=>{J.setVisibleFlag(!0)}),me.onEmptyDocument=De.addEvent("onEmptyDocument",()=>{J.setVisibleFlag(!0)}),me.on2DDocumentLoadSuccess=De.addEvent("on2DDocumentLoadSuccess",tt)}var ot=i.subscribe({event:"/VISU/"},function(e){var t=e.eventType||e.event;"@onViewpointBeginMove"===t?ve=!0:"@onViewpointEndMove"===t&&(ve=!1,Xe())});function at(){var e=[];if(A)e.push({id:"DMUResetDisplayHistory",type:"button",nls:E.resetDisplayHistoryLabel,icon:C.getWebappsAssetUrl("DMUControls","icons/22/I_ResetDisplayHistoryCmd.png"),cb:Le});else{e=te?[{id:"DMUFormats",type:"button",nls:oe?E.exitFormatsUI:E.launchFormatsUI,icon:C.getWebappsAssetUrl("DMUFormatEdition","icons/32/")+(oe?"I_ExitFormatsCmd.png":"I_EditFormatsCmd.png"),cb:Je}]:[];var t=p.getCommand("DMUEditPropertiesHdr",G.commandContext);null!=t&&e.push({id:"DMUEditProperties",type:"button",nls:E.launchEditProperties,icon:C.getWebappsAssetUrl("DMUControls","icons/22/")+"I_DMUEditProperties.png",cb:Ke})}return e}function lt(e){if(e&&e.id){var t=o.getReviewContext({viewer:ee.getViewer()}),n=t?t.getValidation():null;n&&n.setCurrentMarkup(n.getRepRef(e.id)),dt(n)}p.getCommand(oe?"DMUFormatCmdHdr":"slideCmdHdr",G.commandContext).begin(),P&&P.isSmallWidth()&&P.collapsePanel()}function st(){var e=[{id:"switchReviewVisibilityBtn",checkFlag:!0,type:"switch",title:E.switchMarkupVisibility,cb:function(e){var t=e.dsModel.checkFlag;if(Ve(),t){var n=v.getManager({name:"DMU2DSheetManager",context:ee});if(n&&n.isADocumentDisplayed()){var i=o.getReviewContext({viewer:ee.getViewer()});i&&i.getEnvironment().refresh()}}P&&P.isSmallWidth()&&P.collapsePanel()}}];return ue&&e.push({id:"filterButton",type:"checkbox",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-filter",title:E.filterSlides,checkFlag:!!g&&g.getFilterActivationFlag(),cb:function(){g&&g.switchFilterActivation()}}),!A&&te&&e.push({id:"newButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-plus",title:oe?E.newFormat:E.newSlide,cb:lt}),e}function dt(e){if(te=!0,e){let t=e.getCurrentMarkup();if(t){for(;t&&"Markup"!==t.getValType();)t=t.getParentRepRef().getParent();t&&(te=(t.isWebMarkup&&t.isWebMarkup()||t.getRepRef&&t.getRepRef()&&t.getRepRef().isWebMarkup&&t.getRepRef().isWebMarkup())&&!t.isReadOnly())}}g&&(g.setPanelSubMenuCommands(at()),g.setPanelQuickAccessCommands(st()))}function gt(){var e=d.getSlidePreferences({context:ee});if(e&&("boolean"==typeof e.displaySlidePanel&&(de=e.displaySlidePanel),"string"==typeof e.panelTitle&&(k=e.panelTitle),"boolean"==typeof e.displaySlideTitle&&(F=e.displaySlideTitle),void 0===A&&"boolean"==typeof e.playMode&&(A=e.playMode),!j&&e.beforeApplySlideCB&&(j=e.beforeApplySlideCB),!N&&e.afterApplySlideCB&&(N=e.afterApplySlideCB)),de){var t,i=o.getReviewContext({viewer:ee.getViewer()});if(i&&(t=i.getValidation()),g||(g=new n({allowMarkupReorder:Boolean(window.__karma__&&window.allowMarkupReorder),allowSlideReorder:!0,allowReplies:t&&!oe}),(I={}).onTopBarDoubleClick=g.subscribe("onTopBarDoubleClick",Ne),I.onSlideDisplayed=g.subscribe("onSlideDisplayed",Be),I.onSlidePreselected=g.subscribe("onSlidePreselected",We),I.onSlideSelected=g.subscribe("onSlideSelected",He),I.onSlideUpdateRequired=g.subscribe("onSlideUpdateRequired",Ge),I.onSlideNameChanged=g.subscribe("onSlideNameChanged",Ze),I.onSlideCtxMenuRequired=g.subscribe("onSlideCtxMenuRequired",$e),I.onMarkupCtxMenuRequired=g.subscribe("onMarkupCtxMenuRequired",Ye),I.onMarkupRenamed=g.subscribe("onMarkupRenamed",Qe),I.onNewSlideCreated=g.subscribe("onNewSlideCreated",lt),I.onSlideReplyCreated=g.subscribe("onSlideReplyCreated",qe),I.onSlideReordered=g.subscribe("onSlideReordered",_e),I.onSlideDragStart=g.subscribe("onSlideDragStart",e=>{e.isTouch&&setTimeout(ee.getContextualUIManager().hideContextualMenu)}),I.onMarkupReordered=g.subscribe("onMarkupReordered",ze)),!P){var r=g.buildPanel({panelTitle:R||k,noSlideLabel:V,createSlideLabel:T,contextualCmdList:at(),quickAccessBtnList:st()});B&&g.setDragContent(B),g.setReadOnlyFlag(A);var a={id:"DesignReview",className:"DMUSlidesPanel",title:E.slidePanelTitle,closeButtonFlag:!1,showTitleFlag:!1,icon:"fonticon fonticon-DMUSlidePanelIcon DMUSlidePanelIcon",immersiveFrame:ee.getImmersiveFrame(),viewerFrame:ee.getViewerFrame(),content:r,minWidth:Fe(),widthStep:je(),minHeight:160,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea,onPanelResizeCB:function(e){g&&g.resizePanel(e)},onPanelResizedCB:function(e){e.currentDockArea!==WUXDockAreaEnum.RightDockArea&&e.currentDockArea!==WUXDockAreaEnum.LeftDockArea||e.widthModifiedInteractively&&(sessionStorage.setItem("DMUSlidesExpFlag_"+widget.id,"true"),sessionStorage.setItem("DMUSlidesWidth_"+widget.id,e.width)),g&&g.resizePanel(e)}};P=new u(a)}if(g){g.setPanelActiveFlag(pe),g.resizePanel({width:P.getWidth(),height:P.getHeight()});let e=v.getManager({name:"DMU2DSheetManager",context:ee});e&&e.isADocumentDisplayed()?g.enableDragContent(!1):g.enableDragContent(Me)}Ae(),J.setPlayMode(A),nt()}}function ut(e){g||gt(),e.titleEditionAllowed=e.isEditable()&&!A,null!==e.index&&void 0!==e.index?Z.splice(e.index,0,e):Z.push(e),g&&(g.addSlide(e),1===Z.length&&P.setMinWidth(Fe()),"DMUFormat"!==e.slide.getType()&&ke(e.id)),P&&P.setWidthStep(g.getColumnWidthStep()),nt()}fe.onEndProgressiveLoad=he.subscribe({event:"onEndProgressiveLoad"},Pe),this.editMarkupName=function(e){if(ne&&g&&e&&e.getPlmID){let t;for(let n=0;n<Q.length;n++)if(Q[n].id===e.getPlmID()){t=e.getPlmID();break}t&&g.editMarkupName(t)}},this.getRepliedSlide=function(){return z},this.getActiveThumbnailCtxMenuPosition=function(){return ge.clone()},this.setSlideFilteringAvailability=function(e){ue=e,g&&g.setPanelQuickAccessCommands(st())},this.setListOfFilteredSlides=function(e){ce=e&&e.length?e.slice():[];var t=[];Z.forEach(function(e){-1!==ce.indexOf(e.slide)&&t.push(e.id)}),g&&g.setListOfVisibleSlides(t)},this.setActiveFlag=function(e){var t;if(e!==K)if(K=e){for(tt(),t=0;t<Y.length;t++)J.addSlide(Y[t]);le&&J.setActiveSlide(le)}else{if(ce.length=0,g){g.cleanPanel();var n=Object.keys(I);for(t=0;t<n.length;t++)g.unsubscribe(I[n[t]]);Z.length=0,I={}}P&&(P.setPanelVisibilityFlag(!1),P.clean()),W&&clearInterval(W),q&&clearInterval(q),H&&clearInterval(H),P=g=q=W=H=null}},this.getActiveFlag=function(){return K},this.setPanelActiveFlag=function(e){pe=e,g&&g.setPanelActiveFlag(pe),Xe()},this.getPanelActiveFlag=function(){return pe},this.addSlide=function(e,t,n){if(!K||!e)return;var i;if(Te(),n)i=n;else{var r=o.getReviewContext({viewer:ee.getViewer()});if(!r||r&&!r.getCurrentSessionMarkup())return;i=r.getCurrentSessionMarkup()}Z.length||e.parentID||(e.parentID="default");let a=Ue(e);for(var l=0;l<Z.length;l++)if(Ue(Z[l].slide)===a)return;-1===Y.indexOf(e)&&("number"==typeof t?Y.splice(t,0,e):Y.push(e));var s=e.getAttribute("sOwner"),d={slide:e,id:Ue(e),parentID:e.parentID,parentSlideID:e.getAttribute("sParentSlideID"),index:t,isEditable:function(){return!e.isReadOnly()}};"DMUSlide"===e.getType()||"DMUFormat"===e.getType()?(d.title=e.getAttribute("sName"),d.icon="DMUFormat"===e.getType()?C.getWebappsAssetUrl("DMUPlaySlide","icons/22/I_DMUFormat.png"):void 0,d.img=e.getPreview(),d.isActiveSlide=!i.isImporting()):d.text=e.getAttribute("sTextContents"),s&&s.length?y.getUserName(s,function(t){d.userName=t,d.userColor=y.getUserColor(s),d.userPic=y.getUserImageURL(s),d.defaultUserPic=C.getWebappsAssetUrl("DMUBaseUI","icons/I_DefaultUserPic.png"),d.date=e.getAttribute("fCreationDate"),d.dragContent=e.getAssociatedHighlightData?e.getAssociatedHighlightData():null,ut(d)}):(d.dragContent=e.getAssociatedHighlightData?e.getAssociatedHighlightData():null,ut(d))},this.removeSlide=function(e){if(K&&e){Te();for(let t=Z.length-1;t>=0;t--)(Z[t].slide===e||Z[t].parentSlideID&&e.getAttribute("sUuid")===Z[t].parentSlideID)&&(Y.splice(Y.indexOf(e),1),g&&g.removeSlide(Z[t].id),Z.splice(t,1));nt()}},this.addReply=function(e){$.push(e),e.webMarkup=e.content.isWebMarkup(),g&&g.addReply(e)},this.forcePanelVisibility=function(){P&&P.ensureVisible()},this.addMarkup=function(e){var t=o.getReviewContext({viewer:ee.getViewer()}),n=t?t.getValidation():null,i=t?t.getCurrentSessionMarkup():null;t&&e&&(n||i)&&(g||gt(),Q.push(e),e.allowSlideReorder=!0,e.webMarkup=e.content.isWebMarkup(),g&&g.addMarkup(e))},this.updateSlide=function(e,t){if(K&&e&&t){if(t.uuid)for(var n=0;n<Z.length;n++)if(Z[n].slide===e){let t=Z[n].id;return Z[n].id=Ue(e),void(g&&g.updateSlide(t,{id:Z[n].id}))}if(g){let n=Ue(e);g.updateSlide(n,t),X&&X.has(n)&&X.get(n).forEach(e=>{t.name&&e.setThumbnailTexts({title:t.name}),t.img&&e.setPreview(t.img),Object.prototype.hasOwnProperty.call(t,"highlight")&&(e.setInformationIcon(t.highlight?C.getWebappsAssetUrl("DMUBaseUI","icons/32/")+"I_DMU_ReviewHighlight.png":""),t.highlight&&(e.setIsDraggable(!0),e.setFavoriteDivDragContent(t.highlight)))})}}},this.updateSlideEditableFlag=function(e){if(K&&e)for(var t=0;t<Z.length;t++)if(Z[t].slide===e)return Z[t].titleEditionAllowed=Z[t].isEditable()&&!A,void(g&&g.updateSlide(Z[t].id,{titleEditionAllowed:Z[t].titleEditionAllowed}))},this.update=function(){if(K&&Z)for(var e=0;e<Z.length;e++)Z[e].titleEditionAllowed=Z[e].isEditable()&&!A,g&&g.updateSlide(Z[e].id,{titleEditionAllowed:Z[e].titleEditionAllowed})},this.setPlayMode=function(e){if(K&&A!==e){if(A=e,Te(),Xe(),g){if(g.setReadOnlyFlag(A),g.setPanelSubMenuCommands(at()),g.setPanelQuickAccessCommands(st()),Z)for(var t=0;t<Z.length;t++)Z[t].titleEditionAllowed=Z[t].isEditable()&&!A,g.updateSlide(Z[t].id,{titleEditionAllowed:Z[t].titleEditionAllowed,checkFlag:!A&&void 0});g.resetSlideDisplayHistory(),le&&g.setActiveSlide(Ue(le))}dt(o.getReviewContext({viewer:ee.getViewer()}).getValidation())}},this.getPlayMode=function(){return A},this.setVisibleFlag=function(e){K&&(ne=e,nt())},this.getVisibleFlag=function(){return ne},this.getActiveSlide=function(){return le},this.getSlideRepresentation=function(e,t){let n=Z.findIndex(t=>t.id===e);if(n>=0){X||(X=new Map);let i=new c({id:e,data:Z[n].slide,displayMode:t,displayPrefix:!1,width:202,height:127,displayTitleAndIcon:re,title:Z[n].title,allowCtxMenu:!1,isCheckable:!1,clickCB:Be,preview:Z[n].slide.getPreview(),allowTitleEdition:!1});return X.has(e)?X.get(e).push(i):X.set(e,[i]),{getDiv:i.getContent,updateDisplayMode:i.updateDisplayMode,remove:()=>{if(X){let t=X.get(e);t&&(t.splice(t.indexOf(i),1),0===t.length&&X.delete(e)),i.clear()}}}}},this.setPanelOptions=function(e){if(K&&e){Te();var t,n=Object.keys(e);for(t=0;t<n.length;t++){if("panelTitle"===n[t]&&(R=e.panelTitle,g&&g.setPanelTitle(R||k)),"noSlideLabel"===n[t]&&(V=e.noSlideLabel,g&&g.setNoSlideLabel(V)),"createSlideLabel"===n[t]&&(T=e.createSlideLabel,g&&g.setCreateSlideLabel(T)),"editingFormats"===n[t]){oe=e.editingFormats,g&&g.setPanelSubMenuCommands(at()),g.setPanelQuickAccessCommands(st());var i=o.getReviewContext({viewer:ee.getViewer()});g.allowReplies(i&&i.getValidation()&&!oe),g.setAllowMarkupReorderFlag(Boolean(i&&i.getValidation())),g.setAllowSlideReorderFlag(Boolean(i)),P&&(P.setMinWidth(Fe()),P.setWidthStep(je())),Ae()}"playMode"===n[t]&&J.setPlayMode(e.playMode),"beforeApplySlideCB"===n[t]&&(j=e.beforeApplySlideCB),"afterApplySlideCB"===n[t]&&(N=e.afterApplySlideCB)}}},this.setActiveSlide=function(e,t){if(K){Te();var n=!0;if(n){for(var i=0;i<ae.length;i++)if((ae[i].slide?ae[i].slide.getAttribute("sID"):null)===(e?e.getAttribute("sID"):null)){n=!1;break}n&&ae.push({slide:e,options:t||{}})}1===ae.length&&function e(t,n){ae.splice(0,1),se=!0;var i=o.getReviewContext({viewer:ee.getViewer()});i.getTransientReviewBag().removeDMUObjects();var r=i?i.getValidation():null;t&&r&&(r.setCurrentMarkup(r.getRepRef(t.parentID)),dt(r));var s=i?i.getCurrentSessionMarkup():null;if(s){var d=le;if(le=t,Xe(),le){var u,c=a.get();for(u=c.length-1;u>=0;u--)c[u].pathElement.getLastElement(!0).getDMUType&&a.remove(c[u]);for(u=(c=l.get()).length-1;u>=0;u--)c[u].pathElement.getLastElement(!0).getDMUType&&l.remove(c[u]);if(!i.isReadOnly()&&!s.isReadOnly()){var p=h.buildPathElement(le.getNode());a.add({pathElement:p}),J.updateSelectedSlides([le])}}g&&g.setActiveSlide(Ue(le));var m=M.giveDMUApplicativeContextManager({context:he});(m?m.getApplicativeControllers():[]).forEach(function(e){e.setAppViewpointManipFlag&&e.setAppViewpointManipFlag(!le)}),O({context:he,slide:t,opts:n,onBeforeApplySlide:function(){Ce&&g.setInProgress(Ce,!1),g&&(Ce=Ue(le),g.setInProgress(Ce,!0)),j&&j(d,le),De&&De.fireEvent("onDMUSlideStartDisplay",{dmuObject:le})},onSlideActivated:function(t){n.afterSlideActivationCB&&n.afterSlideActivationCB(d,t.slide),N&&N(d,t.slide),De&&De.fireEvent("onDMUSlideDisplayed",{dmuObject:t.slide}),xe(),ae.length?e(ae[0].slide,ae[0].options):(se=!1,Ie(!0)),g&&(g.setInProgress(Ce,!1),Ce=null)}})}}(ae[0].slide,ae[0].options)}},this.updateSelectedSlides=function(e){if(K)for(var t,n=0;n<Z.length;n++){t=!1;for(var i=0;i<e.length;i++)if(Z[n].slide===e[i]){t=!0;break}g&&g.updateSlide(Z[n].id,{checkFlag:t})}},this.clear=function(){var e,t;if(Te(),be=1,J.setActiveFlag(!1),le=null,Y.length=0,Z.length=0,ae.length=0,De)for(t=Object.keys(me),e=0;e<t.length;e++)De.removeEvent(me[t[e]]);for(me={},t=Object.keys(fe),e=0;e<t.length;e++)he.unsubscribe(fe[t[e]]);fe={},X&&X.clear(),ot&&i.unsubscribe(ot),ot=null,L&&L.destroy(),L=null,X=j=N=De=ie=null}}}),I=[];return e.singleton({init:function(){},setActiveSlide:e=>O(e),getDMUSlidesController:function(e){var t;if(e&&e.context)for(var n=0;n<I.length;n++)if(I[n].context===e.context){I[n].counter++,t=I[n].slidesController;break}if(e&&e.context&&!t){var i=new P(e);t={setActiveFlag:function(e){i&&i.setActiveFlag(e)},getActiveFlag:function(){if(i)return i.getActiveFlag()},setPanelActiveFlag:function(e){i&&i.setPanelActiveFlag(e)},getPanelActiveFlag:function(){if(i)return i.getPanelActiveFlag()},forcePanelVisibility:function(){if(i)return i.forcePanelVisibility()},addSlide:function(e,t,n){if(i)return i.addSlide(e,t,n)},addReply:function(e){if(i)return i.addReply(e)},addMarkup:function(e){if(i)return i.addMarkup(e)},editMarkupName:function(e,t){i&&i.editMarkupName(e,t)},removeSlide:function(e){if(i)return i.removeSlide(e)},updateSlide:function(e,t){i&&i.updateSlide(e,t)},updateSlideEditableFlag:function(e){i&&i.updateSlideEditableFlag(e)},update:function(){i&&i.update()},clear:function(){i&&i.clear()},setPlayMode:function(e){i&&i.setPlayMode(e)},getPlayMode:function(){return!!i&&i.getPlayMode()},setVisibleFlag:function(e){i&&i.setVisibleFlag(e)},getVisibleFlag:function(){if(i)return i.getVisibleFlag()},setActiveSlide:function(e,t){i&&i.setActiveSlide(e,t)},getActiveSlide:function(){if(i)return i.getActiveSlide()},getSlideRepresentation:function(e,t){if(i)return i.getSlideRepresentation(e,t)},setPanelOptions:function(e){i&&i.setPanelOptions(e)},setSlideFilteringAvailability:function(e){i&&i.setSlideFilteringAvailability(e)},setListOfFilteredSlides:function(e){i&&i.setListOfFilteredSlides(e)},updateSelectedSlides:function(e){i&&i.updateSelectedSlides(e)},getActiveThumbnailCtxMenuPosition:function(){return i?i.getActiveThumbnailCtxMenuPosition():{}},getRepliedSlide:function(){return i?i.getRepliedSlide():null}},I.push({context:e.context,slidesController:t,counter:1})}return t?Object.freeze(t):t},giveDMUSlidesController:function(e){var t;if(e&&e.context)for(var n=0;n<I.length;n++)if(I[n].context===e.context){t=I[n].slidesController;break}return t?Object.freeze(t):t},unreferenceDMUSlidesController:function(e){if(e&&e.context)for(var t=0;t<I.length;t++)if(I[t].context===e.context){I[t].counter--,I[t].counter<=0&&(I[t].slidesController.clear(),I.splice(t,1));break}}})}),define("DS/DMUBaseUIControllers/DMUReviewController",["UWA/Core","UWA/Class","DS/DMUControls/panels/DMUReviewPanel","DS/DMUBaseExperience/DMUContextManager","DS/ApplicationFrame/CommandsManager","DS/DMUBaseExperience/EXPManagerSet","DS/Core/ModelEvents","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Visualization/PathElement","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Utilities/TouchUtils","DS/CATWebUXComponents/CATWebUXPanel","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","DS/PADUtils/PADUtilsServices","DS/WebappsUtils/WebappsUtils","DS/PADUtils/PADSettingsMgt","DS/DMUBaseExperience/EXPToolsContext","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,g,u,c,p,m,f,h,v,D,C,b){"use strict";var M=t.extend({init:function(t){this._parent(t);var M,S,w,y,U,x,E,O,P,I,A,R,k,V,T,F,j,N,L,B=t||{},W=B.context,H=new a,q=i.giveEventsController({viewer:W.getViewer()}),_=m.giveDMUSlidesController({context:W}),z=!1,X=!0,G=!1,J=!1,K=-1,Z=-1,Y={},Q={},$="noType",ee=[],te=[],ne=[],ie=[],re=0,oe=!1,ae=!1,le=new e.createElement("div",{class:"thumbnailsDiv"}),se=[],de=[];let ge=[];de.statusOK={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-check",fonticonColor:"rgb(71,119,56)"},de.statusKO={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-wrong",fonticonColor:"rgb(234,79,55)"},de.statusUNK={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-i-question",fonticonColor:"#007DA3"},de.statusTBA={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attention",fonticonColor:"#007DA3"},de.requirement={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-requirement",fonticonColor:"black"},de.highlight_high={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-level-high",fonticonColor:"rgb(234,79,55)"},de.highlight_medium={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-level-medium",fonticonColor:"rgb(232,123,0)"},de.highlight_low={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-level-low",fonticonColor:"rgb(71,119,56)"},de.ca_high={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-change",fonticonColor:"rgb(234,79,55)"},de.ca_medium={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-change",fonticonColor:"rgb(232,123,0)"},de.ca_low={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-change",fonticonColor:"rgb(71,119,56)"};var ue=[de.statusUNK,de.statusOK,de.statusKO,de.requirement],ce=[de.statusTBA,de.highlight_low,de.highlight_medium,de.highlight_high,de.statusOK],pe=[];function me(e){var t=!0;if(e&&"3DPart"===e.usage)return t;var n=i.getReviewContext({viewer:W.getViewer()}),r=i.getContextViewer({viewer:W.getViewer()}).getController(),o=n&&n.getValidation()&&n.getValidation().getContext()&&n.getValidation().getContext().getJsonContextIDs()?n.getValidation().getContext().getJsonContextIDs()[0]:null,a=[],d=r.getNode({id:o});if(d){a.push(d);var g=new s(a);if(g.externalPath.length){var u=g.externalPath[0].getChildren();for(let e=0;e<u.length;e++)if(!l.isRepInstance(u[e])){t=!1;break}}}else t=!1;return t}function fe(e){if(q){let r=!1;for(var t=0;t<ge.length;t++)if(ge[t].id===e.id){r=!0;break}if(r){var n=i.getReviewContext({viewer:W.getViewer()});if(!n)return;let t=n.getValidation();if(!t)return;t&&t.getMarkups().some(t=>{let n=t.getRepRef();if(n.getPlmID&&n.getPlmID()===e.id)return q.fireEvent("onValidationObjectAttributesModificationRequest",{dmuObject:n,attr:{key:"name",value:e.title}}),!0})}}}function he(e){for(var t=0;t<ge.length;t++)if(ge[t].id===e.id&&ge[t].content){let i=ge[t].content.getMarkupContent();if(i){var n=l.buildPathElement(i.getNode());d.empty(),g.empty(),d.add({pathElement:n}),u.add({pathElement:n});let t=e.position.clone();W.getContextualUIManager()._showContextualMenu(t)}}}pe.Low=de.ca_low,pe.Medium=de.ca_medium,pe.High=de.ca_high;var ve=function(e){var t,n=e.object.getElementsByClassName("thumbnailDiv").length?e.object.getElementsByClassName("thumbnailDiv")[0]:e.object.getElementsByClassName("editableHighlightThumbDiv")[0];if(!n.getElementsByClassName("DMUCommentMainDiv").length&&!n.getElementsByClassName("thumbnail").length){var r=e.object.getElementsByClassName("slide")[0],o=e.object.getElementsByClassName("slideIcon")[0],a=te[e.id]._repRefMarkupId;if(a){var l=i.getReviewContext({viewer:W.getViewer()}).getValidation().getRepRef(a);R=te[e.id]._slideID,j=n,N=r,L=o;var s=l.getMarkupContent().getSlides();for(let e=0;e<s.length;e++)if(s[e].getAttribute("sUuid")===R)t=s[e];else if(s[e].getDMUObjects().length){var d=s[e].getDMUObjects();for(let e=0;e<d.length;e++){var g=d[e].getDMUComments?d[e].getDMUComments():[];if(g.length)for(let e=0;e<g.length;e++)if(g[e].getAttribute("sUuid")===R){t=g[e];break}}}t&&function(e){var t=f.giveDMUCommentsController({context:W});if("DMUComment"===e.getType()){var n=t.getCommentRepresentation(R,"normal").getDiv(),i=t.getCommentRepresentation(R,"light").getDiv();i.addClassName("lightCommentRepresentation"),n.addClassName("normalCommentRepresentation"),n.inject(j),i.inject(j),i.hide()}else{var r=e.getAttribute("sName"),o=_.getSlideRepresentation(e.getAttribute("sUuid"),"normal");o.getDiv().addClassName("thumbnail"),o.getDiv().inject(j),se.push(o),N.setText(r),N.title=r,L.addClassName("wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-presentation-slide"),o.getDiv().setStyles({padding:"0px"}),c.getTouchMode()&&o.getDiv().setStyles({width:"193px"})}}(t)}}},De=function(e){var t=r.getCommand("DMUEditPropertiesHdr",B.commandContext);t.setObject(e),t.begin()};function Ce(e){var t=e.path;ne[ne.length]={name:e.name,id:re,path:t},ie[re]={name:e.name,index:ne.length-1,path:t},oe=!1,re+=7}var be=function(){q.fireEvent("onUpdateValidatedRequested",!1),y.deactiveValidatedButton(),G=!1,F&&q.removeEvent(F)},Me=function(e){if("Escape"===e.key||27===e.keyCode){if(G&&be(),J)r.getCommand("DMUSetImpactedCheckHdr",B.commandContext).end(),J=!1;var t=r.getCommand("DMUAddHighlightHdr");t&&t.isRunning()&&t.end(),y.deactiveButtons()}if("Delete"===e.key||46===e.keyCode){var n=d.get();if(n.length){var i=n[0].pathElement.getLastElement();if(i.getOwner&&("DMUValidationCheck"===i.getOwner().getType()||"DMUValidationExposedPresentation"===i.getOwner().getType()))if(e.shiftKey){let e=r.getCommand("DMUQuickDeleteHdr",B.commandContext);if(e)e.begin();else{require(["DS/DMUBaseCtxCommands/DMUDeleteCmd"],function(e){var t=new e({ID:"tmpQuickDelete",context:B.commandContext});t.begin(),t.destroy(),t=null})}}else{r.getCommand("DMUDeleteHdr",B.commandContext).begin()}}}},Se=function(){var e=r.getCommand("DMUUpdateValidatedListHdr",B.commandContext);e&&!e.isRunning()&&(G=!0,e.options.arguments[0].Value="add",e.begin(),window.addEventListener("keydown",Me,!0),F=q.addEvent("onDMUValidatedCreated",function(e){if(G=!1,q.fireEvent("onUpdateValidatedRequested",!1),e){me()&&y.setAddValidatedButtonVisibilityFlag(!0);for(let n=0;n<e.validatedNames.length;n++){var t=y.addValidatedObject(e.validatedNames[n],e.validatedIcons[n]);t.getMainDiv().setAdditionalDivVisibleFlag(!0),t.getMainDiv().setSelectedFlag(!0),Ce({name:e.validatedNames[n],id:e.validatedId,path:e.validatedPaths[n]})}}else y.deactiveValidatedButton(),G=!1;q.removeEvent(F)}))};function we(e){re=0,ne=[],ie=[];var t=P.getPathElements();for(let e=0;e<t.length;e++)ne[e]={name:t[e].instanceName,id:re,path:t[e].pathElement},ie[re]={name:t[e].instanceName,index:e,path:t[e].pathElement},re+=7;e&&e()}function ye(){ee=[];let e=E.getContext()?E.getContext().getJsonContextTypes()[0]:null,t=C.getParentType(e)?C.getParentType(e):e;for(let e=0;e<ne.length;e++){let r=[],o=ne[e].id,a=ie[o].path;if("Requirement Specification"===t||"Requirement"===t||"Document"===t||"DesignSight"===t){let t=E.getNode().getChildren(),n=ne[e].path[0];t.forEach(e=>{"Validated"===e.name&&e.getDocInfo().validatedPaths[0]===n&&r.push(e)});let i=new s(r);ee[o]=i}else if(""===ie[o].instanceName&&(ee[o]=void 0),ie[o].path.externalPath)ee[o]=ie[o].path;else{for(var n=0;n<a.length;n++){var i=M.getNode({id:a[n]});r.push(i)}let e=new s(r);ee[o]=e}}oe=!0}function Ue(e){if("Check"===e.type){var t=E.getChecks();for(let n=0;n<t.length;n++)if(t[n].getPlmID()===e.id){let i=l.buildPathElement(t[n].getNode());"add"===e.updateType?d.add({pathElement:i}):(ae=!0,d.remove({pathElement:i}))}}else if("Highlight"===e.type){var n=E.getHighlights();for(let t=0;t<n.length;t++)if(n[t].getPlmID()===e.id){let i=l.buildPathElement(n[t].getNode());"add"===e.updateType?d.add({pathElement:i}):(ae=!0,d.remove({pathElement:i}))}}}function xe(e){var t=d.get(),n=t[t.length-1].pathElement.getLastElement().getOwner().getPlmID();for(let t=0;t<e.expanders.length;t++)e.expanders[t].id===n&&(Z=t)}function Ee(){d.empty();var e=r.getCommand("DMUEditPropertiesHdr",B.commandContext);e&&e.begin()}function Oe(e,t){if(e&&t){var n="noWarning",i=e.getChecks();i&&i.length>0&&("inProgress"===e.getStatus()?i.some(e=>"1"===e.getStatus())||(n="warningProgress"):"failed"===e.getStatus()?i.some(e=>"3"===e.getStatus())||(n="warningFailed"):"passed"===e.getStatus()&&(i.every(e=>"2"===e.getStatus())||(n="warningPassed"))),t.updateValidationStatusWarning(n)}}function Pe(){var e,t=i.getReviewContext({viewer:W.getViewer()});z=!0,M=i.getContextViewer({viewer:W.getViewer()}).getController(),E=t.getValidation(),O=E.getContext(),P=E.getValidated(),we(),I=E.getChecksData(),A=E.getHighlightsData(),function(){for(let t=0;t<A.length;t++){var e={_repRefMarkupId:A[t].repRefMarkupId,_slideID:A[t].slideId};te[A[t].id]=e}}(),y=new n,k={envId:h.getPlatformId(),contextId:D.getSetting("pad_security_ctx")?D.getSetting("pad_security_ctx"):void 0,source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0},V=JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:h.getPlatformId(),serviceId:"3DSpace",contextId:D.getSetting("pad_security_ctx")?D.getSetting("pad_security_ctx"):void 0,objectId:E.getPlmID(),objectType:"DMUValidationValidation",displayName:E.getName()}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}),1===P.getPathElements().length&&(me(O.getJsonContexts()[0])||(e=O.getJsonContexts()[0])&&["Drawing","Document","Requirement","DIFSheet","R2V_FeatureState"].includes(e.type))&&O.getJsonContextIDs()[0]===P.getPathElements()[0].pathElement[0]&&y.setAddValidatedButtonVisibilityFlag(!0);let a=null;if(E.getContext()){let e=E.getContext().getJsonContextTypes()[0];a=C.getParentType(e)?C.getParentType(e):e}var c;x=y.buildPanel({contextualCmdList:E.isReadOnly()?void 0:(c=[],c.push({id:"DMUEditProperties",type:"button",nls:b.launchEditProperties,icon:v.getWebappsAssetUrl("DMUControls","icons/22/")+"I_DMUEditProperties.png",cb:Ee}),c),contextNames:O?O.getJsonContextNames():null,validatedNames:E.getValidated().getValidatedInstanceNames(),checks:I,highlights:A,icons:ue,highlightIcons:ce,readOnlyFlag:E.isReadOnly(),thumbnail:le,onHighlightExpand:ve,allowEditProperties:!0,highlightDragContent:k,reviewDragContent:V,onAttachedObjClicked:De,onAddValidatedClicked:Se,panelTitle:E.getName()?E.getName():S,maturity:E.getCurrentState(),status:E.getStatus(),editionMode:w,frmWindow:W,ctxViewer:i.getContextViewer({viewer:W.getViewer()}),contextType:a});var m={id:"DMUReviewPanel",className:"DMUReviewPanel",title:"Review",showTitleFlag:!1,icon:"fonticon fonticon-wux-ui-3ds-review wux-ui-3ds-review DMUReviewPanelIcon",immersiveFrame:W.getImmersiveFrame(),viewerFrame:W.getViewerFrame(),closeButtonFlag:!1,content:x,minWidth:y?y.getColumnMinimumWidth():273,widthStep:y?y.getColumnWidthStep():240,minHeight:160,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea};function f(){let e=[];O&&O.getJsonContextIDs().length&&e.push(O.getJsonContextIDs()[0]);for(let t=0;t<P.getPathElements().length;t++){let n=P.getPathElements()[t];e.push(n.pathElement[n.pathElement.length-1])}if(O&&"R2V_FeatureState"===O.getJsonContextTypes()[0]){let e;(e=t.getReviewCtxInformation()&&t.getReviewCtxInformation().loadedR2VInfo?t.getReviewCtxInformation().loadedR2VInfo:t.getValidation().getContext().getJsonContexts()[0].loadedR2VInfo).forEach(e=>{if(e.id===O.getJsonContextIDs()[0]){let n=e.info[0].icon,i=e.info[0]["ds6w:label"],r=x.getElementsByClassName("validatedObjectExpander");for(let t=0;t<r.length;t++)if(""!==P.getPathElements()[t].instanceName){let n=e.info[0].icon;y.updateHeaderIcon(r[t].id,n)}else y.updateHeaderIcon(r[t].id,n);var t=x.getElementsByClassName("contextObjectExpander");for(let e=0;e<t.length;e++)y.updateHeaderIcon(t[e].id,n),y.updateHeaderLabel(t[e].id,i)}})}else O&&e.length>0&&M.getAttributes({ids:e,attributes:["type_icon_url"],callbacks:{onComplete:function(e){let t=e[O.getJsonContextIDs()[0]].type_icon_url,n=e[O.getJsonContextIDs()[0]]["ds6w:label"],i=x.getElementsByClassName("validatedObjectExpander");for(let n=0;n<i.length;n++){var r=P.getPathElements()[n].pathElement[P.getPathElements()[n].pathElement.length-1];if(""!==P.getPathElements()[n].instanceName){let t=e[r];y.updateHeaderIcon(i[n].id,t.type_icon_url)}else y.updateHeaderIcon(i[n].id,t)}var o=x.getElementsByClassName("contextObjectExpander");for(let e=0;e<o.length;e++)y.updateHeaderIcon(o[e].id,t),y.updateHeaderLabel(o[e].id,n)},onFailure:function(){let e=t.getReviewCtxInformation().tempObjectInfo.icon,n=x.getElementsByClassName("validIcon");for(let t=0;t<n.length;t++)n[t].src=e;var i=x.getElementsByClassName("ctxIcon");for(let t=0;t<i.length;t++)i[t].src=e;return null}}})}U=new p(m),f(),y&&(Y.updateIconValidated=y.subscribe("updateIconValidated",f));var R,j=[];for(R=0;R<I.length;R++)if(0!==I[R].requirements.length){let e;for(e=0;e<I[R].requirements.length;e++)j.push(I[R].requirements[e].getPlmID())}j.length>0&&M.getAttributes({ids:j,attributes:["label","type_icon_url","ds6w:status"],callbacks:{onComplete:function(e){if(e){var t=x.getElementsByClassName("requirement");for(let i=0;i<t.length;i++){var n=t[i].getText();t[i].setText(e[n].label),t[i].title=e[n].label}}},onFailure:function(){return null}}}),window.addEventListener("keydown",Me,!0),Oe(E,y),Y.onReviewStatusChangeRequest=y.subscribe("onReviewMaturityChangeRequest",function(){var e=r.getCommand("DMUReviewMaturityChangeHdr",B.commandContext);e&&e.begin()}),Y.onReviewStatusChangeRequest=y.subscribe("onReviewStatusChangeRequest",function(){var e=r.getCommand("DMUReviewStatusChangeHdr",B.commandContext);e&&e.begin()}),Y.onValidatedSelected=y.subscribe("onValidatedSelected",function(e){var t=d.get();for(let e=t.length-1;e>=0;e--)if(t[e].pathElement.getLastElement().getOwner){var n=t[e].pathElement.getLastElement().getOwner().getType();if("DMUValidationCheck"===n||"DMUValidationExposedPresentation"===n){ae=!0;var i=t[e].pathElement;g.remove({pathElement:t[e].pathElement}),d.remove({pathElement:t[e].pathElement}),y.unSelectExpander($,i.getLastElement().getOwner?i.getLastElement().getOwner().getPlmID():void 0)}}!function(e){oe||ye();var t=e.element.header,n=e.element.getContent().id;if(t===(O=E.getContext()).getJsonContextNames()[0]&&"Requirement"!==O.getJsonContextTypes()[0]){var i=[],r=M.getNode({id:O.getJsonContextIDs()[0]});i.push(r);var a=new s(i);ee[n]=a}if(!0===e.element.isSelected())if(e.event&&e.event.shiftKey&&K>-1)if(-1!==K){d.add({pathElement:ee[n]}),g.add({pathElement:ee[n]});var u=ie[n].index>ie[K].index+1?ie[K].index+1:ie[n].index,c=ie[n].index>ie[K].index-1?ie[n].index:ie[K].index-1;for(let t=u;t<=c;t++)t>=u&&t<=c&&(e.validatedRects[t].getMainDiv().isSelected()||e.validatedRects[t].getMainDiv().setSelectedFlag(!0))}else d.add({pathElement:ee[n]}),g.add({pathElement:ee[n]}),K=n;else["Requirement Specification","Requirement"].includes(O.getJsonContextTypes()[0])&&o.getManager({name:"DMU2DSheetManager",context:W}).setCurrentElement({elementID:ee[n].getLastElement(!0).modelIdentification?ee[n].getLastElement(!0).modelIdentification:ee[n].getLastElement(!0).getDocInfo().validatedPaths[0]}),e.element.isCheckBoxClicked()||!event||event.shiftKey||event.ctrlKey||(d.empty(),g.empty()),ee[n]&&(d.add({pathElement:l.buildPathElement(ee[n].getLastElement(!0))}),g.add({pathElement:ee[n]}),K=n)}(e)}),Y.onContextSelected=y.subscribe("onContextSelected",function(e){!function(e){var t=M.getNode({id:O.getJsonContextIDs()[0]}),n=l.buildPathElement(t);!0===e.element.isSelected()?(e.event.ctrlKey||(d.empty(),g.empty()),d.add({pathElement:n}),g.add({pathElement:n})):(ae=!0,d.remove({pathElement:n}),g.remove({pathElement:n}))}(e)}),Y.onExpanderCtxMenuRequired=y.subscribe("onExpanderCtxMenuRequired",function(e){!function(e){var t=d.get();for(let e=0;e<t.length;e++){var n=t[e].pathElement.getLastElement().getDMUType?t[e].pathElement.getLastElement().getDMUType():void 0;!n||"Checks"!==n&&"Highlights"!==n||(ae=!0,u.remove({pathElement:t[e].pathElement}),d.remove({pathElement:t[e].pathElement}))}let i="Check"===e.type?l.buildPathElement(E.getNode().getChildByName("Checks")):l.buildPathElement(E.getNode().getChildByName("Highlights"));i.getLastElement().getOwner().setReadOnly(!w),d.add({pathElement:i}),u.add({pathElement:i});var r=e.position.clone();W.getContextualUIManager()._showContextualMenu(r)}(e)}),Y.onExpanderSelectionRequested=y.subscribe("onExpanderSelectionRequested",function(e){!function(e){var t=d.get();if(e.event&&e.event.shiftKey&&Z>-1){var n=e.index>Z?Z:e.index,i=e.index>Z?e.index:Z;if(e.expanders[n].type===e.expanders[i].type)for(let t=0;t<e.expanders.length;t++)t>=n&&t<=i?e.expanders[t].expander.getMainDiv().setSelectedFlag(!0):Ue({id:e.expanders[t].id,type:e.expanders[t].type,index:t,updateType:"remove"})}else{var r;if(t.length)if("DMUValidationExposedPresentation"===(r=t[0].pathElement.getLastElement().getDMUType()&&"DMUComment"===t[0].pathElement.getLastElement().getDMUType()?"Highlight":t[0].pathElement.getLastElement().getOwner?t[0].pathElement.getLastElement().getOwner().getType():void 0)?r="Highlight":"DMUValidationCheck"===r&&(r="Check"),e.expanders[e.index].type!==r){for(let e=t.length-1;e>=0;e--){var o=t[e].pathElement;ae=!0,"Validated"!==r&&"Context"!==r&&y.unSelectExpander($,o.getLastElement().getOwner?o.getLastElement().getOwner().getPlmID():void 0)}d.empty(),g.empty(),"Validated"===r&&y.unSelectAllValidated($)}else e.expanders[e.index].expander.getMainDiv().isCheckBoxClicked()||!event||event.shiftKey||event.ctrlKey||t[0].pathElement.getLastElement().getDMUType()&&"DMUComment"===t[0].pathElement.getLastElement().getDMUType()||(ae=!0,g.empty());Z=e.index}Ue({id:e.expanders[e.index].id,type:e.expanders[e.index].type,index:e.index,updateType:"add"})}(e)}),Y.onExpanderUnselectRequested=y.subscribe("onExpanderUnselectRequested",function(e){!function(e){if("Check"===e.type){var t=E.getChecks();for(let n=0;n<t.length;n++)if(t[n].getPlmID()===e.id){ae=!0;let i=l.buildPathElement(t[n].getNode());d.remove({pathElement:i}),d.get().length?xe(e):Z=-1}}else if("Highlight"===e.type){var n=E.getHighlights();for(let t=0;t<n.length;t++)if(n[t].getPlmID()===e.id){ae=!0;let i=l.buildPathElement(n[t].getNode());d.remove({pathElement:i}),d.get().length?xe(e):Z=-1}}else if("Validated"===e.type){var i=e.id;ae=!0,ee[i]&&(d.remove({pathElement:l.buildPathElement(ee[i].getLastElement(!0))}),g.remove({pathElement:ee[i]})),K=-1}else if("Context"===e.type){var r=M.getNode({id:O.getJsonContextIDs()[0]}),o=l.buildPathElement(r);ae=!0,d.remove({pathElement:o}),g.remove({pathElement:o})}}(e)}),Y.onValidatedRemove=y.subscribe("onValidatedRemove",function(e){!function(){var e=r.getCommand("DMUUpdateValidatedListHdr",B.commandContext);e&&(e.options.arguments[0].Value="remove",e.begin());var t=q.addEvent("onValidatedSaved",function(e){"Requirement"===O.getJsonContextTypes()[0]&&y.setDropZoneVisibilityFlag(!0),y._processValidatedObjDeletion(e),d.empty(),g.empty(),we(function(){ye()}),q.removeEvent(t)})}()}),Y.onCheckAttributeChanged=y.subscribe("onCheckAttributeChanged",function(e){!function(e){var t=d.get();if(e.status){var n=[];for(let r=0;r<t.length;r++){var i=t[r].pathElement.getLastElement().getOwner().getPlmID();n.push(i),y.updateCheckStatus(i,e.status)}var r={objectIds:n,status:e.status};q.fireEvent("onCheckAttributeChanged",r)}else q.fireEvent("onCheckAttributeChanged",e)}(e)}),Y.onHighlightAttributeChanged=y.subscribe("onHighlightAttributeChanged",function(e){!function(e){var t=d.get();if(e.rating){var n=[];for(let r=0;r<t.length;r++){var i=t[r].pathElement.getLastElement().getOwner().getPlmID();n.push(i),y.updateHighlightSeverity(i,e.rating)}var r={objectIds:n,rating:e.rating};q.fireEvent("onHighlightAttributeChanged",r)}else q.fireEvent("onHighlightAttributeChanged",e)}(e)}),Y.onRequirementAddRequested=y.subscribe("onRequirementAddRequested",function(e){!function(e){q.fireEvent("requirementAddRequested",e)}(e)}),Y.onRequirementRemoved=q.addEvent("onRequirementRemoved",function(e){y.removeRequirement(e),(t=t||i.getReviewContext({viewer:W.getViewer()}))&&t.getValidation().getChecks().forEach(t=>{t._sPlmID&&t.removeJsonRequirement(e.requirementId)})}),Y.onObjectRemoveRequested=y.subscribe("onRequirementRemoveRequested",function(e){!function(e){q.fireEvent("onRequirementRemoveRequested",e)}(e)}),Y.onImpCheckCancelCmd=y.subscribe("onImpCheckCancelCmd",function(){var e=r.getCommand("DMUSetImpactedCheckHdr",B.commandContext);e&&e.isRunning()&&e.end()}),Y.onUpdateValidatedListCancel=y.subscribe("onUpdateValidatedListCmdCancel",function(){var e=r.getCommand("DMUUpdateValidatedListHdr",B.commandContext);e&&e.isRunning()&&(e.end(),y.deactiveValidatedButton(),G=!1,F&&q.removeEvent(F))}),Y.onImpCheckRemoveRequested=y.subscribe("onImpCheckRemoveRequested",function(e){!function(e){var t,n;if(E){var i=E.getHighlights();if(i)for(let n=0;n<i.length;n++)if(i[n].getPlmID()===e.highlightId){t=i[n];break}var r=E.getChecks();if(r)for(let t=0;t<r.length;t++)if(r[t].getPlmID()===e.checkId){n=r[t];break}}t&&n&&q.fireEvent("onRemoveImpactedCheckRequested",{highlight:t,check:n})}(e)}),Y.onIssueAddRequested=y.subscribe("onIssueAddRequested",function(e){var t=d.get();for(let n=0;n<t.length;n++)t[n].pathElement.getLastElement().getOwner&&t[n].pathElement.getLastElement().getOwner().getPlmID()!==e.id&&(d.remove(t[n]),n--);var n,i,o=r.getCommand("CATWebUXGenerateIssueHdr",B.commandContext);o&&o.begin(),n=q.addEvent("onTICCreationComplete",function(e){y.deactiveButtons(),y.addIssue({highlightId:e.attachmentIDs[0],name:e.name,id:e.ticID}),q.removeEvent(n),q.removeEvent(i)}),i=q.addEvent("onTICCreationCancel",function(){y.deactiveButtons(),q.removeEvent(n),q.removeEvent(i)}),window.addEventListener("keydown",Me,!0)}),Y.onCaAddRequested=y.subscribe("onCaAddRequested",function(e){var t=d.get();for(let n=0;n<t.length;n++)t[n].pathElement.getLastElement().getOwner&&t[n].pathElement.getLastElement().getOwner().getPlmID()!==e.id&&(d.remove(t[n]),n--);var n,i,o=r.getCommand("CATWebUXGenerateCAHdr",B.commandContext);o&&o.begin(),n=q.addEvent("onTICCreationComplete",function(e){y.deactiveButtons(),y.addCa({highlightId:e.attachmentIDs[0],name:e.name,id:e.ticID}),q.removeEvent(n),q.removeEvent(i)}),i=q.addEvent("onTICCreationCancel",function(){y.deactiveButtons(),q.removeEvent(n),q.removeEvent(i)}),window.addEventListener("keydown",Me,!0)}),Q.onDMUPreferencesChanged=q.addEvent("onDMUPreferencesChanged",function(e){if(e&&void 0!==e.DMUDisplaySlideTitle)for(let t=0;t<se.length;t++)se[t]&&se[t].getContent().getParents().length&&se[t].setTitleAndIconSectionVisibleFlag(e.DMUDisplaySlideTitle)}),Q.onExpandRequested=q.addEvent("onExpandRequested",function(e){"DMUValidationCheck"===e?y.expandAll("Checks"):y.expandAll("Highlights")}),Q.onCollapseRequested=q.addEvent("onCollapseRequested",function(e){"DMUValidationCheck"===e?y.collapseAll("Checks"):y.collapseAll("Highlights")}),Q.onValidatedCmdCancel=q.addEvent("onValidatedObjCancelRequested",function(){be()}),Q.onDMUCheckRemoveRequested=q.addEvent("onDMUCheckRemoveRequested",function(e){y.updateCheckDisplay(e),Oe(E,y)}),Q.onRequirementAdded=q.addEvent("onRequirementAdded",function(e){y.addRequirement(e),(t=t||i.getReviewContext({viewer:W.getViewer()}))&&t.getValidation().getChecks().forEach(t=>{t._sPlmID&&t.addJsonRequirement({type:"Requirement",id:e.requirementId})})}),Q.onDMUHighlightRemoveRequested=q.addEvent("onDMUHighlightRemoveRequested",function(e){y.updateHighlightDisplay(e)}),Q.onHighlightAttributeSaved=q.addEvent("onAttributeSaved",function(e){y.updateImpactedCheckDisplay(e),void 0!==e.status&&e.object&&Oe(e.object.getParent(),y)}),Q.onImpCheckFailed=q.addEvent("onImpCheckFailed",function(){y.deactiveButtons()}),Q.onReviewCtxLoaded=q.addEvent("onReviewCtxLoaded",function(e){y.updateContextInformations(e)}),Q.onHideShowThumbnailRequested=q.addEvent("onHideShowThumbnailRequested",function(){y.highlightUpdatePreview()}),Q.onUpdateImpactedChecksList=q.addEvent("onUpdateImpactedChecksList",function(e){"add"===e.mode?y.updateImpactedCheck({highlightId:e.highlight.getPlmID(),checkId:e.check.getPlmID()}):y.removeImpactedCheck({highlightId:e.highlight.getPlmID(),checkId:e.check.getPlmID()}),y.deactiveButtons()}),Q.onReviewObjectAttributesModified=q.addEvent("onReviewObjectAttributesModified",function(e){e&&e.object&&e.attr&&e.object.getValType&&"DMUValidationValidation"===e.object.getValType()&&e.attr.forEach(function(t){t.sValidationState&&(y.updateMaturityStatus({status:e.object.getStatus()}),Oe(e.object,y)),t.currentState&&y.updateMaturityStatus({maturity:e.object.getCurrentState()})})}),Y.onImpCheckRequested=y.subscribe("onImpCheckRequested",function(e){var t;if(E){var n=E.getHighlights();if(n)for(let i=0;i<n.length;i++)if(n[i].getPlmID()===e.objectId){t=n[i];break}}var i=r.getCommand("DMUSetImpactedCheckHdr",B.commandContext);i&&(i.setHighlightObject(t),i.begin()),J=!0,window.addEventListener("keydown",Me,!0)}),Y.onCheckCreationRequested=y.subscribe("onCheckCreationRequested",function(){var e=r.getCommand("DMUAddCheckHdr",B.commandContext);e&&e.begin()}),Y.onMarkupCreationRequested=y.subscribe("onMarkupCreationRequested",function(){var e=r.getCommand("DMUReviewMarkupHdr",B.commandContext);e&&e.begin()}),Y.onHighlightCreationRequested=y.subscribe("onHighlightCreationRequested",function(){var e=r.getCommand("DMUAddHighlightHdr",B.commandContext);e&&e.begin()}),Y.onMarkupCtxMenuRequired=y.subscribe("onMarkupCtxMenuRequired",he),Y.onMarkupRenamed=y.subscribe("onMarkupRenamed",fe),Q.onTransitionRequested=q.addEvent("setEditionMode",function(e){w=e.editionMode,y.setPanelReadOnlyFlag(e)}),Q.onValidationObjectDeleted=q.addEvent("onValidationObjectDeleted",function(e){if(e&&e.dmuObject&&e.dmuObject[0].getType&&"Markup"===e.dmuObject[0].getType())y&&y.removeMarkup(e);else if(e&&e.dmuObject[0]&&"DMUValidationExposedPresentation"===e.dmuObject[0].getType()){var t=e.dmuObject[0].getParent();if(t){var n,i=t.getRepRef(e.dmuObject[0].getAttribute("sRepRefMarkupID")),r=e.dmuObject[0].getPresentationSlideID(),o=t.getHighlights();for(let t=0;t<o.length;t++)if(o[t]!==e.dmuObject[0]&&o[t].getPresentationSlideID()===r){n=o[t];break}var a=i.getMarkupContent();if(a){var l,s=a.getSlides();for(let e=0;e<s.length;e++){if(s[e].getAttribute("sUuid")===r){l=s[e];break}if(s[e].getDMUObjects().length){var d=s[e].getDMUObjects();for(let e=0;e<d.length;e++){var g=d[e].getDMUComments?d[e].getDMUComments():[];if(g.length)for(let e=0;e<g.length;e++)if(g[e].getAttribute("sUuid")===r){l=g[e];break}}}}l&&l.setAssociatedHighlightData(n?JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:h.getPlatformId(),serviceId:"3DSpace",contextId:D.getSetting("pad_security_ctx")?D.getSetting("pad_security_ctx"):void 0,objectId:n.getPlmID(),objectType:n.getType(),displayName:n.getName()}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}):void 0)}}}}),Q.tokenDMUValidatedCreated=q.addEvent("onReviewCtxUpdateOrDropValidated",function(e){if((O=E.getContext())&&O.getJsonContexts()&&O.getJsonContexts()[0].type&&-1!==["Document","Requirement","Requirement Specification","Drawing","SIMItfSimulation","PLMPIMMetricReference","DIFLayout","DIFSheet","DesignSight","R2V_FeatureState"].indexOf(O.getJsonContexts()[0].type)){y.setContextType(O.getJsonContexts()[0].type);for(let n=0;n<e.validatedNames.length;n++){let i=O.getJsonContexts()[0].type;"R2V_FeatureState"!==i&&"Document"!==i&&"Drawing"!==i&&"DIFSheet"!==i&&"Requirement"!==i||y.setAddValidatedButtonVisibilityFlag(!0),"Requirement"===a&&y.setDropZoneVisibilityFlag(!1);var t=y.addValidatedObject(e.validatedNames[n],e.validatedIcons[n]);t.getMainDiv().setAdditionalDivVisibleFlag(!0),t.getMainDiv().setSelectedFlag(!0),Ce({name:e.validatedNames[n],id:e.validatedId,path:e.validatedPaths[n]})}"Requirement"!==O.getJsonContexts()[0].type&&"DesignSight"!==O.getJsonContexts()[0].type&&"Requirement Specification"!==O.getJsonContexts()[0].type&&"DIFLayout"!==O.getJsonContexts()[0].type&&q.removeEvent(Q.tokenDMUValidatedCreated)}}),T=d.onPostRemove(function(){ae||y.unSelectAllExpanders($),ae=!1,d.get().length||(Z=-1)})}this.addReview=function(){y||Pe()},this.addCheck=function(e){g.empty(),y&&y.addNewCheck(e),Oe(E,y)},this.addHighlight=function(e){if(d.empty(),g.empty(),y){var t={_repRefMarkupId:e.repRefMarkupId,_slideID:e.slideObject.getAttribute("sUuid")};if(te[e.id]=t,"DMUComment"===e.slideObject.getType()){var n=f.giveDMUCommentsController({context:W});e.normalComment=n.getCommentRepresentation(e.slideObject.getAttribute("sUuid"),"normal").getDiv(),e.lightComment=n.getCommentRepresentation(e.slideObject.getAttribute("sUuid"),"light").getDiv()}y.addNewHighlight(e)}},this.addMarkup=function(e){y&&y.addNewMarkup(e),ge.push(e)},this.editMarkupName=function(e){if(X&&y&&e&&e.getPlmID){let t;for(let n=0;n<ge.length;n++)if(ge[n].id===e.getPlmID()){t=e.getPlmID();break}t&&y.editMarkupName(t)}},this.subscribe=function(e,t){if(e&&t)return H.subscribe({event:e},t)},this.setVisibleFlag=function(e){z&&(X=e,U&&U.setPanelVisibilityFlag(X))},this.setEditionMode=function(e){w=e},this.clear=function(){if(q){var e=Object.keys(Q);for(let t=0;t<e.length;t++)q.removeEvent(Q[e[t]])}Q={},this.setActiveFlag(!1)},this.setActiveFlag=function(e){if(e!==z&&!(z=e)){if(y){d.unsubscribe(T);var t=Object.keys(Y);for(let e=0;e<t.length;e++)y.unsubscribe(Y[t[e]]);Y={},y.cleanPanel()}U&&(U.setPanelVisibilityFlag(!1),U.clean()),U=y=null}},this.updateReviewPanelContent=function(e){y&&y.updateReviewPanelContent(e)}}}),S=[];return t.singleton({init:function(){},getDMUReviewController:function(e){var t;if(e&&e.context)for(let n=0;n<S.length;n++)if(S[n].context===e.context){S[n].counter++,t=S[n].reviewController;break}if(e&&e.context&&!t){var n=new M(e);t={addReview:function(){if(n)return n.addReview()},addCheck:function(e){if(n)return n.addCheck(e)},addMarkup:function(e){if(n)return n.addMarkup(e)},addHighlight:function(e){if(n)return n.addHighlight(e)},setVisibleFlag:function(e){if(n)return n.setVisibleFlag(e)},setEditionMode:function(e){if(n)return n.setEditionMode(e)},clear:function(){n&&n.clear()},editMarkupName:function(e){n&&n.editMarkupName(e)},updateReviewPanelContent:function(e){if(n)return n.updateReviewPanelContent(e)}},S.push({context:e.context,reviewController:t,counter:1})}return t?Object.freeze(t):t},giveDMUReviewController:function(e){var t;if(e&&e.context)for(let n=0;n<S.length;n++)if(S[n].context===e.context){t=S[n].reviewController;break}return t?Object.freeze(t):t},unreferenceDMUReviewController:function(e){if(e&&e.context)for(let t=0;t<S.length;t++)if(S[t].context===e.context){S[t].counter--,S[t].counter<=0&&(S[t].reviewController.clear(),S.splice(t,1));break}}})}),define("DS/DMUBaseUIControllers/DMUUserExperienceManager",["UWA/Core","UWA/Class","UWA/Utils","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Utilities/TouchUtils","DS/DMUBaseExperience/DMUContextManager","DS/ApplicationFrame/CommandsManager","DS/DMUBaseExperience/DMUFactory","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/EXPImportServices","DS/DMUBaseExperience/DMUModelServices","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,g,u,c,p,m,f,h){"use strict";return t.extend({init:function(t){var v,D=[],C=[],b=t.frmWindow,M=this,S=null,w={};function y(e){var t=s.getReviewContext({viewer:b.getViewer()});if(t){var n=s.getContextViewer({reviewContext:t});if(n){var i,o=r.get();if(!e.target||"textarea"!==e.target.type&&"input"!==e.target.type&&"P"!==e.target.tagName)if("Delete"===e.key||46===e.keyCode){if(!o.length)return;for(var a=[],l=0;l<o.length;l++){var g=t.getDMUObjectFromPathElement(o[l].pathElement);g&&a.push(g)}if(1===a.length&&a[0].isTextEdited&&a[0].isTextEdited())return;if(e.shiftKey||!t.getCurrentSessionMarkup()||t.getCurrentSessionMarkup()&&!t.getCurrentSessionMarkup().getActiveFlag()||t.getCurrentSessionMarkup()&&t.getCurrentSessionMarkup().getActiveFlag()&&t.getCurrentSessionMarkup().isReadOnly())if(i=d.getCommand("DMUQuickDeleteHdr",n.getCommandContext()))i.begin();else{require(["DS/DMUBaseCtxCommands/DMUDeleteCmd"],function(e){var t=new e({ID:"tmpQuickDelete",context:n.getCommandContext()});t.begin(),t.destroy(),t=null})}else if(i=d.getCommand("DMUDeleteHdr",n.getCommandContext()))i.begin();else{require(["DS/DMUBaseCtxCommands/DMUDeleteCmd"],function(e){var t=new e({ID:"tmpDelete",context:n.getCommandContext()});t.begin(),t.destroy(),t=null})}}else if(!e.ctrlKey||"c"!==e.key&&67!==e.keyCode)if(!e.ctrlKey||"x"!==e.key&&88!==e.keyCode)!e.ctrlKey||"v"!==e.key&&86!==e.keyCode||(i=d.getCommand("DMUPasteHdr",n.getCommandContext()))&&i.begin();else{if(!o.length)return;(i=d.getCommand("DMUCutHdr",n.getCommandContext()))&&i.begin()}else{if(!o.length)return;(i=d.getCommand("DMUCopyHdr",n.getCommandContext()))&&i.begin()}}}}this.clean=function(){if(b){var e;for(e=D.length-1;e>=0;e--)b.getContextualUIManager().unregister(D[e].type);for(e=C.length-1;e>=0;e--)b.getContextualUIManager().unregister(C[e].type);S&&document.removeEventListener("keyup",y),S=null,D.length=0,C.length=0,b=null}},this.pick=function(e,t){if(b)return e.x===w.x&&e.y===w.y&&t===w.type||(w={x:e.x,y:e.y,type:t||"mesh",path:b.getViewer().pick({xPix:e.x,yPix:e.y},t||"mesh",!0).path}),w.path};var U,x=[],E=[],O=!1,P=!1,I=!1;async function A(e,t,i,r){var o,a;if(e&&(t&&"DMUMarkup"===t.getType()?o=t:e.getParent?o=e.getParent():t.getParent&&(o=t.getParent()),o&&o.getType&&"DMUMarkup"===o.getType())){var l=e.getAttribute?e.getAttribute("sType"):e.type,s=g.buildComponent(i||l,t,o);if(s){var d=e.getAttribute?{}:e;if(v||(v=new c({viewer:b.getViewer(),experience:o})),e.getAttribute&&(d=await p.getObjectDefinition(e)),s.importData(d,v,o),i&&s.setAttribute("sType",i),("Slide"===l||"Format"===l)&&s.getParent()!==e.getParent()){let t=e.getObjectOverloads(),n=e.getDMUObjects("DMUCompare3D").concat(e.getDMUObjects("DMUCompare2D"));if("Slide"===l&&e.getPointedFormats&&e.getPointedFormats().length&&s.getPointedFormats&&!s.getPointedFormats().length){let i=e.getPointedFormats()[0].getDMUObjects();for(let e=0;e<i.length;e++)("DMUCompare3D"!==i[e].getType()&&"DMUCompare2D"!==i[e].getType()||!n.length)&&s.addDMUObject(await A(i[e]));t=t.concat(e.getPointedFormats()[0].getObjectOverloads()),n.length||(n=e.getPointedFormats()[0].getDMUObjects("DMUCompare3D")?e.getPointedFormats()[0].getDMUObjects("DMUCompare3D"):e.getPointedFormats()[0].getDMUObjects("DMUCompare2D")),s.setAttribute("sPointedFormats",[])}if(t.length){let e=s.getObjectOverloads();for(a=e.length-1;a>=0;a--)s.removeObjectOverload(e[a]);for(a=0;a<t.length;a++)if(t[a].target){let e=s.getParent().getOrCreateOccurrenceOverloader({idPath:t[a].target.getOccurrenceIDPath()},!0),n={};t[a].state.cColor&&t[a].state.cColor.clone&&(n.cColor=t[a].state.cColor.clone()),null!==t[a].state.fOpacity&&void 0!==t[a].state.fOpacity&&(n.fOpacity=t[a].state.fOpacity),"boolean"==typeof t[a].state.bVisible&&(n.bVisible=t[a].state.bVisible),t[a].state.mTransfoMatrix&&t[a].state.mTransfoMatrix.clone&&(n.mTransfoMatrix=t[a].state.mTransfoMatrix.clone()),s.addObjectOverload({state:n,target:e})}}let i=e.getDMUObjects("DMUCompare3D").concat(e.getDMUObjects("DMUCompare2D"));if(1===n.length&&1===i.length){let t=e.getParent().getAttribute("oLinksManager"),r=n[0].getAttribute("oSelections"),o="Compare2D"===n[0].getAttribute("sType")?n[0].getAttribute("oSheetIDs"):null;if(r&&r.length){let e=[];r.forEach(n=>{let i=t.getChildWithID(n.id);if(i){let n=i.idPath&&i.idPath.length?i.idPath:t.getOccurrenceIdPath(i.path),r=s.getParent().getOccurence({idPath:n},!0);r&&e.push({id:r.id})}}),2===e.length&&i[0].setAttribute("oSelections",e)}o&&o.length&&i[0].setAttribute("oSheetIDs",o)}}if(s.setAttribute("sID","-1"),s.setAttributes([{name:"sID",value:o.computeNewID()},{name:"sUuid",value:n.getUUID()}]),"Slide"===l||"Format"===l){var u,m=s.getDMUObjects();for(a=0;a<m.length;a++)m[a].setAttribute("sID","-1"),m[a].setAttributes([{name:"sID",value:o.computeNewID()},{name:"sUuid",value:n.getUUID()}]),m[a].afterImport(r);i?u=o.computeNewName({object:s,prefix:("DMUSlide"===s.getType()?h.slideDefaultName:h.formatDefaultName)+s.getAttribute("sName"),noSuffixIfPossible:!0,separator:"parenthesis"}):O||(u=o.computeNewName({object:s,prefix:s.getAttribute("sName")+h.copySuffix,noSuffixIfPossible:!0,separator:"parenthesis"})),u&&s.setAttribute("sName",u)}return s}}}function R(e,t){if(t&&("DMUSlide"===e.getType()||"DMUFormat"===e.getType())){var n,i,r,o=s.getReviewContext({viewer:b.getViewer()}),a=Object.keys(t);for(n=0;n<a.length;n++)if("camera"!==a[n]||t[a[n]])if("formatting"!==a[n]||t[a[n]])if("markers3D"!==a[n]||t[a[n]])if("markers2D"!==a[n]||t[a[n]])"format"!==a[n]||t[a[n]]||e.setAttribute("sPointedFormats",null);else for(i=(r=e.get2DMarkers()).length-1;i>=0;i--)e.removeDMUObject(r[i]);else for(i=(r=e.get3DMarkers()).length-1;i>=0;i--)e.removeDMUObject(r[i]);else{for(i=(r=e.getDMUObjects("DMUSection")).length-1;i>=0;i--)e.removeDMUObject(r[i]);for(i=(r=e.getObjectOverloads()).length-1;i>=0;i--)e.removeObjectOverload(r[i])}else e.updateEnvironmentOverload({target:o.getEnvironment(),state:o.getEnvironment().getEnvironmentInfo()})}}this.duplicateDMUElements=async function(e){if(e&&(e.elements||e.elementDefinitions)){var t=async function(t,n){var i=await A(t,e.parent,e.newType,e.markupRepRef);if(i){n&&n.length&&i.setAttributes(n);let t=i.getType();"DMUSlide"===t||"DMUFormat"===t?e.parent["DMUSlide"===t?"addSlide":"addFormat"](i):"DMUMarker3DSpline"===t&&i.updateProjectionPlaneDefinition({up:b.getViewer().currentViewpoint.getUpDirection(),right:b.getViewer().currentViewpoint.getSightDirection().cross(b.getViewer().currentViewpoint.getUpDirection())}),e.parent?i.afterImport(e.markupRepRef):(i.refreshNode(),i.setTemporary(!0)),R(i,e.duplicationOptions)}return i},n=[];if(e.elements&&e.elements.length)for(var i=0;i<e.elements.length;i++)n.push(e.elements[i].getAttribute("sType"));else if(e.elementDefinitions&&e.elementDefinitions.length)for(var r=0;r<e.elementDefinitions.length;r++)n.push(e.elementDefinitions[r].type);g.initFactoryOf(b.getViewer(),n);var o,a,l=[],s=e.elements&&e.elements.length?e.elements:e.elementDefinitions;if(s&&s.length)for(o=0;o<s.length;o++)(a=await t(s[o],e.attributes&&e.attributes.length&&e.attributes[o]?e.attributes[o]:null))&&l.push(a);e.cb&&(l.length?e.cb({duplicatedElements:l}):e.cb({error:"Element not duplicated"}))}else e&&e.cb&&e.cb({error:"Element not duplicated"})},this.setCCPTarget=function(e){U=null,e&&e.getType&&("DMUSlide"===e.getType()||"DMUFormat"===e.getType())&&(U=e)},this.getCCPTarget=function(){return U},this.areOccurenceOverloadsCopied=function(){return 0!==E.length},this.copySelectedDMUElements=function(e){U=null,x.length=0,E.length=0,P=!1,I=!1;var t,n=r.get(),o=s.getReviewContext({viewer:b.getViewer()});if(o){var a=o.getCurrentSessionMarkup();if(a)for(var l=a.getCurrentSlide(),d=function(e,t){if(e){var n,r,o;if(e.state){var a=e.target.getOccurrencePathElement();e.state.mTransfoMatrix?(o=e.state.mTransfoMatrix.clone(),r=(new i.Matrix4).getInverse(a.getLastElement(!0).getMatrix()),n=(new i.Matrix4).multiplyMatrices(o,r)):e.state.mPosition&&(o=(d=a)&&d.getParentPath()?(new i.Matrix4).multiplyMatrices(d.getParentPath().getWorldMatrix(),d.getLastElement(!0).getMatrix()):null,r=(new i.Matrix4).getInverse(o),n=(new i.Matrix4).multiplyMatrices(r,a.getWorldMatrix()))}var s=!1;for(let i=0;i<E.length;i++)E[i].originalPath.isEqual(t)&&(E[i].overloads.push({slideOverload:e,parent:l,transfo:void 0,transfoMatrix:n}),s=!0);s||E.push({originalPath:t.clone(),overloads:[{slideOverload:e,parent:l,transfo:void 0,transfoMatrix:n}]})}var d},g=0;g<n.length;g++)if((t=o.getDMUObjectFromPathElement(n[g].pathElement))&&"DMUOccurrenceOverloader"!==t.getType()){var c=a;if(t.isReadOnly()||!t.isEditable())continue;"DMUSlide"===t.getType()?(P||(x.length=0),P=!0,I=!1):"DMUFormat"===t.getType()?(I||(x.length=0),P=!1,I=!0):((P||I)&&(x.length=0),P=!1,I=!1,c=l),x.push({object:t,parent:c})}else{var p=a.getOrCreateOccurrenceOverloader(n[g]);p&&d(l.getOverloadForTarget(p),n[g].pathElement),n[g].pathElement.getParentPath()&&u.isInstance(n[g].pathElement.getParentPath().getLastElement(!0))&&(p=a.getOrCreateOccurrenceOverloader({pathElement:n[g].pathElement.getParentPath()}))&&d(l.getOverloadForTarget(p),n[g].pathElement)}}M.refreshCCPCommandsAvailability(),O=e},this.pasteDMUElements=async function(t){var n,a,l,d;if(x&&x.length||E&&(!E||E.length)){var c=s.getReviewContext({viewer:b.getViewer()});if(c){var p=c.getCurrentSessionMarkup();if(p){var f=p.getCurrentSlide(),h=U||f;if(h&&h.isReadOnly())return;var v=h===f,D=[],C=function(e){for(var t=0;t<t.length;t++)if(D[t].isEqual(e))return;D.push(e.clone())},M=function(){if(r.empty(),D.length){var e=[],t=[];D.forEach(function(n){e.push({pathElement:n});var i=n.getLastElement(!0);i&&(!i.getDMUType||i.getDMUType&&"DMUSlide"!==i.getDMUType()&&"DMUFormat"!==i.getDMUType())&&t.push({pathElement:n})}),r.add(e),o.add(t)}b.getViewer().render()};if(x&&x.length){var S=x.slice(),w=P||I;if(w&&t&&!1===t.createNewSlide&&h&&("Slide"===h.getAttribute("sType")||"Format"===h.getAttribute("sType"))){S=[];var y,k,V=[],T=function(e,t){e&&e.length&&(S=S.concat(e.map(function(e){return{object:e,parent:t}})))};for(n=0;n<x.length;n++)if(x[n].object&&x[n].object.getDMUObjects){if(t.formatting){T(x[n].object.getDMUObjects("DMUSection"),x[n].object),h.getDMUObjects("DMUCompare3D").length||T(x[n].object.getDMUObjects("DMUCompare3D"),x[n].object);let e=x[n].object.getDMUObjects("DMUCompare2D");if(e&&e.length){!h.getDMUObjects("DMUCompare2D").length&&e[0].getAttribute("oSheetIDs")&&h.getEnvironmentOverload()&&h.getEnvironmentOverload().state&&h.getEnvironmentOverload().state.sFocusProperty&&h.getEnvironmentOverload().state.sFocusProperty[0]&&"string"==typeof h.getEnvironmentOverload().state.sFocusProperty[0]&&e[0].getAttribute("oSheetIDs")[0]&&-1!==h.getEnvironmentOverload().state.sFocusProperty[0].indexOf(e[0].getAttribute("oSheetIDs")[0].id)&&T(e,x[n].object)}for(a=(y=x[n].object.getObjectOverloads()).length-1;a>=0;a--){for(k=!0,l=0;l<V.length;l++)V[l].target===y[a].target&&(V[l].state=y[a].state,k=!1);k&&V.push(y[a])}}t.markers3D&&T(x[n].object.get3DMarkers(),x[n].object),t.markers2D&&T(x[n].object.get2DMarkers(),x[n].object)}if(w=!1,t.camera){let t=x[x.length-1].object.getEnvironmentOverload(),n={};Object.keys(t.state).forEach(i=>{t.state[i].clone?n[i]=t.state[i].clone():n[i]=e.clone(t.state[i])}),h.getEnvironmentOverload()&&h.getEnvironmentOverload().state&&h.getEnvironmentOverload().state.sFocusProperty&&h.getEnvironmentOverload().state.sFocusProperty.length&&(n.sFocusProperty=h.getEnvironmentOverload().state.sFocusProperty.slice()),h.updateEnvironmentOverload({state:n,target:h.getEnvironmentOverload().target})}if(t.formatting){for(n=0;n<V.length;n++)h.addObjectOverload(V[n]);h.fireEvent("onDMUOverloadPropertiesChanged",{overloads:V})}t.format&&h.setAttribute("sPointedFormats",x[x.length-1].object.getAttribute("sPointedFormats"))}var F=[];for(l=0;l<S.length;l++)F.push(S[l].object.getAttribute("sType"));g.initFactoryOf(b.getViewer(),F),h||(h=p);var j,N=[];if(h){if(h.isReadOnly())return;if(w){for(n=S.length-1;n>=0;n--){var L;if("Slide"===S[n].object.getAttribute("sType")&&c.getUIManager().getFormatEditionModeFlag()&&(L="Format"),"Format"!==S[n].object.getAttribute("sType")||c.getUIManager().getFormatEditionModeFlag()||(L="Slide"),j=await A(S[n].object,p,L)){let e;if(N.push(j),"DMUSlide"===h.getType()){let t=p,n=function(){let n=t.getMarkupOwner().getParent();for(;n&&"Markup"!==n.getValType();)n=n.getParent();n&&n.isWebMarkup()&&(e=n.getRepRef(),t=e.getMarkupContent())};var B;j.getAttribute("sParentSlideID")&&h.getAttribute("sParentSlideID")&&h.getAttribute("sParentSlideID")!==j.getAttribute("sParentSlideID")||!h.getAttribute("sParentSlideID")?(j.setAttribute("sParentSlideID",void 0),t.getMarkupOwner()&&t.getMarkupOwner().getParent()&&"Reply"===t.getMarkupOwner().getParent().getValType()&&n()):!j.getAttribute("sParentSlideID")&&h.getAttribute("sParentSlideID")&&n();var W=t.getSlides();for(d=0;d<W.length;d++)if(W[d]===h){B=d+1;break}t.addSlide(j,B)}else if("DMUFormat"===h.getType()){var H;j.setAttribute("sParentSlideID",void 0);var q=p.getFormats();for(d=0;d<q.length;d++)if(q[d]===h){H=d+1;break}p.addFormat(j,H)}else if(c.getUIManager().getFormatEditionModeFlag())j.setAttribute("sParentSlideID",void 0),p.addFormat(j);else{let t=p;if(j.getAttribute("sParentSlideID")&&(j.setAttribute("sParentSlideID",void 0),t.getMarkupOwner()&&t.getMarkupOwner().getParent()&&"Reply"===t.getMarkupOwner().getParent().getValType())){let n=t.getMarkupOwner().getParent();for(;n&&"Markup"!==n.getValType();)n=n.getParent();n&&n.isWebMarkup()&&(t=(e=n.getRepRef()).getMarkupContent())}t.addSlide(j)}j.afterImport(e),R(j,t)}}if(N&&N.length){var _=m.giveDMUSlidesController({context:b});_&&_.setActiveSlide(N[0])}}else{if("DMUSlide"!==h.getType()&&"DMUFormat"!==h.getType())return;for(n=S.length-1;n>=0;n--)S[n].object&&((j=await A(S[n].object,h)).afterImport(),N.push(j))}h.refreshNode(),O&&x.forEach(function(e){"DMUSlide"===e.object.getType()||"DMUFormat"===e.object.getType()?h!==e.object&&"DMUSlide"===e.object.getType()?p.removeSlide(e.object):h!==e.object&&"DMUFormat"===e.object.getType()&&p.removeFormat(e.object):e.parent.removeDMUObject(e.object)})}if(v)for(n=0;n<N.length;n++)C(u.buildPathElement(N[n].getNode()));O&&(x.length=0,P=!1,I=!1,O=!1),U=null,M()}if(h&&E&&E.length){if(t&&!t.graphicProps&&!t.positions)return;var z=[],X=r.get();for(n=0;n<X.length;n++)X[n].pathElement.getLastElement(!0).getDMUType||z.push(X[n].pathElement.clone());var G=function(e){var n,r,o,a=h.getOverloadForTarget(e.slideOverload.target),l={},s=e.slideOverload.target.getOccurrencePathElement();if(a)for(n=Object.keys(a.state),o=0;o<n.length;o++)r=a.state[n[o]],l[n[o]]=r.clone?r.clone():r;for(n=Object.keys(e.slideOverload.state),o=0;o<n.length;o++)(!t||t&&t.graphicProps&&"cColor"===n[o]||t&&t.graphicProps&&"bVisible"===n[o]||t&&t.graphicProps&&"fOpacity"===n[o]||t&&t.positions&&("mPosition"===n[o]||"mTransfoMatrix"===n[o]))&&("mPosition"===n[o]||"mTransfoMatrix"===n[o]?l.mTransfoMatrix=(new i.Matrix4).multiplyMatrices(s.getLastElement(!0).getMatrix(),e.transfoMatrix):(r=e.slideOverload.state[n[o]],l[n[o]]=r.clone?r.clone():r));h.addObjectOverload({target:e.slideOverload.target,state:l}),h.fireEvent("onDMUOverloadPropertiesChanged",{overloads:[{target:e.slideOverload.target,state:l}]})},J=!1;if(!z.length&&h&&h.addObjectOverload)for(n=E.length-1;n>=0;n--)for(a=E[n].overloads.length-1;a>=0;a--)h!==E[n].overloads[a].parent&&(G(E[n].overloads[a]),C(E[n].overloads[a].slideOverload.target.getOccurrencePathElement()),J=!0);else if(h&&h.addObjectOverload&&z.length){var K,Z=0,Y=[],Q=function(e,n){for(var r=Object.keys(e.slideOverload.state),o=0;o<r.length;o++)if(!t||t&&t.graphicProps&&"cColor"===r[o]||t&&t.graphicProps&&"bVisible"===r[o]||t&&t.graphicProps&&"fOpacity"===r[o]||t&&t.positions&&("mPosition"===r[o]||"mTransfoMatrix"===r[o]))if(J=!0,"mPosition"===r[o]||"mTransfoMatrix"===r[o]){for(var a=n.clone();a&&!u.isInstance(a.getLastElement(!0));)a=a.getParentPath();if(!a)for(a=n.clone();a&&!u.isReference(a.getLastElement(!0))&&!u.isRepReference(a.getLastElement(!0));)a=a.getParentPath();if(a&&(K=p.getOrCreateOccurrenceOverloader({pathElement:a},!0))){var l=(new i.Matrix4).multiplyMatrices(K.getOccurrencePathElement().getLastElement(!0).getMatrix(),e.transfoMatrix);K.setAttribute("mTransfoMatrix",l),Y.push({target:K,state:{mTransfoMatrix:l}}),C(n)}}else if(K=p.getOrCreateOccurrenceOverloader({pathElement:n},!0)){K.setAttribute(r[o],e.slideOverload.state[r[o]]);var s={};s[r[o]]=e.slideOverload.state[r[o]],Y.push({target:K,state:s}),C(n)}};for(a=0;a<z.length;a++){for(l=0;l<E[Z].overloads.length;l++)Q(E[Z].overloads[l],z[a]);++Z>=E.length&&(Z=0)}Y.length&&s.giveEventsController({viewer:b.getViewer()}).fireEvent("onDMUOverloadPropertiesChanged",{overloads:Y})}if(J){if(O)for(n=E.length-1;n>=0;n--)for(a=E[n].overloads.length-1;a>=0;a--)E[n].overloads[a].parent.removeObjectOverload(E[n].overloads[a].slideOverload);v&&h.refreshNode()}O&&(E.length=0,O=!1),U=null,M()}s.giveEventsController({viewer:b.getViewer()}).fireEvent("onSaveRequested",{})}}}},this.refreshCCPCommandsAvailability=function(){var e=s.getReviewContext({viewer:b.getViewer()}),t=s.getContextViewer({viewer:b.getViewer()});if(t&&e){var n=e.getCurrentSessionMarkup(),i=n&&n.isVisible()&&!n.isReadOnly(),o=i?e.getUIManager().getSelectedObjects():[],a=function(e){var a=!1;if(i&&!o.length)for(var l=r.get(),s=0;s<l.length;s++){var g=n.getOrCreateOccurrenceOverloader(l[s]);if(g&&g.isOverloadedInCurrentSlide()){a=!0;break}if(l[s].pathElement.getParentPath()&&u.isInstance(l[s].pathElement.getParentPath().getLastElement(!0))&&(g=n.getOrCreateOccurrenceOverloader({pathElement:l[s].pathElement.getParentPath()}))&&g.isOverloadedInCurrentSlide()){a=!0;break}}var c=d.getCommand(e+"DMUCopyHdr",t.getCommandContext());c&&(o.length||a?c.enable():c&&c.disable(),c=d.getCommand(e+"DMUCutHdr",t.getCommandContext()),o.length||a?c.enable():c&&c.disable(),c=d.getCommand(e+"DMUPasteHdr",t.getCommandContext()),i&&c&&(x.length||E.length)?c.enable():c&&c.disable(),(c=d.getCommand(e+"DMUPasteSpecialHdr",t.getCommandContext()))&&(i&&(1===x.length&&("DMUSlide"===x[0].object.getType()||"DMUFormat"===x[0].object.getType())||E.length)?c.enable():c.disable()))};a(""),a("Format_")}},this.registerContextualMenu=function(e){if(b&&!function(e){for(var t=0;t<C.length;t++)if(C[t].type===e)return!0;return!1}(e.type)){var t=s.getContextViewer({viewer:b.getViewer()});if(!t)return;S||(S=!0,document.addEventListener("keyup",y)),b.getContextualUIManager().register({subscriberId:e.type,workbenchName:e.workbenchName,module:e.module,context:t.getCommandContext(),cmdPrefix:"",directory:"assets/afr/",merge:!0,onContextualMenuReady:function(t,n){var i;if(t&&t.event&&t.event.getCurrentPosition?((i=t.event.getCurrentPosition(b.getViewer().canvas)).x*=window.devicePixelRatio,i.y*=window.devicePixelRatio):i={x:n.XmousePositionWithDevPxRatio,y:n.YmousePositionWithDevPxRatio},0===M.pick(i,"mesh").length&&0===a.get().length)return{cmdList:[]};var o=s.getReviewContext({viewer:b.getViewer()});if(o){var l=o.getUIManager().getSelectedObjects(),d=r.get();if(d.length&&l.length===d.length){for(var g=0;g<l.length;g++)if(-1!==l[g].getType().indexOf(e.type)||l[g].getType().includes("DMUComment")&&"DMUMarker"===e.type)return l[g].getSharedContextualMenuCommandList?{cmdList:l[g].getSharedContextualMenuCommandList(l)}:{cmdList:[]}}else if(d.length&&"DMUMarker"===e.type){var u=f.giveDMUCommentsController({context:b});if(u){var c=u.getSelectedComments();if(c&&c.length===d.length)for(var p=0;p<c.length;p++)if("DMUComment"===c[p].getType())return{cmdList:c[p].getSharedContextualMenuCommandList(c)}}}else if(d.length)for(let t=0;t<d.length;t++){if("Checks"===e.type&&d[t].pathElement.getLastElement().getDMUType&&"Checks"===d[t].pathElement.getLastElement().getDMUType()){let e=[d[t].pathElement.getLastElement().getOwner()];return{cmdList:e.length?e[0].getSharedContextualMenuCommandList(e,b.getViewer()):void 0}}if(d.length&&"Highlights"===e.type&&d[t].pathElement.getLastElement().getDMUType&&"Highlights"===d[t].pathElement.getLastElement().getDMUType()){let e=[d[t].pathElement.getLastElement().getOwner()];return{cmdList:e.length?e[0].getSharedContextualMenuCommandList(e,b.getViewer()):void 0}}}}return{cmdList:[]}},onCtxMenuPostXmlLoadingCB:function(){var t=s.getReviewContext({viewer:b.getViewer()});if(t){var n=t.getUIManager().getSelectedObjects(),i=r.get();if(i.length&&n.length===i.length)for(var o=0;o<n.length;o++)if((-1!==n[o].getType().indexOf(e.type)||n[o].getType().includes("DMUComment")&&"DMUMarker"===e.type)&&n[o].setCheckCmdHdrState&&n[o].cmdHdrState_list)return n[o].setCheckCmdHdrState(n[o].cmdHdrState_list),Promise.resolve()}return Promise.resolve()}})}var n,i;n=e.type,(i=C.findIndex(function(e){return e.type===n}))>=0?C[i].count++:C.push({type:n,count:1})},this.unregisterContextualMenu=function(e){var t=C.findIndex(function(t){return t.type===e.type});t>=0&&(C[t].count--,0===C[t].count&&(C.splice(t,1),b.getContextualUIManager().unregister(e.type)))},this.registerContextualBar=function(e){if(b&&!function(e){for(var t=0;t<D.length;t++)if(D[t].type===e)return!0;return!1}(e.type)){var t=s.getContextViewer({viewer:b.getViewer()});if(!t)return;b.getContextualUIManager().register({subscriberId:e.type,workbenchName:e.workbenchName,module:e.module,context:t.getCommandContext(),cmdPrefix:"",directory:"assets/afr/",merge:!0,onContextualBarReady:function(){var t=s.getReviewContext({viewer:b.getViewer()});if(t){var n=t.getUIManager().getSelectedObjects(),i=r.get();if(i.length&&n.length===i.length){for(var o=0;o<n.length;o++)if(-1!==n[o].getType().indexOf(e.type)||n[o].getType().includes("DMUComment")&&"DMUMarker"===e.type)return n[o].getSharedContextualCommandList?{cmdList:n[o].getSharedContextualCommandList(n)}:{cmdList:[]}}else if("DMUMarker"===e.type&&!t.isReadOnly()&&!l.getTouchMode()){var a=window.getSelection();if(a&&""!==a.toString())for(var d=0,g=a.getRangeAt(0).commonAncestorContainer;g&&d<7;){if(g===b.getViewer().currentViewpoint.divCameraCSSElement)return{cmdList:[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"]}]};g=g.parentNode,d++}}}return{cmdList:[]}}})}var n,i;n=e.type,(i=D.findIndex(function(e){return e.type===n}))>=0?D[i].count++:D.push({type:n,count:1})},this.unregisterContextualBar=function(e){var t=D.findIndex(function(t){return t.type===e.type});t>=0&&(D[t].count--,0===D[t].count&&(D.splice(t,1),b.getContextualUIManager().unregister(e.type)))}}})}),define("DS/DMUBaseUIControllers/DMUReviewContextInitializer",["UWA/Class","UWA/Utils","DS/ApplicationFrame/CommandsManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/CoreEvents/Events","DS/VisuEvents/EventsManager","DS/DMUBaseReview/DMUExperience","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUUserExperienceManager","DS/DMUBaseExperience/EXPManagerSet","DS/CATWebUXTooltipManager/CATWebUXTooltipManager","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUBaseUIControllers/DMUReviewController","DS/DMUBaseUIManipulators/DMUCursorsController","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUBaseExperience/EXPUtils","DS/DMUControls/DMUInfoModalDiv","DS/DMUBaseUIManipulators/DMUBaseRepManipulator","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/DMUBaseUIControllers/DMUSceneDisplayController","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,g,u,c,p,m,f,h,v,D,C,b,M,S,w){"use strict";let y=e.extend({init:function(e){var s,y,U,x,E,O,P,I,A,R,k,V,T,F,j,N,L,B=e.context.getFrameWindow(),W=this,H=!1,q=[],_=!1,z=!0,X={},G={},J=d.getContextViewer({viewer:B.getViewer()}),K=d.giveEventsController({viewer:B.getViewer()}),Z=null,Y=null;let Q,$,ee;function te(e){if(e&&e.completed)if(e.arrayPath){var t=A?A.getCommentTooltip(e.arrayPath[0].getLastElement(!0)):null;if(!(t||e.arrayPath&&1===e.arrayPath.length&&e.token&&e.arrayPath[0].getLastElement(!0).getTooltip))return void e.completed();e.completed({token:e.token,div:t||e.arrayPath[0].getLastElement(!0).getTooltip(),interactiveContent:!0})}else if(e.element&&P&&P.length){var n=P.findIndex(function(t){return t.div===e.element});n>=0?e.completed({token:e.token,div:P[n].content,interactiveContent:!0}):e.completed()}else e.completed()}function ne(e){for(var t=e;t&&t.getLastElement(!0).getPickParent();)t=t.getParentPath();return t}function ie(e){if(Z&&e&&e.length){let n=0;for(var t=0;t<e.length;t++)"DMUSlide"!==e[t].getType()&&"DMUFormat"!==e[t].getType()||(e[t].getActiveFlag()&&!_&&"DMUSlide"===e[t].getType()||_&&"DMUFormat"===e[t].getType()?(Z.addSlide(e[t],e[t].getAttribute("sParentSlideID")?n:null),e[t].getAttribute("sParentSlideID")||n++):Z.removeSlide(e[t]))}}function re(t){if(Z&&t&&t.dmuObject&&e.reviewContext&&e.reviewContext.getActiveFlag()){var n=t.dmuCont?t.dmuCont:e.reviewContext.getCurrentSessionMarkup();if(n&&("DMUSlide"===t.dmuObject.getType()||"DMUFormat"===t.dmuObject.getType())){let i=e.reviewContext.getValidation();i&&(t.mkpRepRef?t.dmuObject.parentID=t.mkpRepRef.getPlmID():t.dmuObject.parentID=i.getCurrentMarkup()?i.getCurrentMarkup().getRepRef().getPlmID():null),t.dmuObject.getActiveFlag()&&(!_&&"DMUSlide"===t.dmuObject.getType()||_&&"DMUFormat"===t.dmuObject.getType())?Z.addSlide(t.dmuObject,function(e,t){if(e&&t)for(var n="DMUSlide"===e.getType()?t.getSlides():t.getFormats(),i=0;i<n.length;i++)if(n[i]===e)return i}(t.dmuObject,n),n):Z.removeSlide(t.dmuObject)}}}function oe(){Q&&clearTimeout(Q),Q=setTimeout(()=>{Q=null,B&&B.getContextualUIManager().showContextualBar({hideWithDistance:!0,backMAB:function(){i.empty()}})},100)}function ae(e){if(B){var t=B.getActionBar();t&&t.MAB&&!0===t.MAB.state.visible?a.publish({event:"/"+B.options.context+"/WUX/ContextualBar/Hide/"}):e||B.getContextualUIManager().getContextualBar().hide()}}var le,se,de;function ge(e){if(R&&R.length){N||(N=new M(B.getViewer())),e&&e.event&&e.event.from&&(ee&&l.removeEventFromToken(ee),ee=l.addEvent(e.event.from[0].view,"onPrimaryPointerUpUnique",()=>{null!=ee&&(l.removeEventFromToken(ee),ee=null),N.setTextSelectionFlag(!0),N.setTouchPanActive(!0)})),N.setTextSelectionFlag(!1),N.setTouchPanActive(!1);for(var t=0;t<R.length;t++)R[t].manipulator?R[t].manipulator.onBeginManipulateCB(e):R[t].repManip&&R[t].repManip.onBeginManipulateCB(e)}}function ue(e){if(R&&R.length&&N){var t,n=e&&e.translationVector2D&&(!F||!F.length),i=e&&e.translationVector2D&&(e.ctrlKey||void 0===e.ctrlKey&&e.event&&e.event.from&&e.event.from.length&&e.event.from[0].event&&e.event.from[0].event.ctrlKey);N.updateManipulationData(e);for(var a=0;a<R.length;a++){var l=R[a].dmuObj.getType();n&&"DMUMeasure"!==l&&"DMUCommentPositioned"!==l&&(F||(F=[]),t||(t=[]),"DMUMeasure"!==l&&"DMUCommentPositioned"!==l&&t.push(R[a].dmuObj)),R[a].manipulator?(R[a].dmuObj.setGhostMode(i),R[a].manipulator.onManipulateCB(e),k||R[a].manipulator.setHandlesVisibility(!1)):R[a].repManip&&R[a].repManip.onManipulateCB(e)}if(n&&t&&t.length)N.addToListener("Control",ue),N.activate(),u.getManager({name:"DMUUserExperienceManager",context:B}).duplicateDMUElements({elements:t,cb:function(e){e&&e.duplicatedElements&&(F=e.duplicatedElements.slice())}});if(i){if(!T&&F&&F.length&&L){T=!0,I&&I.setCursors({canvas:"copy",pages:"copy"});for(var s=0;s<F.length;s++)L.addChild(F[s].getNode())}}else if(T&&F&&F.length&&L){I&&I.setCursors({canvas:"move",pages:"move"});for(var d=0;d<F.length;d++)L.removeChild(F[d].getNode());T=!1}k||(o.empty(),k=r.get().slice(),r.empty(),A&&A.setGuidelineVisibility(!1)),ae(),B.getViewer().render()}}async function ce(n){if(R&&R.length&&N){if(null!=ee&&(l.removeEventFromToken(ee),ee=null),N.setTextSelectionFlag(!0),N.setTouchPanActive(!0),N.remove(),F&&F.length&&L){for(var i=0;i<F.length;i++)L.removeChild(F[i].getNode()),F[i].remove();F=null}if(T){for(var o=e.reviewContext.getCurrentSessionMarkup(),a=u.getManager({name:"DMUUserExperienceManager",context:B}),s=[],d=0;d<R.length;d++)"DMUMeasure"!==R[d].dmuObj.getType()&&"DMUCommentPositioned"!==R[d].dmuObj.getType()&&s.push(R[d].dmuObj);s.length&&await a.duplicateDMUElements({elements:s,parent:o.getCurrentSlide(),cb:function(e){if(e&&e.duplicatedElements)for(var n=0;n<e.duplicatedElements.length;n++)e.duplicatedElements[n].setAttributes([{name:"sID",value:o.computeNewID()},{name:"sUuid",value:t.getUUID()}])}}),T=!1}for(var g=0;g<R.length;g++)R[g].manipulator?(R[g].dmuObj.setGhostMode(!1),R[g].manipulator.onEndManipulateCB(n),R[g].manipulator.setHandlesVisibility(!0)):R[g].repManip&&R[g].repManip.onEndManipulateCB(n);k&&k.length&&r.add(k),k=null,A&&A.setGuidelineVisibility(!0),oe(),I&&I.restoreCursors()}}function pe(){var e=D.checkIfCommandIsRunning(B.getViewer());if(e){var t=D.getCurrentCommand(B.getViewer());"measureCmdHdr"!==t&&"measure2DCmdHdr"!==t&&"measure3CmdHdr"!==t&&"measure2CmdHdr"!==t&&"thicknessCmdHdr"!==t&&"DMUSectionInEditModeHdr"!==t||(e=!1)}return e}function me(e){if(e){if(!L)for(var t=B.getViewer().getNodes(),n=0;n<t.length;n++)if("DecorationBag"===t[n].name){L=t[n];break}require(["DS/DMUMarkerManipulators/DMUMarkerRecManipulator","DS/DMUMarkerManipulators/DMUMarkerPolylineManipulator","DS/DMUMarkerManipulators/DMUMarkerCircleManipulator","DS/DMUMarkerManipulators/DMUMarkerArrowManipulator","DS/DMUMarkerManipulators/DMUMarkerLabelManipulator"],function(e,t,n,i,r){se=function(o){if(o){de&&(clearTimeout(de),de=null);var a=[];if(0===(a=o.filter(function(e){return e.getType().includes("Marker")||"DMUMeasure"===e.getType()||"DMUCommentPositioned"===e.getType()})).length){if(R&&R.length){for(var l=0;l<R.length;l++){if(R[l].manipulator&&R[l].manipulator.remove(),R[l].repManipTokens&&R[l].repManipTokens.length)for(var s=0;s<R[l].repManipTokens.length;s++)R[l].repManip.unsubscribe(R[l].repManipTokens[s]);R[l]=null}R=null,V&&K&&(j.destroy(),K.fireEvent("onSaveRequested"),V=!1)}}else{var d=function(){var o=[];if(R||(R=[]),a.forEach(function(a){var l=R.findIndex(function(e){return e.dmuObj.getNode().id===a.getNode().id});-1===l?(!function(o){var a=o.getType();if(!pe()&&!o.isReadOnly()&&o.isEditable()&&o.getAttribute("bVisible")){var l,s=o.getNode().getRepManipulator();s&&("DMUMarker3DRectangle"===a||"DMUMarker3DEllipse"===a||"DMUMarker3DSpline"===a?(l={dmuObj:o,repManip:s,repManipTokens:[s.subscribe("onMarkerRepBegingManipulate",ge),s.subscribe("onMarkerRepManipulate",ue),s.subscribe("onMarkerRepEndManipulate",ce)],manipulator:new e({viewer:B.getViewer(),dmuObj:o,onBeginManipulateCB:ge,onManipulateCB:ue,onEndManipulateCB:ce})},R.push(l)):"DMUMarker3DCircle"===a?(l={dmuObj:o,repManip:s,repManipTokens:[s.subscribe("onMarkerRepBegingManipulate",ge),s.subscribe("onMarkerRepManipulate",ue),s.subscribe("onMarkerRepEndManipulate",ce)],manipulator:new n({viewer:B.getViewer(),dmuObj:o,onBeginManipulateCB:ge,onManipulateCB:ue,onEndManipulateCB:ce})},R.push(l)):"DMUMarker3DLine"===a?(l={dmuObj:o,repManip:s,repManipTokens:[s.subscribe("onMarkerRepBegingManipulate",ge),s.subscribe("onMarkerRepManipulate",ue),s.subscribe("onMarkerRepEndManipulate",ce)],manipulator:new t({viewer:B.getViewer(),dmuObj:o,onBeginManipulateCB:ge,onManipulateCB:ue,onEndManipulateCB:ce})},R.push(l)):"DMUMarker3DArrow"===a?(l={dmuObj:o,repManip:s,repManipTokens:[s.subscribe("onMarkerRepBegingManipulate",ge),s.subscribe("onMarkerRepManipulate",ue),s.subscribe("onMarkerRepEndManipulate",ce)],manipulator:new i({viewer:B.getViewer(),dmuObj:o,onBeginManipulateCB:ge,onManipulateCB:ue,onEndManipulateCB:ce})},R.push(l)):"DMUMarker2DText"===a||"DMUMarker3DStamp"===a||"DMUMarker3DText"===a||"DMUMarker2DPicture"===a||"DMUMarker3DPicture"===a||"DMUMeasure"===a?(l={dmuObj:o,repManip:s,repManipTokens:[s.subscribe("onMarkerRepBegingManipulate",ge),s.subscribe("onMarkerRepManipulate",ue),s.subscribe("onMarkerRepEndManipulate",ce)],manipulator:new r({viewer:B.getViewer(),dmuObj:o,onBeginManipulateCB:ge,onManipulateCB:ue,onEndManipulateCB:ce})},R.push(l)):"DMUCommentPositioned"===a&&(l={dmuObj:o,repManip:s,repManipTokens:[s.subscribe("onMarkerRepBegingManipulate",ge),s.subscribe("onMarkerRepManipulate",ue),s.subscribe("onMarkerRepEndManipulate",ce)]},R.push(l)))}}(a),o.push(R.length-1)):o.push(l)}),o.length!==R.length){for(var l=0;l<R.length;l++)if(!o.includes(l)){if(R[l].manipulator&&R[l].manipulator.remove(),R[l].repManipTokens&&R[l].repManipTokens.length)for(var s=0;s<R[l].repManipTokens.length;s++)R[l].repManip.unsubscribe(R[l].repManipTokens[s]);R[l]=void 0}R.sort(),R=R.slice(0,o.length)}};pe()?de=setTimeout(d):d()}}}})}else se=function(e){if(e){de&&(clearTimeout(de),de=null);var t=[];if(0===(t=e.filter(function(e){return"DMUMeasure"===e.getType()})).length){if(R&&R.length){for(var n=0;n<R.length;n++){if(R[n].repManipTokens&&R[n].repManipTokens.length)for(var i=0;i<R[n].repManipTokens.length;i++)R[n].repManip.unsubscribe(R[n].repManipTokens[i]);R[n]=null}R=null}}else{var r=function(){R||(R=[]);var e=[];if(t.forEach(function(t){var n=R.findIndex(function(e){return e.dmuObj.getNode().id===t.getNode().id});-1===n?(!function(e){if(!pe()&&!e.isReadOnly()&&e.isEditable()&&e.getAttribute("bVisible")){var t,n=e.getNode().getRepManipulator();n&&(t={dmuObj:e,repManip:n,repManipTokens:[n.subscribe("onMarkerRepBegingManipulate",ge),n.subscribe("onMarkerRepManipulate",ue),n.subscribe("onMarkerRepEndManipulate",ce)]},R.push(t))}}(t),e.push(R.length-1)):e.push(n)}),e.length!==R.length){for(var n=0;n<R.length;n++)if(!e.includes(n)){if(R[n].repManipTokens&&R[n].repManipTokens.length)for(var i=0;i<R[n].repManipTokens.length;i++)R[n].repManip.unsubscribe(R[n].repManipTokens[i]);R[n]=void 0}R.sort(),R=R.slice(0,e.length)}};pe()?de=setTimeout(r):r()}}}}function fe(){var t,n,o,a=q.slice(),l=[];if(q.forEach(function(e){e.setInEdition(!1)}),q.length=0,e.reviewContext){var s,d,g=function(e,t,n){for(var i,r=0;r<l.length;r++)if(l[r].path.isEqual(e)){i=l[r];break}i||(i={path:e.clone(),counter:1,dmuObj:t},l.push(i)),i.counter=i.counter+(n?1:-1)},c=i.get(),p=[],m=[],f=[],h=[],v=e.reviewContext.getCurrentSessionMarkup();for(n=0;n<c.length;n++){if(d=e.reviewContext.getDMUObjectFromPathElement(c[n].pathElement))"DMUSlide"===d.getType()||"DMUFormat"===d.getType()?(p.push(d),h.push(c[n])):m.push(c[n]),-1===q.indexOf(d)&&q.push(d),d.setInEdition(!0);else{if(!(v?v.getOrCreateOccurrenceOverloader(c[n]):null))continue;f.push(c[n])}p.length&&c.length>1&&n===c.length-1&&(s=p[p.length-1]===d?m.concat(f):h)}var D=q.length!==a.length;if(!D)for(n=0;n<q.length;n++)if(-1===a.indexOf(q[n])){D=!0;break}if(s&&s.length)i.remove(s);else{q.forEach(function(n){for("DMUSection"===n.getType()&&n.refreshNode(),t=function(t){var n=[];if(!t)return n;t.getPathElement&&n.push(t.getPathElement());var i=t.getPointedReferences?t.getPointedReferences():[];if(i&&i.length&&e.reviewContext){var r=e.reviewContext.getCurrentSessionMarkup();if(r){var o=r.getAttribute("oLinksManager");if(o)for(var a=0;a<i.length;a++)if("null"!==i[a]){var l=o.getOccurrencePathElement(i[a]);l&&n.push(l)}}}return n}(n),o=0;o<t.length;o++)g(t[o],n,!0)});var C=u.getManager({name:"DMUUserExperienceManager",context:B});if(C&&C.refreshCCPCommandsAvailability(),Z&&Z.updateSelectedSlides(p.concat([])),se&&se(q),D){ae(!0),oe();var b=[],M=[];l.forEach(function(e){e.counter>0&&b.push({pathElement:e.path})}),c.length?(r.get().forEach(function(e){if(!i.isIn(e)){for(var t=0;t<b.length;t++)if(b[t].pathElement.isEqual(e.pathElement))return;M.push(e)}}),r.remove(M)):r.empty(),r.add(b),B.getViewer().render()}}}}function he(e){if(e&&e.pathElement){var t=e.pathElement.getLastElement(!0);t&&t.processPathForTrimedText&&(e=t.processPathForTrimedText(e))}return e}u.addManager({name:"DMUUserExperienceManager",context:B,manager:new g({frmWindow:B})}),me(-1!==d.getAuthoringFeatureTypes().indexOf("Marker")),this.setMarkupVisualizationActiveState=function(t){let n;const r=e.reviewContext.getCurrentSessionMarkup();function o(){if(z!==t&&(z=t,r&&(r.setVisibleFlag(z),r.refreshNode(),B.getViewer().render(),Z.setPanelActiveFlag(z)),!z&&q&&q.length)){let t=[];i.get().forEach(function(n){e.reviewContext.getDMUObjectFromPathElement(n.pathElement)&&t.push(n)}),t.length&&i.remove(t)}}r&&(n=r.getApplicativeContext());const a=d.getEventsController({viewer:J.getViewer()});if(n&&n.PIM){require([{isr:"DS/PIMwebViewController/PIMwebItfCtrl"}.isr],function(e){t?(a.fireEvent("onDMUMarkupApplicativeContextLoadBegin"),e.loadApplicativeContext(n.PIM,J).then(()=>{a.fireEvent("onDMUMarkupApplicativeContextLoaded",{markupHasApplicativeContext:!0}),o()})):e.cleanApplicativeContext(n.PIM,J).then(()=>{a.fireEvent("onDMUMarkupApplicativeContextCleaned"),o()})})}else a.fireEvent("onDMUMarkupApplicativeContextLoaded",{markupHasApplicativeContext:!1}),o()},this.setFormatEditionModeFlag=function(t){if(Z&&e.reviewContext){i.empty();var n=e.reviewContext.getCurrentSessionMarkup(),r=n&&n.getCurrentSlide?n.getCurrentSlide():null;_=t;let a=e.reviewContext.getValidation(),l=a?a.getAllRepRefs():[],s=[];l.length?l.forEach(e=>{s.push(e.getMarkupContent())}):s.push(n);let d=[],g=[];if(s.forEach(e=>{g=g.concat(e.getFormats()),d=d.concat(e.getSlides())}),a&&a.getCurrentMarkup()&&"Reply"===a.getCurrentMarkup().getAttribute("sValType")){let e=a.getCurrentMarkup();for(;e&&"Markup"!==e.getValType();)e=e.getParentRepRef().getParent();e&&"Markup"===e.getAttribute("sValType")&&(e=e.getRepRef()),a.setCurrentMarkup(e)}if(_)for(let e=0;e<g.length;e++)g[e].setReadOnly(!1,!0);Z.setPanelOptions({panelTitle:_?w.formatPanelTitle:void 0,noSlideLabel:_?w.noFormatLabel:void 0,createSlideLabel:_?w.createFormatLabel:void 0,editingFormats:_});var o=O||n.getCurrentSlide();o||(o=_?g[0]:d[0]),O=r,ie(_?g:d),ie(_?d:g),Z.setActiveSlide(o,{duration:0}),O&&(O.refreshNode(),"DMUSlide"===O.getType()&&O.getPointedFormats().length&&-1!==O.getPointedFormats().indexOf(o)&&(o.setDisplayedFlag(!0),o.setReadOnly(!1),o.refreshNode()),B.getViewer().render())}},this.getFormatEditionModeFlag=function(){return _},this.setReadOnly=function(e){e&&U&&(U.clean(),U=null),v.setSlidePreferences({context:B,preferences:{playMode:e}}),Z&&Z.setPanelOptions({playMode:e}),me(!e)},this.getSelectedObjects=function(){return q},this.remove=function(){if(W.setActiveFlag(!1),U&&U.clean(),u.removeManager({name:"DMUUserExperienceManager",context:B}),c.unreferenceTooltipManager(e),j&&(j.destroy(),j=null),F&&F.length)for(var t=0;t<F.length;t++)B.getViewer().removeNode(F[t].getNode());N&&N.remove(),F=R=k=V=T=null,q=null,K=null,O=null,N=B=null,y=null,U=null},this.setActiveFlag=function(t){if(H!==t){if(H=t){Z=p.getDMUSlidesController({context:B,commandContext:J.getCommandContext()}),Y=f.getDMUReviewController({context:B,commandContext:J.getCommandContext()}),I=h.getDMUCursorsController({context:B,commandContext:J.getCommandContext()}),Z.setActiveFlag(!0),S.getDMUSceneDisplayController({context:J}),G.onDMUObjectCreated=K.addEvent("onDMUObjectCreated",function(e){e.dmuObject&&"DMUFormat"===e.dmuObject.getType()&&e.dmuObject.setReadOnly(!_)}),G.onDMUObjectInitialized=K.addEvent("onDMUObjectInitialized",function(t){if(t&&t.dmuObject){var n,i,r;if("DMUSlide"===t.dmuObject.getType()||"DMUFormat"===t.dmuObject.getType())t.dmuObject.setDisplayedFlag(!1),U&&U.hide();else if("DMUSection"===t.dmuObject.getType()){if(e.reviewContext&&(n=t.dmuCont?t.dmuCont:e.reviewContext.getCurrentSessionMarkup())&&n.getActiveFlag()&&n.isVisible()){var o=n.getCurrentSlide();o&&"DMUSlide"===o.getType()&&(o.refreshNode(),B.getViewer().render())}}else if("ReviewMarkup"===t.dmuObject.getType()){if(i=e.reviewContext.getValidation(),r=t.dmuObject,Y.addMarkup({title:r.getParent().getName(),content:r,id:r.getPlmID()}),Z&&i){var a=r.getParent();"Markup"===a.getType()?(Z.addMarkup({title:r.getParent().getName(),content:r,id:r.getPlmID()}),A&&(A.addMarkup({title:r.getParent().getName(),content:r,id:r.getPlmID()}),$&&A.setVisibleFlag(!1))):"Reply"===a.getType()&&Z.addReply({title:r.getParent().getName(),content:r,id:r.getPlmID(),parentID:r.getParentRepRef().getPlmID()})}}else if("DMUValidationValidation"===t.dmuObject.getType()){if(i=e.reviewContext.getValidation(),Z&&i){var l=i.getAllRepRefs();let e=[],t=[];for(var s=0;s<l.length;s++){var d=(r=l[s]).getParent().getValType();"Markup"===d?e.push({title:r.getParent().getName(),content:r,id:r.getPlmID()}):"Reply"===d&&t.push({title:r.getParent().getName(),content:r,id:r.getPlmID(),parentID:r.getParentRepRef().getPlmID()})}e.forEach(e=>{Z.addMarkup(e),A&&A.addMarkup(e)}),t.forEach(e=>{Z.addReply(e)})}if(Y&&i){Y.setEditionMode(t.editionMode);var g=Boolean(A);i.enableMultipleMarkupVisibility(g),Y.addReview(g),$&&Y.updateReviewPanelContent({reviewNoContextMode:!0}),Z&&!g&&Z.forcePanelVisibility()}}else if("DMUValidationCheck"===t.dmuObject.getType()){var u=t.dmuObject;Y&&Y.addCheck({id:u.getPlmID(),name:u.getName(),status:u.getStatus(),description:u.getDescription(),requirements:u.getJsonRequirements()?u.getJsonRequirements():[]})}else if("DMUValidationExposedPresentation"===t.dmuObject.getType()){var c=t.dmuObject;Y&&Y.addHighlight({repRefMarkupId:t.dmuObject.getAttribute("sRepRefMarkupID"),slideObject:t.slideObject,id:c.getPlmID(),name:c.getName(),rating:c.getRating(),description:c.getDescription(),issues:[],changeAction:[],index:e.reviewContext.getValidation().getHighlights().length-1})}else{var p=t.dmuObject.getType();!p.includes("DMUMarker")&&"DMUMeasure"!==p&&"DMUCommentPositioned"!==p||"DMUMarker3DPoint"===p||"DMUMarker2DPoint"===p||"DMUCommentHighlight"===p||t.dmuObject.getNode().setRepManipulator(new b(t.dmuObject)),e.reviewContext&&(n=e.reviewContext.getCurrentSessionMarkup())&&n.getActiveFlag()&&!n.isImporting()&&(t.dmuObject.refreshNode(),B.getViewer().render())}re(t)}}),G.onDMUObjectVisuRefreshRequired=K.addEvent("onDMUObjectVisuRefreshRequired",function(e){e&&e.dmuObject&&(e.dmuObject.refreshNode(),B.getViewer().render())}),G.onDMUObjectDeleted=K.addEvent("onDMUObjectDeleted",function(t){if(t&&t.dmuObject&&"DMUSection"===t.dmuObject.getType()&&e.reviewContext){var n=e.reviewContext.getCurrentSessionMarkup();if(n){var i=n.getCurrentSlide();i&&"DMUSlide"===i.getType()&&(i.refreshNode(),B.getViewer().render())}}}),G.onDMUObjectActiveFlagChanged=K.addEvent("onDMUObjectActiveFlagChanged",function(e){re(e),e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&(e.flag?Z&&e.dmuObject.getCurrentSlide()&&Z.setActiveSlide(e.dmuObject.getCurrentSlide()):U&&(U.clean(),U=null),e.dmuObject.refreshNode(),B.getViewer().render())}),G.onDMUObjectVisibleFlagChanged=K.addEvent("onDMUObjectVisibleFlagChanged",function(t){t&&t.dmuObject===e.reviewContext.getCurrentSessionMarkup()&&W.setMarkupVisualizationActiveState(t.flag)}),G.onDMUObjectAttributeModified=K.addEvent("onDMUObjectAttributeModified",function(t){if(t&&"bShortDisplay"===t.attrName&&R&&R.length){var i=R.findIndex(function(e){return e.dmuObj.getNode().id===t.dmuObject.getNode().id});i>=0&&setTimeout(function(){R[i].manipulator&&(R[i].manipulator.updateHandlePosition(),B.getViewer().render())})}(!_&&"DMUSlide"===t.dmuObject.getType()||_&&"DMUFormat"===t.dmuObject.getType())&&Z&&t.dmuObject.getActiveFlag()&&t.dmuObject.isVisible()&&Z.updateSlide(t.dmuObject),t&&t.dmuObject&&"DMUComment"===t.dmuObject.getType()&&"sTextContents"===t.attrName&&t.value&&K.fireEvent("onSaveRequested"),function(t){if(t&&t.dmuObject&&R&&R.length){var i,r=t.dmuObject.getParent();i=r&&r.getType().includes("DMUMarker")?r.getNode():t.dmuObject.getNode();var o=e.reviewContext.getCurrentSessionMarkup(),a=n.getCommand("DMU3ReviewWidgetDefaultHdr",J.getCommandContext())||n.getCommand("DMUReviewWebAppDefaultHdr",J.getCommandContext())||n.getCommand("DMUValidationWebAppDefaultHdr",J.getCommandContext()),l=function(){a&&a.isRunning()&&o&&o.getActiveFlag()&&o.isVisible()&&i&&R&&R.length&&-1!==R.findIndex(function(e){var t=e.dmuObj.getNode();return t&&t.id===i.id})&&(j||(j=new C),j.display({frmWindow:J.getFrameWindow(),label:w.saveMarkup,type:"button",onClick:function(){j.destroy(),V=!1,K.fireEvent("onSaveRequested")}}),V=!0)};a&&(le&&(clearTimeout(le),le=null),a.isRunning()?l():le=setTimeout(l))}}(t)}),G.onDMUObjectReadOnlyFlagChanged=K.addEvent("onDMUObjectReadOnlyFlagChanged",function(e){e&&e.dmuObject&&(!_&&"DMUSlide"===e.dmuObject.getType()||_&&"DMUFormat"===e.dmuObject.getType())&&Z&&Z.updateSlideEditableFlag(e.dmuObject)}),G.onDMUSlideDisplayed=K.addEvent("onDMUSlideDisplayed",function(){U&&U.hide()}),G.onLoadingReviewContext=K.addEvent("onLoadedReviewContext",function(t){if("Document"===t.rootType||"PDF"===t.rootType||"Requirement Specification"===t.rootType||"Requirement"===t.rootType){Z&&Z.setVisibleFlag(!1),A||(A=m.getDMUCommentsController({context:B,commandContext:J.getCommandContext()}));const t=e.reviewContext.getValidation();t&&t.enableMultipleMarkupVisibility(!0)}if("DXF"===t.rootType||"DWG"===t.rootType){Z&&Z.setVisibleFlag(!0),A&&A.setVisibleFlag(!1);const t=e.reviewContext.getValidation();t&&t.enableMultipleMarkupVisibility(!1)}}),G.on2DDocumentLoadSuccess=K.addEvent("on2DDocumentLoadSuccess",e=>{if(e&&"Document"===e.type){var t=d.getReviewContext({viewer:B.getViewer()}),n=t?t.getValidation():null;n&&n.getMarkups().forEach(e=>{let t=e.getRepRef();t&&t.getMarkupContent()&&t.getMarkupContent().refreshNode()})}}),G.onReviewNoContextModeOn=K.addEvent("reviewNoContextModeOn",function(e){$=!0,(A=m.getDMUCommentsController({context:B,commandContext:J.getCommandContext()})).setVisibleFlag(!1),Z&&Z.setVisibleFlag(!1),Y.updateReviewPanelContent({reviewNoContextMode:!0}),e&&e.markups&&e.markups.forEach(e=>{Y.addMarkup({title:e.getName(),content:e,id:e.getPlmID()})})}),G.onReviewNoContextModeOff=K.addEvent("reviewNoContextModeOff",function(e){$=!1;let t=e.rootType;!A||"PDF"!==t&&"Requirement"!==t&&"Requirement Specification"!==t?"DXF"===t||"DWG"===t?A.setVisibleFlag(!1):Z&&(Z.setVisibleFlag(!0),A&&(m.unreferenceDMUCommentsController({context:B}),A=null)):A.setVisibleFlag(!0),Y&&Y.updateReviewPanelContent({reviewNoContextMode:!1,rootType:t})}),y=c.getTooltipManager(e),s=y.register({onTooltipReady:te,filterPath:ne});var r=u.getManager({name:"DMU2DSheetManager",context:B});r&&(A||!r.isADocumentDisplayed()&&!r.isRunning()||"Document"!==r.getDocumentType()&&"Requirement"!==r.getDocumentType()||(A=m.getDMUCommentsController({context:B,commandContext:J.getCommandContext()})),(P=r.getPDFHyperlinks())&&P.length&&y.registerElements(P.reduce(function(e,t){return e.concat(t.div)},[]))),X.onPostAdd=i.onPostAdd(fe),X.onPostRemove=i.onPostRemove(fe),X.onEmpty=i.onEmpty(fe),E=o.onPreAdd(he),x=a.subscribe({event:"/VISU/onWindowResized"},function(){var t=e.reviewContext.getCurrentSessionMarkup();if(t){var n=t.getCurrentSlide();if(n){var i=n.getDMUObjects();if(i&&i.length)for(let e=0;e<i.length;e++)i[e].refreshNode&&-1===i[e].getType().indexOf("Compare")&&i[e].refreshNode()}}})}else{if(Z&&(p.unreferenceDMUSlidesController({context:B}),Z=null),Y&&(f.unreferenceDMUReviewController({context:B}),Y=null),I&&(h.unreferenceDMUCursorsController({context:B}),I=null),A&&(m.unreferenceDMUCommentsController({context:B}),A=null),S.unreferenceDMUSceneDisplayController({context:J}),U&&(U.clean(),U=null),K)for(var l=Object.keys(G),g=0;g<l.length;g++)K.removeEvent(G[l[g]]);G={},X.onPostAdd&&i.unsubscribe(X.onPostAdd),X.onPostRemove&&i.unsubscribe(X.onPostRemove),X.onEmpty&&i.unsubscribe(X.onEmpty),X={},E&&o.unsubscribe(E),E=null,P&&P.length&&(y.unregisterElements(P.reduce(function(e,t){return e.concat(t.div)},[])),P=null),y.unregister(s),s=null,a.unsubscribe(x),x=null}se&&se([])}}}});return Object.freeze({createReviewContext:e=>{if(e&&e.context){var t=d.getReviewContext(e);if(!t){(t=new s(e.context.getFrameWindow())).setUIManager(new y({context:e.context,reviewContext:t}));var n=e.context.getFrameWindow();n.removeReviewModel||(n.removeReviewModel=function(t){if(t){var i=d.getReviewContext(e);if(i){var r=i.getTransientReviewBag();r.removeDMUObjects(t),r.getDMUObjects().length||i.getCurrentSessionMarkup()||(d.removeReviewContext(e),n.removeReviewModel=void 0)}}else d.removeReviewContext(e),n.removeReviewModel=void 0}),n.setReviewModelVisibleFlag||(n.getReviewModelVisibleFlag=function(){var t=d.getReviewContext(e);return!!t&&t.isVisible()},n.setReviewModelVisibleFlag=function(t){var n=d.getReviewContext(e);n&&n.setVisibleFlag(t)}),t&&d.setReviewContext({context:e.context,controller:t})}return t}}})}),define("DS/DMUBaseUIControllers/DMU2DSheetManager",["UWA/Class","DS/DMUControls/EXPNotify","DS/DMUControls/EXPNavBar","DS/DMUControls/DMUCurrentPageWidget","DS/SVGLoader/SVGNode","DS/Mesh/MeshUtils","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseExperience/DMUContextManager","DS/DibUDLWebLoader/CATDibUDLWebLoader","DS/WAFData/WAFData","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUControls/DMUInfoModalDiv","DS/DMUBaseUIControllers/DMUMarkupsController","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/ApplicationFrame/CommandsManager","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers","text!DS/DMUBaseUIControllers/assets/svg/NoUdlWarning.svg"],function(e,t,n,i,r,o,a,l,s,d,g,u,c,p,m,f,h,v){"use strict";return e.extend({init:function(e){let D,C,b,M,S,w,y,U,x,E,O,P,I,A,R,k,V=this,T=e.ctxViewer,F=!1,j=null,N=[],L=[],B=1,W=[],H=0,q=new Map;function _(e,t){let n;if(e&&t)for(let i=0;i<L.length;i++)if(L[i]&&L[i].sheetNodes&&L[i].sheetNodes.length){for(let r=0;r<L[i].sheetNodes.length;r++)"modelID"===e&&L[i].sheetNodes[r].sheetID===t&&(n=L[i].sheetNodes[r].modelID),"sheetID"===e&&L[i].sheetNodes[r].modelID===t&&(n=L[i].sheetNodes[r].sheetID),"parentID"===e&&L[i].sheetNodes[r].sheetID===t&&(n=L[i].parentID);if(n)break}return n}function z(e){D=new t({body:T.getFrameWindow().getUIFrame(),type:"error",message:h.objectWithoutUDL}),j||(j=new DOMParser);var n=j.parseFromString(v,"image/svg+xml"),i=[],o=[];n.documentElement&&(o=[n.documentElement]);var a=new r(o[0],T.getViewer());i.unshift(a),L&&L.length&&L[e].fatherNode&&L[e].fatherNode.addChild(i[0]),i[0].setVisibility(!0)}function X(e){var t,n;let i=e&&e.parentID?e.parentID:L[0].parentID;for(let e=0;e<L.length;e++)if(L[e].parentID===i){n=e;break}if(void 0===n&&L&&L.length&&(i=L[n=0].parentID),i)if(L[n].svg){for(t=0;t<L[n].sheetNodes.length;t++)L[n].sheetNodes[t].setVisibility(L[n].sheetNodes[t].sheetID===e.sheetID),L[n].sheetNodes[t].setVisibilityFree(L[n].sheetNodes[t].sheetID!==e.sheetID);e.callback&&e.callback(),T.getViewer().render()}else{H++;var r=l.giveEventsController({context:T}),o=function(){H--,e.callback&&e.callback(),r&&r.fireEvent("onContextVisuChangeEnd")};r&&r.fireEvent("onContextVisuChangeBegin");let t=_("modelID",e.sheetID);if(L[n].fatherNode&&L[n].fatherNode.removeChildren(),"DXF/DWG"===L[n].dataType||"DIFSheet"===L[n].dataType||"DIFLayout"===L[n].dataType)L[n].getSheet3DNode({modelID:t,noUdlMessage:N,noUdlWarningMessage:function(){z(n)},end:o,cb:function(e){!function(){q?q.clear():q=new Map;let e=function(t){if(t.getLastElement(!0).getDibInfo&&t.getLastElement(!0).getDibInfo()&&t.getLastElement(!0).getDibInfo().id){let e=t.getLastElement(!0).getDibInfo().id;if(e){q.has(e)||q.set(e,[]);let n=q.get(e);n&&n.push(t)}}let n=t.getChildrenPathes();n&&n.length&&n.forEach(e)};e(T.getRootBagPath())}(),T.getViewer().setBackgroundColor(e&&e.getHex?e.getHex():16777215)}});else{let i=L[n].UDLLoader;if(i){let r=i.getSheetBackgroundColor(t);T.getViewer().setBackgroundColor(r&&r.getHex?r.getHex():16777215),i.getSheet3DNode({sheetID:t,onSheetNodeCreated:function(e){L[n].fatherNode&&L[n].fatherNode.addChild(e),T&&T.getViewer().render()},onSheetLoaded:function(){N.includes(e.sheetID)&&z(n),T&&T.getViewer().render(),o()},onFailure:function(){N.push(e.sheetID),z(n),o()}})}}}}function G(e){var t=l.getReviewContext({context:T}),n=t?t.getCurrentSessionMarkup():null,i=a.giveDMUSlidesController({context:T.getFrameWindow()});if(n&&n.getActiveFlag()&&n.isVisible()&&i){var r=null;if(e)for(var o=t.getUIManager().getFormatEditionModeFlag()?n.getFormats():n.getSlides(),s=0;s<o.length;s++)if(o[s].getEnvironmentOverload().state.sFocusProperty&&o[s].getEnvironmentOverload().state.sFocusProperty.length&&o[s].getEnvironmentOverload().state.sFocusProperty[0]===e){r=o[s];break}i.setActiveSlide(r)}else t&&t.getTransientReviewBag&&t.getTransientReviewBag().removeDMUObjects(),T.getViewpoint().reframe()}function J(e){if(!T)return void(e&&e.callback&&e.callback({error:!0}));var n=null;let i,r=e&&e.parentID?e.parentID:L.length?L[0].parentID:null;if(!r)return;for(let e=0;e<L.length;e++)if(L[e].parentID===r){i=e;break}let o=r===L[0].parentID;if(void 0===i&&(i=0),e&&e.sheetID?n=e.sheetID:L[i].sheetNodes&&L[i].sheetNodes.length&&(n=L[i].sheetNodes[0].sheetID),n){let a=!1,l=_("sheetID",L[i].activatedSheet);if(n!==l){a=!0;let e=parseInt(n);e&&L[i].sheetNodes&&L[i].sheetNodes.length&&(L[i].sheetNodes[e-1].sheetID===l?a=!1:n=L[i].sheetNodes[e-1].sheetID)}if(a)D&&D.destroy(),function(e){for(let t=0;t<L.length;t++)if(L[t].sheetNodes)for(let n=0;n<L[t].sheetNodes.length;n++)if(L[t].sheetNodes[n].sheetID===e)return L[t].sheetNodes[n]}(n)?(e.changeActiveSlide&&G(""),L[i].activatedSheet=_("modelID",n),X({sheetID:n,parentID:r,callback:function(t){o&&e.changeActiveSlide&&G(n),e.callback&&e.callback(t)}}),o&&n&&S&&r===L[0].parentID&&S.setActiveNarBarItem(n)):(D=new t({body:T.getFrameWindow().getUIFrame(),type:"error",message:h.sheetNotExistWarning}),e.callback&&e.callback({error:!0}));else e&&e.callback&&e.callback()}else e&&e.callback&&e.callback()}function K(e){y&&y.updateCurrentPage(e.value);var t=l.giveEventsController({viewer:T.getViewer()});t&&t.fireEvent("onCurrentElementChanged",{currentElement:e.value,endMove:e.endMove})}function Z(e){if(O&&e&&e.paths&&e.paths.length&&e.paths[0].length){let t=e.paths[0][e.paths[0].length-1];t&&(k=t,O.setCurrentElement({elementID:t,duration:200}))}}function Y(e){if(e&&e.paths&&e.paths.length){let t=[];if(e.paths.forEach(e=>{if(O&&O.isADocumentDisplayed()&&"Requirement"===O.getDocumentType()){O.forceElementsLoad([e[e.length-1]]);let n=O.getElementInfo(e[e.length-1]);n&&n.pathElement&&t.push(n.pathElement)}else{let n=e&&e.length>2?[e[e.length-2],e[e.length-1]]:e.length?e:[],i=[];for(let e=n.length-1;e>=0;e--)if(q.has(n[e])&&q.get(n[e]).length){let t=q.get(n[e]);if(i.length)for(let e=i.length-1;e>=0;e--){let n=i[e];t.some(e=>e.isAParentOf(n))||i.splice(e,1)}else i=t.slice()}t=t.concat(i)}}),t.length){let e=f.getCommand("DMUFocusOnRepresentationHdr",T.getCommandContext());e&&e.execute(t)}}}function Q(){if(L&&1===L.length){T.getViewer().set2DMode(!0,"CATIA"),C=T.getViewer().antiAliasing,T.getViewer().setAntiAliasing("MSAA");var e=m.getPreference("CATWebUXPreferences_Select2DGeometry","boolean"),t=p.giveSelectionManager({context:T});t&&t.setPicking(e?0:1),-1!==(M=T.getViewer().getVisuEnv()).indexOf("OCA")&&(M=M.split("OCA")[0]),T.getViewer().setVisuEnvOCA("Basic")}}function $(){if(!T.getFrameWindow())return;let e=0,t=T.getFrameWindow().getImmersiveFrame().getDockingElement(WUXDockAreaEnum.LeftDockArea),n=t.getContainedWindows();if(n&&n.length&&(n[0].isAWindowGroup()&&n[0].getEmbeddedWindows().length||!n[0].isAWindowGroup())){let i=n[0].getEmbeddedWindows?n[0].getEmbeddedWindows():n,r=!1;for(let e=0;e<i.length;e++)i[e].visibleFlag&&(r=!0);e=r&&!t.collapseDockingZoneFlag?t.dockingZoneSize+t._collapserSize:t._collapserSize}else t.interactiveDockAreaVisibleFlag&&(e=t.dockingZoneSize+t._collapserSize);y&&y.setOffset(e)}this.isRunning=function(){return H>0},this.load2DDocument=function(e){if(!e||!T)return;if(!e.onFailure)return;if(!e.phyID)return void e.onFailure();if(!e.dataType)return void e.onFailure();if(!e.parentNode&&"DIFLayout"!==e.dataType&&"DIFSheet"!==e.dataType)return void e.onFailure();if(!e.onComplete)return void e.onFailure();for(let t=0;t<L.length;t++)if(e.phyID===L[t].parentID)return;if(-1!==W.indexOf(e.phyID))return;let i=l.giveEventsController({viewer:T.getViewer()});i&&i.fireEvent("on2DDocumentLoadStarted",{id:e.phyID,type:"2DData"}),e.onLoadingStarted&&e.onLoadingStarted(),H++,W.push(e.phyID);var a=function(n,r){D&&D.destroy(),D=new t({body:T.getFrameWindow().getUIFrame(),type:"error",message:n}),H--,i&&i.fireEvent(r,{id:e.phyID,type:"2DData"}),-1!==W.indexOf(e.phyID)&&W.splice(W.indexOf(e.phyID),1),e.onComplete("fail")},g=function(t){J({sheetID:t,parentID:e.phyID,callback:function(){if(T){1===L.length&&function(){if(S&&S.clean(),L[0]&&L[0].sheetNodes&&L[0].sheetNodes.length){for(var e=[],t=0;t<L[0].sheetNodes.length;t++)e.push({id:L[0].sheetNodes[t].sheetID,label:L[0].sheetNodes[t].label});if(e.length){let t=_("sheetID",L[0].activatedSheet);(S=new n({frameWindow:T.getFrameWindow(),tabs:e,onClickCB:e=>{e&&L&&L.length&&J({sheetID:e,parentID:L[0].parentID,changeActiveSlide:!0})},activeTabIndex:t||e[0].id})).setVisibleFlag(B>0)}}}();var t=l.getReviewContext({context:T}),r=t?t.getCurrentSessionMarkup():null;(!r||r&&!r.getSlides().length)&&T.getViewpoint().reframe(),H--,-1!==W.indexOf(e.phyID)&&W.splice(W.indexOf(e.phyID),1),V.initializeDMUEvents(),i&&i.fireEvent("on2DDocumentLoadSuccess",{id:e.phyID,type:"2DData"})}e.onComplete()}})},u=function(){H--,-1!==W.indexOf(e.phyID)&&W.splice(W.indexOf(e.phyID),1),i&&i.fireEvent("on2DDocumentLoadError",{id:e.phyID,type:"2DData"}),e.onFailure()},c=function(){T.getController().getAttributes({ids:[e.phyID],attributes:["svg"],callbacks:{onComplete:function(t){if(-1!==W.indexOf(e.phyID))if(t[e.phyID]&&t[e.phyID].svg&&""!==t[e.phyID].svg){var n={method:"GET",authentication:"passport",proxy:"none",type:"text",timeout:6e4,cache:3600,onComplete:function(t){if(-1===W.indexOf(e.phyID))return;j||(j=new DOMParser);let n=j.parseFromString(t,"image/svg+xml");if(!n)return void a(h.sheetNotSupported,"on2DDocumentLoadError");let i=[],l=[];if(n.documentElement&&n.documentElement.id?l=[n.documentElement]:n.documentElement&&n.documentElement.childNodes&&n.documentElement.childNodes.length&&n.documentElement.childNodes[0].id&&(l=n.documentElement.childNodes),!l.length)return void a(h.sheetNotSupported,"on2DDocumentLoadError");let s,d,u=l.length-1;for(d=l.length-1;d>=0;d--){if(!l[d].id)return void a(h.sheetNotSupported,"on2DDocumentLoadError");if(-1!==i.indexOf(l[d].id))return void a(h.sheetNotSupported,"on2DDocumentLoadError");i.push(l[d].id)}for(L.push({parentID:e.phyID,dataType:e.dataType,svg:!0,sheetNodes:[],activatedSheet:null,fatherNode:e.parentNode}),d=l.length-1;d>=0;d--)(s=new r(l[d],"Drw."+e.phyID+"_"+l[d].id,T.getViewer())).modelID=l[d].id,s.sheetID="Drw."+e.phyID+"_"+l[d].id,s.label=l[d].textContent,s.setPickable(o.PICKTHROUGH),L[L.length-1].sheetNodes.unshift(s),u>0&&"svg"===l[d].localName&&s.setVisibility(!1),u--;for(d=0;d<L[L.length-1].sheetNodes.length;d++)L[L.length-1].fatherNode.addChild(L[L.length-1].sheetNodes[d]);Q(),g(L[L.length-1].sheetNodes[0].sheetID)},onCancel:u,onFailure:u};d.handleRequest(t[e.phyID].svg,n)}else u()},onFailure:u}})};let p=new s;if(p.setMaxSheetInCache(4),"Drawing"===e.dataType)e.serverUrl?p.loadModel({data:{physicalid:e.phyID,dataType:e.dataType},serverUrl:e.serverUrl,securityContext:e.securityContext?e.securityContext:"prefered",onComplete:function(t){if(-1!==W.indexOf(e.phyID))if(t.sheetIDList&&t.sheetIDList.length){N=[],L.push({parentID:e.phyID,dataType:e.dataType,sheetNodes:[],sheetIDList:t.sheetIDList,activatedSheet:null,fatherNode:e.parentNode,UDLLoader:p});for(var n=0;n<t.sheetIDList.length;n++)L[L.length-1].sheetNodes.push({parentID:e.phyID,modelID:t.sheetIDList[n],sheetID:"Drw."+e.phyID+"_"+t.sheetIDList[n],label:p.getSheetName(t.sheetIDList[n])});Q(),g(L[L.length-1].sheetNodes[0].sheetID)}else a(h.objectWithoutSheet,"on2DDocumentLoadError")},onFailure:c}):c();else if("DXF/DWG"===e.dataType||"DIFSheet"===e.dataType||"DIFLayout"===e.dataType){N=[];var m=e.loadedSheetInformations;if(!m||!m.sheetIDList||!m.sheetIDList.length)return void a(h.objectWithoutSheet,"onEmptyDocument");L.push({parentID:"DXF/DWG"===e.dataType?e.parentNode.modelIdentification:e.phyID,dataType:e.dataType,sheetNodes:e.sheetNodes,sheetIDList:m.sheetIDList,activatedSheet:null,fatherNode:e.parentNode,UDLLoader:p,getSheet3DNode:e.getSheet3DNode}),Q(),g(L[L.length-1].sheetNodes[0].sheetID)}else u()},this.loadDocumentStream=function(e){if(!e||!T)return;if(!e.onFailure)return;if(!e.documentID)return void e.onFailure();if(!e.type)return void e.onFailure();if(!e.fatherNode)return void e.onFailure();if(!e.onComplete)return void e.onFailure();V.clean2DDocument();let t=l.giveEventsController({viewer:T.getViewer()});t&&t.fireEvent("on2DDocumentLoadStarted",{type:"Document"}),H++,L.push({parentID:e.documentID,dataType:e.type,fatherNode:null});let n=m.getPreference("CATWebUXPreferences_Select2DGeometry","boolean"),r=p.giveSelectionManager({context:T});r&&r.setPicking(n?0:1),"Document"===e.type||"Requirement"===e.type?require(["DS/WebDocumentVisualization/WebDocumentVisualizationController","DS/WebDocumentVisualization/WebDocumentBookmarksController"],function(n,r){A=n,R=r,O||(O=n.getWebDocumentVisualizationController({context:T})),O.loadDocumentStream({phyId:e.documentID,type:e.type,dataBuffer:e.dataBuffer,elementsToLoad:e.elementsToLoad,fatherNode:e.fatherNode,password:e.password,onPasswordOk:e.onPasswordOk,onIncorrectPassword:()=>{H--,e.onIncorrectPassword()},onComplete:()=>{if("Document"===e.type){y||(T.getFrameWindow().getImmersiveFrame().addEventListener("freeZoneResize",$),y=new i({frameWindow:T.getFrameWindow(),onValueChanged:function(e){O.setCurrentElement({elementID:e})},maxValue:O.getDocumentLength()}));let e=O.getExternalComments(),t=O.getPDFHyperlinks();if(e&&e.length||t&&t.length)l.getReviewContext({viewer:T.getViewer()})||g.createReviewContext({context:T})}if(V.documentHasBookmarks()){U||(U=r.getWebDocumentBookmarksController({context:T}));let t=f.getCommandCheckHeader("WebDocumentBookmarksPanelCmdHdr",T.getCommandContext());if(t){let n=localStorage.getItem("DMUBookmarksPanelDisplayed");("true"===n||"false"!==n&&"Requirement"===e.type)&&t.setState(!0)}}H--,V.initializeDMUEvents(),t&&t.fireEvent("on2DDocumentLoadSuccess",{id:e.documentID,type:"Document"}),e.onComplete()},onFailure:n=>{t&&t.fireEvent("on2DDocumentLoadError",{id:e.documentID,type:"Document"}),H--,n&&window.console.error("Error Loading Document Stream",n.message),e.onFailure(n)}})}):(H--,t&&t.fireEvent("on2DDocumentLoadError",{id:e.documentID,type:"Document"}),e.onFailure(new Error("Data type not supported")))},this.clean2DDocument=function(e){if(T){if(e&&e.id){-1!==W.indexOf(e.phyID)&&W.splice(W.indexOf(e.phyID),1);for(let t=0;t<L.length;t++)if(L[t].parentID===e.id){L[t].fatherNode&&(L[t].fatherNode.removeChildren(),L[t].fatherNode=null),L.splice(t,1);break}}else if(L&&L.length){W.length=0;for(let e=0;e<L.length;e++)L[e].fatherNode&&(L[e].fatherNode.removeChildren(),L[e].fatherNode=null),L.splice(e,1)}if(S&&!L.length&&(S.clean(),S=null),!L||!L.length){if(y&&(y.clean(),T.getFrameWindow().getImmersiveFrame().removeEventListener("freeZoneResize",$)),b&&T.getViewer().setPicking(b),M&&T.getViewer().setVisuEnvOCA(M),T.getViewer().get2DMode()){C&&T.getViewer().antiAliasing!==C&&"MSAA"===T.getViewer().antiAliasing&&T.getViewer().setAntiAliasing(C),T.getViewer().set2DMode(!1);var t=m.getPreference("CATWebUXPreferences_Select3DGeometry","boolean"),n=p.giveSelectionManager({context:T});n&&n.setPicking(t?0:1)}T.getViewer().render(),void 0!==E&&x&&(x.setResponsiveDisplayFlag(E),E=void 0),V.removeDMUEvents(),O&&A&&(O.removeDocument(),A.unreferenceWebDocumentVisualizationController({context:T})),U&&R&&R.unreferenceWebDocumentBookmarksController({context:T}),x&&c.unreferenceDMUMarkupsController({context:T.getViewer()}),x=null,S=C=O=U=k=null,y=b=M=null}}},this.updateDocumentControllers=function(){O=A?A.giveWebDocumentVisualizationController({context:T}):null,U=R?R.giveWebDocumentBookmarksController({context:T}):null,O&&(L.length||L.push({}),L[0].dataType=O.getDocumentType(),L[0].parentID=O.getDocumentLoadedID())},this.initializeDMUEvents=function(){if(O&&(w||(w=new u),P||(P={onCurrentElementChange:O.subscribe("onCurrentElementChange",K),onZoomChange:O.subscribe("onZoomChange",function(e){if("start"===e.type)w.display({modal:!0,frmWindow:T.getFrameWindow(),type:"message",message:h.zoomLabel+" : "+e.value+" %"});else if("change"===e.type)w.updateMessage(h.zoomLabel+" : "+e.value+" %");else if(w.destroy(),O.getMultiPageVisibility()){var t=l.giveEventsController({viewer:T.getViewer()});t&&t.fireEvent("onDMUObjectsVisuRefreshRequired")}}),onElementSelection:O.subscribe("onElementSelection",V.fireCrossWidgetSelection),onDocumentRotationAngleChange:O.subscribe("onDocumentRotationAngleChange",function(){var e=l.getReviewContext({context:T}),t=e?e.getVisibleMarkups():null;t&&t.map(e=>e.getCurrentSlide()).forEach(t=>{t&&t.updateEnvironmentOverload({target:e.getEnvironment(),state:e.getEnvironment().getEnvironmentInfo()})});var n=l.giveEventsController({viewer:T.getViewer()});n&&n.fireEvent("onDMUObjectsVisuRefreshRequired")})}),(x=c.getDMUMarkupsController({context:T.getViewer()}))&&(E=x.getResponsiveDisplayFlag())&&x.setResponsiveDisplayFlag(!1)),!I){I={};var e=l.giveEventsController({viewer:T.getViewer()});"Requirement"===L[0].dataType&&e&&(I.onCrossWidgetSelection=e.addEvent("onCrossWidgetSelection",Z)),e&&(I.onCrossWidgetFind=e.addEvent("onCrossWidgetFind",Y))}},this.removeDMUEvents=function(){if(O){if(P){Object.keys(P).forEach(e=>O.unsubscribe(P[e]))}w&&w.destroy(),void 0!==E&&x&&(x.setResponsiveDisplayFlag(E),E=void 0),c.unreferenceDMUMarkupsController({context:T.getViewer()})}if(I){var e=l.giveEventsController({viewer:T.getViewer()});e&&(I.onCrossWidgetSelection&&e.removeEvent(I.onCrossWidgetSelection),I.onCrossWidgetFind&&e.removeEvent(I.onCrossWidgetFind))}x=w=P=I=null},this.setCurrentElement=function(e){if(O)return O.setCurrentElement(e)},this.isADocumentDisplayed=function(){return L&&L[0]&&L[0].sheetNodes&&L[0].sheetNodes.length>0||O&&O.isADocumentDisplayed()},this.getDocumentRotationAngle=function(){if(O)return O.getDocumentRotationAngle()},this.getDocumentType=function(){return L&&L.length?L[0].dataType:null},this.getDocumentLoadedID=function(){if(L&&L.length&&L[0].parentID)return L[0].parentID},this.getExternalComments=function(){if(O)return O.getExternalComments()},this.getPDFHyperlinks=function(){if(O)return O.getPDFHyperlinks()},this.enableCurrentPageEdition=function(){if(y)return y.enableCurrentPageEdition()},this.setCurrentPageWidgetVisibleFlag=function(e){y&&y.setVisibility(e)},this.setTouchPanActive=function(e){if(O)return O.setTouchPanActive(e)},this.getElementsVisualizationData=function(){if(O)return O.getElementsVisualizationData()},this.getElementInfo=function(e){if(O)return O.getElementInfo(e)},this.getElementMatrix=function(e){if(O)return O.getElementMatrix(e)},this.getPageRotation=function(e){if(O)return O.getPageRotation(e)},this.getPointedElemIDAtPosition=function(e){if(O)return O.getPointedElemIDAtPosition(e)},this.enableTextSelection=function(e){if(O)return O.enableTextSelection(e)},this.setTextSelectionFlag=function(e){if(O)return O.setTextSelectionFlag(e)},this.setLinkActivationFlag=function(e){if(O)return O.setLinkActivationFlag(e)},this.centerViewpointAtElementPosition=function(e){O&&(O.centerViewpointAtElementPosition(e),V.fireCrossWidgetSelection(e.elementID))},this.centerViewpointAtNextOrPreviousElement=function(e){if(O)return O.centerViewpointAtNextOrPreviousElement(e)},this.documentHasMultipleElements=function(){if(O)return O.getDocumentLength()>1},this.documentHasBookmarks=function(){if(!O)return!1;let e=O.getDocumentBookmarks();return Boolean(e&&e.length)},this.setDocumentRotation=function(e){O&&O.setDocumentRotationAngle(e)},this.setMultiPageVisibility=function(e){O&&O.setMultiPageVisibility(e);var t=l.giveEventsController({viewer:T.getViewer()});t&&t.fireEvent("onDMUObjectsVisuRefreshRequired")},this.setBookmarksVisibility=function(e){U&&U.setPanelVisibilityFlag(e)},this.getElementToDraw=function(e){let t=L&&L.length?L[0].dataType:null;if(!t||"Document"!==t&&"Requirement"!==t)return T.getViewer().canvas;var n,i="Document"===t?"WebDocPageLayerPage":"WebDocReqElem";if(e){if(e.id.includes(i))return e;for(n=e.parentNode;n;){if(n.id&&n.id.includes(i))return n;n=n.parentElement}}return null},this.getPointedElem=function(){let e=L&&L.length?L[0].dataType:null;return"Document"===e||"Requirement"===e?T.getViewer().divCssElement:T.getViewer().canvas},this.getPageNumber=function(e){const t="WebDocPageLayerPage";return e&&e!==T.getViewer().canvas&&e.id.includes(t)?parseInt(e.id.slice(t.length)):null},this.getElementId=function(e){return e&&e!==T.getViewer().canvas&&e.id.includes("WebDocReqElem")?e.id.slice("WebDocReqElem".length+1):null},this.fireCrossWidgetSelection=function(e){let{dataType:t,parentID:n}=L&&L.length?L[0]:{};if(e&&e!==n&&k!==e&&"Requirement"===t){k=void 0;var i=l.giveEventsController({viewer:T.getViewer()});i&&i.fireEvent("onFireCrossWidgetSelection",{paths:[[e]]})}},this.setNavBarVisibleFlag=function(e){e?B++:B--,S&&S.setVisibleFlag(B>0)},this.getNavBarVisibleFlag=function(){return S?S.getVisibleFlag():void 0},this.clean=function(){V.clean2DDocument(),D&&D.destroy(),D=j=T=null},this.setCurrentSheet=function(e){var t=e;t&&t.sheet&&(t.sheetID=_("sheetID",t.sheet)),J({sheetID:t.sheetID,parentID:t.parentID?t.parentID:_("parentID",t.sheetID),changeActiveSlide:!1,callback:t.callback})},this.getCurrentSheet=function(){return L&&L.length&&L[0].activatedSheet?_("sheetID",L[0].activatedSheet):null},this.setReviewPlayMode=function(e){F=e},this.getReviewPlayMode=function(){return F},this.getLoadedDocuments=(()=>L?L.slice():[]),this.getDocumentData=function(e){let t,n,i,r=[];for(let t=0;t<L.length;t++)if(L[t].parentID===e){i=t;break}if(void 0!==i&&L[i]&&L[i].sheetIDList){t=L[i].activatedSheet,n=L[i].sheetIDList;for(let e=0;e<L[i].sheetNodes.length;e++)r.push(L[i].sheetNodes[e].label);return{activatedSheetID:t,sheetIDList:n,sheetNames:r}}}}})});