/*!  Copyright 2017 Dassault Systemes. All rights reserved. */
define("DS/Web3DUXFilterBar/Web3DUXFilterBar",["UWA/Core","UWA/Controls/Abstract","DS/Core/PointerEvents","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","css!DS/Web3DUXFilterBar/Web3DUXFilterBar.css"],function(e,t,l,n,a){"use strict";return t.extend({defaultOptions:{body:null,actionBar:null,frmWindow:null,heightElem:"32px",widthElem:"32px",updateVisibilty:!0,typeSeparator:"line",lJsonElement:[],classpanel:"",Idpanel:"",position:null},init:function(t){this._parent(t);var i,s,o,r,c,p,d,b=this,u=this.options||{},h=null,m=[],f={},y=null,g=null,v=u.position,E=!1;function x(e){e.addClassName("Web3DUXFilterActiveState")}function N(e){e.addClassName("Web3DUXFilterInactiveState")}function D(e){e.removeClassName("Web3DUXFilterActiveState")}function S(e){e.removeClassName("Web3DUXFilterInactiveState")}function W(t){var l=e.createElement("div",{class:"Web3DUXFilterSeparator"}).inject(t);return l.addClassName("bubble"===u.typeSeparator?"Web3DUXFilterBubble":"Web3DUXFilterLine"),l}function w(t,n,a,i){var s=e.createElement("div",{class:"Web3DUXFilterBtn",id:t.id,title:t.nls,styles:{top:a,left:i,height:u.heightElem,width:u.widthElem}}).inject(n);new e.Controls.Img({url:t.url,width:"25px",height:"25px"}).inject(s).elements.container.setStyles({position:"absolute",display:"block",padding:"4px"}),f[t.id]=t.callback,m.push(s);var o=new RegExp("Web3DUXFilterActiveState"),r=new RegExp("Web3DUXFilterInactiveState"),c=new RegExp("Web3DUXFilterExcludeType"),p=function(e,t){var l=function(){},n=new RegExp("Web3DUXFilterInactiveState");return t.bexclude&&(l=function(){for(var t=0;t<m.length;t++)e!==m[t]&&(n.test(m[t].className)||(N(m[t]),m[t].bManageOpacity&&(m[t].style.opacity=.5)))}),l}(s,t),d=function(e,t){var l=function(){};return t.bexclude&&(l=function(){for(var t=0;t<m.length;t++)e!==m[t]&&(S(m[t]),m[t].bManageOpacity&&(m[t].style.opacity=1))}),l}(s,t);return s.bManageOpacity=!0,t.bexclude&&(s.addClassName("Web3DUXFilterExcludeType"),s.bManageOpacity=!1),t.bstateActif&&x(s),s.addEvent(l.POINTERUP,function(e){var l;if(r.test(this.className)&&!o.test(this.className)&&t.bexclude){for(S(this),x(this),l=0;l<m.length;l++)s!==m[l]&&c.test(m[l].className)&&(D(m[l]),f[m[l].id]&&f[m[l].id].call(b,e),N(m[l]));t.callback&&t.callback.call(b,e),p&&p.call(b,e)}else if(r.test(this.className)&&!o.test(this.className)&&!t.bexclude||r.test(this.className)&&o.test(this.className)&&!t.bexclude){for(S(this),o.test(this.className)||(x(this),t.callback&&t.callback.call(b,e)),l=0;l<m.length;l++)m[l].style.opacity=1,s!==m[l]&&(o.test(m[l].className)&&(D(m[l]),f[m[l].id]&&f[m[l].id].call(b,e)),r.test(m[l].className)&&S(m[l]));p&&p.call(b,e),g.style.opacity=1}else o.test(this.className)?(D(this),t.callback&&t.callback.call(b,e),d&&d.call(b,e)):(x(this),t.callback&&t.callback.call(b,e),p&&p.call(b,e))}),s.addEvent("mouseenter",function(){t.onEnterCB&&t.onEnterCB({button:t})}),s.addEvent("mouseleave",function(){t.onLeaveCB&&t.onLeaveCB({button:t})}),s}function U(){i=[];for(var t,l,n,a=0,s=0;s<u.lJsonElement.length;s++)"separator"===u.lJsonElement[s].type&&a++;(y=e.createElement("div",{id:"Web3DUXFilterMainDiv"+(u.Idpanel?" "+u.Idpanel:""),class:"Web3DUXFilterMainDiv"+(u.classpanel?" "+u.classpanel:"")})).addEvent("dragstart",function(e){e.preventDefault()}),t="Web3DUXFilterLeftDiv",l=y,(n=e.createElement("div",{html:"",id:t,class:t})).style.display="block",l&&n.inject(l),g=n;for(var o=0;o<a;o++)i.push(W(g));b.setVisibleFlag(!0)}function F(){if(y){!function(){r=40*m.length,y.style.width=r+"px";var e=u.frmWindow.getContent().offsetHeight;p=u.body.getStyle("width").replace(/px/g,"")/2-r/2;let t=u.frmWindow.getActionBar();t&&t.elements&&t.elements.container&&t.elements.container.getStyle("height")&&parseInt(t.elements.container.getStyle("height").replace(/px/g,""),10)>0?(s=parseInt(t.elements.container.getStyle("height").replace(/px/g,""),10),t.elements.container.getStyle("bottom")&&(s+=parseInt(t.elements.container.getStyle("bottom").replace(/px/g,""),10)),s+=50,s+=5):s=145,c=e-s}();var e=v&&!isNaN(v.x)?v.x:p,t=v&&!isNaN(v.y)?v.y:c;y.style.left=e+"px",y.style.top=t+"px",d=new a.Box2(new a.Vector2(e,t),new a.Vector2(e+r,t+o)),E&&(y.style.opacity=.5)}}function X(e){if(y&&E&&d){e||(e=window.event);var t=d.distanceToPoint(new a.Vector2(e.pageX?e.pageX:e.clientX,e.pageY?e.pageY:e.clientY)),l=Math.min(1.5+-.005*t,1);l=Math.max(l,.5),y.style.opacity=l}}this.build=function(){if(u.body&&u.lJsonElement&&(!u.lJsonElement||u.lJsonElement.length)){b.clear();var e,t=[];for(e=0;e<u.lJsonElement.length;e++)"separator"!==u.lJsonElement[e].type&&t.push(u.lJsonElement[e].id);var a=function(e){for(var t=e.length,l=[],n={},a=0;a<t;a++)n[e[a]]=n[e[a]]>=1?n[e[a]]+1:1;for(var i in n)n[i]>1&&l.push(i);return l}(t);if(!a||0===a.length){U();var s=g,r=u.lJsonElement.length;o=0;var c,p=0,d=0,m=0,f=0;for(e=0;e<u.lJsonElement.length;e++){var v=-2*(u.lJsonElement.length/2-1)+2*e+(parseInt(u.widthElem,10)+8)*e+f;if(c=e>u.lJsonElement.length/2?-6*(e-u.lJsonElement.length/2):-6*(u.lJsonElement.length/2-1)+6*e,r<=3)d=v;else if(r%2==0)if(e===u.lJsonElement.length/2||e===u.lJsonElement.length/2-1)d=v;else if(e>=u.lJsonElement.length/2){p=c,d=-2*(u.lJsonElement.length/2-1)+2*(e-1)+(parseInt(u.widthElem,10)+8)*e+f}else p=c,d=v;else e===u.lJsonElement.length/2-.5?d=v:(p=c,d=v);"separator"===u.lJsonElement[e].type?("bubble"===u.typeSeparator?i[m].style.top=p+15+"px":i[m].style.top=p+"px",i[m].style.left=d+"px",(m>=1&&"bubble"!==u.typeSeparator||"bubble"!==u.typeSeparator)&&(i[m].style.transform="translate3d(0%, 0%, 0px) rotate(-15deg) rotateY(85deg)"),m++,f=-(parseInt(u.widthElem,10)+4)*m):(0===e&&(o=p+36),w(u.lJsonElement[e],s,p+"px",d+"px"))}u.body&&(F(),y.inject(u.body),E=!1,u.updateVisibilty&&u.body.parentNode&&u.body.parentNode.parentNode&&(u.body.parentNode.parentNode.addEvent(l.POINTERMOVE,X),E=!0),h=n.subscribe({event:"/VISU/onWindowResized"},function(e){"@onWindowResized"===e.eventType&&F()}))}}},this.setPosition=function(e){v=e,F()},this.getActiveState=function(e){if(y){for(var t=new RegExp("Web3DUXFilterActiveState"),l=0;l<m.length;l++)if(m[l].id===e&&t.test(m[l].className))return!0;return!1}},this.setVisibleFlag=function(e){y&&(y.style.display=e?"block":"none"),e&&F()},this.getVisibleFlag=function(){return!!y&&"block"===y.style.display},this.clear=function(){m=[],f={},y&&(y.destroy(),y=null),g&&(g.destroy(),g=null),E&&u.body&&u.body.parentNode&&u.body.parentNode.parentNode&&u.body.parentNode.parentNode.removeEvent(l.POINTERMOVE,X),h&&(n.unsubscribe(h),h=null)}}})});