!function(e){"use strict";e.importScripts("../AmdLoader/AmdLoader.js"),require.config({baseUrl:".."});var t=null;e.onmessage=function(i){require(["DS/Mesh/ThreeJS_Base","DS/Mesh/Mesh","DS/XCityWorkers/PrimitiveCreator"],function(r,s,n){var a=null;function o(e,i,s){var n=e.datasource,o=n[s],l=o.geometry.coordinates,h=o.properties,d=void 0,u=h.strid,c=h.scale.split(" "),p=h.orient.split(" "),f=Number(h.index),m=new r.Color(16777215),g=Number(h.altitude),v=h.type;void 0!==v&&5===(d=Number(v))&&(d=3);var _=f;void 0!==d&&(_=Math.floor(4*(4-d)+f/4));var y=Math.PI/180*Number(p[0]),b=Math.cos(y),x=Math.sin(y),C=Number(c[0]),S=Number(c[2]),D=.5*C*b,P=.5*C*x,w=8*_;a.startPrimitive();var M=l[0]-n[0].geometry.coordinates[0],T=l[1]-n[0].geometry.coordinates[1];a.pushVertex([M-D,T+P,g]),a.pushVertex([M+D,T-P,g]),a.pushVertex([M+D,T-P,g+S]),a.pushVertex([M-D,T+P,g+S]),a.pushVertex([M+P,T+D,g]),a.pushVertex([M-P,T-D,g]),a.pushVertex([M-P,T-D,g+S]),a.pushVertex([M+P,T+D,g+S]),a.pushNormal([-x,-b,0]),a.pushNormal([-x,-b,0]),a.pushNormal([-b,x,0]),a.pushNormal([-b,x,0]),a.pushNormal([-x,-b,0]),a.pushNormal([-x,-b,0]),a.pushNormal([-b,x,0]),a.pushNormal([-b,x,0]),a.pushTexCoord(0,[t[w],t[w+1]]),a.pushTexCoord(0,[t[w+2],t[w+3]]),a.pushTexCoord(0,[t[w+4],t[w+5]]),a.pushTexCoord(0,[t[w+6],t[w+7]]),a.pushTexCoord(0,[t[w],t[w+1]]),a.pushTexCoord(0,[t[w+2],t[w+3]]),a.pushTexCoord(0,[t[w+4],t[w+5]]),a.pushTexCoord(0,[t[w+6],t[w+7]]);var I=Math.random();a.pushTexCoord(1,[0,I]),a.pushTexCoord(1,[0,I]),a.pushTexCoord(1,[S,I]),a.pushTexCoord(1,[S,I]),a.pushTexCoord(1,[0,I]),a.pushTexCoord(1,[0,I]),a.pushTexCoord(1,[S,I]),a.pushTexCoord(1,[S,I]);var R=8*i;a.pushVertexIndices([R,R+1,R+2]),a.pushVertexIndices([R,R+2,R+3]),a.pushVertexIndices([R+4,R+5,R+6]),a.pushVertexIndices([R+4,R+6,R+7]),a.pushColor([m.r,m.g,m.b,1]),a.pushColor([m.r,m.g,m.b,1]),a.pushColor([m.r,m.g,m.b,1]),a.pushColor([m.r,m.g,m.b,1]),a.pushColor([m.r,m.g,m.b,1]),a.pushColor([m.r,m.g,m.b,1]),a.pushColor([m.r,m.g,m.b,1]),a.pushColor([m.r,m.g,m.b,1]),a.endPrimitive(u)}!0===i.data.init?t=i.data.UVBuffer:function(e,t){a=new n({indexed:!0,normalBinding:n.Binding.VERTEX,useTexCoord:!0,nbTexCoord:2,texCoordBinding:n.Binding.VERTEX,useColor:!0,colorBinding:n.Binding.VERTEX});for(var i=0,r=0;r<e.datasource.length;r++)!1===e.datasource[r].cropped&&(o(e,i,r),i++);t(a.compilePrimitive("Tree",!0))}(i.data,function(t){e.postMessage({result:t})})})}}(this),define("DS/XCityLoaders/ReloadSceneCommand",["DS/ApplicationFrame/Command","DS/AfrCS/AfrCore","DS/CSICommandBinder/CSICommandBinder","DS/CoreUtilities/ErrorManagement"],function(e,t,i,r){"use strict";return e.extend({init:function(){this._parent({mode:"exclusive",isAsynchronous:!1,doServerCall:!0}),this._frameWindow=this.getFrameWindow(),this._frameWindow&&this._frameWindow.getCSIManager&&this._frameWindow.getCSIManager()&&this._frameWindow.getCSIManager()._impl&&this._frameWindow.getCSIManager()._impl.getModel&&(this._clientModel=this._frameWindow.getCSIManager()._impl.getModel()),this.onModeleRemoveFromServer=function(){}},beginExecute:function(){if(this._clientModel){this._clientModel.clear();var e={from:this,operation:"CSISceneTest_CommandAfr_Clear",version:1,msg:t.EXECUTE_OPERATION,callback:this._commandCB.bind(this)},i=t.callOperation(e);return r.hasSucceeded(i)||(r.logResult(i),console.log("CSISceneTest_CommandAfr_Reload callOperation call EXECUTE_OPERATION FAILED with code : "+i)),this._parent()}},setCallbackOnfinish:function(e){this.onModeleRemoveFromServer=e},_commandCB:function(e){!0===e.readBool("commandHasSucceeded")?(console.log("CSISceneTest_CommandAfr_Reload well executed"),this.onModeleRemoveFromServer()):console.log("CSISceneTest_CommandAfr_Reload failed !")}})}),define("DS/XCityTools/RTree",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils"],function(e,t){"use strict";var i=function(e,t,i,r){this.urban=i,this.nb_points=0,this.m=e,this.M=t,this._root=null,this.animation_time=1,this.animation=0,this.oldNodesIndexVisible=[],this.distance=r,this.distanceFactor=1.5},r=function(t,i,r,s,n,a,o,l){this.infos=l,this.instance=o,this.mag=a,this.children=[],this.parent=null,this.urban=this.instance.urban;var h=(s+n)/2;this.boundingBox=new e.Box3(new e.Vector3(t,i,r),new e.Vector3(t+s,i+n,r+h)),this.radius=0,this._computeRadius(),this.center=new e.Vector2((this.boundingBox.max.x+this.boundingBox.min.x)/2,(this.boundingBox.max.y+this.boundingBox.min.y)/2),this.z=r,this.nHits=0};return r.prototype.insert=function(e){var t=new r(e.x,e.y,e.z,e.w,e.h,e.mag,this.instance,e.infos);t.nHits=1;var i,s=this._choosePath2(t),n=s[Math.max(0,s.length-2)];return n._addChild(t),n.children.length>this.instance.M&&(i=n._splitNode(t))._computeMagnitude(),n._computeMagnitude(),null!=(i=this._adjustTree(s,s.length-3,i))?i:this},r.prototype._choosePath=function(e){for(var t=[this],i=this;0!=i.children.length;){for(var s=i.children[0],n=r._computeEnlargement(s,e),a=1;a<i.children.length;a++){var o=r._computeEnlargement(i.children[a],e),l=i.children[a];(o<n||o==n&&r._computeBoundingBoxArea(l.boundingBox)<r._computeBoundingBoxArea(s.boundingBox))&&(s=l,n=o)}t.push(s),i=s}return t},r.prototype._choosePath2=function(e){for(var t=[this],i=this;0!=i.children.length;){for(var s=i.children[0],n=r._computeEnlargement(s,e),a=1;a<i.children.length;a++){var o=r._computeEnlargement(i.children[a],e),l=i.children[a];(o<n||o==n&&r._computeBoundingBoxArea(l.boundingBox)<r._computeBoundingBoxArea(s.boundingBox))&&(s=l,n=o)}t.push(s),i=s}return t},r._computeEnlargement=function(e,t){for(var i=0,r=["x","y","z"],s=0;s<3;s++){var n=r[s],a=e.boundingBox,o=t.boundingBox;i+=Math.max(0,a.min[n]-o.min[n])+Math.max(0,o.max[n]-a.max[n])}return i},r._computeBoundingBoxArea=function(e){var t=Math.abs(e.max.x-e.min.x),i=Math.abs(e.max.y-e.min.y);return t*Math.abs(e.max.z-e.min.z)*i},r.prototype._adjustTree=function(e,t,i){for(var s,n=t,a=i;n>=0;)(s=e[n])._recomputeBoundingBox(),null!=a&&s._addChild(a),s.children.length>this.instance.M?(a=s._splitNode(a),s._computeMagnitude(),a._computeMagnitude()):(s._computeMagnitude(),a=null),n-=1;var o=null;return null!=a&&((o=new r(a.boundingBox.min.x,a.boundingBox.min.y,a.boundingBox.min.z,0,0,0,this.instance,null))._addChild(e[0]),o._addChild(a),o._recomputeBoundingBox(),o._computeMagnitude()),o},r.prototype._splitNode=function(){return this._RPlusTreeSplit()},r.prototype._partition=function(e){var t=this.boundingBox.min.x,i=this.boundingBox.min.y,s=this.children.length/2,n=this._sweep("x",t,s),a=n.cost,o=this._sweep("y",i,s),l=a<=o.cost?n.nodes:o.nodes;this.children=l[0];for(var h=0;h<l[0].length;h++)l[0][h].parent=this;this._recomputeBoundingBox();var d=new r(0,0,0,0,0,0,this.instance);d.children=l[1];for(h=0;h<l[1].length;h++)l[1][h].parent=d;return d._recomputeBoundingBox(),d},r.prototype._sweep=function(e,t,i){this.children.sort(function(t,i){return t.center[e]<i.center[e]?-1:t.center[e]>i.center[e]?1:0});for(var r=[[],[]],s=this.children[0].center[e],n=this.children[this.children.length-1].center[e],a=0,o=0,l=0;l<5;l++){r=[[],[]];for(var h=0;h<this.children.length;h++){var d=this.children[h];r[Math.abs(d.center[e]-s)<Math.abs(d.center[e]-n)?0:1].push(d)}s=0,n=0;for(h=0;h<r[0].length;h++)s+=r[0][h].center[e];s/=r[0].length;for(h=0;h<r[1].length;h++)n+=r[1][h].center[e];if(n/=r[1].length,r[0].length==a&&r[1].length==o)break;a=r[0].length,o=r[1].length}return{cost:-Math.abs(s-n),nodes:r}},r.prototype._RPlusTreeSplit=function(e){return this._partition(e)},r.prototype._addChild=function(t){null==this.boundingBox.min.x?this.boundingBox=new e.Box3(t.boundingBox.min.clone(),t.boundingBox.max.clone()):this._adjustBoundingBox(t),t.parent=this,this.children.push(t),this._computeRadius()},r.prototype._recomputeBoundingBox=function(){if(0!=this.children.length){this.boundingBox=new e.Box3(this.children[0].boundingBox.min.clone(),this.children[0].boundingBox.max.clone());for(var t=1;t<this.children.length;t++)this._adjustBoundingBox(this.children[t]);this._computeCenter(),this._computeRadius()}},r.prototype._computeCenter=function(){if(0!=this.children.length){this.center=new e.Vector2(0,0);for(var t=0;t<this.children.length;t++)this.center.add(this.children[t].center);this.center=new e.Vector2(this.center.x/this.children.length,this.center.y/this.children.length)}},r.prototype._computeRadius=function(){var e=this.boundingBox;this.radius=Math.sqrt(Math.pow(e.max.x-e.min.x,2)+Math.pow(e.max.y-e.min.y,2))/2},r.prototype._adjustBoundingBox=function(e){this.boundingBox.min.x=Math.min(this.boundingBox.min.x,e.boundingBox.min.x),this.boundingBox.min.y=Math.min(this.boundingBox.min.y,e.boundingBox.min.y),this.boundingBox.min.z=Math.min(this.boundingBox.min.z,e.boundingBox.min.z),this.boundingBox.max.x=Math.max(this.boundingBox.max.x,e.boundingBox.max.x),this.boundingBox.max.y=Math.max(this.boundingBox.max.y,e.boundingBox.max.y),this.boundingBox.max.z=Math.max(this.boundingBox.max.z,e.boundingBox.max.z),this._computeCenter(),this._computeRadius()},r.prototype._getBiggestEnclosedNodesPerLevel=function(t,i,r,s,n){var a=[];if(s<n&&this.children.length>0){for(var o=0;o<this.children.length;o++){var l=this.children[o]._getBiggestEnclosedNodesPerLevel(t,i,r,s+1,n);a=a.concat(l)}return a}return this._inViewGeometry(new e.Vector3(this.center.x,this.center.y,0),i,r,s,t)&&a.push(this),this.splitted=!1,a},r.prototype._getNodesInDistance=function(e,t,i,r,s,n,a){var o=[],l=!1;if(this.nHits>1&&this.nHits<a)l=!0;else for(var h=0;h<this.children.length;++h){if(Math.sqrt(Math.pow(e.x-this.children[h].center.x,2)+Math.pow(e.y-this.children[h].center.y,2)+Math.pow(e.z-(this.children[h].boundingBox.max.z+this.children[h].boundingBox.min.z)/2,2))-this.children[h].radius<s){l=!0;break}}if(l){this.instance.nodesIndexVisible.push(1);for(h=0;h<this.children.length;++h){var d=this.children[h]._getNodesInDistance(e,t,i,r+1,s/2,n/2,a);o=o.concat(d)}}else o.push(this),this.instance.nodesIndexVisible.push(0);return o},r.prototype._getNodesInDistanceTest=function(e,t,i,r,s,n,a){var o=[],l=!1;if(Math.sqrt(Math.pow(e.x-this.center.x,2)+Math.pow(e.y-this.center.y,2)+Math.pow(e.z-(this.boundingBox.max.z+this.boundingBox.min.z)/2,2))<this.openDistance*this.instance.distanceFactor&&(l=!0),l){this.instance.nodesIndexVisible.push(1);for(var h=0;h<this.children.length;++h){var d=this.children[h]._getNodesInDistanceTest(e,t,i,r+1,s/2,n/2,a);o=o.concat(d)}}else o.push(this),this.instance.nodesIndexVisible.push(0);return o},r.prototype._getNodeByInstanceId=function(e){if(1!==this.instance.nodesIndexVisible[this.instance.indexInList])return this.instance.indexInList++,this.nHits>1?e===this.instance.indexNode?this:void this.instance.indexNode++:void 0;this.instance.indexInList++;for(var t=0;t<this.children.length;++t){var i=this.children[t]._getNodeByInstanceId(e);if(void 0!==i)return i}},r.prototype._computeNodePoint=function(){return new e.Vector4(this.center.x,this.center.y,this.radius,this.mag)},r.prototype._computeMagnitude=function(){if(0!=this.children.length){this.mag=0;for(var e=0;e<this.children.length;e++){var t=this.children[e];this.mag+=t.mag}}},r.prototype.computeBoxHeight=function(e){return Math.max((this.boundingBox.max.x-this.boundingBox.min.x+this.boundingBox.max.y-this.boundingBox.min.y)/2,4e4/Math.pow(2,e))},r.prototype._inViewGeometry=function(t,i,r,s,n){var a=r.z,o=this.computeBoxHeight(s);this.boundingBox.min.z=a,this.boundingBox.max.z=a+10*o;new e.Vector3(t.x,t.y,a);return this.__frustumIntersectsBox(i,this.boundingBox)},r.prototype.__frustumIntersectsBox=function(t,i){for(var r=t.planes,s=i.min,n=new e.Vector3(i.min.x,i.min.y,i.max.z),a=new e.Vector3(i.min.x,i.max.y,i.min.z),o=new e.Vector3(i.min.x,i.max.y,i.max.z),l=new e.Vector3(i.max.x,i.min.y,i.min.z),h=new e.Vector3(i.max.x,i.min.y,i.max.z),d=new e.Vector3(i.max.x,i.max.y,i.min.z),u=i.min,c=0;c<6;c++){var p=0;if(p+=r[c].distanceToPoint(s)<0?1:0,p+=r[c].distanceToPoint(l)<0?1:0,p+=r[c].distanceToPoint(a)<0?1:0,p+=r[c].distanceToPoint(d)<0?1:0,p+=r[c].distanceToPoint(n)<0?1:0,p+=r[c].distanceToPoint(h)<0?1:0,p+=r[c].distanceToPoint(o)<0?1:0,8==(p+=r[c].distanceToPoint(u)<0?1:0))return!1}return!0},r.prototype.__zoomLevel=function(e,t,i){var r=i.z,s=this.computeBoxHeight(t);return this.boundingBox.min.z=r,this.boundingBox.max.z=r+s,this.boundingBox.max.z>=e.z},r.prototype._toBeSplitted=function(e,t,i){return Math.pow((this.instance.M+this.instance.m)/2,t)<100||this.__zoomLevel(e,t,i)},r.prototype.getAllLeaves=function(){for(var e=[],t=0;t<this.children.length;++t)e=e.concat(this.children[t].getAllLeaves());return 1===this.nHits&&0===this.children.length&&e.push(this),e},i.prototype.insert=function(e){this.nb_points++,null==this._root?(this._root=new r(e.x,e.y,e.z,e.w,e.h,e.mag,this,null),this._root._addChild(new r(e.x,e.y,e.z,e.w,e.h,e.mag,this,e.infos)),this._root.children[0].nHits=1,this._root._computeMagnitude()):this._root=this._root.insert(e)},i.prototype.interpolatePointsOpening=function(t,i){for(var r=this._nodesToVec4(t),s=0;s<t.length;s++){var n=r[s],a=t[s].parent,o=new e.Vector2(n.x,n.y),l=new e.Vector2(a.center.x,a.center.y);o.subVectors(l,o),o.multiplyScalar(1-i),n.set(n.x+o.x,n.y+o.y,a.radius-(a.radius-n.z)*i,n.w)}return r},i.prototype.interpolatePointsClosing=function(t,i){for(var r=this._nodesToVec4(t),s=0;s<t.length;s++){var n=r[s],a=t[s].parent,o=new e.Vector2(n.x,n.y),l=new e.Vector2(a.center.x,a.center.y);o.subVectors(l,o),o.multiplyScalar(i),n.set(n.x+o.x,n.y+o.y,n.z+(a.radius-n.z)*i,n.w)}return r},i.prototype._nodesToVec4=function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i]._computeNodePoint());return t},i.prototype.newgetVisiblePoints=function(e,t,i){if(void 0===this.last_level_displayed&&(this.last_level_displayed=2),2!=this.last_level_displayed){if(!(this.animation>=this.animation_time)){var r=this.urban.USR.timeDelta;this.animation+=r,this.animation>this.animation_time&&(this.animation=this.animation_time);var s=this.animation/this.animation_time,n=null;return 2>this.last_level_displayed?(n=this._root._getBiggestEnclosedNodesPerLevel(e,t,i,0,2),n=this.interpolatePointsOpening(n,s)):(n=this._root._getBiggestEnclosedNodesPerLevel(e,t,i,0,this.last_level_displayed),n=this.interpolatePointsClosing(n,s)),{visiblePoints:n}}this.animation=0}var a=this._root._getBiggestEnclosedNodesPerLevel(e,t,i,0,2);return this.last_level_displayed=2,{visiblePoints:this._nodesToVec4(a)}},i.prototype.getVisiblePoints=function(e,t,i){for(var r=0;Math.pow((this.M+this.m)/2,r)<100||e.z<this.thresholds[r];)r+=1;if(void 0===this.last_level_displayed&&(this.last_level_displayed=r),this.last_level_displayed!=r){if(!(this.animation>=this.animation_time)){var s=this.urban.USR.timeDelta;this.animation+=s,this.animation>this.animation_time&&(this.animation=this.animation_time);var n=this.animation/this.animation_time,a=null;return r>this.last_level_displayed?(a=this._root._getBiggestEnclosedNodesPerLevel(e,t,i,0,r),a=this.interpolatePointsOpening(a,n)):(a=this._root._getBiggestEnclosedNodesPerLevel(e,t,i,0,this.last_level_displayed),a=this.interpolatePointsClosing(a,n)),{visiblePoints:a,scale:scale}}this.animation=0}var o=this._root._getBiggestEnclosedNodesPerLevel(e,t,i,0,r);return this.last_level_displayed=r,{visiblePoints:this._nodesToVec4(o)}},i.prototype.getVisibleNodes=function(e,t,i,r){void 0===this.last_level_displayed&&(this.last_level_displayed=2),this.nodesIndexVisible=[];var s=this._root._getNodesInDistance(e,t,i,0,this.distance,200,r),n=!1;if(this.oldNodesIndexVisible.length!==this.nodesIndexVisible.length)n=!0;else for(var a=0;a<this.nodesIndexVisible;++a)this.oldNodesIndexVisible[a]!==this.nodesIndexVisible[a]&&(n=!0);return this.oldNodesIndexVisible=this.nodesIndexVisible,this.last_level_displayed=2,{visibleNodes:s,changed:n}},i.prototype.computeHits=function(){this._root.computeHits()},r.prototype.computeHits=function(){for(var e=0;e<this.children.length;++e)this.nHits+=this.children[e].computeHits();return this.nHits},i.prototype.computeClusterIds=function(){this._clusterIndex=0,this._root.computeClusterIds()},r.prototype.computeClusterIds=function(){this.clusterId=this.instance.clusterSTRID+"_"+this.instance._clusterIndex,this.instance._clusterIndex++;for(var e=0;e<this.children.length;++e)this.children[e].computeClusterIds()},i.prototype.computeDistances=function(e,t){this._root.computeDistances(Math.max(e,t),Math.max(e,t))},r.prototype.computeDistances=function(e,t){var i=(this.boundingBox.max.x-this.boundingBox.min.x)/2,r=(this.boundingBox.max.y-this.boundingBox.min.y)/2,s=Math.abs(i*e),n=Math.abs(r*t);this.openDistance=Math.max(s,n);for(var a=0;a<this.children.length;++a)this.children[a].computeDistances(e,t)},i.prototype.getVisibleNodesTest=function(e,t,i,r,s){this.distanceFactor=s;void 0===this.last_level_displayed&&(this.last_level_displayed=2),this.nodesIndexVisible=[];var n=this._root._getNodesInDistanceTest(e,t,i,0,this.distance,200,r),a=!1;if(this.oldNodesIndexVisible.length!==this.nodesIndexVisible.length)a=!0;else for(var o=0;o<this.nodesIndexVisible;++o)this.oldNodesIndexVisible[o]!==this.nodesIndexVisible[o]&&(a=!0);return this.oldNodesIndexVisible=this.nodesIndexVisible,this.last_level_displayed=2,{visibleNodes:n,changed:a}},i.prototype.getNodeByInstanceId=function(e){return this.indexInList=0,this.indexNode=0,this._root._getNodeByInstanceId(e)},i}),define("DS/XCityTools/DebugLineChart",["UWA/Class"],function(e){"use strict";var t=function(e,t){this.isActive=!1,this.states=[],this.width=e,this.statDiv=document.getElementById("Stats"),this.debug=t,null!==this.statDiv&&(this.statDiv.style.cssText="display:none;width:"+e+"px;opacity:0.6;cursor:pointer",this.frameDrop=50,this.initStates())};return t.prototype={addCallback:function(e,t){this.callbacks[e]=t},initStates:function(){this.addStates("Fps",void 0,60,60,"#ffff00"),this.addStates("Render",void 0,60,60,"#ff0000"),this.addStates("DrawCalls",void 0,100,60,"#00ffff"),this.addStates("Textures",void 0,200,60,"#ff00ff"),this.addStates("DLRequested",void 0,100,60,"#00ff00"),this.addStates("DLInProcess",void 0,10,60,"#5555ff")},addStates:function(e,t,i,r,s){void 0===i&&(i=60),void 0===r&&(r=60),void 0===s&&(s="#0ff"),void 0===t&&(t=this.debug.callbacks[e]);var n={name:e,callback:t,min:Number.MAX_VALUE,max:-Number.MAX_VALUE,maxChart:i};for(n.text=document.createElement("div"),n.text.id="fpsText",n.text.style.cssText="color:"+s+";font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px;background-color:#000000;opacity:1.0",n.text.innerHTML="name",this.statDiv.appendChild(n.text),n.graph=document.createElement("div"),n.graph.id="fpsGraph",n.graph.style.cssText="position:relative;width:"+this.width+"px;height:"+r+"px;background-color:"+s,this.statDiv.appendChild(n.graph);n.graph.children.length<this.width;){var a=document.createElement("span");a.style.cssText="width:1px;height:"+r+"px;float:left;background-color:#113",n.graph.appendChild(a)}this.statDiv.style.display="block",n.height=r,n.color=s,n.numMax=0,n.numMin=0,this.states.push(n)},update:function(e){if(this.frameDrop)this.frameDrop--;else if(this.isActive)for(var t=0;t<this.states.length;t++){var i=this.states[t];if(i.callback){var r=i.callback(e);i.min=Math.min(i.min,r),i.max=Math.max(i.max,r);var s=i.graph.appendChild(i.graph.firstChild);if(r>i.maxChart){if(i.numMax++,30===i.numMax){i.numMax=15,i.maxChart=Math.ceil(i.max/i.maxChart)*i.maxChart;for(var n=0;n<i.graph.children.length-1;n++)i.graph.children[n].style.height=Math.max(1,i.height-i.graph.children[n].value*i.height/i.maxChart)+"px"}}else if(r<.2*i.maxChart){if(r>0&&(i.numMin++,120===i.numMin)){i.numMin=60,i.maxChart=Math.round(.5*i.maxChart);for(n=0;n<i.graph.children.length-1;n++)i.graph.children[n].style.height=Math.max(1,i.height-i.graph.children[n].value*i.height/i.maxChart)+"px"}}else i.numMin=0,i.numMax=0;i.text.textContent=i.name+": "+r+" /"+i.maxChart+" ("+i.min+"-"+i.max+")",s.value=r,s.style.height=Math.max(1,i.height-r*i.height/i.maxChart)+"px"}}}},t}),define("DS/XCityWorkers/PrimitiveCreator",["DS/Mesh/Mesh"],function(e){"use strict";var t=function(i){this.processPrimitive=!1,this.verticesPerFace=3,this.nbBuffers=0,this.nbPrimitives=0,this.primitiveList=[],this.current=void 0,this.normal=void 0,this.color=void 0,this.texcoord=void 0,this.usercomp=void 0,this.vertexBindingArray=void 0,this.faceBindingArray=void 0,this.primitiveBindingArray=void 0,this.userBindingArray=void 0;var r=function(t,i,r){var s=this.nbBuffers++,n=new e.Buffer;return null!=t?n.component=t:n.indexBuffer=!0,n.format=i,n.dimension=r,n.data=[],n.size=0,{id:s,buffer:n}}.bind(this);this.normalBinding=void 0,this.colorBinding=void 0,this.texCoordBinding=void 0,this.userCompBinding=void 0;var s,n=function(i){switch(i){case t.Binding.FACE:return void 0===this.faceBindingArray&&(this.faceBindingArray=r(void 0,e.DataTypeEnum.UINT,1)),i;case t.Binding.PRIMITIVE:return void 0===this.primitiveBindingArray&&(this.primitiveBindingArray=r(void 0,e.DataTypeEnum.UINT,1)),i;case t.Binding.CUSTOM:return void 0===this.userBindingArray&&(this.userBindingArray=r(void 0,e.DataTypeEnum.UINT,1)),i;case t.Binding.VERTEX:default:return t.Binding.VERTEX}}.bind(this);if(this.position=r(e.VertexComponentEnum.POSITION,e.DataTypeEnum.FLOAT,3),this.indexed=!!i.indexed&&i.indexed,this.vertexBindingArray=r(void 0,e.DataTypeEnum.UINT,1),this.normal=r(e.VertexComponentEnum.NORMAL,e.DataTypeEnum.FLOAT,3),this.normalBinding=n(i.normalBinding),i.useColor&&(this.color=r(e.VertexComponentEnum.DIFFUSE_COLOR,e.DataTypeEnum.FLOAT,4),this.colorBinding=n(i.colorBinding)),i.useTexCoord){this.texcoord=[],this.texCoordBinding=[];var a=i.nbTexCoord?i.nbTexCoord:1;for((0===a||a>8)&&(a=1),s=0;s<a;++s)this.texcoord.push(r(e.VertexComponentEnum.TEX_COORD_0+s,e.DataTypeEnum.FLOAT,3)),i.texCoordBinding&&i.texCoordBinding.length?this.texCoordBinding.push(n(i.texCoordBinding[s])):this.texCoordBinding.push(n(i.texCoordBinding))}if(i.useUserComp){this.usercomp=[],this.userCompBinding=[];var o=i.nbUserComp?i.nbUserComp:1;for((0===o||o>8)&&(o=1),s=0;s<o;++s)this.usercomp.push(r(e.VertexComponentEnum.USER_COMPONENT_0+s,e.DataTypeEnum.FLOAT,3)),i.userCompBinding&&i.userCompBinding.length?this.userCompBinding.push(n(i.userCompBinding[s])):this.userCompBinding.push(n(i.userCompBinding))}};return t.prototype._concat=function(e,t){var i;for(i=t.length;i;i--)e.push(t[t.length-i])},t.prototype.pushVertexIndices=function(e){if(this.processPrimitive&&e instanceof Array){var t,i,r,s,n,a;if(this._concat(this.current.vertexBindingArray,e),this.faceBindingArray)for(t=0,i=e.length;t<i;++t)if((r=this.current.nbVertexIndices+t)%this.verticesPerFace==0){for(s=Math.floor(r/this.verticesPerFace),n=[],a=this.verticesPerFace;a--;)n.push(s);this._concat(this.current.faceBindingArray,n)}this.current.nbVertexIndices+=e.length}},t.prototype.pushVertex=function(e){this.processPrimitive&&(this.indexed||this.pushVertexIndices([this.current.nbVertices]),this.current.position.push(e[0]),this.current.position.push(e[1]),this.current.position.push(e[2]),this.current.nbVertices++)},t.prototype.pushNormal=function(e){this.processPrimitive&&e instanceof Array&&3===e.length&&(this.current.normal.push(e[0]),this.current.normal.push(e[1]),this.current.normal.push(e[2]),this.current.nbNormals++)},t.prototype.pushColor=function(e){this.processPrimitive&&void 0!==this.color&&e instanceof Array&&(this.current.color.push(e[0]),this.current.color.push(e[1]),this.current.color.push(e[2]),4!==e.length?this.current.color.push(1):this.current.color.push(e[2]),this.current.nbColors++)},t.prototype.pushTexCoord=function(e,t){this.processPrimitive&&void 0!==this.texcoord&&void 0!==this.texcoord[e]&&t instanceof Array&&(this.current.texcoord[e].push(t[0]),this.current.texcoord[e].push(t[1]),3===t.length?this.current.texcoord[e].push(t[2]):this.current.texcoord[e].push(0))},t.prototype.pushUserComp=function(e,t){this.processPrimitive&&void 0!==this.usercomp&&void 0!==this.usercomp[e]&&t instanceof Array&&(this.current.usercomp[e].push(t[0]),this.current.usercomp[e].push(t[1]),this.current.usercomp[e].push(t[2]))},t.prototype.startPrimitive=function(t){if(!this.processPrimitive){var i,r;if(this.processPrimitive=!0,this.current={},this.current.connectivity=void 0!==t?t:e.ConnectivityTypeEnum.TRIANGLES,this.current.nbVertexIndices=0,this.current.vertexBindingArray=[],this.faceBindingArray&&(this.current.faceBindingArray=[]),this.userBindingArray&&(this.current.userBindingArray=[]),this.current.nbVertices=0,this.current.position=[],this.current.nbNormals=0,this.current.normal=[],this.color&&(this.current.color=[],this.current.nbColors=0),this.texcoord)for(this.current.texcoord=[],this.current.nbTexcoord=[],i=0,r=this.texcoord.length;i<r;++i)this.current.texcoord.push([]),this.current.nbTexcoord.push(0);if(this.usercomp)for(this.current.usercomp=[],this.current.nbUserComp=[],i=0,r=this.usercomp.length;i<r;++i)this.current.usercomp.push([]),this.current.nbUserComp.push(0)}},t.prototype.endPrimitive=function(i){if(this.processPrimitive)if(0!==this.current.nbVertexIndices){if(this.current.nbVertexIndices%this.verticesPerFace!=0)return console.warn("PrimitiveCreator: Missing indices to complete last triangle."),void console.warn("Not manage so far. Please complete your primitive to continue.");var r,s,n=function(i,r,s,n){var a=new e.VertexComponent;switch(a.nbValuesPerVertex=r.buffer.dimension,a.component=r.buffer.component,a.format=r.buffer.format,a.nbVertices=s,a.bufferId=r.id,a.offset=r.buffer.size/a.nbValuesPerVertex,n){case t.Binding.FACE:a.indices=new e.IndexArray,a.indices.format=this.faceBindingArray.buffer.format,a.indices.bufferId=this.faceBindingArray.id,a.indices.offset=this.faceBindingArray.buffer.size;break;case t.Binding.PRIMITIVE:a.indices=new e.IndexArray,a.indices.format=this.primitiveBindingArray.buffer.format,a.indices.bufferId=this.primitiveBindingArray.id,a.indices.offset=this.primitiveBindingArray.buffer.size;break;case t.Binding.CUSTOM:a.indices=new e.IndexArray,a.indices.format=this.userBindingArray.buffer.format,a.indices.bufferId=this.userBindingArray.id,a.indices.offset=this.userBindingArray.buffer.size;break;case t.Binding.VERTEX:default:a.indices=new e.IndexArray,a.indices.format=this.vertexBindingArray.buffer.format,a.indices.bufferId=this.vertexBindingArray.id,a.indices.offset=this.vertexBindingArray.buffer.size}i.addVertexComponent(a)}.bind(this),a=new e.Primitive;if(a.identifier=void 0===i||""===i?this.nbPrimitives:i,a.nbIndices=this.current.nbVertexIndices,a.connectivity=this.current.connectivity,a.attr={fill:new e.FillAttributes,line:new e.LineAttributes,point:new e.PointAttributes},n(a,this.position,this.current.nbVertices),n(a,this.normal,this.current.nbNormals,this.normalBinding),this.color&&n(a,this.color,this.current.nbColors,this.colorBinding),this.texcoord)for(r=0,s=this.texcoord.length;r<s;++r)n(a,this.texcoord[r],this.current.nbTexcoord[r],this.texCoordBinding[r]);if(this.usercomp)for(this.current.usercomp=[],r=0,s=this.usercomp.length;r<s;++r)n(a,this.usercomp[r],this.current.nbUserComp[r],this.userCompBinding[r]);if(this._concat(this.position.buffer.data,this.current.position),this.position.buffer.size+=this.current.position.length,this._concat(this.normal.buffer.data,this.current.normal),this.normal.buffer.size+=this.current.normal.length,this.color&&(this._concat(this.color.buffer.data,this.current.color),this.color.buffer.size+=this.current.color.length),this.texcoord)for(r=0,s=this.texcoord.length;r<s;++r)this._concat(this.texcoord[r].buffer.data,this.current.texcoord[r]),this.texcoord[r].buffer.size+=this.current.texcoord[r].length;if(this.usercomp)for(r=0,s=this.usercomp.length;r<s;++r)this._concat(this.usercomp[r].buffer.data,this.current.usercomp[r]),this.usercomp[r].buffer.size+=this.current.usercomp[r].length;if(this._concat(this.vertexBindingArray.buffer.data,this.current.vertexBindingArray),this.vertexBindingArray.buffer.size+=this.current.vertexBindingArray.length,this.faceBindingArray&&(this._concat(this.faceBindingArray.buffer.data,this.current.faceBindingArray),this.faceBindingArray.buffer.size+=this.current.faceBindingArray.length),this.primitiveBindingArray){for(var o=[],l=this.current.nbVertexIndices;l--;)o.push(this.nbPrimitives);this._concat(this.primitiveBindingArray.buffer.data,o),this.primitiveBindingArray.buffer.size+=this.current.nbVertexIndices}this.userBindingArray&&(this._concat(this.userBindingArray.buffer.data,this.current.userBindingArray),this.userBindingArray.buffer.size+=this.current.userBindingArray.length),this.primitiveList.push(a),this.nbPrimitives++,this.current=void 0,this.processPrimitive=!1}else console.warn("PrimitiveCreator: Vertex indices is empty.")},t.prototype.compilePrimitive=function(t,i){var r,s,n=new e.PrimitiveGroup;if(void 0!==i&&(n.editable=i),n.name=t,n.fillAttr=new e.FillAttributes,n.lineAttr=new e.LineAttributes,n.pointAttr=new e.PointAttributes,this.position.buffer.data=new Float32Array(this.position.buffer.data),this.normal.buffer.data=new Float32Array(this.normal.buffer.data),this.color&&(this.color.buffer.data=new Float32Array(this.color.buffer.data)),this.texcoord)for(r=0,s=this.texcoord.length;r<s;++r)this.texcoord[r].buffer.data=new Float32Array(this.texcoord[r].buffer.data);if(this.usercomp)for(r=0,s=this.usercomp.length;r<s;++r)this.usercomp[r].buffer.data=new Float32Array(this.usercomp[r].buffer.data);if(this.vertexBindingArray.buffer.data=new Uint16Array(this.vertexBindingArray.buffer.data),this.faceBindingArray&&(this.faceBindingArray.buffer.data=new Uint16Array(this.faceBindingArray.buffer.data)),this.primitiveBindingArray&&(this.primitiveBindingArray.buffer.data=new Uint16Array(this.primitiveBindingArray.buffer.data)),this.userBindingArray&&(this.userBindingArray.buffer.data=new Uint16Array(this.userBindingArray.buffer.data)),n.addBuffer(this.position.id,this.position.buffer),n.addBuffer(this.normal.id,this.normal.buffer),this.color&&n.addBuffer(this.color.id,this.color.buffer),this.texcoord)for(r=0,s=this.texcoord.length;r<s;++r)n.addBuffer(this.texcoord[r].id,this.texcoord[r].buffer);if(this.usercomp)for(r=0,s=this.usercomp.length;r<s;++r)n.addBuffer(this.usercomp[r].id,this.usercomp[r].buffer);for(n.addBuffer(this.vertexBindingArray.id,this.vertexBindingArray.buffer),this.faceBindingArray&&n.addBuffer(this.faceBindingArray.id,this.faceBindingArray.buffer),this.primitiveBindingArray&&n.addBuffer(this.primitiveBindingArray.id,this.primitiveBindingArray.buffer),this.userBindingArray&&n.addBuffer(this.userBindingArray.id,this.userBindingArray.buffer),r=this.nbPrimitives;r;r--)n.addPrimitive(this.primitiveList[this.nbPrimitives-r]);return n},t.Binding={VERTEX:0,FACE:1,PRIMITIVE:2,CUSTOM:3},t}),define("DS/XCityEffects/HeatMapRTreeShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t={defines:{POSTPRO:1},uniforms:{points:{type:"v4v",value:[]},zoomLevel:{type:"f",value:1},tDiffuse:{type:"t",value:null},zBuffer:{type:"t",value:null},test:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},realViewMatrixInverse:{type:"m4",value:new e.Matrix4},worldSize:{type:"f",value:1},reductionFactor:{type:"f",value:100},shift:{type:"v3",value:new e.Vector3}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * ( viewMatrix * (modelMatrix * vec4( position, 1.0 )));","}"].join("\n"),fragmentShader:["uniform vec4 points[100];","uniform vec3 shift;","uniform sampler2D tDiffuse;","uniform sampler2D test;","uniform sampler2D zBuffer;","uniform mat4 realProjectionMatrixInverse;","uniform mat4 realViewMatrixInverse;","uniform float worldSize;","uniform float reductionFactor;","uniform float zoomLevel;","varying vec2 vUv;","vec3 hsv2rgb(vec3 c)","{"," vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);"," vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);"," return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}","// Takes a value between 0 and 1","float bound_linear(float val, float step)","{"," float res = min(1.0, val * step);"," return res;","}","// Takes a value between 0 and 1","float bound_exp(float val, float factor)","{"," float res = min(1.0, (exp(val) - (1.0 * factor)) * factor);"," return res;","}","void main() {","  vec4 zColor = texture2D( zBuffer, vUv );","  vec4 color = texture2D(  tDiffuse, vUv );","  float z = zColor.a;","  vec4 pointSS = vec4(vUv * 2.0 - 1.0, z * 2.0 - 1.0, 1.0);","  vec4 pointVS = realProjectionMatrixInverse * pointSS;","  pointVS /= pointVS.w;","  vec4 pointWS = realViewMatrixInverse * pointVS;","  vec2 fragWorldPos = pointWS.xy;","  float result = 0.0;","  float sat = 0.0;","  for (int i = 0; i < 100; ++i)","  {","    float maxDistance = points[i].z;","    vec2 centeredPoint = points[i].xy - shift.xy + (worldSize / 2.0);","    float radius = points[i].z;","    float intensity = points[i].w;","    float distance = distance(centeredPoint, fragWorldPos);","    sat = max(sat, 1.0 - step(maxDistance, distance));","  }","  vec3 rgb = hsv2rgb(vec3(0.5, 1.0, sat));","  gl_FragColor = color + vec4(rgb, 1.0);","}"].join("\n")},i={defines:{POSTPRO:1},uniforms:{points:{type:"v4v",value:[]},zoomLevel:{type:"f",value:1},tDiffuse:{type:"t",value:null},zBuffer:{type:"t",value:null},test:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},realViewMatrixInverse:{type:"m4",value:new e.Matrix4},worldSize:{type:"v2",value:new e.Vector2},reductionFactor:{type:"f",value:100},shift:{type:"v3",value:new e.Vector3}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * ( viewMatrix * (modelMatrix * vec4( position, 1.0 )));","}"].join("\n"),fragmentShader:["uniform vec4 points[900];","uniform vec3 shift;","uniform sampler2D tDiffuse;","uniform sampler2D test;","uniform sampler2D zBuffer;","uniform mat4 realProjectionMatrixInverse;","uniform mat4 realViewMatrixInverse;","uniform vec2 worldSize;","uniform float reductionFactor;","uniform float zoomLevel;","varying vec2 vUv;","void main() {","  vec4 zColor = texture2D( zBuffer, vUv );","  vec4 color = texture2D(  tDiffuse, vUv );","  float z = zColor.a;","  vec4 pointSS = vec4(vUv * 2.0 - 1.0, z * 2.0 - 1.0, 1.0);","  vec4 pointVS = realProjectionMatrixInverse * pointSS;","  pointVS /= pointVS.w;","  vec4 pointWS = realViewMatrixInverse * pointVS;","  vec2 fragWorldPos = pointWS.xy;","  float result = 1.0;","  float th = 50.0;","  float col = 1.0;","if (z >= 0.0001)","{","  for (int i = 0; i < 900; i += 2)","  {","    vec4 pmin = points[i];","    vec4 pmax = points[i + 1];","    result = result * (","     1.0 - min((","       step(fragWorldPos.x, pmin.x + th)","       * step(pmin.x - th, fragWorldPos.x)","     )","     +","     (","       step(pmax.x - th, fragWorldPos.x)","       * step(fragWorldPos.x, pmax.x + th)","     )","     +","     (","       step(pmax.y - th, fragWorldPos.y)","       * step(fragWorldPos.y, pmax.y + th)","     )","     +","     (","       step(fragWorldPos.y, pmin.y + th)","       * step(pmin.y - th, fragWorldPos.y)","     )","     , 1.0)","     * step(fragWorldPos.x, pmax.x + th)","     * step(fragWorldPos.y, pmax.y + th)","     * step(pmin.x - th, fragWorldPos.x)","     * step(pmin.y - th, fragWorldPos.y)","     );","  }","  result *= col;","  gl_FragColor = vec4(result, result, result, 1.0) * color;","}","else {","  gl_FragColor = color;","}","}"].join("\n")};return{FinalBlending:{defines:{POSTPRO:1},uniforms:{points:{type:"v4v",value:[]},zoomLevel:{type:"f",value:1},tDiffuse:{type:"t",value:null},zBuffer:{type:"t",value:null},test:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},realViewMatrixInverse:{type:"m4",value:new e.Matrix4},minCoord:{type:"v2",value:new e.Vector2},maxCoord:{type:"v2",value:new e.Vector2},worldSize:{type:"v2",value:new e.Vector2},reductionFactor:{type:"f",value:100},maxMag:{type:"f",value:1},opacity:{type:"f",value:.75},shift:{type:"v3",value:new e.Vector3},nHits:{type:"f",value:1e3},boundMin:{type:"f",value:1},boundMax:{type:"f",value:100},kernel:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * ( viewMatrix * (modelMatrix * vec4( position, 1.0 )));","}"].join("\n"),fragmentShader:["uniform vec4 points[900];","uniform vec3 shift;","uniform float nHits;","uniform float boundMin;","uniform float boundMax;","uniform float kernel;","uniform sampler2D tDiffuse;","uniform sampler2D test;","uniform sampler2D zBuffer;","uniform mat4 realProjectionMatrixInverse;","uniform mat4 realViewMatrixInverse;","uniform vec2 minCoord;","uniform vec2 maxCoord;","uniform vec2 worldSize;","uniform float reductionFactor;","uniform float zoomLevel;","uniform float maxMag;","uniform float opacity;","varying vec2 vUv;","vec3 hsv2rgb(vec3 c)","{"," vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);"," vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);"," return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}","vec3 palette2(float vtoc) {"," vec3 dcOffset = vec3(0.5, 0.5, 0.5);"," vec3 amplitude = vec3(0.5, 0.5, 0.5);"," vec3 frequency = vec3(0.5, 0.5, 0.5);"," vec3 phase = vec3(0.5, 0.8332, 1.1665);"," return dcOffset + amplitude * cos( 6.28318 * (frequency * vtoc + phase) );","}","vec3 palette1(float vtoc) {"," vec3 dcOffset = vec3(0.65, -0.710, 0.3);"," vec3 amplitude = vec3(-0.75, 1.7, 0.6);"," vec3 frequency = vec3(0.5, 0.34, 0.368);"," vec3 phase = vec3(1.0, 0.813, 0.087);"," return dcOffset + amplitude * cos( 6.28318 * (frequency * vtoc + phase) );","}","vec3 palette3(float vtoc) {"," vec3 dcOffset = vec3(2.0, -1.0, -1.0);"," vec3 amplitude = vec3(2.0, 2.0, 2.5);"," vec3 frequency = vec3(0.7, 0.66, 0.670);"," vec3 phase = vec3(0.5, 0.833, 1.107);"," return dcOffset + amplitude * cos( 6.28318 * (frequency * vtoc + phase) );","}","vec3 palette(float vtoc) {"," vec3 dcOffset = vec3(1.5484, -0.421, -0.961);"," vec3 amplitude = vec3(2.1284, 1.4884, 2.6584);"," vec3 frequency = vec3(0.6384, 0.7984, 0.6884);"," vec3 phase = vec3(0.6384, 0.9084, 1.184);"," return dcOffset + amplitude * cos( 6.28318 * (frequency * vtoc + phase) );","}","vec3 paletteGM(float vtoc) {"," vec3 dcOffset = vec3(2.06, 0.54, -1.87);"," vec3 amplitude = vec3(2.4, 0.6, 3.88);"," vec3 frequency = vec3(0.25, 0.78, 0.80);"," vec3 phase = vec3(-0.420, 0.783, 0.0);"," return dcOffset + amplitude * cos( 6.28318 * (frequency * vtoc + phase) );","}","vec3 paletteGM2(float vtoc) {"," vec3 dcOffset = vec3(-0.371, -1.011, -0.990);"," vec3 amplitude = vec3(2.3384, 2.8184, 1.9184);"," vec3 frequency = vec3(0.5884, 0.4784, 0.6384);"," vec3 phase = vec3(-0.421, -0.161, 0.965);"," return dcOffset + amplitude * cos( 6.28318 * (frequency * vtoc + phase) );","}","vec3 gradientInterp(float v) {","vec4 colors[12];","colors[0] = vec4(0,0,255,1);","colors[1] = vec4(0,255,255,1);","colors[2] = vec4(0,255,0,1);","colors[3] = vec4(255,255,0,1);","colors[4] = vec4(255,0,0,1);","float size = 1.0 / 4.0;","float floorV = floor(v / size);","int startColor = int(floorV);","float coefInterp = v / size - floorV;","vec4 newColor = vec4(255.0,255.0,255.0,1.0);","if (startColor == 0) {","newColor = mix(colors[0], colors[1], coefInterp);","} else if (startColor == 1) {","newColor = mix(colors[1], colors[2], coefInterp);","} else if (startColor == 2) {","newColor = mix(colors[2], colors[3], coefInterp);","} else if (startColor == 3) {","newColor = mix(colors[3], colors[4], coefInterp);","} else if (startColor == 4) {","newColor = mix(colors[4], colors[5], coefInterp);","} else if (startColor == 5) {","newColor = mix(colors[5], colors[6], coefInterp);","} else if (startColor == 6) {","newColor = mix(colors[6], colors[7], coefInterp);","} else if (startColor == 7) {","newColor = mix(colors[7], colors[8], coefInterp);","} else if (startColor == 8) {","newColor = mix(colors[8], colors[9], coefInterp);","} else if (startColor == 9) {","newColor = mix(colors[9], colors[10], coefInterp);","} else if (startColor == 10) {","newColor = mix(colors[10], colors[11], coefInterp);","}","return newColor.xyz / vec3(255.0);","}","// Takes a value between 0 and 1","float bound_linear(float val, float step)","{"," float res = min(1.0, val * step);"," return res;","}","// Takes a value between 0 and 1","float bound_exp(float val, float factor)","{"," float res = min(1.0, (exp(val) - (1.0 * factor)) * factor);"," return res;","}","void main() {","  vec4 zColor = texture2D( zBuffer, vUv );","  vec4 color = texture2D(  tDiffuse, vUv );","  float z = zColor.a;","  vec4 pointSS = vec4(vUv * 2.0 - 1.0, z * 2.0 - 1.0, 1.0);","  vec4 pointVS = realProjectionMatrixInverse * pointSS;","  pointVS /= pointVS.w;","  vec4 pointWS = realViewMatrixInverse * pointVS;","  vec2 fragWorldPos = pointWS.xy / pointWS.w;","  float result = 0.0;"," //int kernel = 0;"," float coefKernel = 1.0;","if (z >= 0.0001)","{","  float diagonalWorldSize = sqrt(worldSize.x * worldSize.x + worldSize.y * worldSize.y);","  float totalMag = 0.0;","  float totalProx = 0.0;","  float maxMag = 0.0;","  for (int i = 0; i < 900; ++i)","  {","    if (points[i].x == 0.0 && points[i].y == 0.0 && points[i].z == 0.0 && points[i].w == 1.0) { break; }","    float radius = points[i].z;","    //float mag = max(min(points[i].w, boundMax), max(boundMin,1.0)*points[i].w);","    //float mag = max(min(points[i].w, boundMax), max(boundMin,1.0)*(log(points[i].w)+1.0));","    float mag = max(min(points[i].w, boundMax), max(boundMin,1.0)*sqrt(points[i].w));","    //float mag = points[i].w;","    radius = max(radius, 1.0);","    float maxDistance = radius;","    float maxDistance2 = radius;","    vec2 centeredPoint = points[i].xy - shift.xy + (worldSize / 2.0);","    float distance = distance(centeredPoint, fragWorldPos);","    //if (distance < radius) { gl_FragColor = vec4(1.0,0.0,0.0,1.0); return; } ","    float coefDist = distance/maxDistance;","    float proximity = 0.0;","    if (kernel < 0.5) { ","    coefKernel = 0.75;","    if (coefDist <= 1.0) { ","        proximity = min(1.0, coefDist);","        proximity = 0.75 * (1.0 - pow(proximity,2.0));","    maxMag = max(mag, maxMag);// * log(mag+1.0) / log(nHits);","    //if (proximity > 0.0) {","    //proximity = sqrt(proximity);","    //proximity = proximity * 0.2 + 0.8;","    // totalMag += proximity * log(mag+1.0) / log(nHits);","    totalProx = max(proximity, totalProx);// * log(mag+1.0) / log(nHits);","    //if (totalMag == 0.0) {","    //};","    //}","    //totalMag = maxMag*totalProx;","    }","    }","    else { ","    coefKernel = 1.0 / sqrt(2.0*3.14);","if (coefDist <= 3.0) {"," proximity = (1.0 / sqrt(2.0*3.14)) * exp(-0.5*pow(coefDist,2.0));","}","    }","    totalMag += proximity * mag;","   //if (distance < 100.0) { gl_FragColor = vec4(1.0,1.0,1.0,1.0); return; }","//    float intensity = (log(mag) / log(nHits)) * proximity;//proximity * (mag / 1.0);"," //   result = intensity + result;","  }","  if (totalMag > 0.0) {","  //totalMag = totalProx * log(totalMag+1.0) / log(nHits);"," //totalMag = max(min(totalMag, boundMax*coefKernel), boundMin*coefKernel);"," totalMag = max(0.0, totalMag);","  result = 1.0 * (log(totalMag) / log(nHits)) + 0.0 * (totalMag/nHits) ;"," result = (totalMag*1.0) / (boundMax*coefKernel);// * (nHits / 50.0);"," }","  //result /= maxMag;","  result = min(result, 1.0);","  float discard_low = smoothstep(0.0, 0.05, result);","  float blendfactor = discard_low;","  blendfactor = blendfactor * opacity;","  gl_FragColor = vec4(mix(color.rgb, gradientInterp(result), blendfactor), 1.0);","  //gl_FragColor = vec4(result, 0.0, 0.0, 1.0);"," if (totalMag == 0.0) { ","  gl_FragColor = color;","  }","}","else {","  gl_FragColor = color;","}","}"].join("\n")},DebugTree:t,DebugBB:i,DebugShader:{defines:{POSTPRO:1},uniforms:{points:{type:"v4v",value:[]},zoomLevel:{type:"f",value:1},tDiffuse:{type:"t",value:null},zBuffer:{type:"t",value:null},test:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},realViewMatrixInverse:{type:"m4",value:new e.Matrix4},minCoord:{type:"v2",value:new e.Vector2},maxCoord:{type:"v2",value:new e.Vector2},worldSize:{type:"v2",value:new e.Vector2},reductionFactor:{type:"f",value:100},maxMag:{type:"f",value:1},shift:{type:"v3",value:new e.Vector3}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * ( viewMatrix * (modelMatrix * vec4( position, 1.0 )));","}"].join("\n"),fragmentShader:["uniform vec4 points[900];","uniform vec3 shift;","uniform sampler2D tDiffuse;","uniform sampler2D test;","uniform sampler2D zBuffer;","uniform mat4 realProjectionMatrixInverse;","uniform mat4 realViewMatrixInverse;","uniform vec2 minCoord;","uniform vec2 maxCoord;","uniform vec2 worldSize;","uniform float reductionFactor;","uniform float zoomLevel;","uniform float maxMag;","varying vec2 vUv;","vec3 hsv2rgb(vec3 c)","{"," vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);"," vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);"," return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}","vec3 palette(float vtoc) {"," vec3 dcOffset = vec3(0.5, 0.5, 0.5);"," vec3 amplitude = vec3(0.5, 0.5, 0.5);"," vec3 frequency = vec3(0.5, 0.5, 0.5);"," vec3 phase = vec3(0.5, 0.8332, 1.1665);"," return dcOffset + amplitude * cos( 6.28318 * (frequency * vtoc + phase) );","}","// Takes a value between 0 and 1","float bound_linear(float val, float step)","{"," float res = min(1.0, val * step);"," return res;","}","// Takes a value between 0 and 1","float bound_exp(float val, float factor)","{"," float res = min(1.0, (exp(val) - (1.0 * factor)) * factor);"," return res;","}","void main() {","  vec4 zColor = texture2D( zBuffer, vUv );","  vec4 color = texture2D(  tDiffuse, vUv );","  float z = zColor.a;","  vec4 pointSS = vec4(vUv * 2.0 - 1.0, z * 2.0 - 1.0, 1.0);","  vec4 pointVS = realProjectionMatrixInverse * pointSS;","  pointVS /= pointVS.w;","  vec4 pointWS = realViewMatrixInverse * pointVS;","  vec2 fragWorldPos = pointWS.xy;","  float result = 0.0;","if (z >= 0.0001)","{","  float diagonalWorldSize = sqrt(worldSize.x * worldSize.x + worldSize.y * worldSize.y);","  for (int i = 0; i < 900; ++i)","  {","    float radius = points[i].z;","    float mag = points[i].w;","    radius = max(radius, 1.0);","    float maxDistance = radius;","    vec2 centeredPoint = points[i].xy - shift.xy + (worldSize / 2.0);","    float distance = distance(centeredPoint, fragWorldPos);","    float proximity = max(0.0, maxDistance - distance);","    float intensity = proximity * (mag / radius);","    result = intensity + result;","  }","  result /= maxMag;","  result = min(result, 1.0);","  if (result > 0.1) { result = 1.0; }","  else if (result > 0.00) { result = 0.5; }","  float discard_low = smoothstep(0.0, 0.1, result) / 2.0;","  vec3 rgb_dark = hsv2rgb(vec3(0.5 - result * 0.5, 1.0, discard_low));","  vec3 rgb_light = hsv2rgb(vec3(0.5 - result * 0.5, discard_low, 1.0));","  gl_FragColor = vec4(mix(color.rgb, palette(result), discard_low), 1.0);","}","else {","  gl_FragColor = color;","}","  gl_FragColor = zColor;","}"].join("\n")},ShaderLoopSize:900}}),define("DS/XCityEffects/ViewshedShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=[{uniforms:{tNormalDepth:{type:"t",value:null},tDepthCameraViewshed0:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},realViewMatrix:{type:"m4",value:new e.Matrix4},viewshedMatrix0:{type:"m4",value:new e.Matrix4},bias0:{type:"f",value:5e-6}},vertexShader:["varying vec2 vUv;","void main() {","  vUv = uv;","   gl_Position = projectionMatrix * (viewMatrix * (modelMatrix * vec4( position, 1.0 )));","}"].join("\n"),fragmentShader:["uniform mat4 realProjectionMatrixInverse;","uniform mat4 realViewMatrix;","uniform mat4 viewshedMatrix0;","uniform float bias0;","uniform sampler2D tNormalDepth;","uniform sampler2D tDepthCameraViewshed0;","varying vec2 vUv;","#define NB_VIEWSHED_CAMERA 1","void main() {","  float stateVisible = 0.0;","  float stateNotVisible = 0.0;","  float coef = 1.0/float(NB_VIEWSHED_CAMERA);","  vec2 uvSample = vUv;","  // Compute world space position of the current pixel","  float z = texture2D(tNormalDepth, uvSample).w;","  vec4 posProjected = vec4(uvSample * 2.0 - 1.0, 2.0 * z - 1.0, 1.0);","  vec4 posVS = realProjectionMatrixInverse * posProjected;","  posVS.xyzw /= posVS.w;","  vec4 worldPosition = realViewMatrix * posVS;","  worldPosition /= worldPosition.w;","    // Project it to the camera viewshed space","    vec4 viewshedCoord = viewshedMatrix0 * worldPosition;","    viewshedCoord /= viewshedCoord.w;","    bvec4 inFrustumVec = bvec4 ( viewshedCoord.x > 0.001, viewshedCoord.x < 0.999, viewshedCoord.y > 0.001, viewshedCoord.y < 0.999 );","    bool inFrustum = all( inFrustumVec );","    bvec3 frustumTestVec = bvec3( inFrustum, viewshedCoord.z < 1.0, viewshedCoord.z > 0.0 );","    bool frustumTest = all( frustumTestVec );","    if ( frustumTest ) {","      float viewshedDepth = texture2D(tDepthCameraViewshed0, viewshedCoord.xy).w;","      if (viewshedDepth == 0.0) {}","      else if (viewshedDepth < viewshedCoord.z-bias0) {","        stateNotVisible += coef; // in frustum + invisible","      }","      else {","        stateVisible += coef; // in frustum + visible","      }","    }","  gl_FragColor = vec4(stateVisible, stateNotVisible, 0.0, 1.0);","}"].join("\n")},{uniforms:{tNormalDepth:{type:"t",value:null},tDepthCameraViewshed0:{type:"t",value:null},tDepthCameraViewshed1:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},realViewMatrix:{type:"m4",value:new e.Matrix4},viewshedMatrix0:{type:"m4",value:new e.Matrix4},viewshedMatrix1:{type:"m4",value:new e.Matrix4},bias0:{type:"f",value:5e-6},bias1:{type:"f",value:5e-6}},vertexShader:["varying vec2 vUv;","void main() {","  vUv = uv;","   gl_Position = projectionMatrix * (viewMatrix * (modelMatrix * vec4( position, 1.0 )));","}"].join("\n"),fragmentShader:["uniform mat4 realProjectionMatrixInverse;","uniform mat4 realViewMatrix;","uniform mat4 viewshedMatrix0;","uniform mat4 viewshedMatrix1;","uniform float bias0;","uniform float bias1;","uniform sampler2D tNormalDepth;","uniform sampler2D tDepthCameraViewshed0;","uniform sampler2D tDepthCameraViewshed1;","varying vec2 vUv;","#define NB_VIEWSHED_CAMERA 2","void main() {","  float stateVisible = 0.0;","  float stateNotVisible = 0.0;","  float coef = 1.0/float(NB_VIEWSHED_CAMERA);","  vec2 uvSample = vUv;","  // Compute world space position of the current pixel","  float z = texture2D(tNormalDepth, uvSample).w;","  vec4 posProjected = vec4(uvSample * 2.0 - 1.0, 2.0 * z - 1.0, 1.0);","  vec4 posVS = realProjectionMatrixInverse * posProjected;","  posVS.xyzw /= posVS.w;","  vec4 worldPosition = realViewMatrix * posVS;","  worldPosition /= worldPosition.w;","  // FIRST PASS","    // Project it to the camera viewshed space","    vec4 viewshedCoord = viewshedMatrix0 * worldPosition;","    viewshedCoord /= viewshedCoord.w;","    bvec4 inFrustumVec = bvec4 ( viewshedCoord.x > 0.001, viewshedCoord.x < 0.999, viewshedCoord.y > 0.001, viewshedCoord.y < 0.999 );","    bool inFrustum = all( inFrustumVec );","    bvec2 frustumTestVec = bvec2( inFrustum, viewshedCoord.z < 1.0 );","    bool frustumTest = all( frustumTestVec );","    if ( frustumTest ) {","      float viewshedDepth = texture2D(tDepthCameraViewshed0, viewshedCoord.xy).w;","      if (viewshedDepth == 0.0) {}","      else if (viewshedDepth < viewshedCoord.z-bias0) {","        stateNotVisible += coef; // in frustum + invisible","      }","      else {","        stateVisible += coef; // in frustum + visible","      }","    }","  // SECOND PASS","    // Project it to the camera viewshed space","    viewshedCoord = viewshedMatrix1 * worldPosition;","    viewshedCoord /= viewshedCoord.w;","    inFrustumVec = bvec4 ( viewshedCoord.x > 0.001, viewshedCoord.x < 0.999, viewshedCoord.y > 0.001, viewshedCoord.y < 0.999 );","    inFrustum = all( inFrustumVec );","    frustumTestVec = bvec2( inFrustum, viewshedCoord.z < 1.0 );","    frustumTest = all( frustumTestVec );","    if ( frustumTest ) {","      float viewshedDepth = texture2D(tDepthCameraViewshed1, viewshedCoord.xy).w;","      if (viewshedDepth == 0.0) {}","      else if (viewshedDepth < viewshedCoord.z-bias1) {","        stateNotVisible += coef; // in frustum + invisible","      }","      else {","        stateVisible += coef; // in frustum + visible","      }","    }","  gl_FragColor = vec4(stateVisible, stateNotVisible, 0.0, 1.0);","}"].join("\n")},{uniforms:{tNormalDepth:{type:"t",value:null},tDepthCameraViewshed0:{type:"t",value:null},tDepthCameraViewshed1:{type:"t",value:null},tDepthCameraViewshed2:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},realViewMatrix:{type:"m4",value:new e.Matrix4},viewshedMatrix0:{type:"m4",value:new e.Matrix4},viewshedMatrix1:{type:"m4",value:new e.Matrix4},viewshedMatrix2:{type:"m4",value:new e.Matrix4},bias0:{type:"f",value:5e-6},bias1:{type:"f",value:5e-6},bias2:{type:"f",value:5e-6}},vertexShader:["varying vec2 vUv;","void main() {","  vUv = uv;","   gl_Position = projectionMatrix * (viewMatrix * (modelMatrix * vec4( position, 1.0 )));","}"].join("\n"),fragmentShader:["uniform mat4 realProjectionMatrixInverse;","uniform mat4 realViewMatrix;","uniform mat4 viewshedMatrix0;","uniform mat4 viewshedMatrix1;","uniform mat4 viewshedMatrix2;","uniform float bias0;","uniform float bias1;","uniform float bias2;","uniform sampler2D tNormalDepth;","uniform sampler2D tDepthCameraViewshed0;","uniform sampler2D tDepthCameraViewshed1;","uniform sampler2D tDepthCameraViewshed2;","varying vec2 vUv;","#define NB_VIEWSHED_CAMERA 3","void main() {","  float stateVisible = 0.0;","  float stateNotVisible = 0.0;","  float coef = 1.0/float(NB_VIEWSHED_CAMERA);","  vec2 uvSample = vUv;","  // Compute world space position of the current pixel","  float z = texture2D(tNormalDepth, uvSample).w;","  vec4 posProjected = vec4(uvSample * 2.0 - 1.0, 2.0 * z - 1.0, 1.0);","  vec4 posVS = realProjectionMatrixInverse * posProjected;","  posVS.xyzw /= posVS.w;","  vec4 worldPosition = realViewMatrix * posVS;","  worldPosition /= worldPosition.w;","  // FIRST PASS","    // Project it to the camera viewshed space","    vec4 viewshedCoord = viewshedMatrix0 * worldPosition;","    viewshedCoord /= viewshedCoord.w;","    bvec4 inFrustumVec = bvec4 ( viewshedCoord.x > 0.001, viewshedCoord.x < 0.999, viewshedCoord.y > 0.001, viewshedCoord.y < 0.999 );","    bool inFrustum = all( inFrustumVec );","    bvec2 frustumTestVec = bvec2( inFrustum, viewshedCoord.z < 1.0 );","    bool frustumTest = all( frustumTestVec );","    if ( frustumTest ) {","      float viewshedDepth = texture2D(tDepthCameraViewshed0, viewshedCoord.xy).w;","      if (viewshedDepth == 0.0) {}","      else if (viewshedDepth < viewshedCoord.z-bias0) {","        stateNotVisible += coef; // in frustum + invisible","      }","      else {","        stateVisible += coef; // in frustum + visible","      }","    }","  // SECOND PASS","    // Project it to the camera viewshed space","    viewshedCoord = viewshedMatrix1 * worldPosition;","    viewshedCoord /= viewshedCoord.w;","    inFrustumVec = bvec4 ( viewshedCoord.x > 0.001, viewshedCoord.x < 0.999, viewshedCoord.y > 0.001, viewshedCoord.y < 0.999 );","    inFrustum = all( inFrustumVec );","    frustumTestVec = bvec2( inFrustum, viewshedCoord.z < 1.0 );","    frustumTest = all( frustumTestVec );","    if ( frustumTest ) {","      float viewshedDepth = texture2D(tDepthCameraViewshed1, viewshedCoord.xy).w;","      if (viewshedDepth == 0.0) {}","      else if (viewshedDepth < viewshedCoord.z-bias1) {","        stateNotVisible += coef; // in frustum + invisible","      }","      else {","        stateVisible += coef; // in frustum + visible","      }","    }","  // THIRD PASS","    // Project it to the camera viewshed space","    viewshedCoord = viewshedMatrix2 * worldPosition;","    viewshedCoord /= viewshedCoord.w;","    inFrustumVec = bvec4 ( viewshedCoord.x > 0.001, viewshedCoord.x < 0.999, viewshedCoord.y > 0.001, viewshedCoord.y < 0.999 );","    inFrustum = all( inFrustumVec );","    frustumTestVec = bvec2( inFrustum, viewshedCoord.z < 1.0 );","    frustumTest = all( frustumTestVec );","    if ( frustumTest ) {","      float viewshedDepth = texture2D(tDepthCameraViewshed2, viewshedCoord.xy).w;","      if (viewshedDepth == 0.0) {}","      else if (viewshedDepth < viewshedCoord.z-bias2) {","        stateNotVisible += coef; // in frustum + invisible","      }","      else {","        stateVisible += coef; // in frustum + visible","      }","    }","  gl_FragColor = vec4(stateVisible, stateNotVisible, 0.0, 1.0);","}"].join("\n")}];return{FinalBlending:{defines:{POSTPRO:1},uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},strength:{type:"f",value:0},nbViewshedCamera:{type:"f",value:0},colorVisible:{type:"c",value:new e.Color(65280)},colorNotVisible:{type:"c",value:new e.Color(16711680)},colorOutOfFrustum:{type:"c",value:new e.Color(10066329)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * ( viewMatrix * (modelMatrix * vec4( position, 1.0 )));","}"].join("\n"),fragmentShader:["#if (POSTPRO == 1)","uniform sampler2D tDiffuse;","#endif","uniform sampler2D tDiffuse2;","uniform float strength;","uniform float nbViewshedCamera;","uniform vec3 colorVisible;","uniform vec3 colorNotVisible;","uniform vec3 colorOutOfFrustum;","varying vec2 vUv;","void main() {","vec2 viewshedState = texture2D( tDiffuse2, vUv ).xy;","#if (POSTPRO == 1)","vec4 color = texture2D(  tDiffuse, vUv );","vec4 viewshedColor = vec4(1.0,1.0,1.0,1.0);","if (viewshedState.x > 0.0) {","    viewshedColor = vec4(colorVisible,1.0);","} else if (viewshedState.y > 0.0) {","viewshedColor = vec4(colorNotVisible,1.0);","} else {","viewshedColor = vec4(colorOutOfFrustum,1.0);","}","gl_FragColor = color*viewshedColor;","#else","gl_FragColor = vec4(vec3(0.0, 1.0);","#endif","}"].join("\n")},CompareDepth:t}}),define("DS/XCityCore/Profile",["UWA/Class/Events","UWA/Class","DS/xCityBasicUtils/Utils"],function(e,t,i){"use strict";var r=t.extend(e,{init:function(e,t){this._name=t,this._urban=e,this._dirty=!1,this._profileNodes=[],this._enabled=!1,this._savable=!0,this._deactivable=!0,this._removable=!0,this._internal=!1,this._temporary=!1},getName:function(){return this._name},add:function(e,t,i){this._profileNodes.push({callback:e,node:t,name:i}),this._dirty=!0},remove:function(e,t){for(var i=0;i<this._profileNodes.length;i++)if(!(e&&e!==this._profileNodes[i].node||t&&t!==this._profileNodes[i].name))return this._profileNodes.splice(i,1),this._dirty=!0,!0;return!1},set:function(e,t,i){var r=0,s=!1;for(r=0;r<this._profileNodes.length&&!s;r++)t===this._profileNodes[r].node&&(s=!0);s&&this._profileNodes.splice(r-1,1),this.add(e,t,i)},setByName:function(e,t,i){var r=0,s=!1,n=this._profileNodes.length;for(r=0;r<n&&!s;r++)i===this._profileNodes[r].name&&(s=!0);s&&this._profileNodes.splice(r-1,1),this.add(e,t,i)},clone:function(e){for(var t=new r(this._urban,e),i=0;i<this._profileNodes.length;i++)t.push({callback:this._profileNodes[i].callback,node:this._profileNodes[i].node});return t},hasNode:function(e){for(var t=0;t<this._profileNodes.length;t++)if(e===this._profileNodes[t].node)return!0;return!1},hasNodeName:function(e){for(var t=0;t<this._profileNodes.length;t++)if(e===this._profileNodes[t].name)return!0;return!1},getNode:function(e){for(var t=0;t<this._profileNodes.length;t++)if(e===this._profileNodes[t].name)return this._profileNodes[t].node},enable:function(e,t){var i;if(this._enabled=!0,t)for(i=0;i<this._profileNodes.length;i++)this._profileNodes[i].node===t&&this._profileNodes[i].callback(this._urban,t,e);else for(i=0;i<this._profileNodes.length;i++)this._profileNodes[i].callback(this._urban,this._profileNodes[i].node,e);this.dispatchEvent("onEnable",[this,t]),this._dirty=!1},disable:function(){this.isDeactivable()&&(this._enabled=!1)},_getInputProfile:function(){return{name:this.getName()}},toString:function(){var e=this._getInputProfile();return JSON.stringify(e)},getManager:function(){return null},duplicate:function(e){i.is(e)||(e=this.getManager()._getNewProfileDefaultName(this.getName()));var t=this._getInputProfile();t.name=e;var r=this.getManager();return i.is(r)?(r.loadProfiles(t),r.getProfile(e)):null},setName:function(e){this._name=e},clean:function(){},isEnabled:function(){return this._enabled},isSavable:function(){return this._savable},isDeactivable:function(){return this._deactivable},isRemovable:function(){return this._removable},isInternal:function(){return this._internal},isTemporary:function(){return this._temporary},setAsInternal:function(e){this._internal=e},setAsSavable:function(e){this._savable=e},setAsDeactivable:function(e){this._deactivable=e},setAsRemovable:function(e){this._removable=e},setAsTemporary:function(e){this._temporary=e}});return r}),define("DS/XCityTools/AtlasBlock",["UWA/Class","DS/xCityBasicUtils/Utils"],function(e,t){"use strict";return e.extend({getIndex:function(){return null===this._fit?-1:this._fit.Index},getX:function(){return null==this._fit?-1:this._fit.x},getY:function(){return null===this._fit?-1:this._fit.y},getPacked:function(){return null!==this._fit},getWidth:function(){return this.texture.getWidth()},getHeight:function(){return this.texture.getHeight()},isCompatibleWith:function(e){return!0},compareTo:function(e){var t=Math.max(this.texture.getWidth(),this.texture.getHeight());return Math.max(e.texture.getWidth(),e.texture.getHeight())-t},init:function(e){this.rootNode=null,this.texture=null,this._fit=null,this.texture=e}})}),define("DS/XCityCoreUI/LightControler",["UWA/Core","UWA/Class","DS/Windows/Dialog","DS/Controls/Button","DS/Controls/ButtonGroup","DS/Controls/ComboBox","DS/Controls/ColorPicker","DS/Controls/SpinBox","DS/Controls/Slider","DS/Controls/LineEditor","DS/Controls/ColorPalette"],function(e,t,i,r,s,n,a,o,l,h,d){"use strict";var u={id:"lightFolder",name:"Created Lights"},c=1e3,p=135,f=45,m=1,g=1,v=["2000","3000","4000","5000","6000","7000","8000","9000","10000"],_=["#FF890E","#FFB16E","#FFCEA6","#FFE4CE","#FFF6ED","#F3F2FF","#DDE6FF","#D2DFFF","#CADAFF"],y=0,b="#ffb16e",x={spot:{type:"spotLight",intensity:-1,physicalAttenuation:!0,attenuationScale:1},area:{type:"areaLight",intensity:-1,mode:"LUMINOUS_EXITANCE"},point:{type:"pointLight",intensity:-1,physicalAttenuation:!0,attenuationScale:1}},C="point",S=0;function D(e){let t=function(){var e=xCity.findItem({id:u.id});return e||xCity.addFolder({id:u.id,name:u.name})}(),i=t.get("children").length+1;e.setZ(e.z+S);let r={Coordinate:{position:{x:e.x,y:e.y,z:e.z},projection:xCity.widgetData.currentReferential.model._attributes.proj,className:"Coordinate"},id:C+i,className:"Light"};console.log(r),xCity.add3DContent({feature:{name:C+i,selected:!0,Content:{...r,...x[C],power:c,color:b,outerAngle:p,innerAngle:f,width:m,height:g},className:"Feature"},parentFolder:t})}function P(e){return e*(Math.PI/180)}return e.Class.extend({init:function(){this.createPanel()},close:function(){},createPanel:function(){this.container=new e.Element("div"),this.content=new e.Element("div",{html:'\n\t\t<div id="container">\n              <div class="xct-dialog" id="xcity-light-dialog">\n\t\t\t\t\t<div class="xct-parameter">\n\t\t\t\t\t\t<div class="xct-label">Type</div>\n\t\t\t\t\t\t<div class="xct-input" id="xcity-light-selector-buttongroup"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="xct-parameter">\n\t\t\t\t\t\t<div class="xct-label">Temperature</div>\n\t\t\t\t\t\t<div class="xct-input" id="xcity-light-temperature-colorpicker"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="xct-parameter">\n\t\t\t\t\t\t<div class="xct-label">Power</div>\n\t\t\t\t\t\t<div class="xct-input" id="xcity-light-power-spinbox"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="xct-parameter" id="xcity-light-angle-parameter">\n\t\t\t\t\t\t<div class="xct-label">Spot Angles</div>\n\t\t\t\t\t\t<div class="xct-input" id="xcity-light-outerangle-slider"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="xct-parameter" id="xcity-light-size">\n\t\t\t\t\t\t<div class="xct-label">Width / Length</div>\n\t\t\t\t\t\t<div class="xct-input" id="xcity-light-size-spinbox"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="xct-parameter">\n\t\t\t\t\t\t<div class="xct-label">Offset</div>\n\t\t\t\t\t\t<div class="xct-input" id="xcity-light-offset-spinbox"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t\x3c!-- div class="xct-parameter">\n\t\t\t\t\t\t<div class="xct-label">Elevation Offset</div>\n\t\t\t\t\t\t<div class="xct-input" id="xcity-light-offsetHeight-spinbox"></div>\n\t\t\t\t\t</div--\x3e\n\t\t\t\t\t<div class="xct-parameter">\n\t\t\t\t\t\t<div class="xct-label"></div>\n\t\t\t\t\t\t<div class="xct-input" id="xcity-light-activation-button"></div>\n\t\t\t\t\t</div>\n              </div>\n        </div>\n        '}),this.container.addContent(this.content),this.selectorDiv=this.content.getElement("#xcity-light-selector-buttongroup"),this.pointLightButton=new r({label:"Point",value:"point",emphasize:"secondary",type:"radio",checkFlag:!0}),this.spotLightButton=new r({label:"Spot",value:"spot",emphasize:"secondary",type:"radio"}),this.areaLightButton=new r({label:"Area",value:"area",emphasize:"secondary",type:"radio"}),this.lightSelectorButtonGroup=new s({}),this.lightSelectorButtonGroup.addChild(this.pointLightButton),this.lightSelectorButtonGroup.addChild(this.spotLightButton),this.lightSelectorButtonGroup.addChild(this.areaLightButton),this.lightSelectorButtonGroup.inject(this.selectorDiv),this.temperatureDiv=this.content.getElement("#xcity-light-temperature-colorpicker"),this.temperatureCombobox=new n({elementsList:v,selectedIndex:1,enableSearchFlag:!1}).inject(this.temperatureDiv),this.temperatureColorPicker=new a({value:"FFB16E"}).inject(this.temperatureDiv),this.powerDiv=this.content.getElement("#xcity-light-power-spinbox"),this.powerSpinbox=new o({units:"lm",stepValue:1}).inject(this.powerDiv),this.powerSpinbox.value=c,this.SpotAngleDiv=this.content.getElement("#xcity-light-angle-parameter"),this.AngleDiv=this.content.getElement("#xcity-light-outerangle-slider"),this.AngleSlider=new l({value:[45,135],minValue:1,maxValue:180,stepValue:1}).inject(this.AngleDiv),this.AngleSlider.value[1]=p,this.AngleSlider.value[0]=f,this.SpotAngleDiv.hide(),this.offsetHeightDiv=this.content.getElement("#xcity-light-offset-spinbox"),this.offsetHeightSpinbox=new o({units:"m",minValue:0,stepValue:1}).inject(this.offsetHeightDiv),this.offsetHeightSpinbox.value=S,this.sizeDiv=this.content.getElement("#xcity-light-size"),this.sizeAreaDiv=this.content.getElement("#xcity-light-size-spinbox"),this.sizeWidthSpinbox=new o({units:"m",minValue:0,stepValue:1}).inject(this.sizeAreaDiv),this.sizeHeightSpinbox=new o({units:"m",minValue:0,stepValue:1}).inject(this.sizeAreaDiv),this.sizeWidthSpinbox.value=m,this.sizeHeightSpinbox.value=g,this.sizeDiv.hide(),this.buttonDiv=this.content.getElement("#xcity-light-activation-button"),this.activationButton=new r({label:"Activate creation",displayStyle:"normal",type:"check",icon:{iconName:"lightbulb",fontIconFamily:WUXManagedFontIcons.Font3DS}}),this.buttonDiv.addContent(this.activationButton),this.lightSelectorButtonGroup.addEventListener("change",e=>{console.log("Selected method : "+this.lightSelectorButtonGroup.value),"spot"==(C=e.dsModel.value)?this.SpotAngleDiv.show():this.SpotAngleDiv.hide(),"area"==C?this.sizeDiv.show():this.sizeDiv.hide()}),this.temperatureColorPicker.addEventListener("change",e=>{b="#"+e.dsModel.value,console.log("Color picker : "+b)}),this.temperatureCombobox.addEventListener("change",e=>{y=e.dsModel.selectedIndex,b=_[y],console.log("Temperature : "+b),this.temperatureColorPicker.value=b.substring(1)}),this.powerSpinbox.addEventListener("change",e=>{c=e.dsModel.value,console.log("Power : "+b)}),this.AngleSlider.addEventListener("change",e=>{p=P(e.dsModel.value[1]),f=P(e.dsModel.value[0]),console.log("Outer angle : "+p),console.log("Inner angle : "+f)}),this.sizeWidthSpinbox.addEventListener("change",e=>{m=e.dsModel.value,console.log("Width : "+m)}),this.sizeHeightSpinbox.addEventListener("change",e=>{g=e.dsModel.value,console.log("Height : "+m)}),this.offsetHeightSpinbox.addEventListener("change",e=>{S=e.dsModel.value}),this.activationButton.addEventListener("buttonclick",e=>{console.log(e),e.dsModel.checkFlag?(e.dsModel.label="Deactivate creation",xCity.onWorldClick(D,!1)):(e.dsModel.label="Activate creation",xCity.removeOnWorldClick())})}})}),define("DS/XCityLoaders/CmdOpenPointCloud",["UWA/Core","DS/StateCommandEngine/StateCommand","DS/AfrCS/AfrCore","DS/Windows/Dialog","DS/CSICommandBinder/CSICommandBinder","DS/CoreUtilities/ErrorManagement"],function(e,t,i,r,s,n){"use strict";return t.extend({OK_COMMAND_EVENT:"okOpenTestAdvancedCommand",init:function(e){e.doServerCall=!0,e.isAsynchronous=!0,e.mode="exclusive",this._parent(e,{}),this.data=null},buildGraph:function(){var e={iSender:this,iEvent:this.OK_COMMAND_EVENT,iInitialState:this.createInitialState("waitBeginState"),iFinalState:this.getFinalState(),iCondition:null,iAction:this._actionExecuteService};this.addTransition(e)},_actionExecuteService:function(e,t){var r=new s.Parameters;r.writeString("inputObjectPath",t.fileURL);var a={from:this,inputs:r,operation:"CSISceneTest_CommandAfr_Import",version:1,msg:i.EXECUTE_OPERATION,callback:this._commandCB.bind(this,t.loadedCB)},o=i.callOperation(a);n.hasSucceeded(o)||(n.logResult(o),console.log("CSISceneTest_CommandAfr_Import callOperation call EXECUTE_OPERATION FAILED with code : "+o)),e()},_commandCB:function(e,t){!0===t.readBool("commandHasSucceeded")?(console.log("CSISceneTest_CommandAfr_Import well executed"),e()):console.log("CSISceneTest_CommandAfr_Import failed !")}})}),define("DS/XCityTools/shapefile",[],function(){"use strict";function e(e){return new t(e instanceof Uint8Array?e:new Uint8Array(e))}function t(e){this._array=e}t.prototype.read=function(){var e=this._array;return this._array=null,Promise.resolve(e?{done:!1,value:e}:{done:!0,value:void 0})},t.prototype.cancel=function(){return this._array=null,Promise.resolve()};var i=function(t){return fetch(t).then(function(t){return t.body&&t.body.getReader?t.body.getReader():t.arrayBuffer().then(e)})},r=function(t){return new Promise(function(i,r){var s=new XMLHttpRequest;s.responseType="arraybuffer",s.onload=function(){i(e(s.response))},s.onerror=r,s.ontimeout=r,s.open("GET",t,!0),s.send()})};function s(e){return("function"==typeof fetch?i:r)(e)}function n(e){return"function"==typeof e.read?e:e.getReader()}var a=new Uint8Array(0);function o(e){return"function"==typeof e.slice?e:new l("function"==typeof e.read?e:e.getReader())}function l(e){this._source=e,this._array=a,this._index=0}l.prototype.read=function(){var e=this,t=e._array.subarray(e._index);return e._source.read().then(function(i){return e._array=a,e._index=0,i.done?t.length>0?{done:!1,value:t}:{done:!0,value:void 0}:{done:!1,value:function(e,t){if(!e.length)return t;if(!t.length)return e;var i=new Uint8Array(e.length+t.length);return i.set(e),i.set(t,e.length),i}(t,i.value)}})},l.prototype.slice=function(e){if((e|=0)<0)throw new Error("invalid length");var t=this,i=this._array.length-this._index;if(this._index+e<=this._array.length)return Promise.resolve(this._array.subarray(this._index,this._index+=e));var r=new Uint8Array(e);return r.set(this._array.subarray(this._index)),function s(){return t._source.read().then(function(n){return n.done?(t._array=a,t._index=0,i>0?r.subarray(0,i):null):i+n.value.length>=e?(t._array=n.value,t._index=e-i,r.set(n.value.subarray(0,e-i),i),r):(r.set(n.value,i),i+=n.value.length,s())})}()},l.prototype.cancel=function(){return this._source.cancel()};var h=function(e){return!(e=e.trim())||isNaN(e=+e)?null:e},d={B:h,C:function(e){return e.trim()||null},D:function(e){return new Date(+e.substring(0,4),e.substring(4,6)-1,+e.substring(6,8))},F:h,L:function(e){return!/^[nf]$/i.test(e)&&(!!/^[yt]$/i.test(e)||null)},M:h,N:h},u=function(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)},c=function(e,t){return(e=o(e)).slice(32).then(function(i){var r=u(i);return e.slice(r.getUint16(8,!0)-32).then(function(i){return new p(e,t,r,u(i))})})};function p(e,t,i,r){this._source=e,this._decode=t.decode.bind(t),this._recordLength=i.getUint16(10,!0),this._fields=[];for(var s=0;13!==r.getUint8(s);s+=32){for(var n=0;n<11&&0!==r.getUint8(s+n);++n);this._fields.push({name:this._decode(new Uint8Array(r.buffer,r.byteOffset+s,n)),type:String.fromCharCode(r.getUint8(s+11)),length:r.getUint8(s+16)})}}var f=p.prototype;f.read=function(){var e=this,t=1;return e._source.slice(e._recordLength).then(function(i){return i&&26!==i[0]?{done:!1,value:e._fields.reduce(function(r,s){return r[s.name]=d[s.type](e._decode(i.subarray(t,t+=s.length))),r},{})}:{done:!0,value:void 0}})},f.cancel=function(){return this._source.cancel()};var m=function(e){var t,i=40,r=e.getInt32(36,!0),s=new Array(r);for(t=0;t<r;++t,i+=16)s[t]=[e.getFloat64(i,!0),e.getFloat64(i+8,!0)];return{type:"MultiPoint",coordinates:s}},g=function(e){return{type:"Point",coordinates:[e.getFloat64(4,!0),e.getFloat64(12,!0)]}},v=function(e){var t,i=44,r=e.getInt32(36,!0),s=e.getInt32(40,!0),n=new Array(r),a=new Array(s),o=[],l=[];for(t=0;t<r;++t,i+=4)n[t]=e.getInt32(i,!0);for(t=0;t<s;++t,i+=16)a[t]=[e.getFloat64(i,!0),e.getFloat64(i+8,!0)];return n.forEach(function(e,t){var i=a.slice(e,n[t+1]);!function(e){if((t=e.length)<4)return!1;var t,i=0,r=e[t-1][1]*e[0][0]-e[t-1][0]*e[0][1];for(;++i<t;)r+=e[i-1][1]*e[i][0]-e[i-1][0]*e[i][1];return r>=0}(i)?l.push(i):o.push([i])}),l.forEach(function(e){o.some(function(t){if(function(e,t){var i,r=-1,s=t.length;for(;++r<s;)if(i=_(e,t[r]))return i>0;return!1}(t[0],e))return t.push(e),!0})||o.push([e])}),1===o.length?{type:"Polygon",coordinates:o[0]}:{type:"MultiPolygon",coordinates:o}};function _(e,t){for(var i=t[0],r=t[1],s=-1,n=0,a=e.length,o=a-1;n<a;o=n++){var l=e[n],h=l[0],d=l[1],u=e[o],c=u[0],p=u[1];if(y(l,u,t))return 0;d>r!=p>r&&i<(c-h)*(r-d)/(p-d)+h&&(s=-s)}return s}function y(e,t,i){var r=i[0]-e[0],s=i[1]-e[1];if(0===r&&0===s)return!0;var n=t[0]-e[0],a=t[1]-e[1];if(0===n&&0===a)return!1;var o=(r*n+s*a)/(n*n+a*a);return!(o<0||o>1)&&(0===o||1===o||o*n===r&&o*a===s)}var b=function(e){var t,i=44,r=e.getInt32(36,!0),s=e.getInt32(40,!0),n=new Array(r),a=new Array(s);for(t=0;t<r;++t,i+=4)n[t]=e.getInt32(i,!0);for(t=0;t<s;++t,i+=16)a[t]=[e.getFloat64(i,!0),e.getFloat64(i+8,!0)];return 1===r?{type:"LineString",coordinates:a}:{type:"MultiLineString",coordinates:n.map(function(e,t){return a.slice(e,n[t+1])})}},x=function(e,t){var i=new Uint8Array(e.length+t.length);return i.set(e,0),i.set(t,e.length),i},C={0:function(){return null},1:g,3:b,5:v,8:m,11:g,13:b,15:v,18:m,21:g,23:b,25:v,28:m},S=function(e){return(e=o(e)).slice(100).then(function(t){return new D(e,u(t))})};function D(e,t){var i=t.getInt32(32,!0);if(!(i in C))throw new Error("unsupported shape type: "+i);this._source=e,this._type=i,this._index=0,this._parse=C[i],this.bbox=[t.getFloat64(36,!0),t.getFloat64(44,!0),t.getFloat64(52,!0),t.getFloat64(60,!0)]}var P=D.prototype;function w(){}P.read=function(){var e=this;return++e._index,e._source.slice(12).then(function(t){if(null==t)return{done:!0,value:void 0};var i=u(t);function r(){var s=2*i.getInt32(4,!1)-4,n=i.getInt32(8,!0);return s<0||n&&n!==e._type?function s(){return e._source.slice(4).then(function(n){return null==n?{done:!0,value:void 0}:(i=u(t=x(t.slice(4),n))).getInt32(0,!1)!==e._index?s():r()})}():e._source.slice(s).then(function(i){return{done:!1,value:n?e._parse(u(x(t.slice(8),i))):null}})}return r()})},P.cancel=function(){return this._source.cancel()};var M=function(e,t,i){return Promise.all([S(e),t&&c(t,i)]).then(function(e){return new T(e[0],e[1])})};function T(e,t){this._shp=e,this._dbf=t,this.bbox=e.bbox}var I=T.prototype;function R(t,i,r){return"string"==typeof i?(/\.dbf$/.test(i)||(i+=".dbf"),i=s(i)):i instanceof ArrayBuffer||i instanceof Uint8Array?i=e(i):null!=i&&(i=n(i)),"string"==typeof t?(/\.shp$/.test(t)||(t+=".shp"),void 0===i&&(i=s(t.substring(0,t.length-4)+".dbf").catch(function(){})),t=s(t)):t=t instanceof ArrayBuffer||t instanceof Uint8Array?e(t):n(t),Promise.all([t,i]).then(function(e){var t=e[0],i=e[1],s="windows-1252";return r&&null!=r.encoding&&(s=r.encoding),M(t,i,i&&new TextDecoder(s))})}return I.read=function(){return Promise.all([this._dbf?this._dbf.read():{value:{}},this._shp.read()]).then(function(e){var t=e[0],i=e[1];return i.done?i:{done:!1,value:{type:"Feature",properties:t.value,geometry:i.value}}})},I.cancel=function(){return Promise.all([this._dbf&&this._dbf.cancel(),this._shp.cancel()]).then(w)},{open:R,openShp:function(t,i){return"string"==typeof t?(/\.shp$/.test(t)||(t+=".shp"),t=s(t)):t=t instanceof ArrayBuffer||t instanceof Uint8Array?e(t):n(t),Promise.resolve(t).then(S)},openDbf:function(t,i){var r="windows-1252";return i&&null!=i.encoding&&(r=i.encoding),r=new TextDecoder(r),"string"==typeof t?(/\.dbf$/.test(t)||(t+=".dbf"),t=s(t)):t=t instanceof ArrayBuffer||t instanceof Uint8Array?e(t):n(t),Promise.resolve(t).then(function(e){return c(e,r)})},read:function(e,t,i){return R(e,t,i).then(function(e){var t=[],i={type:"FeatureCollection",features:t,bbox:e.bbox};return e.read().then(function r(s){return s.done?i:(t.push(s.value),e.read().then(r))})})}}}),define("DS/XCityCoreUI/Animation",["UWA/Core","UWA/Class","UWA/Element","UWA/Class/Events","UWA/Controls/Input","DS/Controls/Timeline"],function(e,t,i,r,s,n){"use strict";return t.extend({init:function(t){this._parent(t);var r=this;this.container=new e.Element("div");var a=function(){var e=function(){l.setIndex();o()},t=l.openedAnimation;if(Utils.is(t)){for(var i,r=t.getKeyframes(),s=[],n=0;n<r.length;n++)i=r[n].time,s[n]={label:i.toString(),value:i,index:n,onEvent:e,state:0};u.options.maxValue=i,u._realRange=i,u.options.graduations=s,u.getContent().getChildren().forEach(function(e){e.hasClassName("wux-Gauge-scale")&&e.remove()}),u._buildScaling(),u._buildCursor(0),u._buildCursor(1),u.setValue(l.setTime())}},o=function(){g.value=l.setIndex(),v.value=l.setTime()},l=xCity._urbanImpl.getControl(),h=(new s.Button({value:"New Path",events:{onClick:function(e){var t="";Utils.is(l.paths[t])&&(t+="0"),l.createPath(t),d(),h.setValue(t)}}}).inject(this.container),new i("label",{html:" Opened Paths :"}).inject(this.container),new s.Select({events:{onChange:function(e){l.setCurrentPath(h.getValue()[0]),l.goToKeyframe(),a(),o()}}}));h.inject(this.container);var d=function(){for(var t in l.paths)l.paths.hasOwnProperty(t)&&h.putOptions([{label:e.i18n(t),value:t}])};new i("label",{html:" Open File(json or pth) :"}).inject(this.container);new i("input",{html:"file",class:" ",type:"file",events:{change:function(e){var t=this.files[0],i=window.URL.createObjectURL(t),r=new XMLHttpRequest;r.onreadystatechange=function(){4===r.readyState&&200===r.status&&(Utils.endsWith(t.name,".pth")?xCity._urbanImpl.getControl().readPthFile(t.name,r.responseText):Utils.endsWith(t.name,".json")&&xCity._urbanImpl.getControl().setFile(t.name,r.responseText),d(),h.setValue(t.name))},r.open("GET",i,!0),r.send(null)}}}).inject(this.container);new s.Button({value:"Save Path",events:{onClick:function(e){var t,i,r=l.getFile();if(Utils.is(r)){t=r,i=h.getValue()[0],Utils.endsWith(i,".pth")&&(i=i.substring(0,i.lastIndexOf("."))),Utils.endsWith(i,".json")||(i+=".json");var s="data:text/json,"+btoa(t),n=Utils.dataURItoBlob(s);Utils.toDownloadFile(i,n)}else alert("no current path to save")}}}).inject(this.container);var u=new n({minValue:0,maxValue:1e4,value:10,stepValue:.1,dynamicGraduations:!1,dynamicGaugeColor:!1,graduationsLabel:!0,eventsList:[{label:"0",value:0,onEvent:function(){}}],activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container);u.addEvent("change",function(){d(),Utils.is(l.openedAnimation)&&!1===l.openedAnimation.isPlaying()&&l.setAnimationTime(u.getValue())}),[{label:"Play",callback:function(){l.play(),!0===c&&xCity._urbanImpl.getView3D().getRecorder().startRecord(),l.setLoop(m)}},{label:"Pause",callback:function(){l.pause(),!0===c&&xCity._urbanImpl.getView3D().getRecorder().stopRecord(),l.setLoop(m)}},{label:"Stop",callback:function(){l.stop(),l.setIndex(0),l.goToKeyframe(),!0===c&&xCity._urbanImpl.getView3D().getRecorder().stopRecord(),l.setLoop(m),o()}}].forEach(function(e){new i("a",{html:e.label,class:"wux-controls-button",events:{click:e.callback}}).inject(r.container)}),l.timeline=u;var c=!1;new i("label",{html:"Record on Play :"}).inject(this.container),new s.Checkbox({value:"Rec",class:" ",events:{onClick:function(e){c=!c}}}).inject(this.container);new i("label",{html:" time(ms) :"}).inject(this.container);var p=new i("input",{html:" t",class:" ",type:"number",min:0,events:{change:function(e){this.value=l.setAnimationTime(this.valueAsNumber),f.value=1+.025*this.value,u.setValue(this.value)}}}).inject(this.container);new i("label",{html:" frame index :"}).inject(this.container);var f=new i("input",{html:" t",class:" ",type:"number",min:0,events:{change:function(e){var t=40*(this.value-1);p.value=l.setAnimationTime(t),this.value=1+.025*p.value,Debug.log("change event on frameIndex"+t+" , "+p.value+" , "+this.value)}}}).inject(this.container),m=!1;new i("label",{html:" Loop :"}).inject(this.container),new s.Checkbox({value:" Loop",class:" ",events:{onClick:function(e){m=!m,l.setLoop(m)}}}).inject(this.container);new i("label",{html:"<br> Kf index :   "}).inject(this.container);var g=new i("input",{html:" Kf Ind",class:" ",type:"number",min:0,events:{change:function(e){this.value=l.setIndex(this.valueAsNumber);var t=r.urban.getControl().goToKeyframe();Utils.is(t)&&(o(),u.setValue(v.valueAsNumber))}}}).inject(this.container),v=(new i("label",{html:"  Kf Time offset :"}).inject(this.container),new i("input",{html:" Kf Time offset",class:" ",type:"number",min:0,events:{change:function(e){this.value=l.setTime(this.valueAsNumber)}}}).inject(this.container));new s.Button({value:" Add Kf ",class:"",events:{onClick:function(e){l.recordKeyframe(),a(),o()}}}).inject(this.container);new s.Button({value:"OverWrite Kf",class:" ",events:{onClick:function(e){l.overWriteKeyframe(),a(),o()}}}).inject(this.container),new s.Button({value:"Remove Kf",class:" ",events:{onClick:function(e){l.removeKeyframe(),a(),o()}}}).inject(this.container)}})}),define("DS/XCityEffects/AtmosphereShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{FinalBlending:{defines:{POSTPRO:1},uniforms:{tDiffuse:{type:"t",value:null},camPos:{type:"v3",value:new e.Vector3},sunPos:{type:"v3",value:new e.Vector3},turbidity:{type:"f",value:0},rayleigh:{type:"f",value:0},mieCoefficient:{type:"f",value:0},mieDirectionalG:{type:"f",value:0},density:{type:"f",value:0},showroom:{type:"f",value:0},up:{type:"v3",value:new e.Vector3(0,0,1)},totalMie:{type:"v3",value:new e.Vector3},totalRayleigh:{type:"v3",value:new e.Vector3},mieCoefficientS:{type:"f",value:0},sunEClamp:{type:"f",value:0},tNormalDepth:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},realViewMatrix:{type:"m4",value:new e.Matrix4}},vertexShader:["varying vec2 vUv;","uniform float rayleigh;","uniform float turbidity;","uniform float mieCoefficient;","uniform float sunEClamp;","uniform vec3 sunPos;","uniform vec3 up;","uniform vec3 totalMie;","uniform vec3 totalRayleigh;","varying vec3 betaR;","varying vec3 betaM;","varying vec3 sunDir;","varying float sunE;","varying float zenithAngle;","const float e = 2.71828182845904523536028747135266249775724709369995957;","const float EE = 100.0;","const float cutoffAngle = 1.6110731556870734;","float sunIntensity( float zenithAngleCos ) {","\treturn EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) * 0.666666667 ) ) );","}","void main() {","   gl_Position = projectionMatrix * (modelViewMatrix * vec4( position, 1.0 ));","   vUv = uv;","sunDir = normalize(sunPos);","zenithAngle = dot(up, sunDir);","sunE = sunIntensity(zenithAngle) * sunEClamp;","// rayleigh coefficients","betaR = totalRayleigh;","// mie coefficients","betaM = totalMie;","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tNormalDepth;","uniform vec3 camPos;","uniform vec3 sunPos;","uniform float turbidity;","uniform float rayleigh;","uniform float mieCoefficient;","uniform float mieDirectionalG;","uniform float density;","uniform float showroom;","uniform float mieCoefficientS;","uniform mat4 realProjectionMatrixInverse;","uniform mat4 realViewMatrix;","varying vec2 vUv;","varying vec3 betaR;","varying vec3 betaM;","varying float sunE;","varying float zenithAngle;","varying vec3 sunDir;","float rayleighPhase(float cosTheta)","{","return 0.05968310365946075 * (1.0 + pow(cosTheta, 2.0));","}","float hgPhase(float cosTheta, float g)","{","float g2 = pow(g, 2.0);","float inv = 1.0 / pow(1.0 - 2.0*g*cosTheta + g2, 1.5);","return 0.07957747154594767 * ((1.0 - g2) * inv);","}","// Filmic ToneMapping","float A = 0.15;","float B = 0.50;","float C = 0.10;","float D = 0.20;","float E = 0.02;","float F = 0.30;","const float whiteScale = 1.0748724675633854;","vec3 Uncharted2Tonemap(vec3 x)","{","return ((x*(A*x+0.05)+0.004)/(x*(A*x+B)+0.06))-0.0666666667;","}","void main() {","  float z = texture2D(tNormalDepth, vUv).w;","  vec4 posProjected = vec4((vUv * 2.0) - 1.0, (z * 2.0) - 1.0, 1.0);","  vec4 posVS = realProjectionMatrixInverse * posProjected;","  posVS.xyzw /= posVS.w;","  vec4 worldPosition = realViewMatrix * posVS;","  worldPosition /= worldPosition.w;","#if (POSTPRO == 1)","vec3 scenCol = (texture2D(tDiffuse, vUv)).xyz;","float d = density;","if (zenithAngle < 0.3 && turbidity > 10.0)","{","d *= 0.1;","}","float turbdityDensity = pow(turbidity,d);","vec3 rayDir = camPos.xyz-worldPosition.xyz ;","float dist  = clamp(length(rayDir),0.0,10000.0);","float turbidityS = 1.0-smoothstep(0.0,20.0,turbidity);","vec3 betaRM = betaR + betaM;","float cos0 = dot(sunDir, normalize(rayDir));","// combined extinction factor (absorption + outscattering)","vec3 Fex = exp(-pow((betaRM*(dist*(max(1.0,turbdityDensity)))), vec3(max(1.0,2.0*(turbidityS)))));","vec3 betaRTheta = betaR * rayleighPhase(cos0);","vec3 betaMTheta =  betaM * hgPhase(cos0, mieDirectionalG);","vec3 RMthetha = betaRTheta + betaMTheta;","vec3 thetaONbeta = ((RMthetha) / (betaRM));","vec3 Lin = pow(sunE * thetaONbeta * (1.0-Fex), vec3(1.5));","Lin *= mix(vec3(1.0), pow(sunE * thetaONbeta * Fex, vec3(.5)),clamp(pow(1.0-zenithAngle,5.0),0.,1.0));","vec3 curr = clamp(Uncharted2Tonemap(log2(1.366)*Lin), vec3(0.0), vec3(1.0));","vec3 colorTMP = curr*whiteScale;","vec3 retColor = pow(colorTMP,vec3(0.4545));","vec3 col = (scenCol*Fex)+retColor;","gl_FragColor = vec4(col,1.0);","#else","gl_FragColor = vec4(vec3(0.0, 1.0);","#endif","}"].join("\n")}}}),define("DS/XCityTools/Expression",["UWA/Class","DS/xCityBasicUtils/Utils"],function(e,t){"use strict";var i=e.extend({init:function(e){if(e instanceof i)this._set(e._get());else{var t=typeof e;if("number"===t||"string"===t)this.setAsLiteral(e);else{if(Array.isArray(e)){var r,s,n=[],a=e.length;for(r=0;r<a;r++)(s=e[r])instanceof i&&(s=s._get()),n.push(s);e=n}this._set(e),this.usedAttributes=null,this.usedVariables=null,this.stringForm=null}}},clone:function(){return new i(JSON.parse(JSON.stringify(this.toJSON())))},_set:function(e){this.expr=e},setAsPropertyName:function(e){t.is(this.expr)&&t.is(this.expr.PropertyName)?(Array.isArray(this.expr.PropertyName)?this.expr.PropertyName.push(e):this.expr.PropertyName=[this.expr.PropertyName,e],this._set(this.expr)):this._set({PropertyName:e})},propertyName:function(e){return"string"==typeof e?this.setAsPropertyName(e):console.error("property needs a string name"),this},setAsLiteral:function(e){this._set({Literal:e})},literal:function(e){return"object"==typeof e?console.error(" literal should be a basic type number or string"):this.setAsLiteral(e),this},setAsFunction:function(e,t){var i={Function:{}};i.Function[e]=t,this._set(i)},_get:function(){return this.expr},getOperator:function(){var e=null,i=this._getFunction(this.expr);if(t.is(i)){e={};var r=this._internalGetName(i),s=this._internalGetValue(i,r),n=Object.keys(s).length;e[r]=n}return e},_internalGetValue:function(e,i){if(t.is(e)){if(t.is(e.value)){var r=Object.keys(e.value);if(1===r.length){var s=e.value[r[0]];return 1===s.length&&(s=s[0]),s}return e.value}return e[i]}return null},_internalGetName:function(e){return t.is(e)?t.is(e.name)&&t.is(e.name.localPart)?e.name.localPart:Object.keys(e)[0]:null},FunctionList:["Function","ogc:Function","comparisonOps"],_getFunction:function(e){if(t.is(e)){var i,r,s,n=Object.keys(this.FunctionList),a=n.length,o=!1;for(i=0;i<a;i++)if(r=n[i],s=e[this.FunctionList[r]],t.is(s)){o=!0;break}if(o)return s}return null},getOperands:function(){var e=[],i=this._getFunction(this.expr);if(t.is(i))for(var r=this._internalGetName(i),s=this._internalGetValue(i,r),n=Object.keys(s),a=n.length,o=0;o<a;o++){var l=n[o];e.push(this._toJSON(s[l]))}else e.push(this._toJSON(this.expr));return e},_toJSON:function(e){var r=this._internalGetName(e),s=this._internalGetValue(e,r);if("expression"===r)return this._toJSON(s);var n=this._getFunction(e);if(t.is(n))return new i(e);var a={};return a[r]=s,a},toNumber:function(){return this.setAsFunction("toNumber",this._get()),this},add:function(e){var t=new i(e);return this.setAsFunction("Add",[this._get(),t._get()]),this},mul:function(e){var t=new i(e);return this.setAsFunction("Mul",[this._get(),t._get()]),this},sub:function(e){var t=new i(e);return this.setAsFunction("Sub",[this._get(),t._get()]),this},div:function(e){var t=new i(e);return this.setAsFunction("Div",[this._get(),t._get()]),this},toJSON:function(){return this.expr},colorGradient:function(e,r){if(t.is(e)&&t.is(e.keyframes)){var s,n=e.keyframes.length;for(s=0;s<n;s++){var a=e.keyframes[s],o=t.initColor(a.color);a.color="#"+o.getHexString()}}var l=new i(e),h=[this._get(),l._get()];return r&&h.push(r),this.setAsFunction("ColorGradient",h),this},floatGradient:function(e,r){if(t.is(e)&&t.is(e.keyframes)){var s,n=e.keyframes.length;for(s=0;s<n;s++){var a=e.keyframes[s],o=Number(a.float);a.float=o}}var l=new i(e),h=[this._get(),l._get()];return r&&h.push(r),this.setAsFunction("FloatGradient",h),this}});return i}),define("DS/XCityTools/LayerList",["UWA/Class","DS/xCityBasicUtils/Utils"],function(e,t){"use strict";return e.extend({init:function(){this._LayerList=null},setEmptyCallbacks:function(e,t){this.emptyCallback=e,this.notEmptyCallback=t},whenEmpty:function(){t.is(this.emptyCallback)&&this.emptyCallback()},whenNotEmpty:function(){t.is(this.notEmptyCallback)&&this.notEmptyCallback()},hideLayerInList:function(e){t.is(e)&&t.is(this._LayerList[e.id])&&!0===this._LayerList[e.id].visible&&(this._LayerList[e.id].visible=!1,this._LayerList.visibleLength<=0&&this.whenEmpty())},unhideLayerInList:function(e){t.is(e)&&t.is(this._LayerList[e.id])&&!1===this._LayerList[e.id].visible&&(this._LayerList[e.id].visible=!0,1===this._LayerList.visibleLength&&this.whenNotEmpty())},updateList:function(e,t,i,r){i?this.unhideLayerInList(e,t):this.hideLayerInList(e,t)},destroyLayerFromList:function(e){this.removeLayerFromList(e)},addlayerToList:function(e){var i;t.is(e)&&(t.is(this._LayerList)||(this._LayerList={},Object.defineProperties(this._LayerList,{visibleLength:{get(){let e=0;for(let t in this)this.hasOwnProperty(t)&&!0===this[t].visible&&e++;return e++}}}),!0),!t.is(this._LayerList[e.id])&&t.is(e._itemParent)&&(i=e._itemParent.get("visible"),this._LayerList[e.id]={visible:i},e._itemParent.addEvent("onChange:visible",this.updateList.bind(this,e)),e.addEvent("onDestroy",this.destroyLayerFromList.bind(this,e)),i&&1===this._LayerList.visibleLength&&this.whenNotEmpty()))},removeLayerFromList:function(e){t.is(this._LayerList)&&t.is(e)&&t.is(this._LayerList[e.id])&&(delete this._LayerList[e.id],this._LayerList.visibleLength<=0&&this.whenEmpty())}})}),define("DS/XCityRendering/SLDParser",["DS/xCityBasicUtils/Utils","UWA/Class"],function(e,t){"use strict";return t.extend({init:function(){this.textnodename="#text",this.attributenodename="@attributes",this.VALID_SYMBOLIZERS=["LineSymbolizer","TextSymbolizer","PolygonSymbolizer","PointSymbolizer"],this.CONV_TYPE={LineSymbolizer:"line",PolygonSymbolizer:"fill",TextSymbolizer:"symbol",PointSymbolizer:"symbol"},this.VALID_ATTR_TAGS=["Stroke","Fill","Label","Font","Halo","Mark","Size","Geometry","Graphic"],this.CONVERT_ATTR_NAME={stroke:"stroke-color","stroke-width":"stroke-lineWidth","stroke-dasharray":"stroke-dashPattern","stroke-dashoffset":"stroke-dashOffset","stroke-linejoin":"stroke-lineJoin","stroke-linecap":"stroke-lineCap",opacity:"opacity",fill:"color","fill-opacity":"opacity","stroke-opacity":"stroke-opacity","LineSymbolizer-Stroke-stroke-dashoffset":"dashOffset","LineSymbolizer-Stroke-stroke-dasharray":"dashPattern","LineSymbolizer-Stroke-stroke-width":"lineWidth","LineSymbolizer-Stroke-stroke-linecap":"lineCap","LineSymbolizer-Stroke-stroke-linejoin":"lineJoin","LineSymbolizer-Stroke-stroke":"color","LineSymbolizer-Stroke-stroke-opacity":"opacity","PolygonSymbolizer-Fill-fill":"color","PolygonSymbolizer-Fill-fill-opacity":"opacity","PolygonSymbolizer-Fill-opacity":"opacity","font-size":"text-size","font-family":"text-font","font-style":"text-style","font-weight":"text-weight",Label:"text-field","TextSymbolizer-Halo-Fill-fill":"text-halo-color","TextSymbolizer-Fill-fill":"text-color","TextSymbolizer-Font-font-family":"font-family"},this.DIFF_ATTR_TAG=["Label","Halo","Mark","Geometry","Graphic"],this.DIFF_ATTR=["stroke","opacity","fill","fill-opacity","font-size","stroke-width"],this.LABEL_DICT={"background-color":"transparent",border:"medium none color","border-bottom":"medium none color","border-left":"medium none color","border-radius":"0","border-right":"medium none color","border-top":"medium none color",color:"rgb(61, 61, 61)","font-family":"font-family","font-size":"font-size","font-style":"font-style","font-weight":"font-weight","letter-spacing":"normal","line-height":"normal",opacity:"1",padding:"0","text-align":"left","text-decoration":"none currentcolor solid","text-shadow":"none","word-spacing":"normal"}},parseSLD:function(t,i){var r=null;if(e.is(i)&&(this.currentUrl=i),e.is(t)){var s=e.parseXML(t);e.is(s)&&(r=e.xmlToJson(s),r=this.jsonToProfile(r))}return e.is(this.currentUrl)&&(this.currentUrl=null),r},_getfirstchild:function(t){if(e.is(t)){var i,r,s=Object.keys(t),n=s.length;for(i=0;i<n;i++)if((r=s[i])!==this.textnodename&&r!==this.attributenodename)return r}},_readLeaf:function(e,t){return{name:{localPart:t},value:{content:[e[0][this.textnodename]]}}},addToExpression:function(t,i){e.is(t.expression)?Array.isArray(t.expression)?t.expression.push(i):t.expression=[t.expression,i]:t.expression=i},_readFilter:function(e){if(e){var t,i,r,s,n,a,o=Object.keys(e),l=o.length,h={};for(t=0;t<l;t++)switch(r=e[i=o[t]],i){case this.textnodename:case"prefix":break;case"PropertyName":case"Literal":s=this._readLeaf(r,i),this.addToExpression(h,s);break;default:if(Array.isArray(r))for(a=r.length,n=0;n<a;n++){var d=r[n];s={name:{localPart:i},value:this._readFilter(d)},this.isAvailableFunction(i)&&(s={Function:s}),this.addToExpression(h,s)}}return h}},isAvailableFunction:function(e){return["And","Or","Add","Sub","Mul","Div","PropertyIsEqualTo","PropertyIsNotEqualTo","PropertyIsLessThan","PropertyIsLessThanOrEqualTo","PropertyIsGreaterThan","PropertyIsGreaterThanOrEqualTo","PropertyIsBetween"].indexOf(e)>=0},ogctoprofilefilter:function(e){if(!e)return null;this._getfirstchild(e);return this._readFilter(e)},jsonToProfile:function(t){var i,r,s,n,a=t.StyledLayerDescriptor[0].NamedLayer[0].UserStyle[0].FeatureTypeStyle[0],o=t.StyledLayerDescriptor[0].NamedLayer[0].Name[0][this.textnodename],l=[],h=a.Rule;for(e.is(a.Title)&&(s=a.Title[0]),i=0;i<h.length;i++)l.push(h[i]);var d={};for(n=0;n<l.length;n++)i=l[n],r=e.is(i.Name)?i.Name[0][this.textnodename]:"",d[r=this._findnewname(r,d)]=this.jsonToRendering(i,o,s);return d},_findnewname:function(t,i){for(var r=t;e.is(i[r]);)r+=".0";return r},jsonToRendering:function(t,i,r){var s,n,a,o,l=Object.keys(t);(n=t.Filter)&&(n=this.ogctoprofilefilter(n[0]));var h,d,u=!1;if(e.is(n)||void 0===n){for(l.indexOf("PolygonSymbolizer")>=0&&(u=!0),s=0;s<l.length;s++)this.VALID_SYMBOLIZERS.indexOf(l[s])>-1&&(e.is(t.TextSymbolizer)?(a=this.readTextSymbolizer(t.TextSymbolizer),o=this.readTextDataViz(t.TextSymbolizer)):u&&"LineSymbolizer"===l[s]?d=this.readSymbolizer(t[l[s]],l[s],void 0,void 0,void 0,n,i):a=this.readSymbolizer(t[l[s]],l[s],void 0,void 0,void 0,n,i));if(e.is(a)){if(e.is(d)&&(a.stroke=d,a.stroke.enable=!0),h={},e.is(t.Title)&&(a.renderingDescription=t.Title[0][this.textnodename]),e.is(t.Description)){var c=t.Description[0];e.is(c)&&e.is(c.Title)&&(a.renderingDescription=c.Title[0][this.textnodename])}e.is(n)?(h.ElementMaterial=a,h.Filter=n):(e.is(a.renderingDescription)||(a.renderingDescription=r),h.Material=a),e.is(o)&&(e.is(h.ElementRendering)||(h.ElementRendering=[]),h.ElementRendering.push(o))}else console.log("no symbolizer found")}return h},readSymbolizer:function(e,t,i,r,s,n,a){var o;this.convertType(t);try{o=this.getSymbolizersObj(e,t)}catch(e){console.error(e.stack)}return o},convertType:function(e){try{return this.CONV_TYPE[e]}catch(t){console.error("could not convert the type: "+e)}},getSymbolizersObj:function(e,t,i){var r,s,n,a={},o=Object.keys(e),l=o.length;for(s=0;s<l;s++){var h=e[o[s]],d=Object.keys(h),u=d.length;for(r=0;r<u;r++){var c=d[r];if(this.VALID_ATTR_TAGS.indexOf(c)>-1)if(this.DIFF_ATTR_TAG.indexOf(c)>-1||"Fill"===c&&void 0!==h.Fill[0].GraphicFill){var p,f=this.getObjFromDiffAttr(c,t,h,i),m=Object.keys(f),g=m.length;for(n=0;n<g;n++)a[p=m[n]]=f[p]}else{var v=this.getCssParameters(h,c,t);a=this.addProfileRenderingFromCssParams(v,a)}}}return a},addProfileRenderingFromCssParams:function(t,i){var r;for(r=0;r<t.length;r++){var s=t[r][0];if(this.isMultiLevelAttribute(s))this.addMultiLevelAttribute(t[r],i);else{var n=t[r][1];e.is(i[s])?console.log("overwrite symbolizer param "+s+" forbidden"):i[s]=n}}return i},isMultiLevelAttribute:function(e){return e.indexOf("-")>-1},addMultiLevelAttribute:function(t,i){var r,s=t[0],n=t[1],a=s.split("-"),o=i,l=a.length,h=l-1;for(r=0;r<l;r++){var d=a[r];r===h?o[d]=n:(e.is(o[d])||(o[d]={},"stroke"===d&&(o[d].enable=!0)),o=o[d])}return i},getCssParameters:function(t,i,r,s){var n,a=[];if(void 0===s?e.is(t[i])&&(n=t[i][0].CssParameter,e.is(n)||(n=t[i][0].SvgParameter)):e.is(t[s])&&e.is(t[s][0][i])&&(n=t[s][0][i][0].CssParameter,e.is(n)||(n=t[s][0][i][0].SvgParameter)),e.is(n)){var o,l=Object.keys(n),h=l.length;for(o=0;o<h;o++){var d=n[l[o]],u=this.convert_css_parameter(d,i,r,s);e.is(u)&&a.push(u)}}return a},convert_css_parameter:function(t,i,r,s){if(e.is(t[this.attributenodename])){var n,a=t[this.attributenodename].name,o=/^\d+$/,l=/^[0-9]+([\,\.][0-9]+)?$/g,h=t[this.textnodename];try{var d=h.split("#")[1];n=!(this.DIFF_ATTR.indexOf(a)>-1)||o.test(h)||l.test(h)||/^[a-zA-Z]+$/.test(d)||/^\d+$/.test(d)||/^([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(d)?h:t.Function[0].Literal[1]}catch(e){n=this.DIFF_ATTR.indexOf(a)>-1&&!o.test(h)&&!l.test(h)?t.Function[0].Literal[1]:h}return[this.convertCssName(a,i,r,s),this.convertCssValue(n,a)]}return null},convertCssName:function(e,t,i,r){var s;void 0===(s=void 0===r?this.CONVERT_ATTR_NAME[i+"-"+t+"-"+e]:this.CONVERT_ATTR_NAME[i+"-"+r+"-"+t+"-"+e])&&(s=this.CONVERT_ATTR_NAME[e]);return void 0===s&&["font-weight","font-style"].indexOf(s)>-1&&console.log("could not convert the attribute name: "+e),void 0===s&&console.log("could not convert the attribute name: "+i+"-"+r+"-"+t+"-"+e),s},getObjFromDiffAttr:function(e,t,i,r){var s={};return"Label"===e?s=this.getLabelObj(e,t,i,s):"Fill"===e?s=this.readFillTag(e,t,i,s):"Graphic"===e&&(s=this.getGraphicObj(r,i,t,s)),s},readFillTag:function(t,i,r,s){if(e.is(r)&&e.is(r.Fill)){var n=r.Fill[0].GraphicFill;e.is(n)&&this.getMapUrl(n[0],s)}return s},getLabelObj:function(t,i,r,s){var n=this.convertCssName(t,t,i);return e.is(r.Label[0]["ogc:PropertyName"])?s[n]="{"+r.Label[0]["ogc:PropertyName"][0]+"}":s[n]="{"+r.Label[0].PropertyName[0]["#text"]+"}",s},convertCssValue:function(e,t){return e=e.trim(),"stroke"===t||"stroke-linejoin"===t||"stroke-linecap"===t?"#"+e.split("#")[e.split("#").length-1]:"stroke-width"===t||"stroke-opacity"===t||"stroke--dashoffset"===t?parseFloat(e):"stroke-dasharray"===t?e.split(" ").map(Number):"fill"===t?"#"+e.split("#")[e.split("#").length-1]:"opacity"===t||"fill-opacity"===t?parseFloat(e):"font-size"===t?parseFloat(e):e},getCurrentFolder:function(){if(e.is(this.currentUrl)){var t=this.currentUrl.split("?")[0],i=e.removeUrlEnd(t,"/");return e.endsWith(t,".sld")||(i+="/resources"),i}return null},getCurrentOptions:function(){return e.is(this.currentUrl)?this.currentUrl.split("?")[1]:null},isURLRelative:function(e){return!(e.split("://").length>1)&&"/"!==e[0]},getMapUrl:function(t,i){if(e.is(t)&&e.is(t.Graphic)){var r=t.Graphic[0].ExternalGraphic;if(e.is(r)){var s=r[0].OnlineResource[0][this.attributenodename]["xlink:href"];if(this.isURLRelative(s)){var n=this.getCurrentFolder();e.is(n)&&(s=n+"/"+s);var a=this.getCurrentOptions();e.is(a)&&(s=s+"?"+a)}i.mapUrl=s}}},initOffsetFunction:function(e){e.offsetFunction={ratio:{x:.5,y:.5,z:.5},pixel:{x:0,y:0,z:0},bbox:{x:0,y:0,z:0}}},readAnchorPoint:function(t,i){var r=t.AnchorPoint;if(e.is(r)){var s=r[0].AnchorPointX;e.is(i.offsetFunction)||this.initOffsetFunction(i),e.is(s)&&(i.offsetFunction.ratio.x=-s[0][this.textnodename]);var n=r[0].AnchorPointY;e.is(n)&&(i.offsetFunction.ratio.y=1-n[0][this.textnodename])}},readDisplacement:function(t,i){var r=t.Displacement;if(e.is(r)){e.is(i.offsetFunction)||this.initOffsetFunction(i);var s=r[0].DisplacementX;e.is(s)&&(i.offsetFunction.pixel.x=s[0][this.textnodename]);var n=r[0].DisplacementY;e.is(n)&&(i.offsetFunction.pixel.y=n[0][this.textnodename])}},getGraphicObj:function(t,i,r,s){try{var n=i.Graphic[0].Mark;if(e.is(n)){var a=this.getCssParameters(n[0],"Fill",r),o=this.getCssParameters(n[0],"Stroke",r);s=this.addProfileRenderingFromCssParams(a,s),s=this.addProfileRenderingFromCssParams(o,s)}else this.getMapUrl(i,s);this.readAnchorPoint(i.Graphic[0],s),this.readDisplacement(i.Graphic[0],s)}catch(e){console.log("Could not set fill color for graphic tag in file: "+t)}try{var l=i.Graphic[0].Size[0][this.textnodename];s["icon-size"]=parseInt(l,10)}catch(e){console.log("Size does not exist in this graphic-tag")}if(!e.is(s["icon-image"])){var h=this.getIconImage(t);s["icon-image"]=void 0!==h?h:"circle-12"}return s},getIconImage:function(e){},readTextSymbolizer:function(t){var i,r,s,n,a={};if(a.label={},e.is(t[0].Label)&&(a.label.enable=!0,a.label.style={},a.label.position={}),e.is(t[0].Font)&&e.is(t[0].Font[0].CssParameter))for(n=t[0].Font[0].CssParameter,i=0;i<n.length;i++)r=n[i][this.attributenodename].name,s=n[i][this.textnodename],a.label.style[r]=s,"font-size"===r&&(a.label.style[r]=a.label.style[r]+"px");if(e.is(t[0].Fill)&&e.is(t[0].Fill[0].CssParameter))for(n=t[0].Fill[0].CssParameter,i=0;i<n.length;i++)r=n[i][this.attributenodename].name,s=n[i][this.textnodename],a.label.style.color=s;if(e.is(t[0].LabelPlacement)&&e.is(t[0].LabelPlacement[0].PointPlacement)&&e.is(t[0].LabelPlacement[0].PointPlacement[0].Displacement)){var o=t[0].LabelPlacement[0].PointPlacement[0].Displacement;a.label.position.offset={},e.is(o[0].DisplacementX)&&(a.label.position.offset.x=parseInt(o[0].DisplacementX[0][this.textnodename])),e.is(o[0].DisplacementY)&&(a.label.position.offset.y=parseInt(o[0].DisplacementY[0][this.textnodename]))}return e.is(t[0].LabelPlacement)&&e.is(t[0].LabelPlacement[0].PointPlacement)&&e.is(t[0].LabelPlacement[0].PointPlacement[0].Rotation)&&(a.label.position.rotation={x:t[0].LabelPlacement[0].PointPlacement[0].Rotation[0][this.textnodename]}),a},readTextDataViz:function(t){var i;return e.is(t[0].Label)&&e.is(t[0].Label[0].PropertyName)&&e.is(t[0].Label[0].PropertyName[0][this.textnodename])&&(i={DatavizMaterial:{label:{name:{PropertyName:t[0].Label[0].PropertyName[0][this.textnodename]}}}}),e.is(t[0].LabelPlacement)&&e.is(t[0].LabelPlacement[0].PointPlacement)&&e.is(t[0].LabelPlacement[0].PointPlacement[0].Rotation)&&e.is(t[0].LabelPlacement[0].PointPlacement[0].Rotation[0].PropertyName)&&e.is(t[0].LabelPlacement[0].PointPlacement[0].Rotation[0].PropertyName[0][this.textnodename])&&e.is(i)&&e.is(i.DatavizMaterial)&&(i.DatavizMaterial.label.position={rotation:{PropertyName:t[0].LabelPlacement[0].PointPlacement[0].Rotation[0].PropertyName[0][this.textnodename]}}),i}})}),define("DS/XCityTools/AtlasNode",["UWA/Class","DS/xCityBasicUtils/Utils"],function(e,t){"use strict";return e.extend({init:function(e,t,i,r){this.x=0,this.y=0,this.width=0,this.height=0,this.used=!1,this.Index=0,this.block=null,this.right=null,this.down=null,this.x=e,this.y=t,this.width=i,this.height=r}})}),define("DS/XCityEffects/AltitudeShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{FinalBlending:{defines:{POSTPRO:1},uniforms:{tDiffuse:{type:"t",value:null},zBuffer:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},realViewMatrixInverse:{type:"m4",value:new e.Matrix4},zRef:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * ( viewMatrix * (modelMatrix * vec4( position, 1.0 )));","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D zBuffer;","uniform mat4 realProjectionMatrixInverse;","uniform mat4 realViewMatrixInverse;","uniform float zRef;","varying vec2 vUv;","void main() {","  vec4 zColor = texture2D( zBuffer, vUv );","  vec4 color = texture2D(  tDiffuse, vUv );","  float z = zColor.a;","  vec4 pointSS = vec4(vUv * 2.0 - 1.0, z * 2.0 - 1.0, 1.0);","  vec4 pointVS = realProjectionMatrixInverse * pointSS;","  pointVS /= pointVS.w;","  vec4 pointWS = realViewMatrixInverse * pointVS;","  vec3 fragWorldPos = pointWS.xyz / pointWS.w;"," float epsilon = 0.25;"," vec4 center = vec4(255.0/255.0, 0.0/255.0, 0.0/255.0, 1.0);"," vec4 jaune = vec4(255.0/255.0, 245.0/255.0, 62.0/255.0, 1.0);","if (fragWorldPos.z >= (zRef - epsilon) && fragWorldPos.z <= (zRef + epsilon))","{","float colorRatio = (abs(zRef - fragWorldPos.z) / abs(1.0*epsilon));","gl_FragColor = center;","}","else {","  gl_FragColor = vec4(color);","}","}"].join("\n")}}}),define("DS/XCityLayer/Vector",["DS/Visualization/ThreeJS_DS","UWA/Core","UWA/Class"],function(e,t){"use strict";var i={Type:{POINT:0,MULTIPOINT:1,LINESTRING:2,MULTILINESTRING:3,POLYGON:4,MULTIPOLYGON:5},getVerticesAsArrayOfLines:function(e,t){return e.getVertices(t)}};return i.Geometry=UWA.Class.extend({init:function(){},getNumGeometries:function(){return 1},getVertices:function(){return[]}}),i.Point2D=UWA.Class.extend({init:function(e,t){this.type=i.Type.POINT,this.x=e,this.y=t},getVertices:function(){return[this.x,this.y]},intersect:function(e){return Math.abs(this.x-e.getCenter().x)<.5*e.getSize().x&&Math.abs(this.y-e.getCenter().y)<.5*e.getSize().y},isInAABBOX:function(e){return Math.abs(this.x-e.getCenter().x)<.5*e.getSize().x&&Math.abs(this.y-e.getCenter().y)<.5*e.getSize().y},getCenter:function(){return new e.Vector2(this.x,this.y)}}),i.Point3D=i.Point2D.extend({init:function(e,t,i){this._parent(e,t),this.z=i},getVertices:function(){return[this.x,this.y,this.z]},getCenter:function(){return new e.Vector3(this.x,this.y,this.z)}}),i.MultiPoint=UWA.Class.extend({init:function(){this.geometryList=[],this.type=i.Type.MULTIPOINT},addGeometry:function(e){this.geometryList.push(e)},getNumGeometries:function(){return this.geometryList.length},getVertices:function(e){if(void 0===e){for(var t=[],i=0;i<this.geometryList.length;i++)t.push(this.geometryList[i].getVertices());return t}return this.geometryList[e].getVertices()},intersect:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(this.getSize().x+e.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(this.getSize().y+e.getSize().y)},isInAABBOX:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(e.getSize().x-this.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(e.getSize().y-this.getSize().y)},setAABBox:function(t,i){this.aabbox={center:new e.Vector2(.5*(i.x+t.x),.5*(i.y+t.y)),size:new e.Vector2(i.x-t.x,i.y-t.y)}},getCenter:function(){return this.aabbox.center},getSize:function(){return this.aabbox.size}}),i.LineString=UWA.Class.extend({init:function(){this.vertexList=[],this.type=i.Type.LINESTRING},addVertex:function(e){this.vertexList.push(e)},getNumGeometries:function(){return 1},getVertices:function(){return this.vertexList},intersect:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(this.getSize().x+e.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(this.getSize().y+e.getSize().y)},setAABBox:function(t,i){this.aabbox={center:new e.Vector2(.5*(i.x+t.x),.5*(i.y+t.y)),size:new e.Vector2(i.x-t.x,i.y-t.y)}},isInAABBOX:function(e){return!0},getCenter:function(){return this.aabbox.center},getSize:function(){return this.aabbox.size}}),i.MultiLineString=UWA.Class.extend({init:function(){this.geometryList=[],this.type=i.Type.MULTILINESTRING},addGeometry:function(e){this.geometryList.push(e)},getNumGeometries:function(){return this.geometryList.length},getVertices:function(e){if(void 0===e){for(var t=[],i=0;i<this.geometryList.length;i++)t.push(this.geometryList[i].getVertices());return t}return this.geometryList[e].getVertices()},intersect:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(this.getSize().x+e.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(this.getSize().y+e.getSize().y)},isInAABBOX:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(e.getSize().x-this.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(e.getSize().y-this.getSize().y)},setAABBox:function(t,i){this.aabbox={center:new e.Vector2(.5*(i.x+t.x),.5*(i.y+t.y)),size:new e.Vector2(i.x-t.x,i.y-t.y)}},getCenter:function(){return this.aabbox.center},getSize:function(){return this.aabbox.size}}),i.LinearRing=i.LineString.extend({init:function(){this._parent()}}),i.Polygon=UWA.Class.extend({init:function(){this.geometryList=[],this.aabbox=[],this.type=i.Type.POLYGON},addGeometry:function(e){this.geometryList.push(e)},getNumGeometries:function(){return this.geometryList.length},getVertices:function(e){for(var t=[],i=0;i<this.geometryList.length;i++)t.push(this.geometryList[i].getVertices());return t},intersect:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(this.getSize().x+e.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(this.getSize().y+e.getSize().y)},isInAABBOX:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(e.getSize().x-this.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(e.getSize().y-this.getSize().y)},setAABBox:function(t,i){this.aabbox={center:new e.Vector2(.5*(i.x+t.x),.5*(i.y+t.y)),size:new e.Vector2(i.x-t.x,i.y-t.y)}},getCenter:function(){return this.aabbox.center},getSize:function(){return this.aabbox.size}}),i.MultiPolygon=UWA.Class.extend({init:function(){this.geometryList=[],this.aabbox=[],this.type=i.Type.MULTIPOLYGON},addGeometry:function(e){this.geometryList.push(e)},getNumGeometries:function(){return this.geometryList.length},getVertices:function(e){if(void 0===e){for(var t=[],i=0;i<this.geometryList.length;i++)t.push(this.geometryList[i].getVertices());return t}return this.geometryList[e].getVertices()},intersect:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(this.getSize().x+e.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(this.getSize().y+e.getSize().y)},isInAABBOX:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(e.getSize().x-this.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(e.getSize().y-this.getSize().y)},setAABBox:function(t,i){this.aabbox={center:new e.Vector2(.5*(i.x+t.x),.5*(i.y+t.y)),size:new e.Vector2(i.x-t.x,i.y-t.y)}},getCenter:function(){return this.aabbox.center},getSize:function(){return this.aabbox.size}}),i.Feature=UWA.Class.extend({init:function(){this.clear()},clear:function(){return this.geometry=void 0,this.attributes={},this},clone:function(){var e=new i.Feature;return e.geometry=this.geometry,e.attributes=t.clone(this.attributes),e},setGeometry:function(e){this.geometry=e},getGeometry:function(){return this.geometry},getCenter:function(){return this.geometry.getCenter()},distanceTo:function(e){return this.getCenter().clone().sub(e).length()},getAttributeKeys:function(){return Object.keys(this.attributes)},set:function(e,t){return this.attributes[e]=t,this},get:function(e){return void 0!==e?this.attributes[e]:void 0},setAttribute:function(e,t){return this.set(e,t)},getAttribute:function(e){return this.get(e)}}),i}),define("DS/XCityModel/WorkerSemaphore",["UWA/Class"],function(e){"use strict";return e.extend({init:function(e,t){this._workerPath=e,this._workerNumber=t,this._freeWorkers=[],this._workers=[],this._waitingList=[];for(let i=0;i<t;i++){let t=function(){this._unlock(i)}.bind(this),r={worker:new Worker(e),release:t};this._workers[i]=r,this._freeWorkers[i]=r}},requestWorker:function(){let e={},t=new Promise((t,i)=>{e.resolve=t,e.reject=i});return this._waitingList.push(e),this._freeWorkers.length>0&&this._waitingList.pop().resolve(this._freeWorkers.pop()),t},_unlock:function(e){this._waitingList.length>0?this._waitingList.pop().resolve(this._workers[e]):this._freeWorkers.push(this._workers[e])}})}),define("DS/XCityGeometry/DescriptionCard",["UWA/Core","UWA/Class","UWA/Class/Model","DS/xCityBasicUtils/Utils","css!DS/XCityGeometry/assets/style/descriptionCard.css"],function(e,t,i,r){"use strict";return i.extend({init:function(t){this.div=e.createElement("div"),this.div.addClassName("descriptionCard"),t&&(t.className&&this.div.addClassName(t.className),xCity._urbanImpl.showPrimBbox&&(this.debugCanvas=r.createDebugCanvas()))},remove:function(){r.is(this.debugCanvas)&&this.debugCanvas.getContext("2d").clearRect(0,0,this.debugCanvas.width,this.debugCanvas.height);this.div.remove()},fadePopup:function(e){let t=this.div;e?(t.hasClassName("descriptionCardfadeOut")&&t.removeClassName("descriptionCardfadeOut"),t.hasClassName("descriptionCardfadeIn")||t.addClassName("descriptionCardfadeIn")):(t.hasClassName("descriptionCardfadeIn")&&t.removeClassName("descriptionCardfadeIn"),t.hasClassName("descriptionCardfadeOut")||t.addClassName("descriptionCardfadeOut"))},slideElementAccordingToBbox:function(e,t,i,s=10,n=10,a=!0){let o,l=this.div,h=l.getSize().width,d=l.getSize().height;i||(i={x:0,y:0,width:0,height:0});let u={};return"absolute"!==l.style.position&&(e+=(o=l.parentElement.getBoundingClientRect()).left,t+=o.top),this.debugCanvas&&(this.debugCanvas.getContext("2d").clearRect(0,0,this.debugCanvas.width,this.debugCanvas.height),r.draw2Drect(this.debugCanvas,e,t,h,d),r.draw2Drect(this.debugCanvas,i.left,i.top,i.width,i.height,"red")),e=r.slideWithinRange(e,h+s,i.x,window.innerWidth,u),e=-r.slideWithinRange(-e,s,-i.x-i.width,0,u),t=r.slideWithinRange(t,d+n,i.y,window.innerHeight,u),(t=-r.slideWithinRange(-t,n,-i.y-i.height,0,u))+d>i.y&&a&&(t=i.y+i.height,t=r.slideWithinRange(t,d+n,i.y,window.innerHeight,u),t=-r.slideWithinRange(-t,n,-i.y-i.height,0,u)),this.debugCanvas&&r.draw2Drect(this.debugCanvas,e,t,h,d,"blue"),u.toHide?this.fadePopup(!1):l.hasClassName("descriptionCardfadeOut")&&this.fadePopup(!0),"absolute"!==l.style.position&&(e-=o.left,t-=o.top),l.style.left=e+"px",l.style.top=t+"px",{left:e,top:t}}})}),define("DS/XCityEnvironment/SunCalculator",["UWA/Class"],function(){"use strict";return UWA.Class.extend({init:function(e){this.urban=e,this.dayMs=864e5,this.J1970=2440588,this.J2000=2451545,this.rad=Math.PI/180,this.e=23.4397*this.rad,this.J0=9e-4,this.times=[[-.83,"sunrise","sunset"],[-.3,"sunriseEnd","sunsetStart"],[-6,"dawn","dusk"],[-12,"nauticalDawn","nauticalDusk"],[-18,"nightEnd","night"],[6,"goldenHourEnd","goldenHour"]]},toJulian:function(e){return e.valueOf()/this.dayMs-.5+this.J1970},fromJulian:function(e){return new Date((e+.5-this.J1970)*this.dayMs)},toDays:function(e){return this.toJulian(e)-this.J2000},getRightAscension:function(e,t){return Math.atan2(Math.sin(e)*Math.cos(this.e)-Math.tan(t)*Math.sin(this.e),Math.cos(e))},getDeclination:function(e,t){return Math.asin(Math.sin(t)*Math.cos(this.e)+Math.cos(t)*Math.sin(this.e)*Math.sin(e))},getAzimuth:function(e,t,i){return Math.PI+Math.atan2(Math.sin(e),Math.cos(e)*Math.sin(t)-Math.tan(i)*Math.cos(t))},getAltitude:function(e,t,i){return Math.asin(Math.sin(t)*Math.sin(i)+Math.cos(t)*Math.cos(i)*Math.cos(e))},getSiderealTime:function(e,t){return this.rad*(280.16+360.9856235*e)-t},getSolarMeanAnomaly:function(e){return this.rad*(357.5291+.98560028*e)},getEquationOfCenter:function(e){return this.rad*(1.9148*Math.sin(e)+.02*Math.sin(2*e)+3e-4*Math.sin(3*e))},getEclipticLongitude:function(e,t){return e+t+102.9372*this.rad+Math.PI},getSunCoords:function(e){var t=this.getSolarMeanAnomaly(e),i=this.getEquationOfCenter(t),r=this.getEclipticLongitude(t,i);return{dec:this.getDeclination(r,0),ra:this.getRightAscension(r,0)}},getPosition:function(e,t,i){var r=this.rad*-i,s=this.rad*t,n=this.toDays(e),a=this.getSunCoords(n),o=this.getSiderealTime(n,r)-a.ra;return{azimuth:this.getAzimuth(o,s,a.dec),altitude:this.getAltitude(o,s,a.dec)}},computeSunWorldPos:function(e,t){},getJulianCycle:function(e,t){return Math.round(e-this.J0-t/(2*Math.PI))},getApproxTransit:function(e,t,i){return this.J0+(e+t)/(2*Math.PI)+i},getSolarTransitJ:function(e,t,i){return this.J2000+e+.0053*Math.sin(t)-.0069*Math.sin(2*i)},getHourAngle:function(e,t,i){return Math.acos((Math.sin(e)-Math.sin(t)*Math.sin(i))/(Math.cos(t)*Math.cos(i)))},getTimes:function(e,t,i){var r,s,n,a,o,l=this.rad*-i,h=this.rad*t,d=this.toDays(e),u=this.getJulianCycle(d,l),c=this.getApproxTransit(0,l,u),p=this.getSolarMeanAnomaly(c),f=this.getEquationOfCenter(p),m=this.getEclipticLongitude(p,f),g=this.getDeclination(m,0),v=this.getSolarTransitJ(c,p,m),_={solarNoon:this.fromJulian(v),nadir:this.fromJulian(v-.5)};for(r=0,s=this.times.length;r<s;r+=1){n=this.times[r];var y=this.getHourAngle(n[0]*this.rad,h,g),b=this.getApproxTransit(y,l,u);o=v-((a=this.getSolarTransitJ(b,p,m))-v),_[n[1]]=this.fromJulian(o),_[n[2]]=this.fromJulian(a)}return _}})}),define("DS/XCityTools/OGCFilterPrimitive",["UWA/Class"],function(e){"use strict";return e.extend({init:function(e){this.filter=e},apply:function(e){return"PropertyIsBetween"===this.filter["ogc:Filter"].comparisonOps.name.localPart?this.isBetWeenOp(e):this.genericOp(e)},genericOp:function(e){for(var t,i,r=this.filter["ogc:Filter"].comparisonOps,s=0;s<r.value.expression.length;s++)"PropertyName"===r.value.expression[s].name.localPart?t=r.value.expression[s].value.content[0]:"Literal"===r.value.expression[s].name.localPart&&(i=r.value.expression[s].value.content[0]);var n=r.name.localPart;switch(n){case"PropertyIsEqualTo":return e[t]===i;case"PropertyIsNotEqualTo":return e[t]!==i;case"PropertyIsLessThan":return e[t]<i;case"PropertyIsLessThanOrEqualTo":return e[t]<=i;case"PropertyIsGreaterThan":return e[t]>i;case"PropertyIsGreaterThanOrEqualTo":return e[t]>=i;default:return console.error("FILTER comparison operator : "+n+" not yet implemented"),!1}},isBetWeenOp:function(e){var t=this.filter["ogc:Filter"].comparisonOps,i=t.value.expression.value.content[0],r=t.value.lowerBoundary.expression.value.content[0],s=t.value.upperBoundary.expression.value.content[0];return e[i]>=r&&e[i]<=s}})}),define("DS/XCityCoreUI/AnimationReplayPanel",["UWA/Core","UWA/Class","UWA/Element","UWA/Class/Events","UWA/Controls/Input","DS/Controls/Timeline","DS/Windows/Panel"],function(e,t,i,r,s,n,a){"use strict";return t.extend({init:function(t,r,s){var o=this;this.container=new e.Element("div");var l=new n({minValue:0,maxValue:r.duration,value:0,stepValue:.01,dynamicGraduations:!1,dynamicGaugeColor:!1,graduationsLabel:!0,eventsList:[{label:r.startLabel,value:0,onEvent:function(){}},{label:r.endLabel,value:r.duration,onEvent:function(){}}],activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container);l.addEvent("change",function(){if(Utils.is(u)){var e=l.getValue();e<=0&&(e=0),u._setFastTime(1e3*e)}}),r.timeline=l,this.timeline=l,[{label:"Play",callback:function(){l.play()}},{label:"Pause",callback:function(){l.pause()}},{label:"Stop",callback:function(){l.stop()}}].forEach(function(e){new i("a",{html:e.label,class:"wux-controls-button",events:{click:e.callback}}).inject(o.container)});var h=this.container,d=new a({title:"AnimationReplay",content:h,immersiveFrame:t.frmWindow.getImmersiveFrame(),visibleFlag:!0,closeButtonFlag:!1,allowedDockAreas:WUXDockAreaEnum.LeftDockArea|WUXDockAreaEnum.RightDockArea,currentDockArea:WUXDockAreaEnum.RightDockArea,collapsibleFlag:!1,resizableFlag:!0,verticallyStretchableFlag:!0,height:340,minWidth:400,width:400});d.getContent().addClassName("xCity-wux-window"),function(e,t){for(var i in t.windows){var r=t.windows[i];if(r!==e&&0!==e.currentDockArea&&r.currentDockArea===e.currentDockArea){e.attachToWindow(r,WUXSnapAreaEnum.InsideArea),e.windowGroup.verticallyStretchableFlag=!0,e.windowGroup.allowedDockAreas=WUXDockAreaEnum.LeftDockArea|WUXDockAreaEnum.RightDockArea;break}}}(d,t.frmWindow.getImmersiveFrame());var u=s.setOptions(r)}})}),define("DS/XCityEnvironment/VisualEffect",["UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Visualization/Node3D","UWA/Class"],function(e,t,i,r,s){"use strict";return s.extend(e,{init:function(e,t,i,r,s,n){var a=s;for(var o in void 0!==r[t]&&(a=void 0!==r[t].enable?r[t].enable:r[t]),this.enabled=s,this._enabledSilent=a,this._name=t,this._enableCB=i,this._options={},r[t])this._options[o]=r[t][o];void 0!==n&&(this.update=n),this.enable(a,!0);var l=e.url.getArgument(this._name);l&&this.enable("1"===l.value),e.url.updateSlots.push(this.updateUrl.bind(this))},getOption:function(e){return void 0!==this._options[e]?this._options[e]:0},updateUrl:function(e){e.setArgument(this._name,!0===this.enabled?"1":"0")},enable:function(e,t){if(void 0===e&&(e=!0),this.enabled===e&&!0!==t||(this._enableCB(e),this.enabled=e,this._enabledSilent=e,this.dispatchEvent("onChange",this,e)),this.update)for(var i=Object.keys(this._options),r=i.length;r--;)this.update(i[r],this._options[i[r]])},disable:function(){this.enable(!1)},enableSilent:function(e){this._enabledSilent!==e&&!0===this.enabled&&(this._enableCB(e),this._enabledSilent=e)},disableSilent:function(){this.enableSilent(!1)}})}),define("DS/XCityTools/TextureTools",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return e.singleton({init:function(){this._htmlCanvas=document.createElement("canvas")},createTexture:function(e){if(void 0!==e&&void 0!==e.data&&void 0!==e.xSize&&void 0!==e.ySize){var i=e.data;i instanceof Float32Array||(i=new Float32Array(i));var r=e.xSize,s=e.ySize,n=void 0!==e.name?e.name:"",a=void 0!==e.format?e.format:t.RGBAFormat,o=void 0!==e.filter?e.filter:t.LinearFilter,l=void 0!==e.flipY&&e.flipY,h=void 0!==e.generateMipmaps&&e.generateMipmaps,d=new t.DataTexture(i,r,s,a,t.FloatType);return d.name=n,d.minFilter=o,d.magFilter=o,d.flipY=l,d.generateMipmaps=h,d.needsUpdate=!0,d}},pushPixel:function(e,i){var r;if(i instanceof Array)for(r=0;r<i.length;r++)e.push(i[r]);else i instanceof t.Color?(e.push(i.r),e.push(i.g),e.push(i.b)):e.push(i)},int2color:function(e){var t=4,i=[],r=Math.floor(e);for(i[0]=r%256,i[1]=(r-i[0])/255%256,i[2]=(r-i[0]-255*i[1])/65025%256,i[3]=(r-i[0]-255*i[1]-65025*i[2])/16581375%256;t--;)i[t]/=255;return i},float2color:function(e){var t=[],i=e-Math.floor(e);return t[0]=i,t[1]=255*i,t[2]=65025*i,t[3]=16581375*i,t[0]=t[0]-Math.floor(t[0]),t[1]=t[1]-Math.floor(t[1]),t[2]=t[2]-Math.floor(t[2]),t[3]=t[3]-Math.floor(t[3]),t[0]-=t[1]/255,t[1]-=t[2]/255,t[2]-=t[3]/255,t},generateTextureFromName:function(e,i,r,s){var n,a;n=document.getElementsByTagName("body")[0],(a=document.createElement("div")).setAttribute("style","position:absolute;top:0px; left:0px;"),a.innerHTML="<div class='"+i.styleClass+"'><div class='"+i.pClass+"' style='zoom:"+i.samplingFactor+";'>"+e+"</div></div>",n.appendChild(a);var o=["background-color","background-origin","background-image","background-position-x","background-position-y","background-repeat","background-size","background-clip","border-top-color","border-top-style","border-top-width","border-top-left-radius","border-top-right-radius","border-bottom-color","border-bottom-style","border-bottom-width","border-bottom-left-radius","border-bottom-right-radius","border-right-color","border-right-style","border-right-width","border-left-color","border-left-style","border-left-width","border-image-outset","border-image-repeat","border-image-slice","border-image-source","border-image-width","box-sizing","padding-top","padding-bottom","padding-right","padding-left","vertical-align","text-align","word-spacing","letter-spacing","line-height","margin-bottom","margin-top","margin-left","margin-right","color","font-family","font-stretch","font-style","font-variant","font-weight","font-size","width","height","text-shadow"],l=window.getComputedStyle(a.children[0]),h=[],d=window.getComputedStyle(a.children[0].children[0]),u=[],c=d.getPropertyValue("top"),p=d.getPropertyValue("left");r.topText=parseFloat(c),r.leftText=parseFloat(p);for(var f=0;f<o.length;f++)if(9===f)h.push("0px"),u.push("0px");else{var m=o[f];h.push(l.getPropertyValue(m)),u.push(d.getPropertyValue(m))}var g=a.offsetWidth+0,v=a.offsetHeight;r.width=g,r.height=v,r.samplingFactor=i.samplingFactor,c.indexOf("%")>-1&&(r.topText=r.topText*r.height/(100*i.samplingFactor)),p.indexOf("%")>-1&&(r.leftText=r.leftText*r.width/(100*i.samplingFactor)),isNaN(r.topText)&&(r.topText=0),isNaN(r.leftText)&&(r.leftText=0),n.removeChild(a);var _="style='display:block; ",y="style='display:block; zoom:"+i.samplingFactor+";white-space: nowrap; ";for(f=0;f<o.length;f++)_=_.concat(o[f]+": "+h[f]+"; "),y=y.concat(o[f]+": "+u[f]+"; ");var b="<div xmlns='http://www.w3.org/1999/xhtml' style='position:absolute; top:0px; left:0px;'><div xmlns='http://www.w3.org/1999/xhtml' "+(_=_.concat("'"))+" ><div xmlns='http://www.w3.org/1999/xhtml' "+(y=y.concat("'"))+">"+e+"</div></div></div>",x=r.width,C=r.height;this._htmlCanvas.width=1*x,this._htmlCanvas.height=1*C;var S=this._htmlCanvas.getContext("2d"),D="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='"+this._htmlCanvas.width+"' height='"+this._htmlCanvas.height+"'><foreignObject width='100%' height='100%'>"+b+"</foreignObject></svg>",P=new Image;P.onload=function(){this._htmlCanvas.width=1*x,this._htmlCanvas.height=1*C,S.clearRect(0,0,this._htmlCanvas.width,this._htmlCanvas.height),S.drawImage(P,0,0);for(var e=S.getImageData(0,0,x,C),i=new ArrayBuffer(e.data.length),r=new Uint8Array(i),n=0;n<x*C;++n)r[4*n]=e.data[4*n],r[4*n+1]=e.data[4*n+1],r[4*n+2]=e.data[4*n+2],r[4*n+3]=e.data[4*n+3];var a=new t.DataTexture(r,x,C,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearMipMapLinearFilter);a.needsUpdate=!0,S.clearRect(0,0,this._htmlCanvas.width,this._htmlCanvas.height),this._htmlCanvas.height=0,s(a)}.bind(this),P.src=D},computeLabelSize:function(e,t,i=1){if(!Utils.is(e)||""==e)return{width:0,height:0};let r=this._htmlCanvas.getContext("2d"),s=t.style;r.font=s["font-weight"]+" "+s["font-size"]+" "+s["font-family"],r.letterSpacing=s["letter-spacing"];let n=r.measureText(e),a=this.getPaddingSize(s),o={};return o.width=n.width+2*a.horizontal_padding+1+n.actualBoundingBoxLeft,o.height=Math.ceil(n.fontBoundingBoxDescent+n.fontBoundingBoxAscent+n.actualBoundingBoxAscent+n.actualBoundingBoxDescent),o},generateLabelTexture:function(e,i,r,s=1){if(!Utils.is(e)||""==e)return{width:0,height:0};var n={},a="style='display:inline-block; ";for(var o in e=this.removeXMLSpecialChar(e.toString()),i.style){o.includes("color")&&(i.style[o]=i.style[o].hexToRgb()?i.style[o].hexToRgb():i.style[o]);var l=i.style[o];if("font-size"===o){var h=l.match(/\d/g).join(""),d=l.split(/[0-9]+/)[1];l=""+h*s+d}else if("padding"===o){let e=this.getPaddingSize(i.style),t=l.split(/[0-9]+/).pop();l=""+e.vertical_padding+t+" "+e.horizontal_padding+t}a=a.concat(o+": "+l+"; ")}var u="<div xmlns='http://www.w3.org/1999/xhtml' style='position:absolute;white-space: nowrap;'><div xmlns='http://www.w3.org/1999/xhtml' "+(a=(a=a.concat("margin : 1px;")).concat("'"))+">"+e+"</div></div>",c=this.createElementFromHTML(u);document.body.appendChild(c),n.width=c.offsetWidth,n.height=c.offsetHeight,document.body.removeChild(c);var p=n.width,f=n.height;if(p>0&&f>0){this._htmlCanvas.width=p,this._htmlCanvas.height=f;var m=this._htmlCanvas.getContext("2d"),g="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><foreignObject width='100%' height='100%'>"+u+"</foreignObject></svg>",v=new Image;v.onload=function(){this._htmlCanvas.width=p,this._htmlCanvas.height=f,m.clearRect(0,0,this._htmlCanvas.width,this._htmlCanvas.height),m.drawImage(v,0,0);for(var e=m.getImageData(0,0,p,f),i=new ArrayBuffer(e.data.length),s=new Uint8Array(i),n=0;n<p*f;++n)s[4*n]=e.data[4*n],s[4*n+1]=e.data[4*n+1],s[4*n+2]=e.data[4*n+2],s[4*n+3]=e.data[4*n+3];var a=new t.DataTexture(s,p,f,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping,t.ClampWrapping,t.ClampWrapping,t.NearestFilter,t.NearestMipMapLinearFilter);a.needsUpdate=!0,r(a)}.bind(this),v.src=g}return n.width/=s,n.height/=s,n},generateGlypheTexture:function(e,i,r){if(!Utils.is(e)||""==e)return{width:0,height:0};var s={},n="style='display:block; ";for(var a in e=this.removeXMLSpecialChar(e.toString()),i.style)a.includes("color")&&(i.style[a]=i.style[a].hexToRgb()?i.style[a].hexToRgb():i.style[a]),n=n.concat(a+": "+i.style[a]+"; ");var o="<div xmlns='http://www.w3.org/1999/xhtml' style='position:absolute;white-space: pre;transform: translate(150%,150%) scale(4);'><div xmlns='http://www.w3.org/1999/xhtml' "+(n=n.concat("'"))+">"+e+"</div></div>",l=this.createElementFromHTML(o);document.body.appendChild(l),s.width=4*l.offsetWidth,s.height=4*l.offsetHeight,document.body.removeChild(l);var h=s.width,d=s.height;if(h>0&&d>0){this._htmlCanvas.width=h,this._htmlCanvas.height=d;var u=this._htmlCanvas.getContext("2d"),c="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><foreignObject width='100%' height='100%'>"+o+"</foreignObject></svg>",p=new Image;p.onload=function(){this._htmlCanvas.width=h,this._htmlCanvas.height=d,u.clearRect(0,0,this._htmlCanvas.width,this._htmlCanvas.height),u.drawImage(p,0,0);for(var e=u.getImageData(0,0,h,d),i=new ArrayBuffer(e.data.length),s=new Uint8Array(i),n=0;n<h*d;++n)s[4*n]=e.data[4*n],s[4*n+1]=e.data[4*n+1],s[4*n+2]=e.data[4*n+2],s[4*n+3]=e.data[4*n+3];var a=new t.DataTexture(s,h,d,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping,t.ClampWrapping,t.ClampWrapping,t.LinearFilter,t.LinearMipMapLinearFilter);a.anisotropy=1,a.needsUpdate=!0,r(a)}.bind(this),p.onerror=function(t,i,r){console.log("glypheloadingerror",t,e,h,d)},p.src=c}return s},removeXMLSpecialChar:function(e){return e.replace("<"," ").replace("&"," ")},createElementFromHTML:function(e){var t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild},getImageDataFromTexture:function(e){var i=e.image;if(e instanceof t.DataTexture)return i;var r=document.createElement("canvas");r.width=i.width,r.height=i.height;var s=r.getContext("2d");return s.drawImage(i,0,0),s.getImageData(0,0,i.width,i.height)},generateAtlasFromBlocks:function(e,i,r){this.testMode=!1;var s,n,a,o=new ArrayBuffer(i*r*4),l=new Uint8Array(o),h=e.length;for(a=0;a<h;a++){var d=e[a],u=d.getX(),c=d.getY(),p=d.getWidth(),f=d.getHeight(),m=this.getImageDataFromTexture(d.texture.texture),g=u+c*i;for(n=0;n<f;++n)for(s=0;s<p;++s){var v=s+n*p,_=g+s+n*i;!0===this.testMode?(l[4*_]=0===a?255:0,l[4*_+1]=0===a?0:255,l[4*_+2]=0,l[4*_+3]=255):(l[4*_]=m.data[4*v],l[4*_+1]=m.data[4*v+1],l[4*_+2]=m.data[4*v+2],l[4*_+3]=m.data[4*v+3])}}var y=new t.DataTexture(l,i,r,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping,t.ClampWrapping,t.ClampWrapping,t.NearestFilter,t.NearestMipMapLinearFilter);return y.anisotropy=1,y.needsUpdate=!0,y},getShadowSize:function(e){if(""==e)return[0,0];var t=e.replace(/ *\([^)]*\) */g,"").split(","),i=0,r=0,s=0;for(let e=0;e<t.length;e++){var n=t[e].split(" ").filter(e=>e);1===n.length&&n.push(n[0]),i=Math.max(i,n[0].match(/\d/g).join("")),r=Math.max(r,n[1].match(/\d/g).join("")),n.length>3&&(s=Math.max(s,parseInt(n[2].match(/\d/g).join(""))))}return[i+s,r+s]},getPaddingSize:function(e){let t=this.getShadowSize(e.padding),i=this.getShadowSize(e["text-shadow"]);return{vertical_padding:Math.max(t[0],i[0]),horizontal_padding:Math.max(t[1],i[1])}}})}),define("DS/XCityTools/Debug",["UWA/Class","DS/XCityTools/DebugLineChart"],function(e,t){"use strict";var i=function(){this.isActive=!1,this.states=[],this.callbacks={},this.values={},this.logs=[],this.logSize=10,this.logValues=[],this.logCallbacks=[],this.charts=void 0,this.nbLog={},this.maxLog=10,this._privateLog("Debug")};i.prototype={createCharts:function(){this.charts||(this.charts=new t(200,this),window.performance.memory&&this.addCharts("JSmem",function(){return window.performance.memory.usedJSHeapSize/1e6},"#ffffff",window.performance.memory.totalJSHeapSize/1e6))},initialize:function(e,t){if(e){var i=this;this.log=function(){void 0===i.nbLog[arguments]&&(i.nbLog[arguments]=0),i.nbLog[arguments]<i.maxLog&&(i.nbLog[arguments]++,console.log.apply(console,arguments))},this.warn=function(){void 0===i.nbLog[arguments]&&(i.nbLog[arguments]=0),i.nbLog[arguments]<i.maxLog&&(i.nbLog[arguments]++,console.warn.apply(console,arguments))}}t&&this.createCharts()},_privateLog:function(e){this.logs.push(e),this.logs.length>this.logSize&&this.logs.shift()},log:function(){},warn:function(){},error:function(){void 0===this.nbLog[arguments]&&(this.nbLog[arguments]=0),this.nbLog[arguments]<this.maxLog&&(this.nbLog[arguments]++,console.error.apply(console,arguments))},activeCharts:function(e){this.createCharts();var t=document.getElementById("Stats");!0===e?(this.charts.isActive=!0,t.style.display="block"):(this.charts.isActive=!0,t.style.display="none")},addCallback:function(e,t){this.callbacks[e]=t},addCharts:function(e,t,i,r){this.charts.addStates(e,t,r||100,60,i)},getOrCreateLineCharts:function(){return void 0===this.charts&&(this.charts=new UDC.DebugLineChart),this.charts},setValue:function(e,t){this.values[e]=t},logCallback:function(e){this.logCallbacks.push(e)},addStates:function(e,t){void 0!==t?this.states.push({name:e,callback:t}):this.states.push({name:e,callback:this.callbacks[e]})},update:function(e){if(void 0!==this.charts&&this.charts.update(e),this.isActive){var t=document.getElementById("Infos");if(null!==t){for(var i="",r=0;r<this.states.length;r++)if(i+="<br />-------- "+this.states[r].name+" --------","Downloader"===this.states[r].name){let t=this.states[r].callback(e);i+="<br />",i+='<table><tr>\n                            <th style="font-weight: bold; padding-right: 8px">Name</th>\n                            <th style="font-weight: bold; padding-right: 8px">OK</th>\n                            <th style="font-weight: bold; padding-right: 8px">KO</th>\n                            <th style="font-weight: bold; padding-right: 8px">Pending</th>\n                            <th style="font-weight: bold; padding-right: 8px">AvgTime</th>\n                            <th style="font-weight: bold; padding-right: 8px">AvgTTFB</th>\n                            <th style="font-weight: bold; padding-right: 8px">TTFB>500ms</th>\n                            <th style="font-weight: bold; padding-right: 8px">SlowRaster</th>\n                            <th style="font-weight: bold; padding-right: 8px">BlackListed</th>\n                            </tr>',Array.from(t,([e,t])=>{let r="Unknown";if(xCity.widgetData&&xCity.widgetData.datasetCollection){let t=xCity.widgetData.datasetCollection.get(e);r=(r=t&&t.get("name")?t.get("name"):e).substring(0,20)}i+="<tr>",i+='<td style="padding-right: 8px">'+r+"</td>",i+='<td style="padding-right: 8px">'+t.success+"</td>",i+='<td style="padding-right: 8px">'+t.failure+"</td>",i+='<td style="padding-right: 8px">'+Object.keys(t.times).length+"</td>",t.averageTime>500?i+='<td style="color:red; padding-right: 8px">'+t.averageTime.toFixed(0)+"</td>":t.averageTime>250?i+='<td style="color:orange; padding-right: 8px">'+t.averageTime.toFixed(0)+"</td>":i+='<td style="color:green; padding-right: 8px">'+t.averageTime.toFixed(0)+"</td>";let s=Number.isFinite(t.avgTTFB)?t.avgTTFB.toFixed(0):"";t.avgTTFB&&t.avgTTFB>500?i+='<td style="color:red; padding-right: 8px">'+s+"</td>":t.avgTTFB&&t.avgTTFB>200?i+='<td style="color:orange; padding-right: 8px">'+s+"</td>":i+='<td style="color:green; padding-right: 8px">'+s+"</td>",i+='<td padding-right: 8px">'+(Number.isFinite(t.percentTTFBOver500ms)?100*t.percentTTFBOver500ms.toFixed(2)+"%":"")+"</td>",i+='<td style="color:red; font-weight:bold">'+(t.isSlowRasterSlot?"True":"")+"</td>",i+='<td style="color:red; font-weight:bold">'+(t.isBlackListed?"True":"")+"</td>",i+="</tr>"}),i+="</table>"}else i+="<br />"+this.states[r].callback(e);var s=0;for(var n in this.values)this.values.hasOwnProperty(n)&&(0===s&&(i+="<br />--------  Customs Values --------"),i+="<br />"+n+": "+this.values[n],s++);if(this.logCallbacks.length){i+="<br />--------  Customs Callbacks --------";for(r=0;r<this.logCallbacks.length;r++)i+="<br />"+this.logCallbacks[r]+": "+this.callbacks[this.logCallbacks[r]](e)}i+="<br /><br />-------- Console --------";for(r=Math.max(0,this.logs.length-this.logSize);r<this.logs.length;r++)i+="<br />"+this.logs[r];null!==t&&(t.innerHTML=i)}}}};var r=null;return null===r&&(r=new i),r}),define("DS/XCityTools/EventDispatcher",["DS/CoreEvents/Events","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/Gestures/MouseDownGesture","DS/Gestures/MouseMoveGesture","DS/Gestures/MouseUpGesture","DS/Gestures/MouseOutGesture","DS/Gestures/MouseWheelGesture","DS/Gestures/ClickGesture","DS/Gestures/DoubleClickGesture","DS/Gestures/KeyDownGesture","DS/Gestures/KeyUpGesture","DS/Gestures/TouchGesture","DS/Gestures/ReleaseGesture","DS/Gestures/TapGesture","DS/Gestures/DoubleTapGesture","DS/Gestures/SwipeGesture","DS/Gestures/PinchGesture","DS/Gestures/PanGesture","DS/Gestures/RotateGesture","DS/Gestures/PinchPanRotateGesture","DS/Gestures/HoldGesture","DS/Gestures/LongHoldGesture","DS/Gestures/PinchTapGesture","DS/Gestures/DoublePinchTapGesture","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m,g,v,_,y,b,x,C,S,D,P,w){"use strict";var M=function(){this.domElements=[]},T="/3DEXPERIENCity/",I=T+"onDataModelChange:",R=T+"disable.",A="effect";M.prototype={eventsList:{config:T+"onConfig",onStopAnimation:T+"onStopAnimation",onUpdate:T+"onUpdate",onSelect:T+"onSelect",onDeselect:T+"onDeselect",onLoaded:T+"onLoaded",cameraPosition:I+"cameraPosition",date:I+"date",borderChange:I+"borderChange",focusManager:I+"focusManager",manipulatorProfile:I+"manipulatorProfile",performanceProfile:I+"performanceProfile",performanceProfileAdded:I+"performanceProfileAdded",performanceProfileRemoved:I+"performanceProfileRemoved",realisticWater:I+"realisticWater",renderingProfile:I+"renderingProfile",renderingProfileAdded:I+"renderingProfileAdded",renderingProfileRemoved:I+"renderingProfileRemoved",pointOfView:I+"pointOfView",effect:I+A,"effect.sun":I+A+".sun","effect.sun.ambientFactor":I+A+".sun.ambientFactor","effect.sun.diffuseFactor":I+A+".sun.diffuseFactor","effect.dof":I+A+".dof","effect.sslr":I+A+".sslr","effect.ao":I+A+".ao","effect.ao.enable":I+A+".ao.enable","effect.ao.strength":I+A+".ao.strength","effect.ao.angle":I+A+".ao.angle","effect.bloom":I+A+".bloom","effect.bloom.enable":I+A+".bloom.enable","effect.bloom.factor":I+A+".bloom.factor","effect.tone":I+A+".tone","effect.tone.enable":I+A+".tone.enable","effect.tone.gamma":I+A+".tone.gamma","effect.tone.type":I+A+".tone.type","effect.infinitePlane":I+A+".infinitePlane","effect.slab":I+A+".slab","effect.slab.color":I+A+".slab.color","effect.aa":I+A+".aa","effect.normalMap":I+A+".normalMap","effect.specularMap":I+A+".specularMap","effect.roofMode":I+A+".roofMode","effect.shadow":I+A+".shadow","effect.shadow.enable":I+A+".shadow.enable","effect.shadow.visible":I+A+".shadow.visible","effect.shadow.bias":I+A+".shadow.bias","effect.shadow.darkness":I+A+".shadow.darkness","effect.shadow.nbShadowMaps":I+A+".shadow.nbShadowMaps","effect.shadow.resolution":I+A+".shadow.resolution","effect.shadow.boxSize":I+A+".shadow.boxSize","effect.shadow.altitudeOff":I+A+".shadow.altitudeOff","effect.shadow.altitudeOn":I+A+".shadow.altitudeOn","disable.effect.aa":R+A+".aa","disable.effect.ao":R+A+".ao","disable.effect.shadow":R+A+".shadow","disable.effect.bloom":R+A+".bloom","disable.effect.dof":R+A+".dof","disable.effect.sslr":R+A+".sslr","disable.effect.tone":R+A+".tone","disable.effect":R+A,"terrain.terrainAnalyzer":"/3DEXPERIENCity/terrain.terrainAnalyzer","heatmapTool.onChange:numberOfPoint":"/3DEXPERIENCity/heatmapTool.onChange:numberOfPoint"},Initialize:function(e,P){if(-1===this.domElements.indexOf(e)){this.domElements.push(e),t.addGestureRecognizer(new s,document),t.addGestureRecognizer(new o,e),t.addGestureRecognizer(new a,e),t.addGestureRecognizer(new r(i.MouseButton.LEFT),e),t.addGestureRecognizer(new r(i.MouseButton.RIGHT),e),t.addGestureRecognizer(new r(i.MouseButton.WHEEL),e),t.addGestureRecognizer(new r(i.MouseButton.MIDDLE),e),t.addGestureRecognizer(new n(i.MouseButton.LEFT),document),t.addGestureRecognizer(new n(i.MouseButton.RIGHT),document),t.addGestureRecognizer(new n(i.MouseButton.MIDDLE),document);var w=new l(i.MouseButton.LEFT),M=new l(i.MouseButton.MIDDLE),T=new l(i.MouseButton.RIGHT),I=new h(i.MouseButton.LEFT);I.requireGesture(w);var R=new h(i.MouseButton.MIDDLE);R.requireGesture(M);var A=new h(i.MouseButton.RIGHT);A.requireGesture(T),w.maxTime=450,M.maxTime=450,T.maxTime=450,R.maxTime=450,I.maxTime=450,A.maxTime=450,t.addGestureRecognizer(w,e),t.addGestureRecognizer(M,e),t.addGestureRecognizer(T,e),t.addGestureRecognizer(I,e),t.addGestureRecognizer(R,e),t.addGestureRecognizer(A,e),t.addGestureRecognizer(new p,e),t.addGestureRecognizer(new c,e),t.addGestureRecognizer(new g,e),t.addGestureRecognizer(new v,e),t.addGestureRecognizer(new y,e),t.addGestureRecognizer(new x,e),t.addGestureRecognizer(new C,e);var F=new v,L=new _,V=new y;F.maskGesture(L),F.maskGesture(V),L.maskGesture(F),L.maskGesture(V),V.maskGesture(F),V.maskGesture(L),t.addGestureRecognizer(F,e),t.addGestureRecognizer(L,e),t.addGestureRecognizer(V,e),t.addGestureRecognizer(new b,e);var O=new f,N=new m;N.requireGesture(O);var U=new S,E=new D;E.requireGesture(U),t.addGestureRecognizer(O,e),t.addGestureRecognizer(N,e),t.addGestureRecognizer(U,e),t.addGestureRecognizer(E,e),t.addGestureRecognizer(new d),t.addGestureRecognizer(new u),P&&this._debugEvents()}},_debugEvents:function(){this.subscribeTo("/VISU/onKeyDown",function(){P.warn("/VISU/onKeyDown")}),this.subscribeTo("/VISU/onKeyUp",function(){P.warn("/VISU/onKeyUp")}),this.subscribeTo("/VISU/onEdit",function(){P.warn("/VISU/onEdit")}),this.subscribeTo("/VISU/onMouseDown",function(){P.warn("/VISU/onMouseDown")}),this.subscribeTo("/VISU/onMouseOut",function(){P.warn("/VISU/onMouseOut")}),this.subscribeTo("/VISU/onMouseWheel",function(){P.warn("/VISU/onMouseWheel")}),this.subscribeTo("/VISU/onLeftMouseDown",function(){P.warn("/VISU/onLeftMouseDown")}),this.subscribeTo("/VISU/onRightMouseDown",function(){P.warn("/VISU/onRightMouseDown")}),this.subscribeTo("/VISU/onMiddleMouseDown",function(){P.warn("/VISU/onMiddleMouseDown")}),this.subscribeTo("/VISU/onLeftMouseUp",function(){P.warn("/VISU/onLeftMouseUp")}),this.subscribeTo("/VISU/onRightMouseUp",function(){P.warn("/VISU/onRightMouseUp")}),this.subscribeTo("/VISU/onMiddleMouseUp",function(){P.warn("/VISU/onMiddleMouseUp")}),this.subscribeTo("/VISU/onLeftClick",function(){P.warn("/VISU/onLeftClick")}),this.subscribeTo("/VISU/onRightClick",function(){P.warn("/VISU/onRightClick")}),this.subscribeTo("/VISU/onMiddleClick",function(){P.warn("/VISU/onMiddleClick")}),this.subscribeTo("/VISU/onLeftDoubleClick",function(){P.warn("/VISU/onLeftDoubleClick")}),this.subscribeTo("/VISU/onRightDoubleClick",function(){P.warn("/VISU/onRightDoubleClick")}),this.subscribeTo("/VISU/onMiddleDoubleClick",function(){P.warn("/VISU/onMiddleDoubleClick")}),this.subscribeTo("/VISU/onTouch",function(){P.warn("/VISU/onTouch")}),this.subscribeTo("/VISU/onRelease",function(){P.warn("/VISU/onRelease")}),this.subscribeTo("/VISU/onSwipe",function(){P.warn("/VISU/onSwipe")}),this.subscribeTo("/VISU/onTap",function(){P.warn("/VISU/onTap")}),this.subscribeTo("/VISU/onDoubleTap",function(){P.warn("/VISU/onDoubleTap")}),this.subscribeTo("/VISU/onDoublePinchTap",function(){P.warn("/VISU/onDoublePinchTap")}),this.subscribeTo("/VISU/onHold",function(){P.warn("/VISU/onHold")}),this.subscribeTo("/VISU/onLongHold",function(){P.warn("/VISU/onLongHold")}),this.subscribeTo("/VISU/onPan",function(){P.warn("/VISU/onPan")}),this.subscribeTo("/VISU/onPinch",function(){P.warn("/VISU/onPinch")}),this.subscribeTo("/VISU/onRotate",function(){P.warn("/VISU/onRotate")}),this.subscribeTo("/VISU/onPinchPanRotate",function(){P.warn("/VISU/onPinchPanRotate")})},publish:function(t,i,r){e.publish({event:t,data:i,context:r})},unsubscribe:function(t){e.unsubscribe(t)},subscribeTo:function(t,i,r){if(w.is(t))return r?e.subscribeOnce({event:t},i):e.subscribe({event:t},i)},subscribeToBasicEvent:function(e){return this.subscribeTo("/VISU/onBasicEvent",e)},subscribeToMouseWheel:function(e){return this.subscribeTo("/VISU/onMouseDown",e)},subscribeToLeftMouseDown:function(e){return this.subscribeTo("/VISU/onLeftMouseDown",e)},subscribeToRightMouseDown:function(e){return this.subscribeTo("/VISU/onRightMouseDown",e)},subscribeToMiddleMouseDown:function(e){return this.subscribeTo("/VISU/onMiddleMouseDown",e)},subscribeToLeftMouseUp:function(e){return this.subscribeTo("/VISU/onLeftMouseUp",e)},subscribeToRightMouseUp:function(e){return this.subscribeTo("/VISU/onRightMouseUp",e)},subscribeToMiddleMouseUp:function(e){return this.subscribeTo("/VISU/onMiddleMouseUp",e)},subscribeToMouseMove:function(e){return this.subscribeTo("/VISU/onMouseMove",e)},subscribeToMouseOut:function(e){return this.subscribeTo("/VISU/onMouseOut",e)},subscribeToRelease:function(e){t.addEvent(document,"onRelease",e)}};var F=null;return null===F&&(F=new M),F}),define("DS/XCityTools/RenderPassManager",["DS/XCityTools/EventDispatcher","DS/XCityTools/Debug"],function(e,t){"use strict";var i=function(e){this._passes={},this._passesID=[],this._mainComposer=e};return i.prototype={addPass:function(i,r,s,n){if(void 0!==r)if(void 0===this._passes[i]){var a;if(void 0!==s)if(void 0!==s.before){if(void 0===(a=this.getPass(s.before))||void 0!==n&&n!==s.before)return void e.subscribeTo("/RenderPassManager/onNewPassAdded",this.addPass.bind(this,i,r,s),!0);this._mainComposer.insertCustomPassBefore(r,a)}else if(void 0!==s.after){if(void 0===(a=this.getPass(s.after))||void 0!==n&&n!==s.after)return void e.subscribeTo("/RenderPassManager/onNewPassAdded",this.addPass.bind(this,i,r,s),!0);this._mainComposer.insertCustomPassAfterPass(r,a)}else s.pre?this._mainComposer.insertCustomPassBefore(r):this._mainComposer.insertCustomPassAfterPass(r);else this._mainComposer.insertCustomPassAfterPass(r);this._mainComposer.updateComposerContexts(),this._passesID.push(i),this._passes[i]=r,e.publish("/RenderPassManager/onNewPassAdded",i)}else t.warn("A pass with ID '"+i+"' is already defined");else t.warn("Undefined pass: '"+i+"'")},enablePass:function(e){var t=this.getPass(e);if(void 0!==t){var i,r=this._mainComposer.contexts.length;for(i=0;i<r;++i)this._mainComposer.contexts[i].enablePass(t,!0)}},disablePass:function(e){var t=this.getPass(e);if(void 0!==t){var i,r=this._mainComposer.contexts.length;for(i=0;i<r;++i)this._mainComposer.contexts[i].enablePass(t,!1)}},getPass:function(e){return this._passes[e]},getPassList:function(){return this._passesID}},i}),define("DS/XCityTools/ShaderTools",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/ColorGradient","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils","DS/XCityTools/Expression","DS/Shaders/DeferredShaders"],function(e,t,i,r,s,n,a){"use strict";var o=e.singleton({init:function(){r.subscribeTo("/3DEXPERIENCity/onUpdate",this._updateAnimationUniforms.bind(this)),this.animationMaterials={},this.sslrHacked=!1},initialize:function(e){void 0!==e&&e.webglViewer&&(this._GLMaxTextureUnits=e.webglViewer.getWebGLContext().getParameter(e.webglViewer.getWebGLContext().MAX_TEXTURE_IMAGE_UNITS),this._GLStandardDerivatives=void 0!==e.webglViewer.getRenderer().supportsStandardDerivatives(),this._usePhysical=e.webglViewer.getWebGLContext().getParameter(e.webglViewer.getWebGLContext().MAX_VERTEX_UNIFORM_VECTORS)>128&&e.webglViewer.getWebGLContext().getParameter(e.webglViewer.getWebGLContext().MAX_FRAGMENT_UNIFORM_VECTORS)>128)},registerAnimationUniforms:function(e,t,i){void 0!==e&&void 0===this.animationMaterials[e.id]&&(this.animationMaterials[e.id]={material:e,uniform:t,callback:i,activated:!1})},unregisterAnimationUniforms:function(e){void 0!==e&&void 0!==this.animationMaterials[e.id]&&delete this.animationMaterials[e.id]},activateAnimationUniforms:function(e){void 0!==e&&void 0!==this.animationMaterials[e.id]&&(this.animationMaterials[e.id].activated=!0)},deactivateAnimationUniforms:function(e){void 0!==e&&void 0!==this.animationMaterials[e.id]&&(this.animationMaterials[e.id].activated=!1)},_updateAnimationUniforms:function(e){if(!this._noAnimation){var t,i,s=Object.keys(this.animationMaterials),n=s.length;for(i=0;i<n;i++){t=s[i];var a=this.animationMaterials[t];a.activated&&(r.publish("/xCity/needRender",this),this.animationMaterials[t].material.isPDSFX()?this.animationMaterials[t].material.updatePDSFXUniform(a.uniform,a.callback(e)):this.animationMaterials[t].material.uniforms[a.uniform].value=a.callback(e))}}},enableAnimations:function(e){this._noAnimation=!e},disableAnimations:function(){this.enableAnimations(!1)},updateSingleUniform:function(e,t,i){e.isPDSFX()?e.updatePDSFXUniform(t,i):e.uniforms&&e.uniforms[t]&&(e.uniforms[t].value=i)},updateCommonUniforms:function(e,t){var r,s={combine:"combine",envMap:"envMap",lightMap:"lightMap",map:"map",normalMap:"normalMap",specularMap:"specularMap",oceanTexture:"oceanTexture"},n=e.uniforms||{};if(e._PDSFXData&&e._PDSFXData.PDSFX&&(n=e._PDSFXData.pdsfxUniforms),null!=n){for(d in s)void 0!==e[d]&&void 0!==n[s[d]]&&e[d]!==n[s[d].value]&&(null!==n[s[d]].value&&void 0!==n[s[d]].value||(t=!0),n[s[d]].value=e[d]);var a,l=o.commonParams;for(r=0;r<l.length;r++)void 0!==e[d=l[r]]&&void 0!==n[d]&&e[d]!==n[d].value&&(n[d].value=e[d]);for(l=o.ColorParams,r=0;r<l.length;r++)void 0!==(a=e[d=l[r]])&&void 0!==n[d]&&(a instanceof i&&(a=a.computeColor()),a!==n[d]&&(n[d].value=a));for(l=o.PdsfxParams,r=0;r<l.length;r++){var h=l[r],d=h[0],u=h[1];void 0!==e[d]&&void 0!==n[u]&&e[d]!==n[u].value&&(n[u].value=e[d])}e.isPDSFX&&e.isPDSFX()&&n.mapCity&&("Custom"!==e.getType()&&(e.map=void 0),n.useMapCity&&n.mapCity.value&&(n.useMapCity.value=!0)),!0===t&&(e.needsUpdate=!0),e.force=!0}},getBaseShaderMaterial:function(e){return this.getCustomShaderMaterial([o.common,o.vertexInformation,o.clipPlanes,o.urbanLights,o.shadowMapCustom],e)},getMapShaderMaterial:function(e){return this.getCustomShaderMaterial([o.common,o.vertexInformation,o.clipPlanes,o.map,o.urbanLights,o.shadowMapCustom],e)},getExistingShaderMaterial:function(e){var i,r=e.toLowerCase();return"ocean"===r||"swim"===r?((i=this.getPDSFXMaterial([o.chunkOcean_PDSFX],this._usePhysical?"physical":"phong")).name=r+"ShaderMaterial",this._usePhysical||i.updatePDSFXUniform("specularOcean",new t.Color("rgb(25,25,25)")),i):"road"===r?((i=this.getPDSFXMaterial([o.atlas_RoadMarking_PDSFX,o.atlas_RoadArea_PDSFX,o.atlas_LawnArea_PDSFX,o.atlas_FootPaths_PDSFX,o.atlas_SideWalkEdges_PDSFX],"physical")).name=r+"ShaderMaterial",i):void 0},getCustomShaderMaterial:function(e,i,r){if(void 0!==e&&e instanceof Array){var n,a,o,l,h,d;for(n=0;n<e.length;++n){if(d=e[n],e.lastIndexOf(d)!==n){e.splice(e.lastIndexOf(d),1),n-=1;break}if(d&&d.depends)for(a=0;a<d.depends.length;++a)if(-1===e.indexOf(d.depends[a])){e.splice(n,0,d.depends[a]),n-=2;break}}var u=[],c=[],p=[],f=[],m=[];for(n=0;n<e.length;++n)u.push(e[n].uniforms),c.push(e[n].vertex_pars),p.push(e[n].vertex),f.push(e[n].fragment_pars),m.push(e[n].fragment);if(i){for(c[0]=c[0]+"\n attribute mat4 instanceMatrix;\n attribute vec4 instanceColor;\n attribute float instanceFlag;\n attribute float instanceIndex;",n=0;n<c.length;++n)c[n]=c[n].replace(/color/g,"instanceColor");for(n=0;n<p.length;++n)p[n]=p[n].replace(/modelMatrix/g,"modelMatrix * instanceMatrix"),p[n]=p[n].replace(/normalMatrix/g,"normalMatrix * mat3(instanceMatrix)"),p[n]=p[n].replace(/color/g,"instanceColor"),p[n]=p[n].replace(/uv2.y/g,"instanceFlag");for(n=0;n<f.length;++n)f[n]=f[n].replace(/color/g,"instanceColor");for(n=0;n<m.length;++n)m[n]=m[n].replace(/modelMatrix/g,"modelMatrix * instanceMatrix"),m[n]=m[n].replace(/normalMatrix/g,"normalMatrix * mat3(instanceMatrix)"),m[n]=m[n].replace(/color/g,"instanceColor")}m.push(t.ShaderChunk.linear_to_gamma_fragment);var g,v,_=Object.assign({},{name:"custom_shader_material",uniforms:t.UniformsUtils.merge(u),vertexShaderPars:c.join("\n"),vertexShaderBody:p.join("\n"),fragmentShaderPars:f.join("\n"),fragmentShaderBody:m.join("\n")},r),y=new t.ShaderMaterialDS(_),b=[];if(s.is(y.uniforms))for(h=(l=Object.keys(y.uniforms)).length,n=0;n<h;n++)g=l[n],void 0!==y.uniforms[g].animation&&b.push({uniform:g,animation:y.uniforms[g].animation});if(b.length>0){for(y.dynamicUpdate=!0,n=0;n<b.length;++n){var x=b[n];this.registerAnimationUniforms(y,x.uniform,x.animation)}y.cloneWithAnim=function(e){var t=e.clone();t.dynamicUpdate=!0;for(var i=0;i<b.length;++i){var r=b[i];this.registerAnimationUniforms(t,r.uniform,r.animation)}return t}.bind(this,y)}for(n=0;n<e.length;++n)if(e[n]){if(s.is(e[n].attributes))for(h=(l=Object.keys(e[n].attributes)).length,v=0;v<h;v++)o=l[v],y[o]=e[n].attributes[o];if(s.is(e[n].vertex_attributes))for(h=(l=Object.keys(e[n].vertex_attributes)).length,v=0;v<h;v++)o=l[v],void 0!==y.attributes&&null!==y.attributes||(y.attributes={}),y.attributes[o]=e[n].vertex_attributes[o]}return y.force=!0,y.enableClipPlanes=!0,y.clone=function(){return this.__proto__.clone.bind(y)()},y}},parsePDSFXShader:function(e,i){if(e instanceof Array)for(var r=0;r<e.length;++r)this.parsePDSFXShader(e[r],i);if(e.depends){var s,n=e.depends.length;for(r=0;r<n;++r)s=e.depends[r],this.parsePDSFXShader(s,i)}if(-1===i.shaderList.indexOf(e.name)||void 0===e.name){for(var a in i.shaderList.push(e.name),e.attributes)i.attributes[a]=e.attributes[a];var o=t.UniformsUtils.clone(e.uniforms);for(var a in o)i.uniforms[a]=o[a];for(var a in e.varyings)i.varyings[a]=e.varyings[a];for(var a in e.VS_global_code&&i.VS_global_code.push(e.VS_global_code),e.FS_global_code&&i.FS_global_code.push(e.FS_global_code),e.VS_overridableFunctions)i.VS_overridableFunctions[a]?i.VS_overridableFunctions[a]+="\n"+e.VS_overridableFunctions[a]:i.VS_overridableFunctions[a]=e.VS_overridableFunctions[a];for(var a in e.FS_overridableFunctions)i.FS_overridableFunctions[a]?i.FS_overridableFunctions[a]+="\n"+e.FS_overridableFunctions[a]:i.FS_overridableFunctions[a]=e.FS_overridableFunctions[a]}},getPDSFXMaterial:function(e,i,r){var n;(n="physical"===i?new t.PhysicalMaterial({force:!0}):"specGloss"===i?new t.PhysicalMaterial({force:!0,specGloss:!0}):"line"===i?new t.LineBasicMaterial({force:!0,lineWidth:10}):"phong"===i?new t.MeshPhongMaterial({force:!0}):"basic"===i?new t.MeshBasicMaterial({force:!0}):new t.PhysicalMaterial({force:!0})).metalness=0,n.roughness=1,n.textureBlending=t.TextureBlendOperations.MODULATE,n.activatePDSFX();var a={ComputeCommonValues:"void ComputeCommonValues() {",ComputeObjectPosition:"vec3 ComputeObjectPosition() {",ComputeObjectFollowingPosition:"vec3 ComputeObjectFollowingPosition() {",ComputeObjectPreviousPosition:"vec3 ComputeObjectPreviousPosition() {",ComputeObjectNormal:"vec3 ComputeObjectNormal() {",ComputeObjectTexCoord0:"vec4 ComputeObjectTexCoord0() {",ComputeObjectTexCoord1:"vec4 ComputeObjectTexCoord1() {",ComputeObjectTexCoord2:"vec4 ComputeObjectTexCoord2() {",ComputeObjectTangent:"vec3 ComputeObjectTangent() {",ComputeObjectBinormal:"vec3 ComputeObjectBinormal() {",ProcessViewTangentSpace:"void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {",ProcessClipSpacePosition:"void ProcessClipSpacePosition(inout vec4 ioPosition) {",ComputePointSize:"float ComputePointSize()",ComputeVaryingValues:"void ComputeVaryingValues() {",ComputeHalfWidth:"float ComputeHalfWidth() {",ProcessLineDistance:"void ProcessLineDistance(inout vec2 lineDistance) {"},o={ComputeCommonValues:"}",ComputeObjectPosition:"}",ComputeObjectFollowingPosition:"}",ComputeObjectPreviousPosition:"}",ComputeObjectNormal:"}",ComputeObjectTexCoord0:"}",ComputeObjectTexCoord1:"}",ComputeObjectTexCoord2:"}",ComputeObjectTangent:"}",ComputeObjectBinormal:"}",ProcessViewTangentSpace:"}",ProcessClipSpacePosition:"}",ComputePointSize:"}",ComputeVaryingValues:"}",ComputeHalfWidth:"}"},l={ComputeCommonValues:"void ComputeCommonValues() {",ComputeDiscard:"bool ComputeDiscard() {",ComputeAlbedo:"vec3 ComputeAlbedo() {",_ComputeDiffuseTexel:"vec4 _ComputeDiffuseTexel() {",ComputeViewPosition:"vec3 ComputeViewPosition() {",ComputeViewNormal:"vec3 ComputeViewNormal() {",ComputeSpecularReflectance:"vec3 ComputeSpecularReflectance() {",ComputeRoughness:"float ComputeRoughness() {",ComputeTransparency:"float ComputeTransparency() {",ComputeEmissive:"vec3 ComputeEmissive() {",ComputeOpacity:"float ComputeOpacity() {",ComputeHalfWidth:"float ComputeHalfWidth() {",ProcessLinePattern:"void ProcessLinePattern(inout float patternValue, in float currentPixelDistance) {",ProcessFinalColor:"void ProcessFinalColor(inout vec4 ioFinalColor) {"},h={ComputeCommonValues:"}",ComputeDiscard:"}",ComputeAlbedo:"return cAlbedo;}",_ComputeDiffuseTexel:"}",ComputeViewPosition:"}",ComputeViewNormal:"}",ComputeSpecularReflectance:"}",ComputeRoughness:"}",ComputeTransparency:"}",ComputeEmissive:"}",ComputeOpacity:"return cOpacity;}",ComputeHalfWidth:"}",ProcessLinePattern:"}",ProcessFinalColor:"}"},d={attributes:{},uniforms:{},varyings:{},VS_global_code:[],FS_global_code:["vec3 cAlbedo = vec3(1.0);","float cOpacity = 1.0;"],VS_overridableFunctions:{},FS_overridableFunctions:{},shaderList:[]};for(var u in this.parsePDSFXShader(e,d),d.VS_global_code=d.VS_global_code.join("\n"),d.FS_global_code=d.FS_global_code.join("\n"),d.VS_overridableFunctions)d.VS_overridableFunctions[u]=a[u]+d.VS_overridableFunctions[u]+o[u];for(var u in d.FS_overridableFunctions)d.FS_overridableFunctions[u]=l[u]+d.FS_overridableFunctions[u]+h[u];for(var u in d.uniforms&&n.setPDSFXUniforms(d.uniforms),d.varyings&&n.setPDSFXVaryings(d.varyings),(d.VS_global_code||d.FS_global_code)&&n.setPDSFXGlobalShaderCode(d.VS_global_code,d.FS_global_code),(d.VS_overridableFunctions||d.FS_overridableFunctions)&&n.setPDSFXOverridableFunctions(d.VS_overridableFunctions,d.FS_overridableFunctions),d.attributes)n[u]=d.attributes[u];var c=[];if(s.is(n._PDSFXData.pdsfxUniforms))for(var p,f=Object.keys(n._PDSFXData.pdsfxUniforms),m=f.length,g=0;g<m;g++)p=f[g],void 0!==n._PDSFXData.pdsfxUniforms[p].animation&&c.push({uniform:p,animation:n._PDSFXData.pdsfxUniforms[p].animation});if(c.length>0){for(g=0;g<c.length;++g){var v=c[g];this.registerAnimationUniforms(n,v.uniform,v.animation)}n.cloneWithAnim=function(e){for(var t=n.clone(),i=0;i<c.length;++i){var r=c[i];this.registerAnimationUniforms(t,r.uniform,r.animation)}return t}.bind(this,n)}return n.clone=function(){return this.__proto__.clone.bind(n)()},n},setPDSFXMaterial:function(e,i,r,n){if(!s.is(e))return null;e.activatePDSFX();var a={ComputeCommonValues:"void ComputeCommonValues() {",ComputeObjectPosition:"vec3 ComputeObjectPosition() {",ComputeObjectFollowingPosition:"vec3 ComputeObjectFollowingPosition() {",ComputeObjectPreviousPosition:"vec3 ComputeObjectPreviousPosition() {",ComputeObjectNormal:"vec3 ComputeObjectNormal() {",ComputeObjectTexCoord0:"vec4 ComputeObjectTexCoord0() {",ComputeObjectTexCoord1:"vec4 ComputeObjectTexCoord1() {",ComputeObjectTexCoord2:"vec4 ComputeObjectTexCoord2() {",ComputeObjectTangent:"vec3 ComputeObjectTangent() {",ComputeObjectBinormal:"vec3 ComputeObjectBinormal() {",ProcessViewTangentSpace:"void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {",ProcessClipSpacePosition:"void ProcessClipSpacePosition(inout vec4 ioPosition) {",ComputePointSize:"float ComputePointSize()",ComputeVaryingValues:"void ComputeVaryingValues() {",ComputeHalfWidth:"float ComputeHalfWidth() {",ProcessLineDistance:"void ProcessLineDistance(inout vec2 lineDistance) {"},o={ComputeCommonValues:"}",ComputeObjectPosition:"}",ComputeObjectFollowingPosition:"}",ComputeObjectPreviousPosition:"}",ComputeObjectNormal:"}",ComputeObjectTexCoord0:"}",ComputeObjectTexCoord1:"}",ComputeObjectTexCoord2:"}",ComputeObjectTangent:"}",ComputeObjectBinormal:"}",ProcessViewTangentSpace:"}",ProcessClipSpacePosition:"}",ComputePointSize:"}",ComputeVaryingValues:"}",ComputeHalfWidth:"}"},l={ComputeCommonValues:"void ComputeCommonValues() {",ComputeDiscard:"bool ComputeDiscard() {",ComputeAlbedo:"vec3 ComputeAlbedo() {",_ComputeDiffuseTexel:"vec4 _ComputeDiffuseTexel() {",ComputeViewPosition:"vec3 ComputeViewPosition() {",ComputeViewNormal:"vec3 ComputeViewNormal() {",ComputeSpecularReflectance:"vec3 ComputeSpecularReflectance() {",ComputeRoughness:"float ComputeRoughness() {",ComputeTransparency:"float ComputeTransparency() {",ComputeEmissive:"vec3 ComputeEmissive() {",ComputeOpacity:"float ComputeOpacity() {",ComputeHalfWidth:"float ComputeHalfWidth() {",ProcessLinePattern:"void ProcessLinePattern(inout float patternValue, in float currentPixelDistance) {",ProcessFinalColor:"void ProcessFinalColor(inout vec4 ioFinalColor) {"},h={ComputeCommonValues:"}",ComputeDiscard:"}",ComputeAlbedo:"return cAlbedo;}",_ComputeDiffuseTexel:"}",ComputeViewPosition:"}",ComputeViewNormal:"}",ComputeSpecularReflectance:"}",ComputeRoughness:"}",ComputeTransparency:"}",ComputeEmissive:"}",ComputeOpacity:"return cOpacity;}",ComputeHalfWidth:"}",ProcessLinePattern:"}",ProcessFinalColor:"}"},d={attributes:{},uniforms:{},varyings:{},VS_global_code:[],FS_global_code:["vec3 cAlbedo = vec3(1.0);","float cOpacity = 1.0;"],VS_overridableFunctions:{},FS_overridableFunctions:{},shaderList:[]};for(var u in this.parsePDSFXShader(i,d),d.VS_global_code=d.VS_global_code.join("\n"),d.FS_global_code=d.FS_global_code.join("\n"),d.VS_overridableFunctions)d.VS_overridableFunctions[u]=a[u]+d.VS_overridableFunctions[u]+o[u];for(var u in d.FS_overridableFunctions)d.FS_overridableFunctions[u]=l[u]+d.FS_overridableFunctions[u]+h[u];for(var u in d.uniforms&&e.setPDSFXUniforms(d.uniforms),d.varyings&&e.setPDSFXVaryings(d.varyings),(d.VS_global_code||d.FS_global_code)&&e.setPDSFXGlobalShaderCode(d.VS_global_code,d.FS_global_code),(d.VS_overridableFunctions||d.FS_overridableFunctions)&&e.setPDSFXOverridableFunctions(d.VS_overridableFunctions,d.FS_overridableFunctions),d.attributes)e[u]=d.attributes[u];e.metalness=0,e.roughness=1,e.textureBlending=t.TextureBlendOperations.MODULATE;var c=[];if(s.is(e._PDSFXData.pdsfxUniforms))for(var p,f=Object.keys(e._PDSFXData.pdsfxUniforms),m=f.length,g=0;g<m;g++)p=f[g],void 0!==e._PDSFXData.pdsfxUniforms[p].animation&&c.push({uniform:p,animation:e._PDSFXData.pdsfxUniforms[p].animation});if(c.length>0){for(g=0;g<c.length;++g){var v=c[g];this.registerAnimationUniforms(e,v.uniform,v.animation)}e.cloneWithAnim=function(t){var i=e.clone();i.reflectionCoef=t.reflectionCoef;for(var r=0;r<c.length;++r){var s=c[r];this.registerAnimationUniforms(i,s.uniform,s.animation)}return i}.bind(this,e)}return e.clone=function(){return this.__proto__.clone.bind(e)()},e}});o.ColorParams=["color","specular","ambient","oceanColor","oceanColorDetection","diffuse"],o.BoolParams=["forceSide","transparent","wireframe","depthTest","depthWrite","enableClipPlanes","generateMipmaps","dynamicUpdate","showOcean"],o.FloatParams=["opacity","alphaTest","reflectivity","refractionRatio","reflectionCoef","opacityFactor","minOpacity","oceanAlpha","oceanRangeDetection"],o.IntParams=["shininess","wireframeLinewidth","r_mode","minWidth","minDist","maxDist","lineWidth"],o.TexParams=["map","wallTextures","roofTextures","envMap","lightMap","normalMap","specularMap","oceanTexture"],o.StringParams=["extrusionHeight"],o.WrapParams=["wrapS","wrapT"],o.FilterParams=["minFilter","magFilter"],o.PdsfxParams=[["map","mapCity"],["diffuse","diffuseCity"],["ambient","ambientCity"],["specular","specularCity"],["opacity","opacityCity"],["alphaTestCity","alphaTestCity"],["dashPattern","dashPatternCity"]],o.commonParams=o.BoolParams.concat(o.FloatParams,o.IntParams,o.FilterParams,o.WrapParams,"blending","side"),o.whiteMap=new t.DataTexture(new Float32Array([1,1,1,1]),1,1,t.RGBAFormat,t.FloatType),o.whiteMap.name="DefaultWhiteTexture",o.whiteMap.flipY=!1,o.whiteMap.minFilter=t.NearestFilter,o.whiteMap.magFilter=t.NearestFilter,o.whiteMap.generateMipmaps=!1,o.whiteMap.needsUpdate=!0,o.whiteMap.shared=1,o.whiteMap.loadEndStatus="complete",o.common={attributes:{},uniforms:t.UniformsLib.common,vertex_pars:"",vertex:[t.ShaderChunk.default_vertex,t.ShaderChunk.worldpos_vertex,t.ShaderChunk.defaultnormal_vertex,"vec3 mvNormal;","if (use_normal_matrix)","mvNormal = normalMatrix * objectNormal;","else ","mvNormal = vec3(viewMatrix * (modelMatrix * vec4(objectNormal, 0.0)));"].join("\n"),fragment_pars:["uniform float opacity;"].join("\n"),fragment:["gl_FragColor = vec4( vec3(1.0), opacity );","#ifdef GAMMA_INPUT","gl_FragColor.rgb *= gl_FragColor.rgb;","#endif"].join("\n")},o.commonWithoutOpacity={attributes:{},uniforms:t.UniformsLib.common,vertex_pars:"",vertex:[t.ShaderChunk.default_vertex,t.ShaderChunk.worldpos_vertex,t.ShaderChunk.defaultnormal_vertex,"vec3 mvNormal;","if (use_normal_matrix)","mvNormal = normalMatrix * objectNormal;","else ","mvNormal = vec3(viewMatrix * (modelMatrix * vec4(objectNormal, 0.0)));"].join("\n"),fragment_pars:["uniform float opacity;"].join("\n"),fragment:["gl_FragColor = vec4( vec3(1.0), 1.0 );","#ifdef GAMMA_INPUT","gl_FragColor.rgb *= gl_FragColor.rgb;","#endif"].join("\n")},o.commonNoNormal={attributes:{},uniforms:t.UniformsLib.common,vertex_pars:"",vertex:[t.ShaderChunk.default_vertex,t.ShaderChunk.worldpos_vertex,"vec3 mvNormal = vec3(0.0,0.0,1.0);"].join("\n"),fragment_pars:["uniform float opacity;"].join("\n"),fragment:["gl_FragColor = vec4( vec3(1.0), opacity );","#ifdef GAMMA_INPUT","gl_FragColor.rgb *= gl_FragColor.rgb;","#endif"].join("\n")};var l={};return l.lines_vertex=["#ifdef USE_DASHEDLINE","   float worldToPixel = abs(projectionMatrix[0][0]/gl_Position.w)*0.5/pixelSize.x;","   vLineDistance = scale * modelMatrix[0][0] * lineDistance * worldToPixel;","#endif","#ifdef USE_WIDELINE","   mvPosition = viewMatrix * (modelMatrix * vec4(position.xyz, 1.0));","   vec4 mvPositionPrec = viewMatrix * (modelMatrix * vec4(previousPos.xyz, 1.0));","   vec4 mvPositionSuiv = viewMatrix * (modelMatrix * vec4(followingPos.xyz, 1.0));","   vec4 pmvPosition = projectionMatrix * mvPosition;","   vec4 pmvPositionPrec = projectionMatrix * mvPositionPrec;","   vec4 pmvPositionSuiv = projectionMatrix * mvPositionSuiv;","","   vec3 eps = vec3(0.0000001);","   bool bPrecCurr = !all(lessThan(abs(pmvPosition.xyz - pmvPositionPrec.xyz), eps));","   bool bCurrNext = !all(lessThan(abs(pmvPositionSuiv.xyz - pmvPosition.xyz), eps));","","   vec3 testClip = vec3(sign(pmvPositionPrec.w + pmvPositionPrec.z), sign(pmvPosition.w + pmvPosition.z), sign(pmvPositionSuiv.w + pmvPositionSuiv.z));","   if (bPrecCurr && testClip.x * testClip.y < 0.0 ){","       float a = (pmvPositionPrec.w + pmvPositionPrec.z)/((pmvPositionPrec.w + pmvPositionPrec.z) - (pmvPosition.w + pmvPosition.z));","       if (testClip.x < 0.0) {","           pmvPositionPrec = (1.0 - a) * pmvPositionPrec + a * pmvPosition;","       } else if (mod(sideExtrusion,2.0) == 1.0) {","           pmvPosition = (1.0 - a) * pmvPositionPrec + a * pmvPosition;","           pmvPositionSuiv = pmvPosition;","           bCurrNext = false;","       }","   }","   if (bCurrNext && testClip.y * testClip.z < 0.0 ){","       float a = (pmvPosition.w + pmvPosition.z)/((pmvPosition.w + pmvPosition.z) - (pmvPositionSuiv.w + pmvPositionSuiv.z));","       if (testClip.z < 0.0) {","           pmvPositionSuiv = (1.0 - a) * pmvPosition + a * pmvPositionSuiv;","       } else if (mod(sideExtrusion,2.0) == 0.0){","           pmvPosition = (1.0 - a) * pmvPosition + a * pmvPositionSuiv;","           pmvPositionPrec = pmvPosition;","           bPrecCurr = false;","       }","   }","","   pmvPosition.y *= pixelSize.x/pixelSize.y;","   pmvPositionPrec.y *= pixelSize.x/pixelSize.y;","   pmvPositionSuiv.y *= pixelSize.x/pixelSize.y;","   pmvPosition /= abs(pmvPosition.w);","   pmvPositionPrec /= abs(pmvPositionPrec.w);","   pmvPositionSuiv /= abs(pmvPositionSuiv.w);","","   float offset = l_fHalfWidth  * pixelSize.x;","   vec2 pos, posPrecCurr, posCurrNext;","   vec2 dirPrecCurr, dirCurrNext;","","   if (bPrecCurr){","       dirPrecCurr = pmvPosition.xy - pmvPositionPrec.xy;","       dirPrecCurr = normalize(dirPrecCurr);","       posPrecCurr = pmvPosition.xy + offset * sign(sideExtrusion) * vec2(-dirPrecCurr.y, dirPrecCurr.x);","   } else if (bCurrNext) {","       dirPrecCurr = pmvPosition.xy - pmvPositionSuiv.xy;","       dirPrecCurr = normalize(dirPrecCurr);","       posPrecCurr = pmvPosition.xy + offset * dirPrecCurr.xy;","   }","","   if (bCurrNext){ //avoid null vector problems","       dirCurrNext = pmvPositionSuiv.xy - pmvPosition.xy;","       dirCurrNext = normalize(dirCurrNext);","       posCurrNext = pmvPosition.xy + offset * sign(sideExtrusion) * vec2(-dirCurrNext.y, dirCurrNext.x);","   } else if (bPrecCurr) {","       dirCurrNext = pmvPosition.xy - pmvPositionPrec.xy;","       dirCurrNext = normalize(dirCurrNext);","       posCurrNext = pmvPosition.xy + offset * dirCurrNext.xy;","   }","","   vec2 dir = normalize(dirCurrNext.xy - dirPrecCurr.xy);","   if ( bPrecCurr && bCurrNext){","       if (abs(dirCurrNext.x - dirPrecCurr.x) < 0.01 && abs(dirCurrNext.y - dirPrecCurr.y) < 0.01){","           dir = vec2(-dirCurrNext.y, dirCurrNext.x);","       }","       float sinAlpha = dir.y * dirPrecCurr.x - dir.x * dirPrecCurr.y;","       if (sign(sinAlpha) == -sign(sideExtrusion) && asin(abs(sinAlpha)) < radians(45.0)) {","           if (mod(sideExtrusion,2.0) == 0.0){","               pos = posCurrNext - offset * dirCurrNext;","           } else {","               pos = posPrecCurr + offset * dirPrecCurr;","           }","       } else {","           float distPoints = min(distance(pmvPosition.xy, pmvPositionPrec.xy), distance(pmvPosition.xy, pmvPositionSuiv.xy)) + offset;","           float dist = offset/ sinAlpha;","           if (max(distPoints, offset) < abs(dist)){","               dist = max(distPoints - offset, offset)*sign(sinAlpha);","               if (sign(sinAlpha) == sign(sideExtrusion)&& asin(abs(sinAlpha)) < radians(45.0/2.0)){","                   if (mod(sideExtrusion,2.0) == 0.0){","                       pos = posCurrNext + dist * dirCurrNext*sign(sideExtrusion);","                   } else {","                       pos = posPrecCurr - dist * dirPrecCurr *sign(sideExtrusion);","                   }","               } else {","                   pos = pmvPosition.xy + dir * max(distPoints, offset) *sign(sinAlpha) *sign(sideExtrusion);","               }","           } else {","               pos = pmvPosition.xy + dir * dist *sign(sideExtrusion);","           }","       }","   } else if(bPrecCurr || bCurrNext) {","       pos = (posCurrNext - pmvPosition.xy)  + posPrecCurr;","   } else {","       pos = pmvPosition.xy + offset;","   }","   #ifdef USE_DASHEDLINE","       vPointAlt = pmvPosition.xy /pixelSize;","       if (sideExtrusion == -2.0){","           vVertexId = vec4(1.0, 1.0, 1.0, 0.0);","       } else if (sideExtrusion == 2.0){","           vVertexId = vec4(0.0, 1.0, 1.0, 1.0);","       } else if (sideExtrusion == -1.0){","           vVertexId = vec4(1.0, 0.0, 1.0, 1.0);","       } else if (sideExtrusion == 1.0){","           vVertexId = vec4(1.0, 1.0, 0.0, 1.0);","       }","       vec4 mvpPositionPrec = projectionMatrix * mvPositionPrec; ","       vec4 mvpPosition = projectionMatrix * mvPosition;","       vec4 mvpPositionSuiv = projectionMatrix * mvPositionSuiv;","       worldToPixel =  modelMatrix[0][0] * abs(projectionMatrix[0][0]/mvpPosition.w)*0.5/pixelSize.x;","       float worldToPixelPrec = modelMatrix[0][0] * abs(projectionMatrix[0][0]/mvpPositionPrec.w)*0.5/pixelSize.x;","       float worldToPixelSuiv = modelMatrix[0][0] * abs(projectionMatrix[0][0]/mvpPositionSuiv.w)*0.5/pixelSize.x;","       if (abs(sideExtrusion) == 1.0 && bPrecCurr){","           vLineDistanceAlt = vLineDistance.y;","           vPointPrec = (mvpPositionPrec.xy / mvpPositionPrec.w + 1.0) / pixelSize;","           vPointCurr = (mvpPosition.xy / mvpPosition.w + 1.0) / pixelSize;","           vLineDistance.x = scale * lineDistance.x * worldToPixelPrec;","           vLineDistance.y = scale * lineDistance.y * worldToPixel;","       } else if (abs(sideExtrusion) == 2.0 && bCurrNext) {","           vLineDistanceAlt = vLineDistance.x;","           vPointPrec = (mvpPosition.xy / mvpPosition.w  + 1.0)/ pixelSize;","           vPointCurr = (mvpPositionSuiv.xy / mvpPositionSuiv.w + 1.0)/ pixelSize;","           vLineDistance.x = scale * lineDistance.x * worldToPixel;","           vLineDistance.y = scale * lineDistance.y * worldToPixelSuiv;","       }","   #endif","","   gl_Position = vec4(pos.x, pos.y* pixelSize.y/pixelSize.x, pmvPosition.zw);","#endif"].join("\n"),o.line={attributes:{blending:t.NormalBlending,transparent:!0},uniforms:t.UniformsUtils.merge([t.UniformsLib.lines,{l_uInfoTexture:{type:"t",value:void 0},l_uUseOpacityFactor:{type:"f",value:0}}]),vertex_pars:[t.ShaderChunk.lines_pars_vertex,"uniform sampler2D l_uInfoTexture;","uniform float l_uUseOpacityFactor;","varying vec4 l_vColor;","varying float l_fHalfWidth;","varying float l_vOpacity;","varying float l_vOpacityFactor;","varying float v_index;","varying float v_nbLine;","varying float l_vPercent;","vec4 getColor(sampler2D texture, float nbColumn, float nbLines, float indice){","vec4 color = vec4(0,0,0,1);","color.r = texture2D( texture, vec2( 0.5/nbColumn, indice/nbLines ) ).x;","color.g = texture2D( texture, vec2( 1.5/nbColumn, indice/nbLines ) ).x;","color.b = texture2D( texture, vec2( 2.5/nbColumn, indice/nbLines ) ).x;","return color;","}"].join("\n"),vertex:[" float l_fpixPerRow = texture2D( l_uInfoTexture, vec2( 0.0, 0.0 ) ).x;"," float l_fnbLines = texture2D( l_uInfoTexture, vec2( 1.5/l_fpixPerRow, 0.0 ) ).x + 1.0;"," float l_fscale = texture2D( l_uInfoTexture, vec2( 2.5/l_fpixPerRow, 0.0 ) ).x;"," float l_findice = (color.r + 1.5);","v_index = l_findice;","v_nbLine = l_fnbLines;"," l_vColor = getColor(l_uInfoTexture, l_fpixPerRow, l_fnbLines, l_findice);"," l_fHalfWidth = texture2D( l_uInfoTexture, vec2( 3.5/l_fpixPerRow, l_findice/l_fnbLines) ).x / 2.0;"," l_vOpacity = texture2D( l_uInfoTexture, vec2( 4.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;"," l_vOpacityFactor = texture2D( l_uInfoTexture, vec2( 5.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;"," float minDist = texture2D( l_uInfoTexture, vec2( 15.5/l_fpixPerRow, l_findice/l_fnbLines) ).x;"," float maxDist = texture2D( l_uInfoTexture, vec2( 16.5/l_fpixPerRow, l_findice/l_fnbLines) ).x;"," float lineWidth = texture2D( l_uInfoTexture, vec2( 3.5/l_fpixPerRow, l_findice/l_fnbLines) ).x;"," float minWidth = texture2D( l_uInfoTexture, vec2( 17.5/l_fpixPerRow, l_findice/l_fnbLines) ).x;"," mvPosition = viewMatrix * (modelMatrix * vec4(position.xyz, 1.0));"," float dist = length(mvPosition);"," if ( dist < minDist ) { dist = minDist; }"," else if ( dist > maxDist ) { dist = maxDist; }"," float altitudeFactor = (1.0 - min(1.0, (dist - minDist) / (maxDist - minDist)));"," //l_fHalfWidth = floor(lineWidth * altitudeFactor + minWidth * (1.0-altitudeFactor)) / 2.0;",l.lines_vertex," l_vPercent = color.w;"].join("\n"),fragment_pars:[" uniform vec3 diffuse;"," uniform float l_uUseOpacityFactor;"," varying vec4 l_vColor;"," varying float l_vOpacity;"," varying float l_vOpacityFactor;","varying float v_index;","varying float v_nbLine;"," varying float l_vPercent;"].join("\n"),fragment:[t.ShaderChunk.lines_fragment," float l_fmatImgOpacity;"," if(l_uUseOpacityFactor > 0.5){","l_fmatImgOpacity = opacity * l_vOpacity * l_vOpacityFactor;"," }else{","l_fmatImgOpacity = opacity * l_vOpacity;"," }"," gl_FragColor.a = l_fmatImgOpacity;"," #ifdef GAMMA_INPUT","   gl_FragColor.rgb *= l_vColor.rgb * l_vColor.rgb;"," #else","   gl_FragColor.rgb = l_vColor.rgb;"," #endif"].join("\n")},o.clipPlanes={attributes:{},uniforms:t.UniformsLib.clipPlanes,vertex_pars:t.ShaderChunk.clip_pars_vertex,vertex:t.ShaderChunk.clip_vertex,fragment_pars:t.ShaderChunk.clip_pars_fragment,fragment:t.ShaderChunk.clip_fragment},o.alphaTest={attributes:{alphaTest:.5,transparent:!0},uniforms:{alphaTest:{type:"f",value:.5}},vertex_pars:"",vertex:"",fragment_pars:"",fragment:[t.ShaderChunk.alphatest_fragment,"gl_FragColor.a = (opacity);"].join("\n")},o.vertexInformation={uniforms:{},vertex_pars:["varying vec4 vertex_position;","varying vec4 vertex_wPosition;","varying vec4 vertex_vPosition;","varying vec4 vertex_normal;","varying vec4 vertex_wNormal;","varying vec4 vertex_vNormal;","varying vec4 vertex_viewdir;","varying vec4 vertex_vViewdir;","varying float vertex_camDist;"].join("\n"),vertex:["vertex_position = vec4(position, 1.0);","vertex_wPosition = modelMatrix * vertex_position;","vertex_vPosition = viewMatrix * vertex_wPosition;","vertex_normal = normalize(vec4(objectNormal, 0.0));","vertex_wNormal = normalize(modelMatrix * vertex_normal);","if (use_normal_matrix) {","vertex_vNormal = vec4(normalize(normalMatrix * vertex_normal.xyz), 0.0);","} else {","vertex_vNormal = normalize(viewMatrix * vertex_wNormal);","}","vertex_viewdir = vec4(cameraPosition - vertex_wPosition.xyz, 0.0);","vertex_vViewdir = -vertex_vPosition;","vertex_camDist = length(vertex_viewdir);"].join("\n"),fragment_pars:["varying vec4 vertex_position;","varying vec4 vertex_wPosition;","varying vec4 vertex_vPosition;","varying vec4 vertex_normal;","varying vec4 vertex_wNormal;","varying vec4 vertex_vNormal;","varying vec4 vertex_viewdir;","varying vec4 vertex_vViewdir;","varying float vertex_camDist;"].join("\n"),fragment:""},o.vertexColor={attributes:{vertexColors:!0},uniforms:{},vertex_pars:t.ShaderChunk.color_pars_vertex,vertex:t.ShaderChunk.color_vertex,fragment_pars:t.ShaderChunk.color_pars_fragment,fragment:t.ShaderChunk.color_fragment},o.map={attributes:{},uniforms:{map:{type:"t",value:o.whiteMap}},vertex_pars:t.ShaderChunk.map_pars_vertex,vertex:t.ShaderChunk.map_vertex,fragment_pars:t.ShaderChunk.map_pars_fragment,fragment:[t.ShaderChunk.uvmapping_fragment,t.ShaderChunk.map_fragment,"#define USE_UV_MAPS","vec2 maps_UVcoord = vec2(0.0);","#ifdef USE_MAP","maps_UVcoord = vUv;","#endif"].join("\n")},o.mapDebug={depends:[o.map],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = texelColor;","return;"].join("\n")},o.normalMap={attributes:{normalMap:o.whiteMap},uniforms:{normalMap:{type:"t",value:void 0},use_normalMap:{type:"i",value:0}},vertex_pars:"",vertex:"",fragment_pars:["uniform sampler2D normalMap;","uniform int use_normalMap;","vec3 value_normalMap;"].join("\n"),fragment:["#ifdef USE_UV_MAPS","#define USE_NORMAL_MAP","if( use_normalMap > 0 ) {","value_normalMap = normalize( texture2D( normalMap, maps_UVcoord ).rgb * 2.0 - 1.0 );","} else {","value_normalMap = vec3(0.0,0.0,0.0);","}","#endif"].join("\n")},o.normalMapDebug={depends:[o.normalMap],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = vec4(value_normalMap, 1.0);","return;"].join("\n")},o.specularMap={attributes:{specularMap:o.whiteMap},uniforms:{specularMap:{type:"t",value:void 0},use_specularMap:{type:"i",value:0}},vertex_pars:"",vertex:"",fragment_pars:["uniform sampler2D specularMap;","uniform int use_specularMap;","vec3 value_specularMap;"].join("\n"),fragment:["#ifdef USE_UV_MAPS","#define USE_SPECULAR_MAP","if( use_specularMap > 0 ) {","value_specularMap = texture2D( specularMap, maps_UVcoord ).rgb;","} else {","value_specularMap = specular;","}","#endif"].join("\n")},o.specularMapDebug={depends:[o.specularMap],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = vec4(value_specularMap, 1.0);","return;"].join("\n")},o.urbanLights={depends:[o.vertexInformation],attributes:{lights:!0},uniforms:t.UniformsUtils.merge([t.UniformsLib.lights,{shininess:{type:"f",value:2},specular:{type:"c",value:new t.Color(16777215)},ambient:{type:"c",value:new t.Color(16777215)}}]),vertex_pars:"",vertex:"",fragment_pars:[t.ShaderChunk.lights_lambert_pars_vertex,"uniform float shininess;","uniform vec3 specular;","vec3 diffuse_value = diffuse;","vec3 ambient_value = ambient;","float opacity_value = opacity;"].join("\n"),fragment:["vec3 tmp = vec3(0.0);","vec3 light_t = vec3(0.0);","vec3 light_b = vec3(0.0);","vec3 light_dir = vec3(0.0);","vec3 light_viewdir = vec3(0.0);","vec3 light_diffuse = vec3(0.0);","vec3 light_specular = vec3(0.0);","float light_shininess = shininess == 0.0 ? 1.0 : shininess;","vec3 light_normal_value = vertex_wNormal.xyz;","#ifdef USE_NORMAL_MAP","if( value_normalMap != vec3(0.0) ) {","light_normal_value = value_normalMap;","vec3 light_c1 = cross(vertex_wNormal.xyz, vec3(0.0, 0.0, 1.0));","vec3 light_c2 = cross(vertex_wNormal.xyz, vec3(0.0, 1.0, 0.0));","if( length(light_c1)>length(light_c2) )","light_t = normalize( light_c1 );","else","light_t = normalize( light_c2 );","light_b = normalize( cross(vertex_wNormal.xyz, light_t) );","}","#endif","vec3 light_specular_value = specular;","#ifdef USE_SPECULAR_MAP","light_specular_value = value_specularMap;","#endif","light_viewdir = normalize(vertex_viewdir.xyz);","#ifdef USE_NORMAL_MAP","if( value_normalMap != vec3(0.0) ) {","tmp.x = dot( vertex_viewdir.xyz, light_t );","tmp.y = dot( vertex_viewdir.xyz, light_b );","tmp.z = dot( vertex_viewdir.xyz, vertex_wNormal.xyz );","light_viewdir = normalize( tmp );","}","#endif","#if MAX_DIR_LIGHTS > 0","light_dir = normalize( directionalLightDirection[0] );","#ifdef USE_NORMAL_MAP","if( value_normalMap != vec3(0.0) ) {","tmp.x = dot( light_dir, light_t );","tmp.y = dot( light_dir, light_b );","tmp.z = dot( light_dir, vertex_wNormal.xyz );","light_dir = normalize( tmp );","}","#endif","light_diffuse += directionalLightColor[0] * diffuse_value * max( dot( light_dir, light_normal_value ), 0.0);","light_specular += directionalLightColor[0] * light_specular_value * pow( max( 0.0, dot( reflect(-light_dir, light_normal_value ), light_viewdir ) ), light_shininess );","vec3 totalDiffuse = vec3( dot( light_dir, light_normal_value ),0.0,0.0) ;","#endif","#if MAX_POINT_LIGHTS > 0","light_dir = normalize( pointLightPosition[ 0 ] - vertex_wPosition.xyz );","#ifdef USE_NORMAL_MAP","if( value_normalMap != vec3(0.0) ) {","tmp.x = dot( light_dir, light_t );","tmp.y = dot( light_dir, light_b );","tmp.z = dot( light_dir, vertex_wNormal.xyz );","light_dir = normalize( tmp );","}","#endif","light_diffuse += pointLightColor[0] * diffuse_value * max( dot( light_dir, light_normal_value ), 0.0);","light_specular += pointLightColor[0] * light_specular_value * pow( max(0.0, dot( reflect(-light_dir, light_normal_value ), light_viewdir ) ), light_shininess );","#endif","gl_FragColor.rgb = light_specular + gl_FragColor.rgb * clamp(ambientLightColor*ambient_value+light_diffuse, 0.0, 2.0);","gl_FragColor.a = opacity_value;"].join("\n")},o.urbanLightsDebugDiffuse={depends:[o.urbanLights],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = vec4(light_diffuse, 1.0);","return;"].join("\n")},o.urbanLightsDebugSpecular={depends:[o.urbanLights],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = vec4(light_specular, 1.0);","return;"].join("\n")},o.xCityLights={depends:[o.vertexInformation],attributes:{lights:!0},uniforms:t.UniformsUtils.merge([t.UniformsLib.lights,{shininess:{type:"f",value:30},specular:{type:"c",value:new t.Color(16777215)},emissive:{type:"c",value:new t.Color(0)},ambient:{type:"c",value:new t.Color(16777215)}}]),vertex_pars:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;",t.ShaderChunk.lights_phong_pars_vertex].join("\n"),vertex:["vNormal = vertex_vNormal.xyz;","vViewPosition = vertex_vViewdir.xyz;","worldPosition = vertex_wPosition;",t.ShaderChunk.lights_phong_vertex].join("\n"),fragment_pars:["uniform vec3 diffuse;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","float specularStrength = 1.0;",t.ShaderChunk.lights_phong_pars_fragment].join("\n"),fragment:["float shininessValue = shininess;",t.ShaderChunk.lights_phong_fragment].join("\n")},o.xCityEnvMap={depends:[o.xCityLights],attributes:{envMap:!0},uniforms:{},vertex_pars:t.ShaderChunk.envmap_pars_vertex,vertex:[t.ShaderChunk.envmap_vertex,"#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP ) && ! defined( PHYSICALDS )","#ifdef DOUBLE_SIDED","vReflect = vertex_wPosition.xyz;","#endif","#endif"].join("\n"),fragment_pars:t.ShaderChunk.envmap_pars_fragment,fragment:["vec3 vWorldPosition = vertex_wPosition.xyz;","#ifdef USE_ENVMAP","vec3 reflectVec;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","vec3 worldNormal = normalize( vec3( vec4( normal, 0.0 ) * viewMatrix ) );","if ( useRefract ) {","#if defined( USE_REFRACTIONRATIOMAP )","reflectVec = refract( cameraToVertex, worldNormal, texture2D(refractionRatioMap, uvToUse).r );","#else","reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );","#endif","} else { ","reflectVec = reflect( cameraToVertex, worldNormal );","}","#else","reflectVec = vReflect;","#endif","reflectVec = vec3(-reflectVec.x, reflectVec.zy);","vec3 flipReflectVec;","#ifdef DOUBLE_SIDED","float flipNormal = 1.0;","flipReflectVec = flipNormal * reflectVec;","#else","flipReflectVec = reflectVec;","#endif","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_LIGHTPROBEMAP","flipReflectVec = vec3(flipReflectVec.y, flipReflectVec.z, flipReflectVec.x);","float probeR = INV_PI * acos( flipReflectVec.z ) / length(flipReflectVec.xy);","#ifdef USE_ENVMAP_HDR","vec2 texelSizeEnvMap = vec2(1.0 / envMapHDRSize);","vec4 cubeColor = texture2DBilinearFromRGBE( envMap, 0.5 * (probeR * flipReflectVec.xy + 1.0), envMapHDRSize, texelSizeEnvMap );","#else","vec4 cubeColor = texture2D( envMap, 0.5 * (probeR * flipReflectVec.xy + 1.0) );","#endif","#else","float phi = atan(flipReflectVec.y, flipReflectVec.x) + offsetPhi;","float theta = acos(flipReflectVec.z);","#ifdef USE_ENVMAP_HDR","vec2 texelSizeEnvMap = vec2(1.0 / envMapHDRSize);","vec4 cubeColor = envMapExposure * texture2DBilinearFromRGBE( envMap, vec2(0.5 + 0.5 * INV_PI * phi, 1.0 - INV_PI * theta), envMapHDRSize, texelSizeEnvMap );","#else","vec4 cubeColor = envMapExposure * texture2D( envMap, vec2(0.5 + 0.5 * INV_PI * phi, 1.0 - INV_PI * theta) );","#endif","#endif","#else","vec4 cubeColor = textureCube( envMap, flipReflectVec );","#endif","if ( combine == 1 ) {","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );","} else if ( combine == 2 ) {","gl_FragColor.xyz += cubeColor.xyz * specularStrength * reflectivity;","} else {","gl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );","}","#endif"].join("\n")},o.shadowMapCustom={depends:[],attributes:{},uniforms:t.UniformsLib.shadowmap,vertex_pars:t.ShaderChunk.shadowmap_pars_vertex,vertex:["#ifdef USE_SHADOWMAP","#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined( PHYSICALDS ) || defined ( USE_SHADOWMAP )","#ifdef USE_SKINNING","vec4 oldPosition = skinned;","#endif","#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 oldPosition = vec4( morphed, 1.0 );","#endif","#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 oldPosition = vec4( position, 1.0 );","#endif","#endif","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[i]*oldPosition;// + 5.5*vec4(normal,1.0));","}","#endif"].join("\n"),fragment_pars:t.ShaderChunk.shadowmap_pars_fragment,fragment:["#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_DEBUG","vec3 frustumColors[3];","frustumColors[0] = vec3( 1.0, 0.5, 0.0 );","frustumColors[1] = vec3( 0.0, 1.0, 0.8 );","frustumColors[2] = vec3( 0.0, 0.5, 1.0 );","#endif","#ifdef SHADOWMAP_CASCADE","int inFrustumCount = 0;","#endif","float fDepth;","vec3 shadowColor = vec3( 1.0 );","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vec3 shadowCoord = vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );","#ifdef SHADOWMAP_CASCADE","bvec2 inFrustumAndZVec = bvec2(inFrustum, shadowCoord.z <= 1.0);","bool inFrustumAndZ = all(inFrustumAndZVec);","inFrustumCount += int( inFrustumAndZ );","bvec2 frustumTestVec = bvec2( inFrustumAndZ, inFrustumCount == 1 );","#else","bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","#endif","bool frustumTest = all( frustumTestVec );","if ( frustumTest ) {","shadowCoord.z += shadowBias[ i ];","float dv = 1.0;","#if MAX_DIR_LIGHTS > 0","#ifdef PHONG","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ 0 ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","dv =  abs(dot(  dirVector, normal ));","#else","dv = abs(totalDiffuse.x);","#endif","#endif","#if defined( SHADOWMAP_TYPE_PCF )","float shadow = 0.0;","const float shadowDelta = 1.0 / 9.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.25 * xPixelOffset;","float dy0 = -1.25 * yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","float shadow = 0.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.0 * xPixelOffset;","float dy0 = -1.0 * yPixelOffset;","float dx1 = 1.0 * xPixelOffset;","float dy1 = 1.0 * yPixelOffset;","mat3 shadowKernel;","mat3 depthKernel;","depthKernel[0][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","if ( depthKernel[0][0] < shadowCoord.z ) shadowKernel[0][0] = 0.25;","else shadowKernel[0][0] = 0.0;","depthKernel[0][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","if ( depthKernel[0][1] < shadowCoord.z ) shadowKernel[0][1] = 0.25;","else shadowKernel[0][1] = 0.0;","depthKernel[0][2] = unpackDepth( texture2D( shadowMap[ i], shadowCoord.xy + vec2( dx0, dy1 ) ) );","if ( depthKernel[0][2] < shadowCoord.z ) shadowKernel[0][2] = 0.25;","else shadowKernel[0][2] = 0.0;","depthKernel[1][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","if ( depthKernel[1][0] < shadowCoord.z ) shadowKernel[1][0] = 0.25;","else shadowKernel[1][0] = 0.0;","depthKernel[1][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","if ( depthKernel[1][1] < shadowCoord.z ) shadowKernel[1][1] = 0.25;","else shadowKernel[1][1] = 0.0;","depthKernel[1][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","if ( depthKernel[1][2] < shadowCoord.z ) shadowKernel[1][2] = 0.25;","else shadowKernel[1][2] = 0.0;","depthKernel[2][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","if ( depthKernel[2][0] < shadowCoord.z ) shadowKernel[2][0] = 0.25;","else shadowKernel[2][0] = 0.0;","depthKernel[2][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","if ( depthKernel[2][1] < shadowCoord.z ) shadowKernel[2][1] = 0.25;","else shadowKernel[2][1] = 0.0;","depthKernel[2][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","if ( depthKernel[2][2] < shadowCoord.z ) shadowKernel[2][2] = 0.25;","else shadowKernel[2][2] = 0.0;","vec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * shadowMapSize[i].xy );","shadowKernel[0] = mix( shadowKernel[1], shadowKernel[0], fractionalCoord.x );","shadowKernel[1] = mix( shadowKernel[2], shadowKernel[1], fractionalCoord.x );","vec4 shadowValues;","shadowValues.x = mix( shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y );","shadowValues.y = mix( shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y );","shadowValues.z = mix( shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y );","shadowValues.w = mix( shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y );","shadow = dot( shadowValues, vec4( 1.0 ) );","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#else","vec4 rgbaDepth = texture2D( shadowMap[ i ], shadowCoord.xy );","float fDepth = unpackDepth( rgbaDepth );","if (  directionalLightDirection[ 0 ].z < 0.0 || dv < 0.1 || fDepth < shadowCoord.z )","   shadowColor =  vec3( 1.0 -  shadowDarkness[ i ]);","#endif","}","#ifdef SHADOWMAP_DEBUG","#ifdef SHADOWMAP_CASCADE","if ( frustumTest ) gl_FragColor.xyz *= frustumColors[ i ];","#else","if ( inFrustum ) gl_FragColor.xyz *= frustumColors[ i ];","#endif","#endif","}","#ifdef GAMMA_OUTPUT","shadowColor = sqrt( shadowColor );","#endif","#if !defined(IGNORE_SHADOW_COEFF)","gl_FragColor.xyz = gl_FragColor.xyz * shadowColor;","#endif","#endif"].join("\n")},o.shadowMap={attributes:{},uniforms:t.UniformsLib.shadowmap,vertex_pars:t.ShaderChunk.shadowmap_pars_vertex,vertex:t.ShaderChunk.shadowmap_vertex,fragment_pars:t.ShaderChunk.shadowmap_pars_fragment,fragment:t.ShaderChunk.shadowmap_fragment},o.shadowMapDebug={depends:[o.shadowMapCustom],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = vec4( shadowColor, 1.0 );","return;"].join("\n")},o.tileMapping={depends:[o.vertexInformation,o.map],attributes:{},uniforms:{bbox_min:{type:"v2",value:new t.Vector2(0,0)},bbox_max:{type:"v2",value:new t.Vector2(0,0)}},vertex_pars:["uniform vec2 bbox_min;","uniform vec2 bbox_max;"].join("\n"),vertex:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ROUGHNESSMAP )","   float u = clamp((vertex_wPosition.x - bbox_min.x)/(bbox_max.x - bbox_min.x),0.0,1.0);","   float v = clamp((vertex_wPosition.y - bbox_min.y)/(bbox_max.y - bbox_min.y),0.0,1.0);","   vUv = vec2(u, v);","#endif"].join("\n"),fragment_pars:"",fragment:""},o.atlas_PDSFX={name:"atlas_PDSFX",attributes:{},uniforms:{mapCity:{type:"t2",value:o.whiteMap}},varyings:{vertexPos_world:{type:"v2"},vertexColorR:{type:"f"},vertexColorG:{type:"f"},vertexColorB:{type:"f"}},VS_overridableFunctions:{ComputeObjectTexCoord0:["return vGetAttribTexCoord0();"].join("\n"),_ComputeObjectTexCoord1:["vec4 tCoord1 = vec4(vertexPos_world.x, vertexPos_world.y, 0.0, 0.0);","return tCoord1;"].join("\n"),ComputeVaryingValues:["vertexPos_world = vec3(modelMatrix * vec4(ComputeObjectPosition(), 1.0)).xy;","vertexColorR = vGetAttribColor().r;","vertexColorG = vGetAttribColor().g;","vertexColorB = vGetAttribColor().b;"].join("\n")},FS_global_code:["vec4 _texelCity;","#define CITY_HACK_VERTEXCOLOR 1","float atlas_size = 2048.0;","float atlas_borderSize = 5.0;","vec2 atlas_getStartOffset(float posX, float posY) {","return vec2(posX + (atlas_borderSize / atlas_size), posY + (atlas_borderSize / atlas_size));","}","float atlas_getSizeInAtlas(float size) {","return (size - (2.0 * (atlas_borderSize / atlas_size)));","}"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["vec3 vertexColor = vec3(vertexColorR, vertexColorG, vertexColorB);","vec3 hdRoad_color = vec3(0.0);","#if defined (ATLAS_ROAD)","hdRoad_color = atlas_road(hdRoad_color, vertexColor);","#endif","#if defined (ATLAS_ROAD_MARKING)","hdRoad_color = atlas_road_marking(hdRoad_color, vertexColor);","#endif","#if defined (ATLAS_LAWN)","hdRoad_color = atlas_lawn(hdRoad_color, vertexColor);","#endif","#if defined (ATLAS_FOOTPATH)","hdRoad_color = atlas_footpath(hdRoad_color, vertexColor);","#endif","#if defined (ATLAS_SIDEWALKEDGES)","hdRoad_color = atlas_sidewalkedges(hdRoad_color, vertexColor);","#endif","_texelCity = vec4(hdRoad_color, 1.0);",""].join("\n"),ComputeAlbedo:["return sqrt(_texelCity.xyz);","return _DSalbedo_ / vec3(vertexColorR, vertexColorG, vertexColorB);"].join("\n"),__ComputeRoughness:["return 1.0;"].join("\n"),__ProcessFinalColor:["ioFinalColor.xyz = ComputeAlbedo();"].join("\n")}},o.atlas_RoadArea_PDSFX={name:"atlas_RoadArea_PDSFX",depends:[o.atlas_PDSFX],FS_global_code:["#define ATLAS_ROAD","vec3 atlas_road(vec3 color, vec3 vertexColor) {","float ra_colorDiff = length(vertexColor.rgb - vec3(0.0, 0.0, 1.0));","vec3 ra_color = color;","if (abs(ra_colorDiff) < 0.1) {","vec2 ra_startOffset = atlas_getStartOffset(0.5, 0.5);","float ra_texSize = atlas_getSizeInAtlas(0.5);","vec4 ra_noiseColor = texture2D(mapCity, mod(vertexPos_world.xy * ra_texSize * 0.05, ra_texSize) + ra_startOffset);","float ra_noise = clamp((mix(-40.0, 40.0, ra_noiseColor.r) + length(vGetViewPosition()) - 20.0) / 40.0, 0.0, 1.0);","ra_startOffset = atlas_getStartOffset(0.0, 0.25);","ra_texSize = atlas_getSizeInAtlas(0.25);","vec4 ra_mixteColor005 = texture2D(mapCity, mod(vertexPos_world.xy * ra_texSize * 0.05, ra_texSize) + ra_startOffset);","vec4 ra_mixteColor025 = texture2D(mapCity, mod(vertexPos_world.xy * ra_texSize * 0.25, ra_texSize) + ra_startOffset);","vec4 ra_mixteColor050 = texture2D(mapCity, mod(vertexPos_world.xy * ra_texSize * 0.50, ra_texSize) + ra_startOffset);","vec4 ra_mixteColor200 = texture2D(mapCity, mod(vertexPos_world.xy * ra_texSize * 2.00, ra_texSize) + ra_startOffset);","float ra_mul = pow(pow(ra_mixteColor025.r * ra_mixteColor050.r, 0.5) * ra_mixteColor005.g, 0.5);","vec3 ra_mix1 = mix(vec3(0.07), vec3(0.4), ra_mul);","vec3 ra_mix2 = mix(vec3(0.07), vec3(0.4), ra_mul * ra_mixteColor200.b);","ra_color = mix(ra_mix2, ra_mix1, ra_noise);","//ra_color = vec3(0.0,0.0,1.0);","}","return ra_color;","}"].join("\n")},o.atlas_RoadMarking_PDSFX={name:"atlas_RoadMarking_PDSFX",depends:[o.atlas_PDSFX],FS_global_code:["#define ATLAS_ROAD_MARKING","vec3 atlas_road_marking(vec3 color, vec3 vertexColor) {","float rm_colorDiff1 = length(vertexColor.rgb - vec3(1.0, 0.0, 0.0));","float rm_colorDiff2 = length(vertexColor.rgb - vec3(0.0, 1.0, 0.0));","vec3 rm_color = color;","if ((abs(rm_colorDiff1) < 0.1) || (abs(rm_colorDiff2) < 0.1)) {","if (abs(rm_colorDiff1) < 0.1) {","rm_color = vec3(0.9);","} else if (abs(rm_colorDiff2) < 0.1) {","rm_color = vec3(0.985, 0.673, 0.136);","}","vec2 rm_startOffset = atlas_getStartOffset(0.25, 0.25);","float rm_texSize = atlas_getSizeInAtlas(0.25);","rm_color *= texture2D(mapCity, mod(vertexPos_world.xy * rm_texSize * 0.50, rm_texSize) + rm_startOffset).rgb;","rm_color *= texture2D(mapCity, mod(vertexPos_world.xy * rm_texSize * 0.25, rm_texSize) + rm_startOffset).rgb;","//rm_color = vec3(1.0,0.0,0.0);","}","return rm_color;","}"].join("\n")},o.atlas_LawnArea_PDSFX={name:"atlas_LawnArea_PDSFX",depends:[o.atlas_PDSFX],FS_global_code:["#define ATLAS_LAWN","vec3 atlas_lawn(vec3 color, vec3 vertexColor) {","vec3 lawn_color = color;","float la_colorDiff = length(vertexColor.rgb - vec3(1.0, 1.0, 0.0));","if (abs(la_colorDiff) < 0.1) {","vec2 la_startOffset = atlas_getStartOffset(0.5, 0.5);","float la_texSize = atlas_getSizeInAtlas(0.5);","vec4 la_noiseColor = texture2D(mapCity, mod(vertexPos_world.xy * la_texSize * 0.05, la_texSize) + la_startOffset);","float la_noise = clamp((mix(-40.0, 40.0, la_noiseColor.r) + length(vGetViewPosition()) - 20.0) / 40.0, 0.0, 1.0);","la_startOffset = atlas_getStartOffset(0.0, 0.0);","la_texSize = atlas_getSizeInAtlas(0.25);","vec4 la_herb_Color_g = texture2D(mapCity, mod(vertexPos_world.xy * la_texSize * 0.25, la_texSize) + la_startOffset);","vec4 la_herb_Color = texture2D(mapCity, mod(vertexPos_world.xy * la_texSize * 0.05, la_texSize) + la_startOffset);","#ifdef GAMMA_INPUT","la_herb_Color_g *= la_herb_Color_g;","la_herb_Color *= la_herb_Color;","#endif","la_startOffset = atlas_getStartOffset(0.0, 0.5);","la_texSize = atlas_getSizeInAtlas(0.5);","float la_varColor1 = texture2D(mapCity, mod(vertexPos_world.xy * la_texSize * 0.003, la_texSize) + la_startOffset).r;","float la_varColor2 = texture2D(mapCity, mod(vertexPos_world.xy * la_texSize * 0.0025, la_texSize) + la_startOffset).r;","#ifdef GAMMA_INPUT","la_varColor1 *= la_varColor1;","la_varColor2 *= la_varColor2;","#endif","vec4 la_mul_Dead = vec4(0.9, 0.7, 0.3, 1) * la_herb_Color_g.g;","vec4 la_mul_Base = vec4(0.4, 0.45, 0.25, 3) * la_herb_Color_g;","vec4 la_mixColor = mix(la_herb_Color, vec4(0.02, 0.04, 0.01,1), 0.7);","vec4 la_mix1 = mix(la_mul_Dead, la_mul_Base, clamp(mix(0.25, 2.0, la_varColor1), 0.0, 1.0));","vec4 la_mix2 = mix(la_mix1, la_mixColor, la_varColor2);","lawn_color = mix(la_mix1, la_mix2, la_noise).xyz;","//lawn_color = vec3(0.0,1.0,0.0);","}","return lawn_color;","}"].join("\n")},o.atlas_FootPaths_PDSFX={name:"atlas_FootPaths_PDSFX",depends:[o.atlas_PDSFX],FS_global_code:["#define ATLAS_FOOTPATH","vec3 atlas_footpath(vec3 color, vec3 vertexColor) {","float fp_colorDiff = length(vertexColor.rgb - vec3(1.0, 0.0, 1.0));","vec3 fp_color = color;","if (abs(fp_colorDiff) < 0.1) {","float marge = 66.0/2048.0;","vec2 fp_startOffset = atlas_getStartOffset(0.5+marge, 0.0+marge);","float fp_texSize = atlas_getSizeInAtlas(0.25-(marge*2.0));","vec3 fp_texColor1 = texture2D(mapCity, mod(vertexPos_world.xy * fp_texSize, fp_texSize) + fp_startOffset).rgb;","vec3 fp_texColor2 = texture2D(mapCity, mod(vertexPos_world.xy * fp_texSize * 0.5, fp_texSize) + fp_startOffset).rgb;","#ifdef GAMMA_INPUT","fp_texColor1 *= fp_texColor1;","fp_texColor2 *= fp_texColor2;","#endif","float fp_varColor1 = texture2D(mapCity, mod(vertexPos_world.xy * fp_texSize * 0.8, fp_texSize)+ fp_startOffset).w;","fp_startOffset = atlas_getStartOffset(0.0, 0.5);","fp_texSize = atlas_getSizeInAtlas(0.5);","float fp_varColor2 = texture2D(mapCity, mod(vertexPos_world.xy * fp_texSize * 0.015, fp_texSize) + fp_startOffset).r;","fp_color = mix(4.0, 4.0, fp_varColor1) * mix(0.9, 1.3, fp_varColor2) * fp_texColor1 * fp_texColor2;","//fp_color = vec3(1.0,0.0,1.0);","}","return fp_color;","}"].join("\n")},o.atlas_SideWalkEdges_PDSFX={name:"atlas_SideWalkEdges_PDSFX",depends:[o.atlas_PDSFX],FS_global_code:["#define ATLAS_SIDEWALKEDGES","vec3 atlas_sidewalkedges(vec3 color, vec3 vertexColor) {","float swe_colorDiff = length(vertexColor.rgb - vec3(1.0, 1.0, 1.0));","vec3 swe_color = color;","if (abs(swe_colorDiff) < 0.1) {","vec2 swe_startOffset = atlas_getStartOffset(0.5, 0.375);","vec2 swe_texSize = vec2(atlas_getSizeInAtlas(0.5), atlas_getSizeInAtlas(0.125));","swe_color = texture2D(mapCity, mod((vGetTexCoord0().xy * swe_texSize) / vec2(2.0, 1.0), swe_texSize) + swe_startOffset).rgb;","#ifdef GAMMA_INPUT","swe_color *= swe_color;","#endif","}","return swe_color;","}"].join("\n")},o.chunkOcean_PDSFX={name:"chunkOcean_PDSFX",nbTexture:1,uniforms:{mapCity:{type:"t2",value:o.whiteMap},oceanTexture:{type:"t2",value:o.whiteMap},oceanColor:{type:"c",value:new t.Color("rgb(47,64,140)")},landcoverTimer:{type:"f",value:0,animation:function(e){return e.animatedTime}},showOcean:{type:"b",value:!0},specularOcean:{type:"c",value:new t.Color("rgb(255,255,255)")}},varyings:{vertexPos_world:{type:"v3",length:1}},FS_global_code:["#ifndef TERRAIN_SHADER","#define TERRAIN_SHADER","bool computeWaves = true && showOcean;","#endif","// generate a layer of waves","float OceanPI = 3.14;","vec3 generateWavesFromNoises(sampler2D wt, vec2 texCoords, float time, float s, float bs)","{","float sinAngle, cosAngle;","const int nbDirections = 5;","float spread = OceanPI*2.0*s;","vec3 currentLayer = vec3(0.0,0.0,0.0);","float uNormalize = 0.50;","float uBumpStrength = bs; ","for (int i=0; i<nbDirections; i++)","{","float angle = spread * float(i)/float(nbDirections);","cosAngle = cos(angle); ","sinAngle = sin(angle);","vec2 diri =  vec2( cosAngle, sinAngle ); ","vec2 UV = texCoords + time * diri ;","vec3 normal = texture2D(wt, UV).rgb;","vec3 clt = 2.0*(normal - vec3(uNormalize, uNormalize, 0.0));","clt.xy *= uBumpStrength;","currentLayer += normalize(clt); ","}","currentLayer /= float(nbDirections);","return currentLayer.xyz;","}","// combine wave layers","vec3 combineWaves(vec3 worldPos)","{","vec2 uvWater =  5.0*0.001*worldPos.xy;","float waterSpeed = 0.01*landcoverTimer;","vec3 pwave1  =  generateWavesFromNoises(oceanTexture, 0.4*uvWater,  0.5*waterSpeed, 0.6, 1.0);","vec3 cameraToVertex = normalize( worldPos - cameraPosition );","vec3 rwave1 = reflect( cameraToVertex, pwave1 );","if (rwave1.z < 0.0) { pwave1 = vec3(0.0,0.0,1.0); };","vec3 pwave2  = generateWavesFromNoises(oceanTexture, 3.0*uvWater, 0.6*waterSpeed, 0.7, 1.5);","vec3 rwave2 = reflect( cameraToVertex, pwave2 );","if (rwave2.z < 0.0) { pwave2 = vec3(0.0,0.0,1.0); };","vec3 pwave3  = generateWavesFromNoises(oceanTexture, 10.0*uvWater, 0.7*waterSpeed, 1.0, 3.0);","vec3 rwave3 = reflect( cameraToVertex, pwave3 );","if (rwave3.z < 0.0) { pwave3 = vec3(0.0,0.0,1.0); };","vec3 pwave =  normalize((pwave1 + pwave2 + pwave3));","vec3 ppwave =  normalize((pwave1));","return pwave;","}"].join("\n"),VS_overridableFunctions:{ComputeVaryingValues:["vec3 vertexPos_worldXYZ = vec3(modelMatrix * vec4(ComputeObjectPosition(), 1.0));","vertexPos_world = vertexPos_worldXYZ.xyz;"].join("\n"),ComputeObjectNormal:["return vec3(0.0,0.0,1.0);"].join("\n")},FS_overridableFunctions:{ComputeCommonValues:["if (computeWaves) {","}",""].join("\n"),ComputeAlbedo:["if (computeWaves) {","return oceanColor;","}","cAlbedo = oceanColor;",""].join("\n"),ComputeViewNormal:["if (computeWaves) {","float coefDist = clamp(length(vGetViewPosition())/50000.0,0.0,1.0);","vec3 combiwaves = combineWaves(vertexPos_world);","vec3 waveNormal = coefDist * vec3(0.0,0.0,1.0) + (1.0-coefDist) * combiwaves; ","vec3 vNormal = vec3(vGetViewMatrix() * vec4(normalize(waveNormal), 0.0));","return vNormal;","}","else {","return vGetViewNormal();","}"].join("\n"),ComputeSpecularReflectance:["if (computeWaves) {","return specularOcean*0.02777777;","}","else {","return vec3(0.02777777,0.02777777,0.02777777);","}"].join("\n"),ComputeRoughness:["if (computeWaves) {","return 0.1;","}","else {","return 1.0;","}"].join("\n"),_ProcessFinalColor:["ioFinalColor.rgb = ComputeViewNormal().xyz;"].join("\n")}},o.chunkLandcover_unvisibleSource_PDSFX={name:"chunkLandcover_unvisibleSource_PDSFX",nbTexture:1,depends:[],attributes:{},vertex_attributes:{},uniforms:{landcover:{type:"t2",value:void 0},landcoverOffset:{type:"v4",value:new t.Vector4(0,0,1,1)},oceanRangeDetection:{type:"f",value:.1},oceanColorDetection:{type:"c",value:new t.Color("rgb(0,0,255)")}},varyings:{uvslandcover:{type:"v2",length:1}},VS_overridableFunctions:{ComputeCommonValues:["if (uv != vec2(-1.0) ) {","uvslandcover = ComputeObjectTexCoord0_Cropped().xy * landcoverOffset.z + landcoverOffset.xy;","} else {","uvslandcover = vec2(-1.0);","}"].join("\n")},FS_overridableFunctions:{ComputeCommonValues:["vec4 _landcover;","if (uvslandcover != vec2(-1.0)) {","_landcover = texture2D(landcover, uvslandcover);","} else {","_landcover = vec4(0.0);","}","computeWaves = (length(_landcover.rgb - oceanColorDetection) < oceanRangeDetection);"].join("\n")}},o.chunkLandcover_visibleSource_PDSFX={name:"chunkLandcover_visibleSource_PDSFX",nbTexture:0,depends:[],attributes:{},vertex_attributes:{},uniforms:{landcoverIndex:{type:"f",value:-1},oceanRangeDetection:{type:"f",value:.1},oceanColorDetection:{type:"c",value:new t.Color("rgb(0,0,255)")}},varyings:{},VS_overridableFunctions:{ComputeCommonValues:[].join("\n")},FS_global_code:["vec4 _landcover;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["","#ifdef MULTIPLE_RASTER_TERRAIN","#if MULTIPLE_RASTER_TERRAIN >= 2","if (landcoverIndex > -0.5 && landcoverIndex < 0.5) {","_landcover = texture2D(raster[0], uvsraster[0]);","}","else if (landcoverIndex > 0.5 && landcoverIndex < 1.5) {","_landcover = texture2D(raster[1], uvsraster[1]);","}","#endif","#if MULTIPLE_RASTER_TERRAIN >= 3","else if (landcoverIndex > 1.5 && landcoverIndex < 2.5) {","_landcover = texture2D(raster[2], uvsraster[2]);","}","#endif","#if MULTIPLE_RASTER_TERRAIN >= 4","else if (landcoverIndex > 2.5 && landcoverIndex < 3.5) {","_landcover = texture2D(raster[3], uvsraster[3]);","}","#endif","#else","_landcover = texture2D(raster, uvsraster);","#endif","computeWaves = (length(_landcover.rgb - oceanColorDetection) < oceanRangeDetection);","//computeWaves = true;"].join("\n"),_ProcessFinalColor:["ioFinalColor = _landcover;"].join("\n")}},o}),define("DS/XCityEffects/AtmosphereEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/XCityEffects/AtmosphereShader","DS/Plugins/ClearPass","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/XCityTools/ShaderTools"],function(e,t,i,r,s,n,a,o,l,h){"use strict";return t.extend({init:function(t,o,l,h){this._parent(t.renderer);this.urban=h,this._vse=this.urban.getView3D(),this.renderer=t,this.__renderer=t.renderer,this.renderTargetPool=o,this.rootNode=l,this.passesNoScene=[];var d=new e.WebGLRenderTargetProperties(this.width,this.height,"nearest"),u=new i(this.__renderer,d,this.renderTargetPool);u.name="depthCurrentEffectComposer",u.composerContext.keepResult=!0,this.composers.push(u);var c=new a("depthCurrentCameraClearPass"),p=new r(null,null,null,void 0,void 0,void 0,"depthCurrentCameraRenderPass");return p.setDisableBackFaceCulling(!0),p.setMaterialToUse(e.MaterialToUse.normalDepthMaterial),p.cameraName="main",this.passesNoScene.push(p),this.composers[0].addPass(c),this.composers[0].addPass(p),this.composers[0].composerContext.setPassClear(c,!0,new e.Color(0),0),this.composers[0].enablePass(c,!0),this.composers[0].enablePass(p,!0),this.mixPass=new s(n.FinalBlending,void 0,"AtmoEffectCustom"),this.mixPass.compileShader(this.__renderer),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tNormalDepth),this.mixPass.addRequiredComposer(this.composers[0]),this.enableEffect(),t&&t.normalComposerContext&&t.normalComposerContext.enablePass(this.mixPass,!1),t&&t.pickingGPUComposerContext&&t.pickingGPUComposerContext.enablePass(this.mixPass,!1),t&&t.depthComposerContext&&t.depthComposerContext.enablePass(this.mixPass,!1),this.compNormalDepth&&this.compNormalDepth.enablePass(this.mixPass,!1),this.passUniforms(),this},disableEffect:function(){this.enabled&&(this.enabled=!1,this.renderer.mainComposer.removeCustomPassNEW([this.mixPass]))},enableEffect:function(){this.enabled||(this.enabled=!0,this.renderer.mainComposer.insertCustomPassBeforeNEW(this.mixPass,"postEffects1"),this.renderer.compForwardComposerContext.enablePass(this.mixPass,!0))},initEffect:function(e,t){e&&(this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0),this.insertComposerCustom(t,this.composers[0],this.mixPass,!0),this.renderer.initComposer("PickingGPUInstancing")},insertComposerCustom:function(t,i,r,s){e.mobileVersion||(null!==i&&t.composers.push(i),s&&(r.disabledByDefault=!0),t.mainComposer.insertCustomPassBeforeNEW(r,"postEffects1"),this.mixPass.composer=t.mainComposer,t.compForwardComposerContext.enablePass(r,!0),t.updateFinalComposer(!0))},update:function(e,t,i,r){for(this.composers[0].composerContext.needsUpdate=!0;this.passesNoScene.length>0;)this.passesNoScene.pop().setScene(t.scene);i.camera.projectionMatrixInverse.getInverse(i.camera.projectionMatrix),i.camera.matrixWorldInverse.getInverse(i.camera.matrixWorld),this.mixPass.uniforms.realProjectionMatrixInverse.value=i.camera.projectionMatrixInverse,this.mixPass.uniforms.realViewMatrix.value=i.camera.matrixWorld,this.mixPass.uniforms.camPos.value=this._vse.viewpoint.camera.position,this.mixPass.uniforms.sunPos.value=this.urban.environment.sun.sunPos,this.passUniforms()},setSize:function(e,t,i,r){if(this._parent(e,t)||i)for(var s=0;s<this.composers.length;++s)this.composers[s].setSize(this.width,this.height)},getMaxIteration:function(){return 0},totalMie:function(t,i){var r=new e.Vector3(183999185144339.78,277980239196605.28,407904795438610.94),s=.2*t*1e-17;return new e.Vector3(.434*r.x*s*i,.434*r.y*s*i,.434*r.z*s*i)},totalRayleigh:function(t){var i=new e.Vector3(5804542996261093e-21,13562911419845635e-21,30265902468824876e-21);return new e.Vector3(t*i.x,t*i.y,t*i.z)},smoothstep:function(e,t,i){var r=this.clamp((i-e)/(t-e),0,1);return r*r*(3-2*r)},clamp:function(e,t,i){return Math.min(Math.max(e,t),i)},sunClamp:function(e){return Math.max(.6,Math.min(.7,1-e))},passUniforms:function(){this.skyParams=this.urban.environment.skyParams;var e=this.smoothstep(0,.1,this.skyParams.mieCoefficient);this.mixPass.uniforms.turbidity.value=this.skyParams.turbidity,this.mixPass.uniforms.rayleigh.value=this.skyParams.reileigh,this.mixPass.uniforms.mieCoefficient.value=this.skyParams.mieCoefficient,this.mixPass.uniforms.mieDirectionalG.value=this.skyParams.mieDirectionalG,this.mixPass.uniforms.density.value=this.skyParams.density,this.mixPass.uniforms.showroom.value=this.urban.environment.showroom,this.mixPass.uniforms.totalMie.value=this.totalMie(this.skyParams.turbidity,this.skyParams.mieCoefficient),this.mixPass.uniforms.totalRayleigh.value=this.totalRayleigh(this.skyParams.reileigh),this.mixPass.uniforms.mieCoefficientS.value=e,this.mixPass.uniforms.sunEClamp.value=this.sunClamp(e)}})}),define("DS/XCityEffects/AltitudeEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/XCityEffects/AltitudeShader","DS/Plugins/ClearPass","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/XCityTools/ShaderTools","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s,n,a,o,l,h,d,u){"use strict";return t.extend({init:function(t,o,l,h){this._parent(t.renderer);this.urban=l,this.renderer=t,this.__renderer=t.renderer,this.renderTargetPool=o,this.depthRenderPasses=[],this.availableViewshedComposer=[],this.near=.1,this.far=1e3,this.aspect=2,this.fov=1,this.bias=1e-5,this.passesNoScene=[],this.currentCompareDepthsPass=void 0;var d=new e.WebGLRenderTargetProperties(this.width,this.height,"nearest"),u=new i(this.__renderer,d,o);u.name="depthCurrentEffectComposer",u.composerContext.keepResult=!0,this.composers.push(u);var c=new a("depthCurrentCameraClearPass"),p=new r(null,null,null,void 0,void 0,void 0,"depthCurrentCameraRenderPass");p.setDisableBackFaceCulling(!0),p.setMaterialToUse(e.MaterialToUse.normalDepthMaterial),p.cameraName="main",this.passesNoScene.push(p),this.composers[0].addPass(c),this.composers[0].addPass(p),this.composers[0].composerContext.setPassClear(c,!0,new e.Color(16777215),0),this.composers[0].enablePass(c,!0),this.composers[0].enablePass(p,!0);var f=this.urban.getViewpoint();return f._renderedCamera.matrixWorldInverse=f.camera.matrixWorldInverse.getInverse(f.camera.matrixWorld),f._renderedCamera.projectionMatrixInverse=f.camera.projectionMatrixInverse.getInverse(f.camera.projectionMatrix),this.mixPass=new s(n.FinalBlending,void 0,"altitudeProcessCustom"),this.mixPass.uniforms.realProjectionMatrixInverse.value=f.camera.projectionMatrixInverse,this.mixPass.uniforms.realViewMatrixInverse.value=f.camera.matrixWorld,this.mixPass.compileShader(this.__renderer),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.zBuffer),this.mixPass.addRequiredComposer(this.composers[0]),this.max=0,this.count=0,this},disableEffect:function(){this.enabled&&(this.enabled=!1,this.urban.USR.getRenderPassManager().disablePass(this.passID))},enableEffect:function(){this.enabled||(this.enabled=!0,this.urban.USR.getRenderPassManager().enablePass(this.passID))},pauseCamera:function(){},initEffect:function(e,t){e&&(this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=1,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0),this.insertComposerCustom(t,this.composers[0],this.mixPass,!0)},insertComposerCustom:function(t,i,r,s){e.mobileVersion||(null!==i&&t.composers.push(i),s&&(r.disabledByDefault=!0),this.passID="altitudePass",this.urban.USR.getRenderPassManager().addPass(this.passID,this.mixPass,{before:"ClearDepthPass"}),this.mixPass.composer=t.mainComposer,t.compForwardComposerContext.enablePass(r,!0),t.updateFinalComposer(!0))},update:function(e,t,i,r){for(;this.passesNoScene.length>0;)console.warn("altitude effect initialized"),this.passesNoScene.pop().setScene(t.scene);this.updateCameraUniforms(i)},updateCameraUniforms:function(e){e._renderedCamera.projectionMatrixInverse=e.camera.projectionMatrixInverse.getInverse(e.camera.projectionMatrix),e._renderedCamera.matrixWorldInverse=e.camera.matrixWorldInverse.getInverse(e.camera.matrixWorld),this.mixPass.uniforms.realProjectionMatrixInverse.value=e.camera.projectionMatrixInverse,this.mixPass.uniforms.realViewMatrixInverse.value=e._renderedCamera.matrixWorld},setSize:function(e,t,i){if(this._parent(e,t)||i)for(var r=0;r<this.composers.length;++r)this.composers[r].setSize(this.width,this.height)},getMaxIteration:function(){return 0},changeFar:function(e,t){},changeNear:function(e,t){},changeFov:function(e,t){},changeAspect:function(e,t){},changeBias:function(e,t){},setColors:function(e,t,i){}})}),define("DS/XCityEffects/ViewshedEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/XCityEffects/ViewshedShader","DS/Plugins/ClearPass","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/XCityTools/ShaderTools"],function(e,t,i,r,s,n,a,o,l,h){"use strict";return t.extend({init:function(t,o,l,d){this._parent(t.renderer);this.urban=d,this.blueColor=new e.Color("#005686"),this.renderer=t,this.__renderer=t.renderer,this.renderTargetPool=o,this.nbCamera=0,this.cameraList={},this.rtList={},this.depthRenderPasses=[],this.availableViewshedComposer=[],this.near=.1,this.far=1e3,this.aspect=2,this.fov=1,this.bias=1e-5,this.size=2048;var u=new e.Color("#46a7ff"),c=new h.getCustomShaderMaterial([h.common,h.urbanLights]);c.opacity=.7,c.transparent=!0,c.enableClipPlanes=!1,c.uniforms.ambient.value=u,c.uniforms.diffuse.value=u,c.uniforms.specular.value=u,c.line=new e.LineBasicMaterial({lineWidth:5,opacity:1,color:u,enableClipPlanes:!1});var p=u,f=new h.getCustomShaderMaterial([h.common,h.urbanLights]);f.opacity=.7,f.transparent=!0,f.enableClipPlanes=!1,f.uniforms.ambient.value=p,f.uniforms.diffuse.value=p,f.uniforms.specular.value=p,f.line=new e.LineBasicMaterial({lineWidth:5,opacity:1,color:p,enableClipPlanes:!1});var m=u,g=new h.getCustomShaderMaterial([h.common,h.urbanLights]);g.opacity=.7,g.transparent=!0,g.enableClipPlanes=!1,g.uniforms.ambient.value=m,g.uniforms.diffuse.value=m,g.uniforms.specular.value=m,g.line=new e.LineBasicMaterial({lineWidth:5,opacity:1,color:m,enableClipPlanes:!1}),this.lineMatList=[c,f,g],this.rootNode=l,this.passesNoScene=[],this.currentCompareDepthsPass=void 0,this.scissorTest=!1,this.deactivateScissorTest=function(){this.scissorTest=this.__renderer.getScissorTest(),this.__renderer.enableScissorTest(!1)},this.reactivateScissorTest=function(){this.__renderer.enableScissorTest(this.scissorTest)};var v=new e.WebGLRenderTargetProperties(this.width,this.height,"nearest"),_=new i(this.__renderer,v,o);_.name="depthCurrentEffectComposer",_.composerContext.keepResult=!0;var y=new e.WebGLRenderTargetProperties(this.width,this.height,"nearest"),b=new i(this.__renderer,y,o);b.composerContext.keepResult=!0,b.composerContext.setBeforeRenderCB(this.deactivateScissorTest.bind(this)),b.composerContext.setAfterRenderCB(this.reactivateScissorTest.bind(this)),this.composers.push(_),this.composers.push(b);var x=new a("depthCurrentCameraClearPass"),C=new r(null,null,null,void 0,void 0,void 0,"depthCurrentCameraRenderPass");C.setDisableBackFaceCulling(!0),C.setMaterialToUse(e.MaterialToUse.normalDepthIoRRoughnessMaterial),C.cameraName="main",this.passesNoScene.push(C),this.composers[0].addPass(x),this.composers[0].addPass(C),this.composers[0].composerContext.setPassClear(x,!0,new e.Color(0),0),this.composers[0].enablePass(x,!0),this.composers[0].enablePass(C,!0);var S=n.CompareDepth[0];this.compareDepthsPass0=new s(S),this.compareDepthsPass0.compileShader(this.__renderer);var D=n.CompareDepth[1];this.compareDepthsPass1=new s(D),this.compareDepthsPass1.compileShader(this.__renderer);var P=n.CompareDepth[2];return this.compareDepthsPass2=new s(P),this.compareDepthsPass2.compileShader(this.__renderer),this.composers[1].addPass(this.compareDepthsPass0),this.composers[1].enablePass(this.compareDepthsPass0,!1),this.composers[1].addPass(this.compareDepthsPass1),this.composers[1].enablePass(this.compareDepthsPass1,!1),this.composers[1].addPass(this.compareDepthsPass2),this.composers[1].enablePass(this.compareDepthsPass2,!1),this.composers[0].linkToShaderPassUniform(this.compareDepthsPass0,this.compareDepthsPass0.uniforms.tNormalDepth),this.compareDepthsPass0.addRequiredComposer(this.composers[0]),this.composers[0].linkToShaderPassUniform(this.compareDepthsPass1,this.compareDepthsPass1.uniforms.tNormalDepth),this.compareDepthsPass1.addRequiredComposer(this.composers[0]),this.composers[0].linkToShaderPassUniform(this.compareDepthsPass2,this.compareDepthsPass2.uniforms.tNormalDepth),this.compareDepthsPass2.addRequiredComposer(this.composers[0]),this.mixPass=new s(n.FinalBlending,void 0,"ViewshedEffectCustom"),this.mixPass.compileShader(this.__renderer),this.composers[1].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composers[1]),this},addCamera:function(t,s,n,o,l,h,d){if(3!==this.nbCamera){this.enableEffect();for(var u="",c=0;c<3;c++){var p="ViewshedCamera"+c;if(void 0===this.cameraList[p]){u=p;break}}var f=this.cloneCamera(t,n,o);if(s&&(f.modelUrl=s),this.cameraList[u]={camera:f},this.createGeometryFrustum(f,this.nbCamera),this.rootNode.addChild(f.geometry),0==this.availableViewshedComposer.length){var m=new e.WebGLRenderTargetProperties(this.width,this.height,"nearest"),g=new i(this.__renderer,m,this.renderTargetPool);g.name="depthViewshedEffectComposer"+this.nbCamera,g.composerContext.keepResult=!0,this.composers.push(g);var v=new a("depthCameraClearPass"),_=new r(null,null,null,void 0,void 0,void 0,"depthCameraRenderPass");_.setMaterialToUse(e.MaterialToUse.normalDepthIoRRoughnessMaterial),_.setCustomCamera(this.cameraList[u].camera),this.passesNoScene.push(_),this.composers[2+this.nbCamera].addPass(v),this.composers[2+this.nbCamera].addPass(_),this.composers[2+this.nbCamera].composerContext.setPassClear(v,!0,new e.Color(0),0),this.composers[2+this.nbCamera].enablePass(v,!0),this.composers[2+this.nbCamera].enablePass(_,!0)}else this.composers.push(this.availableViewshedComposer.pop()),this.composers[2+this.nbCamera].enabled=!0,this.composers[2+this.nbCamera].passLists[0].passes[1].setCustomCamera(this.cameraList[u].camera);var y=void 0;if(0===this.nbCamera){y=this.compareDepthsPass0;this.composers[1].enablePass(this.compareDepthsPass0,!0),this.composers[1].enablePass(this.compareDepthsPass1,!1),this.composers[1].enablePass(this.compareDepthsPass2,!1),this.compareDepthsPass1.linkedComposerContexts.length>1&&(this.compareDepthsPass1.linkedComposerContexts.pop(),this.compareDepthsPass1.linkedComposerContexts.pop(),this.compareDepthsPass1.requiredComposers.pop(),this.compareDepthsPass1.requiredComposers.pop()),this.compareDepthsPass2.linkedComposerContexts.length>1&&(this.compareDepthsPass2.linkedComposerContexts.pop(),this.compareDepthsPass2.linkedComposerContexts.pop(),this.compareDepthsPass2.linkedComposerContexts.pop(),this.compareDepthsPass2.requiredComposers.pop(),this.compareDepthsPass2.requiredComposers.pop(),this.compareDepthsPass2.requiredComposers.pop())}else if(1===this.nbCamera){y=this.compareDepthsPass1;this.composers[1].enablePass(this.compareDepthsPass0,!1),this.composers[1].enablePass(this.compareDepthsPass1,!0),this.composers[1].enablePass(this.compareDepthsPass2,!1),this.compareDepthsPass0.linkedComposerContexts.length>1&&(this.compareDepthsPass0.linkedComposerContexts.pop(),this.compareDepthsPass0.requiredComposers.pop()),this.compareDepthsPass2.linkedComposerContexts.length>1&&(this.compareDepthsPass2.linkedComposerContexts.pop(),this.compareDepthsPass2.linkedComposerContexts.pop(),this.compareDepthsPass2.linkedComposerContexts.pop(),this.compareDepthsPass2.requiredComposers.pop(),this.compareDepthsPass2.requiredComposers.pop(),this.compareDepthsPass2.requiredComposers.pop())}else if(2===this.nbCamera){y=this.compareDepthsPass2;this.composers[1].enablePass(this.compareDepthsPass0,!1),this.composers[1].enablePass(this.compareDepthsPass1,!1),this.composers[1].enablePass(this.compareDepthsPass2,!0),this.compareDepthsPass0.linkedComposerContexts.length>1&&(this.compareDepthsPass0.linkedComposerContexts.pop(),this.compareDepthsPass0.requiredComposers.pop()),this.compareDepthsPass1.linkedComposerContexts.length>1&&(this.compareDepthsPass1.linkedComposerContexts.pop(),this.compareDepthsPass1.linkedComposerContexts.pop(),this.compareDepthsPass1.requiredComposers.pop(),this.compareDepthsPass1.requiredComposers.pop())}this.compareDepthsPass0.linkedComposerContexts.length>1&&(this.compareDepthsPass0.linkedComposerContexts.pop(),this.compareDepthsPass0.requiredComposers.pop()),this.compareDepthsPass1.linkedComposerContexts.length>1&&(this.compareDepthsPass1.linkedComposerContexts.pop(),this.compareDepthsPass1.linkedComposerContexts.pop(),this.compareDepthsPass1.requiredComposers.pop(),this.compareDepthsPass1.requiredComposers.pop()),this.compareDepthsPass2.linkedComposerContexts.length>1&&(this.compareDepthsPass2.linkedComposerContexts.pop(),this.compareDepthsPass2.linkedComposerContexts.pop(),this.compareDepthsPass2.linkedComposerContexts.pop(),this.compareDepthsPass2.requiredComposers.pop(),this.compareDepthsPass2.requiredComposers.pop(),this.compareDepthsPass2.requiredComposers.pop());for(c=0;c<this.nbCamera+1;++c)this.composers[2+c].linkToShaderPassUniform(y,y.uniforms["tDepthCameraViewshed"+c]),y.addRequiredComposer(this.composers[2+c]);var b=0;for(var c in this.cameraList)y.uniforms["viewshedMatrix"+b].value=this.cameraList[c].camera.viewshedMatrix,y.uniforms["bias"+b].value=this.cameraList[c].camera.bias,b++;return y.material.force=!0,y.material.needsUpdate=!0,this.currentCompareDepthsPass=y,this.nbCamera++,u}},createGeometryFrustum:function(t,i){var r=i%3,s=(t.position,new e.Vector3(1,-1,1));s.applyProjection(t.projectionMatrixInverse),s.applyMatrix4(t.matrixWorld);var n=new e.Vector3(1,1,1);n.applyProjection(t.projectionMatrixInverse),n.applyMatrix4(t.matrixWorld);var a=new e.Vector3(-1,1,1);a.applyProjection(t.projectionMatrixInverse),a.applyMatrix4(t.matrixWorld);var h=new e.Vector3(-1,-1,1);h.applyProjection(t.projectionMatrixInverse),h.applyMatrix4(t.matrixWorld);var d=new e.Vector3(1,-1,-1);d.applyProjection(t.projectionMatrixInverse),d.applyMatrix4(t.matrixWorld);var u=new e.Vector3(1,1,-1);u.applyProjection(t.projectionMatrixInverse),u.applyMatrix4(t.matrixWorld);var c=new e.Vector3(-1,1,-1);c.applyProjection(t.projectionMatrixInverse),c.applyMatrix4(t.matrixWorld);var p=new e.Vector3(-1,-1,-1);p.applyProjection(t.projectionMatrixInverse),p.applyMatrix4(t.matrixWorld);var f,m=[];m.push(s),m.push(n),m.push(a),m.push(h),m.push(s),(f=l.createLineNode({material:this.lineMatList[r],points:m,color:this.blueColor,width:1})).name="line_node",t.geometry=new o("cameraFrustum"),t.geometry.addChild(f),(m=[]).push(d),m.push(s),(f=l.createLineNode({material:this.lineMatList[r],points:m,color:this.blueColor,width:1})).name="line_node",t.geometry.addChild(f),(m=[]).push(u),m.push(n),(f=l.createLineNode({material:this.lineMatList[r],points:m,color:this.blueColor,width:1})).name="line_node",t.geometry.addChild(f),(m=[]).push(c),m.push(a),(f=l.createLineNode({material:this.lineMatList[r],points:m,color:this.blueColor,width:1})).name="line_node",t.geometry.addChild(f),(m=[]).push(p),m.push(h),(f=l.createLineNode({material:this.lineMatList[r],points:m,color:this.blueColor,width:1})).name="line_node",t.geometry.addChild(f),void 0!==t.modelUrl&&this.urban.modelLoader.load({url:t.modelUrl},function(e,i,r){if(i){this.cameraModel=e;var s=this.cameraModel.getMatrix();s.setPosition(t.position),s.setRotationFromQuaternion(t.quaternion),this.cameraModel.setMatrix(s),t.geometry.addChild(this.cameraModel)}}.bind(this))},cloneCamera:function(t,i,r,s,n){if(void 0!==t){void 0===i&&(i=t.near),void 0===r&&(r=t.far),void 0===s&&(s=t.aspect),void 0===n&&(n=t.fov);var a=new e.PerspectiveCamera(n,s,i,r);a.bias=t.bias,a.orientation=t.orientation,a.position.x=t.position.x,a.position.y=t.position.y,a.position.z=t.position.z,a.rotation.x=t.rotation.x,a.rotation.y=t.rotation.y,a.rotation.z=t.rotation.z,a.scale.x=t.scale.x,a.scale.y=t.scale.y,a.scale.z=t.scale.z,a.up.x=t.up.x,a.up.y=t.up.y,a.up.z=t.up.z,a.quaternion.x=t.quaternion.x,a.quaternion.y=t.quaternion.y,a.quaternion.z=t.quaternion.z,a.quaternion.w=t.quaternion.w,a.matrix.copy(t.matrix),a.matrixRotationWorld.copy(t.matrixRotationWorld),a.matrixWorld.copy(t.matrixWorld),a.matrixWorldInverse.copy(t.matrixWorldInverse),a.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,a.projectionMatrixInverse.getInverse(a.projectionMatrix),a.useQuaternion=t.useQuaternion,a.name="ViewshedCamera"+this.indexCamera;var o=new e.Matrix4;return o.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),o.multiply(a.projectionMatrix),o.multiply(a.matrixWorldInverse),a.viewshedMatrix=o,a.modelUrl=t.modelUrl,a}},removeCamera:function(e){if(0!==this.nbCamera){if(!this.cameraList[e])return!1;var t=this.cameraList[e].camera;if(void 0===t)return!1;this.rootNode.removeChild(t.geometry);var i=this.composers.pop();i.removeLinks(),i.enabled=!1,this.availableViewshedComposer.push(i),delete this.cameraList[e],this.nbCamera--;var r=void 0;if(1===this.nbCamera){r=this.compareDepthsPass0;this.composers[1].enablePass(this.compareDepthsPass0,!0),this.composers[1].enablePass(this.compareDepthsPass1,!1),this.composers[1].enablePass(this.compareDepthsPass2,!1),this.compareDepthsPass1.linkedComposerContexts.length>1&&(this.compareDepthsPass1.linkedComposerContexts.pop(),this.compareDepthsPass1.linkedComposerContexts.pop(),this.compareDepthsPass1.requiredComposers.pop(),this.compareDepthsPass1.requiredComposers.pop()),this.compareDepthsPass2.linkedComposerContexts.length>1&&(this.compareDepthsPass2.linkedComposerContexts.pop(),this.compareDepthsPass2.linkedComposerContexts.pop(),this.compareDepthsPass2.linkedComposerContexts.pop(),this.compareDepthsPass2.requiredComposers.pop(),this.compareDepthsPass2.requiredComposers.pop(),this.compareDepthsPass2.requiredComposers.pop())}else if(2===this.nbCamera){r=this.compareDepthsPass1;this.composers[1].enablePass(this.compareDepthsPass0,!1),this.composers[1].enablePass(this.compareDepthsPass1,!0),this.composers[1].enablePass(this.compareDepthsPass2,!1),this.compareDepthsPass0.linkedComposerContexts.length>1&&(this.compareDepthsPass0.linkedComposerContexts.pop(),this.compareDepthsPass0.requiredComposers.pop()),this.compareDepthsPass2.linkedComposerContexts.length>1&&(this.compareDepthsPass2.linkedComposerContexts.pop(),this.compareDepthsPass2.linkedComposerContexts.pop(),this.compareDepthsPass2.linkedComposerContexts.pop(),this.compareDepthsPass2.requiredComposers.pop(),this.compareDepthsPass2.requiredComposers.pop(),this.compareDepthsPass2.requiredComposers.pop())}else if(3===this.nbCamera){r=this.compareDepthsPass2;this.composers[1].enablePass(this.compareDepthsPass0,!1),this.composers[1].enablePass(this.compareDepthsPass1,!1),this.composers[1].enablePass(this.compareDepthsPass2,!0),this.compareDepthsPass0.linkedComposerContexts.length>1&&(this.compareDepthsPass0.linkedComposerContexts.pop(),this.compareDepthsPass0.requiredComposers.pop()),this.compareDepthsPass1.linkedComposerContexts.length>1&&(this.compareDepthsPass1.linkedComposerContexts.pop(),this.compareDepthsPass1.linkedComposerContexts.pop(),this.compareDepthsPass1.requiredComposers.pop(),this.compareDepthsPass1.requiredComposers.pop())}else this.composers[1].enablePass(this.compareDepthsPass0,!1),this.composers[1].enablePass(this.compareDepthsPass1,!1),this.composers[1].enablePass(this.compareDepthsPass2,!1),this.disableEffect();for(var s=0;s<this.nbCamera;++s)this.composers[2+s].linkToShaderPassUniform(r,r.uniforms["tDepthCameraViewshed"+s]),r.addRequiredComposer(this.composers[2+s]);var n=0;for(var s in this.cameraList)r.uniforms["viewshedMatrix"+n].value=this.cameraList[s].camera.viewshedMatrix,r.uniforms["bias"+n].value=this.cameraList[s].camera.bias,this.composers[2+n].passLists[0].passes[1].setCustomCamera(this.cameraList[s].camera),n++;this.currentCompareDepthsPass=r}},disableEffect:function(){this.enabled&&(this.enabled=!1,this.renderer.mainComposer.removeCustomPassNEW([this.mixPass]))},enableEffect:function(){this.enabled||(this.enabled=!0,this.renderer.mainComposer.insertCustomPassBeforeNEW(this.mixPass,"postEffects1"),this.renderer.compForwardComposerContext.enablePass(this.mixPass,!0))},pauseCamera:function(){},initEffect:function(e,t){e&&(this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0),this.insertComposerCustom(t,this.composers[2],this.mixPass,!0),this.renderer.initComposer("PickingGPUInstancing")},insertComposerCustom:function(t,i,r,s){e.mobileVersion||(null!==i&&t.composers.push(i),s&&(r.disabledByDefault=!0),t.mainComposer.insertCustomPassBeforeNEW(r,"postEffects1"),this.mixPass.composer=t.mainComposer,t.compForwardComposerContext.enablePass(r,!0),t.updateFinalComposer(!0))},update:function(e,t,i,r){for(;this.passesNoScene.length>0;)this.passesNoScene.pop().setScene(t.scene);i.camera.projectionMatrixInverse.getInverse(i.camera.projectionMatrix),i.camera.matrixWorldInverse.getInverse(i.camera.matrixWorld);for(var s=this.composers[1].composerContext.passes,n=0;n<s.length;++n)s[n].uniforms.realProjectionMatrixInverse.value=i.camera.projectionMatrixInverse,s[n].uniforms.realViewMatrix.value=i.camera.matrixWorld},setSize:function(e,t,i,r){if(void 0!==r){this.width=e,this.height=t;for(var s=0;s<this.composers.length;++s)this.composers[s].setSize(this.width,this.height)}},getMaxIteration:function(){return 0},updateCamera:function(e,t){var i=0;for(var r in this.cameraList){if(void 0===e||e===r){this.rootNode.removeChild(this.cameraList[r].camera.geometry);var s=this.cloneCamera(t);this.cameraList[r].camera=s,this.composers[2+i].composerContext.passes[1].setCustomCamera(s),this.currentCompareDepthsPass.uniforms["viewshedMatrix"+i].value=s.viewshedMatrix,this.createGeometryFrustum(s,i),this.rootNode.addChild(s.geometry)}i++}},changeFar:function(e,t){var i=0;for(var r in this.cameraList){if(void 0===t||t===r){this.rootNode.removeChild(this.cameraList[r].camera.geometry);var s=this.cloneCamera(this.cameraList[r].camera,void 0,e,void 0,void 0);this.cameraList[r].camera=s,this.composers[2+i].composerContext.passes[1].setCustomCamera(s),this.currentCompareDepthsPass.uniforms["viewshedMatrix"+i].value=s.viewshedMatrix,this.createGeometryFrustum(s,i),this.rootNode.addChild(s.geometry)}i++}},changeNear:function(e,t){var i=0;for(var r in this.cameraList){if(void 0===t||t===r){this.rootNode.removeChild(this.cameraList[r].camera.geometry);var s=this.cloneCamera(this.cameraList[r].camera,e,void 0,void 0,void 0);this.cameraList[r].camera=s,this.composers[2+i].composerContext.passes[1].setCustomCamera(s),this.currentCompareDepthsPass.uniforms["viewshedMatrix"+i].value=s.viewshedMatrix,this.createGeometryFrustum(s,i),this.rootNode.addChild(s.geometry)}i++}},changeFov:function(e,t){var i=0;for(var r in this.cameraList){if(void 0===t||t===r){this.rootNode.removeChild(this.cameraList[r].camera.geometry);var s=this.cloneCamera(this.cameraList[r].camera,void 0,void 0,void 0,e);this.cameraList[r].camera=s,this.composers[2+i].composerContext.passes[1].setCustomCamera(s),this.currentCompareDepthsPass.uniforms["viewshedMatrix"+i].value=s.viewshedMatrix,this.createGeometryFrustum(s,i),this.rootNode.addChild(s.geometry)}i++}},changeAspect:function(e,t){var i=0;for(var r in this.cameraList){if(void 0===t||t===r){this.rootNode.removeChild(this.cameraList[r].camera.geometry);var s=this.cloneCamera(this.cameraList[r].camera,void 0,void 0,e,void 0);this.cameraList[r].camera=s,this.composers[2+i].composerContext.passes[1].setCustomCamera(s),this.currentCompareDepthsPass.uniforms["viewshedMatrix"+i].value=s.viewshedMatrix,this.createGeometryFrustum(s,i),this.rootNode.addChild(s.geometry)}i++}},changeBias:function(e,t){var i=0;for(var r in this.cameraList)void 0!==t&&t!==r||(this.cameraList[r].camera.bias=e,this.currentCompareDepthsPass.uniforms["bias"+i].value=e),i++},setColors:function(t,i,r){t&&(this.mixPass.uniforms.colorVisible.value=new e.Color(t)),i&&(this.mixPass.uniforms.colorNotVisible.value=new e.Color(i)),r&&(this.mixPass.uniforms.colorOutOfFrustum.value=new e.Color(r))}})}),define("DS/XCityTools/Geocoder",["DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils","DS/XCityTools/Debug","VENProj4js-2.7.2/js/proj4"],function(e,t,i,r){"use strict";var s=null;function n(){if(null!==s)throw new Error("Cannot instantiate more than one MySingleton, use MySingleton.getInstance()");this.initialize()}return window.Proj4js||(window.Proj4js=r),n.getInstance=function(){return null===s&&(s=new n),s},n.projList={},n.prototype={initialize:function(){this.baseURL="",this.earthRadius=6378137,this.defaultProjection="EPSG:900913",this.projections={}},setBaseUrl:function(e,t){this.baseURL=e;var i=!0,r=2,s=function(e){i&=e,0===--r&&void 0!==t&&t(i)};this.loadProjection("WGS84",s.bind(this)),this.loadProjection("EPSG:900913",s.bind(this))},setDefaultProjection:function(e,t){this.defaultProjection=e,this.loadProjection(this.defaultProjection,t)},getDefaultProjection:function(){return this.defaultProjection},getProjectProjection:function(){return this.defaultProjection},projectionReady:function(e){var t=n.getInstance().projections[e];return void 0!==t&&1===t.ready},loadProjection:function(e,r,s){var a,o,l,h,d=function(t){var r,a;if(a=n.getInstance().projections[e],t&&void 0===a.proj4js){var o=e;!0!==s&&(o=Proj4js.defs[e],Proj4js.defs(e,o)),a.proj4js=new Proj4js.Proj(o,function(e,t){null===e&&(a.proj4js=t,d(!0))})}for(t?i.log("GEOCODER:loadProjection -> Projection "+e+" LOADED"):i.error("GEOCODER:loadProjection -> FAILLED to load projection "+e),a.ready=t?1:-1,r=0;r<a.cb.length;++r)void 0!==a.cb[r]&&a.cb[r](t);a.cb=[]};if(void 0===this.projections[e])if(this.projections[e]={ready:0,cb:[r]},h=d.bind(this),function(t){var i=n.getInstance().projections[e];i.proj4js=new Proj4js.Proj(e,function(e,t){null===e&&(i.proj4js=t,d(!0))})}.bind(this),s)h(!0);else try{for(l in(o={}).type="text/javascript",o.src=t.getWebappsBaseUrl()+"VENProj4js/defs/"+e.replace(/:/gi,"")+".js",a=document.createElement("script"),o)a[l]=o[l];return a.onerror=function(){h(!1)},a.onload=function(){h(!0)},a.onreadystatechange=function(){"complete"!==a.readyState&&"loaded"!==a.readyState||h(!0)},document.getElementsByTagName("head")[0].appendChild(a),!0}catch(e){return h(!1),!1}else switch(this.projections[e].ready){case 0:this.projections[e].cb.push(r);break;case 1:void 0!==r&&r(!0);break;default:void 0!==r&&r(!1)}},projForWebWorker:function(t,i,r,s,n,a){var o;return void 0!==t.x&&void 0!==t.y?o=new e.Vector3(t.x,t.y):void 0!==t.lat&&void 0!==t.lon?o=new e.Vector3(t.lon,t.lat):t instanceof Array&&t.length>=2&&(o=new e.Vector3(t[0],t[1])),i&&""!==i||(i=this.defaultProjection),s&&""!==s||(s=this.defaultProjection),i!==s&&(!a||"WGS84"!==i&&"EPSG:4326"!==i&&"EPSG:4329"!==i||(o.x=Utils.toDeg(o.x),o.y=Utils.toDeg(o.y)),o=Proj4js.transform(r,n,o),!a||"WGS84"!==s&&"EPSG:4326"!==s&&"EPSG:4329"!==s||(o.x=Utils.toRad(o.x),o.y=Utils.toRad(o.y))),o},proj:function(t,i,r,s){var n;if(void 0!==t.x&&void 0!==t.y?n=new e.Vector3(t.x,t.y):void 0!==t.lat&&void 0!==t.lon?n=new e.Vector3(t.lon,t.lat):t instanceof Array&&t.length>=2&&(n=new e.Vector3(t[0],t[1])),i&&""!==i||(i=this.defaultProjection),this.loadProjection(i),r&&""!==r||(r=this.defaultProjection),this.loadProjection(r),i!==r){if(!s||"WGS84"!==i&&"EPSG:4326"!==i&&"EPSG:4329"!==i||(n.x=Utils.toDeg(n.x),n.y=Utils.toDeg(n.y)),this.projections[i].ready>0&&this.projections[r].ready>0){var a=this.projections[i].proj4js,o=this.projections[r].proj4js;n=Proj4js.transform(a,o,n)}!s||"WGS84"!==r&&"EPSG:4326"!==r&&"EPSG:4329"!==r||(n.x=Utils.toRad(n.x),n.y=Utils.toRad(n.y))}return n},latlonToMercator:function(e,t,i){return this.proj([t,e],"WGS84","EPSG:900913",i)},mercatorToLatlon:function(e,t,i){return this.proj([e,t],"EPSG:900913","WGS84",i)},proj2worldMatrix:function(t,i,r){var s=this.earthRadius+(void 0!==t.z?t.z:0),n=this.toGeographic(this.proj(t,i,"EPSG:900913",r),!0),a=s*Math.cos(n.y),o=a*Math.cos(n.x),l=a*Math.sin(n.x),h=s*Math.sin(n.y),d=(new e.Matrix4).makeRotationY(.5*Math.PI-n.y);return(new e.Matrix4).makeRotationZ(n.x).multiply(d).multiply((new e.Matrix4).makeRotationZ(.5*Math.PI)).setPosition(new e.Vector3(o,l,h))},proj2world:function(t,i,r){var s=new e.Vector3;return s.getPositionFromMatrix(this.proj2worldMatrix(t,i,r)),s},world2proj:function(e,t,i){var r=Math.atan2(e.z,Math.sqrt(e.y*e.y+e.x*e.x)),s=Math.atan2(e.y,e.x);return i||(r=Utils.toDeg(r),s=Utils.toDeg(s)),this.proj([s,r],"WGS84",t,i)},computeMercatorScaleFactor:function(e,t,i,r){if(!this.projectionReady(i))return 1;var s=this.proj([e,t],i,"WGS84",r);return r?Math.min(100,Math.max(1,1/Math.cos(s.y))):Math.min(100,Math.max(1,1/Math.cos(Utils.toRad(s.y))))},reverseGeocodingAt:function(e,t,i){i||(i=this.defaultProjection);var r=this.proj2D([e,t],"WGS84",i),s="http://nominatim.openstreetmap.org/reverse?format=json&lat="+r.y+"&lon="+r.x+"&zoom=18&addressdetails=1";return UWA.Ajax.request(s,{async:!1,cors:!0,onComplete:function(e){return JSON.parse(e).display_name}}),"nowhere"},toGeographic:function(e,t){var i=57.29577951308232*(e.x/6378137),r=i-360*Math.floor((i+180)/360),s=57.29577951308232*(1.5707963267948966-2*Math.atan(Math.exp(-1*e.y/6378137)));return s>85?s=90:s<-85&&(s=-90),t?{y:Utils.toRad(s),x:Utils.toRad(r)}:{y:s,x:r}},getLandPositionFromName:function(t,r,s,n){var a="http://nominatim.openstreetmap.org/search?q="+t+"&format=json";UWA.Ajax.request(a,{cors:!0,onComplete:function(t){if(void 0===JSON.parse(t)[0])return i.error("Error: Destination request failed!"),void s(void 0);r||(r=this.defaultProjection);var a=void 0;a=n?new e.Vector2(p.x,p.y):new e.Vector2(p.x,p.y,0),s(a)},onFailure:function(){s(void 0)}})}},n.getInstance()}),define("DS/XCityTools/Downloader",["DS/WAFData/WAFData","DS/WebappsUtils/WebappsUtils","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","DS/XCityTools/Debug","DS/XCityTools/Geocoder","DS/xCityPlatformUtils/xCityDocumentManagement","DS/XCityTools/shapefile"],function(e,t,i,r,s,n,a,o,l){"use strict";var h=function(){this._downloadStatsRefreshDelay=6e4,this._maxSimultaneousDownloads=10,this._platformID=void 0,this._platformServicesList=[],this._credentials={default:!1},this._downloadList={},this._waitingList=[],this._rejectedDatasetList=[],this._datasetToCheckList=0,this._aliases={},this._datasetLogs=new Map,this._scheduledDataseLogsReset=new Map,this._perfBufferSize=1e3,performance.clearResourceTimings(),performance.setResourceTimingBufferSize(this._perfBufferSize)};h.prototype={setWidget:function(e){if(void 0!==e){this._platformID=e.getValue("x3dPlatformId"),this._platformServicesList.push(t.getWebappsBaseUrl()),i.getServiceUrl({serviceName:"globe",platformId:this._platformID,onComplete:this._setGlobeService.bind(this),onFailure:this._failedServiceUrl.bind(this)});var r=this;i.getPlatformServices({onComplete:function(e){e.forEach(function(e){if(r._platformID===e.platformId){for(var t in e)r._aliases[t]=e[t];r._globeServiceLogin()}})},onFailure:this._failedPlatformServices.bind(this)}),window.xCityFakePlatform&&!Utils.is(this._platformID)&&(this._platformID="xCityFakePlatform")}},setCredentials:function(e,t){this._credentials[e]=t},resetCredentials:function(e,t){this._credentials={default:!1}},reset:function(){this.resetCredentials(),this.resetRejectedDatasetList(),this._datasetLogs=new Map,this._scheduledDataseLogsReset.forEach((e,t)=>{clearTimeout(e.timeoutId)}),this._scheduledDataseLogsReset=new Map},addRejectedDataset:function(e,t,i,r,s){this._rejectedDatasetList.push({name:e,url:t,response:i,errorMessage:r,errorCode:s})},getRejectedDatasetList:function(){return this._rejectedDatasetList},resetRejectedDatasetList:function(){return this._rejectedDatasetList=[]},setUrlParams:function(e){if(e)for(var t in this._aliases={},e)e.hasOwnProperty(t)&&(this._aliases[t]&&console.warn(" Url Alias "+t+" is already used, reusing it will cause problems !!"),"string"==typeof e[t]&&(this._aliases[t]=e[t]))},resetUrlParams:function(){this._aliases={}},resolveUrlWithTimeStamp:function(e,t){return this._appendTimeStampParam(this.resolveUrl(e,t))},resolveUrl:function(e,i){var r,s,n,a,o=e;if(this._aliases){for(var l in n=o.split("data:"),o=n[0],this._aliases)if(this._aliases.hasOwnProperty(l)&&(a="%"+l+"%",o.indexOf(a)>=0))for(r=o.split(a),o="",s=0;s<r.length;s++)o+=r[s],s<r.length-1&&(o+=this._aliases[l]);for(s=1;s<n.length;s++)o+="data:",o+=n[s]}return"http"!==o.substring(0,4)&&"/"!==o[0]&&"data:"!==o.substring(0,5)&&"file:"!==o.substring(0,5)&&(o=i&&i.module?t.getWebappsAssetUrl(i.module,"")+o:t.getWebappsBaseUrl()+o),o},_parseShapeFile:async function(e,t,i,r){return new Promise((s,n)=>{const h=function(t,i){return new Promise((r,s)=>{o.retrieveDocumentUrl(t,i,e).then(function(e){return o.downloadBinaryDocument(e)}).then(function(e){e?r(e):s()})})};let d=t,u=i.shp.id,c=t,p=i.dbf.id,f=t,m=i.prj.id;return"3DDrive"===e&&(d=u=i.shp,c=p=i.dbf,f=m=i.prj),h(d,u).then(function(e){var t,i=e;h(c,p).then(function(e){var n,o;(n=i,o=t=e,new Promise((e,t)=>{l.read(n,o).then(t=>e(t))})).then(function(e){e=e;h(f,m).then(function(n){var o,l=(o=n,String.fromCharCode.apply(null,new Uint8Array(o)));l.endsWith("\n")&&(l=l.slice(0,l.length-1)),a.loadProjection(l,void 0,!0),e.crs={properties:{name:l}},r&&(e.dbfContent=t,e.shpContent=i),s(e)})})})})})},downloadFrom3DDrive:async function(e,t){const i=this;return new Promise((r,s)=>o.retrieveDocumentTypes(e,"3DDrive").then(function(n){for(var a={shp:null,prj:null,dbf:null,geojson:null,other:null},l=0;l<n.types.length;l++){var h=n.types[l].toUpperCase();"GEOJSON"===h?a.geojson=n.filesId[l]:"SHP"===h?a.shp=n.filesId[l]:"KML"!==h&&"GML"!==h&&"ZGDB"!==h&&"CSV"!==h||(a.other=n.filesId[l])}if(null!==a.geojson)o.retrieveDocumentUrl(e,a.geojson,"3DDrive").then(function(e){return t?o.downloadBinaryDocument(e):o.downloadDocument(e)}).then(function(e){r(e)});else if(null!==a.shp){var d=n.title.indexOf("."),u=n.title.slice(0,d);o.retrieveDocumentsInFolder(n.folderId,"3DDrive").then(function(e){for(var t,i=0;i<e.length;++i)"DriveFile"===(t=e[i]).type&&(t.title===u+".dbf"?a.dbf=t.id:t.title===u+".prj"&&(a.prj=t.id))}).then(async function(){const s=await i._parseShapeFile("3DDrive",e,a,t);r(s)})}else null!==a.other?r({needServiceSidePreview:!0}):s()}))},downloadFrom3DSpace:async function(e,t){const i=this;return new Promise((r,s)=>o.retrieveDocumentTypes(e).then(async function(n){for(var a={shp:null,prj:null,dbf:null,geojson:null,other:null},l=function(e,t){return null===e?t:null===t?e:1===e.name.localeCompare(t.name)?t:e},h=0;h<n.types.length;h++){var d=n.types[h].toUpperCase();"GEOJSON"===d?a.geojson=l(a.geojson,{name:n.filesName[h],id:n.filesId[h]}):"SHP"===d?a.shp=l(a.shp,{name:n.filesName[h],id:n.filesId[h]}):"PRJ"===d?a.prj=l(a.prj,{name:n.filesName[h],id:n.filesId[h]}):"DBF"===d?a.dbf=l(a.dbf,{name:n.filesName[h],id:n.filesId[h]}):"KML"!==d&&"GML"!==d&&"ZGDB"!==d&&"CSV"!==d||(a.other=l(a.other,{name:n.filesName[h],id:n.filesId[h]}))}if(null!==a.geojson)o.retrieveDocumentUrl(e,a.geojson.id).then(function(e){return t?o.downloadBinaryDocument(e):o.downloadDocument(e)}).then(function(e){r(e)});else if(null!==a.shp){const s=await i._parseShapeFile("3DSpace",e,a,t);r(s)}else null!==a.other?r({needServiceSidePreview:!0}):s()}))},_appendTimeStampParam:function(e){const t=this.getUuidFromUrl(e);if(t&&"undefined"!=typeof xCity&&xCity.widgetData&&xCity.widgetData.datasetCollection){const i=xCity.widgetData.datasetCollection.get({id:t}),r=i?i.get("lastModificationDate"):null;if(r){let t=new Date(r).getTime();Number.isFinite(t)&&(e+="&ts="+t)}}return e},download:function(e,t,i,s,a){var o,l=this,h=function(e,t){return l.resolveUrl(e,t)};if(!e)return n.warn("Downloader: No url given."),void s.call(a,!1);if(e instanceof Array)for(var d=e.length;d--;)e[d]=h(e[d],t);else e=h(e,t),e=this._appendTimeStampParam(e);s&&(o={func:s,bound:a,opt:Array.prototype.slice.call(arguments,5)});var u=this._downloadList[e];if(void 0!==u)void 0!==o&&u.callbacks.push(o);else{var c=this._waitingList.findIndex(this._sameURLRequest.bind(this,e));if(-1!==c)u=this._removeFromWaitingList(c),i&&10*i>u.priority?u.priority=10*i:u.priority=u.priority+1,void 0!==o&&u.callbacks.push(o);else{var p;for(p in u={url:e,priority:i?10*i:0,callbacks:[],options:{},downloadUUID:UWA.Utils.getUUID()},t)t.hasOwnProperty(p)&&(u.options[p]=t[p]);if(void 0!==o&&u.callbacks.push(o),!u.options.withCredentials){var f=this._credentials.default;for(p in this._credentials)if("default"!==p&&-1!==e.indexOf(p)){f=this._credentials[p];break}u.options.withCredentials=f,f||(u.options.headers={"X-Requested-With":""})}u.options.method="GET",u.options.onComplete=this._onComplete.bind(this,u.url),u.options.onFailure=this._onFailure.bind(this,u.url)}if(void 0!==u.options.textureLOD){var m=document.createElement("canvas"),g=new r.Texture(m,void 0);g.wrapS=u.options.wrapS,g.wrapT=u.options.wrapT,g.loadEndStatus="loading",u.textureLOD=g}this._addToWaitingList(u)}return this._startDownload(),void 0!==u.options.textureLOD?u.textureLOD:void 0},_getDownloadRequest:function(){var e=0;return this._shouldRequestDownload(this._waitingList[e])||(e=this._findBestRequestIndex()),this._waitingList.splice(e,1)[0]},_shouldRequestDownload:function(e){var t=this._datasetLogs.get(this._getDatasetIDFromUrl(e.url)),i=e.options.image,r=!!t&&t.averageTime>500;return i&&r&&!this._slowRasterSlotPendingUrl?(this._slowRasterSlotPendingUrl=e.url,!0):!(i&&r&&this._slowRasterSlotPendingUrl)},_findBestRequestIndex:function(){for(let e=0;e<this._waitingList.length;e++)if(this._shouldRequestDownload(this._waitingList[e]))return e;return 0},_addToWaitingList:function(e){if(e)if(!this._isBlackListed(e)&&this._isReady(e))if(0===this._waitingList.length)this._waitingList.push(e);else{var t=this._waitingList.findIndex(this._firstWithLowerPriority.bind(this,e.priority));this._waitingList.splice(-1===t?this._waitingList.length:t,0,e)}else if(e.callbacks){var i=e.callbacks;e.callbacks=[],i.forEach(function(e){e.opt.unshift(!1,void 0,void 0),e.func.apply(e.bound,e.opt)})}},_addDatasetLogEntry:function(e){performance.getEntriesByType("resource").length===this._perfBufferSize&&performance.clearResourceTimings();var t=this._getDatasetIDFromUrl(e.url);if(t){var i=this._datasetLogs.get(t);i||(i=this._initDatasetLogEntry(t,[])),i.times[e.downloadUUID]=Date.now()}},getDownloadLog:function(e){let t=void 0;if(e&&this._datasetLogs){let i=this._datasetLogs.get(this._getDatasetIDFromUrl(e));i&&((t=Object.assign({},i)).pending=t.times?Object.keys(t.times).map(e=>t.times[e]):[],delete t.times,t.isBlackListed=this._isBlackListed({url:e}),t.isSlowRaster=this._isSlowRaster(e))}return t},_getDownloadLogs:function(){for(const[e,t]of this._datasetLogs.entries()){let i=this._isSlowRaster(e);t.isSlowRasterSlot=i}return this._datasetLogs},_isSlowRaster:function(e){return!!(e&&this._slowRasterSlotPendingUrl&&this._slowRasterSlotPendingUrl.includes(e))},_updateDatasetLogEntry:function(e,t){e.url===this._slowRasterSlotPendingUrl&&(this._slowRasterSlotPendingUrl=null);var i=this._getDatasetIDFromUrl(e.url);if(i&&this._datasetLogs.has(i)){var r=this._datasetLogs.get(i);t?r.success++:r.failure++;var s=r.times[e.downloadUUID]||Date.now();delete r.times[e.downloadUUID];var n=Date.now()-s,a=r.success+r.failure,o=r.averageTime*((a-1)/a),l=n*(1/a);r.averageTime=o+l;let h=performance.getEntriesByType("resource").filter(e=>e.name.includes(i)),d=h.length?h.map(e=>e.responseStart-e.requestStart).reduce((e,t)=>e+t,0)/h.length:null,u=h.length?h.map(e=>e.responseStart-e.requestStart).filter(e=>e>500).length/h.length:null;r.avgTTFB=d,r.percentTTFBOver500ms=u,this._datasetLogs.set(i,r)}},_initDatasetLogEntry:function(e,t){var i={success:0,failure:0,times:t,averageTime:0,avgTTFB:0,percentTTFBOver500ms:0};this._datasetLogs.set(e,i);var r=setTimeout(this._resetLogForDataset.bind(this),this._downloadStatsRefreshDelay,e);return this._scheduledDataseLogsReset.set(e,{timeoutId:r,startTime:Date.now()}),i},getDownloadStatsRefreshDelay:function(){return this._downloadStatsRefreshDelay},setDownloadStatsRefreshDelay:function(e){this._downloadStatsRefreshDelay=e,this._updateDatasetLogResetSchedule()},_updateDatasetLogResetSchedule:function(){let e=new Map;this._scheduledDataseLogsReset.forEach((t,i)=>{const r=setTimeout(this._resetLogForDataset.bind(this),this._downloadStatsRefreshDelay,i);e.set(i,{timeoutId:r,startTime:Date.now()}),clearInterval(t.timeoutId)}),this._scheduledDataseLogsReset=e},_isBlackListed:function(e){var t=this._getDatasetIDFromUrl(e.url),i=this._datasetLogs.get(t);if(e.url&&e.url.contains("/resources/"))return!1;if(i){var r=i.failure+i.success,s=i.failure/Math.max(1,r);if(r>=10&&s>.8){return n.warn("Layer downloads deactivated because of too many errors."),!0}}return!1},_isReady(e){const t=this.getUuidFromUrl(e.url),i="undefined"!=typeof xCity&&xCity.widgetData&&xCity.widgetData.datasetCollection&&xCity.widgetData.datasetCollection.get({id:t});return!i||"Ready"===i.get("state")},_removeFromWaitingList:function(e){return this._waitingList.splice(e,1)[0]},cancel:function(e){var t,i,r=this.resolveUrl(e),s=this.resolveUrlWithTimeStamp(e),n=this._downloadList[r]||this._downloadList[s];void 0!==n?(t=n.callbacks,n.callbacks=[],t.forEach(function(e){e.opt.unshift(!1,void 0,void 0),e.func.apply(e.bound,e.opt)})):(-1===(i=this._waitingList.findIndex(this._sameURLRequest.bind(this,r)))&&(i=this._waitingList.findIndex(this._sameURLRequest.bind(this,s))),-1!==i&&(t=(n=this._waitingList.splice(i,1)[0]).callbacks,n.callbacks=[],t.forEach(function(e){e.opt.unshift(!1,void 0,void 0),e.func.apply(e.bound,e.opt)})))},updatePnORequests:function(e){for(let t=0;t<e.length;t++)e[t]&&this._updatePnoRequest(e[t])},_updatePnoRequest:function(e){let t,i,r=!1,s=!1,n=this.getDataSupplierUrl()+e.uuid+"/%l/%x/%y?tenant="+this._platformID;if(n=this.getDataSupplierUrlFromUrl(n),n=this.resolveUrlWithTimeStamp(n),(i=this._downloadList[n])?r=!0:-1!==(t=this._waitingList.findIndex(this._sameURLRequest.bind(this,n)))&&(i=this._waitingList[t],s=!0),i){s&&(this._downloadList[i.url]=this._waitingList.splice(t,1)[0]);var a="json"===i.options.responseType?e:JSON.stringify(e);this._addDatasetLogEntry(i),this._onComplete(i.url,a,null,200)}},_firstWithLowerPriority:function(e,t,i,r){if(t.priority<e)return!0},_sameURLRequest:function(e,t,i,r){if(t.url===e)return!0},_setGlobeService:function(e){e&&this._platformServicesList.push(e)},_onComplete:function(e,t,i,r){var s=this._downloadList[e];if(delete this._downloadList[e],s&&s.callbacks){var n,a,o,l=r;for(n=0,a=s.callbacks.length;n<a;++n)(o=s.callbacks[n]).opt.unshift(!0,t,l),o.func.apply(o.bound,o.opt)}s&&this._updateDatasetLogEntry(s,!0),this._startDownload()},_onFailure:function(e,t,i,r){var s,n,a,o=this._downloadList[e];if(delete this._downloadList[e],o&&o.callbacks)for(s=0,n=o.callbacks.length;s<n;++s)(a=o.callbacks[s]).opt.unshift(!1,i,t),a.func.apply(a.bound,a.opt);o&&this._updateDatasetLogEntry(o,!1),this._startDownload()},_resetLogForDataset:function(e){this._datasetLogs.has(e)&&(this._scheduledDataseLogsReset.delete(e),this._datasetLogs.delete(e),this._slowRasterSlotPendingUrl=null)},isAPlatformService:function(e){var t=!1;if(void 0!==this._platformID){e instanceof Array&&(e=e[0]);for(var i=this.resolveUrl(e),r=0,s=this._platformServicesList.length;r<s;r++)if(i.startsWith(this._platformServicesList[r])){t=!0;break}}return t},_globeServiceLogin:function(){if(void 0!==this._aliases.globe){var t=this;window.setInterval(function(){var i=t._aliases.globe+"/datasupplier/login?tenant="+t._aliases.platformId,r={method:"GET",type:"json",onComplete:function(e,t,i){console.log("Logged to 3DGlobe service")},onFailure:function(e,t,i){console.error("Unable to log on 3DGlobe service")}};e.authenticatedRequest(i,r)},3e5)}},_loadTextureLOD:function(e,t,i,s,n,a,o){function l(e){var t=Math.log(e)/Math.LN2;return Math.floor(t)===t}function h(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.round(t))}var d=new Image;null!==a&&(d.crossOrigin=a?"use-credentials":"anonymous");var u=new r.ImageLoader;return u.addEventListener("load",function(t){var i,n,a;for(r.ImageUtils.nbTexturesBeingLoaded--,e.needsUpdate=!0,e.loadEndStatus="complete",!o||l(d.width)&&l(d.height)?e.image=d:(i=h(d.width),n=h(d.height),e.image.width=i,e.image.height=n,e.image.getContext("2d").drawImage(d,0,0,i,n)),s&&s(e),a=0;a<e.onLoadCallbacks.length;a++)e.onLoadCallbacks[a](e)}),u.addEventListener("error",function(t){r.ImageUtils.nbTexturesBeingLoaded--,n&&n(t.message),e.loadEndStatus="error"}),d.crossOrigin&&(u.crossOrigin=d.crossOrigin),u.load(t,d),r.ImageUtils.nbTexturesBeingLoaded++,e.sourceFile=t,e},_startDownload:function(){var t=Object.keys(this._downloadList).length;if(0!==this._waitingList.length)if(t>=this._maxSimultaneousDownloads)s.publish("/XCityTools/Downloader/isBusy");else{var i=this._getDownloadRequest(0);this._downloadList[i.url]=i,this._addDatasetLogEntry(i);var n=i.options.withCredentials||this.isAPlatformService(i.url);if(i.options.image){var a=r.ImageUtils;void 0!==i.textureLOD?this._loadTextureLOD(i.textureLOD,i.url,void 0,i.options.onComplete,i.options.onFailure,n):(a.crossOrigin=n?"use-credentials":"anonymous",i.url.indexOf(".dds")===i.url.length-4?a.loadCompressedTexture(i.url,void 0,i.options.onComplete,i.options.onFailure,n):i.url.indexOf(".basis")===i.url.length-6||i.options.basis?a.loadBasisTexture(i.url,void 0,i.options.onComplete,i.options.onFailure,n,r.BasisUsage.RGBA):i.url instanceof Array?a.loadTextureCube(i.url,void 0,i.options.onComplete,i.options.onFailure,n):a.loadTexture(i.url,void 0,i.options.onComplete,i.options.onFailure,n))}else{let t;t=n&&"xCityFakePlatform"!==this._platformID?e.authenticatedRequest(i.url,i.options).cancel:e.request(i.url,i.options).cancel,this._downloadList[i.url].cancelDownload=t}}else 0===t&&s.publish("/XCityTools/Downloader/isFree")},loadTexture:function(e,t,i){if(!(t instanceof Array)&&this.wasAPlatformService(t)){var r=t.split("resources/");if(2===r.length){var s=r[1].split("?")[0],n=this.getUuidFromUrl(t);t=this.getDataSupplierUrl()+n+"/resources/"+s+"?tenant="+this._platformID}}this.download(t,{image:!0},void 0!==i?i:999999,function(e,t,i,r){r(t,e,i)},void 0,e)},loadJSON:function(e,t,i){this.download(t,{},void 0!==i?i:99999,function(e,t,i,r){r(t,e,i)},void 0,e)},authenticatedRequest:function(t,i){e.authenticatedRequest(t,i)},getUrlOptions:function(e){if(e){var t=e.split("?")[1],i="";return Utils.is(t)&&(i+="?"+t),i}return null},_getDatasetIDFromUrl(e){const t=function(e){return-1!==e.search("http://")?e.substring("http://".length,e.length):-1!==e.search("https://")?e.substring("https://".length,e.length):null},i=this.getUuidFromUrl(e);if(i)return i;if(-1!==e.search("/[0-9]+/[0-9]+/[0-9]+")){return t(e.substring(0,e.search("/[0-9]+/[0-9]+/[0-9]+")))}if(-1!==e.search("&x=[0-9]+&y=[0-9]+&z=[0-9]+")){return t(e.substring(0,e.search("&x=[0-9]+&y=[0-9]+&z=[0-9]+")))}return null},getUuidFromUrl:function(e){if(!e||!e.split)return null;var t,i=e.split("/datasupplier/dataset/");if(2===i.length){if((t=i[1].split("/")).length>0)return t[0]}else if(2===(i=e.split("/datasupplier/")).length&&(t=i[1].split("/")).length>0)return t[0];return null},getDataSupplierUrl:function(e){return e?"%globe%/datasupplier/":"%globe%/datasupplier/dataset/"},getDataSupplierUrlFromUrl:function(e){if(this.wasAPlatformService(e)){var t=this.getUrlOptions(e),i=this.getUuidFromUrl(e),r=this.getDataSupplierUrl();return Utils.is(i)&&(r+=i+"/"),!0===window.URBANODT&&(r+=".response"),Utils.is(t)&&(r+=t),r}return e},_failedServiceUrl:function(e){console.warning("failedGetServiceUrl",e)},_failedPlatformServices:function(e){console.warning("failedGetPklatformservices",e)},getResourcesUrlFromUrl:function(e){if(this.isAPlatformService(e)){var t=this.getUrlOptions(e),i=this.getUuidFromUrl(e),r=this.getDataSupplierUrl();return Utils.is(i)?(r+=i+"/",r+="resources/",Utils.is(t)&&(r+=t),r):e}return e},wasAPlatformService:function(e){if(Utils.is(e)){var t=this.isAPlatformService(e);if(!t)2===e.split("datasupplier/").length&&(t=!0);return t}return!1}};var d=null;return null===d&&(d=new h),d}),define("DS/XCityTools/PrimitiveGeometryCreator",["DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/XCityTools/Debug"],function(e,t,i){"use strict";var r=UWA.Class.extend({init:function(e){this.processPrimitive=!1,this.verticesPerFace=3,this.nbBuffers=0,this.nbPrimitives=0,this.primitiveList=[],this.current=void 0,this.normal=void 0,this.color=void 0,this.texcoord=void 0,this.usercomp=void 0,this.vertexBindingArray=void 0,this.faceBindingArray=void 0,this.primitiveBindingArray=void 0,this.userBindingArray=void 0;var i=function(e,i,r){var s=this.nbBuffers++,n=new t.Buffer;return null!=e?n.component=e:n.indexBuffer=!0,n.format=i,n.dimension=r,n.data=[],n.size=0,{id:s,buffer:n}}.bind(this);this.normalBinding=void 0,this.colorBinding=void 0,this.texCoordBinding=void 0,this.userCompBinding=void 0;var s,n=function(e){switch(e){case r.Binding.FACE:return void 0===this.faceBindingArray&&(this.faceBindingArray=i(void 0,t.DataTypeEnum.UINT,1)),e;case r.Binding.PRIMITIVE:return void 0===this.primitiveBindingArray&&(this.primitiveBindingArray=i(void 0,t.DataTypeEnum.UINT,1)),e;case r.Binding.CUSTOM:return void 0===this.userBindingArray&&(this.userBindingArray=i(void 0,t.DataTypeEnum.UINT,1)),e;case r.Binding.VERTEX:default:return r.Binding.VERTEX}}.bind(this);if(this.position=i(t.VertexComponentEnum.POSITION,t.DataTypeEnum.FLOAT,3),this.indexed=!!e.indexed&&e.indexed,this.vertexBindingArray=i(void 0,t.DataTypeEnum.UINT,1),void 0!==e.useNormal?!0===e.useNormal&&(this.normal=i(t.VertexComponentEnum.NORMAL,t.DataTypeEnum.FLOAT,3),this.normalBinding=n(e.normalBinding)):(this.normal=i(t.VertexComponentEnum.NORMAL,t.DataTypeEnum.FLOAT,3),this.normalBinding=n(e.normalBinding)),e.useColor&&(this.color=i(t.VertexComponentEnum.DIFFUSE_COLOR,t.DataTypeEnum.FLOAT,4),this.colorBinding=n(e.colorBinding)),e.useTexCoord){this.texcoord=[],this.texCoordBinding=[];var a=e.nbTexCoord?e.nbTexCoord:1;for((0===a||a>8)&&(a=1),s=0;s<a;++s)this.texcoord.push(i(t.VertexComponentEnum.TEX_COORD_0+s,t.DataTypeEnum.FLOAT,3)),e.texCoordBinding&&e.texCoordBinding.length?this.texCoordBinding.push(n(e.texCoordBinding[s])):this.texCoordBinding.push(n(e.texCoordBinding))}if(e.useUserComp){this.usercomp=[],this.userCompBinding=[];var o=e.nbUserComp?e.nbUserComp:1;for((0===o||o>8)&&(o=1),s=0;s<o;++s)this.usercomp.push(i(t.VertexComponentEnum.USER_COMPONENT_0+s,t.DataTypeEnum.FLOAT,3)),e.userCompBinding&&e.userCompBinding.length?this.userCompBinding.push(n(e.userCompBinding[s])):this.userCompBinding.push(n(e.userCompBinding))}},_concat:function(e,t){var i;for(i=t.length;i;i--)e.push(t[t.length-i])},pushVertexIndices:function(e){if(this.processPrimitive&&e instanceof Array){var t,i,r,s,n,a;if(this._concat(this.current.vertexBindingArray,e),this.faceBindingArray)for(t=0,i=e.length;t<i;++t)if((r=this.current.nbVertexIndices+t)%this.verticesPerFace==0){for(s=Math.floor(r/this.verticesPerFace),n=[],a=this.verticesPerFace;a--;)n.push(s);this._concat(this.current.faceBindingArray,n)}this.current.nbVertexIndices+=e.length}},pushVertex:function(e){this.processPrimitive&&e instanceof Array&&3===e.length&&(this.indexed||this.pushVertexIndices([this.current.nbVertices]),this.current.position.push(e[0]),this.current.position.push(e[1]),this.current.position.push(e[2]),this.current.nbVertices++)},pushNormal:function(e){this.processPrimitive&&e instanceof Array&&3===e.length&&(this.current.normal.push(e[0]),this.current.normal.push(e[1]),this.current.normal.push(e[2]),this.current.nbNormals++)},pushColor:function(e){this.processPrimitive&&void 0!==this.color&&e instanceof Array&&4===e.length&&(this.current.color.push(e[0]),this.current.color.push(e[1]),this.current.color.push(e[2]),this.current.color.push(e[3]),this.current.nbColors++)},pushTexCoord:function(e,t){this.processPrimitive&&void 0!==this.texcoord&&void 0!==this.texcoord[e]&&t instanceof Array&&(this.current.texcoord[e].push(t[0]),this.current.texcoord[e].push(t[1]),3===t.length?this.current.texcoord[e].push(t[2]):this.current.texcoord[e].push(0))},pushUserComp:function(e,t){this.processPrimitive&&void 0!==this.usercomp&&void 0!==this.usercomp[e]&&t instanceof Array&&(this.current.usercomp[e].push(t[0]),this.current.usercomp[e].push(t[1]),this.current.usercomp[e].push(t[2]))},startPrimitive:function(e){if(!this.processPrimitive){var i,r;if(this.processPrimitive=!0,this.current={},this.current.connectivity=void 0!==e?e:t.ConnectivityTypeEnum.TRIANGLES,this.current.nbVertexIndices=0,this.current.vertexBindingArray=[],this.faceBindingArray&&(this.current.faceBindingArray=[]),this.primitiveBindingArray&&(this.current.primitiveBindingArray=[]),this.userBindingArray&&(this.current.userBindingArray=[]),this.current.nbVertices=0,this.current.position=[],this.current.nbNormals=0,this.current.normal=[],this.color&&(this.current.color=[],this.current.nbColors=0),this.texcoord)for(this.current.texcoord=[],this.current.nbTexcoord=[],i=0,r=this.texcoord.length;i<r;++i)this.current.texcoord.push([]),this.current.nbTexcoord.push(0);if(this.usercomp)for(this.current.usercomp=[],this.current.nbUserComp=[],i=0,r=this.usercomp.length;i<r;++i)this.current.usercomp.push([]),this.current.nbUserComp.push(0)}},endPrimitive:function(e,s){if(this.processPrimitive)if(0!==this.current.nbVertexIndices){var n=function(e,i,s,n){var a=new t.VertexComponent;switch(a.nbValuesPerVertex=i.buffer.dimension,a.component=i.buffer.component,a.format=i.buffer.format,a.nbVertices=s,a.bufferId=i.id,a.offset=i.buffer.size/a.nbValuesPerVertex,n){case r.Binding.FACE:a.indices=new t.IndexArray,a.indices.format=this.faceBindingArray.buffer.format,a.indices.bufferId=this.faceBindingArray.id,a.indices.offset=this.faceBindingArray.buffer.size;break;case r.Binding.PRIMITIVE:a.indices=new t.IndexArray,a.indices.format=this.primitiveBindingArray.buffer.format,a.indices.bufferId=this.primitiveBindingArray.id,a.indices.offset=this.primitiveBindingArray.buffer.size;break;case r.Binding.CUSTOM:a.indices=new t.IndexArray,a.indices.format=this.userBindingArray.buffer.format,a.indices.bufferId=this.userBindingArray.id,a.indices.offset=this.userBindingArray.buffer.size;break;case r.Binding.VERTEX:default:a.indices=new t.IndexArray,a.indices.format=this.vertexBindingArray.buffer.format,a.indices.bufferId=this.vertexBindingArray.id,a.indices.offset=this.vertexBindingArray.buffer.size}e.addVertexComponent(a)}.bind(this),a=1;s&&(a=0);var o,l,h=new t.Primitive;if(h.identifier=void 0===e||""===e?this.nbPrimitives:e,h.nbIndices=this.current.nbVertexIndices,h.connectivity=this.current.connectivity,h.attr={fill:new t.FillAttributes(null,a),line:new t.LineAttributes,point:new t.PointAttributes(new t.Color(1,0,0,1),50)},n(h,this.position,this.current.nbVertices),this.normal&&n(h,this.normal,this.current.nbNormals,this.normalBinding),this.color&&n(h,this.color,this.current.nbColors,this.colorBinding),this.texcoord)for(o=0,l=this.texcoord.length;o<l;++o)n(h,this.texcoord[o],this.current.nbTexcoord[o],this.texCoordBinding[o]);if(this.usercomp)for(this.current.usercomp=[],o=0,l=this.usercomp.length;o<l;++o)n(h,this.usercomp[o],this.current.nbUserComp[o],this.userCompBinding[o]);if(this._concat(this.position.buffer.data,this.current.position),this.position.buffer.size+=this.current.position.length,this.normal&&(this._concat(this.normal.buffer.data,this.current.normal),this.normal.buffer.size+=this.current.normal.length),this.color&&(this._concat(this.color.buffer.data,this.current.color),this.color.buffer.size+=this.current.color.length),this.texcoord)for(o=0,l=this.texcoord.length;o<l;++o)this._concat(this.texcoord[o].buffer.data,this.current.texcoord[o]),this.texcoord[o].buffer.size+=this.current.texcoord[o].length;if(this.usercomp)for(o=0,l=this.usercomp.length;o<l;++o)this._concat(this.usercomp[o].buffer.data,this.current.usercomp[o]),this.usercomp[o].buffer.size+=this.current.usercomp[o].length;if(this._concat(this.vertexBindingArray.buffer.data,this.current.vertexBindingArray),this.vertexBindingArray.buffer.size+=this.current.vertexBindingArray.length,this.faceBindingArray&&(this._concat(this.faceBindingArray.buffer.data,this.current.faceBindingArray),this.faceBindingArray.buffer.size+=this.current.faceBindingArray.length),this.primitiveBindingArray){for(var d=[],u=this.current.nbVertexIndices;u--;)d.push(0);this._concat(this.primitiveBindingArray.buffer.data,d),this.primitiveBindingArray.buffer.size+=this.current.nbVertexIndices}this.userBindingArray&&(this._concat(this.userBindingArray.buffer.data,this.current.userBindingArray),this.userBindingArray.buffer.size+=this.current.userBindingArray.length),this.primitiveList.push(h),this.nbPrimitives++,this.current=void 0,this.processPrimitive=!1}else i.warn("PrimitiveGeometryCreator: Vertex indices is empty.")},compilePrimitive:function(i,r,s){var n=new t.PrimitiveGroup;void 0!==r&&(n.editable=!0),n.name=i;var a,o,l=1;if(s&&(l=0),n.fillAttr=new t.FillAttributes(null,l),n.lineAttr=new t.LineAttributes,n.pointAttr=new t.PointAttributes,this.position.buffer.data=new Float32Array(this.position.buffer.data),this.normal&&(this.normal.buffer.data=new Float32Array(this.normal.buffer.data)),this.color&&(this.color.buffer.data=new Float32Array(this.color.buffer.data)),this.texcoord)for(a=0,o=this.texcoord.length;a<o;++a)this.texcoord[a].buffer.data=new Float32Array(this.texcoord[a].buffer.data);if(this.usercomp)for(a=0,o=this.usercomp.length;a<o;++a)this.usercomp[a].buffer.data=new Float32Array(this.usercomp[a].buffer.data);if(e.supportedExtensions&&e.supportedExtensions.elementIndexUint?(this.vertexBindingArray.buffer.data=new Uint32Array(this.vertexBindingArray.buffer.data),this.faceBindingArray&&(this.faceBindingArray.buffer.data=new Uint32Array(this.faceBindingArray.buffer.data)),this.primitiveBindingArray&&(this.primitiveBindingArray.buffer.data=new Uint32Array(this.primitiveBindingArray.buffer.data)),this.userBindingArray&&(this.userBindingArray.buffer.data=new Uint32Array(this.userBindingArray.buffer.data))):(this.vertexBindingArray.buffer.data=new Uint16Array(this.vertexBindingArray.buffer.data),this.faceBindingArray&&(this.faceBindingArray.buffer.data=new Uint16Array(this.faceBindingArray.buffer.data)),this.primitiveBindingArray&&(this.primitiveBindingArray.buffer.data=new Uint16Array(this.primitiveBindingArray.buffer.data)),this.userBindingArray&&(this.userBindingArray.buffer.data=new Uint16Array(this.userBindingArray.buffer.data))),n.addBuffer(this.position.id,this.position.buffer),this.normal&&n.addBuffer(this.normal.id,this.normal.buffer),this.color&&n.addBuffer(this.color.id,this.color.buffer),this.texcoord)for(a=0,o=this.texcoord.length;a<o;++a)n.addBuffer(this.texcoord[a].id,this.texcoord[a].buffer);if(this.usercomp)for(a=0,o=this.usercomp.length;a<o;++a)n.addBuffer(this.usercomp[a].id,this.usercomp[a].buffer);for(n.addBuffer(this.vertexBindingArray.id,this.vertexBindingArray.buffer),this.faceBindingArray&&n.addBuffer(this.faceBindingArray.id,this.faceBindingArray.buffer),this.primitiveBindingArray&&n.addBuffer(this.primitiveBindingArray.id,this.primitiveBindingArray.buffer),this.userBindingArray&&n.addBuffer(this.userBindingArray.id,this.userBindingArray.buffer),a=this.nbPrimitives;a;a--)n.addPrimitive(this.primitiveList[this.nbPrimitives-a]);return n}});return r.Binding={VERTEX:0,FACE:1,PRIMITIVE:2,CUSTOM:3},r}),define("DS/XCityTools/Disposer",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityTools/Debug","DS/XCityTools/ShaderTools"],function(e,t,i,r,s){"use strict";return{traverseV6:function(e,i){if(this.dispose(e,i)){if(r.log("dispose : "+e.name),e instanceof t){for(var s=0,n=e.children.length;s<n;s++)this.traverseV6(e.children[s],i);e.removeChildren()}e.node instanceof t&&this.traverseV6(e.node,i)}},dispose:function(i,r,n){if(!i)return!1;if(!i._globePool||(i._globePool.recycle(i),r)){if(!0!==r&&void 0!==i.shared&&0!==i.shared&&1!==i.shared){if(i.shared>1)return i.shared--,!1;if(i.shared<0)return!1}if(i instanceof Array)for(var a=0;a<i.length;a++)this.dispose(i[a],r,n);if(i.lineBuilder&&i.lineBuilder.dispose(),i.observers){var o=i.observers.length;for(a=0;a<o;a++)i.observers[a](i);i.observers=null}if(i.userData=null,null!==i.material&&this.dispose(i.material,r),i instanceof e.Material){if(i._PDSFXData&&i._PDSFXData.pdsfxUniforms.raster)if(i._PDSFXData.pdsfxUniforms.raster.value instanceof e.Texture)this.dispose(i._PDSFXData.pdsfxUniforms.raster.value,r);else if(i._PDSFXData.pdsfxUniforms.raster.value instanceof Array)for(var l=0;l<i._PDSFXData.pdsfxUniforms.raster.value.length;l++)this.dispose(i._PDSFXData.pdsfxUniforms.raster.value[l],r);if(void 0!==i.map&&null!==i.map&&(this.dispose(i.map,r),i.image=null,i.map.textures&&i.map.textures.length>0)){i.map.usedTexture;i.map.usedTexture=-1}var h,d,u=i.uniforms;if(u)for(d in s.unregisterAnimationUniforms(i),u)if("t"===(h=u[d]).type&&h.value&&h.value instanceof e.Texture)this.dispose(h.value,r,n),h.value.onLoadCallbacks=null,h.value.onUpdate=null;else if("tv"===h.type&&h.value)for(var c=0;c<h.value.length;c++)h.value[c]&&h.value[c]instanceof e.Texture&&(h.value[c].onUpdate=void 0,h.value[c].onLoadCallbacks=void 0,this.dispose(h.value[c],r,n),h.value[c]=void 0);if(i._PDSFXData)if(u=i._PDSFXData.pdsfxUniforms)for(d in s.unregisterAnimationUniforms(i),u)if("t"!==(h=u[d]).type&&"t2"!==h.type||!h.value){if("tv"===h.type&&h.value)for(c=0;c<h.value.length;c++)h.value[c]&&(h.value[c].onUpdate=void 0,h.value[c].onLoadCallbacks=void 0,this.dispose(h.value[c],r,n),h.value[c]=void 0)}else this.dispose(h.value,r,n),h.value.onLoadCallbacks=null,h.value.onUpdate=null}if((i instanceof e.Texture||i instanceof e.DataTexture)&&i.__webglInit&&i.dispatchEvent({type:"dispose"}),i.mesh3js){var p=i.mesh3js;if(void 0!==p.material&&this.dispose(p.material,r),p.geometry&&p.geometry.length>0)for(a=0;a<p.geometry.length;a++){var f=p.geometry[a];this.dispose(f,r,n)}}if(i.drawingGroups&&i.drawingGroups.length>0)for(a=0;a<i.drawingGroups.length;a++)this.dispose(i.drawingGroups[a],r,n);return i instanceof t&&null!==i.material&&this.dispose(i.material,r),i.dispose?(i.dispose(),void 0!==i.needsUpdate&&(i.needsUpdate=!0)):i.dispatchEvent&&i.dispatchEvent({type:"dispose"}),i=null,!0}},disposeV6:function(e,t){this.traverseV6(e,t)}}}),define("DS/XCityLoaders/ModelLoader",["UWA/Core","DS/XCityTools/Downloader","DS/xCityBasicUtils/Utils"],function(e,t,i){"use strict";var r=UWA.Class.singleton({init:function(e){this.urban=e},load:function(e,t,r){e&&(e.gasSharing=!1),this._initModelUrl(e);var s=this._initModelExtension(e),n=new this.formatLoaders[s](this.urban,e);e.uuid=UWA.Utils.getUUID();var a=function(e){i.is(r)&&r(e)};return a({loaded:0,total:1}),n.load(function(e,r,s,n,a){i.is(t)&&t(e,r,s,n,a)},a)},_initModelUrl:function(e){return i.is(e.url)?e.url=t.resolveUrl(e.url):e.url="",e.url},_initModelExtension:function(e){return e.extension=e.extension||i.extractExtension(e.url),i.is(this.formatLoaders[e.extension])?e.extension:"defaultLoader"}});return r.formatLoaders={},r}),define("DS/XCityCore/Store",["DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader","DS/XCityTools/Disposer","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools"],function(e,t,i,r,s,n,a){"use strict";var o=function(e,t){void 0!==e.value&&null!==e.value&&(e.oldValue.push(e.value),e.value=void 0),e.value=t,e.value.sourceFile=e.url,e.value.needsUpdate=!0},l=function(t,i){void 0!==t.value&&null!==t.value&&(t.oldValue.push(t.value),t.value=void 0);var r=new Float32Array(i);t.value=new e.DataTexture(r,this._tileInfo.width,this._tileInfo.height,e.LuminanceFormat,e.FloatType),t.value.sourceFile=t.url,t.value.bounds={min:r[this._tileInfo.width*this._tileInfo.height],max:r[this._tileInfo.width*this._tileInfo.height+1]},THREEDS.Core.supportedExtensions&&null===THREEDS.Core.supportedExtensions.textureFloatLinear?(t.value.magFilter=e.NearestFilter,t.value.minFilter=e.NearestFilter):(t.value.magFilter=e.LinearFilter,t.value.minFilter=e.LinearFilter),t.value.wrapS=e.ClampToEdgeWrapping,t.value.wrapT=e.ClampToEdgeWrapping,t.value.needsUpdate=!0},h=function(e,t){n.is(t.withCredentials)&&(e.withCredentials=t.withCredentials),n.is(t.module)&&(e.module=t.module),n.is(t.responseType)&&(e.responseType=t.responseType),n.is(t.type)&&(e.type=t.type),n.is(t.headers)&&(e.headers=t.headers),n.is(t.image)&&(e.image=t.image),n.is(t.builder)&&(e.builder=t.builder)},d=function(e,t){this._name=e,this._data={},this._toClean=[],this._priority=t.priority?Math.max(0,t.priority):0,this._timestamp=0,this._cacheSize=0,this._temporalParam={},this._baseURL,this._dlOptions={},this._worldSize,this._shiftedPosition,this._tileInfo={width:1,height:1},this._streamvisu=t.streamvisu,this._rendering=t.rendering,this._dataDownloader,this._dataBuilder,this._dataCleaner,this._dataUpdater,this._resultEditor,this._temporalParam.hasToBeConsidered=!!t.listenToDateUpdate&&t.listenToDateUpdate,this._temporalParam.up=t.upTime?t.upTime:void 0,this._temporalParam.down=t.downTime?t.downTime:void 0,this._baseURL=t.url?t.url:void 0,this._cacheSize=t.cacheSize?t.cacheSize:0,this._invertY=!!t.invertY&&t.invertY,h(this._dlOptions,t.dlOptions?t.dlOptions:{}),t.dataDownloader?(this._dataDownloader=t.dataDownloader,this._dataDLCanceler=t.dataDLCanceler):(t.tile?(this._dataDownloader=function(e,t,r,n,a){if(void 0!==this._baseURL){var o;if(void 0!==t&&void 0!==t.tile)e.bbox={xmin:0,xmax:0,ymin:0,ymax:0},o=this._worldSize.x/(1<<t.tile.LOD),e.bbox.xmin=t.tile.I*o+this._shiftedPosition.x,e.bbox.xmax=(t.tile.I+1)*o+this._shiftedPosition.x,o=this._worldSize.y/(1<<t.tile.LOD),e.bbox.ymin=t.tile.J*o+this._shiftedPosition.y,e.bbox.ymax=(t.tile.J+1)*o+this._shiftedPosition.y,e.tile=t.tile;else if(void 0===e.tile)return void s.warn("XCityCoreStore '"+this._name+"': No bbox information given... What should we download ?");var l=this._invertY?(1<<e.tile.LOD)-1-e.tile.J:e.tile.J;e.url=this._baseURL.replace("%l",e.tile.LOD).replace("%x",e.tile.I).replace("%y",l);var h=Array.prototype.slice.call(arguments,2);if(h.unshift(e.url,e.dlOptions),this._streamvisu){var d={name:e.url,url:e.url,urlOptions:void 0,_shifted:!0,shader:[{name:"road"},{name:"ocean"}],rendering:this._rendering,terrain:!0},u=xCity._urbanImpl.modelLoader.load(d,h[3]),c=u.getMatrix();c.elements[12]=-xCity._urbanImpl.shiftedPosition.x,c.elements[13]=-xCity._urbanImpl.shiftedPosition.y,u.setMatrix(c),u.name=e.url}else{if(a._setProgress&&a._getProgress){let e=a._getProgress(),t=e&&e.total||0,i=e&&e.loaded||0;a._setProgress({loaded:i,total:t+1})}i.download.apply(i,h)}}else s.warn("XCityCoreStore '"+this._name+"': No URL template was defined... What should we download ?")}.bind(this),this._worldSize=void 0!==t.tile.worldSize?{x:t.tile.worldSize,y:t.tile.worldSize}:{x:0,y:0},this._shiftedPosition=void 0!==t.tile.shiftedPosition?n.clone(t.tile.shiftedPosition):{x:0,y:0}):t.wms?(this._dataDownloader=function(e,t,r,n,a){if(void 0!==this._baseURL){var o;if(void 0!==t&&void 0!==t.tile)e.bbox={xmin:0,xmax:0,ymin:0,ymax:0},o=this._worldSize.x/(1<<t.tile.LOD),e.bbox.xmin=t.tile.I*o+this._shiftedPosition.x,e.bbox.xmax=(t.tile.I+1)*o+this._shiftedPosition.x,o=this._worldSize.y/(1<<t.tile.LOD),e.bbox.ymin=t.tile.J*o+this._shiftedPosition.y,e.bbox.ymax=(t.tile.J+1)*o+this._shiftedPosition.y,e.tile=t.tile;else if(void 0===e.bbox)return void s.warn("XCityCoreStore '"+this._name+"': No wms information given... What should we download ?");e.url=this._baseURL.replace(/\%xmin/g,e.bbox.xmin).replace(/\%xmax/g,e.bbox.xmax).replace(/\%ymin/g,e.bbox.ymin).replace(/\%ymax/g,e.bbox.ymax).replace(/\%currentdate/g,e.tile.T);var l=Array.prototype.slice.call(arguments,2);l.unshift(e.url,e.dlOptions),i.download.apply(i,l)}else s.warn("XCityCoreStore '"+this._name+"': No URL template was defined... What should we download ?")}.bind(this),this._worldSize=void 0!==t.wms.worldSize?{x:t.wms.worldSize,y:t.wms.worldSize}:{x:0,y:0},this._shiftedPosition=void 0!==t.wms.shiftedPosition?n.clone(t.wms.shiftedPosition):{x:0,y:0}):t.bbox?this._dataDownloader=function(e,t,r,n,a){if(void 0!==this._baseURL){if(void 0!==t&&void 0!==t.bbox)e.bbox=t.bbox;else if(void 0===e.bbox)return void s.warn("XCityCoreStore '"+this._name+"': No bbox information given... What should we download ?");e.url=this._baseURL.replace(/\%xmin/g,e.bbox.xmin).replace(/\%xmax/g,e.bbox.xmax).replace(/\%ymin/g,e.bbox.ymin).replace(/\%ymax/g,e.bbox.ymax),t.tile&&t.tile.T&&(e.url=e.url.replace(/\%currentdate/g,t.tile.T));var o=Array.prototype.slice.call(arguments,2);o.unshift(e.url,e.dlOptions),i.download.apply(i,o)}else s.warn("XCityCoreStore '"+this._name+"': No URL template was defined... What should we download ?")}.bind(this):this._dataDownloader=function(e,t,r,n,a){if(void 0!==t&&void 0!==t.url)void 0===this._baseURL?e.url=t.url:e.url=this._baseURL+t.url;else if(void 0===e.url)return void s.warn("XCityCoreStore '"+this._name+"': No URL defined... What should we download ?");var o=Array.prototype.slice.call(arguments,2);o.unshift(e.url,e.dlOptions),i.download.apply(i,o)}.bind(this),this._dataDLCanceler=function(e){void 0!==e.url&&i.cancel(e.url)}.bind(this)),t.dataBuilder?this._dataBuilder=t.dataBuilder:t.texture?(this._dataBuilder=o.bind(this),this._dlOptions.image=!0):t.basisTexture?(this._dataBuilder=o.bind(this),this._dlOptions.image=!0,this._dlOptions.basis=!0):t.floatTexture?(t.floatTexture.width&&t.floatTexture.height?(this._tileInfo.width=t.floatTexture.width,this._tileInfo.height=t.floatTexture.height):t.floatTexture.size?(this._tileInfo.width=t.floatTexture.size,this._tileInfo.height=t.floatTexture.size):s.warn("Store '"+this._name+"': Missing tile size information. Set to 1."),this._dataBuilder=l.bind(this),this._dlOptions.responseType="arraybuffer"):this._dataBuilder=function(e,t){void 0!==e.value&&null!==e.value&&(e.oldValue.push(e.value),e.value=void 0),e.value=t}.bind(this),t.dataCleaner?this._dataCleaner=t.dataCleaner:this._dataCleaner=r.disposeV6.bind(r),t.dataUpdater?this._dataUpdater=t.dataUpdater:this._dataUpdater=function(e){},t.onFinish&&(this._onFinish=t.onFinish),t.resultEditor&&(this._resultEditor=t.resultEditor),t.setProgress&&(this._setProgress=t.setProgress),t.getProgress&&(this._getProgress=t.getProgress)};d.prototype={_updateDataTimeStamp:function(e){e.timestamp=this._timestamp,this._dataUpdater(e)},_getData:function(e){var t=this._data[e];if(void 0!==t)return this._updateDataTimeStamp(t),t},_storeData:function(e,t,i,r,s){var n,a;if(this._getProgress&&this._getProgress){let e=this._getProgress(),t=e&&e.total||0,i=e&&e.loaded||0;this._setProgress({loaded:i+1,total:t})}if(void 0!==(n=this._data[r])&&(void 0===n.value||n.deprecated)&&s==n.requeststamp){if(e&&void 0===i&&(i={status:200}),e&&204!==i.status){if(void 0!==n.dlOptions.builder&&"texture"===n.dlOptions.builder)o.call(this,n,t);else if(void 0!==n.dlOptions.builder&&"textureFloat"===n.dlOptions.builder)l.call(this,n,t);else if(this._resultEditor){var h=this._resultEditor(t,n.tile,n);null!=h&&this._dataBuilder(n,h)}else this._dataBuilder(n,t);void 0!==n.value&&null!==n.value&&(n.value.storeId=this._name,n.value.storeKey=n.key),n.deprecated=!1}else 0===n.locks?(n.value=null,n.deprecated=!1):n.deprecated=!0;a=n.callbacks,n.callbacks=[],a.forEach(function(t){t.opt.unshift(e,n.value),e?t.opt.push(i&&i.status?i.status:200):t.opt.push(!1),t.func.apply(t.bound,t.opt)})}},_storeModelData:function(e,t,i,r,s){var n,a;void 0!==(n=this._data[e])&&(void 0===n.value||n.deprecated)&&(r?(void 0!==n.dlOptions.builder&&"texture"===n.dlOptions.builder?o.call(this,n,i):void 0!==n.dlOptions.builder&&"textureFloat"===n.dlOptions.builder?l.call(this,n,i):(i.setVisibility(!0),this._dataBuilder(n,i)),void 0!==n.value&&null!==n.value&&(n.value.storeId=this._name,n.value.storeKey=n.key),n.deprecated=!1):0===n.locks?(n.value=null,n.deprecated=!1):n.deprecated=!0,a=n.callbacks,n.callbacks=[],a.forEach(function(e){e.opt.unshift(r,n.value),r?e.opt.push(200):e.opt.push(!1),e.func.apply(e.bound,e.opt)}))},clean:function(e){for(var t,i,r=[],n=function(e,t){return null===this._data[e].value||void 0===this._data[e].value?-1:null===this._data[t].value||void 0===this._data[t].value?1:this._data[e].timestamp-this._data[t].timestamp}.bind(this),a=Object.keys(this._data),o=0,l=a.length;o<l;o++)for((e||0===this._data[a[o]].locks&&!1===this._data[a[o]].undeletable&&this._data[a[o]].timestamp<this._timestamp)&&r.push(a[o]);this._data[a[o]].oldValue.length>0;)this._toClean.push(this._data[a[o]].oldValue.pop());if(e||r.length>this._cacheSize)for(e||r.sort(n),d=e?r.length:r.length-this._cacheSize;d--;){if(i=r.shift(),(t=this._data[i]).locks>0&&s.warn("STORE -  "+this._name+": A locked resource is deleted!"),this.cancelDownloadData(i),void 0!==t.value&&null!==t.value&&this._toClean.push(t.value),t.value=void 0,t.callbacks.length>0){var h=t.callbacks;t.callbacks=void 0,h.forEach(function(e){e.opt.unshift(!1,void 0),e.func.apply(e.bound,e.opt)})}t.callbacks=void 0,delete this._data[i]}for(var d=this._toClean.length;d--;){var u=this._toClean.pop();this._dataCleaner(u),u._globePool||(u=null)}},getData:function(e){var t=this._getData(e);if(void 0!==t)return t.deprecated&&(this._streamvisu||(t.requeststamp=this._timestamp,this._dataDownloader(t,{},this._priority,this._storeData,this,e,t.requeststamp)),0===t.locks)?null:t.value},getOrDownloadData:function(e,t,i,r){var s,n;void 0===t&&(t={}),this._onFinish&&(n={func:this._onFinish.func,bound:this._onFinish.bound,opt:Array.prototype.slice.call(arguments,4)}),i&&(s={func:i,bound:r,opt:Array.prototype.slice.call(arguments,4)});var a=this._getData(e);if(void 0!==a){if(a.deprecated);else if(void 0!==a.value&&a.isVisible===t.isVisible)return void 0!==s&&(s.opt.unshift(null!==a.value,a.value),s.func.apply(s.bound,s.opt)),a.value}else a={key:e,value:void 0,oldValue:[],url:void 0,tile:void 0,bbox:void 0,timestamp:this._timestamp,requeststamp:this._timestamp,dlOptions:this._dlOptions,callbacks:[],locks:0,deprecated:!1,isVisible:!0,tmp:!1,undeletable:!1,temporary:!0},t.undeletable&&(a.undeletable=!0),this._streamvisu&&(a.alreadyDL=!1),Object.seal(a),this._data[e]=a,void 0!==n&&a.callbacks.push(n);return h(a.dlOptions,t),a.isVisible=t.isVisible,void 0!==s&&a.callbacks.push(s),a.requeststamp=this._timestamp,this._streamvisu?a.alreadyDL||(this._dataDownloader(a,t,t.priority?this._priority+t.priority:this._priority,this._storeModelData.bind(this,e,a.requeststamp),this,e,a.requeststamp),a.alreadyDL=!0):this._dataDownloader(a,t,t.priority?this._priority+t.priority:this._priority,this._storeData,this,e,a.requeststamp),void 0!==a.value&&null!==a.value&&(a.value.tmp=a.tmp,a.value.temporary=a.temporary),a.value},cancelDownloadData:function(e){if(void 0!==this._dataDLCanceler&&null!==this._dataDLCanceler){var t,i=this._getData(e);void 0!==i&&(this._dataDLCanceler(i),null!==i.value&&void 0!==i.value||(i.deprecated=!0),t=i.callbacks,i.callbacks=[],t.forEach(function(e){e.opt.unshift(!1,void 0),e.func.apply(e.bound,e.opt)}))}},deprecateData:function(e){var t,i,r=function(e){var t=this._data[e];void 0!==t&&(t.deprecated=!0)}.bind(this);if(e instanceof Array)for(t=0,i=e.length;t<i;++t)r(e[t]);else r(e)},updateTimeParam:function(e){e&&(e.up&&(this._temporalParam.up=e.up),e.down&&(this._temporalParam.down=e.down))},isDeprecated:function(e,t){if(!(e instanceof Array)){var i=this._data[e];if(void 0!==i)return i.deprecated}return!1},traverse:function(e,t){for(var i=Object.keys(this._data),r=0,s=i.length;r<s;r++){var n=this._data[i[r]].value;null!=n&&void 0!==n.nbFeatures&&(n=n.node),null!=n&&e(t?n:this._data[i[r]])}},lockData:function(e){var t,i,r=function(e){var t=this._data[e];if(void 0!==t&&(t.locks++,1===t.locks&&void 0!==t.value&&null!==t.value&&(void 0!==t.value.material&&null!==t.value.material||void 0!==t.value.children||void 0!==t.value.mesh3js))){t.value.traverse(function(e){if(void 0!==e.material&&null!==e.material&&a.activateAnimationUniforms(e.material),void 0!==e.mesh3js)for(var t=0;t<e.mesh3js.geometry[0].drawingGroups.length;++t){var i=e.mesh3js.geometry[0].drawingGroups[t].material;null!=i&&a.activateAnimationUniforms(i)}})}}.bind(this);if(e instanceof Array)for(t=0,i=e.length;t<i;++t)r(e[t]);else r(e)},unlockData:function(e){var t,i,r=function(e){var t=this._data[e];if(void 0!==t&&t.locks>0&&(t.locks--,0===t.locks&&void 0!==t.value&&null!==t.value&&(void 0!==t.value.material&&null!==t.value.material||void 0!==t.value.children||void 0!==t.value.mesh3js))){t.value.traverse(function(e){if(void 0!==e.material&&null!==e.material&&a.deactivateAnimationUniforms(e.material),void 0!==e.mesh3js){var t=e.mesh3js.geometry[0].drawingGroups[0].material;null!=t&&a.deactivateAnimationUniforms(t)}})}}.bind(this);if(e instanceof Array)for(t=0,i=e.length;t<i;++t)r(e[t]);else r(e)},isLocked:function(e,t){if(!(e instanceof Array)){var i=this._data[e];if(void 0!==i)return i.locks>0}return!1}};var u={},c=void 0,p=void 0,f=function(){this.createStore("default",{})};f.prototype={_getStoreInformation:function(e){return n.clone(u[e])},getStoreList:function(){return Object.keys(u)},createStore:function(e,t){void 0===u[e]?u[e]=new d(e,void 0!==t?t:{}):s.warn("Store: A store '"+e+"' is already defined. Cannot create a new one with same ID.")},deleteStore:function(e){void 0!==u[e]&&(this.cleanStore(e,!0),delete u[e])},getStore:function(e){if(void 0!==u[e])return u[e]},storeIsTimeDependant:function(e){return void 0!==u[e]&&u[e]._temporalParam.hasToBeConsidered},cleanStore:function(e,t){var i=u[e];void 0!==i&&i.clean(t)},cleanStores:function(e){var t;for(t in u)this.cleanStore(t,e)},unsubscribeCleanTo:function(){void 0!==c&&(t.unsubscribe(c),c=void 0)},subscribeCleanTo:function(e,i){var r=function(){(void 0===i||i())&&this.cleanStores()}.bind(this);this.unsubscribeCleanTo(),c=t.subscribeTo(e,r)},updateTimeStamp:function(e){var t,i=void 0===e?Date.now():e;for(t in u)u[t]._timestamp=i},unsubscribeTimeStampTo:function(){void 0!==p&&(t.unsubscribe(p),p=void 0)},subscribeTimeStampTo:function(e){this.unsubscribeTimeStampTo(),p=t.subscribeTo(e,this.updateTimeStamp.bind(this))},getData:function(e,t){var i=u[e];if(void 0!==i)return i.getData(t)},getOrDownloadData:function(e,t,i,r,s){var n=u[e];if(void 0!==n)return n.getOrDownloadData.apply(n,Array.prototype.slice.call(arguments,1))},cancelDownloadData:function(e,t){var i=u[e];void 0!==i&&i.cancelDownloadData(t)},updateTimestampData:function(e,t){var i=u[e];void 0!==i&&i._getData(t)},deprecate:function(e,t){var i=u[e];void 0!==i&&i.deprecateData(t)},deprecateAll:function(e){var t=u[e];void 0!==t&&t.deprecateData(Object.keys(t._data))},isDeprecated:function(e,t){var i=u[e];if(void 0!==i)return i.isDeprecated(t)},lock:function(e,t){var i=u[e];void 0!==i&&i.lockData(t)},unlock:function(e,t){var i=u[e];void 0!==i&&i.unlockData(t)},isLocked:function(e,t){var i=u[e];if(void 0!==i)return i.isLocked(t)},traverse:function(e,t,i){var r=u[e];if(void 0!==r)return void 0===i&&(i=!0),r.traverse(t,i)}};var m=null;return null===m&&(m=new f,window.XCityCoreStore=m),m}),define("DS/XCityModel/Item",["UWA/Class/Model","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/AABBox","DS/XCityTools/Debug","DS/XCityTools/Downloader","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils","DS/XCityCore/Store","DS/XCityTools/Debug"],function(e,t,i,r,s,n,a,o,l){"use strict";String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"g"),t)};var h=e.extend({urlRoot:"/item",metaData:{type:"",className:"Item"},setup:function(){for(var e in this.id||(this.id=UWA.Utils.getUUID()),this._attributes.id=this.id,this._itemParent=null,this._created=!1,this.userData=null,this._attributes)null===this._attributes[e]?this.addEvent("onChange:"+e,this._itemChildChanged.bind(this,e)):void 0===this._attributes[e]||this._attributes[e].setItemParent&&(this.addEvent("onChange:"+e,this._itemChildChanged.bind(this,e)),this._itemChildChanged(e,this._attributes[e]));this.addEvent("onChange:visible",this._cleanStoreWaitingList.bind(this)),this._order=-1},_cleanStoreWaitingList:function(e,t){if(!t&&a.is(this._attributes)&&a.is(this._attributes.Content)){if(this.findTags&&this.findTags("landcover"))return;var i=o.getStore(this._attributes.Content._attributes.url);if(i||(i=o.getStore(this._attributes.Content.id)),a.is(i)&&a.is(i._data))l.log("Layer unselected: removing all waiting downloads for "+this._attributes.name),Object.entries(i._data).map(e=>e[0]).forEach(e=>i.cancelDownloadData(e))}},setItemParent:function(e){!e&&this._created?(this.destroy(this._itemParent.getRoot()),this._itemParent=void 0):(this._itemParent=e,this._itemParent&&!this._created&&this._itemParent._root&&this.create(this._itemParent._root))},getItemParent:function(){return this._itemParent},getUserData:function(){return this.userData},getDownloadLog:function(){let e=void 0,t=this.getContent();return t&&(e=s.getDownloadLog(t.get("url"))),e},getFactory:function(){return this._factory},getDataModelOrder:function(){if(-1===this._order)return[];var e=this._itemParent.getDataModelOrder();return e.push(this._order),e},_itemChildChanged:function(e,t){var i=this._attributes[e];i&&i.setItemParent&&i.setItemParent(this);var r=this.previous(e);r&&r.removeItemParent&&r.removeItemParent(this),this._created&&i&&i.create&&!i._created&&i.create(this.getRoot())},removeItemParent:function(e,t){this._itemParent===e&&this._created&&(this.destroy(t||e.getRoot()),this._itemParent=void 0)},getRoot:function(){if(this._itemParent)return this._itemParent.getRoot()},toJSON:function(e){var t=this._parent();t.className=this.metaData.className;var i=(new this.__proto__.constructor)._attributes;if(e)for(var s in t)null===t[s]||void 0===t[s]||a.isEnumerable(t[s])&&0===Object.keys(t[s]).length?delete t[s]:(a.is(i[s])&&i[s]==t[s]&&delete t[s],"Geometry"!==s?"object"==typeof t[s]&&a.is(t[s])&&a.is(t[s].toJSON)&&(t[s]=t[s].toJSON(!0)):r.warn("warning : Geometry is still existing in experience datamodel"));return t},loadJSONVector3:function(e,i,r,s){var n=this.get(i);n||(n=new t.Vector3),void 0!==r.x&&void 0!==r.y?n.set(r.x,r.y,r.z):n.set(r[0],r[1],r[2]),this.set(i,n)},loadJSONColor:function(e,i,r,s){var n=this.get(i);n||(n=new t.Color),n.set(r),a.is(this.setMaterial)||a.is(this.setAttribute)||this.set(i,n)},loadJSONObject:function(e,t,i,r){this.set(t,i)},loadJSONAABox:function(e,t,r,s){r.className&&"AABBox"!==r.className||this.set(t,new i(r,e))},checkDataset:function(e,t,i,r,o,l,h){let d="undefined"!=typeof xCity&&xCity.widgetData&&xCity.widgetData.datasetCollection;if(t.Geometry&&!t.Content&&(t.Content=t.Geometry),t.Content&&t.Content.url){var u=t.Content.url,c=s.resolveUrl(u);if(s.isAPlatformService(c)){s._datasetToCheckList++;var p="";if("enovia"===t.Content.type){var f=c.replaceAll("%xmin","0.0");f=(f=(f=(f=(f=(f=f.replaceAll("%ymin","0.0")).replaceAll("%ymax","0.0")).replaceAll("%xmax","0.0")).replaceAll("%l","0")).replaceAll("%x","0")).replaceAll("%y","0"),p=f}else{var m=t.Content.objectId,g=!1;a.is(m)||(t.Content.userData&&t.Content.userData.cache&&t.Content.userData.cache.dataset&&(m=t.Content.userData.cache.dataset.uuid),a.is(m)||(m=s.getUuidFromUrl(t.Content.url)),a.is(m)&&(t.Content.objectId=m)),a.is(t.Content.userData)&&a.is(t.Content.userData.cache)&&a.is(t.Content.userData.cache.dataset)&&a.is(t.Content.userData.cache.dataset.type)&&!a.is(t.Content.userData.datasetType)&&(t.Content.userData.datasetType=t.Content.userData.cache.dataset.type),t.Content.userData&&t.Content.userData.datasetType&&"RawData"===t.Content.userData.datasetType&&(g=!0);var v=u;if(g){var _=u.split("resources/");if(2===_.length){var y=_[1].split("?")[0];v=s.getDataSupplierUrl()+m+"/resources/"+y+"?tenant="+s._platformID}}else v=s.getDataSupplierUrl()+m+"/%l/%x/%y?tenant="+s._platformID;u=t.Content.url=v,p=s.getDataSupplierUrlFromUrl(u)}var b=t.name,x=this,C=function(a,u,c){if(s._datasetToCheckList--,a){var f=JSON.parse(u);const s=f&&f.uuid;if(d&&s&&d.push(f),"RawData"!==f.type){if(t&&t.Content&&void 0!==t.Content.levelMin&&f&&f.customization&&void 0!==f.customization.startLevel&&(t.Content.levelMin=f.customization.startLevel,t.Geometry&&(t.Geometry.levelMin=f.customization.startLevel)),t&&t.Content&&void 0!==t.Content.levelMax&&f&&f.customization&&void 0!==f.customization.endLevel){var m=Math.min(42,f.customization.endLevel);t.Content.levelMax=m,t.Geometry&&(t.Geometry.levelMax=m)}t&&t.Content&&f&&void 0!==f.outputFormat&&"JsonProxy"!==f.outputFormat&&("Model3DXC"===f.outputFormat?t.Content.type="3DXC":t.Content.type="json",t.Geometry&&(t.Geometry.type=t.Content.type))}x._loadJSON(e,t,i,r,o,l,h)}else{i.decrNumChildrenToLoad();var g=c.message.substring(c.message.length-5,c.message.length-2);s.addRejectedDataset(b,p,u,c.message,Number(g))}0===s._datasetToCheckList&&(!0===e.urbanLoaded?n.publish(n.eventsList.onLoaded,this):s._datasetToCheckList=-1)};let S=d?d.get(m):null;S?C(!0,JSON.stringify(S)):s.download(p,{headers:{Accept:"application/json"}},999999,C)}else this._loadJSON(e,t,i,r,o,l,h)}else this._loadJSON(e,t,i,r,o,l,h)},loadJSON:function(e,t,i,r,s,n,a){var o=-1;void 0!==a?o=a:i&&r&&(o=i.getNumChildren()+i.getNumChildrenToLoad(),i.incrNumChildrenToLoad()),void 0!==s&&!1===s?this._loadJSON(e,t,i,r,s,o,n):this.checkDataset(e,t,i,r,s,o,n)},loadJSONFile:function(e){var t=JSON.parse(e);return this.loadJSON(this._urban,t,void 0)},_loadJSON:function(e,t,i,s,o,l,d){var u=!1;a.is(t.Content)&&(u=!0);try{for(var c in t){var p=t[c];if(("Geometry"!==c||!u)&&("Geometry"!==c||u||(c="Content"),null!==p))if(void 0!==this.loaderJSON&&this.loaderJSON[c])this[this.loaderJSON[c]].apply(this,[e,c,p,i,d]);else if(void 0!==this.get(c))if(!(p.className||p instanceof Object)||p instanceof Array)this.set(c,t[c]);else{var f=p.className||c,m=h.ObjectContructor[f];if(m){var g=new m;g.loadJSON(e,p,this,!1,o,d),this.set(c,g)}else"interactionBehaviours"===c?this.set("interactionBehaviours",p):r.warn("Warning: Object %s unknow",p.className)}else"userData"===c&&p&&this.set("userData",p)}if(i&&s&&(i.decrNumChildrenToLoad(),i.addChild(this,l)),void 0!==d)var v=n.subscribeTo(n.eventsList.onLoaded+":"+this.get("id"),function(e){var t,i;n.unsubscribe(v),a.is(e)&&("boolean"==typeof e?t=e:(t=e.success,i=e.item)),d(t,i)})}catch(e){console.error(e.stack),void 0!==d&&d(!1)}},saveJSONFile:function(){return JSON.stringify(this)},create:function(e){if(!e._urban)return!1;for(var t in this._created=!0,this._root=e,this._attributes){var i=this._attributes[t];i&&!1===i._created&&i.create(e)}return!0},destroy:function(e){if(this.dispatchEvent("onDestroy",this),this._attributes&&this._attributes.loadInfo&&this._attributes.loadInfo.total&&this._attributes.loadInfo.loaded<this._attributes.loadInfo.total){var t={loaded:this.get("loadInfo").total,total:this.get("loadInfo").total};this.set("loadInfo",t)}for(var i in this._attributes){var r=this._attributes[i];r&&r.removeItemParent&&r.removeItemParent(this,e)}this._created=!1,this.clear({silent:!0})},sync:function(){},getBoundingSphere:function(){if(this._node){var e=this.getLocalPosition();return e?new t.Sphere(e,this._node.bSphere.radius):this._node.bSphere}},setRenderable:function(e,t,i){var r=this.getRendering();if(this.renderingProfileManager&&a.is(r)&&r.hasAttribute(e)){var s={};s[e]=t,this.setMaterial(s,i)}else console.log("item has not renderable attribute ",e)},setMaterial:function(e,t){var i=this.getRendering();return i&&(e=i.updatePresetValues(e),this.renderingProfileManager.addRendering(this.parentFeatureID,e,null,t)),this},addFilterRendering:function(e,t){var i=this.getRendering();if(i)return t=i.updatePresetValues(t),this.renderingProfileManager.addFilterRendering(this.parentFeatureID,e,t,this.get("renderID"))},addDatavizRendering:function(e){var t=this.getRendering();if(t)return e=t.updatePresetValues(e),this.renderingProfileManager.addDatavizRendering(this.parentFeatureID,e,this.get("renderID"))},updateDatavizRendering:function(e,t,i,r){var s=this.getRendering();if(s)return i=s.updatePresetValues(i),this.renderingProfileManager.updateDatavizRendering(this.parentFeatureID,e,t,i,r,this.get("renderID"))},deleteDatavizRendering:function(e){if(this.getRendering())return this.renderingProfileManager.deleteDatavizRendering(this.parentFeatureID,e,this.get("renderID"))}});return h.ObjectContructor={},h}),define("DS/XCityLayer/VectorLoaderJSON",["DS/Visualization/ThreeJS_DS","DS/XCityLayer/Vector","UWA/Class"],function(e,t){"use strict";return UWA.Class.extend({init:function(e){this.type=e},requestData:function(e,t){var i=new XMLHttpRequest;i.open("GET",e,!0);i.onload=function(e){var r=JSON.parse(i.response),s={list:r.features,index:0,count:r.features.length};s.getNextFeature=this.getNextFeature.bind(this,s),t(s,i.status)}.bind(this),i.send()},loadDataSource:function(e){if(""!==e){var t=JSON.parse(e),i={list:t.features,index:0,count:t.features.length,getNextFeature:this.getNextFeature.bind(this)};return i.getNextFeature=this.getNextFeature.bind(this,i),i}return{list:[],index:0,count:0}},loadDataSourceFromObject:function(e){if(null!==e){var t={list:e.features,index:0,count:e.features.length,getNextFeature:this.getNextFeature.bind(this)};return t.getNextFeature=this.getNextFeature.bind(this,t),t}return{list:[],index:0,count:0}},getNextFeature:function(e,t){if(e.index<e.count){var i=this.parseFeature(e.list[e.index],t);return"wfs"===this.type&&(i.attributes.STRID=e.list[e.index].id,void 0===i.attributes.STRID&&(i.attributes.STRID=e.idDataSource+"_"+e.tile.key+"_"+e.count)),e.index++,i}return null},parseFeature:function(e,t){var i=this.parseGeometry(e.geometry);if(t.clear(),t.setGeometry(i),void 0!==e.properties)for(var r=Object.keys(e.properties),s=0,n=r.length;s<n;s++)t.setAttribute(r[s],e.properties[r[s]]);return t},parsePoint:function(e){return 3===e.length?new t.Point3D(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])):new t.Point2D(parseFloat(e[0]),parseFloat(e[1]))},parseMultiPoint:function(i){for(var r=i.length,s=new t.MultiPoint,n=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),a=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),o=0;o<r;++o){var l=this.parsePoint(i[o]);s.addGeometry(l),n.set(n.x>l.x?l.x:n.x,n.y>l.y?l.y:n.y),a.set(a.x<l.x?l.x:a.x,a.y<l.y?l.y:a.y)}return s.setAABBox(n,a),s},parsePolygon:function(i){for(var r=new t.Polygon,s=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),n=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),a=0,o=i.length;a<o;a++){for(var l=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),h=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),d=new t.LineString,u=i[a],c=0,p=u.length;c<p;c++){var f=u[c];(c!==p-1||d.vertexList[0].x!==f[0]&&d.vertexList[0].y!==f[1])&&(l.set(l.x>f[0]?f[0]:l.x,l.y>f[1]?f[1]:l.y),h.set(h.x<f[0]?f[0]:h.x,h.y<f[1]?f[1]:h.y),3===f.length?d.addVertex(new t.Point3D(parseFloat(f[0]),parseFloat(f[1]),parseFloat(f[2]))):d.addVertex(new t.Point2D(parseFloat(f[0]),parseFloat(f[1]))))}d.setAABBox(l,h),r.addGeometry(d),s.set(s.x>l.x?l.x:s.x,s.y>l.y?l.y:s.y),n.set(n.x<h.x?h.x:n.x,n.y<h.y?h.y:n.y)}return r.setAABBox(s,n),r},parseMultiPolygon:function(i){for(var r=i.length,s=new t.MultiPolygon,n=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),a=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),o=0;o<r;++o){var l=this.parsePolygon(i[o]);s.addGeometry(l);var h=l.getSize().clone();h.multiplyScalar(.5);var d=l.getCenter().clone().sub(h),u=l.getCenter().clone().add(h);n.set(n.x>d.x?d.x:n.x,n.y>d.y?d.y:n.y),a.set(a.x<u.x?u.x:a.x,a.y<u.y?u.y:a.y)}return s.setAABBox(n,a),s},parseLine:function(i){for(var r=new t.LineString,s=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),n=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),a=0;a<i.length;a++){var o=i[a];3===o.length?r.addVertex(new t.Point3D(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2]))):r.addVertex(new t.Point2D(parseFloat(o[0]),parseFloat(o[1]))),s.set(s.x>o[0]?o[0]:s.x,s.y>o[1]?o[1]:s.y),n.set(n.x<o[0]?o[0]:n.x,n.y<o[1]?o[1]:n.y)}return r.setAABBox(s,n),r},parseMultiLine:function(i){for(var r=i.length,s=new t.MultiLineString,n=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),a=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),o=0;o<r;++o){var l=this.parseLine(i[o]);s.addGeometry(l);var h=l.getSize().clone();h.multiplyScalar(.5);var d=l.getCenter().clone().sub(h),u=l.getCenter().clone().add(h);n.set(n.x>d.x?d.x:n.x,n.y>d.y?d.y:n.y),a.set(a.x<u.x?u.x:a.x,a.y<u.y?u.y:a.y)}return s.setAABBox(n,a),s},parseGeometry:function(e){if(null!=e)return"polygon"===e.type.toLowerCase()?this.parsePolygon(e.coordinates):"multipolygon"===e.type.toLowerCase()?this.parseMultiPolygon(e.coordinates):"point"===e.type.toLowerCase()?this.parsePoint(e.coordinates):"multipoint"===e.type.toLowerCase()?this.parseMultiPoint(e.coordinates):"linestring"===e.type.toLowerCase()?this.parseLine(e.coordinates):"multilinestring"===e.type.toLowerCase()?this.parseMultiLine(e.coordinates):null}})}),define("DS/XCityLoaders/BaseLoader",["DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/XCityTools/Geocoder","DS/XCityTools/ShaderTools","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s){"use strict";return UWA.Class.extend({init:function(e,t){if(this.urban=e,s.is(t)){this.model=t,this.baseURL=this.model.url.substring(0,this.model.url.length-5)}else this.model={};this.model.gasSharing=!1,this._initRootNode(),this._initModelMatrix(),this.model.url?this.model.node.name=this.model.url.slice(this.model.url.lastIndexOf("/")+1):this.model.spec&&this.model.spec.filename&&(this.model.node.name=this.model.spec.filename.slice(0,this.model.spec.filename.indexOf("?")))},_initRootNode:function(){this.model.node=new e,s.is(this.model.destinationNode)&&this.model.destinationNode.addChild(this.model.node)},_initModelMatrix:function(){this._applyModelMatrixToModelNode(),this._applyProjection()},_applyModelMatrixToModelNode:function(){var e=this.model.matrix;s.is(e)||(e=this._computeModelMatrix()),this.model.node.setMatrix(e)},_computeModelMatrix:function(){var e=new t.Matrix4;return void 0!==this.model.rotation&&(e.rotateX(s.toRad(this.model.rotation[0])),e.rotateY(s.toRad(this.model.rotation[1])),e.rotateZ(s.toRad(this.model.rotation[2]))),void 0!==this.model.position&&e.setPosition({x:this.model.position[0],y:this.model.position[1],z:this.model.position[2]}),e},_applyProjection:function(){s.is(this.model.projection)&&i.loadProjection(this.model.projection,this._onProjectionLoaded.bind(this))},_onProjectionLoaded:function(){var e=this.model.node.getMatrix();this._shiftMatrix(1,e),this._translateAndScale(e),this._shiftMatrix(-1,e),this.model.node.setMatrix(e)},_shiftMatrix:function(e,t){this.model.shifted||(t.elements[12]=t.elements[12]*e+this.urban.shiftedPosition.x,t.elements[13]=t.elements[13]*e+this.urban.shiftedPosition.y)},_translateAndScale:function(e){var r=i.proj([e.elements[12],e.elements[13]],this.model.projection),s=1;"EPSG:3857"!==i.getDefaultProjection()&&"EPSG:900913"!==i.getDefaultProjection()||(s=i.computeMercatorScaleFactor(e.elements[12],e.elements[13],this.model.projection)),e.scale(new t.Vector3(s,s,1)),e.elements[12]=r.x,e.elements[13]=r.y},load:function(e,t){var i,r=this._initRenderingCallback(e);this.model.callback=s.is(r)?r:this.model.callback,this.model.progressCallback=t,i=s.is(this.model.progressCallback)?this.model.progressCallback:function(){},this.loader&&this.loader.setOnProgressCallback&&this.loader.setOnProgressCallback(i)},_initRenderingCallback:function(e){var t=function(t,i,r){this.model.rendering._addSpecificGeometry(this.model.node),s.is(e)&&e(t,i,r)}.bind(this);return s.is(this.model.rendering)?t:e},_getModelMaterial:function(e,i,n){if(s.is(i)&&s.is(n)){var a,o={visible:i.visible,force:i.force,side:i.side,enableClipPlanes:i.enableClipPlanes,transparent:i.transparent,opacity:i.opacity,depthTest:i.depthTest,depthWrite:i.depthWrite};return s.is(i.diffuseMap)&&s.is(n.data)&&s.is(n.data.textures)&&(o.map=n.data.textures[i.diffuseMap]),s.is(i.normalMap)&&s.is(n.data)&&s.is(n.data.textures)&&(o.normalMap=n.data.textures[i.normalMap]),s.is(i.specularMap)&&s.is(n.data)&&s.is(n.data.textures)&&(o.specularMap=n.data.textures[i.specularMap]),s.is(e)?e instanceof Array?a="Mat_water"===i.name?r.getExistingShaderMaterial(e[1].name):r.getExistingShaderMaterial(e[0].name):(void 0!==e.name&&(a=r.getExistingShaderMaterial(e.name)),void 0===a&&s.is(e.chunk)&&((a=this._createCityMaterial(e.chunk)).name="model_material")):a=i.clone(),a.setValues(o),s.is(o.map)&&(a.map=o.map),s.is(o.normalMap)&&(a.normalMap=o.normalMap,s.is(a.uniforms)&&s.is(a.uniforms.use_normalMap)&&(a.uniforms.use_normalMap.value=1,i.normalMapScale&&(a.uniforms.normalScale.value=i.normalMapScale))),s.is(o.specularMap)&&(a.specularMap=o.specularMap,s.is(a.uniforms)&&s.is(a.uniforms.use_specularMap)&&(a.uniforms.use_specularMap.value=1)),s.is(i.color)&&(a.color=(new t.Color).setRGB(i.color.r,i.color.g,i.color.b)),s.is(i.ambient)&&(a.ambient=(new t.Color).setRGB(i.ambient.r,i.ambient.g,i.ambient.b)),s.is(i.emissive)&&(a.emissive=(new t.Color).setRGB(i.emissive.r,i.emissive.g,i.emissive.b)),s.is(i.specular)&&(a.specular=(new t.Color).setRGB(i.specular.r,i.specular.g,i.specular.b)),s.is(i.shininess)&&(a.shininess=i.shininess),s.is(i.opacity)&&(a.opacity=i.opacity),s.is(i.transparent)&&(a.transparent=i.transparent),s.is(i.alphaTest)&&(a.alphaTest=i.alphaTest),r.updateCommonUniforms(a),a}},_createCityMaterial:function(e){for(var t=[r.common],i=0;i<e.length;++i)t.push(r[e[i]]);return r.getCustomShaderMaterial(t)},_needCustomShaders:function(){return s.is(this.model.shader)&&(this.model.shader instanceof Array||s.is(this.model.shader.chunk)||s.is(this.model.shader.name)&&s.is(r.getExistingShaderMaterial(this.model.shader.name)))},_isTextured:function(){var e=this.loader.modelsToLoad;if(!e)return!1;for(var t in e){var i=e[t];if(i.json&&i.json.images&&i.json.images.length>0)return!0}return!1}})}),define("DS/XCityTools/Pooler",["DS/Visualization/ThreeJS_DS","DS/XCityTools/Debug"],function(e,t){"use strict";var i=function(e){this._objFactory=e,this._objPool=[],this._nextFreeSlot=null};return i.prototype={use:function(){null!=this._nextFreeSlot&&this._nextFreeSlot!=this._objPool.length||this.grow(this._objPool.length||100);var e=this._objPool[this._nextFreeSlot++];return e._globePoolUsed=!0,e},recycle:function(e){e._globePoolUsed&&(null==this._nextFreeSlot||-1==this._nextFreeSlot?(e._globePoolUsed=!1,this._objPool[this._objPool.length]=e):(e._globePoolUsed=!1,this._objPool[--this._nextFreeSlot]=e))},grow:function(e){if(e>0&&null==this._nextFreeSlot&&(this._nextFreeSlot=0),e>0){var t=this._objPool.length;this._objPool.length+=Number(e);for(var i=t;i<this._objPool.length;i++)this._objPool[i]=this._objFactory(),this._objPool[i]._globePool=this}return this._objPool.length},size:function(){return this._objPool.length}},i}),define("DS/XCityGeometry/PatchVectorFactory",["UWA/Core","UWA/Class","DS/XCityTools/Geocoder","DS/Visualization/Node3D","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s,n){"use strict";return t.extend({init:function(e,t,i){this.hasLabel=!1,this.lifespanstAttribute=void 0!==t.lifespanstAttribute?t.lifespanstAttribute:"LifespanStart",this.lifespanAttribute=void 0!==t.lifespanAttribute?t.lifespanAttribute:"Lifespan",this.lifespanenAttribute=void 0!==t.lifespanenAttribute?t.lifespanenAttribute:"LifespanEnd",this.isFilteredByTime=void 0!==t.isFilteredByTime&&t.isFilteredByTime,this.nameAttribute=void 0!==t.nameAttribute?t.nameAttribute:"NAME",this.shapeType=t.shapeType,this.loadInfo={loaded:1,total:1}},setProgressCallback:function(e){this._progressCallback=e},initLabelOnSelect:function(e,t){this.hasLabel=!0,this.infoNode=new r,this.textNode=[],this.urban=e,this.renderType=t;var i=this.urban.getLayerSelection();i.addEvent("onSelect",this.displayText,this),i.addEvent("onDeselect",this.removeText,this),i.addEvent("onHover",this.displayText,this),i.addEvent("onDehover",this.removeText,this)},destroy:function(){var e=this.urban.getLayerSelection();e.removeEvent("onSelect",this.displayText,this),e.removeEvent("onDeselect",this.removeText,this),e.removeEvent("onHover",this.displayText,this),e.removeEvent("onDehover",this.removeText,this)},displayText:function(e){if(!(this.hasLabel&&this._rendering._getMaterialInfo().label.enable||e&&e.userData&&e.userData.fromWFS&&e.userData.type!==this.type)){var t=e.get("Content");if(t){var i=t.get("dataSourceId");if(!n.is(i))return;var r=t._layer.get("interactionBehaviours");if(!r||!r.onSelect||!r.onSelect.label)return;if(!n.is(this._node.userData))return void s.log(" incomplete node ");var a,o=this._node.userData.get("Content");if(n.is(this.geometrySubsetId)?a=this.geometrySubsetId:n.is(o)&&(a=o.get("id")),a===i&&(e.hasChanged("selected")&&this.nbSelectedNode++,t.userData&&"text"!==this.renderType)){0===this.infoNode.parents.length&&t._root.getNode3D().addChild(this.infoNode);var l=this._generateLabelFromContent(t);if(!n.is(l))return void console.log("textNode didnt create because label has no name");this.infoNode.setVisibility(!0)}}}},_generateLabelFromContent:function(e){var t=e._getStrid(),i=this._rendering.getCompleteMaterialInfo(t,e.userData);if(n.is(e.userData[this.nameAttribute])&&(i.label.name=e.userData[this.nameAttribute]),!n.is(i.label.name)||""===i.label.name)return;var r=this._computeLabelPos(e,i),s=this._computeGeometrySize(e,i);let a=n.generateLabelPriorities(this._node,void 0,e.userData);return this._generateLabel(r,t,i,s,void 0,a,this.infoNode)},_getFeatureDataFromStrid:function(e){var t;return n.is(this._node)&&n.is(this._node.userData)&&n.is(this._node.userData.getContent())&&n.is(this._node.userData.getContent()._data)?t=this._node.userData.getContent()._data:n.is(this._node)&&n.is(this._node.userData)&&n.is(this._node.userData.getContent())&&n.is(this._node.userData.getContent()._poiSet)&&n.is(this._node.userData.getContent()._poiSet._data)&&(t=this._node.userData.getContent()._poiSet._data),n.is(t)?("string"==typeof t&&(t=JSON.parse(t)),t.features.find(t=>t.properties.STRID==e)):n.is(this.geoJSON)&&n.is(this.geoJSON[e])&&n.is(this.geoJSON[e].features)&&n.is(this.geoJSON[e].features[0])?this.geoJSON[e].features[0]:void console.error("didn't find a way to retrieve the feature")},_getPrimInfo:function(e){var t=e._getStrid(),i=this._getPrimInfoFromPreview(t);if(n.is(i))return i;if(n.is(this._node.userData.getContent().primInfos)&&n.is(this._node.userData.getContent().primInfos[t]))return this._node.userData.getContent().primInfos[t];if(n.is(this.patch)&&n.is(this.patch.miDToTile))return this.patch.miDToTile[t];throw new Error("Couldn't find primitive info for strid: "+t)},_getPrimInfoFromPreview:function(e){return null},removeText:function(e){if(!this._rendering._getMaterialInfo().label.enable){var t=e.get("Content");if(t){var i=t.get("dataSourceId");if(!n.is(i))return;if(!n.is(this._node.userData))return void s.log(" incomplete node ");var r,a=this._node.userData.get("Content");if(n.is(this.geometrySubsetId)?r=this.geometrySubsetId:n.is(a)&&(r=a.get("id")),r===i){if("text"!==this.renderType&&n.is(t._getStrid())){let e="textNode_"+t._getStrid();var o=this.infoNode.getChildByName(e);o||(o=this.infoNode.children.find(t=>t.temporaryTextNode.name==e))&&o.temporaryTextNode&&(this.infoNode.removeChild(o),o=o.temporaryTextNode),n.is(o)&&(this.urban.labelManager.unregisterPOI(o),this.infoNode.removeChild(o))}e.hasChanged("selected")&&(this.nbSelectedNode--,this.infoNode.parents.length>0&&0===this.infoNode.children.length&&"text"!==this.renderType&&this.infoNode.parents[0].removeChild(this.infoNode))}}}},addLabelsToNode:function(e,t){var i=new r;if(n.is(e.labelMeshes))for(var s=0;s<e.labelMeshes.length;s++)i.addChild(e.labelMeshes[s]);t.addChild(i)},_patchZPositionProjection:function(e){if("EPSG:3857"===i.getDefaultProjection()||"EPSG:900913"===i.getDefaultProjection()){var t=i.computeMercatorScaleFactor(e.x,e.y,i.getDefaultProjection());e.z=e.z/t}},_shouldCreateLabelFromMaterial:function(e){return e.label&&!0===e.label.enable&&n.is(e.label.name)&&""!==e.label.name}})}),define("DS/XCityTools/ExpressionEvaluator",["UWA/Class","DS/xCityBasicUtils/Utils","DS/XCityTools/Expression","DS/xCityBasicUtils/ColorGradient","DS/xCityBasicUtils/FloatGradient"],function(Class,Utils,Expression,ColorGradient,FloatGradient){"use strict";var FunctionNameToCode={And:"and","ogc:And":"and",Or:"or","ogc:Or":"or",Not:"not","ogc:Not":"not",Add:"add","ogc:Add":"add",Sub:"sub","ogc:sub":"sub",Mul:"mul","ogc:Mul":"mul",Div:"div","ogc:Div":"div",toNumber:"toNumber",PropertyIsEqualTo:"isEqualTo",IsEqualTo:"isEqualTo","ogc:PropertyIsEqualTo":"isEqualTo",PropertyIsNotEqualTo:"isNotEqualTo",IsNotEqualTo:"isNotEqualTo","ogc:PropertyIsNotEqualTo":"isNotEqualTo",PropertyIsLessThan:"isLessThan",IsLessThan:"isLessThan","ogc:PropertyIsLessThan":"isLessThan",PropertyIsLessThanOrEqualTo:"isLessThanOrEqualTo",IsLessThanOrEqualTo:"isLessThanOrEqualTo","ogc:PropertyIsLessThanOrEqualTo":"isLessThanOrEqualTo",PropertyIsGreaterThan:"isGreaterThan",IsGreaterThan:"isGreaterThan","ogc:PropertyIsGreaterThan":"isGreaterThan",PropertyIsGreaterThanOrEqualTo:"isGreaterThanOrEqualTo",IsGreaterThanOrEqualTo:"isGreaterThanOrEqualTo","ogc:PropertyIsGreaterThanOrEqualTo":"isGreaterThanOrEqualTo",PropertyIsBetween:"isBetween",IsBetween:"isBetween","ogc:PropertyIsBetween":"isBetween",PropertyIsNull:"isNull",IsNull:"isNull","ogc:PropertyIsNull":"isNull",PropertyIsNotNull:"isNotNull",IsNotNull:"isNotNull","ogc:PropertyIsNotNull":"isNotNull",PropertyName:"getProperty","ogc:PropertyName":"getProperty",ValueReference:"getProperty","ogc:ValueReference":"getProperty",Literal:"getLiteral","ogc:Literal":"getLiteral",Function:"applyFunction","ogc:Function":"applyFunction",comparisonOps:"applyFunction",logicOps:"applyFunction",expression:"evaluateArrayOrObject",ColorGradient:"colorGradient",FloatGradient:"floatGradient"},ExpressionEvaluator=Class.extend({init:function(e){Utils.is(e)&&e instanceof Expression&&this.setExpression(e)},setExpression:function(e){this.expr=e._get(),this._exprObject=e,this.currentString=e.stringForm,this.usedAttributes=e.usedAttributes,this.usedVariables=e.usedVariables},unsetExpression:function(){this.expr=null,this._exprObject=null,this.currentString=null,this.usedAttributes=null,this.usedVariables=null},setContext:function(e){this.currentAttributes=e},unsetContext:function(){this.currentAttributes=null},apply:function(e){if(Utils.is(e)||(e=this.currentAttributes),this.expr)return this.currentAttributes=e,this.currentString=null,this.evaluate(this.expr)},applytoString:function(e){if(Utils.is(e)||(e=this.currentAttributes),this.expr){this.currentAttributes=e,this.currentString=" ";var t=this.evaluate(this.expr);return this.currentString+=";",t}},evalString:function(attributes){var value,evaluated=!1;if(this.currentString||(value=this.applytoString(attributes),this._exprObject.stringForm=this.currentString,this._exprObject.usedVariables=this.usedVariables,evaluated=!0),this.usedAttributes){this._exprObject.usedAttributes=this.usedAttributes;for(var keys=Object.keys(this.usedAttributes),i=0;i<keys.length;i++){var key=keys[i],attrvalue=this.currentAttributes[key];if(void 0===attrvalue)return}}if(!0===evaluated)return value;var XCITYcurrentVariables=this.usedVariables,XCITYcurrentContent=this.currentAttributes;return eval(this.currentString)},evaluate:function(e){var t,i;if(Array.isArray(e)){var r,s=e.length;for(t=[],this.currentString&&(this.currentString+="["),r=0;r<s;r++)i=e[r],t[r]=this.evaluate(i),r<s-1&&this.currentString&&(this.currentString+=",");this.currentString&&(this.currentString+="]")}else{var n=this.getName(e);i=this.getValue(e,n);var a=FunctionNameToCode[n];Utils.is(a)?t=this[a](i,e):(console.error(" Unknown Expression Type : "+n),t=null)}return t},evaluateArrayOrObject:function(e){var t;return t=Array.isArray(e)?e[0]:e,this.evaluate(t)},getName:function(e){return Utils.is(e)?Utils.is(e.name)&&Utils.is(e.name.localPart)?e.name.localPart:Object.keys(e)[0]:null},getValue:function(e,t){if(Utils.is(e)){if(Utils.is(e.value)){var i=Object.keys(e.value);return 1===i.length?e.value[i[0]]:e.value}return e[t]}return null},applyFunction:function(e){var t=this.getName(e),i=this.getValue(e,t),r=null,s=FunctionNameToCode[t];return Utils.is(s)?r=this[s](i,e):(console.error(" Unknown Expression Type : "+t),r=null),r},oldgetProperty:function(e){return Array.isArray(e)&&1===e.length&&(e=e[0]),this.currentString&&(this.usedAttributes||(this.usedAttributes={}),this.usedAttributes[e]?this.usedAttributes[e]++:this.usedAttributes[e]=0,this.currentString+='XCITYcurrentContent["'+e+'"]'),this.currentAttributes[e]},getProperty:function(e,t){var i,r=0,s=e.length,n=0;if("string"==typeof e){if(this.currentMapping&&this.currentMapping[e])e=this.currentMapping[e],t[Object.keys(t)[0]]=e;this.currentString&&(this.usedAttributes||(this.usedAttributes={}),this.usedAttributes[e]?this.usedAttributes[e]++:this.usedAttributes[e]=0,this.currentString+='XCITYcurrentContent["'+e+'"]'),n=this.currentAttributes[e]}else if(Utils.is(this.currentMapping))for(r=0;r<e.length;r++)i=e[r],this.currentMapping[i]&&(i=this.currentMapping[i]),e[r]=i;else{var a=this.currentAttributes;for(i=e[0],this.currentString&&(this.usedAttributes||(this.usedAttributes={}),this.usedAttributes[i]?this.usedAttributes[i]++:this.usedAttributes[i]=0,this.currentString+='XCITYcurrentContent["'+i+'"]'),n=this.currentAttributes[i],r=1;r<s;r++)this.currentAttributes=n,i=e[r],n=this.currentAttributes[i],this.currentString&&(this.currentString+='["'+i+'"]');this.currentAttributes=a}return n},getLiteral:function(e){return Array.isArray(e)&&1===e.length&&(e=e[0]),this.currentString&&(this.currentString+=e),e},add:function(e){var t,i=0,r=e.length,s=0;for(s=this.evaluate(e[0]),i=1;i<r;i++)this.currentString&&(this.currentString+=" + "),t=e[i],s+=this.evaluate(t);return s},sub:function(e){var t,i=0,r=e.length,s=0;for(s=this.evaluate(e[0]),i=1;i<r;i++)this.currentString&&(this.currentString+=" + "),t=e[i],s-=this.evaluate(t);return s},mul:function(e){var t,i=0,r=e.length,s=1;for(s=this.evaluate(e[0]),i=1;i<r;i++)this.currentString&&(this.currentString+=" * "),t=e[i],s*=this.evaluate(t);return s},div:function(e){var t,i=0,r=e.length,s=1;for(s=this.evaluate(e[0]),i=1;i<r;i++)this.currentString&&(this.currentString+=" / "),t=e[i],s/=this.evaluate(t);return s},and:function(e){var t,i=0,r=e.length,s=1;for(s=this.evaluate(e[0]),i=1;i<r;i++)this.currentString&&(this.currentString+=" && "),t=this.evaluate(e[i]),s=s&&t;return s},or:function(e){var t,i=0,r=e.length,s=1;for(s=this.evaluate(e[0]),i=1;i<r;i++)this.currentString&&(this.currentString+=" || "),t=this.evaluate(e[i]),s=s||t;return s},not:function(e){var t;e.length;return this.currentString&&(this.currentString+=" ( !"),t=!this.evaluate(e[0]),this.currentString&&(this.currentString+=" )"),t},toNumber:function(e){this.currentString&&(this.currentString+=" Number( ");var t=Number(this.evaluate(e));return t=isNaN(t)?0:t,this.currentString&&(this.currentString+=" ) "),t},isNull:function(e){this.currentString&&(this.currentString+=" (!Utils.is( ");var t=this.evaluate(e);return t=!Utils.is(t),this.currentString&&(this.currentString+=" )) "),t},isNotNull:function(e){this.currentString&&(this.currentString+=" (Utils.is( ");var t=this.evaluate(e[0]);return t=Utils.is(t),this.currentString&&(this.currentString+=" )) "),t},isEqualTo:function(e){var t=0,i=e.length,r=1;for(r=this.evaluate(e[0]),2!==i&&console.error(" Comparison needs exactly two operands ! "),t=1;t<i;t++)this.currentString&&(this.currentString+=" == "),r=r==this.evaluate(e[t]);return r},isNotEqualTo:function(e){var t=0,i=e.length,r=1;for(r=this.evaluate(e[0]),2!==i&&console.error(" Comparison needs exactly two operands ! "),t=1;t<i;t++)this.currentString&&(this.currentString+=" != "),r=r!=this.evaluate(e[t]);return r},isLessThan:function(e){var t,i=0,r=e.length,s=1;for(s=this.evaluate(e[0]),2!==r&&console.error(" Comparison needs exactly two operands ! "),i=1;i<r;i++){this.currentString&&(this.currentString+=" < "),t=this.evaluate(e[i]);var n=Number(t),a=Number(s);isNaN(a)&&(a=s),isNaN(n)&&(n=t),s=a<n}return s},isLessThanOrEqualTo:function(e){var t,i=0,r=e.length,s=1;for(s=this.evaluate(e[0]),2!==r&&console.error(" Comparison needs exactly two operands ! "),i=1;i<r;i++){this.currentString&&(this.currentString+=" <= "),t=this.evaluate(e[i]);var n=Number(t),a=Number(s);isNaN(a)&&(a=s),isNaN(n)&&(n=t),s=a<=n}return s},isGreaterThan:function(e){var t,i=0,r=e.length,s=1;for(s=this.evaluate(e[0]),2!==r&&console.error(" Comparison needs exactly two operands ! "),i=1;i<r;i++){this.currentString&&(this.currentString+=" > "),t=this.evaluate(e[i]);var n=Number(t),a=Number(s);isNaN(a)&&(a=s),isNaN(n)&&(n=t),s=a>n}return s},isGreaterThanOrEqualTo:function(e){var t,i=0,r=e.length,s=1;for(s=this.evaluate(e[0]),2!==r&&console.error(" Comparison needs exactly two operands ! "),i=1;i<r;i++){this.currentString&&(this.currentString+=" >= "),t=this.evaluate(e[i]);var n=Number(t),a=Number(s);isNaN(a)&&(a=s),isNaN(n)&&(n=t),s=a>=n}return s},isBetween:function(e){var t,i,r,s=null;if(Utils.is(e)){if(Array.isArray(e)){var n=e.length;for(r=0;r<n;r++){var a=e[r],o=this.getName(a),l=this.getValue(a,o);"LowerBoundary"===o||"lowerBoundary"===o?t=this.evaluate(l):"UpperBoundary"===o||"upperBoundary"===o?i=this.evaluate(l):s=this.evaluate(a)}}else s=this.evaluate(e),Utils.is(e.LowerBoundary)&&(t=this.evaluate(e.LowerBoundary)),Utils.is(e.lowerBoundary)&&(t=this.evaluate(e.lowerBoundary)),Utils.is(e.upperBoundary)&&(i=this.evaluate(e.upperBoundary)),Utils.is(e.UpperBoundary)&&(i=this.evaluate(e.UpperBoundary));Utils.is(t)||(t=s),Utils.is(i)||(i=s);var h=Number(t),d=Number(i),u=Number(s);isNaN(u)&&(u=s),isNaN(h)&&(h=t),isNaN(d)&&(d=i),s=h<=u&&u<=d,this.currentString&&console.error("isBetween not optimised")}return s},colorGradient:function(e){if(!Utils.is(e)||2!=e.length&&3!=e.length)return null;var t,i=e[1];if(Utils.is(i.xCityid)&&Utils.is(this.usedVariables)){var r=this.usedVariables[i.xCityid];Utils.is(r)&&(i=r)}i instanceof ColorGradient||(i=new ColorGradient(i,e[2]),e[1].xCityid=i.xCityid,this.currentString&&(t=i.xCityid,Utils.is(this.usedVariables)||(this.usedVariables={}),this.usedVariables[t]=i)),this.currentString&&(t=i.xCityid,this.currentString+=' XCITYcurrentVariables["'+t+'"].computeColor(');var s=this.evaluate(e[0]),n=null;return Utils.is(s)&&(i.setLastValue(s),n=i.computeColor()),this.currentString&&(this.currentString+=" )"),n},floatGradient:function(e){if(!Utils.is(e)||2!=e.length&&3!=e.length)return null;var t,i=e[1];if(Utils.is(i.xCityid)&&Utils.is(this.usedVariables)){var r=this.usedVariables[i.xCityid];Utils.is(r)&&(i=r)}i instanceof FloatGradient||(i=new FloatGradient(i,e[2]),e[1].xCityid=i.xCityid,this.currentString&&(t=i.xCityid,Utils.is(this.usedVariables)||(this.usedVariables={}),this.usedVariables[t]=i)),this.currentString&&(t=i.xCityid,this.currentString+=' XCITYcurrentVariables["'+t+'"].computeFloat(');var s=this.evaluate(e[0]),n=null;return Utils.is(s)&&(i.setLastValue(s),n=i.computeFloat()),this.currentString&&(this.currentString+=" )"),n},mapExpression:function(e){if(this.expr){this.currentAttributes;this.currentMapping=e,this.currentAttributes={},this.currentString=null,this.evaluate(this.expr),this.currentMapping=null,this.currentAttributes=null,this.currentString=null}}});return ExpressionEvaluator}),define("DS/XCityTools/OGCFilter",["UWA/Class","DS/XCityTools/Expression"],function(e,t){"use strict";var i=t.extend({init:function(e){e?e instanceof i?this._set(e._get()):this._parent(e):this._set({TYPE_NAME:"Filter_1_1_0.FilterType"})},clone:function(){return new i(this.toJSON())},isLike:function(e){return this["ogc:Filter"].comparisonOps={"ogc:PropertyIsLike":{TYPE_NAME:"Filter_1_1_0.PropertyIsLikeType",escapeChar:"",singleChar:"_",wildCard:"%",literal:{TYPE_NAME:"Filter_1_1_0.LiteralType",content:[e]},propertyName:{TYPE_NAME:"Filter_1_1_0.PropertyNameType",content:this.tmp.PropertyName}}},delete this.tmp,this},isNull:function(e){new t(e);return this.setAsBinaryComparisonOpType("PropertyIsNull",[this._get()]),this},isNotNull:function(e){new t(e);return this.setAsBinaryComparisonOpType("PropertyIsNotNull",[this._get()]),this},isBetween:function(e,i){this.setAsBinaryComparisonOpType("PropertyIsBetween",[this._get()]);var r=this.expr.comparisonOps.value;return r.LowerBoundary=new t(e)._get(),r.UpperBoundary=new t(i)._get(),this},setAsBinaryLogicOpType:function(e,t){var i={logicOps:{name:{localPart:e},value:{expression:t}}};this._set(i)},setAsBinaryComparisonOpType:function(e,t){var i={comparisonOps:{name:{localPart:e},value:{expression:t}}};this._set(i)},isEqualTo:function(e){var i=new t(e);return this.setAsBinaryComparisonOpType("PropertyIsEqualTo",[this._get(),i._get()]),this},isLessThanOrEqualTo:function(e){var i=new t(e);return this.setAsBinaryComparisonOpType("PropertyIsLessThanOrEqualTo",[this._get(),i._get()]),this},isGreaterThan:function(e){var i=new t(e);return this.setAsBinaryComparisonOpType("PropertyIsGreaterThan",[this._get(),i._get()]),this},isLessThan:function(e){var i=new t(e);return this.setAsBinaryComparisonOpType("PropertyIsLessThan",[this._get(),i._get()]),this},isGreaterThanOrEqualTo:function(e){var i=new t(e);return this.setAsBinaryComparisonOpType("PropertyIsGreaterThanOrEqualTo",[this._get(),i._get()]),this},isNotEqualTo:function(e){var i=new t(e);return this.setAsBinaryComparisonOpType("PropertyIsNotEqualTo",[this._get(),i._get()]),this},and:function(e){var i=new t(e);return this.setAsBinaryLogicOpType("And",[this._get(),i._get()]),this},or:function(e){var i=new t(e);return this.setAsBinaryLogicOpType("Or",[this._get(),i._get()]),this},not:function(e){var i=new t(e);return this.setAsBinaryLogicOpType("Not",[this._get(),i._get()]),this},getPreviousOperator:function(e){var t;if(void 0!==e["ogc:Filter"].comparisonOps)t=e["ogc:Filter"].comparisonOps;else if(void 0!==e["ogc:Filter"].spatialOps)t=e["ogc:Filter"].spatialOps;else{if(void 0===e["ogc:Filter"].logicOps)throw console.error(e),"Not Implemented yet, another operators";t=e["ogc:Filter"].logicOps}return t},BBOX:function(e,t,i,r,s){return this["ogc:Filter"].spatialOps={"ogc:BBOX":{TYPE_NAME:"Filter_1_1_0.BBOXType",envelope:{"gml:Envelope":{TYPE_NAME:"GML_3_1_1.EnvelopeType",lowerCorner:{TYPE_NAME:"GML_3_1_1.DirectPositionType",value:[e,t]},upperCorner:{TYPE_NAME:"GML_3_1_1.DirectPositionType",value:[i,r]},srsName:s}},propertyName:{TYPE_NAME:"Filter_1_1_0.PropertyNameType",content:"ows:BoundingBox"}}},this}});return i}),define("DS/XCityModel/Location",["DS/XCityTools/Geocoder","UWA/Core","DS/XCityModel/Item","DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s){"use strict";var n=i.extend({defaults:t.merge({position:null,projection:null,shifted:!1,altitudeMode:"absolute"},i.defaults),metaData:{type:"Location",className:"Location"},loaderJSON:{position:"loadJSONVector3"},setup:function(){this._parent(),this._matrix=new r.Matrix4,this._localPosition=void 0,this._scale=1,this.get("position")||this.set("position",new r.Vector3);var t=function(t){e.loadProjection(t.get("projection"),t._updatePosition.bind(t))};this.get("projection")&&t(this),this.addEvent("onChange:projection",t,this)},destroy:function(e){e._urban.getView3D()._removePointToProject(this.id),this._parent(e)},set:function(e,t){this._parent(e,t)},create:function(e){if(!this._parent(e))return!1;e._urban;this._matrix.identity(),this._updatePosition(),this._updateAltitudeMode(),this.addEvent("onChange:position",this._updatePosition,this),this.addEvent("onChange:altitudeMode",this._updateAltitudeMode,this);return this.addEvent("onChange:matrix",function(){s.publish("/xCity/needRender",this)},this),!0},getLocalPosition:function(){return this._localPosition},_updatePosition:function(){if(this._created){if(this._oldscale=this._scale,this._scale=1,"EPSG:3857"!==e.getDefaultProjection()&&"EPSG:900913"!==e.getDefaultProjection()||(this._scale=e.computeMercatorScaleFactor(this.get("position").x,this.get("position").y,this.get("projection"))),this._scale!==this._oldscale){var t=this._scale/this._oldscale;this._matrix.scale({x:t,y:t,z:1})}var i=this.get("position").clone();if(this._localPosition&&this._lastPosition){var r=this._localPosition.z-this._lastPosition.z;i.z+=r}if(this._localPosition=i,this.get("shifted")&&this.getRoot()&&this._localPosition.add(this.getRoot()._urban.shiftedPosition),this.get("projection")||this.getRoot()&&this.getRoot()._urban.getProjectProjection()!==this.getRoot()._urban.getUserDefaultProjection()){var s=e.proj(this.get("position"),this.get("projection"));this._localPosition.set(s.x,s.y,this.get("position").z)}this._matrix.setPosition(this._localPosition),this._lastPosition=this.get("position").clone(),this.dispatchEvent("onChange:matrix",this._matrix.clone())}},_setAltitude:function(e){this._localPosition.z=(this._scaleZ?this._scale:1)*(e+this.get("position").z),this._matrix.elements[14]=this._localPosition.z,this.dispatchEvent("onChange:matrix",this._matrix.clone())},_updateAltitudeMode:function(e){"absolute"!==this.previous("altitudeMode")&&this.getRoot()&&this.getRoot()._urban.getView3D()._removePointToProject(this.id),"absolute"!==this.get("altitudeMode")?this.getRoot()&&this.getRoot()._urban.getView3D()._addPointToProject(this.id,this.getLocalPosition.bind(this),this._setAltitude.bind(this)):this._setAltitude(0)},setMatrix:function(t){this._matrix.copy(t);var i=this._matrix.decompose()[0],r=i.z;(i=e.proj(i,"",this.get("projection"))).z=r,this.set("position",i)},highlight:function(){},unhighlight:function(){}});return i.ObjectContructor.Location=n}),define("DS/XCityModel/Light",["DS/Visualization/ThreeJS_DS","DS/XCityModel/Location","DS/XCityModel/Item","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/Visualization/Node3D","DS/SceneGraphNodes/PointLightNode","DS/SceneGraphNodes/SpotLightNode","DS/SceneGraphNodes/AreaLightNode","DS/Visualization/SceneGraphFactory"],function(e,t,i,r,s,n,a,o,l,h){"use strict";var d=t.extend({defaults:{type:"pointLight",color:"#ffffff",intensity:1,power:0,distance:0,outerAngle:1.5707963267948966,innerAngle:1.5697963267948967,physicalAttenuation:!0,attenuationScale:null,mode:"LUMINOUS_EXITANCE",width:1,height:1,Coordinate:null},metaData:{type:"Location",className:"Light"},setup:function(){this._node=new n,this._node.name="LightFeature",this._parent(),this.addEvent("onChange:Coordinate",this._updateCoordinate,this)},destroy:function(e){this._parent(e),e.getNode3D().remove(this._node)},create:function(t){if(!this._parent(t))return s.publish(s.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;t._urban;this._updateCoordinate();this.getLocalPosition();var i=this.get("intensity");-1===i&&(i=void 0);var r=this.get("type");return this.lightNode="pointLight"===r?new a({color:new e.Color(this.get("color")),intensity:i,power:this.get("power"),distance:this.get("distance"),physicalAttenuation:this.get("physicalAttenuation"),attenuationScale:this.get("attenuationScale")}):"areaLight"===r?new l({color:new e.Color(this.get("color")),intensity:i,width:this.get("width"),height:this.get("height"),mode:this.get("mode")}):new o({color:new e.Color(this.get("color")),intensity:i,power:this.get("power"),distance:this.get("distance"),physicalAttenuation:this.get("physicalAttenuation"),attenuationScale:this.get("attenuationScale"),outerAngle:this.get("outerAngle"),innerAngle:this.get("innerAngle")}),this.helperNode=h.createSphereNode({radius:2}),this._node.add(this.lightNode),t.getNode3D().add(this._node),this.userData={},!0},getRendering:function(){},redraw:function(){},setItemParent:function(e){this._itemParent&&this._itemParent.removeEvent("onChange:selected",this._select),this._itemParent=e,this._itemParent.userData={editablePosition:!0},e&&this._itemParent.addEvent("onChange:selected",this._select,this)},getBaseAltitude:function(){return this._node.getMatrix().elements[14]},_updateCoordinate:function(){var e=this.previous("Coordinate");e&&e.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")?(this.get("Coordinate").setItemParent(this),this._updateMatrix(this.get("Coordinate")._matrix),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this)):this._updateMatrix()},_updateMatrix:function(e){this._node.setMatrix(e)},_updatePosition:function(){this._parent();var e=this.getLocalPosition();this._poi&&this._poi.setPosition(e)},_setVisible:function(e){var t=!!e.get("visible");this._poi&&(this._poi.setVisibility(t),this.getRoot()?this.getRoot()._urban.poiManager.check():this._root&&this._root._urban&&this._root._urban.poiManager&&this._root._urban.poiManager.check())},_select:function(e){e.get("selected")?this._node.add(this.helperNode):this._node.remove(this.helperNode)},addUserDataProperty:function(e,t,i){},removeUserDataProperty:function(e,t){}});return i.ObjectContructor.Light=d}),define("DS/XCityModel/Feature",["DS/XCityModel/Item","DS/XCityTools/Debug"],function(e,t){"use strict";var i=e.extend({defaults:{name:"",description:"",tags:[],visible:!0,selectable:!0,selected:!1,hoverable:!1,hovered:!1,PointOfView:null,Content:null,Credits:null,loadInfo:{loaded:1,total:1}},metaData:{type:"Feature",className:"Feature"},setup:function(){this._parent();var e=this;this.addEvent("onChange:PointOfView",this._setupSubElementsOrder.bind(this)),this.addEvent("onChange:Content",this._setupSubElementsOrder.bind(this)),this.addEvent("onChange:Content",function(){this.get("Content").addEvent("onChange:loadInfo",function(){e._updateLoadInfo()})}.bind(this)),this.addEvent("onChange:tags",function(){var e=this.get("tags");this.dispatchEvent("onAdded:tag",e);var t,i=this.previousAttributes().tags.length;for(t=0;t<i;++t)-1===e.indexOf(this.previousAttributes().tags[t])&&this.removeTag(this.previousAttributes().tags[t]);this.addTags(e)}.bind(this)),this.addEvent("onChange:hoverable",this.setPrepicking,this),this.addEvent("onChange:visible",function(e,t){var i=e.getRoot();Utils.is(i)&&Utils.is(e.getContent())&&Utils.is(e.getContent()._getStrid)&&i._urban.labelManager.onChangeVisibilityPrimitive(e,t)})},_setupSubElementsOrder:function(){var e=0;void 0!==this.get("PointOfView")&&null!==this.get("PointOfView")&&(this.get("PointOfView")._order=e,e++),void 0!==this.get("Content")&&null!==this.get("Content")&&(this.get("Content")._order=e,e++)},setPrepicking:function(){var e=this.get("hoverable"),t=this.getRoot();void 0!==t&&t._urban.getView3D().getPicker().setPrepicking(e)},setVisible:function(e){return this.set("visible",e),this},show:function(){return this.set("visible",!0),this},hide:function(){return this.set("visible",!1),this},select:function(e){return this.set("selected",e),this},getContent:function(){return this.get("Content")},setContent:function(e){return this.set("Content",e)},findTags:function(e){var t,i,r=!0,s=this.get("tags");if(e instanceof Array)for(i=e.length,t=0;t<i;++t)r&=-1!==s.indexOf(e[t].toUpperCase());else r&=-1!==s.indexOf(e.toUpperCase());return r},addTags:function(e){var t,i=e.length;for(t=0;t<i;++t)this.addTag(e[t])},addTag:function(e){var t=this.get("tags").slice(0),i=e.toUpperCase(),r=t.indexOf(i);-1===r&&(i!==e&&-1!==(r=t.indexOf(e))?t[r]=i:t.push(i),this.set("tags",t),this.dispatchEvent("onAdded:tag",e))},removeTags:function(){var e,t=this.get("tags").slice(0),i=t.length;for(e=0;e<i;++e)this.removeTag(t[e])},removeTag:function(e){var t=this.get("tags").slice(0),i=e.toUpperCase(),r=t.indexOf(i);-1!==r&&(t.splice(r,1),this.set("tags",t),this.dispatchEvent("onRemoved:tag",e))},reload:function(e){var t;t=Utils.is(e)?"string"==typeof e?JSON.parse(e):e:this.getContent().toJSON(!0);var i=this.getRoot();return void 0!==i?(this.loadJSON(i._urban,{Content:t}),t):null},set:function(e,t,i){this._parent(e,t,i),this.getContent()&&this.getContent().created&&"selected"!==e&&"hovered"!==e&&"Content"!==e&&(this.temporary=!1)},isIndexablePrimitive:function(){return this._isLayerVectorPrimitive()&&this._hasRdbLinkParentFolder()},_isLayerVectorPrimitive:function(){return Utils.is(this.getContent())&&"LayerVectorPrimitive"===this.getContent().metaData.className},_hasRdbLinkParentFolder:function(){return Utils.is(this.getContent()._layer)&&Utils.is(this.getContent()._layer.getItemParent())&&"Folder"===this.getContent()._layer.getItemParent().metaData.className},_updateLoadInfo:function(){var e=this.get("Content");if(Utils.is(e)){var t=e.get("loadInfo");this.set("loadInfo",t)}}});return e.ObjectContructor.Feature=i}),define("DS/XCityGeometry/Label",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/EditableMesh3D","DS/Visualization/Mesh3D","DS/xCityBasicUtils/Utils","DS/Mesh/MeshUtils","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityTools/ShaderTools","DS/XCityTools/TextureTools","DS/Plugins/RenderPass","DS/Mesh/Mesh","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p){"use strict";var f=t.extend({});return f.labelBillboard={attributes:{alphaTest:.1},uniforms:{alphaTest:{type:"f",value:.1},top:{type:"f",value:0},left:{type:"f",value:0},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)},labelSize:{type:"v2",value:new e.Vector2(0,0)},geometrySize:{type:"v2",value:new e.Vector2(0,0)},geometryOffset:{type:"v3",value:new e.Vector3(0,0,0)},_angle:{type:"f",value:0},switchDistance:{type:"f",value:0}},vertex_pars:["uniform float top;","uniform float left;","uniform vec2 halfScreenResolution;","uniform vec2 labelSize;","uniform vec2 geometrySize;","uniform vec3 geometryOffset;","uniform float _angle;","uniform float switchDistance;"].join("\n"),vertex:["// RenderingCrossQuad MAP - Read CrossQuad info","/////////////////////////////////////////////////","mat2 rotationMatrix = mat2(cos(_angle), -sin(_angle), sin(_angle), cos(_angle));","vec3 rotatedPosition = vec3(position);","rotatedPosition.xy -= labelSize;","rotatedPosition.xy = rotatedPosition.xy * rotationMatrix;","rotatedPosition.xy += labelSize;","vec4 posCenterCameraSpace = vGetViewMatrix() * modelMatrix * vec4(0.0, 0.0, 0.0, 1.0);","vec4 posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;","posCenterScreenSpace /= posCenterScreenSpace.w;","vec3 offset = vec3(left, top, 0.0);","if (posCenterCameraSpace.z > -switchDistance)","{","  float scaleOffset = -switchDistance / posCenterCameraSpace.z;","  scaleOffset -= 1.0;","  float scaleLeft = geometrySize.x * geometryOffset.x;","  float scaleTop = geometrySize.y * geometryOffset.y;","  if (posCenterCameraSpace.z > -switchDistance)","  {","    scaleLeft *= scaleOffset;","    scaleTop *= scaleOffset;","  }","  offset += vec3(scaleLeft, scaleTop, 0.0);","}","vec3 positionLocal = rotatedPosition + offset;","vec2 offsetScreenSpace = positionLocal.xy/halfScreenResolution;","gl_Position = posCenterScreenSpace + vec4(offsetScreenSpace, 0.0, 0.0);"].join("\n"),fragment_pars:["varying vec3 colorFlag;"].join("\n"),fragment:[].join("\n")},f.labelBillboard_PDSFX={attributes:{alphaTest:.1},uniforms:{mapCity:{type:"t2",value:void 0},alphaTest:{type:"f",value:.1},top:{type:"f",value:0},left:{type:"f",value:0},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)},labelSize:{type:"v2",value:new e.Vector2(0,0)},geometrySize:{type:"v2",value:new e.Vector2(0,0)},geometryOffset:{type:"v3",value:new e.Vector3(0,0,0)},_angle:{type:"f",value:0},switchDistance:{type:"f",value:0}},varyings:{uvLabel:{type:"v2",length:1}},VS_overridableFunctions:{ProcessClipSpacePosition:["// RenderingCrossQuad MAP - Read CrossQuad info","/////////////////////////////////////////////////","mat2 rotationMatrix = mat2(cos(_angle), -sin(_angle), sin(_angle), cos(_angle));","vec3 rotatedPosition = vec3(position);","rotatedPosition.xy -= labelSize;","rotatedPosition.xy = rotatedPosition.xy * rotationMatrix;","rotatedPosition.xy += labelSize;","vec4 posCenterCameraSpace = vGetViewMatrix() * modelMatrix * vec4(0.0, 0.0, 0.0, 1.0);","vec4 posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;","posCenterScreenSpace /= posCenterScreenSpace.w;","vec3 offset = vec3(left, top, 0.0);","if (posCenterCameraSpace.z > -switchDistance)","{","  float scaleOffset = -switchDistance / posCenterCameraSpace.z;","  scaleOffset -= 1.0;","  float scaleLeft = geometrySize.x * (geometryOffset.x + 0.0) * scaleOffset;","  float scaleTop = geometrySize.y * (geometryOffset.y + 0.5) * scaleOffset;","  offset += vec3(scaleLeft, scaleTop, 0.0);","}","vec3 positionLocal = rotatedPosition + offset;","vec2 offsetScreenSpace = positionLocal.xy/halfScreenResolution;","ioPosition = posCenterScreenSpace + vec4(offsetScreenSpace, 0.0, 0.0);"].join("\n"),ComputeVaryingValues:["uvLabel = vGetAttribTexCoord0().xy;"].join("\n")},FS_overridableFunctions:{__ComputeAlbedo:["vec4 _raster = texture2D(mapCity, uvLabel);","return _raster.rgb;"].join("\n"),_ComputeDiffuseTexel:["return texture2D(mapCity, uvLabel);"].join("\n")}},f.poiText3D={attributes:{alphaTest:.1},uniforms:{alphaTest:{type:"f",value:.1},top:{type:"f",value:0},left:{type:"f",value:0},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)}},vertex_pars:["uniform float top;","uniform float left;","uniform vec2 halfScreenResolution;"].join("\n"),vertex:["// RenderingCrossQuad MAP - Read CrossQuad info","/////////////////////////////////////////////////","#ifdef USE_MAP","vUv = 1.0 - vUv;","#endif"].join("\n"),fragment_pars:[].join("\n"),fragment:[].join("\n")},f.label3D={attributes:{alphaTest:.1},uniforms:{normalDepthTexture:{type:"t",value:null},alphaTest:{type:"f",value:.1},switchDistance:{type:"f",value:0},scaleCulling:{type:"f",value:1},offsetAnchor:{type:"v3",value:e.Vector3()},labelRotationMatrix:{type:"m4",value:e.Matrix4()},enableAutomaticFlip:{type:"b",value:!1}},vertex_pars:["varying float isOpaque;","varying vec3 normalW;","varying vec4 colorW;","uniform sampler2D normalDepthTexture;","uniform float switchDistance;","uniform float scaleCulling;","uniform vec3 offsetAnchor;","uniform mat4 labelRotationMatrix;","uniform bool enableAutomaticFlip;"].join("\n"),vertex:["// RenderingCrossQuad MAP - Read CrossQuad info","/////////////////////////////////////////////////","#ifdef IS_MULTI_INSTANCED","vec3 center = -offsetAnchor;","#else","vec3 center = -offsetAnchor;","#endif","colorW = color;","normalW = normal;","vec4 posCenterCameraSpace = vGetViewMatrix() * modelMatrix * vec4(center, 1.0);","posCenterCameraSpace /= posCenterCameraSpace.w;","vec4 posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;","posCenterScreenSpace /= posCenterScreenSpace.w;","// Compute offset to rescale the POI in screen space (fixed size)","float scaleOffset = -posCenterCameraSpace.z/switchDistance;","if (posCenterCameraSpace.z > -switchDistance)","{","   scaleOffset = 1.0;","}","if (switchDistance < 0.001)","{","   scaleOffset = -posCenterCameraSpace.z/1000.0;","}","vec4 posVertexCameraSpace = vGetViewMatrix() * modelMatrix * vec4(position.xyz, 1.0);","posVertexCameraSpace /= posVertexCameraSpace.w;","vec4 vectorCameraSpace = posVertexCameraSpace - posCenterCameraSpace;","mvPosition = posCenterCameraSpace + vec4(vectorCameraSpace.xyz*(scaleOffset/scaleCulling), 0.0);","gl_Position = vGetProjectionMatrix() * mvPosition; //viewMatrix * modelMatrix * vec4(position, 1.0);","vertex_wPosition = modelMatrix * vec4(position.xyz*(scaleOffset/scaleCulling), 1.0);","vertex_viewdir = vec4(cameraPosition - vertex_wPosition.xyz, 0.0);","#if defined( USE_SHADOWMAP )","    worldPosition = vertex_wPosition;","#endif","vec4 vertex_normal = normalize(vec4(normal, 0.0));","vertex_wNormal = normalize(modelMatrix * vertex_normal);","mvNormal = vec3(vGetViewMatrix() * vertex_wNormal);","if (enableAutomaticFlip) {","vec4 labelUnitVecXWorldSpace = labelRotationMatrix * vec4(1.0, 0.0, 0.0, 1.0);","vec4 labelUnitVecXCameraSpace = vGetViewMatrix() * labelUnitVecXWorldSpace;","vec4 cameraUnitVecZCameraSpace = vec4(0.0, 0.0, 1.0, 1.0);","vec3 crossProduct = cross(cameraUnitVecZCameraSpace.xyz, labelUnitVecXCameraSpace.xyz);","if (crossProduct.x > 0.0) {","#ifdef USE_MAP","vUv = 1.0 - vUv;","#endif","}","}"].join("\n"),fragment_pars:"",fragment:""},f.label3D_PDSFX={attributes:{alphaTest:.1},uniforms:{normalDepthTexture:{type:"t",value:null},mapCity:{type:"t2",value:void 0},alphaTest:{type:"f",value:.1},switchDistance:{type:"f",value:0},scaleCulling:{type:"f",value:1},offsetAnchor:{type:"v3",value:e.Vector3()},labelRotationMatrix:{type:"m4",value:e.Matrix4()},enableAutomaticFlip:{type:"b",value:!1}},varyings:{normalW:{type:"v3"},colorW:{type:"v4"},isOpaque:{type:"f"}},VS_overridableFunctions:{ProcessClipSpacePosition:["// RenderingCrossQuad MAP - Read CrossQuad info","/////////////////////////////////////////////////","#ifdef IS_MULTI_INSTANCED","vec3 center = -offsetAnchor;","#else","vec3 center = -offsetAnchor;","#endif","colorW = color;","normalW = normal;","vec4 posCenterCameraSpace = vGetViewMatrix() * modelMatrix * vec4(center, 1.0);","posCenterCameraSpace /= posCenterCameraSpace.w;","vec4 posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;","posCenterScreenSpace /= posCenterScreenSpace.w;","// Compute offset to rescale the POI in screen space (fixed size)","float scaleOffset = -posCenterCameraSpace.z/switchDistance;","if (posCenterCameraSpace.z > -switchDistance)","{","   scaleOffset = 1.0;","}","if (switchDistance < 0.001)","{","   scaleOffset = -posCenterCameraSpace.z/1000.0;","}","vec4 posVertexCameraSpace = vGetViewMatrix() * modelMatrix * vec4(position.xyz, 1.0);","posVertexCameraSpace /= posVertexCameraSpace.w;","vec4 vectorCameraSpace = posVertexCameraSpace - posCenterCameraSpace;","vec4 mvPosition = posCenterCameraSpace + vec4(vectorCameraSpace.xyz*(scaleOffset/scaleCulling), 0.0);","ioPosition = vGetProjectionMatrix() * mvPosition; //vGetViewMatrix() * modelMatrix * vec4(position, 1.0);","vec4 vertex_wPosition = modelMatrix * vec4(position.xyz*(scaleOffset/scaleCulling), 1.0);","vec4 vertex_viewdir = vec4(cameraPosition - vertex_wPosition.xyz, 0.0);","#if defined( USE_SHADOWMAP )","    worldPosition = vertex_wPosition;","#endif","vec4 vertex_normal = normalize(vec4(normal, 0.0));","vec4 vertex_wNormal = normalize(modelMatrix * vertex_normal);","vec3 mvNormal = vec3(vGetViewMatrix() * vertex_wNormal);","normalW = mvNormal;","if (enableAutomaticFlip) {","vec4 labelUnitVecXWorldSpace = labelRotationMatrix * vec4(1.0, 0.0, 0.0, 1.0);","vec4 labelUnitVecXCameraSpace = vGetViewMatrix() * labelUnitVecXWorldSpace;","vec4 cameraUnitVecZCameraSpace = vec4(0.0, 0.0, 1.0, 1.0);","vec3 crossProduct = cross(cameraUnitVecZCameraSpace.xyz, labelUnitVecXCameraSpace.xyz);","if (crossProduct.x > 0.0) {","#ifdef USE_MAP","#endif","}","}"].join("\n")}},f.coloring_PDSFX={name:"coloring_PDSFX",depends:[],attributes:{},uniforms:{opacityCity:{type:"f",value:1}},FS_overridableFunctions:{ComputeOpacity:["cOpacity = opacityCity;"].join("\n")}},f.getCurrentDimensions=function(e){var t=e.USR.webGLV6Viewer;return{width:t.SCREEN_WIDTH,height:t.SCREEN_HEIGHT}},f._initMaterial=function(e){return s.is(this._matPoiText)||(this._matPoiText="billboard"===e?l.getPDSFXMaterial([f.coloring_PDSFX,f.labelBillboard_PDSFX],"basic"):l.getPDSFXMaterial([f.coloring_PDSFX,f.label3D_PDSFX],"physical")),this._matPoiText.clone()},f.generateTextNode=function(i,r,a,l,u,c,p,m,g=!1,v,_,y){r.label.name.length>50&&(r.label.name=r.label.name.substr(0,47)+"...");let b=this._initMaterial(r.label.position.mode);s.is(c)&&b.updatePDSFXUniform("switchDistance",c);var x=this.getCurrentDimensions(i),C={x:x.width/2,y:x.height/2};b.updatePDSFXUniform("halfScreenResolution",C),b.depthTest=!1,b.transparent=!0;var S=function(){var e={x:i.USR.webGLV6Viewer.SCREEN_WIDTH/2,y:i.USR.webGLV6Viewer.SCREEN_HEIGHT/2};b.updatePDSFXUniform("halfScreenResolution",e),i.USR._needRender=!0};i._frmViewerContainer.addEvent("resize",S),s.addObserver(b,function(){i._frmViewerContainer.removeEvent("resize",S)}),S();let D=h.computeLabelSize(r.label.name,r.label);var P=D.width,w=D.height,M=f.computeAnchorPointOffset(P,w,a,r.label.position.labelOffset);"3D"===r.label.position.mode&&(b.updatePDSFXUniform("offsetAnchor",M),b.updatePDSFXUniform("enableAutomaticFlip",r.label.position.enableAutomaticFlip));let T=new t,I={};I.material=b,I.bBox=new e.Box3(new e.Vector3(0,0,0),new e.Vector3(D.width,D.height,0)),I.setVisibilityOrCreate=function(t){if(!b.isLoading&&t){var a=function(t){if(b.updatePDSFXUniform("mapCity",t),"billboard"===r.label.position.mode){let i=b.getPDSFXUniform("labelSize").value,s=2*i.x,n=2*i.y,a=t.image.width,o=t.image.height,l=b.getPDSFXUniform("top").value,h=b.getPDSFXUniform("left").value;l+=(n-o)/2,h+=(s-a)/2,l-=n*r.label.position.labelOffset.y,l+=o*r.label.position.labelOffset.y,h-=s*r.label.position.labelOffset.x,h+=a*r.label.position.labelOffset.x,b.updatePDSFXUniform("labelSize",new e.Vector2(a/2,o/2)),b.updatePDSFXUniform("top",l),b.updatePDSFXUniform("left",h)}b._deferredMaterialsInit=!1,b.isLoaded=!0,b.needsUpdate=!0,i.USR._needRender=!0,y.removeChild(T);var a=o.createRectangleNode({width:t.image.width,height:t.image.height,color:new n.Color(1,.5,.5,1),fill:!0,material:b});T.observers=null,a.setMaterial(b),a.mesh3js.material=b,a.setShadow(!1,!1),b._deferredMaterialsInit=!1,s.is(this.visibilityToPut)&&(a.setVisibility(this.visibilityToPut),delete this.visibilityToPut),a.setMatrix(I.matrix),a.setFrustumCulled(!1),a.setExcludeFromBounding(!0),a.setPickable(n.PICKABLE),y.addChild(a);a.setRenderPasses(["LabelOverlayPostPass"]),g&&"billboard"===r.label.position.mode&&i.labelManager.replacePoi(I,a),this.setVisibilityOrCreate=function(e){this.visible!=e&&this.setVisibility(e)}.bind(this)}.bind(this);b.isLoading=!0,h.generateLabelTexture(r.label.name,r.label,a,1)}b.isLoaded?this.visible!=t&&this.setVisibility(t):this.visibilityToPut=t};if(void 0===i.getView3D().getRenderPassManager().getPass("LabelOverlayPostPass")){var R=new d(null,null,void 0,!0,!1,!1,"LabelOverlayPostPass");R.idString="LabelOverlayPostPass",i.getView3D().getRenderPassManager().addPass("LabelOverlayPostPass",R),i.getView3D().getRenderPassManager()._mainComposer.insertCustomPassAfterNEW(R,"noz")}if(r.label.position.mode,s.is(c)&&(b.updatePDSFXUniform("geometrySize",new e.Vector2(a.width,a.height)),b.updatePDSFXUniform("geometryOffset",r.label.position.geometryOffset)),"billboard"===r.label.position.mode)if("billboard"===u){var A=(new e.Matrix4).translate(new e.Vector3(l.x,l.y,l.z));if(b.updatePDSFXUniform("labelSize",new e.Vector2(P/2,w/2)),b.updatePDSFXUniform("_angle",s.toRad(r.label.position.rotation.x)),s.is(b.getPDSFXUniform("top").value)){var F=a.height/2-w/2;F+=w*r.label.position.labelOffset.y,F+=r.label.position.geometryOffset.y*a.height,F+=r.label.position.offset.y,b.updatePDSFXUniform("top",F)}if(s.is(b.getPDSFXUniform("left").value)){var L=-P/2;L+=P*r.label.position.labelOffset.x,L+=r.label.position.geometryOffset.x*a.width,L+=r.label.position.offset.x,b.updatePDSFXUniform("left",L)}}else if("polygon"===u){A=(new e.Matrix4).translate(new e.Vector3(l.x+r.label.position.geometryOffset.x*a.width,l.y+r.label.position.geometryOffset.y*a.length,l.z+r.label.position.geometryOffset.z*a.height));if(b.updatePDSFXUniform("labelSize",new e.Vector2(P/2,w/2)),b.updatePDSFXUniform("_angle",s.toRad(r.label.position.rotation.x)),s.is(b.getPDSFXUniform("top").value)){F=-w/2;F+=w*r.label.position.labelOffset.y,F+=r.label.position.offset.y,b.updatePDSFXUniform("top",F)}if(s.is(b.getPDSFXUniform("left").value)){L=-P/2;L+=P*r.label.position.labelOffset.x,L+=r.label.position.offset.x,b.updatePDSFXUniform("left",L)}}else{A=(new e.Matrix4).translate(new e.Vector3(l.x,l.y,l.z));if(b.updatePDSFXUniform("labelSize",new e.Vector2(P/2,w/2)),b.updatePDSFXUniform("_angle",s.toRad(r.label.position.rotation.x)),s.is(b.getPDSFXUniform("top").value)){F=a.height/2-w/2;F+=w*r.label.position.labelOffset.y,F+=r.label.position.geometryOffset.y*a.height,F+=r.label.position.offset.y,b.updatePDSFXUniform("top",F)}if(s.is(b.getPDSFXUniform("left").value)){L=-P/2;L+=P*r.label.position.labelOffset.x,L+=r.label.position.geometryOffset.x*a.width,L+=r.label.position.offset.x,b.updatePDSFXUniform("left",L)}}if("3D"===r.label.position.mode){A=(new e.Matrix4).translate(M);var V=(new e.Matrix4).rotateX(s.toRad(r.label.position.rotation.x)).rotateY(s.toRad(r.label.position.rotation.y)).rotateZ(s.toRad(r.label.position.rotation.z));A.multiplyMatrices(V,A),A.multiplyMatrices((new e.Matrix4).translate(new e.Vector3(l.x+r.label.position.geometryOffset.x*a.width+r.label.position.offset.x,l.y+r.label.position.geometryOffset.y*a.length+r.label.position.offset.y,l.z+a.height/2+r.label.position.geometryOffset.z*a.height+r.label.position.offset.z)),A),b.updatePDSFXUniform("labelRotationMatrix",A)}if(I.matrix=A,g&&"billboard"===r.label.position.mode){var O=l.z;"polygon"===u&&(O=(new e.Vector3).getPositionFromMatrix(A).z);var N=i.labelManager.addGroup(m,!0);!s.is(v)||"billboard"!==u&&"line"!==u&&"pyramid"!==u&&"sphere"!==u&&"tube"!==u&&"disc"!==u?i.labelManager.registerPOI(I,N,r.label.position.mode,O,(new e.Vector3).getPositionFromMatrix(A),p,void 0,_):i.labelManager.registerPOI(I,N,r.label.position.mode,l.z,(new e.Vector3).addVectors((new e.Vector3).getPositionFromMatrix(A),v),p,c,_),s.addObserver(T,function(){i.labelManager.unregisterPOI(T.temporaryTextNode),i._frmViewerContainer.removeEvent("resize",S)}),T.temporaryTextNode=I,y.addChild(T)}else I.setVisibilityOrCreate(!0);return I.name="textNode_"+p,I},f.computeAnchorPointOffset=function(t,i,r,s){var n=new e.Vector3(0,0,0);return n.x=n.x-t/2,n.y=n.y-i/2,n.x=n.x+t*s.x,n.y=n.y+i*s.y,n},f}),define("DS/XCityGeometry/PatchVectorFactoryPointGeometry",["UWA/Core","DS/XCityGeometry/PatchVectorFactory","DS/XCityGeometry/Label","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t,i,r,s){"use strict";return t.extend({init:function(e,t,i){this._parent(e,t,i)},_computeAltitudeToApply:function(e,t){var i=0;return i=3===t.length&&"geometry"===e.elevationMode?t[2]:"advanced"===e.elevationMode||"geometry"===e.elevationMode?e.elevation:this.urban.USR.getGroundHeight(t[0],t[1]),e.elevationOffset&&(i+=e.elevationOffset),i},_generateLabel:function(e,t,r,s,n,a,o){var l=!1,h=void 0;if(Utils.is(this._node.userData)&&(l=!0,h=this._node.userData._attributes.id),this.labelManagerVisibility||(this.labelManagerVisibility=!0,this._node.userData.addEvent("onChange:visible",this.urban.labelManager.onChangeVisibility,this)),"FactoryPointOfInterest3D"===this._node.name)var d=this.switchDistance,u=this.factoryParam.shapeType;return i.generateTextNode(this.urban,r,s,e,u,d,t,h,l,n,a,o)}})}),define("DS/XCityLayer/VectorLoaderEnovia",["DS/Visualization/ThreeJS_DS","DS/XCityLayer/Vector","DS/XCityTools/Geocoder","UWA/Class","DS/xCityBasicUtils/DataFormatTools"],function(e,t,i,r,s){"use strict";return r.extend({init:function(e){this._urban=e},requestData:function(e,t){console.error("VectorLoaderEnovia : requestData() should not be called !")},loadDataSource:function(e){if(""!==e){var t=JSON.parse(e),i={list:t.hits,index:0,count:t.hits.length,nhits:t.nhits,isCluster:t.nhits!==t.nmatches,getNextFeature:this.getNextFeature.bind(this)};return i.getNextFeature=this.getNextFeature.bind(this,i),i}return{list:[],index:0,count:0}},loadDataSourceFromObject:function(e){if(""!==e){var t={list:e.hits,index:0,count:e.hits.length,nhits:e.nhits,isCluster:e.nhits!==e.nmatches,getNextFeature:this.getNextFeature.bind(this)};return t.getNextFeature=this.getNextFeature.bind(this,t),t}return{list:[],index:0,count:0}},getNextFeature:function(e,t){if(e.index<e.count){var i=this.parseFeature(e.list[e.index],t,e.index,e.tile);return e.index++,i}return null},parseFeature:function(e,t,i,r){for(var s={},n=e.metas.length-1;n>=0;--n){var a=e.metas[n];s[a.name]=a.value}var o=this.parseGeometry(s);t.clear(),t.setGeometry(o);for(var l=Object.keys(s),h=0,d=l.length;h<d;h++)t.setAttribute(l[h],s[l[h]]);return void 0===t.get("STRID")&&t.setAttribute("STRID",t.get("url")),t},parsePoint:function(e,r){return void 0!==r?(e=i.proj(e,r),new t.Point3D(e.x,e.y,e.z)):3===e.length&&e[2]?new t.Point3D(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])):new t.Point2D(parseFloat(e[0]),parseFloat(e[1]))},parseMultiPoint:function(i,r){for(var s=i.length,n=new t.MultiPoint,a=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),o=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),l=0;l<s;++l){var h=this.parsePoint(i[l],r);n.addGeometry(h),a.set(a.x>h.x?h.x:a.x,a.y>h.y?h.y:a.y),o.set(o.x<h.x?h.x:o.x,o.y<h.y?h.y:o.y)}return n.setAABBox(a,o),n},parsePolygon:function(i,r){for(var s=new t.Polygon,n=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),a=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),o=0,l=i.length;o<l;o++){for(var h=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),d=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),u=new t.LineString,c=i[o],p=0,f=c.length;p<f;p++){var m=this.parsePoint(c[p],r);(p!==f-1||u.vertexList[0].x!==m.x&&u.vertexList[0].y!==m.y)&&(h.set(h.x>m.x?m.x:h.x,h.y>m.y?m.y:h.y),d.set(d.x<m.x?m.x:d.x,d.y<m.y?m.y:d.y),u.addVertex(m))}u.setAABBox(h,d),s.addGeometry(u),n.set(n.x>h.x?h.x:n.x,n.y>h.y?h.y:n.y),a.set(a.x<d.x?d.x:a.x,a.y<d.y?d.y:a.y)}return s.setAABBox(n,a),s},parseMultiPolygon:function(i,r){for(var s=i.length,n=new t.MultiPolygon,a=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),o=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),l=0;l<s;++l){var h=this.parsePolygon(i[l],r);n.addGeometry(h);var d=h.getSize().clone();d.multiplyScalar(.5);var u=h.getCenter().clone().sub(d),c=h.getCenter().clone().add(d);a.set(a.x>u.x?u.x:a.x,a.y>u.y?u.y:a.y),o.set(o.x<c.x?c.x:o.x,o.y<c.y?c.y:o.y)}return n.setAABBox(a,o),n},parseLine:function(i,r){for(var s=new t.LineString,n=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),a=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),o=0;o<i.length;o++){var l=this.parsePoint(i[o],r);s.addVertex(l),n.set(n.x>l.x?l.x:n.x,n.y>l.y?l.y:n.y),a.set(a.x<l.x?l.x:a.x,a.y<l.y?l.y:a.y)}return s.setAABBox(n,a),s},parseMultiLine:function(i,r){for(var s=i.length,n=new t.MultiLineString,a=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),o=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),l=0;l<s;++l){var h=this.parseLine(i[l],r);n.addGeometry(h);var d=h.getSize().clone();d.multiplyScalar(.5);var u=h.getCenter().clone().sub(d),c=h.getCenter().clone().add(d);a.set(a.x>u.x?u.x:a.x,a.y>u.y?u.y:a.y),o.set(o.x<c.x?c.x:o.x,o.y<c.y?c.y:o.y)}return n.setAABBox(a,o),n},parseGeometry:function(e){if(void 0!==e){var t=e.geometry||e.gdal_default_geo;if(void 0!==t){var i=s.fromWKTToArray(t),r=t.indexOf("MULTIPOLYGON");return-1!==r?this.parseMultiPolygon(i,void 0):-1!==(r=t.indexOf("POLYGON"))?this.parsePolygon(i,void 0):-1!==(r=t.indexOf("MULTILINESTRING"))?this.parseMultiLine(i,void 0):-1!==(r=t.indexOf("LINESTRING"))?this.parseLine(i,void 0):-1!==(r=t.indexOf("MULTIPOINT"))?this.parseMultiPoint(i,void 0):-1!==(r=t.indexOf("POINT"))?this.parsePoint(i[0],void 0):null}}}})}),define("DS/XCityModel/Folder",["DS/XCityModel/Feature","UWA/Core","UWA/Class/Collection","DS/XCityModel/Item","DS/xCityBasicUtils/LoadingProgressList"],function(e,t,i,r,s){"use strict";var n=i.extend({model:e}),a=e.extend({defaults:t.merge({children:null,exclusive:!1,opened:!0},e.prototype.defaults),metaData:{type:"Feature",className:"Folder"},loaderJSON:t.merge({children:"loadJSONChildren",Root:"loadJSONChildren"},e.loaderJSON),setup:function(){this._parent(),this.set("children",new n),this.addEvent("onChange:visible",this._visibilityUpdatedFolder,this),this.nbChildrenToLoad=0},_setupSubElementsOrder:function(){var e=0;void 0!==this.get("PointOfView")&&null!==this.get("PointOfView")&&(this.get("PointOfView")._order=e,e++),void 0!==this.get("Content")&&null!==this.get("Content")&&(this.get("Content")._order=e,e++);for(var t=0,i=this.getNumChildren();t<i;++t){var r=this.getChild(t);r._order=e,r.dispatchEvent("onChange:order"),e++}},destroy:function(e){this.clear(),this._parent(e)},loadJSONChildren:function(e,t,i,s,n){for(var a=0;a<i.length;a++){var o=i[a];if(Utils.is(o)){var l=o.className||"Feature",h=r.ObjectContructor[l];if(h)(new h).loadJSON(e,o,this,!0,void 0,n)}else console.warn("A "+this.get("name")+"'s child is not valid")}},clear:function(){return this.removeChildren(),this.get("children").reset(),this},removeChildren:function(){for(var e=this.get("children").toArray(),t=0;t<e.length;t++)this.removeChild(e[t])},create:function(e){if(!this._parent(e))return!1;for(var t=this.get("children").toArray(),i=0;i<t.length;i++)t[i]._created||t[i].create(e);return!0},addChild:function(e,t){var i;return e._itemParent&&e._itemParent.removeChild(e),e.addEvent("onChange:loadInfo",this.updateLoadInfo,this),e.setItemParent(this),e.index=t,i=this._checkFeaturePosition(e,t),this.get("children").add(e,{at:i}),!0===e.get("visible")&&(this.setVisible(!0,!1),!0===this.get("exclusive")&&this.childVisible(e,!0)),e.addTags(this.get("tags")),this._childAdded(this,e),e.addEvent("onChange:visible",this.childVisible,this),this.addEvent("onAdded:tag",e.addTag,e),this.addEvent("onRemoved:tag",e.removeTag,e),this._setupSubElementsOrder(),this},_checkFeaturePosition:function(e,t){var i=t;return this.get("children").length<=t&&(i=this._positionInTheHead(e,t)),i},_positionInTheHead:function(e,t){var i=t;return this.get("children").length>0&&this.get("children").last().index>e.index&&(i=this.get("children").length-1),i},removeChild:function(e){return this.findChildById(e.get("id"))&&(e.set("selected",!1),e.getContent()&&"RdbLink"===e.getContent().metaData.className&&e.dispatchEvent("onChange:selected",e),this.get("children").remove(e),e.setItemParent(void 0),this._childRemoved(this,e),e.removeEvent("onChange:visible",this.childVisible),e.removeEvent("onChange:loadInfo",this.updateLoadInfo,this),this.removeEvent("onAdded:tag",e.addTag),this.removeEvent("onRemoved:tag",e.removeTag),this._setupSubElementsOrder()),this},getNumChildren:function(){return this.get("children").length},incrNumChildrenToLoad:function(){this.nbChildrenToLoad++},decrNumChildrenToLoad:function(){this.nbChildrenToLoad>0&&this.nbChildrenToLoad--},getNumChildrenToLoad:function(){return this.nbChildrenToLoad},getChild:function(e){return this.get("children").at(e)},findWhere:function(e,t){var i=this.get("children").findWhere(e);return i||!0!==t||this.traverse(function(t){var r=t.get("children");return r&&r.length&&!i&&(i=r.findWhere(e)),void 0!==i},!0),i},where:function(e,t){var i=this.get("children").where(e);return!0===t&&this.traverse(function(t){var r=t.get("children");r&&r.length&&(i=i.concat(r.where(e)))},!0),i},findChildByName:function(e,t){return this.findWhere({name:e},t)},findChildById:function(e,t){return this.findWhere({id:e},t)},findChildrenByName:function(e,t){return this.where({name:e},t)},getChildrenByClassName:function(e,t){var i=[];return this.traverse(function(t){t.metaData.className===e&&i.push(t)},t),i},childVisible:function(e){!0===e.get("visible")&&(this.set("visible",!0),!0===this.get("exclusive")&&this.get("children").forEach(function(t){t!==e&&t.setVisible(!1,!0)}))},updateLoadInfo:function(e){Utils.is(e)&&(Utils.is(this._loadingProgressList)||(this._loadingProgressList=new s(this._progressEvent.bind(this),this._loadFinished.bind(this))),this._loadingProgressList.updateLoading(e.get("id"),e.get("loadInfo")))},_progressEvent:function(e){this.set("loadInfo",e)},_loadFinished:function(){},setVisible:function(e,t){return this._parent(e),t&&!0===e&&(!0===this.get("exclusive")&&!0===e&&this.get("children").length>0?this.get("children").at(0).setVisible(!0,t):this.invoke("setVisible",e,t)),this},select:function(e,t){return this._parent("select"),t&&this.invoke("select",e,t),this},traverse:function(e,t,i){this.get("children").forEach(function(r){!0!==e(r,i)&&!0===t&&r.traverse&&r.traverse(e,t,i)},this)},invoke:function(e,t){var i=Array.prototype.slice.call(arguments,1);return this.get("children").forEach(function(r){r[e].apply(r,i),!0===t&&r.invoke&&r.invoke(e,t)},this),this},moveChild:function(e,t,i){return this.findChildById(e.get("id"))?(e.set("selected",!1),this.get("children").remove(e),this.dispatchEvent("onChildRemove",e),e._itemParent=void 0,Utils.is(i)||(i=this),i.addChild(e,t),this._setupSubElementsOrder(),i.dispatchEvent("onChildMove",e),this):this},_childAdded:function(e,t){this._itemParent&&this._itemParent._childAdded(e,t),this.dispatchEvent("onChildAdd",t)},_childRemoved:function(e,t){this._itemParent&&this._itemParent._childRemoved(e,t),this.dispatchEvent("onChildRemove",t)},_visibilityUpdatedFolder:function(){!1===this.get("visible")&&this.invoke("setVisible",!1)},_selectedUpdated:function(){if(!0===this.get("selected"))for(var e=this.get("children").toArray(),t=0;t<e.length;t++)e[t].set("selected",!0)}});return r.ObjectContructor.Folder=a}),define("DS/XCityGeometry/Line",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils","DS/Mesh/MeshUtils","DS/XCityTools/EventDispatcher","DS/XCityLayer/Vector"],function(e,t,i,r,s,n,a){"use strict";var o=e.extend({init:function(e,t){var i,r;if(this.urban=e,this._parent(),void 0!==(i=void 0!==t.geom?t.geom:void 0)){r=t.numLine,this.creators=t.creators,this._rendering=t.rendering,this._coordinates=t.coordinates,this.attributes=t.attributes,this.lineId=void 0!==t.id?t.id:this.id;var s=this._rendering.getCompleteMaterialInfo(this.lineId,this.attributes);this.flags=this._rendering.getFlagForPrimitive(this.lineId,this.attributes),this.dynamicUpdate=s.dynamicUpdate,this.animation=s.animation,this._applyMaterial(),this._createShape(i,r),this.oldCamPos={x:0,y:0,z:0}}},_createShape:function(e,t){var i,r=this.creators.lineMesh;for(i=0;i<e.getNumGeometries();++i){var n=a.getVerticesAsArrayOfLines(e,i);n&&(r.startPrimitive(s.ConnectivityTypeEnum.LINES),this._buildLines({points:n,numLine:t,creators:this.creators}),r.endPrimitive(this.lineId))}},_buildLines:function(e){var i,s,n,a=e.points,o=e.numLine,l=e.creators.lineMesh,h=a.length,d=0,u=0,c=0;l.vertexBindingArray.buffer.size>0&&(d=l.vertexBindingArray.buffer.data[l.vertexBindingArray.buffer.size-1]+1);var p={x:a[0].x,y:a[0].y,z:a[0].z},f={x:a[0].x,y:a[0].y,z:a[0].z};for(i=0;i<h;i+=1)s=a[i],i>0&&(c+=Math.sqrt(Math.pow(n.x-s.x,2)+Math.pow(n.y-s.y,2)+Math.pow(n.z-s.z,2))),s.x<p.x?p.x=s.x:s.x>f.x&&(f.x=s.x),s.y<p.y?p.y=s.y:s.y>f.y&&(f.y=s.y),s.z<p.z?p.z=s.z:s.z>f.z&&(f.z=s.z),n=s;if(this._lineCenter=new t.Vector3((p.x+f.x)/2,(p.y+f.y)/2,(p.z+f.z)/2),h>2){var m=a[parseInt(h/2)];this._lineMiddle=new t.Vector3(m.x,m.y,m.z)}else this._lineMiddle=this._lineCenter;for(i=0;i<h;i+=1)s=a[i],i>0&&(u+=Math.sqrt(Math.pow(n.x-s.x,2)+Math.pow(n.y-s.y,2)+Math.pow(n.z-s.z,2))),l.pushVertex([s.x,s.y,s.z]),l.pushColor([o,c,u,i]),n=s;for(i=0;i<h-1;i+=1)l.pushVertexIndices([d]),l.pushVertexIndices([d+1]),d+=1;r.is(this._lengths)||(this._lengths=[]),this._lengths.push(c)},_updateTextureInfo:function(e,t){var i=this.creators.textureInfo.idMap[this.lineId],r=this.creators.textureInfo.texture.image;r.data[i*r.width+e]=t,this.creators.textureInfo.texture.needsUpdate=!0},_computeLineWidthAndOpacityOnDistance:function(){if(this.dynamicUpdate&&r.is(this.creators.textureInfo.texture)){this.lineWidth,this.opacity;var e,t,i,s=this.urban.getViewpoint().getPosition(),n=this._rendering._material;n[0],n[1],this.creators.textureInfo.idMap[this.lineId];s.x===this.oldCamPos.x&&s.y===this.oldCamPos.y&&s.z===this.oldCamPos.z||(i=r.is(this._coordinates)&&r.is(this._coordinates.getLocalPosition)?this._lineCenter.clone().add(this._coordinates.getLocalPosition()):this._lineCenter,this.oldCamPos.x=s.x,this.oldCamPos.y=s.y,this.oldCamPos.z=s.z,(e=i.clone().sub(s).length())<this.minDist&&(e=this.minDist),e>this.maxDist&&(e=this.maxDist),t=1-Math.min(1,(e-this.minDist)/(this.maxDist-this.minDist)),this.computedLineWidth=Math.ceil(Math.max(this.minWidth,this.lineWidth*t)),this.computedOpacity=Math.max(this.minOpacity,this.opacity*t))}},_updateOnDistance:function(){},_setColor:function(e,t){var i=this.color;return this.color=e,this._updateTextureInfo(o.BUFFER_IMAGE.COLOR_RED,e.r),this._updateTextureInfo(o.BUFFER_IMAGE.COLOR_GREEN,e.g),this._updateTextureInfo(o.BUFFER_IMAGE.COLOR_BLUE,e.b),i},_setOpacity:function(e,t){var i=this.opacity;return void 0!==e&&(this.opacity=e),this._updateTextureInfo(o.BUFFER_IMAGE.OPACITY,this.opacity),i},_setLineWidth:function(e,t){var i=this.lineWidth;return void 0!==e&&(this.lineWidth=e),this._updateTextureInfo(o.BUFFER_IMAGE.LINE_WIDTH,this.lineWidth),i},_setSpeed:function(e,t){var i=this.speed;return this.speed=e,this._updateTextureInfo(o.BUFFER_IMAGE.SPEED,e),i},_setSamplingRate:function(e,t){var i=this.samplingRate;return this.samplingRate=e,this._updateTextureInfo(o.BUFFER_IMAGE.SAMPLING_RATE,e),i},_setOpacityFactor:function(e,t){var i=this.opacityFactor;return this.opacityFactor=e,this._updateTextureInfo(o.BUFFER_IMAGE.OPACITY_FACTOR,e),i},_setMinOpacity:function(e,t){var i=this.minOpacity;return this.minOpacity=e,this._updateTextureInfo(o.BUFFER_IMAGE.MIN_OPACITY,e),i},_setMinWidth:function(e,t){var i=this.minWidth;this.minWidth=e;for(var r=this._rendering._getMaterial(),s=0;s<r.length;++s)r[s].updatePDSFXUniform("minWidth",e);return i},_setMinDist:function(e,t){var i=this.minDist;this.minDist=e;for(var r=this._rendering._getMaterial(),s=0;s<r.length;++s)r[s].updatePDSFXUniform("minDist",e);return i},_setMaxDist:function(e,t){var i=this.maxDist;this.maxDist=e;for(var r=this._rendering._getMaterial(),s=0;s<r.length;++s)r[s].updatePDSFXUniform("maxDist",e);return i},_setNbPoints:function(e,t){var i=this.nbPoints;return this.nbPoints=e,this._updateTextureInfo(o.BUFFER_IMAGE.NB_POINTS,e),i},_setDashSize:function(e,t){var i=this.dashSize;return this.dashSize=e,this._updateTextureInfo(o.BUFFER_IMAGE.DASH_SIZE,e),i},_setGapSize:function(e,t){var i=this.gapSize;return this.gapSize=e,this._updateTextureInfo(o.BUFFER_IMAGE.GAP_SIZE,e),i},_setReverse:function(e,t){var i=this.reverse;return this.reverse=e,this._updateTextureInfo(o.BUFFER_IMAGE.REVERSE,e),i},_setLoop:function(e,t){var i=this.loop;return this.loop=e,this._updateTextureInfo(o.BUFFER_IMAGE.LOOP,e),i},setAttribute:function(e,t,i){return this[o.attributeSetter[e]](t,i)},setFlaggedAttribute:function(e,t,i){return this.updateFlags(e,1),this.setAttribute(e,t,i)},isFlagged:function(e){return!!r.is(o.FLAGS[e])},updateFlags:function(e,t){if(this.isFlagged(e)){var i=o.FLAGS[e],s=r.floatPack(this.flags,i,t);this._setFlags(s)}},getFlagsFromPrimitiveRendering:function(e){var t,i,s=Object.keys(e),n=s.length,a=0;for(t=0;t<n;t++)if(i=s[t],this.isFlagged(i)){var l=o.FLAGS[i];a=r.floatPack(a,l,!0)}return a},_setFlags:function(e,t){var i=this.flags;return this.flags=e,this._updateTextureInfo(o.BUFFER_IMAGE.FLAGS,e),i},_applyMaterial:function(){var e=this,t=this._rendering.getCompleteMaterialInfo(this.lineId,this.attributes);o.getSettableAttributes().forEach(function(i){r.is(t[i])&&(e[i]=t[i])})},_setDashPatternIndex:function(e,t){var i=this.dashIndex,s=1,n=0;return r.is(e)&&(n=this._rendering.getIndexFromPattern(e),r.is(n)||(n=0),s=e[e.length-1]),this.dashIndex=n,this.dashLength=s,this._updateTextureInfo(o.BUFFER_IMAGE.DASH_INDEX,n),this._updateTextureInfo(o.BUFFER_IMAGE.DASH_LENGTH,s),i}});return o.attributeSetter={color:"_setColor",opacity:"_setOpacity",opacityFactor:"_setOpacityFactor",minOpacity:"_setMinOpacity",lineWidth:"_setLineWidth",speed:"_setSpeed",samplingRate:"_setSamplingRate",nbPoint:"_setNbPoints",dashSize:"_setDashSize",gapSize:"_setGapSize",reverse:"_setReverse",loop:"_setLoop",dashPattern:"_setDashPatternIndex",dashPatternLayer:"_setDashPatternIndex"},o.getSettableAttributes=function(){var e,t=[];for(e in o.attributeSetter)o.attributeSetter.hasOwnProperty(e)&&t.push(e);return t},o.BUFFER_IMAGE={COLOR_RED:0,COLOR_GREEN:1,COLOR_BLUE:2,LINE_WIDTH:3,OPACITY:4,OPACITY_FACTOR:5,SPEED:6,NB_POINTS:7,OFFSET:8,REVERSE:9,DASH_SIZE:10,SAMPLING_RATE:11,MIN_OPACITY:12,GAP_SIZE:13,LOOP:14,FLAGS:15,DASH_INDEX:16,DASH_LENGTH:17},o.FLAGS={color:0,opacity:1,lineWidth:2},o}),define("DS/XCityLoaders/StreamVisuLoader",["DS/Visualization/StreamVisuLoader","DS/Visualization/ThreeJS_DS","DS/XCityLoaders/BaseLoader","DS/XCityLoaders/ModelLoader","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s){"use strict";return i.extend({load:function(e,t){this._parent(e,t);var i=this._generateObjectToLoad();return i.gasSharing=!1,this.loader.load(i),this.model.node},_nodeCallback:function(e,t,i){i.setRendering=function(e,t,i){var r=this.material;!s.is(r)&&s.is(this.mesh3js)&&(r=this.mesh3js.material);var n=e.color;if(s.is(n)){if(t.setColor)t.setColor(n);else if(t.container&&t.container.material){var a=t.container&&t.container.material;a.ambient&&a.ambient.setRGB(n.r,n.g,n.b),a.diffuse&&a.diffuse.setRGB(n.r,n.g,n.b),a.color&&a.color.setRGB(n.r,n.g,n.b)}s.is(r)&&(r.color.copy(n),r.ambient.copy(n))}var o=e.opacity;s.is(o)&&(t.setOpacity?o=t.setOpacity(o):t.container&&t.container.material&&t.container.material.setOpacity&&t.container.material.setOpacity(o),s.is(r)&&(r.opacity=o))},i.setColor=function(e,t){var i,r;for(r=0;r<t.length;r+=1)if(t[r].setColor)i=t[r].setColor(e);else if(t[r].container&&t[r].container.material){var n=t[r].container&&t[r].container.material;n.ambient&&n.ambient.setRGB(e.r,e.g,e.b),n.diffuse&&n.diffuse.setRGB(e.r,e.g,e.b),n.color&&n.color.setRGB(e.r,e.g,e.b)}var a=this.material;return!s.is(a)&&s.is(this.mesh3js)&&(a=this.mesh3js.material),s.is(a)&&(i=a.color.clone(),a.color.copy(e),a.ambient.copy(e)),i},i.setOpacity=function(e,t){var i,r;for(r=0;r<t.length;r+=1)t[r].setOpacity?i=t[r].setOpacity(e):t[r].container&&t[r].container.material&&t[r].container.material.setOpacity&&t[r].container.material.setOpacity(e);var n=this.material;return!s.is(n)&&s.is(this.mesh3js)&&(n=this.mesh3js.material),s.is(n)&&(i=n.opacity,n.opacity=e),i};var r=t.data.geometries;r.length;Array.isArray(r)||Object.keys(r).length},_doneCallback:function(){if(void 0!==this.model.callback){var e=!1;this.model.node.children.length>0&&(e=!0),this.model.callback(this.model.node,e,this.model.name)}},_addCustomShaders:function(e){this._needCustomShaders()&&(e.materialCallback=this._getModelMaterial.bind(this,this.model.shader))}})}),define("DS/XCityGeometry/PatchVectorFactoryLineStringGeometry",["UWA/Core","DS/XCityGeometry/PatchVectorFactory","DS/XCityGeometry/Label","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t,i,r,s){"use strict";return t.extend({init:function(e,t,i){this._parent(e,t,i)},_computeAltitudeToApply:function(e,t){var i=0;return i=Utils.is(t.z)&&"geometry"===e.elevationMode?t.z:"advanced"===e.elevationMode||"geometry"===e.elevationMode?e.elevation:this.urban.USR.getGroundHeight(t.x,t.y),e.elevationOffset&&(i+=e.elevationOffset),i},_generateLabel:function(e,t,r,s,n,a,o){var l=void 0,h=!1;return Utils.is(this._node.userData)&&(h=!0,l=this._node.userData._attributes.id),this.labelManagerVisibility||(this.labelManagerVisibility=!0,this._node.userData.addEvent("onChange:visible",this.urban.labelManager.onChangeVisibility,this)),i.generateTextNode(this.urban,r,s,e,"line",void 0,t,l,h,n,a,o)}})}),define("DS/XCityLoaders/CityLoader",["DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/ThreeDXLoader","DS/Visualization/ThreeJS_DS","DS/XCityLoaders/BaseLoader","DS/XCityLoaders/ModelLoader","DS/XCityTools/Downloader"],function(e,t,i,r,s,n,a){"use strict";var o=s.extend({init:function(e,t){this._parent(e,t),this.initThreeDXLoader()},initThreeDXLoader:function(){this.loader=this.threeDXLoader=new i,this.threeDXLoader.setMode("concat"),this.threeDXLoader.globalOldFlipTexture=!0;var e=this;this.threeDXLoader.switchLODTextureCB=function(t){if(t.camera!==debugWebGLV6Viewer.currentViewpoint.camera)return this.lastUsedTexture;var i=e.urban.getPerformanceProfileManager().getValue("maxtextureLOD");if(debugWebGLV6Viewer.mobile){if(10===i)return-1;i=Math.min(i,2)}var s=t.matrix,n=t.bSphere,a=n.radius*s.getMaxScaleOnAxis(),o=new r.Vector3;n?o.copy(n.center):o.set(0,0,0),o.applyMatrix4(s);var l,h,d=t.camera.matrixWorldInverse.elements,u=Math.abs(d[2]*o.x+d[6]*o.y+d[10]*o.z+d[14])-a,c=r.glStates.currentHeight/Math.tan(.5*t.camera.fov*Math.PI/180)*a/Math.abs(u);if(c<Math.min(t.texture.image.width,t.texture.image.height))return-1;for(l=0;l<t.lods.length&&(h=t.lods[l],!(c<Math.min(h.imageData.width,h.imageData.height)));l++);var p=l===t.lods.length?l-1:l;return Math.min(p,i)}},load:function(e,t){this._parent(e,t),this.model.node.isCoreReady=!1,this._setArrayBufferSliceBehaviour();var i=this.model.url+(this.model.urlOptions?this.model.urlOptions:"");return a.download(i,{async:!0,cors:!0,withCredentials:!0,responseType:"arraybuffer"},void 0,this.processBin.bind(this)),this.model.node},_setArrayBufferSliceBehaviour:function(){ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=function(e,t){var i=new Uint8Array(this);void 0===t&&(t=i.length);for(var r=new ArrayBuffer(t-e),s=new Uint8Array(r),n=0;n<s.length;n++)s[n]=i[n+e];return r})},processBin:function(e,t){if(e){var i=this._parse(t);this._applyMatrix(i);var r=(4-i.jsonSize%4)%4,s=t.slice(i.jsonSize+r+4+4),n=this._generateObjectToLoad(s);this.threeDXLoader.modelsToLoad[0]=n,n.gasSharing=!1,this._resolveTexturePath(n),this.threeDXLoader.processJSON(n),this._bindPrimitives(i.json)}},_resolveTexturePath:function(e){for(var t=e.json.binaries,i=0,r=t.length;i<r;++i){var s=t[i];if(!1===s.concatenated){var n=s.uri.split("/"),a=n[n.length-1],o=this.model.url,l=o.lastIndexOf("/");l=-1==l?url.length:l+1,o=o.substring(0,l);var h=this.model.urlOptions?this.model.urlOptions:"";t[i].uri="../"+o+a+h}}},_applyMatrix:function(e){if(this.model.geolocalized){var t=e.json.model.matrix,i=new r.Matrix4;i.set(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]),i.transpose(),this.model.matrix=i,this._applyModelMatrixToModelNode()}},_parse:function(e){for(var t=new Uint8Array(e),i=new Uint32Array(e,0,1)[0],r=new Uint16Array(t.buffer,4,i/2),s=[],n=0;65535*n<r.length;n++)s.push(String.fromCharCode.apply(null,r.subarray(65535*n,65535*(n+1))));return{json:JSON.parse(s.join("")),dataAsByte:t,jsonSize:i}},_generateObjectToLoad:function(e){var t=this._parse(e);return{concat:!0,doneCallback:this._doneCallback.bind(this),nodeCallback:this._nodeCallback.bind(this),destinationNode:this.model.node,oldFlipTexture:!0,onTexturesLoadedCB:function(){this.model.node.setVisibility(!0),this.model.node.isCoreReady=!0}.bind(this),data:{nbImagesToLoad:0,chunks:[],header:{},nodes:[],buffers:[],geometries:[],images:[],textures:[],materials:[],reps:{},modelsToLoad:[]},json:t.json,concatBinaries:{data:t.dataAsByte,offset:t.dataAsByte.byteLength}}},_bindPrimitives:function(e){var t=this._extractJSONPrimitives(e),i=this;if(Array.isArray(t)){var r=[];this._extractMesh(this.model.node,r);var s=this._bindUidToPrim(t,r);this.model.uidToPrim=s,this.model.patch&&(Object.keys(this.model.uidToPrim).forEach(function(e){if(Utils.is(i.model.patch._uidListeners[e]))for(var t in i.model.uidToPrim[e])i.model.patch._uidListeners[e][t]=i.model.uidToPrim[e][t];else i.model.patch._uidListeners[e]=i.model.uidToPrim[e]}),this.model.patch.miDToTile!==this.model.patch._uidListeners&&(this.model.patch.miDToTile=this.model.patch._uidListeners))}},_extractJSONPrimitives:function(e){if(e&&e.model&&e.model.objects&&Array.isArray(e.model.objects)&&e.model.objects.length>0)return e.model.objects},_extractMesh:function(e,t){if(e.mesh3js)return t.push(e);e.children.forEach(function(e){this._extractMesh(e,t)}.bind(this))},_bindUidToPrim:function(e,t){var i={};return t.forEach(function(t){for(var r,s=t.getPrimitives(),n=0;n<s.length;n++)for(var a=0;a<e.length;a++)r=Utils.is(s[n].sgNode.cgmIdOld)&&"number"!=typeof s[n].sgNode.getCgmId()?s[n].sgNode.cgmIdOld:s[n].sgNode.getCgmId(),e[a].tags.indexOf(r)>-1&&(s[n].sgNode._setCgmId(e[a].uid),i[e[a].uid]||(i[e[a].uid]={geom:[],strid:e[a].uid,userData:{}}),i[e[a].uid].geom.push({mesh:t,subElement:s[n].sgNode}))}),i},_doneCallback:function(){this.model.node&&(this._isTextured()?this.model.node.setVisibility(!1):this.model.node.isCoreReady=!0,this.model.callback&&this.model.callback(this.model.node,!0,this.model.name))},_nodeCallback:function(e,t,i){i.setColor=function(e,t){var i,r,s,n;for(n=0;n<t.length;n++)i=(s=0===(s=this._getMaterials([t[n]])).length?t[n].group.material||t[n].group.gas:s[0]).color.clone(),(r=s.clone()).textureBlending=s.textureBlending,r.color.copy(e),r.ambient&&r.ambient.copy(e),this.setMaterial([t[n]],r);return i},i.setOpacity=function(e,t){var i,r,s,n;for(n=0;n<t.length;n++)i=(s=0===(s=this._getMaterials([t[n]])).length?t[n].group.material||t[n].group.gas:s[0]).opacity,(r=s.clone()).textureBlending=s.textureBlending,r.opacity=e,this.setMaterial([t[n]],r);return i}}});return n.formatLoaders.cty=o,n.formatLoaders.city=o,o}),define("DS/XCityWorkers/WorkerPool",["UWA/Class","DS/XCityTools/Debug"],function(e,t){"use strict";return UWA.Class.extend({init:function(e,i,r,s){this.urban=e,this.nbMaxWorkers=r,t.log("Workers enabled."),this._workers=[],this._assignTaskToWorker=0;for(var n=0;n<r;n++)this._workers.push(new Worker(i)),this._workers[n].usage=0,this._workers[n].session=[],void 0!==s&&this._workers[n].postMessage(s)},postMessage:function(e){var t=null;return(t=this._workers[this._assignTaskToWorker]).usage++,t.postMessage(e),this._assignTaskToWorker=(this._assignTaskToWorker+1)%this.nbMaxWorkers,t},available:function(e){e.usage--},terminate:function(){for(var e=0;e<nbMaxWorkers;e++)this._workers[e].terminate()}})}),define("DS/XCityLayer/VectorLoaderGML",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityLayer/Vector","DS/XCityTools/Debug"],function(e,t,i,r){"use strict";return UWA.Class.extend({init:function(){this.charset="utf-8",this.gmlNamespaceURI="gml",this.featureNamespaceURI="ms",this.featureTagName="featureMember",this.geometryTagName="msGeometry"},requestData:function(e,t){var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="text",r.log("requestData:");i.onload=function(e){var s=this.getXmlDocument(i.response),n=s.lookupNamespaceURI(this.gmlNamespaceURI),a=s.getElementsByTagNameNS(n,this.featureTagName);r.log(a);var o={list:a,namespace:n,index:0,count:a.length,getNextFeature:this.getNextFeature.bind(this)};o.getNextFeature=this.getNextFeature.bind(this,o),t(o,i.status)}.bind(this),i.send()},loadDataSource:function(e){var t=this.getXmlDocument(e),i=t.lookupNamespaceURI(this.gmlNamespaceURI),r=t.getElementsByTagNameNS(i,this.featureTagName),s={list:r,namespace:i,index:0,count:r.length};return s.getNextFeature=this.getNextFeature.bind(this,s),s},getNextFeature:function(e,t){if(e.index<e.count){var i=this.parseFeature(e.list[e.index],e.namespace,t);return e.index++,i}return null},parseFeature:function(e,t,r){var s=e.lookupNamespaceURI(this.featureNamespaceURI),n=this.parseGeometry(e,t,s);void 0===r?r=new i.Feature:r.clear(),r.setGeometry(n);for(var a=e.getElementsByTagNameNS(s,"*"),o=0,l=a.length;o<l;o++){var h=a[o],d=h.childNodes;if(1===h.nodeType&&1===d.length){var u=d[0],c=u.nodeType;3!==c&&4!==c||r.setAttribute(h.localName,u.textContent)}}return r},parsePointText:function(e){var t,r=e.split(","),s=parseFloat(r[0]),n=parseFloat(r[1]);return r.length>2&&(t=parseFloat(r[2])),new i.Point3D(s,n,t)},parsePoint:function(e,t,i){var r=e.getElementsByTagNameNS(t,"coordinates")[0].textContent;return this.parsePointText(r)},parsePolygon:function(e,r,s){for(var n=new i.Polygon,a=e.getElementsByTagNameNS(r,"coordinates"),o=new t.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),l=new t.Vector2(Number.MIN_VALUE,Number.MIN_VALUE),h=0,d=a.length;h<d;h++){for(var u=new i.LineString,c=a[h].textContent.replace(/^\s+|\s+$/g,"").split(" "),p=0,f=c.length;p<f;p++){var m=c[p].split(","),g=parseFloat(m[0]),v=parseFloat(m[1]);o.set(o.x>g?g:o.x,o.y>v?v:o.y),l.set(l.x<g?g:l.x,l.y<v?v:l.y);var _=0;m.length>2&&(_=parseFloat(m[2])),u.addVertex(new i.Point3D(g,v,_))}n.addGeometry(u)}return n.setAABBox(o,l),n},parseGeometry:function(e,t,i){var r=e.getElementsByTagNameNS(i,this.geometryTagName);if(r.length>0)for(var s=r[0],n=["Polygon","LineString","Point"],a=0;a<n.length;a++){var o=n[a];if(s.getElementsByTagNameNS(t,o).length>0){if("Polygon"===o)return this.parsePolygon(s,t,i);if("Point"===o)return this.parsePoint(s,t,i)}}return null},getXmlDocument:function(e){if(window.DOMParser)return(new DOMParser).parseFromString(e,"text/xml");var t=new ActiveXObject("Microsoft.XMLDOM");return t.async=!1,t.loadXML(e),t}})}),define("DS/XCityEnvironment/LensFlare",["DS/WebappsUtils/WebappsUtils","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/LensFlareNode3D","DS/xCityBasicUtils/Utils","DS/XCityTools/Downloader"],function(e,t,i,r,s,n,a){"use strict";return t.extend({init:function(e){this.urban=e},initLensFlare:function(){var e="XCityEnvironment/assets/textures/lensFlare/",t=[],n=0;this.node1s=new r("lensFlare");var o=function(e){if(t.push(e),!(++n<16)){for(var r=new i.Color(16777215),a=[0,.2,.3,.37,.47,.6,.7,.77,.97,1.17,1.27,1.35,1.5,1.75,1.82,2.2],o=[0,.035,.04,.05,.07,.05,.08,.06,.095,.08,.11,.07,.08,.06,.08,.55],l=[.55,.1,.13,.11,.17,.15,.11,.19,.15,.15,.15,.16,.14,.09,.13,.15],h=new i.LensFlare(t[0],180,0,i.AdditiveBlending,r,1),d=1;d<16;d++)r.setHSL(.5,.01,2*l[d]),h.add(t[d],1080*o[d],.45*a[d],i.AdditiveBlending,r,.65);this.lensFlare=new s(h,"SunFlare"),this.node1s.add(this.lensFlare)}},l=function(e,t,i,r){a.download(i,{image:!0},void 0!==r?r:1,function(e,t,i,r){r(t,e,i)},void 0,t)};l(this.urban,o.bind(this),e+"LensFlare_01.png"),l(this.urban,o.bind(this),e+"LensFlare_02.png"),l(this.urban,o.bind(this),e+"LensFlare_03.png"),l(this.urban,o.bind(this),e+"LensFlare_04.png"),l(this.urban,o.bind(this),e+"LensFlare_05.png"),l(this.urban,o.bind(this),e+"LensFlare_06.png"),l(this.urban,o.bind(this),e+"LensFlare_02.png"),l(this.urban,o.bind(this),e+"LensFlare_03.png"),l(this.urban,o.bind(this),e+"LensFlare_09.png"),l(this.urban,o.bind(this),e+"LensFlare_03.png"),l(this.urban,o.bind(this),e+"LensFlare_09.png"),l(this.urban,o.bind(this),e+"LensFlare_03.png"),l(this.urban,o.bind(this),e+"LensFlare_09.png"),l(this.urban,o.bind(this),e+"LensFlare_14.png"),l(this.urban,o.bind(this),e+"LensFlare_03.png"),l(this.urban,o.bind(this),e+"LensFlare_16.png"),this.urban.USR._root.add(this.node1s)},lensFlareUpdateCallback:function(e){var t,i,r=e.lensFlares.length,s=2*-e.positionScreen.x,n=2*-e.positionScreen.y;for(t=0;t<r;t++)(i=e.lensFlares[t]).x=e.positionScreen.x+s*i.distance,i.y=e.positionScreen.y+n*i.distance,i.rotation=0}})}),define("DS/XCityCore/PlanarQuadtree",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher"],function(e,t,i,r){"use strict";var s=function(e,t,i){this.urban=e,this.levelMin=t,this.leafOnly=i,this.nbQuads=0,this._quadsArea2test=2,this.needRebuild=!0,this.cameraMovedToken=r.subscribeTo(r.eventsList.pointOfView,function(){this.needRebuild=!0}.bind(this)),this._quads=[],this.sizeQuadPool=600,this._quads.length=this.sizeQuadPool;for(var s=0;s<this.sizeQuadPool;++s)this._quads[s]={LOD:0,I:0,J:0,dist:0,leaf:!0,key:void 0,timestamp:0}};return s.prototype={dispose:function(){r.unsubscribe(this.cameraMovedToken),this.cameraMovedToken=void 0,this._quads=void 0},build:function(e,t,i){this.timestamp=Date.now(),this.nbQuads=0,this.maxLevel=e;for(var r,s,n,a,o,l,h,d,u,c=e,p=1,f=-1,m=1,g=-1;c>=this.levelMin;){for(d=(1<<c)-1,a=(a=(n=this.getBaseIJ(c,t,i)).I-this._quadsArea2test)%2!=0?a-1:a,a=Math.max(a,0),o=(o=n.I+this._quadsArea2test)%2==0?o+1:o,o=Math.min(o,d),l=(l=n.J-this._quadsArea2test)%2!=0?l-1:l,l=Math.max(l,0),h=(h=n.J+this._quadsArea2test)%2==0?h+1:h,h=Math.min(h,d),r=a;r<=o;r++)for(s=l;s<=h;s++)r<0||s<0||r>d||s>d||this.leafOnly&&r>=m&&r<=g&&s>=p&&s<=f||(u=!(r>=m&&r<=g&&s>=p&&s<=f),this.addQuad(u,c,r,s,(e-c+1)*(Math.abs(r-n.I)+Math.abs(s-n.J))));1,2,c-=1,m=Math.floor(a/2),p=Math.floor(l/2),g=Math.floor(o/2),f=Math.floor(h/2)}return this.leafOnly&&0===this.nbQuads&&0===this.levelMin&&this.addQuad(!0,0,0,0,0),this.needRebuild=!1,!0},getBaseIJ:function(e,t,i){var r=1<<e;return{I:Math.floor(t*r),J:Math.floor(i*r)}},getXY:function(t,i,r){return new e.Vector2((i+.5)/t,(r+.5)/t)},getXYVector:function(e,t,i,r){r.set((t+.5)/e,(i+.5)/e)},getLength:function(){return this.nbQuads},getQuad:function(e){if(!(e<0||e>this.nbQuads))return t.cloneQuad(this._quads[e])},addQuad:function(e,r,s,n,a){if(this.nbQuads===this.sizeQuadPool){var o=[];o.length=50;for(var l=0;l<50;++l)o[l]={LOD:0,I:0,J:0,dist:0,leaf:e,key:void 0,timestamp:0};this._quads=this._quads.concat(o),this.sizeQuadPool+=50,i.warn("The entire quad pool of PlanarQuadTree is busy, 50 more quads have just been added."),i.warn("New pool size is "+this._quads.length+".")}var h=this.nbQuads;this._quads[h].LOD=r,this._quads[h].I=s,this._quads[h].J=n,this._quads[h].dist=a,this._quads[h].leaf=e,this._quads[h].key=t.getQuadKey(r,s,n),this._quads[h].timestamp=this.timestamp,this.nbQuads++},subdivide:function(){for(var e,i=this.nbQuads,r=0;r<i;++r)e=this._quads[r],this.addQuad(!0,e.LOD+1,2*e.I,2*e.J,e.dist),this.addQuad(!0,e.LOD+1,2*e.I+1,2*e.J,e.dist),this.addQuad(!0,e.LOD+1,2*e.I+1,2*e.J+1,e.dist),e.LOD++,e.I=2*e.I,e.J=2*e.J+1,e.key=t.getQuadKey(e.LOD,e.I,e.J)},_sortByDist:function(e,t){return void 0===e.key?999999:void 0===t.key?-999999:e.dist-t.dist},_sortByLOD:function(t,i,r){if(void 0===i.key||i.timestamp!==this.timestamp)return 1;if(void 0===r.key||r.timestamp!==this.timestamp)return-1;var s=new e.Vector3(this.urban.worldSize/(1<<i.LOD),this.urban.worldSize/(1<<i.LOD),1),n=Math.max(s.x,s.y,s.z)/2,a=new e.Vector3((i.I+.5)*s.x,(i.J+.5)*s.y,0),o=a;this.urban.USR.viewpoint._translateToRelativePosition(o,!0);for(var l=this.urban.USR.viewpoint.frustum.planes,h=!0,d=0;d<6;d++){l[d].distanceToPoint(o)<=-n&&(h=!1)}s=new e.Vector3(this.urban.worldSize/(1<<r.LOD),this.urban.worldSize/(1<<r.LOD),1),n=Math.max(s.x,s.y,s.z)/2,o=a=new e.Vector3((r.I+.5)*s.x,(r.J+.5)*s.y,0),this.urban.USR.viewpoint._translateToRelativePosition(o,!0);for(var u=!0,c=0;c<6;c++){l[c].distanceToPoint(o)<=-n&&(u=!1)}return!0===h&&!0===u?i.LOD>r.LOD?-1:i.LOD<r.LOD?1:i.dist<r.dist?-1:i.dist>r.dist?1:0:!0===h&&!1===u?-1:!1===h&&!0===u?1:i.LOD>r.LOD?-1:i.LOD<r.LOD?1:i.dist<r.dist?-1:i.dist>r.dist?1:0},sortTiles:function(e){this._quads.sort(this._sortByLOD.bind(this,e))},setNbQuadsPerLevelArea:function(e){this._quadsArea2test=e<6?2:Math.floor((e-1)/2)}},s}),define("DS/XCityCore/VisuQuadTree",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityCore/PlanarQuadtree","DS/XCityCore/Store","DS/XCityTools/EventDispatcher","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s,n,a,o){"use strict";var l=function(i,s,n){this._clock=new e.Clock,this._name="VisuQuadTree_"+s,this._urban=i,this._qt=new r(this._urban,0,!0),this._qt.name="IdealQuadTree_"+s,this._doQtUpdate=function(){return!0}.bind(this),this._node=new t,this._node.name=this._name,this._vqtKeys=[],this._holeKeys=[],this._target={level:-1,x:0,y:0,canUseParent:!1},this._currentMaxLevel=-1,this._availableVQT={},this._pendingVQT={},this._cropBox=void 0,this._cropIJBoxes={},this._holes={},this._dirty=!1,this._pixelCulling=!1,this._frameCounter=0,this.terrainInProcess=!1,void 0!==n&&this.setup(n)};return l.prototype={setup:function(e){void 0!==e&&(e.qtTest&&"function"==typeof e.qtTest&&(this._doQtUpdate=e.qtTest),e.cropBox!==this._cropBox&&(this._cropBox=e.cropBox,this._cropIJBoxes={},this._cropBox&&(this._cropIJBoxes[0]={},this._cropBox.getIJBox(0,this._cropIJBoxes[0]))))},reset:function(){this._currentMaxLevel=-1,this._target.level=-1,this._target.x=0,this._target.y=0,this._availableVQT={},this._pendingVQT={},this._cropBox=void 0,this._cropIJBoxes={},this._holes={},this._dirty=!1,this._pixelCulling=!1,this._vqtKeys=[],this._holeKeys=[];for(var e,t=this._node.getChildren(),i=t.length;i--;)e=t[i],s.unlock(e.storeId,e.storeKey),this._node.remove(e);s.cleanStore("terrain",!0)},dispose:function(){a.warn("VQT - dispose"),this.reset(),this._qt.dispose()},debug:function(){return"<br />Level loaded: "+this._currentMaxLevel+"<br />Patches loaded: "+this._node.getChildren().length},addHole:function(e,t,i){var r=o.getQuadKey(e,t,i);if(void 0===this._holes[r]){var s=this._urban.worldSize/(1<<e),n=t*s,a=(t+1)*s,l=i*s,h=(i+1)*s;this._holes[r]={LOD:e,I:t,J:i,key:r,minX:n,minY:l,maxX:a,maxY:h},this._dirty=!0}},removeHole:function(e,t,i){var r=o.getQuadKey(e,t,i);-1!==this._holes[r]&&(delete this._holes[r],this._dirty=!0)},_cullingTest:function(e){if(void 0!==this._cropBox){void 0===this._cropIJBoxes[e.LOD]&&(this._cropIJBoxes[e.LOD]={},this._cropBox.getIJBox(e.LOD,this._cropIJBoxes[e.LOD]));var t=this._cropIJBoxes[e.LOD];if(e.I<t.IMin||e.J<t.JMin||e.I>t.IMax||e.J>t.JMax)return!0;e.I!==t.IMin&&e.J!==t.JMin&&e.I!==t.IMax&&e.J!==t.JMax||(e.intersectCropBox=!0)}return!1},_lookForAvailableChildren:function(e,t,i,r,s){if(this._cullingTest({LOD:e,I:t,J:i}));else{var n=o.getQuadKey(e,t,i);-1!==this._vqtKeys.indexOf(n)?r[n]={LOD:e,I:t,J:i,key:n}:e<s&&(this._lookForAvailableChildren(e+1,t<<1,i<<1,r,s),this._lookForAvailableChildren(e+1,1+(t<<1),i<<1,r,s),this._lookForAvailableChildren(e+1,t<<1,1+(i<<1),r,s),this._lookForAvailableChildren(e+1,1+(t<<1),1+(i<<1),r,s))}},_AreChildrenAvailable:function(e,t,i,r){if(this._cullingTest({LOD:e,I:t,J:i}))return!0;var s=o.getQuadKey(e,t,i);return-1!==this._vqtKeys.indexOf(s)||e<r&&(!1!==this._AreChildrenAvailable(e+1,t<<1,i<<1,r)&&(!1!==this._AreChildrenAvailable(e+1,1+(t<<1),i<<1,r)&&(!1!==this._AreChildrenAvailable(e+1,t<<1,1+(i<<1),r)&&!1!==this._AreChildrenAvailable(e+1,1+(t<<1),1+(i<<1),r))))},_boxInFrustum:function(t){for(var i=this._urban.USR.viewpoint.frustum.planes,r=0;r<6;r++){var s=0;if(s+=i[r].distanceToPoint(new e.Vector3(t.mMinX,t.mMinY,t.mMinZ))<0?1:0,s+=i[r].distanceToPoint(new e.Vector3(t.mMaxX,t.mMinY,t.mMinZ))<0?1:0,s+=i[r].distanceToPoint(new e.Vector3(t.mMinX,t.mMaxY,t.mMinZ))<0?1:0,s+=i[r].distanceToPoint(new e.Vector3(t.mMaxX,t.mMaxY,t.mMinZ))<0?1:0,s+=i[r].distanceToPoint(new e.Vector3(t.mMinX,t.mMinY,t.mMaxZ))<0?1:0,s+=i[r].distanceToPoint(new e.Vector3(t.mMaxX,t.mMinY,t.mMaxZ))<0?1:0,s+=i[r].distanceToPoint(new e.Vector3(t.mMinX,t.mMaxY,t.mMaxZ))<0?1:0,8==(s+=i[r].distanceToPoint(new e.Vector3(t.mMaxX,t.mMaxY,t.mMaxZ))<0?1:0))return!1}return!0},update:function(t,i,r,n){this.terrainInProcess=!1,this._doQtUpdate&&!0===this._doQtUpdate()&&(n||this._qt.needRebuild)&&(this._target.level=t,this._target.x=i,this._target.y=r,this._qt.build(this._target.level,this._target.x,this._target.y),this._qt.sortTiles());var a,l,h,d,u,c,p,f=[];this._node.getChildren();this._availableVQT={},p=this._qt.getLength(),!1!==this._pixelCulling&&(this._urban.USR.viewpoint.camera.pixelCulling=this._pixelCulling,this._pixelCulling=!1);new e.Vector3(0,0,0);for(var m={mMinX:0,mMaxX:0,mMinY:0,mMaxY:0,mMinZ:0,mMaxZ:0},g=0;g<p;){if(R={tile:this._qt.getQuad(g)},0===g){var v={tile:{LOD:0,I:0,J:0,key:o.getQuadKey(0,0,0)},canUseParent:!1,isVisible:!0,priority:999};if(this._cullingTest(v.tile))continue;s.getOrDownloadData("terrain",v.tile.key,v);for(var _=R.tile.LOD-5,y=R.tile.I,b=R.tile.J;_>0;){for(var x=0;x<5;++x)y>>=1,b>>=1;v={tile:{LOD:_,I:y,J:b,key:o.getQuadKey(_,y,b)},canUseParent:!1,isVisible:!0,priority:999},this._cullingTest(v.tile)||(s.getOrDownloadData("terrain",v.tile.key,v),_-=5)}}if(g++,!this._cullingTest(R.tile)){var C=this._urban.worldSize/(1<<R.tile.LOD),S=this._urban.worldSize/(1<<R.tile.LOD),D=new e.Vector3(C,S,1),P=new e.Vector3((R.tile.I+.5)*D.x,(R.tile.J+.5)*D.y,0);if(m.mMinX=P.x-D.x/2-this._urban.USR.viewpoint._camShiftedTranslation.x,m.mMaxX=P.x+D.x/2-this._urban.USR.viewpoint._camShiftedTranslation.x,m.mMinY=P.y-D.y/2-this._urban.USR.viewpoint._camShiftedTranslation.y,m.mMaxY=P.y+D.y/2-this._urban.USR.viewpoint._camShiftedTranslation.y,m.mMinZ=P.z-0-this._urban.USR.viewpoint._camShiftedTranslation.z,m.mMaxZ=P.z+5e3-this._urban.USR.viewpoint._camShiftedTranslation.z,m.mMaxZ*=this._urban.USR.scale,R.isVisible=this._boxInFrustum(m),!0===R.isVisible){if(R.canUseParent=!0,h=R.tile.LOD,d=R.tile.I,u=R.tile.J,-1!==this._vqtKeys.indexOf(R.tile.key));else h++,d<<=1,u<<=1,!0===this._AreChildrenAvailable(h,d,u,this._currentMaxLevel)&&!0===this._AreChildrenAvailable(h,d,u+1,this._currentMaxLevel)&&!0===this._AreChildrenAvailable(h,d+1,u,this._currentMaxLevel)&&!0===this._AreChildrenAvailable(h,d+1,u+1,this._currentMaxLevel)&&(R.canUseParent=!1);if(R.priority=Math.max(0,R.tile.LOD),this._availableVQT[R.tile.key]={LOD:R.tile.LOD,I:R.tile.I,J:R.tile.J,key:R.tile.key},A=s.getOrDownloadData("terrain",R.tile.key,R),o.is(A)){if(A.useGeometricParent)f.push([R.tile.key,R.tile.LOD,R.tile.I,R.tile.J,A.useGeometricParent,A.tileParent,R]);else if(!0===A.tmp&&(A.temporary&&(this.terrainInProcess=!0),h=R.tile.LOD,d=R.tile.I,u=R.tile.J,-1,!1===R.canUseParent)){var w=Object.keys(this._availableVQT).length;h=R.tile.LOD,d=R.tile.I,u=R.tile.J,this._lookForAvailableChildren(h+1,d<<1,u<<1,this._availableVQT,this._currentMaxLevel),this._lookForAvailableChildren(h+1,1+(d<<1),u<<1,this._availableVQT,this._currentMaxLevel),this._lookForAvailableChildren(h+1,d<<1,1+(u<<1),this._availableVQT,this._currentMaxLevel),this._lookForAvailableChildren(h+1,1+(d<<1),1+(u<<1),this._availableVQT,this._currentMaxLevel),Object.keys(this._availableVQT).length>w&&(R.priority=99999,s.deprecate("terrain",R.tile.key),s.getOrDownloadData("terrain",R.tile.key,R),f.push([R.tile.key,R.tile.LOD,R.tile.I,R.tile.J]),!1!==this._urban.USR.viewpoint.camera.pixelCulling&&(this._pixelCulling=this._urban.USR.viewpoint.camera.pixelCulling,this._urban.USR.viewpoint.camera.pixelCulling=!1))}}else console.error("ERROR : NO TILE -> SHOULD NOT HAPPEN")}}}l=this._currentMaxLevel;for(var M=Object.keys(this._availableVQT),T=0,I=M.length;T<I;T++)l=Math.max(l,this._availableVQT[M[T]].LOD);for(a=f.length;a--;)if(c=f.shift(),this._availableVQT[c[0]]){if(c.length>4&&!0===c[4]){var R,A,F=c[5];if(F.key=o.getQuadKey(F.LOD,F.I,F.J),void 0===this._availableVQT[F.key])(R=c[6]).tile=F,(A=s.getOrDownloadData("terrain",R.tile.key,R)).useGeometricParent||(this._availableVQT[F.key]=F),A.temporary&&(this.terrainInProcess=!0)}delete this._availableVQT[c[0]]}else this._cullingTest({LOD:c[1],I:c[2],J:c[3]})||c[1]<l&&(h=c[1]+1,d=c[2]<<1,u=c[3]<<1,f.push([o.getQuadKey(h,d,u),h,d,u]),f.push([o.getQuadKey(h,d+1,u),h,d+1,u]),f.push([o.getQuadKey(h,d,u+1),h,d,u+1]),f.push([o.getQuadKey(h,d+1,u+1),h,d+1,u+1]),a+=4)},display:function(e){var t,i,r;this._currentMaxLevel=0;for(var n=(r=this._node.getChildren()).length;n--;)t=r[n],!this._dirty&&this._availableVQT[t.storeKey]||(this._node.remove(t),this._vqtKeys.splice(this._vqtKeys.indexOf(t.storeKey),1),s.unlock("terrain",t.storeKey));r=this._node.getChildren();var a=Object.keys(this._availableVQT),l=a.length;for(this._holeKeys.length=0;l--;){var h=Number(a[l]),d=this._availableVQT[h];if(this._currentMaxLevel=d.LOD>this._currentMaxLevel?d.LOD:this._currentMaxLevel,this._dirty||-1===this._vqtKeys.indexOf(h)){if(-1===this._holeKeys.indexOf(h)){var u=!1;if(Object.keys(this._holes).length>0){if(this._holes[h]){this._holeKeys.push(h);continue}var c,p=this._urban.worldSize/(1<<d.LOD),f=(d.I+.5)*p,m=(d.J+.5)*p;for(var g in this._holes)(c=this._holes[g]).LOD<d.LOD&&f>c.minX&&f<c.maxX&&m>c.minY&&m<c.maxY&&(u=!0,this._holeKeys.push(h))}u||(i=s.getData("terrain",h),o.is(i)&&!0!==i.useGeometricParent&&(this._node.add(i),this._vqtKeys.push(h),s.lock("terrain",h)))}}else;}for(var v=0;v<this._holeKeys.length;++v)s.getData("terrain",this._holeKeys[v]);this._dirty=!1},getLoadedQuadAt:function(e,t){var i,r,n;if((r=this._node.getChildren()).length>0){var a,l,h=this._currentMaxLevel;a=this._qt.getBaseIJ(this._currentMaxLevel,e,t);var d=function(e,t,a){if(!(e<0))if(l=o.getQuadKey(e,t,a),-1===this._holeKeys.indexOf(l)){if(-1===this._vqtKeys.indexOf(l))d(--e,t>>1,a>>1);else for(n=0;n<r.length;++n)if(r[n].storeKey===l){i=r[n];break}}else null===(i=s.getData("terrain",l))&&(i=void 0)}.bind(this);d(h,a.I,a.J)}return i}},l}),define("DS/XCityCore/VisuQuadTreeSirocco",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityCore/PlanarQuadtree","DS/XCityCore/Store","DS/XCityTools/EventDispatcher","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s,n,a,o){"use strict";var l=function(i,s,n){this._clock=new e.Clock,this._name="VisuQuadTreeSirocco_"+s,this._urban=i,this._lodbias=1,this._qt=new r(this._urban,0,!1),this._qt.name="IdealQuadTreeSirocco_"+s,this._doQtUpdate=function(){return!0}.bind(this),this._qtBias=new r(this._urban,0,!0),this._qtBias.name="IdealQuadTreeSirocco_"+s,this._doQtBiasUpdate=function(){return!0}.bind(this),this._node=new t,this._node.name=this._name,this._vqtKeys=[],this._holeKeys=[],this._target={level:-1,x:0,y:0,canUseParent:!1},this._currentMaxLevel=-1,this._availableVQT={},this._pendingVQT={},this._cropBox=void 0,this._cropIJBoxes={},this._holes={},this._dirty=!1,this._pixelCulling=!1,this.dataInProcess=!1,void 0!==n&&this.setup(n),this._dataSources={},this._activeDataSources={},this._nbActiveDataSources=0,this._activeDataSourcesInTile=[],this._nbActiveDataSourcesInTile=0,this._leavesDataSources={},this._tilePos=new e.Vector3(0,0,0),this._tileBox={mMinX:0,mMaxX:0,mMinY:0,mMaxY:0,mMinZ:0,mMaxZ:0},this._tileBoxXminYminZmin=new e.Vector3(0,0,0),this._tileBoxXmaxYminZmin=new e.Vector3(0,0,0),this._tileBoxXminYmaxZmin=new e.Vector3(0,0,0),this._tileBoxXmaxYmaxZmin=new e.Vector3(0,0,0),this._tileBoxXminYminZmax=new e.Vector3(0,0,0),this._tileBoxXmaxYminZmax=new e.Vector3(0,0,0),this._tileBoxXminYmaxZmax=new e.Vector3(0,0,0),this._tileBoxXmaxYmaxZmax=new e.Vector3(0,0,0)};return l.prototype={setup:function(e){void 0!==e&&(e.qtTest&&"function"==typeof e.qtTest&&(this._doQtUpdate=e.qtTest),e.cropBox!==this._cropBox&&(this._cropBox=e.cropBox,this._cropIJBoxes={},this._cropBox&&(this._cropIJBoxes[0]={},this._cropBox.getIJBox(0,this._cropIJBoxes[0]))))},reset:function(){for(var e in this._currentMaxLevel=-1,this._target.level=-1,this._target.x=0,this._target.y=0,this._availableVQT={},this._pendingVQT={},this._cropBox=void 0,this._cropIJBoxes={},this._holes={},this._dirty=!1,this._pixelCulling=!1,this._vqtKeys=[],this._holeKeys=[],this._dataSources)this.removeDataSource(e);this._activeDataSources={},this._nbActiveDataSources=0,this._dataSources={},this._activeDataSourcesInTile=[],this._nbActiveDataSourcesInTile=0,this._leavesDataSources={}},dispose:function(){a.warn("VQTSirocco - dispose"),this.reset(),this._qt.dispose(),this._qtBias.dispose()},debug:function(){return"<br />Level loaded: "+this._currentMaxLevel+"<br />Patches loaded: "+this._node.getChildren().length},_cullingTest:function(e){if(void 0!==this._cropBox){void 0===this._cropIJBoxes[e.LOD]&&(this._cropIJBoxes[e.LOD]={},this._cropBox.getIJBox(e.LOD,this._cropIJBoxes[e.LOD]));var t=this._cropIJBoxes[e.LOD];if(e.I<t.IMin||e.J<t.JMin||e.I>t.IMax||e.J>t.JMax)return!0;e.I!==t.IMin&&e.J!==t.JMin&&e.I!==t.IMax&&e.J!==t.JMax||(e.intersectCropBox=!0)}return!1},_isTileVisible:function(){for(var e=this._urban.USR.viewpoint.frustum.planes,t=0;t<6;t++){var i=0;if(i+=e[t].distanceToPoint(this._tileBoxXminYminZmin)<0?1:0,i+=e[t].distanceToPoint(this._tileBoxXmaxYminZmin)<0?1:0,i+=e[t].distanceToPoint(this._tileBoxXminYmaxZmin)<0?1:0,i+=e[t].distanceToPoint(this._tileBoxXmaxYmaxZmin)<0?1:0,i+=e[t].distanceToPoint(this._tileBoxXminYminZmax)<0?1:0,i+=e[t].distanceToPoint(this._tileBoxXmaxYminZmax)<0?1:0,i+=e[t].distanceToPoint(this._tileBoxXminYmaxZmax)<0?1:0,8==(i+=e[t].distanceToPoint(this._tileBoxXmaxYmaxZmax)<0?1:0))return!1}return!0},addDataSource:function(e,i){if(void 0===i&&(i=new t),this._dataSources[e.id]=e,e.node=i,e.lodBiasVisu=e.lodBias,i.url=e.url,i.idDataSource=e.id,i.objectId=e.objectId,e.AABBox){for(var r=[],s=this._dataSources[e.id],n=s.levelMin;n<=Math.min(42,Math.max(25,s.levelMax));n++){r.push(e.AABBox.getIJBox(n,{}))}s.filter=r}this._node.addChild(i),this._vqtKeys[e.id]=[],e.visible&&(this._activeDataSources[e.id]=e,this._nbActiveDataSources++,this._activeDataSourcesInTile.length=this._nbActiveDataSources,this._leavesDataSources[e.id]=[])},removeDataSource:function(e){if(void 0!==this._dataSources[e]){for(var t=this._dataSources[e].node,i=t.children.length;i--;){var r=t.children[i];void 0!==r.storeKey&&(t.remove(r),s.unlock(e,r.storeKey))}s.cleanStore(e,!0),this._node.removeChild(t),delete this._dataSources[e],void 0!==this._activeDataSources[e]&&(delete this._activeDataSources[e],delete this._leavesDataSources[e],this._nbActiveDataSources--,this._activeDataSourcesInTile.length=this._nbActiveDataSources)}},setDataSourceAttribute:function(e,t,i){if(this._dataSources[e][t]=i,"visible"===t)i?(this._activeDataSources[this._dataSources[e].id]=this._dataSources[e],this._leavesDataSources[this._dataSources[e].id]=[],this._nbActiveDataSources++):(delete this._activeDataSources[this._dataSources[e].id],delete this._leavesDataSources[this._dataSources[e].id],this._nbActiveDataSources--),this._activeDataSourcesInTile.length=this._nbActiveDataSources;else if(("levelMin"===t||"levelMax"===t)&&this._dataSources[e].AABBox){for(var r=[],s=this._dataSources[e],n=s.levelMin;n<=Math.min(42,Math.max(25,s.levelMax));n++){r.push(this._dataSources[e].AABBox.getIJBox(n,{}))}s.filter=r}},getDataSources:function(e,t){this._nbActiveDataSourcesInTile=0;for(var i=Object.keys(this._activeDataSources),r=0,s=i.length;r<s;r++){var n=this._activeDataSources[i[r]];if(!0!==n.clusteringMode)if(n.previewMode||!0===n.clusteringMode){if(n.visible&&e.leaf&&e.LOD>=n.levelMin&&(!n.filter||e.I>=n.filter[e.LOD-n.levelMin].IMin&&e.I<=n.filter[e.LOD-n.levelMin].IMax&&e.J>=n.filter[e.LOD-n.levelMin].JMin&&e.J<=n.filter[e.LOD-n.levelMin].JMax)){for(var a=Math.floor(e.I/2),l=Math.floor(e.J/2),h=!1,d=e.LOD-1;d>=n.levelMin;--d){var u=o.getQuadKey(d,a,l);-1!==this._leavesDataSources[n.id].indexOf(u)?(h=!0,d=-1):(a=Math.floor(a/2),l=Math.floor(l/2))}h||(this._activeDataSourcesInTile[this._nbActiveDataSourcesInTile]=n,this._nbActiveDataSourcesInTile++)}}else if(n.visible&&e.LOD>=n.levelMin&&(!n.filterLevelMax||e.LOD<=n.levelMax+n.lodBiasVisu)&&(!n.filter||e.I>=n.filter[e.LOD-n.levelMin].IMin&&e.I<=n.filter[e.LOD-n.levelMin].IMax&&e.J>=n.filter[e.LOD-n.levelMin].JMin&&e.J<=n.filter[e.LOD-n.levelMin].JMax)){for(a=Math.floor(e.I/2),l=Math.floor(e.J/2),h=!1,d=e.LOD-1;d>=n.levelMin;--d){u=o.getQuadKey(d,a,l);-1!==this._leavesDataSources[n.id].indexOf(u)?(h=!0,d=-1):(a=Math.floor(a/2),l=Math.floor(l/2))}h||(this._activeDataSourcesInTile[this._nbActiveDataSourcesInTile]=n,this._nbActiveDataSourcesInTile++)}}},getDataSourcesClustered:function(e,t){this._nbActiveDataSourcesInTile=0;for(var i=Object.keys(this._activeDataSources),r=0,s=i.length;r<s;r++){var n=this._activeDataSources[i[r]];if(!0===n.clusteringMode&&(n.visible&&e.leaf&&e.LOD>=n.levelMin&&(!n.filter||e.I>=n.filter[e.LOD-n.levelMin].IMin&&e.I<=n.filter[e.LOD-n.levelMin].IMax&&e.J>=n.filter[e.LOD-n.levelMin].JMin&&e.J<=n.filter[e.LOD-n.levelMin].JMax))){for(var a=Math.floor(e.I/2),l=Math.floor(e.J/2),h=!1,d=e.LOD-1;d>=n.levelMin;--d){var u=o.getQuadKey(d,a,l);-1!==this._leavesDataSources[n.id].indexOf(u)?(h=!0,d=-1):(a=Math.floor(a/2),l=Math.floor(l/2))}h||(this._activeDataSourcesInTile[this._nbActiveDataSourcesInTile]=n,this._nbActiveDataSourcesInTile++)}}},_lookForAvailableParent:function(e,t,i,r,s,n){var a=o.getQuadKey(e,t,i);-1!==this._vqtKeys[n].indexOf(a)?r[n][a]={LOD:e,I:t,J:i,key:a}:e>s&&this._lookForAvailableParent(e-1,t>>1,i>>1,r,s,n)},_lookForAvailableChildren:function(e,t,i,r,s,n){var a=o.getQuadKey(e,t,i);-1!==this._vqtKeys[n].indexOf(a)&&(r[n][a]={LOD:e,I:t,J:i,key:a}),e<s&&(this._lookForAvailableChildren(e+1,t<<1,i<<1,r,s,n),this._lookForAvailableChildren(e+1,t<<1,1+(i<<1),r,s,n),this._lookForAvailableChildren(e+1,1+(t<<1),1+(i<<1),r,s,n),this._lookForAvailableChildren(e+1,1+(t<<1),i<<1,r,s,n))},_shouldBeWaiting:function(e,t,i,r,s){var n=o.getQuadKey(e,t,i);return void 0!==this._temporaryClusterParent[s][n]||e>r&&this._shouldBeWaiting(e-1,t>>1,i>>1,r,s)},_hasAFinalParentNode:function(e,t,i,r,n,a){var l=o.getQuadKey(e,t,i);if(-1!==this._vqtKeys[a].indexOf(l)){var h=s.getData([a],l);return o.is(h)&&o.is(h.node)&&h.nbFeatures<100?{LOD:e,I:t,J:i,key:l}:void 0}return e>n?this._hasAFinalParentNode(e-1,t>>1,i>>1,r,n,a):void 0},_hasAFinalParentNode2:function(e,t,i,r,n,a){var l=o.getQuadKey(e,t,i);if(-1!==this._vqtKeys[a].indexOf(l)){var h=s.getData([a],l);return o.is(h)&&o.is(h.node)&&(0===h.node.clusterType||2===h.node.clusterType||e===this._activeDataSources[a].levelMax)?{LOD:e,I:t,J:i,key:l}:void 0}return e>n?this._hasAFinalParentNode2(e-1,t>>1,i>>1,r,n,a):void 0},update:function(e,t,i,r){var n,a,l,h,d;this.dataInProcess=!1,this._doQtUpdate&&!0===this._doQtUpdate()&&(r||this._qt.needRebuild)&&(this._target.level=e,this._target.x=t,this._target.y=i,this._qt.build(this._target.level,this._target.x,this._target.y));this._availableVQT={},this._temporaryClusterParent={},this._temporaryChildren={};for(var u=Object.keys(this._activeDataSources),c=0,p=u.length;c<p;c++)this._availableVQT[u[c]]={},this._temporaryClusterParent[u[c]]={},this._temporaryChildren[u[c]]={};d=this._qt.nbQuads;for(var f=0;f<d;)if(n={tile:this._qt.getQuad(f)},f++,!this._cullingTest(n.tile)){var m=this._urban.worldSize/(1<<n.tile.LOD);if(this._tilePos.set((n.tile.I+.5)*m,(n.tile.J+.5)*m,0),this._tileBox.mMinX=this._tilePos.x-m/2-this._urban.USR.viewpoint._camShiftedTranslation.x,this._tileBox.mMaxX=this._tilePos.x+m/2-this._urban.USR.viewpoint._camShiftedTranslation.x,this._tileBox.mMinY=this._tilePos.y-m/2-this._urban.USR.viewpoint._camShiftedTranslation.y,this._tileBox.mMaxY=this._tilePos.y+m/2-this._urban.USR.viewpoint._camShiftedTranslation.y,this._tileBox.mMinZ=0,this._tileBox.mMaxZ=4500,this._tileBoxXminYminZmin.set(this._tileBox.mMinX,this._tileBox.mMinY,this._tileBox.mMinZ),this._tileBoxXmaxYminZmin.set(this._tileBox.mMaxX,this._tileBox.mMinY,this._tileBox.mMinZ),this._tileBoxXminYmaxZmin.set(this._tileBox.mMinX,this._tileBox.mMaxY,this._tileBox.mMinZ),this._tileBoxXmaxYmaxZmin.set(this._tileBox.mMaxX,this._tileBox.mMaxY,this._tileBox.mMinZ),this._tileBoxXminYminZmax.set(this._tileBox.mMinX,this._tileBox.mMinY,this._tileBox.mMaxZ),this._tileBoxXmaxYminZmax.set(this._tileBox.mMaxX,this._tileBox.mMinY,this._tileBox.mMaxZ),this._tileBoxXminYmaxZmax.set(this._tileBox.mMinX,this._tileBox.mMaxY,this._tileBox.mMaxZ),this._tileBoxXmaxYmaxZmax.set(this._tileBox.mMaxX,this._tileBox.mMaxY,this._tileBox.mMaxZ),n.isVisible=this._isTileVisible(),!0===n.isVisible){a=n.tile.LOD,l=n.tile.I,h=n.tile.J,n.priority=Math.max(0,n.tile.LOD),this.getDataSources(n.tile);for(c=0;c<this._nbActiveDataSourcesInTile;c++){var g=this._activeDataSourcesInTile[c],v=!1;if(!0===g.clusteringMode){if(!(v=this._hasAFinalParentNode2(a-1,l>>1,h>>1,this._previewNodes,0,g.id))&&a>g.levelMax)continue}else g.previewMode&&(v=this._hasAFinalParentNode(a-1,l>>1,h>>1,this._previewNodes,0,g.id));if(v)this._availableVQT[g.id][v.key]={LOD:v.LOD,I:v.I,J:v.J,key:v.key};else{n.tile.T=encodeURIComponent(this._urban.date._date.getUTCFullYear()+"/"+(this._urban.date._date.getMonth()+1)+"/"+this._urban.date._date.getDate());var _=s.getOrDownloadData(g.id,n.tile.key,n);o.is(_)?(o.is(_.node)?(this._availableVQT[g.id][n.tile.key]={LOD:n.tile.LOD,I:n.tile.I,J:n.tile.J,key:n.tile.key},void 0!==_.node.isCoreReady&&(("function"!=typeof _.node.isCoreReady||_.node.isCoreReady())&&_.node.isCoreReady||(this.dataInProcess=!0))):_.nbFeatures>0&&(this.dataInProcess=!0,(g.previewMode||!0===g.clusteringMode)&&(this._lookForAvailableParent(a-1,l>>1,h>>1,this._temporaryClusterParent,0,g.id),this._lookForAvailableChildren(a+1,l<<1,h<<1,this._temporaryChildren,this._currentMaxLevel,g.id),this._lookForAvailableChildren(a+1,l<<1,1+(h<<1),this._temporaryChildren,this._currentMaxLevel,g.id),this._lookForAvailableChildren(a+1,1+(l<<1),1+(h<<1),this._temporaryChildren,this._currentMaxLevel,g.id),this._lookForAvailableChildren(a+1,1+(l<<1),h<<1,this._temporaryChildren,this._currentMaxLevel,g.id))),0===_.nbFeatures&&n.tile.LOD<g.levelMax&&-1===this._leavesDataSources[g.id].indexOf(n.tile.key)&&this._leavesDataSources[g.id].push(n.tile.key)):(this.dataInProcess=!0,(g.previewMode||!0===g.clusteringMode)&&(this._lookForAvailableParent(a-1,l>>1,h>>1,this._temporaryClusterParent,0,g.id),this._lookForAvailableChildren(a+1,l<<1,h<<1,this._temporaryChildren,this._currentMaxLevel,g.id),this._lookForAvailableChildren(a+1,l<<1,1+(h<<1),this._temporaryChildren,this._currentMaxLevel,g.id),this._lookForAvailableChildren(a+1,1+(l<<1),1+(h<<1),this._temporaryChildren,this._currentMaxLevel,g.id),this._lookForAvailableChildren(a+1,1+(l<<1),h<<1,this._temporaryChildren,this._currentMaxLevel,g.id)))}}0}}this.updateLodBias(e,t,i,r)},updateLodBias:function(e,t,i,r){var n,a,l,h,d;this._doQtBiasUpdate&&!0===this._doQtBiasUpdate()&&(r||this._qtBias.needRebuild)&&(this._target.level=e,this._target.x=t,this._target.y=i,this._qtBias.build(this._target.level+this._lodbias,this._target.x,this._target.y),this._qtBias.subdivide());d=this._qtBias.nbQuads;for(var u=0;u<d;)if(n={tile:this._qtBias.getQuad(u)},u++,!this._cullingTest(n.tile)){var c=this._urban.worldSize/(1<<n.tile.LOD);if(this._tilePos.set((n.tile.I+.5)*c,(n.tile.J+.5)*c,0),this._tileBox.mMinX=this._tilePos.x-c/2-this._urban.USR.viewpoint._camShiftedTranslation.x,this._tileBox.mMaxX=this._tilePos.x+c/2-this._urban.USR.viewpoint._camShiftedTranslation.x,this._tileBox.mMinY=this._tilePos.y-c/2-this._urban.USR.viewpoint._camShiftedTranslation.y,this._tileBox.mMaxY=this._tilePos.y+c/2-this._urban.USR.viewpoint._camShiftedTranslation.y,this._tileBox.mMinZ=0,this._tileBox.mMaxZ=4500,this._tileBoxXminYminZmin.set(this._tileBox.mMinX,this._tileBox.mMinY,this._tileBox.mMinZ),this._tileBoxXmaxYminZmin.set(this._tileBox.mMaxX,this._tileBox.mMinY,this._tileBox.mMinZ),this._tileBoxXminYmaxZmin.set(this._tileBox.mMinX,this._tileBox.mMaxY,this._tileBox.mMinZ),this._tileBoxXmaxYmaxZmin.set(this._tileBox.mMaxX,this._tileBox.mMaxY,this._tileBox.mMinZ),this._tileBoxXminYminZmax.set(this._tileBox.mMinX,this._tileBox.mMinY,this._tileBox.mMaxZ),this._tileBoxXmaxYminZmax.set(this._tileBox.mMaxX,this._tileBox.mMinY,this._tileBox.mMaxZ),this._tileBoxXminYmaxZmax.set(this._tileBox.mMinX,this._tileBox.mMaxY,this._tileBox.mMaxZ),this._tileBoxXmaxYmaxZmax.set(this._tileBox.mMaxX,this._tileBox.mMaxY,this._tileBox.mMaxZ),n.isVisible=this._isTileVisible(),!0===n.isVisible){a=n.tile.LOD,l=n.tile.I,h=n.tile.J,n.priority=Math.max(0,n.tile.LOD),this.getDataSourcesClustered(n.tile);for(var p=0;p<this._nbActiveDataSourcesInTile;p++){var f=this._activeDataSourcesInTile[p],m=!1;if(!0===f.clusteringMode){if(!(m=this._hasAFinalParentNode2(a-1,l>>1,h>>1,this._previewNodes,0,f.id))&&a>f.levelMax)continue}else f.previewMode&&(m=this._hasAFinalParentNode(a-1,l>>1,h>>1,this._previewNodes,0,f.id));if(m)this._availableVQT[f.id][m.key]={LOD:m.LOD,I:m.I,J:m.J,key:m.key};else{var g=s.getOrDownloadData(f.id,n.tile.key,n);o.is(g)?(o.is(g.node)?(this._availableVQT[f.id][n.tile.key]={LOD:n.tile.LOD,I:n.tile.I,J:n.tile.J,key:n.tile.key},void 0!==g.node.isCoreReady&&(("function"!=typeof g.node.isCoreReady||g.node.isCoreReady())&&g.node.isCoreReady||(this.dataInProcess=!0))):g.nbFeatures>0&&(this.dataInProcess=!0,(f.previewMode||!0===f.clusteringMode)&&(this._lookForAvailableParent(a-1,l>>1,h>>1,this._temporaryClusterParent,0,f.id),this._lookForAvailableChildren(a+1,l<<1,h<<1,this._temporaryChildren,this._currentMaxLevel,f.id),this._lookForAvailableChildren(a+1,l<<1,1+(h<<1),this._temporaryChildren,this._currentMaxLevel,f.id),this._lookForAvailableChildren(a+1,1+(l<<1),1+(h<<1),this._temporaryChildren,this._currentMaxLevel,f.id),this._lookForAvailableChildren(a+1,1+(l<<1),h<<1,this._temporaryChildren,this._currentMaxLevel,f.id))),0===g.nbFeatures&&n.tile.LOD<f.levelMax&&-1===this._leavesDataSources[f.id].indexOf(n.tile.key)&&this._leavesDataSources[f.id].push(n.tile.key)):(this.dataInProcess=!0,(f.previewMode||!0===f.clusteringMode)&&(this._lookForAvailableParent(a-1,l>>1,h>>1,this._temporaryClusterParent,0,f.id),this._lookForAvailableChildren(a+1,l<<1,h<<1,this._temporaryChildren,this._currentMaxLevel,f.id),this._lookForAvailableChildren(a+1,l<<1,1+(h<<1),this._temporaryChildren,this._currentMaxLevel,f.id),this._lookForAvailableChildren(a+1,1+(l<<1),1+(h<<1),this._temporaryChildren,this._currentMaxLevel,f.id),this._lookForAvailableChildren(a+1,1+(l<<1),h<<1,this._temporaryChildren,this._currentMaxLevel,f.id)))}}0}}},display:function(e){var t;this._currentMaxLevel=0;for(var i=0;i<this._node.children.length;++i){for(var r=this._node.children[i],n=r.children.length,a=void 0!==this._activeDataSources[r.idDataSource];n--;)void 0!==(t=r.children[n]).storeKey&&"searchRequest"!==t.storeKey&&"cache"!==t.storeKey&&(!this._dirty&&a?this._availableVQT[r.idDataSource][t.storeKey]?this._currentMaxLevel=this._availableVQT[r.idDataSource][t.storeKey].LOD>this._currentMaxLevel?this._availableVQT[r.idDataSource][t.storeKey].LOD:this._currentMaxLevel:this._temporaryClusterParent[r.idDataSource][t.storeKey]?this._currentMaxLevel=this._temporaryClusterParent[r.idDataSource][t.storeKey].LOD>this._currentMaxLevel?this._temporaryClusterParent[r.idDataSource][t.storeKey].LOD:this._currentMaxLevel:this._temporaryChildren[r.idDataSource][t.storeKey]?this._currentMaxLevel=this._temporaryChildren[r.idDataSource][t.storeKey].LOD>this._currentMaxLevel?this._temporaryChildren[r.idDataSource][t.storeKey].LOD:this._currentMaxLevel:(r.remove(t),o.resetLODs(t),o.is(this._vqtKeys[r.idDataSource])&&this._vqtKeys[r.idDataSource].splice(this._vqtKeys[r.idDataSource].indexOf(t.storeKey),1),s.unlock(r.idDataSource,t.storeKey)):(r.remove(t),o.resetLODs(t),o.is(this._vqtKeys[r.idDataSource])&&this._vqtKeys[r.idDataSource].splice(this._vqtKeys[r.idDataSource].indexOf(t.storeKey),1),s.unlock(r.idDataSource,t.storeKey)));var l=this._availableVQT[r.idDataSource];if(void 0!==l)for(var h=Object.keys(l),d=h.length;d--;){var u=Number(h[d]);if(this._dirty||-1===this._vqtKeys[r.idDataSource].indexOf(u)){var c=s.getData([r.idDataSource],u);o.is(c)&&o.is(c.node)&&(r.add(c.node),this._vqtKeys[r.idDataSource].push(u),s.lock([r.idDataSource],u))}else;}}this._dirty=!1}},l}),define("DS/XCityRendering/BuildingTdbAtlas",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityTools/ShaderTools","DS/XCityTools/Disposer","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/XCityTools/Downloader"],function(e,t,i,r,s,n,a){"use strict";var o=e.extend({init:function(e,t,i){this.urban=e,this.name=t,this.loaded=!1,this.onload=[],this.atlasTexture=void 0,this.atlasInfoTexture=void 0,this.atlasNormalTexture=void 0,this.atlasSpecularTexture=void 0,i?(this.useNormalMap=i.useNormalMap,this.useSpecularMap=i.useSpecularMap):(this.useNormalMap=this.urban.useNormalMap,this.useSpecularMap=this.urban.useSpecularMap),this.nbClone=0},updateMaterial:function(e){s.is(e)&&s.is(e.uniforms)&&(void 0!==this.atlasNormalTexture?(e.normalMap!==this.atlasNormalTexture&&(e.normalMap=this.atlasNormalTexture),this.urban.useNormalMap?e.uniforms.use_normalMap.value=1:e.uniforms.use_normalMap.value=0):e.uniforms.use_normalMap.value=0,void 0!==this.atlasSpecularTexture?(e.specularMap!==this.atlasSpecularTexture&&(e.specularMap=this.atlasSpecularTexture),this.urban.useSpecularMap?e.uniforms.use_specularMap.value=1:e.uniforms.use_specularMap.value=0):e.uniforms.use_specularMap.value=0,void 0===this.atlasSpecularTexture&&void 0===this.atlasNormalTexture||i.updateCommonUniforms(e))},setUniforms:function(e){void 0===this.atlasTexture||void 0===this.atlasInfoTexture?(e.uniforms.maps_atlas.value=o.whitetexture,e.uniforms.maps_atlas_info.value=o.whitetexture,this.onload.push(function(e){void 0!==e&&void 0!==e.uniforms&&(this.atlasTexture.shared++,this.atlasInfoTexture.shared++,e.uniforms.maps_atlas.value=this.atlasTexture,e.uniforms.maps_atlas_info.value=this.atlasInfoTexture,o.whitetexture.shared-=2,e.needsUpdate=!0)}.bind(this,e))):(this.atlasTexture.shared++,this.atlasInfoTexture.shared++,e.uniforms.maps_atlas.value=this.atlasTexture,e.uniforms.maps_atlas_info.value=this.atlasInfoTexture),void 0!==this.atlasSpecularTexture&&(this.atlasSpecularTexture.shared++,e.specularMap=this.atlasSpecularTexture,this.useSpecularMap&&(e.uniforms.use_specularMap.value=1)),void 0!==this.atlasNormalTexture&&(this.atlasNormalTexture.shared++,e.normalMap=this.atlasNormalTexture,this.useNormalMap&&(e.uniforms.use_normalMap.value=1)),i.updateCommonUniforms(e)},_defineTextureAs:function(e,t,i,s,n,a){void 0!==this[t]&&r.disposeV6(this[t]),this[t]=e,this[t].shared=-1,this[t].needsUpdate=!0,void 0!==a&&(this[t].flipY=a),void 0!==n&&(this[t].generateMipmaps=n),void 0!==s&&(this[t].minFilter=s,this[t].magFilter=s),void 0!==i&&(this[t].wrapS=i,this[t].wrapT=i)},loadAtlas:function(e,i){this._atlasBaseURL=e;var r=function(e){if(e){if(this.atlasTexture&&this.atlasInfoTexture){for(var t=this.onload.length;t--;)this.onload[t]();this.loaded=!0,i(this.loaded)}}else i(!1)}.bind(this);a.loadTexture(function(e,i){i&&this._defineTextureAs(e,"atlasTexture",t.ClampToEdgeWrapping),r(i)}.bind(this),e);var s=e.replace(".jpg","_info.png");a.loadTexture(function(e,i){i&&this._defineTextureAs(e,"atlasInfoTexture",t.ClampToEdgeWrapping,t.NearestFilter,!1,!1),r(i)}.bind(this),s),s=e.replace(".jpg","_sp.jpg"),a.loadTexture(function(e,i){i&&this._defineTextureAs(e,"atlasSpecularTexture",t.RepeatWrapping)}.bind(this),s),s=e.replace(".jpg","_nm.jpg"),a.loadTexture(function(e,i){i&&this._defineTextureAs(e,"atlasNormalTexture",t.RepeatWrapping)}.bind(this),s)},dispose:function(){n.warn("Dispose Atlas: "+this.name),this.loaded=!1,this.useNormalMap=!1,this.useSpecularMap=!1,this._atlasBaseURL=null,void 0!==this.atlasTexture&&(this.atlasTexture.shared=void 0,r.disposeV6(this.atlasTexture),this.atlasTexture=void 0),void 0!==this.atlasInfoTexture&&(this.atlasInfoTexture.shared=void 0,r.disposeV6(this.atlasInfoTexture),this.atlasInfoTexture=void 0),void 0!==this.atlasNormalTexture&&(this.atlasNormalTexture.shared=void 0,r.disposeV6(this.atlasNormalTexture),this.atlasNormalTexture=void 0),void 0!==this.atlasSpecularTexture&&(this.atlasSpecularTexture.shared=void 0,r.disposeV6(this.atlasSpecularTexture),this.atlasSpecularTexture=void 0)}});return o.whitetexture=new t.DataTexture(new Float32Array([1,1,1,1]),1,1,t.RGBAFormat,t.FloatType),o.whitetexture.flipY=!1,o.whitetexture.minFilter=t.LinearFilter,o.whitetexture.magFilter=t.LinearFilter,o.whitetexture.generateMipmaps=!1,o.whitetexture.needsUpdate=!0,o.whitetexture.shared=-1,o}),define("DS/XCityGeometry/Marker",["UWA/Core","UWA/Class","UWA/Class/Model","DS/Visualization/ThreeJS_DS","DS/xCityGlobeUtils/GeoitemModel","DS/xCityBasicUtils/Utils","DS/xCityBasicUtils/ColorGradient","DS/TransientWidget/TransientWidget","DS/XCityGeometry/DescriptionCard"],function(e,t,i,r,s,n,a,o,l){"use strict";return i.extend({defaults:{name:"",selected:!1,visible:!0,description:"",position:{},customClass:"",style:"annotationIcon",stroke:{},iconName:"",icon:{},color:"#003c5a",textStyle:"button",textColor:"rgb(226, 228, 227)",descriptionDisplayMode:"click"},setup:function(){var e=this;this.addEvent("onChange:name",function(){e.updateTitle()}),this.addEvent("onChange:selected",function(){e.updateSelection()}),this.addEvent("onChange:visible",function(){e.updateVisibility()}),this.addEvent("onChange:description",function(){e.updateDescription()}),this.addEvent("onChange:position",function(){e.update2DPosition()}),this.addEvent("onChange:style",function(){e.updateStyle()}),this.addEvent("onChange:stroke",function(){e.updateStroke()}),this.addEvent("onChange:iconName",function(){e.updateIconName()}),this.addEvent("onChange:icon",function(){e.updateIcon()}),this.addEvent("onChange:customClass",function(){e.updateCustomClassName()}),this.addEvent("onChange:color",function(){e.updateColor()}),this.addEvent("onChange:textStyle",function(){e.updateTextStyle()}),this.addEvent("onChange:textColor",function(){e.updateTextColor()}),this.addEvent("onChange:descriptionDisplayMode",function(){e.updateDescriptionDisplayMode()})},init:function(e){this._parent(e),this._feature=e.feature,this._urban=e.urban,this._markerManager=e.markerManager,this._quadTreeVisibleFlag=!0,this._collidedFlag=!1,this._iconClickCB=e.iconClickCB,this.buildElements(),this.updateProperties()},buildElements:function(){this.buildMarkerContainer(),"annotationIconAdvanced"===this.get("style")?this.buildPinAndNameContainer():(this.buildNameContainer(),this.buildPinContainer()),this.buildArrowContainer(),"annotationIconAdvanced"===this.get("style")?this.buildDescriptionAdvancedContainer():this.buildDescriptionContainer(),this.initElementsEvents()},updateProperties:function(){"annotationIconAdvanced"===this.get("style")&&this.set("color",""),this.updateTitle(),this.update2DPosition(),this.updateStyle(),this.updateIconName(),this.updateIcon(),this.updateCustomClassName(),this.updateColor(),this.updateTextStyle(),this.updateTextColor(),this.updateDescription(),this.updateDescriptionDisplayMode(),this.updateSelection(),this.updateVisibility(),this.updateStroke()},initElementsEvents:function(){var t=this;"annotationIconAdvanced"===this.get("style")?(this._pinAndNameContainer.addEvent("mouseover",function(){t._markerContainer.addClassName("xcity-marker-container-hover"),t.get("selected")||t.updatePinAndNameContainer(!0)}),this._nameContainer.addEvent("mouseover",function(){t.get("description")&&t.hoverAnnotationIconAdvancedColoring(!0,"name")}),this._pinFront.addEvent("mouseover",function(){t.hoverAnnotationIconAdvancedColoring(!0,"icon")}),this._arrowContainer.addEvent("mouseover",function(){t._markerContainer.addClassName("xcity-marker-container-hover"),t.get("selected")||t.updatePinAndNameContainer(!0)}),this._pinAndNameContainer.addEvent("mouseout",function(){t._markerContainer.removeClassName("xcity-marker-container-hover"),t.updatePinAndNameContainer(!1)}),this._nameContainer.addEvent("mouseout",function(){t.hoverAnnotationIconAdvancedColoring(!1,"name")}),this._pinFront.addEvent("mouseout",function(){t.hoverAnnotationIconAdvancedColoring(!1,"icon")}),this._arrowContainer.addEvent("mouseout",function(){t._markerContainer.removeClassName("xcity-marker-container-hover"),t.updatePinAndNameContainer(!1)}),this._nameContainer.addEvent("click",function(e){var i={event:e};t._urban.getView3D().getPicker().select(t._feature._itemParent,i,e),t.get("description")&&t.toggleAnnotationIconAdvancedName(!0)}),this._pinFront.addEvent("click",function(){t.updatePinAndNameContainer(!1);var i=t.get("feature");if(i){var r=i._itemParent.get("userData");if(e.is(r,"object")&&e.is(r.TransientWidgetOption,"object"))return t.openTransientWidget(r);var s=i.get("objectId");t.openPlatformContent(s)}})):(this._nameContainer.addEvent("mouseover",function(){t._applyHoverColor(),t._markerContainer.addClassName("xcity-marker-container-hover")}),this._pinFront.addEvent("mouseover",function(){t._applyHoverColor(),t._markerContainer.addClassName("xcity-marker-container-hover")}),this._pinBack.addEvent("mouseover",function(){t._applyHoverColor(),t._markerContainer.addClassName("xcity-marker-container-hover")}),this._arrowContainer.addEvent("mouseover",function(){t._applyHoverColor(),t._markerContainer.addClassName("xcity-marker-container-hover")}),this._descriptionContainer.addEvent("mouseover",function(){t._applyHoverColor(),t._markerContainer.addClassName("xcity-marker-container-hover")}),this._nameContainer.addEvent("mouseout",function(){t._setHovered(!1),t.updateColor(),t._markerContainer.removeClassName("xcity-marker-container-hover")}),this._pinFront.addEvent("mouseout",function(){t._setHovered(!1),t.updateColor(),t._markerContainer.removeClassName("xcity-marker-container-hover")}),this._pinBack.addEvent("mouseout",function(){t._setHovered(!1),t.updateColor(),t._markerContainer.removeClassName("xcity-marker-container-hover")}),this._arrowContainer.addEvent("mouseout",function(){t.updateColor(),t._markerContainer.removeClassName("xcity-marker-container-hover")}),this._descriptionContainer.addEvent("mouseout",function(){t.updateColor(),t._markerContainer.removeClassName("xcity-marker-container-hover")}),this._nameContainer.addEvent("click",function(e){t._feature._itemParent.set("selected",!t.get("selected"))}),this._pinFront.addEvent("click",function(){t._feature._itemParent.set("selected",!t.get("selected"))}),this._pinBack.addEvent("click",function(){t._feature._itemParent.set("selected",!t.get("selected"))}),this._arrowContainer.addEvent("click",function(){t._feature._itemParent.set("selected",!t.get("selected"))}),this._descriptionContainer.addEvent("click",function(){t._feature._itemParent.set("selected",!t.get("selected"))}))},update2DPosition:function(){this.position2D={},this.position2D=this._urban.USR.viewpoint.getScreenPosition(this.get("position")),(this.position2D.z<-1||this.position2D.z>1||this.position2D.x<0||this.position2D.x>window.innerWidth||this.position2D.y<0||this.position2D.y>window.innerHeight)&&(this._outOfFrustumFlag=!0,this.updateVisibility()),!0===this._outOfFrustumFlag&&(this._outOfFrustumFlag=!1,this.get("visible")&&this.updateVisibility());var e="custom"===this.get("style")?this.position2D.x:this.position2D.x+"px",t="custom"===this.get("style")?this.position2D.y:this.position2D.y-this._shiftValue+"px";if(this._markerContainer.setStyles({left:e,top:t}),this._markerContainer.hasClassName("xcity-marker-selected")){var i=this._descriptionContainer.getSize(),r=100-i.width/2,s=-(i.height+5),n=this._pinContainer.getBoundingClientRect();this._descriptionCard.slideElementAccordingToBbox(r,s,n)}},destroy:function(){this._markerContainer.destroy()},buildMarkerContainer:function(){this._markerContainer=new e.Element("div",{class:"xcity-marker-container"}).inject(this._markerManager.getMarkersContainer())},buildPinContainer:function(){this._pinContainer=new e.Element("div",{class:"xcity-marker-pin"}).inject(this._markerContainer),this._pinBack=new e.Element("div",{class:"xcity-marker-pin-back"}).inject(this._pinContainer),this._pinFront=new e.Element("div",{class:"xcity-marker-pin-front"}).inject(this._pinContainer),this._pinFrontIcon=new e.Element("i").inject(this._pinFront)},buildPinAndNameContainer:function(){this._pinAndNameContainer=new e.Element("div",{class:"xcity-marker-pin-and-name-container"}).inject(this._markerContainer),this._pinAndNameContainerBG=new e.Element("div",{class:"xcity-marker-pin-and-name-bg"}).inject(this._pinAndNameContainer),this._pinContainer=new e.Element("div",{class:"xcity-marker-pin"}).inject(this._pinAndNameContainer),this._pinBack=new e.Element("div",{class:"xcity-marker-pin-back"}),this._pinFront=new e.Element("div",{class:"xcity-marker-pin-front"}).inject(this._pinContainer),this._pinFrontIcon=new e.Element("i").inject(this._pinFront),this._nameContainer=new e.Element("div",{class:"xcity-marker-name"}).inject(this._pinAndNameContainer)},buildDescriptionAdvancedContainer:function(){this.buildDescriptionContainer(),this._descriptionTitle=new e.Element("div",{class:"xcity-marker-description-title"}).inject(this._descriptionContainer),this._descriptionText=new e.Element("div",{class:"xcity-marker-description-text"}).inject(this._descriptionContainer)},buildNameContainer:function(){this._nameContainer=new e.Element("div",{class:"xcity-marker-name"}).inject(this._markerContainer)},buildArrowContainer:function(){this._arrowContainer=new e.Element("div",{class:"xcity-marker-arrow"}).inject(this._markerContainer)},buildDescriptionContainer:function(){this._descriptionCard=new l("xcity-marker-description"),this._descriptionContainer=this._descriptionCard.div,this._descriptionContainer.inject(this._markerContainer)},updateTitle:function(){this._nameContainer.setHTML(this.get("name")),"annotationIconAdvanced"===this.get("style")&&this._descriptionTitle.setHTML(this.get("name")),this.update2DPosition()},updateSelection:function(){this.get("selected")?this._markerContainer.addClassName("xcity-marker-selected"):(this._markerContainer.removeClassName("xcity-marker-selected"),"annotationIconAdvanced"===this.get("style")&&this.toggleAnnotationIconAdvancedName(!1)),this.updateColor(),this._markerManager.render()},updateVisibility:function(){this.get("visible")&&this._quadTreeVisibleFlag&&!this._outOfFrustumFlag?(this.show(),this.fade(!this._collidedFlag)):this.hide()},show:function(){this._markerContainer.removeClassName("xcity-marker-not-visible"),this._visibleFlag=!0,this._markerManager.hiddenMarkerCollection.remove(this),this._markerManager.markerCollection.add(this)},hide:function(){this._markerContainer.addClassName("xcity-marker-not-visible"),this._visibleFlag=!1,this._collidedFlag||(this._markerManager.markerCollection.remove(this),this._markerManager.hiddenMarkerCollection.add(this))},fade:function(e){let t=this._markerContainer;e?(t.hasClassName("xcity-marker-fadeOut")&&t.removeClassName("xcity-marker-fadeOut"),t.hasClassName("xcity-marker-fadeIn")||t.addClassName("xcity-marker-fadeIn")):(t.hasClassName("xcity-marker-fadeIn")&&t.removeClassName("xcity-marker-fadeIn"),t.hasClassName("xcity-marker-fadeOut")||t.addClassName("xcity-marker-fadeOut"))},updateCustomClassName:function(){n.is(this._markerContainer)&&n.is(this.get("customClass"))&&"string"==typeof this.get("customClass")&&this._markerContainer.addClassName(this.get("customClass"))},updateDescription:function(){"annotationIconAdvanced"===this.get("style")?(this._descriptionText.setHTML(this.get("description")),this.updatePositionAnnotationIconAdvancedDescription()):this._descriptionContainer.setHTML(this.get("description")),""!==this.get("description")?(this._markerContainer.removeClassName("xcity-marker-description-disable"),this._markerContainer.addClassName("xcity-marker-description-enable")):(this._markerContainer.removeClassName("xcity-marker-description-enable"),this._markerContainer.addClassName("xcity-marker-description-disable"))},_updateContainerClassName:function(e){n.is(this._markerContainer)&&n.is(e)&&"string"==typeof e&&(-1!==e.indexOf("style")||""===e?(this._markerContainer.removeClassName("xcity-marker-icon-style"),this._markerContainer.removeClassName("xcity-marker-arrow-style"),this._markerContainer.removeClassName("xcity-marker-point-style"),this._markerContainer.removeClassName("xcity-marker-annotation-style"),this._markerContainer.removeClassName("xcity-marker-annotation-icon-style"),this._markerContainer.removeClassName("xcity-marker-annotation-icon-advanced-style"),this._markerContainer.removeClassName("xcity-marker-placename-style"),this._markerContainer.addClassName(e)):-1!==e.indexOf("text")||""===e?(this._markerContainer.removeClassName("xcity-marker-lite-text"),this._markerContainer.removeClassName("xcity-marker-button-text"),this._markerContainer.addClassName(e)):-1===e.indexOf("description-mode")&&""!==e||(this._markerContainer.removeClassName("xcity-marker-description-mode-hover"),this._markerContainer.removeClassName("xcity-marker-description-mode-always"),this._markerContainer.removeClassName("xcity-marker-description-mode-click"),this._markerContainer.addClassName(e)))},_updateShiftValue:function(){var e=0;switch(this.get("style")){case"icon":e=5;break;case"point":e=-10;break;default:e=0}this._shiftValue=e},updateStyle:function(){switch(this._deactivateCustomStyle(),this.get("style")){case"icon":this._updateContainerClassName("xcity-marker-icon-style");break;case"point":this._updateContainerClassName("xcity-marker-point-style");break;case"placename":this._updateContainerClassName("xcity-marker-placename-style");break;case"annotation":this._updateContainerClassName("xcity-marker-annotation-style");break;case"annotationIcon":this._updateContainerClassName("xcity-marker-annotation-icon-style");break;case"annotationIconAdvanced":this._updateContainerClassName("xcity-marker-annotation-icon-advanced-style");break;case"custom":this._updateContainerClassName(""),this._activateCustomStyle();break;default:this._updateContainerClassName("xcity-marker-arrow-style")}this.updateColor(),this._updateShiftValue(),this.update2DPosition()},_activateCustomStyle:function(){this._markerContainer.removeClassName("xcity-marker-container"),this._nameContainer.removeClassName("xcity-marker-name"),this._pinContainer.removeClassName("xcity-marker-pin"),this._pinBack.removeClassName("xcity-marker-pin-back"),this._pinFront.removeClassName("xcity-marker-pin-front"),this._arrowContainer.removeClassName("xcity-marker-arrow"),this._descriptionContainer.removeClassName("xcity-marker-description"),this._markerContainer.addClassName("xcity-marker-container-custom"),this._nameContainer.addClassName("xcity-marker-name-custom"),this._pinContainer.addClassName("xcity-marker-pin-custom"),this._pinBack.addClassName("xcity-marker-pin-back-custom"),this._pinFront.addClassName("xcity-marker-pin-front-custom"),this._arrowContainer.addClassName("xcity-marker-arrow-custom"),this._descriptionContainer.addClassName("xcity-marker-description-custom"),"annotationIconAdvanced"===this.get("style")&&(this._pinAndNameContainer.removeClassName("xcity-marker-pin-and-name"),this._pinAndNameContainer.addClassName("xcity-marker-pin-and-name-custom")),n.is(this._pinFrontIcon)&&this._pinFrontIcon.hide(),n.is(this._pinFrontImg)&&this._pinFrontImg.hide(),this._nameContainer.removeAttribute("style"),this._pinBack.removeAttribute("style"),this._arrowContainer.removeAttribute("style"),this._descriptionContainer.removeAttribute("style")},_deactivateCustomStyle:function(){this._markerContainer.removeClassName("xcity-marker-container-custom"),this._nameContainer.removeClassName("xcity-marker-name-custom"),this._pinContainer.removeClassName("xcity-marker-pin-custom"),this._pinBack.removeClassName("xcity-marker-pin-back-custom"),this._pinFront.removeClassName("xcity-marker-pin-front-custom"),this._arrowContainer.removeClassName("xcity-marker-arrow-custom"),this._descriptionContainer.removeClassName("xcity-marker-description-custom"),this._markerContainer.addClassName("xcity-marker-container"),this._nameContainer.addClassName("xcity-marker-name"),this._pinContainer.addClassName("xcity-marker-pin"),this._pinBack.addClassName("xcity-marker-pin-back"),this._pinFront.addClassName("xcity-marker-pin-front"),this._arrowContainer.addClassName("xcity-marker-arrow"),this._descriptionContainer.addClassName("xcity-marker-description"),"annotationIconAdvanced"===this.get("style")&&(this._pinAndNameContainer.removeClassName("xcity-marker-pin-and-name-custom"),this._pinAndNameContainer.addClassName("xcity-marker-pin-and-name")),this._pinFrontIcon.show(),this.updateIconName(),this.updateIcon()},updateIconName:function(){n.is(this._pinFrontIcon)&&("custom"!==this.get("style")&&this._pinFrontIcon.show(),n.is(this._pinFrontImg)&&this._pinFrontImg.hide(),this._pinFrontIcon.className="",this._pinFrontIcon.className="xcity-marker-font-icon wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-"+this.get("iconName"))},updateIcon:function(){n.is(this.get("icon").iconName)&&(n.is(this.get("icon").fontIcon)||this.set("iconName",this.get("icon").iconName)),n.is(this.get("icon").iconPath)&&n.is(this._pinFrontIcon)&&(this._pinFrontIcon.hide(),n.is(this._pinFrontImg)&&this._pinFrontImg.remove(),this._pinFrontImg=new e.Element("img",{class:"xcity-marker-icon-image",src:this.get("icon").iconPath,draggable:!1}).inject(this._pinFront),"custom"===this.get("style")?this._pinFrontImg.hide():this._pinFrontImg.show())},updateColor:function(){if("custom"!==this.get("style")){var e;this.get("color")instanceof a?this._currentColor=new r.Color(this.get("color").getStyle()):this._currentColor=new r.Color(this.get("color")),this.get("selected")&&this._applySelectedColor(),e=this._currentColor.getStyle(),this._applyColor(e)}},_applySelectedColor:function(){if("custom"!==this.get("style")&&this.get("selected")){var e;this._currentColor.setHSL(this._currentColor.getHSL().h,this._currentColor.getHSL().s,this._currentColor.getHSL().l+.2),e=this._currentColor.getStyle(),this._applyColor(e)}},updateTextColor:function(){if("custom"!==this.get("style")){var e;this.get("textColor")instanceof a?this._currentTextColor=new r.Color(this.get("textColor").getStyle()):this._currentTextColor=new r.Color(this.get("textColor")),e=this._currentTextColor.getStyle(),this._applyTextColor(e)}},_applyTextColor:function(e){"custom"!==this.get("style")&&"lite"===this.get("textStyle")&&this._nameContainer.setStyle("color",e)},_applyHoverColor:function(){this._setHovered(!0),"custom"!==this.get("style")&&(this.get("selected")||(this._currentColor||(this._currentColor=new r.Color(this.get("color"))),this._currentColor.setHSL(this._currentColor.getHSL().h,this._currentColor.getHSL().s,this._currentColor.getHSL().l+.1),this._applyColor(this._currentColor.getStyle())))},_setHovered:function(e){this._hovered!==e&&(this._hovered=e,this._markerManager.render())},_applyColor:function(e){if("custom"!==this.get("style")){var t=new r.Color(e);this._arrowContainer.setStyle("border-top-color",e),"annotationIconAdvanced"!==this.get("style")&&this._nameContainer.setStyle("background-color",e),this._pinBack.setStyle("background-color",e),this._descriptionContainer.setStyle("background-color",e),"lite"!==this.get("textStyle")&&(n.isBright(t)?(this._nameContainer.setStyle("color","#212121"),this._pinFrontIcon.setStyle("color","#212121"),this._descriptionContainer.setStyle("color","#212121")):(this._nameContainer.setStyle("color","#E2E4E3"),this._pinFrontIcon.setStyle("color","#E2E4E3"),this._descriptionContainer.setStyle("color","#E2E4E3")))}},updateTextStyle:function(){if("custom"!==this.get("style"))switch(this.get("textStyle")){case"lite":this._updateContainerClassName("xcity-marker-lite-text"),this.updateTextColor();break;default:this._updateContainerClassName("xcity-marker-button-text")}},updateStroke:function(){if(this.get("stroke").color){var e={"border-style":"solid","border-width":"1px","border-color":this.get("stroke").color};switch(this.get("style")){case"point":case"annotationIcon":case"icon":this._pinBack.setStyles(e)}"button"===this.get("textStyle")&&this._nameContainer.setStyles(e)}},updateDescriptionDisplayMode:function(){if("custom"!==this.get("style"))switch(this.get("descriptionDisplayMode")){case"hover":this._updateContainerClassName("xcity-marker-description-mode-hover");break;case"always":this._updateContainerClassName("xcity-marker-description-mode-always");break;default:this._updateContainerClassName("xcity-marker-description-mode-click")}},updatePinAndNameContainer:function(e){var t=this._pinContainer.getSize().width,i=this._nameContainer.getSize().width,r=this._nameContainer.getSize().height;e?(this._pinAndNameContainerBG.setStyle("width",t+i+30-15),this._pinAndNameContainerBG.setStyle("height",r)):(this._pinAndNameContainerBG.setStyle("width",30),this._pinAndNameContainerBG.setStyle("height",30)),this._setHovered(e)},updatePositionAnnotationIconAdvancedDescription:function(){var e=this._descriptionContainer.getSize(),t=e.width,i=e.height;this._descriptionContainer.setStyles({top:-(i+5),left:100-t/2})},hoverAnnotationIconAdvancedColoring:function(e,t){"name"===t?e?this._nameContainer.setStyle("color","rgb(54, 142, 196)"):this._nameContainer.setStyle("color","rgb(0, 0, 0)"):"icon"===t&&(e?this._pinFront.setStyle("color","rgb(54, 142, 196)"):this._pinFront.setStyle("color","rgb(0, 0, 0)"))},toggleAnnotationIconAdvancedName:function(e){e?(this.updatePositionAnnotationIconAdvancedDescription(),this._nameContainer.setStyle("opacity",0),this._nameContainer.hide()):(this._nameContainer.setStyle("opacity",1),this._nameContainer.show())},openTransientWidget:function(e){var t=e.TransientWidgetOption;o.showWidget(t.appId,void 0,t,{mode:t.mode||"panel",height:t.height||800,width:t.width||650})},openPlatformContent:function(t){if(e.is(t,"string")&&""!==t){var i={mode:"panel",height:800,width:650};return new s({uuid:t}).fetchItem().then(function(e){var t=e.model;if(!t)throw new Error("Unable to retrieve geolocated item");if("3DSwym"!==t.get("serviceId"))return Promise.resolve();var r={x3dPlatformId:t.get("envId"),contentId:t.get("objectId"),contentType:t.get("objectType")};return o.showWidget("X3DVIEW_AP",void 0,r,i)})}}})}),define("DS/XCityGeometry/PointOfInterest",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s,n,a){"use strict";return t.extend({init:function(e,t,i,r,s,n,a,o,l){this._parentContent=t,this._urban=e,this.callback=null,this.visible=!1,this.mayVisible=!1,this.outside=!1,this.isSelected=!1,this.highlighted=!1,o||(o=e.poiManager.defaultStyle);var h=r.split(" "),d=h[0];this.poiData={className:d,text:s,iconClassName:n,style:o,classNames:h,description:l},this.worldPos=i,this.callback=void 0,this.userData=void 0,this.parentDiv=e.poiManager.parentDiv,this.textDiv=null,this.arrowDiv=null,this.divWidth=0,this.divHeight=0,this.arrowWidth=0,this.arrowHeight=0,this.isSelected=!1,this.highlighted=!1,this.create2DPOI(e),this._group=a,e.poiManager.registerPOI(this,a),this.updatePosition(e.USR.viewpoint)},setCallback:function(e){this.callback=e},setUserData:function(e){this.userData=e},display:function(){s.log(this.worldPos.position.z)},appearArrowOnly:function(){null!==this.arrowDiv&&(this.arrowDiv.style.opacity="1")},appear:function(){this.setVisible(!0),this.textDiv.classList.remove("fadeOut"),this.textDiv.classList.add("fadeIn"),this.textDiv.style.pointerEvents="auto",null!==this.arrowDiv&&(this.arrowDiv.style.opacity="1",this.arrowDiv.style.pointerEvents="auto")},disappear:function(e){this.textDiv.classList.remove("fadeIn"),this.textDiv.classList.add("fadeOut"),this.textDiv.style.pointerEvents="none",null!==this.arrowDiv&&(this.arrowDiv.style.opacity=void 0===e?"0.5":"0.0",this.arrowDiv.style.pointerEvents="auto")},appendTo:function(){this.parentDiv.appendChild(this.textDiv),null!==this.arrowDiv&&this.parentDiv.appendChild(this.arrowDiv),this.updateSize()},setVisibility:function(e){this.mayVisible=e,!1===this.mayVisible&&this.setVisible(!1)},setVisible:function(e){this.visible!==e&&(!0===e&&!0===this.mayVisible?(this.appendTo(),this.visible=!0):(this.remove(),this.visible=!1))},isVisible:function(){return this.visible},getVisibility:function(){return this.mayVisible},remove:function(){!0===this.visible&&(this.parentDiv.contains(this.textDiv)&&this.parentDiv.removeChild(this.textDiv),null!==this.arrowDiv&&this.parentDiv.removeChild(this.arrowDiv))},destroy:function(){this._urban.poiManager.unregisterPOI(this,this._group)},setPosition:function(e){this.worldPos=e},updatePosition:function(e){var t=e.getScreenPosition(this.worldPos),i=(this.divWidth,this.divHeight,this.poiData.style),r=t.x,s=t.y;if(this.outside=!1,null!==this.arrowDiv){var n=r-.5*this.arrowWidth,a=s-this.arrowHeight;this.arrowDiv.style.cssText+="; left: "+n+"px; top: "+a+"px;"}if(i){o=r;"center"===i.HPos?o-=.5*this.divWidth:"left"===i.HPos?o-=this.divWidth+.5*this.arrowWidth:"right"===i.HPos&&(o+=.5*this.arrowWidth);l=s;"center"===i.VPos?l-=this.arrowHeight+.5*this.divHeight:"top"===i.VPos?l-=this.divHeight+.8*this.arrowHeight:"bottom"===i.VPos&&(l-=this.divHeight-.8*this.arrowHeight)}else var o=r-.5*this.divWidth,l=s-(this.divHeight+.8*this.arrowHeight);if(this.textDiv.style.cssText+="; left: "+Math.ceil(o)+"px; top: "+Math.ceil(l)+"px;",t.z<-1||t.z>1)return this.disappear(!0),this.textDiv.style.cssText+="; left: -1000px; top: -1000px;",void(this.outside=!0);this.textDiv.cleft=o,this.textDiv.ctop=l,this.textDiv.cbottom=l+this.divHeight,this.textDiv.cright=o+this.divWidth},getParentDiv:function(){return this.parentDiv},updateSize:function(){var e=window.getComputedStyle(this.textDiv),t=isNaN(parseFloat(e.padding))?0:2*parseFloat(e.padding),i=isNaN(parseFloat(e.borderWidth))?0:2*parseFloat(e.borderWidth);if(this.divWidth=(isNaN(parseFloat(e.width))?0:parseFloat(e.width))+i+t,this.divHeight=(isNaN(parseFloat(e.height))?0:parseFloat(e.height))+i+t,null!==this.arrowDiv){var r=window.getComputedStyle(this.arrowDiv);t=isNaN(parseFloat(r.padding))?0:2*parseFloat(r.padding),i=isNaN(parseFloat(r.borderWidth))?0:2*parseFloat(r.borderWidth),this.arrowWidth=(isNaN(parseFloat(r.width))?0:parseFloat(r.width))+i+t,this.arrowHeight=(isNaN(parseFloat(r.height))?0:parseFloat(r.height))+i+t}},setText:function(e){var t;void 0!==this.poiData.iconClassName?(t=document.createElement("span")).className=this.poiData.iconClassName:t=document.createElement("p"),t.className="annotationStyle"===this.poiData.className?"annotationStyleSpan":"PoiSpan";var i=document.createTextNode(e);t.appendChild(i);var r=this.textDiv.getElementsByClassName("PoiSpan");r.length&&this.textDiv.removeChild(r[0]);var s=this.textDiv.getElementsByClassName("annotationStyleSpan");s.length&&this.textDiv.removeChild(s[0]),this.textDiv.appendChild(t),this.poiData.text=i,this.updateSize()},setDescription:function(e){a.is(e)&&(a.is(this.descriptionContainer)?this.descriptionContainer.setHTML(e):this.descriptionContainer=UWA.Element("div",{class:"POIDescription",html:e}).inject(this.textDiv),""===e?this.descriptionContainer.addClassName("empty-description"):this.descriptionContainer.removeClassName("empty-description"))},create2DPOI:function(t){void 0!==this.poiData.iconClassName&&(this.arrowDiv=e.createElement("div",{class:"arrow"}),this.arrowDiv.style.position="absolute",this.arrowDiv.style.visibility="visible");this.poiData.style;this.textDiv="annotationStyle"===this.poiData.className?e.createElement("div"):e.createElement("div",{class:"POIText"});for(var i=0;i<this.poiData.classNames.length;i++)this.textDiv.classList.add(this.poiData.classNames[i]);this.textDiv.style.position="absolute",this.textDiv.style.visibility="visible",this.setText(this.poiData.text),0===t.getView3D().frameId&&n.subscribeTo("/3DEXPERIENCity/onSceneReady",this.updateSize.bind(this),!0);var r=this;null!==this.arrowDiv&&(this.arrowDiv.onmouseover=function(e){r.isSelected||r.highlight(!0)},this.arrowDiv.onmouseout=function(e){r.isSelected||r.highlight(!1)},this.arrowDiv.onmousedown=function(e){e.stopPropagation(),t.poiManager.mouseDown(r,e)},this.arrowDiv.ondblclick=function(e){e.stopPropagation(),t.poiManager.mouseDblClick(r,e)}),this.textDiv.onmouseover=function(e){r._parentContent._itemParent.get("hoverable")&&(r._parentContent._itemParent.set("hovered",!0),r.isSelected||r.highlight(!0))},this.textDiv.onmouseout=function(e){r._parentContent._itemParent.get("hoverable")&&(r._parentContent._itemParent.set("hovered",!1),r.isSelected||r.highlight(!1))},this.textDiv.onclick=function(e){e.stopPropagation(),t.poiManager.mouseDown(r,e)},this.textDiv.ondblclick=function(e){e.stopPropagation(),t.poiManager.mouseDblClick(r,e)}},updateClassName:function(e){this.textDiv.className="annotationStyle"===this.poiData.className?e:"POIText "+e},select:function(e){e!==this.isSelected&&(this.isSelected=e,this.highlight(e))},highlight:function(e){e!==this.highlighted&&(this.highlighted=e,e?(this.textDiv.classList.remove("fadeOut"),this.textDiv.style.zIndex=1,this.textDiv.classList.add("fadeIn"),this.textDiv.classList.add(this.poiData.className+"Over"),null!==this.arrowDiv&&this.arrowDiv.classList.add("arrowOver")):(this.textDiv.style.zIndex="",this.textDiv.classList.remove(this.poiData.className+"Over"),null!==this.arrowDiv&&this.arrowDiv.classList.remove("arrowOver")))}})}),define("DS/XCityModel/View3DContextualMenuManager",["UWA/Class","DS/ApplicationFrame/ContextualUIManager","DS/Selection/CSOManager","DS/XCityTools/EventDispatcher","DS/XCityTools/Debug"],function(e,t,i,r,s){"use strict";return e.singleton({init:function(){this._frmWindow,this._dataModelSelection,this._manager,this.updateMouseToken,this.updateTouchToken,this._mousePos={x:0,y:0},this._contextualCase={},this._visibility=!1},initialize:function(e,t){this._dataModelSelection=t,void 0!==e.urban&&(this._frmWindow=e.urban.frmWindow),this._visibility&&this.enable()},updateMouse:function(e){var t=e;e.from&&e.from.length&&(t=e.from[0].event),t.touches&&t.touches.length>0?this._mousePos={x:t.touches[0].clientX,y:t.touches[0].clientY}:this._mousePos={x:t.clientX,y:t.clientY}},enable:function(){return this._visibility?(s.log("Contextual Menu Manager already enable."),!1):(this._visibility=!0,this._manager=new t({frameWindow:this._frmWindow}),this._manager.register({workbenchName:"View3DContextualMenu",module:"XCityCoreUI",cmdPrefix:"",fileName:"View3DContextualMenu.xml",onContextualBarReady:this._onContextualBarReady.bind(this)}),void 0===this._dataModelSelection?(s.warn("Contextual Menu Manager could not be enable: DataModelSelection is missing."),!1):(this._dataModelSelection.addEvent("onDeselect",this._hide,this),this.updateMouseToken=r.subscribeToLeftMouseDown(this.updateMouse.bind(this)),this.updateTouchToken=r.subscribeTo("/VISU/onTouch",this.updateMouse.bind(this)),!0))},disable:function(){return this._dataModelSelection.removeEvent("onDeselect",this._hide,this),r.unsubscribe(this.updateMouseToken),r.unsubscribe(this.updateTouchToken),this._hide(),!0},addNewContextualMenu:function(e,t){this._contextualCase[e]?this._contextualCase[e].cmdList=this._mergeCmdList(this._contextualCase[e].cmdList,t):this._contextualCase[e]={comparator:e,cmdList:t}},_mergeCmdList:function(e,t){var i,r=[];for(i=0;i<e.length;++i)r.push(e[i]);for(i=0;i<t.length;++i)r.push(t[i]);return r},_onContextualBarReady:function(){var e,t,r=i.get(),s=[];if(r.length>0&&(e=r[r.length-1].model)&&e.get("selected"))for(t in this._contextualCase)(0,this._contextualCase[t].comparator)(e)&&(s=this._mergeCmdList(s,this._contextualCase[t].cmdList));return s.length>0?{cmdList:s}:void 0},_display:function(e){},_hide:function(){},clear:function(e){}})}),define("DS/XCityModel/LayerVectorPrimitive",["DS/Visualization/ThreeJS_DS","DS/XCityTools/Geocoder","DS/XCityModel/Item","DS/XCityModel/View3DContextualMenuManager","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s){"use strict";var n=i.extend({defaults:{strid:"",dataSourceId:"",geojson:null,instanceId:""},metaData:{type:"Geometry",className:"LayerVectorPrimitive"},setup:function(){this._parent(),this._subMeshes=[],this._localPosition=void 0,this._verticalCameraAltitude=0,this._deselectParent=this.deselectParent.bind(this)},traverse:function(e){for(var t=0;t<this._subMeshes.length;t++)e(this._subMeshes[t].mesh,this._subMeshes[t].subElement)},create:function(e){if(this.created=this._parent(e),!this.created)return!1;this._visible=!0,this._itemParent&&(this._visible=this._itemParent.get("visible")),this.urban=e._urban,this.renderingProfileManager=this.urban.getRenderingProfileManager();for(var t=this.getItemParent();!this._layer&&s.is(t);){var i=t.getItemParent();s.is(i)&&(this._layer=i.getContent()),t=i}return this._layer&&(this._layer.register(this),s.is(this._layer.getItemParent())&&this._layer.getItemParent().addEvent("onChange:selected",this._deselectParent)),this._attachToMesh(),!0},deselectParent:function(){s.is(this.getItemParent())&&this.getItemParent().set("selected",!1)},destroy:function(){if(this._layer){this.resetRenderingAttributes(),s.is(this._layer.getItemParent())&&this._layer.getItemParent().removeEvent("onChange:selected",this._deselectParent),this._layer.unregister(this);for(var e=void 0,t=0;t<this._layer._node.children.length;++t)if(this._layer._node.children[t].isAreaCluster){e=this._layer._node.children[t];break}void 0!==e&&this._layer._node.removeChild(e)}this._layer=void 0,this._detachToMesh(),this._subMeshes=[],this._parent()},addSubElements:function(i,r){if(i){if(i.geom){r&&(this._subMeshes=[]);for(var s=0;s<i.geom.length;s++){var n=i.geom[s];n.start?this.addSubElement(n.geometry,{start:n.start,count:n.count}):this.addSubElement(n.mesh,n.subElement)}this._visible||this.setVisible(!1)}var a;if(i.userData)for(a in null===this.userData&&(this.userData={}),i.userData)i.userData.hasOwnProperty(a)&&(this.userData[a]=i.userData[a]);if(i.posSize&&i.posSize.center&&i.posSize.center instanceof e.Vector3){if(this._localPosition=i.posSize.center.clone(),"EPSG:3857"===t.getDefaultProjection()||"EPSG:900913"===t.getDefaultProjection()){var o=t.computeMercatorScaleFactor(this._localPosition.x,this._localPosition.y,t.getDefaultProjection());this._localPosition.z*=o}i.posSize.diameter?this._localSphereDiameter=i.posSize.diameter:this._localSphereDiameter=Math.max(i.posSize.height,i.posSize.length,i.posSize.width)}}else this._subMeshes=[]},setLayerVector:function(e){this._layer=e,this.set("dataSourceId",this._layer.id)},addSubElement:function(e,t){t instanceof THREEDS.SubElement||(t=THREEDS.SubElement.getFromSGNode(t)),e.instanceId=this.get("instanceId");for(var i=!1,r=0;r<this._subMeshes.length;++r)this._subMeshes[r].mesh.id===e.id&&this._subMeshes[r].subElement.id===t.id&&(i=!0);i||(this._subMeshes.push({mesh:e,subElement:t}),t.sgNode.userData=this._feature)},_attachToMesh:function(){for(var e=0;e<this._subMeshes.length;e++)this._subMeshes[e].subElement.sgNode&&(this._subMeshes[e].subElement.sgNode.userData=this._feature)},_detachToMesh:function(){for(var e=0;e<this._subMeshes.length;e++)this._subMeshes[e].subElement.sgNode&&(this._subMeshes[e].subElement.sgNode.userData=void 0)},_setFeature:function(e){this._feature=e,this._attachToMesh(this)},getLocalPosition:function(){return this._localPosition},getSphereDiameter:function(){return this._localSphereDiameter},getBoundingSphere:function(){if(this._localPosition&&this._localSphereDiameter)return new e.Sphere(this._localPosition,this._localSphereDiameter/2)},getBbox:function(){var t=this.getFactory()._getPrimInfo(this).posSize;if(!s.is(t)){var i=this.getFactory()._getPrimInfo(this).geom[0].mesh.getBoundingBox();(t={}).width=i.max.x-i.min.x,t.length=i.max.y-i.min.y,t.height=i.max.z-i.min.z}var r=t.center;r.z=t.altitude;var n=parseFloat(t.width),a=parseFloat(t.length),o=parseFloat(t.height);return i=[new e.Vector3(r.x-a/2,r.y-n/2,r.z),new e.Vector3(r.x+a/2,r.y-n/2,r.z),new e.Vector3(r.x-a/2,r.y+n/2,r.z),new e.Vector3(r.x-a/2,r.y-n/2,r.z+o),new e.Vector3(r.x+a/2,r.y+n/2,r.z),new e.Vector3(r.x-a/2,r.y+n/2,r.z+o),new e.Vector3(r.x+a/2,r.y-n/2,r.z+o),new e.Vector3(r.x+a/2,r.y+n/2,r.z+o)]},getBboxFromTurf:function(){var t=this.getFactory()._getFeatureDataFromStrid(this._getStrid()),i=s.getBbox(t),r=i[0],n=i[1],a=i[2],o=i[3],l=this.getFactory()._getPrimInfo(this).posSize.altitude,h=i[4]?l+i[4]:l,d=i[5]?l+i[5]:l;return[new e.Vector3(r,n,h),new e.Vector3(a,n,h),new e.Vector3(r,o,h),new e.Vector3(a,o,h),new e.Vector3(r,n,d),new e.Vector3(a,n,d),new e.Vector3(r,o,d),new e.Vector3(a,o,d)]},getBboxProjectedInScreen:function(){var t;if("billboard"===this.get("shapeType")){let t=this.getFactory()._computeLabelPos(this),i=this.urban.USR.viewpoint.getScreenPosition(t),r=this.getFactory()._computeGeometrySize(this),s=r.width,n=r.height;if(this.get("switchDistance")){let i=this._subMeshes[0].mesh.mesh3js.getNode().getMatrixWorld();i.elements[14]=t.z;let r=(new e.Matrix4).multiplyMatrices(this.urban.USR.viewpoint.camera.matrixWorldInverse,i),a=-(new e.Vector3).getPositionFromMatrix(r).z;if(a<this.get("switchDistance")){let e=this.get("switchDistance")/a;s*=e,n*=e}}return[new e.Vector3(i.x-s/2,i.y-n,i.z),new e.Vector3(i.x+s/2,i.y-n,i.z),new e.Vector3(i.x-s/2,i.y,i.z),new e.Vector3(i.x-s/2,i.y-n,i.z),new e.Vector3(i.x+s/2,i.y,i.z),new e.Vector3(i.x-s/2,i.y,i.z),new e.Vector3(i.x+s/2,i.y-n,i.z),new e.Vector3(i.x+s/2,i.y,i.z)]}if(t=this.getBbox(),this.urban.showPrimBbox&&!this.renderedBbox){var i=(new e.Vector3).subVectors(t[7],t[0]);this.renderedBbox=s.drawCuboid(t[0],i.x,i.y,i.z)}var r=[];for(let e=0;e<t.length;e++){let i=this.urban.USR.viewpoint.getScreenPosition(t[e]);i.z>-1&&i.z<1&&r.push(i)}return r},getScreenAABbox:function(){var t=this.getBboxProjectedInScreen(),i=Math.min.apply(Math,t.map(e=>e.x)),r=Math.max.apply(Math,t.map(e=>e.x)),s=Math.min.apply(Math,t.map(e=>e.y)),n=Math.max.apply(Math,t.map(e=>e.y));if(!t.length)throw Error("No posSize available with web workers yet");return{min:new e.Vector2(i,s),max:new e.Vector2(r,n)}},drawDebugBbox:function(){this.getScreenAABbox()},eraseDebugBbox:function(){(s.is(this.renderedBbox)&&(this.urban.getView3D()._rootProjShifted.removeChild(this.renderedBbox),this.urban.getView3D()._rootProjShifted.removeChild(this.renderedBbox),delete this.renderedBbox),s.is(this.canvasBbox))&&this.canvasBbox.getContext("2d").clearRect(0,0,this.canvasBbox.width,this.canvasBbox.height)},getVerticalCameraAltitude:function(){return this._verticalCameraAltitude},setVisible:function(e){this._visible=e;for(var t=0;t<this._subMeshes.length;t++)if(this._subMeshes[t].mesh.isInstanceNode3D&&s.is(this._subMeshes[t].mesh.setVisible))this._subMeshes[t].mesh.setVisible(e,this.get("strid"));else{var i=this._subMeshes[t].subElement;i.sgNode&&(e?this._subMeshes[t].mesh.show([i]):this._subMeshes[t].mesh.hide([i]))}return this.urban.USR._forceRender(),this},setMaterial:function(e){var t,i=this._subMeshes;s.is(this._layer)&&(t=this.get("strid")||this.getSubMeshId(i),this.renderingProfileManager.addRendering(this._layer.parentFeatureID,e,t),this.getItemParent().temporary=!1)},getMaterial:function(){var e=this.get("strid")||this.getSubMeshId(this._subMeshes),t=this.getRendering();return s.is(t)?t.getCompleteMaterialInfo(e,this.userData):this.renderingProfileManager.getRenderingData(this._layer.parentFeatureID,e)},getSubMeshId:function(e){if(s.is(e)&&s.is(e[0])&&s.is(e[0].subElement)&&s.is(e[0].subElement.sgNode)&&s.is(e[0].subElement.sgNode.cgmId))return e[0].subElement.sgNode.cgmId},getFactory:function(){if(this._layer)return this._layer.getFactory()},get:function(e){var t,i,r=this.getRendering();return this.renderingProfileManager&&s.is(r)&&r.hasAttribute(e)?(i=this.getMaterial(),s.is(i)&&(t=i[e])):t=this._parent(e),t},setItemParent:function(e){var t=this,i=function(e){t.setVisible(e.get("visible"))};this._itemParent&&this._itemParent.removeEvent("onChange:visible",i),this._parent(e),this._itemParent&&this._itemParent.addEvent("onChange:visible",i)},setAttribute:function(t,i){if("color"===t&&(s.is(i)?i instanceof e.Color||(i=new e.Color(i)):i=new e.Color),this.get(t)!==i)return this.set(t,i),this;var r,n;for(r=0;r<this._subMeshes.length;r++)(n=this._subMeshes[r].mesh).setAttribute&&n.setAttribute(t,i,[this._subMeshes[r].subElement.sgNode]);return this},set:function(e,t){var i={},r=this.getRendering();this.renderingProfileManager&&s.is(r)&&r.hasAttribute(e)?(i[e]=t,this.setMaterial(i)):this._parent(e,t)},getRendering:function(){if(s.is(this._layer))return s.is(this.indexMesh)?this._layer.getRendering(this.indexMesh):this._layer.getRendering()},resetRenderingAttributes:function(){if(s.is(this.renderingProfileManager)&&s.is(this._layer)){var e=this._getStrid();this.renderingProfileManager.resetPrimitive(this._layer.parentFeatureID,e)&&(this.renderingProfileManager.updateGeomRenderings([this._layer]),this._layer.redrawPrimitive(e))}},resetRenderingAttribute:function(e){if(s.is(this.renderingProfileManager)&&s.is(this._layer)){var t=this._getStrid();this.renderingProfileManager.resetPrimitiveAttributeOnly(this._layer.parentFeatureID,t,e)&&(this.renderingProfileManager.updateGeomRenderings([this._layer]),this._layer.redrawPrimitive(t))}},_getStrid:function(){return this.get("strid")||this.getSubMeshId(this._subMeshes)},highlight:function(){if(this._layer&&this._layer._patch&&!this._layer._patch.previewMode){var e=XCityCoreStore.getStore(this._layer.id),t=this._layer._patch.miDToTile[this.get("strid")];if(t){var i=t.tile;if(i){var r=e._invertY?(1<<i.LOD)-1-i.J:i.J,n=s.getQuadKey(i.LOD,i.I,r);e.lockData(n)}}}},unhighlight:function(){if(this._layer&&this._layer._patch&&!this._layer._patch.previewMode){var e=XCityCoreStore.getStore(this._layer.id),t=this._layer._patch.miDToTile[this.get("strid")];if(t){var i=t.tile;if(i){var r=e._invertY?(1<<i.LOD)-1-i.J:i.J,n=s.getQuadKey(i.LOD,i.I,r);e.unlockData(n)}}}}});return r.addNewContextualMenu(function(e){return e.get("Content")instanceof n},[{name:"ContextualTreeview",line:1,hdr_list:["pTreeview"]},{name:"ContextualVisibility",line:1,hdr_list:["pVisibility"]},{name:"ContextualInfo",line:1,hdr_list:["pInfo"]},{name:"ContextualColor",line:1,hdr_list:["pColor"]},{name:"ContextualOpacity",line:1,hdr_list:["pOpacity"]}]),i.ObjectContructor.LayerVectorPrimitive=n}),define("DS/XCityGeometry/MarkerManager",["UWA/Core","UWA/Class","UWA/Class/Collection","DS/XCityGeometry/Marker","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/Visualization/ThreeJS_DS","css!DS/XCityGeometry/assets/style/marker.css"],function(e,t,i,r,s,n,a){"use strict";var o=null,l=t.extend({init:function(e){this._parent(e)},build:function(e){this.urban=e.urban,this._initEvents(),this._buildMarkersContainer(),this.computeCollision=!0,this.markerCollection=new i([],{model:r}),this.hiddenMarkerCollection=new i([],{model:r})},getMarkersContainer:function(){return this.markersContainer},_buildMarkersContainer:function(){this.markersContainer=new e.Element("div",{class:"xcity-markers-container"}).inject(this.urban.viewerContainer)},_initEvents:function(){n.subscribeTo(n.eventsList.pointOfView,this.render.bind(this)),n.subscribeTo("/VISU/onWindowResized",this.render.bind(this))},_updateMarkersPosition:function(){this.markerCollection.forEach(function(e){e._collidedFlag=!1,e.update2DPosition()}),this.hiddenMarkerCollection.forEach(function(e){e.get("visible")&&(e._collidedFlag=!1,e.update2DPosition())})},_updateMarkersVisibility:function(){this.markerCollection.forEach(function(e){e.updateVisibility()}),this.hiddenMarkerCollection.forEach(function(e){e.get("visible")&&e.updateVisibility()})},_computeCollision:function(){var e=this;this.markerCollectionSorted.forEach(function(t){e.markerCollectionSorted.forEach(function(e){if(t!==e&&!1===t._collidedFlag&&!1===e._collidedFlag){let i={width:30,height:30};t.position2D.x+i.width>e.position2D.x&&t.position2D.y+i.height>e.position2D.y&&t.position2D.x-i.width<e.position2D.x&&t.position2D.y-i.height<e.position2D.y&&!e.get("selected")&&!e._hovered&&(e._collidedFlag=!0)}})})},_computeDepth:function(){let e=this.markerCollectionSorted.length+1;var t=this.markerCollectionSorted.length+1;this.markerCollectionSorted.forEach(function(i,r){let s=t;i.get("selected")&&(s+=e),i._hovered&&(s+=e),i._visibleFlag&&i._markerContainer.setStyle("z-index",String(s)),t--})},_sortMarkersByDistance:function(){this.markerCollectionSorted=this.markerCollection.sortBy(function(e){return new a.Vector3(e.get("position").x,e.get("position").y,e.get("position").z).distanceTo(this.urban.getViewpoint().getPosition())}.bind(this))},onMarkerLayerLoaded:function(e){},render:function(){this._updateMarkersPosition(),this._sortMarkersByDistance(),this.computeCollision&&this._computeCollision(),this._computeDepth(),this._updateMarkersVisibility()}});return l.getInstance=function(){return null===o&&(o=new l),o},l.getInstance()}),define("DS/XCityModel/LayerVectorCluster",["DS/Visualization/ThreeJS_DS","DS/XCityModel/LayerVectorPrimitive","DS/XCityTools/Geocoder","DS/XCityModel/Item","DS/XCityModel/View3DContextualMenuManager","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/xCityBasicUtils/Utils","DS/XCityTools/Downloader","DS/XCityCore/Store"],function(e,t,i,r,s,n,a,o,l,h,d){"use strict";var u=t.extend({defaults:{clusterInfo:null},metaData:{type:"Geometry",className:"LayerVectorCluster"},setup:function(){this._parent(),this._bboxDisplayed=!1,this._bboxNode=null},setItemParent:function(e){var t=this,i=function(e){t.setVisible(e.get("visible"))};this._itemParent&&(this._itemParent.removeEvent("onChange:visible",i),this._itemParent.removeEvent("onChange:selected",this.displayBbox.bind(this)),this._itemParent.removeEvent("onChange:hovered",this.displayBbox.bind(this))),this._parent(e),this._itemParent&&(this._itemParent.addEvent("onChange:visible",i),this._itemParent.addEvent("onChange:selected",this.displayBbox.bind(this)),this._itemParent.addEvent("onChange:hovered",this.displayBbox.bind(this)))},create:function(t){this.created=this._parent(t);var i=xCity._urbanImpl.getView3D().getControl();this.initialPOV={target:i.target,direction:i.eye,distance:i.distanceToTarget};var r=this.get("instanceId"),s=this.get("clusterInfo");if(s.rtree){var n=(r-5)/5;s.rtree._root;this._rtreeNode=s.rtree.getNodeByInstanceId(n);var a,o=this._rtreeNode.getAllLeaves(),l=[];if(this._layer._patch._uidListeners)for(var d=0;d<o.length;++d)o[d].infos&&o[d].infos.strid&&(a=this._layer._patch._uidListeners[o[d].infos.strid],l.push(a.userData),l[l.length-1].position=a.posSize.center);this.userData=l;for(var u=[],c=0;c<this._subMeshes.length;++c)this._subMeshes[c].mesh.clusterInfo&&this._subMeshes[c].mesh.clusterInfo.isLeaf||u.push(this._subMeshes[c]);this._subMeshes=u,this._leaves=o,this._localPosition.x=(this._rtreeNode.boundingBox.max.x+this._rtreeNode.boundingBox.min.x)/2,this._localPosition.y=(this._rtreeNode.boundingBox.max.y+this._rtreeNode.boundingBox.min.y)/2,this._localSphereDiameter=2*this._rtreeNode.radius,this._bMin=this._rtreeNode.boundingBox.min,this._bMax=this._rtreeNode.boundingBox.max}else{var p=this._layer.get("url");p=(p=(p=(p=(p=p.replace("%l",s.LOD)).replace("%i",s.I)).replace("%x",s.I)).replace("%j",s.J)).replace("%y",s.J);h.download(p,{responseType:"json"},999999,function(e,t,i,r){r(t,e,i)},void 0,function(e,t,i){if(t&&e.features){for(var r=e,s=[],n=0;n<r.features.length;++n)r.features[n].properties&&(s.push(r.features[n].properties),s[s.length-1].position=r.features[n].geometry.coordinates);this.userData=s}}.bind(this)),this._bMin=new e.Vector3(s.qtClusterBbox.xmin,s.qtClusterBbox.ymin,0),this._bMax=new e.Vector3(s.qtClusterBbox.xmax,s.qtClusterBbox.ymax,0)}return!0},destroy:function(){this._layer&&(Utils.is(this._layer.getItemParent())&&this._layer.getItemParent().removeEvent("onChange:selected",this._deselectParent),this._layer.unregister(this)),this._layer=void 0,this._detachToMesh(),this._subMeshes=[],this._parent()},moveToInitial:function(e){var t=this.getLocalPosition();if(t&&this._rtreeNode.parent){var i=this._rtreeNode.parent.openDistance*this._rtreeNode.instance.distanceFactor*.75;return this._rtreeNode.nHits===this._rtreeNode.parent.nHits&&this._rtreeNode.parent.parent&&(i=this._rtreeNode.parent.parent.openDistance*this._rtreeNode.instance.distanceFactor*.75),xCity._urbanImpl.getView3D().getControl().moveTo(t.clone(),{x:0,y:45,z:0},i,e)}},moveToChildren:function(e){var t=this.getLocalPosition();if(t){var i=this._rtreeNode.openDistance*this._rtreeNode.instance.distanceFactor*.75;return xCity._urbanImpl.getView3D().getControl().moveTo(t.clone(),{x:0,y:45,z:0},i,e)}},moveToParent:function(e){var t=this.getLocalPosition();if(t&&this._rtreeNode.parent&&this._rtreeNode.parent.parent){var i=this._rtreeNode.parent.parent.openDistance*this._rtreeNode.instance.distanceFactor*.75;return this._rtreeNode.parent.nHits===this._rtreeNode.parent.parent.nHits&&this._rtreeNode.parent.parent.parent&&(i=this._rtreeNode.parent.parent.parent.openDistance*this._rtreeNode.instance.distanceFactor*.75),xCity._urbanImpl.getView3D().getControl().moveTo(t.clone(),{x:0,y:45,z:0},i,e)}},displayBbox:function(){var t=this._itemParent.get("selected")||this._itemParent.get("hovered");if(t&&!this._bboxDisplayed){var i=this.convexHull();if(void 0===i)return;var r=new e.MeshLambertMaterial({color:16711680,side:e.DoubleSide,transparent:!0,opacity:.5});r.force=!0;var s=this._bMin,l=this._bMax,h=new e.Vector3;h.subVectors(l,s),h.add(l);var d=new e.Shape(i),u=new e.ShapeGeometry(d),c=new e.Mesh(u),p=n.createNodeFromTHREEMesh(c);p.setMaterial(r);var f=new a;f.addChild(p),f.setMatrix((new e.Matrix4).setPosition(new e.Vector3(0,0,100))),f.setPickable(o.NOPICKABLE),f.isAreaCluster=!0,this._layer._node.addChild(f),this._bboxNode=f,this._bboxDisplayed=!0}else!t&&this._bboxDisplayed&&(this._layer._node.removeChild(this._bboxNode),this._bboxNode=null,this._bboxDisplayed=!1)},highlight:function(){var e=d.getStore(this._layer.id);if(e){var t=this.get("clusterInfo"),i=e._invertY?(1<<t.LOD)-1-t.J:t.J,r=l.getQuadKey(t.LOD,t.I,i);e.lockData(r)}},unhighlight:function(){var e=d.getStore(this._layer.id);if(e){var t=this.get("clusterInfo"),i=e._invertY?(1<<t.LOD)-1-t.J:t.J,r=l.getQuadKey(t.LOD,t.I,i);e.unlockData(r)}},getMinimumAbscisseNode:function(e){if(e.length>0){for(var t,i=e[0].center,r=0;r<e.length;++r)(t=e[r]).center.x<i.x&&(i=t.center);return i}},getMaximumAbscisseNode:function(e){if(e.length>0){for(var t,i=e[0].center,r=0;r<e.length;++r)(t=e[r]).center.x>i.x&&(i=t.center);return i}},computeAngle:function(e,t){return e>0&&t>=0?Math.atan(t/e):e>0&&t<0?Math.atan(t/e)+2*Math.PI:e<0?Math.atan(t/e)+Math.PI:0===e&&t>0?Math.PI/2:3*Math.PI/2},findNextPoint:function(e,t,i){for(var r,s,n,a,o=void 0,l=2*Math.PI-3*Math.PI/2,h=0;h<e.length;++h)e[h].center.x==t.x&&e[h].center.y==t.y||(s=e[h].center.x-t.x,n=e[h].center.y-t.y,a=this.computeAngle(s,n),(a=2*Math.PI-a-l)<0&&(a+=2*Math.PI),(void 0===o||a<o)&&(o=a,r=e[h]));return{x:r.center.x,y:r.center.y}},computeConvexHull:function(){for(var e=this.getMinimumAbscisseNode(this._leaves),t=this.getMaximumAbscisseNode(this._leaves),i=e,r=this.findNextPoint(this._leaves,i),s=[e,r],n=0;r.x!==t.x&&r.y!==t.y&&n<50;)r=this.findNextPoint(this._leaves,r),s.push(r),n++;for(n=0;r.x!==e.x&&r.y!==e.y&&n<50;)r=this.findNextPoint(this._leaves,r,!1),s.push(r),n++;return s},orientation:function(e,t,i){var r=(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y);return 0===r?0:r>0?1:2},convexHull:function(){var e=this._leaves.length;if(!(e<3)){for(var t=[],i=0,r=1;r<e;++r)this._leaves[r].center.x<this._leaves[i].center.x&&(i=r);var s,n,a=i;do{n=this._leaves[a].center,t.push(n),s=(a+1)%e;for(r=0;r<e;++r)2===this.orientation(this._leaves[a].center,this._leaves[r].center,this._leaves[s].center)&&(s=r);a=s}while(a!==i);return t.length<3?[]:t}}});return s.addNewContextualMenu(function(e){return e.get("Content")instanceof u},[{name:"ContextualTreeview",line:1,hdr_list:["pTreeview"]},{name:"ContextualVisibility",line:1,hdr_list:["pVisibility"]},{name:"ContextualInfo",line:1,hdr_list:["pInfo"]},{name:"ContextualColor",line:1,hdr_list:["pColor"]},{name:"ContextualOpacity",line:1,hdr_list:["pOpacity"]}]),r.ObjectContructor.LayerVectorCluster=u}),define("DS/XCityCoreUI/TimeControler",["UWA/Class","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/Controls/Gauge"],function(e,t,i,r){"use strict";return UWA.Class.extend({init:function(){this.container=new UWA.Element("div",{class:"xCity-time-slider-container"}),this.createSlider(),this.updateSlide(),this.initEvents()},createSlider:function(){this.slider=new r({minValue:0,maxValue:23,stepValue:1,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:24,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container)},updateSlide:function(){this.slider.getValue()!==xCity.date.getHours()&&this.slider.setValue(xCity.date.getHours())},initEvents:function(){i.subscribeTo(i.eventsList.date,this.updateSlide.bind(this)),this.slider.addEvent("change",function(){var e=this.getValue(),t=xCity.date;t.setHours(e),xCity.date=t})}})}),define("DS/XCityCore/ProfileManager",["UWA/Class/Events","UWA/Class","DS/XCityCore/Profile","DS/xCityBasicUtils/Utils","DS/XCityTools/Downloader"],function(e,t,i,r,s){"use strict";return t.extend(e,{init:function(e,t){this._urban=e,this._type=t,this._profiles={},this._profileCurrent=void 0,this.request=0,this.defaultProfile=void 0,this.defaultNewProfile="currentprofile"},getDefaultProfile:function(){return this.getProfile(this.defaultProfile)},setDefaultProfile:function(){this.setProfile(this.defaultProfile)},_initdefaultProfile:function(e){this._profileCurrent=this.getProfile(e),r.is(this._profileCurrent)||(this._profileCurrent=this.createProfile(e),this.dispatchAddedEvent(e)),this._profileCurrent.enable()},createProfile:function(e){var t=this._profiles[e];return t||(t=this._createProfile(this._urban,e),this._profiles[e]=t),t},getProfile:function(e){return this._profiles[e]},addProfile:function(e,t,i,s){var n=this.getProfile(e);r.is(n)||(n=this.createProfile(e),this.dispatchAddedEvent(e)),n.add(t,i,s),this.getCurrentProfileName()===e&&t(this._urban,i)},removeProfile:function(e,t,i){if(r.is(e)&&e!==this.defaultProfile){var s=this._profiles[e];if(r.is(s))if(t||i)s.remove(t,i);else{if(e===this.getCurrentProfileName()){var n=this.getProfileNames();if(r.is(n)&&n.length>0){var a=n[0];a===e&&(n.length>1?a=n[1]:r.is(this.defaultProfile)&&(a=this.defaultProfile)),this.setProfile(a)}}else this._profiles[e].disable();s.isRemovable()?(delete this._profiles[e],this.dispatchRemovedEvent(e)):(s.clean(),s.resetRender(this.urban,this._profiles[this.defaultProfile]))}}},setProfile:function(e,t){if(r.is(e)&&e!==this.getCurrentProfileName()){var i=this._profiles[e];if(i)return r.is(this._profileCurrent)&&this._profileCurrent.disable(),this._profileCurrent=i,i.enable(this._profileCurrent,t),!0}return!1},enable:function(e,t){var i=this._profiles[e];return!!i&&(i.enable(this._profileCurrent,t),this._profileCurrent=i,!0)},getProfileNames:function(){var e,t,i=[],s=Object.keys(this._profiles),n=s.length;for(t=0;t<n;t++)if((e=s[t])!==this.defaultProfile){var a=this._profiles[e];r.is(a)&&!a.isInternal()&&i.push(e)}return i},loadProfiles:function(e){if(this._parseProfile(e),0===this.request){this._profileToLoad=!1;var t=this.getCurrentProfile();r.is(t)&&!0===t._dirty&&this.setProfile(t.getName()),this.dispatchEvent("onProfilesLoaded",!0)}},_parseProfile:function(e){if(r.is(e))if(r.is(e.name))this._parseOneProfile&&this._parseOneProfile(e);else if(Array.isArray(e))for(var t=0;t<e.length;t++)this._parseProfile(e[t]);else if("object"==typeof e)for(var i in e)e.hasOwnProperty(i)&&this._parseProfile(e[i]);else if("string"==typeof e){var s=e;this._loadJSON(s)}},_loadJSON:function(e){this.request++;s.download(e,{responseType:"json"},999999,function(e,t,i,r){r(t,e,i)},void 0,function(t,i,s){if(i)try{var n=t;r.is(this._parseProfile)&&this._parseProfile(n)}catch(e){this.dispatchEvent("onProfilesLoaded",!1),console.error("Error while loading profiles: "+e.stack)}else this.dispatchEvent("onProfilesLoaded",!1),console.error("Could not parse profile  "+e),r.is(s)&&r.is(s.stack)&&console.error(s.stack);if(this.request--,0===this.request){this._profileToLoad=!1;var a=this.getCurrentProfile();r.is(a)&&!0===a._dirty&&this.setProfile(a.getName()),this.dispatchEvent("onProfilesLoaded",!0)}}.bind(this))},getCurrentProfileName:function(){if(r.is(this._profileCurrent)&&!this._profileCurrent.isInternal())return this._profileCurrent.getName();return""},getCurrentProfile:function(){return this.getProfile(this.getCurrentProfileName())},_getNewProfileDefaultName:function(e){var t=this.defaultNewProfile;r.is(e)&&(t=e);for(var i=1,s=t+"_"+i;r.is(this.getProfile(s));)s=t+"_"+ ++i;return s},renameProfile:function(e,t){if(this.getProfile(t))return!1;var i=this.getProfile(e);return!!r.is(i)&&(this._profiles[t]=this._profiles[e],i.setName(t),this._profiles[e]=void 0,!0)},reset:function(){var e,t,i=this.getProfileNames();for(e=0,t=i.length;e<t;++e)this.removeProfile(i[e])}})}),define("DS/XCityCoreUI/AtmosphereControler",["UWA/Class","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/Controls/Gauge","DS/Controls/Button","DS/Controls/Toggle","DS/Controls/ButtonGroup"],function(e,t,i,r,s,n,a){"use strict";return UWA.Class.extend({init:function(){this.container=new UWA.Element("div",{class:"xCity-atmo-slider-container"}),new UWA.Element("h4",{text:"Select a mode :"}).inject(this.container),this.modeGroup=new a({type:"radio"}),this.modeGroup.addChild(new n({type:"radio",label:"Off",value:2,checkFlag:!0})),this.modeGroup.addChild(new n({type:"radio",label:"Basic",value:0})),this.modeGroup.addChild(new n({type:"radio",label:"Advanced",value:1})),this.modeGroup.inject(this.container),this.modeID=this.modeGroup.value[0],new UWA.Element("h6",{text:"Presets :"}).inject(this.container),this.presetGroup=new a({type:"radio"}),this.presetGroup.addChild(new n({type:"radio",label:"Sunny",value:0,checkFlag:!0})),this.presetGroup.addChild(new n({type:"radio",label:"Light pollution",value:1})),this.presetGroup.addChild(new n({type:"radio",label:"Light Fog",value:2})),this.presetGroup.addChild(new n({type:"radio",label:"Heavy Fog",value:3})),this.presetGroup.addChild(new n({type:"radio",label:"Custom",value:4,disabled:!0})),this.presetGroup.inject(this.container),this.presetSelect=0;var e={turbidity:xCity._urbanImpl.environment.presetList[0].turbidity,reileigh:xCity._urbanImpl.environment.presetList[0].reileigh,mieCoefficient:xCity._urbanImpl.environment.presetList[0].mieCoefficient,mieDirectionalG:xCity._urbanImpl.environment.presetList[0].mieDirectionalG,density:xCity._urbanImpl.environment.presetList[0].density};xCity._urbanImpl.environment.skyParams=e,this._atmosphere=xCity._urbanImpl.getView3D().getAtmosphereEffect(),this.createSliders(),this.initButtonEvent(),this.initSlidersEvent(),this.updateSlide()},createSliders:function(){2==this.modeID?(this._atmosphere.disableEffect(),this.turbidityLabel&&this.turbidityLabel.destroy(),this.mieCLabel&&this.mieCLabel.destroy(),this.mieGLabel&&this.mieGLabel.destroy(),this.densityLabel&&this.densityLabel.destroy(),this.rayleighLabel&&this.rayleighLabel.destroy(),this.sliderTurbidity&&this.sliderTurbidity.destroy(),this.sliderRayleigh&&this.sliderRayleigh.destroy(),this.sliderMieG&&this.sliderMieG.destroy(),this.sliderMieCoefficient&&this.sliderMieCoefficient.destroy(),this.sliderDensity&&this.sliderDensity.destroy(),this.weatherLabel&&this.weatherLabel.destroy(),this.intensityLabel&&this.intensityLabel.destroy(),this.densityLabelEasy&&this.densityLabelEasy.destroy(),this.sliderDensityEasy&&this.sliderDensityEasy.destroy(),this.sliderWeather&&this.sliderWeather.destroy(),this.sliderIntensity&&this.sliderIntensity.destroy()):0==this.modeID?(this._atmosphere.enableEffect(),this.turbidityLabel&&this.turbidityLabel.destroy(),this.mieCLabel&&this.mieCLabel.destroy(),this.mieGLabel&&this.mieGLabel.destroy(),this.densityLabel&&this.densityLabel.destroy(),this.rayleighLabel&&this.rayleighLabel.destroy(),this.sliderTurbidity&&this.sliderTurbidity.destroy(),this.sliderRayleigh&&this.sliderRayleigh.destroy(),this.sliderMieG&&this.sliderMieG.destroy(),this.sliderMieCoefficient&&this.sliderMieCoefficient.destroy(),this.sliderDensity&&this.sliderDensity.destroy(),this.weatherLabel=new UWA.Element("h6",{text:"Weather :"}).inject(this.container),this.sliderWeather=new r({minValue:0,maxValue:1,stepValue:.01,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:10,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.intensityLabel=new UWA.Element("h6",{text:"Intensity :"}).inject(this.container),this.sliderIntensity=new r({minValue:0,maxValue:1,stepValue:.01,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:10,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.densityLabelEasy=new UWA.Element("h6",{text:"Density :"}).inject(this.container),this.sliderDensityEasy=new r({minValue:0,maxValue:1,stepValue:.01,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:10,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container)):(this._atmosphere.enableEffect(),this.weatherLabel.destroy(),this.intensityLabel.destroy(),this.densityLabelEasy.destroy(),this.sliderDensityEasy.destroy(),this.sliderWeather.destroy(),this.sliderIntensity.destroy(),this.turbidityLabel=new UWA.Element("h6",{text:"Turbidity :"}).inject(this.container),this.sliderTurbidity=new r({minValue:1,maxValue:20,stepValue:.1,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:20,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.rayleighLabel=new UWA.Element("h6",{text:"Rayleigh coefficient:"}).inject(this.container),this.sliderRayleigh=new r({minValue:.1,maxValue:4,stepValue:.01,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:5,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.mieCLabel=new UWA.Element("h6",{text:"Mie coefficient :"}).inject(this.container),this.sliderMieCoefficient=new r({minValue:0,maxValue:.1,stepValue:1e-4,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:10,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.mieGLabel=new UWA.Element("h6",{text:"Mie direction :"}).inject(this.container),this.sliderMieG=new r({minValue:-.95,maxValue:-.7,stepValue:.01,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:26,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.densityLabel=new UWA.Element("h6",{text:"Density :"}).inject(this.container),this.sliderDensity=new r({minValue:0,maxValue:1,stepValue:.01,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:11,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container))},updateSlide:function(){2!=this.modeID&&(0==this.modeID?(this.sliderWeather.setValue(xCity._urbanImpl.environment.skyParams.turbidity/20),this.sliderIntensity.setValue(xCity._urbanImpl.environment.skyParams.reileigh/4),this.sliderDensityEasy.setValue(xCity._urbanImpl.environment.skyParams.density)):(this.sliderTurbidity.getValue()!==xCity._urbanImpl.environment.skyParams.turbidity&&this.sliderTurbidity.setValue(xCity._urbanImpl.environment.skyParams.turbidity),this.sliderRayleigh.getValue()!==xCity._urbanImpl.environment.skyParams.reileigh&&this.sliderRayleigh.setValue(xCity._urbanImpl.environment.skyParams.reileigh),this.sliderMieCoefficient.getValue()!==xCity._urbanImpl.environment.skyParams.mieCoefficient&&this.sliderMieCoefficient.setValue(xCity._urbanImpl.environment.skyParams.mieCoefficient),this.sliderMieG.getValue()!==xCity._urbanImpl.environment.skyParams.mieDirectionalG&&this.sliderMieG.setValue(xCity._urbanImpl.environment.skyParams.mieDirectionalG),this.sliderDensity.getValue()!==xCity._urbanImpl.environment.skyParams.density&&this.sliderDensity.setValue(xCity._urbanImpl.environment.skyParams.density)))},initButtonEvent:function(){var e=this;this.modeGroup.addEventListener("change",function(t){e.modeID=t.dsModel.value[0],e.createSliders(),e.initSlidersEvent(),e.updateSlide(),e.presetGroup.getButtonFromValue(e.presetSelect).checkFlag=!0,console.log(e.presetSelect)}),this.presetGroup.addEventListener("change",function(t){if(4!==t.dsModel.value[0]){var i={turbidity:xCity._urbanImpl.environment.presetList[t.dsModel.value[0]].turbidity,reileigh:xCity._urbanImpl.environment.presetList[t.dsModel.value[0]].reileigh,mieCoefficient:xCity._urbanImpl.environment.presetList[t.dsModel.value[0]].mieCoefficient,mieDirectionalG:xCity._urbanImpl.environment.presetList[t.dsModel.value[0]].mieDirectionalG,density:xCity._urbanImpl.environment.presetList[t.dsModel.value[0]].density};xCity._urbanImpl.environment.skyParams=i,e.presetSelect=t.dsModel.value[0]}e.updateSlide()})},initSlidersEvent:function(){var e=this;2!=this.modeID&&(0==this.modeID?(this.sliderWeather.addEvent("change",function(){var t=this.getValue(),i=20*t,r=.1*t;4!==e.presetGroup.value[0]&&i!==xCity._urbanImpl.environment.presetList[e.presetGroup.value[0]].turbidity&&(e.presetGroup.getButtonFromValue(4).checkFlag=!0),xCity._urbanImpl.environment.skyParams.turbidity=i,xCity._urbanImpl.environment.skyParams.mieCoefficient=r}),this.sliderIntensity.addEvent("change",function(){var t=this.getValue(),i=4*t,r=.25*t-.95;4!==e.presetGroup.value[0]&&i!==xCity._urbanImpl.environment.presetList[e.presetGroup.value[0]].reileigh&&(e.presetGroup.getButtonFromValue(4).checkFlag=!0),xCity._urbanImpl.environment.skyParams.reileigh=i,xCity._urbanImpl.environment.skyParams.mieDirectionalG=r}),this.sliderDensityEasy.addEvent("change",function(){var t=this.getValue();4!==e.presetGroup.value[0]&&t!==xCity._urbanImpl.environment.presetList[e.presetGroup.value[0]].density&&(e.presetGroup.getButtonFromValue(4).checkFlag=!0),xCity._urbanImpl.environment.skyParams.density=t})):(this.sliderTurbidity.addEvent("change",function(){var t=this.getValue();4!==e.presetGroup.value[0]&&t!==xCity._urbanImpl.environment.presetList[e.presetGroup.value[0]].turbidity&&(e.presetGroup.getButtonFromValue(4).checkFlag=!0),xCity._urbanImpl.environment.skyParams.turbidity=t}),this.sliderRayleigh.addEvent("change",function(){var t=this.getValue();4!==e.presetGroup.value[0]&&t!==xCity._urbanImpl.environment.presetList[e.presetGroup.value[0]].reileigh&&(e.presetGroup.getButtonFromValue(4).checkFlag=!0),xCity._urbanImpl.environment.skyParams.reileigh=t}),this.sliderMieG.addEvent("change",function(){var t=this.getValue();4!==e.presetGroup.value[0]&&t!==xCity._urbanImpl.environment.presetList[e.presetGroup.value[0]].mieDirectionalG&&(e.presetGroup.getButtonFromValue(4).checkFlag=!0),xCity._urbanImpl.environment.skyParams.mieDirectionalG=t}),this.sliderMieCoefficient.addEvent("change",function(){var t=this.getValue();4!==e.presetGroup.value[0]&&t!==xCity._urbanImpl.environment.presetList[e.presetGroup.value[0]].mieCoefficient&&(e.presetGroup.getButtonFromValue(4).checkFlag=!0),xCity._urbanImpl.environment.skyParams.mieCoefficient=t}),this.sliderDensity.addEvent("change",function(){var t=this.getValue();4!==e.presetGroup.value[0]&&t!==xCity._urbanImpl.environment.presetList[e.presetGroup.value[0]].density&&(e.presetGroup.getButtonFromValue(4).checkFlag=!0),xCity._urbanImpl.environment.skyParams.density=t})))}})}),define("DS/XCityCoreUI/CloudsControler",["UWA/Class","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/Controls/Gauge","DS/Controls/Button","DS/Controls/Toggle","DS/Controls/ButtonGroup"],function(e,t,i,r,s,n,a){"use strict";return UWA.Class.extend({init:function(){this.container=new UWA.Element("div",{class:"xCity-clouds-slider-container"}),this.coverageLabel=new UWA.Element("h6",{text:"Clouds :"}).inject(this.container),this.cloudsOn=new a({type:"radio"}),this.cloudsOn.addChild(new n({type:"radio",label:"On",value:0})),this.cloudsOn.addChild(new n({type:"radio",label:"Off",value:1,checkFlag:!0})),this.cloudsOn.inject(this.container),this.createSliders(),this.initButtonEvent(),this.initSlidersEvent(),this.updateSlide()},createSliders:function(){this.coverageLabel=new UWA.Element("h6",{text:"Coverage :"}).inject(this.container),this.sliderCoverage=new r({minValue:0,maxValue:1,stepValue:.01,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:10,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.heightLabel=new UWA.Element("h6",{text:"Height :"}).inject(this.container),this.sliderHeight=new r({minValue:0,maxValue:500,stepValue:1,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:6,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.thicknessLabel=new UWA.Element("h6",{text:"Thickness :"}).inject(this.container),this.sliderThickness=new r({minValue:0,maxValue:300,stepValue:1,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:10,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.aspectLabel=new UWA.Element("h6",{text:"Aspect :"}).inject(this.container),this.sliderAspect=new r({minValue:0,maxValue:1,stepValue:.01,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:10,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.shapeLabel=new UWA.Element("h6",{text:"Shape :"}).inject(this.container),this.sliderShape=new r({minValue:.001,maxValue:.01,stepValue:1e-4,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:10,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.directionLabel=new UWA.Element("h6",{text:"Wind direction :"}).inject(this.container),this.sliderDirection=new r({minValue:-180,maxValue:180,stepValue:1,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:36,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.speedLabel=new UWA.Element("h6",{text:"Wind speed :"}).inject(this.container),this.sliderSpeed=new r({minValue:0,maxValue:1,stepValue:.001,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:10,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container)},updateSlide:function(){this.sliderCoverage.getValue()!==xCity._urbanImpl.environment.cloudsParams.coverage&&this.sliderCoverage.setValue(xCity._urbanImpl.environment.cloudsParams.coverage),this.sliderHeight.getValue()!==xCity._urbanImpl.environment.cloudsParams.height&&this.sliderHeight.setValue(xCity._urbanImpl.environment.cloudsParams.height),this.sliderThickness.getValue()!==xCity._urbanImpl.environment.cloudsParams.thickness&&this.sliderThickness.setValue(xCity._urbanImpl.environment.cloudsParams.thickness),this.sliderAspect.getValue()!==xCity._urbanImpl.environment.cloudsParams.aspect&&this.sliderAspect.setValue(xCity._urbanImpl.environment.cloudsParams.aspect),this.sliderShape.getValue()!==xCity._urbanImpl.environment.cloudsParams.shape&&this.sliderShape.setValue(xCity._urbanImpl.environment.cloudsParams.shape),this.sliderSpeed.getValue()!==xCity._urbanImpl.environment.cloudsParams.windSpeed&&this.sliderSpeed.setValue(xCity._urbanImpl.environment.cloudsParams.windSpeed)},initButtonEvent:function(){var e=this;this.cloudsOn.addEventListener("change",function(t){e.buttonClicked=t.dsModel.value[0],e.cloudsOn.getButtonFromValue(e.buttonClicked).checkFlag=!0,0==e.buttonClicked?xCity._urbanImpl.environment.cloudsParams.on=!0:xCity._urbanImpl.environment.cloudsParams.on=!1})},initSlidersEvent:function(){this.sliderCoverage.addEvent("change",function(){var e=this.getValue();xCity._urbanImpl.environment.cloudsParams.coverage=e}),this.sliderThickness.addEvent("change",function(){var e=this.getValue();xCity._urbanImpl.environment.cloudsParams.thickness=e}),this.sliderHeight.addEvent("change",function(){var e=this.getValue();xCity._urbanImpl.environment.cloudsParams.height=e}),this.sliderAspect.addEvent("change",function(){var e=this.getValue();xCity._urbanImpl.environment.cloudsParams.aspect=e}),this.sliderShape.addEvent("change",function(){var e=this.getValue();xCity._urbanImpl.environment.cloudsParams.shape=e}),this.sliderDirection.addEvent("change",function(){var e=this.getValue()*(Math.PI/180),t=Math.cos(e),i=Math.sin(e),r=new THREE.Vector3(t,0,i);xCity._urbanImpl.environment.cloudsParams.windDirection=r}),this.sliderSpeed.addEvent("change",function(){var e=this.getValue();xCity._urbanImpl.environment.cloudsParams.windSpeed=e})}})}),define("DS/XCityGeometry/PatchVectorFactoryPolygonGeometry",["UWA/Core","DS/XCityGeometry/PatchVectorFactory","DS/XCityGeometry/Label","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t,i,r,s){"use strict";return t.extend({init:function(e,t,i){this._parent(e,t,i)},_computeAltitudeToApply:function(e,t){var i=0;return i=Utils.is(t[0].z)&&"geometry"===e.elevationMode?t[0].z:"advanced"===e.elevationMode||"geometry"===e.elevationMode?e.elevation:this.urban.USR.getGroundHeight(t[0].x,t[0].y),e.elevationOffset&&(i+=e.elevationOffset),i},_generateLabel:function(e,t,r,s,n,a,o){var l=void 0,h=!1;return Utils.is(this._node.userData)&&(h=!0,l=this._node.userData._attributes.id),this.labelManagerVisibility||(this.labelManagerVisibility=!0,this._node.userData.addEvent("onChange:visible",this.urban.labelManager.onChangeVisibility,this)),r.name="POLYGON",i.generateTextNode(this.urban,r,s,e,"polygon",void 0,t,l,h,void 0,a,o)}})}),define("DS/XCityLoaders/StreamVisuV1Loader",["DS/Visualization/StreamVisuLoader","DS/Visualization/ThreeJS_DS","DS/XCityLoaders/ModelLoader","DS/XCityLoaders/StreamVisuLoader","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s){"use strict";var n=r.extend({init:function(t,i){this._parent(t,i),this.loader=new e},_generateObjectToLoad:function(){this.model.node.isCoreReady=!1;var e={url:this.baseURL,urlOptions:this.model.urlOptions,destinationNode:this.model.node,nodeCallback:this._nodeCallback,doneCallback:function(e){this.model.node.isCoreReady=!0,this._doneCallback()}.bind(this),imageCallback:this._loadTexture.bind(this)};return this._addCustomShaders(e),e},_loadTexture:function(e,i){var r=this.baseURL.substring(0,this.baseURL.lastIndexOf("/"))+"/";r+=e.path,i.urlOptions&&(r+=i.urlOptions);var s=t.ImageUtils.loadTexture(r,null,null,null,!0);return s.wrapS=e.wrapS||1e3,s.wrapT=e.wrapT||1e3,s.anisotropy=e.anisotropy||8,s.minFilter=e.minFilter||1008,s.magFilter=e.magFilter||1006,s.repeat=e.repeat||{x:1,y:1},s.sRGB="jpg"===e.format||"jpeg"===e.format,s}});return i.formatLoaders.json=n,n}),define("DS/XCityRendering/BuildingTdbStore",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityRendering/BuildingTdbAtlas","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader"],function(e,t,i,r,s,n,a){"use strict";return e.extend({init:function(e,r,s){this.urban=e,this.webWorkersParams=s,this.store={},this.storeLimit=5,this.timeStamp=0,this.inProcessDL=0,this.maxAllowedDL=1,this.DLQueue=[],this.defaultMode=!1,this.callbackList={},this.atlasBaseURL=void 0,this.store.default=new i(this.urban,"default",this.webWorkersParams),a.loadTexture(function(e){e&&(e.wrapS=t.RepeatWrapping,e.wrapT=t.RepeatWrapping,this.store.default._defineTextureAs(e,"atlasTexture",t.RepeatWrapping),this.store.default._defineTextureAs(e,"atlasInfoTexture",t.ClampToEdgeWrapping,t.NearestFilter,!1,!1),this.store.default.loaded=!0)}.bind(this),r),this.pollTiming=200,this.pollTimeOut=setTimeout(this._pollQueue.bind(this),this.pollTiming),this.cleanupTiming=2e3,this.cleanTimeOut=setTimeout(this._cleanupStore.bind(this),this.cleanupTiming),n.subscribeTo("/3DEXPERIENCity/onUpdate",this.update.bind(this))},dispose:function(){for(var e in s.warn("Dispose: TdbStore"),clearTimeout(this.pollTimeOut),clearTimeout(this.cleanTimeOut),this.pollTimeOut=void 0,this.cleanTimeOut=void 0,this.DLQueue=[],this.callbackList={},this.store)if(this.store.hasOwnProperty(e)){var t=this.store[e];t.material&&t.material.shared>1?(s.log("save tdb from darkness "),s.info(t.name,"  -  Material stil in use (",t.material.shared,")")):(s.info("Delete TDB: ",t.name),t.dispose(),t=void 0,delete this.store[e])}this.store={}},setUrls:function(e){this.atlasBaseURL=e},update:function(e){this.timeStamp=e},_displayStore:function(){for(var e in s.log("TDB store content: "),this.store)this.store.hasOwnProperty(e)&&s.log("   -  ",e);s.log("---------------------------------------")},getTDB:function(e){var t=this.store[e];return null!=t?this._touch(t):t},getOrDownloadData:function(e,t,r){if("default"!==e&&void 0===this.atlasBaseURL)return s.error("Default TDB not asked and no base URL defined..."),void 0!==r&&r(null),null;if(void 0===this.store[e])this.webWorkersParams?this.store[e]=new i(this.urban,e,this.webWorkersParams):this.store[e]=new i(this.urban,e,"wall");else if(null===this.store[e])return void 0!==r&&r(this.store.default),this.store.default;var n=this._touch(this.store[e]);return!n.pendingDL&&n.loaded?(void 0!==r&&r(n),n):(void 0===this.callbackList[e]&&(this.callbackList[e]=[]),n.pendingDL||this.load(e,t,!1),void 0!==r&&r(n),n)},load:function(e,t,i){if(i){this.inProcessDL+=1;this.requestData(e,function(t,i){this.inProcessDL-=1,!0===i&&void 0!==this.store[e]&&void 0!==t&&t.loaded?(this.store[e]=this._touch(t),this.store[e].pendingDL=!1):(s.warn(e+" not added to visuStore"),null!==this.store[e]&&void 0!==this.store[e]&&this.store[e].dispose(),this.store[e]=null);var r=this.callbackList[e];if(void 0!==r){for(var n=0;n<r.length;++n){var a=r[n];setTimeout(a(this.store[e]),5*n)}delete this.callbackList[e]}}.bind(this))}else{var r=this.store[e];if(r.pendingDL)return void this._touch(r);r.pendingDL=!0,this.DLQueue.push({tdbName:e,timeStamp:t})}},requestData:function(e,t){if(r.is(this.atlasBaseURL)){var i=this.atlasBaseURL;i=(i=a.resolveUrl(i)).replace("%a",e),this.store[e].loadAtlas(i,function(i){i?t(this.store[e],!0):t(void 0,!1)}.bind(this))}},_touch:function(e){return e.timeStamp=this.timeStamp,e},_pollQueue:function(){for(var e=Math.min(this.DLQueue.length,this.maxAllowedDL-this.inProcessDL),t=this.DLQueue.splice(0,e),i=0;i<t.length;i++)this.load(t[i].tdbName,t[i].timeStamp,!0);this.pollTimeOut=setTimeout(this._pollQueue.bind(this),this.pollTiming)},_cleanupStore:function(){var e=[];for(var t in this.store)null!==this.store[t]&&(this.store[t].name=t,"default"!==t&&e.push(this.store[t]));if(e.length>this.storeLimit){s.log("destroying..."),e.sort(function(e,t){return t.timeStamp-e.timeStamp});var i=e.pop();i.material&&i.material.shared>1?(s.log("save tdb from darkness "),s.info(i.name,"  -  Material stil in use (",i.material.shared,")")):(s.info("Delete TDB: ",i.name),i.dispose(),delete this.store[i.name],i=void 0)}this.cleanTimeOut=setTimeout(this._cleanupStore.bind(this),this.cleanupTiming)}})}),define("DS/XCityLoaders/ColladaParser",["DS/Mesh/MeshUtils","DS/Visualization/Mesh3D","DS/Visualization/SceneGraphConverter","DS/Visualization/ThreeJS_DS","DS/XCityTools/Disposer","DS/XCityTools/Downloader","DS/XCityTools/EventDispatcher","DS/XCityTools/ShaderTools","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s,n,a,o,l){"use strict";return UWA.Class.extend({init:function(e,t,i){this.urban=e,this.collada=t,this.model=i,this.whitetexture=new r.DataTexture(new Float32Array([1,1,1,1]),1,1,r.RGBAFormat,r.FloatType),this.whitetexture.name="DefaultWhiteTexture",this.whitetexture.flipY=!1,this.whitetexture.minFilter=r.LinearFilter,this.whitetexture.magFilter=r.LinearFilter,this.whitetexture.generateMipmaps=!1,this.whitetexture.needsUpdate=!0,this.whitetexture.shared=-1,this.whitetexture.image.complete=!0},parse:function(){return this._daeLoadCallback(this.collada)},_daeLoadCallback:function(e){var t=e.scene;if(void 0!==t){var i=this._selectChildsMaterialsStructure(t),r=this._computeBboxScene(t);this.model.bbox=r,this._applyShaderOnMaterials(i);var s=this._createSceneGraphConverterNode(t);return this._applyShadows(s),this._applyMeshSetter(s),e.scene=void 0,e.dae=void 0,s}},_createSceneGraphConverterNode:function(e){return new i(this.urban.USR.webGLV6Viewer.getWebGLContext(),e,this.urban.USR.webGLV6Viewer.getRootNode()).getRootNode()},_applyMeshSetter:function(i){var r=function(e,t){var i=this.mesh3js.material.color.clone();return this.mesh3js.material.color.copy(e),this.mesh3js.material.ambient.copy(e),i},s=function(e,t){var i=this.mesh3js.material.opacity;return this.mesh3js.material.transparent=1!==e,this.mesh3js.material.opacity=e,i};i.traverse(function(i){i instanceof t&&(i.setPickable(e.PICKABLE),i.setColor=r,i.setOpacity=s,this.model.color&&i.setColor(this.model.color))}.bind(this))},_applyShadows:function(e){void 0!==this.model.shadow&&e.traverse(function(e){this._setShadow(e,this.model.shadow)}.bind(this))},_applyShaderOnMaterials:function(e){for(var t in e)e.hasOwnProperty(t)&&this._changeShader(e[t],this.model)},_computeBboxScene:function(e){var t={min:new r.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),max:new r.Vector2(Number.MIN_VALUE,Number.MIN_VALUE)};return e.traverse(function(e){var i=e.boundingBox;null!=i&&(t.min.x=Math.min(t.min.x,i.min.x),t.min.y=Math.min(t.min.y,i.min.y),t.max.x=Math.max(t.max.x,i.max.x),t.max.y=Math.max(t.max.y,i.max.y))}.bind(this)),t},_selectChildsMaterialsStructure:function(e){var t={};return e.traverse(function(e){this._isTransparent(e),e instanceof r.Mesh&&e.material&&(void 0===t[e.material.id]&&(t[e.material.id]=[]),t[e.material.id].push(e),e.geometry.dynamic=!1)}.bind(this)),t},_isTransparent:function(e){return e instanceof r.Mesh&&void 0!==e.material&&{t:e.material.transparent,b:e.material.blending}},_changeShader:function(e,t){var i,h,d,u,c,p,f=e[0].material,m=f.map,g=this,v=function(e,t){null!=t&&(t.image.complete?f.map=t:(f.map=g.whitetexture,t.onLoadCallbacks.push(function(){f.map=t,o.updateCommonUniforms(f)})),o.updateCommonUniforms(f))},_=function(e,i,s,n){n&&(s.minFilter=r[i.minFilter]||r.LinearMipMapLinearFilter,s.magFilter=r[i.magFilter]||r.LinearMipMapLinearFilter,s.wrapS=s.wrapT=r[i.wrapMode]||r.ClampToEdgeWrapping),this.urban.getView3D().getProfileRendering().removeProfile(e,this.whitetexture),this.urban.getView3D().getProfileRendering().addProfile(e,v,s,t.name)};if(t.shader&&"default"!==t.shader.name){var y,b=[o.common];if("building"===t.shader.name)b.push(o.vertexInformation),b.push(o.clipPlanes),b.push(o.map),b.push(o.alphaTest),void 0!==t.shader.uniforms&&(t.shader.uniforms.normalMap&&b.push(o.normalMap),t.shader.uniforms.specularMap&&b.push(o.specularMap)),b.push(o.urbanLights),b.push(o.shadowMapCustom);else if(t.shader.chunk)for(y=0;y<t.shader.chunk.length;++y)b.push(o[t.shader.chunk[y]]);var x=o.getCustomShaderMaterial(b);for(x.name="model_"+t.shader.name+"_material",x.side=f.side,t.shader.color?x.color=new r.Color(t.shader.color):x.color=new r.Color("#FFFFFF"),x.opacity=f.opacity,x.ambient=f.ambient,x.emissive=f.emissive,x.shininess=f.shininess,x.transparent=f.transparent,o.updateCommonUniforms(x),y=0;y<e.length;y++)e[y].material.dispose&&e[y].material.dispose(),e[y].material=x;x.map=m,f=x}if(f.shared=e.length,l.is(f.uniforms)&&(void 0!==f.uniforms.bbox_min&&(f.uniforms.bbox_min.value=t.bbox.min),void 0!==f.uniforms.bbox_max&&(f.uniforms.bbox_max.value=t.bbox.max)),t.shader&&t.shader.maps)for(p in t.shader.maps)t.shader.maps.hasOwnProperty(p)&&(void 0!==(i=t.shader.maps[p]).url&&""!==i.url?h=i.url:void 0!==i.tile&&void 0!==i.layerName&&""!==i.layerName&&(d=i.tile,u=i.layerName,this.urban.getLayerRoot().findChildByName(u)?c=this.urban.getLayerRoot().findChildByName(u).get("Content"):this.urban._dataModelPrivate.findChildByName(u)&&(c=this.urban._dataModelPrivate.findChildByName(u).get("Content")),c?(h=c.get("url"),c.get("invertY")):h=u,h=(h=n.resolveUrl(h)).replace("%l",d.lvl).replace("%x",d.x).replace("%y",d.y)),n.loadTexture(_.bind(this,p,i.options||{}),h));if(void 0===f.observers&&(f.observers=[]),f.observers.push(function(e){e.map&&"DefaultWhiteTexture"===e.map.name&&s.disposeV6(m)}),f.normalMap||f.specularMap){var C=function(e,t){var i=m.sourceFile.replace("_df","_"+t).replace("_op","_"+t).replace(".png",".jpg");n.loadTexture(function(t,i){i&&(t.minFilter=r.LinearMipMapLinearFilter,t.magFilter=r.LinearFilter,t.wrapS=t.wrapT=r.RepeatWrapping,f[e]=t,o.updateCommonUniforms(f))},i)};f.normalMap&&(C("normalMap","nm"),a.subscribeTo("/3DEXPERIENCity/onUpdate",function(e){void 0!==e.normalMap&&"DefaultWhiteTexture"!==e.normalMap.name&&(this.useNormalMap?e.uniforms.use_normalMap.value=1:e.uniforms.use_normalMap.value=0,e.needsUpdate=!0)}.bind(this.urban,f))),f.specularMap&&(C("specularMap","sp"),a.subscribeTo("/3DEXPERIENCity/onUpdate",function(e){void 0!==e.specularMap&&"DefaultWhiteTexture"!==e.specularMap.name&&(this.useSpecularMap?e.uniforms.use_specularMap.value=1:e.uniforms.use_specularMap.value=0,e.needsUpdate=!0)}.bind(this.urban,f)))}},_setShadow:function(e,i){e instanceof t&&e.setShadow(i,i)}})}),define("DS/XCityCoreUI/PbrControler",["UWA/Class","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/Controls/Gauge","DS/Controls/Button","DS/Controls/Toggle","DS/Controls/ButtonGroup","DS/Controls/SpinBox"],function(e,t,i,r,s,n,a,o){"use strict";return UWA.Class.extend({init:function(){this.container=new UWA.Element("div",{html:'<div class="xct-title">Colors</div><div class="xct-parameter"><div class="xct-label">Albedo / Diffuse</div><div id="albedoInput" class="xct-input"><div class="xct-horizontal xct-one-third"><div class="xct-label xct-sublabel">R:</div><div id="albedoRInput"></div></div><div class="xct-horizontal xct-one-third"><div class="xct-label xct-sublabel">G:</div><div id="albedoGInput"></div></div><div class="xct-horizontal xct-one-third"><div class="xct-label xct-sublabel">B:</div><div id="albedoBInput"></div></div></div></div><div class="xct-parameter"><div class="xct-label">Ambient</div><div id="ambientInput" class="xct-input"><div class="xct-horizontal xct-one-third"><div class="xct-label xct-sublabel">R:</div><div id="ambientRInput"></div></div><div class="xct-horizontal xct-one-third"><div class="xct-label xct-sublabel">G:</div><div id="ambientGInput"></div></div><div class="xct-horizontal xct-one-third"><div class="xct-label xct-sublabel">B:</div><div id="ambientBInput"></div></div></div></div><div class="xct-parameter"><div class="xct-label">Specular</div><div id="specularInput" class="xct-input"><div class="xct-horizontal xct-one-third"><div class="xct-label xct-sublabel">R:</div><div id="specularRInput"></div></div><div class="xct-horizontal xct-one-third"><div class="xct-label xct-sublabel">G:</div><div id="specularGInput"></div></div><div class="xct-horizontal xct-one-third"><div class="xct-label xct-sublabel">B:</div><div id="specularBInput"></div></div></div></div><div class="xct-parameter"><div class="xct-label">Emissive</div><div id="emissiveColorInput" class="xct-input"><div class="xct-horizontal xct-one-third"><div class="xct-label xct-sublabel">R:</div><div id="emissiveRInput"></div></div><div class="xct-horizontal xct-one-third"><div class="xct-label xct-sublabel">G:</div><div id="emissiveGInput"></div></div><div class="xct-horizontal xct-one-third"><div class="xct-label xct-sublabel">B:</div><div id="emissiveBInput"></div></div></div></div><div class="xct-separator"></div><div class="xct-title">Values</div><div class="xct-parameter"><div class="xct-label">Metalness</div><div id="metalnessInput" class="xct-input"></div></div><div class="xct-parameter"><div class="xct-label">Roughness</div><div id="roughnessInput" class="xct-input"></div></div><div class="xct-parameter"><div class="xct-label">IOR</div><div id="iorInput" class="xct-input"></div></div><div class="xct-parameter"><div class="xct-label">Transparency</div><div id="transparencyInput" class="xct-input"></div></div><div class="xct-parameter"><div class="xct-label">Emissive</div><div id="emissiveInput" class="xct-input"></div></div>'})},setup:function(){var e=document.getElementById("albedoRInput");this.albedoRSpinbox=new o({value:1,minValue:0,maxValue:1,stepValue:.1,pageStepValue:1,displayStyle:"lite"}),this.albedoRSpinbox.getContent().addClassName("xct-min-width"),this.albedoRSpinbox.inject(e);var t=document.getElementById("albedoGInput");this.albedoGSpinbox=new o({value:1,minValue:0,maxValue:1,stepValue:.1,pageStepValue:1,displayStyle:"lite"}),this.albedoGSpinbox.getContent().addClassName("xct-min-width"),this.albedoGSpinbox.inject(t);var i=document.getElementById("albedoBInput");this.albedoBSpinbox=new o({value:1,minValue:0,maxValue:1,stepValue:.1,pageStepValue:1,displayStyle:"lite"}),this.albedoBSpinbox.getContent().addClassName("xct-min-width"),this.albedoBSpinbox.inject(i);var r=document.getElementById("ambientRInput");this.ambientRSpinbox=new o({value:1,minValue:0,maxValue:1,stepValue:.1,pageStepValue:1,displayStyle:"lite"}),this.ambientRSpinbox.getContent().addClassName("xct-min-width"),this.ambientRSpinbox.inject(r);var n=document.getElementById("ambientGInput");this.ambientGSpinbox=new o({value:1,minValue:0,maxValue:1,stepValue:.1,pageStepValue:1,displayStyle:"lite"}),this.ambientGSpinbox.getContent().addClassName("xct-min-width"),this.ambientGSpinbox.inject(n);var a=document.getElementById("ambientBInput");this.ambientBSpinbox=new o({value:1,minValue:0,maxValue:1,stepValue:.1,pageStepValue:1,displayStyle:"lite"}),this.ambientBSpinbox.getContent().addClassName("xct-min-width"),this.ambientBSpinbox.inject(a);var l=document.getElementById("specularRInput");this.specularRSpinbox=new o({value:1,minValue:0,maxValue:1,stepValue:.1,pageStepValue:1,displayStyle:"lite"}),this.specularRSpinbox.getContent().addClassName("xct-min-width"),this.specularRSpinbox.inject(l);var h=document.getElementById("specularGInput");this.specularGSpinbox=new o({value:1,minValue:0,maxValue:1,stepValue:.1,pageStepValue:1,displayStyle:"lite"}),this.specularGSpinbox.getContent().addClassName("xct-min-width"),this.specularGSpinbox.inject(h);var d=document.getElementById("specularBInput");this.specularBSpinbox=new o({value:1,minValue:0,maxValue:1,stepValue:.1,pageStepValue:1,displayStyle:"lite"}),this.specularBSpinbox.getContent().addClassName("xct-min-width"),this.specularBSpinbox.inject(d);var u=document.getElementById("emissiveRInput");this.emissiveRSpinbox=new o({value:1,minValue:0,maxValue:1,stepValue:.1,pageStepValue:1,displayStyle:"lite"}),this.emissiveRSpinbox.getContent().addClassName("xct-min-width"),this.emissiveRSpinbox.inject(u);var c=document.getElementById("emissiveGInput");this.emissiveGSpinbox=new o({value:1,minValue:0,maxValue:1,stepValue:.1,pageStepValue:1,displayStyle:"lite"}),this.emissiveGSpinbox.getContent().addClassName("xct-min-width"),this.emissiveGSpinbox.inject(c);var p=document.getElementById("emissiveBInput");this.emissiveBSpinbox=new o({value:1,minValue:0,maxValue:1,stepValue:.1,pageStepValue:1,displayStyle:"lite"}),this.emissiveBSpinbox.getContent().addClassName("xct-min-width"),this.emissiveBSpinbox.inject(p);var f=document.getElementById("metalnessInput");this.metalnessSpinBox=new o({value:0,minValue:0,maxValue:1,stepValue:.01,pageStepValue:.1}),this.metalnessSpinBox.inject(f);var m=document.getElementById("roughnessInput");this.roughnessSpinBox=new o({value:.3,minValue:0,maxValue:1,stepValue:.01,pageStepValue:.1}),this.roughnessSpinBox.inject(m);var g=document.getElementById("iorInput");this.iorSpinBox=new o({value:1.5,minValue:1,maxValue:2.5,stepValue:.01,pageStepValue:.1}),this.iorSpinBox.inject(g);var v=document.getElementById("transparencyInput");this.transparencySpinBox=new o({value:0,minValue:0,maxValue:1,stepValue:.01,pageStepValue:.1}),this.transparencySpinBox.inject(v);var _=document.getElementById("emissiveInput");this.emissiveSpinBox=new o({value:0,minValue:0,maxValue:999,stepValue:.1,pageStepValue:1}),this.emissiveSpinBox.inject(_);var y=new s({label:"Apply",type:"check",internalLabelsFlag:!0});y.inject(this.container);var b=this;y.addEventListener("change",function(){xCity.selectedItems[0].get("Content")._node.traverse(function(e){if(e&&e._material&&e._material instanceof THREE.PhysicalMaterial){var t=e._material;t.diffuse.r=this.albedoRSpinbox.value,t.diffuse.g=this.albedoGSpinbox.value,t.diffuse.b=this.albedoBSpinbox.value,t.ambient.r=this.ambientRSpinbox.value,t.ambient.g=this.ambientGSpinbox.value,t.ambient.b=this.ambientBSpinbox.value,t.specular.r=this.specularRSpinbox.value,t.specular.g=this.specularGSpinbox.value,t.specular.b=this.specularBSpinbox.value,t.emissionColor.r=this.emissiveRSpinbox.value,t.emissionColor.g=this.emissiveGSpinbox.value,t.emissionColor.b=this.emissiveBSpinbox.value,t.emissionValue=this.emissiveSpinBox.value,t.metalness=this.metalnessSpinBox.value,t.roughness=this.roughnessSpinBox.value,t.ior=this.iorSpinBox.value,t.transparency=this.transparencySpinBox.value}}.bind(b))})},createPanel:function(){this.colorLabel=new UWA.Element("h6",{text:"Colors"}).inject(this.container),this.albedoLabel=new UWA.Element("h6",{text:"Albedo / Diffuse"}).inject(this.container),this.albedoRInput=new UWA.Element("h6",{text:"R:",classid:"xct-label xct-sublabel"}).inject(this.albedoLabel);var e=new o({value:1,minValue:0,maxValue:1,stepValue:.1,pageStepValue:1,displayStyle:"lite"});e.getContent().addClassName("xct-min-width"),e.inject(this.albedoRInput),this.albedoGInput=new UWA.Element("h6",{text:"G:"}).inject(this.albedoLabel);var t=new o({value:1,minValue:0,maxValue:1,stepValue:.1,pageStepValue:1,displayStyle:"lite"});t.getContent().addClassName("xct-min-width"),t.inject(this.albedoGInput),this.albedoBInput=new UWA.Element("h6",{text:"B:"}).inject(this.albedoLabel);var i=new o({value:1,minValue:0,maxValue:1,stepValue:.1,pageStepValue:1,displayStyle:"lite"});i.getContent().addClassName("xct-min-width"),i.inject(this.albedoBInput)},createSliders:function(){this.coverageLabel=new UWA.Element("h6",{text:"Coverage :"}).inject(this.container),this.sliderCoverage=new r({minValue:0,maxValue:1,stepValue:.01,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:10,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.heightLabel=new UWA.Element("h6",{text:"Height :"}).inject(this.container),this.sliderHeight=new r({minValue:0,maxValue:500,stepValue:1,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:6,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.thicknessLabel=new UWA.Element("h6",{text:"Thickness :"}).inject(this.container),this.sliderThickness=new r({minValue:0,maxValue:300,stepValue:1,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:10,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.aspectLabel=new UWA.Element("h6",{text:"Aspect :"}).inject(this.container),this.sliderAspect=new r({minValue:0,maxValue:1,stepValue:.01,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:10,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.shapeLabel=new UWA.Element("h6",{text:"Shape :"}).inject(this.container),this.sliderShape=new r({minValue:.001,maxValue:.01,stepValue:1e-4,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:10,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.directionLabel=new UWA.Element("h6",{text:"Wind direction :"}).inject(this.container),this.sliderDirection=new r({minValue:-180,maxValue:180,stepValue:1,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:36,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container),this.speedLabel=new UWA.Element("h6",{text:"Wind speed :"}).inject(this.container),this.sliderSpeed=new r({minValue:0,maxValue:1,stepValue:.001,dynamicGraduations:!1,graduationsLabel:!1,dynamicGaugeColor:!1,knobIndicator:"line",knobMaterial:"pearl",graduations:10,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.container)},updateSlide:function(){this.sliderCoverage.getValue()!==xCity._urbanImpl.environment.cloudsParams.coverage&&this.sliderCoverage.setValue(xCity._urbanImpl.environment.cloudsParams.coverage),this.sliderHeight.getValue()!==xCity._urbanImpl.environment.cloudsParams.height&&this.sliderHeight.setValue(xCity._urbanImpl.environment.cloudsParams.height),this.sliderThickness.getValue()!==xCity._urbanImpl.environment.cloudsParams.thickness&&this.sliderThickness.setValue(xCity._urbanImpl.environment.cloudsParams.thickness),this.sliderAspect.getValue()!==xCity._urbanImpl.environment.cloudsParams.aspect&&this.sliderAspect.setValue(xCity._urbanImpl.environment.cloudsParams.aspect),this.sliderShape.getValue()!==xCity._urbanImpl.environment.cloudsParams.shape&&this.sliderShape.setValue(xCity._urbanImpl.environment.cloudsParams.shape),this.sliderSpeed.getValue()!==xCity._urbanImpl.environment.cloudsParams.windSpeed&&this.sliderSpeed.setValue(xCity._urbanImpl.environment.cloudsParams.windSpeed)},initButtonEvent:function(){var e=this;this.cloudsOn.addEventListener("change",function(t){e.buttonClicked=t.dsModel.value[0],e.cloudsOn.getButtonFromValue(e.buttonClicked).checkFlag=!0,0==e.buttonClicked?xCity._urbanImpl.environment.cloudsParams.on=!0:xCity._urbanImpl.environment.cloudsParams.on=!1})},initSlidersEvent:function(){this.sliderCoverage.addEvent("change",function(){var e=this.getValue();xCity._urbanImpl.environment.cloudsParams.coverage=e}),this.sliderThickness.addEvent("change",function(){var e=this.getValue();xCity._urbanImpl.environment.cloudsParams.thickness=e}),this.sliderHeight.addEvent("change",function(){var e=this.getValue();xCity._urbanImpl.environment.cloudsParams.height=e}),this.sliderAspect.addEvent("change",function(){var e=this.getValue();xCity._urbanImpl.environment.cloudsParams.aspect=e}),this.sliderShape.addEvent("change",function(){var e=this.getValue();xCity._urbanImpl.environment.cloudsParams.shape=e}),this.sliderDirection.addEvent("change",function(){var e=this.getValue()*(Math.PI/180),t=Math.cos(e),i=Math.sin(e),r=new THREE.Vector3(t,0,i);xCity._urbanImpl.environment.cloudsParams.windDirection=r}),this.sliderSpeed.addEvent("change",function(){var e=this.getValue();xCity._urbanImpl.environment.cloudsParams.windSpeed=e})}})}),define("DS/XCityModel/WebWorkerPool",["UWA/Class","DS/XCityTools/Debug"],function(e,t){"use strict";return e.extend({init:function(e,i,r){r?t.log("Creating a worker pool with dynamic pool size management"):t.log(`Creating a worker pool with static pool size of ${i} worker(s)`),this.useDynamicManagement=r,this.workerPath=e,this.maxIdleWorkers=8,this.poolSize=r?this.maxIdleWorkers:i,this.pool=[],this.freeWorkers=[],this.taskQueue=[],this.refreshTaskFrequency=20,this.slowDownFactorThresholmd=.85,this.speedUpFactorThreshold=1.1,this.perfQueueLength=4,this.performanceQueue=[],this.currAvgPerf,this.prevAvgPerf=Number.MIN_VALUE,this.activeWorkers=r?1:this.poolSize,this.fakeDecrements=0,this.poolManagementFrequency=1e3,this.isLocked=!0,this.pendingGeomSet=[],this.preloadWorkers=!0,this.msecBetweenWorkerSpawn=0,this.msecBeforeFirstSpawn=8e3,this.lockOwner,this.isAborting=!1,this.abortCallback;let s=0,n=this;var a=function(){s<n.poolSize?(n.pool[s]=new Worker(n.workerPath),n.pool[s].onerror=function(e){e.preventDefault(),t.log(e)},n.preloadWorkers&&n.pool[s].postMessage("just_load_dependencies"),s++,setTimeout(a,this.msecBetweenWorkerSpawn)):n._finishInit()};setTimeout(a,this.msecBeforeFirstSpawn)},_finishInit:function(){for(let e=0;e<this.activeWorkers;e++)this.freeWorkers.push(this.pool[e]);this._updateInterval=setInterval(this._update.bind(this),this.refreshTaskFrequency),this.useDynamicManagement&&(this._managePoolInterval=setInterval(this._managePool.bind(this),this.poolManagementFrequency)),this.unlock()},lock:function(e){let t={},i=new Promise((e,i)=>{t.resolve=e,t.reject=i});return this.pendingGeomSet.push(t),this.isLocked&&this.lockOwner!==e||(this.lockOwner=e,this.isLocked=!0,this.pendingGeomSet.pop().resolve()),i},abort:function(e){let t={},i=new Promise((e,i)=>{t.resolve=e,t.reject=i});return this.isLocked&&this.lockOwner!==e?t.reject():(this._flushPerfQueue(),this.taskQueue=[],this.abortCallback=t.resolve,this.freeWorkers.length===this.poolSize?(this.isAborting=!1,this.abortCallback()):this.isAborting=!0),i},unlock:function(){this.pendingGeomSet.length>0&&this.pendingGeomSet.pop().resolve(),this.isLocked=!1},_update:function(){if(this.taskQueue.length>0&&this.freeWorkers.length>0){let e=this.taskQueue.shift();t.log("Assigning a task to a free worker "+(void 0!==e.workerData.indexSession?e.workerData.indexSession:""));let i=this.freeWorkers.pop();i.onmessage=(r=>{t.log("A worker completed its task"),this.freeWorkers.push(i),this.isAborting?this.freeWorkers.length===this.poolSize&&(this.isAborting=!1,this.abortCallback()):e.resolve(r.data)}),i.postMessage(e.workerData)}},setPerfHook:function(e){this.perfHook=e},_managePool:function(){if(this.perfHook){let e=this.perfHook();void 0===e||isNaN(e)?t.warn("Perf measure is undefined or NaN. Waiting for next measure..."):this._addPerfToPerfQueue(e)}else t.error("Worker pool can't manage workers without performance statistics. Please plug in the function returning your performance score at initialization using setPerfHook(yourPerfFunction)");if(this.performanceQueue.length===this.perfQueueLength){this.currAvgPerf=this._getPerfQueueAvg(this.performanceQueue);let e=performance.now(),i=Math.round(e/1e3);i+=", "+this.currAvgPerf,this.currAvgPerf>this.prevAvgPerf*this.speedUpFactorThreshold?(0===this.fakeDecrements?(this.activeWorkers++,this.freeWorkers.push(this.pool[this.activeWorkers-1])):this.fakeDecrements--,this.prevAvgPerf=this.currAvgPerf,this._flushPerfQueue()):this.currAvgPerf<this.prevAvgPerf*this.slowDownFactorThresholmd&&(this.fakeDecrements++,this.prevAvgPerf=this.currAvgPerf,this._flushPerfQueue()),i+=", "+this.fakeDecrements,i+=", "+this.activeWorkers,t.log("WebWorkerPool[DEBUG]: "+i)}},_getPerfQueueAvg:function(e){let t=0;for(let e=0;e<this.performanceQueue.length;e++)t+=this.performanceQueue[e];return t/=this.performanceQueue.length},_addPerfToPerfQueue:function(e){this.performanceQueue.push(e),this.performanceQueue.length>this.perfQueueLength&&this.performanceQueue.shift()},_flushPerfQueue:function(){this.performanceQueue=[]},submit:function(e){t.log("Task submited");let i={};i.workerData=e;let r=new Promise((e,t)=>{i.resolve=e,i.reject=t});return this.taskQueue.push(i),r},invokeAll:function(e){let t=[];for(let i in e){let r=e[i],s={};s.workerData=r;let n=new Promise((e,t)=>{s.resolve=e,s.reject=t});t.push(n),this.taskQueue.push(s)}return Promise.all(t)},isTerminated:function(){},isShutdown:function(){},shutdown:function(){},shutdownNow:function(){clearInterval(this._updateInterval),clearInterval(this._managePoolInterval);for(let e=0;e<this.poolSize;e++)this.pool[e].terminate(),this.freeWorkers.push(this.pool[e]);return this.taskQueue}})}),define("DS/XCityLoaders/ColladaLoader",["DS/Visualization/ColladaLoader","DS/XCityLoaders/BaseLoader","DS/XCityLoaders/ColladaParser","DS/XCityLoaders/ModelLoader"],function(e,t,i,r){"use strict";var s=t.extend({init:function(t,i){this._parent(t,i),this.loader=new e.ColladaLoader,this.loader.options.convertUpAxis=!1},load:function(e,t){this._parent(e,t);var i=this.model.url+(this.model.urlOptions?this.model.urlOptions:"");return this.loader.load(i,this._ready.bind(this)),this.model.node},_ready:function(e){var t,r=new i(this.urban,e,this.model).parse(),s=!1;r&&(this.model.node.add(r),t=this.model.node,s=!0),this.model.callback&&this.model.callback(t,s,this.model.name)}});return r.formatLoaders.dae=s,r.formatLoaders.zae=s,s}),define("DS/XCityGeometry/PatchVectorFactoryParticle",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/Visualization/ParticlesNode3D","DS/XCityLayer/Vector","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader"],function(e,t,i,r,s,n,a,o,l){"use strict";return UWA.Class.extend({init:function(e,r){this._parent(e,r),this.urban=e,this._node=new i,this._node.name="FactoryParticle",this.altitudeAttribute=void 0!==r.altitudeAttribute?r.altitudeAttribute:"ALTITUDE",this.scaleAttribute=void 0!==r.scaleAttribute?r.scaleAttribute:"SCALE",this.orientationAttribute=void 0!==r.orientationAttribute?r.orientationAttribute:"ORIENT",this.textureIndexAttribute=void 0!==r.textureIndexAttribute?r.textureIndexAttribute:"INDEX",this.typeAttribute=void 0!==r.typeAttribute?r.typeAttribute:"TYPE",this.stridAttribute=void 0!==r.stridAttribute?r.stridAttribute:"STRID",this.pustuleSize=60,this.textSize=100,this.color=r.color||"#ffffff",this.color=r.color||"#ffffff",this.pustule=void 0,this.materialPustule=void 0,l.loadTexture(function(e){this.pustule=e,this.materialPustule=new t.ParticleBasicMaterial({size:this.pustuleSize,sizeAttenuation:!1,map:this.pustule,transparent:!0,depthTest:!1,color:this.color,shading:t.SmoothShading})}.bind(this),"../XCityEnvironment/assets/textures/poi/pustule2.png"),o.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},destroy:function(){this.urban.USR.getScene().remove(this._node)},dispose:function(){a.warn("Dispose: UrbanSiroccoFactoryPOI"),void 0!==this.pustule&&(this.pustule.dispatchEvent({type:"dispose"}),this.pustule=void 0),void 0!==this.materialPustule&&(this.materialPustule.dispose(),this.materialPustule=void 0)},getData:function(e){var i=new s(new t.ParticleSystem(geom.geom,this.materialPustule),"poi");return i.setMatrix((new t.Matrix4).identity().setPosition(new t.Vector3(e.posTile.x,e.posTile.y,0))),i},initMesh:function(e,t,i,r,s){},_getOrCreateGeometry:function(e,i,r){if(!(r in i)){var s={};s.geom=new t.Geometry,i[r]=s}return i[r]},buildOne:function(e,i,r){if(e.getGeometry().type===n.Type.POINT){var s=e.getGeometry().getVertices(),a=void 0;void 0===i.geometry?(i.geometry=this._getOrCreateGeometry(e,ltileGeoms,"Placemark"),a=new t.Vector2(Math.round(s[0]),Math.round(s[1])),i.posTile=a):a=i.posTile,i.geometry.geom.vertices.push(new t.Vector3(s[0]-a.x,s[1]-a.y,100))}},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1}})}),define("DS/XCityModel/ParallelFeatBuildingAPI",["UWA/Class","DS/WebappsUtils/WebappsUtils","DS/XCityLayer/VectorLoaderJSON","DS/XCityModel/WebWorkerPool","DS/XCityGeometry/Line","DS/XCityTools/Debug"],function(e,t,i,r,s,n){"use strict";return e.extend({init:function(e,t){this.urban=e,this.isBuildingFeatureSet=!1,this.sessionBuffer=[],this.promiseBuffer=[],this.pendingSessionToSend=0,this.indexSessionToSend=0,this.nbFeatPerNode,this.nbNode,this.useDynamicManagement=t,this.polygonSetWorker=e.urban.polygonSetWorker,this.lineSetWorker=e.urban.lineSetWorker},lock:function(e,t){switch(this.featureType=e,e){case"polygon":return this.polygonSetWorker.lock(t);case"line":return this.lineSetWorker.lock(t);case"default":return n.error("Feature of type ["+e+"] not handled"),null}},abort:function(e,t){this.featureType=e;let i={},r=new Promise((e,t)=>{i.resolve=e,i.reject=t});switch(e){case"polygon":return this.polygonSetWorker.abort(t).then(e=>{this._reset(),i.resolve(e)},e=>{i.reject(e)}),r;case"line":return this.lineSetWorker.abort(t).then(e=>{this._reset(),i.resolve(e)},e=>{i.reject(e)}),r;case"default":return n.error("Feature of type ["+e+"] not handled"),null}},_reset:function(){switch(this.isBuildingFeatureSet=!1,this.sessionBuffer=[],this.promiseBuffer=[],this.pendingSessionToSend=0,this.indexSessionToSend=0,this.featureType){case"polygon":this.polygonSetWorker.unlock();break;case"line":this.lineSetWorker.unlock();break;case"default":n.error("Feature of type ["+featureType+"] not handled")}},setPerfHook:function(e){this.currentWorkerPoolPerfHook=e},_createWorkerPool:function(e,t,i){return e?n.log("Returning already instantiated pool, close this pool to create a new one with different parameters"):this.useDynamicManagement?(e=new r(i,null,!0)).setPerfHook(this.currentWorkerPoolPerfHook):e=new r(i,t,!1),e},_assignFeaturesTasks(e,t,i){this.indexSessionToSend=0;let r=t.count;if(this.nbNode=e.nbNode,0===this.nbNode)this._reset();else for(let s=0;s<this.nbNode;s++){let n=s*e.nbFeatPerNode,a=s===this.nbNode-1?Math.min(e.nbFeatureMax,r):(s+1)*e.nbFeatPerNode,o={features:t.list.slice(n,a)},l={};l.features=o,l.indexSession=s,Object.assign(l,e),this._submitTask(l,i)}},_submitTask:function(e,t){switch(t){case"polygon":this.polygonSetWorker.submit(e).then(e=>this.addSessiontoBuffer(e));break;case"line":this.lineSetWorker.submit(e).then(e=>this.addSessiontoBuffer(e));break;default:n.error("Feature of type ["+t+"] has no associated worker pool")}},buildPolygonSet:function(e){n.log("Parallel building of a polygon set in progress");let t={};t.loaderType=this.get("type"),t.nbFeatPerNode=this.nbFeatPerNode,t.nbNode=this.nbNode,t.isPickable=!0,t.urbanBaseProjection=this.urban.baseProjection,t.refBbox=this.urban.baseReferential.bbox,t.factoryStridAttribute=this.get("stridAttribute"),t.infoStrid=this.get("id"),t.useNormalMap=this.urban.useNormalMap,t.useSpecularMap=this.urban.useSpecularMap,t.elevationMode=this.get("elevationMode"),t.elevation=this.get("elevation"),t.elevationOffset=this.get("elevationOffset"),t.slabAltitude=this.urban.slabAltitude,t.precomputedZValues=this.precomputedZValues,t.preloadedUrbanProj=this.preloadedUrbanProj,t.preloadedInputCRS=this.preloadedInputCRS,t.fromGeometrySet=this.fromGeometrySet,t.inputCRS=this._inputCRS,t.nbFeatureMax=this.nbFeatureMax;let i=["elevation","elevationOffset","precomputedZValues"];for(let e in t)if(void 0===t[e]&&!i.includes(e))return void n.error(`A required parameter is undefined for the polygon set parallel building: [${e}]`);if(!e)return void n.error("The data source content is undefined for the polygon set parallel building");t.roofObjects=this.urban.url.getArgument("roofObjects")?parseFloat(this.urban.url.getArgument("roofObjects").value):void 0,t.defaultRendering=this._rendering.getDefaultRendering(),t.proj4Projection=this.urban.proj4Projection,t.magnitude=this.get("magnitude");let r=this.getRendering().currentRendering.toJSON();t.datavizRenderings=r.DatavizRendering,t.datavizRenderings&&(t.datavizRenderings.length=this.getRendering().currentRendering.getDatavizIds().length),t.primitiveRenderings=r.ElementRendering,t.currentRenderingData=this._rendering.currentRendering.renderingData,t.defaultRenderingData=this._rendering.defaultRendering.renderingData,this.parallelBuilder._assignFeaturesTasks(t,e,"polygon")},buildLineSet:function(e){n.log("Parallel building of a line set in progress");let t={};t.loaderType=this.get("type"),t.nbFeatPerNode=this.nbFeatPerNode,t.nbNode=this.nbNode,t.factoryStridAttribute=this.get("stridAttribute"),t.infoStrid=this.get("id"),t.nbInfoPix=Object.keys(s.BUFFER_IMAGE).length,t.refBbox=this.urban.baseReferential.bbox,t.urbanBaseProjection=this.urban.baseProjection,t.camPos=this.urban.getViewpoint().getPosition(),t.elevationMode=this.get("elevationMode"),t.elevation=this.get("elevation"),t.elevationOffset=this.get("elevationOffset"),t.slabAltitude=this.urban.slabAltitude,t.precomputedZValues=this.precomputedZValues,t.preloadedUrbanProj=this.preloadedUrbanProj,t.preloadedInputCRS=this.preloadedInputCRS,t.fromGeometrySet=this.fromGeometrySet,t.inputCRS=this._inputCRS,t.nbFeatureMax=this.nbFeatureMax;let i=["elevation","elevationOffset","precomputedZValues"];for(let e in t)if(void 0===t[e]&&!i.includes(e))return void n.error(`A required parameter is undefined for the line set parallel building: [${e}]`);if(!e)return void n.error("The data source content is undefined for the line set parallel building");let r=this.getRendering().currentRendering.toJSON();t.datavizRenderings=r.DatavizRendering,t.datavizRenderings&&(t.datavizRenderings.length=this.getRendering().currentRendering.getDatavizIds().length),t.primitiveRenderings=r.ElementRendering,t.currentRenderingData=this._rendering.currentRendering.renderingData,t.defaultRenderingData=this._rendering.defaultRendering.renderingData,this.parallelBuilder._assignFeaturesTasks(t,e,"line")},next:function(){n.log(`Session number ${this.indexSessionToSend} is being asked`);let e={},t=new Promise((t,i)=>{e.resolve=t});return this.promiseBuffer[this.indexSessionToSend]=e,this.pendingSessionToSend++,this.sendBufferSession(),t},addSessiontoBuffer:function(e){n.log(`Receiving session number ${e.indexNodeReady}`),this.sessionBuffer[e.indexNodeReady]=e,this.pendingSessionToSend>0&&this.sendBufferSession()},sendBufferSession:function(){if(this.sessionBuffer[this.indexSessionToSend]&&this.pendingSessionToSend>0){n.log(`Sending session number ${this.indexSessionToSend}`);let e=this.sessionBuffer[this.indexSessionToSend];delete this.sessionBuffer[this.indexSessionToSend],this.promiseBuffer[this.indexSessionToSend].resolve(e),delete this.promiseBuffer[this.indexSessionToSend],this.pendingSessionToSend--,this.indexSessionToSend++,this.nbNode===this.indexSessionToSend&&this._reset()}},close:function(){}})}),define("DS/XCityModel/AbstractSet",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityModel/Item","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/VectorLoaderEnovia","DS/XCityLayer/Vector","DS/xCityBasicUtils/Utils","DS/XCityModel/LayerVectorPrimitive","DS/XCityTools/EventDispatcher","DS/XCityTools/Geocoder","DS/XCityTools/Downloader","DS/XCityTools/ExpressionEvaluator","DS/XCityTools/Disposer","DS/XCityModel/ParallelFeatBuildingAPI","DS/XCityLayer/VectorLoaderGML"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m){"use strict";var g=r.extend({defaults:{url:"",geojson:null,type:"json",Coordinate:null,renderID:"",Rendering:null,objectId:"",serviceId:"",stridAttribute:"STRID",interactionBehaviours:{onSelect:{label:!0},onHover:{label:!0}}},setup:function(){this._parent(),this._node=new t,this.loaderJSON||(this.loaderJSON={}),this.heightMatrix=new e.Matrix4,this.nbOutside=0,this.nbInside=0,this.nbError=0,this.oversized=!1,this.isBuilt=!1,this.nbInputFeature=0,this.oldPrimInfos={}},destroy:function(e){if(this.primInfos=null,this._data=null,this._patch)for(var t in this._patch._uidListeners)delete this._patch._uidListeners[t];this._factory&&(this._factory.destroy(),this._factory=null),delete this._patch,e.getNode3D().remove(this._node),p.disposeV6(this._node),this._parent(e)},rebuild:async function(){if(this.oldPrimInfos=Object.assign({},this.primInfos),!this.isBuilt&&this.parallelBuilder){await this.parallelBuilder.lock(this._geometrySTRIDName,this),this.isAborting=!0,await this.parallelBuilder.abort(this._geometrySTRIDName,this);const e=function(){this.isAborting=!1,this.isBuilt=!1,this._createAbstractSet(this._data,!0)}.bind(this);setTimeout(e,1e3)}else this.isBuilt=!1,this._createAbstractSet(this._data,!0)},_shouldUseWebWorkers:function(e){if(!this._builderWorker)return!1;return!(e<1e4&&!this.urban.forceWebWorkers)&&(this.parallelBuilder||(this.parallelBuilder=new f(this,!1)),!0)},_shouldUseSorterWorkers:function(e){return this.urban.featureSorterWorkerSem&&!this._isDataSorted&&e>this.nbFeatPerNode},_terminate:function(){this.isBuilt=!0,h.publish(h.eventsList.onUpdate+":"+this.get("id"),{loaded:this.nbNodeBeforeCleaning+1+1+1,total:this.nbNodeBeforeCleaning+3}),h.publish(h.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})},_processMultiTypeGeometry:function(e,t,i){return!1},_processSimpleTypeGeometry:function(e,t,i){return!1},_handleOnNextBatchReady:function(e,t){},_createAbstractSet:function(r,l){if(this.nbGeometry=0,this.nbMultiGeometry=0,!1===l)return this.isBuilt=!0,void h.publish(h.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()});var u,c;r instanceof ArrayBuffer&&(this.geojsonArrayBuffer=r.slice(0),r=(new TextDecoder).decode(r)),this._data=r;var p=this.get("type");if("json"===p?u=new s:"gml"===p?u=new m:"enovia"===p&&(u=new n(this.urban)),this._savedDatasource?(c=this._savedDatasource).index=0:(c=u.loadDataSourceFromObject("string"==typeof r?JSON.parse(r):r),this._savedDatasource=c),this._inputCRS)g=this._inputCRS;else{var f,g=(f="string"==typeof r?JSON.parse(r):r).crs&&f.crs.properties&&f.crs.properties.name?f.crs.properties.name:"WGS84";if(-1===g.indexOf("AUTHORITY")){var v=g.indexOf("EPSG"),_=g.indexOf("CRS84");v>0?g=g.slice(v):_>0&&(g="WGS84"),g=g.replace("::",":")}this._inputCRS=g}if(this.nbOutside=0,this.nbInside=0,this.nbError=0,this.primInfos={},this._shouldUseSorterWorkers(c.count)){let e=function(e){e.worker.onmessage=(t=>{if(this._sortedFeaturesIndexes=Array.from(new Int32Array(t.data.sortedFeaturesIndexesBuffer)),this._precomputedNbFeatures=t.data.geometriesCount[this._geometryName]+t.data.geometriesCount[this._multiGeometryName],e.release(),0===this._precomputedNbFeatures)return this.nbNodeBeforeCleaning=0,this._terminate();this._createAbstractSet(r,!0)});let t=!1,i=!1;r.shpContent&&(t=!0),r.dbfContent&&(i=!0);let s=t&&i;if(this.geojsonArrayBuffer||s||(this.geojsonArrayBuffer=(new TextEncoder).encode(JSON.stringify(r)).buffer),s){let t={geometries:[this._geometryVectorMultiType,this._geometryVectorType],dbf:r.dbfContent.slice(0),shp:r.shpContent.slice(0)};e.worker.postMessage(t,[t.dbf,t.shp])}else{let t={geometries:[this._geometryVectorMultiType,this._geometryVectorType],geojson:this.geojsonArrayBuffer};e.worker.postMessage(t,[t.geojson])}this._isDataSorted=!0}.bind(this);return void this.urban.featureSorterWorkerSem.requestWorker().then(t=>e(t))}if(this._sortedFeaturesIndexes&&!1!==this._shouldSorterDatasource){let e=[];for(let t=0;t<this._sortedFeaturesIndexes.length;t++)e.push(c.list[this._sortedFeaturesIndexes[t]]);c.list=e,c.count=c.list.length,this._shouldSorterDatasource=!1}var y=c.count;this.nbInputFeature=y;var b=!1;this._shouldUseWebWorkers(y)&&(b=!0);var x=new a.Feature;this.nbFeatureMax=xCity._urbanImpl.USR.getProfilePerformance().getValue(this._maxGeometryPreview),y=Math.min(y,this.nbFeatureMax),this._precomputedNbFeatures&&(this._precomputedNbFeatures=Math.min(this._precomputedNbFeatures,this.nbFeatureMax)),this.oversized=!1,this.nbInputFeature>y&&(this.oversized=!0);var C=this.nbFeatPerNode;this.nbNode=Math.ceil(y/C),this.nbNodeBeforeCleaning=this.nbNode;var S=[];h.publish(h.eventsList.onUpdate+":"+this.get("id"),{loaded:1,total:this.nbNode+3});for(let e=0;e<this.nbNode;++e)S[e]={tile:{LOD:0,I:0,J:0},infos:{},ltileGeoms:{}};var D=[];g!==this.urban.baseProjection&&d.loadProjection(g);var P=[];if(this._nodes=new t,this._node.addChild(this._nodes),this._node.userData=this._itemParent,this._factory._node.userData=this._itemParent,0===y)return this.isBuilt=!0,this.oversized=!1,void h.publish(h.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()});this._patch={register:function(t,i){var r=this.primInfos[t];r?(r.listeners?r.listeners.push(i):r.listeners=[i],r.tile&&i(r)):this.primInfos[t]={listeners:[i],strid:t,tile:{LOD:0,I:0,J:0},posSize:{center:new e.Vector3,altitude:0,height:0,width:0,length:0},userData:{}}}.bind(this),unregister:function(e,t){var i=this.primInfos[e];if(i&&i.listeners){for(var r=-1,s=0;s<i.listeners.length;++s)if(i.listeners[s].name===t.name){r=s;break}r>-1&&i.listeners.splice(r,1)}}.bind(this),previewMode:!0,_uidListeners:this.primInfos};var w=function(){if(!this.isAborting){var e=P.shift(),t=e.indexSession;if(!Number.isFinite(t))return this._terminate();if(0!==e.nbInsideSession&&(this._nodes.addChild(this._factory.getData(S[t])),Object.assign(this.primInfos,S[t].infos)),h.publish(h.eventsList.onUpdate+":"+this.get("id"),{loaded:t+1+1,total:this.nbNode+3}),t===this.nbNode-1){var r=performance.now(),s=function(e){if(e instanceof i&&!0===e.pickable){e.show();var t,s,n,a=e.getPrimitives();if(!1===e.isInstanceNode3D)for(t=0;t<a.length;t++){let i=(s=a[t].sgNode).getCgmId();for(let t=0;t<this.nbNode;++t)if(n=S[t].infos[i]){n.geom?n.geom.push({subElement:s,mesh:e}):n.geom=[{subElement:s,mesh:e}];var l=this.oldPrimInfos[i];if(o.is(l&&l.listeners)&&(n.listeners=l.listeners),n.listeners&&n.listeners.length>0)for(let e=0;e<n.listeners.length;++e){(0,n.listeners[e])(n)}}}}r=performance.now()}.bind(this);const e=function(){const t=Math.min(200*this.nbNode,2e3);if(!(performance.now()-r>t))return setTimeout(e,200);this._nodes.children.map(e=>{let t=e;return t.userData={records:D},t}),this._terminate()}.bind(this);this._nodes.traverse(function(e){o.requestIdleCallback(()=>s(e))}.bind(this)),e()}if(b){var n=function(){this.isAborting||(function(){this.nbGeometrySession=0,this.nbMultiGeometrySession=0}.bind(this)(),this.parallelBuilder.next().then(e=>this.onNextBatchReadyCallback(e)))}.bind(this);t!==this.nbNode-1?h.subscribeTo("/3DEXPERIENCity/onPostUpdate",n,!0):(this.nbGeometrySession=0,this.nbMultiGeometrySession=0),I=!1}}}.bind(this),M=0;this.nbBuiltTotal=0;var T=function(){for(var t=0,i=!1,r=M;r<y;++r){if(50===t){M=r,h.subscribeTo("/3DEXPERIENCity/onPostUpdate",T,!0);break}r===y-1&&(i=!0),c.getNextFeature(x);var s=x.getGeometry(),n=!0,a=this.urban.baseReferential.bbox;if(s&&s.type===this._geometryVectorMultiType)n=this._processMultiTypeGeometry(s,g,a);else{if(!s||s.type!==this._geometryVectorType){this.nbError++;continue}n=this._processSimpleTypeGeometry(s,g,a)}if(n)this.nbOutside++;else{this.nbInside++,this.nbInsideSession++;var o={listeners:null,strid:x.getAttribute(this._factory.stridAttribute),tile:{LOD:0,I:0,J:0},posSize:{center:new e.Vector3,altitude:0,height:0,width:0,length:0},userData:{}};if(void 0!==o.strid&&null!==o.strid||(this.fromGeometrySet?o.strid=this.get("id")+"_"+(this.nbGeometry+this.nbMultiGeometry):o.strid=this.get("id")+"_"+this._geometrySTRIDName+"_"+(this.nbGeometry+this.nbMultiGeometry),x.attributes[this._factory.stridAttribute]=o.strid),s){var l,d;for(d=(l=x.getAttributeKeys()).length;d--;)o.userData[l[d]]=x.getAttribute(l[d]);D.push(o);var u=Math.floor(this.nbBuiltTotal/C);S[u].infos[o.strid]=o,this._factory.buildOne(x,S[u],o),(r+1)%this.nbFeatPerNode==0&&(P.push({indexSession:u,nbInsideSession:this.nbInsideSession}),this.nbInsideSession=0,h.subscribeTo("/3DEXPERIENCity/onPostUpdate",w,!0))}t++,this.nbBuiltTotal++}}i&&(this.nbNode-1!==u&&(this.nbNode=Math.max(1,u-1)),u=this.nbNode-1,P.push({indexSession:u,nbInsideSession:this.nbInsideSession}),this.nbInsideSession=0,h.subscribeTo("/3DEXPERIENCity/onPostUpdate",w,!0))}.bind(this),I=!1,R=-1;let A=0;var F=function(){if(!this.isAborting){-1===R&&(R=performance.now());for(var t=!1,i=M;i<y;++i){if(I){M=i;break}if(performance.now()-R>10){R=-1,M=i,h.subscribeTo("/3DEXPERIENCity/onPostUpdate",F,!0);break}i===y-1&&(t=!0),c.getNextFeature(x);var r=x.getGeometry(),s=!0,n=this.urban.baseReferential.bbox;if(r&&r.type===this._geometryVectorMultiType)s=this._processMultiTypeGeometry(r,g,n);else{if(!r||r.type!==this._geometryVectorType){this.nbError++,(i+1)%this.nbFeatPerNode==0&&(P.push({indexSession:A,nbInsideSession:this.nbInsideSession}),this.nbInsideSession=0,h.subscribeTo("/3DEXPERIENCity/onPostUpdate",w,!0),I=!0);continue}s=this._processSimpleTypeGeometry(r,g,n)}if(s)this.nbOutside++,(i+1)%this.nbFeatPerNode==0&&(P.push({indexSession:A,nbInsideSession:this.nbInsideSession}),this.nbInsideSession=0,h.subscribeTo("/3DEXPERIENCity/onPostUpdate",w,!0),I=!0);else{this.nbInside++,this.nbInsideSession++;var a={strid:x.getAttribute(this._factory.stridAttribute),tile:{LOD:0,I:0,J:0},posSize:{center:new e.Vector3,altitude:0,height:0,width:0,length:0},userData:{}};if(void 0!==a.strid&&null!==a.strid||(this.fromGeometrySet?a.strid=this.get("id")+"_"+(this.nbMultiGeometrySession+this.nbGeometrySession)+"_"+this.receivedSessionId:a.strid=this.get("id")+"_"+this._geometrySTRIDName+"_"+(this.nbMultiGeometrySession+this.nbGeometrySession)+"_"+this.receivedSessionId,x.attributes[this._factory.stridAttribute]=a.strid),r){var o,l;for(l=(o=x.getAttributeKeys()).length;l--;)a.userData[o[l]]=x.getAttribute(o[l]);D.push(a),A=this.receivedSessionId,S[A].infos[a.strid]=a,S[A][this._webWorkersDataName]=this.webWorkersData,this._factory.buildOne(x,S[A],a)}(i+1)%this.nbFeatPerNode==0&&(P.push({indexSession:A,nbInsideSession:this.nbInsideSession}),this.nbInsideSession=0,h.subscribeTo("/3DEXPERIENCity/onPostUpdate",w,!0),I=!0),0,this.nbBuiltTotal++}}t&&(this.parallelBuilder.close(),this.nbNode-1!==A&&(this.nbNode=Math.max(1,A-1)),A=this.nbNode-1,P.push({indexSession:A,nbInsideSession:this.nbInsideSession}),this.nbInsideSession=0,h.subscribeTo("/3DEXPERIENCity/onPostUpdate",w,!0))}}.bind(this);if(this.onNextBatchReadyCallback=function(e){this.isAborting||(this.webWorkersData=e,this.receivedSessionId=this.webWorkersData.indexNodeReady,e.empty||!0===e.empty||this._handleOnNextBatchReady(e,S),h.subscribeTo("/3DEXPERIENCity/onPostUpdate",F,!0))}.bind(this),b)Promise.all(this._prepareDataForWorkers(r)).then(()=>{this.parallelBuilder.lock(this._geometrySTRIDName,this).then(()=>{this.isAborting||(this.parallelBuilder[this._parallelBuilderFunName].call(this,c),this.parallelBuilder.next().then(e=>this.onNextBatchReadyCallback(e)))})});else{var L=function(){void 0===d.projections[g]||1!==d.projections[g].ready?h.subscribeTo("/3DEXPERIENCity/onPostUpdate",L,!0):h.subscribeTo("/3DEXPERIENCity/onPostUpdate",T,!0)}.bind(this);h.subscribeTo("/3DEXPERIENCity/onPostUpdate",L,!0)}},create:function(e){if(!this._parent(e))return h.publish(h.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;this.urban=e._urban,this.renderingProfileManager=this.urban.getRenderingProfileManager(),this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this._node.userData=this._itemParent,this._itemParentVisible(this._itemParent),e.getNode3D().add(this._node),this._isDataSorted=!1,this.fromGeometrySet=!1,this._itemParent.get("Content")._poiSet&&this._itemParent.get("Content")._lineSet&&this._itemParent.get("Content")._polygonSet&&(this.fromGeometrySet=!0),this._updateCoordinate(),this.nbGeometry=0,this.nbMultiGeometry=0,this.nbGeometrySession=0,this.nbMultiGeometrySession=0,this.nbInsideSession=0,this.nbFeatPerNode=1e3,this._rendering=this._factory._rendering,this._rendering.defaultRendering.addOver({renderMode:"overlay"}),this.renderingProfileManager.initRendering(this);var t=this,i=this.get("serviceId");if(void 0!==this.get("objectId")&&""!==this.get("objectId")&&void 0!==i&&""!==i)"3DSpace"===i?u.downloadFrom3DSpace(this.get("objectId")).then(function(e){t._createAbstractSet(e,!0)}):"3DDrive"===i&&u.downloadFrom3DDrive(this.get("objectId")).then(function(e){t._createAbstractSet(e,!0)});else if(""!==this.get("url")){var r=this.get("url");u.download(r,{type:"arraybuffer"},99999,function(e,t,i,r){r(t,e,i)},void 0,t._createAbstractSet.bind(this))}else null!==this.get("geojson")&&this._createAbstractSet(this.get("geojson"),!0);return h.publish(h.eventsList.onUpdate+":"+this.get("id"),{loaded:0,total:3}),!0},get:function(e){var t,i,r=this.getRendering();return this.renderingProfileManager&&o.is(r)&&r.hasAttribute(e)?(i=this.getMaterial(),o.is(i)&&(t=i[e])):t=this._parent(e),t},set:function(e,t){var i={},r=this.getRendering();this.renderingProfileManager&&o.is(r)&&r.hasAttribute(e)?(i[e]=t,this.setMaterial(i)):this._parent(e,t)},getMaterial:function(){var e=this.getRendering();return o.is(e)?e.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)},getLocalPosition:function(){var e=this._node.getBoundingSphere().center;return this.get("Coordinate")&&e.add(this.get("Coordinate").getLocalPosition()),e},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},getBoundingSphere:function(){if(this._localPosition&&this._node){if(o.is(this._factory)&&o.is(this._factory.rtrees)){var t={minX:this._factory.rtrees[0]._root.boundingBox.min.x,minY:this._factory.rtrees[0]._root.boundingBox.min.y,minZ:this._factory.rtrees[0]._root.boundingBox.min.z,maxX:this._factory.rtrees[0]._root.boundingBox.max.x,maxY:this._factory.rtrees[0]._root.boundingBox.max.y,maxZ:this._factory.rtrees[0]._root.boundingBox.max.z},i=this._localPosition;i.z=this._node.bSphere.center.z;var r=Math.sqrt(Math.pow(t.maxX-t.minX,2)+Math.pow(t.maxY-t.minY,2)+Math.pow(t.maxZ-t.minZ,2))/2;return new e.Sphere(i,r)}return this._node.getBoundingSphere()}},_shouldCreateLabelFromMaterial:function(e){return e.label&&!0===e.label.enable&&o.is(e.label.name)&&""!==e.label.name},_updateCoordinate:function(){var e=this.previous("Coordinate");e&&e.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")?(this.get("Coordinate").setItemParent(this),this._updateMatrix(this.get("Coordinate")._matrix),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this)):this._updateMatrix()},_itemParentVisible:function(e){this._created&&this._node.setVisibility(e.get("visible"))},setItemParent:function(e){this._itemParent&&this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._itemParent=e,this._itemParent&&this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this)},_updateMatrix:function(e){this._node.setMatrix(e)},_setVisible:function(e){var t=!!e.get("visible");this._nodes&&(t?this._node.addChild(this._nodes):this._node.removeChild(this._nodes))},createPrimitive:function(e,t){var i;this._factory&&this._factory.getGeoJSON&&(i=this._factory.getGeoJSON(e));var r=new l({strid:e,geojson:i,instanceId:t});return r.setLayerVector(this),r.create(this.getRoot()),r.addSubElements(this.primInfos[e]),r},register:function(e){},unregister:function(e){},redrawPrimitive:function(e){if(o.is(this._patch)){var t=this.getRendering();o.is(t)&&(t.isPrimitiveRegistered(e)?t._renderprimitive(e):this.registerPrimitive(e))}},registerPrimitive:function(e){if(o.is(this._patch)){var t=this.getRendering();o.is(t)&&(t.isPrimitiveRegistered(e)||t.registerPrimitive(this._patch,e))}},registerPrimitives:function(e){var t,i,r=Object.keys(e),s=r.length;for(t=0;t<s;t++)i=r[t],this.registerPrimitive(i)},addUserDataProperty:function(e,t,i){if(o.is(e)){var r=this.get("geojson"),s=r.features[0];if(o.is(i))for(var n=0;n<r.features.length;n++){var a=r.features[n];if(a&&a.properties&&a.properties.STRID===i){s=a;break}}s.properties||(s.properties={}),s.properties[e]=t;var l=this.get("userData");return l||(l={},this.set("userData",l)),l[e]=t,!0}return!1},removeUserDataProperty:function(e,t){if(o.is(e)){var i=this.get("geojson"),r=i.features[0];if(o.is(t))for(var s=0;s<i.features.length;s++){var n=i.features[s];if(n&&n.properties&&n.properties.STRID===t){r=n;break}}o.is(r.properties[e])&&delete r.properties[e];var a=this.get("userData");return o.is(a[e])&&delete a[e],!0}return!1},redraw:function(){var e=this.getRendering();if(o.is(e)){if(e._needRebuild&&this._node.children.length>0&&this._node.children[0].children.length>0&&(p.disposeV6(this._node),this.rebuild()),this._nodes)for(var t=0;t<this._nodes.children.length;++t)e.applyRendering(this._nodes.children[t]);e._needRebuild=!1}},getRendering:function(){return this._rendering},findPrimitivesByCriteria:function(e){var t=new c(e),i={};if(!o.is(t))return null;var r;for(var s in this.primInfos){var n=this.primInfos[s].userData;!0===(r=n,t.apply(r)||!1)&&(i[s]=n)}return i},getTransformedGeoJSON:function(){var t=this.get("Coordinate"),i=this.get("geojson");if(!o.is(t))return i;var r=t.getMatrix();if(r.isIdentity())return i;for(var s=i.features[0].geometry.coordinates[0],n=[],a=0;a<s.length;a++){var l=new e.Vector3(s[a][0],s[a][1],s[a][2]);l.applyMatrix4(r),n.push(l.toArray())}var h=o.clone(i);return h.features[0].geometry.coordinates[0]=n,h}});return r.ObjectContructor.AbstractSet=g}),define("DS/XCityLoaders/PointCloudLoader",["DS/XCityLoaders/BaseLoader","DS/XCityLoaders/ModelLoader","DS/XCityLoaders/CmdOpenPointCloud","DS/XCityLoaders/ReloadSceneCommand"],function(e,t,i,r){"use strict";var s=e.extend({init:function(e,t){this._parent(e,t),(new r).begin()},load:function(e,t){var r=new i({});return r.begin(),r.publish({event:r.OK_COMMAND_EVENT,data:{fileURL:this.model.url,loadedCB:this._movePointCloud.bind(this,e)}}),this.urban.frmWindow&&this.urban.frmWindow._3dViewer&&this.urban.frmWindow._3dViewer.viewpoints&&this.urban.frmWindow._3dViewer.viewpoints[0]&&(this.urban.frmWindow._3dViewer.viewpoints[0].fixed=!0),this.model.node},_movePointCloud:function(e){if(this.urban.frmWindow._sceneGraphTree){var t=this.urban.frmWindow._sceneGraphTree,i=t._sg.children[1];i.name="pointCloud",this.model.node.addChild(i),t._sg.removeChild(i)}e()}});return t.formatLoaders.oocpc=s,s}),define("DS/XCityEnvironment/Sun",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D","DS/XCityEnvironment/SunCalculator","DS/XCityTools/Geocoder","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s,n,a){"use strict";return e.extend({init:function(e,s){this._urban=e,this.toUpdate=!0,this.lockUpdateLightFlag=!1;if(a.subscribeTo(a.eventsList.date,function(){this.toupdateLight,this._urban.USR._forceRender()}.bind(this)),this.changeEventName="effect.sun",this.sunCalculator=new r(e),this.ambientFactor=1,this.diffuseFactor=1,this.solarConstant=1367,this.altFactor=1,this.sunLight=new t.DirectionalLight(16777215,0),void 0===s.color)this.sunLight.color.setRGB(1.02,.98,.94),this._urban._debugVisualOdt&&this.sunLight.color.setHex(16777215);else if(void 0!==s.color.r&&void 0!==s.color.g&&void 0!==s.color.b)this.sunLight.color.setRGB(s.color.r,s.color.g,s.color.b);else{var n=new t.Color;n.setHex(parseInt(s.color,16)),this.sunLight.color=n}this.sunLight.intensity=.5,this.sunLight.intensity*=Math.PI,this.sunPos=new t.Vector3,void 0===s.position?(this.sunPos.x=.5*this._urban.worldSize,this.sunPos.y=.5*this._urban.worldSize,this.sunPos.z=.5*this._urban.worldSize):(this.sunPos.x=s.position.x,this.sunPos.y=s.position.y,this.sunPos.z=s.position.z),this.lightNode=new i(this.sunLight,null,null,!0),this.light=this.lightNode._occurrences[0].renderable;var o=(new t.Matrix4).translate(this.sunPos);this.lightNode.setMatrix(o),this._urban.USR._root.add(this.lightNode),void 0!==s.ambientFactor&&(this.ambientFactor=s.ambientFactor),void 0!==s.diffuseFactor&&(this.diffuseFactor=s.diffuseFactor),this.ambientLight=new t.AmbientLight,this.ambientLightNode=new i(this.ambientLight),this.updateLight(this._urban.date)},toupdateLight:function(){!0!==this.lockUpdateLightFlag&&(this.toUpdate=!0)},shadowState:function(e,t){n.log("ShadowState : ",e),this.shadow=t,this.setShadowCascade(e),e&&a.subscribeTo("/3DEXPERIENCity/onUpdate",this.updateShadowParameters.bind(this))},setShadowCascade:function(e){this._urban.USR.webGLV6Viewer.setShadow(e),this.light.castShadow=e,this.light.updateShadowMap=e,this.light.shadowDarkness=this.shadow.darkness,this._urban.USR.webGLV6Viewer.debugShadowLight=this.shadow.visible,this.sunLight.shadowCameraVisible=this.shadow.visible;var t=this.shadow.resolution?this.shadow.resolution:4096,i=!1,r=0;if(this.shadow.bias=[-.001,-.001,-.001],null!==this.light){this._urban.USR.webGLV6Viewer.getRenderer()&&(this._urban.USR.webGLV6Viewer.getRenderer().shadowMapCascade=e),this._urban.USR.webGLV6Viewer.shadowMapWidth=t,this._urban.USR.webGLV6Viewer.shadowMapHeight=t,this.shadowMapWidth===t&&this.shadowMapHeight===t||(i=!0,this.shadowMapWidth=t,this.shadowMapHeight=t,e||(this.light.shadowMap=null,this.light.shadowMapWidth=t,this.light.shadowMapHeight=t)),this.light.shadowCascade=e,this.light.LiSPSM=!1,this.light.shadowCascadeCount=this.shadow.nbShadowMaps?this.shadow.nbShadowMaps:3,this.light.shadowCascadeWidth=[],this.light.shadowCascadeHeight=[],this.light.shadowCascadeBias=[],this.light.shadowCascadeNearZ=[],this.light.shadowCascadeFarZ=[],this.light.shadowCascadeSubNear=[],this.light.shadowCascadeSubFar=[];var s=this._urban.USR.viewpoint._dist2ngp,n=[s-30,Math.max(2*s,10),Math.max(3.5*s,50)],a=[Math.max(2*s,10),Math.max(3.5*s,50),Math.max(5*s,300)];for(r=0;r<this.light.shadowCascadeCount;r++)this.light.shadowCascadeSubNear[r]=-n[r],this.light.shadowCascadeSubFar[r]=-a[r],this.light.shadowCascadeWidth[r]=t,this.light.shadowCascadeHeight[r]=t,this.light.shadowCascadeBias[r]=this.computeBias(r+1,this.shadow.bias),this.light.shadowCameraHelperToUpdate=this.shadow.visible;if(this.light.shadowCascadeOffset.set(0,0,-10),i&&this.light.shadowCascadeArray)for(r=0;r<this.light.shadowCascadeArray.length;r++){var o=this.light.shadowCascadeArray[r];o.shadowMap=null,o.LiSPSM=!1,o.shadowMapWidth=t,o.shadowMapHeight=t,o.shadowBias=this.computeBias(r+1,this.shadow.bias),o.shadowCameraHelperToUpdate=this.shadow.visible}}},computeBias:function(e,t){return void 0===t?1===e?-1e-4:2===e?-5e-4:-.001:t instanceof Array?t[e-1]:t},updateShadowParameters:function(){if(null!==this.light&&this.light.castShadow)for(var e=this._urban.USR.viewpoint._dist2ngp,t=[e-30,Math.max(2*e,10),Math.max(3.5*e,50)],i=[Math.max(2*e,10),Math.max(3.5*e,50),Math.max(5*e,300)],r=0;r<this.light.shadowCascadeCount;r++)this.light.shadowCascadeSubNear[r]=-t[r],this.light.shadowCascadeSubFar[r]=-i[r]},lockUpdateLight:function(){this.lockUpdateLightFlag=!0},unlockUpdateLight:function(){this.lockUpdateLightFlag=!1},updateLight:function(e){this.toUpdate=!1;var i=this.ambientLightNode._occurrences[0].renderable,r=this._urban.getViewpoint().getTarget();this._urban.baseReferential&&this._urban.baseReferential.bbox&&(r.x<this._urban.baseReferential.bbox.xmin&&(r.x=this._urban.baseReferential.bbox.xmin),r.x>this._urban.baseReferential.bbox.xmax&&(r.x=this._urban.baseReferential.bbox.xmax),r.y<this._urban.baseReferential.bbox.ymin&&(r.y=this._urban.baseReferential.bbox.ymin),r.y>this._urban.baseReferential.bbox.ymax&&(r.y=this._urban.baseReferential.bbox.ymax));var n=s.proj(r,s.getDefaultProjection(),"WGS84");this._urban._debugVisualOdt&&(n.x=0,n.y=0);var a=e._date.toString(),o=Math.round(n.x/15);o=o>0&&o<10?"+0"+o+"00":o>=10?"+"+o+"00":o<0&&o>-10?"-0"+Math.abs(o)+"00":o<=-10?"-"+Math.abs(o)+"00":"",a=a.split("GMT")[0]+"GMT"+o;var l=new Date(a);o=n.x/15*60,a=a.split("GMT")[0]+"GMT",(l=new Date(a)).setTime(l.getTime()-60*o*1e3);var h=this.sunCalculator.getPosition(l,n.y,n.x);this.sunDist=1e4;var d=1;this._urban.USR.viewpoint.getDistanceCameraToNearGroundPoint()>1e7?(h.altitude=Math.PI/2,h.azimuth=0,this.altFactor=1,this.altFactorBack=1,this.altFactorIBL=1,d=0):this._urban.USR.viewpoint.getDistanceCameraToNearGroundPoint()>2e6&&(d=1.25*(2e6/this._urban.USR.viewpoint.getDistanceCameraToNearGroundPoint()-.2),h.altitude=(1-d)*(Math.PI/2)+d*h.altitude,h.azimuth=0*(1-d)+d*h.azimuth),this._urban._debugVisualOdt&&(l=e._date,h=this.sunCalculator.getPosition(l,n.y,n.x),d=1);var u=Math.sin(h.altitude),c=Math.cos(h.altitude);this.sunPos.x=this.sunDist*Math.sin(h.azimuth)*c,this.sunPos.y=this.sunDist*Math.cos(h.azimuth)*c,this.sunPos.z=this.sunDist*u;var p=this._urban.USR.viewpoint.target;this.light.target.position.set(p.x,p.y,p.z);var f=new t.Vector3(this.sunPos.x+p.x,this.sunPos.y+p.y,this.sunPos.z+p.z),m=(new t.Matrix4).translate(f);this.lightNode.setMatrix(m);var g=this.sunCalculator.getTimes(l,n.y,n.x),v=g.sunrise.getTime(),_=g.sunset.getTime(),y=g.dawn.getTime(),b=g.dusk.getTime(),x=g.solarNoon.getHours()+.0166667*g.solarNoon.getMinutes(),C=l.getHours(),S=C+.0166667*l.getMinutes();if(this._urban._debugVisualOdt){var D=this.getDayAltitudes(e,n);D=this.normAltitude(D,0,1,!0);var P=this.getDayAltitudes(e,n);P=this.normAltitude(P,.2,1);var w=this.getDayAltitudes(e,n);w=this.normAltitude(w,.1,1),this.altFactor=isNaN(D[C])?1:D[C],this.altFactorBack=isNaN(P[C])?1:P[C],this.altFactorIBL=isNaN(w[C])?1:w[C],this.ambientValue=Math.max(5.3*this.ambientFactor,.07),this.diffuseValue=this.diffuseFactor*D[C]*5.3}else{var M=(b-y)/36e5,T=M/2,I=x/T,R=(-1+I)*T,A=(1+I)*T;R<0&&S>R+24?(I=(x+24)/T,this.altFactorBack=1-Math.pow(S/T-I,16)):A>24&&S<A-24?(I=(x-24)/T,this.altFactorBack=1-Math.pow(S/T-I,16)):isNaN(M)||(this.altFactorBack=1-Math.pow(S/T-I,16)),isNaN(M)&&(this.altFactorBack=1),this.altFactorIBL=this.altFactorBack,this.altFactorBack<0&&(this.altFactorBack=0),this.altFactorIBL<.1&&(this.altFactorIBL=.1);var F=(_-v)/36e5,L=F/2,V=x/L,O=(-1+V)*L,N=(1+V)*L;O<0&&S>O+24?(V=(x+24)/L,this.altFactor=1-Math.pow(S/L-V,16)):N>24&&S<N-24?(V=(x-24)/L,this.altFactor=1-Math.pow(S/L-V,16)):isNaN(F)||(this.altFactor=1-Math.pow(S/L-V,16)),isNaN(F)&&(this.altFactor=1),this.altFactor<0&&(this.altFactor=0),this.altFactor=d*this.altFactor+1*(1-d),this.altFactorIBL=d*this.altFactorIBL+1*(1-d),this.altFactorBack=d*this.altFactorBack+1*(1-d)}if(this._urban.environment&&this._urban.environment.sky&&this._urban.environment.sky.updateSun){if(this._urban.environment.sky.lensFlare){var U=new t.Vector3(10*this._urban.worldSize*this.sunPos.x+p.x,10*this._urban.worldSize*this.sunPos.y+p.y,10*this._urban.worldSize*this.sunPos.z+p.z),E=(new t.Matrix4).translate(U);this._urban.environment.sky.lensFlare.node1s.setMatrix(E)}this._urban.environment.sky.updateSun();var k=this._urban.environment.sky.getSunInfo(h.azimuth,h.altitude);this.light.color.setRGB(1.2*k.d.r,1.2*k.d.g,1.2*k.d.b),i.color.setRGB(.8*k.a.r,.8*k.a.g,.8*k.a.b),this._urban.environment.slab._infPlaneMaterial.getPDSFXUniform("skyColor").value.setRGB(k.a.r,k.a.g,k.a.b),this.AmbientIntensity=this.ambientFactor,this.light.intensity=this.diffuseFactor*this.diffuseFactor,this.light.intensity*=Math.PI,i.intensity=this.ambientFactor}else this.diffuseValue=this.diffuseFactor*this.altFactor*5.3*.5,this.light.intensity=this.diffuseValue,debugWebGLV6Viewer.ambience.getBackground().setIntensity(this.altFactorBack*this.ambientFactor*5.3*.25),debugWebGLV6Viewer.ambience.getEnvironmentLight().setIntensity(this.altFactorIBL*this.ambientFactor*5.3*.25)},getDayAltitudes:function(e,t){for(var i=e.getDate().getHours(),r=[],s=e.valueOf(),n=0;n<24;n++){s.getDate().setHours(n);var a=this.sunCalculator.getPosition(s.getDate(),t.y,t.x);r[n]=a.altitude}return this._urban.date.getDate().setHours(i),r},verbose:function(){n.log("Sun pos is   ",this.sunLight.position),n.log("Sun color is ",this.sunLight.color)},getPos:function(){return this.sunLight.position},setPos:function(e){this.sunLight.position=e},setAltitude:function(e){this.sunLight.position.z=e},getColor:function(){return this.sunLight.color},setColor:function(e){this.sunLight.color.setHex(e)},normAltitude:function(e,t,i,r){var s=0,n=0;if(void 0===t&&(t=0),void 0===i&&(i=1),r)for(var a=0;a<e.length;a++)e[a]<0&&(e[a]=0);for(a=0;a<e.length;a++)(e[a]<n||0==n)&&(n=e[a]);for(a=0;a<e.length;a++)e[a]+=Math.abs(n);n+=Math.abs(n);for(a=0;a<e.length;a++)(e[a]>s||0==s)&&(s=e[a]);for(a=0;a<e.length;a++)e[a]=(e[a]-n)/(s-n);if(0!==t||1!==i)for(a=0;a<e.length;a++)e[a]=t+e[a]*(i-t);return e},setDiffuseFactor:function(e){this.diffuseFactor=e,this.toupdateLight(),a.publish(a.eventsList[this.changeEventName+".diffuseFactor"],e)},setAmbientFactor:function(e){this.ambientFactor=e,debugWebGLV6Viewer.ambience.getEnvironmentLight().setIntensity(this.altFactor*this.ambientFactor),a.publish(a.eventsList[this.changeEventName+".ambientFactor"],e)}})}),define("DS/XCityEffects/HeatMapRTree",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/XCityEffects/HeatMapRTreeShader","DS/Plugins/ClearPass","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/XCityTools/ShaderTools","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s,n,a,o,l,h,d,u){"use strict";return t.extend({init:function(t,o,l,h){this._parent(t.renderer);this.doNotUpdateYet=!0,this.urban=l,this._rptree=null,this.M=10,this.m=this.M/2,this.shaderLoopSize=n.ShaderLoopSize,this.renderer=t,this.__renderer=t.renderer,this.renderTargetPool=o,this.nbCamera=0,this.indexCamera=0,this.cameraList={},this.rtList={},this.depthRenderPasses=[],this.availableViewshedComposer=[],this.near=.1,this.far=1e3,this.aspect=2,this.fov=1,this.bias=1e-5,this.passesNoScene=[],this.currentCompareDepthsPass=void 0;var d=new e.WebGLRenderTargetProperties(this.width,this.height,"nearest"),u=new i(this.__renderer,d,o);u.name="depthCurrentEffectComposer",u.composerContext.keepResult=!0,this.composers.push(u);var c=new a("depthCurrentCameraClearPass"),p=new r(null,null,null,void 0,void 0,void 0,"depthCurrentCameraRenderPass");p.setDisableBackFaceCulling(!0),p.setMaterialToUse(e.MaterialToUse.normalDepthMaterial),p.cameraName="main",this.passesNoScene.push(p),this.composers[0].addPass(c),this.composers[0].addPass(p),this.composers[0].composerContext.setPassClear(c,!0,new e.Color(16777215),0),this.composers[0].enablePass(c,!0),this.composers[0].enablePass(p,!0);var f=this.urban.getViewpoint();f._renderedCamera.matrixWorldInverse=f.camera.matrixWorldInverse.getInverse(f.camera.matrixWorld),f._renderedCamera.projectionMatrixInverse=f.camera.projectionMatrixInverse.getInverse(f.camera.projectionMatrix),this.mixPass=new s(n.FinalBlending,void 0,"heatmapPostProcessCustom"),this.mixPass.uniforms.realProjectionMatrixInverse.value=f.camera.projectionMatrixInverse,this.mixPass.uniforms.realViewMatrixInverse.value=f.camera.matrixWorld,void 0!==this.urban.cropBox?this.mixPass.uniforms.worldSize.value=new e.Vector2(this.urban.cropBox._size.x,this.urban.cropBox._size.y):this.mixPass.uniforms.worldSize.value=new e.Vector2(this.urban.worldSize,this.urban.worldSize),this.mixPass.uniforms.points.value=[];for(var m=0;m<this.shaderLoopSize;m++)this.mixPass.uniforms.points.value.push(new e.Vector4);return this.mixPass.uniforms.shift.value=f._camShiftedTranslation,this.mixPass.uniforms.nbPoints=0,this.mixPass.compileShader(this.__renderer),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.zBuffer),this.mixPass.addRequiredComposer(this.composers[0]),this.max=0,this.count=0,this},addPoint:function(e){null===this._rptree?this._rptree=this.buildTree([e],this.m,this.M):(this.count++,this._rptree.insert(e))},computeScales:function(){this._rptree.computeScales()},disableEffect:function(){this.enabled&&(this.enabled=!1,this.renderer.mainComposer.removeCustomPassNEW([this.mixPass]))},enableEffect:function(){this.enabled||(this.enabled=!0,this.renderer.mainComposer.insertCustomPassBeforeNEW(this.mixPass,"postEffects1"),this.renderer.compForwardComposerContext.enablePass(this.mixPass,!0))},pauseCamera:function(){},initEffect:function(e,t){e&&(this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0),this.insertComposerCustom(t,this.composers[2],this.mixPass,!0)},insertComposerCustom:function(t,i,r,s){e.mobileVersion||(null!==i&&t.composers.push(i),s&&(r.disabledByDefault=!0),t.mainComposer.insertCustomPassBeforeNEW(r,"postEffects1"),this.mixPass.composer=t.mainComposer,t.compForwardComposerContext.enablePass(r,!0),t.updateFinalComposer(!0))},update:function(t,i,r,s){for(;this.passesNoScene.length>0;)console.warn("heatmaprtree initialized"),this.passesNoScene.pop().setScene(i.scene);this.updateCameraUniforms(r);var a,o=this.getVisiblePoints(),l=0;if(d.is(o)){var h=o.visiblePoints,c=o.maxMag,p=h.length;for(u.publish(u.eventsList["heatmapTool.onChange:numberOfPoint"],p),p>n.ShaderLoopSize&&console.warn("Overload points number",p),p>this.max&&(this.max=p),l=Math.min(this.shaderLoopSize,h.length),a=0;a<l;a++)this.mixPass.uniforms.points.value[a]=h[a];this.mixPass.uniforms.maxMag.value=c,this.mixPass.uniforms.nHits.value=this.factories[this.activeFactory]._content._nhitsTotal}for(a=l;a<this.shaderLoopSize;a++)this.mixPass.uniforms.points.value[a]=new e.Vector4},updateCameraUniforms:function(e){e._renderedCamera.projectionMatrixInverse=e.camera.projectionMatrixInverse.getInverse(e.camera.projectionMatrix),e._renderedCamera.matrixWorldInverse=e.camera.matrixWorldInverse.getInverse(e.camera.matrixWorld),this.mixPass.uniforms.realProjectionMatrixInverse.value=e.camera.projectionMatrixInverse,this.mixPass.uniforms.realViewMatrixInverse.value=e._renderedCamera.matrixWorld;var t=this.urban.getViewpoint();this.mixPass.uniforms.shift.value=t._camShiftedTranslation},setSize:function(e,t,i){if(this._parent(e,t)||i)for(var r=0;r<this.composers.length;++r)this.composers[r].setSize(this.width,this.height)},getMaxIteration:function(){return 0},changeFar:function(e,t){},changeNear:function(e,t){},changeFov:function(e,t){},changeAspect:function(e,t){},changeBias:function(e,t){},setColors:function(e,t,i){},addFactory:function(e){for(var t in d.is(this.factories)||(this.factories={}),this.factories)delete this.factories[t];var i=e._content.get("id");this.activeFactory=i,this.factories[i]=e},removeFactory:function(e){var t=e._content.get("id");d.is(this.factories[t])&&delete this.factories[t];var i=!1;return 0===Object.keys(this.factories).length&&(this.factories=null,i=!0),i},getVisiblePoints:function(){if(d.is(this.factories)){var e,t,i=Object.keys(this.factories),r=i.length;for(t=0;t<r;t++)if(e=this.factories[i[t]],d.is(e))return e.getVisiblePoints()}},_computeMagnitudeForPoint:function(t,i){for(var r=0,s=new e.Vector2(t.x,t.y),n=0;n<i.length;n++){var a=i[n].z,o=i[n].w,l=a,h=new e.Vector2(i[n].x,i[n].y),d=s.distanceTo(h);r+=(1-Math.min(d,l)/l)*o}return r},generateTextureFromPoints:function(t){for(var i=new Float32Array(4194304),r=0;r<1048576;r++)i[4*r]=0,i[4*r+1]=0,i[4*r+2]=0,i[4*r+3]=0;for(r=0;r<t.length;r++){var s=t[r];i[4*r]=s.x,i[4*r+1]=s.y,i[4*r+2]=s.z,i[4*r+3]=s.w}var n=new e.DataTexture(i,1024,1024,e.RGBAFormat,e.FloatType);return n.needsUpdate=!0,n},buildTree:function(e,t,i){return null}})}),define("DS/XCityTools/AtlasPacker",["UWA/Class","DS/xCityBasicUtils/Utils","DS/XCityTools/AtlasNode","DS/XCityTools/AtlasBlock"],function(e,t,i,r){"use strict";return e.extend({init:function(e,t,i){this.BlockList=[],this._roots=[],this._atlasMaxWidth=null,this._atlasMaxHeight=null,this._powerOfTwo=null,this._atlasMaxWidth=e,this._atlasMaxHeight=t,this._powerOfTwo=i},makeBlock:function(e){var t=new r(e);return this.BlockList.push(t),t},getBlock:function(e){return this.BlockList[e]},getBlockCount:function(){return this.BlockList.length},clearBlocks:function(){this.BlockList=[],this._roots=[]},getAtlasCount:function(){return this._roots.length},getAtlasWidth:function(e){return this._roots[e].width},getAtlasHeight:function(e){return this._roots[e].height},getBlocksInAtlasByIndex:function(e){var i,r,s=this.BlockList.length;for(i=0;i<s;i++){var n=this.BlockList[i];n.getPacked()&&n._fit.Index===e&&(t.is(r)||(r=[]),r.push(n))}return r},sortBlockList:function(){this.BlockList.sort(function(e,t){return e.getWidth()>t.getWidth()?-1:e.getWidth()<t.getWidth()?1:e.getHeight()>t.getHeight()?-1:e.getHeight()<t.getHeight()?1:0})},Build:function(){if(this._roots.push(new i(0,0,0,0)),this._roots[0].Index=0,0!==this.BlockList.length){this.sortBlockList(),this._roots[0].width=this.BlockList[0].getWidth(),this._roots[0].height=this.BlockList[0].getHeight();var e,t,r,s,n=this.BlockList.length,a=this._roots.length;for(e=0;e<n;e++){var o=this.BlockList[e];if(o.getWidth()>this._atlasMaxWidth||o.getHeight()>this._atlasMaxHeight);else{for(t=0;t<a;t++){var l=!0,h=(r=this._roots[t]).block;if(null!==h&&(l=h.isCompatibleWith(o)),l){if(null!==(s=this.findNode(r,o.getWidth(),o.getHeight()))){o._fit=this.splitNode(s,o.getWidth(),o.getHeight()),o._fit.block=o,o.rootNode=r;break}if(o._fit=this._powerOfTwo?this.growNodeP2(r,o.getWidth(),o.getHeight()):this.growNode(r,o.getWidth(),o.getHeight()),null!=o._fit){o._fit.block=o,o.rootNode=r;break}}}null===o._fit&&((r=new i(0,0,o.getWidth(),o.getHeight())).Index=this._roots.length,this._roots.push(r),null!==(s=this.findNode(r,o.getWidth(),o.getHeight()))&&(o._fit=this.splitNode(s,o.getWidth(),o.getHeight()),o._fit.block=o,o.rootNode=r))}}}},nextPowerOf2:function(e){var t=Math.log(e)/Math.log(2),i=Math.floor(Math.ceil(t));return Math.floor(Math.pow(2,i))},findNode:function(e,t,i){if(e.used){var r=this.findNode(e.right,t,i);return null===r&&(r=this.findNode(e.down,t,i)),r}return t<=e.width&&i<=e.height?e:null},splitNode:function(e,t,r){return e.used=!0,e.width-t>e.height-r?(e.down=new i(e.x,e.y+r,e.width,e.height-r),e.right=new i(e.x+t,e.y,e.width-t,r)):(e.down=new i(e.x,e.y+r,t,e.height-r),e.right=new i(e.x+t,e.y,e.width-t,e.height)),e.down.Index=e.Index,e.right.Index=e.Index,e},growNodeP2:function(e,t,i){var r=this.nextPowerOf2(e.height+i),s=this.nextPowerOf2(e.width+t),n=t<=e.width&&r<=this._atlasMaxHeight,a=i<=e.height&&s<=this._atlasMaxWidth,o=a&&e.height>=s,l=n&&e.width>=r;return o?this.growRight(e,s-e.width,i):l?this.growDown(e,t,r-e.height):a?this.growRight(e,s-e.width,i):n?this.growDown(e,t,r-e.height):null},growNode:function(e,t,i){var r=t<=e.width&&e.height+i<=this._atlasMaxHeight,s=i<=e.height&&e.width+t<=this._atlasMaxWidth,n=s&&e.height>=e.width+t,a=r&&e.width>=e.height+i;return n?this.growRight(e,t,i):a?this.growDown(e,t,i):s?this.growRight(e,t,i):r?this.growDown(e,t,i):null},growRight:function(e,t,r){var s=new i(e.x,e.y,e.width,e.height);s.used=e.used,s.Index=e.Index,s.down=e.down,s.right=e.right,e.width=e.width+t,e.down=s,e.right=new i(s.width,0,t,s.height),e.right.Index=e.Index;var n;return null!==(n=this.findNode(e,t,r))?this.splitNode(n,t,r):null},growDown:function(e,t,r){var s=new i(e.x,e.y,e.width,e.height);s.used=e.used,s.Index=e.Index,s.down=e.down,s.right=e.right,e.height=e.height+r,e.down=new i(0,s.height,s.width,r),e.down.Index=e.Index,e.right=s;var n;return null!==(n=this.findNode(e,t,r))?this.splitNode(n,t,r):null}})}),define("DS/XCityTools/TextureManager",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/AtlasPacker","DS/XCityTools/TextureTools","DS/XCityTools/Downloader"],function(e,t,i,r,s,n){"use strict";var a=e.singleton({init:function(){this._textures={},this._atlases={},this._waitingList={},this._waiting=!1},ATLASSIZE:800,COMPLETESTATUS:"complete",FAILURESTATUS:"failed",LOADINGSTATUS:"loading",addTexture:function(e,t){i.is(this._textures[e])&&(this._textures[e].shared--,this._textures[e]=null),this._textures[e]=t,i.is(t.shared)?t.shared++:t.shared=1},getTexture:function(e){var t;return i.is(e)&&(i.is(this._atlases)&&i.is(this._atlases[e])&&(t=this._atlases[e].atlas),!i.is(t)&&i.is(this._textures)&&(t=this._textures[e])),t},getTexturesToLoad:function(e){var t,r,s,n,o,l,h=[],d=Object.keys(e),u=d.length;for(t=0;t<u;t++){var c=(r=d[t]).indexOf("Url");if(c>-1&&c===r.length-3){o=(l=(s=r.slice(0,c))+"Atlas")+"Id",n=e[r],h.push({url:n,paramUrl:r,param:s,atlas:l,atlasId:o});var p=a.getTexture(n);i.is(p)&&(e[s]=p),p=a.getTexture(e[o]),i.is(p)&&(e[l]=p)}}return h},getOrDownloadTexture:function(e,t){var r=this.getTexture(e);return i.is(r)?i.is(t)&&t(r,!0,e):this.downloadTexture(e,t),r},textureDownloaded:function(e,t,r){if(i.is(this._waitingList[e])){r||(Utils.is(this._failureList)||(this._failureList={}),this._failureList[e]={});for(var s=this._waitingList[e].callbacks,n=0;n<s.length;n++)Utils.is(s[n])&&s[n](t,r,e);delete this._waitingList[e]}Object.keys(this._waitingList).length<=0&&this.allTexturesLoaded()},allTexturesLoaded:function(){if(i.is(this._doneCallbacks)){var e,t,r=this._doneCallbacks.length;for(e=0;e<r;e++)t=this._doneCallbacks[e],i.is(t)&&t()}this._doneCallbacks=null,this._waiting=!1},callWhenDoneOnce:function(e){this._waiting?(i.is(this._doneCallbacks)||(this._doneCallbacks=[]),this._doneCallbacks.push(e)):e()},isAnAtlas:function(e){return i.is(this._atlases[e])},addCallbackToAtlas:function(e,t){var r=this._atlases[e];i.is(r)&&i.is(t)&&(this.isComplete(e)?t(this._atlases[e]):(i.is(r.callbacks)||(r.callbacks=[]),r.callbacks.push(t)))},downloadTexture:function(e,t){if(this.isAnAtlas(e))this.addCallbackToAtlas(e,t);else if(i.is(this._waitingList[e]))i.is(t)&&this._waitingList[e].callbacks.push(t);else{this._waitingList[e]={status:this.LOADINGSTATUS,callbacks:[]},this._waiting=!0;var r=this;n.loadTexture(function(i,s,n){t(i,s,e),r.textureDownloaded(e,i,s)},e,999999)}},getorDownloadAlltextures:function(e,t){var i=0,r=e.length;for(i=0;i<r;i++){var s=e[i];this.getOrDownloadTexture(s,t)}},shouldLoadMap:function(e,t){if(i.is(e)){if(!i.is(t))return!0;if(t.name&&"DefaultWhiteTexture"===t.name)return!0}return!1},makeAtlasFromUrls:function(e,t){var r;if(i.is(e))if(r=this.getAtlasFromUrls(e),i.is(r))this.getOrDownloadTexture(r,t);else{r=this.addAtlas(e);var s=e.length,n=this,a={};this.getorDownloadAlltextures(e,function(e,i,o){if(i){if(s--,a[o]=e,s<=0){var l=n.makeAtlasFromTextures(r,a);t&&t(l)}}else console.error("texture could not be loaded",o),console.error("atlas could not be created")})}return r},getAtlasFromUrls:function(e){var t,i,r,s,n=Object.keys(this._atlases),a=n.length;for(t=0;t<a;t++){i=n[t],r=this._atlases[i];var o=e.indexOf(i);if(s=o>=0?(s=e.slice(0,o)).concat(e.slice(o+1,e.length)):e.slice(),!this.doesAtlasHaveAllMaps(r,s))break}return t<a?i:null},doesAtlasHaveMap:function(e,t){return i.is(e.urls[t])},doesAtlasHaveAllMaps:function(e,t){var i,r,s=t.length;for(i=0;i<s&&(r=t[i],this.doesAtlasHaveMap(e,r));i++);return i<s},findnewatlasId:function(){for(var e=0,t="atlas."+e;i.is(this._atlases[t]);)e++,t=t.split(".")[0]+"."+e;return t},addAtlas:function(e){var t=this.findnewatlasId();i.is(this._atlases[t])&&(t=this.findnewatlasId()),this._atlases[t]={_status:this.LOADINGSTATUS,urls:{}};var r,s,n=e.length;for(r=0;r<n;r++)s=e[r],this._atlases[t].urls[s]=!0;return t},prepareTexture:function(e,t){var i={texture:e,url:t,getWidth:function(){return this.texture.image.width},getHeight:function(){return this.texture.image.height},getUrl:function(){return this.url}};return i},makeAtlasFromTextures:function(e,t){var i,s,n=new r(1/0,1/0,!1),a=0,o=Object.keys(t),l=o.length;for(a=0;a<l;a++){s=o[a];var h=this.prepareTexture(t[s],s);n.makeBlock(h)}return n.Build(),n.getAtlasCount()>1?(console.error("atlas too big no complete rendering is possible"),i=null):(this.completeAtlas(e,n),i=this.getAtlas(e)),i},getAtlas:function(e){return this._atlases[e]},completeAtlas:function(e,t){this._atlases[e].blockList=t.getBlocksInAtlasByIndex(0),this._atlases[e].width=t.getAtlasWidth(0),this._atlases[e].height=t.getAtlasHeight(0);var r=s.generateAtlasFromBlocks(this._atlases[e].blockList,this._atlases[e].width,this._atlases[e].height);this._atlases[e].atlas=r,this._atlases[e]._status=this.COMPLETESTATUS,this._atlases[e].X=[],this._atlases[e].Y=[],this._atlases[e].W=[],this._atlases[e].H=[];var n,a,o,l,h,d=this._atlases[e].blockList,u=d.length,c=this._atlases[e].width,p=this._atlases[e].height;for(n=0;n<u;n++){var f=d[n],m=f.texture.url;this._atlases[e].urls[m]=n,a=f.getX()/c,o=(p-(f.getY()+f.getHeight()))/p,l=f.getWidth()/c,h=f.getHeight()/p,this._atlases[e].X.push(a),this._atlases[e].Y.push(o),this._atlases[e].W.push(l),this._atlases[e].H.push(h)}if(i.is(this._atlases[e].callbacks)){for(u=this._atlases[e].callbacks.length,n=0;n<u;n++)this._atlases[e].callbacks[n](r);this._atlases[e].callbacks=null}},getTextureInfoByIndex:function(e,t){var r=null;if(i.is(e)&&i.is(this._atlases[e])&&i.is(this._atlases[e].blockList)){this._atlases[e].blockList[t];var s=this._atlases[e].width,n=this._atlases[e].height;r={index:t,x:this._atlases[e].X[t],y:this._atlases[e].Y[t],width:this._atlases[e].W[t],height:this._atlases[e].H[t],atlasWidth:s,atlasHeight:n}}return r},getTextureInfoByUrl:function(e,t){var r=null;if(i.is(t)){var s=this.getAtlas(t);if(this.doesAtlasHaveMap(s,e)){var n=this.getTextureIndex(t,e);r=this.getTextureInfoByIndex(t,n)}}else if(i.is(this._textures[e])){var a=this._textures[e];r={index:0,width:a.image.width,height:a.image.height}}else if(i.is(this._waitingList[e])&&i.is(this._waitingList[e].output)){var o=this._waitingList[e].output;r={index:0,width:o.width,height:o.height,texturenotloaded:!0}}return r},getTextureIndex:function(e,t){var r=0;if(i.is(e)&&i.is(this._atlases[e])&&(this.isComplete(e)||(r=null),i.is(this._atlases[e].urls)&&i.is(this._atlases[e].urls[t]))){var s=this._atlases[e].urls[t];!0!==s&&(r=s)}return r},isComplete:function(e){var t=!1;return i.is(this._atlases[e])&&this._atlases[e]._status===this.COMPLETESTATUS&&(t=!0),t},getAtlasDescription:function(e){return i.is(this._atlases[e])?this.isComplete(e)?{x:this._atlases[e].X,y:this._atlases[e].Y,width:this._atlases[e].W,height:this._atlases[e].H}:null:{x:[0],y:[0],width:[1],height:[1]}},getAtlasSize:function(e){return i.is(this._atlases[e])&&this.isComplete(e)?{width:this._atlases[e].width,height:this._atlases[e].height}:null},isWaitingForTextures:function(){return this._waiting},waitForTexture:function(e,t){i.is(t)&&(i.is(this._waitingList[e])?this._waitingList[e].status===this.LOADINGSTATUS?this._waitingList[e].callbacks.push(t):Utils.is(this._failureList[e])?t(null,!1,e):this._waitingList[e].status===this.COMPLETESTATUS&&t(this.getTexture(e),!0,e):(this._waitingList[e]={status:this.LOADINGSTATUS,callbacks:[t]},this._waiting=!0))},getOrCreateGlypheTexure:function(e,t,i){var r=this.getTexture(e);if(Utils.is(r))return r;if(Utils.is(this._waitingList[e]))return this.waitForTexture(e,i),this._waitingList[e].output;var n=this,a=s.generateGlypheTexture(t.name,t,function(t){n.textureDownloaded(e,t,!0),n.addTexture(e,t)});return this._waitingList[e]={status:this.LOADINGSTATUS,callbacks:[i],output:a},a},removeTexture:function(e){var t=this.getTexture(e);if(i.is(t))i.is(t.shared)&&t.shared--,delete this._textures[e];else if(i.is(this._waitingList[e])){var r=this;this.waitForTexture(e,function(t,i,s){setTimeout(r.removeTexture.bind(r,e),1e3)})}else i.is(this._failureList)&&i.is(this._failureList[e])&&console.warn("texture could not be loaded, you cannot remove it ...")}});return a}),define("DS/XCityTools/RenderingTools",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/ColorGradient","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils","DS/XCityTools/Expression","DS/XCityTools/ShaderTools","DS/XCityTools/TextureManager"],function(e,t,i,r,s,n,a,o){"use strict";var l=e.singleton({init:function(){},getJSONFromRendering:function(e){return l._RenderingToJSON(e)},_CollectionToRendering:function(e,t){var i=e;if(s.is(e)){var r,n,a,o,h=Object.keys(e),d=h.length;if(s.is(t.init))i=t.init(e);else if(s.is(t.collectionType)){var u=l._types[t.collectionType];if(s.is(u))for(r=0;r<d;r++)a=e[n=h[r]],s.is(a)&&(o=l._initAttributeValue(a,u)),s.is(i)||(i=Array.isArray(e)?[]:{}),i[n]=o}}return i},_boundAttributeValue:function(e,t){var i=e;if(Array.isArray(e)){for(var r=0;r<e.length;r++)e[r]=l._boundAttributeValue(e[r],t);return e}return"number"==typeof i&&(s.is(t.min)&&(i=Math.max(i,t.min)),s.is(t.max)&&(i=Math.min(i,t.max))),s.is(t.valuesIn)&&(i=t.valuesIn[i],s.is(i)||(i=void 0)),i},_initSimpleAttributeValue:function(e,t){var i;return i=s.is(t.init)?t.init(e):l._types.none.init(e),i=l._boundAttributeValue(i,t)},_initAttributeValue:function(e,t){var i;return s.is(t)&&(i=s.is(t.children)?l._JSONToRendering(e,t.children):s.is(t.collectionType)?l._CollectionToRendering(e,t):l._initSimpleAttributeValue(e,t)),i},_JSONToRendering:function(e,t){if(!s.is(e))return null;s.is(t)||(t=l._renderingParams);var i,r,n=Object.keys(e),a=n.length,o={};for(i=0;i<a;i++){"_alphaTest"===(r=n[i])&&(r="alphaTest"),"_transparent"===r&&(r="transparent"),"_opacity"===r&&(r="opacity"),"_visible"===r&&(r="visible"),"_side"===r&&(r="side");var h=t[r];if(s.is(h)){var d,u=e[r],c=l._types[h];d=l._initAttributeValue(u,c),o[r]=d}}return o},_RenderingToRendering:function(e,t,i){if(s.is(e)&&s.is(t)){s.is(i)||(i=l._renderingParams);var r,n,a=Object.keys(t),o=a.length;for(n=0;n<o;n++){"_alphaTest"===(r=a[n])&&(r="alphaTest"),"_transparent"===r&&(r="transparent"),"_opacity"===r&&(r="opacity"),"_visible"===r&&(r="visible"),"_side"===r&&(r="side");var h=i[r];if(s.is(h)){var d,u=l._types[h];s.is(u.children)?(d=s.is(e[r])?e[r]:{},l._RenderingToRendering(d,t[r],u.children),e[r]=d):s.is(u.copy)?u.copy(e,t,r):l._types.none.copy(e,t,r)}}}},_RemoveRendering:function(e,t,i){if(s.is(e)&&s.is(t)){s.is(i)||(i=l._renderingParams);var r,n,a=Object.keys(t),o=a.length;for(n=0;n<o;n++){"_alphaTest"===(r=a[n])&&(r="alphaTest"),"_transparent"===r&&(r="transparent"),"_opacity"===r&&(r="opacity"),"_visible"===r&&(r="visible"),"_side"===r&&(r="side");var h=i[r];if(s.is(h)){var d=l._types[h];s.is(d.remove)?d.remove(e,t,r):l._types.none.remove(e,t,r)}}}},_RenderingToRenderingNoAdd:function(e,t,i){var r;if(s.is(e)&&s.is(t))for(r in s.is(i)||(i=l._renderingParams),t)if(t.hasOwnProperty(r)&&("_alphaTest"===r&&(r="alphaTest"),"_transparent"===r&&(r="transparent"),"_opacity"===r&&(r="opacity"),"_visible"===r&&(r="visible"),"_side"===r&&(r="side"),void 0!==e[r])){var n,a=i[r];if(!s.is(a))continue;var o=l._types[a];s.is(o.children)?(n={},l._RenderingToRendering(n,t[r],o.children),e[r]=n):s.is(o.copy)?o.copy(e,t,r):l._types.none.copy(e,t,r)}},_RenderingToJSON:function(e,t){if(!s.is(e))return null;s.is(t)||(t=l._renderingParams);var i,r={};for(i in e)if(e.hasOwnProperty(i)){"_alphaTest"===i&&(i="alphaTest"),"_transparent"===i&&(i="transparent"),"_opacity"===i&&(i="opacity"),"_visible"===i&&(i="visible"),"_side"===i&&(i="side");var n=t[i];if(!s.is(n))continue;var a,o=e[i],h=l._types[n];s.is(h.children)?a=l._RenderingToJSON(o,h.children):(a=s.is(h.save)?h.save(o):l._types.none.save(o),s.is(h.valuesOut)&&(a=h.valuesOut[a])),r[i]=a}return r},_RenderingToJSONExpression:function(e,t){if(!s.is(e))return null;s.is(t)||(t=l._renderingParams);var i,r={};for(i in e)if(e.hasOwnProperty(i)){"_alphaTest"===i&&(i="alphaTest"),"_transparent"===i&&(i="transparent"),"_opacity"===i&&(i="opacity"),"_visible"===i&&(i="visible"),"_side"===i&&(i="side");var n=t[i];if(!s.is(n))continue;var a,o=e[i],h=l._types[n];s.is(h.children)?a=l._RenderingToJSONExpression(o,h.children):(a=s.is(h.addexpression)?h.addexpression(o):l._types.none.addexpression(o),s.is(h.valuesOut)&&(a=h.valuesOut[a])),r[i]=a}return r},_ExpressionToEval:function(e,t,i){if(!s.is(e))return null;s.is(i)||(i=l._renderingParams);var r,n={};for(r in e)if(e.hasOwnProperty(r)){"_alphaTest"===r&&(r="alphaTest"),"_transparent"===r&&(r="transparent"),"_opacity"===r&&(r="opacity"),"_visible"===r&&(r="visible"),"_side"===r&&(r="side");var a=i[r];if(!s.is(a))continue;var o,h=e[r],d=l._types[a];s.is(d.children)?o=l._ExpressionToEval(h,t,d.children):(o=s.is(d.evaluateexpression)?d.evaluateexpression(h,t):l._types.none.evaluateexpression(h,t),s.is(d.valuesOut)&&(o=d.valuesOut[o])),n[r]=o}return n},_setMaterialFromProfile:function(e,t){l._RenderingToRendering(e,t)},_setMaterialFromProfileNoAdd:function(e,t){l._RenderingToRenderingNoAdd(e,t)},_setColor:function(e,i,r){s.is(i[r])&&("string"==typeof i[r]?l._setValue(e,i,r):(s.is(e[r])&&e[r]instanceof t.Vector3||(e[r]=new t.Color),e[r].copy(i[r])))},_setVector2:function(e,i,r){s.is(i[r])&&("string"==typeof i[r]?l._setValue(e,i,r):(s.is(e[r])&&e[r]instanceof t.Vector2||(e[r]=new t.Vector2),e[r].copy(i[r])))},_setVector3:function(e,i,r){s.is(i[r])&&("string"==typeof i[r]?l._setValue(e,i,r):(s.is(e[r])&&e[r]instanceof t.Vector3||(e[r]=new t.Vector3),e[r].copy(i[r])))},_setValue:function(e,t,i){s.is(t[i])&&(e[i]=t[i])},_setArrayOrNull:function(e,t,i){s.is(t[i])&&s.is(t[i].slice)?e[i]=t[i].slice():l._setEvenIfNull(e,t,i)},_setMapUrl:function(e,t,i){var r=i;void 0!==t[r]&&(e[r]=t[r])},_setEvenIfNull:function(e,t,i){void 0!==t[i]&&(e[i]=t[i])},_setMap:function(e,i,r){void 0!==i[r]&&(e[r]=i[r],e instanceof t.Material&&e.isPDSFX()&&"map"===r&&(null===i[r]||s.is(i[r+"Params"])&&!1===i[r+"Params"].enable)&&(e[r]=a.whiteMap))},_setDiffuseAndAmbient:function(e,t,i){if(s.is(t[i])){var r="ambient";s.is(t.diffuse)||(t.diffuse=t[i]),l._setColorGradient(e,t,"diffuse"),s.is(t[r])||(t[r]=t[i]),l._setColorGradient(e,t,r),l._setColorGradient(e,t,i)}},_setColorGradient:function(e,t,r){s.is(t[r])&&("string"==typeof t[r]?l._setValue(e,t,r):s.is(e[r])&&e[r]instanceof i?e[r].copy(t[r]):e[r]=new i(t[r]))},_setAlphaTest:function(e,i,r){s.is(i[r])&&(e instanceof t.Material?s.is(e[r])&&(s.is(e.defines)&&s.is(e.defines.ALPHATEST)?(e.defines.ALPHATEST=i[r],e.alphaTest=0):e.isPDSFX()?(e[r+"City"]=i[r],s.is(e.alphaTest)&&(e.alphaTest=0)):e[r]=i[r]):e[r]=i[r])},_setPlusUpdateMaterial:function(e,i,r){s.is(i[r])&&(e instanceof t.Material?s.is(e[r])&&s.is(e.needsUpdate)&&e[r]!==i[r]&&(e.needsUpdate=!0,e[r]=i[r]):e[r]=i[r])},_initDashPattern:function(e){var i;if(s.is(e)){var r=e;e instanceof t.Vector2&&(r=[e.x,e.y]),e instanceof t.Vector3&&(r=[e.x,e.y,e.z]);var n,a=r.length;if(s.is(a)&&a>0){var o=a;for(o%2&&(o*=2),i=new Float32Array(o),n=0;n<o;n++)i[n]=r[n%a],n>0&&(i[n]+=i[n-1])}}return i},_initValue:function(e){return e},_initColor:function(e){"object"==typeof e&&(e="rgb("+Math.floor(255*e.r)+","+Math.floor(255*e.g)+","+Math.floor(255*e.b)+")");return new t.Color(e)},_initColorGradient:function(e){if(s.is(e)){var r;if(e instanceof t.Color)r=e;else{if("object"==typeof e){if(!(s.is(e.r)&&s.is(e.g)&&s.is(e.b))){if(s.is(e.start)&&s.is(e.start.color)&&(e.start.color=l._initColor(e.start.color)),s.is(e.mid)&&s.is(e.mid.color)&&(e.mid.color=l._initColor(e.mid.color)),s.is(e.end)&&s.is(e.end.color)&&(e.end.color=l._initColor(e.end.color)),s.is(e.keyframes)){var n,a=e.keyframes.length;for(n=0;n<a;n++){var o=e.keyframes[n];s.is(o)&&s.is(o.color)&&(o.color=l._initColor(e.keyframes[n].color))}}return new i(e)}e="rgb("+Math.floor(255*e.r)+","+Math.floor(255*e.g)+","+Math.floor(255*e.b)+")"}r=new t.Color(e)}return new i(r)}},_initUrl:function(e){var t=null;return"string"==typeof e&&(t="null"===e?null:e),t},_initBool:function(e){return"string"==typeof e?"false"!==e&&("true"===e||e):"boolean"==typeof e&&e},_initInt:function(e){var t=l._initFloat(e);return s.is(t)&&"string"!=typeof e&&(t=Math.round(t)),t},_initFloat:function(e){var t;return"string"==typeof e?(t=Number(e),s.is(t)||(t=e)):"number"==typeof e&&(t=e),t},_initNbVertices:function(e,t){var i;if(Array.isArray(e))i=[l._initFloat(e[0]),l._initInt(e[1])];else if("object"==typeof e)s.is(e[0])?i=[l._initFloat(e[0]),l._initInt(e[1])]:s.is(e.x)&&(i=[l._initInt(e.x),l._initInt(e.y)]);else if("number"==typeof(i=l._initInt(e)))i=[e,e];else if("string"==typeof e){var r=(e=(e=e.replace("[","")).replace("]","")).split(/,|;|\s/);if(2===r.length){var n=Number(r[0]),a=Number(r[1]);i=isNaN(n)||isNaN(a)?e:[l._initInt(n),l._initInt(a)]}else i=e}return i},_initVector2:function(e){var i;if("object"==typeof e)s.is(e[0])?i=new t.Vector2(l._initFloat(e[0]),l._initFloat(e[1])):s.is(e.x)&&(i=new t.Vector2(l._initFloat(e.x),l._initFloat(e.y)));else if("number"==typeof(i=l._initFloat(e)))i=new t.Vector2(e,e);else if("string"==typeof e){var r=(e=(e=e.replace("[","")).replace("]","")).split(/,|;|\s/);if(2===r.length){var n=Number(r[0]),a=Number(r[1]);i=isNaN(n)||isNaN(a)?e:new t.Vector2(n,a)}else i=e}return i},_initVector3:function(e){var i;if("object"==typeof e)s.is(e[0])?i=new t.Vector3(l._initFloat(e[0]),l._initFloat(e[1]),l._initFloat(e[2])):s.is(e.x)&&(i=new t.Vector3(l._initFloat(e.x),l._initFloat(e.y),l._initFloat(e.z)));else if("number"==typeof(i=l._initFloat(e)))i=new t.Vector3(e,e,e);else if("string"==typeof e){var r=(e=(e=e.replace("[","")).replace("]","")).split(/,|;|\s/);if(3===r.length){var n=Number(r[0]),a=Number(r[1]),o=Number(r[2]);i=isNaN(n)||isNaN(a)||isNaN(o)?e:new t.Vector3(n,a,o)}else i=e}return i},_initMap:function(e){if(null===e)return null;if(s.is(e))if("object"!=typeof e);else;},_saveDashPattern:function(e){var t=e;if(s.is(e)&&e.length){var i=e.length,r=i;t=[];let s=!1,a=100;do{t=e;for(var n=r-1;n>0;n--)t[n]-e[n-1]<=0&&(s=!0);for(n=r-1;n>=0&&!s;n--)t[n]=e[n],n>0&&(t[n]-=e[n-1]);4===i?t[2]===t[3]&&(s=!0):2===i?(t[0]===t[1]&&(s=!0),t[0]/3==t[1]/2&&(s=!0)):s=!0}while(!s&&--a)}return t instanceof Float32Array?Array.from(t):t},_saveValue:function(e){return e},_saveColor:function(e){var i;return s.is(e)&&s.is(e instanceof t.Color)&&(i="#"+e.getHexString()),i},_saveMap:function(e){return null===e?null:"object"==typeof e?l._RenderingToJSON(e,l._types.map.children):void 0},_saveVector2:function(e){return s.is(e)?[e.x,e.y]:null},_saveVector3:function(e){return s.is(e)?[e.x,e.y,e.z]:null},_saveColorGradient:function(e){if(s.is(e))return"#"+e.getHexString()},_removeValue:function(e,t,i){void 0!==e[i]&&delete e[i]},_addExpression:function(e){return new n(e)},_evaluateExpression:function(e,t){return t.setExpression(e),t.apply()},_removeDiffuseAndAmbient:function(e,t,i){var r=e[i];if(s.is(r)){var n=e.diffuse;s.is(n)&&n.getHexString()===r.getHexString()&&l._removeValue(e,t,"diffuse");var a=e.ambient;s.is(a)&&a.getHexString()===r.getHexString()&&l._removeValue(e,t,"ambient"),l._removeValue(e,t,i)}},_addParamsToTexture:function(e,t){s.is(t)&&(s.is(t.wrapS)&&(e.wrapS=t.wrapS),s.is(t.wrapT)&&(e.wrapT=t.wrapT),s.is(t.minFilter)&&(e.minFilter=t.minFilter),s.is(t.magFilter)&&(e.magFilter=t.magFilter),s.is(t.anisotropy)&&(e.anisotropy=t.anisotropy),s.is(t.generateMipmaps)&&(!0===t.generateMipmaps?e.generateMipmaps=!0:e.generateMipmaps=!1))},_setMaterialMapFromProfile:function(e,t,i){if(s.is(e)&&s.is(t))for(var r=this,n=function(n,l){if(s.is(l)){o.addTexture(n.url,l),r._addParamsToTexture(l,t);var h=t[n.param+"Params"];s.is(h)||(h={}),t[n.param+"Params"]=h,r._addParamsToTexture(l,t[n.param+"Params"]),t[n.param]=l,s.is(l.shared)?l.shared++:l.shared=1,t[n.param+"Params"]&&!1===t[n.param+"Params"].enable?e[n.param]=a.whiteMap:e[n.param]=t[n.param],s.is(i)&&i.onTextureApplied(e[n.param],e,t,n),a.updateCommonUniforms(e),e.updateDeferredMaterials&&(e._deferredMaterialsInit=!1)}else console.warn("Could not load texture : "+t[n.paramUrl])},l=o.getTexturesToLoad(t),h=0;h<l.length;++h){if(void 0===t[l[h].param]&&void 0===t[l[h].paramUrl])return;o.shouldLoadMap(t[l[h].paramUrl],t[l[h].param])&&(s.is(i)&&i.onTextureDownloadStart(e,t,l[h]),o.downloadTexture(t[l[h].paramUrl],n.bind(void 0,l[h]))),t[l[h].param+"Params"]&&!1===t[l[h].param+"Params"].enable?(e[l[h].param]=a.whiteMap,s.is(i)&&i.onTextureApplied(e[l[h].param],e,t,l[h])):e[l[h].param]!==t[l[h].param]&&(e[l[h].param]=t[l[h].param],s.is(i)&&i.onTextureApplied(e[l[h].param],e,t,l[h]))}}});return l._types={bool:{init:l._initBool},boolWithUpdate:{init:l._initBool,copy:l._setPlusUpdateMaterial},string:{},ratio:{init:l._initFloat,min:0,max:1},alphaTest:{init:l._initFloat,copy:l._setAlphaTest,min:0,max:1},positiveInt:{init:l._initInt,min:0},width:{init:l._initFloat,min:1},positiveFloat:{init:l._initFloat,min:0},float:{init:l._initFloat},int:{init:l._initInt},nbVertices:{init:l._initNbVertices,min:3,max:17},none:{init:l._initValue,copy:l._setValue,save:l._saveValue,remove:l._removeValue,addexpression:l._addExpression,evaluateexpression:l._evaluateExpression},basicColor:{init:l._initColor,copy:l._setColor,save:l._saveColor},map:{init:l._initMap,copy:l._setMap,save:l._saveMap},url:{init:l._initUrl,copy:l._setMapUrl},wrap:{init:l._initValue,valuesIn:{repeat:t.RepeatWrapping,clamp:t.ClampToEdgeWrapping,mirroredrepeat:t.MirroredRepeatWrapping,1000:t.RepeatWrapping,1001:t.ClampToEdgeWrapping,1002:t.MirroredRepeatWrapping},valuesOut:{1000:"repeat",1001:"clamp",1002:"mirroredrepeat"}},filter:{init:l._initValue,valuesIn:{nearest:t.NearestFilter,nearestmipmapnearest:t.NearestMipMapNearestFilter,nearestmipmaplinear:t.NearestMipMapLinearFilter,linear:t.LinearFilter,linearmipmapnearest:t.LinearMipMapNearestFilter,linearmipmaplinear:t.LinearMipMapLinearFilter,1003:t.NearestFilter,1004:t.NearestMipMapNearestFilter,1005:t.NearestMipMapLinearFilter,1006:t.LinearFilter,1007:t.LinearMipMapNearestFilter,1008:t.LinearMipMapLinearFilter},valuesOut:{1003:"nearest",1004:"nearestmipmapnearest",1005:"nearestmipmaplinear",1006:"linear",1007:"linearmipmapnearest",1008:"linearmipmaplinear"}},mapParams:{children:{enable:"bool",wrapS:"wrap",wrapT:"wrap",minFilter:"filter",magFilter:"filter",anisotropy:"positiveFloat",generateMipmaps:"bool",width:"width",height:"width"}},texturingMode:{valuesIn:{simple:"simple",cameraStop:"cameraStop",continuous:"continuous",screenSpace:"screenSpace"}},geometricMode:{init:l._initValue,valuesIn:{filled:"filled",line:"line",volumetric:"volumetric",extruded:"extruded"}},renderMode:{init:l._initValue,valuesIn:{occluded:"occluded",overlay:"overlay",dual:"dual"}},diffuseandambient:{init:l._initColorGradient,copy:l._setDiffuseAndAmbient,save:l._saveColorGradient,remove:l._removeDiffuseAndAmbient},color:{init:l._initColorGradient,copy:l._setColorGradient,save:l._saveColorGradient},gradientKeyframe:{children:{value:"none",color:"basicColor"}},side:{init:l._initInt,valuesIn:{0:t.FrontSide,1:t.BackSide,2:t.DoubleSide},copy:l._setPlusUpdateMaterial},roofMode:{init:l._initInt,valuesIn:{"-1":-1,0:0,1:1,2:2}},vector2:{init:l._initVector2,copy:l._setVector2,save:l._saveVector2},vector3:{init:l._initVector3,copy:l._setVector3,save:l._saveVector3},lineAnimation:{children:{enable:"bool",speed:"float",dashSize:"float",minOpacity:"ratio",gapSize:"float",samplingRate:"float",nbPoints:"positiveInt",loop:"bool",reverse:"bool"}},stroke:{children:{enable:"bool",opacity:"ratio",renderMode:"renderMode",opacityFactor:"ratio",minOpacity:"ratio",minDist:"positiveFloat",maxDist:"positiveFloat",lineWidth:"width",minWidth:"positiveFloat",dynamicUpdate:"bool",animation:"lineAnimation",color:"diffuseandambient",diffuse:"basicColor",ambient:"basicColor",specular:"basicColor",wireframe:"bool",alphaTest:"alphaTest",side:"side",shininess:"positiveInt",depthTest:"boolWithUpdate",depthWrite:"boolWithUpdate",dashPattern:"dashPattern",elevationOffset:"float"}},label:{children:{enable:"bool",onSelect:"bool",position:"labelPositioning",style:"labelStyling",styleName:"string",name:"string"}},labelPositioning:{children:{mode:"string",rotation:"vector3",geometryOffset:"vector3",labelOffset:"vector2",offset:"vector3",enableAutomaticFlip:"bool",isAligned:"bool",isRepeated:"bool"}},labelStyling:{children:{"background-color":"string",border:"string","border-bottom":"string","border-left":"string","border-radius":"string","border-right":"string","border-top":"string",color:"string","font-family":"string","font-size":"string","font-style":"string","font-weight":"string","letter-spacing":"string","line-height":"string",opacity:"string",padding:"string","text-align":"string","text-decoration":"string","text-shadow":"string","word-spacing":"string","-webkit-text-stroke":"string"}},linecap:{valuesIn:{round:"round",square:"square"}},taMode:{valuesIn:{elevation:"elevation",slope:"slope",orientation:"orientation",default:"default"}},cosineGradient:{children:{DCOffset:"vector3",Amplitude:"vector3",Frequency:"vector3",Phase:"vector3"}},terrainAnalyzer:{children:{mode:"taMode",min:"float",max:"float",gradient:"cosineGradient",elevationMin:"float",elevationMax:"float",slopeMin:"float",slopeMax:"float"}},blending:{valuesIn:{none:t.NoBlending,normal:t.NormalBlending,additive:t.AdditiveBlending,subtractive:t.SubtractiveBlending,multiply:t.MultiplyBlending,custom:t.CustomBlending,normaldepth:t.NormalDepthBlending,0:t.NoBlending,1:t.NormalBlending,2:t.AdditiveBlending,3:t.SubtractiveBlending,4:t.MultiplyBlending,5:t.CustomBlending,6:t.NormalDepthBlending},valuesOut:{0:"none",1:"normal",2:"additive",3:"subtractive",4:"multiply",5:"custom",6:"normaldepth"}},style:{valuesIn:{arrow:"arrow",point:"point",icon:"icon",placename:"placename",annotation:"annotation",annotationIcon:"annotationIcon",annotationIconAdvanced:"annotationIconAdvanced",custom:"custom"}},textStyle:{valuesIn:{button:"button",lite:"lite"}},textColor:{init:l._initColorGradient,copy:l._setColorGradient,save:l._saveColorGradient},descriptionDisplayMode:{valuesIn:{hover:"hover",click:"click",always:"always"}},elevationMode:{valuesIn:{geometry:"geometry",advanced:"advanced",ground:"ground"}},cubeMapUrl:{init:l._initCubeMapUrl,copy:l._setCubeMapUrl,save:l._saveCubeMapUrl},dashPattern:{init:l._initDashPattern,save:l._saveDashPattern,copy:l._setArrayOrNull,collectionType:"positiveFloat"},offset2d:{children:{x:"float",y:"float"}},offset3d:{children:{x:"float",y:"float",z:"float"}},offsetFunction:{children:{ratio:"vector3",pixel:"vector3",bbox:"offset3d"}},float02:{init:l._initFloat,min:0,max:2},highlightSet:{children:{color:"basicColor",intensity:"ratio",colorEnabled:"bool",outlineColor:"basicColor",outlineAlpha:"ratio",outlineEnabled:"bool",outlineThickness:"positiveInt",haloColor:"basicColor",haloIntensity:"float02",haloEnabled:"bool"}},shapeType:{valuesIn:{billboard:"billboard",disc:"disc",sphere:"sphere",pyramid:"pyramid",tube:"tube"}}},l._renderingParams={alphaTest:"alphaTest",altitude:"float",ambient:"color",animation:"lineAnimation",appearance:"positiveFloat",blending:"blending",classStyle:"string",color:"diffuseandambient",customClass:"string",depthTest:"boolWithUpdate",depthWrite:"boolWithUpdate",descriptionDisplayMode:"descriptionDisplayMode",diffuse:"color",dynamicUpdate:"bool",enableClipPlanes:"bool",enable:"bool",envMap:"map",envMapUrl:"url",extrusionHeight:"positiveFloat",forceSide:"bool",generateMipmaps:"bool",geometricMode:"geometricMode",gradient:"cosineGradient",height:"float",influenceRadius:"width",icon:"string",iconName:"string",label:"label",lightMap:"map",lightMapUrl:"url",lineWidth:"width",magFilter:"filter",map:"map",mapUrl:"url",mapAtlas:"map",mapAtlasId:"string",mapParams:"mapParams",maxDist:"positiveInt",minDist:"positiveInt",minFilter:"filter",minOpacity:"ratio",minWidth:"positiveInt",noGeometry:"bool",normalMap:"map",normalMapUrl:"url",renderingDescription:"string",styleClass:"string",elevationOffset:"float",elevation:"float",elevationMode:"elevationMode",terrainAnalyzer:"terrainAnalyzer",oceanAlpha:"ratio",oceanColor:"color",oceanColorDetection:"color",oceanRangeDetection:"float",oceanTexture:"map",oceanTextureUrl:"url",oceanTextureParams:"mapParams",opacity:"ratio",opacityFactor:"ratio",orientation:"float",r_mode:"roofMode",reflectivity:"ratio",refractionRatio:"ratio",reflectionCoef:"ratio",renderMode:"renderMode",roofTextures:"map",roofTexturesUrl:"url",scale:"vector3",shininess:"positiveInt",showOcean:"bool",side:"side",specular:"color",specularMap:"map",specularMapUrl:"url",style:"style",stroke:"stroke",textStyle:"textStyle",textColor:"textColor",transparent:"bool",wallTextures:"map",wallTexturesUrl:"url",weight:"float",wireframe:"bool",wireframeLinewidth:"positiveInt",wrapS:"wrap",wrapT:"wrap",slabColor:"color",cubeMapUrl:"url",cubeMapExt:"string",domeSize:"positiveFloat",cubeMap:"map",boundMin:"positiveInt",boundMax:"positiveInt",kernel:"positiveInt",dashPattern:"dashPattern",offsetUv:"vector2",repeatUv:"vector2",offsetFunction:"offsetFunction",highlightSet:"highlightSet",linecap:"linecap",texturingMode:"texturingMode",shapeType:"shapeType",nbVertices:"nbVertices",switchDistance:"positiveFloat",polyExtruOptim:"bool"},l}),define("DS/XCityRendering/Rendering",["DS/XCityTools/RenderingTools","UWA/Class","DS/xCityBasicUtils/Utils"],function(e,t,i){"use strict";var r=t.extend({init:function(e){this.reset(),this.addOver(e)},hasData:function(){return Object.keys(this.renderingData).length>0},reset:function(){this.renderingData={}},_addOver:function(t,i){e._setMaterialFromProfile(t,i)},copy:function(e){this.reset(),this.addOver(e)},getRenderingData:function(){return this.renderingData},toJSON:function(){return e._RenderingToJSON(this.getRenderingData())},addOver:function(e){var t=e;e instanceof r&&(t=e.getRenderingData()),this._addOver(this.renderingData,t)},get:function(e){return i.getComposedProperty(this.renderingData,e)},set:function(e,t){this.renderingData[e]=t},remove:function(t){var i={};return i[t]=null,e._RemoveRendering(this.renderingData,i),this.isEmpty()},_addOverNoAdd:function(t,i){e._setMaterialFromProfileNoAdd(t,i)},addOverNoAdd:function(e){var t=e;e instanceof r&&(t=e.getRenderingData()),this._addOverNoAdd(this.renderingData,t)},isEmpty:function(){var e=this.getRenderingData();return Object.keys(e).length<1},isImpactingAttribute:function(e){var t=!1,r=this.get(e);return i.is(r)&&(t=!0),t},getDifferences:function(e){if(i.is(e)&&e instanceof r){var t=e.getRenderingData(),s=this.getRenderingData(),n=i.getDifferences(s,t);return i.is(n)&&(n=this._create(n)),n}},getSimilarity:function(e){var t;return i.is(e)&&e instanceof r&&(t=i.getSubsetOfBinA(this.renderingData,e.renderingData)),i.is(t)&&(t=this._create(t)),t},_create:function(e){return new r(e)},getImpactedAttributes:function(e){if(e||(e={}),this.renderingData)for(var t=Object.keys(this.renderingData),i=0;i<t.length;i++){e[t[i]]=!0}return e}});return r}),define("DS/XCityRendering/DatavizRendering",["DS/XCityTools/RenderingTools","DS/xCityBasicUtils/Utils","DS/XCityRendering/Rendering","DS/XCityTools/OGCFilter","DS/XCityTools/OGCFilterPrimitive","DS/XCityTools/Expression","DS/XCityTools/ExpressionEvaluator"],function(RenderingTools,Utils,Rendering,OGCFilter,OGCFilterPrimitive,Expression,ExpressionEvaluator){"use strict";var DatavizRendering=Rendering.extend({init:function(e,t,i){this._id=void 0,e instanceof DatavizRendering&&(t=e.filter,i=e.exprData,this._id=e._id,e=e.renderingData),this._parent(e),this._initFilter(t),this._initExpressions(i)},reset:function(){this.filter=null,this._context=null,this._parent()},resetRenderingDataOnly:function(){this.renderingData={}},_initFilter:function(e){Utils.is(e)&&(this.filter=new OGCFilter(e))},_initExpressions:function(e){Utils.is(e)&&(this.exprData=Object.assign({},RenderingTools._RenderingToJSONExpression(e)))},checkFilter:function(){if(!Utils.is(this.filter))return!0;var e=!0;if(Utils.is(this._context)){var t=this.getEvaluator();t.setContext(this._context),t.setExpression(this.filter),e=t.apply(),t.unsetContext()}return e},setContext:function(e){this._context=e},hasInterpretedData:function(){return!!(Utils.is(this.exprData)&&Object.keys(this.exprData).length>0)},getRenderingData:function(){var e={};if(this.checkFilter()){var t=this._parent();if(this._addOver(e,t),this.hasInterpretedData()){var i=this.getInterpretedData();this._addOver(e,i)}}return e},getInterpretedData:function(){var e={};if(this.hasInterpretedData()&&Utils.is(this._context)){var t=this.getEvaluator();t.setContext(this._context),e=RenderingTools._ExpressionToEval(this.exprData,t),t.unsetContext(),e=RenderingTools._JSONToRendering(e)}return e},getEvaluator:function(){return Utils.is(this.evaluator)||(this.evaluator=new ExpressionEvaluator),this.evaluator},getFilterRendering:function(){var e=null;if(this.isFilterRendering()){var t=this.toJSON();(e={}).filter=this.filter,e.rendering=t.ElementMaterial}return e},getMappingRendering:function(){var e=null;this.isMappingRendering()&&(e=this.toJSON().DatavizMaterial);return e},isMappingRendering:function(){return Utils.is(this.exprData)},isFilterRendering:function(){return Utils.is(this.filter)},setAll:function(e,t,i){this.reset(),this.addOver(e),this._initFilter(t),this._initExpressions(i)},convertToJSON:function(e,t){var i,r,s,n,a=Object.keys(e),o=a.length;for(i=0;i<o;i++)n=e[r=a[i]],Utils.is(n)&&(Utils.is(s)||(s={}),s[r]=!1===t?Utils.is(n.expr)?n.clone():this.convertToJSON(n,t):Utils.is(n.expr)?n.toJSON():this.convertToJSON(n,t));return s},toJSON:function(e){var t,i=this._parent();if(Utils.is(i)&&Object.keys(i).length>0&&(Utils.is(t)||(t={}),t.ElementMaterial=i),this.isFilterRendering()&&(Utils.is(t)||(t={}),t.Filter=!1===e?this.filter.clone():this.filter.toJSON()),this.isMappingRendering()){var r=this.convertToJSON(this.exprData,e);Utils.is(r)&&(Utils.is(t)||(t={}),t.DatavizMaterial=r)}return t},isImpactingAttribute:function(e){var t=this.get(e);return!!Utils.is(t)||!(!this.isMappingRendering()||!Utils.is(Utils.getComposedProperty(this.exprData,e)))},isEmpty:function(){var e=this.getRenderingData();if(Object.keys(e).length<1){if(!this.isMappingRendering())return!0;if(Object.keys(this.exprData).length<1)return!0}return!1},remove:function(e){return Utils.is(this.exprData)&&delete this.exprData[e],this._parent(e)},getId:function(){return this._id},addOverIds:function(e){this._id=e},getSimilarity:function(e){var t,i;if(Utils.is(e)){i=this._parent(e);var r=Utils.getSubsetOfBinA(this.exprData,e.exprData);(Utils.is(i)||Utils.is(r))&&(t=new DatavizRendering(i,this._filter,r))}return t},_create:function(e){return new DatavizRendering(e)},_interpretMappings:function(contexts,defaultValues){var i=0,j=0,results=[],evaluator=this.getEvaluator(),res=[],keys=Object.keys(this.exprData);for(i=0;i<keys.length;i++){var key=keys[i],expr=this.exprData[key];if(expr.stringForm||(evaluator.setExpression(expr),evaluator.evalString(contexts[0])),expr.usedAttributes){var allattributesdefined=!0,keys2=Object.keys(expr.usedAttributes);for(j=0;j<keys2.length;j++){var key2=keys2[j],value=contexts[0][key2];if(void 0===value){allattributesdefined=!1;break}}if(!allattributesdefined)continue;var XCITYcurrentVariables=expr.usedVariables;for(j=0;j<contexts.length;j++){var XCITYcurrentContent=contexts[j];res[j]||(res[j]={}),res[j][key]=eval(expr.stringForm)||defaultValues[key]}}}for(i=0;i<res.length;i++)results.push(RenderingTools._JSONToRendering(res[i]));return results},getImpactedAttributes:function(e){if(e=this._parent(e),this.exprData)for(var t=Object.keys(this.exprData),i=0;i<t.length;i++){e[t[i]]=!0}return e}});return DatavizRendering}),define("DS/XCityRendering/PrimitiveRendering",["DS/xCityBasicUtils/Utils","DS/XCityRendering/Rendering"],function(e,t){"use strict";var i=t.extend({init:function(e){var t=!1;e instanceof i&&(t=e,e=e.getRenderingData()),this._parent(e),t&&(this.primitiveIds=t.primitiveIds.concat())},reset:function(){this.primitiveIds=[],this._parent()},resetRenderingDataOnly:function(){this.renderingData={}},addOver:function(t){var r,s;e.is(t)&&(t instanceof i?(r=t.getIds(),s=t):(r=t.ElementIds,s=t.ElementMaterial?t.ElementMaterial:t),this.addOverIds(r),this._parent(s))},isIdIncluded:function(e){var t,i=this.primitiveIds.length;for(t=0;t<i;t++)if(this.primitiveIds[t]===e)return!0;return!1},getIds:function(){return this.primitiveIds},addOverIds:function(t){if(e.is(t)){"string"==typeof t&&(t=[t]);var i,r,s=t.length;for(i=0;i<s;i++)r=t[i],this.isIdIncluded(r)||this.primitiveIds.push(r)}},toJSON:function(){var t,i=this._parent();return e.is(i)&&((t={ElementIds:this.getIds()}).ElementMaterial=i),t},getId:function(){return this.primitiveIds[0]},_create:function(e){return new i(e)}});return i}),define("DS/XCityRendering/FeatureRendering",["DS/XCityRendering/Rendering","DS/XCityRendering/PrimitiveRendering","DS/XCityRendering/DatavizRendering","DS/xCityBasicUtils/Utils"],function(e,t,i,r){"use strict";var s=e.extend({init:function(e){this._parent(e)},reset:function(){this._parent(),this.primitiveRenderings={length:0},this.datavizRenderings={length:0}},addOver:function(e){if(r.is(e))if(e instanceof s){var n=e.getRenderingData();this._parent(n),this.addPrimitives(e.getPrimitiveRenderings()),this.addRenderings(e.getDatavizRenderings())}else e instanceof i?this.addDatavizOver(e):e instanceof t?this.addPrimitiveOver(e):(e.ElementRendering&&this.addRenderings(e.ElementRendering),e.Material?this._parent(e.Material):this._parent(e))},hasFilterDataviz:function(){var e=!1;if(r.is(this.datavizRenderings)){var t,i,s=this.getDatavizIds(),n=s.length;for(t=0;t<n&&(i=s[t],!(e=this.datavizRenderings[i].isFilterRendering()));t++);}return e},hasFeatureRendering:function(){return this.hasData()},hasPrimitiveRendering:function(){return this.primitiveRenderings.length>0},getPrimitiveRenderings:function(){return this.primitiveRenderings},hasDatavizRendering:function(){return this.datavizRenderings.length>0},getDatavizRenderings:function(){return this.datavizRenderings},addRenderings:function(e){if(r.is(e)){var s,n,a,o=Object.keys(e),l=o.length;for(s=0;s<l;s++)"length"!==(a=o[s])&&(n=e[a],r.is(n)&&(n instanceof i?this.addDatavizOver(n):n instanceof t?this.addPrimitiveOver(n):r.is(n.DatavizMaterial)?this.addDatavizOver(n):r.is(n.ElementMaterial)?this.addPrimitiveOver(n):console.error(" unknown data format for renderingformat ")))}},addPrimitives:function(e){if(r.is(e)){var t,i,s=Object.keys(e),n=s.length;for(t=0;t<n;t++)"length"!==(i=s[t])&&this.addPrimitiveOver(e[i])}},addPrimitiveOver:function(e){if(r.is(e)){if(!(e instanceof t)){if(!e.ElementMaterial)return void console.error("cannot initialize primitive rendering");e=new t(e)}var i=e.getId();r.is(this.primitiveRenderings[i])?this.primitiveRenderings[i].addOver(e):(this.primitiveRenderings[i]=new t(e),this.primitiveRenderings.length++)}},addDatavizOver:function(e){if(r.is(e)){if(!(e instanceof i)){if(!e.DatavizMaterial)return void console.error("cannot initialize dataviz rendering ");(e=new i(e)).addOverIds("3DXCityDefaultID")}this._mappingsMerge=null;var t=e.getId();r.is(this.datavizRenderings[t])?this.datavizRenderings[t].addOver(e):(this.datavizRenderings[t]=new i(e),this.datavizRenderings.length++)}},getDatavizRendering:function(e){var i,r,s=this.datavizRenderings.length,n=new t;n.addOverIds(e);var a=this.getDatavizIds();for(i=0;i<s;i++)r=this.datavizRenderings[a[i]],n.addOver(r.getRenderingData());return n},getPrimitiveRendering:function(e,i){var s,n;this.primitiveRenderings.length;s=new t,r.is(i)&&(this.setContext(i),n=this.getDatavizRendering(e),this.unsetContext(),r.is(n)&&s.addOver(n));var a=this.primitiveRenderings[e];return r.is(a)&&s.addOver(a),s},setContext:function(e){if(r.is(this.datavizRenderings)){var t,i=this.datavizRenderings.length,s=this.getDatavizIds();for(t=0;t<i;t++)this.datavizRenderings[s[t]].setContext(e)}},unsetContext:function(){if(r.is(this.datavizRenderings)){var e,t=this.datavizRenderings.length,i=this.getDatavizIds();for(e=0;e<t;e++)this.datavizRenderings[i[e]].setContext(null)}},getCompleteMaterialInfo:function(t,i){var r=this.getRenderingData(),s=this.getPrimitiveRendering(t,i),n=new e;return n.addOver(r),n.addOver(s),n.getRenderingData()},getDatavizIds:function(){var e,t=(e=Object.keys(this.datavizRenderings)).indexOf("length");return t>=0&&e.splice(t,1),e},hasDatavizOnAttribute:function(e){var t=!1;if(r.is(this.datavizRenderings)){var i,s,n=this.getDatavizIds(),a=n.length;for(i=0;i<a&&(s=n[i],!(t=this.datavizRenderings[s].isImpactingAttribute(e)));i++);}return t},getPrimitiveIds:function(){var e,t=(e=Object.keys(this.primitiveRenderings)).indexOf("length");return t>=0&&e.splice(t,1),e},hasPrimitivesOnAttribute:function(e){var t=!1;if(r.is(this.primitiveRenderings)){var i,s,n=this.getPrimitiveIds(),a=n.length;for(i=0;i<a&&(s=n[i],!(t=this.primitiveRenderings[s].isImpactingAttribute(e)));i++);}return t},isImpactingAttribute:function(e){return this._parent(e)||this.hasPrimitivesOnAttribute(e)||this.hasDatavizOnAttribute(e)},_priorityClean:function(e){if(r.is(e)){var t,i=Object.keys(e),s=i.length;for(t=0;t<s;t++){var n=i[t];void 0!==e[n]&&(r.is(this.datavizRenderings)&&this.shouldResetDataviz(n,e[n])&&this.removeAttributeFromDataviz(n),r.is(this.primitiveRenderings))}}},shouldResetDataviz:function(e,t){var i,s=this.getDatavizIds(),n=s.length;for(i=0;i<n;i++)if(r.is(this.datavizRenderings[s[i]])&&r.is(this.datavizRenderings[s[i]].exprData)&&r.is(this.datavizRenderings[s[i]].exprData[e]))return this.compareRenderings(this.datavizRenderings[s[i]].exprData[e],t);return!0},compareRenderings:function(e,t){var i,s=Object.keys(e),n=s.length;for(i=0;i<n;i++)return!!r.is(e.expr)||!!r.is(t[s[i]])&&this.compareRenderings(e[s[i]],t[s[i]])},removeAttributeFromDataviz:function(e){var t,i=this.datavizRenderings.length,r={length:0},s=this.getDatavizIds();for(t=0;t<i;t++){var n=s[t];if("length"!==n){var a=this.datavizRenderings[n];a.remove(e)||(r[n]=a,r.length++)}}r.length!==this.datavizRenderings.length&&(this.datavizRenderings=r)},removeAttributeFromPrimitives:function(e){var t,i=this.primitiveRenderings.length,r={length:0},s=this.getPrimitiveIds();for(t=0;t<i;t++){var n=s[t];if("length"!==n){var a=this.primitiveRenderings[n];a.remove(e)||(r[n]=a,r.length++)}}r.length!==this.primitiveRenderings.length&&(this.primitiveRenderings=r)},getStrokeFeatureRendering:function(){var e,r,n,a=[],o=this.get("stroke"),l=new s(o),h=this.getDatavizImpactingAttribute("stroke"),d=h.length;for(r=0;r<d;r++)n=h[r],(e=new i(h[r])).addOverIds("3DXCityDefaultID_stroke"+r),e.resetRenderingDataOnly(),e.addOver(n.get("stroke")),e.exprData&&e.exprData.stroke&&(e.exprData=e.exprData.stroke),a.push(e);var u=this.getPrimitiveImpactingAttribute("stroke");for(d=u.length,r=0;r<d;r++)n=u[r],(e=new t(u[r])).resetRenderingDataOnly(),e.addOver(n.get("stroke")),a.push(e);return l.addRenderings(a),l},getDatavizImpactingAttribute:function(e){var t=[];if(r.is(this.datavizRenderings)){var i,s,n=this.getDatavizIds(),a=n.length;for(i=0;i<a;i++)s=n[i],!1,this.datavizRenderings[s].isImpactingAttribute(e)&&t.push(this.datavizRenderings[s])}return t},getPrimitiveImpactingAttribute:function(e){var t=[];if(r.is(this.primitiveRenderings)){var i,s,n=this.getPrimitiveIds(),a=n.length;for(i=0;i<a;i++)s=n[i],!1,this.primitiveRenderings[s].isImpactingAttribute(e)&&t.push(this.primitiveRenderings[s])}return t},toJSON:function(e){var t={},i=this._parent();return r.is(i)&&Object.keys(i).length>0&&(t.Material=i),r.is(this.datavizRenderings)&&this.addJSONRenderingDataviz(t,e),r.is(this.primitiveRenderings)&&this.addJSONRenderingPrimitive(t),t},addJSONRenderingDataviz:function(e,t){var i=this._getJSONDataviz(this.datavizRenderings,t);r.is(i)&&Object.keys(i).length>0&&(e.DatavizRendering=i)},addJSONRenderingPrimitive:function(e){var t=this._getJSONPrimitives(this.primitiveRenderings);r.is(t)&&Object.keys(t).length>0&&(e.ElementRendering=t)},_getJSONPrimitives:function(e){var t;if(r.is(e)){var i,s,n,a,o=Object.keys(e),l=o.length;for(i=0;i<l;i++)"length"!==(a=o[i])&&(s=e[a],r.is(s)&&(n=s.toJSON(),r.is(n)&&(r.is(t)||(t=[]),t.push(n))))}return t},_getJSONDataviz:function(e,t){var i;if(r.is(e)&&r.is(e.length)&&e.length>0){var s,n,a,o,l=this.getDatavizIds(),h=l.length;for(s=0;s<h;s++)n=e[o=l[s]],r.is(n)&&(a=r.is(n.expr)&&!1===t?n:n.toJSON(t),r.is(a)&&(r.is(i)||(i={}),i[o]=a))}return i},getAllValuesForAttribute:function(e){var t,i=this.get(e);r.is(i)&&((t={}).Material={},t.Material[e]=i);var s=this.getAllDatavizValuesForAttribute(e);r.is(s)&&(r.is(t)||(t={}),t.DatavizMaterial={},t.DatavizMaterial[e]=s);var n=this.getAllPrimitiveValuesForAttribute(e);return r.is(n)&&(r.is(t)||(t={}),t.ElementMaterial={},t.ElementMaterial[e]=n),t},getAllDatavizValuesForAttribute:function(e){var t;if(r.is(this.datavizRenderings)){var i,s,n,a=this.getDatavizIds(),o=a.length;for(i=0;i<o;i++)if(n=a[i],s=this.datavizRenderings[n],r.is(s)){var l=s.get(e);r.is(l)&&(r.is(t)||(t={}),t[n]=l)}}return t},getAllPrimitiveValuesForAttribute:function(e){var t;if(r.is(this.primitiveRenderings)){var i,s,n,a=this.getPrimitiveIds(),o=a.length;for(i=0;i<o;i++)if(n=a[i],s=this.primitiveRenderings[n],r.is(s)){var l=s.get(e);r.is(l)&&(r.is(t)||(t={}),t[n]=l)}}return t},_getPertinentRenderings:function(e){var t;if(r.is(this.primitiveRenderings)){var s,n,a,o,l=this.primitiveRenderings[this.getPrimitiveIds()[0]],h=e.getPrimitiveIds(),d=h.length;for(s=0;s<d;s++)a=h[s],n=e.primitiveRenderings[a],o=l.getSimilarity(n),r.is(o)&&(r.is(t)||(t=[]),t.push(o));for(d=e.getDatavizIds().length,l=new i(l),s=0;s<d;s++)a=h[s],n=e.datavizRenderings[a],o=l.getSimilarity(n),r.is(o)&&(r.is(t)||(t=[]),t.push(o))}return t},getSimilarity:function(e){var t,i=this._parent(e);r.is(i)&&(t=new s(i));var n=this._getPertinentRenderings(e);return r.is(n)&&(r.is(t)||(t=new s),t.addRenderings(n)),t},_create:function(e){return new s(e)},getMappings:function(e){var t,s,n=this.datavizRenderings.length;if(!r.is(this._mappingsMerge)){var a=this.getDatavizIds();for(this._mappingsMerge=new i(this.datavizRenderings[a[0]]),t=1;t<n;t++)s=this.datavizRenderings[a[t]],this._mappingsMerge.exprData=Object.assign(this._mappingsMerge.exprData,s.exprData)}delete this._mappingsMerge.exprData.label;var o={},l=Object.keys(this._mappingsMerge.exprData);n=l.length;for(t=0;t<n;t++){let e=l[t];o[e]=this.get(e)}return this._mappingsMerge._interpretMappings(e,o)},getImpactedAttributes:function(e){if(e=this._parent(e),r.is(this.datavizRenderings)){var t,i=this.getDatavizIds(),s=i.length;for(n=0;n<s;n++){t=i[n],e=this.datavizRenderings[t].getImpactedAttributes(e)}}if(r.is(this.primitiveRenderings)){var n,a,o,l=this.getPrimitiveIds();s=l.length;for(n=0;n<s;n++)o=l[n],a=this.primitiveRenderings[o],r.is(a)&&(e=a.getImpactedAttributes(e))}return e}});return s}),define("DS/XCityGeometry/PointOfInterest3DSet",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/Mesh/MeshUtils","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityTools/ShaderTools","DS/XCityTools/TextureTools","DS/Plugins/RenderPass","DS/Mesh/Mesh","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader","DS/XCityTools/Pooler","DS/XCityTools/RenderingTools","DS/XCityTools/TextureManager","DS/WebappsUtils/WebappsUtils"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m){"use strict";var g=t.extend({init:function(t,r,s){this.__v0=new e.Vector3,this.__v1=new e.Vector3,this.__center=new e.Vector3,this.__scale=new e.Vector3,this.__instanceMatrix=new e.Matrix4,this.__instanceNormalMatrix=new e.Matrix3,this.__p0=new e.Vector3,this.__p1=new e.Vector3,this.__p2=new e.Vector3,this.__p3=new e.Vector3,this.__p4=new e.Vector3,this.__n0=new e.Vector3,this.__n1=new e.Vector3,this.__n2=new e.Vector3,this.__n3=new e.Vector3,this.__n4=new e.Vector3,this.urban=t,this.posTile=s.posTile,this.tileInfo=s.tile.LOD+"_"+s.tile.I+"_"+s.tile.J,this.tileBbox={};var n=this.urban.worldSize/(1<<s.tile.LOD);this.tileBbox.xmin=s.tile.I*n+this.urban.shiftedPosition.x,this.tileBbox.xmax=(s.tile.I+1)*n+this.urban.shiftedPosition.x,this.tileBbox.ymin=s.tile.J*n+this.urban.shiftedPosition.y,this.tileBbox.ymax=(s.tile.J+1)*n+this.urban.shiftedPosition.y;var a=this.getCurrentDimensions();this.halfScreenResolution=new e.Vector2(a.width/2,a.height/2),i.is(r.rendering)&&(this._rendering=r.rendering),this.geometryMode=void 0!==r.geometryMode?r.geometryMode.toLowerCase():"mesh",this.urban.USR.hwInstancing&&(this.geometryMode="instancing"),this.shapeType=r.shapeType,void 0!==r.modelMesh3d&&(this.modelMesh3d=r.modelMesh3d,this.ownModelReady=!0,this._posSize=r._posSize),this.shadingMode=void 0!==r.shadingMode?r.shadingMode.toLowerCase():"smooth",this.renderType=void 0!==r.renderType?r.renderType.toLowerCase():"icon","text"===this.renderType&&(this.geometryMode="mesh"),this.renderMode=void 0!==r.renderMode?r.renderMode.toLowerCase():"overlay",this.iconTopLeft=null,this.samplingFactor=void 0!==r.samplingFactor?r.samplingFactor:1,this.opacityFactor=void 0!==r.opacityFactor?r.opacityFactor:1,this.size=new e.Vector3(1,1,1),this.switchDistance=void 0!==r.switchDistance?r.switchDistance:0,this.styleClass=void 0,this.primitiveNodes={},this.primitiveAnchorNodes={},this.nbMesh=0,this.nbPoi=0,this.idLayer=0,this.cssProcessed=!1,this.initializeRendering(),this.initializeInstancingParams(),this.minMax={minX:99999999.9,minY:99999999.9,minZ:99999999.9,maxX:-99999999.9,maxY:-99999999.9,maxZ:-99999999.9},this.minMaxOrig={minX:99999999.9,minY:99999999.9,minZ:99999999.9,maxX:-99999999.9,maxY:-99999999.9,maxZ:-99999999.9},this.scaleCulling=g.scaleCulling,this._debugID=0,this.urlTexture=void 0!==r.urlTexture?r.urlTexture:"",this.widthTexture=1,this.heightTexture=1,this.textMaterial=[],this.textNode=[],this.poiName=[],this.nbSelectedNode=0,this.renderAnchor=void 0!==r.renderAnchor&&r.renderAnchor,this.anchorLineWidth=void 0!==r.anchorLineWidth?r.anchorLineWidth:1,this.transparentPrimitive=!1,this.nbVertices=[15,15],this.maxVerticesSphere=17,"number"==typeof r.nbVertices&&r.nbVertices>=3?this.nbVertices=[r.nbVertices,r.nbVertices]:r.nbVertices instanceof Array&&(r.nbVertices[0]>=3&&(this.nbVertices[0]=r.nbVertices[0]),r.nbVertices[1]>=3&&(this.nbVertices[1]=r.nbVertices[1])),this.nbVertices[0]>this.maxVerticesSphere&&(console.log("POI sphere resolution (nbVertices) is bounded to 17."),this.nbVertices[0]=this.maxVerticesSphere),this.nbVertices[1]>this.maxVerticesSphere&&(console.log("POI sphere resolution (nbVertices) is bounded to 17."),this.nbVertices[1]=this.maxVerticesSphere),this._defineRenderPass(),this._setMaterial()},initializeInstancingParams:function(){this.instanceMatrix=[],this.instanceNormalMatrix=[],this.instanceColor=[],this.instanceAnchor=[],this.instanceAnchorColor=[],this.instanceFlags=[],this.instanceFloats=[],this.instancingReady=!1,this.instanceCgmId=[],this.initScale=[]},initializeRendering:function(){if(i.is(this._rendering)){var e=this._rendering.getCompleteMaterialInfo();p._setMaterialFromProfile(this,e)}},destroy:function(){},isReady:function(){return this._ready},dispose:function(){},setRendering:function(){return!1},getCurrentDimensions:function(){var e=this.urban.USR.webGLV6Viewer;return e?{width:e.SCREEN_WIDTH,height:e.SCREEN_HEIGHT}:this.urban._frmViewerContainer.getDimensions()},updateScreenDimension:function(e){var t=this.getCurrentDimensions();1!==t.width&&1!==t.height&&(this.halfScreenResolution.x=t.width/2,this.halfScreenResolution.y=t.height/2,i.is(e)&&(i.is(e.isPDSFX())?e.updatePDSFXUniform("halfScreenResolution",this.halfScreenResolution):e.uniforms.halfScreenResolution.value=this.halfScreenResolution))},_defineRenderPass:function(){var e;"occluded"===this.renderMode?this._poiPostPassID="main":"overlay"===this.renderMode?(this._poiPostPassID="PoiTransparentOverlayPass",void 0===this.urban.getView3D().getRenderPassManager().getPass(this._poiPostPassID)&&((e=new l(null,null,void 0,!0,!1,!1,this._poiPostPassID)).idString=this._poiPostPassID,this.urban.getView3D().getRenderPassManager().addPass(this._poiPostPassID,e,{after:"ClearDepthPass"}))):(this._poiPrePassID="main",this._poiPostPassID="PoiTransparentOverlayPass",void 0===this.urban.getView3D().getRenderPassManager().getPass(this._poiPostPassID)&&((e=new l(null,null,void 0,!0,!1,!1,this._poiPostPassID)).idString=this._poiPostPassID,this.urban.getView3D().getRenderPassManager().addPass(this._poiPostPassID,e,{after:"ClearDepthPass"})))},_setMaterial:function(){var t,i=this._rendering,r=i.getCompleteMaterialInfo(),s=r.color,n=r.opacity;if("icon"===this.renderType){"billboard"===this.shapeType?(this.matPostPass=a.getPDSFXMaterial([g.coloring_PDSFX,g.mapping_PDSFX,g.atlasing_PDSFX,g.poiOnePass2d_instancing_PDSFX],"basic"),i.addAtlasUniforms(this.matPostPass),this.matPostPass.updatePDSFXUniform("halfScreenResolution",this.halfScreenResolution),this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,this.matPostPass))):(this.matPostPass=a.getPDSFXMaterial([g.poiOnePass3d_instancing_PDSFX],"physical"),this.matPostPass.metalness=0,this.matPostPass.roughness=1),this.matPostPass.name=this.shapeType+"material",this.matPostPass.updatePDSFXUniform("switchDistance",this.switchDistance),this.matPostPass.updatePDSFXUniform("scaleCulling",this.scaleCulling),this.matPostPass.alphaTest=.1,this.matPostPass.side=e.FrontSide;var o=!1;n<1?o=!0:"billboard"===this.shapeType&&(o=!0),this.matPostPass.transparent=o,this.transparentPrimitive=o,this.matPostPass.forceSide=!0,this.matPostPass.side=0,this.matPostPass._autoForceSide=!1,this.matPostPass.depthTest=!0,this.matPostPass.depthWrite=!0,"disc"===this.shapeType&&i.defaultRendering.addOver({side:e.DoubleSide,forceSide:!0}),t=1,"dual"===this.renderMode&&("billboard"===this.shapeType&&this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,this.matPrePass)),t=this.opacityFactor),this.matPostPass.color=s,this.matPostPass.opacity=n*t,a.updateCommonUniforms(this.matPostPass)}this.renderAnchor&&(this.matAnchorPostPass=a.getPDSFXMaterial([g.poiOnePass3dAnchorTriangle_instancing_PDSFX],"physical"),this.matAnchorPostPass.updatePDSFXUniform("halfWidth",this.anchorLineWidth/2),this.matAnchorPostPass.updatePDSFXUniform("switchDistance",this.switchDistance),this.matAnchorPostPass.side=e.FrontSide,this.matAnchorPostPass.transparent=!0,this.matAnchorPostPass.depthTest=!0,this.matAnchorPostPass.depthWrite=!0,this.matAnchorPostPass.name="AnchorPostpass",this.matAnchorPostPass.color=s,this.matAnchorPostPass.opacity=n*t,a.updateCommonUniforms(this.matAnchorPostPass),this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,this.matAnchorPostPass)))},getMesh:function(){var r,s,a,o,l=function(t,i,r){var s=!1,n=i.geometry.boundingSphere,a=n.center.x-n.radius,o=n.center.x+n.radius,l=n.center.y-n.radius,h=n.center.y+n.radius,d=n.center.z-n.radius,u=n.center.z+n.radius,c=i.userData.__v0,p=i.userData.__v1;c.set(t[r+12],t[r+13],t[r+14]),p.set(t[r+0],t[r+5],t[r+10]),c.x-p.x<a&&(a=c.x-p.x,s=!0),c.x+p.x>o&&(o=c.x+p.x,s=!0),c.y-p.y<l&&(l=c.y-p.y,s=!0),c.y+p.y>h&&(h=c.y+p.y,s=!0);var f=c.z;if(c.z-p.z<d&&(d=c.z-p.z,s=!0),f+p.z>u&&(u=f+p.z,s=!0),s){var m=new e.Sphere;m.radius=Math.sqrt(Math.pow(o-a,2)+Math.pow(h-l,2)+Math.pow(u-d,2))/2,m.center.x=(a+o)/2,m.center.y=(l+h)/2,m.center.z=(d+u)/2,i.boundingSphere=m}},h=function(e,t){return e.reduce((e,i,r)=>(i===t&&e.push(r),e),[])},d=function(e,t){var r=this.mesh3js.instanceAttribArrays.instanceFlag.array,s=[-1];if(!0===this.isInstanceNode3D){var n=this.mesh3js.userData.instanceIds;if(!i.is(n))return;s=h(n,t)}for(let t=0;t<s.length;t++){const n=s[t];var a=r[n],o=r[n];(a=i.floatPack(a,3,!e))!==o&&(r[n]=a,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0)}},u=function(e,t,r){var s,n=0,a=e.scale,o=i.is(a),d="billboard"===this._shapeType,u=[-1];if(!0===this.isInstanceNode3D){var c=this.mesh3js.userData.instanceIds;if(!i.is(c))return;var p=this.mesh3js.instanceAttribArrays.instanceFlag.array;u=h(c,r)}for(let t=0;t<u.length;t++){const h=u[t];if(!0===this.isInstanceNode3D&&(n=p[h]),o){s||(s=[]);var f,m,g,v=d?1:.5,_=d?1:100;f=a.x*v,m=a.y*v,"sphere"===this._shapeType&&(m=g=f),s[0]=f*_,s[5]=m*_,s[10]=g*_}n=i.floatPack(n,2,o);var y=e.color;i.is(y)&&i.is(y.computeColor)&&(y=y.computeColor());var b,x,C=e.opacity,S=i.is(y),D=i.is(C);if(n=i.floatPack(n,0,S),n=i.floatPack(n,1,D),!0===this.isInstanceNode3D){var P=this.mesh3js.userData.instanceIds.indexOf(r);if(s){b=16*h,x=16*P;var w=this.mesh3js.instanceAttribArrays.instanceMatrix.array,M=this.mesh3js.userData.instanceMatrix;for(var T in s)if(s.hasOwnProperty(T)){var I=b+Number(T);w[I]=s[T],M[I=x+Number(T)]=s[T]}this.mesh3js.instanceAttribArrays.instanceMatrix.isDynamic=!0,l(w,this.mesh3js,b)}if(S||D){var R=this.mesh3js.instanceAttribArrays.instanceColor.array,A=this.mesh3js.userData.instanceColor;b=4*h,x=4*P,S&&(R[b]=y.r,R[b+1]=y.g,R[b+2]=y.b,A[P].x=y.r,A[P].y=y.g,A[P].z=y.b),D&&(R[b+3]=C,A[P].w=C),this.mesh3js.instanceAttribArrays.instanceColor.isDynamic=!0}p=this.mesh3js.instanceAttribArrays.instanceFlag.array;var F=this.mesh3js.userData.instanceFlags;n!==p[h]&&(p[h]=n,F[P]=n,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0)}}},c=function(e,t,r){var s,n=0;!0===this.isInstanceNode3D&&(n=s=(b=this.mesh3js.instanceAttribArrays.instanceFlag.array)[v=this.mesh3js.userData.cgmIds.indexOf(r)]);var a,o=e.scale;if(i.is(o)){a||(a=[]);var l,h,d;l=.5*o.x,h=.5*o.y,d=o.z,"sphere"===this._shapeType&&(h=d=l),a[0]=100*l,a[5]=100*h,a[10]=100*d,n=i.floatPack(n,2,1)}var u=e.color;i.is(u)&&i.is(u.computeColor)&&(u=u.computeColor());var c,p=e.opacity,f=i.is(u),m=i.is(p);if(n=i.floatPack(n,0,f),n=i.floatPack(n,1,m),!0===this.isInstanceNode3D){var g=this.mesh3js.userData.instanceIds.indexOf(r),v=this.mesh3js.userData.cgmIds.indexOf(r);if(f||m){var _=this.mesh3js.instanceAttribArrays.instanceColor.array,y=this.mesh3js.userData.instanceColor;c=4*v,4*g,f&&(_[c]=u.r,_[c+1]=u.g,_[c+2]=u.b,y[g].x=u.r,y[g].y=u.g,y[g].z=u.b),m&&(_[c+3]=p,y[g].w=p),this.mesh3js.instanceAttribArrays.instanceColor.isDynamic=!0}if(n!==s){var b=this.mesh3js.instanceAttribArrays.instanceFlag.array,x=this.mesh3js.userData.instanceFlags;b[v]=n,x[g]=n,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0}}},p=function(t,i){if(void 0!==t){var r=this.mesh3js.userData.cgmIds.indexOf(i),s=t[0],n=t[1],a=t[2];if(void 0!==this.mesh3js.userData.__posTile&&(s-=this.mesh3js.userData.__posTile.x,n-=this.mesh3js.userData.__posTile.y),-1!==r){var o=this.mesh3js.userData.__initScale[r][0],l=this.mesh3js.userData.__initScale[r][1],h=this.mesh3js.userData.__initScale[r][2],d=this.mesh3js.userData.__transModel.x,u=this.mesh3js.userData.__transModel.y,c=this.mesh3js.userData.__transModel.z,p=this.mesh3js.instanceAttribArrays.instanceMatrix.array,f=p[16*r+0]/o,m=p[16*r+1]/o,g=p[16*r+10]/h,v=p[16*r+6]/l,_=s+d*f-m*(u*g-c*v),y=n+(u*g-c*v)*f+d*m,b=a+u*v+c*g;p[16*r+12]=_,p[16*r+13]=y,p[16*r+14]=b,this.mesh3js.instanceAttribArrays.instanceMatrix.isDynamic=!0;var x=!1,C=this.mesh3js.geometry.boundingSphere,S=C.center.x-C.radius,D=C.center.x+C.radius,P=C.center.y-C.radius,w=C.center.y+C.radius,M=C.center.z-C.radius,T=C.center.z+C.radius,I=this.mesh3js.userData.__v0,R=this.mesh3js.userData.__v1;I.set(p[16*r+12],p[16*r+13],p[16*r+14]),R.set(p[16*r+0],p[16*r+5],p[16*r+10]),I.x-R.x<S&&(S=I.x-R.x,x=!0),I.x+R.x>D&&(D=I.x+R.x,x=!0),I.y-R.y<P&&(P=I.y-R.y,x=!0),I.y+R.y>w&&(w=I.y+R.y,x=!0);var A=I.z;if(I.z-R.z<M&&(M=I.z-R.z,x=!0),A+R.z>T&&(T=A+R.z,x=!0),x){var F=new e.Sphere;F.radius=Math.sqrt(Math.pow(D-S,2)+Math.pow(w-P,2)+Math.pow(T-M,2))/2,F.center.x=(S+D)/2,F.center.y=(P+w)/2,F.center.z=(M+T)/2}}}},f=function(e,t){if(void 0!==e){var i,r,s=this.mesh3js.userData.cgmIds.indexOf(t);if("object"==typeof e?(i=e[1],r=e[0]):(i=e,r=0),-1!==s){var n=this.mesh3js.instanceAttribArrays.instanceMatrix.array,a=this.mesh3js.userData.__initScale[s][0],o=this.mesh3js.userData.__initScale[s][1],l=this.mesh3js.userData.__initScale[s][2],h=Math.cos(i),d=Math.sin(i),u=Math.cos(r),c=Math.sin(r);n[16*s+0]=h*a,n[16*s+1]=d*a,n[16*s+2]=0,n[16*s+4]=-d*u*o,n[16*s+5]=u*h*o,n[16*s+6]=c*o,n[16*s+8]=c*d*l,n[16*s+9]=-h*c*l,n[16*s+10]=u*l,this.mesh3js.instanceAttribArrays.instanceMatrix.isDynamic=!0}return this}},m=new t;void 0!==this.modelMesh3d?(this.nbMesh=1,this.renderAnchor&&(this.primitiveAnchorNodes[0]=this.creatorAnchor.compilePrimitive("Poi3D_anchor",!0))):(this.primitiveNodes[0]=this.creator.compilePrimitive("Poi3D",!0),this.nbMesh=1,this.renderAnchor&&(this.primitiveAnchorNodes[0]=this.creatorAnchor.compilePrimitive("Poi3D_anchor",!0)));var g,v=this.matPostPass,_=this.matPrePass,y=1;"dual"===this.renderMode&&(y=this.opacityFactor),!0===this.transparentPrimitive&&(v.transparent=!0,_&&(_.transparent=!0));for(var b=0;b<this.nbMesh;b++){if(void 0!==this.modelMesh3d)g=this.modelMesh3d.clone(!0);else{var x=this.primitiveNodes[b];g=n.createMeshNode(x)}"text"===this.renderType&&"billboard"===this.shapeType&&((v=this.textMaterial[this.poiName[b]].postPass).updatePDSFXUniform("opacityCity",this.opacity*y),this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,v)),"dual"===this.renderMode&&(_=this.textMaterial[this.poiName[b]].prePass,this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,_)))),g.setRendering=u,g.setVisible=d,g._shapeType=this.shapeType,g.setPosition=p,g.setOrientation=f,g.setRenderPasses([this._poiPostPassID]),o="_poi3D_PostPass_"+this.styleClass,g.name=o,g._debugID=this._debugID,g.mesh3js.material=v,g.setMaterial(v);var C={data:this.instanceMatrix,type:"m4",attribName:"instanceMatrix"};if(r={data:this.instanceColor,type:"v4",attribName:"instanceColor"},s={data:this.instanceFlags,type:"f",attribName:"instanceFlag"},a={data:this.instanceFloats,type:"v4",attribName:"instanceFloats"},g.mesh3js.userData.cgmIds=this.instanceCgmId,g.mesh3js.userData.instanceMatrix=this.instanceMatrix,g.mesh3js.userData.instanceColor=this.instanceColor,g.mesh3js.userData.instanceFlags=this.instanceFlags,g.mesh3js.userData.instanceFloats=this.instanceFloats,g.mesh3js.userData.instanceIds=this.instanceCgmId.slice(),g.mesh3js.userData.__v0=new e.Vector3,g.mesh3js.userData.__v1=new e.Vector3,g.mesh3js.userData.__initScale=this.initScale,g.mesh3js.userData.__posTile=this.posTile,void 0!==this.modelMesh3d){var S=this.modelMesh3d.getMatrix();g.mesh3js.userData.__transModel=new e.Vector3(S.elements[12],S.elements[13],S.elements[14])}else g.mesh3js.userData.__transModel=new e.Vector3;g.setInstancingParameters(this.nbPoi,[C,r,s,a],"instance"),"dual"===this.renderMode&&(this.matPrePass=v.clone(),this.matPrePass.forceSide=!0,this.matPrePass.side=0,this.matPrePass._autoForceSide=!1,_=this.matPrePass,this._rendering.addAtlasUniforms(this.matPrePass));for(var D=0;D<g._occurrences.length;D++)g._occurrences[D].renderable.userData.cgmIds=this.instanceCgmId;if(g.forceBoundingSphere({radius:Math.sqrt(Math.pow(this.tileBbox.xmax-this.tileBbox.xmin,2)+Math.pow(this.tileBbox.ymax-this.tileBbox.ymin,2)+Math.pow(this.minMax.maxZ-this.minMax.minZ,2))/2,center:new e.Vector3((this.minMax.minX+this.minMax.maxX)/2,(this.minMax.minY+this.minMax.maxY)/2,(this.minMax.minZ+this.minMax.maxZ)/2)}),g.setShadow(!1,!1),m.addChild(g),this.renderAnchor){var P=this.primitiveAnchorNodes[b],w=n.createMeshNode(P);w.setRendering=c,w.setVisible=d,w.setPosition=p,w.setOrientation=f,w._shapeType="anchor",w.setRenderPasses([this._poiPostPassID]),w.name=o+"_Anchor",w._debugID=this._debugID,w.mesh3js.material=this.matAnchorPostPass,w.setMaterial(this.matAnchorPostPass),r={data:this.instanceAnchorColor,type:"v4",attribName:"instanceColor"};var M={data:this.instanceAnchor,type:"v4",attribName:"instanceAnchor"};s={data:this.instanceFlags,type:"f",attribName:"instanceFlag"},a={data:this.instanceFloats,type:"v4",attribName:"instanceFloats"},w.mesh3js.userData.cgmIds=this.instanceCgmId,w.mesh3js.userData.instanceAnchor=this.instanceAnchor,w.mesh3js.userData.instanceColor=this.instanceAnchorColor,w.mesh3js.userData.instanceFlags=this.instanceFlags,w.mesh3js.userData.instanceFloats=this.instanceFloats,w.mesh3js.userData.instanceIds=this.instanceCgmId.slice(),w.setInstancingParameters(this.nbPoi,[r,M,s,a]);for(D=0;D<g._occurrences.length;D++)w._occurrences[D].renderable.userData.cgmIds=this.instanceCgmId;w.forceBoundingSphere({radius:Math.sqrt(Math.pow(this.tileBbox.xmax-this.tileBbox.xmin,2)+Math.pow(this.tileBbox.ymax-this.tileBbox.ymin,2)+Math.pow(this.minMax.maxZ-this.minMax.minZ,2))/2,center:new e.Vector3((this.minMax.minX+this.minMax.maxX)/2,(this.minMax.minY+this.minMax.maxY)/2,(this.minMax.minZ+this.minMax.maxZ)/2)}),w.setShadow(!1,!1),m.addChild(w),"dual"===this.renderMode&&(this.matAnchorPrePass=this.matAnchorPostPass.clone(),_=this.matPrePass)}if("dual"===this.renderMode){var T=g.clone();if(T.setRenderPasses([this._poiPrePassID]),_.isInstancingMaterial=v.isInstancingMaterial,_.attributes=g.material.attributes,T.isInstanceNode3D=!0,T.mesh3js.material=_,T.setMaterial(_),T.setRendering=u,m.addChild(T),this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,_)),this.renderAnchor){var I=w.clone();I.setRenderPasses([this._poiPrePassID]),I._shapeType="anchor",this.matAnchorPrePass.isInstancingMaterial=this.matAnchorPostPass.isInstancingMaterial,this.matAnchorPrePass.attributes=w.material.attributes,I.mesh3js.material=this.matAnchorPrePass,I.setMaterial(this.matAnchorPrePass),I.setRendering=c,m.addChild(I),this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,this.matAnchorPrePass))}}}return o="_poi3D_PostPass_"+this.styleClass+"_"+this.tileInfo,m.name=o,this._rendering.updateTextureWhenReady(this._indexUpdates,m),this._indexUpdates=null,this._rendering.applyRendering(m),m},_pushInstancesData:function(t,r,s,n,a){this.instanceMatrix[this.nbPoi]=t,this.instanceColor[this.nbPoi]=new e.Vector4(r[0],r[1],r[2],r[3]),this.instanceFlags[this.nbPoi]=s,i.is(a)||(a=[s,0,0,0]),this.instanceFloats[this.nbPoi]=new e.Vector4(a[0],a[1],a[2],a[3]),i.is(n)&&(this.instanceNormalMatrix[this.nbPoi]=n)},_pushPrimitiveBillboard:function(t,r,s,n,a,o,l,h,d){if(!1===this.instancingReady){t.pushVertex([0,-1,0]),t.pushVertex([1,-1,0]),t.pushVertex([1,0,0]),t.pushVertex([0,0,0]),t.pushNormal([0,0,0]),t.pushNormal([0,0,0]),t.pushNormal([0,0,0]),t.pushNormal([0,0,0]);t.pushTexCoord(0,[0,0]),t.pushTexCoord(0,[1,0]),t.pushTexCoord(0,[1,1]),t.pushTexCoord(0,[0,1]),t.pushVertexIndices([a+0,a+1,a+2]),t.pushVertexIndices([a+0,a+2,a+3])}var u=new e.Vector3(s[0]/this.scaleCulling,s[1]/this.scaleCulling,s[2]),c=new e.Vector3(o,l,h),p=new e.Matrix4;p.identity(),p.translate(c),p.scale(u);var f=0,m=0,g=0;i.is(d.indexTexture)&&(f=d.indexTexture,m=d.top,g=d.left);var v=[d.flags,f,g,m];this._pushInstancesData(p,n,d.flags,void 0,v)},_pushPrimitiveDisc:function(t,i,r,s,n,a,o,l,h,d,u,c){if(!1===this.instancingReady){var p,f;t.pushVertex([i[0],i[1],i[2]]),t.pushNormal([0,0,1]);for(var m=0;m<this.nbVertices[0];++m)p=s[0]*Math.sin(2*m*Math.PI/this.nbVertices[0]),f=s[1]*Math.cos(2*m*Math.PI/this.nbVertices[0]),t.pushVertex([i[0]+p,i[1]+f,i[2]]),t.pushNormal([0,0,1]),m+1===this.nbVertices[0]?t.pushVertexIndices([n,n+1,n+m+1]):t.pushVertexIndices([n,n+m+2,n+m+1])}var g=new e.Vector3(a,o,l),v=new e.Vector3(h,d,u),_=new e.Matrix4;_.identity(),_.translate(g),_.scale(v),this._pushInstancesData(_,r,c)},_pushPrimitiveTube:function(t,i,r,s,n,a,o,l,h,d,u,c){var p,f,m;if(!1===this.instancingReady)if("smooth"===this.shadingMode)for(t.pushVertex([i[0],i[1],i[2]+r[2]]),t.pushNormal([0,0,1]),t.pushVertex([i[0],i[1],i[2]]),t.pushNormal([0,0,-1]),m=0;m<this.nbVertices[0];++m)f=Math.cos((2*m*Math.PI-Math.PI*this.nbVertices[0]/4)/this.nbVertices[0]),p=Math.sin((2*m*Math.PI-Math.PI*this.nbVertices[0]/4)/this.nbVertices[0]),t.pushVertex([i[0]+r[0]*p,i[1]+r[1]*f,i[2]+r[2]]),t.pushVertex([i[0]+r[0]*p,i[1]+r[1]*f,i[2]+r[2]]),t.pushVertex([i[0]+r[0]*p,i[1]+r[1]*f,i[2]]),t.pushVertex([i[0]+r[0]*p,i[1]+r[1]*f,i[2]]),t.pushNormal([0,0,1]),t.pushNormal([p,f,0]),t.pushNormal([p,f,0]),t.pushNormal([0,0,-1]),m+1===this.nbVertices[0]?(t.pushVertexIndices([n,n+2,n+4*m+2]),t.pushVertexIndices([n+1,n+4*m+5,n+5]),t.pushVertexIndices([n+4*m+3,n+4,n+4*m+4]),t.pushVertexIndices([n+4*m+3,n+3,n+4])):(t.pushVertexIndices([n,n+4*(m+1)+2,n+4*m+2]),t.pushVertexIndices([n+1,n+4*m+5,n+4*(m+1)+5]),t.pushVertexIndices([n+4*m+3,n+4*(m+1)+4,n+4*m+4]),t.pushVertexIndices([n+4*m+3,n+4*(m+1)+3,n+4*(m+1)+4]));else{t.pushVertex([i[0],i[1],i[2]+r[2]]),t.pushNormal([0,0,1]);var g,v,_=new e.Vector3,y=new e.Vector3,b=new e.Vector3,x=new e.Vector3,C=new e.Vector3,S=new e.Vector3,D=new e.Vector3;for(m=0;m<this.nbVertices[0];++m)f=Math.cos((2*m*Math.PI-Math.PI*this.nbVertices[0]/4)/this.nbVertices[0]),p=Math.sin((2*m*Math.PI-Math.PI*this.nbVertices[0]/4)/this.nbVertices[0]),g=Math.cos((2*(m+1)*Math.PI-Math.PI*this.nbVertices[0]/4)/this.nbVertices[0]),v=Math.sin((2*(m+1)*Math.PI-Math.PI*this.nbVertices[0]/4)/this.nbVertices[0]),_.set(i[0]+r[0]*p,i[1]+r[1]*f,i[2]+r[2]),y.set(i[0]+r[0]*p,i[1]+r[1]*f,i[2]),b.set(i[0]+r[0]*v,i[1]+r[1]*g,i[2]),x.set(i[0]+r[0]*v,i[1]+r[1]*g,i[2]+r[2]),t.pushVertex(_.toArray()),t.pushVertex(y.toArray()),t.pushVertex(b.toArray()),t.pushVertex(x.toArray()),C.subVectors(b,x).normalize(),S.subVectors(b,y).normalize(),D.crossVectors(S,C),t.pushNormal(D.toArray()),t.pushNormal(D.toArray()),t.pushNormal(D.toArray()),t.pushNormal(D.toArray()),t.pushVertexIndices([n+6*m+0+1,n+6*m+2+1,n+6*m+1+1]),t.pushVertexIndices([n+6*m+0+1,n+6*m+3+1,n+6*m+2+1]),t.pushVertex(x.toArray()),t.pushVertex(_.toArray()),t.pushNormal([0,0,1]),t.pushNormal([0,0,1]),t.pushTexCoord(0,[i[0],i[1]]),t.pushTexCoord(0,[i[0],i[1]]),t.pushTexCoord(1,[i[2],c]),t.pushTexCoord(1,[i[2],c]),t.pushColor(s),t.pushColor(s),t.pushVertexIndices([n+0,n+6*m+4+1,n+6*m+5+1])}var P=new e.Vector3(a,o,l),w=new e.Vector3(h,d,u),M=new e.Matrix4;M.identity(),M.translate(P),M.scale(w),this._pushInstancesData(M,s,c)},_pushPrimitiveSphere:function(t,i,r,s,n,a,o,l,h,d){var u,c;if(!1===this.instancingReady){var p=r[0],f=this.nbVertices[0],m=this.nbVertices[1],g=2*Math.PI,v=Math.PI,_=0+v,y=0,b=[],x=new e.Vector3;for(u=0;u<=m;u++){var C=[],S=u/m;for(c=0;c<=f;c++){var D=c/f,P=-p*Math.cos(0+D*g)*Math.sin(0+S*v),w=p*Math.cos(0+S*v),M=p*Math.sin(0+D*g)*Math.sin(0+S*v);x.set(P,w,M).normalize(),t.pushVertex([i[0]+P,i[1]+w,i[2]+M]),t.pushNormal([x.x,x.y,x.z]),t.pushTexCoord(0,[D,S]),C.push(y),y++}b.push(C)}for(u=0;u<m;u++)for(c=0;c<f;c++){var T=b[u][c+1],I=b[u][c],R=b[u+1][c],A=b[u+1][c+1];0!==u&&t.pushVertexIndices([n+T,n+I,n+A]),(u!==m-1||_<Math.PI)&&t.pushVertexIndices([n+I,n+R,n+A])}}var F=this.__center.set(a,o,l),L=this.__scale.set(h,h,h),V=new e.Matrix4;V.identity(),V.translate(F),V.scale(L),this._pushInstancesData(V,s,d)},_pushPrimitivePyramid:function(e,t,i,r,s,n,a,o,l,h,d,u){if(this.__center.set(n,a,o),this.__scale.set(l,h,d),this.__instanceMatrix.identity(),this.__instanceMatrix.translate(this.__center),this.__instanceMatrix.scale(this.__scale),this.__instanceNormalMatrix.getNormalMatrix(this.__instanceMatrix),this.__p0.set(0,0,0),this.__p1.set(1,-1,1),this.__p2.set(-1,-1,1),this.__p3.set(-1,1,1),this.__p4.set(1,1,1),this.__n2.set(0,1,0),this.__n1.set(1,0,0),this.__n0.set(0,-1,0),this.__n3.set(-1,0,0),this.__n4.set(0,0,1),!1===this.instancingReady){var c=this.__p0.toArray(),p=this.__p1.toArray(),f=this.__p2.toArray(),m=this.__p3.toArray(),g=this.__p4.toArray(),v=this.__n0.toArray(),_=this.__n1.toArray(),y=this.__n2.toArray(),b=this.__n3.toArray(),x=this.__n4.toArray();e.pushVertex(c),e.pushVertex(p),e.pushVertex(f),e.pushNormal(v),e.pushNormal(v),e.pushNormal(v),e.pushVertex(c),e.pushVertex(g),e.pushVertex(p),e.pushNormal(_),e.pushNormal(_),e.pushNormal(_),e.pushVertex(c),e.pushVertex(m),e.pushVertex(g),e.pushNormal(y),e.pushNormal(y),e.pushNormal(y),e.pushVertex(c),e.pushVertex(f),e.pushVertex(m),e.pushNormal(b),e.pushNormal(b),e.pushNormal(b),e.pushVertex(f),e.pushVertex(p),e.pushVertex(g),e.pushVertex(m),e.pushNormal(x),e.pushNormal(x),e.pushNormal(x),e.pushNormal(x),e.pushVertexIndices([s,s+1,s+2]),e.pushVertexIndices([s+3,s+1+3,s+2+3]),e.pushVertexIndices([s+6,s+1+6,s+2+6]),e.pushVertexIndices([s+9,s+1+9,s+2+9]),e.pushVertexIndices([s+12,s+1+12,s+2+12]),e.pushVertexIndices([s+12,s+2+12,s+3+12])}this._pushInstancesData(this.__instanceMatrix.clone(),r,u,this.__instanceNormalMatrix.clone())},_pushAnchorPrimitive:function(t,i,r,s,n,a,o,l,h,d){!1===this.instancingReady&&(t.pushVertex([i[0],i[1],i[3]-r]),t.pushVertex([i[0],i[1],i[3]-r]),t.pushVertex([i[0],i[1],i[2]+r]),t.pushVertex([i[0],i[1],i[2]+r]),t.pushNormal([1,0,0]),t.pushNormal([-1,0,0]),t.pushNormal([-1,0,0]),t.pushNormal([1,0,0]),t.pushTexCoord(0,[0,0]),t.pushTexCoord(0,[1,0]),t.pushTexCoord(0,[1,1]),t.pushTexCoord(0,[0,1]),t.pushVertexIndices([n,n+2,n+3]),t.pushVertexIndices([n,n+3,n+1]));var u=new e.Vector4(a,o,(l+h)/2,(h-l)/2),c=new e.Vector4(s[0],s[1],s[2],s[3]);this.instanceAnchor[this.nbPoi]=u,this.instanceAnchorColor[this.nbPoi]=c},_addPoi:function(t,i,r,s,n,a,o,l,h,d,u,c){var p=a+o,f=c.flags,m=c.color,g=.5*h,v=.5*d,_=isNaN(l)?0:l;"pyramid"===this.shapeType?this.pLength=16:"disc"===this.shapeType?this.pLength=this.nbVertices[0]+1:"tube"===this.shapeType?"smooth"===this.shadingMode?this.pLength=3*this.nbVertices[0]+1:this.pLength=6*this.nbVertices[0]+1:"sphere"===this.shapeType&&(this.pLength=(this.nbVertices[0]+1)*(this.nbVertices[1]+1));var y=0,b=0;"primitive"===this.geometryMode&&(y=4*this.nbPoi,b=4*this.nbPoi,y=this.nbPoi*this.pLength),!1===this.instancingReady&&(t.startPrimitive(),this.renderAnchor&&i.startPrimitive());var x=[1,1,1],C=[0,0,0,0],S={x:g,y:v,z:u},D={x:s,y:n,z:p,w:a};if(this.ownModelReady){var P=new e.Vector3(s,n,p),w=new e.Vector3(g,v,u),M=new e.Matrix4;M.identity(),M.translate(P),M.rotateZ(_),M.scale(w);var T=new e.Matrix4;T.identity(),T.multiplyMatrices(this.modelMesh3d.getMatrix(),M),this._pushInstancesData(T,m,f),D={x:s+this._posSize.center.x,y:n+this._posSize.center.y,z:p+this._posSize.center.z,w:a+this._posSize.center.z}}else"billboard"===this.shapeType?(x=[h,d,u],this._pushPrimitiveBillboard(t,C,x,m,y,s,n,p,c)):"disc"===this.shapeType?this._pushPrimitiveDisc(t,C,m,x,y,s,n,p,g,v,u,f):"tube"===this.shapeType?this._pushPrimitiveTube(t,C,x,m,y,s,n,p,g,v,u,f):"sphere"===this.shapeType?this._pushPrimitiveSphere(t,C,x,m,y,s,n,p,g,f):"pyramid"===this.shapeType&&this._pushPrimitivePyramid(t,[0,0],[0,0],m,y,s,n,p,g,v,u,f);this._computeMinMax(this.minMax,D,S),this.instanceCgmId[this.nbPoi]=r,this.initScale[this.nbPoi]=[g,v,u],this.renderAnchor&&this._pushAnchorPrimitive(i,C,1,m,b,s,n,a,p),!1===this.instancingReady&&(t.endPrimitive(r),this.instancingReady=!0,this.renderAnchor&&i.endPrimitive(r))},_computeMinMax:function(e,t,i){t.x-i.x<e.minX&&(e.minX=t.x-i.x),t.x+i.x>e.maxX&&(e.maxX=t.x+i.x),t.y-i.y<e.minY&&(e.minY=t.y-i.y),t.y+i.y>e.maxY&&(e.maxY=t.y+i.y),t.w-i.z<e.minZ&&(e.minZ=t.w-i.z),t.z+i.z>e.maxZ&&(e.maxZ=t.z+i.z)},loadBillboardMap:function(e){void 0!==this.urlTexture&&""!==this.urlTexture&&this._rendering.setCssMap(this.urlTexture,this.iconTopLeft,this.widthTexture,this.heightTexture)},initBillboardMap:function(e){var t=e.mapUrl;i.is(t)&&(this.urlTexture=t,this.iconTopLeft=null)},initBillboardCSSMap:function(){var e,t;e=document.getElementsByTagName("body")[0],(t=document.createElement("div")).setAttribute("style","position:absolute;top:0px; left:0px;"),t.innerHTML="<div class='"+this.styleClass+"'><p class='poiIcon'></p></div>",e.appendChild(t);var r=window.getComputedStyle(t.children[0].children[0]),s=r.getPropertyValue("background-image"),n=r.getPropertyValue("width"),a=r.getPropertyValue("height");e.removeChild(t),(t=document.createElement("div")).setAttribute("style","position:absolute;top:0px; left:0px;width:"+n+";height:"+a+";"),t.innerHTML="<div class='"+this.styleClass+"'><p class='poiIcon'></p></div>",e.appendChild(t);var o=(r=window.getComputedStyle(t.children[0].children[0])).getPropertyValue("top"),l=r.getPropertyValue("left");if(e.removeChild(t),"none"!==s){var h=s.search("http");(h=(s=s.slice(h,-1)).search('"'))>-1&&(s=s.slice(0,h)),this.urlTexture=s}if(i.is(m.getWebappsBaseUrl())&&""!==m.getWebappsBaseUrl())var d=m.getWebappsBaseUrl(),u=this.extractPortURL(d),c=d.replace(u,"");if(i.is(m.getProxifiedWebappsBaseUrl())&&""!==m.getProxifiedWebappsBaseUrl()){var p=m.getProxifiedWebappsBaseUrl(),f=this.extractPortURL(p);p.replace(f,"")}if(i.is(this.urlTexture))var g=this.extractPortURL(this.urlTexture),v=this.urlTexture.replace(g,"");i.is(m.getWebappsBaseUrl())&&v.contains(c)&&i.is(m.getProxifiedWebappsBaseUrl())&&""!==m.getProxifiedWebappsBaseUrl()&&(this.urlTexture=v.replace(c,m.getProxifiedWebappsBaseUrl())),this.widthTexture=parseInt(n),this.heightTexture=parseInt(a),i.is(this.iconTopLeft)||(this.iconTopLeft=[0,0]),this.iconTopLeft[0]=parseFloat(o),this.iconTopLeft[1]=parseFloat(l)},extractPortURL:function(e){var t=e.match(/:([0-9]+)/g);return null!==t?t[0]:""},addPointOfInterest:function(t,r,n){var l,h=r.strid,d=r.attributes,u=this._rendering.getFlagForPrimitive(h,d);if(void 0!==this.styleClass&&""!==this.styleClass||(this.styleClass=r.styleClass),"billboard"===this.shapeType)if("icon"!==this.renderType||this.cssProcessed){if("text"===this.renderType){var c=r.name;this.poiName[this.nbPoi]=c;var p={};if(void 0===this.textMaterial[c]){var f,m=a.getCustomShaderMaterial([a.common,a.map,g.poiOnePass2d_instancing],!1);m.side=e.FrontSide,m.transparent=!0,m.depthTest=!0,m.depthWrite=!0,m.name="textMaterial"+c;var v=function(e){m.map=e,a.updateCommonUniforms(m),m._deferredMaterialsInit=!1,"dual"===this.renderMode&&(f.map=e,a.updateCommonUniforms(f),f._deferredMaterialsInit=!1)}.bind(this),_={styleClass:this.styleClass,pClass:"poiText",samplingFactor:this.samplingFactor};o.generateTextureFromName(c,_,p,v),this.widthTexture=p.width/this.samplingFactor,this.heightTexture=p.height/this.samplingFactor,m.uniforms.scaleCulling.value=this.scaleCulling,m.uniforms.halfScreenResolution.value=this.halfScreenResolution,m.uniforms.width.value=this.widthTexture,m.uniforms.height.value=this.heightTexture,m.uniforms.top.value=p.topText,m.uniforms.left.value=p.leftText,this.textMaterial[c]={prePass:void 0,postPass:m},"dual"===this.renderMode&&(f=m.clone(),this.textMaterial[c].prePass=m),r.localScale[0]*=this.widthTexture,r.localScale[1]*=this.heightTexture}}}else this.cssProcessed=!0,this.initBillboardCSSMap(),i.is(r.mapUrl)&&this.initBillboardMap(r),this.loadBillboardMap();var y={x:r.localScale[0]*this.widthTexture,y:r.localScale[1]*this.heightTexture,z:r.localScale[2]},b={x:t.x,y:t.y,z:r.height,w:r.altitude},x=this._rendering.getCompleteMaterialInfo(h,d);this._computeMinMax(this.minMaxOrig,b,y);var C=[r.localScale[0]*this.scaleCulling,r.localScale[1]*this.scaleCulling,r.localScale[2]*this.scaleCulling];l=[x.color.r,x.color.g,x.color.b,x.opacity],x.opacity<1&&(this.transparentPrimitive=!0),void 0===this.creator&&(this.creator=new s({indexed:!0,normalBinding:s.Binding.VERTEX,useTexCoord:!0,nbTexCoord:1,texCoordBinding:s.Binding.VERTEX,useColor:!1}),this.renderAnchor&&(this.creatorAnchor=new s({indexed:!0,normalBinding:s.Binding.VERTEX,useTexCoord:!0,nbTexCoord:1,texCoordBinding:s.Binding.VERTEX,useColor:!1})));var S={flags:u,color:l};"billboard"===this.shapeType&&(this._rendering.setTextureInfo(S,h,d,this)&&(i.is(this._indexUpdates)||(this._indexUpdates={}),this._indexUpdates[h]=d));if(this._addPoi(this.creator,this.creatorAnchor,r.strid,t.x,t.y,r.altitude,r.height,Number(r.orientation[0]),C[0],C[1],C[2],S),"mesh"===this.geometryMode){var D=this.creator.compilePrimitive("poi3D_primitive_"+this._poi,!0);if(this.primitiveNodes[this.nbPoi]=D,this.nbMesh++,this.renderAnchor){var P=this.creatorAnchor.compilePrimitive("poi3D_primitiveAnchor_"+this._poi,!0);this.primitiveAnchorNodes[this.nbPoi]=P}}return this.nbPoi++,y={x:r.localScale[0]*this.widthTexture,y:r.localScale[1]*this.heightTexture,z:r.localScale[2]}},setAttribute:function(){return!1},updateAttribute:function(){return!1},getMaterials:function(){var e=[];return i.is(this.matPrePass)&&e.push(this.matPrePass),i.is(this.matPostPass)&&e.push(this.matPostPass),i.is(this.matAnchorPostPass)&&e.push(this.matAnchorPostPass),e},getIndexForTextureUrl:function(e){return this._rendering.getIndexForTextureUrl(e)}});return g.poiOnePass2d_instancing={attributes:{},uniforms:{normalDepthTexture:{type:"t",value:null},width:{type:"f",value:1},height:{type:"f",value:1},top:{type:"f",value:0},left:{type:"f",value:0},switchDistance:{type:"f",value:0},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)},scaleCulling:{type:"f",value:1},diffuse:{type:"c",value:new e.Color(16777215)}},vertex_pars:["uniform vec2 halfScreenResolution;","uniform float switchDistance;","//varying float isOpaque;","uniform sampler2D normalDepthTexture;","uniform float width;","uniform float height;","uniform float top;","uniform float left;","varying vec2 posCenter;","varying vec4 colorW;","uniform float scaleCulling;","varying vec2 newUvs;","","// Compute offset to rescale the POI in screen space (fixed size)","float computeScaleOffset(float depthCenterCameraSpace) {","   float scaleOffset = 1.0;","   if (depthCenterCameraSpace > -switchDistance)","   {","      scaleOffset = -switchDistance / depthCenterCameraSpace;","   }","   return scaleOffset;","}",""].join("\n"),vertex:["//-------------- POI Billboard rendering - only post-pass --------------//","//---------------------------------------------------------------------//","//-------------------- 1. COMPUTE VERTEX POSITION ----------------------//","//---------------------------------------------------------------------//","colorW = color;","#ifdef IS_MULTI_INSTANCED","vec3 origin = vec3(0.0,0.0,0.0);","#else","vec3 origin = normal.xyz; // normal attribute contains the position of the billboard origin (top-left corner), in tile space","#endif","vec4 posOriginCameraSpace = viewMatrix * modelMatrix * vec4(origin.xyz, 1.0);","posOriginCameraSpace /= posOriginCameraSpace.w;","float scaleOffset = computeScaleOffset(posOriginCameraSpace.z); // / scaleCulling;","float topOffsetInPixels = top;","float leftOffsetInPixels = left;","float w = width;","float h = height;","#ifdef IS_MULTI_INSTANCED","vec2 offsetTileSpace = position.xy;","w *= instanceMatrix[0][0];","h *= instanceMatrix[1][1];","#else","vec2 offsetTileSpace = position.xy - origin.xy; // position is in tile space","offsetTileSpace.xy /= vec2(w*scaleCulling,h*scaleCulling);","offsetTileSpace.xy += vec2(0.5,-0.5);","#endif","offsetTileSpace.x += leftOffsetInPixels/width;","offsetTileSpace.y -= topOffsetInPixels/height;","vec2 offsetScreenSpace = scaleOffset*offsetTileSpace.xy*vec2(w,h)/halfScreenResolution;","vec4 posOriginScreenSpace = projectionMatrix * posOriginCameraSpace;","posOriginScreenSpace /= posOriginScreenSpace.w;","gl_Position = posOriginScreenSpace + vec4(offsetScreenSpace, 0.0, 0.0);"].join("\n"),fragment_pars:[].join("\n"),fragment:[].join("\n")},g.atlasing_PDSFX={name:"atlasing_PDSFX",attributes:{},uniforms:{atlasOffsetTexture:{type:"t2",value:a.whiteMap}},varyings:{texCoordCity:{type:"v2"}},VS_overridableFunctions:{ComputeVaryingValues:["float index = instanceFloats.y;","vec4 offset = texture2D(atlasOffsetTexture, vec2(0.5, (index+0.5)/800.0));","texCoordCity = vGetAttribTexCoord0().xy * vec2(offset.w, offset.z) + vec2(offset.x, offset.y);"].join("\n")},FS_overridableFunctions:{}},g.mapping_PDSFX={name:"mapping_PDSFX",depends:[],attributes:{},uniforms:{useMapCity:{type:"b",value:!1},mapCityLoaded:{type:"b",value:!0},mapCity:{type:"t2",value:a.whiteMap},alphaTestCity:{type:"f",value:.5}},varyings:{texCoordCity:{type:"v2"}},VS_overridableFunctions:{ComputeVaryingValues:["texCoordCity = vGetAttribTexCoord0().xy;"].join("\n")},FS_global_code:["vec4 _texelCity = vec4(1.0);","float _alphaCity = 1.0;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["if (useMapCity && mapCityLoaded) {","_texelCity = texture2D(mapCity, texCoordCity.xy);","","_alphaCity = _texelCity.w;","#ifdef GAMMA_INPUT","_alphaCity *= _texelCity.w;","#endif","","}"].join("\n"),_ComputeDiffuseTexel:["return vec4(_texelCity.xyz, 1.0);"].join("\n"),ComputeOpacity:["cOpacity *= _alphaCity;"].join("\n"),ComputeDiscard:["if ((_alphaCity < alphaTestCity) || (useMapCity && !mapCityLoaded)) {","return true;","}",""].join("\n")}},g.coloring_PDSFX={name:"coloring_PDSFX",depends:[],attributes:{},uniforms:{diffuseCity:{type:"c",value:new e.Color(16711680)},opacityCity:{type:"f",value:1}},varyings:{colorW:{type:"v4"},l_useColor:{type:"f"},l_useOpacity:{type:"f"},l_invisibility:{type:"f",value:0}},VS_global_code:["float getFlag(float flags, float row){","    float res = mod(flags, row*2.0); ","    if(res >= row){","       return 1.0;","   }","   return 0.0; ","}"].join("\n"),VS_overridableFunctions:{ComputeVaryingValues:["//colorW = vec4(vGetAttribColor(),1.0);","//float flags = vGetAttribTexCoord1().y;","colorW = instanceColor;","float flags = instanceFlag;","l_useColor = getFlag(flags, 1.0);","l_useOpacity = getFlag(flags, 2.0);","l_invisibility = getFlag(flags, 8.0);"].join("\n")},FS_global_code:["vec3 cityDiffuse;","float cityOpacity;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["cityDiffuse = diffuseCity;","cityOpacity = opacityCity;","if(l_useColor > 0.5 ) {","cityDiffuse = colorW.rgb;","}","if( l_useOpacity > 0.5 ) {","cityOpacity = colorW.a;","}"].join("\n"),ComputeAlbedo:["cAlbedo *= cityDiffuse.xyz;"].join("\n"),ComputeOpacity:["cOpacity *= cityOpacity;"].join("\n"),ComputeDiscard:["if (l_invisibility > 0.5) {","return true;","}",""].join("\n")}},g.poiOnePass2d_instancing_PDSFX={name:"poiOnePass2d_instancing_PDSFX",depends:[],attributes:{},uniforms:{width:{type:"f",value:50},height:{type:"f",value:60},top:{type:"f",value:0},left:{type:"f",value:0},switchDistance:{type:"f",value:0},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)}},varyings:{},VS_global_code:["// Compute offset to rescale the POI in screen space (fixed size)","float computeScaleOffset(float depthCenterCameraSpace) {","   float scaleOffset = 1.0;","   if (depthCenterCameraSpace > -switchDistance)","   {","      scaleOffset = -switchDistance / depthCenterCameraSpace;","   }","   return scaleOffset;","}"].join("\n"),VS_overridableFunctions:{ProcessClipSpacePosition:["","vec3 origin = vec3(0.0,0.0,0.0);","vec4 posOriginCameraSpace = vGetWorldViewMatrix() * instanceMatrix * vec4(origin.xyz, 1.0);","posOriginCameraSpace /= posOriginCameraSpace.w;","float scaleOffset = computeScaleOffset(posOriginCameraSpace.z); // / scaleCulling;","float topOffsetInPixels = instanceFloats.w;","float leftOffsetInPixels = instanceFloats.z;","float index = instanceFloats.y;","vec4 offset = texture2D(atlasOffsetTexture, vec2(0.5, (index+0.5)/800.0));","float w = width*offset.w;","float h = height*offset.z;","vec2 offsetTileSpace = vGetAttribPosition().xy;","offsetTileSpace.x += leftOffsetInPixels/w;","offsetTileSpace.y -= topOffsetInPixels/h;","w *= instanceMatrix[0][0];","h *= instanceMatrix[1][1];","vec2 offsetScreenSpace = scaleOffset*offsetTileSpace.xy*vec2(w,h)/halfScreenResolution;","vec4 posOriginScreenSpace = vGetProjectionMatrix() * posOriginCameraSpace;","posOriginScreenSpace /= posOriginScreenSpace.w;","ioPosition = posOriginScreenSpace + vec4(offsetScreenSpace, 0.0, 0.0);"].join("\n")},FS_overridableFunctions:{ComputeAlbedo:["return cAlbedo;"].join("\n"),ComputeOpacity:["return cOpacity;"].join("\n"),ComputeDiscard:["return false;"].join("\n")}},g.poiOnePass3d_instancing_PDSFX={attributes:{},uniforms:{switchDistance:{type:"f",value:0},scaleCulling:{type:"f",value:1},diffuseCity:{type:"c",value:new e.Color(16711680)},ambientCity:{type:"c",value:new e.Color(16711680)},opacityCity:{type:"f",value:1},alphaTestCity:{type:"f",value:.5}},varyings:{colorW:{type:"v4"},l_useColor:{type:"f"},l_useOpacity:{type:"f"},l_invisibility:{type:"f",value:0}},VS_global_code:["// Compute offset to rescale the POI in screen space (fixed size)","float computeScaleOffset(float depthCenterCameraSpace) {","float scaleOffset = -depthCenterCameraSpace/switchDistance;","if (depthCenterCameraSpace > -switchDistance) {","scaleOffset = 1.0;","}","if (switchDistance < 0.001) {","scaleOffset = -depthCenterCameraSpace/1000.0;","}","return scaleOffset;","}","float getFlag(float flags, float row){","    float res = mod(flags, row*2.0); ","    if(res >= row){","       return 1.0;","   }","   return 0.0; ","}"].join("\n"),VS_overridableFunctions:{ComputeVaryingValues:["colorW = instanceColor;","float flags = instanceFlag;","l_useColor = getFlag(flags, 1.0);","l_useOpacity = getFlag(flags, 2.0);","l_invisibility = getFlag(flags, 8.0);"].join("\n"),ProcessClipSpacePosition:["vec3 center = vec3(0.0,0.0,0.0);","vec4 posCenterCameraSpace = vGetWorldViewMatrix() * instanceMatrix * vec4(center, 1.0);","posCenterCameraSpace /= posCenterCameraSpace.w;","vec4 posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;","posCenterScreenSpace /= posCenterScreenSpace.w;","vec4 posVertexCameraSpace = vGetWorldViewMatrix() * instanceMatrix * vec4(vGetAttribPosition().xyz, 1.0);","posVertexCameraSpace /= posVertexCameraSpace.w;","vec4 vectorCameraSpace = posVertexCameraSpace - posCenterCameraSpace;","vec4 screenPos = posCenterCameraSpace + vec4(vectorCameraSpace.xyz*(computeScaleOffset(posCenterCameraSpace.z)/scaleCulling), 0.0);","ioPosition = vGetProjectionMatrix() * screenPos;"].join("\n"),ProcessViewTangentSpace:["ioWorldViewTS.Normal = normalize(vGetWorldViewMatrix() * instanceMatrix * vec4(vGetAttribNormal().xyz,0.0)).xyz;"].join("\n")},FS_global_code:["vec3 cityDiffuse;","float cityOpacity;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["cityDiffuse = diffuseCity;","cityOpacity = opacityCity;","if(l_useColor > 0.5 ) {","cityDiffuse = colorW.rgb;","}","if( l_useOpacity > 0.5 ) {","cityOpacity = colorW.a;","}"].join("\n"),ComputeAlbedo:["cAlbedo *= cityDiffuse;"].join("\n"),ComputeOpacity:["cOpacity *= cityOpacity;"].join("\n"),ComputeDiscard:["if (l_invisibility > 0.5) {","return true;","}","return false;"].join("\n")}},g.poiOnePass3dAnchorTriangle_instancing_PDSFX={attributes:{},uniforms:{switchDistance:{type:"f",value:0},scaleCulling:{type:"f",value:1},diffuseCity:{type:"c",value:new e.Color(16711680)},opacityCity:{type:"f",value:1},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)},halfWidth:{type:"f",value:.5}},varyings:{colorW:{type:"v4"},l_useColor:{type:"f"},l_useOpacity:{type:"f"},l_invisibility:{type:"f",value:0}},VS_global_code:["float getFlag(float flags, float row){","    float res = mod(flags, row*2.0); ","    if(res >= row){","       return 1.0;","   }","   return 0.0; ","}"].join("\n"),VS_overridableFunctions:{ComputeVaryingValues:["colorW = instanceColor;","float flags = instanceFlag;","l_useColor = getFlag(flags, 1.0);","l_useOpacity = getFlag(flags, 2.0);","l_invisibility = getFlag(flags, 8.0);"].join("\n"),ProcessClipSpacePosition:["vec3 center = instanceAnchor.xyz;","vec4 posCenterCameraSpace = vGetWorldViewMatrix() * vec4(center.xyz, 1.0);","posCenterCameraSpace /= posCenterCameraSpace.w;","float scaleOffset = 1.0;","float offsetScreenSpace = vGetAttribNormal().x *scaleOffset*halfWidth/halfScreenResolution.x;","float halfHeight = instanceAnchor.w;","vec4 positionCamSpace = vGetWorldViewMatrix() * vec4(center.xyz + vec3(0.0,0.0,halfHeight*vGetAttribPosition().z), 1.0);","vec4 posOriginScreenSpace = vGetProjectionMatrix() * positionCamSpace;","// we need to divide by the abs of .w to avoid weird values when closed top views","posOriginScreenSpace = posOriginScreenSpace/abs(posOriginScreenSpace.w);","vec4 positionCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;","positionCenterScreenSpace = positionCenterScreenSpace/abs(positionCenterScreenSpace.w);","vec2 vecExtr = (normalize( posOriginScreenSpace.xy - positionCenterScreenSpace.xy));","vec2 crossExtr = vec2(-vecExtr.y, vecExtr.x);","ioPosition = posOriginScreenSpace;","ioPosition.xy += crossExtr.xy*offsetScreenSpace;"].join("\n"),ProcessViewTangentSpace:["ioWorldViewTS.Normal = vec3(0.0, 0.0, 1.0);"].join("\n")},FS_global_code:["vec3 cityDiffuse;","float cityOpacity;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["cityDiffuse = diffuseCity;","cityOpacity = opacityCity;","if(l_useColor > 0.5 ) {","cityDiffuse = colorW.rgb;","}","if( l_useOpacity > 0.5 ) {","cityOpacity = colorW.a;","}"].join("\n"),ComputeAlbedo:["cAlbedo *= cityDiffuse.xyz;"].join("\n"),ComputeOpacity:["cOpacity *= cityOpacity;"].join("\n"),ComputeDiscard:["if (l_invisibility > 0.5) {","return true;","}","return false;"].join("\n")}},g.poiText_PDSFX={attributes:{},uniforms:{mapCity:{type:"t2",value:null},alphaTestCity:{type:"f",value:.5},top:{type:"f",value:0},left:{type:"f",value:0},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)}},varyings:{texCoordCity:{type:"v2"}},VS_overridableFunctions:{ComputeVaryingValues:["texCoordCity = vGetAttribTexCoord0().xy;"].join("\n"),ProcessClipSpacePosition:["vec3 positionLocal = vGetAttribPosition() + vec3(left, -top, 0.0);// - color.xyz; // position is in tile space while color contains center in tile space","vec4 posCenterCameraSpace = vGetWorldViewMatrix() * vec4(0.0, 0.0, 0.0, 1.0);","vec4 posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;","posCenterScreenSpace /= posCenterScreenSpace.w;","vec2 offsetScreenSpace = positionLocal.xy/halfScreenResolution;","ioPosition = posCenterScreenSpace + vec4(offsetScreenSpace, 0.0, 0.0);"].join("\n")},FS_global_code:["vec4 _texelCity = vec4(1.0);","float _alphaCity = 1.0;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["_texelCity = texture2D(mapCity, texCoordCity.xy);","_alphaCity = _texelCity.w;","#ifdef GAMMA_INPUT","_alphaCity *= _texelCity.w;","#endif",""].join("\n"),_ComputeDiffuseTexel:["return vec4(_texelCity.xyz, 1.0);"].join("\n"),ComputeAlbedo:["return vec3(1.0,1.0,1.0);"].join("\n"),ComputeOpacity:["return _alphaCity;"].join("\n"),ComputeDiscard:["if (_alphaCity < alphaTestCity) { ","return true;","}","return false;"].join("\n")}},g.poiTextOpti_PDSFX={attributes:{},uniforms:{top:{type:"f",value:0},left:{type:"f",value:0},width:{type:"f",value:1},height:{type:"f",value:1},samplingFactor:{type:"f",value:1},halfScreenResolution:{type:"v2",value:new e.Vector2(1920,955)},pattern:{type:"fv1",length:7,value:[1,1,1,1,1,1,1]},pixelSize:{type:"v2",value:new e.Vector2(.005,.005)},mapCity:{type:"t2",value:null},alphaTestCity:{type:"f",value:.5}},varyings:{texCoordCity:{type:"v2"}},VS_overridableFunctions:{ComputeVaryingValues:["texCoordCity = vGetAttribTexCoord0().xy;"].join("\n"),ProcessClipSpacePosition:["ioPosition = vGetProjectionMatrix() * vGetWorldViewMatrix() * vec4(0.0, 0.0, 0.0, 1.0);","ioPosition.x += ioPosition.w * (pixelSize.x*(vGetAttribTexCoord0().x * width + left));","ioPosition.y += ioPosition.w * (pixelSize.y*(vGetAttribTexCoord0().y * height - top));"].join("\n")},FS_global_code:["vec4 _texelCity = vec4(1.0);","float _alphaCity = 1.0;","#define NB_DIGIT_INT 1","#define NB_DIGIT_FLOAT 1.0","const float nbDigit = NB_DIGIT_FLOAT;","vec4 texelPattern;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["// texelCity = texture2D(mapCity, texCoordCity.xy);","vec2 uvDigit = texCoordCity.xy;","float newU = mod(uvDigit.x*nbDigit,1.0);","float indexLetter = floor(uvDigit.x*nbDigit);","vec3 indexColor = vec3(0.0,0.0,0.0);","newU *= 0.1;","if (indexLetter < 1.0) {","newU += pattern[0]*0.1;","indexColor = vec3(1.0,0.0,0.0);","}","#if NB_DIGIT_INT > 1","else if (indexLetter < 2.0) {","newU += pattern[1]*0.1;","indexColor = vec3(1.0,1.0,0.0);","}","#endif","#if NB_DIGIT_INT > 2","else if (indexLetter < 3.0) {","newU += pattern[2]*0.1;","indexColor = vec3(1.0,0.0,1.0);","}","#endif","#if NB_DIGIT_INT > 3","else if (indexLetter < 4.0) {","newU += pattern[3]*0.1;","indexColor = vec3(0.0,1.0,0.0);","}","#endif","#if NB_DIGIT_INT > 4","else if (indexLetter < 5.0) {","newU += pattern[4]*0.1;","indexColor = vec3(0.0,1.0,1.0);","}","#endif","#if NB_DIGIT_INT > 5","else if (indexLetter < 6.0) {","newU += pattern[5]*0.1;","indexColor = vec3(0.0,0.0,1.0);","}","#endif","#if NB_DIGIT_INT > 6","else if (indexLetter < 7.0) {","newU += pattern[6]*0.1;","indexColor = vec3(0.5,0.5,0.5);","}","#endif","_texelCity = texture2D(mapCity, vec2(newU, uvDigit.y));","_alphaCity = _texelCity.w;","#ifdef GAMMA_INPUT","_alphaCity *= _texelCity.w;","#endif",""].join("\n"),_ComputeDiffuseTexel:["return vec4(_texelCity.xyz, 1.0);"].join("\n"),ComputeAlbedo:["return vec3(1.0);",""].join("\n"),ComputeOpacity:["return _alphaCity;"].join("\n"),ComputeDiscard:["if (_alphaCity < alphaTestCity) { ","return true;","}","return false;"].join("\n")}},g.generateTextNode=function(e,t,i){var s=a.getPDSFXMaterial([g.poiText_PDSFX],"basic"),h=e._frmViewerContainer.getDimensions(),d={x:h.width/2,y:h.height/2};s.updatePDSFXUniform("halfScreenResolution",d),s.depthTest=!1,s.transparent=!0;s.name="generateTextNodeMaterial",e._frmViewerContainer.addEvent("resize",function(e,t){var i=e._frmViewerContainer.getDimensions(),r={x:i.width/2,y:i.height/2};t.updatePDSFXUniform("halfScreenResolution",r)}.bind(this,e,s));var u={};o.generateTextureFromName(t,i,u,function(e){s.map=e,a.updateCommonUniforms(s),s._deferredMaterialsInit=!1,s.updateDeferredMaterials()});var c=u.width/i.samplingFactor,p=u.height/i.samplingFactor;s.updatePDSFXUniform("top",u.topText),s.updatePDSFXUniform("left",u.leftText);var f=n.createRectangleNode({width:c,height:p,color:new r.Color(1,.5,.5,0),fill:!0,material:s});f.setPickable(r.NOPICKABLE),f.name="text";if(void 0===e.getView3D().getRenderPassManager().getPass("OverlayPostPass")){var m=new l(null,null,void 0,!0,!1,!1,"OverlayPostPass");m.idString="OverlayPostPass";var v="PoiTransparentOverlayPass";void 0===e.getView3D().getRenderPassManager().getPass(v)&&(v="ClearDepthPass"),e.getView3D().getRenderPassManager().addPass("OverlayPostPass",m,{after:v})}return f.setRenderPasses(["OverlayPostPass"]),f},g.createRectangle=function(e){var t,i,s,a,o,l,h,d,u,c,p,f,m,g,v;for(10,(t=new r.PrimitiveGroup).fillAttr=new r.FillAttributes,t.lineAttr=new r.LineAttributes,t.pointAttr=new r.PointAttributes,(i=new r.Buffer).size=12,i.component=r.VertexComponentEnum.POSITION,i.format=r.DataTypeEnum.FLOAT,i.dimension=3,i.data=new Float32Array(i.size),(s=new r.Buffer).size=3,s.component=r.VertexComponentEnum.NORMAL,s.format=r.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(s.size),(a=new r.Buffer).size=12,a.component=r.VertexComponentEnum.TEX_COORD_0,a.format=r.DataTypeEnum.FLOAT,a.dimension=3,a.data=new Float32Array(a.size),(o=new r.Buffer).indexBuffer=!0,o.size=4,o.format=r.DataTypeEnum.UINT,o.dimension=1,o.data=new Uint16Array(o.size),(l=new r.Buffer).indexBuffer=!0,l.size=4,l.format=r.DataTypeEnum.UINT,l.dimension=1,l.data=new Uint16Array(l.size),(h=new r.Buffer).indexBuffer=!0,h.size=4,h.format=r.DataTypeEnum.UINT,h.dimension=1,h.data=new Uint16Array(h.size),t.addBuffer(0,i),t.addBuffer(1,s),t.addBuffer(2,o),t.addBuffer(3,l),t.addBuffer(4,a),t.addBuffer(5,h),m=0,(v=o.data)[m++]=0,v[m++]=1,v[m++]=3,v[m++]=2,v=l.data,m=0,g=0;g<1;g++)v[m++]=g,v[m++]=g,v[m++]=g,v[m++]=g;for(m=0,(v=h.data)[m++]=0,v[m++]=1,v[m++]=3,v[m++]=2,v=i.data,m=0,m=0;m<12;m++)v[m]=0;for(m=0,(v=s.data)[m++]=0,v[m++]=0,v[m++]=1,m=0,(v=a.data)[m++]=0,v[m++]=0,v[m++]=0,v[m++]=1,v[m++]=0,v[m++]=0,v[m++]=1,v[m++]=1,v[m++]=0,v[m++]=0,v[m++]=1,v[m++]=0,g=0;g<1;g++)(d=new r.Primitive).nbIndices=4,d.connectivity=r.ConnectivityTypeEnum.TRIANGLE_STRIP,d.attr={fill:new r.FillAttributes(new r.Color(1-g/6,0,g/6,1),1),line:new r.LineAttributes,point:new r.PointAttributes},(u=new r.VertexComponent).component=r.VertexComponentEnum.POSITION,u.nbVertices=4,u.nbValuesPerVertex=3,u.format=r.DataTypeEnum.FLOAT,u.cardinality=0,u.bufferId=0,u.indices=new r.IndexArray,u.indices.format=r.DataTypeEnum.UINT,u.indices.bufferId=2,u.indices.offset=4*g,(c=new r.VertexComponent).component=r.VertexComponentEnum.NORMAL,c.nbVertices=4,c.nbValuesPerVertex=3,c.format=r.DataTypeEnum.FLOAT,c.cardinality=0,c.bufferId=1,c.indices=new r.IndexArray,c.indices.format=r.DataTypeEnum.UINT,c.indices.bufferId=3,c.indices.offset=4*g,(p=new r.VertexComponent).component=r.VertexComponentEnum.TEX_COORD_0,p.nbVertices=4,p.nbValuesPerVertex=3,p.format=r.DataTypeEnum.FLOAT,p.cardinality=0,p.bufferId=4,p.indices=new r.IndexArray,p.indices.format=r.DataTypeEnum.UINT,p.indices.bufferId=5,p.indices.offset=0,d.addVertexComponent(u),d.addVertexComponent(c),d.addVertexComponent(p),t.addPrimitive(d);return(f=n.createMeshNode(t,e)).setShadow(!1),f},g.generateTextNodeOpti=function(t,i,s){var n=i.toString().length.toString();if(void 0===g._poolTextNodeOpti[n]){var o=g.poiTextOpti_PDSFX;o.FS_global_code=o.FS_global_code.replace(/NB_DIGIT_INT \d/g,"NB_DIGIT_INT "+n),o.FS_global_code=o.FS_global_code.replace(/NB_DIGIT_FLOAT \d/g,"NB_DIGIT_FLOAT "+n),(u=a.getPDSFXMaterial([o],"basic")).name="generateTextNodeOpti";var h=t._frmViewerContainer.getChildren()[0].getDimensions(),d={x:h.width,y:h.height};u.updatePDSFXUniform("halfScreenResolution",d),u.depthTest=!1,u.transparent=!0;t._frmViewerContainer.getChildren()[0].addEvent("resize",function(e,t){var i=e._frmViewerContainer.getChildren()[0].getDimensions(),r={x:i.width,y:i.height};t.updatePDSFXUniform("halfScreenResolution",r)}.bind(this,t,u)),u.map=g.textTexture.clusterDigits.map,g._poolTextNodeOpti[n]=new c(u.clone.bind(u)),g._poolTextNodeOpti[n].name="textMaterialPool_"+n}for(var u=g._poolTextNodeOpti[n].use(),p=i,f=0,m=i.toString().length,v=[],_=0;_<m;++_)v.push(Math.floor((p-f)/Math.pow(10,m-1-_))),f+=v[_]*Math.pow(10,m-1-_);u.updatePDSFXUniform("pattern",v);var y=g.textTexture.clusterDigits.params.width,b=g.textTexture.clusterDigits.params.height;u.updatePDSFXUniform("width",Math.floor(y/10)*m),u.updatePDSFXUniform("height",b),u.updatePDSFXUniform("top",g.textTexture.clusterDigits.params.topText),u.updatePDSFXUniform("left",g.textTexture.clusterDigits.params.leftText*m/10),u.updatePDSFXUniform("samplingFactor",g.textTexture.clusterDigits.params.samplingFactor);var x=g.createRectangle(u);x.setPickable(r.NOPICKABLE),x.name="text",u.refreshUniforms=function(t,i){var r;if(!t._smallTargetPicking||t.materialToUse!==e.MaterialToUse.pickingMaterial&&t.materialToUse!==e.MaterialToUse.pickingMaterialInstancing&&t.materialToUse!==e.MaterialToUse.normalMaterial&&t.materialToUse!==e.MaterialToUse.depthMaterial)r=new e.Vector2(2/t.domElement.width,2/t.domElement.height);else{var s=2*t._gpuPickingTolerance+1;r=new e.Vector2(2/s,2/s)}this.updatePDSFXUniform("pixelSize",r)},a.updateCommonUniforms(u,!1);if(void 0===t.getView3D().getRenderPassManager().getPass("OverlayPostPass")){var C=new l(null,null,void 0,!0,!1,!1,"OverlayPostPass");C.idString="OverlayPostPass";var S="PoiTransparentOverlayPass";void 0===t.getView3D().getRenderPassManager().getPass(S)&&(S="ClearDepthPass"),t.getView3D().getRenderPassManager().addPass("OverlayPostPass",C,{after:S})}return x.setRenderPasses(["OverlayPostPass"]),x},g.generateTextTexture=function(e,t){var i={};o.generateTextureFromName(e,t,i,function(t){g.textTexture[e]={map:t,params:i}})},g.textTexture=[],g.scaleCulling=100,g._poolTextNodeOpti={},g}),define("DS/XCityModel/Content",["DS/XCityModel/Item","DS/XCityTools/Downloader","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools"],function(e,t,i,r,s){"use strict";return e.extend({defaults:{renderID:"",objectId:"",Rendering:null,loadInfo:{loaded:1,total:1}},metaData:{type:"Content",className:"Content"},create:function(e){var t=this._parent(e);this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this.addEvent("OnDestroy",this._cleanResource.bind(this));var i=e._urban;return this._urban=i,this.renderingProfileManager=this._urban.getRenderingProfileManager(),t},_cleanResource:function(){this.renderingProfileManager.getResourceProfile().removeRendering(this.parentFeatureID)},redraw:function(){console.error("redraw Interface should be implemented on derived classes ")},_getUrlOptions:function(e){return t.getUrlOptions(e)},_getDatasetBaseUrl:function(e){var t=e.split("?")[0],r=this._getDatasetId(t);if(i.is(r))return this._getDataSupplierUrl()+r+"/"},_changeUrlEnd:function(e){var t=this.get("url"),r=this._getDatasetBaseUrl(t),s=r.length,n=r.indexOf("resources");n>=s-10&&(r=r.slice(0,n));var a=t.split("?")[1],o=r+e;return i.is(a)&&(o+="?"+a),o},_getResourceUrl:function(e){return this._changeUrlEnd("resources/"+e)},_getStyleUrl:function(){return this._changeUrlEnd("style")},loadResource:function(e){t.isAPlatformService(this.get("url"))&&("enovia"!==this.get("type")&&i.is(e)&&(i.endsWith(e,".sld")?this.addSLDResource(this._getResourceUrl(e)):(i.endsWith(e,".png")||i.endsWith(e,".jpg"))&&this.addMapResource(this._getResourceUrl(e))))},loadStyle:function(){let e=this._attributes&&this._attributes.objectId,t="undefined"!=typeof xCity&&xCity.widgetData&&xCity.widgetData.datasetCollection&&xCity.widgetData.datasetCollection.get({id:e}),i=t?t.get("style"):null;return!1===(i&&(i.insource||i.customized))?null:this.getStyleFromServer()},getRendering:function(){var e=null;return i.is(this._rendering)&&(e=this._rendering),e},getRenderingHandler:function(){var e=null;return i.is(this._rendering)&&(e=this._rendering),e},getMaterial:function(){var e=this.getRendering();return i.is(e)?e.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)},get:function(e){var t,r,n=this.getRendering();return"heightOffset"===e&&(e="elevationOffset"),this.renderingProfileManager&&i.is(n)&&n.hasAttribute(e)?(r=this.getMaterial(),i.is(r)&&(t=(r=s.getJSONFromRendering(r))[e])):t=this._parent(e),t},set:function(e,t){var r={},s=this.getRendering();"heightOffset"===e&&(e="elevationOffset"),this.renderingProfileManager&&i.is(s)&&s.hasAttribute(e)?(r[e]=t,this.setMaterial(r)):this._parent(e,t)},resetRenderingAttribute:function(e){if(i.is(this.renderingProfileManager)){let t=this.getRendering();if(i.is(t)){let i=t.getDependantAttributes(e);for(let e=0;e<i.length;e++){const t=i[e];this.renderingProfileManager.resetRenderingAttribute(this.parentFeatureID,t)}}}},addSLDResource:function(e,t){if(i.is(e)&&i.is(this.renderingProfileManager)&&i.is(this.parentFeatureID)){var r=this;this.downloadResource(e,function(i,s,n){if(s)try{var a=i;r.renderingProfileManager._parseSLD(a,r.parentFeatureID,e)}catch(e){console.error("Error while parsing SLD: "+e.stack)}t&&t(i,s,n)})}},addMapResource:function(e){if(i.is(e)&&i.is(this.renderingProfileManager)&&i.is(this.parentFeatureID)){var t=this;this.downloadResource(e,function(i,r,s){if(r){var n={};n.mapUrl=e,t.renderingProfileManager.getResourceProfile().addRendering(t.parentFeatureID,n)}})}},downloadResource:function(e,i){t.download(e,{},999999,function(e,t,i,r){r(t,e,i)},void 0,i)},updateStatistics:function(){var e=this.get("url");if(t.isAPlatformService(e)){var i=t.getDataSupplierUrlFromUrl(e),r=this;this.requestStatistics(i,function(e,t,i){t&&r.setStatistics(e.analytics)})}},_getDatasetId:function(e){return this.get("objectId")},getUrlOptions:function(e){var t=e.split("?");return t[t.length-1]},setStatistics:function(e){this.set("statistics",e)},requestStatistics:function(e,i){const r="undefined"!=typeof xCity&&xCity.widgetData&&xCity.widgetData.datasetCollection,s=t.getUuidFromUrl(e);if(r&&r.get(s)&&r.get(s).get("analytics")){let e=JSON.parse(JSON.stringify(r.get(s)));setTimeout(i.bind(this),0,e,!0)}else t.download(e,{responseType:"json"},999999,function(e,t,i,r){r(t,e,i)},void 0,i)},toJSON:function(e){var t=this._parent(e);return delete t.Rendering,t},requestResourceStyle:function(e,t){if(i.is(e)&&i.is(this.renderingProfileManager)&&i.is(this.parentFeatureID)){var r=this;this.downloadResource(e,function(i,s,n){if(s)try{var a=i;r.renderingProfileManager._parseSLDInfos(a,r.parentFeatureID,e)}catch(e){try{var o=JSON.parse(i);r.renderingProfileManager.addStyleToResource(r.parentFeatureID,o)}catch(t){console.error("Error while parsing SLD: "+e.stack),console.error("Error while parsing JSON: "+t.stack)}}t&&t(i,s,n)})}},getStyleFromServer:function(e){if(t.isAPlatformService(this.get("url"))&&"enovia"!==this.get("type")){var i=this._getStyleUrl();this.requestResourceStyle(i,e)}},uploadStyleToServer:function(e){if(t.isAPlatformService(this.get("url"))&&"enovia"!==this.get("type")){var i=this.getRenderingToUpload(),r=this._getAuthoringStyleUrl(),s={method:"PUT"},n=new FormData,a=new Blob([JSON.stringify(i)],{type:"text/json"});n.append("file",a,"style.json"),s.data=n,this.serverRequest(r,s,e)}},deleteStyleOnserver:function(e){if(t.isAPlatformService(this.get("url"))&&"enovia"!==this.get("type")){var i=this._getAuthoringStyleUrl(),r={method:"DELETE"};this.serverRequest(i,r,e)}},_getUUid:function(e){return this.get("objectId")},_getOptions:function(e){var t=e.split("?");return 2===t.length?"?"+t[1]:""},_getAuthoringStyleUrl:function(){var e=this.get("url"),r=t.resolveUrl(e),s=r.split("/datasupplier/");if(2!==s.length)return console.error("globe url format not usable for authoring"),"";var n=this._getOptions(r),a=this._getUUid(r),o=null;return i.is(a)&&(o=s[0]+"/authoring/dataset/"+a+"/style"+n),o},getRenderingToUpload:function(){var e=this.renderingProfileManager.getResourceProfile().getRenderingForLayer(this),t=this.renderingProfileManager.getSessionProfile().getRenderingForLayer(this);return e._priorityClean(t.getRenderingData()),e.addOver(t),e.toJSON()},serverRequest:function(e,i,r){var s={headers:{},withCredentials:!0,onComplete:r,onFailure:r},n=Object.assign(s,i);t.authenticatedRequest(e,n)},_getDataSupplierUrl:function(){return t.getDataSupplierUrl()}})}),define("DS/XCityGeometry/Building",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityTools/Debug","DS/Visualization/PolygonTessellator","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s){"use strict";var n=e.singleton({init:function(){},build:function(e){if(void 0!==e.roofCreator&&void 0!==e.shape&&0!==e.shape.length&&void 0!==e.altitude&&void 0!==e.height){var t=e.wallCreator,i=e.roofCreator,r=e.shape,s=void 0!==e.altitude?e.altitude:0,n=void 0!==e.height?e.height:100,a=void 0!==e.roofHeight?e.roofHeight:0,o=void 0!==e.roofAngle?e.roofAngle:0,l=void 0!==e.infoInd?e.infoInd:-1,h=void 0!==e.roofObjects?e.roofObjects:0,d=void 0!==e.roofShape?e.roofShape:0;r=this.getClockWiseRing(r),t&&(t.startPrimitive(),this.buildWalls({creator:t,shape:r,holes:e.holes,altitude:s,height:n,infoInd:l}),t.endPrimitive(e.pIdentifer)),i.startPrimitive(),a<=0||0===o||r.length>20?(this.buildFlatRoof({creator:i,shape:r,holes:e.holes,altitude:s+n,infoInd:l,uvCalc:e.uvCalc}),h&&this.buildRoofObjects({roofCreator:i,wallCreator:t,shape:r,altitude:s,height:n,infoInd:l})):"GABLE"===d&&4===r.length&&a>0?this.buildGableRoof({creator:i,shape:r,altitude:s+n,height:a,infoInd:l}):this.buildRoof({creator:i,shape:r,altitude:s+n,height:a,angle:o,infoInd:l}),i.endPrimitive(e.pIdentifer)}},getClockWiseRing:function(e,t){for(var i=0,r=e.length-1,s=0;s<e.length;r=s++)i+=e[r].x*e[s].y-e[s].x*e[r].y;var n=e.length,a=[];if(!0!==t&&.5*i>=0||!0===t&&.5*i<=0)for(;n--;)a.push(e[n]);else a=a.concat(e);return a},__getBevelVec1:function(e,i,r){var s=Math.atan2(i.y-e.y,i.x-e.x),n=Math.atan2(r.y-e.y,r.x-e.x);s>n&&(n+=2*Math.PI);var a=(s+n)/2,o=-Math.cos(a),l=-Math.sin(a);return new t.Vector2(o,l)},__getBevelVec2:function(e,t,r){var s,a,o,l,h,d=n.__v1,u=n.__v2,c=n.__v3,p=n.__v4,f=n.__v5,m=n.__v6;return d.set(e.x-t.x,e.y-t.y),u.set(e.x-r.x,e.y-r.y),s=d.normalize(),a=u.normalize(),c.set(-s.y,s.x),p.set(a.y,-a.x),f.copy(e).add(c),m.copy(e).add(p),f.equals(m)?p.clone():(f.copy(t).add(c),m.copy(r).add(p),o=s.dot(p),l=m.sub(f).dot(p),0===o&&(i.log("Either infinite or no solutions!"),0===l?i.log("Its finite solutions."):i.log("Too bad, no solutions.")),(h=l/o)<0?this.__getBevelVec1(e,t,r):s.multiplyScalar(h).add(f).sub(e).clone())},_getBevelVec:function(e,t,i){return this.__getBevelVec2(e,t,i)},_scalePt2:function(e,t,r){return t||i.log("die"),t.clone().multiplyScalar(r).add(e)},_isCoherent:function(e,t){var i,r,s,a,o,l,h,d,u,c,p,f,m,g,v,_;for(i=0,o=e.length;i<o;i++){if((r=i+1)===o&&(r=0),n.__v1.set(e[r].x-e[i].x,e[r].y-e[i].y),n.__v1.normalize(),n.__v2.set(t[r].x-t[i].x,t[r].y-t[i].y),n.__v2.normalize(),n.__v1.dot(n.__v2)<.9)return!1;for(s=0;s<o;s++)if((a=s+1)===o&&(a=0),p=e[r].x-e[i].x,f=e[r].y-e[i].y,m=e[i].x-e[s].x,h=(g=e[i].y-e[s].y)*p-g*f,0!==(l=g*(v=e[a].x-e[s].x)-m*(_=e[a].y-e[s].y))&&0!==h&&0!==(d=p*_-f*v)&&(c=h/d,(u=l/d)>.1&&u<.9&&c>.1&&c<.9))return!1}return!0},_positionRandom:function(e){return Math.abs(e.x*e.x*e.y%100)/100},_makeTriFace:function(e,t,i,r,s,n,a,o){e.pushVertex(t),e.pushVertex(i),e.pushVertex(r),e.pushNormal(s),e.pushTexCoord(0,[n,a]),e.pushTexCoord(0,[n,a]),e.pushTexCoord(0,[n,a]),e.pushTexCoord(1,[0,0]),e.pushTexCoord(1,[1,0]),e.pushTexCoord(1,[.5,1]),e.pushVertexIndices([o,o+1,o+2])},_makeQuadFace1:function(e,t,i,r,s,n,a,o,l){e.pushVertex(t),e.pushVertex(i),e.pushVertex(r),e.pushVertex(s),e.pushNormal(n),e.pushNormal(n),e.pushTexCoord(0,[o,0]),e.pushTexCoord(0,[o,a]),e.pushTexCoord(0,[o,0]),e.pushTexCoord(0,[o,a]),e.pushVertexIndices([l,l+2,l+3]),e.pushVertexIndices([l,l+3,l+1])},_makeQuadFace2:function(e,t,i,r,s,n,a,o,l,h,d){e.pushVertex(t),e.pushVertex(i),e.pushVertex(r),e.pushVertex(s),e.pushNormal(n),e.pushNormal(n),e.pushTexCoord(0,[l,h]),e.pushTexCoord(0,[l,h]),e.pushTexCoord(0,[l,h]),e.pushTexCoord(0,[l,h]),a>0&&o>0?(e.pushTexCoord(1,[0,0]),e.pushTexCoord(1,[a,0]),e.pushTexCoord(1,[0,o]),e.pushTexCoord(1,[a,o])):(e.pushTexCoord(1,[a,o]),e.pushTexCoord(1,[a,o]),e.pushTexCoord(1,[a,o]),e.pushTexCoord(1,[a,o])),e.pushVertexIndices([d,d+2,d+3]),e.pushVertexIndices([d,d+3,d+1])},buildWalls:function(e){if(void 0!==e.creator&&void 0!==e.shape&&0!==e.shape.length){var t,i,r,s,a=e.creator,o=a.current.nbVertices,l=void 0!==e.altitude?e.altitude:0,h=void 0!==e.height?e.height:1,d=void 0!==e.infoInd?e.infoInd:-1,u=e.shape,c=[];if(c.push(u),e.holes)for(var p=e.holes.length,f=0;f<p;f++){var m=this.getClockWiseRing(e.holes[f],!0);c.push(m)}for(var g=c.length,v=0;v<g;v++){var _=(u=c[v]).length;for(t=0;t<_;++t)i=t+1<_?t+1:0,s=(r=n.__vec1.set(u[i].x-u[t].x,u[i].y-u[t].y,0)).length(),r.normalize(),this._makeQuadFace1(a,[u[t].x,u[t].y,l],[u[i].x,u[i].y,l],[u[t].x,u[t].y,l+h],[u[i].x,u[i].y,l+h],[-r.y,r.x,0],s,d,o+4*t);o=a.current.nbVertices}}},buildRoofSides:function(e){if(void 0!==e.creator&&void 0!==e.shape&&0!==e.shape.length&&void 0!==e.topShape&&0!==e.topShape.length){var t,r,s,a,o,l,h,d=e.creator,u=d.current.nbVertices,c=e.shape,p=c.length,f=e.topShape,m=void 0!==e.altitude?e.altitude:0,g=void 0!==e.height?e.height:1,v=void 0!==e.infoInd?e.infoInd:-1;for(t=0;t<p;++t)(r=t+1)===p&&(r=0),d.pushVertex([c[t].x,c[t].y,m]),d.pushVertex([c[r].x,c[r].y,m]),h=(s=n.__vec1.set(c[r].x-c[t].x,c[r].y-c[t].y,0)).length(),s.normalize(),d.pushVertex([f[t].x,f[t].y,m+g]),d.pushVertex([f[r].x,f[r].y,m+g]),d.pushTexCoord(0,[v,0]),d.pushTexCoord(0,[v,0]),d.pushTexCoord(0,[v,0]),d.pushTexCoord(0,[v,0]),a=n.__vec2.set(f[t].x-c[t].x,f[t].y-c[t].y,g),(l=n.__vecN.crossVectors(a,s)).normalize(),d.pushNormal([l.x,l.y,l.z]),d.pushNormal([l.x,l.y,l.z]),a.crossVectors(s,l),o=n.__vec3,d.pushTexCoord(1,[0,0]),d.pushTexCoord(1,[h,0]),o.set(f[t].x-c[t].x,f[t].y-c[t].y,g),d.pushTexCoord(1,[s.dot(o),a.dot(o)]),o.set(f[r].x-c[t].x,f[r].y-c[t].y,g),d.pushTexCoord(1,[s.dot(o),a.dot(o)]),d.pushVertexIndices([u+4*t,u+4*t+2,u+4*t+3]),d.pushVertexIndices([u+4*t,u+4*t+3,u+4*t+1])}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},buildFlatRoof:function(e){if(void 0!==e.creator&&void 0!==e.shape&&0!==e.shape.length){var n,a,o,l,h,d,u=e.creator,c=u.current.nbVertices,p=(e.shape.length,void 0!==e.altitude?e.altitude:0),f=void 0!==e.infoInd?e.infoInd:-1,m=[];if(e.holes)for(var g=e.holes.length,v=0;v<g;v++){var _=this.getClockWiseRing(e.holes[v],!0);m.push(_)}var y=new r;for(o=e.shape,n=0;n<o.length;n++)h=o[n].x,d=-o[n].y,y.addPointToCurrentPolygonLoop(h,d);if(y.closeCurrentPolygonLoop(),l=m,s.is(l))for(n=0;n<l.length;n++){for(o=l[n],a=0;a<o.length;a++)h=o[a].x,d=-o[a].y,y.addPointToCurrentPolygonLoop(h,d);y.closeCurrentPolygonLoop()}y.endCurrentPolygon();var b=y.createNode3D(new t.MeshBasicMaterial({force:!0}),p);if(s.is(b)){var x,C=b.children[0].mesh3js.geometry[0].vertexIndexArray,S=b.children[0].mesh3js.geometry[0].vertexPositionArray;!0===e.uvCalc&&((x=b.getBoundingBox()).width=x.max.x-x.min.x,x.height=x.max.y-x.min.y);var D=S.length;for(n=0;n<D;n+=3){u.pushVertex([S[n],S[n+1],S[n+2]]),u.pushTexCoord(0,[f,1]);var P=[-1,-1];if(!0===e.uvCalc){var w=new t.Vector3(S[n],S[n+1],S[n+2]);P=this.calculatePlanarUV(w,x)}u.pushTexCoord(1,P)}var M=C.length,T=[];for(n=0;n<M;n+=3)T[n]=[],T[n].push(C[n]+c),T[n].push(C[n+1]+c),T[n].push(C[n+2]+c),u.pushVertexIndices(T[n]),u.pushNormal([0,0,1])}}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},_appendHoles:function(e,i){if(i&&i.length>0)for(var r=0;r<i.length;r++){var s=i[r],n=new t.Path(s);e.push(n)}},buildRoofObjects:function(e){if(void 0!==e.roofCreator&&void 0!==e.shape&&0!==e.shape.length){var t=e.roofCreator,r=e.wallCreator,s=e.shape,a=s.length,o=void 0!==e.altitude?e.altitude:0,l=void 0!==e.height?e.height:1,h=void 0!==e.infoInd?e.infoInd:-1;if(this.buildRoofAcroterion({creator:t,shape:s,altitude:o+l,infoInd:h,height:.4,width:.4}),!(a>10)){var d,u,c,p,f,m,g,v,_,y,b,x,C,S,D=n.__v1,P=this._positionRandom(s[0]),w=this._positionRandom(s[1]);for(g=a-1,v=a-1,D.subVectors(s[0],s[a-1]),p=m=D.length(),d=1;d<a;d++)D.subVectors(s[d],s[d-1]),(u=D.length())>m&&(m=u,v=d-1),u<p&&(p=u,g=d-1);if(n.__v1.subVectors(s[g+1<a?g+1:0],s[g]),p=(c=n.__vec1.set(n.__v1.x,n.__v1.y,0)).length(),c.normalize(),n.__v1.subVectors(s[g>0?g-1:a-1],s[g]),m=(f=n.__vec2.set(n.__v1.x,n.__v1.y,0)).length(),f.normalize(),n.__vec3.crossVectors(f,c),n.__vec3.z<0&&f.multiplyScalar(-1),n.__vec3.length()>.9&&(C=0,S=4*P,_=[.5,1,2.5,2,1],y=s[g].x+c.x*_[0]+f.x*_[1],b=s[g].y+c.y*_[0]+f.y*_[1],n.__v1.set(c.x*_[2],c.y*_[2]),n.__v2.set(f.x*_[3],f.y*_[3]),m>_[1]+_[3]))for(;p>_[0]+_[2]&&C<S;)this.buildRoofBox({creator:t,altitude:o+l+.01,infoInd:h,xCoord:y,yCoord:b,direction1:n.__v1,direction2:n.__v2,height:_[4],type:4}),y+=c.x*(_[0]+_[2]),b+=c.y*(_[0]+_[2]),p-=_[0]+_[2],C++;if(n.__v1.subVectors(s[v+1<a?v+1:0],s[v]),p=(c=n.__vec1.set(n.__v1.x,n.__v1.y,0)).length(),c.normalize(),m=n.__v1.subVectors(s[v>0?v-1:a-1],s[v]).length(),(f=n.__vec2.crossVectors(c,n.__vecN.set(0,0,1))).normalize(),r&&l>25)if(4===a)if(Math.abs(p-m)<2)for(n.__v1.set(c.x*p*.5,c.y*p*.5),n.__v2.set(f.x*m*.5,f.y*m*.5),y=s[v].x+c.x*p*.25+f.x*m*.25,b=s[v].y+c.y*p*.25+f.y*m*.25,this.buildRoofBox({creator:t,wallCreator:r,altitude:o+l+.01,infoInd:h,xCoord:y,yCoord:b,direction1:n.__v1,direction2:n.__v2,height:2.5+2*P}),o=o+l+2.5+2*P,S=2+5*P,C=0;C<S;++C)x={creator:t,coordX:y+c.x*p*(P/2>.45?.45:P/2)+f.x*m*(w/2>.45?.45:w/2),coordY:b+c.y*p*(P/2>.45?.45:P/2)+f.y*m*(w/2>.45?.45:w/2),altitude:o,height:2.5+5*P,size:P/4,infoInd:h},P=this._positionRandom({x:x.coordX,y:x.coordY}),w=this._positionRandom({x:x.coordY,y:x.coordX}),this.buildRoofPyramid(x);else u=[P/2<.1?.1:P/2>.25?.25:P/2,2*w<.45?.45:2*w>.65?.65:2*w],n.__v1.set(c.x*p*u[1],c.y*p*u[1]),n.__v2.set(f.x*m*.5,f.y*m*.5),y=s[v].x+c.x*p*u[0]+f.x*m*.25,b=s[v].y+c.y*p*u[0]+f.y*m*.25,this.buildRoofBox({creator:t,wallCreator:r,altitude:o+l+.01,infoInd:h,xCoord:y,yCoord:b,direction1:n.__v1,direction2:n.__v2,height:2.5+2*P}),p*(1-u[0]-u[1])>.5*m+10&&(n.__v1.set(c.x*m*.5,c.y*m*.5),n.__v2.set(f.x*m*.5,f.y*m*.5),y=s[v].x+c.x*(p*(u[0]+u[1])+5)+f.x*m*.25,b=s[v].y+c.y*(p*(u[0]+u[1])+5)+f.y*m*.25,this.buildRoofBox({creator:t,altitude:o+l+.1,infoInd:h,xCoord:y,yCoord:b,direction1:n.__v1,direction2:n.__v2,height:4+2*P,type:5}));else m>12&&(u=[P/2<.15?.15:P/2>.45?.45:P/2,2*P<.1?.1:2*P>.45?.45:2*P],n.__v1.set(c.x*p*u[1],c.y*p*u[1]),n.__v2.set(8*f.x,8*f.y),this.buildRoofBox({creator:t,wallCreator:r,altitude:o+l+.01,infoInd:h,xCoord:s[v].x+c.x*p*u[0]+2*f.x,yCoord:s[v].y+c.y*p*u[0]+2*f.y,direction1:n.__v1,direction2:n.__v2,height:2.5+2*P}))}}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},buildRoofAcroterion:function(e){if(void 0!==e.creator&&void 0!==e.shape&&0!==e.shape.length){var t,r,s,a,o,l=e.creator,h=l.current.nbVertices,d=e.shape,u=d.length,c=void 0!==e.altitude?e.altitude:0,p=void 0!==e.infoInd?e.infoInd:-1,f=void 0===e.height?1:e.height,m=void 0===e.width?.5:e.width,g=[],v=[];for(t=0,r=(a=d.length)-1,s=t+1;t<a;t++,r++,s++)r=r===a?0:r,s=s===a?0:s,g.push(this._getBevelVec(d[t],d[r],d[s]));for(t=0,a=d.length;t<a;t++)o=this._scalePt2(d[t],g[t],-m),v.push(o);for(t=0;t<u;++t)r=t+1===u?0:t+1,n.__v1.set(d[r].x-d[t].x,d[r].y-d[t].y),a=n.__v1.length(),n.__v1.normalize(),this._makeQuadFace2(l,[d[t].x,d[t].y,c],[d[r].x,d[r].y,c],[d[t].x,d[t].y,c+f],[d[r].x,d[r].y,c+f],[-n.__v1.y,n.__v1.x,0],a,f,p,2,h),h+=4,n.__v1.set(v[r].x-v[t].x,v[r].y-v[t].y),a=n.__v1.length(),n.__v1.normalize(),this._makeQuadFace2(l,[v[r].x,v[r].y,c],[v[t].x,v[t].y,c],[v[r].x,v[r].y,c+f],[v[t].x,v[t].y,c+f],[n.__v1.y,-n.__v1.x,0],a,f,p,2,h),h+=4,this._makeQuadFace2(l,[d[t].x,d[t].y,c+f],[d[r].x,d[r].y,c+f],[v[t].x,v[t].y,c+f],[v[r].x,v[r].y,c+f],[0,0,1],-1,-1,p,3,h),h+=4}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},buildRoofBox:function(e){if(void 0!==e.creator&&void 0!==e.xCoord&&void 0!==e.yCoord&&void 0!==e.direction1&&void 0!==e.direction2){var t,r,s,a,o=e.creator,l=o.current.nbVertices,h=e.xCoord,d=e.yCoord,u=e.direction1,c=e.direction2,p=void 0!==e.altitude?e.altitude+.01:0,f=void 0!==e.height?e.height:2.5,m=void 0!==e.type?e.type:1,g=void 0!==e.infoInd?e.infoInd:-1;t=n.__v3.set(h,d),r=n.__v4.set(h+u.x,d+u.y),s=n.__v5.set(h+c.x,d+c.y),a=n.__v6.set(h+u.x+c.x,d+u.y+c.y),this._makeQuadFace2(o,[t.x,t.y,p+f],[r.x,r.y,p+f],[s.x,s.y,p+f],[a.x,a.y,p+f],[0,0,1],u.length(),c.length(),g,m,l),e.wallCreator?(l=e.wallCreator.current.nbVertices,this._makeQuadFace1(e.wallCreator,[t.x,t.y,p],[r.x,r.y,p],[t.x,t.y,p+f],[r.x,r.y,p+f],[-c.x,-c.y,0],0,g,l),this._makeQuadFace1(e.wallCreator,[r.x,r.y,p],[a.x,a.y,p],[r.x,r.y,p+f],[a.x,a.y,p+f],[u.x,u.y,0],0,g,l+4),this._makeQuadFace1(e.wallCreator,[a.x,a.y,p],[s.x,s.y,p],[a.x,a.y,p+f],[s.x,s.y,p+f],[c.x,c.y,0],0,g,l+8),this._makeQuadFace1(e.wallCreator,[s.x,s.y,p],[t.x,t.y,p],[s.x,s.y,p+f],[t.x,t.y,p+f],[-u.x,-u.y,0],0,g,l+12)):(this._makeQuadFace2(o,[t.x,t.y,p],[r.x,r.y,p],[t.x,t.y,p+f],[r.x,r.y,p+f],[-c.x,-c.y,0],u.length(),f,g,m,l+4),this._makeQuadFace2(o,[r.x,r.y,p],[a.x,a.y,p],[r.x,r.y,p+f],[a.x,a.y,p+f],[u.x,u.y,0],c.length(),f,g,m,l+8),this._makeQuadFace2(o,[a.x,a.y,p],[s.x,s.y,p],[a.x,a.y,p+f],[s.x,s.y,p+f],[c.x,c.y,0],u.length(),f,g,m,l+12),this._makeQuadFace2(o,[s.x,s.y,p],[t.x,t.y,p],[s.x,s.y,p+f],[t.x,t.y,p+f],[-u.x,-u.y,0],c.length(),f,g,m,l+16))}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},buildRoofPyramid:function(e){if(void 0!==e.creator&&void 0!==e.coordX&&void 0!==e.coordY){var t=e.creator,r=t.current.nbVertices,s={x:e.coordX,y:e.coordY},n=void 0!==e.altitude?e.altitude:0,a=void 0!==e.height?e.height:0,o=void 0!==e.size?e.size:.2,l=void 0!==e.infoInd?e.infoInd:-1;this._makeTriFace(t,[s.x,s.y+o,n],[s.x-o,s.y,n],[s.x,s.y,n+a],[-.5,.5,0],l,6,r),this._makeTriFace(t,[s.x-o,s.y,n],[s.x,s.y-o,n],[s.x,s.y,n+a],[-.5,-.5,0],l,6,r+3),this._makeTriFace(t,[s.x,s.y-o,n],[s.x+o,s.y,n],[s.x,s.y,n+a],[.5,-.5,0],l,6,r+6),this._makeTriFace(t,[s.x+o,s.y,n],[s.x,s.y+o,n],[s.x,s.y,n+a],[.5,.5,0],l,6,r+9)}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},buildRoof:function(e){if(void 0!==e.creator&&void 0!==e.shape&&0!==e.shape.length){var t,r,s,n,a,o=e.creator,l=e.shape,h=void 0!==e.altitude?e.altitude:0,d=void 0!==e.height?e.height:1,u=void 0!==e.angle?e.angle:0,c=void 0!==e.infoInd?e.infoInd:-1,p=d,f=-1*d/Math.tan(u),m=[],g=[];for(t=0,r=(n=l.length)-1,s=t+1;t<n;t++,r++,s++)r===n&&(r=0),s===n&&(s=0),m.push(this._getBevelVec(l[t],l[r],l[s]));for(t=0,n=l.length;t<n;t++)a=this._scalePt2(l[t],m[t],f),g.push(a);if(!this._isCoherent(g,l)){for(p*=.7,f*=.3,g=[],t=0,n=l.length;t<n;t++)a=this._scalePt2(l[t],m[t],f),g.push(a);if(!this._isCoherent(g,l))return this.buildFlatRoof({creator:o,shape:l,altitude:h,infoInd:c})}this.buildRoofSides({creator:o,shape:l,altitude:h,height:p,infoInd:c,topShape:g}),this.buildFlatRoof({creator:o,shape:g,altitude:h+p,infoInd:c})}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},buildGableRoof:function(e){if(void 0!==e.creator&&void 0!==e.shape&&4===e.shape.length){var t,r,s,a,o,l=e.creator,h=l.current.nbVertices,d=e.shape,u=void 0!==e.altitude?e.altitude:0,c=void 0!==e.height?e.height:10,p=void 0!==e.infoInd?e.infoInd:-1,f=void 0===e.edgeSize?0:e.edgeSize;s=n.__vec1,a=n.__vec2,o=n.__vecN,t=[(d[0].x+d[3].x)/2,(d[0].y+d[3].y)/2,u+c],r=[(d[1].x+d[2].x)/2,(d[1].y+d[2].y)/2,u+c],s.set(d[3].x-d[0].x,d[3].y-d[0].y,0),a.set(t[0]-d[0].x,t[1]-d[0].y,c),o.crossVectors(s,a),o.normalize(),l.pushVertex([d[0].x,d[0].y,u]),l.pushVertex([d[3].x,d[3].y,u]),l.pushVertex(t),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(1,[0,0]),l.pushTexCoord(1,[s.length(),0]),l.pushTexCoord(1,[s.length()/2,c]),l.pushNormal([o.x,o.y,o.z]),l.pushVertexIndices([h+0,h+1,h+2]),s.set(d[1].x-d[2].x,d[1].y-d[2].y,0),a.set(r[0]-d[2].x,r[1]-d[2].y,c),o.crossVectors(s,a),o.normalize(),l.pushVertex([d[2].x,d[2].y,u]),l.pushVertex([d[1].x,d[1].y,u]),l.pushVertex(r),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(1,[0,0]),l.pushTexCoord(1,[s.length(),0]),l.pushTexCoord(1,[s.length()/2,c]),l.pushNormal([o.x,o.y,o.z]),l.pushVertexIndices([h+3,h+4,h+5]),s.set(r[0]-t[0],r[1]-t[1],0),s.normalize(),l.pushVertex([t[0]-f*s.x,t[1]-f*s.y,t[2]]),l.pushVertex([r[0]+f*s.x,r[1]+f*s.y,r[2]]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(1,[0,0]),l.pushTexCoord(1,[0,0]),s.set(d[1].x-d[0].x,d[1].y-d[0].y,0),a.set(t[0]-d[0].x,t[1]-d[0].y,c),o.crossVectors(a,s),o.normalize(),l.pushVertex([d[0].x-f*s.x-f*a.x,d[0].y-f*s.y-f*a.y,u-f*a.z]),l.pushVertex([d[1].x+f*s.x-f*a.x,d[1].y+f*s.y-f*a.y,u-f*a.z]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(1,[0,0]),l.pushTexCoord(1,[0,0]),l.pushNormal([o.x,o.y,o.z]),l.pushNormal([o.x,o.y,o.z]),l.pushVertexIndices([h+8,h+6,h+7]),l.pushVertexIndices([h+8,h+7,h+9]),s.set(d[3].x-d[2].x,d[3].y-d[2].y,0),a.set(r[0]-d[2].x,r[1]-d[2].y,c),o.crossVectors(a,s),o.normalize(),l.pushVertex([d[2].x-f*s.x-f*a.x,d[2].y-f*s.y-f*a.y,u-f*a.z]),l.pushVertex([d[3].x+f*s.x-f*a.x,d[3].y+f*s.y-f*a.y,u-f*a.z]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(1,[0,0]),l.pushTexCoord(1,[0,0]),l.pushNormal([o.x,o.y,o.z]),l.pushNormal([o.x,o.y,o.z]),l.pushVertexIndices([h+10,h+7,h+6]),l.pushVertexIndices([h+10,h+6,h+11])}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},calculatePlanarUV:function(e,t){var i=e.sub(t.min);return[i.x/t.width,i.y/t.height]}});return n.__vec1=new t.Vector3,n.__vec2=new t.Vector3,n.__vec3=new t.Vector3,n.__vecN=new t.Vector3,n.__v1=new t.Vector2,n.__v2=new t.Vector2,n.__v3=new t.Vector2,n.__v4=new t.Vector2,n.__v5=new t.Vector2,n.__v6=new t.Vector2,n}),define("DS/XCityRendering/RenderingHandler",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s){"use strict";return e.extend({init:function(e,t){this.urban=e,this._needRebuild=!1,this._prefix="3DXCity",this._allIds="AllIds",this._inputParam=r._JSONToRendering(t)},needsRebuild:function(){return this._needRebuild},flagAsRebuilt:function(e){this._needRebuild=!e},getIds:function(){var e=[];if(s.is(this._content)){var t;s.is(this._content._itemParent)&&(t=this._content._itemParent.get("id"),s.is(t)&&e.push(t)),t=this._content.get("id"),s.is(t)&&e.push(t);var i=this._content.get("renderID");s.is(i)&&""!==i&&e.push(i)}return s.is(this.type)&&e.push(this._prefix+this.type),s.is(this._allIds)&&e.push(this._allIds),e=s.removeDuplicateInArray(e)},setContent:function(e){this._content=e},shouldRebuild:function(){return!1},updatePresetValues:function(e){return e},getDependantAttributes:function(e){return[e]},isChangingCurrentMaterial:function(e,t){for(var i in e){e[i];if("color"===i){if(e[i].toUpperCase().toLowerCase()!==t[i].toLowerCase()&&e[i].rgbToHex()!==t[i].toLowerCase()&&e[i].hexToRgb()!==t[i].toLowerCase())return!0}else if(e[i]!==t[i])return!0}return!1},_getMaterial:function(e){s.is(e)||(e=this._initMaterial(),r._setMaterialFromProfile(e,this.defaultMaterial));var t=this._getMaterialInfo();return r._setMaterialFromProfile(e,t),r._setMaterialMapFromProfile(e,t,this),i.updateCommonUniforms(e),e},_getMaterialNoMap:function(e){s.is(e)||(e=this._initMaterial(),r._setMaterialFromProfile(e,this.defaultMaterial));var t=this._getMaterialInfo();return r._setMaterialFromProfile(e,t),e.mapUrl=null,e.map=null,i.updateCommonUniforms(e),e},setMaterialToMesh:function(e,t){e.mesh3js.material=t,e.setMaterial(t),this._lastSeenMaterial=t},dispose:function(){this._parent()},initMesh:function(e){if(s.is(e)){var t;t=this._getMaterial(),i.updateCommonUniforms(t),this.setMaterialToMesh(e,t)}},removeMesh:function(e){}})}),define("DS/XCityRendering/RenderingProfileBase",["DS/Visualization/ThreeJS_DS","DS/XCityTools/RenderingTools","DS/XCityCore/Profile","DS/xCityBasicUtils/Utils","DS/XCityTools/Downloader","DS/XCityRendering/Rendering","DS/XCityRendering/FeatureRendering"],function(e,t,i,r,s,n,a){"use strict";return i.extend({init:function(e,t){this.SkyId="Sky",this.GroundId="Ground",this._parent(e,t)},_getRendering:function(e,t){var i,s=null;return r.is(this._ids)&&r.is(this._ids[e])&&(r.is(t)?r.is(this._ids[e].elementRendering)&&r.is(this._ids[e].elementRendering[t])&&(s=this._ids[e].elementRendering[t]):(i=this._ids[e].materialIndex,r.is(this._materials)&&r.is(this._materials[i])&&(s=this._materials[i]))),s},resetRender:function(e,t){var i,s=t.getManager();r.is(t)&&r.is(t._ids)&&(i=t._ids),s.resetRender(i)},resetRendering:function(e,t){if(r.is(this._ids)&&r.is(this._materials)){var i={};if(r.is(e))r.is(t)?(this._ids[e].elementRendering[t]={},i[e]={}):(this._ids[e]={},i[e]={});else{for(var s in this._ids)this._ids.hasOwnProperty(s)&&(i[s]={});this._ids={},this._materials={}}if(!0===this._enabled)this.getManager().resetRender(i)}},setGround:function(e){var t;if(r.is(this._ids)||(this._ids={}),r.is(this._ids[this.GroundId])){var i=this._ids[this.GroundId].materialIndex;t=this._materials[i]}else(t={}).id=this._findnewmaterialId(),r.is(this._materials)||(this._materials={}),this._materials[t.id]=t,this._ids[this.GroundId]={materialIndex:t.id};if(r.is(e.showOcean)&&(t.showOcean=e.showOcean,void 0!==this._ids["3DXCityGeometricTerrain"])){i=this._ids["3DXCityGeometricTerrain"].materialIndex;(t=this._materials[i]).showOcean=e.showOcean}!0===this._enabled&&this.setRender(this._urban,this)},setSky:function(e){this._parseSky(e),!0===this._enabled&&this.setRender(this._urban,this)},getSky:function(){if(!r.is(this._ids)||!r.is(this._materials)||!r.is(this._ids[this.SkyId]))return null;var e=this._ids[this.SkyId].materialIndex;return this._materials[e]},setEffect:function(e){this._urban.getEnvironment().addRenderProfile(this.getName(),e)},getGlobalEffects:function(){return this._urban.environment._getprofileparams(this.getName())},resetEffect:function(){},enableOcean:function(e){r.is(this._ids)||(this._ids={}),this.setGround({showOcean:e})},isOceanEnabled:function(){var e,t,i=null;return r.is(this._ids)&&r.is(this._ids[this.GroundId])&&(e=this._ids[this.GroundId].materialIndex,t=this._materials[e],r.is(t)&&r.is(t.showOcean)&&(i=t.showOcean)),i},unload:function(){var e,t,i,s,n;if(r.is(this._materials)){var a,o=Object.keys(this._materials);for(a=0;a<o.length;a++)t=o[a],e=this._materials[t],r.is(e)&&r.is(e.map)&&e.map.dispose&&(e.map.dispose(),e.map=void 0)}if(s=this.getManager(),this.getName()!==s.defaultProfile)for(t in(i=s.getProfile(s.defaultProfile))._ids={},this._ids)this._ids.hasOwnProperty(t)&&(n={materialIndex:0},i._ids[t]=n)},_parseConfig:function(e){if(r.is(e.Configuration)){var t=this.getManager();this._show=[],this._hide=[],r.is(e.Configuration.Show)&&(this._show=e.Configuration.Show.slice()),r.is(e.Configuration.Hide)&&(this._hide=e.Configuration.Hide.slice());var i={show:this._show,hide:this._hide},s=function(e,t){var i=e.id,r=e.get("name");i?r?(t.show&&(t.show.indexOf(i)>=0?e.setVisible(!0):t.show.indexOf(r)>=0&&e.setVisible(!0)),t.hide&&(t.hide.indexOf(i)>=0?e.setVisible(!1):t.hide.indexOf(r)>=0&&e.setVisible(!1))):(t.show&&t.show.indexOf(i)>=0&&e.setVisible(!0),t.hide&&t.hide.indexOf(i)>=0&&e.setVisible(!1)):r&&(t.show&&t.show.indexOf(r)>=0&&e.setVisible(!0),t.hide&&t.hide.indexOf(r)>=0&&e.setVisible(!1))};t.addProfile(e.name,function(e,t){t.show.length+t.hide.length>0&&(e._dataModelPrivate.traverse(s,!0,t),e.modelRoot.traverse(s,!0,t))},i,"ShowHide")}},_parseEffects:function(e,t){var i=this.getManager(),s=null;r.is(e.Effects)&&(s=r.clone(e.Effects));var n=!0;if(t&&t._urban&&t._urban._coreVersion){var a=t._urban._coreVersion.split(".");a[0]=Number(a[0].split("R")[1]),a[1]=Number(a[1]),a[2]=Number(a[2]),a[0]<424?n=!1:424===a[0]&&a[1]<=21&&a[2]<=42&&(n=!1)}else n=!1;!1===n&&(s&&s.sun&&s.sun.ambientFactor&&(s.sun.ambientFactor/=1.7),s&&s.sun&&s.sun.diffuseFactor&&(s.sun.diffuseFactor/=.7)),t.addRenderProfile(e.name,s);var o=this;i.addProfile(e.name,function(){t.setRendering(o.getName())},e,"EffectsParams")},_parseRendering:function(e){if(r.is(e.Rendering)){var t=0;for(t=0;t<e.Rendering.length;t++)this._parseOneRenderingGroup(e.Rendering[t])}},_findnewmaterialId:function(){var e=0;if(r.is(this._materials))for(;r.is(this._materials[e]);)e++;return e},setRender:function(e,t){var i,s,n=t.getManager();r.is(t)&&(r.is(t._ids)&&(i=t._ids),r.is(t._materials)&&(s=t._materials)),n.setRender(i,s)},isRenderInitialized:function(){return this.hasNodeName("RenderingGroup")},_initRender:function(){this.getManager().addProfile(this.getName(),this.setRender,this,"RenderingGroup")},_profileToGroundMaterial:function(e){var t,i=e;r.is(e.showOcean)&&(i.showOcean=e.showOcean);var s=["oceanColor","oceanColorDetection"];for(t=0;t<s.length;t++)r.is(e[s[t]])&&(i[s[t]]=this._profileToColor(e[s[t]]));var n=["oceanAlpha","oceanRangeDetection"];for(t=0;t<n.length;t++)r.is(e[n[t]])&&(i[n[t]]=this._profileToFloat(e[n[t]]));return void 0!==e.oceanTextureUrl&&(i.oceanTextureUrl=this._profileToUrl(e.oceanTextureUrl)),i},_profileToSkyMaterial:function(e){var t=e,i=e;return t.cubeMapUrl=this._profileToUrl(i.cubeMapUrl),t},_parseSky:function(e){if(r.is(e)){var t=this._profileToSkyMaterial(e),i=this;if(r.is(this._ids)||(this._ids={}),t.id=this._findnewmaterialId(),r.is(this._materials)||(this._materials={}),this._materials[t.id]=t,this._ids[this.SkyId]={materialIndex:t.id},r.is(t.cubeMapUrl)&&e.cubeMapExt){var s=e.cubeMapExt;".png"!==s&&"hdr"!==s&&(s=".png");var n=t.cubeMapUrl+"_4K"+s,a=t.cubeMapUrl+"_4K_rmips"+s,o=function(e){r.is(e)&&(e._urbanurl=t.cubeMapUrl,t.cubeMap._rmips=e),!0===i._enabled&&i.getManager().setRender(i.SkyId)};this.loadTexture(this._urban,function(e){r.is(e)?(e._urbanurl=t.cubeMapUrl,t.cubeMap=e,i.loadTexture(i._urban,o,a)):(t.cubeMap=e,!0===i._enabled&&i.getManager().setRender(i.SkyId))},n)}}},_initMaterialFromProfile:function(e){return t._JSONToRendering(e)},_profileToColor:function(t){return"object"==typeof t&&(t="rgb("+255*t.r+","+255*t.g+","+255*t.b+")"),new e.Color(t)},_profileToUrl:function(e){var t=null;return"string"==typeof e&&(t="null"===e?null:e),t},_profileToFloat:function(e){var t=null;return"string"==typeof e?t=Number(e):"number"==typeof e&&(t=e),r.is(t)||(t=null),t},_loadTexture:function(e,t,i,s){if(!r.is(i))return!1;i.toload++;return this.loadTexture(this._urban,function(n){i.toload--,r.is(n)&&(i.material[e]=n,r.endsWith(t,".png")&&!1!==i.material.transparent&&(i.material.transparent=!0)),i.toload<=0&&(i.loaded=!0,s(n))},t),!0},_getRelationMatrix:function(){var e,t,i=!1,s={};if(r.is(this._ids)){var n,a=Object.keys(this._ids),o=a.length;for(n=0;n<o;n++)e=a[n],t=this._ids[e].materialIndex,r.is(this._ids[e].elementRendering)?(r.is(s.elementRendering)||(s.elementRendering=[]),s.elementRendering.push(e)):r.is(this._ids[e].datavizRenderings)?(r.is(s.datavizRenderings)||(s.datavizRenderings=[]),s.datavizRenderings.push(e)):(r.is(s[t])||(s[t]=[]),s[t].push(e)),i=!0}return i||(s=null),s},_getDisplayConfiguration:function(){var e;return r.is(this._show)&&this._show.length>0&&(r.is(e)||(e={}),e.Show=this._show),r.is(this._hide)&&this._hide.length>0&&(r.is(e)||(e={}),e.Hide=this._hide),e},_getJSONAllRendering:function(e){var t,i,s,n=e.length;for(i=0;i<n;i++){s=e[i];var a=this._getJSONRendering(s),o=this._getJSONRenderingElement(s);r.is(o)&&(r.is(a)||(a={Ids:s}),a.ElementRendering=o);var l=this._getJSONRenderingDataviz(s);r.is(l)&&(r.is(a)||(a={Ids:s}),a.DatavizRendering=l),r.is(a)&&(r.is(t)||(t=[]),t.push(a))}return t},_getJSONRenderingElement:function(e){var t,i=this._ids[e];if(r.is(i)){var s=i.elementRendering;if(r.is(s)){var n,a,o,l=Object.keys(s),h=l.length;for(n=0;n<h;n++)a=s[l[n]],r.is(a)&&(o=a.toJSON(),r.is(o)&&(r.is(t)||(t=[]),t.push(o)))}}return t},_getJSONRenderingDataviz:function(e){var t,i=this._ids[e];if(r.is(i)){var s=i.datavizRenderings;if(r.is(s)){var n,a,o,l,h=Object.keys(s),d=h.length;for(n=0;n<d;n++)a=s[l=h[n]],r.is(a)&&(o=a.toJSON(),r.is(t)||(t={}),t[l]=o)}}return t},_getInputProfile:function(){var e=this._parent();e.Effects=this.getGlobalEffects();var t,i,s,n,a,o=this._getDisplayConfiguration();if(r.is(o)&&(e.Configuration=o),this.matrix=this._getRelationMatrix(),r.is(this.matrix)){e.Rendering=[];var l=Object.keys(this.matrix),h=l.length;for(s=0;s<h;s++){i=l[s];var d=this.matrix[i],u=d.length;if("elementRendering"===i)t=this._getJSONAllRendering(d),r.is(t)&&(e.Rendering=e.Rendering.concat(t));else if("datavizRenderings"===i)for(n=0;n<u;n++){a=d[n],t=this._getJSONRendering(a);var c=this._getJSONRenderingDataviz(a);r.is(c)&&(r.is(t)||(t={Ids:a}),t.DatavizRendering=c),r.is(t)&&e.Rendering.push(t)}else t=this._getJSONRendering(d),r.is(t)&&e.Rendering.push(t);t=null}}return e},_getJSONRendering:function(e){var i;if(r.is(e)){var s=e;Array.isArray(e)&&(s=e[0]);var n=this._ids[s];if(r.is(n)){i={Ids:e};var a=n.materialIndex;r.is(a)&&(i.Material=t._RenderingToJSON(t._JSONToRendering(this._materials[a])),i.Material=this.deactivateToolsFromExperience(i.Material))}}return i},deactivateToolsFromExperience:function(e){return r.is(e)&&r.is(e.terrainAnalyzer)&&r.is(e.terrainAnalyzer.mode)&&delete e.terrainAnalyzer.mode,e},disable:function(){this._parent(),this.unload()},_getMaterialForFeatureFromLayer:function(e,i){var s=this;if(r.is(i)&&console.warn("NOT implemented"),r.is(s._ids)&&r.is(s._ids[e])){var n={},a=s._ids[e].materialIndex;if(r.is(s._materials)){var o=s._materials[a];t._setMaterialFromProfile(n,o)}return n}return null},getManager:function(){return this._urban.getRenderingProfileManager()},setName:function(e){var t=this.getName();this._parent(e),this._urban.getEnvironment().defaults[this.getName()]=this._urban.getEnvironment().defaults[t],this._urban.getEnvironment().defaults[t]=void 0},getReferencedId:function(e){var t=null;if(r.is(e)&&r.is(this._ids)){var i=e.get("id");if(r.is(this._ids[i]))t=i;else if(i=e.get("renderID"),r.is(this._ids[i]))t=i;else{var s=e._itemParent;r.is(s)&&(i=s.get("id"),r.is(this._ids[i])&&(t=i))}}return t},loadTexture:function(e,t,i,r){s.loadTexture(t,i,r)},loadTextureCube:function(e,t,i){this.loadTexture(e,t,i,1)},clean:function(){this._ids=null,this._materials=null}})}),define("DS/XCityRendering/RenderingHandlerDownload",["DS/XCityTools/ShaderTools","DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandler","DS/XCityTools/RenderingTools"],function(e,t,i,r,s,n,a){"use strict";return n.extend({init:function(e,t){this._parent(e,t)},updateRendering:function(e){this._parent(e);this._specificToUpdate=!0},applyRendering:function(e){!0===this._specificToUpdate&&this.updateSpecificRendering()},_removeMeshFromList:function(e,t){if(s.is(e)&&s.is(this._specificMaterials[t]))for(var i=0;i<this._specificMaterials[t].meshes.length;i++){if(this._specificMaterials[t].meshes[i].id===e.id&&(this._specificMaterials[t].meshes.splice(i,1),i--,this._specificMaterials[t].meshes.length<=0)){delete this._specificMaterials[t];break}}},_whenDisposeOfMeshes:function(e,t){for(var i=0;i<e.length;i++){var r=e[i];s.is(r.observers)||(r.observers=[]),r.observers.push(this._removeMeshFromList.bind(this,r,t))}},_replaceDrawingGroup:function(e,t){s.is(e.gas)&&(e.gas=t),s.is(e.material)&&(e.material=t)},_addSpecificGeometry:function(e){s.is(this._specificMaterials)||(this._specificMaterials={},this._specificToUpdate=!0);Object.keys(this._specificMaterials).length;var t,n={},a={},o=this;for(var l in e.traverse(function(e){if(e instanceof i){if(e.mesh3js&&e.mesh3js.material&&(void 0===n[e.mesh3js.material.id]&&(n[e.mesh3js.material.id]=[]),n[e.mesh3js.material.id].push(e),s.is(e.mesh3js.geometry)&&e.mesh3js.geometry.length>0)){var t=e.mesh3js.geometry[0];if(s.is(t.drawingGroups)&&t.drawingGroups.length>0){a[e.mesh3js.material.id]||(a[e.mesh3js.material.id]={}),a[e.mesh3js.material.id][t.id]||(a[e.mesh3js.material.id][t.id]={}),a[e.mesh3js.material.id][t.id].material||(a[e.mesh3js.material.id][t.id].material=[]),a[e.mesh3js.material.id][t.id].gas||(a[e.mesh3js.material.id][t.id].gas=[]);for(var l=0;l<t.drawingGroups.length;l++)s.is(t.drawingGroups[l].material)&&s.is(t.drawingGroups[l].gas)&&t.drawingGroups[l].material.id!=t.drawingGroups[l].gas.id?(t.drawingGroups[l].material=o._cloneMaterial(t.drawingGroups[l].material),a[e.mesh3js.material.id][t.id].material.push(t.drawingGroups[l].material),t.drawingGroups[l].gas=o._cloneMaterial(t.drawingGroups[l].gas),a[e.mesh3js.material.id][t.id].gas.push(t.drawingGroups[l].gas)):s.is(t.drawingGroups[l].material)?(o._replaceDrawingGroup(t.drawingGroups[l],o._cloneMaterial(t.drawingGroups[l].material)),a[e.mesh3js.material.id][t.id].material.push(t.drawingGroups[l].material)):s.is(t.drawingGroups[l].gas)&&(o._replaceDrawingGroup(t.drawingGroups[l],o._cloneMaterial(t.drawingGroups[l].gas)),a[e.mesh3js.material.id][t.id].gas.push(t.drawingGroups[l].gas))}}}else e instanceof r&&s.is(e.material)&&(void 0===n[e.material.id]&&(n[e.material.id]=[]),n[e.material.id].push(e))}),n)if(n.hasOwnProperty(l)){var h=n[l];this._whenDisposeOfMeshes(h,l),s.is(this._specificMaterials[l])?this._specificMaterials[l].meshes=this._specificMaterials[l].meshes.concat(h):this._specificMaterials[l]={meshes:h};var d=h[0].material;if(s.is(d)||(d=h[0].mesh3js.material),this._specificMaterials[l].material=this._cloneMaterial(d),h[0].material&&h[0].setMaterial(this._specificMaterials[l].material),s.is(a[l]))for(var u in a[l])if(a[l].hasOwnProperty(u)){for(this._specificMaterials[l].geometries||(this._specificMaterials[l].geometries={}),this._specificMaterials[l].geometries[u]||(this._specificMaterials[l].geometries[u]={}),this._specificMaterials[l].geometries[u].dgnum=0,this._specificMaterials[l].geometries[u].DG={},this._specificMaterials[l].geometries[u].DG.material=[],this._specificMaterials[l].geometries[u].DG.gas=[],t=0;t<a[l][u].gas.length;t++)this._specificMaterials[l].geometries[u].DG.gas.push(this._cloneMaterial(a[l][u].gas[t])),this._specificMaterials[l].geometries[u].dgnum++;for(t=0;t<a[l][u].material.length;t++)this._specificMaterials[l].geometries[u].DG.material.push(this._cloneMaterial(a[l][u].material[t]))}this._specificToUpdate=!0}this.updateSpecificRendering(n)},updateMeshSpecificRendering:function(e){if(e&&e.material){var t={};t[e.material.id]=!0,this.updateSpecificRendering(t)}},updateSpecificRendering:function(e){this._specificToUpdate=!0,this._setSpecificRendering(null,e);var t=this.getCurrentRenderingDifference();s.is(t)&&(Object.keys(t).length>0&&(this._specificToUpdate=!0,this._setSpecificRendering(t,e)))},_isSpecModel:function(){var e=!1,t=this._content;return s.is(t)&&s.is(t.get("spec"))&&(e=!0),e},_cloneMaterial:function(i){if(s.is(i)){var r,n=this;this._isSpecModel()&&i.ambient&&1===i.ambient.r&&1===i.ambient.g&&1===i.ambient.b&&(i.ambient=i.color),void 0===i.cloneWithAnim?!0===i._usePhongLighting?((r=t.MaterialUtils.createShinyFaceMaterial(i)).metalness=0,r.roughness=1,r.textureBlending=t.TextureBlendOperations.MODULATE):(r=i.clone()).textureBlending=t.TextureBlendOperations.MODULATE:(r=i.cloneWithAnim(),e.unregisterAnimationUniforms(i),e.deactivateAnimationUniforms(r)),a._setMaterialFromProfile(r,this.getDefaultRenderingData()),a._setMaterialFromProfile(r,i),a._setMaterialMapFromProfile(r,i,this);var o=r.map;return o&&o.image&&!o.image.complete&&o.onLoadCallbacks&&o.onLoadCallbacks.push(function(){r.map=o,e.updateCommonUniforms(r),r.updateDeferredMaterials&&(r._deferredMaterialsInit=!1);var t={};t[r.id]=!0,n.updateSpecificRendering(t)}),e.updateCommonUniforms(r),r}},_setSpecificMaterial:function(t,r){var n,o,l,h,d,u,c,p,f;for(h=0;h<t.meshes.length;h++)if(d=t.meshes[h],u=t.material,d instanceof i){if(c=t.material,s.is(r)&&(u=r,d.mesh3js.material.updateDeferredMaterials&&(d.mesh3js.material._deferredMaterialsInit=!1)),s.is(t.geometries)){l=d.mesh3js.geometry[0],s.is(r)&&(u=r,c=r);var m=0,g=0;for(o=0;o<l.drawingGroups.length;o++)l.drawingGroups[o].material&&(p=l.drawingGroups[o].material,r||(u=t.geometries[l.id].DG.material[m],m++)),l.drawingGroups[o].gas&&(f=l.drawingGroups[o].gas,r||(c=t.geometries[l.id].DG.gas[g],g++)),s.is(r)&&(n=d.mesh3js.material),c&&f&&(a._setMaterialFromProfile(f,c),a._setMaterialMapFromProfile(f,c,this),e.updateCommonUniforms(f)),u&&p&&(a._setMaterialFromProfile(p,u),a._setMaterialMapFromProfile(p,u,this),e.updateCommonUniforms(p),c&&f&&f.id!==p.id&&(f.force=!1)),f=null,p=null}else n=d.mesh3js.material,a._setMaterialFromProfile(n,u),a._setMaterialMapFromProfile(n,u,this),e.updateCommonUniforms(n),this.setMaterialToMesh(d,n);this._lastSeenMaterial=n,f&&(this._lastSeenMaterial=f),p&&(this._lastSeenMaterial=p),this.applyElementRendering(d)}else s.is(r)&&(u=r),n=d.material,a._setMaterialFromProfile(n,u),a._setMaterialMapFromProfile(n,u,this),e.updateCommonUniforms(n),d.setMaterial(n),this.applyElementRendering(d)},_setSpecificRendering:function(e,t){var i,r,n,a;if(s.is(this._specificMaterials)&&this._specificToUpdate){for(n=Object.keys(this._specificMaterials),s.is(t)&&(n=Object.keys(t)),r=0;r<n.length;r++)i=n[r],a=this._specificMaterials[i],s.is(a)&&this._setSpecificMaterial(a,e);this._specificToUpdate=!1}},removeMesh:function(e){this._parent(e)}})}),define("DS/XCityRendering/RenderingProfile",["DS/XCityRendering/RenderingProfileBase","DS/xCityBasicUtils/Utils","DS/XCityRendering/FeatureRendering","DS/XCityRendering/PrimitiveRendering","DS/XCityTools/OGCFilter","DS/XCityRendering/DatavizRendering","DS/XCityTools/RenderingTools","DS/XCityTools/TextureManager"],function(e,t,i,r,s,n,a,o){"use strict";return e.extend({init:function(e,t){this.level=50,this._parent(e,t)},getRenderingForId:function(e,r){var s,n,a=r;return t.is(r)||(a=new i),t.is(this._ids)&&t.is(this._ids[e])&&(t.is(this._materials)&&(s=this._ids[e].materialIndex,t.is(s)&&(a._priorityClean(this._materials[s]),a.addOver(this._materials[s]))),n=this._ids[e].elementRendering,t.is(n)&&a.addPrimitives(n),n=this._ids[e].datavizRenderings,t.is(n)&&a.addRenderings(n)),a},addOnlyPrimitiveRendering:function(e,i,r){t.is(this._ids)||(this._ids={}),t.is(this._ids[e])||(this._ids[e]={}),t.is(this._ids[e].elementRendering)||(this._ids[e].elementRendering={});var s={ElementIds:i,ElementMaterial:r};this._parseElementRender(e,s)},addPrimitiveRendering:function(e,t,i){this.addOnlyPrimitiveRendering(e,t,i),this.getManager().renderPrimitive(e,t)},isMaterialInfo:function(e){return e&&(e.Material||e.DatavizRendering||e.ElementRendering)},featureIsLine:function(e){let t=this._urban.getLayerRoot().getRoot().findChildById(e,!0);return t&&t.getContent()&&t.getContent().getFactory()&&t.getContent().getFactory()._node&&"FactoryLine"==t.getContent().getFactory()._node.name},addRendering:function(e,i,r){if(t.is(r))this.addPrimitiveRendering(e,r,i);else if(t.is(e)&&t.is(i)){var s={};s.Ids=e,this.isMaterialInfo(i)?s=Object.assign(i,s):s.Material=i,this._parseOneRenderingGroup(s),this.cleanMaterials()}},cleanMaterials:function(){var e=this._materials,i=this._ids;if(t.is(e)&&t.is(i)){var r,s,n,a=Object.keys(i),o=a.length,l={};for(r=0;r<o;r++)n=i[s=a[r]].materialIndex,t.is(n)&&(l[n]=!0);for(o=(a=Object.keys(e)).length,r=0;r<o;r++)s=a[r],t.is(l[s])||delete this._materials[s]}},addOnlyRendering:function(e,i,r){t.is(r)?this.addOnlyPrimitiveRendering(e,r,i):this.addRendering(e,i,r)},addFilterRendering:function(e,i,r){var n;if(t.is(e)&&t.is(r)){t.is(i)||(i=new s);var a={};a.Ids=[e],a.DatavizRendering={},n=this._findnewdatavizId(e),a.DatavizRendering[n]={ElementMaterial:r,Filter:i},this._parseOneRenderingGroup(a)}return n},addDatavizRendering:function(e,i){var r;if(t.is(e)&&t.is(i)){var s={};s.Ids=[e],s.DatavizRendering={},r=this._findnewdatavizId(e),s.DatavizRendering[r]={DatavizMaterial:i},this._parseOneRenderingGroup(s)}return r},getRenderingForPrimitive:function(e,i,s){var n,a=s;return t.is(s)||(a=new r).addOverIds(i),t.is(this._ids)&&t.is(this._ids[e])&&(n=this._ids[e].elementRendering,t.is(n)&&t.is(n[i])&&a.addOver(n[i])),a},_parseElementIds:function(e){var t;return t=e,Array.isArray(e)||("string"==typeof e?t=[e]:"number"==typeof e&&(t=[e.toString()])),t},_addElementRenderingById:function(e,i,s){var n;for(n=0;n<i.length;n++){var a=i[n];if(t.is(this._ids[e].elementRendering)||(this._ids[e].elementRendering={}),t.is(this._ids[e].elementRendering[a]))this._ids[e].elementRendering[a].addOver(s);else this._ids[e].elementRendering[a]=new r(s);this._ids[e].elementRendering[a].addOverIds(a)}},_addDatavizRendering:function(e,i,r,s,a){t.is(this._ids[e].datavizRenderings)||(this._ids[e].datavizRenderings={});var o=new n(i,r,s);t.is(a)||(a=this._findnewdatavizId(e)),t.is(this._internalDatavizIds)||(this._internalDatavizIds={}),t.is(this._internalDatavizIds[a])&&(a=this._findnewdatavizId(e+a)),this._internalDatavizIds[a]=e,this._ids[e].datavizRenderings[a]=o,this._ids[e].datavizRenderings[a].addOverIds(a)},_parseElementRender:function(e,i){if(t.is(i)){var r,s,n,a;if(t.is(i.ElementMaterial)&&(s=this._initMaterialFromProfile(i.ElementMaterial)),t.is(i.ElementIds))return r=this._parseElementIds(i.ElementIds),void this._addElementRenderingById(e,r,s);t.is(i.Filter)&&(a=this._initFilter(i.Filter)),t.is(i.DatavizMaterial)&&(n=this._initDatavizMaterial(i.DatavizMaterial)),t.is(a)||t.is(n)||console.error(" elementrendering not correctly  initialized"),this._addDatavizRendering(e,s,a,n)}},_parseDatavizRender:function(e,i,r){var s,n,a;t.is(i)&&(t.is(i.ElementMaterial)&&(s=this._initMaterialFromProfile(i.ElementMaterial)),t.is(i.Filter)&&(a=this._initFilter(i.Filter)),t.is(i.DatavizMaterial)&&(n=this._initDatavizMaterial(i.DatavizMaterial)),t.is(a)||t.is(n)||console.error(" elementrendering not correctly  initialized"),this._addDatavizRendering(e,s,a,n,r))},_initFilter:function(e){return e instanceof s?e:new s(e)},_initDatavizMaterial:function(e){return e},_hasId:function(e){return t.is(this._ids)&&t.is(this._ids[e])},_hasPrimId:function(e,i){return this._hasId(e)&&t.is(this._ids[e].elementRendering)&&t.is(this._ids[e].elementRendering[i])},_resetRendering:function(e,i){var r=!1;return this._hasId(e)&&(t.is(i)?this._hasPrimId(e,i)&&(r=!0,this._resetPrimitiveRendering(e,i)):r=this._resetLayerRendering(e)),r},_resetPrimitiveRendering:function(e,t){delete this._ids[e].elementRendering[t]},_resetLayerRendering:function(e){var i=this._ids[e].materialIndex,r=this._materials[i],s=!1;if(t.is(r)&&Object.keys(r).length>0){var n={},a=this._findnewmaterialId();n.id=a,this._materials[a]=n,this._ids[e].materialIndex=a,s=!0}return s},_resetLayerDatavizRendering:function(e){var i=!1;if(t.is(this._ids)&&t.is(this._ids[e])){var r=this._ids[e].datavizRenderings;t.is(r)&&(delete this._ids[e].datavizRenderings,i=!0)}return i},_resetAttribute:function(e,i,r){return t.is(r)?this._resetPrimitiveAttribute(e,r,i):this._resetLayerAttribute(e,i)},_resetDatavizAttribute:function(e,i){var r=this._ids[e].datavizRenderings;if(t.is(r))for(var s=Object.keys(r),n=0;n<s.length;n++){var a=s[n],o=r[a];if(t.is(o))o.remove(i)&&delete r[a]}},_resetLayerAttribute:function(e,i){var r=!1;if(this._hasId(e)){var s=this._ids[e].materialIndex,n=this._materials[s];if(t.is(n)&&void 0!==t.getComposedProperty(n,i)){var o={};a._setMaterialFromProfile(o,n);var l={};t.setComposedProperty(l,i,null),a._RemoveRendering(o,l);var h=this._findnewmaterialId();o.id=h,this._materials[h]=o,this._ids[e].materialIndex=h,r=!0}this._resetDatavizAttribute(e,i)}return r},_resetPrimitiveAttribute:function(e,i,s){var n=!1;if(this._hasPrimId(e,i)){var o=this._ids[e].elementRendering[i];if(o instanceof r){var l=o.get(s);t.is(l)&&(o.remove(s),n=!0)}else if(t.is(o[s])){n=!0;var h={};h[s]=null,a._RemoveRendering(o,h)}}return n},removeRendering:function(e,i,r){var s=!1;if(this._hasId(e))if(t.is(i)){if("string"==typeof i){var n=i;s=this._resetAttribute(e,n,r)}}else s=this._resetRendering(e,r),this._renderIds([e]);return s},_findnewdatavizId:function(e){t.is(this._internalDatavizIds)||(this._internalDatavizIds={});var i=0,r=i;for(t.is(e)&&(r=e);t.is(this._internalDatavizIds[r]);)i++,r=r.split(".")[0]+"."+i;return r},_getIdsFromJSON:function(e){return Array.isArray(e.Ids)||"string"!=typeof e.Ids?e.Ids.slice():[e.Ids]},_addMaterialToIds:function(e,i){if(t.is(e)&&!(e.length<=0)&&t.is(i)){var r,s,n,o,l=this._findnewmaterialId();for(i.id=l,n=0;n<e.length;n++)if(o=e[n],t.is(this._ids[o])){r=this._ids[o].materialIndex;var h={};if(t.is(r)){var d=this._materials[r];a._setMaterialFromProfile(h,d)}a._setMaterialFromProfile(h,i),s=this._findnewmaterialId(),h.id=s,this._addMaterialToId(h,o)}else this._addMaterialToId(i,o)}},_addMaterialToId:function(e,i){var r=e.id;t.is(this._materials)||(this._materials={}),t.is(this._materials[r])||(this._materials[r]=e),t.is(this._ids[i])||(this._ids[i]={}),this._ids[i].materialIndex=r},_addElementRenderingToProfile:function(e,i){if(t.is(e.ElementRendering)){var r=i;t.is(this._ids[r])||(this._ids[r]={}),t.is(this._ids[r].elementRendering)||(this._ids[r].elementRendering={});var s,n=Object.keys(e.ElementRendering),a=n.length;for(s=0;s<a;s++){var o=n[s],l=e.ElementRendering[o];this._parseElementRender(r,l)}}},_addDatavizRenderingToProfile:function(e,i){if(t.is(e.DatavizRendering)){var r=i;t.is(this._ids[r])||(this._ids[r]={}),t.is(this._ids[r].datavizRenderings)||(this._ids[r].datavizRenderings={});var s,n=Object.keys(e.DatavizRendering),a=n.length;for(s=0;s<a;s++){var o=n[s],l=e.DatavizRendering[o];this._parseDatavizRender(r,l,o)}}},_parseOneRenderingGroup:function(e,i){if(t.is(e.Ids)){var r,s,n,a,o=this._getIdsFromJSON(e);s=o.slice(),t.is(e.Material)&&(r=this._initMaterialFromProfile(e.Material)),(n=s.indexOf(this.SkyId))>=0&&(s.splice(n,1),this._parseSky(r)),(a=s.indexOf(this.GroundId))>=0&&(s.splice(a,1),this._parseGround(r)),s.length>0&&(t.is(this._ids)||(this._ids={}),this._addMaterialToIds(s,r),this._addElementRenderingToProfile(e,s[0]),this._addDatavizRenderingToProfile(e,s[0])),!0!==i&&this._renderIds(o)}},_renderIds:function(e){if(t.is(e)&&e.length>0)if(this.isRenderInitialized()){if(this._enabled){var i,r,s,n=this.getManager(),a={};for(i=0;i<e.length;i++)r=e[i],t.is(this._ids)&&(s=this._ids[r],t.is(s)&&(a[r]=!0));n.setRender(a)}}else this._initRender()},_parseGround:function(e){if(t.is(e)){var i=this._profileToGroundMaterial(e),r=this.getManager();if(t.is(this._materials)||(this._materials={}),t.is(this._ids)||(this._ids={}),t.is(this._materialID)||(this._materialID=1),this._addMaterialToIds([this.GroundId],i),t.is(i.oceanTextureUrl)){var s=this;this._loadTexture("oceanTexture",i.oceanTextureUrl,{toload:0,material:i},function(e){if(t.is(e)){var i={};e.anisotropy=4,i.oceanTexture=e,s.isEnabled()&&(s._addMaterialToIds([s.GroundId],i),r.setRender(s._ids,s._materials))}})}}},getFilters:function(e,i){var r;if(t.is(this._ids)){var s=this._ids[e];if(t.is(s)){var n=s.datavizRenderings;if(t.is(n)){var a,o,l,h,d=Object.keys(n),u=d.length;for(a=0;a<u;a++)l=n[o=d[a]],t.is(l)&&(h=l.getFilterRendering(),t.is(h)&&t.is(h.rendering)&&t.is(h.rendering[i])&&(t.is(r)||(r={}),r[o]=h))}}}return r},getMappings:function(e,i){var r;if(t.is(this._ids)){var s=this._ids[e];if(t.is(s)){var n=s.datavizRenderings;if(t.is(n)){var a,o,l,h,d=Object.keys(n),u=d.length;for(a=0;a<u;a++)l=n[o=d[a]],t.is(l)&&(h=l.getMappingRendering(),t.is(h)&&t.is(h[i])&&(t.is(r)||(r={}),r[o]=h))}}}return r},updateDatavizRendering:function(e,i,r,s){var n=this.getDatavizRenderingFromId(e);if(t.is(n)){var a=this._initMaterialFromProfile(r);n.dataviz.setAll(a,i,s);var o={};o[n.layerid]=!0,this.getManager().setRender(o)}},deleteDatavizRendering:function(e){var i=this.getDatavizRenderingFromId(e);if(t.is(i)){this._ids[i.layerid].datavizRenderings[e]=void 0;var r={};r[i.layerid]=!0,this.getManager().setRender(r)}},getDatavizRenderingFromId:function(e){var i=null;if(!t.is(this._ids))return i;var r,s,n,a=Object.keys(this._ids),o=a.length,l=!1;for(r=0;r<o;r++)if(s=a[r],n=this._ids[s].datavizRenderings,t.is(n)){var h,d,u=Object.keys(n),c=u.length;for(h=0;h<c;h++)if((d=u[h])==e){i={dataviz:n[d],layerid:s},l=!0;break}if(l)break}return i},addSLDRenderings:function(e,i){if(t.is(e)&&t.is(i)){var r={};r.Ids=[e];var s,n=Object.keys(i),a=n.length;for(s=0;s<a;s++){var o=n[s],l=i[o];t.is(l)&&(t.is(l.Material)?(r.Material=Object.assign({},r.Material,l.Material),t.is(l.ElementRendering)&&(r.ElementRendering=l.ElementRendering)):(t.is(r.DatavizRendering)||(r.DatavizRendering={}),r.DatavizRendering[o]=l))}this._parseOneRenderingGroup(r,!0),this.createAtlas(r,e)}},resetAllPrimitivesRendering:function(e,i){var r,s,n=e.length;if(t.is(i))for(r=0;r<n;r++)s=e[r],this.removePrimitivesAttribute(s,i);else for(r=0;r<n;r++)s=e[r],this.removePrimitivesRendering(s)},removePrimitivesRendering:function(e){t.is(this._ids[e])&&(this._ids[e].elementRendering=null)},removePrimitivesAttribute:function(e,i){if(t.is(this._ids[e])){var r=this._ids[e].elementRendering;if(t.is(r)){var s,n,a,o=Object.keys(r),l=o.length;for(s=0;s<l;s++)(a=r[n=o[s]]).remove(i),a.isEmpty()&&delete this._ids[e].elementRendering[n]}}},getRenderingForLayer:function(e){if(t.is(e)){var r,s,n=e.getRendering().getIds(),a=new i,o=n.length;for(r=0;r<o;r++)s=n[r],this.getRenderingForId(s,a);return a}},getMapsArrayFromRender:function(e){var i,r,s,n,a;if(t.is(e)){var o=[];if(t.is(e.Material)&&o.push(e.Material.mapUrl),t.is(e.DatavizMaterial))for(r=(i=Object.keys(e.DatavizMaterial.mapUrl)).length,s=0;s<r;s++)n=i[s],a=e.DatavizMaterial.mapUrl[n],o.push(a);if(t.is(e.ElementMaterial))for(r=(i=Object.keys(e.ElementMaterial.mapUrl)).length,s=0;s<r;s++)n=i[s],a=e.ElementMaterial.mapUrl[n],o.push(a);return o}return null},createAtlas:function(e,r){var s,n=new i;if(t.is(this._ids[r])){var a=this._ids[r].datavizRenderings;if(t.is(a)){var l,h,d=Object.keys(a),u=d.length;for(l=0;l<u;l++)h=a[d[l]],n.addOver(h)}var c=this._ids[r].materialIndex;if(t.is(c)){var p=this._materials[c];t.is(p)&&n.addOver(p)}var f=n.getAllValuesForAttribute("mapUrl");if(s=this.getMapsArrayFromRender(f),t.is(s)&&s.length>1){var m=this;o.makeAtlasFromUrls(s,function(e){var t={Ids:r,Material:{map:e}};m._parseOneRenderingGroup(t)})}else this._renderIds([r])}},clearRendering:function(e){this.emptyRendering(e),delete this._ids[e]},emptyRendering:function(e){this._resetLayerDatavizRendering(e),this.removeRendering(e)}})}),define("DS/XCityRendering/RenderingHandlerPrimitive",["DS/Visualization/ThreeJS_DS","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerDownload","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s,n){"use strict";return s.extend({init:function(e,t){this._parent(e,t)},getElementMaterialInfoFromLayer:function(e){var t,s={};return i._setMaterialFromProfile(s,this.defaultMaterial),i._setMaterialFromProfile(s,this.currentMaterial),r.is(this._elementRendering)&&r.is(this._elementRendering._ids[e])&&(t=this._elementRendering._ids[e],i._setMaterialFromProfile(s,this._elementRendering._materials[t])),s},initMesh:function(e){this._parent(e),r.is(e)&&this.applyElementRendering(e)},mustRedrawPrimitive:function(){return!this.mustRedrawDataviz()&&(this.currentRendering.hasPrimitiveRendering()||this.lastRendering.hasPrimitiveRendering())},getPrimitiveRenderingValuesOrOriginal:function(e){var t=this.getPrimitiveRenderingValues(e);return r.is(t)||(t=this._primitives[e].originalMaterial),t},applyElementRendering:function(e){var t,i,s,n;if(!this.applyElementRenderingAll(e)&&r.is(this._primitivesMeshes)&&this.mustRedrawPrimitive()&&(t=this._primitivesMeshes[e.id],r.is(t))){var a,o=!1,l=Object.keys(t),h=l.length;for(a=0;a<h;a++)s=l[a],r.is(s)&&(i=t[s],r.is(i)&&(n=this.getPrimitiveRenderingValuesOrOriginal(s),this.applyRenderingToPrimitive(e,n,i,s),r.is(n.opacity)&&n.opacity<1&&(o=!0)));this.handleMaterialTransparent(e,o)}},handleMaterialTransparent:function(e,i){var s=e.material;if(r.is(s)){var n=!1;if(i)n=!0;else n=this.getCompleteMaterialInfo().opacity<1,void 0!==s.opacityFactor&&s.opacityFactor<1&&s.useOpacityFactor&&(n=!0);s.transparent=n,t.updateCommonUniforms(s)}},applyRenderingToPrimitive:function(t,i,s,n){var a,o;if(r.is(t.setRendering)){if(r.is(i))for(var l=0;l<s.length;++l)t.setRendering(i,s[l],n)}else r.is(i.color)&&(r.is(t.setColor)?(a=t.setColor(i.color,s,n),r.is(this._primitives[n].originalMaterial.color)||(this._primitives[n].originalMaterial.color=new e.Color,this._primitives[n].originalMaterial.color.copy(a))):console.warn("this mesh does not have the setColor method")),r.is(i.opacity)&&(r.is(t.setOpacity)?(o=t.setOpacity(i.opacity,s,n),r.is(this._primitives[n].originalMaterial.opacity)||(this._primitives[n].originalMaterial.opacity=o)):console.warn("this mesh does not have the setOpacity method"))},_getStridFromPrim:function(e){return e.userData.strid||e.strid},addPrimitive:function(e){if(r.is(e)&&r.is(e.geom)&&r.is(e.userData)){var t=this._getStridFromPrim(e);r.is(t)&&r.is(this._primitives[t])&&(this._primitives[t].prim=[],this._primitives[t].prim=e.geom,this._renderprimitive(t))}},_getMainNodeWithMaterial:function(e,t){for(var i=this._primitives[e].prim[t].mesh,r=i;i.parents&&i.parents[0];)i.parents[0].material&&(r=i.parents[0]),i=i.parents[0];return r},_alreadyContains:function(e,t){for(var i=0;i<e.length;i++)if(e[i].getCgmId()===t.getCgmId()&&e[i].getStart()===t.getStart())return!0;return!1},_renderprimitive:function(e){var t,i;if(r.is(this._primitives)&&r.is(this._primitives[e])&&r.is(this._primitives[e].prim)){for(i=0;i<this._primitives[e].prim.length;i++)t=this._getMainNodeWithMaterial(e,i),r.is(t)&&(r.is(this._primitivesMeshes)||(this._primitivesMeshes={}),r.is(this._primitivesMeshes[t.id])||(this._primitivesMeshes[t.id]={}),r.is(this._primitivesMeshes[t.id][e])||(this._primitivesMeshes[t.id][e]=[]),this._alreadyContains(this._primitivesMeshes[t.id][e],this._primitives[e].prim[i].subElement)||this._primitivesMeshes[t.id][e].push(this._primitives[e].prim[i].subElement),this.applyElementRendering(t));n.publish("/xCity/needRender",this)}},registerPrimitive:function(e,t){if(r.is(t)&&r.is(e)&&(r.is(this._primitives)||(this._primitives={}),!r.is(this._primitives[t]))){this._primitives[t]={originalMaterial:{}};var i=this.addPrimitive.bind(this);e.register(t,i)}},removeMesh:function(e){var t,i,s,n,a,o,l;if(this._parent(e),r.is(this._primitivesMeshes)&&r.is(this._primitivesMeshes[e])&&(n=this._primitivesMeshes[e],this._primitivesMeshes[e]=null),r.is(this._primitives)&&r.is(n))for(o=(a=Object.keys(n)).length,l=0;l<o;l++)if(t=a[l],r.is(this._primitives[t])&&(i=this._primitives[t].prim,r.is(i))){var h=[];for(s=0;s<i.length;s++)i[s].mesh.id!==e&&h.push(i[s]);this._primitives[t].prim=h}}})}),define("DS/XCityGeometry/PointOfInterestManager",["UWA/Core","UWA/Class","UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityGeometry/PointOfInterest","DS/XCityTools/EventDispatcher","css!DS/XCityGeometry/assets/style/annotation.css"],function(e,t,i,r,s,n,a){"use strict";return t.extend(i,{init:function(e){this.urban=e,this.createParentDiv(),this.maxVisible=-1,this.cCollision=!0,this.cDistance=!0,this.groups={},this.currentGroup=null,this.pois=[],this.defaultStyle={HPos:"center",VPos:"top"},a.subscribeTo("/3DEXPERIENCity/onUpdate",this.update.bind(this)),this.urban.USR.viewpoint.addEvent("onCameraStopped",this.check.bind(this))},reset:function(){for(var e in this.maxVisible=-1,this.cCollision=!0,this.cDistance=!0,this.removeAll(),this.groups)this.removeGroup(e)},setup:function(e){void 0!==e&&(void 0!==e.maxVisible&&(this.maxVisible=e.maxVisible),void 0!==e.checkCollision&&(this.cCollision=e.checkCollision),void 0!==e.checkDistance&&(this.cDistance=e.checkDistance))},addGroup:function(e,t){if(void 0===this.groups[e]){var i={name:e,pois:new Array};this.groups[e]=i}return void 0!==t&&!0===t&&this.setCurrentGroup(e),this.groups[e]},setCurrentGroup:function(e){void 0!==this.groups[e]&&(this.currentGroup=this.groups[e])},createParentDiv:function(){this.parentDiv=e.createElement("div",{id:"POI-manager-div",class:"POImanager",styles:{position:"absolute",width:"100%",height:"100%",top:"0px",left:"0px","pointer-events":"none"}}),this.parentDiv.inject(this.urban.viewerContainer)},update:function(e,t){for(var i=Object.keys(this.groups),r=0,s=i.length;r<s;r++)for(var n=0,a=this.groups[i[r]].pois.length;n<a;n++)this.groups[i[r]].pois[n].updatePosition(this.urban.USR.viewpoint)},removeAll:function(){for(this.pois=[];this.parentDiv.hasChildNodes();)this.parentDiv.removeChild(this.parentDiv.lastChild)},removeGroup:function(e){var t=this.currentGroup;void 0!==e&&(t=this.groups[e]);for(var i=0;i<t.pois.length;i++)t.pois[i].remove();t.pois=[],this.groups[e]=void 0,delete this.groups[e],this.check(!1)},display:function(){for(var e=Object.keys(this.groups),t=0,i=e.length;t<i;t++)for(var r=0,s=this.groups[e[t]].pois.length;r<s;r++)this.groups[e[t]].pois[r].display()},check:function(e){for(var t=Object.keys(this.groups),i=0,r=t.length;i<r;i++){this.groups[t[i]].displayed=[];for(var s=0,n=this.groups[t[i]].pois.length;s<n;s++){var a=this.groups[t[i]].pois[s];a.getVisibility()&&this.checkDistance(a)&&(this.maxVisible>0?this.groups[t[i]].displayed.length<this.maxVisible?this.checkCollision(this.groups[t[i]].displayed,a):a.disappear():this.checkCollision(this.groups[t[i]].displayed,a))}}},checkDistance:function(e){if(!this.cDistance)return!0;var t=this.urban.getViewpoint().getPosition(),i=new r.Vector2(t.x,t.y),s=new r.Vector2(e.worldPos.x,e.worldPos.y),n=(new r.Vector2).subVectors(i,s),a=.5+.5*(1-this.urban.getViewpoint().getRotationAngle().y/(.5*Math.PI));return n.length()<10*a*t.z||(e.disappear(),!1)},registerPOI:function(e,t){void 0===t&&void 0!==this.currentGroup?this.currentGroup.pois.push(e):t.pois.push(e)},unregisterPOI:function(e,t){var i;void 0===t&&void 0!==this.currentGroup?(i=this.currentGroup.pois.indexOf(e))>-1&&this.currentGroup.pois.splice(i,1):(i=t.pois.indexOf(e))>-1&&t.pois.splice(i,1)},mouseDown:function(e,t){this.dispatchEvent("onMouseDown",[e,t])},mouseDblClick:function(e,t){this.dispatchEvent("onMouseDblClick",[e,t])},intersect2DBox:function(e,t){return!(t.textDiv.cleft>e.textDiv.cright||t.textDiv.cright<e.textDiv.cleft||t.textDiv.ctop>e.textDiv.cbottom||t.textDiv.cbottom<e.textDiv.ctop)},checkCollision:function(e,t){if(!this.cCollision)return t.appear(),void e.push(t);if(0===e.length)t.appear(),e.push(t);else{for(var i=!1,r=0;r<e.length;r++)if(this.intersect2DBox(e[r],t)&&e[r]!==t){i=!0,t.disappear();break}!1===i&&(t.appear(),e.push(t))}}})}),define("DS/XCityGeometry/LabelManager",["UWA/Core","UWA/Class","UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityGeometry/PointOfInterestManager","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s,n,a,o){"use strict";class l{constructor(e){if("function"!=typeof e.pointInterfaceGetX)throw new TypeError("Provided point object does not fulfill the contract: no pointInterfaceGetX method.");if("function"!=typeof e.pointInterfaceGetY)throw new TypeError("Provided point object does not fulfill the contract: no pointInterfaceGetY method.");this.pointInterfaceGetX=e.pointInterfaceGetX,this.pointInterfaceGetY=e.pointInterfaceGetY}get x(){let e=this.pointInterfaceGetX();if("number"!=typeof e)throw new TypeError("x value for point is NaN when calling the pointInterfaceGetX method.");return e}get y(){let e=this.pointInterfaceGetY();if("number"!=typeof e)throw new TypeError("y value for point is NaN when calling the pointInterfaceGetY method.");return e}}class h{constructor(e,t,i,r){this.x=e,this.y=t,this.width=i,this.height=r}contains(e){return!(e.x<this.x||e.x>this.x+this.width||e.y<this.y||e.y>this.y+this.height)}overlaps(e){return e.x+e.width>this.x&&this.x+this.width>e.x&&e.y+e.height>this.y&&this.y+this.height>e.y}}class d{constructor(e,t,i,r,s=!1){this.nodeCapacityDefault=32,this.maxDepthDefault=32,this.box=e,this.nodeCapacity=t||this.nodeCapacityDefault,this.maxDepth=i||this.maxDepthDefault,this.northWest=null,this.northEast=null,this.southWest=null,this.southEast=null,this.points=new Array,this.level=r||0,this.sortPointsByPriority=s}removePoint(e,t){if(null===this.northWest){let t=this.points.find(t=>t.poi===e);return t?this.points.splice(this.points.indexOf(t),1):null}return this.northWest.box.contains(t)?this.northWest.removePoint(e,t):this.northEast.box.contains(t)?this.northEast.removePoint(e,t):this.southWest.box.contains(t)?this.southWest.removePoint(e,t):this.southEast.box.contains(t)?this.southEast.removePoint(e,t):null}replacePoint(e,t,i){if(null===this.northWest){let i=this.points.find(t=>t.poi===e);return i?i.poi=t:null}return this.northWest.box.contains(i)?this.northWest.replacePoint(e,t,i):this.northEast.box.contains(i)?this.northEast.replacePoint(e,t,i):this.southWest.box.contains(i)?this.southWest.replacePoint(e,t,i):this.southEast.box.contains(i)?this.southEast.replacePoint(e,t,i):null}insertPoint(e){let t=function(e,i,r,s){if(r>s)return r;let n=Math.floor((r+s)/2);return e[n].priority===i.priority?n:e[n].priority>i.priority?t(e,i,r,n-1):t(e,i,n+1,s)};if(!this.box.contains(e))return!1;if(this.points.length<this.nodeCapacity&&null===this.northWest){if(!this.sortPointsByPriority||0===this.points.length)return this.points.push(e),!0;let i=t(this.points,e,0,this.points.length-1);return this.points.splice(i,0,e),!0}return null===this.northWest&&this.subdivide(),!!(this.northWest.insertPoint(e)||this.northEast.insertPoint(e)||this.southWest.insertPoint(e)||this.southEast.insertPoint(e))}insertPoints(e){for(let t in e)this.insertPoint(e[t])}subdivide(){let e=this.box.width/2,t=this.box.height/2,i=new h(this.box.x,this.box.y,e,t),r=new h(this.box.x+e,this.box.y,e,t),s=new h(this.box.x,this.box.y+t,e,t),n=new h(this.box.x+e,this.box.y+t,e,t);this.northWest=new d(i,this.nodeCapacity,this.maxDepth,this.level+1,this.sortPointsByPriority),this.northEast=new d(r,this.nodeCapacity,this.maxDepth,this.level+1,this.sortPointsByPriority),this.southWest=new d(s,this.nodeCapacity,this.maxDepth,this.level+1,this.sortPointsByPriority),this.southEast=new d(n,this.nodeCapacity,this.maxDepth,this.level+1,this.sortPointsByPriority),this.insertPoints(this.points),this.points=new Array}printDebug(e,t){if(e=e||d.maxDepthDefault,this.level>e)return;let i="";for(let e=0;e<this.level;e++)e+1===this.level?i+="|---":i+="|   ";if(i+="level["+this.level+"]",this.points.length>0){i+=" ["+this.points.length+" node(s)]\n";for(let e=0;e<this.level&&(e+1!==this.level||!t);e++)i+="|   ";i+="\n"}else{i+="\n";for(let e=0;e<=this.level;e++)i+="|   ";i+="\n"}return null!==this.northWest&&(i+=this.northWest.printDebug(e,!1),i+=this.northEast.printDebug(e,!1),i+=this.southWest.printDebug(e,!1),i+=this.southEast.printDebug(e,!0)),i}getLeaves(e){return e=e||[],null===this.northWest?(e.push(this.points),e):(e=this.northWest.getLeaves(e),e=this.northEast.getLeaves(e),e=this.southWest.getLeaves(e),e=this.southEast.getLeaves(e))}getValuesFromBBox(e,t){return t=t||[],this.box.overlaps(e)?null===this.northWest?(t.push(this.points),t):(t=this.northWest.getLeaves(t),t=this.northEast.getLeaves(t),t=this.southWest.getLeaves(t),t=this.southEast.getLeaves(t)):t}getValuesFromFrustum(e,t,i){if(t=t||[],!function(e,t){for(let i=0;i<6;i++){const s=t[i];let n=new r.Vector3;if(n.x=s.normal.x>0?e.max.x:e.min.x,n.y=s.normal.y>0?e.max.y:e.min.y,n.z=s.normal.z>0?e.max.z:e.min.z,s.distanceToPoint(n)<0)return!1}return!0}({max:{x:this.box.x+this.box.width,y:this.box.y+this.box.height,z:1e4},min:{x:this.box.x,y:this.box.y,z:-1e4}},e.planes))return t;if(null===this.northWest){let r=new Array;for(let t=0;t<this.points.length;t++)e.containsPoint(this.points[t].poi.pos3D)&&this.points[t].poi.group.visible&&!this.points[t].poi.isHidden&&r.push(this.points[t]);return r.length>0&&(i?t.splice(Math.floor(314159*r.length%t.length),0,r):t.push(r)),t}return t=this.northWest.getValuesFromFrustum(e,t,i),t=this.northEast.getValuesFromFrustum(e,t,i),t=this.southWest.getValuesFromFrustum(e,t,i),t=this.southEast.getValuesFromFrustum(e,t,i)}}return n.extend({init:function(e){this.urban=e,this.groups=[],a.subscribeTo("/3DEXPERIENCity/onUpdate",this.handleOpacity.bind(this)),a.subscribeTo("/3DEXPERIENCity/onUpdate",this.check.bind(this)),this.fadingTime=.7,this.fadeOutFactor=3,this.startFadeIn=!0,this._debugBbox=!1,this._debugBboxWidth=2,this._labelsToFadeIn=new Map,this._labelsToFadeOut=new Map,this._visibleLabels=new Map,this._lastFrameVisibleLabels=new Map,this._quadTree=null,a.subscribeTo("/3DEXPERIENCity/onReset",this._resetQuadtree.bind(this))},_resetQuadtree:function(){this._quadTree=null},enableDebugBbox:function(e,t=1){this._debugBbox=e,e||this.clearCanvasBbox(),this._debugBboxWidth=t},addGroup:function(e,t){if(void 0===this.groups[e]){var i=this._parent(e,t);i.layer=xCity.findItem({id:e}),i.visible=!0,this.sortGroups()}return this.groups[e]},onChangeVisibility:function(e,t){var i=e.id,r=this.urban.labelManager;o.is(r.groups[i])&&(r.groups[i].visible=t,r._needCheck=!0)},onChangeVisibilityPrimitive:function(e,t){var i=e.getContent()._getStrid(),r=e.getContent()._layer.parentFeatureID,s=this.groups[r];if(o.is(s)){var n=s.pois.find(e=>e.name==="textNode_"+i);o.is(n)&&(n.setVisibilityOrCreate(t),n.isHidden=!t,this._needCheck=!0)}},sortGroups:function(){this.groups=Object.fromEntries(Object.entries(this.groups).sort(([,e],[,t])=>e.layer.get("levelMin")-t.layer.get("levelMin")))},_generateLabelPriority:function(e){if(!e)return-1e5;if(e.streamPriority&&!isNaN(e.streamPriority))return e.streamPriority;let t=0;e.priority&&(t=(Math.min(500,e.priority)-1)/499);let i=-50;return(e.levelMin||0===e.levelMin)&&(i=-e.levelMin),100*i+10*t},registerPOI:function(e,t,i,r,s,n,a,u){var c=t.pois.find(e=>e.name==="textNode_"+n);if(o.is(c)&&c.observers){for(var p=c.observers.length,f=0;f<p;f++)c.observers[f](c);c.observers=null}if(!this._quadTree){let e,t=xCity._urbanImpl;if(!o.is(t.worldSize))return void console.error("No worldSize information for referential: can't compute label positions");{let i=t.shiftedPosition&&t.shiftedPosition.x?t.shiftedPosition.x:0,r=t.shiftedPosition&&t.shiftedPosition.y?t.shiftedPosition.y:0;e={xmin:i,xmax:i+t.worldSize,ymin:r,ymax:r+t.worldSize}}let i=new h(e.xmin,e.ymin,e.xmax-e.xmin,e.ymax-e.ymin),r=32,s=32,n=!0,a=0;this._quadTree=new d(i,r,s,a,n)}let m={x:s.x,y:s.y},g={pointInterfaceGetX:function(){return m.x},pointInterfaceGetY:function(){return m.y}};g=new l(g);let v=this._generateLabelPriority(u);e.labelPriority=v,g.priority=v,g.poi=e,g.poi.group=t,this._quadTree.insertPoint(g),this._parent(e,t),e.layer=xCity.findItem({id:t.name}),e.mode=i,e.pos3D=s.clone(),e.pos3D.z=r,e.switchDistance=a,this._needCheck=!0,e.setVisibilityOrCreate(!1),e.material.updatePDSFXUniform("opacityCity",0),setTimeout(t=>{t._visibleLabels.get(e.group.name+"_"+e.name,e)||(e.setVisibilityOrCreate(!1),e.material.updatePDSFXUniform("opacityCity",0))},0,this)},deleteGroup:function(e){delete this.groups[e],this.currentGroup&&this.currentGroup.name===e&&delete this.currentGroup},unregisterGroup:function(e){let t=this.groups[e]?this.groups[e].pois:void 0;if(!o.is(t))return;let i=t.length;for(let e=0;e<i;e++)this.unregisterPOI(t[0])},unregisterPOI:function(e){let t=this.getPoiFullName(e);this._visibleLabels.delete(t),this._labelsToFadeIn.delete(t),this._labelsToFadeOut.delete(t),this._lastFrameVisibleLabels.delete(t);var i=e.layer.get("id"),r=this.urban.labelManager.groups[i],s=r.pois.findIndex(t=>t===e);if(r.pois.splice(s,1),this._quadTree){let t=new h(e.pos3D.x,e.pos3D.y,0,0);this._quadTree.removePoint(e,t)}this._needCheck=!0,0==r.pois.length&&this.deleteGroup(i)},getPoiFullName:function(e){return e.group.name+"_"+e.name},replacePoi:function(e,t){this._needCheck=!0,t.name=e.name;let i=this.getPoiFullName(e);var r=function(e){this.unregisterPOI(e)}.bind(this);o.is(t.observers)||(t.observers=[]),t.observers.push(r.bind(t)),t.mode=e.mode,t.switchDistance=e.switchDistance,t.group=e.group,t.layer=e.layer,t.pos3D=e.pos3D,t.fade=e.fade,t.labelPriority=e.labelPriority;let s=new h(t.pos3D.x,t.pos3D.y,0,0);this._quadTree.replacePoint(e,t,s);let n=e.group.pois.findIndex(t=>t===e);n>=0&&(e.group.pois[n]=t),this._visibleLabels.has(i)&&this._visibleLabels.set(i,t),this._lastFrameVisibleLabels.has(i)&&this._lastFrameVisibleLabels.set(i,t),this._labelsToFadeOut.has(i)&&this._labelsToFadeOut.set(i,t),this._labelsToFadeIn.has(i)&&this._labelsToFadeIn.set(i,t),t.setVisibilityOrCreate=function(e){this.visible!=e&&this.setVisibility(e)}.bind(t)},handleOpacity:function(e){this._lastFrameVisibleLabels.forEach((e,t)=>{this._visibleLabels.has(t)||this._labelsToFadeOut.has(t)||(this._labelsToFadeOut.set(t,e),e.fade=-this.fadeOutFactor,this._labelsToFadeIn.has(t)&&this._labelsToFadeIn.delete(t))}),this._visibleLabels.forEach((e,t)=>{this._labelsToFadeOut.has(t)&&this._labelsToFadeOut.delete(t),e.setVisibilityOrCreate(!0),this._lastFrameVisibleLabels.has(t)||this._labelsToFadeIn.has(t)||(this.startFadeIn?e.material.updatePDSFXUniform("opacityCity",0):e.material.updatePDSFXUniform("opacityCity",1),this._labelsToFadeIn.set(t,e),e.fade=1)}),(this._labelsToFadeIn.size||this._labelsToFadeOut.size)&&(this.urban.USR._needRender=!0),this._labelsToFadeIn.forEach((t,i)=>{if(o.is(t.material.isLoaded)){let r=t.material.getPDSFXUniform("opacityCity").value;(r+=t.fade*e.clockDelta/this.fadingTime)>=1&&(r=1,this._labelsToFadeIn.delete(i)),t.material.updatePDSFXUniform("opacityCity",r)}}),this._labelsToFadeOut.forEach((t,i)=>{let r=t.material.getPDSFXUniform("opacityCity").value;(r+=t.fade*e.clockDelta/this.fadingTime)<=0&&(r=0,t.setVisibilityOrCreate(!1),this._labelsToFadeOut.delete(i)),t.material.updatePDSFXUniform("opacityCity",r)}),this._lastFrameVisibleLabels=new Map(this._visibleLabels)},concatGroups:function(){for(var e=[],t=Object.keys(this.groups),i=0,r=t.length;i<r;i++){var s=this.groups[t[i]];s.visible&&(e=e.concat(s.pois))}return e},check:function(e){if(this._needCheck||this._needCheckLater||e.camMoved)if(!this._needCheck&&this.lastCollisionUpdate&&Date.now()-this.lastCollisionUpdate<500)this._needCheckLater=!0;else if(this._needCheck=!1,this._needCheckLater=!1,this.lastCollisionUpdate=Date.now(),this._debugBbox&&this.clearCanvasBbox(),this._quadTree){this._visibleLabels.clear();let e,i,s=[],n=this.urban.getViewpoint(),a=n.frustum.clone(),o=new r.Vector3(this.urban.shiftedPosition.x,this.urban.shiftedPosition.y,this.urban.shiftedPosition.z),l=new r.Vector3(n._camShiftedTranslation.x+o.x,n._camShiftedTranslation.y+o.y,n._camShiftedTranslation.z+o.z);a.set(a.planes[0].clone().translate(l),a.planes[1].clone().translate(l),a.planes[2].clone().translate(l),a.planes[3].clone().translate(l),a.planes[4].clone().translate(l),a.planes[5].clone().translate(l));let h=this._quadTree.getValuesFromFrustum(a,new Array,!0),d=[],u=function(){let e=-1/0,t=-1;for(let i=0;i<h.length;i++)d[i]||(d[i]=0),h[i].length>d[i]&&h[i][h[i].length-1-d[i]].poi.labelPriority>e&&(e=h[i][h[i].length-1-d[i]].poi.labelPriority,t=i);if(-1!==t){let e=d[t];return d[t]++,h[t][h[t].length-1-e].poi}return null};const c=5;let p=Date.now();for(;s.length<80&&Date.now()-p<c;){let r=!0;if(!(i=u()))break;e=this.computePlacedBbox(i);for(var t=0;t<s.length;t++)if(this.collision(s[t],e)){r=!1;break}r&&(s.push(e),this._visibleLabels.set(i.group.name+"_"+i.name,i))}}},collision:function(e,t){return e.min.x-6<t.max.x&&e.max.x+6>t.min.x&&e.min.y-8<t.max.y&&e.max.y+8>t.min.y},_getFirstLeaf:function(e){let t;return null===e.northWest?e.points:(t=this._getFirstLeaf(e.northWest))?t:(t=this._getFirstLeaf(e.northEast))?t:(t=this._getFirstLeaf(e.southWest))||this._getFirstLeaf(e.southEast)},placeBbox:function(e,t,i){var r=t.clone();return r.translate(e),r},computePlacedBbox:function(e){var t;e.layer;if("billboard"!==e.mode)throw"Label mode "+e.mode+" is not implemented.";var i=this.pos3DToScreenPos(e.pos3D).clone().clone();i.x+=e.material.getPDSFXUniform("left").value,i.y-=e.material.getPDSFXUniform("top").value;var s=e.switchDistance;if(o.is(s)){let t;if(e.getMatrixWorld)t=e.getMatrixWorld();else{let i=(new r.Vector3).getPositionFromMatrix(e.layer.get("_node").getMatrixWorld()).add(e.pos3D);t=(new r.Matrix4).setPosition(i)}var n=(new r.Matrix4).multiplyMatrices(this.urban.USR.viewpoint.camera.matrixWorldInverse,t),a=-(new r.Vector3).getPositionFromMatrix(n).z;if(0!=s&&a<s){var l=s/a-1;i.y-=(e.material.getPDSFXUniform("geometryOffset").value.y+.5)*e.material.getPDSFXUniform("geometrySize").value.y*l,i.x+=e.material.getPDSFXUniform("geometryOffset").value.x*e.material.getPDSFXUniform("geometrySize").value.x*l}}if(i.y-=e.bBox.max.y-e.bBox.min.y,t=this.placeBbox(i,e.bBox),this._debugBbox){if(!o.is(this.canvasBbox)){var h=document.createElement("CANVAS");this.canvasBbox=h,h.width=xCity._urbanImpl.USR.webGLV6Viewer.SCREEN_WIDTH,h.height=xCity._urbanImpl.USR.webGLV6Viewer.SCREEN_HEIGHT,h.style.position="absolute",this.urban.viewerContainer.appendChild(h),h.style.top=0,h.style.left=0}var d=this.canvasBbox.getContext("2d");let i="grey",r=.2;e.visible&&(i="orange"),e.visible&&e.material.getPDSFXUniform("opacityCity").value>.9&&(i="green"),!e.visible&&e.material.getPDSFXUniform("opacityCity").value<.1&&(i="red"),e.material.isLoading&&(r=1.6),e.material.isLoaded&&(r=4),e.material.map||(i="black"),d.strokeStyle=i,d.lineWidth=this._debugBboxWidth+r,d.strokeRect(t.min.x,t.min.y,t.max.x-t.min.x,t.max.y-t.min.y)}return t},pos3DToScreenPos:function(e){return this.urban.USR.viewpoint.getScreenPosition(e)},isBBoxInScreen:function(e){return e.min.x>0&&e.max.x<this.urban.viewerContainer.clientWidth&&e.min.y>0&&e.max.y<this.urban.viewerContainer.clientHeight},clearCanvasBbox:function(){o.is(this.canvasBbox)&&this.canvasBbox.getContext("2d").clearRect(0,0,this.canvasBbox.width,this.canvasBbox.height)}})}),define("DS/XCityRendering/RenderingHandlerDataviz",["DS/XCityTools/RenderingTools","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerPrimitive"],function(e,t,i){"use strict";return i.extend({init:function(e,t){this._parent(e,t)},mustRedrawDataviz:function(){return this.currentRendering.hasDatavizRendering()||this.lastRendering.hasDatavizRendering()},applyElementRenderingAll:function(e){var t=!1;return e.setRendering&&this.mustRedrawDataviz()?t=this.applyPrimitiveDataVizRendering(e):t},getAllPrimitiveRenderings:function(e,t,i){for(var r,s=[],n=0;n<t.records.length;n++)(r=t.records[n]).strid,s.push(r.userData);return this.getMappings(s)},applyAllPrimitiveDataVizRendering:function(e){var i,r=!1,s=t.getDataSource(e);if(t.is(s)){var n=!1,a=this.getAllPrimitiveRenderings(e,s,n);t.is(a)&&a.length>0&&(this.setRenderingList(a,s.records,null,e),r=!0,i=a[0],t.is(i.opacity)&&i.opacity<1&&(n=!0),n&&this.handleMaterialTransparent(e,!0))}return r},hasOnlyMappingDataviz:function(){var e=!0;return this.currentRendering.hasDatavizRendering()?this.currentRendering.hasPrimitiveRendering()?e=!1:this.currentRendering.hasFilterDataviz()&&(e=!1):e=!1,e},applyPrimitiveDatavizRenderingFromRecord:function(e,i){if(t.is(i)&&t.is(i.strid)&&t.is(i.userData)){var r=this.getPrimitiveRenderingValues(i.strid,i.userData);if(t.is(r))if(Object.keys(r).length>0&&t.is(i.geom))for(var s=i.geom.length,n=0;n<s;n++){var a=i.geom[n].subElement;e.setRendering(r,a,i.strid)}}},useDatavizMappingOptim(e){return t.is(this.setRenderingList)&&this.hasOnlyMappingDataviz()&&!this.currentRendering.hasDatavizOnAttribute("label")},applyPrimitiveDataVizRendering:function(e){var i,r,s,n,a,o=!1,l=t.getDataSource(e);if(t.is(l)){if(this.useDatavizMappingOptim(e))return this.applyAllPrimitiveDataVizRendering(e);for(var h=!1,d=0;d<l.records.length;d++)if(s=(n=l.records[d]).strid,a=n.userData,r=null,t.is(n.geom)&&t.is(n.geom.length>0)){i=this.getPrimitiveRenderingValues(s,a),t.is(i.opacity)&&i.opacity<1&&(h=!0);for(var u=n.geom.length,c=0;c<u;c++)r=n.geom[c].subElement,e.setRendering(i,r,s),o=!0}else{var p=function(t){this.applyPrimitiveDatavizRenderingFromRecord(e,t)}.bind(this);t.is(n.listeners)||(n.listeners=[]),n.listeners.push(p)}h&&this.handleMaterialTransparent(e,!0)}return o},interpretRendering:function(t,i){return e._interpretRendering(t,null,i)}})}),define("DS/XCityGeometry/PointOfInterest3DSetLabel",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityGeometry/PointOfInterest3DSet","DS/xCityBasicUtils/Utils","DS/Mesh/MeshUtils","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityTools/ShaderTools","DS/XCityTools/TextureTools","DS/Plugins/RenderPass","DS/Mesh/Mesh","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader","DS/XCityTools/Pooler","DS/XCityTools/RenderingTools","DS/XCityTools/TextureManager","DS/WebappsUtils/WebappsUtils"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m,g){"use strict";var v=i.extend({init:function(e,t,i){t.linePoints&&(this._linePoints=t.linePoints),this._parent(e,t,i)},_defineRenderPass:function(){this._poiPostPassID="noz",this._poiPrePassID="noz"},_setMaterial:function(){var t=this._rendering;if("icon"===this.renderType){if("billboard"===this.shapeType){var r=Object.assign({},v.alignedLabel);r.uniforms.points.length=this._linePoints.length,r.VS_global_code+=["// Compute offset to rescale the POI in screen space (fixed size)","vec4 getPositionFromDistance(float linearDistance) {","   int overIndex = -1;","   vec4 interpolatedPoint = vec4(-1.0);","   for(int i = 0;i < "+r.uniforms.points.length+" ;i++){","     vec4 point = points[i];","     if(overIndex < 0){","       if(point.w >= linearDistance){","         overIndex = i;","       }}","   }","   if (overIndex > 0 )","   {","      vec4 beforePoint = points[overIndex-1];","      vec4 afterPoint = points[overIndex];","      float factor = (linearDistance - beforePoint.w) / (afterPoint.w - beforePoint.w);","      interpolatedPoint = mix(beforePoint,afterPoint,factor);","   }","   if(linearDistance == 0.0){","     interpolatedPoint = points[0];","   }","   return interpolatedPoint;","}","float getPixelDistanceFromLineDistance(float linearDistance) {","   int overIndex = -1;","   float perspectiveFactor = -1.0;","   float pixelDistance = -1.0;","   float linePixelDistance = 0.0;","   float segmentPixelDistance = 0.0;","   vec4 interpolatedPoint = vec4(-1.0);","   vec4 projectedPoint = vec4(-1.0);","   vec4 lastProjectedPoint = projectLinePoint(points[0], perspectiveFactor);","   for(int i = 1; i < "+r.uniforms.points.length+" ;i++){","     vec4 point = points[i];","     if(overIndex < 0){","       projectedPoint = projectLinePoint(point, perspectiveFactor);","       vec2 segmentVector = projectedPoint.xy - lastProjectedPoint.xy;","       vec2 segmentVectorInPixel = segmentVector*halfScreenResolution;","       segmentPixelDistance = length(segmentVectorInPixel);","       linePixelDistance += segmentPixelDistance;","       if(point.w >= linearDistance){","         overIndex = i;","       }else {","         lastProjectedPoint = projectedPoint;","       }","     }","   }","   if (overIndex > 0 )","   {","      vec4 beforePoint = points[overIndex-1];","      vec4 afterPoint = points[overIndex];","      float factor = (linearDistance - beforePoint.w) / (afterPoint.w - beforePoint.w);","     float beforePixelDistance = linePixelDistance - segmentPixelDistance;","     pixelDistance = mix(beforePixelDistance,linePixelDistance,factor);","   }","   return pixelDistance;","}","vec4 getPositionFromPixelDistance(float pixelDistance, float perspectiveFactor,float linearDistance) {","   int overIndex = -1;","   float linePixelDistance = 0.0;","   float segmentPixelDistance = 0.0;","   vec4 interpolatedPoint = vec4(-1.0);","   vec4 projectedPoint = vec4(-1.0);","   vec4 lastProjectedPoint = projectLinePoint(points[0], perspectiveFactor);","   float lastFactor = perspectiveFactor;","   for(int i = 1; i < "+r.uniforms.points.length+" ;i++){","     vec4 point = points[i];","     if(overIndex < 0){","       projectedPoint = projectLinePoint(point, perspectiveFactor);","       vec2 segmentVector = projectedPoint.xy - lastProjectedPoint.xy;","       vec2 segmentVectorInPixel = segmentVector*halfScreenResolution;","       segmentPixelDistance = length(segmentVectorInPixel);","       linePixelDistance += segmentPixelDistance;","       if(linePixelDistance >= pixelDistance){","         overIndex = i;","       }else {","         lastProjectedPoint = projectedPoint;","         lastFactor = perspectiveFactor;","       }","     }","   }","   if (overIndex > 0 )","   {","     float beforeDistance = linePixelDistance - segmentPixelDistance;","     float factor = (pixelDistance - beforeDistance) / (linePixelDistance - beforeDistance);","     interpolatedPoint = mix(lastProjectedPoint,projectedPoint,factor);","     perspectiveFactor = mix(lastFactor,perspectiveFactor,factor);","     vec4 beforePoint = points[overIndex-1];","     vec4 afterPoint = points[overIndex];","     linearDistance = mix(beforePoint.w,afterPoint.w,factor);","   }","   if(pixelDistance == 0.0){","     interpolatedPoint = projectLinePoint(points[0],perspectiveFactor);","   }","   return interpolatedPoint;","}","float getLineMaximummDistance() {","   return points["+r.uniforms.points.length+" -1].w;","}","vec4 getScreenSpacePositionFromLineDistance(float linearDistance, float perspectiveFactor) {","   vec4 posCameraSpace = getPositionFromDistance(linearDistance);","   if(posCameraSpace.w < 0.0 ){","     discardVertex = true;","   }","   posCameraSpace = vGetWorldViewMatrix() * vec4(posCameraSpace.xyz, 1.0);","   posCameraSpace /= posCameraSpace.w;","   vec4 posScreenSpace = vGetProjectionMatrix() * posCameraSpace;","   perspectiveFactor = posScreenSpace.w;","   posScreenSpace /= posScreenSpace.w;","   return posScreenSpace;","}"].join("\n"),this.matPostPass=o.getPDSFXMaterial([i.coloring_PDSFX,i.mapping_PDSFX,i.atlasing_PDSFX,r],"basic"),t.addAtlasUniforms(this.matPostPass),this.matPostPass.setPDSFXPolygonOffset("Frontward1"),this.matPostPass.updatePDSFXUniform("halfScreenResolution",this.halfScreenResolution),this.matPostPass.updatePDSFXUniform("points",this._linePoints),this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,this.matPostPass))}else this.matPostPass=o.getPDSFXMaterial([i.poiOnePass3d_instancing_PDSFX],"physical");this.matPostPass.name=this.shapeType+"material",this.matPostPass.updatePDSFXUniform("switchDistance",this.switchDistance),this.matPostPass.updatePDSFXUniform("scaleCulling",this.scaleCulling),this.matPostPass.alphaTest=.1,this.matPostPass.side=e.FrontSide,this.matPostPass.transparent=!0,this.matPostPass.depthTest=!0,this.matPostPass.depthWrite=!0,1,"dual"===this.renderMode&&("billboard"===this.shapeType&&this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,this.matPrePass)),this.opacityFactor),o.updateCommonUniforms(this.matPostPass),void 0!==this.urlTexture&&this.urlTexture}},_pushPrimitiveBillboard:function(t,i,s,n,a,o,l,h,d){if(!1===this.instancingReady){t.pushVertex([0,-1,0]),t.pushVertex([1,-1,0]),t.pushVertex([1,0,0]),t.pushVertex([0,0,0]),t.pushNormal([0,0,0]),t.pushNormal([0,0,0]),t.pushNormal([0,0,0]),t.pushNormal([0,0,0]);t.pushTexCoord(0,[0,0]),t.pushTexCoord(0,[1,0]),t.pushTexCoord(0,[1,1]),t.pushTexCoord(0,[0,1]),t.pushVertexIndices([a+0,a+1,a+2]),t.pushVertexIndices([a+0,a+2,a+3])}var u=new e.Vector3(s[0]/this.scaleCulling,s[1]/this.scaleCulling,s[2]),c=new e.Vector3(o,l,h),p=new e.Matrix4;p.identity(),p.translate(c),p.scale(u);var f=0,m=0,g=0;r.is(d.indexTexture)&&(f=d.indexTexture,m=d.top,g=d.left);var v=[d.anchorMaximumRadius,f,g,m],_=[d.startRatio,d.endRatio,d.labelPixelLength,d.anchorLineLength];this._pushInstancesData(p,n,d.flags,void 0,v,_)},addPointOfInterest:function(e,t,i){var s,a=t.strid,o=t.attributes,l=this._rendering.getFlagForPrimitive(a,o);void 0!==this.styleClass&&""!==this.styleClass||(this.styleClass=t.styleClass),"billboard"===this.shapeType&&("icon"!==this.renderType||this.cssProcessed||(this.cssProcessed=!0,this.initBillboardCSSMap(),r.is(t.mapUrl)&&this.initBillboardMap(t),this.loadBillboardMap()));var h={x:t.localScale[0]*this.widthTexture,y:t.localScale[1]*this.heightTexture,z:t.localScale[2]},d={x:e.x,y:e.y,z:t.height,w:t.altitude},u=t.material;this._computeMinMax(this.minMaxOrig,d,h);var c=[t.localScale[0]*this.scaleCulling,t.localScale[1]*this.scaleCulling,t.localScale[2]*this.scaleCulling];s=[u.color.r,u.color.g,u.color.b,u.opacity],void 0===this.creator&&(this.creator=new n({indexed:!0,normalBinding:n.Binding.VERTEX,useTexCoord:!0,nbTexCoord:1,texCoordBinding:n.Binding.VERTEX,useColor:!1}));var p={flags:l,color:s};"billboard"===this.shapeType&&(this._rendering.setTextureInfo(p,a,o,i)&&(r.is(this._indexUpdates)||(this._indexUpdates={}),r.is(this._indexUpdates[a])||(this._indexUpdates[a]={attributes:o,glyphes:{}}),this._indexUpdates[a].glyphes[this.nbPoi]=i),p.anchorLineLength=t.lineLength,p.anchorMaximumRadius=t.anchorMaximumRadius,p.labelPixelLength=t.labelLength,p.startRatio=i.startRatio,p.endRatio=i.endRatio);return this._addPoi(this.creator,this.creatorAnchor,t.strid,e.x,e.y,t.altitude,t.height,Number(t.orientation[0]),c[0],c[1],c[2],p),this.nbPoi++,h},getMesh:function(){var i,s,n,o,l,h=function(e,t){var i=this.mesh3js.instanceAttribArrays.instanceFlag.array,s=this.mesh3js.userData.cgmIds.indexOf(t),n=i[s],a=i[s];(n=r.floatPack(n,3,!e))!==a&&(i[s]=n,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0)},d=function(t,i,s){var n,a=0,o=t.scale,l=r.is(o),h="billboard"===this._shapeType,d=-1;if(!0===this.isInstanceNode3D){var u=this.mesh3js.userData.cgmIds;if(!r.is(u))return;a=(T=this.mesh3js.instanceAttribArrays.instanceFlag.array)[d=u.indexOf(s)]}if(l&&!h){n||(n=[]);var c,p,f;c=.5*o.x,p=.5*o.y,f=o.z,"sphere"===this._shapeType&&(p=f=c),n[0]=100*c,n[5]=100*p,n[10]=100*f}a=r.floatPack(a,2,l);var m=t.color;r.is(m)&&r.is(m.computeColor)&&(m=m.computeColor());var g,v,_=t.opacity,y=r.is(m),b=r.is(_);if(a=r.floatPack(a,0,y),a=r.floatPack(a,1,b),!0===this.isInstanceNode3D){var x=this.mesh3js.userData.instanceIds.indexOf(s);if(n){g=16*d,v=16*x;var C=this.mesh3js.instanceAttribArrays.instanceMatrix.array,S=this.mesh3js.userData.instanceMatrix;for(var D in n)if(n.hasOwnProperty(D)){var P=g+Number(D);C[P]=n[D],S[P=v+Number(D)]=n[D]}this.mesh3js.instanceAttribArrays.instanceMatrix.isDynamic=!0,function(t,i,r){var s=!1,n=i.geometry.boundingSphere,a=n.center.x-n.radius,o=n.center.x+n.radius,l=n.center.y-n.radius,h=n.center.y+n.radius,d=n.center.z-n.radius,u=n.center.z+n.radius,c=i.userData.__v0,p=i.userData.__v1;c.set(t[r+12],t[r+13],t[r+14]),p.set(t[r+0],t[r+5],t[r+10]),c.x-p.x<a&&(a=c.x-p.x,s=!0),c.x+p.x>o&&(o=c.x+p.x,s=!0),c.y-p.y<l&&(l=c.y-p.y,s=!0),c.y+p.y>h&&(h=c.y+p.y,s=!0);var f=c.z;if(c.z-p.z<d&&(d=c.z-p.z,s=!0),f+p.z>u&&(u=f+p.z,s=!0),s){var m=new e.Sphere;m.radius=Math.sqrt(Math.pow(o-a,2)+Math.pow(h-l,2)+Math.pow(u-d,2))/2,m.center.x=(a+o)/2,m.center.y=(l+h)/2,m.center.z=(d+u)/2,i.boundingSphere=m}}(C,this.mesh3js,g)}if(y||b){var w=this.mesh3js.instanceAttribArrays.instanceColor.array,M=this.mesh3js.userData.instanceColor;g=4*d,v=4*x,y&&(w[g]=m.r,w[g+1]=m.g,w[g+2]=m.b,M[x].x=m.r,M[x].y=m.g,M[x].z=m.b),b&&(w[g+3]=_,M[x].w=_),this.mesh3js.instanceAttribArrays.instanceColor.isDynamic=!0}var T=this.mesh3js.instanceAttribArrays.instanceFlag.array,I=this.mesh3js.userData.instanceFlags;a!==T[d]&&(T[d]=a,I[x]=a,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0)}},u=function(t,i){if(void 0!==t){var r=this.mesh3js.userData.cgmIds.indexOf(i),s=t[0],n=t[1],a=t[2];if(void 0!==this.mesh3js.userData.__posTile&&(s-=this.mesh3js.userData.__posTile.x,n-=this.mesh3js.userData.__posTile.y),-1!==r){var o=this.mesh3js.userData.__initScale[r][0],l=this.mesh3js.userData.__initScale[r][1],h=this.mesh3js.userData.__initScale[r][2],d=this.mesh3js.userData.__transModel.x,u=this.mesh3js.userData.__transModel.y,c=this.mesh3js.userData.__transModel.z,p=this.mesh3js.instanceAttribArrays.instanceMatrix.array,f=p[16*r+0]/o,m=p[16*r+1]/o,g=p[16*r+10]/h,v=p[16*r+6]/l,_=s+d*f-m*(u*g-c*v),y=n+(u*g-c*v)*f+d*m,b=a+u*v+c*g;p[16*r+12]=_,p[16*r+13]=y,p[16*r+14]=b,this.mesh3js.instanceAttribArrays.instanceMatrix.isDynamic=!0;var x=!1,C=this.mesh3js.geometry.boundingSphere,S=C.center.x-C.radius,D=C.center.x+C.radius,P=C.center.y-C.radius,w=C.center.y+C.radius,M=C.center.z-C.radius,T=C.center.z+C.radius,I=this.mesh3js.userData.__v0,R=this.mesh3js.userData.__v1;I.set(p[16*r+12],p[16*r+13],p[16*r+14]),R.set(p[16*r+0],p[16*r+5],p[16*r+10]),I.x-R.x<S&&(S=I.x-R.x,x=!0),I.x+R.x>D&&(D=I.x+R.x,x=!0),I.y-R.y<P&&(P=I.y-R.y,x=!0),I.y+R.y>w&&(w=I.y+R.y,x=!0);var A=I.z;if(I.z-R.z<M&&(M=I.z-R.z,x=!0),A+R.z>T&&(T=A+R.z,x=!0),x){var F=new e.Sphere;F.radius=Math.sqrt(Math.pow(D-S,2)+Math.pow(w-P,2)+Math.pow(T-M,2))/2,F.center.x=(S+D)/2,F.center.y=(P+w)/2,F.center.z=(M+T)/2}}}},c=function(e,t){if(void 0!==e){var i,r,s=this.mesh3js.userData.cgmIds.indexOf(t);if("object"==typeof e?(i=e[1],r=e[0]):(i=e,r=0),-1!==s){var n=this.mesh3js.instanceAttribArrays.instanceMatrix.array,a=this.mesh3js.userData.__initScale[s][0],o=this.mesh3js.userData.__initScale[s][1],l=this.mesh3js.userData.__initScale[s][2],h=Math.cos(i),d=Math.sin(i),u=Math.cos(r),c=Math.sin(r);n[16*s+0]=h*a,n[16*s+1]=d*a,n[16*s+2]=0,n[16*s+4]=-d*u*o,n[16*s+5]=u*h*o,n[16*s+6]=c*o,n[16*s+8]=c*d*l,n[16*s+9]=-h*c*l,n[16*s+10]=u*l,this.mesh3js.instanceAttribArrays.instanceMatrix.isDynamic=!0}return this}},p=new t;this.primitiveNodes[0]=this.creator.compilePrimitive("Poi3D",!0),this.nbMesh=1;var f,m=this.matPostPass,g=this.matPrePass;"dual"===this.renderMode&&this.opacityFactor;for(var v=0;v<this.nbMesh;v++){var _=this.primitiveNodes[v];(f=a.createMeshNode(_)).setRendering=d,f.setVisible=h,f._shapeType=this.shapeType,f.setPosition=u,f.setOrientation=c,f.setRenderPasses([this._poiPostPassID]),l="_poi3D_PostPass_"+this.styleClass,f.name=l,f._debugID=this._debugID,f.mesh3js.material=m,f.setMaterial(m);var y={data:this.instanceMatrix,type:"m4",attribName:"instanceMatrix"};i={data:this.instanceColor,type:"v4",attribName:"instanceColor"},s={data:this.instanceFlags,type:"f",attribName:"instanceFlag"},n={data:this.instanceFloats,type:"v4",attribName:"instanceFloats"},o={data:this.instanceLabels,type:"v4",attribName:"instanceLabels"},f.mesh3js.userData.cgmIds=this.instanceCgmId,f.mesh3js.userData.instanceMatrix=this.instanceMatrix,f.mesh3js.userData.instanceColor=this.instanceColor,f.mesh3js.userData.instanceFlags=this.instanceFlags,f.mesh3js.userData.instanceFloats=this.instanceFloats,f.mesh3js.userData.instanceLabels=this.instanceLabels,f.mesh3js.userData.instanceIds=this.instanceCgmId.slice(),f.mesh3js.userData.__v0=new e.Vector3,f.mesh3js.userData.__v1=new e.Vector3,f.mesh3js.userData.__initScale=this.initScale,f.mesh3js.userData.__posTile=this.posTile,f.mesh3js.userData.__transModel=new e.Vector3,f.setInstancingParameters(this.nbPoi,[y,i,s,n,o],"instance"),"dual"===this.renderMode&&(this.matPrePass=m.clone(),g=this.matPrePass);for(var b=0;b<f._occurrences.length;b++)f._occurrences[b].renderable.userData.cgmIds=this.instanceCgmId;if(f.forceBoundingSphere({radius:Math.sqrt(Math.pow(this.tileBbox.xmax-this.tileBbox.xmin,2)+Math.pow(this.tileBbox.ymax-this.tileBbox.ymin,2)+Math.pow(this.minMax.maxZ-this.minMax.minZ,2))/2,center:new e.Vector3((this.minMax.minX+this.minMax.maxX)/2,(this.minMax.minY+this.minMax.maxY)/2,(this.minMax.minZ+this.minMax.maxZ)/2)}),f.setShadow(!1,!1),p.addChild(f),"dual"===this.renderMode){var x=f.clone();x.setRenderPasses([this._poiPrePassID]),g.isInstancingMaterial=m.isInstancingMaterial,g.attributes=f.material.attributes,x.isInstanceNode3D=!0,x.mesh3js.material=g,x.setMaterial(g),x.setRendering=d,p.addChild(x),this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,g))}}return l="_poi3D_PostPass_"+this.styleClass+"_"+this.tileInfo,p.name=l,this._rendering.updateTextureWhenReady(this._indexUpdates,p),this._indexUpdates=null,this._rendering.applyRendering(p),p},_pushInstancesData:function(t,i,s,n,a,o){this.instanceMatrix[this.nbPoi]=t,this.instanceColor[this.nbPoi]=new e.Vector4(i[0],i[1],i[2],i[3]),this.instanceFlags[this.nbPoi]=s,r.is(a)||(a=[s,0,0,0]),this.instanceFloats[this.nbPoi]=new e.Vector4(a[0],a[1],a[2],a[3]),r.is(n)&&(this.instanceNormalMatrix[this.nbPoi]=n),this.instanceLabels[this.nbPoi]=new e.Vector4(o[0],o[1],o[2],o[3])},initializeInstancingParams:function(){this.instanceMatrix=[],this.instanceNormalMatrix=[],this.instanceColor=[],this.instanceAnchor=[],this.instanceAnchorColor=[],this.instanceFlags=[],this.instanceFloats=[],this.instanceLabels=[],this.instancingReady=!1,this.instanceCgmId=[],this.initScale=[]}});return v.alignedLabel={name:"alignedLabel",depends:[],attributes:{},uniforms:{width:{type:"f",value:50},height:{type:"f",value:60},top:{type:"f",value:0},left:{type:"f",value:0},switchDistance:{type:"f",value:0},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)},points:{type:"v4v",value:[]}},varyings:{},VS_global_code:["bool discardVertex = false;","bool discardVertexAngle = false;","vec4 lineDirectionScreenSpace = vec4(0.0);","const float pi = 3.141592653589793238462643383279502884197169;","// Compute offset to rescale the POI in screen space (fixed size)","float computeScaleOffset(float depthCenterCameraSpace) {","   float scaleOffset = 1.0;","   if (depthCenterCameraSpace > -switchDistance)","   {","      scaleOffset = -switchDistance / depthCenterCameraSpace;","   }","   return scaleOffset;","}","vec2 rotateVector2D(vec2 inputvector, float rotationAngle) {","   float cosRot = cos(rotationAngle);","   float sinRot = sin(rotationAngle);","   vec2 rotatedVector = vec2(cosRot*inputvector.x-sinRot*inputvector.y, sinRot*inputvector.x +cosRot*inputvector.y );","   return rotatedVector;","}","float atan2(float y,float x){","   float angle = 0.0;","   if (abs(x) > abs(y)) {","       angle = atan(y,x);","   }else {","     angle = pi/2.0 - atan(x,y);","   }","   return angle;","}","vec4 projectLinePoint(vec4 linePoint, float perspectiveFactor){"," vec4 posCameraSpace = vGetWorldViewMatrix() * vec4(linePoint.xyz, 1.0);"," posCameraSpace /= posCameraSpace.w;"," vec4 posScreenSpace = vGetProjectionMatrix() * posCameraSpace;"," perspectiveFactor = posScreenSpace.w;"," posScreenSpace /= posScreenSpace.w;"," return posScreenSpace;","}","float  getUvToMeterXFactor(vec4 posOriginCameraSpace, float xOffset, float offsetUVWidth, float width){"," vec4 posOriginScreenSpace = vGetProjectionMatrix() * posOriginCameraSpace;"," float perspectiveFactor = posOriginScreenSpace.w;"," posOriginScreenSpace /= posOriginScreenSpace.w;"," vec4 projectedVertexoffsetInX = posOriginScreenSpace + vec4(xOffset/halfScreenResolution.x,0.0, 0.0, 0.0);"," projectedVertexoffsetInX *= perspectiveFactor;"," vec4 vertexPosCameraSpaceX = vGetProjectionInvMatrix() * projectedVertexoffsetInX;"," float offsetWidthinMeters = distance(vertexPosCameraSpaceX.xyz,posOriginCameraSpace.xyz)*width;"," float uvinMeter =  offsetWidthinMeters / offsetUVWidth ;"," return uvinMeter;","}"].join("\n"),VS_overridableFunctions:{ProcessClipSpacePosition:["vec3 origin = vec3(0.0,0.0,0.0);","float niceScaledown = 0.25;","vec4 posOriginCameraSpace = vGetWorldViewMatrix() * instanceMatrix * vec4(origin.xyz, 1.0);","posOriginCameraSpace /= posOriginCameraSpace.w;","float scaleOffset = computeScaleOffset(posOriginCameraSpace.z); // / scaleCulling;"," float topOffsetInPixels = instanceFloats.w;"," float leftOffsetInPixels = instanceFloats.z;"," float index = instanceFloats.y;"," vec4 offset = texture2D(atlasOffsetTexture, vec2(0.5, (index+0.5)/800.0));"," float w = width*offset.w;"," float h = height*offset.z;"," vec2 offsetTileSpace = vGetAttribPosition().xy;"," offsetTileSpace.x += leftOffsetInPixels/w;"," offsetTileSpace.y -= topOffsetInPixels/h;"," w *= instanceMatrix[0][0];"," h *= instanceMatrix[1][1];"," vec2 offsetScreenSpace = scaleOffset*offsetTileSpace.xy*vec2(w,h)/halfScreenResolution*niceScaledown;"," vec4 posOriginScreenSpace = vGetProjectionMatrix() * posOriginCameraSpace;"," float perspectiveFactor = posOriginScreenSpace.w;"," posOriginScreenSpace /= posOriginScreenSpace.w;"," float glypheUvHalfWidth = (instanceLabels.y - instanceLabels.x)*0.5;"," float labelPixelLength = instanceLabels.z/niceScaledown;"," vec4 projectedVertexoffsetInX = posOriginScreenSpace + vec4(scaleOffset*offsetTileSpace.x/halfScreenResolution.x,0.0, 0.0, 0.0);"," projectedVertexoffsetInX *= perspectiveFactor;"," vec4 vertexPosCameraSpaceX = vGetProjectionInvMatrix() * projectedVertexoffsetInX;"," float glypheHalfWidthinMeters = distance(vertexPosCameraSpaceX.xyz,posOriginCameraSpace.xyz)*w*niceScaledown;"," float uvinMeter =  getUvToMeterXFactor(posOriginCameraSpace,scaleOffset*offsetTileSpace.x,glypheUvHalfWidth,w*niceScaledown) ;"," float linearDistancetoLabelCenter = instanceLabels.w;"," float glypheUvCenter = instanceLabels.x + glypheUvHalfWidth; "," float uvDistance = 0.5 - glypheUvCenter; "," float radius = 0.5 * uvinMeter;"," if(radius > instanceFloats.x){","   discardVertex = true;"," }"," vec4 posStartLabelCameraSpace = getPositionFromDistance(linearDistancetoLabelCenter - radius);","if(posStartLabelCameraSpace.w < 0.0){","   discardVertex = true;","}"," posStartLabelCameraSpace = vGetWorldViewMatrix() * vec4(posStartLabelCameraSpace.xyz, 1.0);"," posStartLabelCameraSpace /= posStartLabelCameraSpace.w;"," vec4 posStartLabelScreenSpace = vGetProjectionMatrix() * posStartLabelCameraSpace;"," posStartLabelScreenSpace /= posStartLabelScreenSpace.w;"," vec4 posEndLabelCameraSpace = getPositionFromDistance(linearDistancetoLabelCenter + radius);","if(posEndLabelCameraSpace.w < 0.0){","   discardVertex = true;","}"," posEndLabelCameraSpace = vGetWorldViewMatrix() * vec4(posEndLabelCameraSpace.xyz, 1.0);"," posEndLabelCameraSpace /= posEndLabelCameraSpace.w;"," vec4 posEndLabelScreenSpace = vGetProjectionMatrix() * posEndLabelCameraSpace;"," posEndLabelScreenSpace /= posEndLabelScreenSpace.w;"," float disTancetoanchor = uvDistance * uvinMeter;","vec3 depthDirection = (vec3(0.0,0.0,-1.0));","vec3 readingDirection = (vec3(1.0,0.0,0.0));","vec3 lineDirectionCameraSpace = normalize(posEndLabelCameraSpace.xyz - posOriginCameraSpace.xyz);","lineDirectionScreenSpace.xyz = normalize(posEndLabelScreenSpace.xyz - posOriginScreenSpace.xyz);","float readingAngle = dot(lineDirectionScreenSpace.xyz,readingDirection);","bool shiftReading = false;","if(readingAngle < 0.0){"," shiftReading = true;","disTancetoanchor = -disTancetoanchor;","}","vec3 viewdir = (normalize(lineDirectionCameraSpace.xyz));","vec3 vector = normalize(posStartLabelCameraSpace.xyz);","float otherangle = (abs(dot(vector,vec3(0.0,0.0,1.0) ) ) ) ;","float verticalangle = abs(dot(viewdir,vec3(0.0,0.0,1.0) ) ) ;","if(abs(verticalangle) > 0.51){","float exsecOfAngle = verticalangle;","}","if(abs(verticalangle) > 0.81){"," discardVertexAngle = true;","}"," lineDirectionScreenSpace.xyz = abs(viewdir.xyz);"," float distanceToGlypheCenter = instanceLabels.w - disTancetoanchor;"," vec4 posCenterCameraSpace = getPositionFromDistance(distanceToGlypheCenter);","if(posCenterCameraSpace.w < 0.0 ){","   discardVertex = true;","}"," posCenterCameraSpace = vGetWorldViewMatrix() * vec4(posCenterCameraSpace.xyz, 1.0);"," posCenterCameraSpace /= posCenterCameraSpace.w;"," vec4 posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;"," perspectiveFactor = posCenterScreenSpace.w;"," posCenterScreenSpace /= posCenterScreenSpace.w;"," projectedVertexoffsetInX = posCenterScreenSpace + vec4(offsetScreenSpace.x,0.0, 0.0, 0.0);"," projectedVertexoffsetInX *= perspectiveFactor;"," vertexPosCameraSpaceX = vGetProjectionInvMatrix() * projectedVertexoffsetInX;"," glypheHalfWidthinMeters = distance(vertexPosCameraSpaceX.xyz,posCenterScreenSpace.xyz);"," float uvinMeterY =  glypheHalfWidthinMeters / glypheUvHalfWidth ;"," float distancetoLabelcenter = (posOriginCameraSpace.z);"," float distancetoglypheCenter = (posCenterCameraSpace.z);"," float distancedirect = distance(posOriginCameraSpace.xyz , posCenterCameraSpace.xyz);"," float otherscale =  distancetoglypheCenter/distancedirect;","  float adjustementScale = distancetoglypheCenter/distancetoLabelcenter;","if(verticalangle > 0.01){","}","distanceToGlypheCenter = instanceLabels.w - disTancetoanchor*adjustementScale;"," posCenterCameraSpace = getPositionFromDistance(distanceToGlypheCenter);","if(posCenterCameraSpace.w < 0.0 ){","   discardVertex = true;","}"," posCenterCameraSpace = vGetWorldViewMatrix() * vec4(posCenterCameraSpace.xyz, 1.0);"," posCenterCameraSpace /= posCenterCameraSpace.w;"," posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;"," posCenterScreenSpace /= posCenterScreenSpace.w;"," float disTancetostart = (0.5 - instanceLabels.x) * uvinMeter;"," float disTancetoend = (0.5 - instanceLabels.y) * uvinMeter;","if(shiftReading == true){","   disTancetostart = -disTancetostart;","   disTancetoend = -disTancetoend;","}"," float disTancetostartPoint = instanceLabels.w - disTancetostart;"," vec4 posStartCameraSpace = getPositionFromDistance(disTancetostartPoint);","if(posStartCameraSpace.w < 0.0){","   discardVertex = true;","}"," posStartCameraSpace = vGetWorldViewMatrix() * vec4(posStartCameraSpace.xyz, 1.0);"," posStartCameraSpace /= posStartCameraSpace.w;"," vec4 posStartScreenSpace = vGetProjectionMatrix() * posStartCameraSpace;"," posStartScreenSpace /= posStartScreenSpace.w;"," float distanceToEndPoint = instanceLabels.w - disTancetoend;"," vec4 posEndCameraSpace = getPositionFromDistance(distanceToEndPoint);","if(posEndCameraSpace.w < 0.0){","   discardVertex = true;","}"," posEndCameraSpace = vGetWorldViewMatrix() * vec4(posEndCameraSpace.xyz, 1.0);"," posEndCameraSpace /= posEndCameraSpace.w;"," vec4 posEndScreenSpace = vGetProjectionMatrix() * posEndCameraSpace;"," posEndScreenSpace /= posEndScreenSpace.w;","vec2 horizontalOrientation = normalize(normalize(posEndScreenSpace.xy - posStartScreenSpace.xy)*halfScreenResolution);","float rotationAngle = atan2(horizontalOrientation.y,horizontalOrientation.x);"," vec2 offsetOrientedScreenSpace = rotateVector2D(scaleOffset*offsetTileSpace*vec2(w,h),rotationAngle)/halfScreenResolution*niceScaledown;"," ioPosition = posCenterScreenSpace + vec4(offsetOrientedScreenSpace, 0.0, 0.0);"].join("\n"),ComputeVaryingValues:["if(discardVertexAngle){","   l_invisibility = 1.0;","}","if(discardVertex){","   l_invisibility = 1.0;","}"].join("\n")},FS_overridableFunctions:{ComputeOpacity:[].join("\n")}},v}),define("DS/XCityRendering/RenderingHandler3D",["DS/XCityTools/ShaderTools","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerDataviz","DS/XCityRendering/Rendering","DS/XCityRendering/FeatureRendering","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/ColorGradient","DS/XCityTools/RenderingTools"],function(e,t,i,r,s,n,a,o){"use strict";return i.extend({init:function(e,i,r){this._parent(e,i),this.defaultRendering=new s,this.lastRendering=new s,this.currentRendering=new s;var o={Material:{opacity:1,wireframe:!1,alphaTest:0,side:n.FrontSide,specular:new a(new n.Color("#000000")),ambient:new a(new n.Color("#FFFFFF")),diffuse:new a(new n.Color("#FFFFFF")),depthTest:!0,depthWrite:!0,shininess:1,color:new a(new n.Color("#FFFFFF")),renderingDescription:""},ElementRendering:[{ElementIds:this._allIds,ElementMaterial:{color:new a(new n.Color("#FFFFFF")),opacity:1}}]};t.is(r)&&(this.defaultRendering.addOver(r.defaultRendering),this._content=r._content,this.currentRendering.addOver(r.currentRendering)),this.defaultRendering.addOver(o),this.defaultRendering.addOver(this.getDefaultRendering()),this.initInputParams()},getDefaultRendering:function(){},updateRendering:function(e){this.lastRendering.copy(this.currentRendering);var t=e;this.currentRendering.copy(t),this._completeFeatureRendering=null,this._needRebuild=this._needRebuild||this.shouldRebuild(this.lastRendering,this.currentRendering);this._parent(e);this.updateContentRendering()},updateContentRendering:function(){if(t.is(this._content)){var e=new s;e.addOver(this.defaultRendering),e.addOver(this.currentRendering);var i=e.toJSON();this._content.set("Rendering",i)}},updatePrimitiveRendering:function(e){this.currentRendering.addOver(e)},getFeatureRendering:function(){var e=new r;return e.addOver(this.defaultRendering),e.addOver(this.currentRendering),e},getMappings:function(e){return t.is(this._completeFeatureRendering)||(this._completeFeatureRendering=new s(this.defaultRendering),this._completeFeatureRendering.addOver(this.currentRendering)),this._completeFeatureRendering.getMappings(e)},getPrimitiveRendering:function(e,t){var i=new r,s=this.defaultRendering.getPrimitiveRendering(e,t);i.addOver(s);var n=this.currentRendering.getPrimitiveRendering(e,t);return i.addOver(n),i},applyFeatureRenderingToMaterial:function(t){var i=this.getCompleteMaterialInfo();o._setMaterialFromProfile(t,i),o._setMaterialMapFromProfile(t,i,this),e.updateCommonUniforms(t),this._lastSeenMaterial=t},applyRendering:function(e){if(t.is(e)){this._parent(e);var i,r,s=!0;if(e.children&&(r=e.children.length)>0)for(s=!1,i=0;i<r;i++)this.isMeshToConsider(e.children[i])&&this.applyRenderingToMesh(e.children[i]);s&&this.isMeshToConsider(e)&&this.applyRenderingToMesh(e)}},isMeshToConsider:function(e){return!(!e||void 0===e.mesh3js)},applyRenderingToMesh:function(e){this.applyFeatureRenderingToMesh(e),this.applyPrimitiveRenderingToMesh(e)},applyFeatureRenderingToMesh:function(e){this.updateMesh(e)},updateMesh:function(e){this.initMesh(e)},applyPrimitiveRenderingToMesh:function(e){this.applyElementRendering(e)},hasAttribute:function(e){return!(!t.is(this.defaultRendering)||void 0===this.defaultRendering.get(e))},getCompleteMaterialInfo:function(e,t){var i=this.defaultRendering.getCompleteMaterialInfo(e,t),s=this.currentRendering.getCompleteMaterialInfo(e,t),n=new r(i);return n.addOver(s),n.getRenderingData()},_getMaterialInfo:function(){return this.getCompleteMaterialInfo()},getDefaultRenderingData:function(){return this.defaultRendering.getRenderingData()},getPrimitiveRenderings:function(){return this.currentRendering.getPrimitiveRenderings()},hasPrimitiveRendering:function(){return this.currentRendering.hasPrimitiveRendering()},isPrimitiveRegistered:function(e){var i=!1;return t.is(this._primitives)&&t.is(this._primitives[e])&&(i=!0),i},getListRenderingAttributes:function(){var e=this.getDefaultRenderingData();return Object.keys(e)},getCurrentRenderingDifference:function(e,t){return this.currentRendering.getCompleteMaterialInfo(e,t)},initInputParams:function(){var e=this.getInputRendering();this.defaultRendering.addOverNoAdd(e)},getInputRendering:function(){var e=new r;if(t.is(this._inputParam)){var i=this._inputParam;e.addOver(i)}return e},getRenderingValues:function(e,t){return this.getCompleteMaterialInfo(e,t)},getPrimitiveRenderingValues:function(e,t){return this.getPrimitiveRendering(e,t).getRenderingData()},getFlagForPrimitive:function(e,i){var r=0;if(e){var s=this.getPrimitiveRenderingValues(e,i);t.is(s.color)&&(r+=1),t.is(s.opacity)&&(r+=2)}return r},_getAllFixedValuesForAttribute:function(e){var i,r,s,n,a,o;if(i=this.currentRendering.getAllValuesForAttribute(e),t.is(i)||(i=this.defaultRendering.getAllValuesForAttribute(e)),t.is(i)){var l=[];if(t.is(i.Material)&&l.push({isPrimitive:!1,value:i.Material[e]}),t.is(i.DatavizMaterial))for(s=(r=Object.keys(i.DatavizMaterial[e])).length,n=0;n<s;n++)a=r[n],o=i.DatavizMaterial[e][a],l.push({isPrimitive:!0,value:o});if(t.is(i.ElementMaterial))for(s=(r=Object.keys(i.ElementMaterial[e])).length,n=0;n<s;n++)a=r[n],o=i.ElementMaterial[e][a],l.push({isPrimitive:!0,value:o});return l}return null},onTextureDownloadStart:function(e,t,i){},getDefaultPrimitiveRenderingData:function(){return this.defaultRendering.getPrimitiveRendering(this._allIds).getRenderingData()},getListPrimitiveRenderingAttributes:function(){var e=this.getDefaultPrimitiveRenderingData();return Object.keys(e)}})}),define("DS/XCityRendering/RenderingHandlerAtlasing",["DS/XCityRendering/RenderingHandler3D","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/Visualization/ThreeJS_DS","DS/XCityTools/TextureManager","DS/XCityTools/TextureTools"],function(e,t,r,s,n,a){"use strict";var o=e.extend({init:function(e,t,i){this.atlasId=null,this.enableAtlasing=!1,this._parent(e,t,i)},_getMapsFromRendering:function(e,i,r){var s,n,a,o;if(t.is(i.Material)&&(r[i.Material[e]]=!0),t.is(i.DatavizMaterial))for(n=(s=Object.keys(i.DatavizMaterial[e])).length,a=0;a<n;a++)o=s[a],r[i.DatavizMaterial[e][o]]=!0;if(t.is(i.ElementMaterial))for(n=(s=Object.keys(i.ElementMaterial[e])).length,a=0;a<n;a++)o=s[a],r[i.ElementMaterial[e][o]]=!0},getAllMapsToAtlas:function(){var e;e=this.currentRendering.getAllValuesForAttribute("mapUrl");var i=[],r={};t.is(this._mapUrls)&&(r=Object.assign(this._mapUrls));var s,n,a,o;for(t.is(e)&&this._getMapsFromRendering("mapUrl",e,r),e=this.defaultRendering.getAllValuesForAttribute("mapUrl"),t.is(e)&&this._getMapsFromRendering("mapUrl",e,r),i=[],n=(s=Object.keys(r)).length,a=0;a<n;a++)o=s[a],i.push(o);return i.length>0?i:null},_createAtlasFromUrlsList:function(e){t.is(e)&&e.length>1?(this.atlasId=n.makeAtlasFromUrls(e),this.currentRendering.set("mapAtlasId",this.atlasId),this._needRebuild=!0):(this.atlasId&&(this._needRebuild=!0),this.atlasId=null)},updateCurrentMaps:function(){if(!0===this.enableAtlasing){var e=this.getAllMapsToAtlas();this._createAtlasFromUrlsList(e)}},updateRendering:function(e){this._parent(e),this.updateCurrentMaps()},getIndexForTextureUrl:function(e){return t.is(this.atlasId)?n.getTextureIndex(this.atlasId,e):0},addAtlasUniforms:function(e){var i=n.getAtlasDescription(this.atlasId);if(t.is(i)){var o,l=[];for(o=0;o<Math.min(i.x.length,n.ATLASSIZE);o++){var h=i.x[o],d=i.y[o],u=i.height[o],c=i.width[o],p=new s.Vector4(h,d,u,c);l.push(p)}for(o=i.x.length;o<n.ATLASSIZE;o++)l.push(new s.Vector4);var f=0,m=new Float32Array(4*n.ATLASSIZE);for(o=0;o<n.ATLASSIZE;o++)m[f+0]=l[o].x,m[f+1]=l[o].y,m[f+2]=l[o].z,m[f+3]=l[o].w,f+=4;var g={data:m,xSize:1,ySize:n.ATLASSIZE,name:"atlasOffsetTexture",format:s.RGBAFormat,filter:s.NearestFilter,flipY:!1,generateMipmaps:!1},v=a.createTexture(g);r.updateSingleUniform(e,"atlasOffsetTexture",v)}else n.addCallbackToAtlas(this.atlasId,this.addAtlasUniforms.bind(this,e))},onTextureApplied:function(e,i,s,a){var o=s[a.atlas];t.is(o)||t.is(s[a.atlasId])&&(o=n.getOrDownloadTexture(s[a.atlasId],function(e){if(t.is(e)){i[a.param]=e;var s=i[a.param].image.width;t.is(s)&&r.updateSingleUniform(i,"width",s);var n=i[a.param].image.height;t.is(n)&&r.updateSingleUniform(i,"height",n),r.updateCommonUniforms(i)}}),t.is(o)&&(s[a.atlas]=o)),t.is(o)&&(i[a.param]=o)},updateTextureWhenReady:function(e,i){if(t.is(e)&&t.is(i)){this.updateCurrentMaps();var r=this;t.is(this.atlasId)&&n.addCallbackToAtlas(this.atlasId,function(){var t,s,n,a,o,l=Object.keys(e),h=l.length,d=i.children.length;for(a=0;a<d;a++)for(o=i.children[a],t=0;t<h;t++)s=l[t],n=e[s],r.updateTextureInfo(o,s,n)})}}}),l=0,h=new Float32Array(4*n.ATLASSIZE);for(i=0;i<n.ATLASSIZE;i++)h[l+0]=0,h[l+1]=0,h[l+2]=1,h[l+3]=1,l+=4;var d={data:h,xSize:1,ySize:n.ATLASSIZE,name:"defaultAtlasOffsetTexture",format:s.RGBAFormat,filter:s.NearestFilter,flipY:!1,generateMipmaps:!1};return o.defaultAtlasOffsetTexture=a.createTexture(d),o}),define("DS/XCityRendering/RenderingHandlerSpecific",["DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/Visualization/Mesh3D","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerAtlasing"],function(e,t,i,r,s,n){"use strict";return n.extend({init:function(e,t,i){this._parent(e,t,i)}})}),define("DS/XCityRendering/RenderingHandlerGeometry",["DS/XCityTools/ShaderTools","DS/Visualization/Mesh3D","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerSpecific","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering","DS/Visualization/ThreeJS_DS"],function(e,t,i,r,s,n,a,o){"use strict";return s.extend({init:function(e,t){this._parent(e,t),this.type="Geometry"},getDefaultRendering:function(){return Object.assign({},this._parent(),{scale:new o.Vector3(0,0,0)})},addDefaultScaleFromAttributes:function(e){var t=(new n).propertyName(e).toNumber(),i=new a(null,null,{scale:t});i.addOverIds("3DXCityDefaultIDdefaultScaleAttributeModel"),this.defaultRendering.addOver(i)},shouldRebuild:function(e,t){return!!this._parent(e,t)||!(!t.renderingData.scale||e.renderingData.scale&&t.renderingData.scale.equals(e.renderingData.scale))}})}),define("DS/XCityGeometry/Polygon",["DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Plugins/RenderPass","DS/Plugins/ClearPass","DS/Visualization/SceneGraphFactory","DS/XCityRendering/RenderingHandlerSpecific","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools"],function(THREE,CATXMLV6,Node3D,RenderPass,ClearPass,SceneGraphFactory,RenderingHandlerSpecific,Utils,ShaderTools,RenderingTools){"use strict";var Polygon=Node3D.extend({init:function(e,t){this.urban=e,void 0!==t.shape&&(this.shape=t.shape,this.holes=t.holes,this.shape[0].x===this.shape[this.shape.length-1].x&&this.shape[0].y===this.shape[this.shape.length-1].y||this.shape.push(this.shape[0]),this.attributes=t.attributes,this._parent(),this.primId=t.primId,this._rendering=t.rendering,Utils.is(this._rendering)||(console.error(" UrbanPolygon instanciated with wrong handler"),this._rendering=new RenderingHandlerSpecific(e,t)),this.matOne=void 0,this.matTwo=void 0,this.oldCamPos={x:0,y:0,z:0},this._applyMaterial(),this._createShape(this.shape),this.forceUpdateDistance=!0,this.dynamicUpdate?(this._updateOnDistance(this.urban),this.isInUpdateSlots=!0):(this.isInUpdateSlots=!1,this._updateOnDistance(this.urban)))},_defineRenderPass:function(){this._polygonOccludedPassID="main",this._polygonOverlayPassID="noz"},_defineStencilPass:function(){var e=this.color.getStyle();if(this._clearStencilPassID="clear_stencil_polygon_"+e,void 0===this.urban.getView3D().getRenderPassManager().getPass(this._clearStencilPassID)){var t=new ClearPass(this._clearStencilPassID);t.defaults.clear=!1,t.defaults.doClearDepth=!1,t.clear=!1,t.clearDepth=!1,t.clearStencil=!0,t.idString=this._clearStencilPassID,this.urban.getView3D().getRenderPassManager().addPass(this._clearStencilPassID,t,{post:!0})}if(this._polygonStencilPassID="stencil_polygon_"+e,void 0===this.urban.getView3D().getRenderPassManager().getPass(this._polygonStencilPassID)){var i=new RenderPass(null,null,void 0,!0,!1,!1,this._polygonStencilPassID);i.idString=this._polygonStencilPassID,i.setEnableStencilTest(!0),i.setDisableColorWrite(!0),i.setDisableDepthWrite(!0),i.setEnableStencilWrite(!0),i.setStencilFunc("ALWAYS"),i.setStencilOpsSeparate("INCR_WRAP","DECR_WRAP","KEEP","KEEP"),i.setDisableBackFaceCulling(!0),i.ignoreNoZ=!0,this.urban.getView3D().getRenderPassManager().addPass(this._polygonStencilPassID,i,{after:this._clearStencilPassID})}if(this._polygonFullscreenPassID="fullscreen_polygon_"+e,void 0===this.urban.getView3D().getRenderPassManager().getPass(this._polygonFullscreenPassID)){var r=new RenderPass(null,null,void 0,!0,!1,!1,this._polygonFullscreenPassID);r.idString=this._polygonFullscreenPassID,r.setDisableBackFaceCulling(!1),r.setDisableDepthWrite(!0),r.setEnableStencilTest(!0),r.setStencilFunc("NOTEQUAL"),r.ignoreNoZ=!0,this.urban.getView3D().getRenderPassManager().addPass(this._polygonFullscreenPassID,r,{after:this._polygonStencilPassID})}},_createGeometryLine:function(e){var t=new Node3D,i=Array.from(e),r=0;for(r=0;r<i.length;r++)i[r].setZ(0);if(t.addChild(SceneGraphFactory.createLineNode({points:i})),this.holes&&this.holes.length>0)for(r=0;r<this.holes.length;r++)t.addChild(SceneGraphFactory.createLineNode({points:this.holes[r]}));return t},_createShape:function(e){var t,i,r,s,n;if(e)if(this.removeAllExistingChildren(),"line"===this.geometricMode||"filled"===this.geometricMode||"extruded"===this.geometricMode){if("line"===this.geometricMode)r=this._createGeometryLine(e);else if("filled"===this.geometricMode)t=new THREE.Shape(e),this._appendHoles(t.holes),s=new THREE.ShapeGeometry(t),i=new THREE.Mesh(s),r=SceneGraphFactory.createNodeFromTHREEMesh(i);else{t=new THREE.Shape(e),this._appendHoles(t.holes);var a=this.extrusionHeight;isNaN(a)&&(a=this.attributes[this.extrusionHeight],isNaN(a)&&(a=this.computeExpr(this.extrusionHeight),isNaN(a)&&(a=100))),n={amount:a,steps:1,material:1,extrudeMaterial:0,bevelEnabled:!1},s=new THREE.ExtrudeGeometry(t,n),i=new THREE.Mesh(s),r=SceneGraphFactory.createNodeFromTHREEMesh(i)}if("occluded"===this.renderMode)"line"===this.geometricMode?(this.matOne=new THREE.LineBasicMaterial,this.matOne.isWideLine=!0):"filled"===this.geometricMode?this.matOne=new THREE.MeshBasicMaterial:this.matOne=new THREE.MeshPhongMaterial,r.setMaterial(this.matOne),r.setRenderPasses([this._polygonOccludedPassID]),this.addChild(r);else if("overlay"===this.renderMode)"line"===this.geometricMode?(this.matOne=new THREE.LineBasicMaterial,this.matOne.isWideLine=!0):"filled"===this.geometricMode?this.matOne=new THREE.MeshBasicMaterial:this.matOne=new THREE.MeshPhongMaterial,this.matOne.depthTest=!1,r.setMaterial(this.matOne),r.setRenderPasses([this._polygonOverlayPassID]),this.addChild(r);else{var o;if("line"===this.geometricMode?(this.matOne=new THREE.LineBasicMaterial,this.matTwo=new THREE.LineBasicMaterial,this.matOne.isWideLine=!0,this.matTwo.isWideLine=!0):"filled"===this.geometricMode?(this.matOne=new THREE.MeshBasicMaterial,this.matTwo=new THREE.MeshBasicMaterial):(this.matOne=new THREE.MeshPhongMaterial,this.matTwo=new THREE.MeshPhongMaterial),r.setMaterial(this.matOne),r.setRenderPasses([this._polygonOccludedPassID]),"line"===this.geometricMode){o=new Node3D;for(var l=0;l<r.getChildren().length;l++)o.addChild(r.getChildren()[l])}else o=r.clone();o.setMaterial(this.matTwo),o.setRenderPasses([this._polygonOverlayPassID]),this.addChild(r),this.addChild(o)}}else{n={amount:300,steps:1,material:1,extrudeMaterial:0,bevelEnabled:!1},t=new THREE.Shape(e),this._appendHoles(t.holes),d=new THREE.ExtrudeGeometry(t,n),i=new THREE.Mesh(d),(r=SceneGraphFactory.createNodeFromTHREEMesh(i)).setShadow(!1,!1),r.setSSAO(!1),r.setMatrix((new THREE.Matrix4).identity().setPosition(new THREE.Vector3(0,0,-150)));var h=new THREE.MeshBasicMaterial;r.setMaterial(h),r.setRenderPasses([this._polygonStencilPassID]),this.addChild(r),this.matOne=new THREE.ShaderMaterialDS({side:THREE.FrontSide,transparent:!0,opacity:.5,uniforms:{pColor:{type:"c",value:this.color},pOpacity:{type:"f",value:this.opacity}},vertexShaderPars:"varying vec3 vColor;uniform vec3 pColor;varying float vOp; uniform float pOpacity;",vertexShaderBody:["vec4 mvPosition = viewMatrix * ( modelMatrix  * vec4(position.xyz, 1));","vec3 mvNormal;","if (use_normal_matrix)","mvNormal = normalMatrix * vec3(0.0,0.0,1.0);","else ","mvNormal = vec3(viewMatrix * (modelMatrix * vec4(0.0,0.0,1.0,0.0) ) );","gl_Position = vec4(position.xy, 0.5,1.0);","vColor = pColor.rgb;","vOp = pOpacity;"].join("\n"),fragmentShaderPars:"varying vec3 vColor;varying float vOp;",fragmentShaderBody:["gl_FragColor.rgb = vColor; gl_FragColor.a = vOp;"].join("\n")}),this.matOne.force=!0,this.matOne.depthTest=!1,this.matOne.depthWrite=!1;var d=new THREE.PlaneGeometry(1e7,1e7),u=new THREE.Mesh(d),c=SceneGraphFactory.createNodeFromTHREEMesh(u);c.setPickable(CATXMLV6.NODRAWHL),c.setShadow(!1,!1),c.setSSAO(!1),c.setMaterial(this.matOne),c.setRenderPasses([this._polygonFullscreenPassID]),this.addChild(c)}},_appendHoles:function(e){if(this.holes&&this.holes.length>0)for(var t=0;t<this.holes.length;t++){var i=new THREE.Path(this.holes[t]);e.push(i)}},addChild:function(e){var t=this;e.setColor=function(e,i){return Utils.is(i[0].originalMaterial)||(i[0].originalMaterial={}),Utils.is(i[0].originalMaterial.color)||(i[0].originalMaterial.color=t.color.clone()),t.setColor(e.clone()),i[0].originalMaterial.color},e.setOpacity=function(e,i){return Utils.is(i[0].originalMaterial)||(i[0].originalMaterial={}),Utils.is(i[0].originalMaterial.opacity)||(i[0].originalMaterial.opacity=t.opacity),t.setOpacity(e),i[0].originalMaterial.opacity},this._parent(e)},removeChild:function(e){this._rendering.removeMesh(e.id),this._parent(e)},_setShape:function(){if("volumetric"===this.geometricMode)2===this.children.length&&(this.children[0].setRenderPasses([this._polygonStencilPassID]),this.children[1].setRenderPasses([this._polygonFullscreenPassID]));else{var e=this.children.length;if(0===e)return;if(1===e)if("occluded"===this.renderMode)this.children[0].setRenderPasses([this._polygonOccludedPassID]);else if("overlay"===this.renderMode)this.children[0].setRenderPasses([this._polygonOverlayPassID]);else{"line"===this.geometricMode?this.matTwo=new THREE.LineBasicMaterial:"filled"===this.geometricMode?this.matTwo=new THREE.MeshBasicMaterial:this.matTwo=new THREE.MeshPhongMaterial;var t=this.children[0].clone();t.setMaterial(this.matTwo),t.setRenderPasses([this._polygonOverlayPassID]),this.addChild(t),this.children[0].setRenderPasses([this._polygonOccludedPassID])}else this.removeChild(this.children[1]),"occluded"===this.renderMode?this.children[0].setRenderPasses([this._polygonOccludedPassID]):"overlay"===this.renderMode&&this.children[0].setRenderPasses([this._polygonOverlayPassID])}},_updateMaterials:function(){var e=this._rendering.getCompleteMaterialInfo(this.primId,this.attributes);this.matOne&&(this.matOne.force=!0,this.matOne.needsUpdate=!0,RenderingTools._setMaterialFromProfileNoAdd(this.matOne,e),"volumetric"===this.geometricMode&&(this.matOne.depthTest=!1,this.matOne.depthWrite=!1),ShaderTools.updateCommonUniforms(this.matOne),this.matOne.update&&this.matOne.update(),this.matOne.updateDeferredMaterials&&(this.matOne._deferredMaterialsInit=!1)),this.matTwo&&(this.matTwo.force=!0,this.matTwo.needsUpdate=!0,RenderingTools._setMaterialFromProfileNoAdd(this.matTwo,e),this.matTwo.opacity=this.matTwo.opacity*e.opacityFactor,ShaderTools.updateCommonUniforms(this.matTwo),this.matTwo.update&&this.matTwo.update(),this.matTwo.updateDeferredMaterials&&(this.matTwo._deferredMaterialsInit=!1))},setColor:function(e){this.color=e,"volumetric"===this.geometricMode&&(this._defineStencilPass(),this._setShape()),this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban)},setOpacity:function(e){this.opacity=e,this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban)},setOpacityFactor:function(e){this.opacityFactor=e,this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban)},setLineWidth:function(e){this.lineWidth=e,this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban)},setRenderMode:function(e){this.renderMode=e,this._setShape(),this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban)},setGeometricMode:function(e){e!==this.geometricMode&&(this.geometricMode=e,"volumetric"===this.geometricMode?this._defineStencilPass():this._defineRenderPass(this.renderMode),this._createShape(this.shape),this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban))},setExtrusionHeight:function(e){e!==this.extrusionHeight&&(this.extrusionHeight=e,this._createShape(this.shape),this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban))},setColorGradient:function(e){if(e!==this.colorGradient){if(this.colorGradient=e,void 0!==this.colorGradient){var t=this.computeExpr(this.colorGradient.value);this.color=Utils.getColorGradient(t,{min:this.colorGradient.gradientMin,max:this.colorGradient.gradientMax,minHue:this.colorGradient.minHue,maxHue:this.colorGradient.maxHue,sat:this.colorGradient.sat})}"volumetric"===this.geometricMode&&(this._defineStencilPass(),this._setShape()),this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban)}},_updateOnDistance:function(e){if(this.dynamicUpdate||this.forceUpdateDistance){var t,i,r=e.getViewpoint().getPosition();if(this.forceUpdateDistance||r.x!==this.oldCamPos.x||r.y!==this.oldCamPos.y||r.z!==this.oldCamPos.z){if(this.forceUpdateDistance=!1,this.dynamicUpdate){this.oldCamPos.x=r.x,this.oldCamPos.y=r.y,this.oldCamPos.z=r.z;var s=this.bSphere.center.clone().sub(r).length();s<this.minDist&&(s=this.minDist),s>this.maxDist&&(s=this.maxDist);var n=1-Math.min(1,(s-this.minDist)/(this.maxDist-this.minDist));t=Math.ceil(Math.max(this.minWidth,this.lineWidth*n)),i=Math.max(this.minOpacity,this.opacity*n)}else t=this.lineWidth,i=this.opacity;this.matOne&&(this.matOne.color=this.color,"line"===this.geometricMode&&(this.matOne.lineWidth=t),this.matOne.opacity=i,this.matOne.transparent=i<1,"volumetric"===this.geometricMode&&Utils.is(this.matOne.uniforms)&&(this.matOne.uniforms.pColor={type:"c",value:this.color},this.matOne.uniforms.pOpacity={type:"f",value:i})),this.matTwo&&(this.matTwo.color=this.color,"line"===this.geometricMode&&(this.matTwo.lineWidth=t),this.matTwo.opacity=i*this.opacityFactor,this.matTwo.transparent=i*this.opacityFactor<1),this._updateMaterials()}}},getMaterials:function(){var e=[];return Utils.is(this.matOne)&&e.push(this.matOne),Utils.is(this.matTwo)&&e.push(this.matTwo),e},isVolumetric:function(){return"volumetric"===this.geometricMode},_applyMaterial:function(){this.needDynUpdate=!1;var e=!1,t=!1,i=!1,r=this._rendering.getCompleteMaterialInfo(this.primId,this.attributes);Utils.is(r.dynamicUpdate)&&(this.dynamicUpdate=r.dynamicUpdate),Utils.is(r.minDist)&&(this.minDist=r.minDist,this.needDynUpdate=!0),Utils.is(r.maxDist)&&(this.maxDist=r.maxDist,this.needDynUpdate=!0),Utils.is(r.renderMode)&&this.renderMode!==r.renderMode&&(this.renderMode=r.renderMode,e=!0,this.needDynUpdate=!0),Utils.is(r.geometricMode)&&r.geometricMode!==this.geometricMode&&(this.geometricMode=r.geometricMode,this.isVolumetric()?t=!0:i=!0,!0,this.needDynUpdate=!0),Utils.is(r.color)&&(this.color=r.color,this.isVolumetric()&&(t=!0,e=!0),this.needDynUpdate=!0),Utils.is(r.minOpacity)&&(this.minOpacity=r.minOpacity,this.needDynUpdate=!0),Utils.is(r.opacity)&&(this.opacity=r.opacity,this.needDynUpdate=!0),Utils.is(r.lineWidth)&&(this.lineWidth=r.lineWidth,this.needDynUpdate=!0),Utils.is(r.minWidth)&&(this.minWidth=r.minWidth,this.needDynUpdate=!0),Utils.is(r.extrusionHeight)&&r.extrusionHeight!==this.extrusionHeight&&(this.extrusionHeight=r.extrusionHeight,!0,this.needDynUpdate=!0),Utils.is(r.opacityFactor)&&(this.opacityFactor=r.opacityFactor,this.needDynUpdate=!0),t&&this._defineStencilPass(),i&&this._defineRenderPass(this.renderMode),!1===this._rendering.needsRebuild()&&e&&this._setShape(this.shape),this._applyDynamicUpdate(),this._keepLastSeenMaterial()},removeAllExistingChildren:function(){for(var e=this.children.length;e>0;--e)this.removeChild(this.children[e-1])},rebuild:function(){this._createShape(this.shape),this._applyDynamicUpdate(),this._keepLastSeenMaterial()},_applyDynamicUpdate:function(){!0===this.needDynUpdate&&(this.forceUpdateDistance=!0,this._updateOnDistance(this.urban))},_keepLastSeenMaterial:function(){var e=this.getMaterials();Utils.is(e)&&Utils.is(e[0])&&(this._rendering._lastSeenMaterial=e[0])},_updateCommonParams:function(){var e,t=this.getMaterials(),i=this._rendering.currentMaterial;for(e=0;e<t.length;e++)RenderingTools._setMaterialFromProfile(t[e],i),this._rendering._lastSeenMaterial=t[e]},computeExpr:function(expr){for(var list=expr.split(/[()\/*+-]/),attr,i=0;i<list.length;++i)attr=list[i],-1===attr.indexOf("Math.")&&""!==attr&&isNaN(attr)&&(expr=expr.replace(attr,this.attributes[attr]));return eval(expr)}});return Polygon}),define("DS/XCityRendering/RenderingHandlerLabel",["DS/XCityTools/ShaderTools","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerSpecific","DS/Visualization/ThreeJS_DS","DS/XCityTools/Expression","DS/XCityTools/OGCFilter","DS/XCityRendering/DatavizRendering"],function(e,t,i,r,s,n,a){"use strict";return i.extend({init:function(e,t,i){this._parent(e,t,i),this.addDefaultDatavizLabelName("NAME")},addDefaultDatavizLabelName:function(e){var t={label:{name:(new s).propertyName(e)}},i=(new n).propertyName(e).isNotNull().and((new n).propertyName(e).isNotEqualTo("")),r=new a(null,i,t);r.addOverIds("3DXCityDefaultLabelName"),this.defaultRendering.addOver(r)},getDefaultRendering:function(){return Object.assign({},this._parent(),{label:{enable:!1,name:"",styleName:"default",position:{mode:"billboard",rotation:new r.Vector3(0,0,0),geometryOffset:new r.Vector3(0,0,1),labelOffset:new r.Vector2(0,.5),offset:new r.Vector3(0,0,0),enableAutomaticFlip:!1,isAligned:!1,isRepeated:!1},style:this._getPresetLabelStyle("default")}})},shouldRebuild:function(e,t){return JSON.stringify(t.renderingData.label)!==JSON.stringify(e.renderingData.label)},updatePresetValues:function(e){if(e=this._parent(e),t.is(e)&&t.is(e.label)&&t.is(e.label.styleName)){var i=this._getPresetLabelStyle(e.label.styleName);t.is(i)&&(e.label.style=i)}else t.is(e)&&t.is(e.label)&&t.is(e.label.style)&&this.isChangingCurrentMaterial(e.label.style,this.getRenderingValues().label.style)&&(e.label.styleName="custom");return e},_getPresetLabelStyle:function(e){var t={"background-color":"transparent",border:"medium none color","border-bottom":"medium none color","border-left":"medium none color","border-radius":"0px","border-right":"medium none color","border-top":"medium none color",color:"#FFFFFF","font-family":"Arial","font-size":"12px","font-style":"normal","font-weight":"bold","letter-spacing":"0.5px","line-height":"124%",opacity:"1",padding:"3px 7px","text-align":"left","text-decoration":"none currentcolor solid","text-shadow":"","word-spacing":"normal"};switch(e){case"default":t.color="#ffffff",t["text-shadow"]="-1px -1px 0 rgb(0,0,0), 1px -1px 0 rgb(0,0,0), -1px 1px 0 rgb(0,0,0), 1px 1px 0 rgb(0,0,0), 0 -1px 0 rgb(0,0,0), 0 1px 0 rgb(0,0,0), 1px 0 0 rgb(0,0,0), -1px 0 0 rgb(0,0,0)";break;case"dark":t.color="#3d3d3d",t["text-shadow"]="-1px -1px 0 rgb(255,255,255), 1px -1px 0 rgb(255,255,255), -1px 1px 0 rgb(255,255,255), 1px 1px 0 rgb(255,255,255), 0 -1px 0 rgb(255,255,255), 0 1px 0 rgb(255,255,255), 1px 0 0 rgb(255,255,255), -1px 0 0 rgb(255,255,255)";break;case"basic":t.color="#3d3d3d",t["font-weight"]="normal",t["background-color"]="#ffffff",t.border="solid 1px rgb(61,61,61)",t["border-radius"]="10px";break;case"blue":t["font-family"]="Arial",t.color="#ffffff",t["font-weight"]="normal",t["background-color"]="#005686",t.border="solid 1px  rgb(0,60,90)",t["border-radius"]="10px";break;default:return}return t}})}),define("DS/XCityRendering/RenderingHandlerAltitude",["DS/XCityTools/ShaderTools","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerLabel"],function(e,t,i){"use strict";return i.extend({init:function(e,t,i){this._parent(e,t,i)},getDefaultRendering:function(){return Object.assign({},this._parent(),{elevation:0,elevationOffset:0,elevationMode:"geometry"})},shouldRebuild:function(e,i){if(this._parent(e,i))return!0;var r=i.renderingData.elevation,s=e.renderingData.elevation;if(r!==s)return!0;if((r=i.renderingData.elevationOffset)!==(s=e.renderingData.elevationOffset))return!0;if((r=i.renderingData.elevationMode)!==(s=e.renderingData.elevationMode))return!0;if(i.hasDatavizOnAttribute("elevation"))return!0;let n=i.hasDatavizOnAttribute("elevationOffset")+e.hasDatavizOnAttribute("elevationOffset"),a=i.getDatavizImpactingAttribute("elevationOffset"),o=e.getDatavizImpactingAttribute("elevationOffset");return 2==n&&!t.simpleJSONCompare(a,o)||1==n},getRenderModeFromMesh:function(e){if(e.userData)return e.userData.CityRenderMode},setRenderModeToMesh:function(e,t){e.userData||(e.userData={}),e.userData.CityRenderMode=t}})}),define("DS/XCityRendering/RenderingHandlerLine",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/Plugins/RenderPass","DS/XCityRendering/RenderingHandlerAltitude","DS/xCityBasicUtils/ColorGradient","DS/XCityTools/Pooler","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s,n,a,o,l){"use strict";var h=n.extend({init:function(e,i,r){this._parent(e,i,r);var s={ElementRendering:[{ElementIds:this._allIds,ElementMaterial:{lineWidth:10}}]};this.defaultRendering.addOver(s),this.lineMesh=[],t.is(i)||(i={}),this._defineRenderPass(),this.type="Line",this._pdsfxMaterial={},this._poolMaterial={},this.nbLabelNode=0},attachLabelRendering:function(e){this.renderingHandlerLineLabels=e},updateRenderingLineLabel:function(e){if(t.is(this.renderingHandlerLineLabels))for(var i in this.renderingHandlerLineLabels)this.renderingHandlerLineLabels.hasOwnProperty(i)&&this.renderingHandlerLineLabels[i].updateRendering(e)},updateRendering:function(e){e.addOver(e.getStrokeFeatureRendering()),this._parent(e),this.updateDashPatterns(),this.updateRenderingLineLabel(e)},updateDashPatterns:function(){var e=this._getAllFixedValuesForAttribute("dashPattern");this.resetDashPatterns(e)},getHashFromPattern:function(e){var i;if(t.is(e)){var r,s=Object.keys(e),n=s.length;for(i="",r=0;r<n;r++)r>0&&(i+="_"),i+=e[s[r]]}return i},getIndexFromPattern:function(e){var i,r=this.getHashFromPattern(e);t.is(r)&&t.is(this.dashPatterns)&&(i=this.dashPatterns[r].startIndex);return i},resetDashPatterns:function(e){if(this.dashPatterns={length:0},this.dashPatternLayer=void 0,t.is(e)&&t.is(e.length)){var i,r,s,n,a=0,o=e.length,l=Object.keys(e);for(i=0;i<o;i++)s=e[r=l[i]].value.slice(),n=this.getHashFromPattern(s),t.is(n)&&(t.is(this.dashPatterns[n])||(this.dashPatterns[n]={index:this.dashPatterns.length,startIndex:a,pattern:s,isPrimitive:e[r].isPrimitive},this.dashPatterns.length++,a+=s.length),!1===e[r].isPrimitive&&(this.dashPatternLayer=s))}this.refreshConcatenatedDashPatterns=!0},getConcatenatedDashedPatterns:function(){if(this.refreshConcatenatedDashPatterns){if(this.dashedPatternConcatenated=[],t.is(this.dashPatterns)){var e=this.dashPatterns.length;if(e>0){var i,r,s,n,a,o,l=Object.keys(this.dashPatterns);for(i=0;i<e+1;i++)if("length"!==(s=l[i]))for(n=(o=(a=this.dashPatterns[s]).pattern).length,r=0;r<n;r++)this.dashedPatternConcatenated[a.startIndex+r]=o[r]}}this.refreshConcatenatedDashPatterns=!1}return this.dashedPatternConcatenated},getDefaultRendering:function(){var t=Object.assign({},this._parent(),{ambient:new a(new e.Color("#000000")),diffuse:new a(new e.Color("#000000")),color:new a(new e.Color("#000000")),renderMode:"dual",alphaTest:.01,opacityFactor:.3,minOpacity:.1,minDist:1e3,elevationOffset:1,maxDist:2e3,lineWidth:4,minWidth:4,dynamicUpdate:!1,animation:null,dashPattern:null,linecap:"square"});return this._defaultStrokeParameters={enable:!1,opacityFactor:.3,minOpacity:.1,minDist:1e3,elevationOffset:1,maxDist:2e3,lineWidth:4,minWidth:4,dynamicUpdate:!1,animation:{},ambient:new a(new e.Color("#000000")),diffuse:new a(new e.Color("#000000")),color:new a(new e.Color("#000000")),opacity:1,dashPattern:null},t.stroke=this._defaultStrokeParameters,t},addStrokeInfo:function(e){let i=t.cloneRecKeepingClasses(e);return i.stroke=t.cloneRecKeepingClasses(e),i},addStrokeInfoToBaseLevel:function(e){let i=t.cloneRecKeepingClasses(e.stroke),r=t.cloneRecKeepingClasses(e);return r=Object.assign(r,i)},dupplicateStrokeInfo:function(e){return t.is(e)&&(e=t.is(e.stroke)?this.addStrokeInfoToBaseLevel(e):this.addStrokeInfo(e)),e},getDependantAttributes:function(e){let t=this._parent(e),i=[];for(let e=0;e<t.length;e++){const r=t[e];let s="";r&&(r.startsWith("stroke.")?(s=r.substr("stroke.".length),i.push(s),i.push(r)):(s="stroke."+r,i.push(r),i.push(s)))}return i},updatePresetValues:function(e){return e=this._parent(e),this.dupplicateStrokeInfo(e)},_applyPolygonOffset:function(e,i){t.is(e)&&t.is(i)&&(e.polygonOffset=!0,e.polygonOffsetFactor=i.x,e.polygonOffsetUnits=i.y)},_initMaterial:function(){var e,s,n=[],a=this.getCompleteMaterialInfo(),o=this._getShaderType();this._shaderType=o;var l=a;if("dashed"===o){var d=this.getConcatenatedDashedPatterns();t.is(d)&&d.length>0&&(l=Object.assign({},a,{dashPattern:d}))}(e=h.shaderLine[o](l)).isWideLine=!0,e.setPDSFXPolygonOffset("Frontward1"),e.linecap=a.linecap,e._shaderType=o,e.transparent=l.opacity<1,n=[e],r._setMaterialFromProfile(e,l),i.updateCommonUniforms(e),e.updateDeferredMaterials();for(var u=1;u<e._deferredMaterials.length;u++){var c=e._deferredMaterials[u];t.is(c)&&(c.needsUpdate=!0)}if("dual"===a.renderMode){(s=h.shaderLine[o](l)).isWideLine=!0,s.setPDSFXPolygonOffset("Frontward1"),s._shaderType=o,s.transparent=l.opacity<1||l.opacityFactor<1,n.push(s),r._setMaterialFromProfile(s,l),i.updateCommonUniforms(s),s.updateDeferredMaterials();for(u=1;u<s._deferredMaterials.length;u++){var p=s._deferredMaterials[u];t.is(p)&&(p.needsUpdate=!0)}}return n},applyRendering:function(e){this.isMeshToConsider(e)&&this.applyRenderingToMesh(e)},isMeshToConsider:function(e){return!(!e||!e.lineBuilder)},linesName:{occluded:"occluded",overlay:"overlay"},updateMaterialTextureInfo:function(e,i){t.is(e.uniforms)&&t.is(e.uniforms.l_uInfoTexture)?e.uniforms.l_uInfoTexture.value=i:e.isPDSFX&&e.updatePDSFXUniform("l_uInfoTexture",i)},initMeshes:function(e,t){var r=[e],s=this.getCompleteMaterialInfo().renderMode;this._renderMode=s;var n=this._getMaterial(r[0]._cityMaterial);return r[0]._cityMaterial=n,s===this.linesName.occluded||s===this.linesName.overlay?(this.setMaterialToMesh(r[0],n[0]),r[0].name="line_"+s+"_pass_0",r[0].mesh3js.name="line_"+s+"_pass_0",this.setRenderModeToMesh(r[0],s),r[0]._shaderType=this._getShaderType(),t&&(n[0].transparent=!0),this._setRenderPasses(r[0],s),n[0].updatePDSFXUniform("l_uUseOpacityFactor",0),n[0].useOpacityFactor=!1,this.updateMaterialTextureInfo(n[0],r[0].textureInfo.texture),i.updateCommonUniforms(n[0]),this.applyElementRendering(r[0])):(this.setMaterialToMesh(r[0],n[0]),r[0].name="line_occluded_pass_0",r[0].mesh3js.name="line_occluded_pass_0",this.setRenderModeToMesh(r[0],s),r[0]._shaderType=this._getShaderType(),this._setRenderPasses(r[0],"occluded"),this.updateMaterialTextureInfo(n[0],e.textureInfo.texture),i.updateCommonUniforms(n[0]),this.applyElementRendering(r[0]),r.push(r[0].clone()),r[1].setRendering=r[0].setRendering,r[1].resetFlags=r[0].resetFlags,r[1].setAttribute=r[0].setAttribute,r[1].get=r[0].get,this.setMaterialToMesh(r[1],n[1]),r[1].name="line_overlay_pass_1",r[1].mesh3js.name="line_overlay_pass_1",r[1].textureInfo=e.textureInfo,this._setRenderPasses(r[1],"overlay"),n[0].updatePDSFXUniform("l_uUseOpacityFactor",0),n[1].updatePDSFXUniform("l_uUseOpacityFactor",1),n[0].useOpacityFactor=!1,n[1].useOpacityFactor=!0,t&&(n[0].transparent=!0,n[1].transparent=!0),this.updateMaterialTextureInfo(n[1],e.textureInfo.texture),i.updateCommonUniforms(n[1]),this.applyElementRendering(r[1])),r},_refreshMaterial:function(e){var t=this._getMaterial();e.name.indexOf("pass_0")>-1?(e.setMaterial(t[0]),this.updateMaterialTextureInfo(t[0],e.textureInfo.texture),i.updateCommonUniforms(t[0]),this.applyElementRendering(e)):e.name.indexOf("pass_1")>-1&&(e.setMaterial(t[1]),this.updateMaterialTextureInfo(t[1],e.textureInfo.texture),i.updateCommonUniforms(t[1]),this.applyElementRendering(e))},shouldRebuild:function(e,i){if(this._parent(e,i))return!0;var r=e.getRenderingData(),s=i.getRenderingData();if(t.is(r.linecap)){if(!t.is(s.linecap))return!0;if(s.linecap!==r.linecap)return!0}else if(t.is(s.linecap))return!0;var n=s.geometricMode,a=r.geometricMode;if(n!==a){var o={stroke:{enable:!1}};return"extruded"===n?this.defaultRendering.addOver(o):"line"===n?(o.stroke.enable=!0,this.defaultRendering.addOver(o)):this.defaultRendering.addOver(o),!0}return"extruded"===n&&(n=s.extrusionHeight,(a=r.extrusionHeight)!==n)},_defineRenderPass:function(){var e;this._lineOccludedPassID="main",this._lineOverlayPassID="LineOverlayPass",this.urban&&void 0===this.urban.getView3D().getRenderPassManager().getPass(this._lineOverlayPassID)&&((e=new s(null,null,void 0,!0,!1,!1,this._lineOverlayPassID)).idString=this._lineOverlayPassID,this.urban.getView3D().getRenderPassManager().addPass(this._lineOverlayPassID,e,{after:"ClearDepthPass"}))},_getShaderType:function(){var e=this.getCompleteMaterialInfo(),i=e&&t.is(e.animation)&&!0===e.animation.enable?"dynamic":"static";if("static"===i){var r=this.getConcatenatedDashedPatterns();t.is(r)&&r.length>0&&(Object.assign({},e,{dashPattern:r}),i="dashed")}return i},setMaterialToMesh:function(e,t){var i=e.getMaterial();i&&i._globePool&&i.id!==t.id&&i._globePool.recycle(i),e.setMaterial(t),this._lastSeenMaterial=t},_getMaterialInfo:function(){var e=this._parent(),i=this.getConcatenatedDashedPatterns();return t.is(i)&&i.length>0&&(e.dashPattern=i),e.dashPatternLayer=this.dashPatternLayer,e},_getMaterial:function(e){var t=this._getMaterialInfo();return(!e||this._getShaderType()!==e[0]._shaderType||t.renderMode!==e[0].renderMode||e[0].dashPattern&&t.dashPattern.length!==e[0].dashPattern.length)&&(e=this._initMaterial()),r._setMaterialFromProfile(e[0],this.defaultMaterial),r._setMaterialFromProfile(e[0],t),r._setMaterialMapFromProfile(e[0],t,this),i.updateCommonUniforms(e[0]),e[0].updatePDSFXUniform("l_uUseOpacityFactor",0),e[0].useOpacityFactor=!1,e[0].transparent=e[0].opacity<1,e[0].dashPatternLayer=t.dashPatternLayer,2===e.length&&(r._setMaterialFromProfile(e[1],this.defaultMaterial),r._setMaterialFromProfile(e[1],t),r._setMaterialMapFromProfile(e[1],t,this),i.updateCommonUniforms(e[1]),e[1].updatePDSFXUniform("l_uUseOpacityFactor",1),e[1].useOpacityFactor=!0,e[1].transparent=e[1].opacity<1||e[1].opacityFactor<1,e[1].dashPatternLayer=t.dashPatternLayer),e},initMesh:function(e){if(t.is(e)&&e.children.length>0){var i=null,r=this.getRenderModeFromMesh(e.children[0]);if(r!==this._getMaterialInfo().renderMode){var s=e.lineBuilder._rootNode,n="dual"===r,a=this.initMeshes(e.children[0]);if(this.nbLabelNode>0&&a.push(s.children[s.children.length-1]),n){var o=e.children[1].getMaterial();o._globePool&&o._globePool.recycle(o)}s.removeChildren();for(var h=0;h<a.length;++h)a[h].lineBuilder=e.lineBuilder,s.addChild(a[h]);i=a[0]._cityMaterial}else if(e.children[0]._cityMaterial&&(i=e.children[0]._cityMaterial),i=this._getMaterial(i),e.children[0]._cityMaterial=i,e.children[0].getMaterial().id!==i[0].id)for(h=0;h<e.children.length-this.nbLabelNode;++h)this.setMaterialToMesh(e.children[h],i[h]),e.children[h]._shaderType=this._shaderType;for(var d in{opacityFactor:"_setOpacityFactor",lineWidth:"_setLineWidth",dashPatternLayer:"_setDashPatternIndex",minOpacity:"_setMinOpacity"})e.children[0].setAttribute(d,i[0][d]);if(t.is(i[0].animation)&&!0===i[0].animation.enable){void 0===e.lineBuilder.tokenUpdateEvent&&(i[0].transparent=!0,"dual"===e.children[0]._renderType&&(i[1].transparent=!0),e.lineBuilder.clockTime=0,e.lineBuilder.tokenUpdateEvent=l.subscribeTo("/3DEXPERIENCity/onUpdate",e.lineBuilder._update.bind(e.lineBuilder)));for(var d in{minOpacity:"_setMinOpacity",speed:"_setSpeed",samplingRate:"_setSamplingRate",nbPoint:"_setNbPoints",dashSize:"_setDashSize",gapSize:"_setGapSize",reverse:"_setReverse",loop:"_setLoop"})void 0!==i[0].animation[d]&&null!==i[0].animation[d]&&e.children[0].setAttribute(d,i[0].animation[d])}else void 0!==e.lineBuilder.tokenUpdateEvent&&(l.unsubscribe(e.lineBuilder.tokenUpdateEvent),e.lineBuilder.tokenUpdateEvent=void 0);this.updateMaterialTextureInfo(i[0],e.children[0].textureInfo.texture),2===i.length&&this.updateMaterialTextureInfo(i[1],e.children[0].textureInfo.texture)}},setAttribute:function(e,t){this[h.attributeSetter[e]](t)},_setRenderPasses:function(e,t){var i={occluded:this._lineOccludedPassID,overlay:this._lineOverlayPassID};e.setRenderPasses([i[t]])},applyPrimitiveRenderingToMesh:function(e){if(e){var t,i=e.children.length;for(t=0;t<i;t++)this.applyElementRendering(e.children[t])}}});return h._pdsfxMaterial={},h._poolMaterial={},h.shaderLine={dynamic:function(){return void 0===h._poolMaterial.dynamic&&(h._pdsfxMaterial.dynamic=i.getPDSFXMaterial([h.dynamicLine_PDSFX],"line"),h._poolMaterial.dynamic=new o(h._pdsfxMaterial.dynamic.clone.bind(h._pdsfxMaterial.dynamic)),h._poolMaterial.dynamic.name="line_dynamic_pool"),h._poolMaterial.dynamic.use()},static:function(){return void 0===h._poolMaterial.static&&(h._pdsfxMaterial.static=i.getPDSFXMaterial([h.line_PDSFX],"line"),h._poolMaterial.static=new o(h._pdsfxMaterial.static.clone.bind(h._pdsfxMaterial.static)),h._poolMaterial.static.name="line_static_pool"),h._poolMaterial.static.use()},dashed:function(e){var t=e.dashPattern.length;if(void 0===h._poolMaterial["dashed_"+t]){Object.assign({isDashedLine:!0,isCPUPattern:!0,scale:1},e);h.dashedLine_PDSFX.uniforms.dashPatternCity.length=t,h._pdsfxMaterial["dashed_"+t]=i.getPDSFXMaterial([h.dashedLine_PDSFX],"line"),h._poolMaterial["dashed_"+t]=new o(h._pdsfxMaterial["dashed_"+t].clone.bind(h._pdsfxMaterial["dashed_"+t])),h._poolMaterial["dashed_"+t].name="line_dashed_"+t+"_pool"}return h._poolMaterial["dashed_"+t].use()}},h.attributeSetter={wireframe:"",alphaTest:"",specular:"",ambient:"",depthTest:"",depthWrite:"",shininess:"",diffuse:"",side:"",elevation:"",elevationOffset:"",elevationMode:"",renderMode:""},h.getSettableAttributes=function(){var e,t=[];for(e in h.attributeSetter)h.attributeSetter.hasOwnProperty(e)&&t.push(e);return t},h.line_PDSFX={attributes:{blending:e.NormalBlending},uniforms:{l_uInfoTexture:{type:"t2",value:void 0},l_uUseOpacityFactor:{type:"f",value:0},opacityCity:{type:"f",value:1},diffuseCity:{type:"c",value:new e.Color(16711680)},ambientCity:{type:"c",value:new e.Color(16711680)},minDist:{type:"f",value:200},maxDist:{type:"f",value:2e3},minWidth:{type:"f",value:1},dynamicUpdate:{type:"b",value:!1}},varyings:{vInstanceColor:{type:"v4",value:new e.Vector4(1,1,1,1)},l_useColor:{type:"f",value:0},l_useOpacity:{type:"f",value:0},l_useLineWidth:{type:"f",value:0},l_visibility:{type:"f",value:0},l_vColor:{type:"v3",value:new e.Vector3(1,1,1)},l_fHalfWidth:{type:"f",value:0},l_vOpacity:{type:"f",value:0},l_vOpacityFactor:{type:"f",value:0},l_vMinOpacity:{type:"f",value:0}},VS_global_code:["float getFlag(float flags, float row){","    float res = mod(flags, row*2.0); ","    if(res >= row){","       return 1.0;","   }","   return 0.0; ","}","vec3 getColor(sampler2D texture, float nbColumn, float nbLines, float indice){","vec3 color = vec3(0,0,0);","color.r = texture2D( texture, vec2( 0.5/nbColumn, indice/nbLines ) ).x;","color.g = texture2D( texture, vec2( 1.5/nbColumn, indice/nbLines ) ).x;","color.b = texture2D( texture, vec2( 2.5/nbColumn, indice/nbLines ) ).x;","return color;","}"].join("\n"),VS_overridableFunctions:{ComputeCommonValues:["float l_fpixPerRow = texture2D( l_uInfoTexture, vec2( 0.0, 0.0 ) ).x;","float l_fnbLines = texture2D( l_uInfoTexture, vec2( 1.5/l_fpixPerRow, 0.0 ) ).x + 1.0;","float l_fscale = texture2D( l_uInfoTexture, vec2( 2.5/l_fpixPerRow, 0.0 ) ).x;","float l_findice = (vGetAttribColor().r + 1.5);","float l_useFlags = texture2D( l_uInfoTexture, vec2( 15.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_useColor = getFlag(l_useFlags, 1.0);","l_useOpacity = getFlag(l_useFlags, 2.0);","l_useLineWidth = getFlag(l_useFlags, 4.0);","l_fHalfWidth = texture2D( l_uInfoTexture, vec2( 3.5/l_fpixPerRow, l_findice/l_fnbLines) ).x *0.5;","l_vColor = getColor(l_uInfoTexture, l_fpixPerRow, l_fnbLines, l_findice);","l_vOpacity = texture2D( l_uInfoTexture, vec2( 4.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vOpacityFactor = texture2D( l_uInfoTexture, vec2( 5.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vMinOpacity = texture2D( l_uInfoTexture, vec2( 12.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","if (dynamicUpdate) {","vec4 mvPosition = vGetWorldViewMatrix() * vec4(vGetAttribPosition().xyz, 1.0);","float dist = length(mvPosition);","if ( dist < minDist ) { ","l_fHalfWidth = l_fHalfWidth;","l_vOpacity = l_vOpacity;","}","else if ( dist > maxDist ) {","l_fHalfWidth = minWidth/2.0;","l_vOpacity = l_vMinOpacity;","}","else {","float altitudeFactor = (1.0 - ((dist - minDist) / (maxDist - minDist)));","l_fHalfWidth = l_fHalfWidth * altitudeFactor + minWidth/2.0 * (1.0 - altitudeFactor);","l_vOpacity = max(l_vMinOpacity, l_vOpacity * altitudeFactor);","}","}",""].join("\n"),ComputeHalfWidth:["return l_fHalfWidth;"].join("\n")},FS_global_code:["vec4 _texelCity = vec4(1.0);","float _alphaCity = 1.0;","#define CITY_HACK_VERTEXCOLOR 1","//#define  CITY_HACK_ALPHATEST 1","vec3 colorInstance= vec3(1.0,1.0,1.0);","float opacityInstance = 1.0;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["colorInstance = diffuseCity.xyz;","if (l_useColor > 0.5) {","colorInstance = l_vColor.xyz;","}"," #ifdef GAMMA_INPUT","   colorInstance *= colorInstance;"," #endif","opacityInstance = opacityCity;","if (l_useOpacity > 0.5) {","opacityInstance = l_vOpacity;","}","if (l_uUseOpacityFactor > 0.5) {","opacityInstance *= l_vOpacityFactor;","}",""].join("\n"),ComputeHalfWidth:["return l_fHalfWidth;"].join("\n"),ComputeAlbedo:["cAlbedo = colorInstance;"].join("\n"),__ComputeDiffuseTexel:["return vec4(_texelCity.xyz, 1.0);"].join("\n"),ComputeOpacity:["cOpacity = opacityInstance;"].join("\n"),__ComputeDiscard:["if (_alphaCity < alphaTestCity || l_visibility > 0.5) {","return true;","}","return false;"].join("\n")}},h.dynamicLine_PDSFX={depends:[h.line_PDSFX],uniforms:{clockTime:{type:"f",value:0}},varyings:{l_vSpeed:{type:"f",value:0},l_vDashSize:{type:"f",value:0},l_vGapSize:{type:"f",value:0},l_vSamplingRate:{type:"f",value:0},l_vNbPoints:{type:"f",value:0},l_vOffset:{type:"f",value:0},l_vReverse:{type:"f",value:0},l_vMinOpacity:{type:"f",value:0},l_vLoop:{type:"f",value:0},lineInfo:{type:"v4",value:new e.Vector4(1,1,1,1)}},VS_overridableFunctions:{ComputeCommonValues:["l_vSpeed = texture2D( l_uInfoTexture, vec2( 6.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vNbPoints = texture2D( l_uInfoTexture, vec2( 7.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vOffset = texture2D( l_uInfoTexture, vec2( 8.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vReverse = texture2D( l_uInfoTexture, vec2( 9.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vDashSize = texture2D( l_uInfoTexture, vec2( 10.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vSamplingRate = texture2D( l_uInfoTexture, vec2( 11.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vMinOpacity = texture2D( l_uInfoTexture, vec2( 12.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vGapSize = texture2D( l_uInfoTexture, vec2( 13.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vLoop = texture2D( l_uInfoTexture, vec2( 14.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","lineInfo = vec4(vGetAttribColor(), 1.0);"].join("\n")},FS_global_code:["bool isDiscarded = false;","vec4 newColor = vec4(1.0);"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["float alpha = opacityInstance;","float minAlpha = l_vMinOpacity;","float speed = l_vSpeed;","float samplingRate = l_vSamplingRate;","float nbPoints = l_vNbPoints;","float coef = 0.0;","if (samplingRate == 0.0) {"," float startLength = l_vSpeed * clockTime;"," float endLength = max(0.0, startLength - l_vDashSize);"," if (l_vLoop < 0.5) {","   if (l_vReverse < 0.5 && lineInfo.z < startLength) {","     isDiscarded = true;","   }","   else if (l_vReverse > 0.5 && (lineInfo.y - lineInfo.z) < startLength ) {","     isDiscarded = true;","   }"," }"," float distLength = startLength - endLength;"," float divisor = lineInfo.y/nbPoints;"," if (l_vGapSize > 0.0) {","   divisor = (l_vDashSize + l_vGapSize);"," }"," startLength = mod(startLength, divisor);"," endLength = mod(endLength, divisor);"," float curPosition = lineInfo.z;"," if (l_vReverse > 0.5) {","   curPosition = lineInfo.y - curPosition;"," }"," float offsetLength = floor(curPosition / divisor) * divisor;"," float currentLength = curPosition - offsetLength;"," if (currentLength > (endLength) && currentLength < (startLength)) {","   coef = (startLength - currentLength) / distLength;"," } else if (currentLength > endLength && currentLength > startLength && endLength > startLength) {","   coef = 1.0 - ((currentLength - endLength) / distLength);"," } else if (currentLength > 0.0 && currentLength < startLength && startLength < endLength) {","   coef = (startLength - currentLength) / distLength;"," } else {","   coef = 1.0;"," }","}","else {"," float startTime = clockTime;"," float currentTime = lineInfo.w * samplingRate;","// Can't find a way to compute quickly an average speed per fragment..."," float averageSpeed = l_vSpeed; // lineInfo.y / (lineInfo.x * samplingRate);"," float endTime = startTime - l_vDashSize/averageSpeed;"," if (currentTime < endTime || currentTime > startTime) {","   if (minAlpha == 0.0) { ","     discard;","   } else {","     coef = 1.0;","   }"," } else {","   coef = (startTime - currentTime) / (startTime - endTime);"," }","}","newColor = vec4(colorInstance.xyz, (1.0-coef)*(alpha-minAlpha)+minAlpha);"].join("\n"),ComputeAlbedo:["cAlbedo = newColor.xyz;"].join("\n"),ComputeOpacity:["cOpacity = newColor.w;"].join("\n"),ComputeDiscard:["if (isDiscarded) {","return true;","}","return false;"].join("\n")}},h.dashedLine_PDSFX={depends:[h.line_PDSFX],attributes:{isDashedLine:!0,isCPUPattern:!0,scale:1},uniforms:{dashPatternCity:{type:"fv1",value:[0],length:1},scaleCity:{type:"f",value:1}},varyings:{patterntoUseStartIndexCity:{type:"f",value:0},totalSizeToUseCity:{type:"f",value:0}},VS_overridableFunctions:{ComputeCommonValues:["patterntoUseStartIndexCity = float(int(texture2D( l_uInfoTexture, vec2( 16.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x));","totalSizeToUseCity = float(int(texture2D( l_uInfoTexture, vec2( 17.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x));",""].join("\n")},FS_global_code:["#ifdef PATTERN_LENGTH","float _floatRound(in float decimal){ ","float low = floor(decimal);","float high = ceil(decimal);","float rest = decimal - low;","float res = high;","if (rest < 0.5 ) {","res = low;","}","return res;","}","vec3 _getPatternInfo(in float dist) {","int index = 0;","int startindex = int(_floatRound(patterntoUseStartIndexCity));","float prec = 0.0, cur = 0.0;","for (int i = 0; i < PATTERN_LENGTH; i++) {","if (i >= startindex) {","cur = max(scaleCity,1e-6)*dashPatternCity[i];","if (cur > dist) {","break;","}","prec = cur;","index++;","}","}","return vec3(float(index + startindex),prec,cur);","}","float _getPatternAlpha(in float dist) {","float length = _floatRound(totalSizeToUseCity);","length = max(scaleCity,1e-6) * length;","float mDist = mod( dist, length );","vec3 patternInfo = _getPatternInfo(mDist);","if (abs(mod(patternInfo.x,2.0)) < 0.5) {","return 0.0;","}","return 1.0;","}","#endif"].join("\n"),FS_overridableFunctions:{ProcessLinePattern:["","#ifdef PATTERN_LENGTH","patternValue = _getPatternAlpha(currentPixelDistance);","#endif",""].join("\n")}},h}),define("DS/XCityRendering/RenderingHandlerPOI3D",["DS/XCityRendering/RenderingHandlerAltitude","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/Visualization/ThreeJS_DS","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering","DS/XCityTools/TextureManager","DS/XCityRendering/FeatureRendering"],function(e,t,i,r,s,n,a,o){"use strict";return e.extend({init:function(e,t,i){this._parent(e,t,i),this.type="POI3D"},getDefaultRendering:function(){var e=UWA.clone(this._parent());return UWA.extend(e,{scale:new r.Vector3(1,1,1),renderMode:"overlay",opacityFactor:"0.3",alphaTest:.1,altitude:void 0,styleClass:"",label:{position:{geometryOffset:new r.Vector3(0,.5,0)}},shapeType:"pyramid",nbVertices:[15,15],switchDistance:0},!0),e},isMeshLeafSet:function(e){return!!(t.is(e)&&t.is(e.name)&&t.startsWith(e.name,"leafMeshCluster"))},isMeshClusterSet:function(e){return!!(t.is(e)&&t.is(e.name)&&t.startsWith(e.name,"rtreeMeshCluster"))},isMeshQTSet:function(e){return!!(t.is(e)&&t.is(e.name)&&t.startsWith(e.name,"qtcluster"))},updateMesh:function(e){if(t.is(e)){var i=e.parents[0];this.isMeshLeafSet(i)?this._leafSetRendering.initMesh(e):this.isMeshClusterSet(i)?this._clusterSetRendering.initMesh(e):this.isMeshQTSet(i)?this._qtClusterSetRendering.initMesh(e):t.is(e.name)&&t.startsWith(e.name,"text")||this.initMesh(e)}},initMesh:function(e){if(t.is(e)){var r=this._getMaterial(e.mesh3js.material);"PoiTransparentOverlayPass"===e.passes[0]&&"dual"===this.getCompleteMaterialInfo().renderMode&&(r.opacity=this.getCompleteMaterialInfo().opacity*this.getCompleteMaterialInfo().opacityFactor),"OverlayPostPass"===e.passes[0]&&(r.depthTest=!1),i.updateCommonUniforms(r),this.setMaterialToMesh(e,r),this._lastSeenMaterial=r}},applyRendering:function(e){if(t.is(e)){this._parent(e);var i,r,s,n,a=!0;if(e.children&&(s=e.children.length)>0)for(a=!1,i=0;i<s;i++)if(this.isMeshToConsider(e.children[i]))this.applyRenderingToMesh(e.children[i]);else for(n=e.children[i].children.length,r=0;r<n;++r)this.isMeshToConsider(e.children[i].children[r])&&(this.isMeshClusterSet(e.children[i])?this.applyFeatureRenderingToMesh(e.children[i].children[r]):this.applyRenderingToMesh(e.children[i].children[r]));a&&this.isMeshToConsider(e)&&this.applyRenderingToMesh(e)}},shouldRebuild:function(e,t){if(this._parent(e,t))return!0;var i,s,n,a,o=e.getRenderingData(),l=t.getRenderingData(),h=["altitude","height","styleClass","renderMode","shapeType","nbVertices","switchDistance"],d=h.length;for(i=0;i<d;i++){var u=h[i];if((s=l[u])!==(n=o[u])){a=!0;break}}if(!0===a)return!0;if(s=l.scale,n=o.scale,s instanceof r.Vector3&&n instanceof r.Vector3){if(!s.equals(n))return!0}else if(s!==n)return!0;var c=t.hasDatavizOnAttribute("scale");return!!c||!!(c=e.hasDatavizOnAttribute("scale"))},getFlagForPrimitive:function(e,i){var r=this._parent(e,i);if(e){var s=this.getPrimitiveRenderingValues(e,i);t.is(s.scale)&&(r+=4)}return r},addDefaultAltitudeFromAttributes:function(e,t,i){var r,a=(new s).propertyName(t);r="number"==typeof e?(new s).literal(e):(new s).propertyName(e);var o=a.toNumber(),l=r.toNumber();o.add(l);var h=new n(null,null,{elevation:o});h.addOverIds("3DXCityDefaultIDdefaultElevationAttributePoi3d"),this.defaultRendering.addOver(h)},updateRendering:function(e){this._parent(e),this.updateOtherRenderings(e)},updateOtherRenderings:function(e){t.is(this._leafSetRendering)&&this._leafSetRendering.updateRendering(e);var i=new o(e);if(i.remove("mapUrl"),i.remove("shapeType"),t.is(this._clusterSetRendering)){var r=new o;r.copy(i),delete r.datavizRenderings,this._clusterSetRendering.updateRendering(r)}t.is(this._qtClusterSetRendering)&&this._qtClusterSetRendering.updateRendering(i)},setClusterSetRendering:function(e){this._clusterSetRendering=e,this.updateOtherRenderings(this.currentRendering)},setLeafSetRendering:function(e){this._leafSetRendering=e,this.updateOtherRenderings(this.currentRendering)},setQtClusterSetRendering:function(e){this._qtClusterSetRendering=e,this.updateOtherRenderings(this.currentRendering)},useDatavizMappingOptim(e){var i=this._parent(e);return i=i&&t.is(e.mesh3js.instanceAttribArrays.instanceMatrix)}})}),define("DS/XCityRendering/RenderingHandlerElement",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityRendering/RenderingHandlerAltitude","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering"],function(e,t,i,r,s,n){"use strict";var a=r.extend({init:function(e,t,i){this._parent(e,t,i),this.instancing=!1,this.type="Element",this._subRenderingHandler=void 0},setInstancing:function(e){this.instancing=e},getDefaultRendering:function(){return Object.assign({},this._parent())},_initMaterial:function(){return t.is(this._material)||(this._baseMaterial?this._material=i.setPDSFXMaterial(this._baseMaterial,[a._element_PDSFX],"physical"):this._material=i.getPDSFXMaterial([a._element_PDSFX],"physical")),this._material},hasAttribute:function(e){if(t.is(this.defaultRendering)&&void 0!==this.defaultRendering.get(e))return!0;if(this._subRenderingHandler){for(var i=!1,r=0;r<this._subRenderingHandler.length;++r)i=i||this._subRenderingHandler[r].hasAttribute(e);return i}return!1},copyMaterial:function(e){this._baseMaterial||(this._baseMaterial=e)},addToDefaultMaterial:function(e){this.defaultRendering.addOver(e)},addDefaultAltitudeFromAttributes:function(e,i){if(t.is(e))this.defaultRendering.set("elevation",e);else{var r=(new s).propertyName(i),a=new n(null,null,{elevation:r});a.addOverIds("3DXCityDefaultIDdefaultElevationAttributeElement"),this.defaultRendering.addOver(a)}},applyRendering:function(e){if(this._parent(e),this._subRenderingHandler&&e&&e.children)for(var t=0;t<this._subRenderingHandler.length;++t)for(var i=0;i<e.children.length;++i)e.children[i].indexMesh===t&&this._subRenderingHandler[t].applyRendering(e.children[i])},updateMesh:function(e){if(t.is(e)){e.parents[0];this._subRenderingHandler&&e.indexMesh>-1&&e.indexMesh<this._subRenderingHandler.length?this._subRenderingHandler[e.indexMesh].initMesh(e):this.initMesh(e)}},updateRendering:function(e){this._parent(e),this.updateOtherRenderings(e)},updateOtherRenderings:function(e){if(this._subRenderingHandler)for(var t=0;t<this._subRenderingHandler.length;++t)this._subRenderingHandler[t].updateRendering(e)},addSubRenderingHandler:function(e,t){this._subRenderingHandler||(this._subRenderingHandler=[]),this._subRenderingHandler.push(e),e.defaultRendering.addOver(this.defaultRendering),e.updateRendering(this.currentRendering)}});return a._element_PDSFX={attributes:{___transparent:!0},uniforms:{mapCity:{type:"t2",value:i.whiteMap},useMapCity:{type:"b",value:!1},mapCityLoaded:{type:"b",value:!0},diffuseCity:{type:"c",value:new e.Color(16711680)},opacityCity:{type:"f",value:1},alphaTestCity:{type:"f",value:.5}},varyings:{vInstanceColor:{type:"v4",value:new e.Vector4(1,1,1,1)},l_useColor:{type:"f",value:0},l_useOpacity:{type:"f",value:0},l_visibility:{type:"f",value:0}},VS_global_code:["float getFlag(float flags, float row){","    float res = mod(flags, row*2.0); ","    if(res >= row){","       return 1.0;","   }","   return 0.0; ","}"].join("\n"),VS_overridableFunctions:{ComputeVaryingValues:["vInstanceColor = instanceColor;","float flags = instanceFlag;","l_useColor = getFlag(flags, 1.0);","l_useOpacity = getFlag(flags, 2.0);","l_visibility = getFlag(flags, 4.0);",""].join("\n"),ComputeObjectPosition:["vec3 instancePosition = vGetAttribPosition();","vec4 newPosition = instanceMatrix * vec4(instancePosition,1.0);","return newPosition.xyz/newPosition.w;"].join("\n"),ComputeObjectNormal:["vec4 norm = instanceMatrix * vec4(vGetAttribNormal(),0.0);","return normalize(norm).xyz;"].join("\n")},FS_global_code:["vec4 _texelCity = vec4(1.0);","float _alphaCity = 1.0;","vec3 colorInstance= vec3(1.0,1.0,1.0);","float opacityInstance = 0.0;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["if (useMapCity) {","_texelCity = texture2D(mapCity, vGetTexCoord0().xy);","_alphaCity = _texelCity.w;","}","colorInstance = diffuseCity;","if (l_useColor > 0.5) {","colorInstance = vInstanceColor.xyz;","}","opacityInstance = opacityCity;","if (l_useOpacity > 0.5) {","opacityInstance = vInstanceColor.w;","}",""].join("\n"),ComputeAlbedo:["return colorInstance*_texelCity.xyz;"].join("\n"),ComputeOpacity:["if (l_useOpacity < 0.5) {","return _DSopacity_;","}","else {","return _DSopacity_*vInstanceColor.w/opacityCity;","}"].join("\n"),ComputeDiscard:["if (_alphaCity < alphaTestCity || l_visibility > 0.5) {","return true;","}","return false;"].join("\n")}},a}),define("DS/XCityRendering/RenderingHandlerModel",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/RenderingTools","DS/XCityRendering/RenderingHandlerAltitude","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering"],function(e,t,i,r,s,n){"use strict";return r.extend({init:function(e){this._parent(e),this._waitingList=[],this.type="Model"},getDefaultRendering:function(){return Object.assign({},this._parent(),{scale:new e.Vector3(0,0,0)})},addDefaultAltitudeFromAttributes:function(e){var t=(new s).propertyName(e).toNumber(),i=new n(null,null,{elevation:t});i.addOverIds("3DXCityDefaultIDdefaultElevationAttributeModel"),this.defaultRendering.addOver(i)},addDefaultScaleFromAttributes:function(e){var t=(new s).propertyName(e).toNumber(),i=new n(null,null,{scale:t});i.addOverIds("3DXCityDefaultIDdefaultScaleAttributeModel"),this.defaultRendering.addOver(i)},shouldRebuild:function(e,t){return!!this._parent(e,t)||!(!t.renderingData.scale||e.renderingData.scale&&t.renderingData.scale.equals(e.renderingData.scale))}})}),define("DS/XCityGeometry/LineBuilder",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityGeometry/Line","DS/XCityRendering/RenderingHandlerLine","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityTools/TextureTools","DS/XCityTools/Debug","DS/XCityTools/ShaderTools","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils","DS/XCityLayer/Vector"],function(e,t,i,r,s,n,a,o,l,h,d,u){"use strict";var c=e.extend({init:function(e,t,s){this.urban=e,this.nbLines=0,this.nbInfoPix=Object.keys(i.BUFFER_IMAGE).length,this.creators=this._createElements(),this._rendering=void 0===t?new r(e,s):t;var n=this._rendering.getCompleteMaterialInfo(),a=(n.dynamicUpdate,n.animation);d.is(a)&&!0===a.enable&&(this.clockTime=0,this.tokenUpdateEvent=h.subscribeTo("/3DEXPERIENCity/onUpdate",this._update.bind(this)))},dispose:function(){o.warn("Dispose: LINE BUILDER"),this.tokenUpdateEvent&&h.unsubscribe(this.tokenUpdateEvent)},_update:function(e){if(this.clockTime+=e.clockDelta,void 0!==this._rootNode){h.publish("/xCity/needRender",this);for(var t=0;t<this._rootNode.children.length;++t){var i=this._rootNode.children[t].material;d.is(i)&&i.getPDSFXUniform("clockTime")&&i.updatePDSFXUniform("clockTime",this.clockTime)}}},_updateOnDistance:function(){if(void 0!==this._lineSet){var e,t,i,r=Object.keys(this._lineSet),s=r.length;for(e=0;e<s;e++){t=r[e];var n=this._lineSet[t];for(i=0;i<n.length;i++){n[i]._updateOnDistance()}}}},getData:function(e,t,i,r){if(r){this.creators.textureInfo=r.textureInfoCreator;var n=new s({indexed:!0,useNormal:!1,useColor:!0,useTexCoord:!1});Object.assign(n,r.lineCreator);for(var o=0;o<n.primitiveList.length;o++){var l=n.primitiveList[o];l.attr.fill.isEqual=function(e){return!0},l.attr.line.isEqual=function(e){return!0},l.attr.point.isEqual=function(e){return!0}}this.creators.lineMesh=n}this.creators.textureInfo.texture=a.createTexture(this.creators.textureInfo),this._lineSet=e,this._refMesh=this._compileMesh(this.creators.lineMesh,this.creators.textureInfo,"CBN5_LINE",e);var h=this._rendering.initMeshes(this._refMesh,i);this._rootNode=t;for(o=0;o<h.length;++o)h[o].lineBuilder=this,t.addChild(h[o]);return t.lineBuilder=this,h},setDynamicUpdate:function(e){},_updateUniform(e,t){if(this._rootNode)for(var i,r=0;r<this._rootNode.children.length;++r)(i=this._rootNode.children[r].material)&&i.updatePDSFXUniform(e,t)},setDynamicUpdate:function(e){this._updateUniform("dynamicUpdate",e)},setMinDist:function(e){this._updateUniform("minDist",e)},setMaxDist:function(e){this._updateUniform("maxDist",e)},setMinWidth:function(e){this._updateUniform("minWidth",e)},setRenderMode:function(e){this._rendering._renderMode},setAnimation:function(e,t){var i;if(d.is(e)&&!0===e.enable){if(void 0===this.tokenUpdateEvent){for(i=0;i<t.children.length;++i)this._rendering._refreshMaterial(t.children[i]);this.clockTime=0,this.tokenUpdateEvent=h.subscribeTo("/3DEXPERIENCity/onUpdate",this._update.bind(this))}if(t.children.length>0){var r,s=Object.keys(e),n=s.length;for(i=0;i<n;i++)r=s[i],t.children[0].setAttribute(r,e[r])}}else if(void 0!==this.tokenUpdateEvent){for(i=0;i<t.children.length;++i)this._rendering._refreshMaterial(t.children[i]);h.unsubscribe(this.tokenUpdateEvent),this.tokenUpdateEvent=void 0}},_prepareWebWorkerLine:function(e){this._isWebWorkerLine(e)&&(e._rendering.getIndexFromPatternn||(e._rendering=this._rendering),e.setRendering||Object.setPrototypeOf(e,i.prototype))},_isWebWorkerLine:function(e){return e&&e.isWebWorkerLine},_compileMesh:function(e,t,s,a){var l=e.compilePrimitive(s,!1),h=n.createMeshNode(l);h.name=s,h.mesh3js.name=s,h._rendering=this._rendering,h.textureInfo={texture:t.texture,idMap:t.idMap};var u=this;return h.setAttribute=function(e,t,s){var n,l,h,p;if(i.attributeSetter[e]){var f;if(void 0!==s)for(n=0;n<s.length;++n)if(h=a[s[n].getCgmId()],d.is(h))for(l=0;l<h.length;l++)p=h[l],u._prepareWebWorkerLine(p),f=p.setFlaggedAttribute(e,t,s[n]);else o.warn("lineManipulators[pList["+n+"].getCgmId() is undefined");else{var m,g=Object.keys(a),v=g.length;for(n=0;n<v;n++)for(m=g[n],h=a[m],l=0;l<h.length;l++)p=h[l],u._prepareWebWorkerLine(p),p.setAttribute(e,t,void 0)}return f}return r.attributeSetter[e]?this._rendering.setAttribute(e,t):c.attributeSetter[e]?this.lineBuilder.setAttribute(e,t):void 0},h.get=function(e,t){var i=a[t[0].getCgmId()];if(d.is(i))return i[0][e]},h.resetFlags=function(e,t){var i,r,s,n;if(void 0!==e)for(i=0;i<e.length;++i)if(s=a[t],d.is(s))for(r=0;r<s.length;r++)n=s[r],u._prepareWebWorkerLine(n),n._setFlags(0)},h.setRendering=function(e,t,i){if(this.resetFlags([t],i),d.is(e))for(var r=Object.keys(e),s=r.length,n=[t],a=0;a<s;a++){var o=r[a],l=e[o];d.is(l)&&this.setAttribute(o,l,n)}},h},buildOne:function(e,t,r,s,n){var a;"string"==typeof e?a=e:(a=e.strid,this._initBSphereAndPosSize(e,t)),void 0!==s&&!0===s&&(a=a.concat("_"+this.nbLines));var o=this.nbLines,l=this.creators.textureInfo;d.is(l.idMap[a])&&(o=l.idMap[a]-1);var h=new i(this.urban,{id:a,numLine:o,creators:this.creators,geom:t,rendering:this._rendering,coordinates:r,attributes:n});return this.nbLines+=1,this._updatesInfoTextures(a,n,h),h},_initBSphereAndPosSize:function(e,i){for(var r={minX:99999999,minY:99999999,maxX:-99999999,maxY:-99999999},s=new t.Sphere,n=0;n<i.getNumGeometries();++n){u.getVerticesAsArrayOfLines(i,n).forEach(function(e){r.minX=Math.min(e.x,r.minX),r.minY=Math.min(e.y,r.minY),r.maxX=Math.max(e.x,r.maxX),r.maxY=Math.max(e.y,r.maxY)})}return s.radius=Math.sqrt(Math.pow(r.maxX-r.minX,2)+Math.pow(r.maxY-r.minY,2))/2,s.center.x=(r.minX+r.maxX)/2,s.center.y=(r.minY+r.maxY)/2,s.center.z=0,e.bSphere=s,e.posSize.width=r.maxY-r.minY,e.posSize.length=r.maxX-r.minX,e},_updatesInfoTextures:function(e,t,i){var r=this._rendering.getRenderingValues(e,t),s=this._rendering.getPrimitiveRenderingValues(e,t),n=this.creators.textureInfo,a=n.data,o=0,l=1,h=r.dashPattern;d.is(h)&&(o=this._rendering.getIndexFromPattern(h),l=h[h.length-1]),r.opacity<1&&(i.isTransparent=!0),a[1]=this.nbLines,a.push(r.color.r),a.push(r.color.g),a.push(r.color.b),a.push(r.lineWidth),a.push(r.opacity),a.push(r.opacityFactor),a.push(r.animation&&r.animation.speed||10),a.push(r.animation&&r.animation.nbPoints||1),a.push(r.animation&&r.animation.offest||0),a.push(r.animation&&!0===r.animation.reverse?1:0),a.push(r.animation&&r.animation.dashSize||10),a.push(r.animation&&r.animation.samplingRate||0),a.push(r.animation&&r.animation.minOpacity||.1),a.push(r.animation&&r.animation.gapSize||10),a.push(r.animation&&!1===r.animation.loop?0:1);var u=i.getFlagsFromPrimitiveRendering(s);a.push(u),a.push(o),a.push(l),d.is(n.idMap[e])||(n.idMap[e]=n.ySize),n.ySize+=1},_createElements:function(){var e,i=[];for(i.push(this.nbInfoPix),i.push(0),i.push(1),i.push(0),e=0;e<this.nbInfoPix-4;e+=1)i.push(0);return{lineMesh:new s({indexed:!0,useNormal:!1,useColor:!0,useTexCoord:!1}),textureInfo:{name:"lines_textureInfo",idMap:{},filter:t.NearestFilter,format:t.LuminanceFormat,xSize:this.nbInfoPix,ySize:1,data:i}}},setAttribute:function(e,t){this[c.attributeSetter[e]](t)}});return c.attributeSetter={dynamicUpdate:"setDynamicUpdate",minDist:"setMinDist",maxDist:"setMaxDist",minWidth:"setMinWidth"},c.getSettableAttributes=function(){var e,t=[];for(e in c.attributeSetter)c.attributeSetter.hasOwnProperty(e)&&t.push(e);return t.concat(i.getSettableAttributes().concat(r.getSettableAttributes()))},c}),define("DS/XCityRendering/RenderingHandlerHeatMap",["DS/XCityRendering/RenderingHandlerPOI3D","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/ColorGradient","DS/XCityCore/Store"],function(e,t,i,r,s,n){"use strict";return e.extend({init:function(e,t,i){this._parent(e,t,i),this._clusterminlength=1/0,this._clustermaxlength=-1/0,this._clustermaxmag=-1/0,this._nodesminlength=1/0,this._nodesmaxlength=-1/0,this._nodesmaxmag=-1/0,this.verbose=!1,this.debug=!1,this._magnitude=null},getIds:function(){return["3DXCityHeatMap"].concat(this._parent())},getDefaultRendering:function(){return Object.assign({},this._parent(),{influenceRadius:20,weight:1,boundMin:1,boundMax:100,kernel:0})},setHeatMapTool:function(e){this.heatmapToolRendering=e},getStoreVisiblePoints:function(){var e,r,s=[],a=1,o=[],l=this,h=this._content.get("id"),d=function(e){var t,r=i.getDataSource(e);return i.is(r)&&(t=r.records[0].userData.nhits),t||1},u=function(e,t){var r=i.getDataSource(e.value.node),s=d(e.value.node);return null!==l._magnitude&&(s=function(e,t){var r,s=i.getDataSource(e);return i.is(s)&&(r=s.records[0].userData.magnitude[t].sum),r||1}(e.value.node,l._magnitude)),i.is(r)&&(r.records[0].userData.STRID,r.records[0].userData),!0===l.debug?1:s};return n.traverse(h,function(n){if(i.is(n)&&n.locks>0&&i.is(n.value))if(1===n.value.nbFeatures&&n.value.node&&n.value.node.userData&&n.value.node.userData.records[0].userData.nhits>1){n.bbox;var l,h=n.value.node.getBoundingSphere();l=h&&h.radius>0?n.value.node.getBoundingSphere().center:(new t.Vector3).getPositionFromMatrix(n.value.node.getMatrix()),e=function(e){var t,r=i.getDataSource(e.value.node),s=1;return i.is(r)&&(t=r.records[0].bbox,r.records[0].userData.STRID,s=r.records[0].userData.radius||Math.max(t.xmax-t.xmin,t.ymax-t.ymin)/2),s}(n),r=u(n),s.push(new t.Vector4(l.x,l.y,e,r)),a=Math.max(r,a)}else{var d=i.getDataSource(n.value.node);o.push({tile:{LOD:n.tile.LOD,I:n.tile.I,J:n.tile.J},userData:d})}},!1),!0===l.verbose&&console.log("number of cluster",s.length,"maxmag:",a),{visiblePoints:s,maxMag:a,nonCLuster:o}},isRtreeToDisplay:function(e,t){if(!t)return!1;var r,s=e.tile;if(!i.is(s))return!0;for(r=0;r<t.length;r++){var n=t[r].userData;if(i.is(n)){var a=n.source.tile;if(i.isSameTile(s,a))return t.splice(r,1),!0}}return!1},getFrustumGeometry:function(e,i){var r=e.frustum.clone(),s=new t.Vector3(-e._camShiftedTranslation.x+this.urban.shiftedPosition.x,-e._camShiftedTranslation.y+this.urban.shiftedPosition.y,-e._camShiftedTranslation.z+this.urban.shiftedPosition.z),n=new t.Vector3(e._camShiftedTranslation.x+s.x,e._camShiftedTranslation.y+s.y,e._camShiftedTranslation.z+s.z);return r.set(r.planes[0].clone().translate(n),r.planes[1].clone().translate(n),r.planes[2].clone().translate(n),r.planes[3].clone().translate(n),r.planes[4].clone().translate(n),r.planes[5].clone().translate(n)),r},getVisibleRTreePoints:function(e){var t,i,r=[],s=1,n=this.urban.getViewpoint(),a=n.getPosition(),o=this.getFrustumGeometry(n,a),l=0;for(!0===this.verbose&&console.log(" store rtrees nodes",e.length),t=0;t<this.rtrees.length;++t)if(i=this.rtrees[t],this.isRtreeToDisplay(i,e)&&(l++,this.rtreeNodes[t].children.length>0)){var h=this.getRTreeListOfVisiblePoints(i,a,o);r=r.concat(h.visiblePoints),s=Math.max(s,h.maxMag)}return!0===this.verbose&&(console.log("total rtrees on layer ",this.rtrees.length,"rtrees considered",l),console.log("number of rtree node",r.length,"maxmag:",s)),{visiblePoints:r,maxMag:s}},newgetRTreeListOfVisiblePoints:function(e,i,r){for(var s=1,n=[],a=new t.Vector3(e.shift[0],e.shift[1],0),o=e.newgetVisiblePoints(i,r,a),l=0;l<o.visiblePoints.length;++l){var h=o.visiblePoints[l],d=this.getRadiusFromAttributes(h.z),u=this.getWeightFromAttributes(h.w),c=new t.Vector4(h.x,h.y,d,u);s=Math.max(s,u),n.push(c)}return{visiblePoints:n,maxMag:s}},getRTreeListOfVisiblePoints:function(e,i,r){var s=1,n=[],a=new t.Vector3(e.shift[0],e.shift[1],0),o=10;this._content._nhitsTotal<900&&(o=900);for(var l=e.getVisibleNodes(i,r,a,o),h=0;h<l.visibleNodes.length;++h){var d=l.visibleNodes[h].center,u=this.getRadiusFromRTreeNode(l.visibleNodes[h]),c=this.getWeightFromRTreeNode(l.visibleNodes[h]),p=new t.Vector4(d.x,d.y,u,c);s=Math.max(s,c),n.push(p)}return{visiblePoints:n,maxMag:s}},getMagnitudeFromRTreeNode:function(e){return e.mag/Math.max(e.nHits,1)},getRadiusFromRTreeNode:function(e){var t,r,s=e.radius;return i.is(e.infos)&&(t=e.infos.strid,r=e.infos.attributes),!0===this.debug?10:this.getRadiusFromAttributes(s,t,r)},getRadiusFromAttributes:function(e,t,i){var r=this.getCompleteMaterialInfo(t,i).influenceRadius;return this.getRadiusFromDistance(e,r)},getRadiusFromDistance:function(e,t){var i=e+t;return Math.max(i,1)},getrtreenodelevel:function(e){var t=5;return e.parent&&(t=this.getrtreenodelevel(e.parent),t-=1),t},getWeightFromRTreeNode:function(e){return e.mag},getWeightFromAttributes:function(e,t,i){var r=this.getCompleteMaterialInfo(t,i).weight;return this.getWeightFromValue(e,r)},getWeightFromValue:function(e,t){return e||t},shiftVisiblePoints:function(e,i){var r,s,n,a,o,l=1,h=[];for(r=0;r<e.visiblePoints.length;++r)n=(s=e.visiblePoints[r]).z,a=s.w,o=new t.Vector4(s.x+i.x,s.y+i.y,n,a),l=Math.max(l,a),h.push(o);return{visiblePoints:h,maxMag:l}},getVisiblePoints:function(){var e,i=new t.Vector3(this.urban.shiftedPosition.x,this.urban.shiftedPosition.y,this.urban.shiftedPosition.z);(e=this.urban.cropBox?new t.Vector4(i.x+this.urban.cropBox._size.x/2,i.y+this.urban.cropBox._size.y/2,0,0):new t.Vector4(i.x+this.urban.worldSize/2,i.y+this.urban.worldSize/2,0,0)).negate();var r=this.getStoreVisiblePoints();if(this._clusterminlength=Math.min(this._clusterminlength,r.visiblePoints.length),this._clustermaxlength=Math.max(this._clustermaxlength,r.visiblePoints.length),this._clustermaxmag=Math.max(this._clustermaxmag,r.maxMag),this.rtrees=this._content.getFactory().rtrees,this.rtreeNodes=this._content.getFactory().rtreeNodes,void 0!==this.rtrees){var s=this.getVisibleRTreePoints(r.nonCLuster);this._nodesminlength=Math.min(this._nodesminlength,s.visiblePoints.length),this._nodesmaxlength=Math.max(this._nodesmaxlength,s.visiblePoints.length),this._nodesmaxmag=Math.max(this._nodesmaxmag,s.maxMag),r={visiblePoints:s.visiblePoints.concat(r.visiblePoints),maxMag:Math.max(s.maxMag,r.maxMag)}}else if(r.nonCLuster&&r.nonCLuster.length>0){var n=this.getNonClusteredPoints(r.nonCLuster);r={visiblePoints:n.visiblePoints.concat(r.visiblePoints),maxMag:Math.max(n.maxMag,r.maxMag)}}var a=r=this.shiftVisiblePoints(r,e);return!0===this.verbose&&console.log("Number of visible Points ",r.visiblePoints.length),a},getNonClusteredPoints:function(e){var t,i={visiblePoints:[],maxMag:1};for(t=0;t<e.length;++t){var r=e[t],s=this.getPointsFromNonCluster(r);i={visiblePoints:s.visiblePoints.concat(i.visiblePoints),maxMag:Math.max(s.maxMag,i.maxMag)}}return i},getPointsFromNonCluster:function(e){var r,s,n,a=[],o={visiblePoints:a,maxMag:1},l=[];if(!(i.is(e)&&i.is(e.userData)&&i.is(e.userData.records)))return o;for(l=e.userData.records,r=0;r<l.length;++r){var h=l[r];if(i.is(h)&&i.is(h.posSize)&&i.is(h.posSize.center)){var d=h.posSize.center;s=this.getRadiusFromAttributes(null,h.strid,h.userData),n=this.getWeightFromAttributes(null,h.strid,h.userData),a.push(new t.Vector4(d.x,d.y,s,n)),o.maxMag=Math.max(o.maxMag,n)}}return o},shouldRebuild:function(e,t){var i=this._parent(e,t);if(!i){var r=this.currentRendering.getDifferences(this.lastRendering);r&&r.get("noGeometry")&&(i=!0)}return i}})}),define("DS/XCityRendering/RenderingHandlerPOI3DBillboard",["DS/XCityRendering/RenderingHandlerHeatMap","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/Visualization/ThreeJS_DS","DS/XCityRendering/DatavizRendering","DS/XCityTools/TextureManager","DS/XCityRendering/FeatureRendering","DS/XCityTools/OGCFilter"],function(e,t,i,r,s,n,a,o,l){"use strict";return e.extend({init:function(e,t,i){this._parent(e,t,i),this.enableAtlasing=!0,this.type="POI3D"},addDefaultDatavizMapping:function(e){var i={offsetFunction:{ratio:new s.Vector3(-.5,1,0),pixel:new s.Vector3}},r=(new l).propertyName("FILENAME").isNotNull().and((new l).propertyName("FILENAME").isNotEqualTo("")),a=new n(i,r,e);a.addOverIds("3DXCityDefaultIDdefaultMapBillboard"),this.defaultRendering.addOver(a),t.is(this._leafSetRendering)&&this._leafSetRendering.defaultRendering.addOver(a)},setLeafSetRendering:function(e){this._parent(e),this._leafSetRendering.defaultRendering.addOver(this.defaultRendering)},getDefaultRendering:function(){return Object.assign({},this._parent(),{scale:new s.Vector3(1,1,1),renderMode:"overlay",opacityFactor:"0.3",alphaTest:.1,altitude:void 0,styleClass:"",offsetFunction:{ratio:{x:-.5,y:.5,z:.5},pixel:{x:0,y:0,z:0}},mapUrl:null,map:null,shapeType:"billboard"})},updateRendering:function(e){var t=new o(e);this._parent(t)},initMesh:function(e){if(t.is(e)){var r=e._shapeType;if(t.is(r)){if("anchor"===r)return void this.initMeshAnchor(e);t.is(r)&&"billboard"===r&&t.is(this.atlasId)?this.currentRendering.set("mapAtlasId",this.atlasId):t.is(this.urlTexture)?this.applyDefaultMapUrl():this.currentRendering.set("map",null)}var s=this._getMaterial(e.mesh3js.material),n=s;"PoiTransparentOverlayPass"===e.passes[0]&&"dual"===this.getCompleteMaterialInfo().renderMode&&(n.opacity=this.getCompleteMaterialInfo().opacity*this.getCompleteMaterialInfo().opacityFactor),"OverlayPostPass"===e.passes[0]&&(n.depthTest=!1),t.is(this.atlasId)&&t.is(r)&&"billboard"===r&&this.addAtlasUniforms(s),i.updateCommonUniforms(n),this.setMaterialToMesh(e,n),this._lastSeenMaterial=n}},initMeshAnchor:function(e){var t=this._getMaterialInfo();t.map=void 0,t.mapUrl=void 0,t.alphaTest=void 0;var s=e.mesh3js.material;r._setMaterialFromProfile(s,t),i.updateCommonUniforms(s);var n=s;"PoiTransparentOverlayPass"===e.passes[0]&&"dual"===this.getCompleteMaterialInfo().renderMode&&(n.opacity=this.getCompleteMaterialInfo().opacity*this.getCompleteMaterialInfo().opacityFactor),"OverlayPostPass"===e.passes[0]&&(n.depthTest=!1),i.updateCommonUniforms(n),this.setMaterialToMesh(e,n),this._lastSeenMaterial=n},shouldRebuild:function(e,t){if(this._parent(e,t))return!0;var i=e.getRenderingData(),r=t.getRenderingData(),s=JSON.stringify(r.offsetFunction),n=JSON.stringify(i.offsetFunction);if(s!==n)return!0;var a,o,l=["mapUrl"],h=l.length;for(a=0;a<h;a++){var d=l[a];if((s=r[d])!==(n=i[d])){o=!0;break}}return!0===o},applyDefaultMapUrl:function(){var e=this.defaultRendering.get("mapUrl");if(this.urlTexture!==e){this.defaultRendering.set("mapUrl",this.urlTexture);var i=this.defaultRendering.get("mapParams");t.is(this.iconTopLeft)&&(t.is(i)||(i={}),i.width=this.widthTexture,i.height=this.heightTexture,this.defaultRendering.set("mapParams",i),this.defaultRendering.set("offsetFunction",{pixel:{x:this.iconTopLeft[1],y:-this.iconTopLeft[0]},ratio:{x:0,y:0}}),this.updateCurrentMaps())}},setCssMap:function(e,i,r,s){e!==this.urlTexture&&(this.urlTexture=e,t.is(i)&&(this.iconTopLeft=i,this.widthTexture=r,this.heightTexture=s),this.applyDefaultMapUrl())},onTextureApplied:function(e,r,s,n){if(e&&(r.updatePDSFXUniform("useMapCity",!0),r.updatePDSFXUniform("mapCityLoaded",!0)),this._parent(e,r,s,n),t.is(r[n.param])){var a,o,l=r[n.param].image.width;t.is(l)&&(i.updateSingleUniform(r,"width",l),o=.5*-l);var h=r[n.param].image.height;t.is(h)&&(i.updateSingleUniform(r,"height",h),a=-h);var d=s[n.param+"Params"];t.is(d)&&(t.is(d.top)&&(a=d.top),t.is(d.left)&&(o=d.left)),t.is(a)&&i.updateSingleUniform(r,"top",a),t.is(o)&&i.updateSingleUniform(r,"left",o)}},setTextureInfo:function(e,i,r,s){var n=!0;e.top=0,e.left=0,e.indexTexture=0;var a=this.getCurrentRenderingDifference(i,r);if(t.is(a.mapUrl)?t.is(a.offsetFunction)||(a.offsetFunction={ratio:{x:-.5,y:.5,z:.5},pixel:{x:0,y:0,z:0}}):a=this.getCompleteMaterialInfo(i,r),t.is(a.mapUrl)){e.top=-a.offsetFunction.pixel.y,e.left=a.offsetFunction.pixel.x,e.mapUrl=a.mapUrl;var o=this.getTextureInfo(a.mapUrl);if(t.is(o)){n=!1,e.indexTexture=o.index;var l=o.width,h=o.height;t.is(o.atlasWidth)&&(l*=o.atlasWidth),t.is(o.atlasHeight)&&(h*=o.atlasHeight),e.top-=a.offsetFunction.ratio.y*h,e.left+=a.offsetFunction.ratio.x*l,t.is(s)&&(s.widthTexture=l,s.heightTexture=h)}else e.indexTexture=0}else e.top=-128,e.left=-128;return n},computePOI3DBillboardLabelUniforms:function(e,i,r,s,n){if(t.is(e.getPDSFXUniform("top"))){var a=r.height/2-n/2;a+=n*i.label.position.labelOffset.y,a+=i.label.position.geometryOffset.y*r.height,a+=i.label.position.offset.y,e.updatePDSFXUniform("top",a)}if(t.is(e.getPDSFXUniform("left"))){var o=-s/2;o+=s*i.label.position.labelOffset.x,o+=i.label.position.geometryOffset.x*r.width,o+=i.label.position.offset.x,e.updatePDSFXUniform("left",o)}},updateLabelPos:function(e,i){if(t.is(this._content)&&t.is(this._content.parentFeatureID)&&t.is(xCity._urbanImpl.labelManager.groups[this._content.parentFeatureID])&&t.is(xCity._urbanImpl.labelManager.groups[this._content.parentFeatureID].pois)){var r=xCity._urbanImpl.labelManager.groups[this._content.parentFeatureID].pois.find(t=>t.name==="textNode_"+e);if(t.is(r)){var s=r.material,n=this.getCompleteMaterialInfo(),a=n.scale,o={width:i.atlasWidth*i.width*a.x,length:a.z,height:i.atlasHeight*i.height*a.y},l=s.getPDSFXUniform("labelSize").value;this.computePOI3DBillboardLabelUniforms(s,n,o,2*l.x,2*l.y)}}else console.warn("couldn't update label position because the matching group id coudldn't be found in labelManager")},updateTextureInfo:function(e,i,r){if(t.is(e)&&t.is(r)&&!0===e.isInstanceNode3D){var s={},n=this.setTextureInfo(s,i,r),a=this.getTextureInfo(s.mapUrl);if(this.updateLabelPos(i,a),n)console.error("texture download ended but no texture available!");else{var o=s.left,l=s.top,h=s.indexTexture;if(t.is(e.mesh3js.userData.cgmIds)){var d=e.mesh3js.userData.cgmIds.indexOf(i),u=e.mesh3js.instanceAttribArrays.instanceFloats.array,c=!1;h!==u[4*d+1]&&(u[4*d+1]=h,c=!0),o!==u[4*d+2]&&(u[4*d+2]=o,c=!0),l!==u[4*d+3]&&(u[4*d+3]=l,c=!0),c&&(e.mesh3js.instanceAttribArrays.instanceFloats.isDynamic=!0)}}}},onTextureDownloadStart:function(e,t,i){e.updatePDSFXUniform("useMapCity",!0),e.updatePDSFXUniform("mapCityLoaded",!1)},getTextureInfo:function(e){return a.getTextureInfoByUrl(e,this.atlasId)},getCompleteMaterialInfo:function(e,i){var r=this._parent(e,i);return r&&t.is(r.mapUrl)&&(this._mapUrls||(this._mapUrls={}),a.getAtlas(r.mapUrl)||(this._mapUrls[r.mapUrl]=!0)),r}})}),define("DS/XCityGeometry/PatchVectorFactoryModel",["DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PatchVectorFactoryPointGeometry","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/XCityLoaders/ModelLoader","UWA/Class","DS/XCityRendering/RenderingHandlerModel","DS/XCityTools/ShaderTools","DS/XCityTools/EventDispatcher","DS/XCityRendering/RenderingHandlerLabel","DS/xCityBasicUtils/LoadingProgressList","DS/XCityTools/Downloader","DS/XCityTools/Geocoder","DS/XCityTools/RenderingTools"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p){"use strict";return t.extend({init:function(e,t,s){this._parent(e,t,s),this.urban=e,this.fileNameAttribute=void 0!==t.fileNameAttribute?t.fileNameAttribute:"FILENAME",this.stridAttribute=void 0!==t.stridAttribute?t.stridAttribute:"STRID",this.attrAltitude=void 0!==t.attributAltitude?t.attributAltitude:"ALTITUDE",this.scaleAttribute=void 0!==t.scaleAttribute?t.scaleAttribute:"SCALE",this.path=t.path,r.is(this.path)&&(this.path=u.getResourcesUrlFromUrl(this.path),t.path=this.path),this.shader=t.Shader,"3DXM"===s?this._rendering=new h(e,t):(this._rendering=new a(e,t),this._rendering.addDefaultScaleFromAttributes(this.scaleAttribute),this._rendering.addDefaultAltitudeFromAttributes(this.attrAltitude)),this._node=new i,this._node.name="FactoryModel",this.urlOptions="",l.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},destroy:function(){this.urban.USR.getScene().remove(this._node)},dispose:function(){},getData:function(e){var t=new i;for(var r in e.ltileGeoms){var s=e.ltileGeoms[r];t.add(s)}this.addLabelsToNode(e,t);return this._isCoreReady=!1,t.isCoreReady=function(){if(this._isCoreReady)return!0;for(var e=!0,t=0;t<this.children.length;++t)if(!1===this.children[t].isCoreReady){e=!1;break}return this._isCoreReady=e,e},t},initMesh:function(e,t,i,r,s){},buildOne:function(t,i,s){var n,a=t.getAttribute(this.stridAttribute),o=t.getAttribute(this.fileNameAttribute),l=t.getGeometry(),h=l.getVertices(),d=this._rendering.getCompleteMaterialInfo(a,t.attributes);n=this._computeAltitudeToApply(d,h);var f=d.scale,m=new e.Vector3(0,0,0);if(f.equals(m)){if(o&&(o.includes(".3dxml")||o.includes(".cgr")))var g=p._initVector3(.001)}else g=f;this._rendering.currentRendering.renderingData.scale=g||p._initVector3(1);var v=(new e.Matrix4).identity().setPosition(new e.Vector3(l.x,l.y,n));s.posSize.center.set(l.x,l.y,n),s.posSize.altitude=n;var _=this.path.indexOf("?");""===this.urlOptions&&-1!==_&&(this.urlOptions=this.path.substring(_),this.path=this.path.substring(0,_));var y={name:a,url:this.path+o,urlOptions:this.urlOptions,shifted:!0,matrix:v,rendering:this._rendering,color:t.color,opacity:t.opacity,patch:this.patch};if(o.includes(".3dxml")){var b=this.path.replace("%globe%",u._aliases.globe);y={name:a,spec:{filename:o+this.urlOptions,serverurl:b,withCredentials:!0,provider:"FILE",proxyurl:"none",requiredAuth:null},shifted:!0,matrix:v,rendering:this._rendering,color:t.color,opacity:t.opacity,patch:this.patch}}this.shader&&(y.shader=this.shader);var x=this;this.primitiveProgress(a,{loaded:0,total:1});var C=i.indexPrimitive,S=this.urban.modelLoader.load(y,function(e,t,i,s,n){if(g&&x.setScale(e,g),"EPSG:3857"===x.urban.baseProjection||"EPSG:900913"===x.urban.baseProjection){var a=c.computeMercatorScaleFactor(l.x,l.y,c.getDefaultProjection());x.appliedMercatorScale=p._initVector3(a),x.applyScale(e,x.appliedMercatorScale)}r.is(C)&&C(e,t,i,s,n),x._loadingProgressList.modelLoaded(i)},this.primitiveProgress.bind(this,a));if(i.ltileGeoms[a]=S,this._shouldCreateLabelFromMaterial(d)){var D=new e.Vector3(l.x,l.y,n);r.is(i.labelMeshes)||(i.labelMeshes=[]);let o=r.generateLabelPriorities(this._node,t);i.labelMeshes.push(this._generateLabel(D,a,d,s.posSize,void 0,o))}},primitiveProgress:function(e,t){r.is(this._loadingProgressList)||(this._loadingProgressList=new d(this.layerProgress.bind(this),this.layerLoaded.bind(this))),this._loadingProgressList.updateLoading(e,t)},layerProgress:function(e){r.is(this._progressCallback)&&this._progressCallback(e)},layerLoaded:function(){},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1},attributeSetter:{color:"setColor",opacity:"setOpacity"},setGeomAttribute:function(e,t,i){return e[this.attributeSetter[t]](i),this},setScale:function(t,i){if(t._matrix){var r=i.x/t._matrix.elements[0],s=i.y/t._matrix.elements[5],n=i.z/t._matrix.elements[10],a=new e.Vector3(r,s,n);t.setMatrix(t.getMatrix().scale(a))}else t.setMatrix((new e.Matrix4).makeScale(i.x,i.y,i.z))},applyScale:function(t,i){t._matrix?t.setMatrix(t.getMatrix().scale(i)):t.setMatrix((new e.Matrix4).makeScale(i.x,i.y,i.z))},getDatas:function(e){var t,i=[];if(e.geom)for(t=0;t<e.geom.length;t+=1)e.geom[t].subElement.group.geometry.drawingGroups[t]&&i.push({attributes:{id:e.geom[t].subElement.group.geometry.drawingGroups[t].gas.id},target:e.geom[t].subElement});return i}})}),define("DS/XCityRendering/RenderingHandlerMarker",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/xCityBasicUtils/ColorGradient","DS/XCityRendering/RenderingHandlerAltitude"],function(e,t,i,r){"use strict";return r.extend({init:function(e){this._parent(e),this.type="Marker"},getDefaultRendering:function(){return Object.assign({},this._parent(),{color:new i(new e.Color("#003c5a")),textColor:new i(new e.Color("#e2e4e3")),style:"annotationIcon",customClass:"",iconName:"",icon:{},textStyle:"button",stroke:{},descriptionDisplayMode:"click"})},applyRendering:function(e){if(e)for(var i=t.getDataSource(e),r=0;r<e.features.length;r++){var s=i.records[r].userData,n=this.getCompleteMaterialInfo(i.records[r].strid,s);e.features[r].get("Content").applyMaterialOnGeometry(n)}}})}),define("DS/XCityRendering/RenderingHandlerPOI3DGeometry",["DS/XCityRendering/RenderingHandlerHeatMap","DS/xCityBasicUtils/Utils","DS/Visualization/ThreeJS_DS","DS/XCityRendering/FeatureRendering","DS/xCityBasicUtils/ColorGradient"],function(e,t,i,r,s){"use strict";return e.extend({init:function(e,t,i){this._parent(e,t,i),this.type="POI3DGeometry"},getDefaultRendering:function(){return Object.assign({},this._parent(),{ambient:new s(new i.Color("#000000")),diffuse:new s(new i.Color("#000000")),color:new s(new i.Color("#000000")),scale:new i.Vector3(8,8,8),renderMode:"dual",opacityFactor:.3,alphaTest:.01,altitude:void 0,styleClass:""})},updateRendering:function(e){var t=new r(e);t.remove("mapUrl"),this._parent(t)},notsetRenderingList:function(e,r,s,n){var a,o,l,h="billboard"===n._shapeType,d="sphere"===n._shapeType;if(!0===n.isInstanceNode3D&&(o=n.mesh3js.userData.cgmIds,t.is(o)&&n.mesh3js.instanceAttribArrays.instanceColor)){var u=n.mesh3js.instanceAttribArrays.instanceColor.array,c=n.mesh3js.userData.instanceColor;if(n.mesh3js.instanceAttribArrays.instanceMatrix){var p=n.mesh3js.instanceAttribArrays.instanceMatrix.array,f=n.mesh3js.userData.instanceMatrix;a=n.mesh3js.instanceAttribArrays.instanceFlag.array;for(var m=n.mesh3js.userData.instanceFlags,g=(n.mesh3js.userData.instanceIds,{}),v=0;v<n.mesh3js.userData.instanceIds.length;v++)g[n.mesh3js.userData.instanceIds[v]]=v;var _=n.mesh3js.userData.__v0,y=n.mesh3js.userData.__v1,b=!1,x=n.mesh3js.geometry.boundingSphere,C=x.center.x-x.radius,S=x.center.x+x.radius,D=x.center.y-x.radius,P=x.center.y+x.radius,w=x.center.z-x.radius,M=x.center.z+x.radius;for(v=0;v<o.length;v++){var T=v,I=g[n.mesh3js.userData.cgmIds[v]],R=e[I];if(R){var A=0;A=a[T];var F=R.color,L=R.opacity,V=t.is(F),O=t.is(L);A=t.floatPack(A,0,V),A=t.floatPack(A,1,O);var N,U,E=R.scale;if(E&&!h){l||(l=[]);var k,z,B;k=.5*E.x,z=.5*E.y,B=E.z,d&&(z=B=k),l[0]=100*k,l[5]=100*z,l[10]=100*B}if(l){for(var j in N=16*T,U=16*I,l)if(l.hasOwnProperty(j)){var X=N+Number(j);p[X]=l[j],f[X=U+Number(j)]=l[j]}_.set(p[N+12],p[N+13],p[N+14]),y.set(p[N+0],p[N+5],p[N+10]),_.x-y.x<C&&(C=_.x-y.x,b=!0),_.x+y.x>S&&(S=_.x+y.x,b=!0),_.y-y.y<D&&(D=_.y-y.y,b=!0),_.y+y.y>P&&(P=_.y+y.y,b=!0);var G=_.z;_.z-y.z<w&&(w=_.z-y.z,b=!0),G+y.z>M&&(M=G+y.z,b=!0)}N=4*T,U=4*I,V&&(u[N]=F.r,u[N+1]=F.g,u[N+2]=F.b,c[I].x=F.r,c[I].y=F.g,c[I].z=F.b),O&&(u[N+3]=L,c[I].w=L),A!==a[T]&&(a[T]=A,m[I]=A)}}if(n.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0,n.mesh3js.instanceAttribArrays.instanceColor.isDynamic=!0,n.mesh3js.instanceAttribArrays.instanceMatrix.isDynamic=!0,b){var W=new i.Sphere;W.radius=Math.sqrt(Math.pow(S-C,2)+Math.pow(P-D,2)+Math.pow(M-w,2))/2,W.center.x=(C+S)/2,W.center.y=(D+P)/2,W.center.z=(w+M)/2,n.boundingSphere=W}}}}})}),define("DS/XCityGeometry/PatchVectorFactoryPointOfInterest3D",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PatchVectorFactoryPointGeometry","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/xCityBasicUtils/Utils","DS/XCityGeometry/PointOfInterest3DSet","DS/XCityLayer/Vector","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/XCityRendering/RenderingHandlerPOI3DGeometry","DS/XCityRendering/RenderingHandlerPOI3DBillboard","DS/XCityTools/Geocoder","DS/XCityTools/RTree","DS/Visualization/SceneGraphFactory","DS/XCityTools/Downloader","DS/XCityTools/Disposer"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m,g,v){"use strict";return i.extend({init:function(e,i){this._parent(e,i),this.urban=e,this._billboardCSSMaploaded=!1,this.instancing=!0,this.geoJSON={},this._node=new r,this._node.name="FactoryPointOfInterest3D",this._node.hwInstancing=this.urban.USR.hwInstancing,this._webglEvent=d.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this)),this._node.setMatrix(new t.Matrix4);var n=this.urban.USR.viewpoint,l=new t.Matrix4;if(l.scale(new t.Vector3(1,1,1/n.urban.USR.scale)),this._node.setMatrix(l),this._disableMercatorScaleFactor=function(e){var i=new t.Matrix4;i.scale(new t.Vector3(1,1,1/e.urban.USR.scale)),this._node.setMatrix(i)},n.addEvent("onCameraShift",this._disableMercatorScaleFactor,this),this._geometrySet=i.geometrySet,i.geometrySet=void 0,this.factoryParam=UWA.clone(i),this.styleClass=void 0,this.samplingFactor=void 0!==i.samplingFactor?i.samplingFactor:1,this.nameAttribute=void 0!==i.nameAttribute?i.nameAttribute:"NAME",this.stridAttribute=void 0!==i.stridAttribute?i.stridAttribute:"STRID",this.styleClassAttribute=void 0!==i.styleClassAttribute?i.styleClassAttribute:"STYLECLASS",this.altitudeAttribute=void 0!==i.altitudeAttribute?i.altitudeAttribute:"ALTITUDE",this.heightAttribute=void 0!==i.heightAttribute?i.heightAttribute:"HEIGHT",this.anchorLineWidth=void 0!==i.anchorLineWidth?i.anchorLineWidth:1,this.orientationAttribute=void 0!==i.orientationAttribute?i.orientationAttribute:"ORIENTATION",this.switchDistance=void 0!==i.switchDistance?i.switchDistance:0,this.shapeType="pyramid",this._isReady=!1,this.rdblink=!0,this.type=0,void 0!==i.shapeType){var u=i.shapeType.toLowerCase();"billboard"===u||"disc"===u||"sphere"===u||"tube"===u||"pyramid"===u?(this.factoryParam.shapeType=u,this._isReady=!0):e.USR.hwInstancing?(this.shapeType=i.shapeType,this.factoryParam._posSize={},e.modelLoader.load({url:this.shapeType},function(e,t,i){this.factoryParam._posSize.center=e.bSphere.center.clone(),this.factoryParam._posSize.radius=e.bSphere.radius,this.factoryParam._posSize.altitude=e.bBox.min.z,this.factoryParam._posSize.height=e.bBox.max.z-e.bBox.min.z,this.factoryParam._posSize.width=e.bBox.max.y-e.bBox.min.y,this.factoryParam._posSize.length=e.bBox.max.x-e.bBox.min.x,e.traverse(function(e){e instanceof s&&(this.factoryParam.modelMesh3d=e,this._isReady=!0)}.bind(this))}.bind(this))):h.warn("Unable to load the model or hw instancing is not activated...")}if(this.alwaysDisplayText=!!i.alwaysDisplayText&&i.alwaysDisplayText,i.alwaysDisplayText=!1,a.is(i.rendering)||(this._rendering=this.createNewRenderingHandler(this.factoryParam.shapeType,e,i),this.factoryParam.rendering=this._rendering),this.displayClusterHits=!0,this.nbSelectedNode=0,this.initLabelOnSelect(e,i.renderType),this.eventOnVisibilityParent=!1,this.minMaxTmp={minX:0,maxX:0,minY:0,maxY:0,minZ:0,maxZ:0},this._frame=0,this._refreshFrame=10,this._minimumHits=10,this._densityFactor=1,this._nbSteps=6,this._nHitsTotal=1e5,this._clusterScale=5,this._magnitude=null,this.rtreeMin=5,this.rtreeMax=10,this.rtreeCoverageFactor=1.5,this._digitTextureReady=!0,this.nbFeature=0,void 0===o.textTexture.clusterDigits){this._digitTextureReady=!1;g.loadTexture(function(e){e.minFilter=t.NearestFilter,e.magFilter=t.NearestFilter,o.textTexture.clusterDigits={map:e,params:{width:e.image.width,height:e.image.height,topText:e.image.height/2,leftText:-e.image.width/2,samplingFactor:1}},this._digitTextureReady=!0}.bind(this),"XCityGeometry/assets/img/cluster_digit.png")}this._rendering.addDefaultAltitudeFromAttributes(this.heightAttribute,this.altitudeAttribute)},isBillboard:function(){return this.factoryParam&&"billboard"===this.factoryParam.shapeType},createNewRenderingHandler:function(e,t,i,r){return"billboard"===e?new c(t,i,r):new u(t,i,r)},destroy:function(){this.urban.USR.getScene().remove(this._node),void 0!==this._webglEvent&&d.unsubscribe(this._webglEvent),void 0!==this.updateToken&&d.unsubscribe(this.updateToken),this.urban.USR.viewpoint.removeEvent("onCameraShift",this._disableMercatorScaleFactor,this),void 0!==this.rtreeNodes&&(this.rtreeNodes=[],this.rtrees=[]),this._parent()},isReady:function(){return this._isReady&&this._digitTextureReady},dispose:function(){},setRendering:function(e){return!1},_computeMinMax:function(e){var t={minX:0,maxX:0,minY:0,maxY:0,minZ:0,maxZ:0};return this.minMaxTmp.minX=t.minX=Math.min(this.minMaxTmp.minX,e.minX),this.minMaxTmp.maxX=t.maxX=Math.max(this.minMaxTmp.maxX,e.maxX),this.minMaxTmp.minY=t.minY=Math.min(this.minMaxTmp.minY,e.minY),this.minMaxTmp.maxY=t.maxY=Math.max(this.minMaxTmp.maxY,e.maxY),this.minMaxTmp.minZ=t.minZ=Math.min(this.minMaxTmp.minZ,e.minZ),this.minMaxTmp.maxZ=t.maxZ=Math.max(this.minMaxTmp.maxZ,e.maxZ),t},getData:function(e){var i=new r;if(void 0!==e.rtree){void 0===this.updateToken&&(this.updateToken=d.subscribeTo("/3DEXPERIENCity/onUpdate",this._update.bind(this))),void 0===this.rtreeNodes&&(this.rtreeNodes=[],this.rtrees=[]);var s=e.clusterSet.getMesh();s.name="rtreeMeshCluster_"+e.tile.LOD+"_"+e.tile.I+"_"+e.tile.J,this.rdblink&&(s.setPickable(n.NOPICKABLE),s.children[0].setPickable(n.NOPICKABLE),2===s.children.length&&s.children[1].setPickable(n.NOPICKABLE));for(var o=0;o<s.children.length;++o)s.children[0].clusterInfo={LOD:e.tile.LOD,I:e.tile.I,J:e.tile.J,rtree:e.rtree};var l=e.leafSet.getMesh();l.name="leafMeshCluster_"+e.tile.LOD+"_"+e.tile.I+"_"+e.tile.J,l.children[0].clusterInfo={LOD:e.tile.LOD,I:e.tile.I,J:e.tile.J,isLeaf:!0},2===l.children.length&&(l.children[1].clusterInfo={LOD:e.tile.LOD,I:e.tile.I,J:e.tile.J,isLeaf:!0}),e.tileNode.addChild(s),e.tileNode.addChild(l),e.tileNode.addChild(new r);var h=(new t.Matrix4).identity().setPosition(new t.Vector3(e.posTile.x,e.posTile.y,0));e.tileNode.setMatrix(h);for(var u=-1,c=0;c<this.rtrees.length;++c)this.rtrees[c].clusterSTRID===e.rtree.clusterSTRID&&(u=c);if(e.rtree.shift=[e.posTile.x,e.posTile.y],e.rtree.billboardSize=[e.leafSet.scaleCulling,e.leafSet.scaleCulling],u>-1?(this.rtreeNodes[u]=e.tileNode,this.rtrees[u]=e.rtree):(this.rtreeNodes.push(e.tileNode),this.rtrees.push(e.rtree),e.rtree.tile={LOD:e.tile.LOD,I:e.tile.I,J:e.tile.J}),e.rtree.computeHits(),e.rtree.firstUpdate=!0,e.tileNode.name="tileNodePoi3dCluster_"+e.tile.LOD+"_"+e.tile.I+"_"+e.tile.J,i=e.tileNode,a.is(e.labelsNode)&&e.tileNode.addChild(e.labelsNode),e.namingMeshes){(m=new r).name="namingMeshes";for(o=0;o<e.namingMeshes.length;++o)m.addChild(e.namingMeshes[o]);i.addChild(m)}i.clusterType=2}else if(void 0!==e.poiSet){var p=e.poiSet.getMesh();this.maxMinMax=this._computeMinMax(e.poiSet.minMaxOrig);h=(new t.Matrix4).identity().setPosition(new t.Vector3(e.posTile.x,e.posTile.y,0));if(p.setMatrix(h),e.tileNode.clusterType=0,!0===e.qtCluster){p.setPickable(n.NOPICKABLE),p.name="qtcluster_"+e.tile.LOD+"_"+e.tile.I+"_"+e.tile.J;for(var f=0;f<p.children.length;++f)p.children[f].clusterInfo={LOD:e.tile.LOD,I:e.tile.I,J:e.tile.J,qtClusterBbox:e.qtClusterBbox};e.tileNode.clusterType=1}e.tileNode.addChild(p),i=e.tileNode;let s=e.labelsNode;if(s&&(s.name="labelsMeshes",s.setMatrix(h),i.addChild(s)),e.namingMeshes){var m;(m=new r).name="namingMeshes",m.setMatrix(h);for(o=0;o<e.namingMeshes.length;++o)m.addChild(e.namingMeshes[o]);i.addChild(m)}}return i=this.geometryToReturn(i)},geometryToReturn:function(e){var i=this._rendering.getCompleteMaterialInfo();if(e&&i&&i.noGeometry){var s=e.getBoundingSphere().center,n=new t.Matrix4;n.setPosition(s);var a=new r;return a.setMatrix(n),a.name=e.name,a.clusterType=e.clusterType,a}return e},disposeRtree:function(e){if(void 0!==this.rtreeNodes&&a.is(e)){for(var t=-1,i=0;i<this.rtreeNodes.length;++i)if(this.rtreeNodes[i].name===e.name){t=i;break}t>-1&&(this.rtreeNodes.splice(t,1),this.rtrees.splice(t,1))}},_update:function(e){if(void 0!==this.rtrees){let e=!1;var i=this.urban.getViewpoint(),r=i.frustum.clone(),s=new t.Vector3(-i._camShiftedTranslation.x+this.urban.shiftedPosition.x,-i._camShiftedTranslation.y+this.urban.shiftedPosition.y,-i._camShiftedTranslation.z+this.urban.shiftedPosition.z),n=new t.Vector3(i._camOldPosition.x+s.x,i._camOldPosition.y+s.y,i._camOldPosition.z+s.z);n=i.getPosition();var a=new t.Vector3(i._camShiftedTranslation.x+s.x,i._camShiftedTranslation.y+s.y,i._camShiftedTranslation.z+s.z);r.set(r.planes[0].clone().translate(a),r.planes[1].clone().translate(a),r.planes[2].clone().translate(a),r.planes[3].clone().translate(a),r.planes[4].clone().translate(a),r.planes[5].clone().translate(a));var o=new t.Matrix4,l=new t.Vector4,h=new t.Vector4,u=0,c=this._rendering.getCompleteMaterialInfo();if(c.noGeometry)return;for(var p=0;p<this.rtrees.length;++p){var f=this.rtrees[p],m=new t.Vector3(f.shift[0],f.shift[1],0);if(this._frame%this._refreshFrame==0||!0===f.firstUpdate){if(f.firstUpdate=!1,this.rdblink)g=f.getVisibleNodes(n,r,m,this._minimumHits);else var g=f.getVisibleNodesTest(n,r,m,1,this.rtreeCoverageFactor);if(e=e||g.changed,g.changed&&this.rtreeNodes[p].children.length>0){for(var _=0,y=0,b=0;b<g.visibleNodes.length;++b)g.visibleNodes[b].nHits>0&&(1===g.visibleNodes[b].mag?y++:_++);if(c.label&&c.label.enable&&this.rtreeNodes[p].children[3])for(var x=0;x<this.rtreeNodes[p].children[3].children.length;++x)this.rtreeNodes[p].children[3].children[x].setVisibility(!1);if(this.rtreeNodes[p].children[4])for(x=0;x<this.rtreeNodes[p].children[4].children.length;++x)this.rtreeNodes[p].children[4].children[x].setVisibility(!1);for(x=0;x<this.rtreeNodes[p].children[0].children.length;++x){if((V=this.rtreeNodes[p].children[0].children[x]).mesh3js._instancingInfos.instanceAttribArrays.instanceMatrix){V.nbInstances=_,V.mesh3js.nbInstances=_,V.mesh3js._instancingInfos.nbInstances=_;for(var C=0;C<V._occurrences.length;C++){V._occurrences[C].renderable.nbInstances=_,V._occurrences[C].renderable.highlight&&(V._occurrences[C].renderable.highlight.nbInstances=_)}}else{V.nbInstances=0,V.mesh3js.nbInstances=0,V.mesh3js._instancingInfos.nbInstances=0;for(C=0;C<V._occurrences.length;C++){V._occurrences[C].renderable.nbInstances=0,V._occurrences[C].renderable.highlight&&(V._occurrences[C].renderable.highlight.nbInstances=0)}}}for(x=0;x<this.rtreeNodes[p].children[1].children.length;++x){this.rtreeNodes[p].children[1].children[x].nbInstances=y,this.rtreeNodes[p].children[1].children[x].mesh3js.nbInstances=y,this.rtreeNodes[p].children[1].children[x].mesh3js._instancingInfos.nbInstances=y;for(C=0;C<this.rtreeNodes[p].children[1].children[x]._occurrences.length;C++){this.rtreeNodes[p].children[1].children[x]._occurrences[C].renderable.nbInstances=y,this.rtreeNodes[p].children[1].children[x]._occurrences[C].renderable.highlight&&(this.rtreeNodes[p].children[1].children[x]._occurrences[C].renderable.highlight.nbInstances=y)}}v.traverseV6(this.rtreeNodes[p].children[2]);var S=0,D=0;for(b=0;b<g.visibleNodes.length;++b){for(var P=g.visibleNodes[b];1===P.nHits&&1===P.children.length;)P=P.children[0];if(P.nHits>0){"billboard"===this.factoryParam.shapeType?(o.elements[0]=2*this.rtreeNodes[p].children[1].children[0].mesh3js.userData.__initScale[0][0]/f.billboardSize[0],o.elements[5]=2*this.rtreeNodes[p].children[1].children[0].mesh3js.userData.__initScale[0][1]/f.billboardSize[1],o.elements[10]=this.rtreeNodes[p].children[1].children[0].mesh3js.userData.__initScale[0][2]):(o.elements[0]=this.rtreeNodes[p].children[1].children[0].mesh3js.userData.__initScale[0][0],o.elements[5]=this.rtreeNodes[p].children[1].children[0].mesh3js.userData.__initScale[0][1],o.elements[10]=this.rtreeNodes[p].children[1].children[0].mesh3js.userData.__initScale[0][2]/2);for(var w=[67,60,53,46,39,32,25,18],M=0,T=!1,I=0,R=this._clusterSteps.length-1;R>=0;--R)P.mag>=this._clusterSteps[R]&&!T&&P.mag>1&&(T=!0,M=w[I]),I++;if(T&&(o.elements[0]=100*M/2,o.elements[5]=100*M/2,o.elements[10]=100*M/2),o.elements[12]=P.center.x-m.x,o.elements[13]=P.center.y-m.y,o.elements[14]=(P.boundingBox.max.z+P.boundingBox.min.z)/2,1===P.mag){o.elements[14]=P.infos.altitude+P.infos.height,l.x=P.center.x-m.x,l.y=P.center.y-m.y,l.w=P.infos.height/2,l.z=P.infos.altitude+l.w;for(x=0;x<this.rtreeNodes[p].children[1].children.length;++x){if((V=this.rtreeNodes[p].children[1].children[x]).mesh3js.userData.instanceIds){var A=V.mesh3js.userData.instanceIds.indexOf(P.infos.strid);h=V.mesh3js.userData.instanceColor[A],u=V.mesh3js.userData.instanceFlags[A],V.mesh3js._instancingInfos.instanceAttribArrays.instanceMatrix?(V.updateInstanceAttribValue({instanceId:5*D+5,attribName:"instanceMatrix",value:o}),V.updateInstanceAttribValue({instanceId:5*D+5,attribName:"instanceColor",value:h}),V.updateInstanceAttribValue({instanceId:5*D+5,attribName:"instanceFlag",value:u})):(V.updateInstanceAttribValue({instanceId:5*D+5,attribName:"instanceAnchor",value:l}),V.updateInstanceAttribValue({instanceId:5*D+5,attribName:"instanceColor",value:h}),V.updateInstanceAttribValue({instanceId:5*D+5,attribName:"instanceFlag",value:u})),V._occurrences[0].renderable.userData.cgmIds&&(V._occurrences[0].renderable.userData.cgmIds[D]=P.infos.strid)}}if(c.label&&c.label.enable&&this.rtreeNodes[p].children[3]){var F;for(x=0;x<this.rtreeNodes[p].children[3].children.length;++x)(F=this.rtreeNodes[p].children[3].children[x]).name==="textNode_"+P.infos.strid&&F.setVisibility(!0)}if(this.rtreeNodes[p].children[4]){var L;for(x=0;x<this.rtreeNodes[p].children[4].children.length;++x)(L=this.rtreeNodes[p].children[4].children[x]).name==="textNode_"+P.infos.strid&&L.setVisibility(!0)}D++}else{P.tmpIndexCluster=S;for(x=0;x<this.rtreeNodes[p].children[0].children.length;++x){var V;(V=this.rtreeNodes[p].children[0].children[x]).mesh3js._instancingInfos.instanceAttribArrays.instanceMatrix&&V.updateInstanceAttribValue({instanceId:5*S+5,attribName:"instanceMatrix",value:o}),V._occurrences[0].renderable.userData.cgmIds&&(V._occurrences[0].renderable.userData.cgmIds[S]=P.clusterId)}S++}if(P.mag>1&&this.displayClusterHits){var O=new t.Vector3(P.center.x-m.x,P.center.y-m.y,o.elements[14]),N=this._generateTextOpti(O,P.mag?P.mag:P.nHits,void 0,!0);N.setFrustumCulled(!1),this.rtreeNodes[p].children[2].addChild(N)}}}d.publish("/3DEXPERIENCity/onClusterUpdate",this.rtreeNodes[p].children[1].children[0])}}}this._frame++,e&&this._node.userData._attributes.selected&&(xCity._urbanImpl.USR._modelHightlighter._unhighlightElement(!0,this._node.userData._attributes.Content._node),xCity._urbanImpl.USR._modelHightlighter._highlightElement(!0,this._node.userData._attributes.Content._node))}},updateShapeType:function(e){var t=this.factoryParam.shapeType,i=e.shapeType;this.factoryParam.shapeType=e.shapeType,"billboard"!==t&&"billboard"!==i||(this._rendering=this.createNewRenderingHandler(i,this.urban,this.factoryParam,this._rendering),this._rendering.addDefaultAltitudeFromAttributes(this.heightAttribute,this.altitudeAttribute),this._leafSetRendering&&(this._leafSetRendering=null),this._qtClusterSetRendering&&this._rendering.setQtClusterSetRendering(this._qtClusterSetRendering),this._clusterSetRendering&&this._rendering.setClusterSetRendering(this._clusterSetRendering)),this.factoryParam.rendering._proxyHandler&&(this._rendering._proxyHandler=this.factoryParam.rendering._proxyHandler,this._rendering._proxyHandler._subRenderingHandler[0]=this._rendering),this.factoryParam.rendering=this._rendering,this._geometrySet&&(this._geometrySet._poiSet._rendering=this._rendering,this._geometrySet.getRendering()._subRenderingHandler[0]=this._rendering)},buildOne:function(e,i,s,n){var h,d,u,c,p,m;this.eventOnVisibilityParent||(this.eventOnVisibilityParent=!0,this._node.userData&&this._node.userData.addEvent("onChange:visible",this.removeAllInfoNodes,this));var g=e.getAttribute(this.orientationAttribute);void 0===g?g=[0]:"number"==typeof g?g=[g]:"string"==typeof g&&(g=g.split(" "));var v=e.getGeometry();if(v.type===l.Type.POINT||v.type===l.Type.MULTIPOINT){h=e.getAttribute(this.stridAttribute),d=e.getAttribute(this.nameAttribute),u=v.getVertices();var _=this,y=function(l){var u=e.attributes,v=_._rendering.getCompleteMaterialInfo();if(_.factoryParam.nbVertices=v.nbVertices,_.switchDistance=v.switchDistance,_.factoryParam.switchDistance=v.switchDistance,_.factoryParam.shapeType!==v.shapeType&&_.updateShapeType(v),v=_._rendering.getCompleteMaterialInfo(h,u),void 0===i.posTile&&(i.posTile=new t.Vector2(Math.round(l[0]),Math.round(l[1])),i.nbPoi=0,i.textMaterial=[],i.widthText={},i.heightText={},i.textTexture={},i.tileNode=new r,i.nbPoi=0),1===n){if(void 0===i.rtree){i.rtree=new f(_.rtreeMin,_.rtreeMax,_.urban,Math.max(xCity.distanceToTarget/2,1e3));var y=h.toString(),b=y.lastIndexOf("-");if(y=(y=y.slice(0,b))+"-Cluster_"+s.tile.LOD+"_"+s.tile.I+"_"+s.tile.J,i.rtree.clusterSTRID=y,!_._leafSetRendering){var x=Object.assign({},_.factoryParam,_._rendering.getCompleteMaterialInfo());_._leafSetRendering=_.createNewRenderingHandler(x.shapeType,_.urban,x),_._rendering.setLeafSetRendering(_._leafSetRendering)}var C=Object.assign({},_.factoryParam,{rendering:_._leafSetRendering});if(i.leafSet=new o(_.urban,C,i),!_._clusterSetRendering){var S=Object.assign({},_._rendering.getCompleteMaterialInfo(),{shapeType:"sphere",nbVertices:15,switchDistance:0});_._clusterSetRendering=_.createNewRenderingHandler("sphere",_.urban,S),_._rendering.setClusterSetRendering(_._clusterSetRendering)}var D=Object.assign({},_.factoryParam,{rendering:_._clusterSetRendering,shapeType:"sphere",nbVertices:15,switchDistance:0});i.clusterSet=new o(_.urban,D,i)}}else 0===n&&(i.qtCluster=!0);if(1!==n&&void 0===i.poiSet){var P=_.factoryParam;if(0===n){if(!_._qtClusterSetRendering){var w=Object.assign({},_.factoryParam,_._rendering.getCompleteMaterialInfo(),{mapUrl:null,shapeType:"sphere",nbVertices:15,switchDistance:0});_._qtClusterSetRendering=_.createNewRenderingHandler("sphere",_.urban,w),_._rendering.setQtClusterSetRendering(_._qtClusterSetRendering)}P=Object.assign({},_.factoryParam,{rendering:_._qtClusterSetRendering,shapeType:"sphere",nbVertices:15,switchDistance:0})}i.poiSet=new o(_.urban,P,i)}m=i.posTile,c=[1,1,1],a.is(v.scale)&&(c[0]=v.scale.x,c[1]=v.scale.y,c[2]=v.scale.z),new t.Color(16777215),1;var M=_._rendering.getPrimitiveRenderingValues(h,u);if(a.is(M)&&(a.is(M.color)&&M.color.computeColor(),a.is(M.opacity)&&M.opacity,a.is(M.scale)&&(c[0]=M.scale.x,c[1]=M.scale.y,c[2]=M.scale.z)),0===n||1===n)for(var T=[67,60,53,46,39,32,25,18],I=!1,R=0,A=_._clusterSteps.length-1;A>=0;--A)u.nhits>=_._clusterSteps[A]&&!I&&(I=!0,c[0]=T[R],c[1]=T[R],c[2]=T[R]),R++;p=_._computeAltitudeToApply(v,l,e);var F=""!==v.styleClass?v.styleClass:e.getAttribute(_.styleClassAttribute),L=new t.Vector3(c[0],c[1],c[2]);n&&void 0===_._rtreeFeatureScale&&(_._rtreeFeatureScale=L),s.posSize.center.set(l[0],l[1],p),0===n?(s.posSize.width=2*e.getAttribute("radius"),s.posSize.length=s.posSize.width,s.posSize.height=L.z,s.posSize.altitude=p,i.qtClusterBbox=e.getAttribute("bbox")):(s.posSize.width=L.y,s.posSize.length=L.x,s.posSize.height=L.z,s.posSize.altitude=p);var V=Number(_.heightAttribute);isNaN(V)&&(V=Number(e.getAttribute(_.heightAttribute))),isNaN(V)&&(V=0),1===n&&i.rtree.insert({x:l[0],y:l[1],z:p+V,w:1,h:1,mag:_._magnitude?parseInt(e.getAttribute(_._magnitude)):1,infos:{strid:h,altitude:p,height:V}});var O,N={name:d,strid:h,styleClass:F,altitude:p,height:V,localScale:[L.x,L.y,L.z],orientation:g,attributes:u,material:v},U={name:d,strid:h,styleClass:F,altitude:p,height:V,localScale:[L.x,L.y,L.z],orientation:g,attributes:u,material:v};if(void 0!==_.styleClass&&_.styleClass===N.styleClass||(_.styleClass=N.styleClass),1===n){if(N.localScale=[L.x,L.y,L.z],O=i.clusterSet.addPointOfInterest(new t.Vector3(l[0]-m.x,l[1]-m.y,0),U),N.localScale=[L.x,L.y,L.z],O=i.leafSet.addPointOfInterest(new t.Vector3(l[0]-m.x,l[1]-m.y,0),N),!_._billboardCSSMaploaded&&_.isBillboard()){_._billboardCSSMaploaded=!0;let e=new o(_.urban,_.factoryParam,i);e.initBillboardCSSMap(),a.is(N.mapUrl)&&e.initBillboardMap(N),e.loadBillboardMap()}}else O=i.poiSet.addPointOfInterest(new t.Vector3(l[0]-m.x,l[1]-m.y,0),N);_.nbFeature++,i.nbPoi++;var E=new t.Vector3(l[0]-m.x,l[1]-m.y,p+V);if(0===n&&_.displayClusterHits){var k=_._generateTextOpti(E,e.getAttribute("nhits"),N.strid,!0);k.setFrustumCulled(!1),a.is(i.namingMeshes)||(i.namingMeshes=[]),i.namingMeshes.push(k)}if(_._shouldCreateLabelFromMaterial(v)&&0!==n){var z={};z=a.is(O)?"billboard"===_.factoryParam.shapeType?{width:O.x,length:O.z,height:O.y}:{width:O.y,length:O.x,height:O.z}:{width:0,length:0,height:0},a.is(i.labelMeshes)||(i.labelMeshes=[]);let t=a.generateLabelPriorities(_._node,e);i.labelsNode||(i.labelsNode=new r,i.labelsNode.name="labelsMeshes"),i.labelMeshes.push(_._generateLabel(E,N.strid,v,z,i.posTile,t,i.labelsNode))}};if(v.type===l.Type.MULTIPOINT)for(let e=0;e<u.length;e++)y(u[e]);else y(u)}},_generateTextUsingLabel:function(e,t,i,r,s){var n=this._rendering.getCompleteMaterialInfo(i);n.label.name=t;var a=this._generateLabel(e,i,n,r);if(a.setFrustumCulled(!1),!0===s)return a;this.infoNode.setVisibility(!0),this.infoNode.addChild(a)},_generateTextOpti:function(e,i,r,s){var n={styleClass:this.styleClass,pClass:"poiText",samplingFactor:this.samplingFactor},a=o.generateTextNodeOpti(this.urban,i,n);if(a.name="textNode_"+r,a.setMatrix((new t.Matrix4).translate(new t.Vector3(e.x,e.y,e.z))),!0===s)return a;this.infoNode.setVisibility(!0),this.infoNode.addChild(a)},_generateTextMesh:function(e,i,r,s){s.name="textNode_"+r,s.setMatrix((new t.Matrix4).translate(new t.Vector3(e.x,e.y,e.z)));var n=new t.TextGeometry(i,{font:"arial nova"}),a=new t.Mesh(n),o=m.createNodeFromTHREEMesh(a);s.add(o)},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1},removeAllInfoNodes:function(e,t){t||(this.infoNode.removeChildren(),this.nbSelectedNode=0,this.infoNode.setVisibility(!1))},attributeSetter:{color:"setColor",opacity:"setOpacity"},setGeomAttribute:function(e,t,i){if(e)for(var r=0;r<e.length;r++){var s=THREEDS.SubElement.getFromSGNode(e[r].subElement);e[r].mesh[this.attributeSetter[t]](i,[s.sgNode,e[r].strid])}},getDatas:function(e){var t=[];t[0]={attributes:e.userData,target:e.geom};for(var i=0;i<t[0].target.length;++i)t[0].target[i].strid=e.strid;return t},getGeoJSON:function(e){return this.geoJSON[e]},_computeLabelPos:function(e,t){t||(t=this._rendering.getCompleteMaterialInfo(e._getStrid(),e.userData));var i=a.cloneRecKeepingClasses(e.getLocalPosition()),r=this._computeAltitudeToApply(t,i.toArray()),s=Number(this.heightAttribute);return isNaN(s)&&(s=Number(e.userData[this.heightAttribute])),isNaN(s)&&(s=0),i.z=r+s,this._patchZPositionProjection(i),i},_computeGeometrySize:function(e,t){var i=this._getPrimInfo(e).posSize,r={width:i.width,length:i.length,height:i.height};if("billboard"===this.factoryParam.shapeType){t||(t=this._rendering.getCompleteMaterialInfo(e._getStrid(),e.userData));var s=this._rendering,n=s.getTextureInfo(t.mapUrl);a.is(n)||(t=(s=this._leafSetRendering).getCompleteMaterialInfo(e._getStrid(),e.getUserData()),n=s.getTextureInfo(t.mapUrl));var o=n.width;a.is(n.atlasWidth)&&(o*=n.atlasWidth);var l=n.height;a.is(n.atlasHeight)&&(l*=n.atlasHeight),r.width*=o,r.height*=l}return r},_getPrimInfoFromPreview:function(e){if(a.is(this._node.userData.getContent()._poiSet)&&a.is(this._node.userData.getContent()._poiSet.primInfos))return this._node.userData.getContent()._poiSet.primInfos[e]}})}),define("DS/XCityGeometry/PatchVectorFactoryElement",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/XCityGeometry/PatchVectorFactoryPointGeometry","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/XCityTools/PrimitiveGeometryCreator","DS/XCityRendering/RenderingHandlerElement","DS/XCityLayer/Vector","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils","DS/XCityTools/RenderingTools","DS/XCityTools/Downloader","DS/XCityTools/Pooler"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m){"use strict";return i.extend({init:function(t,i,s){this._parent(t,i),this.urban=t,this.param=i,this.name=void 0!==i.name?i.name:"Element",this.offset=void 0!==i.offset?Number(i.offset):0,this.altitudeAttribute=void 0!==i.altitudeAttribute?i.altitudeAttribute:"ALTITUDE",this.orientationAttribute=void 0!==i.orientationAttribute?i.orientationAttribute:"ORIENT",this.stridAttribute=void 0!==i.stridAttribute?i.stridAttribute:"STRID",this.colorAttribute=void 0!==i.colorAttribute?i.colorAttribute:"COLOR",this.scaleAttribute=void 0!==i.scaleAttribute?i.scaleAttribute:"SCALE",this.filenameAttribute=void 0!==i.filenameAttribute?i.filenameAttribute:"FILENAME",this.urlOptions="",this._ready=!1,this._editable=!0,this.forceAltitude=i.forceAltitude,this.isPickable=void 0===i.isPickable||i.isPickable,this.instancing=!0,this.centerVec=new e.Vector3,this.scaleVec=new e.Vector3,this._posSize=[],this._parentId=f.getUuidFromUrl(s),this._options=f.getUrlOptions(s),this.nbMesh=0,this.oldLoading=!1,this._rendering=new l(t,i),this._rendering.setInstancing(this.instancing),this._rendering.addDefaultAltitudeFromAttributes(this.forceAltitude,this.altitudeAttribute),this._node=new r,this._node.name="FactoryElement",this._node.hwInstancing=this.urban.USR.hwInstancing,this.tileNodes=[],u.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},loadResources:function(){var e=f.getDataSupplierUrl()+this._parentId+"/resources/index.json"+this._options;f.download(e,{responseType:"json"},999999,function(e,t,i,r){r(t,e,i)},void 0,function(e,t,i){if(t){var r=["3dxc","json"],n=[];if(e instanceof Array&&e.length>=1)for(var a=0;a<e.length;a++){var o=e[a].substr(e[a].lastIndexOf(".")+1);r.indexOf(o)>-1&&(n.push(e[a]),this.nbMesh++)}this._renderingMesh=[],this._renderingMesh.length=this.nbMesh;for(var h=0;h<this.nbMesh;++h)this._renderingMesh[h]=new l(this.urban,this.param,this._rendering),this._rendering.addSubRenderingHandler(this._renderingMesh[h]);this.modelMesh3d=[],this.modelMesh3d.length=this.nbMesh,this.matrixMesh3d=[],this.matrixMesh3d.length=this.nbMesh;var d=0;this.indexMesh={};var p={},g=this._options;for(this._posSize.length=this.nbMesh,0===this.nbMesh&&(this._ready=!0),h=0;h<this.nbMesh;++h)v=f.getDataSupplierUrl()+this._parentId+"/resources/"+n[h],_=n[h],this.indexMesh[_]=h,p[h]=_,this.urban.modelLoader.load({url:v,urlOptions:g,rendering:this._renderingMesh[h]},function(e,t,i){if(!t)return u.publish(u.eventsList.onLoaded+":"+this._parentId,{success:!1}),void console.warn("Model not loaded "+i);var r=e.bSphere;r=e._bsShow,c.is(r)||(r=e.bSphere);var n=e.bBox;n=e._bbShow,c.is(n)||(n=e.bBox);for(var a=-1,o=0;o<this.nbMesh;++o)if(p[o]===e.name&&void 0===this.modelMesh3d[o]){a=o;break}this._posSize[a]={center:r.center.clone(),radius:r.radius,altitude:n.min.z,height:n.max.z-n.min.z,width:n.max.y-n.min.y,length:n.max.x-n.min.x},e.traverse(function(t){t instanceof s&&(t.name=e.name,this.modelMesh3d[a]=new m(t.clone.bind(t,!0)),this.matrixMesh3d[a]=t.getMatrix(),++d===this.nbMesh&&(this._ready=!0))}.bind(this));var l=c.getAllMaterials(e);if(c.is(l)){var h=c.getMainMaterial(l);this._renderingMesh[a].copyMaterial(h),this._renderingMesh[a].addToDefaultMaterial(h)}}.bind(this))}else{this.nbMesh=1,this.oldLoading=!0,this._renderingMesh=[],this._renderingMesh.length=this.nbMesh,this._renderingMesh[0]=new l(this.urban,this.param,this._rendering),this._rendering.addSubRenderingHandler(this._renderingMesh[0]),this.modelMesh3d=[],this.modelMesh3d.length=this.nbMesh,this.matrixMesh3d=[],this.matrixMesh3d.length=this.nbMesh;var v=this.param.url,_="model";d=0,this.indexMesh={},p={},g=this._options,this.indexMesh[_]=0,p[0]=_,this.urban.modelLoader.load({url:v,urlOptions:g,rendering:this._renderingMesh[0]},function(e,t,i){if(!t)return u.publish(u.eventsList.onLoaded+":"+this._parentId,{success:!1}),void console.warn("Model not loaded "+i);var r=e.bSphere;r=e._bsShow,c.is(r)||(r=e.bSphere);var n=e.bBox;n=e._bbShow,c.is(n)||(n=e.bBox),this._posSize.length=1,this._posSize[0]={center:r.center.clone(),radius:r.radius,altitude:n.min.z,height:n.max.z-n.min.z,width:n.max.y-n.min.y,length:n.max.x-n.min.x},e.traverse(function(t){t instanceof s&&(t.name=e.name,this.modelMesh3d[0]=new m(t.clone.bind(t,!0)),this.matrixMesh3d[0]=t.getMatrix(),++d===this.nbMesh&&(this._ready=!0))}.bind(this));var a=c.getAllMaterials(e);if(c.is(a)){var o=c.getMainMaterial(a);this._renderingMesh[0].addToDefaultMaterial(o)}}.bind(this))}}.bind(this))},destroy:function(){this.urban.getView3D().getScene().remove(this._node)},isReady:function(){return this._ready||this._loadingResources||(this.loadResources(),this._loadingResources=!0),this._ready},dispose:function(){d.warn("Dispose: UrbanElement")},_getOptions:function(e){var t=e.split("?");return 2===t.length?"?"+t[1]:""},getData:function(t){var i=new r;if(i.name=t.tile.LOD+"_"+t.tile.I+"_"+t.tile.J+"_"+this.name,t.nbTotal>0){i.setMatrix((new e.Matrix4).identity().setPosition(new e.Vector3(t.posTile.x,t.posTile.y,0))),this.isPickable?i.setPickable(a.PICKABLE):i.setPickable(a.NOPICKABLE);for(var s,n=function(e,t){var i=this.mesh3js.instanceAttribArrays.instanceFlag.array,r=this.mesh3js.userData.cgmIds.indexOf(t),s=i[r],n=i[r];(s=c.floatPack(s,2,!e))!==n&&(i[r]=s,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0)},o=function(e,t,i){var r=this.mesh3js.instanceAttribArrays.instanceFlag.array[h=this.mesh3js.userData.cgmIds.indexOf(i)],s=e.color;c.is(s)&&c.is(s.computeColor)&&(s=s.computeColor());var n,a=e.opacity,o=c.is(s),l=c.is(a);if(r=c.floatPack(r,0,o),r=c.floatPack(r,1,l),!0===this.isInstanceNode3D){var h=this.mesh3js.userData.cgmIds.indexOf(i),d=this.mesh3js.instanceAttribArrays.instanceColor.array;n=4*h,o&&(d[n]=s.r,d[n+1]=s.g,d[n+2]=s.b),l&&(d[n+3]=a),this.mesh3js.instanceAttribArrays.instanceColor.isDynamic=!0,this.mesh3js.instanceAttribArrays.instanceFlag.array[h]=r,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0}},l=0;l<this.nbMesh;++l)if(t.instanceMesh[l].nbElement>0){(s=this.modelMesh3d[l].use()).mesh3js.name=s.name,s.indexMesh=l,s.setRendering=o,s.setVisible=n,this._renderingMesh[l].initMesh(s),s.material.transparent=t.transparent,i.add(s);var h={data:t.instanceMesh[l].instanceMatrix,type:"m4",attribName:"instanceMatrix"},d={data:t.instanceMesh[l].instanceColor,type:"v4",attribName:"instanceColor"},u={data:t.instanceMesh[l].instanceFlag,type:"f",attribName:"instanceFlag"};s.mesh3js.userData.cgmIds=t.instanceMesh[l].instanceCgmId,s.setInstancingParameters(t.instanceMesh[l].nbElement,[h,d,u]);for(var p=0;p<s._occurrences.length;p++)s._occurrences[p].renderable.userData.cgmIds=t.instanceMesh[l].instanceCgmId;var f=new e.Sphere;f.radius=Math.sqrt(Math.pow(t.minMax.maxX-t.minMax.minX,2)+Math.pow(t.minMax.maxY-t.minMax.minY,2)+Math.pow(t.minMax.maxZ-t.minMax.minZ,2))/2,f.center.x=(t.minMax.minX+t.minMax.maxX)/2,f.center.y=(t.minMax.minY+t.minMax.maxY)/2,f.center.z=(t.minMax.minZ+t.minMax.maxZ)/2,s.forceBoundingSphere(f)}this.addLabelsToNode(t,i)}return i},buildOne:function(t,i,r){var s=function(t,i,r,s,n,a,o,l,h,d,u){Math.cos(a),Math.sin(a);var p=new e.Matrix4;p.identity(),p.translate(this.centerVec.set(r,s,n));var f=a;p.rotateZ(f),c.is(h)&&p.scale(h);var m=new e.Matrix4;m.identity(),m.multiplyMatrices(p,this.matrixMesh3d[u]);var g=new e.Vector4(o.r,o.g,o.b,l);t.instanceMesh[u].instanceMatrix[t.instanceMesh[u].nbElement]=m,t.instanceMesh[u].instanceColor[t.instanceMesh[u].nbElement]=g,t.instanceMesh[u].instanceFlag[t.instanceMesh[u].nbElement]=d,t.instanceMesh[u].instanceCgmId[t.instanceMesh[u].nbElement]=i,r+this._posSize[u].center.x-this._posSize[u].radius<t.minMax.minX&&(t.minMax.minX=r+this._posSize[u].center.x-this._posSize[u].radius),r+this._posSize[u].center.x+this._posSize[u].radius>t.minMax.maxX&&(t.minMax.maxX=r+this._posSize[u].center.x+this._posSize[u].radius),s+this._posSize[u].center.y-this._posSize[u].radius<t.minMax.minY&&(t.minMax.minY=s+this._posSize[u].center.y-this._posSize[u].radius),s+this._posSize[u].center.y+this._posSize[u].radius>t.minMax.maxY&&(t.minMax.maxY=s+this._posSize[u].center.y+this._posSize[u].radius),n+this._posSize[u].center.z-this._posSize[u].radius<t.minMax.minZ&&(t.minMax.minZ=n+this._posSize[u].center.z-this._posSize[u].radius),n+this._posSize[u].center.z+this._posSize[u].radius>t.minMax.maxZ&&(t.minMax.maxZ=n+this._posSize[u].center.z+this._posSize[u].radius),t.instanceMesh[u].nbElement++,t.nbTotal++}.bind(this),n=t.getGeometry();if(n.type===h.Type.POINT){var a,o,l,d,u,f,m,g;a=t.getAttribute(this.stridAttribute),o=n.getVertices(),c.is(this.scaleAttribute)&&c.is(t.getAttribute(this.scaleAttribute))&&(g=p._initVector3(t.getAttribute(this.scaleAttribute))),l=(l=t.getAttribute(this.orientationAttribute))?l.split(" "):[0,0,0],d=new e.Color(t.getAttribute(this.colorAttribute)||16777215),u=1,void 0===i.creator&&(i.creator=[],i.nbElement=0,i.nbTotal=0);var v=-1;if(this.oldLoading)v=0;else{var _=t.getAttribute(this.filenameAttribute);if(_){if(-1===_.indexOf(".")&&(_+=".3dxc"),null==(v=this.indexMesh[_]))return}else{if(!(Object.keys(this.indexMesh).length>0))return;v=0}}r.indexMesh=v;var y=this._renderingMesh[v].getCompleteMaterialInfo(a,t.attributes);if(f=this._computeAltitudeToApply(y,o),void 0===i.posTile){i.posTile=new e.Vector2(Math.round(o[0]),Math.round(o[1])),i.instanceMesh=[],i.instanceMesh.length=this.nbMesh;for(var b=0;b<this.nbMesh;++b)i.instanceMesh[b]={},i.instanceMesh[b].instanceMatrix=[],i.instanceMesh[b].instanceCgmId=[],i.instanceMesh[b].instanceColor=[],i.instanceMesh[b].instanceFlag=[],i.instanceMesh[b].nbElement=0;i.minMax={minX:99999999.9,minY:99999999.9,minZ:99999999.9,maxX:-99999999.9,maxY:-99999999.9,maxZ:-99999999.9}}m=i.posTile,r.posSize.center.set(o[0],o[1],f).add(this._posSize[v].center),r.posSize.width=this._posSize[v].width,r.posSize.length=this._posSize[v].length,r.posSize.height=this._posSize[v].height,r.posSize.altitude=f+this._posSize[v].altitude;var x=t.attributes,C=this._renderingMesh[v].getPrimitiveRenderingValues(a,x);c.is(C)&&(c.is(C.color)&&(d=C.color.computeColor()),c.is(C.opacity)&&(u=C.opacity),c.is(C.scale)&&g.copy(C.scale));var S=!1;(u<1||!0===y.transparent)&&(S=!0),i.transparent||(i.transparent=S);var D=this._renderingMesh[v].getFlagForPrimitive(a,t.attributes);if(s(i,a,o[0]-m.x,o[1]-m.y,Number(f),(Number(l[0])+this.offset)*Math.PI/180,d,u,g,D,v),this._shouldCreateLabelFromMaterial(y)){var P=new e.Vector3(o[0]-m.x,o[1]-m.y,Number(f));c.is(i.labelMeshes)||(i.labelMeshes=[]);let s=c.generateLabelPriorities(this._node,t);i.labelMeshes.push(this._generateLabel(P,a,y,r.posSize,void 0,s))}}},setAttribute:function(){return!1},updateAttribute:function(){return!1},attributeSetter:{color:"setColor",opacity:"setOpacity"},setGeomAttribute:function(e,t,i){if(e)for(var r=0;r<e.length;r++){var s=THREEDS.SubElement.getFromSGNode(e[r].subElement);e[r].mesh[this.attributeSetter[t]](i,[s.sgNode])}return this},getDatas:function(e){var t,i=[];for(t=0;t<e.geom.length;t+=1)i.push({attributes:e.datas,target:[e.geom[t]]});return i}})}),define("DS/XCityRendering/RenderingHandlerProxy",["DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerAltitude","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering","DS/XCityRendering/FeatureRendering","DS/XCityRendering/Rendering"],function(e,t,i,r,s,n){"use strict";return t.extend({init:function(e,t,i){this._parent(e,t,i),this.instancing=!1,this.type="Proxy",this._subRenderingHandler=void 0},setInstancing:function(e){this.instancing=e},getDefaultRendering:function(){return Object.assign({},this._parent())},setContent:function(e){if(this._content=e,e._poiSet)this._subRenderingHandler[e.get("SUB_REND_HANDLER_POINT_INDEX")].setContent(e._poiSet),this._subRenderingHandler[e.get("SUB_REND_HANDLER_LINE_INDEX")].setContent(e._lineSet),this._subRenderingHandler[e.get("SUB_REND_HANDLER_POLY_INDEX")].setContent(e._polygonSet);else for(var t=0;t<this._subRenderingHandler.length;++t)this._subRenderingHandler[t].setContent(e)},_initMaterial:function(){},hasAttribute:function(t){if(e.is(this.defaultRendering)&&void 0!==this.defaultRendering.get(t))return!0;if(this._subRenderingHandler){for(var i=!1,r=0;r<this._subRenderingHandler.length;++r)i=i||this._subRenderingHandler[r].hasAttribute(t);return i}return!1},addToDefaultMaterial:function(e){this.defaultRendering.addOver(e)},addDefaultAltitudeFromAttributes:function(t,s){if(e.is(t))this.defaultRendering.set("elevation",t);else{var n=(new i).propertyName(s),a=new r(null,null,{elevation:n});a.addOverIds("3DXCityDefaultIDdefaultElevationAttributeElement"),this.defaultRendering.addOver(a)}},applyRendering:function(e){if(this._parent(e),this._subRenderingHandler&&e&&e.children)for(var t=0;t<this._subRenderingHandler.length;++t)for(var i=0;i<e.children.length;++i)e.children[i].indexMesh===t&&this._subRenderingHandler[t].applyRendering(e.children[i])},updateMesh:function(t){if(e.is(t)){t.parents[0];this._subRenderingHandler&&t.indexMesh>-1&&t.indexMesh<this._subRenderingHandler.length?this._subRenderingHandler[t.indexMesh].initMesh(t):this.initMesh(t)}},updateRendering:function(e){this._parent(e),this.updateOtherRenderings(e)},updateOtherRenderings:function(e){if(this._subRenderingHandler)for(var t=0;t<this._subRenderingHandler.length;++t){let i=new s;i.copy(e),this._subRenderingHandler[t].updateRendering(i)}},addSubRenderingHandler:function(e,t){this._subRenderingHandler||(this._subRenderingHandler=[]),Number.isFinite(t)?this._subRenderingHandler.splice(t,0,e):this._subRenderingHandler.push(e)},isPrimitiveRegistered:function(e){var t=!1;if(this._subRenderingHandler)for(var i=0;i<this._subRenderingHandler.length;++i)t=t||this._subRenderingHandler[i].isPrimitiveRegistered(e);return t},needsRebuild:function(){var e=this._needRebuild;if(this._subRenderingHandler)for(var t=0;t<this._subRenderingHandler.length;++t)e=e||this._subRenderingHandler[t].needsRebuild();return e},flagAsRebuilt:function(e){if(this._needRebuild=!e,this._subRenderingHandler)for(var t=0;t<this._subRenderingHandler.length;++t)this._subRenderingHandler[t].flagAsRebuilt(e)},registerPrimitive:function(t,i){if(e.is(i)&&this._subRenderingHandler)for(var r=0;r<this._subRenderingHandler.length;++r)this._subRenderingHandler[r].registerPrimitive(this._subRenderingHandler[r]._content._patch,i)},updatePrimitiveRendering:function(e){if(this._parent(e),this._subRenderingHandler)for(var t=0;t<this._subRenderingHandler.length;++t)this._subRenderingHandler[t].updatePrimitiveRendering(e)},_renderprimitive:function(e){if(this._subRenderingHandler)for(var t=0;t<this._subRenderingHandler.length;++t)this._subRenderingHandler[t]._renderprimitive(e)},getIds:function(){var t=[];if(this._subRenderingHandler)for(var i=0;i<this._subRenderingHandler.length;++i){var r;if(e.is(this._subRenderingHandler[i]._content))e.is(this._subRenderingHandler[i]._content._itemParent)&&(r=this._subRenderingHandler[i]._content._itemParent.get("id"),e.is(r)&&0===t.length&&t.push(r)),r=this._subRenderingHandler[i]._content.get("id"),e.is(r)&&t.push(r)}else e.is(this._content)&&(e.is(this._content._itemParent)&&(r=this._content._itemParent.get("id"),e.is(r)&&t.push(r)),r=this._content.get("id"),e.is(r)&&t.push(r));if(e.is(this._content)){var s=this._content.get("renderID");e.is(s)&&""!==s&&t.push(s)}return e.is(this.type)&&t.push(this._prefix+this.type),e.is(this._allIds)&&t.push(this._allIds),t},getCompleteMaterialInfo:function(e,t){var i=this.defaultRendering.getCompleteMaterialInfo(e,t),r=new n(i);if(this._subRenderingHandler)for(var s=0;s<this._subRenderingHandler.length;++s){let i=this._subRenderingHandler[s].getCompleteMaterialInfo(e,t);r.addOver(i)}return r.getRenderingData()}})}),define("DS/XCityRendering/RenderingHandlerCrossQuad",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityRendering/RenderingHandlerAltitude","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering","DS/XCityTools/RenderingTools"],function(e,t,i,r,s,n,a){"use strict";var o=r.extend({init:function(e){this._parent(e),this.type="Crossquad",this.atlasSize={x:4,y:4}},getDefaultRendering:function(){return Object.assign({},this._parent(),{side:e.DoubleSide,forceSide:!0,alphaTest:.5,mapUrl:null})},_initMaterial:function(){if(!t.is(this._material)){this._material=i.getPDSFXMaterial([o._crossquad_PDSFX],"physical");var e=this.defaultRendering.getRenderingData();a._setMaterialFromProfile(this._material,e),i.updateCommonUniforms(this._material)}return this._material},addDefaultAltitudeFromAttributes:function(e,i){if(t.is(e))this.defaultRendering.set("elevation",e);else{var r=(new s).propertyName(i),a=new n(null,null,{elevation:r});a.addOverIds("3DXCityDefaultIDdefaultElevationAttributeCrossquad"),this.defaultRendering.addOver(a)}},onTextureDownloadStart:function(e,t,i){e.updatePDSFXUniform("useMapCity",!0),e.updatePDSFXUniform("mapCityLoaded",!1)},onTextureApplied:function(e,t,i,r){e&&(t.updatePDSFXUniform("useMapCity",!0),t.updatePDSFXUniform("mapCityLoaded",!0))}});return o._crossquad_PDSFX={attributes:{},uniforms:{atlasSize:{type:"v2",value:new e.Vector2(4,4)},mapCity:{type:"t2",value:i.whiteMap},useMapCity:{type:"b",value:!1},mapCityLoaded:{type:"b",value:!0},diffuseCity:{type:"c",value:new e.Color(16711680)},opacityCity:{type:"f",value:1},alphaTestCity:{type:"f",value:.5}},varyings:{vInstanceColor:{type:"v4",value:new e.Vector4(1,1,1,1)},l_useColor:{type:"f",value:0},l_useOpacity:{type:"f",value:0},l_visibility:{type:"f",value:0},texCoordCity:{type:"v2",value:new e.Vector2(0,0)}},VS_global_code:["float getFlag(float flags, float row){","    float res = mod(flags, row*2.0); ","    if(res >= row){","       return 1.0;","   }","   return 0.0; ","}"].join("\n"),VS_overridableFunctions:{ComputeObjectPosition:["vec3 instancePosition = vGetAttribPosition();","vec4 newPosition = instanceMatrix * vec4(instancePosition,1.0);","return newPosition.xyz;"].join("\n"),ComputeObjectNormal:["vec3 norm = mat3(cos(instanceRotation), sin(instanceRotation), 0,","-sin(instanceRotation), cos(instanceRotation), 0,","0,0,1) * vGetAttribNormal();","return norm.xyz;"].join("\n"),ComputeObjectTexCoord0:["float instanceID = float(vGetInstanceID());","float indexTexture = instanceIndexTexture;","float startX = mod(indexTexture,atlasSize.x)/atlasSize.x;","float startY = floor(indexTexture/atlasSize.x)/atlasSize.y;","return vec4(vGetAttribTexCoord0().xy/atlasSize + vec2(startX, startY), 0.0, 0.0);"].join("\n"),ComputeVaryingValues:["vInstanceColor = instanceColor.xyzw;","float flags = instanceFlag;","l_useColor = getFlag(flags, 1.0);","l_useOpacity = getFlag(flags, 2.0);","l_visibility = getFlag(flags, 4.0);","","float instanceID = float(vGetInstanceID());","float indexTexture = instanceIndexTexture;","float startX = mod(indexTexture,atlasSize.x)/atlasSize.x;","float startY = floor(indexTexture/atlasSize.x)/atlasSize.y;","texCoordCity = vec2(vGetAttribTexCoord0().xy/atlasSize + vec2(startX, startY));"].join("\n")},FS_global_code:["vec4 _texelCity = vec4(1.0);","float _alphaCity = 1.0;","vec3 colorInstance= vec3(1.0,1.0,1.0);","float opacityInstance = 1.0;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["if (useMapCity && mapCityLoaded) {","_texelCity = texture2D(mapCity, texCoordCity.xy);","_alphaCity = _texelCity.w;","","}","colorInstance = diffuseCity;","if (l_useColor > 0.5) {","colorInstance = vInstanceColor.xyz;","}","opacityInstance = opacityCity;","if (l_useOpacity > 0.5) {","opacityInstance = vInstanceColor.w;","}",""].join("\n"),ComputeAlbedo:["return colorInstance*_texelCity.xyz;"].join("\n"),__ComputeDiffuseTexel:["return vec4(_texelCity.xyz, 1.0);"].join("\n"),__ComputeSpecularReflectance:["return vec3(0.0);"].join("\n"),ComputeOpacity:["if (l_useOpacity < 0.5) {","return _DSopacity_ / _alphaCity;","}","else {","return _DSopacity_*vInstanceColor.w/(opacityCity*_alphaCity);","}"].join("\n"),ComputeDiscard:["if (_alphaCity < alphaTestCity || (useMapCity && !mapCityLoaded) || l_visibility > 0.5) {","return true;","}","return false;"].join("\n")}},o}),define("DS/XCityRendering/RenderingHandlerBuilding",["DS/Visualization/ThreeJS_DS","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/XCityRendering/RenderingHandlerAltitude","DS/XCityRendering/BuildingTdbStore","DS/XCityRendering/BuildingTdbAtlas","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering","DS/Plugins/RenderPass","DS/xCityBasicUtils/ColorGradient","DS/XCityRendering/RenderingHandlerLine"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p){"use strict";var f=r.extend({init:function(e,t){this._parent(e),this.urban=e,this.material2update=[],this.animationMaterials={},this.animationTime=-1,a.subscribeTo("/3DEXPERIENCity/onUpdate",this._update.bind(this)),this.isInWebWorkers="webworkerstitle"===self.document.title,this.rasterId="",this.rasterMinlvl=-1,t&&(t.rasterId&&(this.rasterId=t.rasterId),t.rasterMinlvl&&(this.rasterMinlv=t.rasterMinlv)),this._defineRenderPass(),this.savedParam=t,this._initStores(this.savedParam),this.type="Building"},_attributesforRebuild:["extrusionHeight","stroke"],shouldRebuild:function(e,t){if(this._parent(e,t))return!0;var i,r=this._attributesforRebuild,s=r.length,n=!1;for(i=0;i<s;i++){var a=r[i],l=e.hasDatavizOnAttribute(a),h=t.hasDatavizOnAttribute(a);if(l||h){n=!0;break}if(l=e.get(a),h=t.get(a),!1===o.simpleJSONCompare(l,h)){n=!0;break}}return n},getDefaultRendering:function(){return this._defaultStrokeParameters={enable:!1,color:new c(new e.Color("#000000")),ambient:new c(new e.Color("#000000")),diffuse:new c(new e.Color("#000000")),lineWidth:2,dashPattern:null},Object.assign({},this._parent(),{wallTexturesUrl:null,roofTexturesUrl:null,r_mode:-1,extrusionHeight:10,renderMode:"occluded",opacityFactor:.5,stroke:this._defaultStrokeParameters})},_initStores:function(e){var t=this.getCompleteMaterialInfo();if(this.isInWebWorkers)this.tdbStore={};else if(o.is(this.tdbStore)||(this.tdbStore=new s(this.urban,"XCityEnvironment/assets/textures/buildings/white.jpg")),this.tdbStore.atlasBaseURL!==t.wallTexturesUrl){var i=t.wallTexturesUrl;o.is(i)||(i=void 0),this.tdbStore.atlasBaseURL=i}o.is(this.roofAtlas)||(this.roofAtlas=new n(this.urban,"roof",e)),this.roofAtlas._atlasBaseURL!==t.roofTexturesUrl&&(o.is(t.roofTexturesUrl)?this.roofAtlas.loadAtlas(t.roofTexturesUrl,function(e){e||l.warn("Unable to load roof atlas...")}.bind(this)):o.is(this.roofAtlas._atlasBaseURL)&&this.roofAtlas.dispose())},isInLineMode:function(){var e=this.getCompleteMaterialInfo();return!(!o.is(e.geometricMode)||"line"!==e.geometricMode)},updateRendering:function(e){this._parent(e);this._initStores(this.savedParam),this.updateStrokeRendering(e)},updatePrimitiveRendering:function(e){if(this._parent(e),!o.is(this._strokeRenderingHandler))this.getStrokeHandler();o.is(this._strokeRenderingHandler)&&this._strokeRenderingHandler.currentRendering.addOver(e)},updateStrokeRendering:function(e){if(!o.is(this._strokeRenderingHandler))this.getStrokeHandler();if(o.is(this._strokeRenderingHandler)){var t=this.defaultRendering.getStrokeFeatureRendering(),i=this.getFeatureRendering();t.set("renderMode",i.get("renderMode")),this._strokeRenderingHandler.defaultRendering.addOver(t),o.is(e)&&(e=e.getStrokeFeatureRendering()),delete this._strokeRenderingHandler.defaultRendering.renderingData.map,delete this._strokeRenderingHandler.defaultRendering.renderingData.mapParams,delete this._strokeRenderingHandler.defaultRendering.renderingData.mapUrl,this._strokeRenderingHandler.updateRendering(e)}},_update:function(e){this._updateAnimationUniforms(e);for(var t,i=this.material2update.length;i--;)for(t=this.material2update[i].callback.length;t--;)this.material2update[i].callback[t](this.material2update[i].material)},_enable:function(e,t){var i=function(e){for(var t=this.material2update.length;t--;)e===this.material2update[t].material&&this.material2update.splice(t,1)}.bind(this);if(void 0!==e&&void 0!==t){for(var r=-1,s=this.material2update.length;s--;)e===this.material2update[s].material&&(r=s);-1===r&&(r=this.material2update.length,this.material2update.push({material:e,callback:[]}),void 0===e.observers&&(e.observers=[]),e.observers.push(i));for(var n=0;n<t.length;++n)void 0!==t[n]&&this.material2update[r].callback.push(t[n])}},dispose:function(){l.warn("Dispose: RenderingHandlerBuilding"),void 0!==this.roofAtlas&&(this.roofAtlas.dispose(),this.roofAtlas=void 0),void 0!==this.tdbStore&&(this.tdbStore.dispose(),this.tdbStore=void 0),this._parent()},_initMaterial:function(){return o.is(this._material)||(this._material=t.getCustomShaderMaterial([t.common,t.vertexInformation,t.clipPlanes,f._building,t.urbanLights,t.shadowMapCustom])),this.material},_getCommonShaderStructure:function(){var i={b_infoTexture:{type:"t2",value:t.whiteMap},extrusionFactor:{type:"f",value:1},diffuseCity:{type:"c",value:new e.Color(16711680)},opacityCity:{type:"f",value:1},alphaTestCity:{type:"f",value:.5}},r={b_color:{type:"v4",value:new e.Vector4(0,0,0,1)},b_flag:{type:"f",value:0}},s=["float b_rgba2float( vec4 color ) {","    return dot( color, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/16581375.0) );","}","float b_rgba2int( vec4 color ) {","    return ( 255.0 * ( color.r + (color.g*255.0) + (color.b*65025.0) + (color.a*16581375.0) ) );","}","float getLastBit( float flags ){","    return mod( flags, 2.0 ); ","}"].join("\n"),n={ComputeObjectPosition:["float b_pixPerRow = b_rgba2int( texture2D( b_infoTexture, vec2( 0.0, 0.0 ) ) );","float b_nbBuilding = b_rgba2int( texture2D( b_infoTexture, vec2( 1.5/b_pixPerRow, 0.0 ) ) );","float b_indice = (vGetAttribTexCoord0().x + .5)/b_nbBuilding;","float b_altitude = b_rgba2int( texture2D( b_infoTexture, vec2( 2.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 3.5/b_pixPerRow, b_indice ) ) );","vec3 vertexposition = vGetAttribPosition();","float buildingheight = vertexposition.z - b_altitude;","//vec3 position = vertexposition;","vec3 position = vGetAttribPosition();","float factor = extrusionFactor;","//if( buildingheight > 0.0  ) {","//  position.z = mix(position.z - buildingheight,position.z,factor);","//}","return position;"].join("\n"),ComputeVaryingValues:["float b_pixPerRow = b_rgba2int( texture2D( b_infoTexture, vec2( 0.0, 0.0 ) ) );","float b_nbBuilding = b_rgba2int( texture2D( b_infoTexture, vec2( 1.5/b_pixPerRow, 0.0 ) ) );","float b_indice = (vGetAttribTexCoord0().x + .5)/b_nbBuilding;","float b_texIndice = b_rgba2int( texture2D( b_infoTexture, vec2( 1.5/b_pixPerRow, b_indice ) ) );","float b_altitude = b_rgba2int( texture2D( b_infoTexture, vec2( 2.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 3.5/b_pixPerRow, b_indice ) ) );","b_color = texture2D( b_infoTexture, vec2( 0.0, b_indice ) );","vec4  primflags = texture2D( b_infoTexture, vec2( 17.5/b_pixPerRow, b_indice ) ) ;","float l_useColor = getLastBit(primflags.x);","primflags.x = primflags.x*0.5;","float l_useOpacity = getLastBit(primflags.x);","b_flag = 0.0;","if (l_useColor > 0.9 && l_useOpacity < 0.9) {","b_flag = 1.0;","}","else if (l_useColor < 0.9 && l_useOpacity > 0.9) {","b_flag = 2.0;","}","else if (l_useColor > 0.9 && l_useOpacity > 0.9) {","b_flag = 3.0;","}"].join("\n")},a=["vec3 colorInstance= vec3(1.0,1.0,1.0);","float opacityInstance = 1.0;"].join("\n");return{VS_overridableFunctions:n,FS_overridableFunctions:{ComputeCommonValues:["colorInstance = diffuseCity;","bool l_useColor = ((b_flag > 0.5 && b_flag < 1.5) || (b_flag > 2.5 && b_flag < 3.5));","if (l_useColor) {","colorInstance = b_color.xyz;","}","opacityInstance = opacityCity;","bool l_useOpacity = ((b_flag > 1.5 && b_flag < 2.5) || (b_flag > 2.5 && b_flag < 3.5));","if (l_useOpacity) {","opacityInstance = b_color.w;","}"].join("\n"),ComputeAlbedo:["return colorInstance;"].join("\n"),ComputeOpacity:["return opacityInstance;"].join("\n")},VS_global_code:s,FS_global_code:a,uniforms:i,varyings:r}},_initWallMaterial:function(){if(!o.is(this._wallMaterial)){var e=this._getCommonShaderStructure();this._wallMaterial=t.getPDSFXMaterial([e],"physical"),this._wallMaterial.name="building_material_wall_",this._wallMaterial.updateDeferredMaterials()}return this._wallMaterial.clone()},_initRoofMaterial:function(){if(!o.is(this._roofMaterial)){var e=this._getCommonShaderStructure();this._roofMaterial=t.getPDSFXMaterial([e],"physical"),this._roofMaterial.name="building_material_roof_",this._roofMaterial.updateDeferredMaterials()}return this._roofMaterial.clone()},roofOrthoUpdate:function(){},_getRoofMaterial:function(e){e=this._getMaterial(e);var t=this.getCompleteMaterialInfo();return t.r_mode&&e.updatePDSFXUniform("r_mode",t.r_mode),e},isanimationinprogress:function(e){},easing:function(e){var t=e-1;return(t*=t*t*t*t)+1},_updateAnimationUniforms:function(e){var t,i,r=1,s=e.clockDelta,n=Object.keys(this.animationMaterials),a=n.length;for(i=0;i<a;i++){t=n[i];var l=this.animationMaterials[t];o.is(l._initRemainingtime)&&this.animationTime>0?(l._initRemainingtime-=s,r=1-Math.max(0,l._initRemainingtime)/this.animationTime,r=this.easing(r),l.updatePDSFXUniform("extrusionFactor",r),r>=1&&delete l._initRemainingtime):(l.updatePDSFXUniform("extrusionFactor",1),delete this.animationMaterials[t])}},isStrokeMesh:function(e){return!(!o.is(e)||!o.is(e._isStroke))||!(!o.is(e.parents)||!o.is(e.parents[0]))&&this.isStrokeMesh(e.parents[0])},initMesh:function(r){if(this.isStrokeMesh(r)&&o.is(this._strokeRenderingHandler))return this._strokeRenderingHandler.initMesh(r);var s=null,n=r.name.split("_"),a=n.length;if(!(a<4)){var h,d,u,c,p;for(d=n[0],u=n[1],c=n[2],h=n[3],p=4;p<a;++p)h+="_"+n[p];if(h.contains("roof")){if(o.is(r.material)?s=r.material:(s=this._initRoofMaterial(),i._setMaterialFromProfile(s,this.getDefaultRenderingData()),this.animationMaterials[s.id]=s,s._initRemainingtime=this.animationTime),this.roofAtlas._atlasBaseURL&&""!==this.rasterId&&this.rasterMinlvl>=0){var f=parseFloat(d),m=parseFloat(u),g=parseFloat(c);m=Math.floor(m/(1<<f-this.rasterMinlvl)),g=Math.floor(g/(1<<f-this.rasterMinlvl)),f=this.rasterMinlvl,s.tile=[f,m,g];var v=this.urban.worldSize/Math.pow(2,f);s.uniforms.r_orthoData.value=this.urban.USR.viewpoint._translateToRelativePosition(new e.Vector3(m*v,g*v,v),!0),this.roofOrthoUpdate(s),this._enable(s,[this.roofAtlas.updateMaterial.bind(this.roofAtlas),this.roofOrthoUpdate.bind(this)])}s=this._getRoofMaterial(s)}else{o.is(r.material)?s=r.material:(s=this._initWallMaterial(),i._setMaterialFromProfile(s,this.getDefaultRenderingData()),this.animationMaterials[s.id]=s,s._initRemainingtime=this.animationTime),s.updatePDSFXUniform("b_infoTexture",r.textureInfo.texture),this.tdbStore.atlasBaseURL||(h="default");this.getOrDownloadTDB(h);s=this._getMaterial(s)}return s.updatePDSFXUniform("b_infoTexture",r.textureInfo.texture),s.name+=d+"_"+u+"_"+c,s.needsUpdate=!0,s.force=!0,t.updateCommonUniforms(s),r.mesh3js.material=s,r.setMaterial(s),r.setShadow(!0,!0),this.updateRenderMode(r),this._lastSeenMaterial=s,!0}l.warn("RenderingHandlerBuilding: Missing parameters to initialize meshes...")},setPassToMesh:function(e,t){if(o.is(e)&&o.is(t))switch(t){case"overlay":e.setRenderPasses(["noz"]),this.setRenderModeToMesh(e,"overlay");break;default:e.setRenderPasses(["main"]),this.setRenderModeToMesh(e,"occluded")}},cloneMesh:function(e){var t=this,i=e.clone(!0);i.setMatrix(e.getMatrix()),i.setMaterial(null),i.textureInfo=e.textureInfo,i.setRendering=e.setRendering,void 0===i.observers&&(i.observers=[]);this._rendering;return i.observers.push(function(e){t.removeMesh(i.id),delete i.textureInfo,delete i.setRendering,delete i.getColor,delete i.getOpacity}),i},createOtherMesh:function(e){if(o.is(e)){var t=this.getRenderModeFromMesh(e);if(o.is(t)){var i="occluded";switch(t){case"occluded":i="overlay";break;case"overlay":i="occluded";break;default:return void console.error(" basic rendermode ",t," unknown")}var r=this.cloneMesh(e);this.setPassToMesh(r,i),o.is(e.parents[0])&&e.parents[0].addChild(r),e.userData||(e.userData={}),e.userData.CityOtherMesh=r,r.userData||(r.userData={}),r.userData.CityOtherMesh=e,this.initMesh(r)}}},updateRenderMode:function(e){if(o.is(e)){var i=this.getCompleteMaterialInfo(),r=i.renderMode,s=e,n=!1,a=!1,l=this.getRenderModeFromMesh(s);o.is(l)||(this.setPassToMesh(e,r),l=this.getRenderModeFromMesh(s)),l!==r?(n=!1,a=!0):(n=!0,a=!1),"dual"===r&&(n=!0,a=!0,"overlay"===l&&(s.material.opacity=i.opacity*i.opacityFactor,t.updateCommonUniforms(s.material))),e.setVisibility(n),e.userData&&e.userData.CityOtherMesh?e.userData.CityOtherMesh.setVisibility(a):a&&(this.createOtherMesh(e),e.userData.CityOtherMesh.setVisibility(a))}},_defineRenderPass:function(){},getOrDownloadTDB:function(e,t){return this.tdbStore.getOrDownloadData(e,Date.now(),t)},getFlagForPrimitive:function(e,t){var i=this._parent(e,t);if(e){var r=this.getPrimitiveRenderingValues(e,t);o.is(r.extrusionHeight)&&(i+=4)}return i},addDefaultHeightAttribute:function(e){var t=(new h).propertyName(e),i=new d(null,null,{extrusionHeight:t});i.addOverIds("3DXCityDefaultIDdefaultHeightAttributeBuilding"),this.defaultRendering.addOver(i),this.getStrokeHandler().defaultRendering.addOver(i)},addDefaultAltitudeFromAttributes:function(e,t){if(o.is(t))this.defaultRendering.set("elevation",t);else{var i=(new h).propertyName(e).toNumber(),r=new d(null,null,{elevation:i});r.addOverIds("3DXCityDefaultIDdefaultElevationAttributeBuilding"),this.defaultRendering.addOver(r),this.getStrokeHandler().defaultRendering.addOver(r)}},isMeshToConsider:function(e){return!!e},getStrokeHandler:function(){return o.is(this._strokeRenderingHandler)||(this._strokeRenderingHandler=new p(this.urban,this._defaultStrokeParameters)),this._strokeRenderingHandler},applyRenderingToPrimitive:function(e,t,i,r){this.isStrokeMesh(e)?(t=this._strokeRenderingHandler.getPrimitiveRenderingValuesOrOriginal(r),o.is(t)&&(this.isInLineMode()||(t=t.stroke),e.setRendering(t,i[0],r))):this._parent(e,t,i,r)},applyPrimitiveDataVizRendering:function(e){this.isStrokeMesh(e)?this._strokeRenderingHandler.applyPrimitiveDataVizRendering(e):this._parent(e)}});return f._building={attributes:{},uniforms:{b_infoTexture:{type:"t",value:void 0},extrusionHeight:{type:"f",value:1}},vertex_pars:["// RenderingBuilding - Varyings & Uniforms","// **************************************************","uniform sampler2D b_infoTexture;","uniform float extrusionHeight;","varying vec4 b_color;","varying vec2 vUv;","varying float colorflag;","varying float opacityflag;","// RenderingBuilding - RGBA decoder function","// **************************************************","float b_rgba2float( vec4 color ) {","    return dot( color, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/16581375.0) );","}","float b_rgba2int( vec4 color ) {","    return ( 255.0 * ( color.r + (color.g*255.0) + (color.b*65025.0) + (color.a*16581375.0) ) );","}","float getFlag(float flags, float row){","    float res = mod(flags, row*2.0); ","    if(res >= row){","       return 1.0;","   }","   return 0.0; ","}"].join("\n"),vertex:["    // RenderingBuilding MAP - Read Building info","    /////////////////////////////////////////////////","    float b_pixPerRow = b_rgba2int( texture2D( b_infoTexture, vec2( 0.0, 0.0 ) ) );","    float b_nbBuilding = b_rgba2int( texture2D( b_infoTexture, vec2( 1.5/b_pixPerRow, 0.0 ) ) );","    float b_scale = b_rgba2int( texture2D( b_infoTexture, vec2( 2.5/b_pixPerRow, 0.0 ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 3.5/b_pixPerRow, 0.0 ) ) );","    float b_indice = (uv.x + .5)/b_nbBuilding;","    b_color = texture2D( b_infoTexture, vec2( 0.0, b_indice ) );","    float b_texIndice = b_rgba2int( texture2D( b_infoTexture, vec2( 1.5/b_pixPerRow, b_indice ) ) );","    float b_altitude = b_rgba2int( texture2D( b_infoTexture, vec2( 2.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 3.5/b_pixPerRow, b_indice ) ) );","    float b_height = b_rgba2int( texture2D( b_infoTexture, vec2( 4.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 5.5/b_pixPerRow, b_indice ) ) );","    float b_roofHeight = b_rgba2int( texture2D( b_infoTexture, vec2( 6.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 7.5/b_pixPerRow, b_indice ) ) );","    vec3 b_roofMainDir = texture2D( b_infoTexture, vec2( 8.5/b_pixPerRow, b_indice ) ).rgb;","    vec2 b_roofOrthoUV;","    b_roofOrthoUV.x = b_rgba2int( texture2D( b_infoTexture, vec2( 9.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 10.5/b_pixPerRow, b_indice ) ) );","    b_roofOrthoUV.y = b_rgba2int( texture2D( b_infoTexture, vec2( 11.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 12.5/b_pixPerRow, b_indice ) ) );","    vec3 b_roofOrigin;","    b_roofOrigin.x = b_rgba2int( texture2D( b_infoTexture, vec2( 13.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 14.5/b_pixPerRow, b_indice ) ) );","    b_roofOrigin.y = b_rgba2int( texture2D( b_infoTexture, vec2( 15.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 16.5/b_pixPerRow, b_indice ) ) );","    b_roofOrigin.z = b_altitude+b_height;","    vec4 flag = texture2D( b_infoTexture, vec2( 17.5/b_pixPerRow, b_indice ) ) ;"," colorflag = getFlag(flag.x, 1.0);"," opacityflag = getFlag(flag.x, 2.0);"].join("\n"),fragment_pars:["// RenderingBuilding MAP - Varyings","// **************************************************","varying vec4 b_color;","varying vec2 vUv;","varying float colorflag;","varying float opacityflag;"].join("\n"),fragment:[" vec3 color_value = vec3(0.0);","    #ifdef GAMMA_INPUT","       color_value.rgb *= b_color.rgb * b_color.rgb;","    #else","       color_value.rgb *= b_color.rgb;","    #endif","if( colorflag > 0.5 ) {","   diffuse_value = b_color.rgb;","   ambient_value = b_color.rgb;","}            ","if( opacityflag > 0.5 ) {","   opacity_value = b_color.a;","}            "].join("\n")},f._wall={depends:[f._building],attributes:{},uniforms:{maps_atlas:{type:"t",value:void 0},maps_atlas_info:{type:"t",value:void 0}},vertex_pars:["\n\n","// RenderingBuilding Wall","//**************************************************","uniform sampler2D maps_atlas_info;","varying vec4 w_atlasTexInfo;","varying vec4 w_size;","varying vec2 w_uvs;","//**************************************************"].join("\n"),vertex:["\n\n","// RenderingBuilding Wall","//**************************************************","    w_uvs = vec2( 0.0 );","    if( b_texIndice > 0.0 ) {","        vec2 maps_atlas_infoStep;","        maps_atlas_infoStep.x = 1.0 / b_rgba2int( texture2D( maps_atlas_info, vec2( 0.0, 0.0 ) ) );","        if( !( maps_atlas_infoStep.x == 0.0 || maps_atlas_infoStep.x > 0.5 ) ) {","            maps_atlas_infoStep.y = 1.0 / b_rgba2int( texture2D( maps_atlas_info, vec2( 3.5*maps_atlas_infoStep.x, 0.0 ) ) );","            float offset = b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, 0.0 ) ) );","            float tdb_texIndice = (0.5 + offset + b_texIndice)*maps_atlas_infoStep.y;","            vec2 w_atlasTexSize;","            vec2 w_numWindows;","            w_atlasTexInfo.z = b_rgba2int( texture2D( maps_atlas_info, vec2( 0.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 1.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            w_atlasTexInfo.w = b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 3.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            w_atlasTexInfo.x = b_rgba2int( texture2D( maps_atlas_info, vec2( 4.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 5.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            w_atlasTexInfo.y = b_rgba2int( texture2D( maps_atlas_info, vec2( 6.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 7.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            w_atlasTexInfo.y = 1.0 - w_atlasTexInfo.y - w_atlasTexInfo.w;","            w_atlasTexSize.x = b_rgba2int( texture2D( maps_atlas_info, vec2( 8.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 9.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            w_atlasTexSize.y = b_rgba2int( texture2D( maps_atlas_info, vec2( 10.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 11.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            w_numWindows.x = b_rgba2int( texture2D( maps_atlas_info, vec2( 14.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            w_numWindows.y = b_rgba2int( texture2D( maps_atlas_info, vec2( 15.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            float groundFloorHeight = b_rgba2int( texture2D( maps_atlas_info, vec2( 12.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 13.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            float w_wallLength = uv.y / b_scale;","            w_size.x = w_atlasTexInfo.w * groundFloorHeight / w_atlasTexSize.y;","            w_size.y = (w_atlasTexInfo.w - w_size.x) / w_numWindows.y;","            w_size.z = w_numWindows.x;","            w_size.w = 0.0;","            w_uvs.x = floor( 0.5 + (w_numWindows.x * w_wallLength / w_atlasTexSize.x) ) / w_numWindows.x;","            if( position.z - b_altitude > b_height + 0.005 ) {","                w_uvs.y = 1.0;","            } else if( position.z - b_altitude > 0.0 ) {","                float w_nbWindowsHeigth = 0.0;","                if( b_height > groundFloorHeight )","                    w_nbWindowsHeigth = floor( w_numWindows.y * ( b_height - groundFloorHeight ) / ( w_atlasTexSize.y - groundFloorHeight ) );","                w_uvs.y = w_size.x + w_nbWindowsHeigth * w_size.y;","            } else {","                w_uvs.y = 0.0;","            }","        }","    }","//**************************************************"].join("\n"),fragment_pars:["\n\n","// RenderingBuilding Wall","//**************************************************","uniform sampler2D maps_atlas;","varying vec4 w_atlasTexInfo;","varying vec4 w_size;","varying vec2 w_uvs;","float w_nbFloor = 3.0;","//**************************************************"].join("\n"),fragment:["\n\n","// RenderingBuilding Wall","//**************************************************","    #define USE_UV_MAPS","    vec2 maps_UVcoord;","    vec3 w_atlasColor = vec3( 1.0 );","    if( w_atlasTexInfo.z > 0.0 && w_atlasTexInfo.w > 0.0 ) {","        maps_UVcoord.x = w_atlasTexInfo.x + w_atlasTexInfo.z * mod(w_uvs.x, 1.0);","        if( w_uvs.y >= w_size.x + w_size.y ) {","            float w_floors = w_uvs.y - w_size.x - w_size.y;","            float w_floorStart = w_size.y * mod( floor( w_floors / w_size.y ), (w_nbFloor - 1.0));","            maps_UVcoord.y = mod(w_floors, w_size.y) + w_floorStart + w_size.x + w_size.y + w_atlasTexInfo.y;","        } else {","            maps_UVcoord.y = mod(w_uvs.y, w_atlasTexInfo.w) + w_atlasTexInfo.y;","        }","        w_atlasColor = texture2D( maps_atlas, maps_UVcoord ).rgb;","    }","    #ifdef GAMMA_INPUT","        w_atlasColor *= w_atlasColor;","    #endif","    gl_FragColor.rgb *= w_atlasColor;","//**************************************************"].join("\n")},f._roof={depends:[t.vertexInformation,f._building],uniforms:{maps_atlas:{type:"t",value:void 0},maps_atlas_info:{type:"t",value:void 0},r_ortho:{type:"t",value:void 0},r_mode:{type:"i",value:0},r_orthoOffset:{type:"v3",value:new e.Vector3(0,0,1)},r_orthoData:{type:"v3",value:new e.Vector3(0,0,1)}},vertex_pars:["\n\n","// RenderingBuilding Roof","//**************************************************","uniform sampler2D maps_atlas_info;","uniform sampler2D r_ortho;","uniform vec3 r_orthoOffset;","uniform vec3 r_orthoData;","varying vec4 r_atlasTexRatio;","varying vec4 r_dirtRatio;","varying vec4 r_orthoUVs;","varying vec4 r_uvs;","//**************************************************"].join("\n"),vertex:["\n\n","// RenderingBuilding Roof","//**************************************************","    float r_type = uv.y; // 0 means roof is not flat, 1 it's flat, 2 is acroterion's side and 3 is acroterion's top","    r_orthoUVs.xy = ((vertex_position.xy - r_orthoData.xy)/r_orthoData.z)*r_orthoOffset.z + r_orthoOffset.xy;","    r_orthoUVs.zw = (((modelMatrix*vec4(b_roofOrthoUV,0.0,1.0)).xy - r_orthoData.xy)/r_orthoData.z)*r_orthoOffset.z + r_orthoOffset.xy;","    vec3 r_orthoColor = texture2D(r_ortho, r_orthoUVs.zw).rgb;","    vec4 maps_atlas_infoStep;","    maps_atlas_infoStep.x = 1.0 / b_rgba2int( texture2D( maps_atlas_info, vec2( 0.0, 0.0 ) ) );","    maps_atlas_infoStep.y = 1.0 / b_rgba2int( texture2D( maps_atlas_info, vec2( 3.5*maps_atlas_infoStep.x, 0.0 ) ) );","    maps_atlas_infoStep.z = b_rgba2int( texture2D( maps_atlas_info, vec2( 1.5*maps_atlas_infoStep.x, 0.0 ) ) );","    maps_atlas_infoStep.w = b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, 0.0 ) ) );","    vec3 color;","    float r_test, r_dist, r_closerDist = 100000.0;","    float r_texinclass, r_class = -1.0, r_dirtclass = -1.0;","    for( float r_ind=1.0; r_ind<128.0; ++r_ind ) {","        if( r_ind - 1.0 < maps_atlas_infoStep.w ) {","            r_test = b_rgba2int( texture2D( maps_atlas_info, vec2( 1.5*maps_atlas_infoStep.x, (r_ind + .5)*maps_atlas_infoStep.y ) ) );","            if( abs( r_type - r_test ) < 0.1 ) {","                color = texture2D( maps_atlas_info, vec2( 0.0, (r_ind + .5)*maps_atlas_infoStep.y ) ).rgb - r_orthoColor;","                r_dist = color.r*color.r + color.g*color.g + color.b*color.b;","                if( r_dist < r_closerDist && b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, (r_ind + .5)*maps_atlas_infoStep.y ) ) ) > 0.0) {","                    r_closerDist = r_dist;","                    r_class = r_ind;","                    r_texinclass = b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, (r_ind + .5)*maps_atlas_infoStep.y ) ) );","                }","            } else if( abs( 10.0 - r_test ) < 0.1 ) {","                r_dirtclass = r_ind;","            }","        }","    }","    float tdb_texIndice = -1.0;","    if( r_class > 0.0 ) {","        tdb_texIndice = 3.5 + mod( uv.x, r_texinclass );","        tdb_texIndice = 0.5 + maps_atlas_infoStep.w + b_rgba2int( texture2D( maps_atlas_info, vec2( tdb_texIndice*maps_atlas_infoStep.x, (r_class + .5)*maps_atlas_infoStep.y ) ) );","        tdb_texIndice = tdb_texIndice*maps_atlas_infoStep.y;","    }","    if( tdb_texIndice > 0.0 ) {","        vec2 r_atlasTexSize;","        r_atlasTexRatio.x = b_rgba2int( texture2D( maps_atlas_info, vec2( 0.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 1.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_atlasTexRatio.y = b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 3.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_atlasTexRatio.z = b_rgba2int( texture2D( maps_atlas_info, vec2( 4.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 5.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_atlasTexRatio.w = b_rgba2int( texture2D( maps_atlas_info, vec2( 6.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 7.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_atlasTexSize.x = b_rgba2int( texture2D( maps_atlas_info, vec2( 8.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 9.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_atlasTexSize.y = b_rgba2int( texture2D( maps_atlas_info, vec2( 10.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 11.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        if( uv2.x < 0.0 && uv2.y < 0.0 ) {","            vec3 r_u = normalize( b_roofMainDir ); // u is direction between the 2 lower point, or main direction","            vec3 r_v = cross(vertex_wNormal.xyz, r_u); // v is cross product between u and face normal","            vec3 r_d = vertex_position.xyz - b_roofOrigin;","            r_uvs.x = dot(r_u, r_d) / ( b_scale * r_atlasTexSize.x );","            r_uvs.y = dot(r_v, r_d) / ( b_scale * r_atlasTexSize.y );","        } else {","            r_uvs.x = uv2.x / ( b_scale * r_atlasTexSize.x );","            r_uvs.y = uv2.y / ( b_scale * r_atlasTexSize.y );","        }","    }","    if( r_dirtclass > 0.0 ) {","        r_texinclass = b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, (r_dirtclass + .5)*maps_atlas_infoStep.y ) ) );","        tdb_texIndice = 3.5 + mod( uv.x, r_texinclass );","        tdb_texIndice = 0.5 + maps_atlas_infoStep.w + b_rgba2int( texture2D( maps_atlas_info, vec2( tdb_texIndice*maps_atlas_infoStep.x, (r_dirtclass + .5)*maps_atlas_infoStep.y ) ) );","        tdb_texIndice = tdb_texIndice*maps_atlas_infoStep.y;","        vec2 r_dirtSize;","        r_dirtRatio.x = b_rgba2int( texture2D( maps_atlas_info, vec2( 0.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 1.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_dirtRatio.y = b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 3.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_dirtRatio.z = b_rgba2int( texture2D( maps_atlas_info, vec2( 4.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 5.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_dirtRatio.w = b_rgba2int( texture2D( maps_atlas_info, vec2( 6.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 7.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_dirtSize.x = b_rgba2int( texture2D( maps_atlas_info, vec2( 8.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 9.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_dirtSize.y = b_rgba2int( texture2D( maps_atlas_info, vec2( 10.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 11.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_uvs.zw = vertex_position.xy / (r_dirtSize.xy * b_scale);","    } else {","        r_uvs.z = 0.0;","    }","    if( r_type > 1.0 )","        r_orthoUVs = vec4(-1.0);","//**************************************************"].join("\n"),fragment_pars:["\n\n","// RenderingBuilding Roof","//**************************************************","float r_coeffDirty = 0.75;","uniform sampler2D maps_atlas;","uniform sampler2D r_ortho;","uniform int r_mode;","varying vec4 r_atlasTexRatio;","varying vec4 r_dirtRatio;","varying vec4 r_orthoUVs;","varying vec4 r_uvs;","//**************************************************"].join("\n"),fragment:["\n\n","// RenderingBuilding Roof","//**************************************************","    #define USE_UV_MAPS","    vec3 old = gl_FragColor.rgb;","    vec2 maps_UVcoord;","    maps_UVcoord.x = r_atlasTexRatio.z + r_atlasTexRatio.x * mod( r_uvs.x, 1.0);","    maps_UVcoord.y = r_atlasTexRatio.w + r_atlasTexRatio.y * mod( r_uvs.y, 1.0);","    vec3 r_orthoMainColor = vec3(0.8);","    vec3 r_orthoColor = vec3( 0.8 );","    vec3 r_atlasColor = vec3( 1.0 );","    vec3 r_dirty = vec3( 1.0 );","    if( length(r_orthoUVs + 1.0) > 0.05 ) {","        r_orthoMainColor = texture2D( r_ortho, r_orthoUVs.zw ).rgb;","        r_orthoColor = texture2D( r_ortho, r_orthoUVs.xy ).rgb;","        r_atlasColor = texture2D( maps_atlas, maps_UVcoord ).rgb;","        r_dirty = (texture2D( maps_atlas, r_dirtRatio.zw + r_dirtRatio.xy * mod( r_uvs.zw, 1.0) ).rgb - 0.5 ) * r_coeffDirty + 1.0;","    }","    #ifdef GAMMA_INPUT","        r_orthoColor *= r_orthoColor;","        r_orthoMainColor *= r_orthoMainColor;","    #endif","    if( r_mode == 0 )","        gl_FragColor.rgb *= r_orthoColor * r_atlasColor;","    else if( r_mode == 1 )","        gl_FragColor.rgb *=  r_orthoMainColor * r_atlasColor * r_dirty;","    if( gl_FragColor.rgb == vec3(0.0) )","        gl_FragColor.rgb = old;","//**************************************************"].join("\n")},f._roof_debug={uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["\n\n","// RenderingBuilding Roof - DEBUG","//**************************************************","    gl_FragColor.r = mod( r_uvs.x, 1.0);","    gl_FragColor.g = mod( r_uvs.y, 1.0);","    gl_FragColor.b = 0.0;","    gl_FragColor.rgb = texture2D( r_ortho, r_uvs.zw ).rgb;","    return;","//**************************************************"].join("\n")},f}),define("DS/XCityGeometry/PatchVectorFactoryCrossQuad",["DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PatchVectorFactoryPointGeometry","DS/Visualization/Node3D","DS/WebappsUtils/WebappsUtils","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityRendering/RenderingHandlerCrossQuad","DS/XCityWorkers/WorkerPool","DS/Mesh/MeshUtils","DS/XCityLayer/Vector","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader","UWA/Class","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f){"use strict";return t.extend({init:function(t,s,n){if(this._parent(t,s),this.urban=t,this.supportWorkers=!0,this.altitudeAttribute=void 0!==s.altitudeAttribute?s.altitudeAttribute:"ALTITUDE",this.scaleAttribute=void 0!==s.scaleAttribute?s.scaleAttribute:"SCALE",this.orientationAttribute=void 0!==s.orientationAttribute?s.orientationAttribute:"ORIENT",this.textureIndexAttribute=void 0!==s.textureIndexAttribute?s.textureIndexAttribute:"INDEX",this.typeAttribute=void 0!==s.typeAttribute?s.typeAttribute:"TYPE",this.stridAttribute=void 0!==s.stridAttribute?s.stridAttribute:"STRID",this._debugID=0,this._editable=!0,this.atlasNum=s.atlasNum,this.instancing=!1,this.urban.USR.hwInstancing&&(this.instancing=!0),this._rendering=new a(t,s),this.instancing&&(this.centerVec=new e.Vector3,this.scaleVec=new e.Vector3),this._node=new i,this._node.name="FactoryCrossQuad",this._node.hwInstancing=this.urban.USR.hwInstancing,this.forceAltitude=s.forceAltitude,this.identifier=0,this._treeid=0,this.nbInfoPixels=1,this.isPickable=void 0===s.isPickable||s.isPickable,this._rendering.addDefaultAltitudeFromAttributes(this.forceAltitude,this.altitudeAttribute),this.urban.USR.workers){d.log("create crosQuad Worker POOL");var l={init:!0,UVBuffer:this.UVBuffer};this._workers=new o(this.urban,r.getWebappsBaseUrl()+"UrbanWorkers/CrossQuadWorker.js",4,l)}var h=c.getUuidFromUrl(n),p=c.getUrlOptions(n);this._isReady=!1;var f=c.getDataSupplierUrl()+h+"/resources/index.json"+p;c.download(f,{responseType:"json"},999999,function(e,t,i,r){r(t,e,i)},void 0,function(e,t,i){if(t){var r=["jpg","png"],s=[];if(e instanceof Array&&e.length>=1)for(var n=0;n<e.length;n++){var a=e[n].substr(e[n].lastIndexOf(".")+1);r.indexOf(a)>-1&&s.push(e[n])}s.length>0&&this._rendering.defaultRendering.set("mapUrl",c.getDataSupplierUrl()+h+"/resources/"+s[0])}this._isReady=!0}.bind(this)),u.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},destroy:function(){this.urban.USR.getScene().remove(this._node)},dispose:function(){d.warn("Dispose: UrbanCrossQuad")},isReady:function(){return this._isReady},getData:function(t){this._treeid=0;var r=null;if(!1===this.urban.USR.workers)r=!0===this._editable?t.creator.compilePrimitive("Tree",!0,!0):t.creator.compilePrimitive("Tree",void 0,!0);else{var s=(r=t.primitiveGroup).primitives[0];s.attr.fill.isEqual=function(e){return!0},s.attr.line.isEqual=function(e){return!0},s.attr.point.isEqual=function(e){return!0},r.getBufferFromId=function(e){var t=this.buffers[e];return void 0!==t?t:null}}var a=n.createMeshNode(r);a.setMatrix((new e.Matrix4).identity().setPosition(new e.Vector3(t.posTile.x,t.posTile.y,0))),this.isPickable?a.setPickable(l.PICKABLE):a.setPickable(l.NOPICKABLE);var o=t.tile.LOD+"_"+t.tile.I+"_"+t.tile.J+"_crossquad";a.name=o,a.mesh3js.name=o,a.trees=!0,a._debugID=this._debugID,a.setVisible=function(e,t){var i=this.mesh3js.instanceAttribArrays.instanceFlag.array,r=this.mesh3js.userData.cgmIds.indexOf(t),s=i[r],n=i[r];(s=f.floatPack(s,2,!e))!==n&&(i[r]=s,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0)},a.setRendering=function(e,t,i){var r=this.mesh3js.instanceAttribArrays.instanceFlag.array[h=this.mesh3js.userData.cgmIds.indexOf(i)],s=e.color;f.is(s)&&f.is(s.computeColor)&&(s=s.computeColor());var n,a=e.opacity,o=f.is(s),l=f.is(a);r=f.floatPack(r,0,o),r=f.floatPack(r,1,l);t.getStart();if(!0===this.isInstanceNode3D){var h=-1;h="number"==typeof t.getCgmId()?this.mesh3js.userData.cgmIds.indexOf(Number(i)):this.mesh3js.userData.cgmIds.indexOf(i);var d=this.mesh3js.instanceAttribArrays.instanceColor.array;n=4*h,o&&(d[n]=s.r,d[n+1]=s.g,d[n+2]=s.b),l&&(d[n+3]=a),this.mesh3js.instanceAttribArrays.instanceColor.isDynamic=!0,this.mesh3js.instanceAttribArrays.instanceFlag.array[h]=r,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0}},this._rendering.initMesh(a),a.material.transparent=t.transparent;var h={data:t.instanceMatrix,type:"m4",attribName:"instanceMatrix"},d={data:t.instanceRotation,type:"f",attribName:"instanceRotation"},u={data:t.instanceColor,type:"v4",attribName:"instanceColor"},c={data:t.instanceIndexTexture,type:"f",attribName:"instanceIndexTexture"},p={data:t.instanceFlag,type:"f",attribName:"instanceFlag"};a.mesh3js.userData.cgmIds=t.instanceCgmId,a.setInstancingParameters(t.nbElement,[h,d,u,c,p]);for(var m=0;m<a._occurrences.length;m++)a._occurrences[m].renderable.userData.cgmIds=t.instanceCgmId;a.forceBoundingSphere({radius:Math.sqrt(Math.pow(t.minMax.maxX-t.minMax.minX,2)+Math.pow(t.minMax.maxY-t.minMax.minY,2)+Math.pow(t.minMax.maxZ-t.minMax.minZ,2))/2,center:new e.Vector3((t.minMax.minX+t.minMax.maxX)/2,(t.minMax.minY+t.minMax.maxY)/2,(t.minMax.minZ+t.minMax.maxZ)/2)});var g=new i;return g.addChild(a),this.addLabelsToNode(t,g),g},initOne:function(e,t,i){var r,s,n,a=e.getGeometry();if(a.type===h.Type.POINT){r=a.getVertices(),s=(s=e.getAttribute(this.scaleAttribute))?s.split(" "):[1,1,1];var o=this._rendering.getCompleteMaterialInfo(strid,e.attributes);n=this._computeAltitudeToApply(o,r),i.posSize.center.set(r[0],r[1],n+s[2]/2),i.posSize.width=s[1],i.posSize.length=s[0],i.posSize.height=s[2],i.posSize.altitude=n}},buildOne:function(t,i,r){var n=function(t,i,r,s,n,a,o,l,h,d,u,c){if(0===t.nbElement){var p=t.creator,f=new e.Vector3(r,s,n);if(!t.bSphere.containsPoint(f)){var m=t.bSphere.distanceToPoint(f);t.bSphere.set(t.bSphere.center,m+o)}p.startPrimitive(),p.pushVertex([-.5,0,0]),p.pushVertex([.5,0,0]),p.pushVertex([.5,0,1]),p.pushVertex([-.5,0,1]),p.pushVertex([0,.5,0]),p.pushVertex([0,-.5,0]),p.pushVertex([0,-.5,1]),p.pushVertex([0,.5,1]),p.pushNormal([0,-1,0]),p.pushNormal([0,-1,0]),p.pushNormal([0,-1,0]),p.pushNormal([0,-1,0]),p.pushNormal([-1,0,0]),p.pushNormal([-1,0,0]),p.pushNormal([-1,0,0]),p.pushNormal([-1,0,0]),p.pushTexCoord(0,[0,0]),p.pushTexCoord(0,[1,0]),p.pushTexCoord(0,[1,1]),p.pushTexCoord(0,[0,1]),p.pushTexCoord(0,[0,0]),p.pushTexCoord(0,[1,0]),p.pushTexCoord(0,[1,1]),p.pushTexCoord(0,[0,1]);var g;g=8*this._treeid,p.pushVertexIndices([g,g+1,g+2]),p.pushVertexIndices([g,g+2,g+3]),p.pushVertexIndices([g+4,g+5,g+6]),p.pushVertexIndices([g+4,g+6,g+7]),p.endPrimitive(i,!0)}var v=new e.Matrix4;v.identity(),v.translate(this.centerVec.set(r,s,n)),v.scale({x:o,y:o,z:l});var _=-a;v.rotateZ(_);var y=new e.Matrix4;y.identity(),y.rotateZ(_);var b=_,x=new e.Vector4(d.r,d.g,d.b,u);t.instanceMatrix[t.nbElement]=v,t.instanceRotation[t.nbElement]=b,t.instanceColor[t.nbElement]=x,t.instanceCgmId[t.nbElement]=i,t.instanceIndexTexture[t.nbElement]=h,t.instanceFlag[t.nbElement]=c;var C=Math.abs(Math.cos(_)),S=Math.abs(Math.sin(_));r-.5*o*C<t.minMax.minX&&(t.minMax.minX=r-.5*o*C),r+.5*o*C>t.minMax.maxX&&(t.minMax.maxX=r+.5*o*C),s-.5*o*S<t.minMax.minY&&(t.minMax.minY=s-.5*o*S),s+.5*o*S>t.minMax.maxY&&(t.minMax.maxY=s+.5*o*S),n<t.minMax.minZ&&(t.minMax.minZ=n),n+l>t.minMax.maxZ&&(t.minMax.maxZ=n+l),t.nbElement++}.bind(this),a=t.getGeometry();if(a.type===h.Type.POINT){var o,l,d,u,c,p,m,g,v,_;o=t.getAttribute(this.stridAttribute),l=a.getVertices(),d=(d=t.getAttribute(this.scaleAttribute))?d.split(" "):[1,1,1],u=(u=t.getAttribute(this.orientationAttribute))?u.split(" "):[0,0,0],c=Number(t.getAttribute(this.textureIndexAttribute)),(p=t.getAttribute("color"))?p instanceof e.Color||(p=new e.Color(p)):p=new e.Color(16777215);var y=t.getAttribute("opacity");y<1?this.transparent=!0:y=1;var b=this._rendering.getCompleteMaterialInfo(o,t.attributes);m=this._computeAltitudeToApply(b,l),void 0!==(v=t.getAttribute(this.typeAttribute))&&5===(g=Number(v))&&(g=3),r.posSize.center.set(l[0],l[1],m+d[2]/2),r.posSize.width=d[1],r.posSize.length=d[0],r.posSize.height=d[2],r.posSize.altitude=m,void 0===i.posTile&&(i.posTile=new e.Vector2(Math.round(l[0]),Math.round(l[1])),this._treeid=0,i.instanceMatrix=[],i.instanceRotation=[],i.instanceCgmId=[],i.instanceColor=[],i.instanceIndexTexture=[],i.instanceFlag=[],i.minMax={minX:99999999.9,minY:99999999.9,minZ:99999999.9,maxX:-99999999.9,maxY:-99999999.9,maxZ:-99999999.9},i.nbElement=0),_=i.posTile,void 0===i.creator&&(i.creator=new s({indexed:!0,normalBinding:s.Binding.VERTEX,useTexCoord:!0,nbTexCoord:1,texCoordBinding:s.Binding.VERTEX,useColor:!1})),void 0===i.bSphere&&(i.bSphere=new e.Sphere,i.bSphere.center.z=Number(m));var x=t.attributes,C=this._rendering.getPrimitiveRenderingValues(o,x);f.is(C)&&(f.is(C.color)&&(p=C.color.computeColor()),f.is(C.opacity)&&(y=C.opacity));var S=!1;y<1&&(S=!0),i.transparent||(i.transparent=S);var D=this._rendering.getFlagForPrimitive(o,t.attributes),P=c;void 0!==g&&(P=Math.floor(4*(4-g)+c/4));var w={x:l[0]-_.x,y:l[1]-_.y,z:Number(m)},M={x:l[0],y:l[1],z:Number(m)};if(n(i,o,w.x,w.y,w.z,Number(u[0]),Number(d[0]),Number(d[2]),P,p,y,D),this._shouldCreateLabelFromMaterial(b)){f.is(i.labelMeshes)||(i.labelMeshes=[]);let e=f.generateLabelPriorities(this._node,t);i.labelMeshes.push(this._generateLabel(M,o,b,r.posSize,void 0,e))}this._treeid++}},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1},attributeSetter:{color:"setColor",opacity:"setOpacity"},getDatas:function(e){var t=[];return t[0]={attributes:e.userData,target:e.geom},t},setGeomAttribute:function(e,t,i){var r;for(r=0;r<e.length;r+=1){var s=THREEDS.SubElement.getFromSGNode(e[r].subElement);e[r].mesh[this.attributeSetter[t]](i,[s.sgNode])}},buildAll:function(e,t,i){this._debugID++;var r=this;if(void 0===e.posTile&&(e.posTile={x:t[0].geometry.coordinates[0],y:t[0].geometry.coordinates[1]}),this._workers){var s=this._workers.postMessage({datasource:t});s.onmessage=function(t){r._workers.available(s),e.primitiveGroup=t.data.result,i()}}}})}),define("DS/XCityGeometry/PatchVectorFactoryBuilding",["UWA/Class","DS/XCityGeometry/PatchVectorFactoryPolygonGeometry","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/XCityTools/Geocoder","DS/XCityTools/TextureTools","DS/XCityTools/Debug","DS/XCityGeometry/Building","DS/Visualization/SceneGraphFactory","DS/XCityTools/PrimitiveGeometryCreator","DS/XCityRendering/RenderingHandlerBuilding","DS/XCityLayer/Vector","DS/xCityBasicUtils/Utils","DS/Mesh/MeshUtils","DS/XCityGeometry/LineBuilder","DS/XCityLayer/VectorLoaderJSON","DS/Visualization/EditableMesh3D","DS/Visualization/Mesh3D","DS/Mesh/Mesh"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m,g,v,_,y){"use strict";return t.extend({init:function(e,t){this._parent(e,t),this.urban=e,this.supportWorkers=!1,this._node=new s,this._node.name="Buildings",this.altitudeAttribute=void 0!==t.altitudeAttribute?t.altitudeAttribute:"ALTITUDE",this.heightAttribute=void 0!==t.heightAttribute?t.heightAttribute:"HEIGHT",this.roofAttribute=void 0!==t.roofAttribute?t.roofAttribute:"ROOFHGT",this.roofAngleAttribute=void 0!==t.roofAngleAttribute?t.roofAngleAttribute:"ROOFANGLE",this.roofShapeAttribute=void 0!==t.roofShapeAttribute?t.roofShapeAttribute:"roofShape",this.stridAttribute=void 0!==t.stridAttribute?t.stridAttribute:"STRID",this.alternAttribute=void 0!==t.alternAttribute?t.alternAttribute:"ALTERN",this.walltexAttribute=void 0!==t.walltexAttribute?t.walltexAttribute:"WALLTEX",this.tdbAttribute=void 0!==t.tdbAttribute?t.tdbAttribute:"TDB",this.transparent=!1,this.layerColor=[1,1,1],this.forceAltitude=t.forceAltitude,this.isPickable=void 0===t.isPickable||t.isPickable,this.alternBuilding=t.alternBuildingUrl,this.createRoofObjects=e.url.getArgument("roofObjects")?parseFloat(e.url.getArgument("roofObjects").value):t.createRoofObjects,this._rendering=new u(e,t),this._rendering.addDefaultHeightAttribute(this.heightAttribute),this._rendering.addDefaultAltitudeFromAttributes(this.altitudeAttribute,this.forceAltitude),this.initLabelOnSelect(e,t.renderType),this.nbInfoPixels=18,this.nbFeature=0,this.geoJSON={}},getGeoJSON:function(e){return this.geoJSON[e]},destroy:function(){this.urban.USR.getScene().remove(this._node),this._parent()},dispose:function(){o.warn("Dispose: building")},get3DMesh:function(e,t,s,n,a){var o,l;if(l=e.compilePrimitive(t),a&&a.dataFromWebWorkers){for(var d,u=(d=t.contains("roof")?a.dataFromWebWorkers.meshBundle.roofs:a.dataFromWebWorkers.meshBundle.walls).mesh,c=f.DrawingGroup.prototype,m=0;m<u.drawingGroups.length;m++)Object.setPrototypeOf(u.drawingGroups[m],c);var g=f.divideRep(u),y=new f.SGBag;g.sceneGraph=y,d.params.iPrimGroupPatternOffsets&&(g.patternOffsets=iPrimGroup.patternOffsets);var b,x=l.material,C=f.convertTo3jsMesh(g,x,!0,d.params.toShare);b=d.params.toEdit?new v(C):new _(C),!i.disableJHGDev&&x&&b.setMaterial(x),d.params.iPrimGroupNoz&&b.setRenderPasses(["noz"]),o=b}else o=h.createMeshNode(l);o.name=t,o.mesh3js.name=t,o.textureInfo={texture:n.texture,idMap:n.idMap},void 0===o.observers&&(o.observers=[]);var S=this._rendering;return o.observers.push(function(e){S.removeMesh(o.id),delete o.textureInfo,delete o.setRendering,delete o.getColor,delete o.getOpacity}),o.setRendering=function(e,t,i){var r,s=p.is(e.color),n=p.is(e.opacity),a=e.color,o=e.opacity,l=(e.extrusionHeight,t.length,this.textureInfo.texture.image);r=t;let h=this.textureInfo.idMap[r.getCgmId()];for(let e=0;h&&e<h.length;e++){let t=h[e];var d=l.data[4*t*l.width+68];if(s){let e=a.computeColor();l.data[4*t*l.width]=e.r,l.data[4*t*l.width+1]=e.g,l.data[4*t*l.width+2]=e.b,d=p.floatPack(d,0,1),!0}d=p.floatPack(d,0,s),n&&(l.data[4*t*l.width+3]=o,d=p.floatPack(d,1,1),!0),d=p.floatPack(d,1,n),l.data[4*t*l.width+68]=d}this.textureInfo.texture.needsUpdate=!0},o.setMatrix((new i.Matrix4).identity().setPosition(new i.Vector3(s.x,s.y,0))),this.isPickable?o.setPickable(r.PICKABLE):o.setPickable(r.NOPICKABLE),o},_compilMesh:function(e,t,i,r){var s=this.get3DMesh(i,r,e.posTile,t,e);return this._rendering.initMesh(s),this.transparent&&(s.mesh3js.material.transparent=!0,s.textureInfo.texture.needsUpdate=!0),s},getData:function(e){var t,i,r,n,o=new s,l=Object.keys(e.ltileGeoms),h=l.length;for(c=0;c<h;c++)if(t=l[c],i=e.tile.LOD+"_"+e.tile.I+"_"+e.tile.J,void 0!==(r=e.ltileGeoms[t]).node)o.add(r.node);else{if(e.dataFromWebWorkers){r.tdbName="default",r.textureInfo=e.dataFromWebWorkers.textureInfoCreator;var u=new d({indexed:!0,useColor:!0,normalBinding:d.Binding.FACE,useTexCoord:!0,nbTexCoord:2,texCoordBinding:d.Binding.VERTEX});Object.assign(u,e.dataFromWebWorkers.roofCreator);for(var c=0;c<u.primitiveList.length;c++){(g=u.primitiveList[c]).attr.fill.isEqual=function(e){return!0},g.attr.line.isEqual=function(e){return!0},g.attr.point.isEqual=function(e){return!0}}r.roofs=u;var m=new d({indexed:!0,useColor:!0,normalBinding:d.Binding.FACE,useTexCoord:!0,nbTexCoord:1,texCoordBinding:d.Binding.VERTEX});Object.assign(m,e.dataFromWebWorkers.wallCreator);for(c=0;c<m.primitiveList.length;c++){var g;(g=m.primitiveList[c]).attr.fill.isEqual=function(e){return!0},g.attr.line.isEqual=function(e){return!0},g.attr.point.isEqual=function(e){return!0}}r.walls=m}if(r.textureInfo.texture=a.createTexture(r.textureInfo),r.walls.nbPrimitives>0&&(n=this._compilMesh(e,r.textureInfo,r.walls,i+"_"+t),o.add(n),p.is(n.userData)&&p.is(n.userData.CityOtherMesh)&&(p.is(n.userData.CityOtherMesh.parents[0])||n.parents[0].addChild(n.userData.CityOtherMesh))),r.roofs.nbPrimitives>0&&(n=this._compilMesh(e,r.textureInfo,r.roofs,i+"_roof_"+t),o.add(n),p.is(n.userData)&&p.is(n.userData.CityOtherMesh)&&(p.is(n.userData.CityOtherMesh.parents[0])||n.parents[0].addChild(n.userData.CityOtherMesh))),e.dataFromWebWorkers){var v=f.DrawingGroup.prototype;for(c=0;c<n.mesh3js.geometry.length;c++)for(var _=n.mesh3js.geometry[c],y=0;y<_.drawingGroups.length;y++){var b=_.drawingGroups[y];Object.setPrototypeOf(b,v)}}e.builder&&this.addStrokes(e,o)}return e.ltileGeoms=void 0,e.labelsNode&&o.addChild(e.labelsNode),o},addStrokes:function(e,t){var r=new s;r._isStroke=!0,t.add(r);var n=e.posTile;r.setMatrix((new i.Matrix4).identity().setPosition(new i.Vector3(n.x,n.y,0))),e.builder.getData(e.lines,r,e.forceTransparent)},_updatesInfoTextures:function(e,t,i,r,s,n,o,l,h,d,u){p.is(e.idMap[t])||(e.idMap[t]=[]),e.idMap[t].push(e.ySize),i?a.pushPixel(e.data,[i.r,i.g,i.b,e.opacity]):a.pushPixel(e.data,[this.layerColor[0],this.layerColor[1],this.layerColor[2],e.opacity]),a.pushPixel(e.data,a.int2color(r)),a.pushPixel(e.data,a.int2color(s)),a.pushPixel(e.data,a.float2color(s)),a.pushPixel(e.data,a.int2color(n)),a.pushPixel(e.data,a.float2color(n)),a.pushPixel(e.data,a.int2color(o)),a.pushPixel(e.data,a.float2color(o)),a.pushPixel(e.data,[h.x,h.y,0,1]),a.pushPixel(e.data,a.int2color(l.x)),a.pushPixel(e.data,a.float2color(l.x)),a.pushPixel(e.data,a.int2color(l.y)),a.pushPixel(e.data,a.float2color(l.y)),a.pushPixel(e.data,a.int2color(d.x)),a.pushPixel(e.data,a.float2color(d.x)),a.pushPixel(e.data,a.int2color(d.y)),a.pushPixel(e.data,a.float2color(d.y)),a.pushPixel(e.data,[u,u,u,u]),e.ySize++;var c=a.int2color(e.ySize);e.data[4]=c[0],e.data[5]=c[1],e.data[6]=c[2],e.data[7]=c[3]},_createElements:function(e,t,i,r){var s={};s.tdbName=e,s.walls=new d({indexed:!0,useColor:!0,normalBinding:d.Binding.FACE,useTexCoord:!0,nbTexCoord:1,texCoordBinding:d.Binding.VERTEX}),s.roofs=new d({indexed:!0,useColor:!0,normalBinding:d.Binding.FACE,useTexCoord:!0,nbTexCoord:2,texCoordBinding:d.Binding.VERTEX});var n={};n.name="buildings_info_"+t.LOD+"_"+t.I+"_"+t.J,n.idMap={},n.xSize=i,n.ySize=1;var o=[];a.pushPixel(o,a.int2color(i)),a.pushPixel(o,[0,0,0,0]),a.pushPixel(o,a.int2color(r)),a.pushPixel(o,a.float2color(r));for(var l=0;l<4*(i-4);++l)o.push(0);return n.data=o,s.textureInfo=n,s},buildOne:function(e,t,i){var r=e.getAttribute(this.stridAttribute),s=Number(e.getAttribute(this.alternAttribute));if(t.dataFromWebWorkers?this._currentPrimRendering=null:this._currentPrimRendering=this._rendering.getCompleteMaterialInfo(r,e.attributes),p.is(s)||(s=-1),0===r&&o.warn("STRID = 0..."),this.nbFeature++,t&&(t.nbFeature?t.nbFeature++:t.nbFeature=1),1===s&&void 0!==this.alternBuilding&&""!==this.alternBuilding);else{var n=e.getGeometry();if(n.type===c.Type.POLYGON)this.addOneBuilding(t,n,e,r,i);else{if(n.type!==c.Type.MULTIPOLYGON)return;for(var a=n.geometryList.length,l=0;l<a;l++){var h=n.geometryList[l];this.addOneBuilding(t,h,e,r,i)}}}},addOneBuilding:function(e,t,r,a,o){var h,d,u,c,f,m,g,v,_,y,b,x,C,S,D,P;if(t.geometryList.length<1)console.warn("Empty polygon geometryList");else{var w=t.geometryList[0].getVertices();void 0===e.posTile&&(e.posTile=new i.Vector2(Math.round(w[0].x),Math.round(w[0].y)),"EPSG:3857"===this.urban.proj4Projection||"EPSG:900913"===this.urban.proj4Projection?e.scale=n.computeMercatorScaleFactor(e.posTile.x,e.posTile.y):e.scale=1),c=e.posTile;var M=!1,T=!1;if(e.dataFromWebWorkers?(this._shouldCreateLabel(this._rendering.getCompleteMaterialInfo(a,r.attributes))&&(M=!0),this._shouldAddOneStroke(a,I)&&(T=!0),(M||T)&&(this._currentPrimRendering=this._rendering.getCompleteMaterialInfo(a,r.attributes))):M=p.is(this._currentPrimRendering.label)&&this._currentPrimRendering.label.enable,e.dataFromWebWorkers)d=(u=r.getAttribute(this.tdbAttribute))||"default",e.ltileGeoms[d]={},e.ltileGeoms[d].tdbName=u,e.ltileGeoms[d].textureInfo={},e.ltileGeoms[d].textureInfo={},e.ltileGeoms[d].walls={};else{var I=r.attributes,R=this._currentPrimRendering,A=R.extrusionHeight;v=1,_=Number(r.getAttribute(this.roofAttribute)),y=Number(r.getAttribute(this.roofAngleAttribute)),b=Math.max(2,Number(r.getAttribute(this.walltexAttribute))+1),g=this._computeAltitudeToApply(R,w);var F=r.getAttribute(this.roofShapeAttribute);p.is(y)||(y=0),p.is(_)||(_=0),p.is(g)||(g=0),!(x=r.getAttribute("color"))||x instanceof i.Color||(x=new i.Color(x));var L=r.getAttribute("opacity");p.is(R)&&(p.is(R.color)&&(x=R.color.computeColor()),p.is(R.opacity)&&(L=R.opacity)),v=A,L<1?this.transparent=!0:L=1;var V=this._rendering.getFlagForPrimitive(a,r.attributes);C=this.initShape(w,c,o,g,v,_);var O=this.initHoles(t,c);if(void 0===(u=r.getAttribute(this.tdbAttribute))&&!isNaN(b)&&2!==b){var N=4,U=[];for(h=Math.floor(b-1),U[0]=h%256,U[1]=(h-U[0])/256%256,U[2]=(h-U[0]-256*U[1])/65536%256,U[3]=(h-U[0]-256*U[1]-65536*U[2])/16777216%256;N--;)U[N]/=255;x&&x instanceof i.Color?x.setRGB(U[0],U[1],U[2]):(x=new i.Color).setRGB(U[0],U[1],U[2])}(h=(S=(new i.Vector2).subVectors(w[1],w[0])).clone().normalize()).set(h.y,-h.x),D=new i.Vector2(2.5*h.x+.5*S.x+w[0].x-c.x,2.5*h.y+.5*S.y+w[0].y-c.y),S=S.normalize(),P=new i.Vector3(w[0].x-c.x,w[0].y-c.y,w[0].z),(d=u||"default")in e.ltileGeoms||(e.ltileGeoms[d]=this._createElements(d,o.tile,this.nbInfoPixels,e.scale)),a=r.getAttribute(this.stridAttribute);var E=R.geometricMode;p.is(E)&&"line"===E||("filled"===E?v=0:f=e.ltileGeoms[d].walls,m=e.ltileGeoms[d].roofs,l.build({wallCreator:f,roofCreator:m,shape:C,holes:O,altitude:g,height:v,roofHeight:_,roofAngle:y*Math.PI/180,roofShape:F,infoInd:e.ltileGeoms[d].textureInfo.ySize,pIdentifer:a,roofObjects:this.createRoofObjects,uvCalc:this.uvCalc}),e.ltileGeoms[d].textureInfo.opacity=L,b=this.getTextureIndex(b),this._updatesInfoTextures(e.ltileGeoms[d].textureInfo,a,x,b,g,A,_,D,S,P,V))}if((!e.dataFromWebWorkers||e.dataFromWebWorkers&&M)&&(R||(R=this._rendering.getCompleteMaterialInfo(a,r.attributes)),this._shouldCreateLabel(R))){var k={width:t.aabbox.size.x,length:t.aabbox.size.y,height:v+_},z=this._getFeatureDataFromStrid(r.get(this.stridAttribute)),B=p.computePolygonCentroidTurf(z),j=new i.Vector3(B[0],B[1],g);p.is(e.labelMeshes)||(e.labelMeshes=[]),e.labelsNode||(e.labelsNode=new s,e.labelsNode.name="labelsMeshes");let n=p.generateLabelPriorities(this._node,r);e.labelMeshes.push(this._generateLabel(j,a,R,k,void 0,n,e.labelsNode))}(!e.dataFromWebWorkers||e.dataFromWebWorkers&&T)&&this.addOneStroke(e,o,t,r)}},_shouldCreateLabel:function(e){return e&&e.label&&e.label.enable&&e.label.name&&""!==e.label.name},_shouldAddOneStroke:function(e,t){return this._shouldAddOneStrokeForMaterial(this._rendering.getPrimitiveRendering(e,t).getRenderingData())||this._shouldAddOneStrokeForMaterial(this._rendering.currentRendering.getRenderingData())||this._shouldAddOneStrokeForMaterial(this._rendering.defaultRendering.getRenderingData())},_shouldAddOneStrokeForMaterial:function(e){var t="line"===e.geometricMode,i=p.is(e.stroke)&&p.is(e.stroke.enable)&&e.stroke.enable;return t||i},getTextureIndex:function(e){return isNaN(e)&&(e=1),e},initHoles:function(e,t){for(var r=[],s=1;s<e.geometryList.length;s++){for(var n=e.geometryList[s].vertexList,a=[],o=n.length,l=0;l<o;l++)a.push(new i.Vector2(n[l].x-t.x,n[l].y-t.y));r.push(a)}return r},initShape:function(e,t,r,s,n,a){var o,l,h=[],d=[],u=[];for(o=0,l=e.length;o<l;o++)h.push(new i.Vector2(e[o].x-t.x,e[o].y-t.y)),r.posSize.center.add(e[o]),(void 0===d||void 0===u||UWA.equals(d,[])||UWA.equals(u,[]))&&(d=[h[o].x,h[o].y],u=[h[o].x,h[o].y]),d[0]=Math.min(d[0],h[o].x),d[1]=Math.min(d[1],h[o].y),u[0]=Math.max(u[0],h[o].x),u[1]=Math.max(u[1],h[o].y);return r.posSize.width=u[1]-d[1],r.posSize.length=u[0]-d[0],this._currentPrimRendering.geometricMode&&"extruded"!==this._currentPrimRendering.geometricMode&&(n=0),r.posSize.height=n+a+1,r.posSize.altitude=s,r.posSize.center.divideScalar(l),r.posSize.center.z=r.posSize.altitude+r.posSize.height/2,h},addOneStroke:function(e,t,i,r){r.getAttribute(this.stridAttribute);var s=this._currentPrimRendering,n="line"===s.geometricMode,a="extruded"!==s.geometricMode&&p.is(s.stroke)&&p.is(s.stroke.enable)&&s.stroke.enable;if(n||a){if(void 0===i.getVertices(0))return;void 0===e.builder&&(e.builder=new m(this.urban,this._rendering.getStrokeHandler())),a&&p.is(this._currentPrimRendering.stroke.elevationOffset)&&(this._currentPrimRendering.elevationOffset+=this._currentPrimRendering.stroke.elevationOffset),this.createOneLine(e,t,i,r.attributes),a&&p.is(this._currentPrimRendering.stroke.elevationOffset)&&(this._currentPrimRendering.elevationOffset-=this._currentPrimRendering.stroke.elevationOffset)}},createOneLine:function(e,t,i,r){var s,n,a,o,l,h,d=i.geometryList.length,u=this._currentPrimRendering,c=e.posTile,f=1,m=0;p.is(r.floorsNumber)&&(f=r.floorsNumber),p.is(r.floorHeight)&&(m=r.floorHeight);var g=m;if(p.is(r.groundFloorHeight)&&(g=r.groundFloorHeight),u&&u.geometricMode&&"extruded"===u.geometricMode)u.extrusionHeight,!0;else for(a=this._computeAltitudeToApply(u,i.geometryList[0].getVertices()),s=0;s<d;s++){for(n=i.geometryList[s],l=0;l<n.getVertices().length;l++)n.getVertices()[l].x=n.getVertices()[l].x-c.x,n.getVertices()[l].y=n.getVertices()[l].y-c.y,n.getVertices()[l].z=a;var v=n.getVertices(0);for(v[0].x===v[v.length-1].x&&v[0].y===v[v.length-1].y||(n.vertexList.push(n.vertexList[0]),1),h=-1;h<f-1;h++){var _=h*m+g;for(h<0&&(_=0),l=0;l<n.getVertices().length;l++)n.getVertices()[l].z=a+_;o=e.builder.buildOne(t,n,void 0,void 0,r),p.is(e.lines)||(e.lines={}),p.is(e.lines[t.strid])||(e.lines[t.strid]=[]),o.isTransparent&&(e.forceTransparent=!0),e.lines[t.strid].push(o)}for(l=0;l<n.getVertices().length;l++)n.getVertices()[l].z=a}},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1},attributeSetter:{color:"setColor",opacity:"setOpacity"},setGeomAttribute:function(e,t,i){if(e)for(var r=0;r<e.length;r++){var s=THREEDS.SubElement.getFromSGNode(e[r].subElement);e[r].mesh[this.attributeSetter[t]](i,[s.sgNode])}return this},getDatas:function(e){var t=[];return t[0]={attributes:e.userData,target:e.geom},t},_computeAltitudeFromFeature:function(e,t){var r=[],s="MultiPolygon"===e.geometry.type?e.geometry.coordinates[0][0][0]:e.geometry.coordinates[0][0];return p.is(s[2])?r[0]=new i.Vector3(s[0],s[1],s[2]):r[0]=new i.Vector2(s[0],s[1]),this._computeAltitudeToApply(t,r)},_computeLabelPos:function(e,t){var r=this._getFeatureDataFromStrid(e._getStrid());if(p.is(r)){var s,n=p.computePolygonCentroidTurf(r);return(s=new i.Vector2(n[0],n[1])).z=this._computeAltitudeFromFeature(r,t),s}console.error("No feature given so can't compute label pos")},_computeGeometrySize:function(e,t){var r=this._getFeatureDataFromStrid(e._getStrid());if(p.is(r))var s=t.geometricMode,n=!s||"filled"!==s&&"line"!==s?this._getPrimInfo(e).posSize.height:0,a=p.getBbox(r),o={width:a[2]-a[0],length:a[3]-a[1],height:n};else o={center:new i.Vector3,altitude:0,height:0,width:0,length:0};return o}})}),define("DS/XCityRendering/RenderingHandlerFile",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/XCityRendering/RenderingHandlerSpecific"],function(e,t,i,r,s){"use strict";return s.extend({init:function(e){this._parent(e),this._waitingList=[],this.type="File"},getDefaultRendering:function(){},_createMaterial:function(){var t=i.getCustomShaderMaterial([i.common,i.clipPlanes,i.map,i.alphaTest]);return r._setMaterialFromProfile(t,this.currentMaterial),t.side=e.DoubleSide,this.currentMaterial.map&&(t.map=this.currentMaterial.map,this.currentMaterial.map.shared++),i.updateCommonUniforms(t),t},initMesh:function(r){var s=null;t.is(this.currentMaterial)?s=this._createMaterial():((s=i.getCustomShaderMaterial([i.common,i.clipPlanes,i.map,i.alphaTest])).side=e.DoubleSide,this.texture?(s.map=this.texture,this.texture.shared++):this._waitingList.push(s),i.updateCommonUniforms(s)),r.mesh3js.material=s,r.setMaterial(s),r.setShadow(!0,!0)}})}),define("DS/XCityGeometry/PatchVectorFactoryFile",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/XCityLoaders/ModelLoader","DS/XCityGeometry/PatchVectorFactory","DS/XCityRendering/RenderingHandlerFile","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s,n,a){"use strict";return s.extend({init:function(e,i){this._parent(e,i),this.urban=e,this.fileNameAttribute=void 0!==i.fileNameAttribute?i.fileNameAttribute:"FILENAME",this.stridAttribute=void 0!==i.stridAttribute?i.stridAttribute:"STRID",this.pathBuilding=i.path,this.suffix=i.suffix,this.shader=i.shader||"building",this.Shader=i.Shader||{name:this.shader},this.shadow=void 0===i.shadow||i.shadow,this._rendering=new n(e,i),this._node=new t,this._node.name="FactoryFile",this.urlOptions="",a.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},destroy:function(){this.urban.USR.getScene().remove(this._node)},dispose:function(){},getData:function(e){var i=new t;for(var r in e.ltileGeoms){var s=e.ltileGeoms[r];i.add(s)}return i},initMesh:function(e,t,i,r,s){},buildOne:function(e,t,r){var s=e.getAttribute(this.stridAttribute),n=e.getAttribute(this.fileNameAttribute);if(i.is(n)){this.suffix&&(-1!==n.lastIndexOf(".")?n=n.substring(0,n.lastIndexOf(".")+1):n+=".",n+=this.suffix);var a=this.pathBuilding.indexOf("?");""===this.urlOptions&&-1!==a&&(this.urlOptions=this.pathBuilding.substring(a),this.pathBuilding=this.pathBuilding.substring(0,a));var o={name:s,url:this.pathBuilding+n,urlOptions:this.urlOptions,shader:this.Shader,shifted:!0,shadow:this.shadow,rendering:this._rendering,color:e.getAttribute("color"),opacity:e.getAttribute("opacity")},l=this.urban.modelLoader.load(o,t.indexPrimitive);t.ltileGeoms[s]=l}},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1},attributeSetter:{color:"setColor",opacity:"setOpacity"},setGeomAttribute:function(e,t,i){return e[this.attributeSetter[t]](i),this},getDatas:function(e){var t=[],i=this.stridAttribute||"STRID",r={};return e.geom&&(r[i]=e.strid,t[0]={attributes:r,target:e.geom[0].subElement}),t}})}),define("DS/XCityGeometry/RenderingHandlerPipe",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/XCityTools/Disposer","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/Debug","DS/XCityRendering/RenderingHandlerSpecific","DS/XCityTools/RenderingTools"],function(e,t,i,r,s,n,a,o){"use strict";var l=a.extend({init:function(e,t){this._parent(e)},getDefaultRendering:function(){return{side:e.DoubleSide}},_initMaterial:function(){if(!r.is(this._material)){this._material=s.getCustomShaderMaterial([s.common,s.clipPlanes,s.alphaTest,l._pipe,s.urbanLights]),this._material.force=!0,this._material.enableClipPlanes=!0;var e=this.defaultRendering.getRenderingData();o._setMaterialFromProfile(this._material,e),s.updateCommonUniforms(this._material)}return this._material},_getMaterial:function(){var e=this._parent(),t=this.getCompleteMaterialInfo();return o._setMaterialFromProfile(e,t),s.updateCommonUniforms(e),e}});return l._pipe={attributes:{vertexColors:!0},uniforms:{},vertex_pars:["// RenderingPipe - Varyings & Uniforms","// **************************************************","uniform float timer;","varying vec4 cq_color;"].join("\n"),vertex:["// RenderingPipe MAP - Read Pipe info","/////////////////////////////////////////////////","#ifdef USE_COLOR","cq_color = color;","#else","cq_color = vec4(1.0);","#endif","mvPosition = viewMatrix * (modelMatrix * vec4(position,1.0));","gl_Position = projectionMatrix * mvPosition;"].join("\n"),fragment_pars:["// RenderingPipe MAP - Varyings","// **************************************************","varying vec4 cq_color;"].join("\n"),fragment:["    gl_FragColor.a *= cq_color.a;","    #ifdef GAMMA_INPUT","       gl_FragColor.rgb *= cq_color.rgb * cq_color.rgb;","    #else","       gl_FragColor.rgb *= cq_color.rgb;","    #endif"].join("\n")},l}),define("DS/XCityModel/Marker",["DS/XCityTools/Downloader","DS/XCityModel/Location","DS/XCityGeometry/MarkerManager","DS/XCityModel/Item","DS/XCityGeometry/Marker","DS/xCityBasicUtils/Utils","DS/xCityBasicUtils/DataFormatTools","DS/Visualization/ThreeJS_DS","DS/XCityRendering/RenderingHandlerMarker","DS/XCityModel/Folder","DS/XCityModel/Feature","DS/XCityTools/Geocoder","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s,n,a,o,l,h,d,u,c){"use strict";var p=t.extend({defaults:{renderID:"",Rendering:null,url:"",geojson:null,nameAttribute:"NAME",descriptionAttribute:"DESCRIPTION",visibleAttribute:"VISIBLE",selectedAttribute:"SELECTED",stridAttribute:"STRID",objectId:""},metaData:{type:"Location",className:"Marker",customClass:"Marker"},init:function(e){this._parent(e),n.is(e)&&n.is(e._rendering)&&(this._rendering=e._rendering),n.is(e)&&n.is(e.parentId)&&(this._parentId=e.parentId),this._created=!1},create:function(t){var r=this;this._created=!0,this._urban=t._urban,this.initEvents(),n.is(i.markerCollection)||i.build({urban:this._urban}),n.is(this._rendering)||this._initRenderingProfile();var l=this._rendering.getCompleteMaterialInfo();if(!this.get("url")||""===this.get("url")){var f=this.get("position");this.geometryMarker=new s({feature:this,urban:this._urban,markerManager:i,name:this._itemParent?this._itemParent.get("name"):"",selected:!!this._itemParent&&this._itemParent.get("selected"),visible:!this._itemParent||this._itemParent.get("visible"),description:this._itemParent?this._itemParent.get("description"):"",position:f,customClass:l.customClass,style:l.style,stroke:l.stroke,iconName:l.iconName,icon:l.icon,color:"#"+l.color.getHexString(),textStyle:l.textStyle,textColor:"#"+l.textColor.getHexString(),descriptionDisplayMode:l.descriptionDisplayMode}),i.markerCollection.add(this.geometryMarker);var m=a.fromArrayToJSON([f.toArray()],"point");this.set("geojson",m),c.publish(c.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})}if(this.get("url")&&""!==this.get("url")){var g=this.get("url");e.download(g,void 0,9,function(e,t){if(!1!==e&&n.is(t)){r.geometryMarker&&(r.geometryMarker.destroy(),i.markerCollection.remove(r.geometryMarker));var s=JSON.parse(t);r.set("geojson",s),r.privateFolder=r._urban._dataModelPrivate.findChildById("vector_markers"),void 0===r.privateFolder&&(r.privateFolder=new h({id:"vector_markers",name:"vector_markers",visible:!0,opened:!1}),r._urban._dataModelPrivate.addChild(r.privateFolder)),r._itemParent.addEvent("onChange:visible",function(){i.render()});for(var a=0;a<s.features.length;a++)if(s.features[a].geometry){var l,c=s.features[a].geometry;l=s.crs&&"WGS84"!==s.crs.properties.name?{x:c.coordinates[0],y:c.coordinates[1]}:u.proj(c.coordinates,"WGS84",r._urban.baseProjection);var f=Object.assign({},r._rendering.currentMaterial,{position:new o.Vector3(l.x,l.y,c.coordinates[2]?c.coordinates[2]:0),_rendering:r._rendering}),m=new p(f);r._featureSet||(r._featureSet=[]),r._featureSet.push(m);var g=new d({name:"",description:"",selected:r._itemParent.get("selected"),visible:r._itemParent.get("visible")});g.set("Content",m),r.privateFolder.addChild(g),s.features[a].properties[r.get("nameAttribute")]&&m._itemParent.set("name",s.features[a].properties[r.get("nameAttribute")]),s.features[a].properties[r.get("descriptionAttribute")]&&m._itemParent.set("description",s.features[a].properties[r.get("descriptionAttribute")]),s.features[a].properties[r.get("visibleAttribute")]&&m._itemParent.set("visible",s.features[a].properties[r.get("visibleAttribute")]),s.features[a].properties[r.get("selectedAttribute")]&&m._itemParent.set("selected",s.features[a].properties[r.get("selectedAttribute")]),s.features[a].properties[r.get("stridAttribute")]&&m._itemParent.set("strid",s.features[a].properties[r.get("stridAttribute")]);var v=r._rendering.getRenderingValues(m._itemParent.get("strid"),s.features[a].properties);m.applyMaterialOnGeometry(v)}i.onMarkerLayerLoaded({number:s.features.length,id:r._itemParent.get("id")}),i.render()}})}},_initRenderingProfile:function(){this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this._rendering=new l(this._urban),this.renderingProfileManager=this._urban.getRenderingProfileManager(),this.renderingProfileManager.initRendering(this)},destroy:function(){if(this._featureSet)for(var e=0;e<this._featureSet.length;e++)this._featureSet[e].destroy();this.geometryMarker&&(this.geometryMarker.destroy(),i.markerCollection.remove(this.geometryMarker)),this._parent(this.getRoot())},getRendering:function(){return this._rendering},set:function(e,t){var i={},r=this.getRendering();n.is(r)&&r.hasAttribute(e)?(i[e]=t,this.setMaterial(i)):this._parent(e,t)},get:function(e){var t,i,r=this._rendering;return n.is(r)&&r.hasAttribute(e)?(i=this._rendering.getCompleteMaterialInfo(),n.is(i)&&(t=i[e])):t=this._parent(e),t},setMaterial:function(e){if(this._parentId){this.renderingProfileManager||(this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this.renderingProfileManager=this._urban.getRenderingProfileManager()),this.renderingProfileManager.addRendering(this._parentId,e,this.parentFeatureID);var t=this._rendering._elementRendering._materials[this._rendering._elementRendering._ids[this.parentFeatureID]];this.applyMaterialOnGeometry(t)}else this.renderingProfileManager.addRendering(this.parentFeatureID,e)},redraw:function(){var e,t,i=this.getRendering();if(n.is(i)&&n.is(this.geometryMarker))if(this._featureSet)for(var r=0;r<this._featureSet.length;r++)e=this._featureSet[r]._itemParent.get("strid"),t=i.getRenderingValues(e,this.get("geojson").features[r].properties),this._featureSet[r].applyMaterialOnGeometry(t);else t=i.getCompleteMaterialInfo(),this.applyMaterialOnGeometry(t)},applyMaterialOnGeometry:function(e){var t;if(n.is(e)){if(n.is(e.color)&&"annotationIconAdvanced"!==e.style&&(this.geometryMarker.set("color","#"+e.color.getHexString()),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("color","#"+e.color.getHexString());if(n.is(e.style)&&(this.geometryMarker.set("style",e.style),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("style",e.style);if(n.is(e.customClass)&&(this.geometryMarker.set("customClass",e.customClass),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("customClass",e.customClass);if(n.is(e.iconName)&&(this.geometryMarker.set("iconName",e.iconName),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("iconName",e.iconName);if(n.is(e.icon)&&(this.geometryMarker.set("icon",""),this.geometryMarker.set("icon",e.icon),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("icon",e.icon);if(n.is(e.textStyle)&&(this.geometryMarker.set("textStyle",e.textStyle),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("textStyle",e.textStyle);if(n.is(e.stroke)&&(this.geometryMarker.set("stroke",e.stroke),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("stroke",e.stroke);if(n.is(e.textColor)&&(this.geometryMarker.set("textColor","#"+e.textColor.getHexString()),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("textColor","#"+e.textColor.getHexString());if(n.is(e.descriptionDisplayMode)&&(this.geometryMarker.set("descriptionDisplayMode",e.descriptionDisplayMode),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("descriptionDisplayMode",e.descriptionDisplayMode)}},initEvents:function(){var e=this;n.is(this._itemParent)&&(this._itemParent.addEvent("onChange:name",function(){e._itemParent&&e.geometryMarker&&e.geometryMarker.set("name",e._itemParent.get("name"))}),this._itemParent.addEvent("onChange:selected",function(){if(e._itemParent&&(e.geometryMarker&&e.geometryMarker.set("selected",e._itemParent.get("selected")),e._featureSet))for(var t=0;t<e._featureSet.length;t++)e._featureSet[t]._itemParent.set("selected",e._itemParent.get("selected"))}),this._itemParent.addEvent("onChange:visible",function(){if(e._itemParent&&(e.geometryMarker&&e.geometryMarker.set("visible",e._itemParent.get("visible")),e._featureSet))for(var t=0;t<e._featureSet.length;t++)e._featureSet[t]._itemParent.set("visible",e._itemParent.get("visible"))}),this._itemParent.addEvent("onChange:description",function(){e.geometryMarker&&e.geometryMarker.set("description",e._itemParent.get("description"))})),this.addEvent("onChange:position",function(){e._itemParent&&e.geometryMarker&&e.geometryMarker.set("position",e.get("position"))}),this.addEvent("onChange:geojson",function(){if(e.geometryMarker){var t=e.get("geojson");if(t&&t.features&&t.features[0]&&t.features[0].geometry&&t.features[0].geometry.coordinates){var i=t.features[0].geometry.coordinates,r=new o.Vector3(i[0],i[1],i[2]);this.set("position",r)}}})}});return r.ObjectContructor.Marker=p}),define("DS/XCityModel/PointOfInterest3DSet",["DS/XCityModel/Location","DS/XCityModel/Item","DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PointOfInterest3DSet","DS/XCityGeometry/PatchVectorFactoryPointOfInterest3D","DS/XCityModel/LayerVectorPrimitive","DS/XCityModel/LayerVectorCluster","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityTools/Debug","DS/XCityRendering/RenderingHandlerPOI3D","DS/XCityRendering/RenderingHandlerPOI3DBillboard","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/Vector","DS/XCityTools/RTree","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Disposer","DS/XCityTools/Downloader","DS/XCityTools/Geocoder","DS/XCityTools/ExpressionEvaluator"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m,g,v,_,y,b,x,C){"use strict";var S=e.extend({defaults:{url:"",geojson:"",type:"json",styleClass:"",shapeType:"sphere",nbVertices:15,shadingMode:"smooth",_renderMode:"occluded",renderType:"icon",opacityFactor:.3,altitude:0,height:10,switchDistance:500,samplingFactor:1,renderAnchor:!0,anchorLineWidth:1,scale:8,orientation:0,renderID:"",Rendering:null,Clustering:null,nameAttribute:"NAME",stridAttribute:"STRID",styleClassAttribute:"STYLECLASS",altitudeAttribute:"ALTITUDE",heightAttribute:"HEIGHT",orientationAttribute:"ORIENTATION",objectId:"",serviceId:"",rtreeMin:5,rtreeMax:10,rtreeCoverageFactor:2,magnitude:null,interactionBehaviours:{onSelect:{label:!0},onHover:{label:!0}}},metaData:{type:"Location",className:"PointOfInterest3DSet"},loaderJSON:{Clustering:"loadJSONClustering",geojson:"loadJSONObject"},loadJSONClustering:function(e,t,i,r){i.className&&"Clustering"!==i.className||this.set(t,{enable:i.enable,nbSteps:i.nbSteps,minimumHits:i.minimumHits})},setup:function(e){this._parent(),this._poi=void 0,this._scaleZ=!0,this._node=new o,this._node.name="poi3DSetFeature",this._node.hwInstancing=!0,this.addEvent("onChange:rtreeCoverageFactor",this._changeCoverageFactor,this),c.is(e)&&(this._geometrySet=e.geometrySet),this.nbOutside=0,this.nbInside=0,this.nbError=0,this.nbPoint=0,this.nbMultiPoint=0,this.oversized=!1,this.isBuilt=!1,this.nbInputFeature=0,this.oldPrimInfos={}},destroy:function(e){this.primInfos=null,this._data=null,this._factory&&(this._factory.destroy(),this._factory=null),delete this._patch,e.getNode3D().remove(this._node),y.disposeV6(this._node),this._parent(e)},getMesh:function(){return new o},_changeCoverageFactor:function(e){this._factory.rtreeCoverageFactor=this.get("rtreeCoverageFactor")},setClustering:function(e){var t={enable:!(!e||!e.enable)&&e.enable,nbSteps:e&&e.nbSteps?e.nbSteps:6,minimumHits:e&&e.minimumHits?e.minimumHits:1};this.set("Clustering",t);var i=!0===t.enable;i&&!this.clusteringMode?(this._geometrySet?this._geometrySet.getNode3D().remove(this._node):this.getRoot().getNode3D().remove(this._node),this._node=new o,this._node.name="poi3DSetFeature",this._node.hwInstancing=!0,this._poi=void 0,this.create(this._root||this.getRoot())):!i&&this.clusteringMode&&(this._geometrySet?this._geometrySet.getNode3D().remove(this._node):this.getRoot().getNode3D().remove(this._node),this._node=new o,this._node.name="poi3DSetFeature",this._node.hwInstancing=!0,this._poi=void 0,this.create(this._root||this.getRoot()))},rebuild:function(){this.oldPrimInfos=Object.assign({},this.primInfos),this._createSet(this._data,!0)},_createSet:function(e,t){if(this.nbPoint=0,this.nbMultiPoint=0,!1===t)return this.isBuilt=!0,void p.publish(p.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()});var r,s;e instanceof ArrayBuffer&&(e=(new TextDecoder).decode(e)),this._data=e;var n,a=this.get("type");"json"===a?r=new f:"gml"===a?r=new VectorLoaderGML:"enovia"===a&&(r=new VectorLoaderEnovia(urban)),void 0===this.geojson?(s=r.loadDataSourceFromObject("string"==typeof e?JSON.parse(e):e),n="string"==typeof e?JSON.parse(e):e):(s=r.loadDataSourceFromObject("string"==typeof e?JSON.parse(e):e),this.geojson=void 0,n="string"==typeof e?JSON.parse(e):e);var h=n.crs&&n.crs.properties&&n.crs.properties.name?n.crs.properties.name:"WGS84";if(-1===h.indexOf("AUTHORITY")){var d=h.indexOf("EPSG"),u=h.indexOf("CRS84");d>0?h=h.slice(d):u>0&&(h="WGS84"),h=h.replace("::",":")}this._inputCRS=h,this.nbOutside=0,this.nbInside=0,this.nbError=0;var g=s.count;if(this.nbInputFeature=g,0===g)return this.isBuilt=!0,this.oversized=!1,void p.publish(p.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()});this.nbFeatureMax=xCity._urbanImpl.USR.getProfilePerformance().getValue("maxPointPreview"),this.oversized=!1,this.nbInputFeature>g&&(this.oversized=!0);var v=new m.Feature;this.clusteringMode=!1;var _=void 0,y=this.get("Clustering");y&&y.enable&&(_=1,this.clusteringMode=!0);var b=[{tile:{LOD:0,I:0,J:0},infos:{}}],C=[];h!==this.urban.baseProjection&&x.loadProjection(h);this._poi=new o,this.primInfos={},this._node.userData=this._itemParent,this._factory._node.userData=this._itemParent,this._itemParentVisible(this._itemParent);var S=this.getLocalPosition(),D=(new i.Matrix4).identity().setPosition(new i.Vector3(S.x,S.y,0));this._node.setMatrix(D),this._patch={register:function(e,t){var r=this.primInfos[e];r?(r.listeners?r.listeners.push(t):r.listeners=[t],r.tile&&t(r)):this.primInfos[e]={listeners:[t],strid:e,tile:{LOD:0,I:0,J:0},posSize:{center:new i.Vector3,altitude:0,height:0,width:0,length:0},userData:{}}}.bind(this),unregister:function(e,t){var i=this.primInfos[e];if(i&&i.listeners){for(var r=-1,s=0;s<i.listeners.length;++s)if(i.listeners[s].name===t.name){r=s;break}r>-1&&i.listeners.splice(r,1)}}.bind(this),previewMode:!0,_uidListeners:b[0].infos};var P=function(){this._node.addChild(this._factory.getData(b[0])),Object.assign(this.primInfos,b[0].infos),p.publish(p.eventsList.onUpdate+":"+this.get("id"),{loaded:1,total:1}),1===_&&(b[0].rtree.computeClusterIds(),b[0].rtree.computeDistances(xCity._urbanImpl.getViewpoint().camera.projectionMatrix.elements[0],xCity._urbanImpl.getViewpoint().camera.projectionMatrix.elements[5]),b[0].rtree.firstUpdate=!0);var e=function(e){if(e instanceof l&&!0===e.pickable){e.show();var t=e.getPrimitives();if(e.isInstanceNode3D){var i=e.mesh3js.userData.cgmIds;if(void 0!==i)for(var r=i.length-1;r>=0;--r){var s;if(s=b[0].infos[i[r]]){s.geom?s.geom.push({mesh:e,subElement:t[0].sgNode}):s.geom=[{mesh:e,subElement:t[0].sgNode}];var n=this.oldPrimInfos[i[r]];if(c.is(n&&n.listeners)&&(s.listeners=n.listeners),s.listeners&&s.listeners.length>0)for(let e=0;e<s.listeners.length;++e){(0,s.listeners[e])(s)}}}}}}.bind(this);this._node.traverse(e.bind(this)),this._node.children.length>0&&this._node.children[0].children&&this._node.children[0].children.length>0&&(this._node.children[0].children[0].userData={records:C}),this.isBuilt=!0,p.publish(p.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})}.bind(this);this.nbBuiltTotal=0;var w=function(){for(var e=!1,t=0;t<g;++t){t===g-1&&(e=!0),s.getNextFeature(v);var r=v.getGeometry(),n=!0,a=this.urban.baseReferential.bbox;if(r&&r.type===m.Type.MULTIPOINT)for(var o=r.geometryList,l=0;l<o.length;++l){if(h!==this.urban.baseProjection){var d=x.proj(o[l],h,this.urban.baseProjection);o[l].x=d.x,o[l].y=d.y}n&&o[l].x>a.xmin&&o[l].x<a.xmax&&o[l].y>a.ymin&&o[l].y<a.ymax&&(this.nbMultiPoint++,n=!1)}else{if(!r||r.type!==m.Type.POINT){this.nbError++;continue}if(h!==this.urban.baseProjection){d=x.proj(r,h,this.urban.baseProjection);r.x=d.x,r.y=d.y}n&&r.x>a.xmin&&r.x<a.xmax&&r.y>a.ymin&&r.y<a.ymax&&(this.nbPoint++,n=!1)}if(n)this.nbOutside++;else{this.nbInside++;var u={listeners:null,strid:v.getAttribute(this._factory.stridAttribute),tile:{LOD:0,I:0,J:0},posSize:{center:new i.Vector3,altitude:0,height:0,width:0,length:0},userData:{}};if(void 0===u.strid&&(this.fromGeometrySet?u.strid=this.get("id")+"_"+(this.nbPoint+this.nbMultiPoint):u.strid=this.get("id")+"_point_"+(this.nbPoint+this.nbMultiPoint),v.attributes[this._factory.stridAttribute]=u.strid),r){var c,f;for(f=(c=v.getAttributeKeys()).length;f--;)u.userData[c[f]]=v.getAttribute(c[f]);C.push(u),b[0].infos[u.strid]=u,this.nbFeature++,this._factory.buildOne(v,b[0],u,_)}0,this.nbBuiltTotal++}}e&&p.subscribeTo("/3DEXPERIENCity/onPostUpdate",P,!0)}.bind(this),M=function(){void 0===x.projections[h]||1!==x.projections[h].ready?p.subscribeTo("/3DEXPERIENCity/onPostUpdate",M,!0):p.subscribeTo("/3DEXPERIENCity/onPostUpdate",w,!0)}.bind(this);p.subscribeTo("/3DEXPERIENCity/onPostUpdate",M,!0)},create:function(e){if(this._urban=e._urban,!this._parent(e))return p.publish(p.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;this.fromGeometrySet=!1,this._itemParent.get("Content")._poiSet&&this._itemParent.get("Content")._lineSet&&this._itemParent.get("Content")._polygonSet&&(this.fromGeometrySet=!0),e.getNode3D().add(this._node),this.urban=e._urban;var t={nameAttribute:this.get("nameAttribute"),stridAttribute:this.get("stridAttribute"),styleClassAttribute:this.get("styleClassAttribute"),altitudeAttribute:this.get("altitudeAttribute"),heightAttribute:this.get("heightAttribute"),orientationAttribute:this.get("orientationAttribute"),scale:this.get("scale"),shapeType:this.get("shapeType"),shadingMode:this.get("shadingMode"),renderType:this.get("renderType"),renderMode:this.get("renderMode"),samplingFactor:this.get("samplingFactor"),opacityFactor:this.get("opacityFactor"),switchDistance:this.get("switchDistance"),renderAnchor:this.get("renderAnchor"),anchorLineWidth:this.get("anchorLineWidth"),nbVertices:this.get("nbVertices"),alwaysDisplayText:this.get("alwaysDisplayText"),geometrySet:this._geometrySet};this._factory=new s(this.urban,t),this._factory.rtreeMax=this.get("rtreeMax"),this._factory.rtreeMin=this.get("rtreeMin"),this._factory.rtreeCoverageFactor=this.get("rtreeCoverageFactor"),this._factory._magnitude=this.get("magnitude"),this._factory.eventOnVisibilityParent=!0,this._factory._clusterSteps=[2,10,100,1e3,1e4,1e5,1e6,1e7],this._factory.rdblink=!1,this.renderingProfileManager=this.urban.getRenderingProfileManager(),this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this._rendering=this._factory._rendering,this._rendering.defaultRendering.addOver({renderMode:"overlay"}),this.renderingProfileManager.initRendering(this),this._geometrySet&&this._geometrySet.getRendering()&&this._geometrySet.getRendering()._subRenderingHandler&&(this._geometrySet._poiSet._rendering=this._rendering,this._geometrySet.getRendering()._subRenderingHandler[0]=this._rendering),this.nbPoint=0,this.nbMultiPoint=0,this.isBuilt=!1;var r=this.get("scale");"number"==typeof r&&(r=new i.Vector3(r,r,r));this.getLocalPosition();this.nbFeature=0;var n=function(){if(this._factory.isReady&&this._factory.isReady()){var e=this.get("serviceId");if(void 0!==this.get("objectId")&&""!==this.get("objectId")&&void 0!==e&&""!==e)"3DSpace"===e?b.downloadFrom3DSpace(this.get("objectId")).then(function(e){this._createSet(e,!0)}):"3DDrive"===e&&b.downloadFrom3DDrive(this.get("objectId")).then(function(e){this._createSet(e,!0)});else if(""!==this.get("url")){var t=this.get("url");b.download(t,{},99999,function(e,t,i,r){r(t,e,i)},void 0,this._createSet.bind(this))}else null!==this.get("geojson")&&(this.geojson=!0,this._createSet(this.get("geojson"),!0))}else p.subscribeTo("/3DEXPERIENCity/onPostUpdate",n,!0)}.bind(this);return n(),!0},getRendering:function(){return this._rendering},redraw:function(){var e=this.getRendering();c.is(e)&&(e._needRebuild&&this._node.children.length>0&&(y.disposeV6(this._node),this.rebuild()),e.applyRendering(this._node.children[0]),e._needRebuild=!1)},setItemParent:function(e){this._itemParent&&(this._itemParent.removeEvent("onChange:name",this._updateName),this._itemParent.removeEvent("onChange:visible",this._itemParentVisible)),this._itemParent=e,e&&(this._itemParent.addEvent("onChange:name",this._updateName,this),this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this))},_updatePosition:function(){this._parent();var e=this.getLocalPosition();if(this._node){var t=(new i.Matrix4).identity().setPosition(new i.Vector3(e.x,e.y,e.z));this._node.setMatrix(t)}},_updateName:function(){},_itemParentVisible:function(e){this._created&&this._node.setVisibility(e.get("visible"))},_select:function(e){var t;if(this._poi)if(e.get("selected")){var s=e.getContent()._node.instanceId,n=e.getContent()._node.children[0].children[0].children[0].mesh3js.userData.cgmIds[(s-5)/5],a=this.bboxes[n];new i.MeshLambertMaterial({color:16777215,side:i.DoubleSide}).force=!0;var l=a.min,h=a.max,d=new i.Vector3;d.subVectors(h,l),d.add(h);var u=_.createRectangleNode({width:h.x-l.x,height:h.y-l.y,fill:!0,color:new v.Color(.5,.2,.5,1)}),c=new o;c.addChild(u),c.setMatrix((new i.Matrix4).setPosition(l)),c.setPickable(v.NOPICKABLE),c.isAreaCluster=!0,this._node.addChild(c),this._bboxNode=c;var p={styleClass:this.get("styleClass"),pClass:"poiText",samplingFactor:this.get("samplingFactor")};(t=r.generateTextNode(this.urban,this._itemParent.get("name"),p))._excludeFromCSO=!0,t._excludeFromHSO=!0,t._excludeFromHL=!0,t._excludeFromPSO=!0,t._excludeFromPreHL=!0;var f=e.getContent().get("position");t.setMatrix((new i.Matrix4).translate(new i.Vector3(f.x,f.y,f.z))),this._node.addChild(t)}else(t=this._node.getChildByName("text"))&&this._node.removeChild(t),this._node.removeChild(this._bboxNode)},get:function(e){var t,i,r=this.getRendering();return this.renderingProfileManager&&c.is(r)&&r.hasAttribute(e)?(i=this.getMaterial(),c.is(i)&&(t=i[e])):t=this._parent(e),t},set:function(e,t){var i={},r=this.getRendering();this.renderingProfileManager&&c.is(r)&&r.hasAttribute(e)?(i[e]=t,this.setMaterial(i)):this._parent(e,t)},getMaterial:function(){var e=this.getRendering();return c.is(e)?e.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},getBoundingSphere:function(){if(this._localPosition&&this._node){if(c.is(this._factory)&&c.is(this._factory.rtrees)){var e={minX:this._factory.rtrees[0]._root.boundingBox.min.x,minY:this._factory.rtrees[0]._root.boundingBox.min.y,minZ:this._factory.rtrees[0]._root.boundingBox.min.z,maxX:this._factory.rtrees[0]._root.boundingBox.max.x,maxY:this._factory.rtrees[0]._root.boundingBox.max.y,maxZ:this._factory.rtrees[0]._root.boundingBox.max.z},t=this._localPosition;t.z=this._node.bSphere.center.z;var r=Math.sqrt(Math.pow(e.maxX-e.minX,2)+Math.pow(e.maxY-e.minY,2)+Math.pow(e.maxZ-e.minZ,2))/2;return new i.Sphere(t,r)}return this._node.getBoundingSphere()}},createPrimitive:function(e,t){var i;if(this._factory&&this._factory.getGeoJSON&&(i=this._factory.getGeoJSON(e)),void 0===t){var r=function(i){if(i instanceof l&&!0===i.pickable&&i.isInstanceNode3D){var r=i.mesh3js.userData.cgmIds;if(void 0!==r)for(var s=r.length-1;s>=0;--s)r[s]===e&&(t=5*s+5)}}.bind(this);this._node.traverse(r.bind(this))}var s=new n({strid:e,geojson:i,instanceId:t});return s.setLayerVector(this),s.create(this.getRoot()),s.addSubElements(this.primInfos[e]),s},createCluster:function(e,t,r){var s;this._factory&&this._factory.getGeoJSON&&(s=this._factory.getGeoJSON(e));var n=new a({strid:e,geojson:s,instanceId:t,clusterInfo:r});n.setLayerVector(this),n._localPosition=new i.Vector3,n.create(this.getRoot());var o=this._node.children[0].children[0].children[0];return n._subMeshes.push({mesh:o,subElement:o.getPrimitives()}),n._subMeshes.instanceId=t,n},register:function(e){},unregister:function(e){},redrawPrimitive:function(e){if(c.is(this._patch)){var t=this.getRendering();c.is(t)&&(t.isPrimitiveRegistered(e)?t._renderprimitive(e):this.registerPrimitive(e))}},registerPrimitive:function(e){if(c.is(this._patch)){var t=this.getRendering();c.is(t)&&(t.isPrimitiveRegistered(e)||t.registerPrimitive(this._patch,e))}},registerPrimitives:function(e){var t,i,r=Object.keys(e),s=r.length;for(t=0;t<s;t++)i=r[t],this.registerPrimitive(i)},addUserDataProperty:function(e,t,i){if(c.is(e)){var r=this.get("geojson"),s=r.features[0];if(c.is(i))for(var n=0;n<r.features.length;n++){var a=r.features[n];if(a&&a.properties&&a.properties.STRID===i){s=a;break}}s.properties||(s.properties={}),s.properties[e]=t;var o=this.get("userData");return o||(o={},this.set("userData",o)),o[e]=t,!0}return!1},removeUserDataProperty:function(e,t){if(c.is(e)){var i=this.get("geojson"),r=i.features[0];if(c.is(t))for(var s=0;s<i.features.length;s++){var n=i.features[s];if(n&&n.properties&&n.properties.STRID===t){r=n;break}}c.is(r.properties[e])&&delete r.properties[e];var a=this.get("userData");return c.is(a[e])&&delete a[e],!0}return!1},findPrimitivesByCriteria:function(e){var t=new C(e),i={};if(!c.is(t))return null;var r;for(var s in this.primInfos){var n=this.primInfos[s].userData;!0===(r=n,t.apply(r)||!1)&&(i[s]=n)}return i}});return t.ObjectContructor.PointOfInterest3DSet=S}),define("DS/XCityGeometry/PatchVectorFactoryPipe",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/WebappsUtils/WebappsUtils","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityGeometry/RenderingHandlerPipe","DS/Mesh/MeshUtils","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/XCityGeometry/PatchVectorFactory"],function(e,t,i,r,s,n,a,o,l,h){"use strict";return h.extend({init:function(e,i){this._parent(e,i),this.urban=e,this.renderer=e.getView3D(),this.supportWorkers=!1,this.altitudeAttribute=i.altitudeAttribute?i.altitudeAttribute:"ALTITUDE",this.radiusAttribute=i.radiusAttribute?i.radiusAttribute:"RADIUS",this.stridAttribute=i.stridAttribute?i.stridAttribute:"STRID",this.colorAttribute=i.colorAttribute?i.colorAttribute:"COLOR",this._node=new t("FactoryPipe"),this._debugID=0,this._editable=!0,this.identifier=0,this._treeid=0,this.nbInfoPixels=1,this.isPickable=void 0===i.isPickable||i.isPickable,this._rendering=new n(e,i),l.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},destroy:function(){this.urban.USR.getScene().remove(this._node)},dispose:function(){o.warn("Dispose: UrbanPipe")},getData:function(t){this._treeid=0;var i=null;i=!0===this._editable?t.creator.compilePrimitive("Tree",!0):t.creator.compilePrimitive("Tree");var r=s.createMeshNode(i);r.setMatrix((new e.Matrix4).identity().setPosition(new e.Vector3(t.posTile.x,t.posTile.y,0))),this.isPickable?r.setPickable(a.PICKABLE):r.setPickable(a.NOPICKABLE);var n=t.tile.LOD+"_"+t.tile.I+"_"+t.tile.J+"_pipe";return r.name=n,r.mesh3js.name=n,r.trees=!0,r._debugID=this._debugID,r.setColor=function(e,t){for(var i=this.getBuffer(a.VertexComponentEnum.DIFFUSE_COLOR),r=t[0].start/12*8,s=0;s<8;s++)i[4*(s+r)]=e.r,i[4*(s+r)+1]=e.g,i[4*(s+r)+2]=e.b;return this.updateBuffer(a.VertexComponentEnum.DIFFUSE_COLOR,0,t[0].group.geometry.vertexPositionArray.length/3),this},r.setOpacity=function(e,t){for(var i=this.getBuffer(a.VertexComponentEnum.DIFFUSE_COLOR),r=t[0].start/12*8,s=0;s<8;s++)i[4*(s+r)+3]=e;return this.updateBuffer(a.VertexComponentEnum.DIFFUSE_COLOR,0,t[0].group.geometry.vertexPositionArray.length/3),this},this._rendering.initMesh(r),r.setRenderPasses(["UNDERGROUND_PREPASS","UNDERGROUND_POSTPASS"]),r},buildOne:function(t,i,s){var n,a,l,h,d,u=function(t,i){var r,s,n;return 0==(r=new e.Vector3(i.x-t.x,i.y-t.y,i.z-t.z)).z?s=new e.Vector3(0,0,1):0!=r.x||0!=r.y?s=r.z<0?new e.Vector3(r.x,r.y,(-r.x*r.x-r.y*r.y)/r.z):new e.Vector3(-r.x,-r.y,(r.x*r.x+r.y*r.y)/r.z):(r=new e.Vector3(0,0,1),s=new e.Vector3(1,0,0)),r.normalize(),s.normalize(),(n=new e.Vector3).crossVectors(r,s),[r,s,n]},c=function(t,i,r,s,n,a){for(var l,h,d,c,p,f,m,g,v,_,y=t.creator,b=t.posTile,x=r.length,C=new e.Vector3,S=new e.Vector3,D=[],P=[],w=0;w<8;++w)D[w]=Math.cos(2*w*Math.PI/8),P[w]=Math.sin(2*w*Math.PI/8);var M=!isNaN(s);y.startPrimitive();for(var T=0;T<x;++T){var I=M?s:r[T].z,R=I;T>0&&(R=M?s:r[T-1].z);var A=I;if(T<x-1&&(A=M?s:r[T+1].z),0===T){g=new e.Vector3(r[0].x-b.x,r[0].y-b.y,I),v=new e.Vector3(r[1].x-b.x,r[1].y-b.y,A),h=(l=u(g,v))[0],d=l[1],c=l[2];for(w=0;w<8;++w)S.addVectors(new e.Vector3(d.x*D[w],d.y*D[w],d.z*D[w]),new e.Vector3(c.x*P[w],c.y*P[w],c.z*P[w])),C.addVectors(g,new e.Vector3(S.x*n,S.y*n,S.z*n)),y.pushVertex([C.x,C.y,C.z]),y.pushNormal([S.x,S.y,S.z])}else if(T==x-1){g=new e.Vector3(r[T-1].x-b.x,r[T-1].y-b.y,R),v=new e.Vector3(r[T].x-b.x,r[T].y-b.y,I),h=(l=u(g,v))[0],d=l[1],c=l[2];for(w=0;w<8;++w)S.addVectors(new e.Vector3(d.x*D[w],d.y*D[w],d.z*D[w]),new e.Vector3(c.x*P[w],c.y*P[w],c.z*P[w])),C.addVectors(v,new e.Vector3(S.x*n,S.y*n,S.z*n)),y.pushVertex([C.x,C.y,C.z]),y.pushNormal([S.x,S.y,S.z])}else{g=new e.Vector3(r[T-1].x-b.x,r[T-1].y-b.y,R),_=new e.Vector3(r[T].x-b.x,r[T].y-b.y,I),v=new e.Vector3(r[T+1].x-b.x,r[T+1].y-b.y,A),h=(l=u(g,_))[0],d=l[1],c=l[2],p=(l=u(_,v))[0],f=l[1],l[2],T==x-2&&o.log("break"),h.add(p).multiplyScalar(.5),d.add(f).multiplyScalar(.5),c.crossVectors(h,d),m=1/Math.abs(h.x*p.x+h.y*p.y+h.z*p.z);for(w=0;w<8;++w)S.addVectors(new e.Vector3(d.x*D[w],d.y*D[w],d.z*D[w]),new e.Vector3(c.x*P[w],c.y*P[w],c.z*P[w])),C.addVectors(_,new e.Vector3(S.x*n*m,S.y*n*m,S.z*n)),y.pushVertex([C.x,C.y,C.z]),y.pushNormal([S.x,S.y,S.z])}}for(T=0;T<x-1;++T)for(var F=0;F<8;++F)y.pushVertexIndices([8*T+F,8*T+(F+1)%8,8*(T+1)+F]),y.pushColor([a.r,a.g,a.b,1]),y.pushVertexIndices([8*T+(F+1)%8,8*(T+1)+(F+1)%8,8*(T+1)+F]),y.pushColor([a.r,a.g,a.b,1]);y.endPrimitive(i)}.bind(this);n=t.getAttribute(this.stridAttribute),a=t.getGeometry().vertexList,l=new e.Color(t.getAttribute(this.colorAttribute)||this.colorAttribute||16777215),((d=t.getAttribute(this.radiusAttribute))<.1||void 0===d)&&(d=.1);var p=Number(this.altitudeAttribute);if(isNaN(p)){var f=Number(t.getAttribute(this.altitudeAttribute));h=isNaN(f)?-10:f}else h=p;void 0===i.posTile&&(i.posTile=new e.Vector2(Math.round(a[0].x),Math.round(a[0].y))),i.posTile,void 0===i.creator&&(i.creator=new r({indexed:!0,normalBinding:r.Binding.VERTEX,useTexCoord:!1,useColor:!0,colorBinding:r.Binding.FACE})),void 0===i.bSphere&&(i.bSphere=new e.Sphere,i.bSphere.center.z=isNaN(h)?0:h),c(i,n,a,h,d,l)}})}),define("DS/XCityGeometry/PatchVectorFactoryMarker",["UWA/Core","UWA/Class","DS/XCityGeometry/PatchVectorFactoryPointGeometry","DS/XCityModel/Marker","DS/XCityLayer/Vector","DS/XCityModel/Folder","DS/XCityModel/Feature","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityRendering/RenderingHandlerMarker","DS/XCityGeometry/MarkerManager"],function(e,t,i,r,s,n,a,o,l,h,d){"use strict";return i.extend({init:function(e,t,i){var r=this;this._parent(e,t,i),this.urban=e,this._parentId=i,this.nameAttribute=void 0!==t.nameAttribute?t.nameAttribute:"NAME",this.descriptionAttribute=void 0!==t.descriptionAttribute?t.descriptionAttribute:"DESCRIPTION",this.selectedAttribute=void 0!==t.selectedAttribute?t.selectedAttribute:"SELECTED",this.visibleAttribute=void 0!==t.visibleAttribute?t.visibleAttribute:"VISIBLE",this.stridAttribute=void 0!==t.stridAttribute?t.stridAttribute:"STRID",this.privateFolder=this.urban._dataModelPrivate.findChildById("vector_markers"),this._rendering=new h(this.urban),void 0===this.privateFolder&&(this.privateFolder=new n({id:"vector_markers",name:"vector_markers",visible:!0,opened:!1}),this.urban._dataModelPrivate.addChild(this.privateFolder)),this._node=new l,this._node.add=function(e){var t,i;if(r._node.addChild(e),e&&e.features)for(t=0,i=e.features.length;t<i;++t)e.features[t].getContent().geometryMarker._quadTreeVisibleFlag=!0,e.features[t].getContent().geometryMarker.updateVisibility();d.render()},this._node.setVisibility=function(){},this._node.name="FactoryMarker",this._node.remove=function(e){var t,i;if(r._node.removeChild(e),e&&e.features)for(t=0,i=e.features.length;t<i;++t)e.features[t].getContent().geometryMarker._quadTreeVisibleFlag=!1,e.features[t].getContent().geometryMarker.updateVisibility()}},destroy:function(){if(this._node&&this._node.children&&this._node.children[0]&&this._node.children[0].features){var e,t,i=this._node.children[0].features;for(e=0,t=i.length;e<t;++e)i[e].get("Content")&&i[e].get("Content").destroy()}},buildOne:function(e,t,i){void 0===t.markers&&(t.markers=[]);var n=e.getGeometry();if(n.type===s.Type.POINT){var l=n.getVertices(),h=Object.assign({},this._rendering.currentMaterial,{position:new o.Vector3(l[0],l[1],e.getAttribute(this.altitudeAttribute)?e.getAttribute(this.altitudeAttribute):0),_rendering:this._rendering,parentId:this._parentId}),d=new r(h),u=new a({id:e.getAttribute(this.stridAttribute)?e.getAttribute(this.stridAttribute):"",name:e.getAttribute(this.nameAttribute)?e.getAttribute(this.nameAttribute):"",description:e.getAttribute(this.descriptionAttribute)?e.getAttribute(this.descriptionAttribute):"",selected:!!e.getAttribute(this.selectedAttribute)&&e.getAttribute(this.selectedAttribute),visible:!e.getAttribute(this.visibleAttribute)||e.getAttribute(this.visibleAttribute)});u.set("Content",d),t.markers.push(u),this.privateFolder.addChild(u);var c=this._rendering.getRenderingValues(e.getAttribute(this.stridAttribute),e.attributes);d.applyMaterialOnGeometry(c)}},getData:function(e){var t=new l;return t.name="FactoryMarker",t.features=e.markers,t},select:function(e){var t,i;if(this._node&&this._node.children)for(t=0,i=this._node.children.length;t<i;++t)if(this._node.children[t]&&this._node.children[t].features){var r,s,n=this._node.children[t].features;for(r=0,s=n.length;r<s;++r)n[r].set("selected",e.get("selected"))}}})}),define("DS/XCityRendering/RenderingHandlerPolygon",["DS/XCityRendering/RenderingHandlerBuilding","DS/xCityBasicUtils/Utils","DS/xCityBasicUtils/ColorGradient","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/Visualization/ThreeJS_DS","DS/XCityTools/TextureManager","DS/XCityRendering/RenderingHandlerAtlasing","DS/XCityTools/TextureTools"],function(e,t,i,r,s,n,a,o,l){"use strict";var h=e.extend({init:function(e,t,i){this._parent(e,t,i),this.enableAtlasing=!0,this.type="Polygon",this._usePolygonExtrusionOptim=!1},getDefaultRendering:function(){var e=Object.assign({},this._parent(),{renderMode:"dual",opacityFactor:.3,opacity:.8,elevationOffset:.1,ambient:new i(new n.Color("#000000")),diffuse:new i(new n.Color("#000000")),color:new i(new n.Color("#000000")),geometricMode:"filled",wallTexturesUrl:void 0,roofTexturesUrl:void 0,extrusionHeight:100,lineWidth:4,alphaTest:.01,stroke:this._defaultStrokeParameters,map:null,mapUrl:null,mapParams:{wrapS:1e3,wrapT:1e3},repeatUv:new n.Vector2(1,1),offsetUv:new n.Vector2(0,0),texturingMode:"cameraStop",polyExtruOptim:!1});return this._defaultStrokeParameters={enable:!1,opacityFactor:.3,minOpacity:.4,minDist:100,elevationOffset:.05,maxDist:2e3,lineWidth:2,minWidth:1,dynamicUpdate:!1,animation:{},ambient:new i(new n.Color("#000000")),diffuse:new i(new n.Color("#000000")),color:new i(new n.Color("#000000")),opacity:1,dashPattern:null},e.stroke=this._defaultStrokeParameters,e},shouldRebuild:function(e,t){if(this._parent(e,t))return!0;var i=e.getRenderingData(),r=t.getRenderingData(),s=r.geometricMode,n=i.geometricMode;if(s!==n){var a={stroke:{enable:!1}};return"extruded"===s?this.defaultRendering.addOver(a):"line"===s?(a.stroke.enable=!0,this.defaultRendering.addOver(a)):this.defaultRendering.addOver(a),!0}return"extruded"===s&&(s=r.extrusionHeight,(n=i.extrusionHeight)!==s)||((s=r.renderMode)!==(n=i.renderMode)&&("dual"===s||"dual"===n)||(s=r.mapUrl)!==(n=i.mapUrl))},updateRendering:function(e){void 0!==e.getRenderingData().polyExtruOptim&&this._setUsePolygonExtrusionOptim(e.getRenderingData().polyExtruOptim),this._parent(e)},_getCommonShaderStructure:function(){var e=this._parent(),t={usePolygonExtrusionOptim:{type:"b",value:this._usePolygonExtrusionOptim}};return Object.assign(e.uniforms,t),e.VS_overridableFunctions.ComputeObjectPosition=["if(usePolygonExtrusionOptim == false) return vGetAttribPosition();","float b_pixPerRow = b_rgba2int( texture2D( b_infoTexture, vec2( 0.0, 0.0 ) ) );","float b_nbBuilding = b_rgba2int( texture2D( b_infoTexture, vec2( 1.5/b_pixPerRow, 0.0 ) ) );","float b_indice = (vGetAttribTexCoord0().x + .5)/b_nbBuilding;","float b_altitude = b_rgba2int( texture2D( b_infoTexture, vec2( 2.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 3.5/b_pixPerRow, b_indice ) ) );","vec3 vertexposition = vGetAttribPosition();","float b_height = b_rgba2int( texture2D( b_infoTexture, vec2( 4.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 5.5/b_pixPerRow, b_indice ) ) );","vec4  primflags = texture2D( b_infoTexture, vec2( 17.5/b_pixPerRow, b_indice ) ) ;","float buildingheight = vertexposition.z - b_altitude;","//vec3 position = vertexposition;","vec3 position = vGetAttribPosition();","float factor = extrusionFactor;","if((primflags.x > 3.5)&&(buildingheight > 0.0)) {","  position.z = position.z - buildingheight + b_height;","}","return position;"].join("\n"),e},_initRoofMaterial:function(){if(!t.is(this._roofMaterial)){var e={uvMode:{type:"f",value:1},offsetUvCity:{type:"v2",value:new n.Vector2(0,0)},repeatUvCity:{type:"v2",value:new n.Vector2(0,0)},mapCity:{type:"t2",value:r.whiteMap},useMapCity:{type:"b",value:!1},mapCityLoaded:{type:"b",value:!0},lastCameraAltitude:{type:"f",value:1},textureWidth:{type:"f",value:1},textureHeight:{type:"f",value:1},atlasOffsetTexture:{type:"t2",value:o.defaultAtlasOffsetTexture}},i={texCoordCity:{type:"v2",value:new n.Vector2(0,0)},noMap:{type:"f",value:0},currentOffsetX:{type:"f",value:0},currentOffsetY:{type:"f",value:0},currentOffsetHeight:{type:"f",value:1},currentOffsetWidth:{type:"f",value:1}},s=this._getCommonShaderStructure();s.uniforms=Object.assign(s.uniforms,e),s.varyings=Object.assign(s.varyings,i),s.VS_overridableFunctions.ComputeVaryingValues=[s.VS_overridableFunctions.ComputeVaryingValues,"  float textureIndex = b_texIndice;","  int index = int(textureIndex);","    vec4 currentOffset = texture2D(atlasOffsetTexture, vec2(0.5, (textureIndex+0.5)/800.0));","    currentOffsetX = currentOffset.x;","    currentOffsetY = currentOffset.y;","    currentOffsetHeight = currentOffset.z;","    currentOffsetWidth = currentOffset.w;","    vec3 position = vGetAttribPosition();","    vec4 worldPos = modelMatrix * vec4(position.xyz, 1.0);","    float altitudeCamera = lastCameraAltitude - worldPos.z;","    vec2 vUvvuc = (worldPos.xy);","    vUvvuc.xy = vUvvuc.xy * min(1.0,(1.0/abs(altitudeCamera)));","    vec2 textureScaleFactor = 1.3 * 4.0 * 256.0 / vec2(max(1.0,textureWidth),max(1.0,textureHeight));","//vUvvuc.xy = vUvvuc.xy * repeatUvCity * textureScaleFactor / currentOffset.wz;","    vUvvuc.xy = vUvvuc.xy * repeatUvCity * textureScaleFactor / vec2(currentOffsetWidth, currentOffsetHeight);","    vUvvuc.xy = vUvvuc.xy + offsetUvCity;","    texCoordCity = vUvvuc.xy;","    noMap = 0.0;","if(uvMode <= 0.5){","    texCoordCity.xy = uv2;","}",""].join("\n"),s.FS_global_code=[s.FS_global_code,"vec4 _texelCity = vec4(1.0);","float _alphaCity = 1.0;"].join("\n"),s.FS_overridableFunctions.ComputeCommonValues=["if (useMapCity && mapCityLoaded ) {","//vec2 mytexCoordCity = fract(texCoordCity.xy) * vec2(currentOffset.w, currentOffset.z) + vec2(currentOffset.x, currentOffset.y);","vec2 mytexCoordCity = fract(texCoordCity.xy) * vec2(currentOffsetWidth, currentOffsetHeight) + vec2(currentOffsetX, currentOffsetY);","#extension GL_EXT_shader_texture_lod : enable","#ifdef GL_EXT_shader_texture_lod ","_texelCity = texture2DGradEXT(mapCity, mytexCoordCity.xy,dFdx(texCoordCity.xy), dFdy(texCoordCity.xy) );","#else","_texelCity = texture2D(mapCity, mytexCoordCity.xy);","#endif","_alphaCity = _texelCity.w;","#ifdef GAMMA_INPUT","_alphaCity *= _texelCity.w;","#endif","","}",s.FS_overridableFunctions.ComputeCommonValues].join("\n"),s.FS_overridableFunctions.ComputeAlbedo=["return colorInstance*_texelCity.xyz;"].join("\n"),s.FS_overridableFunctions.ComputeDiscard=["if (_alphaCity < alphaTestCity || (useMapCity && !mapCityLoaded)) {","return true;","}","return false;"].join("\n"),this._roofMaterial=r.getPDSFXMaterial([s],"physical"),this._roofMaterial.name="building_material_roof_",this._roofMaterial.setPDSFXPolygonOffset("Frontward0"),this._roofMaterial.updateDeferredMaterials()}return this._roofMaterial.clone()},_applyPolygonOffset:function(e,i){t.is(e)&&t.is(i)&&(e.polygonOffset=!0,e.polygonOffsetFactor=i.x,e.polygonOffsetUnits=i.y)},updateTexturingUniforms:function(e){if(this.updateCameraAltitudeUniform(e),e){var i=this.getCompleteMaterialInfo(),r=1;switch(i.texturingMode){case"cameraStop":r=1;break;case"simple":r=0;break;default:r=1}if(e.isPDSFX())t.is(i.repeatUv)&&e.updatePDSFXUniform("repeatUvCity",new n.Vector2(i.repeatUv.x,i.repeatUv.y)),t.is(i.offsetUv)&&e.updatePDSFXUniform("offsetUvCity",new n.Vector2(i.offsetUv.x,i.offsetUv.y)),t.is(r)&&e.updatePDSFXUniform("uvMode",r);else if(t.is(e.uniforms)){if(t.is(i.repeatUv)){e.uniforms.repeatUv.value=new n.Vector2(1*i.repeatUv.x,1*i.repeatUv.y)}t.is(i.offsetUv)&&(e.uniforms.offsetUv.value=i.offsetUv),t.is(r)&&(e.uniforms.uvMode.value=r)}}},updateCameraAltitudeUniform:function(e){if(t.is(e)){var i=this.urban.getViewpoint().getPosition();t.is(i)&&t.is(i.z)&&(e.isPDSFX()?e.updatePDSFXUniform("lastCameraAltitude",i.z):t.is(e.uniforms)&&t.is(e.uniforms.lastCameraAltitude)&&(e.uniforms.lastCameraAltitude.value=i.z))}},_editLineWidth:function(e){e.geometricMode&&"line"===e.geometricMode||(e.lineWidth=void 0)},initMesh:function(e){if(this.isStrokeMesh(e)&&t.is(this._strokeRenderingHandler))return this._strokeRenderingHandler.initMesh(e);t.is(this.atlasId)&&this.currentRendering.set("mapUrl",this.atlasId);var i=null,n=e.name.split("_"),a=n.length;if(!(a<4)){var o,l,h,d,u;for(l=n[0],h=n[1],d=n[2],o=n[3],u=4;u<a;++u)o+="_"+n[u];if(o.contains("roof")){if(t.is(e.material))i=e.material;else{i=this._initRoofMaterial(),s._setMaterialFromProfile(i,this.getDefaultRenderingData());var c=this;this.urban.USR.viewpoint.addEvent("onCameraStopped",function(){c.updateCameraAltitudeUniform(i)})}this.updateTexturingUniforms(i),i=this._getMaterial(i),this._editLineWidth(i)}else t.is(e.material)?i=e.material:(i=this._initWallMaterial(),s._setMaterialFromProfile(i,this.getDefaultRenderingData())),i.updatePDSFXUniform("b_infoTexture",e.textureInfo.texture),i=this._getMaterialNoMap(i),this._editLineWidth(i);return i.updatePDSFXUniform("b_infoTexture",e.textureInfo.texture),i.updatePDSFXUniform("usePolygonExtrusionOptim",this._usePolygonExtrusionOptim),i.name+=l+"_"+h+"_"+d,i.force=!0,t.is(this.atlasId)&&this.addAtlasUniforms(i),r.updateCommonUniforms(i,!1),e.mesh3js.material=i,e.setMaterial(i),e.setShadow(!0,!0),this.updateRenderMode(e),this._lastSeenMaterial=i,!0}},onTextureDownloadStart:function(e,i,r){t.is(e)&&(e.updatePDSFXUniform("useMapCity",!0),e.updatePDSFXUniform("mapCityLoaded",!1))},onTextureApplied:function(e,i,r,s){if(t.is(e)&&t.is(i)){var n=e.image.width,a=e.image.height;i.isPDSFX()?(i.updatePDSFXUniform("useMapCity",!0),i.updatePDSFXUniform("mapCityLoaded",!0),i.updatePDSFXUniform("textureWidth",n),i.updatePDSFXUniform("textureHeight",a)):t.is(i.uniforms)&&t.is(i.uniforms.textureWidth)&&(i.uniforms.textureWidth.value=n,i.uniforms.textureHeight.value=a)}},_initStores:function(){},useDatavizMappingOptim(){return this._parent()&&this._usePolygonExtrusionOptim},_setUsePolygonExtrusionOptim:function(e){!0!==e&&!1!==e||(this._usePolygonExtrusionOptim=e,this._attributesforRebuild=this._attributesforRebuild.filter(e=>"extrusionHeight"!==e),!1===e&&this._attributesforRebuild.push("extrusionHeight"))},setRenderingList:function(e,i,r,s){var n,a,o,h,d=s.textureInfo.texture.image,u=!1;for(a=0;a<e.length;a++){var c=e[a],p=i[a].strid;o=s.textureInfo.idMap[p];var f=c.color,m=(c.extrusionHeight,c.opacity),g=t.is(c.color),v=t.is(c.opacity),_=t.is(c.extrusionHeight);if(o)for(h=0;h<o.length;h++){n=o[h];var y=d.data[4*n*d.width+68];if(g){var b=f.computeColor();d.data[4*n*d.width]=b.r,d.data[4*n*d.width+1]=b.g,d.data[4*n*d.width+2]=b.b,y=t.floatPack(y,0,1),u=!0}if(y=t.floatPack(y,0,g),v&&(d.data[4*n*d.width+3]=m,y=t.floatPack(y,1,1),u=!0),y=t.floatPack(y,1,v),_){var x=l.int2color(c.extrusionHeight),C=l.float2color(c.extrusionHeight);d.data[4*n*d.width+16]=x[0],d.data[4*n*d.width+16+1]=x[1],d.data[4*n*d.width+16+2]=x[2],d.data[4*n*d.width+16+3]=x[3],d.data[4*n*d.width+20]=C[0],d.data[4*n*d.width+20+1]=C[1],d.data[4*n*d.width+20+2]=C[2],d.data[4*n*d.width+20+3]=C[3],y=t.floatPack(y,2,1),u=!0}y=t.floatPack(y,2,_),d.data[4*n*d.width+68]=y}}u&&(s.textureInfo.texture.needsUpdate=!0)}});return h._polyOffseted={attributes:{},vertex_pars:["varying vec2 vUvvuc;"].join("\n"),vertex:["#ifdef USE_MAP","vec4 posOriginCameraSpace = viewMatrix * modelMatrix * vec4(0.0,0.0,position.z,1.0);","posOriginCameraSpace /= posOriginCameraSpace.w;","vec2 uvcentered = uv.xy - vec2(0.5,0.5);","vUvvuc.xy = uvcentered.xy * (10.0/posOriginCameraSpace.z);","#endif"].join("\n"),fragment_pars:["varying vec2 vUvvuc;"].join("\n"),fragment:["#ifdef USE_MAP","       gl_FragColor.rgba = texture2D(map,vUvvuc);","#endif"].join("\n")},h._polyScreenSpace={attributes:{},vertex_pars:["varying vec2 vUvvuc;"].join("\n"),vertex:["vec4 posOriginCameraSpace = vec4(cameraPosition.xyz,1.0);","posOriginCameraSpace /= posOriginCameraSpace.w;","#ifdef USE_MAP","vec2 uvcentered = uv.xy;","vUvvuc.xy = uvcentered.xy;","vec4 orientedUv = projectionMatrix * viewMatrix * modelMatrix* vec4(position.x,position.y,position.z,1.0);","orientedUv /= orientedUv.w;","vUvvuc.xy = orientedUv.xy;","#endif"].join("\n"),fragment_pars:["varying vec2 vUvvuc;"].join("\n"),fragment:["#ifdef USE_MAP","       gl_FragColor.rgba = texture2D(map,gl_FragCoord.xy / 204.8);","#endif"].join("\n")},h._polySimple={attributes:{},uniforms:{repeatUv:{type:"v2",value:new n.Vector2(1,1)},offsetUv:{type:"v2",value:new n.Vector2(0,0)}},vertex_pars:["varying vec2 vUvvuc;","uniform vec2 repeatUv;","uniform vec2 offsetUv;"].join("\n"),vertex:["#ifdef USE_MAP","vec4 worldpos = modelMatrix* vec4(position.xyz,1.0);","vUvvuc.xy = worldpos.xy * (0.0001 *repeatUv) + offsetUv;","#endif"].join("\n"),fragment_pars:["varying vec2 vUvvuc;"].join("\n"),fragment:["#ifdef USE_MAP","       gl_FragColor.rgba = texture2D(map,vUvvuc);","#ifdef ALPHATEST","if ( gl_FragColor.a < ALPHATEST ) discard;","#endif","#endif"].join("\n")},h._polySemiSimple={attributes:{},uniforms:{repeatUv:{type:"v2",value:new n.Vector2(1,1)},offsetUv:{type:"v2",value:new n.Vector2(0,0)},lastCameraAltitude:{type:"f",value:1},textureWidth:{type:"f",value:1}},vertex_pars:["varying vec2 vUvvuc;","uniform vec2 repeatUv;","uniform vec2 offsetUv;","uniform float lastCameraAltitude;","uniform float textureWidth;"].join("\n"),vertex:["#ifdef USE_MAP","vec4 worldPos = modelMatrix * vec4(position.xyz, 1.0);","float altitudeCamera = lastCameraAltitude - worldPos.z;","vec2 uvcentered = (worldPos.xy);","vUvvuc.xy = uvcentered.xy * min(1.0,(1.0/abs(altitudeCamera)));","float textureScaleFactor = 1.3 * 4.0 * 256.0 /max(1.0,textureWidth);","vUvvuc.xy = vUvvuc.xy * repeatUv * textureScaleFactor;","vUvvuc.xy = vUvvuc.xy + offsetUv;","#endif"].join("\n"),fragment_pars:["varying vec2 vUvvuc;"].join("\n"),fragment:["#ifdef USE_MAP","       gl_FragColor.rgba = texture2D(map,vUvvuc);","#ifdef ALPHATEST","if ( gl_FragColor.a < ALPHATEST ) discard;","#endif","#endif"].join("\n")},h}),define("DS/XCityGeometry/PatchVectorFactoryPolygon",["UWA/Class","DS/XCityGeometry/PatchVectorFactoryBuilding","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/XCityTools/Geocoder","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityLayer/Vector","DS/XCityGeometry/Polygon","DS/XCityTools/Debug","DS/XCityRendering/RenderingHandlerPolygon","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s,n,a,o,l,h,d,u,c){"use strict";return t.extend({init:function(e,t){this._parent(e,t),this._node=new s,this._node.name="FactoryPolygon",this._rendering=new u(e,t),this.type=2,this.uvCalc=!0,this._initialHeightOffset=t.heightOffset,delete t.heightOffset,d.log("PatchVectorFactoryPolygon:init")},getTextureIndex:function(){var e=this._currentPrimRendering.mapUrl,t=-1;return c.is(e)&&(t=this._rendering.getIndexForTextureUrl(e)),t},_getPrimInfoFromPreview:function(e){if(c.is(this._node.userData.getContent()._lineSet)&&c.is(this._node.userData.getContent()._lineSet.primInfos)){let t=this._node.userData.getContent()._polygonSet.primInfos[e];return 0===t.posSize.length&&0===t.posSize.width&&t.posSize.center.x,t}}})}),define("DS/XCityGeometry/PatchVectorFactoryTree",["DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PatchVectorFactoryPointGeometry","DS/XCityGeometry/PatchVectorFactoryCrossQuad","DS/XCityGeometry/PatchVectorFactoryElement","DS/Visualization/Node3D","DS/WebappsUtils/WebappsUtils","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityRendering/RenderingHandlerCrossQuad","DS/XCityRendering/RenderingHandlerElement","DS/XCityWorkers/WorkerPool","DS/Mesh/MeshUtils","DS/XCityLayer/Vector","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","UWA/Class","DS/xCityBasicUtils/Utils","DS/XCityRendering/DatavizRendering","DS/XCityTools/Downloader","DS/XCityTools/Pooler"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m,g,v,_,y){"use strict";return t.extend({init:function(t,n,a){this._parent(t,n),this.urban=t,this.stridAttribute=void 0!==n.stridAttribute?n.stridAttribute:"STRID",this.filenameAttribute=void 0!==n.filenameAttribute?n.filenameAttribute:"FILENAME",this.atlasNum=n.atlasNum,this.instancing=!1,this.urban.USR.hwInstancing&&(this.instancing=!0),this._isReady=!1,this._rendering=new h(t,n);var o=_.getDataSupplierUrlFromUrl(a);_.download(o,{responseType:"json"},999999,function(e,t,i,r){r(t,e,i)},void 0,function(e,s,o){var l=this._rendering._content;if(s&&e){var h=!1;if(e.sourceList&&e.sourceList[0].attributeMapping.FILENAME?(this._factory=new r(t,n,a),h=!0):e.analytics&&e.analytics.attributeList&&e.analytics.attributeList.find(e=>"FILENAME"===e.name&&e.count>0)?(this._factory=new r(t,n,a),h=!0):this._factory=new i(t,n,a),this._factory._rendering.updateRendering(this._rendering.currentRendering),this._rendering=this._factory._rendering,h){this._rendering.currentRendering&&this._rendering.currentRendering.renderingData&&this._rendering.currentRendering.renderingData.mapUrl&&delete this._rendering.currentRendering.renderingData.mapUrl;var d=this._rendering.updateRendering.bind(this._rendering);this._rendering.updateRendering=function(e){e&&e.renderingData&&e.renderingData.mapUrl&&delete e.renderingData.mapUrl,d(e)}}}else this._factory=new i(t,n),this._factory._rendering.updateRendering(this._rendering.currentRendering),this._rendering=this._factory._rendering;l&&this._rendering.setContent(l),this._isReady=!0}.bind(this)),this.instancing&&(this.centerVec=new e.Vector3,this.scaleVec=new e.Vector3),this._node=new s,this._node.name="FactoryTree",this._node.hwInstancing=this.urban.USR.hwInstancing,this.forceAltitude=n.forceAltitude,this.identifier=0,this._treeid=0,this.nbInfoPixels=1,this.isPickable=void 0===n.isPickable||n.isPickable,f.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},destroy:function(){this.urban.USR.getScene().remove(this._node)},dispose:function(){p.warn("Dispose: UrbanTree")},isReady:function(){if(this._isReady)return this._factory.isReady?this._factory.isReady():this._isReady},getData:function(e){return this._factory.getData(e)},buildOne:function(e,t,i){this._factory.buildOne(e,t,i)},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1},attributeSetter:{color:"setColor",opacity:"setOpacity"},getDatas:function(e){var t=[];return t[0]={attributes:e.userData,target:e.geom},t},setGeomAttribute:function(e,t,i){var r;for(r=0;r<e.length;r+=1){var s=THREEDS.SubElement.getFromSGNode(e[r].subElement);e[r].mesh[this.attributeSetter[t]](i,[s.sgNode])}}})}),define("DS/XCityModel/PolygonSet",["DS/XCityModel/AbstractSet","DS/XCityModel/Item","DS/XCityLayer/Vector","DS/XCityGeometry/PatchVectorFactoryPolygon","DS/XCityTools/Geocoder","DS/XCityTools/Debug"],function(e,t,i,r,s,n){"use strict";var a=e.extend({defaults:{renderMode:"occluded"},metaData:{type:"Geometry",className:"PolygonSet"},loaderJSON:{geojson:"loadJSONObject"},setup:function(){this._parent(),this._node.name="polygonSetFeature"},_processMultiTypeGeometry:function(e,t,i){let r=!0,n=e.geometryList;for(let e=0;e<n.length&&(r||t!==this.urban.baseProjection);++e){let a=n[e].geometryList;for(let e=0;e<a.length&&(r||t!==this.urban.baseProjection);++e){let n=a[e].vertexList;for(let e=0;e<n.length;++e){let a=n[e];if(t!==this.urban.baseProjection){let e=s.proj(a,t,this.urban.baseProjection);a.x=e.x,a.y=e.y}r&&a.x>i.xmin&&a.x<i.xmax&&a.y>i.ymin&&a.y<i.ymax&&(r=!1,this.nbMultiGeometry++,this.nbMultiGeometrySession++)}}}return r},_processSimpleTypeGeometry:function(e,t,i){let r=!0,n=e.geometryList;for(let e=0;e<n.length&&(r||t!==this.urban.baseProjection);++e){let a=n[e].vertexList;for(let e=0;e<a.length;++e){let n=a[e];if(t!==this.urban.baseProjection){let e=s.proj(n,t,this.urban.baseProjection);n.x=e.x,n.y=e.y}r&&n.x>i.xmin&&n.x<i.xmax&&n.y>i.ymin&&n.y<i.ymax&&(r=!1,this.nbGeometry++,this.nbGeometrySession++)}}return r},_handleOnNextBatchReady:function(e,t){this.webWorkersData.roofCreator.primitiveList=JSON.parse(this.webWorkersData.roofCreator.primitiveList),this.webWorkersData.wallCreator.primitiveList=JSON.parse(this.webWorkersData.wallCreator.primitiveList),this.webWorkersData.textureInfoCreator.data=new Float32Array(this.webWorkersData.textureInfoCreator.data)},geometryRemoved:function(e){if(e.userData&&e.userData.records){for(var t=e.userData.records,i=t.length;i--;){var r=t[i].strid,s=this.miDToTile[r];this.cleanInfo(s,r)}e.userData=void 0}},_prepareDataForWorkers:function(e){let t=[],r=this._inputCRS,a=this,o=this._savedDatasource;o.index=0;let l=new Promise((e,t)=>{s.loadProjection(a.urban.baseProjection,function(i){i?(e(),a.preloadedUrbanProj=Object.assign({},s.projections[a.urban.baseProjection].proj4js),delete a.preloadedUrbanProj.forward,delete a.preloadedUrbanProj.init,delete a.preloadedUrbanProj.inverse):(n.error("Failed loading projection: "+a.urban.baseProjection),t("Failed loading projection: "+a.urban.baseProjection))})});t.push(l);let h=new Promise((e,t)=>{s.loadProjection(r,function(i){i?(e(),a.preloadedInputCRS=Object.assign({},s.projections[r].proj4js),delete a.preloadedInputCRS.forward,delete a.preloadedInputCRS.init,delete a.preloadedInputCRS.inverse):(n.error("Failed loading projection: "+r),t("Failed loading projection: "+r))})});t.push(h);let d=new i.Feature,u=[];return"ground"===this._rendering.currentRendering.renderingData.elevationMode&&void 0!==this._rendering.currentRendering.renderingData.elevationOffset&&(o.list.forEach(e=>{o.getNextFeature(d);let t=d.getGeometry();t.type===i.Type.POLYGON&&e.geometry.coordinates.forEach(e=>{e.forEach(e=>{u.push(a.urban.USR.getGroundHeight(e[0],e[1]))})}),t.type===i.Type.MULTIPOLYGON&&e.geometry.coordinates.forEach(e=>{e.forEach(e=>{e.forEach(e=>{u.push(a.urban.USR.getGroundHeight(e[0],e[1]))})})})}),o.index=0),this.precomputedZValues=u,t},create:function(e){this._urban=e._urban,this._geometrySTRIDName="polygon",this._builderWorker=this._urban.polygonSetWorker,this._parallelBuilderFunName="buildPolygonSet",this._geometryName="polygon",this._multiGeometryName="multipolygon",this._geometryVectorMultiType=i.Type.MULTIPOLYGON,this._geometryVectorType=i.Type.POLYGON,this._maxGeometryPreview="maxPolygonPreview",this._webWorkersDataName="dataFromWebWorkers";const t={stridAttribute:this.get("stridAttribute")};return this._factory=new r(this._urban,t),this._parent(e)}});return t.ObjectContructor.PolygonSet=a}),define("DS/XCityRendering/RenderingHandlerGround",["DS/XCityRendering/RenderingHandlerSpecific","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher"],function(e,t,i,r){"use strict";return e.extend({init:function(e){this._parent(e)},getDefaultRendering:function(){return this.defaultElevationMin=0,this.defaultElevationMax=200,{showOcean:!1,color:new t.Color("rgb(225,225,225)"),oceanAlpha:1,oceanRangeDetection:.0625,oceanColorDetection:new t.Color("rgb(0,64,102)"),oceanTexture:null,oceanTextureUrl:"XCityEnvironment/assets/textures/ocean/waterNormalsn.jpg",anisotropy:4,oceanTextureParams:{minFilter:"linearmipmaplinear",magFilter:"linear",wrapS:"repeat",wrapT:"repeat"},oceanColor:new t.Color("rgb(47,64,71)"),terrainAnalyzer:{mode:"default",elevationMin:this.defaultElevationMin,elevationMax:this.defaultElevationMax,slopeMin:0,slopeMax:1,gradient:{DCOffset:new t.Vector3(.52,.52,.1),Amplitude:new t.Vector3(.48,-.48,-.11),Frequency:new t.Vector3(-.62,.56,.4),Phase:new t.Vector3(.33,.3,.5)}}}},getIds:function(){return["Ground"]},updateRendering:function(e){this.getCompleteMaterialInfo(),this._parent(e);this.updateDefaultGradient();this.getCompleteMaterialInfo();this.launchChangeEvents()},launchChangeEvents:function(e,t){var s=this.currentRendering.getDifferences(this.lastRendering);i.is(s)&&i.is(s.get("terrainAnalyzer"))&&r.publish(r.eventsList["terrain.terrainAnalyzer"])},updateDefaultGradient:function(){var e=this.getCompleteMaterialInfo().terrainAnalyzer;if(i.is(e)){var r=e.mode;if(i.is(r)){var s={DCOffset:new t.Vector3(.66,.56,.68),Amplitude:new t.Vector3(.718,.438,.72),Frequency:new t.Vector3(.52,.8,.52),Phase:new t.Vector3(-.43,-.397,-.083)},n={DCOffset:new t.Vector3(.52,.52,.1),Amplitude:new t.Vector3(.48,-.48,-.11),Frequency:new t.Vector3(-.62,.56,.4),Phase:new t.Vector3(.33,.3,.5)},a={terrainAnalyzer:{}};"slope"===r?(a.terrainAnalyzer.gradient=s,this.defaultRendering.addOver(a)):"elevation"===r&&(a.terrainAnalyzer.gradient=n,this.defaultRendering.addOver(a))}}},applyFeatureRenderingToMaterial:function(e){this._parent(e),this._updateAnalyzerUniforms(e)},isTerrainAnalyzerActivated:function(){var e=this.getCompleteMaterialInfo().terrainAnalyzer;return void 0!==e.mode&&"default"!==e.mode},_updateAnalyzerUniforms:function(e){if(this.isTerrainAnalyzerActivated()&&i.is(e)){var r,s=this.getCompleteMaterialInfo().terrainAnalyzer,n=e.getPDSFXUniform("mode");if(i.is(n)){var a=-1;"slope"===s.mode?(a=2,r=new t.Vector3(a,s.slopeMin,s.slopeMax)):"orientation"===s.mode?(a=.5,r=new t.Vector3(a,0,0)):"elevation"===s.mode&&(a=-1,r=new t.Vector3(a,s.elevationMin,s.elevationMax)),e.updatePDSFXUniform("mode",r)}if("orientation"!==s.mode){var o=e.getPDSFXUniform("DCOffset");i.is(o)&&e.updatePDSFXUniform("DCOffset",s.gradient.DCOffset);var l=e.getPDSFXUniform("Amplitude");i.is(l)&&e.updatePDSFXUniform("Amplitude",s.gradient.Amplitude);var h=e.getPDSFXUniform("Frequency");i.is(h)&&e.updatePDSFXUniform("Frequency",s.gradient.Frequency);var d=e.getPDSFXUniform("Phase");i.is(d)&&e.updatePDSFXUniform("Phase",s.gradient.Phase)}}},updateElevationMin:function(e){var t={terrainAnalyzer:{elevationMin:e}};this.defaultRendering.addOver(t)},updateElevationMax:function(e){var t={terrainAnalyzer:{elevationMax:e}};this.defaultRendering.addOver(t)}})}),define("DS/XCityCore/Terrain",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/XCityCore/Store","DS/XCityTools/Downloader","DS/XCityTools/Disposer","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/EventDispatcher","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityRendering/RenderingHandlerGround","DS/xCityBasicUtils/Utils","DS/XCityTools/Pooler","DS/XCityTools/RenderingTools"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m){"use strict";var g=0,v=new e.Vector2(1,1),_=void 0,y=-50,b=0,x=!1,C=8,S=!1,D=!0,P=!1,w=!1,M=!1,T=!1,I=!0,R={},A=1,F=.1,L=new e.Color("rgb(0,0,255)"),V=new e.Color("rgb(0,0,255)"),O=void 0,N=1,U=void 0,E={name:"terrain_DebugLevelsColor_PDSFX",uniforms:{levelColor:{type:"c",value:new e.Color}},FS_overridableFunctions:{ProcessFinalColor:["ioFinalColor.rgb *= levelColor.rgb;"].join("\n")}},k={name:"terrain_DebugTileInfos_PDSFX",uniforms:{tileTexture:{type:"t2",value:void 0}},varyings:{uvTile:{type:"v2",length:1}},VS_overridableFunctions:{ComputeVaryingValues:["uvTile = vGetAttribTexCoord0().xy;"].join("\n")},FS_overridableFunctions:{ProcessFinalColor:["vec3 invertColor = vec3(1.0) - ioFinalColor.rgb;","vec3 tileInfo = texture2D(tileTexture, uvTile.xy).rgb;","ioFinalColor.rgb = ioFinalColor.rgb*(vec3(1.0)-tileInfo) + invertColor*tileInfo;"].join("\n")}},z={name:"terrain_DebugWireframe_PDSFX",uniforms:{},varyings:{wireColor:{type:"v3",length:1}},VS_overridableFunctions:{ComputeVaryingValues:["wireColor = vGetAttribNormal();"].join("\n")},FS_global_code:["float _edgeFactor(vec3 _color){","vec3 d = fwidth(_color);","vec3 a3 = smoothstep(vec3(0.0), d*1.5, _color);","return min(min(a3.x, a3.y), a3.z);","}"].join("\n"),FS_overridableFunctions:{ProcessFinalColor:["ioFinalColor.rgb *= mix(vec3(0.0),vec3(1.0),_edgeFactor(wireColor.rgb));"].join("\n")}},B={name:"terrain_Crop_PDSFX",uniforms:{dtmCrop:{type:"v4",value:new e.Vector4(-1,-1,1,1)},worldMat:{type:"m4",value:new e.Matrix4}},VS_global_code:["vec3 ComputeObjectPosition_Cropped() {","vec3 position = vGetAttribPosition();","position.x = clamp(position.x, dtmCrop.x, dtmCrop.z);","position.y = clamp(position.y, dtmCrop.y, dtmCrop.w);","return position;","}","vec4 ComputeObjectTexCoord0_Cropped() {","vec4 croppedUV = vGetAttribTexCoord0();","croppedUV.x = clamp(croppedUV.x, dtmCrop.x + 0.5, dtmCrop.z + 0.5);","croppedUV.y = clamp(croppedUV.y, dtmCrop.y + 0.5, dtmCrop.w + 0.5);","return croppedUV;","}","float _altitudeAnalyzer = 0.0;"].join("\n"),FS_global_code:["#define TERRAIN_SHADER","bool computeWaves = false;"].join("\n"),_FS_overridableFunctions:{ComputeAlbedo:["return vec3(1.0,0.2,0.2);"].join("\n")}},j={name:"terrain_Flat_PDSFX",depends:[B],uniforms:{dtmAltitudes:{type:"v4",value:new e.Vector4(0,0,0,0)},dtmOffset:{type:"v4",value:new e.Vector4(0,0,1,1)}},VS_overridableFunctions:{ComputeObjectPosition:["vec3 position = ComputeObjectPosition_Cropped();","position.z = dtmAltitudes.x;","return position;"].join("\n"),ComputeObjectNormal:["vec3 terrainNormal = vec3(0.0,0.0,1.0);","return terrainNormal;"].join("\n"),ProcessViewTangentSpace:["ioWorldViewTS.Normal = normalize(vGetViewMatrix() * vec4(0.0,0.0,1.0,0.0)).xyz;"].join("\n")},FS_overridableFunctions:{_ComputeSpecularReflectance:["vec3 specularRef = vec3(0.0,0.0,0.0);","return specularRef;"].join("\n"),_ProcessFinalColor:["ioFinalColor = vec4(vGetViewNormal(), 1.0);"].join("\n")}},X={name:"terrain_Raster_PDSFX",depends:[B],nbTexture:1,uniforms:{dtm:{type:"t2",value:void 0},dtmOffset:{type:"v4",value:new e.Vector4(0,0,1,1)},dtmAltitudes:{type:"v4",value:new e.Vector4(0,0,0,0)},dtmProperties:{type:"v4",value:new e.Vector4(0,0,0,0)},terrainDebug:{type:"v4",value:new e.Vector4(0,0,0,0)}},VS_global_code:["vec3 _terrainPosition;","vec3 _terrainNormal;","vec3 _computeNormal(vec2 uv) {","float w = texture2D(dtm, uv + vec2(-dtmProperties.x, 0.0)).r;","float e = texture2D(dtm, uv + vec2( dtmProperties.x, 0.0)).r;","float s = texture2D(dtm, uv + vec2(0.0, -dtmProperties.y)).r;","float n = texture2D(dtm, uv + vec2(0.0,  dtmProperties.y)).r;","mat3 modelMatrix = vGet3x3WorldMatrix();","vec3 va = normalize(vec3(modelMatrix[0][0]*2.0*dtmProperties.x/dtmOffset.z, 0.0, e-w));","vec3 vb = normalize(vec3(0.0, modelMatrix[1][1]*2.0*dtmProperties.y/dtmOffset.z, n-s));","return normalize(cross(va,vb));","}"].join("\n"),VS_overridableFunctions:{ComputeCommonValues:["_terrainPosition = ComputeObjectPosition_Cropped();","float _altitude = dtmAltitudes.x;","_altitudeAnalyzer = dtmAltitudes.x;","vec2 croppedUV = ComputeObjectTexCoord0_Cropped().xy;","vec2 _uvsdtm = (croppedUV * dtmOffset.z + dtmOffset.xy) * (vec2(1.0) - 2.0 * dtmProperties.zw) + dtmProperties.zw;","if (dtmAltitudes.z > 0.0 || _terrainPosition.z > -999.0 ) {","if (terrainDebug.z > 0.5 && terrainDebug.z < 1.5) {","_altitude = dtmAltitudes.x;","_altitudeAnalyzer = _altitude;","_terrainNormal = vec3(0.0, 0.0, 1.0);","}","else {","_terrainNormal = _computeNormal(_uvsdtm);","_altitude = texture2D(dtm, _uvsdtm).r;","_altitudeAnalyzer = _altitude;","}","} else {","_altitudeAnalyzer = texture2D(dtm, _uvsdtm).r;","_altitude = dtmAltitudes.y;","_terrainNormal = vec3(0.0, 0.0, 1.0);","}","_terrainPosition.z = (_altitude - dtmAltitudes.w)/dtmOffset.w;"].join("\n"),ComputeObjectPosition:["return _terrainPosition;"].join("\n"),ComputeObjectNormal:["return _terrainNormal;"].join("\n"),ProcessViewTangentSpace:["ioWorldViewTS.Normal = normalize(vGetViewMatrix() * vec4(_terrainNormal,0.0)).xyz;"].join("\n")},FS_overridableFunctions:{_ProcessFinalColor:["ioFinalColor = vec4(vGetViewNormal(), 1.0);"].join("\n")}},G={name:"terrain_noOverlayRaster_PDSFX",nbTexture:0,FS_overridableFunctions:{_ComputeRoughness:["return 1.0;"].join("\n"),_ComputeAlbedo:["return vec3(0.9);"].join("\n")}},W={0:{name:"terrain_OverlayRaster_PDSFX",nbTexture:0,uniforms:{raster:{type:"t2v",value:[],length:0},rasterOffset:{type:"v4v",value:[],length:0},previewCoefs:{type:"v4v",value:[],length:0},previewRotation:{type:"v4v",value:[],length:0},isVisible:{type:"f",value:1}},varyings:{uvsraster:{type:"v2v",length:0}},VS_overridableFunctions:{ComputeVaryingValues:["for(int i = 0; i < __NBRASTER__; i++) {","uvsraster[i] = ComputeObjectTexCoord0_Cropped().xy * rasterOffset[i].z + rasterOffset[i].xy;","}"].join("\n")},FS_global_code:["#define MULTIPLE_RASTER_TERRAIN __NBRASTER__"].join("\n"),FS_overridableFunctions:{ComputeAlbedo:["if (computeWaves == false) {","vec3 _rasterMixedColor = vec3(225.0/255.0);","if (uvsraster[0] != vec2(-1.0)) {","vec4 _raster;","float _rasterAlpha = 0.0;","for(int i = 0; i < __NBRASTER__; i++) {","if (previewCoefs[i] != vec4(-1.0)) {","vec2 uvs = uvsraster[i];","float angleRad = previewRotation[i].x * 3.14 / 180.0;","float xM = uvs.x - (previewCoefs[i].x + previewCoefs[i].z) / 2.0;","float yM = uvs.y - (previewCoefs[i].y + previewCoefs[i].w) / 2.0;","uvs.x = xM * cos(angleRad) + yM * sin(angleRad) + (previewCoefs[i].x + (previewCoefs[i].z - previewCoefs[i].x)/2.0);","uvs.y = -xM * sin(angleRad) + yM * cos(angleRad) + (previewCoefs[i].y + (previewCoefs[i].w - previewCoefs[i].y)/2.0);","if (uvs.x < previewCoefs[i].x) {","uvs.x = -1.0;","}","else if (uvs.x > previewCoefs[i].z) {","uvs.x = -1.0;","}","if (uvs.y < previewCoefs[i].y) {","uvs.y = -1.0;","}","else if (uvs.y > previewCoefs[i].w) {","uvs.y = -1.0;","}","if (uvs.x != -1.0 && uvs.y != -1.0) {","uvs.x -= previewCoefs[i].x;","uvs.x /= (previewCoefs[i].z - previewCoefs[i].x);","uvs.y -= previewCoefs[i].y;","uvs.y /= (previewCoefs[i].w - previewCoefs[i].y);","_raster = texture2D(raster[i], uvs);","_rasterAlpha = _raster.a;","}","}","else {","_raster = texture2D(raster[i], uvsraster[i]);","_rasterAlpha = _raster.a;","}","float coefDark = 225.0/255.0;","float darkness = (1.0 - _rasterAlpha) * coefDark + (_rasterAlpha * 1.0);","_raster.xyz = _raster.xyz * vec3(darkness);","_rasterMixedColor = _raster.rgb * _raster.a * rasterOffset[i].w + _rasterMixedColor * (1.0 - _raster.a * rasterOffset[i].w);","}","}","#ifdef GAMMA_INPUT","//_rasterMixedColor *= _rasterMixedColor;","#endif","return _rasterMixedColor;","}"].join("\n"),_ComputeRoughness:["return 1.0;"].join("\n")}},1:{name:"terrain_OverlayRaster_PDSFX",nbTexture:1,uniforms:{raster:{type:"t2",value:void 0},rasterOffset:{type:"v4",value:new e.Vector4(0,0,1,1)},previewCoefs:{type:"v4",value:new e.Vector4(-1,-1,-1,-1)},previewRotation:{type:"v4",value:new e.Vector4(0,0,0,0)},isVisible:{type:"f",value:1}},varyings:{uvsraster:{type:"v2",length:1}},VS_overridableFunctions:{ComputeVaryingValues:["uvsraster = ComputeObjectTexCoord0_Cropped().xy * rasterOffset.z + rasterOffset.xy;"].join("\n")},FS_overridableFunctions:{_ComputeRoughness:["return 1.0;"].join("\n"),ComputeAlbedo:["if (computeWaves == false) {","vec3 _rasterMixedColor = vec3(225.0/255.0);","float _rasterAlpha = 0.0;","vec4 _raster = vec4(1.0);","if (uvsraster != vec2(-1.0)) {","if (previewCoefs != vec4(-1.0)) {","vec2 uvs = uvsraster;","float angleRad = previewRotation.x * 3.14 / 180.0;","float xM = uvs.x - previewCoefs.x;","float yM = uvs.y - previewCoefs.y;","uvs.x = xM * cos(angleRad) + yM * sin(angleRad) + previewCoefs.x;","uvs.y = -xM * sin(angleRad) + yM * cos(angleRad) + previewCoefs.y;","if (uvs.x < previewCoefs.x) {","uvs.x = -1.0;","}","else if (uvs.x > previewCoefs.z) {","uvs.x = -1.0;","}","if (uvs.y < previewCoefs.y) {","uvs.y = -1.0;","}","else if (uvs.y > previewCoefs.w) {","uvs.y = -1.0;","}","_rasterAlpha = 0.0;","if (uvs.x != -1.0 && uvs.y != -1.0) {","uvs.x -= previewCoefs.x;","uvs.x /= (previewCoefs.z - previewCoefs.x);","uvs.y -= previewCoefs.y;","uvs.y /= (previewCoefs.w - previewCoefs.y);","_raster = texture2D(raster, uvs);","_rasterAlpha = _raster.a;","}","}","else {","_raster = texture2D(raster, uvsraster);","_rasterAlpha = _raster.a;","}","}","#ifdef GAMMA_INPUT","//_rasterMixedColor.rgb *= _rasterMixedColor.rgb;","#endif","float coefDark = 225.0/255.0;","float darkness = (1.0 - _rasterAlpha) * coefDark + (_rasterAlpha * 1.0);","_raster.rgb = _raster.rgb * vec3(darkness);","_rasterMixedColor = _raster.rgb * _raster.a * rasterOffset.w + _rasterMixedColor * (1.0 - _raster.a * rasterOffset.w);","return _rasterMixedColor;","}"].join("\n")}}},H={0:{name:"terrain_OverlayRaster_PDSFX",nbTexture:0,uniforms:{raster:{type:"t2v",value:[],length:0},rasterOffset:{type:"v4v",value:[],length:0},isVisible:{type:"f",value:1}},varyings:{uvsraster:{type:"v2v",length:0}},VS_overridableFunctions:{ComputeVaryingValues:["for(int i = 0; i < __NBRASTER__; i++) {","uvsraster[i] = ComputeObjectTexCoord0_Cropped().xy * rasterOffset[i].z + rasterOffset[i].xy;","}"].join("\n")},FS_global_code:["#define MULTIPLE_RASTER_TERRAIN __NBRASTER__","vec4 _texelCity = vec4(1.0);","#endif"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["if (computeWaves == false) {","if (uvsraster[0] != vec2(-1.0)) {","vec4 _raster;","for(int i = 0; i < __NBRASTER__; i++) {","vec4 _raster = texture2D(raster[i], uvsraster[i]);","_texelCity.xyz = _raster.rgb * _raster.a * rasterOffset[i].w + _texelCity.xyz * (1.0 - _raster.a * rasterOffset[i].w);","}","}","}",""].join("\n"),_ComputeDiffuseTexel:["return vec4(_texelCity.xyz, 1.0);"].join("\n"),ComputeAlbedo:["cAlbedo = vec3(0.5);"].join("\n"),ComputeSpecularReflectance:["return vec3(0.0,0.0,0.0);"].join("\n")}},1:{name:"terrain_OverlayRaster_PDSFX",nbTexture:1,uniforms:{mapCity:{type:"t2",value:void 0},raster:{type:"t2",value:void 0},rasterOffset:{type:"v4",value:new e.Vector4(0,0,1,1)},isVisible:{type:"f",value:1}},varyings:{uvsraster:{type:"v2",length:1}},VS_overridableFunctions:{ComputeVaryingValues:["uvsraster = ComputeObjectTexCoord0_Cropped().xy * rasterOffset.z + rasterOffset.xy;"].join("\n")},FS_global_code:["vec4 _texelCity = vec4(1.0);","#endif"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["if (!computeWaves) {","if (uvsraster != vec2(-1.0)) {","vec4 _raster = texture2D(raster, uvsraster);","_texelCity.xyz = _raster.rgb * _raster.a * rasterOffset.w + _texelCity.xyz * (1.0 - _raster.a * rasterOffset.w);","}","}",""].join("\n"),_ComputeDiffuseTexel:["return vec4(_texelCity.xyz, 1.0);"].join("\n"),ComputeAlbedo:["cAlbedo = vec3(0.5);"].join("\n"),ComputeSpecularReflectance:["return vec3(0.0,0.0,0.0);"].join("\n")}}},J={name:"terrain_Analyzer_PDSFX",uniforms:{mode:{type:"v3",value:new e.Vector3(0,0,1)},DCOffset:{type:"v3",value:new e.Vector3(0,0,0)},Amplitude:{type:"v3",value:new e.Vector3(0,0,0)},Frequency:{type:"v3",value:new e.Vector3(0,0,0)},Phase:{type:"v3",value:new e.Vector3(0,0,0)}},varyings:{alti:{type:"f",length:1},terrain_normal:{type:"v3",length:1}},VS_overridableFunctions:{ComputeVaryingValues:["alti = _altitudeAnalyzer; //ComputeObjectPosition().z;","terrain_normal = ComputeObjectNormal();"].join("\n")},FS_global_code:["vec3 palette(float vtoc){","return DCOffset + Amplitude * cos( 6.28318 * (Frequency * vtoc + Phase) );","}"].join("\n"),FS_overridableFunctions:{ProcessFinalColor:["if (mode.x < 0.0) {","float altToUse = clamp(alti,mode.y,mode.z);","float colorAlt = (altToUse - mode.y) / (mode.z -mode.y); //max(min( log(max(1.0+alti,1.0))/4.0-1.0, 1.0),0.0);","ioFinalColor.rgb *= palette(colorAlt);","} else if (mode.x > 1.0) { ","ioFinalColor.rgb *= palette(1.0-((terrain_normal.z - mode.y) / (mode.z -mode.y)));","} else {","ioFinalColor.rgb *= abs(terrain_normal.xyz);","}"].join("\n")}},q={},Y=function(e,t){var i=e.get("res")-2*e.get("border"),r=e.get("res")-2*e.get("border");if(t.LOD>e.get("levelMax")){var s=1<<t.LOD-e.get("levelMax");i=Math.max(1,i/s),r=Math.max(1,r/s)}return function(e,t,i){if(void 0!==q[[e,t,i]])return q[[e,t,i]].use();var r=new d({indexed:!0,useNormal:!0,normalBinding:d.Binding.VERTEX,useTexCoord:!0,nbTexCoord:1,texCoordBinding:d.Binding.VERTEX});r.startPrimitive();for(var s=0,n=0,a=0;a<e;a++)for(var o=0;o<t;o++)r.pushVertex([a/e-.5,o/t-.5,0]),r.pushVertex([(a+1)/e-.5,o/t-.5,0]),r.pushVertex([(a+1)/e-.5,(o+1)/t-.5,0]),r.pushVertex([a/e-.5,(o+1)/t-.5,0]),r.pushTexCoord(0,[a/e,o/t]),r.pushTexCoord(0,[(a+1)/e,o/t]),r.pushTexCoord(0,[(a+1)/e,(o+1)/t]),r.pushTexCoord(0,[a/e,(o+1)/t]),r.pushNormal([0,1,0]),r.pushNormal([0,0,1]),r.pushNormal([0,1,2]),r.pushNormal([1,0,3]),r.pushVertexIndices([s,s+1,s+3]),r.pushVertexIndices([s+1,s+2,s+3]),s+=4,i&&(n=s,0===o&&(r.pushVertex([a/e-.5,o/t-.5,-999.9]),r.pushVertex([(a+1)/e-.5,o/t-.5,-999.9]),r.pushTexCoord(0,[a/e,o/t]),r.pushTexCoord(0,[(a+1)/e,o/t]),r.pushNormal([1,0,0]),r.pushNormal([0,1,0]),r.pushVertexIndices([n-4,s,n-3]),r.pushVertexIndices([s,s+1,n-3]),s+=2),o===e-1&&(r.pushVertex([a/e-.5,(o+1)/t-.5,-999.9]),r.pushVertex([(a+1)/e-.5,(o+1)/t-.5,-999.9]),r.pushTexCoord(0,[a/e,(o+1)/t]),r.pushTexCoord(0,[(a+1)/e,(o+1)/t]),r.pushNormal([0,1,0]),r.pushNormal([0,0,1]),r.pushVertexIndices([n-1,n-2,s+1]),r.pushVertexIndices([n-1,s+1,s]),s+=2),0===a&&(r.pushVertex([a/e-.5,o/t-.5,-999.9]),r.pushVertex([a/e-.5,(o+1)/t-.5,-999.9]),r.pushTexCoord(0,[a/e,o/t]),r.pushTexCoord(0,[a/e,(o+1)/t]),r.pushNormal([0,0,1]),r.pushNormal([0,1,0]),r.pushVertexIndices([s,n-4,n-1]),r.pushVertexIndices([s,n-1,s+1]),s+=2),a===t-1&&(r.pushVertex([(a+1)/e-.5,o/t-.5,-999.9]),r.pushVertex([(a+1)/e-.5,(o+1)/t-.5,-999.9]),r.pushTexCoord(0,[(a+1)/e,o/t]),r.pushTexCoord(0,[(a+1)/e,(o+1)/t]),r.pushNormal([0,1,0]),r.pushNormal([1,0,0]),r.pushVertexIndices([n-3,s,s+1]),r.pushVertexIndices([n-3,s+1,n-2]),s+=2));r.endPrimitive("terrainGenericMesh");var l=r.compilePrimitive("terrainGenericMesh",!0),h=u.createMeshNode(l),c=new f(h.clone.bind(h));return q[[e,t,i]]=c,c.use()}(Math.max(1,i),Math.max(1,r),!e.noSkirts)},K=new e.Vector3,Q=new e.Quaternion,Z=new e.Vector3,$=function(t,i){if(this.children&&this.children[0]){var r,s=0;this.traverse(function(e){e.mesh3js&&e.mesh3js.matrix&&(r=e.mesh3js.matrix.elements[12],s=e.mesh3js.matrix.elements[13])});var n=new e.Vector3;n.getPositionFromMatrix(this.children[0].getMatrix());var a=new e.Vector3;a.getPositionFromMatrix(this.getMatrix());var o=debugWebGLV6Viewer.castRay(new e.Ray(new e.Vector3(r-a.x+t-n.x,s-a.y+i-n.y,1e3),new e.Vector3(0,0,-1)),this,"prim");return o&&o.length>0?o[0].point.z:this.bSphere.center.z}return 0},ee=function(){this._sourceList={default:{noSkirts:!0,acceptTile:function(){return{valid:!0,complete:!0}},getTile:function(){return{}},downloadTile:function(){return!0},applyDTM:function(){return!0},cancelTile:function(){return!0},updateTile:function(){return!0},isHD:function(){return!1},isGeometric:function(){return!1},getDataModelOrder:function(){return[]},getRendering:function(){},get:function(e){return"url"===e?"":"res"===e?1:"border"===e?0:"levelMin"===e?0:"levelMax"===e?0:"levelMaxVisu"===e?9999:"priority"===e?5:void 0}}},this._activeTerrain={0:["default"]},this._activeLandcover={},this._activeRaster={},this._chunksList=[],this._poolMaterial=[],r.createStore("terrain",{dataBuilder:this.buildTerrainTile.bind(this),dataDownloader:this.downloadTerrainTile.bind(this),dataDLCanceler:this.cancelDownloadTerrainTile.bind(this),dataCleaner:this.cleanTerrainTile.bind(this),dataUpdater:this.updateTerrainTile.bind(this),dlOptions:{},cacheSize:0})};ee.prototype={initialize:function(e){void 0!==e&&e.webglViewer&&(C=e.webglViewer.getWebGLContext().getParameter(e.webglViewer.getWebGLContext().MAX_TEXTURE_IMAGE_UNITS),S=void 0!==e.webglViewer.getRenderer().supportsStandardDerivatives(),D=e.webglViewer.getWebGLContext().getParameter(e.webglViewer.getWebGLContext().MAX_VERTEX_UNIFORM_VECTORS)>128&&e.webglViewer.getWebGLContext().getParameter(e.webglViewer.getWebGLContext().MAX_FRAGMENT_UNIFORM_VECTORS)>128),this.setup(e),this.setupDebug(e),this.setupOcean(e),this.setupSky(e),this.renderingProfileManager=e.renderingProfileManager,this._renderingId="Ground"},reset:function(){v.set(1,1),g=0,_=void 0,y=-100,1e4,b=0,x=!1,P=!1,w=!1,M=!1,T=!1,I=!1,A=1,F=.1,L.set("rgb(0,0,255)"),V.set("rgb(0,0,255)"),O=void 0,N=1,U=void 0,r.deprecateAll("terrain")},setup:function(t){if(void 0!==t){var i=!1;t.slabAltitude&&t.slabAltitude!==g&&(g=t.slabAltitude,y=g-25,g+100,i=!0),t.worldSize&&(t.worldSize instanceof e.Vector2?v.equals(t.worldSize)||(v.copy(t.worldSize),_=void 0,i=!0):v.x===t.worldSize&&v.y===t.worldSize||(v.x=t.worldSize,v.y=t.worldSize,_=void 0,i=!0)),t.cropBox&&t.cropBox!==_&&(_=t.cropBox,i=!0),i&&r.deprecateAll("terrain")}},setupAnalyzer:function(e){return void 0===e||void 0===e.terrainAnalyzer||e.terrainAnalyzer.mode===R.mode||(R=e.terrainAnalyzer,r.deprecateAll("terrain"),!1)},setupOcean:function(t){if(void 0!==t){var i=!1,s=!1;return void 0!==t.oceanAlpha&&A!==t.oceanAlpha&&(A=t.oceanAlpha),void 0!==t.oceanRangeDetection&&F!==t.oceanRangeDetection&&(F=t.oceanRangeDetection),void 0!==t.oceanColorDetection&&L.copy(t.oceanColorDetection),void 0!==t.oceanColor&&V.copy(t.oceanColor),O!==t.oceanTexture&&(O=t.oceanTexture,o.is(O)&&(O.minFilter=e.LinearMipMapLinearFilter,O.magFilter=e.LinearFilter,O.wrapS=O.wrapT=e.RepeatWrapping)),void 0!==t.reflectionCoef&&N!==t.reflectionCoef&&(N=t.reflectionCoef),void 0!==t.showOcean&&I!==t.showOcean&&(I=t.showOcean,s=!0,i=!0),!i||(r.deprecateAll("terrain"),s&&h.publish(h.eventsList.realisticWater,I),!1)}},_enableOcean:function(e){void 0!==e&&I!==e&&(I=e,r.deprecateAll("terrain"),h.publish(h.eventsList.realisticWater,e))},_isOceanEnabled:function(){return I},setupSky:function(e){if(void 0!==e){var t=!1;U!==e.skyCubeMap&&(t=!0,void 0!==(U=e.skyCubeMap)&&(U.shared=0)),t&&r.deprecateAll("terrain")}},setupDebug:function(e){if(void 0!==e){var t=!1;void 0!==e.showtiles&&P!==e.showtiles&&(P=e.showtiles,t=!0),void 0!==e.wireframe&&T!==e.wireframe&&(T=e.wireframe,t=!0),void 0!==e.coloredlevels&&w!==e.coloredlevels&&(w=e.coloredlevels,t=!0),void 0!==e.tileInfos&&M!==e.tileInfos&&(M=e.tileInfos,t=!0),t&&r.deprecateAll("terrain")}},setupUndergroundMode:function(e){if(void 0!==e){x=e;r.traverse("terrain",function(e){if(o.is(e.material)){var t=e.material.getPDSFXUniform("dtmAltitudes");o.is(t)&&t.value.setZ(x?1:0)}})}},_findTerrainSource:function(e){for(var t,i,r,s,n,a,o,l=e.LOD,h={id:"default",complete:!0};l+1;){if(s=this._activeTerrain[l])for(t=0,i=s.length;t<i;++t){if(r=s[i-t-1],(a=this._sourceList[r].acceptTile(e)).valid&&"default"!==r&&(!0===a.complete||void 0===a.complete))this.getLowerDataModelSource(h.id,r)===r&&(!0===a.complete?h={id:r,complete:a.complete}:void 0===a.complete&&(o={id:r}));a.valid&&!1===a.complete&&(n=void 0===n?r:this.getLowerDataModelSource(n,r))}l--}return"default"===h.id&&n?{display:n,download:void 0!==o?o.id:n}:{display:"default"===h.id&&void 0!==o?o.id:h.id,download:void 0!==o?o.id:h.id}},_findLandcoverSource:function(e){var t,i,r,s,n,a,o=e.LOD;if(I)for(;o+1;){if(s=this._activeLandcover[o])for(t=0,i=s.length;t<i;++t)r=s[i-t-1],(a=this._sourceList[r])&&a.acceptTile(e)&&(n=void 0===n?r:this.getLowerDataModelSource(n,r));o--}return n},_findSortedRasterSources:function(e){for(var t,i,r,s,n,a,o,l,h,d,u=e.LOD,c=[];u+1;){if(a=this._activeRaster[u])for(t=0,i=a.length;t<i;++t)if(n=a[i-t-1],this._sourceList[n].acceptTile(e))if(0===c.length)c.push(n);else{for(h=0,d=!1,l=this._sourceList[n].getDataModelOrder();!d&&h<c.length;){for(o=this._sourceList[c[h]].getDataModelOrder(),r=Math.min(o.length,l.length),s=0;s<r;++s)if(l[s]>o[s]){c.splice(h,0,n),d=!0;break}h++}d||c.push(n)}u--}return c},_updateOceanUniforms:function(e){if(I&&o.is(e)){var t=e.getPDSFXUniform("oceanColor");o.is(t)&&(e.updatePDSFXUniform("oceanAlpha",A),e.updatePDSFXUniform("oceanRangeDetection",F),e.updatePDSFXUniform("oceanColorDetection",L),e.updatePDSFXUniform("oceanColor",V));var i=e.getPDSFXUniform("oceanTexture");if(o.is(i)){var r=i.value;o.is(r)&&e.updatePDSFXUniform("oceanTexture",void 0)}e.updatePDSFXUniform("oceanTexture",O)}},_updateDebugUniforms:function(t,i){if(w&&void 0!==t){var r=t.getPDSFXUniform("levelColor");o.is(r)&&(r.value.set(o.toColor(i.LOD/b)),t.updatePDSFXUniform("levelColor",r.value))}if(M&&void 0!==t){var s=t.getPDSFXUniform("tileTexture");if(o.is(s)){var n=document.createElement("canvas");n.width=256,n.height=256;var a=n.getContext("2d");a.font="24pt Arial",a.textAlign="center",a.fillStyle="black",a.fillRect(0,0,256,256),a.fillStyle="white";var l=i.J;!1,a.fillText(i.LOD+"/"+i.I+"/"+l,n.width/2,n.height/2);var h=new e.Texture(n);h.needsUpdate=!0,t.updatePDSFXUniform("tileTexture",h)}}},_updateAltitudeUniforms:function(e){var t=e.getPDSFXUniform("dtmAltitudes");o.is(t)&&(t.value.set(g,y,x?1:0,t.value.w),e.updatePDSFXUniform("dtmAltitudes",t.value))},_updateCropUniforms:function(e,t){if(void 0!==e){var i=e.getPDSFXUniform("dtmCrop");if(o.is(i))if(void 0!==_&&t.intersectCropBox){var r=v.x/(1<<t.LOD),s=v.y/(1<<t.LOD),n=(t.I+.5)*r,a=(t.J+.5)*s;i.value.set((_.getShiftedCenter().x-_.getSize().x/2-n)/r,(_.getShiftedCenter().y-_.getSize().y/2-a)/s,(_.getShiftedCenter().x+_.getSize().x/2-n)/r,(_.getShiftedCenter().y+_.getSize().y/2-a)/s),e.updatePDSFXUniform("dtmCrop",i.value)}else i.value.set(-1,-1,1,1),e.updatePDSFXUniform("dtmCrop",i.value)}},_updateAnalyzerUniforms:function(t){if(this.isTerrainAnalyzerActivated()&&o.is(t)){var i,r=t.getPDSFXUniform("mode");if(o.is(r)){var s=-1;"slope"===R.mode?(s=2,i=new e.Vector3(s,R.slopeMin,R.slopeMax)):"orientation"===R.mode?(s=.5,i=new e.Vector3(s,0,0)):"elevation"===R.mode&&(s=-1,i=new e.Vector3(s,R.elevationMin,R.elevationMax)),t.updatePDSFXUniform("mode",i)}if("orientation"!==R.mode){var n=t.getPDSFXUniform("DCOffset");o.is(n)&&t.updatePDSFXUniform("DCOffset",R.gradient.DCOffset);var a=t.getPDSFXUniform("Amplitude");o.is(a)&&t.updatePDSFXUniform("Amplitude",R.gradient.Amplitude);var l=t.getPDSFXUniform("Frequency");o.is(l)&&t.updatePDSFXUniform("Frequency",R.gradient.Frequency);var h=t.getPDSFXUniform("Phase");o.is(h)&&t.updatePDSFXUniform("Phase",R.gradient.Phase)}}},_updateSkyUniforms:function(e){var t=e.envMap;if(o.is(U)&&U!==t){var i=t;o.is(i)&&(i.shared--,e.envMap=null),U.shared++,e.envMap=U}},_getTerrainMaterial:function(t,i,r,s){var n=0;t.isGeometric()||(n=""!==t.get("url")?2:1);var a=0;void 0!==i&&I&&(a=void 0!==O?2:1);var h=0;w&&(h=1);var d=0;M&&(d=1);var u=0;T&&S&&(t.isGeometric()||(u=1));var c=0;this.isTerrainAnalyzerActivated()&&(c=1);var p="DTM"+n+"_nbRasters"+r+"_landcover"+a+"_landcoverRasterVisible"+s+"_terrainLevels"+h+"_terrainTileInfos"+d+"_terrainWireframe"+u+"_terrainAnalyzer"+c;if(void 0===this._chunksList[p]){var m=[];if(n>0&&(2===n?m.push(X):m.push(j)),a>0&&(s?m.push(l.chunkLandcover_visibleSource_PDSFX):m.push(l.chunkLandcover_unvisibleSource_PDSFX),m.push(l.chunkOcean_PDSFX)),r>0)if(D){if(void 0===W[r]){(g=o.clone(W[0])).uniforms.raster.length=r,g.uniforms.rasterOffset.length=r,g.uniforms.previewCoefs.length=r,g.uniforms.previewRotation.length=r;for(v=0;v<r;++v)g.uniforms.raster.value.push(void 0),g.uniforms.rasterOffset.value.push(void 0),g.uniforms.previewCoefs.value.push(void 0),g.uniforms.previewRotation.value.push(void 0);g.uniforms.isVisible.value=1,g.VS_overridableFunctions.ComputeVaryingValues=g.VS_overridableFunctions.ComputeVaryingValues.replace(/__NBRASTER__/g,r.toString()),g.FS_global_code=g.FS_global_code.replace(/__NBRASTER__/g,r.toString()),g.FS_overridableFunctions.ComputeAlbedo=g.FS_overridableFunctions.ComputeAlbedo.replace(/__NBRASTER__/g,r.toString()),g.nbTexture=r,g.varyings.uvsraster.length=r,W[r]=g}m.push(W[r])}else{if(void 0===H[r]){var g;(g=o.clone(H[0])).uniforms.raster.length=r,g.uniforms.rasterOffset.length=r,g.uniforms.previewCoefs.length=r,g.uniforms.previewRotation.length=r;for(var v=0;v<r;++v)g.uniforms.raster.value.push(void 0),g.uniforms.rasterOffset.value.push(void 0),g.uniforms.previewCoefs.value.push(void 0),g.uniforms.previewRotation.value.push(void 0);g.uniforms.isVisible.value=1,g.VS_overridableFunctions.ComputeVaryingValues=g.VS_overridableFunctions.ComputeVaryingValues.replace(/__NBRASTER__/g,r.toString()),g.FS_global_code=g.FS_global_code.replace(/__NBRASTER__/g,r.toString()),g.FS_overridableFunctions.ComputeCommonValues=g.FS_overridableFunctions.ComputeCommonValues.replace(/__NBRASTER__/g,r.toString()),g.nbTexture=r,g.varyings.uvsraster.length=r,H[r]=g}m.push(H[r])}else m.push(G);this.isTerrainAnalyzerActivated()&&2===n&&m.push(J),1===h&&m.push(E),1===d&&m.push(k),1===u&&m.push(z),D?this._chunksList[p]=l.getPDSFXMaterial(m,"physical"):(this._chunksList[p]=l.getPDSFXMaterial(m,"phong"),this._chunksList[p].updatePDSFXUniform("specularOcean",new e.Color("rgb(25,25,25)"))),this._chunksList[p].metalness=0,this._chunksList[p].roughness=1,void 0!==this._chunksList[p].cloneWithAnim?this._poolMaterial[p]=new f(this._chunksList[p].cloneWithAnim):this._poolMaterial[p]=new f(this._chunksList[p].clone.bind(this._chunksList[p]))}return this._poolMaterial[p].use()},updateTerrainTile:function(e){if(void 0!==e.tile){var t,i,r=this._findTerrainSource(e.tile).display;if(this._sourceList[r].isHD()||this._sourceList[r].isGeometric()||(t=this._findSortedRasterSources(e.tile),i=this._findLandcoverSource(e.tile)),this._sourceList[r].updateTile(e.tile),void 0!==i&&this._sourceList[i].updateTile(e.tile),void 0!==t)for(;t.length;)r=t.shift(),this._sourceList[r].updateTile(e.tile)}},cancelDownloadTerrainTile:function(e){if(void 0!==e.tile){var t,i,r=this._findTerrainSource(e.tile).download;if(this._sourceList[r].isHD()||this._sourceList[r].isGeometric()||(t=this._findSortedRasterSources(e.tile),i=this._findLandcoverSource(e.tile)),this._sourceList[r].cancelTile(e.tile),void 0!==i&&this._sourceList[i].cancelTile(e.tile),void 0!==t)for(;t.length;)r=t.shift(),this._sourceList[r].cancelTile(e.tile)}},downloadTerrainTile:function(e,t,i,s,n){if(void 0!==t&&void 0!==t.tile)e.tile=t.tile;else if(void 0===e.tile)return void a.warn("XCityCoreTerrain: No tile information given...");var l,h,d,u,c,p=!0,f=function(e,t,i){e&&r.deprecate("terrain",i)};if(e.temporary=!1,e.tmp=!1,h=this._findTerrainSource(e.tile).download,this._sourceList[h].isHD()||this._sourceList[h].isGeometric()||(d=this._findSortedRasterSources(e.tile),u=this._findLandcoverSource(e.tile)),c=this._sourceList[h].downloadTile(e.tile,t,i,f,this,e.key),p&=o.is(c),void 0!==u&&(c=this._sourceList[u].downloadTile(e.tile,t,i,f,this,e.key),p&=o.is(c)),void 0!==d){var m=i;const r=.9;for(;d.length;)h=d.shift(),c=this._sourceList[h].downloadTile(e.tile,t,m,f,this,e.key),p&=o.is(c),this._sourceList[h]._attributes.opacity&&this._sourceList[h]._attributes.opacity<r||this._sourceList[h].isTileContainedInSource(e.tile)&&(m=1)}p||(c=this._sourceList.default.downloadTile(e.tile,t,i,f,this,e.key),p=!0,e.tmp=!0,e.temporary=!0),(l=Array.prototype.slice.call(arguments,5)).unshift(p,void 0,{status:200}),s.apply(n,l)},buildTerrainTile:function(t){var s,n,a,d,u,c,f,m,_,y,b=this._findTerrainSource(t.tile);if(f=b.display,_=(m=this._sourceList[f]).isHD()||m.isGeometric()?[]:this._findSortedRasterSources(t.tile),y=m.isHD()||m.isGeometric()?void 0:this._findLandcoverSource(t.tile),o.is(t.value)&&t.value.source===f){if(s=t.value,b.download!==b.display)if((L=this._sourceList[b.download]).isGeometric()){for(var x=t.tile.LOD,D=t.tile.I,A=t.tile.J;x>L.get("levelMax");)D>>=1,A>>=1,--x;var F={LOD:x,I:D,J:A,key:o.getQuadKey(x,D,A)};s.useGeometricParent=!0,s.tileParent=F}else s.useGeometricParent=!1}else{if(m.isGeometric())if(t.tile.LOD>m.get("levelMax")){for(x=t.tile.LOD,D=t.tile.I,A=t.tile.J;x>m.get("levelMax");)D>>=1,A>>=1,--x;(s={useGeometricParent:!0,tileParent:F={LOD:x,I:D,J:A,key:o.getQuadKey(x,D,A)}}).isGeometric=!0,s.getGroundAltitude=$.bind(s)}else null!=(s=r.getData(m.get("url"),t.tile.key))?(s.isGeometric=!0,s.getGroundAltitude=$.bind(s)):(f="default",m=this._sourceList[f],_=this._findSortedRasterSources(t.tile),y=this._findLandcoverSource(t.tile));var L;if(null==s)if((s=Y(m,t.tile)).name="TerrainPatch_"+t.tile.LOD+"_"+t.tile.I+"_"+t.tile.J,s.mesh3js.name="TerrainPatch_"+t.tile.LOD+"_"+t.tile.I+"_"+t.tile.J,s.boundingSphere=new e.Sphere,s.boundingSphere.radius=Math.sqrt(.75)+0,s.setShadow(!1,!0),s.setPickable(i.PICKABLE),s.getGroundColor=function(e,t){var i=this.getMaterial().getPDSFXUniform("raster");if(o.is(i.value)&&o.is(i.value.image)){this.getMatrix().decompose(K,Q,Z);var r=.5+(e-K.x)/Z.x,s=.5+(t-K.y)/Z.y,n=i.value.image;s=1-s;var a=Math.floor(r*n.width),l=Math.floor(s*n.height);return n.width,n.height,function(e,t,i){var r=4*(t+e.width*i),s=e.data;return{r:s[r],g:s[r+1],b:s[r+2],a:s[r+3]}}(function(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var i=t.getContext("2d");return i.drawImage(e,0,0),i.getImageData(0,0,e.width,e.height)}(n),a,l)}}.bind(s),(L=this._sourceList[b.download]).isGeometric()){for(x=t.tile.LOD,D=t.tile.I,A=t.tile.J;x>L.get("levelMax");)D>>=1,A>>=1,--x;F={LOD:x,I:D,J:A,key:o.getQuadKey(x,D,A)};s.useGeometricParent=!0,s.tileParent=F}else s.useGeometricParent=!1;s.source=f,s.storeKey=t.key}if(!s.isGeometric){var V=_.indexOf(y)>=0;a=function(e,t,i,r){var s,n=0;return e.isGeometric()||""===e.get("url")||(n+=X.nbTexture),void 0!==t&&I&&(r||(n+=l.chunkLandcover_unvisibleSource_PDSFX.nbTexture),void 0!==O&&(n+=l.chunkOcean_PDSFX.nbTexture)),s=C-n,Math.min(i,s)}(m,y,_.length,V);var N,U=s.getMaterial();if(!function(e,t,i,r,s){if(null==e)return!0;if(!t.isGeometric()){var n=e.getPDSFXUniform("dtm");if(""!==t.get("url")&&!o.is(n)||""===t.get("url")&&o.is(n))return!0}if(void 0!==e.nbRasterSources&&e.nbRasterSources!==r)return!0;var a=e.getPDSFXUniform("landcover");if(void 0!==i&&!o.is(a)||void 0===i&&o.is(a))return!0;if(e.landcoverRasterVisible!==s)return!0;var l=e.getPDSFXUniform("oceanTexture");if(I&&!o.is(l)||!I&&o.is(l))return!0;var h=e.getPDSFXUniform("levelColor"),d=e.getPDSFXUniform("tileTexture"),u=e.getPDSFXUniform("wireColor");if(w&&!o.is(h)||!w&&o.is(h)||M&&!o.is(d)||!M&&o.is(d)||S&&T&&!o.is(u)||S&&!T&&o.is(u))return!0;var c=e.getPDSFXUniform("mode");return!((void 0===R.mode||"default"===R.mode||o.is(c))&&(void 0!==R.mode&&"default"!==R.mode||!o.is(c)))}(U,m,y,a,V)?(n=U).name="TerrainMaterial_"+t.tile.LOD+"_"+t.tile.I+"_"+t.tile.J:((n=this._getTerrainMaterial(m,y,a,V)).name="TerrainMaterial_"+t.tile.LOD+"_"+t.tile.I+"_"+t.tile.J,n.nbRasterSources=a,n.landcoverRasterVisible=V,n.side=e.FrontSide,n.forceSide=!0,l.updateCommonUniforms(n,!1),o.is(U)&&(l.deactivateAnimationUniforms(U),U._globePool.recycle(U)),s.setMaterial(n),s.mesh3js.material=n,""!==m.get("url")?m.isGeometric()||(s.getGroundAltitude=function(e,t){var i=this.getMaterial(),r=i.getPDSFXUniform("dtm");if(!o.is(r.value)||!o.is(r.value.image))return g;this.getMatrix().decompose(K,Q,Z);var s=.5+(e-K.x)/Z.x,n=.5+(t-K.y)/Z.y,a=i.getPDSFXUniform("dtmOffset");if(o.is(a)){var l=a.value;s=s*l.z+l.x,n=n*l.z+l.y}var h=i.getPDSFXUniform("dtmProperties");if(o.is(h)){var d=h.value;s=s*(1-2*d.z)+d.z,n=n*(1-2*d.w)+d.w}var u=r.value.image;n=1-n;var c=Math.floor(s*u.width),p=Math.floor(n*u.height),f=s*u.width-c,m=n*u.height-p,v=u.data[p*u.width+c],_=u.data[p*u.width+(c+1)],y=u.data[(p+1)*u.width+(c+1)];return v*(1-f)*(1-m)+_*f*(1-m)+u.data[(p+1)*u.width+c]*m*(1-f)+y*f*m}.bind(s)):s.getGroundAltitude=function(e,t){return g}.bind(s)),this._updateAltitudeUniforms(n),this._updateDebugUniforms(n,t.tile),this._updateCropUniforms(n,t.tile),this._updateSkyUniforms(n),m.isGeometric()||""===m.get("url")||m.applyDTM(n,t.tile),void 0===y||V||this._sourceList[y].applyLandcover(n,t.tile),this.isTerrainAnalyzerActivated()&&this._updateAnalyzerUniforms(n),a>0)if(1===a)this._sourceList[_[0]].applyOverlay(n,t.tile),y===_[0]&&this._sourceList[y].applyLandcover2(n,t.tile,0);else for(_.sort(function(e,t){var i,r=this._sourceList[e].getDataModelOrder(),s=this._sourceList[t].getDataModelOrder(),n=Math.min(r.length,s.length);for(i=0;i<n;++i){if(r[i]<s[i])return-1;if(r[i]>s[i])return 1}return 0}.bind(this)),u=0,c=_.length-a;u<a;++u,++c)N=_[c],this._sourceList[N].applyOverlay(n,t.tile,u),y===N&&this._sourceList[y].applyLandcover2(n,t.tile,u);var E=1,k=0,z=n.getPDSFXUniform("dtm");o.is(z)&&void 0!==z.value&&(E=Math.max(z.value.bounds.max-z.value.bounds.min,1),k=(z.value.bounds.max+z.value.bounds.min)/2),function(t,i,r,s){var n=t.getMatrix();n.identity();var a=v.x/(1<<i.LOD),o=v.y/(1<<i.LOD),l=s,h=new e.Vector3(a,o,l),d=new e.Vector3((i.I+.5)*h.x,(i.J+.5)*h.y,r);P&&(h.x*=.9,h.y*=.9),n.setPosition(d),n.scale(h),t.setMatrix(n),t.forceUpdate()}(s,t.tile,k,E)}var B=this._sourceList[s.source].getRendering();if(p.is(B)||(B=this.getRendering()),!0!==s.useGeometricParent&&(p.is(n)?(B.applyFeatureRenderingToMaterial(n),O=n.oceanTexture):B.applyRendering(s)),this._updateOceanUniforms(n),h.publish("/xCity/needRender",this),t.value!==s)if(void 0===t.value||null===t.value)t.value=s;else{if(void 0!==t.value.parents&&!0!==s.useGeometricParent)for(c=(d=t.value.getParents()).length;c--;)d[c].removeChild(t.value),d[c].addChild(s);var j=!1;t.locks>0&&(j=!0,r.unlock("terrain",t.key)),t.oldValue.push(t.value),t.value=s,s.isGeometric&&(t.tmp=!1,t.temporary=!1,t.value.tmp=!1,t.value.temporary=!1),!0===j&&r.lock("terrain",t.key)}else{j=!1;t.locks>0&&(j=!0,r.unlock("terrain",t.key)),!0===j&&r.lock("terrain",t.key)}},getLowerDataModelSource:function(e,t){var i=this._sourceList[e].getDataModelOrder(),r=this._sourceList[t].getDataModelOrder(),s=i.length,n=r.length;if(s<=0)return t;if(n<=0)return e;var a,o=Math.min(s,n);for(a=0;a<o;++a){if(i[a]<r[a])return t;if(i[a]>r[a])return e}return o===s?e:t},cleanTerrainTile:function(i){var s,n=function(e,t){var i,s,n=e.getPDSFXUniform(t);if(p.is(n))if("tv"===n.type)for(i=0,s=n.value.length;i<s;++i)void 0!==(a=n.value[i])&&(n.value[i]=void 0,r.unlock(a.storeId,a.storeKey));else if("t"===n.type||"t2"===n.type){var a=n.value;void 0!==a&&(n.value=void 0,r.unlock(a.storeId,a.storeKey))}};i instanceof e.ShaderMaterialDS?s=i:i instanceof t&&(s=i.getMaterial()),void 0!==s?(n(s,"dtm"),n(s,"raster"),n(s,"landcover"),s.updatePDSFXUniform("dtmCrop",new e.Vector4(-1,-1,1,1)),s._globePool.recycle(s),i.setMaterial(null),i.mesh3js.material=null,i._globePool.recycle(i)):a.warn("XCityCoreTerrain:cleanTerrainTile - no material...")},registerTerrainSource:function(e,t){void 0===this._sourceList[e]?(this._sourceList[e]=t,b=Math.max(b,t.get("levelMax")),t.addEvent("onChange:statistics",this.updateStatistics.bind(this,t)),t._itemParent.addEvent("onChange:visible",this.updateStatistics.bind(this,t)),t.addEvent("onDestroy",this.removeStatistics.bind(this,t))):a.warn("XCityCoreTerrain: A terrain source '"+e+"' already exists!")},removeStatistics:function(e){var t=e.get("url");if(p.is(this._altitudeMaxList)){var i,r=this._altitudeMaxList.length;for(i=0;i<r;i++)if(this._altitudeMaxList[i].id===t){this._altitudeMaxList.splice(i,1);break}for(r=this._altitudeMinList.length,!1,i=0;i<r;i++)if(this._altitudeMinList[i].id===t){this._altitudeMinList.splice(i,1);break}this.updateMinMaxAltitude()}},updateStatistics:function(e){var t=e.get("statistics");p.is(t)||(t={}),t.id=e.get("url"),t.visible=e._itemParent.get("visible"),this.mergeStatistics(t)},mergeStatistics:function(e){p.is(this._altitudeMaxList)||(this._altitudeMaxList=[]);var t,i=this._altitudeMaxList.length,r=!1;for(t=0;t<i;t++)if(this._altitudeMaxList[t].id===e.id){this._altitudeMaxList[t]=e,r=!0;break}for(r||(this._altitudeMaxList.push(e),p.sortObjectArraybyAttribute(this._altitudeMaxList,"maximalAltitude")),p.is(this._altitudeMinList)||(this._altitudeMinList=[]),i=this._altitudeMinList.length,r=!1,t=0;t<i;t++)if(this._altitudeMinList[t].id===e.id){this._altitudeMinList[t]=e,r=!0;break}r||(this._altitudeMinList.push(e),p.sortObjectArraybyAttribute(this._altitudeMinList,"minimalAltitude")),this.updateMinMaxAltitude()},updateMinMaxAltitude:function(){var e,t,i=this._altitudeMaxList.length;for(e=i-1;e>=0&&!(t=this._altitudeMaxList[e]).visible;e--);e<0&&(t=null);var r=this.getRendering();for(p.is(t)&&p.is(t.maximalAltitude)?this.maximalAltitude=t.maximalAltitude:this.maximalAltitude=r.defaultElevationMax,i=this._altitudeMinList.length,e=0;e<i&&!(t=this._altitudeMinList[e]).visible;e++);e>=i&&(t=null),p.is(t)&&p.is(t.minimalAltitude)?this.minimalAltitude=t.minimalAltitude:this.minimalAltitude=r.defaultElevationMin,r.updateElevationMin(this.minimalAltitude),r.updateElevationMax(this.maximalAltitude)},unregisterTerrainSource:function(e){void 0!==this._sourceList[e]&&(delete this._sourceList[e],r.deprecateAll("terrain"))},activateTerrainSource:function(e){var t=this._sourceList[e];t&&(void 0===this._activeTerrain[t.get("levelMin")]&&(this._activeTerrain[t.get("levelMin")]=[]),-1===this._activeTerrain[t.get("levelMin")].indexOf(e)&&(this._activeTerrain[t.get("levelMin")].push(e),r.deprecateAll("terrain")))},deactivateTerrainSource:function(e){var t,i=this._sourceList[e];i&&void 0!==this._activeTerrain[i.get("levelMin")]&&-1!==(t=this._activeTerrain[i.get("levelMin")].indexOf(e))&&(this._activeTerrain[i.get("levelMin")].splice(t,1),0===this._activeTerrain[i.get("levelMin")].length&&delete this._activeTerrain[i.get("levelMin")],r.deprecateAll("terrain"))},registerRasterSource:function(e,t){void 0===this._sourceList[e]?(this._sourceList[e]=t,b=Math.max(b,t.get("levelMax")),t.isLandcover()&&(void 0===this._activeLandcover[t.get("levelMin")]&&(this._activeLandcover[t.get("levelMin")]=[]),this._activeLandcover[t.get("levelMin")].push(e),r.deprecateAll("terrain"))):a.warn("XCityCoreTerrain: A overlay source '"+e+"' already exists!")},unregisterRasterSource:function(e){if(void 0!==this._sourceList[e]){if(this._activeLandcover[this._sourceList[e].get("levelMin")]){var t=this._activeLandcover[this._sourceList[e].get("levelMin")].indexOf(e);t>-1&&this._activeLandcover[this._sourceList[e].get("levelMin")].splice(t,1)}delete this._sourceList[e],r.deprecateAll("terrain")}},activateRasterSource:function(e){var t=this._sourceList[e];t&&(void 0===this._activeRaster[t.get("levelMin")]&&(this._activeRaster[t.get("levelMin")]=[]),-1===this._activeRaster[t.get("levelMin")].indexOf(e)&&(this._activeRaster[t.get("levelMin")].push(e),r.deprecateAll("terrain")))},deactivateRasterSource:function(e,t){var i,s=this._sourceList[e];if(s){var n=s.get("levelMin");"number"==typeof t&&(n=t),void 0!==this._activeRaster[n]&&-1!==(i=this._activeRaster[n].indexOf(e))&&(this._activeRaster[n].splice(i,1),0===this._activeRaster[n].length&&delete this._activeRaster[n],r.deprecateAll("terrain"))}},getRendering:function(){return p.is(this._rendering)||(this._rendering=new c(this.renderingProfileManager._urban)),this._rendering},redraw:function(){var e=this.getRendering(),t=e.getCompleteMaterialInfo(),i=!0;if(this.setupOcean(t)||(i=!1),this.setupAnalyzer(t)||(i=!1),i){r.traverse("terrain",function(t){void 0!==t.material&&null!==t.material&&e.applyFeatureRenderingToMaterial(t.material)})}},redrawGeometricTiles:function(e){var t=e.getRendering(),i=(t.getCompleteMaterialInfo(),e.get("id"));r.traverse("terrain",function(e){e.isGeometric&&e.source===i&&t.applyRendering(e)})},get:function(e){var t,i,r=this.getRendering();return p.is(r)&&r.hasAttribute(e)&&(i=this.getMaterial(),p.is(i)&&(t=(i=m.getJSONFromRendering(i))[e])),t},set:function(e,t){var i={},r=this.getRendering();p.is(r)&&r.hasAttribute(e)&&(i[e]=t,this.setMaterial(i))},resetRenderingAttribute:function(e){if(!p.is(this.renderingProfileManager))return null;this.renderingProfileManager.resetAttributeOnly(this._renderingId,e),this.renderingProfileManager.updateGeomRenderings([this]),this.redraw()},setMaterial:function(e){return p.is(this.renderingProfileManager)?(this.renderingProfileManager.addRendering(this._renderingId,e),this):null},getMaterial:function(){var e=this.getRendering();return p.is(e)?e.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this._renderingId)},isTerrainAnalyzerActivated:function(){return void 0!==R.mode&&"default"!==R.mode}};var te=null;return null===te&&(te=new ee),te}),define("DS/XCityModel/RasterOverlay",["DS/Visualization/ThreeJS_DS","DS/XCityModel/Item","DS/XCityCore/Store","DS/XCityCore/Terrain","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/EventDispatcher","DS/xCityPlatformUtils/xCityDocumentManagement","DS/Manipulators/PointHandle","DS/Visualization/Node3D","DS/Mesh/MeshUtils"],function(e,t,i,r,s,n,a,o,l,h,d,u){"use strict";var c=function(e,t){var i=n.cloneQuad(t);return i.LOD>e.get("levelMax")&&(i.I=i.I>>i.LOD-e.get("levelMax"),i.J=i.J>>i.LOD-e.get("levelMax"),i.LOD=e.get("levelMax"),i.key=void 0),e.get("yTopToBottom")&&(i.J=(1<<i.LOD)-1-i.J,i.key=void 0),void 0===i.key&&(i.key=n.getQuadKey(i.LOD,i.I,i.J)),i},p=t.extend({defaults:{levelMin:0,levelMax:-1,levelMaxVisu:99999,priority:3,cache:50,AABBox:null,url:"",res:1,opacity:1,yTopToBottom:!1,listenToDateUpdate:!1,upTime:"",downTime:"",objectId:"",serviceId:"",loadInfo:{loaded:1,total:1}},metaData:{type:"RasterOverlay",className:"RasterOverlay"},loaderJSON:{AABBox:"loadJSONAABox"},setup:function(){this._parent()},create:function(t){if(!this._parent(t))return o.publish(o.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;this._urban=t._urban,this._attributes.loadInfo.loaded=1,this._attributes.loadInfo.total=1;var s=function(){""===this.get("objectId")&&""===this.get("url")||-1===i.getStoreList().indexOf(this.get("url"))&&(i.deleteStore(this.previous("url")),this.get("url").search("%xmin")>-1&&this.get("url").search("%xmax")>-1&&this.get("url").search("%ymin")>-1&&this.get("url").search("%ymax")>-1?i.createStore(this.get("url"),{url:this.get("url"),cacheSize:this.get("cache"),priority:this.get("priority"),texture:!0,wms:{worldSize:t._urban.worldSize,shiftedPosition:t._urban.shiftedPosition},onFinish:{func:this._onFinish.bind(this),bound:this},listenToDateUpdate:this.get("listenToDateUpdate"),upTime:this.get("upTime"),downTime:this.get("downTime")}):i.createStore(this.get("url"),{url:this.get("url"),cacheSize:this.get("cache"),priority:this.get("priority"),texture:!0,tile:!0,onFinish:{func:this._onFinish.bind(this),bound:this},listenToDateUpdate:this.get("listenToDateUpdate"),upTime:this.get("upTime"),downTime:this.get("downTime")}),i.deprecateAll("terrain"))}.bind(this);s(),this.addEvent("onChange:url",s),this.addEvent("onChange:opacity",this.deprecateTerrain),this.addEvent("onChange:levelMin",this.rebuildTerrain),this.addEvent("onChange:levelMax",this.rebuildTerrain),this.addEvent("onChange:AABBox",this.deprecateTerrain),this.get("objectId");var n=this,a=this.get("url"),h="null"!==a&&"undefined"!==a&&!0===a.includes("datasupplier");if(""!==this.get("objectId")&&!h){var u=this.get("objectId"),c=null,p="3DSpace";"3DDrive"===this.get("serviceId")&&(c=u,p="3DDrive"),l.retrieveDocumentUrl(u,c,p).then(function(e){n.userData={isPreview:!0,editablePosition:!0,cache:{dataset:{previewRaster:!0}}},n._itemParent&&(n._itemParent.userData||(n._itemParent.userData={}),n._itemParent.userData.isPreview=!0,n._itemParent.userData.editablePosition=!0),n.set("url",e)})}return r.registerRasterSource(this.get("id"),this),this._updateVisibility(this.getItemParent()),this.anchorList=[],this.anchorRootNode=new d,this.anchorOffsetNode=new d,this.anchorRootNode.setVisibility(!0),this.anchorRootNode.setMatrix(new e.Matrix4),this.clickedColor=new e.Color("#00BFFE"),this.pointColor=new e.Color("#FFFFFF"),this._node=new d,t._urban.getView3D()._rootProjShifted.addChild(this.anchorOffsetNode),this.anchorOffsetNode.addChild(this.anchorRootNode),this.anchorOffsetNode.addChild(this._node),!0},_onFinish:function(e){o.publish(o.eventsList.onLoaded+":"+this.get("id"),{success:e,item:this.getItemParent()})},destroy:function(e){r.deactivateRasterSource(this.get("id")),r.unregisterRasterSource(this.get("id"));var t=!0;e.traverse(function(e){e.get("Content")&&e.get("Content").get("url")&&e.get("Content").get("id")!==this.get("id")&&e.get("Content").get("url")===this.get("url")&&(t=!1)}.bind(this),!0),t&&i.deleteStore(this.get("url"),!0),e._urban.getView3D()._rootProjShifted.removeChild(this.anchorOffsetNode),this._parent(e)},isLandcover:function(){return this._itemParent.findTags("landcover")},acceptTile:function(e){if(e.LOD<this.get("levelMin")||e.LOD>this.get("levelMaxVisu"))return!1;if(n.is(this.get("AABBox"))){var t={};if(this.get("AABBox").getIJBox(e.LOD,t),e.I<t.IMin||e.I>t.IMax)return!1;if(e.J<t.JMin||e.J>t.JMax)return!1}return!0},isTileContainedInSource:function(e){if(e.LOD<this.get("levelMin")||e.LOD>this.get("levelMaxVisu"))return!1;if(n.is(this.get("AABBox"))){var t=this.get("AABBox"),i=t.getShiftedBBox(e.LOD,e.I,e.J);return!(i.xMax>t._maxShifted[0]||i.xMin<t._minShifted[0]||i.yMax>t._maxShifted[1]||i.yMin<t._minShifted[1])}return!0},cancelTile:function(e){var t=c(this,e);t.LOD===e.LOD&&i.cancelDownloadData(this.get("url"),t.key)},updateTile:function(e){var t=c(this,e);i.updateTimestampData(this.get("url"),t.key)},getTile:function(e){var t=c(this,e);return i.getData(this.get("url"),t.key)},downloadTile:function(e,t,r,s,a){var o,l={tile:c(this,e),priority:r,undeletable:t.undeletable},h=i.getData(this.get("url"),l.tile.key);if(!n.is(h)&&(t.isVisible&&(this._incrementTotalItems(),(o=Array.prototype.slice.call(arguments,3)).unshift(this.get("url"),l.tile.key,l,function(e,t,i,r){if(e&&t&&(t.anisotropy=1),void 0!==i){var s=Array.prototype.slice.call(arguments,4);s.unshift(e,t),i.apply(r,s)}this._incrementLoadedItems()},this),i.getOrDownloadData.apply(i,o)),t&&t.canUseParent))for(var d=this.get("levelMin"),u=l.tile.LOD,p=l.tile.I,f=l.tile.J,m=void 0;!n.is(m)&&u>d;)u-=1,p>>=1,f>>=1,m=i.getData(this.get("url"),n.getQuadKey(u,p,f));return h},_incrementTotalItems:function(){var e={loaded:this.get("loadInfo").loaded,total:this.get("loadInfo").total+1};this.set("loadInfo",e)},_incrementLoadedItems:function(){var e={loaded:this.get("loadInfo").loaded+1,total:this.get("loadInfo").total};this.set("loadInfo",e)},_attachCallbacks:function(t){var i=this;t.subscribe("Manipulate",function(r){var s=r.event.from[0].currentPosition;t.setPickable(u.NOPICKABLE);var n=i._urban.getViewpoint().exactPick(s);if(t.setPickable(u.PICKABLE),Utils.is(n)){var a=n.clone();a=n,t.setMatrix((new e.Matrix4).setPosition(a)),t.pos3D=n,t.pos2D={x:s.x,y:s.y},0===t.index?(i._SWanchor=[n.x,n.y],i._centroid.x=(i.anchorList[1].ph.pos3D.x+n.x)/2,i._centroid.y=(i.anchorList[1].ph.pos3D.y+n.y)/2,i._node.setMatrix((new e.Matrix4).setPosition(i._centroid)),i._urban.USR.setRobotTarget(i._itemParent,!0),i.rebuildTerrain()):1===t.index&&(i._NEanchor=[n.x,n.y],i._centroid.x=(n.x+i.anchorList[0].ph.pos3D.x)/2,i._centroid.y=(n.y+i.anchorList[0].ph.pos3D.y)/2,i._node.setMatrix((new e.Matrix4).setPosition(i._centroid)),i._urban.USR.setRobotTarget(i._itemParent,!0),i.rebuildTerrain()),i.widthTexture=i.anchorList[1].ph.pos3D.x-i.anchorList[0].ph.pos3D.x,i.heightTexture=i.anchorList[1].ph.pos3D.y-i.anchorList[0].ph.pos3D.y}}),t.subscribe("BeginManipulate",function(e){t.locked=!0}),t.subscribe("EndManipulate",function(e){t.locked=!1}),t.subscribe("BeginPreactivate",function(e){i.preSelectedPh=t}),t.subscribe("Preactivate",function(e){}),t.subscribe("EndPreactivate",function(e){i.preSelectedPh=null})},_createPointHandle:function(t,i){var r,s=new h({viewer:this._urban.getView3D().webGLV6Viewer,sceneGraph:this.anchorRootNode});return Utils.is(this._pointTexture)?s.pointMat.map=this._pointTexture:this._pointTexture=s.pointMat.map,s.index=this.anchorList.length,s.pos3D=t,s.pos2D={x:i.x,y:i.y},s.name="ph_"+this.anchorList.length,r=t,s.setMatrix((new e.Matrix4).setPosition(r)),s.setSize(20),s.setFillColor(this.pointColor),this._attachCallbacks(s),s},_addAnchor:function(t,i,r,s){if(Utils.is(t)&&Utils.is(i)&&t instanceof e.Vector3&&(i instanceof e.Vector3||i instanceof e.Vector2)){var n={ph:this._createPointHandle(t,i),featureIndex:r||0};this.anchorList.push(n)}},_computePreviewCoefs:function(){if(this.get("objectId")&&this.userData&&this.userData.isPreview){if(this.centroidInit)this.target.getPositionFromMatrix(this._node.getMatrix()),this._rotation=180*Math.acos(this._node._matrix.elements[0])/Math.PI,this._node._matrix.elements[1]<0&&(this._rotation=-this._rotation);else{this.centroidInit=!0,this.widthTexture=xCity.pointOfView.length/4,this.heightTexture=xCity.pointOfView.length/4,this.target=xCity.targetPosition;var t=new e.Vector3(this.target.x,this.target.y,0);this._centroid=t,this._node.setMatrix((new e.Matrix4).setPosition(t)),this._node.userData=this._itemParent;var i=this;this.customRobot=function(){var t=i._node._matrix.getPosition(),r=t.x-i._centroid.x,s=t.y-i._centroid.y;i._SWanchor[0]+=r,i._SWanchor[1]+=s,i._NEanchor[0]+=r,i._NEanchor[1]+=s;var n=new e.Vector3(-i.widthTexture/2,-i.heightTexture/2,0).applyMatrix4(i._node._matrix),a=new e.Vector3(i.widthTexture/2,i.heightTexture/2,0).applyMatrix4(i._node._matrix);i.anchorList[0].ph.pos3D.x=n.x,i.anchorList[0].ph.pos3D.y=n.y,i.anchorList[1].ph.pos3D.x=a.x,i.anchorList[1].ph.pos3D.y=a.y,i.anchorList[0].ph.setMatrix((new e.Matrix4).setPosition(new e.Vector3(i.anchorList[0].ph.pos3D.x,i.anchorList[0].ph.pos3D.y,0))),i.anchorList[1].ph.setMatrix((new e.Matrix4).setPosition(new e.Vector3(i.anchorList[1].ph.pos3D.x,i.anchorList[1].ph.pos3D.y,0))),i._centroid=t.clone(),i.rebuildTerrain()}}if(this._SWanchor||(this._SWanchor=[this.target.x-this.widthTexture/2,this.target.y-this.heightTexture/2]),this.get("selected")){var r=new e.Vector3(this._SWanchor[0],this._SWanchor[1],0),s=xCity._urbanImpl.getViewpoint().getScreenPosition(r);0===this.anchorList.length&&this._addAnchor(r,s,0)}if(this._NEanchor||(this._NEanchor=[this.target.x+this.widthTexture/2,this.target.y+this.heightTexture/2]),this.get("selected")){var n=new e.Vector3(this._NEanchor[0],this._NEanchor[1],0),a=xCity._urbanImpl.getViewpoint().getScreenPosition(n);1===this.anchorList.length&&this._addAnchor(n,a,0)}var o=(xCity._urbanImpl.baseReferential.bbox.xmin-this._SWanchor[0])/(xCity._urbanImpl.baseReferential.bbox.xmin-xCity._urbanImpl.baseReferential.bbox.xmax),l=(xCity._urbanImpl.baseReferential.bbox.ymin-this._SWanchor[1])/(xCity._urbanImpl.baseReferential.bbox.ymin-xCity._urbanImpl.baseReferential.bbox.ymax),h=(xCity._urbanImpl.baseReferential.bbox.xmin-this._NEanchor[0])/(xCity._urbanImpl.baseReferential.bbox.xmin-xCity._urbanImpl.baseReferential.bbox.xmax);return{xMin:l,xMax:(xCity._urbanImpl.baseReferential.bbox.ymin-this._NEanchor[1])/(xCity._urbanImpl.baseReferential.bbox.ymin-xCity._urbanImpl.baseReferential.bbox.ymax),yMin:o,yMax:h,rotation:this._rotation}}},applyOverlay:function(t,r,s){var o=t.getPDSFXUniform("raster");if(n.is(o)){var l,h,d,u,p,f,m,g;void 0===s?void 0!==o.value&&(g=o.value,i.unlock(g.storeId,g.storeKey),t.updatePDSFXUniform("raster",void 0)):void 0!==o.value[s]&&(g=o.value[s],i.unlock(g.storeId,g.storeKey),o.value[s]=void 0);var v=t.getPDSFXUniform("rasterOffset");void 0===s?void 0===v.value&&t.updatePDSFXUniform("rasterOffset",new e.Vector4(0,0,1,1)):void 0===v.value[s]&&(v.value[s]=new e.Vector4(0,0,1,1)),m=c(this,r),g=i.getData(this.get("url"),m.key);if(n.is(g))d=r.LOD-m.LOD;else{for(l=this.get("levelMin"),h=m.LOD,p=m.I,f=m.J;!n.is(g)&&h>l;)h-=1,p>>=1,f>>=1,g=i.getData(this.get("url"),n.getQuadKey(h,p,f)),1;d=r.LOD-h}var _=this.get("opacity");if(n.is(g)||(g=a.whiteMap,2,_=0),n.is(g))if(u=1<<d,p=r.I>>d,f=r.J>>d,i.lock(g.storeId,g.storeKey),void 0===s){if(t.updatePDSFXUniform("raster",g),t.updatePDSFXUniform("rasterOffset",new e.Vector4(r.I/u-p,r.J/u-f,1/u,_)),t.updatePDSFXUniform("previewCoefs",new e.Vector4(-1,-1,-1,-1)),this.get("objectId")&&this.userData&&this.userData.isPreview){var y=this._computePreviewCoefs();t.updatePDSFXUniform("previewCoefs",new e.Vector4(y.yMin,y.xMin,y.yMax,y.xMax)),t.updatePDSFXUniform("previewRotation",new e.Vector4(y.rotation,0,0,0))}}else{o.value[s]=g,v.value[s]=new e.Vector4(r.I/u-p,r.J/u-f,1/u,_);var b=t.getPDSFXUniform("previewCoefs");void 0===b.value[s]&&(b.value[s]=new e.Vector4(0,0,1,1)),b.value[s]=new e.Vector4(-1,-1,-1,-1);var x=t.getPDSFXUniform("previewRotation");if(void 0===x.value[s]&&(x.value[s]=new e.Vector4(0,0,1,1)),x.value[s]=new e.Vector4(0,-1,-1,-1),this.get("objectId")&&this.userData&&this.userData.isPreview){y=this._computePreviewCoefs();b.value[s]=new e.Vector4(y.yMin,y.xMin,y.yMax,y.xMax),x.value[s]=new e.Vector4(y.rotation,0,0,0)}}t.force=!0}},applyLandcover:function(e,t,r){var s=e.getPDSFXUniform("landcover");if(n.is(s)){if(void 0!==s.value){var a=s.value;i.unlock(a.storeId,a.storeKey),e.updatePDSFXUniform("landcover",void 0)}var o,l,h,d,u,p,f=c(this,t);a=i.getData(this.get("url"),f.key);if(n.is(a))h=t.LOD-f.LOD;else{for(o=this.get("levelMin"),l=f.LOD,u=f.I,p=f.J;!n.is(a)&&l>o;)l-=1,u>>=1,p>>=1,a=i.getData(this.get("url"),n.getQuadKey(l,u,p));h=t.LOD-l}if(n.is(a)){i.lock(a.storeId,a.storeKey),e.updatePDSFXUniform("landcover",a),d=1<<h,u=t.I>>h,p=t.J>>h;var m=e.getPDSFXUniform("landcoverOffset");m.value.set(t.I/d-u,t.J/d-p,1/d),e.updatePDSFXUniform("landcoverOffset",m.value)}e.force=!0}},applyLandcover2:function(e,t,i){var r=e.getPDSFXUniform("landcoverIndex");n.is(r)&&(void 0!==r.value&&e.updatePDSFXUniform("landcoverIndex",-1),e.updatePDSFXUniform("landcoverIndex",i))},deprecateTerrain:function(){return i.deprecateAll("terrain"),this},rebuildTerrain:function(){return r.deactivateRasterSource(this.get("id"),this.previous("levelMin")),r.activateRasterSource(this.get("id")),this},setRobot:function(t){if(t){var i=new e.Vector3(this._SWanchor[0],this._SWanchor[1],0),r=xCity._urbanImpl.getViewpoint().getScreenPosition(i);0===this.anchorList.length&&this._addAnchor(i,r,0);var s=new e.Vector3(this._NEanchor[0],this._NEanchor[1],0),n=xCity._urbanImpl.getViewpoint().getScreenPosition(s);1===this.anchorList.length&&this._addAnchor(s,n,0),this.anchorOffsetNode.setVisibility(!0)}else this.anchorOffsetNode.setVisibility(!1)},getLocalPosition:function(){if(this.get("AABBox")){var t=this.get("AABBox").getCenter();return new e.Vector3(t.x,t.y,0)}},setItemParent:function(e){this._itemParent&&(this._itemParent.removeEvent("onChange:visible",this._updateVisibility),this._itemParent.removeEvent("onChange:order",this._reload),this._itemParent.removeEvent("onChange:tags",this._tagChanged.bind(this))),this._parent(e),this._updateVisibility(e),this._itemParent&&(this._itemParent.addEvent("onChange:visible",this._updateVisibility,this),this._itemParent.addEvent("onChange:order",this._reload),this._itemParent.addEvent("onChange:tags",this._tagChanged.bind(this)))},_updateVisibility:function(e){void 0!==e&&(e.get("visible")?r.activateRasterSource(this.get("id")):r.deactivateRasterSource(this.get("id")))},_reload:function(){i.deprecateAll("terrain")},_tagChanged:function(){r.unregisterRasterSource(this.get("id")),r.registerRasterSource(this.get("id"),this)}});return t.ObjectContructor.RasterOverlay=p}),define("DS/XCityRendering/RenderingHandlerSky",["DS/XCityRendering/RenderingHandlerSpecific","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityCore/Terrain"],function(e,t,i,r){"use strict";return e.extend({init:function(e){this._parent(e)},getDefaultRendering:function(){var e={cubeMapUrl:"XCityEnvironment/assets/textures/skybox/plaster",cubeMapExt:".png",slabColor:new t.Color("rgb(152,196,233)")};return this.urban._debugVisualOdt&&(e.cubeMapUrl="XCityEnvironment/assets/textures/skybox/pure_grey"),e},getIds:function(){return["Sky"]},applySkyMaterial:function(e){this.urban.getEnvironment().applySkyMaterial(e)}})}),define("DS/XCityEnvironment/Slab",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/XCityTools/ShaderTools","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s,n,a,o){"use strict";var l={uniforms:{skyColor:{type:"c",value:new t.Color},slabSize:{type:"v3",value:new t.Vector3(1,1,0)},slabPosition:{type:"v3",value:new t.Vector3(0,0,0)}},varyings:{vertexPosition:{type:"v3",length:1}},VS_overridableFunctions:{ComputeVaryingValues:["vertexPosition = vGetAttribPosition().xyz;"].join("\n"),ComputeObjectNormal:["return vec3(0.0, 1.0, 0.0);"].join("\n")},FS_overridableFunctions:{ProcessFinalColor:["float _fog = 1.0 - clamp(length(vertexPosition.xy) / length(slabSize.xy), 0.0, 1.0);","vec3 planeColor = _fog * vec3(1.0) + (1.0 - _fog) * skyColor;","if (slabSize.z > 0.0) {","float xShade = abs(vertexPosition.x) - 0.5 * slabSize.x;","float yShade = abs(vertexPosition.y) - 0.5 * slabSize.y;","float _shadowMask = 1.0 - smoothstep(-0.1*slabSize.z, 0.1*slabSize.z, xShade) * smoothstep(-0.1*slabSize.z, 0.1*slabSize.z, yShade);","float _shadowEffect = (1.0 - smoothstep(0.0, 0.5*slabSize.z, xShade)) * (1.0 - smoothstep(0.0, 0.5*slabSize.z, yShade));","float _shadow = 0.8 + 0.2 * log(2.0 - _shadowEffect * _shadowMask) / log(2.0);","planeColor.rgb *= _shadow;","}","ioFinalColor.rgb *= planeColor.rgb;"].join("\n")}},h={varyings:{slabShadow:{type:"v3",length:1}},VS_overridableFunctions:{ComputeVaryingValues:["slabShadow.rgb = vec3(1.0 + 0.5 * vGetAttribPosition().z);"].join("\n"),ComputeObjectNormal:["return vec3(0.0, 1.0, 0.0);"].join("\n")},FS_overridableFunctions:{ProcessFinalColor:["ioFinalColor.rgb *= slabShadow.rgb;"].join("\n")}},d=function(e,s){this._slabNode=new r,this._slabNode.exludeFromBounding(!0),e.USR._rootProjScaled.add(this._slabNode),this._viewpoint=e.getViewpoint();var n=new t.PlaneGeometry(1,1,4,4),d=new t.Mesh(n);d.name="XCityInfinitePlane",this._infPlaneMesh3D=i.createNodeFromTHREEMesh(d),this._infPlaneMesh3D.name="XCityInfinitePlane",this._infPlaneMesh3D.mesh3js.name="XCityInfinitePlane",this._infPlaneMesh3D.setSSAO(!1),this._infPlaneMesh3D.setShadow(!1,!1),this._infPlaneMaterial=a.getPDSFXMaterial([l]),this._infPlaneMaterial.name="XCityInfinitePlane",this._infPlaneMaterial.metalness=0,this._infPlaneMaterial.roughness=1,this._infPlaneMaterial.getPDSFXUniform("skyColor").value.setRGB(.596078431,.768627451,.91372549),this._infPlaneMesh3D.setMaterial(this._infPlaneMaterial),this._infPlanePosition=new t.Vector3(.5,.5,0),this._infPlaneSize=new t.Vector3(100,100,1),this._infPlaneMatrix=new t.Matrix4;var u=new t.CubeGeometry(1,1,1);u.faces.splice(4,2);var c=new t.Mesh(u);c.name="XCitySlabCube",this._slabCubeMesh3D=i.createNodeFromTHREEMesh(c),this._slabCubeMesh3D.name="XCitySlabCube",this._slabCubeMesh3D.mesh3js.name="XCitySlabCube",this._slabCubeMesh3D.setSSAO(!1),this._slabCubeMesh3D.setShadow(!1,!1),this._slabCubeMesh3D.setRenderPasses(["GenericOverlayPass"]),this._slabCubeMaterial=a.getPDSFXMaterial([h]),this._slabCubeMaterial.name="XCitySlabCube",this._slabCubeMaterial.forceSide=!0,this._slabCubeMaterial.side=t.FrontSide,this._slabCubeMaterial.metalness=0,this._slabCubeMaterial.roughness=1,this._slabCubeMesh3D.setMaterial(this._slabCubeMaterial),this._slabPosition=new t.Vector3(.5,.5,0),this._slabSize=new t.Vector3(1,1,0),this._slabCubeMatrix=new t.Matrix4;var p=function(e){void 0!==e.cropBox?(this._slabSize.x=e.cropBox.getSize().x,this._slabSize.y=e.cropBox.getSize().y,this._slabSize.z=.1*Math.max(this._slabSize.x,this._slabSize.y),this._slabPosition.x=e.cropBox.getShiftedCenter().x,this._slabPosition.y=e.cropBox.getShiftedCenter().y,this._slabPosition.z=-this._slabSize.z/2):(this._slabSize.x=e.worldSize,this._slabSize.y=e.worldSize,this._slabSize.z=.1*e.worldSize,this._slabPosition.x=.5*e.worldSize,this._slabPosition.y=.5*e.worldSize,this._slabPosition.z=-this._slabSize.z/2),void 0!==e.slabAltitude&&(this._slabPosition.z+=e.slabAltitude);var t=1e3*this._slabSize.z;this._infPlaneSize.set(t,t,1),this._infPlanePosition.copy(this._slabPosition),this._infPlanePosition.z=-.5*this._slabSize.z,0===this._slabCubeMesh3D.getParents().length&&this._slabNode.add(this._slabCubeMesh3D),m()}.bind(this),f=function(e){this._slabSize.x=1,this._slabSize.y=1,this._slabSize.z=1,this._slabPosition.x=.5,this._slabPosition.y=.5,this._slabPosition.z=0,this._infPlaneSize.x=100,this._infPlaneSize.y=100,this._infPlaneSize.z=1,this._infPlanePosition.x=.5,this._infPlanePosition.y=.5,this._infPlanePosition.z=0,this._slabCubeMesh3D.getParents().length>0&&this._slabNode.remove(this._slabCubeMesh3D),m()}.bind(this),m=function(){this._slabCubeMatrix.identity(),this._slabCubeMatrix.scale(this._slabSize),this._slabCubeMatrix.setPosition(this._slabPosition),this._slabCubeMesh3D.setMatrix(this._slabCubeMatrix),this._infPlaneMatrix.identity(),this._infPlaneMatrix.scale(this._infPlaneSize),this._infPlaneMatrix.setPosition(this._infPlanePosition),this._infPlaneMesh3D.setMatrix(this._infPlaneMatrix);var e=this._infPlaneMaterial.getPDSFXUniform("slabSize");e.value.copy(this._slabSize),e.value.divide(this._infPlaneSize)}.bind(this);o.subscribeTo("/3DEXPERIENCity/onConfig",p),o.subscribeTo("/3DEXPERIENCity/onReset",f)};return d.prototype={setSkyColor:function(e){this._infPlaneMaterial.getPDSFXUniform("skyColor").value.copy(e)},enableInfinitePlane:function(e){e?0===this._infPlaneMesh3D.getParents().length&&this._slabNode.add(this._infPlaneMesh3D):this._infPlaneMesh3D.getParents().length>0&&this._slabNode.remove(this._infPlaneMesh3D)}},d}),define("DS/XCityRendering/RenderingHandlerGeometricTerrain",["DS/XCityRendering/RenderingHandlerModel","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return e.extend({init:function(e){this._parent(e),this.type="GeometricTerrain"},getDefaultRendering:function(){return{showOcean:!1,oceanAlpha:1,oceanRangeDetection:.0625,oceanColorDetection:new t.Color("rgb(0,64,102)"),oceanTexture:null,oceanTextureUrl:"XCityEnvironment/assets/textures/ocean/waterNormalsn.jpg",oceanColor:new t.Color("rgb(47,64,71)"),mapUrl:"XCityEnvironment/assets/textures/hdroad/t_atlasF.jpg",mapParams:{minFilter:t.NearestMipMapNearestFilter,magFilter:t.NearestMipMapNearestFilter,wrapS:t.RepeatWrapping,wrapT:t.RepeatWrapping}}},onTextureApplied:function(e,t,i,r){if(r&&"map"===r.param){var s=this.getCompleteMaterialInfo();if(e&&s.mapParams)for(var n in s.mapParams)e[n]=s.mapParams[n]}}})}),define("DS/XCityModel/Terrain",["DS/Visualization/ThreeJS_DS","DS/XCityModel/Item","DS/XCityModel/Content","DS/XCityCore/Store","DS/XCityCore/Terrain","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerGeometricTerrain","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s,n,a,o,l){"use strict";var h=function(e,t){var i=a.cloneQuad(t);return"geometricMode"!==e.get("sourceMode")&&i.LOD>e.get("levelMax")&&(i.I=i.I>>i.LOD-e.get("levelMax"),i.J=i.J>>i.LOD-e.get("levelMax"),i.LOD=e.get("levelMax"),i.key=void 0),e.get("yTopToBottom")&&(i.J=(1<<i.LOD)-1-i.J,i.key=void 0),void 0===i.key&&(i.key=a.getQuadKey(i.LOD,i.I,i.J)),i},d=i.extend({defaults:{levelMin:0,levelMax:-1,levelMaxVisu:99999,priority:3,cache:50,AABBox:null,url:"",sourceMode:"raster",border:0,res:1,yTopToBottom:!1,statistics:null,loadInfo:{loaded:1,total:1}},metaData:{type:"Terrain",className:"Terrain"},loaderJSON:{AABBox:"loadJSONAABox"},setup:function(){this._parent()},create:function(t){if(!this._parent(t))return!1;this._partial=[],this._complete=[],this._attributes.loadInfo.loaded=1,this._attributes.loadInfo.total=1;var i=function(){-1===r.getStoreList().indexOf(this.get("url"))&&(r.deleteStore(this.previous("url")),this.get("url").search("%xmin")>-1&&this.get("url").search("%xmax")>-1&&this.get("url").search("%ymin")>-1&&this.get("url").search("%ymax")>-1?r.createStore(this.get("url"),{url:this.get("url"),cacheSize:this.get("cache"),priority:this.get("priority"),floatTexture:{width:this.get("res"),height:this.get("res")},wms:{worldSize:t._urban.worldSize,shiftedPosition:t._urban.shiftedPosition},onFinish:{func:this._onFinish.bind(this),bound:this}}):(r.createStore(this.get("url"),{url:this.get("url"),cacheSize:this.get("cache"),priority:this.get("priority"),floatTexture:{width:this.get("res"),height:this.get("res")},tile:!0,onFinish:{func:this._onFinish.bind(this),bound:this}}),this.updateStatistics()),r.deprecateAll("terrain"))}.bind(this),n=function(){-1===r.getStoreList().indexOf(this.get("url"))&&(r.deleteStore(this.previous("url")),this.get("url").search("%xmin")>-1&&this.get("url").search("%xmax")>-1&&this.get("url").search("%ymin")>-1&&this.get("url").search("%ymax")>-1?r.createStore(this.get("url"),{url:this.get("url"),cacheSize:this.get("cache"),priority:this.get("priority"),streamvisu:!0,rendering:this._rendering,wms:{worldSize:t._urban.worldSize,shiftedPosition:t._urban.shiftedPosition},onFinish:{func:this._onFinish.bind(this),bound:this}}):r.createStore(this.get("url"),{url:this.get("url"),cacheSize:this.get("cache"),priority:this.get("priority"),streamvisu:!0,rendering:this._rendering,tile:!0,onFinish:{func:this._onFinish.bind(this),bound:this}}),r.deprecateAll("terrain"))}.bind(this);if(this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this.isGeometric()){this._rendering=new o(t._urban),this.renderingProfileManager=t._urban.getRenderingProfileManager(),this.renderingProfileManager.initRendering(this),this.renderingProfileManager.addRendering("3DXCityGeometricTerrain",{showOcean:s._isOceanEnabled()});var a=this.renderingProfileManager.getProfile("Underground");Utils.is(a)||(a=this.renderingProfileManager.createProfile("Underground"));a.addRendering(this.parentFeatureID,{opacity:.3}),n(),this.addEvent("onChange:url",n),this.loadResource("landuse_atlas.jpg")}else{i(),this.addEvent("onChange:url",i),this._dtmProperties=new e.Vector4(0);var l=function(){this._dtmProperties.setX(1/this.get("res")),this._dtmProperties.setY(1/this.get("res")),this._dtmProperties.setZ(this.get("border")*this._dtmProperties.x),this._dtmProperties.setW(this.get("border")*this._dtmProperties.y)}.bind(this);l(),this.addEvent("onChange:res",l),this.addEvent("onChange:border",l)}return s.registerTerrainSource(this.get("id"),this),this._updateVisibility(this.getItemParent()),!0},_onFinish:function(e){l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:e,item:this.getItemParent()})},destroy:function(e){s.deactivateTerrainSource(this.get("id")),s.unregisterTerrainSource(this.get("id"));var t=!0;e.traverse(function(e){e.get("Content")&&e.get("Content").get("url")&&e.get("Content").get("id")!==this.get("id")&&e.get("Content").get("url")===this.get("url")&&(t=!1)}.bind(this),!0),t&&r.deleteStore(this.get("url"),!0),this._parent(e)},isGeometric:function(){return-1!==this.get("sourceMode").indexOf("geometric")},isHD:function(){return-1!==this.get("sourceMode").indexOf("HD")},acceptTile:function(e){if(e.LOD<this.get("levelMin")||e.LOD>this.get("levelMaxVisu"))return!1;if(a.is(this.get("AABBox"))){var t={};if(this.get("AABBox").getIJBox(e.LOD,t),e.I<t.IMin||e.I>t.IMax)return!1;if(e.J<t.JMin||e.J>t.JMax)return!1}var i=void 0;if(e.LOD<=this.get("levelMax")){if(!(i=this._complete.indexOf(e.key)>-1)&&-1===this._partial.indexOf(e.key)){i=void 0;for(var r={LOD:e.LOD,I:e.I,J:e.J,key:0},s=!1,n=!1,o=e.LOD;o>=0&&(r.I=r.I>>1,r.J=r.J>>1,--r.LOD,r.key=a.getQuadKey(r.LOD,r.I,r.J),!(n=this._complete.indexOf(r.key)>-1));--o);n&&(i=!0)}}else{for(r={LOD:e.LOD,I:e.I,J:e.J,key:0},s=!1,n=!1,o=e.LOD;o>=0&&(r.I=r.I>>1,r.J=r.J>>1,--r.LOD,r.key=a.getQuadKey(r.LOD,r.I,r.J),s=this._partial.indexOf(r.key)>-1,!(n=this._complete.indexOf(r.key)>-1)&&!s);--o);n?i=!0:s&&(i=!1)}return{valid:!0,complete:i}},acceptStrictTile:function(e){if(e.LOD<this.get("levelMin")||e.LOD>this.get("levelMax"))return!1;if(a.is(this.get("AABBox"))){var t={};if(this.get("AABBox").getIJBox(e.LOD,t),e.I<t.IMin||e.I>t.IMax)return!1;if(e.J<t.JMin||e.J>t.JMax)return!1}return!0},cancelTile:function(e){if(!this.isGeometric()){var t=h(this,e);t.LOD===e.LOD&&r.cancelDownloadData(this.get("url"),t.key)}},updateTile:function(e){var t=h(this,e);r.updateTimestampData(this.get("url"),t.key)},getTile:function(e){var t=h(this,e);return r.getData(this.get("url"),t.key)},downloadTile:function(e,t,i,s,n){var o=function(e,t,i,r,s,n){if(206===n?-1===this._partial.indexOf(s)&&this._partial.push(s):200===n&&-1===this._complete.indexOf(s)&&this._complete.push(s),void 0!==i){var a=Array.prototype.slice.call(arguments,4);a.unshift(e,t),i.apply(r,a)}this._incrementLoadedItems()};if(!this.isGeometric()){m={tile:h(this,e),priority:i,undeletable:t.undeletable};var l=r.getData(this.get("url"),m.tile.key);if(!a.is(l)&&(t.isVisible&&(this._incrementTotalItems(),(f=Array.prototype.slice.call(arguments,3)).unshift(this.get("url"),m.tile.key,m,o,this),r.getOrDownloadData.apply(r,f)),t&&t.canUseParent))for(var d=this.get("levelMin"),u=m.tile.LOD,c=m.tile.I,p=m.tile.J;!a.is(l)&&u>d;)u-=1,c>>=1,p>>=1,r.getData(this.get("url"),a.getQuadKey(u,c,p));return l}if(this.acceptStrictTile(e)){var f,m={tile:h(this,e),priority:i,undeletable:t.undeletable},g=r.getData(this.get("url"),m.tile.key);return a.is(g)||t.isVisible&&(this._incrementTotalItems(),(f=Array.prototype.slice.call(arguments,3)).unshift(this.get("url"),m.tile.key,m,o,this),r.getOrDownloadData.apply(r,f)),g}},_incrementTotalItems:function(){var e={loaded:this.get("loadInfo").loaded,total:this.get("loadInfo").total+1};this.set("loadInfo",e)},_incrementLoadedItems:function(){var e={loaded:this.get("loadInfo").loaded+1,total:this.get("loadInfo").total};this.set("loadInfo",e)},applyDTM:function(t,i){var s=t.getPDSFXUniform("dtm");if(a.is(s)){var n,o,l,d,u,c,p,f;a.is(s.value)&&(f=s.value,r.unlock(f.storeId,f.storeKey),t.updatePDSFXUniform("dtm",void 0)),p=h(this,i),f=r.getData(this.get("url"),p.key);p.key;if(a.is(f))l=i.LOD-p.LOD;else{for(n=this.get("levelMin"),o=p.LOD,u=p.I,c=p.J;!a.is(f)&&o>n;)o-=1,u>>=1,c>>=1,f=r.getData(this.get("url"),a.getQuadKey(o,u,c));l=i.LOD-o}if(a.is(f)){t.updatePDSFXUniform("dtm",f),t.updatePDSFXUniform("dtmProperties",this._dtmProperties.clone()),r.lock(f.storeId,f.storeKey),d=1<<l,u=i.I>>l,c=i.J>>l,t.updatePDSFXUniform("dtmOffset",new e.Vector4(i.I/d-u,i.J/d-c,1/d,Math.max(f.bounds.max-f.bounds.min,1))),(g=t.getPDSFXUniform("dtmAltitudes")).value.setW((f.bounds.max+f.bounds.min)/2),g.value.setY(f.bounds.min-25),t.updatePDSFXUniform("dtmAltitudes",g.value),(m=t.getPDSFXUniform("terrainDebug")).value.setZ(0),t.updatePDSFXUniform("terrainDebug",m.value)}else{var m;(m=t.getPDSFXUniform("terrainDebug")).value.setZ(1),t.updatePDSFXUniform("terrainDebug",m.value);var g,v=t.getPDSFXUniform("dtmOffset");v.value.setW(1),t.updatePDSFXUniform("dtmOffset",v.value),(g=t.getPDSFXUniform("dtmAltitudes")).value.setW(0),g.value.setY(-25),t.updatePDSFXUniform("dtmAltitudes",g.value)}t.force=!0}},getLocalPosition:function(){if(this.get("AABBox")){var t=this.get("AABBox").getCenter();return new e.Vector3(t.x,t.y,0)}},setItemParent:function(e){this._itemParent&&(this._itemParent.removeEvent("onChange:visible",this._updateVisibility),this._itemParent.removeEvent("onChange:order",this._reload)),this._parent(e),this._updateVisibility(e),this._itemParent&&(this._itemParent.addEvent("onChange:visible",this._updateVisibility,this),this._itemParent.addEvent("onChange:order",this._reload))},redraw:function(){if(this.isGeometric()){this.getRendering();s.redrawGeometricTiles(this)}},getRendering:function(){return this._rendering},_updateVisibility:function(e){e.get("visible")?s.activateTerrainSource(this.get("id")):s.deactivateTerrainSource(this.get("id"))},_reload:function(){r.deprecateAll("terrain")},setStatistics:function(e){var t=e.geoItemTypeList.GridRelief.altitude,i={maximalAltitude:t.max,minimalAltitude:t.min};this.set("statistics",i)}});return t.ObjectContructor.Terrain=d}),define("DS/XCityRendering/RenderingProfileManager",["DS/XCityCore/ProfileManager","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/xCityBasicUtils/Utils","DS/XCityCore/Terrain","DS/XCityTools/EventDispatcher","DS/XCityRendering/RenderingProfile","DS/XCityRendering/Rendering"],function(e,t,i,r,s,n,a,o){"use strict";return e.extend({init:function(e){this._parent(e,"rendering"),this.defaultProfile="UrbanDefault",this.defaultNewProfile="renderingProfile",this.SkyId="Sky",this.GroundId="Ground";var t=this.getProfile(this.defaultProfile);r.is(t)||((t=this.createProfile(this.defaultProfile)).setAsInternal(!0),this.dispatchAddedEvent(this.defaultProfile)),this.addProfile(t.getName(),t.resetRender,t,"RenderingGroup"),t._materials={},t._materials[0]=null,this._initSessionProfile()},_initEnvironment:function(e){var t=this.getDefaultProfile();t._parseEffects({name:t.getName()},e)},_initSessionProfile:function(){this.sessionProfileName="defaultProfile",this._sessionProfile=this.getProfile(this.sessionProfileName),r.is(this._sessionProfile)||(this._sessionProfile=this.createProfile(this.sessionProfileName),this._sessionProfile.setAsRemovable(!1),this._sessionProfile.setAsDeactivable(!1),this.dispatchAddedEvent(this.sessionProfileName)),this.addProfile(this._sessionProfile.getName(),this._sessionProfile.setRender,this._sessionProfile,"RenderingGroup")},dispatchAddedEvent:function(e){n.publish(n.eventsList.renderingProfileAdded,e)},dispatchRemovedEvent:function(e){n.publish(n.eventsList.renderingProfileRemoved,e)},_getSessionProfile:function(){return this._sessionProfile},getProfileNames:function(){return this._parent()},_getSky:function(){return this._urban.getEnvironment().sky},setProfile:function(e,t){e!==this.getCurrentProfileName()&&(e!==this.defaultProfile&&this._parent(this.defaultProfile),this._parent(e,t)&&n.publish(n.eventsList.renderingProfile,e))},_parseOneProfile:function(e){var t=this.getProfile(e.name),i=!1;r.is(t)||(t=this.createProfile(e.name),i=!0),t._parseEffects(e,this._urban.getEnvironment()),t._parseConfig(e),t._parseRendering(e),i&&this.dispatchAddedEvent(e.name)},_getGeometry:function(e){var t=null;if(e===this.SkyId)t=this._getSky();else{this._urban.modelRoot.traverse(function(i){var s=i.id;if(s&&e===s){var n=i.get("Content");r.is(n)&&r.is(n.getRendering)&&(t=n)}},!0)}return r.is(t)?t:null},_createProfile:function(e,t){return new a(e,t)},getAllRenderIds:function(){var e,t=[];if(r.is(this._generics)){var i=Object.keys(this._generics);for(e=0;e<i.length;e++)t.push(i[e])}return t},getAllNamesandIds:function(){var e={};this._urban.modelRoot.traverse(function(e,t){var i=e.id,s=e.get("name");if(i&&s&&!r.is(t[s])){var n=e.get("Content");if(r.is(n)&&r.is(n.getRendering)){var a=n.getRendering();r.is(a)&&(t[s]=i)}}},!0,e);var t=e;return t[this.GroundId]=this.GroundId,t},_updateRenderID:function(e){var t=this.getCurrentProfile(),i=e.getRendering();r.is(i)&&i.setContent(e);var s=e.get("renderID");if(r.is(s)&&""!==s&&this.addGenericMap(e.id,s),r.is(t)){var n=t.getReferencedId(e);if(r.is(n)){var a=t._ids[n].materialIndex;t._materials[a],this.setRender(t._ids,t._materials)}}},initRendering:function(e){if(r.is(e)){var t=e.get("id");t!==this.SkyId&&t!==this.GroundId||console.warn("Id "+t+" is reserved, its use could present rendering problems ");var i=e.getRendering();r.is(i)&&i.setContent(e),e.fromGeometrySet&&"FactoryLine"===e._factory._node.name?e._itemParent.getContent().addEvent("onChange:renderID",this.updateFeatureRendering.bind(this),e._itemParent.getContent()):(e.addEvent("onChange:renderID",this.updateFeatureRendering.bind(this),e),e.addEvent("onChange:id",this.updateFeatureRendering.bind(this),e)),this.updateFeatureRendering(e)}},addGenericMap:function(e,t){r.is(this._generics)||(this._generics={}),r.is(this._generics[t])||(this._generics[t]=[]),r.is(e)&&this._generics[t].push(e)},getRenderingProfileAndId:function(e,t,i){var s;if(r.is(t)&&""!==t&&!r.is(i)){if(s=this.getStylingProfile(),!r.is(s))return;e=t}else if(s=this._getSessionProfile(),!r.is(s))return;return{profile:s,featureId:e}},addRendering:function(e,t,i,r){let s=this.getRenderingProfileAndId(e,r,i);return s.profile.addRendering(s.featureId,t,i)},addFilterRendering:function(e,t,i,r){let s=this.getRenderingProfileAndId(e,r);return s.profile.addFilterRendering(s.featureId,t,i)},addDatavizRendering:function(e,t,i){let r=this.getRenderingProfileAndId(e,i);return r.profile.addDatavizRendering(r.featureId,t)},updateDatavizRendering:function(e,t,i,r,s,n){this.getRenderingProfileAndId(e,n).profile.updateDatavizRendering(t,i,r,s)},deleteDatavizRendering:function(e,t,i){this.getRenderingProfileAndId(e,i).profile.deleteDatavizRendering(t)},addPrimitiveRenderingNoDraw:function(e,t,i){var s=this._getSessionProfile();r.is(s)&&s.addOnlyRendering(e,t,i)},renameProfile:function(e,t){this._parent(e,t)&&n.publish(n.eventsList.renderingProfile,t)},setDefaultProfile:function(){return this.setProfile(this.getDefaultProfile().getName())}})}),define("DS/XCityRendering/RenderingManager",["DS/XCityRendering/RenderingProfileManager","DS/xCityBasicUtils/Utils","DS/XCityTools/LayerList","DS/XCityRendering/FeatureRendering","DS/XCityRendering/PrimitiveRendering","DS/XCityCore/Terrain","DS/XCityModel/LayerVectorPrimitive","DS/XCityRendering/SLDParser","DS/XCityTools/EventDispatcher","DS/XCityTools/OGCFilter"],function(e,t,i,r,s,n,a,o,l,h){"use strict";return e.extend({init:function(e){this._parent(e),this.HeatMapToolId="3DXCityHeatMapTool",this._IdstoUpdate={}},setRender:function(e){this.addToIdstoUpdate(e),this.renderScene(this._IdstoUpdate),this._IdstoUpdate={}},addToIdstoUpdate:function(e){if(t.is(e)){var i,r,s,n;if("string"==typeof e)i=e,(e={})[i]=!0;else if(Array.isArray(e)){for(r=e.length,i={},s=0;s<r;s++)i[n=e[s]]=!0;e=i}var a=Object.keys(e);for(r=a.length,s=0;s<r;s++)n=a[s],this._IdstoUpdate[n]=!0}},resetRender:function(e){this.setRender(e)},renderScene:function(e){var i=this.getGeomFromIds(e);t.is(i)&&i.length>0&&(this.updateGeomRenderings(i),this.redrawGeoms(i))},getIdFromGeom:function(e){if(t.is(e)){if(t.is(e.id))return e.id;if(e===this.getGroundGeom())return this.GroundId;if(e===this.getSkyGeom())return this.SkyId}},redrawGeoms:function(e){var t,i,r=e.length,s={};for(t=0;t<r;t++){i=e[t],s[this.getIdFromGeom(i)]=i,i.redraw(),l.publish("/xCity/needRender",this)}},getActiveRenderingsForGeoms:function(e,i=[]){for(var s=this.getOrderedIdsFromGeoms(e),n=[],a=i&&i.length>0?i:this.getActiveProfiles(),o=0;o<s.length;o++){for(var l=s[o],h=new r,d=0;d<a.length;d++){var u=a[d],c=this.getCurrentRenderingForOneProfile(l,u);t.is(c)&&(h._priorityClean(c.getRenderingData()),h.addOver(c))}n.push(h)}return n},getGeomFromIds:function(e){var i=[];this.getNonDataModelGeoms(e,i);return this._urban.modelRoot.traverse(function(e,r){var s=e.get("Content");if(t.is(s)&&!(s instanceof a)){var n=!1;if(t.is(s.getRendering)){var o=s.getRendering();if(t.is(o)){var l,h=o.getIds(),d=h.length;for(l=0;l<d;l++){var u=h[l];if(t.is(r[u])){n=!0;break}}}}else{var c=e.id;c&&t.is(r[c])&&(n=c);var p=s.id;if(p&&!n&&t.is(r[p])&&(n=p),!n){var f=s.get("renderID");t.is(f)&&""!==f&&t.is(r[f])&&(n=f)}}n&&i.push(s)}},!0,e),i},getNonDataModelGeoms:function(e,t){this.getGroundAndSkyGeoms(e,t),this.getHeatMapGeom(e,t)},getHeatMapGeom:function(e,i){var r;t.is(e[this.HeatMapToolId])&&(r=this.getHeatMapGeometry(),t.is(r)&&i.push(r))},getGroundAndSkyGeoms:function(e,i){var r;t.is(e[this.GroundId])&&(r=this.getGroundGeom(),t.is(r)&&i.push(r)),t.is(e[this.SkyId])&&(r=this.getSkyGeom(),t.is(r)&&i.push(r))},getHeatMapGeometry:function(){return this._heatMapGeom},getGroundGeom:function(){return n},getSkyGeom:function(){return this._urban.getEnvironment().sky},getOrderedIdsFromGeoms:function(e){var t,i,r=[],s=e.length;for(t=0;t<s;t++)i=e[t].getRendering(),r[t]=i.getIds();return r},getIdsFromGeom:function(e){var t,i,r,s,n={},a=e.length;for(t=0;t<a;t++)for(r=(i=e[t].getRendering().getIds()).length,s=0;s<r;s++)n[i[s]]=!0;return n},getActiveRenderingsFromIds:function(e){var t,i,r={},s=Object.keys(e),n=s.length;for(t=0;t<n;t++)r[i=s[t]]=this.getCurrentRenderingForOneId(i);return r},getCurrentRenderingForOneId:function(e){var i,s,n=new r,a=this.getActiveProfiles(),o=a.length;for(i=0;i<o;i++)s=a[i],t.is(s)&&s.getRenderingForId(e,n);return n},getCurrentRenderingForOneProfile:function(e,t){var i,s,n=e.length,a=new r;for(s=n-1;s>=0;s--)i=e[s],t.getRenderingForId(i,a);return a},combineRenderingForGeom:function(e,t){var i,r,s=[],n=e.length;for(i=0;i<n;i++)r=e[i].getRendering().getIds(),s.push(this.getRenderingFromIdList(r,t));return s},getRenderingFromIdList:function(e,i){var s,n,a=e.length,o=new r;for(s=a-1;s>=0;s--)n=i[e[s]],t.is(n)&&o.addOver(n);return o},setOIT:function(e){this._oitStatus=e;var t=this._urban.getView3D();void 0===t.ugVisu||"WINDOW"!==t.ugVisu.mode_&&!t.ugVisu.selecting_window_?t.setOIT(e):t.setOIT(!1)},applyOIT:function(){t.is(this._oitStatus)&&this.setOIT(this._oitStatus)},handleOITActivation:function(e,r){var s,n,a,o=r.length;for(t.is(this._OITList)||(this._OITList=new i,this._OITList.setEmptyCallbacks(this.setOIT.bind(this,!1),this.setOIT.bind(this,!0))),s=0;s<o;s++)a=e[s],n=r[s].get("opacity"),t.is(n)&&(n<=.99?this._OITList.addlayerToList(a):this._OITList.removeLayerFromList(a));this.applyOIT()},updateGeomRenderings:function(e){var t=this.getActiveRenderingsForGeoms(e);this.handleOITActivation(e,t);var i,r,s,n,a=e.length;for(i=0;i<a;i++)if(r=e[i],s=t[i],(n=r.getRendering()).updateRendering(s),n.hasPrimitiveRendering()){var o=n.getPrimitiveRenderings();r.registerPrimitives(o)}},getProfileRenderingData:function(e,t){return this.getCurrentRenderingForOneId(e).getCompleteMaterialInfo(t)},getRenderingData:function(e,i){var r=this._getGeometry(e);if(!t.is(r))return this.getProfileRenderingData(e,i);if(t.is(r.getRendering)){var s=r.getRendering();if(t.is(s))return s.getCompleteMaterialInfo(i)}},renderPrimitive:function(e,i){var r=this._getGeometry(e);if(t.is(r)){var s=r.getRendering();if(t.is(s)){var n=this.getCurrentRenderingForPrimitive(e,i);s.updatePrimitiveRendering(n),r.redrawPrimitive(i)}}else console.log("Feature does not exist yet for this primitiverendering")},getCurrentRenderingForPrimitive:function(e,i){var r=new s;r.addOverIds(i);var n,a,o=this.getActiveProfiles(),l=o.length;for(n=0;n<l;n++)a=o[n],t.is(a)&&a.getRenderingForPrimitive(e,i,r);return r},updateFeatureRendering:function(e){var i=e.getRendering();if(t.is(i)){var r=e.get("renderID");t.is(r)&&""!==r&&this.addGenericMap(e.id,r),i.setContent(e);var s=[e];this.updateGeomRenderings(s),this.redrawGeoms(s)}},initGroundRendering:function(e){var i=e.getRendering();t.is(i)&&i.setContent(e)},resetPrimitive:function(e,i){var r=this.getTopProfile(),s=!1;return t.is(r)&&(s=r._resetRendering(e,i)),s},resetPrimitiveAttributeOnly:function(e,i,r){var s=this.getTopProfile(),n=!1;return t.is(s)&&(n=s._resetPrimitiveAttribute(e,i,r)),n},resetAttributeOnly:function(e,i){var r=this.getTopProfile(),s=!1;return t.is(r)&&(s=r._resetLayerAttribute(e,i)),s},_parseSLD:function(e,t,i){var r=(new o).parseSLD(e,i);this.getResourceProfile().addSLDRenderings(t,r)},_parseSLDInfos:function(e,i,r){var s,n,a,l=JSON.parse(e),h={};if(!(t.is(l)&&Array.isArray(l)&&l.length>0))throw new Error("JSON is not an array");for(a=0;a<1;a++){var d=l[a];d.geoItemSourceUuid;s=d.content,n=(new o).parseSLD(s,r),h=Object.assign(h,n)}this.getResourceProfile().addSLDRenderings(i,h)},getResourceProfile:function(){return t.is(this._resourceProfile)||this._initResourceProfile(),this._resourceProfile},_initResourceProfile:function(){this._resourceProfileName="3DXCityResourceProfile",this._resourceProfile=this.createProfile(this._resourceProfileName),this._resourceProfile.setAsInternal(!0),this.dispatchAddedEvent(this._resourceProfileName),this.addProfile(this._resourceProfile.getName(),this._resourceProfile.setRender,this._resourceProfile,"RenderingGroup"),this._resourceProfile.enable()},getActiveProfiles:function(){var e=[],i=this.getDefaultProfile(),r=this.getCurrentProfile(),s=this.getSessionProfile(),n=this.getStylingProfile();e.push(i),t.is(this._resourceProfile)&&e.push(this._resourceProfile);var a=!1;if(t.is(r)){var o=r.getName();o!==i.getName()&&o!==s.getName()&&o!==n.getName()&&(r.isTemporary()?a=!0:e.push(r))}return s.isEnabled()&&e.push(s),n.isEnabled()&&e.push(n),a&&e.push(r),e},newgetActiveProfiles:function(){var e,t,i,r,s,n,a=Object.keys(this._profiles),o=[];for(e=0;e<a.length;e++)if(r=a[e],(i=this._profiles[r]).isEnabled())if(o[s=i.level]||(o[s]=[],o[s].push(i)),n)for(t=0;t<n.length;t++)n[t]>s&&n.splice(t,0,s);else n=[s];var l=[];for(e=0;e<n.length;e++)l.push(o[n[e]]);return l},_initSessionProfile:function(){this._parent(),this._defaultRenderingProfileName=this.sessionProfileName,this._defaultRenderingProfile=this._sessionProfile,this.sessionProfileName="sessionProfile",this._sessionProfile=this.getProfile(this.sessionProfileName),t.is(this._sessionProfile)||(this._sessionProfile=this.createProfile(this.sessionProfileName),this._sessionProfile.setAsRemovable(!1),this._sessionProfile.setAsDeactivable(!1),this.dispatchAddedEvent(this.sessionProfileName)),this.addProfile(this._sessionProfile.getName(),this._sessionProfile.setRender,this._sessionProfile,"RenderingGroup"),this._sessionProfile._enabled=!0,this._initStylingProfile()},_initStylingProfile:function(){this._parent(),this.stylingProfileName="stylingProfile",this._stylingProfile=this.getProfile(this.stylingProfileName),t.is(this._stylingProfile)||(this._stylingProfile=this.createProfile(this.stylingProfileName),this._stylingProfile.setAsRemovable(!1),this._stylingProfile.setAsDeactivable(!1),this.dispatchAddedEvent(this.stylingProfileName)),this.addProfile(this._stylingProfile.getName(),this._stylingProfile.setRender,this._stylingProfile,"RenderingGroup"),this._stylingProfile._enabled=!0,this._stylingProfile.setAsTemporary(!0)},getDefaultProfile:function(){return this._defaultRenderingProfile},_getSessionProfile:function(){return this._sessionProfile},getSessionProfile:function(){return this._getSessionProfile()},getStylingProfile:function(){return this._stylingProfile||this._initStylingProfile(),this._stylingProfile},getTopProfile:function(){return this.getSessionProfile()},resetAllPrimitivesRendering:function(e,i){if(t.is(e)){var r=this.getSessionProfile();t.is(r)&&r.resetAllPrimitivesRendering(e,i),this.resetRenderPrimitives(e)}},resetRenderPrimitives:function(e){this.addToIdstoUpdate(e);var t=this.getGeomFromIds(this._IdstoUpdate);this.resetGeomFlags(t),this.redrawGeoms(t)},rebuildGeomRenderings:function(e){var t,i=e.length;for(t=0;t<i;t++)e[t].getRendering().flagAsRebuilt(!1)},resetGeomFlags:function(e){var i,r,s=e.length;for(i=0;i<s;i++)r=e[i],t.is(r.resetFlags)&&r.resetFlags()},getActiveRenderingProfilesNames:function(){var e,t=this.getActiveProfiles(),i=[],r=t.length;for(e=0;e<r;e++)i.push(t[e].getName());return i},addStyleToResource:function(e,t){var i=this.getResourceProfile(),r=Object.assign({Ids:e},t);i._parseOneRenderingGroup(r)},resetRenderingAttribute:function(e,t){this.resetAttributeOnly(e,t),this.setRender([e])},getActiveRenderingsForGeomByProfile:function(e){for(var i=e.getRendering().getIds(),r=null,s=[],n=this.getActiveProfiles(),a=0;a<n.length;a++){var o=n[a],l=this.getCurrentRenderingForOneProfile(i,o);if(t.is(l)){for(var h=l.getRenderingData(),d=0;d<a;d++){var u=s[d];u&&u._priorityClean(h)}s.push(l),r||(r={}),r[o.getName()]=l}}return r},getCurrentRenderingForPrimitiveByProfile:function(e,i){var r,n,a,o=e.getRendering().getIds(),l=this.getActiveProfiles(),h=l.length,d=null;for(r=0;r<h;r++)if(a=l[r],t.is(a)){for(n=o.length-1;n>=0;n--){var u=o[n],c=new s;c.addOverIds(i),a.getRenderingForPrimitive(u,i,c)}d||(d={}),d[a.getName()]=c}return d},emptyRendering:function(e){var t=this.getStylingProfile();t.emptyRendering(e),(t=this.getSessionProfile()).emptyRendering(e)}})}),define("DS/XCityEnvironment/CubeMap",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/EventDispatcher","DS/XCityRendering/RenderingHandlerSky","DS/XCityCore/Terrain"],function(e,t,i,r,s,n,a,o,l,h){"use strict";var d={uniforms:{skyColor:{type:"c",value:new e.Color},envMapSky:{type:"tc",value:a.whiteMap},useEnvMapSky:{type:"b",value:!1}},varyings:{pos3d:{type:"v3v",length:0}},VS_overridableFunctions:{ComputeVaryingValues:["pos3d = vGetAttribPosition();"].join("\n")},FS_overridableFunctions:{ProcessFinalColor:["ioFinalColor.rgb = skyColor.rgb;","if (useEnvMapSky) { ioFinalColor.rgb *= textureCube( envMapSky, vec3(-pos3d.x, pos3d.zy) ).xyz; }"].join("\n")}},u=function(r,n){this._urban=r,this._skyNode=new i,this._skyNode.exludeFromBounding(!0),this._viewpoint=r.getViewpoint(),this._viewer=r.USR.webGLV6Viewer;var h=new e.CubeGeometry(1,1,1),u=new e.Mesh(h);u.name="XCitySkyBox",u.frustumCulled=!1,u.geometry.dynamic=!0,u.renderDepth=-Number.MAX_VALUE,u.depthWrite=!1,this._skyBoxMesh3D=t.createNodeFromTHREEMesh(u),this._skyBoxMesh3D.name="XCitySkyBox",this._skyBoxMesh3D.setPickable(s.NODRAWHL),this._skyBoxMesh3D.setShadow(!1,!1),this._skyBoxMesh3D.setSSAO(!1),this._skyNode.add(this._skyBoxMesh3D),this._skyboxMaterial=a.getPDSFXMaterial([d]),this._skyboxMaterial.name="XCitySkyBox",this._skyboxMaterial.side=e.BackSide,this._skyboxMaterial.forceSide=!0,this._skyBoxMesh3D.setMaterial(this._skyboxMaterial),this._skyboxMatrix=new e.Matrix4;var c=function(){var t,i;t=this._viewpoint.getCamera().far,i=this._viewpoint._getPositionRelative(),this._skyboxMatrix.identity(),this._skyboxMatrix.scale(new e.Vector3(t,t,t)),this._skyboxMatrix.setPosition(i),this._skyBoxMesh3D.setMatrix(this._skyboxMatrix)}.bind(this);o.subscribeTo("/3DEXPERIENCity/onPostUpdate",c),this._skyColor=new e.Color,this.setSkyColor((new e.Color).setRGB(.596078431,.768627451,.91372549)),this._rendering=new l(r),this._iblReady=!1};return u.prototype={initDefaultSky:function(){this._urban.getRenderingProfileManager().addRendering("Sky",this._rendering.getDefaultRendering())},setSkyColor:function(e){this._skyColor.copy(e),this._skyboxMaterial.getPDSFXUniform("skyColor").value.copy(this._skyColor)},getSkyColor:function(){return this._skyColor.clone()},getCubeMap:function(){return this._skyboxMaterial.getPDSFXUniform("envMapSky").value},setCubeMap:function(t){n.is(t)?(this._viewer.ambience.setBackGroundMap({texture:t,mapping:new e.LatLongEnvMapping,pngHdr:!0}),this._viewer.ambience.setIblMap({texture:t,mapping:new e.LatLongReflectionMapping,pngHdr:!0}),this._viewer.ambience.setRoughnessMap({texture:t._rmips,mapping:new e.LatLongReflectionMapping,pngHdr:!0}),this._iblReady=!0):(this._viewer.ambience.setBackGroundMap({texture:a.whiteMap,mapping:new e.LatLongEnvMapping,pngHdr:!1}),this._viewer.ambience.setIblMap({texture:a.whiteMap,mapping:new e.LatLongReflectionMapping,pngHdr:!0}),this._viewer.ambience.setRoughnessMap({texture:null,mapping:new e.LatLongReflectionMapping,pngHdr:!0}))},getRendering:function(){return this._rendering},redraw:function(){var e=this.getRendering(),t=e.getFeatureRendering().getRenderingData();e.applySkyMaterial(t)}},u}),define("DS/XCityRendering/RenderingHandlerPOI3DBillboardAlignedLabel",["DS/XCityRendering/RenderingHandlerPOI3DBillboard","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/XCityRendering/PrimitiveRendering","DS/Visualization/ThreeJS_DS","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering","DS/XCityTools/TextureManager","DS/XCityRendering/FeatureRendering","DS/XCityTools/TextureTools"],function(e,t,i,r,s,n,a,o,l,h,d){"use strict";return e.extend({init:function(e,t,i){this._parent(e,t,i),this.enableAtlasing=!0,this.type="POI3DBillboardAlignedLabel"},addDefaultDatavizMapping:function(){},startFontAtlas:function(e){if(!t.is(this._fontAtlas)){for(var i=" WXCVBNPOIUYTREZAQSDFGHJKLM'-azertyuiop^$*mlkjhgfdsq<wxcvbn_,;:!1234567890+%/.?<~{[|`^@]} &'(-)=",r=Object.assign({},e),s={},n=0;n<i.length;n++){var a=i[n];if(!t.is(s[a])){r.name=a;var o=this._getUrlFromLabel(e,a);l.getOrCreateGlypheTexure(o,r);s[a]=o}}this._createAtlasFromUrlsList(Object.values(s)),this._fontAtlas=this.atlasId}},_getUrlFromLabel:function(e,i){var r=""+this._prefix;return t.is(e)&&t.is(e.style)&&(t.is(e.style["font-family"])&&(r+=e.style["font-family"]),t.is(e.style["font-size"])&&(r+=e.style["font-size"]),t.is(e.style.color)&&(r+=e.style.color.hexToRgb()?e.style.color.hexToRgb():e.style.color),t.is(e.style["font-weight"])&&(r+=e.style["font-weight"]),t.is(e.style["text-shadow"])&&(r+=e.style["text-shadow"])),t.is(i)?r+=i:t.is(e.name)&&(r+=e.name),r},setTextureInfo:function(e,i,r,s){var n=!0;e.top=0,e.left=0,e.indexTexture=0;var a=this.getCompleteMaterialInfo(i,r);if(a.mapUrl=this._getUrlFromLabel(a.label,s.value),t.is(a.offsetFunction)||(a.offsetFunction={ratio:{x:-.5,y:.5,z:.5},pixel:{x:0,y:0,z:0}}),t.is(a.mapUrl)){e.top=-a.offsetFunction.pixel.y,e.left=a.offsetFunction.pixel.x,e.mapUrl=a.mapUrl;var o=this.getTextureInfo(a.mapUrl);if(t.is(o)){n=!1,o.texturenotloaded&&(n=!0),e.indexTexture=o.index;var l=o.width,h=o.height;t.is(o.atlasWidth)&&(l*=o.atlasWidth),t.is(o.atlasHeight)&&(h*=o.atlasHeight),e.top-=a.offsetFunction.ratio.y*h,e.left+=a.offsetFunction.ratio.x*l}else e.indexTexture=0}return n},updateTextureWhenReady:function(e,i){if(t.is(e)&&t.is(i)){var r=this;this.atlasId;t.is(this.atlasId)&&l.addCallbackToAtlas(this.atlasId,function(){var s,n,a,o,l,h,d=Object.keys(e),u=d.length,c=i.children.length;for(o=0;o<c;o++)if(h=i.children[o],t.is(h))for(s=0;s<u;s++){n=d[s];var p=e[n].glyphes;a=e[n].attributes;var f=Object.keys(p);for(l=0;l<f.length;l++){var m=f[l];r.updateTextureInfoOfAgent(h,n,a,m,p[m])}}})}},updateTextureInfoOfAgent:function(e,i,r,s,n){if(t.is(e)&&t.is(r)&&!0===e.isInstanceNode3D){var a={};if(this.setTextureInfo(a,i,r,n))console.error("texture download ended but no texture available!");else{var o=a.left,l=a.top,h=a.indexTexture;if(t.is(e.mesh3js.userData.cgmIds)){var d=e.mesh3js.instanceAttribArrays.instanceFloats.array,u=!1;h!==d[4*s+1]&&(d[4*s+1]=h,u=!0),o!==d[4*s+2]&&(d[4*s+2]=o,u=!0),l!==d[4*s+3]&&(d[4*s+3]=l,u=!0),u&&(e.mesh3js.instanceAttribArrays.instanceFloats.isDynamic=!0)}}}},getCompleteMaterialInfo:function(e,i){if(t.is(this.lastMaterialInfo)||(this.lastMaterialInfo={}),!t.is(this.lastMaterialInfo[e])){if(!t.is(i))return this._parent(e,i);this.lastMaterialInfo[e]=this._parent(e,i)}return this.lastMaterialInfo[e]}})}),define("DS/XCityEnvironment/Sky",["DS/WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/XCityEnvironment/LensFlare","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/EventDispatcher","DS/XCityRendering/RenderingHandlerSky"],function(e,t,i,r,s,n,a,o,l,h,d,u,c){"use strict";var p=e.getWebappsAssetUrl("XCityEnvironment",""),f=h.loadTexture(p+"textures/skybox/cloudNoise.jpg"),m=10,g=2,v=.005,_=.8,y={coverage:.5,thickness:80,height:100,aspect:.035,shape:.01,on:!1,windDirection:new t.Vector3(1,0,0),windSpeed:.2},b={uniforms:{turbidity:{type:"f",value:m},reileigh:{type:"f",value:g},mieCoefficient:{type:"f",value:v},mieDirectionalG:{type:"f",value:_},sunPos:{type:"v3",value:new t.Vector3(0,0,0)},cloudNoise:{type:"t2",value:f},timer:{type:"f",value:0,animation:function(e){return e.animatedTime}},coverage:{type:"f",value:y.coverage},thickness:{type:"f",value:y.thickness},height:{type:"f",value:y.height},aspect:{type:"f",value:y.aspect},shape:{type:"f",value:y.shape},on:{type:"b",value:y.on},windDirection:{type:"v3",value:y.windDirection},windSpeed:{type:"f",value:y.windSpeed}},varyings:{myWorldPosition:{type:"v3"}},VS_overridableFunctions:{ComputeVaryingValues:["myWorldPosition = vGetAttribPosition().xyz;"].join("\n")},FS_global_code:["vec3 cameraPos = vec3(0., 0., 0.);","const float UN_SUR_QUATREPI = 0.07957747154594767;","#define wind windDirection * (windSpeed * timer)","#define sunDir normalize(sunPos)","float noise(vec3 x){","vec3 p = floor(x);","vec3 f = fract(x);","f = f*f*(3.0 - 2.0*f);","vec2 uv = (p.xy+vec2(37.0,17.0)*p.z) + f.xy;","vec2 rg = texture2D(cloudNoise,(uv+0.5)/256.0,0.).yx;","return mix( rg.x, rg.y, f.z );","}","float fbm(vec3 p,float lacunarity){","float t  = 0.50000 * noise(p); p *= lacunarity;","t += 0.25000 * noise(p); p *= lacunarity;","t += 0.12500 * noise(p); p *= lacunarity;","t += 0.06250 * noise(p); p *= lacunarity;","t += 0.03125 * noise(p);","return t;","}","float hgPhase(float cosTheta, float g)","{","float g2 = g * g;","return UN_SUR_QUATREPI * (pow(1.0 - g, 2.0) / pow(1.0 - 2.0*g*cosTheta + g2, 1.5));","}","vec3 render(vec3 cloudPos, vec3 skyColor)","{","if(coverage >= 0.9 || on == false) return skyColor;","int steps = int(max(thickness*2.0,55.0));","float valueStep = (thickness / float(steps));","float light = clamp(-dot(sunDir, cloudPos),0., 1.0);","vec3 projection = cloudPos / cloudPos.y;","vec3 iter = projection * valueStep;","float cHeight = 0.;","float alpha = 0.;","float T = 1.0;","float sunAngle = clamp(dot(sunDir,cloudPos),0.0,1.0);","vec3 origin = projection * height;","vec3 pos = origin;","vec3 C = vec3(0.);","float invThickness = 1.0 / thickness;","for (int i = 0; i < 600; i++) {","if (i >= steps) break;","if (alpha > 0.95 || T < 0.05) break;","cHeight = (pos.y - origin.y) * invThickness;","float dens = fbm(pos * shape + wind, 2.76434);","if (dens != 0.0){","dens *= smoothstep (coverage, coverage + aspect, dens)*valueStep;","float T_i = exp(-dens);","T *= T_i;","C += T * exp(cHeight) * 0.5128 * dens;","alpha += (1. - T_i) * (1. - alpha);","}","pos += iter;","}","if (sunPos.z < 0.0)","{","C *= 3.5*skyColor;","return mix(skyColor, C, alpha* smoothstep(0.,0.2,cloudPos.y));","}","else {","C *= mix(vec3(1.0,0.3,0.1), C, pow(sunDir.z, 0.5));","alpha *= smoothstep(0.,sunDir.z*0.1,cloudPos.y);","return mix(skyColor, pow(C,max(vec3(2.0*smoothstep(0.0,200.0,thickness)),1.0)), alpha);","}","}","// constants for atmospheric scattering","const float e = 2.71828182845904523536028747135266249775724709369995957;","const float pi = 3.141592653589793238462643383279502884197169;","// optical length at zenith for molecules","const float rayleighZenithLength = 8.4E3;","const float mieZenithLength = 1.25E3;","const vec3 up = vec3(0.0, 0.0, 1.0);","const float EE = 800.0;","const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;","// 66 arc seconds -> degrees, and the cosine of that","// earth shadow hack","const float cutoffAngle = 1.6110731556870734;","float steepness = 1.5;","const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );","const float TROIS_SUR_SEIZEPI = 0.05968310365946075;","float rayleighPhase(float cosTheta)","{","return TROIS_SUR_SEIZEPI * (1.0 + pow(cosTheta, 2.0));","}","const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );","vec3 totalMie(float T)","{","float c = (0.2 * T ) * 10E-18;","return 0.434 * c * MieConst;","}","float sunIntensity(float zenithAngleCos)","{","return EE * max(0.0, 1.0 - pow(e, -((cutoffAngle - acos(zenithAngleCos))/(steepness))));","}","// Filmic ToneMapping","float A = 0.15;","float B = 0.50;","float C = 0.10;","float D = 0.20;","float E = 0.02;","float F = 0.30;","const float whiteScale = 1.0748724675633854;","vec3 Uncharted2Tonemap(vec3 x)","{","return ((x*(A*x+0.05)+0.004)/(x*(A*x+B)+0.06))-0.0666666667;","}"].join("\n"),FS_overridableFunctions:{ProcessFinalColor:["float sunUpAngle = dot(sunDir, up);","float sunE = sunIntensity(sunUpAngle);","// extinction (absorbtion + out scattering) ","// rayleigh coefficients","vec3 betaR = totalRayleigh * reileigh;","// mie coefficients","vec3 betaM = totalMie(turbidity) * mieCoefficient;","// optical length","// cutoff angle at 90 to avoid singularity in next formula.","float zenithAngle = acos(max(0.0, dot(up, normalize(myWorldPosition - cameraPos))));","float sR = rayleighZenithLength / (cos(zenithAngle) + 0.15 * pow(93.885 - ((zenithAngle * 180.0) / pi), -1.253));","float sM = mieZenithLength / (cos(zenithAngle) + 0.15 * pow(93.885 - ((zenithAngle * 180.0) / pi), -1.253));","// combined extinction factor\t","vec3 Fex = exp(-(betaR * sR + betaM * sM));","// in scattering","float cosTheta = dot(normalize(myWorldPosition - cameraPos), sunDir);","float rPhase = rayleighPhase(cosTheta);","vec3 betaRTheta = betaR * rPhase;","float mPhase = hgPhase(cosTheta, mieDirectionalG);","vec3 betaMTheta = betaM * mPhase;","float coeffMie = smoothstep(0.005,0.1, mieCoefficient);","float coeffTurbid = smoothstep(1.0,20.0, turbidity);","vec3 thetaONbeta = ((betaRTheta + betaMTheta) / (betaR + betaM));","vec3 Lin = pow((sunE * max(0.6,min(0.7,1.0-coeffMie))) * thetaONbeta * (1.0 - Fex), vec3(1.5));","Lin *= mix(vec3(1.0),pow((sunE * max(0.6,min(0.7,1.0-coeffMie))) * thetaONbeta * Fex,vec3(0.5)),clamp(pow(1.0-sunUpAngle,5.0),0.0,1.0));","//nightsky","vec3 L0 = vec3(0.1) * pow(Fex, vec3(1.0-min(coeffTurbid,0.8)));","// composition + solar disc","float sundisk;","if(coverage <= 0.5 && sunDir.z >= 0.0){sundisk = 0.;}","else{sundisk = smoothstep(sunAngularDiameterCos,sunAngularDiameterCos+0.00002,cosTheta);}","L0 += (sunE * 19000.0 * Fex)*sundisk;","vec3 texColor = (Lin+L0);","texColor *= 0.04 ;","texColor += vec3(0.0,0.001,0.0025)*0.3;","vec3 curr = clamp(Uncharted2Tonemap((log2(1.366))*texColor),vec3(0.0), vec3(1.0));","vec3 color = curr*whiteScale;","vec2 uv = vGetTexCoord0().xy;","float phi = pi * (2.0 * uv.x - 1.0);","float theta = pi * uv.y;","vec3 posPixel = vec3( sin(theta)*cos(phi),  cos(theta), sin(theta)*sin(phi));","color = pow(render(posPixel, color),vec3(0.4545));","ioFinalColor.rgb = color;","ioFinalColor.a = 1.0;"].join("\n")}},x={uniforms:{turbidity:{type:"f",value:m},reileigh:{type:"f",value:g},mieCoefficient:{type:"f",value:v},mieDirectionalG:{type:"f",value:_},sunPos:{type:"v3",value:new t.Vector3(0,0,0)}},vertexShader:["varying vec2 vUv;","varying vec3 myWorldPosition;","void main() {","vUv = uv;","myWorldPosition = position;","gl_Position = projectionMatrix * ( viewMatrix * (modelMatrix * vec4( position, 1.0 )));","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform vec3 sunPos;","varying vec3 myWorldPosition;","uniform float turbidity;","uniform float reileigh;","uniform float mieCoefficient;","uniform float mieDirectionalG;","// constants for atmospheric scattering","const float e = 2.71828182845904523536028747135266249775724709369995957;","const float pi = 3.141592653589793238462643383279502884197169;","// optical length at zenith for molecules","const float rayleighZenithLength = 8.4E3;","const float mieZenithLength = 1.25E3;","const vec3 up = vec3(0.0, 0.0, 1.0);","const float EE = 800.0;","const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;","// 66 arc seconds -> degrees, and the cosine of that","// earth shadow hack","const float cutoffAngle = 1.6110731556870734;","const float steepness = 1.5;","const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );","const float TROIS_SUR_SEIZEPI = 0.05968310365946075;","const float UN_SUR_QUATREPI = 0.07957747154594767;","float rayleighPhase(float cosTheta)","{","return TROIS_SUR_SEIZEPI * (1.0 + pow(cosTheta, 2.0));","}","const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );","vec3 totalMie(float T)","{","float c = (0.2 * T ) * 10E-18;","return 0.434 * c * MieConst;","}","float hgPhase(float cosTheta, float g)","{","return UN_SUR_QUATREPI * ((1.0 - pow(g, 2.0)) / pow(1.0 - 2.0*g*cosTheta + pow(g, 2.0), 1.5));","}","float sunIntensity(float zenithAngleCos)","{","return EE * max(0.0, 1.0 - pow(e, -((cutoffAngle - acos(zenithAngleCos))/steepness)));","}","// Filmic ToneMapping","float A = 0.15;","float B = 0.50;","float C = 0.10;","float D = 0.20;","float E = 0.02;","float F = 0.30;","const float whiteScale = 1.0748724675633854;","vec3 Uncharted2Tonemap(vec3 x)","{","return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;","}","void main() {","float phi = pi * (2.0 * vUv.x - 1.0);","float theta = pi * vUv.y;","vec3 posPixel = vec3( sin(theta)*cos(phi),  sin(theta)*sin(phi), cos(theta) );","float sunfade = 1.0-clamp(1.0-exp(posPixel.z),0.0,1.0);","vec3 sunDirection = normalize(sunPos);","float sunUpAngle = dot(sunDirection, up);","float sunE = sunIntensity(sunUpAngle);","// extinction (absorbtion + out scattering) ","// rayleigh coefficients","vec3 betaR = totalRayleigh * reileigh;","// mie coefficients","vec3 betaM = totalMie(turbidity) * mieCoefficient;","// optical length","// cutoff angle at 90 to avoid singularity in next formula.","float zenithAngle = acos(max(0.0, dot(up, normalize(posPixel))));","float sR = rayleighZenithLength / (cos(zenithAngle) + 0.15 * pow(93.885 - ((zenithAngle * 180.0) / pi), -1.253));","float sM = mieZenithLength / (cos(zenithAngle) + 0.15 * pow(93.885 - ((zenithAngle * 180.0) / pi), -1.253));","// combined extinction factor\t","vec3 Fex = exp(-(betaR * sR + betaM * sM));","// in scattering","float cosTheta = dot(normalize(posPixel), sunDirection);","float rPhase = rayleighPhase(cosTheta*0.5+0.4);","vec3 betaRTheta = betaR * rPhase;","float mPhase = hgPhase(cosTheta, mieDirectionalG);","vec3 betaMTheta = betaM * mPhase;","float coeffMie = smoothstep(0.005,0.1, mieCoefficient);","float coeffTurbid = smoothstep(1.0,20.0, turbidity);","vec3 thetaONbeta = ((betaRTheta + betaMTheta) / (betaR + betaM));","vec3 Lin = pow((sunE * max(0.6,min(0.7,1.0-coeffMie))) * thetaONbeta * (1.0 - Fex), vec3(1.5));","Lin *= mix(vec3(1.0),pow((sunE * max(0.6,min(0.7,1.0-coeffMie))) * thetaONbeta * Fex,vec3(0.5)),clamp(pow(1.0-sunUpAngle,5.0),0.0,1.0));","//nightsky","vec3 L0 = vec3(0.1) * pow(Fex, vec3(1.0-min(coeffTurbid,0.8)));","// composition + solar disc","float sundisk = smoothstep(sunAngularDiameterCos,sunAngularDiameterCos+0.00002,cosTheta);","L0 += (sunE * 19000.0 * Fex)*sundisk;","vec3 texColor = (Lin+L0);   ","texColor *= 0.04 ;","texColor += vec3(0.0,0.001,0.0025)*0.3;","vec3 curr = Uncharted2Tonemap((log2(2.0/pow(1.1,4.0)))*texColor);","vec3 color = curr*whiteScale;","vec3 retColor = pow(color,vec3(1.0/(2.2)));","gl_FragColor.rgb = retColor;","gl_FragColor.a = 1.0;","} // main"].join("\n")},C=function(e){var r=d.getPDSFXMaterial(b);r.side=t.DoubleSide,r.forceSide=!0;var s=i.createSphereNode({radius:.5});s.setMaterial(r),r.needsUpdate=!0,r.force=!0,this.mesh=s,this.mesh.setPickable(n.NODRAWHL),this.mesh.setShadow(!1,!1),this.mesh.setSSAO(!1)},S=function(e){this.urban=e,this.shoot=0,this._vse=this.urban.getView3D(),f.flipY=!1,f.wrapS=t.RepeatWrapping,f.wrapT=t.RepeatWrapping,f.generateMipmaps=!0,this.sky=new C(e);this.urban.date;this.sky.mesh.material.updatePDSFXUniform("turbidity",this.urban.environment.skyParams.turbidity),this.sky.mesh.material.updatePDSFXUniform("reileigh",this.urban.environment.skyParams.reileigh),this.sky.mesh.material.updatePDSFXUniform("mieCoefficient",this.urban.environment.skyParams.mieCoefficient),this.sky.mesh.material.updatePDSFXUniform("mieDirectionalG",-this.urban.environment.skyParams.mieDirectionalG),this.sky.mesh.material.updatePDSFXUniform("coverage",1-this.urban.environment.cloudsParams.coverage),this.sky.mesh.material.updatePDSFXUniform("height",this.urban.environment.cloudsParams.height),this.sky.mesh.material.updatePDSFXUniform("thickness",this.urban.environment.cloudsParams.thickness),this.sky.mesh.material.updatePDSFXUniform("aspect",this.urban.environment.cloudsParams.aspect),this.sky.mesh.material.updatePDSFXUniform("shape",this.urban.environment.cloudsParams.shape),this.sky.mesh.material.updatePDSFXUniform("on",this.urban.environment.cloudsParams.on),this.sky.mesh.material.updatePDSFXUniform("windDirection",this.urban.environment.cloudsParams.windDirection),this.sky.mesh.material.updatePDSFXUniform("windSpeed",this.urban.environment.cloudsParams.windSpeed),this._skyboxMatrix=new t.Matrix4,this.lensFlare=new l(this.urban),this.lensFlare.initLensFlare();var i=function(){var e,i;e=this.urban.getViewpoint().getCamera().far,i=this.urban.getViewpoint()._getPositionRelative(),this.sky.mesh.material.updatePDSFXUniform("turbidity",this.urban.environment.skyParams.turbidity),this.sky.mesh.material.updatePDSFXUniform("reileigh",this.urban.environment.skyParams.reileigh),this.sky.mesh.material.updatePDSFXUniform("mieCoefficient",this.urban.environment.skyParams.mieCoefficient),this.sky.mesh.material.updatePDSFXUniform("mieDirectionalG",-this.urban.environment.skyParams.mieDirectionalG),this.sky.mesh.material.updatePDSFXUniform("coverage",1-this.urban.environment.cloudsParams.coverage),this.sky.mesh.material.updatePDSFXUniform("height",this.urban.environment.cloudsParams.height),this.sky.mesh.material.updatePDSFXUniform("thickness",this.urban.environment.cloudsParams.thickness),this.sky.mesh.material.updatePDSFXUniform("aspect",this.urban.environment.cloudsParams.aspect),this.sky.mesh.material.updatePDSFXUniform("shape",this.urban.environment.cloudsParams.shape),this.sky.mesh.material.updatePDSFXUniform("on",this.urban.environment.cloudsParams.on),this.sky.mesh.material.updatePDSFXUniform("windDirection",this.urban.environment.cloudsParams.windDirection),this.sky.mesh.material.updatePDSFXUniform("windSpeed",this.urban.environment.cloudsParams.windSpeed),this._skyboxMatrix.identity(),this._skyboxMatrix.scale(new t.Vector3(e,e,e)),this._skyboxMatrix.setPosition(i),this.sky.mesh.setMatrix(this._skyboxMatrix)}.bind(this);u.subscribeTo("/3DEXPERIENCity/onPostUpdate",i),this.composer=null,this._rendering=new c(e)};return S.prototype={updateSun:function(e){null===this.composer&&this.initSkyPass(),this.sky.mesh.material.updatePDSFXUniform("sunPos",this.urban.environment.sun.sunPos),this.passSky&&(this.passSky.uniforms.sunPos.value=this.urban.environment.sun.sunPos),this.computePass(),this.shoot++},setSkyColor:function(e){},getSunInfo:function(e,t){var i=Math.floor(this.width*(.5+e/Math.PI*.5)),r=4*(Math.floor(this.height*(.5+t/(.5*Math.PI)*.5))*this.width+i),s={r:Math.pow(this.buffer[r]/255,.5),g:Math.pow(this.buffer[r+1]/255,.5),b:Math.pow(this.buffer[r+2]/255,.5)},n=4*(this.height/2*this.width+this.width/2);return{d:s,a:{r:Math.pow(this.buffer[n]/255,.5),g:Math.pow(this.buffer[n+1]/255,.5),b:Math.pow(this.buffer[n+2]/255,.5)}}},initSkyPass:function(){this.width=1024,this.height=512,this.renderTarget=new t.WebGLRenderTargetProperties(this.width,this.height,"uint"),this.composer=new a(this.urban.USR.webGLV6Viewer.renderer.renderer,this.renderTarget,this.urban.USR.webGLV6Viewer.renderer.renderTargetPool),this.composer.composerContext.keepResult=!0,this.composer.name="depthCurrentEffectComposer",this.passSky=new o(x),this.passSky.renderToScreen=!1,this.composer.addPass(this.passSky)},computePass:function(){this.composer.render(),this.buffer=new Uint8Array(this.width*this.height*4),this.gl=this.urban.USR.webGLV6Viewer.renderer.renderer.context,this.gl.readPixels(0,0,this.width,this.height,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.buffer)},setCubeMap:function(e){},getRendering:function(){return this._rendering},redraw:function(){var e=this.getRendering(),t=e.getCompleteMaterialInfo().getRenderingData();e.applySkyMaterial(t)}},S}),define("DS/XCityEnvironment/Environment",["UWA/Class","UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityEnvironment/VisualEffect","DS/XCityEnvironment/Sun","DS/XCityEnvironment/LensFlare","DS/XCityEnvironment/Slab","DS/XCityEnvironment/CubeMap","DS/XCityEnvironment/Sky","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p){"use strict";var f=e.extend(t,{init:function(e){this._urban=e,this.changeEventName="effect",this._loadListeners(),this.initialized=!1,this._param=new m,this.shadowConfig(this._param.shadow),this.effects={},this.defaults={},this.disabledEffects={},this.defaultslabcolor=(new i.Color).setRGB(.596078431,.768627451,.91372549);var t=this._urban.getRenderingProfileManager(),r=this._urban.getPerformanceProfileManager();this.addRenderProfile(t.defaultProfile,this._param);var s=this;t.addProfile(t.defaultProfile,function(e,t){s.setRendering(t),s.setSlabColor(s.defaultslabcolor)},t.defaultProfile,"EffectsParams"),t._initEnvironment(this),r._initEnvironment(this),this.sun=new a(this._urban,this._param.sun||{}),this.sky=new h(this._urban,this._param.sky||this._param),this.presetList=[{turbidity:2.6,reileigh:1,mieCoefficient:.013,mieDirectionalG:-.8,density:1},{turbidity:14,reileigh:4,mieCoefficient:.05,mieDirectionalG:-.75,density:.4},{turbidity:20,reileigh:1,mieCoefficient:.1,mieDirectionalG:-.7,density:.3},{turbidity:20,reileigh:1,mieCoefficient:.1,mieDirectionalG:-.9,density:1}],this.cloudsParams={coverage:.5,thickness:80,height:100,aspect:.035,shape:.01,on:!1,windDirection:new i.Vector3(1,0,0),windSpeed:.2},this.skyParams=this.presetList[0],this.showroom=0,this.betasky=null,this.slab=new l(this._urban,this._param),this.initEffects(),this.setRendering(this._urban.USR.renderingCurrent),this.initialized=!0,this.showAtmosphere=!1},_loadListeners:function(){var e=this,t={evtEnvironment:function(t){p.publish("/xCity/needRender",this),p.publish(p.eventsList[e.changeEventName],t)},evtAO:function(i){p.publish(p.eventsList[e.changeEventName+".ao"],i),t.evtEnvironment(i)},evtBloom:function(i){p.publish(p.eventsList[e.changeEventName+".bloom"],i),t.evtEnvironment(i)},evtTone:function(i){p.publish(p.eventsList[e.changeEventName+".tone"],i),t.evtEnvironment(i)},evtSun:function(i){p.publish(p.eventsList[e.changeEventName+".sun"],i),t.evtEnvironment(i)},evtSlab:function(i){p.publish(p.eventsList[e.changeEventName+".slab"],i),t.evtEnvironment(i)},evtShadow:function(i){p.publish(p.eventsList[e.changeEventName+".shadow"],i),t.evtEnvironment(i)}};p.subscribeTo(p.eventsList[this.changeEventName+".dof"],t.evtEnvironment),p.subscribeTo(p.eventsList[this.changeEventName+".sslr"],t.evtEnvironment),p.subscribeTo(p.eventsList[this.changeEventName+".ao.enable"],t.evtAO),p.subscribeTo(p.eventsList[this.changeEventName+".ao.strength"],t.evtAO),p.subscribeTo(p.eventsList[this.changeEventName+".ao.angle"],t.evtAO),p.subscribeTo(p.eventsList[this.changeEventName+".bloom.enable"],t.evtBloom),p.subscribeTo(p.eventsList[this.changeEventName+".bloom.factor"],t.evtBloom),p.subscribeTo(p.eventsList[this.changeEventName+".tone.enable"],t.evtTone),p.subscribeTo(p.eventsList[this.changeEventName+".tone.gamma"],t.evtTone),p.subscribeTo(p.eventsList[this.changeEventName+".tone.type"],t.evtTone),p.subscribeTo(p.eventsList[this.changeEventName+".infinitePlane"],t.evtEnvironment),p.subscribeTo(p.eventsList[this.changeEventName+".sun.diffuseFactor"],t.evtSun),p.subscribeTo(p.eventsList[this.changeEventName+".sun.ambientFactor"],t.evtSun),p.subscribeTo(p.eventsList[this.changeEventName+".slab.color"],t.evtSlab),p.subscribeTo(p.eventsList[this.changeEventName+".aa"],t.evtEnvironment),p.subscribeTo(p.eventsList[this.changeEventName+".normalMap"],t.evtEnvironment),p.subscribeTo(p.eventsList[this.changeEventName+".specularMap"],t.evtEnvironment),p.subscribeTo(p.eventsList[this.changeEventName+".roofMode"],t.evtEnvironment),p.subscribeTo(p.eventsList[this.changeEventName+".shadow.enable"],t.evtShadow),p.subscribeTo(p.eventsList[this.changeEventName+".shadow.visible"],t.evtShadow),p.subscribeTo(p.eventsList[this.changeEventName+".shadow.bias"],t.evtShadow),p.subscribeTo(p.eventsList[this.changeEventName+".shadow.darkness"],t.evtShadow),p.subscribeTo(p.eventsList[this.changeEventName+".shadow.nbShadowMaps"],t.evtShadow),p.subscribeTo(p.eventsList[this.changeEventName+".shadow.resolution"],t.evtShadow),p.subscribeTo(p.eventsList[this.changeEventName+".shadow.boxSize"],t.evtShadow),p.subscribeTo(p.eventsList[this.changeEventName+".shadow.altitudeOff"],t.evtShadow),p.subscribeTo(p.eventsList[this.changeEventName+".shadow.altitudeOn"],t.evtShadow)},setup:function(e,t){this.sky.initDefaultSky()},reset:function(e,t){},addRenderProfile:function(e,t){u.is(this.defaults[e])||(this.defaults[e]={}),u.is(this.defaults[e])&&this._mergeeffects(this.defaults[e],t);var i=this._urban.getRenderingProfileManager().sessionProfileName;this.type!==e&&e!==i||this.setRendering(this.type)},removeRenderProfile:function(e){u.is(this.defaults[e])&&(this.defaults[e]={})},disableEffects:function(e){if(u.is(e)){var t,i,r=["aa","ao","bloom","dof","shadow","tone","sslr"];for(t=0;t<r.length;t++){i=r[t];var s=e.indexOf(i);u.is(this.disabledEffects[i])?s>=0||(this.disabledEffects[i]=void 0,p.publish(p.eventsList["disable."+this.changeEventName+"."+i],!1),p.publish(p.eventsList["disable."+this.changeEventName],i)):s>=0?(this._enableEffect(i,!1),this.disabledEffects[i]=!0,p.publish(p.eventsList["disable."+this.changeEventName+"."+i],!0),p.publish(p.eventsList["disable."+this.changeEventName],i)):(p.publish(p.eventsList["disable."+this.changeEventName+"."+i],!1),p.publish(p.eventsList["disable."+this.changeEventName],i))}return u.is(this.type)&&this.setParams(this.defaults[this.type]),!0}return!1},shadowConfig:function(e){var t={visible:!1,bias:[-1e-4,-5e-4,-.001],darkness:.6,nbShadowMaps:3,resolution:4096};for(var i in void 0===e&&(e={}),t)void 0===e[i]?e[i]=t[i]:p.publish(p.eventsList[this.changeEventName+".shadow."+i],e[i]);this.shadow=e},initEffects:function(){var e=this,t=this._param.effects,i=this._urban.getView3D().webGLV6Viewer;void 0===t&&(t=this._param);this.effects.ao=new n(this._urban,"ao",i.setSSAO.bind(i),t,!1,function(e,t){var r=i.getEffect("SSAO");null!==r&&("strength"===e?(r.setStrength(t),i.setSSAOParameters({power:t})):"angle"===e&&(r.setThresholdAngle(t),i.setSSAOParameters({thresholdAngle:t}))),this._options[e]=t});this.effects.bloom=new n(this._urban,"bloom",i.setBloom.bind(i),t,!1,function(e,t){var r=i.getEffect("Bloom");null!==r&&"factor"===e&&r.setBloomFactor(t),this._options[e]=t}),this.effects.sslr=new n(this._urban,"sslr",i.setSSLR.bind(i),t,!1);this.effects.dof=new n(this._urban,"dof",function(e){i.setDOF(e);var t=i.getEffect("DOF");t&&e&&(t.useCameraInfo=!0,t.setAutoFocus(!0),t.setSceneScale(1e3),t.setBehaviour(t.Behaviours.ARTISTIC))},t,!1);this.effects.aa=new n(this._urban,"aa",function(e){i.setAntiAliasing(!0===e?"SMAA":"NoAA")},t,!0);this.effects.tone=new n(this._urban,"tone",function(e){i.setToneMapping({enable:e}),this._options.enable=e},t.tone&&t.tone.gamma?t:{tone:{gamma:2.2,type:2}},!0,function(e,t){var r=i.renderer.ToneMappingEffect;null!==r&&("gamma"===e?r.setGamma(t):"type"===e&&r.setToneMapping(this._options.enable?t:0)),this._options[e]=t});this.effects.shadow=new n(this._urban,"shadow",function(t){e.sun.shadowState(t,e.shadow)},t,!1)},update:function(){this.sky&&this.sky.update()},setAmbientFactor:function(e){return this.sun&&e!==this.sun.ambientFactor?(this.sun.setAmbientFactor(e),this):null},setDiffuseFactor:function(e){var t=null;return this.sun&&e!==this.sun.diffuseFactor&&(this.sun.setDiffuseFactor(e),t=!0),t},switchSky:function(){null===this.betasky&&(this.betasky=new d(this._urban),this.cubeSky=this.sky),this.realisticSky?(this.sky=this.cubeSky,this._urban.USR._root.remove(this.betasky.sky.mesh),this.sun.toUpdate=!0,this.realisticSky=!1,this.showAtmosphere&&this._atmosphere.disableEffect()):(this._urban.USR._root.add(this.betasky.sky.mesh),this.sky=this.betasky,this.sun.toUpdate=!0,this.realisticSky=!0,this.showAtmosphere&&(this._atmosphere||(this._atmosphere=this._urban.getView3D().getAtmosphereEffect()),this._atmosphere.enableEffect()))},setSlabColor:function(e){e&&(this.sky&&this.sky.setSkyColor(e),this.slab&&this.slab.setSkyColor(e),p.publish(p.eventsList[this.changeEventName+".slab.color"],e))},getSlabColor:function(){return this.sky?this.sky.getSkyColor():this.slab?this.slab.getSkyColor():void 0},enableEffect:function(e,t){return!!u.is(this.effects[e])&&this._enableEffect(e,t)},_enableEffect:function(e,t){if(u.is(this.disabledEffects[e]))return!1;var i=this.effectEnabled(e);if(u.is(i)&&i!==t){this.effects[e].enable(t);var r=".enable";return u.is(this._param[e].enable)||(r=""),p.publish(p.eventsList[this.changeEventName+"."+e+r],t),!0}},effectEnabled:function(e){return u.is(this.effects[e])?this.effects[e].enabled:null},setEffectAttribute:function(e,t,i){return u.is(this.effects[e])&&u.is(this.effects[e].update)&&this.effects[e].getOption(t)!==i?(this._setEffectAttribute(e,t,i),this):null},_setEffectAttribute:function(e,t,i){u.is(this.disabledEffects[e])||(this.effects[e].update(t,i),p.publish(p.eventsList[this.changeEventName+"."+e+"."+t],i))},setParams:function(e){if(this.initialized&&u.is(e)){var t=u.clone(e),i=this._urban.getRenderingProfileManager().sessionProfileName;if(u.is(this.defaults[i])){var r=u.clone(this.defaults[i]);this._mergeeffects(r,t),t=r}if(u.is(t.dof)&&this._enableEffect("dof",t.dof),u.is(t.sslr)&&this._enableEffect("sslr",t.sslr),u.is(t.ao)&&(u.is(t.ao.enable)&&this._enableEffect("ao",t.ao.enable),u.is(t.ao.strength)&&this._setEffectAttribute("ao","strength",t.ao.strength),u.is(t.ao.angle)&&this._setEffectAttribute("ao","angle",t.ao.angle)),u.is(t.bloom)&&(u.is(t.bloom.enable)&&this._enableEffect("bloom",t.bloom.enable),u.is(t.bloom.factor)&&this._setEffectAttribute("bloom","factor",t.bloom.factor)),u.is(t.tone)&&(u.is(null!==t.tone.enable)&&this._enableEffect("tone",t.tone.enable),u.is(t.tone.gamma)&&this._setEffectAttribute("tone","gamma",t.tone.gamma)),u.is(t.infinitePlane)&&this.slab&&this.slab.enableInfinitePlane(t.infinitePlane),u.is(t.sun)&&(u.is(t.sun.ambientFactor)&&this.sun.setAmbientFactor(t.sun.ambientFactor),u.is(t.sun.diffuseFactor))){var s=t.sun.diffuseFactor;this.sun&&this.sun.setDiffuseFactor(s)}u.is(t.aa)&&this._enableEffect("aa",t.aa),u.is(t.normalMap)&&(this._urban.useNormalMap=t.normalMap,this.dispatchEvent(this.ChangeEventName)),u.is(t.specularMap)&&(this._urban.useSpecularMap=t.specularMap,this.dispatchEvent(this.ChangeEventName)),u.is(t.roofMode)&&(this._urban.roofMode=t.roofMode,this.dispatchEvent(this.ChangeEventName)),u.is(t.shadow)&&(this.shadowConfig(t.shadow),u.is(t.shadow.enable)&&this._enableEffect("shadow",t.shadow.enable))}},getParams:function(){var e={};return e.bloom={enable:this.effects.bloom.enabled,factor:this.effects.bloom.getOption("factor")},e.aa=this.effects.aa.enabled,e.ao={enable:this.effects.ao.enabled,strength:this.effects.ao.getOption("strength"),angle:this.effects.ao.getOption("angle")},e.shadow={enable:this.effects.shadow.enabled},e.dof=this.effects.dof.enabled,e.sslr=this.effects.sslr.enabled,e.tone={enable:this.effects.tone.enabled,gamma:this.effects.tone.getOption("gamma")},e.normalMap=this._urban.useNormalMap,e.specularMap=this._urban.useSpecularMap,e.roofMode=this._urban.roofMode,e.sun={diffuseFactor:this._urban.environment.sun.diffuseFactor,ambientFactor:this._urban.environment.sun.ambientFactor},e},_getprofileparams:function(e){var t=null;return u.is(this.defaults[e])&&(t=u.clone(this.defaults[e])),t},setRendering:function(e){var t=this._urban.getRenderingProfileManager(),i=t.sessionProfileName,r=null;if(u.is(this.defaults[e])){r=this.defaults[e];t.sessionProfileName;this.type=e}else r=this.defaults[i],this.type=i;this.setParams(r)},applySkyMaterial:function(e){var t=this.defaultslabcolor;u.is(e)&&u.is(e.slabColor)&&(t=e.slabColor),this.setSlabColor(t);var i=null;u.is(e)&&u.is(e.cubeMap)&&(i=e.cubeMap),this.sky.setCubeMap(i)},getSkyMaterial:function(){var e={};return e.slabColor=this.sky.getSkyColor(),e.cubeMap=this.sky.getCubeMap(),e},_mergeeffects:function(e,t){if(u.is(e)&&u.is(t)&&(u.is(t.dof)&&(e.dof=t.dof),u.is(t.sslr)&&(e.sslr=t.sslr),u.is(t.ao)&&(u.is(e.ao)||(e.ao={}),u.is(t.ao.enable)&&(e.ao.enable=t.ao.enable),u.is(t.ao.strength)&&(e.ao.strength=t.ao.strength),u.is(t.ao.angle)&&(e.ao.angle=t.ao.angle)),u.is(t.bloom)&&(u.is(e.bloom)||(e.bloom={}),u.is(t.bloom.enable)&&(e.bloom.enable=t.bloom.enable),u.is(t.bloom.factor)&&(e.bloom.factor=t.bloom.factor)),u.is(t.tone)&&(u.is(e.tone)||(e.tone={}),u.is(t.tone.enable)&&(e.tone.enable=t.tone.enable),u.is(t.tone.gamma)&&(e.tone.gamma=t.tone.gamma)),u.is(t.infinitePlane)&&(e.infinitePlane=t.infinitePlane),u.is(t.sun)&&(u.is(e.sun)||(e.sun={}),u.is(t.sun.ambientFactor)&&(e.sun.ambientFactor=t.sun.ambientFactor),u.is(t.sun.diffuseFactor)&&(e.sun.diffuseFactor=t.sun.diffuseFactor)),u.is(t.aa)&&(e.aa=t.aa),u.is(t.normalMap)&&(e.normalMap=t.normalMap),u.is(t.specularMap)&&(e.specularMap=t.specularMap),u.is(t.roofMode)&&(e.roofMode=t.roofMode),u.is(t.shadow))){u.is(e.shadow)||(e.shadow={});for(var i=["enable","visible","bias","darkness","nbShadowMaps","resolution","boxSize","altitudeOff","altitudeOn","subNears","subFars"],r=0;r<i.length;r++){var s=i[r];u.is(t.shadow[s])&&(e.shadow[s]=t.shadow[s])}}}}),m=e.extend({init:function(e){if(this.resetDefaultValue(),u.is(e))for(var t,i=u.clone(e),r=Object.keys(i),s=r.length;s--;)this[t=r[s]]=i[t]},resetDefaultValue:function(){this.bloom={enable:!1,factor:.2},this.aa=!0,this.ao={enable:!1,strength:.5,angle:1},this.shadow={enable:!1},this.dof=!1,this.sslr=!1,xCity._urbanImpl._debugVisualOdt&&(this.sslr=!0),this.normalMap=!0,this.specularMap=!0,this.roofMode=!1,this.infinitePlane=!0,this.tone={enable:!0,gamma:2.2,type:2},this.sun={diffuseFactor:1,ambientFactor:1}},clone:function(){var e=new m;return e.bloom={enable:this.bloom.enable,factor:this.bloom.factor},e.aa=this.aa,e.ao={enable:this.ao.enable,strength:this.ao.strength,angle:this.ao.angle},e.shadow={enable:this.shadow.enable},e.dof=this.dof,e.sslr=this.sslr,e.normalMap=this.normalMap,e.specularMap=this.specularMap,e.roofMode=this.roofMode,e.infinitePlane=this.infinitePlane,e.tone={enable:this.tone.enable,gamma:this.tone.gamma},e.sun={diffuseFactor:this.sun.diffuseFactor,ambientFactor:this.sun.ambientFactor},e}});return f}),define("DS/XCityGeometry/BillboardLabelAligned",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PatchVectorFactoryLineStringGeometry","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/xCityBasicUtils/Utils","DS/XCityGeometry/PointOfInterest3DSetLabel","DS/XCityLayer/Vector","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/XCityRendering/RenderingHandlerPOI3DGeometry","DS/XCityRendering/RenderingHandlerPOI3DBillboardAlignedLabel","DS/XCityTools/Geocoder","DS/XCityTools/RTree","DS/Visualization/SceneGraphFactory","DS/XCityTools/Downloader","DS/XCityTools/Disposer","DS/XCityTools/TextureManager","DS/XCityRendering/FeatureRendering"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m,g,v,_,y){"use strict";return i.extend({init:function(e,t){this.urban=e,this.hierarchyScale=3,this._parent(e,t),a.is(t._rendering)&&(this.parentRendering=t._rendering),this._currentGlyphes={}},updateLabelRendering:function(){var e=this.parentRendering.currentRendering.get("label"),t=this.parentRendering.currentRendering.getDatavizImpactingAttribute("label"),i=this.parentRendering.currentRendering.getPrimitiveImpactingAttribute("label"),r=new y({label:e});r.addRenderings(t),r.addRenderings(i),this._rendering.updateRendering(r)},buildOne:function(e,t,i,r,s,n){a.is(this._poiSet)||(this._preparePoints(r.vertexList),this._initPoiSet(t)),this.updateLabelRendering();var o=e.attributes,l={name:name,strid:s,styleClass:"",altitude:0,height:0,localScale:[1,1,1],orientation:[0],attributes:o,material:n},h=n.label;this._rendering.startFontAtlas(n.label);var d=this._separateLabelInGlyphes(h);l.labelLength=this.labelPixelLength;var u=t.lines[s][0]._lengths[0],c=Math.max(1,Math.round(u/this.labelPixelLength*8));!0!==h.position.isRepeated&&(c=1);for(var p=this.getEquidistantPoints(r.vertexList,u,c),f=(t.posTile,0),m=(p.length,this.anotherCalculateRanges(p,u)),g=0;g<p.length;g++){var v=p[g];f=v.length,l.lineLength=f,l.anchorMaximumRadius=m[g],this.addOneRepetition(v.position,l,r.vertexList,d)}},getEquidistantPoints:function(e,t,i){for(var r=e.length,s=t/(i+1),n=0,a=[],o=e[0],l=0,h=0,d=1;d<r;d++){var u=e[d];for(l+=Math.sqrt(Math.pow(o.x-u.x,2)+Math.pow(o.y-u.y,2)+Math.pow(o.z-u.z,2));a.length<i&&l>n+s;){var c=(n+s-h)/(l-h),p=this.interpolate(o,u,c);a.push({position:p,length:n+s}),n+=s}h=l,o=u}return a},interpolate:function(e,i,r){if(!a.is(e))return a.is(i)?i:null;if(!a.is(i))return e;var s=new t.Vector3(e.x,e.y,e.z);return s.lerp(new t.Vector3(i.x,i.y,i.z),r),s},calculateRanges:function(e,t){this.spacingFactor=2;var i,r,s=e.length,n=[],o=.5*e[0].length,l=(e[e.length-1].length,Math.floor(a.logX(2,s)));for(i=0;i<s;i++)n[i]=o/this.spacingFactor;if(l>=1){var h,d,u=[];for(r=1;r<n.length;r+=2)n[r]*=2,u.push(r);for(h=u,i=1;i<l;i++){for(u=[],r=1;r<h.length;r+=2)n[d=h[r]]*=2,u.push(d);h=u}}return n},getRangeFor:function(e,t,i,r,s){if(r!==i&&s!==i){var n=e[r].length,a=e[s].length,o=e[i].length;t[i]=.5*Math.min(a-o,o-n)/this.spacingFactor,this.getRangeFor(e,t,i-Math.round(.5*(i-r)),r,i),this.getRangeFor(e,t,i+Math.round(.5*(s-i)),i,s)}},anotherCalculateRanges:function(e,t){var i=e.length;this.spacingFactor=2;var r=[],s=.5*e[0].length,n=Math.floor(.5*i),a=i-1,o=e[n].length;return r[0]=r[i-1]=s,r[n]=.75*Math.min(t-o,o),this.getRangeFor(e,r,n-Math.round(.5*(n-0)),0,n),this.getRangeFor(e,r,n+Math.round(.5*(a-n)),n,a),r},_determineRange:function(e,t,i,r){var s,n=.5*(i/t*.5),a=1;for(a=t,s=0;s<r;s++)e%a===Math.floor(.5*a)&&(n*=2),a=Math.round(.5*a);return n},_preparePoints:function(e){var i,r,s,n=e,a=0;this._pointsArray=[];var o=e.length;for(i=0;i<o;i+=1)r=n[i],i>0&&(a+=Math.sqrt(Math.pow(s.x-r.x,2)+Math.pow(s.y-r.y,2)+Math.pow(s.z-r.z,2))),this._pointsArray.push(new t.Vector4(r.x,r.y,r.z,a)),s=r},_initPoiSet:function(e){this._rendering=new c(this.urban,null,this.parentRendering);var t={shapeType:"billboard",rendering:this._rendering,switchDistance:"0",linePoints:this._pointsArray};this._poiSet=new o(this.urban,t,e)},_separateLabelInGlyphes:function(e){var t,i,r,s=e.name.toString(),n=[],a=0;for(i=0;i<s.length;i++)if(""!==(t=s[i])){var o=this.initLabelTexture(t,e);i;var l=o.image?o.image.width:o.width;r={value:t,startRatio:a,endRatio:a+l,textureUrl:o.url},n.push(r),a+=l}for(this.labelPixelLength=n[n.length-1].endRatio,i=0;i<n.length;i++)(r=n[i]).startRatio/=this.labelPixelLength,r.endRatio/=this.labelPixelLength;return n},addOneRepetition:function(e,t,i,r){t.material.label.name;for(var s=0;s<r.length;s++){var n=r[s];n.linepoints=i,t.mapUrl=n.textureUrl,this._poiSet.addPointOfInterest(e,t,n)}},initLabelTexture:function(e,t){var i=this._rendering._getUrlFromLabel(t,e);a.is(e)&&(t=Object.assign({},t,{name:e}),this._currentGlyphes[e]=!0);var r=_.getOrCreateGlypheTexure(i,t);return r&&(r.url=i),this._maps||(this._maps={}),this._maps[i]=!0,r},getData:function(e){var t=Object.keys(this._maps);this._currentGlyphes={},this._rendering._createAtlasFromUrlsList(t),1===t.length&&this._rendering.currentRendering.set("mapUrl",t[0]);var i=this._poiSet.getMesh();e.labelMeshes.push(i)},_createOneLabel:function(){}})}),define("DS/XCityGeometry/PatchVectorFactoryLine",["UWA/Class","DS/XCityGeometry/PatchVectorFactoryLineStringGeometry","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/XCityTools/Geocoder","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityLayer/Vector","DS/XCityGeometry/Line","DS/XCityRendering/RenderingHandlerLine","DS/XCityTools/TextureTools","DS/XCityGeometry/LineBuilder","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils","DS/XCityGeometry/BillboardLabelAligned"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m){"use strict";return t.extend({init:function(e,t){this._parent(e,t),this.urban=e,this._node=new s,this._node.name="FactoryLine",this.geoJSON={},this.stridAttribute=void 0!==t.stridAttribute?t.stridAttribute:"STRID",this._rendering=new d(e,t),this._labelBillboardMode=!0,this.nbFeature=0,this.type=1,this._initialHeightOffset=t.heightOffset,delete t.heightOffset,this.initLabelOnSelect(e,t.renderType),p.log("PatchVectorFactoryLine:init")},destroy:function(){this.urban.USR.getScene().remove(this._node),this._parent()},dispose:function(){p.warn("Dispose: line")},getGeoJSON:function(e){return this.geoJSON[e]},registerListeners:function(e){c.getSettableAttributes().forEach(function(t){e.addEvent("onChange:"+t,function(){e.setAttribute(t,e.get(t))},e)})},_getDataLabel:function(e){if(this._rendering.nbLabelNode=0,f.is(e.labelBuilders))for(var t in e.labelBuilders)e.labelBuilders.hasOwnProperty(t)&&e.labelBuilders[t].getData(e)},getData:function(e){var t;if(void 0!==e.rootNode){this._rendering.getCompleteMaterialInfo();var r=new i.Vector3(e.posTile.x,e.posTile.y,0),n=(new i.Matrix4).identity().setPosition(r);e.rootNode.setMatrix(n),e.builder.getData(e.lines,e.rootNode,e.forceTransparent,e.creatorsFromWorker),this._getDataLabel(e),this._updatePosSize(e),t=e.rootNode}else t=new s;return e.labelsNode?t.addChild(e.labelsNode):this.addLabelsToNode(e,t),t},_updatePosSize:function(e){var t=Object.keys(e.infos),i=e.rootNode;e.posTile.z=0;for(var r=0;r<t.length;r++){var s=t[r],n=e.infos[s];if(n.bSphere){var a=n.posSize;a.center.getPositionFromMatrix(i.getMatrix()).add(n.bSphere.center),a.altitude+=i.bBox.min.z,a.height=i.bBox.max.z-i.bBox.min.z,a.diameter=2*n.bSphere.radius}}},labelBuildersInit:function(e,t,i){i.label.position&&i.label.position.isAligned?(f.is(e.labelBuilders)||(e.labelBuilders={}),e.labelBuilders[t]=new m(this.urban,this)):f.is(e.labelBuilders)&&(e.labelBuilders=null)},computeLabelLinePoints:function(e,t){return e},buildBillboardsAlignedLabel:function(e,t,i,r,s,n){if(3===r.type)for(var a=0;a<r.geometryList.length;a++){var o=r.geometryList[a];t.labelBuilders[s].buildOne(e,t,i,o,s,n)}else t.labelBuilders[s].buildOne(e,t,i,r,s,n)},buildOneLabel:function(e,t,i,r,n,a){if(f.is(e)&&this._shouldCreateLabel(this._rendering.getCompleteMaterialInfo(a,r.attributes)))if(f.is(n.labelMeshes)||(n.labelMeshes=[]),e.label.position&&e.label.position.isAligned){var o=this.computeLabelLinePoints(t,1050);this.buildBillboardsAlignedLabel(r,n,i,o,a,e)}else for(var l=0;l<n.lines[i.strid].length;l++){var h=n.lines[i.strid][l];let t=f.generateLabelPriorities(this._node,r);n.labelsNode||(n.labelsNode=new s,n.labelsNode.name="labelsMeshes"),n.labelMeshes.push(this._generateLabel(h._lineMiddle,a,e,i.posSize,n.posTile,t,n.labelsNode))}},buildOne:function(e,t,r){p.log("PatchVectorFactoryLine:buildOne");var n=e.getGeometry();if(n.type===l.Type.LINESTRING||n.type===l.Type.MULTILINESTRING){var a=n.getVertices();if(void 0!==a){var o=e.attributes,h=e.getAttribute(this.stridAttribute),d=this._rendering.getCompleteMaterialInfo(h,o),u=!1;if(this._shouldCreateLabel(this._rendering.getCompleteMaterialInfo(h,e.attributes))&&(u=!0),t.creatorsFromWorker&&!u){var m={};this._setElevationAttributesFromMaterials(m,this._rendering.getPrimitiveRendering(h,o).getRenderingData(),this._rendering.currentRendering.getRenderingData(),this._rendering.defaultRendering.getRenderingData()),d=m}if(void 0===t.posTile&&(n.type===l.Type.MULTILINESTRING?t.posTile=new i.Vector2(Math.round(a[0][0].x),Math.round(a[0][0].y)):t.posTile=new i.Vector2(Math.round(a[0].x),Math.round(a[0].y)),t.rootNode=new s,t.builder=new c(this.urban,this._rendering)),u&&this.labelBuildersInit(t,h,d),!t.creatorsFromWorker)if(n.type===l.Type.MULTILINESTRING)for(var g=0;g<a.length;g++){var v=a[g];this._applyAltitude(v,t.posTile,d)}else this._applyAltitude(a,t.posTile,d);if(this.nbFeature++,t.creatorsFromWorker)t.builder.nbLines++;else{var _=t.builder.buildOne(r,n,void 0,void 0,e.attributes,t.creatorsFromWorker);f.is(t.lines)||(t.lines={}),f.is(t.lines[r.strid])||(t.lines[r.strid]=[]),t.lines[r.strid].push(_),_.isTransparent&&(t.forceTransparent=!0)}u&&this.buildOneLabel(d,n,r,e,t,h)}}},_shouldCreateLabel:function(e){return e&&e.label&&e.label.enable&&e.label.name&&""!==e.label.name},getRendering:function(){return this._rendering},setAttribute:function(e,t){return-1!==c.getSettableAttributes().indexOf(e)&&(this[e]=t,!0)},updateAttribute:function(e,t){if("renderMode"===e){var i=t.lineBuilder.setRenderMode(this.renderMode);t.removeChildren();for(var r=0;r<i.length;++r)t.addChild(i[r])}else"animation"===e?t.lineBuilder.setAnimation(this.animation,t):"dynamicUpdate"===e?t.lineBuilder.setDynamicUpdate(this.dynamicUpdate):this._setGeometryProperty(t,e,this[e])},_applyAltitude:function(e,t,i){for(var r=0;r<e.length;r++)e[r].z=this._computeAltitudeToApply(i,e[r]),e[r].x=e[r].x-t.x,e[r].y=e[r].y-t.y},_setElevationAttributesFromMaterials:function(e,...t){var i,r,s=["elevationMode","elevation","elevationOffset"],n={},a=1,o=0,l=1;for(var h in s)n[s[h]]=a,o|=a,a<<=1;for(var d in t)for(var h in s)if(i=h=s[h],r=t[d],i in r&&void 0!==r[i]&&null!==r[i]&&(e[h]=t[d][h],o===(l|=n[h])))return},_setGeometryProperty:function(e,t,i){void 0!==e&&e.children[0].setAttribute(t,i)},getDatas:function(e){return[{attributes:e.userData,target:e.geom}]},_computeLabelPos:function(e){var t,r=e._subMeshes[0].mesh.lineBuilder._lineSet[e._getStrid()][0]._lineMiddle,s=(t=f.is(this.patch)?this.patch.miDToTile[e._getStrid()]:f.is(this._node.userData.get("Content").primInfos)?this._node.userData.get("Content").primInfos[e._getStrid()]:this._node.userData.get("Content")._lineSet.primInfos[e._getStrid()]).bSphere?t.bSphere.center.x:0,n=t.bSphere?t.bSphere.center.y:0,a=new i.Vector3(t.posSize.center.x-s,t.posSize.center.y-n,0);return(new i.Vector3).addVectors(r,a)},_computeGeometrySize:function(e){return{center:new i.Vector3,altitude:0,height:0,width:0,length:0}},_getPrimInfoFromPreview:function(e){if(f.is(this._node.userData.getContent()._lineSet)&&f.is(this._node.userData.getContent()._lineSet.primInfos))return this._node.userData.getContent()._lineSet.primInfos[e]}})}),define("DS/XCityGeometry/PatchVector",["UWA/Core","UWA/Class","UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Mesh3D","DS/Visualization/Node3D","DS/XCityLayer/Vector","DS/xCityBasicUtils/DataFormatTools","DS/xCityBasicUtils/Utils","DS/XCityGeometry/PatchVectorFactoryModel","DS/XCityGeometry/PatchVectorFactoryFile","DS/XCityGeometry/PatchVectorFactoryPolygon","DS/XCityGeometry/PatchVectorFactoryLine","DS/XCityTools/Disposer","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m,g,v){"use strict";return t.extend(i,{init:function(e,t,i){this.urban=e,this.name="SiroccoFactory",this.factory=t,this.previewMode="enovia"===i.type||"wfs"===i.type,this.clusteringMode=i.clusteringMode;void 0!==this.urban.baseURL&&this.urban.baseURL,this.numGeomTotal=0,this.numBuild=0,this.timeBuild=0,this._modelAlternLoadCount=0,this.miDToTile={},this._uidListeners={},this.nbFeaturesMax=i.nbFeaturesMax||-1,this._synchrone=window.DEBUG_SYNCHRO_MODE||!1,this.invertY=i.invertY||!1,this.alternDict={},this.alternUrl=i.alternUrl||"";for(var r,s=i.alternDict||[],n=function(e,t,i){var r,s,n;if(!1!==t){try{n=JSON.parse(e)}catch(t){n=e}for(r in n)void 0!==(s=n[r]).url&&""!==s.url&&"http"!==s.url.substring(0,4)&&(s.url=this.alternUrl+s.url),this.alternDict[r]=s}},a=0;a<s.length;++a)""!==(r=s[a])&&"http"!==r.substring(0,4)&&(r=this.alternUrl+r),v.download(r,{responseType:"json"},1,function(e,t,i,r){r(t,e,i)},void 0,n.bind(this));m.addCallback("SiroccoBuild",function(){return this.numBuild}.bind(this)),m.addCallback("SiroccoBuildGeom",function(){return this.numGeomTotal}.bind(this)),this.stridAttribute=void 0!==this.factory.stridAttribute?this.factory.stridAttribute:"STRID",this._uidAttributName=this.stridAttribute,this._uidListeners=this.miDToTile,this.buildTimeOut=void 0,this.filters=[],this.eachs=[]},dispose:function(){for(var e in m.warn("Dispose: Sirocco"),clearTimeout(this.buildTimeOut),this.mgeomToTile)this.geometryRemoved(this.mgeomToTile[e]);this.factory.dispose(),this.factory=void 0},getGeometry:function(e){var t=this.miDToTile[e];if(t)return t.geometry},cleanInfo:function(e,t,i){if(e){var r=!0;if(e.geom){for(var s=e.geom.length-1;s>=0;--s)e.geom[s].mesh.parents&&0!==e.geom[s].mesh.parents.length?e.geom[s].mesh.parents[0].storeKey===i&&e.geom.splice(s,1):e.geom.splice(s,1);0===e.geom.length?e.geom=void 0:r=!1}else e.geom=void 0;if(r){if(e._observers){for(s=0;s<e._observers.length;s++)e._observers[s](e);e._observers=void 0}if(e.listeners){for(s=0;s<e.listeners.length;s++)e.listeners[s](void 0);this.miDToTile[t]={strid:t,listeners:e.listeners}}else delete this.miDToTile[t]}else if(e.listeners)for(s=0;s<e.listeners.length;s++)e.listeners[s](e,!0)}else delete this.miDToTile[t]},geometryRemoved:function(e){if(e.userData&&e.userData.records){for(var t=e.userData.records,i=t.length;i--;){var r=t[i].strid,s=this.miDToTile[r];this.cleanInfo(s,r,e.storeKey)}e.userData=void 0}},addObserver:function(e){void 0===e.observers&&(e.observers=[]),e.observers.push(this.geometryRemoved.bind(this))},rebuild:function(e,t){if(h.is(e)&&h.is(e.value))if(h.is(e.value.node)&&h.is(e.value.node.userData)){var i=e.value.node.userData.source;this.buildDataSourceV2(this.urban,i,e)}else if(h.is(e.value.userData)){i=e.value.userData.source;this.buildDataSourceV2(this.urban,i,e)}else{if(h.is(t)){if(t>2)return}else t=1;t++,g.subscribeTo("/3DEXPERIENCity/onPostUpdate",this.rebuild.bind(this,e,t),!0)}},reset:function(e){if(e)this.rebuild(e);else{for(;this.eachs.length;)this.eachs.pop();for(;this.filters.length;)this.filters.pop()}},each:function(e,t){t?this.rebuild(t):this.eachs.push(e)},filter:function(e,t){t?this.rebuild(t):this.filters.push(e)},register:function(e,t){var i=this._uidListeners[e];i?(i.listeners?i.listeners.push(t):i.listeners=[t],i.tile&&t(i)):this._uidListeners[e]={strid:e,listeners:[t]}},unregister:function(e,t){var i=this._uidListeners[e];if(i&&i.listeners){for(var r=-1,s=0;s<i.listeners.length;++s)if(i.listeners[s].name===t.name){r=s;break}r>-1&&(i.listeners.splice(r,1),0===i.listeners.length&&this._uidListeners!==this.miDToTile&&delete this._uidListeners[e])}},buildV2:function(e,t,i,r,s){if("string"==typeof s)var n=e.loadDataSource(s);else if(void 0!==s.cluster&&null!==t)n=t.loadDataSourceFromObject(s);else n=e.loadDataSourceFromObject(s);this.buildDataSourceV2(i,n,r)},_intersectCropBBox:function(e,t,i){return void 0!==this.urban.cropBox&&this.urban.cropBox.intersectIJ(e,t,i)},buildDataSourceV2:function(t,i,s){var a=i.count;if(h.is(s.value)&&h.is(s.value.node)?(s.value={node:s.value.node,nbFeatures:a},this.geometryRemoved(s.value.node)):s.value={node:null,nbFeatures:a},0!==a){var f=s.tile.LOD,v=s.tile.I,_=s.tile.J;i.index=0;(new Date).getTime();var y=0,b=this._uidAttributName!==this.stridAttribute,x=0,C=[],S=!1;i.tile={LOD:f,I:v,J:this.invertY?(1<<f)-1-_:_,key:s.tile.key,factory:this},i.idDataSource=this.factory._node.idDataSource;var D=this._intersectCropBBox(i.tile.LOD,i.tile.I,i.tile.J),P=this,w={ltileGeoms:{},infos:{}};w.tile=i.tile;var M=[],T=[],I=function(e){listeners.infos.splice(listeners.infos.indexOf(e),1)},R=function(e,t){if(e.storeKey=s.key,e instanceof n&&!0===e.pickable){e.show();var i,r,a,o,l=e.getPrimitives();if(e.isInstanceNode3D){var d=e.mesh3js.userData.cgmIds;if(a=l[0].sgNode,void 0!==d){for(var u=d.length-1;u>=0;--u)if(o=t[d[u]]){if(o.geom?o.geom.push({subElement:a,mesh:e}):o.geom=[{subElement:a,mesh:e}],!h.is(o.listeners)){var c=this._uidListeners[d[u]];h.is(c.listeners)&&(o.listeners=[],o.listeners.push(c.listeners))}if(o.listeners&&o.listeners.length>0)for(i=0;i<o.listeners.length;++i)void 0!==(r=o.listeners[i])&&r(o)}var p=function(){for(var i=d.length-1;i>=0;--i)if((o=t[d[i]])&&o.geom){for(var r=[],s=0;s<o.geom.length;s++){o.geom[s].mesh.id!==e.id&&r.push(o.geom[s])}o.geom=r}};e.observers&&e.observers.push(p)}}else{for(u=0;u<l.length;u++)if(a=l[u].sgNode,t&&t.strid&&(a.cgmIdOld=a.getCgmId(),a._setCgmId(t.strid)),o=t[a.getCgmId()]){if(o.geom?o.geom.push({subElement:a,mesh:e}):o.geom=[{subElement:a,mesh:e}],!h.is(o.listeners)){c=this._uidListeners[a.getCgmId()];h.is(c&&c.listeners)&&(o.listeners=[],o.listeners.push(c.listeners))}if(o.listeners&&o.listeners.length>0)for(i=0;i<o.listeners.length;++i)void 0!==(r=o.listeners[i])&&r(o)}p=function(){for(u=0;u<l.length;u++)if(a=l[u].sgNode,t&&t.strid&&(a.cgmIdOld=a.getCgmId(),a.cgmId=t.strid),(o=t[a.getCgmId()])&&o.geom){for(var i=[],r=0;r<o.geom.length;r++){var s=o.geom[r].mesh;s&&s.id!==e.id&&i.push(o.geom[r])}o.geom=i}};e.observers&&e.observers.push(p)}}},A=function(e,t,i,r){if(i){t.posTile?e.posSize.center.getPositionFromMatrix(t.getMatrix()).add(t.bSphere.center).add(t.posTile):e.posSize.center.getPositionFromMatrix(t.getMatrix()).add(t.bSphere.center),t.children&&t.children.length>0&&(t=t.children[0]),e.posSize.altitude+=t.bBox.min.z,e.posSize.height=t.bBox.max.z-t.bBox.min.z,e.posSize.width=t.bBox.max.y-t.bBox.min.y,e.posSize.length=t.bBox.max.x-t.bBox.min.x;var s={};s[e.strid]=e,s.strid=e.strid,t.traverse(R.bind(this),s)}},F=function(e,t,i,r){if(null==i){if(null!=t&&null!=e){if(t!=e)return Date.parse(e)>Date.parse(r)&&Date.parse(t)<=Date.parse(r);var s=new Date(Date.parse(e));return s.setDate(s.getDate()+1),s>Date.parse(r)&&Date.parse(t)<=Date.parse(r)}return null!=t?Date.parse(t)<Date.parse(r):null==e||Date.parse(e)>Date.parse(r)}return Date.parse(r)==Date.parse(i)},L=function(){if(!P.factory.isReady||P.factory.isReady()){var n=Date.now(),f=0;if(P.numBuild++,P.intervalFuncCall++,x<a){var v=new o.Feature,_=2e3;P.urban.USR.viewpoint.camMoved&&(_=1e3);for(var V=x,O=0;x<a&&_>f+O&&null!==(v=i.getNextFeature(v));){x++;for(var N=!1,U=0;U<P.filters.length&&!N;U++)N=P.filters[U](v);if(!N){for(var E=0;E<P.eachs.length;E++)v=P.eachs[E](v);if(v.getGeometry())if(!P.urban._timefilter||1!=P.factory.isFilteredByTime||F(v.getAttribute(P.factory.lifespanenAttribute),v.getAttribute(P.factory.lifespanstAttribute),v.getAttribute(P.factory.lifespanAttribute),t.date._date)){P.numGeomTotal++;var k=v.getAttribute(P.stridAttribute),z=P.miDToTile[k];if(P.previewMode||P.clusteringMode||"searchRequest"===s.key){if(v.getGeometry().type!==o.Type.POINT&&v.getGeometry().type!==o.Type.MULTIPOINT){var B=v.getGeometry().aabbox.center;if(B.x<s.bbox.xmin||B.x>s.bbox.xmax||B.y<s.bbox.ymin||B.y>s.bbox.ymax)continue}}else if(void 0!==z&&z.tile&&(z.tile.LOD!==i.tile.LOD||z.tile.I!==i.tile.I||z.tile.J!==i.tile.J))continue;if(!1===D||!0===v.getGeometry().isInAABBOX(P.urban.cropBox)){var j,X;for(y++,i.list[x-1].cropped=!1,z?(z.tile=i.tile,z.bbox=s.bbox):z={strid:k,tile:i.tile,bbox:s.bbox,listeners:null},h.is(P.factory.geoJSON)&&(P.factory.geoJSON[k]=ee([i.list[i.index-1]])),z.posSize={center:new r.Vector3,altitude:0,height:0,width:0,length:0},z.userData={},X=(j=v.getAttributeKeys()).length;X--;)z.userData[j[X]]=v.getAttribute(j[X]);if(P.miDToTile[k]=z,C.push(z),k in P.alternDict){var G=P.alternDict[k];G.color=v.getAttribute("color"),z.userData={};for(var W=Object.keys(G),H=0,J=W.length;H<J;H++)z.userData[W[H]]=G[W[H]];if(z.strid=k,1===G.altern){var q=e.clone(G);q.rendering=P.factory._rendering;var Y=P.urban.modelLoader.load(q,A.bind(P,z));T.push(Y)}}else if(w.infos[k]=z,(P.factory instanceof d||P.factory instanceof u||P.factory instanceof c||P.factory instanceof p)&&(w.indexPrimitive=A.bind(P,z)),!1===P.urban.USR.workers||void 0===P.factory.supportWorkers||!1===P.factory.supportWorkers?P.factory.buildOne(v,w,z,P.clusteringMode?i.isCluster?0:1:void 0):void 0!==P.factory.initOne&&P.factory.initOne(v,w,z),z.listeners)M.push(z);else if(b){var K=P._uidListeners[v.getAttribute(P._uidAttributName)];K?M.push(z):K={infos:[],listeners:null},K.infos.push(z),z._observers.push(I)}}else i.list[x-1].cropped=!0;O=(f=Date.now()-n)/(x-V)}else S||(S=!0)}}v||(a=x),!0===P._synchrone?L():g.subscribeTo("/3DEXPERIENCity/onPostUpdate",L,!0)}else{if(P.time=(new Date).getTime()-n,P.timeTotal+=P.time,0===y){if(h.is(s.value)&&h.is(s.value.node)){var Q=s.value.node.getParents(),Z=Q.length;if(!S)for(;Z--;)Q[Z].removeChild(s.value.node);s.value.node.observers=void 0,s.oldValue.push(s.value.node)}return void(s.value={node:null,userData:{records:C,source:i},nbFeatures:0})}var $=function(){var e=P.factory.getData(w);if(w.nbFeature?w.nbFeature:w.nbElement?w.nbElement:w.infos?Object.keys(w.infos).length:(0,m.warn("PatchVector did not build any feature.")),e.idDataSource=P.factory._node.idDataSource,e.storeKey=h.getQuadKey(w.tile.LOD,w.tile.I,w.tile.J),h.is(e)){e.traverse(R.bind(P),w.infos);for(var t=0;t<T.length;t++)m.log("add altern "),e.add(T[t]);P.addObserver(e),e.userData={records:C,source:i};for(var r=0;r<M.length;r++)for(var o=0;o<M[r].listeners.length;o++)M[r].listeners[o](M[r]);if(P.time=(new Date).getTime()-n,P+=P.time,e.storeKey=s.key,h.is(s.value)&&h.is(s.value.node)){for(var l=s.value.node.getParents(),d=l.length;d--;)l[d].removeChild(s.value.node),l[d].addChild(e);s.value.node.observers=void 0,s.oldValue.push(s.value.node)}}s.value={node:e,nbFeatures:a},this.urban._timefilter&&(s.value.userData={records:C,source:i})}.bind(P);!0===P.urban.USR.workers&&!0===P.factory.supportWorkers?P.factory.buildAll(w,i.list,$):$()}}else g.subscribeTo("/3DEXPERIENCity/onPostUpdate",L,!0);function ee(e){var t;t=P.factory instanceof c?"Polygon":P.factory instanceof p?"LineString":"Point";var i=0;if(e[0].metas){for(;i<e[0].metas.length&&"geometry"!==e[0].metas[i].name&&"gdal_default_geo"!==e[0].metas[i].name;)i++;var r=e[0].metas[i].value,s=l.fromWKTToArray(r);return r.contains("MULTI")||(s=[s]),l.fromArrayToJSON(s,t)}return{type:"FeatureCollection",features:e}}};!0===P._synchrone?L():g.subscribeTo("/3DEXPERIENCity/onPostUpdate",L,!0)}},load:function(e,t,i,r,s,n){this.featureLayer.load(i,t)},getUidListeners:function(){return this._uidListeners},_debug:function(e){return"time  : "+this.time+"<br />time/(1000 crossquad)  : "+Math.ceil(1e3*this.timeTotal/this.numGeomTotal)}})}),define("DS/XCityLoaders/StreamVisuV2Loader",["DS/Visualization/ThreeJS_DS","DS/Visualization/ThreeDXLoader","DS/XCityLoaders/StreamVisuLoader","DS/XCityLoaders/ModelLoader"],function(e,t,i,r){"use strict";var s=i.extend({init:function(e,i){this._parent(e,i),this.loader=new t,this.loader.setMode("3dxc"===i.extension?"concat":"zipped")},_generateObjectToLoad:function(){this.model.node.isCoreReady=!1;var t={oldFlipTexture:!0,url:this.model.url+(this.model.urlOptions?this.model.urlOptions:""),urlOptions:this.model.urlOptions,destinationNode:this.model.node,nodeCallback:this._nodeCallback,doneCallback:function(t){if(this.model.node){var i=this.loader.modelsToLoad[0].json;if(i&&i.materials&&i.materials[0]&&this.loader.modelsToLoad[0].data&&this.loader.modelsToLoad[0].data.materials[0]&&(this.loader.modelsToLoad[0].data.materials[0]._transparent=i.materials[0].transparent),i&&i.userData&&i.userData.cityData&&i.userData.cityData.matrix&&!0===this.model.terrain){var r=new e.Matrix4,s=i.userData.cityData.matrix;r.set(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8],s[9],s[10],s[11],s[12],s[13],s[14],s[15]),r.transpose(),r=this.model.node.getMatrix().multiply(r),this.model.node.setMatrix(r)}this._isTextured()?this.model.node.setVisibility(!1):this.model.node.isCoreReady=!0,this._doneCallback()}}.bind(this),onTexturesLoadedCallback:function(){this.model.node.setVisibility(!0),this.model.node.isCoreReady=!0}.bind(this)};return this._addCustomShaders(t),t}});return r.formatLoaders["3dxc"]=s,r.formatLoaders["3dx"]=s,s}),define("DS/XCityGeometry/PatchVectorFactoryGeometry",["UWA/Class","DS/XCityGeometry/PatchVectorFactoryPolygon","DS/XCityGeometry/PatchVectorFactoryLine","DS/XCityGeometry/PatchVectorFactoryPointOfInterest3D","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/XCityTools/Geocoder","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityLayer/Vector","DS/XCityGeometry/Polygon","DS/XCityTools/Debug","DS/XCityRendering/RenderingHandlerProxy","DS/xCityBasicUtils/Utils","DS/XCityGeometry/PatchVectorFactory"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m){"use strict";var g=m.extend({init:function(e,s){this._parent(e,s),this.urban=e,this._node=new a,this._node.name="FactoryGeometry",this._node.hwInstancing=!0;this._factoryPoint=new r(e,{shapeType:"sphere",nameAttribute:"name",heightAttribute:10,renderAnchor:!0,switchDistance:500}),this._factoryLine=new i(e,s),this._factoryPolygon=new t(e,s),this._rendering=new p(e,s),this._rendering.addSubRenderingHandler(this._factoryPoint._rendering),this._factoryPoint._rendering._proxyHandler=this._rendering,this._rendering.addSubRenderingHandler(this._factoryLine._rendering),this._rendering.addSubRenderingHandler(this._factoryPolygon._rendering),this._isReady=!0,c.log("PatchVectorFactoryGeometry:init")},isReady:function(){return this._isReady},destroy:function(){this.urban.getView3D().getScene().remove(this._node),this._factoryPoint.destroy(),this._factoryLine.destroy(),this._factoryPolygon.destroy()},dispose:function(){},getData:function(e){var t=new a,i=this._factoryPoint.getData(e.sessionPoint);i.indexMesh=0,t.addChild(i);var r=this._factoryLine.getData(e.sessionLine);r.indexMesh=1,t.addChild(r);var s=this._factoryPolygon.getData(e.sessionPolygon);return s.indexMesh=2,t.addChild(s),t},buildOne:function(e,t,i,r){t.sessionPoint||t.sessionLine||t.sessionPolygon||(t.sessionPoint={tile:t.tile,infos:t.infos},t.sessionLine={tile:t.tile,infos:t.infos},t.sessionPolygon={tile:t.tile,infos:t.infos,ltileGeoms:{}}),this._factoryPoint.patch||(this._factoryPoint.patch=this.patch,this._factoryLine.patch=this.patch,this._factoryPolygon.patch=this.patch);var s=e.getGeometry();s.type===d.Type.POINT||s.type===d.Type.MULTIPOINT?this._factoryPoint.buildOne(e,t.sessionPoint,i,r):s.type===d.Type.LINESTRING||s.type===d.Type.MULTILINESTRING?this._factoryLine.buildOne(e,t.sessionLine,i):s.type!==d.Type.POLYGON&&s.type!==d.Type.MULTIPOLYGON||this._factoryPolygon.buildOne(e,t.sessionPolygon,i)},_getPrimInfoFromPreview:function(e){}});return Object.defineProperty(g.prototype,"_clusterSteps",{get:function(){return this._factoryPoint._clusterSteps},set:function(e){this._factoryPoint._clusterSteps=e}}),Object.defineProperty(g.prototype,"_minimumHits",{get:function(){return this._factoryPoint._minimumHits},set:function(e){this._factoryPoint._minimumHits=e}}),g}),define("DS/XCityGeometry/PatchVectorCityFormat",["UWA/Class","DS/XCityGeometry/PatchVector","DS/XCityLoaders/CityLoader"],function(e,t,i){"use strict";return e.extend(t,{init:function(e,t,i){this._parent(e,t,i)},buildV2:function(e,t,i,r,s){var n;e?(n=e.loadDataSource(s),this.buildDataSourceV2(t,n,r)):this.buildCity(t,r,s,i)},buildCity:function(e,t,r,s){t.tile;var n=new i(e);n.model.url=t.url,n.model.patch=this,n.model.geolocalized=s,n.model.rendering=this.factory._rendering;var a=n._initRenderingCallback();n.model.callback=Utils.is(a)?a:n.model.callback,n.processBin(!0,r),this._triggerListeners(),t.value={node:n.model.node},n.model.node.storeKey=t.key},_triggerListeners:function(){for(var e in this._uidListeners)if(this._uidListeners[e].listeners&&this._uidListeners[e].listeners.length>0)for(var t=0;t<this._uidListeners[e].listeners.length;++t)this._uidListeners[e].listeners[t](this._uidListeners[e])}})}),define("DS/XCityLoaders/DefaultLoader",["DS/Visualization/ModelLoader","DS/Visualization/ThreeJS_DS","DS/XCityLoaders/BaseLoader","DS/XCityLoaders/ModelLoader","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s){"use strict";var n=i.extend({init:function(t,i){this._parent(t,i),this.loader=new e(this.urban.USR.webGLV6Viewer.getWebGLContext(),!1),this.loader.setSceneGraph(this.model.node)},load:function(e,t){return this._parent(e,t),this._loadWithDefaultLoader()},_loadWithDefaultLoader:function(){var e=this.model.callback;if(void 0!==e){this.loader,this.model;this.loader.setOnLoadedCallback(this._onModelLoadedCb.bind(this,e,!0)),this.loader.setOnErrorCallback(e.bind(this,this.model.node,!1,this.model.name))}var t=this.model.url+(this.model.urlOptions?this.model.urlOptions:"");this.loader.loadModel(this.model.spec||t,this.model.node);this.model.scale;return this.model.node},_onModelLoadedCb:function(e,t){if(this._needCustomShaders()){var i=this._applyChunks(this.model);this._applyMaterial(this.model.node,i)}e(this.model.node,t,this.model.name)},_applyChunks:function(e){var t=e.shader,i=this._getMainMaterial(e.node);return this._getModelMaterial(t,i,e)},_getMainMaterial:function(e){if(s.is(e))return s.is(e.children[0])?s.is(e.children[0].material)?e.children[0].material:this._getMainMaterial(e.children[0]):e.material||e.mesh3js.material},_applyMaterial:function(e,t){s.is(e)&&s.is(t)&&s.is(e.children)&&(0!==e.children.length?(e.material=this._assignMaterial(e.material,t),this._recurseOnChildrenNodes(e.children,t)):s.is(e.mesh3js)&&(e.mesh3js.material=this._assignMaterial(e.mesh3js.material,t),this._assignMaterialOnDrawingGroups(e.mesh3js,t)))},_assignMaterial:function(e,t){return s.is(e)&&(e=t),e},_recurseOnChildrenNodes:function(e,t){for(var i=0;i<e.length;i++)this._applyMaterial(e[i],t)},_assignMaterialOnDrawingGroups:function(e,t){if(this._hasDrawingGroups(e))for(var i=e.geometry[0].drawingGroups,r=0;r<i.length;r++)this._replaceDrawingGroup(i[r],t)},_replaceDrawingGroup:function(e,t){e.gas=t,e.material&&e.material&&(e.material=t)},_hasDrawingGroups:function(e){return s.is(e.geometry)&&s.is(e.geometry[0])&&s.is(e.geometry[0].drawingGroups)}});return r.formatLoaders.defaultLoader=n,n}),define("DS/XCityLoaders/XCityLoader",["DS/XCityLoaders/ModelLoader","DS/XCityLoaders/CityLoader","DS/XCityLoaders/ColladaLoader","DS/XCityLoaders/DefaultLoader","DS/XCityLoaders/PointCloudLoader","DS/XCityLoaders/StreamVisuV1Loader","DS/XCityLoaders/StreamVisuV2Loader"],function(e,t,i,r,s,n){return e}),define("DS/XCityModel/LineSet",["DS/XCityModel/AbstractSet","DS/XCityModel/Item","DS/XCityLayer/Vector","DS/xCityBasicUtils/Utils","DS/XCityGeometry/PatchVectorFactoryLine","DS/XCityTools/Geocoder","DS/XCityTools/Debug"],function(e,t,i,r,s,n,a){"use strict";var o=e.extend({metaData:{type:"Geometry",className:"LineSet"},loaderJSON:{geojson:"loadJSONObject",animation:"loadJSONObject"},setup:function(){this._parent(),this._node.name="lineSetFeature"},_processMultiTypeGeometry:function(e,t,i){let r=!0;for(var s=e.geometryList,a=0;a<s.length&&(r||t!==this.urban.baseProjection);++a){let e=s[a].vertexList;for(var o=0;o<e.length&&(r||t!==this.urban.baseProjection);++o){if(t!==this.urban.baseProjection){let i=n.proj(e[o],t,this.urban.baseProjection);e[o].x=i.x,e[o].y=i.y}r&&e[o].x>i.xmin&&e[o].x<i.xmax&&e[o].y>i.ymin&&e[o].y<i.ymax&&(r=!1,this.nbMultiGeometry++,this.nbMultiGeometrySession++)}}return r},_processSimpleTypeGeometry:function(e,t,i){let r=!0,s=e.vertexList;for(var a=0;a<s.length&&(r||t!==this.urban.baseProjection);++a){if(t!==this.urban.baseProjection){let e=n.proj(s[a],t,this.urban.baseProjection);s[a].x=e.x,s[a].y=e.y}r&&s[a].x>i.xmin&&s[a].x<i.xmax&&s[a].y>i.ymin&&s[a].y<i.ymax&&(r=!1,this.nbGeometry++,this.nbGeometrySession++)}return r},_handleOnNextBatchReady:function(e,t){t[this.receivedSessionId].lines=e.lines,this.webWorkersData.lineCreator.primitiveList=JSON.parse(this.webWorkersData.lineCreator.primitiveList),this.webWorkersData.lineCreator.color.buffer.data=new Float32Array(this.webWorkersData.lineCreator.color.buffer.data),this.webWorkersData.lineCreator.position.buffer.data=new Float32Array(this.webWorkersData.lineCreator.position.buffer.data),this.webWorkersData.lineCreator.vertexBindingArray.buffer.data=new Uint32Array(this.webWorkersData.lineCreator.vertexBindingArray.buffer.data),this.webWorkersData.textureInfoCreator.data=new Float32Array(this.webWorkersData.textureInfoCreator.data)},_prepareDataForWorkers:function(e){let t=[],r=this._inputCRS,s=this,o=this._savedDatasource;o.index=0;let l=new Promise((e,t)=>{n.loadProjection(s.urban.baseProjection,function(i){i?(e(),s.preloadedUrbanProj=Object.assign({},n.projections[s.urban.baseProjection].proj4js),delete s.preloadedUrbanProj.forward,delete s.preloadedUrbanProj.init,delete s.preloadedUrbanProj.inverse):(a.error("Failed loading projection: "+s.urban.baseProjection),t("Failed loading projection: "+s.urban.baseProjection))})});t.push(l);let h=new Promise((e,t)=>{n.loadProjection(r,function(i){i?(e(),s.preloadedInputCRS=Object.assign({},n.projections[r].proj4js),delete s.preloadedInputCRS.forward,delete s.preloadedInputCRS.init,delete s.preloadedInputCRS.inverse):(a.error("Failed loading projection: "+r),t("Failed loading projection: "+r))})});t.push(h);let d=new i.Feature,u=[];return"ground"===this._rendering.currentRendering.renderingData.elevationMode&&void 0!==this._rendering.currentRendering.renderingData.elevationOffset&&(o.list.forEach(e=>{o.getNextFeature(d);let t=d.getGeometry();t.type===i.Type.LINESTRING&&e.geometry.coordinates.forEach(e=>{u.push(s.urban.USR.getGroundHeight(e[0],e[1]))}),t.type===i.Type.MULTILINESTRING&&e.geometry.coordinates.forEach(e=>{e.forEach(e=>{u.push(s.urban.USR.getGroundHeight(e[0],e[1]))})})}),o.index=0),this.precomputedZValues=u,t},create:function(e){this._urban=e._urban,this._geometrySTRIDName="line",this._builderWorker=this._urban.lineSetWorker,this._parallelBuilderFunName="buildLineSet",this._geometryName="linestring",this._multiGeometryName="multilinestring",this._geometryVectorMultiType=i.Type.MULTILINESTRING,this._geometryVectorType=i.Type.LINESTRING,this._maxGeometryPreview="maxLinePreview",this._webWorkersDataName="creatorsFromWorker";const t={stridAttribute:this.get("stridAttribute")};return this._factory=new s(this._urban,t),this._parent(e)},_setElevationAttributesFromMaterials:function(e,...t){var i,r,s=["elevationMode","elevation","elevationOffset"],n={},a=1,o=0,l=1;for(let e in s)n[s[e]]=a,o|=a,a<<=1;for(let a in t)for(let h in s)if(i=h=s[h],r=t[a],i in r&&void 0!==r[i]&&null!==r[i]&&(e[h]=t[a][h],o===(l|=n[h])))return},_shouldCreateLabelFromMaterial:function(e){return e.label&&!0===e.label.enable&&r.is(e.label.name)&&""!==e.label.name}});return t.ObjectContructor.LineSet=o}),define("DS/XCityModel/GeometrySet",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityModel/Item","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/VectorLoaderEnovia","DS/XCityLayer/Vector","DS/xCityBasicUtils/Utils","DS/XCityModel/PointOfInterest3DSet","DS/XCityModel/LineSet","DS/XCityModel/PolygonSet","DS/XCityModel/LayerVectorPrimitive","DS/XCityTools/EventDispatcher","DS/XCityTools/Geocoder","DS/XCityTools/Downloader","DS/XCityTools/ExpressionEvaluator","DS/XCityTools/Disposer","DS/XCityRendering/RenderingHandlerProxy","DS/XCityTools/RenderingTools"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m,g,v,_){"use strict";var y=r.extend({defaults:{SUB_REND_HANDLER_LINE_INDEX:1,SUB_REND_HANDLER_POLY_INDEX:2,SUB_REND_HANDLER_POINT_INDEX:0,url:"",geojson:null,type:"json",Coordinate:null,renderID:"",Rendering:null,Clustering:null,objectId:"",serviceId:"",stridAttribute:"STRID",interactionBehaviours:{onSelect:{label:!0},onHover:{label:!0}}},metaData:{type:"Geometry",className:"GeometrySet"},loaderJSON:{Clustering:"loadJSONClustering",geojson:"loadJSONObject",animation:"loadJSONObject"},loadJSONClustering:function(e,t,i,r){i.className&&"Clustering"!==i.className||this.set(t,{enable:i.enable,nbSteps:i.nbSteps,minimumHits:i.minimumHits})},setup:function(){this._parent(),this._node=new t,this._node.name="geometrySetFeature",this.loaderJSON||(this.loaderJSON={}),this.heightMatrix=new e.Matrix4,this._poiSet=new l({geometrySet:this}),this._lineSet=new h,this._polygonSet=new d,this.analytics=null},destroy:function(e){c.unsubscribe(this.onPointLoadedToken),c.unsubscribe(this.onLineLoadedToken),c.unsubscribe(this.onPolygonLoadedToken),c.unsubscribe(this.onPointUpdatedToken),c.unsubscribe(this.onLineUpdatedToken),c.unsubscribe(this.onPolygonUpdatedToken),this._poiSet.destroy(this),delete this._poiSet,this._lineSet.destroy(this),delete this._lineSet,this._polygonSet.destroy(this),delete this._polygonSet,delete this._rendering,delete this.heightMatrix,e.getNode3D().remove(this._node),g.disposeV6(this._node),this._parent(e)},getNode3D:function(){return this._node},create:function(e){if(this._urban=e._urban,!this._parent(e))return c.publish(c.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this.renderingProfileManager=this._urban.getRenderingProfileManager(),e.getNode3D().add(this._node),this._poiSet.setItemParent(this._itemParent),this._lineSet.setItemParent(this._itemParent),this._polygonSet.setItemParent(this._itemParent),this.get("stridAttribute")&&(this._poiSet.set("stridAttribute",this.get("stridAttribute")),this._lineSet.set("stridAttribute",this.get("stridAttribute")),this._polygonSet.set("stridAttribute",this.get("stridAttribute"))),this._poiSet._attributes.id=this.get("id")+"_point",this._lineSet._attributes.id=this.get("id")+"_line",this._polygonSet._attributes.id=this.get("id")+"_polygon",this._nbLayerBuilt=0;var t=this,i=function(e){o.is(e)&&("boolean"==typeof e||(e.success,e.item)),t._nbLayerBuilt++,3===t._nbLayerBuilt&&(t.get("Clustering")&&t.setClustering(t.get("Clustering")),c.publish(c.eventsList.onLoaded+":"+t.get("id"),{success:!0,item:t.getItemParent()}))},r={loaded:1,total:1},s={loaded:1,total:1},n={loaded:1,total:1},a=function(e){var i=r.loaded+s.loaded+n.loaded,a=r.total+s.total+n.loaded;t.set("loadInfo",{loaded:i,total:a})};this.onPointLoadedToken=c.subscribeTo(c.eventsList.onLoaded+":"+this.get("id")+"_point",i),this.onLineLoadedToken=c.subscribeTo(c.eventsList.onLoaded+":"+this.get("id")+"_line",i),this.onPolygonLoadedToken=c.subscribeTo(c.eventsList.onLoaded+":"+this.get("id")+"_polygon",i),this.onLineUpdatedToken=c.subscribeTo(c.eventsList.onUpdate+":"+this.get("id")+"_line",function(e){r=e,a()}),this.onPolygonUpdatedToken=c.subscribeTo(c.eventsList.onUpdate+":"+this.get("id")+"_polygon",function(e){s=e,a()}),this.onPointUpdatedToken=c.subscribeTo(c.eventsList.onUpdate+":"+this.get("id")+"_point",function(e){n=e,a()});t=this;var l=function(e,i){if(i)t._poiSet._attributes.geojson=e,t._lineSet._attributes.geojson=e,t._polygonSet._attributes.geojson=e,t._poiSet.create(t),t._lineSet.create(t),t._polygonSet.create(t),t.getLayerAttributes(),t._rendering.addSubRenderingHandler(this._poiSet.getRendering(),this.get("SUB_REND_HANDLER_POINT_INDEX")),t._rendering.addSubRenderingHandler(this._lineSet.getRendering(),this.get("SUB_REND_HANDLER_LINE_INDEX")),t._rendering.addSubRenderingHandler(this._polygonSet.getRendering(),this.get("SUB_REND_HANDLER_POLY_INDEX")),t._rendering.setContent(t);else if(e){e instanceof ArrayBuffer&&(e=(new TextDecoder).decode(e));var r=JSON.parse(e);t.serviceError=r,c.publish(c.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()})}}.bind(this);this._rendering=new v(this._urban,{});var h=this.get("serviceId"),d=this.get("objectId"),u=this._urban.baseProjection.split(":");if(u=u[u.length-1],void 0!==d&&""!==d&&void 0!==h&&""!==h)"3DSpace"===h?f.downloadFrom3DSpace(d,!0).then(function(e){e&&e.needServiceSidePreview?f.download(f.getDataSupplierUrl(!0)+"togeojson?serviceId=3DSpace&objectId="+d+"&outputEPSG="+u+"&tenant="+f._platformID,{type:"arraybuffer"},99999,function(e,t,i,r){r(t,e,i)},void 0,l):l(e,!0)}):"3DDrive"===h&&f.downloadFrom3DDrive(d,!0).then(function(e){e&&e.needServiceSidePreview?f.download(f.getDataSupplierUrl(!0)+"togeojson?serviceId=3DDrive&objectId="+d+"&outputEPSG="+u+"&tenant="+f._platformID,{type:"arraybuffer"},99999,function(e,t,i,r){r(t,e,i)},void 0,l):l(e,!0)});else if(""!==this.get("url")){var p=this.get("url");f.download(p,{type:"arraybuffer"},99999,function(e,t,i,r){r(t,e,i)},void 0,l)}else null!==this.get("geojson")&&(t._poiSet._attributes.geojson=this.get("geojson"),t._lineSet._attributes.geojson=this.get("geojson"),t._polygonSet._attributes.geojson=this.get("geojson"),t._poiSet.create(t),t._lineSet.create(t),t._polygonSet.create(t),t._rendering.addSubRenderingHandler(this._poiSet.getRendering()),t._rendering.addSubRenderingHandler(this._lineSet.getRendering()),t._rendering.addSubRenderingHandler(this._polygonSet.getRendering()));return this._factory=!0,!0},get:function(e){var t,i,r=this.getRendering();if(this.renderingProfileManager&&o.is(r)&&r.hasAttribute(e)){if(i=this._rendering._getMaterialInfo(),o.is(i)){t=(i=_.getJSONFromRendering(i))[e];let s=function(t,i){let s=_.getJSONFromRendering(r._subRenderingHandler[i]._getMaterialInfo())[e];return s||t};this._lineSet.nbBuiltTotal&&this._lineSet.nbBuiltTotal>0&&(t=s(t,this.get("SUB_REND_HANDLER_LINE_INDEX"))),this._poiSet.nbBuiltTotal&&this._poiSet.nbBuiltTotal>0&&"stroke"!==e&&(t=s(t,this.get("SUB_REND_HANDLER_POINT_INDEX"))),this._polygonSet.nbBuiltTotal&&this._polygonSet.nbBuiltTotal>0&&(t=s(t,this.get("SUB_REND_HANDLER_POLY_INDEX")))}}else t=this._parent(e);return t},set:function(e,t){if("renderID"===e||"id"===e||"interactionBehaviours"===e){let i=e;this._polygonSet.set(i,t),this._poiSet.set(i,t),this._lineSet.set(i,t)}var i={},r=this.getRendering();this.renderingProfileManager&&o.is(r)&&r.hasAttribute(e)?(i[e]=t,this.setMaterial(i)):this._parent(e,t)},getLocalPosition:function(){var e=this._node.getBoundingSphere().center;return this.get("Coordinate")&&e.add(this.get("Coordinate").getLocalPosition()),e},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},_updateCoordinate:function(){var e=this.previous("Coordinate");e&&e.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")?(this.get("Coordinate").setItemParent(this),this._updateMatrix(this.get("Coordinate")._matrix),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this)):this._updateMatrix()},_itemParentVisible:function(e){this._created},setItemParent:function(e){this._itemParent&&this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._parent(e),this._itemParent&&this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this)},_updateMatrix:function(e){this._node.setMatrix(e)},_setVisible:function(e){var t=!!e.get("visible");this._poi&&(t?this._node.addChild(this._poi):this._node.removeChild(this._poi))},createPrimitive:function(e,t){var i,r=this,s=void 0,n=void 0;if(void 0!==this._poiSet.primInfos[e]){if(s=this._poiSet._factory,n=this._poiSet.primInfos[e],r=this._poiSet,void 0===t){var a=function(t){if(t.mesh3js){for(var i=t.mesh3js.userData.cgmIds,r=-1,s=0;s<i.length;++s)if(i[s]===e){r=s;break}if(r>-1)return 5*r+5}}.bind(this);t=this._poiSet._node.traverse(a)}}else void 0!==this._lineSet.primInfos[e]?(s=this._lineSet._factory,n=this._lineSet.primInfos[e],r=this._lineSet):void 0!==this._polygonSet.primInfos[e]&&(s=this._polygonSet._factory,n=this._polygonSet.primInfos[e],r=this._polygonSet);let o=!1;if(this._polygonSet._itemParent._attributes.children){let t=this._polygonSet._itemParent._attributes.children._models.filter(t=>t.get("name")===e);t&&t[0]&&(o=!0,(i=t[0].getContent()).setLayerVector(r),i.addSubElements(n))}var l;o||(s&&s.getGeoJSON&&(l=s.getGeoJSON(e)),(i=new u({strid:e,geojson:l,instanceId:t})).setLayerVector(r),i.create(this.getRoot()),i.addSubElements(n));return s&&(s.geometrySubsetId=r.id),i},register:function(e){},unregister:function(e){},redrawPrimitive:function(e){var t=this.getRendering();o.is(t)&&(t.isPrimitiveRegistered(e)?t._renderprimitive(e):this.registerPrimitive(e))},registerPrimitive:function(e){var t=this.getRendering();o.is(t)&&(t.isPrimitiveRegistered(e)||t.registerPrimitive(this._patch,e))},registerPrimitives:function(e){var t,i,r=Object.keys(e),s=r.length;for(t=0;t<s;t++)i=r[t],this.registerPrimitive(i)},addUserDataProperty:function(e,t,i){if(o.is(e)){var r=this.get("geojson"),s=r.features[0];if(o.is(i))for(var n=0;n<r.features.length;n++){var a=r.features[n];if(a&&a.properties&&a.properties.STRID===i){s=a;break}}s.properties||(s.properties={}),s.properties[e]=t;var l=this.get("userData");return l||(l={},this.set("userData",l)),l[e]=t,!0}return!1},removeUserDataProperty:function(e,t){if(o.is(e)){var i=this.get("geojson"),r=i.features[0];if(o.is(t))for(var s=0;s<i.features.length;s++){var n=i.features[s];if(n&&n.properties&&n.properties.STRID===t){r=n;break}}o.is(r.properties[e])&&delete r.properties[e];var a=this.get("userData");return o.is(a[e])&&delete a[e],!0}return!1},redraw:function(){var e=this.getRendering();o.is(e)&&(this._poiSet&&(this._poiSet.nbPoint>0||this._poiSet.nbMultiPoint>0)&&this._poiSet.redraw(),this._lineSet&&(this._lineSet.nbGeometry>0||this._lineSet.nbMultiGeometry>0)&&this._lineSet.redraw(),this._polygonSet&&(this._polygonSet.nbGeometry>0||this._polygonSet.nbMultiGeometry>0)&&this._polygonSet.redraw())},getRendering:function(){return this._rendering},highlight:function(){this._poiSet._node.traverse(function(e){if(void 0!==e.mesh3js&&"instance"===e.mesh3js.instancingSelectionMode){e.mesh3js.instancingSelectionMode="mesh";for(var t=0;t<e._occurrences.length;++t)e._occurrences[t].renderable.instancingSelectionMode="mesh"}})},unhighlight:function(){this._poiSet._node.traverse(function(e){if(void 0!==e.mesh3js&&"mesh"===e.mesh3js.instancingSelectionMode){e.mesh3js.instancingSelectionMode="instance";for(var t=0;t<e._occurrences.length;++t)e._occurrences[t].renderable.instancingSelectionMode="instance"}})},findPrimitivesByCriteria:function(e){var t=new m(e),i={};if(!o.is(t))return null;var r=function(e){return t.apply(e)};if(this._poiSet){this._poiSet._factory;for(var s in this._poiSet.primInfos){!0===(r(n=this._poiSet.primInfos[s].userData)||!1)&&(i[s]=n)}}if(this._lineSet){this._lineSet._factory;for(var s in this._lineSet.primInfos){!0===(r(n=this._lineSet.primInfos[s].userData)||!1)&&(i[s]=n)}}if(this._polygonSet){this._polygonSet._factory;for(var s in this._polygonSet.primInfos){var n;!0===(r(n=this._polygonSet.primInfos[s].userData)||!1)&&(i[s]=n)}}return i},setClustering:function(e){this._poiSet.nbBuiltTotal&&this._poiSet.nbBuiltTotal>0&&(this._poiSet.setClustering(e),this.set("Clustering",this._poiSet.get("Clustering")))},getLayerAttributes:function(){let e,t,i=this,r=function(){i._urban.generalWorkerSem.requestWorker().then(t=>(function(t){t.worker.onmessage=(r=>{i.analytics=r.data,t.release(),e(i.analytics)});let r=i._polygonSet._attributes.geojson,s=!1,n=!1;if(r.shpContent&&(s=!0),r.dbfContent&&(n=!0),s&&n){let e={function:"analytics",dbf:r.dbfContent.slice(0),shp:r.shpContent.slice(0)};t.worker.postMessage(e,[e.dbf,e.shp])}else{let e={function:"analytics",geojson:r.slice(0)};t.worker.postMessage(e,[e.geojson])}})(t))};return new Promise(function(s,n){e=s,t=n,i._polygonSet._attributes.geojson?i._urban.generalWorkerSem?i.analytics?e(i.analytics):o.requestIdleCallback(r,{timeout:100}):n("General worker not available"):n("Layer has no geojson attached")})},getLayerAttributesSync:function(){return this.analytics?this.analytics:(this.getLayerAttributes(),null)},getStatistics:function(e){let t,i,r=this,s=function(){r._urban.generalWorkerSem.requestWorker().then(i=>(function(i){i.worker.onmessage=(e=>{i.release(),t(e.data)});let s=r._polygonSet._attributes.geojson,n=!1,a=!1;if(s.shpContent&&(n=!0),s.dbfContent&&(a=!0),n&&a){let t={function:"stats",param:e,dbf:s.dbfContent.slice(0),shp:s.shpContent.slice(0)};i.worker.postMessage(t,[t.dbf,t.shp])}else{let t={function:"stats",param:e,geojson:s.slice(0)};i.worker.postMessage(t,[t.geojson])}})(i))};return new Promise(function(e,n){t=e,i=n,r._lineSet.isBuilt&&r._poiSet.isBuilt&&r._polygonSet.isBuilt?r._urban.generalWorkerSem?r.getLayerAttributes().then(()=>{o.requestIdleCallback(s,{timeout:100})}):n("General worker not available"):n("Layer is not built")})}});return r.ObjectContructor.GeometrySet=y}),define("DS/XCityLoaders/ThreetyDXLoader",["DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/ThreeDXLoader","DS/Visualization/ThreeJS_DS","DS/XCityLoaders/BaseLoader","DS/XCityLoaders/ModelLoader","DS/XCityTools/Downloader","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s,n,a,o){"use strict";return s.extend({init:function(e,t,i){this._parent(e,t),this.priority=i,void 0===this.priority&&(this.priority=1),this.initThreeDXLoader(),this.cityData=null},initThreeDXLoader:function(){this.loader=this.threeDXLoader=new i,this.threeDXLoader.setMode("concat"),this.threeDXLoader.globalOldFlipTexture=!0;var e=this;this.threeDXLoader.switchLODTextureCB=function(t){if(t.camera!==debugWebGLV6Viewer.currentViewpoint.camera)return this.lastUsedTexture;var i=e.urban.getPerformanceProfileManager(),s=i.getValue("maxtextureLOD"),n=i.getValue("textureLODOffset"),a=i.getValue("textureLODDistanceFactor");if(debugWebGLV6Viewer.mobile){if(10===s)return-1;s=Math.min(s,2)}var o=t.matrix,l=t.bSphere,h=l.radius*o.getMaxScaleOnAxis(),d=new r.Vector3;l?d.copy(l.center):d.set(0,0,0),d.applyMatrix4(o);var u=t.camera.matrixWorldInverse.elements,c=Math.abs(u[2]*d.x+u[6]*d.y+u[10]*d.z+u[14])-h;c*=a;var p,f,m=r.glStates.currentHeight/Math.tan(.5*t.camera.fov*Math.PI/180)*h/Math.abs(c);if(m<Math.min(t.texture.image.width,t.texture.image.height))return-1;for(p=0;p<t.lods.length&&(f=t.lods[p],!(m<Math.min(f.imageData.width,f.imageData.height)));p++);var g=p===t.lods.length?p-1:p;return g=Math.max(-1,g+n),Math.min(g,s)}},processBin:function(e,t){if(e){var i=this._parse(t);this.cityData=i.json.userData.cityData,this._applyMatrix();var r=this._generateObjectToLoad(t);this.threeDXLoader.modelsToLoad[0]=r,r.gasSharing=!0;var s=r.doneCallback,n=this;r.doneCallback=function(e,t,i){n._bindPrimitives(),s(e,t,i)},this._resolveTexturePath(r),this.threeDXLoader.processJSON(r)}},_resolveTexturePath:function(e){for(var t=e.json.binaries,i=0,r=t.length;i<r;++i){var s=t[i];if(!1===s.concatenated){var n,o,l=s.uri.split("/"),h=l[l.length-1],d=a.resolveUrl(this.model.url);if(d.indexOf("resources")>-1)n=-1==(n=d.lastIndexOf("/"))?d.length:n+1,d=d.substring(0,n),(o=this.model.url.split("?")).length>1?t[i].uri=d+h+"?"+o[o.length-1]:t[i].uri=d+h;else n=-1==(n=d.lastIndexOf("?"))?d.length:n+0,d=d.substring(0,n),(o=this.model.url.split("?")).length>1?t[i].uri=d+"/resources/"+h+"?"+o[o.length-1]:t[i].uri=d+"/"+h}}},_applyMatrix:function(){var e=this.cityData.matrix;if(e){var t=new r.Matrix4;t.set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]),t.transpose(),this.model.matrix=t,this._applyModelMatrixToModelNode()}},_parse:function(e){for(var t=new Uint8Array(e),i=new Uint32Array(e,0,1)[0],r=new Uint16Array(t.buffer,4,i/2),s=[],n=0;65535*n<r.length;n++)s.push(String.fromCharCode.apply(null,r.subarray(65535*n,65535*(n+1))));return{json:JSON.parse(s.join("")),dataAsByte:t,jsonSize:i}},_generateObjectToLoad:function(e){var t=this._parse(e);return this.model.node.isCoreReady=!1,{concat:!0,doneCallback:this._doneCallback.bind(this),nodeCallback:this._nodeCallback.bind(this),destinationNode:this.model.node,oldFlipTexture:!0,unstreamPrimitives:!0,onTexturesLoadedCB:function(){this.model.node.setVisibility(!0),this.model.node.isCoreReady=!0}.bind(this),data:{nbImagesToLoad:0,chunks:[],header:{},nodes:[],buffers:[],geometries:[],images:[],textures:[],materials:[],reps:{},modelsToLoad:[]},json:t.json,concatBinaries:{data:t.dataAsByte,offset:t.dataAsByte.byteLength}}},_bindPrimitives:function(){var e=this.cityData.objects,t=this;if(Array.isArray(e)){var i=[];this._extractMesh(this.model.node,i);var r=this._bindUidToPrim(e,i);this.model.uidToPrim=r,this.model.patch&&(Object.keys(this.model.uidToPrim).forEach(function(e){if(o.is(t.model.patch._uidListeners[e]))for(var i in t.model.uidToPrim[e])t.model.patch._uidListeners[e][i]=t.model.uidToPrim[e][i];else t.model.patch._uidListeners[e]=t.model.uidToPrim[e]}),this.model.patch.miDToTile!==this.model.patch._uidListeners&&(this.model.patch.miDToTile=this.model.patch._uidListeners))}},_extractMesh:function(e,t){if(e.mesh3js)return t.push(e);e.children.forEach(function(e){this._extractMesh(e,t)}.bind(this))},_bindUidToPrim:function(e,t){var i={},r=this.model.tile;return t.forEach(function(t){for(var s,n=t.getPrimitives(),a=[],l=0;l<n.length;l++)for(var h=0;h<e.length;h++)if(s=o.is(n[l].sgNode.cgmIdOld)&&"number"!=typeof n[l].sgNode.cgmId?n[l].sgNode.cgmIdOld:n[l].sgNode.cgmId,e[h].tags.indexOf(s)>-1){var d,u=e[h].STRID,c=e[h].uuid;if(void 0===c&&(c=e[h].uid),d=void 0!==u?u:c,n[l].sgNode.cgmId=d,!i[d]){var p={};for(var f in e[h])"tags"!==f&&""!==e[h][f]&&(p[f]=e[h][f]);i[d]={geom:[],strid:d,userData:p,tile:r}}i[d].geom.push({mesh:t,subElement:n[l].sgNode}),a.push(i[d])}t.userData={records:a}}),i},_doneCallback:function(){this.model.node&&(this._isTextured()&&!0!==this.model.node.isCoreReady?this.model.node.setVisibility(!1):this.model.node.isCoreReady=!0,this.model.callback&&this.model.callback(this.model.node,!0,this.model.name))},_nodeCallback:function(e,t,i){i.getGroupMaterial=function(e){return e.group.material||e.group.gas},i.setRendering=function(e,t,i){var r,s,n,a=!1,l=!1,h=this.getPrimitive(i,!0);o.is(h)||(l=!0),(r=(s=this.getGroupMaterial(t)).clone()).textureBlending=s.textureBlending,o.is(e.color)&&(n=e.color,r.color.copy(n),r.ambient&&r.ambient.copy(n),a=!0),o.is(e.opacity)&&(n=e.opacity,r.opacity=n,a=!0),a?(this.setMaterial([t],r),l&&this.hide([t])):this.setMaterial([t],s)}}})}),define("DS/XCityRendering/RenderingHandlerHeatMapTool",["DS/XCityRendering/RenderingHandlerPOI3D","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/ColorGradient"],function(e,t,i,r,s){"use strict";return e.extend({init:function(e,t,i){this._parent(e,t,i),this.type="HeatMapTool"},getDefaultRendering:function(){return Object.assign({},this._parent(),{gradient:{DCOffset:new t.Vector3(.52,.52,.1),Amplitude:new t.Vector3(.48,-.48,-.11),Frequency:new t.Vector3(-.62,.56,.4),Phase:new t.Vector3(.33,.3,.5)},influenceRadius:20,enable:!1,opacity:.75,boundMin:1,boundMax:100,kernel:0})},updateRendering:function(e){this._parent(e),this.updateSources()},updateSources:function(){if(i.is(this._currentLayerRendering)){var e=this.currentRendering.get("influenceRadius");e!==this.lastRendering.get("radius")&&this._currentLayerRendering.currentRendering.set("influenceRadius",e)}},setHeatMap:function(e){this._currentLayerRendering=e,this._currentLayerRendering.defaultRendering.set("noGeometry",!0),this._currentLayerRendering._needRebuild=!0},unsetHeatMap:function(e){i.is(this._currentLayerRendering)&&(this._currentLayerRendering.defaultRendering.set("noGeometry",!1),this._currentLayerRendering._needRebuild=!0,this._currentLayerRendering=null)}})}),define("DS/XCityRendering/HeatMapTool",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityEffects/HeatMapRTree","DS/XCityRendering/RenderingHandlerHeatMapTool"],function(e,t,i,r,s){"use strict";return e.extend({init:function(e){this._parent();return this.urban=e,this.renderingProfileManager=this.urban.getRenderingProfileManager(),this.renderingProfileManager._heatMapGeom=this,this._renderingId=this.renderingProfileManager.HeatMapToolId,this.heatmapId="3DXCityHeatMap",this._rendering=new s(this.urban),this},getRendering:function(){var e=null;return i.is(this._rendering)&&(e=this._rendering),e},get:function(e){var t,r,s=this.getRendering();return i.is(s)&&s.hasAttribute(e)&&(r=this.getMaterial(),i.is(r)&&(t=r[e])),t},set:function(e,t){var r=this.getRendering();if("magnitude"===e&&this.currentContent){1===t?(this.currentContent._factory._magnitude=null,this.currentContent._factory._rendering._magnitude=null):(this.currentContent._factory._magnitude=t,this.currentContent._factory._rendering._magnitude=t),void 0===(n=this.currentContent.get("url"))&&(n="");var s=n.indexOf("&method=sum&heatmap=");s>-1&&(n=n.slice(0,s)),1===t?this.currentContent.set("url",n):this.currentContent.set("url",n+"&method=sum&heatmap="+t)}else{var n,a={};if(i.is(r)&&r.hasAttribute(e)&&(a[e]=t,this.setMaterial(a)),"enable"===e&&this.currentContent)if(void 0===(n=this.currentContent.get("url"))&&(n=""),t)-1===n.indexOf("heatmap")&&null!==this.currentContent._factory._magnitude&&this.currentContent.set("url",n+"&method=sum&heatmap="+this.currentContent._factory._magnitude);else{var o=n.indexOf("&method=sum&heatmap=");o>-1&&this.currentContent.set("url",n.slice(0,o))}}},resetRenderingAttribute:function(e){if(!i.is(this.renderingProfileManager))return null;this.renderingProfileManager.resetAttributeOnly(this._renderingId,e),this.renderingProfileManager.updateGeomRenderings([this]),this.redraw()},setMaterial:function(e){return i.is(this.renderingProfileManager)?(this.renderingProfileManager.addRendering(this._renderingId,e),this):null},getMaterial:function(){var e=this.getRendering();return i.is(e)?e.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this._renderingId)},redraw:function(){var e=this.getRendering().getCompleteMaterialInfo();e.enable?(this._enableEffect(),i.is(this._factoriestoadd)&&this._factoriestoadd.length>0&&(this._addFactory(this._factoriestoadd.pop()),this._factoriestoadd.length>0&&(this._factoriestoadd=null)),this._updateEffect(e)):this._disableEffect()},_enableEffect:function(){if(i.is(this.heatMapEffect)||(this.heatMapEffect=this._getHeatMapRTree()),this.heatMapEffect.enableEffect(),i.is(this.currentContent)){var e=this.currentContent.getRendering();this.getRendering().setHeatMap(e)}},_getHeatMapRTree:function(){if(void 0===this.heatMapRTree){var e=this.urban.USR.webGLV6Viewer.renderer,t=this.urban.USR.webGLV6Viewer.renderer.renderTargetPool;this.heatMapRTree=new r(e,t,this.urban),this.urban.USR.webGLV6Viewer.renderer.addCustomEffect(this.heatMapRTree)}return this.heatMapRTree},_disableEffect:function(){if(i.is(this.heatMapEffect)&&(this.heatMapEffect.disableEffect(),i.is(this.currentContent))){this.currentContent.clusterlimit=2,this.currentContent._factory._magnitude=null,this.currentContent._factory._rendering._magnitude=null;var e=this.currentContent.get("url");void 0===e&&(e=""),this.currentContent.set("url",""),this.currentContent.set("url",e),this.getRendering().unsetHeatMap(null),this._redrawFactory()}},_updateEffect:function(e){i.is(e)&&(this._updateOpacity(e.opacity),this._updateRadius(e.influenceRadius),this._updateBoundMin(e.boundMin),this._updateBoundMax(e.boundMax),this._updateKernel(e.kernel))},_updateOpacity:function(e){this.heatMapEffect.mixPass.uniforms.opacity.value=e},_updateRadius:function(e){},_updateBoundMin:function(e){this.heatMapEffect.mixPass.uniforms.boundMin.value=e},_updateBoundMax:function(e){this.heatMapEffect.mixPass.uniforms.boundMax.value=e},_updateKernel:function(e){this.heatMapEffect.mixPass.uniforms.kernel.value=e},_redrawFactory:function(){i.is(this.currentContent)&&this.currentContent.redraw()},addSource:function(e){if(i.is(e)){var t=e.getContent();this._addFactory(t)}return!1},removeSource:function(e){if(i.is(e)){var t=e.getContent();this._removeFactory(t)}return!1},_addFactory:function(e){if(i.is(e))if(i.is(this.heatMapEffect)){this.currentContent&&this._removeFactory(this.currentContent);var t=e.get("url");void 0===t&&(t=""),t.indexOf("heatmap"),e._nhitsTotal<900&&(e.clusterlimit=900,e.set("url",""),e.set("url",t));var r=e.getRendering();r&&i.is(r.getVisiblePoints)&&(this.getRendering().setHeatMap(r),this.heatMapEffect.addFactory(r),this.currentContent=e,this._redrawFactory())}else i.is(this._factoriestoadd)||(this._factoriestoadd=[]),this._factoriestoadd.push(e)},_removeFactory:function(e){var t=e.get("id");if(i.is(this._factoriestoadd)&&this._factoriestoadd.length>0){var r,s=this._factoriestoadd.length;for(r=0;r<s;r++){if(this._factoriestoadd[r].get("id")===t){this._factoriestoadd.splice(r,1);break}}}else{if(this.getRendering().unsetHeatMap(null),i.is(this.heatMapEffect))this.heatMapEffect.removeFactory(e.getRendering());this._redrawFactory(),this.currentContent=null}}})}),define("DS/XCityGeometry/PatchVector3DXMFormat",["UWA/Class","DS/XCityGeometry/PatchVector","DS/XCityLoaders/ThreetyDXLoader","DS/Visualization/Mesh3D"],function(e,t,i,r){"use strict";return e.extend(t,{init:function(e,t,i){this._parent(e,t,i),this.cityLoader={}},build:function(e,t,r,s,n){var a=s.tile;this.cityLoader[a.key]=new i(e,void 0,r),this.cityLoader[a.key].model.url=s.url,this.cityLoader[a.key].model.patch=this,this.cityLoader[a.key].model.geolocalized=t,this.cityLoader[a.key].model.rendering=this.factory._rendering,this.cityLoader[a.key].model.tile=a,this.cityLoader[a.key]._oldDoneCallback=this.cityLoader[a.key]._doneCallback,this.cityLoader[a.key]._doneCallback=this._triggerListener.bind(this,a.key),n.byteLength>0&&(this.cityLoader[a.key].load(),this.cityLoader[a.key].processBin(!0,n)),s.value={node:this.cityLoader[a.key].model.node},this.cityLoader[a.key].model.node.storeKey=s.key},_triggerListeners:function(){for(var e in this._uidListeners)if(this._uidListeners[e].listeners&&this._uidListeners[e].listeners.length>0)for(var t=0;t<this._uidListeners[e].listeners.length;++t)this._uidListeners[e].listeners[t](this._uidListeners[e])},remove:function(e){for(var t in this.cityLoader[e].model.uidToPrim){var i=this.miDToTile[t];this.cleanInfo(i,t)}delete this.cityLoader[e].loader,delete this.cityLoader[e].threeDXLoader,delete this.cityLoader[e]},_triggerListener:function(e){for(var t in Utils.is(this.cityLoader[e].model.node.observers)||(this.cityLoader[e].model.node.observers=[]),this.cityLoader[e].model.node.observers.push(this.remove.bind(this,e)),this.cityLoader[e]._oldDoneCallback(),this.cityLoader[e].model.uidToPrim){var i=this._uidListeners[t].listeners;if(i)for(var r=0;r<i.length;++r)i[r](this._uidListeners[t])}}})}),define("DS/XCityRendering/RenderingHandlerPointOfInterest",["DS/XCityTools/ShaderTools","DS/Visualization/Mesh3D","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerSpecific"],function(e,t,i,r,s){"use strict";return s.extend({init:function(e,t){this._parent(e,t),this.type="POI"},getDefaultRendering:function(){return{classStyle:"poiText"}}})}),define("DS/XCityCoreUI/DebugControls",["UWA/Core","UWA/Class","DS/Controls/Toggle","DS/Controls/Button","DS/Controls/ColorPalette","DS/Controls/ButtonGroup","DS/Controls/Slider","DS/xCityPlatformUtils/xCityDocumentManagement","DS/XCityTools/Debug","DS/XCityCore/Terrain","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader"],function(e,t,i,r,s,n,a,o,l,h,d,u,c){"use strict";return t.extend({init:function(t){this.container=new e.Element("div",{class:"xCity-debug-controls-container"}),this.createDebugPanel()},addGeojsonToCity:function(e,t,i,r,s,n,a){JSON.stringify(s);var o=d.createUUID(),l=(xCity._urbanImpl.baseProjection,t||"");e=e+"_"+i;if("Point"===n.type)var h={className:"Feature",name:e,id:o,visible:!0,selectable:!0,Content:{className:"PointOfInterest3DSet",type:"json",objectId:l,serviceId:i,id:o,Clustering:{enable:!1,nbSteps:6,minimumHits:1},scale:[2,2,2]}};else if("LineString"===n.type)h={className:"Feature",name:e,id:o,visible:!0,selectable:!0,Content:{className:"LineSet",type:"json",objectId:l,serviceId:i,id:o}};else if("Polygon"===n.type)h={className:"Feature",name:e,id:o,visible:!0,selectable:!0,Content:{className:"PolygonSet",type:"json",objectId:l,serviceId:i,id:o}};else if("Geometry"===n.type)h={className:"Feature",name:e,id:o,visible:!0,selectable:!0,Content:{className:"GeometrySet",type:"json",objectId:l,serviceId:i,id:o}};void 0!==s?h.Content.geojson=s:void 0!==r&&(h.Content.url=r),n.strid&&(h.Content.stridAttribute=n.strid),n.name&&(h.Content.nameAttribute=n.name);xCity.add3DContent({feature:h,parentFolder:a,readyCB:function(e){var t,i=e.impl.getContent(),r=0;i&&"Point"===n.type?(t=i.nbPoint,r=i.nbMultiPoint):i&&"LineString"===n.type?(t=i.nbLineString,r=i.nbMultiLineString):i&&"Polygon"===n.type&&(t=i.nbPolygon,r=i.nbMultiPolygon);var s=e.get("name");e.set("name",s+" ("+t+" "+n.type+", "+r+" Multi"+n.type+")")}})},processFiles:function(e){return new Promise((t,i)=>{for(var r=this,s=0;s<e.items.length;s++)if("file"===e.items[s].kind){var n=e.items[s].getAsFile();n.name.includes(".json")||n.name.includes(".geojson")||i("wrong file format dropped, please retry"),r.readFileAsJSON(n).then(function(e){console.log(e);var i=r.getAttributesOfGeojson(e);t({fileName:n.name,geojson:e,attributes:i})})}})},readFileAsJSON:function(e){return new Promise((t,i)=>{var r=new FileReader;r.onloadend=function(e){t(JSON.parse(this.result))},r.readAsText(e)})},getAttributesOfGeojson:function(e){return"string"==typeof e&&(e=JSON.parse(e)),Object.keys(e.features[0].properties)},dropHandler:function(e,t){var i=e.getData("text"),r=JSON.parse(i).data.items[0],s=(r.envId,r.serviceId),n=r.objectId;return new Promise((e,t)=>o.retrieveDocumentTypes(n,s).then(function(i){Promise.resolve();for(var a=[],o=0;o<i.types.length;o++){var l=i.types[o].toUpperCase();"GEOJSON"!==l&&"SHP"!==l||a.push({index:o,extension:l})}a.length>0?e({fileName:r.displayName,url:void 0,objectId:n,serviceId:s,attributes:[]}):t()}))},buildCache:function(e,t,i){const r=this;let s=function(s){s.worker.onmessage=(e=>{const n=e.data,a=(n.RequestsRemaining/r._buildCacheTotalTiles).toFixed(2);n.RequestsRemaining%50==0&&(t.label="Pause ("+(100-100*a).toFixed(0)+"%)"),0===n.RequestsRemaining&&(s.release(),r._generalWorker=null,t.label="Build Cache",i.setText("Tile padding"),t.emphasize="success")});let n={function:"buildTileCache",requests:e};s.worker.postMessage(n)};r._generalWorker?s(r._generalWorker):xCity._urbanImpl.generalWorkerSem.requestWorker().then(e=>{r._generalWorker=e,s(r._generalWorker)})},addTileRequest:function(e,t,i){const r=this;if(!e.has(t)){if(e.add(t),!i)return;const s=t.substring(t.search("\\?")),n=t.substring(0,t.search("/[0-9]+/[0-9]+/[0-9]+")),a=t.substring(t.search("/[0-9]+/[0-9]+/[0-9]+")+1,t.search("\\?")).split("/"),o=Number(a[0]),l=Number(a[1]),h=Number(a[2]);let d=0;for(let t=-i.padding.length/2;t<i.padding.length/2;t++){let a=0;for(let u=-i.padding[0].length/2;u<i.padding[0].length/2;u++){if(i.padding[d][a]){const i=n+"/"+Math.max(0,o+Math.ceil(t))+"/"+Math.max(0,l+Math.ceil(u))+"/"+h+s;r.addTileRequest(e,i,null)}a++}d++}}},parseHAFile:async function(e,t,i,r){const s=Math.max(1,Math.min(10,Number(t.value)));let n=[];for(let e=-10;e<10;e++){let t=[];for(let i=-10;i<10;i++){const r=Math.abs(i)<=s&&Math.abs(e)<=s;t.push(r)}n.push(t)}const a={padding:n};if(e){const t=await e.text(),i=JSON.parse(t),r="/globe/datasupplier/dataset/";this._HAFileEntries=i.log.entries.filter(e=>e.request.url.includes(r))}const o=this._HAFileEntries;if(!o||0===o.length)return;const l=o.map(e=>e.request.url),h=new Set,d=this;l.forEach(e=>{d.addTileRequest(h,e,a)});const u=o.map(e=>e.time).reduce((e,t)=>e+t,0)/o.length*h.size;let c="";return c=h.size>1e6?(h.size/1e6).toFixed(0)+"M":h.size>1e3?(h.size/1e3).toFixed(0)+"K":h.size,c+=" tiles.",i.setText("Tile padding. "+c+"  Estimated time (h): "+(u/1e3/60/60).toFixed(2)),h},createDebugPanel:function(){var t=this,o=new i({label:"Display infos",type:"switch",internalLabelsFlag:!0}),d=new i({label:"Display charts",type:"switch",internalLabelsFlag:!0}),p=new i({label:"QT Lock",type:"switch",internalLabelsFlag:!0}),f=new i({label:"QT View",type:"switch",internalLabelsFlag:!0}),m=new i({label:"QT Levels",type:"switch",internalLabelsFlag:!0}),g=new i({label:"QT Tile Infos",type:"switch",internalLabelsFlag:!0}),v=new i({label:"QT Triangles",type:"switch",internalLabelsFlag:!0}),_=new i({label:"MoveTo",type:"switch",internalLabelsFlag:!0}),y=new i({label:"NearGround",type:"switch",internalLabelsFlag:!0}),b=new i({label:"Robot",type:"switch",internalLabelsFlag:!0}),x=new i({label:"Bbox Labels Collisions",type:"switch",internalLabelsFlag:!0}),C=new i({label:"Bbox Item on prim selection",type:"switch",internalLabelsFlag:!0}),S=new r({label:"Ground color picker",type:"check",internalLabelsFlag:!0}),D=new s,P=new a({value:.01,minValue:.01,maxValue:1.73,stepValue:.01,displayStyle:"horizontal"}),w=new n({label:"Skybox",type:"radio"});w.addChild(new i({type:"radio",label:"blue",value:0})),w.addChild(new i({type:"radio",label:"crepuscule",value:1})),w.addChild(new i({type:"radio",label:"natural",value:2})),w.addChild(new i({type:"radio",label:"plaster",value:3,checkFlag:!0})),w.addChild(new i({type:"radio",label:"realistic",value:4})),o.addEventListener("buttonclick",function(i){l.isActive=o.checkFlag,t.debugContainer||(t.debugContainer=new e.Element("div",{id:"Infos"}).inject(t.container)),!0===l.isActive?t.debugContainer.style.display="block":t.debugContainer.style.display="none"}),p.addEventListener("buttonclick",function(e){xCity._urbanImpl.USR.forceUpdate=!0,xCity._urbanImpl.lockQuadtree=p.checkFlag}),f.addEventListener("buttonclick",function(e){xCity._urbanImpl.showQuadtree=f.checkFlag,h.setupDebug({showtiles:xCity._urbanImpl.showQuadtree})}),m.addEventListener("buttonclick",function(e){xCity._urbanImpl.showQuadtreeLevels=m.checkFlag,h.setupDebug({coloredlevels:xCity._urbanImpl.showQuadtreeLevels})}),g.addEventListener("buttonclick",function(e){xCity._urbanImpl.showQuadtreeTileInfos=g.checkFlag,h.setupDebug({tileInfos:xCity._urbanImpl.showQuadtreeTileInfos})}),x.addEventListener("buttonclick",function(e){xCity._urbanImpl.labelManager.enableDebugBbox(x.checkFlag)}),C.addEventListener("buttonclick",function(e){xCity._urbanImpl.showPrimBbox=C.checkFlag}),v.addEventListener("buttonclick",function(e){xCity._urbanImpl.showTriangles=v.checkFlag,h.setupDebug({wireframe:xCity._urbanImpl.showTriangles})}),d.addEventListener("buttonclick",function(e){l.activeCharts(d.checkFlag)}),_.addEventListener("buttonclick",function(e){xCity._urbanImpl.getControl().debugMove()}),y.addEventListener("buttonclick",function(e){xCity._urbanImpl.USR.getViewpoint()._debugNearGround(y.checkFlag)}),b.addEventListener("buttonclick",function(e){xCity.enableRobot(b.checkFlag,xCity.selectedItems[0]),xCity.selectedItems[0]||console.log("you must select a feature before activating the robot")}),this.groundColorPickerChecked=!1,this.groundColorPickerToken=void 0,this.groundColorResult=D,S.addEventListener("change",function(){if(this.groundColorPickerToken)u.unsubscribe(this.groundColorPickerToken),this.groundColorPickerToken=void 0;else{var e=function(e){if(Utils.is(e.gesture)){var t=e.gesture.getEvents();if(Utils.is(t)&&t.length>0){var i=t[0].event;console.log("x : "+i.clientX+" / y : "+i.clientY);var r=xCity._urbanImpl.USR.getGroundColor(i.clientX,i.clientY);console.log("groundColor : ["+r.r+" "+r.g+" "+r.b);var s="rgb("+r.r+","+r.g+","+r.b+")";this.groundColorResult.swatches=[{value:s}],xCity.getSessionRenderingProfile().setRendering("Ground",{oceanColorDetection:s}),xCity.realisticWater=!0}}}.bind(this);this.groundColorPickerToken=u.subscribeToLeftMouseDown(e)}}.bind(this)),P.addEventListener("change",function(e){xCity.getSessionRenderingProfile().setRendering("Ground",{oceanRangeDetection:e.dsModel.value}),xCity.realisticWater=!0}.bind(this)),this.realisticSky=!1,w.addEventListener("change",function(e){if(w.value[0]<4){this.realisticSky&&(xCity._urbanImpl.environment.switchSky(),this.realisticSky=!1);xCity.getSessionRenderingProfile().setRendering("Sky",{cubeMapUrl:"XCityEnvironment/assets/textures/skybox/"+["blue","crepuscule","natural","plaster"][w.value[0]],cubeMapExt:".jpg"})}else 4===w.value[0]&&(this.realisticSky=!0,xCity._urbanImpl.environment.switchSky())}.bind(this)),y.inject(this.container),o.inject(this.container),d.inject(this.container),p.inject(this.container),f.inject(this.container),m.inject(this.container),g.inject(this.container),v.inject(this.container),_.inject(this.container),b.inject(this.container),x.inject(this.container),C.inject(this.container),S.inject(this.container),D.inject(this.container),P.inject(this.container),w.inject(this.container);var M=new e.Element("div",{id:"dropZone",events:{dragenter:function(e){e.preventDefault()},dragleave:function(e){e.preventDefault()},dragover:function(e){e.preventDefault()},drop:function(e){e.preventDefault()}}});M.setStyle("color","blue"),M.setStyle("border-color","#808080"),M.setStyle("border-width","2px"),M.setStyle("border-style","dotted"),M.setStyle("height","50px");var T=new e.Element("span",{id:"dropZoneText",html:"Drag a geojson to this Drop Zone"});t=this;let I,R,A;M.addEvent("drop",function(e){var i=event.dataTransfer;t.dropHandler(i,{fromFile:!0,from3DDrive:!1}).then(function(e){var i;i=e.objectId&&e.serviceId?{name:e.fileName,url:e.url,objectId:e.objectId,serviceId:e.serviceId,attributes:e.attributes}:{name:e.fileName,geojson:e.geojson,attributes:e.attributes};var r=xCity.addFolder({id:"PreviewFolder_"+e.filename,name:"Preview: "+e.serviceId});t.addGeojsonToCity(i.name,i.objectId,i.serviceId,i.url,i.geojson,{strid:void 0,name:void 0,type:"Geometry",proj:"WGS84"},r)},e=>{errorMessage("upload issue",e)})}),T.inject(M),M.inject(this.container);var F=new e.Element("div",{id:"dropZoneHA",events:{dragenter:function(e){e.preventDefault()},dragleave:function(e){e.preventDefault()},dragover:function(e){e.preventDefault()},drop:function(e){e.preventDefault()}}});F.setStyle("color","blue"),F.setStyle("border-color","#808080"),F.setStyle("border-width","2px"),F.setStyle("border-style","dotted"),F.setStyle("height","50px"),F.setStyle("margin","4px 0px 4px 0px");const L=new e.Element("span",{html:"Tile cache builder tool"});L.setStyle("margin","30px 0px 0px 0px"),L.inject(this.container);const V=new e.Element("span",{id:"dropZoneHAText",html:"Drag a Chrome network recording (.har) file to this Drop Zone"});F.addEvent("drop",function(e){e.dataTransfer&&e.dataTransfer.files&&(t._pauseBuildCache=!1,t.parseHAFile(e.dataTransfer.files[0],I,R,A).then(e=>t._cacheBuilderRequests=e))}),V.inject(F),F.inject(this.container),(I=new e.Element("input",{id:"inputTileBuilderPadding",value:2,min:1,max:10,styles:{width:"40px"},type:"number",events:{change:function(e){t.parseHAFile(void 0,I,R,A).then(e=>t._cacheBuilderRequests=e)}}}).inject(this.container)).setStyle("margin","4px 4px 4px 0px"),(R=new e.Element("span",{id:"spanTileBuilderPadding",html:"Tile padding"}).inject(this.container)).setStyle("margin","0px 12px 0px 0px"),(A=new r({label:"Build cache",emphasize:"success"}).inject(this.container)).addEventListener("buttonclick",function(){if("high-attention"===A.emphasize){if(A.emphasize="success",A.label="Resume",t._pauseBuildCache=!0,t._generalWorker){let e={function:"buildTileCache",requests:null,pause:!0};t._generalWorker.worker.postMessage(e)}}else if(t._cacheBuilderRequests&&t._cacheBuilderRequests.size>0){if(A.emphasize="high-attention",A.label="Pause",t._pauseBuildCache&&t._generalWorker){let e={function:"buildTileCache",requests:null,pause:!1,resume:!0};t._generalWorker.worker.postMessage(e)}else t._buildCacheTotalTiles=t._cacheBuilderRequests.size,t.buildCache(t._cacheBuilderRequests,A,R);t._pauseBuildCache=!1}else alert("Please drag and drop a Chrome network recording into the drop zone and wait for the file to be parsed")}),new e.Element("div").inject(this.container).setStyle("margin","0px 0px 50px 0px"),new e.Element("input",{id:"logRefreshInput",value:c.getDownloadStatsRefreshDelay(),styles:{width:"80px"},type:"number",events:{change:function(e){Number.isFinite(Number(e.target.value))?c.setDownloadStatsRefreshDelay(Number(e.target.value)):console.error("DEBUG: Please enter a valid number in milliseconds")}}}).inject(this.container).setStyle("margin","4px 4px 4px 0"),new e.Element("span",{html:"Downloader statistics refresh delay (ms)"}).inject(this.container)}})}),define("DS/XCityCoreUI/DebugUI",["UWA/Core","UWA/Class","DS/XCityCoreUI/TimeControler","DS/XCityCoreUI/DebugControls","DS/XCityCoreUI/Animation","DS/XCityCoreUI/AtmosphereControler","DS/XCityCoreUI/CloudsControler","DS/XCityCoreUI/PbrControler","DS/XCityCoreUI/LightControler","DS/Windows/Panel"],function(e,t,i,r,s,n,a,o,l,h){"use strict";function d(e,t){for(var i in t.windows){var r=t.windows[i];if(r!==e&&0!==e.currentDockArea&&r.currentDockArea===e.currentDockArea){e.attachToWindow(r,WUXSnapAreaEnum.InsideArea),e.windowGroup.verticallyStretchableFlag=!0,e.windowGroup.allowedDockAreas=WUXDockAreaEnum.LeftDockArea|WUXDockAreaEnum.RightDockArea;break}}}return t.extend({init:function(e){this.urban=e,this.build()},build:function(){this.frmWindow=this.urban.frmWindow,this.createPanels()},addDebugPanel:function(e,t){var i=this,r=new h({title:e,content:t,immersiveFrame:this.frmWindow.getImmersiveFrame(),visibleFlag:!0,closeButtonFlag:!1,allowedDockAreas:WUXDockAreaEnum.LeftDockArea|WUXDockAreaEnum.RightDockArea,currentDockArea:WUXDockAreaEnum.RightDockArea,collapsibleFlag:!1,resizableFlag:!0,verticallyStretchableFlag:!0,height:340,minWidth:400,width:400});return r.getContent().addClassName("xCity-wux-window"),r.addEventListener("stopWindowDrag",function(e){d(e.dsModel,i.frmWindow.getImmersiveFrame())}),d(r,this.frmWindow.getImmersiveFrame()),r},createPanels:function(){var e=new i;this.timeControlerPanel=this.addDebugPanel("Time Controller",e.container);var t=new s;this.animationPanel=this.addDebugPanel("Animation",t.container);var h=new r;this.debugControlsPanel=this.addDebugPanel("Debug Controls",h.container);var d=new n;this.atmosphereControlsPanel=this.addDebugPanel("Atmosphere Controls",d.container);var u=new a;this.cloudsControlsPanel=this.addDebugPanel("Clouds Controls",u.container);var c=new o;this.pbrControlsPanel=this.addDebugPanel("Pbr Controls",c.container),c.setup();var p=new l;this.lightControlsPanel=this.addDebugPanel("Light Controls",p.container)},hide:function(){this.timeControlerPanel.visibleFlag=!1,this.debugControlsPanel.visibleFlag=!1,this.animationPanel.visibleFlag=!1,this.atmosphereControlsPanel.visibleFlag=!1,this.cloudsControlsPanel.visibleFlag=!1,this.pbrControlsPanel.visibleFlag=!1,this.lightControlsPanel.visibleFlag=!1},show:function(){this.timeControlerPanel.visibleFlag=!0,this.debugControlsPanel.visibleFlag=!0,this.animationPanel.visibleFlag=!0,this.atmosphereControlsPanel.visibleFlag=!0,this.cloudsControlsPanel.visibleFlag=!1,this.pbrControlsPanel.visibleFlag=!1,this.lightControlsPanel.visibleFlag=!1}})}),define("DS/XCityModel/PointOfInterest",["DS/XCityModel/Location","DS/XCityModel/Item","DS/XCityGeometry/PointOfInterest","DS/XCityRendering/RenderingHandlerPointOfInterest","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s,n){"use strict";var a=e.extend({defaults:{classStyle:"poiText"},metaData:{type:"Location",className:"PointOfInterest"},setup:function(){this._parent(),this._poi=void 0,this._scaleZ=!0,this.addEvent("onChange:position",this._updatePosition,this),this.addEvent("onChange:classStyle",this._updateClassStyle,this)},destroy:function(e){this._poi&&(this._poi.remove(),this._poi.destroy()),this._parent(e)},create:function(e){if(!this._parent(e))return n.publish(n.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;var t=e._urban,r=this._attributes.groupId,s=(t.poiManager.addGroup(r,!0),this.getLocalPosition());return this._poi=new i(t,this,s,this.get("classStyle"),this._itemParent?this._itemParent.get("name"):"",void 0,void 0,void 0,this._itemParent.get("description")),this._poi.setUserData(this._itemParent),this._updateName(),this._setVisible(this._itemParent),this._initRenderingProfile(t,this._attributes),this._updateClassStyle(),this._poi.textDiv.dataModelID=this._itemParent.get("id"),n.publish(n.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()}),!0},_initRenderingProfile:function(e,t){this._rendering=new r(e,t),this.renderingProfileManager=e.getRenderingProfileManager(),this.renderingProfileManager.initRendering(this)},getRendering:function(){return this._rendering},redraw:function(){var e=this.getRendering();if(s.is(e)){var t=e.getCompleteMaterialInfo();s.is(t)&&s.is(t.classStyle)&&this.set("classStyle",t.classStyle)}},_updateClassStyle:function(){this._poi&&this._poi.updateClassName(this.get("classStyle"))},setItemParent:function(e){this._itemParent&&(this._itemParent.removeEvent("onChange:name",this._updateName),this._itemParent.removeEvent("onChange:selected",this._select),this._itemParent.removeEvent("onChange:visible",this._setVisible),this._itemParent.removeEvent("onChange:description",this._setDescription)),this._itemParent=e,e&&(this._itemParent.addEvent("onChange:name",this._updateName,this),this._itemParent.addEvent("onChange:selected",this._select,this),this._itemParent.addEvent("onChange:visible",this._setVisible,this),this._itemParent.addEvent("onChange:description",this._setDescription,this),this._poi&&this._poi.setUserData(e),this._updateName()),this._poi&&this._poi.setUserData(this._itemParent)},_updatePosition:function(){this._parent();var e=this.getLocalPosition();this._poi&&this._poi.setPosition(e)},_updateName:function(){this._poi&&this._itemParent&&this._poi.setText(this._itemParent.get("name"))},_setDescription:function(){this._poi&&this._itemParent&&this._poi.setDescription(this._itemParent.get("description"))},_setVisible:function(e){var t=!!e.get("visible");this._poi&&(this._poi.setVisibility(t),this.getRoot()?this.getRoot()._urban.poiManager.check():this._root&&this._root._urban&&this._root._urban.poiManager&&this._root._urban.poiManager.check())},_select:function(e){this._poi&&this._poi.select(e.get("selected"))}});return t.ObjectContructor.PointOfInterest=a}),define("DS/XCityGeometry/PatchVectorFactoryPointOfInterest",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PatchVectorFactoryPointGeometry","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/XCityModel/Folder","DS/XCityModel/Feature","DS/XCityModel/PointOfInterest","DS/XCityLayer/Vector","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s,n,a,o,l,h,d){"use strict";return i.extend({init:function(e,t,i){this._parent(e,t,i),this.urban=e,this.color=t.color||"#ffffff",this.groupId=i,this.attrName=void 0!==t.attributName?t.attributName:"NAME",this.attrClass=void 0!==t.attributClass?t.attributClass:"STYLECLASS",this.attrAltitude=void 0!==t.attributAltitude?t.attributAltitude:"ALTITUDE",this.attrContent=void 0!==t.attributContent?t.attributContent:"CONTENT",this.stridAttribute=void 0!==t.stridAttribute?t.stridAttribute:"STRID",this.privateFolder=this.urban._dataModelPrivate.findChildById("vector_poi"),void 0===this.privateFolder&&(this.privateFolder=new a({id:"vector_poi",name:"vector_poi",visible:!0,opened:!1}),this.urban._dataModelPrivate.addChild(this.privateFolder)),this._node=new r,this._node.add=this.addToScene.bind(this),this._node.remove=this.removeFromScene.bind(this),this._node.setVisibility=function(){},this._node.name="FactoryPointOfInterrest",d.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},destroy:function(){},dispose:function(){n.warn("Dispose: PatchVectorFactoryPointOfInterest")},addToScene:function(e){var t,i;if(this._node.addChild(e),e&&e.pois)for(t=0,i=e.pois.length;t<i;++t)e.pois[t].setVisible(!0)},removeFromScene:function(e){var t,i;if(this._node.removeChild(e),e&&e.pois)for(t=0,i=e.pois.length;t<i;++t)e.pois[t].setVisible(!1)},initMesh:function(e,t,i,r,s){},getData:function(e){var t=new r;return t.name="FakeNode3DPerPOI2DTile",t.pois=e.pois,t},buildOne:function(e,i,r){void 0===i.pois&&(i.pois=[]);var s=e.getGeometry();if(s.type===h.Type.POINT){var n,a=s.getVertices(),d=e.getAttribute(this.attrName),u=e.getAttribute(this.attrClass),c=(Number(e.getAttribute(this.attrAltitude)),e.getAttribute(this.attrContent)),p=new l({groupId:this.groupId,altitudeMode:"relative",position:new t.Vector3(a[0],a[1],0),classStyle:u});for(n in void 0!==p.userData&&null!==p.userData||(p.userData={content:c}),r.userData)void 0!==p.userData[n]?p.userData[n]=[p.userData[n],r.userData[n]]:p.userData[n]=r.userData[n];var f=new o({id:d,name:d,visible:!1});f.set("Content",p),i.pois.push(f),this.privateFolder.addChild(f)}},select:function(e){var t=this;this.privateFolder&&this.privateFolder.traverse(function(i){i.getContent().get("groupId")===t.groupId&&i.getContent()._select(e)})},hoverable:function(e){var t=this;this.privateFolder&&this.privateFolder.traverse(function(i){i.getContent().get("groupId")===t.groupId&&i.set("hoverable",e.get("hoverable"))})},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1}})}),define("DS/XCityModel/RdbLink",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityModel/Item","DS/XCityModel/Content","DS/XCityModel/LayerVectorPrimitive","DS/XCityModel/LayerVectorCluster","DS/XCityGeometry/PatchVector","DS/XCityGeometry/PatchVectorCityFormat","DS/XCityGeometry/PatchVector3DXMFormat","DS/XCityGeometry/PatchVectorFactoryBuilding","DS/XCityGeometry/PatchVectorFactoryCrossQuad","DS/XCityGeometry/PatchVectorFactoryTree","DS/XCityGeometry/PatchVectorFactoryElement","DS/XCityGeometry/PatchVectorFactoryFile","DS/XCityGeometry/PatchVectorFactoryModel","DS/XCityGeometry/PatchVectorFactoryParticle","DS/XCityGeometry/PatchVectorFactoryPointOfInterest","DS/XCityGeometry/PatchVectorFactoryPointOfInterest3D","DS/XCityGeometry/PatchVectorFactoryMarker","DS/XCityGeometry/PatchVectorFactoryLine","DS/XCityGeometry/PatchVectorFactoryPolygon","DS/XCityGeometry/PatchVectorFactoryGeometry","DS/XCityGeometry/PatchVectorFactoryPipe","DS/xCityBasicUtils/Utils","DS/XCityLayer/VectorLoaderGML","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/VectorLoaderEnovia","DS/XCityLayer/Vector","DS/XCityCore/Store","DS/XCityTools/EventDispatcher","DS/XCityTools/RTree","DS/XCityTools/Downloader","DS/XCityTools/Disposer","DS/XCityTools/ExpressionEvaluator","DS/XCityTools/Expression","DS/xCityGlobeUtils/xCityDatasetServices","DS/WebappsUtils/WebappsUtils"],function(e,t,i,r,s,n,a,o,l,h,d,u,c,p,f,m,g,v,_,y,b,x,C,S,D,P,w,M,T,I,R,A,F,L,V,O,N){"use strict";var U=r.extend({defaults:{levelMin:0,levelMax:-1,priority:3,priorityOffset:1,cache:50,lodBias:0,AABBox:null,Clustering:null,type:"json",url:"",listenToDateUpdate:!1,upTime:"",downTime:"",invertY:!1,alternUrl:"",alternDict:[],geolocalized:!0,interactionBehaviours:{onSelect:{label:!0},onHover:{label:!0}}},metaData:{type:"LayerVector",className:"RdbLink"},loaderJSON:{Factory:"loadJSONFactory",AABBox:"loadJSONAABox",Clustering:"loadJSONClustering"},loadJSONClustering:function(e,t,i,r){i.className&&"Clustering"!==i.className||this.set(t,{enable:i.enable,nbSteps:i.nbSteps,minimumHits:i.minimumHits})},computeSteps:function(e){for(var t=[2],i=Math.log(this._nhitsTotal)/e,r=1;r<=e;++r)t.push(Math.ceil(Math.exp(r*i)));return t=[2,10,100,1e3,1e4,1e5,1e6,1e7]},setClustering:function(e){var t={enable:!(!e||!e.enable)&&e.enable,nbSteps:e&&e.nbSteps?e.nbSteps:6,minimumHits:e&&e.minimumHits?e.minimumHits:1};this.set("Clustering",t);var i=!0===t.enable;i&&!this.clusteringMode?this.create(this._root):!i&&this.clusteringMode&&this.create(this._root),t.nbSteps&&(this._clusterSteps=this.computeSteps(t.nbSteps),this._factory._clusterSteps=this._clusterSteps,this._patch&&T.traverse(this.get("id"),this._patch.rebuild.bind(this._patch),!1)),t.minimumHits&&(this._factory._minimumHits=t.minimumHits)},setup:function(){this._parent(),this._patch=void 0,this._factory=void 0,this._quadTree=void 0,this._manager=void 0,this._node=void 0,this.isLayer=!0,this.clusterlimit=1},destroy:function(e){this._manager.removeDataSource(this.get("id")),this._factory.destroy(),T.deleteStore(this.get("id")),this._parent(e)},createPrimitive:function(e,t){var i;if(this._factory&&this._factory.getGeoJSON&&(i=this._factory.getGeoJSON(e)),void 0===t&&this._factory.instancing&&this._patch&&this._patch.miDToTile[e]&&this._patch.miDToTile[e].geom&&this._patch.miDToTile[e].geom[0]){var r=this._patch.miDToTile[e].geom[0].mesh.mesh3js.userData.cgmIds;if(r)for(var n=0;n<r.length;++n)if(r[n]===e){t=5*n+5;break}}var a=new s({strid:e,geojson:i,instanceId:t});return this._patch&&this._patch.miDToTile[e]&&this._patch.miDToTile[e].indexMesh>-1&&(a.indexMesh=this._patch.miDToTile[e].indexMesh),a.setLayerVector(this),a.create(this.getRoot()),a},createCluster:function(e,t,i){var r;this._factory&&this._factory.getGeoJSON&&(r=this._factory.getGeoJSON(e));var s=new n({strid:e,geojson:r,instanceId:t,clusterInfo:i});return s.setLayerVector(this),s.create(this.getRoot()),s},loadJSONFactory:function(e,t,i,r){var s=i.className;s||(s=r.factory),"building"===(s=s.toLowerCase())?this._factory=new h(e,i):"crossquad"===s?this._factory=new d(e,i,this.get("url")):"tree"===s?this._factory=new u(e,i,this.get("url")):"element"===s?this._factory=new c(e,i,this.get("url")):"placemark"===s?this._factory=new m(e,i):"file"===s?this._factory=new p(e,i):"model"===s?this._factory=new f(e,i,this.get("type")):"pointofinterest"===s?this._factory=new g(e,i,r.cid):"pointofinterest3d"===s?this._factory=new v(e,i):"marker"===s?this._factory=new _(e,i,r.get("id")):"linestring"===s?this._factory=new y(e,i):"polygon"===s?this._factory=new b(e,i):"pipe"===s?this._factory=new C(e,i):"geometryset"===s&&(this._factory=new x(e,i)),void 0===this._factory.toJSON&&(this._factory.toJSON=function(){return i}),this._factory.setProgressCallback(this._onProgress.bind(this))},toJSON:function(e){var t=this._parent(e);return this._factory&&(t.Factory=this._factory.toJSON()),t},_createNewStore:function(){T.getStoreList().indexOf(this.get("id"))>-1&&T.deleteStore(this.previous("id"));var e={url:this.get("url"),listenToDateUpdate:this.get("listenToDateUpdate"),upTime:this.get("upTime"),downTime:this.get("downTime"),cacheSize:this.get("cache"),priority:this.get("priority")};this.clusteringMode&&(e.url=e.url.concat("&clustered=true&clusterlimit="+this.clusterlimit+"&averagecount=20")),this.isWFS&&(e.url=e.url.concat("&limit=200")),e.url.search("%xmin")>-1&&e.url.search("%xmax")>-1&&e.url.search("%ymin")>-1&&e.url.search("%ymax")>-1?e.wms={worldSize:this._root._urban.worldSize,shiftedPosition:this._root._urban.shiftedPosition}:e.tile={worldSize:this._root._urban.worldSize,shiftedPosition:this._root._urban.shiftedPosition},void 0!==this._storeOptions&&(e.dataDownloader=this._storeOptions.dataDownloader,e.dataBuilder=this._storeOptions.dataBuilder,e.dataCleaner=this._storeOptions.dataCleaner,e.invertY=this._storeOptions.invertY,e.dlOptions=this._storeOptions.dlOptions,e.onFinish=this._storeOptions.onFinish,e.resultEditor=this._storeOptions.resultEditor),this._shouldUpdateProgress()&&(e.getProgress=this._storeOptions.getProgress,e.setProgress=this._storeOptions.setProgress),T.createStore(this.get("id"),e)},requestProxyInformation:function(e){var t=this;O.getProxyInformation(e).then(function(i){if(200===i.request.status){t._factory._isReady=!0,t._attributes.userData.proxyInformation=i.data;var r="xCityTreeviewSimpleFeatures.png";if(t._attributes.userData.proxyInformation.layerInformation.inReferentialContext){var s=t._attributes.userData.proxyInformation.layerInformation.inReferentialContext.geometryTypeMap,n=0;s&&((s.Point&&s.Point>0||s.MultiPoint&&s.MultiPoint>0)&&(r="xCityTreeviewPoint.png",n++),(s.LineString&&s.LineString>0||s.MultiLineString&&s.MultiLineString>0)&&(r="xCityTreeviewLine.png",n++),(s.Polygon&&s.Polygon>0||s.MultiPolygon&&s.MultiPolygon>0)&&(r="xCityTreeviewPolygon.png",n++),n>1&&(r="xCityTreeviewSimpleFeatures.png"))}else t._attributes.userData.proxyInformation.layerInformation.inReferentialContext={featureCount:t._attributes.userData.proxyInformation.layerInformation.featureCount,geometryTypeMap:{Point:"NA",MultiPoint:"NA",LineString:"NA",MultiLineString:"NA",Polygon:"NA",MultiPolygon:"NA"}};var a=N.getWebappsAssetUrl("xCityUI","icons/TreeView/")+r;t._itemParent.userData=t._itemParent.userData||{},t._itemParent.userData.iconUrl=a;var o=t._getProgress();o&&(o.loaded+=1,o.total+=1,t._onProgress(o))}else 202===i.request.status&&(t._nbIterationWFS||(t._nbIterationWFS=0),t._nbIterationWFS<5?(t._nbIterationWFS++,window.setTimeout(t.requestProxyInformation.bind(t,e),5e3)):t._factory._isReady=!0)})},create:function(e){if(!this._parent(e))return I.publish(I.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;var i=e._urban;this._urban=i;var r=null,s=null,n=this.get("type");"json"===n?r=new P:"wfs"===n?r=new P("wfs"):"gml"===n?r=new D:"enovia"===n&&(r=new w(i)),this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null;var h=this.toJSON();if(h.previewMode="enovia"===this.get("type")||"wfs"===this.get("type"),this.isWFS="wfs"===this.get("type"),this.isWFS){this._factory._isReady=!1;var d=N.getWebappsAssetUrl("xCityUI","icons/TreeView/")+"xCityTreeviewSimpleFeatures.png";this._itemParent.userData=this._itemParent.userData||{},this._itemParent.userData.iconUrl=d,this.requestProxyInformation(this.get("objectId")),this.addEvent("onChange:levelMin",this._updateLevelMin)}if(h.Clustering&&h.Clustering.enable&&!this.isWFS){this.clusteringMode=!0,this._nhitsTotal=1e4,this._factory._isReady=!1;let e=!1;if(h.previewMode)u=(u=this.get("url").concat("&clustered=true&clusterlimit=1&averagecount=2")).replace("%l",0).replace("%x",0).replace("%y",0);else{var u=this.get("url");if(A.wasAPlatformService(u))u=A.getDataSupplierUrlFromUrl(u),e=!0;else{var c=u.indexOf("datasupplier"),p=u.indexOf("?"),f=u.slice(p),m=this.get("objectId").length;u=(u=u.slice(0,c+18+m)).concat(f),e=!0}}var y=function(e,t){if(t){var i=JSON.parse(e);if(h.previewMode)this._nhitsTotal=i.nhits;else if(i.statistics)this._nhitsTotal=i.statistics.geoItemCount;else{var r=Object.keys(i.analytics.geoItemTypeList)[0];this._nhitsTotal=i.analytics.geoItemTypeList[r].count}var s=this.get("Clustering").nbSteps||6;this._clusterSteps=this.computeSteps(s),this._factory._clusterSteps=this._clusterSteps,this._factory._nhitsTotal=this._nhitsTotal}this._factory._isReady=!0};const t="undefined"!=typeof xCity&&xCity.widgetData&&xCity.widgetData.datasetCollection,r=A.getUuidFromUrl(u);e&&t&&t.get(r)?setTimeout(y.bind(this),0,JSON.stringify(t.get(r)),!0):A.download(u,{},9999999,function(e,t,i,r){r(t,e,i)},void 0,y.bind(this)),this.setClustering(h.Clustering),!1===h.previewMode&&(s=new w(i))}else this.clusteringMode=!1;if(h.clusteringMode=this.clusteringMode,this._factory){this._node=this._factory._node,this._storeOptions=void 0;var b=this._attributes.url.split(".");if("3DXM"===n||"3DXC"===n||"3dxc"===b[b.length-1].toLowerCase()?(this._patch=new l(i,this._factory,h),this._storeOptions={dataBuilder:this._patch.build.bind(this._patch,i,this.get("geolocalized"),this._attributes.priority),dlOptions:{responseType:"arraybuffer"},invertY:this.get("invertY"),onFinish:{func:this._onFinish.bind(this),bound:this}},this._createNewStore()):"cty"===n||"city"===n?(this._patch=new o(i,this._factory,h),this._storeOptions={dataBuilder:this._patch.buildV2.bind(this._patch,r,i,this.get("geolocalized")),dlOptions:{responseType:"arraybuffer"},invertY:this.get("invertY"),onFinish:{func:this._onFinish.bind(this),bound:this}},this._createNewStore()):(this._patch=new a(i,this._factory,h),this._storeOptions={dataBuilder:this._patch.buildV2.bind(this._patch,r,s,i),invertY:this.get("invertY"),onFinish:{func:this._onFinish.bind(this),bound:this},dataCleaner:h.clusteringMode?this._dataCleaner.bind(this):void 0,resultEditor:h.clusteringMode?this._resultEditor.bind(this):void 0},this._shouldUpdateProgress()&&(this._storeOptions.setProgress=this._onProgress.bind(this),this._storeOptions.getProgress=this._getProgress.bind(this)),this._createNewStore()),this.isWFS&&h.Clustering&&h.Clustering.enable&&(this.clusteringMode=!0,this._patch.clusteringMode=this.clusteringMode,this.setClustering(h.Clustering)),this._factory.patch=this._patch,this._factory instanceof g&&(this._itemParent.addEvent("onChange:hoverable",this._factory.hoverable,this._factory),this._itemParent.addEvent("onChange:selected",this._factory.select,this._factory)),this._factory instanceof _&&this._itemParent.addEvent("onChange:selected",this._factory.select,this._factory),this._factory instanceof v&&this.clusteringMode,this._factory instanceof v&&this._factory.isBillboard()){var C=this.get("url");if(A.isAPlatformService(C)){var S=this._getDatasetBaseUrl(C),M=S.length,T=S.indexOf("resources");T>=M-10&&(S=S.slice(0,T));var R=S+"resources/",F=this._getUrlOptions(C),L={mapUrl:new V(R).add((new V).propertyName("FILENAME").add(F))};this.getRendering().addDefaultDatavizMapping(L)}}if(this._factory instanceof v&&this._factory.alwaysDisplayText){this.set("label",{enable:!0});var O={label:{name:xCity.createExpression().propertyName(this._factory.nameAttribute)}};xCity.getSessionRenderingProfile().addDatavizRendering(this.parentFeatureID,O),this._factory.alwaysDisplayText=!1}this.addEvent("onChange:url",this._createNewStore),this.loadStyle()}else{var U=this.get("type"),E=this;this._patch=new a(i,{},{});var k={extension:U,rendering:E.getRendering(),uidToPrim:{}};k.url=this.get("url"),E._node=i.modelLoader.load(k,function(e){k.patch=E._patch,E._node.addChild(e)}),this._node=new t,this._node.name="RdbLink"}return this._node.userData=this._itemParent,this._factory instanceof x&&(this._factory._factoryPoint._node.userData=this._itemParent,this._factory._factoryLine._node.userData=this._itemParent,this._factory._factoryPolygon._node.userData=this._itemParent),h.filterLevelMax=!0,h.visible=this._itemParent.get("visible"),i.USR.vqtPo.addDataSource(h,this._node),this._manager=i.USR.vqtPo,this.renderingProfileManager.initRendering(this),this._elevationRetroCompatibilty(),this._updateGeometryTags(),!0},_shouldUpdateProgress:function(){const e=["FactoryModel","Buildings"];return!(this._factory&&this._factory._node&&this._factory._node.name)||!e.includes(this._factory._node.name)},_elevationRetroCompatibilty:function(){if(S.is(this._factory)){var e,t=!1;this._factory instanceof y&&(e=this.get("elevationOffset"))!==this.getRenderingHandler().defaultRendering.get("elevationOffset")&&S.is(this._factory._initialHeightOffset)&&(e+=this._factory._initialHeightOffset+this._factory._initialHeightOffset,t=!0),this._factory instanceof b&&(e=this.get("elevationOffset"))!==this.getRenderingHandler().defaultRendering.get("elevationOffset")&&S.is(this._factory._initialHeightOffset)&&(e+=this._factory._initialHeightOffset,t=!0),t&&(this.set("elevationOffset",e),this._factory._initialHeightOffset=null,this.renderingProfileManager.updateFeatureRendering(this))}},_onFinish:function(e){I.publish(I.eventsList.onLoaded+":"+this.get("id"),{success:e,item:this.getItemParent()})},_onProgress:function(e){this.set("loadInfo",e)},_getProgress:function(e){return this.get("loadInfo")},getRenderingHandler:function(){var e=null;return S.is(this._rendering)?e=this._rendering:this._factory&&(S.is(this._factory._rendering)?e=this._factory._rendering:this._factory.getRendering&&(e=this._factory.getRendering())),e},getRendering:function(){return this.getRenderingHandler()},redraw:function(){var e=this.getRendering();!0===e.needsRebuild()?(T.traverse(this.get("id"),this._patch.rebuild.bind(this._patch),!1),e.flagAsRebuilt(!0)):T.traverse(this.get("id"),e.applyRendering.bind(e))},resetFlags:function(){var e=this.getRendering();T.traverse(this.get("id"),e.resetFlags.bind(e))},redrawPrimitive:function(e){if(S.is(this._patch)){var t=this.getRendering();S.is(t)&&(t.isPrimitiveRegistered(e)?t._renderprimitive(e):this.registerPrimitive(e))}},registerPrimitive:function(e){if(S.is(this._patch)){var t=this.getRendering();S.is(t)&&(t.isPrimitiveRegistered(e)||t.registerPrimitive(this._patch,e))}},registerPrimitives:function(e){var t,i,r=Object.keys(e),s=r.length;for(t=0;t<s;t++)i=r[t],this.registerPrimitive(i)},each:function(e,t){return e instanceof Function&&(t=e),this._patch&&this._patch.each(t),T.traverse(this.get("id"),this._patch.each.bind(this._patch,t),!1),this},filter:function(e,t){return e instanceof Function&&(t=e),this._patch&&this._patch.filter(t),T.traverse(this.get("id"),this._patch.filter.bind(this._patch,t),!1),this},reset:function(){return this._patch&&this._patch.reset(),T.traverse(this.get("id"),this._patch.reset.bind(this._patch),!1),this},register:function(e){this._patch&&this._patch.register(e.get("strid"),e.addSubElements.bind(e))},unregister:function(e){this._patch&&this._patch.unregister(e.get("strid"),e.addSubElements.bind(e))},getBoundingSphere:function(){if(this._factory instanceof v){var t=this._factory.maxMinMax;if(t){var i=new e.Vector3(this._node.bSphere.center.x,this._node.bSphere.center.y,(t.minZ+t.maxZ)/2),r=Math.sqrt(Math.pow(t.maxX-t.minX,2)+Math.pow(t.maxY-t.minY,2)+Math.pow(t.maxZ-t.minZ,2))/2;return new e.Sphere(i,r)}}return this._node.bSphere},getLocalPosition:function(){if(this.get("AABBox")){var t=this.get("AABBox").getCenter();return new e.Vector3(t.x,t.y,0)}},getSphereDiameter:function(){if(this.get("AABBox")){var e=this.get("AABBox").getSize();return Math.max(e.x,e.y)}},setFactoryAttribute:function(e,t){this._factory&&this._factory.setAttribute(e,t)&&(T.traverse(this.get("id"),this._factory.updateAttribute.bind(this._factory,e)),this.dispatchEvent("onChange:factoryAttribute:"+e,t))},setItemParent:function(e){this._itemParent&&(this._itemParent.removeEvent("onChange:visible",this._itemParentVisible),this._itemParent.removeEvent("onChange:tags",this._updateGeometryTags,this)),this._parent(e),this._itemParentVisible(e),this._itemParent&&(this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this),this._itemParent.addEvent("onChange:tags",this._updateGeometryTags,this))},_itemParentVisible:function(e){this._created&&(this._node.setVisibility(e.get("visible")),this._manager.setDataSourceAttribute(this.get("id"),"visible",e.get("visible")))},_updateGeometryTags:function(){if(void 0!==this._itemParent&&void 0!==this._node){var e=this._itemParent.get("tags");e&&-1!==e.indexOf("UNDERGROUND")?this._node.setRenderPasses(["UNDERGROUND_PREPASS","UNDERGROUND_POSTPASS"]):this._node.setRenderPasses(["main"]),I.publish("/xCity/needRender",this)}},modifier:function(e,t){var i=this;T.traverse(this.get("id"),function(t){var r,s=i._patch.getUidListeners(),n=t.userData.source,a=new M.Feature,o=i._factory.stridAttribute||"STRID";for(n.index=0;a=n.getNextFeature(a);)(r=s[a.getAttribute(o)])&&r.geom&&e(a,r)}),S.is(t)&&this._patch.each(function(e){return t(e)})},colorize:function(e){var t,i,r=this,s=this._factory,n={color:s.colorAttribute||"color",opacity:s.opacityAttribute||"opacity",id:s.stridAttribute||"STRID"},a=this.renderingProfileManager;t=function(t,i){var o,l,h=s.getDatas(i),d=h.length;for(l=0;l<d;l+=1)h[l].attributes.center=t.getCenter(),(o=e(h[l].attributes)||!1)&&a.addPrimitiveRenderingNoDraw(r.parentFeatureID,o,t.getAttribute(n.id))},i=function(t){t.attributes.center=t.getCenter();var i=e(t.attributes);return i&&a.addRendering(r.parentFeatureID,i,t.getAttribute(n.id)),t},this.modifier(t,i),this.renderingProfileManager.setRender(this.get("id"))},findPrimitivesByCriteria:function(e){var t,i,r=this._factory,s={color:r.colorAttribute||"color",opacity:r.opacityAttribute||"opacity",id:r.stridAttribute||"STRID"},n=new L(e),a={};return S.is(n)?(i=function(e){return n.apply(e)},t=function(e,t){var n=r.getDatas(t);n.length;!0===(i(e.attributes)||!1)&&(a[e.getAttribute(s.id)]=n[void 0])},this.modifier(t),a):null},search:function(e,i,r,s,n){return new Promise((s,a)=>{var o=this.get("objectId");null==e&&(e=[[{operator:"equals",attribute:"datasetUuid",value:o}]]),null==e&&(i=[]),null==r&&(r=xCity.widgetData.currentReferential.get("uuid"));var l={datamodel:"geoItemDatasetRepresentation",referentialUuid:r,filterList:e,spatialFilterList:i};n&&(l.response=n);var h=function(e,i,r){if(console.log("SEARCH REQUEST RECEIVED"),0===e.nhits){var n={nhits:e.nhits,offset:e.offset};s({primitiveList:[],info:n})}else{this.searchNode=new t,this.searchNode.name="searchNode";var a=new t;this.searchNode.addChild(a);var o=this.searchNode.removeChild.bind(this.searchNode),l=this.searchNode.addChild.bind(this.searchNode);this.searchNode.removeChild=function(e){console.log("SEARCH NODE READY"),o(e)},this.searchNode.addChild=function(t){console.log("SEARCH NODE ADDED"),l(t);for(var i=[],r=t.userData.records,n=0;n<r.length;++n)i.push(r[n].strid);var a={nhits:e.nhits,offset:e.offset};s({primitiveList:i,info:a})};var h={key:"searchRequest",value:{node:a},oldValue:[],url:void 0,tile:{LOD:0,I:1,J:0},bbox:{xmin:-9999999999.9,ymin:-9999999999.9,xmax:9999999999.9,ymax:9999999999.9},timestamp:this._timestamp,requeststamp:this._timestamp,dlOptions:this._dlOptions,callbacks:[],locks:0,deprecated:!1,isVisible:!0,tmp:!1,undeletable:!1,temporary:!0};this._storeOptions.dataBuilder(h,e),this._node.addChild(this.searchNode)}}.bind(this),d={method:"POST",type:"json",proxy:"passport",headers:{"content-type":"application/json;charset=UTF-8"},data:JSON.stringify(l),onComplete:h,onFailure:function(e,t,i){a(t)}},u=A.getDataSupplierUrl(!0)+"search?tenant="+A._platformID+"&xrequestedwith=xmlhttprequest";A.authenticatedRequest(A.resolveUrl(u),d)})},getFactory:function(){return this._factory},_dataCleaner:function(e){this._factory.disposeRtree(e.node),F.disposeV6(e)},highlight:function(){},unhighlight:function(){},_updateLevelMin:function(){this._manager.setDataSourceAttribute(this.get("id"),"levelMin",this.get("levelMin")),T.traverse(this.get("id"),this._patch.rebuild.bind(this._patch),!1)},_resultEditor:function(e,t,i){return void 0!==(e=JSON.parse(e)).cluster&&(e.hits=[],e.hits.push({}),e.hits[0].metas=[],e.hits[0].metas.push({name:"STRID",value:i.key}),e.hits[0].metas.push({name:"gdal_default_geo",value:e.cluster.center}),e.hits[0].metas.push({name:"nhits",value:e.nhits}),e.cluster.bbox&&e.hits[0].metas.push({name:"bbox",value:e.cluster.bbox}),e.cluster.radius&&e.hits[0].metas.push({name:"radius",value:e.cluster.radius}),e.cluster.magnitude&&e.hits[0].metas.push({name:"magnitude",value:e.cluster.magnitude}),e.nmatches=e.nhits,e.nhits=1,e.hits.length=1),e}});return i.ObjectContructor.LayerVector=i.ObjectContructor.RdbLink=U});