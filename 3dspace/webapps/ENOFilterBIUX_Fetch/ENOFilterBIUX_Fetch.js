define("DS/ENOFilterBIUX_Fetch/Fetch_FBIComponentProxy",["UWA/Core","UWA/Controls/Abstract","UWA/Class/Events","DS/Windows/Dialog","DS/Windows/ImmersiveFrame","DS/Controls/Button","DS/Controls/Toggle","DS/TagNavigatorProxy/TagNavigatorProxy","DS/ENOFilterBIUX/Abstract_FBIComponentProxy","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/FBISettings","DS/ENOFilterBIUX/FBIProxyServices","DS/ENOFilterBIUX/NGFServices","UWA/Promise","DS/PlatformAPI/PlatformAPI","i18n!DS/ENOFilterBIUX/assets/nls/ENOFilterBIUX"],function(e,t,i,s,r,a,n,l,o,h,c,g,u,d,f,_){"use strict";return o.extend({init:function(e){this._parent(e),this._defaultServiceId="3DSpace"},_setDataModel:function(e){this._summary=this._volatileTags?this._volatileTags.concat(e.summary):e.summary,this._odtSummary=this._volatileTags?this._volatileTags.concat(e.summary):e.summary,this._grouped=e.grouped},setPathTags:function(t,i){var s,r=this,a=!1;if(r._setPathTagsWithSynthesis=!0,this._nodesIN=e.clone(t.nodes,!1),this._tree=[],this._allNodes&&this._allNodes.length)for(var n=0;n<t.nodes.length;n++)this._allNodes.indexOf(t.nodes[n])<=-1&&(this._allNodes.push(t.nodes[n]),a=!0);else(!this._allNodes||this._allNodes&&0===this._allNodes.length)&&(this._allNodes=e.clone(t.nodes));s=h.convertFromIndexToPID(t.nodes,t.paths);for(var l=0;l<t.paths.length;l++)this._tree.push({id:s[l],path:t.paths[l]}),this._unFilteredPathIDs.indexOf(s[l])<0&&this._unFilteredPathIDs.push(s[l]);h.convertFromPIDToIndexAsync(this._allNodes,this._unFilteredPathIDs,this,function(e){this._unfilteredTree=[];for(var s=0;s<e.length;s++)this._unfilteredTree.push({id:this._unFilteredPathIDs[s],path:e[s]});if(t.nodes.length){if(h._setTree(r._tree),h._setNodes(t.nodes),this.myTagProxy&&this.myTagProxy.getCurrentFilter()&&this.myTagProxy.getCurrentFilter().allfilters&&Object.keys(this.myTagProxy.getCurrentFilter().allfilters).length&&(a||this._needsFiltering(this.myTagProxy.getCurrentFilter(),this._tagData||{})))return void this.filterBIFilter(this.myTagProxy.getCurrentFilter());r.checkBeforeSynthFetch(t.nodes).then(function(e){e?r._launchFetchWithSynthesis(t.nodes,r._defaultServiceId).then(function(e){e=r._volatileTags?r._volatileTags.concat(e):e,r._setTags(null,e),i&&i()},function(e){console.log("_launchFetchWithSynthesis failure")}):r._setTags(null,[])})}else{var n={summary:[],suggested:[]};r._setDataModel(n),r._setTags(null,n.summary),i&&i()}})},setTagsWithFetchSynthesis:function(t,i,s){var r=this;if(t.length)e.merge(this.optionsToKeep,this._completeAppOptions(this.optionsToKeep)),this._fetchWithSynthesis=!0,this._keepRootsInSession(t),this._keepRootsAliasInSession(t),void 0===r._tagData&&r.myTagProxy&&r.myTagProxy.getCurrentFilter()&&r.myTagProxy.getCurrentFilter().allfilters&&Object.keys(r.myTagProxy.getCurrentFilter().allfilters).length&&r._keepTagDataInSession(r.myTagProxy.getCurrentFilter()),!s&&r._tagData&&Object.keys(r._tagData).length&&Object.keys(r._tagData.allfilters).length?r.filterBIFilter(r._tagData,!0):r.checkBeforeFetch(t).then(function(e){e?r._launchFetchWithSynthesis(t,r._defaultServiceId).then(function(e){e=r._volatileTags?r._volatileTags.concat(e):e,r._setTags(null,e),i&&i()},function(e){console.log("ERROR : setTagsWithFetchSynthesis: _launchFetchWithSynthesis failure"),r._setTags(null,[])}):(console.log("ERROR :setTagsWithFetchSynthesis, non okForFetch"),r._setTags(null,[]))},function(e){console.log("ERROR : setTagsWithFetchSynthesis: checkBeforeFetch failure"),r._setTags(null,[])});else{var a=r._volatileTags?r._volatileTags:[];r._setTags(null,a)}},onApplyNGFilter:function(e){e.empty?(this._updateFilteredRootsInSession(e.filterRootIds[0]),u.setUsageTracker(this._widgetId,"NGF-Tagger-ApplyNGFilter","Empty")):(this._keepRootsInSession(e.filterRootIds),e=this.completeCVQueryWithAppParams(e,this._expandIterParam,this._expandWithSynthesis),this._updateFilteredRootsInSession(e.filterRootIds[0],e),this._shareFilterSpec&&this._keepShareSpec(e),e.filterId&&this._keepFilterIdInSession(e.filterRootIds[0],e.filterId)),this.cleanUselessDataForApps(e),console.log(e),u.setUsageTracker(this._widgetId,"NGF-Tagger-ApplyNGFilter","NGF only"),this.dispatchEvent("ApplyNGFilterAbstract",e)},_filtering:function(e,t,i){Object.keys(t).length?this._grouped?(e=this._filterPredicatesAndTags(t),i.filteredSubjectList=this._computeFilters(e,t),i.filteredPathIDList=h.convertFromIndexToPID(this._allNodes,i.filteredSubjectList)):(i.nodes=this._allNodes,i.filteredSubjectList=[],i.filteredPathIDList=[]):(i.nodes=this._allNodes,i.filteredSubjectList=h.convertFromPIDToIndex(this._allNodes,this._unFilteredPathIDs),i.filteredPathIDList=this._unFilteredPathIDs),i.nodes=this._allNodes,this._filteredData.nodes=i.nodes,this._filteredData.paths=i.filteredSubjectList,this._needsCB(i)?this.dispatchEvent("FilterBIFilteringEvent",i):(this.myTagProxy&&(this.myTagProxy.filters=this.myTagProxy.getCurrentFilter()),this.myTagProxy.filters&&(this._filterBIToKeep=this.myTagProxy.filters),this._setTagsWIWIOr3DD(null,this._summary))},_needsCB:function(){var t,i=!1,s=[];if(data.filteredPathIDList&&data.filteredPathIDList.length)for(var r=0;r<data.filteredPathIDList.length;r++)for(var a=h.splitListOfPID(data.filteredPathIDList[r]),n=0;n<a.length;n++){t=!1;for(var l=0;l<s.length;l++)e.equals(a[n],s[l])&&(t=!0);!1!==t&&0!==s.length||s.push(a[n])}if(this._nodesIN.length)if(s.length===this._nodesIN.length)for(var o=0;o<this._nodesIN.length;o++){for(var c=!1,g=0;g<data.nodes.length;g++)if(s[g]===this._nodesIN[o]){c=!0;break}if(!1===c){i=!0;break}}else i=!0;else s.length&&(i=!0);return i},displayWarningPanel:function(){var t=this,i=new r;return i.inject(document.body),new d(function(r,l){if(sessionStorage.getItem("FBI_toggleWarningHugeStructure"))r(sessionStorage.getItem("FBI_choiceWarningOK"));else{var o=e.createElement("div",{html:"<p>"+_.get("hugeNumberodfObjects")+"<br><br>"+_.get("validProceedforFetch")+"<br></p>"}),h=new n({label:_.get("DoNotAskAgain"),checkFlag:!1});h.inject(o),h.addEventListener("buttonclick",function(e){sessionStorage.getItem("FBI_toggleWarningHugeStructure")?sessionStorage.removeItem("FBI_toggleWarningHugeStructure"):sessionStorage.setItem("FBI_toggleWarningHugeStructure",!0)}),new s({title:"Warning",content:o,immersiveFrame:i,buttons:{Ok:new a({emphasize:"primary",onClick:function(e){e.dsModel.dialog.close(),sessionStorage.setItem("FBI_choiceWarningOK",!0),r(!0)}}),Cancel:new a({onClick:function(e){e.dsModel.dialog.close(),t._setTagsWIWIOr3DD(null,null),sessionStorage.setItem("FBI_choiceWarningOK",!1),r(!1)}})}}).inject(document.body)}})},checkBeforeFetch:function(e){var t=c.getOption("ENO_FBI_NB_PAGERESULT"),i=this,s=!0,r=e.length/t,a=Number.isInteger(r)?r:parseInt(r)+1;return new d(function(e){a>1?(s=!1,i.displayWarningPanel().then(function(t){e(s=t)})):e(s)})},checkBeforeSynthFetch:function(e){var t=!0;return new d(function(i){e.length>1e4?(t=!1,console.log("*** KO ***"+_.get("FetchSynthesisLimit")),i(t)):i(t)})},launchFetch:function(e,t,i,s){var r=this;return new d(function(a,n){h.fetch(e,t,i,s).then(function(e){e||(e={summary:[],suggested:[]}),e.response&&r._setDataModel(e),a(e)},function(e){n(e)})})},_launchFetchWithSynthesis:function(e,t){var i=this;return new d(function(s,r){h.fetchWithSynthesis(e,t).then(function(e){i._facetsToFeedTagger=e,s(e)},function(e){r(e)})})},_refineFetchWithoutSynthesis:function(e,t,i){var s=this;return new d(function(r,a){h.refineFetchWithoutSynthesis(e,t,i).then(function(e){s._facetsToFeedTagger=e,r(e)},function(e){a(e)})})},_launchOrRefineFetchWithPredicates:function(e,t,i,s){return new d(function(r,a){h.launchOrRefineFetchWithPredicates(e,t,i,s).then(function(e){r(e.results)},function(e){a(e)})})},filterBIFilter:function(t,i){if(this._isProxyActive)if(this._directTaggerProxy)this.dispatchEvent("FilterBIFilteringEvent",t);else{var s=e.clone(t),r=this,a=t.allfilters,n=(i=i||null,this._sortPredicates(t.allfilters));if(this._fetchWithSynthesis){var l=this._needsFiltering(t,this._tagData||{});if(!0===i||l){var o=this._getAllRootsInSession();o&&o.length?this._refineFetchWithoutSynthesis(o,n.classics,this._defaultServiceId).then(function(e){r._keepTagDataInSession(t);var i=e.results,a=[];if(i)for(var l=0;l<i.length;l++)a.push(r._getIDFromResult(i[l]));if(s.matchingIDs=a,n.volatiles&&!Object.keys(n.volatiles).length&&n.classics&&!Object.keys(n.classics).length)u.setUsageTracker(r._widgetId,"NGF-Tagger-FilteringEvent","Trash");else{if(n.volatiles&&Object.keys(n.volatiles).length)for(var o in n.volatiles)if(n.volatiles[o].length)for(var h in n.volatiles[o])n.volatiles[o][h]&&n.volatiles[o][h].excluded?u.setUsageTracker(r._widgetId,"NGF-Tagger-FilteringEvent",{label:"Exclude Tag",value:o}):u.setUsageTracker(r._widgetId,"NGF-Tagger-VolatileEvent",{label:"Tag",value:o});if(n.classics&&Object.keys(n.classics).length)for(var o in n.classics)if(n.classics[o].length)for(var h in n.classics[o])n.classics[o][h]&&n.classics[o][h].excluded?u.setUsageTracker(r._widgetId,"NGF-Tagger-FilteringEvent",{label:"Exclude Tag",value:o}):u.setUsageTracker(r._widgetId,"NGF-Tagger-FilteringEvent",{label:"Tag",value:o})}n.volatiles&&Object.keys(n.volatiles).length?r.dispatchEvent("FilterVolatileEvent",s):(r.dispatchEvent("fetchFilterBIFilteringEvent",s),a.length?r._launchFetchWithSynthesis(a,r._defaultServiceId).then(function(e){e=r._volatileTags?r._volatileTags.concat(e):e,r._setTags(null,e)}):r._setTags(null,r._volatileTags))}):this._setTags(null,this._volatileTags)}}else if(this._setPathTagsWithSynthesis)s.filteredPathIDList=[],s.filteredSubjectList=[],s.nodes=this._allNodes,this._refineFetchWithoutSynthesis(this._allNodes,n.classics,this._defaultServiceId).then(function(e){r._keepTagDataInSession(t);var i=e.results;if(i){if(0===Object.keys(t.allfilters).length)for(var a=0;a<r._unfilteredTree.length;a++)s.filteredPathIDList.push(r._unfilteredTree[a].id);else for(var l=0;l<i.length;l++)for(var o=r._getIDFromResult(i[l]),c=h._getIdPaths(r._unfilteredTree,r._allNodes,o),g=0;g<c.length;g++)s.filteredPathIDList.push(c[g].id);s.filteredSubjectList=h.convertFromPIDToIndex(r._allNodes,s.filteredPathIDList)}n.volatiles&&Object.keys(n.volatiles).length?r.dispatchEvent("FilterVolatileEvent",s):r.dispatchEvent("FilterBIFilteringEvent",s)});else{var c=!1,g=!1;this._filterBIToKeep&&this._filterBIToKeep.allfilters&&(Object.keys(a).length&&Object.keys(a).length<Object.keys(this._filterBIToKeep.allfilters).length&&(c=!0),0===Object.keys(a).length&&Object.keys(this._filterBIToKeep.allfilters).length&&(g=!0)),(c||g)&&0!==this._unfilteredTree.length?(h._groupedData={},this.checkBeforeFetch(this._allNodes).then(function(e){e&&r.launchFetch(r._predicates,r._allNodes,r._unfilteredTree,r._defaultServiceId).then(function(e){r.manageFiltering(t)},function(e){})})):this.manageFiltering(t)}}},_sortPredicates:function(t){var i={volatiles:{},classics:{}};for(var s in t)t.hasOwnProperty(s)&&(this._keepVolatileTags.indexOf(s)>-1?i.volatiles[s]=e.clone(t[s],!1):i.classics[s]=e.clone(t[s],!1));return i},manageFiltering:function(e){var t=e.allfilters;this._isFetchCustoDone=!1,this._filtering({},t,e)},_filterPredicatesAndTags:function(e){var t,i,s={},r=[],a=!1;for(var n in e)if(e.hasOwnProperty(n)){r=e[n],0===n.indexOf("sixw")&&(n=n.substring(5),a=!0),this.checkBIRuleFiltering(n)||(s[n]={});for(var l=0;l<r.length;l++)if(a){if((t=this._getMatchingAttribute(n,r[l])).length)for(var o=0;o<t.length;o++)s[n][t[o].key]=t[o].value}else if("date"===r[l].type)for(var c in i=this._grouped[n])i.hasOwnProperty(c)&&-1!==c.indexOf(r[l].object)&&(s[n][c]=i[c]);else if(this._grouped&&this._grouped[n])if(Array.isArray(r[l].object)){var g=h._buildValueForHierarchicalTags(r[l].object);s[n][r[l].object]=this._predicatesToKeepForHierarchicalTags(n,g)}else this._grouped[n][r[l].object]&&(s[n][r[l].object]=this._grouped[n][r[l].object]);a=!1}return s},_predicatesToKeepForHierarchicalTags:function(t,i){var s={};for(var r in this._grouped)if(t===r&&this._grouped.hasOwnProperty(r))for(var a in this._grouped[r])this._grouped[r].hasOwnProperty(a)&&a.contains(i)&&e.extend(s,this._grouped[t][a]);return s},_getMatchingAttribute:function(e,t){var i=[];for(var s in this._grouped[e])this._grouped[e].hasOwnProperty(s)&&this._valuesMatch(s,t)&&i.push({key:s,value:this._grouped[e][s]});return i},_valuesMatch:function(e,t){var i=!1;switch(t.type){case"string":i=this._valuesMatchString(e,t.object);break;case"date":i=this._valuesMatchDate(e,t.object)}return i},_valuesMatchString:function(e,t){return e.indexOf(t)>=0},_valuesMatchDate:function(e,t){var i=!1,s=new Date(e),r=t.from||t.to;return r=new Date(r),t.from?i=s>r:t.to&&(i=s<r),i},_computeFilters:function(e,t){var i=[],s=[];for(var r in e)if(e.hasOwnProperty(r))for(var a in e[r])if(e[r].hasOwnProperty(a))for(var n in e[r][a])e[r][a].hasOwnProperty(n)&&"object"==typeof e[r][a][n]&&this._applyFilter(n,e,t)&&s.push(e[r][a][n].pathID);return s.length&&(i=h.convertFromPIDToIndex(this._allNodes,s)),i},_applyFilter:function(e,t,i){var s=!0;for(var r in i){if(i.hasOwnProperty(r))for(var a in s=!1,t[r])t[r].hasOwnProperty(a)&&t[r][a][e]&&(s=!0);if(!1===s)return s}return s},filterBIColorize:function(t){var i=this._getAllRootsInSession()?this._getAllRootsInSession().length:0;if(this._isProxyActive&&i)if(t.tagColors&&t.tagColors.length>1&&u.setUsageTracker(this._widgetId,"NGF-Tagger-ColorizeEvent",{label:"Count",value:t.tagColors.length}),this._directTaggerProxy)this.dispatchEvent("FilterBIColorizeEvent",t);else{var s=this,r=e.clone(t);if(t.tagColors&&t.tagColors.length>0){for(var a=!1,n=0;n<this._keepVolatileTags.length;n++)if(t.tagColors[0].predicate.contains(this._keepVolatileTags[n])){a=!0,t.predicateName=this._keepVolatileTags[n];break}if(a){for(var l in t.tagColors)u.setUsageTracker(this._widgetId,"NGF-Tagger-ColorizeEvent",{label:"Volatile Tag",value:t.tagColors[l].predicate});return void this.dispatchEvent("ColorizeVolatileEvent",t)}}if(this._colorizedData={},this._setPathTagsWithSynthesis||this._fetchWithSynthesis){var o=[];null==this._tagData&&this._keepTagDataInSession(this._currentFilteredTags);var c=this._tagData?this._tagData.allfilters:null,g=this._fetchWithSynthesis?this._getAllRootsInSession():this._allNodes;this._launchOrRefineFetchWithPredicates(c,g,t.tagColors[0].predicate,this._defaultServiceId).then(function(e){for(var i=[],a=0;a<e.length;a++)i.push({ID:s._getIDFromResult(e[a]),object:s._getObjectFromResult(t.tagColors[0].predicate,e[a])});for(var n=0;n<t.tagColors.length;n++){for(var l=[],c=0;c<i.length;c++)"date"===t.tagColors[n].type?-1!==i[c].object.indexOf(t.tagColors[n].object)&&l.push(i[c].ID):Array.isArray(t.tagColors[n].object)?JSON.stringify(i[c].object)===JSON.stringify(t.tagColors[n].object)&&l.push(i[c].ID):i[c].object===t.tagColors[n].object&&l.push(i[c].ID);if(s._fetchWithSynthesis)for(var g=0;g<l.length;g++)o.push({id:l[g],color:t.tagColors[n].color});else if(s._setPathTagsWithSynthesis){var d=h.convertFromPIDToIndex(s._allNodes,l);for(var f in d)d.hasOwnProperty(f)&&o.push({path:d[f],color:t.tagColors[n].color})}}for(var _ in t.tagColors)u.setUsageTracker(s._widgetId,"NGF-Tagger-ColorizeEvent",{label:"Tag",value:t.tagColors[_].predicate});s._fetchWithSynthesis?s.dispatchEvent("fetchFilterBIColorizeEvent",[o]):s._setPathTagsWithSynthesis&&(r.coloredSubjects=o,r.nodes=s._allNodes,s.dispatchEvent("FilterBIColorizeEvent",r))})}else if(s._tree.length)for(var d=s._grouped,f=t.tagColors,_=(o=[],0);_<f.length;_++){var v=[],p=h.findColoredPaths(d,f[_]);for(var I in p)p.hasOwnProperty(I)&&"object"==typeof p[I]&&v.push(p[I].pathID);var F=h.convertFromPIDToIndex(s._allNodes,v);for(var y in F)F.hasOwnProperty(y)&&o.push({path:F[y],color:f[_].color});t.coloredSubjects=o,t.nodes=s._allNodes,s._colorizedData.nodes=t.nodes,s._colorizedData.coloredSubjects=t.coloredSubjects,s.dispatchEvent("FilterBIColorizeEvent",t)}else s.dispatchEvent("FilterBIColorizeEvent",t)}},filterBIGrouping:function(e){if(this._isProxyActive){if(e.groups&&e.groups.length)for(var t in e.groups)e.groups[t].predLevel?u.setUsageTracker(this._widgetId,"NGF-Tagger-GroupingEvent",{label:"Predicate",value:e.groups[t]}):u.setUsageTracker(this._widgetId,"NGF-Tagger-GroupingEvent",{label:"Tag",value:e.groups[t]});else u.setUsageTracker(this._widgetId,"NGF-Tagger-GroupingEvent-Predicate","Ungrouping");this.dispatchEvent("FilterBIGroupingEvent",e)}},filterBISelection:function(e){if(this._isProxyActive){if(e&&Object.keys(e).length)for(var t in e)for(var i in e[t])u.setUsageTracker(this._widgetId,"NGF-Tagger-SelectionEvent",{label:"Tag",value:t});this.dispatchEvent("FilterBISelectionAbstract",e)}},checkCustoBITagInFilter:function(e){var t={custoTag:!1};for(var i in e){if(e.hasOwnProperty(i))if(this.checkIsCustoBIRule(i))return t.pred=i,t.custoTag=!0,t}return t},checkBIRuleFiltering:function(e){var t=!1,i=e;return e.indexOf("/")>=0&&(i=e.slice(e.indexOf("/")+1,e.length)),this._biEngine&&this._biEngine._biPredCriteriaMatchingBIPredLabel[i]&&"NoCriteria"===this._biEngine._biPredCriteriaMatchingBIPredLabel[i][0]&&(t=!0),t},_getIDFromResult:function(e){if(e&&e.attributes)for(var t=0;t<e.attributes.length;t++)if("resourceid"===e.attributes[t].name)return e.attributes[t].value},_getObjectFromResult:function(e,t){var i=e.slice(e.lastIndexOf("/")+1,e.length);if(t&&t.attributes)for(var s=0;s<t.attributes.length;s++)if(i===t.attributes[s].name)return"date"===t.attributes[s].type?t.attributes[s].value=t.attributes[s].value.split("-").join("/").substr(0,10):t.attributes[s].value.contains("/")&&(t.attributes[s].value=t.attributes[s].value.split("/")),t.attributes[s].value}})});