/*!  COPYRIGHT DASSAULT SYSTEMES 2020   */
define("DS/ENOXFindUX/ENOXPanel",["css!DS/ENOXFindUX/ENOXFindUX.css","DS/Windows/ImmersiveFrame","DS/Windows/Dialog"],function(e,t,n){"use strict";function o(e){this.elements={},this.options=e||{},this.options=Object.assign({target:null,events:{onClose:this.close.bind(this)},closeCB:void 0},this.options),this.elements.immframe=new t,this.elements.immframe.getContent().addClassName("enoxpanel-immframe");var o=Object.assign({immersiveFrame:this.elements.immframe},this.options);return this.elements.dialog=new n(o),this.elements.dialog.addEventListener("close",this.close.bind(this)),this.options.target.appendChild(this.elements.immframe.getContent()),this}return o.prototype.close=function(){this.elements.immframe.getContent().remove(),this.elements.dialog.destroy(),"function"==typeof this.options.closeCB&&this.options.closeCB()},o.prototype.closePanel=function(){this.elements.dialog.close()},o.prototype.getContent=function(){return this.elements.dialog.getContent()},o}),define("DS/ENOXFindUX/ENOXFindUtils",["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/PlatformAPI/PlatformAPI","DS/WAFData/WAFData"],function(e,t,n){"use strict";const o="ENOXFindTaxonomies";var s=null,i={},l=null;function a(){return"object"==typeof a.instance?a.instance:(a.instance=this,i=(i=localStorage.getItem(o))?JSON.parse(i):{},this)}return a.prototype.getPlatformServices=function(){return new Promise((t,n)=>{var o=[];null===s&&o.push(new Promise(function(t,n){e.getPlatformServices({onComplete:function(e){s=e,t()},onFailure:function(e){n(e)}})})),Promise.all(o).then(t).catch(n)})},a.prototype.getPlatformId=function(){return"undefined"!=typeof widget&&widget.getValue("x3dPlatformId")?widget.getValue("x3dPlatformId"):"OnPremise"},a.prototype.getTenantInfo=function(e){for(var t={},n=0;n<s.length;n++)if(s[n].platformId===e){t=s[n];break}return t},a.prototype.get3DSpaceURL=function(){return this.getPlatformURL("3DSpace")},a.prototype.getPlatformURL=function(e){if(!UWA.is(s,"array"))throw new Error("Platform services not initialize yet");var t=this.getPlatformId(),n=this.getTenantInfo(t);if(void 0===n[e])throw console.error("No "+e+" URL available for this tenant."),new Error("Unknown service "+e);return n[e]},a.prototype.getTypeTaxonomies=function(e){var t=this;return new Promise((n,s)=>{var l={},a=[],d=[];for(let t=0;t<e.typesToSearch.length;t++)i[e.typesToSearch[t].type]?l[e.typesToSearch[t].type]=i[e.typesToSearch[t].type]:(a.push(e.typesToSearch[t].rscId),d.push(e.typesToSearch[t].type));a.length?t.getPlatformServices().then(()=>{t.fetchTypeTaxonomies({physicalid:a,missingTypes:d}).then(e=>{l=Object.assign(l,e),i=Object.assign(i,e),localStorage.setItem(o,JSON.stringify(i)),n(l)})}):n(l)})},a.prototype.getUser=function(){return null==l&&(l=t.getUser()),l},a.prototype.getUserLogin=function(){var e=this.getUser(),t="";return void 0!==e&&(t=e.login),t},a.prototype.getAppId=function(){var e="/no_private_channel";return"undefined"!=typeof widget&&null!==widget&&(void 0!==widget.getValue("x3dSharedId")?e="/"+widget.getValue("x3dSharedId"):void 0!==widget.getValue("x3dAppId")?e="/"+widget.getValue("x3dAppId"):void 0!==widget.getValue("appId")&&(e="/"+widget.getValue("appId")+"_"+widget.id)),e},a.prototype.getRequestLabel=function(){return this.getUserLogin()+"-"+this.getAppId()+"-"+Date.now()},a.prototype.fetchTypeTaxonomies=function(e){var t=this;return new Promise((o,s)=>{var i={label:"fetchTypeTaxonomies-"+t.getRequestLabel(),physicalid:e.physicalid,select_predicate:["ds6w:label","flattenedtaxonomies"],select_file:[],tenant:t.getPlatformId()},l=t.get3DSpaceURL()+"/cvservlet/fetch/v2?tenant="+t.getPlatformId(),a={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},data:JSON.stringify(i),onComplete:function(t){t="string"==typeof t?JSON.parse(t):t;var n={};for(let o=0;o<t.results.length;o++){var s=[],i=t.results[o].attributes;for(let e=0;e<i.length;e++)if("flattenedtaxonomies"===i[e].name){var l=i[e].value.split("/");s.push(l[l.length-1])}let a;for(let t=0;t<e.missingTypes.length;t++){let n=s.indexOf(e.missingTypes[t]);-1!==n&&(a=s[n])}a&&(n[a]=s)}o(n)},onFailure:s};n.authenticatedRequest(l,a)})},new a}),define("DS/ENOXFindUX/FindView",["css!DS/ENOXFindUX/ENOXFindUX.css","i18n!DS/ENOXFindUX/assets/nls/ENOXFindUX","DS/ENOXFindUX/ENOXPanel","DS/Utilities/Utils","DS/Tree/TreeDocument","DS/Tree/TreeNodeModel","DS/WUXAutoComplete/AutoComplete","DS/Controls/Button","DS/Controls/ButtonGroup","DS/Controls/Toggle","DS/Controls/Expander","DS/Controls/ComboBox","DS/Core/PointerEvents","DS/Utilities/TouchUtils","DS/UIKIT/Spinner","DS/UIKIT/Tooltip","DS/PlatformAPI/PlatformAPI","DS/Utilities/Dom","DS/ENOXFindUX/ENOXFindUtils"],function(e,t,n,o,s,i,l,a,d,c,r,h,u,p,m,f,g,v,C){"use strict";function y(e){e.style.width="90%",e.style.whiteSpace="normal"}function S(e){return this._selectPlatformAPIToken=null,this.elements={},this.options=e||{},this.options=Object.assign({},this.options),this.options.strString="",this.relatedWidget=this.options.relatedWidget,this.currentValue=0,this.options.matchingStringCount=0,this.__buildView(),this.__listenSelect(),this}return S.prototype.getContent=function(){return this.elements.panelFind.getContent()},S.prototype.__buildView=function(){this.elements.findContainer=this._buildContent();var e=this.options.renderTo;let t={of:e,my:"bottom center",at:"bottom center",offsetX:0,offsetY:!0===this.options.onlyTitleTag?-60:-80};this.options.position&&this.options.position.x&&(t={of:e,my:"top left",at:"top left",offsetX:this.options.position.x,offsetY:this.options.position.y});this.elements.panelFind=new n({target:e,closeButtonFlag:!0,title:this.options.title,associatedNodeResourceId:this.options.associatedNodeResourceId,titleBarVisibleFlag:!0,width:"auto",height:"auto",content:this.elements.findContainer,position:t,resizableFlag:!1,closeCB:this.close.bind(this)}),this.elements.panelFind.getContent().addClassName("eno-find-panel"),setTimeout(function(){this._giveFocus()}.bind(this),200)},S.prototype._buildContent=function(){var e=this,n=v.createElement("div",{class:"eno-find-panel-content"});!0===p.getTouchMode()&&n.setAttributeNode(document.createAttribute("touch-mode")),this.options.autocompleteModel=new s;var o=localStorage.getItem("eno-find-panel");if(o)for(var m=JSON.parse(o),f=0;f<m.length;f++)e.options.autocompleteModel.addRoot(m[f]);this.elements.wuxautocomplete=new l({elementsTree:this.options.autocompleteModel,multiSearchMode:!1,placeholder:""}).inject(n),this.elements.wuxautocomplete.getContent().addClassName("eno-controls-autocomplete"),function(e){let t=e.querySelector("input");t&&t.addEventListener("drop",function(e){return e.preventDefault(),!1})}(this.elements.wuxautocomplete.getContent()),this.__integrateFindResults(),this.elements.wuxautocomplete.addEventListener("change",function(){if(e.matchCount=0,e.currentValue=0,e.elements.wuxautocomplete.selectedItems){var t=e.elements.wuxautocomplete.selectedItems.getLabel();e.options.strString=t,e._addAutocompleteModelNode(t)}else e.options.strString="";e.__checkLaunchBtn(),e._displayCurrentValue(),!1===e.elements.findBtn.disabled&&e._launchSearch()});let g=v.createElement("div",{class:"eno-find-panel-actions"});if(!0===p.getTouchMode()&&g.setAttributeNode(document.createAttribute("touch-mode")),this.elements.findBtn=new a({className:"eno-controls-find-btn eno-controls-button",title:t.find.findBtn,icon:{iconName:"check",fontIconFamily:1},disabled:!0}).inject(g),this.elements.findBtn.getContent().addClassName("eno-controls-find-btn eno-controls-button"),this.elements.findBtn.getContent().addEventListener("buttonclick",this._launchSearch.bind(this)),this.elements.wuxautocomplete.addEventListener("uncommittedChange",function(t){e.options.strString=t.dsModel.valueToCommit,e.__checkLaunchBtn(),e._resetFindResult(),e._displayCurrentValue()}),this.elements.findBtn.getContent().addEventListener(u.POINTERHIT,function(t){if(e.elements.wuxautocomplete._hidePopup(),!e.elements.wuxautocomplete.selectedItems&&e.options.strString.length>0){var n=e.options.autocompleteModel.search({match:function(t){return t.nodeModel.getLabel()===e.options.strString}});n.length>0?n[0].select():e._addAutocompleteModelNode(e.options.strString)}}),this.elements.navGrp=new d({disabled:!0}).inject(g),this.elements.previousBtn=new a({title:t.find.previous,icon:{iconName:"chevron-up",fontIconFamily:1}}),this.elements.previousBtn.getContent().addClassName("eno-controls-arrow-up-btn eno-controls-button"),this.elements.previousBtn.getContent().addEventListener("buttonclick",this._goToPreviousFindResult.bind(this)),this.elements.nextBtn=new a({title:t.find.next,icon:{iconName:"chevron-down",fontIconFamily:1}}),this.elements.nextBtn.getContent().addClassName("eno-controls-arrow-down-btn eno-controls-button"),this.elements.nextBtn.getContent().addEventListener("buttonclick",this._goToNextFindResult.bind(this)),this.elements.navGrp.addChild(this.elements.previousBtn),this.elements.navGrp.addChild(this.elements.nextBtn),this.elements.selectBtn=new a({title:t.find.select,icon:{iconName:"select-on",fontIconFamily:1},disabled:!0}).inject(g),this.elements.selectBtn.getContent().addClassName("eno-controls-select-btn eno-controls-button"),this.elements.selectBtn.getContent().addEventListener("buttonclick",this._launchSelect.bind(this)),n.appendChild(g),this.options.availableCols.withChooser){n.classList.add("eno-find-with-cols-chooser");let e=v.createElement("div",{class:"eno-find-options"});this.elements.selectNavigateMode=new c({type:"checkbox",label:t.find.navigateByRow,checkFlag:"boolean"==typeof this.options.availableCols.selectedNavigateMode&&this.options.availableCols.selectedNavigateMode}),this.elements.selectNavigateMode.getContent().addClassName("eno-find-options-row-select"),e.appendChild(this.elements.selectNavigateMode.getContent()),this.elements.selectNavigateMode.elements.label&&y(this.elements.selectNavigateMode.elements.label),this.elements.includeType3dShape=new c({type:"checkbox",label:t.find.includeType3dShape,checkFlag:"boolean"!=typeof this.options.availableCols.includeType3dShape||this.options.availableCols.includeType3dShape}),this.elements.includeType3dShape.getContent().addClassName("eno-find-options-include-type-3dshape"),e.appendChild(this.elements.includeType3dShape.getContent()),this.elements.includeTypeInstance=new c({type:"checkbox",label:t.find.includeTypeInstance,checkFlag:"boolean"!=typeof this.options.availableCols.includeTypeInstance||this.options.availableCols.includeTypeInstance}),this.elements.includeTypeInstance.getContent().addClassName("eno-find-options-include-type-instance"),e.appendChild(this.elements.includeTypeInstance.getContent()),this.elements.selectMatch=new c({type:"checkbox",label:t.find.autoselect,checkFlag:"boolean"==typeof this.options.availableCols.selectedMatch&&this.options.availableCols.selectedMatch}),this.elements.selectMatch.getContent().addClassName("eno-find-options-select"),e.appendChild(this.elements.selectMatch.getContent()),this.elements.selectMatch.elements.label&&y(this.elements.selectMatch.elements.label);let o=v.createElement("span",{class:"eno-find-options-findIn"});o.innerText=t.find.findIn,e.appendChild(o);let l=0,a=this.colModel=new s({});for(l=0;l<this.options.availableCols.allCols.length;l++){let e={label:this.options.availableCols.allCols[l].text,grid:{ds6w:this.options.availableCols.allCols[l].ds6w},value:this.options.availableCols.allCols[l].ds6w},t=new i(e);a.addRoot(t)}this.elements.selectedColList=new h({elementsTree:a,placeholder:t.find.none,enableSearchFlag:!1,autocompleteFlag:!1,multiSelFlag:!0}),this.elements.selectedColList.getContent().addClassName("eno-controls-autocomplete-colList");let d=a.getRoots();for(l=0;l<d.length;l++)-1!==this.options.availableCols.selectedCols.indexOf(d[l].getReferenceValue("ds6w"))&&d[l].select();this.colModel.getXSO().onAdd(e=>{this.__checkLaunchBtn()}),this.colModel.getXSO().onRemove(e=>{this.__checkLaunchBtn()}),e.appendChild(this.elements.selectedColList.getContent());let u=new r({header:t.find.options,body:e,style:"simple"});u.getContent().addClassName("eno-controls-colList-expander"),n.appendChild(u.getContent())}else{this.options.selectedDS6W=[];for(let e=0;e<this.options.availableCols.allCols.length;e++)this.options.selectedDS6W.push(this.options.availableCols.allCols[e].ds6w)}return this.__setToolTip(),n},S.prototype._resetFindResult=function(){this.options.events.onResetFindResult()},S.prototype._addAutocompleteModelNode=function(e){if(0===this.options.autocompleteModel.search({match:function(t){return t.nodeModel.getLabel()===e}}).length){var t=this.options.autocompleteModel.getRoots();5===t.length&&(this.options.autocompleteModel.removeRoot(t[4]),t=this.options.autocompleteModel.getRoots());var n=new i({label:e,icons:[{iconName:"clock",fontIconFamily:1}]});0===t.length?this.options.autocompleteModel.addRoot(n):this.options.autocompleteModel.insertBefore(n,t[0]),this.__storeAutocompleteModel()}},S.prototype.__storeAutocompleteModel=function(){for(var e=[],t=this.options.autocompleteModel.getRoots(),n=0;n<t.length;n++)e.push(t[n].dump());localStorage.setItem("eno-find-panel",JSON.stringify(e))},S.prototype.__listenSelect=function(){if(this.options.listenSelect){var e=this;this._selectPlatformAPIToken=g.subscribe("DS/PADUtils/PADCommandProxy/select",function(t){t.MAX_NB_STORE=5;let n="undefined"!=typeof widget?widget.id:"nope";t.metadata.widgetid!==n&&(e.timeoutSelect?(clearTimeout(e.timeoutSelect),e.timeoutSelect=setTimeout(function(){e.options.events.onListenSelect(t.data,t.MAX_NB_STORE),delete e.timeoutSelect},200)):e.timeoutSelect=setTimeout(function(){e.options.events.onListenSelect(t.data,t.MAX_NB_STORE)},300))})}else this._selectPlatformAPIToken&&(g.unsubscribe(this._selectPlatformAPIToken),this._selectPlatformAPIToken=null)},S.__getAppId=function(){var e=C.getAppId();return e||(e="/no_private_channel"),e},S.prototype.close=function(){this._selectPlatformAPIToken&&(g.unsubscribe(this._selectPlatformAPIToken),this._selectPlatformAPIToken=null),this.options.events.onClose&&this.options.events.onClose();for(var e=Object.keys(this.elements),t=0;t<e.length;t++)this.elements[e[t]]&&(this.elements[e[t]].destroy?this.elements[e[t]].destroy():delete this.elements[e[t]],this.elements[e[t]]=void 0)},S.prototype.closePanel=function(){this.elements.panelFind.closePanel()},S.prototype.setMatchingStringCount=function(e){this.matchCount=e,this.currentValue=0,this.matchCount>0&&(this.currentValue=1),this.setLoadingState(!1),this._displayCurrentValue()},S.prototype.setCurrentValue=function(e){switch(e){case"previous":this.currentValue>1?this.currentValue=this.currentValue-1:this.currentValue=this.matchCount;break;case"next":this.currentValue<this.matchCount?this.currentValue=this.currentValue+1:this.currentValue=1}this._displayCurrentValue()},S.prototype.setLoadingState=function(e){this._setLoadingState(e)},S.prototype._launchSearch=function(e){var t=this,n=function(){if(t.options.events&&t.options.events.onSearch){var e,n=t.options.autocompleteModel.getSelectedNodes(),o=""===t.options.strString?t.elements.wuxautocomplete._editor.value:t.options.strString;1===n.length&&(e=n[0].getReferenceValue("rscId")),t.setLoadingState(!0);let i=[],l=[];if(t.elements.selectedColList){let e=t.colModel.getSelectedNodes();for(let t=0;t<e.length;t++){let n=e[t].getReferenceValue("ds6w");"allColumns"!==n&&(i.push(n),l.push(e[t].getLabel()))}}else i=t.options.selectedDS6W;var s={searchFts:o,rscId:e,selectedPredicates:i,findInContentSelected:l,selectMatch:!!t.elements.selectMatch&&t.elements.selectMatch.checkFlag,selectNavigateMode:!!t.elements.selectNavigateMode&&t.elements.selectNavigateMode.checkFlag,includeType3dShape:!!t.elements.includeType3dShape&&t.elements.includeType3dShape.checkFlag,includeTypeInstance:!!t.elements.includeTypeInstance&&t.elements.includeTypeInstance.checkFlag};t.options.events.onSearch(s)}},s=o.debounce(n,500);e?s():n()},S.prototype._launchSelect=function(){this.options.events&&this.options.events.onSelect&&this.options.events.onSelect({})},S.prototype._displayCurrentValue=function(){let e=this.elements.wuxautocomplete._editor._myInput.value;if(this.options.strString=e.length&&e!=this.options.strString?e:this.options.strString,this.elements.findCounter&&(this.elements.findCounter.innerText=!1===this.elements.findBtn.disabled&&this.options.strString&&""!==this.options.strString&&void 0!==this.currentValue&&void 0!==this.matchCount?this.currentValue+"/"+this.matchCount:""),void 0===this.matchCount)this.elements.selectBtn.disabled=!0,this.elements.previousBtn.disabled=!0,this.elements.nextBtn.disabled=!0;else{var t=!(this.matchCount>1);this.elements.previousBtn&&this.elements.nextBtn&&this.elements.selectBtn&&(this.elements.previousBtn.disabled=t,this.elements.nextBtn.disabled=t),0===this.matchCount?this.elements.selectBtn.disabled=!0:this.elements.selectBtn.disabled=!1}},S.prototype._goToPreviousFindResult=function(){var e=this,t=e.currentValue;e.matchCount&&0!==e.matchCount&&(e.currentValue>1?e.currentValue--:e.currentValue=e.matchCount,e._displayCurrentValue()),e.currentValue&&t!==e.currentValue&&e.options.events&&e.options.events.onFindPreviousResult&&e.options.events.onFindPreviousResult()},S.prototype._goToNextFindResult=function(){var e=this,t=e.currentValue;e.matchCount&&0!==e.matchCount&&(e.currentValue<e.matchCount?e.currentValue++:e.currentValue=1,e._displayCurrentValue()),e.currentValue&&t!==e.currentValue&&e.options.events&&e.options.events.onFindNextResult&&e.options.events.onFindNextResult()},S.prototype._giveFocus=function(){if(this.elements.wuxautocomplete&&document.activeElement!==this.elements.wuxautocomplete._editor._myInput){var e=document.createEvent("Event");e.initEvent("focus",!0,!0),this.elements.wuxautocomplete._editor.getContent().dispatchEvent(e)}},S.prototype.__integrateFindResults=function(){let e=this.elements.wuxautocomplete.getContent().querySelector(".wux-controls-autoComplete-editor");e.classList.add("eno-autoComplete-editor-with-counter"),e.firstChild.classList.add("eno-autoComplete-input"),this.elements.results=v.createElement("div",{class:"eno-controls-find-results"}),this.elements.findCounter=v.createElement("span",{class:"eno-controls-find-counter"}),this.elements.results.appendChild(this.elements.findCounter),this.elements.loader=new m({visible:!1,animate:!0,spin:!0}),this.elements.results.appendChild(this.elements.loader.getContent()),this.elements.loader.getContent().addClassName("eno-controls-find-loader"),e.insertBefore(this.elements.results,e.childNodes[1])},S.prototype._setLoadingState=function(e){var t=this.elements.loader.elements.container;e?(this.elements.findBtn.disabled=!0,this.elements.wuxautocomplete.disabled=!0,this.elements.wuxautocomplete._editor.disabled=!0,this.elements.findCounter.setAttributeNode(document.createAttribute("hidden")),this.elements.loader.show(),t.classList.remove("hide")):(this.elements.findBtn.disabled=!1,this.elements.wuxautocomplete.disabled=!1,this.elements.wuxautocomplete._editor.disabled=!1,this.elements.loader.hide(),t.classList.add("hide"),this.elements.findCounter.removeAttribute("hidden"))},S.prototype.__checkLaunchBtn=function(){this.options.strString&&this.options.strString.length>=3||this.colModel&&this.colModel.getSelectedNodes().length>0?this.elements.findBtn.disabled=!1:this.elements.findBtn.disabled=!0,this.colModel&&(this.colModel.getSelectedNodes().length>0?this.elements.findBtnTooltip.setBody(t.find.findBtnTooltip):this.elements.findBtnTooltip.setBody(t.find.findBtnTooltipNoColumn))},S.prototype.__setToolTip=function(){this.elements.findBtnTooltip=new f({target:this.elements.findBtn.elements.button}),this.elements.findBtnTooltip.setBody(t.find.findBtnTooltip),this.elements.nextBtnTooltip=new f({target:this.elements.nextBtn.elements.button}),this.elements.nextBtnTooltip.setBody(t.find.nextBtnTooltip),this.elements.previousBtnTooltip=new f({target:this.elements.previousBtn.elements.button}),this.elements.previousBtnTooltip.setBody(t.find.previousBtnTooltip),this.elements.selectBtnTooltip=new f({target:this.elements.selectBtn.elements.button}),this.elements.selectBtnTooltip.setBody(t.find.selectBtnTooltip)},S});