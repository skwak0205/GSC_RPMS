/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils",["DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/Visualization/Node3D","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/WebappsUtils/WebappsUtils","DS/ApplicationFrame/CommandsManager","DS/Visualization/SceneGraphFactory","DS/PADUtils/PADSettingsMgt"],function(e,t,n,r,i,o,s,a){"use strict";var c,f,u=i.getWebappsAssetUrl("CAT3DAnnotationUtils","icons/22/"),d={setLoadedAssetType:function(e){c=e},getLoadedAssetType:function(){return c},getLoadedStream:function(e,t){return r.getLoadedStream(e,t)},getNodeInfos:function(e){var t={};return e?("3DXML"===c&&(t.name=e.name,d.isReference(e)&&(t.icon=u+"I_Reference.png"),d.isRepReference(e)&&(t.icon=u+"I_Part.png")),t):null},getNodeType:function(e){var t=r.getNodeType(e);return t||((t=e.getType?e.getType():t)?t:t=e.productType)},getNodeID:function(e){if("3DXML"===c)return e.persistentId;var t=r.getNodeID(e);return!t&&e&&e.getID&&(t=e.getID()),t},getRoots:function(e){if("3DXML"!==c)return r.getRoots(e);for(var t=e.getRootBagPath().getChildrenPathes(),n=[],i=0;i<t.length;i++)n.push(t[i].getLastElement(!0));return n},is3DLeaf:function(e){return"3DXML"!==c?r.is3DLeaf(e):d.isRepReference(e)},isPLMNode:function(e){if("3DXML"!==c)return r.isPLMNode(e);var t=d.getNodeType(e);return null!=t&&""!==t},isReference:function(e){if(e){if("3DXML"!==c){var t=r.isReference(e);return t||(t=!(!e.isPLMReference||"function"!=typeof e.isPLMReference)&&e.isPLMReference())}return!!e.productType&&"Reference3D"===e.productType}},isRepReference:function(e){if(e){if("3DXML"!==c){var t=r.isRepReference(e);return t||(t=!(!e.isPLMRepReference||"function"!=typeof e.isPLMRepReference)&&e.isPLMRepReference())}return!!e.productType&&"ReferenceRep"===e.productType}},isRepInstance:function(e){if(e){if("3DXML"!==c){var t=r.isRepInstance(e);return t||(t=!(!e.isPLMRepInstance||"function"!=typeof e.isPLMRepInstance)&&e.isPLMRepInstance())}return!!e.productType&&"InstanceRep"===e.productType}},isInstance:function(e){if(e){if("3DXML"!==c){var t=r.isInstance(e);return t||(t=!(!e.isPLMInstance||"function"!=typeof e.isPLMInstance)&&e.isPLMInstance())}return!!e.productType&&"Instance3D"===e.productType}},solveAttributeLink:function(e){if(e&&e.phyID){require(["DS/PADUtils/PADUtilsServices","DS/TransientWidget/TransientWidget"],function(t,n){var r,i;e&&(512&e.type||1024&e.type?o.getCommand("CAT3DAnnotSemanticSolveAttrLinkHdr",e.cmdContext).launchProperties({getSecurityContext:function(){return a.getSetting("pad_security_ctx")},getSelectedNodes:function(){return[{attrLinkID:e.phyID,getID:function(){return this.attrLinkID}}]}}):(r={appID:"X3DPLAW_AP",title:e.title?e.title:e.url,physicalid:e.phyID,type:e.phyType},i={protocol:"3DXContent",version:"0.1",source:"X3DCSMA_AP",data:{items:[{envId:t.getPlatformId(),serviceId:"3DSpace",objectId:r.physicalid,objectType:r.type,contextId:a.getSetting("pad_security_ctx")}]}},n.showWidget(r.appID,r.title,{x3dSharedId:window.widget.getValue("x3dSharedId"),x3dPlatformId:window.widget.getValue("x3dPlatformId"),X3DContentId:JSON.stringify(i)})))})}},create2DClippingRepresentation:function(r){var i,o=new e.LineBasicMaterial({color:new e.Color("#FFFFFF"),lineWidth:1,opacity:1,force:!0,dashType:t.LinePatternEnum.DOTDASHED,isCPUPattern:!0,polygonBorderMode:!0});if("circular"===r.type)(i=s.createCircleNode({radius:r.radius,fill:!1,segments:30,material:o})).setMatrix((new e.Matrix4).setPosition(new e.Vector3(r.center.x,r.center.y,0)));else{var a=[];r.points.forEach(function(t){a.push(new e.Vector3(t.x,t.y,0))}),a.push(new e.Vector3(r.points[0].x,r.points[0].y,0)),i=s.createLineNode({points:a,material:o})}i.setShadow(!1),i.setPickParent(!0);var c=new n;return c.addChild(i),c},_sendUsageProbe:function(e,t,n){if(f){var r=f.getPADTracker({eventCategory:"usage",eventAction:e}),i={eventLabel:t};void 0!==n&&(i.eventValue=n),r.setEventData(i),r.trackPageEvent()}else require(["DS/PADServices/utils/PADTrackerManager"],function(e,t,n,r){f=r,this._sendUsageProbe(e,t,n)}.bind(this,e,t,n))}};return d}),define("DS/CAT3DAnnotationUtils/CAT3DAnnotationUtilsOptions",["UWA/Core","UWA/Class","UWA/Class/Options","UWA/Utils"],function(e,t,n,r){"use strict";return t.singleton(n,{init:function(){var t={};window.annotUrlComplementForODT&&(t=r.parseQuery(window.annotUrlComplementForODT)),""!==window.location.search&&(e.extend(t,r.parseQuery(window.location.search)),t.widgetDomain&&e.extend(t,r.parseQuery(t.widgetDomain)));for(var n={},i=Object.keys(t),o=0;o<i.length;o++)n[i[o]]=!0;"debug_me"in t&&(n.debug=!0),!0===window.debug&&(n.debug=!0),!0===window.AutomaticAttrScroll&&(n.AutomaticAttrScroll=!0),!0===window.CAT3DANN_FILTER_PANEL_VER1&&(n.CAT3DANN_FILTER_PANEL_VER1=!0),!0===window.testWkb&&(n.testWkb=!0),parseFloat(window.CAT3DGRID_MAXLABEL)&&(n.CAT3DGRID_MAXLABEL=parseFloat(window.CAT3DGRID_MAXLABEL)),this.setOptions(n)}})}),define("DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController",["UWA/Core","UWA/Controls/Abstract","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","i18n!DS/CAT3DAnnotationUtils/assets/nls/CAT3DAnnotationUtils","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationAttributesCategories"],function(e,t,n,r,i,o){"use strict";var s=t.singleton({init:function(){var t=new n,a=this,c=function(e){for(var t=[],n=e.clone();n;){var i=n.getLastElement(!0);r.getNodeID(i)&&t.unshift(r.getNodeID(i)),n=n.getParentPath()}return t},f=function(e,t){if(e.length>t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0},u=function(e,t){if(!e||!t)return!1;if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0};this.subscribe=function(e,n){if(e&&n)return t.subscribe({event:e},n)},this.unsubscribe=function(e){e&&t.unsubscribe(e)},this.saveA3EWidgetPref=function(t){if(t&&t.pref&&(t.path||t.rootLog||t.id)&&window.widget){var n=window.widget.getValue(t.pref);if((n=n&&e.is(n,"string")?JSON.parse(n):void 0)||(window.widget.addPreference({name:t.pref,type:"hidden"}),n=[]),t.rootLog)window.widget.setValue(t.pref,JSON.stringify(t.rootLog));else if(t.id)n.some(function(e){return e===t.id})||(n.push(t.id),window.widget.setValue(t.pref,JSON.stringify(n)));else{var r={idPath:c(t.path)};if(t.data)for(var i=Object.keys(t.data),o=0;o<i.length;o++)r[i[o]]=t.data[i[o]];for(var s=n.length-1;s>=0;s--)u(n[s].idPath,r.idPath)&&n.splice(s,1);n.push(r),window.widget.setValue(t.pref,JSON.stringify(n))}}},this.getA3EWidgetAnnotSetsLoadedPref=function(t){if(t&&t.path&&window.widget){var n=window.widget.getValue("A3EAnnotSetsLoaded");if(n=n&&e.is(n,"string")?JSON.parse(n):void 0){for(var r=[],i=c(t.path),o=0;o<n.length;o++)f(i,n[o].idPath)&&r.push({idPath:n[o].idPath,visibility:n[o].visibility,ctxTypes:n[o].ctxType?[n[o].ctxType]:null});return r}}},this.removeA3EWidgetPref=function(t){if(t&&t.pref&&(t.path||t.id)&&window.widget){var n,r=window.widget.getValue(t.pref);if(r=r&&e.is(r,"string")?JSON.parse(r):void 0)if(t.id)for(n=r.length-1;n>=0;n--)r[n]===t.id&&(r.splice(n,1),window.widget.setValue(t.pref,JSON.stringify(r)),0===r.length&&window.widget.deleteValue(t.pref));else if(t.path){var i=c(t.path);for(n=r.length-1;n>=0;n--)u(r[n].idPath,i)&&(r.splice(n,1),window.widget.setValue(t.pref,JSON.stringify(r)),0===r.length&&window.widget.deleteValue(t.pref))}else if(t.nodeID)for(n=r.length-1;n>=0;n--)-1!==r[n].idPath.indexOf(t.nodeID)&&(r.splice(n,1),window.widget.setValue(t.pref,JSON.stringify(r)),0===r.length&&window.widget.deleteValue(t.pref))}},this.deleteA3EWidgetPref=function(e){e&&e.pref&&window.widget&&window.widget.deleteValue(e.pref)},this.setPreference=function(e,n){if(e){var r=localStorage.getItem(e),i=n;switch(e){case"3DAnnotSemStd":if("string"!=typeof i)return;break;case"FavoriteContextLoadMode":if("0"!==i&&"1"!==i&&"2"!==i)return;break;case"3DAnnotLoadARMPartsPref":case"3DAnnotDisplayCapturesPref":case"3DAnnotWhiteVectorAsBlack":case"3DAnnotUpdateThumbnailsPref":case"3DAnnotKeepSelectedFeaturesPref":if("boolean"!=typeof i)return;break;case"3DAnnotAttributesOrderedList":return;default:if(-1!==e.indexOf("3DAnnotSemAttr_")&&"boolean"!=typeof i)return;if(-1!==e.indexOf("CAT3DAnnotAttrRowSelection_")&&"string"!=typeof i)return;if(-1!==e.indexOf("CAT3DAnnotAttrAttrDisplay_")&&"string"!=typeof i)return}r!==i&&(localStorage.setItem(e,i),t.publish({event:"onPreferenceModified",data:{preference:e,value:i},context:this}))}},this.getPreference=function(t){if(t){var n=localStorage.getItem(t);switch(t){case"3DAnnotSemStd":return n;case"FavoriteContextLoadMode":n="0"===n||"2"===n?n:"1";break;case"3DAnnotLoadARMPartsPref":case"3DAnnotDisplayCapturesPref":n="true"===n;break;case"3DAnnotWhiteVectorAsBlack":case"3DAnnotUpdateThumbnailsPref":case"3DAnnotKeepSelectedFeaturesPref":n="false"!==n;break;case"3DAnnotAttributesOrderedList":var r=n?JSON.parse(n):null;n=r&&e.is(r,"array")?r:["2","3DAnnotations","0","1","7","3","4","6","5"];break;default:-1!==t.indexOf("3DAnnotSemAttr_")&&(n="false"!==n),-1!==t.indexOf("CAT3DAnnotAttrRowSelection_")&&(n||"CAT3DAnnotAttrRowSelection_4"!==t&&"CAT3DAnnotAttrRowSelection_6"!==t||(n="display")),-1!==t.indexOf("CAT3DAnnotAttrAttrDisplay_")&&(n||"CAT3DAnnotAttrAttrDisplay_4"!==t&&"CAT3DAnnotAttrAttrDisplay_6"!==t||(n="rows"))}return n}},this.getPreferenceDefinitions=function(e){var t=[],n=!1,r={nls:i.preferences.annotationSectionTitle,id:"3DAnnotationPreferences",type:"section",preferences:[]};if(t.push(r),(!e||e&&!1!==e.annotDisplayPrefs)&&(n=!0,r.preferences.push({nls:i.preferences.WhiteVecAsBlackLbl,id:"3DAnnotWhiteVectorAsBlack",type:"checkbox",getValue:function(){return a.getPreference("3DAnnotWhiteVectorAsBlack")},getDefaultValue:function(){return!0},setValue:function(e){e!==a.getPreference("3DAnnotWhiteVectorAsBlack")&&s.setPreference("3DAnnotWhiteVectorAsBlack",e)}})),(!e||e&&!1!==e.loadingPrefs)&&(n=!0,r.preferences.push({nls:i.preferences.LoadARMPartsLbl,id:"3DAnnotLoadARMPartsPref",type:"checkbox",getValue:function(){return a.getPreference("3DAnnotLoadARMPartsPref")},getDefaultValue:function(){return!1},setValue:function(e){e!==a.getPreference("3DAnnotLoadARMPartsPref")&&s.setPreference("3DAnnotLoadARMPartsPref",e)}})),(!e||e&&!1!==e.thumbnailPrefs)&&(n=!0,r.preferences.push({nls:i.preferences.DisplayCapturesLbl,id:"3DAnnotDisplayCapturesPref",type:"checkbox",getValue:function(){return a.getPreference("3DAnnotDisplayCapturesPref")},getDefaultValue:function(){return!1},setValue:function(e){e!==a.getPreference("3DAnnotDisplayCapturesPref")&&s.setPreference("3DAnnotDisplayCapturesPref",e)}}),r.preferences.push({nls:i.preferences.UpdateThumbnailsLbl,id:"3DAnnotUpdateThumbnailsPref",type:"checkbox",getValue:function(){return a.getPreference("3DAnnotUpdateThumbnailsPref")},getDefaultValue:function(){return!0},setValue:function(e){e!==a.getPreference("3DAnnotUpdateThumbnailsPref")&&s.setPreference("3DAnnotUpdateThumbnailsPref",e)}})),(!e||e&&!1!==e.keepSelectedFeaturesPrefs)&&(n=!0,r.preferences.push({nls:i.preferences.keepSelectedFeatures,id:"3DAnnotKeepSelectedFeaturesPref",type:"checkbox",getValue:function(){return a.getPreference("3DAnnotKeepSelectedFeaturesPref")},getDefaultValue:function(){return!0},setValue:function(e){e!==a.getPreference("3DAnnotKeepSelectedFeaturesPref")&&s.setPreference("3DAnnotKeepSelectedFeaturesPref",e)}})),(!e||e&&!1!==e.favoriteCtxPrefs)&&(n=!0,r.preferences.push({nls:i.preferences.FavoriteContextLabel,id:"3DAnnotFavoriteContextPref",type:"radio",getValue:function(){return a.getPreference("FavoriteContextLoadMode")},getDefaultValue:function(){return"1"},setValue:function(e){e!==a.getPreference("FavoriteContextLoadMode")&&s.setPreference("FavoriteContextLoadMode",e)},options:[{id:"0",nls:i.preferences.FavoriteContextOpen},{id:"1",nls:i.preferences.FavoriteContextCheck},{id:"2",nls:i.preferences.FavoriteContextIgnore}]})),!e||e&&!1!==e.attributePrefs){n=!0;var c={nls:i.preferences.PrefAttributesTitle,id:"3DAnnotationAttrSection",type:"section",preferences:[]};r.preferences.push(c),a.getPreference("3DAnnotAttributesOrderedList").forEach(function(e){c.preferences.push({nls:o[e],id:"3DAnnotSemAttr_"+e,type:"checkbox",getValue:function(){return s.getPreference("3DAnnotSemAttr_"+e)},getDefaultValue:function(){return!0},setValue:function(t){t!==a.getPreference("3DAnnotSemAttr_"+e)&&s.setPreference("3DAnnotSemAttr_"+e,t)}})})}return n?t:null}}});return s.init(),s});