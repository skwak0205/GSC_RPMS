define("DS/SocialUserMention/Controls/AbstractAutocomplete",["UWA/Core","UWA/Promise","UWA/Json","UWA/Utils/Client","DS/WAFData/WAFData","DS/UIKIT/Autocomplete","DS/Logger/Logger"],function(e,t,n,r,o,i,s){"use strict";var a=i.extend({_areSuggestsVisible:!1,_lastRange:null,name:"autocomplete",defaultOptions:{swymUrl:"",tenantId:"",swymServerToken:null,boundingElement:null,userGroups:null,defaultClassName:"",editorElement:null,allowFreeInput:!0,noResultsMessage:!1,itemMultiSelect:!0,minLengthBeforeSearch:1,typeDelayBeforeSearch:300},_get3DSwymServerToken:function(){var r=this.options;return new t(function(t,i){var s=r.swymUrl;r.swymServerToken?t(r.swymServerToken):s?o.authenticatedRequest(s+"/api/index/tk",{method:"GET",onComplete:function(o){(o=e.is(o,"string")?n.decode(o):o)&&o.result&&o.result.ServerToken?(r.swymServerToken=o.result.ServerToken,t(o.result.ServerToken)):i("3DSwym server token is missing from server response")},onFailure:function(){i("Error retrieving 3DSwym server token")},onTimeout:function(){i("Time out while trying to retrieve 3DSwym server token")}}):i("3DSwym URL could not be found!")})},_initSocialMentionDataSet:function(){throw new Error("This method is supposed to be overridden!")},_positionComponent:function(e,t){var n=this.elements&&this.elements.container;n&&(n.style.setProperty("top",e+"px","important"),n.style.setProperty("left",t+"px","important"))},_getBoundingClientRect:function(e){var t=e.getBoundingClientRect();return r.Features.touchEvents&&0===t.top&&0===t.right&&0===t.bottom&&0===t.left&&(t=e.getClientRects()[0]),t},init:function(){if(this._parent.apply(this,arguments),!this.options.editorElement)throw new Error("Editor element is missing");this._initSocialMentionDataSet()},propagateKeyboardEventToInput:function(t){var n=null,o=t.type,i=this.elements&&this.elements.input;if(!t)throw new Error("The event to propagate is missing!");if(!i)throw new Error("Autocomplete input element is missing!");r.Engine.ie||!window.KeyboardEvent||r.Features.touchEvents?"function"==typeof document.createEvent&&((n=document.createEvent("KeyboardEvent")).initKeyEvent?function(t,n,r){t.initKeyEvent(n,!0,!0,window,r.ctrlKey,r.altKey,r.shiftKey,r.metaKey,e.is(r.keyCode)?r.keyCode:r.key||r.which,r.charCode)}(n,o,t):n.initKeyboardEvent(o,!0,!0,window,t.key,t.location,t.ctrlKey,t.altKey,t.shiftKey,t.metaKey,t.keyCode,t.charCode)):n=new KeyboardEvent(o,{bubbles:!0,cancelable:!0,view:window,key:t.key,code:t.code,ctrlKey:t.ctrlKey,altKey:t.altKey,shiftKey:t.shiftKey,metaKey:t.metaKey,which:e.is(t.which)?t.which:t.keyCode,charCode:t.charCode,keyCode:t.keyCode,isComposing:t.isComposing,repeat:t.repeat,location:t.location}),n?(r.Engine.webkit&&function(e,t){Object.defineProperty(e,"keyCode",{get:function(){return this.customKeyCode}}),Object.defineProperty(e,"which",{get:function(){return this.customKeyCode}}),e.customKeyCode=t}(n,t.keyCode),i.dispatchEvent(n)):s.error("Failed to link the editor to autocomplete component")},buildSkeleton:function(){var t=this._parent.apply(this,arguments),n=this.getOption("defaultClassName");if(!this.elements.container)throw new Error("Autocomplete container cannot be found");if(!this.options.editorElement.parentElement)throw new Error("Editable element has no parent");return n||(n=""),this.elements.container.addClassName((n?n+" ":"")+"sm-autocomplete"),this.elements.userAutocompleteWrapper=e.createElement("div",{class:(n?n+"-wrapper ":"")+"sm-autocomplete-wrapper"}),this.inject(this.elements.userAutocompleteWrapper),this.elements.userAutocompleteWrapper.inject(this.options.containerElement||this.options.editorElement.parentElement),t},areSuggestsVisible:function(){return this._areSuggestsVisible},displayContextually:function(t){if(this.elements&&this.elements.suggestsContainer){var n=null,o=null,i=this.elements.userAutocompleteWrapper.parentElement;if(i){e.extendElement(i),e.extendElement(document.body),t?this._lastRange=t:t=this._lastRange,this.options.boundingElement&&(n=e.extendElement(this.options.boundingElement),o=this._getBoundingClientRect(n));var a,l,u,c,p,m,h,d,g,f=!1,y=document.body.getSize(),S=n?o.bottom:y.height,b=n?o.right:y.width,w=this.elements.suggestsContainer.getSize(),v=w.width,C=w.height;if(v&&C||(this.show(),f=!0,v=(w=this.elements.suggestsContainer.getSize()).width,C=w.height),g=C+10,!(u=this._getBoundingClientRect(t)))return void s.error("Range bounding element rectangle could not be computed!");p=u.top,m=u.bottom,h=u.left,d=u.right,c=this._getBoundingClientRect(i),a=u.top-c.top,l=u.left-c.left,a=r.Features.touchEvents?p>g?p-c.top-g:a+u.height+10:S-m>C?a+u.height+10:p>g?p-c.top-g:a+u.height+10,b-d>v||(l=h+v>b?b-v-c.left:0),this._positionComponent(a,l),!0!==f&&this.show()}}},onShowSuggests:function(){this._areSuggestsVisible=!0;var e=this._parent.apply(this,arguments);return this.displayContextually(),e},onHideSuggests:function(){return this._areSuggestsVisible=!1,this._parent.apply(this,arguments)},onHide:function(){return this._areSuggestsVisible=!1,this._parent.apply(this,arguments)},destroy:function(){return this._areSuggestsVisible=!1,this._parent.apply(this,arguments)}});return a.DEFAULT_CLASSNAME="sm-autocomplete",a}),define("DS/SocialUserMention/Utils/Generic",["UWA/Core"],function(e){"use strict";return{throttle:function(t,n,r){if("function"==typeof t)return o=null,i=null,s=!1,a=!0,l=n||30,u=r?e.clone(r,!1):{},c=function(){for(;!0===a;)a=!1,t.apply(i,o);"function"==typeof u.after&&u.after.apply(i,o),s=!1},function(){a=!0,i=this,o=arguments,!1===s&&(s=!0,"function"==typeof u.before&&u.before.apply(i,o),setTimeout(c,l))};throw new Error("First argument is supposed to be a function");var o,i,s,a,l,u,c}}}),define("DS/SocialUserMention/AbstractSocialMention",["UWA/Core","UWA/Event","UWA/String","UWA/Promise","UWA/Utils","UWA/Utils/Client","UWA/Class/Events","UWA/Class/Listener","DS/SocialUserMention/Utils/Generic","DS/Logger/Logger","css!DS/UIKIT/UIKIT","css!DS/SocialUserMention/SocialUserMention"],function(e,t,n,r,o,i,s,a,l,u){"use strict";var c="["+["!","?","$","^","*","+","|","\\","/",":",",","=","[","]","{","}","(",")"].map(function(e){return"\\"+e}).join("")+"]",p="\\s|\\u200B|&#8203;|$|"+c,m="\\s|\\u200B|&#8203;|"+("^|$|"+c),h=new RegExp("("+c+")"),d=new RegExp(p),g=new RegExp("^("+m+")$"),f={};return a.extend(s,{_autocompleteClass:null,_attributeForStoringAutocompleteId:null,_triggerCharacter:null,_appendTriggerCharacterToMention:!0,_queryMatcher:null,_removeEndingSlash:function(t){return e.is(t,"string")&&t.length>0&&"/"===t.charAt(t.length-1)?t.slice(0,t.length-1):t},_get3DSwymUrl:function(e){var t=this;return new r(function(n,r){var o=e["3DSwymUrl"];o?n(o):require(["DS/i3DXCompassServices/i3DXCompassServices"],function(i){i.getPlatformServices({onComplete:function(i){var s=e.tenantId;Array.isArray(i)&&i.forEach(function(e){e.platformId===s&&(o=t._removeEndingSlash(e["3DSwym"]))}),o?n(o):r("There is no 3DSwym instance on this tenant")},onFailure:function(){r("Error calling MyApps. Please make sure the TopFrame is correctly configured.")}})})})},_handleAutoCompleteDisplay:function(){var e,t,n,r=null,o=0,i=null,s=null,a="",l=null,c=-1,p=!1;if(0!==(e=window.getSelection()).rangeCount){if((n=(t=e.getRangeAt(0))&&t.cloneRange())&&n.collapsed&&(o=n.endOffset,s=n.endContainer,(l=s.nodeValue)&&(c=l.substring(0,o).lastIndexOf(this._triggerCharacter)),-1!==c)){if(l&&c<o)if(c+1===o)(r=l.substring(c,l.length).match(this._queryMatcher))&&"string"==typeof r[1]?a=r[1]:c=-1;else{if((i=o+l.substring(o).search(d))<o)throw new Error("Can't find the end of the word. This was not supposed to happen.");(r=l.substring(c+1,i).match(h))&&"string"==typeof r[1]?c=-1:(a=l.substring(c+1,i).split(/\s+/).slice(0,6).join(" "),o>c+a.length+1&&(c=-1))}-1!==c&&(0===c?p=!0:(c>=1?(m=l[c-1].match(g))&&"string"==typeof m[1]:(u.error("Position of trigger-character is incorrect"),0))&&(c+1===o||l&&l[c+1].match(/^\S$/))&&(p=!0))}var m;return!0===p?(n.setStart(s,c+1),n.setEnd(s,c+1),{unalteredQuery:a,query:a.replace(/(\u200B|&#8203;)/g,""),container:s,triggerCharIndex:c,cursorIndex:o,range:n}):null}u.warn("Can't display list. There is no selection!")},getMention:function(t){var r,o,i,s="";if(!(t&&t.object&&t.object.value&&t.object.label))throw new Error("Required information are missing");if(i=t.linksExtraAttributes,o=(!1===this._appendTriggerCharacterToMention?"":this._triggerCharacter)+n.escapeHTML(t.object.label),!1===t.stringFormat)return(r=document.createDocumentFragment()).appendChild(e.createElement("a",e.merge({contenteditable:"false",html:o},t.linksExtraAttributes))),r.appendChild(document.createTextNode(!1===t.includeNonBreakableSpace?"":" ")),r;if(e.is(i,"object"))for(var a in i)i.hasOwnProperty(a)&&(s+=" "+a+'="'+i[a]+'"');return"<a"+s+' contenteditable="false">'+o+"</a>"+(!1===t.includeNonBreakableSpace?"":" ")},enableFeature:function(n){var r,i,s,a,c=this,p=null,h=null;if(!n||!n.editableElement||(s=e.extendElement(n.editableElement).getAttribute("contenteditable"))&&"true"!==s&&""!==s)throw new Error("An editable element is required");if(!n["3DSwymUrl"]&&!n.tenantId)throw new Error("Tenant (online instance) ID is required.");if(!this._autocompleteClass)throw new Error("Autocomplete class is missing!");if(!this._attributeForStoringAutocompleteId)throw new Error("Attribute for storing autocomplete ID is missing!");if(!this._triggerCharacter)throw new Error("The character supposed to trigger the display of suggestions is missing!");this._queryMatcher||(this._queryMatcher=new RegExp("^"+this._triggerCharacter+"(.*?)(?="+m+")")),r=n.editableElement,i=n.containerElement,a={keydown:l.throttle(function(e){p&&p.propagateKeyboardEventToInput(e)},200),keyup:l.throttle(function(e){var n,o;if(p){switch(o=t.whichKey(e)){case"left":case"right":case"home":case"end":return}(n=p.elements&&p.elements.input)&&("del"!==o&&"backspace"!==o&&r.normalize(),(h=c._handleAutoCompleteDisplay())?(n.value=h.query.trim(),p.displayContextually(h.range),p.propagateKeyboardEventToInput(e)):(n.value="",p.hide()))}},200),keypress:l.throttle(function(e){p&&p.propagateKeyboardEventToInput(e)},200)},c.listenTo(n.editableElement,{keydown:function(e){switch(t.whichKey(e)){case"return":case"up":case"down":if(!p||!p.areSuggestsVisible())return;t.stopPropagation(e),t.preventDefault(e),e.stopImmediatePropagation()}a.keydown.apply(this,arguments)},keyup:function(e){switch(t.whichKey(e)){case"return":case"up":case"down":if(!p||!p.areSuggestsVisible())return;t.stopPropagation(e),t.preventDefault(e),e.stopImmediatePropagation(),p.propagateKeyboardEventToInput(e);break;default:a.keyup.apply(this,arguments)}},keypress:function(e){a.keypress.apply(this,arguments)}},1e3),c._get3DSwymUrl(n).then(function(t){if(!r[c._attributeForStoringAutocompleteId]){var s=o.getUUID();f[s]=p=new c._autocompleteClass(e.merge({editorElement:r,containerElement:i,tenantId:n.tenantId,swymUrl:t,swymServerToken:n["3DSwymServerToken"],boundingElement:n.boundingElement,events:{onSelect:function(t){var o,i,s,a;if(!h)throw new Error("Something went wrong...");s=h.container.parentElement||h.container.parentNode,i=h.container.nodeValue,a=h.triggerCharIndex+h.unalteredQuery.length+1===i.length,h.container.nodeValue=i.substring(0,h.triggerCharIndex)+i.substring(h.triggerCharIndex+h.unalteredQuery.length+1,i.length),o=h.container.splitText(h.triggerCharIndex),s.insertBefore(c.getMention({object:t,linksExtraAttributes:n.linksExtraAttributes,stringFormat:!1,includeNonBreakableSpace:a}),o),"function"==typeof(r&&r.focus)&&r.getChildren()[0].focus(),setTimeout(function(){!function(t,n){try{var r=document.createRange(),o=document.getSelection();t&&(e.is(n,"number")||(n=t.nodeValue.length),r.setStart(t,n),r.collapse(!0),o.removeAllRanges(),o.addRange(r))}catch(e){}}(o,0),e.is(n.events&&n.events.onInsert,"function")&&n.events.onInsert({cursorPosition:{node:o,offset:0}})},0),h=null}}},n.autocompleteOptions)),r[c._attributeForStoringAutocompleteId]=s}},function(e){u.error(e)})},disableFeature:function(e){var t;if(!e||!e.editableElement)throw new Error("An HTML element is required");this.stopListening(e.editableElement),(t=e.editableElement[this._attributeForStoringAutocompleteId]&&f[e.editableElement[this._attributeForStoringAutocompleteId]])&&(t.destroy(),e.editableElement[this._attributeForStoringAutocompleteId]=null)},resetCache(t){if(t&&e.is(t,"string")){const e=f[t];e&&e.datasets&&e.resetCache&&e.resetCache()}else Object.values(f).forEach(e=>{e.datasets&&e.resetCache&&e.resetCache()})}})}),define("DS/SocialUserMention/Controls/UserAutocomplete",["UWA/Core","UWA/Json","UWA/Promise","UWA/Array","DS/WAFData/WAFData","DS/UWPClientCode/I18n","DS/SocialUserMention/Controls/AbstractAutocomplete","DS/Logger/Logger"],function(e,t,n,r,o,i,s,a){"use strict";return s.extend({defaultOptions:{defaultClassName:"sum-user-autocomplete",fedSearchUrl:"",currentUserInfo:null},_isUsersGroupServiceAvailable:function(){var e=this;return new n(function(t){require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(n){n.getServiceUrl({serviceName:"usersgroup",platformId:e.options.tenantId,onComplete:function(e){t("string"==typeof e&&""!==e)},onFailure:function(){t(!1)}})},function(){t(!1)})})},_initSocialMentionDataSet:function(){var r=this;this.addDataset({name:"Users",items:[],searchUrl:this.options.fedSearchUrl+"/search",remoteSearchEngine:function(r,s){var a=this;return this._isUsersGroupServiceAvailable().then(function(l){return new n(function(n,u){var c,p=a.options.userGroups&&a.options.userGroups["3DSwymCommunity"];r.searchUrl&&(c={start:0,nresults:20,tenant:a.options.tenantId,source:["swym"].concat(!0===l?["usersgroup"]:[]),specific_source_parameter:{usersgroup:{additional_query:"AND [ds6w:label]:("+s.trim()+"*)"},swym:{additional_query:" AND personOrGroup:("+s+")"}},select_predicate:["ds6w:label","ds6w:type"],label:"SocialUserMention-"+a.options.currentUserInfo.userLogin+"-"+(new Date).getTime(),query:'[ds6w:type]:("foaf:Group" OR "pno:Person")',with_synthesis:!1,with_synthesis_attribute:!1,locale:i.getCurrentLanguage()},p&&(c.community_id=p),o.authenticatedRequest(r.searchUrl,{method:"POST",type:"json",proxy:"passport",headers:{"Content-Type":"application/json;charset=utf-8"},data:t.encode(c),onComplete:function(t){var o={matchingItems:[]};t&&(o.matchingItems=e.is(r.dataParser,"function")?r.dataParser.call(a,r,t):a.defaultDataParser(t)),o.dataset=r,n(o)},onFailure:function(e){e.type="error",e.dataset=r,u(e)},onTimeout:function(e){e.type="timeout",e.dataset=r,u(e)}}))})})},dataParser:function(e,t){return Array.isArray(t&&t.results)?t.results.reduce(function(e,t){var n=!1,r=!1,o=t.attributes.reduce(function(e,t){switch(t.name){case"ds6w:label":n=!0,t.value||(r=!0),e.label=t.value;break;case"resourceid":e.value=t.value;break;case"ds6w:type":case"ds6w:what/ds6w:type":"foaf:Group"===t.value&&(e.memberType="usersgroup")}return e},{memberType:"user"});return n&&!r&&("user"===o.memberType&&(o.value=o.value.replace("iam:","")),e.push(o)),e},[]):[]}},{templateEngine:function(t,n,o){var i;t.addClassName("user-template"),(i=e.createElement("span",{class:"item-label"})).setText(o.label),t.setContent(["user"===o.memberType?e.createElement("img",{src:r.getOption("swymUrl")+"/api/user/getpicture/login/"+o.value+"/format/mini"}):e.createElement("span",{class:"fonticon fonticon-users-group"}),i])},onError:function(){r.hide()},onTimeout:function(){r.hide()}})}})}),define("DS/SocialUserMention/SocialUserMention",["UWA/Core","UWA/Promise","DS/SocialUserMention/AbstractSocialMention","DS/SocialUserMention/Controls/UserAutocomplete","DS/Logger/Logger"],function(e,t,n,r,o){"use strict";return n.singleton({_triggerCharacter:"@",_autocompleteClass:r,_attributeForStoringAutocompleteId:"_socialUserMentionAutocompleteId",_getFedSearchUrl:function(e){return new t(function(t,n){require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(r){r.getServiceUrl({serviceName:"3DSearch",platformId:e.tenantId,onComplete:function(e){e&&"string"==typeof e?t(e):n("Couldn't find 3DSearch instance on this tenant")},onFailure:function(){n("Error calling MyApps. Please make sure the TopFrame is correctly configured.")}})})})},_getUserInfo:function(e){return new t(function(t,n){e.userLogin&&e.userName?t({userLogin:e.userLogin,userName:e.userName}):require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(r){try{r.getUser({platformId:e.tenantId,onComplete:function(e){t({userLogin:e.id,userName:e.firstname+" "+e.lastname,userIsAdmin:e.admin})},onFailure:function(){n("Error retrieving user information. Please make sure that the TopFrame is correctly configured and that 3DCompass is up and running.")}})}catch(e){n("Error trying to call 3DCompass: "+e.message)}})})},getMention:function(t){var n=t?e.clone(t,!1):{},r={class:"sum-user-link sm-link"};return n.object&&(r["usersgroup"===n.object.memberType?"data-users-group-uri":"data-login"]=n.object.value),n.linksExtraAttributes=e.merge(r,"function"==typeof n.linksExtraAttributes?n.linksExtraAttributes.call(null,n.object):n.linksExtraAttributes),this._parent.call(this,n)},enableFeature:function(n){var r=void 0,o=this._parent,i=this;n?(r=e.clone(n,!1)).autocompleteOptions={userGroups:n.userGroups}:r={autocompleteOptions:{}},t.all([this._getFedSearchUrl(n),this._getUserInfo(n)]).then(function(e){r.autocompleteOptions.fedSearchUrl=e[0],r.autocompleteOptions.currentUserInfo=e[1],o.call(i,r)})},disableFeature:function(){return this._parent.apply(this,arguments)}})});