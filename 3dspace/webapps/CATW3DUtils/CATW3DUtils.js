/*!  Copyright 2020 Dassault Systemes. All rights reserved. */
define("DS/CATW3DUtils/CATW3DUtils",["DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Selection/PSOManager"],function(e,t){"use strict";var r={};function n(t){if(t&&t.pathElement&&e.isAModelPath(t.pathElement)){for(var r,n=t.pathElement.externalPath.length-1;n>=0&&!r;n--)e.isRepReference(t.pathElement.externalPath[n])&&(r=t.pathElement.externalPath[n]);if(r)return{repRefNode:r,repRefID:e.getNodeID(r)}}}function a(e){if(e){var r,a=t.get();1===a.length&&(r=n(a[0]))&&r.repRefID===e&&t.empty()}}return Object.freeze({switchToAV1withMesh:function(t){if(t&&t.pathElement&&t.pad3DViewer&&t.onComplete&&t.onFailure){var l=n(t),o=l?l.repRefID:null,c=l?l.repRefNode:null;if(o){if(t.selectionFilter&&!Object.keys(t.selectionFilter).reduce(function(e,r){return e+("product"!==r&&"surface"!==r?t.selectionFilter[r]:0)},0))return{status:"filtered"};if(l=r[o])return l.callbacks.push(t),{status:l.timeOut?"existing":"switching",repRefNode:c,repRefID:o,cancel:l.cancel};var i=e.getLoadedStream(c,t.pad3DViewer),s=t.pad3DViewer.getController();return"thumbnail"!==i&&"cgr"!==i?(window.console.error("Unknown loaded stream!"),{status:"UnknownLoadedStream"}):"cgr"===i&&s.hasMeshInRAM(o)?{status:"done",repRefNode:c,repRefID:o}:((l={repRefNode:c,repRefID:o,callbacks:[t]}).timeOut=setTimeout(function(){l&&(clearTimeout(l.timeOut),delete l.timeOut,s.lockRepresentationMeshInRAM(o),"thumbnail"===i?s.switchNodeVisuStreamOnDemand({data:[{node:l.repRefNode,stream:"cgr"}],callbacks:{onComplete:function(){if(s.unlockRepresentationMeshInRAM(o),l){var e=l;a(l.repRefID),delete r[l.repRefID],l=null,e.callbacks.forEach(function(t){t.onComplete({status:"switchSuccess",repRefNode:e.repRefNode,repRefID:e.repRefID})})}},onFailure:function(){if(s.unlockRepresentationMeshInRAM(o),l){var e=l;a(l.repRefID),delete r[l.repRefID],l=null,e.callbacks.forEach(function(t){t.onFailure({status:"switchFailure",repRefNode:e.repRefNode,repRefID:e.repRefID})})}}}}):s.setForceReferencesLoad({data:[{id:l.repRefID,state:!0}],callback:function(){if(s.setForceReferencesLoad({data:[{id:o,state:!1}]}),s.unlockRepresentationMeshInRAM(o),l){var e=l;a(l.repRefID),delete r[l.repRefID],l=null,e.callbacks.forEach(function(t){t.onComplete({status:"switchSuccess",repRefNode:e.repRefNode,repRefID:e.repRefID})})}}}))},500),l.cancel=function(){return l?l.timeOut?(clearTimeout(l.timeOut),l.callbacks.forEach(function(e){e.onCancel&&e.onCancel({status:"cancelled",repRefNode:c,repRefID:o})}),delete r[l.repRefID],void(l=null)):{status:"SwitchInProgress"}:{status:"AlreadyDone"}},r[o]=l,{status:"created",repRefNode:c,repRefID:o,cancel:l.cancel})}}}})});