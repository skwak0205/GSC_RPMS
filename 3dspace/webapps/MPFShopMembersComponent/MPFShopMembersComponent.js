define("DS/MPFShopMembersComponent/MPFControlsTag",["UWA/Core","UWA/Controls/Abstract","UWA/Event","DS/UIKIT/Input/Text","DS/UIKIT/Touch","DS/UIKIT/Spinner"],function(e,t,n,i,s,o){"use strict";return t.extend({defaultOptions:{text:null,onChange:function(){},onDestroy:function(){}},init:function(e){this._parent(e),this.buildContainer()},destroy:function(){this.options.onDestroy(),this._parent()},processChange:function(t,n){e.is(n.getParent("div"))&&(this.options.validator(t)?(this.options.text=t,n.getParent("div").removeClassName("has-error"),this.getContent().setContent(this.setReadInput()),this.asyncCheck()):(n.focus(),e.log(n),n.getParent("div").hasClassName("has-error")||(n.getParent("div").addClassName("has-error"),this.options.onError&&this.options.onError())))},setEditInput:function(){var t=this;this.input=new i({value:this.options.text,attributes:{type:"email",styles:{width:t.getContent().getSize().width},events:{keyup:function(e){e.preventDefault(),e.stopPropagation(),13===e.keyCode&&t.processChange(this.value,this)},blur:function(n){var i=this;n.preventDefault(),n.stopPropagation(),e.is(i)&&setTimeout(function(){t.processChange(i.value,i)},100)}}}}),this.getContent().setContent(this.input),this.input.focus()},getButton:function(){var t=this;return this.button||(this.button=e.createElement("button",{class:"btn btn-default",html:{tag:"span",class:"fonticon fonticon-cancel"},events:{click:function(e){this.getElement(".fonticon").hasClassName("fonticon-cancel")&&(t.destroy(),n.stop(e))}}})),{tag:"span",class:"input-group-btn",html:this.button}},getInputText:function(){var t=this;return this.inputText=e.createElement("span",{class:"form-control",text:this.options.text,events:this._isTouchActivate()?null:{dblclick:function(){t.setEditInput()}}}),this._isTouchActivate()&&(this.touch=new s(this.inputText).on("hold",function(e){e.preventDefault(),e.stopPropagation(),t.setEditInput()})),this.inputText},setReadInput:function(){return e.createElement("div",{class:"input-group",html:[this.getInputText(),this.getButton()]})},buildContainer:function(){this.elements.container=e.createElement("div",{class:"uwa-input-tags uwa-input",html:this.setReadInput()})},setLoading:function(e){var t=this.button.getElement(".fonticon");e?(t.removeClassName("fonticon-cancel"),this.button.addClassName("is-loading"),new o({visible:!0,className:"small"}).inject(t)):(this.button.removeClassName("is-loading"),t.addClassName("fonticon-cancel"),t.setContent(""))},setError:function(e){var t=this.inputText.getParent("div");e?t.hasClassName("has-error")||t.addClassName("has-error"):t.removeClassName("has-error"),this.options.onChange()},asyncCheck:function(){var e=this;this.options.validatorAsync&&(this.setLoading(!0),this.options.syncInputSize(),this.options.validatorAsync(this.inputText.getText(),{onComplete:function(){e.getContent().setContent(e.setReadInput()),e.setLoading(),e.setError(!1),e.options.syncInputSize()},onFailure:function(){e.setLoading(),e.setError(!0),e.options.syncInputSize()}}))},_isTouchActivate:function(){return e.Utils.Client.Features.touchEvents}})}),define("DS/MPFShopMembersComponent/MPFInputTagger",["UWA/Core","UWA/Controls/Abstract","DS/UIKIT/Input/Text","DS/MPFShopMembersComponent/MPFControlsTag"],function(e,t,n,i){"use strict";return t.extend({defaultOptions:{validator:function(e){return e.length>0},onSuccess:function(){},onError:function(){},onLimitError:function(){},placeholder:"",limit:null,onChange:function(){}},isFirst:!0,init:function(e){var t=this;this.cancelButtonID=e.cancelButtonID,t._parent(e),this.buildContainer(),setTimeout(function(){t.elements.input.focus()},1)},buildContainer:function(){this.elements.container=e.createElement("div",{html:[{class:"tags-input-wrapper",html:[{class:"tag-wrapper"},{class:"tag-input-wrapper"}]},this.buildInput(),{class:"clearfix"}]})},buildInput:function(){var e=this;return this.elements.input=new n({className:"",attributes:{type:"email",placeholder:this.options.placeholder,autofocus:this.options.focus||null,events:{keydown:function(t){9===t.keyCode&&e.paste(!1,!0)},keyup:function(t){17!==t.keyCode&&(13===t.keyCode||188===t.keyCode?e.paste(!1,!0):e.paste(!0,!0))},drop:function(){e.paste(!1,!0)},paste:function(){e.paste(!1,!0)},focusout:function(t){t.relatedTarget&&t.relatedTarget.id===e.cancelButtonID||e.paste(!1,!1)}}}}),this.elements.input},paste:function(e,t){var n=this;setTimeout(function(){var i,s,o,a,r=n.elements.input.getValue(),l=r,c=n.elements.container.getElement(".tags-input-wrapper"),u=n.elements.container.getElement(".tag-input-wrapper"),d=!0;!e&&r.contains(" ")&&(a=n._extractEmails(r))&&(r=a.join(";")),(e&&r.indexOf(";")>-1||!e)&&((i=r.split(";")).forEach(function(e,t){""!==e&&(n.options.validator(e)&&(null===n.options.limit||n.getSelected().length<n.options.limit)?-1===n.getSelected().indexOf(e)&&((s=n.buildTag(e)).inject(c),s.asyncCheck(),d=!1,o=t+1===i.length?"":";",r=r.replace(e+o,"")):n.options.validator(e)&&n.getSelected().length===n.options.limit&&(u.hasClassName("has-error")||(u.addClassName("has-error"),n.options.onLimitError())))}),r!==l&&(n.elements.input.setValue(r),n.syncInputSize(),t&&setTimeout(function(){n.elements.input.focus()},1)),d&&n.validate())},0)},buildTag:function(e){var t=this;return new i({text:e,onDestroy:function(){setTimeout(function(){t.syncInputSize(),t.validate()},10)},onChange:function(){t.syncInputSize(),t.validate()},onError:function(){t.syncInputSize(),t.options.onError()},syncInputSize:t.syncInputSize.bind(this),validator:t.options.validator,validatorAsync:t.options.validatorAsync})},isFirstEmailAlreadySelected:function(){var e=this.elements.input.getValue().split(";");return this.getSelected().indexOf(e[0])>-1},validate:function(){var e=this;setTimeout(function(){var t,n=e.elements.container.getElement(".tag-input-wrapper");n&&(""!==e.elements.input.getValue()||0!==e.getContent().getElements(".uwa-input-split.has-error").length?(n.hasClassName("has-error")||n.addClassName("has-error"),t=e.isFirstEmailAlreadySelected(),""!==e.elements.input.getValue()&&t?e.options.onError(!0,t):""!==e.elements.input.getValue()?e.options.onError():e.options.onError(!0)):(n.removeClassName("has-error"),e.options.onSuccess()))},10)},proceedRemove:function(){var e=this.elements.container.getElements(".uwa-input-tags.focus");e.length>0?(e.forEach(function(e){e.destroy()}),this.syncInputSize()):(e=this.elements.container.getElements(".uwa-input-tags")).length>0&&(e[e.length-1].destroy(),this.syncInputSize()),this.validate()},syncInputSize:function(){this.options.onChange()},getSelected:function(){var e=[];return this.elements.container.getElements(".uwa-input-tags span.form-control").forEach(function(t){e.push(t.getHTML())}),e},_extractEmails:function(e){return e.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi)}})}),define("DS/MPFShopMembersComponent/ModalShopMembersAdd",["UWA/Core","UWA/String","DS/UIKIT/SuperModal","DS/UIKIT/Mask","DS/UIKIT/Input/Select","DS/MPFShopMembersComponent/MPFInputTagger","i18n!DS/MPFShopMembersComponent/assets/nls/ShopMembersComponent","css!DS/MPFUI/MPFUI"],function(e,t,n,i,s,o,a){"use strict";return e.Class.extend({init:function(i){this._parent(i),this.serviceTerm=i.serviceTerm||a.get("lab"),this._container=null,this._validateButton=null,this._inviteCB=null,this._members=null,this._emails=[],this._roles=i.roles,this.title=i.title?i.title:t.format(a.inviteManagersTitle,t.ucfirst(this.serviceTerm)),i&&(i.container&&(this._container=i.container),i.inviteCB&&(this._inviteCB=i.inviteCB)),this.modalContainer=e.createElement("div",{class:"mpf-members-modal-container"}),this._superModal=new n({renderTo:this.modalContainer}),this._roleSelectDiv=e.createElement("div",{class:"mpf-membersRolesDiv"})},display:function(){this.modalContainer.inject(this._container);var t=this;if(this._emails=[],this._roles){for(var n=[],r=0;r<this._roles.length;r++)n[r]={label:a.get(this._roles[r]),value:this._roles[r]};this._roleLabel=e.createElement("label",{text:a.get("selectRole")}),this._roleSelect=new s({className:"",options:n,placeholder:!1}),this._roleSelectDiv.setContent([this._roleLabel,this._roleSelect])}var l=new o({cancelButtonID:"mpfSuperModalCancelButtonID",placeholder:a.inviteByEmailPlaceholder,limit:null,focus:!0,validator:function(t){return e.String.isEmail(t)},onError:function(e,n){var i=a.invalidEmail;e||t.errorInterval||(setTimeout(function(){t._displayError(i)},200),t.errorInterval=!0,setTimeout(function(){t.errorInterval=null},2e3)),n&&(i=a.emailAlreadyInList,t._displayError(i)),t._setValidateBtnDisabled(!0)},onLimitError:function(){var e=a.get("maxEmailLimit",{limit:null});t._displayError(e),t.errorInterval=!0,setTimeout(function(){t.errorInterval=null},2e3),t._setValidateBtnDisabled(!0)},onSuccess:function(){l.getSelected().length&&null===l.elements.container.getElement(".has-error")?(t._emails=l.getSelected(),t._setValidateBtnDisabled(!1),t._displayError("")):t._setValidateBtnDisabled(!0)},validatorAsync:function(e,n){for(var i=!1,s=0;t._members&&s<t._members.length;s++)if(e.toLowerCase()===t._members[s].email.toLowerCase()){i=!0;break}if(i){var o=a.youCantInviteAlreadyAddedMember;t._displayError(o),t._setValidateBtnDisabled(!0),n.onFailure()}else n.onComplete()},onChange:function(){l.getSelected().length&&t._setValidateBtnDisabled(!0)}}),c=e.createElement("div",{html:[{tag:"label",html:a.inviteByEmailLabel},l,this._roleSelectDiv,{tag:"label",html:a.addAMessageLabel},{tag:"textarea",class:"form-control invitation-message",rows:"2"},{tag:"br"},{tag:"p",class:"error-msg text-error",text:""}]}),u=[{className:"primary validate-btn",value:a.invite,action:function(e){if(t._setValidateBtnDisabled(!0),i.mask(t._validateButton,""),t._inviteCB){var n=e.elements.body.getElement(".invitation-message").value,s={emails:t._emails,message:n,roles:t._roleSelect?t._roleSelect.getValue():["ShopOperator","Admin"],onComplete:function(t){e.hide()},onFailure:function(e){i.unmask(t._validateButton),t._setValidateBtnDisabled(!1),t._displayError(a.get("memberInvitationFailed"))}};t._roles||(s.shopID=t._shopID),t._inviteCB(s)}}},{className:"default",id:"mpfSuperModalCancelButtonID",value:a.cancel,action:function(e){e.hide()}}];this._superModal.dialog({body:c,title:this.title,buttons:u}),this._validateButton=this._container.getElement(".validate-btn"),this._setValidateBtnDisabled(!0)},_displayError:function(e){this._container.getElement(".error-msg").setContent(e)},_setValidateBtnDisabled:function(e){var t=this._validateButton;t&&(e?t.setAttribute("disabled","true"):t.removeAttribute("disabled"))}})}),define("DS/MPFShopMembersComponent/ShopMembersComponent",["UWA/Core","UWA/String","DS/PlatformAPI/PlatformAPI","DS/MPFView/MPFView","DS/UIKIT/Alert","DS/UIKIT/Input/Select","DS/UIKIT/SuperModal","DS/UIKIT/DropdownMenu","DS/UIKIT/Mask","DS/MPFView/InitialsDot","DS/MPFShopMembersComponent/ModalShopMembersAdd","DS/MPFView/GuidanceHelper","DS/MPFInviteModel/InviteFactory","DS/Handlebars/Handlebars","text!DS/MPFShopMembersComponent/assets/templates/ShopMembersComponent.hbs","i18n!DS/MPFShopMembersComponent/assets/nls/ShopMembersComponent","css!DS/MPFUI/MPFUI"],function(e,t,n,i,s,o,a,r,l,c,u,d,m,h,p,g){"use strict";return i.extend({setup:function(i){console.warn('The component "DS/MPFShopMembersComponent/ShopMembersComponent" is deprecated. Consider using "DS/MPFMembersComponent/MembersComponent" instead.'),i||(i={}),this._parent(i),this.companyId=i.companyId,this.shopID=i.shopId,this.companyMembers=!0===i.companyMembers,this.completed=!0===i.completed,this.topic=i.mpTopic,this.internalLab=!0===i.internalLab,this.roles=i.roles,this.inviteFactory=i.inviteFactory,this.serviceTerm=e.is(i.serviceTerm,"string")?i.serviceTerm:g.get("lab"),this.tooltip=e.is(i.tooltip,"string")?i.tooltip:t.format(g.get("helpMessageInvitation"),this.serviceTerm,t.ucfirst(this.serviceTerm)),this._isEditable=!1!==i.isEditable,"ifCond"in h.helpers||h.registerHelper("ifCond",function(e,t,n){return e===t?n.fn(this):n.inverse(this)}),"initialsDot"in h.helpers||h.registerHelper("initialsDot",function(e,t){return new c({title:e,image:t}).getContent().outerHTML}),"I18N"in h.helpers||h.registerHelper("I18N",function(e,t){return void 0!==h.I18N?h.I18N.get(e,t.hash):e}),this.template=h.compile(p),this._superModal=new a({renderTo:this.container}),this.alert=new s({closable:!0,animate:!1,attributes:{style:"visibility: visible; z-index: 100;"}}),!0!==i.needData&&(this._addMembersModal=new u({container:this.container,inviteCB:this._onInvite.bind(this),roles:this.roles,title:i.addMembersModalTitle,serviceTerm:this.serviceTerm})),this.model&&this.model.size()>0&&n.publish(this.topic,{complete:!0,event:"updateMenu",id:"members"})},className:"mpf-members",tagName:"div",domEvents:{"click .add-member":"_openAddMemberModal"},render:function(){var e=this.model?this.model.toJSON():null;if(this._addMembersModal._members=e,this._addMembersModal._shopID=this.shopID,e){e.length>0&&this.topic&&n.publish(this.topic,{complete:!0,event:"updateMenu",id:"members"});for(var i=0;i<e.length;i++){var s=e[i],o=s.name?s.name:s.id;s.initials="active"===s.state&&s.firstName&&s.lastName?s.firstName+" "+s.lastName:s.email,s.removable=o!==n.getUser().login,s.admin=-1!==s.Roles.indexOf("Admin"),s.internalManager=-1!==s.Roles.indexOf("ShopOperator")}}h.I18N=g;var a=this.companyMembers?g.get("inviteMembersTitle"):t.format(g.get("inviteManagersTitle"),t.ucfirst(this.serviceTerm)),r=t.format(g.get("invitationInformation"),this.serviceTerm),l=this.template.call(null,{launchModalText:a,includeArrow:this._isEditable||this.internalLab,includeDescription:!this.companyMembers,invitationInformation:r,editable:this._isEditable&&!this.internalLab,internalLab:this.internalLab,members:e});this.container.setContent(l),this.alert.inject(this.container,"top");var c=this.container.getElement(".members-info");c&&new d({content:this.tooltip}).inject(c);return this._addDropdowns(),this},_openAddMemberModal:function(){this._addMembersModal.display()},_onInvite:function(e){for(var t=this,n=e.emails||[],i=e.message||"",s=[],o=0;o<n.length;o++){var a={email:n[o],Message:i};e.roles&&(a.Roles=e.roles),e.shopID&&(a.ShopId=e.shopID),s.push(a)}this.model.addAll(s,{companyId:this.companyId,onComplete:function(n){t.shopID&&(t.model.parentResourceId=t.shopID),e.onComplete(n),t.render()},onFailure:function(t){e.onFailure(t)}})},_addDropdowns:function(){var e,t,n,i,s,o,a=this.container.getElements(".remove-member");if(e=this._createChangeRoleItem(),n=this._createRemoveItem(),a&&a.length)for(var l=0;l<a.length;l++)o=[],this.companyMembers?(o.push(e),o.push(n)):this.internalLab?o.push(e):o.push(n),i=a[l].getAttribute("data-id"),s=this.model.get(i),!this.internalLab&&this.inviteFactory&&"active"!==s.get("state")&&(t=this._createResendInviteItem(i),o.unshift(t)),new r({target:a[l],items:o})},_createChangeRoleItem:function(){var e=this;return{fonticon:"pencil",handler:function(){e._onChangeRoles(e.model.get(this.options.target.getAttribute("data-id")))},text:g.changeRoles}},_createResendInviteItem:function(e){return{text:g.get("sendInvitation"),fonticon:"mail",handler:this._resendInvite.bind(this,e)}},_createRemoveItem:function(){var e=this;return{text:g.removeButton,fonticon:"wrong",handler:function(){e._onRemove(this.options.target.getAttribute("data-id"),this.options.target.getAttribute("data-name"))}}},_resendInvite:function(e){var t,n;return t=this.inviteFactory.createModel(m.Types.COMPANY_INVITE),this.companyId?(n=this.companyId,t.setShopId(this.shopID)):n=this.model.parentResourceId,t.parentResourceId=n,t.addMemberId(e),t.save()},_onChangeRoles:function(t){var n,i,a=this,r=[],l=this.internalLab?{style:"opacity: 0.6; pointer-events: none;"}:{},c=new s({closable:!0,animate:!1}),u=e.clone(l);u=Object.assign(u,{"data-id":"admin"});var d=e.clone(l);d=Object.assign(d,{"data-id":"buyer"});var m=[{attributes:u,disabled:this.internalLab,label:g.Admin,selected:-1!==t.get("Roles").indexOf("Admin"),value:"Admin"},{attributes:d,disabled:this.internalLab,label:g.Buyer,selected:-1!==t.get("Roles").indexOf("Buyer"),value:"Buyer"}];this.internalLab&&m.push({attributes:{"data-id":"operator"},label:g.ShopOperator,selected:-1!==t.get("Roles").indexOf("ShopOperator"),value:"ShopOperator"}),n=new o({multiple:!0,options:m,placeholder:!1,events:{onChange:function(){(r=n.getValue(),a.companyMembers)&&(-1!==t.get("Roles").indexOf("ShopOperator")&&r.push("ShopOperator"))}}}),r=n.getValue(),this._superModal.dialog({body:e.createElement("div",{class:"",html:[c,n]}),buttons:[{action:function(e){var n=t.get("Roles");a._lastLabManagerRemoved(n,r)?((i=c.getMessages()).length>0&&i.forEach(function(e){c.remove(e)}),c.inject(e.elements.body,"top"),c.add({message:g.get("onlyManagerRole"),className:"error"}).show()):r.length>0?(a.model.updateRoles(t.get("id"),{companyId:a.companyId,shopId:a.shopID,email:t.get("email"),newRoles:r,previousRoles:n,onFailure:a._onUpdateRolesFailure.bind(a),onComplete:a._onUpdateRolesComplete.bind(a)}),a.shopId&&(a.model.parentResourceId=a.shopID),t.set("Roles",r),e.hide(),e.destroy(),a.render()):((i=c.getMessages()).length>0&&i.forEach(function(e){c.remove(e)}),c.add({message:g.get("noRoleError"),className:"error"}).show())},className:"primary mpf-btn-ok",value:g.get("OK")},{action:function(e){t.get("Roles").length>0?(e.hide(),e.destroy()):((i=c.getMessages()).length>0&&i.forEach(function(e){c.remove(e)}),c.inject(e.elements.body,"top"),c.add({message:g.get("noRoleError"),className:"error"}).show())},className:"default mpf-btn-cancel",value:g.get("cancel")}],title:g.get("changeRoles")})},_onUpdateRolesComplete:function(){this.alert.add({className:"success",message:g.get("roleUpdateSuccessful")}).show()},_onUpdateRolesFailure:function(){this.alert.add({className:"error",message:g.get("errorMsg")}).show()},_onRemove:function(e,t){var n=this;n._superModal.confirm(g.get("areYouSurToRemove",{name:t}),g.confirmationModalTitle,function(t){if(t){var i=n.container.getElement('.member[data-id="'+e+'"]');if(i&&l.mask(i,""),n.model.removeOne){var s={companyId:n.companyId,onComplete:n._onRemoveComplete.bind(n),onFailure:n._onRemoveFailure.bind(n,i),roles:n.model.get(e).get("Roles")};n.internalLab||s.roles.push("Admin"),-1!==s.roles.indexOf("ShopOperator")&&(s.shopID=n.shopID),n.model.removeOne(e,s)}}})},_onRemoveComplete:function(){this.shopID&&(this.model.parentResourceId=this.shopID),this.render()},_onRemoveFailure:function(e,t){var n;n=-1!==t.message.indexOf("403")?g.get("onlyManagerMsg"):g.get("errorMsg"),this.alert.add({className:"error",message:n}).show(),l.unmask(e)},_lastLabManagerRemoved:function(e,t){var n;return n=-1!==e.indexOf("ShopOperator")&&-1===t.indexOf("ShopOperator"),1===this.model.filter(function(e){return-1!==e.get("Roles").indexOf("ShopOperator")}).length&&n},destroy:function(){this.alert.destroy(),this.model=null,this._parent(),this.container=null}})});