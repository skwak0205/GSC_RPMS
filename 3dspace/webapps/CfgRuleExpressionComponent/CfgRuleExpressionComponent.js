define("DS/CfgRuleExpressionComponent/Presenter/CfgRuleExpressionComponentExpressionGenerator",["DS/CfgDictionary/CfgDictionaryTypeEnum","DS/CfgDictionary/CfgDictionaryOperatorEnum"],function(e,n){"use strict";var t={generateRawExpression:function(t){var i="";if(t&&t&&0!==t.length){var o=0,r=!1,s=!1,l=null,a=null,c=null,u=!1;for(o=0;o<t.length;o+=1)u=!1,a=t[o].type,c=t[o+1]?t[o+1].type:null,l=t[o],a===e.VARIANT&&c===e.VALUE?(r=!0,u=!0):a===e.VALUE&&c===e.VALUE?(s=!1,u=!1):a===e.VALUE&&c!==e.VALUE&&(u=!1,s=!0),u||(a===e.VALUE?(r&&(i+=" (",r=!1),i+=s?l.id:l.id+" OR ",s&&(i+=") ",s=!1)):a===n.binary_operator||a===n.unary_operator||a===n.opening_separator||a===n.closing_separator?i+=" "+l.value:i+=" "+l.id);return i=" "===(i=i.replace(/  +/g," "))[0]?i.substr(1):i}},generateExpression:function(e){var n,i={version:"1.0.1"};return n=t.generateRawExpression(e),i.expression=n,"EREV1:"+JSON.stringify(i)},generateDependencies:function(n){var t=[],i=0,o=[];for(i=0;i<n.length;i+=1)if(n[i].type===e.VARIANT||n[i].type===e.VALUE||n[i].type===e.OPTION||n[i].type===e.PACK){var r=n[i].id;o.indexOf(r)<0&&o.push(r)}var s={};for(i=0;i<o.length;i+=1)(s={}).id=o[i],t.push(s);return t}};return t}),define("DS/CfgRuleExpressionComponent/Model/CfgRuleExpressionModel",["UWA/Class/Model"],function(e){"use strict";return e.extend({editable:null,fullDictionary:null,autoCompleteRuleModel:null,languageInformation:null,solverKey:null})}),define("DS/CfgRuleExpressionComponent/Presenter/CfgRuleExpressionPresenter",["DS/CfgRuleExpressionComponent/Model/CfgRuleExpressionModel","DS/CfgAutoCompleteComponent/Presenter/CfgAutoCompletePresenter","DS/CfgLanguageInformationComponent/Presenter/CfgLanguageInformationPresenter","DS/CfgDictionary/CfgDictionaryMapperUtils","DS/Core/ModelEvents","DS/xModelEventManager/xModelEventManager","DS/UIKIT/Input/Button","DS/UIKIT/Input/ButtonGroup","DS/UIKIT/Spinner","DS/UIKIT/Popover","DS/UIKIT/Iconbar","DS/UIKIT/SuperModal","DS/ENOXSplitViewVertical/js/ENOXSplitViewVertical","DS/UIKIT/Mask","DS/Handlebars/Handlebars","DS/CfgRuleExpressionComponent/Presenter/CfgRuleExpressionComponentExpressionGenerator","DS/CfgSolver/CfgSolverServices","DS/CfgRuleMatrixComponent/Runtime/ConflictPanelPresenter","i18n!DS/CfgRuleExpressionComponent/assets/nls/CfgRuleExpressionComponent","text!DS/CfgRuleExpressionComponent/View/CfgRuleExpressionTemplate.html","css!DS/CfgRuleExpressionComponent/View/CfgRuleExpressionComponent.css"],function(e,n,t,i,o,r,s,l,a,c,u,p,_,h,f,d,g,v,C,y,E){"use strict";var m=function(e,n){this._ruleExpressionModel=e,this._fullDictionary=e.fullDictionary,this._mapDico=i.dicoMinifiedV3ToMap(this._fullDictionary),this._solverKey=e.solverKey,this._languageInformation=e.languageInformation,this._ruleExpressionExpression=e.autoCompleteRuleModel,this._ruleName=n.ruleName?n.ruleName:C._rule,this._ruleTitle=n.ruleTitle?n.ruleTitle:C._rule,this._isConflictPanelOpen=!1,this._isVariabilityPanelOpen=!1,this._editable=!0===n.editable,this._isInConflict=null,this._initialExpression=JSON.parse(JSON.stringify(e.autoCompleteRuleModel)),this._applicationChannel=n.applicationChannel,this._updateChannel=n.updateChannel,this._privateChannelForRules=n.privateChannelForRules,this._localModelEvents=n.localModelEvents?n.localModelEvents:new o,this._myEventManager=new r(this._applicationChannel,this._updateChannel),this._subscribeToEvents(),this._initLanguageInformation(),this._initAutoComplete(),this._initInternalActions(),this._createOKCancelActions(),this._initDiv()};return m.prototype._initAutoComplete=function(){this._cfgAutoCompleteRulePresenter=null;var e={};e.currentExpression=this._ruleExpressionExpression,e.dictionary=this._fullDictionary,e.withAdvancedOperator=!0,e._localModelEvent=this._localModelEvents,e.solverKey=this._solverKey,e.editable=this._editable,e.dictionary_mapped=this._mapDico,this._cfgAutoCompleteRulePresenter=new n(e)},m.prototype._initLanguageInformation=function(){this._cfgLanguageInformationPresenter=null;var e={};e._givenModel=this._languageInformation,e._localModelEvent=this._localModelEvents,this._cfgLanguageInformationPresenter=new t(e)},m.prototype._initDiv=function(){var e=f.compile(y)();this._container=document.createElement("div"),this._container.innerHTML=e,this._container=this._container.firstElementChild,UWA.extendElement(this._container),this._splitViewVertical=new _;this._splitViewVertical.init({originalTop:60,sizeType:"px",resizable:!0}),this._splitViewVertical.setMaxHeightOnTop(2500),this._splitViewVertical.setNumberTop(60),this._splitViewVertical.inject(this._container.querySelector(".ruleexpression-frame")),this._cfgAutoCompleteRulePresenter.inject(this._splitViewVertical.getTop()),this._cfgAutoCompleteRulePresenter.render(),this._cfgLanguageInformationPresenter.inject(this._splitViewVertical.getBot()),this._cfgLanguageInformationPresenter.render(),this._actionBar=new u({renderTo:this._container.querySelector(".ruleexpression-header-content"),items:this._actions}),this._localModelEvents.subscribe({event:"onChangeExpression"},this._checkSolverCompatibility.bind(this)),this._localModelEvents.subscribe({event:"onCheckExpression"},this._checkSolverCompatibility.bind(this)),this._subResize(),this._OkCancel.inject(this._container.querySelector(".ruleexpression-footer-content"))},m.prototype._initInternalActions=function(){this._actions=[];var e=this,n={text:"Solver computing",title:"Solver computing",icon:"progress-0",fonticon:"progress-0",selected:!1,handler:function(e,n){0}},t={text:C.conflict_with_existing_rules,title:C.conflict_with_existing_rules,icon:"attention",fonticon:"attention",selected:!1,handler:function(n,t){e._updateChannel.publish({event:"triptych-hide-panel-if-opened-from-rule"});var i=e._getSolverObject(!0);var o=function(n,t){if(e._internalActionConflictContainer.setStyle("pointerEvents","auto"),e._internalActionLoaderContainer.classList.add("displaynone"),"string"==typeof n&&(n=JSON.parse(n)),null!=n&&("OK"===n._rc||"S_FALSE"===n._rc||"CONFLICTING_RULE"===n._rc))if(""===n)e._isInConflict=!1,e._internalActionConflictContainer.classList.add("displaynone");else{e._updateChannel.publish({event:"show-loading-right-panel"});var i=0,o={};for(o.privateChannelForRules=e._privateChannelForRules,o.causingRulesList=[],o.conflictingRules=[],i=0;i<n._data.conflictingRules.length;i+=1){var r=n._data.conflictingRules[i].substring(0,32),s=e._mapDico[r];o.conflictingRules[s.name]=r,o.causingRulesList.push(s)}var l={};l.conflictingRules=n._data.conflictingRules,l.reasons=o,e._updateChannel.publish({event:"get-rule-details",data:l})}};e._internalActionConflictContainer.setStyle("pointerEvents","none"),e._internalActionLoaderContainer.classList.remove("displaynone"),e._solverKey&&i?g.computeAnswer(i,e._solverKey,null,!0).then(o,function(n){e._privateChannelForRules.publish({event:"solver-call-error",data:n})}):o("")}};this._actions.push(n),this._actions.push(t)},m.prototype._createOKCancelActions=function(){this._OkCancelIsDisplayed=!1;var e=this,n=function(n){e._privateChannelForRules.publish({event:"update-ready-to-navigation-flag",data:!0}),e._applicationChannel.publish({event:"update-ready-to-navigation-flag",data:!0}),h.unmask(e._container),e._container.querySelector(".ruleexpression-footer-content").classList.add("displaynone"),e._localModelEvents.publish({event:"onResize",data:null}),e._splitViewVertical._resize(e._splitViewVertical.getTop().clientHeight+40),e._OkCancelIsDisplayed=!1,n?e._initialExpression=JSON.parse(JSON.stringify(e.getExpression())):(e._cfgAutoCompleteRulePresenter.setExpression(JSON.parse(JSON.stringify(e._initialExpression))),e._cfgAutoCompleteRulePresenter.createInitialExpression(),e._localModelEvents.publish({event:"onCheckExpression",data:null}))};e._localModelEvents.subscribe({event:"onChangeExpression"},function(){e._applicationChannel&&e._privateChannelForRules&&(e._privateChannelForRules.publish({event:"update-ready-to-navigation-flag",data:!1}),e._applicationChannel.publish({event:"update-ready-to-navigation-flag",data:!1})),e._OkCancelIsDisplayed||(e._container.querySelector(".ruleexpression-footer-content").classList.remove("displaynone"),e._localModelEvents.publish({event:"onResize",data:null}),e._splitViewVertical._resize(e._splitViewVertical.getTop().clientHeight-40)),e._OkCancelIsDisplayed=!0}),e._localModelEvents.subscribe({event:"onDone"},n),e._localModelEvents.subscribe({event:"onFailSave"},function(){h.unmask(e._container)});var t=new s({value:C.save,className:"primary"});t.addEvent("onClick",function(){h.mask(e._container);var n=function(n){!0===n?e._localModelEvents.publish({event:"onSave",data:{expression:e.getExpression()}}):e._localModelEvents.publish({event:"onFailSave"})};e.containsError()&&!0===e.isInConflict()||(e.containsError()?new p({renderTo:e._container}).confirm(C._confirmation_save_rule+" "+e._ruleTitle+"? "+C._error_confirmation_message,C._save_rule,n):e._cfgRuleExpressionPresenter&&!0===e._cfgRuleExpressionPresenter.isInConflict()?new p({renderTo:e._container}).confirm(C._confirmation_save_rule+" "+e._ruleTitle+"? "+C._conflict_confirmation_message,C._save_rule,n):n(!0))});var i=new s({value:C._undo,className:"default"});i.addEvent("onClick",function(){n(!1)});var o=new l({buttons:[t,i]});e._OkCancel=o},m.prototype.inject=function(e){e.appendChild(this._container),this._triggerResizeInit(),this._localModelEvents.publish({event:"onCheckExpression",data:null})},m.prototype._subResize=function(){var e=this;e._localModelEvents.subscribe({event:"onResize"},function(){var n=e._container.querySelector(".ruleexpression-frame"),t=e._container.querySelector(".ruleexpression-language-information").clientHeight+e._container.querySelector(".ruleexpression-header-content").clientHeight+e._container.querySelector(".ruleexpression-footer-content").clientHeight;n.style.height="calc(100% - "+t+"px)"}),e._localModelEvents.subscribe({event:"onResizeLIP"},function(n){var t=e._container.querySelector(".ruleexpression-frame").clientHeight;n?e._splitViewVertical._resize(t/2):(e._splitViewVertical._resize(t-60),e._cfgLanguageInformationPresenter._accordion.unselectAll())})},m.prototype._getSolverObject=function(e){var n=d.generateRawExpression(this._cfgAutoCompleteRulePresenter.getExpression()),t=e?"true":"false",i={},o={};if(o.expression=n,o.computeCause=t,""===n)return null;return i._data=o,i._from="CfgRuleExpressionPresenter",i._to="solverRule",i._request="checkExpressionValidity",i},m.prototype.getExpression=function(){return this._cfgAutoCompleteRulePresenter.getExpression()},m.prototype._checkSolverCompatibility=function(){var e=this;if(e._internalActionConflictContainer=e._container.querySelectorAll(".iconbar li")[1],e._internalActionLoaderContainer=e._container.querySelectorAll(".iconbar li")[0],!e._cfgAutoCompleteRulePresenter.isThereError()){var n=null;n=e._isConflictPanelOpen&&!e._isVariabilityPanelOpen?e._getSolverObject(!0):e._getSolverObject(!1);var t=function(n,t){if(""!==n&&(n=JSON.parse(n)),e._internalActionConflictContainer.setStyle("pointerEvents","auto"),e._internalActionLoaderContainer.classList.add("displaynone"),e._isConflictPanelOpen&&!e._isVariabilityPanelOpen){e._updateChannel.publish({event:"show-loading-right-panel"});var i=0,o={};if(o.privateChannelForRules=e._privateChannelForRules,o.causingRulesList=[],o.conflictingRules=[],n._data.conflictingRules)for(i=0;i<n._data.conflictingRules.length;i+=1){var r=n._data.conflictingRules[i].substring(0,32),s=e._mapDico[r];o.conflictingRules[s.name]=r,o.causingRulesList.push(s)}var l={};l.conflictingRules=n._data.conflictingRules,l.reasons=o,e._updateChannel.publish({event:"get-rule-details",data:l})}if(null==n||"OK"!==n._rc&&"S_FALSE"!==n._rc&&"CONFLICTING_RULE"!==n._rc)return e._internalActionConflictContainer.classList.add("displaynone"),void(e._isInConflict=null);""===n?(e._isInConflict=!1,e._internalActionConflictContainer.classList.add("displaynone")):"OK"===n._rc||"S_FALSE"===n._rc?(e._isInConflict=!1,e._internalActionConflictContainer.classList.add("displaynone")):(e._isInConflict=!0,e._internalActionConflictContainer.classList.remove("displaynone"))};e._solverKey&&n?(e._internalActionConflictContainer.setStyle("pointerEvents","none"),e._internalActionLoaderContainer.classList.remove("displaynone"),g.computeAnswer(n,e._solverKey,null,!0).then(t,function(n){e._privateChannelForRules.publish({event:"solver-call-error",data:n})})):t("")}else e._isInConflict=!1,e._internalActionConflictContainer.classList.add("displaynone")},m.prototype._triggerResizeInit=function(){this._localModelEvents.publish({event:"onResize",data:null}),this._cfgLanguageInformationPresenter._isOpen?this._localModelEvents.publish({event:"onResizeLIP",data:!0}):this._localModelEvents.publish({event:"onResizeLIP",data:!1})},m.prototype.addToolBarAction=function(e){this._actions.push(e),this._container.querySelector(".ruleexpression-header-content").innerHTML="",this._actionBar=new u({renderTo:this._container.querySelector(".ruleexpression-header-content"),items:this._actions});this._internalActionConflictContainer=this._container.querySelectorAll(".iconbar li")[1],this._internalActionLoaderContainer=this._container.querySelectorAll(".iconbar li")[0],this._internalActionLoaderContainer.style.pointerEvents="none",this._internalActionLoaderContainer.style.color="white";var n=(new a).inject(this._internalActionLoaderContainer).show();n.elements.container.style.position="absolute",n.elements.container.style.left="8px",n.elements.container.style.top="4px"},m.prototype.isInConflict=function(){return this._isInConflict},m.prototype.containsError=function(){return this._cfgAutoCompleteRulePresenter.isThereError()},m.prototype._subscribeToEvents=function(){var e=this;this._myEventManager.subscribe(this._applicationChannel,{event:"triptych-panel-visible"},function(n){e._isConflictPanelOpen=!0}),this._myEventManager.subscribe(this._applicationChannel,{event:"triptych-panel-hidden"},function(n){e._isConflictPanelOpen=!1}),this._myEventManager.subscribe(e._applicationChannel.subscribe({event:"variability-panel-visible"},function(){e._isVariabilityPanelOpen=!0})),this._myEventManager.subscribe(e._applicationChannel.subscribe({event:"variability-panel-hidden"},function(){e._isVariabilityPanelOpen=!1}))},m.prototype.destroy=function(){this._myEventManager&&(this._myEventManager.cleanup("CfgRuleExpressionPresenter"),this._myEventManager=null)},m});