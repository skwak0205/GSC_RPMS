define("DS/UrbanManipulator/Keyframe",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/Animation/PropertyAnimation","DS/Animation/AnimationPath","DS/UrbanTool/Utils","DS/XCityTools/Debug"],function(t,e,i,s,n,o){"use strict";var a=e.extend({init:function(e){if(this.verbose=!1,this.spheric=!1,this.position=null,this.time=null,this.date=null,this.quaternion=null,this._eye=null,this._up=null,this._target=null,n.is(e)){var i;for(i in e)e.hasOwnProperty(i)&&(this[i]=e[i]);n.is(this.position)&&(this.position=(new t.Vector3).copy(this.position)),n.is(this.date)&&(this.date=new Date(this.date)),n.is(this.quaternion)&&(this.quaternion=new t.Quaternion(this.quaternion.x,this.quaternion.y,this.quaternion.z,this.quaternion.w)),n.is(this._eye)&&(this._eye=(new t.Vector3).copy(this._eye)),n.is(this._up)&&(this._up=(new t.Vector3).copy(this._up)),n.is(this._target)&&(this._target=(new t.Vector3).copy(this._target)),n.is(this._right)&&(this._right=(new t.Vector3).copy(this._right))}this.normalize()},lerp:function(t,e,i){if(!n.is(t))return n.is(e)?e:null;if(!n.is(e))return t;var s=t.clone(),o=e.clone();return s.multiplyScalar(1-i),o.multiplyScalar(i),s.add(o)},lerpValue:function(t,e,i){return n.is(t)&&n.is(e)?t+(e-t)*i:null},lerpQuat:function(t,e,i){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w<=0&&(e.x=-e.x,e.y=-e.y,e.z=-e.z,e.w=-e.w),t.clone().slerp(e,i)},lerpTime:function(t,e,i){if(!n.is(t)||!n.is(e))return null;var s=t.getTime(),o=e.getTime(),a=this.lerpValue(s,o,i),r=new Date;return r.setTime(a),r},interpol:function(e,i,s){var r=new a;if(n.is(this.time)&&n.is(e.time)&&(r.time=this.lerpValue(this.time,e.time,i)),n.is(this.date)&&n.is(e.date)&&(r.date=this.lerpTime(this.date,e.date,i)),n.is(s)){if(r.position=s,!0===this.spheric){var h=this.lerpValue(this.position.length(),e.position.length(),i);r.position.setLength(h)}}else if(n.is(this.position)&&n.is(e.position)&&(r.position=this.lerp(this.position,e.position,i),!0===this.spheric)){var l=this.position.length(),u=e.position.length();h=this.lerpValue(l,u,i);r.position.setLength(h)}if(n.is(this.fadeOn)&&(i=this.fadeinout(i)),n.is(this._target)&&n.is(e._target)){r._target=this.lerp(this._target,e._target,i),r._eye=r._target.clone().sub(r.position),r._eye.normalize(),0===e._eye.x&&0===e._eye.y||0===this._eye.x&&0===this._eye.y?(r._up=this.lerp(this._up,e._up,i),o.log(n.displayVector(r._eye.normalize())+" "+n.displayVector(r._up))):r._up=n.getUpFromCameraEye(r._eye);var c=n.getQuaternion2(r.position,r._target,r._up);r.setQuaternion(c)}else{c=new t.Quaternion;var d=this.getQuaternion(),m=e.getQuaternion();n.is(d)&&n.is(m)?(c=this.lerpQuat(d,m,i),r.setQuaternion(c),!0===this.verbose&&o.log("up "+n.displayVector(r._up))):o.log("quaternion interpolation error ")}return r},setQuaternion:function(e){n.is(this.quaternion)||(this.quaternion=new t.Quaternion),n.is(e)&&(this.quaternion.copy(e),this.normalize())},getQuaternion:function(){return this.quaternion},normalize:function(){return n.is(this.quaternion)&&(this.quaternion.normalize(),n.is(this._eye)||(this._eye=new t.Vector3),this._eye.copy(n.refX),this._eye.applyQuaternion(this.quaternion),this._eye.normalize(),n.is(this._up)||(this._up=new t.Vector3),this._up.copy(n.refZ),this._up.applyQuaternion(this.quaternion),this._up.normalize(),n.is(this._right)||(this._right=new t.Vector3),this._right.copy(this._eye),this._right.cross(this._up),this._right.normalize()),this},clone:function(){return new a(this)},initQuat:function(t,e){var i;(n.is(this.position)&&n.is(this._target)&&n.is(this._up)&&this.initQuat2(),n.is(this.quaternion))||(i=n.is(t)?n.is(e)?n.getQuaternion(t,e):n.getQuaternionFromEye(t):n.getQuaternionBetween(n.refZ,e),this.setQuaternion(i))},initQuat2:function(){n.is(this.position)&&n.is(this._target)&&n.is(this._up)&&this.setQuaternion(n.getQuaternion2(this.position,this._target,this._up))},fadein:function(t){return 1-Math.cos(t*Math.PI/2)},fadeout:function(t){return Math.sin(t*Math.PI/2)},fadeinout:function(t){return.5*(1-Math.cos(Math.PI*t))}});return a}),define("DS/UrbanManipulator/CameraAnimation",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/Animation/PropertyAnimation","DS/UrbanTool/Utils","DS/XCityTools/Debug"],function(t,e,i,s,n){"use strict";return e.extend({init:function(t,e,n,o){this.control=t,this.currentPath=e,this.updateCalls=0,this.animation=new i(this,"updateTime",e),this.name=n,this.runOnce=!0,this.stopped=!1,this.verbose=!1,s.is(o)&&(this.runOnce=o)},getKeyframes:function(){return this.currentPath.getKeyframes()},getCurrentKeyframe:function(){return this.currentPath.getCurrentKeyframe()},updateTime:function(t){!0===this.verbose&&n.log(t),this.animationTime=t;var e=this.getCurrentKeyframe();this.control.setKeyframe(e),this.updateCalls++},setPath:function(t){this.stop(),this.currentPath=t,this.animation.setPath(this.currentPath)},start:function(){this.updateCalls=0,this.lastStartTime=window.performance.now(),this.animation.start()},pause:function(){0===this.animation.state()&&this.animation.pause()},play:function(){this.stopped=!1,2===this.animation.state()?this.resume():this.start()},resume:function(){2===this.animation.state()&&this.animation.resume()},displayRuntime:function(){!0===this.verbose&&(n.log(" runtime "+this.lastRuntime),n.log(" calls "+this.updateCalls),n.log(" avg fps "+this.updateCalls/(this.lastRuntime/1e3)))},stop:function(){this.animation.stop(),this.lastRuntime=window.performance.now()-this.lastStartTime,this.displayRuntime()},isDone:function(){return!s.is(this.animation.state())||1===this.animation.state()},getKeyframe:function(t){return s.is(this.currentPath)?this.currentPath.getKeyframe(t):null},setKeyframe:function(t,e){return s.is(this.currentPath)?this.currentPath.setKeyframe(t,e):null},addKeyframe:function(t,e){return s.is(this.currentPath)?this.currentPath.addKeyframe(t,e):null},removeKeyframe:function(t){return s.is(this.currentPath)?this.currentPath.removeKeyframe(t):null},duration:function(){return s.is(this.currentPath)?this.currentPath.duration():0},size:function(){return s.is(this.currentPath)&s.is(this.currentPath.keyframes)?this.currentPath.keyframes.length:0},setTime:function(t){return t<=0?(this.animation.setTime(t),this.animation.stop()):(this.animation.start(),this.animation.pause(),this.animation.setTime(t)),this.animation.time()},setFrame:function(t,e){var i=(t-1)/e*1e3;return i=Math.max(0,i),this.setTime(i),this.animation.time()===i},goToKeyframe:function(t){var e=this.getKeyframe(t);return s.is(e)?(this.setTime(e.time),e):null},isRunning:function(){return!0!==this.stopped&&(this.isPlaying()||(this.stopped=!0),!0)},isPlaying:function(){return 0===this.animation.state()}})}),define("DS/UrbanManipulator/ManipulatorParams",["UWA/Class"],function(t){"use strict";return t.extend({init:function(t){var e;for(e in this.resetDefaultValue(),t)t.hasOwnProperty(e)&&(this[e]=t[e])},resetDefaultValue:function(){this.STATE={NONE:-1,ROTATE:2,ZOOM:-2,PAN:0,TOUCH_ROTATE:3,TOUCH_ZOOM:4,TOUCH_PAN:5,TOUCH_TILT:6,KEYBOARD_PAN:7,KEYBOARD_ROTATE:8,KEYBOARD_ZOOM:9},this.Keys={PAN_LEFT:37,PAN_RIGHT:39,PAN_FRONT:38,PAN_BACK:40,ROTATE_LEFT:100,ROTATE_RIGHT:102,ROTATE_DOWN:98,ROTATE_UP:104,ZOOM_IN:107,ZOOM_OUT:109,RESET:32,KEYFRAME:75,PLAY:80},this.keysSpeed=.1,this.moveDuration2=1,this.moveDuration=7,this.moveToTarget=!0,this.minHeight=1.5,this.rotateSpeed=.7,this.zoomSpeed=2,this.panSpeed=1,this.touchZoom=2,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noAnimation=!1,this.focusTime=10,this.dynamicDampingFactor=.15,this.dampingTime=1,this.targetDisplay=!0,this.altMax=57403233,this.pickingAltitude=0,this.exactAltitude=2*this.altMax,this.groundModeAltitude=1.8,this.manipTransitionDuration=2,this.defaultDistance=75,this.northMoveDuration=1,this.guiPanFactor=1,this.guiPanHoldFactor=.3,this.guiRotateFactor=2,this.guiRotateHoldFactor=.2,this.guiZoomFactor=4,this.guiZoomHoldFactor=.1,this.guiTiltMin=0,this.guiPanVisualOffset=7,this.guiZoomVisualOffset=2,this.cursorChangeDelay=300,this.manipulationSpeedFactor=1,this.manipulationShiftSpeedFactor=5,this.pitchMax=85,this.maxfactor=4,this.fovMin=1,this.fovMax=179,this.noAnimationOnActivation=!1,this.defaultDistanceOnActivation=1e3,this.panLimitFactor=1e-4,this.doubleClickZoomFactor=10,this.resetTime=10,this.pandirframe=3,this.zoomExactPick=!1,this.leftDoubleClickEnable=!0,this.rightDoubleClickEnable=!0,this.noExactRepick=!1},resetDefaultGroundValue:function(){this.resetDefaultValue(),this.groundModeAltitude=1.8,this.noZoom=!0,this.minHeight=this.groundModeAltitude,this.guiPanFactor=1,this.guiPanHoldFactor=.3,this.guiRotateFactor=2,this.guiRotateHoldFactor=.2,this.guiZoomFactor=4,this.guiZoomHoldFactor=.1,this.guiTiltMin=90,this.pitchMax=180,this.panSpeed=.1,this.rotateSpeed=.3,this.zoomSpeed=3,this.targetDisplay=!1,this.defaultDistanceOnActivation=5,this.rightDoubleClickEnable=!1},resetDefaultFixedValue:function(){this.resetDefaultGroundValue(),this.noZoom=!1,this.fovMin=1,this.fovMax=179},resetDefault2DValue:function(){this.resetDefaultValue(),this.pitchMax=0},resetDefaultSphericValue:function(){this.resetDefaultValue(),this.defaultDistanceOnActivation=15e6,this.noRotate=!0,this.panSpeed=2,this.pitchMax=360,this.leftDoubleClickEnable=!1,this.rightDoubleClickEnable=!1,this.dampingTime=2,this.zoomSpeed=.75,this.noExactRepick=!0}})}),define("DS/UrbanManipulator/CityRobot",["DS/Robot/FreeRobot","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/xCityBasicUtils/Utils"],function(t,e,i,s){"use strict";return t.extend({init:function(t,e,i,s,n){this._parent(t,e,i,s,n),this.setDisplayScalingNodes(!1),this.setDisplayTiltingArcAndPlanesNodes(!1)},setCityFeature:function(t){this._cityfeature=t;var e=t;t.impl&&(e=t.impl),this._citycontent=e.getContent()},setPickingMethod:function(t){this._picking=t},setDisplayTiltingArcAndPlanesNodes:function(t){this.rotationArcYZ.setVisibility(!!t),this.rotationArcXZ.setVisibility(!!t),this.translationPlaneYZ.setVisibility(!!t),this.translationPlaneXZ.setVisibility(!!t)},setDisplayBaseRotation:function(t){this.rotationArcXY.setVisibility(!!t),this.translationPlaneXY.setVisibility(!!t)},showcontent:function(t){if(this._citycontent){var e=this._citycontent._node;if(e.children.length>0&&(e=e.children[0]).children.length>0){e=e.children[0];for(var i=0;i<Math.round(e.children.length);i++){e.children[i].setVisibility(t)}}return this.waspickable=!0,!0}return!1},showmost:function(t){this.robotHandle.setVisibility(!!t)},ScreenPlaneTranslationBeginCB:function(t){this.target&&(this.setManipulated(!0),this.initialMatrix=(new e.Matrix4).copy(this.getMatrix()),this.initialTargetWorldMatrix=(new e.Matrix4).copy(this.target.getWorldMatrix(t.viewer)),this.showOnlyManipulated&&this.setToGhostState(),this._citycontent&&(this.showcontent(!1),this.robotwaspickable=this.visible,this.showmost(!1),this.initialPositionPicked=this._picking(t.event.from[0].currentPosition)),t.viewer.render()),this._modelEvent.publish({event:"ScreenPlaneTranslationBegin",data:{eventChannel:"ScreenPlaneTranslationBegin",target:this.target,intersection:t.intersection,manipulator:t.manipulator,event:t.event}})},ScreenPlaneTranslationManipulationCB:function(t){if(this.target){var i=t.paths[0].externalPath;if(this.contains(this,i)){var s=new e.Vector3,n=this._picking(t.event.from[0].currentPosition);n&&this.initialPositionPicked&&(t.translationVector=n.sub(this.initialPositionPicked)),s.getPositionFromMatrix(this.initialMatrix),s.add(t.translationVector);var o=(new e.Matrix4).copy(this.getMatrix());this.setMatrix(o.setPosition(s)),this.updateCenterPosition(s)}var a=new e.Vector3;a.getPositionFromMatrix(this.initialTargetWorldMatrix),a.add(t.translationVector);var r=(new e.Matrix4).copy(this.initialTargetWorldMatrix).setPosition(a);if(this.sceneGraphState&&"OCCURRENCE_secret"===this.mode)this.sceneGraphState.applyAbsolutePositionToPath(this.target,r);else if("NODE"===this.mode){var h,l=this.target.externalPath,u=this.target.getParentPath();h=u?u.getWorldMatrix(t.viewer):new e.Matrix4;var c=new e.Matrix4;c.getInverse(h);var d=c.multiply(r);l[l.length-1].setMatrix(d)}t.viewer.render()}this._modelEvent.publish({event:"ScreenPlaneTranslationManipulation",data:{eventChannel:"ScreenPlaneTranslationManipulation",target:this.target,translationVector:t.translationVector,intersection:t.intersection,manipulator:t.manipulator,event:t.event}})},ScreenPlaneTranslationEndCB:function(t){this.target&&(this.setManipulated(!1),this.showOnlyManipulated&&this.setToNonGhostState(),this._citycontent&&(this.waspickable&&(this.showcontent(!0),this.waspickable=null),this.robotwaspickable&&(this.showmost(!0),this.robotwaspickable=null),this.initialPositionPicked=null),t.viewer.render(),this.endCenterClick=Date.now()),this._modelEvent.publish({event:"ScreenPlaneTranslationEnd",data:{eventChannel:"ScreenPlaneTranslationEnd",target:this.target,intersection:t.intersection,manipulator:t.manipulator,event:t.event}})}})}),define("DS/UrbanManipulator/QuaternionSpline",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/UrbanTool/Utils","DS/XCityTools/Debug"],function(t,e,i,s){"use strict";var n=e.extend({init:function(t){if(this.quaternions=[],this.verbose=null,this.extra=!1,i.is(t)&&t.length>0){if(!0===this.extra){this.quaternions[0]=t[0].normalize().clone();for(var e=0,s=t.length;e<s;e++)this.quaternions[e+1]=t[e].normalize().clone();this.quaternions[t.length+1]=t[t.length-1].normalize().clone()}else this.quaternions=t;this._normalize(this.quaternions);var n=[];n.push(this.quaternions[0].clone());for(e=1,s=this.quaternions.length-1;e<s;e++)n.push(this._quadrangle(this.quaternions[e-1],this.quaternions[e],this.quaternions[e+1]));n.push(this.quaternions[this.quaternions.length-1].clone()),this.quadrangles=n}},correctQuat:function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w<=0&&((t=t.set(-t.x,-t.y,-t.z,-t.w)).normalize(),!0===this.verbose&&s.log("correction quat00")),t},_slerpNoInvert:function(e,i,s){var n=s,o=new t.Quaternion,a=e.x,r=e.y,h=e.z,l=e.w,u=l*i.w+a*i.x+r*i.y+h*i.z;if(u<0||o.copy(i),u>=1)return o.w=l,o.x=a,o.y=r,o.z=h,o;var c=Math.acos(u),d=Math.sqrt(1-u*u);if(Math.abs(d)<.001)return o.w=.5*(l+o.w),o.x=.5*(a+o.x),o.y=.5*(r+o.y),o.z=.5*(h+o.z),o;var m=Math.sin((1-n)*c)/d,p=Math.sin(n*c)/d;return o.w=l*m+o.w*p,o.x=a*m+o.x*p,o.y=r*m+o.y*p,o.z=h*m+o.z*p,o.normalize()},slerpQuat:function(t,e,i){t.normalize(),e.normalize();var n=t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w;return n<=0&&((t=t.clone().set(-t.x,-t.y,-t.z,-t.w)).normalize(),n=t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w,!0===this.verbose&&s.log("correction quat")),this._slerpNoInvert(t.clone(),e.clone(),i).normalize()},_normalize:function(t){var e=0;for(e=0;e<t.length;e++)t[e]=t[e].normalize();for(e=t.length-1;e>0;e--)t[e-1]=this.correctQuat(t[e-1],t[e])},clone:function(){return new n(this.quaternions)},_add:function(e,i){return new t.Quaternion(e.x+i.x,e.y+i.y,e.z+i.z,e.w+i.w)},_factor:function(e,i){return new t.Quaternion(e*i.x,e*i.y,e*i.z,e*i.w)},_log:function(e){var i=Math.acos(e.w),s=Math.sin(i);if(0===s)return new t.Quaternion(0,0,0,0);var n=i/s;return new t.Quaternion(n*e.x,n*e.y,n*e.z,0)},_exp:function(e){var i=e.length();if(0===i)return new t.Quaternion(0,0,0,1);var s=Math.cos(i),n=Math.sin(i)/i;return new t.Quaternion(n*e.x,n*e.y,n*e.z,s)},_quadrangle:function(e,i,s){var n=i.clone().inverse();n.multiply(s);var o=i.clone().inverse();o.multiply(e);var a=this._factor(-.25,this._add(this._log(n),this._log(o)));return(new t.Quaternion).copy(i).multiply(this._exp(a)).normalize()},_squad:function(t,e,i,s,n){var o=this._slerpNoInvert(t,s,n),a=this._slerpNoInvert(e,i,n),r=2*n*(1-n);return this._slerpNoInvert(o,a,r)},squads:function(t){var e,n,o,a=this.quaternions,r=this.quadrangles;if(1===t)return this.quaternions[this.quaternions.length-1].clone();if(0===t)return this.quaternions[0].clone();n=t*(r.length-1),!0===this.extra&&(n=t*(r.length-3)+1),o=n-(e=Math.floor(n));var h=r[e],l=r[e+1],u=a[e],c=a[e+1],d=this._squad(u,h,l,c,o);return!0===this.verbose&&s.log(" squad "+e+" "+n+" "+t+i.displayVector(d)),d},getAt:function(t){var e=t;return this.squads(e)}});return n}),define("DS/UrbanManipulator/LocalisationManipulator",["DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","UWA/Class","DS/UrbanTool/Utils","DS/XCityTools/Debug"],function(t,e,i,s,n){"use strict";return i.singleton({init:function(){this.initialized=!1},Initialize:function(e){!1===this.initialized&&(this.shiftKey=!1,this.refX=new t.Vector3(1,0,0),this.refY=new t.Vector3(0,1,0),this.refZ=new t.Vector3(0,0,1),this.urban=e,this.position=new t.Vector3,this.target=new t.Vector3,this.up=new t.Vector3,this.eye=new t.Vector3,this.northAngle=0,this.verticalAngle=0,this.currentPan=new t.Vector2(0,0),this.currentRotate=new t.Vector2(0,0),this.currentZoom=new t.Vector2(0,0))},initEvents:function(){var t=this,i=function(i){t.mouseUp(i),s.is(t.mmoveToken)&&e.unsubscribe(t.mmoveToken),t.mmoveToken=null}.bind(t);e.subscribeToLeftMouseUp(i),e.subscribeToRightMouseUp(i),e.subscribeToMiddleMouseUp(i);var n=document.getElementById("boussole_circle_div"),o=document.getElementById("gui_pan_bg"),a=document.getElementById("gui_zoom_bg"),r=document.getElementById("gui_zoom_plus"),h=document.getElementById("gui_zoom_moins");r.onclick=t.zoomPlusClick.bind(t),h.onclick=t.zoomMoinsClick.bind(t),n.onclick=t.compassClick.bind(t),n.ondblclick=t.compassDblClick.bind(t);var l=function(i){t.verbose&&console.log("mousedown"),s.is(t.mmoveToken)&&(e.unsubscribe(t.mmoveToken),t.mmoveToken=null),t.rotateMouseDown(i),t.mmoveToken=e.subscribeToMouseMove(t.rotateMouseMove.bind(t))}.bind(t),u=function(e){t.verbose&&console.log("touchstart"),t.reset(),t.rotateMouseDown(e),n.ontouchmove=t.rotateMouseMove.bind(t)}.bind(t),c=function(e){t.verbose&&console.log("pointerdown"),t.reset(),t.rotateMouseDown(e),n.onpointermove=t.rotateMouseMove.bind(t)}.bind(t);n.onmousedown=l,n.ontouchstart=u,n.onpointerdown=c,n.onpointerup=t.touchEnd.bind(t),n.ontouchend=t.touchEnd.bind(t),o.onclick=t.panClick.bind(t);var d=function(i){s.is(t.mmoveToken)&&(e.unsubscribe(t.mmoveToken),t.mmoveToken=null),t.panMouseDown(i),t.mmoveToken=e.subscribeToMouseMove(t.panMouseMove.bind(t))}.bind(t),m=function(e){t.reset(),t.panMouseDown(e),o.ontouchmove=t.panMouseMove.bind(t)}.bind(t),p=function(e){t.reset(),t.panMouseDown(e),o.onpointermove=t.panMouseMove.bind(t)}.bind(t);o.onmousedown=d,o.ontouchstart=m,o.onpointerdown=p,o.onpointerup=t.touchEnd.bind(t),o.ontouchend=t.touchEnd.bind(t);var f=function(i){s.is(t.mmoveToken)&&(e.unsubscribe(t.mmoveToken),t.mmoveToken=null),t.zoomMouseDown(i),t.mmoveToken=e.subscribeToMouseMove(t.zoomMouseMove.bind(t)),a.onpointermove=t.zoomMouseMove.bind(t)}.bind(t),g=function(e){t.reset(),t.zoomMouseDown(e),a.ontouchmove=t.zoomMouseMove.bind(t)}.bind(t),v=function(e){t.reset(),t.zoomMouseDown(e),a.onpointermove=t.zoomMouseMove.bind(t)}.bind(t);a.onmousedown=f,a.ontouchstart=g,a.onpointerdown=v,a.onpointerup=t.touchEnd.bind(t),a.ontouchend=t.touchEnd.bind(t),this.initialized=!0},zoomEnable:function(t){if(this.initialized){var e="hidden";t&&(e="visible"),document.getElementById("gui_zoom_div").style.visibility=e}},panEnable:function(t){if(this.initialized){var e="hidden";t&&(e="visible"),document.getElementById("gui_pan_div").style.visibility=e}},rotateEnable:function(t){if(this.initialized){var e="hidden";t&&(e="visible"),document.getElementById("boussole_circle_div").style.visibility=e}},enableInterns:function(t){this.zoomEnable(t),this.panEnable(t),this.rotateEnable(t)},draw:function(){this.initialized&&(this.drawCompass(),this.drawPan(),this.drawRotate(),this.drawZoom())},set:function(t){this.up.copy(t.up),this.target.copy(t.target),this.position.copy(t.position)},getStandardizedUp:function(){var e=new t.Vector3(0,0,0);return e.add(this.up),e.z=0,e.normalize(),e},compassClick:function(t){this.rotateClickOff||this.urban.getControl().faceNorth()},compassDblClick:function(t){this.urban.getControl().faceVerticalNorth()},drawCompass:function(){if(this.initialized){var t=this.getStandardizedUp();this.eye.copy(this.target).sub(this.position);var e=t.x<0?1:-1,i=this.eye.z>0,n=s.cleandot(t,this.refY),o=Math.acos(n)*e;i&&(o=Math.PI+o),n=s.cleandot(this.eye.normalize().negate(),this.refZ);var a=Math.acos(n);if(a!==this.verticalAngle||o!==this.northAngle){this.northAngle=o,this.verticalAngle=a;var r=document.getElementById("boussole_arrow");if(null===r)return;var h=s.toDeg(this.northAngle);h%=360;var l=s.toDeg(this.verticalAngle);if(l%=360,l=Math.max(0,Math.min(l,90-this.urban.getControl().getParams().guiTiltMin)),r.style.msTransform="rotateX("+l+"deg) rotateZ("+h+"deg)  ",r.style.webkitTransform="rotateX("+l+"deg) rotateZ("+h+"deg) ",r.style.transform="rotateX("+l+"deg) rotateZ("+h+"deg) ",null===(r=document.getElementById("boussole_circle")))return;r.style.msTransform="rotateX("+l+"deg) ",r.style.webkitTransform=" rotateX("+l+"deg) ",r.style.transform="rotateX("+l+"deg) "}}},panClick:function(e){if(!this.panClickOff){var i=e.target.getBoundingClientRect(),s=e.clientX-i.left,n=e.clientY-i.top,o=new t.Vector2(s,n),a=new t.Vector2(.5*e.target.clientWidth,.5*e.target.clientHeight);o.sub(a),o.multiplyScalar(-this.urban.getControl().getParams().guiPanFactor*this.urban.getControl().getParams().manipulationSpeedFactor),!0===e.shiftKey?this.shiftKey=!0:this.shiftKey=!1,!0===this.shiftKey&&o.multiplyScalar(this.urban.getControl().getParams().manipulationShiftSpeedFactor),this.urban.getControl().pan2d(o)}},panMouseDown:function(e){this.pan=!1,this.panClickOff=!1,this.pan=!0,this.panOrigin=new t.Vector2(this.getEventX(e),this.getEventY(e))},panMouseMove:function(e){if(!0===this.pan){var i=this._getEvent(e);i.preventDefault(),i.stopPropagation();var s=new t.Vector2(this.getEventX(i),this.getEventY(i));s.sub(this.panOrigin),s.length()>0&&(s.multiplyScalar(-this.urban.getControl().getParams().guiPanHoldFactor*this.urban.getControl().getParams().manipulationSpeedFactor),!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,!0===this.shiftKey&&s.multiplyScalar(this.urban.getControl().getParams().manipulationShiftSpeedFactor),this.currentPan.copy(s),this.panClickOff=!0)}},rotateMouseDown:function(e){this.rotate=!1,this.rotateClickOff=!1,this.rotate=!0,this.rotateOrigin=new t.Vector2(this.getEventX(e),this.getEventY(e)),this.verbose&&console.log("rotateOrigin",this.rotateOrigin)},rotateMouseMove:function(e){if(!0===this.rotate){var i=this._getEvent(e);i.preventDefault(),i.stopPropagation();var s=new t.Vector2(this.getEventX(i),this.getEventY(i));this.verbose&&console.log("rotateMouseMove",e.type,s,e.offsetX,e.offsetY,e.movementX,e.movementY),s.sub(this.rotateOrigin),s.length()>0&&(s.multiplyScalar(-this.urban.getControl().getParams().guiRotateHoldFactor*this.urban.getControl().getParams().manipulationSpeedFactor),!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,!0===this.shiftKey&&s.multiplyScalar(this.urban.getControl().getParams().manipulationShiftSpeedFactor),this.currentRotate.copy(s),this.rotateClickOff=!0)}},zoomPlusClick:function(e){var i=new t.Vector2(0);i.y+=1,i.multiplyScalar(this.urban.getControl().getParams().guiZoomFactor*this.urban.getControl().getParams().manipulationSpeedFactor),!0===e.shiftKey?this.shiftKey=!0:this.shiftKey=!1,!0===this.shiftKey&&i.multiplyScalar(this.urban.getControl().getParams().manipulationShiftSpeedFactor),this.urban.getControl().zoom2d(i)},zoomMoinsClick:function(e){var i=new t.Vector2(0);i.y-=1,i.multiplyScalar(this.urban.getControl().getParams().guiZoomFactor*this.urban.getControl().getParams().manipulationSpeedFactor),!0===e.shiftKey?this.shiftKey=!0:this.shiftKey=!1,!0===this.shiftKey&&i.multiplyScalar(this.urban.getControl().getParams().manipulationShiftSpeedFactor),this.urban.getControl().zoom2d(i)},zoomMouseDown:function(e){this.zoom=!1,this.zoomClickOff=!1,this.zoom=!0,this.zoomOrigin=new t.Vector2(this.getEventX(e),this.getEventY(e))},zoomMouseMove:function(e){if(!0===this.zoom){var i=this._getEvent(e);i.preventDefault(),i.stopPropagation();var s=new t.Vector2(this.getEventX(i),this.getEventY(i));s.sub(this.zoomOrigin),s.length()>0&&(!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,this.currentZoom.copy(s),this.zoomClickOff=!0)}},reset:function(){if(this.verbose&&console.log("reset"),this.initialized){var t=document.getElementById("boussole_circle_div"),e=document.getElementById("gui_pan_bg"),i=document.getElementById("gui_zoom_bg");t.ontouchmove=null,t.onmousemove=null,t.onpointermove=null,e.ontouchmove=null,e.onmousemove=null,e.onpointermove=null,i.ontouchmove=null,i.onmousemove=null,i.onpointermove=null,this.pan=!1,this.rotate=!1,this.zoom=!1,this.currentPan.set(0,0),this.currentRotate.set(0,0),this.currentZoom.set(0,0),this.shiftKey=!1}},mouseUp:function(t){this.verbose&&console.log("mouseup"),this.reset()},touchEnd:function(){this.verbose&&console.log("touchend"),this.reset()},drawPan:function(){if(this.initialized){!0===this.pan&&this.urban.getControl().pan2d(this.currentPan);var e=document.getElementById("gui_pan_arrows");if(null!==e){var i=Math.abs(this.urban.getControl().getParams().guiPanVisualOffset),s=new t.Vector2(0,0);s.copy(this.currentPan),s.length()>i?s.multiplyScalar(-i/s.length()):s.multiplyScalar(-1);var n=s.x,o=s.y;e.style.msTransform="translate("+n+"px,"+o+"px) ",e.style.webkitTransform="translate("+n+"px,"+o+"px) ",e.style.transform="translate("+n+"px,"+o+"px) "}}},drawRotate:function(){this.initialized&&!0===this.rotate&&this.urban.getControl().rotate2d(this.currentRotate)},drawZoom:function(){if(this.initialized){if(!0===this.zoom){var e=new t.Vector2(0,0);e.copy(this.currentZoom),e.multiplyScalar(-this.urban.getControl().getParams().guiZoomHoldFactor*this.urban.getControl().getParams().manipulationSpeedFactor),!0===this.shiftKey&&e.multiplyScalar(this.urban.getControl().getParams().manipulationShiftSpeedFactor),this.urban.getControl().zoom2d(e)}var i=document.getElementById("gui_zoom_slider");if(null!==i){var s=document.getElementById("gui_zoom_bg").clientHeight,n=i.clientHeight,o=Math.max(.5*s-.5*n,0);o+=Math.max(this.urban.getControl().getParams().guiZoomVisualOffset,0);var a=Math.min(o,Math.max(this.currentZoom.y,-o));i.style.msTransform="translate(0px,"+a+"px) ",i.style.webkitTransform=" translate(0px,"+a+"px) ",i.style.transform="translate(0px,"+a+"px) "}}},_getEvent:function(t){if(s.is(t.gesture)){var e=t.gesture.getEvents();if(s.is(e)&&e.length>0)return e[0].event}return t},getEventX:function(t){return s.is(t.touches)?t.touches[0].clientX:t.clientX},getEventY:function(t){return s.is(t.touches)?t.touches[0].clientY:t.clientY}})}),define("DS/UrbanManipulator/LayerAnimation",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/Animation/PropertyAnimation","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/Animation/AnimationPath"],function(t,e,i,s,n,o){"use strict";return e.extend({init:function(t){this.layerId=t.layerId,this.layerName=t.layerName,this.timeline=t.timeline;var e=new o(t.start,t.end,1e3*t.duration);this.currentPath=e,this.updateCalls=0,this.animation=new i(this,"updateTime",e),this.runOnce=!0,this.stopped=!1,this.verbose=!1},setOptions:function(t){this.layerId=t.layerId,this.layerName=t.layerName,this.timeline=t.timeline;var e=new o(t.start,t.end,1e3*t.duration);this.currentPath=e,this.updateCalls=0,this.animation=new i(this,"updateTime",e)},getKeyframes:function(){return this.currentPath.getKeyframes()},getCurrentKeyframe:function(){return this.currentPath.getCurrentKeyframe()},applyKeyframe:function(t){if(s.is(this._layer)||(this._layer=xCity.findItem({id:this.layerId})),s.is(this._layer)||(this._layer=xCity.findItem({name:this.layerName})),s.is(this._layer)){var e=this._layer.get("renderID"),i=Math.round(t);e!==i&&this._layer.set("renderID",i)}},updateTime:function(t){!0===this.verbose&&n.log(t),this.animationTime=t,this.applyKeyframe(t),this.updateCalls++},setPath:function(t){this.stop(),this.currentPath=t,this.animation.setPath(this.currentPath)},start:function(){this.updateCalls=0,this.lastStartTime=window.performance.now(),this.animation.start()},pause:function(){0===this.animation.state()&&this.animation.pause()},play:function(){this.stopped=!1,2===this.animation.state()?this.resume():this.start()},resume:function(){2===this.animation.state()&&this.animation.resume()},displayRuntime:function(){!0===this.verbose&&(n.log(" runtime "+this.lastRuntime),n.log(" calls "+this.updateCalls),n.log(" avg fps "+this.updateCalls/(this.lastRuntime/1e3)))},stop:function(){this.animation.stop(),this.lastRuntime=window.performance.now()-this.lastStartTime,this.displayRuntime()},isDone:function(){return!s.is(this.animation.state())||1===this.animation.state()},getKeyframe:function(t){return s.is(this.currentPath)?this.currentPath.getKeyframe(t):null},setKeyframe:function(t,e){return s.is(this.currentPath)?this.currentPath.setKeyframe(t,e):null},addKeyframe:function(t,e){return s.is(this.currentPath)?this.currentPath.addKeyframe(t,e):null},removeKeyframe:function(t){return s.is(this.currentPath)?this.currentPath.removeKeyframe(t):null},duration:function(){return s.is(this.currentPath)?this.currentPath.duration():0},size:function(){return s.is(this.currentPath)&s.is(this.currentPath.keyframes)?this.currentPath.keyframes.length:0},setTime:function(t){return t<=0?(this.animation.setTime(t),this.animation.stop()):(this.animation.start(),this.animation.pause(),this.animation.setTime(t)),this.animation.time()},_setFastTime:function(t){this.animation.setTime(t)},setFrame:function(t,e){var i=(t-1)/e*1e3;return i=Math.max(0,i),this.setTime(i),this.animation.time()===i},goToKeyframe:function(t){var e=this.getKeyframe(t);return s.is(e)?(this.setTime(e.time),e):null},isRunning:function(){return!0!==this.stopped&&(this.isPlaying()||(this.stopped=!0),!0)},isPlaying:function(){return 0===this.animation.state()}})}),define("DS/UrbanManipulator/AnimationPath",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/Animation/PropertyAnimation","DS/Animation/AnimationPath","DS/UrbanManipulator/Keyframe","DS/UrbanTool/Utils","DS/UrbanManipulator/QuaternionSpline","DS/XCityTools/Debug"],function(t,e,i,s,n,o,a,r){"use strict";return e.extend({init:function(t){var e;for(e in this.verbose=null,this.spheric=!1,this.speedAdjust=!0,this.splineInterpolate=!0,this.keyframes=[],this.currentKeyframe=null,this.lastKeyframeIndex=-1,this.valuation=0,t)t.hasOwnProperty(e)&&(this[e]=t[e])},duration:function(){return this.keyframes.length>0?this.keyframes[this.keyframes.length-1].time-this.keyframes[0].time:0},valueAt:function(t){return this.valuation++,this.updateKeyframeIndex(t),t},reset:function(){this.start=0,this.end=this.start,this.keyframes.length>0&&(this.start=this.keyframes[0].time,this.end=this.keyframes[this.keyframes.length-1].time),this.removeSplines()},addKeyframe:function(t,e){!o.is(e)||e<0||e>=this.keyframes.length?this.keyframes[this.keyframes.length]=t:this.keyframes.splice(e,0,t),this.reset()},removeKeyframe:function(t){!o.is(t)||t<0||t>=this.keyframes.length||(this.keyframes.splice(t,1),this.reset())},setKeyframe:function(t,e){return o.is(t)?e<0?null:e>=this.keyframes.length?null:(this.keyframes[e]=t,void this.reset()):null},getKeyframes:function(){var t=0,e=[];for(t=0;t<this.keyframes.length;t++)e[t]=this.keyframes[t].clone();return e},getKeyframe:function(t){return t<0?null:t>=this.keyframes.length?null:this.keyframes[t].clone()},removeSplines:function(){this.currentPositionSpline=null,this.currentTimeSpline=null,this.currentQuaternionSpline=null,this.currentTargetSpline=null,this.dateSpline=null},createAndAddKeyframe:function(t){var e=new n(t);this.addKeyframe(e)},getCurrentKeyframe:function(){if(this.keyframes.length<=1)return null;if(!o.is(this.lastKeyframeIndex))return r.log(" inconsistent time path"),null;o.is(this.currentPositionSpline)||this.initSplines();var t=Math.floor(this.lastKeyframeIndex),e=Math.ceil(this.lastKeyframeIndex);if(t<0||e>=this.keyframes.length)return null;var i=this.lastKeyframeIndex-Math.floor(this.lastKeyframeIndex);o.is(this.curving)&&(i=this.curving(i));var s=this.keyframes[t],n=this.keyframes[e];return!0===this.verbose&&r.log("time "+this.currentTime+" "+this.lastKeyframeIndex+" "+t+" "+e+" "+i),this.interpol(s,n,i)},interpolPosition:function(e,i){var s,n,o,a;s=Math.floor(e),n=Math.min(s+1,this.keyframes.length-1),a=Math.min(n+1,this.keyframes.length-1),o=Math.max(s-1,0),s=this.frameToSpline[s],n=this.frameToSpline[n],o=this.frameToSpline[o],a=this.frameToSpline[a];var r=[];r[0]=this.keyframes[o].position.clone(),r[1]=this.keyframes[s].position.clone(),r[2]=this.keyframes[n].position.clone(),r[3]=this.keyframes[a].position.clone();var h=r[0].clone(),l=r[1].distanceTo(r[2]),u=.5*r[0].distanceTo(r[1]);if(u>l){var c=l/u;h=r[1].clone().add(r[0].clone().sub(r[1]).multiplyScalar(c))}var d=r[3].clone(),m=.5*r[3].distanceTo(r[2]);if(m>l){c=l/m;d=r[2].clone().add(r[3].clone().sub(r[2]).multiplyScalar(c))}r[0]=h,r[3]=d;var p=new t.Vector3,f=i;return p.x=t.Curve.Utils.interpolate(r[0].x,r[1].x,r[2].x,r[3].x,f),p.y=t.Curve.Utils.interpolate(r[0].y,r[1].y,r[2].y,r[3].y,f),p.z=t.Curve.Utils.interpolate(r[0].z,r[1].z,r[2].z,r[3].z,f),p},interpolQuaternion:function(t,e){var i,s,n,o;i=Math.floor(t),s=Math.min(i+1,this.keyframes.length-1),o=Math.min(s+1,this.keyframes.length-1),n=Math.max(i-1,0);var r=new a([]),h=this.keyframes[i].getQuaternion(),l=this.keyframes[s].getQuaternion(),u=this.keyframes[n].getQuaternion(),c=this.keyframes[o].getQuaternion();return u=r._quadrangle(u,h,l),c=r._quadrangle(h,l,c),r._squad(h,u,c,l,e)},interpol:function(t,e,i){var s=null;if(!0===this.splineInterpolate){var n=0;if(this.lastKeyframeIndex>=this.keyframes.length-1)n=1;else{var a=this.frameToSpline[Math.floor(this.lastKeyframeIndex)],h=this.frameToSpline[Math.floor(this.lastKeyframeIndex)+1];if((l=this.positions.length-1)>0)n=(a/=l)+((h/=l)-a)*(this.lastKeyframeIndex-Math.floor(this.lastKeyframeIndex));else n=0}s=t.interpol(e,i,this.currentPositionSpline.getPoint(n));if(this.lastKeyframeIndex>=this.keyframes.length-1)1;else{var l;a=this.quatToSpline[Math.floor(this.lastKeyframeIndex)],h=this.quatToSpline[Math.floor(this.lastKeyframeIndex)+1];if((l=this.quats.length-1)>0)(a/=l)+((h/=l)-a)*(this.lastKeyframeIndex-Math.floor(this.lastKeyframeIndex));else 0}if(!0===this.verbose&&r.log(" quat "+n+"  "+o.displayVector(this.keyframes[Math.floor(this.lastKeyframeIndex)].quaternion)+"  "+o.displayVector(s.quaternion)),o.is(this.dateSpline)){var u=Math.floor(this.lastKeyframeIndex),c=Math.min(this.keyframes.length-1,u+1);s.date=s.lerpTime(this.dateSpline[u],this.dateSpline[c],i)}}else s=t.interpol(e,i);return!0===this.verbose&&r.log(s._up.x+" "+s._up.y+" "+s._up.z," "+s.position.length()),s},fadein:function(t){return 1-Math.cos(t*Math.PI/2)},fadeout:function(t){return Math.sin(t*Math.PI/2)},fadeinout:function(t){return.5*(1-Math.cos(Math.PI*t))},easing:function(t,e){var i=t;return 2===this.keyframes.length?i=this.fadeinout(this.fadeinout(t)):0===e?i=this.fadein(this.fadein(t)):e>=this.keyframes.length-2&&(i=this.fadeout(this.fadeout(t))),i=Math.max(0,i),i=Math.min(1,i)},updateKeyframeIndex:function(t){if(o.is(this.keyframes))if(this.lasttime=this.currentTime,this.currentTime=t,this.keyframes.length<=1)this.lastKeyframeIndex=0;else if(0!==t){o.is(this.currentTimeSpline)||this.initSplines();var e=0;for(e=0;e<this.keyframes.length&&!(this.keyframes[e].time>=t);e++);if(e>=this.keyframes.length)return!0===this.verbose&&r.log("time superior to end of path !"),void(this.lastKeyframeIndex=this.keyframes.length-1);var i=Math.max(e-1,0),s=this.keyframes[e].time-this.keyframes[i].time,n=t-this.keyframes[i].time;if(0===s)return!0===this.verbose&&r.log("2 keyframes for a same time "),void(this.lastKeyframeIndex=null);n/=s,!1===this.verbose&&r.log((t-this.lasttime)/(i+n-this.lastKeyframeIndex)+" ");var a=this.easing(n,i);this.lastKeyframeIndex=i+a}else this.lastKeyframeIndex=0},getPositionSpline:function(){return o.is(this.currentPositionSpline)||this.initSplines(),this.currentPositionSpline},initSplines:function(){if(!(this.keyframes.length<=1)){var e,i,s=[],n=[],h=0,l=0,u=0,c=0,d=0;this.frameToSpline=[],this.quatToSpline=[];var m=[],p=[],f=[],g=[],v=[],y=[];for(e=0;e<this.keyframes.length;e++){if(!0===this.fadeRotation&&(this.keyframes[e].fadeOn=!0),!0===this.targetInterpol&&!o.is(this.keyframes[e]._target)){var b=this.keyframes[e]._eye.clone().setLength(this.keyframes[e].position.z);this.keyframes[e]._target=this.keyframes[e].position.clone().add(b)}this.keyframes[e].time<d&&r.log(" error Time is not strictly increasing in the path "),o.is(s[h-1])&&this.keyframes[e].position.equals(s[h-1])||(s[h]=this.keyframes[e].position.clone(),p[h]=s[h].clone(),p[h].z=s[h].length(),h++),this.frameToSpline[e]=h-1,i=this.keyframes[e].time-d,v[e]=i/this.end,n[e]=new t.Vector3(this.keyframes[e].time/this.end,e,i/this.end),d=this.keyframes[e].time,o.is(this.keyframes[e].date)&&(y[c]=e,c++),f[e]=new t.Vector2(this.keyframes[e].time/this.end,e/(this.keyframes.length-1));var S=this.keyframes[e].target;o.is(S)&&(g[l]=S,l++),o.is(m[u-1])&&this.keyframes[e].quaternion.equals(m[u-1])||(m[u]=this.keyframes[e].quaternion.clone(),u++),this.quatToSpline[e]=u-1}!0===this.bezierSpline?(this.currentPositionSpline=new t.CubicBezierCurve3(s[0],s[1],s[2],s[3]),this.keyframes[1].position=this.currentPositionSpline.getPoint(1/3),this.keyframes[2].position=this.currentPositionSpline.getPoint(2/3),this.keyframes[1].initQuat2(),this.keyframes[2].initQuat2()):this.currentPositionSpline=new t.SplineCurve3(s),this.positions=s,g.length===this.keyframes.length&&(this.currentTargetSpline=new t.SplineCurve3(g)),this.currentAtitudeSpline=new t.SplineCurve3(p),this.currenttestspline=new t.SplineCurve(f);var _=s.length-1;for(e=0;e<this.keyframes.length;e++)_<=0&&(this.frameToSpline[e]=0);this.currentTimeSpline=n,this.quats=m,this.currentQuaternionSpline=new a(m)}},timeAdjust:function(){}})}),define("DS/UrbanManipulator/Localisator",["UWA/Core","UWA/Class","DS/UrbanManipulator/LocalisationManipulator"],function(t,e,i){"use strict";return e.extend({init:function(e,i){this.container=t.createElement("div",{id:"Boussole"}),this.container.inject(e),this.container.control=this;var s=this.container.ownerDocument,n=s.createDocumentFragment(),o=this.create(s);n.appendChild(o),this.container.appendChild(n);var a=s.createElement("div");a.id="target_div",e.appendChild(a),this.targetDiv=a},create:function(t){var e=t.createElement("div");e.id="Urbanlocalisator",e.style["touch-action"]="none";var i=t.createElement("div");i.id="boussole_circle_div",e.appendChild(i);var s=t.createElement("div");s.id="boussole_circle",i.appendChild(s);var n=t.createElement("div");n.id="boussole_arrow",i.appendChild(n);var o=t.createElement("div");o.id="gui_pan_div",e.appendChild(o);var a=t.createElement("div");a.id="gui_pan_bg",o.appendChild(a);var r=t.createElement("div");r.id="gui_pan_arrows",a.appendChild(r);var h=t.createElement("div");h.id="gui_zoom_div",e.appendChild(h);var l=t.createElement("div");l.id="gui_zoom_bg",h.appendChild(l);var u=t.createElement("div");u.id="gui_zoom_slider",l.appendChild(u);var c=t.createElement("div");c.id="gui_slider_icon",c.className="fonticon fonticon-search",u.appendChild(c);var d=t.createElement("div");d.id="gui_zoom_plus",h.appendChild(d);var m=t.createElement("div");return m.id="gui_zoom_moins",h.appendChild(m),e},bindEvents:function(){i&&i.initEvents()},hide:function(){this._visibleFlag=!1,this.container.hide()},show:function(){this._visibleFlag=!0,this.container.show()},setAlignment:function(t){var e,i=["top","bottom","left","right"];for(e=0;e<i.length;e++)this.container.classList.contains(i[e])&&this.container.classList.remove(i[e]);this._alignment=t,this.container.classList.add(t)},getAlignment:function(){return this._alignment},getVisibility:function(){return this._visibleFlag}})}),define("DS/UrbanManipulator/CameraAnimationPath",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/Animation/PropertyAnimation","DS/Animation/AnimationPath","DS/UrbanManipulator/Keyframe","DS/UrbanTool/Utils","DS/UrbanManipulator/QuaternionSpline","DS/XCityTools/Debug"],function(t,e,i,s,n,o,a,r){"use strict";return e.extend({init:function(t){var e;for(e in this.verbose=null,this.spheric=!1,this.speedAdjust=!0,this.splineInterpolate=!0,this.keyframes=[],this.currentKeyframe=null,this.lastKeyframeIndex=-1,this.valuation=0,t)t.hasOwnProperty(e)&&(this[e]=t[e])},duration:function(){return this.keyframes.length>0?this.keyframes[this.keyframes.length-1].time-this.keyframes[0].time:0},valueAt:function(t){return this.valuation++,this.updateKeyframeIndex(t),t},reset:function(){this.start=0,this.end=this.start,this.keyframes.length>0&&(this.start=this.keyframes[0].time,this.end=this.keyframes[this.keyframes.length-1].time),this.removeSplines()},addKeyframe:function(t,e){!o.is(e)||e<0||e>=this.keyframes.length?this.keyframes[this.keyframes.length]=t:this.keyframes.splice(e,0,t),this.reset()},removeKeyframe:function(t){!o.is(t)||t<0||t>=this.keyframes.length||(this.keyframes.splice(t,1),this.reset())},setKeyframe:function(t,e){return o.is(t)?e<0?null:e>=this.keyframes.length?null:(this.keyframes[e]=t,void this.reset()):null},getKeyframes:function(){var t=0,e=[];for(t=0;t<this.keyframes.length;t++)e[t]=this.keyframes[t].clone();return e},getKeyframe:function(t){return t<0?null:t>=this.keyframes.length?null:this.keyframes[t].clone()},removeSplines:function(){this.currentPositionSpline=null,this.currentTimeSpline=null,this.currentQuaternionSpline=null,this.currentTargetSpline=null,this.dateSpline=null},createAndAddKeyframe:function(t){var e=new n(t);this.addKeyframe(e)},getCurrentKeyframe:function(){if(this.keyframes.length<=1)return null;if(!o.is(this.lastKeyframeIndex))return r.log(" inconsistent time path"),null;o.is(this.currentPositionSpline)||this.initSplines();var t=Math.floor(this.lastKeyframeIndex),e=Math.ceil(this.lastKeyframeIndex);if(t<0||e>=this.keyframes.length)return null;var i=this.lastKeyframeIndex-Math.floor(this.lastKeyframeIndex);o.is(this.curving)&&(i=this.curving(i));var s=this.keyframes[t],n=this.keyframes[e];return!0===this.verbose&&r.log("time "+this.currentTime+" "+this.lastKeyframeIndex+" "+t+" "+e+" "+i),this.interpol(s,n,i)},interpolPosition:function(e,i){var s,n,o,a;s=Math.floor(e),n=Math.min(s+1,this.keyframes.length-1),a=Math.min(n+1,this.keyframes.length-1),o=Math.max(s-1,0),s=this.frameToSpline[s],n=this.frameToSpline[n],o=this.frameToSpline[o],a=this.frameToSpline[a];var r=[];r[0]=this.keyframes[o].position.clone(),r[1]=this.keyframes[s].position.clone(),r[2]=this.keyframes[n].position.clone(),r[3]=this.keyframes[a].position.clone();var h=r[0].clone(),l=r[1].distanceTo(r[2]),u=.5*r[0].distanceTo(r[1]);if(u>l){var c=l/u;h=r[1].clone().add(r[0].clone().sub(r[1]).multiplyScalar(c))}var d=r[3].clone(),m=.5*r[3].distanceTo(r[2]);if(m>l){c=l/m;d=r[2].clone().add(r[3].clone().sub(r[2]).multiplyScalar(c))}r[0]=h,r[3]=d;var p=new t.Vector3,f=i;return p.x=t.Curve.Utils.interpolate(r[0].x,r[1].x,r[2].x,r[3].x,f),p.y=t.Curve.Utils.interpolate(r[0].y,r[1].y,r[2].y,r[3].y,f),p.z=t.Curve.Utils.interpolate(r[0].z,r[1].z,r[2].z,r[3].z,f),p},interpolQuaternion:function(t,e){var i,s,n,o;i=Math.floor(t),s=Math.min(i+1,this.keyframes.length-1),o=Math.min(s+1,this.keyframes.length-1),n=Math.max(i-1,0);var r=new a([]),h=this.keyframes[i].getQuaternion(),l=this.keyframes[s].getQuaternion(),u=this.keyframes[n].getQuaternion(),c=this.keyframes[o].getQuaternion();return u=r._quadrangle(u,h,l),c=r._quadrangle(h,l,c),r._squad(h,u,c,l,e)},interpol:function(t,e,i){var s=null;if(!0===this.splineInterpolate){var n=0;if(this.lastKeyframeIndex>=this.keyframes.length-1)n=1;else{var a=this.frameToSpline[Math.floor(this.lastKeyframeIndex)],h=this.frameToSpline[Math.floor(this.lastKeyframeIndex)+1];if((l=this.positions.length-1)>0)n=(a/=l)+((h/=l)-a)*(this.lastKeyframeIndex-Math.floor(this.lastKeyframeIndex));else n=0}s=t.interpol(e,i,this.currentPositionSpline.getPoint(n));if(this.lastKeyframeIndex>=this.keyframes.length-1)1;else{var l;a=this.quatToSpline[Math.floor(this.lastKeyframeIndex)],h=this.quatToSpline[Math.floor(this.lastKeyframeIndex)+1];if((l=this.quats.length-1)>0)(a/=l)+((h/=l)-a)*(this.lastKeyframeIndex-Math.floor(this.lastKeyframeIndex));else 0}if(!0===this.verbose&&r.log(" quat "+n+"  "+o.displayVector(this.keyframes[Math.floor(this.lastKeyframeIndex)].quaternion)+"  "+o.displayVector(s.quaternion)),o.is(this.dateSpline)){var u=Math.floor(this.lastKeyframeIndex),c=Math.min(this.keyframes.length-1,u+1);s.date=s.lerpTime(this.dateSpline[u],this.dateSpline[c],i)}}else s=t.interpol(e,i);return!0===this.verbose&&r.log(s._up.x+" "+s._up.y+" "+s._up.z," "+s.position.length()),s},fadein:function(t){return 1-Math.cos(t*Math.PI/2)},fadeout:function(t){return Math.sin(t*Math.PI/2)},fadeinout:function(t){return.5*(1-Math.cos(Math.PI*t))},easing:function(t,e){var i=t;return 2===this.keyframes.length?i=this.fadeinout(this.fadeinout(t)):0===e?i=this.fadein(this.fadein(t)):e>=this.keyframes.length-2&&(i=this.fadeout(this.fadeout(t))),i=Math.max(0,i),i=Math.min(1,i)},updateKeyframeIndex:function(t){if(o.is(this.keyframes))if(this.lasttime=this.currentTime,this.currentTime=t,this.keyframes.length<=1)this.lastKeyframeIndex=0;else if(0!==t){o.is(this.currentTimeSpline)||this.initSplines();var e=0;for(e=0;e<this.keyframes.length&&!(this.keyframes[e].time>=t);e++);if(e>=this.keyframes.length)return!0===this.verbose&&r.log("time superior to end of path !"),void(this.lastKeyframeIndex=this.keyframes.length-1);var i=Math.max(e-1,0),s=this.keyframes[e].time-this.keyframes[i].time,n=t-this.keyframes[i].time;if(0===s)return!0===this.verbose&&r.log("2 keyframes for a same time "),void(this.lastKeyframeIndex=null);n/=s,!1===this.verbose&&r.log((t-this.lasttime)/(i+n-this.lastKeyframeIndex)+" ");var a=this.easing(n,i);this.lastKeyframeIndex=i+a}else this.lastKeyframeIndex=0},getPositionSpline:function(){return o.is(this.currentPositionSpline)||this.initSplines(),this.currentPositionSpline},initSplines:function(){if(!(this.keyframes.length<=1)){var e,i,s=[],n=[],h=0,l=0,u=0,c=0,d=0;this.frameToSpline=[],this.quatToSpline=[];var m=[],p=[],f=[],g=[],v=[],y=[];for(e=0;e<this.keyframes.length;e++){if(!0===this.fadeRotation&&(this.keyframes[e].fadeOn=!0),!0===this.targetInterpol&&!o.is(this.keyframes[e]._target)){var b=this.keyframes[e]._eye.clone().setLength(this.keyframes[e].position.z);this.keyframes[e]._target=this.keyframes[e].position.clone().add(b)}this.keyframes[e].time<d&&r.log(" error Time is not strictly increasing in the path "),o.is(s[h-1])&&this.keyframes[e].position.equals(s[h-1])||(s[h]=this.keyframes[e].position.clone(),p[h]=s[h].clone(),p[h].z=s[h].length(),h++),this.frameToSpline[e]=h-1,i=this.keyframes[e].time-d,v[e]=i/this.end,n[e]=new t.Vector3(this.keyframes[e].time/this.end,e,i/this.end),d=this.keyframes[e].time,o.is(this.keyframes[e].date)&&(y[c]=e,c++),f[e]=new t.Vector2(this.keyframes[e].time/this.end,e/(this.keyframes.length-1));var S=this.keyframes[e].target;o.is(S)&&(g[l]=S,l++),o.is(m[u-1])&&this.keyframes[e].quaternion.equals(m[u-1])||(m[u]=this.keyframes[e].quaternion.clone(),u++),this.quatToSpline[e]=u-1}!0===this.bezierSpline?(this.currentPositionSpline=new t.CubicBezierCurve3(s[0],s[1],s[2],s[3]),this.keyframes[1].position=this.currentPositionSpline.getPoint(1/3),this.keyframes[2].position=this.currentPositionSpline.getPoint(2/3),this.keyframes[1].initQuat2(),this.keyframes[2].initQuat2()):this.currentPositionSpline=new t.SplineCurve3(s),this.positions=s,g.length===this.keyframes.length&&(this.currentTargetSpline=new t.SplineCurve3(g)),this.currentAtitudeSpline=new t.SplineCurve3(p),this.currenttestspline=new t.SplineCurve(f);var _=s.length-1;for(e=0;e<this.keyframes.length;e++)_<=0&&(this.frameToSpline[e]=0);this.currentTimeSpline=n,this.quats=m,this.currentQuaternionSpline=new a(m)}},timeAdjust:function(){}})}),define("DS/UrbanManipulator/Manipulator",["UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","DS/UrbanManipulator/ManipulatorParams","DS/UrbanManipulator/LocalisationManipulator","DS/UrbanManipulator/CameraAnimation","DS/UrbanManipulator/CameraAnimationPath","DS/UrbanManipulator/Keyframe","UWA/Class","DS/UrbanTool/Utils","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Debug","DS/WebappsUtils/WebappsUtils","DS/Visualization/PathElement","DS/XCityTools/Geocoder","DS/XCityModel/LayerVectorCluster"],function(t,e,i,s,n,o,a,r,h,l,u,c,d,m,p,f,g){"use strict";return h.extend(t,{init:function(t,i,n,o){if(this.urban=t,this.domElement=n,this.viewpoint=i,l.is(o)?this.params=o:this.params=new s,this.firstcall=!0,this.still=-1,this.lastPosition=null,this.currentSpeed=null,this.enabled=!0,this.checkH=!1,this.temp2=new e.Vector2,this.temp3=new e.Vector3,this.vertical=new e.Vector3(0,0,1),this.position=new e.Vector3,this.target=new e.Vector3,this.up=new e.Vector3,this.eye=new e.Vector3,this.distanceToTarget=19e3,this.currentQuaternion=new e.Quaternion,this.orientation=new e.Quaternion,this.currenteye=new e.Vector3,this.currentup=new e.Vector3,this._currentDir=new e.Vector3,this.dir=[],this.lastRotation=new e.Vector2,l.is(i.initQuaternion))this.position=i.camera.position,this.currentQuaternion=i.initQuaternion.clone(),this.updateBase(),this.target.copy(this.position),this.eye.setLength(this.getAltitude()),this.target.add(this.eye),this.eye.normalize(),this.updateViewpoint();else{this.currenteye.copy(i.target).sub(i.camera.position);var a=l.getQuaternionBetween(l.refX.clone(),this.currenteye);l.is(a)&&(this.currentQuaternion=a,this.updateBase())}this.terrainHeight=0,this.currentState=this.params.STATE.NONE,this.prevState=this.params.STATE.NONE,this.screen={width:0,height:0,offsetLeft:0,offsetTop:0},this.radius=(this.screen.width+this.screen.height)/4,this.mouseChange=new e.Vector2(0,0),this.lastX=0,this.lastY=0,this.currentX=0,this.currentY=0,this.currentPan=new e.Vector2,this.lastPan=new e.Vector2,this.zoomStart=new e.Vector2,this.zoomEnd=new e.Vector2,this.zoomMouse=new e.Vector2,this.heightOffset=0,this.targetDisplayed=!1,this._lastTarget=new e.Vector3,this._lastPos=new e.Vector3,this.currentKeyOffset=new e.Vector2,this.currentKeyAngle=new e.Vector2,this.currentKeyZoom=new e.Vector2,this.touchZoomDistanceStart=0,this.touchZoomDistanceEnd=0,this.startTouch=0,this.debug=!1,this.debugPicking=!1,this.debugPicking2=!1,this.debugMoveTo=!1,this.verbose=null,l.is(this.verbose)&&(this.lastMove=""),this.paths={},this.openedAnimation=null,this.buttonDown=0,this.openedKeyframe={index:-1,time:-1},this._updateFromKeyframe=!1,this.timetoFps=.025,this.movelength=0,this.moverotX=0,this.moverotY=0,this.movelapse=0,this.dampingDistance=0,this.dampingAngleX=0,this.dampingAngleY=0,this.topSpeed=0;var r=this.urban.url.getArgument("moveto");l.is(r)&&"1"===r.value&&this.debugMove(),this.type="default",this.zeroish=1e-6,this.epsilon=.001,this.dampingRotateMin=.005,this.zoomtouchfactor=.001,this.timeToOffset=62.5,this.minZoomDistance=.5,this.mountainHeight=700,this.groundMaxAlt=8848,this.touchZoomStartFactor=1.15,this.defaulttimebetweenkeys=2e3,this._lastPick=new e.Vector3},setActive:function(t){t.viewpoint?this.activate({noAnimationOnActivation:!0}):this.deactivate()},setVerbose:function(t){l.is(t)&&t?(this.verbose=t,this.lastMove=""):(this.verbose=null,this.lastMove=null)},_getWorldSize:function(){var t=this.urban.worldSize;return(!l.is(t)||t<=0)&&(t=1/0),t},activate:function(t){if(this.enabled=!0,!0===this.verbose&&d.log(" activate default manip"),this.resetMove(),this.askedmove=null,this.askedmovepos=null,this.initEvents(),!(this.firstcall||this.params.noAnimationOnActivation||l.is(t)&&l.is(t.noAnimationOnActivation))){var i=new e.Vector3(0,.5,-.5);this.moveTo3(this.target,this.params.defaultDistanceOnActivation,i,this.params.manipTransitionDuration)}n.enableInterns(!0)},deactivate:function(t){this.enabled=!1,!0===this.verbose&&d.log(" de activate manip "+this.type)},updateBase:function(){this.currentQuaternion.normalize(),this.currenteye.copy(l.refX),this.currenteye.applyQuaternion(this.currentQuaternion),this.eye.copy(this.currenteye),this.currentup.copy(l.refZ),this.currentup.applyQuaternion(this.currentQuaternion),this.up.copy(this.currentup)},initEvents:function(){if(!0!==this._initialized){i.Initialize(this.domElement),n.Initialize(this.urban),this.domElement.addEventListener("contextmenu",function(t){t.preventDefault()});var t=this;this.changeEvent={type:"change"},this.rotatemoveToken=void 0,this.mmoveToken=void 0;var e=function(e){if(!1===t.enabled)return!1;l.is(t.mmoveToken)&&(i.unsubscribe(t.mmoveToken),t.mmoveToken=null),t.mousedown(e),t.mmoveToken=i.subscribeToMouseMove(t.mousemove.bind(t))}.bind(t),s=function(e){if(!1===t.enabled)return!1;t.mouseup(e),l.is(t.mmoveToken)&&i.unsubscribe(t.mmoveToken),t.mmoveToken=null}.bind(t);this.unmin=function(e){t.unminimize(e)},i.subscribeToLeftMouseDown(e),i.subscribeToRightMouseDown(e),i.subscribeToMiddleMouseDown(e),i.subscribeToLeftMouseUp(s),i.subscribeToRightMouseUp(s),i.subscribeToMiddleMouseUp(s),i.subscribeToMouseWheel(this.mousewheel.bind(this)),i.subscribeTo("/VISU/onTouch",this.touchstart.bind(this)),i.subscribeTo("/VISU/onPinch",this.touchmove.bind(this)),i.subscribeTo("/VISU/onPan",this.touchmove.bind(this)),i.subscribeTo("/VISU/onRotate",this.touchmove.bind(this)),i.subscribeTo("/VISU/onPinchPanRotate",this.touchmove.bind(this)),i.subscribeTo("/VISU/onSwipe",this.touchmove.bind(this)),i.subscribeToRelease(this.touchend.bind(this));i.subscribeTo("/VISU/onDoubleTap",this.doubleClick.bind(this));i.subscribeTo("/VISU/onLeftDoubleClick",this.doubleClick.bind(this)),i.subscribeTo("/VISU/onRightDoubleClick",this.doubleClick.bind(this)),i.subscribeTo("/VISU/onKeyDown",this.keydown.bind(this)),i.subscribeTo("/VISU/onKeyUp",this.keyup.bind(this)),this.domElement.onkeypress=function(){d.log("keypress baaby")},i.subscribeTo("/VISU/onMiddleClick",this.centerTarget.bind(this)),i.subscribeTo("/VISU/onMiddleDoubleClick",this.testFunction.bind(this));i.subscribeTo("/VISU/onLeftClick",function(e){l.is(e)&&l.is(e.from)&&l.is(e.from[0])&&l.is(e.from[0].view)&&l.is(e.from[0].view.classList)&&l.is(e.from[0].view.classList[0])&&("POIText"!==e.from[0].view.classList[0]&&"annotationStyle"!==e.from[0].view.classList[0]||t._lastPick.copy(xCity.findItem({id:e.from[0].view.dataModelID}).get("position")),"PoiSpan"!==e.from[0].view.classList[0]&&"annotationStyleSpan"!==e.from[0].view.classList[0]&&"POIDescription"!==e.from[0].view.classList[0]||t._lastPick.copy(xCity.findItem({id:e.from[0].view.getParent().dataModelID}).get("position"))),t.dispatchEvent("onUrbanClick",t)}),i.subscribeTo("/VISU/onTap",function(e){t.dispatchEvent("onUrbanClick",t)}),this.handleResize(),this._initialized=!0}},testFunction:function(t){},reset:function(){this.initPan(),this.resetMove()},_resize:function(t,e){this.handleResize()},handleResize:function(){this.screen.width=window.innerWidth,this.screen.height=window.innerHeight,this.screen.offsetLeft=0,this.screen.offsetTop=0,this.radius=(this.screen.width+this.screen.height)/4,this.lastPan.set(.5*this.screen.width,.5*this.screen.height),this.currentPan.copy(this.lastPan)},getMouseOnScreen:function(t,i){return new e.Vector2((t-this.screen.offsetLeft)/this.radius*.5,(i-this.screen.offsetTop)/this.radius*.5)},pixeltoangle:function(t){var e=t/Math.max(this.screen.width,this.screen.height)*2*Math.PI,i=this.params.manipulationSpeedFactor*this.params.rotateSpeed*e;return!0===this.shiftKey&&(i*=this.params.manipulationShiftSpeedFactor),i},getCurrentPitchAngle:function(){var t=l.vertical.clone().negate().dot(this.eye.clone().normalize());return t=Math.acos(t)},rotatelimited:function(){var t,i,s,n,o=0,a=0,r=this.lastY-this.currentY,h=!1,u=l.toRad(this.params.pitchMax),c=0,m=0,p=this.getCurrentPitchAngle();if(c=u-p,Math.abs(c)<this.zeroish&&(c=0),m=0-p,Math.abs(m)<this.zeroish&&(m=0),this.currentState===this.params.STATE.TOUCH_ROTATE){if(l.is(this.touchLast1)&&l.is(this.touchVeryFirst1)){var f=this.touchFirst2.clone().sub(this.touchFirst1).clone(),g=this.touchLast2.clone().sub(this.touchLast1).clone(),v=f.normalize(),y=g.normalize();this.touchFirst1.y<this.touchFirst2.y&&(v.negate(),y.negate());var b=l.cleandot(v,y),S=v.sub(y).x<0?1:-1;o=Math.acos(b)*S,this.touchFirst1.copy(this.touchLast1),this.touchFirst2.copy(this.touchLast2),this.touchLast1=null,Math.abs(o)<this.epsilon&&(o=0)}a=this.pixeltoangle(r)}else if(this.currentState===this.params.STATE.TOUCH_TILT)a=this.pixeltoangle(r),o=0;else{var _=this.lastX-this.currentX;o=this.pixeltoangle(_),a=this.pixeltoangle(r)}if(this.lastRotation.set(0,0),a=Math.max(m,a),a=Math.min(a,c),0===o&&0===a){if(!(this.timeLeftRotate>0))return this.timeLeftRotate=0,this.dampingAngleX=0,this.dampingAngleY=0,!1;Math.abs(this.dampingAngleX)<this.epsilon&&(this.dampingAngleX=.25*this.currentXAngularSpeed*this.params.dampingTime,!0===this.verbose&&d.log("total damping angle X "+this.dampingAngleX)),Math.abs(this.dampingAngleY)<this.epsilon&&(this.dampingAngleY=.25*this.currentYAngularSpeed*this.params.dampingTime,!0===this.verbose&&d.log("total damping angle Y "+this.dampingAngleY));var T=this.timeLeftRotate/this.params.dampingTime,P=this.dampingAngleX*this.easing(T),M=this.dampingAngleY*this.easing(T);!0===this.verbose&&d.log("current  angle "+P+" "+M),this.timeLeftRotate-=this.urban.USR.timeDelta,this.timeLeftRotate=Math.max(0,this.timeLeftRotate);var D=this.timeLeftRotate/this.params.dampingTime;o=P-this.dampingAngleX*this.easing(D),a=M-this.dampingAngleY*this.easing(D),Math.abs(o)<this.dampingRotateMin&&(o=0),Math.abs(a)<this.dampingRotateMin&&(a=0),a=Math.max(m,a),a=Math.min(a,c),0===o&&0===a&&(this.timeLeftRotate=0,this.dampingAngleX=0,this.dampingAngleY=0)}if((new e.Vector3).copy(this.eye),(new e.Vector3).copy(this.up),h=!1,o&&(i=this.vertical,(t=new e.Quaternion).setFromAxisAngle(i,o),h=!0,this.lastRotation.x=o,this.lastX=this.currentX,!0===this.verbose&&d.log("x "+o)),a&&(n=this.position.clone().sub(this.target.clone()).normalize(),(i=(new e.Vector3).crossVectors(n,this.up).normalize()).normalize(),(s=new e.Quaternion).setFromAxisAngle(i,-a),t=l.is(t)?t.multiply(s):s,h=!0,this.lastRotation.y=a,this.lastY=this.currentY),h){if(l.is(t)){t.normalize();var C=this.target.clone();l.is(this.zoomFocus)&&!l.isOut(this.zoomFocus,this.urban)&&(C=this.zoomFocus.clone()),this.rotateAround(t,C),this.currentQuaternion=t.multiply(this.currentQuaternion),this.updateBase(),this.eye.setLength(this.distanceToTarget)}}return h},rotateAround:function(t,e){var i=e.clone().sub(this.position);i.applyQuaternion(t),this.position.copy(e),this.position.sub(i)},zoomCameraOld:function(){var t,e,i,s=!1;if(this.currentstate===this.params.STATE.TOUCH_ZOOM&&(this.zoomEnd.y=-this.touchZoomDistanceEnd*this.zoomtouchfactor,this.zoomStart.y=-this.touchZoomDistanceStart*this.zoomtouchfactor),e=this.zoomEnd.y-this.zoomStart.y,Math.abs(e)<1/Math.max(this.screen.width,this.screen.height)&&(e=0),t=e*this.params.manipulationSpeedFactor*this.params.zoomSpeed*this.urban.USR.timeDelta*this.timeToOffset,!0===this.shiftKey&&(t*=this.params.manipulationShiftSpeedFactor),0!==e&&1!==t){this.eye.length(),i=.5*-t*Math.max(this.distanceToTarget,this.minZoomDistance),this.distanceToTarget=this.distanceToTarget-i;var n=this.eye.clone();this.position.add(n.setLength(i)),s=!0,this.zoomStart.y+=(this.zoomEnd.y-this.zoomStart.y)*Math.min(1,.5*this.params.dynamicDampingFactor*this.urban.USR.timeDelta*this.timeToOffset)}return this.touchZoomDistanceStart=-this.zoomStart.y/this.zoomtouchfactor,!0===this.verbose&&d.log("touchZoomDistanceStart  "+this.touchZoomDistanceStart),s},zoomCamera:function(){var t,e,i,s,n;if(!l.is(this.zoomFocus))return this.zoomCameraOld();if(this.currentState===this.params.STATE.TOUCH_ZOOM||this.currentState===this.params.STATE.TOUCH_ROTATE?(this.zoomEnd.y=-this.touchZoomDistanceEnd*this.zoomtouchfactor/this.params.touchZoom,this.zoomStart.y=-this.touchZoomDistanceStart*this.zoomtouchfactor/this.params.touchZoom,e=this.zoomEnd.y-this.zoomStart.y):(e=this.zoomEnd.y-this.zoomStart.y,!0===this.shiftKey&&(e*=this.params.manipulationShiftSpeedFactor)),Math.abs(e)<1/Math.max(this.screen.width,this.screen.height)&&(e=0),t=e*this.params.manipulationSpeedFactor*this.params.zoomSpeed*Math.min(.16,this.urban.USR.timeDelta)*this.timeToOffset,0!==e&&1!==t){t=Math.min(2,Math.max(-2,t));var o=this.zoomFocus.clone().sub(this.position);s=o.length(),i=.5*-t*Math.max(s,0),this.currentState!==this.params.STATE.TOUCH_ZOOM&&this.currentState!==this.params.STATE.TOUCH_ROTATE||(i=s*(1-(t=this.touchZoomDistanceStart/this.touchZoomDistanceEnd)),!0===this.verbose&&d.log("zoom "+s+" "+t+" "+i+" "+this.touchZoomDistanceEnd+" "+this.touchZoomDistanceStart),this.touchZoomDistanceStart=this.touchZoomDistanceEnd),o.setLength(i);var a=this.distanceToTarget;if(0===(s=Math.abs(s)))t>0||(n=.5*-t*1,o.setLength(n));else if(this.distanceToTarget=this.distanceToTarget*(s-i)/s,this.distanceToTarget<this.minZoomDistance)this.distanceToTarget=this.minZoomDistance,n=s*(this.distanceToTarget/a),o.setLength(s-n);return!0===this.verbose&&d.log("zoom applied  "+l.displayVector(o)),this.position.add(o),this.currentState!==this.params.STATE.TOUCH_ZOOM&&this.currentState!==this.params.STATE.TOUCH_ROTATE||this.zoomStart.copy(this.zoomEnd),this.zoomStart.y+=(this.zoomEnd.y-this.zoomStart.y)*Math.min(1,.5*this.params.dynamicDampingFactor*this.urban.USR.timeDelta*this.timeToOffset),this.touchZoomDistanceStart=-this.zoomStart.y*this.params.touchZoom/this.zoomtouchfactor,!0===this.verbose&&d.log("zoomdamping "+this.zoomStart.y+" "+this.zoomEnd.y+" "+this.touchZoomDistanceEnd+" "+this.touchZoomDistanceStart),!0}return!1},getAltitude:function(){return this.position.z-this.terrainHeight},setAltitude:function(t){var e=t+this.terrainHeight;return this.position.z!==e&&(this.position.z=t+this.terrainHeight),this.position},panDamping:function(){var t=!1;if(this.timeLeft>0)if(this.currentPan.copy(this.lastPan),l.is(this.currentSpeed))if(this.getCurrentDir().length()>0){this.dampingDistance<=0&&(this.dampingDistance=.25*this.currentSpeed*this.params.dampingTime,!0===this.verbose&&d.log("total damping distance "+this.dampingDistance));var e=this.timeLeft/this.params.dampingTime,i=this.dampingDistance*this.easing(e);!0===this.verbose&&d.log("current  distance "+i),!0===this.verbose&&d.log("time delta "+this.urban.USR.timeDelta),this.timeLeft-=this.urban.USR.timeDelta,this.timeLeft=Math.max(0,this.timeLeft),!0===this.verbose&&d.log("damping time left "+this.timeLeft);var s=this.timeLeft/this.params.dampingTime,n=this.dampingDistance*this.easing(s);!0===this.verbose&&d.log("damping new dist "+n);var o=this.topSpeed*this.urban.USR.timeDelta;!0===this.verbose&&d.log("damping max "+o);var a=Math.min(i-n,o),r=a;!0===this.verbose&&d.log("moved distance "+r),r<this.position.z*this.params.panLimitFactor?(this.timeLeft=0,this.dampingDistance=0,!0===this.verbose&&d.log("too small pan")):(a=this.getCurrentDir().setLength(r),this.position.sub(a),t=!0)}else this.timeLeft=0,this.dampingDistance=0;else this.timeLeft=0,this.dampingDistance=0;else this.timeLeft=0,this.dampingDistance=0;return t},panCameraOld:function(){var t,i,s,n,o=!1;t=this.lastPan.clone().sub(this.currentPan);var a=this.getAltitude();if(Math.abs(t.length())>this.epsilon){!0===this.verbose&&d.log(" pixel pan "+l.displayVector(this.mouseChange)+" "+l.displayVector(this.lastPan)+" "+l.displayVector(this.currentPan));var r=Math.max(this.getAltitude()*this.epsilon,.1);t.multiplyScalar(r*this.params.manipulationSpeedFactor*this.params.panSpeed),!0===this.shiftKey&&t.multiplyScalar(this.params.manipulationShiftSpeedFactor),n=this.eye.clone().cross(this.up).setLength(-t.x),0===(s=(i=new e.Vector3(this.target.x-this.position.x,this.target.y-this.position.y,0)).length())?n.add(this.up.clone().setLength(t.y)):n.add(i.multiplyScalar(t.y/s));var h=Math.abs(this.position.z)*this.params.panLimitFactor;n.length()>h&&(this.position.sub(n),!0===this.verbose&&d.log(" oldpan length "+n.length()+" "+this.urban.USR.timeDelta+" "+n.length()/this.urban.USR.timeDelta),this.updateCurrentDir(n)),this.lastPan.copy(this.currentPan),o=!0}return o||(o=this.panDamping()),o&&this.setAltitude(a),o},panCamera:function(){if(this.currentState===this.params.STATE.KEYBOARD_PAN)return this.panCameraOld();var t,e=!1,i=this.getAltitude();if(l.is(this.lastPan)&&(this.mouseChange.copy(this.currentPan),this.mouseChange.sub(this.lastPan),this.mouseChange.lengthSq()>this.epsilon&&(!0===this.verbose&&d.log(" pixel pan "+l.displayVector(this.mouseChange)+" "+l.displayVector(this.lastPan)+" "+l.displayVector(this.currentPan)),l.is(this.lastMouseFocus)||this.initPan(),l.is(this.lastMouseFocus)&&(this.currentMouseFocus=this.pick2D(!1,this.currentPan,this.lastMouseFocus.z),!0===this.verbose&&d.log("pickfocus "+l.displayVector(this.currentMouseFocus)+l.displayVector(this.currentPan)+l.displayVector(this.lastMouseFocus)),l.is(this.currentMouseFocus))))){if(this.debugPicking2){if(d.log("panfocus "+l.displayVector(this.currentMouseFocus)),!l.is(this.node2)){var s=new u.Color(0,1,0,1);this.node2=c.createSphereNode({radius:10,color:s}),this.urban.getView3D().getScene().add(this.node2)}var n=this.node2.getMatrix(),o=this.currentMouseFocus.clone();n.setPosition(o),this.node2.setMatrix(n)}(t=this.currentMouseFocus.clone().sub(this.lastMouseFocus)).z=0;var a=Math.max(Math.abs(this.position.z)*this.params.panLimitFactor,.01);t.length()>a&&(!0===this.verbose&&d.log(" pan length "+t.length()+" "+this.urban.USR.timeDelta+" "+t.length()/this.urban.USR.timeDelta),this.position.sub(t),this.updateCurrentDir(t),e=!0),this.currentPan.copy(this.lastPan)}if(e||(e=this.panDamping()),!0===e){if(!0===this.verbose){var r=this.lastPosition.position.clone().sub(this.position);d.log(" meter pan "+l.displayVector(r))}this.setAltitude(i)}return e},updateCurrentDir:function(t){var i=this.params.pandirframe;if(!l.is(this.dir[i]))for(;i>0;i--)l.is(this.dir[i-1])||(this.dir[i-1]=new e.Vector3);if(l.is(t)){for(i=this.params.pandirframe;i>1;i--)this.dir[i-1].copy(this.dir[i-2]);this.dir[0].copy(t)}else for(i=this.params.pandirframe;i>0;i--)this.dir[i-1].set(0,0,0)},getCurrentDir:function(){var t=this.params.pandirframe-1;for(this._currentDir.copy(this.dir[t]);t>0;t--)this._currentDir.add(this.dir[t-1]);return this._currentDir.multiplyScalar(1/this.params.pandirframe),this._currentDir.clone()},initPan:function(){this.lastMouseFocus=this.pick2D(!1,this.lastPan)},autoFocus:function(){var t,i=new e.Vector2(.5*this.screen.width,.5*this.screen.height);!0===this.verbose&&d.log("autofocus");var s=t=this.exactPick(i);if(l.is(t)){s.length();!0===this.verbose&&d.log("picked pos "+l.displayVector(s)),this.distanceToTarget=this.position.distanceTo(s),this.updateTarget(),!0===this.verbose&&d.log("picked dtt "+this.distanceToTarget+"  newtalt"+this.getAltitudeFromVector(s)+l.displayVector(this.target))}return!0},updateTarget:function(){!0===this.verbose&&d.log("befre "+l.displayVector(this.target));var t=this.eye.setLength(this.distanceToTarget);this.target=this.position.clone().add(t),!0===this.verbose&&d.log("after "+l.displayVector(this.target))},checkOnly:function(){if(this.urban.webSocket)return!0;var t=!0;this.getAltitude(this.position)<=this.params.minHeight&&(l.is(this.currentAnimation)&&this.checkH||(t=!1)),this.up.normalize(),this.eye.normalize();var e=this.getCurrentPitchAngle(),i=l.toRad(this.params.pitchMax);return this.up.z<-.01?t=!1:e>i&&(t=!1),t},setPositionOnSphere:function(t,e){var i=this.eye.clone(),s=this.position.clone(),n=(this.target.clone(),t.clone().sub(s)),o=n.length();i.length();i.normalize(),n.normalize();var a=s.add(i.multiplyScalar(n.dot(i)*o)),r=t.sub(a).length(),h=Math.sqrt(e*e-r*r);h=Math.min(h-1,this.distanceToTarget),!0===this.verbose&&d.log("oldpos"+l.displayVector(this.position)),this.position=a.add(i.negate().setLength(h)),!0===this.verbose&&d.log("correctedpos"+l.displayVector(this.position))},checkValues:function(){if(this.urban.webSocket)return!0;var t=!0;this.getAltitude(this.position)<=this.params.minHeight&&(l.is(this.currentAnimation)&&this.checkH||(this.resetZoom(),!0===this.verbose&&d.log("too low"),this.setAltitude(this.params.minHeight+.1)));var i=this.viewpoint._translateToAbsolutePosition(this.viewpoint._initialCenter.clone());this.target.distanceTo(i)>this._getWorldSize()*this.params.maxfactor&&(this.resetMove(),this.target=this.target.sub(i),this.target.setLength(this._getWorldSize()*this.params.maxfactor),this.target.add(i),this.distanceToTarget=this.position.distanceTo(this.target),t=!0,!0===this.verbose&&d.log("correction : target too far from center")),this.position.distanceTo(i)>this._getWorldSize()*this.params.maxfactor&&(this.resetMove(),this.setPositionOnSphere(i,this._getWorldSize()*this.params.maxfactor),this.distanceToTarget=this.position.distanceTo(this.target),this.updateTarget(),t=!0,!0===this.verbose&&d.log("correction : position too far from center")),this.up.normalize(),this.eye.normalize();var s=this.getCurrentPitchAngle(),n=l.toRad(this.params.pitchMax),o=this.position.clone().sub(this.target.clone()).normalize(),a=(new e.Vector3).crossVectors(o,this.up).normalize();if(a.normalize(),this.up.z<-.01){if(t=!0,!0===this.verbose&&d.log("correction : up must not be below horizon"),l.is(this.zoomFocus))this.zoomFocus.distanceTo(this.position);this.up.z=0,this.up.normalize(),this.eye.x=0,this.eye.y=0,this.eye.normalize(),this.position.copy(this.target),this.position.z+=this.distanceToTarget,this.eye.normalize(),this.resetMove(),this.zoomFocus=null}else if(s>n){t=!0;var r=new e.Quaternion,h=s-n;r.setFromAxisAngle(a,h),r.normalize(),this.eye.normalize(),this.eye.copy(this.eye.applyQuaternion(r)),this.eye.normalize(),this.up=l.getUpFromCameraEye(this.eye).normalize();this.position.z;this.position.copy(this.target.clone().sub(this.eye.setLength(this.distanceToTarget))),this.eye.normalize(),s=this.getCurrentPitchAngle(),!0===this.verbose&&d.log("correction : pitch angle too high")}return this.distanceToTarget<this.viewpoint.camera.near+1&&(this.distanceToTarget=this.viewpoint.camera.near+1,this.position.copy(this.target.clone().sub(this.eye.setLength(this.distanceToTarget))),t=!0,!0===this.verbose&&d.log("correction : target too close")),t},setKeyframe:function(t){if(l.is(t)){var e=!1;if(l.is(t.position)&&(this.position.copy(t.position),e=!0),l.is(t._target)&&(this.target.copy(t._target),this.distanceToTarget=this.position.distanceTo(this.target),e=!0),l.is(t.quaternion)&&(this.currentQuaternion.copy(t.quaternion),this.updateBase(),e=!0),l.is(t.date)&&(this.urban.date.setDate(t.date),e=!0),!0===e)return this._updateFromKeyframe=!0,this.resetMove(),!0}return this._updateFromKeyframe=!1,!1},animate:function(){l.is(this.askedmove)&&(this.moveToClick(this.askedmovepos,this.askedmove),this.askedmove=null,this.askedmovepos=null);var t=!1;return l.is(this.currentAnimation)&&(this.currentAnimation.isDone()&&!this.currentAnimation.isRunning()?(this.urban.getView3D().getRecorder().stopRecord(),this.autoFocus(),this.checkH=!0,this.currentAnimation.stop(),this.currentAnimation=null,this.repickExact=!0,this.zoomFocus=null,t=!0):this.currentAnimation.isPlaying()&&l.is(this.timeline)&&this.timeline.setValue(this.currentAnimation.animationTime)),t},updateLastPosition:function(){!0===this.checkOnly()&&(this.lastPosition=this.getCurrentKeyframe(),!0===this.verbose&&d.log("lastposition "+l.displayVector(this.lastPosition.position)))},updateSpeed:function(){l.is(this.lastPosition)&&l.is(this.lastPosition.position)&&(this.motion=this.lastPosition.position.clone().sub(this.position),0!==this.urban.USR.timeDelta&&(this.movelapse+=this.urban.USR.timeDelta,l.is(this.motion)&&(this.movelength+=this.motion.length(),this.movelapse>0?this.currentSpeed=this.movelength/this.movelapse:this.currentSpeed=0,this.topSpeed<this.currentSpeed&&(this.topSpeed=this.currentSpeed),this.movelapse>0?(this.moverotX+=this.lastRotation.x,this.moverotY+=this.lastRotation.y,this.currentXAngularSpeed=this.moverotX/this.movelapse,this.currentYAngularSpeed=this.moverotY/this.movelapse):this.currentXAngularSpeed=this.currentYAngularSpeed=0,!0===this.verbose&&this.currentSpeed>this.epsilon&&d.log("speed "+this.currentSpeed+" m/s "+l.displayVector(this.motion)+" "+this.urban.USR.timeDelta))))},screenBound:function(t){var i=new e.Vector2;return i.x=Math.max(0,t.x),i.y=Math.max(0,t.y),i.x=Math.min(t.x,this.screen.width),i.y=Math.min(t.y,this.screen.height),i},update:function(t){if(!0!==t)return!1;l.is(this.lastPan)&&this.currentKeyOffset.length()>0&&(this.lastPan.sub(this.currentKeyOffset),this.screenBound(this.currentPan).equals(this.currentPan)||(this.lastMouseFocus=null,this.currentPan.copy(this.lastPan)));l.is(this.currentX)&&(this.currentX+=this.currentKeyAngle.x),l.is(this.currentY)&&(this.currentY+=this.currentKeyAngle.y),l.is(this.zoomStart)&&(this.zoomStart.y+=this.currentKeyZoom.y),!0===this.firstcall&&this.updateLastPosition();var e=!1,s=!1,o=!1,a=this.viewpoint.getTarget(),r=this.viewpoint.getPosition(),h=this.viewpoint.camera.up.clone(),u=a.clone().sub(r),c=this.viewpoint.camera.quaternion.clone();l.is(this.currentQuaternion)&&(c=this.viewpoint.camera.quaternion.clone());this.getAltitude();if(!0===this._updateFromKeyframe?(e=!0,s=!0,!1===this.checkH&&(this._updateFromKeyframe=!1),!0===this.verbose&&d.log(" keyframe applied ")):(l.is(r)&&(this.position.distanceTo(r)>this.epsilon&&(e=!0),this.position.copy(r)),l.is(a)&&this.target.copy(a),l.is(h)&&this.up.copy(h),l.is(u)&&this.eye.copy(u),l.is(this.currentQuaternion)&&(l.equals(this.currentQuaternion,c)||(e=!0),this.currentQuaternion.copy(c)),!0===this.verbose&&e&&d.log(" viewpoint modified outside of manipulator")),!l.is(this.currentAnimation)&&!0===this.checkH){!0===this.verbose&&d.log("checkH ...");var m=this.getAltitude();m<this.params.minHeight&&(this.heightOffset+=this.params.minHeight+1-m,this.setAltitude(this.params.minHeight+1),r.copy(this.position),e=!0,this.resetMove(),d.log("ground too high")),this.checkH=!1}this.distanceToTarget=this.position.distanceTo(this.target);var p,f;this.position.length();l.is(this.noPick)&&l.is(this.zoomFocus)||(!0!==this.repick&&!0!==this.repickExact||(this.terrainHeight>this.mountainHeight&&this.getAltitudeFromVector(this.position)<this.groundMaxAlt&&(this.repickExact=!0),!0===this.repickExact&&!1===this.params.noExactRepick?(p=this.exactPick(this.zoomMouse),l.isOut(p,this.urban)?!0===this.verbose&&d.log(" no exact pick 7 !! "+l.displayVector(this.zoomFocus)):(this.zoomFocus=p,this._lastPick.copy(p))):(!0===this.params.zoomExactPick?(p=this.exactPick(this.zoomMouse),l.isOut(p,this.urban)?!0===this.verbose&&d.log(" no exact pick 6 !! "+l.displayVector(this.zoomFocus)):this.zoomFocus=p):this.zoomFocus=this.pick2D(!1,this.zoomMouse),l.is(this.zoomFocus)||(this.zoomFocus=this.pick2D(!1,this.zoomMouse))),l.is(this.zoomFocus)&&(!0===this.verbose&&d.log("zoomfocus"+l.displayVector(this.zoomFocus)),this.lastPan.equals(this.zoomMouse)&&(this.lastMouseFocus=this.zoomFocus.clone())),this.repickExact=!1,this.repick=!1));if((this.urban.getView3D().getRecorder().isRecording()||this.still===this.params.focusTime||this.still===this.params.focusTime*this.params.focusTime)&&(l.is(this.noPick)||(o=this.autoFocus()),l.is(this.lastMove)&&o&&(this.lastMove+=" focused")),this.params.noAnimation||(e=(f=this.animate())||e,f&&l.is(this.lastMove)&&(this.lastMove+=" animation"),!f)){if(!1===e?(this.params.noRotate||(e=(f=this.rotatelimited())||e,f&&(this.resetZoom(),l.is(this.lastMove)&&(this.lastMove+=" rotate"))),this.params.noZoom||(e=(f=this.zoomCamera())||e,f&&l.is(this.lastMove)&&(this.lastMove+=" zoom")),this.params.noPan||(e=(f=this.panCamera())||e,f&&l.is(this.lastMove)&&(this.lastMove+=" pan"))):!0===this.verbose&&d.log("no movement because animation"+this.lastMove),!0===this.verbose&&l.is(this.lastMove)&&""!==this.lastMove&&d.log(this.lastMove),this.updateSpeed(),this.updateLastPosition(),!0===e||!0===o||!0===this.firstcall){if(this.updateTarget(),this.firstcall=!1,l.is(this.currentAnimation)||(this._lastTarget.copy(a),this._lastPos.copy(r),!1===this.checkValues()&&(this.target.copy(a),this.position.copy(r),this.up.copy(h),this.eye.copy(u),this.currentQuaternion.copy(c),this.distanceToTarget=this.position.distanceTo(this.target),!0===this.verbose&&d.log(" false values"))),this.updateViewpoint(),l.is(this.urban.USR.webGLV6Viewer.renderer.BokehDOFEffect)&&this.distanceToTarget<129){var g=Math.min(64,.5*this.distanceToTarget);this.urban.USR.webGLV6Viewer.renderer.BokehDOFEffect.updateFocalLength(g)}!0,e&&(this.still=0,s||(this.lastFeature=null))}var v={position:this.position,target:this.target,up:this.up,eye:this.eye};if(n.set(v),n.draw(),this.currentState===this.params.STATE.ROTATE?!0===e&&(this.targetDisplayed=!0):this.currentState===this.params.STATE.TOUCH_ROTATE?this.startTouch<=0?this.targetDisplayed=!1:!0===e&&(this.targetDisplayed=!0):this.targetDisplayed=!1,this.displayTarget(this.targetDisplayed),!1===e&&(this.still++,this.movelength=0,this.moverotX=0,this.moverotY=0,this.still>this.params.resetTime&&(this.movelapse=0,this.topSpeed=0,this.buttonDown<=0&&this.startTouch<=0&&this.setState(this.params.STATE.NONE))),(e||o)&&!0===this.verbose){this.eye.clone().normalize(),this.up.clone().normalize();var y=this.viewpoint.getPosition().clone(),b=this.viewpoint.getTarget().clone();y.length(),b.length();y.normalize(),b.normalize()}return this.currentState!==this.params.STATE.NONE}i.publish(i.eventsList.onStopAnimation)},getLastMoveType:function(){var t="";return l.is(this.lastMove)&&(t=this.lastMove,this.lastMove=""),t},getAltitudeFromVector:function(t){return t.z},setAltitudeToVector:function(t,e){return t.z=e,t},getText:function(t){var e=this.eye.clone().normalize(),i=this.up.clone().normalize(),s=this.viewpoint.get();return"<br />vangle  : "+l.displayVector(s.angle)+"<br />Tgt  : "+l.displayVector(this.target)+"<br />Talt : "+this.getAltitudeFromVector(this.target)+"<br />Pos  : "+l.displayVector(this.position)+"<br />Palt : "+(this.getAltitudeFromVector(this.position)-this.terrainHeight)+"<br />Dtot : "+this.distanceToTarget.toFixed(3)+"<br />Eye  : "+l.displayVector(e)+"<br />Up : "+l.displayVector(i)+"<br />quat : "+l.displayVector(this.currentQuaternion)+"<br />move : "+this.getLastMoveType()},updateViewpoint:function(){this.viewpoint.setPosition(this.position),this.viewpoint.camera.up.copy(this.up),this.viewpoint.overwriteTarget(this.target),this.orientation.copy(this.currentQuaternion)},moveToFeature:function(t,e){if(l.is(this.askedmove))return null;if(l.is(t)&&l.is(t.get)){if(t.get("PointOfView")){var i=t.get("PointOfView");return this.moveTo(i.getLocalPosition(this.urban).clone(),i.get("rotation").clone().multiplyScalar(Math.PI/180),i.get("length"),e)}if(t.get("Content")){var s,n=t.get("Content");if(n instanceof g){if(s=n.getLocalPosition(this.urban)){var o=n._rtreeNode.openDistance*n._rtreeNode.instance.distanceFactor*.75;return this.moveTo(s.clone(),{x:0,y:45,z:0},o,e)}}else if(s=n.getLocalPosition(this.urban)){o=this.params.defaultDistance;return l.is(n.getSphereDiameter)&&(o=Math.max(2*n.getSphereDiameter(),2),l.is(o)||(o=this.params.defaultDistance)),this.moveTo(s.clone(),void 0,o,e)}}}return null},isFrom3dViewer:function(t){if(t.target){var e=t.target;if("xCityViewer"===e.id)return"timeSlider"!==e.className;if(e.parentElement&&"xCityViewer"===e.parentElement.id)return"timeSlider"!==e.className}return!1},centerTarget:function(t){if(!1===this.enabled)return!1;!0===this.verbose&&d.log("center click");var e=this._getEvent(t);return this.isFrom3dViewer(e)?this.AskMoveToClick(t.gesture.events[0].currentPosition,1):void 0},doubleClick:function(t){if(!1===this.enabled)return!1;!0===this.verbose&&d.log("double click");var e=this._getEvent(t);if(this.isFrom3dViewer(e)&&(!t.from[0]||!0!==t.from[0]._movetoFeatureLaunched)){var i=!0;if(l.is(e.button)){if(0===e.button){if(!this.params.leftDoubleClickEnable)return!1}else if(2===e.button&&!this.params.rightDoubleClickEnable)return!1;0!==e.button&&(i=!1)}!0===e.ctrlKey&&(i=!i);var s=1/this.params.doubleClickZoomFactor;return!1===i&&(s=this.params.doubleClickZoomFactor),this.AskMoveToClick(t.gesture.events[0].currentPosition,s)}},AskMoveToClick:function(t,e){l.is(this.currentAnimation)&&!this.params.movetoclickpriority||(this.askedmove=e,this.askedmovepos=t,this.currentAnimation=null)},moveToClick:function(t,e){var i=null;if(i=e>=1?this.exactPick(t):this.viewpoint.featureIntersect(t)?null:this.exactPick(t),l.is(i)){var s=this.viewpoint._translateToAbsolutePosition(this.viewpoint._initialCenter.clone()),n=this.params.maxfactor*this._getWorldSize();n-=i.distanceTo(s);var o=Math.min(n,e*this.position.distanceTo(i));return this.moveTo3(i,o,void 0,void 0)}return null},faceNorth:function(){var t=this.distanceToTarget,i=this.getCurrentKeyframe();i.date=null;var s=l.getNorthAngle(this.eye,this.up),n=i.getQuaternion(),r=i.clone(),h=new e.Quaternion;h.setFromAxisAngle(l.vertical.clone(),.5*-s);var u=h.multiply(n);r.setQuaternion(u);var c=r._eye.clone(),d=r._target.clone().sub(c.setLength(t));r.position=d.clone(),r.time=.5*this.params.northMoveDuration*1e3;var m=i.clone(),p=new e.Quaternion;p.setFromAxisAngle(l.vertical.clone(),-s),u=p.multiply(n),m.setQuaternion(u),c=m._eye.clone(),d=m._target.clone().sub(c.setLength(t)),m.position=d.clone(),m.time=1e3*this.params.northMoveDuration,(d=new a).addKeyframe(i),d.addKeyframe(r),d.addKeyframe(m);var f=new o(this,d,"facenorth");return this.setCurrentAnimation(f)},faceVerticalNorth:function(){new e.Vector3(0,0,0);var t=new e.Vector3(0,0,-1),i=this.target,s=this.distanceToTarget;return this.moveTo3(i,s,t,this.params.northMoveDuration)},toKeyframe:function(t,e,i,s,n,o){l.is(s)||(s=0);var a=new r({position:t,time:s,date:o});return a._target=n,a._up=i,a.initQuat(e,i),a},_getFinalPositionFromViewpoint:function(t,e,i){var s=t.clone().sub(i.normalize().multiplyScalar(e)),n=this.urban.USR.getGroundHeight(s.x,s.y);n*=this.urban.USR.scale;var o=this.params.minHeight+n;return this.getAltitudeFromVector(s)<o&&(this.setAltitudeToVector(s,o+1),(i=t.clone().sub(s)).normalize()),!0===this.verbose&&d.log("moveto3 to: "+l.displayVector(s)),s},moveTo3:function(t,e,i,s){if(!l.is(t))return!1;l.is(e)||(e=this.distanceToTarget),l.is(i)||(i=this.eye.clone()),l.is(s)||(s=this.params.moveDuration2);var n=this._getFinalPositionFromViewpoint(t,e,i);return this.moveTo4(n,i,s,t)},moveTo4:function(t,e,i,s){if(t.distanceTo(this.position)<this.epsilon)return d.log("same position no anim"),!1;var n=this.toKeyframe(t,e.normalize(),this.up,1e3*i,s),r=new a({splineInterpolate:!1}),h=this.getCurrentKeyframe();return h.date=null,r.addKeyframe(h),r.addKeyframe(n),this.setCurrentAnimation(new o(this,r,"moveto4"))},getCurrentKeyframe:function(){var t=null,e=null,i=null,s=null;l.is(this.position)&&(s=this.position.clone()),l.is(this.target)&&(i=this.target.clone()),l.is(this.up)&&(t=this.up.clone().normalize()),l.is(this.eye)&&(e=this.eye.clone().normalize());var n=this.urban.date.getDate(),o=new r({position:s,time:0,date:n,_target:i,_up:t});return o.initQuat(e,t),o},interpolKey:function(t,i,s,n,o){var a=i.date,r=t.lerp(t.position,i.position,s);this.setAltitudeToVector(r,o);var h=n.clone().sub(r),u=(new e.Vector3(1,0,0),l.getUpFromCameraEye(h)),c=t.lerpValue(t.time,i.time,s);return this.toKeyframe(r,h,u,c,n.clone(),a)},positionOffset:function(t,e,i,s){i._target.clone().sub(e._target);var n=i._eye.clone().normalize().add(i._up.clone().normalize()),o=t._right.clone().normalize();o.dot(n)>this.epsilon&&o.negate();var a=t.position.clone();return a.add(o.setLength(s)),a},getPathF4:function(t,e,i,s,n){var o=null,r=this._getFinalPositionFromViewpoint(t,e,i);if(r.distanceTo(this.position)<this.epsilon)return d.log("same position no anim"),null;var h=this.getAltitudeFromVector(this.position),u=this.getAltitudeFromVector(r),c=this.getCurrentKeyframe(),m=c._target;c.date=null,c._target=null;var p=c.date,f=l.getUpFromCameraEye(i);if(o=m.distanceTo(t),!l.is(n)){(f=t.clone().sub(c.position)).z=0,f.normalize();var g=c._up.clone();g.z=0,g.normalize();var v=f.clone();v.z=0,v.normalize(),g.clone().dot(v)<this.epsilon&&o<1e3&&(f.negate(),d.log(" negated"))}var y=this.toKeyframe(r,i,f,1e3*s*1,t.clone(),p);l.is(n)&&y.setQuaternion(n);var b=r.clone(),S=this.position.clone(),_=Math.abs(.5*b.distanceTo(S)),T=0+(Math.min(h,u)+.5*_),P=y.date,M=c.lerp(c.position,y.position,.5);this.setAltitudeToVector(M,T);var D=t.clone().sub(M);f=l.getUpFromCameraEye(D),o<1e3&&(l.is(n)||(f=c.lerp(c._up.clone(),y._up.clone(),.5).normalize()));var C=c.lerpValue(c.time,y.time,.5),x=this.toKeyframe(M,D,f,C,t.clone(),P);return(o=new a({fadeRotation:!0,targetInterpol:!1})).addKeyframe(c),o.addKeyframe(x),o.addKeyframe(y),o.timeAdjust(),o},teleport:function(t,i,s){var n=null;l.is(i)||(i=.5*this.distanceToTarget),l.is(s)?(n=l.quatFromAngles(s.x,s.y,s.z),s=new e.Vector3(-Math.sin(s.x)*Math.sin(s.y),-Math.cos(s.x)*Math.sin(s.y),Math.cos(s.y)).normalize().multiplyScalar(i).negate()):s=this.vertical.clone().negate();var r=t.clone().sub(s.setLength(i)),h=this.toKeyframe(r,s,l.getUpFromCameraEye(s),0,t.clone(),null);l.is(n)&&h.setQuaternion(n);var u=new a;u.addKeyframe(h.clone()),h.time=1,u.addKeyframe(h);var c=new o(this,u,"teleport");this.setCurrentAnimation(c)},teleportToFeature:function(t){if(l.is(t))if(t.get("PointOfView")){var e=t.get("PointOfView");this.teleport(e.getLocalPosition(this.urban).clone(),e.get("length"),e.get("rotation").clone().multiplyScalar(Math.PI/180))}else if(t.get("Content")){var i=t.get("Content").getLocalPosition(this.urban);i&&this.teleport(i.clone(),this.params.defaultDistanceOnActivation,void 0)}},moveTo2:function(t,i,s,n){if(!l.is(t))return!1;var o=null;return l.is(i)||(i=this.params.defaultDistanceOnActivation),l.is(s)?(o=l.quatFromAngles(s.x,s.y,s.z),s=new e.Vector3(-Math.sin(s.x)*Math.sin(s.y),-Math.cos(s.x)*Math.sin(s.y),Math.cos(s.y)).normalize().multiplyScalar(i).negate()):s=new e.Vector3(0,0,-1),this.moveToWithOrientation(t,i,s,n,o)},moveToWithOrientation:function(t,e,i,s,n){l.is(s)||(s=this.params.moveDuration);var a=this.getPathF4(t,e,i,s,n);if(l.is(a)){if(!0===this.debug){var r,h=a.getPositionSpline(),d=h.points;if(l.is(h.points)&&h.points.length>0){var m=new u.Color(1,0,0,1);for(r=0;r<h.points.length;r++)d[r]=h.points[r].clone();var p=c.createLineNode({points:d,width:500,color:m});for(p.name="ManipulatorHelper",this.urban.getView3D().getScene().add(p),d=h.getSpacedPoints(2e3),m=new u.Color(0,0,1,1),r=0;r<d.length;r++)d[r]=d[r].clone();(p=c.createLineNode({points:d,width:500,color:m})).name="ManipulatorHelper",this.urban.getView3D().getScene().add(p)}}var f=new o(this,a,"moveto2");return!0===this.debugMoveTo&&(f.runOnce=!1,this.paths.moveto2=f,this.setCurrentPath("moveto2")),this.setCurrentAnimation(f)}return null},getCurrentAnimation:function(){return this.currentAnimation},setCurrentAnimation:function(t){return!!l.is(t)&&(l.is(this.currentAnimation)&&(this.currentAnimation.stop(),this.currentAnimation=null),this.currentAnimation=t,!0===this.currentAnimation.runOnce&&this.currentAnimation.start(),this.resetMove(),!0)},moveTo:function(t,e,i,s){return this.params.moveToTarget?this.moveTo2(t,i,e,s):null},resetPan:function(){this.timeLeft=0,this.currentKeyOffset.set(0,0),this.updateCurrentDir(null),this.dampingDistance=0,this.movelength=0},resetMove:function(){this.movelapse=0,this.resetPan(),this.resetZoom(),this.resetRotate(),this.setState(this.params.STATE.NONE)},resetRotate:function(){this.currentKeyAngle.set(0,0),this.moverotX=0,this.moverotY=0,this.currentX=this.lastX,this.currentY=this.lastY,this.timeLeftRotate=0,this.dampingAngleX=0,this.dampingAngleY=0},resetZoom:function(){!0===this.verbose&&d.log("reset zoom"),this.currentKeyZoom.set(0,0),this.zoomStart.copy(this.zoomEnd)},mousedown:function(t){if(!1===this.enabled)return!1;var i=this._getEvent(t);if(!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,!0===this.verbose&&d.log("mousedown "+i.button),this.isFrom3dViewer(i)){if(this.resetMove(),this.lastX=i.clientX,this.lastY=i.clientY,this.currentX=i.clientX,this.currentY=i.clientY,this.currentState===this.params.STATE.NONE){var s=i.button;!0===i.ctrlKey&&(s===this.params.STATE.PAN?(s=this.params.STATE.ROTATE,this.lastMouseFocus=null):s===this.params.STATE.ROTATE&&(s=this.params.STATE.PAN)),this.setState(s)}var n=new e.Vector2(i.clientX,i.clientY);return!0===this.verbose&&d.log(l.displayVector(n)),l.is(this.zoomMouse)&&!n.equals(this.zoomMouse)&&(this.zoomMouse.copy(n),this.repickExact=!0,this.zoomFocus=null),this.currentState!==this.params.STATE.ROTATE||this.params.noRotate?this.currentState!==this.params.STATE.ZOOM||this.params.noZoom?this.currentState!==this.params.STATE.PAN||this.params.noPan||(this.currentPan.set(i.clientX,i.clientY),this.lastPan.set(i.clientX,i.clientY),this.initPan(),!0===this.verbose&&d.log("mousedown"+l.displayVector(this.lastPan))):this.zoomStart=this.zoomEnd=this.getMouseOnScreen(i.clientX,i.clientY):(this.repickExact=!0,this.zoomFocus=null),this.buttonDown=1,!1}},mousemove:function(t){if(!1===this.enabled)return!1;var e=this._getEvent(t);!0===e.shiftKey?this.shiftKey=!0:this.shiftKey=!1,this.currentState!==this.params.STATE.NONE&&e.preventDefault(),this.currentState!==this.params.STATE.ROTATE||this.params.noRotate?this.currentState!==this.params.STATE.ZOOM||this.params.noZoom?this.currentState!==this.params.STATE.PAN||this.params.noPan||(this.currentPan.set(e.clientX,e.clientY),!0===this.verbose&&d.log("mousemove"+l.displayVector(this.currentPan))):this.zoomEnd=this.getMouseOnScreen(e.clientX,e.clientY):(this.currentX=e.clientX,this.currentY=e.clientY,this.noPick=!0),!0===this.verbose&&d.log("mousemove")},mouseup:function(t){if(!1===this.enabled)return!1;if(!1===this.enabled)return!1;this._getEvent(t);if(this.shiftKey=!1,!0===this.verbose&&d.log("mouseup"),this.noPick=null,this.currentState===this.params.STATE.PAN?(this.timeLeft=this.params.dampingTime,!0===this.verbose&&d.log(" damp pan start ")):this.currentState===this.params.STATE.ROTATE&&(this.timeLeftRotate=this.params.dampingTime,!0===this.verbose&&d.log(" damp rotate start ")),this.buttonDown=0,!0===this.repickExact){var e=this.exactPick(this.zoomMouse);l.isOut(e,this.urban)?!0===this.verbose&&d.log(" no exact pick 5 !! "+l.displayVector(this.zoomFocus)):(this.zoomFocus=e,this._lastPick.copy(e)),this.repickExact=!1}},mousewheel:function(t){if(!1===this.enabled)return!1;var i=this._getEvent(t);!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,l.is(i)&&UWA.Event.preventDefault(i),this.resetPan(),this.resetRotate();var s=0;i.wheelDelta?s=i.wheelDelta/40:i.detail&&(s=-i.detail),s=s>0?3:-3,!0===this.verbose&&d.log("wheel "+s),this.setState(this.params.STATE.ZOOM),this.zoomStart.y+=1/s*.05;var n=new e.Vector2(i.clientX,i.clientY);l.is(this.zoomMouse)&&!n.equals(this.zoomMouse)&&(this.zoomMouse.copy(n),this.repick=!0)},exactPick:function(t){if(!l.is(t))return null;!0===this.verbose&&d.log(" exact pick ...");var e=this.viewpoint.exactPick(t);if(l.is(e)){var i=this.getAltitudeFromVector(e);this.getAltitudeFromVector(this.position);if(l.isOut(e,this.urban))return!0===this.verbose&&d.log("pick dans lespace ..."),null;var s=-Math.abs(.001*this.position.z);i<Math.min(s,-1)&&!0===this.verbose&&console.warn("Pick error : picked altitude "+i+" "+s);var n=e.clone().sub(this.position);if(l.getAngleBetween(this.eye.clone(),n)>.5*Math.PI)return!0===this.verbose&&console.warn("Pick error : picked behind camera tgt alt : "+i+" cam alt :"+this.getAltitude()),null;if(!0===this.verbose&&d.log("pick "+l.displayVector(e)),this.debugPicking2){if(!l.is(this.node)){var o=new u.Color(1,0,0,1);this.node=c.createSphereNode({radius:10,color:o}),this.urban.getView3D().getScene().add(this.node)}var a=this.node.getMatrix(),r=e.clone();a.setPosition(r),this.node.setMatrix(a)}return e}return!0===this.verbose&&d.log("pas dintersection ..."),null},pick:function(t,i){return this.pick2D(!0,new e.Vector2(t,i))},pickFromRay:function(t,e){return this.viewpoint.fastPick(t,e)},pick2D:function(t,e,i){if(!l.is(e))return null;l.is(i)||(i=this.terrainHeight);var s=this.pickFromRay(e,i);return t&&l.isOut(s,this.urban)&&(s=null),!0===this.verbose&&d.log(" pick2D !! "+l.displayVector(s)),s},setState:function(t){t!==this.currentState&&(!0===this.verbose&&d.log(" from "+this.currentState+" to "+t),this.prevState=this.currentState,this.setCursor(t),this.currentState=t)},_getCursor:function(t){var e=m.getWebappsAssetUrl("UrbanWidget","")+"icons/32/",i="",s="";t===this.params.STATE.PAN?this.params.noPan||(i="Pan",s=" 15 15"):t===this.params.STATE.ZOOM?this.params.noZoom||(i="Zoom",s=" 13 13"):t===this.params.STATE.ROTATE&&(this.params.noRotate||(i="Rotate",s=" 16 15"));var n="url('"+e+"Urban"+i+".png')"+s+", url('"+e+"Urban"+i+".cur')"+s+", auto";return""===i&&(n="auto"),n},setCursor:function(t){var e=this,i=this._getCursor(t);this._changeCursorDelay&&(clearTimeout(this._changeCursorDelay),this._changeCursorDelay=null),this.params.cursorChangeDelay>0?this._changeCursorDelay=setTimeout(function(){e.domElement.style.cursor=i,e.urban.getView3D().webGLV6Viewer.setCursor(i,1,!0)},this.params.cursorChangeDelay):this.domElement.style.cursor=i},touchstart:function(t){if(!1===this.enabled)return!1;var i=this._getEvent(t);if(this.isFrom3dViewer(i)){!0===this.verbose&&d.log("touchstart "+this.startTouch),this.startTouch=this.startTouch+1,this.resetMove(),l.is(i)&&i.stopPropagation(),this.repickExact=!0,i=t.gesture.events[0].currentPosition;var s=new e.Vector2(i.x,i.y);l.is(this.zoomMouse)&&!s.equals(this.zoomMouse)&&(this.zoomMouse.copy(s),this.repickExact=!0,this.zoomFocus=null)}},touchmove:function(t){if(!1===this.enabled)return!1;!0===this.verbose&&d.log("touchmove");var i,s,n=t.gesture,o=this._getEvent(t);if(this.startTouch<1||void 0===n.touches||0===n.touches.length||!0===n.lastChange)return d.log("useless touch move"),!1;if(l.is(o)&&(o.preventDefault(),o.stopPropagation()),!0===this.verbose&&d.log(n.name),this.currentState===this.params.STATE.NONE)if("Pinch"===n.name)this.setState(this.params.STATE.TOUCH_ZOOM),this.touchZoomDistanceStart=n.distance,!0===this.verbose&&d.log("touchZoomDistanceStart init "+n.initDistance);else if("Swipe"===n.name)this.setState(this.params.STATE.TOUCH_PAN),this.lastPan.set(n.touches[0].currentPosition.x,n.touches[0].currentPosition.y),this.repickExact=!0,this.zoomMouse.copy(this.lastPan),this.initPan();else if("PinchPanRotate"===n.name){this.touchZoomDistanceStart=n.distance,!0===this.verbose&&d.log("touchZoomDistanceStart "+n.distance),this.setState(this.params.STATE.TOUCH_ROTATE),this.lastX=n.touches[0].currentPosition.x,this.lastY=n.touches[0].currentPosition.y,this.currentX=n.touches[0].currentPosition.x,this.currentY=n.touches[0].currentPosition.y,this.touchFirst1=new e.Vector2(this.currentX,this.currentY),this.touchFirst2=new e.Vector2(n.touches[1].currentPosition.x,n.touches[1].currentPosition.y),i=Math.floor((this.touchFirst1.x+this.touchFirst2.x)/2),s=Math.floor((this.touchFirst1.y+this.touchFirst2.y)/2);var a=new e.Vector2(i,s);this.lastPan.copy(a),this.currentPan.copy(this.lastPan),this.initPan(),l.is(this.zoomMouse)&&a.equals(this.zoomMouse)||(this.zoomMouse.copy(a),this.repick=!0),l.is(this.touchVeryFirst1)||(this.touchVeryFirst1=this.touchFirst1,this.touchVeryFirst2=this.touchFirst2),this.choice=0}if("Pinch"===n.name&&this.currentState===this.params.STATE.TOUCH_ZOOM)this.touchZoomDistanceEnd=n.distance,!0===this.verbose&&d.log("touchZoomDistanceEnd B  "+n.distance);else if("PinchPanRotate"===n.name&&this.currentState===this.params.STATE.TOUCH_TILT)this.currentY=n.touches[0].currentPosition.y;else if("PinchPanRotate"===n.name&&this.currentState===this.params.STATE.TOUCH_ROTATE){if(l.is(this.touchVeryFirst1)){var r=new e.Vector2(n.touches[0].currentPosition.x,n.touches[0].currentPosition.y),h=new e.Vector2(n.touches[1].currentPosition.x,n.touches[1].currentPosition.y),u=r.clone().sub(this.touchVeryFirst1).clone(),c=h.clone().sub(this.touchVeryFirst2).clone();if(0===this.choice&&n.distance<this.touchZoomDistanceStart*this.touchZoomStartFactor&&Math.abs(u.y)>Math.abs(2*u.x)&&Math.abs(c.y)>Math.abs(2*c.x))this.currentY=n.touches[0].currentPosition.y,this.setState(this.params.STATE.TOUCH_TILT),this.choice=1;else{this.touchLast1=r,this.touchLast2=h,this.touchZoomDistanceEnd=n.distance,!0===this.verbose&&d.log("touchZoomDistancend C "+n.distance),this.currentX=n.touches[0].currentPosition.x;n.touches[0].currentPosition.y;i=Math.floor((this.touchLast1.x+this.touchLast2.x)/2),s=Math.floor((this.touchLast1.y+this.touchLast2.y)/2),this.currentPan.set(i,s),0!==u.x&&0!==u.y&&0!==c.x&&0!==c.y&&(this.choice=-1)}}}else"Swipe"===n.name&&this.currentState===this.params.STATE.TOUCH_PAN&&this.currentPan.set(n.touches[0].currentPosition.x,n.touches[0].currentPosition.y)},touchend:function(t){if(!1===this.enabled)return!1;if(!0===this.verbose&&d.log("touchend "+this.startTouch),n.touchEnd(),this.startTouch=this.startTouch-1,this.touchVeryFirst1=null,this.getCurrentDir().length()>0&&this.currentState===this.params.STATE.TOUCH_PAN?(this.timeLeft=this.params.dampingTime,this.currentPan.copy(this.lastPan),this.lastMouseFocus=null):this.currentState===this.params.STATE.TOUCH_ROTATE?(this.timeLeftRotate=this.params.dampingTime,!0===this.verbose&&d.log(" damp rotate start ")):this.startTouch<=0&&(this.setState(this.params.STATE.NONE),this.startTouch=0,this.shiftKey=!1),!0===this.repickExact){var e=this.exactPick(this.zoomMouse);l.isOut(e,this.urban)?!0===this.verbose&&d.log(" no exact pick 8 !! "+l.displayVector(this.zoomFocus)):(this.zoomFocus=e,this._lastPick.copy(e)),this.repickExact=!1}},goToLatLonAlt:function(t){var e=l.toPos3D(this.urban,t.lat,t.lon,0);return this.moveTo(e,null,t.alt,1)},_getEvent:function(t){if(l.is(t.gesture)){var e=t.gesture.getEvents();if(l.is(e)&&e.length>0)return e[0].event}return null},getTime:function(){return l.is(this.openedAnimation)?this.openedAnimation.animationTime:0},setTime:function(t){if(l.is(t)){var e=0,i=1/0;if(l.is(this.openedAnimation)){var s=this.openedAnimation.getKeyframe(this.openedKeyframe.index-1);l.is(s)&&(e=s.time+1);var n=this.openedAnimation.getKeyframe(this.openedKeyframe.index+1);l.is(n)&&(i=n.time)}t>=e&&t<=i&&(this.openedKeyframe.time=t)}return this.openedKeyframe.time},setIndex:function(t){if(l.is(t)&&t>=0){var e=0;l.is(this.openedAnimation)&&(e=this.openedAnimation.size(),this.openedAnimation.duration()),t<e&&(this.openedKeyframe.index=t)}return this.openedKeyframe.index},recordKeyframe:function(){if(l.is(this.openedAnimation)){var t=this.getCurrentKeyframe(),e=this.openedKeyframe.index+1;if(e<=0)t.time=0;else if(e===this.openedAnimation.size())t.time=this.openedAnimation.duration()+this.defaulttimebetweenkeys;else{var i=0,s=0,n=this.openedAnimation.getKeyframe(e-1);l.is(n)?i+=l.is(n.time)?n.time:0:d.log("path error");var o=this.openedAnimation.getKeyframe(e);l.is(o)?s+=l.is(o.time)?o.time:i+this.defaulttimebetweenkeys:d.log("path error"),(t=this.getCurrentKeyframe()).time=.5*(i+s)}this.openedAnimation.addKeyframe(t,e),this.setIndex(this.openedKeyframe.index+1),this.updateOpenedKeyframe()}},removeKeyframe:function(){l.is(this.openedAnimation)&&(this.openedAnimation.removeKeyframe(this.openedKeyframe.index),this.updateOpenedKeyframe())},updateOpenedKeyframe:function(){if(l.is(this.openedAnimation)){var t=this.openedAnimation.getKeyframe(this.openedKeyframe.index);l.is(t)?this.setTime(t.time):(this.openedKeyframe.index=-1,this.openedKeyframe.time=-1)}},goToKeyframe:function(t){if(!l.is(this.openedAnimation))return null;var e=this.openedAnimation.goToKeyframe(this.openedKeyframe.index);return l.is(e)?(this.openedKeyframe.time=e.time,this.setCurrentAnimation(this.openedAnimation),!0):null},overWriteKeyframe:function(){if(!l.is(this.openedAnimation))return null;var t=this.getCurrentKeyframe();t.time=this.openedKeyframe.time,this.openedAnimation.setKeyframe(t,this.openedKeyframe.index),this.updateOpenedKeyframe()},play:function(){l.is(this.openedAnimation)&&this.setCurrentAnimation(this.openedAnimation),l.is(this.currentAnimation)&&this.currentAnimation.play()},setLoop:function(t){l.is(this.currentAnimation)&&this.currentAnimation.animation.setLoop(t)},pause:function(){l.is(this.currentAnimation)&&this.currentAnimation.pause()},stop:function(){l.is(this.currentAnimation)&&this.currentAnimation.stop()},setAnimationTime:function(t){var e=null;if(l.is(this.currentAnimation)?e=this.currentAnimation:l.is(this.openedAnimation)&&(e=this.openedAnimation),l.is(e))return!0===this.verbose&&d.log("anim set time : "+t),t=e.setTime(t),this.urban.USR.animId=Math.floor(1+t*this.timetoFps),t},setFile:function(t,e){if(l.is(e)){this.fichier=e;for(var i=JSON.parse(e),s=new a,n=0;n<i.length;n++)s.addKeyframe(new r(i[n]));this.paths[t]=new o(this,s,t,!1),this.setCurrentPath(t)}},getFile:function(){return l.is(this.openedAnimation)&&(this.fichier=JSON.stringify(this.openedAnimation.getKeyframes())),this.fichier},createPath:function(t){l.is(this.paths[t])||(this.paths[t]=new o(this,new a,t,!1))},setCurrentPath:function(t){l.is(this.paths[t])&&(this.openedAnimation=this.paths[t],this.setIndex(0))},readPthFile:function(t,i){var s,n,h,d,m,p=i.split("\n"),f=p.length,g=new e.Vector3,v=new a;for(s=0;s<f;s++){var y=p[s].split(" ");8===y.length&&(n=1e3*Number(y[0]),h=new e.Vector3(Number(y[1]),Number(y[2]),Number(y[3])).add(g).multiplyScalar(1),(d=new e.Quaternion(Number(y[4]),Number(y[5]),Number(y[6]),Number(y[7])).normalize()).normalize(),(m=new r({position:h,time:n})).setQuaternion(d),v.addKeyframe(m))}if(this.paths[t]=new o(this,v,t,!1),!0===this.debug){var b=v.getPositionSpline(),S=b.points;if(l.is(b.points)&&b.points.length>0){var _=new u.Color(1,0,0,1);for(s=0;s<b.points.length;s++)S[s]=b.points[s].clone();var T=c.createLineNode({points:S,width:500,color:_});for(T.name=t+"_line",this.urban.getView3D().getScene().add(T),S=b.getSpacedPoints(2e3),_=new u.Color(0,0,1,1),s=0;s<S.length;s++)S[s]=S[s].clone();(T=c.createLineNode({points:S,width:500,color:_})).name=t+"_spline",this.urban.getView3D().getScene().add(T)}}this.setCurrentPath(t)},updateZoomMouse:function(t){t.equals(this.zoomMouse)||(this.zoomMouse.copy(t),this.repickExact=!0,this.zoomFocus=null)},keydown:function(t){if(!1===this.enabled)return!1;if(!0!==this.urban._debugMode)return!1;var i=this.params.manipulationSpeedFactor*this.params.keysSpeed;i*=this.params.manipulationShiftSpeedFactor;var s=t.gesture.key,n=new e.Vector2;if("input"!==t.from[0].view.localName){var o=!1;switch(s){case this.params.Keys.PAN_LEFT:this.currentKeyOffset.x+=i,this.setState(this.params.STATE.KEYBOARD_PAN),o=!0;break;case this.params.Keys.PAN_FRONT:this.currentKeyOffset.y+=i,this.setState(this.params.STATE.KEYBOARD_PAN),o=!0;break;case this.params.Keys.PAN_RIGHT:this.currentKeyOffset.x-=i,this.setState(this.params.STATE.KEYBOARD_PAN),o=!0;break;case this.params.Keys.PAN_BACK:this.currentKeyOffset.y-=i,this.setState(this.params.STATE.KEYBOARD_PAN),o=!0;break;case this.params.Keys.ROTATE_LEFT:this.currentKeyAngle.x+=i,n.set(.5*this.screen.width+1,.5*this.screen.height+1),this.updateZoomMouse(n),this.setState(this.params.STATE.KEYBOARD_ROTATE),o=!0;break;case this.params.Keys.ROTATE_RIGHT:this.currentKeyAngle.x-=i,n.set(.5*this.screen.width+1,.5*this.screen.height+1),this.updateZoomMouse(n),this.setState(this.params.STATE.KEYBOARD_ROTATE),o=!0;break;case this.params.Keys.ROTATE_UP:this.currentKeyAngle.y+=i,n.set(.5*this.screen.width+1,.5*this.screen.height+1),this.updateZoomMouse(n),this.setState(this.params.STATE.KEYBOARD_ROTATE),o=!0;break;case this.params.Keys.ROTATE_DOWN:this.currentKeyAngle.y-=i,n.set(.5*this.screen.width+1,.5*this.screen.height+1),this.updateZoomMouse(n),this.setState(this.params.STATE.KEYBOARD_ROTATE),o=!0;break;case this.params.Keys.ZOOM_IN:this.currentKeyZoom.y+=i*(1/120*.05),n.set(.5*this.screen.width+1,.5*this.screen.height+1),this.updateZoomMouse(n),this.setState(this.params.STATE.KEYBOARD_ZOOM),o=!0;break;case this.params.Keys.ZOOM_OUT:this.currentKeyZoom.y-=i*(1/120*.05),n.set(.5*this.screen.width+1,.5*this.screen.height+1),this.updateZoomMouse(n),this.setState(this.params.STATE.KEYBOARD_ZOOM),o=!0;break;case this.params.Keys.RESET:this.resetMove();break;case this.params.Keys.KEYFRAME:this.recordKeyframe();break;case this.params.Keys.PLAY:this.play()}!0===o&&!0===this.verbose&&d.log("keydown"),!0===this._getEvent(t).shiftKey?this.shiftKey=!0:this.shiftKey=!1}},keyup:function(t){!0===this._getEvent(t).shiftKey?this.shiftKey=!0:this.shiftKey=!1},debugMove:function(){this.debug=!this.debug,this.debugMoveTo=!this.debugMoveTo},setParams:function(t){this.params=t},getParams:function(){return this.params},detachEvents:function(){},setCurrentHeight:function(t){this.terrainHeight!==t&&(this.terrainHeight=t)},pan2d:function(t){this.resetMove(),this.currentPan.copy(this.lastPan.set(.5*this.screen.width,.5*this.screen.height)),this.initPan(),this.currentPan.add(t),this.timeLeft=this.params.dampingTime,this.setState(this.params.STATE.KEYBOARD_PAN)},rotate2d:function(t){this.resetMove(),this.zoomFocus=null,this.lastX=this.currentX=.5*this.screen.width,this.currentY=this.lastY=.5*this.screen.width,this.currentX-=t.x,this.currentY-=t.y,this.timeLeftRotate=this.params.dampingTime,this.setState(this.params.STATE.KEYBOARD_ROTATE)},zoom2d:function(t){0!==t.y&&(this.resetMove(),this.zoomFocus=null,this.zoomStart.copy(this.zoomEnd.set(0,0)),this.zoomStart.y+=.05*t.y*.033,this.setState(this.params.STATE.KEYBOARD_ZOOM))},displayTarget:function(t){if(!0===this.params.targetDisplay){if(!l.is(this.targetDiv)){var i=document.getElementById("target_div");if(null===i)return;this.targetDiv=i}if(l.is(this.targetDiv))if(t){var s=new e.Vector2(.5*this.screen.width,.5*this.screen.height);l.is(this.zoomFocus)&&(s=this.viewpoint.getScreenPosition(this.zoomFocus)),this.targetDiv.style.visibility="visible",s.x-=.5*this.targetDiv.clientWidth,s.y-=.5*this.targetDiv.clientHeight,this.targetDiv.style.top=s.y+"px",this.targetDiv.style.left=s.x+"px"}else this.targetDiv.style.visibility="hidden"}},easing:function(t){return t*t*t*t*t},getLastPick:function(){return this._lastPick.clone()},getLastLatLon:function(){return f.proj(this.getLastPick(),f.getDefaultProjection(),"WGS84")},onMove:function(t){return i.subscribeTo(i.eventsList.pointOfView,t)},unsubscribe:function(t){return i.unsubscribe(t)},_onStopManip:function(t){this.resetMove()},_onEditEventBegin:function(t){}})}),define("DS/UrbanManipulator/UndergroundSelectionManipulator",["DS/Visualization/ThreeJS_DS","DS/UrbanManipulator/Manipulator","DS/UrbanManipulator/ManipulatorParams","DS/XCityTools/EventDispatcher"],function(t,e,i,s){"use strict";return e.extend({init:function(e,i,s,n){this._parent(e,i,s,n),this.selectingArea=!1,this.firstFinal=null,this.lastFinal=null,this.areaBL=null,this.areaTR=null,this.clickedPosition=new t.Vector2(0,0),this.currentPosition=new t.Vector2(0,0),this.previewCrop=!1,this.done=!1,this.tokenLeftMouseUp=null,this.tokenLeftMouseDown=null,this.tokenKeyDown=null},activate:function(){this.urban.getView3D().webGLV6Viewer.setManipulators({activated:!0,preActivate:!1}),this.initEvents()},deactivate:function(){this.urban.getView3D().webGLV6Viewer.setManipulators({activated:!1,preActivate:!1}),this.detachEvents()},initEvents:function(){if(!0!==this._initialized){s.Initialize(this.domElement);var t=this;this.changeEvent={type:"change"},this.mmoveToken=void 0;var e=function(e){t.mousedown(e),t.mmoveToken=s.subscribeToMouseMove(t.mousemove.bind(t))}.bind(t),i=function(e){t.mouseup(e),s.unsubscribe(t.mmoveToken),t.mmoveToken=void 0}.bind(t);this.unmin=function(e){t.unminimize(e)},this.tokenLeftMouseDown=s.subscribeToLeftMouseDown(e),this.tokenLeftMouseUp=s.subscribeToLeftMouseUp(i),this.tokenKeyDown=s.subscribeTo("/VISU/onKeyDown",this.keydown.bind(this)),this.domElement.onkeypress=function(){Debug.log("keypress baaby")},this.handleResize(),this._initialized=!0}},mousedown:function(e){var i=this._getEvent(e);if(0===i.button){var s=new t.Vector2(i.clientX,i.clientY),n=this.exactPick(s);null!==n&&(n.z=n.z/this.urban.USR.scale,this.clickedPosition=n)}},mouseup:function(e){0===this._getEvent(e).button&&this.previewCrop&&(this.done=!0,this.firstFinal=new t.Vector2(Math.min(this.clickedPosition.x,this.currentPosition.x),Math.min(this.clickedPosition.y,this.currentPosition.y)),this.lastFinal=new t.Vector2(Math.max(this.clickedPosition.x,this.currentPosition.x),Math.max(this.clickedPosition.y,this.currentPosition.y)))},mousemove:function(e){var i=this._getEvent(e);if(0===i.button){var s=new t.Vector2(i.clientX,i.clientY),n=this.exactPick(s);null!==n&&(n.z=n.z/this.urban.USR.scale,this.previewCrop||(this.previewCrop=!0),this.currentPosition=n)}},update:function(){this.previewCrop&&(this.areaBL=new t.Vector3(Math.min(this.clickedPosition.x,this.currentPosition.x),Math.min(this.clickedPosition.y,this.currentPosition.y),Math.min(this.clickedPosition.z,this.currentPosition.z)),this.areaTR=new t.Vector3(Math.max(this.clickedPosition.x,this.currentPosition.x),Math.max(this.clickedPosition.y,this.currentPosition.y),Math.max(this.clickedPosition.z,this.currentPosition.z)))},detachEvents:function(){s.unsubscribe(this.tokenLeftMouseUp),s.unsubscribe(this.tokenLeftMouseDown),s.unsubscribe(this.tokenKeyDown)},getManipulationState:function(){return this.currentState},startAreaSelection:function(){this.selectingArea=!0},endAreaSelection:function(){},isSelectionDone:function(){return this.done},isPreviewEnabled:function(){return this.previewCrop},getFinalAreaBL:function(){return this.firstFinal},getFinalAreaTR:function(){return this.lastFinal},getAreaBL:function(){return this.areaBL},getAreaTR:function(){return this.areaTR},getData:function(){var t=(this.areaBL.z+this.areaTR.z)/2;return{xmin:this.areaBL.x,ymin:this.areaBL.y,xmax:this.areaTR.x,ymax:this.areaTR.y,height:t}}})}),define("DS/UrbanManipulator/UndergroundManipulator",["DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","DS/UrbanManipulator/Manipulator","DS/UrbanManipulator/ManipulatorParams","DS/UrbanManipulator/LocalisationManipulator","DS/UrbanManipulator/CameraAnimation","DS/UrbanManipulator/CameraAnimationPath","DS/UrbanManipulator/Keyframe","UWA/Class","DS/Visualization/Node3D","DS/UrbanTool/Utils","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Debug"],function(t,e,i,s,n,o,a,r,h,l,u,c,d,m){"use strict";return i.extend({init:function(t,e,i,s,n){this._parent(t,e,i,s),this.type="underground",this.undergroundVisu=n},mousedown:function(e){if(!1===this.enabled)return!1;var i=this._getEvent(e);if(!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,!0===this.verbose&&m.log("mousedown "+i.button),this.isFrom3dViewer(i)){if(this.resetMove(),this.lastX=i.clientX,this.lastY=i.clientY,this.currentX=i.clientX,this.currentY=i.clientY,this.currentXY=new t.Vector2(i.clientX,i.clientY),this.currentState===this.params.STATE.NONE){var s=i.button;!0===i.ctrlKey&&(s===this.params.STATE.PAN?s=this.params.STATE.NONE:s===this.params.STATE.ROTATE&&(s=this.params.STATE.PAN)),this.setState(s)}var n=new t.Vector2(i.clientX,i.clientY);return!0===this.verbose&&m.log(u.displayVector(n)),u.is(this.zoomMouse)&&n.equals(this.zoomMouse)||(this.zoomMouse.copy(n),this.repickExact=!0,this.zoomFocus=null),this.currentState!==this.params.STATE.ROTATE||this.params.noRotate?this.currentState!==this.params.STATE.ZOOM||this.params.noZoom?this.currentState!==this.params.STATE.PAN||this.params.noPan||(this.currentPan.set(i.clientX,i.clientY),this.lastPan.set(i.clientX,i.clientY),this.initPan(),!0===this.verbose&&m.log("mousedown"+u.displayVector(this.lastPan))):this.zoomStart=this.zoomEnd=this.getMouseOnScreen(i.clientX,i.clientY):(this.repickExact=!0,this.zoomFocus=null),this.buttonDown=1,!1}},mousemove:function(e){if(!1===this.enabled)return!1;var i=this._getEvent(e);!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,this.currentXY=new t.Vector2(i.clientX,i.clientY),this.currentState!==this.params.STATE.ROTATE||this.params.noRotate?this.currentState!==this.params.STATE.ZOOM||this.params.noZoom?this.currentState!==this.params.STATE.PAN||this.params.noPan||(this.currentPan.set(i.clientX,i.clientY),!0===this.verbose&&m.log("mousemove"+u.displayVector(this.currentPan))):this.zoomEnd=this.getMouseOnScreen(i.clientX,i.clientY):(this.currentX=i.clientX,this.currentY=i.clientY,this.noPick=!0),!0===this.verbose&&m.log("mousemove")},mouseup:function(t){if(!1===this.enabled)return!1;var e=this._getEvent(t);if(this.shiftKey=!1,!0===this.verbose&&m.log("mouseup"),this.noPick=null,this.currentState===this.params.STATE.PAN?(this.timeLeft=this.params.dampingTime,!0===this.verbose&&m.log(" damp pan start ")):this.currentState===this.params.STATE.ROTATE&&(this.timeLeftRotate=this.params.dampingTime,!0===this.verbose&&m.log(" damp rotate start ")),this.lastX===e.clientX&&(this.lastY,e.clientY),this.buttonDown=0,!0===this.repickExact){var i=this.exactPick(this.zoomMouse);u.isOut(i,this.urban)?!0===this.verbose&&m.log(" no exact pick !! "+u.displayVector(this.zoomFocus)):(this.zoomFocus=i,this._lastPick.copy(i)),this.repickExact=!1}},mousewheel:function(e){if(!1===this.enabled)return!1;var i=this._getEvent(e);!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,u.is(i)&&i.preventDefault(),this.resetPan(),this.resetRotate();var s=0;i.wheelDelta?s=i.wheelDelta/40:i.detail&&(s=-i.detail),s=s>0?3:-3,!0===this.verbose&&m.log("wheel "+s),this.setState(this.params.STATE.ZOOM),this.zoomStart.y+=1/s*.05;var n=new t.Vector2(i.clientX,i.clientY);u.is(this.zoomMouse)&&n.equals(this.zoomMouse)||(this.zoomMouse.copy(n),this.repickExact=!0)},exactPick:function(t,e){!0===this.verbose&&m.log(" exact pick ..."),e&&(this.undergroundVisu._renderPassManager.disablePass(this.undergroundVisu._undergroundStencilPass_id),this.undergroundVisu._renderPassManager.disablePass(this.undergroundVisu._windowFillPass_id),this.undergroundVisu._renderPassManager.disablePass(this.undergroundVisu._undergroundClearDepthPass_id),this.undergroundVisu._renderPassManager.disablePass(this.undergroundVisu._undergroundPostPass_id));var i=this.viewpoint.exactPick(t);return e&&(this.undergroundVisu._renderPassManager.enablePass(this.undergroundVisu._undergroundStencilPass_id),this.undergroundVisu._renderPassManager.enablePass(this.undergroundVisu._windowFillPass_id),this.undergroundVisu._renderPassManager.enablePass(this.undergroundVisu._undergroundClearDepthPass_id),this.undergroundVisu._renderPassManager.enablePass(this.undergroundVisu._undergroundPostPass_id)),u.is(i)?i:(!0===this.verbose&&m.log("pas dintersection ..."),null)}})}),define("DS/UrbanManipulator/DrawingManipulator",["DS/Manipulators/PointHandle","DS/UrbanAPI/xCityItem","DS/UrbanManipulator/Manipulator","DS/XCityTools/Geocoder","DS/UrbanTool/Utils","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/UrbanTool/DrawingManipulatorTool","DS/xCityBasicUtils/DataFormatTools","DS/SceneGraphNodes/FixedSizeNode3D","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Robot/LineTranslationNode","DS/XCityTools/ShaderTools"],function(t,e,i,s,n,o,a,r,h,l,u,c,d,m){"use strict";return i.extend({init:function(t,e,i,s,o){this.anchorRootNode=new d,this.anchorOffsetNode=new d,this._inverseCoordinate=new c.Matrix4,this._parent(t,i,s,o),this.urban=t,this.tool=this._getTool(e)||new r(t),this.type=this.tool.type,this.clickToken=null,this.doubleClickToken=null,this.onUpdateToken=null,this.urban.getView3D()._rootProjShifted.addChild(this.anchorOffsetNode),this.anchorOffsetNode.addChild(this.anchorRootNode),this.clickedColor=new c.Color("#00BFFE"),this.pointColor=new c.Color("#FFFFFF"),this.segmentColor=new c.Color("red"),this._defaultRoofHeight=this.tool.isHouse()?2:0,this._defaultRoofAngle=45,this._defaultHouseWidth=10,this._defaultHouseLength=5,this._defaultExtrusionHeight=10,this._destroyBinding=this._destroyFeature.bind(this),this._visibleBinding=this._visibilityFeature.bind(this),this._coordinateBinding=this._coordinateChange.bind(this),this._geojsonBinding=this._geojsonChange.bind(this),this._clicks=[],this._doubleclicks=[],this._lastsClicks=[],this.params.cursorChangeDelay=15;var a=n.getBuildingGISPropertiesMap();this.floorNumberAttribute=a.floors,this.floorHeightAttribute=a.floorHeight,this.groundFloorHeightAttribute=a.groundFloorHeight,this.roofHeightAttribute=a.roofHeight,this.roofAngleAttribute=a.roofAngle,this.roofShapeAttribute=a.roofShape,this.heightAttribute=a.height,this.altitudeAttribute=a.altitude,this.otherVerbose=!1,this.initialState()},_getTool:function(t){if(n.is(t))return t instanceof r?t:function(t){var e=new(r.extend(t))(this.urban);for(var i in t)e[i]=t[i];return e}.call(this,t)},initialState:function(){this._removeAllAnchors(),this.anchorRootNode.setVisibility(!0),this.anchorRootNode.setMatrix(new c.Matrix4),this._inverseCoordinate.identity(),this.nbFeatures=1,this._lastGeojsonData=null,this.currentGeometryType=null,this.currentShapeReference=null,this.lastClickedPH=null,this.preSelectedPh=null,this.justAddedPh=null,this.urban.USR.disableRobot(),this._lastItem=null,this._currentExtrusionHeight=this._defaultExtrusionHeight,this._roofHeight=null,this._lastAltitude=0},_removeAllAnchors:function(){this._removeAllPointHandle(this.anchorList),this.removeExtrusionHandle(),this.removeVerticalNode(),this.removeSegmentHandle(),this.preSelectedPh=null,this.anchorList=[],this.loop=!1},_removeAllPointHandle:function(){this.anchorRootNode.removeChildren()},drawShape:function(t){n.is(t)&&(t=n.clone(t)),this._lastGeojsonData=t;var e=h.fromJSONToArray(this._lastGeojsonData),i=this._getFirstShape(e,void 0);if(n.is(i)){this.currentShapeReference=i.index,this.currentGeometryType=this._lastGeojsonData.features[0].geometry.type,this._initAnchorListFromArray(i.coords,0);var s=this.anchorList[this.anchorList.length-1];s.loopEnd&&(s=this.anchorList[this.anchorList.length-2]),this.setLastClickedPH(s.ph)}return this.setCursor(),this.updateLine()},_getFirstShape:function(t,e){var i,s=!1;if(!n.is(t))return null;if(i=t,n.is(i)&&Array.isArray(i)&&this._containsPoints(i)&&(s=!0),!s){e||(e="0");i=t[0],n.is(i)&&Array.isArray(i)&&(this._containsPoints(i)?s=!0:e+=".0")}return n.is(i)?s?{coords:i,index:e}:this._getFirstShape(i,e):null},_initAnchorListFromArray:function(t,e){this.anchorList=[],this._initinProgress=!0;var i,s=this,o=!1,a=!0,r=0;return this.tool.isBuilding()&&this._lastGeojsonData&&this._lastGeojsonData.features&&this._lastGeojsonData.features[0]&&this._lastGeojsonData.features[0].properties&&(r=this._lastGeojsonData.features[0].properties[this.altitudeAttribute]||0),n.is(t)&&Array.isArray(t)?(i=t[0],this._containsPoints(t)?t.forEach(function(t){var n=new c.Vector3(t[0],t[1],t[2]||r),h=s.pos3DToScreenPos(n),l=!0;s._samePoint(i,t)&&(o&&(s._createLoop(),l=!1),o=!0),l&&(s._addAnchor(n,h,e,!0)||(a=!1))}):console.log("not a coordinate list")):a=!1,this._initinProgress=!1,a},_insertAnchor:function(t,e){this.anchorList.splice(e,0,t);for(var i=e;i<this.anchorList.length;i++)this.anchorList[i].ph.index=i},_addAnchor:function(t,e,i,s){var o=this.anchorList.length,a=!0;if(n.is(t)&&n.is(e)&&t instanceof c.Vector3&&(e instanceof c.Vector3||e instanceof c.Vector2)){if(this.tool.isSquare()&&this.anchorList.length>=2)return;if(this.tool.isHouse()&&this.anchorList.length>=0&&(a=!1,s&&this.anchorList.length>=1))return;var r;if(this.tool.isPoint()&&(a=!1),o)if(this.anchorList[o-1].ph.pos3D.distanceTo(t)<.001)return!1;var h={ph:r=!0===a?this._createPointHandle(t,e):{notaNode:!0,text:{innerHTML:""},pos3D:t,pos2D:e,setFillColor:function(){},addChild:function(){}},featureIndex:i||0};if(!0!==s&&!0===this.tool.smartInsert){var l=this.getinsertPointInClosestSegment(t);this._insertAnchor(h,l+1)}else n.is(this.lastClickedPH)&&!0===a?(this._insertAnchor(h,this.lastClickedPH.index+1),this.setLastClickedPH(h.ph)):this.anchorList.push(h);a&&(this.justAddedPh=r,this.tool.onAddAnchor(r,this.anchorList))}return o<this.anchorList.length},_removeAnchor:function(e){var i=this.anchorList.length;if(e instanceof t){var s=e.index;this.tool.onRemoveAnchor(e,this.anchorList),this.anchorRootNode.remove(e),this.anchorList.splice(e.index,1),!0===this.otherVerbose&&console.log("removeanchor",e.index,e.pos3D);for(var n=0;n<this.anchorList.length;n++)this.anchorList[n].ph.index=n;this.loop&&(3===this.anchorList.length?this._breakLoop():0===s&&(this._breakLoop(),this._createLoop())),this.preSelectedPh=null,this.updateLine()}return i>this.anchorList.length},_createPointHandle:function(e,i){var s,o=new t({viewer:this.urban.getView3D().webGLV6Viewer,sceneGraph:this.anchorRootNode});return n.is(this._pointTexture)?o.pointMat.map=this._pointTexture:this._pointTexture=o.pointMat.map,o.index=this.anchorList.length,o.pos3D=e,o.pos2D={x:i.x,y:i.y},o.name="ph_"+this.anchorList.length,s=e,o.setMatrix((new c.Matrix4).setPosition(s)),o.setSize(20),o.setFillColor(this.pointColor),this._attachCallbacks(o),o},removeVerticalNode:function(){var t;if(n.is(this._verticalHandleNode)){for(t=0;t<this._verticalHandleNode.parents.length;t++)this._verticalHandleNode.parents[t].removeChild(this._verticalHandleNode);this._verticalHandleNode=null}if(n.is(this._fixedSizeNode3D)){for(t=0;t<this._fixedSizeNode3D.parents.length;t++)this._fixedSizeNode3D.parents[t].removeChild(this._fixedSizeNode3D);this._fixedSizeNode3D=null}},removeExtrusionHandle:function(){var t;if(n.is(this._extrusionHandleNode)){for(t=0;t<this._extrusionHandleNode.parents.length;t++)this._extrusionHandleNode.parents[t].removeChild(this._extrusionHandleNode);this._extrusionHandleNode=null}if(n.is(this.extrusionPositionNode)){for(t=0;t<this.extrusionPositionNode.parents.length;t++)this.extrusionPositionNode.parents[t].removeChild(this.extrusionPositionNode);this.extrusionPositionNode=null}},createExtrusionHandle:function(){if(this.tool.isBuilding()){if(n.is(this._extrusionHandleNode))return void(this.extrusionPositionNode&&this.extrusionPositionNode.updateHandlePosition());var t=this;this._extrusionHandleNode=new m({touchMode:!0}),n.is(this._verticalTexture)?this._extrusionHandleNode.mat.map=this._verticalTexture:this._verticalTexture=this._extrusionHandleNode.mat.map,this._extrusionHandleNode.modelEvents=this._extrusionHandleNode._modelEvent,this._extrusionHandleNode.setRenderPasses(["noz"]);var e=new l({name:"extrusionFixedSizeNode3D",ratio:7});e.addChild(this._extrusionHandleNode),this._extrusionHandleNode.subscribe({event:"LineTranslationBegin"},function(){t.enabled=!1,t._extrusionHandleNode.initialMatrix=(new c.Matrix4).copy(t.extrusionPositionNode.getMatrix()),!0===t.tool.altitudeDisplay&&(t._extrusionHandleNode.altitudeEffect=t.urban.getView3D().getAltitudeEffect(),t._extrusionHandleNode.altitudeEffect.enableEffect())}),this._extrusionHandleNode.subscribe({event:"LineTranslationManipulation"},function(e){var i=e.translationVector,s=new c.Vector3;if(s.getPositionFromMatrix(t._extrusionHandleNode.initialMatrix),s.add(i),t._extrusionHandleNode.altitudeEffect){t._extrusionHandleNode.altitudeEffect.disableEffect();var n=(new c.Vector3).getPositionFromMatrix(t._extrusionHandleNode.getMatrixWorld());t._extrusionHandleNode.altitudeEffect._currentZ=n.z,t._extrusionHandleNode.altitudeEffect.enableEffect()}t.updateRoofAltitude(s.z),t.updateLine()}),this._extrusionHandleNode.subscribe({event:"LineTranslationEnd"},function(){t.enabled=!0,t._extrusionHandleNode.altitudeEffect&&(t._extrusionHandleNode.altitudeEffect.disableEffect(),t._extrusionHandleNode.altitudeEffect=null)}),this.extrusionPositionNode=new d,this.extrusionPositionNode.updateHandlePosition=function(){for(var e=[],i=0;i<t.anchorList.length;i++)!0!==t.anchorList[i].loopEnd&&e.push(t.anchorList[i].ph.pos3D);var s=o.compute2DPolygonCentroid(e),n=new c.Vector3(s.x,s.y,0),a=t._getShapeAltitude(),r=t._getShapeExtrusionHeight(),h=t._getRoofHeight();n.z=a+r+h,this.setMatrix((new c.Matrix4).setPosition(n))},this.extrusionPositionNode.updateHandlePosition(),this.extrusionPositionNode.addChild(e),t.anchorRootNode.addChild(this.extrusionPositionNode)}else this.removeExtrusionHandle()},_createVerticalPointHandle:function(){this.removeVerticalNode();var t=this;this._verticalHandleNode=new m({touchMode:!0}),n.is(this._verticalTexture)?this._verticalHandleNode.mat.map=this._verticalTexture:this._verticalTexture=this._verticalHandleNode.mat.map,this._verticalHandleNode.modelEvents=this._verticalHandleNode._modelEvent,this._verticalHandleNode.setRenderPasses(["noz"]);var e=this._verticalHandleNode.getMatrix().setPosition(new c.Vector3(0,0,2));this._verticalHandleNode.setMatrix(e),this._fixedSizeNode3D=new l({name:"fixedSizeNode3D",ratio:7}),this._fixedSizeNode3D.addChild(this._verticalHandleNode),this._verticalHandleNode.subscribe({event:"LineTranslationBegin"},function(e){t.enabled=!1,t._verticalHandleNode.initialMatrix=(new c.Matrix4).copy(t.lastClickedPH.getMatrix()),!0===t.tool.altitudeDisplay&&(t._verticalHandleNode.altitudeEffect=t.urban.getView3D().getAltitudeEffect(),t._verticalHandleNode.altitudeEffect.enableEffect())}),this._verticalHandleNode.subscribe({event:"LineTranslationManipulation"},function(e){var i=e.translationVector,s=new c.Vector3;if(s.getPositionFromMatrix(t._verticalHandleNode.initialMatrix),s.add(i),t._verticalHandleNode.altitudeEffect){t._verticalHandleNode.altitudeEffect.disableEffect();var n=t._verticalHandleNode.getMatrixWorld().getPosition();t._verticalHandleNode.altitudeEffect._currentZ=n.z,t._verticalHandleNode.altitudeEffect.enableEffect()}t.updateAnchorListZ(s.z,void 0,e.event.from[0].deltaPosition.y),t._segmentHandle&&t._segmentHandle.updateSegmentHandlePosition(),t.extrusionPositionNode&&t.extrusionPositionNode.updateHandlePosition(),t.updateLine()}),this._verticalHandleNode.subscribe({event:"LineTranslationEnd"},function(e){t.enabled=!0,t._verticalHandleNode.altitudeEffect&&(t._verticalHandleNode.altitudeEffect.disableEffect(),t._verticalHandleNode.altitudeEffect=null)})},updateAnchorZ:function(t,e){if(t.getMatrix){var i=(new c.Matrix4).copy(t.getMatrix()),s=i.getPosition();s.z=e,t.setMatrix(i.setPosition(s))}t.pos3D.z=e;var n=this.pos3DToScreenPos(t.pos3D);t.pos2D={x:n.x,y:n.y},this.tool.onManipulateAnchor(t,this.anchorList)},updateAnchorListZ:function(t,e){if(this.tool.isPolygon())if(n.is(e))this.updateAnchorZ(this.anchorList[e].ph,t);else for(var i=0;i<this.anchorList.length;i++)this.updateAnchorZ(this.anchorList[i].ph,t);else n.is(this.lastClickedPH)&&(e=this.lastClickedPH.index,n.is(e)&&this.updateAnchorZ(this.anchorList[e].ph,t))},_attachCallbacks:function(t){var e=this;t.subscribe("Manipulate",function(i){!0===e.tool.altitudeDisplay&&(e.tool.isPolygon()||t.altitudeEffect||(t.altitudeEffect=e.urban.getView3D().getAltitudeEffect(),t.altitudeEffect.enableEffect()));var s,o,a=i.event.from[0].currentPosition,r=!1;if(n.is(e.lastClickedPH)&&(r=t.id===e.lastClickedPH.id),e._lastItem&&e._lastItem.impl.getContent()._node&&(s=e._lastItem.impl.getContent()._node.getPickable(),e._lastItem.impl.getContent()._node.setPickable(u.NOPICKABLE)),t.setPickable(u.NOPICKABLE),t.altitudeEffect?(t.altitudeEffect.disableEffect(),o=e._getClicked3DPosition(a,r),t.altitudeEffect.enableEffect()):o=e._getClicked3DPosition(a,r),t.setPickable(u.PICKABLE),e._lastItem&&e._lastItem.impl.getContent()._node&&e._lastItem.impl.getContent()._node.setPickable(s),n.is(o)){t.altitudeEffect&&(t.altitudeEffect._currentZ=o.z);var h=o.clone();n.is(e._inverseCoordinate)&&(h.applyMatrix4(e._inverseCoordinate),o=h),h=o,t.setMatrix((new c.Matrix4).setPosition(h)),t.pos3D=o,t.pos2D={x:a.x,y:a.y},!e.tool.isPolygon()&&e.loop&&0===t.index&&(e.anchorList[e.anchorList.length-1].ph.pos3D=t.pos3D),e.tool.onManipulateAnchor(t,e.anchorList),e.updateLine(),t._segmentPH&&t._segmentPH.updateSegmentHandlePosition(),e.extrusionPositionNode&&e.extrusionPositionNode.updateHandlePosition()}}),t.subscribe("BeginManipulate",function(i){t.locked=!0,e.enabled=!1}),t.subscribe("EndManipulate",function(i){t.locked=!1,t.altitudeEffect&&(t.altitudeEffect.disableEffect(),t.altitudeEffect=null),e.enabled=!0}),t.subscribe("BeginPreactivate",function(i){e.preSelectedPh=t,e.tool.onBeginPreactivateAnchor(t,e.anchorList)}),t.subscribe("Preactivate",function(t){}),t.subscribe("EndPreactivate",function(i){e.tool.onEndPreactivateAnchor(t,e.anchorList),e.preSelectedPh=null,e.setCursor()})},_createLoop:function(){if(!(this.tool.isPolygon()||this.anchorList.length<=2)){if(this.loop=!0,this.anchorList[0].ph.pos3D.clone().sub(this.anchorList[this.anchorList.length-1].ph.pos3D).length()>.01){var t={ph:{pos3D:this.anchorList[0].ph.pos3D},featureIndex:0,loopEnd:!0};this.anchorList.push(t)}return this.tool.isPolyline()&&this.lastClickedPH&&(this._createSegmentHandle(),this.lastClickedPH.addChild(this._segmentHandle)),this.tool.onCreateLoop(this.anchorList)||!0}},_breakLoop:function(t){if(!this.tool.isPolygon()){if(this.loop=!1,this.anchorList.splice(this.anchorList.length-1,1),n.is(t)){var e,i=[],s=this.anchorList.length;for(e=0;e<s;e++){var o=this.anchorList[(e+t)%s];i.push(o)}for(this.anchorList=i,e=0;e<this.anchorList.length;e++)this.anchorList[e].ph.index=e}return this.removeSegmentHandle(),this.tool.onBreakLoop(this.anchorList)||!0}},_getCurrentGEOJSON:function(){var t=[];this._addCoordinatesTo(t,0);var e=this._lastGeojsonData;if(n.is(e)){var i=this.currentShapeReference?this.currentShapeReference.split("."):null,s=e.features[0].geometry.type,o=this._getGeometryTypeFromLength(t.length);if(o.toLowerCase()!==s.toLowerCase())this.tool.isPolygon()&&(this.loop="polygon"===o.toLowerCase(),this.loop?(this.currentShapeReference+=".0",this.createExtrusionHandle()):(this.removeExtrusionHandle(),this.currentShapeReference=this.currentShapeReference.substring(0,this.currentShapeReference.length-2))),h.updateFeatureType(e,t,i,o);else if("point"===s.toLowerCase()&&(i=null),"polygon"===s.toLowerCase()?(this.loop=!0,this.createExtrusionHandle()):this.removeExtrusionHandle(),this.tool.isHouse()){var a=0;for(a=0;a<t.length;a++){i=[a,0];var r=this._createRectangleCoordinates(t[a]);h.updateGeoJSON(e,r,i)}}else h.updateGeoJSON(e,t,i)}else{var l=this._getGeometryTypeFromLength(t.length);if(this.tool.isHouse()&&t.length>0){r=this._createRectangleCoordinates(t[0]);e=h.fromCoodinatesToJSON(r,l)}else e=h.fromCoodinatesToJSON(t,l);if(e.crs={type:"name",properties:{name:this.urban.baseProjection}},!this.tool.isBuilding()||l.toLowerCase()!==this.currentGeometryType.toLowerCase()){this.tool.isPolygon()&&(this.loop=!0,this.createExtrusionHandle()),this._lastGeojsonData=e;var u=this._getFirstShape(h.fromJSONToArray(e),"0");n.is(u)&&(this.currentShapeReference=u.index)}}return e},_initGeojsonFromCoordinates:function(){},_getGeometryTypeFromLength:function(t){var e;return n.is(this.currentGeometryType)||(this.currentGeometryType=this.tool.getGeoJSONType(!0)),e=this.currentGeometryType,this.tool.isHouse()?"Polygon":"point"===e.toLowerCase()?e:(t<3&&(e="LineString",t<2&&(e=null)),e)},updateLine:function(){if(this.anchorList.length>0&&("point"===this.tool.getGeoJSONType()||this.anchorList.length>1||this.tool.isHouse())){var t=this._getCurrentGEOJSON();this.tool.onUpdate(this.loop,this.anchorList),this.robotHasBeenSet=!1;let i=function(){!this.robotHasBeenSet&&this.tool.isRobotEnabled()&&this._lastItem&&(xCity.enableRobot(!0,this._lastItem),this.robotHasBeenSet=!0)}.bind(this);var e=this._createShape(t,i);if(e){this._lastItem=e;for(let t in e.impl._itemParent._attributes.children._models){let i=e.impl._itemParent._attributes.children._models[t];xCity._urbanImpl.modelSelection.selection[i.id]&&xCity._urbanImpl.getView3D()._modelHightlighter.highlight(i)}let t=e.impl.getContent()._node&&e.impl.getContent()._node.children&&e.impl.getContent()._node.children.length;!this.robotHasBeenSet&&t&&(xCity.enableRobot(!0,this._lastItem),this.robotHasBeenSet=!0)}return this._lastItem}return this._lastItem=this._clear(),this.urban.USR.disableRobot(),this._lastItem},_modifyCoordinates:function(t,e){return"polygon"===e?[t]:t},_createShape:function(t,e){var i;if(i=this._drawShape(t,e),n.is(i)){if(n.is(i.impl)){i.impl.removeEvent("onDestroy",this._destroyBinding),i.impl.removeEvent("onChange:visible",this._visibleBinding),i.impl.addEvent("onDestroy",this._destroyBinding),i.impl.addEvent("onChange:visible",this._visibleBinding);var s=i.impl.getContent();if(s.removeEvent("onChange:geojson",this._geojsonBinding),s.addEvent("onChange:geojson",this._geojsonBinding),this.tool.isRobotEnabled()){var o=s.get("Coordinate");n.is(o)&&(o.removeEvent("onChange:matrix",this._coordinateBinding),o.addEvent("onChange:matrix",this._coordinateBinding),this._coordinateChange(o.getMatrix()))}}return i.set("geojson",t),this._visibilityFeature(i),i}return!1},_destroyFeature:function(t){this.tool.onDestroy(t.get("id"),this.anchorList),this.initialState()},_visibilityFeature:function(t){var e=t.get("visible");this.anchorRootNode.setVisibility(e)},_addCoordinatesTo:function(t,e){var i,s=this.anchorList.length;if(n.is(e)&&"number"==typeof e||(e=0),Array.isArray(t))for(i=0;i<s;i+=1)this.anchorList[i].featureIndex===e&&t.push([this.anchorList[i].ph.pos3D.x,this.anchorList[i].ph.pos3D.y,this.anchorList[i].ph.pos3D.z/this.urban.getView3D().getScale()])},_drawShape:function(t,e){var i=this.tool.getGeoJSONType(this.loop);n.is(t)&&n.is(t.features)&&n.is(t.features[0])&&n.is(t.features[0].geometry)&&n.is(t.features[0].geometry.type)&&(i=t.features[0].geometry.type.toLowerCase()),this.shouldOffset=!1;return{linestring:this._drawLine,LineString:this._drawLine,polygon:this._drawPolygon,point:this._drawPoints}[i].call(this,t,e)||!1},_drawLine:function(t){var i=this._getFeature(),s=this._getLineContentJSON(t);if(i instanceof e){var o=i.impl.getContent().get("Coordinate");n.is(o)&&(s.Coordinate=o.toJSON()),i.reload(s)}else if(this._clear(),(i=this._getFeature()).feature.Content=s,i=xCity.add3DContent(i),this.tool.onItemCreated(i.get("id")),this.tool.isBuilding()){var a={color:"white",opacity:.7,renderMode:"occluded"};i.set("Rendering",a)}return i},_drawPoints:function(t,i){var s,o,a,r=h.initGeoJsonObject();if(r.features[0]=t.features[0],(s=this._getFeature())instanceof e){(a=s.impl.getContent().toJSON()).geojson=r;var l=s.impl.getContent().get("Coordinate");n.is(l)&&(a.Coordinate=l.toJSON()),s.reload(a)}else this._clear(),s=this._getFeature(),a=this._getPointContentJSON(r),s.feature.Content=a,s.readyCB=i,s=xCity.add3DContent(s),this.tool.onItemCreated(s.get("id"));if(o=a.geojson,t.features.length>1){for(var u=1;u<t.features.length;u++){if(this.tool.onNewShape()){if((r=h.initGeoJsonObject()).features[0]=t.features[u],s=this._getFeature(),a=this._getPointContentJSON(r),s instanceof e){l=s.get("Coordinate");n.is(l)&&(a.Coordinate=l.toJSON()),s.reload(a)}else this._clear(),(s=this._getFeature()).feature.Content=a,s.readyCB=i,s=xCity.add3DContent(s),this.tool.onItemCreated(s.get("id"));o=a.geojson}}this.resetAsOneFeature(o,t)}return s},resetAsOneFeature:function(t,e){t&&(e.features=t.features,this.initialState(),this.drawShape(t))},updateGeoJSONCoordinates:function(t,e){var i;for(i=0;i<t.features.length;i++)t.features[i],e.features[i].properties=t.features[i].properties;return e},_drawPolygon:function(t){if(this.tool.isBuilding())return this._drawBuilding(t);if(this.tool.isHouse())return this._drawHouse(t);var i,s=this._getFeature();if(t&&t.features&&t.features[0]&&t.features[0].properties&&(t.features[0].properties[this.altitudeAttribute]=this._getShapeAltitude()),this.resetZfromPolygonandanchors(t),this.shouldOffset=!0,s instanceof e&&"Polygon"===s.get("className")){i=this._getPolygonContentJSON(t);var o=s.impl.getContent().get("Coordinate");n.is(o)&&(i.Coordinate=o.toJSON()),s.reload(i)}else this._clear(),s=this._getFeature(),i=this._getPolygonContentJSON(t),s.feature.Content=i,s=xCity.add3DContent(s),this.tool.onItemCreated(s.get("id"));return s},_drawBuilding:function(t){var i,s=this._getFeature(),o=t.features[0].properties[this.floorNumberAttribute];n.is(o)?this._lastNbFloors=o:o=n.is(this._lastNbFloors)?this._lastNbFloors:1;var a=t.features[0].properties[this.floorHeightAttribute];n.is(a)?this._lastFloorHeight=a:a=n.is(this._lastFloorHeight)?this._lastFloorHeight:2.7;var r=t.features[0].properties[this.groundFloorHeightAttribute];n.is(r)?this._lastGroundFloorHeight=r:r=n.is(this._lastGroundFloorHeight)?this._lastGroundFloorHeight:a,t.features[0].properties[this.heightAttribute]=r+(o-1)*a,t.features[0].properties[this.altitudeAttribute]=this._getShapeAltitude(),t.features[0].properties[this.floorNumberAttribute]=o,t.features[0].properties[this.floorHeightAttribute]=a,t.features[0].properties[this.groundFloorHeightAttribute]=r;var h=t.features[0].properties[this.roofHeightAttribute];n.is(h)||(h=this._roofHeight=this._defaultRoofHeight),n.is(this._roofHeight)||(this._roofHeight=h),t.features[0].properties[this.roofHeightAttribute]=this._roofHeight;var l=t.features[0].properties[this.roofAngleAttribute];if(n.is(l)||(l=this._defaultRoofAngle),n.is(t.features[0].properties[this.roofAngleAttribute])||(t.features[0].properties[this.roofAngleAttribute]=l),n.is(t.features[0].properties[this.roofShapeAttribute])||(t.features[0].properties[this.roofShapeAttribute]="MANSARD"),s instanceof e&&"BuildingSet"===s.get("className")){(i=s.impl.getContent().toJSON()).geojson=t;var u=s.impl.getContent().get("Coordinate");n.is(u)&&(i.Coordinate=u.toJSON()),s.reload(i)}else this._clear(),s=this._getFeature(),i=this._getBuildingContentJSON(t),s.feature.Content=i,s=xCity.add3DContent(s),this.tool.onItemCreated(s.get("id"));return s.set("Rendering",{renderMode:"occluded"}),s},_drawHouse:function(t){for(var e,i=t.features.length,s=0;s<i;s++){var o;if(n.is(t.features[s].properties[this.roofShapeAttribute])||(t.features[s].properties[this.roofShapeAttribute]="GABLE"),(o=n.clone(t)).features=[t.features[s]],(e=this._drawBuilding(o)).set("rectangleBase",!0),i>1)if(s===i-1)this.resetAsOneFeature(o,t);else if(!this.tool.onNewShape()){this.resetAsOneFeature(o,t);break}}return e},_getFeature:function(t){var e=xCity.findItem({id:this.tool.getCurrentContext(t).Line.id});return n.is(e)?e:this._getFeatureJSON(t)},_getFeatureJSON:function(t){var e,i=this.tool.getCurrentContext(t);return!1===i.Folder.temporary?void 0===(e=xCity.findItem({id:i.Folder.id}))&&(e=xCity.addFolder({id:i.Folder.id,name:i.Folder.name})):e=xCity.getTemporaryFolder(i.Folder.id,i.Folder.name),{feature:{className:"Feature",name:i.Line.name,id:i.Line.id,visible:!0},parentFolder:e}},_getLineContentJSON:function(t){return{className:"Line",id:"drawing_line_id2",Coordinate:{isCreatedShape:!0,className:"Coordinate",position:[0,0,0],shifted:!1,projection:s.getDefaultProjection()},geojson:t||h.initGeoJsonObject()}},_getPolygonContentJSON:function(t){var e=0;return this.anchorList&&this.anchorList[0]&&this.anchorList[0].ph&&this.anchorList[0].ph.pos3D&&this.anchorList[0].ph.pos3D.z&&(e=this.anchorList[0].ph.pos3D.z/this.urban.getView3D().getScale()),this._lastAltitude&&(e=this._lastAltitude/this.urban.getView3D().getScale()),{className:"Polygon",id:"drawing_polygon_id",geojson:t||h.initGeoJsonObject(),Coordinate:{isCreatedShape:!0,className:"Coordinate",position:[0,0,e],shifted:!1,projection:s.getDefaultProjection()}}},_getBuildingContentJSON:function(t){return{className:"BuildingSet",id:"drawing_building_id",asynchronous:!1,rectangleBase:!1,geojson:t||h.initGeoJsonObject(),Coordinate:{isCreatedShape:!0,className:"Coordinate",position:[0,0,0],shifted:!1,projection:s.getDefaultProjection()}}},_getPointContentJSON:function(t){return t&&(t.crs={properties:{name:this.urban.baseProjection}}),{shapeType:"sphere",scale:8,shadingMode:"smooth",nameAttribute:"name",opacityFactor:.3,heightAttribute:10,renderAnchor:!0,switchDistance:500,className:"SimplePointOfInterest3D",id:"drawing_point_id",Coordinate:{isCreatedShape:!0,className:"Coordinate",position:[0,0,0],shifted:!1,projection:s.getDefaultProjection()},Clustering:!1,nbVertices:15,geojson:t||h.initGeoJsonObject()}},_clear:function(){var t=xCity.findItem({id:this.tool.getCurrentContext().Line.id});return void 0!==t&&(t.impl.removeEvent("onDestroy",this._destroyBinding),t.impl.removeEvent("onChange:visible",this._visibleBinding),xCity.removeChild(t),t.impl.addEvent("onDestroy",this._destroyBinding),t.impl.addEvent("onChange:visible",this._visibleBinding),!0)},setOtherClickedPh:function(){var t=0;n.is(this.lastClickedPH)&&(t=this.anchorList.length>1?(this.anchorList.length+this.lastClickedPH.index-1)%this.anchorList.length:-1);var e=null;this.anchorList[t]&&(this.anchorList[t].loopEnd&&(t=(this.anchorList.length+t-1)%this.anchorList.length),e=this.anchorList[t].ph),this.setLastClickedPH(e)},setLastClickedPH:function(t){return t?this.lastClickedPH&&(this.lastClickedPH.setFillColor(this.pointColor),t.id===this.lastClickedPH.id)?this.setOtherClickedPh():(this.lastClickedPH=t,this.lastClickedPH.setFillColor(this.clickedColor),this.updateVerticalHandle(),!1):(this.lastClickedPH=null,this.updateVerticalHandle(),!0)},updateVerticalHandle:function(){this.tool.hasVerticalHandle()&&(n.is(this.lastClickedPH)?(this._createVerticalPointHandle(),this.lastClickedPH.addChild(this._fixedSizeNode3D),n.is(this._fixedSizeNode3D)&&n.is(this._fixedSizeNode3D.parents)&&this._fixedSizeNode3D.parents.length>1&&n.is(this._fixedSizeNode3D.parents[0])&&this._fixedSizeNode3D.parents[0].removeChild(this._fixedSizeNode3D),this.tool.isPolyline()&&this.loop&&(this._createSegmentHandle(),this.lastClickedPH.addChild(this._segmentHandle))):n.is(this._fixedSizeNode3D)&&(this._fixedSizeNode3D.setVisibility(!1),n.is(this._segmentHandle)&&this._segmentHandle.setVisibility(!1)))},removeSegmentHandle:function(){var t;if(n.is(this._segmentHandle)){for(this._segmentHandle.startPh._segmentPH=null,this._segmentHandle.endPh._segmentPH=null,t=0;t<this._segmentHandle.parents.length;t++)this._segmentHandle.parents[t].removeChild(this._segmentHandle);this._segmentHandle=null,this.preSelectedSegment=null}},_createSegmentHandle:function(){this.removeSegmentHandle();var e=new t({viewer:this.urban.getView3D().webGLV6Viewer,sceneGraph:this.anchorRootNode});n.is(this._pointTexture)?e.pointMat.map=this._pointTexture:this._pointTexture=e.pointMat.map,e.index=this.lastClickedPH.index,e.startPh=this.lastClickedPH,this.lastClickedPH._segmentPH=e;var i=e.index-1;0===e.index&&(i=this.anchorList.length-1),e.othersideIndex=i;var s=this.anchorList[i];s.loopEnd&&(s=this.anchorList[i-1]),e.endPh=s.ph,e.endPh._segmentPH=e,e.updateSegmentHandlePosition=function(){var t=this.startPh.pos3D.clone().add(this.endPh.pos3D).multiplyScalar(.5);this.setMatrix((new c.Matrix4).setPosition(t))},e.name="segmentHandle"+this.anchorList.length,e.setSize(20),e.setFillColor(this.segmentColor),e.updateSegmentHandlePosition();var o=this;e.subscribe("BeginPreactivate",function(t){o.preSelectedSegment=e,o.setCursor()}),e.subscribe("EndPreactivate",function(t){o.preSelectedSegment=null,o.setCursor()}),this._segmentHandle=e},_getShapeAltitude:function(){return this.tool.isPolygon()&&this.anchorList.length>0?this.tool.isBuilding()&&this._lastGeojsonData&&this._lastGeojsonData.features&&this._lastGeojsonData.features[0]&&this._lastGeojsonData.features[0].properties&&this._lastGeojsonData.features[0].properties[this.altitudeAttribute]?this._lastGeojsonData.features[0].properties[this.altitudeAttribute]:this.anchorList[0].ph.pos3D.z:void 0},_getClicked3DPosition:function(t,e){var i,s;if(!0===e)s=this.lastClickedPH.pos3D,i=this.fromGeojsonPositionToAbsolute(s).z;else if(this.tool.isPolygon()){if(this.tool.isHouse()||!(this.anchorList.length>0)){var o=this.exactPick(t);if(n.is(o)){var a=t.clone();a.x+=1,a.y+=1;var r=this.exactPick(a);if(n.is(r)){var h=.5*o.distanceTo(r);o.z+=h}}return this._lastAltitude=o.z,o}s=this.anchorList[0].ph.pos3D,i=this.fromGeojsonPositionToAbsolute(s).z}return n.is(i)?this.pick2D(!0,t,i):this.exactPick(t)},_rememberClickedPh:function(t){this._lastsClicks.length>=2&&(this._lastsClicks=[this._lastsClicks[this._lastsClicks.length-1]]),this._lastsClicks.push(t)},isRobotCenter:function(){var t=xCity._urbanImpl.USR._freeRobot;return!!(t&&t.endCenterClick-Date.now()<500)},_moveToClick:function(t){if(!0!==this.isRobotCenter()){var e,i=t.from[0].currentPosition;if(e=this._getClicked3DPosition(i),!n.is(e))return null;var s=e.clone();return n.is(this._inverseCoordinate)&&(s.applyMatrix4(this._inverseCoordinate),e=s),this.lastClickedPH&&this._samePosition(e,this.lastClickedPH.pos3D)?(this._rememberClickedPh(this.lastClickedPH),void this.setLastClickedPH(this.lastClickedPH)):(this.preSelectedPh?(this._rememberClickedPh(this.preSelectedPh),!this.loop&&this.lastClickedPH&&this.anchorList.length>2&&this.tool.isPolyline()&&(0===this.preSelectedPh.index&&this.lastClickedPH.index===this.anchorList.length-1||0===this.lastClickedPH.index&&this.preSelectedPh.index===this.anchorList.length-1)&&(this._createLoop(),this.updateLine()),this.setLastClickedPH(this.preSelectedPh)):(this.preSelectedPh=null,this.preSelectedSegment?this._rememberClickedPh(this._segmentHandle):this.lastClickedPH?(this._addAnchor(e,i),this._rememberClickedPh(this.anchorList[this.anchorList.length-1].ph),this.updateLine()):0!==this.anchorList.length&&"point"!==this.currentGeometryType.toLowerCase()||(this._addAnchor(e,i),this.setLastClickedPH(this.anchorList[this.anchorList.length-1].ph),this._rememberClickedPh(this.anchorList[this.anchorList.length-1].ph),this.updateLine())),(this.tool.isHouse()||this.tool.isPoint())&&xCity.selectedItems.length>1&&xCity.selectedItems[0].set("selected",!1),null)}},_resizeHandle:function(){this.updateAnchorDivPosition()},activate:function(){this.urban.getView3D().webGLV6Viewer.setManipulators({activated:!0,preActivate:!0}),this.tool.onStart(this.anchorList),this.urban.getView3D().getPicker().disable(),this.clickToken=a.subscribeTo("/VISU/onLeftClick",this._moveToClick.bind(this)),this.tapToken=a.subscribeTo("/VISU/onTap",this._moveToClick.bind(this)),this.params.leftDoubleClickEnable||(this.doubleClickToken=a.subscribeTo("/VISU/onLeftDoubleClick",this._doubleClickHandle.bind(this))),this.enabled=!0,this.loop=!1,this.initEvents();var t=this;this.onUpdateToken=a.subscribeTo(a.eventsList.onUpdate,function(e){t.cameraUpdate(e),t.tool.onCameraUpdate(t.anchorList,e)}),this.onResizeToken=a.subscribeTo("/VISU/onWindowResized",this._resizeHandle.bind(this)),this.setCursor()},cameraUpdate:function(t){},deactivate:function(){this.enabled=!1,this.urban.getView3D().webGLV6Viewer.setManipulators({activated:!1,preActivate:!1}),a.unsubscribe(this.onUpdateToken),a.unsubscribe(this.clickToken),a.unsubscribe(this.tapToken),a.unsubscribe(this.onResizeToken),this.doubleClickToken&&a.unsubscribe(this.doubleClickToken),this.urban.getView3D().getPicker().enable();var t=xCity.findItem({id:this.tool.getCurrentContext().Line.id});void 0!==t&&(t.impl.removeEvent("onDestroy",this._destroyBinding),t.impl.removeEvent("onChange:visible",this._visibleBinding)),this.tool.onFinish(this.anchorList),this.initialState(),this.setCursor()},_onStopManip:function(){this.resetMove()},_containsPoints:function(t){return t.length>0&&(2===t[0].length||3===t[0].length)&&"number"==typeof t[0][0]&&"number"==typeof t[0][1]},_samePoint:function(t,e){return t[0]===e[0]&&t[1]===e[1]},_samePosition:function(t,e){return!(t.clone().sub(e).length()>.01)},pos3DToScreenPos:function(t){return this.urban.getView3D().viewpoint.getScreenPosition(t)},_doubleClickHandle:function(t){if(!0!==this.isRobotCenter()){if(this._lastsClicks[0]&&this._lastsClicks[1]&&this._lastsClicks[1].id===this._lastsClicks[0].id){if(this._segmentHandle&&this._lastsClicks[0].id===this._segmentHandle.id)return this._breakLoop(this._segmentHandle.index),this.updateLine(),void this.setCursor();this.lastClickedPH&&this._lastsClicks[0].id===this.lastClickedPH.id&&this.setOtherClickedPh(),this._removeAnchor(this._lastsClicks[0]),this.setCursor()}this._lastsClicks[0]=this._lastsClicks[1]=null}},AskMoveToClick:function(t,e){!0!==this.isRobotCenter()&&this._parent(t,e)},_getCursor:function(t){var e=this._parent(t);if(this.enabled){var i,s=" 0 0";if((this.tool.isPoint()||this.tool.isHouse())&&this.tool.canCreateNewShape&&!this.tool.canCreateNewShape())return e;(i=this.tool.creationCursor)&&(s=this.tool.creationCursorHotSpot),this.tool.additionCursor&&this.anchorList.length>0&&(this.lastClickedPH?(i=this.tool.additionCursor,s=this.tool.additionCursorHotSpot):this.tool.isPoint()||(i=null)),this.preSelectedSegment&&this.tool.segmentRemovalCursor&&(i=this.tool.segmentRemovalCursor,s=this.tool.segmentRemovalCursorHotSpot),i&&(e="url('"+i+".png')"+s+", url('"+i+".cur')"+s+", auto")}return e},setCurrentContext:function(t){this.tool&&this.tool.setCurrentContext(t),this.setCursor()},_getShapeExtrusionHeight:function(){var t;if(this.tool&&this.tool.isBuilding())return(t=n.is(this._lastItem)&&this._lastItem instanceof e?this._lastItem.get("geojson"):this._lastGeojsonData)&&(this._currentExtrusionHeight=t.features[0].properties[this.heightAttribute]),this._currentExtrusionHeight?this._currentExtrusionHeight=Number(this._currentExtrusionHeight):this._currentExtrusionHeight=this._defaultExtrusionHeight,this._currentExtrusionHeight},_getRoofHeight:function(){if(this.tool&&this.tool.isBuilding())return this._roofHeight},updateRoofAltitude:function(t){this._roofHeight=t-this._getShapeAltitude()-this._getShapeExtrusionHeight()},getsmallestdistancetoSegment:function(t,e,i){var s=new c.Vector2(i.x,i.y).sub(e),n=s.clone().normalize(),o=t.clone().sub(e),a=n.dot(o.normalize());a<=0&&(a=0),a>=1&&(a=1);var r=e.clone().add(n.clone().setLength(a*s.length()));return t.distanceTo(r)},acceptWhenprojectedBeforeSegment:function(t,e,i,s){var n=!1,o=t.clone().sub(e),a=i.clone().sub(e),r=o.clone().normalize(),h=a.clone().normalize(),l=Math.atan2(h.y,h.x);l>0&&(l-=2*Math.PI);var u=Math.atan2(r.y,r.x);return u>0&&(u-=2*Math.PI),l-u>.5*s&&(n=!0),n},acceptWhenprojectedAfterSegment:function(t,e,i,s){var n=!1,o=t.clone().sub(i),a=e.clone().sub(i),r=o.clone().normalize(),h=a.clone().normalize(),l=Math.atan2(h.y,h.x);l>0&&(l-=2*Math.PI);var u=Math.atan2(r.y,r.x);return u>0&&(u-=2*Math.PI),u-l>.5*s&&(n=!0),n},getinsertPointInClosestSegment:function(t){var e=0,i=this.anchorList.length;if(e=Math.max(0,i-1),i>2){var s,n,o,a,r,h,l,u,d,m,p,f=new c.Vector2(t.x,t.y),g=1/0,v=i-1,y=new c.Vector2(this.anchorList[v].ph.pos3D.x,this.anchorList[v].ph.pos3D.y),b=[];for(o=0;o<this.anchorList.length;o++)l=new c.Vector2(this.anchorList[(o+i-1)%i].ph.pos3D.x,this.anchorList[(o+i-1)%i].ph.pos3D.y),r=new c.Vector2(this.anchorList[o].ph.pos3D.x,this.anchorList[o].ph.pos3D.y),u=new c.Vector2(this.anchorList[(o+1)%i].ph.pos3D.x,this.anchorList[(o+1)%i].ph.pos3D.y),m=l.clone().sub(r),d=u.clone().sub(r),m.normalize(),d.normalize(),(p=Math.atan2(d.y,d.x)-Math.atan2(m.y,m.x))>0&&(p-=2*Math.PI),b.push(p);for(h=y,o=0;o<this.anchorList.length;o++){r=new c.Vector2(this.anchorList[o].ph.pos3D.x,this.anchorList[o].ph.pos3D.y),n=(s=new c.Vector2(r.x,r.y).sub(h)).clone().normalize(),a=f.clone().sub(h);var S=s.length(),_=n.dot(a),T=!0;_<=0&&(this.acceptWhenprojectedBeforeSegment(f,h,r,b[(o+i-1)%i])?_=0:T=!1),_>=S&&(this.acceptWhenprojectedAfterSegment(f,h,r,b[o])?_=S:T=!1);var P=h.clone().add(n.clone().setLength(_)),M=f.distanceTo(P);T&&M<g&&(g=M,e=(o+i-1)%i,!0),h=r}}return e},controlZ:function(){n.is(this.lastAddition)&&(this._lastRemoval=this.lastAddition,this._removeAnchor(this._lastAddition))},shiftControlZ:function(){n.is(this._lastRemoval)&&this.addAnchor(this._lastRemoval)},keydown:function(t){var e=this._parent(t),i=t.gesture.key,s=this._getEvent(t);switch(i){case 90:!0===s.ctrlKey&&(!0===s.shiftKey?this.shiftControlZ(s):this.controlZ(s));break;case 99:case 67:!0===s.ctrlKey&&this.controlC(s);break;case 86:case 118:!0===s.ctrlKey&&this.controlV(s)}return e},getSquareFromCorners:function(t,e){var i=new c.Vector2(e.x,e.y).sub(t),s=.25*Math.PI,n=(new c.Quaternion).setFromAxisAngle(new c.Vector3(0,0,1),s),a=(new c.Quaternion).setFromAxisAngle(new c.Vector3(0,0,1),-s),r=new c.Vector3(i.x,i.y,0).normalize(),h=r.clone();r.applyQuaternion(n),h.applyQuaternion(a);var l=o.projectPointOnDirection(t,t.clone().add(r),e),u=o.projectPointOnDirection(t,t.clone().add(h),e);return[t,l,e,u]},_createSquareCoordinates:function(){return this.getSquareFromCorners(this.anchorList[0].ph.pos3D,this.anchorList[1].ph.pos3D)},getRectangleFrom3Points:function(t,e,i){var s=o.projectPointOnDirection(t,e,i),n=i.clone().sub(s),a=e.clone().add(n),r=t.clone().add(n);return[t,e,a,r]},getRectangleFrom2Points:function(t,e){var i=this.eye.clone();i.z=0,i.normalize();var s=i.clone().negate(),n=o.projectPointOnDirection(e,e.clone().add(i),t),a=o.projectPointOnDirection(t,t.clone().add(s),e);return[t,n,e,a]},getRectangleFrom1Point:function(t){var e,i,s,o;if(t=Array.isArray(t)?new c.Vector3(t[0],t[1],t[2]):(new c.Vector3).setFromJSon(t),n.is(this._lastGeojsonData)){var a=this._lastGeojsonData.features[0].geometry.coordinates[0],r=new c.Vector2(a[0][0],a[0][1]),h=new c.Vector2(a[1][0],a[1][1]),l=new c.Vector2(a[3][0],a[3][1]);(e=new c.Vector3(h.x,h.y,0)).sub(new c.Vector3(r.x,r.y,0)),s=e.length(),o=(i=new c.Vector3(l.x,l.y,0).sub(new c.Vector3(r.x,r.y,0))).length()}else{(e=this.eye.clone()).z=0;e.x<.001&&e.y<.001&&((e=this.up.clone()).z=0),e.normalize();var u=.5*-Math.PI,d=(new c.Quaternion).setFromAxisAngle(new c.Vector3(0,0,1),u);(i=e.clone()).applyQuaternion(d),s=this._defaultHouseWidth,o=this._defaultHouseLength,e.setLength(s),i.setLength(o)}var m=t.clone().add(e),p=m.clone().add(i),f=t.clone().add(i);return[t,m,p,f]},_createRectangleCoordinates:function(t){var e=this.getRectangleFrom1Point(t);return e=[[e[0].x,e[0].y,e[0].z],[e[1].x,e[1].y,e[1].z],[e[2].x,e[2].y,e[2].z],[e[3].x,e[3].y,e[3].z]]},controlC:function(){},controlV:function(){},_coordinateChange:function(t){if(!0===this.shouldOffset&&this.anchorList[0]){var e=-this.anchorList[0].ph.pos3D.z;this.anchorOffsetNode.setMatrix((new c.Matrix4).setPosition(new c.Vector3(0,0,e)))}this.anchorRootNode.setMatrix(t),this._inverseCoordinate.getInverse(t)},fromGeojsonPositionToAbsolute:function(t){return t.clone().applyMatrix4(this.anchorRootNode.getMatrix())},fromAbsoluteToGeojsonPosition:function(t){return t.clone().applyMatrix4(this._inverseCoordinate)},updateRoofHeightFromItem:function(){var t;(t=n.is(this._lastItem)?this._lastItem.get("geojson"):this._lastGeojsonData)&&(this._roofHeight=t.features[0].properties[this.roofHeightAttribute]),this._roofHeight?this._roofHeight=Number(this._roofHeight):this._roofHeight=this._defaultRoofHeight},_geojsonChange:function(){n.is(this._lastItem)&&(this._lastGeojsonData=n.clone(this._lastItem.get("geojson"))),n.is(this.extrusionPositionNode)&&(this.updateRoofHeightFromItem(),this.extrusionPositionNode.updateHandlePosition())},resetZfromPolygonandanchors:function(t){if(t&&t.features&&t.features.length>0){for(var e=t.features[0].geometry.coordinates[0],i=[],s=0;s<e.length;s++){var n=new c.Vector3(e[s][0],e[s][1],0);i.push(n.toArray());var o=this.anchorList[s];o&&o.ph&&(o.ph.pos3D.z=0,o.ph.setMatrix((new c.Matrix4).setPosition(o.ph.pos3D)))}t.features[0].geometry.coordinates[0]=i}},updateAnchorDivPosition:function(){if(this.anchorList)for(var t=0;t<this.anchorList.length;t++)if("div"in this.anchorList[t].ph){var e=this.urban.getView3D().viewpoint.getScreenPosition(this.anchorList[t].ph.pos3D);this.anchorList[t].ph.div.style.top=e.y+"px",this.anchorList[t].ph.div.style.left=e.x+"px"}}})}),define("DS/UrbanManipulator/MeasureAltitudeManipulator",["DS/Visualization/ThreeJS_DS","DS/Manipulators/PointHandle","UWA/Core","DS/UrbanManipulator/Manipulator","DS/UrbanManipulator/ManipulatorParams","DS/UrbanManipulator/LocalisationManipulator","DS/UrbanManipulator/CameraAnimation","DS/UrbanManipulator/CameraAnimationPath","DS/UrbanManipulator/Keyframe","UWA/Class","DS/Visualization/Node3D","DS/UrbanTool/Utils","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher"],function(t,e,i,s,n,o,a,r,h,l,u,c,d,m,p,f){"use strict";return s.extend({init:function(t,e,i,s){this.urban=t,this._parent(t,e,i,s),this.type="altitude",this.params.movetoclickpriority=!0,this.parentDiv=this.urban.frmWindow.getUIFrame(),this.anchorList=[],this.clickToken=null,this.tapToken=null,this.updateToken=null,this.preSelectedPh=null},_moveToClick:function(s,n){var o=s.from[0].currentPosition;if(null===this.preSelectedPh){var a=this.exactPick(o);if(!c.is(a))return null;var r=new e({viewer:this.urban.getView3D().webGLV6Viewer,sceneGraph:this.urban.getView3D()._rootProjShifted});r.index=this.anchorList.length;r.div=i.createElement("div",{id:"measure",styles:{position:"absolute",margin:"auto",padding:"6px",top:"Opx",left:"Opx",textAlign:"center",backgroundColor:"rgba(161, 229, 255, 0.28)",border:"solid 2px rgba(161, 229, 255, 0.8)",pointerEvents:"none",borderRadius:"6px"}});var h=this,l=function(t){return Math.round(100*t.z/h.urban.getView3D().getScale())/100+" m.<BR>"},u=function(t){return l(t)+"x = "+Math.round(100*t.x)/100+" m.<BR>y = "+Math.round(100*t.y)/100+" m."},d=document.createElement("p");return d.innerHTML=l(a),d.style.pointerEvents="none",d.style.textAlign="justify",r.div.appendChild(d),r.div.inject(this.parentDiv),this.divStyleHeight=parseFloat(window.getComputedStyle(r.div).height),r.div.style.top=o.y-this.divStyleHeight+"px",r.div.style.left=o.x+20+"px",r.name="phMeasureAlt",r.setMatrix((new t.Matrix4).setPosition(a)),r.setSize(20),r.setFillColor(new t.Color("#FF5555")),r.pos3D=a,r.pos2D=o,this.anchorList.push({ph:r}),r.subscribe("Manipulate",function(e){var i=e.event.from[0].currentPosition,s=h.exactPick(i);r.setMatrix((new t.Matrix4).setPosition(s)),r.pos3D=s,r.pos2D=i,r.div.style.top=i.y-h.divStyleHeight+"px",r.div.style.left=i.x+20+"px",d.innerHTML=u(s)}),r.subscribe("BeginManipulate",function(t){}),r.subscribe("EndManipulate",function(t){d.innerHTML=l(r.pos3D)}),r.subscribe("BeginPreactivate",function(t){h.preSelectedPh=r,d.innerHTML=u(r.pos3D)}),r.subscribe("Preactivate",function(t){}),r.subscribe("EndPreactivate",function(t){h.preSelectedPh=null,d.innerHTML=l(r.pos3D)}),null}this.urban.getView3D()._rootProjShifted.remove(this.preSelectedPh),void 0!==this.preSelectedPh.div&&this.preSelectedPh.div.getParent()===this.parentDiv&&this.parentDiv.removeChild(this.preSelectedPh.div),this.anchorList.splice(this.preSelectedPh.index,1);for(var m=0;m<this.anchorList.length;m++)this.anchorList[m].ph.index=m},_update:function(t){if(this.urban.getViewpoint().camMoved)for(var e=0;e<this.anchorList.length;e++){var i=this.urban.getView3D().viewpoint.getScreenPosition(this.anchorList[e].ph.pos3D);i.z<-1||i.z>1||i.x<0||i.x>window.innerWidth||i.y<0||i.y>window.innerHeight?this.anchorList[e].ph.div.hide():this.anchorList[e].ph.div.show(),this.anchorList[e].ph.div.style.top=i.y-this.divStyleHeight+"px",this.anchorList[e].ph.div.style.left=i.x+20+"px"}},activate:function(){this.urban.getView3D().webGLV6Viewer.setManipulators({activated:!0,preActivate:!0}),this.enabled=!0,this.initEvents(),this.urban.getView3D().getPicker().disable(),this.clickToken=f.subscribeTo("/VISU/onLeftClick",this._moveToClick.bind(this)),this.tapToken=f.subscribeTo("/VISU/onTap",this._moveToClick.bind(this)),this.updateToken=f.subscribeTo("/3DEXPERIENCity/onUpdate",this._update.bind(this))},deactivate:function(){this.enabled=!1,this.urban.getView3D().getPicker().enable();for(var t=0;t<this.anchorList.length;t++)this.parentDiv.removeChild(this.anchorList[t].ph.div),this.urban.getView3D()._rootProjShifted.remove(this.anchorList[t].ph);this.anchorList=[],f.unsubscribe(this.clickToken),f.unsubscribe(this.tapToken),f.unsubscribe(this.updateToken),this.urban.getView3D().webGLV6Viewer.setManipulators({activated:!1,preActivate:!1})}})}),define("DS/UrbanManipulator/GroundManipulator",["DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","DS/UrbanManipulator/Manipulator","DS/UrbanManipulator/ManipulatorParams","DS/UrbanManipulator/LocalisationManipulator","DS/UrbanManipulator/CameraAnimation","DS/UrbanManipulator/CameraAnimationPath","DS/UrbanManipulator/Keyframe","UWA/Class","DS/Visualization/Node3D","DS/UrbanTool/Utils","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Debug"],function(t,e,i,s,n,o,a,r,h,l,u,c,d,m){"use strict";return i.extend({init:function(t,e,i,s){var n=!1;u.is(s)&&(n=!0),this._parent(t,e,i,s),n||this.params.resetDefaultGroundValue(),this.type="ground"},rotateAround:function(t,e){return!0},panCamera:function(){return this.panCameraOld()},checkOnly:function(){var t=!0,e=this.getAltitude();return!(Math.abs(e-this.params.groundModeAltitude)>.001)&&(this.eye.normalize(),this.up.normalize(),this.up.z<0?t=!1:this.eye.z>.999&&(t=!1),t)},checkValues:function(){var t=!0,e=this.getAltitude();return Math.abs(e-this.params.groundModeAltitude)>.001&&(u.is(this.currentAnimation)&&this.checkH||(m.log("too low"),this.setAltitude(this.params.groundModeAltitude))),this.eye.normalize(),this.up.normalize(),this.up.z<0?(t=!0,this.up.z=0,this.up.normalize(),this.eye.x=0,this.eye.y=0,this.eye.normalize(),this.target.copy(this.position.clone().add(this.eye.setLength(this.distanceToTarget))),this.setAltitude(this.params.groundModeAltitude)):this.eye.z>.999&&(t=!0,this.eye.z=.998,this.eye.normalize(),0===this.eye.x&&0===this.eye.y?(this.up.z=0,this.up.normalize()):this.up=u.getUpFromCameraEye(this.eye.clone()).normalize(),this.target.copy(this.position.clone().add(this.eye.setLength(this.distanceToTarget))),this.setAltitude(this.params.groundModeAltitude),this.zoomFocus=null),this.distanceToTarget<this.viewpoint.camera.near+1&&(this.distanceToTarget=this.viewpoint.camera.near+1,this.position.copy(this.target.clone().sub(this.eye.setLength(this.distanceToTarget))),t=!0),t},moveToClick:function(t,e){var i=this.exactPick(t);if(u.is(i)&&this.getAltitudeFromVector(i)<8848){var s=e*this.position.distanceTo(i),n=this.urban.USR.getGroundHeight(i.x,i.y);return n*=this.urban.USR.scale,this.setAltitudeToVector(i,this.params.groundModeAltitude+n),this.moveTo3(i,s,void 0,void 0)}return null},faceNorth:function(){this.distanceToTarget;var e=this.getCurrentKeyframe();e.date=null,e._target=null;var i=u.getNorthAngle(this.eye,this.up),s=e.getQuaternion(),n=e.clone(),r=new t.Quaternion;r.setFromAxisAngle(u.vertical.clone(),.5*-i);var h=r.multiply(s);n.setQuaternion(h),n.time=.5*this.params.northMoveDuration*1e3;var l=e.clone(),c=new t.Quaternion;c.setFromAxisAngle(u.vertical.clone(),-i),h=c.multiply(s),l.setQuaternion(h),l.time=1e3*this.params.northMoveDuration;var d=new a;d.addKeyframe(e),d.addKeyframe(n),d.addKeyframe(l);var m=new o(this,d,"facenorth");return this.setCurrentAnimation(m)},faceVerticalNorth:function(){this.distanceToTarget;var e=this.getCurrentKeyframe();e.date=null,e._target=null;var i=e.getQuaternion(),s=e.clone(),n=new t.Quaternion;if(n.setFromAxisAngle(new t.Vector3(1,0,0),.5*Math.PI),!i.equals(n)){s.setQuaternion(n),s.time=1e3*this.params.northMoveDuration;var r=new a;r.addKeyframe(e),r.addKeyframe(s);var h=new o(this,r,"facenorthhorinzontal");return this.setCurrentAnimation(h)}},activate:function(t){if(this.enabled=!0,!0===this.verbose&&m.log(" activate ground manip"),this.resetMove(),this.askedmove=null,this.askedmovepos=null,this.initEvents(),this.checkH=!0,!(this.params.noAnimationOnActivation||u.is(t)&&u.is(t.noAnimationOnActivation))){var e=this.eye.clone();0===e.x&&0===e.y&&(e=this.up.clone()),e.z=0,e.normalize();var i=this.target.clone(),s=(Math.max(this.params.groundModeAltitude,this.getAltitudeFromVector(this.target)),this.urban.USR.getGroundHeight(this.target.x,this.target.y));s*=this.urban.USR.scale,this.setAltitudeToVector(i,this.params.groundModeAltitude+s);var o=Math.max(this.params.defaultDistanceOnActivation,this.eye.z*-this.params.groundModeAltitude);this.moveTo3(i,o,e,this.params.manipTransitionDuration)}n.enableInterns(!0),n.zoomEnable(!1)},_getFinalPositionFromViewpoint:function(t,e,i){var s=t.clone().sub(i.normalize().multiplyScalar(e)),n=this.urban.USR.getGroundHeight(s.x,s.y);n*=this.urban.USR.scale;var o=this.params.groundModeAltitude+n;return this.getAltitudeFromVector(s)!==o&&(this.setAltitudeToVector(s,o),(i=t.clone().sub(s)).normalize()),!0===this.verbose&&m.log("moveto3 to: "+u.displayVector(s)),s},setAltitude:function(t){this.position.z=this.terrainHeight+this.params.groundModeAltitude},setCurrentHeight:function(t){if(u.is(t)&&this.terrainHeight!==t){u.is(this._terrainLastHeights)||(this._terrainLastHeights=[]),this._terrainLastHeights.length>5&&this._terrainLastHeights.shift(),this._terrainLastHeights.push(t);for(var e=this._terrainLastHeights.length,i=0,s=0;s<e;s++)i=Math.max(this._terrainLastHeights[s],i);this.terrainHeight=i}}})}),define("DS/UrbanManipulator/CarManipulator",["DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","DS/UrbanManipulator/Manipulator","DS/UrbanManipulator/ManipulatorParams","DS/UrbanManipulator/LocalisationManipulator","DS/UrbanManipulator/CameraAnimation","DS/UrbanManipulator/CameraAnimationPath","DS/UrbanManipulator/Keyframe","UWA/Class","DS/Visualization/Node3D","DS/UrbanTool/Utils","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Debug","DS/UrbanManipulator/GroundManipulator","DS/UrbanFeature/Coordinate"],function(t,e,i,s,n,o,a,r,h,l,u,c,d,m,p,f){"use strict";return i.extend({init:function(t,e,i,s){this._parent(t,e,i,s),this.type="car",this.turnOffset=0,this.acceleration=0},activate:function(t){this._parent(t),this.urban._setDebugMode(!0)},updateCarPosition:function(){var e=new t.Vector3(0,-20,0);if(u.is(this._lastCarPosition)){var i=this._lastCarPosition.clone();i.sub(this.target),i.setLength(20),this._lastCarPosition=this.target.clone(),this._lastCarPosition.add(i)}else this._lastCarPosition=this.target.clone(),this._lastCarPosition.add(e);return this._lastCarPosition.z=.2,this._lastCarPosition},updateCarOrientation:function(){var t=this._lastCarPosition.clone().sub(this.target);return u.getNorthAngle(t,this.up)},lerp:function(t,e,i){if(!u.is(t))return u.is(e)?e:null;if(!u.is(e))return t;var s=t.clone(),n=e.clone();return s.multiplyScalar(1-i),n.multiplyScalar(i),s.add(n)},update:function(t){if(!0!==t)return!1;this.turn(this.turnOffset),this.accelerate(this.acceleration),this._parent(t);var e=this.updateCarPosition();this.updateCoordinatePosition(e,u.toDeg(this.updateCarOrientation()))},updateCoordinatePosition:function(e,i){var s,n,o;if(s=this._car,u.is(s)&&(u.is(s.impl)?o=s.impl.getContent():u.is(s.getContent)&&(o=s.getContent()),u.is(o))){n=o.get("Coordinate"),u.is(n)||(n=new f({projection:this.urban.getUserDefaultProjection()})).create(this.urban);var a=e;n.set("position",a),n.set("rotation",new t.Vector3(0,0,i+90)),o.set("Coordinate",n)}},addModel:function(t){this._car=t},keepturn:function(t){this.turnOffset=.25*t},stopturn:function(){this.turnOffset=0},keepaccelerate:function(t){this.acceleration=.5*t},stopaccelerate:function(){this.acceleration=0},turn:function(t){0!==t&&(this.turn2d(this.currentKeyOffset,.25*t),this.setState(this.params.STATE.KEYBOARD_PAN))},turn2d:function(t,e){var i=Math.cos(e)*t.x-Math.sin(e)*t.y,s=Math.sin(e)*t.x+Math.cos(e)*t.y;return t.x=i,t.y=s,t},turnLeft:function(t){this.turn2d(this.currentKeyOffset,.25*-t),this.setState(this.params.STATE.KEYBOARD_PAN)},turnRight:function(t){this.turn2d(this.currentKeyOffset,.25*t),this.setState(this.params.STATE.KEYBOARD_PAN)},accelerate:function(t){if(0!==t){var e=this.currentKeyOffset.length();0!==e?this.currentKeyOffset.setLength(e+t):this.currentKeyOffset.y+=t,this.setState(this.params.STATE.KEYBOARD_PAN)}},resetMove:function(){this._parent(),this.turnOffset=0,this.acceleration=0},decelerate:function(t){this.acceleration-=.5*t},keydown:function(e){if(!1===this.enabled)return!1;if(!0!==this.urban._debugMode)return!1;var i=this.params.manipulationSpeedFactor*this.params.keysSpeed;i*=this.params.manipulationShiftSpeedFactor;var s=e.gesture.key;new t.Vector2;if("input"!==e.from[0].view.localName){var n=!1;switch(s){case this.params.Keys.PAN_LEFT:this.keepturn(-i),n=!0;break;case this.params.Keys.PAN_FRONT:this.keepaccelerate(i),n=!0;break;case this.params.Keys.PAN_RIGHT:this.keepturn(i),n=!0;break;case this.params.Keys.PAN_BACK:this.decelerate(i),n=!0;break;case this.params.Keys.RESET:this.resetMove();break;case this.params.Keys.KEYFRAME:this.recordKeyframe();break;case this.params.Keys.PLAY:this.play()}!0===n&&!0===this.verbose&&m.log("keydown"),!0===this._getEvent(e).shiftKey?this.shiftKey=!0:this.shiftKey=!1}},keyup:function(e){if(!1===this.enabled)return!1;if(!0!==this.urban._debugMode)return!1;var i=this.params.manipulationSpeedFactor*this.params.keysSpeed;i*=this.params.manipulationShiftSpeedFactor;var s=e.gesture.key;new t.Vector2;if("input"!==e.from[0].view.localName){var n=!1;switch(s){case this.params.Keys.PAN_RIGHT:case this.params.Keys.PAN_LEFT:this.stopturn(i),n=!0;break;case this.params.Keys.PAN_FRONT:this.stopaccelerate(i),n=!0}!0===n&&!0===this.verbose&&m.log("keyup"),!0===this._getEvent(e).shiftKey?this.shiftKey=!0:this.shiftKey=!1}}})}),define("DS/UrbanManipulator/FixedManipulator",["DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","DS/UrbanManipulator/GroundManipulator","DS/UrbanManipulator/ManipulatorParams","DS/UrbanManipulator/LocalisationManipulator","DS/UrbanManipulator/CameraAnimation","DS/UrbanManipulator/CameraAnimationPath","DS/UrbanManipulator/Keyframe","UWA/Class","DS/Visualization/Node3D","DS/UrbanTool/Utils","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Debug"],function(t,e,i,s,n,o,a,r,h,l,u,c,d,m){"use strict";return i.extend({init:function(e,i,s,n){var o=!1;u.is(n)&&(o=!0),this._parent(e,i,s,n),o||this.params.resetDefaultFixedValue(),this.type="fixed",this.initialPosition=new t.Vector3,this.initialFov=this.viewpoint.camera.fov},panCamera:function(){return!0===this.panCameraOld()&&this.urban.getView3D().setControl(this.urban.getView3D().manipulators.default),!1},checkOnly:function(){var t=!0;return this.position.distanceTo(this.initialPosition)>.001?(this.urban.getView3D().setControl(this.urban.getView3D().manipulators.default),!1):(this.eye.normalize(),this.up.normalize(),this.up.z<0?t=!1:this.eye.z>.999&&(t=!1),t)},checkValues:function(){var t=!0;return this.position.distanceTo(this.initialPosition)>.001&&this.position.copy(this.initialPosition),this.eye.normalize(),this.up.normalize(),this.up.z<0?(t=!0,this.up.z=0,this.up.normalize(),this.eye.x=0,this.eye.y=0,this.eye.normalize(),this.target.copy(this.position.clone().add(this.eye.setLength(this.distanceToTarget))),this.setAltitude(this.params.groundModeAltitude)):this.eye.z>.999&&(t=!0,this.eye.z=.998,this.eye.normalize(),0===this.eye.x&&0===this.eye.y?(this.up.z=0,this.up.normalize()):this.up=u.getUpFromCameraEye(this.eye.clone()).normalize(),this.target.copy(this.position.clone().add(this.eye.setLength(this.distanceToTarget))),this.setAltitude(this.params.groundModeAltitude),this.zoomFocus=null),t},moveToClick:function(t,e){return null},activate:function(){this.params.groundModeAltitude=this.getAltitude(),this.initialPosition.copy(this.position),this.initialFov=this.viewpoint.camera.fov,this.enabled=!0,!0===this.verbose&&m.log(" activate fixed manip"),this.resetMove(),this.askedmove=null,this.askedmovepos=null,this.initEvents(),this.checkH=!0,n.enableInterns(!0),n.zoomEnable(!1),n.panEnable(!1)},deactivate:function(){this.viewpoint.camera.fov=this.initialFov,this._parent()},setAltitude:function(t){this.position.copy(this.initialPosition)},zoomCamera:function(){var t,e,i=!1;if(this.currentState===this.params.STATE.TOUCH_ZOOM||this.currentState===this.params.STATE.TOUCH_ROTATE?(this.zoomEnd.y=-this.touchZoomDistanceEnd/(1e3*this.params.touchZoom),this.zoomStart.y=-this.touchZoomDistanceStart/(1e3*this.params.touchZoom),e=this.zoomEnd.y-this.zoomStart.y):(e=this.zoomEnd.y-this.zoomStart.y,!0===this.shiftKey&&(e*=this.params.manipulationShiftSpeedFactor)),Math.abs(e)<1/Math.max(this.screen.width,this.screen.height)&&(e=0),t=e*this.params.manipulationSpeedFactor*this.params.zoomSpeed*this.urban.USR.timeDelta*1e3/16,0!==e&&1!==t){var s=this.viewpoint.camera.fov+t;s=Math.max(this.params.fovMin,s),s=Math.min(this.params.fovMax,s),this.viewpoint.camera.fov=s,i=!0,this.currentState!==this.params.STATE.TOUCH_ZOOM&&this.currentState!==this.params.STATE.TOUCH_ROTATE||this.zoomStart.copy(this.zoomEnd),this.zoomStart.y+=(this.zoomEnd.y-this.zoomStart.y)*Math.min(1,.5*this.params.dynamicDampingFactor*this.urban.USR.timeDelta*1e3/16),this.touchZoomDistanceStart=-this.zoomStart.y*(1e3*this.params.touchZoom)}return i}})}),define("DS/UrbanManipulator/ArrowHandle",["DS/Manipulators/PointHandle","DS/UrbanAPI/xCityItem","DS/UrbanManipulator/Manipulator","DS/XCityTools/Geocoder","DS/UrbanTool/Utils","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/UrbanTool/DrawingManipulatorTool","DS/xCityBasicUtils/DataFormatTools","DS/SceneGraphNodes/FixedSizeNode3D","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Robot/LineTranslationNode","DS/XCityTools/ShaderTools"],function(t,e,i,s,n,o,a,r,h,l,u,c,d,m){"use strict";var p;return m.extend({init:function(t){n.is(t)||(t={}),t.touchMode=!0,this._parent(t),n.is(p)?this.mat.map=p:p=this.mat.map,this.modelEvents=this._modelEvent}})}),define("DS/UrbanManipulator/AltitudeNode",["DS/Manipulators/PointHandle","DS/UrbanAPI/xCityItem","DS/UrbanManipulator/Manipulator","DS/XCityTools/Geocoder","DS/UrbanTool/Utils","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/UrbanTool/DrawingManipulatorTool","DS/xCityBasicUtils/DataFormatTools","DS/SceneGraphNodes/FixedSizeNode3D","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/UrbanManipulator/ArrowHandle","DS/XCityTools/ShaderTools"],function(t,e,i,s,n,o,a,r,h,l,u,c,d,m){"use strict";return d.extend({init:function(t,e,i){var s=this;this.urban=t,this.tool=e,window.URBANODT?this._extrusionHandleNode=new d:this._extrusionHandleNode=new m;var n=new l({name:"extrusionFixedSizeNode3D",ratio:7});n.addChild(this._extrusionHandleNode),this._extrusionHandleNode.subscribe({event:"LineTranslationBegin"},function(){s._extrusionHandleNode.initialMatrix=(new c.Matrix4).copy(s.getMatrix()),!0===s.tool.altitudeDisplay&&(s._extrusionHandleNode.altitudeEffect=s.urban.getView3D().getAltitudeEffect(),s._extrusionHandleNode.altitudeEffect.enableEffect())}),this._extrusionHandleNode.subscribe({event:"LineTranslationManipulation"},function(t){var e=t.translationVector,i=new c.Vector3;if(i.getPositionFromMatrix(s._extrusionHandleNode.initialMatrix),i.add(e),s._extrusionHandleNode.altitudeEffect){var n=s._extrusionHandleNode.getMatrixWorld().getPositionFromMatrix();s._extrusionHandleNode.altitudeEffect.disableEffect(),s._extrusionHandleNode.altitudeEffect._currentZ=n.z,s._extrusionHandleNode.altitudeEffect.enableEffect()}s.updateRoofAltitude(i.z),s.updateLine()}),this._extrusionHandleNode.subscribe({event:"LineTranslationEnd"},function(){s._extrusionHandleNode.altitudeEffect&&(s._extrusionHandleNode.altitudeEffect.disableEffect(),s._extrusionHandleNode.altitudeEffect=null)}),this._parent(),this.addChild(n)},updateHandlePosition:function(t){this.setMatrix((new c.Matrix4).setPosition(t))},handleWasUpdate:function(){}})});