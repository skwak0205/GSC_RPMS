/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtx",[],function(){}),define("DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager",["UWA/Class","DS/PADUtils/PADTypesMgt","DS/DibWebUtils/DibFavoriteContextAccess","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/UIKIT/Modal","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Button","DS/PADUtils/PADUtilsServices","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(e,t,n,o,a,r,i,c,d,s){"use strict";var u,l,f,p,v,h,g,C=["3DShape"];require(["i18n!DS/CAT3DAnnotationFavoriteCtx/assets/nls/CAT3DAnnotationFavoriteCtx"],function(e){u=e.rootInSession,l=e.noFavoriteContext,f=e.checkTitle,p=e.checkConfirm,v=e.checkButton,h=e.checkYes,g=e.checkNo});var D=e.extend({init:function(e){var D,m=e.context,x=0;function b(e,t){x++;var o=[],a=e.length;e.length?e.forEach(function(e){var r={data:e,rootID:null,instances:null,filters:null};o.push(r),n.getFavoriteContextInfos({ObjectPhysicalid:e.objectId,onComplete:function(e){a--,!e.Error&&e.RootObject&&(r.rootID=e.RootObject.physicalid,r.instances=e.PathOfInstances.map(function(e){return e.physicalid})),0===a&&t(o)},onFailure:function(){0===--a&&t(o)}})}):t(o)}function I(e){var t,n=!1,o=[],d=[];o.push("<p>"+p+"</p>"),o.push(new i({name:"fcCheckBox",label:v,value:"value",type:"checkbox",className:"primary"})),d.push(new c({className:"primary",value:h,events:{onClick:function(){o[1].isChecked()&&a.setPreference("FavoriteContextLoadMode","0"),t.hide(),n=!0,e.onOkCB&&e.onOkCB()}}})),d.push(new c({className:"default",value:g,events:{onClick:function(){o[1].isChecked()&&a.setPreference("FavoriteContextLoadMode","0"),t.hide(),n=!0,e.onCancelCB&&e.onCancelCB()}}})),(t=new r({closable:!0,escapeToClose:!0,visible:!0,overlay:!0,renderTo:document.body,header:f,body:o,footer:d,events:{onHide:function(){!n&&e.onHideCB&&e.onHideCB(),t.destroy(),t=null}}})).getHeader().setStyle("text-align","left"),t.getBody().setStyle("text-align","left")}function y(n){var o=Boolean(n.event),r=!n.event||!n.event.shiftKey,i=s.getRoots(m).map(function(e){return s.getNodeID(e)?s.getNodeID(e):void 0});!function(e,n){var o={other:[],favCtxt:[]};try{t.retrieveAuthorizedObjects({displayNotif:!1,X3DContentId:e.x3dContent,dnd_event:e.event,version:"2.0",callback:function(e){(e.unauthorized_objects||[]).forEach(function(e){o.other.push(e)}),Object.keys(e.authorizedWithKind).forEach(function(t){"Product"===t?e.authorizedWithKind.Product.forEach(function(e){-1===C.indexOf(e.objectType)?o.other.push(e):o.favCtxt.push(e)}):e.authorizedWithKind[t].forEach(function(e){o.other.push(e)})}),e.authorized_objects&&e.authorized_objects.length?d.multiTenantMgt(e.authorized_objects,s.getRoots(m),function(e){e.isMultiTenant||n(o)}):n(o)}})}catch(e){n(o)}}(n,function(t){t.other.length&&(require("DS/PADServices/utils/GlobalModelEvents").publish({event:"ENXViews/WelcomePanel/closeLandingPage"}),e.addRootNodesFromContent?e.addRootNodesFromContent(t.other):m.addRootNodesFromContent({json3DXContent:{data:{items:t.other}},dispatch:!0,inContext:r})),b(t.favCtxt,function(t){var n=[],c=[],d=!1,f=!1,p=[];t.forEach(function(e,o){if(!e.rootID)return f=!0,t.splice(o,1),void n.push({path:e.data.path&&r?e.data.path.map(function(e){return e.resourceid}):[e.data.objectId]});p.push({origin:e.data.objectId,root:e.rootID,instances:e.instances}),i.indexOf(e.rootID)>-1?(t.splice(o,1),d=!0):-1!==c.indexOf(e.rootID)||n.some(function(t){return t[0]===e.rootID})||c.push(e.rootID)}),f&&m.displayNotification({msg:l,eventID:"info"}),d&&m.displayNotification({msg:u,eventID:"info"}),c.length&&"1"===a.getPreference("FavoriteContextLoadMode")?I({onOkCB:function(){p.length&&D&&D.publish({event:"onFavoriteContextLoading",data:p}),e.addRoots?e.addRoots(c.map(function(e){return{path:[e]}})):m.addRoots({objects:c.map(function(e){return{path:[e]}})},o)},onCancelCB:function(){e.addRoots?e.addRoots(t.map(function(e){return{path:e.data.path&&r?e.data.path.map(function(e){return e.resourceid}):[e.data.objectId]}})):m.addRoots({objects:t.map(function(e){return{path:e.data.path&&r?e.data.path.map(function(e){return e.resourceid}):[e.data.objectId]}})},o)},onHideCB:function(){0===n.length&&0===s.getRoots(m).length&&m._dropZoneContainer&&m._dropZoneContainer.show("drop")}}):(c.forEach(function(e){n.push({path:[e]})}),p.length&&D&&D.publish({event:"onFavoriteContextLoading",data:p})),n.length?e.addRoots?e.addRoots(n):m.addRoots({objects:n},o):0===c.length&&0===s.getRoots(m).length&&m._dropZoneContainer&&m._dropZoneContainer.show("drop")})})}function A(e){if("2"!==a.getPreference("FavoriteContextLoadMode")){var t=d.deserializeDroppedData(e);if(!(t&&t.data&&t.data.items&&1===t.data.items.length&&"Document"===t.data.items[0].objectType)){e.preventDefault();for(var n=!1,o=e.target;(o=o.parentNode)&&!n;)n=!!o.classList&&o.classList.contains("enx-welcome-panel-dropArea");if(!n){e.stopPropagation(),m._dropZoneContainer&&m._dropZoneContainer.hide(),m.clearWidgetBorder();var r=document.getElementById("pad_invite");r&&r.setStyle("display","none"),(r=document.getElementById("background_container"))&&r.setStyle("display","none");var i=document.getElementById("canvas-div");i&&i.removeClassName("drag_over_class")}y({event:e})}}}this.managePath=function(t,n){if(!n||"2"!==a.getPreference("FavoriteContextLoadMode")){var o=t.path.getLastElement(!0),r=s.getNodeType(o)?s.getNodeType(o):null;if(C.indexOf(r)>-1){var i=s.getNodeID(o),c=x+1,d=!1;return b([{objectId:i}],function(o){if(c===x)if(o[0].rootID){var r=function(){var n=o[0].rootID;t.path.externalPath.some(function(e){return e&&s.getNodeID(e)===n})?m.displayNotification({msg:u,eventID:"info"}):-1===s.getRoots(m).map(function(e){return s.getNodeID(e)}).indexOf(n)?(s.getNodeID(t.path.externalPath[1])===i&&m.removeRoots({pids:[i]}),D&&D.publish({event:"onFavoriteContextLoading",data:[{origin:i,root:o[0].rootID,instances:o[0].instances}]}),e.addRoots?e.addRoots([{path:[n]}]):m.addRoots({objects:[{path:[n]}]},!0)):m.displayNotification({msg:u,eventID:"info"})};n&&"1"===a.getPreference("FavoriteContextLoadMode")?I({onOkCB:r}):r()}else m.displayNotification({msg:l,eventID:"info"});t.onComplete&&t.onComplete(),d=!0}),{cancel:d?null:function(){c=null}}}return t.onComplete&&t.onComplete(),{}}},this.manageX3DContentId=function(e){return"2"===a.getPreference("FavoriteContextLoadMode")?m.addRootNodesFromContent({json3DXContent:e.x3dContentId,dispatch:!1}):(y({x3dContent:e.x3dContentId}),null)};var N=!1;this.setActivationDropState=function(e){if(N!==e&&m.getViewer()){(N=e)?m.getViewer().canvas.addEventListener("drop",A):m.getViewer().canvas.removeEventListener("drop",A);var t=m.render().getContent().parentNode;t&&t.querySelector(".landing-root .enx-welcome-panel-dropArea")&&(N?t.querySelector(".landing-root .enx-welcome-panel-dropArea").addEventListener("drop",A):t.querySelector(".landing-root .enx-welcome-panel-dropArea").removeEventListener("drop",A))}},this.subscribe=function(e,t){return D||(D=new o),D.subscribe(e,t)},this.unsubscribe=function(e){return D?D.unsubscribe(e):0},this.unreference=function(){if(N){m.getViewer().canvas.removeEventListener("drop",A);var e=m.render().getContent().parentNode;e&&e.querySelector(".landing-root .enx-welcome-panel-dropArea")&&e.querySelector(".landing-root .enx-welcome-panel-dropArea").removeEventListener("drop",A)}D&&D.destroy(),m=D=null,N=!1}}}),m=[];return e.singleton({init:function(){},getFavoriteContextManager:function(e){var t;if(e&&e.context&&"ENOPAD3DViewer"===e.context.name){for(var n=0;n<m.length;n++)if(m[n].context===e.context){t=m[n].favoriteCtxManager;break}if(!t){var o=new D(e),a={unreference:function(){o&&(o.unreference(),a=o=null)},manageFavoriteContext:function(e,t){if(o)return e.path?o.managePath(e,t):e.x3dContentId?o.manageX3DContentId(e):void 0},setActivationDropState:function(e){if(o)return o.setActivationDropState(e)},subscribe:function(e,t){if(o)return o.subscribe(e,t)},unsubscribe:function(e){if(o)return o.unsubscribe(e)}};m.push({context:e.context,favoriteCtxManager:a}),t=a}}return t},giveFavoriteContextManager:function(e){if(e&&e.context&&"ENOPAD3DViewer"===e.context.name)for(var t=0;t<m.length;t++)if(m[t].context===e.context)return m[t].favoriteCtxManager},unreferenceFavoriteContextManager:function(e){if(e&&e.context&&"ENOPAD3DViewer"===e.context.name)for(var t=0;t<m.length;t++)if(m[t].context===e.context)return m[t].favoriteCtxManager.unreference(),void m.splice(t,1)}})});