define("DS/CollaborativeTasks/Views/CollaborativeTasksUtils",["UWA/Core","i18n!DS/E6WCommonApps/assets/nls/CollaborativeTasksNLS"],function(e,t){"use strict";return{getErrorMessageForInvalidCredentials:function(e){var s,i;return e&&401===e.statusCode&&e.error&&-1!==e.error.indexOf("ErrorCode:1501009")&&(i="emxCollaborativeTasks.Error.InvalidCredentials",s=t.get(i)),s}}}),define("DS/CollaborativeTasks/Models/RDFTasksWorkscopeModel",["UWA/Core","DS/E6WCommonApps/Models/WorkscopeModel","DS/RDFFoundation/RDFUtils","DS/E6WCommonApps/XTaskScope","DS/E6WCommonApps/SmartSchedulerUtils"],function(e,t,s,i,a){"use strict";return t.extend({_uwaClassName:"RDFTasksWorkscopeModel",getTaskCollectionForFilter:function(s,i){var a=this.getCollectionAttribute(t.TASK_RELATION_ATTR,{mask:"dsplan:MVMask.Task.Complex",detailsMask:"dsplan:MVMask.Task.Complex"});a.setIdForCreateChild(this.id+"/dsxplan:hasTask");var o=e.clone(i||{},!1),n=this.getTaskFetchOptions(s);return e.merge(o,n),a.fetch(o),a},getTaskFetchOptions:function(e){var t={};t.url=s.expandUrl("invoke/dsxplan:getFirstLevelLeafTasks?$mask=dsplan:MVMask.Task.CollaborativeTask.Basic");var i=a.getCompletedTaskFilter(),o=[{versionURI:this.id,filter:e,fromCompletionDate:i}];return t.data=JSON.stringify(o),t.headers={"Content-Type":"application/json"},t.method="POST",t},hasFetchedAttribute:function(e){return"dsxplan:hasTask"===e?this._collections[e]:this._parent.apply(this,arguments)}})}),define("DS/CollaborativeTasks/Views/TasksTableConfig",["UWA/Core","DS/E6WCommonUI/UIHelper","DS/E6WCommonApps/Models/TaskModelMixin","DS/Handlebars/Handlebars4","DS/E6WCommonApps/TreeNodeUtil","i18n!DS/E6WCommonApps/assets/nls/CollaborativeTasksNLS","i18n!DS/E6WCommonApps/assets/nls/E6WCommonAppsNLS","DS/E6WCommonApps/Models/E6WCommonAppsConstants","text!DS/CollaborativeTasks/assets/templates/personFieldOnGrid.html.handlebars","text!DS/CollaborativeTasks/assets/templates/contextFieldOnGrid.html.handlebars"],function(e,t,s,i,a,o,n,l,r,c){"use strict";var d=function(e){var t=o.get(e);return t===e&&(t=n.get(e)),t},u=i.compile(r),h=i.compile(c),p="references",m="deliverables",g={attachment_or_deliverable:"attachmentOrDeliverableIconContent",context:"contextContent",project:"projectContent",assignee:"taskAssigneesContent",owner:"taskOwnerContent"},C=function(e,t){return(e=e?new Date(e):new Date("10/10/200"))-(t=t?new Date(t):new Date("10/10/200"))},T={[a.COLUMN_DATA_INDICES.context]:"contextForSort",[a.COLUMN_DATA_INDICES.assignees]:"assigneesForSort",[a.COLUMN_DATA_INDICES.owner]:"ownerForSort",[a.COLUMN_DATA_INDICES.project]:"parentForSort"},f=function(e,t,s){var i=this.reuseCellContent(g.attachment_or_deliverable);i.empty(),e.getAttributeValue("correspondingModel").get(s).length?t._setReusableContent(i):t._setReusableContent(null)},v=function(e){if(!e)return 0;var t=e.indexOf(d("E6WCommonApps.Label.Hours"));return-1!==t?Number(e.substring(0,t))/8:Number(e.substring(0,e.indexOf(d("E6WCommonApps.Label.Days"))))},b=function(e,t){var s="",i=e.getAttributeValue(T[t]);return i?(Array.isArray(i)&&i.length>=1?i.forEach(e=>{s=s+" "+e.name}):s=s+" "+i.name,s):s},k=[{text:d("E6WCommonApps.Label.Title"),dataIndex:a.COLUMN_DATA_INDICES.title,typeRepresentation:"string",editableFlag:!1,sortableFlag:!0,visibleFlag:!0,className:"grid-title-cell",getCellSemantics:function(e){return{icon:"fonticon fonticon-bpa "+e.nodeModel.getAttributeValue("correspondingModel").getFonticonValue()}}},{text:d("E6WCommonApps.Label.Description"),dataIndex:a.COLUMN_DATA_INDICES.description,typeRepresentation:"string",editableFlag:!1,sortableFlag:!0,visibleFlag:!0,allowUnsafeHTMLContent:!0},{text:d("emxCollaborativeTasks.Label.Contributing"),dataIndex:a.COLUMN_DATA_INDICES.context,typeRepresentation:"string",editableFlag:!1,sortableFlag:!0,visibleFlag:!0,customContentId:g.context,onCellRequest:function(e){(function(e,t){var s=e.getAttributeValue("correspondingModel"),i=this.reuseCellContent(g.context);i.empty();var o={};s.isRDFTask()||(o=s.dataForRendering().context,i.setHTML(h({lData:o}))),i.computeContentSize=function(){return 10*(o.title&&o.title.length+2)},t._setReusableContent(i),e.setAttribute(T[a.COLUMN_DATA_INDICES.context],o)}).call(this,e.nodeModel,e.cellView)},getCellValueForSort:b},{text:d("E6WCommonApps.Label.Parent"),dataIndex:a.COLUMN_DATA_INDICES.project,typeRepresentation:"string",editableFlag:!1,sortableFlag:!0,visibleFlag:!0,customContentId:g.project,onCellRequest:function(e){(function(e,t){var s,i=e.getAttributeValue("correspondingModel"),o=this.reuseCellContent(g.project);o.empty(),s=i.isRDFTask()?i.getParent()&&i.getParent().dataForRendering():i.dataForRendering().DPMProject,o.setHTML(h({lData:s})),o.computeContentSize=function(){return 10*(s.title&&s.title.length+2)},t._setReusableContent(o);var n=e.getAttributeValue(T[a.COLUMN_DATA_INDICES.project]);n&&n.isNoAccessModel&&s.isNoAccessModel||e.setAttribute(T[a.COLUMN_DATA_INDICES.project],s)}).call(this,e.nodeModel,e.cellView)},getCellValueForSort:b},{text:d("E6WCommonApps.Label.RouteContent"),dataIndex:a.COLUMN_DATA_INDICES.routeContent,typeRepresentation:"string",editableFlag:!1,sortableFlag:!0,visibleFlag:!0},{text:d("E6WCommonApps.Label.RouteTaskAction"),dataIndex:a.COLUMN_DATA_INDICES.routeTaskAction,typeRepresentation:"string",editableFlag:!1,sortableFlag:!0,visibleFlag:!0},{text:d("E6WCommonApps.Label.RouteTaskInstructions"),dataIndex:a.COLUMN_DATA_INDICES.routeTaskInstructions,typeRepresentation:"string",editableFlag:!1,sortableFlag:!0,visibleFlag:!0},{text:d("E6WCommonApps.Label.MaturityState"),dataIndex:a.COLUMN_DATA_INDICES.maturity,typeRepresentation:"string",editableFlag:!1,sortableFlag:!0,visibleFlag:!0,getCellClassName:function(e){return e.cellModel===d("emxCollaborativeTasks.Label.Preliminary")?"maturity-state-draft":e.cellModel===d("emxCollaborativeTasks.Label.ToDo")?"maturity-state-todo":e.cellModel===d("emxCollaborativeTasks.Label.InWork")?"maturity-state-inwork":e.cellModel===d("emxCollaborativeTasks.Label.InReview")?"maturity-state-review":e.cellModel===d("emxCollaborativeTasks.Label.Completed")?"maturity-state-completed":""}},{text:d("E6WCommonApps.Label.Priority"),dataIndex:a.COLUMN_DATA_INDICES.priority,typeRepresentation:"string",editableFlag:!1,sortableFlag:!0,visibleFlag:!0,getCellSemantics:function(e){var t={icon:"fonticon fonticon-medium priority-for-grid"};return e.cellModel===d("E6WCommonApps.Label.Low")?t.icon="fonticon fonticon-low":e.cellModel===d("E6WCommonApps.Label.High")?t.icon="fonticon fonticon-high":e.cellModel===d("E6WCommonApps.Label.Urgent")&&(t.icon="fonticon fonticon-alert"),t}},{text:d("E6WCommonApps.Label.PlannedStart"),dataIndex:a.COLUMN_DATA_INDICES.estimatedStartDate,typeRepresentation:"date",editableFlag:!1,sortableFlag:!0,visibleFlag:!0,compareFunction:C},{text:d("E6WCommonApps.Label.PlannedEnd"),dataIndex:a.COLUMN_DATA_INDICES.estimatedFinishDate,typeRepresentation:"date",editableFlag:!1,sortableFlag:!0,visibleFlag:!0,compareFunction:C},{text:d("E6WCommonApps.Label.Duration"),dataIndex:a.COLUMN_DATA_INDICES.estimatedDuration,typeRepresentation:"string",editableFlag:!1,sortableFlag:!0,visibleFlag:!0,compareFunction:function(e,t){return v(e)-v(t)}},{text:d("E6WCommonApps.Label.Attachments"),dataIndex:a.COLUMN_DATA_INDICES.attachments,typeRepresentation:"string",editableFlag:!1,sortableFlag:!1,customContentId:g.attachment_or_deliverable,onCellRequest:function(e){f.call(this,e.nodeModel,e.cellView,p)}},{text:d("E6WCommonApps.Label.Deliverables"),dataIndex:a.COLUMN_DATA_INDICES.deliverables,typeRepresentation:"string",editableFlag:!1,sortableFlag:!1,customContentId:g.attachment_or_deliverable,onCellRequest:function(e){f.call(this,e.nodeModel,e.cellView,m)}},{text:d("E6WCommonApps.Label.ActualStart"),dataIndex:a.COLUMN_DATA_INDICES.actualStartDate,typeRepresentation:"date",editableFlag:!1,sortableFlag:!0,visibleFlag:!0,compareFunction:C},{text:d("E6WCommonApps.Label.ActualEnd"),dataIndex:a.COLUMN_DATA_INDICES.actualFinishDate,typeRepresentation:"date",editableFlag:!1,sortableFlag:!0,visibleFlag:!0,compareFunction:C},{text:d("E6WCommonApps.Label.Created"),dataIndex:a.COLUMN_DATA_INDICES.created,typeRepresentation:"date",editableFlag:!1,sortableFlag:!0,visibleFlag:!0,compareFunction:C},{text:d("E6WCommonApps.Label.LastUpdated"),dataIndex:a.COLUMN_DATA_INDICES.modified,typeRepresentation:"date",editableFlag:!1,sortableFlag:!0,visibleFlag:!0,compareFunction:C},{text:d("E6WCommonApps.Label.Assignees"),dataIndex:a.COLUMN_DATA_INDICES.assignees,typeRepresentation:"string",editableFlag:!1,sortableFlag:!0,visibleFlag:!0,customContentId:g.assignee,onCellRequest:function(e){(function(e,t){var i=e.getAttributeValue("correspondingModel"),o=this.reuseCellContent(g.assignee),n=i&&i.dataForRendering({attributes:[s.ASSIGNEESATTR]}).assignees;n&&n.length>=1?o.setHTML(u({persons:n,multiple:1!==n.length})):n&&0===n.length&&o.setHTML(u({noPerson:!0})),o.computeContentSize=function(){var e=0;return n&&1===n.length?e=n[0].firstname&&n[0].lastname?n[0].firstname.length+n[0].lastname.length:n[0].name.length:n&&n.length>1?e=3*n.length:n&&0===n.length&&(e=0),10*e},t._setReusableContent(o),e.setAttribute(T[a.COLUMN_DATA_INDICES.assignees],n)}).call(this,e.nodeModel,e.cellView)},getCellValueForSort:b},{text:d("E6WCommonApps.Label.Owner"),dataIndex:a.COLUMN_DATA_INDICES.owner,typeRepresentation:"string",editableFlag:!1,sortableFlag:!0,visibleFlag:!0,customContentId:g.owner,onCellRequest:function(e){(function(e,t){var i,o=e.getAttributeValue("correspondingModel"),n=this.reuseCellContent(g.owner),l=o.dataForRendering({attributes:[s.OWNERATTR]}).ownerInfo;i=l?{persons:Array.isArray(l)?l:[l],multiple:!1}:{noPerson:!0},n.computeContentSize=function(){var e=0;return i.persons&&(e=i.persons[0].firstname&&i.persons[0].lastname?i.persons[0].firstname.length+i.persons[0].lastname.length:i.persons[0].name.length),10*e},n.setHTML(u(i)),t._setReusableContent(n),e.setAttribute(T[a.COLUMN_DATA_INDICES.owner],Array.isArray(l)?l:[l])}).call(this,e.nodeModel,e.cellView)},getCellValueForSort:b}];return window.widget&&window.widget.getValue("appId")===l.APP_3DPLAN&&(k.splice(4,3),k.splice(2,1)),{columns:k,reusableComponentIDs:g,lengthOfEachCharacter:10}}),define("DS/CollaborativeTasks/Collections/MergingSplitCollection",["UWA/Core","DS/E6WCommonUI/Collections/MergingCollection"],function(e,t){"use strict";var s=t.extend({_uwaClassName:"MergingSplitCollection",getSaveAttributes:function(){return this._subCollections[0].getSaveAttributes.apply(this,arguments)},dataForRendering:function(){var e=this._subCollections[0],t=e.dataForRendering.apply(e,arguments),s=this._subCollections[1],i=s.dataForRendering.apply(s,arguments);return t.filteredCount=t.filteredCount+i.filteredCount,t}});return Object.defineProperty(s.prototype,"extid",{get:function(){return this._subCollections[0].extid}}),Object.defineProperty(s.prototype,"_valueForFiltering",{get:function(){return this._subCollections[0]._valueForFiltering}}),Object.defineProperty(s.prototype,"_filterAttr",{get:function(){return this._subCollections[0]._filterAttr}}),s}),define("DS/CollaborativeTasks/XTaskTagUtils",[],function(){"use strict";var e={setTagColors:function(t){e.colorData={values:{}},e.colorData.attr=t.tagColors[0].predicate.split(":").pop(),t.tagColors.forEach(function(t){e.colorData.values[t.object]=t.color})},unsetTagColors:function(){e.colorData=void 0},hasTagColors:function(){return Boolean(e.colorData)},getColorForModel:function(t){var s;if(e.hasTagColors()){var i=t.get("_tagData");if(i){var a=i[e.colorData.attr];s=e.colorData.values[a]}}return s}};return e}),define("DS/CollaborativeTasks/Views/CustomizedStartStopView",["UWA/Core","DS/E6WCommonUI/Views/StartStopView"],function(e,t){"use strict";return t.extend({_uwaClassName:"E6WCommonUIStartStopView",template:function(){var e=arguments[0].data;return e&&this.setEditFlagOnFields(e),this._parent.apply(this,arguments)},_clearValidationErrors:function(){this._parent.apply(this,arguments);var e=this.container.getElements(".has-error");if(e.length>0)for(var t=0;t<e.length;t++)e[t].toggleClassName("has-error",!1)}})}),define("DS/CollaborativeTasks/Models/UserGroupModel",["DS/Foundation2/Models/ReferenceModel","DS/E6WCommonUI/PlatformManager","DS/E6WCommonUI/UIHelper","i18n!DS/E6WCommonUI/assets/nls/E6WCommonUINLS"],function(e,t,s,i){"use strict";return e.extend({_uwaClassName:"UserGroupModel",dataForRendering:function(){return this._parent.apply(this,arguments)},setup:function(){return this.setViewAccess(Boolean(this.get("Title"))),this._parent.apply(this,arguments)},setViewAccess:function(e){this._hasViewAccess=e},canShowProperties:function(){return!1},hasViewAccess:function(){return this._hasViewAccess},get:function(e){var s=this._parent.apply(this,arguments);switch(e){case"name":return this.hasViewAccess()?this.get("Title")||s:i.get("E6WCommonUI.Label.PrivateGroup");case"image":try{return this.hasViewAccess()?t.getServiceUrl("usersgroup")+"/3drdfpersist/common/images/T_dsaccess_Group.png":require.toUrl("DS/E6WCommonApps/assets/img/defaultGroupPrivate.png")}catch(e){return s}}return s}})}),define("DS/CollaborativeTasks/Views/TaskMenuMixin",["UWA/Core","DS/Foundation2/FoundationV2Data","DS/UIKIT/DropdownMenu","DS/UIKIT/Input/ButtonGroup","DS/UIKIT/Input/Button","DS/E6WCommonUI/UIHelper","DS/E6WCommonApps/DeleteUtil","DS/E6WCommonApps/DuplicateItemUtils","DS/E6WCommonApps/SmartSchedulerUtils","DS/E6WCommonApps/Models/NoAccessModel","DS/E6WCommonApps/Models/E6WCommonAppsConstants","i18n!DS/E6WCommonUI/assets/nls/E6WCommonUINLS","i18n!DS/E6WCommonApps/assets/nls/CollaborativeTasksNLS"],function(e,t,s,i,a,o,n,l,r,c,d,u,h){"use strict";var p=function(e){var s=u.get(e);return s===e&&(s=h.get(e)),s===e&&(s=t.getWidgetConstant.apply(this,arguments)),s};return{createMenuButtons:function(){var e=this,t=[];return t.push({className:e.editItemClassName(),fonticon:"pencil",text:p("emxCollaborativeTasks.Command.Edit"),func:function(){e.dispatchEvent("onTaskCardClicked",e)}},this.getAssignToSelfMenuConfig(this.model)),t=e.getConditionalDropMenuItems(t),this.isRouteTask(this.model)&&"Assign"===this.model.get("state")&&"Approve"===this.model.get("routeTaskAction")?t=this.getApprovalMenuItems(t,this.model):t.push(this.getCompleteMenuConfig(this.model)),this.shouldShowDuplicateOption()&&t.push(this.getDuplicateMenuConfig({model:this.model,parentView:this.getParentView()})),t.push(this.getBookmarkMenuConfig(this.model)),t.push(this.getDeleteMenuConfig({model:this.model,parentView:this.getParentView()})),e.getCardMenu(t)},shouldShowDuplicateOption:function(){var t=!1;t=!(this.isRouteTask(this.model)||this.model&&this.model.isProjectTask&&this.model.isProjectTask());var s=e.is(this.model.getParent,"function")&&this.model.getParent();return(!s||s&&s instanceof c)&&(t=!1),t},isRouteTask:function(e){var t=this.model||e;return t&&t.isRouteTask&&t.isRouteTask()},getBookmarkMenuConfig:function(e){var t=r.getBookmarkURLMenuConfig(e);return this._bookmarkHandler=t.handler,t},getAssignToSelfMenuConfig:function(e){var t=this,s=!1;return e.hasFetchedAccessData()&&(s=!t.assignToSelfItemAccess(e)),{className:t.assignToSelfItemClassName(),fonticon:"user-add",disabled:s,text:p("E6WCommonUI.Command.AssignToSelf"),handler:function(){t.assignToSelf(e)}}},getDuplicateMenuConfig:function(t){var s=this,i=e.clone(t||{},!1).model,a=!1;return i&&i.hasFetchedAccessData()&&(a=this.duplicateItemAccess(i,t)),!a&&(a=t&&e.is(t.taskHasSubTasks,"function")&&t.taskHasSubTasks(i)),{className:"item-duplicate",fonticon:"duplicate",disabled:a,text:p("E6WCommonUI.Label.Duplicate"),func:function(e){s.duplicateItemCallback(e,t)}}},getCompleteMenuConfig:function(e){var t=!1;return e.hasFetchedAccessData()&&(t=!this.completeItemAccess(e)&&!this.reOpenItemAccess(e)),{className:this.completeItemClassName()+(e.isComplete()?"re-open":""),fonticon:e.isComplete()?"reset":"check",disabled:t,text:e.isComplete()?p("emxCollaborativeTasks.Command.ReOpen"):p("emxCollaborativeTasks.Command.Complete"),handler:this.toggleStateIntoOrOutOfDone.bind(this,e)}},getDeleteMenuConfig:function(t){var s=this,i=e.clone(t||{},!1).model,a=!1;return i&&i.hasFetchedAccessData()&&(a=this.isRouteTask(i)||!this.deleteItemAccess(i)),!a&&(a=o.isWedoTask(i.get("dsxplan:jsType"))),{className:this.deleteItemClassName(),fonticon:"trash",disabled:a,text:p("emxCollaborativeTasks.Command.Delete"),func:function(e){s.deleteItemCallback(e,t)}}},getApprovalMenuItems:function(e,t){var s,i=!1,a=function(e){var s=t.collection&&t.collection.allRouteTaskApprovalActions&&t.collection.allRouteTaskApprovalActions();return s&&s.find(t=>t.actualValue===e)};return t&&t.hasFetchedAccessData()&&(i=!this.approvalActionsItemAccess(t)),t&&"Assign"===t.get("state")&&"Approve"===t.get("routeTaskAction")&&(e.push({className:"header",text:p("emxCollaborativeTasks.Command.ApprovalAction")}),(s=a("Approve"))&&e.push({className:this.approveItemClassName(),fonticon:"thumbs-up",disabled:i,name:"approve",selectable:!0,selected:t&&"Approve"===t.get("routeTaskApprovalAction"),text:s.displayValue,handler:this.handleApprovalActions.bind(this,t,"Approve")}),(s=a("Reject"))&&e.push({className:this.rejectItemClassName(),fonticon:"thumbs-down",disabled:i,name:"reject",selectable:!0,selected:t&&"Reject"===t.get("routeTaskApprovalAction"),text:s.displayValue,handler:this.handleApprovalActions.bind(this,t,"Reject")}),(s=a("Abstain"))&&e.push({className:this.abstainItemClassName(),fonticon:"ignore",disabled:i,name:"abstain",selectable:!0,selected:t&&"Abstain"===t.get("routeTaskApprovalAction"),text:s.displayValue,handler:this.handleApprovalActions.bind(this,t,"Abstain")}),e.push({className:"divider"})),e},getConditionalDropMenuItems:function(e){var t=this.isRouteTask(),s=this,i=this.isModelAProjectTask();if(this.subscribedToItem()&&!i&&!t&&this.model.subscriptionsEnabled()?e.push({className:s.unsubscribeItemClassName(),fonticon:"rss",visible:!1,text:p("emxCollaborativeTasks.Command.Unsubscribe"),func:function(){s.toggleSubscription()}}):i||t||!this.model.subscriptionsEnabled()||e.push({className:s.subscribeItemClassName(),fonticon:"rss",text:p("emxCollaborativeTasks.Command.Subscribe"),func:function(){s.toggleSubscription()}}),i){var a={className:s.launchItemClassName(),fonticon:"logout",text:p("emxCollaborativeTasks.Command.OpenProjectItem"),func:function(e){s.openProjectItemCallback(e)}};e.splice(1,0,a)}return e},getCardMenu:function(e){return{value:"",dropdownCaret:!1,removeOnHide:!0,id:this.menuId(),className:"link",icon:"fonticon-open-down",dropdown:{items:e},events:{onDropdownClick:function(e,t){t&&"function"==typeof t.func&&t.func()}}}},setDescriptionForLargeCards:function(e,t){var s=t.get(d.DESCRIPTION_ATTR);if(s){var i='<div class="card-description">';t.isRDFTask()?e.replace("<pre></pre>",""):i+="<pre>";var a=e.indexOf(i)+i.length;e=e.slice(0,a)+s+e.slice(a)}return e},deleteItemClassName:function(){return"item-delete"},completeItemClassName:function(){return"item-complete"},launchItemClassName:function(){return"item-launch"},subscribeItemClassName:function(){return"item-subscribe"},unsubscribeItemClassName:function(){return"item-unsubscribe"},assignToSelfItemClassName:function(){return"item-assign"},editItemClassName:function(){return"item-edit"},approveItemClassName:function(){return"item-approve"},rejectItemClassName:function(){return"item-reject"},abstainItemClassName:function(){return"item-abstain"},toggleSubscription:function(){this.model.save("subscribed",String(!this.subscribedToItem()).toUpperCase(),{patch:!0,onFailure:function(){var e=p("emxCollaborativeTasks.Error.FailSubscription");o.displayError(e)}})},deleteItemAccess:function(e){return(this.model||e).canDelete()},duplicateItemAccess:function(t){var s=this.model||t;return e.is(s.canModify,"function")&&!s.canModify()},completeItemAccess:function(e){var t=this.model||e,s=!t.isComplete()&&t.get("canEdit");return s&&t.isProjectTask()&&"Yes"===t.get("needsReview")&&"Review"!==t.get("state")&&(s=!1),s},approvalActionsItemAccess:function(e){var t=this.model||e;return t.isRouteTask()&&"Assign"===t.get("state")&&"Approve"===t.get("routeTaskAction")&&t.get("canEdit")},reOpenItemAccess:function(e){var t=this.model||e,s=!t.isRouteTask()&&t.isComplete();return t.isRDF&&(s=s&&t.get("canEdit")),s},subscribedToItem:function(){var e=this.model&&this.model.get("subscribed");return void 0===e&&(e="false"),"TRUE"===e},isModelAProjectTask:function(){return this.model&&this.model.isProjectTask()},deleteItemCallback:function(t,s){var i=e.clone(s||{},!1),a=i.model||this.model,o=i.parentView||this._parentView;e.extend(i,{model:a,parentView:o}),this.deleteItemAccess(a)&&n.deleteItem(i)},duplicateItemCallback:function(t,s){var i=e.clone(s||{},!1),a=i.model||this.model,o=i.parentView||this._parentView;e.extend(i,{model:a,parentView:o}),this.duplicateItemAccess(a)||l.duplicateItem(i)},openProjectItemCallback:function(s){var i="string"===e.typeOf(s)?s:this.model.id,a=t.calculateFinalUrl("/emxLogin.jsp?appName=ENOPRPR_AP&physicalId="+i);return window.open(a,"projectWindow"),!0},toggleStateIntoOrOutOfDone:function(e){var t,s,i=this.model||e,a=this.options&&this.options.stateValues||this.getColumn().options.stateValues,n=a&&a.length,l=i.get("dsxplan:jsType")||i.get("type");s=o.isMilestone(l)||o.isGate(l)?i.isComplete()?"Review":"Complete":i.isComplete()?"Active":"Complete";for(var r=0;r<n;r++)if(a[r].actualValue===s){t=a[r];break}i.isComplete()?this.reOpenItem(t,i):this.completeItem(t,i)},reOpenItem:function(t,s){var i=this.model||s,a=e.clone(t,!1);i.isRDF&&(a.displayValue=p("emxCollaborativeTasks.Label.InProgress"));var o=this.stateChangeOptions(a.displayValue);i.save("state",a.actualValue,o)},completeItem:function(t,s){var i=this.model||s;if(!i.isComplete()){var a=e.clone(t,!1);i.isRDF&&(a.displayValue=p("emxCollaborativeTasks.Label.Done"));var o=p("emxCollaborativeTasks.Error.FailSetToComplete"),n=this.stateChangeOptions(a.displayValue,o),l={state:a.actualValue};i.save(l,n)}},createApprovalActionsControl:function(e){var t=this;return new i({buttons:[new a({icon:e.fonticon,events:{onClick:function(){var e=this.elements.content.getParent(".panel-action"),s="Approve";e.hasClassName("item-reject")?s="Reject":e.hasClassName("item-abstain")&&(s="Abstain"),t.handleApprovalActions(t.model,s)}}}),new a({dropdown:{items:this.getApprovalMenuItems([],t.model)}})]})},handleApprovalActions:function(e,t){var s=this.model||e,i=s&&"No"!==s.get("needsReview");if(!s.isComplete()){this._detailsView&&this._detailsView.model.modificationsPending&&this._detailsView.model.save();var a={};a.routeTaskApprovalAction=t;for(var o,n=this.options&&(this.options.stateValues||this._parentView.options.stateValues),l=n&&n.length,r=i?"Review":"Complete",c=0;c<l;c++)if(n[c].actualValue===r){o=n[c].displayValue;break}var d={actualValue:r,displayValue:o},u=p("emxCollaborativeTasks.Error.FailSetToComplete"),h=this.stateChangeOptions(d.displayValue,u);a.state=d.actualValue,s.save(a,h)}},stateChangeOptions:function(e,t){return{patch:!0,onComplete:function(){var t=p("emxCollaborativeTasks.Label.SuccessfullyChangedAttribute");t=(t=t.replace("%ATTRIBUTE_NAME%",p("emxCollaborativeTasks.Command.View.state"))).replace("%ATTRIBUTE_VALUE%",e),o.displaySuccess(t)},onFailure:function(s,i,a){var n;n=t||(n=(n=p("emxCollaborativeTasks.Error.FailedToChangeAttribute")).replace("%ATTRIBUTE_NAME%",p("emxCollaborativeTasks.Command.View.state"))).replace("%ATTRIBUTE_VALUE%",e),a&&a.response&&400===a.response.statusCode&&a.response.error&&(n+="<br>"+p(o.sanitizeMessage(a.response.error))),o.displayError(n)}}},assignToSelfItemAccess:function(e){return(this.model||e).canAssignToSelf()},assignToSelf:function(e){var t=this.model||e;this.assignToSelfItemAccess(t)&&t.assignToSelf()},menuId:function(){return"menu-card"},getParentView:function(){return(this._column||this)._parentView}}}),define("DS/CollaborativeTasks/Views/CardViewHandler",["UWA/Core","UWA/Class","DS/Handlebars/Handlebars4","DS/UIKIT/Input/Button","DS/CollaborativeTasks/Views/TaskMenuMixin","DS/CollaborativeTasks/XTaskTagUtils","DS/E6WCommonApps/Models/E6WCommonAppsConstants","DS/E6WCommonUI/Views/E6WHandlebarsHelpers","text!DS/CollaborativeTasks/assets/templates/cardContent.html.handlebars","text!DS/CollaborativeTasks/assets/templates/cardHandler.html.handlebars","i18n!DS/E6WCommonApps/assets/nls/CollaborativeTasksNLS"],function(e,t,s,i,a,o,n,l,r,c,d){"use strict";var u=d.get.bind(d),h=s.compile(r),p=s.compile(c),m=new Map;m.set("Low",n.PRIORITY_LOW_ICON),m.set("Medium",n.PRIORITY_MEDIUM_ICON),m.set("High",n.PRIORITY_HIGH_ICON),m.set("Urgent",n.PRIORITY_URGENT_ICON);var g=t.extend({_uwaClassName:"CardViewHandler",init:function(e){this._column=e.column},getCardHtml:function(e,t){return p({index:t,id:e.id,color:!e.isBlank&&o.getColorForModel(e),hasProgress:!e.isBlank,cardContent:g.prototype.getCardContentHtml(e)}).trim()},generateMenu:function(e){var s=e.querySelector(".card-menu"),a=this.createMenuButtons(),o=s.querySelector("button");s.removeChild(o),(a=new i(a)).inject(s);var n=new t.Listener;return n.listenTo(a.dropdown,"onShow",function(){document.addEventListener("contextmenu",a.dropdown.events.document.click,!0)}),n.listenTo(a.dropdown,"onHide",function(){document.removeEventListener("contextmenu",a.dropdown.events.document.click,!0)}),a},getCardContentHtml:function(e){e.calculateAndSetUpListenersForVisualAttributesIfNeeded();var t=e.dataForRendering({attributes:["id","title","dueDate","assignees","name","firstname","lastname","state","stateForDisplay","priority",n.USER_DEFINED_START_DATE_ATTR,n.USER_DEFINED_END_DATE_ATTR,n.ACTUAL_DELIVERABLE_ATTR,n.ATTACHMENT_ATTR,"hasFiles","atRisk","readyToStart","late","compressionLevel","percentComplete"]});e.isBlank||this._addDataForLargeCards(e,t),t.priority=m.get(t.priority),t.isFixed=t[n.USER_DEFINED_START_DATE_ATTR]||t[n.USER_DEFINED_END_DATE_ATTR],t.isComplete="Complete"===t.state,t.late?(t.status="late",t.percentCompleteTooltip=u("emxCollaborativeTasks.Label.Late")):t.atRisk?t.status="at-risk":t.readyToStart?(t.status="ready-to-start",t.compression=t.compressionLevel?"at-risk":"on-time"):t.isComplete?t.status="complete":t.status=t.compressionLevel?"at-risk":"on-time","at-risk"!==t.status&&"at-risk"!==t.compression||(t.percentCompleteTooltip=u("emxCollaborativeTasks.Label.Risk")),t.assignees&&t.assignees.length>3&&(t.moreAssignees=!0);var s=l.i18n;l.i18n=u;var i=h(t).trim();return l.i18n=s,i=this.setDescriptionForLargeCards(i,e)},_addDataForLargeCards:function(e,t){t.parent=e.getParentAsLabel(),t.explicitTagsData=e.get(n.EXPLICIT_TAGS_DATA)},setModel:function(e,t){this.model=e,this.cardDiv=t},dispatchEvent:function(){this.model.isBlank||this._column.cardClicked(this.cardDiv,this.model)},getColumn:function(){return this._column}});return g.implement(a),g}),define("DS/CollaborativeTasks/Models/TaskModel",["UWA/Core","DS/Foundation2/FoundationV2Data","DS/Foundation2/Models/FoundationBaseModel","DS/Foundation2/Models/ReferenceModel","DS/Foundation2/Collections/FoundationBaseCollection","DS/E6WCommonUI/UIHelper","DS/TreeModel/TreeNodeModel","DS/E6WCommonApps/Models/TaskModelMixin","DS/E6WCommonApps/Models/FileManagementMixin","DS/E6WCommonApps/XTaskScope","DS/Foundation2/Collections/ProxyFoundationBaseCollection","DS/CollaborativeTasks/Models/UserGroupModel","DS/E6WCommonApps/TreeNodeUtil","DS/E6WCommonApps/Models/E6WCommonAppsConstants","i18n!DS/E6WCommonUI/assets/nls/E6WCommonUINLS"],function(e,t,s,i,a,o,n,l,r,c,d,u,h,p,m){"use strict";var g=function(e){var s=m.get(e);return s===e&&(s=t.getWidgetConstant.apply(this,arguments)),s},C={"To Do":"Assign","In Progress":"Active",Done:"Complete"},T={Create:"To Do",Assign:"To Do",Active:"In Progress",Review:"In Progress",Complete:"Done"},f=i.extend({}),v=null;f.typeAheadCallback=function(e,s,i){return null!==v&&(v.cancel(),v=null),v=t.ajaxRequest({url:"/resources/v2/e6w/service/PersonSearch?searchStr="+s+"*",type:"get",dataType:"json",callback:function(e){var t=[];if(v=null,e.success&&e.data&&e.data.length)for(var s=e.data.length,a=0;a<s;a++){var n=e.data[a];if(n.dataelements){var l=n.dataelements.firstname||"",r=n.dataelements.lastname||"",c=n.dataelements.name||"";t.push({value:n.id,label:l+" "+r,image:o.userPictureURL(c)})}}i(t)},headers:{"content-type":"application/json"}})},f.get=function(e){var t=this._parent.apply(this,arguments);switch(e){case"dsaccess:accountName":return!t&&this.get("name")}return t};var b=function(e,t){switch(e.type){case"Group":case"Group Proxy":return new u(e,t);default:return new f(e,t)}};b.prototype.idAttribute="id";var k=a.childCollection.extend({}),S=s.extend({ASSIGNEESATTR:"assignees",_relations:[{key:"assignees",collectionType:k,serviceName:"ObjectInfo",relatedModel:b},{key:"originatorInfo",relatedModel:f,collectionType:k,serviceName:"ObjectInfo",isCardinalityOne:!0},{key:"ownerInfo",relatedModel:f,collectionType:k,serviceName:"ObjectInfo",isCardinalityOne:!0},{key:p.COOWNERATTR,relatedModel:f,collectionType:k,serviceName:"ObjectInfo"},{key:"references",serviceName:"ObjectInfo",collectionType:d},{key:"scopes",serviceName:"ObjectInfo",relatedModel:i,isCardinalityOne:!0},{key:"contents",serviceName:"ObjectInfo",relatedModel:i},{key:"deliverables",serviceName:"ObjectInfo",collectionType:d},{key:"referencedSimulations",serviceName:"ObjectInfo",collectionType:d},{key:"dependenciesPredecessors",serviceName:"ObjectInfo",relatedModel:i},{key:"DPMProject",serviceName:"ObjectInfo",relatedModel:i,isCardinalityOne:!0},{key:"route",serviceName:"ObjectInfo",relatedModel:i,isCardinalityOne:!0},{key:"dependenciesSuccessors",serviceName:"ObjectInfo",relatedModel:i},{key:"predecessors",relatedModel:i},{key:"successors",relatedModel:i}],_uwaClassName:"TaskModel",addAssigneesByName:function(e){var t=e.map(function(e){return{image:o.userPictureURL(e)}});return this.addObjects(e,this.getMappedAttribute(this.ASSIGNEESATTR),"name",{otherObjectAttributes:t})},getTreeNodeModel:function(){if(this._treeNodeModel)this._treeNodeModel.show();else{var e=this.createNodeData();this._treeNodeModel=new n({label:e.title,grid:e}),h.addListenersOnTreeNode(this._treeNodeModel)}return this._treeNodeModel},assignToSelf:function(){var e=this;this.addAssigneesByName([window.enoviaServer.user]),this.save(null,{patch:!0,onComplete:function(){e.dispatchEvent("onChange:"+e.ASSIGNEESATTR);var t=g("emxCollaborativeTasks.Label.SuccessfullyAssignedToSelf");o.displaySuccess(t)},onFailure:function(){var e=g("emxCollaborativeTasks.Error.FailAssignToSelf");o.displayError(e)}})},_getValidationOptions:function(e){var t="false"!==g("emxComponents.Routes.ShowCommentsForTaskApproval").toLowerCase().trim(),s=t&&"false"!==g("emxComponents.Routes.EnforceAssigneeApprovalComments").toLowerCase().trim(),i="false"!==g("emxComponents.Routes.EnforceOwnerReviewComments").toLowerCase().trim();return{needsReview:e.needsReview,newState:e.state,currentState:this.get("state"),showComments:t,enforceAssigneeApprovalComments:s,enforceOwnerReviewComments:i}},_validateNeedsReview:function(e,t,s){"Review"!==s.currentState&&"Complete"!==s.currentState&&"Complete"===s.newState&&"Yes"===s.needsReview&&t.fields.push("needsReview")},validate:function(e){var t,s={fields:[]},i=this._getValidationOptions(e);return this._validateNeedsReview(e,s,i),s.fields.length&&(t=s),t},get:function(e){switch(e){case"canEdit":return!this.isComplete()&&"TRUE"===this.get("modifyAccess");case"stateForDisplay":return this.getStateForDisplayValue();case this.DUEDATECATEGORY:return this.dueDateCategory(this.get(this.DUEDATEATTR));case p.DESCRIPTION_ATTR:return this.get("description")||this.get("routeTaskInstructions");case p.FONTICON_ATTR:return this.getFonticonValue()}return this._parent.apply(this,arguments)},getFonticonValue:function(){var e=this.getObjectType();return o.isGate(e)?"fonticon-gate":o.isMilestone(e)?"fonticon-milestone":o.isPhaseTask(e)?"fonticon-phase":this.isProjectTask()?"fonticon-project-task":this.isRouteTask()?"fonticon-route-task":"fonticon-standalone-task"},getStateForDisplayValue:function(){return T[this.get("state")]},getFieldDef:function(e){var t=this.getInMemoryData(),s=t&&t.getAllFields();return(s=s||{})[e]},getDeliverables:function(){return this.get("deliverables")&&this.get("deliverables")},getMaturityState:function(){return this.get("state")},getContext:function(){return this.get(p.SCOPEATTR)},getProject:function(){return this.get(p.DPMPROJECTATTR)},createNodeData:function(){var e={title:this.get("title"),description:h.getDisplayLabelForDescription(this.get("description")),context:this.getContext(),project:this.getProject(),maturity:h.getDisplayLabelForState(this.getMaturityState()),estimatedFinishDate:this.get("dueDate"),estimatedDuration:h.getDisplayLabelForDuration(this),attachments:this.get("references"),deliverables:this.getDeliverables(),estimatedStartDate:this.get("estimatedStartDate"),actualStartDate:this.get("actualStartDate"),actualFinishDate:this.get("actualFinishDate"),created:this.get("originated"),modified:this.get("modified"),assignees:this.get("assignees"),owner:this.get("owner"),correspondingModel:this};return this.isRouteTask()&&(e.contents=h.getDisplayLabelForRouteContent(this)),e},set:function(){var t=o.setHelper.apply(this,arguments),s=e.clone(t.attrs||{},!1),i=t.options;if(s){if(s.hasOwnProperty("stateForDisplay")){var a=s.stateForDisplay;delete s.stateForDisplay,s.state=C[a]}if(s.hasOwnProperty(this.DUEDATECATEGORY)){var n=s[this.DUEDATECATEGORY];delete s[this.DUEDATECATEGORY],this.isProjectTask()&&"NO_DATE"===n||(s[this.DUEDATEATTR]=this.dueDateCategory2DueDate(n))}return this._parent(s,i)}return this._parent.apply(this,arguments)},toJSON:function(e){var t=this._parent.apply(this,arguments);return e&&e.onlyUpdated&&!e.dataForRendering&&delete t.dueDateCategory,e&&e.dataForRendering&&(t[this.DUEDATECATEGORY]=this.get(this.DUEDATECATEGORY),t.stateForDisplay=this.get("stateForDisplay"),t[p.FONTICON_ATTR]=this.get(p.FONTICON_ATTR)),t.percentComplete&&(t.percentComplete=parseInt(t.percentComplete).toString()),t},setup:function(){this.nbInFlightRequests=0,this.listenTo(this,"onChange:DPMProject",function(){this.adjustDuration(),this._filterDatabyScope()}),this.listenTo(this,"onChange:scopes",function(){this._filterDatabyScope()}),this.listenTo(this,"onChange:assignees",function(){this._filterDatabyScope()}),this.listenTo(this,"onChange:"+p.COOWNERATTR,function(){this._filterDatabyScope()}),this.listenTo(this,"onChange:ownerInfo",function(){this._filterDatabyScope()}),this.listenTo(this,"onChange:"+this.DUEDATEATTR,function(e,t,s){s.silent||e.dispatchEvent("onChange:"+this.DUEDATECATEGORY,arguments)}),this.listenTo(this,"onChange:state",function(e,t,s){var i=T[e.previousAttributes().state],a=T[t];i===a||s.silent||e.dispatchEvent("onChange:stateForDisplay",[e,a,s])}),this.collection&&this.listenTo(this.collection,"onComplete",this._filterDatabyScope),this._parent.apply(this,arguments)},dataForRendering:function(){var e=this._parent.apply(this,arguments);return this.isComplete()?e.date=e.actualFinishDate:e.date=e.dueDate,e.context=e.scopes&&e.scopes[0],e.DPMProject=e.DPMProject&&e.DPMProject[0],e.canEdit=this.get("canEdit"),e},getPredecessors:function(){return this.get("predecessors")},getSuccessors:function(){return this.get("successors")},adjustDuration:function(){var t=this.get("estimatedDuration")||0;e.is(t,"string")&&(t=parseInt(t,10));var s=0;!this.isDPMMilestoneGate()&&this.isProjectTask()&&(s=1),t>=s||this.set("estimatedDuration",s)},isDPMMilestoneGate:function(){var e=this.get("dsxplan:jsType")||this.get("type");return o.isMilestone(e)||o.isGate(e)},isProjectTask:function(){var e=!1,t=this.get("hasProject");if(t&&"TRUE"===t.toUpperCase())e=!0;else{var s=this.get("DPMProject");e=Boolean(s&&s.length)}return e},isRouteTask:function(){return!1},isRDFTask:function(){return!1},hasChangeSOVAccess:function(){return"TRUE"===this.get("changeSOVAccess")},subscriptionsEnabled:function(){var e=t.getWidgetConstant("ENABLE_SUBSCRIPTIONS");return!this.isProjectTask()&&("true"===e||"TRUE"===e)},addObjects:function(t,s,i,a){var n=e.clone(a||{},!1);if("assignees"===s||"references"===s||"referencedSimulations"===s){var l,r,c=!1;if(n.values&&"assignees"===s)for(var d=n.values.length,u=0;u<d;u++)l=!1,r=n.values[u].get("name"),(l=o._alreadyHasObjectInRelatedData(this,s,r))&&(c=!0,o.displayAlreadyAttachedErrorMessage(this.get("title"),l));else for(var h=t.length,p=0;p<h;p++)l=!1,r=t[p],(l=o._alreadyHasObjectInRelatedData(this,s,r))&&(c=!0,o.displayAlreadyAttachedErrorMessage(this.get("title"),l));if(c)return{}}return this._parent.apply(this,arguments)},_belongsInCurrentScope:function(e,t){var s;if(!(s=-1!==this.collection.projectTypes().split(",").indexOf(t)?this.get(this.DPMPROJECTATTR):this.get(this.SCOPESATTR))){if(e)return!1;s=[]}for(var i=0;i<s.length;i++){var a=s[i].id||s[i].get("objectId");if(a&&e&&a.toUpperCase()===e.toUpperCase())return!0}return!1},_belongsInCurrentFilter:function(){var e,t=window.enoviaServer.user,s=c.getFilter(),i=[],a=this.get(this.ASSIGNEESATTR),o=this.get("ownerInfo"),n=this.get(p.COOWNERATTR);s===c.FILTER_OWNED?i=i.concat(o,n):s===c.FILTER_ASSIGNED?i=i.concat(o,a):s===c.FILTER_ALL&&(i=i.concat(o,n,a)),o&&o.length||!this.isNew()||(o={get:function(e){var s;return"name"===e&&(s=t),s}});for(var l=0;l<i.length;l++)if((e=i[l].get("name",{noMapping:!0}))&&t&&e.toUpperCase()===t.toUpperCase())return!0;return!1},_removeFromCollection:function(t){var s=this;e.Utils.setImmediate(function(){s.collection&&s.collection.remove(s),"function"==typeof t&&t()})},_filterDatabyScope:function(e){if(this.noFilter||0===this.get("ownerInfo").length||this.fetching)"function"==typeof e&&e();else if(this.collection){var t=!0,s=c.getScopeId(),i=c.getScopeType(),a=window.widget.getValue("showProjectTasks"),o=this.isProjectTask();this.isRouteTask()?t=!1:o?(t=!1===a||"false"===a,!1===a&&o&&this._belongsInCurrentScope(s,i)&&(t=!1)):s&&"tempfix"!==s&&!c.isScopeRDF()?t=!this._belongsInCurrentScope(s,i):c.isScopeRDF()||(t=!this._belongsInCurrentFilter()),t?this._removeFromCollection(e):"function"==typeof e&&e()}},uploadFile:function(t,s,i){var a=this;this._onRequest();var o=e.clone(i||{},!1),n=o.onComplete,l=o.onFailure;o.onComplete=function(){a._onCompleteRequest(),a.set("subscribed","sendEmail"),a.save(),n&&n.apply(this,arguments)},o.onFailure=function(t,s){if(a._onCompleteRequest(),l){var i=e.clone(s||{},!1);o.file=t;var n=i.errorMsg||null;l(n,i.contextModel,o)}},o.deriveCollabspace=!0,this._parent(t,s,o)},sync:function(t,s,i){var a=Array.prototype.slice.call(arguments,0),o=e.clone(i||{},!1);if(a[2]=o,"create"===t){var n=this,l=o.onComplete;o.onComplete=function(){n.completed=!0,l&&l.apply(this,arguments)}}return this._parent.apply(this,a)},handleSelfAssignToInWorkTask:function(){var e=o.setHelper.apply(this,arguments).attrs||{},t=this.get(this.ASSIGNEESATTR),s=!t||0===t.length,i=e.state,a=e.stateForDisplay,n=e.percentComplete,l=this.get("state"),r="Active"===i||"In Progress"===a,c=this.isProjectTask()&&"Active"!==l&&n&&parseFloat(n)!==parseFloat(0)&&parseFloat(n)!==parseFloat(100);s&&(r||c)&&(this.addAssigneesByName([window.enoviaServer.user]),this.addSelfAssignToInWorkMessage.apply(this,arguments))},save:function(){this.markDeliverablesOn3DNavigate(),this.handleSelfAssignToInWorkTask.apply(this,arguments),this._parent.apply(this,arguments)},getWorkDayLength:function(){return 8},getWorkingHoursInMilliseconds:function(){return 60*this.getWorkDayLength()*60*1e3},isStarted:function(){var e=this.get("state");return"Active"===e||"Review"===e},getStartDate:function(){return this.isStarted()?this.get(this.ACTUALSTARTDATEATTR):this.get("estimatedStartDate")},getPercentComplete:function(){return void 0===this.get("percentComplete")?-1:parseFloat(this.get("percentComplete"))},getEstimatedDuration:function(){var e=this.get("estimatedDuration")||0;return e&&parseFloat(e)},getDefinedDuration:function(){return this.getEstimatedDuration()},getTransferObject:function(t){var s=this.get("type"),i=e.clone(t||{},!1);i&&delete i.parentObject;var a=e.merge(i,{source:window.widget.getValue("appId")||p.APP_TSK,envId:window.enoviaServer.tenant||window.widget.getValue("x3dPlatformId"),objectId:this.id,objectType:s,displayType:o.translateType(s),objectType_Internal:s,displayName:this.get("title"),image:this.get("typeicon")});return o.getTransferObject(a)},canDelete:function(){var e=this.get("deleteAccess");e="FALSE"!==e&&e;var t=this.get("state");return e&&("Assign"===t||"Create"===t)},isReadyToStart:function(){var e=this.get("estimatedStartDate"),t=this.get("state");return this.isProjectTask()&&t&&("Create"===t||"Assign"===t)&&e&&!(new Date(new Date(e)-l.THRESHOLD)<=new Date)},getCompressionLevel:function(){return this.isProjectTask()&&"behindSchedule"===this.get("status")?1:0},hasFetchedAccessData:function(){return!0},getParentAsLabel:function(){var e;if(this.isProjectTask()){var t=this.get("DPMProject");if(t&&t[0]){var s=t[0].get("name");e={key:g("emxCollaborativeTasks.Label.Project"),value:s}}}return e},getTaggerURI:function(){return this.getTagPrefix()+this.id}});return S.implement(l,{updateDocument:r.updateDocument}),S.getAttachmentErrorMessage=function(e,t){var s="";return"assignees"===e?s=g("emxCollaborativeTasks.Error.FailedToAssignUser"):"references"===e?s=g("emxCollaborativeTasks.Error.FailedToCreateReference"):"deliverables"===e?s=g("emxCollaborativeTasks.Error.FailedToCreateDeliverable"):"scopes"===e?s=g("emxCollaborativeTasks.Error.FailedToCreateScope"):e===p.COOWNERATTR?s=g("emxCollaborativeTasks.Error.FailedToAddCoOwner"):"referencedSimulations"===e&&(s=g("emxCollaborativeTasks.Error.FailedToAddProcess")),s=s.replace("%NAME%",t)},S.getAttachmentSuccessMessage=function(e,t){var s="";return"references"===e?s=g("emxCollaborativeTasks.Success.ObjectAddedAsReference"):"deliverables"===e?s=g("emxCollaborativeTasks.Success.ObjectAddedAsDeliverable"):"referencedSimulations"===e&&(s=g("emxCollaborativeTasks.Success.ProcessAdded")),s=s.replace("%NAME%",t)},S.PersonModel=f,S.ReferenceModel=i,Object.defineProperty(S.prototype,"extid",{get:function(){return this.id}}),S.ASSIGNEESATTR="assignees",S}),define("DS/CollaborativeTasks/Views/ERTasksDetailsPanelConfig",["UWA/Core","DS/Foundation2/FoundationV2Data","DS/CollaborativeTasks/Models/TaskModel","DS/E6WCommonApps/Views/LinkLauncherUtils","DS/RDFFoundation/FederatedSearchUtil","DS/E6WCommonApps/SmartSchedulerUtils","DS/RDFFoundation/RDFUtils","DS/CollaborativeTasks/Views/CustomizedStartStopView","DS/CollaborativeTasks/Views/CollaborativeTasksUtils","DS/E6WCommonApps/Views/DependencyGroupView","DS/E6WCommonApps/Views/E6WObjectCardView","DS/E6WCommonApps/Models/E6WCommonAppsConstants","DS/E6WCommonUI/Models/DropValidator","DS/E6WCommonUI/UIHelper","DS/E6WCommonUI/PlatformManager","i18n!DS/E6WCommonApps/assets/nls/E6WCommonAppsNLS","i18n!DS/E6WCommonApps/assets/nls/CollaborativeTasksNLS"],function(e,t,s,i,a,o,n,l,r,c,d,u,h,p,m,g,C){"use strict";var T=function(e){var s=t.getWidgetConstant.apply(this,arguments);return s===e&&(s=g.get(e)),s},f={config:function(){var e=T("emxCollaborativeTasks.GroupLabel.More"),t={"3dspace":[u.SIMULATION_TYPE,u.SIMULATION_TEMPLATE_TYPE]},s=[{readWrite:"true",name:"title",label:T("E6WCommonApps.Label.Title"),type:"text",removeCarriageReturns:!0,numberOfEditableLines:4,maxLength:128,required:!0,validate:!0},{readWrite:"true",name:"description",label:T("emxCollaborativeTasks.Label.TaskDescription"),type:"textarea",numberOfDisplayLines:3,numberOfEditableLines:6},{readWrite:"true",name:"scopes",attributeToDisplay:"name",imageAttribute:"image",singleObjectOnly:!0,label:T("emxCollaborativeTasks.Label.Contributing"),type:"object",searchTitle:T("emxCollaborativeTasks.Label.ContributingSearchTitle"),customView:d,typeAheadCallback:n.typeAheadCallback,searchSource:a.filterSearchSources(["3dspace"]),linkCallback:i.launchProperties,placeHolder:T("emxCollaborativeTasks.Label.ObjectPlaceHolder"),excludeSearchTypes:{"3dspace":["Task","Inbox Task","Project Baseline","Experiment","Project Snapshot","Project Space"]},getDropDownMenuItems:o.getDocumentTypeDropDownMenuItems},{readWrite:"true",name:"DPMProject",attributeToDisplay:"name",imageAttribute:"image",singleObjectOnly:!0,label:T("emxCollaborativeTasks.Label.Project"),type:"object",searchTitle:T("emxCollaborativeTasks.Label.ProjectSearchTitle"),customView:d,typeAheadCallback:n.typeAheadCallback,searchSourceTypes:{"3dspace":["Project Space"]},searchSource:a.filterSearchSources(["3dspace"]),linkCallback:i.launchProperties,placeHolder:T("emxCollaborativeTasks.Label.ObjectPlaceHolder"),getDropDownMenuItems:o.getDocumentTypeDropDownMenuItems},{readWrite:"true",name:"state",label:T("emxCollaborativeTasks.Label.TaskMaturityState"),type:"select"},{name:"dueDate",readWrite:"true",label:T("emxCollaborativeTasks.Label.EstimatedFinishDate"),type:"date",validate:!0},{readWrite:"true",name:"estimatedDurationInputValue",unitAttribute:"estimatedDurationInputUnit",label:T("emxCollaborativeTasks.Label.estimatedDuration"),type:"uom",uomValues:[T("emxCollaborativeTasks.Label.Days"),T("emxCollaborativeTasks.Label.Hours")],minimumValue:"0",conversionTable:[1,24]},f.assigneeFieldConfig(),f.attachmentFieldConfig,f.deliverablesFieldConfig,{name:"project",label:T("emxCollaborativeTasks.Label.CollaborativeSpace"),type:"text"},{readWrite:"true",name:"actualStartDate",label:T("emxCollaborativeTasks.Label.ActualDates"),type:"startStop",customView:l,startDateLabel:T("emxCollaborativeTasks.Label.StartDate"),canEditStartDate:function(e){var t=e.get("state");return"Create"!==t&&"Assign"!==t},endDateAttribute:"actualFinishDate",endDateLabel:T("emxCollaborativeTasks.Label.FinishDate"),canEditEndDate:function(e){return"Complete"===e.get("state")},validate:!0,group:e},{name:"originatorInfo",attributeToDisplay:"name",imageAttribute:"image",label:T("emxCollaborativeTasks.Label.TaskOriginator"),type:"person",customView:d,searchSource:["swym"],linkCallback:i.launchProperties},{name:"ownerInfo",attributeToDisplay:"name",imageAttribute:"image",label:T("emxCollaborativeTasks.Label.TaskOwner"),type:"person",customView:d,searchSource:["swym"],linkCallback:i.launchProperties},f.coOwnerFieldConfig(),{name:"originated",label:T("emxCollaborativeTasks.Label.TaskCreated"),type:"date",group:e},{name:"modified",label:T("emxCollaborativeTasks.Label.TaskModified"),type:"date",group:e},{name:"dependencies",customView:c}];return m.hasLoadedRolesData()&&m.hasSimulationRole()&&widget.getValue("referencedSimulations")&&s.splice(9,0,{readWrite:"true",name:"referencedSimulations",attributeToDisplay:"name",searchTitle:T("emxCollaborativeTasks.Label.ProcessesSearchTitle"),imageAttribute:"image",label:T("emxCollaborativeTasks.Label.Processes"),type:"object",customView:d,typeAheadCallback:n.typeAheadCallback,linkCallback:i.launchProperties,placeHolder:T("emxCollaborativeTasks.Label.ObjectPlaceHolder"),dropTypes:t,searchSourceTypes:t,searchSource:a.filterSearchSources(["3dspace"]),validateSameTenant:!0,getDropDownMenuItems:o.getDocumentTypeDropDownMenuItems}),s},projectConfig:function(){var e=T("emxCollaborativeTasks.GroupLabel.More");return[{readWrite:"true",name:"percentComplete",label:T("emxCollaborativeTasks.Label.Percent"),type:"range",step:5,percents:!0,insertIndex:4},{readWrite:"true",name:"estimatedStartDate",label:T("emxCollaborativeTasks.Label.EstimatedDates"),type:"startStop",startDateLabel:T("emxCollaborativeTasks.Label.StartDate"),endDateAttribute:"dueDate",endDateLabel:T("emxCollaborativeTasks.Label.FinishDate"),insertIndex:5},{readWrite:"true",name:"taskRequirement",insertIndex:11,label:T("emxCollaborativeTasks.Label.TaskRequirement"),type:"select"},{name:"actualDuration",label:T("emxCollaborativeTasks.Label.ActualDuration"),type:"uom",uomValues:[T("emxCollaborativeTasks.Label.Days"),T("emxCollaborativeTasks.Label.Hours")],conversionTable:[1,24],group:e,insertIndex:12},{readWrite:"true",name:"needsReview",label:T("emxProgramCentral.Task.NeedsReview"),type:"checkbox",insertIndex:18,group:e},{readWrite:"true",name:"deliverablesInheritance",label:T("emxProgramCentral.common.DeliverablesInheritance"),type:"checkbox",insertIndex:20,group:e}]}},v=function(e,t,s){var i,a;return"assignees"===e?i=T("emxCollaborativeTasks.Error.FailedToDisconnectUser"):"references"===e?i=T("emxCollaborativeTasks.Error.FailedToDisconnectReference"):"scopes"===e?i=T("emxCollaborativeTasks.Error.FailedToDisconnectScope"):e===u.COOWNERATTR&&(i=T("emxCollaborativeTasks.Error.FailedToRemoveCoOwner")),a=k(t),i=s&&s.response&&400===s.response.statusCode&&s.response.error?s.response.error:a?i.replace("%NAME%",a):s&&s.response&&s.response.error},b=function(t,i,a,o){var n,l=k(i);return n=a&&a.response&&400===a.response.statusCode&&a.response.error?a.response.error:l?s.getAttachmentErrorMessage(t,l):a&&a.response&&a.response.error,"assignees"===t&&o&&e.is(o.isRouteTask,"function")&&o.isRouteTask()&&"TRUE"===o.get("routeOwnerTask")&&o.get("routeOwnerUGTitle")&&a&&a.response&&a.response.error&&(n+="<br>"+a.response.error),n},k=function(s){let i;if("Person"===s.type){let t=s._mvcModel.get("firstname"),a=s._mvcModel.get("lastname");i=e.is(t,"string")&&e.is(a,"string")?t+" "+a:""}else i=t.getFieldValue(s,"title")||t.getFieldValue(s,"name");return i},S=function(e){var t=T("emxCollaborativeTasks.Error.FailedToModify");return e&&e.response&&400===e.response.statusCode&&e.response.error&&(t+="<br>"+T(p.sanitizeMessage(e.response.error))),t},D=function(e,t,s,i,a){if(t===u.COOWNERATTR&&a&&a.response&&a.response.internalError){a.response.internalError.contains("#1500028")&&("CONNECT"===s?e=T("emxCollaborativeTasks.Error.FailedToAddCoOwnerAccessIssue"):"DISCONNECT"===s&&(e=T("emxCollaborativeTasks.Error.FailedToRemoveCoOwnerAccessIssue")));var o=k(i);e=e.replace("%NAME%",o)}return e},_=function(){return m.enableUserGroup()?m.getServiceUrl("3DSwym",!0)?["swym","usersgroup"]:["3dspace"]:m.getServiceUrl("3DSwym",!0)?["swym"]:["3dspace"]},w=function(e){var t="swym"===e.toString()?{swym:[u.PERSON_TYPE]}:{"3dspace":["Person"]};return m.enableUserGroup()&&(t="swym,usersgroup"===e.toString()?{swym:[u.PERSON_TYPE],usersgroup:[u.USER_GROUP_TYPE]}:{"3dspace":["Person"]}),t},A=function(e){var t;return"swym"===e.toString()||(t={"3dspace":["Security Context"]}),t};return f.options={onFailure:function(e,t,s){var i;if(s.clonedInfo)for(var a=Object.keys(s.clonedInfo),o=a.length,n=0;n<o;n++){var l=a[n],c=s.clonedInfo[l].item,d=s.clonedInfo[l].source,u=s.clonedInfo[l].source._relationship,h=c.updateAction;(i=r.getErrorMessageForInvalidCredentials(s.response))||("DISCONNECT"===h?i=v(u,d,s):"CONNECT"===h?i=b(u,d,s,e):"MODIFY"===h&&(i=S(s))),i&&(i=D(i,u,h,d,s),p.displayError(i))}else"nothing to save"!==s.response.error&&p.displayError(T("E6WCommonApps.Error.SaveFailed"))}},f.assigneeFieldConfig=function(){return{readWrite:"true",name:"assignees",attributeToDisplay:"name",imageAttribute:"image",label:T("emxCollaborativeTasks.Label.Assignees"),searchTitle:T("E6WCommonApps.Label.assigneeSearchTitle"),typeAheadCallback:n.typeAheadCallback,dropTypes:h.PERSON_DROP_TYPES,searchSourceTypes:w(_()),type:"person",searchSource:a.filterSearchSources(_()),customView:d,linkCallback:i.launchProperties,placeHolder:T("emxCollaborativeTasks.Label.ObjectPlaceHolder"),validateSameTenant:!0,excludeSearchTypes:A(_()),excludePendingUser:!0,addMembers:!0,customButtons:[p.assignToSelfButtonConfig()]}},f.coOwnerFieldConfig=function(){return{name:u.COOWNERATTR,attributeToDisplay:"name",imageAttribute:"image",label:T("emxCollaborativeTasks.Label.TaskCoOwners"),searchTitle:T("emxCollaborativeTasks.Label.coOwnerSearchTitle"),typeAheadCallback:n.typeAheadCallback,dropTypes:h.PERSON_DROP_TYPES,searchSourceTypes:w(_()),type:"person",searchSource:a.filterSearchSources(_()),customView:d,linkCallback:i.launchProperties,placeHolder:T("emxCollaborativeTasks.Label.ObjectPlaceHolder"),validateSameTenant:!0,excludeSearchTypes:A(_()),excludePendingUser:!0,addMembers:!0}},Object.defineProperty(f,"attachmentFieldConfig",{get:function(){return{readWrite:"true",name:"references",attributeToDisplay:"name",imageAttribute:"image",allowFileManagement:!0,label:T("emxCollaborativeTasks.Label.References"),searchTitle:T("emxCollaborativeTasks.Label.referencesSearchTitle"),typeAheadCallback:n.typeAheadCallback,type:"object",customView:d,linkCallback:i.launchProperties,placeHolder:T("emxCollaborativeTasks.Label.ObjectPlaceHolder"),searchSource:a.filterSearchSources(["3dspace","drive"]),excludeSearchTypes:{"3dspace":["Person","Security Context","Business Role"]},validateSameTenant:!0,limit:100,getDropDownMenuItems:o.getDocumentTypeDropDownMenuItems}}}),Object.defineProperty(f,"deliverablesFieldConfig",{get:function(){return{readWrite:"true",name:"deliverables",attributeToDisplay:"name",allowFileManagement:!0,searchTitle:T("emxCollaborativeTasks.Label.deliverablesSearchTitle"),imageAttribute:"image",label:T("emxCollaborativeTasks.Label.Deliverables"),type:"object",customView:d,typeAheadCallback:n.typeAheadCallback,linkCallback:i.launchProperties,placeHolder:T("emxCollaborativeTasks.Label.ObjectPlaceHolder"),searchSource:a.filterSearchSources(["3dspace","drive"]),validateSameTenant:!0,limit:100,getDropDownMenuItems:o.getDocumentTypeDropDownMenuItems}}}),f}),define("DS/CollaborativeTasks/Models/TskCloneModel",["UWA/Core","DS/Foundation/WidgetUwaUtils","DS/Foundation2/FoundationV2Data","DS/CollaborativeTasks/Models/TaskModel","DS/E6WCommonUI/Models/CloneModel","DS/E6WCommonUI/UIHelper","DS/E6WCommonUI/PlatformManager","DS/E6WCommonUI/Models/DropValidator","i18n!DS/E6WCommonApps/assets/nls/CollaborativeTasksNLS"],function(e,t,s,i,a,o,n,l,r){"use strict";var c=s.getWidgetConstant;s.getWidgetConstant=function(e){return c.apply(this,arguments)||r.get(e)};var d=function(){return s.getWidgetConstant.apply(this,arguments)},u={d:0,h:1},h=["d","h"];return a.extend({_uwaClassName:"TskCloneModel",i18n:d,_attributesGet:function(e,t){return e?e[t]:this.get(t)},validate:function(e){var t=!0,i={fields:[],messages:{}},a=this._attributesGet(e,"title"),o=!this.model.isRouteTask()&&s.containsBadChars(a);return a&&a.length&&!o||(i.fields.push("title"),o&&(i.messages.title=d("emxCollaborativeTasks.Validate.TitleError")),t=!1),(t=t&&this._validateActualDates(e,i))?void 0:i},_validateActualDates:function(e,t){var s=!0,i=this._attributesGet(e,"actualStartDate"),a=this._attributesGet(e,"actualFinishDate"),o=this._attributesGet(e,"state");"Create"===o||"Assign"===o||i&&void 0!==i&&""!==i||this._hasModifiedProperty("actualStartDate")&&(t.fields.push("actualStartDate"),s=!1),"Complete"!==o||a&&void 0!==a&&""!==a||(t.fields.push("actualFinishDate"),s=!1);var n=new Date;return i=i&&new Date(i).setHours(0,0,0,0),a=a&&new Date(a).setHours(0,0,0,0),i&&i>n&&(t.fields.push("actualStartDate"),s=!1),a&&a>n&&(t.fields.push("actualFinishDate"),s=!1),i&&a&&i>a&&(t.fields.push("actualStartDate"),s=!1),s},get:function(e){var t=this._parent.apply(this,arguments);if("needsReview"===e||"deliverablesInheritance"===e)return"Yes"===t?"TRUE":"FALSE";switch(e){case"estimatedDurationInputUnit":t=u[t];break;case"modified":case"originated":t=o.getIntlDateTimeFormat(t);break;case"actualStartDate":case"actualFinishDate":t=o.getIntlDateFormat(t)}return t},dataForRendering:function(){var s,i,a=this._parent();this.model&&e.is(this.model.isRouteTask,"function")&&this.model.isRouteTask()||(i=(s=this.get("scopes"))&&s.length?[s[0].dataForRendering()]:[],a.scopes=i),a.route&&a.route.forEach(function(e){e.image={imageValue:window.enoviaServer.computeUrl("/common/images/iconSmallRoute.gif")}});var o=this.get("estimatedDurationInputUnit");void 0!==o&&(a.estimatedDurationInputUnit=o);var n=this.get("needsReview");void 0!==n&&(a.needsReview=n);var l=this.get("deliverablesInheritance");return void 0!==l&&(a.deliverablesInheritance=l),void 0!==a.modified&&(a.modified=this.get("modified")),void 0!==a.originated&&(a.originated=this.get("originated")),void 0!==a.actualStartDate&&(a.actualStartDate=this.get("actualStartDate")),void 0!==a.actualFinishDate&&(a.actualFinishDate=this.get("actualFinishDate")),void 0!==a.project&&(a.project=t.getContextDisplayValueForContext(this.get("project"))),a},isProjectTask:function(){return this.model.isProjectTask()},set:function(e,t,s){var i=t;if(t.actualValue&&void 0!==t.actualValue&&""!==t.actualValue){var a=this.model.getFieldDef(e);if(a&&a.format&&("UTC"===a.format||"date"===a.format)){var o=new Date(t.actualValue),n=o.getDate(),l=o.getMonth(),r=o.getFullYear();o.setUTCHours(12,0,0,0),o.setMonth(l,n),o.setFullYear(r),i=o}}return void 0!==i.actualValue&&(i=i.actualValue),"title"===e&&(i=i.trim()),"needsReview"!==e&&"deliverablesInheritance"!==e||(i="TRUE"===i?"Yes":"No"),"estimatedDurationInputUnit"===e&&(i=h[i]),this._parent(e,i,s)},add:function(e,t,s){var i,a=s&&s.dropObj;return a&&(i=l.validateTenant(a)),i?(o.displayError(i),[]):this._parent.apply(this,arguments)},addIndividualObject:function(e,t){return"scopes"!==e&&"contents"!==e||(this._addForScopes.apply(this,arguments),t instanceof FileList||t instanceof File)?this._parent.apply(this,arguments):{}},_addForScopes:function(t,s,i,a){var o=e.clone(a||{},!1),n=function(e){return this._addCompletedModelToScopeOrContents(e,t,o)},l=this.model.collection.getRelatedObject(t,s);return l.get("type")?n.call(this,l):(this.listenToOnce(l,"onChange:type",n),{ret:l})},_addCompletedModelToScopeOrContents:function(t,s,i){var n={};if("scopes"===s||"contents"===s){var l=t.get("type");if(-1!==("scopes"===s?this.scopesTypes:this.contentsTypes).indexOf(l)){var r=this.get(s),c=e.clone(i||{},!1);c.silent=!0,r&&r.length&&r[0]===t||(i&&i.config.singleObjectOnly&&this.remove(s,0,c),(n=a.prototype.addIndividualObject.call(this,s,t.id,t,c)).changedModificationPending&&this.dispatchEvent("onChange:modificationsPending"),n.changed&&((c=e.clone(i||{},!1)).operation="add",this._fireRelationshipChangeEvents(s,c)))}else{var u=d("emxCollaborativeTasks.Error.InvalidScopesType");u=u.replace("%TYPE%",l),o.displayError(u)}}return n},save:function(){var e=this.localAttributes;this._parent.apply(this,arguments),this.model.validationError&&(this.localAttributes=e,this.modificationsPending=!0,this.dispatchEvent("onChange:modificationsPending",[this]))},assignToSelf:function(t){var s=e.clone(t||{},!1),a="iam:"+window.enoviaServer.user,o=[{id:a,serviceId:"3DSwym"}];if(s.detailedObjects=[o[0]],t.config.singleObjectOnly&&o&&o.length>0){var n=this.get(i.ASSIGNEESATTR);if(n&&e.is(n,"array")&&n.length>0&&e.is(this.model.remove,"function")){var l=s.singleObjectRemove;s.singleObjectRemove=!0,this.remove(i.ASSIGNEESATTR,0,s),s.singleObjectRemove=l}}this.add(i.ASSIGNEESATTR,a,s),this.model.isRouteTask()&&this.model.isAssignedToUserGroup()&&this.remove("assignees",1)},onFileUploadFailure:function(e){if("deliverables"===e.fieldName){var t=i.getAttachmentErrorMessage(e.fieldName,e.fileName);return this._parent(e,t)}return this._parent.apply(this,arguments)}})}),define("DS/CollaborativeTasks/Views/CardView",["UWA/Core","DS/UIKIT/Tooltip","DS/UIKIT/Input/Button","DS/Handlebars/Handlebars4","DS/E6WCommonUI/Views/E6WHandlebarsHelpers","DS/E6WCommonUI/Views/FoundationBaseView","DS/CollaborativeTasks/Models/TaskModel","DS/E6WCommonUI/UIHelper","DS/E6WCommonUI/DragUtil","DS/CollaborativeTasks/Views/TaskMenuMixin","DS/CollaborativeTasks/Models/TskCloneModel","DS/E6WCommonApps/Models/RDFTaskCloneModel","DS/Foundation2/FoundationV2Data","DS/E6WCommonApps/Models/E6WCommonAppsConstants","DS/RDFFoundation/RDFUtils","DS/CollaborativeTasks/Views/ERTasksDetailsPanelConfig","DS/E6WCommonApps/Views/RDFTaskDetailsPanelConfig","DS/E6WCommonUI/Models/DropValidator","DS/E6WCommonUI/CompassUtil","DS/E6WCommonUI/Views/E6WHandlebarsHelpers","DS/E6WCommonApps/TaggerChipColorMixin","DS/E6WCommonUI/PlatformManager","i18n!DS/E6WCommonApps/assets/nls/E6WCommonAppsNLS","i18n!DS/E6WCommonUI/assets/nls/E6WCommonUINLS","i18n!DS/E6WCommonApps/assets/nls/CollaborativeTasksNLS","text!DS/CollaborativeTasks/assets/templates/card.html.handlebars"],function(e,t,s,i,a,o,n,l,r,c,d,u,h,p,m,g,C,T,f,v,b,k,S,D,_,w){"use strict";l.fixDisplayMessageMethod();var A=function(){return h.getWidgetConstant.apply(this,arguments)},y=i.compile(w),E=o.extend({_uwaClassName:"CardView",className:"card real-card drop-target",name:"CollaborativeTasks.CardView",domEvents:{"click .card-content":"onClickTaskCard","dragenter ":"handleDragEnter","dragover ":"handleDragOver","dragleave ":"handleDragLeave","drop ":"handleDrop","dragend .drop-target":"handleDragEnd","dragstart ":"handleDragStart"},droppedData:null,onClickTaskCard:function(){this.dispatchEvent("onTaskCardClicked",this)},onSelect:function(){this.container.toggleClassName(this._getActiveClassName(),!0),f.publishOnPlatformAPI(window.widget.getValue("appId")+".select",this.model)},onUnselect:function(){this.container.toggleClassName(this._getActiveClassName(),!1),f.publishOnPlatformAPI(window.widget.getValue("appId")+".unselect",this.model)},_getActiveClassName:function(){return l.isTouchDevice()?"touch-active":"active"},id:function(){return"card"+(this.model.extid?this.model.extid:this.model.cid)},destroy:function(){this.container.innerHTML="",this._tooltip&&this._tooltip.destroy(),this.cardMenu&&this.cardMenu.dropdown&&this.cardMenu.dropdown.destroy(),this.cardMenu&&this.cardMenu.destroy(),delete this.cardMenu,this._parent()},_changeDirty:function(){this.container.toggleClassName("pending-modification",this.model.nbInFlightRequests>0),this.showSubscriptionIcon()},setup:function(e){var t=this;return this._parent.apply(this,arguments),!l.isTouchDevice()&&this.container.addEventListener("contextmenu",function(e){return e.preventDefault(),t.displayMenu(e),!1},!1),this.listenToModelEvent(),e},updateButtons:function(){this._emptyMenuButtons(),this._drawMenuButtons()},listenToModelEvent:function(){var e=this,t={onChange:function(t,s){s&&s.relationshipChanged||e.render(),"assignees"===s.relationshipChanged||"contents"===s.relationshipChanged?e.render():!s||"references"!==s.relationshipChanged&&"deliverables"!==s.relationshipChanged&&"referencedSimulations"!==s.relationshipChanged||e.showAttachmentIcon()},"onChange:nbInFlightRequests":this._changeDirty};t["onChange:"+p.USER_DEFINED_START_DATE_ATTR]=this.showFixedIcon,t["onChange:"+p.USER_DEFINED_END_DATE_ATTR]=this.showFixedIcon,t["onChange:"+p.COMPLETE_PERCENT_ATTR]=this.showProgress,t["onChange:hasProject"]=this.updateButtons,t["onChange:DPMProject"]=function(){this.updateButtons();var e=this.model.get("DPMProject");e&&e[0]&&this.render()},t["onChange:route"]=this.render,t["onChange: "+p.EXPLICIT_TAGS_DATA]=this.render,t.onModifyAccessChanged=this.updateButtons,t.onDeleteAccessChanged=this.updateButtons,this.addTaggerChipColorChangeEvents(),this.listenTo(this.model,t)},template:function(){var e,t=this.model.dataForRendering({attributes:["id","fonticon","title","cardTitle","actualName","dueDate","assignees","name","firstname","lastname","state","stateForDisplay","priority","percentComplete"]});switch(t.cardTitle=t.cardTitle||t.title,this._addDataForLargeCards(t),t&&t.priority){case"Low":e=p.PRIORITY_LOW_ICON;break;case"Medium":e=p.PRIORITY_MEDIUM_ICON;break;case"High":e=p.PRIORITY_HIGH_ICON;break;case"Urgent":e=p.PRIORITY_URGENT_ICON}t.priority=e,t.notRDF=!this.model.isRDFTask(),t.subtitle=this.model.get(p.DESCRIPTION_ATTR);var s=v.i18n;v.i18n=A;var i=y(t);return v.i18n=s,i},_addDataForLargeCards:function(e){e.parent=this.model.getParentAsLabel(this.model),e.explicitTagsData=this.model.get(p.EXPLICIT_TAGS_DATA)},render:function(){if(this.container){this.container.innerHTML=this.template(),this.container.setAttribute("draggable","true"),this._drawMenuButtons(),this.setDefaultImages(),this.showAttachmentIcon(),this._changeDirty(),this.showFixedIcon(),this.showAtRiskOrLateness(),this.showGreyPriorityIcon(),this.showProgress(),this.colorTaggerChip();var e=this.model.get("assignees");e&&this.container.toggleClassName("more-assignees",Boolean(e.length>3))}return this},showAtRiskOrLateness:function(){var e=this.model.isLate(),t=this.model.isAtRisk(),s=this.model.isComplete(),i=this.model.isReadyToStart(),a=this.container.getElement(".card-progress span");this.container.removeClassName("at-risk"),this.container.removeClassName("late"),this.container.removeClassName("ready-to-start"),this.container.removeClassName("complete"),this.container.removeClassName("on-time"),e?(this.container.addClassName("late"),a&&a.setAttribute("title",A("emxCollaborativeTasks.Label.Late"))):t?(this.container.addClassName("at-risk"),i&&this.container.addClassName("ready-to-start")):i?(this.container.addClassName("ready-to-start"),this.container.addClassName("on-time")):s?this.container.addClassName("complete"):this.container.addClassName("on-time"),this.container.hasClassName("at-risk")&&a&&a.setAttribute("title",A("emxCollaborativeTasks.Label.Risk"))},showFixedIcon:function(){this.container.getElement(".card-properties")&&this.container.getElement(".card-properties").toggleClassName("is-fixed",Boolean(this.model.fixed))},showAttachmentIcon:function(){var e=this.model.get("references")||[],t=this.model.get("deliverables")||[],s=[];e.toArray&&(e=e.toArray()),t.toArray&&(t=t.toArray());var i=e.concat(t);k.hasLoadedRolesData()&&k.hasSimulationRole()&&widget.getValue("referencedSimulations")&&((s=this.model.get("referencedSimulations")||[]).toArray&&(s=s.toArray()),i=i.concat(s)),this.container.getElement(".card-properties")&&this.container.getElement(".card-properties").toggleClassName("has-files",Boolean(i.length))},showSubscriptionIcon:function(){var e=this.model.get("subscribed");this.container.getElement(".card-properties")&&this.container.getElement(".card-properties").toggleClassName("subscribed",this.model.subscriptionsEnabled()&&"TRUE"===e&&!this.model.isProjectTask()&&!this.model.isRouteTask())},showGreyPriorityIcon:function(){this.container.getElement(".card-properties")&&this.container.getElement(".card-properties").toggleClassName("is-complete",Boolean(this.model.isComplete()))},showProgress:function(){this.container.toggleClassName("has-progress",this.model.isRDFTask()||this.model.isProjectTask())},_emptyMenuButtons:function(){var e=this.getElement(".card-menu");e&&(this.cardMenu.dropdown&&this.cardMenu.dropdown.destroy(),e.empty())},displayMenu:function(e){var t=this;(this.updateButtons(),l.showAndUpdateContextualDropdownMenuPosition(t.cardMenu.dropdown,e),this.model.hasFetchedAccessData())||this.model.getAccessBatch().sendBatch({onComplete:function(){t.displayMenu(e)}})},_drawMenuButtons:function(){var e=this.getElement(".card-menu"),i=this.createMenuButtons();if(e){this.cardMenu&&this.cardMenu.destroy(),this.cardMenu=new s(i).inject(e);var a=this;this.cardMenu.addEvent("onClick",function(e){return a.displayMenu(e),!1}),this.cardMenu.elements.container.setStyle("min-width",""),this._tooltip=new t({target:this.cardMenu.elements.container,body:A("emxCollaborativeTasks.Label.TaskMenu")}),this.listenTo(this.cardMenu.dropdown,"onShow",function(){this._parentView&&this._parentView.setDropdown(this.cardMenu.dropdown),document.addEventListener("contextmenu",this.cardMenu.dropdown.events.document.click,!0)}),this.listenTo(this.cardMenu.dropdown,"onHide",function(){document.removeEventListener("contextmenu",this.cardMenu.dropdown.events.document.click,!0)})}},handleDragStart:function(e){r.setDragModel(this.model),r.setDragTransferData(e,this.model.getTransferObject())},canDragOverCard:function(){var e=!1;return!r.getDragModel()&&(e=this.model.isRDFTask()||"complete"!==this.model.get("state").toLowerCase()),e},handleDragOver:function(e){return e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),!!this.canDragOverCard()&&(e.dataTransfer.dropEffect="copy",this.container.addClassName(p.DROP_CLASS_NAME),!1)},handleDragEnter:function(){if(!this.canDragOverCard())return!1;o.getViewFromContainer(this.container.getClosest(".column"))._parentView.clearAllDropZoneMasks(),this.container.addClassName(p.DROP_CLASS_NAME)},handleDragLeave:function(e){e.target.getParent().toggleClassName(p.DROP_CLASS_NAME,!1)},handleDrop:function(e){if(e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),this.container.removeClassName(p.DROP_CLASS_NAME),!this.canDragOverCard())return!1;var t=e.dataTransfer.files;if(t&&t.length){if(this.model.uploadFiles){var s=this.model.isRDFTask()?u:d,i=new s(this.model),a=this,o=this.model.get("state");o=o?o.toLowerCase():o;var r="references";"active"!==o&&"review"!==o&&"complete"!==o||(r="deliverables");var c={onFailure:function(e,t,s){var o={fieldName:a.model.getMappedAttribute(r),fileName:s&&s.file&&s.file.name};i.onFileUploadFailure(o,e)},onComplete:function(e){var i=new s(a.model),o={fieldName:a.model.getMappedAttribute(r),fileName:e.title||e.dataelements.title},c=o.fileName,d=A("emxCollaborativeTasks.Label.SuccessfulSave");1===t.length&&(e.relateddata&&e.relateddata.files&&e.relateddata.files.length&&(c=e.relateddata.files[0].dataelements.title),d=n.getAttachmentSuccessMessage(r,c)),o.onComplete=function(){l.displaySuccess(d)},i.onFileUploadComplete(o,e)}};if(this.model.hasFetchedAccessData&&this.model.hasFetchedAccessData()&&this.model.canModify&&!this.model.canModify())return l.displayError(D.get("E6WCommonUI.Error.noAccessOnObject")),!1;this.model.uploadFiles(t,r,c)}else l.displayError("emxCollaborativeTasks.Error.NoFileDrop");return!1}var h=l.getDataTransferJSON(e.dataTransfer);return h&&this.processDropData(h,e.dataTransfer),!1},handleDragEnd:function(){this.container.removeClassName(p.DROP_CLASS_NAME)},isValidObjectType:function(e){return"Person"===e.objectType||"pno:Person"===e.objectType||"Group Proxy"===e.objectType||"Group"===e.objectType||"foaf:Group"===e.objectType||e.objectType===p.LOGICAL_USER_TYPE},processDropData:function(e){var t=e.data.items,s=this.model.get("state");s=s?s.toLowerCase():s;for(let e=0;e<t.length;e++){const s=t[e];if(this.validateDroppedObject(s))return}let i="references";for(let e=0;e<t.length;e++){const r=t[e];var a=this.model instanceof n&&!this.model.isRouteTask(),o=r.objectType===p.SIMULATION_TYPE||r.objectType===p.SIMULATION_TEMPLATE_TYPE;this.isValidObjectType(r)?i="assignees":o&&a&&k.hasSimulationRole()&&widget.getValue("referencedSimulations")?i="referencedSimulations":"active"!==s&&"review"!==s&&"complete"!==s||(i="deliverables");const c={save:e===t.length-1,onComplete:function(){if(1===t.length){var e=n.getAttachmentSuccessMessage(i,r.displayName);e&&l.displaySuccess(e)}else _.get("emxCollaborativeTasks.Success.ManyObjectsAdded").replace({OBJECT_COUNT:t.length})},onFailure:function(){if(1===t.length){var e=n.getAttachmentErrorMessage(i,r.displayName);e&&l.displayError(e)}else l.displayMessage(S.get("E6WCommonApps.Error.SaveFailed"))}};this.model.isRDFTask()?this.addAttributeToRDFTask(r,i,c):this.addAttributeToNonRDFTask(r,i,c)}},addAttributeToRDFTask:function(e,t,s){if(this._tempCloneModel=this._tempCloneModel||new u(this.model),this._tempCloneModel.add(t,[e.objectId],{dropObj:e})&&s&&s.save){this._tempCloneModel.save({onComplete:function(){var s=n.getAttachmentSuccessMessage(t,e.displayName);s&&l.displaySuccess(s)},onFailure:function(){var s=n.getAttachmentErrorMessage(t,e.displayName);s&&l.displayError(s)},relationshipName:t,objectName:e.displayName}),delete this._tempCloneModel}},addAttributeToNonRDFTask:function(e,t,s){var i,a,o=e.objectType,r=this._getIdForDroppedItem(e);"pno:Person"===o&&(i="name",a=[{type:"Person",displayName:e.displayName}]);var c=this.model.addObjects([r],t,i,{otherObjectAttributes:a,attributes:{service:e.serviceId,tenant:e.envId},onFailure:function(e){l.displayError(e)}});c&&c.length&&s.save&&this.model.save(null,{onComplete:function(){var s=n.getAttachmentSuccessMessage(t,e.displayName);s&&l.displaySuccess(s)},onFailure:function(e,t,s){l.displayError(n.getAttachmentErrorMessage(s.relationshipName,s.objectName))},relationshipName:t,objectName:e.displayName,at:0})},_getFieldConfigForValidatingDrop:function(e){var t;return t=this.model instanceof n?g:C,this.isValidObjectType(e)?t.assigneeFieldConfig(this.model):t.attachmentFieldConfig},validateDroppedObject:function(e){var t,s=this._getFieldConfigForValidatingDrop(e);return(t=s.readWrite?T.validateDroppedObject(e,s):D.replace(D.get("E6WCommonUI.Alert.FailedToAttachObjectBadType"),{TYPE:e.displayType||l.translateType(e.objectType)}))&&l.displayError(t),t},_getIdForDroppedItem:function(e){var t=e.objectId;return this.model.isRDFTask()||"pno:Person"!==e.objectType||(t=m.splitUri(e.objectId)[1]),t},getColumn:function(){return this._parentView}});return E.implement(c,b),E}),define("DS/CollaborativeTasks/Models/RouteTaskModel",["UWA/Core","DS/Foundation2/FoundationV2Data","DS/CollaborativeTasks/Models/TaskModel","DS/E6WCommonUI/UIHelper","i18n!DS/E6WCommonUI/assets/nls/E6WCommonUINLS","DS/E6WCommonApps/Models/E6WCommonAppsConstants"],function(e,t,s,i,a,o){"use strict";var n=function(e){var s=t.getWidgetConstant.apply(this,arguments);return s===e&&(s=a.get(e)),s};return s.extend({_uwaClassName:"RouteTaskModel",ROUTETASKDUEDATE:"routeTaskDueDate",setup:function(){this.listenTo(this,"onChange:"+this.ROUTETASKDUEDATE,function(e,t,s){s.silent||e.dispatchEvent("onChange:"+this.DUEDATECATEGORY,arguments)}),this._parent.apply(this,arguments)},dataForRendering:function(){var e=this._parent.apply(this,arguments);return this.isComplete()?e.date=e.routeTaskActualFinishDate:e.date=e.routeTaskDueDate,e.routeOwnerTask&&(e.routeOwnerTask=this.isTaskReassignmentRequired()),1===e.contents.length?e.cardTitle=e.title+" | "+e.contents[0].title+" ("+(e.contents[0].actualName||e.contents[0].name)+")":e.contents.length>1&&(e.cardTitle=e.title+" | "+n("E6WCommonUI.Label.ShowContentInfo").replace("{Number}",e.contents.length)),e.context="",e},toJSON:function(){return this._parent.apply(this,arguments)},isTaskReassignmentRequired:function(){return"TRUE"===this.get("routeOwnerTask")},isAssignedToUserGroup:function(){var e=this.get("assignees");return e&&e.length&&("Group"===e[0].get("type")||"Group Proxy"===e[0].get("type"))},get:function(e){if("canEdit"===e&&this.isAssignedToUserGroup())return!1;if("dueDate"===e)return new Date(this.get(this.ROUTETASKDUEDATE));if("routeOwner"===e){var t=this._parent.apply(this,arguments);return t||(this.fetch({server:!0,urlParam:"$include=none&$fields=none,routeOwner,routeOwnerTask,routeOwnerUGChoice,routeOwnerUGName,routeOwnerUGTitle"}),this.nbInFlightRequests--),t}return this._parent.apply(this,arguments)},set:function(){var t=i.setHelper.apply(this,arguments),s=e.clone(t.attrs||{},!1),a=t.options;if(s){if(s.hasOwnProperty(this.DUEDATECATEGORY)){var o=s[this.DUEDATECATEGORY];delete s[this.DUEDATECATEGORY],s[this.ROUTETASKDUEDATE]=this.dueDateCategory2DueDate(o)}return this._parent(s,a)}return this._parent.apply(this,arguments)},subscriptionsEnabled:function(){return!1},isRouteTask:function(){return!0},getContext:function(){return""},canAssignToSelf:function(){return!this.isComplete()&&(this.isAssignedToUserGroup()||this.get("canEdit"))&&!this.isAssignedToCurrentUser()},_validateApprovalComments:function(e,t,s){if(s.currentState!==s.newState&&e.hasOwnProperty("routeTaskAction")){var i=e.routeTaskApprovalComments&&e.routeTaskApprovalComments.trim();s.enforceAssigneeApprovalComments&&!i&&t.fields.push("routeTaskApprovalComments")}},_validateApprovalAction:function(e,t,s){s.currentState!==s.newState&&e.hasOwnProperty("routeTaskApprovalAction")&&"Approve"===e.routeTaskAction&&"None"===e.routeTaskApprovalAction&&t.fields.push("routeTaskApprovalAction")},_validateEnforceOwnerReviewComments:function(e,t,s){"Yes"===s.needsReview&&s.enforceOwnerReviewComments&&e.hasOwnProperty("routeTaskReviewerComments")&&("Complete"!==s.newState||e.routeTaskReviewerComments.trim()||t.fields.push("routeTaskReviewerComments"))},_validateSignatureRequired:function(e,t,s){s.currentState!==s.newState&&e.hasOwnProperty("routeTaskApprovalAction")&&"Approve"===e.routeTaskAction&&"None"!==e.routeTaskApprovalAction&&(0!==t.fields.length||"True"!==e.routeTaskRequiresESign||this._signature||(t.fields.push("signature_required"),t.fields.push(e.routeTaskApprovalAction)))},validate:function(e){var t=this._parent.apply(this,arguments)||{fields:[]},s=this._getValidationOptions(e);return this._validateApprovalComments(e,t,s),this._validateApprovalAction(e,t,s),this._validateEnforceOwnerReviewComments(e,t,s),this._validateSignatureRequired(e,t,s),t.fields.length?t:void 0},getParentIdForRelationship:function(e){return"contents"===e?this.get("route")[0].id:this.id},assignToSelf:function(){var e=this;this.addAssigneesByName([window.enoviaServer.user]),this.isAssignedToUserGroup()&&this.removeObject("assignees",this.get("assignees")[0]),this.save(null,{patch:!0,onComplete:function(){e.dispatchEvent("onChange:"+e.ASSIGNEESATTR);var t=n("emxCollaborativeTasks.Label.SuccessfullyAssignedToSelf");i.displaySuccess(t),e.dispatchEvent("onModifyAccessChanged")},onFailure:function(){var e=n("emxCollaborativeTasks.Error.FailAssignToSelf");i.displayError(e)}})},save:function(e,t){var s=arguments;arguments.length>0?this._saveArgs=arguments:s=this._saveArgs;var i=this;return t&&t.onComplete&&this._shouldDoAutoRefresh(e)&&(t.onComplete=function(){i.collection.fetch({server:!0,partialRefresh:!0,noTag:!0})}),this._parent.apply(this,s)},_shouldDoAutoRefresh:function(e){var t=this.get("assignees")[0].get("dsaccess:accountName"),s=e&&e.state;return!i.isLoggedInUser(t)||s&&("Review"===s||"Complete"===s)},getParentAsLabel:function(){var e,t=this.get("route");if(t&&t[0]){var s=t[0].get("name");e={key:n("emxCollaborativeTasks.Label.Route"),value:s}}return e}})}),define("DS/CollaborativeTasks/Collections/TasksCollection",["UWA/Core","UWA/Class/Promise","DS/Foundation/CsvParser","DS/Foundation/WidgetUwaUtils","DS/Foundation2/FoundationV2Data","DS/Foundation2/Collections/FoundationBaseCollection","DS/RDFFoundation/SecurityContextUtils","DS/CollaborativeTasks/Models/TaskModel","DS/CollaborativeTasks/Models/RouteTaskModel","DS/E6WCommonUI/UIHelper","DS/E6WCommonApps/XTaskScope","DS/E6WCommonApps/Models/E6WCommonAppsConstants","DS/E6WCommonApps/Collections/TasksSplitCollection","DS/RDFFoundation/Collections/CollectionTaggerHelper","i18n!DS/E6WCommonApps/assets/nls/E6WCommonAppsNLS","i18n!DS/E6WCommonApps/assets/nls/CollaborativeTasksNLS"],function(e,t,s,i,a,o,n,l,r,c,d,u,h,p,m,g){"use strict";var C=function(e){var t=m.get(e);return t===e&&(t=g.get(e)),t===e&&(t=a.getWidgetConstant.apply(this,arguments)),t},T=u.DUE_DATE_CATEGORY,f=u.PAST_DUE,v=u.NO_DATE,b=u.DUE_TODAY,k=u.DUE_TOMORROW,S=u.DUE_THIS_WEEK,D=u.DUE_FUTURE,_=function(e){return e&&e.actualValue||e},w=function(e){var t=l;return"Inbox Task"===e&&(t=r),t},A=o.extend({_uwaClassName:"TasksCollection",model:l,_prepareModel:function(e){return this.model=w(e.type),this._parent.apply(this,arguments)},setAttrToSplitBy:function(e,t){if(t&&this._attrToSplitBy!==e){var s=Object.prototype.hasOwnProperty;for(var i in this._TasksByAttr)s.call(this._TasksByAttr,i)&&this._cleanupSubCollectionForAttr(i)}this._attrToSplitBy=e},addNewTask:function(){var e=this.add.apply(this,arguments);if(window.widget){var t=d.getScopeId(),s=d.getScopeType();if(t&&!d.isScopeRDF()){var i=-1===this.projectTypes().split(",").indexOf(s)?"scopes":"DPMProject";"tempfix"!==t&&e.addObjects([t],i)}}return e},setup:function(t,s){var o=Array.prototype.slice.call(arguments,0);if(window.widget){var n=i.getContext().split(".");n&&n.length&&(this.collabSpace=n[n.length-1])}this.fetching=0,this._TasksByAttr={},this._attrToSplitBy="state",this.extid="allTasks";var l=e.clone(s,!1);l.serviceName="/resources/v1/modeler/tasks",l.initialLoadOptions="$include=none&$fields=none,title,modifyAccess,deleteAccess,state,dueDate,routeTaskDueDate,routeOwnerTask&$definition=true&$terse=true",l.completeOptions="$terse=true&$include=co-owners,predecessors,successors&$fields=deliverablesInheritance,revision",o[1]=l,this._translate=s.translate,this.addEvent("onSync",this._onSync),this.dictionaryLoaded=!1,this._allStates=[{actualValue:"Create",displayValue:C("emxCollaborativeTasks.Label.Preliminary")},{actualValue:"Assign",displayValue:C("emxCollaborativeTasks.Label.ToDo")},{actualValue:"Active",displayValue:C("emxCollaborativeTasks.Label.InWork")},{actualValue:"Review",displayValue:C("emxCollaborativeTasks.Label.InReview")},{actualValue:"Complete",displayValue:C("emxCollaborativeTasks.Label.Completed")}];for(var r=this._allStates.length,c=0;c<r;c++){var d=this._allStates[c];a.setWidgetConstant(d.actualValue,d.displayValue)}var u=this.data();for(u&&u.definitions?this._allDueDates=this._getDefRange(T):this._allDueDates=[{actualValue:f,displayValue:C("emxCollaborativeTasks.Label.Overdue")},{actualValue:v,displayValue:C("emxCollaborativeTasks.Label.NoDate")},{actualValue:b,displayValue:C("emxCollaborativeTasks.Label.Today")},{actualValue:k,displayValue:C("emxCollaborativeTasks.Label.Tomorrow")},{actualValue:S,displayValue:C("emxCollaborativeTasks.Label.ThisWeek")},{actualValue:D,displayValue:C("emxCollaborativeTasks.Label.Future")}],this._allStatesForDisplay=[{actualValue:"To Do",displayValue:C("emxCollaborativeTasks.Label.ToDo")},{actualValue:"In Progress",displayValue:C("emxCollaborativeTasks.Label.InProgress")},{actualValue:"Done",displayValue:C("emxCollaborativeTasks.Label.Done")}],r=this._allStatesForDisplay.length,c=0;c<r;c++)d=this._allStatesForDisplay[c],a.setWidgetConstant(d.actualValue,d.displayValue);this._parent.apply(this,o)},setSearch:function(e){this._search=e,this._cleanupSubCollections(),this.dispatchEvent("onChange:search")},resetSearch:function(){delete this._search,this._cleanupSubCollections(),this.dispatchEvent("onChange:search")},getSearch:function(){return this._search},dataForRendering:function(){return{collabSpace:this.collabSpace}},tasksWithAttrValue:function(e,t){var s=this,i=t||this._attrToSplitBy,a=_(e);return this.filter(function(e){var t=_(e.get("state")),o=_(e.get(i)),n=_(e.get("title")||e.get("text")),l=!s._search||c.match(s._search,n);return(i!==u.DUE_DATE_CATEGORY||"Complete"!==t)&&(o===a&&l)})},tasksWithAttrValueCollection:function(e,t){if(void 0!==e){var s=t||this._attrToSplitBy,i=_(e),a=this._TasksByAttr[s];if(!a||!a[i]){var o=this.tasksWithAttrValue(e,s),n={filterAttr:s,valueForFiltering:e,parentCollection:this},l=new A.TasksSplitCollection(o,n);l.extid="tasks-"+s+"-"+i,a||(this._TasksByAttr[s]=a={}),a[i]=l}return a[i]}},_getDefRange:function(e,t){var s,i=a.getAllFields(this.data())[e],o=[];if(i&&i.range)for(var n=i.range.item,l=n.length,r=0;r<l;r++){var c=n[r];s=t&&t.translateUsingE6WCommonAppsNLS?C("E6WCommonApps.Label."+c.display):C("emxCollaborativeTasks.Label."+c.display.replace(/ /g,"")),o.push({actualValue:c.value,displayValue:this._translate?s:c.display})}return o},allTaskRequirements:function(){if(!this._allTaskRequirements){var e=this.data();e&&e.definitions&&(this._allTaskRequirements=this._getDefRange("taskRequirement"))}return this._allTaskRequirements},allStates:function(){return this._allStates},allDueDates:function(){return this._allDueDates},allRouteTaskApprovalActions:function(e){return this._allRouteTaskApprovalActions||(this._allRouteTaskApprovalActions=this._getTranslatedAttributeValues("routeTaskApprovalAction",e)),this._allRouteTaskApprovalActions},allRouteTaskActions:function(e){return this._allRouteTaskActions||(this._allRouteTaskActions=this._getTranslatedAttributeValues("routeTaskAction",e)),this._allRouteTaskActions},allRouteTaskStates:function(e){return this._allRouteTaskStates||(this._allRouteTaskStates=this._getTranslatedAttributeValues("routeTaskValidStates",e)),this._allRouteTaskStates},allRouteTaskNoReviewStates:function(e){return this._allRouteTaskNoReviewStates||(this._allRouteTaskNoReviewStates=this._getTranslatedAttributeValues("routeTaskValidStates",e),this._allRouteTaskNoReviewStates&&this._allRouteTaskNoReviewStates.splice(1,1)),this._allRouteTaskNoReviewStates},_getTranslatedAttributeValues:function(e,t){var s,i=this.data();if(i&&i.definitions)for(var o=(s=this._getDefRange(e,t)).length,n=0;n<o;n++){var l=s[n];a.setWidgetConstant(l.actualValue,l.displayValue)}return s},setFlagForReferencedSimulationsService:function(e){widget.setValue("referencedSimulations",e.some(function(e){return"referencedSimulations"===e.name}))},allStatesForDisplay:function(){return this._allStatesForDisplay},allPrioritiesForDisplay:function(){return this._allPrioritiesForDisplay||(this._allPrioritiesForDisplay=this._getTranslatedAttributeValues("priority",{translateUsingE6WCommonAppsNLS:!0})),this._allPrioritiesForDisplay},allValues:function(){switch(this._attrToSplitBy){case T:return this.allDueDates();case"state":return this.allStates();case"stateForDisplay":return this.allStatesForDisplay();case"priority":return this.allPrioritiesForDisplay();default:return[]}},getSearchTypes:function(e,t){var s,i=this._getDefRange(e);return i&&i.length&&(s=i[0][t]),s},scopesTypesForSearch:function(){return this.getSearchTypes("scopes.scopesTypesForSearch","actualValue")},scopesTypes:function(){return this.getSearchTypes("scopes.scopesTypesForSearch","displayValue")},contentsTypesForSearch:function(){return this.getSearchTypes("contents.contentsTypesForSearch","actualValue")},contentsTypes:function(){return this.getSearchTypes("contents.contentsTypesForSearch","displayValue")},deliverablesTypesForSearch:function(){return this.getSearchTypes("deliverables.deliverablesTypesForSearch","actualValue")},deliverablesTypes:function(){return this.getSearchTypes("deliverables.deliverablesTypesForSearch","displayValue")},projectTypesForSearch:function(){return this.getSearchTypes("projectTypesForSearch","actualValue")},projectTypes:function(){return this.getSearchTypes("projectTypesForSearch","displayValue")},importTasksFromCSV:function(e,i){var a,o,n,l,r,c=s.parse(e),d={},u=c.length,h=[],p=[],m="";function g(e,s,i,a){return new t(function(t,i){var o={onComplete:function(){s.forEach(function(e){e._onCompleteRequest()}),t(s)},onFailure:function(){s.forEach(function(e){e._onCompleteRequest()}),i(new Error("timeout for: "+a))}};e.save(null,o)})}if(u)for(n=(o=c[0]).length,l=0;l<n;l++)(r=o[l].toLowerCase().trim()).match(/^(name|estimated duration|estimated finish date|type|description|assignee)$/)&&h.push({index:l,value:r.trim()});for(var C=this.allStates()[0],T=h.length,f=[],v=1;v<u;v++){o=c[v],(d={}).state=C;var b=[];for(l=0;l<T;l++){switch(r=o[h[l].index].trim(),h[l].value){case"name":d.title=r;break;case"estimated duration":d.estimatedDuration={actualValue:parseFloat(r),displayValue:r};break;case"estimated finish date":d.dueDate={actualValue:new Date(r).getTime(),displayValue:r};break;case"description":d.description={actualValue:r,displayValue:r};break;case"type":d.type=r.toLowerCase();break;case"assignee":b=r.split(";")}}"task"!==d.type||isNaN(d.estimatedDuration.actualValue)||isNaN(d.dueDate.actualValue)||(a=this.addNewTask(d),b&&b.length&&a.addAssigneesByName(b),p.push(a),a._onRequest(),this.updateModelInFoundation("create",a,null),m+=", "+d.title),p.length&&p.length%5==0&&(f.push(g(a,p,0,m)),p=[],m="")}p.length&&f.push(g(a,p,0,m)),t.all(f).then(function(){i.onComplete()},function(){i.onFailure()})},_cleanupSubCollections:function(){var e=Object.prototype.hasOwnProperty;for(var t in this._TasksByAttr)e.call(this._TasksByAttr,t)&&this._cleanupSubCollectionForAttr(t)},_cleanupSubCollectionForAttr:function(e){var t=Object.prototype.hasOwnProperty,s=this._TasksByAttr[e];for(var i in s){if(t.call(s,i))s[i].stopListening(),delete s[i]}},sync:function(t,s,i){var o=i||{},n=this,r=n._getStorage();if("read"===t&&n.isServerFetch(s,o)&&o.partialRefresh){var c={data:[]},d=this.data();if(d&&d.data){d.data.forEach(function(e){var t={id:e.id,cestamp:e.cestamp};e.serviceId&&(t.serviceId=e.serviceId),c.data.push(t)});var u="refreshWidget="+JSON.stringify(c);return a.loadServiceData(this._partialRefreshServiceName,function(t){var s,i=n.data();if(a.copyDefinition(i,t),a.__updateCsrf(i,t),t&&t.success&&t.data){for(var l=t.data,c=l.length,d=0;d<c;d++){var u=l[d];switch(u.updateAction.toUpperCase()){case"DELETE":n.remove(u.tempId),a.unloadObjects(n.data(),[u.tempId]);break;case"MODIFY":var h=u,p=a.__getSourceObjectFromServerObject(i,h);a.__synchronizeSourceObjectFromServerObject(i,h,p,!0,!0);break;case"CREATE":delete(h=u).updateAction;var m=new(w(u.type))(h);a.__addOrConnectObjectToStructure(i,void 0,void 0,h,void 0,m),n.add(m)}}r&&a.saveCachedData(r,n._serviceName,i),e.is(o.onComplete,"function")&&(s=o.onComplete(t,o))}else e.is(o.onFailure,"function")&&(s=o.onFailure(t,o));return s},!0,u,"application/x-www-form-urlencoded; charset=utf-8","$include=co-owners,predecessors,successors")}}else if(s instanceof l){var h=s;!h.toJSON({onlyUpdated:!0}).subscribed&&h.subscriptionsEnabled()&&h.set("sendEmail","sendEmail")}return this._parent.apply(this,arguments)},_onSync:function(e,t,s){if(e===this&&!this.dictionaryLoaded){var i=this.data();i&&i.definitions&&(this.dictionaryLoaded=!0,this.setFlagForReferencedSimulationsService(i.definitions),this.dispatchEvent("onChange:dictionary"))}},fetch:function(t){var s=this,i=e.clone(t||{},!1);if(d.isScopeRDF()||i.forceRDF)return"local"===this.lastReadFrom&&(this.lastReadFrom="server",this.dispatchEvent("onChange:lastReadFrom",[this,this.lastReadFrom,t])),this.clearData(),this.reset(void 0,i),this.getTNProxy().setSubjectsTags({},"foundation2"),{cancel:function(){},noFetch:!0};const a=function(){s.fetching--};this.fetching++;const o=i.onComplete,n=i.onFailure;return i.partialRefresh?(void 0===i.parse&&(i.parse=!0),i.onComplete=function(e){a(),o&&o(s,e,i)},i.onFailure=function(e){a(),n&&n(s,e,i),s.dispatchEvent("onError",[s,e,i])},s.sync("read",s,i)):(i.onComplete=function(e){a(),o&&o(s,e,i)},i.onFailure=function(e){a(),n&&n(s,e,i)},this._parent(i))},fetchTaskById:function(t,s){this.fetch(e.extend({server:!0,url:"/resources/v1/modeler/tasks",method:"POST",data:"$ids="+t,contentType:"application/x-www-form-urlencoded"},s))},getModelsAsArrayToHandleTagger:p.getModelsAsArrayToHandleTagger});return A.optimized=!0,A.TasksSplitCollection=h.extend({model:l}),A}),define("DS/CollaborativeTasks/Views/TasksTableView",["UWA/Core","UWA/Class","UWA/Class/Events","UWA/Class/Listener","UWA/Class/Promise","DS/DataGridView/DataGridView","DS/Tree/TreeDocument","DS/TreeModel/TreeNodeModel","DS/E6WCommonUI/UIHelper","DS/E6WCommonApps/TreeNodeUtil","DS/CollaborativeTasks/Views/TaskMenuMixin","DS/E6WCommonApps/DeleteUtil","DS/E6WCommonApps/TaskUtils","DS/E6WCommonApps/XTaskScope","DS/E6WCommonApps/Collections/FTSTaskPseudoCollection","DS/RDFFoundation/RDFUtils","DS/CollaborativeTasks/Views/TasksTableConfig","i18n!DS/E6WCommonApps/assets/nls/E6WCommonAppsNLS","DS/E6WCommonApps/Models/E6WCommonAppsConstants"],function(e,t,s,i,a,o,n,l,r,c,d,u,h,p,m,g,C,T,f){"use strict";var v=C.columns,b={},k={};const S={};var D=function(e){return T.get(e)},_=t.extend({});_.implement(d),_.implement(s);var w=o.extend({_uwaClassName:"TasksTableView",tagName:"span",createTreeDocument:function(){return new n},getSelectedColumnInfo:function(){var e,t=this.layout._getDataFromPreferences("columnsSortModel");return t&&this.columns.forEach(s=>{s.dataIndex===t.dataIndex&&(e=s)}),e||this.columns[0]},addNodeToMap:function(e,t){k[e]=t},getTreeNodeModels:function(e){var t=e.tasksCollection,s=e.rdfTasksCollection,i=this.createTreeDocument();if(i.prepareUpdate(),h.useFTS())this.showSubProjectTasks();else{var a=t.toArray();s&&(a=a.concat(s.toArray())),a.forEach(e=>{i.addChild(e.getTreeNodeModel()),this.addNodeToMap(e.id,e.getTreeNodeModel())})}return i.expandAll(),i.pushUpdate(),i},callRegisterReusableCellContent:function(t){t.forEach(t=>{this.registerReusableCellContent({id:t.id,buildContent:t.buildContent||function(){return e.createElement("div",{class:t.className})},getTweakerPadding:function(){return C.lengthOfEachCharacter}})})},setupResuableComponents:function(){this.callRegisterReusableCellContent([{id:C.reusableComponentIDs.attachment_or_deliverable,className:"fonticon fonticon-attach"},{id:C.reusableComponentIDs.context,className:"grid-object grid-context"},{id:C.reusableComponentIDs.project,className:"grid-object grid-project"},{id:C.reusableComponentIDs.assignee,className:"grid-object grid-member"},{id:C.reusableComponentIDs.owner,className:"grid-object grid-member"}])},_manageCellSelection:function(e,t,s){this._parent(e,t,s),this.openPropertyPanel(e),"DSpointerhit"!==e.type||this.isTouchDevice()||this.selectCell(this.getActiveCellID())},openOrResetPropertyPanelFromGrid:function(e){var t=this._activeCellStableID.nodeModel.getAttributeValue("correspondingModel");e?this.parentTaskView._detailPanel.resetModel(t):this.parentTaskView._detailPanel.isOpen()||e||(this.parentTaskView._detailPanel.open(),this.parentTaskView._detailPanel.resetModel(t))},isTouchDevice:function(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0},openPropertyPanel:function(e){if(this.isTouchDevice()){if(1===e.detail)if(this.parentTaskView._detailPanel.isOpen())this.openOrResetPropertyPanelFromGrid(!0);else{if(!this.clickOneDone&&!this.srcElement)return this.clickOneDone=!0,void(this.srcElement=e.srcElement);this.clickOneDone&&(this.srcElement===e.srcElement&&this.openOrResetPropertyPanelFromGrid(),delete this.clickOneDone,delete this.srcElement)}}else 1===e.detail&&this.parentTaskView._detailPanel.isOpen()?this.openOrResetPropertyPanelFromGrid(!0):2===e.detail&&this.openOrResetPropertyPanelFromGrid()},shouldModelBeAdded:function(e){return p.getFilter()!==p.FILTER_OWNED||(h.useFTS()?e._isOwnedByCurrentUser():e._isOwnedByOrAssignedToCurrentUser())},addNewNode:function(e,t){this.shouldModelBeAdded(e)&&(!e.id||k[e.id]||e.isBlank||(this.getTreeDocument().addChild(e.getTreeNodeModel()),this.addNodeToMap(e.id,e.getTreeNodeModel()),t&&this.subProjectTasks.push(e)))},removeNode:function(e){k[e.id]&&(this.getTreeDocument().removeRoot(k[e.id]),delete k[e.id],delete b[e.id])},handleTaskAddition:function(e,t){e.id&&k[e.id]?this.showNode(e):e.id?this.addNewNode(e,t):this.listenToOnce(e,"onChange:"+e.idAttribute,function(){this.addNewNode(e,t)})},addListenersToCollection:function(e){this.listenTo(e,"onAdd",function(e){this.handleTaskAddition(e)}),this.listenTo(e,"onRemove",function(e){this.removeNode(e)}),this.listenTo(e,"onReset",function(e,t){this.setupLoadingMessages(),this.onTaskCollectionsReset(e,t)})},addCollectionListeners:function(e){this.addListenersToCollection(e.tasksCollection),e.rdfTasksCollection&&this.addListenersToCollection(e.rdfTasksCollection)},hideNode:function(e){var t=k[e.id];t&&t.hide(),delete b[e.id]},showNode:function(e,t){k[e.id]?k[e.id].show():this.addNewNode(e,t)},addNodesInBulk:function(t,s){var i=this.getTreeDocument()||this.createTreeDocument();i.prepareUpdate(),t.forEach(e=>this.showNode(e,s)),e.Utils.Client.Engine.firefox?setTimeout(function(){i.pushUpdate()},0):i.pushUpdate()},removeNodesInBulk:function(e){var t=this.getTreeDocument();t.prepareUpdate(),e.forEach(e=>this.hideNode(e)),t.pushUpdate()},onTaskCollectionsReset:function(t,s){var i=[],a=e.is(s.previousModels,"array")?s.previousModels.slice():[];a.length>0?t.forEach(function(e){var t=a.indexOf(e);-1===t?i.push(e):a.splice(t,1)}):i=t.toArray(),this.removeNodesInBulk(a),this.addNodesInBulk(i)},customizeScroller:function(){var e=this;this._getScroller().onScrollEnd(function(){this.getPosition().y!==this._lastScrollPosition.y&&e.invokeLazyLoading()})},invokeLazyLoading:function(){var e=this.getModelsAndIDsToFetch();e&&(this.rdfTasksCollection&&this.rdfTasksCollection.complete(e.rdfModelIDsToBeFetched,{onlyIfNeeded:!0}),this.tasksCollection.complete(e.nonRDFModelsToBeFetched,{onlyIfNeeded:!0}))},getModelsAndIDsToFetch:function(){let e,t=[],s=[],i=this.layout.collectionView._rowModel;if(i){let o=this.layout.getMinMaxVisibleRowIDs();if(o.minRowID<=0&&o.maxRowID<=0)return void this.onPostUpdateViewOnce(this.invokeLazyLoading);for(let n=o.minRowID;n<=o.maxRowID;n++){var a=(e=i.getVisibleNodeModel(n).getAttributeValue("correspondingModel")).id;b[a]||(b[a]=!0,e.isRDFTask()?t.push(a):s.push(e))}}return{rdfModelIDsToBeFetched:t,nonRDFModelsToBeFetched:s}},_sortAfterFetching:function(e,t){let s=0;const i=this,a=function(){0===--s&&setTimeout(function(){i._rowModel._applySortModel(e,t)},0)};if(this.tasksCollection.fetching&&(s++,this.listenToOnce(this.tasksCollection,"onSync",a)),this.rdfTasksCollection&&this.rdfTasksCollection.fetching){s++;const e=function(){i.stopListening(i.rdfTasksCollection,"onSync"),i.stopListening(i.rdfTasksCollection,"doneCompleting"),a()};this.listenToOnce(this.rdfTasksCollection,"onSync",e),this.listenToOnce(this.rdfTasksCollection,"doneCompleting",e)}},customizeSortingForColumns:function(e){var t=this.tasksCollection,s=this.rdfTasksCollection,i=this;this._rowModel._applySortModel=function(o,n){var l=this,r=arguments;if(t.fetching||s&&s.fetching)i._sortAfterFetching(o,n);else if(o&&o.length||n&&n.length)if(!o||!o.length||n&&n.length){var d=Object.keys(c.ER_TO_TREE_NODE).filter(e=>c.ER_TO_TREE_NODE[e]===n[0].dataIndex).join(","),u=[];s&&u.push(new a(function(e){var t=s.map(e=>e.id);t.length?s.complete(t,{mask:c.getMasksForFetchingRDFTaskDetails(n[0].dataIndex),onlyIfNeeded:!0,onComplete:function(){e()}}):e()})),!S[d]&&d&&u.push(new a(function(e){if(t.length>0){const s=t._initialLoadOptions;t._initialLoadOptions=`$include=none&$fields=${d}&$definition=true&$terse=true`,t.fetch({onComplete:()=>{S[d]=!0,t._initialLoadOptions=s,e()}})}else e()})),i.showLoadingMessage(),a.all(u).then(function(){i.hideLoadingMessage(),e.apply(l,r),i.invokeLazyLoading()})}else e.apply(l,r)}},showLoadingMessage:function(){this.elements&&r.showLoadingMessage(this.elements.container)},hideLoadingMessage:function(){r.hideLoadingMessage(this.elements.container)},setupLoadingMessages:function(){this.showLoadingMessage(),this.tasksCollection.fetching||this.rdfTasksCollection&&this.rdfTasksCollection.fetching?(this.tasksCollection.fetching&&this.listenToOnce(this.tasksCollection,"onSync",this.hideLoadingMessage),this.rdfTasksCollection&&this.rdfTasksCollection.fetching&&(this.listenToOnce(this.rdfTasksCollection,"onSync",this.hideLoadingMessage),this.listenToOnce(this.rdfTasksCollection,"doneCompleting",this.hideLoadingMessage))):window.widget.getValue("appId")===f.APP_TSK&&0===this.tasksCollection.length&&this.rdfTasksCollection&&0===this.rdfTasksCollection.length?setTimeout(this.hideLoadingMessage.bind(this),1e3):window.widget.getValue("appId")===f.APP_3DPLAN&&0===this.rdfTasksCollection.length?setTimeout(this.hideLoadingMessage.bind(this),1e3):(this.tasksCollection.length>0||this.rdfTasksCollection&&this.rdfTasksCollection.length>0)&&this.hideLoadingMessage()},getTaskMenu:function(e){const t=new _;var s=this;t.getParentView=function(){return s.parentTaskView};var i=e.isComplete()?[{actualValue:f.ACTIVE,displayValue:D("E6WCommonApps.Label.InWork")}]:[{actualValue:f.COMPLETE,displayValue:D("E6WCommonApps.Label.Completed")}];return t.options={stateValues:i},t.model=e,t},onEditOnGridView:function(){this.parentTaskView._detailPanel.isOpen()?this.openOrResetPropertyPanelFromGrid(!0):this.openOrResetPropertyPanelFromGrid()},getContextualMenu:function(e,t){var s=[];if(e.cellInfos&&e.cellInfos.rowID>-1){var i=e.cellInfos.nodeModel.getAttributeValue("correspondingModel");i.hasFetchedAccessData()||i.fetchAccess();var a=this.getTaskMenu(i);this.listenTo(a,"onTaskCardClicked",function(){i.dispatchEvent("onEditOnGridView")}),this.listenTo(i,"onEditOnGridView",this.onEditOnGridView),a.createMenuButtons().dropdown.items.forEach(e=>{var t=e.disabled?"disabled":"",i="divider"===e.className?"SeparatorItem":"PushItem";s.push({type:i,title:e.text,icon:e.fonticon,state:t,action:{callback:e.func||e.handler}})})}else s=e.collectionView.buildDefaultContextualMenu(e,t);return s},updateTreeDocumentWithNewModels:function(e){this.resetTreeDocumentAndMap(),e.forEach(e=>{this.handleTaskAddition(e)})},onLevelChanged:function(){h.useFTS()?this.showSubProjectTasks():this.hideSubProjectTasks()},updateRDFCollection:function(e){this.stopListening(this.rdfTasksCollection),this.rdfTasksCollection=e,this.updateTreeDocumentWithNewModels(e),this.addListenersToCollection(this.rdfTasksCollection)},resetTreeDocumentAndMap:function(){this.treeDocument.empty(),k={}},addListenersToColCollectionsForAdd:function(){var e=this;this.parentTaskView._columnViews.forEach(t=>{e.parentTaskView.listenTo(t.collection,"onAdd",function(t){e._ftsCollection.add(t)})})},_onCompleteSubProjectTasksFetch:function(){this.addListenersToColCollectionsForAdd(),this.addListenersToCollection(this._ftsCollection),this.addNodesInBulk(this._ftsCollection._models,!0),this.hideLoadingMessage()},showSubProjectTasks:function(){this.subProjectTasks=[],this.treeDocument&&this.resetTreeDocumentAndMap(),this.showLoadingMessage(),this.stopListening(this._ftsCollection),this._ftsCollection.reset(),this._ftsCollection.fetch({limit:1e5,tagFilters:this.parentTaskView._tagFilters,onComplete:this._onCompleteSubProjectTasksFetch.bind(this),onFailure:this.hideLoadingMessage})},showFirstLevelTasks:function(){this.addNodesInBulk(this.rdfTasksCollection.toArray()),this.hideLoadingMessage()},hideSubProjectTasks:function(){this.removeNodesInBulk(this.subProjectTasks),this.subProjectTasks=[],this.showFirstLevelTasks()},init:function(e){this.tasksCollection=e.tasksCollection,this.rdfTasksCollection=e.rdfTasksCollection,this.parentTaskView=e.parentTaskView,this.subProjectTasks=[],this.rdfTasksCollection&&(this._ftsCollection=new m(void 0,{view:f.TASK_TABLE,parentModel:this.rdfTasksCollection.parentModel}));var t=this.getTreeNodeModels(e);this._parent({identifier:"TasksTableView",treeDocument:t,columns:v,rowSelection:"single",cellSelection:"none",showSelectionCheckBoxesFlag:!1,onContextualEvent:this.getContextualMenu,cellActivationFeedback:"row",layoutOptions:{layoutDensity:"comfortable"}}),this.setupLoadingMessages(),this.setupResuableComponents(),this.addCollectionListeners(e),this.customizeScroller(),this.customizeSortingForColumns(this._rowModel._applySortModel),this.onPostUpdateView(this.invokeLazyLoading)}});return w.implement(i),w.implement(s),w}),define("DS/CollaborativeTasks/Views/ColumnView",["UWA/Core","UWA/Event","UWA/Class/View","DS/UIKIT/Scroller","DS/Handlebars/Handlebars4","DS/E6WCommonUI/Views/FoundationBaseView","DS/CollaborativeTasks/Collections/TasksCollection","DS/CollaborativeTasks/Views/CardView","DS/UIKIT/Tooltip","DS/E6WCommonUI/UIHelper","DS/E6WCommonUI/DragUtil","DS/E6WCommonApps/SmartSchedulerUtils","DS/E6WCommonApps/Models/E6WCommonAppsConstants","text!DS/CollaborativeTasks/assets/templates/column.html.handlebars","DS/Foundation2/FoundationV2Data","DS/E6WCommonUI/Views/E6WHandlebarsHelpers"],function(e,t,s,i,a,o,n,l,r,c,d,u,h,p,m,g){"use strict";var C=function(){return m.getWidgetConstant.apply(this,arguments)},T=a.compile(p),f=o.extend({_uwaClassName:"ColumnView",tagName:"div",className:"column ds-dialog drop-target",name:"CollaborativeTasks.ColumnView",id:function(){return this.collection.extid},domEvents:{"dragstart .ui-droppable":"handleDragStart","dragenter .ui-droppable":"handleDragEnter","dragleave .ui-droppable":"handleDragLeave","dragover .ui-droppable":"handleDragOver","dragend .ui-droppable":"handleDragEnd","drop .ui-droppable":"handleDrop"},_addChildrenViewAtBack:function(){var e=this._childrenViews.length;this.resetChildViews(this._firstChild+e,!0),this._addChildrenToDom(e,void 0,!0)},_addChildrenViewAtFront:function(){var e=this._childrenViews.length,t=f.nbCardsBuffer-e;this.resetChildViews(Math.max(this._firstChild-t,0),!0,!0),this._addChildrenToDom(0,this._childrenViews.length-e,!0)},resizeBuffer:function(){var e=this._childrenViews.length;if(e<f.nbCardsBuffer&&e<this.collection.size()){var t=this.collection.size();if(this._firstChild+e>=t)this._addChildrenViewAtFront();else{this._addChildrenViewAtBack();var s=this._childrenViews.length;s<f.nbCardsBuffer&&s<this.collection.size()&&this._addChildrenViewAtFront()}}else if(e>f.nbCardsBuffer)for(var i;this._childrenViews.length>f.nbCardsBuffer;)i=this._childrenViews.pop(),this._recycleChild(i);this._adjustBufferHeights()},_onScroll:function(t){if(this.clearDropdown(),this.collection&&this.container){var s=e.Event.getElement(t);if(s&&this._childrenViews.length&&this.collection.length-this._childrenViews.length>0){f._cardHeight||this._computeCardHeight();var i=s.scrollTop,a=Math.floor(i/f._cardHeight),o=Math.max(a-f.nbCardsTopBuffer,0),n=(o=Math.min(o,this.collection.length-f.nbCardsBuffer))-this._firstChild;if(0!==n){if(n>0)if(n>=this._childrenViews.length)this.resetChildViews(o),this._addChildrenToDom(0,void 0);else{for(var l=0;l<n;l++){var r=this._childrenViews.shift();this._recycleChild(r)}this.resetChildViews(o+this._childrenViews.length,!0),this._addChildrenToDom(this._childrenViews.length-n,void 0)}else if(n<0)if((n=-n)>=this._childrenViews.length)this.resetChildViews(o),this._addChildrenToDom(0,void 0);else{for(var c=this._childrenViews.length-f.nbCardsBuffer+n,d=0;d<c;d++){var u=this._childrenViews.pop();this._recycleChild(u)}var h=this._childrenViews.length;this.resetChildViews(o,!0,!0),this._addChildrenToDom(0,this._childrenViews.length-h)}this._adjustBufferHeights()}}}},setDropdown:function(e){this.dropdown=e},clearDropdown:function(){this.dropdown&&(this.dropdown.hide(),delete this.dropdown)},_createTaskView:function(e){var t=new l({model:e,parentView:this});return this.listenTo(t,{onTaskCardClicked:function(){this.dispatchEvent("onTaskCardClicked",arguments)},onDestroy:function(){this.dispatchEvent("onTaskDestroyed",arguments)}}),t},_getRecycledChild:function(e){var t;return this._recycleBin&&this._recycleBin.length?((t=this._recycleBin.pop()).model=e,t.container.id=t.id(),t.listenToModelEvent(),delete t._recycled):t=this._createTaskView(e),t},_recycleChild:function(e){this.dispatchEvent("onTaskDestroyed",arguments),e._recycled=!0,e.container.remove(),e.container.empty(!0),this._recycleBin.push(e)},getNonRDFSelectedViewId:function(){var e=this.getParentView(),t=e&&e._selectedView;if(t&&!t.model.isRDFTask())return t.model.id},resetChildViews:function(e,t,s){var i=e||0,a=this;this._childrenViews||(this._childrenViews=[]);var o=t?this._childrenViews.length:0;this._firstChild=i-(s?0:o);var n=a.collection.length,l=(i=Math.max(0,i))+(f.nbCardsBuffer-o);l=Math.min(n,l);var r,c={};if(t)this._childrenViews.forEach(function(e){var t=e.model;c[t.id]=e});else{var d,u=[],h={};for(r=i;r<l;r++)h[a.collection.at(r).id]=!0;var p=a.getNonRDFSelectedViewId();this._childrenViews.forEach(function(e){var t=e.model;h[t.id]?(t.isRDFTask()||(a._recycleChild(e),(e=a._getRecycledChild(a.collection.get(e.model.id))).model.id===p&&(d=e)),u.push(e),c[t.id]=e):a._recycleChild(e)}),this._childrenViews=u,d&&this.getParentView().select(this,d)}if(s)for(var m=l-1;m>=i;m--){var g=a.collection.at(m);if(!c[g.id]){var C=a._getRecycledChild(g);a._childrenViews.unshift(C)}}else for(r=i;r<l;r++){var T=a.collection.at(r);if(!c[T.id]){var v=a._getRecycledChild(T);a.addChildView(v)}}},tasksChanged:function(){this.container.innerHTML="",this.resetChildViews(),this.render()},_onAdd:function(e,t,s){if(!s||!s.fromServer){var i=s.at;i=void 0!==i?i:this._childrenViews.length-1;var a,o=this._getRecycledChild(e);if(o){this._childrenViews.splice(i,0,o);var n=this.getElement(f.CssSelectorMarkingInsertionPoint);o.render(),0===i?o.container.inject(n,"after"):o.container.inject(this.getElement(f.CssSelectorMarkingBottomInsertionPoint),"before")}if(f.lastCardAdded=o,this._childrenViews.length>f.nbCardsBuffer)a=0!==i?this._childrenViews.shift():this._childrenViews.pop(),this._recycleChild(a);e.id&&(f.pushToComplete(o),this.scheduleComplete()),this._adjustBufferHeights(),this.getElement(f.TitleObjectCountId).setText(f.TitleObjectCountString.replace("%COUNT%",this.collection.length))}},_onRemove:function(e){var t=this;this._childrenViews=this._childrenViews.filter(function(s){return s.model!==e||(t._recycleChild(s),!1)});var s=this._childrenViews.length,i=this.collection.length;this._firstChild+f.nbCardsBuffer>i&&f.nbCardsBuffer<i?(this.resetChildViews(this._firstChild-1,!0,!0),this._addChildrenToDom(0,this._childrenViews.length-s,!0)):(this.resetChildViews(this._firstChild+this._childrenViews.length,!0),this._addChildrenToDom(s,void 0,!0)),this._adjustBufferHeights(),this.getElement(f.TitleObjectCountId).setText(i?f.TitleObjectCountString.replace("%COUNT%",i):"")},setup:function(e){return this._parent.apply(this,arguments),this._firstChild=0,this._scrolling=0,this.resetChildViews(),this.listenTo(this.collection,"onReset",this.tasksChanged),this.listenTo(this.collection,"onTaskCollectionFetchComplete",function(){this._parentView.isBeingTagFiltered()||this.tasksChanged()}),this.listenTo(this.collection,"onAdd",this._onAdd),this.listenTo(this.collection,"onRemove",this._onRemove),this.listenTo(this.collection,"onValidationFailure",function(e,t){for(var s,i=0;i<t.fields.length;i++)"needsReview"===t.fields[i]?s=C("emxCollaborativeTasks.Error.needsReview"):"routeTaskApprovalComments"===t.fields[i]?s=C("emxCollaborativeTasks.Error.needsApprovalComments"):"routeTaskApprovalAction"===t.fields[i]?s=C("emxCollaborativeTasks.Error.needsApprovalAction"):"routeTaskReviewerComments"===t.fields[i]&&(s=C("emxCollaborativeTasks.Error.needsReviewerComments"));s&&c.displayError(s)}),this._recycleBin=[],this.$dsTaskManagement=e.$dsTaskManagement,e},destroy:function(){clearTimeout(this.completeTimeout),delete this.completeTimeout,this.container.remove(),this._scroller&&this._scroller.destroy();for(var e=this._recycleBin.length,t=0;t<e;t++){this._recycleBin[t].destroy()}delete this._recycleBin,this._parent(),this.$dsTaskManagement=null,this.container=null,delete this._BottomPlaceholder,delete this._TopPlaceholder,this._taskFilterTooltip&&this._taskFilterTooltip.destroy(),delete this._taskFilterTooltip},template:function(){var e=g.i18n;g.i18n=C;var t=this.collection.dataForRendering(),s=t.filteredByValue&&t.filteredByValue.actualValue;"all"===widget.getValue(u.COMPLETED_TASK_PREF_NAME)||"Done"!==s&&"Complete"!==s||(t.completedTaskFilterOn=!0);var i=T(t);return g.i18n=e,i},processModelDrop:function(e){var t=this.getElement(".drop-zone-mask");t.addClassName("dropping");var s=this.collection._valueForFiltering;s=s.displayValue?s.displayValue:s;var i=this.collection.getSaveAttributes();setTimeout(function(){t.removeClassName("dropping")},500);var a=this.getColumnFilterAttrValue();e.save(i,{patch:!0,onComplete:function(){var e=C("emxCollaborativeTasks.Label.SuccessfullyChangedAttribute");e=(e=e.replace("%ATTRIBUTE_NAME%",C("emxCollaborativeTasks.Command.View."+a))).replace("%ATTRIBUTE_VALUE%",s),c.displaySuccess(e)},onFailure:function(e,t,i){var o=C("emxCollaborativeTasks.Error.FailedToChangeAttribute");o=(o=o.replace("%ATTRIBUTE_NAME%",C("emxCollaborativeTasks.Command.View."+a))).replace("%ATTRIBUTE_VALUE%",s),i&&i.response&&400===i.response.statusCode&&i.response.error&&(o+="<br>"+C(c.sanitizeMessage(i.response.error))),c.displayError(o)}})},_addChildrenToDom:function(e,t,s){for(var i=e||0,a=t?t+e:this._childrenViews.length,o=document.createDocumentFragment(),n=[],l=i;l<a;l++){var r=this._childrenViews[l];r.container.inject(o),n.push(r)}var c,d,u=this,h=function(){var e,t=n.length;e=!1;for(var i=0;i<t;i++){var a=n[i];!a._recycled&&a.model&&a.container&&(a.render(),a.model.completed||(e=!0,f.pushToComplete(a)))}f.toComplete&&f.toComplete.length&&e&&(s?u.complete():u.scheduleComplete())};n.length&&(s?h():setTimeout(h,21),t&&e+t<this._childrenViews.length&&(d=(c=this._childrenViews[e+t].container).parentElement),c&&!c._recycled||(d=(c=this._BottomPlaceholder).parentElement),d.insertBefore(o,c))},scheduleComplete:function(){this.completeTimeout||(this.completeTimeout=setTimeout(this.complete.bind(this),200))},complete:function(){if(this.collection&&f.toComplete){for(var e=[],t=0,s=f.toComplete.length;t<s;t++){var i=f.toComplete[t];!i._recycled&&i.model&&i.container&&e.push(i.model)}this.collection.complete(e,{onlyIfNeeded:!0}),delete f.toComplete}delete this.completeTimeout},_computeCardHeight:function(){var e=this._childrenViews[0];if(e){var t=e.container.getDimensions();t.height>0&&(f._cardHeight=t.outerHeight)}},_adjustBufferHeights:function(){if(this.collection){var e=Math.max(this.collection.length-this._childrenViews.length-this._firstChild,0);if(this._childrenViews[0]){f._cardHeight||this._computeCardHeight(),f._cardHeight||setTimeout(this._adjustBufferHeights.bind(this),0);var t=f._cardHeight||80;this._BottomPlaceholder&&this._BottomPlaceholder.setStyle("height",e*t),this._TopPlaceholder&&this._TopPlaceholder.setStyle("height",this._firstChild*t)}}},render:function(){for(var t=this,s=this._childrenViews.length,a=0;a<s;a++){t._childrenViews[a].container.remove()}t.container.empty(!0),delete this._BottomPlaceholder,delete this._TopPlaceholder,t.container.setHTML(this.template());var o=this.container.getElement(".fonticon-filter");o&&this.setCompletedTaskFilterToolTip(o),this._BottomPlaceholder=this.getElement(".bottom-buffer"),this._TopPlaceholder=this.getElement(".top-buffer");var n=t.getElement(f.CssSelectorMarkingInsertionPoint);n.getParent().setSelectable(!1),this._columnContent=t.getElement(".body"),this._scroller&&this._scroller.destroy();return this._scroller=new i({element:n.parentElement}).inject(this._columnContent),this.getElement(".scroller-content").addEventListener("scroll",function(s){if(t.container){var i=t.lastScrollEvtTime?t.lastScrollEvtTime:0,a=s.timeStamp-i>1e3,o=t.container.getElement(".scroller-content").scrollTop;if(0===t._scrolling&&(t.scrollTopPos!==o||a)){t.scrollTopPos=o,t.lastScrollEvtTime=s.timeStamp,t._scrolling++;var n=e.clone(s,!1);window.requestAnimationFrame(function(){t._onScroll(n),t._scrolling--})}}}),this._addChildrenToDom(0,void 0,!0),this._adjustBufferHeights(),this.container.addEvent("dragenter",this.handleDragEnter.bind(this)),this},setCompletedTaskFilterToolTip:function(e){var t=widget.getValue("completedTasksDisplayPref"),s=C("emxCollaborativeTasks.Label.CompletedTaskTopCountFilterToolTip");s=s.replace("%DAY_COUNT%",t),this._taskFilterTooltip=new r({target:e,body:s+"<br><br>"+C("emxCollaborativeTasks.Label.ChangeCompletedTaskFiltering")})},getVisibleModels:function(){var e=[];f._cardHeight||this._computeCardHeight();var t=this._scroller.getInnerElement(),s=t.scrollTop,i=Math.floor(s/f._cardHeight),a=t.getSize().height,o=Math.ceil(a/f._cardHeight);o=Math.min(o,this.collection.length);for(var n=0;n<o;n++)e.push(this.collection.at(n+i));return e},getColumnViewName:function(){var e=this.collection._valueForFiltering;return e.actualValue||e},getColumnFilterAttrValue:function(){var e=this.collection._filterAttr;return e.actualValue||e},canDragOverColumn:function(){var e=!1,t=d.getDragModel();if(t){var s=this.getColumnViewName(),i=this.getColumnFilterAttrValue();e=t.get(i)!==s;var a=t.get("dsxplan:jsType")||t.get("type");e&&t.isRDFTask()?"state"===i?e="Assign"===s||"Active"===s||"Complete"===s:"dueDateCategory"===i&&(e="NO_DATE"!==s):e&&(c.isMilestone(a)||c.isGate(a))&&"state"===i&&(e="Create"===s||"Review"===s||"Complete"===s)}return e},handleDragStart:function(e){var t=e.target,s=o.getViewFromContainer(t);d.setDragView(s),this.container.click()},handleDragEnter:function(){if(!this.canDragOverColumn())return this.container.toggleClassName(h.DROP_CLASS_NAME,!1),!1;this._parentView.clearAllDropZoneMasks(),this.container.getElement(".ui-droppable").toggleClassName(h.DROP_CLASS_NAME,!0)},handleDragOver:function(e){return e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="copy",!!this.canDragOverColumn(e)&&(this.container.getElement(".ui-droppable").toggleClassName(h.DROP_CLASS_NAME,!0),!1)},handleDragLeave:function(e){e.target.getParent().toggleClassName(h.DROP_CLASS_NAME,!1),this.adjustScrolling(e)},handleDragEnd:function(){d.setDragModel(),d.setDragView(),this._parentView.clearAllDropZoneMasks()},handleDrop:function(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault();var t=d.getDragModel();return this.canDragOverColumn()&&this.processModelDrop(t),d.setDragModel(),d.setDragView(),this._parentView.clearAllDropZoneMasks(),!1},adjustScrolling:function(e){var t,s;if(!this._parentView.autoScrolling)try{t=d.getDragView().container.offsetWidth,s=e.clientX;var i=this._parentView.container.offsetWidth,a=this._parentView.container.getOffsets().x;s+t-a>i+t/3?this._parentView.scrollRight():s-a<=t/3&&this._parentView.scrollLeft()}catch(e){}},getParentView:function(){return this._parentView},getSuperModal:function(){return this.getParentView().getSuperModal()}});return f.nbCardsBuffer=20,f.nbCardsTopBuffer=5,f.CssSelectorMarkingInsertionPoint=".top-buffer",f.CssSelectorMarkingBottomInsertionPoint=".bottom-buffer",f.TitleObjectCountId=".object-count",f.TitleObjectCountString="(%COUNT%)",f.pushToComplete=function(){f.toComplete||(f.toComplete=[]),f.toComplete.push.apply(f.toComplete,arguments)},f}),define("DS/CollaborativeTasks/Views/RouteTaskDetailsPanelConfig",["DS/Foundation2/FoundationV2Data","DS/RDFFoundation/RDFUtils","DS/RDFFoundation/FederatedSearchUtil","DS/CollaborativeTasks/Models/TaskModel","DS/CollaborativeTasks/Views/ERTasksDetailsPanelConfig","DS/E6WCommonUI/Views/ObjectCardView","DS/E6WCommonUI/Models/DropValidator","DS/E6WCommonUI/UIHelper","DS/E6WCommonApps/Views/LinkLauncherUtils","DS/E6WCommonApps/SmartSchedulerUtils","DS/E6WCommonApps/Views/E6WObjectCardView","i18n!DS/E6WCommonApps/assets/nls/E6WCommonAppsNLS","DS/E6WCommonUI/PlatformManager"],function(e,t,s,i,a,o,n,l,r,c,d,u,h){"use strict";var p=function(t){var s=e.getWidgetConstant.apply(this,arguments);return s===t&&(s=u.get(t)),s},m={},g=function(e){var t=e&&e.isTaskReassignmentRequired()&&e.get("routeOwnerUGName");return h.getServiceUrl("swym",!0)&&!t?["swym"]:["3dspace"]};return m.config=function(e){var i=p("emxCollaborativeTasks.GroupLabel.More"),o="false"!==p("emxComponents.Routes.ShowCommentsForTaskApproval").toLowerCase().trim(),u="false"!==p("emxComponents.Routes.EnforceAssigneeApprovalComments").toLowerCase().trim(),h=e&&"Comment"!==e.get("routeTaskAction"),m=e&&"No"!==e.get("routeTaskSetDueDate"),C=e&&"FALSE"!==e.get("routeTaskDelegationAllowed"),T=e&&"No"!==e.get("needsReview"),f=e.collection.contentsTypesForSearch(),v=e.collection.contentsTypes(),b=a.attachmentFieldConfig;b.excludeSearchTypes["3dspace"]=["Person","Security Context","Business Role","Route","Route Template","Inbox Task"];var k,S=[{name:"title",label:p("emxCollaborativeTasks.Label.Title"),type:"text",numberOfEditableLines:4,maxLength:128},{name:"routeTaskAction",label:p("emxCollaborativeTasks.Label.TaskExpectedAction"),type:"select"},{name:"routeTaskInstructions",label:p("emxCollaborativeTasks.Label.TaskInstructions"),type:"textarea"},{name:"route",attributeToDisplay:"name",imageAttribute:"image",singleObjectOnly:!0,label:p("emxCollaborativeTasks.Label.Route"),type:"object",customView:d,linkCallback:r.launchProperties},{readWrite:"true",required:u,name:"routeTaskApprovalComments",label:p("emxCollaborativeTasks.Label.TaskApproverComments"),type:"textarea",numberOfDisplayLines:3,numberOfEditableLines:6},{name:"needsReview",label:p("emxCollaborativeTasks.Label.TaskNeedsReview"),type:"checkbox"},{readWrite:"true",name:"state",label:p("emxCollaborativeTasks.Label.TaskMaturityState"),type:"select"},{readWrite:"false",name:"routeTaskDueDate",label:p("emxCollaborativeTasks.Label.TaskDueDate"),type:"date"},{readWrite:"true",name:"assignees",attributeToDisplay:"name",imageAttribute:"image",label:p("emxCollaborativeTasks.Label.Assignees"),searchTitle:p("E6WCommonApps.Label.assigneeSearchTitle"),typeAheadCallback:t.typeAheadCallback,singleObjectOnly:!0,type:"person",dropTypes:n.PERSON_DROP_TYPES,customView:d,linkCallback:r.launchProperties,searchSourceTypes:(k=g(),"swym"===k.toString()?{swym:["pno:Person"]}:{"3dspace":["Person"]}),searchSource:s.filterSearchSources(g()),excludeSearchTypes:function(e){var t;return"swym"===e.toString()||(t={"3dspace":["Security Context"]}),t}(g()),customButtons:[l.assignToSelfButtonConfig()]},{readWrite:"true",name:"contents",attributeToDisplay:"name",imageAttribute:"image",label:p("emxCollaborativeTasks.Label.Content"),searchTitle:p("emxCollaborativeTasks.Label.contentsSearchTitle"),typeAheadCallback:t.typeAheadCallback,type:"object",customView:d,linkCallback:r.launchProperties,placeHolder:p("emxCollaborativeTasks.Label.ObjectPlaceHolder"),searchSource:s.filterSearchSources(["3dspace"]),dropTypes:{"3dspace":v&&v.split(",")},searchSourceTypes:{"3dspace":f&&f.split(",")},excludeSearchTypes:{"3dspace":["Person","Security Context"]},allowFileManagement:!0,validateSameTenant:!0,getDropDownMenuItems:c.getDocumentTypeDropDownMenuItems},b,{name:"routeTaskApprovalAction",label:p("emxCollaborativeTasks.Label.Decision"),type:"select"},{name:"project",label:p("emxCollaborativeTasks.Label.CollaborativeSpace"),type:"text"},{name:"originatorInfo",attributeToDisplay:"name",imageAttribute:"image",label:p("emxCollaborativeTasks.Label.TaskOriginator"),type:"person",customView:d,linkCallback:r.launchProperties,searchSource:["swym"]},{name:"ownerInfo",attributeToDisplay:"name",imageAttribute:"image",label:p("emxCollaborativeTasks.Label.TaskOwner"),type:"person",customView:d,linkCallback:r.launchProperties,searchSource:["swym"]},{name:"originated",label:p("emxCollaborativeTasks.Label.TaskCreated"),type:"date",group:i},{name:"modified",label:p("emxCollaborativeTasks.Label.TaskModified"),type:"date",group:i}];T&&S.splice(6,0,{readWrite:"true",required:!0,name:"routeTaskReviewerComments",label:p("emxCollaborativeTasks.Label.TaskReviewerComments"),type:"textarea",numberOfDisplayLines:3,numberOfEditableLines:6}),o||S.splice(4,1);var D=e.get("routeOwner"),_=e.get("routeOwnerUGName"),w=e.get("state"),A=C||enoviaServer.user===D;h&&"Assign"!==w||(T?S.splice(12,1):S.splice(11,1));for(var y=0;y<S.length;y++)("assignees"===S[y].name&&!A||"routeTaskDueDate"===S[y].name&&!m||"routeTaskReviewerComments"===S[y].name&&(enoviaServer.user!==D||"Review"!==w))&&delete S[y].readWrite,("routeTaskReviewerComments"===S[y].name&&(enoviaServer.user!==D||"Review"!==w)||"routeTaskApprovalComments"===S[y].name&&"Complete"===w)&&(delete S[y].required,delete S[y].numberOfDisplayLines),"assignees"===S[y].name&&A&&_&&(S[y].userRole=_);return S},m}),define("DS/CollaborativeTasks/Views/DetailsPanel",["UWA/Core","UWA/Class/Events","DS/Foundation2/FoundationV2Data","DS/E6WCommonApps/Views/PropertyPanel","DS/DocumentManagement/DocumentManagement","DS/UIKIT/Input/Button","DS/CollaborativeTasks/Views/ERTasksDetailsPanelConfig","DS/CollaborativeTasks/Models/TskCloneModel","DS/CollaborativeTasks/Views/TaskMenuMixin","DS/E6WCommonApps/Models/NoAccessModel","DS/E6WCommonApps/Models/RDFTaskModel","DS/E6WCommonApps/Models/RDFTaskCloneModel","DS/CollaborativeTasks/Views/RouteTaskDetailsPanelConfig","DS/E6WCommonApps/Models/AssigneeTypeAhead","DS/E6WCommonApps/Views/RDFTaskDetailsPanelConfig","DS/E6WCommonApps/Models/E6WCommonAppsConstants","i18n!DS/E6WCommonApps/assets/nls/E6WCommonAppsNLS","i18n!DS/E6WCommonUI/assets/nls/E6WCommonUINLS","DS/E6WCommonUI/UIHelper"],function(e,t,s,i,a,o,n,l,r,c,d,u,h,p,m,g,C,T,f){"use strict";var v=function(e){var t=s.getWidgetConstant.apply(this,arguments);if(t===e||null==t){var i=C.get(e);return i===e&&(i=T.get(e)),i}return t},b="column ds-dialog property-panel off",k="off";b="slide-in-panel right ds-dialog",k="active";var S=i.extend({_uwaClassName:"DetailsPanel",_durationOfDetailOpening:500,tagName:"div",className:b,name:"CollaborativeTasks.DetailsPanel",domEvents:{"click #completeItem":"toggleStateIntoOrOutOfDone","click #bookmarkButton":"bookmarkItem","click #deleteButton":"deleteItemCallback","click #duplicateButton":"duplicateItemCallback","click #openProjectItem":function(){this.openProjectItemCallback()},"click #subscribeToItem":"toggleSubscription",resize:function(){delete this._width,this._adjustHeader()}},bookmarkItem:function(){this._bookmarkHandler()},treatCustomFields:function(t,s){for(var i=Object.keys(s),a=i.length,o=0;o<a;o++){var n=s[i[o]],l={};if(l.name=n.name,l.label=n.label,void 0!==this.model.get(n.name)){var r=n.viewConfig;try{if(l.name&&l.label&&r){e.extend(l,r);var c=l.insertIndex||0;void 0!==l.insertIndex?t.splice(c,0,l):t.push(l)}}catch(e){console.log(e)}}}},close:function(){this._parent.apply(this,arguments),this.container.toggleClassName(k,!1),this._isOpen&&(this._isOpen=!1,this._lockWidths(),this.dispatchEvent("onClose"))},open:function(e){var t=this;this.container.toggleClassName(k,!0),this._width=e,this._isOpen||(this._isOpen=!0,this._unlockWidths(),this.dispatchEvent("onOpen")),this._detailsView&&!S.maximize&&(this._detailsView.container.style.width=e+"px",setTimeout(function(){t._detailsView&&(t._detailsView.container.style.width="")},this._durationOfDetailOpening),this._detailsView._resizeHandler()),this._parent.apply(this,arguments)},isOpen:function(){return this._isOpen},id:function(){return"DetailsPanelView"},init:function(t){var s=e.clone(t||{},!1);s.scopesTypes=t.collection.scopesTypes(),s.scopesTypesForSearch=t.collection.scopesTypesForSearch(),s.contentsTypes=t.collection.contentsTypes(),s.contentsTypesForSearch=t.collection.contentsTypesForSearch(),s.projectTypes=t.collection.projectTypes(),s.projectTypesForSearch=t.collection.projectTypesForSearch(),s.deliverablesTypes=t.collection.deliverablesTypes(),s.deliverablesTypesForSearch=t.collection.deliverablesTypesForSearch(),delete s.collection,this._parent(s)},setup:function(t){var s=e.clone(t||{},!1);if(this.erTaskConfig=n.config(),this.projectConfig=n.projectConfig(),this.erTaskConfig.options=n.options,this.scopesTypes=t&&t.scopesTypes?t.scopesTypes.split(","):[],this.projectTypes=t&&t.projectTypes?t.projectTypes.split(","):[],this.contentsTypes=t&&t.contentsTypes?t.contentsTypes.split(","):[],this._updateConfigValues(t),e.Utils.Client.Platform.ios||e.Utils.Client.Platform.android)for(var i=this.erTaskConfig.length,o=0;o<i;o++){var l=this.erTaskConfig[o];switch(l.type){case"object":case"person":l.appendTo=".collaborative-tasks"}}return s.buttons=this._getButtonConfig(),s.detailsViewParameters={DocumentManagement:a},this._parent(s),this._detailsView.setConfig(this.getConfig()),this._callbackForVisibleTasks=t.callbackForVisibleTasks,t},_updateConfigValues:function(t){this.erTaskConfig.detect(function(e){return"state"===e.name}).values=t.stateValues;var s=this.erTaskConfig.detect(function(e){return"scopes"===e.name});s.dropTypes={"3dspace":t.scopesTypes?t.scopesTypes.split(","):[]},s.searchSourceTypes={"3dspace":t.scopesTypesForSearch?t.scopesTypesForSearch.split(","):[]};var i=this.erTaskConfig.detect(function(e){return"DPMProject"===e.name});i.dropTypes={"3dspace":t.projectTypes?t.projectTypes.split(","):[]},i.searchSourceTypes={"3dspace":t.projectTypes?t.projectTypes.split(","):[]};var a={dropTypes:{"3dspace":t.deliverablesTypes?t.deliverablesTypes.split(","):[]},searchSourceTypes:{"3dspace":t.deliverablesTypesForSearch?t.deliverablesTypesForSearch.split(","):[]}},o=this.erTaskConfig.detect(function(e){return"deliverables"===e.name});-1!==o.searchSource.indexOf("drive")&&(a.dropTypes.drive=["DriveFile"],a.searchSourceTypes.drive=["DriveFile"]),e.merge(o,a),this.projectConfig.detect(function(e){return"taskRequirement"===e.name}).values=t.taskRequirementValues},_emptyMenu:function(){this._menu&&(this._menu.destroy(),delete this._menu)},_drawMenu:function(){var e=this.getElement(".panel-overflow");e.empty(),e&&(this._menu=new o(this._panelActionsMenu).inject(e),this._menu.elements.container.setStyle("min-width","")),this._adjustHeader()},cloneModelForDetailDisplayView:function(){if(this.model){var e=this.CloneClass;this.model instanceof d?e=u:e||(e=l);var t=new e(this.model,n.options);return t.scopesTypes=this.scopesTypes,t.projectTypes=this.projectTypes,t.contentsTypes=this.contentsTypes,t}},render:function(){return this.model?(this._parent.apply(this,arguments),this._updateActionButtonsState(),this.toggleLaunchControl(),this):this},_adjustHeader:function(){var t=this.getContent(),s=this.getElement(".panel-tabs"),i=this.getElement(".panel-actions");if(t&&s&&i){t.removeClassName("overflow");var a=e.is(this._width)?this._width:t.offsetWidth;i.offsetWidth>=a-s.offsetWidth?t.addClassName("overflow"):t.removeClassName("overflow")}},toggleLaunchControl:function(){var e=this.getElement("#openProjectItem");if(e){var t=this.model.get("DPMProject");t&&t.length?e.toggleClassName("disabled",!1):e.toggleClassName("disabled",!0)}},getStates:function(){var e=[];return e.push({actualValue:g.STATE_OPEN,displayValue:v("emxCollaborativeTasks.Label.ToDo")}),e.push({actualValue:g.STATE_IN_PROGRESS,displayValue:v("emxCollaborativeTasks.Label.InProgress")}),e.push({actualValue:g.STATE_DONE,displayValue:v("emxCollaborativeTasks.Label.Done")}),e},getDPMGateMilestoneStates:function(){return[{actualValue:"Create",displayValue:v("emxCollaborativeTasks.Label.Preliminary")},{actualValue:"Review",displayValue:v("emxCollaborativeTasks.Label.InReview")},{actualValue:"Complete",displayValue:v("emxCollaborativeTasks.Label.Completed")}]},redrawPanel:function(){this.resetModel(this.model||this._detailsView.model,{},!0)},resetModel:function(e,t){var s=this;this._parent(e,t);var i=function(){s._panelActionsMenu=s.createMenuButtons(),s.updateConfigAndRender()};this.listenTo(this.model,"onChange:hasProject",i),this.listenTo(this.model,"onChange:DPMProject",i),this.listenTo(this.model,"onChange:PALId",this.updateConfigAndRender),this.listenTo(this.model,"onChange:subscribed",this._updateActionButtonsState),this.listenTo(this.model,"onChange:routeOwner",this.updateConfigAndRender);var a={"onChange:dsxplan:hasAssignee":this._updateActionButtonsState,onChange:function(e,t){t&&"assignees"===t.relationshipChanged&&s._updateActionButtonsState()},onDeleteAccessChanged:this._updateStateOfDeleteButton,onDestroy:this.close};this.listenTo(this.model,a),this.listenTo(this.model,"onModifyAccessChanged",this._updateStateOfAssignToSelfButton),this.listenTo(this.model,"onModifyAccessChanged",this._updateCompleteButton),this.listenTo(this.model,"onModifyAccessChanged",this._updateApprovalActionsButton),this.container.getElement(".panel-actions").empty(),this.buttonConfig=this._getButtonConfig(),this._initButtons(this.buttonConfig),this._updateActionButtonsState(),this.listenTo(this.model,"onChange:"+g.STATE_ATTR,this.redrawPanel),this.listenTo(this.model,"onChange:routeTaskApprovalAction",this._updateApprovalActionsButton),this.listenTo(this.model,"onChange:routeTaskAction",this.redrawPanel),this.listenTo(this._detailsView.model,"onChange:"+g.STATE_ATTR,this.onFieldValueChange),this.listenTo(this.model,"onChange:"+g.PARENT_HAS_SWYM_COMMUNITY,this.updateConfigAndRender),this.listenTo(this.model,"onChange:"+g.PARENT_HAS_LEAN_BOARD,this.updateConfigAndRender),this.listenTo(this.model,"onChange:"+g.PARENT_ATTR,this.updateConfigAndRender),this.listenTo(this.model,"onChange:"+g.TASK_PARENT_ATTR,this.updateConfigAndRender),this.listenTo(this.model,"onChange:"+g.RESTRICT_ASSIGNEE_ATTR,this.updateConfigAndRender)},updateConfigAndRender:function(){this._detailsView.setConfig(this.getConfig()),this.render()},getOriginalConfig:function(){var t=this.erTaskConfig;if(!this.model)return t;this.model.isRouteTask()?(t=this._getRouteTaskConfig()).options=n.options:this.model instanceof d?((t=this._getRDFTaskConfig(this._detailsView.model&&this._detailsView.model.model===this.model?this._detailsView.model:this.model)).options=m.options,this.showOrHideBookmarkForRepositoryField(t)):(t=this._getERTaskConfig(this.model)).options=n.options;var s=e.clone(t,!0);s.options=t.options,(this.model.isProjectTask()||"TRUE"===this.model.get("hasProject"))&&this.treatProjectTaskAttributes(s);var i=this.model.getCustomFields();return i&&this.treatCustomFields(s,i),this.config=s,s},treatProjectTaskAttributes:function(t){for(var s=t.length,i=3,a=-1,o=0;o<s;o++){if("DPMProject"===t[o].name){var n=e.clone(t[o]);delete n.readWrite,t[o]=n,i--}else if("dueDate"===t[o].name)a=o,i--;else if("estimatedDuration"===t[o].name){if("Review"===this.model.get("state")){var l=e.clone(t[o]);delete l.readWrite,t[o]=l}i--}if(0===i)break}a>-1&&t.splice(a,1);var r=this.projectConfig,c=this.model.get("dsxplan:jsType")||this.model.get("type");if(this.model.isProjectTask()){var d=this.model.get("state"),u=r.find(function(e){return"needsReview"===e.name});u&&(u.readWrite="Review"!==d&&"Complete"!==d)}var h=!1;if((f.isMilestone(c)||f.isGate(c))&&(h=!0,r=r.filter(e=>!["needsReview"].includes(e.name))),r&&r.length>0)for(var p=0,m=r.length;p<m;p++)if(h&&r[p].name===g.PERCENT_COMPLETE){var C=e.clone(r[p],!1);C.step=100,t.splice(r[p].insertIndex,0,C)}else t.splice(r[p].insertIndex,0,r[p])},getConfig:function(e){var t=this.getOriginalConfig(e);return this._parent(t)},_updateActionButtonsState:function(){delete this._panelActionsMenu,this._panelActionsMenu=this.createMenuButtons();var t=this.getElement("#subscribeToItem"),s=this.getElement("#openProjectItem"),i=this.getElement("#duplicateButton");if(this._updateStateOfAssignToSelfButton(),this._updateCompleteButton(),this._updateApprovalActionsButton(),this._updateStateOfDeleteButton(),this._updateStateOfDuplicateButton(),i){var a=e.is(this.model.getParent,"function")&&this.model.getParent();(this.model.isProjectTask()||this.model.isRouteTask()||!a||a&&a instanceof c)&&i.remove()}if(s&&(this.isModelAProjectTask()?s.toggleClassName("disabled",!1):s.remove()),t){t.toggleClassName("active",this.subscribedToItem());var o=this.getElement("#subscribeToItem");this.subscribedToItem()?o.set("title",v("emxCollaborativeTasks.Command.UnsubscribeFromNotifications")):o.set("title",v("emxCollaborativeTasks.Command.SubscribeToNotifications")),this.model.subscriptionsEnabled()||t.remove()}this._emptyMenu(),this._drawMenu()},subscribedToItem:function(){return"TRUE"===this.model.get("subscribed")},destroy:function(){this._emptyMenu(),delete this._panelActionsMenu,delete this.erTaskConfig,delete this.config,delete this.projectConfig,delete this.scopesTypes,delete this.projectTypes,delete this.contentsTypes,this._unlockTimeout&&clearTimeout(this._unlockTimeout),delete this._unlockTimeout,delete this._bookmarkHandler,this._parent.apply(this,arguments)},_lockWidths:function(){var e=this.container.getSize().width,t=this.container.getElement(".body");t&&(t.setStyle("width",e),this.container.getElement(".footer").setStyle("width",e),this.container.getElement(".header").setStyle("width",e),this._unlockTimeout&&clearTimeout(this._unlockTimeout),this._unlockTimeout=setTimeout(this._unlockWidths.bind(this),this._durationOfDetailOpening))},_unlockWidths:function(){if(this.container){var e=this.container.getElement(".body");e&&(e.setStyle("width",""),this.container.getElement(".footer").setStyle("width",""),this.container.getElement(".header").setStyle("width",""))}},_getButtonConfig:function(){return this._approvalActionsControl=this.createApprovalActionsControl({fonticon:"thumbs-up"}),[{id:"openProjectItem",title:v("emxCollaborativeTasks.Command.OpenProjectItem"),fonticon:"logout"},{id:"subscribeToItem",title:v("emxCollaborativeTasks.Command.SubscribeToNotifications"),fonticon:"rss"},{id:"approvalActionsItem",title:v("emxCollaborativeTasks.Command.ApprovalActions"),content:this._approvalActionsControl.getContent()},{id:"completeItem",title:v("emxCollaborativeTasks.Command.Complete"),fonticon:"check"},this.getBookmarkMenuConfig(),{id:"duplicateButton",title:v("E6WCommonUI.Label.Duplicate"),fonticon:"duplicate"},{id:"deleteButton",title:v("emxCollaborativeTasks.Command.Delete"),fonticon:"trash"}]},_getRouteTaskConfig:function(){for(var t=h.config(this.model),s=this.model&&"No"!==this.model.get("needsReview"),i=this.options,a=t.length,o=0;o<a;o++){var n=t[o];"state"===n.name?n.values=s?i.routeTaskStateValues:i.routeTaskNoReviewStateValues:"routeTaskApprovalAction"===n.name?n.values=i.routeTaskApprovalActionValues:"routeTaskAction"===n.name&&(n.values=i.routeTaskActionValues)}if(e.Utils.Client.Platform.ios||e.Utils.Client.Platform.android)for(var l=0;l<a;l++){var r=t[l];switch(r.type){case"object":case"person":r.appendTo=".collaborative-tasks"}}return t},_getRDFTaskConfig:function(e){for(var t=m.config(e||this.model),s=t.length,i=0;i<s;i++){var a=t[i];a.name===g.STATE_ATTR?a.values=this.getStates():"dependencies"===a.name&&(a.getVisibleModels=this._callbackForVisibleTasks)}return t},_getERTaskConfig:function(t){var s=e.clone(this.erTaskConfig,!1);if(s.find(function(e){return e.name===g.COOWNERATTR}).readWrite=t.hasChangeSOVAccess(),!this.model.isProjectTask()){var i=s.findIndex(function(e){return"dependencies"===e.name});i>=0&&s.splice(i,1)}var a=t&&(t.get("dsxplan:jsType")||t.get("type"));return f.isMilestone(a)||f.isGate(a)?this._getDPMGateMilestoneConfig(s):s},_getDPMGateMilestoneConfig:function(t){for(var s=e.clone(t,!0),i=s.length,a=-1,o=0;o<i;o++){var n=s[o];"state"===n.name?n.values=this.getDPMGateMilestoneStates():"estimatedDurationInputValue"===n.name&&(a=o)}return a>-1&&s.splice(a,1),s},_updateApprovalActionsButton:function(){var e=this.getElement("#approvalActionsItem"),t=e.getElement(".fonticon"),s=this.model.get("state"),i=this.model.get("routeTaskAction"),a=this.model.get("routeTaskApprovalAction"),o=this._approvalActionsControl&&this._approvalActionsControl.buttons[1]&&this._approvalActionsControl.buttons[1].dropdown?this._approvalActionsControl.buttons[1].dropdown:void 0,n=this._menu&&this._menu.dropdown?this._menu.dropdown:void 0,l=this.model&&!this.approvalActionsItemAccess(this.model),r=this.model&&!this.model.isRouteTask();r||(r="Assign"!==s||"Approve"!==i),r?e.toggleClassName("hidden",!0):e.toggleClassName("hidden",!1),this.model&&!this.approvalActionsItemAccess()?e.toggleClassName("disabled",!0):e.toggleClassName("disabled",!1),e.toggleClassName("item-approve",!1),e.toggleClassName("item-reject",!1),e.toggleClassName("item-abstain",!1),t.toggleClassName("fonticon-thumbs-up",!1),t.toggleClassName("fonticon-thumbs-down",!1),t.toggleClassName("fonticon-ignore",!1),"Reject"===a?(e.toggleClassName("item-reject",!0),t.toggleClassName("fonticon-thumbs-down",!0)):"Abstain"===a?(e.toggleClassName("item-abstain",!0),t.toggleClassName("fonticon-ignore",!0)):(e.toggleClassName("item-approve",!0),t.toggleClassName("fonticon-thumbs-up",!0)),n&&(l?n.disableItem("approve"):n.enableItem("approve"),l?n.disableItem("reject"):n.enableItem("reject"),l?n.disableItem("abstain"):n.enableItem("abstain")),o&&(l?o.disableItem("approve"):o.enableItem("approve"),l?o.disableItem("reject"):o.enableItem("reject"),l?o.disableItem("abstain"):o.enableItem("abstain"))},_updateCompleteButton:function(){var e,t=this.getElement("#completeItem");if(this.model&&this.model.isRouteTask()&&"Assign"===this.model.get("state")&&"Approve"===this.model.get("routeTaskAction")?t.toggleClassName("hidden",!0):t.toggleClassName("hidden",!1),!this.model||this.completeItemAccess()||this.reOpenItemAccess()?t.toggleClassName("disabled",!1):t.toggleClassName("disabled",!0),this.reOpenItemAccess()){e=v("emxCollaborativeTasks.Command.ReOpen"),t.setAttribute("title",v("emxCollaborativeTasks.Command.ReOpen"));var s=t.getElement(".fonticon-check");s&&s.removeClassName("fonticon-check").addClassName("fonticon-reset")}else{e=v("emxCollaborativeTasks.Command.Complete"),t.setAttribute("title",v("emxCollaborativeTasks.Command.Complete"));var i=t.getElement(".fonticon-reset");i&&i.removeClassName("fonticon-reset").addClassName("fonticon-check")}f.createTooltip(t,e)}});return S.implement(r),S.maximize=!0,S.CLASS_NAME=b,S.ACTIVE_CLASS_NAME=k,S.DETAILSPANEL_MAX_WIDTH=400,S});var groupViewerModuleName="DS/i3DXRDFGroupViewer/js/GroupViewer";define("DS/CollaborativeTasks/Views/CollaborativeTasksView",["UWA/Core","UWA/Event","UWA/Controls/Drag","DS/UIKIT/Input/Button","DS/UIKIT/SuperModal","DS/UIKIT/DropdownMenu","DS/UIKIT/Tooltip","DS/WAFData/WAFData","DS/Handlebars/Handlebars4","DS/ENO6WPlugins/jQuery_3.3.1","DS/Foundation/WidgetUwaUtils","DS/Foundation/WidgetAPIs","DS/E6WCommonUI/Views/FoundationBaseView","DS/E6WCommonUI/Views/DetailsDisplayView","DS/Foundation2/FoundationV2Data","DS/DocumentManagement/DocumentManagement","DS/CollaborativeTasks/Collections/MergingSplitCollection","DS/E6WCommonUI/Views/E6WHandlebarsHelpers","DS/E6WCommonUI/UIHelper","DS/Foundation2/TaggerAggregator","DS/CollaborativeTasks/Views/ColumnView","DS/CollaborativeTasks/Views/CardView","DS/CollaborativeTasks/Views/DetailsPanel","DS/CollaborativeTasks/Views/CollaborativeTasksUtils","DS/RDFFoundation/RDFUtils","DS/E6WCommonApps/Models/RDFTaskModel","DS/E6WCommonApps/XTaskScope","DS/XTaskApp/Models/ScopeModelContainer","DS/RDFFoundation/SecurityContextUtils","DS/RDFFoundation/FederatedSearchUtil","DS/RDFFoundation/Collections/CollectionTaggerHelper","DS/CollaborativeTasks/Views/TasksTableView","DS/E6WCommonUI/PlatformManager","DS/PlatformAPI/PlatformAPI","DS/ENXESignature/Views/Dialogs/ESignatureAuthDialog","DS/Windows/ImmersiveFrame","DS/E6WCommonApps/LiveUpdateUtils","DS/E6WCommonApps/TaskUtils","DS/E6WCommonApps/TaggerChipColorMixin","DS/E6WCommonApps/Models/E6WCommonAppsConstants",groupViewerModuleName,"i18n!DS/E6WCommonUI/assets/nls/E6WCommonUINLS","i18n!DS/E6WCommonApps/assets/nls/E6WCommonAppsNLS","text!DS/CollaborativeTasks/assets/templates/main.html.handlebars","css!DS/CollaborativeTasks/CollaborativeTasks"],function(e,t,s,i,a,o,n,l,r,c,d,u,h,p,m,g,C,T,f,v,b,k,S,D,_,w,A,y,E,I,V,F,R,M,x,N,P,L,O,U,W,j,B,H){"use strict";f.fixDisplayMessageMethod(),_.typeDictionary.typeMap=_.typeDictionary.typeMap||{},e.merge(_.typeDictionary,_.typeDictionary,{mapping:[{key:"dsplan:Task",type:w}],typeMap:{"dsplan:Task":w}});var G=U.DUE_DATE_CATEGORY,z=function(e){var t=m.getWidgetConstant.apply(this,arguments);return t===e&&(t=j.get(e)),t===e&&(t=B.get(e)),t};var Y=r.compile(H),q=A.FILTER_ALL,K=A.FILTER_OWNED,X=A.FILTER_ASSIGNED,$=A.FILTER_ASSIGNED_TO_GROUP,J="cards-small",Z="cards-large",Q="task-table",ee={"cards-small":"smallCards","cards-large":"largeCards","task-table":"taskTable"},te={taskTable:Q,smallCards:J,largeCards:Z},se={smallCards:"fonticon-view-small-tile ",largeCards:"fonticon-view-big-tile ",taskTable:"fonticon-view-list "},ie=h.extend({_uwaClassName:"CollaborativeTasksView",_minColWidth:256,_maxColWidth:800,_durationOfDetailClosure:300,className:"collaborative-tasks",name:"CollaborativeTasks.CollaborativeTasksView",scopeName:"",ColumnView:b,domEvents:{"keypress #addExpandedTaskText":"onKeyUpAddTask","click button.scroll-right":"scrollRight","click button.scroll-left":"scrollLeft","click #addTask":"onClickAddTaskButton","click #addAndOpenTask":"onClickAddAndOpenTaskButton","click #cancelCreateTask":"onClickCancelTaskButton","click #closeCreateTask":"onClickCancelTaskButton","click .add-actions .add-button button":"expandTaskInputField","drop #addTaskDropZone #addTaskText, div.toolbar.add-button":"handleDropCSV","dragenter #addTaskDropZone #addTaskText, div.toolbar.add-button":"handleDragEnter","dragover #addTaskDropZone #addTaskText, div.toolbar.add-button":"handleDragOver","dragleave #addTaskDropZone #addTaskText, div.toolbar.add-button":"handleDragLeave","dragend #addTaskDropZone #addTaskText, div.toolbar.add-button":"handleDragEnd",mousedown:"handleMouseDown","input #addExpandedTaskText":"onExpandedTaskTextInput"},init:function(t){const s=e.clone(t||{},!1);this._rdfCollection=s.rdfCollection,A.setCollection(this._rdfCollection),this._fetchCount=s.fetchCount||0,this._parent.apply(this,arguments)},disableCreateTask:function(){var e=this.getElement("#addTaskText")||widget.getElement("#addTaskText"),t=this.getElement("#addTaskButton")||widget.getElement("#addTaskButton"),s=this.getElement(".add-actions .add-button button")||widget.getElement(".add-actions .add-button button");e&&e.setAttribute("disabled",!0),s&&s.setAttribute("disabled",!0),t&&t.setAttribute("disabled",!0)},enableCreateTask:function(){var e=this.getElement("#addTaskText")||widget.getElement("#addTaskText"),t=this.getElement("#addTaskButton")||widget.getElement("#addTaskButton"),s=this.getElement(".add-actions .add-button button")||widget.getElement(".add-actions .add-button button");e&&e.removeAttribute("disabled"),s&&s.removeAttribute("disabled"),t&&t.removeAttribute("disabled")},_updateTaskDivDisplayBasedOnTaskName:function(e){var t=(this.getElement("#addExpandedTaskDiv")||widget.getElement("#addExpandedTaskDiv")).getElement(".form-group"),s=function(e){var t=!(!e||!e.length)&&m.containsBadChars(e),s=A.isScopeRDF()||d.getContext()===u.TSK_PRIVATE_SPACE;return t&&!s}(e),i=!e||0===e.length;t.toggleClassName("has-error",s),(this.getElement("#addTask")||widget.getElement("#addTask")).disabled=i||s,(this.getElement("#addAndOpenTask")||widget.getElement("#addAndOpenTask")).disabled=i||s,t.getElement(".form-control-error-text").setText(s?z("emxCollaborativeTasks.Validate.TitleError"):"")},onExpandedTaskTextInput:function(){var e=this.getElement("#addExpandedTaskText")||widget.getElement("#addExpandedTaskText"),t=e&&e.value&&e.value.trim();this._updateTaskDivDisplayBasedOnTaskName(t),this.hideOrShowCloseAndCancelButtons(t)},hideOrShowCloseAndCancelButtons:function(e){(this.getElement("#addExpandedTaskDiv")||widget.getElement("#addExpandedTaskDiv")).toggleClassName("showCancelHideClose",Boolean(e))},id:function(){var e="no id found";return this.collection&&this.collection.extid?e=this.collection.extid:this.options&&this.options.rdfCollection&&this.options.rdfCollection.extid&&(e=this.options.rdfCollection.extid),e},destroy:function(){this.scopeIdView&&this.scopeIdView.destroy(),delete this.scopeIdView,this._parent(),this.$dsTaskManagement=null,delete this._columnStyle,delete this._columnsCarrier,this._taskTools&&this._taskTools.destroy(),delete this._taskTools,this._tasksFilterMenuButton&&this._tasksFilterMenuButton.destroy(),delete this._tasksFilterMenuButton,this._smallLargeCardTooltip&&this._smallLargeCardTooltip.destroy(),delete this._smallLargeCardTooltip,this._tasksFilterDropDownMenu&&this._tasksFilterDropDownMenu.destroy(),delete this._tasksFilterDropDownMenu,this._displayMenuButton&&this._displayMenuButton.destroy(),delete this._displayMenuButton,this._viewByTooltip&&this._viewByTooltip.destroy(),delete this._viewByTooltip,delete this._displayOptionsDropdown,delete this._scopeIdContainer,this.scopeIdView&&(this.stopListening(this.scopeIdView),this.scopeIdView.destroy(),delete this.scopeIdView),delete this._scopeListenedTo,this.modal&&this.modal.destroy(),delete this.modal,this.scopeIdView&&this.scopeIdView.destroy(),delete this.scopeIdView},cleanUpChildren:function(){this._circleContainer&&this._circleContainer.empty(!0),this._parent(),delete this._detailPanel,delete this._selectedView,delete this._selectedChildView,this._columnViews=[]},selectById:function(e){var t=this,s=this.getColumnAndCardIdxFromId(e),i=s[0],a=s[1];if(i&&-1!==a){b._cardHeight||i._computeCardHeight();var o=b._cardHeight*a;i._scroller.scrollTo(0,o),setTimeout(function(){var a;i&&i._childrenViews||(s=this.getColumnAndCardIdxFromId(e),i=s[0]);for(var o=0;o<i._childrenViews.length;o++){var n=i._childrenViews[o];if(n.model.id===e){a=n;break}}a&&(t.select(i,a),t._detailPanel.selectTab(widget.getValue("propertyPanelTab"))),widget.deleteValue("propertyPanelTab")}.bind(this),0)}},getColumnAndCardIdxFromId:function(e){for(var t,s=-1,i=this._childrenViews.length,a=0;a<i;a++){var o=(t=this._childrenViews[a]).collection;if(o){var n=o.get(e);if(n){s=o.indexOf(n);break}}}return[t,s]},onTaskCardClicked:function(e,t){t===this._selectedView?this.unselect(this._selectedChildView,this._selectedView):(this.select(e,t),t.model.markDeliverablesOn3DNavigate())},select:function(e,t){var s=this;function i(){s._selectedView&&s._selectedView.onUnselect(),t.onSelect(),s._selectedChildView=e,s._selectedView=t,s.openDetailPanel(s._childrenViews.indexOf(e)+1)}if(this._selectedView){var a=!this._selectedChildView||this._selectedChildView===e||S.maximize;this._detailPanel.cancel({keepPanelOpen:a,onCancel:function(){s._durationOfDetailClosure&&!a?setTimeout(i,s._durationOfDetailClosure):i(),s.handleTagCollect(t)}})}else i(),this.handleTagCollect(t)},openDetailPanel:function(t){var s=f.isWidgetNarrow()?this._selectedChildView.container.clientWidth:S.DETAILSPANEL_MAX_WIDTH;if(this._detailPanel.open(s),this._detailPanel.resetModel(this._selectedView.model,{force:!0},this._selectedView),!S.maximize){this._detailPanel.isOpen()||e.createElement("li").inject(this._circleContainer);var i=10*t+1;this.onResize(),this._detailPanel.container.setAttributes({style:"order:"+i+"; -webkit-order:"+i+"; -ms-order:"+i+";"}),t-this.getLeftColumnIndex()===this._nbColumnsShown?this.scrollRight():this._updateScrollButtonsAndDots()}},unselect:function(e,t,s){var i=this;t===this._selectedView&&e===this._selectedChildView&&this._detailPanel.cancel({onCancel:function(){i.handleTagCollect(),s&&s.onCancel&&s.onCancel()},onAbortCancel:function(){i.scopeModelContainer.getScope()&&(A.removeScopeData(),i.scopeModelContainer.removeScopeInternal(),i.onReset())}})},cancelCurrentDetailsPanel:function(e){this._selectedView?this.unselect(this._selectedChildView,this._selectedView,e):e&&e.onCancel&&e.onCancel()},handleTagCollect:function(e){V.handleFocusOnSubjects(this.collection.getTNProxy(),e&&e.model)},resetChildViews:function(){var t=this;this.cleanUpChildren();var s=this.collection.allValues();this._circleContainer||(this._circleContainer=e.createElement("ul")),s&&s.forEach(this.createColumnView,this);this._detailPanel=new S({stateValues:this.collection.allStates(),collection:this.collection,deliverablesTypes:this.collection.deliverablesTypes(),deliverablesTypesForSearch:this.collection.deliverablesTypesForSearch(),taskRequirementValues:this.collection.allTaskRequirements(),routeTaskActionValues:this.collection.allRouteTaskActions(),routeTaskStateValues:this.collection.allRouteTaskStates(),routeTaskNoReviewStateValues:this.collection.allRouteTaskNoReviewStates(),routeTaskApprovalActionValues:this.collection.allRouteTaskApprovalActions(),alertMessageContainer:this._alertContainer||this.container,context:d.getContext(),callbackForVisibleTasks:function(){return t.filterModelsWithSameParentWorkScopeAsSelectedTask(t.getVisibleRDFModels())}}),this.listenTo(this._detailPanel,"onClose",this.onCloseDetail),this.addChildView(this._detailPanel)},getColumnViewCollection:function(e){var t=this.collection.tasksWithAttrValueCollection(e);if(this._rdfCollection){var s=this._rdfCollection.tasksWithAttrValueCollection(e),i=new C;i.addSubCollection(t),i.addSubCollection(s),t=i}return t},unselectTaskForDestruction:function(e){this._selectedView===e&&this.unselect(this._selectedChildView,this._selectedView)},createColumnView:function(t,s){var i=new this.ColumnView({parentView:this,collection:this.getColumnViewCollection(t),$dsTaskManagement:this.$dsTaskManagement,stateValues:this.collection.allStates(),attrDisplayValue:t.displayValue,attrValue:t.actualValue});this._columnViews.push(i);var a=s+1+"0";return i.container.setAttributes({style:"order:"+a+"; -webkit-order:"+a+"; -ms-order:"+a+";"}),this.addChildView(i),this.listenTo(i,"onTaskCardClicked",this.onTaskCardClicked.bind(this,i)),this.listenTo(i,"onTaskDestroyed",this.unselectTaskForDestruction.bind(this)),e.createElement("li").inject(this._circleContainer),i},onCloseDetail:function(){this._selectedView&&"function"==typeof this._selectedView.onUnselect&&this._selectedView.onUnselect();var e=this._selectedChildView;if(this._selectedChildView=null,this._selectedView=null,S.maximize)this._updateScrollButtonsAndDots();else{if(this.onResize(),this._maxLeftIndex()<this.getLeftColumnIndex())this.scrollLeft();else{var t=this.getLeftColumnIndex();--t>=0&&t<this._childrenViews.length&&e===this._childrenViews[t]&&this.scrollLeft()}this._circleContainer.getElements("li").pop().remove(),this._updateScrollButtonsAndDots()}this.handleTagCollect()},filterTasks:function(e){var t=A.getFilter(),s=e.value;s!==t&&(A.setFilter(s),enoviaServer.preferences.currentTaskFilter=s,this.setTitleDefaultValue(),this._drawTaskTools(),this.onFilter())},onFilter:function(){this.onReset()},switchView:function(e,t){if(e!==this.currentViewName){this.currentViewName&&this.container.toggleClassName("tasks-"+this.currentViewName,!1),this.container.toggleClassName("tasks-"+e,!0),this.currentViewName=e;this.collection.setAttrToSplitBy(this.currentViewName,!1),this._rdfCollection&&this._rdfCollection.setAttrToSplitBy(this.currentViewName,!1),t||this.colChanged(),widget.setValue("currentView",e),this.onResize()}this._drawTaskTools()},colReset:function(){},colChanged:function(){this.resetChildViews(),this.onResize(),this.renderColumns(),this.dispatchEvent("afterColChanged"),this.updateTitle()},setScopeNameLabels:function(){if(this.container.isInjected()){var e,t=this.scopeModelContainer.getScope();t&&(e=t.get("name")),this.setTitleDefaultValue(),window.widget&&window.widget.getValue("appId")===U.APP_TSK&&this.setCredentialPreference(),this.modifyCreateTaskText(e),this.setScopePlaceholderText(t),this.setTaskForProjectLabel(t),this.collection&&this.listenToOnce(this.collection,"onSync",this.updateTitle),this._rdfCollection&&this.listenToOnce(this._rdfCollection,"onSync",this.updateTitle)}},setCredentialPreference:function(){window.widget&&widget.getValue("collabspace")!==u.TSK_PRIVATE_SPACE?widget.setValue("xPref_CREDENTIAL",R.getCollaborativeSpaceName()):window.widget&&widget.getValue("collabspace")===u.TSK_PRIVATE_SPACE&&widget.getValue("xPref_CREDENTIAL")&&widget.deleteValue("xPref_CREDENTIAL")},setTaskForProjectLabel:function(e){var t=this.getElement(".collab-space")||widget.getElement(".collab-space");if(A.isScopeRDF())t.hide();else{t.show();var s,i,a=t.getElement("span"),o=t.getElement("label"),n=!1,l=!1;if(o.show(),e){var r=e.get("collabSpace")||this.collection.collabSpace,c=e.get("type")||"",h=this.collection.projectTypes();(n=h&&-1!==h.split(",").indexOf(c))&&(l=r!==this.collection.collabSpace,s=(i=z("emxCollaborativeTasks.Label.CollaborativeSpace")+": ")+r,t.set("title",s),a.setText(r))}if(!n){var p=d.getContext(),m=d.getContextDisplayValue();i=z("emxCollaborativeTasks.Label.CollaborativeSpace")+": ",p&&p===u.TSK_PRIVATE_SPACE?(o.hide(),s=m):s=i+m,t.set("title",s),a.setText(m)}t.toggleClassName("alert-icon",l)}},setScopePlaceholderText:function(e){var t=this.scopeIdView.getElement("input[type=text]");if(t){var s=z("emxCollaborativeTasks.Label.ShowTasksForObject");s=s.replace("%NAME%",z("emxCollaborativeTasks.WidgetLabel.MyTasks")),e?t.removeAttribute("placeholder"):t.setAttribute("placeholder",s)}},setup:function(t){var s=e.clone(t||{},!1);this.SHOWTASKSFOR=z("emxCollaborativeTasks.Label.ShowTasksForObject"),this._parent.apply(this,arguments),this.$dsTaskManagement=c(this.container);var i=widget.getValue("currentView"),o=i||"stateForDisplay";this._columnStyleInnerHTML="",this._embeddedApp=s.embeddedApp,this._alertContainer=s.alertContainer,this._singleTaskId=s.singleTaskId,this._columnViews=[],this.switchView(o,!0),this.resetChildViews(),this._initializeScopeModelContainer(),this._initializeScopeIdView(),this._rdfCollection&&this.listenTo(this._rdfCollection,"onFailToFindScope",this.onFailToFindRDFScope),this.addListeners(),this.modal=new a({renderTo:this.container,okButtonText:z("emxCollaborativeTasks.Command.OK"),koButtonText:z("emxCollaborativeTasks.Command.Cancel")}),this.initTagger()},loadCommonInitializerLibrary:function(){var e=m.getAllFields(this.collection.data()).isLibraryInstalled,t=e&&e.label&&"TRUE"===e.label;this._detailPanel.createCommonLibrary(t)},addListeners:function(){this.collection.dictionaryLoaded?this.loadCommonInitializerLibrary():this.listenToOnce(this.collection,"onChange:dictionary",function(){this.loadCommonInitializerLibrary()}),this.listenTo(this.collection,"onChange:dictionary",function(){this.colChanged()}),this.listenTo(this.collection,"onReset",this.colReset),this.listenTo(this.collection,"onChange:lastReadFrom",this._setLastReadClass),this.listenTo(this.collection,"onChange:search",function(){this.colChanged(),this._updateTnProxyWithSearchFilter()}),widget&&this.listenTo(widget,"onViewChange",this.onViewChange),this.listenTo(this.collection,"onChange:collabSpace",this.render),this.listenTo(this,"onInjected",this.setScopeNameLabels),this.listenTo(this.scopeModelContainer,"onScopeDestroyed",this._onScopeDestroyed),this.eSignatureAuthAndRecordIdUpdate(),this.listenTo(P,"onUpdateNotification",function(e){A.isScopeRDF()&&A.getScopeId()===e["@id"]&&this.resetRDFCollectionForLiveUpdate()})},eSignatureAuthAndRecordIdUpdate:function(){this.listenTo(this.collection,"onValidationFailure",function(e,t){if(0!==t.fields.length&&"signature_required"===t.fields[0]){var s,i=M.getUser(),a=t.fields[1];"Reject"===a&&(a="Disapprove"),s={eSignPolicyReference:"ESignConfigRoute",Username:i&&i.login,x3dPlatformId:enoviaServer.tenant,ObjectActionType:a},x.init(s).subscribe("ESign-Authenticated",function(t){let s=t.ESignRecordId;e._signature=!0,e.eSignRecordId=s,e.save();let i=R.getServiceUrl("3DSpace",!0)+"/resources/v1/modeler/ESignRecord/"+s,a=e.csrf;var o=e.get("needsReview"),n={actionType:[{ObjectRevision:e.get("revision")},{MaturityChange:{before:"To Do",after:""!==o&&"Yes"===o?"Review":"Complete"}}]},r={csrf:a,data:[{dataelements:{ObjectActionTaken:JSON.stringify(n),ObjectReference:e.id,ObjectServiceID:"3DSpace",ObjectURI:"/resources/v1/modeler/tasks/"}}]};l.authenticatedRequest(i,{method:"PUT",type:"json",data:JSON.stringify(r),headers:{"Content-Type":"application/json"},onComplete:()=>{var e=z("emxCollaborativeTasks.Success.UpdatedEsignRecordId");f.displaySuccess(e)},onFailure:()=>{var e=z("emxCollaborativeTasks.Error.FailedToUpdateEsignRecordId");f.displayError(e)}}),delete e._signature})}})},resetRDFCollectionForLiveUpdate:function(){this.resetRDFCollection()},tagAddListener:function(e){var t=this._selectedView.model;V.setExplicitTagsData(t,{object:e.object,sixw:e.predicate})},tagRemoveListener:function(e){var t=this._selectedView.model;V.removeExplicitTagsData(t,{object:e.object,sixw:e.predicate})},_onScopeDestroyed:function(e){e||f.displayError(z("emxCollaborativeTasks.Error.FailedToRetrieveScope")),this.setTitleDefaultValue()},_initializeScopeIdView:function(){this.scopeIdView=new p({model:this.scopeModelContainer,id:function(){return"changeContextDiv"},DocumentManagement:g,context:d.getContext(),i18n:z})},resetRDFCollection:function(){if(!this._rdfCollection)return;var e=this;this.showLoadingMessage(!0);let t=this._rdfCollection&&this._rdfCollection.fetch({reset:!0,onComplete:function(){e.updateTitle.bind(e),e.hideLoadingMessage()},onFailure:function(){e.hideLoadingMessage()}});t&&t.noFetch&&setTimeout(this.hideLoadingMessage.bind(this),0)},_initializeScopeModelContainer:function(){var e=this;this.scopeModelContainer=new y({collection:this.collection}),this.scopeModelContainer.confirmRemoveScope=function(t){var s=this.get("scope");if(s){var i=s.get("name")||"",a=z("emxCollaborativeTasks.Command.RemoveContext").replace("%NAME%",i);e.modal.confirm(a,z("emxCollaborativeTasks.Command.RemoveContextTitle"),function(s){s&&(t(),e.setScopePlaceholderText())})}};var t=function(){this._scopeListenedTo&&this.stopListening(this._scopeListenedTo),this._scopeListenedTo=this.scopeModelContainer.getScope(),this._scopeListenedTo&&this.listenTo(this._scopeListenedTo,{onChange:this.setScopeNameLabels,onReset:this.setScopeNameLabels})};this.listenTo(this.scopeModelContainer,"onChange:scopeId",function(s){t.apply(this),this.updateCreateTaskUI(),s&&this.onReset(),setTimeout(function(){e.container&&e.container.getElement("#scopeIdContainer").removeClassName("active"),e.container&&e.container.getElement("ul").removeClassName("active")},0)}),t.apply(this)},_setLastReadClass:function(e,t){this.container.toggleClassName("readFromLocal","local"===t)},onViewChange:function(){this.container.click()},template:function(){var e=T.i18n;T.i18n=z;const t=this.collection.dataForRendering();t.isAgile=widget.getValue("agile");var s=Y(t);return T.i18n=e,s},updateCreateTaskUI:function(){this.setScopeNameLabels(),this.shouldDisableCreateTask()?this.disableCreateTask():this.enableCreateTask()},updateCredentialsBasedOnServiceData:function(){d.onEdit(widget)},render:function(t){return this._removeElementsFromDom(),this.container.empty(!0),this.container.setHTML(this.template()),e.Utils.Client.Platform.ios&&this.container.addClassName("ios"),this._setScopesTypesForSearch(),this._columnStyle=this.getElement("#respColumnWidth"),this._columnStyle.setHTML(this._columnStyleInnerHTML),this._addEventsOnAddTaskArea(),this.renderColumns(),this.showLoadingMessage(),this._drawTaskTools(),this._setLastReadClass(null,this.collection.lastReadFrom),this._scopeIdContainer=this.getElement("#scopeIdContainer")||widget.getElement("#scopeIdContainer"),this.scopeIdView.render().inject(this._scopeIdContainer),R.hasLoadedRolesData()?this.updateCredentialsBasedOnServiceData():(this.listenToOnce(R,"rolesDataLoaded",this._updateUIBasedOnRoles),this.listenToOnce(R,"serviceDataLoaded",this.updateCredentialsBasedOnServiceData)),this.updateCreateTaskUI(),this.dispatchEvent("afterRender"),this.container.addClassName(te[widget.getValue("selectedTaskView")||"smallCards"]),void 0!==this._fetchCount&&this._fetchCount>0&&this.showLoadingMessage(),t&&t.shouldRearrangeDOMElementsForToolbar&&this.rearrangeDOMElementsForToolbar(),this.checkAndInitializeTaskTableView(),this},_updateUIBasedOnRoles:function(){this.updateCreateTaskUI(),this._detailPanel._detailsView&&this._detailPanel.updateConfigAndRender()},injectTaskDetailsPanel:function(){this._detailPanel.inject(this.container)},showLoadingMessage:function(e){var t=this.getElement(".pagination");e&&this._fetchCount++,this._fetchCount>0&&t&&f.showLoadingMessage(t)},hideLoadingMessage:function(){if(this._fetchCount--,this._fetchCount<=0&&this.container){const e=this.getElement(".pagination");e&&f.hideLoadingMessage(e)}this._fetchCount<0&&(console.error("negative fetch count reset to 0"),this._fetchCount=0)},_addEventsOnAddTaskArea:function(){this.container.getElement("#addTaskText").addEvent("focus",this.onFocusAddExpandedTask.bind(this)),this.container.getElement("#addTaskButton").addEvent("click",this.onFocusAddExpandedTask.bind(this))},shouldDisableCreateTask:function(){var e=0===E.getUsersContentRepositories().length,t=A.isScopeRDF(),s=d.getContext()===u.TSK_PRIVATE_SPACE,i=!t&&e&&!s;return!i&&t&&(i=!R.isXPPAuthorized()),i},_removeElementsFromDom:function(){this._circleContainer.remove(),this.scopeIdView&&this.scopeIdView.remove();for(var e=this._childrenViews.length,t=0;t<e;t++){this._childrenViews[t].container.remove()}},_setScopesTypesForSearch:function(){var e=this,t=function(){var t=e.scopeModelContainer.config();t[0].activationCallback=function(t,s){e._scopeIdContainer.toggleClassName("active",s)},e.scopeIdView.setConfig(t),e.scopeIdView.render(),e.setScopeNameLabels()};this.collection.scopesTypesForSearch()||this.listenToOnce(this.collection,"onSync",function(){t()}),I.hasLoadedFederatedSearchSources()||this.listenToOnce(I.eventDispatcher,"onFederatedSearchSourcesLoaded",function(){t()}),t()},renderColumns:function(){var e=this.getElement(".columns-carrier");if(this._columnsCarrier=e,e){e.empty();for(var t=this._childrenViews.length,s=0;s<t;s++){var i=this._childrenViews[s];i instanceof S&&S.maximize?this.injectTaskDetailsPanel():i.container.inject(e),i.render()}}return this._circleContainer.inject(this.getElement(".pagination")),this.setLeftColumnIndex(0),this},_drawTaskTools:function(){this._taskFilterNLSValues=this._getTaskFilterViewNLSValues(),this._taskTools=this.getElement("#taskTools")||widget.getElement("#taskTools"),this._taskTools&&(this._taskTools.empty(),this._tasksFilterMenuButton&&this._tasksFilterMenuButton.destroy(),this._tasksFilterMenuButton=this._drawTaskFilterMenu().inject(this._taskTools),this._displayMenuButton&&this._displayMenuButton.destroy(),this._displayMenuButton=this._drawSmallLargeTaskCardsTableViewMenu().inject(this._taskTools))},_drawTaskFilterMenu:function(){var t=e.createElement("span",{id:"ViewMenu",class:"fonticon fonticon-list-filter"});this._viewByTooltip=new n({target:t,body:z("E6WCommonApps.Label.FilterBy"),position:"bottom"});var s=this.getDropDownItems();return this.setSelectView(s),this._tasksFilterDropDownMenu=new o({id:"ViewMenu",target:t,items:s,events:{onClick:this.onMenuClick.bind(this)}}),t},onMenuClick:function(e,t){t.className.indexOf("filter-")>-1?this.filterTasks(t):this.switchView(t.value)},setClassNameAndWidgetValue:function(e){[Q,J,Z].forEach(e=>{this.container.removeClassName(e)}),this.container.addClassName(e),widget.setValue("selectedTaskView",ee[e])},_drawSmallLargeTaskCardsTableViewMenu:function(){var t=this,s=e.createElement("span",{class:"fonticon "+se[widget.getValue("selectedTaskView")||"smallCards"]});this._smallLargeCardTooltip=new n({target:s,body:z("E6WCommonApps.Label.SwitchView"),position:"bottom"});var i=[{text:z("E6WCommonApps.Label.SmallTiles"),selected:"smallCards"===widget.getValue("selectedTaskView"),class:J,fonticon:"fonticon fonticon-view-small-tile "},{text:z("E6WCommonApps.Label.LargeTiles"),selected:"largeCards"===widget.getValue("selectedTaskView"),class:Z,fonticon:"fonticon fonticon-view-big-tile "},{text:z("E6WCommonApps.Tasks.Label.TaskTableView"),selected:"taskTable"===widget.getValue("selectedTaskView"),class:Q,fonticon:"fonticon fonticon-view-list "}];return this._displayOptionsDropdown=new o({target:s,items:i,events:{onClick:function(e,s){t.setClassNameAndWidgetValue(s.class),t._drawTaskTools(),t.checkAndInitializeTaskTableView()}}}),s},checkAndInitializeTaskTableView:function(){"taskTable"!==widget.getValue("selectedTaskView")||this.tasksTableView||this.initializeTaskTableView()},initializeTaskTableView:function(){var e=new F({tasksCollection:this.collection,rdfTasksCollection:this._rdfCollection,parentTaskView:this});e.listenTo(this,"scopeInitializedOnTaskView",function(t){e.scopeModelContainer=t,e.listenTo(t,"onChange:scopeId",e.setupLoadingMessages)}),this.tasksTableView=e;var t=new N;e.inject(t.getFreeZone()),t.inject(this.getElement("#taskTableViewDiv"))},_getTaskFilterViewNLSValues:function(){return{viewBy:z("E6WCommonApps.Label.FilterBy"),stateForDisplay:z("emxCollaborativeTasks.Command.View.stateForDisplay"),state:z("emxCollaborativeTasks.Command.View.state"),dueDateCategory:z("emxCollaborativeTasks.Command.View.dueDateCategory"),all:z("emxCollaborativeTasks.Command.Filter.all"),owned:z("emxCollaborativeTasks.Command.Filter.owned"),assigned:z("emxCollaborativeTasks.Command.Filter.assigned"),group:z("emxCollaborativeTasks.Command.Filter.assignedToMyGroups")}},getDropDownItems:function(){var e=this._taskFilterNLSValues,t=[],s="";return"taskTable"===widget.getValue("selectedTaskView")&&(s="disabled"),t.push({className:"drop-tool view-by-menu stateForDisplay-view "+s,text:e.stateForDisplay,value:"stateForDisplay"}),this._embeddedApp||t.push({className:"drop-tool view-by-menu state-view "+s,text:e.state,value:"state"}),t.push({className:"drop-tool view-by-menu dueDateCategory-view "+s,text:e.dueDateCategory,value:G}),t.push({className:"divider"}),t.push({className:"drop-tool task-filter filter-all",text:e.all,value:q}),t.push({className:"drop-tool task-filter filter-owned",text:e.owned,value:K}),t.push({className:"drop-tool task-filter filter-assigned",text:e.assigned,value:X}),R.enableUserGroup()&&t.push({className:"drop-tool task-filter filter-assigned-to-group",text:e.group,value:$}),t},setSelectView:function(e){var t=this,s=A.getFilter();return e.forEach(function(e){t.currentViewName===e.value||s===e.value?e.fonticon="fonticon fonticon-check":e.fonticon="fonticon"}),e},scrollRight:function(){var e=this.getLeftColumnIndex();this.setLeftColumnIndex(++e)},scrollLeft:function(){var e=this.getLeftColumnIndex();this.setLeftColumnIndex(--e)},_resetSingleTask:function(){R.hasAccess("3DSpace")&&this.collection.fetchTaskById(this._singleTaskId,{reset:!0}),this._rdfCollection.length&&this._rdfCollection.at(0).fetch()},onReset:function(){this.onViewChange(),this.scopeModelContainer._scope&&this.scopeModelContainer.validateRDFScopeWithServer(this.scopeModelContainer._scope),this._singleTaskId?this._resetSingleTask():this.resetCollections()},resetCollections:function(){var e=this,t=!this._embeddedApp&&R.hasAccess("3DSpace"),s={previousModels:this.collection.toArray()};if(t){this.showLoadingMessage(!0);let t=this.collection.fetch({server:!0,reset:!0,onComplete:function(){e.updateTitle(),e.hideLoadingMessage(),e.collection.dispatchEvent("onReset",[e.collection,s]);var t=z("emxCollaborativeTasks.Label.SuccessfulRefresh");f.displaySuccess(t)},onFailure:function(t,s){e.hideLoadingMessage();var i=D.getErrorMessageForInvalidCredentials(s);if(!i){var a=z("emxCollaborativeTasks.Label.FailedRefresh");i=s&&s.error||a}f.displayError(i)}});t&&t.noFetch&&setTimeout(this.hideLoadingMessage.bind(this),0)}this.resetRDFCollection()},onResize:function(){var e=this;if(this._childrenViews){var t=this.container.getSize();if(t.width&&t.height){var s=this._nbColumnsShown;!function(){var s=b.nbCardsBuffer,i=b._cardHeight||80;b.nbCardsBuffer=Math.floor(t.height/i)+2*b.nbCardsTopBuffer;for(var a=e._childrenViews.length-1;a>=0;a--){var o=e._childrenViews[a];o.collection&&o.collection.size()>Math.min(s,b.nbCardsBuffer)&&o.resizeBuffer()}}();var i=c(this.container),a=t.width/this._minColWidth,o=Math.floor(a);o=Math.max(1,o);var n,l="min-width:"+this._minColWidth+"px;",r=100/o,d=this._nbColumnsToDisplay(),u=r*d,h=100/d,p="",m="";a>d?(m=".columns-carrier { max-width: calc( "+d+" * "+this._maxColWidth+"px );} ",p=".column { width:"+h+"%;"+l+" max-width:"+this._maxColWidth+"px; } ",i.toggleClass("wide",!0),i.toggleClass("medium",!1),i.toggleClass("narrow",!1),this._nbColumnsShown=d):(i.toggleClass("wide",!1),o>1?(i.toggleClass("medium",!0),i.toggleClass("narrow",!1),l="min-width:0px;"):(i.toggleClass("medium",!1),i.toggleClass("narrow",!0),l="min-width:0px;"),p=".column { width:"+h+"%; max-width:none;"+l+"} ",m=".columns-carrier { width:"+u+"%;} ",this._nbColumnsShown=o||1),n=".collaborative-tasks-content .alert:not(.alert-fullwidth)  { width: calc("+100/this._nbColumnsShown+"% - 4px) }";var g=".column.details-tasks.off { transition: width "+this._durationOfDetailClosure/1e3+"s ease-in-out; }";this._columnStyleInnerHTML=g+p+m+n,this._columnStyle&&this._columnStyle.setHTML(this._columnStyleInnerHTML),s!==this._nbColumnsShown&&this.setLeftColumnIndex(this.getLeftColumnIndex())}}},_maxLeftIndex:function(){return this._nbColumnsToDisplay()-this._nbColumnsShown},_stopAutoScrolling:function(){this.autoScrolling=!1},_nbColumnsToDisplay:function(){var e=this._columnViews.length;return this._selectedChildView&&!S.maximize&&e++,e},setLeftColumnIndex:function(e){if(this._childrenViews){var t=e<0?0:e;if(this._selectedChildView&&!S.maximize){var s=this._childrenViews.indexOf(this._selectedChildView)-(this._nbColumnsShown-2);1===this._nbColumnsShown&&(s=this._childrenViews.indexOf(this._selectedChildView)+1),t=t<s?s:t}var i=this._maxLeftIndex();t=t>i?i:t,this._leftColumnIndex!==t&&(this.autoScrolling=!0,setTimeout(this._stopAutoScrolling.bind(this),510)),this._leftColumnIndex=t,this._columnsCarrier&&this._columnsCarrier.setStyle("left",-100*t/this._nbColumnsShown+"%"),this._updateScrollButtonsAndDots()}},_updateScrollButtonsAndDots:function(){var e=this.getLeftColumnIndex(),t=this.getElement(".scroll-left"),s=this.getElement(".scroll-right");t&&t.toggle(0!==e&&!this._selectedChildView),s&&s.toggle(e!==this._maxLeftIndex()&&!this._selectedChildView);var i=this._circleContainer.getElements("li");if(i)for(var a=i.length,o=0;o<a;o++){var n=i[o];o<e||o>=e+this._nbColumnsShown?n.removeClassName("in-view"):n.addClassName("in-view")}for(var l=this._nbColumnsToDisplay(),r=[],c=0;c<l;c++){var d=this._childrenViews[c];r.push(d),d===this._selectedChildView&&r.push(this._detailPanel)}for(var u=e+this._nbColumnsShown-1,h=0;h<l;h++){r[h].container.toggleClassName("right-most-column-shown",h===u)}},getLeftColumnIndex:function(){return this._leftColumnIndex||(this._leftColumnIndex=0),this._leftColumnIndex},expandTaskInputField:function(){var e=this.getElement("#addExpandedTaskDiv")||widget.getElement("#addExpandedTaskDiv");e.getElement(".form-group").toggleClassName("has-error",!1),e.toggleClassName("visible",!0),(this.getElement("#addExpandedTaskText")||widget.getElement("#addExpandedTaskText")).focus()},onFocusAddExpandedTask:function(){this.expandTaskInputField()},onKeyUpAddTask:function(e){"Enter"===e.key&&(e.preventDefault&&e.preventDefault(),this.processExpandedTaskInput(!1))},onClickAddTaskButton:function(){this.processExpandedTaskInput(!0)},onClickAddAndOpenTaskButton:function(){this.processExpandedTaskInput(!0,!0)},onClickCancelTaskButton:function(){this.removeExpandedTaskInput()},removeExpandedTaskInput:function(){(this.getElement("#addExpandedTaskDiv")||widget.getElement("#addExpandedTaskDiv")).toggleClassName("visible",!1);var e=this.getElement("#addExpandedTaskText")||widget.getElement("#addExpandedTaskText");e.blur(),e.value=""},processExpandedTaskInput:function(e,t){t&&this._drawTaskTools();var s,i=this.getElement("#addExpandedTaskText")||widget.getElement("#addExpandedTaskText"),a=i&&i.value&&i.value.trim();return i&&i.value&&i.value.trim()&&(s=this.createTaskWithString(i.value.trim(),t)),a||this.removeExpandedTaskInput(),s&&(e?this.removeExpandedTaskInput():(i.value="",i.focus(),this.hideOrShowCloseAndCancelButtons())),s},createTaskWithString:function(e,t){var s,i,a=this.collection.allDueDates()[1];if(t&&(i=function(){b.lastCardAdded&&b.lastCardAdded.onClickTaskCard()}),A.isScopeRDF()||!A.getScopeType()&&d.getContext()===u.TSK_PRIVATE_SPACE)s=this._rdfCollection.addNewTask(e,this.scopeModelContainer.getScope(),{onComplete:i});else{var o={title:e,state:this.collection.allStates()[0].actualValue,dueDateCategory:a};(s=this.collection.addNewTask(o)).completed=!0,s.save(null,{onFailure:function(){var e=z("emxCollaborativeTasks.Error.FailedToCreateTask"),t=arguments[2],s=t&&t.response;if(s&&400===s.statusCode)e=s.error&&s.error.length?z(f.sanitizeMessage(s.error)):e;else{var i=D.getErrorMessageForInvalidCredentials(s);i&&(e=i)}f.displayError(e)},onComplete:i,at:0,urlParam:"$fields=deliverablesInheritance"})}var n=this.getNewColumnIndex(0,1,s);return this.setLeftColumnIndex(n),s},getNewColumnIndex:function(e,t,s){var i=0;if("state"===this.currentViewName)i=e;else if(this.currentViewName===G){var a=s.get(G);i=t,this.collection.allDueDates().detect(function(e,t){var s=e.actualValue===a;return s&&(i=t),s})}return i},handleDropCSV:function(e){var s,i,a,o=this;return e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),t.getElement(e).getParent().removeClassName(U.DROP_CLASS_NAME),(s=e.dataTransfer.files)&&s.length&&(i=s[0],"undefined"!=typeof FileReader&&((a=new FileReader).onload=function(e){var t=e.target.result,s={onComplete:o.onCSVSuccess,onFailure:o.onCSVFailure};o.collection.importTasksFromCSV(t,s)},a.readAsText(i))),!1},onCSVSuccess:function(){var e=z("emxCollaborativeTasks.Label.ImportItemsDone");f.displayMessage({msg:e,msgType:"primary"})},onCSVFailure:function(){var e=z("emxCollaborativeTasks.Label.ImportItemsDone");f.displayPrimary(e)},handleDragOver:function(e){return e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="copy",t.getElement(e).getParent().addClassName(U.DROP_CLASS_NAME),!1},handleDragEnter:function(e){t.getElement(e).getParent().addClassName(U.DROP_CLASS_NAME)},handleDragLeave:function(e){t.getElement(e).getParent().removeClassName(U.DROP_CLASS_NAME)},handleDragEnd:function(e){t.getElement(e).getParent().removeClassName(U.DROP_CLASS_NAME)},clearAllDropZoneMasks:function(){for(var e=this.getElements("."+U.DROP_CLASS_NAME),t=e.length,s=0;s<t;s++)e[s].toggleClassName(U.DROP_CLASS_NAME,!1)},modifyCreateTaskText:function(e){var t=this.getElement("#addTaskText")||widget.getElement("#addTaskText"),s=z("emxCollaborativeTasks.Label.CreateTask");this.shouldDisableCreateTask()?t.placeholder=this.getDisabledPlaceholder():e?(s=z("emxCollaborativeTasks.Label.CreateTaskForContext"),t.placeholder=s.replace("%CONTEXT%",e),(this.getElement("#addExpandedTaskText")||widget.getElement("#addExpandedTaskText")).placeholder=s.replace("%CONTEXT%",e)):(t.placeholder=s,(this.getElement("#addExpandedTaskText")||widget.getElement("#addExpandedTaskText")).placeholder=s)},getDisabledPlaceholder:function(){var e,t=0===E.getUsersContentRepositories().length,s=A.isScopeRDF(),i=d.getContext()===u.TSK_PRIVATE_SPACE;return s||!t||i?s&&!R.hasRole("XPP")&&(e="emxCollaborativeTasks.Error.FailedToCreateTaskWithNoXPPLicense"):e="E6WCommonUI.Label.NoAccessToCollabSpace",z(e)},setTitleDefaultValue:function(){var e=z("emxCollaborativeTasks.Command.Filter.assigned"),t=widget.getValue("title"),s=z("emxCollaborativeTasks.Command.Filter."+A.getFilter())||t,i=s&&s.indexOf(":");-1!==i&&(s=s&&s.substring(i+1,i.length));var a=this.scopeModelContainer.getScope(),o=a&&a.get("name");s=o?o+":"+s:s||e,d&&d.getContextDisplayValue()&&(s=d.getContextDisplayValue()+" - "+s),widget.setValue("title",s)},handleMouseDown:function(e){var t=c(this.container).find("#addExpandedTaskDiv");t.hasClass("visible")&&0===t.has(c(e.target)).length?this.removeExpandedTaskInput():t.hasClass("visible")||this.onExpandedTaskTextInput();var s=c("#contextDropZone").find(".active"),i=c(e.target).closest("#changeContextDiv").length;s.length&&!i&&s.removeClass("active")},initScope:function(){var e=A.getScopeId();!this.scopeModelContainer.getScope()&&e?this.scopeModelContainer.add("scope",e,{scopeType:A.getScopeType(),isRDF:A.isScopeRDF(),dontCheckTypes:A.isScopeRDF(),initialLoad:!0}):A.isInvalidScope()?(A.setScopeToInvalid(!1),this.scopeModelContainer.removeScopeOnDelete()):this.scopeModelContainer.getScope()&&!e&&this.scopeModelContainer.removeScopeInternal(),this.dispatchEvent("scopeInitializedOnTaskView",[this.scopeModelContainer])},_getSingleTaskTitle:function(){var e;return 1===this.collection.length?e=this.collection.at(0).get("title"):this._rdfCollection&&1===this._rdfCollection.length&&(e=this._rdfCollection.at(0).get("title")),e},getTotalTasksCount:function(){var e=0;return this._columnViews.forEach(t=>{e+=t.collection.length}),e},updateTitle:function(){if(widget){var e;if(this._singleTaskId)e=this._getSingleTaskTitle();else if(e=widget.getValue("title"))if(e=e.trim(),this.collection&&this.collection._search)e+=" ("+this.getTotalTasksCount()+")";else{var t=this.collection.length;this._rdfCollection&&(t+=this._rdfCollection.length),e+=" ("+t+")"}e=e&&e.stripTags(),widget.getTitle()!==e&&widget.setTitle(e)}},getVisibleModels:function(){for(var e=[],t=this.getLeftColumnIndex(),s=t;s<t+this._nbColumnsShown;s++){var i=this._childrenViews[s];i.getVisibleModels&&(e=e.concat(i.getVisibleModels()))}return e},getVisibleRDFModels:function(){return this.getVisibleModels().filter(function(e){return e instanceof w})},filterModelsWithSameParentWorkScopeAsSelectedTask:function(e){var t=[],s=this._selectedView.model.getParent&&this._selectedView.model.getParent();return s&&(t=e.filter(function(e){var t=e.getParent&&e.getParent();return t&&t.id===s.id})),t},onFailToFindRDFScope:function(){f.displayError(z("emxCollaborativeTasks.Error.FailedToRetrieveScope"));var e=widget.getPreference("title");e&&widget.setValue("title",e.defaultValue),this.scopeModelContainer.setScope(null),A.removeUserScopeData(),this._rdfCollection.fetch({reset:!0,onComplete:this.updateTitle.bind(this)})},initTagger:function(){var t=this;try{var s=this.collection.getTNProxy({events:{addTagCreationListener:this.tagAddListener.bind(t),addTagDeletionListener:this.tagRemoveListener.bind(t)}});s instanceof v||(s.addEvent("foundation2TagsFetchComplete",function(e){t.updateLargeCardsWithTaggerData(e)}),s=new v(s),this.collection.setTNProxy(s)),this._rdfCollection&&V.addTaggerProxyColoringEvents(s.tnProxy,this._rdfCollection),V.addTaggerProxyColoringEvents(s.tnProxy,this.collection),this.setTaggerColorMap(s.tnProxy),this._rdfCollection&&s&&s.tnProxy&&(this.listenTo(s.tnProxy,"onFilterSubjectsChange",this._rdfCollection.filterCollection.bind(this._rdfCollection)),this.listenTo(this._rdfCollection,"onReset",function(){var t=Array.prototype.slice.call(arguments,0),s=e.clone(t[1]||{},!1);this.fetchNewTags(s)}),this.listenTo(this._rdfCollection,"onTaskCollectionFetchComplete",function(){this.fetchNewTags()}),this.listenTo(V.dispatcher,"refreshTagger",function(){V.updateTagsData.apply(this,arguments),this._setTagDataOnProxy("rdf")}))}catch(e){}},fetchNewTags:function(t){var s=this,i=e.clone(t||{},!1);if(!i.dontCallTagger){var a=i.rdfCollection||this._rdfCollection;a&&0===a.length?s._setTagDataOnProxy("rdf",t):a&&a.federatedTaggerServiceRequest({searchSource:[U.SERVICE_3DPLAN,"swym"],onComplete:function(){s._setTagDataOnProxy("rdf",i)},onFailure:function(){s._setTagDataOnProxy("rdf",i)}})}},_updateTnProxyWithSearchFilter:function(){!this.collection.getSearch()&&this.collection.originalCollection&&(this.collection.reset(this.collection.originalCollection._models,{dontRegisterChange:!0}),delete this.collection.originalCollection);var e=this.collection.getTNProxy();e.setSubjectsTags(V.getTaggerDataWithSearchFilter(this.collection),"foundation2"),e.setSubjectsTags(V.getTaggerDataWithSearchFilter(this._rdfCollection),"rdf")},_setTagDataOnProxy:function(e){var t=this._rdfCollection.getTaggerData();this.collection.getTNProxy().setSubjectsTags(t,e)},updateLargeCardsWithTaggerData:function(e){var t=this.collection&&this.collection.toArray();t&&t.forEach(t=>{var s=_.jsonURIToSparqlURI(t.id);if(s=t.getTagPrefix()+s,e[s]){var i=V.getExplicitTagsData(e[s]);t.set(V.EXPLICIT_TAGS_DATA,i)}})},isBeingTagFiltered:function(){return!!this.collection.tnProxy.tnProxy.getCurrentFilter().allfilters&&Object.keys(this.collection.tnProxy.tnProxy.getCurrentFilter().allfilters).length},getSuperModal:function(){return this.modal}});return ie.AUTO_SCROLL_TIMEOUT=510,ie.VIEW_VALUE_PRIORITY="priority",ie.implement(O),ie}),define("DS/CollaborativeTasks/CollaborativeTasksBootstrap",["UWA/Core","UWA/Utils","DS/Utilities/TouchUtils","DS/Foundation2/FoundationV2Data","DS/CollaborativeTasks/Collections/TasksCollection","DS/E6WCommonApps/Collections/RDFTasksCollection","DS/CollaborativeTasks/Models/RDFTasksWorkscopeModel","DS/RDFFoundation/RDFUtils","DS/RDFFoundation/MemberUtils","DS/CollaborativeTasks/Views/CollaborativeTasksView","DS/Foundation/WidgetAPIs","DS/Foundation/WidgetUwaUtils","DS/E6WCommonApps/SharedWidgetUwaUtils","DS/E6WCommonUI/Views/E6WHandlebarsHelpers","DS/E6WCommonApps/XTaskScope","DS/E6WCommonApps/LiveUpdateUtils","DS/DocumentManagement/DocumentManagement","DS/E6WCommonApps/SmartSchedulerUtils","DS/E6WCommonUI/UIHelper","DS/RDFFoundation/FederatedSearchUtil","DS/RDFFoundation/SecurityContextUtils","DS/E6WCommonApps/Models/RDFTaskModel","DS/E6WCommonUI/PlatformManager","DS/PlatformAPI/PlatformAPI","DS/E6WCommonUI/WidgetUtils","DS/E6WCommonApps/Views/ProgressBarPopupView","DS/E6WCommonApps/Models/E6WCommonAppsConstants","DS/E6WCommonApps/CommonAppsHandlebarsHelper","i18n!DS/E6WCommonApps/assets/nls/CollaborativeTasksNLS","DS/XTaskApp/Models/XTaskAppTypeDictionary","css!DS/E6WCommonApps/E6WCommonApps"],function(e,t,s,i,a,o,n,l,r,c,d,u,h,p,m,g,C,T,f,v,b,k,S,D,_,w,A,y,E){"use strict";new e.Class.Listener;var I,V=i.getWidgetConstant;i.getWidgetConstant=function(e){return V.apply(this,arguments)||E.get(e)};var F=function(){return i.getWidgetConstant.apply(this,arguments)},R=function(e){e.options&&e.options.length>1&&e.options.sort((e,t)=>e.label.localeCompare(t.label))};return p.i18n=F,y.registerPartials(),window.dataVersion=.3,(I={emailNotificationService:"/resources/v1/modeler/tasks/tasksPreference",defaultWindowedHeight:505,checkVisibilityAPI:function(){void 0!==I.document.hidden?(I._hidden="hidden",I._visibilityChange="visibilitychange"):void 0!==I.document.mozHidden?(I._hidden="mozHidden",I._visibilityChange="mozvisibilitychange"):void 0!==I.document.msHidden?(I._hidden="msHidden",I._visibilityChange="msvisibilitychange"):void 0!==I.document.webkitHidden&&(I._hidden="webkitHidden",I._visibilityChange="webkitvisibilitychange")},onPreferencesOpened:function(e){e&&e.fromTSK||(I._prefsWhenOpened=widget.getPreferences().reduce(function(e,t){return e[t.name]=t.value,e},{}))},onPreferencesClosed:function(){I.updateEmailPreference.apply(this,arguments),widget.dispatchEvent("onUpdateTitle",[widget.getTitle(),void 0]),I._prefsWhenOpened.collabspace!==widget.getValue("collabspace")&&(window.enoviaServer.space=widget.getValue("collabspace")),I._prefsWhenOpened.collabstorage!==widget.getValue("collabstorage")&&(S.setTenant(widget.getValue("collabstorage")),window.enoviaServer.storageUrl=S.getTenantServiceData()["3DSpace"],I.onStorageChange()),I._prefsWhenOpened.collabspace!==widget.getValue("collabspace")&&I.onSpaceChange()},_initEmailPreference:function(){if(S.isOnPremise()){var e={url:I.emailNotificationService,type:"GET",dataType:"json",callback:function(e){var t;e||(e={});var s=I.tasks.data();s&&i.__updateCsrf(s,e);try{widget.getValue("emailNotify")!==(t="true"===(t=e.data[0].dataelements.preference_AssignedTaskNotificationOn).toLowerCase())&&widget.setValue("emailNotify",t)}catch(e){}}};i.ajaxRequest(e)}},_doAutoRefresh:function(){!I.PENDINGFETCH&&I.tasks.length<=I.MAXFETCHCOUNT&&!this._getTaskIdToOpen()&&(I.PENDINGFETCH=!0,I.tasks.fetch({server:!0,partialRefresh:!0,noTag:!0,onComplete:function(){I.PENDINGFETCH=!1,I._setAutoRefreshTimeout()},onFailure:function(e,t){I.PENDINGFETCH=!1,I._handleInvalidScope(t,!I.tasks.dictionaryLoaded)||I._setAutoRefreshTimeout.bind(void 0,void 0)}}))},_setAutoRefreshTimeout:function(e){e?I._doAutoRefresh():I.REFRESHTIMEOUT&&(I.refreshTimeoutId=setTimeout(function(){I.document[I._hidden]||I._doAutoRefresh()},I.REFRESHTIMEOUT))},handleVisibilityChange:function(){I.document[I._hidden]?(clearTimeout(I.refreshTimeoutId),delete I.refreshTimeoutId):I.refreshTimeoutId||I._setAutoRefreshTimeout(!0)},onTenantChangedInPreference:function(e){b.loadSecurityContextsForTenant({tenant:e,callback:function(e){var t=u.securityContextsForSameOrganization(e),s=widget.getPreference("collabspace");s.options=[];var i=e[0].name;for(var a of e){var o=u.getSecurityContextName(t,a.displayName);s.options.push({label:o,value:a.name}),a.isDefault&&(i=a.name)}R(s),s.defaultValue=i,widget.addPreference(s),widget.dispatchEvent("onEdit",{fromTSK:!0})}})},addNewPreferences:function(){var e=function(){window.enoviaServer.preferences.showProjectTasks=widget.getValue("showProjectTasks")},t={name:"showProjectTasks",type:"boolean",label:"Show project tasks",defaultValue:"true",onChange:e},s=T.getCompletedTasksFilterPref(T.COMPLETED_TASK_FILTER_30_DAYS);widget.addPreference({name:"collabstorage",type:"list",label:"collabstorage"}),widget.addPreference({name:"collabspace",type:"list",label:"collabspace"}),widget.addPreference(s),widget.addPreference(t),widget.addEvent("onStorageChange",function(e,t){widget.isEdit&&I.onTenantChangedInPreference(t)}),S.isOnPremise()&&(widget.addPreference({name:"emailNotify",type:"boolean",label:"Email notifications",defaultValue:"defaultValue"}),widget.setValue("emailNotify","defaultValue")),e();var i=m.getFilter(),a=i||m.setFilter("all");enoviaServer.preferences.currentTaskFilter=a;var o=T.getCompletedTaskFilter();enoviaServer.preferences[T.COMPLETION_DATE_TASK_FILTER_ATTR]=o,widget.getValue("createSampleData")||(widget.setValue("createSampleData","true"),enoviaServer.preferences.createSampleData="true")},_has3DPlanAccess:function(){return S.hasAccess(A.SERVICE_3DPLAN)},showLoadingMessage:function(){I._fetchCount++,I.tasksView&&I.tasksView.showLoadingMessage(!0)},hideLoadingMessage:function(){I._fetchCount--,I.tasksView&&I.tasksView.hideLoadingMessage()},_loadRDFTasks:function(){if(I._getTaskIdToOpen()){if(I._taskIdToOpenIsRDF()){var e=new k({"@id":I._getTaskIdToOpen(),"dsxplan:jsType":"dsplan:Task"});I.showLoadingMessage(!0),e.fetch({onComplete:function(){I.hideLoadingMessage(),"dsplan:DeletedTask"===e.get("dsxplan:jsType")?f.displayInfo(F("emxCollaborativeTasks.Label.TaskDeleted")):(e.noFilter=!0,I.rdfTasks.add(e),I._selectTaskByIdOnLoad(e.id))},onFailure:function(){I.hideLoadingMessage(),I._onSingleTaskFetchFail()},mask:"dsplan:MVMask.Task.CollaborativeTask.Basic"})}}else{var t={fromCompletionDate:T.getCompletedTaskFilter()};I.showLoadingMessage(!0),I.rdfTasks.fetch({reset:!0,data:JSON.stringify([m.getFilter(),t]),onComplete:I.hideLoadingMessage,onFailure:I.hideLoadingMessage}).noFetch&&setTimeout(I.hideLoadingMessage,0)}l.subscribeToNotification(this.onNotification.bind(this)),this._notifQueue=[]},onNotification:g.onNotification,_getTaskIdToOpen:function(){return l.removeBracketLongURI(I._selectedTaskId)},_taskIdToOpenIsRDF:function(){return-1!==I._getTaskIdToOpen().indexOf(":")},initMSF:function(){require(["DS/MSFDocumentManagement/WidgetIntegration"],function(e){C.MSFDocumentClient=e,C.MSFDocumentClient.ConnectWidgetWithMSF()})},_initTasksCollection:function(){I.tasks=new a,I.tasks.addEvent("onAdd",I.onTitleChange),I.tasks.addEvent("onRemove",I.onTitleChange),I.tasks.addEvent("onReset",I.onTitleChange)},_initRDFTasksCollection:function(){o.RDFWorkscopeModel=n,this.rdfTasks=new o(void 0,{"@href":"/invoke/dsxplan:getTasks","@mask":"dsplan:MVMask.Task.CollaborativeTask.Basic",detailsMask:"dsplan:MVMask.Task.CollaborativeTasks.Complex"}),this.rdfTasks.addEvent("onAdd",this.onTitleChange),this.rdfTasks.addEvent("onRemove",this.onTitleChange),this.rdfTasks.addEvent("onReset",this.onTitleChange)},init:function(){I._fetchCount=0,f.setHeaderMetaTag(),s.setTouchMode(!0),e.extend(u,h),_.restoreWidgetViewModeBeforePreview(),window.enoviaServer||u.setupEnoviaServer({getUrl:()=>S.getServiceUrl("3DSpace",!0)}),window.enoviaServer.widgetId=widget.id,window.enoviaServer.widgetName=widget["6wWidgetName"];try{t.Client.Platform.windows&&this.initMSF()}catch(e){console.error(e)}widget.addEvents({onRefresh:I.onRefresh,onEdit:I.onPreferencesOpened,endEdit:I.onPreferencesClosed}),widget.useUIKitSelect=!0,this.addNewPreferences(),r.setContextUserUid(),u.onAfterLoad=Function.prototype,f.initializeAlert(window.document.body),this._initTasksCollection();var i=widget.getValue("collabstorage");this._processSelectedIds(),d.getCollaborativeStorages(function(e){u.processStorages(e,i,{additionalStorage:A.SERVICE_3DPLAN}),S.storePlatformServiceData(e),u.setStoragesPrefs(widget,e,i,"true"),m.initialize(),I.processStorageChange(i),I.document.addEventListener(I._visibilityChange,I.handleVisibilityChange,!1)}),I.scopes=I.tasks.getChildCollection("scopes");var a=top.document.getElementsByName("viewport");a&&a.length&&a[0].setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"),C.downloadDocument=function(t,s,i,a){var o=e.clone(a||{},!1),n=Array.prototype.slice.call(arguments,0);n[3]=o;var l=o.serviceId;return enoviaServer&&l&&(o.tenantUrl=enoviaServer[l]),this.constructor.prototype.downloadDocument.apply(this,n)},_.addDragDropListeners(),S.fetchRolesData(),D.subscribe("Collaborative Tasks.refresh",function(){I.refreshTimeoutId||I._setAutoRefreshTimeout(!0)})},onLoad:function(){I.init()},onRefresh:h.onRefresh,_updatePrefOnRefresh:function(){var e=widget.getValue("showProjectTasks");window.enoviaServer.preferences.showProjectTasks=e;var t=T.getCompletedTaskFilter();enoviaServer.preferences[T.COMPLETION_DATE_TASK_FILTER_ATTR]=t},onViewChange:function(){var e=widget.getView();e.previous&&e.previous.type!==e.type&&I.setWindowHeight()},setWindowHeight:function(){var e=widget.getViewportDimensions();I.tasksView&&I.tasksView.container.setStyle("height",e.height)},onTitleChange:function(){I.tasksView&&I.tasksView.updateTitle()},onEmailNotifyChange:function(e,t){I.userEnteredEmailValue=t},onCompletedTasksDisplayPrefChange:function(e,t){T.setCompletedTaskFilter(t)},updateEmailPreference:function(){if(S.isOnPremise()){var e=widget.getValue("emailNotify"),t={data:[{dataelements:{}}]},s=I.userEnteredEmailValue;if(void 0!==s&&e===s){var a=I.tasks.data();a&&i.__updateCsrf(t,a),t.data[0].dataelements.preference_AssignedTaskNotificationOn=s.toString();var o={url:I.emailNotificationService,type:"PUT",dataType:"json",data:JSON.stringify(t),headers:{"content-type":"application/json"}};i.ajaxRequest(o),delete I.userEnteredEmailValue}}},spaceNames:{},myAppsStorages:null,onStorageChange:function(){S.setTenant(widget.getValue("collabstorage")),I._has3DPlanAccess()&&I.tasksView&&!I.tasksView._rdfCollection&&(this._initRDFTasksCollection(),I.tasksView&&I.tasksView.destroy(),I.setupTasksView()),m.removeScopeData(),u.onStorageChange.call(I),I.tasksView._detailPanel.updateCommonInitializerLibrary()},onSpaceChange:function(){u.onSpaceChange.call(I),I.setSpace(),I.tasksView._detailPanel.updateCommonInitializerLibrary()},_loadIndividual3DSpaceTask:function(){var e=I._getTaskIdToOpen();if(!I._taskIdToOpenIsRDF()){I.showLoadingMessage(!0);let t=I.tasks.fetchTaskById(e,{reset:!0,onComplete:function(){var t=I.tasks.get(e);t&&(t.noFilter=!0),I.hideLoadingMessage(),I._afterLoadInvididual3DSpaceTask()},onFailure:function(){I.hideLoadingMessage(),I._onSingleTaskFetchFail()}});t&&t.noFetch&&setTimeout(I.hideLoadingMessage,0)}},_afterLoadInvididual3DSpaceTask:function(){if(!I._taskIdToOpenIsRDF()){var e=I._getTaskIdToOpen();I.tasksView?I._selectTaskByIdOnLoad(e):widget.addEventOnce("constantsServiceReturned",function(){I._selectTaskByIdOnLoad(e)})}},_load3DSpaceTasks:function(){if(I._getTaskIdToOpen())I._loadIndividual3DSpaceTask();else{var e=!1;if("true"===enoviaServer.preferences.createSampleData&&!enoviaServer.space){var t=Object.keys(u.spaceNames);enoviaServer.space=t.find(e=>e!==d.TSK_PRIVATE_SPACE&&"undefined"!==e&&""!==e),e=!0}var s=this;I.showLoadingMessage(!0);let i=I.tasks.fetch({server:!0,reset:!0,onComplete:function(){e&&(enoviaServer.space=null,s.tasks.dispatchEvent("onChange:collabSpace",[s.tasks,s.tasks.collabSpace])),I._setAutoRefreshTimeout(),I.hideLoadingMessage()},onFailure:function(t,s){e&&(enoviaServer.space=null);var i=s&&s.error;i&&(I._handleInvalidScope(s),i=!1),I.hideLoadingMessage(),I.tasksView&&I._setAutoRefreshTimeout(),i&&(I._setAutoRefreshTimeout(),I.licenseError=s.error,widget.body.setContent(""),f.initializeAlert(widget.body),f.displayError(s.error))}});i&&i.noFetch&&setTimeout(I.hideLoadingMessage,0)}},_tasksServiceInitCalls:function(){var e=this;0!==I.tasks.collabSpace.length&&this._load3DSpaceTasks(),i.getWidgetConstants("/resources/v2/e6w/service/TSK_WIDGET_CONSTANTS",function(){var t=F("REFRESH_TIMEOUT");t&&(I.REFRESHTIMEOUT=1e3*parseInt(t,10)),enoviaServer.widgetId=widget.id,I._has3DPlanAccess()&&(e._initRDFTasksCollection(),I._loadRDFTasks()),I.tasksView||(widget.addEvents({onViewChange:I.onViewChange,onUpdateTitle:I.onTitleChange,onUpdateValue:I.onValueChanged}),I.setupTasksView(),I._initEmailPreference.apply(this,arguments)),I.tasksView.setTitleDefaultValue(),I.tasksView.initScope(),I.setWindowHeight(),widget.dispatchEvent("onResize"),I._initPreferencesWithConstants(),widget.dispatchEvent("constantsServiceReturned")})},onValueChanged:function(e,t){switch(e){case"emailNotify":I.onEmailNotifyChange(e,t);break;case T.COMPLETED_TASK_PREF_NAME:I.onCompletedTasksDisplayPrefChange(e,t)}},setupTasksView:function(){I.tasksView=new c({collection:I.tasks,rdfCollection:I.rdfTasks,singleTaskId:I._getTaskIdToOpen(),fetchCount:I._fetchCount}),I.licenseError?delete I.licenseError:(I.tasksView.listenTo(widget,"onResize",function(){I.setWindowHeight(),I.tasksView.onResize.apply(I.tasksView,arguments)}),I.tasksView.listenTo(widget,"onSearch",function(e){I.rdfTasks&&I.rdfTasks.setSearch(e),I.tasks.setSearch(e)}),I.tasksView.listenTo(widget,"onResetSearch",function(){I.rdfTasks&&I.rdfTasks.resetSearch(),I.tasks.resetSearch()}),widget.body.empty(),I.tasksView.render().inject(widget.body),this._progressBarView=new w,this._progressBarView.render().inject(window.widget.body))},_initPreferencesWithConstants:function(){if("0"!==V("hasDPJAccess")){var e=widget.getPreference("showProjectTasks");e.disabled="disabled",widget.addPreference(e)}var t=widget.getPreference("collabspace");t.label=F("emxCollaborativeTasks.Label.Credential"),R(t),widget.addPreference(t);var s=widget.getPreference("collabstorage");s.label=F("emxFoundation.Widget.CollaborativeStorages"),s.disabled=s.options&&1===s.options.length,widget.addPreference(s);var i=widget.getPreference("showProjectTasks");if(i.label=F("emxCollaborativeTasks.Label.ShowProjectTasks"),widget.addPreference(i),S.isOnPremise()){var a=widget.getPreference("emailNotify");a.label=F("emxCollaborativeTasks.Label.EmailNotify"),widget.addPreference(a)}},setSpace:function(){var e=u.getContext().split(".");if(I.tasks.collabSpace=e[e.length-1],I.myAppsStorages&&I.myAppsStorages.find){var t=I.myAppsStorages.find(e=>e.platformId===S.getTenant());t&&(enoviaServer.storageUrl=t["3DSpace"])}I._tasksServiceInitCalls(),I.tasks.dispatchEvent("onChange:collabSpace",[I.tasks,I.tasks.collabSpace]);var s=this.spaceNames[enoviaServer.storageUrl];s&&b.processSecurityContextData(s)},clearData:function(){u.clearData.call(I)},loadBPS:function(){u.loadBPS.call(I,widget,"false","/resources/v2/e6w/service/TSK_WIDGET_CONSTANTS",{additionalStorage:A.SERVICE_3DPLAN,storageAsTenant:!0})},setTitlePref:Function.prototype,setRowPref:Function.prototype,processStorageChange:function(){u.processStorageChange.apply(I,arguments)},onAfterLoad:Function.prototype,_onSingleTaskFetchFail:function(){f.displayInfo(F("emxCollaborativeTasks.Info.TaskNotFound"))},_selectTaskByIdOnLoad:function(e){-1===I.tasksView.getColumnAndCardIdxFromId(e)[1]?I.tasksView.addEventOnce("afterColChanged",function(){I.tasksView.selectById(e)}):I.tasksView.selectById(e)},_processSelectedIds:function(){var e;if(widget.getValue("id")||widget.getValue("ids")){var t=(e=widget.getValue("id")||widget.getValue("ids")).indexOf("?");-1!==t&&(e=e.substring(0,t))}else widget.getValue("X3DContentId")&&(e=this._getIdFromCompassSelect());e&&(I._selectedTaskId=e)},_getIdFromCompassSelect:function(){var e=JSON.parse(widget.getValue("X3DContentId")).data.items[0];if(-1!==["Task","Inbox Task","dsplan:Task"].indexOf(e.objectType))return f.validateObjectTenant(),e.objectId;f.displayWarning(i.getWidgetConstant("emxCollaborativeTasks.Warning.ObjectNotTask")),widget.deleteValue("X3DContentId")},_handleInvalidScope:function(e,t){var s=!1;return e&&400===e.statusCode&&e.error&&e.error.indexOf("Invalid Business Object")>=0&&(s=!0,m.setScopeToInvalid(!0),t?m.removeUserScopeData():m.removeScopeData(),I.setSpace()),s}}).onAfterLoad=I.setSpace,I.REFRESHTIMEOUT=0,I.PENDINGFETCH=!1,I.MAXFETCHCOUNT=1e3,I.document=document,I.checkVisibilityAPI(),I});