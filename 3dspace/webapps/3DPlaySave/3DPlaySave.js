define("DS/3DPlaySave/SaveTo3DDrive",["DS/WebUtils/Tracker","DS/WAFData/WAFData","DS/UIKIT/Spinner","DS/UIKIT/SuperModal","DS/UIKIT/Input/Text","DS/W3DDriveComponent/DriveContentSelector","css!DS/UIKIT/UIKIT.css","i18n!DS/3DPlaySave/assets/nls/SaveServices","DS/WebUtils/WebServices"],function(e,t,n,o,i,r,a,s,l){"use strict";return function(e,i){function a(e){var t=document.querySelector(".drive-validation-button");t&&(t.disabled=e)}function c(){a(!0)}var u,d=new n({className:"spinner-center",visible:!0}),m=new o({className:"driveBrowserTest",closable:!1,renderTo:document.body});m.dialog({title:s.DriveBrowser_Title,body:[d],buttons:[{className:"primary drive-validation-button",value:s.DriveBrowser_Button_OK,action:function(n){var o,r;o=u.envId,r={onFailure:i.onFailed,onComplete:function(n){var o,r,a;o={url:n.url,envId:u.envId},r={onFailure:i.onFailed,onComplete:function(o){var r,a,s;r={ticket:o.ticket,file:e},a={timeout:i.timeout,onTimeout:i.onTimeout,onFailure:i.onFailed,onProgress:i.onProgress,onComplete:function(r){var a=UWA.createElement("div").setHTML(r).getElement('[name="__fcs__jobReceipt"]').value;!function(n,o){var r=n.url+"/resources/3ddrive/v1/bos/"+n.objectId+"/contents?update=true&withactions=true";n.tenant&&(r+="&tenant="+n.tenant);var a={"Content-Type":"application/json;charset=UTF-8"};a["X-DS-CSRFTOKEN"]=n.token;var s={};s.receipt=n.receipt,s.file=n.file.name,s.title=n.file.name,s.type="DriveFile",i.logger.log("contents",r,a),t.authenticatedRequest(r,{parse:!0,validate:!0,wait:!0,method:"POST",type:"json",headers:a,file:e,data:JSON.stringify(s),onComplete:o.onComplete,onFailure:o.onFailure})}({url:n.url,objectId:u.objectId,envId:u.envId,token:o.token,file:e,receipt:a},{onFailure:i.onFailed,onComplete:function(t){var n={objectType:"DriveFile",objectId:t.id,serviceId:"3DDrive",envId:u.envId,displayName:e.name};i.onComplete(n)}})}},(s=new FormData).append(r.ticket.jobticket,r.ticket.ticket),s.append("file-name",r.file.name),s.append("file_0",r.file),s.append("file-title",r.file.name),s.append("file-description",r.file.name),i.logger.log("uploadFCS",r.ticket.actionurl,r.ticket.jobticket,r.ticket.ticket),t.authenticatedRequest(r.ticket.actionurl,{timeout:a.timeout,method:"POST",data:s,onTimeout:a.onTimeout,onComplete:a.onComplete,onUploadProgress:a.onProgress,onFailure:a.onFailure})}},a=o.url+"/resources/3ddrive/v1/bos/ticket",o.tenant&&(a+="?tenant="+o.tenant),i.logger.log("_getTicket",a),t.authenticatedRequest(a,{method:"GET",type:"json",onComplete:function(e,t,n){e&&e.actionurl&&e.ticket&&e.jobticket?r.onComplete({ticket:e,token:t["x-ds-csrftoken"]}):(i.logger.error("_getTicket no response Ticket"),r.cbs&&r.onFailure())},onFailure:o.onFailure})}},l.getServiceUrl({serviceName:"3DDrive",platformId:o,onError:r.onFailure,onSuccess:r.onComplete}),n.hide()}},{value:s.DriveBrowser_Button_Cancel,action:function(e){e.hide(),i.onCancel()}}]}),c();var p={createFolder:!0,accessright:"edit",select:{type:"DriveFolder"},filter:{type:"DriveFolder"},multiEnv:!0,onSelect:function(e){if(e&&e.length>0&&e[0]){if("sharedwithme"===(u=e[0]).objectId)return;a(!1)}else c()}};try{var S=r.create3DDriveChooser(p);d.hide(),m.modals.current.getBody().appendChild(S.container)}catch(e){m.modals.current.hide()}}}),define("DS/3DPlaySave/Load3DComment",["UWA/Core","UWA/Controls/Abstract","DS/ApplicationFrame/Command","DS/WebSystem/SessionManager","UWA/Utils"],function(e,t,n,o,i){"use strict";var r,a=t.extend({init:function(t){this._parent(t);var n=null,o=new FileReader,r=!1;function a(){!r&&t.onErrorCB&&t.onErrorCB()}(n=new e.createElement("input",{id:"TestFileSelector"}).inject(widget.body)).setAttribute("type","file"),n.setAttribute("accept",".json,.zip"),n.setStyles({opacity:0}),n.onchange=function(){if(n){var e=n.files;if(!e||e&&!e.length)return void a();setTimeout(a,5e3),e[0].name.indexOf(".zip")>-1?(o.onload=function(){r=!0;var e=o.result;try{e=i.base64Decode(e)}catch(e){}for(var n=new ArrayBuffer(e.length),a=new Uint8Array(n),s=0;s<e.length;s++)a[s]=e.charCodeAt(s);var l=new window.zip.Inflater,c=l.append(a);l.flush();var u=String.fromCharCode.apply(null,c);t.onFileLoadedCB(JSON.parse(u))},o.readAsBinaryString(e[0])):(o.onload=function(){r=!0;var e=o.result;e=(e=e.replace(/\\n/g,"\\n").replace(/\\'/g,"\\'").replace(/\\"/g,'\\"').replace(/\\&/g,"\\&").replace(/\\r/g,"\\r").replace(/\\t/g,"\\t").replace(/\\b/g,"\\b").replace(/\\f/g,"\\f")).replace(/[\u0000-\u0019]+/g,""),t.onFileLoadedCB(JSON.parse(e))},o.readAsText(e[0]))}},this.openFileBrowser=function(){n.click()},this.cleanFileBrowser=function(){n&&n.parentNode===widget.body&&widget.body.removeChild(n),n=null}}});return n.extend({init:function(e){this._parent(e,{mode:"shared"}),this.setRepeatMode(!1);var t=this;this.initFileBrowser=function(){r=new a({onErrorCB:function(){},onFileLoadedCB:function(e){o.restoreSession(e),r.cleanFileBrowser(),r=null,t.end()}})},this.initFileBrowser()},beginExecute:function(){r||this.initFileBrowser(),r.openFileBrowser()}})}),define("DS/3DPlaySave/SaveServices",["DS/WebUtils/Tracker","DS/WebUtils/Network","DS/WebUtils/WebServices","DS/WebInfraUI/CmdScenarioUI","i18n!DS/3DPlaySave/assets/nls/SaveServices","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/WebUtils/StringUtils","DS/Core/PointerEvents","DS/CoreEvents/Events","DS/WebUtils/Logger"],function(e,t,n,o,i,r,a,s,l,c,u,d){"use strict";var m,p,S,f,g,v,D,y,h,P,b={"3DSpace":{name:"3DSpace",app:"X3DCSMA_AP",module:"DS/3DPlaySave/SaveTo3DSpace"},"3DSwym":{name:"3DSwym",app:"X3DMCTY_AP",module:"DS/3DPlaySave/SaveTo3DSwym"},"3DDrive":{name:"3DDrive",app:"X3DDRIV_AP",module:"DS/3DPlaySave/SaveTo3DDrive"}},F=!0;u.subscribe({event:"3DPLAY.ODT.UPLOAD.RESET"},function(){g=null});var w=d("3DPlay.SaveServices","3DPlay.Log.Save");function C(e){if(F&&y){y.workbenchIndex=0;let i=y.args.workbenchs,r=y.frmWindow.getActionBar().MAB,a=JSON.stringify(r.getCurrentModel())===JSON.stringify(r.modelTablet),s={},l={model:UWA.extend({},r.model,!0),modelTablet:UWA.extend({},r.modelTablet,!0)};for(let e in l)s[e]=l[e].speeddial.filter(function(e){return"Share"===e.id}),Array.isArray(s[e])&&(s[e]=s[e][0]);if(e){if(!p&&!S){let e={id:"Upload3Dexp",rsc:"3DPlaySave/3DPlaySave"};for(let t in s)if(s[t]){let n=s[t].flyout.filter(function(e){return"Share3DComment"===e.id})[0];if(n){p=p||{};let o=s[t].flyout.indexOf(n);p[t]=s[t].flyout[o],s[t].flyout[o]=e}else(S=S||{})[t]=s[t].flyout.push(e)}else console.log("shareMenu",t)}if(!m)for(var t=i.length;t--;)if(i[t].name.indexOf("3DPlayShare")>-1){m=UWA.clone(i[t]),i[t].name="3DPlayUpload",i[t].module="3DPlaySave";break}}else{for(t=i.length;t--;)if("3DPlayUpload"==i[t].name){i[t]=m,m=void 0;break}for(let e in l)if(s[e]){var n=s[e].flyout.filter(function(e){return"Upload3Dexp"===e.id});if(n)if(p&&p[e]){var o=s[e].flyout.indexOf(n[0]);s[e].flyout[o]=p[e],p[e]=void 0}else S&&S[e]?(s[e].flyout.splice(s[e].flyout.indexOf(n[0]),1),S[e]=void 0):console.log("missing entry");else console.log("Upload3Dexp")}else console.log("shareMenu")}r.update(a?l.modelTablet:l.model),y.manageWorkBenchs({createActionBar:!0,finishCallBack:function(){}})}}function T(){return g||(g=new UWA.Promise(function(e,t){n.getPlatformServices({onComplete:function(n){f=[];var o=Object.keys(b);if(n&&n.length>0){for(var i=[],r=n.length;r--;)for(var a=Object.keys(n[r]),s=o.length;s--;){var l=o[s];-1===i.indexOf(l)&&a.indexOf(l)>-1&&(i.push(l),f.push(b[l]))}w.log("availableProviders",f),e(f)}else t(f)},onFailure:t})})),g}var N=function(){D&&a.removeNotification(D)},U=function(){N();var t,n,o={level:"info",message:i.FileDnDFromDesktopNotif,category:"3DPlayPublishServices",sticky:!0},s=f&&f.length>0;(s&&(o.action={label:f.length>1?i.FileDnDFromDesktopNotif_ActionTitle:i.FileDnDFromDesktopNotif_ActionTitle_1+f[0].name,callback:function(){t=!0,e.command("NotifUpload3DExp"),k()}},C(!0),I(!0)),D=r.addNotif(o),s)&&(a._notifications.forEach(function(e){e._data.count===D&&(n=e)}),n&&(n._action.addClassName("wux-ui-state-primary"),setTimeout(function(){var e=function(){if(!t){var o={level:"warning",message:i.FileDnDFromDesktopNotif+i["FileDnDFromDesktopNotif_2Message".concat(F?"_CMD":"")],category:"3DPlayPublishServices",sticky:!0};n.getDiv().removeEventListener(c.POINTERUP,e),D=r.addNotif(o)}};n.getDiv().addEventListener(c.POINTERUP,e)},50)));return D},k=function(){var t=function(t,n){require([t.module],function(o){function a(o){var i=l.getExtension(n.name);e.trackPageEvent("save",i,t.name,{success:200,failed:1,canceled:2,timeout:3}[o],{fileSize:Math.floor(n.size/1e3)}),y.getPhaseProgress().hideProgressBar()}y.uploadprogress||(y.uploadprogress=y.getPhaseProgress().registerSubProgress()),y.getPhaseProgress().setAbsoluteProgress(y.uploadprogress,0),o(n,{frame:y.frmWindow.getImmersiveFrame(),timeout:54e5,onComplete:function(e){w.log("onComplete"),a("success"),N(),r.addNotif({level:"success",message:i.FileDnDFromDesktopNotif_PublishOK+t.name,category:"3DPlayPublishServices"}),P(e),A()},onCancel:function(){w.log("canceled"),a("canceled"),U()},onTimeout:function(){a("timeout"),r.addNotif({level:"error",message:i.FileDnDFromDesktopNotif_ErrorTimeout,category:"3DPlayPublishServices"}),w.error("Upload",t.name,"timeout"),U()},onFailed:function(e){a("failed"),r.addNotif({level:"error",title:e.displayMessage?i.FileDnDFromDesktopNotif_ErrorInPublish:void 0,message:e.displayMessage?e.displayMessage:i.FileDnDFromDesktopNotif_ErrorInPublish,category:"3DPlayPublishServices"}),w.error("Upload",t.name,e),U()},onProgress:function(e){y&&(y.getPhaseProgress().progress.state.visible||(y.getPhaseProgress().showProgressBar(),D=r.addNotif({level:"info",message:i.FileDnDFromDesktopNotif_UploadingContent+t.name||"Uploading Content",category:"3DPlayPublishServices"})),y.getPhaseProgress().setAbsoluteProgress(y.uploadprogress,Math.round(100*e.loaded/e.total))),w.log("progress",e)},logger:w})},console.error)};if(f.length<2)t(f[0],v.localFile);else{for(var n=[],a=0;a<f.length;a++){!function(e){e.onSelectCB=function(n){o.dispose(),t(e,v.localFile)},n.push(new Promise(function(t){s.getAppInfo({appId:e.app,onComplete:function(n){e.thumbnail=n.icon,t()}})}))}(f[a])}Promise.all(n).then(function(){n=null,N(),D=void 0,o.create({frmWnd:y.frmWindow,listchooser:f,title:i.FileDnDFromDesktopNotif_ChooserTitle,endcb:U})})}};function A(){I(!1),C(!1),m=void 0,p=void 0,S=void 0}function I(t){y.PanelManager.dispose(),y.PanelManager.generated=void 0,y.PanelManager.setTopBarId(y.args.options);var n={ctx:y.ctx,container:y.frmWindow.getUIFrame(),experience:y,showBubbleMenu:y.args.options.showBubbleMenu};t&&(n.allowUploadServices={label:i.FileDnDFromDesktopNotif_ActionTitle,onExecute:function(){e.command("TopBarUpload3DExp"),k()}}),w.log("handlePanelManager",t),y.PanelManager.createTopMenu(n),y.PanelManager.createDefaultHelp()}return T(),function(e,t,n){e?(v=e.loadAssetInfo,y=n,P=t,h||(h=!0,y.subscribe("ASSET/LOADINGSTARTED",A,!0),y.disposeFunctions.add(function(){A(),h=void 0})),T().then(U)):T().then(k)}}),define("DS/3DPlaySave/SaveTo3DSpace",["DS/WebUtils/WebServices","DS/WebSystem/App"],function(e,t){"use strict";return function(e,n){var o,i=function(t,i){n.logger.log("PlateformInfo :",t["3DSpace"],t.platformId,i);var r=new o({tenantUrl:t["3DSpace"],tenant:t.platformId,securityContext:i,immersiveFrame:n.frame,getWorkUnderHeaders:function(){return{}},onUploadStart:function(){n.logger.log("onUploadStart")},onCancel:n.onCancel,onError:n.onFailed,onDocumentUpload:function(o){n.logger.log("onDocumentUpload");var i=o.documents[0];n.onComplete({objectId:i.id,objectType:i.type,envId:t.platformId,serviceId:"3DSpace",displayName:e.name}),r.destroy(),r=null}});r.create([e])};require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/PADServices/utils/GlobalUtils","DS/DocumentCreateNew/CreateNew"],function(e,r,a){o=a;var s=[];r.getSecurityContext()||s.push(new Promise(function(e){require(["DS/PADServices/utils/PlatformURL"],function(t){t.retrievePlatformUrl({addDefaults:!0,initWSAcess:!0}).then(()=>{r.retrieveAndSetSC().then(e)})})})),e.getPlatformServices({serviceName:"3DSpace",onError:n.onFailed,onComplete:function(e){t.isOnCloud()&&e.length>1?parent.require(["DS/Dashboard/Modals/PlatformSelect","i18n!DS/Dashboard/assets/nls/modal"],function(t,o){var a=[];e.forEach(e=>{e["3DSpace"]&&a.push(e)}),n.logger.log(e,a),e=null,t.show({message:o.noPlatformSelectContent,closable:!0,platforms:a,onCancel:n.onCancel,onConfirm:function(e){Promise.all(s).then(()=>{i(e,r.getSecurityContext())})}})}):Promise.all(s).then(()=>{i(e[0],r.getSecurityContext())})}})})}}),define("DS/3DPlaySave/3DPlayEnvironment",["DS/WebSystem/Environment","DS/Visualization/ThreeJS_R57"].concat(["DS/DMUBaseReview/DMUOverloadableObject"]),function(e,t,n){"use strict";var o=[{name:"sVisuViewSettings",type:"string",JSONname:"VisuViewSettingsJSON"}];return n.extend({init:function(){this._parent(),this.addParameters(o),this.setAttributes([{name:"sType",value:"3DPlayEnvironment"},{name:"sName",value:null}]),this.importData=function(e,n,o){var i=o.getViewer();if(i.applyViewPanelSettings)i.applyViewPanelSettings(e.VisuViewSettingsJSON);else{if(i.setMaterialMode(e.VisuViewSettingsJSON.materialMode),i.setVisuShadingFaceMode(e.VisuViewSettingsJSON.visuShadingFaceMode),i.setVisuShadingEdgeMode(e.VisuViewSettingsJSON.visuShadingEdgeMode),i.setVisuShadingMode(e.VisuViewSettingsJSON.visuShadingMode),e.VisuViewSettingsJSON.visuEnv.includes("OCA")){var r=e.VisuViewSettingsJSON.visuEnv.replace("OCA","");i.setVisuEnvOCA(r)}else i.setVisuEnvOCA(e.VisuViewSettingsJSON.visuEnv);i.setVisuAppearanceMode(t.DefaultAppearanceMode[e.VisuViewSettingsJSON.visuAppearanceMode]),i.setPointsFilter(e.VisuViewSettingsJSON.pointsState),i.setAxisOnlyFilter(e.VisuViewSettingsJSON.axisState),i.setPlanesFilter(e.VisuViewSettingsJSON.planesState),i.setLinesFilter(e.VisuViewSettingsJSON.linesState),i._setVisuOutlineMode(e.VisuViewSettingsJSON.visuOutlineMode),i.currentViewpoint.setProjectionType(e.VisuViewSettingsJSON.projectionMode)}},this.exportData=function(e,t){var n=require("DS/PADUtils/PADContext").get().getViewer();this.setAttribute("sVisuViewSettings",n.dumpViewPanelSettings?n.dumpViewPanelSettings():require("DS/VisuTools/SettingManager").Struct({importFromOldLocalStorage:!0,name:"VisuViewSettings",useLocalStorage:!1,useWidget:!0,viewer:n})),e.writeObjectAttributes(this,t)}}})}),define("DS/3DPlaySave/Save3DComment",["DS/ApplicationFrame/Command","DS/WebSystem/SessionManager","DS/WebSystem/Downloader"],function(e,t,n){"use strict";return e.extend({beginExecute:function(){!async function(){const e=await t.getSession(),o=JSON.stringify(e);n("3DPlaySession.json",new Blob([o],{type:"json"}))}(),this.end()}})}),define("DS/3DPlaySave/SaveTo3DSwym",["DS/WebUtils/Tracker","DS/UIKIT/Modal","DS/WAFData/WAFData","i18n!DS/3DPlaySave/assets/nls/SaveServices","DS/WebUtils/WebServices","DS/WebUtils/StringUtils"],function(e,t,n,o,i,r){"use strict";return function(e,a){require(["DS/SwymPublishForm/script/publish-form-view"],function(s){var l,c=new s({mode:"jsevent",contentTitle:e.name}),u=function(){c&&(c.destroy(),c=null),l&&(l.destroy(),l=null)};c.addEvent("CancelShare",function(){u(),a.onCancel()}),c.addEvent("StartUpload",function(t){l&&(l.destroy(),l=null),a.logger.log("StartUpload",t);var s,d=JSON.parse(t);s={url:d.platform_instance,onComplete:function(t){var s,l;s={timeout:a.timeout,url:d.platform_instance,communityId:d.community_id,serverToken:t,file:e,filename:e.name,name:e.name,onTimeout:a.onTimeout,onFailure:a.onFailed,onProgress:a.onProgress,onComplete:function(t){c.addEvent("ContentCreated",function(t){u();var n=i.getTenant(d.platform_instance);try{t=JSON.parse(t)}catch(e){t=""}if(!0===t.success){var o={objectType:"media",objectId:t.contentSubjectURI,serviceId:"3DSwym",envId:n,displayName:e.name};a.onComplete(o)}else a.onFailure()}),a.logger.log("publishFormView.createContent",t.result.id),c.createContent(t.result.id)}},(l=new FormData).append("userFile",s.file,s.localFilename),l.append("published",1),l.append("title",s.name),l.append("community_id",s.communityId),"media"!==s._currentType&&l.append("is_illustration","true"),a.logger.log("_publish",s.url+"/api/media/add",s.communityId),n.authenticatedRequest(s.url+"/api/media/add",{timeout:s.timeout,method:"POST",type:"json",headers:{"X-DS-SWYM-CSRFTOKEN":s.serverToken},data:l,onTimeout:s.onTimeout,onComplete:function(e){e.errorcode?(a.logger.error("_publish",e),s.onFailure&&s.onFailure(e)):s.onComplete(e)},onUploadProgress:s.onProgress,onFailure:function(e,t,n){s.onFailure({error:e,response:t,headers:n,displayMessage:t&&t.errorcode&&r.sprintf(o["Swym_"+t.errorcode],"3DSwym")||"File exceeds 3DSwym's size limit"})}})},onFailure:a.onFailed},a.logger.log("_getServerToken",s.url+"/api/index/tk"),n.authenticatedRequest(s.url+"/api/index/tk",{method:"GET",type:"json",onComplete:function(e){e&&e.result&&e.result.ServerToken?s.onComplete(e.result.ServerToken):(a.logger.error("_getServerToken No response"),s.onFailure&&s.onFailure())},onFailure:s.onFailure})}),(l=new t({closable:!1,header:o.SwymPublish_Title,body:c.render("publish_to_sywm_wrapper_id"),className:"publishSwymPanel_3DPlay"})).inject(document.body),l.show()})}}),define("DS/3DPlaySave/CmdUpload3DExp",["DS/ApplicationFrame/Command","DS/WebUtils/Tracker","DS/3DPlaySave/SaveServices"],function(e,t,n){"use strict";return e.extend({init:function(e){this._parent(e,{isAsynchronous:!1}),this.enable()},execute:function(){t.command(this.getId()),n()}})});