/*!  Copyright 2018 Dassault Systemes. All rights reserved. */
"use strict";define("DS/i3DXRDFGroupViewer/js/Viewer/SkeletonConfiguration/IdCardsOptions",["DS/W3DXComponents/Skeleton","i18n!DS/i3DXRDFGroupViewer/assets/nls/group"],function(e,t){return{getMyGroupsIdCardOptions:function(){return{thumbnail:function(){return{squareFormat:!1,url:this.get("image")}},attributesMapping:{title:function(){return this.escape("name")},ownerName:function(){return this.get("owner")?this.get("owner").givenName+" "+this.get("owner").familyName:""},description:function(){return this.get("memberCount")+" "+t.get("tile.member")}},facets:function(){return[{name:"members",text:t.get("facet.members"),icon:"users",handler:e.getRendererHandler("membersRenderer")},{name:"properties",text:t.get("facet.properties"),icon:"doc-text",handler:e.getRendererHandler("groupPropertiesRenderer")}]}}}}}),define("DS/i3DXRDFGroupViewer/js/Viewer/Models/GroupModel",["UWA/Class/Model","DS/WebappsUtils/WebappsUtils"],function(e,t){var i,n,r,o=t.getWebappsAssetUrl("i3DXRDFGroupViewer","img/default-group.png"),s="?$mask=dsaccess:Mask.GroupUI.Properties";return e.extend({idAttribute:"@id",defaults:{name:"",description:"",groupMembers:[],memberCount:0,image:o,readOnly:!1},setup:function(e,t){i=t.usersGroupURL,n=t.platformId,r=t.customRequest},urlRoot:function(){return"OnPremise"===n?i+"/group":i+"/resources"},url:function(){var e=this._parent();return"OnPremise"===n?e+s+"&select=title&select=description&select=uri&select=members&select=membersfullname&select=modified":e+s},sync:function(e,t,i){i.ajax=r,this._parent(e,t,i)},parse:function(e,t){var i,r=(i=e.value?e.value:e).owner;return"OnPremise"===n?{"@id":i.uri,name:i.title,description:i.description,groupMembers:i.members?i.members:[],memberCount:i.members?i.members.length:0,owner:{"@id":r,givenName:r.firstname,familyName:r.lastname},modified:i.modified}:{"@id":i["@id"],name:i.name,description:i.description,memberCount:i.memberCount?i.memberCount.totalItems:0,owner:{"@id":r["@id"],givenName:r.givenName&&r.givenName.member?r.givenName.member.filter(function(e){return""!==e})[0]:"",familyName:r.familyName&&r.familyName.member?r.familyName.member.filter(function(e){return""!==e})[0]:""},modified:i.modificationDate?i.modificationDate:"",maturity:i.maturity&&i.maturity.name?i.maturity.name:""}}})}),define("DS/i3DXRDFGroupViewer/js/Viewer/Models/MemberModel",["UWA/Class/Model","DS/WebappsUtils/WebappsUtils"],function(e,t){var i=t.getWebappsAssetUrl("i3DXRDFGroupViewer","img/default-member.png");return e.extend({idAttribute:"@id",defaults:{image:i},parse:function(e,t){return{"@id":e["@id"],givenName:e.givenName&&e.givenName.member?e.givenName.member.filter(function(e){return""!==e})[0]:"",familyName:e.familyName&&e.familyName.member?e.familyName.member.filter(function(e){return""!==e})[0]:"",accountName:e.accountName||e.mbox||""}}})}),define("DS/i3DXRDFGroupViewer/js/Viewer/Views/GroupProperties",["DS/UIKIT/Form","DS/UIKIT/Input/Button","UWA/Class/View","DS/W3DXComponents/Views/Layout/ScrollView","i18n!DS/i3DXRDFGroupViewer/assets/nls/group"],function(e,t,i,n,r){return i.extend({tagName:"div",className:"group-properties",setup:function(e){this.form=this.buildForm(),this.form.disable(),this.elements.formScrollView=new n({view:this.form,useInfiniteScroll:!1,usePullToRefresh:!1})},buildForm:function(){var t=[{type:"text",name:"name",label:r.get("form.name"),value:this.model.get("name")},{type:"text",multiline:!0,rows:5,name:"description",label:r.get("form.description"),value:this.model.get("description")},{type:"text",name:"owner",label:r.get("form.owner")},{type:"text",name:"modified",label:r.get("form.modified"),value:this.model.get("modified")},{type:"text",name:"groupURI",label:r.get("form.groupURI"),value:this.model.get("@id")}];"OnPremise"!==this.options.platformId&&t.splice(3,0,{type:"text",name:"maturity",label:r.get("form.maturity"),value:this.model.get("maturity")});var i=new e({fields:t});return i.setValue("owner",this.model.get("owner").givenName+" "+this.model.get("owner").familyName),i.render=function(){},i.container=i.elements.container,i.container.addClassName("form-properties"),console.log(i.container),i},destroy:function(){this.stopListening(),this.model=null,this.form=null,this._parent()},render:function(){return this.elements.formScrollView.render().inject(this.container),console.log(this.elements.formScrollView),this}})}),define("DS/i3DXRDFGroupViewer/js/Viewer/Models/MemberModelOnPremise",["UWA/Class/Model","DS/WebappsUtils/WebappsUtils"],function(e,t){var i=t.getWebappsAssetUrl("i3DXRDFGroupViewer","img/default-member.png");return e.extend({defaults:{image:i,givenName:"",familyName:"",accountName:""}})}),define("DS/i3DXRDFGroupViewer/js/Viewer/Collections/MemberCollection",["UWA/Class/Collection","DS/i3DXRDFGroupViewer/js/Viewer/Models/MemberModel"],function(e,t){var i,n;return e.extend({model:t,setup:function(e,t){this._parent(e,t),i=t._modelKey;var r=t.usersGroupURL;this.swymURL=t.swymURL,n=t.customRequest,this.url=r+"/resources/"+i.id+"/groupMembers",this.state={hasNextPage:!0,skip:0,itemsPerPage:50}},sync:function(e,t,i){i.ajax=n,this._parent(e,t,i)},fetch:function(e){var t=this.state.itemsPerPage;e.getNextPage?e.getNextPage&&(this.state.skip+=t):(this.state.skip=0,this.state.hasNextPage=!0),e.data={$mask:"dsaccess:Mask.GroupUI.Members",$skip:this.state.skip,$top:t,$orderby:"familyName"},e.onTimeout&&(e.onTimeout=e.onTimeout.bind(this)),this._parent(e)},parse:function(e){var t=e.member;return t&&t.length||(this.state.hasNextPage=!1),t},onAdd:function(e,t,i){this.swymURL&&e.set("image",this.swymURL+"/api/user/getpicture/login/"+e.get("accountName"))}})}),define("DS/i3DXRDFGroupViewer/js/Viewer/Collections/MemberCollectionOnPremise",["UWA/Class/Collection","DS/i3DXRDFGroupViewer/js/Viewer/Models/MemberModelOnPremise"],function(e,t){return e.extend({model:t,setup:function(e,i){var n=this;this._parent(e,i),(i.groupMembers?i.groupMembers:[]).map(e=>n.add(new t({givenName:e.firstname,familyName:e.lastname,accountName:e.name})))}})}),define("DS/i3DXRDFGroupViewer/js/Viewer/SkeletonConfiguration/RenderersOptions",["UWA/Class/Promise","DS/W3DXComponents/Views/EmptyView","DS/W3DXComponents/MemberSet","DS/i3DXRDFGroupViewer/js/Viewer/Collections/MemberCollection","DS/i3DXRDFGroupViewer/js/Viewer/Collections/MemberCollectionOnPremise","DS/i3DXRDFGroupViewer/js/Viewer/Views/GroupProperties","i18n!DS/i3DXRDFGroupViewer/assets/nls/group"],function(e,t,i,n,r,o,s){function a(e,t,i){t.add({message:i}),e.state.hasNextPage=!1}return{getRenderers:function(e){var m=e.usersGroupURL,l=e.swymURL,u=e.customRequest,c=e.errorAlert,d=e.onUserClick,p=e.platformId;return{groupPropertiesRenderer:{fetchMode:"never",view:o,viewOptions:{errorAlert:c,platformId:p}},membersRenderer:"OnPremise"===p?{collection:r,collectionOptions:{groupMembers:e.model.get("groupMembers")?e.model.get("groupMembers"):[]},fetchMode:"never",view:i,viewOptions:function(e){return{contents:{useInfiniteScroll:!1,usePullToRefresh:!1,headers:[{label:s.get("header.firstName"),property:"header_gname"},{label:s.get("header.lastName"),property:"header_fname"}],emptyView:t,itemViewOptions:{icon:"users",title:s.get("noMembers"),mapping:{title:function(){return this.model.escape("givenName")+" "+this.model.escape("familyName")},header_gname:function(){return this.model.escape("givenName")},header_fname:function(){return this.model.escape("familyName")}}}},events:{onRenderSwitcherView:function(e){this.tileIcon=e.container.getElement('input[value="tile"]').parentElement,this.tableIcon=e.container.getElement('input[value="table"]').parentElement,this.tileIcon.addClassName("hide")},onSwitch:function(){"table"===this.currentViewId?(this.tableIcon.addClassName("hide"),this.tileIcon.removeClassName("hide")):(this.tileIcon.addClassName("hide"),this.tableIcon.removeClassName("hide"))}}}}}:{collection:n,collectionOptions:{usersGroupURL:m,swymURL:l,customRequest:u},fetchMode:"once",fetchOptions:{onFailure:function(e){a(e,c,s.get("member.fetchError"))},onTimeout:function(){a(this,c,s.get("member.fetchError"))}},view:i,viewOptions:function(e){return{className:"loading",contents:{selectionMode:"",headers:[{label:s.get("header.firstName"),property:"header_gname"},{label:s.get("header.lastName"),property:"header_fname"}],emptyView:t,itemViewOptions:{icon:"users",title:s.get("noMembers"),mapping:{title:function(){return this.model.escape("givenName")+" "+this.model.escape("familyName")},header_gname:function(){return this.model.escape("givenName")},header_fname:function(){return this.model.escape("familyName")}}},useInfiniteScroll:!0,events:{onInfiniteScroll:function(){!function(e,t,i){var n=e.collection,r=e.scrollView,o=function(t){r.endLoading(),r.container.offsetParent.removeClassName("loading"),(t&&!n.state.hasNextPage||!t)&&(r.useInfiniteScroll(!1),e.dispatchEvent("infiniteScrollEnd"))};n.state.hasNextPage?n.fetch({getNextPage:!0,remove:!1,onComplete:function(){o(!0)},onFailure:function(){o(!1),a(n,t,i)},onTimeout:function(){o(!1),a(this,t,i)}}):o(!1)}(this,c,s.get("member.fetchError"))},onItemViewClick:function(e,t){d&&d(t.model.get("accountName"))}}},events:{onRenderSwitcherView:function(e){this.tileIcon=e.container.getElement('input[value="tile"]').parentElement,this.tableIcon=e.container.getElement('input[value="table"]').parentElement,this.tileIcon.addClassName("hide")},onSwitch:function(){"table"===this.currentViewId?(this.tableIcon.addClassName("hide"),this.tileIcon.removeClassName("hide")):(this.tileIcon.addClassName("hide"),this.tableIcon.removeClassName("hide"))}}}}}}}}}),define("DS/i3DXRDFGroupViewer/js/GroupViewer",["UWA/Class/View","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/UIKIT/Alert","DS/WAFData/WAFData","DS/W3DXComponents/Skeleton","DS/W3DXComponents/Views/EmptyView","DS/UIKIT/Mask","DS/i3DXRDFGroupViewer/js/Viewer/Models/GroupModel","DS/i3DXRDFGroupViewer/js/Viewer/SkeletonConfiguration/RenderersOptions","DS/i3DXRDFGroupViewer/js/Viewer/SkeletonConfiguration/IdCardsOptions","i18n!DS/i3DXRDFGroupViewer/assets/nls/group","css!DS/i3DXRDFGroupViewer/i3DXRDFGroupViewer.css"],function(e,t,i,n,r,o,s,a,m,l,u){var c,d,p,f=new i({className:"create-alert",closable:!0,visible:!0,autoHide:!0,messageClassName:"error"}),g=function(e,t){e+=-1===e.indexOf("?")?"?":"&",e+="tenant=dstenant:"+d;var i=t.headers||{};return i["Accept-Language"]=c,"OnPremise"===d&&(i.SecurityContext="VPLMAdmin.MyCompany.Default"),t.headers=i,n.authenticatedRequest(e,t)};return e.extend({className:"GroupViewer",setup:function(e){d=e.platformId,c=e.language||"en";var t=e.groupId;p=-1!==t.indexOf("<")&&-1!==t.indexOf(">")?t.slice(t.indexOf("<")+"<".length,t.indexOf(">")):t},_buildSkeleton:function(e){e.errorAlert=f;var t=new r(m.getRenderers(e),{rootIdCardOptions:UWA.merge(l.getMyGroupsIdCardOptions(),{model:e.model}),events:{}});this.bones=t},render:function(){var e=this,i=this.options.onUserClick;return s.mask(e.container),t.getPlatformServices({platformId:d,onComplete:function(t){var n="OnPremise"===d?t["3DSpace"]+"/resources/modeler/pno":t.usersgroup+"/3drdfindex/v0",r=t["3DSwym"],m=new a({"@id":p},{usersGroupURL:n,platformId:d,customRequest:g});m.fetch({onComplete:function(){e._buildSkeleton({model:m,languagePref:c,usersGroupURL:n,swymURL:r,customRequest:g,onUserClick:i,platformId:d}),s.unmask(e.container),f.inject(e.container),e.bones.render().inject(e.container)},onFailure:function(t,i,n){var r=n.request.xhr.status;s.unmask(e.container),new o({icon:"alert",title:404===r?u.get("group.notFound"):u.get("group.fetchError")}).render().inject(e.container)}})},onFailure:function(){s.unmask(e.container),new o({icon:"alert",title:u.get("compassError")}).render().inject(e.container)}}),this},destroy:function(){this.bones&&this.bones.destroy(),this._parent()}})});