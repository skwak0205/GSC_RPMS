define("DS/XCityTimeManager/xCityTimer",["UWA/Class","DS/XCityCore/Store","DS/XCityTools/EventDispatcher"],function(t,e,a){function i(t,e,a){var i=function(e,i){a(t,i)};t.addEvent("onChange:"+e,i),t.getContent()&&t.getContent().addEvent("onChange:"+e,i)}function r(t,a,r){r.getLayerRoot().getRoot().traverse(function(r){var n;if(null!=r._attributes&&null!=r._attributes.Content)if(r._attributes.Content.isLayer){if(r._attributes.visible&&(null===r.userData||void 0===r.userData?r.userData={date:a}:r.userData.date=a),n=r._attributes.Content.id,e.storeIsTimeDependant(n)){var o=e.getStore(n),l=t.indexOf(n);u(o._temporalParam.down,o._temporalParam.up,a)?-1==l?(r._attributes.visible&&t.push(n),null===r.userData||void 0===r.userData?(r.userData={listenVisible:!0},i(r,"visible",s)):!1===r.userData.listenVisible&&(r.userData.listenVisible=!0,i(r,"visible",s))):r._attributes.visible||(t.splice(l,1),null===r.userData||void 0===r.userData?(r.userData={listenVisible:!0},i(r,"visible",s)):!1===r.userData.listenVisible&&(r.userData.listenVisible=!0,i(r,"visible",s))):-1!=l&&(t.splice(l,1),null===r.userData||void 0===r.userData?(r.userData={listenVisible:!0},i(r,"visible",s)):!1===r.userData.listenVisible&&(r.userData.listenVisible=!0,i(r,"visible",s)))}}else(n=r._attributes.Content._attributes.url)?e.storeIsTimeDependant(n)&&(u((o=e.getStore(n))._temporalParam.down,o._temporalParam.up,a)?r.get("visible")||r.show():r.get("visible")&&r.hide()):void 0===r._attributes.Content._attributes.downTime&&void 0===r._attributes.Content._attributes.upTime||(u(r._attributes.Content._attributes.downTime,r._attributes.Content._attributes.upTime,a)?r.get("visible")||r.show():r.get("visible")&&r.hide())},!0)}function s(t,e){if(t._attributes.visible){t._attributes.Content.id;new Date(t.userData.date),new Date(this.date)}}function n(t){for(var e=t.length,a=0;a<e;a++)t[a].patch.rebuild(t[a].tile)}function u(t,e,a,i){if(null==i){if(null!=t&&null!=e){if(t!=e)return Date.parse(e)>Date.parse(a)&&Date.parse(t)<=Date.parse(a);var r=new Date(Date.parse(e));return r.setDate(r.getDate()+1),r>Date.parse(a)&&Date.parse(t)<=Date.parse(a)}return null!=t?Date.parse(t)<Date.parse(a):null==e||Date.parse(e)>Date.parse(a)}return Date.parse(a)==Date.parse(i)}function o(t,e){for(var a,i=0;i<e.length;i++)if(a=!0,t.strid==e[i].userData.strid){for(var r in t)if(t[r]!=e[i].userData[r]){a=!1;break}if(!0===a)return!0}return!1}function l(t,e){var a;if(null==e.value)return!1;if(a=e.value.userData)for(var i,r,s=a.source.list,n=a.records,l=a.source.tile.factory.factory.lifespanenAttribute,d=a.source.tile.factory.factory.lifespanstAttribute,b=a.source.tile.factory.factory.lifespanAttribute,p=0;p<s.length;p++)if(i=s[p].properties[d],r=s[p].properties[l],exact=s[p].properties[b],u(i,r,t,exact)){if(!o(s[p].properties,n))return!0}else if(o(s[p].properties,n))return!0;return!1}return t.extend({init:function(t){this.urban=t,this.displayedStores=[],this.date=void 0,a.subscribeTo("/3DEXPERIENCity/onPostUpdate",function(){a.subscribeTo(a.eventsList.borderChange,function(t){!function(t){var a=e.getStore(t.storeId);a&&a.updateTimeParam(t);e.deprecateAll(t.storeId)}(t)}.bind(this));a.subscribeTo(a.eventsList.date,function(t){this.date=t._date,r(this.displayedStores,t._date,this.urban),function(t,a,i){var r=[];if(i){var s;for(var n in i)for(var u in(s=e.getStore(i[n]))._data){var o=s._data[u];null!=o&&l(t,o)&&r.push({patch:o.value.userData.source.tile.factory,tile:o})}a(r)}}(this.date,n,this.displayedStores)}.bind(this))}.bind(this),!0)},_deprecateStores:function(t){var a=e.getStore(t.storeId);a&&a.updateTimeParam(t),e.deprecateAll(t.storeId)}})});