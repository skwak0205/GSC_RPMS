define("DS/InstantMessaging/js/model/RTChatModel",["UWA/Class","DS/RTProxyDriver/RTLogger","UWA/Class/Events"],function(e,t,i){"use strict";return t.debug("RTChatModel load"),e.extend(i,{init:function(e){this.ListofMsg={},this.controller=e.controller,this.contact=e.contact},onMessageReceived:function(e){this.ListofMsg[e.timestamp]=e},onSendMessage:function(e){this.ListofMsg[e.timestamp]=e},getMsg:function(){return this.ListofMsg}})}),define("DS/InstantMessaging/js/ressources/FileSaver",[],function(){return{saveAs:function(){"use strict";var e="undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content;if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var t=e.document,i=function(){return e.URL||e.webkitURL||e},n=t.createElementNS("http://www.w3.org/1999/xhtml","a"),s="download"in n,o=/Version\/[\d\.]+.*Safari/.test(navigator.userAgent),a=e.webkitRequestFileSystem,r=e.requestFileSystem||a||e.mozRequestFileSystem,l=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},c=0,d=function(e){setTimeout(function(){"string"==typeof e?i().revokeObjectURL(e):e.remove()},4e4)},h=function(e,t,i){for(var n=(t=[].concat(t)).length;n--;){var s=e["on"+t[n]];if("function"==typeof s)try{s.call(e,i||e)}catch(e){l(e)}}},u=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\ufeff",e],{type:e.type}):e},g=function(t,l,g){g||(t=u(t));var p,m,f,v=this,w=t.type,y=!1,T=function(){h(v,"writestart progress write writeend".split(" "))},C=function(){if(m&&o&&"undefined"!=typeof FileReader){var n=new FileReader;return n.onloadend=function(){var e=n.result;m.location.href="data:attachment/file"+e.slice(e.search(/[,;]/)),v.readyState=v.DONE,T()},n.readAsDataURL(t),void(v.readyState=v.INIT)}!y&&p||(p=i().createObjectURL(t)),m?m.location.href=p:void 0===e.open(p,"_blank")&&o&&(e.location.href=p),v.readyState=v.DONE,T(),d(p)},I=function(e){return function(){if(v.readyState!==v.DONE)return e.apply(this,arguments)}},b={create:!0,exclusive:!1};if(v.readyState=v.INIT,l||(l="download"),s)return p=i().createObjectURL(t),void setTimeout(function(){n.href=p,n.download=l,function(e){if(navigator.userAgent.toLowerCase().indexOf("firefox")>-1){var t=window.open(e.href,"_blank");setTimeout(function(){t.document.title=e.download},1e3)}else{var i=new MouseEvent("click");e.dispatchEvent(i)}}(n),T(),d(p),v.readyState=v.DONE});e.chrome&&w&&"application/octet-stream"!==w&&(f=t.slice||t.webkitSlice,t=f.call(t,0,t.size,"application/octet-stream"),y=!0),a&&"download"!==l&&(l+=".download"),("application/octet-stream"===w||a)&&(m=e),r?(c+=t.size,r(e.TEMPORARY,c,I(function(e){e.root.getDirectory("saved",b,I(function(e){var i=function(){e.getFile(l,b,I(function(e){e.createWriter(I(function(i){i.onwriteend=function(t){m.location.href=e.toURL(),v.readyState=v.DONE,h(v,"writeend",t),d(e)},i.onerror=function(){var e=i.error;e.code!==e.ABORT_ERR&&C()},"writestart progress write abort".split(" ").forEach(function(e){i["on"+e]=v["on"+e]}),i.write(t),v.abort=function(){i.abort(),v.readyState=v.DONE},v.readyState=v.WRITING}),C)}),C)};e.getFile(l,{create:!1},I(function(e){e.remove(),i()}),I(function(e){e.code===e.NOT_FOUND_ERR?i():C()}))}),C)}),C)):C()},p=g.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,i){return i||(e=u(e)),navigator.msSaveOrOpenBlob(e,t||"download")}:(p.abort=function(){this.readyState=this.DONE,h(this,"abort")},p.readyState=p.INIT=0,p.WRITING=1,p.DONE=2,p.error=p.onwritestart=p.onprogress=p.onwrite=p.onabort=p.onerror=p.onwriteend=null,function(e,t,i){return new g(e,t,i)})}}()}}),define("DS/InstantMessaging/js/view/RTLoginPanelView",["UWA/Class","UWA/Class/Events","DS/UIKIT/Input/Button","DS/RTProxyDriver/RTLogger","DS/UIKIT/Form","DS/UIKIT/Input/Text"],function(e,t,i,n,s,o){"use strict";return n.debug("RTLoginPanelView load"),e.extend(t,{init:function(e){var t=document.body.offsetWidth;this.globalView=UWA.createElement("div",{class:"RTLoginPanel",id:"RTLoginPanel",styles:{width:"300px",height:"350px",background:"white",position:"fixed",border:"solid 1px ligthgray",padding:"20px",boxShadow:"0px 0px 10px 1px rgba(0, 0, 0, 0.1)",left:t/2-150+"px",top:"200px",borderRadius:"8px",zIndex:4e3}}),this.logForm=new s({fields:[{name:"login",type:"text",label:"Login",placeholder:"Login...",required:!0,value:this.getCookie("3DIMLogin")},{name:"password",type:"password",label:"Password",placeholder:"Password...",required:!0},{name:"server",type:"text",label:"Server to connect to",placeholder:"Server...",required:!0,value:atob(this.getCookie("3DIMServer"))}],buttons:[{type:"submit",value:"Login"}],events:{onSubmit:function(t){document.cookie="3DIMLogin="+t.login,document.cookie="3DIMServer="+btoa(t.server),e.events&&e.events.click&&e.events.click(t)},onInvalid:function(){console.log("You have some errors")},onValid:function(){console.log("You have no errors")}}}).inject(this.globalView)},getView:function(){return this.globalView},getCookie:function(e){for(var t=e+"=",i=document.cookie.split(";"),n=0;n<i.length;n++){for(var s=i[n];" "==s.charAt(0);)s=s.substring(1);if(0==s.indexOf(t))return s.substring(t.length,s.length)}return""}})}),define("DS/InstantMessaging/js/controller/RTEventBusController",["UWA/Class","UWA/Utils","UWA/Class/Events","DS/RTProxyDriver/RTLogger"],function(e,t,i,n){"use strict";n.debug("RTEventBus load");var s={eventName:{STARTCHAT:"STARTCHAT",ONEDITMODECLICK:"ONEDITMODECLICK",ONADDGROUPCLICK:"ONADDGROUPCLICK",STARTVIDEO:"STARTVIDEO",PANELICONISED:"PANELICONISED",ONICONISEPANELCLICK:"ONICONISEPANELCLICK",ONMAXIMIZEDCLICK:"ONMAXIMIZEDCLICK",PANELMAXIMIZED:"PANELMAXIMIZED",ICONISEALLCLICK:"ICONISEALLCLICK",DISPLAYGLISTOFCONTACT:"DISPLAYGLISTOFCONTACT",ONCLICKNOTIFICATION:"ONCLICKNOTIFICATION",LISTSTATUSRECEIVED:"LISTSTATUSRECEIVED",ONADDCONTACT:"ONADDCONTACT",DISPLAYTRASHEDZONE:"DISPLAYTRASHEDZONE",ONELEMENTDRAGSTART:"ONELEMENTDRAGSTART",ONELEMENTDRAGSTOP:"ONELEMENTDRAGSTOP",LOCKDRAGONMAINVIEW:"LOCKDRAGONMAINVIEW",ACTIVEELEMENTDRAGANDDROP:"ACTIVEELEMENTDRAGANDDROP",RESTARTLOGIN:"RESTARTLOGIN",ACTIVEMINIZONE:"ACTIVEMINIZONE",ONPANELDRAGOVER:"ONPANELDRAGOVER",ONPANELDRAGLEAVE:"ONPANELDRAGLEAVE",SIGNOUT:"SIGNOUT",ACTIVEBUDDYSCROLLER:"ACTIVEBUDDYSCROLLER",ONPANELDROP:"ONPANELDROP"}},o=new i;return s.dispatch=function(e,t){o&&o.dispatchEvent(e,t)},s.addEvent=function(e,t){o&&o.addEvent(e,t)},s}),define("DS/InstantMessaging/js/view/RTSearchView",["UWA/Class","UWA/Class/Events","DS/RTProxyDriver/RTLogger","i18n!DS/InstantMessaging/assets/nls/feed"],function(e,t,i,n){"use strict";return i.debug("RTSearchView load"),e.extend(t,{init:function(e){this.isForShareAPI=e.isForShareAPI,this.searchClearIconViewAction=e.searchClearIconViewAction,this.controller=e.controller,this.holderTxt=e.holderTxt,this.timerOn=void 0;var t=this;this.globalView=UWA.createElement("div",{class:"RTSearch",id:"RTSearch"}),this.searchInputView=UWA.createElement("input",{type:"text",placeholder:n.search||"Search ...",events:{focus:function(e){i.debug("RTSearchView Search focus")},blur:function(e){i.debug(t.searchInputView.value)},keyup:function(e){i.debug("RTSearchView keyup"),t.searchClearIconView.style.visibility="visible",""===t.searchInputView.value&&(t.controller.clearAllElement(),t.searchClearIconView.style.visibility="hidden"),t.timerOn&&(clearTimeout(t.timerOn),t.timerOn=void 0),t.timerOn=setTimeout(function(){t.searchInputView.value.length>1&&t.controller.controller.searchContact(t.searchInputView.value,t.isForShareAPI)},400)}}}),this.searchInputView.inject(this.globalView),this.searchIconView=UWA.createElement("span",{class:"fonticon handler fonticon-search",styles:{margin:"auto",color:"#555",fontSize:"1.6em",float:"right"},events:{click:function(){t.dispatchEvent(action.eventName,[]),i.debug(action.eventName)}}}).inject(this.globalView),this.searchClearIconView=UWA.createElement("span",{class:"fonticon handler fonticon-cancel",styles:{margin:"4px",color:"#555",fontSize:"0.9em",float:"right",top:"3px",position:"relative",visibility:"hidden"},events:{click:function(){t.searchClearIconViewAction&&t.searchClearIconViewAction(),t.isForShareAPI||t.controller.clearAllElement(),t.searchInputView.value="",t.searchClearIconView.style.visibility="hidden"}}}).inject(this.globalView),this.searchParamIconView&&(this.searchParamIconView=UWA.createElement("img",{src:this.searchParamIconView}),this.searchParamIconView.inject(this.globalView)),this.resultView=UWA.createElement("div",{class:"RTSearchResultView",id:"RTSearchResultView"}),this.resultView.inject(this.globalView)},getView:function(){return this.globalView},addContactToResultView:function(e){},showResultOfSearch:function(){new UWA.Fx(this.resultView,{duration:250,transition:"linear"}).start({height:"200px"})},hideResultOfSearch:function(){new UWA.Fx(this.resultView,{duration:250,transition:"linear"}).start({height:"0px"})},clearInput:function(){this.searchInputView.value=""}})});var prereqs=["UWA/Class/View","DS/UIKIT/Input/Button","DS/UIKIT/Spinner","DS/UIKIT/Alert","DS/RTProxyDriver/RTLogger","DS/UIKIT/Modal","DS/3DPlayHelper/3DPlayHelper"];define("DS/InstantMessaging/InstantMessaging3DPlayer",prereqs,function(e,t,i,n,s,o,a){"use strict";return s.addLevel("IM3DPlayer","black"),e.extend({setup:function(e){if(s.IM3DPlayer("Init"),this.room_id=e.room_id,!this.room_id)return s.error("InstantMessaging3DPlayer init without room_id");this.ctrl=e.ctrl,this.leader=e.init,this._createContent()},launchCoreview:function(e){e.room_id=this.room_id,e.path=this.path,e.fileName=this.fileName,e.mime=this.mime,this.ctrl.sendToServer("coreview",e)},uploadFile:function(e){this.ctrl.sendToServer("uploadMedia",e)},_createContent:function(){return this.setContainer({tag:"div",class:"IM-3dplayer",styles:{display:"none"},html:[{tag:"div",id:"IMWActionBar",class:"IM-3dplayer-action",styles:{margin:"0px"},html:[{tag:"div",class:"IM-3dplayer-feedback",styles:{width:"170px",height:"40px"}},{tag:"span",class:"IM-3dplayer-close fonticon fonticon-2x fonticon-close",events:{click:this.display3dplayer.bind(this)}}]},{tag:"div",class:"IM-3dplayer-div"}]}),this},inject:function(e){return this.container.inject(e),this},startCoreview:function(){if("none"!==this.container.style.display){var e=this;this._player.setCollabMode(!0),this._player.addCollabCB(function(t,i){e.sendCoreviewAction({arg1:t,arg2:i})})}},sendCoreviewAction:function(e){this.launchCoreview({actions:e})},showModal:function(e){s.IM3DPlayer("Coreview invitation received"),s.IM3DPlayer(e);var t=this,i=new o({closable:!0,header:"<h4>"+e.username+" wants to start a coreview with you</h4>",body:'<div class="thumbFile"><div><b>'+e.fileName+"</b></div></div>",footer:"<button type='button' id='coreviewRefuse' class='btn btn-default'>Refuse</button> <button type='button' id='coreviewAccept' class='btn btn-primary'>Accept</button>"}).inject(document.body);i.getContent().getElements("#coreviewRefuse")[0].addEvent("click",function(){i.hide(),t.destroy()}),i.getContent().getElements("#coreviewAccept")[0].addEvent("click",function(){i.hide(),t.display3dplayer({mime:e.mime,path:e.path,room_id:e.room_id,fileName:e.fileName,coreview:!0}),t.coreviewAccepted=!0}),i.show()},onCoreview:function(e){e.actions?null!=e.actions.accept?e.actions.accept&&this.leader&&this.startCoreview():(this.leader||this.coreviewAccepted)&&this.onCoreviewAction(e.actions):this.showModal(e)},onCoreviewAction:function(e){this._player.performAction(e.arg1,e.arg2)},send:function(){var e=this.getElement(".IM-3dplayer-feedback"),t=this.getElement(".IM-3dplayer-action");t.style.display="inline-flex";var i=this;this._player.getScreenshot({onSuccess:function(s){console.log("URL received");var o=new XMLHttpRequest;o.open("GET",s,!0),o.send(),o.onload=function(s){console.log("svg");o.responseText;i.uploadFile({room_id:i.room_id,mime:"svg",name:i.fileName,file:o.responseText}),new n({visible:!0}).inject(e).add({className:"success",message:"Model shared !"}),setTimeout(function(i){e.innerHTML="",t.style.display="none"},3e3)}}})},display3dplayer:function(e){if("none"===this.container.style.display)e&&(this.mime=e.mime,this.room_id=e.room_id,this.fileName=e.fileName,this.coreview=this.leader,this.path!==e.path&&(this.path=e.path,this.createPlayer(e.fileName)),this.container.style.display="block",this.divTop=this.container.offsetHeight+80,this.container.style.maxHeight="100%",this._player&&this.coreview);else{this.container.style.maxHeight=0;var t=this;this._player&&this._player.setCollabMode&&this._player.removeCollabCB&&(this._player.setCollabMode(!1),this._player.removeCollabCB()),setTimeout(function(){t.container.style.display="none"},600)}},createPlayer:function(e){var t=this.container.getElement(".IM-3dplayer-div"),i={collabmode:this.leader,container:t,input:{asset:this.path},options:{loading:"autoplay",callbacks:{experience:{ExperienceReady:this.onExperienceReady.bind(this)},asset:{LoadingFinished:this.onLoadingFinished.bind(this)}}}};this._player&&this._player.dispose(),this._player=new a(i)},onExperienceReady:function(e){this.coreview?this._player.setCollabMode(!1):this.launchCoreview({actions:{accept:!0}})},onLoadingFinished:function(e){},destroy:function(){this.stopListening(),this.model=null,this._parent()}})}),define("DS/InstantMessaging/js/view/RTMinimizePanelView",["UWA/Class","UWA/Class/Events","DS/UIKIT/Tooltip","DS/RTColors/RTColors","DS/RTProxyDriver/RTLogger"],function(e,t,i,n,s){"use strict";return s.debug("RTMinimizePanelView load"),e.extend(t,{init:function(e){this.views=[],this.expand=!0,this.elementDisplay=!1,this.globalDisplay=!0,this.buddyMinimize=!0,this.displayCss=void 0,this.dontDisplayIcon=e.dontDisplayIcon,this.notifQtyIcon=e.notifQtyIcon,this.notificationStyle=e.notificationStyle;var t=this;-1!=navigator.platform.indexOf("iPhone")||-1!=navigator.platform.indexOf("iPod")||-1!=navigator.platform.indexOf("iPad")?this.globalView=UWA.createElement("div",{class:"RTMinimizePanel",id:"RTMinimizePanel",styles:{position:"absolute"}}):this.globalView=UWA.createElement("div",{class:"RTMinimizePanel",id:"RTMinimizePanel"}),this.iconView=UWA.createElement("div",{styles:{padding:"2px"}}).inject(this.globalView),this.icon=UWA.createElement("div",{styles:{margin:"2px",width:"50px",height:"50px",borderRadius:"8px",border:"1px solid "+n.offline,boxShadow:"0px 0px 10px 1px rgba(0, 0, 0, 0.1)",background:"white","border-radius":"50px",position:"relative"},events:{mouseover:function(){t.icon.style.cursor="pointer"},mouseout:function(){t.icon.style.cursor="default"},click:function(){!t.views.length||t.dontDisplayIcon?((e.OpenBuddyList||t.dontDisplayIcon)&&e.OpenBuddyList(),t.buddyMinimize=!1):t.expand?t.collapseAll():t.expandAll()}}}).inject(this.iconView),this.spanChat=UWA.createElement("span",{class:"fonticon handler fonticon-chat",styles:{fontSize:"1.6em",color:"#005686",margin:"10px 12px"}}).inject(this.icon),this.statusIconMini=UWA.createElement("span",{id:"RTMiniPanelStatus",styles:{width:"16px",height:"16px",background:"grey",borderRadius:"16px",position:"absolute",top:"0px",left:"34px"}}),this.statusIconMini.inject(this.icon),this.notifqtyIconMini=UWA.createElement("span",{id:"RTMiniPanelNotifqty",styles:{width:"16px",height:"16px",background:n.away,color:"white",borderRadius:"16px",position:"absolute",display:"none",bottom:"0px",left:"34px","text-align":"center","font-weight":"bold"}}),this.notifQtyIcon&&this.notifqtyIconMini.inject(this.icon),this.statusIconMiniIcon=UWA.createElement("span",{class:"",styles:{color:"white","font-size":"4px",position:"relative",top:"-6px","font-weight":"bold"}}),this.statusIconMiniIcon.inject(this.statusIconMini),this.buddyIconView=UWA.createElement("div",{styles:{padding:"2px",marginRight:"-60px",overflow:"hidden",display:"none"}}).inject(this.globalView),this.buddyIcon=UWA.createElement("div",{styles:{margin:"2px",width:"50px",height:"50px",borderRadius:"50px",border:"1px solid "+n.offline,background:"white"},events:{mouseover:function(){t.buddyIcon.style.cursor="pointer"},mouseout:function(){t.buddyIcon.style.cursor="default"},click:function(){e.OpenBuddyList(),t.activeBuddyIcon(!1)}}}).inject(this.buddyIconView),UWA.createElement("span",{class:"fonticon handler fonticon-users",styles:{fontSize:"1.6em",color:"rgb(0, 86, 134)",margin:"9px 12px"}}).inject(this.buddyIcon),this.arrowDownView=UWA.createElement("div",{styles:{margin:"2px",width:"50px",height:"14px",display:"none"},events:{mouseover:function(){t.spanDown.style.color="#3D3D3D",t.spanDown.style.cursor="pointer"},mouseout:function(){t.spanDown.style.color=n.offline,t.spanDown.style.cursor="default"},click:function(){t.iconsListView.scrollTop;t.iconsListView.scrollTop+=100}}}).inject(this.globalView),this.spanDown=UWA.createElement("span",{class:"fonticon handler fonticon-down-open",styles:{fontSize:"2em",color:n.offline,position:"relative",bottom:"13px",margin:"0px 11px"}}).inject(this.arrowDownView),this.iconsListView=UWA.createElement("div",{styles:{margin:"2px",maxHeight:"580px",overflow:"hidden",minWidth:"50px",padding:"2px"},events:{mousewheel:function(e){t.iconsListView.scrollTop+=e.deltaY}}}).inject(this.globalView),this.arrowUpView=UWA.createElement("div",{styles:{margin:"2px",width:"50px",height:"14",display:"none"},events:{mouseover:function(){t.spanUp.style.color="#3D3D3D",t.spanUp.style.cursor="pointer"},mouseout:function(){t.spanUp.style.color=n.offline,t.spanUp.style.cursor="default"},click:function(){t.iconsListView.scrollTop;t.iconsListView.scrollTop-=100}}}).inject(this.globalView),this.spanUp=UWA.createElement("span",{class:"fonticon handler fonticon-up-open",styles:{fontSize:"2em",color:n.offline,position:"relative",bottom:"13px",margin:"0px 11px"}}).inject(this.arrowUpView)},getView:function(){return this.globalView},removeAllElements:function(){for(var e=0;e<this.views.length;e++)this.removeElement(this.views[e].idElement)},removeElement:function(e){for(var t=this,i=-1,n=0;n<this.views.length;n++)if(this.views[n].idElement===e){i=n;break}-1!==i&&new UWA.Fx(this.views[i].view,{duration:200,transition:"linear",events:{onComplete:function(e){t.views[i]&&t.views[i].view&&t.views[i].view.destroy(),t.views.splice(i,1)}}}).start({height:0});10===this.views.length&&(new UWA.Fx(this.arrowDownView,{duration:200,transition:"linear",events:{onComplete:function(e){t.arrowDownView.style.display="none"}}}).start({height:0}),new UWA.Fx(this.arrowUpView,{duration:200,transition:"linear",events:{onComplete:function(e){t.arrowUpView.style.display="none"}}}).start({height:0}))},addContact:function(e){for(var t=-1,s=0;s<this.views.length;s++)if(this.views[s].idElement===e.id){t=s;break}if(-1===t){var o=this,a=UWA.createElement("div",{styles:{width:"50px",height:"50px",marginTop:"6px",background:"white",borderRadius:"50px",border:"1px solid "+n.offline},events:{mouseover:function(){a.style.cursor="pointer"},mouseout:function(){a.style.cursor="default"},click:function(){e.events.click(),a.tooltip.destroy(),o.removeElement(e.id)}}});a.tooltip=new i({target:a,body:e.userName,position:"left"}),a.tooltip.getContent().style.zIndex="30000",UWA.createElement("img",{styles:{width:"42px",borderRadius:"42px",margin:"3px"},src:e.pathPicture}).inject(a),this.addElement({idElement:e.id,view:a,contactView:a,position:"bottom",show:!0})}},addNotification:function(e){for(var t=-1,i=0;i<this.views.length;i++)if(this.views[i].idElement===e.id){t=i;break}if(-1===t){var s=this;if(this.notificationStyle)var o="",a={right:"15px","border-radius":"4px",width:"300px",height:"74px",marginTop:"6px",boxShadow:"0px 1px 2px 0px #77797c",overflow:"hidden"};else o="",a={width:"300px",height:"74px",marginTop:"6px",boxShadow:"0px 1px 2px 0px #77797c",overflow:"hidden"};var r=UWA.createElement("div",{id:"RTNotifView",class:o,styles:a,events:{mouseover:function(){r.style.cursor="pointer"},mouseout:function(){r.style.cursor="default"},click:function(){e.events.click(),s.removeElement(e.id)}}}),l=UWA.createElement("div",{styles:{width:"50px",height:"50px",margin:"13px 12px",background:"white",borderRadius:"100%",border:"1px solid "+n.offline,float:"left"},events:{mouseover:function(){l.style.cursor="pointer"},mouseout:function(){l.style.cursor="default"},click:function(){}}}).inject(r);UWA.createElement("img",{styles:{width:"42px",borderRadius:"42px",margin:"3px"},src:e.pathPicture}).inject(l);var c=UWA.createElement("div",{styles:{width:"300px",height:"38px",background:this.notificationStyle?"white":"#005686",textAlign:"left"}}).inject(r),d=UWA.createElement("div",{styles:{height:"38px",display:"flex",flexDirection:"row"}}).inject(c);UWA.createElement("div",{text:e.userName,styles:{width:"150px",color:this.notificationStyle?"#77797c":"white",fontFamily:"arial",fontWeight:"bold",margin:"auto",whiteSpace:"nowrap",overflow:"hidden",float:"left",textOverflow:"ellipsis","margin-bottom":this.notificationStyle?0:"auto"}}).inject(d),UWA.createElement("span",{class:"fonticon handler fonticon-popup",styles:{fontSize:"1.4em",color:"white",width:"38px",float:"left",margin:"auto"}}).inject(d),UWA.createElement("span",{class:"fonticon handler fonticon-cancel",styles:{fontSize:"1.2em",color:"white",width:"38px",float:"left",margin:"auto"},events:{click:function(t){UWA.Event.stopPropagation(t),s.removeElement(e.id)}}}).inject(d);var h=UWA.createElement("div",{styles:{width:"300px",height:"36px",background:"white",textAlign:"left"}}).inject(r),u=UWA.createElement("div",{styles:{margin:"auto",borderRadius:"4px",width:"294px",height:"33px",background:this.notificationStyle?"white":"#F1F1F1",paddingTop:this.notificationStyle?"0":"8px"}}).inject(h);UWA.createElement("div",{text:e.infoTxt,styles:{color:"#3D3D3D",fontFamily:"arial",width:"210px",whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"}}).inject(u),this.addElement({idElement:e.id,view:r,contactView:l,position:"bottom",show:!0});var g=new UWA.Fx(r,{duration:300,transition:"linear"}),p=new UWA.Fx(l,{duration:300,transition:"linear",events:{onComplete:function(e){c.style.display="none",h.style.display="none",r.style.boxShadow="rgb(119, 121, 124) 0px 0px 0px 0px",g.start({width:50,height:50,marginRight:0,borderRadius:"50px"}),l.style.border="1px solid "+n.away,l.style.borderRadius="50px"}}});setTimeout(function(){g.start({marginRight:-250}),p.start({margin:0})},3e3)}else this.receivedMessage(e.id)},addElement:function(e){console.log(e.position);var t=this;if(this.elementDisplay=e.show,"top"===e.position?(console.log("top"),this.views.push({idElement:e.idElement,view:e.view,contactView:e.contactView,show:this.expand||e.show})):(console.log("not top"),this.views.unshift({idElement:e.idElement,view:e.view,contactView:e.contactView,show:this.expand||e.show})),console.log(this.iconsListView),e.view.inject(this.iconsListView,e.position),console.log(this.iconsListView),this.expand||e.show){var i=e.view.offsetWidth,n=e.view.offsetHeight;e.view.style.marginRight=-i+"px";var s=!1,o=new UWA.Fx(e.view,{duration:200,transition:"linear",events:{onAnimate:function(e,i,n){s||(t.iconsListView.scrollTop+=5)},onComplete:function(t){"top"!==e.position&&s&&(s=!1,o.start({marginRight:[-i,0]}))}}});"top"===e.position?o.start({marginRight:[-i,0]}):(s=!0,o.start({height:[0,n]})),t.buddyMinimize&&!this.dontDisplayIcon&&this.activeBuddyIcon(!0)}11===this.views.length&&(this.arrowDownView.style.display="block",this.arrowUpView.style.display="block",new UWA.Fx(this.arrowDownView,{duration:200,transition:"linear"}).start({height:[0,13],marginRight:2}),new UWA.Fx(this.arrowUpView,{duration:200,transition:"linear"}).start({height:[0,13],marginRight:2}))},expandAll:function(){this.expand=!0,this.buddyIcon.style.display="block";var e=new UWA.Fx(this.buddyIcon,{duration:200,transition:"linear"});this.views.length?(e.start(this.elementDisplay?{height:[0,50],marginRight:2}:{marginRight:2}),this.animeElement(0),this.views.length>10&&(this.arrowDownView.style.display="block",(e=new UWA.Fx(this.arrowDownView,{duration:200,transition:"linear"})).start({height:[0,13],marginRight:2}))):e.start({marginRight:2})},collapseAll:function(){var e=this;this.expand=!1,this.elementDisplay=!1,new UWA.Fx(this.buddyIcon,{duration:200,transition:"linear",events:{onComplete:function(t){e.buddyIcon.style.display="none"}}}).start({marginRight:-60}),this.views.forEach(function(e){e.show=!1,new UWA.Fx(e.view,{duration:200,transition:"linear",events:{onComplete:function(t){e.view.style.display="none"}}}).start({marginRight:-60})}),new UWA.Fx(this.arrowDownView,{duration:200,transition:"linear",events:{onComplete:function(t){e.arrowDownView.style.display="none"}}}).start({marginRight:-60}),new UWA.Fx(this.arrowUpView,{duration:200,transition:"linear",events:{onComplete:function(t){e.arrowUpView.style.display="none"}}}).start({marginRight:-60})},animeElement:function(e){var t=!0,i=this;if(this.views[e].show)++e<i.views.length&&i.animeElement(e);else{this.views[e].show=!0;var n=this.views[e].view;n.style.display="block";var s=new UWA.Fx(n,{duration:200,transition:"linear",events:{onAnimate:function(n,o,a){s.currentTime>30&&t&&(t=!1,++e<i.views.length?i.animeElement(e):i.views.length>10&&(i.arrowUpView.style.display="block",new UWA.Fx(i.arrowUpView,{duration:200,transition:"linear"}).start({height:[0,13],marginRight:2})))}}});s.start({marginRight:[-60,0]})}},updateStatus:function(e){this.statusIconMini.style.background=e},updateIcon:function(e){this.statusIconMiniIcon.className=e.name,this.statusIconMiniIcon.style["font-size"]=e.fontSize,this.statusIconMiniIcon.style.top=e.top,this.statusIconMiniIcon.style.left=e.left},updateStatusAndIcon:function(e){"online"===(e=e.toLowerCase())&&(this.updateStatus(n.online),this.updateIcon({fontSize:"9px",top:"-3px",left:"-1px",name:"fonticon handler fonticon-check"})),"offline"===e&&(this.updateStatus(n.offline),this.updateIcon({fontSize:"5px",top:"-4px",left:"-1px",name:""})),"away"===e&&(this.updateStatus(n.away),this.updateIcon({fontSize:"9px",top:"-3px",left:"-1px",name:"fonticon handler fonticon-cancel"})),"busy"===e&&(this.updateStatus(n.busy),this.updateIcon({fontSize:"9px",top:"-3px",left:"-1px",name:"fonticon handler fonticon-minus"})),"dnd"===e&&(this.updateStatus(n.busy),this.updateIcon({fontSize:"9px",top:"-3px",left:"-1px",name:"fonticon handler fonticon-minus"}))},receivedMessage:function(e){for(var t=this,i=-1,s=0;s<this.views.length;s++)if(this.views[s].idElement===e){i=s;break}if(-1!==i){var o=0,a=!1;this.views[i].contactView.style.border="1px solid "+n.offline;var r=setInterval(function(){t.views&&t.views[i]&&t.views[i].contactView?(t.views[i].contactView.style.border=a?"1px solid "+n.offline:"1px solid "+n.away,a=!a,5===++o&&(t.views[i].contactView.style.border="1px solid "+n.away,clearInterval(r))):clearInterval(r)},300)}},activeMiniZone:function(e){if(this.globalDisplay!==e){var t=this;if(e)this.globalDisplay=e,t.globalView.className="RTMinimizePanel",new UWA.Fx(this.globalView,{duration:200,transition:"linear"}).start({marginRight:0});else this.globalDisplay=e,new UWA.Fx(this.globalView,{duration:200,transition:"linear",events:{onComplete:function(e){t.globalView.className="RTMinimizePanelNone"}}}).start({marginRight:-60})}},setNotifQty:function(e){this.notifqtyIconMini.innerText=e},incrementNotifQty:function(e){this.notifqty=Math.min((this.notifqty||0)+(e||1),99),this.setNotifQty(this.notifqty)},razNotifQty:function(e){this.notifqty=0,this.setNotifQty(this.notifqty)},hideNotifQty:function(e){this.notifqtyIconMini.hide()},showNotifQty:function(e){this.notifqtyIconMini.show()},activeBuddyIcon:function(e){var t=this;e?(this.buddyMinimize=!0,this.views.length&&(this.buddyIconView.style.display="block",new UWA.Fx(this.buddyIcon,{duration:200,transition:"linear",events:{onComplete:function(e){new UWA.Fx(t.buddyIconView,{duration:200,transition:"linear"}).start({marginRight:0})}}}).start({height:50}))):(this.buddyMinimize=!1,new UWA.Fx(this.buddyIconView,{duration:200,transition:"linear",events:{onComplete:function(e){new UWA.Fx(t.buddyIcon,{duration:200,transition:"linear",events:{onComplete:function(e){t.buddyIconView.style.display="none"}}}).start({height:0})}}}).start({marginRight:-60}))},destroy:function(){s.debug("RTMinimizePanelView destroy"),this.globalView.destroy()}})}),define("DS/InstantMessaging/js/controller/RTSettingController",[],function(e,t){"use strict";var i={},n={};return i.getSetting=function(e){return n[e]},i.setSetting=function(e,t){n[e]=t},i}),define("DS/InstantMessaging/js/view/RTMsgInfoContactView",["UWA/Class","UWA/Class/Events","DS/RTProxyDriver/RTLogger","i18n!DS/InstantMessaging/assets/nls/feed"],function(e,t,i,n){"use strict";return i.debug("RTMsgInfoContactView load"),e.extend(t,{init:function(e){this.isDisplayed=!0,this.globalView=UWA.createElement("div",{class:"RTMsgInfoContact",id:"RTMsgInfoContact",styles:{left:"0px",right:"0px",border:"solid 2px #D1D4D4",margin:"10px",padding:"4px",color:"#B4B6Ba"}}),this.retryIcon=UWA.createElement("span",{class:"fonticon handler fonticon-attention",styles:{fontSize:"2em",float:"left",margin:"4px"}}).inject(this.globalView),this.msgTextView=UWA.createElement("div",{class:"RTMsgTextWarning",id:"RTMsgTextWarning",text:n.ContactOfflineMessage}).inject(this.globalView)},getView:function(){return this.globalView},display:function(e,t){if(this.isDisplayed!=e)if(this.isDisplayed=e,e){var i=new UWA.Fx(this.globalView,{duration:200,transition:"linear"});this.globalView.style.display="block",i.start({opacity:[0,1]})}else{var s=this;(i=new UWA.Fx(this.globalView,{duration:200,transition:"linear",events:{onComplete:function(e){s.globalView.style.display="none"}}})).start({opacity:[1,0]})}this.isDisplayed&&(t&&n[t]?this.msgTextView.innerText=n[t]:this.msgTextView.innerText=n.ContactOfflineMessage)}})}),define("DS/InstantMessaging/js/model/RTGroupModel",["UWA/Class","DS/RTProxyDriver/RTLogger","UWA/Class/Events"],function(e,t,i){"use strict";return t.debug("RTGroupModel load"),e.extend(i,{init:function(e){this.listOfContact={},this.controller=e.controller,this.groupId=e.groupId,this.groupName=e.groupName,this.groupType=e.groupType},getId:function(){return this.groupId},setId:function(e){this.groupId=e},getName:function(){return this.groupName},setName:function(e){this.groupName=e},getType:function(){return this.groupType},setType:function(e){this.groupType=e},addContact:function(e){e.userId&&void 0===this.listOfContact[e.userId]&&(this.listOfContact[e.userId]=e,this.dispatchEvent("onContactAdded",[e]))},removeContact:function(e){e.userId&&void 0!==this.listOfContact[e.userId]&&(this.dispatchEvent("onContactRemoved",[e]),delete this.listOfContact[e.userId])}})}),define("DS/InstantMessaging/js/view/RTSendMsgView",["UWA/Class","UWA/Class/Events","DS/RTProxyDriver/RTLogger","i18n!DS/InstantMessaging/assets/nls/feed"],function(e,t,i,n){"use strict";return i.debug("RTSendMsgView load"),e.extend(t,{init:function(e){this.controller=e.controller,this.holderTxt=e.holderTxt;var t=this;this.globalView=UWA.createElement("div",{class:"RTSendMsg",id:"RTSendMsg",events:{click:function(e){e.stopPropagation(),t.sendInputView.focus()}}}),this.holderTxtView=UWA.createElement("div",{id:"holderSendMsg",text:this.holderTxt,styles:{position:"absolute","padding-left":"2%","padding-top":"2%",color:"rgb(180, 182, 186)","-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none","z-index":"0"}}).inject(this.globalView),this.sendInputView=UWA.createElement("p",{class:"placeHolderView",contenteditable:"true",spellcheck:"true",events:{keydown:function(e){e.stopPropagation(),""!==t.sendInputView.textContent?t.holderTxtView.style.display="none":t.holderTxtView.style.display="block",13===e.keyCode&&""!==t.sendInputView.textContent&&(t.sendMessage(t.sendInputView.textContent),t.sendInputView.textContent="",t.sendInputView.innerHTML=""),27===e.keyCode&&""===t.sendInputView.textContent&&(t.sendInputView.textContent="",t.sendInputView.innerHTML="")},keyup:function(e){e.stopPropagation(),""!==t.sendInputView.textContent?t.holderTxtView.style.display="none":t.holderTxtView.style.display="block",13===e.keyCode&&""===t.sendInputView.textContent&&(t.sendInputView.textContent="",t.sendInputView.innerHTML="")},paste:function(e){if(!(!!window.MSInputMethodContext&&!!document.documentMode))return!0;i.debug("pasted in IE11 "),e.preventDefault();var n=window.clipboardData.getData("text");t.sendInputView.textContent=n}}}),this.sendInputView.inject(this.globalView)},getView:function(){return this.globalView},sendMessage:function(e){this.controller.sendMessage(e)},SendState:function(e){},focus:function(){this.sendInputView.focus()}})}),define("DS/InstantMessaging/InstantMessagingManager",["DS/UWPClientCode/PublicAPI","DS/RTProxyDriver/RTLogger","DS/UIKIT/Modal","DS/PlatformAPI/PlatformAPI","DS/RTProxyDriver/RTProxyDriver","DS/InstantMessaging/js/controller/RTSettingController","UWA/Class","UWA/Class/Events","UWA/Core","DS/WAFData/WAFData","DS/TopBarProxy/TopBarProxy","DS/TopBarProxy/MenuItem","DS/InstantMessaging/js/view/RTMinimizePanelView","DS/InstantMessagingWebRTC/InstantMessagingWebRTC","DS/InstantMessagingCall/InstantMessagingCall","DS/RTColors/RTColors","DS/MessageBus/MessageBus","i18n!DS/InstantMessaging/assets/nls/feed","DS/RTDriver/RTDetectClient","DS/InstantMessaging/InstantMessaging3DPlayer"],function(e,t,i,n,s,o,a,r,l,c,d,h,u,g,p,m,f,v,w,y){"use strict";var T=!0,C=a.extend(r,{init:function(){t.addLevel("Manager","maroon"),t.Manager("InstantMessagingManager init 14/05/2019"),this.channelToServer="fromwidgetim.ds.com",this.channelToWidget="towidgetim.ds.com",this.channelFromWidget="im.ds.com",this.channelFromSwym="fromswym.im.ds.com",this.channelToSwym="toswym.im.ds.com",this.channelCoreview="collab.im.ds.com",this.channelToWidgetTenant=function(e){return"towidget."+e+".im.ds.com"},this.channelToRTC="toRTC.im.ds.com",this.listOfStatus={Offline:"Offline",Away:"Away",Busy:"Busy",Online:"Online"},this.listOfSysStatus={},this.isTopBarInited=!1,this.isWidgetLoaded=!1,this.coreview=!0,this.coreviewAccepted=!0,this.convSubscribed={},this.widget_identifier=o.getSetting("widget_identifier")||"X3DIMSG_AP",o.setSetting("widget_identifier",this.widget_identifier),"disabled"===e.getApplicationConfiguration("app.rtc.callexperience")&&(T=!1),T&&w.setCallVersion("2"),UWA.Utils.getQueryString(document.URL,"coreview")||UWA.Utils.getQueryString(document.URL,"coreviewVR")||localStorage.getItem("enable3DPlayCollab")&&"false"!==localStorage.getItem("enable3DPlayCollab")||"enabled"===e.getApplicationConfiguration("app.swymfeature.activateSketchCoreview")||e.getApplicationConfiguration("app.swymfeature.activateWBCollab")&&"false"!==e.getApplicationConfiguration("app.swymfeature.activateWBCollab")?(this.coreview=!0,localStorage.setItem("enable3DPlayCollab",!0),UWA.Utils.getQueryString(document.URL,"coreviewVR")?this.coreviewVR=!0:(this.coreviewVR=!1,window.sessionStorage.setItem("3DPlay.PersistedAnnotationsEnabled","true"),window.sessionStorage.setItem("3DMessaging.PersistedAnnotationsEnabled","true"))):localStorage.setItem("enable3DPlayCollab",!1)},fromWidgetListener:function(e){var i=e.evenement,n=e.data,o=e.action;if("startX3DPhoto"===i)return t.Manager("todo");if("GETLOGINOKDATA"===i){if(this.isWidgetLoaded=!0,!this.loginOKData)return!0;if(this.publishToWidget("CONNECTED",this.loginOKData),this.loginOKData.rooms&&this.loginOKData.rooms.length)for(var a=0;a<this.loginOKData.rooms.length;a++)this.publishToWidget("ROOM",this.loginOKData.rooms[a]);return!0}return"logger"===i?t.Manager(e.data):"initCoreview"==o?this.initCoreview(e):"stopCollab"==o?this.stopCoreview(e):"getCallInfo"===i&&n&&this.convSubscribed[n.dmId]?this.dispatchCallInfo(n):"subConv"===i&&n&&this.convSubscribed[n.dmId]?this.dispatchConvInfo(n):void("CONNECTED"==i||"publish"!==o&&!n||s.dispatch(i,[n]))},fromSwymListener:function(e){return t.Manager("Received from swym : "+JSON.stringify(e)),!e||!e.action&&!e.method||e.action&&e.method&&e.action!=e.method?t.error("fromSwymListener bad format"):(!e.action&&e.method&&(e.action=e.method),e.action,t.error("fromSwymListener unknown action "+e.action))},callInfo:function(e){if(!e||!e.dmId)return t.error("callInfo bad args");this.convSubscribed[e.dmId]=this.convSubscribed[e.dmId]||{},this.convSubscribed[e.dmId].callState=e,t.Manager("callInfo state:"+e.callState+"; dm:"+e.dmId),this.dispatchCallInfo(e)},dispatchCallInfo:function(e){return e&&e.dmId?this.convSubscribed[e.dmId]?this.publishToWidget("CallInfo",this.convSubscribed[e.dmId].callState,"towidgetim.dmId:"+e.dmId):t.error("dispatchCallInfo cant find conv "+e.dmId):t.error("dispatchCallInfo bad args")},convInfo:function(e){if(!e||!e.dmId)return t.error("convInfo bad args");this.convSubscribed[e.dmId]=this.convSubscribed[e.dmId]||{},this.convSubscribed[e.dmId].convInfo=e,t.Manager("convInfo :"+JSON.stringify(e)+"; dm:"+e.dmId),this.dispatchConvInfo(e)},dispatchConvInfo:function(e){return e&&e.dmId?this.convSubscribed[e.dmId]?this.publishToWidget("convInfo",this.convSubscribed[e.dmId].convInfo,"towidgetim.dmId:"+e.dmId):t.error("dispatchConvInfo cant find conv "+e.dmId):t.error("dispatchConvInfo bad args")},initCollab:function(e){var i;t.Manager("initCollab on channel "+e.channel),n.subscribe(e.channel,(i=this,function(){i.fromSwymListener(arguments[0])}))},startCollab:function(e){t.Manager("startCollab on channel "+e.channel),this.initCoreview(e)},initCoreview3DPlay:function(e){return e.path=e.mediaUrl,e.mime=e.config3DPlay?e.config3DPlay.input.asset.format:null,e.fileName=e.mediaTitle,this.initCoreview(e)},stopCoreview:function(e){this.coreviewAccepted=!1,this.sendToServer("coreview",e)},initCoreview:function(e){if(!e||!e.users&&!e.login&&!e.logins)return t.error("initCoreview bad args");if(e.logins=e.logins||[],!e.users&&"object"==typeof e.login&&e.login.length&&(e.users=e.login),!e.logins.length&&e.users)for(var i in e.users)e.logins.push(e.users[i].login);if(!e.logins.length)return t.error("can not start coreview without logins");e.init=!0,delete e.action,delete e.method,this.sendToServer("coreview",e)},init3DPlayer:function(e){this.player3d||(this.player3d=new y(Object.assign({},e,{ctrl:this})),this.player3d.inject(document.body))},initVRPlayer:function(e){t.Manager(" initVRPlayer not implemented yet")},initPlayer:function(e){if(this.coreviewVR)return this.initVRPlayer(e);this.init3DPlayer(e)},displayPlayer:function(e){if(this.coreviewVR)return t.Manager(" display coreview VR not implemented yet");this.player3d.display3dplayer(e)},giveDataToPlayer:function(e){if(this.coreviewVR)return t.Manager(" giveDataTo coreview VR not implemented yet");this.player3d.onCoreview(e)},giveDataToWidget:function(e,t,i){this.publishToWidget(i||"dataCollabReceived",e,t||"collab.im.ds.com")},coreviewListnr:function(e){return this.coreview?e.init?(delete e.init,this.coreviewAccepted=!0,n.publish(e.channel||"collab.im.ds.com",Object.assign({action:"startCollab",isMaster:!0},e)),this.sendToServer("coreview",Object.assign({invitation:!0},e))):void(this.player3d||this.coreviewVR?this.giveDataToPlayer(e):this.coreviewAccepted?(this.giveDataToWidget(e,e.channel||this.channelCoreview,e.action),"stopCollab"==e.action&&delete this.coreviewAccepted):!this.coreviewAccepted&&e.invitation?e.collabExperienceOrigin?document.IMCall&&document.IMCall.vmCall.$store.getters.is_accepted_room(e.room_id)?this.acceptCoreview(e,!0):t.Manager("received a collabExperience coreview on another device"):this.showCoreviewInvitModal(e):t.Manager("Received coreview data but it has not been accepted (yet)")):t.Manager("Received coreview but the feature is not enabled.")},showCoreviewInvitModal:function(e){t.Manager("Coreview invitation received"),t.Manager(e),e.fileName=e.fileName||e.data&&e.data.mediaId||" ";var n=this;this.modal&&this.modal.destroy&&this.modal.destroy(),this.modal=new i({closable:!0,header:"<h4>Coreview invitation</h4>",body:'<div class="thumbFile"><div><b>'+(e.username?e.username:"Someone")+" wants to start a coreview with you</b></div></div>",footer:"<button type='button' id='coreviewRefuse' class='btn btn-default'>Refuse</button> <button type='button' id='coreviewAccept' class='btn btn-primary'>Accept</button>"}).inject(document.body),this.modal.getContent().getElements("#coreviewRefuse")[0].addEvent("click",function(){n.modal.hide(),n.coreviewAccepted=!1}),this.modal.getContent().getElements("#coreviewAccept")[0].addEvent("click",function(){n.modal.hide(),n.acceptCoreview(e)}),this.modal.show()},acceptCoreview:function(e,t){if(!e||!e.room_id)return console.error("can not accept coreview without room_id");this.modal&&this.modal.destroy&&this.modal.destroy(),this.coreviewAccepted=!0,e.action="acceptCoreview",t?this.giveDataToWidget(e,e.channel||this.channelCoreview,"startCollab"):this.publishToSwym(e)},publishToSwym:function(e){t.Manager("Publishing "+e.action+" on "+this.channelToSwym),t.Manager(e),n.publish(this.channelToSwym,e)},sendToServer:function(e,i){if(!e||!i)return t.error("sendToServer misses args");t.Manager("Sending "+e+" to server"),t.Manager(i),s.dispatch(e,[i])},findCurrentTenant:function(){var i=window.sessionStorage.getItem("3DIMfavoriteTenant")||UWA.Utils.getQueryString(document.URL,"tenant3DIM");if(i)return t.Manager("findCurrentTenant forced the tenant "+i),i;if(1==this.resources.length&&this.resources[0].platformid?(i=this.resources[0].platformid,t.Manager("findCurrentTenant selected the only tenant of instanciation params : "+i)):0===window.location.href.search(/https:\/\/([A-z0-9]+)-[A-z0-9]+-[A-z0-9]+-[A-z0-9]+/)?(i=window.location.href.split(/https:\/\//)[1].split("-")[0],t.Manager("findCurrentTenant selected the tenant from url : "+i)):(i=e.getApplicationConfiguration("app.mp.tenant"),t.Manager("findCurrentTenant selected the PublicAPI.app.mp.tenant "+i)),!i){try{var n,s=JSON.parse(e.user.properties.dashboards)}catch(e){t.error("unable to parse user dahboards")}for(n in s)if(s[n].platformId){i=s[n].platformId,t.Manager("findCurrentTenant selected the first PublicAPI.user.properties.dashboards tenant "+i);break}}return t.Manager("findCurrentTenant ends with "+i),i},getServicesInfos:function(e,i){this.passportUrl=(i?i.passportUrl:null)||n.getApplicationConfiguration("app.urls.passport");var s,o,a=[];if(i&&i.ressources)for(s in i.ressources.instantMessaging)o=i.ressources.instantMessaging[s],a.push({platformid:o.id.toLowerCase(),displayname:o.displayName,"3dmessaging":o.url,"3dswym":i.ressources.swym[s]?i.ressources.swym[s].url:null,"3dpassport":this.passportUrl});else a=i;t.Manager("instanciation resources : "),t.table(a),this.resources=a;var r=this.findCurrentTenant();if(this.devEnv)return e(Object.assign(i,{platformid:r,"3dswym":"none"}));require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(i){i.getPlatformServices({onComplete:function(i){try{i=JSON.parse(JSON.stringify(i).toLowerCase())}catch(e){for(var n=0;n<i.length;n++)for(var s in i[n])i[n].hasOwnProperty(s)&&(i[n][s.toLowerCase()]=i[n][s],delete i[n][s])}if(t.Manager("i3DXCompassPlatformServices resources : "),t.table(i),r){r=r.toLowerCase();var o=i.concat(a);for(var n in t.Manager("all resources : "),t.table(o),o)if(o[n].platformid&&o[n].platformid.toLowerCase()===r)return t.Manager("getServicesInfos ends with resources of selected tenant : "),t.table(o[n]),e(o[n]);return t.error("getServicesInfos failed to find the tenant "+r+" in resources. Using the first one "+o[0].platformid),e(o[0])}if(e)return t.Manager("getServicesInfos ends with resources of first tenant : "),t.Manager(i[0]),e(i[0]);t.error("InstantMessagingManager no callback")}})})},standaloneSetup:function(t,i){this.devEnv=t.devEnv,this.noMiniPanels=t.noMiniPanels;var s,o=(s=this,function(i){i.url=i["3dmessaging"]||t.url,i.passportUrl=s.passportUrl||i["3dpassport"],i.platformId=i.platformid||i.platformId||require("DS/TopFrame/TopFrame")._tenantId,i.platformIdName=i.displayname,i.username=(e.user.firstName?e.user.firstName+" "+e.user.lastName:null)||t.userName||t.username,i.login=e.user.login||i.login||t.userId||t.login,i.swymUrl=i["3dswym"],i.topBarId=i.topBarId||"instantMessagingMenu",i.appName=t.appName||i.appName||n.getApplicationConfiguration("app.usage.service"),i.callContainer=t.callContainer,i.tenants=i.allOptions,i.devEnv=t.devEnv,i.bypassTopbarMenu=!1===e.getApplicationConfiguration("app.rtc.enable")||"false"===e.getApplicationConfiguration("app.rtc.enable"),s.setup(i),s.connectToServer()});this.getServicesInfos(o,t)},setup:function(e){var i;for(var o in this.options=e,this.url=e.url,this.passportUrl=e.passportUrl,this.platformId=e.platformId,this.username=e.username,this.login=e.login,this.devEnv=e.devEnv,this.swymUrl=e.swymUrl,this.topBarId=e.topBarId,this.active3DIM=e.tenants,this.appName=e.appName,this.bypassTopbarMenu=e.bypassTopbarMenu,n.subscribe("fromx3dphoto.ds.com",function(e){var t=e.evenement,i=e.data;"upload"===t&&s.dispatch("uploadMedia",[i])}),n.subscribe(this.channelToServer,(i=this,function(){i.fromWidgetListener(arguments[0])})),n.subscribe(this.channelFromSwym,function(e){return function(){e.fromSwymListener(arguments[0])}}(this)),n.subscribe(this.channelFromWidget,function(e){"getStatus"==e.action?s.dispatch("GETSTATUS",e):"getAllStatus"==e.action&&s.dispatch(s.eventName.GETALLSTATUS,[e.users])}),s.addEvent(s.eventName.CONNECTED,function(e){return function(){e.connectedListnr(arguments[0])}}(this)),s.addEvent(s.eventName.ONPRESENCERECEIVED,function(e){return function(){e.presenceListnr(arguments[0])}}(this)),s.addEvent(s.eventName.ONMESSAGERECEIVED,function(e){return function(){e.messageListnr(arguments[0])}}(this)),s.addEvent("ROOM",function(e){return function(){e.roomListnr(arguments[0])}}(this)),s.addEvent("COREVIEW",function(e){return function(){e.coreviewListnr(arguments[0])}}(this)),s.addEvent("callInfo",function(e){return function(){e.callInfo(arguments[0])}}(this)),s.addEvent("convInfo",function(e){return function(){e.convInfo(arguments[0])}}(this)),s.addEvent("DISCONNECTED",function(e){return function(){e.disconnectedListnr(arguments[0])}}(this)),this.eventsFromDriver=["DISCONNECTED","CONNECTED","GROUP","ROOM","ONMESSAGERECEIVED","ONDATARECEIVED","ONARCHIVERECEIVED","ONPRESENCERECEIVED","RESULTOFSEARCH","COREVIEW","miscellaneous","onLeaveRoom","onJoinRoom","mediaReceived","discovered"],this.eventsFromDriver)!function(e,t){s.addEvent(e,function(i){t.publishToWidget(e,i)})}(this.eventsFromDriver[o],this);n.subscribe(this.channelToRTC,function(){s.dispatch("toRTC",arguments[0])}),function(e){s.addEvent("conversation",function(i){if(i&&i.tenant){let n=i.tenant.toLowerCase();t.Manager("Event conversation - Received event "+i.action+" on "+n);const s=e.channelToWidgetTenant(n);e.publishToWidget("conversation",i,s)}else t.Manager("Event conversation - Missing tenant")})}(this),T?(this.appName=this.appName||(window.location.origin.contains("-3dswym.")?"swymSA":null),p.init({audiovideoV2:T,base_url:this.url,platformId:this.platformId,appName:this.appName,swymUrl:this.swymUrl,callContainer:this.callContainer})):this.webrtcCtrl=new g({audiovideoV2:T,platformId:this.platformId,nwayActivated:!0,appName:this.appName,login:this.login,userName:this.userName,swymUrl:this.swymUrl,doLogRTC:!1,url:"toremove",platformId:"toremove"})},disconnectedListnr:function(e){delete this.convSubscribed,this.convSubscribed={}},connectedListnr:function(e){e.userId||t.error("unable to retrieve user's login"),this.login=e.userId,this.username=e.username,t.Manager("Connected to RTC server "+this.login),o.setSetting("userLogin",e.userId),this.loginOKData=e,this.loginOKData.options=this.options,this.loginOKData.appName=this.appName,this.publishToWidget("CONNECTED",e),this.isLoggedIn=!0,this.selfPresenceListnr(e.status),this.devEnv||this.isTopBarInited||this.bypassTopbarMenu||this.initTopBar(this.noMiniPanels)},roomListnr:function(e){this.loginOKData.rooms=this.loginOKData.rooms||[],this.loginOKData.rooms.push(e)},connectToServer:function(){if(!this.url)return t.error("no 3DMessaging url");t.Manager("connectToServer NodeJS "+this.url+" user "+this.login+" on tenant "+this.platformId+" and passportUrl "+this.passportUrl);var e={nameApp:"3DIM",driverName:"NODE",url:this.url,domaineName:this.platformId,passportUrl:this.passportUrl,username:this.username,devEnv:this.devEnv,credentials:{jid:this.login||UWA.Utils.getQueryString(document.URL,"login3DIM")||"noLogin",user:this.login,password:null}};s.dispatch(s.eventName.SETDRIVER,[e])},publishToWidget:function(e,t,i){n.publish(i||this.channelToWidget,{evenement:e,data:t})},load3DIMW:function(){if(this.devEnv)return!0;this.noMiniPanels||this.miniPanels.razNotifQty(),this.hideGlobalIcon(),this.openInSidePanel()},openInSidePanel:function(){window.location.href+="/sidepanel:"+this.widget_identifier},openInDiv:function(){var e=this,t=require("DS/TopBar/TopBar");this.w3DIM?this.w3DIM.style.display="block":(this.w3DIM=UWA.createElement("div",{class:"W3DIM-main-div",styles:{position:"absolute",top:"43px",left:"0px",right:"0px",bottom:"0px",heigth:"auto",width:"100%",background:"#ffffff","z-index":"15"},html:[{tag:"div",class:"W3DIM-player"}]}),this.w3DIM.inject(document.body),this.loadWidget({app:this.widget_identifier,el:this.w3DIM.getElement(".W3DIM-player")}),t.addEvent({events:{"click-extrabtn":function(){var i=document.body.offsetWidth;document.body.offsetHeight;new UWA.Fx(e.w3DIM,{duration:600,transition:"linear",events:{onComplete:function(){e.w3DIM.style.display="none",t.set("brand",e.oldBrand.brand),t.set("application",e.oldBrand.app),e.showGlobalIcon()}}}).start({left:i}),t.toggleExtraButton()}}})),this.oldBrand={brand:t._model.get("brand"),app:t._model.get("application")},t.set("brand","3DMessaging"),t.set("application",""),t.setExtraButtonOptions({tooltip:"Exit 3DMessaging",fonticon:"fonticon-cancel"}),t.toggleExtraButton();var i=document.body.offsetWidth;document.body.offsetHeight;setTimeout(function(){new UWA.Fx(e.w3DIM,{duration:400,transition:"linear"}).start({left:[i,0]})},10)},loadWidget:function(e){require("DS/i3DXCompass/i3DXCompass").getAppInfo({appId:e.app,onComplete:function(t){if(UWA.log(t),t){var i=t.platformId,n=l.merge({},i),s={el:e.el,parent:!1,preview:!0,appId:e.app,data:n,header:!1};if(!t||!(t.checksum&&t.launchInfos||t.platforms&&t.platforms[0]&&t.platforms[0].checksum&&t.platforms[0].launchInfos))throw new Error("Could not get valid Config from MyApps for the App "+s.appId);s=l.extend(s,{widgetId:l.is(t.launchInfos)?t.launchInfos:t.platforms[0].launchInfos,isolationLevel:l.is(t.isolationLevel)?t.isolationLevel:t.platforms[0].isolationLevel,token:l.is(t.checksum)?t.checksum:t.platforms[0].checksum}),require("DS/TopFrame/TopFrame")._loadModules(["DS/UWPClientCode/WidgetFactory","DS/TopFrame/Environment"]).then(function(e){var t=e[0],i=e[1];t.load(s,function(){},i)})}}})},initTopBar:function(e){t.Manager("initTopBar");var i,n,o=e?v.myStatus||"Presence":"3DMessaging",a=this;this.topBarProxy=new d({id:this.topBarId});var r=function(e){return function(t){e===o?console.log("  .--,-``-.                              \n /   /     '.      ,---,      .--.--.    \n/ ../        ;   .'  .' `\\   /  /    '.  \n\\ ``\\  .`-    ',---.'     \\ |  :  /`. /  \n \\___\\/   \\   :|   |  .`\\  |;  |  |--`   \n      \\   :   |:   : |  '  ||  :  ;_     \n      /  /   / |   ' '  ;  : \\  \\    `.  \n      \\  \\   \\ '   | ;  .  |  `----.   \\ \n  ___ /   :   ||   | :  |  '  __ \\  \\  | \n /   /\\   /   :'   : | /  ;  /  /`--'  / \n/ ,,/  ',-    .|   | '` ,/  '--'.     /  \n\\ ''\\        ; ;   :  .'      `--'---'   \n \\   \\     .'  |   ,.'                   \n  `--`-,,-'    '---'"):"Signout"===e?(RTEventBusController.dispatch(RTEventBusController.eventName.SIGNOUT,[]),a.isLoggedIn=!1):a.isLoggedIn&&s.dispatch(s.eventName.SETSTATUS,{myStatus:e,statusMsg:e})}};for(i in this.subMenu=[],this.listOfStatus){var l=new h({label:v["Offline"==i||"Away"==i?"Appear"+i:i],checked:"Online"===i,onExecute:r(i)});l.set("statusName",i),this.subMenu.push(l)}for(n in 0,this.active3DIM)this.active3DIM[n].imActive&&0;this.topBarProxy.setContent({profile:[{label:o,submenu:this.subMenu,onExecute:r(o)}]}),s.addEvent(s.eventName.LOGOUT,function(){a.subMenu.forEach(function(e){e.set("disabled",!0)}),a.isTopBarInited=!1}),this.isTopBarInited=!0},initGlobalIcon:function(){var e;this.miniPanels=new u({dontDisplayIcon:!0,notificationStyle:!0,notifQtyIcon:!0,OpenBuddyList:(e=this,function(){e.load3DIMW()})}),this.miniPanels.getView().inject(document.body),document.getElementById("RTMiniPanelStatus").style.textAlign="center"},showGlobalIcon:function(){if(this.noMiniPanels)return!0;this.miniPanels.globalView.show()},hideGlobalIcon:function(){if(this.noMiniPanels)return!0;this.miniPanels.globalView.hide(),this.miniPanels.hideNotifQty()},isWidgetOpen:function(){return!this.noMiniPanels&&this.miniPanels.globalView.isHidden()},selfPresenceListnr:function(e){t.Manager("Self presence received "+e),this.myStatus=e,o.setSetting("userStatus",e),this.noMiniPanels||this.miniPanels.updateStatusAndIcon(e),this.updateSubMenu(e)},updateSubMenu:function(e){this.subMenu?this.subMenu.forEach(function(t){t.get("statusName")==e?t.set("checked",!0):t.set("checked",!1),t.set("disabled",!1)}):t.error("no subMenu")},presenceListnr:function(e){e.userId.split("@")[0]===this.login&&this.selfPresenceListnr(e.status)},messageListnr:function(e){this.isWidgetOpen()||"system"==e.origin||this.addNotification(e)},addNotification:function(e){if(this.noMiniPanels)return!0;var i;this.miniPanels.addNotification({id:e.roomId,pathPicture:this.swymUrl+"/api/user/getpicture/login/"+e.login,userName:e.username,infoTxt:e.msg?e.msg.unescapeHTML():e.data?"Content received.":"Error : No message.",events:{click:(i=this,function(){t.Manager("click on notif "+e.roomId),i.openRoom(e)})}}),this.miniPanels.incrementNotifQty(),this.miniPanels.showNotifQty()},openRoom:function(e){this.isWidgetOpen()||this.load3DIMW(),this.isWidgetLoaded?this.publishToWidget("DISPLAY_ROOM",e):this.loginOKData.expectedRoom=e.roomId||e.room_id},initFrameEvents:function(e){if(!e)return t.error("TopFrame not found");var i;e.addEvent("onRightPanelOpened",(i=this,function(t){"messaging"==e._visibleXApp||-1!=window.location.href.indexOf("/sidepanel:"+i.widget_identifier)?i.hideGlobalIcon():i.showGlobalIcon()})),e.addEvent("onRightPanelClosed",function(e){return function(t){e.showGlobalIcon()}}(this))}}),I=document.RTCManager||new C;return document.RTCManager=I,I}),define("DS/InstantMessaging/InstantMessaging",["DS/UWPClientCode/PublicAPI","DS/RTProxyDriver/RTLogger","DS/PlatformAPI/PlatformAPI","DS/RTProxyDriver/RTProxyDriver","DS/InstantMessaging/js/controller/RTSettingController","DS/InstantMessagingCall/InstantMessagingCall"],function(e,t,i,n,s,o){"use strict";t.info("InstantMessaging load");var a={},r=function(i){if(!i)return null;if(!e||!e.user||!e.user.properties)return t.error("InstantMessaging can not find user properties via PublicAPI");var n,s,o,a,r;if(s=window.sessionStorage.getItem("3DIMfavoriteTenant"))t.info("InstantMessaging selected via sessionStorage the tenant "+s);else try{if(!(s=e.getApplicationConfiguration("app.mp.tenant")))for(n in o=JSON.parse(e.user.properties.dashboards))if(o[n].platformId){s=o[n].platformId;break}t.info("InstantMessaging selected via PublicAPI the tenant "+s)}catch(e){t.info("InstantMessaging can not find dashboards via PublicAPI")}for(n in!s&&i.instantMessaging[0]&&(s=i.instantMessaging[0].id),i.instantMessaging)if(i.instantMessaging[n].id==s){a=i.instantMessaging[n];break}if(!a)return UWA.log("InstantMessaging init failed with ressources : "+JSON.stringify(i.instantMessaging),"error");if(t.info("InstantMessaging selected the ressource "+JSON.stringify(a)),i.swym)for(n=0;n<i.swym.length&&(!(r=i.swym[n])||!r.id||r.id!=s);n++);return a.swym=r.url,a};return a.init=function(i,n){var o=UWA.Utils.getQueryString(document.URL,"devEnv3diM")||i.devEnv3diM;r(i.ressources)||i.ressources&&i.ressources.instantMessaging&&i.ressources.instantMessaging[0];return!0===e.getApplicationConfiguration("app.rtc.disable")?t.info("InstantMessaging disabled by app.rtc.disable"):(s.setSetting("aloneManager",!0),require(["DS/InstantMessaging/InstantMessagingManager"],function(e){o&&({url:i.url||UWA.Utils.getQueryString(document.URL,"server3DIM"),id:"hyper3dsy",devEnv:!0},i.login=UWA.Utils.getQueryString(document.URL,"login3DIM"),i.devEnv=!0),i.noMiniPanels=!0,e.standaloneSetup(i)}),!0)},a}),define("DS/InstantMessaging/js/view/RTElementView",["UWA/Class","UWA/Class/Events","DS/UIKIT/Spinner","DS/InstantMessaging/js/controller/RTSettingController","DS/RTProxyDriver/RTProxyDriver","DS/RTProxyDriver/RTLogger","DS/InstantMessaging/js/controller/RTEventBusController","DS/RTColors/RTColors","i18n!DS/InstantMessaging/assets/nls/feed"],function(e,t,i,n,s,o,a,r,l){"use strict";return o.debug("RTElementView load"),e.extend(t,{init:function(e){this.editMode=!1,this.addBorder=!1,this.lockDropData=!1,this.controller=e.controller,this.statusElement=e.statusElement,this.pictureElement=e.pictureElement,this.pictureElement.picture.draggable=!1,this.titleElement=e.titleElement,this.titleElement.txt=this.htmlDecode(this.titleElement.txt),this.subTitleElement=e.subTitleElement,this.expander=e.expander,this.fonticonElement=e.fonticonElement,this.groupId=e.groupId;var t=this;if("searchChatId"===this.groupId)this.globalView=UWA.createElement("div",{class:"RTElement",id:"RTElement",events:{mouseover:function(){t.editMode||(t.globalView.style.cursor="pointer",t.globalView.style.background="rgb(204,227,240)")},mouseout:function(){t.editMode||(t.globalView.style.cursor="default",t.globalView.style.background="white")}}}),this.expander&&(this.RTElementExpander=UWA.createElement("span",{class:"fonticon handler fonticon-right-open",styles:{position:"relative",left:"0px",margin:"auto",color:"#555",width:"20px",height:"20px",marginTop:"6px"},events:{click:function(){t.pictureElement.eventName&&t.dispatchEvent(t.pictureElement.eventName,[]),o.debug("RTElementView  RTElementExpander Click : "+t.pictureElement.eventName)}}}).inject(this.globalView)),this.pictureElement&&this.pictureElement.picture&&(this.RTElementPictureView=this.pictureElement.picture.cloneNode(!0),this.RTElementPictureView.className="RTElementPicture",this.RTElementPictureView.draggable="false",this.globalView.appendChild(this.RTElementPictureView)),this.fonticonElement&&(this.fonticonElementView=UWA.createElement("span",{class:"fonticon handler "+this.fonticonElement,styles:{margin:"auto",color:"#555",fontSize:"1.2em",marginTop:"4px"}}).inject(this.globalView)),this.RTElementTxtInfoView=UWA.createElement("div",{class:"RTElementTxtInfo",id:"RTElementTxtInfo",events:{click:function(){t.editMode||t.titleElement.eventName&&(o.debug("RTElementView RTElementTxtInfoView Click : "+t.pictureElement.eventName),t.controller.dispatchEvent(t.pictureElement.eventName,[t.controller]))}}}),this.titleElement&&this.titleElement.txt&&(this.RTTitleElementView=UWA.createElement("div",{class:"RTTitleElement",id:"RTTitleElement",text:this.titleElement.txt}),this.RTTitleElementView.inject(this.RTElementTxtInfoView)),this.RTElementSubView=UWA.createElement("div",{class:"RTElementSub",id:"RTElementSub"}),this.RTElementStatusView=UWA.createElement("div",{class:"RTElementStatus",id:"RTElementStatus",style:{background:r.offline}}),this.RTElementStatusView.inject(this.globalView),this.RTElementStatusIcon=UWA.createElement("span",{class:"",styles:{color:"white","font-size":"4px",position:"relative",top:"-6px","font-weight":"bold"}}),this.RTElementStatusIcon.inject(this.RTElementStatusView),this.RTSubTitleElementView=UWA.createElement("div",{class:"RTSubTitleElement",id:"RTSubTitleElement"}),this.RTSubTitleElementView.inject(this.RTElementSubView),this.RTElementSubView.inject(this.RTElementTxtInfoView),this.RTElementTxtInfoView.inject(this.globalView),this.addIcon=UWA.createElement("span",{class:"fonticon handler fonticon-plus",styles:{margin:"auto 5px",color:"#555",fontSize:"1em",float:"right",position:"relative",display:"none"},events:{click:function(){o.debug("RTElementView ONADDCONTACT"+t.id);var e={userId:t.controller.getId(),userName:t.controller.getUserName(),login:t.controller.getLogin(),status:t.controller.getStatus()};a.dispatch(a.eventName.ONADDCONTACT,[{user:e,group:"_"}])}}}).inject(this.globalView),this.removeIcon=UWA.createElement("span",{class:"fonticon handler fonticon-cancel-circled",styles:{margin:"4px",color:"#555",fontSize:"0.9em",float:"right",top:"3px",position:"relative",display:"none"},events:{click:function(){o.debug("RTElementView Remove"+t.id),t.controller.sendRemove()}}}).inject(this.globalView),e.displayNumberOfcontact&&(this.numberOfContactView=UWA.createElement("div",{styles:{color:"#555",fontSize:"1em",float:"right",position:"relative",margin:"6px"}}).inject(this.globalView)),this.ChangeNameInputView=UWA.createElement("input",{type:"text",placeholder:"Add group...",styles:{height:"32px",width:"100%",flex:"1",webkitFlex:"1",msFlex:"1",textAlign:"left",marginLeft:"10px",display:"none",fontSize:"16px",margin:"1px",outline:"none",paddingLeft:"1%",border:"0px"},events:{blur:function(e){o.debug("RTElementView ChangeNameInputView - onblur"),""!==t.ChangeNameInputView.value&&t.ChangeNameInputView.value!==t.ChangeNameInputView.placeholder&&s.dispatch(s.eventName.CREATEGROUP,[t.ChangeNameInputView.value])},keyup:function(e){o.debug("RTElementView ChangeNameInputView - keyup"),13===e.keyCode&&""!==t.ChangeNameInputView.value&&t.ChangeNameInputView.value!==t.ChangeNameInputView.placeholder&&s.dispatch(s.eventName.CREATEGROUP,[t.ChangeNameInputView.value])}}}),this.ChangeNameInputView.inject(this.globalView);else{this.globalView=UWA.createElement("div",{class:"RTContactElement",id:"RTContactElement",styles:{overflow:"hidden",float:"left",width:"84px",height:"84px",margin:"1px"},events:{mouseover:function(){t.editMode||(t.globalView.style.cursor="pointer")},mouseout:function(){t.editMode||(t.globalView.style.cursor="default")},click:function(){t.pictureElement.eventName&&(o.debug("RTElementView RTElementTxtInfoView Click : "+t.titleElement.eventName),t.controller.dispatchEvent(t.pictureElement.eventName,[t.controller]))}}});var c=n.getSetting("defaultAvatarURL")||"./resources/en/1/webapps/InstantMessaging/assets/avatarDefault.png";if(this.pictureElement.picture.complete)this.RTElementPictureView=this.pictureElement.picture.cloneNode(!0),this.RTElementPictureView.style.width="48px",this.RTElementPictureView.style["border-radius"]="48px",this.RTElementPictureView.style.margin="4px";else{this.pictureElement.picture.onload=function(){t.RTElementPictureView.destroy(),t.RTElementPictureView=t.pictureElement.picture.cloneNode(!0),t.RTElementPictureView.style.width="48px",t.RTElementPictureView.style["border-radius"]="48px",t.RTElementPictureView.style.margin="4px",t.RTElementPictureView.draggable=!1,t.globalView.insertBefore(t.RTElementPictureView,t.globalView.firstChild)},this.pictureElement.picture.onerror=function(){o.debug("RTContactController : User avatar has not been found, setting the default one. User login:"),t.RTElementPictureView.destroy(),t.RTElementPictureView=UWA.createElement("img",{draggable:"false",src:c,styles:{height:"48px",margin:"4px","border-radius":"48px",draggable:"false"}}),t.globalView.insertBefore(t.RTElementPictureView,t.globalView.firstChild)};var d=UWA.createElement("div",{styles:{height:"84px",padding:"10px"}});(new i).inject(d).show();this.RTElementPictureView=d}this.RTElementPictureView.className="RTContactPicture",this.RTElementPictureView.draggable="false",this.globalView.appendChild(this.RTElementPictureView),this.titleElement&&this.titleElement.txt&&(this.RTTitleElementView=UWA.createElement("div",{class:"RTTitleElement",id:"RTTitleElement",styles:{width:"100%",height:"25px",color:"black"},text:this.titleElement.txt}),this.RTTitleElementView.inject(this.globalView)),this.RTElementName=UWA.createElement("div",{class:"RTElementName",id:"RTElementName",styles:{width:"90%",overflow:"hidden",textOverflow:"ellipsis",margin:"auto"}}),this.RTElementName.inject(this.RTTitleElementView),this.RTElementStatusView=UWA.createElement("div",{class:"RTContactStatus",id:"RTContactStatus",styles:{width:"24px",height:"24px",background:r.offline,"margin-top":"-80px","margin-left":"56px",position:"relative","border-radius":"100%",border:"2px solid white"}}),this.RTElementStatusView.inject(this.globalView),this.RTElementStatusIcon=UWA.createElement("span",{class:"",styles:{color:"white","font-size":"6px",position:"relative",top:"0px","font-weight":"bold"}}),this.RTElementStatusIcon.inject(this.RTElementStatusView)}if(void 0!==this.statusElement){var h=n.getSetting("RTCStatus");this.subTitleElement=l.Offline||"Offline",this.RTElementStatusView.style.background=r.offline,this.RTElementStatusIcon.className="",this.RTElementStatusIcon.style["font-size"]="searchChatId"===this.groupId?"4px":"6px",h&&(this.statusElement===h.Online&&(this.RTElementStatusView.style.background=r.online,this.subTitleElement=l.Online||"Online",this.RTElementStatusIcon.className="fonticon handler fonticon-check",this.RTElementStatusIcon.style["font-size"]="searchChatId"===this.groupId?"8px":"10px"),this.statusElement===h.Busy&&(this.RTElementStatusView.style.background=r.busy,this.subTitleElement=l.Busy||"Busy",this.RTElementStatusIcon.className="fonticon handler fonticon-minus",this.RTElementStatusIcon.style["font-size"]="searchChatId"===this.groupId?"8px":"10px"),this.statusElement===h.Away&&(this.RTElementStatusView.style.background=r.away,this.subTitleElement=l.Away||"Away",this.RTElementStatusIcon.className="fonticon handler fonticon-cancel",this.RTElementStatusIcon.style["font-size"]="searchChatId"===this.groupId?"8px":"10px"))}else this.RTElementStatusView.style.display="none";this.subTitleElement?(this.RTSubTitleElementView&&this.RTSubTitleElementView.setText(this.subTitleElement),this.RTTitleElementView.style.top="0px"):this.RTSubTitleElementView&&(this.RTSubTitleElementView.style.display="none"),this.initListner()},initListner:function(){var e=this;a.addEvent(a.eventName.ONELEMENTDRAGSTART,function(t){e.controller.getId()===t.userId?e.setDropData(!1):e.setDropData(!0)}),a.addEvent(a.eventName.ACTIVEELEMENTDRAGANDDROP,function(t){t?(e.lockDropData=!t,e.setDropData(t)):(e.setDropData(t),e.lockDropData=!t)})},getView:function(){return this.globalView},setBorder:function(e){},updateStatus:function(e){if(void 0!==e&&this.RTElementStatusView){if("none"===this.RTElementStatusView.style.display)this.RTElementStatusView.style.display="inline-block",new UWA.Fx(this.RTElementStatusView,{duration:200,transition:"linear"}).start({opacity:[0,1]});this.statusElement=e,this.subTitleElement=l.Offline||"Offline",this.RTElementStatusView.style.background=r.offline,this.RTElementStatusIcon.className="",this.RTElementStatusIcon.style["font-size"]="searchChatId"===this.groupId?"4px":"6px";var t=n.getSetting("RTCStatus");if(t&&(this.statusElement===t.Online&&(this.RTElementStatusView.style.background=r.online,this.subTitleElement=l.Online||"Online",this.RTElementStatusIcon.className="fonticon handler fonticon-check",this.RTElementStatusIcon.style["font-size"]="searchChatId"===this.groupId?"8px":"10px"),this.statusElement===t.Busy&&(this.RTElementStatusView.style.background=r.busy,this.subTitleElement=l.Busy||"Busy",this.RTElementStatusIcon.className="fonticon handler fonticon-minus",this.RTElementStatusIcon.style["font-size"]="searchChatId"===this.groupId?"8px":"10px"),this.statusElement===t.Away&&(this.RTElementStatusView.style.background=r.away,this.subTitleElement=l.Away||"Away",this.RTElementStatusIcon.className="fonticon handler fonticon-cancel",this.RTElementStatusIcon.style["font-size"]="searchChatId"===this.groupId?"8px":"10px")),this.subTitleElement){if(this.RTSubTitleElementView)this.RTSubTitleElementView.style.display="inline-block",new UWA.Fx(this.RTSubTitleElementView,{duration:200,transition:"linear"}).start({opacity:[0,1]}),this.RTSubTitleElementView&&this.subTitleElement&&this.RTSubTitleElementView.setText(this.subTitleElement);this.RTTitleElementView&&(this.RTTitleElementView.style.top="0px")}}},setExpand:function(e){var t=0;e&&(t=90),this.RTElementExpander.style.mozTransform="rotate("+t+"deg)",this.RTElementExpander.style.webkitTransform="rotate("+t+"deg)",this.RTElementExpander.style.oTransform="rotate("+t+"deg)",this.RTElementExpander.style.transform="rotate("+t+"deg)"},setEditMode:function(e){this.editMode=e,this.editMode?(this.removeIcon.style.display="block",this.globalView.style.background="#ffbb69",this.numberOfContactView.style.display="none"):(this.removeIcon.style.display="none",this.numberOfContactView.style.display="block",this.addBorder?this.globalView.style.background="#f3f4f5":this.globalView.style.background="#ffffff")},showRemoveElement:function(e){this.removeIcon.style.display=e?"block":"none"},showAddElement:function(e){this.addIcon.style.display=e?"block":"none"},displayNumberOfContact:function(e){this.numberOfContactView&&this.numberOfContactView.setText(e)},setChangeName:function(e){this.editMode=e,this.editMode?(this.ChangeNameInputView.style.display="block",this.RTElementTxtInfoView.style.display="none"):(this.ChangeNameInputView.style.display="none",this.RTElementTxtInfoView.style.display="block")},setDraggable:function(e,t){if(this.globalView.draggable=e,e){var i=this;this.globalView.ondragstart=function(e){a.dispatch(a.eventName.ONELEMENTDRAGSTART,[{userId:i.controller.getId(),groupId:i.controller.groupId}]);var t={protocol:"3DXContent",version:"1.0",data:{items:[{serviceId:"3DMessaging",contact:{userId:i.controller.getId(),userName:i.controller.getUserName(),login:i.controller.getLogin(),status:i.controller.getStatus(),contactGroupId:i.controller.groupId}}]}},n=JSON.stringify(t);o.debug("RTElementView Drag data : "+n),e.dataTransfer.setData("text",n),"searchChatId"!==i.groupId&&"Recents"!==i.groupId&&"Support"!==i.groupId&&a.dispatch(a.eventName.DISPLAYTRASHEDZONE,[!0])},this.globalView.ondragend=function(e){o.debug("RTElementView Drag data end"),a.dispatch(a.eventName.DISPLAYTRASHEDZONE,[!1]),a.dispatch(a.eventName.ONELEMENTDRAGSTOP,[{userId:i.controller.getId(),groupId:i.groupId}])}}else this.globalView.ondragstart=""},setDropData:function(e){if(!this.lockDropData)if(e){var t=this;this.globalView.ondrop=function(e){o.debug("RTElementView Drop data"),e.preventDefault();var i=e.dataTransfer.getData("text"),n=void 0;if((i=JSON.parse(i))&&"3DMessaging"===i.data.items[0].serviceId&&(n=i.data.items[0].contact),n&&n.userId!==t.controller.getId()){s.dispatch(s.eventName.CREATEGROUP,["GROUPTMP"]),a.dispatch(a.eventName.ONADDCONTACT,[{user:n,group:"GROUPTMP"}]),s.dispatch(s.eventName.REMOVECONTACT,{user:n.userId,group:"_"});var r={userId:t.controller.getId(),userName:t.controller.getUserName(),login:t.controller.getLogin(),status:t.controller.getStatus()};s.dispatch(s.eventName.REMOVECONTACT,{user:r.userId,group:"_"}),a.dispatch(a.eventName.ONADDCONTACT,[{user:r,group:"GROUPTMP"}]),a.dispatch(a.eventName.DISPLAYGLISTOFCONTACT,["GROUPTMP"])}},this.globalView.ondragover=function(e){e.preventDefault(),t.dragEnter=!0,t.RTElementPictureView.style.border="2px solid "+r.online,a.dispatch(a.eventName.LOCKDRAGONMAINVIEW,[!0])},this.globalView.ondragleave=function(e){o.debug("RTElementView drag Leave"),t.dragEnter&&(t.dragEnter=!1,t.RTElementPictureView.style.border="",a.dispatch(a.eventName.LOCKDRAGONMAINVIEW,[!1]))}}else this.globalView.ondrop="",this.globalView.ondragover="",this.globalView.ondragleave=""},sendAddContact:function(e){a.dispatch(a.eventName.ONADDCONTACT,[e])},htmlDecode:function(e){if(!e)return null;var t=e.replace(/&gt;/g,">");return t=(t=(t=(t=t.replace(/&lt;/g,"<")).replace(/&quot;/g,'"')).replace(/&apos;/g,"'")).replace(/&amp;/g,"&")}})}),define("DS/InstantMessaging/js/view/RTBottomBarView",["UWA/Class","UWA/Class/Events","DS/InstantMessaging/js/controller/RTEventBusController","DS/RTProxyDriver/RTProxyDriver","DS/RTProxyDriver/RTLogger","i18n!DS/InstantMessaging/assets/nls/feed"],function(e,t,i,n,s,o){"use strict";return s.debug("RTBottomBarView load"),e.extend(t,{init:function(e){this.controller=e.controller,this.editMode=!1,this.dragEnter=!1;var t=this;this.globalView=UWA.createElement("div",{class:"RTBottomBar",id:"RTBottomBar",styles:{height:"60px",border:"3px dashed #EA4F37",margin:"20px",borderRadius:"3px",display:"none",zIndex:3e3}}),this.iconTrashView=UWA.createElement("span",{class:"fonticon handler fonticon-trash",styles:{margin:"12px",color:"grey",fontSize:"1.4em",float:"left",cursor:"default"}}),this.iconTrashView.inject(this.globalView),this.divTrashView=UWA.createElement("div",{styles:{float:"left",color:"#EA4F37",width:"170px",height:"100%",position:"relative"}}),this.divTrashView.inject(this.globalView),this.textTrashView=UWA.createElement("p",{text:o.DropContactHere,styles:{margin:"0",position:"absolute",top:"50%",transform:"translate(0, -50%)"}}),this.textTrashView.inject(this.divTrashView),i.addEvent(i.eventName.DISPLAYTRASHEDZONE,function(e){!0===e?setTimeout(function(){t.globalView.style.display="block",new UWA.Fx(t.globalView,{duration:200,transition:"linear"}).start({opacity:[0,1]})},200):t.globalView.style.display="none"}),this.globalView.ondrop=function(e){var i=e.dataTransfer.getData("text");if(i&&(i=JSON.parse(i))&&i.data&&i.data.items&&"3DMessaging"===i.data.items[0].serviceId){var s=i.data.items[0].contact;s&&(s.idGroup?n.dispatch(n.eventName.REMOVEGROUP,s.idGroup):n.dispatch(n.eventName.REMOVECONTACT,{user:s.userId,group:s.contactGroupId})),t.dragEnter=!1,t.globalView.style.border="3px dashed #EA4F37",t.iconTrashView.style.color="#EA4F37",t.textTrashView.style.color="#EA4F37"}},this.globalView.ondragover=function(e){e.preventDefault(),t.dragEnter=!0,t.globalView.style.border="3px dashed #844138",t.iconTrashView.style.color="#844138",t.textTrashView.style.color="#844138"},this.globalView.ondragleave=function(e){s.debug("RTBottomBarView ondragleave ondragleave"),t.dragEnter&&(t.dragEnter=!1,t.globalView.style.border="3px dashed #EA4F37",t.iconTrashView.style.color="#EA4F37",t.textTrashView.style.color="#EA4F37")}},getView:function(){return this.globalView}})}),define("DS/InstantMessaging/js/view/RTPanelView",["UWA/Class","UWA/Class/Events","DS/RTProxyDriver/RTLogger","DS/InstantMessaging/js/controller/RTEventBusController","DS/InstantMessaging/js/controller/RTSettingController"],function(e,t,i,n,s){"use strict";return i.debug("RTPanelView load"),e.extend(t,{init:function(e){i.debug("RTPanelView init"),this.controller=e.controller,this.sizeOnY=e.sizeOnY,this.originXPos=e.originXPos,this.originYPos=e.originYPos,this.oldXPos=e.originXPos,this.oldYPos=e.originYPos,this.minimumSize=e.minimumSize,this.minimumResize=e.minimumResize,this.panelLarger=e.panelLarger,this.panelId=e.panelId,this.iconeIconise=e.iconeIconise,this.isMinimize=!0,this.isIconise=!1,this.dragEnter;this.globalView=UWA.createElement("div",{class:"RTPanel",id:"RTPanel",styles:{bottom:this.originYPos+"px",right:this.originXPos+"px",height:this.minimumSize+"px",width:this.panelLarger+"px"}});var t=this;this.globalView.ondrop=function(e){e.stopPropagation(),e.preventDefault()},this.globalView.ondragover=function(e){if(e.dataTransfer&&(e.dataTransfer.files&&e.dataTransfer.files.length>0||e.dataTransfer.items&&e.dataTransfer.items.length>0||e.dataTransfer.types.length>0)){if(!s.getSetting("activeShareFile")&&"file"==e.dataTransfer.items[0].kind)return i.debug("File Sharing not activated");for(var o=!0,a=0;a<e.dataTransfer.types.length;a++)"webrtc"==e.dataTransfer.types[a]&&(o=!1);if(!o)return!0;e.preventDefault(),t.dragEnter=!0,n.dispatch(n.eventName.ONPANELDRAGOVER,[t.panelId])}},this.globalView.ondragend=function(e){t.dragEnter&&(t.dragEnter=!1,n.dispatch(n.eventName.ONPANELDRAGLEAVE,[t.panelId]))}},getView:function(){return i.debug("RTPanelView getView"),this.globalView},addElement:function(e){if(i.debug("RTPanelView addElement"),e){e.inject(this.globalView);new UWA.Fx(e,{duration:250,transition:"linear"})}},minimize:function(){i.debug("RTPanelView minimize")},iconise:function(e){(i.debug("RTPanelView iconise"),this.isMinimize=!0,this.isIconise=!0,this.globalView.style.display="block",e)?(this.setHeight(this.minimumSize),this.setWidth(this.minimumSize)):new UWA.Fx(this.globalView,{duration:200,transition:"linear"}).start({height:42,width:42,bottom:88,right:13,borderRadius:48})},maximize:function(){i.debug("RTPanelView maximize"),this.isMinimize=!1,this.isIconise=!1,this.originYPos=0,this.globalView.style.display="flex",new UWA.Fx(this.globalView,{duration:200,transition:"linear"}).start({height:this.sizeOnY,width:this.panelLarger,borderRadius:"3px",bottom:this.originYPos+"px"})},resizeOn:function(e){i.debug("RTPanelView resizeOn");var t=this;window.onmousemove=function(e){var i=t.globalView.getBoundingClientRect();t.sizeOnY=i.height+(i.top-e.clientY+20),t.sizeOnY<=t.minimumResize&&(t.sizeOnY=t.minimumResize);var n=document.body.offsetHeight;t.sizeOnY>=n-100&&(t.sizeOnY=n-100),t.globalView.style.height=t.sizeOnY+"px",t.controller.dispatchEvent("panelIsResized",[])},window.onmouseup=function(e){window.onmousemove=null}},resizeOff:function(){i.debug("RTPanelView resizeOff"),document.onmousemove=null},getOriginPosition:function(){return i.debug("RTPanelView getOriginPosition"),{xPosition:this.originXPos,yPosition:this.originYPos}},getOldPosition:function(){return i.debug("RTPanelView getOldPosition"),{xPosition:this.oldXPos,yPosition:this.oldYPos}},setOriginPosition:function(e){i.debug("RTPanelView setOriginPosition"),this.oldXPos=this.originXPos,this.oldYPos=this.originYPos,null!=e.originXPos&&(this.originXPos=e.originXPos),null!=e.originYPos&&(this.originYPos=e.originYPos)},move:function(e,t){i.debug("RTPanelView move");var n=this.panelLarger+10;(t.buddyIcon||t.buddyIcon&&t.chatIsIconise)&&(n=36),"right"===e&&(n=-n),this.originXPos=this.originXPos+n>0?this.originXPos+n:this.originXPos,new UWA.Fx(this.globalView,{duration:250,transition:"linear"}).start({right:this.originXPos+"px",bottom:this.originYPos+"px"})},moveToOrigin:function(){i.debug("RTPanelView moveToOrigin"),new UWA.Fx(this.globalView,{duration:250,transition:"linear"}).start({right:this.originXPos+"px",bottom:this.originYPos+"px"})},closePanel:function(){i.debug("RTPanelView closePanel"),this.globalView.destroy()},setDisplayPanel:function(e){i.debug("RTPanelView setDisplayPanel"),e?(this.globalView.style.display="block",this.globalView.classList.add("RTPanelSafariFix"),this.globalView.style.right=this.originXPos+"px"):(this.globalView.style.display="none",this.globalView.classList.remove("RTPanelSafariFix"))},getDisplayPanel:function(){return i.debug("RTPanelView getDisplayPanel"),"none"!==this.globalView.style.display},getSizeOnY:function(){return i.debug("RTPanelView getSizeOnY"),this.sizeOnY},setNotif:function(e){i.debug("RTPanelView setNotif")},setZindex:function(e){i.debug("RTPanelView setZindex"),this.globalView.style.zIndex=e},setHeight:function(e){i.debug("RTPanelView setHeight"),that.globalView.style.height=e+"px"},setWidth:function(e){i.debug("RTPanelView setWidth"),that.globalView.style.width=e+"px"},isAnIcon:function(){return i.debug("RTPanelView isAnIcon"),this.isIconise},getWidth:function(){return this.panelLarger}})}),define("DS/InstantMessaging/js/view/RTSendDataView",["UWA/Class","UWA/Class/Events","DS/InstantMessaging/js/controller/RTEventBusController","DS/RTProxyDriver/RTLogger","DS/W3DXComponents/Views/Item/TileView","UWA/Class/Model","i18n!DS/InstantMessaging/assets/nls/feed"],function(e,t,i,n,s,o,a){"use strict";return n.debug("RTSendDataView load"),e.extend(t,{init:function(e){this.isDisplayed=!1,this.dragEnter=!1,this.panelId=e.panelId,this.timeToClose=void 0,this.globalView=UWA.createElement("div",{class:"RTSendData",id:"RTSendData",styles:{left:"0px",right:"0px","border-radius":"3px","flex-direction":"row",position:"absolute",top:"42px",bottom:"32px",background:"white",opacity:"0.9",display:"none"}}),this.borderView=UWA.createElement("div",{class:"RTSendDataBorder",id:"RTSendDataBorder",styles:{margin:"20px",position:"absolute",top:"0px",bottom:"0px",left:"0px",right:"0px",border:"3px dashed #B4B6BA",color:"#B4B6BA"}}).inject(this.globalView),this.infoView=UWA.createElement("div",{class:"RTSendDataBorder",id:"RTSendDataBorder",styles:{position:"absolute",margin:"0px",top:"50%",transform:"translate(0, -50%)",width:"100%"}}).inject(this.borderView),this.sendDataView=UWA.createElement("span",{class:"fonticon handler fonticon-popup",styles:{fontSize:"2em",marginLeft:"10px"}}).inject(this.infoView),this.msgTextView=UWA.createElement("div",{class:"RTSendDataText",id:"RTSendDataText",text:a.SendDataMsg}).inject(this.infoView);var t=this;this.globalView.ondrop=function(i){e.events.ondrop(i),t.dragEnter=!1,t.borderView.style.border="3px dashed #B4B6BA",t.borderView.style.color="#B4B6BA",t.display(!1)},this.globalView.ondragover=function(e){t.dragEnter=!0,t.borderView.style.border="3px dashed #368ec4",t.borderView.style.color="#368ec4",t.timeToClose&&(clearTimeout(t.timeToClose),t.timeToClose=void 0),t.timeToClose=setTimeout(function(){t.display(!1)},1e3)},this.globalView.ondragleave=function(e){n.debug("Leave"),t.dragEnter&&(t.dragEnter=!1,t.borderView.style.border="3px dashed #B4B6BA",t.borderView.style.color="#B4B6BA")}},getView:function(){return this.globalView},generateViewFromNetvibes:function(e){if(!e)return!1;var t,i,a,r,l,c,d,h=new DOMParser;try{i=(t=h.parseFromString(e,"text/xml")).getElementsByClassName("item-title")[0].innerHTML,a=t.getElementsByClassName("item-preview")[0].innerHTML,l=(c=(d=t.getElementsByClassName("item-feedinfo-image")[0])&&d.getAttribute?d.getAttribute("style"):null)?c.substring(c.indexOf('"')+1,c.lastIndexOf('"')):null,r=t.getElementsByClassName("item-time")[0].innerHTML}catch(e){return n.debug(e),!1}if(!i||"string"!=typeof i)return!1;try{var u=new o({image:l,title:i,subtitle:r,content:a}),g=new s({model:u});return g=g.render().getContent(),l||(g.getElementsByClassName("tile-header")[0].style.display="none"),g.getElementsByClassName("tile-sub-container")[0].style.width="100%",g.getElementsByTagName("progress")&&(g.getElementsByTagName("progress")[0].style.display="none"),g.innerHTML}catch(e){return n.debug("RTSendDataView unable to construct TileView : "+e),!1}},generateViewFromTile:function(e){if(!e)return!1;for(var t=document.activeElement.contentWindow.document.getElementsByClassName(" tile-title"),i=0;i<t.length;i++){if(t[i].innerHTML===e.displayName){var n=t[i].parentElement.parentElement.parentElement.cloneNode(!0);return(n=n.children[1]).removeChild(n.children[2]),n.children[1].removeChild(n.children[1].children[3]),n.children[1].removeChild(n.children[1].children[3]),n.children[1].children[3]&&n.children[1].removeChild(n.children[1].children[3]),n.innerHTML}}return!1},generateViewFromJson:function(e,t){var i=new o({image:e.displayPreview,icon:e.displayIcon,title:e.displayName,subtitle:e.objectType,content:e.content}),n=new s({model:i});n=n.render().getContent(),i.image||i._attributes.image?n.getElementsByTagName("img")&&n.getElementsByTagName("img")[0]&&n.getElementsByTagName("img")[0].setAttribute("onerror",'this.onerror=null; this.parentElement.style.display="none"'):n.getElementsByClassName("tile-header")[0].style.display="none",n.getElementsByClassName("tile-sub-container")[0].style.width="100%",n.getElementsByTagName("progress")&&(t?n.getElementsByTagName("progress")[0].style.width="100%":n.getElementsByTagName("progress")[0].style.display="none");for(var a=n.getElementsByClassName("tile-icon"),r=0;r<a.length;r++)0==a[r].src.indexOf("fonticon:")&&(a[r].outerHTML="<span style='position:absolute' class='fonticon fonticon-"+a[r].src.replace("fonticon:","")+"'></span>");return n.innerHTML},generateViewFromUrl:function(e){return!(!e||"string"!=typeof e)&&'<a href="'+e+'" target="_blank" >'+e+"</a>"},generateViewFromImage:function(e){if(!e||"string"!=typeof e)return!1;if(0==e.indexOf("<img")){var t=document.createElement("div");t.innerHTML=e,e=t.firstChild.src}return'<img onerror="this.onerror=null; this.style.display=\'none\';" src="'+e+'"/>'},getURLFromImageString:function(e){if(!e||"string"!=typeof e)return!1;if(0!=e.indexOf("<img"))return!1;var t=document.createElement("div");return t.innerHTML=e,t.firstChild.src},generateViewFromLink:function(e){if(!e||"string"!=typeof e)return!1;var t=document.createElement("div");t.innerHTML=e;var i=t.getElementsByTagName("a"),n=i&&i.length?i[0]:null;return!!n&&(n.target="_blank",(t=document.createElement("div")).appendChild(n),t.innerHTML)},generateViewFromFile:function(e){if(!(e&&e.fileId&&e.fileName&&e.fileLength))return n.debug("RTSendDataView generateViewFromFile bad args");var t=this.generateViewFromJson({displayIcon:"fonticon:doc-text-inv",displayName:a.fileTransfer,subtitle:e.fileName,content:e.fileName},!1);return t="<div id='"+e.fileId+"' style='width:100%'>"+t+"</div>"},display:function(e){if(this.isDisplayed!==e)if(this.isDisplayed=e,e){var t=new UWA.Fx(this.globalView,{duration:200,transition:"linear"});this.globalView.style.display="block",t.start({opacity:[0,.9]})}else{var i=this;(t=new UWA.Fx(this.globalView,{duration:200,transition:"linear",events:{onComplete:function(e){i.globalView.style.display="none"}}})).start({opacity:[.9,0]})}}})}),define("DS/InstantMessaging/js/view/RTGroupView",["UWA/Class","UWA/Class/Events","DS/InstantMessaging/js/view/RTSearchView","DS/InstantMessaging/js/view/RTElementView","DS/InstantMessaging/js/controller/RTEventBusController","DS/RTProxyDriver/RTProxyDriver","DS/RTProxyDriver/RTLogger","DS/UIKIT/Input/Text","DS/UIKIT/Scroller","i18n!DS/InstantMessaging/assets/nls/feed","DS/InstantMessaging/js/controller/RTSettingController","DS/RTColors/RTColors"],function(e,t,i,n,s,o,a,r,l,c,d,h){"use strict";return a.debug("RTGroupView load"),e.extend(t,{init:function(e){this.numberOfContact=0,this.pictureListPreview=[],this.expand=0,this.controller=e.controller,this.groupType=e.groupType,this.idGroup=e.idElement,this.isDraggable=e.isDraggable,this.isHidden=!1,this.dragEnter=!1,this.displayNumberOfcontact=e.displayNumberOfcontact,this.isLocked=e.isLocked,this.titleElement=void 0,this.resizeViewFX=void 0;var t=this;if("searchChatId"===this.idGroup)this.globalView=UWA.createElement("div",{class:"RTGroupSearch",id:"RTGroupSearch"});else{this.globalView=UWA.createElement("div",{class:"RTGroupContact",id:"RTGroupContact"}),this.globalPreview=UWA.createElement("div",{class:"RTGroupPreview",id:"RTGroupPreview",events:{mouseover:function(e){e.stopPropagation(),t.globalView.style.cursor="pointer"},mouseout:function(e){e.stopPropagation(),t.globalView.style.cursor="default"},click:function(e){e.stopPropagation(),a.debug("Group"),s.dispatch(s.eventName.ACTIVEELEMENTDRAGANDDROP,[!1]),s.dispatch(s.eventName.ACTIVEBUDDYSCROLLER,[!1]),t.setDisplayListOfContact(!0)}}}),this.globalPreview.inject(this.globalView),this.picturePreview=UWA.createElement("div",{class:"RTGroupPicturePreview",id:"RTGroupPicturePreview"}),this.picturePreview.inject(this.globalPreview),this.pView=[];for(var i=0;i<4;i++)this.pView.push(UWA.createElement("img",{draggable:!1,styles:{width:"50%",height:"50%",float:"left",border:"1px solid white",display:"none"}})),this.pView[i].inject(this.picturePreview);this.groupNameView=UWA.createElement("div",{class:"RTGroupNamePreview",id:"RTGroupNamePreview",text:this.htmlDecode(this.idGroup)}),this.groupNameView.inject(this.globalPreview),this.listOfContactView=UWA.createElement("div",{class:"RTGroupListContact",id:"RTGroupListContact"}),this.scrollerView=new l({element:UWA.createElement("div",{class:"scrollable-body",styles:{height:"100%",margin:"auto",background:"white",position:"absolute",left:"0px",right:"0px",bottom:"0px","margin-left":"300px",display:"none","z-index":"1"},html:this.listOfContactView})}).inject(this.globalView),this.listOfContactView&&(this.closeListOfContactView=UWA.createElement("div",{events:{mouseover:function(){t.closeListOfContactView.style.cursor="pointer"},mouseout:function(){t.closeListOfContactView.style.cursor="default"},click:function(){a.debug("Group"),t.groupNameInput&&(t.expand&&""!==t.groupNameInput.getValue()&&"Add Name"!==t.groupNameInput.getValue()?(s.dispatch(s.eventName.ACTIVEELEMENTDRAGANDDROP,[!0]),s.dispatch(s.eventName.ACTIVEBUDDYSCROLLER,[!0]),t.setDisplayListOfContact(!1),t.groupNameInput.getValue()!==t.htmlDecode(t.idGroup)&&o.dispatch(o.eventName.RENAMEGROUPVIEW,[{oldName:t.idGroup,newName:t.groupNameInput.getValue()}])):t.groupNameInput.elements.container.style.border="1px solid "+h.busy)}}}),this.leftArrowIcon=UWA.createElement("span",{class:"fonticon handler fonticon-left-open",styles:{fontSize:"2em",float:"left",color:"#77797c",marginTop:"6px"}}),this.leftArrowIcon.inject(this.closeListOfContactView),this.closeListOfContactView.inject(this.listOfContactView),this.groupNameInput=new r({placeholder:c.AddName,value:this.htmlDecode(this.idGroup),events:{onKeyDown:function(e){t.groupNameInput.elements.container.style.border=""}}}),this.isLocked&&this.groupNameInput.disable(),this.groupNameInput.inject(this.listOfContactView),this.contactsView=UWA.createElement("div",{class:"RTGroupContactsView",id:"RTGroupContactsView"}),this.contactsView.inject(this.listOfContactView),this.isDraggable&&this.setDraggable(!0))}void 0!==e.isHidden&&this.setIsHidden(e.isHidden),this.displayMsg=void 0,this.initListner()},initListner:function(){var e=this;s.addEvent(s.eventName.DISPLAYGLISTOFCONTACT,function(t){e.idGroup===t&&"GROUPTMP"===e.idGroup&&(e.setDisplayListOfContact(!0),s.dispatch(s.eventName.ACTIVEBUDDYSCROLLER,[!1]),a.debug("RTGroupView : Group creation => rename GROUPTMP."))}),s.addEvent(s.eventName.ACTIVEELEMENTDRAGANDDROP,function(t){e.setDropData(t)}),s.addEvent(s.eventName.ONELEMENTDRAGSTART,function(t){e.idGroup===t.groupId&&"searchChatId"===e.idGroup&&e.setActiveResultOfSearch(!1)}),s.addEvent(s.eventName.ONELEMENTDRAGSTOP,function(t){e.idGroup===t.groupId&&"searchChatId"===e.idGroup&&e.setActiveResultOfSearch(!0)})},getView:function(){return this.globalView},addTitle:function(e){"search"===this.groupType&&(this.titleGroup=new i(e),this.titleGroup&&this.titleGroup.getView().inject(this.globalView))},addContact:function(e,t){if(e){this.numberOfContact++,this.pictureListPreview.push({idElement:e.getId(),src:e.pathPictureUser,view:void 0});var i=e.getView();"searchChatId"===this.idGroup?(i.inject(this.globalView),t&&(this.expand=1)):(i.inject(this.contactsView),this.renderPreview())}},renderPreview:function(){if(this.pictureListPreview.length<7){var e=UWA.createElement("img",{draggable:!1,src:this.pictureListPreview[this.pictureListPreview.length-1].src,styles:{width:"30%",height:"30%",float:"left",maxWidth:"48px",maxHeight:"48px","border-radius":"48px",margin:"1px"}}),t={handleEvent:function(t){var i=d.getSetting("defaultAvatarURL")||"./resources/en/1/webapps/InstantMessaging/assets/avatarDefault.png";a.debug("RTGroupView : User avatar has not been found, setting the default one."),i&&e.src&&(e.src=i),e.removeEvent("error",this)}};e.addEvent("error",t),this.pictureListPreview[this.pictureListPreview.length-1].view=e,this.picturePreview.children.length<10&&e.inject(this.picturePreview)}},dislayMessage:function(e){void 0!==this.displayMsg&&this.removeMessage(),this.displayMsg=UWA.createElement("div",{text:e,styles:{fontStyle:"italic",margin:"8px"}}),this.displayMsg.inject(this.globalView),this.expand=1,this.numberOfContact++},removeMessage:function(){this.displayMsg&&this.displayMsg.destroy()},removeMember:function(e){var t=this;if(e){this.numberOfContact--;var i=e.getView();new UWA.Fx(i,{duration:200,transition:"linear",events:{onComplete:function(){i.destroy(),t.displayNumberOfContact()}}}).start({height:"0px",opacity:0});for(var n=-1,s=0;s<this.pictureListPreview.length;s++)this.pictureListPreview[s].idElement===e.getId()&&(n=s);n>-1&&this.pictureListPreview[n].view&&(this.pictureListPreview[n].view.parentNode.removeChild(this.pictureListPreview[n].view),this.pictureListPreview.splice(n,1))}},resizeView:function(){var e="34px";this.isHidden&&(e="0px"),0===this.numberOfContact&&(this.expand=0),this.expand&&(e=34+40*this.numberOfContact+"px"),this.resizeViewFX||(this.resizeViewFX=new UWA.Fx(this.globalView,{duration:200,transition:"linear"})),this.titleElement&&(this.isHidden||"34px"===e?this.titleElement.setExpand(!1):this.titleElement.setExpand(!0)),this.resizeViewFX.stop(),this.resizeViewFX.start({height:e})},displayNumberOfContact:function(){if(this.titleElement){var e=this.controller.getNumberOfContact();0===e&&(e=""),this.titleElement.displayNumberOfContact(e)}},setIsHidden:function(e){this.isHidden!==e&&(this.isHidden=e,this.expand=0,"searchChatId"===this.idGroup?this.resizeView():e?this.globalView.style.display="none":(this.globalView.style.display="block",new UWA.Fx(this.globalView,{duration:200,transition:"linear"}).start({opacity:[0,1]})))},setDropData:function(e){if(e&&!this.isLocked){var t=this;this.globalView.ondrop=function(e){t.controller.onDragOver(e),t.dragEnter=!1,t.picturePreview.style.border="1px solid "+h.offline},this.globalView.ondragover=function(e){e.preventDefault(),t.dragEnter=!0,t.expand||(t.picturePreview&&(t.picturePreview.style.border="2px solid limegreen"),s.dispatch(s.eventName.LOCKDRAGONMAINVIEW,[!0]))},this.globalView.ondragleave=function(e){a.debug("Leave"),t.dragEnter&&(t.dragEnter=!1,t.picturePreview&&(t.picturePreview.style.border="1px solid "+h.offline),s.dispatch(s.eventName.LOCKDRAGONMAINVIEW,[!1]))}}else this.globalView.ondrop="",this.globalView.ondragover="",this.globalView.ondragleave=""},setEditMode:function(e){this.titleElement&&this.titleElement.setEditMode(e)},setChangeName:function(e){this.titleElement.setChangeName(e),this.globalView.style.border="solid 1px rgb(0, 86, 134)"},setDisplayListOfContact:function(e){this.expand=!this.expand;var t=new UWA.Fx(this.scrollerView.getContent(),{duration:300,transition:"linear"});e?(this.setDraggable(!1),"GROUPTMP"===this.idGroup&&this.groupNameInput&&this.groupNameInput.setValue(""),this.scrollerView.getContent().style.display="block",t.start({marginLeft:[300,0]})):(this.isDraggable&&this.setDraggable(!0),t.start({marginLeft:[0,300]}))},setDraggable:function(e){if(this.globalView.draggable=e,e){var t=this;this.globalView.ondragstart=function(e){var i={protocol:"3DXContent",version:"1.0",data:{items:[{serviceId:"3DMessaging",contact:{idGroup:t.idGroup}}]}},n=JSON.stringify(i);e.dataTransfer.setData("text",n),s.dispatch(s.eventName.DISPLAYTRASHEDZONE,[!0]),s.dispatch(s.eventName.ACTIVEELEMENTDRAGANDDROP,[!1])},this.globalView.ondragend=function(e){s.dispatch(s.eventName.DISPLAYTRASHEDZONE,[!1]),s.dispatch(s.eventName.ACTIVEELEMENTDRAGANDDROP,[!0])}}else this.globalView.ondragstart=""},setActiveResultOfSearch:function(e){var t="32px";!0===e&&(t=38+38*this.controller.getNumberOfContact()+"px"),new UWA.Fx(this.globalView,{duration:200,transition:"linear"}).start({height:t})},clearInput:function(){this.titleGroup.clearInput()},htmlDecode:function(e){var t=e.replace(/&gt;/g,">");return t=(t=(t=(t=t.replace(/&lt;/g,"<")).replace(/&quot;/g,'"')).replace(/&apos;/g,"'")).replace(/&amp;/g,"&"),decodeURIComponent(t)}})}),define("DS/InstantMessaging/js/view/RTOfflineView",["UWA/Class","UWA/Class/Events","DS/UIKIT/Spinner","DS/UIKIT/Input/Select","DS/UIKIT/Input/Button","DS/RTProxyDriver/RTLogger","DS/InstantMessaging/js/controller/RTSettingController","DS/InstantMessaging/js/controller/RTEventBusController","i18n!DS/InstantMessaging/assets/nls/feed"],function(e,t,i,n,s,o,a,r,l){"use strict";return o.debug("RTOfflineView load"),e.extend(t,{init:function(e){this.SignInIsDisplayed=!1,this.globalView=UWA.createElement("div",{class:"RTOffline",id:"RTOffline",styles:{width:"100%",height:"100%",background:"white",position:"absolute",zIndex:"1"}}),this.spinnerView=UWA.createElement("div",{class:"RTOfflineSpinner",id:"RTOfflineSpinner",styles:{marginTop:"50%"}}).inject(this.globalView),this.spinner=new i({visible:!0,className:"large"}),this.spinner.inject(this.spinnerView),this.offlineView=UWA.createElement("div",{class:"RTOfflineInfoView",id:"RTOfflineInfoView",styles:{display:"none",top:"80px",bottom:"0px",right:"0px",left:"0px",width:"100%"}}).inject(this.globalView),this.InfoView=UWA.createElement("div",{class:"RTInfoOffline",id:"RTInfoOffline",styles:{marginTop:"70px"}}).inject(this.offlineView),this.TxtView=UWA.createElement("div",{class:"RTInfoTxtOffline",id:"RTInfoTxtOffline",text:l.OfflineMessage,styles:{fontSize:"1.1em",color:"#77797c"}}).inject(this.InfoView)},buildSignInView:function(e){var t=this;this.signInView=UWA.createElement("div",{class:"RTSignInView",id:"RTSignInView",styles:{display:"none",top:"80px",bottom:"0px",right:"0px",left:"0px",margin:"10px",marginTop:"10px"}}).inject(this.globalView);var i=[];for(var o in e)i.push({value:o,label:e[o].displayname});1==i.length&&(i[0].selected=!0);var c=new n({nativeSelect:!1,custom:!0,placeholder:l.SelectPlatform,options:i,styles:{margin:"5px"}});c.elements.container.style.margin="10px",c.inject(this.signInView),new s({value:l.Signin,icon:"play",className:"primary"}).inject(this.signInView).addEvent("onClick",function(){var e=c.getValue();e[0]&&(a.setSetting("currentPlateformId",e[0]),window.sessionStorage.setItem("3DIMfavoriteTenant",e[0]),r.dispatch(r.eventName.RESTARTLOGIN,[]),t.activeOfflineView(!1))})},getView:function(){return this.globalView},activeOfflineView:function(e){var t=this;e?(this.globalView.style.display="block",new UWA.Fx(this.globalView,{duration:200,transition:"linear"}).start({opacity:[0,1]})):new UWA.Fx(this.globalView,{duration:200,transition:"linear",events:{onComplete:function(e){t.globalView.style.display="none"}}}).start({opacity:[1,0]})},activeSpinner:function(e){e?(this.offlineView.style.display="none",this.signInView.style.display="none",this.spinnerView.style.display="block"):this.spinnerView.style.display="none"},activeOffline:function(e){this.SignInIsDisplayed||(e?(this.spinnerView&&this.spinnerView.style&&(this.spinnerView.style.display="none"),this.signInView&&this.signInView.style&&(this.signInView.style.display="none"),this.offlineView&&this.offlineView.style&&(this.offlineView.style.display="block")):this.offlineView&&this.offlineView.style&&(this.offlineView.style.display="none"))},activeSignIn:function(e,t){this.signInView||this.buildSignInView(t),e?(this.spinnerView.style.display="none",this.offlineView.style.display="block",this.signInView.style.display="block"):this.signInView.style.display="none",this.SignInIsDisplayed=e}})}),define("DS/InstantMessaging/js/view/RTAddContactView",["UWA/Class","UWA/Class/Events","DS/InstantMessaging/js/controller/RTEventBusController","DS/RTProxyDriver/RTProxyDriver","DS/RTProxyDriver/RTLogger","i18n!DS/InstantMessaging/assets/nls/feed"],function(e,t,i,n,s,o){"use strict";return s.debug("RTAddContactView load"),e.extend(t,{init:function(e){this.dragEnter=!1;var t=this;this.globalView=UWA.createElement("div",{class:"RTAddContact",id:"RTAddContact",styles:{height:"84px",width:"84px",border:"3px dashed #B4B6BA",margin:"1px",borderRadius:"3px"}}),this.iconPlusView=UWA.createElement("span",{class:"fonticon handler fonticon-user-add",styles:{marginTop:"4px",color:"#B4B6BA",fontSize:"1.6em"}}),this.iconPlusView.inject(this.globalView),this.textAddView=UWA.createElement("div",{text:o.AddContactHere,styles:{float:"left",color:"#B4B6BA",padding:"1px"}}),this.textAddView.inject(this.globalView),this.globalView.ondrop=function(e){s.debug("RTAddContactView Drop data"),e.preventDefault();var t=e.dataTransfer.getData("text"),n=void 0;(t=JSON.parse(t))&&"3DMessaging"===t.data.items[0].serviceId&&(n=t.data.items[0].contact),n&&i.dispatch(i.eventName.ONADDCONTACT,[{user:n,group:"_"}])},this.globalView.ondragover=function(e){e.preventDefault(),t.dragEnter=!0,t.globalView.style.border="3px dashed #368ec4",t.iconPlusView.style.color="#368ec4",t.textAddView.style.color="#368ec4"},this.globalView.ondragleave=function(e){s.debug("RTAddContactView ondragleave"),t.dragEnter&&(t.dragEnter=!1,t.globalView.style.border="3px dashed #B4B6BA",t.iconPlusView.style.color="#B4B6BA",t.textAddView.style.color="#B4B6BA")}},getView:function(){return this.globalView},destroy:function(){this.globalView.destroy()}})}),define("DS/InstantMessaging/js/view/RTTitleView",["UWA/Class","UWA/Class/Events","DS/InstantMessaging/js/controller/RTSettingController","DS/InstantMessaging/js/controller/RTEventBusController","DS/RTProxyDriver/RTLogger","DS/UIKIT/DropdownMenu","DS/RTProxyDriver/RTProxyDriver","i18n!DS/InstantMessaging/assets/nls/feed","DS/RTColors/RTColors","DS/UIKIT/Tooltip"],function(e,t,i,n,s,o,a,r,l,c){"use strict";return s.debug("RTTitleView load"),e.extend(t,{init:function(e){s.debug("RTTitleView init"),this.panelId=e.panelId,this.titleName=e.titleName,this.titleName.txt=this.htmlDecode(decodeURI(this.titleName.txt)),this.eventResizePanel=e.eventResizePanel,this.iconActions=e.iconActions,this.minimizeButton=e.minimizeButton,this.closeButton=e.closeButton,this.menuButton=e.menuButton,this.iconPath=e.iconPath,this.noAction=e.noAction,this.iconiseAll=e.iconiseAll,this.picture=e.picture,this.status=e.status,this.activeMenu=e.activeMenu,this.active3DIM=e.active3DIM,this.isMaximize=!0;var t,d,h=this;if(this.globalView=UWA.createElement("div",{class:"RTTitle",id:"RTTitle"}),this.resizeView=UWA.createElement("div",{class:"RTTitleResize",id:"RTTitleResize",events:{mousedown:function(e){e=e||window.event,h.dispatchEvent(h.eventResizePanel.MouseDown,e),s.debug(h.eventResizePanel.MouseDown),e.preventDefault(),UWA.Event.stop(e)},mouseup:function(){h.dispatchEvent(h.eventResizePanel.MouseUp,[]),s.debug(h.eventResizePanel.MouseUp)}}}),this.iconPath?this.iconTitleView=UWA.createElement("span",{class:"fonticon handler "+this.iconPath,styles:{margin:"3px 0px 0px 6px",color:"white",fontSize:"1.2em",float:"left"},events:{click:function(){h.isMaximize?h.iconise():h.maximize()}}}):this.iconTitleView=UWA.createElement("div",{styles:{margin:"12px",background:l.offline,float:"left",borderRadius:"16px",width:"16px",height:"16px",marginRight:"0px","text-align":"center"},events:{click:function(){h.isMaximize?h.iconise():h.maximize()}}}),this.iconTitleViewIcon=UWA.createElement("span",{class:"",styles:{color:"white","font-size":"5px",position:"relative",top:"-4px","font-weight":"bold"}}),this.iconTitleViewIcon.inject(this.iconTitleView),this.iconTitleView.inject(this.globalView),this.activeMenu&&(this.statusMenuIcon=UWA.createElement("span",{class:"fonticon handler fonticon-down-open",styles:{margin:"10px 0px",float:"left",background:"#005686",opacity:"0.2",color:"white"},events:{mouseover:function(e){h.statusMenuIcon.style.opacity=1},mouseout:function(){h.statusMenuIcon.style.opacity=.1}}}),this.statusMenuIcon.inject(this.globalView)),this.status){var u=i.getSetting("RTCStatus");u&&(this.status===u.Online&&(this.iconTitleView.style.background=l.online,this.iconTitleViewIcon.className="fonticon handler fonticon-check",this.iconTitleViewIcon.style["font-size"]="8px",this.iconTitleViewIcon.style.top="-3px"),this.status===u.Busy&&(this.iconTitleView.style.background=l.busy,this.iconTitleViewIcon.className="fonticon handler fonticon-minus",this.iconTitleViewIcon.style["font-size"]="8px",this.iconTitleViewIcon.style.top="-3px"),this.status===u.Away&&(this.iconTitleView.style.background=l.away,this.iconTitleViewIcon.className="fonticon handler fonticon-cancel",this.iconTitleViewIcon.style["font-size"]="8px",this.iconTitleViewIcon.style.top="-3px"))}if(this.titleName&&(this.titleNameView=UWA.createElement("div",{class:"RTTitleName",id:"RTTitleName",text:this.titleName.txt,events:{click:function(){h.isMaximize?h.iconise():h.maximize()}}}),this.titleNameView.inject(this.globalView)),!this.noAction){if(this.actionsView=UWA.createElement("div",{class:"RTTitleAction",id:"RTTitleAction"}),this.minimizeButton&&UWA.createElement("span",{class:"fonticon handler fonticon-minus",styles:{margin:"5px",color:"white",fontSize:"1.2em",float:"right",verticalAlign:"sub",display:"none"},events:{click:function(){h.iconise()}}}).inject(this.actionsView),this.iconiseAll&&UWA.createElement("span",{class:"fonticon handler fonticon-resize-small",events:{click:function(){n.dispatch(n.eventName.ICONISEALLCLICK,[])}}}).inject(this.actionsView),this.coreviewButton=UWA.createElement("span",{class:"fonticon handler fonticon-monitor ",styles:{display:"none"},events:{}}).inject(this.actionsView),this.coreviewButton.tooltip=new c({target:this.coreviewButton,position:"bottom",body:r.TooltipCoreview||"Coreview"}),this.coreviewButton.tooltip.getContent().style.zIndex="30000",this.menuButton){this.buttonMenu=UWA.createElement("span",{class:"fonticon handler fonticon-down-open ",styles:{},events:{}}).inject(this.actionsView);var g=(t=i.getSetting("userLogin"),d=this.panelId.split("@")[0],function(){console.log("start video call from "+t+" to "+d),a.dispatch("startCall",[{login:d,type:"video"}])}),p=function(e,t){return function(){console.log("start video call from "+e+" to "+t),a.dispatch("startCall",[{login:t,type:"audio"}])}}(i.getSetting("userLogin"),this.panelId.split("@")[0]),m=!0;(-1!==navigator.userAgent.indexOf("MSIE")||navigator.appVersion.indexOf("Trident/")>0)&&(m=!1),i.getSetting("webrtc3DIM")?(this.dropdownMenuArchive=new o({target:this.buttonMenu,items:[{id:"DownloadHistoryOption",text:r.buttonSendHistory||"Download history",fonticon:"download",className:"historyButton",handler:function(){h.mail()}},{text:r.buttonClearHistory||"Clean history",fonticon:"trash",className:"historyButton",handler:function(){h.trash()}},{className:"divider"},{id:"VideoCallOption",text:r.videoCall||"Video Call",className:"callButton",fonticon:"videocamera",handler:m?g:null},{id:"AudioCallOption",text:r.audioCall||"Audio Call",className:"callButton",fonticon:"phone",handler:m?p:null}]}),m||(this.dropdownMenuArchive.getContent().getElementsByClassName("callButton")[0].style.opacity=.5,this.dropdownMenuArchive.getContent().getElementsByClassName("callButton")[1].style.opacity=.5,this.notCompatibleTooltip=new c({target:this.dropdownMenuArchive.getContent().children[0].children.VideoCallOption,position:"left",trigger:"click touch hover",body:r.notCompatible}),this.notCompatibleTooltip.getContent().style.zIndex="30000",this.notCompatibleTooltip=new c({target:this.dropdownMenuArchive.getContent().children[0].children.AudioCallOption,position:"left",trigger:"click touch hover",body:r.notCompatible}),this.notCompatibleTooltip.getContent().style.zIndex="30000")):this.dropdownMenuArchive=new o({target:this.buttonMenu,items:[{text:r.buttonSendHistory||"Download history",fonticon:"download",className:"historyButton",handler:function(){h.mail()}},{text:r.buttonClearHistory||"Clean history",fonticon:"trash",className:"historyButton",handler:function(){h.trash()}}]}),this.dropdownMenuArchive.getContent().style.zIndex="3000";var f=this.buttonMenu;this.dropdownMenuArchive.activateCallButtons=function(){if(!(this.elements&&this.elements.container&&this.elements.container.getElementsByClassName("callButton")&&this.elements.container.getElementsByClassName("callButton").item(0)))return!0;for(var e=this.elements.container.getElementsByClassName("callButton"),t=0;t<e.length;t++)e.item(t).show();f.show()},this.dropdownMenuArchive.deactivateCallButtons=function(){if(!(this.elements&&this.elements.container&&this.elements.container.getElementsByClassName("callButton")&&this.elements.container.getElementsByClassName("callButton").item(0)))return!0;for(var e=this.elements.container.getElementsByClassName("callButton"),t=0;t<e.length;t++)e.item(t).hide();this.elements.container.getElementsByClassName("historyButton")&&this.elements.container.getElementsByClassName("historyButton").item(0)&&!this.elements.container.getElementsByClassName("historyButton").item(0).isHidden()||f.hide()},this.dropdownMenuArchive.activateHistoryButtons=function(){if(!(this.elements&&this.elements.container&&this.elements.container.getElementsByClassName("historyButton")&&this.elements.container.getElementsByClassName("historyButton").item(0)))return!0;for(var e=this.elements.container.getElementsByClassName("historyButton"),t=0;t<e.length;t++)e.item(t).show();f.show()},this.dropdownMenuArchive.deactivateHistoryButtons=function(){if(!(this.elements&&this.elements.container&&this.elements.container.getElementsByClassName("historyButton")&&this.elements.container.getElementsByClassName("historyButton").item(0)))return!0;for(var e=this.elements.container.getElementsByClassName("historyButton"),t=0;t<e.length;t++)e.item(t).hide();this.elements.container.getElementsByClassName("callButton")&&this.elements.container.getElementsByClassName("callButton").item(0)&&!this.elements.container.getElementsByClassName("callButton").item(0).isHidden()||f.hide()},this.dropdownMenuArchive.deactivateHistoryButtons()}this.closeButton&&UWA.createElement("span",{class:"fonticon handler fonticon-cancel",events:{click:function(){h.close()}}}).inject(this.actionsView),this.actionsView.inject(this.globalView)}this.resizeView.inject(this.globalView),this.activeMenu&&(a.addEvent(a.eventName.SETSTATUS,function(e){h.setStatus(e)}),a.addEvent(a.eventName.ONPRESENCERECEIVED,function(e){s.debug("RTTitleView : ONPRESENCERECEIVED");var t=e.userId.split("@"),n=i.getSetting("userLogin");if(t[0]===n){var o=i.getSetting("RTCStatus");h.setStatus({myStatus:e.status}),h.iconTitleView.style.background=l.offline,h.iconTitleViewIcon.className="",h.iconTitleViewIcon.style["font-size"]="5px",h.iconTitleViewIcon.style.top="-3px",h.dropdownMenuArchive&&!document.callAlwaysAvailable&&h.dropdownMenuArchive.deactivateCallButtons(),o&&(e.status===o.Online&&(h.iconTitleView.style.background=l.online,h.iconTitleViewIcon.className="fonticon handler fonticon-check",h.iconTitleViewIcon.style["font-size"]="8px",h.iconTitleViewIcon.style.top="-3px",h.dropdownMenuArchive&&("Online"==i.getSetting("userStatus")||document.callAlwaysAvailable)&&h.dropdownMenuArchive.activateCallButtons()),e.status===o.Busy&&(h.iconTitleView.style.background=l.busy,h.iconTitleViewIcon.className="fonticon handler fonticon-minus",h.iconTitleViewIcon.style["font-size"]="8px",h.iconTitleViewIcon.style.top="-3px"),e.status===o.Away&&(h.iconTitleView.style.background=l.away,h.iconTitleViewIcon.className="fonticon handler fonticon-cancel",h.iconTitleViewIcon.style["font-size"]="8px",h.iconTitleViewIcon.style.top="-3px"))}})),this.initListner()},initListner:function(){var e=this;n.addEvent(n.eventName.ONMAXIMIZEDCLICK,function(t){t===e.panelId&&(e.isMaximize=!0)}),n.addEvent(n.eventName.ONICONISEPANELCLICK,function(t){t===e.panelId&&(e.isMaximize=!1)}),this.statusMenuIcon&&(n.addEvent(n.eventName.LISTSTATUSRECEIVED,function(t){e.buildDropDownMenu()}),a.addEvent(a.eventName.DISCONNECTED,function(t){e.statusMenuIcon.style.display="none",e.setStatus({myStatus:"Offline"}),a.dispatch(a.eventName.SETSTATUS,{myStatus:"Offline",statusMsg:"Offline"}),n.dispatch(n.eventName.SIGNOUT,[])}),a.addEvent(a.eventName.CONNECTED,function(t){e.statusMenuIcon.style.display="block"}))},buildDropDownMenu:function(){s.debug("RTTitleView buildDropDownMenu");if(this.statusMenuIcon){this.statusMenuIcon.style.display="",this.dropdownMenu=new o({target:this.statusMenuIcon,items:[],events:{onClick:function(e,t){"signOutAction"===t["data-id"]?(s.debug("Clik menu signOutAction"),n.dispatch(n.eventName.SIGNOUT,[])):(s.debug("Clik menu"),a.dispatch(a.eventName.SETSTATUS,{myStatus:t.name,statusMsg:t.name}))}}}),this.dropdownMenu.getContent().style.zIndex="3000";var e,t=i.getSetting("RTCStatus");for(var l in t)("Offline"==l||"Away"==l)&&r[e="Appear"+l]||(e=l),this.dropdownMenu.addItem({text:r[e],name:l,icon:"Online"===l?"fonticon fonticon-check":""});if(this.active3DIM&&Object.keys(this.active3DIM).length>1){var c=this.active3DIM,d=0;for(var h in c)if(1==c[h].imActive&&d++,d>1){this.dropdownMenu.addItem({className:"divider"}),this.dropdownMenu.addItem({text:r.Signout,name:"SignoutLIname","data-id":"signOutAction"});break}}}},getView:function(){return s.debug("RTTitleView getView"),this.globalView},setTitle:function(e){s.debug("RTTitleView setTitle to "+e),this.titleNameView&&e&&this.titleNameView.setText(decodeURI(e))},setNotif:function(e){s.debug("RTTitleView setNotif"),this.globalView.style.background=e?l.away:"#005686"},close:function(){s.debug("RTTitleView close"),this.dispatchEvent(this.panelId+"ClosedClick",[])},mail:function(){s.debug("RTTitleView mail"),this.dispatchEvent(this.panelId+"MailClick",[])},trash:function(){s.debug("RTTitleView trash"),this.dispatchEvent(this.panelId+"TrashClick",[])},minimize:function(){s.debug("RTTitleView minimize"),this.dispatchEvent(this.panelId+"MinimizedClick",[])},maximize:function(){s.debug("RTTitleView maximize"),this.actionsView.style.visibility="",this.isMaximize||(this.isMaximize=!0,n.dispatch(n.eventName.ONMAXIMIZEDCLICK,[this.panelId]))},iconise:function(){s.debug("RTTitleView iconise"),this.actionsView.style.visibility="hidden",this.isMaximize=!1,n.dispatch(n.eventName.ONICONISEPANELCLICK,[this.panelId])},changeIconColor:function(e){s.debug("RTTitleView changeIconColor"),this.iconTitleView.style.background=e},changeIconClassName:function(e){this.iconTitleViewIcon.className=e},setBackgroundColor:function(e){s.debug("RTTitleView setBackgroundColor"),this.globalView.style.background=e},display:function(e){this.globalView.style.display=e?"block":"none"},setTenantName:function(e){this.tenantNameView?this.tenantNameView.setText(e):(this.tenantNameView=UWA.createElement("div",{class:"RTTenantName",id:"RTTenantName",text:e}),this.tenantNameView.inject(this.globalView),this.titleNameView.style.marginTop="0px")},setStatus:function(e){var t=this;t.dropdownMenu&&t.dropdownMenu.items.forEach(function(i){"SignoutLIname"!=i.name&&(i.name===e.myStatus?t.dropdownMenu.updateItem({id:i.id,text:i.text,name:i.name,icon:"fonticon fonticon-check"}):t.dropdownMenu.updateItem({id:i.id,text:i.text,name:i.name,icon:""}),i.elements&&i.elements.container&&i.elements.container.firstChild&&!i.elements.container.firstChild.className&&i.elements.container.firstChild.destroy())})},htmlDecode:function(e){var t=e.replace(/&gt;/g,">");return t=(t=(t=(t=t.replace(/&lt;/g,"<")).replace(/&quot;/g,'"')).replace(/&apos;/g,"'")).replace(/&amp;/g,"&")},injectCoreviewMenu:function(){this.globalView.addClassName("RTTitleWithCoreviewMenu")},destroyCoreviewMenu:function(){this.globalView.removeClassName("RTTitleWithCoreviewMenu")}})}),define("DS/InstantMessaging/js/controller/RTPanelController",["UWA/Class","UWA/Class/Events","DS/UIKIT/Alert","DS/InstantMessaging/js/view/RTPanelView","DS/InstantMessaging/js/view/RTOfflineView","DS/InstantMessaging/js/view/RTTitleView","DS/RTProxyDriver/RTLogger","DS/RTProxyDriver/RTProxyDriver","DS/InstantMessaging/js/controller/RTEventBusController","DS/InstantMessaging/js/view/RTSearchView","i18n!DS/InstantMessaging/assets/nls/feed"],function(e,t,i,n,s,o,a,r,l,c,d){"use strict";return a.debug("RTPanelController load"),e.extend(t,{init:function(e){this.id=e.id,this.controller=e.controller,this.initPanel(e),this.initListner()},initPanel:function(e){var t=this,i={controller:this,originXPos:e.originXPos,originYPos:e.originYPos,sizeOnY:e.sizeOnY,minimumSize:e.minimumSize,minimumResize:e.minimumResize,panelLarger:e.panelLarger,panelId:this.id,iconeIconise:e.iconeIconise};this.panel=new n(i),this.panelView=this.panel.getView(),e.titleOpt&&(e.titleOpt.panelId=this.id,e.titleOpt.active3DIM=e.active3DIM,this.titlePanel=new o(e.titleOpt),l.addEvent(l.eventName.ONMAXIMIZEDCLICK,function(e){t.id!==e||t.titlePanel.noAction||t.maximized()}),e.titleOpt.minimizeButton&&this.titlePanel.addEvent(this.id+"MinimizedClick",function(){t.minimize()}),e.titleOpt.closeButton&&this.titlePanel.addEvent(this.id+"ClosedClick",function(){t.closePanel()}),e.titleOpt.menuButton&&(this.titlePanel.addEvent(this.id+"TrashClick",this.ArchiveTrash.bind(this)),this.titlePanel.addEvent(this.id+"MailClick",this.ArchiveMail.bind(this)),l.addEvent(this.id+"DisplayArchiveMenu",this.DisplayArchiveMenu.bind(this)),l.addEvent(this.id+"HideArchiveMenu",this.HideArchiveMenu.bind(this))),l.addEvent(l.eventName.ONICONISEPANELCLICK,function(e){e===t.id&&t.iconise()}),e.titleOpt.eventResizePanel&&(e.titleOpt.eventResizePanel.MouseDown&&this.titlePanel.addEvent(e.titleOpt.eventResizePanel.MouseDown,function(e){t.panel.resizeOn(e)}),e.titleOpt.eventResizePanel.MouseUp&&this.titlePanel.addEvent(e.titleOpt.eventResizePanel.MouseUp,function(){t.panel.resizeOff()})),this.titlePanel.getView().inject(this.panelView),this.offlineView=new s({spinnerOn:!0}),this.offlineView.getView().inject(this.panelView),e.showOfflineView||t.offlineView.activeOfflineView(!1))},ArchiveMail:function(){this.dispatchEvent(this.id+"ArchiveMail",this.id)},ArchiveTrash:function(){this.dispatchEvent(this.id+"ArchiveTrash",this.id)},HideArchiveMenu:function(){this.titlePanel.dropdownMenuArchive.deactivateHistoryButtons()},DisplayArchiveMenu:function(){this.titlePanel.dropdownMenuArchive.activateHistoryButtons()},alert:function(e){this.alertBox&&this.alertBox.isVisible&&this.alertBox.destroy(),this.alertBox=new i({visible:!0}).inject(this.offlineView.globalView),this.alertBox.add({className:e.className||"primary",message:e.message||"Done."})},initListner:function(){var e=this;r.addEvent(r.eventName.DISCONNECTED,function(t){e.offlineView.activeOffline(!0),e.offlineView.activeOfflineView(!0),t.forced&&e.alert({className:"error",message:d.networkDisconnected})}),r.addEvent(r.eventName.CONNECTED,function(t){e.offlineView.activeOfflineView(!1)})},render:function(e){this.panelView.inject(e)},move:function(e,t){this.panel.move(e,t)},moveToOrigin:function(){this.panel.moveToOrigin()},getOriginPosition:function(){return this.panel.getOriginPosition()},getOldPosition:function(){return this.panel.getOldPosition()},setOriginPosition:function(e){return this.panel.setOriginPosition(e)},maximize:function(){l.dispatch(l.eventName.PANELMAXIMIZED,[this.id])},maximized:function(){this.titlePanel.setNotif(!1),this.panel.setNotif(!1),this.titlePanel&&(this.titlePanel.display(!0),this.titlePanel.actionsView&&(this.titlePanel.actionsView.style.visibility="")),this.panel.maximize(),this.maximize()},minimize:function(){this.panel.minimize(),this.dispatchEvent(this.id+"Minimized",[])},iconise:function(e){this.panel.iconise(e),this.titlePanel&&(this.titlePanel.display(!1),this.titlePanel.actionsView&&(this.titlePanel.actionsView.style.visibility="hidden")),l.dispatch(l.eventName.PANELICONISED,[this.id])},closePanel:function(e){this.minimize(),this.panel.setDisplayPanel(!1),this.dispatchEvent(this.id+"Closed",[e])},addElement:function(e){this.panel.addElement(e)},setTitle:function(e){this.titlePanel&&this.titlePanel.setTitle(e)},getLarger:function(){return this.panel.panelLarger},setDisplayPanel:function(e){this.panel.setDisplayPanel(e)},getDisplayPanel:function(){return this.panel.getDisplayPanel()},getView:function(){return this.panel.getView()},setNotif:function(e){this.panel.isMinimize&&(this.panel.setNotif(e),this.titlePanel.setNotif(e))},showPanel:function(){this.panel.setDisplayPanel(!0)},isMinimize:function(){return this.panel.isMinimize},getSizeOnY:function(){return this.panel.getSizeOnY()},setZindex:function(e){this.panel.setZindex(e)},setTitleBackgroundColor:function(e){this.titlePanel.setBackgroundColor(e)},changeTitleMainIconColor:function(e){this.titlePanel.changeIconColor(e)},changeTitleMainIconClassName:function(e){this.titlePanel.changeIconClassName(e)},isAnIcon:function(){return this.panel.isAnIcon()},getWidth:function(){return this.panel.getWidth()},activeSignInView:function(e,t){this.offlineView&&(this.offlineView.activeSignIn(e,t),this.titlePanel.setTenantName(""),this.offlineView.activeOfflineView(e))},activeOfflineView:function(e){this.offlineView&&this.offlineView.activeOfflineView(e)},destroy:function(){this.panel.closePanel()},setTenantName:function(e){this.titlePanel.setTenantName(e)}})}),define("DS/InstantMessaging/js/view/RTListOfGroupView",["UWA/Class","UWA/Class/Events","DS/InstantMessaging/js/view/RTAddContactView","DS/RTProxyDriver/RTProxyDriver","DS/RTProxyDriver/RTLogger","DS/InstantMessaging/js/controller/RTEventBusController","i18n!DS/InstantMessaging/assets/nls/feed","DS/UIKIT/Scroller","DS/RTColors/RTColors"],function(e,t,i,n,s,o,a,r,l){"use strict";return s.debug("RTListOfGroupView load"),e.extend(t,{init:function(e){this.pageView=[],this.nbEleme=0,this.addContactView=void 0,this.globalView=UWA.createElement("div",{class:"RTListOfGroup",id:"RTListOfGroup"}),this.noElementView=UWA.createElement("div",{class:"RTNoElement",id:"RTNoElement",styles:{display:"none",top:"80px",bottom:"0px",right:"0px",left:"0px",width:"100%"}}).inject(this.globalView),this.noElementInfoView=UWA.createElement("div",{class:"RTNoElementInfo",id:"RTNoElementInfo",styles:{marginTop:"70px"}}).inject(this.noElementView),this.addUserView=UWA.createElement("span",{class:"fonticon handler fonticon-user-add",styles:{fontSize:"4em",color:l.offline}}).inject(this.noElementInfoView),this.noElementTxtView=UWA.createElement("div",{class:"RTNoElementInfoTxt",id:"RTNoElementInfoTxt",text:a.FirstMessage,styles:{fontSize:"1.1em",color:l.offline}}).inject(this.noElementInfoView),this.initListner(),this.scrollerView=new r({element:UWA.createElement("div",{class:"scrollable-body",styles:{flex:"1"},html:this.globalView})})},initListner:function(){var e=this;o.addEvent(o.eventName.ACTIVEBUDDYSCROLLER,function(t){var i=e.getView().children;e.scrollerView.scrollTo(0,0);for(var n=0;n<i.length;n++){var s=i[n];t?1===n?s.style.display="block":s.style.overflow="scroll":(s.style.overflow="hidden",1===n&&(s.style.display="none"))}}),o.addEvent(o.eventName.ONELEMENTDRAGSTART,function(t){"searchChatId"===t.groupId&&(e.addContactView||(e.globalView.scrollTop=e.globalView.scrollHeight,e.addContactView=new i,e.addElement(e.addContactView.getView())))}),o.addEvent(o.eventName.ONELEMENTDRAGSTOP,function(t){"searchChatId"===t.groupId&&e.addContactView&&(e.addContactView.destroy(),delete e.addContactView)}),n.addEvent(n.eventName.REMOVECONTACT,function(t){"_"===t.group&&(e.nbEleme--,3===e.globalView.childElementCount&&"none"===e.globalView.childNodes[1].style.display&&e.setNoElement(!0))}),n.addEvent(n.eventName.REMOVEGROUP,function(t){e.nbEleme--,3===e.globalView.childElementCount&&"none"===e.globalView.childNodes[1].style.display&&e.setNoElement(!0)})},getView:function(){return this.scrollerView.getContent()},addElement:function(e,t){e&&(this.setNoElement(!1),e.inject(this.globalView,t||"top"),new UWA.Fx(e,{duration:250,transition:"linear"}).start({opacity:["O","1"]}),this.nbEleme++)},setNoElement:function(e){this.noElementView.style.display=e?"block":"none"},mouveUp:function(e){var t=this.scrollerView.elements.content.scrollTop;t>0&&(this.scrollerView.elements.content.scrollTop=t-50)},mouveDownp:function(e){var t=this.scrollerView.elements.content.scrollTop;t<this.scrollerView.elements.content.scrollHeight&&(this.scrollerView.elements.content.scrollTop=t+50)},setDropData:function(e){}})}),define("DS/InstantMessaging/js/model/RTContactModel",["UWA/Class","UWA/Class/Events","DS/RTProxyDriver/RTLogger","DS/InstantMessaging/js/controller/RTSettingController"],function(e,t,i,n){"use strict";return i.debug("RTContactModel load"),e.extend(t,{init:function(e){this.userId=e.contact.userId,this.userName=e.contact.userName,this.login=e.contact.login?e.contact.login:this.userId.substring(0,this.userId.indexOf("@")),this.controller=e.controller,this.listOfStatus=n.getSetting("RTCStatus"),e.contact.status?this.status=e.contact.status:this.status=this.listOfStatus?this.listOfStatus.Offline:void 0},getId:function(){return this.userId},setId:function(e){this.userId=e},getStatus:function(){return this.status},setStatus:function(e){this.status=e},getEmail:function(){return this.email},setEmail:function(e){this.email=e},getLogin:function(){return this.login},setLogin:function(e){this.login=e},getUserName:function(){return this.userName},setUserName:function(e){this.userName=e}})}),define("DS/InstantMessaging/js/controller/RTContactController",["UWA/Class","UWA/Class/Events","DS/InstantMessaging/js/view/RTElementView","DS/InstantMessaging/js/model/RTContactModel","DS/RTProxyDriver/RTProxyDriver","DS/RTProxyDriver/RTLogger","DS/InstantMessaging/js/controller/RTSettingController","DS/InstantMessaging/js/controller/RTEventBusController"],function(e,t,i,n,s,o,a,r){"use strict";return o.debug("RTContactController load"),e.extend(t,{init:function(e){this.controller=e.controller,this.connection=e.connection,this.groupId=e.groupId,this.addIcon=!1,this.imgContact=void 0,e.contact.addIcon&&(this.addIcon=!0),this.contactView=void 0,this.contactModel=void 0,e.contact&&this.initContact(e.contact)},initContact:function(e){var t=this;if(this.contactModel=new n({contact:e,connection:this.connection,controller:this}),this.contactModel){var l=this.contactModel.getLogin()||this.contactModel.getId(),c=this.contactModel.getUserName()||l,d=this.contactModel.getStatus(),h=a.getSetting("currentPlateformId"),u=a.getSetting("plateformsInfo"),g=a.getSetting("defaultAvatarURL")||"./resources/en/1/webapps/InstantMessaging/assets/avatarDefault.png",p=h&&u&&u[h]?u[h].swym:void 0;this.imgContact=new Image,this.pathPictureUser=p?p+"/api/user/getpicture/login/"+l+"/format":void 0,this.imgContact.src=this.pathPictureUser||g,this.imgContact.id=escape(this.contactModel.login+"_avatar");for(var m=0;document.getElementById(this.imgContact.id)&&m<100;)this.imgContact.id+=m,m++;t=this;this.imgContact.onerror=function(){o.debug("RTContactController : User avatar has not been found, setting the default one. User login:"+l),t.imgContact.onerror=null;var e=document.getElementById(t.imgContact.id);e&&e.src&&g&&(e.src=g),t.pathPictureUser=g,t.imgContact.src=t.pathPictureUser};var f={groupId:this.groupId,controller:this,statusElement:d,pictureElement:{picture:this.imgContact,eventName:"onStartChat"},titleElement:{txt:c,eventName:"onStartChat"},subTitleElement:void 0};if(this.contactView=new i(f),"_"===this.groupId&&(this.contactView.setDraggable(!0),this.contactView.setDropData(!0)),this.contactView){t=this;e.noClick||this.addEvent(f.pictureElement.eventName,function(e){o.debug("RTContactController CLICK Picture"),r.dispatch(r.eventName.STARTCHAT,[e])}),this.addIcon&&this.contactView.showAddElement(this.addIcon)}s.addEvent(s.eventName.ONPRESENCERECEIVED,function(e){e.userId===t.getId()&&(t.setStatus(e.status),e.username&&(t.contactView.RTTitleElementView.innerText=e.username))})}},getView:function(){if(this.contactView)return this.contactView.getView()},setBorder:function(e){this.contactView.setBorder(e)},getId:function(){return this.contactModel.getId()},getStatus:function(){return this.contactModel.getStatus()},setStatus:function(e){this.getStatus()!==e&&(this.contactModel.setStatus(e),this.contactView.updateStatus(e))},getEmail:function(){return this.contactModel.getEmail()},setEmail:function(e){this.contactModel.setEmail(e)},getLogin:function(){return this.contactModel.getLogin()},setLogin:function(e){this.contactModel.setLogin(e)},getUserName:function(){return this.contactModel.getUserName()},setUserName:function(e){this.contactModel.setUserName(e)},setDraggable:function(e){this.contactView.setDraggable(e)},setEditMode:function(e){this.contactView.setEditMode(e)},sendRemove:function(e){s.dispatch(s.eventName.REMOVECONTACT,{user:this.getId(),group:this.groupId})},sendAddContact:function(){},getPathPicture:function(){return this.pathPictureUser},getGroupNumberOfContact:function(){return this.controller&&this.controller.getNumberOfContact?this.controller.getNumberOfContact():-1},getPicture:function(){return this.imgContact}})}),define("DS/InstantMessaging/js/view/RTMsgView",["UWA/Class","UWA/Class/Events","DS/UIKIT/DropdownMenu","DS/RTProxyDriver/RTLogger","DS/InstantMessaging/js/controller/RTSettingController","DS/InstantMessaging/js/ressources/FileSaver","DS/i3DXCompassPlatformServices/OpenWith","i18n!DS/InstantMessaging/assets/nls/feed","UWA/Utils/InterCom"],function(e,t,i,n,s,o,a,r,l){"use strict";return n.debug("RTMsgView load"),e.extend(t,{init:function(e){this.controller=e.controller,this.message=e.msg,this.msgType=e.msgType,this.activePicture=e.activePicture,this.contactPicture=e.contactPicture,void 0===this.msgType&&(this.msgType="received");var t=this;this.globalView=UWA.createElement("div",{class:"RTMsg"+this.msgType,id:"RTMsg"+this.msgType}),"received"===this.msgType&&this.activePicture&&(this.contactPicture.className="RTImgReceived",this.contactPicture.draggable="false",this.globalView.appendChild(this.contactPicture.cloneNode(!0))),this.msgTextView=UWA.createElement("div",{class:"RTMsgText"+this.msgType,id:"RTMsgText"+this.msgType});var o=this.message.msg;UWA.createElement("div",{}).textContent="";var a=function(e){if(!e.data)return!1;for(var t in e.data)return!0;return!1}(e.msg);if(!a)for(var c=this.urlify(o),d=0;d<c.split.length;d++){if(c.split[d]&&c.split[d].length>0){var h=UWA.createElement("span");h.textContent+=c.split[d],h.inject(this.msgTextView)}if(c.url&&c.split.length>1&&c.split.length-1!==d)UWA.createElement("a",{text:c.url,target:"_blank",href:c.url}).inject(this.msgTextView)}if(this.msgTextView.inject(this.globalView),a){"received"===this.msgType?this.msgTextView.className="RTMsgTextreceivedData":this.msgTextView.className="RTMsgTextsentData";var u,g=e.msg.fileName,p=void 0,m=void 0,f=[],v={},w=void 0;try{var y=atob(e.msg.data);m=(w=JSON.parse(y)).datahtml,m=decodeURIComponent(escape(window.atob(m))),y=decodeURIComponent(w.data),this.data=y,u=w.uri}catch(e){n.debug("RTMsgView Error parsing data "+e)}if("DS3DXContent"===e.msg.typeData){void 0,this.msgTextView.draggable=!0;try{w=JSON.parse(y);try{w.data=JSON.parse(JSON.parse(decodeURIComponent(w.data))),w.data=w.data.data||w.data,m=w.datahtml,m=decodeURIComponent(escape(window.atob(m)))}catch(e){console.error(e)}"3DSpace"===(p=w.data.items[0].serviceId)?g=w.data.items[0].displayName:"3DSwym"===p&&(g=w.data.items[0].objectType)}catch(e){n.debug("RTMsgView Error parsing data "+e)}this.msgTextView.ondragstart=function(e){var t=y;try{t=atob(w.data)}catch(e){t=y}e.dataTransfer.setData("text",t);try{var i=new UWA.Widget;i.socket=new l.Socket("SwymMyCommunities-"+i.id),i.socket.subscribeServer("ifweServer",window.parent),i.socket.dispatchEvent("SwymContentDragStarted",JSON.parse(y))}catch(e){n.debug("RTMsgView while dispatching SwymContentDragStarted "+e)}}}else"fileTransfer"===e.msg.typeData?(UWA.createElement("span",{class:"fonticon handler fonticon-doc-text-inv",styles:{fontSize:"2.8em",color:" #B4B6BA",marginTop:"3px"}}).inject(this.msgTextView),this.msgIconData=UWA.createElement("div",{class:"RTMsgIconData"+this.msgType,id:"RTMsgIconData"+this.msgType,text:g,styles:{background:"white",borderRadius:"3px",margin:"auto","max-width":"180px"}}).inject(this.msgTextView),f.push({text:r.Save||"Save",name:"Save"}),v.Save=function(){t.SaveToDisk(e.msg.data,g)}):"fileTransferInvitation"===e.msg.typeData?this.fileTransferInvitation=!0:"coreviewInvitation"===e.msg.typeData&&(this.coreviewInvitation=!0);!u&&w&&(!w.uri||"string"!=typeof w.uri||-1==w.uri.indexOf("http")&&-1==w.uri.indexOf("www")?w.data&&w.data.items&&w.data.items.length>0&&w.data.items[0].urlContent?u=w.data.items[0].urlContent:"string"!=typeof w.data||0!==w.data.indexOf("http")&&0!==w.data.indexOf("www")?w.data.data&&w.data.data.items&&w.data.data.items.length>0&&w.data.data.items[0].urlContent?u=w.data.data.items[0].urlContent:n.debug("3DIM RTMsgView init - no url found in parsed data"):u=w.data:u=w.uri),u&&(f.push({text:r.Open||"Open",name:"Open"}),v.Open=function(e){e&&e.preventDefault&&e.preventDefault();var t=u;if("3DDashboard"===s.getSetting("appName")&&u["3DD"]?t=u["3DD"]:u["3DSwym"]&&(t=u["3DSwym"]),"string"!=typeof t)return n.debug("RTMsgView unable to open link attached to dropped data");if(t.contains(window.location.hostname)){if(-1!=t.indexOf("#app"))window.open(t.substr(t.indexOf("#app"),t.length),"_self");else if(-1!=t.indexOf("#community")&&window.location.hostname.contains("3dswym")){var i=t.substr(t.indexOf("#community"),t.length);window.location.toString().contains("#home")?window.location=window.location.toString().replace("#home",i):window.open(i,"_self")}}else window.open(t,"_blank")}),m&&(this.msgDetailsData=UWA.createElement("div",{class:"RTMsgDetailsData"+this.msgType,id:"RTMsgDetailsData"+this.msgType,html:m}),u&&v.Open&&(this.msgDetailsData.addEvent("click",v.Open),this.msgDetailsData.setStyle("cursor","pointer")),this.msgDetailsData.inject(this.msgTextView)),"received"===this.msgType&&f.length>0&&(this.MenuIcon=UWA.createElement("span",{class:"fonticon handler fonticon-down-open",styles:{margin:"auto 0px",float:"left",color:"#B4B6BA",fontSize:"large",opacity:"0.4"},events:{mouseover:function(e){t.MenuIcon.style.opacity=1},mouseout:function(){t.MenuIcon.style.opacity=.2}}}),this.MenuIcon.inject(this.msgTextView),this.shareDropdownMenu=new i({target:this.MenuIcon,items:f,events:{onClick:function(e,t){v[t.name]()}}}),this.shareDropdownMenu.getContent().style.zIndex="3000")}},htmlDecode:function(e){var t=document.createElement("div");return t.innerHTML=e,0===t.childNodes.length?"":t.childNodes[0].nodeValue},urlify:function(e){try{var t=e.match(/(https?:\/\/[^\s]+)/g);if(Array.isArray(t)&&(t=t[0]),t)return{url:t,split:e.split(t)}}catch(e){n.debug("RTMsgView error urlify")}return{split:[e]}},getView:function(){return this.globalView},getType:function(){return this.msgType},SaveToDisk:function(e,t){for(var i=e.split(";"),n=i[1].split(","),s=i[0].split(":")[1],a=n[1],r=s,l=atob(a),c=[],d=0;d<l.length;d+=512){for(var h=l.slice(d,d+512),u=new Array(h.length),g=0;g<h.length;g++)u[g]=h.charCodeAt(g);var p=new Uint8Array(u);c.push(p)}var m=new Blob(c,{type:r});return o.saveAs(m,t),!0}})}),define("DS/InstantMessaging/js/view/RTShareContentView",["UWA/Class","UWA/Class/Events","DS/RTProxyDriver/RTLogger","DS/InstantMessaging/js/view/RTSearchView","DS/InstantMessaging/js/controller/RTEventBusController","DS/UIKIT/Input/Button","DS/RTProxyDriver/RTProxyDriver","DS/InstantMessaging/js/controller/RTSettingController","DS/UIKIT/SuperModal","DS/PlatformAPI/PlatformAPI","DS/InstantMessaging/js/controller/RTContactController","i18n!DS/InstantMessaging/assets/nls/feed"],function(e,t,i,n,s,o,a,r,l,c,d,h){"use strict";i.debug("RTShareContentView load");var u=function(e,t){return function(){console.log("RTShareContentView share with "+e.login);var i={login:e.login,tenant:r.getSetting("currentPlateformId").toLowerCase(),username:e.username||e.userName,presence:e.presence||e.status,action:"startChat",share:t};c.publish("im.ds.com",i)}},g=function(e,t){return function(n){return i.debug("RTShareContentView : add contacts. qty="+n.length),function(e,t,n){var s,o,a=[];if(Array.isArray(t))a=t;else{var l=Object.keys(t);for(o=0;s=l[o];o++)a.push(t[s].contactModel)}if(!(a.length>0))return i.debug("RTShareContentView addListOfContacts : list of contacts is empty");var c,h,g,p,m=r.getSetting("userLogin");for(o=0;o<a.length;o++)if((g=a[o])&&g.userId){var f=-1!=g.userId.indexOf("@")?g.userId.substring(0,g.userId.indexOf("@")):g.userId;if(f!==m&&decodeURI(f)!==m){if(p={userId:g.userId,userName:decodeURI(g.userName),login:decodeURI(f),addIcon:!1,where:"3DIMWeb",status:g.status,noClick:!0},e.getElementsByTagName("li")[p.login])continue;c=new d({contact:p,groupId:"searchChatId"}).getView(),h=UWA.createElement("li",{class:"RTShareContentListElement",id:p.login}),c.inject(h),c.addEvent("click",u(p,n)),h.inject(e)}}}(e,n,t)}};return e.extend(t,{init:function(e){return e.controller?(this.dragEnter=!1,this.globalView=UWA.createElement("div",{class:"RTShareContent",id:"RTShareContent"}),this.searchPart=UWA.createElement("section",{class:"RTShareWithPart",id:"RTShareWithPartSearch"}),this.searchPart.inject(this.globalView),this.searchView=new n({isForShareAPI:!0,holderTxt:"Search",controller:e.controller,searchClearIconViewAction:(t=this,function(){t.receiversListSearch.innerHTML=""})}),this.searchView.getView().inject(this.searchPart),this.receiversListSearch=UWA.createElement("ul",{class:"RTShareContentList"}),this.receiversListSearch.inject(this.searchPart),this.addContactListToSearchResults=g(this.receiversListSearch,e.content),a.addEvent(a.eventName.RESULTOFSEARCHFORSEARCHAPI,this.addContactListToSearchResults),this.rosterPart=UWA.createElement("section",{class:"RTShareWithPart",id:"RTShareWithPartRoster"}),this.rosterPart.inject(this.globalView),this.receiversListRoster=UWA.createElement("ul",{class:"RTShareContentList"}),this.receiversListRoster.inject(this.rosterPart),this.receiversListRoster.setAttribute("name",h.Recents||"Recents"),this.addContactListToRosterResults=g(this.receiversListRoster,e.content),e.controller.controller&&e.controller.controller.listOfGroup&&e.controller.controller.listOfGroup.Recents?this.addContactListToRosterResults(e.controller.controller.listOfGroup.Recents.listOfContact):i.debug("RTShareContentView can not find group Recents "),new l({renderTo:document.body}).dialog({body:this.globalView,title:h.ShareWith,buttons:[{className:"primary",value:h.Cancel,action:function(e){e.hide()}}]}),!0):i.debug("RTShareContentView needs a controller (RTChatController)");var t},destroy:function(){this.globalView.destroy()}})}),define("DS/InstantMessaging/js/view/RTChatHistoryView",["UWA/Date","UWA/Class","UWA/Class/Events","DS/UIKIT/Scroller","DS/UWPClientCode/I18n","DS/InstantMessaging/js/view/RTMsgView","DS/UIKIT/Spinner","DS/UIKIT/SuperModal","DS/UIKIT/Mask","DS/RTProxyDriver/RTLogger","DS/UIKIT/Alert","i18n!DS/InstantMessaging/assets/nls/feed"],function(e,t,i,n,s,o,a,r,l,c,d,h){"use strict";return c.debug("RTChatHistoryView load"),t.extend(i,{init:function(e){this.controller=e.controller,this.lastMsg=void 0,this.lastMsgTime=void 0,this.contactPicture=e.contactPicture,this.spinner=new a,this.messages=[],this.globalView=UWA.createElement("div",{class:"RTChatHistory",id:"RTChatHistory"}),this.scrollerView=new n({element:UWA.createElement("div",{class:"scrollable-body",styles:{flex:"1"},html:this.globalView})})},getView:function(){return this.globalView},mailInUri:function(t){if(!t.me||!t.him)return!1;for(var i=null,n="",s=0;s<this.messages.length;s++)!function(s,o){if(s.messages[o].typeData)return!1;n+="%0D%0A",void 0===s.messages[o].isSend&&(s.messages[o].isSend=s.messages[o].username===t.me),i!==s.messages[o].isSend&&(i=s.messages[o].isSend,n+="%0D%0A",n+="%09%09%09%09%09%09",n+=encodeURI(s.messages[o].isSend?t.me:t.him),n+="%0D%0A"),n+="%20%5B"+encodeURI(e.strftime(new Date(s.messages[o].dateMsg),"%Y-%m-%d %H:%M:%S"))+"%5D",n+="%09",n+=encodeURI(s.htmlDecode(s.messages[o].msg))}(this,s);return n={body:n,subject:"3DExperience Platform - Conversation history between "+t.him+" and "+t.me}},mail:function(t){if(!t.me||!t.him)return!1;for(var i=null,n="",s=0;s<this.messages.length;s++)!function(s,o){if(s.messages[o].typeData)return!1;n+="\r\n ",void 0===s.messages[o].isSend&&(s.messages[o].isSend=s.messages[o].username===t.me),i!==s.messages[o].isSend&&(i=s.messages[o].isSend,n+="\r\n ",n+="\t\t\t\t\t\t",n+=s.messages[o].isSend?t.me:t.him,n+="\r\n "),n+=" ["+e.strftime(new Date(s.messages[o].dateMsg),"%Y-%m-%d %H:%M:%S")+"]",n+="\t",n+=s.messages[o].msg}(this,s);return n={body:n,subject:"3DExperience Platform - Conversation history between "+t.me+" and "+t.him}},htmlDecode:function(e){var t=document.createElement("div");return t.innerHTML=e.escapeHTML(),0===t.childNodes.length?"":t.childNodes[0].nodeValue.replace(/&/g,"%26")},addMessageDates:function(e,t,i,n,s,o,a){var r;if(t){var l=UWA.createElement("div",{class:"RTMsgTimeLineDay",id:"RTMsgTimeLineDay",text:n?n+", "+s:s,styles:{fontSize:"10px",fontFamily:"arial",marginTop:"18px"}});r=e.getElementsByClassName("RTMsgTimeLineDay");for(var d=0;d<r.length;d++)r[d].innerHTML===l.innerHTML&&("top"==a?r[d].remove():t=!1)}if(i){var h=UWA.createElement("div",{class:"RTMsgTimeLine",id:"RTMsgTimeLine",date:s,text:o,styles:{fontSize:"10px",fontFamily:"arial",marginTop:t?"0px":"18px"}});r=e.getElementsByClassName("RTMsgTimeLine");for(d=0;d<r.length;d++)r[d].innerHTML===h.innerHTML&&r[d].getAttribute("date")}return"bottom"==a?(t&&l.inject(e,a),i&&h.inject(e,a)):"top"==a?(i&&h.inject(e,a),t&&l.inject(e,a)):c.debug("A message does not have a position"),!0},addMessage:function(t,i,n,a){if("media"==t.origin)return!0;if(!t)return c.debug("RTChatHistoryView addMessage has been called without message !");if("offlinemsg"===t.typeMsg)return!0;if(this.lastMsg&&this.lastMsg.message&&this.lastMsg.message.msg_id&&this.lastMsg.message.msg_id===t.msg_id)return c.debug("RTChatHistoryView addMessage doublon received !");var r=void 0;t.timestamp?(r=new Date(t.timestamp),t.dateMsg=(new Date).toISOString()):t.dateMsg?r=new Date(t.dateMsg):(r=new Date,t.dateMsg=(new Date).toISOString());var l=s.getCurrentLanguage(),d=e.strftime(r,"%H:%M"),u=r.getMinutes(),g=r.getHours(),p=r.getDay(),m=0;n=n||"bottom";l||(l=window.navigator.language);var f=r.toLocaleString(l,{weekday:"long"});(-1!=f.indexOf(",")||-1!=f.indexOf(":")||f.length>10)&&(f=null);var v=r.toLocaleDateString(l),w=!1,y=!1;if(a||"top"===n)w=!0,y=!0,this.lastMsgTime=r;else if(this.lastMsgTime){var T=this.lastMsgTime.getMinutes(),C=this.lastMsgTime.getHours();this.lastMsgTime.getDay()!==p&&(y=!0),T===u&&C===g||(this.lastMsgTime=r,w=!0)}else this.lastMsgTime=r,w=!0,y=!0;"bottom"==n&&(m+=this.addMessageDates(this.globalView,y,w,f,v,d,n));var I={controller:this,msg:t,msgType:i,activePicture:!0,contactPicture:this.contactPicture};this.lastMsg&&"received"===i&&"received"===this.lastMsg.getType()&&(I.activePicture=!1);var b=new o(I);if(this.lastMsg=b,this.lastMsg.getView().inject(this.globalView,n),"top"==n?m+=this.addMessageDates(this.globalView,y,w,f,v,d,n):this.scrollToBottom(),this.messages||(this.messages=[]),"top"===n?this.messages.unshift(t):this.messages.push(t),!this.alertBox||!this.alertBox.isVisible||"sent"!==i||t.typeMsg&&"result"==t.typeMsg||this.alertBox.destroy(),b.fileTransferInvitation&&"received"===i){var E=this;this.displayModalConfirm({content:h.confirmReceiveFileContent+" "+b.message.fileName,header:h.confirmReceiveFileHeader},function(e){if(e)return E.controller.acceptFile(b.message);!1===e&&E.controller.refuseFile(b.message)},!0)}return m},injectSpinner:function(e){this.spinner.inject(this.globalView,e||"top").show()},removeSpinner:function(){this.spinner.remove()},injectMessage:function(e,t){UWA.createElement("div",{class:"RTMsgTimeLineDay",id:"RTMsgTimeLineDay",text:e,styles:{fontSize:"10px",fontFamily:"arial",marginTop:"18px"}}).inject(this.globalView,t)},displayModalConfirm:function(e,t,i){var n,s=!this.controller.isRender;if(this.controller.show(),this.superModal||(this.superModal=new r({renderTo:this.globalView}),this.superModal.callbacks=[]),t&&(this.superModal.callbacks&&this.superModal.callbacks.length&&i?(this.superModal.callbacks.push(t),this.superModal.callback=(n=this.superModal.callbacks,function(e){if(void 0===e)return!0;for(var t in n)n[t](e);n.length=0})):this.superModal.callback=t),i&&this.superModal.modals.current){var o=this.superModal.modals.current.getBody().innerText+e.content;this.superModal.modals.current.destroy(),this.superModal.confirm(o,e.header||"Confirmation",this.superModal.callback||function(e){c.debug(e)})}else this.superModal.confirm(e.content||"Are you sure?",e.header||"Confirmation",this.superModal.callback||function(e){c.debug(e)});try{this.globalView.getElementsByClassName("modal modal-root")[0].setStyle("position","relative"),this.globalView.getElementsByClassName("modal-wrap")[0].setStyle("width","100%"),this.globalView.getElementsByClassName("modal-overlay in")[0].setStyle("position","relative")}catch(e){c.debug("tried to display a modal in a ChatPanl that has never be opened")}s?(this.controller.getPanel().panelView.style.display="none",this.controller.displayChat=!1):this.scrollToBottom()},mask:function(e){return e?l.mask(this.scrollerView.getContent()):l.unmask(this.scrollerView.getContent()),!0},alert:function(e){this.alertBox&&this.alertBox.isVisible&&this.alertBox.destroy(),this.alertBox=new d({visible:!0}).inject(this.scrollerView.getContent()),this.alertBox.add({className:e.className||"primary",message:e.message||"Done."})},scrollToBottom:function(){this.scrollerView.scrollTo(0,this.globalView.scrollHeight)}})}),define("DS/InstantMessaging/js/controller/RTGroupController",["UWA/Class","UWA/Class/Events","DS/InstantMessaging/js/view/RTGroupView","DS/InstantMessaging/js/model/RTGroupModel","DS/InstantMessaging/js/controller/RTContactController","DS/RTProxyDriver/RTProxyDriver","DS/InstantMessaging/js/controller/RTSettingController","DS/RTProxyDriver/RTLogger","DS/InstantMessaging/js/controller/RTEventBusController","i18n!DS/InstantMessaging/assets/nls/feed"],function(e,t,i,n,s,o,a,r,l,c){"use strict";return r.debug("RTGroupController load"),e.extend(t,{init:function(e){this.numberOfContact=0,this.listOfContact={},this.groupId=e.groupId,this.groupType=e.groupType,this.connection=e.connection,this.controller=e.controller,this.fonticonElement=e.fonticonElement,this.displayNumberOfcontact=e.displayNumberOfcontact,this.group=void 0,this.groupView=void 0,this.groupId&&this.initGroup(e)},initGroup:function(e){var t=this;if(e.controller=this,this.group=new n(e),this.group){o.addEvent(o.eventName.REMOVECONTACT,function(e){r.debug("RTGroupController : REMOVECONTACT received"),e.group!==t.groupId&&e.name!==t.groupId||!t.listOfContact[e.user]&&!t.listOfContact[e.user.login]||t.removeMember(t.listOfContact[e.user]||t.listOfContact[e.user.login])}),this.group.addEvent("onContactRemoved",function(e){t.removeMember(t.listOfContact[e.userId])});e={controller:this,groupType:this.groupType,isHidden:e.isHidden,idElement:this.groupId,displayNumberOfcontact:this.displayNumberOfcontact,isDraggable:e.isDraggable,isLocked:e.isLocked};this.groupView=new i(e),this.addTitle()}this.addEvent("RT_"+this.groupId+"_onGroupPictureClick",function(e){e.getNumberOfContact()>0&&(e.groupView.expand=!e.groupView.expand,e.groupView.resizeView())}),"rtc"===this.groupType&&(this.groupView.setDropData(!0),this.controller.addEvent("RTSwitchToEditMode",function(e){for(var i in t.listOfContact){t.listOfContact[i].setEditMode(e)}}))},onDragOver:function(e){if("rtc"===this.groupType){e.preventDefault();var t=e.dataTransfer.getData("text");if("3DMessaging"===(t=JSON.parse(t)).data.items[0].serviceId){var i=t.data.items[0].contact;this.addContact(i,!0),l.dispatch(l.eventName.ONADDCONTACT,[{user:i,group:this.groupId}]),"RTGroupPicturePreview"==e.srcElement.id&&o.dispatch(o.eventName.REMOVECONTACT,{user:i.userId,group:"_"})}}},getView:function(){return this.groupView.getView()},setIsHidden:function(e){this.groupView.setIsHidden(e)},getNumberOfContact:function(){return this.numberOfContact},addContact:function(e,t){if(void 0===this.listOfContact[e.userId]){this.numberOfContact++,this.group.addContact(e);var i={controller:this,connection:this.connection,groupId:this.groupId,contact:e},n=new s(i);n.setDraggable(!0),this.listOfContact[e.userId]=n,n.status&&"Offline"!=n.status&&this.listOfContact[e.userId].setStatus(e.status),"_"!==this.groupId&&this.groupView.addContact(n,t)}else this.listOfContact[e.userId].setStatus(e.status)},addTitle:function(){var e={controller:this,connection:this.connection,fonticonElement:this.fonticonElement,pictureElement:{eventName:"RT_"+this.groupId+"_onGroupPictureClick"},titleElement:{txt:this.group.getName(),eventName:"RT_"+this.groupId+"_onGroupPictureClick"}};"search"===this.groupType&&(e={controller:this,connection:this.connection,holderTxt:c.SearchField}),this.groupView.addTitle(e)},removeMember:function(e){this.numberOfContact--;var t=e.getId(),i=this.listOfContact[t];this.groupView.removeMember(i),delete this.listOfContact[t]},removeGroup:function(){this.clearAllElement(),this.groupView.getView().destroy(),l.dispatch(l.eventName.DISPLAYTRASHEDZONE,[!1])},clearAllElement:function(e){for(var t in this.numberOfContact=0,this.groupView.removeMessage(),this.listOfContact){var i=this.listOfContact[t];this.groupView.removeMember(i),delete this.listOfContact[t]}this.listOfContact={},this.groupView.numberOfContact=0,e||this.groupView.resizeView()},setConnection:function(e){this.connection=e},dislayMessage:function(e){this.numberOfContact++,this.groupView.dislayMessage(e)},setEditMode:function(e){this.groupView.setEditMode(e)},setChangeName:function(e){this.groupView.setChangeName(e)},sendRemove:function(e){r.debug("RTGroupController : REMOVEGROUP sendRemove"+this.groupId),o.dispatch(o.eventName.REMOVEGROUP,this.groupId)},getMember:function(e){return this.listOfContact[e]},getId:function(){return this.groupId},setId:function(e){for(var t in this.groupId=e,this.group.setId(e),this.groupView.idGroup=e,this.listOfContact)this.listOfContact[t].groupId=e},getName:function(){return this.group.getName()},setName:function(e){this.group.setName(e),this.groupView&&this.groupView.groupNameView&&this.groupView.groupNameView.textContent&&(this.groupView.groupNameView.textContent=e),this.groupView&&this.groupView.groupNameInput&&this.groupView.groupNameInput.elements&&this.groupView.groupNameInput.elements.input?this.groupView.groupNameInput.elements.input.value=e:r.debug("RTGroupController unable to rename the view of group "+e)},clearInput:function(){this.groupView.clearInput()},resizeView:function(){this.groupView.resizeView()}})}),define("DS/InstantMessaging/js/controller/RTChatController",["UWA/Class","UWA/Class/Events","DS/PlatformAPI/PlatformAPI","DS/InstantMessaging/js/ressources/FileSaver","DS/InstantMessaging/js/controller/RTPanelController","DS/InstantMessaging/js/controller/RTContactController","DS/InstantMessaging/js/model/RTChatModel","DS/InstantMessaging/js/view/RTElementView","DS/InstantMessaging/js/view/RTSendMsgView","DS/InstantMessaging/js/view/RTChatHistoryView","DS/InstantMessaging/js/view/RTMsgInfoContactView","DS/InstantMessaging/js/view/RTSendDataView","DS/RTProxyDriver/RTProxyDriver","DS/InstantMessaging/js/controller/RTEventBusController","DS/InstantMessaging/js/controller/RTSettingController","i18n!DS/InstantMessaging/assets/nls/feed","DS/RTColors/RTColors","DS/UIKIT/DropdownMenu","DS/RTProxyDriver/RTLogger","UWA/Class/Model","DS/UIKIT/Tooltip","DS/W3DXComponents/Views/Item/TileView","DS/UIKIT/Spinner"],function(e,t,i,n,s,o,a,r,l,c,d,h,u,g,p,m,f,v,w,y,T,C,I){"use strict";return w.debug("RTChatController load"),e.extend(t,{init:function(e){w.debug("RTChatController init"),this.controller=e.controller,this.connection=e.connection,this.id=e.id,this.shareSizeLimit=9e6,this.roomId=e.roomId,this.contact=void 0,this.chatModel=void 0,this.displayChat=!1,this.activeShare=p.getSetting("activeShare"),this.activeArchive=p.getSetting("activeArchive"),this.activeShareFile=p.getSetting("activeShareFile"),this.listOfMember={},this.initChat(e)},initChat:function(e){w.debug("RTChatController initChat");var t,i=this;if(this.contact=new o(e),this.contact){var r={id:this.id,controller:this,originXPos:e.originXPos,originYPos:e.originYPos,sizeOnY:e.sizeOnY,minimumSize:e.minimumSize,titleOpt:e.titleOpt,minimumResize:e.minimumResize,panelLarger:e.panelLarger,iconeIconise:e.iconeIconise};if(this.chat=new s(r),this.chat){this.contact.setDraggable(!0),this.id=this.contact.getId();r={connection:this.connection,controller:this,contact:this.contact};this.chatModel=new a(r),this.chat.addEvent(this.id+"Closed",function(e){i.displayChat=!1,i.controller.closeChatPanel(i.id,i.contact,e),i.chat.setOriginPosition({originXPos:345})}),this.chat.addEvent(this.id+"Minimized",function(e){i.chat.setTitle(i.contact.getUserName()),i.sendChatView.getView().style.display="none"}),this.chat.addEvent(this.id+"ArchiveTrash",function(e){w.debug("RTChatController ArchiveTrash"),g.dispatch(i.id+"HideArchiveMenu",{}),i.historyOfChat.displayModalConfirm({header:m.Confirmation,content:m.ConfirmCleanArchive},function(t){if(t){i.historyOfChat.mask(!0);for(var n=!1,s=0;s<i.historyOfChat.messages.length;s++)if(!i.historyOfChat.messages[s].typeData){n=!0;break}if(!n)return i.onArchiveReceived({type:"archiveCleaned",roomID:i.id,qty:66});i.historyOfChat.messages[i.historyOfChat.messages.length-1]?u.dispatch(u.eventName.CLEANARCHIVES,{interlocuteur:e,lastMessageID:i.historyOfChat.messages[i.historyOfChat.messages.length-1].msg_id,uuid:i.uuid}):u.dispatch(u.eventName.CLEANARCHIVES,{interlocuteur:e})}else g.dispatch(i.id+"DisplayArchiveMenu",{})})}),this.chat.addEvent(this.id+"ArchiveMail",function(){w.debug("RTChatController ArchiveMail "+this.id+"ArchiveMail");var e=i.historyOfChat.mail({me:p.getSetting("userName"),him:i.contact.contactModel.getUserName()});i.controller.lockMail=!0;var t=new Blob([e.body],{type:"text/plain;charset=utf-8"});n.saveAs(t,e.subject+".txt")}),this.historyOfChat=new c({controller:this,contactPicture:this.contact.getPicture()}),this.historyOfChat&&this.chat.addElement(this.historyOfChat.scrollerView.getContent()),this.msgUserInfo=new d,this.msgUserInfo&&(this.chat.addElement(this.msgUserInfo.getView()),"Offline"!==this.contact.getStatus()&&this.msgUserInfo.display(!1)),this.activeShare&&(this.sendGeneratedView=function(e,t,n,s,o){if(!e)return null===e?w.debug("RTChatController - dropped widget format is not supported"):!1===e?w.debug("RTChatController - can not generate html view from dropped widget"):w.debug("RTChatController - unknown error about generatedStringView");var a;try{a=btoa(unescape(encodeURIComponent(e)))}catch(e){return w.debug("RTChatController - unable to btoa generated view")}"coreviewInvitation"==s&&(t=JSON.stringify(t));var r={data:btoa(unescape(encodeURIComponent(t))),datahtml:a,uri:n};r=btoa(JSON.stringify(r)),i.sendData({data:r,typeData:s,options:o})},this.displayAlertSizeLimitReached=(t=this.historyOfChat,function(){t.alert({className:"error",message:m.ShareSizeLimitReached+" "+this.shareSizeLimit/1e6+(m.MegaOctet||"MB")})}),this.displayAlertError=function(e){return function(t){e.alert({className:"error",message:t||m.canceled})}}(this.historyOfChat),this.sendDataFromDrop=function(e){var t=p.getSetting("shareSizeLimit")||9e6;e.stopPropagation(),e.preventDefault();var n,s,o,a=e?e.dataTransfer?e.dataTransfer.files:e.target?e.target.files:null:null,r=[],l=null;if(a&&a.length>0&&(1==e.dataTransfer.types.length||e.dataTransfer.types[0]&&-1!=e.dataTransfer.types[0].indexOf("moz"))){if(n="fileTransfer",!i.activeShareFile)return w.debug("File sharing is not activated");var c,d="";for(c=0;a[c];c++){d=a[c].name,r[d]=new FileReader,r[d].fileName=d;var h="3DIMfiletransfer"+Date.now();r[d].fileId=h,r[d].size=a[c].size,r[d].size>t?i.displayAlertSizeLimitReached():(r[d].onloadend=function(e){w.debug("RTChatController : file loaded : "+e.target.fileName),i.sendDataView.files||(i.sendDataView.files={}),i.sendDataView.files[e.target.fileId]={data:e.target.result,fileName:e.target.fileName,fileId:e.target.fileId},s={fileId:e.target.fileId,fileName:e.target.fileName,fileLength:e.target.size},l=i.sendDataView.generateViewFromFile(s),i.sendGeneratedView(l,s,o,"fileTransferInvitation",s),i.replaceProgressBar(e.target.fileId,m.Waiting,f.away),delete r[d]},r[d].readAsDataURL(a[c]))}}else{var u,g;if(n="DS3DXContent",e.dataTransfer&&e.dataTransfer.getData&&e.dataTransfer.types){if(Array.prototype.contains||(Array.prototype.includes?Array.prototype.contains=Array.prototype.includes:Array.prototype.contains=function(t){return-1!=e.dataTransfer.types.indexOf(t)}),e.dataTransfer.types.contains("text")||e.dataTransfer.types.contains("Text"))s=e.dataTransfer.getData("text");else{if(!e.dataTransfer.types.contains("text/plain"))return w.debug("RTChatController ondrop senddata view : no data found in dataTransfer");s=e.dataTransfer.getData("text/plain")}u=e.dataTransfer.types.contains("text/plain")?e.dataTransfer.getData("text/plain"):s,o=e.dataTransfer.types.contains("text/uri-list")?e.dataTransfer.getData("text/uri-list"):e.dataTransfer.types.contains("Url")?e.dataTransfer.getData("Url"):s.url?s.url:null,g=e.dataTransfer.types.contains("text/html")?e.dataTransfer.getData("text/html"):s}else{if(!e.detail)return w.debug("RTChatController ondrop senddata view : no data attached");u=s=e.detail,g=s,o=s.url?s.url:e.detail.data&&e.detail.data.items&&e.detail.data.items[0]?e.detail.data.items[0].urlContent:null}var v=void 0;if("object"==typeof s)v=s;else try{v=JSON.parse(decodeURIComponent(s)),o||(o=v.data.items&&v.data.items[0]?v.data.items[0].urlContent:null)}catch(e){w.debug(e),v=void 0}if(v&&v.data&&v.data.items&&v.data.items[0]){if("3DDrive"==v.data.items[0].serviceId)return i.displayAlertError(m.actionNotSupported||"This action is not supported"),!1;"3DSwym"!=v.data.items[0].serviceId&&"3DSpace"!=v.data.items[0].serviceId&&"X3DCSMA_AP"!==v.source&&"X3DMCTY_AP"!==v.source&&"X3DWNEW_AP"!=v.source&&"X3DDRIV_AP"!=v.source&&"X3PDRIV_AP"!=v.source||(l=i.sendDataView.generateViewFromJson(v.data.items[0]))||(l=i.sendDataView.generateViewFromTile(v.data.items[0]))}else{if(v&&v.type&&"coreview"==v.type)return v.channel?(this.initCoreview(v.channel,!0),l=null,i.sendGeneratedView("<div></div>",v,null,"coreviewInvitation",v),i.historyOfChat.alert({message:m.collabInvitationSent,className:"success"}),!0):w.debug("RTChatController sendDataFromDrop received a coreview without channel !");g&&-1!=g.indexOf("item-title")&&(l=i.sendDataView.generateViewFromNetvibes(g))}if(!l){if(g&&"string"==typeof g){var y=g.slice(g.length-3);if(0===g.indexOf("<img")){var T=u;-1!=T.indexOf("thumb")&&(T=g),l=i.sendDataView.generateViewFromImage(T),o=i.sendDataView.getURLFromImageString(l)}else 0!=g.indexOf("http")||"jpg"!=y&&"png"!=y&&"gif"!=y&&"bmp"!=y?-1!=g.indexOf("<a")&&(l=i.sendDataView.generateViewFromLink(g)):l=i.sendDataView.generateViewFromImage(g)}!l&&o&&o.length>0&&(l=i.sendDataView.generateViewFromUrl(o))}if(l&&l.length>t)return this.displayAlertSizeLimitReached(),!1;if(!l)return i.displayAlertError(m.formatNotSupported||"This content type is not supported"),!1;i.sendGeneratedView(l,s,o,n)}},this.sendDataView=new h({panelId:this.id,events:{ondrop:this.sendDataFromDrop}}),this.sendDataView&&this.chat.addElement(this.sendDataView.getView())),this.sendChatView=new l({controller:this,holderTxt:m.PlaceHolderInputMsgSend}),this.sendChatView&&this.chat.addElement(this.sendChatView.getView()),void 0===this.contact.getStatus()&&this.sendChatView.SendState(!1),u.addEvent(u.eventName.ONMESSAGERECEIVED,function(e){w.debug("RTChatController : ONMESSAGERECEIVED"),e.from!==i.contact.getId()&&e.to!==i.uuid||i.onMessageReceived(e)}),u.addEvent("onLeaveRoom",function(e){e.user.login!==i.contact.getId()&&e.room_id!==i.uuid||(w.debug("RTChatController : roomLeft room_id : "+e.room_id+" user : "+e.user.login),i.msgUserInfo.display(!0,"ContactRemovedMessage"))}),u.addEvent(u.eventName.ONPRESENCERECEIVED,function(e){w.debug("RTChatController : ONPRESENCERECEIVED");var t=p.getSetting("userLogin");if(e.userId===i.contact.getId()){e.username&&(i.chat.titlePanel.titleNameView.innerText=e.username);p.getSetting("RTCStatus");i.chat.titlePanel.dropdownMenuArchive&&!document.callAlwaysAvailable&&i.chat.titlePanel.dropdownMenuArchive.deactivateCallButtons(),"Offline"===e.status?(i.chat.changeTitleMainIconColor(f.offline),i.chat.changeTitleMainIconClassName(""),i.msgUserInfo.display(!0),i.stopCoreview(!0)):i.msgUserInfo.display(!1),"Online"===e.status&&(i.chat.changeTitleMainIconColor(f.online),i.chat.changeTitleMainIconClassName("fonticon handler fonticon-check"),i.chat.titlePanel.dropdownMenuArchive&&("Online"==p.getSetting("userStatus")||document.callAlwaysAvailable)&&i.chat.titlePanel.dropdownMenuArchive.activateCallButtons()),"Away"===e.status&&(i.chat.changeTitleMainIconColor(f.away),i.chat.changeTitleMainIconClassName("fonticon handler fonticon-cancel")),"Busy"===e.status&&(i.chat.changeTitleMainIconColor(f.busy),i.chat.changeTitleMainIconClassName("fonticon handler fonticon-minus")),"DND"===e.status&&(i.chat.changeTitleMainIconColor(f.busy),i.chat.changeTitleMainIconClassName("fonticon handler fonticon-minus"))}else t===e.userId&&i.chat.titlePanel.dropdownMenuArchive&&("Online"===e.status&&"Online"==p.getSetting("userStatus")||document.callAlwaysAvailable?i.chat.titlePanel.dropdownMenuArchive.activateCallButtons():i.chat.titlePanel.dropdownMenuArchive.deactivateCallButtons())}),g.addEvent(g.eventName.PANELICONISED,function(e){w.debug("RTChatController : PANELICONISED"),e===i.id&&(i.sendChatView.getView().style.display="none")}),g.addEvent(g.eventName.PANELMAXIMIZED,function(e){w.debug("RTChatController : PANELMAXIMIZED"),e===i.id&&(i.isAnIcon()&&i.startChatWith(i.contact),i.sendChatView.getView().style.display="block",i.sendChatView.focus())}),this.activeShare&&(g.addEvent(g.eventName.ONPANELDRAGOVER,function(e){e===i.id&&i.sendDataView&&!i.sendDataView.isDisplayed&&i.sendDataView.display(!0)}),g.addEvent(g.eventName.ONPANELDRAGLEAVE,function(e){w.debug("RTChatController : ONPANELDRAGOVER"),e===i.id&&i.sendDataView&&i.sendDataView.isDisplayed&&i.sendDataView.display(!1)}),g.addEvent(g.eventName.ONPANELDROP,function(e){e===i.id&&i.sendDataView&&!i.sendDataView.isDisplayed&&i.sendDataView.dispatch("ondrop",e)})),this.activeArchive&&(this.historyOfChat.injectSpinner(),u.dispatch(u.eventName.GETARCHIVES,[{from:i.id,uuid:i.uuid,roomid:i.id,archive_qty:p.getSetting("archive_qty")||10}])),u.addEvent(u.eventName.ONARCHIVERECEIVED,function(e){w.debug("RTChatController : ONARCHIVESRECEIVED"),e.dateMsg&&(e.dateMsg=e.dateMsg.replace(/ /g,"T")),i.onArchiveReceived(e)})}}},initCoreview:function(e,t){if(!e||"string"!=typeof e)return w.debug("RTChatController initCoreview received a coreview without channel !");var n;this.coreviewChannel=e,w.debug("RTChatController : initCoreview"),i.subscribe(this.coreviewChannel,(n=this,function(e){if("dataCollab"==e.action){if("object"!=typeof e)return w.debug("RTChatController received bad dataCollab");n.sendData({data:btoa(JSON.stringify(e)),typeData:"dataCollab"})}}))},endCoreview:function(e){if(!e||e!=this.coreviewChannel)return w.debug("RTChatController endCoreview coreview channel does not match the current one!");this.stopCoreview(),this.hideCoreviewMenu(),this.coreviewChannel=null},displayCoreviewMenu:function(e){if(!this.coreviewChannel)return w.debug("ChatController displayCoreviewMenu called without channel");var t;this.chat.titlePanel.injectCoreviewMenu(),this.chat.titlePanel.coreviewButton.style.display="inline-block",this.chat.titlePanel.coreviewDropDownMenu=new v({target:this.chat.titlePanel.coreviewButton,items:[{text:m.CoreviewStop||"Stop Coreview",name:"wtf",icon:"fonticon fonticon-stop",handler:(t=this,function(){t.stopCoreview()})}]}),this.chat.titlePanel.coreviewDropDownMenu.getContent().style.zIndex="3000",e||this.chat.titlePanel.coreviewDropDownMenu.addItem({text:m.CoreviewRequestMaster||"Request control",name:"wtf",icon:"fonticon fonticon-switch",handler:function(e){return function(){e.historyOfChat.alert("not implemented yet")}}(this)})},hideCoreviewMenu:function(){if(this.chat.titlePanel.destroyCoreviewMenu(),!this.chat.titlePanel.coreviewDropDownMenu)return!0;this.chat.titlePanel.coreviewDropDownMenu.destroy(),this.chat.titlePanel.coreviewButton.style.display="none"},onDataCollabReceived:function(e){i.publish(this.coreviewChannel,{action:"dataCollabReceived",data:e})},acceptCoreview:function(e){e||w.debug("acceptCoreview without channel"),this.displayCoreviewMenu(),this.sendData({data:"accept",typeData:"coreviewInvitation",options:{accept:!0,channel:e}}),this.coreviewChannel=e,this.initCoreview(e,!1),this.startCoreview(!1),i.publish(this.coreviewChannel,{action:"subscribeToChannelAndStartCollab",channel:e})},refuseCoreview:function(e){this.sendData({data:"refuse",typeData:"coreviewInvitation",options:{accept:!1,channel:e}})},startCoreview:function(e){if(!this.coreviewChannel)return w.debug("startCoreview without channel");this.displayCoreviewMenu(e),u.dispatch(u.eventName.SETSTATUS,{myStatus:"Busy",statusMsg:"Busy"}),i.publish(this.coreviewChannel,{action:"startCollab",isMaster:e})},stopCoreview:function(e){if(!this.coreviewChannel)return w.debug("stopCoreview without channel");this.hideCoreviewMenu(),this.historyOfChat.alert({message:m.collabStopped,className:"warning"}),i.publish(this.coreviewChannel,{action:"stopCollab"}),u.dispatch(u.eventName.SETSTATUS,{myStatus:"Online",statusMsg:"Online"}),!0!==e&&this.sendData({data:"stop",typeData:"coreviewInvitation",options:{channel:this.coreviewChannel}})},onArchiveReceived:function(e){if(this.historyOfChat&&(this.id==e.roomID||this.uuid&&this.uuid===e.uuid)){if(this.historyOfChat.messagestemp||(this.historyOfChat.messagestemp=[]),this.uuid||(this.uuid=e.uuid),e.type){if("archive_qty"==e.type&&(e.archive_qty||0===e.archive_qty))return!!this.historyOfChat.messagestemp_qty||(this.historyOfChat.messagestemp_qty=e.archive_qty,"0"!==this.historyOfChat.messagestemp_qty&&0!==this.historyOfChat.messagestemp_qty||this.historyOfChat.NoMoreArchive||(this.historyOfChat.NoMoreArchive=!0,this.historyOfChat.scrollerView.getInnerElement().onscroll=null,this.historyOfChat.removeSpinner(),this.historyOfChat.messages.length>1&&this.historyOfChat.injectMessage(m.NoMoreArchive,"top")),!0);if("archiveCleaned"==e.type)return w.debug("3DIM RTChatController - archiveCleaned stanza received"),this.historyOfChat.mask(!1),e.qty&&-1!==e.qty&&"-1"!==e.qty?(this.historyOfChat.globalView.empty(),this.historyOfChat.messages.length=0,delete this.historyOfChat.lastMsgTime,this.historyOfChat.alert({message:m.CleanArchiveConfirmed,className:"success"})):this.historyOfChat.alert({message:m.CleanArchiveFailed,className:"error"}),!0}if(void 0===this.historyOfChat.messagestemp_qty&&(this.historyOfChat.messagestemp_qty=0),"3DIMmessages3DIMsoon3DIMdeleted3DIM"===e.msg)return e.isSend&&this.historyOfChat.alert({message:m.SoonPurgeArchive,className:"warning"}),this.historyOfChat.messagestemp_qty--,this.historyOfChat.removeSpinner(),!0;if("3DIMmessages3DIMdeleted3DIM"===e.msg)return e.isSend&&this.historyOfChat.alert({message:m.PurgeArchive,className:"info"}),this.historyOfChat.messagestemp_qty--,this.historyOfChat.removeSpinner(),!0;if(this.historyOfChat.messagestemp.push(e),this.historyOfChat.messagestemp.length>=this.historyOfChat.messagestemp_qty){this.historyOfChat.messagestemp_qty=0,this.historyOfChat.messagestemp.sort(function(e,t){if(e.msg_id&&t.msg_id&&!isNaN(e.msg_id)){if(e.msg_id<t.msg_id)return-1;if(e.msg_id>t.msg_id)return 1}else{if(!e.dateMsg||!t.dateMsg)return 1;var i=new Date(e.dateMsg.replace(/ /g,"T")),n=new Date(t.dateMsg.replace(/ /g,"T"));if(i<n)return-1;if(i>n)return 1}return 0});for(var t=!this.historyOfChat.messages||!this.historyOfChat.messages.length,i=t?0:this.historyOfChat.lastMsg.globalView,n=this.historyOfChat.messagestemp.length-1;n>=0;n--)this.historyOfChat.addMessage(this.historyOfChat.messagestemp[n],this.historyOfChat.messagestemp[n].isSend?"sent":"received","top",!1);this.historyOfChat.removeSpinner(),g.dispatch(this.id+"DisplayArchiveMenu",{}),t?this.historyOfChat.scrollToBottom():this.historyOfChat.scrollerView.scrollTo(0,i.getBoundingClientRect().top-this.historyOfChat.getView().getBoundingClientRect().top),this.historyOfChat.lastMessageID=this.historyOfChat.messagestemp[0].msg_id||0,this.historyOfChat.messagestemp.length=0,delete this.historyOfChat.messagestemp_qty,this.canGetArchive=!0}}},onMessageReceived:function(e){if(w.debug("RTChatController onMessageReceived"),this.historyOfChat){if(e.fileId){if(e.numpart&&e.nbpart){if("fileTransfer"==e.typeData&&"progress"===e.data)return e.numpart>=e.nbpart&&this.sendDataView.files&&(this.sendDataView.files[e.fileId]=null),this.setProgressBar(e.fileId,e.nbpart,e.numpart);if("fileTransferInvitation"!=e.typeData){var t=parseInt(e.numpart,10),i=parseInt(e.nbpart,10);if(this.setProgressBar(e.fileId,i,t),this.sendData({data:"progress",typeData:"fileTransfer",options:{numpart:t,nbpart:i,fileName:e.fileName,fileId:e.fileId}}),t<i)return!0;if(t>i)return w.debug("RTChatController onMessageReceived - a file transfer is taking too much parts !!! (severe error)")}}if("fileTransferInvitation"==e.typeData&&("accept"==e.data||"refuse"==e.data)){var n=this.sendDataView.files[e.fileId];return n?("accept"==e.data?(w.debug("fileTransfer accepted "+e.fileName),this.replaceProgressBar(e.fileId,m.InProgress,f.away),this.sendData({data:n.data,typeData:"fileTransfer",options:n})):"refuse"==e.data&&(w.debug("fileTransfer refused "+e.fileName),this.replaceProgressBar(e.fileId,m.canceled),delete this.sendDataView.files[e.fileId]),!0):w.debug("ERROR file not found : "+e.fileId+e.fileName)}}else{if("coreviewInvitation"===e.typeData){switch(e.data){case"accept":this.historyOfChat.alert({message:m.collabAccepted,className:"success"}),this.startCoreview(!0);break;case"refuse":this.historyOfChat.alert({message:m.collabRefused,className:"error"});break;case"stop":this.stopCoreview(!0);default:var s;try{s=JSON.parse(decodeURIComponent(atob(JSON.parse(atob(e.data)).data))).channel}catch(e){return w.debug("RTChatController received a coreviewInvitation but can not find the channel ")}this.historyOfChat.displayModalConfirm({content:m.confirmReceiveCoreview,header:m.confirmReceiveCoreviewHeader},(o=this,function(e){if(e)return o.acceptCoreview(s);!1===e&&o.refuseCoreview(s)}),!0)}return!0}if("dataCollab"===e.typeData)return this.onDataCollabReceived(e.data),!0}g.dispatch(this.id+"DisplayArchiveMenu",{}),this.historyOfChat.addMessage(e,e.from===p.getSetting("userLogin")?"sent":"received","bottom",!this.historyOfChat.messages||!(this.historyOfChat.messages.length>0))}var o;this.chatModel&&this.chatModel.onMessageReceived(e)},setProgressBar:function(e,t,i){return!e||isNaN(t)||isNaN(i)?w.debug("RTChatController setProgressBar bad args"):t==i?this.replaceProgressBar(e,m.fileTransferComplete,f.online):document.getElementById(e)?(this.historyOfChat.injectSpinner("bottom"),void this.historyOfChat.scrollToBottom()):w.debug("setProgressBar : div of the file not found")},replaceProgressBar:function(e,t,i){if(!e||!t)return w.debug("RTChatController replaceProgressBar bad args");this.historyOfChat.removeSpinner();var n=document.getElementById(e);if(!n)return w.debug("replaceProgressBar : div of the file not found");var s=n.getElementsByTagName("progress")[0];if(!s)return w.debug("replaceProgressBar : div of the progress bar not found");var o=e+"RTProgressStatus",a=document.getElementById(o);a&&(a.remove?a.remove():a.removeNode?a.removeNode():w.debug("replaceProgressBar did not find a function to remove the dom element of progress bar Status"));var r=document.createElement("div");r.id=o,r.appendChild(document.createTextNode(t)),r.style.color=i||f.busy,s.parentElement.appendChild(r)},sendMessage:function(e,t){if(w.debug("RTChatController sendMessage"),this.historyOfChat){var i=new Date,n=UWA.Date.strftime(i,"%Y-%m-%d %H:%M:%S"),s=i.getTime(),o=p.getSetting("userLogin"),a=p.getSetting("userName"),r={dateMsg:n,timestamp:s,to:this.contact.getId(),username:a,login:o,status:this.contact.getStatus(),activeArchive:this.activeArchive,where:"3DIMWeb",msg:e,room:this.id,uuid:this.uuid},l={dateMsg:n,timestamp:s,to:this.contact.getId(),username:a,login:o,status:this.contact.getStatus(),activeArchive:this.activeArchive,where:"3DIMWeb",msg:e};this.historyOfChat.addMessage(l,"sent"),g.dispatch(this.id+"DisplayArchiveMenu",{}),u.dispatch(u.eventName.SENDMSG,[r])}},acceptFile:function(e){this.historyOfChat.injectSpinner("bottom"),this.historyOfChat.scrollToBottom(),this.sendData({data:"accept",typeData:"fileTransferInvitation",options:{accept:!0,fileName:e.fileName,fileId:e.fileId}})},refuseFile:function(e){this.sendData({data:"refuse",typeData:"fileTransferInvitation",options:{accept:!1,fileName:e.fileName,fileId:e.fileId}}),this.replaceProgressBar(e.fileId,m.canceled)},sendData:function(e){if(w.debug("RTChatController sendData"),this.historyOfChat){var t=new Date,i=UWA.Date.strftime(t,"%Y-%m-%dT%H:%M:%S"),n=t.getTime(),s=p.getSetting("userLogin"),o=p.getSetting("userName"),a={crdate:i,timestamp:n,to:this.contact.getId(),username:o,login:s,status:this.contact.getStatus(),where:"3DIMWeb",data:e.data,persisted:e.persisted,typeData:e.typeData,fileName:e.options?e.options.fileName:null,fileId:e.options?e.options.fileId:null,nbpart:e.options?e.options.nbpart:null,numpart:e.options?e.options.numpart:null,accept:e.options?e.options.accept:null,roomId:this.uuid};"accept"!=e.data&&"refuse"!=e.data&&"progress"!=e.data&&"coreviewInvitation"!=e.typeData&&"dataCollab"!=e.typeData&&("fileTransfer"==e.typeData?a.nbpart>=a.numpart&&this.historyOfChat.addMessage(a,"sent"):this.historyOfChat.addMessage(a,"sent")),g.dispatch(this.id+"DisplayArchiveMenu",{}),u.dispatch(u.eventName.SENDDATA,[a])}},move:function(e,t){w.debug("RTChatController move"),this.chat.move(e,t)},getOldPosition:function(){return w.debug("RTChatController getOldPosition"),this.chat.getOldPosition()},getOriginPosition:function(){return w.debug("RTChatController getOriginPosition"),this.chat.getOriginPosition()},render:function(e){w.debug("RTChatController render"),this.chat.render(e),this.chat.maximized(),this.displayChat=!0,this.isRender=!0},maximize:function(){w.debug("RTChatController maximize"),this.chat&&this.chat.maximized()},iconise:function(){w.debug("RTChatController iconise"),this.sendChatView.getView().style.display="none",this.chat.iconise()},getPanelLarger:function(){return w.debug("RTChatController getPanelLarger"),this.chat.getLarger()},isDisplay:function(){return w.debug("RTChatController isDisplay"),this.displayChat},isAnIcon:function(){return w.debug("RTChatController isAnIcon"),this.chat.isAnIcon()},getContact:function(){return w.debug("RTChatController getContact"),this.contact},getPanel:function(){return w.debug("RTChatController getPanel"),this.chat},show:function(){if(w.debug("RTChatController show"),!this.displayChat){var e={userName:this.contact.getUserName(),login:this.contact.getLogin(),userId:this.contact.getId(),status:this.contact.getStatus()};this.controller.addContactToRecentChat(e),this.isRender?(this.displayChat=!0,this.chat.setDisplayPanel(this.displayChat),g.dispatch(g.eventName.ONMAXIMIZEDCLICK,[this.chat.id])):(this.displayChat=!0,this.render(document.body));var t=this.historyOfChat.getView().scrollHeight;this.historyOfChat.scrollerView.scrollTo(0,t),u.dispatch(u.eventName.GETSTATUS,[e]),this.activeArchive&&(this.historyOfChat.scrollerView.getInnerElement().onscroll=function(){if(this.historyOfChat.NoMoreArchive)return!1;!this.historyOfChat.scrollerView.getInnerElement().scrollTop&&this.historyOfChat.messages&&this.historyOfChat.messages.length&&this.canGetArchive&&(this.canGetArchive=!1,this.historyOfChat.injectSpinner(),u.dispatch(u.eventName.GETARCHIVES,[{to:this.id,uuid:this.uuid,archive_qty:p.getSetting("archive_qty")||10,roomid:this.id,lastMessageID:this.historyOfChat.lastMessageID}]))}.bind(this))}},setNotif:function(e){w.debug("RTChatController setNotif"),this.chat.setNotif(e)},getNumberOfIconiseChat:function(){return w.debug("RTChatController getNumberOfIconiseChat"),this.controller.getNumberOfIconiseChat()},startChatWith:function(e){w.debug("RTChatController startChatWith"),g.dispatch(g.eventName.STARTCHAT,[e])},getWidth:function(){return this.chat.getWidth()},setDisplayPanel:function(e){this.chat.setDisplayPanel(this.displayPanel)}})}),define("DS/InstantMessaging/js/controller/RTBuddyListController",["UWA/Class","UWA/Class/Events","UWA/Utils","DS/InstantMessaging/js/controller/RTPanelController","DS/InstantMessaging/js/view/RTListOfGroupView","DS/InstantMessaging/js/view/RTBottomBarView","DS/InstantMessaging/js/controller/RTGroupController","DS/RTProxyDriver/RTProxyDriver","DS/InstantMessaging/js/controller/RTEventBusController","DS/InstantMessaging/js/controller/RTSettingController","i18n!DS/InstantMessaging/assets/nls/feed","DS/RTProxyDriver/RTLogger","DS/RTColors/RTColors"],function(e,t,i,n,s,o,a,r,l,c,d,h,u){"use strict";return h.debug("RTBuddyListController load"),e.extend(t,{init:function(e){this.editMode=!1,this.listOfGroup={},this.listOfCurrent={},this.listOfRecent={},this.activeEditMode=!1,this.connected=!1,this.id=e.id,this.controller=e.controller,this.sizeOnY=e.sizeOnY,this.originXPos=e.originXPos,this.originYPos=e.originYPos,this.minimumSize=e.minimumSize,this.titleOpt=e.titleOpt,this.minimumResize=e.minimumResize,this.panelLarger=e.panelLarger,this.active3DIM=e.active3DIM,this.searchString="",this.initBuddylistPanel(),this.initEventListener(),this.groups3DIM=UWA.Utils.getQueryString(document.URL,"groups3DIM"),this.updateNotDone=!0},initBuddylistPanel:function(){var e=this,t={id:this.id,controller:this,originXPos:this.originXPos,originYPos:this.originYPos,sizeOnY:this.sizeOnY,minimumSize:this.minimumSize,titleOpt:this.titleOpt,minimumResize:this.minimumResize,panelLarger:this.panelLarger,iconeIconise:{type:"span",src:"fonticon handler fonticon-list",activeMiniStatus:!0,hiddenAfterClick:!0},showOfflineView:!0,active3DIM:this.active3DIM};this.buddyList=new n(t),UWA.Utils.getQueryString(document.URL,"maxi3DIM")?this.buddyList.maximized():l.dispatch(l.eventName.ONICONISEPANELCLICK,[e.getId()]);t={groupId:"searchChatId",controller:this,groupType:"search"};this.searchController=new a(t),this.listOfGroup.searchChatId=this.searchController;var i=this.searchController.getView();i?(h.debug("RTBuddyListController : Add search View done."),this.buddyList.addElement(i)):h.debug("RTBuddyListController : Error Add search view."),this.listOfGroupView=new s;var r=UWA.createElement("div",{styles:{width:"100%",height:"5px"},events:{}});r.ondragover=function(t){h.debug("RTBuddyListController : Scroller test."),e.listOfGroupView.mouveUp()},this.buddyList.addElement(r),this.buddyList.addElement(this.listOfGroupView.getView()),t={groupId:"Recents",titleGroup:"Recents",fonticonElement:"fonticon-clock",isHidden:!0,connection:this.connection,controller:this,groupType:"rtc",displayNumberOfcontact:!0,isDraggable:!1,isLocked:!0},this.recentChatController=new a(t),this.listOfGroup.Recents=this.recentChatController;var c=this.recentChatController.getView();c?this.listOfGroupView.addElement(c):h.debug("RTBuddyListController : Error get recentChatControllerView controller view.");var d=UWA.createElement("div",{styles:{width:"100%",height:"5px"},events:{}});d.ondragover=function(t){e.listOfGroupView.mouveDownp()},this.buddyList.addElement(d),this.bottomBarView=new o({controller:this}),this.buddyList.addElement(this.bottomBarView.getView()),this.listOfGroupView.setNoElement(!0)},initEventListener:function(){var e=this;r.addEvent(r.eventName.STATUSUPDATED,function(t){h.debug("RTBuddyListController : STATUSUPDATED received");c.getSetting("RTCStatus");"Online"===t&&e.buddyList.changeTitleMainIconColor(u.online),"Offline"===t&&e.buddyList.changeTitleMainIconColor(u.offline),"Away"===t&&e.buddyList.changeTitleMainIconColor(u.away),"Busy"===t&&e.buddyList.changeTitleMainIconColor(u.busy),"DND"===t&&e.buddyList.changeTitleMainIconColor(u.busy)}),r.addEvent(r.eventName.BUDDYLISTBUILT,function(t){var i,n,s,o;h.debug("RTBuddyListController : BUDDYLISTBUILT received"),e.removeAll(!0);for(o in t)if(e.addGroup(o,"rtc"),(i=t[o]).toRemove)e.removeGroup(o);else if("_"!=o)for(s in i.users)(n=i.users[s]).toRemove?e.removeContact(o,n):e.addContact(o,n);if(i=t._)for(s in i.users)(n=i.users[s]).toRemove?e.removeContact("_",n):e.addContact("_",n);t.GROUPTMP&&l.dispatch(l.eventName.DISPLAYGLISTOFCONTACT,["GROUPTMP"])}),r.addEvent(r.eventName.RESULTOFSEARCH,function(t){h.debug("RTBuddyListController : RESULTOFSEARCH received");var i=e.listOfGroup.searchChatId;if(i)if(i.clearAllElement(),t.length>0){for(var n,s,o,a=c.getSetting("userLogin"),l=0;l<(t.length<7?t.length:7);l++)(o=-1!=(n=t[l]).userId.indexOf("@")?n.userId.substring(0,n.userId.indexOf("@")):n.userId)!==a&&(s={userId:n.userId,userName:decodeURI(n.userName),login:decodeURI(o),addIcon:!0,where:"3DIMWeb",status:n.status},r.dispatch(r.eventName.GETSTATUS,[s]),i.addContact(s,!0));t.length>=7&&i.dislayMessage(d.RefineSearchResult),i.resizeView()}else i.dislayMessage(d.NoResultFound),i.resizeView()}),r.addEvent(r.eventName.CREATEGROUP,function(t){e.listOfGroup.addGroupID&&e.removeGroup("addGroupID"),e.addGroup(t,"rtc"),e.listOfGroup[t]&&e.listOfGroup[t].setEditMode(e.editMode)}),r.addEvent(r.eventName.REMOVEGROUP,function(t){e.listOfGroup[t]&&e.removeGroup(t)}),this.buddyList.addEvent(this.id+"Closed",function(e){l.dispatch(l.eventName.ICONISEALLCLICK,[]),l.dispatch(l.eventName.ACTIVEMINIZONE,[!1])}),l.addEvent(l.eventName.ONADDGROUPCLICK,function(t){if(!e.listOfGroup.addGroupID){var i={groupId:"addGroupID",titleGroup:d.ChangeTitleName,fonticonElement:"fonticon-users",controller:this,groupType:"rtc",displayNumberOfcontact:!0},n=new a(i);n.setChangeName(!0),e.listOfGroup[i.groupId]=n;var s=n.getView();s&&e.listOfGroupView.addElement(s)}}),l.addEvent(l.eventName.ONADDCONTACT,function(t){h.debug("Add contact from plus button.");var i={userId:t.user.userId,userName:t.user.userName,login:t.user.login,status:t.user.status};r.dispatch(r.eventName.ADDCONTACT,{user:i,group:t.group}),e.addContact(t.group,i,!0)}),r.addEvent(r.eventName.RENAMEGROUPVIEW,function(t){e.renameGroup(t.oldName,t.newName)})},render:function(e){this.buddyList.render(e)},addGroup:function(e,t){if("undefined"===e)return!1;if(void 0===this.listOfGroup[e]){var i={groupId:e,titleGroup:e,fonticonElement:"fonticon-users",connection:this.connection,controller:this,groupType:t,displayNumberOfcontact:!0,isDraggable:!0};"Support"===e&&(i.isLocked=!0);var n=new a(i);if(this.listOfGroup[e]=n,"_"!==e){var s=n.getView();s?(h.debug("Get recentChatControllerView controller view done."),this.listOfGroupView.addElement(s,"bottom")):h.debug("Error get recentChatControllerView controller view.")}}},removeAll:function(e){for(var t in this.searchController.clearAllElement(),this.searchController.clearInput(),e||(this.recentChatController.clearAllElement(!0),this.setRecentChatIsHidden(!0)),this.listOfGroup)"searchChatId"!==t&&"Recents"!==t&&"Support"!==t&&this.removeGroup(t);this.listOfGroupView.setNoElement(!0)},removeGroup:function(e){this.listOfGroup[e].removeGroup(),delete this.listOfGroup[e],0===this.listOfGroup.length&&this.listOfGroupView.setNoElement(!0)},renameGroup:function(e,t){t&&e||h.debug("RTBuddyListController renameGroup bad args"),this.listOfGroup[e]||h.debug("RTBuddyListController renameGroup oldGroupName does not exist");var i,n=encodeURIComponent(t),s=n;for(i=1;this.listOfGroup[s]||i>100;i++)s=n+"_"+i;this.listOfGroup[s]=this.listOfGroup[e],this.listOfGroup[s].setName(decodeURIComponent(s)),this.listOfGroup[s].setId(s),delete this.listOfGroup[e],r.dispatch(r.eventName.RENAMEGROUP,[{oldName:e,newName:s}])},addContact:function(e,t,i){var n=this.listOfGroup[e];n&&(n.addContact(t,i),"_"===e&&this.listOfGroupView.addElement(n.getMember(t.userId).getView(),"bottom"))},removeContact:function(e,t){var i=this.listOfGroup[e];i&&i.removeMember(t)},setRecentChatIsHidden:function(e){this.recentChatController.setIsHidden(e)},addNotif:function(e){},searchContact:function(e,t){t?r.dispatch(r.eventName.SEARCHCONTACT,{name:e,isForShareAPI:!0}):r.dispatch(r.eventName.SEARCHCONTACT,e)},addContactToRecentChat:function(e){h.debug("RTBuddyListController addContactToRecentChat");var t=e.userId;if(void 0===this.listOfRecent[t]){this.listOfGroupView.setNoElement(!1);var i=Date.now();h.debug("RTBuddyListController addContactToRecentChat see the comment"),this.recentChatController.addContact(e,!1),this.listOfRecent[t]={contact:this.recentChatController.listOfContact[t],timestamp:i},this.recentChatController.setIsHidden(!1);try{var n=this.recentChatController.getView();n.parentElement.removeChild(n),this.listOfGroupView.addElement(n),h.debug("RTBuddyListController  addContactToRecentChat group Recents has been set at the top of the listofgroupview")}catch(e){h.debug("RTBuddyListController addContactToRecentChat unable to set Recents group at the top")}}},removeContactFromRecentChat:function(e){delete this.listOfRecent[e.getId()],this.removeContact("Recents",e)},getEditMode:function(){return this.editMode},startChatWith:function(e){this.controller&&this.controller.startChatWith(e)},setNotif:function(e){this.buddyList.setNotif(e)},cleanAll:function(){for(var e in this.listOfGroup)this.removeGroup(e)},showBuddyList:function(){!this.isAnIcon()&&this.getDisplayPanel()||(this.buddyList.showPanel(),l.dispatch(l.eventName.ONMAXIMIZEDCLICK,[this.id]))},closeBuddyList:function(){this.buddyList.closePanel()},isAnIcon:function(){return this.buddyList.isAnIcon()},isMinimize:function(){return this.buddyList.isMinimize()},getId:function(){return this.id},getDisplayPanel:function(){return this.buddyList.getDisplayPanel()},setDisplayPanel:function(e){this.buddyList.setDisplayPanel(e)},activeSignInView:function(e,t){this.buddyList.activeSignInView(e,t)},activeOfflineView:function(e){this.buddyList.activeOfflineView(e)},setTenantName:function(e){this.buddyList.setTenantName(e)},destroy:function(){this.buddyList.destroy()}})}),define("DS/InstantMessaging/js/controller/InstantMessagingController",["UWA/Class","UWA/Class/Events","UWA/Utils","UWA/Core","DS/WAFData/WAFData","DS/TopBarProxy/TopBarProxy","DS/TopBarProxy/MenuItem","DS/InstantMessaging/js/controller/RTBuddyListController","DS/InstantMessaging/js/controller/RTChatController","DS/InstantMessaging/js/controller/RTContactController","DS/InstantMessaging/js/controller/RTSettingController","DS/RTProxyDriver/RTProxyDriver","DS/InstantMessaging/js/controller/RTEventBusController","DS/InstantMessaging/js/controller/RTPanelController","DS/InstantMessaging/js/view/RTMinimizePanelView","DS/InstantMessaging/js/view/RTShareContentView","DS/UWPClientCode/PublicAPI","DS/PlatformAPI/PlatformAPI","i18n!DS/InstantMessaging/assets/nls/feed","DS/RTColors/RTColors","DS/UIKIT/Input/Button","DS/RTProxyDriver/RTLogger","css!InstantMessaging/InstantMessaging.css"],function(e,t,i,n,s,o,a,r,l,c,d,h,u,g,p,m,f,v,w,y,T,C){"use strict";C.debug("InstantMessagingController load 2");var I=void 0;return e.extend(t,{init:function(e){C.debug("InstantMessagingController init");var t=this;if(this.expanded=!1,this.lockIconise=!1,this.iconExpanded={},this.listOfChat={},this.listOfSysStatus={},this.activeChatPanel=[],this.active3DIM=e.tenants,this.myStatus=void 0,this.lockMail=!1,this.appName=e.appName?e.appName:f.getApplicationConfiguration("app.build.name"),this.favoriteTenant=e.favoriteTenant,this.logger=C,this.x3DPhotoWidgetLoaded=!1,d.setSetting("appName",this.appName),this.isDevMode=e.devMode&&!e.ODTMode,this.isDevMode){UWA.debug=!0,d.setSetting("defaultAvatarURL","./assets/avatarDefault.png"),this.login=e.devOpt.login.split("@")[0],document.getElementById("postlogin")&&(document.getElementById("postlogin").style.display="inline-block"),document.getElementById("prelogin")&&(document.getElementById("prelogin").style.display="none");var i="login : "+e.devOpt.login;i+="<br>server : <a href='"+e.devOpt.server+"' target='_blank'>"+e.devOpt.server+"</a>";var n=UWA.Utils.getQueryString(document.URL,"driver3DIM")||"NODE";this.nameApp=n,i+="<br>driver : "+n;var s=document.getElementById("userInfos");s?s.innerHTML=i:console.log(i);var o=document.getElementById("btnLogout");if(o)new T({value:"Logout"}).inject(o).addEvent("onClick",function(){h.dispatch(h.eventName.LOGOUT,[{nameApp:n}])})}else d.setSetting("defaultAvatarURL","./resources/en/1/webapps/InstantMessaging/assets/avatarDefault.png"),this.login=e.userId?e.userId:f.user.login;this.isInitTopBar=!1,this.topBarId=e.topBarId,d.setSetting("imPort","5281"),d.setSetting("archive_qty",20),d.setSetting("shareSizeLimit",9e6);var a=UWA.Utils.getQueryString(document.URL,"imPort3DIM");a&&d.setSetting("imPort",a),this.activeArchive=UWA.Utils.getQueryString(document.URL,"archive3DIM")||e.activeArchive,this.activeArchive?d.setSetting("activeArchive",!1):d.setSetting("activeArchive",!0),this.activeShare=UWA.Utils.getQueryString(document.URL,"share3DIM"),this.activeShare=!0,this.activeShare?d.setSetting("activeShare",!0):d.setSetting("activeShare",!1),this.activeShareFile=!0,this.activeShareFile?d.setSetting("activeShareFile",!0):d.setSetting("activeShareFile",!1);var r=UWA.Utils.getQueryString(document.URL,"driver3DIM");!r||"XMPP"!==r&&"NODE"!==r?d.setSetting("driver","NODE"):d.setSetting("driver",r),d.setSetting("userLogin",this.login),d.setSetting("userName",f.user.firstName+" "+f.user.lastName),e.devMode?d.setSetting("userName",e.devOpt.login.split("@")[0]):e.userName?d.setSetting("userName",e.userName):d.setSetting("userName",f.user.firstName+" "+f.user.lastName),this.addEvent("onTenantChanged",function(i){C.debug("Tenant changed"),I.cleanAll(),t.getRTCServerInfo(e)}),this.initBuddyList(),this.showBuddylist(),this.initGlobalIcon(),e.devMode?(this.initDevEnv(e),I.activeOfflineView(!1)):this.getRTCServerInfo(e),this.initEventListener(),e.devOptFct&&e.devOptFct(this)},initGlobalIcon:function(){this.miniPanels=new p({OpenBuddyList:function(){I.showBuddyList()}}),this.miniPanels.getView().inject(document.body)},initBuddyList:function(){if(C.debug("InstantMessagingController initBuddyList"),void 0===I){var e={controller:this,id:"RTBuddyListID",originXPos:66,originYPos:0,sizeOnY:400,minimumSize:42,minimumResize:380,panelLarger:270,titleOpt:{titleName:{txt:"3DMessaging",eventName:"onBuddylistNameClick"},eventResizePanel:{MouseDown:"onResizeBLPanelMouseDown",MouseUp:"onResizeBLPanelMouseUp"},minimizeButton:!0,closeButton:!0,iconiseAll:!0,activeMenu:!0},active3DIM:this.active3DIM};I=new r(e)}},showBuddylist:function(){(C.debug("InstantMessagingController showBuddylist"),I)&&(I.render(document.body),UWA.Utils.getQueryString(document.URL,"maxi3DIM")||I.closeBuddyList())},initTopBar:function(e){C.debug("InstantMessagingController initTopBar");var t,i,n,s=this;this.topBarProxy=new o({id:this.topBarId});var r,l,c=this.topBarProxy.callback=function(e){var t=e.get("label");d.getSetting("widget3DIM")&&"3DMessaging"===t?"3DSwym"===s.appName?s.load3DIMW():window.location.href+="/sidepanel:MAP-DRCMQIWVY":"3DMessaging"===t?I&&(I.isMinimize()&&!0===s.miniPanels.globalDisplay?I.showBuddyList():(u.dispatch(u.eventName.ACTIVEMINIZONE,[!0]),I.showBuddyList())):t===w.Signout?(u.dispatch(u.eventName.SIGNOUT,[]),s.isLoggedIn=!1):s.isLoggedIn&&h.dispatch(h.eventName.SETSTATUS,{myStatus:s.listOfSysStatus[t],statusMsg:s.listOfSysStatus[t]})};for(t in this.subMenu=[],e)this.listOfSysStatus[w[t]]=t,"Offline"==t||"Away"==t?(r="Appear"+t,l="Appear "+t,this.listOfSysStatus[l]=t):r=t,this.subMenu.push(new a({label:w[r],checked:"Online"===t,onExecute:c}));for(i in n=0,this.active3DIM)this.active3DIM[i].imActive&&n++;n>1&&this.subMenu.push(new a({label:w.Signout,checked:!1,onExecute:c})),this.topBarProxy.setContent({profile:[{label:"3DMessaging",submenu:this.subMenu,onExecute:c}]});this.topBarProxy;h.addEvent(h.eventName.LOGOUT,function(){s.subMenu.forEach(function(e){e.set("disabled",!0)})})},initEventListener:function(){C.debug("InstantMessagingController initEventListener");var e=this;h.addEvent(h.eventName.ONMESSAGERECEIVED,function(t){var i;if(C.debug("InstantMessagingController : ONMESSAGERECEIVED"),I.setNotif(!0),d.getSetting("userLogin")===t.from){for(var n in e.listOfChat)if(e.listOfChat[n].uuid===t.to){i=e.listOfChat[n];break}if(!i)return!1}if(i||(i=e.listOfChat[t.from]),void 0===i){var s={userName:t.username,login:t.login,userId:t.from,status:t.status},o={controller:e,connection:e.connection,groupId:void 0,contact:s},a=new c(o),r=e.createChat(a,!1,t.roomId);t.activeArchive||r.onMessageReceived(t),e.miniPanels.addNotification({id:a.getId(),pathPicture:a.getPathPicture(),userName:a.getUserName(),infoTxt:t.msg?t.msg.unescapeHTML():t.data?"Content received.":"Error : No message.",events:{click:function(){u.dispatch(u.eventName.STARTCHAT,[a])}}})}else if(i.isDisplay())e.miniPanels.receivedMessage(t.from),i.setNotif(!0);else{a=(r=i).getContact();e.miniPanels.addNotification({id:a.getId(),pathPicture:a.getPathPicture(),userName:a.getUserName(),infoTxt:t.msg?t.msg.unescapeHTML():t.data?"Content received.":"Error : No message.",events:{click:function(){u.dispatch(u.eventName.STARTCHAT,[a])}}})}}),u.addEvent(u.eventName.PANELICONISED,function(t){if(C.debug("InstantMessagingController : PANELICONISED"),"RTBuddyListID"!==t){var i=e.listOfChat[t].getContact();e.miniPanels.addContact({id:i.getId(),pathPicture:i.getPathPicture(),userName:i.getUserName(),events:{click:function(){u.dispatch(u.eventName.ONMAXIMIZEDCLICK,[t])}}})}else e.miniPanels.activeBuddyIcon(!0);e.organizeChatPanel(t)}),u.addEvent(u.eventName.PANELMAXIMIZED,function(t){C.debug("InstantMessagingController : PANELMAXIMIZED"),e.organizeChatPanel(t)}),u.addEvent(u.eventName.ICONISEALLCLICK,function(t){for(var i in C.debug("InstantMessagingController : ICONISEALLCLICK"),e.lockIconise=!0,e.listOfChat){e.listOfChat[i].isDisplay()&&u.dispatch(u.eventName.ONICONISEPANELCLICK,[i])}u.dispatch(u.eventName.ONICONISEPANELCLICK,[I.getId()]),e.lockIconise=!1}),u.addEvent(u.eventName.STARTCHAT,function(t,i){C.debug("InstantMessagingController : STARTCHAT"),e.startChatWith(t,i)}),h.addEvent(h.eventName.SETSTATUS,function(t){C.debug("InstantMessagingController : SETSTATUS"),e.subMenu.forEach(function(e){-1!=e.get("label").indexOf(w[t.myStatus])?e.set("checked",!0):e.set("checked",!1)})}),h.addEvent(h.eventName.ONPRESENCERECEIVED,function(t){C.debug("InstantMessagingController : ONPRESENCERECEIVED");var i=t.userId.split("@");if(t&&t.status&&t.status.toLowerCase){var n=y[t.status.toLowerCase()];n?v.publish(t.userId,{login:i[0],action:"setStatus",status:t.status,color:n}):C.debug("InstantMessagingController ONPRESENCERECEIVED : status unknown : "+t.status)}if(i[0]===e.login){e.myStatus=t.status,e.subMenu.forEach(function(e){-1!=e.get("label").indexOf(w[t.status])?e.set("checked",!0):e.set("checked",!1),e.set("disabled",!1)});d.getSetting("RTCStatus");"Online"===t.status&&(e.miniPanels.updateStatus(y.online),e.miniPanels.updateIcon({fontSize:"9px",top:"-3px",left:"-1px",name:"fonticon handler fonticon-check"})),"Offline"===t.status&&(e.miniPanels.updateStatus(y.offline),e.miniPanels.updateIcon({fontSize:"5px",top:"-4px",left:"-1px",name:""})),"Away"===t.status&&(e.miniPanels.updateStatus(y.away),e.miniPanels.updateIcon({fontSize:"9px",top:"-3px",left:"-1px",name:"fonticon handler fonticon-cancel"})),"Busy"===t.status&&(e.miniPanels.updateStatus(y.busy),e.miniPanels.updateIcon({fontSize:"9px",top:"-3px",left:"-1px",name:"fonticon handler fonticon-minus"})),"DND"===t.status&&(e.miniPanels.updateStatus(y.busy),e.miniPanels.updateIcon({fontSize:"9px",top:"-3px",left:"-1px",name:"fonticon handler fonticon-minus"})),d.setSetting("userStatus",t.status)}}),h.addEvent(h.eventName.DISCONNECTED,function(t){e.subMenu.forEach(function(e){e.set("disabled",!0)})}),h.addEvent(h.eventName.CONNECTED,function(t){t.userId||C.error("InstantMessaging unable to retrieve user's login"),e.login=t.userId,d.setSetting("userLogin",t.userId),h.dispatch("ONPRESENCERECEIVED",[t]),e.subMenu.forEach(function(e){e.set("disabled",!1)})}),u.addEvent(u.eventName.ONCLICKNOTIFICATION,function(t){if(e.expanded)for(var i in e.listOfChat)if(e.listOfChat[i].isAnIcon()){var n=e.listOfChat[i];n.chat.setOriginPosition({originXPos:5,originYPos:n.getOriginPosition().yPosition-46}),n.chat.moveToOrigin(),e.iconExpanded[i]=n.getOriginPosition()}}),h.addEvent(h.eventName.LOGOUT,function(){v.publish("im.ds.com",{action:"logout"})}),h.addEvent(h.eventName.STATUSUPDATED,function(t){C.debug("RTBuddyListController : STATUSUPDATED received");d.getSetting("RTCStatus");"Online"===t&&(e.miniPanels.updateStatus(y.online),e.miniPanels.updateIcon({fontSize:"9px",top:"-3px",left:"-1px",name:"fonticon handler fonticon-check"})),"Offline"===t&&(e.miniPanels.updateStatus(y.offline),e.miniPanels.updateIcon({fontSize:"5px",top:"-4px",left:"-1px",name:""})),"Away"===t&&(e.miniPanels.updateStatus(y.away),e.miniPanels.updateIcon({fontSize:"9px",top:"-3px",left:"-1px",name:"fonticon handler fonticon-cancel"})),"Busy"===t&&(e.miniPanels.updateStatus(y.busy),e.miniPanels.updateIcon({fontSize:"9px",top:"-3px",left:"-1px",name:"fonticon handler fonticon-minus"})),"DND"===t&&(e.miniPanels.updateStatus(y.busy),e.miniPanels.updateIcon({fontSize:"9px",top:"-3px",left:"-1px",name:"fonticon handler fonticon-minus"}))}),u.addEvent(u.eventName.RESTARTLOGIN,function(t){e.activeConnection()}),u.addEvent(u.eventName.ACTIVEMINIZONE,function(t){if(t)for(var i=0;i<e.activeChatPanel.length;i++)e.activeChatPanel[i].setDisplayPanel(t);else{for(var n in e.listOfChat){var s=e.listOfChat[n];s.isDisplay()&&(s.setDisplayPanel(t),e.activeChatPanel.push(s))}I.setDisplayPanel(t)}e.miniPanels.activeMiniZone(t)}),u.addEvent(u.eventName.SIGNOUT,function(t){var i=d.getSetting("plateformsInfo");for(var n in I.activeSignInView(!0,i),C.info("IMController SIGNOUT"),h.dispatch(h.eventName.LOGOUT,[{nameApp:"3DIM"}]),h.dispatch(h.eventName.ONPRESENCERECEIVED,[{status:"Offline",userId:d.getSetting("userLogin")+"@im"}]),e.listOfChat){e.listOfChat[n].getPanel().destroy(),delete e.listOfChat[n]}e.miniPanels.removeAllElements(),I.removeAll()}),v.subscribe("im.ds.com",function(t){var i=t.login+"@"+d.getSetting("currentPlateformId").toLowerCase()+".im.3ds.com";switch(t.action){case"shareContent":t.controller=I.searchController,e.sharecontentView=new m(t);break;case"getStatus":var n={userName:t.username,login:t.login,userId:i};h.dispatch(h.eventName.GETSTATUS,[n]);break;case"getAllStatus":var s=[];t.users&&(s=t.users.map(e=>({login:e.login,userName:e.username,userId:e.login+"@"+d.getSetting("currentPlateformId").toLowerCase()+".im.3ds.com"}))),h.dispatch(h.eventName.GETALLSTATUS,[s]);break;case"startChat":if(d.getSetting("userLogin")===t.login){C.debug("InstantMessagingController starChat with self forbidden");break}if(d.getSetting("currentPlateformId").toLowerCase()!=(t.tenant.displayName||t.tenant).toLowerCase()){C.debug("InstantMessagingController starChat with user on other tenant forbidden");break}if(void 0===e.listOfChat[i]&&void 0===e.listOfChat[t.login]){n={userName:t.username,login:t.login,userId:"NODE"===d.getSetting("driver")?t.login:i,status:t.presence};var o={controller:e,connection:e.connection,groupId:void 0,contact:n},a=new c(o);u.dispatch(u.eventName.STARTCHAT,[a,t.share])}else{a=(e.listOfChat[i]||e.listOfChat[t.login]).getContact();u.dispatch(u.eventName.STARTCHAT,[a,t.share])}}}),window.onbeforeunload=function(t){e.lockMail?e.lockMail=!e.lockMail:(h.dispatch(h.eventName.LOGOUT,[{nameApp:"3DIM"}]),C.debug("Leave page !!"))}},startX3DPhoto:function(e){var t=this;if(this.x3DPhotoData=e,this.x3DPhotoDiv)this.x3DPhotoDiv.style.display="block",v.publish("tox3dphoto.ds.com",{evenement:"loadPhoto",data:t.x3DPhotoData});else{this.x3DPhotoDiv=UWA.createElement("div",{class:"X3DPHOTO-main-div",html:[{tag:"div",class:"X3DPHOTO-toolbar",styles:{position:"absolute",right:"30px",top:"10px","z-index":"20"}},{tag:"div",class:"X3DPHOTO-player"}]}),this.x3DPhotoDiv.inject(document.body);var i=new T({value:"Close"});i.addEvent("onClick",function(){t.x3DPhotoWidgetLoaded=!1,t.x3DPhotoDiv.style.top=t.x3DPhotoDiv.offsetHeight+59+"px",setTimeout(function(){t.x3DPhotoDiv.style.display="none",t.x3DPhotoDiv.destroy(),t.x3DPhotoDiv=void 0},600)}),i.inject(this.x3DPhotoDiv.getElement(".X3DPHOTO-toolbar")),v.subscribe("fromx3dphoto.ds.com",function(e){var i=e.evenement,n=e.data;"WidgetLoaded"!==i||t.x3DPhotoWidgetLoaded?"upload"===i&&h.dispatch("uploadMedia",[n]):(t.x3DPhotoWidgetLoaded=!0,v.publish("tox3dphoto.ds.com",{evenement:"loadPhoto",data:t.x3DPhotoData}))}),this.loadWidget({app:"CAT3DSH_AP",el:this.x3DPhotoDiv.getElement(".X3DPHOTO-player")}),this.x3DPhotoDiv.style.top="103px"}},getRTCServerInfo:function(e){C.debug("InstantMessagingController getRTCServerInfo");var t={},i=(e.appName,!1),n=function(e){return e&&"string"==typeof e?e.replace(":8081/rest","").replace(":8081/rest/","").replace("http:","https:").replace(":8081","").replace("/rest","").replace("/rest/",""):null},s=n(e.messaging),o=e.passport;for(var a in e.tenants){var r=a;if(e.tenants[r]){var l=e.tenants[r].swym,c=e.tenants[r].displayName,h=e.tenants[r].url;l&&r&&e.tenants[r]&&e.tenants[r].imActive&&(t[r]={im:n(h)||s,swym:l.replace(":443/",""),passport:o,displayname:c},i=!0)}}i?(d.setSetting("plateformsInfo",t),this.favoriteTenant&&t[this.favoriteTenant]?d.setSetting("currentPlateformId",this.favoriteTenant):d.setSetting("currentPlateformId",Object.keys(t)[0]),C.info("will now launch connection to RTC server on tenant "+d.getSetting("currentPlateformId")),this.activeConnection()):(I.destroy(),this.miniPanels.destroy())},activeConnection:function(){C.debug("InstantMessagingController activeConnection");var e=this;if(this.login=this.login||"noMoreNeeded",this.login){var t=d.getSetting("currentPlateformId"),i=d.getSetting("plateformsInfo"),n=(d.getSetting("imPort"),i[t].passport),s=i[t].im,o=s.replace(":443/rest",""),a=function(i){var s=JSON.parse(i);if(s.access_token){e.isLoggedIn=!0;var a={nameApp:"3DIM",driverName:d.getSetting("driver")||"NODE",credentials:{jid:e.login+"@"+t.toLowerCase()+".im.3ds.com",user:e.login,password:s.access_token},url:o,domaineName:t,passportUrl:n};Object.keys(e.active3DIM).length>1&&I.setTenantName(t),I.listOfRecent={},h.addEvent(h.eventName.GETSTATUSLIST,function(t){e.isInitTopBar||(e.isInitTopBar=!0,d.setSetting("RTCStatus",t),e.initTopBar(t),u.dispatch(u.eventName.LISTSTATUSRECEIVED,[]))}),h.dispatch(h.eventName.SETDRIVER,[a])}};return e.isDevMode,a('{"access_token":"osef"}')}C.error("InstantMessagingController activeConnection failed without userId")},startChatWith:function(e,t){if(C.debug("InstantMessagingController startChatWith"),!I.getEditMode()){var i,n=e.getId();if(this.listOfChat[n]?(C.debug("InstantMessagingController : Notify startChatWith - "+n),(i=this.listOfChat[n]).isDisplay()||i.show()):i=this.createChat(e,!0),t){var s=document.createEvent("CustomEvent");s.dataTransfer={types:["text"],getData:function(e){return e&&"string"==typeof e&&-1!=e.toLowerCase().indexOf("url")?t.urlContent:t},target:{files:{}}},i.sendDataFromDrop(s)}}},createChat:function(e,t,i,n){C.debug("InstantMessagingController createChat");var s=e.getId(),o=e.getLogin(),a=d.getSetting("currentPlateformId"),r=d.getSetting("plateformsInfo"),c=(r&&r[a]?r[a].swym:void 0)+"/api/user/getpicture/login/"+o+"/format",h={controller:this,connection:this.connection,roomId:i,contact:{userId:s,userName:e.getUserName(),login:e.getLogin(),email:e.getEmail(),status:e.getStatus()},id:s,originXPos:345,originYPos:0,sizeOnY:400,minimumSize:32,minimumResize:400,panelLarger:270,titleOpt:{titleName:{txt:e.getUserName(),eventName:"on"+s+"NameClick"},status:e.getStatus(),eventResizePanel:{MouseDown:"onResize"+s+"PanelMouseDown",MouseUp:"onResize"+s+"PanelMouseUp"},minimizeButton:!0,closeButton:!0,menuButton:d.getSetting("activeArchive"),picture:c}},u=new l(h,n);return u&&(this.listOfChat[s]=u,t&&(u.show(),I&&I.setRecentChatIsHidden(!1))),u},closeChatPanel:function(e,t,i){C.debug("InstantMessagingController closeChatPanel");var n=this.listOfChat[e];if(!n)return C.debug("IMcontroller closeChatPanel : chatpanel already closed");n.getOriginPosition();this.organizeChatPanel(e)},organizeChatPanel:function(e){if(C.debug("InstantMessagingController organizeChatPanel"),!this.lockIconise){var t=void 0,i=!1,n=(this.getNumberOfIconiseChat(),this.getNumberOfDisplayChat(),void 0);if(I.getId()===e?i=!0:(n=this.listOfChat[e])&&(t=n.getOriginPosition()),n&&!n.isAnIcon()&&n.isDisplay()){var s=66;!I.isAnIcon()&&I.getDisplayPanel()&&(s=345),n.chat.setOriginPosition({originXPos:s,originYPos:0}),n.chat.moveToOrigin(),t=n.getOriginPosition()}for(var o in this.listOfChat)if(e!==o){var a=this.listOfChat[o];if(i){if(I.isAnIcon()){if(a.isDisplay()&&!a.isAnIcon())(r=a.chat.getOriginPosition()).xPosition-279>=66&&(a.chat.setOriginPosition({originXPos:r.xPosition-279}),a.chat.moveToOrigin())}else if(a.isDisplay()&&!a.isAnIcon()){var r=a.chat.getOriginPosition();a.chat.setOriginPosition({originXPos:r.xPosition+279}),a.chat.moveToOrigin(),r=a.chat.getOriginPosition();var l=document.body.offsetWidth;if(r.xPosition+a.getWidth()>l){var c=o;setTimeout(function(){u.dispatch(u.eventName.ONICONISEPANELCLICK,[c])},400)}}}else if(a.isDisplay()&&!a.isAnIcon())if(a.getOriginPosition().xPosition>=t.xPosition){r=a.chat.getOriginPosition();if(n.isAnIcon()||!n.isDisplay())r.xPosition-279>=(I.isAnIcon()?66:345)&&(a.chat.setOriginPosition({originXPos:r.xPosition-279}),a.chat.moveToOrigin());else{r=a.chat.getOriginPosition();a.chat.setOriginPosition({originXPos:r.xPosition+279}),a.chat.moveToOrigin(),r=a.chat.getOriginPosition();l=document.body.offsetWidth;if(r.xPosition+a.getWidth()>l){c=o;setTimeout(function(){u.dispatch(u.eventName.ONICONISEPANELCLICK,[c])},400)}}}}}},getNumberOfIconiseChat:function(){C.debug("InstantMessagingController getNumberOfIconiseChat");var e=0;for(var t in this.listOfChat)this.listOfChat[t].isAnIcon()&&e++;return e},getNumberOfDisplayChat:function(){C.debug("InstantMessagingController getNumberOfDisplayChat");var e=0;for(var t in this.listOfChat)this.listOfChat[t].isDisplay()&&!this.listOfChat[t].isAnIcon()&&e++;return e},setRecentChatIsHidden:function(e){C.debug("InstantMessagingController setRecentChatIsHidden"),I.setRecentChatIsHidden(e)},addContactToRecentChat:function(e){C.debug("InstantMessagingController addContactToRecentChat"),I.addContactToRecentChat(e)},buddylistIsAnIcon:function(){return C.debug("InstantMessagingController buddylistIsAnIcon"),I.isAnIcon()},initDevEnv:function(e){if(e.ODTMode){this.subMenu=[],this.login="odt",d.setSetting("currentPlateformId","ODTTENANT"),d.setSetting("userLogin","odt"),d.setSetting("RTCStatus",{Away:"Away",Busy:"Busy",Offline:"Offline",Online:"Online"}),u.dispatch(u.eventName.LISTSTATUSRECEIVED,[]),I.groups3DIM=!0}else{var t=this;h.addEvent(h.eventName.GETSTATUSLIST,function(e){t.isInitTopBar||(t.isInitTopBar=!0,d.setSetting("RTCStatus",e),t.initTopBar(e),u.dispatch(u.eventName.LISTSTATUSRECEIVED,[]))});var i={nameApp:"3DIM",devEnv:!0,driverName:d.getSetting("driver")||"NODE",credentials:{jid:e.devOpt.login,user:e.devOpt.login,password:e.devOpt.password},url:e.devOpt.server,domaineName:e.devOpt.login.split("@")[1].split(".")[0]};"im"===i.domaineName&&(i.domaineName="3DIMprivatenant"),d.setSetting("currentPlateformId",i.domaineName),this.active3DIM={count:2},this.active3DIM[i.domaineName]={imActive:!0},this.login=e.devOpt.login.split("@")[0];var n={global:{im:e.devOpt.server,displayname:"global"},hyper3dsy:{im:e.devOpt.server,displayname:"hyper3dsy"}};for(var s in n)this.active3DIM[s]={imActive:!0};d.setSetting("plateformsInfo",n),h.dispatch(h.eventName.SETDRIVER,[i])}},getBuddylist:function(){return I}})});