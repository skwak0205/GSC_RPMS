define("DS/OfficeDocumentEditorClient/Utils",["UWA/Utils","UWA/Promise","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/PlatformAPI/PlatformAPI"],function(e,t,n,o){"use strict";const r={service:{}},s={ERROR:{NO_DOCUMENT_URL_PROVIDED:1e3,SERVICE_NOT_FOUND:1001,NO_ROOT_ELEM:1002,UNKNOWN:1003,PLATFORM_ID_NOT_GRANTED:1004,ODE_SERVICE_NOT_FOUND:1005,XHR:1006,XHR_TIMEOUT:1007,INVALID_SERVER_RESPONSE:1008,FILE_FORMAT_NOT_SUPPORTED:1009,X3DPLAY_NOT_SUPPORTED:1010},getErrorKey:e=>{let t="";return Object.keys(s.ERROR).forEach((n,o)=>{s.ERROR[n]===e&&(t=n)}),t},isErrorSupported:e=>""!==s.getErrorKey(e),DOCTYPE:{WORD:"word",SPREADSHEET:"spreadsheet",PRESENTATION:"presentation",UNKNOWN:"unknown"},getDocumentKindFromExt:(e,t)=>{let n=(e||"").toLowerCase();const o=(t||"").toLowerCase().split(".").pop();""===n&&(n=o);return["doc","docx","rtf"].indexOf(n)>-1?s.DOCTYPE.WORD:["xls","xlsx","csv"].indexOf(n)>-1?s.DOCTYPE.SPREADSHEET:["ppt","pptx"].indexOf(n)>-1?s.DOCTYPE.PRESENTATION:s.DOCTYPE.UNKNOWN},isInMobileApp:()=>!(!window.ds||"MOBILE"!==window.ds.env),is404Error:e=>!!(e&&e.message&&e.message.indexOf("404")>-1),isDfcsUrl:e=>{let t=!1;try{const n=new URL(e);/^.*-dfcs\./.test(n.hostname)&&(t=!0)}catch(e){}return t},getServiceUrl:(o,i)=>{const a=`${o}_${i}`.toLowerCase();return new t(function(t,l){r.service[a]?t(r.service[a]):n.getPlatformServices({onComplete:function(n){const p=[];n.forEach(function(e){for(const t in e)t===i&&p.push({platformId:e.platformId,url:e[t]})});let c="";if(o){const t=p.filter(e=>(e.platformId||"").toLowerCase()===(o||"").toLowerCase());if(t.length>0){const n=e.parseUrl(t[0].url);n.path="/",n.query="",c=e.composeUrl(n)}}c?(r.service[a]=c,t(c)):l(s.ERROR.SERVICE_NOT_FOUND)},onFailure:()=>{l(s.ERROR.UNKNOWN)}})})},getOfficeDocumentEditorServiceUrl:e=>new t(function(t,n){s.getServiceUrl(e,"officedocumenteditor").then(e=>{let r=e;const i=o.getApplicationConfiguration("app.ode.url");i&&(r=i),r?t(r):n(s.ERROR.ODE_SERVICE_NOT_FOUND)}).catch(e=>{const r=o.getApplicationConfiguration("app.ode.url");r?t(r):n(e)})})};return s}),define("DS/OfficeDocumentEditorClient/Editor",["UWA/Core","UWA/Utils","UWA/Promise","DS/OfficeDocumentEditorClient/Utils","DS/WAFData/WAFData","DS/3DPlaySupport/AssetSupport","DS/3DPlayHelper/3DPlayHelper","DS/UIKIT/Spinner","DS/Usage/TrackerAPI","UWA/Data"],function(e,t,n,o,r,s,i,a,l,p){"use strict";const c={},E="ode-view-container-"+t.getUUID(),O="ode-3dplayer-view-container-"+t.getUUID(),d="ode-spinner-"+t.getUUID();let u;const m=[],N={};function R(){return this instanceof R?(this.session=this.generateNewSession(),this):new R}N.PREFIX="officedocumenteditor",N.CATEGORY={DOCUMENT:`${N.PREFIX}.document`},N.ACTION={OPEN:`${N.PREFIX}..open`,SAVE:`${N.PREFIX}..save`,CLOSE:`${N.PREFIX}..close`,GET_TEMPLATE:`${N.PREFIX}..get_template`},N.DIMENSIONS={TENANT:`${N.PREFIX}.tenant`,TEMPLATE:`${N.PREFIX}.template`,DOCUMENT_KIND:`${N.PREFIX}.documentKind`,OPEN_MODE:`${N.PREFIX}.openMode`,ERROR_KIND:`${N.PREFIX}.errorKind`,ERROR_VALUE:`${N.PREFIX}.errorValue`},N.DIMENSIONS_VAL={YES:"yes",NO:"no",PDF:"pdf",IMAGE:"image",EDITOR:"editor"},R.prototype.get=function(){return this.session},R.prototype.getNewSessionId=function(){return t.getUUID()},R.prototype.generateNewSession=function(){return{_id:this.getNewSessionId(),_startTime:Math.floor(Date.now()/1e3)}},R.prototype.getValue=function(e){return this.session[e]},R.prototype.setValue=function(e,t){this.session[e]=t},R.prototype.resetSession=function(){this.session=this.generateNewSession()};const I=new R,D=()=>{c.x3DPlayerInstance&&"function"==typeof c.x3DPlayerInstance.dispose&&(c.x3DPlayerInstance.dispose(),c.x3DPlayerInstance=null);const e=document.getElementById(O);e&&e.parentNode.removeChild(e)},f=e=>{e&&null!==e.elements&&e.destroy()},S={endpointUrl:"",url:"",key:"",platformId:"",spinner:null};return S.ERROR=Object.assign({},o.ERROR),S.setKey=((e,n)=>{if(S.key=e,!n)return;const o=document.getElementById(E);if(!o)return;if(!o.getElementsByTagName("iframe").length)return;const r=t.parseUrl(S.endpointUrl);r.path="",r.query="";const s=t.composeUrl(r);o.getElementsByTagName("iframe")[0].postMessage(JSON.stringify({kind:"ode.updateKey",key:e}),s)}),S.getKey=(()=>S.key),S.isGranted=(e=>(I.setValue(N.DIMENSIONS.TENANT,e.platformId),new n((s,i)=>{o.getOfficeDocumentEditorServiceUrl(e.platformId).then(a=>{((e,o)=>{const s=t.parseUrl(e);return s.path="/acl/get.json",s.query=`tenant=${o}`,new n((e,n)=>{r.handleRequest(t.composeUrl(s),{method:"GET",type:"json",responseType:"json",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:(t,r)=>{t&&t.data?t.error?n(new Error(JSON.stringify(t.error))):(t.data.tenant||"").toLowerCase()===o.toLowerCase()?e(t):n(new Error("invalid response")):n(new Error("unexpected response"))},onFailure:n,onTimeout:n,authentication:"passport"})})})(a,e.platformId).then(()=>{s(!0)}).catch(e=>{o.is404Error(e)?s(!0):i(S.ERROR.PLATFORM_ID_NOT_GRANTED)})}).catch(()=>{i(S.ERROR.SERVICE_NOT_FOUND)})}))),S.isFileFormatSupported=(e=>new n((t,n)=>{const r=(e.format||"").toLowerCase().replace(".",""),s=o.getDocumentKindFromExt(r);s!==o.DOCTYPE.WORD&&s!==o.DOCTYPE.SPREADSHEET&&s!==o.DOCTYPE.PRESENTATION?n(new Error(S.ERROR.FILE_FORMAT_NOT_SUPPORTED)):t(!0)})),S.getDocumentTemplatesURL=(e=>(I.setValue(N.DIMENSIONS.TENANT,e.platformId),I.setValue(N.DIMENSIONS.TEMPLATE,N.DIMENSIONS_VAL.YES),new n((n,s)=>{o.getOfficeDocumentEditorServiceUrl(e.platformId).then(s=>{const i=()=>{const e=t.parseUrl(s);e.path="/resources/template.docx",e.query="v="+t.getUUID();const o=t.parseUrl(s);o.path="/resources/template.pptx",o.query="v="+t.getUUID();const r=t.parseUrl(s);r.path="/resources/template.xlsx",r.query="v="+t.getUUID(),n({docx:t.composeUrl(e),pptx:t.composeUrl(o),xlsx:t.composeUrl(r)})},a=t.parseUrl(s);a.path="/template/get.json";const l=[];l.push(`tenant=${t.encodeUrl(e.platformId)}`),a.query=l.join("&"),r.handleRequest(t.composeUrl(a),{timeout:8e3,responseType:"json",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:e=>{if(!e||!e.data||e.error)return void i();const t={};e.data.forEach(e=>{t[e.kind]=e.template_url,e.kind===o.DOCTYPE.WORD?t.docx=e.template_url:e.kind===o.DOCTYPE.SPREADSHEET?t.xlsx=e.template_url:e.kind===o.DOCTYPE.PRESENTATION&&(t.pptx=e.template_url)}),0!==Object.keys(t).length?(n(t),N.CATEGORY.DOCUMENT,N.ACTION.GET_TEMPLATE):i()},onFailure:i,onTimeout:i,authentication:"passport"})}).catch(e=>{let t=e;o.isErrorSupported(t)||(t=S.ERROR.SERVICE_NOT_FOUND),I.setValue(N.DIMENSIONS.ERROR_KIND,o.getErrorKey(t)),I.setValue(N.DIMENSIONS.ERROR_VALUE,e),N.CATEGORY.DOCUMENT,N.ACTION.GET_TEMPLATE,s(t)})}))),S.close=(()=>{N.CATEGORY.DOCUMENT,N.ACTION.CLOSE,I.resetSession(),m.forEach(e=>e()),m.splice(0,m.length),D();const e=document.getElementById(E);e&&e.parentNode.removeChild(e)}),S.init=S.open=(r=>{const l=Object.assign(r||{},{autoSaveDelayInSec:0});return I.setValue(N.DIMENSIONS.TENANT,l.platformId),I.setValue(N.DIMENSIONS.DOCUMENT_KIND,o.getDocumentKindFromExt(l.ext,l.url)),new n((r,R)=>{l.ext&&l.title&&l.title.substring(l.title.length-l.ext.length-1,l.title.length)!=="."+l.ext&&(l.title=l.title+"."+l.ext),l.url?l.rootElem?(D(),l.rootElem.empty(),l.rootElem.setStyles({display:"flex",justifyContent:"center",alignItems:"center"}),S.spinner=(e=>{const t=new a;return t.elements.container.setStyles({position:"absolute",zIndex:1}),t.elements.container.set("id",d),t.inject(e),t.show(),t})(l.rootElem),S.url=l.url,l.platformId&&(S.platformId=l.platformId),o.getOfficeDocumentEditorServiceUrl(l.platformId).then(e=>{const n=[];n.push(`url=${t.encodeUrl(l.url)}`),void 0!==l.title&&""!==l.title&&n.push(`title=${t.encodeUrl(l.title)}`),void 0!==l.ext&&""!==l.ext&&n.push(`ext=${t.encodeUrl(l.ext)}`),void 0!==l.docKeyToUse&&""!==l.docKeyToUse&&n.push(`docKeyToUse=${t.encodeUrl(l.docKeyToUse)}`),l.newDocument&&n.push("newDocument=true"),l.readOnly&&n.push("readOnly=true"),l.image&&(n.push("image=true"),l.imagePage&&n.push(`imagePage=${t.encodeUrl(l.imagePage)}`)),void 0!==l.platformId&&""!==l.platformId&&n.push(`platformId=${t.encodeUrl(l.platformId)}`),l.enableAutoSave&&n.push("enableAutoSave=true"),void 0!==l.saveOpts&&Object.keys(l.saveOpts).length>0&&n.push(`saveOpts=${t.encodeUrl(JSON.stringify(l.saveOpts))}`);const o=t.parseUrl(e);return o.path="/open",o.query=n.join("&"),S.endpointUrl=t.composeUrl(o),S.endpointUrl}).then(()=>(e=>{const t={provider:"FILE",filename:o.isInMobileApp()?p.proxifyUrl(e.endpointUrl,{proxy:"passport"}):e.endpointUrl,requestsOptions:{proxy:o.isInMobileApp()?"passport":"none",withCredentials:!0},format:"pdf",type:"pdf"},r=Object.assign({},t);e.playerConfig&&e.playerConfig.input&&e.playerConfig.input.asset&&Object.assign(r,{filename:e.url,requestsOptions:{proxy:"none"},format:e.ext,type:e.ext,tenant:e.platformId},e.playerConfig.input.asset);const i=(e,t)=>{s.checkSupport(e,{usage:"preview"},t)};return new n((n,o)=>{e.readOnly?i(r,e=>{e?n(r):(Object.assign(r,t),i(r,e=>{n(e?r:null)}))}):n(null)})})(Object.assign({},l,{endpointUrl:S.endpointUrl,spinner:S.spinner}))).then(t=>{if(t)return(t=>{f(t.spinner),D(),t.rootElem.setStyles({display:"block"});const n=e.createElement("div",{id:O,styles:{height:"100%",width:"100%"}});n.inject(t.rootElem);const o=Object.assign({},t.playerConfig,{container:n});o.input=Object.assign(o.input||{},{asset:t.asset}),o.options=Object.assign(o.options||{},{loading:"autoplay"}),c.x3DPlayerInstance=new i(o),"function"==typeof t.on3DPlayerReady&&t.on3DPlayerReady(c.x3DPlayerInstance)})(Object.assign({},l,{asset:t,spinner:S.spinner})),r(!0),I.setValue(N.DIMENSIONS.OPEN_MODE,N.DIMENSIONS_VAL.PDF),l.image&&I.setValue(N.DIMENSIONS.OPEN_MODE,N.DIMENSIONS_VAL.IMAGE),N.CATEGORY.DOCUMENT,void N.ACTION.OPEN;(t=>{const n={frameborder:0,src:o.isInMobileApp()?p.proxifyUrl(t.url,{proxy:"passport"}):t.url,width:"100%",height:"100%",scrolling:!0,styles:{marginTop:"-26px",height:"calc(100% + 26px)"}},r=["allow-same-origin","allow-forms","allow-scripts","allow-popups"];o.isInMobileApp()||r.push("allow-downloads","allow-modals"),n.sandbox=r.join(" ");const s=e.createElement("iframe",n),i=e.createElement("div",{id:E,styles:{height:"100%",width:"100%",overflow:"hidden",border:"1px solid #dadada"}});s.inject(i),i.inject(t.rootElem);let a=!1;const l=e=>{if(!/(\.3ds\.com|\.3dexperience\.cn)$/.test(e.origin))return;let n;try{n=JSON.parse(e.data)}catch(e){return}switch(n.kind){case"iframe.ready":f(t.spinner);break;case"ode.onDocumentReady":a=!0,f(t.spinner),""!==n.key&&S.setKey(n.key,!1);break;case"ode.onDocumentStateChange":if(!t.autoSaveInput)return;if(!a)return;if(n.data)break;if(""===n.key)break;clearTimeout(u),u=setTimeout(()=>{const e=S.save(t.autoSaveInput);"function"==typeof t.onAutoSaveComplete&&e.then(e=>t.onAutoSaveComplete(null,e)).catch(e=>t.onAutoSaveComplete(e,null))},1e3+1e3*t.autoSaveDelayInSec)}};window.addEventListener("message",l),window.onbeforeunload=(e=>{window.removeEventListener("message",l)}),m.push(()=>{window.removeEventListener("message",l)})})(Object.assign({},l,{url:S.endpointUrl,spinner:S.spinner})),r(!0),I.setValue(N.DIMENSIONS.OPEN_MODE,N.DIMENSIONS_VAL.EDITOR),l.image&&I.setValue(N.DIMENSIONS.OPEN_MODE,N.DIMENSIONS_VAL.IMAGE),N.CATEGORY.DOCUMENT,N.ACTION.OPEN}).catch(e=>{f(S.spinner);let t=e;o.isErrorSupported(t)||(t=S.ERROR.UNKNOWN),R(t),I.setValue(N.DIMENSIONS.ERROR_KIND,o.getErrorKey(t)),I.setValue(N.DIMENSIONS.ERROR_VALUE,e),N.CATEGORY.DOCUMENT,N.ACTION.OPEN})):R(S.ERROR.NO_ROOT_ELEM):R(S.ERROR.NO_DOCUMENT_URL_PROVIDED)})}),S.save=(async e=>{const s=Object.assign(e||{},{}),i=await(()=>new n((e,t)=>{const n=new MessageChannel;n.port1.onmessage=(o=>{if(!o.data)return void t(new Error("unexpected response"));let r;try{r=JSON.parse(o.data)}catch(e){return}switch(r.kind){case"ode.docGetInfo":return n.port1.close(),void e(r.data)}t(new Error("unexpected response"))}),document.getElementById(E).getElementsByTagName("iframe")[0].contentWindow.postMessage({kind:"docGetInfo"},"*",[n.port2])}))(),a={key:s.key||S.key,url:S.url,callbackUrl:s.callbackUrl,params:s.params,headers:s.headers,filenameForUpload:s.filenameForUpload,firstCallUrl:s.firstCallUrl,hancomOpen:i.open,hancomUserSession:i.smb_index,hancomSmb:i.smb,hancomApp:i.smb_app},l=t.parseUrl(S.endpointUrl);l.path="/save",l.query="";const p=JSON.stringify(a);return new n((e,n)=>{r.handleRequest(t.composeUrl(l),{timeout:6e4,method:"POST",data:p,type:"json",responseType:"json",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:(t,r)=>{const s=document.getElementById(E).getElementsByTagName("iframe")[0];return s.focus(),s.contentWindow.postMessage({focusEditor:!0},"*"),t?t.error?(I.setValue(N.DIMENSIONS.ERROR_KIND,o.getErrorKey(S.ERROR.INVALID_SERVER_RESPONSE)),I.setValue(N.DIMENSIONS.ERROR_VALUE,t),N.CATEGORY.DOCUMENT,N.ACTION.SAVE,void n(new Error(JSON.stringify(t.error)))):(N.CATEGORY.DOCUMENT,N.ACTION.SAVE,void e(t)):(I.setValue(N.DIMENSIONS.ERROR_KIND,o.getErrorKey(S.ERROR.INVALID_SERVER_RESPONSE)),I.setValue(N.DIMENSIONS.ERROR_VALUE,t),N.CATEGORY.DOCUMENT,N.ACTION.SAVE,void n(new Error("unexpected response")))},onFailure:e=>{I.setValue(N.DIMENSIONS.ERROR_KIND,o.getErrorKey(S.ERROR.XHR)),I.setValue(N.DIMENSIONS.ERROR_VALUE,e),N.CATEGORY.DOCUMENT,N.ACTION.SAVE,n(e)},onTimeout:e=>{I.setValue(N.DIMENSIONS.ERROR_KIND,o.getErrorKey(S.ERROR.XHR_TIMEOUT)),I.setValue(N.DIMENSIONS.ERROR_VALUE,e),N.CATEGORY.DOCUMENT,N.ACTION.SAVE,n(e)},authentication:"passport"})})}),S.state=(e=>{const s=Object.assign(e||{},{}),i={key:s.key||S.key},a=(e,n,o)=>{const s=t.parseUrl(e);s.path="/state",s.query=Object.keys(i).map(e=>`${t.encodeUrl(e)}=${t.encodeUrl(i[e])}`).join("&"),r.handleRequest(t.composeUrl(s),{timeout:6e4,method:"GET",type:"json",responseType:"json",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:(e,t)=>{e?e.error?o(new Error(JSON.stringify(e.error))):n(e):o(new Error("unexpected response"))},onFailure:o,onTimeout:o,authentication:"passport"})};return new n((e,t)=>{s.platformId||!S.endpointUrl?o.getOfficeDocumentEditorServiceUrl(s.platformId).then(n=>{a(n,e,t)}).catch(t):a(S.endpointUrl,e,t)})}),S}),define("DS/OfficeDocumentEditorClient/OfficeDocumentEditorClient",["DS/OfficeDocumentEditorClient/Utils"],function(e){"use strict";let t="";try{t=window.location.host.split(".")[0].split("-")[0]}catch(e){}e.getOfficeDocumentEditorServiceUrl(t).then(e=>{const t=new URL(e);t.pathname="/resources/webapps/OfficeDocumentEditorClient",requirejs.undef("DS/OfficeDocumentEditorClient/Editor"),requirejs.undef("DS/OfficeDocumentEditorClient/Utils"),require.config({paths:{"DS/OfficeDocumentEditorClient/Editor":`${t.toString()}/OfficeDocumentEditorClient`,"DS/OfficeDocumentEditorClient/Utils":`${t.toString()}/OfficeDocumentEditorClient`}})}).catch(e=>{console.log(new Error("Cannot load ODE script, err:"+e))})});