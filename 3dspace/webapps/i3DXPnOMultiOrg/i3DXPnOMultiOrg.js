"use strict";define("DS/i3DXPnOMultiOrg/DataProxy",["DS/WAFData/WAFData"],function(e){var t,n,r,i,o,s={};return{setParams:function(e,o,s,l){t=e,n=o,r=s,i=l||"en"},setServicesMap:function(e){s={"3DSpace":e["3DSpace"],"3DSwym":e["3DSwym"],"3DSearch":e["3DSearch"]}},setIsOnPremise:function(e){o=e},isOnPremise:function(){return o},getSpaceURL:function(){return s["3DSpace"]||""},getSwymURL:function(){return s["3DSwym"]||""},getSearchURL:function(){return s["3DSearch"]||""},getTenantId:function(){return n},getCurrentUser:function(){return r},getCurrentLanguage:function(){return i},request:function(r,o){r+=-1===r.indexOf("?")?"?":"&",r+="tenant="+n;var s=o.headers||{};return s["Accept-Language"]=i,s.SecurityContext=t,o.headers=s,e.authenticatedRequest(r,o)}}}),define("DS/i3DXPnOMultiOrg/OrganisationsOperator/Models/Org",["UWA/Class/Model"],function(e){return e.extend({idAttribute:"pid",defaults:{pid:"",name:"",title:"",type:"",host:"false",visible:"true",children:[],color:""},setup:function(){this.visibleChildren=null},sync:function(e){"delete"!==e&&this._parent.apply(this,arguments)},getId:function(){return this.get("pid")||""},getName:function(){return this.get("name")||""},getTitle:function(){return this.get("title")||this.getName()},getChildren:function(){return this.get("children")||[]},getColor:function(){return this.get("color")},setColor:function(e,t){this.set("color",e,{silent:t})},isRoot:function(){return"Company"===this.get("type")},isVisible:function(){return"true"===this.get("visible")},destroy:function(){this._parent.apply(this,arguments)}})}),define("DS/i3DXPnOMultiOrg/OrganisationsOperator/Collections/Orgs",["UWA/Core","UWA/Json","UWA/Class/Collection","DS/i3DXPnOMultiOrg/DataProxy","DS/i3DXPnOMultiOrg/OrganisationsOperator/Models/Org"],function(e,t,n,r,i){return n.extend({model:i,rootColor:["blue-root","yellow-root","red-root","orange-root","green-root","purple-root","pink-root","grey-root","black-root"],hostRootColor:"host-color-root",rootColorIndex:0,setup:function(e,t){this.roots=[]},sync:function(e,t,n){n.ajax=r.request,this._parent.apply(this,[e,t,n])},parse:function(e,t){return e.organizations},parseCollection:function(){var e=this,t=e.rootColor;e.forEach(function(n){if(n.isRoot()){"true"===n.get("host")?e.roots.unshift(n):e.roots.push(n),n.setColor("true"===n.get("host")?e.hostRootColor:t[e.rootColorIndex%t.length]);var r=n.getColor();e.getVisibleChildrenOf(n).forEach(function(e){e.setColor(r)}),e.rootColorIndex++}})},getRoots:function(){return this.roots},getChildrenOf:function(e){var t=[],n=this;return function e(r){r.getChildren().forEach(function(i){i=n.get(i),t.splice(-1!==t.indexOf(r)?t.indexOf(r)+1:0,0,i),e(i)})}(e),t},getVisibleChildrenOf:function(e){var t=e.visibleChildren;return t||(e.visibleChildren=this.getChildrenOf(e).filter(function(e){return e.isVisible()}),e.visibleChildren)},getPeopleColor:function(e){var t,n=e.getMemberOfIds();return n.length?(t=this.get(n[0]))&&t.getColor():""}})}),define("DS/i3DXPnOMultiOrg/OrganisationsOperator/Models/People",["UWA/Core","UWA/Class/Model","UWA/String","DS/i3DXPnOMultiOrg/DataProxy","i18n!DS/i3DXPnOMultiOrg/assets/nls/OrganisationsOperator"],function(e,t,n,r,i){return t.extend({idAttribute:"pid",defaults:{pid:"",name:"",firstname:"",lastname:"",email:"",couples:[],organizations:[],assignmentOverflow:!1,group:!1},setup:function(e){this.set("couples",e.couples||[],{silent:!0}),this.set("organizations",e.organizations||[],{silent:!0})},sync:function(e,t,n){n.ajax=r.request,this._parent(e,t,n)},isGroup:function(){return this.get("group")},getNLSType:function(){return this.isGroup()?"groupType":"userType"},getId:function(){return this.get("pid")||""},getName:function(){return this.isGroup()?this.get("name"):""==this.get("firstname")&&""==this.get("lastname")?this.get("email")+" ("+i.get("pending")+")":n.ucfirst(this.get("firstname"))+" "+this.get("lastname").toUpperCase()},getMemberOfIds:function(){return this.get("organizations")||[]},getAssignments:function(){return this.get("couples")||[]},getNumberOfOwnerAssignments:function(){return this.getAssignments().filter(function(e){return"VPLMProjectAdministrator"===e.role}).length},hasOnlyOneAssignment:function(){var e=this.getAssignments();return e.length<2||2===e.length&&e[0].organization===e[1].organization},canOwnerRoleBeRemoved:function(e,t){return 1!==this.getNumberOfOwnerAssignments()||this.get("name")!==e&&e===t},canBeRemovedfromCS:function(e,t){return this.get("name")!==e&&!(this.getNumberOfOwnerAssignments()>0&&e!==t)},_removeAssignmentImpl:function(e){var t,n,r=this.getAssignments(),i=[];for(n=0;n<r.length;n++)(t=r[n]).organization!==e&&i.push(t);return i},setAssignment:function(t,r,i){var o=e.clone(this._removeAssignmentImpl(r));"VPLMProjectLeader&VPLMProjectAdministrator"===t?(o.push({role:"VPLMProjectAdministrator",organization:r}),o.push({role:"VPLMProjectLeader",organization:r})):"3DSRestrictedLeader&3DSRestrictedOwner"===t?(o.push({role:"3DSRestrictedOwner",organization:r}),o.push({role:"3DSRestrictedLeader",organization:r})):o.push({role:n.ucfirst(t),organization:r}),this.save({couples:o},{headers:{"Content-Type":"application/json"},wait:!0,onComplete:i.onComplete,onFailure:i.onFailure})},removeAssignment:function(e,t){this.save({couples:this._removeAssignmentImpl(e)},{headers:{"Content-Type":"application/json"},wait:!0,onComplete:t.onComplete,onFailure:t.onFailure})},destroy:function(){this._parent.apply(this,arguments)}})}),define("DS/i3DXPnOMultiOrg/OrganisationsOperator/Collections/Peoples",["UWA/Core","UWA/Json","UWA/Class/Collection","DS/i3DXPnOMultiOrg/DataProxy","DS/i3DXPnOMultiOrg/OrganisationsOperator/Models/People"],function(e,t,n,r,i){return n.extend({model:i,setup:function(e,t){this._parent(e,t),this.state={hasNextPage:!0,pagenumber:0,pagesize:50}},setView:function(e){var t=this;t.view=e,t.addEvent("onChange:couples",function(e){t.view.dispatchEvent("onAssignmentsChange",e)}),t.addEvent("onScrollEnd",function(e){t.view.dispatchEvent("onScrollEnd",e)}),t.addEvent("onScrollFailure",function(){t.view.dispatchEvent("onScrollFailure")})},sync:function(e,t,n){n.ajax=r.request,this._parent.apply(this,[e,t,n])},fetch:function(e){e.getNextPage?e.getNextPage&&(this.state.pagenumber+=1):(this.state.pagenumber=0,this.state.hasNextPage=!0),e.data={pagenumber:this.state.pagenumber,pagesize:this.state.pagesize},this._parent(e)},parse:function(e,t){var n=e.members;return r.setIsOnPremise(e.isOnPremise),n&&n.length||(this.state.hasNextPage=!1),n},handleScroll:function(){if(!this.isAlreadyHandling){this.isAlreadyHandling=!0;var e=this;this.state.hasNextPage&&this.fetch({getNextPage:!0,remove:!1,onComplete:function(t,n,i){if(r.isOnPremise())e.isAlreadyHandling=!1,e.dispatchEvent("onScrollEnd",n.members.length);else{e.filterPrivateGroups(n,function(t){e.isAlreadyHandling=!1,e.dispatchEvent("onScrollEnd",t)},function(){e.state.hasNextPage=!1,e.dispatchEvent("onScrollFailure")})}},onFailure:function(){e.state.hasNextPage=!1,e.dispatchEvent("onScrollFailure")}})}},filterPrivateGroups:function(e,t,n){for(var i=[],o=0;o<e.members.length;o++){var s=e.members[o];if(s.group){var l=s.uri;i.push(l)}}if(0===i.length)t(e.members.length);else{var a=this,c={type:"json",method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify({source:["usersgroup"],nresults:50,order_by:"desc",order_field:"relevance",tenant:r.getTenantId(),select_predicate:["ds6w:resourceUid","ds6w:label"],label:"3DSpaceAdv-"+r.getCurrentUser()+"-"+Date.now(),query:'[ds6w:resourceUid]:("'+i.join('" OR "')+'")',with_synthesis:!1,with_synthesis_attribute:!1,locale:r.getCurrentLanguage()}),onComplete:function(n){var r=a._parseSearchResponse(n),o=Object.keys(r);a.map(function(e){var t=e.get("uri");r[t]&&e.set("name",r[t])});var s=i.filter(function(e){return!o.includes(e)}),l=a.filter(function(e){return s.includes(e.get("uri"))});a.remove(l),t(e.members.length-l.length)},onFailure:function(){var e=a.filter(function(e){return i.includes(e.get("uri"))});a.remove(e),n()}};r.request(r.getSearchURL()+"/search",c)}},_parseSearchResponse:function(e){for(var t=e.results||[],n={},r=0;r<t.length;r++){for(var i=t[r].attributes,o="",s="",l=0;l<i.length;l++){var a=i[l];"ds6w:resourceUid"===a.name?(o=a.value)&&-1===o.indexOf("uuid:")&&-1===o.indexOf("dsaccess:")&&(o="<"+(o="uuid:"+o)+">"):"ds6w:label"===a.name&&(s=a.value)}n[o]=s}return n}})}),define("DS/i3DXPnOMultiOrg/OrganisationsOperator/Views/OrganisationsOperator",["UWA/Core","UWA/Class/View","UWA/Event","UWA/Element","UWA/Utils","UWA/String","DS/UIKIT/SuperModal","DS/UIKIT/Input/Text","DS/UIKIT/DropdownMenu","DS/UIKIT/Tooltip","DS/i3DXPnOMultiOrg/DataProxy","DS/i3DXPnOMultiOrg/OrganisationsOperator/Collections/Peoples","DS/i3DXPnOMultiOrg/OrganisationsOperator/Collections/Orgs","i18n!DS/i3DXPnOMultiOrg/assets/nls/OrganisationsOperator","css!DS/i3DXPnOMultiOrg/i3DXPnOMultiOrg.css"],function(e,t,n,r,i,o,s,l,a,c,d,u,g,h){var m=!1,p=!1,f=0,v=0,C=null,O=null;function b(e,t,n){var r,i,o,s=0;function l(){s=(new Date).getTime(),i=null,o=e.apply(n,r)}return function(){var a=(new Date).getTime(),c=t-(a-s);return n=n||this,r=arguments,c<=0?(clearTimeout(i),i=null,s=a,o=e.apply(n,r)):i||(i=setTimeout(l,c)),o}}function P(e,t){var n,r,i,o,s,l;return r=(n=t.getDimensions()).width,o=(i=e.getOffsets().x-t.getOffsets().x)+e.getDimensions().width,{totally:s=i>=0&&o<=r,partially:l=i<0&&o>0||i>=0&&i<=n.width,visible:s||l}}function S(e,t){e.scroll?e.scroll(t):(t.top&&(e.scrollTop=t.top),t.left&&(e.scrollLeft=t.left))}return t.extend({tagName:"div",className:"orgsop-view",domEvents:{"click .content-line .suborg-cell":"_clickOnCell","click .add-people-btn":"_clickOnAddUsersBtn","click .close-view-btn":"_clickOnCloseViewBtn","click .people-trash-ctn":"_clickOnTrashBtn","click .left-orgnav-btn":"_clickOnLeftOrgNavBtn","click .right-orgnav-btn":"_clickOnRightOrgNavBtn"},events:{onAddUsers:null,onRemoveUser:null},currentUser:"",swymURL:null,peoplesCollection:null,orgsCollection:null,roleIcons:{VPLMProjectLeader:"fonticon fonticon-favorite-on","3DSRestrictedLeader":"fonticon fonticon-favorite-on",VPLMProjectAdministrator:"fonticon fonticon-key","3DSRestrictedOwner":"fonticon fonticon-key",VPLMCreator:"fonticon fonticon-feather","3DSRestrictedAuthor":"fonticon fonticon-feather",VPLMExperimenter:"fonticon fonticon-chat","3DSRestrictedContributor":"fonticon fonticon-chat",VPLMViewer:"fonticon fonticon-eye","3DSRestrictedReader":"fonticon fonticon-eye",VPLMSecuredCrossAccess:"fonticon fonticon-eye"},rolesDDMenu:null,selectedCell:null,hoverPeopleCell:null,hoverContentCell:null,setup:function(t){var n=t||{};this.readOnly=n.readOnly,this.restrictedOrg=n.restrictedOrg,this.currentUser=n.currentUser||"",this.swymURL=d.getSwymURL(),this.roles=n.roles,this.mainOwner=n.mainOwner,this.peoplesCollection=n.peopleCollection,this.peoplesCollection.setView(this),this.orgsCollection=n.orgsCollection,this.orgsCollection.parseCollection(),this.successAlert=n.successAlert,this.errorAlert=n.errorAlert,e.merge(this.events,n.events||{})},render:function(){var t,n,r,o,s,a,d,u,g,m,p,f,v,C,O=this,b=i.Client.getScrollbarWidth();O.container;r=e.createElement("div",{class:"buttons-row-ctn",html:[O.readOnly&&!O.restrictedOrg?null:t=e.createElement("div",{class:"fonticon fonticon-user-add action-btn add-people-btn"}),n=e.createElement("div",{class:"fonticon fonticon-close action-btn close-view-btn"})]}),t&&new c({target:t,body:h.addNewUser,position:"bottom"}),new c({target:n,body:h.closeAdvView,position:"bottom"});var P=e.createElement("div",{class:"header-ctn",html:[e.createElement("div",{class:"csadv-title",text:this.options.collabSpace}),r]});return o=e.createElement("div",{class:"table-ctn"}),O.container.addContent(P,o),O.orgsCollection.isEmpty()?(o.addContent(e.createElement("div",{class:"empty-table",text:h.emptyTable})),O):(o.addContent(s=e.createElement("div",{class:"header-line",html:[e.createElement("div",{class:"filter-cell",html:[e.createElement("div",{class:"filter-ctn",html:[new l({className:"search-filter hide",placeholder:h.searchPlaceHolder}),e.createElement("div",{class:"fonticon fonticon-tag-sorting sort-icon hide"})]})]}),e.createElement("div",{class:"orgs-col",html:[e.createElement("div",{class:"navorg-cell",html:[e.createElement("div",{class:"navorg-ctn",html:[f=e.createElement("div",{class:"fonticon fonticon-chevron-left left-orgnav-btn nav-btn disabled",title:h.previousOrgNavBtn}),e.createElement("div",{class:"navorg-middle-ctn",text:h.contentOwnByTitle}),e.createElement("div",{class:"fonticon fonticon-network org-explode-btn nav-btn hide"}),v=e.createElement("div",{class:"fonticon fonticon-chevron-right right-orgnav-btn nav-btn",title:h.nextOrgNavBtn})]})]}),u=e.createElement("div",{class:"orgs-line"})]})]}),e.createElement("div",{class:"contents-line",html:[a=e.createElement("div",{class:"peoples-col",styles:{"padding-bottom":b}}),d=e.createElement("div",{class:"contents-col",html:[g=e.createElement("div",{class:"contents-ctn"})],events:{scroll:O._onScroll.bind(O)}}),C=e.createElement("div",{class:"action-overlay"})]}),m=e.createElement("div",{class:"horizontal-highlight"}),p=e.createElement("div",{class:"vertical-highlight"})),O.orgsCollection.getRoots().forEach(function(t){var n=t.getTitle();u.addContent(e.createElement("div",{class:"org-cell",html:[e.createElement("div",{class:"rootorg-cell",html:[e.createElement("div",{class:"rootorg-ctn",html:[e.createElement("div",{class:"rootorg-name",text:n.toUpperCase(),title:n,styles:{width:138*((t.isVisible()?1:0)+O.orgsCollection.getVisibleChildrenOf(t).length)-5+"px",overflow:"hidden","text-overflow":"ellipsis"}}),e.createElement("div",{class:"rootorg-color "+t.getColor()})]})]}),e.createElement("div",{class:"subsorg-cell",html:O._buildSubOrgCell(t)})]}));var r=u.getElement('div[title="'+t.getTitle()+'"]');new c({target:r,body:n,position:"top"})}),u.addContent(e.createElement("div",{html:'<div style="width: 138px"></div>'})),O.peoplesCollection.forEach(function(e){a.addContent(O._buildPeopleCell(e)),g.addContent(O._buildContentLine(e))}),O.elements={horizontalHighlight:m,verticalHighlight:p,headerLine:s,orgsLine:u,peoplesCol:a,contentsCol:d,contentsCtn:g,actionOverlay:C,leftOrgNavBtn:f,rightOrgNavBtn:v},O)},onPostInject:function(){var e=this.elements,t=e.contentsCtn,n=e.orgsLine,r=i.Client.getScrollbarWidth();t.setStyles({width:n.scrollWidth-r+"px"}),e.verticalHighlight.setStyles({top:t.getPosition().y}),this._addEvents()},onFacetSelect:function(){},onPositionChange:function(){this.onResize()},onResize:function(){},destroy:function(){this.peoplesCollection&&(this.peoplesCollection=null),this.orgsCollection&&(this.orgsCollection=null),this._parent.apply(this,arguments),this.elements=null},_buildSubOrgCell:function(t){function n(t){return e.createElement("div",{class:"suborg-cell",html:[e.createElement("div",{class:"suborg-ctn",html:[e.createElement("div",{class:"suborg-name",text:o.capitalize(t.getTitle().toLowerCase())})]})]})}return(t.isVisible()?[n(t)]:[]).concat(this.orgsCollection.getVisibleChildrenOf(t).map(n))},_buildPeopleCell:function(t){var n=this.orgsCollection,r="",s=t.getId();if(this.swymURL&&!t.isGroup()){var l=i.parseUrl(this.swymURL);l.authority&&(r=o.format("{0}://{1}{2}api/user/getpicture/login/{3}/format/normal",l.protocol||"https",l.authority,l.directoryPath||"/",t.get("name")))}return e.createElement("div",{class:"people-cell people-id-"+s,html:[e.createElement("div",{class:"peopleorg-color "+n.getPeopleColor(t)}),e.createElement("div",{class:"people-ctn",html:[e.createElement("div",{class:t.isGroup()?"profile-pic-ctn fonticon fonticon-users":"profile-pic-ctn fonticon fonticon-user",html:e.createElement("div",{class:"profile-pic",styles:{"background-image":'url("'+r+'")'}})}),e.createElement("div",{class:"people-info-ctn",html:[e.createElement("div",{class:"name-ctn",text:t.getName()}),t.isGroup()?null:e.createElement("div",{class:"memberof-org-ctn",html:this._buildPeopleMemberOfInfo(t)})]}),this.readOnly?null:e.createElement("div",{class:"separator"}),this.readOnly?null:e.createElement("div",{class:"people-trash-ctn "+(t.canBeRemovedfromCS(this.currentUser,this.mainOwner)?"":"disabled"),title:h.replace(h.get("trashBtn"),{type:h.get(t.getNLSType())}),html:[e.createElement("div",{class:"fonticon fonticon-trash trash-btn"})]})]})]}).setData("people",{id:s})},_buildPeopleMemberOfInfo:function(t){var n=this,r=t.getAssignments(),i=t.getMemberOfIds(),s=e.createElement("div",{class:"memberof-names",html:i.map(function(e){return'<span class="org-name '+(!!r.filter(function(t){return e===t.organization}).length?"has-assignment":"")+'">'+o.capitalize(n.orgsCollection.get(e).getTitle().toLowerCase())+"</span>"}).join(" - ")});if(s.textContent.length>37)new c({target:s,className:"memberof-tooltip",body:s.innerHTML,position:"right"});return s},_buildContentLine:function(t){var n=this,r=t.getId();return e.createElement("div",{class:"content-line people-id-"+r,html:n.orgsCollection.getRoots().map(function(r){return e.createElement("div",{class:"subsorg-cell"+(n.readOnly?" read-only":""),html:function(e){return(e.isVisible()?[n._buildCell(t,e)]:[]).concat(n.orgsCollection.getVisibleChildrenOf(e).map(function(e){return n._buildCell(t,e)}))}(r)})})}).setData("people",{id:r})},_buildCell:function(t,n){var r,i,o=this,s=n.getId(),l=n.getName(),a=t.getMemberOfIds(),c=t.getAssignments().filter(function(e){return e.organization===s}),d={orgId:s,peopleId:t.getId()},u=[];return(i=a.indexOf(s)>=0)&&(d.isMemberOf=i),c.length&&(2===c.length&&"VPLMProjectLeader"!==c[0].role&&"3DSRestrictedLeader"!==c[0].role&&c.reverse(),c=c.map(function(n,r){var s=n.role||"",l=i&&!t.isGroup()?o.roleIcons[s]:"";return u.push(s),s=h[s],e.createElement("div",{class:"role-ctn "+l,html:e.createElement("div",{class:"role-name",text:r?h.get("ANDRoleTxt")+" "+s:s})})}),r=e.createElement("div",{class:"assignments-ctn",html:c}),d.roles=u),e.createElement("div",{class:"content-cell suborg-cell "+(o.readOnly&&l===this.restrictedOrg?"restrictedOrg":""),html:[e.createElement("div",{class:"suborg-ctn "+(i&&r&&!t.isGroup()?"memberof":""),html:[r,e.createElement("div",{class:"fonticon fonticon-chevron-down menu-icon "+(!r||o.readOnly&&l!==this.restrictedOrg?"has-no-role":"")})]})],events:{mouseenter:o._onMouseEnterCell.bind(o)}}).setData("data",d)},_addEvents:function(){var e=this,t=e.elements,n=t.contentsCol,r=t.orgsLine,i=t.peoplesCol,o=(t.horizontalHighlight,t.verticalHighlight);e.addEvent("onAssignmentsChange",e._onAssignmentsChange.bind(e)),e.addEvent("onScrollEnd",e._onScrollEnd.bind(e)),e.addEvent("onScrollFailure",e._onScrollFailure.bind(e)),n.addEvent("mouseenter",function(){o.addClassName("show")}),n.addEvent("mouseleave",function(){(e.rolesDDMenu||{}).isVisible||o.removeClassName("show")}),e.container.addEvent("mousewheel",function(e){if(m||p)return e.preventDefault&&e.preventDefault(),e.returnValue=!1,!1}),i.addEvent("mouseenter",function(){m=!0}),i.addEvent("mouseleave",function(){m=!1}),r.addEvent("mouseenter",function(){p=!0}),r.addEvent("mouseleave",function(){p=!1}),i.addEvent("mousewheel",b(function(t){var n=t.wheelDelta;e._scrollContent({way:n>0?"up":"down",delta:n,behavior:"smooth"})},200)),r.addEvent("mousewheel",b(function(t){var n=t.wheelDelta;e._scrollContent({way:n>0?"right":"left",delta:n,behavior:"smooth"})},200))},selectCell:function(e){e.addClassName("selected"),this.selectedCell=e},_unSelectCell:function(e){(e=e||this.selectedCell)&&(e.removeClassName("selected"),this.selectedCell=null)},_hoverPeopleCell:function(e){e.addClassName("hover"),this.hoverPeopleCell=e},_hoverContentCell:function(e){e.addClassName("hover"),this.hoverContentCell=e},_unHoverPeopleCell:function(e){(e=e||this.hoverPeopleCell)&&(e.removeClassName("hover"),this.hoverPeopleCell=null)},_unHoverContentCell:function(e){(e=e||this.hoverContentCell)&&(e.removeClassName("hover"),this.hoverContentCell=null)},_showActionOverlay:function(){this.elements.actionOverlay.addClassName("show")},_hideActionOverlay:function(){this.elements.actionOverlay.removeClassName("show")},_clickOnCell:function(e){var t,n,r,i,o,s,l,c=this,d=e.target;l=d.hasClassName("content-cell")?d:d.getParent(".content-cell"),i=l.getData("data");var u=this.orgsCollection.get(i.orgId).getName();if(!c.readOnly||this.restrictedOrg===u){c._unSelectCell(),r=l.getParent(".content-line"),s=0===(o=i.roles||[]).length,t=r.getData("people").id,n=c.peoplesCollection.get(t);for(var g,m=P("VPLMProjectAdministrator")&&!n.canOwnerRoleBeRemoved(this.currentUser,this.mainOwner),p=h.replace(h.get("lastOwnerRole"),{type:h.get(n.getNLSType())}),f=this.roles||[],v=!1,C=!1,O=!1,b=0;b<f.length;b++)"PublicReader"===f[b]?C=!0:"Reader"===f[b]?v=!0:"Contributorrestricted"===f[b]&&(O=!0);g=f.indexOf("Leader")>=0&&f.indexOf("Owner")>=0,c.rolesDDMenu&&c.rolesDDMenu.destroy(),c.rolesDDMenu=new a({target:l.getElement(".menu-icon"),items:this._buildRolesMenu(n,m,p,P,s,v,C,O,g),closeOnClick:!1,events:{onClick:function(e,t){t.items||(c.rolesDDMenu.hide(),c._clickOnRoleDDMenu(e,t,l,i,o,n))},onHide:function(){c._unSelectCell()}}}),c.selectCell(l),c.rolesDDMenu.show()}function P(e){return o.indexOf(e)>=0}},_buildBasicItems:function(e,t,n,r,i){var o,s,l=[o={text:h.VPLMExperimenter,name:"VPLMExperimenter",selectable:!e,disabled:t||!e&&this.restrictedOrg,attributes:t?{title:n}:{},selected:r("VPLMExperimenter")||r("3DSRestrictedContributor")},s={text:h.VPLMCreator,name:"VPLMCreator",selectable:!e,disabled:t||!e&&this.restrictedOrg,attributes:t?{title:n}:{},selected:r("VPLMCreator")||r("3DSRestrictedAuthor")}];if(i){var a={text:h.VPLMProjectLeader,name:"VPLMProjectLeader",selectable:!e,disabled:t||!e&&this.restrictedOrg,selected:r("VPLMProjectLeader")&&!r("VPLMProjectAdministrator")||r("3DSRestrictedLeader")&&!r("3DSRestrictedOwner")},c={text:h.VPLMProjectAdministrator,name:"VPLMProjectAdministrator",selectable:!e,disabled:!e&&this.restrictedOrg,selected:r("VPLMProjectAdministrator")&&!r("VPLMProjectLeader")||r("3DSRestrictedOwner")&&!r("3DSRestrictedLeader")};l.push(a),l.push(c)}var d={text:h.VPLMProjectLeader+" "+h.ANDRoleTxt+" "+h.VPLMProjectAdministrator,name:"VPLMProjectLeader&VPLMProjectAdministrator",selectable:!e,disabled:!e&&this.restrictedOrg,selected:r("VPLMProjectLeader")&&r("VPLMProjectAdministrator")||r("3DSRestrictedLeader")&&r("3DSRestrictedOwner")};return l.push(d),e&&(t||(o.items=[{text:h.get("VPLMExperimenter"),name:"VPLMExperimenter",selectable:!0,disabled:this.restrictedOrg,selected:r("VPLMExperimenter")},{text:h.get("3DSRestrictedContributor"),name:"3DSRestrictedContributor",selectable:!0,selected:r("3DSRestrictedContributor")}],s.items=[{text:h.get("VPLMCreator"),name:"VPLMCreator",selectable:!0,disabled:this.restrictedOrg,selected:r("VPLMCreator")},{text:h.get("3DSRestrictedAuthor"),name:"3DSRestrictedAuthor",selectable:!0,selected:r("3DSRestrictedAuthor")}]),i&&(a.items=[{text:h.get("VPLMProjectLeader"),name:"VPLMProjectLeader",selectable:!0,disabled:t||this.restrictedOrg,selected:r("VPLMProjectLeader")&&!r("VPLMProjectAdministrator")},{text:h.get("3DSRestrictedLeader"),name:"3DSRestrictedLeader",selectable:!0,disabled:t,attributes:t?{title:n}:{},selected:r("3DSRestrictedLeader")&&!r("3DSRestrictedOwner")}],c.items=[{text:h.get("VPLMProjectAdministrator"),name:"VPLMProjectAdministrator",selectable:!0,disabled:this.restrictedOrg,selected:r("VPLMProjectAdministrator")&&!r("VPLMProjectLeader")},{text:h.get("3DSRestrictedOwner"),name:"3DSRestrictedOwner",selectable:!0,disabled:t,attributes:t?{title:n}:{},selected:r("3DSRestrictedOwner")&&r("3DSRestrictedLeader")}]),d.items=[{text:h.get("VPLMProjectLeader")+" "+h.get("ANDRoleTxt")+" "+h.get("VPLMProjectAdministrator"),name:"VPLMProjectLeader&VPLMProjectAdministrator",selectable:!0,disabled:this.restrictedOrg,selected:r("VPLMProjectLeader")&&r("VPLMProjectAdministrator")},{text:h.get("3DSRestrictedLeader")+" "+h.get("ANDRoleTxt")+" "+h.get("3DSRestrictedOwner"),name:"3DSRestrictedLeader&3DSRestrictedOwner",selectable:!0,disabled:t,attributes:t?{title:n}:{},selected:r("3DSRestrictedLeader")&&r("3DSRestrictedOwner")}]),l},_buildAdditionalItems:function(e,t,n,r,i,o,s){if(t){var l={text:h.VPLMViewer,name:"VPLMViewer",selectable:!0,disabled:r||!s&&this.restrictedOrg,attributes:r?{title:i}:{},selected:o("VPLMViewer")||o("3DSRestrictedReader")};s&&!r&&(l.items=[{text:h.get("VPLMViewer"),name:"VPLMViewer",selectable:!0,disabled:this.restrictedOrg,selected:o("VPLMViewer")},{text:h.get("3DSRestrictedReader"),name:"3DSRestrictedReader",selectable:!0,selected:o("3DSRestrictedReader")}]),e.unshift(l)}n&&e.unshift({text:h.VPLMSecuredCrossAccess,name:"VPLMSecuredCrossAccess",selectable:!0,disabled:r||this.restrictedOrg,attributes:r?{title:i}:{},selected:o("VPLMSecuredCrossAccess")})},_buildRolesMenu:function(e,t,n,r,i,o,s,l,a){var c=this._buildBasicItems(l,t,n,r,a);if(this._buildAdditionalItems(c,o,s,t,n,r,l),!i){var d={text:h.revoke,name:"revoke",fonticon:"block",selectable:!1,disabled:t,attributes:t?{title:n}:{}};e.hasOnlyOneAssignment()&&(d.disabled=!0,d.attributes.title=d.attributes.title||h.replace(h.get("unableToRevoke"),{type:h.get(e.getNLSType())})),c.unshift(d)}return c},_clickOnRoleDDMenu:function(e,t,n,r,i,o){var s,l=this,a=t.name;if(function(e,t){return-1===t.indexOf(e)||t.length>1&&"VPLMProjectLeader&VPLMProjectAdministrator"!==e}(a,i)){s=r.orgId;var c=function(e){l._hideActionOverlay();var t=[{message:h.replace(h.get("success.changeAssignment"),{type:h.get(o.getNLSType())})}];e.get("assignmentOverflow")&&t.push({message:h.replace(h.get("warning.assignmentOverflow"),{type:h.get(o.getNLSType())}),className:"warning"}),l.successAlert.add(t),l._buildCell(o,l.orgsCollection.get(s)).inject(n,"after"),n.remove(),n=null},d=function(){l._hideActionOverlay(),l.errorAlert.add({message:h.replace(h.get("error.changeAssignment"),{type:h.get(o.getNLSType())})})};l._showActionOverlay(),"revoke"===a?o.removeAssignment(s,{onComplete:c,onFailure:d}):o.setAssignment(a,s,{onComplete:c,onFailure:d})}},_clickOnTrashBtn:function(e){var t,n,r,i,o,l,a=this,c=e.target;(c.hasClassName("people-trash-ctn")?c:c.getParent(".people-trash-ctn")).hasClassName("disabled")||(t=c.getParent(".people-cell"),n=t.getData("people").id,i=(r=a.peoplesCollection.get(n)).getName(),new s({closable:!0}).confirm((o=h.removeUserMsg,l={name:i},o.replace(/\{([\w\-]+)\}/g,function(e,t){return void 0!==l[t]?l[t]:""})),h.removeUserTitle,function(e){var i;if(e){a._showActionOverlay(),r.destroy({wait:!0,onComplete:function(){a._hideActionOverlay(),a.successAlert.add({message:h.replace(h.get("success.removeUser"),{type:h.get(r.getNLSType())})}),(i=a.elements.contentsCtn.getElement(".content-line.people-id-"+n)).addClassName("removed"),t.addClassName("removed"),setTimeout(function(){t&&t.remove(),t=null,i&&i.remove(),i=null},750),a.events.onRemoveUser(r.get("pid"))},onFailure:function(){a._hideActionOverlay(),a.errorAlert.add({message:h.replace(h.get("error.removeUser"),{type:h.get(r.getNLSType())})})}})}}))},_clickOnAddUsersBtn:function(){var t,n,r,i;t=this.events.onAddUsers,n=this,e.is(t,"function")&&(i?setTimeout(function(){t.apply(n,r)}):t.apply(n,r))},_clickOnCloseViewBtn:function(){this.events.onCloseView()},_clickOnLeftOrgNavBtn:function(){var e,t,n,r,i,o,s=this.elements,l=s.orgsLine,a=s.contentsCol.scrollLeft;function c(e){return l.scrollLeft+e.getPosition().x}if(0!==a){for(o=l.getElements(".org-cell"),e=0;e<o.length;e++){if((n=P(t=o[e],l)).totally){if(0===e)return;r=o[e-1];break}if(n.partially){r=t;break}}i=c(r),0!==e&&o.length>1&&i===a&&(i=c(r=o[e-1])),this._scrollContent({way:"left",left:i,behavior:"smooth"})}},_clickOnRightOrgNavBtn:function(){var e,t,n,r,i=this.elements,o=i.orgsLine;if(!i.rightOrgNavBtn.hasClassName("disabled")){for(r=o.getElements(".org-cell"),e=0;e<r.length;e++)if(P(r[e],o).visible){if(e+1>=r.length)return;t=r[e+1];break}n=o.scrollLeft+t.getOffsets().x-o.getOffsets().x,this._scrollContent({way:"right",left:n,behavior:"smooth"})}},_getPeopleCell:function(e){return this.elements.peoplesCol.getElement(".people-id-"+e)},_onMouseEnterCell:function(e){var t=e.target,n=t.getPosition(),r=this.elements,i=t.getData("data");this._unHoverPeopleCell(),this._unHoverContentCell(),r.horizontalHighlight.setStyles({transform:"translateY("+n.y+"px)"}),r.verticalHighlight.setStyles({transform:"translateX("+n.x+"px)"}),this._hoverPeopleCell(this._getPeopleCell(i.peopleId)),this._hoverContentCell(t)},_onScroll:function(){var e=this.elements.contentsCol,t=e.scrollTop,n=e.scrollLeft;this.rolesDDMenu&&this.rolesDDMenu.destroy(),this._unSelectCell(),t>f?this._onScrollV("down"):t<f&&this._onScrollV("up"),f=t,n>v?this._onScrollH("right"):n<v&&this._onScrollH("left"),v=n},_onScrollV:function(e,t){t=t||{};var n=this.elements,r=n.peoplesCol,i=n.headerLine,o=n.contentsCol;S(r,{top:t.top||o.scrollTop-(t.delta||0),behavior:t.behavior}),i.addClassName("scrolling"),clearTimeout(C),C=setTimeout(function(){i.removeClassName("scrolling")},750),f=o.scrollTop;var s=o.scrollHeight-o.clientHeight;f/s>.85&&this.peoplesCollection.handleScroll()},_onScrollH:function(e,t){t=t||{};var n,r,i,o,s=this.elements,l=s.peoplesCol,a=s.orgsLine,c=s.contentsCol,d=s.leftOrgNavBtn,u=s.rightOrgNavBtn;function g(e,t){e[(t?"add":"remove")+"ClassName"]("disabled")}S(a,{left:t.left||c.scrollLeft-(t.delta||0),behavior:t.behavior}),"left"===e&&l.addClassName("scrolling"),"right"===e&&c.addClassName("scrolling"),clearTimeout(O),O=setTimeout(function(){l.removeClassName("scrolling"),c.removeClassName("scrolling")},750),n=c.scrollLeft,v=n,g(d,0===n),(r=a.getElements(".org-cell")).length>1?(i=P(r[r.length-2],a),o=P(r[r.length-1],a),g(u,!i.visible&&o.visible)):g(u,!0)},_scrollContent:function(t){t=t||{};var n,r,i=this.elements.contentsCol,o=e.is(t.top,"number")?t.top:void 0,s=e.is(t.left,"number")?t.left:void 0,l=t.behavior,a=e.is(t.delta)?t.delta:void 0,c=t.way,d=a&&("up"===c||"down"===c),u=a&&("right"===c||"left"===c);S(i,{top:n=d&&a?i.scrollTop-a:o,left:r=u&&a?i.scrollLeft-a:s,behavior:l}),(o||d)&&this._onScrollV(c,{top:n,behavior:l}),(s||u)&&this._onScrollH(c,{left:r,behavior:l})},_onAssignmentsChange:function(e){var t=e.getId(),n=this._getPeopleCell(t);if(e.isGroup()||n.getElement(".memberof-org-ctn").empty().addContent(this._buildPeopleMemberOfInfo(e)),!e.canBeRemovedfromCS(this.currentUser,this.mainOwner)){var r=n.getElement(".people-trash-ctn");r.hasClassName("disabled")||r.addClassName("disabled")}},_onScrollEnd:function(e){for(var t=this.peoplesCollection,n=t.slice(t.length-e),r=0;r<n.length;r++)this.elements.peoplesCol.addContent(this._buildPeopleCell(n[r])),this.elements.contentsCtn.addContent(this._buildContentLine(n[r]))},_onScrollFailure:function(){this.errorAlert.add({message:h.get("error.fetchMembers")})}})}),define("DS/i3DXPnOMultiOrg/OrgOperatorController",["UWA/Core","UWA/Class","UWA/Class/Events","UWA/Json","DS/UIKIT/Alert","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/i3DXPnOMultiOrg/OrganisationsOperator/Collections/Orgs","DS/i3DXPnOMultiOrg/OrganisationsOperator/Collections/Peoples","DS/i3DXPnOMultiOrg/OrganisationsOperator/Views/OrganisationsOperator","DS/i3DXPnOMultiOrg/DataProxy","i18n!DS/i3DXPnOMultiOrg/assets/nls/OrganisationsOperator"],function(e,t,n,r,i,o,s,l,a,c,d){return t.extend(n,{options:{},container:null,orgsOpView:null,buildSkeleton:function(){var e=this.options;this.container.empty();var t="";e.ownerRestricted&&(t=e.securityContext.split(".")[1]),this.orgsOpView=new a({currentUser:e.currentUser,readOnly:!e.owner,restrictedOrg:t,roles:e.roles,mainOwner:e.mainOwner,collabSpace:e.collabSpaceTitle?e.collabSpaceTitle:e.collabSpace,orgsCollection:e.orgsCollection,peopleCollection:e.peopleCollection,successAlert:this.successAlert,errorAlert:this.errorAlert,events:{onAddUsers:e.onAddUsers||function(){},onRemoveUser:function(e){this.dispatchEvent("onRemoveUser",[e])}.bind(this),onCloseView:e.onCloseView||this.destroy.bind(this)}}),this.orgsOpView.render().inject(this.container),this.successAlert.inject(this.container),this.errorAlert.inject(this.container)},init:function(t){this.options=e.clone(t,!1)||{},this.container=e.extendElement(t.container)},load:function(){var e=this,t=this.options,n=t.collabSpace,r=t.securityContext,a=t.tenantId,u=t.currentUser,g=widget.lang;this.successAlert=new i({className:"message-alert",closable:!0,visible:!0,autoHide:!0,messageClassName:"success"}),this.errorAlert=new i({className:"message-alert",closable:!0,visible:!0,autoHide:!0,messageClassName:"error"}),c.setParams(r,a,u,g),o.getPlatformServices({platformId:a,onComplete:function(r){c.setServicesMap(r);var i=new s([],{url:c.getSpaceURL()+"/resources/pno/collaborativespace/"+n+"/organizations"}),o=new l([],{url:c.getSpaceURL()+"/resources/pno/collaborativespace/"+n+"/members"});i.fetch({onComplete:function(){o.fetch({onComplete:function(n,r){if(c.isOnPremise())t.orgsCollection=i,t.peopleCollection=o,e.buildSkeleton();else{o.filterPrivateGroups(r,function(){t.orgsCollection=i,t.peopleCollection=o,e.buildSkeleton()},function(){e.errorAlert.inject(e.container),e.errorAlert.add({message:d.get("error.fetchMembers")})})}},onFailure:function(){e.errorAlert.inject(e.container),e.errorAlert.add({message:d.get("error.fetchMembers")})}})},onFailure:function(){e.errorAlert.inject(e.container),e.errorAlert.add({message:d.get("error.fetchOrganisations")})}})},onFailure:function(){e.errorAlert.inject(e.container),e.errorAlert.add({message:d.get("compassError")})}})},refresh:function(){this.orgsOpView&&this.orgsOpView.destroy(),this.successAlert&&this.successAlert.destroy(),this.errorAlert&&this.errorAlert.destroy(),this.orgsOpView=null,this.successAlert=null,this.errorAlert=null,this.load()},destroy:function(){this.container=null,this.orgsOpView&&this.orgsOpView.destroy(),this.successAlert&&this.successAlert.destroy(),this.errorAlert&&this.errorAlert.destroy(),this.orgsOpView=null,this.successAlert=null,this.errorAlert=null,this.removeEvents()},onAddUsersEnd:function(){this.refresh()}})});