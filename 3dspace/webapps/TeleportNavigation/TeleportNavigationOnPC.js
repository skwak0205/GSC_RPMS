define("DS/TeleportNavigation/TeleportNavigationOnPC",["UWA/Class","DS/VisuEvents/EventsManager","DS/Visualization/TrackballControls","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/TeleportNavigation/TeleportNavigationRunLoop","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/WebappsUtils/WebappsUtils","DS/SceneGraphNodes/BillBoardNode3D","DS/RuntimeView/NLSManager"],function(t,e,i,o,n,r,s,a,l,_,c){"use strict";var h="Release to Teleport",u=t.extend({init:function(){this._enabled=!1,this._prevDistanceToTarget=0,this._viewer=null,this._domElement=null,this._evtTokenMouse=[],this._evtTokenTouch=[],this._nlsHandle=null,this._downCursorPosition=null,this._cursorPosition=null,this._teleportTransitionPossible=!1,this._teleportTransitionActive=!1,this._forwardTransitionActive=!1,this._forwardTransitionWalkActive=!1,this._selectionTimer=null,this._teleportTimer=null,this._teleportPosition=null,this._teleportIconNode=null,this._teleportIconRectNode=null,this._teleportIconShown=!1,this._teleportIconOnTouch=!1,this._gravity=new o.Vector3(0,0,-1),this._groundHeight=0,this._currentHeight=0,this._animationLoopCB=null,this._bBox=null,this._bBoxRadius=0,this._viewerState={TrapSelectionState:!0,PrePickingActivation:!0,PreHighlightDisplay:!0}},setup:function(t){this._viewer=t.viewer,this._frameWindow=t.frameWindow,this._domElement=void 0!==this._viewer?this._viewer.canvas:document},enable:function(){this._enabled=!0,this._setNLSResources(),this._setGravity(),this._setBBox(),this._setMouseEventsMap(),this._setTouchEventsMap(),this._setPickingForNavigation(),this._viewer.currentViewpoint.onCenterCamera(this._onCenterCamera),this._prevDistanceToTarget=this._viewer.currentViewpoint.getTargetDistance(),this._viewer.currentViewpoint.setTargetDistance(3e3),this._animationLoopCB=new r,this._animationLoopCB.setup({subscriber:this,animationLoopCB:this._onAnimationLoop})},disable:function(){this._enabled&&(this._enabled=!1,this._destroyTeleportIcon(),this._unsetMouseEventsMap(),this._unsetTouchEventsMap(),this._unsetPickingForNavigation(),this._viewer.currentViewpoint.onCenterCamera(null),this._viewer.currentViewpoint.setTargetDistance(this._prevDistanceToTarget),this._animationLoopCB&&(this._animationLoopCB.stop(),this._animationLoopCB=null))},_setPickingForNavigation:function(){this._storeViewerState(),this._setViewerState()},_unsetPickingForNavigation:function(){this._unsetViewerState()},_storeViewerState:function(){this._viewerState.TrapSelectionState=this._viewer.picking.trapSelection,this._viewerState.PrePickingActivation=this._viewer.pPicking.activated,this._viewerState.PreHighlightDisplay=this._viewer.pPicking.displayHL},_setViewerState:function(){this._viewer.setPicking({trapSelection:!1}),this._viewer.setPrePicking({activated:!1,displayHL:!1})},_unsetViewerState:function(){this._viewer.setPicking({trapSelection:this._viewerState.TrapSelectionState}),this._viewer.setPrePicking({activated:this._viewerState.PrePickingActivation,displayHL:this._viewerState.PreHighlightDisplay})},_setNLSResources:function(){var t=this;c.DEFAULT_LANGUAGE=widget.lang?widget.lang:widget.getValue("lang"),c.loadResource({resourceFile:"TeleportNavigation/TeleportNavigationOnPC"}),c.onResourceLoaded({resourceFile:"TeleportNavigation/TeleportNavigationOnPC",language:widget.lang?widget.lang:widget.getValue("lang")},function(){t._nlsHandle=this,h=this.getKey({key:"TeleportNavigationOnPC.Text"})})},_setGravity:function(){var t=this._viewer.currentViewpoint.getWorldOrientation().upAttribute;this._gravity="y"===t?new o.Vector3(0,-1,0):new o.Vector3(0,0,-1)},_setBBox:function(){this._frameWindow.experience?this._bBox=this._frameWindow.experience.getRootBag().bBox:this._bBox=this._viewer.getRootNode().bBox;var t=this._bBox.max.x-this._bBox.min.x,e=this._bBox.max.y-this._bBox.min.y,i=this._bBox.max.z-this._bBox.min.z;this._bBoxRadius=Math.sqrt(t*t+e*e+i*i)},_getBbox:function(){return this._bBox||this._setBBox(),this._bBox},_isInsideBboxLimits:function(t){return this._bBox||(this._bBox=this._getBbox()),this._bBox.min.x<t.x&&t.x<this._bBox.max.x&&this._bBox.min.y<t.y&&t.y<this._bBox.max.y},_getBboxDistance:function(t){this._bBox||(this._bBox=this._getBbox());var e=new o.Vector3((this._bBox.max.x+this._bBox.min.x)/2,(this._bBox.max.y+this._bBox.min.y)/2,(this._bBox.max.z+this._bBox.min.z)/2),i=1,n=1;this._bBox.max.x<t.x?n=(t.x-this._bBox.max.x)/(t.x-e.x):t.x<this._bBox.min.x&&(n=(this._bBox.min.x-t.x)/(e.x-t.x));var r=1;this._bBox.max.y<t.y?r=(t.y-this._bBox.max.y)/(t.y-e.y):t.y<this._bBox.min.y&&(r=(this._bBox.min.y-t.y)/(e.y-t.y));var s=1;return this._bBox.max.z<t.z?s=(t.z-this._bBox.max.z)/(t.z-e.z):t.z<this._bBox.min.z&&(s=(this._bBox.min.z-t.z)/(e.z-t.z)),(i=n)<r&&(i=r),i<s&&(i=s),t.distanceTo(e)*i},_getBboxTarget:function(t){this._bBox||(this._bBox=this._getBbox());var e=null,i=this._gravity.clone().multiplyScalar(-1),n=new o.Plane(i,this._groundHeight);e=new o.Ray(t,i.clone()).intersectPlane(n);var r=new o.Vector3((this._bBox.max.x+this._bBox.min.x)/2,(this._bBox.max.y+this._bBox.min.y)/2,(this._bBox.max.z+this._bBox.min.z)/2),s=1,a=1;this._bBox.max.x<t.x?a=(t.x-this._bBox.max.x)/(t.x-r.x):t.x<this._bBox.min.x&&(a=(this._bBox.min.x-t.x)/(r.x-t.x));var l=1;return this._bBox.max.y<t.y?l=(t.y-this._bBox.max.y)/(t.y-r.y):t.y<this._bBox.min.y&&(l=(this._bBox.min.y-t.y)/(r.y-t.y)),(s=a)<l&&(s=l),e.x=e.x*s,e.y=e.y*s,e},_setMouseEventsMap:function(){var t=this,i=0;t._evtTokenMouse.push(e.addEvent(t._domElement,"onLeftMouseDown",function(e){i=1,t._onLeftMouseDown(e)})),t._evtTokenMouse.push(e.addEvent(t._domElement,"onLeftMouseUp",function(e){i=0,t._onLeftMouseUp(e)})),t._evtTokenMouse.push(e.addEvent(t._domElement,"onMouseMove",function(e){1===i&&t._onLeftMouseMove(e)}))},_setTouchEventsMap:function(){var t=this;t._evtTokenTouch.push(e.addEvent(t._domElement,"onTouch",function(i){e.getTouchEvents().length>1?t._onTouchUp(i):t._onTouchDown(i)})),t._evtTokenTouch.push(e.addEvent(t._domElement,"onRelease",function(e){t._onTouchUp(e)})),t._evtTokenTouch.push(e.addEvent(t._domElement,"onSwipe",function(e){t._onTouchMove(e)}))},_unsetMouseEventsMap:function(){this._evtTokenMouse&&(this._evtTokenMouse.forEach(function(t){e.removeEventFromToken(t)}),this._evtTokenMouse=void 0)},_unsetTouchEventsMap:function(){this._evtTokenTouch&&(this._evtTokenTouch.forEach(function(t){e.removeEventFromToken(t)}),this._evtTokenTouch=void 0)},_onLeftMouseDown:function(t){var e=this;null!==e._selectionTimer&&clearTimeout(e._selectionTimer),e._selectionTimer=null,null!==e._teleportTimer&&clearTimeout(e._teleportTimer),e._teleportTimer=null;var o=(t.from&&t.from.length?t.from[0]:null).getCurrentPosition(e._domElement);this._downCursorPosition=o.clone(),this._cursorPosition=o.clone(),this._teleportIconOnTouch=!1,this._teleportPosition=null;var n=e._viewer.currentViewpoint.control.getManipulationState();n!==i.State.FORCE_ZOOM&&n!==i.State.FORCE_PAN&&n!==i.State.FORCE_ROTATE&&(e._teleportTransitionPossible=!0),e._selectionTimer=setTimeout(function(){if(!0===e._teleportTransitionPossible){e._teleportTransitionActive=!0;var t=e._getTeleportPosition(o);e._showTeleportIcon(t),e._viewer.setCursor("Auto",0),e._teleportTimer=setTimeout(function(){null!==e._selectionTimer&&clearTimeout(e._selectionTimer),e._selectionTimer=null,null!==e._teleportTimer&&clearTimeout(e._teleportTimer),e._teleportTimer=null,e._teleportTransitionPossible=!1,e._teleportTransitionActive=!1,e._forwardTransitionActive=!0;var t=e._viewer.currentViewpoint.getEyePosition();e._isInsideBboxLimits(t)?e._forwardTransitionWalkActive=!0:e._forwardTransitionWalkActive=!1,e._hideTeleportIcon(),e._animationLoopCB&&e._animationLoopCB.start()},700)}},300)},_onTouchDown:function(t){var e=this;null!==e._selectionTimer&&clearTimeout(e._selectionTimer),e._selectionTimer=null,null!==e._teleportTimer&&clearTimeout(e._teleportTimer),e._teleportTimer=null;var o=(t.from&&t.from.length?t.from[0]:null).currentPosition;this._downCursorPosition=o.clone(),this._cursorPosition=o.clone(),this._teleportIconOnTouch=!0,this._teleportPosition=null;var n=e._viewer.currentViewpoint.control.getManipulationState();n!==i.State.FORCE_ZOOM&&n!==i.State.FORCE_PAN&&n!==i.State.FORCE_ROTATE&&(e._teleportTransitionPossible=!0),e._selectionTimer=setTimeout(function(){if(!0===e._teleportTransitionPossible){e._teleportTransitionActive=!0;var t=e._getTeleportPosition(o);e._showTeleportIcon(t),e._viewer.setCursor("Auto",0),e._teleportTimer=setTimeout(function(){null!==e._selectionTimer&&clearTimeout(e._selectionTimer),e._selectionTimer=null,null!==e._teleportTimer&&clearTimeout(e._teleportTimer),e._teleportTimer=null,e._teleportTransitionPossible=!1,e._teleportTransitionActive=!1,e._forwardTransitionActive=!0;var t=e._viewer.currentViewpoint.getEyePosition();e._isInsideBboxLimits(t)?e._forwardTransitionWalkActive=!0:e._forwardTransitionWalkActive=!1,e._hideTeleportIcon(),e._animationLoopCB&&e._animationLoopCB.start()},700)}},300)},_onLeftMouseUp:function(t){var e=(t.from&&t.from.length?t.from[0]:null).getCurrentPosition(this._domElement);this._cursorPosition=e.clone(),null!==this._selectionTimer&&clearTimeout(this._selectionTimer),this._selectionTimer=null,null!==this._teleportTimer&&clearTimeout(this._teleportTimer),this._teleportTimer=null,!0===this._teleportTransitionActive?(this._hideTeleportIcon(),this._teleport(this._teleportPosition)):!0===this._forwardTransitionActive&&this._animationLoopCB&&this._animationLoopCB.stop(),this._teleportTransitionPossible=!1,this._teleportTransitionActive=!1,this._forwardTransitionActive=!1},_onTouchUp:function(t){var e=(t.from&&t.from.length?t.from[0]:null).currentPosition;this._cursorPosition=e.clone(),null!==this._selectionTimer&&clearTimeout(this._selectionTimer),this._selectionTimer=null,null!==this._teleportTimer&&clearTimeout(this._teleportTimer),this._teleportTimer=null,!0===this._teleportTransitionActive?(this._hideTeleportIcon(),this._teleport(this._teleportPosition)):!0===this._forwardTransitionActive&&this._animationLoopCB&&this._animationLoopCB.stop(),this._teleportTransitionPossible=!1,this._teleportTransitionActive=!1,this._forwardTransitionActive=!1},_onLeftMouseMove:function(t){var e=(t.from&&t.from.length?t.from[0]:null).getCurrentPosition(this._domElement);this._cursorPosition=e.clone(),(this._downCursorPosition.x>e.x+10||this._downCursorPosition.x<e.x-10||this._downCursorPosition.y>e.y+10||this._downCursorPosition.y<e.y-10)&&(this._teleportTransitionPossible=!1,this._teleportTransitionActive=!1,this._forwardTransitionActive=!0,this._hideTeleportIcon())},_onTouchMove:function(t){var e=(t.from&&t.from.length?t.from[0]:null).currentPosition;this._cursorPosition=e.clone(),(this._downCursorPosition.x>e.x+10||this._downCursorPosition.x<e.x-10||this._downCursorPosition.y>e.y+10||this._downCursorPosition.y<e.y-10)&&(this._teleportTransitionPossible=!1,this._teleportTransitionActive=!1,this._forwardTransitionActive=!0,this._hideTeleportIcon())},_createTeleportIcon:function(){if(this._viewer&&!this._teleportIconNode){var t=null,e=o.ImageUtils.loadTexture(l.getWebappsAssetUrl("TeleportNavigation","images/TeleportOnModel.png"));if(e){var i=new o.MeshPhongMaterial({map:e,side:o.DoubleSide,alphaTest:.05,transparent:!0});i.force=!0;var n={width:46,height:46,fill:!0,fillColor:null,noEdge:!0,material:i};t=a.createRectangleNode(n),this._teleportIconRectNode=t;var r=(new o.Matrix4).makeTranslation(-23,0,0);t.setMatrix(r),t.setShadow(!0),t.setFrustumCulled(!1),t.exludeFromBounding(!0)}var c=null;(c=a.createTextNode({text:h,fontSize:14,color:new o.Color("yellow"),sdf:1})).setNoZ(!0),c.setMatrix((new o.Matrix4).makeTranslation(30,0,0)),c.setPickable(s.NOPICKABLE),c.name="text";var u=null;t&&c&&((u=a.createFixedSizeNode()).addChild(c),u.addChild(t));var p=null;if(u){var v={viewpoint:this._viewer.currentViewpoint,position:new o.Vector3,name:"Teleport 3D",type:"Spherical"};(p=new _(v)).setMatrix(new o.Matrix4),p.addChild(u)}this._teleportIconNode=p,this._viewer.getRootNode().addChild(this._teleportIconNode)}},_destroyTeleportIcon:function(){this._teleportIconNode&&this._viewer&&this._viewer.getRootNode().removeChild(this._teleportIconNode)},_computeModelIntersection:function(t){var e=null,i=this._viewer.pick(this._viewer.getMousePosition(t),"mesh",!0);return i.path.length>0&&(e=i.position.clone()),e},_computeGroundIntersection:function(t){var e=null,i=this._viewer.currentViewpoint.getEyePosition(),n=this._viewer.currentViewpoint.camera.getLookAt(),r=this._gravity.clone().multiplyScalar(-1),s=new o.Plane(r,this._groundHeight),a=new o.Vector3(this._viewer.getMousePosition(t).x,this._viewer.getMousePosition(t).y,.5);return(new o.Projector).unprojectVector(a,this._viewer.currentViewpoint.camera),(e=new o.Ray(i,a.clone().sub(i).normalize()).intersectPlane(s)).clone().sub(i).dot(n)<=0&&(e=null),e},_computeCursorDirection:function(t){var e=null,i=this._viewer.currentViewpoint.getEyePosition(),n=new o.Vector3(this._viewer.getMousePosition(t).x,this._viewer.getMousePosition(t).y,.5);return(new o.Projector).unprojectVector(n,this._viewer.currentViewpoint.camera),(e=n.clone().sub(i)).normalize(),e},_getTeleportPosition:function(t){var e=this._viewer.currentViewpoint.getEyePosition(),i=this._viewer.currentViewpoint.camera.getLookAt(),n=this._computeModelIntersection(t),r=this._computeGroundIntersection(t),s=this._computeCursorDirection(t),a=null,l=null;if(n&&r&&e.distanceTo(r)<e.distanceTo(n)&&(n=null),n){l=n;var _=n.clone().sub(e);_.sub(this._gravity.clone().multiplyScalar(_.clone().dot(this._gravity))),_.normalize(),_.setLength(1500),a=l.clone().sub(_);var c=e.dot(this._gravity.clone().multiplyScalar(-1)),h=this._groundHeight-a.dot(this._gravity.clone().multiplyScalar(-1)),u=c-a.dot(this._gravity.clone().multiplyScalar(-1));Math.abs(u)<2e3?a.add(this._gravity.clone().multiplyScalar(-u)):Math.abs(h)<1e3&&a.add(this._gravity.clone().multiplyScalar(-h-1800))}else if(r)a=(l=r).clone().sub(this._gravity.clone().multiplyScalar(1800));else if(s){l=e.clone().add(s.clone().multiplyScalar(5e3));var p=s.clone().sub(this._gravity.clone().multiplyScalar(s.clone().dot(this._gravity)));a=e.clone().add(p.clone().multiplyScalar(5e3))}if(this._teleportPosition=a,l){new o.Ray(e,s);var v=.9*(e.distanceTo(l)-this._viewer.currentViewpoint.camera.near/s.dot(i));l=l.clone().sub(s.clone().multiplyScalar(v))}return l},_showTeleportIcon:function(t){if(t){var e=t.clone();if(this._createTeleportIcon(),this._teleportIconNode&&e){var i=null;i=!1===this._teleportIconOnTouch?(new o.Matrix4).makeTranslation(-23,0,0):(new o.Matrix4).makeTranslation(-23,35,0),this._teleportIconRectNode.setMatrix(i);var n=new o.Matrix4;n.setPosition(e),this._teleportIconNode.setMatrix(n),this._teleportIconNode.setVisibility(!0),this._teleportIconNode.cbChange(),this._viewer.render(),this._teleportIconShown=!0}}},_hideTeleportIcon:function(){!1!==this._teleportIconShown&&this._teleportIconNode&&(this._teleportIconNode.setVisibility(!1),this._teleportIconNode.cbChange(),this._viewer.render(),this._teleportIconShown=!1)},_teleport:function(t){if(null!==t){this._viewer.currentViewpoint.getTargetDistance();var e=this._viewer.currentViewpoint.camera.getLookAt();this._viewer.currentViewpoint.getEyePosition();3e3;var i;i={eyePosition:t,sightDirection:e,distanceToTarget:3e3,duration:2e3,interpolationType:1},this._viewer.currentViewpoint.moveTo(i)}},_isTeleportRequired:function(){return!this._viewer.manipulatorManager||!this._viewer.manipulatorManager.isInManipulation()},_onAnimationLoop:function(){!0===this._forwardTransitionActive&&!0===this._isTeleportRequired()&&this._updatePositionForLinearAngularMove()},_getRotationSpeed:function(t){var e=Math.PI/180*.035;return e*=t},_getTranslationSpeed:function(){var t=this._bBoxRadius/1e4;t>1.5&&(t=1.5);var e=t,i=this._viewer.currentViewpoint.getEyePosition();this._isInsideBboxLimits(i)||(e+=this._getBboxDistance(i)/2e3);return e<t&&(e=t),e},_updatePositionForLinearAngularMove:function(){this._setGravity(),this._setBBox();this._viewer.currentViewpoint.getTargetDistance();var t=this._viewer.currentViewpoint.getUpDirection(),e=this._viewer.currentViewpoint.camera.getLookAt(),i=this._viewer.currentViewpoint.getEyePosition();var n=this._gravity.clone();n.multiplyScalar(-1);var r;r=this._getTranslationSpeed();var s,a;s=this._getRotationSpeed(this._viewer.getMousePosition(this._cursorPosition).x),a=this._getRotationSpeed(this._viewer.getMousePosition(this._cursorPosition).y);var l=e.clone(),_=200*r;!0===this._forwardTransitionWalkActive&&((c=new o.Vector3(0,0,0)).crossVectors(this._gravity,e),c&&c.length()>.1?l.crossVectors(c,this._gravity):l=null);l&&(l.setLength(_),i.add(l));var c,h=0,u=0;u=200*a,h=-(h=200*s),(c=new o.Vector3(0,0,0)).crossVectors(e,t);var p=n.angleTo(t),v=new o.Vector3(0,0,0);v.crossVectors(n,t),v.dot(c)<0&&(p=-p),p+u>Math.PI/2&&(u=Math.PI/2-p),p+u<-Math.PI/2&&(u=-Math.PI/2-p);var m=new o.Vector3(0,0,0);if(m.crossVectors(e,n),m&&m.length()>.1){var T=t.dot(m);m.setLength(T),m.multiplyScalar(-1),t.add(m),t.normalize()}c.applyAxisAngle(n,h),e.applyAxisAngle(n,h),0!==u&&e.applyAxisAngle(c,u),t.crossVectors(c,e);var d;d={upDirection:t,eyePosition:i,sightDirection:e,distanceToTarget:3e3,duration:200,interpolationType:1},this._viewer.currentViewpoint.moveTo(d)},_onCenterCamera:function(t){var e=this.camera.getLookAt(),i=this.getEyePosition(),o=t.clone().sub(i),r=o.dot(e),s=o.clone().sub(e.multiplyScalar(r)),a=i.clone().add(s);r=3e3;if(this._focusMode===n._FOCUS_MODE.TRANSLATION){var l;l={eyePosition:a,distanceToTarget:r,duration:2e3,interpolationType:1},this.moveTo(l)}}});return UWA.namespace("DS/TeleportNavigation/TeleportNavigationOnPC",u)});