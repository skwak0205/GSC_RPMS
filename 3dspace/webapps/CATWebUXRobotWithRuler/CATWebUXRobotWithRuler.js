/*!  Copyright 2020 Dassault Systemes. All rights reserved. */
define("DS/CATWebUXRobotWithRuler/CATWebUXRobotWithRuler",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Robot/FreeRobot","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager"],function(n,e,i,t,o,r,a){"use strict";var l=150,s=150,u=1;return n.extend({init:function(n){var c,g,p,d,b,f,v,M,y,V,x,h=n.frameWindow,w=h.getViewer(),m=n.lightDisplay,P=!1,R=!1;Object.defineProperty(this,"robotMatrixCompute",{set:function(n){"function"==typeof n&&(c=n)},get:void 0}),Object.defineProperty(this,"robotOrigin3DCompute",{set:function(n){"function"==typeof n&&(g=n)},get:void 0}),Object.defineProperty(this,"moveBegin",{set:function(n){"function"==typeof n&&(p=n)},get:void 0}),Object.defineProperty(this,"move",{set:function(n){"function"==typeof n&&(d=n)},get:void 0}),Object.defineProperty(this,"moveEnd",{set:function(n){"function"==typeof n&&(b=n)},get:void 0}),Object.defineProperty(this,"moveRobotBegin",{set:function(n){"function"==typeof n&&(f=n)},get:void 0}),Object.defineProperty(this,"moveRobot",{set:function(n){"function"==typeof n&&(v=n)},get:void 0}),Object.defineProperty(this,"moveRobotEnd",{set:function(n){"function"==typeof n&&(M=n)},get:void 0}),Object.defineProperty(this,"moveRulerOriginBegin",{set:function(n){"function"==typeof n&&(y=n)},get:void 0}),Object.defineProperty(this,"moveRulerOrigin",{set:function(n){"function"==typeof n&&(V=n)},get:void 0}),Object.defineProperty(this,"moveRulerOriginEnd",{set:function(n){"function"==typeof n&&(x=n)},get:void 0});var O=new i("",w,!1,!1);O.name="RobotWithRuler_"+u++,O.target={getWorldMatrix:function(){return O.getMatrix()}},O.setMoveMode("CALLBACK_ONLY"),O.scalingNodeX.setVisibility(!1),O.scalingNodeX.setVisibilityFree(!0),O.scalingNodeY.setVisibility(!1),O.scalingNodeY.setVisibilityFree(!0),O.scalingNodeZ.setVisibility(!1),O.scalingNodeZ.setVisibilityFree(!0),O.setVisibility(!1),w.addNode(O);var C,T,A,D,E,S,B,N,X,U,L,F,Y,k,Z=[],W=[],j=[],z={origin:new e.Vector3,initOrigin:new e.Vector3,direction:null,initValue:null,value:null,origin3D:null},G={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null},I=!1,H=function(){var n={x:new e.Vector3,y:new e.Vector3,z:new e.Vector3};function i(n,e){var i;return n.normalize(),n.x>.9995?i="x":n.y>.9995?i="y":n.z>.9995&&(i="z"),i?e+"|"+i:e}return function(e){e?(O.getMatrix().extractBasis(n.x,n.y,n.z),O.setLabels({labelX:i(n.x,"u"),labelY:i(n.y,"v"),labelZ:i(n.z,"w")})):O.setLabels()}}();function K(n){O.setPickable(n?o.PICKABLE:o.PICKTHROUGH)}function _(){A&&A.clear(),D&&D.clear()}function q(){A&&(A.direction=null,A.origin=null,A.origin3DPos=null,A.setValue(0)),D&&(D.direction=null,D.origin=null,D.originVector=null,D.setValue(0)),_()}function J(){O.setToNonGhostState()}function Q(){K(!1),N=A.displayOrigin,B=(A.origin3DPos||A.origin).clone(),y&&y()}function $(n){if(X=null,g){var e=g({event:n.event,viewer:w});X=e&&e.origin3D}return A.displayOrigin=N,X?(A.displayOrigin=!0,V&&V(),X.clone()):B}function nn(){K(!0),X&&(z.origin3D=X.clone()),x&&x()}function en(n){if("RulerManipulateBegin"===n.eventName||"AngularRulerManipulateBegin"===n.eventName)R=!0,U=new e.Vector3,L=0,T=O.getMatrix(),p&&p({robotMatrix:O.getMatrix(),from:"ruler",axis:(new e.Vector3).copy(n.direction),kind:"RulerManipulateBegin"===n.eventName?"translation":"rotation",event:n.event});else if("RulerManipulate"===n.eventName)H(),U.add(n.translationVector),O.setMatrix((new e.Matrix4).copy(T).setPosition((new e.Vector3).getPositionFromMatrix(T).add(U))),d&&d({robotMatrix:O.getMatrix(),translationVector:n.translationVector,from:"ruler",axis:(new e.Vector3).copy(n.direction),kind:"translation",event:n.event}),w.render();else if("AngularRulerManipulate"===n.eventName){H();var i=n.diffAngle*Math.PI/180;L+=i;var t=(new e.Matrix4).makeRotationAxis(n.direction,L).multiply((new e.Matrix4).extractRotation(T));O.setMatrix(t.setPosition((new e.Vector3).getPositionFromMatrix(T))),G.value=D.value,d&&d({robotMatrix:O.getMatrix(),rotationAngle:i,from:"ruler",axis:(new e.Vector3).copy(n.direction),kind:"rotation",event:n.event})}else"RulerManipulateEnd"!==n.eventName&&"AngularRulerManipulateEnd"!==n.eventName||(O.setRobotMatrix(O.getMatrix()),R=!1,b&&b({robotMatrix:O.getMatrix(),from:"ruler",axis:(new e.Vector3).copy(n.direction),kind:"RulerManipulateEnd"===n.eventName?"translation":"rotation",event:n.event}),H(!0),w.render())}function tn(n){var i,t;if(K(!1),R=!0,w.setCursor("pointer"),_(),i=n.manipulator,[O.arrowX,O.arrowY,O.arrowZ,O.translationPlaneYZ,O.translationPlaneXY,O.translationPlaneXZ,O.rotationArcYZ,O.rotationArcXZ,O.rotationArcXY].forEach(function(n){n&&n.manipulator&&n.manipulator!==i&&n.setToGhostState()}),O.robotHandle.setToGhostState(),"LineTranslationBegin"===n.eventChannel){t=(new e.Vector3).copy(n.manipulator.axis);var o=(new e.Vector3).getPositionFromMatrix(O.getMatrix()),a=(new e.Vector3).copy(t).multiplyScalar((new e.Vector3).copy(z.baseOrigin).sub(o).dot(t));z.initOrigin=(new e.Vector3).copy(o).add(a);var l=(new e.Vector3).copy(z.initOrigin);if(z.origin3D)l=new e.Line3(z.initOrigin,(new e.Vector3).copy(z.initOrigin).add(t)).closestPointToPoint(z.origin3D,!1);z.origin=l;var s=(new e.Vector3).copy(z.origin).sub(o).dot(t);z.direction=t,z.value=l.distanceTo(o)*(s>0?-1:1),z.initValue=z.value,A&&(A.origin=z.origin,A.origin3DPos=z.origin3D,A.initOrigin=z.initOrigin,A.setValue(z.value),A.direction=z.direction,A.initValue=z.initValue,A.displayOrigin=Boolean(z.origin3D),A.unit=r.getCurrentUnit("length").unit,A.display(),A.beginManipulation())}else if("RotationBegin"===n.eventChannel){if(t=(new e.Vector3).copy(n.manipulator.axis),!G.direction||0===Math.round(100*t.dot(G.direction))){var u=new e.Vector3,c=new e.Vector3,g=new e.Vector3;O.getMatrix().extractBasis(u,c,g),u.normalize(),c.normalize();var d=Math.round(100*u.dot(t)),b=Math.round(100*c.dot(t));0===d?G.originVector=(new e.Vector3).copy(u):0===b&&(G.originVector=(new e.Vector3).copy(c)),G.value=0,G.direction=t}G.origin=(new e.Vector3).getPositionFromMatrix(O.getMatrix()),G.initValue=G.value,D&&(D.originVector=G.originVector,D.setValue(G.value),D.origin=G.origin,D.direction=G.direction,D.initValue=G.initValue,D.unit=r.getCurrentUnit("angle").unit,D.display(),D.beginManipulation())}p&&p({robotMatrix:O.getMatrix(),from:"robot",axis:(new e.Vector3).copy(n.manipulator.axis),kind:"LineTranslationBegin"===n.eventChannel?"translation":"rotation",event:n.event})}function on(n){if(w.setCursor("pointer"),H(),"LineTranslationManipulation"===n.eventChannel)z.value=z.initValue+n.translationVector.length()*(z.direction.dot(n.translationVector)>0?1:-1),A&&A.setValue(z.value);else if("RotationManipulation"===n.eventChannel){var i=(new e.Vector3).copy(n.axis),t=G.direction.dot(i)<0?2*Math.PI-n.angle:n.angle;G.value=G.initValue+180*t/Math.PI,D&&D.setValue(G.value)}n.translationVector&&d?d({robotMatrix:O.getMatrix(),axis:(new e.Vector3).copy(n.manipulator.axis),translationVector:n.translationVector,from:"robot",kind:"translation",event:n.event}):n.angle&&d&&d({robotMatrix:O.getMatrix(),axis:(new e.Vector3).copy(n.axis),rotationAngle:n.angle,from:"robot",kind:"rotation",event:n.event}),w.render()}function rn(n){K(!0),J(),"LineTranslationEnd"===n.eventChannel?A&&(A.endManipulation(),A.display()):"RotationEnd"===n.eventChannel&&D&&(D.endManipulation(),D.display()),R=!1,b&&b({robotMatrix:O.getMatrix(),from:"robot",axis:(new e.Vector3).copy(n.manipulator.axis),kind:"LineTranslationEnd"===n.eventChannel?"translation":"rotation",event:n.event}),H(!0),w.render()}function an(){I||(I=!0,require(["DS/Ruler/Ruler","DS/Ruler/AngularRuler"],function(n,e){O&&((A=new n(h,{displayOrigin:!1,offset:l,mainGrad:100,nbSecondaryGrads:9,displayUnit:!0,lockedOrigin:!1,lightDisplay:m})).setVisibilityFree(!0),W.push(A.subscribe("OriginManipulateBegin",Q)),A.onOriginManipulator=$,W.push(A.subscribe("OriginManipulateEnd",nn)),W.push(A.subscribe("RulerManipulateBegin",function(n){en(n)})),W.push(A.subscribe("RulerManipulate",function(n){en(n)})),W.push(A.subscribe("RulerManipulateEnd",function(n){en(n)})),(D=new e(h,{radius:s,mainGrad:10,nbSecondaryGrads:4,displayUnit:!0,lightDisplay:m})).setVisibilityFree(!0),j.push(D.subscribe("AngularRulerManipulateBegin",function(n){en(n)})),j.push(D.subscribe("AngularRulerManipulate",function(n){en(n)})),j.push(D.subscribe("AngularRulerManipulateEnd",function(n){en(n)})))})),E||(E=a.givePreferenceManager({context:h}))&&(S=E.subscribe("onPreferencesChanged",function(){A&&A.getVisibleFlag()&&(A.unit=r.getCurrentUnit("length").unit,A.display()),D&&D.getVisibleFlag()&&(D.unit=r.getCurrentUnit("angle").unit,D.display())}))}function ln(n){f&&f({event:n.event}),w.setCursor("pointer"),R=!0,K(!1),O.arrowX.mat.opacity=.2,O.arrowY.mat.opacity=.2,O.arrowZ.mat.opacity=.2,O.translationPlaneYZ.planeMat.opacity=.2,O.translationPlaneXY.planeMat.opacity=.2,O.translationPlaneXZ.planeMat.opacity=.2,O.rotationArcYZ.planeMat.opacity=.2,O.rotationArcXZ.planeMat.opacity=.2,O.rotationArcXY.privilegedPlaneMat.opacity=.2,F=O.getMatrix(),k=new e.Plane(w.currentViewpoint.getSightDirection()),an()}O.snapTranslationCallback=function(n){var e=n.translationVector;if(A){var i=A.getSnappedTranslationVector(n);0===i.returnCode&&(e=i.snappedTranslationVector)}return e},O.snapRotationCallback=function(n){var e={value:180*n.angle/Math.PI,axis:n.axis};if(G.direction.dot(n.axis)<0&&(e.value=360-e.value),D){var i=D.getSnappedRotationValue(n);0===i.returnCode&&(e={value:i.snappedRotationAngle,axis:i.axis})}return e};var sn=!1;Z.push(O.subscribe("LineTranslationBegin",function(n){tn(n)})),Z.push(O.subscribe("RotationBegin",function(n){tn(n)})),Z.push(O.subscribe("ScalingBegin",function(n){tn(n)})),Z.push(O.subscribe("PlaneTranslationBegin",function(n){tn(n)})),Z.push(O.subscribe("LineTranslationManipulation",function(n){on(n)})),Z.push(O.subscribe("RotationManipulation",function(n){on(n)})),Z.push(O.subscribe("ScalingManipulation",function(n){on(n)})),Z.push(O.subscribe("PlaneTranslationManipulation",function(n){on(n)})),Z.push(O.subscribe("LineTranslationEnd",function(n){rn(n)})),Z.push(O.subscribe("RotationEnd",function(n){rn(n)})),Z.push(O.subscribe("ScalingEnd",function(n){rn(n)})),Z.push(O.subscribe("PlaneTranslationEnd",function(n){rn(n)})),Z.push(O.subscribe("ScreenPlaneTranslationBegin",function(n){ln(n)})),Z.push(O.subscribe("ScreenPlaneTranslationManipulation",function(n){!function(n){H(),_(),w.setCursor("pointer"),v&&v({event:n.event});var e=O.getMatrix().setPosition(n.intersection.ray.intersectPlane(k));if(c){var i=c({event:n.event,viewer:w});Y=i&&i.robotMatrix.clone()}O.setRobotMatrix(Y||e),w.render()}(n)})),Z.push(O.subscribe("ScreenPlaneTranslationEnd",function(n){!function(n){R=!1,K(!0),J(),_(),q(),O.setRobotMatrix(Y||F);var i=O.getMatrix(),t=(new e.Vector3).getPositionFromMatrix(i);z.origin=t,z.initOrigin=t.clone(),z.baseOrigin=t.clone(),M&&M({event:n.event}),H(!0),w.render()}(n)})),C=t.subscribe({event:"/VISU/"},function(n){P&&("@onViewpointBeginMove"===n.eventType?sn=!0:"@onViewpointChange"===n.eventType?sn&&(O.setVisibility(!1),w.render()):"@onViewpointEndMove"===n.eventType&&(O.setVisibility(!0),sn=!1,w.render()))}),this.setPosition=function(n){if(!R){if(!n||!n.robotMatrix&&!n.translationRulerOrigin)throw new Error("No valid positions defined!");var i,t;n.robotMatrix&&(i=n.robotMatrix.clone(),t=(new e.Vector3).getPositionFromMatrix(i),O.setRobotMatrix(i),z.origin=t,z.initOrigin=t.clone(),z.baseOrigin=t.clone(),A&&(A.initOrigin=z.initOrigin,A.origin=z.origin)),n.translationRulerOrigin?z.origin3D=n.translationRulerOrigin.clone():null===n.translationRulerOrigin&&(z.origin3D=null),an(),n.doNotResetRuler||q(),H(),w.render()}},this.setVisibility=function(n){if("boolean"!=typeof n)throw new Error("Argument must be a boolean");P=n,O.setVisibility(n),H(!0)},this.destroy=function(){Z.forEach(O.unsubscribe,O),Z=null,t.unsubscribe(C),C=null,E&&(S=E.unsubscribe(S)),E=S=null,w.removeNode(O),_(),A&&W.forEach(A.unsubscribe,A),D&&j.forEach(D.unsubscribe,D),O=h=w=null,A=D=null}}})});