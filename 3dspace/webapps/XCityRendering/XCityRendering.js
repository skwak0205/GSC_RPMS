define("DS/XCityRendering/RenderingHandler",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/xCityBasicUtils/Utils"],function(e,t,i,r,n){"use strict";return e.extend({init:function(e,t){this.urban=e,this._needRebuild=!1,this._prefix="3DXCity",this._allIds="AllIds",this._inputParam=r._JSONToRendering(t)},needsRebuild:function(){return this._needRebuild},flagAsRebuilt:function(e){this._needRebuild=!e},getIds:function(){var e=[];if(n.is(this._content)){var t;n.is(this._content._itemParent)&&(t=this._content._itemParent.get("id"),n.is(t)&&e.push(t)),t=this._content.get("id"),n.is(t)&&e.push(t);var i=this._content.get("renderID");n.is(i)&&""!==i&&e.push(i)}return n.is(this.type)&&e.push(this._prefix+this.type),n.is(this._allIds)&&e.push(this._allIds),e=n.removeDuplicateInArray(e)},setContent:function(e){this._content=e},shouldRebuild:function(){return!1},updatePresetValues:function(e){return e},getDependantAttributes:function(e){return[e]},isChangingCurrentMaterial:function(e,t){for(var i in e){e[i];if("color"===i){if(e[i].toUpperCase().toLowerCase()!==t[i].toLowerCase()&&e[i].rgbToHex()!==t[i].toLowerCase()&&e[i].hexToRgb()!==t[i].toLowerCase())return!0}else if(e[i]!==t[i])return!0}return!1},_getMaterial:function(e){n.is(e)||(e=this._initMaterial(),r._setMaterialFromProfile(e,this.defaultMaterial));var t=this._getMaterialInfo();return r._setMaterialFromProfile(e,t),r._setMaterialMapFromProfile(e,t,this),i.updateCommonUniforms(e),e},_getMaterialNoMap:function(e){n.is(e)||(e=this._initMaterial(),r._setMaterialFromProfile(e,this.defaultMaterial));var t=this._getMaterialInfo();return r._setMaterialFromProfile(e,t),e.mapUrl=null,e.map=null,i.updateCommonUniforms(e),e},setMaterialToMesh:function(e,t){e.mesh3js.material=t,e.setMaterial(t),this._lastSeenMaterial=t},dispose:function(){this._parent()},initMesh:function(e){if(n.is(e)){var t;t=this._getMaterial(),i.updateCommonUniforms(t),this.setMaterialToMesh(e,t)}},removeMesh:function(e){}})}),define("DS/XCityRendering/BuildingTdbAtlas",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityTools/ShaderTools","DS/XCityTools/Disposer","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/XCityTools/Downloader"],function(e,t,i,r,n,a,s){"use strict";var o=e.extend({init:function(e,t,i){this.urban=e,this.name=t,this.loaded=!1,this.onload=[],this.atlasTexture=void 0,this.atlasInfoTexture=void 0,this.atlasNormalTexture=void 0,this.atlasSpecularTexture=void 0,i?(this.useNormalMap=i.useNormalMap,this.useSpecularMap=i.useSpecularMap):(this.useNormalMap=this.urban.useNormalMap,this.useSpecularMap=this.urban.useSpecularMap),this.nbClone=0},updateMaterial:function(e){n.is(e)&&n.is(e.uniforms)&&(void 0!==this.atlasNormalTexture?(e.normalMap!==this.atlasNormalTexture&&(e.normalMap=this.atlasNormalTexture),this.urban.useNormalMap?e.uniforms.use_normalMap.value=1:e.uniforms.use_normalMap.value=0):e.uniforms.use_normalMap.value=0,void 0!==this.atlasSpecularTexture?(e.specularMap!==this.atlasSpecularTexture&&(e.specularMap=this.atlasSpecularTexture),this.urban.useSpecularMap?e.uniforms.use_specularMap.value=1:e.uniforms.use_specularMap.value=0):e.uniforms.use_specularMap.value=0,void 0===this.atlasSpecularTexture&&void 0===this.atlasNormalTexture||i.updateCommonUniforms(e))},setUniforms:function(e){void 0===this.atlasTexture||void 0===this.atlasInfoTexture?(e.uniforms.maps_atlas.value=o.whitetexture,e.uniforms.maps_atlas_info.value=o.whitetexture,this.onload.push(function(e){void 0!==e&&void 0!==e.uniforms&&(this.atlasTexture.shared++,this.atlasInfoTexture.shared++,e.uniforms.maps_atlas.value=this.atlasTexture,e.uniforms.maps_atlas_info.value=this.atlasInfoTexture,o.whitetexture.shared-=2,e.needsUpdate=!0)}.bind(this,e))):(this.atlasTexture.shared++,this.atlasInfoTexture.shared++,e.uniforms.maps_atlas.value=this.atlasTexture,e.uniforms.maps_atlas_info.value=this.atlasInfoTexture),void 0!==this.atlasSpecularTexture&&(this.atlasSpecularTexture.shared++,e.specularMap=this.atlasSpecularTexture,this.useSpecularMap&&(e.uniforms.use_specularMap.value=1)),void 0!==this.atlasNormalTexture&&(this.atlasNormalTexture.shared++,e.normalMap=this.atlasNormalTexture,this.useNormalMap&&(e.uniforms.use_normalMap.value=1)),i.updateCommonUniforms(e)},_defineTextureAs:function(e,t,i,n,a,s){void 0!==this[t]&&r.disposeV6(this[t]),this[t]=e,this[t].shared=-1,this[t].needsUpdate=!0,void 0!==s&&(this[t].flipY=s),void 0!==a&&(this[t].generateMipmaps=a),void 0!==n&&(this[t].minFilter=n,this[t].magFilter=n),void 0!==i&&(this[t].wrapS=i,this[t].wrapT=i)},loadAtlas:function(e,i){this._atlasBaseURL=e;var r=function(e){if(e){if(this.atlasTexture&&this.atlasInfoTexture){for(var t=this.onload.length;t--;)this.onload[t]();this.loaded=!0,i(this.loaded)}}else i(!1)}.bind(this);s.loadTexture(function(e,i){i&&this._defineTextureAs(e,"atlasTexture",t.ClampToEdgeWrapping),r(i)}.bind(this),e);var n=e.replace(".jpg","_info.png");s.loadTexture(function(e,i){i&&this._defineTextureAs(e,"atlasInfoTexture",t.ClampToEdgeWrapping,t.NearestFilter,!1,!1),r(i)}.bind(this),n),n=e.replace(".jpg","_sp.jpg"),s.loadTexture(function(e,i){i&&this._defineTextureAs(e,"atlasSpecularTexture",t.RepeatWrapping)}.bind(this),n),n=e.replace(".jpg","_nm.jpg"),s.loadTexture(function(e,i){i&&this._defineTextureAs(e,"atlasNormalTexture",t.RepeatWrapping)}.bind(this),n)},dispose:function(){a.warn("Dispose Atlas: "+this.name),this.loaded=!1,this.useNormalMap=!1,this.useSpecularMap=!1,this._atlasBaseURL=null,void 0!==this.atlasTexture&&(this.atlasTexture.shared=void 0,r.disposeV6(this.atlasTexture),this.atlasTexture=void 0),void 0!==this.atlasInfoTexture&&(this.atlasInfoTexture.shared=void 0,r.disposeV6(this.atlasInfoTexture),this.atlasInfoTexture=void 0),void 0!==this.atlasNormalTexture&&(this.atlasNormalTexture.shared=void 0,r.disposeV6(this.atlasNormalTexture),this.atlasNormalTexture=void 0),void 0!==this.atlasSpecularTexture&&(this.atlasSpecularTexture.shared=void 0,r.disposeV6(this.atlasSpecularTexture),this.atlasSpecularTexture=void 0)}});return o.whitetexture=new t.DataTexture(new Float32Array([1,1,1,1]),1,1,t.RGBAFormat,t.FloatType),o.whitetexture.flipY=!1,o.whitetexture.minFilter=t.LinearFilter,o.whitetexture.magFilter=t.LinearFilter,o.whitetexture.generateMipmaps=!1,o.whitetexture.needsUpdate=!0,o.whitetexture.shared=-1,o}),define("DS/XCityRendering/Rendering",["DS/XCityTools/RenderingTools","UWA/Class","DS/xCityBasicUtils/Utils"],function(e,t,i){"use strict";var r=t.extend({init:function(e){this.reset(),this.addOver(e)},hasData:function(){return Object.keys(this.renderingData).length>0},reset:function(){this.renderingData={}},_addOver:function(t,i){e._setMaterialFromProfile(t,i)},copy:function(e){this.reset(),this.addOver(e)},getRenderingData:function(){return this.renderingData},toJSON:function(){return e._RenderingToJSON(this.getRenderingData())},addOver:function(e){var t=e;e instanceof r&&(t=e.getRenderingData()),this._addOver(this.renderingData,t)},get:function(e){return i.getComposedProperty(this.renderingData,e)},set:function(e,t){this.renderingData[e]=t},remove:function(t){var i={};return i[t]=null,e._RemoveRendering(this.renderingData,i),this.isEmpty()},_addOverNoAdd:function(t,i){e._setMaterialFromProfileNoAdd(t,i)},addOverNoAdd:function(e){var t=e;e instanceof r&&(t=e.getRenderingData()),this._addOverNoAdd(this.renderingData,t)},isEmpty:function(){var e=this.getRenderingData();return Object.keys(e).length<1},isImpactingAttribute:function(e){var t=!1,r=this.get(e);return i.is(r)&&(t=!0),t},getDifferences:function(e){if(i.is(e)&&e instanceof r){var t=e.getRenderingData(),n=this.getRenderingData(),a=i.getDifferences(n,t);return i.is(a)&&(a=this._create(a)),a}},getSimilarity:function(e){var t;return i.is(e)&&e instanceof r&&(t=i.getSubsetOfBinA(this.renderingData,e.renderingData)),i.is(t)&&(t=this._create(t)),t},_create:function(e){return new r(e)},getImpactedAttributes:function(e){if(e||(e={}),this.renderingData)for(var t=Object.keys(this.renderingData),i=0;i<t.length;i++){e[t[i]]=!0}return e}});return r}),define("DS/XCityRendering/SLDParser",["DS/xCityBasicUtils/Utils","UWA/Class"],function(e,t){"use strict";return t.extend({init:function(){this.textnodename="#text",this.attributenodename="@attributes",this.VALID_SYMBOLIZERS=["LineSymbolizer","TextSymbolizer","PolygonSymbolizer","PointSymbolizer"],this.CONV_TYPE={LineSymbolizer:"line",PolygonSymbolizer:"fill",TextSymbolizer:"symbol",PointSymbolizer:"symbol"},this.VALID_ATTR_TAGS=["Stroke","Fill","Label","Font","Halo","Mark","Size","Geometry","Graphic"],this.CONVERT_ATTR_NAME={stroke:"stroke-color","stroke-width":"stroke-lineWidth","stroke-dasharray":"stroke-dashPattern","stroke-dashoffset":"stroke-dashOffset","stroke-linejoin":"stroke-lineJoin","stroke-linecap":"stroke-lineCap",opacity:"opacity",fill:"color","fill-opacity":"opacity","stroke-opacity":"stroke-opacity","LineSymbolizer-Stroke-stroke-dashoffset":"dashOffset","LineSymbolizer-Stroke-stroke-dasharray":"dashPattern","LineSymbolizer-Stroke-stroke-width":"lineWidth","LineSymbolizer-Stroke-stroke-linecap":"lineCap","LineSymbolizer-Stroke-stroke-linejoin":"lineJoin","LineSymbolizer-Stroke-stroke":"color","LineSymbolizer-Stroke-stroke-opacity":"opacity","PolygonSymbolizer-Fill-fill":"color","PolygonSymbolizer-Fill-fill-opacity":"opacity","PolygonSymbolizer-Fill-opacity":"opacity","font-size":"text-size","font-family":"text-font","font-style":"text-style","font-weight":"text-weight",Label:"text-field","TextSymbolizer-Halo-Fill-fill":"text-halo-color","TextSymbolizer-Fill-fill":"text-color","TextSymbolizer-Font-font-family":"font-family"},this.DIFF_ATTR_TAG=["Label","Halo","Mark","Geometry","Graphic"],this.DIFF_ATTR=["stroke","opacity","fill","fill-opacity","font-size","stroke-width"],this.LABEL_DICT={"background-color":"transparent",border:"medium none color","border-bottom":"medium none color","border-left":"medium none color","border-radius":"0","border-right":"medium none color","border-top":"medium none color",color:"rgb(61, 61, 61)","font-family":"font-family","font-size":"font-size","font-style":"font-style","font-weight":"font-weight","letter-spacing":"normal","line-height":"normal",opacity:"1",padding:"0","text-align":"left","text-decoration":"none currentcolor solid","text-shadow":"none","word-spacing":"normal"}},parseSLD:function(t,i){var r=null;if(e.is(i)&&(this.currentUrl=i),e.is(t)){var n=e.parseXML(t);e.is(n)&&(r=e.xmlToJson(n),r=this.jsonToProfile(r))}return e.is(this.currentUrl)&&(this.currentUrl=null),r},_getfirstchild:function(t){if(e.is(t)){var i,r,n=Object.keys(t),a=n.length;for(i=0;i<a;i++)if((r=n[i])!==this.textnodename&&r!==this.attributenodename)return r}},_readLeaf:function(e,t){return{name:{localPart:t},value:{content:[e[0][this.textnodename]]}}},addToExpression:function(t,i){e.is(t.expression)?Array.isArray(t.expression)?t.expression.push(i):t.expression=[t.expression,i]:t.expression=i},_readFilter:function(e){if(e){var t,i,r,n,a,s,o=Object.keys(e),l=o.length,d={};for(t=0;t<l;t++)switch(r=e[i=o[t]],i){case this.textnodename:case"prefix":break;case"PropertyName":case"Literal":n=this._readLeaf(r,i),this.addToExpression(d,n);break;default:if(Array.isArray(r))for(s=r.length,a=0;a<s;a++){var u=r[a];n={name:{localPart:i},value:this._readFilter(u)},this.isAvailableFunction(i)&&(n={Function:n}),this.addToExpression(d,n)}}return d}},isAvailableFunction:function(e){return["And","Or","Add","Sub","Mul","Div","PropertyIsEqualTo","PropertyIsNotEqualTo","PropertyIsLessThan","PropertyIsLessThanOrEqualTo","PropertyIsGreaterThan","PropertyIsGreaterThanOrEqualTo","PropertyIsBetween"].indexOf(e)>=0},ogctoprofilefilter:function(e){if(!e)return null;this._getfirstchild(e);return this._readFilter(e)},jsonToProfile:function(t){var i,r,n,a,s=t.StyledLayerDescriptor[0].NamedLayer[0].UserStyle[0].FeatureTypeStyle[0],o=t.StyledLayerDescriptor[0].NamedLayer[0].Name[0][this.textnodename],l=[],d=s.Rule;for(e.is(s.Title)&&(n=s.Title[0]),i=0;i<d.length;i++)l.push(d[i]);var u={};for(a=0;a<l.length;a++)i=l[a],r=e.is(i.Name)?i.Name[0][this.textnodename]:"",u[r=this._findnewname(r,u)]=this.jsonToRendering(i,o,n);return u},_findnewname:function(t,i){for(var r=t;e.is(i[r]);)r+=".0";return r},jsonToRendering:function(t,i,r){var n,a,s,o,l=Object.keys(t);(a=t.Filter)&&(a=this.ogctoprofilefilter(a[0]));var d,u,f=!1;if(e.is(a)||void 0===a){for(l.indexOf("PolygonSymbolizer")>=0&&(f=!0),n=0;n<l.length;n++)this.VALID_SYMBOLIZERS.indexOf(l[n])>-1&&(e.is(t.TextSymbolizer)?(s=this.readTextSymbolizer(t.TextSymbolizer),o=this.readTextDataViz(t.TextSymbolizer)):f&&"LineSymbolizer"===l[n]?u=this.readSymbolizer(t[l[n]],l[n],void 0,void 0,void 0,a,i):s=this.readSymbolizer(t[l[n]],l[n],void 0,void 0,void 0,a,i));if(e.is(s)){if(e.is(u)&&(s.stroke=u,s.stroke.enable=!0),d={},e.is(t.Title)&&(s.renderingDescription=t.Title[0][this.textnodename]),e.is(t.Description)){var h=t.Description[0];e.is(h)&&e.is(h.Title)&&(s.renderingDescription=h.Title[0][this.textnodename])}e.is(a)?(d.ElementMaterial=s,d.Filter=a):(e.is(s.renderingDescription)||(s.renderingDescription=r),d.Material=s),e.is(o)&&(e.is(d.ElementRendering)||(d.ElementRendering=[]),d.ElementRendering.push(o))}else console.log("no symbolizer found")}return d},readSymbolizer:function(e,t,i,r,n,a,s){var o;this.convertType(t);try{o=this.getSymbolizersObj(e,t)}catch(e){console.error(e.stack)}return o},convertType:function(e){try{return this.CONV_TYPE[e]}catch(t){console.error("could not convert the type: "+e)}},getSymbolizersObj:function(e,t,i){var r,n,a,s={},o=Object.keys(e),l=o.length;for(n=0;n<l;n++){var d=e[o[n]],u=Object.keys(d),f=u.length;for(r=0;r<f;r++){var h=u[r];if(this.VALID_ATTR_TAGS.indexOf(h)>-1)if(this.DIFF_ATTR_TAG.indexOf(h)>-1||"Fill"===h&&void 0!==d.Fill[0].GraphicFill){var g,c=this.getObjFromDiffAttr(h,t,d,i),p=Object.keys(c),_=p.length;for(a=0;a<_;a++)s[g=p[a]]=c[g]}else{var m=this.getCssParameters(d,h,t);s=this.addProfileRenderingFromCssParams(m,s)}}}return s},addProfileRenderingFromCssParams:function(t,i){var r;for(r=0;r<t.length;r++){var n=t[r][0];if(this.isMultiLevelAttribute(n))this.addMultiLevelAttribute(t[r],i);else{var a=t[r][1];e.is(i[n])?console.log("overwrite symbolizer param "+n+" forbidden"):i[n]=a}}return i},isMultiLevelAttribute:function(e){return e.indexOf("-")>-1},addMultiLevelAttribute:function(t,i){var r,n=t[0],a=t[1],s=n.split("-"),o=i,l=s.length,d=l-1;for(r=0;r<l;r++){var u=s[r];r===d?o[u]=a:(e.is(o[u])||(o[u]={},"stroke"===u&&(o[u].enable=!0)),o=o[u])}return i},getCssParameters:function(t,i,r,n){var a,s=[];if(void 0===n?e.is(t[i])&&(a=t[i][0].CssParameter,e.is(a)||(a=t[i][0].SvgParameter)):e.is(t[n])&&e.is(t[n][0][i])&&(a=t[n][0][i][0].CssParameter,e.is(a)||(a=t[n][0][i][0].SvgParameter)),e.is(a)){var o,l=Object.keys(a),d=l.length;for(o=0;o<d;o++){var u=a[l[o]],f=this.convert_css_parameter(u,i,r,n);e.is(f)&&s.push(f)}}return s},convert_css_parameter:function(t,i,r,n){if(e.is(t[this.attributenodename])){var a,s=t[this.attributenodename].name,o=/^\d+$/,l=/^[0-9]+([\,\.][0-9]+)?$/g,d=t[this.textnodename];try{var u=d.split("#")[1];a=!(this.DIFF_ATTR.indexOf(s)>-1)||o.test(d)||l.test(d)||/^[a-zA-Z]+$/.test(u)||/^\d+$/.test(u)||/^([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(u)?d:t.Function[0].Literal[1]}catch(e){a=this.DIFF_ATTR.indexOf(s)>-1&&!o.test(d)&&!l.test(d)?t.Function[0].Literal[1]:d}return[this.convertCssName(s,i,r,n),this.convertCssValue(a,s)]}return null},convertCssName:function(e,t,i,r){var n;void 0===(n=void 0===r?this.CONVERT_ATTR_NAME[i+"-"+t+"-"+e]:this.CONVERT_ATTR_NAME[i+"-"+r+"-"+t+"-"+e])&&(n=this.CONVERT_ATTR_NAME[e]);return void 0===n&&["font-weight","font-style"].indexOf(n)>-1&&console.log("could not convert the attribute name: "+e),void 0===n&&console.log("could not convert the attribute name: "+i+"-"+r+"-"+t+"-"+e),n},getObjFromDiffAttr:function(e,t,i,r){var n={};return"Label"===e?n=this.getLabelObj(e,t,i,n):"Fill"===e?n=this.readFillTag(e,t,i,n):"Graphic"===e&&(n=this.getGraphicObj(r,i,t,n)),n},readFillTag:function(t,i,r,n){if(e.is(r)&&e.is(r.Fill)){var a=r.Fill[0].GraphicFill;e.is(a)&&this.getMapUrl(a[0],n)}return n},getLabelObj:function(t,i,r,n){var a=this.convertCssName(t,t,i);return e.is(r.Label[0]["ogc:PropertyName"])?n[a]="{"+r.Label[0]["ogc:PropertyName"][0]+"}":n[a]="{"+r.Label[0].PropertyName[0]["#text"]+"}",n},convertCssValue:function(e,t){return e=e.trim(),"stroke"===t||"stroke-linejoin"===t||"stroke-linecap"===t?"#"+e.split("#")[e.split("#").length-1]:"stroke-width"===t||"stroke-opacity"===t||"stroke--dashoffset"===t?parseFloat(e):"stroke-dasharray"===t?e.split(" ").map(Number):"fill"===t?"#"+e.split("#")[e.split("#").length-1]:"opacity"===t||"fill-opacity"===t?parseFloat(e):"font-size"===t?parseFloat(e):e},getCurrentFolder:function(){if(e.is(this.currentUrl)){var t=this.currentUrl.split("?")[0],i=e.removeUrlEnd(t,"/");return e.endsWith(t,".sld")||(i+="/resources"),i}return null},getCurrentOptions:function(){return e.is(this.currentUrl)?this.currentUrl.split("?")[1]:null},isURLRelative:function(e){return!(e.split("://").length>1)&&"/"!==e[0]},getMapUrl:function(t,i){if(e.is(t)&&e.is(t.Graphic)){var r=t.Graphic[0].ExternalGraphic;if(e.is(r)){var n=r[0].OnlineResource[0][this.attributenodename]["xlink:href"];if(this.isURLRelative(n)){var a=this.getCurrentFolder();e.is(a)&&(n=a+"/"+n);var s=this.getCurrentOptions();e.is(s)&&(n=n+"?"+s)}i.mapUrl=n}}},initOffsetFunction:function(e){e.offsetFunction={ratio:{x:.5,y:.5,z:.5},pixel:{x:0,y:0,z:0},bbox:{x:0,y:0,z:0}}},readAnchorPoint:function(t,i){var r=t.AnchorPoint;if(e.is(r)){var n=r[0].AnchorPointX;e.is(i.offsetFunction)||this.initOffsetFunction(i),e.is(n)&&(i.offsetFunction.ratio.x=-n[0][this.textnodename]);var a=r[0].AnchorPointY;e.is(a)&&(i.offsetFunction.ratio.y=1-a[0][this.textnodename])}},readDisplacement:function(t,i){var r=t.Displacement;if(e.is(r)){e.is(i.offsetFunction)||this.initOffsetFunction(i);var n=r[0].DisplacementX;e.is(n)&&(i.offsetFunction.pixel.x=n[0][this.textnodename]);var a=r[0].DisplacementY;e.is(a)&&(i.offsetFunction.pixel.y=a[0][this.textnodename])}},getGraphicObj:function(t,i,r,n){try{var a=i.Graphic[0].Mark;if(e.is(a)){var s=this.getCssParameters(a[0],"Fill",r),o=this.getCssParameters(a[0],"Stroke",r);n=this.addProfileRenderingFromCssParams(s,n),n=this.addProfileRenderingFromCssParams(o,n)}else this.getMapUrl(i,n);this.readAnchorPoint(i.Graphic[0],n),this.readDisplacement(i.Graphic[0],n)}catch(e){console.log("Could not set fill color for graphic tag in file: "+t)}try{var l=i.Graphic[0].Size[0][this.textnodename];n["icon-size"]=parseInt(l,10)}catch(e){console.log("Size does not exist in this graphic-tag")}if(!e.is(n["icon-image"])){var d=this.getIconImage(t);n["icon-image"]=void 0!==d?d:"circle-12"}return n},getIconImage:function(e){},readTextSymbolizer:function(t){var i,r,n,a,s={};if(s.label={},e.is(t[0].Label)&&(s.label.enable=!0,s.label.style={},s.label.position={}),e.is(t[0].Font)&&e.is(t[0].Font[0].CssParameter))for(a=t[0].Font[0].CssParameter,i=0;i<a.length;i++)r=a[i][this.attributenodename].name,n=a[i][this.textnodename],s.label.style[r]=n,"font-size"===r&&(s.label.style[r]=s.label.style[r]+"px");if(e.is(t[0].Fill)&&e.is(t[0].Fill[0].CssParameter))for(a=t[0].Fill[0].CssParameter,i=0;i<a.length;i++)r=a[i][this.attributenodename].name,n=a[i][this.textnodename],s.label.style.color=n;if(e.is(t[0].LabelPlacement)&&e.is(t[0].LabelPlacement[0].PointPlacement)&&e.is(t[0].LabelPlacement[0].PointPlacement[0].Displacement)){var o=t[0].LabelPlacement[0].PointPlacement[0].Displacement;s.label.position.offset={},e.is(o[0].DisplacementX)&&(s.label.position.offset.x=parseInt(o[0].DisplacementX[0][this.textnodename])),e.is(o[0].DisplacementY)&&(s.label.position.offset.y=parseInt(o[0].DisplacementY[0][this.textnodename]))}return e.is(t[0].LabelPlacement)&&e.is(t[0].LabelPlacement[0].PointPlacement)&&e.is(t[0].LabelPlacement[0].PointPlacement[0].Rotation)&&(s.label.position.rotation={x:t[0].LabelPlacement[0].PointPlacement[0].Rotation[0][this.textnodename]}),s},readTextDataViz:function(t){var i;return e.is(t[0].Label)&&e.is(t[0].Label[0].PropertyName)&&e.is(t[0].Label[0].PropertyName[0][this.textnodename])&&(i={DatavizMaterial:{label:{name:{PropertyName:t[0].Label[0].PropertyName[0][this.textnodename]}}}}),e.is(t[0].LabelPlacement)&&e.is(t[0].LabelPlacement[0].PointPlacement)&&e.is(t[0].LabelPlacement[0].PointPlacement[0].Rotation)&&e.is(t[0].LabelPlacement[0].PointPlacement[0].Rotation[0].PropertyName)&&e.is(t[0].LabelPlacement[0].PointPlacement[0].Rotation[0].PropertyName[0][this.textnodename])&&e.is(i)&&e.is(i.DatavizMaterial)&&(i.DatavizMaterial.label.position={rotation:{PropertyName:t[0].LabelPlacement[0].PointPlacement[0].Rotation[0].PropertyName[0][this.textnodename]}}),i}})}),define("DS/XCityRendering/DatavizRendering",["DS/XCityTools/RenderingTools","DS/xCityBasicUtils/Utils","DS/XCityRendering/Rendering","DS/XCityTools/OGCFilter","DS/XCityTools/OGCFilterPrimitive","DS/XCityTools/Expression","DS/XCityTools/ExpressionEvaluator"],function(RenderingTools,Utils,Rendering,OGCFilter,OGCFilterPrimitive,Expression,ExpressionEvaluator){"use strict";var DatavizRendering=Rendering.extend({init:function(e,t,i){this._id=void 0,e instanceof DatavizRendering&&(t=e.filter,i=e.exprData,this._id=e._id,e=e.renderingData),this._parent(e),this._initFilter(t),this._initExpressions(i)},reset:function(){this.filter=null,this._context=null,this._parent()},resetRenderingDataOnly:function(){this.renderingData={}},_initFilter:function(e){Utils.is(e)&&(this.filter=new OGCFilter(e))},_initExpressions:function(e){Utils.is(e)&&(this.exprData=Object.assign({},RenderingTools._RenderingToJSONExpression(e)))},checkFilter:function(){if(!Utils.is(this.filter))return!0;var e=!0;if(Utils.is(this._context)){var t=this.getEvaluator();t.setContext(this._context),t.setExpression(this.filter),e=t.apply(),t.unsetContext()}return e},setContext:function(e){this._context=e},hasInterpretedData:function(){return!!(Utils.is(this.exprData)&&Object.keys(this.exprData).length>0)},getRenderingData:function(){var e={};if(this.checkFilter()){var t=this._parent();if(this._addOver(e,t),this.hasInterpretedData()){var i=this.getInterpretedData();this._addOver(e,i)}}return e},getInterpretedData:function(){var e={};if(this.hasInterpretedData()&&Utils.is(this._context)){var t=this.getEvaluator();t.setContext(this._context),e=RenderingTools._ExpressionToEval(this.exprData,t),t.unsetContext(),e=RenderingTools._JSONToRendering(e)}return e},getEvaluator:function(){return Utils.is(this.evaluator)||(this.evaluator=new ExpressionEvaluator),this.evaluator},getFilterRendering:function(){var e=null;if(this.isFilterRendering()){var t=this.toJSON();(e={}).filter=this.filter,e.rendering=t.ElementMaterial}return e},getMappingRendering:function(){var e=null;this.isMappingRendering()&&(e=this.toJSON().DatavizMaterial);return e},isMappingRendering:function(){return Utils.is(this.exprData)},isFilterRendering:function(){return Utils.is(this.filter)},setAll:function(e,t,i){this.reset(),this.addOver(e),this._initFilter(t),this._initExpressions(i)},convertToJSON:function(e,t){var i,r,n,a,s=Object.keys(e),o=s.length;for(i=0;i<o;i++)a=e[r=s[i]],Utils.is(a)&&(Utils.is(n)||(n={}),n[r]=!1===t?Utils.is(a.expr)?a.clone():this.convertToJSON(a,t):Utils.is(a.expr)?a.toJSON():this.convertToJSON(a,t));return n},toJSON:function(e){var t,i=this._parent();if(Utils.is(i)&&Object.keys(i).length>0&&(Utils.is(t)||(t={}),t.ElementMaterial=i),this.isFilterRendering()&&(Utils.is(t)||(t={}),t.Filter=!1===e?this.filter.clone():this.filter.toJSON()),this.isMappingRendering()){var r=this.convertToJSON(this.exprData,e);Utils.is(r)&&(Utils.is(t)||(t={}),t.DatavizMaterial=r)}return t},isImpactingAttribute:function(e){var t=this.get(e);return!!Utils.is(t)||!(!this.isMappingRendering()||!Utils.is(Utils.getComposedProperty(this.exprData,e)))},isEmpty:function(){var e=this.getRenderingData();if(Object.keys(e).length<1){if(!this.isMappingRendering())return!0;if(Object.keys(this.exprData).length<1)return!0}return!1},remove:function(e){return Utils.is(this.exprData)&&delete this.exprData[e],this._parent(e)},getId:function(){return this._id},addOverIds:function(e){this._id=e},getSimilarity:function(e){var t,i;if(Utils.is(e)){i=this._parent(e);var r=Utils.getSubsetOfBinA(this.exprData,e.exprData);(Utils.is(i)||Utils.is(r))&&(t=new DatavizRendering(i,this._filter,r))}return t},_create:function(e){return new DatavizRendering(e)},_interpretMappings:function(contexts,defaultValues){var i=0,j=0,results=[],evaluator=this.getEvaluator(),res=[],keys=Object.keys(this.exprData);for(i=0;i<keys.length;i++){var key=keys[i],expr=this.exprData[key];if(expr.stringForm||(evaluator.setExpression(expr),evaluator.evalString(contexts[0])),expr.usedAttributes){var allattributesdefined=!0,keys2=Object.keys(expr.usedAttributes);for(j=0;j<keys2.length;j++){var key2=keys2[j],value=contexts[0][key2];if(void 0===value){allattributesdefined=!1;break}}if(!allattributesdefined)continue;var XCITYcurrentVariables=expr.usedVariables;for(j=0;j<contexts.length;j++){var XCITYcurrentContent=contexts[j];res[j]||(res[j]={}),res[j][key]=eval(expr.stringForm)||defaultValues[key]}}}for(i=0;i<res.length;i++)results.push(RenderingTools._JSONToRendering(res[i]));return results},getImpactedAttributes:function(e){if(e=this._parent(e),this.exprData)for(var t=Object.keys(this.exprData),i=0;i<t.length;i++){e[t[i]]=!0}return e}});return DatavizRendering}),define("DS/XCityRendering/PrimitiveRendering",["DS/xCityBasicUtils/Utils","DS/XCityRendering/Rendering"],function(e,t){"use strict";var i=t.extend({init:function(e){var t=!1;e instanceof i&&(t=e,e=e.getRenderingData()),this._parent(e),t&&(this.primitiveIds=t.primitiveIds.concat())},reset:function(){this.primitiveIds=[],this._parent()},resetRenderingDataOnly:function(){this.renderingData={}},addOver:function(t){var r,n;e.is(t)&&(t instanceof i?(r=t.getIds(),n=t):(r=t.ElementIds,n=t.ElementMaterial?t.ElementMaterial:t),this.addOverIds(r),this._parent(n))},isIdIncluded:function(e){var t,i=this.primitiveIds.length;for(t=0;t<i;t++)if(this.primitiveIds[t]===e)return!0;return!1},getIds:function(){return this.primitiveIds},addOverIds:function(t){if(e.is(t)){"string"==typeof t&&(t=[t]);var i,r,n=t.length;for(i=0;i<n;i++)r=t[i],this.isIdIncluded(r)||this.primitiveIds.push(r)}},toJSON:function(){var t,i=this._parent();return e.is(i)&&((t={ElementIds:this.getIds()}).ElementMaterial=i),t},getId:function(){return this.primitiveIds[0]},_create:function(e){return new i(e)}});return i}),define("DS/XCityRendering/FeatureRendering",["DS/XCityRendering/Rendering","DS/XCityRendering/PrimitiveRendering","DS/XCityRendering/DatavizRendering","DS/xCityBasicUtils/Utils"],function(e,t,i,r){"use strict";var n=e.extend({init:function(e){this._parent(e)},reset:function(){this._parent(),this.primitiveRenderings={length:0},this.datavizRenderings={length:0}},addOver:function(e){if(r.is(e))if(e instanceof n){var a=e.getRenderingData();this._parent(a),this.addPrimitives(e.getPrimitiveRenderings()),this.addRenderings(e.getDatavizRenderings())}else e instanceof i?this.addDatavizOver(e):e instanceof t?this.addPrimitiveOver(e):(e.ElementRendering&&this.addRenderings(e.ElementRendering),e.Material?this._parent(e.Material):this._parent(e))},hasFilterDataviz:function(){var e=!1;if(r.is(this.datavizRenderings)){var t,i,n=this.getDatavizIds(),a=n.length;for(t=0;t<a&&(i=n[t],!(e=this.datavizRenderings[i].isFilterRendering()));t++);}return e},hasFeatureRendering:function(){return this.hasData()},hasPrimitiveRendering:function(){return this.primitiveRenderings.length>0},getPrimitiveRenderings:function(){return this.primitiveRenderings},hasDatavizRendering:function(){return this.datavizRenderings.length>0},getDatavizRenderings:function(){return this.datavizRenderings},addRenderings:function(e){if(r.is(e)){var n,a,s,o=Object.keys(e),l=o.length;for(n=0;n<l;n++)"length"!==(s=o[n])&&(a=e[s],r.is(a)&&(a instanceof i?this.addDatavizOver(a):a instanceof t?this.addPrimitiveOver(a):r.is(a.DatavizMaterial)?this.addDatavizOver(a):r.is(a.ElementMaterial)?this.addPrimitiveOver(a):console.error(" unknown data format for renderingformat ")))}},addPrimitives:function(e){if(r.is(e)){var t,i,n=Object.keys(e),a=n.length;for(t=0;t<a;t++)"length"!==(i=n[t])&&this.addPrimitiveOver(e[i])}},addPrimitiveOver:function(e){if(r.is(e)){if(!(e instanceof t)){if(!e.ElementMaterial)return void console.error("cannot initialize primitive rendering");e=new t(e)}var i=e.getId();r.is(this.primitiveRenderings[i])?this.primitiveRenderings[i].addOver(e):(this.primitiveRenderings[i]=new t(e),this.primitiveRenderings.length++)}},addDatavizOver:function(e){if(r.is(e)){if(!(e instanceof i)){if(!e.DatavizMaterial)return void console.error("cannot initialize dataviz rendering ");(e=new i(e)).addOverIds("3DXCityDefaultID")}this._mappingsMerge=null;var t=e.getId();r.is(this.datavizRenderings[t])?this.datavizRenderings[t].addOver(e):(this.datavizRenderings[t]=new i(e),this.datavizRenderings.length++)}},getDatavizRendering:function(e){var i,r,n=this.datavizRenderings.length,a=new t;a.addOverIds(e);var s=this.getDatavizIds();for(i=0;i<n;i++)r=this.datavizRenderings[s[i]],a.addOver(r.getRenderingData());return a},getPrimitiveRendering:function(e,i){var n,a;this.primitiveRenderings.length;n=new t,r.is(i)&&(this.setContext(i),a=this.getDatavizRendering(e),this.unsetContext(),r.is(a)&&n.addOver(a));var s=this.primitiveRenderings[e];return r.is(s)&&n.addOver(s),n},setContext:function(e){if(r.is(this.datavizRenderings)){var t,i=this.datavizRenderings.length,n=this.getDatavizIds();for(t=0;t<i;t++)this.datavizRenderings[n[t]].setContext(e)}},unsetContext:function(){if(r.is(this.datavizRenderings)){var e,t=this.datavizRenderings.length,i=this.getDatavizIds();for(e=0;e<t;e++)this.datavizRenderings[i[e]].setContext(null)}},getCompleteMaterialInfo:function(t,i){var r=this.getRenderingData(),n=this.getPrimitiveRendering(t,i),a=new e;return a.addOver(r),a.addOver(n),a.getRenderingData()},getDatavizIds:function(){var e,t=(e=Object.keys(this.datavizRenderings)).indexOf("length");return t>=0&&e.splice(t,1),e},hasDatavizOnAttribute:function(e){var t=!1;if(r.is(this.datavizRenderings)){var i,n,a=this.getDatavizIds(),s=a.length;for(i=0;i<s&&(n=a[i],!(t=this.datavizRenderings[n].isImpactingAttribute(e)));i++);}return t},getPrimitiveIds:function(){var e,t=(e=Object.keys(this.primitiveRenderings)).indexOf("length");return t>=0&&e.splice(t,1),e},hasPrimitivesOnAttribute:function(e){var t=!1;if(r.is(this.primitiveRenderings)){var i,n,a=this.getPrimitiveIds(),s=a.length;for(i=0;i<s&&(n=a[i],!(t=this.primitiveRenderings[n].isImpactingAttribute(e)));i++);}return t},isImpactingAttribute:function(e){return this._parent(e)||this.hasPrimitivesOnAttribute(e)||this.hasDatavizOnAttribute(e)},_priorityClean:function(e){if(r.is(e)){var t,i=Object.keys(e),n=i.length;for(t=0;t<n;t++){var a=i[t];void 0!==e[a]&&(r.is(this.datavizRenderings)&&this.shouldResetDataviz(a,e[a])&&this.removeAttributeFromDataviz(a),r.is(this.primitiveRenderings))}}},shouldResetDataviz:function(e,t){var i,n=this.getDatavizIds(),a=n.length;for(i=0;i<a;i++)if(r.is(this.datavizRenderings[n[i]])&&r.is(this.datavizRenderings[n[i]].exprData)&&r.is(this.datavizRenderings[n[i]].exprData[e]))return this.compareRenderings(this.datavizRenderings[n[i]].exprData[e],t);return!0},compareRenderings:function(e,t){var i,n=Object.keys(e),a=n.length;for(i=0;i<a;i++)return!!r.is(e.expr)||!!r.is(t[n[i]])&&this.compareRenderings(e[n[i]],t[n[i]])},removeAttributeFromDataviz:function(e){var t,i=this.datavizRenderings.length,r={length:0},n=this.getDatavizIds();for(t=0;t<i;t++){var a=n[t];if("length"!==a){var s=this.datavizRenderings[a];s.remove(e)||(r[a]=s,r.length++)}}r.length!==this.datavizRenderings.length&&(this.datavizRenderings=r)},removeAttributeFromPrimitives:function(e){var t,i=this.primitiveRenderings.length,r={length:0},n=this.getPrimitiveIds();for(t=0;t<i;t++){var a=n[t];if("length"!==a){var s=this.primitiveRenderings[a];s.remove(e)||(r[a]=s,r.length++)}}r.length!==this.primitiveRenderings.length&&(this.primitiveRenderings=r)},getStrokeFeatureRendering:function(){var e,r,a,s=[],o=this.get("stroke"),l=new n(o),d=this.getDatavizImpactingAttribute("stroke"),u=d.length;for(r=0;r<u;r++)a=d[r],(e=new i(d[r])).addOverIds("3DXCityDefaultID_stroke"+r),e.resetRenderingDataOnly(),e.addOver(a.get("stroke")),e.exprData&&e.exprData.stroke&&(e.exprData=e.exprData.stroke),s.push(e);var f=this.getPrimitiveImpactingAttribute("stroke");for(u=f.length,r=0;r<u;r++)a=f[r],(e=new t(f[r])).resetRenderingDataOnly(),e.addOver(a.get("stroke")),s.push(e);return l.addRenderings(s),l},getDatavizImpactingAttribute:function(e){var t=[];if(r.is(this.datavizRenderings)){var i,n,a=this.getDatavizIds(),s=a.length;for(i=0;i<s;i++)n=a[i],!1,this.datavizRenderings[n].isImpactingAttribute(e)&&t.push(this.datavizRenderings[n])}return t},getPrimitiveImpactingAttribute:function(e){var t=[];if(r.is(this.primitiveRenderings)){var i,n,a=this.getPrimitiveIds(),s=a.length;for(i=0;i<s;i++)n=a[i],!1,this.primitiveRenderings[n].isImpactingAttribute(e)&&t.push(this.primitiveRenderings[n])}return t},toJSON:function(e){var t={},i=this._parent();return r.is(i)&&Object.keys(i).length>0&&(t.Material=i),r.is(this.datavizRenderings)&&this.addJSONRenderingDataviz(t,e),r.is(this.primitiveRenderings)&&this.addJSONRenderingPrimitive(t),t},addJSONRenderingDataviz:function(e,t){var i=this._getJSONDataviz(this.datavizRenderings,t);r.is(i)&&Object.keys(i).length>0&&(e.DatavizRendering=i)},addJSONRenderingPrimitive:function(e){var t=this._getJSONPrimitives(this.primitiveRenderings);r.is(t)&&Object.keys(t).length>0&&(e.ElementRendering=t)},_getJSONPrimitives:function(e){var t;if(r.is(e)){var i,n,a,s,o=Object.keys(e),l=o.length;for(i=0;i<l;i++)"length"!==(s=o[i])&&(n=e[s],r.is(n)&&(a=n.toJSON(),r.is(a)&&(r.is(t)||(t=[]),t.push(a))))}return t},_getJSONDataviz:function(e,t){var i;if(r.is(e)&&r.is(e.length)&&e.length>0){var n,a,s,o,l=this.getDatavizIds(),d=l.length;for(n=0;n<d;n++)a=e[o=l[n]],r.is(a)&&(s=r.is(a.expr)&&!1===t?a:a.toJSON(t),r.is(s)&&(r.is(i)||(i={}),i[o]=s))}return i},getAllValuesForAttribute:function(e){var t,i=this.get(e);r.is(i)&&((t={}).Material={},t.Material[e]=i);var n=this.getAllDatavizValuesForAttribute(e);r.is(n)&&(r.is(t)||(t={}),t.DatavizMaterial={},t.DatavizMaterial[e]=n);var a=this.getAllPrimitiveValuesForAttribute(e);return r.is(a)&&(r.is(t)||(t={}),t.ElementMaterial={},t.ElementMaterial[e]=a),t},getAllDatavizValuesForAttribute:function(e){var t;if(r.is(this.datavizRenderings)){var i,n,a,s=this.getDatavizIds(),o=s.length;for(i=0;i<o;i++)if(a=s[i],n=this.datavizRenderings[a],r.is(n)){var l=n.get(e);r.is(l)&&(r.is(t)||(t={}),t[a]=l)}}return t},getAllPrimitiveValuesForAttribute:function(e){var t;if(r.is(this.primitiveRenderings)){var i,n,a,s=this.getPrimitiveIds(),o=s.length;for(i=0;i<o;i++)if(a=s[i],n=this.primitiveRenderings[a],r.is(n)){var l=n.get(e);r.is(l)&&(r.is(t)||(t={}),t[a]=l)}}return t},_getPertinentRenderings:function(e){var t;if(r.is(this.primitiveRenderings)){var n,a,s,o,l=this.primitiveRenderings[this.getPrimitiveIds()[0]],d=e.getPrimitiveIds(),u=d.length;for(n=0;n<u;n++)s=d[n],a=e.primitiveRenderings[s],o=l.getSimilarity(a),r.is(o)&&(r.is(t)||(t=[]),t.push(o));for(u=e.getDatavizIds().length,l=new i(l),n=0;n<u;n++)s=d[n],a=e.datavizRenderings[s],o=l.getSimilarity(a),r.is(o)&&(r.is(t)||(t=[]),t.push(o))}return t},getSimilarity:function(e){var t,i=this._parent(e);r.is(i)&&(t=new n(i));var a=this._getPertinentRenderings(e);return r.is(a)&&(r.is(t)||(t=new n),t.addRenderings(a)),t},_create:function(e){return new n(e)},getMappings:function(e){var t,n,a=this.datavizRenderings.length;if(!r.is(this._mappingsMerge)){var s=this.getDatavizIds();for(this._mappingsMerge=new i(this.datavizRenderings[s[0]]),t=1;t<a;t++)n=this.datavizRenderings[s[t]],this._mappingsMerge.exprData=Object.assign(this._mappingsMerge.exprData,n.exprData)}delete this._mappingsMerge.exprData.label;var o={},l=Object.keys(this._mappingsMerge.exprData);a=l.length;for(t=0;t<a;t++){let e=l[t];o[e]=this.get(e)}return this._mappingsMerge._interpretMappings(e,o)},getImpactedAttributes:function(e){if(e=this._parent(e),r.is(this.datavizRenderings)){var t,i=this.getDatavizIds(),n=i.length;for(a=0;a<n;a++){t=i[a],e=this.datavizRenderings[t].getImpactedAttributes(e)}}if(r.is(this.primitiveRenderings)){var a,s,o,l=this.getPrimitiveIds();n=l.length;for(a=0;a<n;a++)o=l[a],s=this.primitiveRenderings[o],r.is(s)&&(e=s.getImpactedAttributes(e))}return e}});return n}),define("DS/XCityRendering/BuildingTdbStore",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityRendering/BuildingTdbAtlas","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader"],function(e,t,i,r,n,a,s){"use strict";return e.extend({init:function(e,r,n){this.urban=e,this.webWorkersParams=n,this.store={},this.storeLimit=5,this.timeStamp=0,this.inProcessDL=0,this.maxAllowedDL=1,this.DLQueue=[],this.defaultMode=!1,this.callbackList={},this.atlasBaseURL=void 0,this.store.default=new i(this.urban,"default",this.webWorkersParams),s.loadTexture(function(e){e&&(e.wrapS=t.RepeatWrapping,e.wrapT=t.RepeatWrapping,this.store.default._defineTextureAs(e,"atlasTexture",t.RepeatWrapping),this.store.default._defineTextureAs(e,"atlasInfoTexture",t.ClampToEdgeWrapping,t.NearestFilter,!1,!1),this.store.default.loaded=!0)}.bind(this),r),this.pollTiming=200,this.pollTimeOut=setTimeout(this._pollQueue.bind(this),this.pollTiming),this.cleanupTiming=2e3,this.cleanTimeOut=setTimeout(this._cleanupStore.bind(this),this.cleanupTiming),a.subscribeTo("/3DEXPERIENCity/onUpdate",this.update.bind(this))},dispose:function(){for(var e in n.warn("Dispose: TdbStore"),clearTimeout(this.pollTimeOut),clearTimeout(this.cleanTimeOut),this.pollTimeOut=void 0,this.cleanTimeOut=void 0,this.DLQueue=[],this.callbackList={},this.store)if(this.store.hasOwnProperty(e)){var t=this.store[e];t.material&&t.material.shared>1?(n.log("save tdb from darkness "),n.info(t.name,"  -  Material stil in use (",t.material.shared,")")):(n.info("Delete TDB: ",t.name),t.dispose(),t=void 0,delete this.store[e])}this.store={}},setUrls:function(e){this.atlasBaseURL=e},update:function(e){this.timeStamp=e},_displayStore:function(){for(var e in n.log("TDB store content: "),this.store)this.store.hasOwnProperty(e)&&n.log("   -  ",e);n.log("---------------------------------------")},getTDB:function(e){var t=this.store[e];return null!=t?this._touch(t):t},getOrDownloadData:function(e,t,r){if("default"!==e&&void 0===this.atlasBaseURL)return n.error("Default TDB not asked and no base URL defined..."),void 0!==r&&r(null),null;if(void 0===this.store[e])this.webWorkersParams?this.store[e]=new i(this.urban,e,this.webWorkersParams):this.store[e]=new i(this.urban,e,"wall");else if(null===this.store[e])return void 0!==r&&r(this.store.default),this.store.default;var a=this._touch(this.store[e]);return!a.pendingDL&&a.loaded?(void 0!==r&&r(a),a):(void 0===this.callbackList[e]&&(this.callbackList[e]=[]),a.pendingDL||this.load(e,t,!1),void 0!==r&&r(a),a)},load:function(e,t,i){if(i){this.inProcessDL+=1;this.requestData(e,function(t,i){this.inProcessDL-=1,!0===i&&void 0!==this.store[e]&&void 0!==t&&t.loaded?(this.store[e]=this._touch(t),this.store[e].pendingDL=!1):(n.warn(e+" not added to visuStore"),null!==this.store[e]&&void 0!==this.store[e]&&this.store[e].dispose(),this.store[e]=null);var r=this.callbackList[e];if(void 0!==r){for(var a=0;a<r.length;++a){var s=r[a];setTimeout(s(this.store[e]),5*a)}delete this.callbackList[e]}}.bind(this))}else{var r=this.store[e];if(r.pendingDL)return void this._touch(r);r.pendingDL=!0,this.DLQueue.push({tdbName:e,timeStamp:t})}},requestData:function(e,t){if(r.is(this.atlasBaseURL)){var i=this.atlasBaseURL;i=(i=s.resolveUrl(i)).replace("%a",e),this.store[e].loadAtlas(i,function(i){i?t(this.store[e],!0):t(void 0,!1)}.bind(this))}},_touch:function(e){return e.timeStamp=this.timeStamp,e},_pollQueue:function(){for(var e=Math.min(this.DLQueue.length,this.maxAllowedDL-this.inProcessDL),t=this.DLQueue.splice(0,e),i=0;i<t.length;i++)this.load(t[i].tdbName,t[i].timeStamp,!0);this.pollTimeOut=setTimeout(this._pollQueue.bind(this),this.pollTiming)},_cleanupStore:function(){var e=[];for(var t in this.store)null!==this.store[t]&&(this.store[t].name=t,"default"!==t&&e.push(this.store[t]));if(e.length>this.storeLimit){n.log("destroying..."),e.sort(function(e,t){return t.timeStamp-e.timeStamp});var i=e.pop();i.material&&i.material.shared>1?(n.log("save tdb from darkness "),n.info(i.name,"  -  Material stil in use (",i.material.shared,")")):(n.info("Delete TDB: ",i.name),i.dispose(),delete this.store[i.name],i=void 0)}this.cleanTimeOut=setTimeout(this._cleanupStore.bind(this),this.cleanupTiming)}})}),define("DS/XCityRendering/RenderingProfileBase",["DS/Visualization/ThreeJS_DS","DS/XCityTools/RenderingTools","DS/XCityCore/Profile","DS/xCityBasicUtils/Utils","DS/XCityTools/Downloader","DS/XCityRendering/Rendering","DS/XCityRendering/FeatureRendering"],function(e,t,i,r,n,a,s){"use strict";return i.extend({init:function(e,t){this.SkyId="Sky",this.GroundId="Ground",this._parent(e,t)},_getRendering:function(e,t){var i,n=null;return r.is(this._ids)&&r.is(this._ids[e])&&(r.is(t)?r.is(this._ids[e].elementRendering)&&r.is(this._ids[e].elementRendering[t])&&(n=this._ids[e].elementRendering[t]):(i=this._ids[e].materialIndex,r.is(this._materials)&&r.is(this._materials[i])&&(n=this._materials[i]))),n},resetRender:function(e,t){var i,n=t.getManager();r.is(t)&&r.is(t._ids)&&(i=t._ids),n.resetRender(i)},resetRendering:function(e,t){if(r.is(this._ids)&&r.is(this._materials)){var i={};if(r.is(e))r.is(t)?(this._ids[e].elementRendering[t]={},i[e]={}):(this._ids[e]={},i[e]={});else{for(var n in this._ids)this._ids.hasOwnProperty(n)&&(i[n]={});this._ids={},this._materials={}}if(!0===this._enabled)this.getManager().resetRender(i)}},setGround:function(e){var t;if(r.is(this._ids)||(this._ids={}),r.is(this._ids[this.GroundId])){var i=this._ids[this.GroundId].materialIndex;t=this._materials[i]}else(t={}).id=this._findnewmaterialId(),r.is(this._materials)||(this._materials={}),this._materials[t.id]=t,this._ids[this.GroundId]={materialIndex:t.id};if(r.is(e.showOcean)&&(t.showOcean=e.showOcean,void 0!==this._ids["3DXCityGeometricTerrain"])){i=this._ids["3DXCityGeometricTerrain"].materialIndex;(t=this._materials[i]).showOcean=e.showOcean}!0===this._enabled&&this.setRender(this._urban,this)},setSky:function(e){this._parseSky(e),!0===this._enabled&&this.setRender(this._urban,this)},getSky:function(){if(!r.is(this._ids)||!r.is(this._materials)||!r.is(this._ids[this.SkyId]))return null;var e=this._ids[this.SkyId].materialIndex;return this._materials[e]},setEffect:function(e){this._urban.getEnvironment().addRenderProfile(this.getName(),e)},getGlobalEffects:function(){return this._urban.environment._getprofileparams(this.getName())},resetEffect:function(){},enableOcean:function(e){r.is(this._ids)||(this._ids={}),this.setGround({showOcean:e})},isOceanEnabled:function(){var e,t,i=null;return r.is(this._ids)&&r.is(this._ids[this.GroundId])&&(e=this._ids[this.GroundId].materialIndex,t=this._materials[e],r.is(t)&&r.is(t.showOcean)&&(i=t.showOcean)),i},unload:function(){var e,t,i,n,a;if(r.is(this._materials)){var s,o=Object.keys(this._materials);for(s=0;s<o.length;s++)t=o[s],e=this._materials[t],r.is(e)&&r.is(e.map)&&e.map.dispose&&(e.map.dispose(),e.map=void 0)}if(n=this.getManager(),this.getName()!==n.defaultProfile)for(t in(i=n.getProfile(n.defaultProfile))._ids={},this._ids)this._ids.hasOwnProperty(t)&&(a={materialIndex:0},i._ids[t]=a)},_parseConfig:function(e){if(r.is(e.Configuration)){var t=this.getManager();this._show=[],this._hide=[],r.is(e.Configuration.Show)&&(this._show=e.Configuration.Show.slice()),r.is(e.Configuration.Hide)&&(this._hide=e.Configuration.Hide.slice());var i={show:this._show,hide:this._hide},n=function(e,t){var i=e.id,r=e.get("name");i?r?(t.show&&(t.show.indexOf(i)>=0?e.setVisible(!0):t.show.indexOf(r)>=0&&e.setVisible(!0)),t.hide&&(t.hide.indexOf(i)>=0?e.setVisible(!1):t.hide.indexOf(r)>=0&&e.setVisible(!1))):(t.show&&t.show.indexOf(i)>=0&&e.setVisible(!0),t.hide&&t.hide.indexOf(i)>=0&&e.setVisible(!1)):r&&(t.show&&t.show.indexOf(r)>=0&&e.setVisible(!0),t.hide&&t.hide.indexOf(r)>=0&&e.setVisible(!1))};t.addProfile(e.name,function(e,t){t.show.length+t.hide.length>0&&(e._dataModelPrivate.traverse(n,!0,t),e.modelRoot.traverse(n,!0,t))},i,"ShowHide")}},_parseEffects:function(e,t){var i=this.getManager(),n=null;r.is(e.Effects)&&(n=r.clone(e.Effects));var a=!0;if(t&&t._urban&&t._urban._coreVersion){var s=t._urban._coreVersion.split(".");s[0]=Number(s[0].split("R")[1]),s[1]=Number(s[1]),s[2]=Number(s[2]),s[0]<424?a=!1:424===s[0]&&s[1]<=21&&s[2]<=42&&(a=!1)}else a=!1;!1===a&&(n&&n.sun&&n.sun.ambientFactor&&(n.sun.ambientFactor/=1.7),n&&n.sun&&n.sun.diffuseFactor&&(n.sun.diffuseFactor/=.7)),t.addRenderProfile(e.name,n);var o=this;i.addProfile(e.name,function(){t.setRendering(o.getName())},e,"EffectsParams")},_parseRendering:function(e){if(r.is(e.Rendering)){var t=0;for(t=0;t<e.Rendering.length;t++)this._parseOneRenderingGroup(e.Rendering[t])}},_findnewmaterialId:function(){var e=0;if(r.is(this._materials))for(;r.is(this._materials[e]);)e++;return e},setRender:function(e,t){var i,n,a=t.getManager();r.is(t)&&(r.is(t._ids)&&(i=t._ids),r.is(t._materials)&&(n=t._materials)),a.setRender(i,n)},isRenderInitialized:function(){return this.hasNodeName("RenderingGroup")},_initRender:function(){this.getManager().addProfile(this.getName(),this.setRender,this,"RenderingGroup")},_profileToGroundMaterial:function(e){var t,i=e;r.is(e.showOcean)&&(i.showOcean=e.showOcean);var n=["oceanColor","oceanColorDetection"];for(t=0;t<n.length;t++)r.is(e[n[t]])&&(i[n[t]]=this._profileToColor(e[n[t]]));var a=["oceanAlpha","oceanRangeDetection"];for(t=0;t<a.length;t++)r.is(e[a[t]])&&(i[a[t]]=this._profileToFloat(e[a[t]]));return void 0!==e.oceanTextureUrl&&(i.oceanTextureUrl=this._profileToUrl(e.oceanTextureUrl)),i},_profileToSkyMaterial:function(e){var t=e,i=e;return t.cubeMapUrl=this._profileToUrl(i.cubeMapUrl),t},_parseSky:function(e){if(r.is(e)){var t=this._profileToSkyMaterial(e),i=this;if(r.is(this._ids)||(this._ids={}),t.id=this._findnewmaterialId(),r.is(this._materials)||(this._materials={}),this._materials[t.id]=t,this._ids[this.SkyId]={materialIndex:t.id},r.is(t.cubeMapUrl)&&e.cubeMapExt){var n=e.cubeMapExt;".png"!==n&&"hdr"!==n&&(n=".png");var a=t.cubeMapUrl+"_4K"+n,s=t.cubeMapUrl+"_4K_rmips"+n,o=function(e){r.is(e)&&(e._urbanurl=t.cubeMapUrl,t.cubeMap._rmips=e),!0===i._enabled&&i.getManager().setRender(i.SkyId)};this.loadTexture(this._urban,function(e){r.is(e)?(e._urbanurl=t.cubeMapUrl,t.cubeMap=e,i.loadTexture(i._urban,o,s)):(t.cubeMap=e,!0===i._enabled&&i.getManager().setRender(i.SkyId))},a)}}},_initMaterialFromProfile:function(e){return t._JSONToRendering(e)},_profileToColor:function(t){return"object"==typeof t&&(t="rgb("+255*t.r+","+255*t.g+","+255*t.b+")"),new e.Color(t)},_profileToUrl:function(e){var t=null;return"string"==typeof e&&(t="null"===e?null:e),t},_profileToFloat:function(e){var t=null;return"string"==typeof e?t=Number(e):"number"==typeof e&&(t=e),r.is(t)||(t=null),t},_loadTexture:function(e,t,i,n){if(!r.is(i))return!1;i.toload++;return this.loadTexture(this._urban,function(a){i.toload--,r.is(a)&&(i.material[e]=a,r.endsWith(t,".png")&&!1!==i.material.transparent&&(i.material.transparent=!0)),i.toload<=0&&(i.loaded=!0,n(a))},t),!0},_getRelationMatrix:function(){var e,t,i=!1,n={};if(r.is(this._ids)){var a,s=Object.keys(this._ids),o=s.length;for(a=0;a<o;a++)e=s[a],t=this._ids[e].materialIndex,r.is(this._ids[e].elementRendering)?(r.is(n.elementRendering)||(n.elementRendering=[]),n.elementRendering.push(e)):r.is(this._ids[e].datavizRenderings)?(r.is(n.datavizRenderings)||(n.datavizRenderings=[]),n.datavizRenderings.push(e)):(r.is(n[t])||(n[t]=[]),n[t].push(e)),i=!0}return i||(n=null),n},_getDisplayConfiguration:function(){var e;return r.is(this._show)&&this._show.length>0&&(r.is(e)||(e={}),e.Show=this._show),r.is(this._hide)&&this._hide.length>0&&(r.is(e)||(e={}),e.Hide=this._hide),e},_getJSONAllRendering:function(e){var t,i,n,a=e.length;for(i=0;i<a;i++){n=e[i];var s=this._getJSONRendering(n),o=this._getJSONRenderingElement(n);r.is(o)&&(r.is(s)||(s={Ids:n}),s.ElementRendering=o);var l=this._getJSONRenderingDataviz(n);r.is(l)&&(r.is(s)||(s={Ids:n}),s.DatavizRendering=l),r.is(s)&&(r.is(t)||(t=[]),t.push(s))}return t},_getJSONRenderingElement:function(e){var t,i=this._ids[e];if(r.is(i)){var n=i.elementRendering;if(r.is(n)){var a,s,o,l=Object.keys(n),d=l.length;for(a=0;a<d;a++)s=n[l[a]],r.is(s)&&(o=s.toJSON(),r.is(o)&&(r.is(t)||(t=[]),t.push(o)))}}return t},_getJSONRenderingDataviz:function(e){var t,i=this._ids[e];if(r.is(i)){var n=i.datavizRenderings;if(r.is(n)){var a,s,o,l,d=Object.keys(n),u=d.length;for(a=0;a<u;a++)s=n[l=d[a]],r.is(s)&&(o=s.toJSON(),r.is(t)||(t={}),t[l]=o)}}return t},_getInputProfile:function(){var e=this._parent();e.Effects=this.getGlobalEffects();var t,i,n,a,s,o=this._getDisplayConfiguration();if(r.is(o)&&(e.Configuration=o),this.matrix=this._getRelationMatrix(),r.is(this.matrix)){e.Rendering=[];var l=Object.keys(this.matrix),d=l.length;for(n=0;n<d;n++){i=l[n];var u=this.matrix[i],f=u.length;if("elementRendering"===i)t=this._getJSONAllRendering(u),r.is(t)&&(e.Rendering=e.Rendering.concat(t));else if("datavizRenderings"===i)for(a=0;a<f;a++){s=u[a],t=this._getJSONRendering(s);var h=this._getJSONRenderingDataviz(s);r.is(h)&&(r.is(t)||(t={Ids:s}),t.DatavizRendering=h),r.is(t)&&e.Rendering.push(t)}else t=this._getJSONRendering(u),r.is(t)&&e.Rendering.push(t);t=null}}return e},_getJSONRendering:function(e){var i;if(r.is(e)){var n=e;Array.isArray(e)&&(n=e[0]);var a=this._ids[n];if(r.is(a)){i={Ids:e};var s=a.materialIndex;r.is(s)&&(i.Material=t._RenderingToJSON(t._JSONToRendering(this._materials[s])),i.Material=this.deactivateToolsFromExperience(i.Material))}}return i},deactivateToolsFromExperience:function(e){return r.is(e)&&r.is(e.terrainAnalyzer)&&r.is(e.terrainAnalyzer.mode)&&delete e.terrainAnalyzer.mode,e},disable:function(){this._parent(),this.unload()},_getMaterialForFeatureFromLayer:function(e,i){var n=this;if(r.is(i)&&console.warn("NOT implemented"),r.is(n._ids)&&r.is(n._ids[e])){var a={},s=n._ids[e].materialIndex;if(r.is(n._materials)){var o=n._materials[s];t._setMaterialFromProfile(a,o)}return a}return null},getManager:function(){return this._urban.getRenderingProfileManager()},setName:function(e){var t=this.getName();this._parent(e),this._urban.getEnvironment().defaults[this.getName()]=this._urban.getEnvironment().defaults[t],this._urban.getEnvironment().defaults[t]=void 0},getReferencedId:function(e){var t=null;if(r.is(e)&&r.is(this._ids)){var i=e.get("id");if(r.is(this._ids[i]))t=i;else if(i=e.get("renderID"),r.is(this._ids[i]))t=i;else{var n=e._itemParent;r.is(n)&&(i=n.get("id"),r.is(this._ids[i])&&(t=i))}}return t},loadTexture:function(e,t,i,r){n.loadTexture(t,i,r)},loadTextureCube:function(e,t,i){this.loadTexture(e,t,i,1)},clean:function(){this._ids=null,this._materials=null}})}),define("DS/XCityRendering/RenderingHandlerDownload",["DS/XCityTools/ShaderTools","DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandler","DS/XCityTools/RenderingTools"],function(e,t,i,r,n,a,s){"use strict";return a.extend({init:function(e,t){this._parent(e,t)},updateRendering:function(e){this._parent(e);this._specificToUpdate=!0},applyRendering:function(e){!0===this._specificToUpdate&&this.updateSpecificRendering()},_removeMeshFromList:function(e,t){if(n.is(e)&&n.is(this._specificMaterials[t]))for(var i=0;i<this._specificMaterials[t].meshes.length;i++){if(this._specificMaterials[t].meshes[i].id===e.id&&(this._specificMaterials[t].meshes.splice(i,1),i--,this._specificMaterials[t].meshes.length<=0)){delete this._specificMaterials[t];break}}},_whenDisposeOfMeshes:function(e,t){for(var i=0;i<e.length;i++){var r=e[i];n.is(r.observers)||(r.observers=[]),r.observers.push(this._removeMeshFromList.bind(this,r,t))}},_replaceDrawingGroup:function(e,t){n.is(e.gas)&&(e.gas=t),n.is(e.material)&&(e.material=t)},_addSpecificGeometry:function(e){n.is(this._specificMaterials)||(this._specificMaterials={},this._specificToUpdate=!0);Object.keys(this._specificMaterials).length;var t,a={},s={},o=this;for(var l in e.traverse(function(e){if(e instanceof i){if(e.mesh3js&&e.mesh3js.material&&(void 0===a[e.mesh3js.material.id]&&(a[e.mesh3js.material.id]=[]),a[e.mesh3js.material.id].push(e),n.is(e.mesh3js.geometry)&&e.mesh3js.geometry.length>0)){var t=e.mesh3js.geometry[0];if(n.is(t.drawingGroups)&&t.drawingGroups.length>0){s[e.mesh3js.material.id]||(s[e.mesh3js.material.id]={}),s[e.mesh3js.material.id][t.id]||(s[e.mesh3js.material.id][t.id]={}),s[e.mesh3js.material.id][t.id].material||(s[e.mesh3js.material.id][t.id].material=[]),s[e.mesh3js.material.id][t.id].gas||(s[e.mesh3js.material.id][t.id].gas=[]);for(var l=0;l<t.drawingGroups.length;l++)n.is(t.drawingGroups[l].material)&&n.is(t.drawingGroups[l].gas)&&t.drawingGroups[l].material.id!=t.drawingGroups[l].gas.id?(t.drawingGroups[l].material=o._cloneMaterial(t.drawingGroups[l].material),s[e.mesh3js.material.id][t.id].material.push(t.drawingGroups[l].material),t.drawingGroups[l].gas=o._cloneMaterial(t.drawingGroups[l].gas),s[e.mesh3js.material.id][t.id].gas.push(t.drawingGroups[l].gas)):n.is(t.drawingGroups[l].material)?(o._replaceDrawingGroup(t.drawingGroups[l],o._cloneMaterial(t.drawingGroups[l].material)),s[e.mesh3js.material.id][t.id].material.push(t.drawingGroups[l].material)):n.is(t.drawingGroups[l].gas)&&(o._replaceDrawingGroup(t.drawingGroups[l],o._cloneMaterial(t.drawingGroups[l].gas)),s[e.mesh3js.material.id][t.id].gas.push(t.drawingGroups[l].gas))}}}else e instanceof r&&n.is(e.material)&&(void 0===a[e.material.id]&&(a[e.material.id]=[]),a[e.material.id].push(e))}),a)if(a.hasOwnProperty(l)){var d=a[l];this._whenDisposeOfMeshes(d,l),n.is(this._specificMaterials[l])?this._specificMaterials[l].meshes=this._specificMaterials[l].meshes.concat(d):this._specificMaterials[l]={meshes:d};var u=d[0].material;if(n.is(u)||(u=d[0].mesh3js.material),this._specificMaterials[l].material=this._cloneMaterial(u),d[0].material&&d[0].setMaterial(this._specificMaterials[l].material),n.is(s[l]))for(var f in s[l])if(s[l].hasOwnProperty(f)){for(this._specificMaterials[l].geometries||(this._specificMaterials[l].geometries={}),this._specificMaterials[l].geometries[f]||(this._specificMaterials[l].geometries[f]={}),this._specificMaterials[l].geometries[f].dgnum=0,this._specificMaterials[l].geometries[f].DG={},this._specificMaterials[l].geometries[f].DG.material=[],this._specificMaterials[l].geometries[f].DG.gas=[],t=0;t<s[l][f].gas.length;t++)this._specificMaterials[l].geometries[f].DG.gas.push(this._cloneMaterial(s[l][f].gas[t])),this._specificMaterials[l].geometries[f].dgnum++;for(t=0;t<s[l][f].material.length;t++)this._specificMaterials[l].geometries[f].DG.material.push(this._cloneMaterial(s[l][f].material[t]))}this._specificToUpdate=!0}this.updateSpecificRendering(a)},updateMeshSpecificRendering:function(e){if(e&&e.material){var t={};t[e.material.id]=!0,this.updateSpecificRendering(t)}},updateSpecificRendering:function(e){this._specificToUpdate=!0,this._setSpecificRendering(null,e);var t=this.getCurrentRenderingDifference();n.is(t)&&(Object.keys(t).length>0&&(this._specificToUpdate=!0,this._setSpecificRendering(t,e)))},_isSpecModel:function(){var e=!1,t=this._content;return n.is(t)&&n.is(t.get("spec"))&&(e=!0),e},_cloneMaterial:function(i){if(n.is(i)){var r,a=this;this._isSpecModel()&&i.ambient&&1===i.ambient.r&&1===i.ambient.g&&1===i.ambient.b&&(i.ambient=i.color),void 0===i.cloneWithAnim?!0===i._usePhongLighting?((r=t.MaterialUtils.createShinyFaceMaterial(i)).metalness=0,r.roughness=1,r.textureBlending=t.TextureBlendOperations.MODULATE):(r=i.clone()).textureBlending=t.TextureBlendOperations.MODULATE:(r=i.cloneWithAnim(),e.unregisterAnimationUniforms(i),e.deactivateAnimationUniforms(r)),s._setMaterialFromProfile(r,this.getDefaultRenderingData()),s._setMaterialFromProfile(r,i),s._setMaterialMapFromProfile(r,i,this);var o=r.map;return o&&o.image&&!o.image.complete&&o.onLoadCallbacks&&o.onLoadCallbacks.push(function(){r.map=o,e.updateCommonUniforms(r),r.updateDeferredMaterials&&(r._deferredMaterialsInit=!1);var t={};t[r.id]=!0,a.updateSpecificRendering(t)}),e.updateCommonUniforms(r),r}},_setSpecificMaterial:function(t,r){var a,o,l,d,u,f,h,g,c;for(d=0;d<t.meshes.length;d++)if(u=t.meshes[d],f=t.material,u instanceof i){if(h=t.material,n.is(r)&&(f=r,u.mesh3js.material.updateDeferredMaterials&&(u.mesh3js.material._deferredMaterialsInit=!1)),n.is(t.geometries)){l=u.mesh3js.geometry[0],n.is(r)&&(f=r,h=r);var p=0,_=0;for(o=0;o<l.drawingGroups.length;o++)l.drawingGroups[o].material&&(g=l.drawingGroups[o].material,r||(f=t.geometries[l.id].DG.material[p],p++)),l.drawingGroups[o].gas&&(c=l.drawingGroups[o].gas,r||(h=t.geometries[l.id].DG.gas[_],_++)),n.is(r)&&(a=u.mesh3js.material),h&&c&&(s._setMaterialFromProfile(c,h),s._setMaterialMapFromProfile(c,h,this),e.updateCommonUniforms(c)),f&&g&&(s._setMaterialFromProfile(g,f),s._setMaterialMapFromProfile(g,f,this),e.updateCommonUniforms(g),h&&c&&c.id!==g.id&&(c.force=!1)),c=null,g=null}else a=u.mesh3js.material,s._setMaterialFromProfile(a,f),s._setMaterialMapFromProfile(a,f,this),e.updateCommonUniforms(a),this.setMaterialToMesh(u,a);this._lastSeenMaterial=a,c&&(this._lastSeenMaterial=c),g&&(this._lastSeenMaterial=g),this.applyElementRendering(u)}else n.is(r)&&(f=r),a=u.material,s._setMaterialFromProfile(a,f),s._setMaterialMapFromProfile(a,f,this),e.updateCommonUniforms(a),u.setMaterial(a),this.applyElementRendering(u)},_setSpecificRendering:function(e,t){var i,r,a,s;if(n.is(this._specificMaterials)&&this._specificToUpdate){for(a=Object.keys(this._specificMaterials),n.is(t)&&(a=Object.keys(t)),r=0;r<a.length;r++)i=a[r],s=this._specificMaterials[i],n.is(s)&&this._setSpecificMaterial(s,e);this._specificToUpdate=!1}},removeMesh:function(e){this._parent(e)}})}),define("DS/XCityRendering/RenderingProfile",["DS/XCityRendering/RenderingProfileBase","DS/xCityBasicUtils/Utils","DS/XCityRendering/FeatureRendering","DS/XCityRendering/PrimitiveRendering","DS/XCityTools/OGCFilter","DS/XCityRendering/DatavizRendering","DS/XCityTools/RenderingTools","DS/XCityTools/TextureManager"],function(e,t,i,r,n,a,s,o){"use strict";return e.extend({init:function(e,t){this.level=50,this._parent(e,t)},getRenderingForId:function(e,r){var n,a,s=r;return t.is(r)||(s=new i),t.is(this._ids)&&t.is(this._ids[e])&&(t.is(this._materials)&&(n=this._ids[e].materialIndex,t.is(n)&&(s._priorityClean(this._materials[n]),s.addOver(this._materials[n]))),a=this._ids[e].elementRendering,t.is(a)&&s.addPrimitives(a),a=this._ids[e].datavizRenderings,t.is(a)&&s.addRenderings(a)),s},addOnlyPrimitiveRendering:function(e,i,r){t.is(this._ids)||(this._ids={}),t.is(this._ids[e])||(this._ids[e]={}),t.is(this._ids[e].elementRendering)||(this._ids[e].elementRendering={});var n={ElementIds:i,ElementMaterial:r};this._parseElementRender(e,n)},addPrimitiveRendering:function(e,t,i){this.addOnlyPrimitiveRendering(e,t,i),this.getManager().renderPrimitive(e,t)},isMaterialInfo:function(e){return e&&(e.Material||e.DatavizRendering||e.ElementRendering)},featureIsLine:function(e){let t=this._urban.getLayerRoot().getRoot().findChildById(e,!0);return t&&t.getContent()&&t.getContent().getFactory()&&t.getContent().getFactory()._node&&"FactoryLine"==t.getContent().getFactory()._node.name},addRendering:function(e,i,r){if(t.is(r))this.addPrimitiveRendering(e,r,i);else if(t.is(e)&&t.is(i)){var n={};n.Ids=e,this.isMaterialInfo(i)?n=Object.assign(i,n):n.Material=i,this._parseOneRenderingGroup(n),this.cleanMaterials()}},cleanMaterials:function(){var e=this._materials,i=this._ids;if(t.is(e)&&t.is(i)){var r,n,a,s=Object.keys(i),o=s.length,l={};for(r=0;r<o;r++)a=i[n=s[r]].materialIndex,t.is(a)&&(l[a]=!0);for(o=(s=Object.keys(e)).length,r=0;r<o;r++)n=s[r],t.is(l[n])||delete this._materials[n]}},addOnlyRendering:function(e,i,r){t.is(r)?this.addOnlyPrimitiveRendering(e,r,i):this.addRendering(e,i,r)},addFilterRendering:function(e,i,r){var a;if(t.is(e)&&t.is(r)){t.is(i)||(i=new n);var s={};s.Ids=[e],s.DatavizRendering={},a=this._findnewdatavizId(e),s.DatavizRendering[a]={ElementMaterial:r,Filter:i},this._parseOneRenderingGroup(s)}return a},addDatavizRendering:function(e,i){var r;if(t.is(e)&&t.is(i)){var n={};n.Ids=[e],n.DatavizRendering={},r=this._findnewdatavizId(e),n.DatavizRendering[r]={DatavizMaterial:i},this._parseOneRenderingGroup(n)}return r},getRenderingForPrimitive:function(e,i,n){var a,s=n;return t.is(n)||(s=new r).addOverIds(i),t.is(this._ids)&&t.is(this._ids[e])&&(a=this._ids[e].elementRendering,t.is(a)&&t.is(a[i])&&s.addOver(a[i])),s},_parseElementIds:function(e){var t;return t=e,Array.isArray(e)||("string"==typeof e?t=[e]:"number"==typeof e&&(t=[e.toString()])),t},_addElementRenderingById:function(e,i,n){var a;for(a=0;a<i.length;a++){var s=i[a];if(t.is(this._ids[e].elementRendering)||(this._ids[e].elementRendering={}),t.is(this._ids[e].elementRendering[s]))this._ids[e].elementRendering[s].addOver(n);else this._ids[e].elementRendering[s]=new r(n);this._ids[e].elementRendering[s].addOverIds(s)}},_addDatavizRendering:function(e,i,r,n,s){t.is(this._ids[e].datavizRenderings)||(this._ids[e].datavizRenderings={});var o=new a(i,r,n);t.is(s)||(s=this._findnewdatavizId(e)),t.is(this._internalDatavizIds)||(this._internalDatavizIds={}),t.is(this._internalDatavizIds[s])&&(s=this._findnewdatavizId(e+s)),this._internalDatavizIds[s]=e,this._ids[e].datavizRenderings[s]=o,this._ids[e].datavizRenderings[s].addOverIds(s)},_parseElementRender:function(e,i){if(t.is(i)){var r,n,a,s;if(t.is(i.ElementMaterial)&&(n=this._initMaterialFromProfile(i.ElementMaterial)),t.is(i.ElementIds))return r=this._parseElementIds(i.ElementIds),void this._addElementRenderingById(e,r,n);t.is(i.Filter)&&(s=this._initFilter(i.Filter)),t.is(i.DatavizMaterial)&&(a=this._initDatavizMaterial(i.DatavizMaterial)),t.is(s)||t.is(a)||console.error(" elementrendering not correctly  initialized"),this._addDatavizRendering(e,n,s,a)}},_parseDatavizRender:function(e,i,r){var n,a,s;t.is(i)&&(t.is(i.ElementMaterial)&&(n=this._initMaterialFromProfile(i.ElementMaterial)),t.is(i.Filter)&&(s=this._initFilter(i.Filter)),t.is(i.DatavizMaterial)&&(a=this._initDatavizMaterial(i.DatavizMaterial)),t.is(s)||t.is(a)||console.error(" elementrendering not correctly  initialized"),this._addDatavizRendering(e,n,s,a,r))},_initFilter:function(e){return e instanceof n?e:new n(e)},_initDatavizMaterial:function(e){return e},_hasId:function(e){return t.is(this._ids)&&t.is(this._ids[e])},_hasPrimId:function(e,i){return this._hasId(e)&&t.is(this._ids[e].elementRendering)&&t.is(this._ids[e].elementRendering[i])},_resetRendering:function(e,i){var r=!1;return this._hasId(e)&&(t.is(i)?this._hasPrimId(e,i)&&(r=!0,this._resetPrimitiveRendering(e,i)):r=this._resetLayerRendering(e)),r},_resetPrimitiveRendering:function(e,t){delete this._ids[e].elementRendering[t]},_resetLayerRendering:function(e){var i=this._ids[e].materialIndex,r=this._materials[i],n=!1;if(t.is(r)&&Object.keys(r).length>0){var a={},s=this._findnewmaterialId();a.id=s,this._materials[s]=a,this._ids[e].materialIndex=s,n=!0}return n},_resetLayerDatavizRendering:function(e){var i=!1;if(t.is(this._ids)&&t.is(this._ids[e])){var r=this._ids[e].datavizRenderings;t.is(r)&&(delete this._ids[e].datavizRenderings,i=!0)}return i},_resetAttribute:function(e,i,r){return t.is(r)?this._resetPrimitiveAttribute(e,r,i):this._resetLayerAttribute(e,i)},_resetDatavizAttribute:function(e,i){var r=this._ids[e].datavizRenderings;if(t.is(r))for(var n=Object.keys(r),a=0;a<n.length;a++){var s=n[a],o=r[s];if(t.is(o))o.remove(i)&&delete r[s]}},_resetLayerAttribute:function(e,i){var r=!1;if(this._hasId(e)){var n=this._ids[e].materialIndex,a=this._materials[n];if(t.is(a)&&void 0!==t.getComposedProperty(a,i)){var o={};s._setMaterialFromProfile(o,a);var l={};t.setComposedProperty(l,i,null),s._RemoveRendering(o,l);var d=this._findnewmaterialId();o.id=d,this._materials[d]=o,this._ids[e].materialIndex=d,r=!0}this._resetDatavizAttribute(e,i)}return r},_resetPrimitiveAttribute:function(e,i,n){var a=!1;if(this._hasPrimId(e,i)){var o=this._ids[e].elementRendering[i];if(o instanceof r){var l=o.get(n);t.is(l)&&(o.remove(n),a=!0)}else if(t.is(o[n])){a=!0;var d={};d[n]=null,s._RemoveRendering(o,d)}}return a},removeRendering:function(e,i,r){var n=!1;if(this._hasId(e))if(t.is(i)){if("string"==typeof i){var a=i;n=this._resetAttribute(e,a,r)}}else n=this._resetRendering(e,r),this._renderIds([e]);return n},_findnewdatavizId:function(e){t.is(this._internalDatavizIds)||(this._internalDatavizIds={});var i=0,r=i;for(t.is(e)&&(r=e);t.is(this._internalDatavizIds[r]);)i++,r=r.split(".")[0]+"."+i;return r},_getIdsFromJSON:function(e){return Array.isArray(e.Ids)||"string"!=typeof e.Ids?e.Ids.slice():[e.Ids]},_addMaterialToIds:function(e,i){if(t.is(e)&&!(e.length<=0)&&t.is(i)){var r,n,a,o,l=this._findnewmaterialId();for(i.id=l,a=0;a<e.length;a++)if(o=e[a],t.is(this._ids[o])){r=this._ids[o].materialIndex;var d={};if(t.is(r)){var u=this._materials[r];s._setMaterialFromProfile(d,u)}s._setMaterialFromProfile(d,i),n=this._findnewmaterialId(),d.id=n,this._addMaterialToId(d,o)}else this._addMaterialToId(i,o)}},_addMaterialToId:function(e,i){var r=e.id;t.is(this._materials)||(this._materials={}),t.is(this._materials[r])||(this._materials[r]=e),t.is(this._ids[i])||(this._ids[i]={}),this._ids[i].materialIndex=r},_addElementRenderingToProfile:function(e,i){if(t.is(e.ElementRendering)){var r=i;t.is(this._ids[r])||(this._ids[r]={}),t.is(this._ids[r].elementRendering)||(this._ids[r].elementRendering={});var n,a=Object.keys(e.ElementRendering),s=a.length;for(n=0;n<s;n++){var o=a[n],l=e.ElementRendering[o];this._parseElementRender(r,l)}}},_addDatavizRenderingToProfile:function(e,i){if(t.is(e.DatavizRendering)){var r=i;t.is(this._ids[r])||(this._ids[r]={}),t.is(this._ids[r].datavizRenderings)||(this._ids[r].datavizRenderings={});var n,a=Object.keys(e.DatavizRendering),s=a.length;for(n=0;n<s;n++){var o=a[n],l=e.DatavizRendering[o];this._parseDatavizRender(r,l,o)}}},_parseOneRenderingGroup:function(e,i){if(t.is(e.Ids)){var r,n,a,s,o=this._getIdsFromJSON(e);n=o.slice(),t.is(e.Material)&&(r=this._initMaterialFromProfile(e.Material)),(a=n.indexOf(this.SkyId))>=0&&(n.splice(a,1),this._parseSky(r)),(s=n.indexOf(this.GroundId))>=0&&(n.splice(s,1),this._parseGround(r)),n.length>0&&(t.is(this._ids)||(this._ids={}),this._addMaterialToIds(n,r),this._addElementRenderingToProfile(e,n[0]),this._addDatavizRenderingToProfile(e,n[0])),!0!==i&&this._renderIds(o)}},_renderIds:function(e){if(t.is(e)&&e.length>0)if(this.isRenderInitialized()){if(this._enabled){var i,r,n,a=this.getManager(),s={};for(i=0;i<e.length;i++)r=e[i],t.is(this._ids)&&(n=this._ids[r],t.is(n)&&(s[r]=!0));a.setRender(s)}}else this._initRender()},_parseGround:function(e){if(t.is(e)){var i=this._profileToGroundMaterial(e),r=this.getManager();if(t.is(this._materials)||(this._materials={}),t.is(this._ids)||(this._ids={}),t.is(this._materialID)||(this._materialID=1),this._addMaterialToIds([this.GroundId],i),t.is(i.oceanTextureUrl)){var n=this;this._loadTexture("oceanTexture",i.oceanTextureUrl,{toload:0,material:i},function(e){if(t.is(e)){var i={};e.anisotropy=4,i.oceanTexture=e,n.isEnabled()&&(n._addMaterialToIds([n.GroundId],i),r.setRender(n._ids,n._materials))}})}}},getFilters:function(e,i){var r;if(t.is(this._ids)){var n=this._ids[e];if(t.is(n)){var a=n.datavizRenderings;if(t.is(a)){var s,o,l,d,u=Object.keys(a),f=u.length;for(s=0;s<f;s++)l=a[o=u[s]],t.is(l)&&(d=l.getFilterRendering(),t.is(d)&&t.is(d.rendering)&&t.is(d.rendering[i])&&(t.is(r)||(r={}),r[o]=d))}}}return r},getMappings:function(e,i){var r;if(t.is(this._ids)){var n=this._ids[e];if(t.is(n)){var a=n.datavizRenderings;if(t.is(a)){var s,o,l,d,u=Object.keys(a),f=u.length;for(s=0;s<f;s++)l=a[o=u[s]],t.is(l)&&(d=l.getMappingRendering(),t.is(d)&&t.is(d[i])&&(t.is(r)||(r={}),r[o]=d))}}}return r},updateDatavizRendering:function(e,i,r,n){var a=this.getDatavizRenderingFromId(e);if(t.is(a)){var s=this._initMaterialFromProfile(r);a.dataviz.setAll(s,i,n);var o={};o[a.layerid]=!0,this.getManager().setRender(o)}},deleteDatavizRendering:function(e){var i=this.getDatavizRenderingFromId(e);if(t.is(i)){this._ids[i.layerid].datavizRenderings[e]=void 0;var r={};r[i.layerid]=!0,this.getManager().setRender(r)}},getDatavizRenderingFromId:function(e){var i=null;if(!t.is(this._ids))return i;var r,n,a,s=Object.keys(this._ids),o=s.length,l=!1;for(r=0;r<o;r++)if(n=s[r],a=this._ids[n].datavizRenderings,t.is(a)){var d,u,f=Object.keys(a),h=f.length;for(d=0;d<h;d++)if((u=f[d])==e){i={dataviz:a[u],layerid:n},l=!0;break}if(l)break}return i},addSLDRenderings:function(e,i){if(t.is(e)&&t.is(i)){var r={};r.Ids=[e];var n,a=Object.keys(i),s=a.length;for(n=0;n<s;n++){var o=a[n],l=i[o];t.is(l)&&(t.is(l.Material)?(r.Material=Object.assign({},r.Material,l.Material),t.is(l.ElementRendering)&&(r.ElementRendering=l.ElementRendering)):(t.is(r.DatavizRendering)||(r.DatavizRendering={}),r.DatavizRendering[o]=l))}this._parseOneRenderingGroup(r,!0),this.createAtlas(r,e)}},resetAllPrimitivesRendering:function(e,i){var r,n,a=e.length;if(t.is(i))for(r=0;r<a;r++)n=e[r],this.removePrimitivesAttribute(n,i);else for(r=0;r<a;r++)n=e[r],this.removePrimitivesRendering(n)},removePrimitivesRendering:function(e){t.is(this._ids[e])&&(this._ids[e].elementRendering=null)},removePrimitivesAttribute:function(e,i){if(t.is(this._ids[e])){var r=this._ids[e].elementRendering;if(t.is(r)){var n,a,s,o=Object.keys(r),l=o.length;for(n=0;n<l;n++)(s=r[a=o[n]]).remove(i),s.isEmpty()&&delete this._ids[e].elementRendering[a]}}},getRenderingForLayer:function(e){if(t.is(e)){var r,n,a=e.getRendering().getIds(),s=new i,o=a.length;for(r=0;r<o;r++)n=a[r],this.getRenderingForId(n,s);return s}},getMapsArrayFromRender:function(e){var i,r,n,a,s;if(t.is(e)){var o=[];if(t.is(e.Material)&&o.push(e.Material.mapUrl),t.is(e.DatavizMaterial))for(r=(i=Object.keys(e.DatavizMaterial.mapUrl)).length,n=0;n<r;n++)a=i[n],s=e.DatavizMaterial.mapUrl[a],o.push(s);if(t.is(e.ElementMaterial))for(r=(i=Object.keys(e.ElementMaterial.mapUrl)).length,n=0;n<r;n++)a=i[n],s=e.ElementMaterial.mapUrl[a],o.push(s);return o}return null},createAtlas:function(e,r){var n,a=new i;if(t.is(this._ids[r])){var s=this._ids[r].datavizRenderings;if(t.is(s)){var l,d,u=Object.keys(s),f=u.length;for(l=0;l<f;l++)d=s[u[l]],a.addOver(d)}var h=this._ids[r].materialIndex;if(t.is(h)){var g=this._materials[h];t.is(g)&&a.addOver(g)}var c=a.getAllValuesForAttribute("mapUrl");if(n=this.getMapsArrayFromRender(c),t.is(n)&&n.length>1){var p=this;o.makeAtlasFromUrls(n,function(e){var t={Ids:r,Material:{map:e}};p._parseOneRenderingGroup(t)})}else this._renderIds([r])}},clearRendering:function(e){this.emptyRendering(e),delete this._ids[e]},emptyRendering:function(e){this._resetLayerDatavizRendering(e),this.removeRendering(e)}})}),define("DS/XCityRendering/RenderingHandlerPrimitive",["DS/Visualization/ThreeJS_DS","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerDownload","DS/XCityTools/EventDispatcher"],function(e,t,i,r,n,a){"use strict";return n.extend({init:function(e,t){this._parent(e,t)},getElementMaterialInfoFromLayer:function(e){var t,n={};return i._setMaterialFromProfile(n,this.defaultMaterial),i._setMaterialFromProfile(n,this.currentMaterial),r.is(this._elementRendering)&&r.is(this._elementRendering._ids[e])&&(t=this._elementRendering._ids[e],i._setMaterialFromProfile(n,this._elementRendering._materials[t])),n},initMesh:function(e){this._parent(e),r.is(e)&&this.applyElementRendering(e)},mustRedrawPrimitive:function(){return!this.mustRedrawDataviz()&&(this.currentRendering.hasPrimitiveRendering()||this.lastRendering.hasPrimitiveRendering())},getPrimitiveRenderingValuesOrOriginal:function(e){var t=this.getPrimitiveRenderingValues(e);return r.is(t)||(t=this._primitives[e].originalMaterial),t},applyElementRendering:function(e){var t,i,n,a;if(!this.applyElementRenderingAll(e)&&r.is(this._primitivesMeshes)&&this.mustRedrawPrimitive()&&(t=this._primitivesMeshes[e.id],r.is(t))){var s,o=!1,l=Object.keys(t),d=l.length;for(s=0;s<d;s++)n=l[s],r.is(n)&&(i=t[n],r.is(i)&&(a=this.getPrimitiveRenderingValuesOrOriginal(n),this.applyRenderingToPrimitive(e,a,i,n),r.is(a.opacity)&&a.opacity<1&&(o=!0)));this.handleMaterialTransparent(e,o)}},handleMaterialTransparent:function(e,i){var n=e.material;if(r.is(n)){var a=!1;if(i)a=!0;else a=this.getCompleteMaterialInfo().opacity<1,void 0!==n.opacityFactor&&n.opacityFactor<1&&n.useOpacityFactor&&(a=!0);n.transparent=a,t.updateCommonUniforms(n)}},applyRenderingToPrimitive:function(t,i,n,a){var s,o;if(r.is(t.setRendering)){if(r.is(i))for(var l=0;l<n.length;++l)t.setRendering(i,n[l],a)}else r.is(i.color)&&(r.is(t.setColor)?(s=t.setColor(i.color,n,a),r.is(this._primitives[a].originalMaterial.color)||(this._primitives[a].originalMaterial.color=new e.Color,this._primitives[a].originalMaterial.color.copy(s))):console.warn("this mesh does not have the setColor method")),r.is(i.opacity)&&(r.is(t.setOpacity)?(o=t.setOpacity(i.opacity,n,a),r.is(this._primitives[a].originalMaterial.opacity)||(this._primitives[a].originalMaterial.opacity=o)):console.warn("this mesh does not have the setOpacity method"))},_getStridFromPrim:function(e){return e.userData.strid||e.strid},addPrimitive:function(e){if(r.is(e)&&r.is(e.geom)&&r.is(e.userData)){var t=this._getStridFromPrim(e);r.is(t)&&r.is(this._primitives[t])&&(this._primitives[t].prim=[],this._primitives[t].prim=e.geom,this._renderprimitive(t))}},_getMainNodeWithMaterial:function(e,t){for(var i=this._primitives[e].prim[t].mesh,r=i;i.parents&&i.parents[0];)i.parents[0].material&&(r=i.parents[0]),i=i.parents[0];return r},_alreadyContains:function(e,t){for(var i=0;i<e.length;i++)if(e[i].getCgmId()===t.getCgmId()&&e[i].getStart()===t.getStart())return!0;return!1},_renderprimitive:function(e){var t,i;if(r.is(this._primitives)&&r.is(this._primitives[e])&&r.is(this._primitives[e].prim)){for(i=0;i<this._primitives[e].prim.length;i++)t=this._getMainNodeWithMaterial(e,i),r.is(t)&&(r.is(this._primitivesMeshes)||(this._primitivesMeshes={}),r.is(this._primitivesMeshes[t.id])||(this._primitivesMeshes[t.id]={}),r.is(this._primitivesMeshes[t.id][e])||(this._primitivesMeshes[t.id][e]=[]),this._alreadyContains(this._primitivesMeshes[t.id][e],this._primitives[e].prim[i].subElement)||this._primitivesMeshes[t.id][e].push(this._primitives[e].prim[i].subElement),this.applyElementRendering(t));a.publish("/xCity/needRender",this)}},registerPrimitive:function(e,t){if(r.is(t)&&r.is(e)&&(r.is(this._primitives)||(this._primitives={}),!r.is(this._primitives[t]))){this._primitives[t]={originalMaterial:{}};var i=this.addPrimitive.bind(this);e.register(t,i)}},removeMesh:function(e){var t,i,n,a,s,o,l;if(this._parent(e),r.is(this._primitivesMeshes)&&r.is(this._primitivesMeshes[e])&&(a=this._primitivesMeshes[e],this._primitivesMeshes[e]=null),r.is(this._primitives)&&r.is(a))for(o=(s=Object.keys(a)).length,l=0;l<o;l++)if(t=s[l],r.is(this._primitives[t])&&(i=this._primitives[t].prim,r.is(i))){var d=[];for(n=0;n<i.length;n++)i[n].mesh.id!==e&&d.push(i[n]);this._primitives[t].prim=d}}})}),define("DS/XCityRendering/RenderingProfileManager",["DS/XCityCore/ProfileManager","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/xCityBasicUtils/Utils","DS/XCityCore/Terrain","DS/XCityTools/EventDispatcher","DS/XCityRendering/RenderingProfile","DS/XCityRendering/Rendering"],function(e,t,i,r,n,a,s,o){"use strict";return e.extend({init:function(e){this._parent(e,"rendering"),this.defaultProfile="UrbanDefault",this.defaultNewProfile="renderingProfile",this.SkyId="Sky",this.GroundId="Ground";var t=this.getProfile(this.defaultProfile);r.is(t)||((t=this.createProfile(this.defaultProfile)).setAsInternal(!0),this.dispatchAddedEvent(this.defaultProfile)),this.addProfile(t.getName(),t.resetRender,t,"RenderingGroup"),t._materials={},t._materials[0]=null,this._initSessionProfile()},_initEnvironment:function(e){var t=this.getDefaultProfile();t._parseEffects({name:t.getName()},e)},_initSessionProfile:function(){this.sessionProfileName="defaultProfile",this._sessionProfile=this.getProfile(this.sessionProfileName),r.is(this._sessionProfile)||(this._sessionProfile=this.createProfile(this.sessionProfileName),this._sessionProfile.setAsRemovable(!1),this._sessionProfile.setAsDeactivable(!1),this.dispatchAddedEvent(this.sessionProfileName)),this.addProfile(this._sessionProfile.getName(),this._sessionProfile.setRender,this._sessionProfile,"RenderingGroup")},dispatchAddedEvent:function(e){a.publish(a.eventsList.renderingProfileAdded,e)},dispatchRemovedEvent:function(e){a.publish(a.eventsList.renderingProfileRemoved,e)},_getSessionProfile:function(){return this._sessionProfile},getProfileNames:function(){return this._parent()},_getSky:function(){return this._urban.getEnvironment().sky},setProfile:function(e,t){e!==this.getCurrentProfileName()&&(e!==this.defaultProfile&&this._parent(this.defaultProfile),this._parent(e,t)&&a.publish(a.eventsList.renderingProfile,e))},_parseOneProfile:function(e){var t=this.getProfile(e.name),i=!1;r.is(t)||(t=this.createProfile(e.name),i=!0),t._parseEffects(e,this._urban.getEnvironment()),t._parseConfig(e),t._parseRendering(e),i&&this.dispatchAddedEvent(e.name)},_getGeometry:function(e){var t=null;if(e===this.SkyId)t=this._getSky();else{this._urban.modelRoot.traverse(function(i){var n=i.id;if(n&&e===n){var a=i.get("Content");r.is(a)&&r.is(a.getRendering)&&(t=a)}},!0)}return r.is(t)?t:null},_createProfile:function(e,t){return new s(e,t)},getAllRenderIds:function(){var e,t=[];if(r.is(this._generics)){var i=Object.keys(this._generics);for(e=0;e<i.length;e++)t.push(i[e])}return t},getAllNamesandIds:function(){var e={};this._urban.modelRoot.traverse(function(e,t){var i=e.id,n=e.get("name");if(i&&n&&!r.is(t[n])){var a=e.get("Content");if(r.is(a)&&r.is(a.getRendering)){var s=a.getRendering();r.is(s)&&(t[n]=i)}}},!0,e);var t=e;return t[this.GroundId]=this.GroundId,t},_updateRenderID:function(e){var t=this.getCurrentProfile(),i=e.getRendering();r.is(i)&&i.setContent(e);var n=e.get("renderID");if(r.is(n)&&""!==n&&this.addGenericMap(e.id,n),r.is(t)){var a=t.getReferencedId(e);if(r.is(a)){var s=t._ids[a].materialIndex;t._materials[s],this.setRender(t._ids,t._materials)}}},initRendering:function(e){if(r.is(e)){var t=e.get("id");t!==this.SkyId&&t!==this.GroundId||console.warn("Id "+t+" is reserved, its use could present rendering problems ");var i=e.getRendering();r.is(i)&&i.setContent(e),e.fromGeometrySet&&"FactoryLine"===e._factory._node.name?e._itemParent.getContent().addEvent("onChange:renderID",this.updateFeatureRendering.bind(this),e._itemParent.getContent()):(e.addEvent("onChange:renderID",this.updateFeatureRendering.bind(this),e),e.addEvent("onChange:id",this.updateFeatureRendering.bind(this),e)),this.updateFeatureRendering(e)}},addGenericMap:function(e,t){r.is(this._generics)||(this._generics={}),r.is(this._generics[t])||(this._generics[t]=[]),r.is(e)&&this._generics[t].push(e)},getRenderingProfileAndId:function(e,t,i){var n;if(r.is(t)&&""!==t&&!r.is(i)){if(n=this.getStylingProfile(),!r.is(n))return;e=t}else if(n=this._getSessionProfile(),!r.is(n))return;return{profile:n,featureId:e}},addRendering:function(e,t,i,r){let n=this.getRenderingProfileAndId(e,r,i);return n.profile.addRendering(n.featureId,t,i)},addFilterRendering:function(e,t,i,r){let n=this.getRenderingProfileAndId(e,r);return n.profile.addFilterRendering(n.featureId,t,i)},addDatavizRendering:function(e,t,i){let r=this.getRenderingProfileAndId(e,i);return r.profile.addDatavizRendering(r.featureId,t)},updateDatavizRendering:function(e,t,i,r,n,a){this.getRenderingProfileAndId(e,a).profile.updateDatavizRendering(t,i,r,n)},deleteDatavizRendering:function(e,t,i){this.getRenderingProfileAndId(e,i).profile.deleteDatavizRendering(t)},addPrimitiveRenderingNoDraw:function(e,t,i){var n=this._getSessionProfile();r.is(n)&&n.addOnlyRendering(e,t,i)},renameProfile:function(e,t){this._parent(e,t)&&a.publish(a.eventsList.renderingProfile,t)},setDefaultProfile:function(){return this.setProfile(this.getDefaultProfile().getName())}})}),define("DS/XCityRendering/RenderingManager",["DS/XCityRendering/RenderingProfileManager","DS/xCityBasicUtils/Utils","DS/XCityTools/LayerList","DS/XCityRendering/FeatureRendering","DS/XCityRendering/PrimitiveRendering","DS/XCityCore/Terrain","DS/XCityModel/LayerVectorPrimitive","DS/XCityRendering/SLDParser","DS/XCityTools/EventDispatcher","DS/XCityTools/OGCFilter"],function(e,t,i,r,n,a,s,o,l,d){"use strict";return e.extend({init:function(e){this._parent(e),this.HeatMapToolId="3DXCityHeatMapTool",this._IdstoUpdate={}},setRender:function(e){this.addToIdstoUpdate(e),this.renderScene(this._IdstoUpdate),this._IdstoUpdate={}},addToIdstoUpdate:function(e){if(t.is(e)){var i,r,n,a;if("string"==typeof e)i=e,(e={})[i]=!0;else if(Array.isArray(e)){for(r=e.length,i={},n=0;n<r;n++)i[a=e[n]]=!0;e=i}var s=Object.keys(e);for(r=s.length,n=0;n<r;n++)a=s[n],this._IdstoUpdate[a]=!0}},resetRender:function(e){this.setRender(e)},renderScene:function(e){var i=this.getGeomFromIds(e);t.is(i)&&i.length>0&&(this.updateGeomRenderings(i),this.redrawGeoms(i))},getIdFromGeom:function(e){if(t.is(e)){if(t.is(e.id))return e.id;if(e===this.getGroundGeom())return this.GroundId;if(e===this.getSkyGeom())return this.SkyId}},redrawGeoms:function(e){var t,i,r=e.length,n={};for(t=0;t<r;t++){i=e[t],n[this.getIdFromGeom(i)]=i,i.redraw(),l.publish("/xCity/needRender",this)}},getActiveRenderingsForGeoms:function(e,i=[]){for(var n=this.getOrderedIdsFromGeoms(e),a=[],s=i&&i.length>0?i:this.getActiveProfiles(),o=0;o<n.length;o++){for(var l=n[o],d=new r,u=0;u<s.length;u++){var f=s[u],h=this.getCurrentRenderingForOneProfile(l,f);t.is(h)&&(d._priorityClean(h.getRenderingData()),d.addOver(h))}a.push(d)}return a},getGeomFromIds:function(e){var i=[];this.getNonDataModelGeoms(e,i);return this._urban.modelRoot.traverse(function(e,r){var n=e.get("Content");if(t.is(n)&&!(n instanceof s)){var a=!1;if(t.is(n.getRendering)){var o=n.getRendering();if(t.is(o)){var l,d=o.getIds(),u=d.length;for(l=0;l<u;l++){var f=d[l];if(t.is(r[f])){a=!0;break}}}}else{var h=e.id;h&&t.is(r[h])&&(a=h);var g=n.id;if(g&&!a&&t.is(r[g])&&(a=g),!a){var c=n.get("renderID");t.is(c)&&""!==c&&t.is(r[c])&&(a=c)}}a&&i.push(n)}},!0,e),i},getNonDataModelGeoms:function(e,t){this.getGroundAndSkyGeoms(e,t),this.getHeatMapGeom(e,t)},getHeatMapGeom:function(e,i){var r;t.is(e[this.HeatMapToolId])&&(r=this.getHeatMapGeometry(),t.is(r)&&i.push(r))},getGroundAndSkyGeoms:function(e,i){var r;t.is(e[this.GroundId])&&(r=this.getGroundGeom(),t.is(r)&&i.push(r)),t.is(e[this.SkyId])&&(r=this.getSkyGeom(),t.is(r)&&i.push(r))},getHeatMapGeometry:function(){return this._heatMapGeom},getGroundGeom:function(){return a},getSkyGeom:function(){return this._urban.getEnvironment().sky},getOrderedIdsFromGeoms:function(e){var t,i,r=[],n=e.length;for(t=0;t<n;t++)i=e[t].getRendering(),r[t]=i.getIds();return r},getIdsFromGeom:function(e){var t,i,r,n,a={},s=e.length;for(t=0;t<s;t++)for(r=(i=e[t].getRendering().getIds()).length,n=0;n<r;n++)a[i[n]]=!0;return a},getActiveRenderingsFromIds:function(e){var t,i,r={},n=Object.keys(e),a=n.length;for(t=0;t<a;t++)r[i=n[t]]=this.getCurrentRenderingForOneId(i);return r},getCurrentRenderingForOneId:function(e){var i,n,a=new r,s=this.getActiveProfiles(),o=s.length;for(i=0;i<o;i++)n=s[i],t.is(n)&&n.getRenderingForId(e,a);return a},getCurrentRenderingForOneProfile:function(e,t){var i,n,a=e.length,s=new r;for(n=a-1;n>=0;n--)i=e[n],t.getRenderingForId(i,s);return s},combineRenderingForGeom:function(e,t){var i,r,n=[],a=e.length;for(i=0;i<a;i++)r=e[i].getRendering().getIds(),n.push(this.getRenderingFromIdList(r,t));return n},getRenderingFromIdList:function(e,i){var n,a,s=e.length,o=new r;for(n=s-1;n>=0;n--)a=i[e[n]],t.is(a)&&o.addOver(a);return o},setOIT:function(e){this._oitStatus=e;var t=this._urban.getView3D();void 0===t.ugVisu||"WINDOW"!==t.ugVisu.mode_&&!t.ugVisu.selecting_window_?t.setOIT(e):t.setOIT(!1)},applyOIT:function(){t.is(this._oitStatus)&&this.setOIT(this._oitStatus)},handleOITActivation:function(e,r){var n,a,s,o=r.length;for(t.is(this._OITList)||(this._OITList=new i,this._OITList.setEmptyCallbacks(this.setOIT.bind(this,!1),this.setOIT.bind(this,!0))),n=0;n<o;n++)s=e[n],a=r[n].get("opacity"),t.is(a)&&(a<=.99?this._OITList.addlayerToList(s):this._OITList.removeLayerFromList(s));this.applyOIT()},updateGeomRenderings:function(e){var t=this.getActiveRenderingsForGeoms(e);this.handleOITActivation(e,t);var i,r,n,a,s=e.length;for(i=0;i<s;i++)if(r=e[i],n=t[i],(a=r.getRendering()).updateRendering(n),a.hasPrimitiveRendering()){var o=a.getPrimitiveRenderings();r.registerPrimitives(o)}},getProfileRenderingData:function(e,t){return this.getCurrentRenderingForOneId(e).getCompleteMaterialInfo(t)},getRenderingData:function(e,i){var r=this._getGeometry(e);if(!t.is(r))return this.getProfileRenderingData(e,i);if(t.is(r.getRendering)){var n=r.getRendering();if(t.is(n))return n.getCompleteMaterialInfo(i)}},renderPrimitive:function(e,i){var r=this._getGeometry(e);if(t.is(r)){var n=r.getRendering();if(t.is(n)){var a=this.getCurrentRenderingForPrimitive(e,i);n.updatePrimitiveRendering(a),r.redrawPrimitive(i)}}else console.log("Feature does not exist yet for this primitiverendering")},getCurrentRenderingForPrimitive:function(e,i){var r=new n;r.addOverIds(i);var a,s,o=this.getActiveProfiles(),l=o.length;for(a=0;a<l;a++)s=o[a],t.is(s)&&s.getRenderingForPrimitive(e,i,r);return r},updateFeatureRendering:function(e){var i=e.getRendering();if(t.is(i)){var r=e.get("renderID");t.is(r)&&""!==r&&this.addGenericMap(e.id,r),i.setContent(e);var n=[e];this.updateGeomRenderings(n),this.redrawGeoms(n)}},initGroundRendering:function(e){var i=e.getRendering();t.is(i)&&i.setContent(e)},resetPrimitive:function(e,i){var r=this.getTopProfile(),n=!1;return t.is(r)&&(n=r._resetRendering(e,i)),n},resetPrimitiveAttributeOnly:function(e,i,r){var n=this.getTopProfile(),a=!1;return t.is(n)&&(a=n._resetPrimitiveAttribute(e,i,r)),a},resetAttributeOnly:function(e,i){var r=this.getTopProfile(),n=!1;return t.is(r)&&(n=r._resetLayerAttribute(e,i)),n},_parseSLD:function(e,t,i){var r=(new o).parseSLD(e,i);this.getResourceProfile().addSLDRenderings(t,r)},_parseSLDInfos:function(e,i,r){var n,a,s,l=JSON.parse(e),d={};if(!(t.is(l)&&Array.isArray(l)&&l.length>0))throw new Error("JSON is not an array");for(s=0;s<1;s++){var u=l[s];u.geoItemSourceUuid;n=u.content,a=(new o).parseSLD(n,r),d=Object.assign(d,a)}this.getResourceProfile().addSLDRenderings(i,d)},getResourceProfile:function(){return t.is(this._resourceProfile)||this._initResourceProfile(),this._resourceProfile},_initResourceProfile:function(){this._resourceProfileName="3DXCityResourceProfile",this._resourceProfile=this.createProfile(this._resourceProfileName),this._resourceProfile.setAsInternal(!0),this.dispatchAddedEvent(this._resourceProfileName),this.addProfile(this._resourceProfile.getName(),this._resourceProfile.setRender,this._resourceProfile,"RenderingGroup"),this._resourceProfile.enable()},getActiveProfiles:function(){var e=[],i=this.getDefaultProfile(),r=this.getCurrentProfile(),n=this.getSessionProfile(),a=this.getStylingProfile();e.push(i),t.is(this._resourceProfile)&&e.push(this._resourceProfile);var s=!1;if(t.is(r)){var o=r.getName();o!==i.getName()&&o!==n.getName()&&o!==a.getName()&&(r.isTemporary()?s=!0:e.push(r))}return n.isEnabled()&&e.push(n),a.isEnabled()&&e.push(a),s&&e.push(r),e},newgetActiveProfiles:function(){var e,t,i,r,n,a,s=Object.keys(this._profiles),o=[];for(e=0;e<s.length;e++)if(r=s[e],(i=this._profiles[r]).isEnabled())if(o[n=i.level]||(o[n]=[],o[n].push(i)),a)for(t=0;t<a.length;t++)a[t]>n&&a.splice(t,0,n);else a=[n];var l=[];for(e=0;e<a.length;e++)l.push(o[a[e]]);return l},_initSessionProfile:function(){this._parent(),this._defaultRenderingProfileName=this.sessionProfileName,this._defaultRenderingProfile=this._sessionProfile,this.sessionProfileName="sessionProfile",this._sessionProfile=this.getProfile(this.sessionProfileName),t.is(this._sessionProfile)||(this._sessionProfile=this.createProfile(this.sessionProfileName),this._sessionProfile.setAsRemovable(!1),this._sessionProfile.setAsDeactivable(!1),this.dispatchAddedEvent(this.sessionProfileName)),this.addProfile(this._sessionProfile.getName(),this._sessionProfile.setRender,this._sessionProfile,"RenderingGroup"),this._sessionProfile._enabled=!0,this._initStylingProfile()},_initStylingProfile:function(){this._parent(),this.stylingProfileName="stylingProfile",this._stylingProfile=this.getProfile(this.stylingProfileName),t.is(this._stylingProfile)||(this._stylingProfile=this.createProfile(this.stylingProfileName),this._stylingProfile.setAsRemovable(!1),this._stylingProfile.setAsDeactivable(!1),this.dispatchAddedEvent(this.stylingProfileName)),this.addProfile(this._stylingProfile.getName(),this._stylingProfile.setRender,this._stylingProfile,"RenderingGroup"),this._stylingProfile._enabled=!0,this._stylingProfile.setAsTemporary(!0)},getDefaultProfile:function(){return this._defaultRenderingProfile},_getSessionProfile:function(){return this._sessionProfile},getSessionProfile:function(){return this._getSessionProfile()},getStylingProfile:function(){return this._stylingProfile||this._initStylingProfile(),this._stylingProfile},getTopProfile:function(){return this.getSessionProfile()},resetAllPrimitivesRendering:function(e,i){if(t.is(e)){var r=this.getSessionProfile();t.is(r)&&r.resetAllPrimitivesRendering(e,i),this.resetRenderPrimitives(e)}},resetRenderPrimitives:function(e){this.addToIdstoUpdate(e);var t=this.getGeomFromIds(this._IdstoUpdate);this.resetGeomFlags(t),this.redrawGeoms(t)},rebuildGeomRenderings:function(e){var t,i=e.length;for(t=0;t<i;t++)e[t].getRendering().flagAsRebuilt(!1)},resetGeomFlags:function(e){var i,r,n=e.length;for(i=0;i<n;i++)r=e[i],t.is(r.resetFlags)&&r.resetFlags()},getActiveRenderingProfilesNames:function(){var e,t=this.getActiveProfiles(),i=[],r=t.length;for(e=0;e<r;e++)i.push(t[e].getName());return i},addStyleToResource:function(e,t){var i=this.getResourceProfile(),r=Object.assign({Ids:e},t);i._parseOneRenderingGroup(r)},resetRenderingAttribute:function(e,t){this.resetAttributeOnly(e,t),this.setRender([e])},getActiveRenderingsForGeomByProfile:function(e){for(var i=e.getRendering().getIds(),r=null,n=[],a=this.getActiveProfiles(),s=0;s<a.length;s++){var o=a[s],l=this.getCurrentRenderingForOneProfile(i,o);if(t.is(l)){for(var d=l.getRenderingData(),u=0;u<s;u++){var f=n[u];f&&f._priorityClean(d)}n.push(l),r||(r={}),r[o.getName()]=l}}return r},getCurrentRenderingForPrimitiveByProfile:function(e,i){var r,a,s,o=e.getRendering().getIds(),l=this.getActiveProfiles(),d=l.length,u=null;for(r=0;r<d;r++)if(s=l[r],t.is(s)){for(a=o.length-1;a>=0;a--){var f=o[a],h=new n;h.addOverIds(i),s.getRenderingForPrimitive(f,i,h)}u||(u={}),u[s.getName()]=h}return u},emptyRendering:function(e){var t=this.getStylingProfile();t.emptyRendering(e),(t=this.getSessionProfile()).emptyRendering(e)}})}),define("DS/XCityRendering/RenderingHandlerDataviz",["DS/XCityTools/RenderingTools","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerPrimitive"],function(e,t,i){"use strict";return i.extend({init:function(e,t){this._parent(e,t)},mustRedrawDataviz:function(){return this.currentRendering.hasDatavizRendering()||this.lastRendering.hasDatavizRendering()},applyElementRenderingAll:function(e){var t=!1;return e.setRendering&&this.mustRedrawDataviz()?t=this.applyPrimitiveDataVizRendering(e):t},getAllPrimitiveRenderings:function(e,t,i){for(var r,n=[],a=0;a<t.records.length;a++)(r=t.records[a]).strid,n.push(r.userData);return this.getMappings(n)},applyAllPrimitiveDataVizRendering:function(e){var i,r=!1,n=t.getDataSource(e);if(t.is(n)){var a=!1,s=this.getAllPrimitiveRenderings(e,n,a);t.is(s)&&s.length>0&&(this.setRenderingList(s,n.records,null,e),r=!0,i=s[0],t.is(i.opacity)&&i.opacity<1&&(a=!0),a&&this.handleMaterialTransparent(e,!0))}return r},hasOnlyMappingDataviz:function(){var e=!0;return this.currentRendering.hasDatavizRendering()?this.currentRendering.hasPrimitiveRendering()?e=!1:this.currentRendering.hasFilterDataviz()&&(e=!1):e=!1,e},applyPrimitiveDatavizRenderingFromRecord:function(e,i){if(t.is(i)&&t.is(i.strid)&&t.is(i.userData)){var r=this.getPrimitiveRenderingValues(i.strid,i.userData);if(t.is(r))if(Object.keys(r).length>0&&t.is(i.geom))for(var n=i.geom.length,a=0;a<n;a++){var s=i.geom[a].subElement;e.setRendering(r,s,i.strid)}}},useDatavizMappingOptim(e){return t.is(this.setRenderingList)&&this.hasOnlyMappingDataviz()&&!this.currentRendering.hasDatavizOnAttribute("label")},applyPrimitiveDataVizRendering:function(e){var i,r,n,a,s,o=!1,l=t.getDataSource(e);if(t.is(l)){if(this.useDatavizMappingOptim(e))return this.applyAllPrimitiveDataVizRendering(e);for(var d=!1,u=0;u<l.records.length;u++)if(n=(a=l.records[u]).strid,s=a.userData,r=null,t.is(a.geom)&&t.is(a.geom.length>0)){i=this.getPrimitiveRenderingValues(n,s),t.is(i.opacity)&&i.opacity<1&&(d=!0);for(var f=a.geom.length,h=0;h<f;h++)r=a.geom[h].subElement,e.setRendering(i,r,n),o=!0}else{var g=function(t){this.applyPrimitiveDatavizRenderingFromRecord(e,t)}.bind(this);t.is(a.listeners)||(a.listeners=[]),a.listeners.push(g)}d&&this.handleMaterialTransparent(e,!0)}return o},interpretRendering:function(t,i){return e._interpretRendering(t,null,i)}})}),define("DS/XCityRendering/RenderingHandler3D",["DS/XCityTools/ShaderTools","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerDataviz","DS/XCityRendering/Rendering","DS/XCityRendering/FeatureRendering","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/ColorGradient","DS/XCityTools/RenderingTools"],function(e,t,i,r,n,a,s,o){"use strict";return i.extend({init:function(e,i,r){this._parent(e,i),this.defaultRendering=new n,this.lastRendering=new n,this.currentRendering=new n;var o={Material:{opacity:1,wireframe:!1,alphaTest:0,side:a.FrontSide,specular:new s(new a.Color("#000000")),ambient:new s(new a.Color("#FFFFFF")),diffuse:new s(new a.Color("#FFFFFF")),depthTest:!0,depthWrite:!0,shininess:1,color:new s(new a.Color("#FFFFFF")),renderingDescription:""},ElementRendering:[{ElementIds:this._allIds,ElementMaterial:{color:new s(new a.Color("#FFFFFF")),opacity:1}}]};t.is(r)&&(this.defaultRendering.addOver(r.defaultRendering),this._content=r._content,this.currentRendering.addOver(r.currentRendering)),this.defaultRendering.addOver(o),this.defaultRendering.addOver(this.getDefaultRendering()),this.initInputParams()},getDefaultRendering:function(){},updateRendering:function(e){this.lastRendering.copy(this.currentRendering);var t=e;this.currentRendering.copy(t),this._completeFeatureRendering=null,this._needRebuild=this._needRebuild||this.shouldRebuild(this.lastRendering,this.currentRendering);this._parent(e);this.updateContentRendering()},updateContentRendering:function(){if(t.is(this._content)){var e=new n;e.addOver(this.defaultRendering),e.addOver(this.currentRendering);var i=e.toJSON();this._content.set("Rendering",i)}},updatePrimitiveRendering:function(e){this.currentRendering.addOver(e)},getFeatureRendering:function(){var e=new r;return e.addOver(this.defaultRendering),e.addOver(this.currentRendering),e},getMappings:function(e){return t.is(this._completeFeatureRendering)||(this._completeFeatureRendering=new n(this.defaultRendering),this._completeFeatureRendering.addOver(this.currentRendering)),this._completeFeatureRendering.getMappings(e)},getPrimitiveRendering:function(e,t){var i=new r,n=this.defaultRendering.getPrimitiveRendering(e,t);i.addOver(n);var a=this.currentRendering.getPrimitiveRendering(e,t);return i.addOver(a),i},applyFeatureRenderingToMaterial:function(t){var i=this.getCompleteMaterialInfo();o._setMaterialFromProfile(t,i),o._setMaterialMapFromProfile(t,i,this),e.updateCommonUniforms(t),this._lastSeenMaterial=t},applyRendering:function(e){if(t.is(e)){this._parent(e);var i,r,n=!0;if(e.children&&(r=e.children.length)>0)for(n=!1,i=0;i<r;i++)this.isMeshToConsider(e.children[i])&&this.applyRenderingToMesh(e.children[i]);n&&this.isMeshToConsider(e)&&this.applyRenderingToMesh(e)}},isMeshToConsider:function(e){return!(!e||void 0===e.mesh3js)},applyRenderingToMesh:function(e){this.applyFeatureRenderingToMesh(e),this.applyPrimitiveRenderingToMesh(e)},applyFeatureRenderingToMesh:function(e){this.updateMesh(e)},updateMesh:function(e){this.initMesh(e)},applyPrimitiveRenderingToMesh:function(e){this.applyElementRendering(e)},hasAttribute:function(e){return!(!t.is(this.defaultRendering)||void 0===this.defaultRendering.get(e))},getCompleteMaterialInfo:function(e,t){var i=this.defaultRendering.getCompleteMaterialInfo(e,t),n=this.currentRendering.getCompleteMaterialInfo(e,t),a=new r(i);return a.addOver(n),a.getRenderingData()},_getMaterialInfo:function(){return this.getCompleteMaterialInfo()},getDefaultRenderingData:function(){return this.defaultRendering.getRenderingData()},getPrimitiveRenderings:function(){return this.currentRendering.getPrimitiveRenderings()},hasPrimitiveRendering:function(){return this.currentRendering.hasPrimitiveRendering()},isPrimitiveRegistered:function(e){var i=!1;return t.is(this._primitives)&&t.is(this._primitives[e])&&(i=!0),i},getListRenderingAttributes:function(){var e=this.getDefaultRenderingData();return Object.keys(e)},getCurrentRenderingDifference:function(e,t){return this.currentRendering.getCompleteMaterialInfo(e,t)},initInputParams:function(){var e=this.getInputRendering();this.defaultRendering.addOverNoAdd(e)},getInputRendering:function(){var e=new r;if(t.is(this._inputParam)){var i=this._inputParam;e.addOver(i)}return e},getRenderingValues:function(e,t){return this.getCompleteMaterialInfo(e,t)},getPrimitiveRenderingValues:function(e,t){return this.getPrimitiveRendering(e,t).getRenderingData()},getFlagForPrimitive:function(e,i){var r=0;if(e){var n=this.getPrimitiveRenderingValues(e,i);t.is(n.color)&&(r+=1),t.is(n.opacity)&&(r+=2)}return r},_getAllFixedValuesForAttribute:function(e){var i,r,n,a,s,o;if(i=this.currentRendering.getAllValuesForAttribute(e),t.is(i)||(i=this.defaultRendering.getAllValuesForAttribute(e)),t.is(i)){var l=[];if(t.is(i.Material)&&l.push({isPrimitive:!1,value:i.Material[e]}),t.is(i.DatavizMaterial))for(n=(r=Object.keys(i.DatavizMaterial[e])).length,a=0;a<n;a++)s=r[a],o=i.DatavizMaterial[e][s],l.push({isPrimitive:!0,value:o});if(t.is(i.ElementMaterial))for(n=(r=Object.keys(i.ElementMaterial[e])).length,a=0;a<n;a++)s=r[a],o=i.ElementMaterial[e][s],l.push({isPrimitive:!0,value:o});return l}return null},onTextureDownloadStart:function(e,t,i){},getDefaultPrimitiveRenderingData:function(){return this.defaultRendering.getPrimitiveRendering(this._allIds).getRenderingData()},getListPrimitiveRenderingAttributes:function(){var e=this.getDefaultPrimitiveRenderingData();return Object.keys(e)}})}),define("DS/XCityRendering/RenderingHandlerAtlasing",["DS/XCityRendering/RenderingHandler3D","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/Visualization/ThreeJS_DS","DS/XCityTools/TextureManager","DS/XCityTools/TextureTools"],function(e,t,r,n,a,s){"use strict";var o=e.extend({init:function(e,t,i){this.atlasId=null,this.enableAtlasing=!1,this._parent(e,t,i)},_getMapsFromRendering:function(e,i,r){var n,a,s,o;if(t.is(i.Material)&&(r[i.Material[e]]=!0),t.is(i.DatavizMaterial))for(a=(n=Object.keys(i.DatavizMaterial[e])).length,s=0;s<a;s++)o=n[s],r[i.DatavizMaterial[e][o]]=!0;if(t.is(i.ElementMaterial))for(a=(n=Object.keys(i.ElementMaterial[e])).length,s=0;s<a;s++)o=n[s],r[i.ElementMaterial[e][o]]=!0},getAllMapsToAtlas:function(){var e;e=this.currentRendering.getAllValuesForAttribute("mapUrl");var i=[],r={};t.is(this._mapUrls)&&(r=Object.assign(this._mapUrls));var n,a,s,o;for(t.is(e)&&this._getMapsFromRendering("mapUrl",e,r),e=this.defaultRendering.getAllValuesForAttribute("mapUrl"),t.is(e)&&this._getMapsFromRendering("mapUrl",e,r),i=[],a=(n=Object.keys(r)).length,s=0;s<a;s++)o=n[s],i.push(o);return i.length>0?i:null},_createAtlasFromUrlsList:function(e){t.is(e)&&e.length>1?(this.atlasId=a.makeAtlasFromUrls(e),this.currentRendering.set("mapAtlasId",this.atlasId),this._needRebuild=!0):(this.atlasId&&(this._needRebuild=!0),this.atlasId=null)},updateCurrentMaps:function(){if(!0===this.enableAtlasing){var e=this.getAllMapsToAtlas();this._createAtlasFromUrlsList(e)}},updateRendering:function(e){this._parent(e),this.updateCurrentMaps()},getIndexForTextureUrl:function(e){return t.is(this.atlasId)?a.getTextureIndex(this.atlasId,e):0},addAtlasUniforms:function(e){var i=a.getAtlasDescription(this.atlasId);if(t.is(i)){var o,l=[];for(o=0;o<Math.min(i.x.length,a.ATLASSIZE);o++){var d=i.x[o],u=i.y[o],f=i.height[o],h=i.width[o],g=new n.Vector4(d,u,f,h);l.push(g)}for(o=i.x.length;o<a.ATLASSIZE;o++)l.push(new n.Vector4);var c=0,p=new Float32Array(4*a.ATLASSIZE);for(o=0;o<a.ATLASSIZE;o++)p[c+0]=l[o].x,p[c+1]=l[o].y,p[c+2]=l[o].z,p[c+3]=l[o].w,c+=4;var _={data:p,xSize:1,ySize:a.ATLASSIZE,name:"atlasOffsetTexture",format:n.RGBAFormat,filter:n.NearestFilter,flipY:!1,generateMipmaps:!1},m=s.createTexture(_);r.updateSingleUniform(e,"atlasOffsetTexture",m)}else a.addCallbackToAtlas(this.atlasId,this.addAtlasUniforms.bind(this,e))},onTextureApplied:function(e,i,n,s){var o=n[s.atlas];t.is(o)||t.is(n[s.atlasId])&&(o=a.getOrDownloadTexture(n[s.atlasId],function(e){if(t.is(e)){i[s.param]=e;var n=i[s.param].image.width;t.is(n)&&r.updateSingleUniform(i,"width",n);var a=i[s.param].image.height;t.is(a)&&r.updateSingleUniform(i,"height",a),r.updateCommonUniforms(i)}}),t.is(o)&&(n[s.atlas]=o)),t.is(o)&&(i[s.param]=o)},updateTextureWhenReady:function(e,i){if(t.is(e)&&t.is(i)){this.updateCurrentMaps();var r=this;t.is(this.atlasId)&&a.addCallbackToAtlas(this.atlasId,function(){var t,n,a,s,o,l=Object.keys(e),d=l.length,u=i.children.length;for(s=0;s<u;s++)for(o=i.children[s],t=0;t<d;t++)n=l[t],a=e[n],r.updateTextureInfo(o,n,a)})}}}),l=0,d=new Float32Array(4*a.ATLASSIZE);for(i=0;i<a.ATLASSIZE;i++)d[l+0]=0,d[l+1]=0,d[l+2]=1,d[l+3]=1,l+=4;var u={data:d,xSize:1,ySize:a.ATLASSIZE,name:"defaultAtlasOffsetTexture",format:n.RGBAFormat,filter:n.NearestFilter,flipY:!1,generateMipmaps:!1};return o.defaultAtlasOffsetTexture=s.createTexture(u),o}),define("DS/XCityRendering/RenderingHandlerSpecific",["DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/Visualization/Mesh3D","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerAtlasing"],function(e,t,i,r,n,a){"use strict";return a.extend({init:function(e,t,i){this._parent(e,t,i)}})}),define("DS/XCityRendering/RenderingHandlerFile",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/XCityRendering/RenderingHandlerSpecific"],function(e,t,i,r,n){"use strict";return n.extend({init:function(e){this._parent(e),this._waitingList=[],this.type="File"},getDefaultRendering:function(){},_createMaterial:function(){var t=i.getCustomShaderMaterial([i.common,i.clipPlanes,i.map,i.alphaTest]);return r._setMaterialFromProfile(t,this.currentMaterial),t.side=e.DoubleSide,this.currentMaterial.map&&(t.map=this.currentMaterial.map,this.currentMaterial.map.shared++),i.updateCommonUniforms(t),t},initMesh:function(r){var n=null;t.is(this.currentMaterial)?n=this._createMaterial():((n=i.getCustomShaderMaterial([i.common,i.clipPlanes,i.map,i.alphaTest])).side=e.DoubleSide,this.texture?(n.map=this.texture,this.texture.shared++):this._waitingList.push(n),i.updateCommonUniforms(n)),r.mesh3js.material=n,r.setMaterial(n),r.setShadow(!0,!0)}})}),define("DS/XCityRendering/RenderingHandlerPointOfInterest",["DS/XCityTools/ShaderTools","DS/Visualization/Mesh3D","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerSpecific"],function(e,t,i,r,n){"use strict";return n.extend({init:function(e,t){this._parent(e,t),this.type="POI"},getDefaultRendering:function(){return{classStyle:"poiText"}}})}),define("DS/XCityRendering/RenderingHandlerSky",["DS/XCityRendering/RenderingHandlerSpecific","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityCore/Terrain"],function(e,t,i,r){"use strict";return e.extend({init:function(e){this._parent(e)},getDefaultRendering:function(){var e={cubeMapUrl:"XCityEnvironment/assets/textures/skybox/plaster",cubeMapExt:".png",slabColor:new t.Color("rgb(152,196,233)")};return this.urban._debugVisualOdt&&(e.cubeMapUrl="XCityEnvironment/assets/textures/skybox/pure_grey"),e},getIds:function(){return["Sky"]},applySkyMaterial:function(e){this.urban.getEnvironment().applySkyMaterial(e)}})}),define("DS/XCityRendering/RenderingHandlerGeometry",["DS/XCityTools/ShaderTools","DS/Visualization/Mesh3D","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerSpecific","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering","DS/Visualization/ThreeJS_DS"],function(e,t,i,r,n,a,s,o){"use strict";return n.extend({init:function(e,t){this._parent(e,t),this.type="Geometry"},getDefaultRendering:function(){return Object.assign({},this._parent(),{scale:new o.Vector3(0,0,0)})},addDefaultScaleFromAttributes:function(e){var t=(new a).propertyName(e).toNumber(),i=new s(null,null,{scale:t});i.addOverIds("3DXCityDefaultIDdefaultScaleAttributeModel"),this.defaultRendering.addOver(i)},shouldRebuild:function(e,t){return!!this._parent(e,t)||!(!t.renderingData.scale||e.renderingData.scale&&t.renderingData.scale.equals(e.renderingData.scale))}})}),define("DS/XCityRendering/RenderingHandlerGround",["DS/XCityRendering/RenderingHandlerSpecific","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher"],function(e,t,i,r){"use strict";return e.extend({init:function(e){this._parent(e)},getDefaultRendering:function(){return this.defaultElevationMin=0,this.defaultElevationMax=200,{showOcean:!1,color:new t.Color("rgb(225,225,225)"),oceanAlpha:1,oceanRangeDetection:.0625,oceanColorDetection:new t.Color("rgb(0,64,102)"),oceanTexture:null,oceanTextureUrl:"XCityEnvironment/assets/textures/ocean/waterNormalsn.jpg",anisotropy:4,oceanTextureParams:{minFilter:"linearmipmaplinear",magFilter:"linear",wrapS:"repeat",wrapT:"repeat"},oceanColor:new t.Color("rgb(47,64,71)"),terrainAnalyzer:{mode:"default",elevationMin:this.defaultElevationMin,elevationMax:this.defaultElevationMax,slopeMin:0,slopeMax:1,gradient:{DCOffset:new t.Vector3(.52,.52,.1),Amplitude:new t.Vector3(.48,-.48,-.11),Frequency:new t.Vector3(-.62,.56,.4),Phase:new t.Vector3(.33,.3,.5)}}}},getIds:function(){return["Ground"]},updateRendering:function(e){this.getCompleteMaterialInfo(),this._parent(e);this.updateDefaultGradient();this.getCompleteMaterialInfo();this.launchChangeEvents()},launchChangeEvents:function(e,t){var n=this.currentRendering.getDifferences(this.lastRendering);i.is(n)&&i.is(n.get("terrainAnalyzer"))&&r.publish(r.eventsList["terrain.terrainAnalyzer"])},updateDefaultGradient:function(){var e=this.getCompleteMaterialInfo().terrainAnalyzer;if(i.is(e)){var r=e.mode;if(i.is(r)){var n={DCOffset:new t.Vector3(.66,.56,.68),Amplitude:new t.Vector3(.718,.438,.72),Frequency:new t.Vector3(.52,.8,.52),Phase:new t.Vector3(-.43,-.397,-.083)},a={DCOffset:new t.Vector3(.52,.52,.1),Amplitude:new t.Vector3(.48,-.48,-.11),Frequency:new t.Vector3(-.62,.56,.4),Phase:new t.Vector3(.33,.3,.5)},s={terrainAnalyzer:{}};"slope"===r?(s.terrainAnalyzer.gradient=n,this.defaultRendering.addOver(s)):"elevation"===r&&(s.terrainAnalyzer.gradient=a,this.defaultRendering.addOver(s))}}},applyFeatureRenderingToMaterial:function(e){this._parent(e),this._updateAnalyzerUniforms(e)},isTerrainAnalyzerActivated:function(){var e=this.getCompleteMaterialInfo().terrainAnalyzer;return void 0!==e.mode&&"default"!==e.mode},_updateAnalyzerUniforms:function(e){if(this.isTerrainAnalyzerActivated()&&i.is(e)){var r,n=this.getCompleteMaterialInfo().terrainAnalyzer,a=e.getPDSFXUniform("mode");if(i.is(a)){var s=-1;"slope"===n.mode?(s=2,r=new t.Vector3(s,n.slopeMin,n.slopeMax)):"orientation"===n.mode?(s=.5,r=new t.Vector3(s,0,0)):"elevation"===n.mode&&(s=-1,r=new t.Vector3(s,n.elevationMin,n.elevationMax)),e.updatePDSFXUniform("mode",r)}if("orientation"!==n.mode){var o=e.getPDSFXUniform("DCOffset");i.is(o)&&e.updatePDSFXUniform("DCOffset",n.gradient.DCOffset);var l=e.getPDSFXUniform("Amplitude");i.is(l)&&e.updatePDSFXUniform("Amplitude",n.gradient.Amplitude);var d=e.getPDSFXUniform("Frequency");i.is(d)&&e.updatePDSFXUniform("Frequency",n.gradient.Frequency);var u=e.getPDSFXUniform("Phase");i.is(u)&&e.updatePDSFXUniform("Phase",n.gradient.Phase)}}},updateElevationMin:function(e){var t={terrainAnalyzer:{elevationMin:e}};this.defaultRendering.addOver(t)},updateElevationMax:function(e){var t={terrainAnalyzer:{elevationMax:e}};this.defaultRendering.addOver(t)}})}),define("DS/XCityRendering/RenderingHandlerLabel",["DS/XCityTools/ShaderTools","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerSpecific","DS/Visualization/ThreeJS_DS","DS/XCityTools/Expression","DS/XCityTools/OGCFilter","DS/XCityRendering/DatavizRendering"],function(e,t,i,r,n,a,s){"use strict";return i.extend({init:function(e,t,i){this._parent(e,t,i),this.addDefaultDatavizLabelName("NAME")},addDefaultDatavizLabelName:function(e){var t={label:{name:(new n).propertyName(e)}},i=(new a).propertyName(e).isNotNull().and((new a).propertyName(e).isNotEqualTo("")),r=new s(null,i,t);r.addOverIds("3DXCityDefaultLabelName"),this.defaultRendering.addOver(r)},getDefaultRendering:function(){return Object.assign({},this._parent(),{label:{enable:!1,name:"",styleName:"default",position:{mode:"billboard",rotation:new r.Vector3(0,0,0),geometryOffset:new r.Vector3(0,0,1),labelOffset:new r.Vector2(0,.5),offset:new r.Vector3(0,0,0),enableAutomaticFlip:!1,isAligned:!1,isRepeated:!1},style:this._getPresetLabelStyle("default")}})},shouldRebuild:function(e,t){return JSON.stringify(t.renderingData.label)!==JSON.stringify(e.renderingData.label)},updatePresetValues:function(e){if(e=this._parent(e),t.is(e)&&t.is(e.label)&&t.is(e.label.styleName)){var i=this._getPresetLabelStyle(e.label.styleName);t.is(i)&&(e.label.style=i)}else t.is(e)&&t.is(e.label)&&t.is(e.label.style)&&this.isChangingCurrentMaterial(e.label.style,this.getRenderingValues().label.style)&&(e.label.styleName="custom");return e},_getPresetLabelStyle:function(e){var t={"background-color":"transparent",border:"medium none color","border-bottom":"medium none color","border-left":"medium none color","border-radius":"0px","border-right":"medium none color","border-top":"medium none color",color:"#FFFFFF","font-family":"Arial","font-size":"12px","font-style":"normal","font-weight":"bold","letter-spacing":"0.5px","line-height":"124%",opacity:"1",padding:"3px 7px","text-align":"left","text-decoration":"none currentcolor solid","text-shadow":"","word-spacing":"normal"};switch(e){case"default":t.color="#ffffff",t["text-shadow"]="-1px -1px 0 rgb(0,0,0), 1px -1px 0 rgb(0,0,0), -1px 1px 0 rgb(0,0,0), 1px 1px 0 rgb(0,0,0), 0 -1px 0 rgb(0,0,0), 0 1px 0 rgb(0,0,0), 1px 0 0 rgb(0,0,0), -1px 0 0 rgb(0,0,0)";break;case"dark":t.color="#3d3d3d",t["text-shadow"]="-1px -1px 0 rgb(255,255,255), 1px -1px 0 rgb(255,255,255), -1px 1px 0 rgb(255,255,255), 1px 1px 0 rgb(255,255,255), 0 -1px 0 rgb(255,255,255), 0 1px 0 rgb(255,255,255), 1px 0 0 rgb(255,255,255), -1px 0 0 rgb(255,255,255)";break;case"basic":t.color="#3d3d3d",t["font-weight"]="normal",t["background-color"]="#ffffff",t.border="solid 1px rgb(61,61,61)",t["border-radius"]="10px";break;case"blue":t["font-family"]="Arial",t.color="#ffffff",t["font-weight"]="normal",t["background-color"]="#005686",t.border="solid 1px  rgb(0,60,90)",t["border-radius"]="10px";break;default:return}return t}})}),define("DS/XCityRendering/RenderingHandlerAltitude",["DS/XCityTools/ShaderTools","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerLabel"],function(e,t,i){"use strict";return i.extend({init:function(e,t,i){this._parent(e,t,i)},getDefaultRendering:function(){return Object.assign({},this._parent(),{elevation:0,elevationOffset:0,elevationMode:"geometry"})},shouldRebuild:function(e,i){if(this._parent(e,i))return!0;var r=i.renderingData.elevation,n=e.renderingData.elevation;if(r!==n)return!0;if((r=i.renderingData.elevationOffset)!==(n=e.renderingData.elevationOffset))return!0;if((r=i.renderingData.elevationMode)!==(n=e.renderingData.elevationMode))return!0;if(i.hasDatavizOnAttribute("elevation"))return!0;let a=i.hasDatavizOnAttribute("elevationOffset")+e.hasDatavizOnAttribute("elevationOffset"),s=i.getDatavizImpactingAttribute("elevationOffset"),o=e.getDatavizImpactingAttribute("elevationOffset");return 2==a&&!t.simpleJSONCompare(s,o)||1==a},getRenderModeFromMesh:function(e){if(e.userData)return e.userData.CityRenderMode},setRenderModeToMesh:function(e,t){e.userData||(e.userData={}),e.userData.CityRenderMode=t}})}),define("DS/XCityRendering/RenderingHandlerElement",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityRendering/RenderingHandlerAltitude","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering"],function(e,t,i,r,n,a){"use strict";var s=r.extend({init:function(e,t,i){this._parent(e,t,i),this.instancing=!1,this.type="Element",this._subRenderingHandler=void 0},setInstancing:function(e){this.instancing=e},getDefaultRendering:function(){return Object.assign({},this._parent())},_initMaterial:function(){return t.is(this._material)||(this._baseMaterial?this._material=i.setPDSFXMaterial(this._baseMaterial,[s._element_PDSFX],"physical"):this._material=i.getPDSFXMaterial([s._element_PDSFX],"physical")),this._material},hasAttribute:function(e){if(t.is(this.defaultRendering)&&void 0!==this.defaultRendering.get(e))return!0;if(this._subRenderingHandler){for(var i=!1,r=0;r<this._subRenderingHandler.length;++r)i=i||this._subRenderingHandler[r].hasAttribute(e);return i}return!1},copyMaterial:function(e){this._baseMaterial||(this._baseMaterial=e)},addToDefaultMaterial:function(e){this.defaultRendering.addOver(e)},addDefaultAltitudeFromAttributes:function(e,i){if(t.is(e))this.defaultRendering.set("elevation",e);else{var r=(new n).propertyName(i),s=new a(null,null,{elevation:r});s.addOverIds("3DXCityDefaultIDdefaultElevationAttributeElement"),this.defaultRendering.addOver(s)}},applyRendering:function(e){if(this._parent(e),this._subRenderingHandler&&e&&e.children)for(var t=0;t<this._subRenderingHandler.length;++t)for(var i=0;i<e.children.length;++i)e.children[i].indexMesh===t&&this._subRenderingHandler[t].applyRendering(e.children[i])},updateMesh:function(e){if(t.is(e)){e.parents[0];this._subRenderingHandler&&e.indexMesh>-1&&e.indexMesh<this._subRenderingHandler.length?this._subRenderingHandler[e.indexMesh].initMesh(e):this.initMesh(e)}},updateRendering:function(e){this._parent(e),this.updateOtherRenderings(e)},updateOtherRenderings:function(e){if(this._subRenderingHandler)for(var t=0;t<this._subRenderingHandler.length;++t)this._subRenderingHandler[t].updateRendering(e)},addSubRenderingHandler:function(e,t){this._subRenderingHandler||(this._subRenderingHandler=[]),this._subRenderingHandler.push(e),e.defaultRendering.addOver(this.defaultRendering),e.updateRendering(this.currentRendering)}});return s._element_PDSFX={attributes:{___transparent:!0},uniforms:{mapCity:{type:"t2",value:i.whiteMap},useMapCity:{type:"b",value:!1},mapCityLoaded:{type:"b",value:!0},diffuseCity:{type:"c",value:new e.Color(16711680)},opacityCity:{type:"f",value:1},alphaTestCity:{type:"f",value:.5}},varyings:{vInstanceColor:{type:"v4",value:new e.Vector4(1,1,1,1)},l_useColor:{type:"f",value:0},l_useOpacity:{type:"f",value:0},l_visibility:{type:"f",value:0}},VS_global_code:["float getFlag(float flags, float row){","    float res = mod(flags, row*2.0); ","    if(res >= row){","       return 1.0;","   }","   return 0.0; ","}"].join("\n"),VS_overridableFunctions:{ComputeVaryingValues:["vInstanceColor = instanceColor;","float flags = instanceFlag;","l_useColor = getFlag(flags, 1.0);","l_useOpacity = getFlag(flags, 2.0);","l_visibility = getFlag(flags, 4.0);",""].join("\n"),ComputeObjectPosition:["vec3 instancePosition = vGetAttribPosition();","vec4 newPosition = instanceMatrix * vec4(instancePosition,1.0);","return newPosition.xyz/newPosition.w;"].join("\n"),ComputeObjectNormal:["vec4 norm = instanceMatrix * vec4(vGetAttribNormal(),0.0);","return normalize(norm).xyz;"].join("\n")},FS_global_code:["vec4 _texelCity = vec4(1.0);","float _alphaCity = 1.0;","vec3 colorInstance= vec3(1.0,1.0,1.0);","float opacityInstance = 0.0;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["if (useMapCity) {","_texelCity = texture2D(mapCity, vGetTexCoord0().xy);","_alphaCity = _texelCity.w;","}","colorInstance = diffuseCity;","if (l_useColor > 0.5) {","colorInstance = vInstanceColor.xyz;","}","opacityInstance = opacityCity;","if (l_useOpacity > 0.5) {","opacityInstance = vInstanceColor.w;","}",""].join("\n"),ComputeAlbedo:["return colorInstance*_texelCity.xyz;"].join("\n"),ComputeOpacity:["if (l_useOpacity < 0.5) {","return _DSopacity_;","}","else {","return _DSopacity_*vInstanceColor.w/opacityCity;","}"].join("\n"),ComputeDiscard:["if (_alphaCity < alphaTestCity || l_visibility > 0.5) {","return true;","}","return false;"].join("\n")}},s}),define("DS/XCityRendering/RenderingHandlerMarker",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/xCityBasicUtils/ColorGradient","DS/XCityRendering/RenderingHandlerAltitude"],function(e,t,i,r){"use strict";return r.extend({init:function(e){this._parent(e),this.type="Marker"},getDefaultRendering:function(){return Object.assign({},this._parent(),{color:new i(new e.Color("#003c5a")),textColor:new i(new e.Color("#e2e4e3")),style:"annotationIcon",customClass:"",iconName:"",icon:{},textStyle:"button",stroke:{},descriptionDisplayMode:"click"})},applyRendering:function(e){if(e)for(var i=t.getDataSource(e),r=0;r<e.features.length;r++){var n=i.records[r].userData,a=this.getCompleteMaterialInfo(i.records[r].strid,n);e.features[r].get("Content").applyMaterialOnGeometry(a)}}})}),define("DS/XCityRendering/RenderingHandlerProxy",["DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerAltitude","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering","DS/XCityRendering/FeatureRendering","DS/XCityRendering/Rendering"],function(e,t,i,r,n,a){"use strict";return t.extend({init:function(e,t,i){this._parent(e,t,i),this.instancing=!1,this.type="Proxy",this._subRenderingHandler=void 0},setInstancing:function(e){this.instancing=e},getDefaultRendering:function(){return Object.assign({},this._parent())},setContent:function(e){if(this._content=e,e._poiSet)this._subRenderingHandler[e.get("SUB_REND_HANDLER_POINT_INDEX")].setContent(e._poiSet),this._subRenderingHandler[e.get("SUB_REND_HANDLER_LINE_INDEX")].setContent(e._lineSet),this._subRenderingHandler[e.get("SUB_REND_HANDLER_POLY_INDEX")].setContent(e._polygonSet);else for(var t=0;t<this._subRenderingHandler.length;++t)this._subRenderingHandler[t].setContent(e)},_initMaterial:function(){},hasAttribute:function(t){if(e.is(this.defaultRendering)&&void 0!==this.defaultRendering.get(t))return!0;if(this._subRenderingHandler){for(var i=!1,r=0;r<this._subRenderingHandler.length;++r)i=i||this._subRenderingHandler[r].hasAttribute(t);return i}return!1},addToDefaultMaterial:function(e){this.defaultRendering.addOver(e)},addDefaultAltitudeFromAttributes:function(t,n){if(e.is(t))this.defaultRendering.set("elevation",t);else{var a=(new i).propertyName(n),s=new r(null,null,{elevation:a});s.addOverIds("3DXCityDefaultIDdefaultElevationAttributeElement"),this.defaultRendering.addOver(s)}},applyRendering:function(e){if(this._parent(e),this._subRenderingHandler&&e&&e.children)for(var t=0;t<this._subRenderingHandler.length;++t)for(var i=0;i<e.children.length;++i)e.children[i].indexMesh===t&&this._subRenderingHandler[t].applyRendering(e.children[i])},updateMesh:function(t){if(e.is(t)){t.parents[0];this._subRenderingHandler&&t.indexMesh>-1&&t.indexMesh<this._subRenderingHandler.length?this._subRenderingHandler[t.indexMesh].initMesh(t):this.initMesh(t)}},updateRendering:function(e){this._parent(e),this.updateOtherRenderings(e)},updateOtherRenderings:function(e){if(this._subRenderingHandler)for(var t=0;t<this._subRenderingHandler.length;++t){let i=new n;i.copy(e),this._subRenderingHandler[t].updateRendering(i)}},addSubRenderingHandler:function(e,t){this._subRenderingHandler||(this._subRenderingHandler=[]),Number.isFinite(t)?this._subRenderingHandler.splice(t,0,e):this._subRenderingHandler.push(e)},isPrimitiveRegistered:function(e){var t=!1;if(this._subRenderingHandler)for(var i=0;i<this._subRenderingHandler.length;++i)t=t||this._subRenderingHandler[i].isPrimitiveRegistered(e);return t},needsRebuild:function(){var e=this._needRebuild;if(this._subRenderingHandler)for(var t=0;t<this._subRenderingHandler.length;++t)e=e||this._subRenderingHandler[t].needsRebuild();return e},flagAsRebuilt:function(e){if(this._needRebuild=!e,this._subRenderingHandler)for(var t=0;t<this._subRenderingHandler.length;++t)this._subRenderingHandler[t].flagAsRebuilt(e)},registerPrimitive:function(t,i){if(e.is(i)&&this._subRenderingHandler)for(var r=0;r<this._subRenderingHandler.length;++r)this._subRenderingHandler[r].registerPrimitive(this._subRenderingHandler[r]._content._patch,i)},updatePrimitiveRendering:function(e){if(this._parent(e),this._subRenderingHandler)for(var t=0;t<this._subRenderingHandler.length;++t)this._subRenderingHandler[t].updatePrimitiveRendering(e)},_renderprimitive:function(e){if(this._subRenderingHandler)for(var t=0;t<this._subRenderingHandler.length;++t)this._subRenderingHandler[t]._renderprimitive(e)},getIds:function(){var t=[];if(this._subRenderingHandler)for(var i=0;i<this._subRenderingHandler.length;++i){var r;if(e.is(this._subRenderingHandler[i]._content))e.is(this._subRenderingHandler[i]._content._itemParent)&&(r=this._subRenderingHandler[i]._content._itemParent.get("id"),e.is(r)&&0===t.length&&t.push(r)),r=this._subRenderingHandler[i]._content.get("id"),e.is(r)&&t.push(r)}else e.is(this._content)&&(e.is(this._content._itemParent)&&(r=this._content._itemParent.get("id"),e.is(r)&&t.push(r)),r=this._content.get("id"),e.is(r)&&t.push(r));if(e.is(this._content)){var n=this._content.get("renderID");e.is(n)&&""!==n&&t.push(n)}return e.is(this.type)&&t.push(this._prefix+this.type),e.is(this._allIds)&&t.push(this._allIds),t},getCompleteMaterialInfo:function(e,t){var i=this.defaultRendering.getCompleteMaterialInfo(e,t),r=new a(i);if(this._subRenderingHandler)for(var n=0;n<this._subRenderingHandler.length;++n){let i=this._subRenderingHandler[n].getCompleteMaterialInfo(e,t);r.addOver(i)}return r.getRenderingData()}})}),define("DS/XCityRendering/RenderingHandlerCrossQuad",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityRendering/RenderingHandlerAltitude","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering","DS/XCityTools/RenderingTools"],function(e,t,i,r,n,a,s){"use strict";var o=r.extend({init:function(e){this._parent(e),this.type="Crossquad",this.atlasSize={x:4,y:4}},getDefaultRendering:function(){return Object.assign({},this._parent(),{side:e.DoubleSide,forceSide:!0,alphaTest:.5,mapUrl:null})},_initMaterial:function(){if(!t.is(this._material)){this._material=i.getPDSFXMaterial([o._crossquad_PDSFX],"physical");var e=this.defaultRendering.getRenderingData();s._setMaterialFromProfile(this._material,e),i.updateCommonUniforms(this._material)}return this._material},addDefaultAltitudeFromAttributes:function(e,i){if(t.is(e))this.defaultRendering.set("elevation",e);else{var r=(new n).propertyName(i),s=new a(null,null,{elevation:r});s.addOverIds("3DXCityDefaultIDdefaultElevationAttributeCrossquad"),this.defaultRendering.addOver(s)}},onTextureDownloadStart:function(e,t,i){e.updatePDSFXUniform("useMapCity",!0),e.updatePDSFXUniform("mapCityLoaded",!1)},onTextureApplied:function(e,t,i,r){e&&(t.updatePDSFXUniform("useMapCity",!0),t.updatePDSFXUniform("mapCityLoaded",!0))}});return o._crossquad_PDSFX={attributes:{},uniforms:{atlasSize:{type:"v2",value:new e.Vector2(4,4)},mapCity:{type:"t2",value:i.whiteMap},useMapCity:{type:"b",value:!1},mapCityLoaded:{type:"b",value:!0},diffuseCity:{type:"c",value:new e.Color(16711680)},opacityCity:{type:"f",value:1},alphaTestCity:{type:"f",value:.5}},varyings:{vInstanceColor:{type:"v4",value:new e.Vector4(1,1,1,1)},l_useColor:{type:"f",value:0},l_useOpacity:{type:"f",value:0},l_visibility:{type:"f",value:0},texCoordCity:{type:"v2",value:new e.Vector2(0,0)}},VS_global_code:["float getFlag(float flags, float row){","    float res = mod(flags, row*2.0); ","    if(res >= row){","       return 1.0;","   }","   return 0.0; ","}"].join("\n"),VS_overridableFunctions:{ComputeObjectPosition:["vec3 instancePosition = vGetAttribPosition();","vec4 newPosition = instanceMatrix * vec4(instancePosition,1.0);","return newPosition.xyz;"].join("\n"),ComputeObjectNormal:["vec3 norm = mat3(cos(instanceRotation), sin(instanceRotation), 0,","-sin(instanceRotation), cos(instanceRotation), 0,","0,0,1) * vGetAttribNormal();","return norm.xyz;"].join("\n"),ComputeObjectTexCoord0:["float instanceID = float(vGetInstanceID());","float indexTexture = instanceIndexTexture;","float startX = mod(indexTexture,atlasSize.x)/atlasSize.x;","float startY = floor(indexTexture/atlasSize.x)/atlasSize.y;","return vec4(vGetAttribTexCoord0().xy/atlasSize + vec2(startX, startY), 0.0, 0.0);"].join("\n"),ComputeVaryingValues:["vInstanceColor = instanceColor.xyzw;","float flags = instanceFlag;","l_useColor = getFlag(flags, 1.0);","l_useOpacity = getFlag(flags, 2.0);","l_visibility = getFlag(flags, 4.0);","","float instanceID = float(vGetInstanceID());","float indexTexture = instanceIndexTexture;","float startX = mod(indexTexture,atlasSize.x)/atlasSize.x;","float startY = floor(indexTexture/atlasSize.x)/atlasSize.y;","texCoordCity = vec2(vGetAttribTexCoord0().xy/atlasSize + vec2(startX, startY));"].join("\n")},FS_global_code:["vec4 _texelCity = vec4(1.0);","float _alphaCity = 1.0;","vec3 colorInstance= vec3(1.0,1.0,1.0);","float opacityInstance = 1.0;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["if (useMapCity && mapCityLoaded) {","_texelCity = texture2D(mapCity, texCoordCity.xy);","_alphaCity = _texelCity.w;","","}","colorInstance = diffuseCity;","if (l_useColor > 0.5) {","colorInstance = vInstanceColor.xyz;","}","opacityInstance = opacityCity;","if (l_useOpacity > 0.5) {","opacityInstance = vInstanceColor.w;","}",""].join("\n"),ComputeAlbedo:["return colorInstance*_texelCity.xyz;"].join("\n"),__ComputeDiffuseTexel:["return vec4(_texelCity.xyz, 1.0);"].join("\n"),__ComputeSpecularReflectance:["return vec3(0.0);"].join("\n"),ComputeOpacity:["if (l_useOpacity < 0.5) {","return _DSopacity_ / _alphaCity;","}","else {","return _DSopacity_*vInstanceColor.w/(opacityCity*_alphaCity);","}"].join("\n"),ComputeDiscard:["if (_alphaCity < alphaTestCity || (useMapCity && !mapCityLoaded) || l_visibility > 0.5) {","return true;","}","return false;"].join("\n")}},o}),define("DS/XCityRendering/RenderingHandlerPOI3D",["DS/XCityRendering/RenderingHandlerAltitude","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/Visualization/ThreeJS_DS","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering","DS/XCityTools/TextureManager","DS/XCityRendering/FeatureRendering"],function(e,t,i,r,n,a,s,o){"use strict";return e.extend({init:function(e,t,i){this._parent(e,t,i),this.type="POI3D"},getDefaultRendering:function(){var e=UWA.clone(this._parent());return UWA.extend(e,{scale:new r.Vector3(1,1,1),renderMode:"overlay",opacityFactor:"0.3",alphaTest:.1,altitude:void 0,styleClass:"",label:{position:{geometryOffset:new r.Vector3(0,.5,0)}},shapeType:"pyramid",nbVertices:[15,15],switchDistance:0},!0),e},isMeshLeafSet:function(e){return!!(t.is(e)&&t.is(e.name)&&t.startsWith(e.name,"leafMeshCluster"))},isMeshClusterSet:function(e){return!!(t.is(e)&&t.is(e.name)&&t.startsWith(e.name,"rtreeMeshCluster"))},isMeshQTSet:function(e){return!!(t.is(e)&&t.is(e.name)&&t.startsWith(e.name,"qtcluster"))},updateMesh:function(e){if(t.is(e)){var i=e.parents[0];this.isMeshLeafSet(i)?this._leafSetRendering.initMesh(e):this.isMeshClusterSet(i)?this._clusterSetRendering.initMesh(e):this.isMeshQTSet(i)?this._qtClusterSetRendering.initMesh(e):t.is(e.name)&&t.startsWith(e.name,"text")||this.initMesh(e)}},initMesh:function(e){if(t.is(e)){var r=this._getMaterial(e.mesh3js.material);"PoiTransparentOverlayPass"===e.passes[0]&&"dual"===this.getCompleteMaterialInfo().renderMode&&(r.opacity=this.getCompleteMaterialInfo().opacity*this.getCompleteMaterialInfo().opacityFactor),"OverlayPostPass"===e.passes[0]&&(r.depthTest=!1),i.updateCommonUniforms(r),this.setMaterialToMesh(e,r),this._lastSeenMaterial=r}},applyRendering:function(e){if(t.is(e)){this._parent(e);var i,r,n,a,s=!0;if(e.children&&(n=e.children.length)>0)for(s=!1,i=0;i<n;i++)if(this.isMeshToConsider(e.children[i]))this.applyRenderingToMesh(e.children[i]);else for(a=e.children[i].children.length,r=0;r<a;++r)this.isMeshToConsider(e.children[i].children[r])&&(this.isMeshClusterSet(e.children[i])?this.applyFeatureRenderingToMesh(e.children[i].children[r]):this.applyRenderingToMesh(e.children[i].children[r]));s&&this.isMeshToConsider(e)&&this.applyRenderingToMesh(e)}},shouldRebuild:function(e,t){if(this._parent(e,t))return!0;var i,n,a,s,o=e.getRenderingData(),l=t.getRenderingData(),d=["altitude","height","styleClass","renderMode","shapeType","nbVertices","switchDistance"],u=d.length;for(i=0;i<u;i++){var f=d[i];if((n=l[f])!==(a=o[f])){s=!0;break}}if(!0===s)return!0;if(n=l.scale,a=o.scale,n instanceof r.Vector3&&a instanceof r.Vector3){if(!n.equals(a))return!0}else if(n!==a)return!0;var h=t.hasDatavizOnAttribute("scale");return!!h||!!(h=e.hasDatavizOnAttribute("scale"))},getFlagForPrimitive:function(e,i){var r=this._parent(e,i);if(e){var n=this.getPrimitiveRenderingValues(e,i);t.is(n.scale)&&(r+=4)}return r},addDefaultAltitudeFromAttributes:function(e,t,i){var r,s=(new n).propertyName(t);r="number"==typeof e?(new n).literal(e):(new n).propertyName(e);var o=s.toNumber(),l=r.toNumber();o.add(l);var d=new a(null,null,{elevation:o});d.addOverIds("3DXCityDefaultIDdefaultElevationAttributePoi3d"),this.defaultRendering.addOver(d)},updateRendering:function(e){this._parent(e),this.updateOtherRenderings(e)},updateOtherRenderings:function(e){t.is(this._leafSetRendering)&&this._leafSetRendering.updateRendering(e);var i=new o(e);if(i.remove("mapUrl"),i.remove("shapeType"),t.is(this._clusterSetRendering)){var r=new o;r.copy(i),delete r.datavizRenderings,this._clusterSetRendering.updateRendering(r)}t.is(this._qtClusterSetRendering)&&this._qtClusterSetRendering.updateRendering(i)},setClusterSetRendering:function(e){this._clusterSetRendering=e,this.updateOtherRenderings(this.currentRendering)},setLeafSetRendering:function(e){this._leafSetRendering=e,this.updateOtherRenderings(this.currentRendering)},setQtClusterSetRendering:function(e){this._qtClusterSetRendering=e,this.updateOtherRenderings(this.currentRendering)},useDatavizMappingOptim(e){var i=this._parent(e);return i=i&&t.is(e.mesh3js.instanceAttribArrays.instanceMatrix)}})}),define("DS/XCityRendering/RenderingHandlerHeatMap",["DS/XCityRendering/RenderingHandlerPOI3D","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/ColorGradient","DS/XCityCore/Store"],function(e,t,i,r,n,a){"use strict";return e.extend({init:function(e,t,i){this._parent(e,t,i),this._clusterminlength=1/0,this._clustermaxlength=-1/0,this._clustermaxmag=-1/0,this._nodesminlength=1/0,this._nodesmaxlength=-1/0,this._nodesmaxmag=-1/0,this.verbose=!1,this.debug=!1,this._magnitude=null},getIds:function(){return["3DXCityHeatMap"].concat(this._parent())},getDefaultRendering:function(){return Object.assign({},this._parent(),{influenceRadius:20,weight:1,boundMin:1,boundMax:100,kernel:0})},setHeatMapTool:function(e){this.heatmapToolRendering=e},getStoreVisiblePoints:function(){var e,r,n=[],s=1,o=[],l=this,d=this._content.get("id"),u=function(e){var t,r=i.getDataSource(e);return i.is(r)&&(t=r.records[0].userData.nhits),t||1},f=function(e,t){var r=i.getDataSource(e.value.node),n=u(e.value.node);return null!==l._magnitude&&(n=function(e,t){var r,n=i.getDataSource(e);return i.is(n)&&(r=n.records[0].userData.magnitude[t].sum),r||1}(e.value.node,l._magnitude)),i.is(r)&&(r.records[0].userData.STRID,r.records[0].userData),!0===l.debug?1:n};return a.traverse(d,function(a){if(i.is(a)&&a.locks>0&&i.is(a.value))if(1===a.value.nbFeatures&&a.value.node&&a.value.node.userData&&a.value.node.userData.records[0].userData.nhits>1){a.bbox;var l,d=a.value.node.getBoundingSphere();l=d&&d.radius>0?a.value.node.getBoundingSphere().center:(new t.Vector3).getPositionFromMatrix(a.value.node.getMatrix()),e=function(e){var t,r=i.getDataSource(e.value.node),n=1;return i.is(r)&&(t=r.records[0].bbox,r.records[0].userData.STRID,n=r.records[0].userData.radius||Math.max(t.xmax-t.xmin,t.ymax-t.ymin)/2),n}(a),r=f(a),n.push(new t.Vector4(l.x,l.y,e,r)),s=Math.max(r,s)}else{var u=i.getDataSource(a.value.node);o.push({tile:{LOD:a.tile.LOD,I:a.tile.I,J:a.tile.J},userData:u})}},!1),!0===l.verbose&&console.log("number of cluster",n.length,"maxmag:",s),{visiblePoints:n,maxMag:s,nonCLuster:o}},isRtreeToDisplay:function(e,t){if(!t)return!1;var r,n=e.tile;if(!i.is(n))return!0;for(r=0;r<t.length;r++){var a=t[r].userData;if(i.is(a)){var s=a.source.tile;if(i.isSameTile(n,s))return t.splice(r,1),!0}}return!1},getFrustumGeometry:function(e,i){var r=e.frustum.clone(),n=new t.Vector3(-e._camShiftedTranslation.x+this.urban.shiftedPosition.x,-e._camShiftedTranslation.y+this.urban.shiftedPosition.y,-e._camShiftedTranslation.z+this.urban.shiftedPosition.z),a=new t.Vector3(e._camShiftedTranslation.x+n.x,e._camShiftedTranslation.y+n.y,e._camShiftedTranslation.z+n.z);return r.set(r.planes[0].clone().translate(a),r.planes[1].clone().translate(a),r.planes[2].clone().translate(a),r.planes[3].clone().translate(a),r.planes[4].clone().translate(a),r.planes[5].clone().translate(a)),r},getVisibleRTreePoints:function(e){var t,i,r=[],n=1,a=this.urban.getViewpoint(),s=a.getPosition(),o=this.getFrustumGeometry(a,s),l=0;for(!0===this.verbose&&console.log(" store rtrees nodes",e.length),t=0;t<this.rtrees.length;++t)if(i=this.rtrees[t],this.isRtreeToDisplay(i,e)&&(l++,this.rtreeNodes[t].children.length>0)){var d=this.getRTreeListOfVisiblePoints(i,s,o);r=r.concat(d.visiblePoints),n=Math.max(n,d.maxMag)}return!0===this.verbose&&(console.log("total rtrees on layer ",this.rtrees.length,"rtrees considered",l),console.log("number of rtree node",r.length,"maxmag:",n)),{visiblePoints:r,maxMag:n}},newgetRTreeListOfVisiblePoints:function(e,i,r){for(var n=1,a=[],s=new t.Vector3(e.shift[0],e.shift[1],0),o=e.newgetVisiblePoints(i,r,s),l=0;l<o.visiblePoints.length;++l){var d=o.visiblePoints[l],u=this.getRadiusFromAttributes(d.z),f=this.getWeightFromAttributes(d.w),h=new t.Vector4(d.x,d.y,u,f);n=Math.max(n,f),a.push(h)}return{visiblePoints:a,maxMag:n}},getRTreeListOfVisiblePoints:function(e,i,r){var n=1,a=[],s=new t.Vector3(e.shift[0],e.shift[1],0),o=10;this._content._nhitsTotal<900&&(o=900);for(var l=e.getVisibleNodes(i,r,s,o),d=0;d<l.visibleNodes.length;++d){var u=l.visibleNodes[d].center,f=this.getRadiusFromRTreeNode(l.visibleNodes[d]),h=this.getWeightFromRTreeNode(l.visibleNodes[d]),g=new t.Vector4(u.x,u.y,f,h);n=Math.max(n,h),a.push(g)}return{visiblePoints:a,maxMag:n}},getMagnitudeFromRTreeNode:function(e){return e.mag/Math.max(e.nHits,1)},getRadiusFromRTreeNode:function(e){var t,r,n=e.radius;return i.is(e.infos)&&(t=e.infos.strid,r=e.infos.attributes),!0===this.debug?10:this.getRadiusFromAttributes(n,t,r)},getRadiusFromAttributes:function(e,t,i){var r=this.getCompleteMaterialInfo(t,i).influenceRadius;return this.getRadiusFromDistance(e,r)},getRadiusFromDistance:function(e,t){var i=e+t;return Math.max(i,1)},getrtreenodelevel:function(e){var t=5;return e.parent&&(t=this.getrtreenodelevel(e.parent),t-=1),t},getWeightFromRTreeNode:function(e){return e.mag},getWeightFromAttributes:function(e,t,i){var r=this.getCompleteMaterialInfo(t,i).weight;return this.getWeightFromValue(e,r)},getWeightFromValue:function(e,t){return e||t},shiftVisiblePoints:function(e,i){var r,n,a,s,o,l=1,d=[];for(r=0;r<e.visiblePoints.length;++r)a=(n=e.visiblePoints[r]).z,s=n.w,o=new t.Vector4(n.x+i.x,n.y+i.y,a,s),l=Math.max(l,s),d.push(o);return{visiblePoints:d,maxMag:l}},getVisiblePoints:function(){var e,i=new t.Vector3(this.urban.shiftedPosition.x,this.urban.shiftedPosition.y,this.urban.shiftedPosition.z);(e=this.urban.cropBox?new t.Vector4(i.x+this.urban.cropBox._size.x/2,i.y+this.urban.cropBox._size.y/2,0,0):new t.Vector4(i.x+this.urban.worldSize/2,i.y+this.urban.worldSize/2,0,0)).negate();var r=this.getStoreVisiblePoints();if(this._clusterminlength=Math.min(this._clusterminlength,r.visiblePoints.length),this._clustermaxlength=Math.max(this._clustermaxlength,r.visiblePoints.length),this._clustermaxmag=Math.max(this._clustermaxmag,r.maxMag),this.rtrees=this._content.getFactory().rtrees,this.rtreeNodes=this._content.getFactory().rtreeNodes,void 0!==this.rtrees){var n=this.getVisibleRTreePoints(r.nonCLuster);this._nodesminlength=Math.min(this._nodesminlength,n.visiblePoints.length),this._nodesmaxlength=Math.max(this._nodesmaxlength,n.visiblePoints.length),this._nodesmaxmag=Math.max(this._nodesmaxmag,n.maxMag),r={visiblePoints:n.visiblePoints.concat(r.visiblePoints),maxMag:Math.max(n.maxMag,r.maxMag)}}else if(r.nonCLuster&&r.nonCLuster.length>0){var a=this.getNonClusteredPoints(r.nonCLuster);r={visiblePoints:a.visiblePoints.concat(r.visiblePoints),maxMag:Math.max(a.maxMag,r.maxMag)}}var s=r=this.shiftVisiblePoints(r,e);return!0===this.verbose&&console.log("Number of visible Points ",r.visiblePoints.length),s},getNonClusteredPoints:function(e){var t,i={visiblePoints:[],maxMag:1};for(t=0;t<e.length;++t){var r=e[t],n=this.getPointsFromNonCluster(r);i={visiblePoints:n.visiblePoints.concat(i.visiblePoints),maxMag:Math.max(n.maxMag,i.maxMag)}}return i},getPointsFromNonCluster:function(e){var r,n,a,s=[],o={visiblePoints:s,maxMag:1},l=[];if(!(i.is(e)&&i.is(e.userData)&&i.is(e.userData.records)))return o;for(l=e.userData.records,r=0;r<l.length;++r){var d=l[r];if(i.is(d)&&i.is(d.posSize)&&i.is(d.posSize.center)){var u=d.posSize.center;n=this.getRadiusFromAttributes(null,d.strid,d.userData),a=this.getWeightFromAttributes(null,d.strid,d.userData),s.push(new t.Vector4(u.x,u.y,n,a)),o.maxMag=Math.max(o.maxMag,a)}}return o},shouldRebuild:function(e,t){var i=this._parent(e,t);if(!i){var r=this.currentRendering.getDifferences(this.lastRendering);r&&r.get("noGeometry")&&(i=!0)}return i}})}),define("DS/XCityRendering/RenderingHandlerPOI3DGeometry",["DS/XCityRendering/RenderingHandlerHeatMap","DS/xCityBasicUtils/Utils","DS/Visualization/ThreeJS_DS","DS/XCityRendering/FeatureRendering","DS/xCityBasicUtils/ColorGradient"],function(e,t,i,r,n){"use strict";return e.extend({init:function(e,t,i){this._parent(e,t,i),this.type="POI3DGeometry"},getDefaultRendering:function(){return Object.assign({},this._parent(),{ambient:new n(new i.Color("#000000")),diffuse:new n(new i.Color("#000000")),color:new n(new i.Color("#000000")),scale:new i.Vector3(8,8,8),renderMode:"dual",opacityFactor:.3,alphaTest:.01,altitude:void 0,styleClass:""})},updateRendering:function(e){var t=new r(e);t.remove("mapUrl"),this._parent(t)},notsetRenderingList:function(e,r,n,a){var s,o,l,d="billboard"===a._shapeType,u="sphere"===a._shapeType;if(!0===a.isInstanceNode3D&&(o=a.mesh3js.userData.cgmIds,t.is(o)&&a.mesh3js.instanceAttribArrays.instanceColor)){var f=a.mesh3js.instanceAttribArrays.instanceColor.array,h=a.mesh3js.userData.instanceColor;if(a.mesh3js.instanceAttribArrays.instanceMatrix){var g=a.mesh3js.instanceAttribArrays.instanceMatrix.array,c=a.mesh3js.userData.instanceMatrix;s=a.mesh3js.instanceAttribArrays.instanceFlag.array;for(var p=a.mesh3js.userData.instanceFlags,_=(a.mesh3js.userData.instanceIds,{}),m=0;m<a.mesh3js.userData.instanceIds.length;m++)_[a.mesh3js.userData.instanceIds[m]]=m;var v=a.mesh3js.userData.__v0,y=a.mesh3js.userData.__v1,b=!1,x=a.mesh3js.geometry.boundingSphere,R=x.center.x-x.radius,D=x.center.x+x.radius,S=x.center.y-x.radius,M=x.center.y+x.radius,C=x.center.z-x.radius,P=x.center.z+x.radius;for(m=0;m<o.length;m++){var T=m,I=_[a.mesh3js.userData.cgmIds[m]],w=e[I];if(w){var O=0;O=s[T];var F=w.color,z=w.opacity,U=t.is(F),A=t.is(z);O=t.floatPack(O,0,U),O=t.floatPack(O,1,A);var L,k,X=w.scale;if(X&&!d){l||(l=[]);var E,j,N;E=.5*X.x,j=.5*X.y,N=X.z,u&&(j=N=E),l[0]=100*E,l[5]=100*j,l[10]=100*N}if(l){for(var V in L=16*T,k=16*I,l)if(l.hasOwnProperty(V)){var H=L+Number(V);g[H]=l[V],c[H=k+Number(V)]=l[V]}v.set(g[L+12],g[L+13],g[L+14]),y.set(g[L+0],g[L+5],g[L+10]),v.x-y.x<R&&(R=v.x-y.x,b=!0),v.x+y.x>D&&(D=v.x+y.x,b=!0),v.y-y.y<S&&(S=v.y-y.y,b=!0),v.y+y.y>M&&(M=v.y+y.y,b=!0);var G=v.z;v.z-y.z<C&&(C=v.z-y.z,b=!0),G+y.z>P&&(P=G+y.z,b=!0)}L=4*T,k=4*I,U&&(f[L]=F.r,f[L+1]=F.g,f[L+2]=F.b,h[I].x=F.r,h[I].y=F.g,h[I].z=F.b),A&&(f[L+3]=z,h[I].w=z),O!==s[T]&&(s[T]=O,p[I]=O)}}if(a.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0,a.mesh3js.instanceAttribArrays.instanceColor.isDynamic=!0,a.mesh3js.instanceAttribArrays.instanceMatrix.isDynamic=!0,b){var B=new i.Sphere;B.radius=Math.sqrt(Math.pow(D-R,2)+Math.pow(M-S,2)+Math.pow(P-C,2))/2,B.center.x=(R+D)/2,B.center.y=(S+M)/2,B.center.z=(C+P)/2,a.boundingSphere=B}}}}})}),define("DS/XCityRendering/RenderingHandlerModel",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/RenderingTools","DS/XCityRendering/RenderingHandlerAltitude","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering"],function(e,t,i,r,n,a){"use strict";return r.extend({init:function(e){this._parent(e),this._waitingList=[],this.type="Model"},getDefaultRendering:function(){return Object.assign({},this._parent(),{scale:new e.Vector3(0,0,0)})},addDefaultAltitudeFromAttributes:function(e){var t=(new n).propertyName(e).toNumber(),i=new a(null,null,{elevation:t});i.addOverIds("3DXCityDefaultIDdefaultElevationAttributeModel"),this.defaultRendering.addOver(i)},addDefaultScaleFromAttributes:function(e){var t=(new n).propertyName(e).toNumber(),i=new a(null,null,{scale:t});i.addOverIds("3DXCityDefaultIDdefaultScaleAttributeModel"),this.defaultRendering.addOver(i)},shouldRebuild:function(e,t){return!!this._parent(e,t)||!(!t.renderingData.scale||e.renderingData.scale&&t.renderingData.scale.equals(e.renderingData.scale))}})}),define("DS/XCityRendering/RenderingHandlerGeometricTerrain",["DS/XCityRendering/RenderingHandlerModel","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return e.extend({init:function(e){this._parent(e),this.type="GeometricTerrain"},getDefaultRendering:function(){return{showOcean:!1,oceanAlpha:1,oceanRangeDetection:.0625,oceanColorDetection:new t.Color("rgb(0,64,102)"),oceanTexture:null,oceanTextureUrl:"XCityEnvironment/assets/textures/ocean/waterNormalsn.jpg",oceanColor:new t.Color("rgb(47,64,71)"),mapUrl:"XCityEnvironment/assets/textures/hdroad/t_atlasF.jpg",mapParams:{minFilter:t.NearestMipMapNearestFilter,magFilter:t.NearestMipMapNearestFilter,wrapS:t.RepeatWrapping,wrapT:t.RepeatWrapping}}},onTextureApplied:function(e,t,i,r){if(r&&"map"===r.param){var n=this.getCompleteMaterialInfo();if(e&&n.mapParams)for(var a in n.mapParams)e[a]=n.mapParams[a]}}})}),define("DS/XCityRendering/RenderingHandlerHeatMapTool",["DS/XCityRendering/RenderingHandlerPOI3D","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/ColorGradient"],function(e,t,i,r,n){"use strict";return e.extend({init:function(e,t,i){this._parent(e,t,i),this.type="HeatMapTool"},getDefaultRendering:function(){return Object.assign({},this._parent(),{gradient:{DCOffset:new t.Vector3(.52,.52,.1),Amplitude:new t.Vector3(.48,-.48,-.11),Frequency:new t.Vector3(-.62,.56,.4),Phase:new t.Vector3(.33,.3,.5)},influenceRadius:20,enable:!1,opacity:.75,boundMin:1,boundMax:100,kernel:0})},updateRendering:function(e){this._parent(e),this.updateSources()},updateSources:function(){if(i.is(this._currentLayerRendering)){var e=this.currentRendering.get("influenceRadius");e!==this.lastRendering.get("radius")&&this._currentLayerRendering.currentRendering.set("influenceRadius",e)}},setHeatMap:function(e){this._currentLayerRendering=e,this._currentLayerRendering.defaultRendering.set("noGeometry",!0),this._currentLayerRendering._needRebuild=!0},unsetHeatMap:function(e){i.is(this._currentLayerRendering)&&(this._currentLayerRendering.defaultRendering.set("noGeometry",!1),this._currentLayerRendering._needRebuild=!0,this._currentLayerRendering=null)}})}),define("DS/XCityRendering/HeatMapTool",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityEffects/HeatMapRTree","DS/XCityRendering/RenderingHandlerHeatMapTool"],function(e,t,i,r,n){"use strict";return e.extend({init:function(e){this._parent();return this.urban=e,this.renderingProfileManager=this.urban.getRenderingProfileManager(),this.renderingProfileManager._heatMapGeom=this,this._renderingId=this.renderingProfileManager.HeatMapToolId,this.heatmapId="3DXCityHeatMap",this._rendering=new n(this.urban),this},getRendering:function(){var e=null;return i.is(this._rendering)&&(e=this._rendering),e},get:function(e){var t,r,n=this.getRendering();return i.is(n)&&n.hasAttribute(e)&&(r=this.getMaterial(),i.is(r)&&(t=r[e])),t},set:function(e,t){var r=this.getRendering();if("magnitude"===e&&this.currentContent){1===t?(this.currentContent._factory._magnitude=null,this.currentContent._factory._rendering._magnitude=null):(this.currentContent._factory._magnitude=t,this.currentContent._factory._rendering._magnitude=t),void 0===(a=this.currentContent.get("url"))&&(a="");var n=a.indexOf("&method=sum&heatmap=");n>-1&&(a=a.slice(0,n)),1===t?this.currentContent.set("url",a):this.currentContent.set("url",a+"&method=sum&heatmap="+t)}else{var a,s={};if(i.is(r)&&r.hasAttribute(e)&&(s[e]=t,this.setMaterial(s)),"enable"===e&&this.currentContent)if(void 0===(a=this.currentContent.get("url"))&&(a=""),t)-1===a.indexOf("heatmap")&&null!==this.currentContent._factory._magnitude&&this.currentContent.set("url",a+"&method=sum&heatmap="+this.currentContent._factory._magnitude);else{var o=a.indexOf("&method=sum&heatmap=");o>-1&&this.currentContent.set("url",a.slice(0,o))}}},resetRenderingAttribute:function(e){if(!i.is(this.renderingProfileManager))return null;this.renderingProfileManager.resetAttributeOnly(this._renderingId,e),this.renderingProfileManager.updateGeomRenderings([this]),this.redraw()},setMaterial:function(e){return i.is(this.renderingProfileManager)?(this.renderingProfileManager.addRendering(this._renderingId,e),this):null},getMaterial:function(){var e=this.getRendering();return i.is(e)?e.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this._renderingId)},redraw:function(){var e=this.getRendering().getCompleteMaterialInfo();e.enable?(this._enableEffect(),i.is(this._factoriestoadd)&&this._factoriestoadd.length>0&&(this._addFactory(this._factoriestoadd.pop()),this._factoriestoadd.length>0&&(this._factoriestoadd=null)),this._updateEffect(e)):this._disableEffect()},_enableEffect:function(){if(i.is(this.heatMapEffect)||(this.heatMapEffect=this._getHeatMapRTree()),this.heatMapEffect.enableEffect(),i.is(this.currentContent)){var e=this.currentContent.getRendering();this.getRendering().setHeatMap(e)}},_getHeatMapRTree:function(){if(void 0===this.heatMapRTree){var e=this.urban.USR.webGLV6Viewer.renderer,t=this.urban.USR.webGLV6Viewer.renderer.renderTargetPool;this.heatMapRTree=new r(e,t,this.urban),this.urban.USR.webGLV6Viewer.renderer.addCustomEffect(this.heatMapRTree)}return this.heatMapRTree},_disableEffect:function(){if(i.is(this.heatMapEffect)&&(this.heatMapEffect.disableEffect(),i.is(this.currentContent))){this.currentContent.clusterlimit=2,this.currentContent._factory._magnitude=null,this.currentContent._factory._rendering._magnitude=null;var e=this.currentContent.get("url");void 0===e&&(e=""),this.currentContent.set("url",""),this.currentContent.set("url",e),this.getRendering().unsetHeatMap(null),this._redrawFactory()}},_updateEffect:function(e){i.is(e)&&(this._updateOpacity(e.opacity),this._updateRadius(e.influenceRadius),this._updateBoundMin(e.boundMin),this._updateBoundMax(e.boundMax),this._updateKernel(e.kernel))},_updateOpacity:function(e){this.heatMapEffect.mixPass.uniforms.opacity.value=e},_updateRadius:function(e){},_updateBoundMin:function(e){this.heatMapEffect.mixPass.uniforms.boundMin.value=e},_updateBoundMax:function(e){this.heatMapEffect.mixPass.uniforms.boundMax.value=e},_updateKernel:function(e){this.heatMapEffect.mixPass.uniforms.kernel.value=e},_redrawFactory:function(){i.is(this.currentContent)&&this.currentContent.redraw()},addSource:function(e){if(i.is(e)){var t=e.getContent();this._addFactory(t)}return!1},removeSource:function(e){if(i.is(e)){var t=e.getContent();this._removeFactory(t)}return!1},_addFactory:function(e){if(i.is(e))if(i.is(this.heatMapEffect)){this.currentContent&&this._removeFactory(this.currentContent);var t=e.get("url");void 0===t&&(t=""),t.indexOf("heatmap"),e._nhitsTotal<900&&(e.clusterlimit=900,e.set("url",""),e.set("url",t));var r=e.getRendering();r&&i.is(r.getVisiblePoints)&&(this.getRendering().setHeatMap(r),this.heatMapEffect.addFactory(r),this.currentContent=e,this._redrawFactory())}else i.is(this._factoriestoadd)||(this._factoriestoadd=[]),this._factoriestoadd.push(e)},_removeFactory:function(e){var t=e.get("id");if(i.is(this._factoriestoadd)&&this._factoriestoadd.length>0){var r,n=this._factoriestoadd.length;for(r=0;r<n;r++){if(this._factoriestoadd[r].get("id")===t){this._factoriestoadd.splice(r,1);break}}}else{if(this.getRendering().unsetHeatMap(null),i.is(this.heatMapEffect))this.heatMapEffect.removeFactory(e.getRendering());this._redrawFactory(),this.currentContent=null}}})}),define("DS/XCityRendering/RenderingHandlerLine",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/Plugins/RenderPass","DS/XCityRendering/RenderingHandlerAltitude","DS/xCityBasicUtils/ColorGradient","DS/XCityTools/Pooler","DS/XCityTools/EventDispatcher"],function(e,t,i,r,n,a,s,o,l){"use strict";var d=a.extend({init:function(e,i,r){this._parent(e,i,r);var n={ElementRendering:[{ElementIds:this._allIds,ElementMaterial:{lineWidth:10}}]};this.defaultRendering.addOver(n),this.lineMesh=[],t.is(i)||(i={}),this._defineRenderPass(),this.type="Line",this._pdsfxMaterial={},this._poolMaterial={},this.nbLabelNode=0},attachLabelRendering:function(e){this.renderingHandlerLineLabels=e},updateRenderingLineLabel:function(e){if(t.is(this.renderingHandlerLineLabels))for(var i in this.renderingHandlerLineLabels)this.renderingHandlerLineLabels.hasOwnProperty(i)&&this.renderingHandlerLineLabels[i].updateRendering(e)},updateRendering:function(e){e.addOver(e.getStrokeFeatureRendering()),this._parent(e),this.updateDashPatterns(),this.updateRenderingLineLabel(e)},updateDashPatterns:function(){var e=this._getAllFixedValuesForAttribute("dashPattern");this.resetDashPatterns(e)},getHashFromPattern:function(e){var i;if(t.is(e)){var r,n=Object.keys(e),a=n.length;for(i="",r=0;r<a;r++)r>0&&(i+="_"),i+=e[n[r]]}return i},getIndexFromPattern:function(e){var i,r=this.getHashFromPattern(e);t.is(r)&&t.is(this.dashPatterns)&&(i=this.dashPatterns[r].startIndex);return i},resetDashPatterns:function(e){if(this.dashPatterns={length:0},this.dashPatternLayer=void 0,t.is(e)&&t.is(e.length)){var i,r,n,a,s=0,o=e.length,l=Object.keys(e);for(i=0;i<o;i++)n=e[r=l[i]].value.slice(),a=this.getHashFromPattern(n),t.is(a)&&(t.is(this.dashPatterns[a])||(this.dashPatterns[a]={index:this.dashPatterns.length,startIndex:s,pattern:n,isPrimitive:e[r].isPrimitive},this.dashPatterns.length++,s+=n.length),!1===e[r].isPrimitive&&(this.dashPatternLayer=n))}this.refreshConcatenatedDashPatterns=!0},getConcatenatedDashedPatterns:function(){if(this.refreshConcatenatedDashPatterns){if(this.dashedPatternConcatenated=[],t.is(this.dashPatterns)){var e=this.dashPatterns.length;if(e>0){var i,r,n,a,s,o,l=Object.keys(this.dashPatterns);for(i=0;i<e+1;i++)if("length"!==(n=l[i]))for(a=(o=(s=this.dashPatterns[n]).pattern).length,r=0;r<a;r++)this.dashedPatternConcatenated[s.startIndex+r]=o[r]}}this.refreshConcatenatedDashPatterns=!1}return this.dashedPatternConcatenated},getDefaultRendering:function(){var t=Object.assign({},this._parent(),{ambient:new s(new e.Color("#000000")),diffuse:new s(new e.Color("#000000")),color:new s(new e.Color("#000000")),renderMode:"dual",alphaTest:.01,opacityFactor:.3,minOpacity:.1,minDist:1e3,elevationOffset:1,maxDist:2e3,lineWidth:4,minWidth:4,dynamicUpdate:!1,animation:null,dashPattern:null,linecap:"square"});return this._defaultStrokeParameters={enable:!1,opacityFactor:.3,minOpacity:.1,minDist:1e3,elevationOffset:1,maxDist:2e3,lineWidth:4,minWidth:4,dynamicUpdate:!1,animation:{},ambient:new s(new e.Color("#000000")),diffuse:new s(new e.Color("#000000")),color:new s(new e.Color("#000000")),opacity:1,dashPattern:null},t.stroke=this._defaultStrokeParameters,t},addStrokeInfo:function(e){let i=t.cloneRecKeepingClasses(e);return i.stroke=t.cloneRecKeepingClasses(e),i},addStrokeInfoToBaseLevel:function(e){let i=t.cloneRecKeepingClasses(e.stroke),r=t.cloneRecKeepingClasses(e);return r=Object.assign(r,i)},dupplicateStrokeInfo:function(e){return t.is(e)&&(e=t.is(e.stroke)?this.addStrokeInfoToBaseLevel(e):this.addStrokeInfo(e)),e},getDependantAttributes:function(e){let t=this._parent(e),i=[];for(let e=0;e<t.length;e++){const r=t[e];let n="";r&&(r.startsWith("stroke.")?(n=r.substr("stroke.".length),i.push(n),i.push(r)):(n="stroke."+r,i.push(r),i.push(n)))}return i},updatePresetValues:function(e){return e=this._parent(e),this.dupplicateStrokeInfo(e)},_applyPolygonOffset:function(e,i){t.is(e)&&t.is(i)&&(e.polygonOffset=!0,e.polygonOffsetFactor=i.x,e.polygonOffsetUnits=i.y)},_initMaterial:function(){var e,n,a=[],s=this.getCompleteMaterialInfo(),o=this._getShaderType();this._shaderType=o;var l=s;if("dashed"===o){var u=this.getConcatenatedDashedPatterns();t.is(u)&&u.length>0&&(l=Object.assign({},s,{dashPattern:u}))}(e=d.shaderLine[o](l)).isWideLine=!0,e.setPDSFXPolygonOffset("Frontward1"),e.linecap=s.linecap,e._shaderType=o,e.transparent=l.opacity<1,a=[e],r._setMaterialFromProfile(e,l),i.updateCommonUniforms(e),e.updateDeferredMaterials();for(var f=1;f<e._deferredMaterials.length;f++){var h=e._deferredMaterials[f];t.is(h)&&(h.needsUpdate=!0)}if("dual"===s.renderMode){(n=d.shaderLine[o](l)).isWideLine=!0,n.setPDSFXPolygonOffset("Frontward1"),n._shaderType=o,n.transparent=l.opacity<1||l.opacityFactor<1,a.push(n),r._setMaterialFromProfile(n,l),i.updateCommonUniforms(n),n.updateDeferredMaterials();for(f=1;f<n._deferredMaterials.length;f++){var g=n._deferredMaterials[f];t.is(g)&&(g.needsUpdate=!0)}}return a},applyRendering:function(e){this.isMeshToConsider(e)&&this.applyRenderingToMesh(e)},isMeshToConsider:function(e){return!(!e||!e.lineBuilder)},linesName:{occluded:"occluded",overlay:"overlay"},updateMaterialTextureInfo:function(e,i){t.is(e.uniforms)&&t.is(e.uniforms.l_uInfoTexture)?e.uniforms.l_uInfoTexture.value=i:e.isPDSFX&&e.updatePDSFXUniform("l_uInfoTexture",i)},initMeshes:function(e,t){var r=[e],n=this.getCompleteMaterialInfo().renderMode;this._renderMode=n;var a=this._getMaterial(r[0]._cityMaterial);return r[0]._cityMaterial=a,n===this.linesName.occluded||n===this.linesName.overlay?(this.setMaterialToMesh(r[0],a[0]),r[0].name="line_"+n+"_pass_0",r[0].mesh3js.name="line_"+n+"_pass_0",this.setRenderModeToMesh(r[0],n),r[0]._shaderType=this._getShaderType(),t&&(a[0].transparent=!0),this._setRenderPasses(r[0],n),a[0].updatePDSFXUniform("l_uUseOpacityFactor",0),a[0].useOpacityFactor=!1,this.updateMaterialTextureInfo(a[0],r[0].textureInfo.texture),i.updateCommonUniforms(a[0]),this.applyElementRendering(r[0])):(this.setMaterialToMesh(r[0],a[0]),r[0].name="line_occluded_pass_0",r[0].mesh3js.name="line_occluded_pass_0",this.setRenderModeToMesh(r[0],n),r[0]._shaderType=this._getShaderType(),this._setRenderPasses(r[0],"occluded"),this.updateMaterialTextureInfo(a[0],e.textureInfo.texture),i.updateCommonUniforms(a[0]),this.applyElementRendering(r[0]),r.push(r[0].clone()),r[1].setRendering=r[0].setRendering,r[1].resetFlags=r[0].resetFlags,r[1].setAttribute=r[0].setAttribute,r[1].get=r[0].get,this.setMaterialToMesh(r[1],a[1]),r[1].name="line_overlay_pass_1",r[1].mesh3js.name="line_overlay_pass_1",r[1].textureInfo=e.textureInfo,this._setRenderPasses(r[1],"overlay"),a[0].updatePDSFXUniform("l_uUseOpacityFactor",0),a[1].updatePDSFXUniform("l_uUseOpacityFactor",1),a[0].useOpacityFactor=!1,a[1].useOpacityFactor=!0,t&&(a[0].transparent=!0,a[1].transparent=!0),this.updateMaterialTextureInfo(a[1],e.textureInfo.texture),i.updateCommonUniforms(a[1]),this.applyElementRendering(r[1])),r},_refreshMaterial:function(e){var t=this._getMaterial();e.name.indexOf("pass_0")>-1?(e.setMaterial(t[0]),this.updateMaterialTextureInfo(t[0],e.textureInfo.texture),i.updateCommonUniforms(t[0]),this.applyElementRendering(e)):e.name.indexOf("pass_1")>-1&&(e.setMaterial(t[1]),this.updateMaterialTextureInfo(t[1],e.textureInfo.texture),i.updateCommonUniforms(t[1]),this.applyElementRendering(e))},shouldRebuild:function(e,i){if(this._parent(e,i))return!0;var r=e.getRenderingData(),n=i.getRenderingData();if(t.is(r.linecap)){if(!t.is(n.linecap))return!0;if(n.linecap!==r.linecap)return!0}else if(t.is(n.linecap))return!0;var a=n.geometricMode,s=r.geometricMode;if(a!==s){var o={stroke:{enable:!1}};return"extruded"===a?this.defaultRendering.addOver(o):"line"===a?(o.stroke.enable=!0,this.defaultRendering.addOver(o)):this.defaultRendering.addOver(o),!0}return"extruded"===a&&(a=n.extrusionHeight,(s=r.extrusionHeight)!==a)},_defineRenderPass:function(){var e;this._lineOccludedPassID="main",this._lineOverlayPassID="LineOverlayPass",this.urban&&void 0===this.urban.getView3D().getRenderPassManager().getPass(this._lineOverlayPassID)&&((e=new n(null,null,void 0,!0,!1,!1,this._lineOverlayPassID)).idString=this._lineOverlayPassID,this.urban.getView3D().getRenderPassManager().addPass(this._lineOverlayPassID,e,{after:"ClearDepthPass"}))},_getShaderType:function(){var e=this.getCompleteMaterialInfo(),i=e&&t.is(e.animation)&&!0===e.animation.enable?"dynamic":"static";if("static"===i){var r=this.getConcatenatedDashedPatterns();t.is(r)&&r.length>0&&(Object.assign({},e,{dashPattern:r}),i="dashed")}return i},setMaterialToMesh:function(e,t){var i=e.getMaterial();i&&i._globePool&&i.id!==t.id&&i._globePool.recycle(i),e.setMaterial(t),this._lastSeenMaterial=t},_getMaterialInfo:function(){var e=this._parent(),i=this.getConcatenatedDashedPatterns();return t.is(i)&&i.length>0&&(e.dashPattern=i),e.dashPatternLayer=this.dashPatternLayer,e},_getMaterial:function(e){var t=this._getMaterialInfo();return(!e||this._getShaderType()!==e[0]._shaderType||t.renderMode!==e[0].renderMode||e[0].dashPattern&&t.dashPattern.length!==e[0].dashPattern.length)&&(e=this._initMaterial()),r._setMaterialFromProfile(e[0],this.defaultMaterial),r._setMaterialFromProfile(e[0],t),r._setMaterialMapFromProfile(e[0],t,this),i.updateCommonUniforms(e[0]),e[0].updatePDSFXUniform("l_uUseOpacityFactor",0),e[0].useOpacityFactor=!1,e[0].transparent=e[0].opacity<1,e[0].dashPatternLayer=t.dashPatternLayer,2===e.length&&(r._setMaterialFromProfile(e[1],this.defaultMaterial),r._setMaterialFromProfile(e[1],t),r._setMaterialMapFromProfile(e[1],t,this),i.updateCommonUniforms(e[1]),e[1].updatePDSFXUniform("l_uUseOpacityFactor",1),e[1].useOpacityFactor=!0,e[1].transparent=e[1].opacity<1||e[1].opacityFactor<1,e[1].dashPatternLayer=t.dashPatternLayer),e},initMesh:function(e){if(t.is(e)&&e.children.length>0){var i=null,r=this.getRenderModeFromMesh(e.children[0]);if(r!==this._getMaterialInfo().renderMode){var n=e.lineBuilder._rootNode,a="dual"===r,s=this.initMeshes(e.children[0]);if(this.nbLabelNode>0&&s.push(n.children[n.children.length-1]),a){var o=e.children[1].getMaterial();o._globePool&&o._globePool.recycle(o)}n.removeChildren();for(var d=0;d<s.length;++d)s[d].lineBuilder=e.lineBuilder,n.addChild(s[d]);i=s[0]._cityMaterial}else if(e.children[0]._cityMaterial&&(i=e.children[0]._cityMaterial),i=this._getMaterial(i),e.children[0]._cityMaterial=i,e.children[0].getMaterial().id!==i[0].id)for(d=0;d<e.children.length-this.nbLabelNode;++d)this.setMaterialToMesh(e.children[d],i[d]),e.children[d]._shaderType=this._shaderType;for(var u in{opacityFactor:"_setOpacityFactor",lineWidth:"_setLineWidth",dashPatternLayer:"_setDashPatternIndex",minOpacity:"_setMinOpacity"})e.children[0].setAttribute(u,i[0][u]);if(t.is(i[0].animation)&&!0===i[0].animation.enable){void 0===e.lineBuilder.tokenUpdateEvent&&(i[0].transparent=!0,"dual"===e.children[0]._renderType&&(i[1].transparent=!0),e.lineBuilder.clockTime=0,e.lineBuilder.tokenUpdateEvent=l.subscribeTo("/3DEXPERIENCity/onUpdate",e.lineBuilder._update.bind(e.lineBuilder)));for(var u in{minOpacity:"_setMinOpacity",speed:"_setSpeed",samplingRate:"_setSamplingRate",nbPoint:"_setNbPoints",dashSize:"_setDashSize",gapSize:"_setGapSize",reverse:"_setReverse",loop:"_setLoop"})void 0!==i[0].animation[u]&&null!==i[0].animation[u]&&e.children[0].setAttribute(u,i[0].animation[u])}else void 0!==e.lineBuilder.tokenUpdateEvent&&(l.unsubscribe(e.lineBuilder.tokenUpdateEvent),e.lineBuilder.tokenUpdateEvent=void 0);this.updateMaterialTextureInfo(i[0],e.children[0].textureInfo.texture),2===i.length&&this.updateMaterialTextureInfo(i[1],e.children[0].textureInfo.texture)}},setAttribute:function(e,t){this[d.attributeSetter[e]](t)},_setRenderPasses:function(e,t){var i={occluded:this._lineOccludedPassID,overlay:this._lineOverlayPassID};e.setRenderPasses([i[t]])},applyPrimitiveRenderingToMesh:function(e){if(e){var t,i=e.children.length;for(t=0;t<i;t++)this.applyElementRendering(e.children[t])}}});return d._pdsfxMaterial={},d._poolMaterial={},d.shaderLine={dynamic:function(){return void 0===d._poolMaterial.dynamic&&(d._pdsfxMaterial.dynamic=i.getPDSFXMaterial([d.dynamicLine_PDSFX],"line"),d._poolMaterial.dynamic=new o(d._pdsfxMaterial.dynamic.clone.bind(d._pdsfxMaterial.dynamic)),d._poolMaterial.dynamic.name="line_dynamic_pool"),d._poolMaterial.dynamic.use()},static:function(){return void 0===d._poolMaterial.static&&(d._pdsfxMaterial.static=i.getPDSFXMaterial([d.line_PDSFX],"line"),d._poolMaterial.static=new o(d._pdsfxMaterial.static.clone.bind(d._pdsfxMaterial.static)),d._poolMaterial.static.name="line_static_pool"),d._poolMaterial.static.use()},dashed:function(e){var t=e.dashPattern.length;if(void 0===d._poolMaterial["dashed_"+t]){Object.assign({isDashedLine:!0,isCPUPattern:!0,scale:1},e);d.dashedLine_PDSFX.uniforms.dashPatternCity.length=t,d._pdsfxMaterial["dashed_"+t]=i.getPDSFXMaterial([d.dashedLine_PDSFX],"line"),d._poolMaterial["dashed_"+t]=new o(d._pdsfxMaterial["dashed_"+t].clone.bind(d._pdsfxMaterial["dashed_"+t])),d._poolMaterial["dashed_"+t].name="line_dashed_"+t+"_pool"}return d._poolMaterial["dashed_"+t].use()}},d.attributeSetter={wireframe:"",alphaTest:"",specular:"",ambient:"",depthTest:"",depthWrite:"",shininess:"",diffuse:"",side:"",elevation:"",elevationOffset:"",elevationMode:"",renderMode:""},d.getSettableAttributes=function(){var e,t=[];for(e in d.attributeSetter)d.attributeSetter.hasOwnProperty(e)&&t.push(e);return t},d.line_PDSFX={attributes:{blending:e.NormalBlending},uniforms:{l_uInfoTexture:{type:"t2",value:void 0},l_uUseOpacityFactor:{type:"f",value:0},opacityCity:{type:"f",value:1},diffuseCity:{type:"c",value:new e.Color(16711680)},ambientCity:{type:"c",value:new e.Color(16711680)},minDist:{type:"f",value:200},maxDist:{type:"f",value:2e3},minWidth:{type:"f",value:1},dynamicUpdate:{type:"b",value:!1}},varyings:{vInstanceColor:{type:"v4",value:new e.Vector4(1,1,1,1)},l_useColor:{type:"f",value:0},l_useOpacity:{type:"f",value:0},l_useLineWidth:{type:"f",value:0},l_visibility:{type:"f",value:0},l_vColor:{type:"v3",value:new e.Vector3(1,1,1)},l_fHalfWidth:{type:"f",value:0},l_vOpacity:{type:"f",value:0},l_vOpacityFactor:{type:"f",value:0},l_vMinOpacity:{type:"f",value:0}},VS_global_code:["float getFlag(float flags, float row){","    float res = mod(flags, row*2.0); ","    if(res >= row){","       return 1.0;","   }","   return 0.0; ","}","vec3 getColor(sampler2D texture, float nbColumn, float nbLines, float indice){","vec3 color = vec3(0,0,0);","color.r = texture2D( texture, vec2( 0.5/nbColumn, indice/nbLines ) ).x;","color.g = texture2D( texture, vec2( 1.5/nbColumn, indice/nbLines ) ).x;","color.b = texture2D( texture, vec2( 2.5/nbColumn, indice/nbLines ) ).x;","return color;","}"].join("\n"),VS_overridableFunctions:{ComputeCommonValues:["float l_fpixPerRow = texture2D( l_uInfoTexture, vec2( 0.0, 0.0 ) ).x;","float l_fnbLines = texture2D( l_uInfoTexture, vec2( 1.5/l_fpixPerRow, 0.0 ) ).x + 1.0;","float l_fscale = texture2D( l_uInfoTexture, vec2( 2.5/l_fpixPerRow, 0.0 ) ).x;","float l_findice = (vGetAttribColor().r + 1.5);","float l_useFlags = texture2D( l_uInfoTexture, vec2( 15.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_useColor = getFlag(l_useFlags, 1.0);","l_useOpacity = getFlag(l_useFlags, 2.0);","l_useLineWidth = getFlag(l_useFlags, 4.0);","l_fHalfWidth = texture2D( l_uInfoTexture, vec2( 3.5/l_fpixPerRow, l_findice/l_fnbLines) ).x *0.5;","l_vColor = getColor(l_uInfoTexture, l_fpixPerRow, l_fnbLines, l_findice);","l_vOpacity = texture2D( l_uInfoTexture, vec2( 4.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vOpacityFactor = texture2D( l_uInfoTexture, vec2( 5.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vMinOpacity = texture2D( l_uInfoTexture, vec2( 12.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","if (dynamicUpdate) {","vec4 mvPosition = vGetWorldViewMatrix() * vec4(vGetAttribPosition().xyz, 1.0);","float dist = length(mvPosition);","if ( dist < minDist ) { ","l_fHalfWidth = l_fHalfWidth;","l_vOpacity = l_vOpacity;","}","else if ( dist > maxDist ) {","l_fHalfWidth = minWidth/2.0;","l_vOpacity = l_vMinOpacity;","}","else {","float altitudeFactor = (1.0 - ((dist - minDist) / (maxDist - minDist)));","l_fHalfWidth = l_fHalfWidth * altitudeFactor + minWidth/2.0 * (1.0 - altitudeFactor);","l_vOpacity = max(l_vMinOpacity, l_vOpacity * altitudeFactor);","}","}",""].join("\n"),ComputeHalfWidth:["return l_fHalfWidth;"].join("\n")},FS_global_code:["vec4 _texelCity = vec4(1.0);","float _alphaCity = 1.0;","#define CITY_HACK_VERTEXCOLOR 1","//#define  CITY_HACK_ALPHATEST 1","vec3 colorInstance= vec3(1.0,1.0,1.0);","float opacityInstance = 1.0;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["colorInstance = diffuseCity.xyz;","if (l_useColor > 0.5) {","colorInstance = l_vColor.xyz;","}"," #ifdef GAMMA_INPUT","   colorInstance *= colorInstance;"," #endif","opacityInstance = opacityCity;","if (l_useOpacity > 0.5) {","opacityInstance = l_vOpacity;","}","if (l_uUseOpacityFactor > 0.5) {","opacityInstance *= l_vOpacityFactor;","}",""].join("\n"),ComputeHalfWidth:["return l_fHalfWidth;"].join("\n"),ComputeAlbedo:["cAlbedo = colorInstance;"].join("\n"),__ComputeDiffuseTexel:["return vec4(_texelCity.xyz, 1.0);"].join("\n"),ComputeOpacity:["cOpacity = opacityInstance;"].join("\n"),__ComputeDiscard:["if (_alphaCity < alphaTestCity || l_visibility > 0.5) {","return true;","}","return false;"].join("\n")}},d.dynamicLine_PDSFX={depends:[d.line_PDSFX],uniforms:{clockTime:{type:"f",value:0}},varyings:{l_vSpeed:{type:"f",value:0},l_vDashSize:{type:"f",value:0},l_vGapSize:{type:"f",value:0},l_vSamplingRate:{type:"f",value:0},l_vNbPoints:{type:"f",value:0},l_vOffset:{type:"f",value:0},l_vReverse:{type:"f",value:0},l_vMinOpacity:{type:"f",value:0},l_vLoop:{type:"f",value:0},lineInfo:{type:"v4",value:new e.Vector4(1,1,1,1)}},VS_overridableFunctions:{ComputeCommonValues:["l_vSpeed = texture2D( l_uInfoTexture, vec2( 6.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vNbPoints = texture2D( l_uInfoTexture, vec2( 7.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vOffset = texture2D( l_uInfoTexture, vec2( 8.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vReverse = texture2D( l_uInfoTexture, vec2( 9.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vDashSize = texture2D( l_uInfoTexture, vec2( 10.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vSamplingRate = texture2D( l_uInfoTexture, vec2( 11.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vMinOpacity = texture2D( l_uInfoTexture, vec2( 12.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vGapSize = texture2D( l_uInfoTexture, vec2( 13.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","l_vLoop = texture2D( l_uInfoTexture, vec2( 14.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;","lineInfo = vec4(vGetAttribColor(), 1.0);"].join("\n")},FS_global_code:["bool isDiscarded = false;","vec4 newColor = vec4(1.0);"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["float alpha = opacityInstance;","float minAlpha = l_vMinOpacity;","float speed = l_vSpeed;","float samplingRate = l_vSamplingRate;","float nbPoints = l_vNbPoints;","float coef = 0.0;","if (samplingRate == 0.0) {"," float startLength = l_vSpeed * clockTime;"," float endLength = max(0.0, startLength - l_vDashSize);"," if (l_vLoop < 0.5) {","   if (l_vReverse < 0.5 && lineInfo.z < startLength) {","     isDiscarded = true;","   }","   else if (l_vReverse > 0.5 && (lineInfo.y - lineInfo.z) < startLength ) {","     isDiscarded = true;","   }"," }"," float distLength = startLength - endLength;"," float divisor = lineInfo.y/nbPoints;"," if (l_vGapSize > 0.0) {","   divisor = (l_vDashSize + l_vGapSize);"," }"," startLength = mod(startLength, divisor);"," endLength = mod(endLength, divisor);"," float curPosition = lineInfo.z;"," if (l_vReverse > 0.5) {","   curPosition = lineInfo.y - curPosition;"," }"," float offsetLength = floor(curPosition / divisor) * divisor;"," float currentLength = curPosition - offsetLength;"," if (currentLength > (endLength) && currentLength < (startLength)) {","   coef = (startLength - currentLength) / distLength;"," } else if (currentLength > endLength && currentLength > startLength && endLength > startLength) {","   coef = 1.0 - ((currentLength - endLength) / distLength);"," } else if (currentLength > 0.0 && currentLength < startLength && startLength < endLength) {","   coef = (startLength - currentLength) / distLength;"," } else {","   coef = 1.0;"," }","}","else {"," float startTime = clockTime;"," float currentTime = lineInfo.w * samplingRate;","// Can't find a way to compute quickly an average speed per fragment..."," float averageSpeed = l_vSpeed; // lineInfo.y / (lineInfo.x * samplingRate);"," float endTime = startTime - l_vDashSize/averageSpeed;"," if (currentTime < endTime || currentTime > startTime) {","   if (minAlpha == 0.0) { ","     discard;","   } else {","     coef = 1.0;","   }"," } else {","   coef = (startTime - currentTime) / (startTime - endTime);"," }","}","newColor = vec4(colorInstance.xyz, (1.0-coef)*(alpha-minAlpha)+minAlpha);"].join("\n"),ComputeAlbedo:["cAlbedo = newColor.xyz;"].join("\n"),ComputeOpacity:["cOpacity = newColor.w;"].join("\n"),ComputeDiscard:["if (isDiscarded) {","return true;","}","return false;"].join("\n")}},d.dashedLine_PDSFX={depends:[d.line_PDSFX],attributes:{isDashedLine:!0,isCPUPattern:!0,scale:1},uniforms:{dashPatternCity:{type:"fv1",value:[0],length:1},scaleCity:{type:"f",value:1}},varyings:{patterntoUseStartIndexCity:{type:"f",value:0},totalSizeToUseCity:{type:"f",value:0}},VS_overridableFunctions:{ComputeCommonValues:["patterntoUseStartIndexCity = float(int(texture2D( l_uInfoTexture, vec2( 16.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x));","totalSizeToUseCity = float(int(texture2D( l_uInfoTexture, vec2( 17.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x));",""].join("\n")},FS_global_code:["#ifdef PATTERN_LENGTH","float _floatRound(in float decimal){ ","float low = floor(decimal);","float high = ceil(decimal);","float rest = decimal - low;","float res = high;","if (rest < 0.5 ) {","res = low;","}","return res;","}","vec3 _getPatternInfo(in float dist) {","int index = 0;","int startindex = int(_floatRound(patterntoUseStartIndexCity));","float prec = 0.0, cur = 0.0;","for (int i = 0; i < PATTERN_LENGTH; i++) {","if (i >= startindex) {","cur = max(scaleCity,1e-6)*dashPatternCity[i];","if (cur > dist) {","break;","}","prec = cur;","index++;","}","}","return vec3(float(index + startindex),prec,cur);","}","float _getPatternAlpha(in float dist) {","float length = _floatRound(totalSizeToUseCity);","length = max(scaleCity,1e-6) * length;","float mDist = mod( dist, length );","vec3 patternInfo = _getPatternInfo(mDist);","if (abs(mod(patternInfo.x,2.0)) < 0.5) {","return 0.0;","}","return 1.0;","}","#endif"].join("\n"),FS_overridableFunctions:{ProcessLinePattern:["","#ifdef PATTERN_LENGTH","patternValue = _getPatternAlpha(currentPixelDistance);","#endif",""].join("\n")}},d}),define("DS/XCityRendering/RenderingHandlerPOI3DBillboard",["DS/XCityRendering/RenderingHandlerHeatMap","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/Visualization/ThreeJS_DS","DS/XCityRendering/DatavizRendering","DS/XCityTools/TextureManager","DS/XCityRendering/FeatureRendering","DS/XCityTools/OGCFilter"],function(e,t,i,r,n,a,s,o,l){"use strict";return e.extend({init:function(e,t,i){this._parent(e,t,i),this.enableAtlasing=!0,this.type="POI3D"},addDefaultDatavizMapping:function(e){var i={offsetFunction:{ratio:new n.Vector3(-.5,1,0),pixel:new n.Vector3}},r=(new l).propertyName("FILENAME").isNotNull().and((new l).propertyName("FILENAME").isNotEqualTo("")),s=new a(i,r,e);s.addOverIds("3DXCityDefaultIDdefaultMapBillboard"),this.defaultRendering.addOver(s),t.is(this._leafSetRendering)&&this._leafSetRendering.defaultRendering.addOver(s)},setLeafSetRendering:function(e){this._parent(e),this._leafSetRendering.defaultRendering.addOver(this.defaultRendering)},getDefaultRendering:function(){return Object.assign({},this._parent(),{scale:new n.Vector3(1,1,1),renderMode:"overlay",opacityFactor:"0.3",alphaTest:.1,altitude:void 0,styleClass:"",offsetFunction:{ratio:{x:-.5,y:.5,z:.5},pixel:{x:0,y:0,z:0}},mapUrl:null,map:null,shapeType:"billboard"})},updateRendering:function(e){var t=new o(e);this._parent(t)},initMesh:function(e){if(t.is(e)){var r=e._shapeType;if(t.is(r)){if("anchor"===r)return void this.initMeshAnchor(e);t.is(r)&&"billboard"===r&&t.is(this.atlasId)?this.currentRendering.set("mapAtlasId",this.atlasId):t.is(this.urlTexture)?this.applyDefaultMapUrl():this.currentRendering.set("map",null)}var n=this._getMaterial(e.mesh3js.material),a=n;"PoiTransparentOverlayPass"===e.passes[0]&&"dual"===this.getCompleteMaterialInfo().renderMode&&(a.opacity=this.getCompleteMaterialInfo().opacity*this.getCompleteMaterialInfo().opacityFactor),"OverlayPostPass"===e.passes[0]&&(a.depthTest=!1),t.is(this.atlasId)&&t.is(r)&&"billboard"===r&&this.addAtlasUniforms(n),i.updateCommonUniforms(a),this.setMaterialToMesh(e,a),this._lastSeenMaterial=a}},initMeshAnchor:function(e){var t=this._getMaterialInfo();t.map=void 0,t.mapUrl=void 0,t.alphaTest=void 0;var n=e.mesh3js.material;r._setMaterialFromProfile(n,t),i.updateCommonUniforms(n);var a=n;"PoiTransparentOverlayPass"===e.passes[0]&&"dual"===this.getCompleteMaterialInfo().renderMode&&(a.opacity=this.getCompleteMaterialInfo().opacity*this.getCompleteMaterialInfo().opacityFactor),"OverlayPostPass"===e.passes[0]&&(a.depthTest=!1),i.updateCommonUniforms(a),this.setMaterialToMesh(e,a),this._lastSeenMaterial=a},shouldRebuild:function(e,t){if(this._parent(e,t))return!0;var i=e.getRenderingData(),r=t.getRenderingData(),n=JSON.stringify(r.offsetFunction),a=JSON.stringify(i.offsetFunction);if(n!==a)return!0;var s,o,l=["mapUrl"],d=l.length;for(s=0;s<d;s++){var u=l[s];if((n=r[u])!==(a=i[u])){o=!0;break}}return!0===o},applyDefaultMapUrl:function(){var e=this.defaultRendering.get("mapUrl");if(this.urlTexture!==e){this.defaultRendering.set("mapUrl",this.urlTexture);var i=this.defaultRendering.get("mapParams");t.is(this.iconTopLeft)&&(t.is(i)||(i={}),i.width=this.widthTexture,i.height=this.heightTexture,this.defaultRendering.set("mapParams",i),this.defaultRendering.set("offsetFunction",{pixel:{x:this.iconTopLeft[1],y:-this.iconTopLeft[0]},ratio:{x:0,y:0}}),this.updateCurrentMaps())}},setCssMap:function(e,i,r,n){e!==this.urlTexture&&(this.urlTexture=e,t.is(i)&&(this.iconTopLeft=i,this.widthTexture=r,this.heightTexture=n),this.applyDefaultMapUrl())},onTextureApplied:function(e,r,n,a){if(e&&(r.updatePDSFXUniform("useMapCity",!0),r.updatePDSFXUniform("mapCityLoaded",!0)),this._parent(e,r,n,a),t.is(r[a.param])){var s,o,l=r[a.param].image.width;t.is(l)&&(i.updateSingleUniform(r,"width",l),o=.5*-l);var d=r[a.param].image.height;t.is(d)&&(i.updateSingleUniform(r,"height",d),s=-d);var u=n[a.param+"Params"];t.is(u)&&(t.is(u.top)&&(s=u.top),t.is(u.left)&&(o=u.left)),t.is(s)&&i.updateSingleUniform(r,"top",s),t.is(o)&&i.updateSingleUniform(r,"left",o)}},setTextureInfo:function(e,i,r,n){var a=!0;e.top=0,e.left=0,e.indexTexture=0;var s=this.getCurrentRenderingDifference(i,r);if(t.is(s.mapUrl)?t.is(s.offsetFunction)||(s.offsetFunction={ratio:{x:-.5,y:.5,z:.5},pixel:{x:0,y:0,z:0}}):s=this.getCompleteMaterialInfo(i,r),t.is(s.mapUrl)){e.top=-s.offsetFunction.pixel.y,e.left=s.offsetFunction.pixel.x,e.mapUrl=s.mapUrl;var o=this.getTextureInfo(s.mapUrl);if(t.is(o)){a=!1,e.indexTexture=o.index;var l=o.width,d=o.height;t.is(o.atlasWidth)&&(l*=o.atlasWidth),t.is(o.atlasHeight)&&(d*=o.atlasHeight),e.top-=s.offsetFunction.ratio.y*d,e.left+=s.offsetFunction.ratio.x*l,t.is(n)&&(n.widthTexture=l,n.heightTexture=d)}else e.indexTexture=0}else e.top=-128,e.left=-128;return a},computePOI3DBillboardLabelUniforms:function(e,i,r,n,a){if(t.is(e.getPDSFXUniform("top"))){var s=r.height/2-a/2;s+=a*i.label.position.labelOffset.y,s+=i.label.position.geometryOffset.y*r.height,s+=i.label.position.offset.y,e.updatePDSFXUniform("top",s)}if(t.is(e.getPDSFXUniform("left"))){var o=-n/2;o+=n*i.label.position.labelOffset.x,o+=i.label.position.geometryOffset.x*r.width,o+=i.label.position.offset.x,e.updatePDSFXUniform("left",o)}},updateLabelPos:function(e,i){if(t.is(this._content)&&t.is(this._content.parentFeatureID)&&t.is(xCity._urbanImpl.labelManager.groups[this._content.parentFeatureID])&&t.is(xCity._urbanImpl.labelManager.groups[this._content.parentFeatureID].pois)){var r=xCity._urbanImpl.labelManager.groups[this._content.parentFeatureID].pois.find(t=>t.name==="textNode_"+e);if(t.is(r)){var n=r.material,a=this.getCompleteMaterialInfo(),s=a.scale,o={width:i.atlasWidth*i.width*s.x,length:s.z,height:i.atlasHeight*i.height*s.y},l=n.getPDSFXUniform("labelSize").value;this.computePOI3DBillboardLabelUniforms(n,a,o,2*l.x,2*l.y)}}else console.warn("couldn't update label position because the matching group id coudldn't be found in labelManager")},updateTextureInfo:function(e,i,r){if(t.is(e)&&t.is(r)&&!0===e.isInstanceNode3D){var n={},a=this.setTextureInfo(n,i,r),s=this.getTextureInfo(n.mapUrl);if(this.updateLabelPos(i,s),a)console.error("texture download ended but no texture available!");else{var o=n.left,l=n.top,d=n.indexTexture;if(t.is(e.mesh3js.userData.cgmIds)){var u=e.mesh3js.userData.cgmIds.indexOf(i),f=e.mesh3js.instanceAttribArrays.instanceFloats.array,h=!1;d!==f[4*u+1]&&(f[4*u+1]=d,h=!0),o!==f[4*u+2]&&(f[4*u+2]=o,h=!0),l!==f[4*u+3]&&(f[4*u+3]=l,h=!0),h&&(e.mesh3js.instanceAttribArrays.instanceFloats.isDynamic=!0)}}}},onTextureDownloadStart:function(e,t,i){e.updatePDSFXUniform("useMapCity",!0),e.updatePDSFXUniform("mapCityLoaded",!1)},getTextureInfo:function(e){return s.getTextureInfoByUrl(e,this.atlasId)},getCompleteMaterialInfo:function(e,i){var r=this._parent(e,i);return r&&t.is(r.mapUrl)&&(this._mapUrls||(this._mapUrls={}),s.getAtlas(r.mapUrl)||(this._mapUrls[r.mapUrl]=!0)),r}})}),define("DS/XCityRendering/RenderingHandlerPOI3DBillboardAlignedLabel",["DS/XCityRendering/RenderingHandlerPOI3DBillboard","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/XCityRendering/PrimitiveRendering","DS/Visualization/ThreeJS_DS","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering","DS/XCityTools/TextureManager","DS/XCityRendering/FeatureRendering","DS/XCityTools/TextureTools"],function(e,t,i,r,n,a,s,o,l,d,u){"use strict";return e.extend({init:function(e,t,i){this._parent(e,t,i),this.enableAtlasing=!0,this.type="POI3DBillboardAlignedLabel"},addDefaultDatavizMapping:function(){},startFontAtlas:function(e){if(!t.is(this._fontAtlas)){for(var i=" WXCVBNPOIUYTREZAQSDFGHJKLM'-azertyuiop^$*ùmlkjhgfdsq<wxcvbnè_çàÉ,;:!²1234567890°+£¨%µ§/.?<ÇÅÆÑ╘ŒÖΘΩδÜ~{[|`¤^@]}âïôûêäëöüÿ &é'(-)=",r=Object.assign({},e),n={},a=0;a<i.length;a++){var s=i[a];if(!t.is(n[s])){r.name=s;var o=this._getUrlFromLabel(e,s);l.getOrCreateGlypheTexure(o,r);n[s]=o}}this._createAtlasFromUrlsList(Object.values(n)),this._fontAtlas=this.atlasId}},_getUrlFromLabel:function(e,i){var r=""+this._prefix;return t.is(e)&&t.is(e.style)&&(t.is(e.style["font-family"])&&(r+=e.style["font-family"]),t.is(e.style["font-size"])&&(r+=e.style["font-size"]),t.is(e.style.color)&&(r+=e.style.color.hexToRgb()?e.style.color.hexToRgb():e.style.color),t.is(e.style["font-weight"])&&(r+=e.style["font-weight"]),t.is(e.style["text-shadow"])&&(r+=e.style["text-shadow"])),t.is(i)?r+=i:t.is(e.name)&&(r+=e.name),r},setTextureInfo:function(e,i,r,n){var a=!0;e.top=0,e.left=0,e.indexTexture=0;var s=this.getCompleteMaterialInfo(i,r);if(s.mapUrl=this._getUrlFromLabel(s.label,n.value),t.is(s.offsetFunction)||(s.offsetFunction={ratio:{x:-.5,y:.5,z:.5},pixel:{x:0,y:0,z:0}}),t.is(s.mapUrl)){e.top=-s.offsetFunction.pixel.y,e.left=s.offsetFunction.pixel.x,e.mapUrl=s.mapUrl;var o=this.getTextureInfo(s.mapUrl);if(t.is(o)){a=!1,o.texturenotloaded&&(a=!0),e.indexTexture=o.index;var l=o.width,d=o.height;t.is(o.atlasWidth)&&(l*=o.atlasWidth),t.is(o.atlasHeight)&&(d*=o.atlasHeight),e.top-=s.offsetFunction.ratio.y*d,e.left+=s.offsetFunction.ratio.x*l}else e.indexTexture=0}return a},updateTextureWhenReady:function(e,i){if(t.is(e)&&t.is(i)){var r=this;this.atlasId;t.is(this.atlasId)&&l.addCallbackToAtlas(this.atlasId,function(){var n,a,s,o,l,d,u=Object.keys(e),f=u.length,h=i.children.length;for(o=0;o<h;o++)if(d=i.children[o],t.is(d))for(n=0;n<f;n++){a=u[n];var g=e[a].glyphes;s=e[a].attributes;var c=Object.keys(g);for(l=0;l<c.length;l++){var p=c[l];r.updateTextureInfoOfAgent(d,a,s,p,g[p])}}})}},updateTextureInfoOfAgent:function(e,i,r,n,a){if(t.is(e)&&t.is(r)&&!0===e.isInstanceNode3D){var s={};if(this.setTextureInfo(s,i,r,a))console.error("texture download ended but no texture available!");else{var o=s.left,l=s.top,d=s.indexTexture;if(t.is(e.mesh3js.userData.cgmIds)){var u=e.mesh3js.instanceAttribArrays.instanceFloats.array,f=!1;d!==u[4*n+1]&&(u[4*n+1]=d,f=!0),o!==u[4*n+2]&&(u[4*n+2]=o,f=!0),l!==u[4*n+3]&&(u[4*n+3]=l,f=!0),f&&(e.mesh3js.instanceAttribArrays.instanceFloats.isDynamic=!0)}}}},getCompleteMaterialInfo:function(e,i){if(t.is(this.lastMaterialInfo)||(this.lastMaterialInfo={}),!t.is(this.lastMaterialInfo[e])){if(!t.is(i))return this._parent(e,i);this.lastMaterialInfo[e]=this._parent(e,i)}return this.lastMaterialInfo[e]}})}),define("DS/XCityRendering/RenderingHandlerBuilding",["DS/Visualization/ThreeJS_DS","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/XCityRendering/RenderingHandlerAltitude","DS/XCityRendering/BuildingTdbStore","DS/XCityRendering/BuildingTdbAtlas","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/XCityTools/Expression","DS/XCityRendering/DatavizRendering","DS/Plugins/RenderPass","DS/xCityBasicUtils/ColorGradient","DS/XCityRendering/RenderingHandlerLine"],function(e,t,i,r,n,a,s,o,l,d,u,f,h,g){"use strict";var c=r.extend({init:function(e,t){this._parent(e),this.urban=e,this.material2update=[],this.animationMaterials={},this.animationTime=-1,s.subscribeTo("/3DEXPERIENCity/onUpdate",this._update.bind(this)),this.isInWebWorkers="webworkerstitle"===self.document.title,this.rasterId="",this.rasterMinlvl=-1,t&&(t.rasterId&&(this.rasterId=t.rasterId),t.rasterMinlvl&&(this.rasterMinlv=t.rasterMinlv)),this._defineRenderPass(),this.savedParam=t,this._initStores(this.savedParam),this.type="Building"},_attributesforRebuild:["extrusionHeight","stroke"],shouldRebuild:function(e,t){if(this._parent(e,t))return!0;var i,r=this._attributesforRebuild,n=r.length,a=!1;for(i=0;i<n;i++){var s=r[i],l=e.hasDatavizOnAttribute(s),d=t.hasDatavizOnAttribute(s);if(l||d){a=!0;break}if(l=e.get(s),d=t.get(s),!1===o.simpleJSONCompare(l,d)){a=!0;break}}return a},getDefaultRendering:function(){return this._defaultStrokeParameters={enable:!1,color:new h(new e.Color("#000000")),ambient:new h(new e.Color("#000000")),diffuse:new h(new e.Color("#000000")),lineWidth:2,dashPattern:null},Object.assign({},this._parent(),{wallTexturesUrl:null,roofTexturesUrl:null,r_mode:-1,extrusionHeight:10,renderMode:"occluded",opacityFactor:.5,stroke:this._defaultStrokeParameters})},_initStores:function(e){var t=this.getCompleteMaterialInfo();if(this.isInWebWorkers)this.tdbStore={};else if(o.is(this.tdbStore)||(this.tdbStore=new n(this.urban,"XCityEnvironment/assets/textures/buildings/white.jpg")),this.tdbStore.atlasBaseURL!==t.wallTexturesUrl){var i=t.wallTexturesUrl;o.is(i)||(i=void 0),this.tdbStore.atlasBaseURL=i}o.is(this.roofAtlas)||(this.roofAtlas=new a(this.urban,"roof",e)),this.roofAtlas._atlasBaseURL!==t.roofTexturesUrl&&(o.is(t.roofTexturesUrl)?this.roofAtlas.loadAtlas(t.roofTexturesUrl,function(e){e||l.warn("Unable to load roof atlas...")}.bind(this)):o.is(this.roofAtlas._atlasBaseURL)&&this.roofAtlas.dispose())},isInLineMode:function(){var e=this.getCompleteMaterialInfo();return!(!o.is(e.geometricMode)||"line"!==e.geometricMode)},updateRendering:function(e){this._parent(e);this._initStores(this.savedParam),this.updateStrokeRendering(e)},updatePrimitiveRendering:function(e){if(this._parent(e),!o.is(this._strokeRenderingHandler))this.getStrokeHandler();o.is(this._strokeRenderingHandler)&&this._strokeRenderingHandler.currentRendering.addOver(e)},updateStrokeRendering:function(e){if(!o.is(this._strokeRenderingHandler))this.getStrokeHandler();if(o.is(this._strokeRenderingHandler)){var t=this.defaultRendering.getStrokeFeatureRendering(),i=this.getFeatureRendering();t.set("renderMode",i.get("renderMode")),this._strokeRenderingHandler.defaultRendering.addOver(t),o.is(e)&&(e=e.getStrokeFeatureRendering()),delete this._strokeRenderingHandler.defaultRendering.renderingData.map,delete this._strokeRenderingHandler.defaultRendering.renderingData.mapParams,delete this._strokeRenderingHandler.defaultRendering.renderingData.mapUrl,this._strokeRenderingHandler.updateRendering(e)}},_update:function(e){this._updateAnimationUniforms(e);for(var t,i=this.material2update.length;i--;)for(t=this.material2update[i].callback.length;t--;)this.material2update[i].callback[t](this.material2update[i].material)},_enable:function(e,t){var i=function(e){for(var t=this.material2update.length;t--;)e===this.material2update[t].material&&this.material2update.splice(t,1)}.bind(this);if(void 0!==e&&void 0!==t){for(var r=-1,n=this.material2update.length;n--;)e===this.material2update[n].material&&(r=n);-1===r&&(r=this.material2update.length,this.material2update.push({material:e,callback:[]}),void 0===e.observers&&(e.observers=[]),e.observers.push(i));for(var a=0;a<t.length;++a)void 0!==t[a]&&this.material2update[r].callback.push(t[a])}},dispose:function(){l.warn("Dispose: RenderingHandlerBuilding"),void 0!==this.roofAtlas&&(this.roofAtlas.dispose(),this.roofAtlas=void 0),void 0!==this.tdbStore&&(this.tdbStore.dispose(),this.tdbStore=void 0),this._parent()},_initMaterial:function(){return o.is(this._material)||(this._material=t.getCustomShaderMaterial([t.common,t.vertexInformation,t.clipPlanes,c._building,t.urbanLights,t.shadowMapCustom])),this.material},_getCommonShaderStructure:function(){var i={b_infoTexture:{type:"t2",value:t.whiteMap},extrusionFactor:{type:"f",value:1},diffuseCity:{type:"c",value:new e.Color(16711680)},opacityCity:{type:"f",value:1},alphaTestCity:{type:"f",value:.5}},r={b_color:{type:"v4",value:new e.Vector4(0,0,0,1)},b_flag:{type:"f",value:0}},n=["float b_rgba2float( vec4 color ) {","    return dot( color, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/16581375.0) );","}","float b_rgba2int( vec4 color ) {","    return ( 255.0 * ( color.r + (color.g*255.0) + (color.b*65025.0) + (color.a*16581375.0) ) );","}","float getLastBit( float flags ){","    return mod( flags, 2.0 ); ","}"].join("\n"),a={ComputeObjectPosition:["float b_pixPerRow = b_rgba2int( texture2D( b_infoTexture, vec2( 0.0, 0.0 ) ) );","float b_nbBuilding = b_rgba2int( texture2D( b_infoTexture, vec2( 1.5/b_pixPerRow, 0.0 ) ) );","float b_indice = (vGetAttribTexCoord0().x + .5)/b_nbBuilding;","float b_altitude = b_rgba2int( texture2D( b_infoTexture, vec2( 2.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 3.5/b_pixPerRow, b_indice ) ) );","vec3 vertexposition = vGetAttribPosition();","float buildingheight = vertexposition.z - b_altitude;","//vec3 position = vertexposition;","vec3 position = vGetAttribPosition();","float factor = extrusionFactor;","//if( buildingheight > 0.0  ) {","//  position.z = mix(position.z - buildingheight,position.z,factor);","//}","return position;"].join("\n"),ComputeVaryingValues:["float b_pixPerRow = b_rgba2int( texture2D( b_infoTexture, vec2( 0.0, 0.0 ) ) );","float b_nbBuilding = b_rgba2int( texture2D( b_infoTexture, vec2( 1.5/b_pixPerRow, 0.0 ) ) );","float b_indice = (vGetAttribTexCoord0().x + .5)/b_nbBuilding;","float b_texIndice = b_rgba2int( texture2D( b_infoTexture, vec2( 1.5/b_pixPerRow, b_indice ) ) );","float b_altitude = b_rgba2int( texture2D( b_infoTexture, vec2( 2.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 3.5/b_pixPerRow, b_indice ) ) );","b_color = texture2D( b_infoTexture, vec2( 0.0, b_indice ) );","vec4  primflags = texture2D( b_infoTexture, vec2( 17.5/b_pixPerRow, b_indice ) ) ;","float l_useColor = getLastBit(primflags.x);","primflags.x = primflags.x*0.5;","float l_useOpacity = getLastBit(primflags.x);","b_flag = 0.0;","if (l_useColor > 0.9 && l_useOpacity < 0.9) {","b_flag = 1.0;","}","else if (l_useColor < 0.9 && l_useOpacity > 0.9) {","b_flag = 2.0;","}","else if (l_useColor > 0.9 && l_useOpacity > 0.9) {","b_flag = 3.0;","}"].join("\n")},s=["vec3 colorInstance= vec3(1.0,1.0,1.0);","float opacityInstance = 1.0;"].join("\n");return{VS_overridableFunctions:a,FS_overridableFunctions:{ComputeCommonValues:["colorInstance = diffuseCity;","bool l_useColor = ((b_flag > 0.5 && b_flag < 1.5) || (b_flag > 2.5 && b_flag < 3.5));","if (l_useColor) {","colorInstance = b_color.xyz;","}","opacityInstance = opacityCity;","bool l_useOpacity = ((b_flag > 1.5 && b_flag < 2.5) || (b_flag > 2.5 && b_flag < 3.5));","if (l_useOpacity) {","opacityInstance = b_color.w;","}"].join("\n"),ComputeAlbedo:["return colorInstance;"].join("\n"),ComputeOpacity:["return opacityInstance;"].join("\n")},VS_global_code:n,FS_global_code:s,uniforms:i,varyings:r}},_initWallMaterial:function(){if(!o.is(this._wallMaterial)){var e=this._getCommonShaderStructure();this._wallMaterial=t.getPDSFXMaterial([e],"physical"),this._wallMaterial.name="building_material_wall_",this._wallMaterial.updateDeferredMaterials()}return this._wallMaterial.clone()},_initRoofMaterial:function(){if(!o.is(this._roofMaterial)){var e=this._getCommonShaderStructure();this._roofMaterial=t.getPDSFXMaterial([e],"physical"),this._roofMaterial.name="building_material_roof_",this._roofMaterial.updateDeferredMaterials()}return this._roofMaterial.clone()},roofOrthoUpdate:function(){},_getRoofMaterial:function(e){e=this._getMaterial(e);var t=this.getCompleteMaterialInfo();return t.r_mode&&e.updatePDSFXUniform("r_mode",t.r_mode),e},isanimationinprogress:function(e){},easing:function(e){var t=e-1;return(t*=t*t*t*t)+1},_updateAnimationUniforms:function(e){var t,i,r=1,n=e.clockDelta,a=Object.keys(this.animationMaterials),s=a.length;for(i=0;i<s;i++){t=a[i];var l=this.animationMaterials[t];o.is(l._initRemainingtime)&&this.animationTime>0?(l._initRemainingtime-=n,r=1-Math.max(0,l._initRemainingtime)/this.animationTime,r=this.easing(r),l.updatePDSFXUniform("extrusionFactor",r),r>=1&&delete l._initRemainingtime):(l.updatePDSFXUniform("extrusionFactor",1),delete this.animationMaterials[t])}},isStrokeMesh:function(e){return!(!o.is(e)||!o.is(e._isStroke))||!(!o.is(e.parents)||!o.is(e.parents[0]))&&this.isStrokeMesh(e.parents[0])},initMesh:function(r){if(this.isStrokeMesh(r)&&o.is(this._strokeRenderingHandler))return this._strokeRenderingHandler.initMesh(r);var n=null,a=r.name.split("_"),s=a.length;if(!(s<4)){var d,u,f,h,g;for(u=a[0],f=a[1],h=a[2],d=a[3],g=4;g<s;++g)d+="_"+a[g];if(d.contains("roof")){if(o.is(r.material)?n=r.material:(n=this._initRoofMaterial(),i._setMaterialFromProfile(n,this.getDefaultRenderingData()),this.animationMaterials[n.id]=n,n._initRemainingtime=this.animationTime),this.roofAtlas._atlasBaseURL&&""!==this.rasterId&&this.rasterMinlvl>=0){var c=parseFloat(u),p=parseFloat(f),_=parseFloat(h);p=Math.floor(p/(1<<c-this.rasterMinlvl)),_=Math.floor(_/(1<<c-this.rasterMinlvl)),c=this.rasterMinlvl,n.tile=[c,p,_];var m=this.urban.worldSize/Math.pow(2,c);n.uniforms.r_orthoData.value=this.urban.USR.viewpoint._translateToRelativePosition(new e.Vector3(p*m,_*m,m),!0),this.roofOrthoUpdate(n),this._enable(n,[this.roofAtlas.updateMaterial.bind(this.roofAtlas),this.roofOrthoUpdate.bind(this)])}n=this._getRoofMaterial(n)}else{o.is(r.material)?n=r.material:(n=this._initWallMaterial(),i._setMaterialFromProfile(n,this.getDefaultRenderingData()),this.animationMaterials[n.id]=n,n._initRemainingtime=this.animationTime),n.updatePDSFXUniform("b_infoTexture",r.textureInfo.texture),this.tdbStore.atlasBaseURL||(d="default");this.getOrDownloadTDB(d);n=this._getMaterial(n)}return n.updatePDSFXUniform("b_infoTexture",r.textureInfo.texture),n.name+=u+"_"+f+"_"+h,n.needsUpdate=!0,n.force=!0,t.updateCommonUniforms(n),r.mesh3js.material=n,r.setMaterial(n),r.setShadow(!0,!0),this.updateRenderMode(r),this._lastSeenMaterial=n,!0}l.warn("RenderingHandlerBuilding: Missing parameters to initialize meshes...")},setPassToMesh:function(e,t){if(o.is(e)&&o.is(t))switch(t){case"overlay":e.setRenderPasses(["noz"]),this.setRenderModeToMesh(e,"overlay");break;default:e.setRenderPasses(["main"]),this.setRenderModeToMesh(e,"occluded")}},cloneMesh:function(e){var t=this,i=e.clone(!0);i.setMatrix(e.getMatrix()),i.setMaterial(null),i.textureInfo=e.textureInfo,i.setRendering=e.setRendering,void 0===i.observers&&(i.observers=[]);this._rendering;return i.observers.push(function(e){t.removeMesh(i.id),delete i.textureInfo,delete i.setRendering,delete i.getColor,delete i.getOpacity}),i},createOtherMesh:function(e){if(o.is(e)){var t=this.getRenderModeFromMesh(e);if(o.is(t)){var i="occluded";switch(t){case"occluded":i="overlay";break;case"overlay":i="occluded";break;default:return void console.error(" basic rendermode ",t," unknown")}var r=this.cloneMesh(e);this.setPassToMesh(r,i),o.is(e.parents[0])&&e.parents[0].addChild(r),e.userData||(e.userData={}),e.userData.CityOtherMesh=r,r.userData||(r.userData={}),r.userData.CityOtherMesh=e,this.initMesh(r)}}},updateRenderMode:function(e){if(o.is(e)){var i=this.getCompleteMaterialInfo(),r=i.renderMode,n=e,a=!1,s=!1,l=this.getRenderModeFromMesh(n);o.is(l)||(this.setPassToMesh(e,r),l=this.getRenderModeFromMesh(n)),l!==r?(a=!1,s=!0):(a=!0,s=!1),"dual"===r&&(a=!0,s=!0,"overlay"===l&&(n.material.opacity=i.opacity*i.opacityFactor,t.updateCommonUniforms(n.material))),e.setVisibility(a),e.userData&&e.userData.CityOtherMesh?e.userData.CityOtherMesh.setVisibility(s):s&&(this.createOtherMesh(e),e.userData.CityOtherMesh.setVisibility(s))}},_defineRenderPass:function(){},getOrDownloadTDB:function(e,t){return this.tdbStore.getOrDownloadData(e,Date.now(),t)},getFlagForPrimitive:function(e,t){var i=this._parent(e,t);if(e){var r=this.getPrimitiveRenderingValues(e,t);o.is(r.extrusionHeight)&&(i+=4)}return i},addDefaultHeightAttribute:function(e){var t=(new d).propertyName(e),i=new u(null,null,{extrusionHeight:t});i.addOverIds("3DXCityDefaultIDdefaultHeightAttributeBuilding"),this.defaultRendering.addOver(i),this.getStrokeHandler().defaultRendering.addOver(i)},addDefaultAltitudeFromAttributes:function(e,t){if(o.is(t))this.defaultRendering.set("elevation",t);else{var i=(new d).propertyName(e).toNumber(),r=new u(null,null,{elevation:i});r.addOverIds("3DXCityDefaultIDdefaultElevationAttributeBuilding"),this.defaultRendering.addOver(r),this.getStrokeHandler().defaultRendering.addOver(r)}},isMeshToConsider:function(e){return!!e},getStrokeHandler:function(){return o.is(this._strokeRenderingHandler)||(this._strokeRenderingHandler=new g(this.urban,this._defaultStrokeParameters)),this._strokeRenderingHandler},applyRenderingToPrimitive:function(e,t,i,r){this.isStrokeMesh(e)?(t=this._strokeRenderingHandler.getPrimitiveRenderingValuesOrOriginal(r),o.is(t)&&(this.isInLineMode()||(t=t.stroke),e.setRendering(t,i[0],r))):this._parent(e,t,i,r)},applyPrimitiveDataVizRendering:function(e){this.isStrokeMesh(e)?this._strokeRenderingHandler.applyPrimitiveDataVizRendering(e):this._parent(e)}});return c._building={attributes:{},uniforms:{b_infoTexture:{type:"t",value:void 0},extrusionHeight:{type:"f",value:1}},vertex_pars:["// RenderingBuilding - Varyings & Uniforms","// **************************************************","uniform sampler2D b_infoTexture;","uniform float extrusionHeight;","varying vec4 b_color;","varying vec2 vUv;","varying float colorflag;","varying float opacityflag;","// RenderingBuilding - RGBA decoder function","// **************************************************","float b_rgba2float( vec4 color ) {","    return dot( color, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/16581375.0) );","}","float b_rgba2int( vec4 color ) {","    return ( 255.0 * ( color.r + (color.g*255.0) + (color.b*65025.0) + (color.a*16581375.0) ) );","}","float getFlag(float flags, float row){","    float res = mod(flags, row*2.0); ","    if(res >= row){","       return 1.0;","   }","   return 0.0; ","}"].join("\n"),vertex:["    // RenderingBuilding MAP - Read Building info","    /////////////////////////////////////////////////","    float b_pixPerRow = b_rgba2int( texture2D( b_infoTexture, vec2( 0.0, 0.0 ) ) );","    float b_nbBuilding = b_rgba2int( texture2D( b_infoTexture, vec2( 1.5/b_pixPerRow, 0.0 ) ) );","    float b_scale = b_rgba2int( texture2D( b_infoTexture, vec2( 2.5/b_pixPerRow, 0.0 ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 3.5/b_pixPerRow, 0.0 ) ) );","    float b_indice = (uv.x + .5)/b_nbBuilding;","    b_color = texture2D( b_infoTexture, vec2( 0.0, b_indice ) );","    float b_texIndice = b_rgba2int( texture2D( b_infoTexture, vec2( 1.5/b_pixPerRow, b_indice ) ) );","    float b_altitude = b_rgba2int( texture2D( b_infoTexture, vec2( 2.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 3.5/b_pixPerRow, b_indice ) ) );","    float b_height = b_rgba2int( texture2D( b_infoTexture, vec2( 4.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 5.5/b_pixPerRow, b_indice ) ) );","    float b_roofHeight = b_rgba2int( texture2D( b_infoTexture, vec2( 6.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 7.5/b_pixPerRow, b_indice ) ) );","    vec3 b_roofMainDir = texture2D( b_infoTexture, vec2( 8.5/b_pixPerRow, b_indice ) ).rgb;","    vec2 b_roofOrthoUV;","    b_roofOrthoUV.x = b_rgba2int( texture2D( b_infoTexture, vec2( 9.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 10.5/b_pixPerRow, b_indice ) ) );","    b_roofOrthoUV.y = b_rgba2int( texture2D( b_infoTexture, vec2( 11.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 12.5/b_pixPerRow, b_indice ) ) );","    vec3 b_roofOrigin;","    b_roofOrigin.x = b_rgba2int( texture2D( b_infoTexture, vec2( 13.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 14.5/b_pixPerRow, b_indice ) ) );","    b_roofOrigin.y = b_rgba2int( texture2D( b_infoTexture, vec2( 15.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 16.5/b_pixPerRow, b_indice ) ) );","    b_roofOrigin.z = b_altitude+b_height;","    vec4 flag = texture2D( b_infoTexture, vec2( 17.5/b_pixPerRow, b_indice ) ) ;"," colorflag = getFlag(flag.x, 1.0);"," opacityflag = getFlag(flag.x, 2.0);"].join("\n"),fragment_pars:["// RenderingBuilding MAP - Varyings","// **************************************************","varying vec4 b_color;","varying vec2 vUv;","varying float colorflag;","varying float opacityflag;"].join("\n"),fragment:[" vec3 color_value = vec3(0.0);","    #ifdef GAMMA_INPUT","       color_value.rgb *= b_color.rgb * b_color.rgb;","    #else","       color_value.rgb *= b_color.rgb;","    #endif","if( colorflag > 0.5 ) {","   diffuse_value = b_color.rgb;","   ambient_value = b_color.rgb;","}            ","if( opacityflag > 0.5 ) {","   opacity_value = b_color.a;","}            "].join("\n")},c._wall={depends:[c._building],attributes:{},uniforms:{maps_atlas:{type:"t",value:void 0},maps_atlas_info:{type:"t",value:void 0}},vertex_pars:["\n\n","// RenderingBuilding Wall","//**************************************************","uniform sampler2D maps_atlas_info;","varying vec4 w_atlasTexInfo;","varying vec4 w_size;","varying vec2 w_uvs;","//**************************************************"].join("\n"),vertex:["\n\n","// RenderingBuilding Wall","//**************************************************","    w_uvs = vec2( 0.0 );","    if( b_texIndice > 0.0 ) {","        vec2 maps_atlas_infoStep;","        maps_atlas_infoStep.x = 1.0 / b_rgba2int( texture2D( maps_atlas_info, vec2( 0.0, 0.0 ) ) );","        if( !( maps_atlas_infoStep.x == 0.0 || maps_atlas_infoStep.x > 0.5 ) ) {","            maps_atlas_infoStep.y = 1.0 / b_rgba2int( texture2D( maps_atlas_info, vec2( 3.5*maps_atlas_infoStep.x, 0.0 ) ) );","            float offset = b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, 0.0 ) ) );","            float tdb_texIndice = (0.5 + offset + b_texIndice)*maps_atlas_infoStep.y;","            vec2 w_atlasTexSize;","            vec2 w_numWindows;","            w_atlasTexInfo.z = b_rgba2int( texture2D( maps_atlas_info, vec2( 0.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 1.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            w_atlasTexInfo.w = b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 3.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            w_atlasTexInfo.x = b_rgba2int( texture2D( maps_atlas_info, vec2( 4.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 5.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            w_atlasTexInfo.y = b_rgba2int( texture2D( maps_atlas_info, vec2( 6.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 7.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            w_atlasTexInfo.y = 1.0 - w_atlasTexInfo.y - w_atlasTexInfo.w;","            w_atlasTexSize.x = b_rgba2int( texture2D( maps_atlas_info, vec2( 8.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 9.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            w_atlasTexSize.y = b_rgba2int( texture2D( maps_atlas_info, vec2( 10.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 11.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            w_numWindows.x = b_rgba2int( texture2D( maps_atlas_info, vec2( 14.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            w_numWindows.y = b_rgba2int( texture2D( maps_atlas_info, vec2( 15.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            float groundFloorHeight = b_rgba2int( texture2D( maps_atlas_info, vec2( 12.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 13.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","            float w_wallLength = uv.y / b_scale;","            w_size.x = w_atlasTexInfo.w * groundFloorHeight / w_atlasTexSize.y;","            w_size.y = (w_atlasTexInfo.w - w_size.x) / w_numWindows.y;","            w_size.z = w_numWindows.x;","            w_size.w = 0.0;","            w_uvs.x = floor( 0.5 + (w_numWindows.x * w_wallLength / w_atlasTexSize.x) ) / w_numWindows.x;","            if( position.z - b_altitude > b_height + 0.005 ) {","                w_uvs.y = 1.0;","            } else if( position.z - b_altitude > 0.0 ) {","                float w_nbWindowsHeigth = 0.0;","                if( b_height > groundFloorHeight )","                    w_nbWindowsHeigth = floor( w_numWindows.y * ( b_height - groundFloorHeight ) / ( w_atlasTexSize.y - groundFloorHeight ) );","                w_uvs.y = w_size.x + w_nbWindowsHeigth * w_size.y;","            } else {","                w_uvs.y = 0.0;","            }","        }","    }","//**************************************************"].join("\n"),fragment_pars:["\n\n","// RenderingBuilding Wall","//**************************************************","uniform sampler2D maps_atlas;","varying vec4 w_atlasTexInfo;","varying vec4 w_size;","varying vec2 w_uvs;","float w_nbFloor = 3.0;","//**************************************************"].join("\n"),fragment:["\n\n","// RenderingBuilding Wall","//**************************************************","    #define USE_UV_MAPS","    vec2 maps_UVcoord;","    vec3 w_atlasColor = vec3( 1.0 );","    if( w_atlasTexInfo.z > 0.0 && w_atlasTexInfo.w > 0.0 ) {","        maps_UVcoord.x = w_atlasTexInfo.x + w_atlasTexInfo.z * mod(w_uvs.x, 1.0);","        if( w_uvs.y >= w_size.x + w_size.y ) {","            float w_floors = w_uvs.y - w_size.x - w_size.y;","            float w_floorStart = w_size.y * mod( floor( w_floors / w_size.y ), (w_nbFloor - 1.0));","            maps_UVcoord.y = mod(w_floors, w_size.y) + w_floorStart + w_size.x + w_size.y + w_atlasTexInfo.y;","        } else {","            maps_UVcoord.y = mod(w_uvs.y, w_atlasTexInfo.w) + w_atlasTexInfo.y;","        }","        w_atlasColor = texture2D( maps_atlas, maps_UVcoord ).rgb;","    }","    #ifdef GAMMA_INPUT","        w_atlasColor *= w_atlasColor;","    #endif","    gl_FragColor.rgb *= w_atlasColor;","//**************************************************"].join("\n")},c._roof={depends:[t.vertexInformation,c._building],uniforms:{maps_atlas:{type:"t",value:void 0},maps_atlas_info:{type:"t",value:void 0},r_ortho:{type:"t",value:void 0},r_mode:{type:"i",value:0},r_orthoOffset:{type:"v3",value:new e.Vector3(0,0,1)},r_orthoData:{type:"v3",value:new e.Vector3(0,0,1)}},vertex_pars:["\n\n","// RenderingBuilding Roof","//**************************************************","uniform sampler2D maps_atlas_info;","uniform sampler2D r_ortho;","uniform vec3 r_orthoOffset;","uniform vec3 r_orthoData;","varying vec4 r_atlasTexRatio;","varying vec4 r_dirtRatio;","varying vec4 r_orthoUVs;","varying vec4 r_uvs;","//**************************************************"].join("\n"),vertex:["\n\n","// RenderingBuilding Roof","//**************************************************","    float r_type = uv.y; // 0 means roof is not flat, 1 it's flat, 2 is acroterion's side and 3 is acroterion's top","    r_orthoUVs.xy = ((vertex_position.xy - r_orthoData.xy)/r_orthoData.z)*r_orthoOffset.z + r_orthoOffset.xy;","    r_orthoUVs.zw = (((modelMatrix*vec4(b_roofOrthoUV,0.0,1.0)).xy - r_orthoData.xy)/r_orthoData.z)*r_orthoOffset.z + r_orthoOffset.xy;","    vec3 r_orthoColor = texture2D(r_ortho, r_orthoUVs.zw).rgb;","    vec4 maps_atlas_infoStep;","    maps_atlas_infoStep.x = 1.0 / b_rgba2int( texture2D( maps_atlas_info, vec2( 0.0, 0.0 ) ) );","    maps_atlas_infoStep.y = 1.0 / b_rgba2int( texture2D( maps_atlas_info, vec2( 3.5*maps_atlas_infoStep.x, 0.0 ) ) );","    maps_atlas_infoStep.z = b_rgba2int( texture2D( maps_atlas_info, vec2( 1.5*maps_atlas_infoStep.x, 0.0 ) ) );","    maps_atlas_infoStep.w = b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, 0.0 ) ) );","    vec3 color;","    float r_test, r_dist, r_closerDist = 100000.0;","    float r_texinclass, r_class = -1.0, r_dirtclass = -1.0;","    for( float r_ind=1.0; r_ind<128.0; ++r_ind ) {","        if( r_ind - 1.0 < maps_atlas_infoStep.w ) {","            r_test = b_rgba2int( texture2D( maps_atlas_info, vec2( 1.5*maps_atlas_infoStep.x, (r_ind + .5)*maps_atlas_infoStep.y ) ) );","            if( abs( r_type - r_test ) < 0.1 ) {","                color = texture2D( maps_atlas_info, vec2( 0.0, (r_ind + .5)*maps_atlas_infoStep.y ) ).rgb - r_orthoColor;","                r_dist = color.r*color.r + color.g*color.g + color.b*color.b;","                if( r_dist < r_closerDist && b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, (r_ind + .5)*maps_atlas_infoStep.y ) ) ) > 0.0) {","                    r_closerDist = r_dist;","                    r_class = r_ind;","                    r_texinclass = b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, (r_ind + .5)*maps_atlas_infoStep.y ) ) );","                }","            } else if( abs( 10.0 - r_test ) < 0.1 ) {","                r_dirtclass = r_ind;","            }","        }","    }","    float tdb_texIndice = -1.0;","    if( r_class > 0.0 ) {","        tdb_texIndice = 3.5 + mod( uv.x, r_texinclass );","        tdb_texIndice = 0.5 + maps_atlas_infoStep.w + b_rgba2int( texture2D( maps_atlas_info, vec2( tdb_texIndice*maps_atlas_infoStep.x, (r_class + .5)*maps_atlas_infoStep.y ) ) );","        tdb_texIndice = tdb_texIndice*maps_atlas_infoStep.y;","    }","    if( tdb_texIndice > 0.0 ) {","        vec2 r_atlasTexSize;","        r_atlasTexRatio.x = b_rgba2int( texture2D( maps_atlas_info, vec2( 0.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 1.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_atlasTexRatio.y = b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 3.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_atlasTexRatio.z = b_rgba2int( texture2D( maps_atlas_info, vec2( 4.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 5.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_atlasTexRatio.w = b_rgba2int( texture2D( maps_atlas_info, vec2( 6.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 7.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_atlasTexSize.x = b_rgba2int( texture2D( maps_atlas_info, vec2( 8.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 9.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_atlasTexSize.y = b_rgba2int( texture2D( maps_atlas_info, vec2( 10.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 11.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        if( uv2.x < 0.0 && uv2.y < 0.0 ) {","            vec3 r_u = normalize( b_roofMainDir ); // u is direction between the 2 lower point, or main direction","            vec3 r_v = cross(vertex_wNormal.xyz, r_u); // v is cross product between u and face normal","            vec3 r_d = vertex_position.xyz - b_roofOrigin;","            r_uvs.x = dot(r_u, r_d) / ( b_scale * r_atlasTexSize.x );","            r_uvs.y = dot(r_v, r_d) / ( b_scale * r_atlasTexSize.y );","        } else {","            r_uvs.x = uv2.x / ( b_scale * r_atlasTexSize.x );","            r_uvs.y = uv2.y / ( b_scale * r_atlasTexSize.y );","        }","    }","    if( r_dirtclass > 0.0 ) {","        r_texinclass = b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, (r_dirtclass + .5)*maps_atlas_infoStep.y ) ) );","        tdb_texIndice = 3.5 + mod( uv.x, r_texinclass );","        tdb_texIndice = 0.5 + maps_atlas_infoStep.w + b_rgba2int( texture2D( maps_atlas_info, vec2( tdb_texIndice*maps_atlas_infoStep.x, (r_dirtclass + .5)*maps_atlas_infoStep.y ) ) );","        tdb_texIndice = tdb_texIndice*maps_atlas_infoStep.y;","        vec2 r_dirtSize;","        r_dirtRatio.x = b_rgba2int( texture2D( maps_atlas_info, vec2( 0.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 1.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_dirtRatio.y = b_rgba2int( texture2D( maps_atlas_info, vec2( 2.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 3.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_dirtRatio.z = b_rgba2int( texture2D( maps_atlas_info, vec2( 4.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 5.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_dirtRatio.w = b_rgba2int( texture2D( maps_atlas_info, vec2( 6.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 7.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_dirtSize.x = b_rgba2int( texture2D( maps_atlas_info, vec2( 8.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 9.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_dirtSize.y = b_rgba2int( texture2D( maps_atlas_info, vec2( 10.5*maps_atlas_infoStep.x, tdb_texIndice ) ) ) + b_rgba2float( texture2D( maps_atlas_info, vec2( 11.5*maps_atlas_infoStep.x, tdb_texIndice ) ) );","        r_uvs.zw = vertex_position.xy / (r_dirtSize.xy * b_scale);","    } else {","        r_uvs.z = 0.0;","    }","    if( r_type > 1.0 )","        r_orthoUVs = vec4(-1.0);","//**************************************************"].join("\n"),fragment_pars:["\n\n","// RenderingBuilding Roof","//**************************************************","float r_coeffDirty = 0.75;","uniform sampler2D maps_atlas;","uniform sampler2D r_ortho;","uniform int r_mode;","varying vec4 r_atlasTexRatio;","varying vec4 r_dirtRatio;","varying vec4 r_orthoUVs;","varying vec4 r_uvs;","//**************************************************"].join("\n"),fragment:["\n\n","// RenderingBuilding Roof","//**************************************************","    #define USE_UV_MAPS","    vec3 old = gl_FragColor.rgb;","    vec2 maps_UVcoord;","    maps_UVcoord.x = r_atlasTexRatio.z + r_atlasTexRatio.x * mod( r_uvs.x, 1.0);","    maps_UVcoord.y = r_atlasTexRatio.w + r_atlasTexRatio.y * mod( r_uvs.y, 1.0);","    vec3 r_orthoMainColor = vec3(0.8);","    vec3 r_orthoColor = vec3( 0.8 );","    vec3 r_atlasColor = vec3( 1.0 );","    vec3 r_dirty = vec3( 1.0 );","    if( length(r_orthoUVs + 1.0) > 0.05 ) {","        r_orthoMainColor = texture2D( r_ortho, r_orthoUVs.zw ).rgb;","        r_orthoColor = texture2D( r_ortho, r_orthoUVs.xy ).rgb;","        r_atlasColor = texture2D( maps_atlas, maps_UVcoord ).rgb;","        r_dirty = (texture2D( maps_atlas, r_dirtRatio.zw + r_dirtRatio.xy * mod( r_uvs.zw, 1.0) ).rgb - 0.5 ) * r_coeffDirty + 1.0;","    }","    #ifdef GAMMA_INPUT","        r_orthoColor *= r_orthoColor;","        r_orthoMainColor *= r_orthoMainColor;","    #endif","    if( r_mode == 0 )","        gl_FragColor.rgb *= r_orthoColor * r_atlasColor;","    else if( r_mode == 1 )","        gl_FragColor.rgb *=  r_orthoMainColor * r_atlasColor * r_dirty;","    if( gl_FragColor.rgb == vec3(0.0) )","        gl_FragColor.rgb = old;","//**************************************************"].join("\n")},c._roof_debug={uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["\n\n","// RenderingBuilding Roof - DEBUG","//**************************************************","    gl_FragColor.r = mod( r_uvs.x, 1.0);","    gl_FragColor.g = mod( r_uvs.y, 1.0);","    gl_FragColor.b = 0.0;","    gl_FragColor.rgb = texture2D( r_ortho, r_uvs.zw ).rgb;","    return;","//**************************************************"].join("\n")},c}),define("DS/XCityRendering/RenderingHandlerPolygon",["DS/XCityRendering/RenderingHandlerBuilding","DS/xCityBasicUtils/Utils","DS/xCityBasicUtils/ColorGradient","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/Visualization/ThreeJS_DS","DS/XCityTools/TextureManager","DS/XCityRendering/RenderingHandlerAtlasing","DS/XCityTools/TextureTools"],function(e,t,i,r,n,a,s,o,l){"use strict";var d=e.extend({init:function(e,t,i){this._parent(e,t,i),this.enableAtlasing=!0,this.type="Polygon",this._usePolygonExtrusionOptim=!1},getDefaultRendering:function(){var e=Object.assign({},this._parent(),{renderMode:"dual",opacityFactor:.3,opacity:.8,elevationOffset:.1,ambient:new i(new a.Color("#000000")),diffuse:new i(new a.Color("#000000")),color:new i(new a.Color("#000000")),geometricMode:"filled",wallTexturesUrl:void 0,roofTexturesUrl:void 0,extrusionHeight:100,lineWidth:4,alphaTest:.01,stroke:this._defaultStrokeParameters,map:null,mapUrl:null,mapParams:{wrapS:1e3,wrapT:1e3},repeatUv:new a.Vector2(1,1),offsetUv:new a.Vector2(0,0),texturingMode:"cameraStop",polyExtruOptim:!1});return this._defaultStrokeParameters={enable:!1,opacityFactor:.3,minOpacity:.4,minDist:100,elevationOffset:.05,maxDist:2e3,lineWidth:2,minWidth:1,dynamicUpdate:!1,animation:{},ambient:new i(new a.Color("#000000")),diffuse:new i(new a.Color("#000000")),color:new i(new a.Color("#000000")),opacity:1,dashPattern:null},e.stroke=this._defaultStrokeParameters,e},shouldRebuild:function(e,t){if(this._parent(e,t))return!0;var i=e.getRenderingData(),r=t.getRenderingData(),n=r.geometricMode,a=i.geometricMode;if(n!==a){var s={stroke:{enable:!1}};return"extruded"===n?this.defaultRendering.addOver(s):"line"===n?(s.stroke.enable=!0,this.defaultRendering.addOver(s)):this.defaultRendering.addOver(s),!0}return"extruded"===n&&(n=r.extrusionHeight,(a=i.extrusionHeight)!==n)||((n=r.renderMode)!==(a=i.renderMode)&&("dual"===n||"dual"===a)||(n=r.mapUrl)!==(a=i.mapUrl))},updateRendering:function(e){void 0!==e.getRenderingData().polyExtruOptim&&this._setUsePolygonExtrusionOptim(e.getRenderingData().polyExtruOptim),this._parent(e)},_getCommonShaderStructure:function(){var e=this._parent(),t={usePolygonExtrusionOptim:{type:"b",value:this._usePolygonExtrusionOptim}};return Object.assign(e.uniforms,t),e.VS_overridableFunctions.ComputeObjectPosition=["if(usePolygonExtrusionOptim == false) return vGetAttribPosition();","float b_pixPerRow = b_rgba2int( texture2D( b_infoTexture, vec2( 0.0, 0.0 ) ) );","float b_nbBuilding = b_rgba2int( texture2D( b_infoTexture, vec2( 1.5/b_pixPerRow, 0.0 ) ) );","float b_indice = (vGetAttribTexCoord0().x + .5)/b_nbBuilding;","float b_altitude = b_rgba2int( texture2D( b_infoTexture, vec2( 2.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 3.5/b_pixPerRow, b_indice ) ) );","vec3 vertexposition = vGetAttribPosition();","float b_height = b_rgba2int( texture2D( b_infoTexture, vec2( 4.5/b_pixPerRow, b_indice ) ) ) + b_rgba2float( texture2D( b_infoTexture, vec2( 5.5/b_pixPerRow, b_indice ) ) );","vec4  primflags = texture2D( b_infoTexture, vec2( 17.5/b_pixPerRow, b_indice ) ) ;","float buildingheight = vertexposition.z - b_altitude;","//vec3 position = vertexposition;","vec3 position = vGetAttribPosition();","float factor = extrusionFactor;","if((primflags.x > 3.5)&&(buildingheight > 0.0)) {","  position.z = position.z - buildingheight + b_height;","}","return position;"].join("\n"),e},_initRoofMaterial:function(){if(!t.is(this._roofMaterial)){var e={uvMode:{type:"f",value:1},offsetUvCity:{type:"v2",value:new a.Vector2(0,0)},repeatUvCity:{type:"v2",value:new a.Vector2(0,0)},mapCity:{type:"t2",value:r.whiteMap},useMapCity:{type:"b",value:!1},mapCityLoaded:{type:"b",value:!0},lastCameraAltitude:{type:"f",value:1},textureWidth:{type:"f",value:1},textureHeight:{type:"f",value:1},atlasOffsetTexture:{type:"t2",value:o.defaultAtlasOffsetTexture}},i={texCoordCity:{type:"v2",value:new a.Vector2(0,0)},noMap:{type:"f",value:0},currentOffsetX:{type:"f",value:0},currentOffsetY:{type:"f",value:0},currentOffsetHeight:{type:"f",value:1},currentOffsetWidth:{type:"f",value:1}},n=this._getCommonShaderStructure();n.uniforms=Object.assign(n.uniforms,e),n.varyings=Object.assign(n.varyings,i),n.VS_overridableFunctions.ComputeVaryingValues=[n.VS_overridableFunctions.ComputeVaryingValues,"  float textureIndex = b_texIndice;","  int index = int(textureIndex);","    vec4 currentOffset = texture2D(atlasOffsetTexture, vec2(0.5, (textureIndex+0.5)/800.0));","    currentOffsetX = currentOffset.x;","    currentOffsetY = currentOffset.y;","    currentOffsetHeight = currentOffset.z;","    currentOffsetWidth = currentOffset.w;","    vec3 position = vGetAttribPosition();","    vec4 worldPos = modelMatrix * vec4(position.xyz, 1.0);","    float altitudeCamera = lastCameraAltitude - worldPos.z;","    vec2 vUvvuc = (worldPos.xy);","    vUvvuc.xy = vUvvuc.xy * min(1.0,(1.0/abs(altitudeCamera)));","    vec2 textureScaleFactor = 1.3 * 4.0 * 256.0 / vec2(max(1.0,textureWidth),max(1.0,textureHeight));","//vUvvuc.xy = vUvvuc.xy * repeatUvCity * textureScaleFactor / currentOffset.wz;","    vUvvuc.xy = vUvvuc.xy * repeatUvCity * textureScaleFactor / vec2(currentOffsetWidth, currentOffsetHeight);","    vUvvuc.xy = vUvvuc.xy + offsetUvCity;","    texCoordCity = vUvvuc.xy;","    noMap = 0.0;","if(uvMode <= 0.5){","    texCoordCity.xy = uv2;","}",""].join("\n"),n.FS_global_code=[n.FS_global_code,"vec4 _texelCity = vec4(1.0);","float _alphaCity = 1.0;"].join("\n"),n.FS_overridableFunctions.ComputeCommonValues=["if (useMapCity && mapCityLoaded ) {","//vec2 mytexCoordCity = fract(texCoordCity.xy) * vec2(currentOffset.w, currentOffset.z) + vec2(currentOffset.x, currentOffset.y);","vec2 mytexCoordCity = fract(texCoordCity.xy) * vec2(currentOffsetWidth, currentOffsetHeight) + vec2(currentOffsetX, currentOffsetY);","#extension GL_EXT_shader_texture_lod : enable","#ifdef GL_EXT_shader_texture_lod ","_texelCity = texture2DGradEXT(mapCity, mytexCoordCity.xy,dFdx(texCoordCity.xy), dFdy(texCoordCity.xy) );","#else","_texelCity = texture2D(mapCity, mytexCoordCity.xy);","#endif","_alphaCity = _texelCity.w;","#ifdef GAMMA_INPUT","_alphaCity *= _texelCity.w;","#endif","","}",n.FS_overridableFunctions.ComputeCommonValues].join("\n"),n.FS_overridableFunctions.ComputeAlbedo=["return colorInstance*_texelCity.xyz;"].join("\n"),n.FS_overridableFunctions.ComputeDiscard=["if (_alphaCity < alphaTestCity || (useMapCity && !mapCityLoaded)) {","return true;","}","return false;"].join("\n"),this._roofMaterial=r.getPDSFXMaterial([n],"physical"),this._roofMaterial.name="building_material_roof_",this._roofMaterial.setPDSFXPolygonOffset("Frontward0"),this._roofMaterial.updateDeferredMaterials()}return this._roofMaterial.clone()},_applyPolygonOffset:function(e,i){t.is(e)&&t.is(i)&&(e.polygonOffset=!0,e.polygonOffsetFactor=i.x,e.polygonOffsetUnits=i.y)},updateTexturingUniforms:function(e){if(this.updateCameraAltitudeUniform(e),e){var i=this.getCompleteMaterialInfo(),r=1;switch(i.texturingMode){case"cameraStop":r=1;break;case"simple":r=0;break;default:r=1}if(e.isPDSFX())t.is(i.repeatUv)&&e.updatePDSFXUniform("repeatUvCity",new a.Vector2(i.repeatUv.x,i.repeatUv.y)),t.is(i.offsetUv)&&e.updatePDSFXUniform("offsetUvCity",new a.Vector2(i.offsetUv.x,i.offsetUv.y)),t.is(r)&&e.updatePDSFXUniform("uvMode",r);else if(t.is(e.uniforms)){if(t.is(i.repeatUv)){e.uniforms.repeatUv.value=new a.Vector2(1*i.repeatUv.x,1*i.repeatUv.y)}t.is(i.offsetUv)&&(e.uniforms.offsetUv.value=i.offsetUv),t.is(r)&&(e.uniforms.uvMode.value=r)}}},updateCameraAltitudeUniform:function(e){if(t.is(e)){var i=this.urban.getViewpoint().getPosition();t.is(i)&&t.is(i.z)&&(e.isPDSFX()?e.updatePDSFXUniform("lastCameraAltitude",i.z):t.is(e.uniforms)&&t.is(e.uniforms.lastCameraAltitude)&&(e.uniforms.lastCameraAltitude.value=i.z))}},_editLineWidth:function(e){e.geometricMode&&"line"===e.geometricMode||(e.lineWidth=void 0)},initMesh:function(e){if(this.isStrokeMesh(e)&&t.is(this._strokeRenderingHandler))return this._strokeRenderingHandler.initMesh(e);t.is(this.atlasId)&&this.currentRendering.set("mapUrl",this.atlasId);var i=null,a=e.name.split("_"),s=a.length;if(!(s<4)){var o,l,d,u,f;for(l=a[0],d=a[1],u=a[2],o=a[3],f=4;f<s;++f)o+="_"+a[f];if(o.contains("roof")){if(t.is(e.material))i=e.material;else{i=this._initRoofMaterial(),n._setMaterialFromProfile(i,this.getDefaultRenderingData());var h=this;this.urban.USR.viewpoint.addEvent("onCameraStopped",function(){h.updateCameraAltitudeUniform(i)})}this.updateTexturingUniforms(i),i=this._getMaterial(i),this._editLineWidth(i)}else t.is(e.material)?i=e.material:(i=this._initWallMaterial(),n._setMaterialFromProfile(i,this.getDefaultRenderingData())),i.updatePDSFXUniform("b_infoTexture",e.textureInfo.texture),i=this._getMaterialNoMap(i),this._editLineWidth(i);return i.updatePDSFXUniform("b_infoTexture",e.textureInfo.texture),i.updatePDSFXUniform("usePolygonExtrusionOptim",this._usePolygonExtrusionOptim),i.name+=l+"_"+d+"_"+u,i.force=!0,t.is(this.atlasId)&&this.addAtlasUniforms(i),r.updateCommonUniforms(i,!1),e.mesh3js.material=i,e.setMaterial(i),e.setShadow(!0,!0),this.updateRenderMode(e),this._lastSeenMaterial=i,!0}},onTextureDownloadStart:function(e,i,r){t.is(e)&&(e.updatePDSFXUniform("useMapCity",!0),e.updatePDSFXUniform("mapCityLoaded",!1))},onTextureApplied:function(e,i,r,n){if(t.is(e)&&t.is(i)){var a=e.image.width,s=e.image.height;i.isPDSFX()?(i.updatePDSFXUniform("useMapCity",!0),i.updatePDSFXUniform("mapCityLoaded",!0),i.updatePDSFXUniform("textureWidth",a),i.updatePDSFXUniform("textureHeight",s)):t.is(i.uniforms)&&t.is(i.uniforms.textureWidth)&&(i.uniforms.textureWidth.value=a,i.uniforms.textureHeight.value=s)}},_initStores:function(){},useDatavizMappingOptim(){return this._parent()&&this._usePolygonExtrusionOptim},_setUsePolygonExtrusionOptim:function(e){!0!==e&&!1!==e||(this._usePolygonExtrusionOptim=e,this._attributesforRebuild=this._attributesforRebuild.filter(e=>"extrusionHeight"!==e),!1===e&&this._attributesforRebuild.push("extrusionHeight"))},setRenderingList:function(e,i,r,n){var a,s,o,d,u=n.textureInfo.texture.image,f=!1;for(s=0;s<e.length;s++){var h=e[s],g=i[s].strid;o=n.textureInfo.idMap[g];var c=h.color,p=(h.extrusionHeight,h.opacity),_=t.is(h.color),m=t.is(h.opacity),v=t.is(h.extrusionHeight);if(o)for(d=0;d<o.length;d++){a=o[d];var y=u.data[4*a*u.width+68];if(_){var b=c.computeColor();u.data[4*a*u.width]=b.r,u.data[4*a*u.width+1]=b.g,u.data[4*a*u.width+2]=b.b,y=t.floatPack(y,0,1),f=!0}if(y=t.floatPack(y,0,_),m&&(u.data[4*a*u.width+3]=p,y=t.floatPack(y,1,1),f=!0),y=t.floatPack(y,1,m),v){var x=l.int2color(h.extrusionHeight),R=l.float2color(h.extrusionHeight);u.data[4*a*u.width+16]=x[0],u.data[4*a*u.width+16+1]=x[1],u.data[4*a*u.width+16+2]=x[2],u.data[4*a*u.width+16+3]=x[3],u.data[4*a*u.width+20]=R[0],u.data[4*a*u.width+20+1]=R[1],u.data[4*a*u.width+20+2]=R[2],u.data[4*a*u.width+20+3]=R[3],y=t.floatPack(y,2,1),f=!0}y=t.floatPack(y,2,v),u.data[4*a*u.width+68]=y}}f&&(n.textureInfo.texture.needsUpdate=!0)}});return d._polyOffseted={attributes:{},vertex_pars:["varying vec2 vUvvuc;"].join("\n"),vertex:["#ifdef USE_MAP","vec4 posOriginCameraSpace = viewMatrix * modelMatrix * vec4(0.0,0.0,position.z,1.0);","posOriginCameraSpace /= posOriginCameraSpace.w;","vec2 uvcentered = uv.xy - vec2(0.5,0.5);","vUvvuc.xy = uvcentered.xy * (10.0/posOriginCameraSpace.z);","#endif"].join("\n"),fragment_pars:["varying vec2 vUvvuc;"].join("\n"),fragment:["#ifdef USE_MAP","       gl_FragColor.rgba = texture2D(map,vUvvuc);","#endif"].join("\n")},d._polyScreenSpace={attributes:{},vertex_pars:["varying vec2 vUvvuc;"].join("\n"),vertex:["vec4 posOriginCameraSpace = vec4(cameraPosition.xyz,1.0);","posOriginCameraSpace /= posOriginCameraSpace.w;","#ifdef USE_MAP","vec2 uvcentered = uv.xy;","vUvvuc.xy = uvcentered.xy;","vec4 orientedUv = projectionMatrix * viewMatrix * modelMatrix* vec4(position.x,position.y,position.z,1.0);","orientedUv /= orientedUv.w;","vUvvuc.xy = orientedUv.xy;","#endif"].join("\n"),fragment_pars:["varying vec2 vUvvuc;"].join("\n"),fragment:["#ifdef USE_MAP","       gl_FragColor.rgba = texture2D(map,gl_FragCoord.xy / 204.8);","#endif"].join("\n")},d._polySimple={attributes:{},uniforms:{repeatUv:{type:"v2",value:new a.Vector2(1,1)},offsetUv:{type:"v2",value:new a.Vector2(0,0)}},vertex_pars:["varying vec2 vUvvuc;","uniform vec2 repeatUv;","uniform vec2 offsetUv;"].join("\n"),vertex:["#ifdef USE_MAP","vec4 worldpos = modelMatrix* vec4(position.xyz,1.0);","vUvvuc.xy = worldpos.xy * (0.0001 *repeatUv) + offsetUv;","#endif"].join("\n"),fragment_pars:["varying vec2 vUvvuc;"].join("\n"),fragment:["#ifdef USE_MAP","       gl_FragColor.rgba = texture2D(map,vUvvuc);","#ifdef ALPHATEST","if ( gl_FragColor.a < ALPHATEST ) discard;","#endif","#endif"].join("\n")},d._polySemiSimple={attributes:{},uniforms:{repeatUv:{type:"v2",value:new a.Vector2(1,1)},offsetUv:{type:"v2",value:new a.Vector2(0,0)},lastCameraAltitude:{type:"f",value:1},textureWidth:{type:"f",value:1}},vertex_pars:["varying vec2 vUvvuc;","uniform vec2 repeatUv;","uniform vec2 offsetUv;","uniform float lastCameraAltitude;","uniform float textureWidth;"].join("\n"),vertex:["#ifdef USE_MAP","vec4 worldPos = modelMatrix * vec4(position.xyz, 1.0);","float altitudeCamera = lastCameraAltitude - worldPos.z;","vec2 uvcentered = (worldPos.xy);","vUvvuc.xy = uvcentered.xy * min(1.0,(1.0/abs(altitudeCamera)));","float textureScaleFactor = 1.3 * 4.0 * 256.0 /max(1.0,textureWidth);","vUvvuc.xy = vUvvuc.xy * repeatUv * textureScaleFactor;","vUvvuc.xy = vUvvuc.xy + offsetUv;","#endif"].join("\n"),fragment_pars:["varying vec2 vUvvuc;"].join("\n"),fragment:["#ifdef USE_MAP","       gl_FragColor.rgba = texture2D(map,vUvvuc);","#ifdef ALPHATEST","if ( gl_FragColor.a < ALPHATEST ) discard;","#endif","#endif"].join("\n")},d});