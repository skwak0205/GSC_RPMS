define("DS/DeleteWidget/DeleteWidget",["DS/LifecycleServices/LifecycleObjectList","css!DS/DeleteWidget/DeleteWidget","UWA/Core","UWA/Controls/Abstract","DS/LifecycleServices/LifecycleCommandManager","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","i18n!DS/LifecycleServices/assets/nls/LifecycleServicesNls","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleServicesSettings","DS/LifecycleControls/CommandDialog","DS/WAFData/WAFData","DS/LifecycleCmd/MessageMediator","DS/ReportingPanel/ReportingPanel"],function(e,t,i,s,n,o,r,a,l,c,d,h,p){"use strict";var u=["Workspace","Workspace Vault"];return s.extend({physicalid:"",securityContext:null,context:null,tenant:null,operationType:"delete",refreshType:"",_commandResult:!1,init:function(e){UWA.is(e,"string")&&(this.operationType=e),this.deleteOptions=[];var t=this;this.commandManager=new n,this.commandManager.addEvent("onModifyOptions",function(e){t.deleteOptions=e.options})},executeCmd:function(e,t,i){this.addEvent("onReady",function(t){e.length>1?this._showMultiselUI(e):this._showCommandUI(e)},this),this.addEvent("onComplete",function(e){i()}),this.context=t.context,this.setObjects(e)},launchReportingPanel:function(e){if(e.hasOwnProperty("report")&&0!==e.report.length){var t=[];for(var i in e.report){var s=e.report[i],n=s.isinput,r=[],a=s.physicalids[0];r.push(a),r.push(o.deleteFailedShort),r.push("Failed"),null!=(h=s["attribute[PLMEntity.V_Name]"])&&0!==h.length||(h=s.name),r.push(h);var l=s.displaytype;r.push(l);var c=s.revision;r.push(c);var d=s.error;r.push(d),"true"==n?r.push(o.deleteSelected):r.push(o.deleteAdded),r.push(o.deleteFailedShort),t.push(r)}if(e.hasOwnProperty("results")&&0!==e.results.length)for(var i in e.results){var h,u=e.results[i],f=u.isinput;r=[],a=u.physicalid;r.push(a),r.push(o.deleteSuccessfulShort),r.push("Success"),null!=(h=u["attribute[PLMEntity.V_Name]"])&&0!==h.length||(h=u.name),r.push(h);l=u.displaytype;r.push(l);c=u.revision;r.push(c);d="";r.push(d),"true"==f?r.push(o.deleteSelected):r.push(o.deleteAdded),r.push(o.deleteSuccessfulShort),t.push(r)}var m=[{text:"ID",dataIndex:"ID",isHidden:!0},{text:"StatusToolTipColumn",dataIndex:"statusTooltip",isHidden:!0,tooltipColumn:"Status"},{text:o.status,dataIndex:"Status",typeRepresentation:"icon"},{text:o.title,dataIndex:"Title"},{text:o.type,dataIndex:"Type"},{text:o.revision,dataIndex:"Revision"},{text:o.message,dataIndex:"Message"},{text:o.deleteObjects,dataIndex:"Selected",isHidden:!0,isFilter:!0,filterOptions:[{value:o.deleteSelected,default:"on",tooltip:o.deleteSelectedToolTip},{value:o.deleteAdded,default:"off",tooltip:o.deleteAddedToolTip}]},{text:o.deleteResults,dataIndex:"Results",isHidden:!0,isFilter:!0,filterOptions:[{value:o.deleteSuccessfulShort,default:"on",tooltip:o.deleteSuccessfulShort},{value:o.deleteFailedShort,default:"on",tooltip:o.deleteFailedShort}]}];p.launchReportingPanel(t,m,null)}},getResult:function(){return this._commandResult},_showMultiselUI:function(t){var i=this,s=!1;t.every(e=>!(s=!!e.type&&u.indexOf(e.type)>=0)),this.deleteContent=UWA.createElement("div",{class:"lcm-delete-content"});var n=document.createElement("div");n.className="delete_popup_warning";var r=UWA.createElement("div",{styles:{height:"100%"}}),a=l.get3DSpaceBaseUrl(widget.getValue("x3dPlatformId"))+"/webapps/IterationsWidget/assets/images/warning.png";r.innerHTML='<img src="'+a+'"></img>',n.appendChild(r),this.deleteContent.appendChild(n);var d=o.doDelete+o.questionMark;d=s?d+"<br />"+o.doDeleteBookmarkDetails:d,UWA.createElement("p",{html:d,class:"delete-info-msg"}).inject(this.deleteContent),this.maturityTable=UWA.createElement("table",{class:"DeleteTable"}).inject(this.deleteContent),this.tableSpan=UWA.createElement("tr",{class:"DeleteTableSpan"}).inject(this.maturityTable),this.objectListDiv=UWA.createElement("div",{class:"Delete-objectList"}),this.objectsList=new e({className:"objectlist-Revise",showTypeColumn:!0,showRevisionColumn:!0,showMaturityColumn:!1}),this.objectsList.inject(this.objectListDiv),this.tableSpan.appendChild(this.objectListDiv),this.objectsList.setObjects(t),this.objectListDiv.show();var h=new c,p=h.create(this.deleteContent,{title:o.delete_,closeButton:!0,imageUrl:t[0].imageUrl||"",OKBtnText:o.delete_,onOk:function(){i._executeDelete(function(){h.destroy(),i._onComplete()})},onClose:function(){i._onComplete()}});p.inject(widget.body),p.setNewSize({})},_showCommandUI:function(e){var t=this,i="",s=null;if(e&&UWA.is(e,"array")&&e.length>0&&e[0].hasOwnProperty("revision")&&e[0].hasOwnProperty("displayName")){var n=e[0].revision;i=e[0].displayName.concat(" ").concat(n),e[0].displayName.endsWith(n)&&(i=e[0].displayName);var r=o.delete_;if(e[0].hasOwnProperty("type")&&(s=e[0].type,r=o.delete_+" - "+s),e[0].hasOwnProperty("typeDisplayName")){var a=e[0].typeDisplayName;r=o.delete_+" - "+a}}var l=this._renderDialogContent(i,s),d=new c,h=d.create(l,{title:r,OKBtnText:o.delete_,closeButton:!0,imageUrl:e[0].imageUrl||"",onOk:function(){t._executeDelete(function(){d.destroy(),t._onComplete()})},onClose:function(){t._onComplete()}});h.inject(widget.body),h.setNewSize({})},_renderDialogContent:function(e,t){var i=UWA.String.escapeHTML(e),s=document.createElement("div");s.className="delete_popup";var n,a=document.createElement("div"),c=document.createElement("div");c.className="delete_popup_warning";var d=UWA.createElement("div",{styles:{height:"100%"}}),h=l.get3DSpaceBaseUrl(widget.getValue("x3dPlatformId"))+"/webapps/IterationsWidget/assets/images/warning.png";d.innerHTML='<img src="'+h+'"></img>',c.appendChild(d),s.appendChild(c),n=t&&u.indexOf(t)>=0?null==o.doDeleteBookmark?r.replace("Do you want to permanently delete the {bookmarkName} hierarchy? The content is removed",{bookmarkName:e}):r.replace(o.doDeleteBookmark,{bookmarkName:e}):o.doDeleteMessage+i+o.questionMark+"<br><br>"+o.doDeleteDetails,a.innerHTML=n,s.appendChild(a);var p=document.createElement("div");return p.appendChild(this.commandManager.buildOptionPanel(this.deleteOptions)),s.appendChild(p),s},_onComplete:function(){this.dispatchEvent("onComplete",{})},setObjects:function(e){var t=this;if(0===e.length)throw o.noObject;if(1===e.length){var i=[];if((n={}).data=e,(r=e[0]).hasOwnProperty("physicalid")&&""===r.physicalid)throw o.epmtyPhysicalId;this.physicalid=r.physicalid,i.push({physicalid:this.physicalid}),this.dataPIDs=i,this.tenant=r.tenant,this.commandManager.setTenant(this.tenant),this.commandManager.addEvent("onCompleteGetOptions",function(e){document.body.style.cursor="default",this.deleteOptions=e.options,this.refreshType="Delete",this.dispatchEvent("onReady",{})},this);var s={data:[{physicalid:this.physicalid}],command:"Delete"};this.commandManager.getOptions(s,function(e,i){t.showError(e),t._refreshInvalidObjects(i),t._onComplete()})}else{var n;(n={}).data=e;for(var r,a=(r=e[0]).tenant,l=[],c=(i=[],0);c<n.data.length;++c){var d=e[c];if(d.hasOwnProperty("physicalid")&&""===d.physicalid)throw o.epmtyPhysicalId;if(d.tenant!=a)throw o.MultipleTenants;l.push(d.physicalid),i.push({physicalid:d.physicalid})}this.pids=l,this.dataPIDs=i,this.tenant=a,this.commandManager.setTenant(this.tenant),this.commandManager.addEvent("onCompleteGetOptions",function(e){document.body.style.cursor="default",this.deleteOptions=e.options,this.refreshType="Delete",this.dispatchEvent("onReady",{})},this);s={data:i,command:"Delete"};this.commandManager.getOptions(s,function(e,i){t.showError(e),t._refreshInvalidObjects(i),t._onComplete()})}},_executeDelete:function(e){var t={},i=this.dataPIDs;t.data=i,t.notificationTimeout=300,"restore"!=this.operationType&&(t.options=this.deleteOptions),console.log("Prepare Delete/Restore Input:"),console.log(t);var s=JSON.stringify(t);document.body.style.cursor="wait";var n=function(){document.body.style.cursor="default",e()},r=this;if(null!=r.context&&"function"==typeof r.context.getSecurityContext){var l=r.context.getSecurityContext();r.securityContext=l.SecurityContext,r.DeleteServiceRequest(s,n)}else a.getSecurityContextPromise().then(function(e){null==e?(r.showError({errorMsg:o.ErrorSecurityContextEmpty}),n()):(r.securityContext=e,r.DeleteServiceRequest(s,n))}).catch(function(e){r.showError({errorMsg:e}),n()})},_refreshInvalidObjects:function(e){if(e&&UWA.is(e.report,"array")){var t=this._getInvalidObjectIDs(e.report);if(!(t.length<1)){for(var i=[],s=0;s<t.length;++s)i.push({physicalid:t[s]});this._refreshObjects("Delete",i)}}},_getInvalidObjectIDs:function(e){for(var t=[],i=0;i<e.length;++i)if(UWA.is(e[i].errorcode,"number")&&(1===e[i].errorcode||100===e[i].errorcode||101===e[i].errorcode))if(UWA.is(e[i].physicalids,"array"))for(var s=e[i].physicalids,n=0;n<s.length;++n)t.push(s[n]);else UWA.is(e[i].physicalid)&&t.push(e[i].physicalid);return t},showNotification:function(e,t){if("function"==typeof this.context.displayNotification){var i={eventID:"string"==typeof t?t:"primary",msg:e};this.context.displayNotification(i)}else alert(e)},showError:function(e){if(void 0!==this.context&&null!==this.context&&"function"==typeof this.context.displayNotification){var t=e.message||e,i="error";null!=e&&e&&e.hasOwnProperty("isNotificationInfo")&&e.isNotificationInfo&&(i="info");var s=!1;null!=e&&e&&e.hasOwnProperty("sticky")&&(s=e.sticky);var n={eventID:i,msg:t.split?t.split("\n").join("<br>"):t,sticky:s};this.context.displayNotification(n)}else alert(e)},_refreshObjects:function(e,t,i){var s={created:[],deleted:[],modified:[],restored:[]};s.context=this.context;var n=function(e,t,i){e.forEach(function(e){t.push({physicalid:e.physicalid,operation:i,impl:e.impl})})};t&&n(t,s.deleted,e),i&&n(i,s.restored,e),h.dispatchEvent("onModification",s)},_refreshFromSuccessResponse:function(e){var t=[],i=[];e.results.forEach(function(e){"restore"===this.operationType?i.push(e):t.push(e)},this),this._refreshObjects(this.refreshType,t,i)},DeleteServiceRequest:function(e,t){var i=this;this._commandResult=!1;var s=l.get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/Delete/structure",null);d.authenticatedRequest(s,{method:"POST",headers:l.getHeaders(encodeURIComponent(this.securityContext)),timeout:288e5,onComplete:function(e){var s;if(console.log("delete: COMPLETED"),console.log(e),null!=e)if(e.hasOwnProperty("results")&&0!==e.results.length&&(i._commandResult=!0),i.launchReportingPanel(e),t(),!0===i._commandResult){if(e.hasOwnProperty("report")&&0!==e.report.length){var n=e.report.length;s=o.deletePartialSuccessful+": "+n+" ",s+=1===n?o.deleteIgnoredObject:o.deleteIgnoredObjects}else s=o.deleteSuccessful;i.showNotification(s),i._refreshFromSuccessResponse(e)}else s=e.hasOwnProperty("errormessage")?e.errormessage:o.deleteFailed,"restore"===i.operationType&&(s=o.restoreFailed),i.showError(s),i._refreshInvalidObjects(e);else t()},data:e,onFailure:function(e,s){var n=a._parseWebServiceError(e,s,!0,"Delete");void 0!==n&&void 0!==n&&n.hasOwnProperty("message")?(n.errorMsg=n.message,n.type="error",n.hasOwnProperty("isNotificationInfo")&&n.isNotificationInfo&&(n.type="info")):n.errorMsg=a.parseWebServiceError(e,s,!0),n.sticky=!0,i.showError(n),console.log("Failed to retrive data from the server"),t()},onTimeout:function(e){(e=a._parseWebServiceError(e,null,!0,"Delete")).sticky=!0,i.showError(e),t()},type:"json"})}})});