/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CATW3DAnims/CATW3DAnimation",["UWA/Class"],function(i){"use strict";return i.extend({init:function(i){var t=i||{},e=0,r=null,n=!1,o=t.nbSteps,a=t.animationTime/o,s=1,c=!1;o&&o>0&&a&&a>0&&(c="function"==typeof t.onAnimation,t.onBeforeFirstAnimation&&c&&(c=c&&"function"==typeof t.onBeforeFirstAnimation),t.onAnimationEnd&&c&&(c=c&&"function"==typeof t.onAnimationEnd)),this.forceInitAnimation=function(){s=0,e=0,r&&(clearInterval(r),r=null)},this.animate=function(i){c&&(s!==i&&(clearInterval(r),r=null),s=i,n||(t.onBeforeFirstAnimation&&t.onBeforeFirstAnimation(),n=!0),r=setInterval(function(){var i=!1;0===s?e>=100/o?(e-=100/o,i=!0):e=0:e<=100-100/o?(e+=100/o,i=!0):e=100,i?t.onAnimation(e,s):(clearInterval(r),r=null,t.onAnimationEnd&&t.onAnimationEnd(e))},a))}}})}),define("DS/CATW3DAnims/CATW3DAnimation3D",["UWA/Core","UWA/Class","UWA/Utils","DS/Animation/PropertyAnimation","DS/Animation/ANIM","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS","DS/SceneGraphOverrides/SceneGraphOverrideSet"],function(i,t,e,r,n,o,a,s){"use strict";var c={};window.c3dUrlComplementForODT&&(c=e.parseQuery(window.c3dUrlComplementForODT)),""!==window.location.search&&(i.extend(c,e.parseQuery(window.location.search)),c.widgetDomain&&i.extend(c,e.parseQuery(c.widgetDomain)));var u,l,f,p,m,d,v=function(i){return"opacityOn"===i||"opacityOff"===i||"showAxis"===i||"hideAxis"===i?100:"cancel"===i||"unsnap"===i?200:"snap"===i?400:"move"===i||"rotate"===i?100:null},y=(u=new a.Quaternion,l=new a.Quaternion,f=new a.Vector3,p=new a.Vector3,m=new a.Vector3,d=new a.Vector3,function(i){if(!i.matrixSource||!i.matrixTarget)return null;i.matrixSource.decompose(f,u,m),i.matrixTarget.decompose(p,l,d);var t=u.slerp(l,i.factor),e=f.lerp(p,i.factor),r=m.lerp(d,i.factor);return(new a.Matrix4).compose(e,t,r)}),h=function(){var i=new a.Vector3,t=new a.Vector3(1,1,1);return function(e){if(!(e.obj.quaternionSource&&e.obj.quaternionTarget&&e.obj.centerRotation&&e.obj.matrixSource))return null;e.obj.quaternionSource=e.obj.quaternionSource.slerp(e.obj.quaternionTarget,e.factor);var r=(new a.Matrix4).compose(i,e.obj.quaternionSource,t),n=(new a.Matrix4).setPosition(e.obj.centerRotation),o=r.multiply((new a.Matrix4).getInverse(n).multiply(e.obj.matrixSource));return n.multiply(o)}}(),b=t.extend({init:function(t){var e={},u={},l=[],f="no"===c.c3dAnim,p=t.viewer,m=p.getSceneGraphOverrideSetManager();e.opacityOn=function(i){if(!(i.progress<0)){var t=.7;i.progress>=30&&(t=(i.progress-100)*(i.util.opacityOnEnd-.7)/70+i.util.opacityOnEnd),t<0&&(t=0),i.util.objectListToAnimate.forEach(function(i){i.override&&i.override.setOpacity(t,!0)}),p.render()}},e.opacityOff=function(i){if(!(i.progress<0)){var t=.3+i.progress/100*.7;(100===i.progress||t>1)&&(t=1),i.util.objectListToAnimate.forEach(function(i){i.override&&i.override.setOpacity(t,!0)}),p.render()}},e.opacityOnOff=function(i){if(!(i.progress<0)){var t=.7;t=i.progress<=50?-.014*i.progress+1:.014*i.progress+1-1.4,100===i.progress||t>1?t=1:t<0&&(t=0),i.util.objectListToAnimate.forEach(function(i){i.override&&i.override.setOpacity(t,!0)}),p.render()}},e.snap=function(i){i.progress<0||(i.util.objectListToAnimate.forEach(function(t){if(t.override){var e=null,r=t.override.getPosition();if(r)e=(new a.Matrix4).copy(r);else{var n=(new a.Matrix4).copy(t.initWorldMatrix);e=(new a.Matrix4).getInverse(t.path.getParentPath().getWorldMatrix()).multiply(n)}var o=t.snappedPosition;t.override.setPosition(y({matrixSource:e,matrixTarget:o,factor:i.progress/100}))}}),p.render())},e.unsnap=function(i){i.progress<0||(i.util.objectListToAnimate.forEach(function(t){if(t.override){var e=null;if(t.currentPosition)e=(new a.Matrix4).copy(t.currentPosition);else{var r=t.override.getPosition();e=(new a.Matrix4).copy(r)}var n=t.snappedPosition;t.override.setPosition(y({matrixSource:n,matrixTarget:e,factor:i.progress/100}))}}),p.render())},e.cancel=function(i){i.progress<0||(100===i.progress?i.util.objectListToAnimate.forEach(function(i){i.override&&i.override.setPosition(null)}):i.util.objectListToAnimate.forEach(function(t){t.lastMatrix=y({matrixSource:t.currentMatrix,matrixTarget:t.initMatrix,factor:i.progress/100}),t.override&&t.override.setPosition(t.lastMatrix)}),p.render())},e.move=function(i){if(!(i.progress<0)&&(i.util.iterationData||(i.util.iterationData=[],i.util.objectListToAnimate.forEach(function(t){i.util.iterationData.push({matrixSource:(new a.Matrix4).copy(t.matrixSource),matrixTarget:t.matrixTarget,override:t.override})})),0!==i.progress)){var t=i.progress/100;i.util.iterationData.forEach(function(i){if(i.override){var e=y({matrixSource:i.matrixSource,matrixTarget:i.matrixTarget,factor:t});i.override.setPosition(e),i.matrixSource=e}}),p.render()}},e.rotate=function(i){if(!(i.progress<0)){if(!i.util.iterationData){i.util.iterationData=[];var t=new a.Vector3,e=new a.Vector3;i.util.objectListToAnimate.forEach(function(r){var n=new a.Quaternion;r.matrixRotation.decompose(t,n,e);var o=r.matrixParent?(new a.Vector3).copy(r.centerRotation).applyMatrix4(r.matrixParent):r.centerRotation,s=r.matrixParent?(new a.Matrix4).multiplyMatrices(r.matrixParent,r.matrixSource):r.matrixSource;i.util.iterationData.push({quaternionSource:new a.Quaternion,quaternionTarget:n,centerRotation:o,matrixSource:s,matrixParentInv:r.matrixParentInv,override:r.override})})}if(0!==i.progress){var r=i.progress/100;i.util.iterationData.forEach(function(i){if(i.override){var t=h({obj:i,factor:r});i.override.setPosition(i.matrixParentInv?(new a.Matrix4).multiplyMatrices(i.matrixParentInv,t):t)}}),p.render()}}},e.color=function(i){i.progress<0||(i.util.objectListToAnimate.forEach(function(t){t.override&&t.override.setColor(i.util.color,!0)}),p.render())},u.visibility=function(){return function(i){var t=i.progress/100;i.util.visibility||(t=1-t),i.util.objectListToAnimate.forEach(function(i){(i.node||i.children)&&(i.node||i).children.forEach(function(i){i.setRatio?i.setRatio(t):i.children.forEach(function(i){i.setRatio&&i.setRatio(t)})})}),(f||100===i.progress&&i.util.visibility||0===i.progress&&!i.util.visibility)&&i.util.objectListToAnimate.forEach(function(t){t.override&&t.override.setPickability(i.util.pickability?"PICKABLE":null)}),(f||0===i.progress&&i.util.visibility||100===i.progress&&!i.util.visibility)&&i.util.objectListToAnimate.forEach(function(t){var e;t.override?(t.override.setVisibilityFree(!i.util.visibility),t.override.setVisibility(i.util.visibility)):((e=t.parents[0])&&"AxisSystems"===e.name&&e.setVisibilityFree(!1),t.setVisibilityFree(!i.util.visibility),function i(t,e,r){t.setVisibility(e),t.setPickable(r?o.PICKABLE:o.PICKTHROUGH),t.getChildren().forEach(function(t){i(t,e,r)})}(t,i.util.visibility,i.util.pickability)),(t.node||t.children)&&(t.node||t).children.forEach(function(i){i.setRatio?i.setRatio(1):i.children.forEach(function(i){i.setRatio&&i.setRatio(1)})})}),p.render()}}(),this.addAnimation=function(t){if(this.isRunning())return{returnCode:-1};if(!t||!t.objectListToAnimate||!t.animationType||!e[t.animationType]&&"mask"!==t.animationType&&"unmask"!==t.animationType&&"opacityOnOff"!==t.animationType)return{returnCode:-1};var o=t.objectListToAnimate,a=t.callBackFct;if(!0===t.createOverrideSet){var c=new s(t.objectListToAnimate[0].path.externalPath[0]);if(m.pushSceneGraphOverrideSet(c),o=[],"mask"===t.animationType||"unmask"===t.animationType||"color"===t.animationType||"opacityOnOff"===t.animationType){var u=[];t.objectListToAnimate.forEach(function(i){!i.override&&i.path&&u.push(i.path)}),u.length&&o.push({override:c.createOverride({pathes:u})})}else t.objectListToAnimate.forEach(function(t){if(!t.override&&t.path){var e=i.extend({},t);e.override=c.createOverride({pathes:t.path}),o.push(e)}});a=function(){m.removeSceneGraphOverrideSet(c),t.callBackFct&&t.callBackFct(),p.render()}}if("mask"===t.animationType)return this.addAnimation({animationType:"opacityOn",duration:"number"==typeof t.duration?t.duration:v(t.animationType),opacityOnEnd:0,objectListToAnimate:o,offsetTime:t.offsetTime,callBackFct:function(){o.forEach(function(i){i.override&&(i.override.setVisibility(!1),i.override.setVisibilityFree(!0),i.override.setOpacity(null,null))}),a&&a(),p.render()}});if("unmask"===t.animationType)return o.forEach(function(i){i.override&&(i.override.setOpacity(0),i.override.setVisibility(!0),i.override.setVisibilityFree(null))}),this.addAnimation({animationType:"opacityOff",duration:"number"==typeof t.duration?t.duration:v(t.animationType),objectListToAnimate:o,offsetTime:t.offsetTime,callBackFct:function(){a&&a(),o.forEach(function(i){i.override&&(i.override.setOpacity(null,null),i.override.setVisibility(null))}),p.render()}});var d={objectListToAnimate:o,callback:a};"opacityOn"===t.animationType?d.opacityOnEnd="number"==typeof t.opacityOnEnd?t.opacityOnEnd:.3:"color"===t.animationType&&(d.color=t.color);var y=f?0:"number"==typeof t.offsetTime?t.offsetTime:0,h=f?0:"number"==typeof t.duration?t.duration:v(t.animationType);0===o.length&&(h=0);var b={duration:function(){return h+y},valueAt:function(i){return{progress:i<y?-1:0===h?100:(i-y)/h*100,util:d}}};return l.push(new r(e,t.animationType,b,function(i){i===n.State.STOPPED?(a&&a(),l.splice(l.indexOf(this),1)):i===n.State.RUNNING&&0===b.duration()&&this.stop()})),{returnCode:0}},this.startAnimation=function(){return this.isRunning()?{returnCode:-1}:(l.slice().forEach(function(i){i.start()}),{returnCode:0})},this.isRunning=function(){return l.some(function(i){return i.state()===n.State.RUNNING})},this.forward=function(){l.forEach(function(i){i.setTime(i.duration())}),this.stop()},this.stop=function(){l.slice().forEach(function(i){i.stop()})},this.axisSystemVisibility=function(i){var t={objectListToAnimate:i.objectListToAnimate,visibility:i.visibility,pickability:i.pickability},e=f?0:"number"==typeof i.duration?i.duration:v(i.visibility?"showAxis":"hideAxis"),o={duration:function(){return e},valueAt:function(i){return{progress:0===e?100:i/e*100,util:t}}};return new r(u,"visibility",o,function(t){t===n.State.STOPPED?i.callBackFct&&i.callBackFct():t===n.State.RUNNING&&0===o.duration()&&this.stop()}).start(),{returnCode:0}},this.getDefaultDuration=function(i){return v(i)}}}),T=[];return t.singleton({init:function(){},getAnimation3DEngine:function(i){var t;if(i&&i.viewer&&(T.some(function(e){return e.viewer===i.viewer&&(t=e.engine,!0)}),!t)){var e=new b({viewer:i.viewer});T.push({viewer:i.viewer,engine:e}),t=e}return t}})});