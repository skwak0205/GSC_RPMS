define("DS/ReviseFromWidget/ReviseFromPrefsDlg",["UWA/Class","UWA/Core","DS/UIKIT/SuperModal","DS/Controls/Toggle","DS/Controls/ButtonGroup","i18n!DS/ReviseFromWidget/assets/nls/ReviseFromPrefsDlg","i18n!DS/Windows/assets/nls/translation","css!DS/LifecycleControls/assets/styles/LifecycleModals"],function(e,t,i,s,n,r,o,a){"use strict";return e.singleton({init:function(){this._parent({})},showDialog:function(e){var t=this,s=e.onOk,n=e.onShow,r=new i({closable:!0,className:"Lifecycle_Modals",events:{onShow:function(){null!=n&&n(this)}},renderTo:e.parent}),a=this.buildDialogBody(e);r.dialog({body:a,title:e.title,buttons:[{className:"primary",value:o.save,action:function(e){var i={};t.titleFromSourceToggle&&(i.titleFromSource=t.titleFromSourceToggle.checkFlag),t.warningNoReviseToggle&&(i.warningNoRevise=t.warningNoReviseToggle.checkFlag),e.hide(),s(i)}},{value:o.cancel,action:function(e){e.hide()}}]})},buildDialogBody:function(e){var i=t.createElement("div",{styles:{position:"relative",height:"100%",overflow:"auto"}}),o=new n({type:"checkbox"});return this.titleFromSourceToggle=new s({type:"checkbox",label:r.CopyTitleFromSource,value:0,checkFlag:e.titleFromSource}),o.addChild(this.titleFromSourceToggle),this.warningNoReviseToggle=new s({type:"checkbox",label:r.WarningNoRevise,value:1,checkFlag:e.warningNoRevise}),o.addChild(this.warningNoReviseToggle),o.inject(i),i}})}),define("DS/ReviseFromWidget/util/TreeSyncMgr",["UWA/Controls/Abstract","DS/LifecycleServices/Utils"],function(e,t){"use strict";return e.extend({nextId:1,syncing:!1,add:function(e,i){var s=this,n=i||!1;this.trees=this.trees||[],this.debouncedSyncScroll=this.debouncedSyncScroll||t.debounce(this.syncScrollTo.bind(this),25);var r=s.nextId++;return e.getManager().onReady(function(){var t=0;n&&s.trees.length>0&&(t=s.trees[0].id),s.trees.push({id:r,tree:e}),e.getManager().getScroller().onScroll(function(){s.debouncedSyncScroll(r)}),0!==t&&s.syncScrollTo(t),e.onExpand(function(e){s.syncNodes(r,e.data.nodeModel._rowID,function(e){e.expand()})}),e.onCollapse(function(e){s.syncNodes(r,e.data.nodeModel._rowID,function(e){e.collapse()})})}),r},remove:function(e){},syncScrollTo:function(e){var t=this.trees.find(function(t){return t.id===e});if(t){var i=t.tree.getManager().getScrollerPosition(),s=this;this.trees.forEach(function(t){t.id!==e&&(s.syncing=!0,t.tree.getManager().setScrollerPosition(i),s.syncing=!1)})}},syncNodes:function(e,t,i){this.syncing||(this.syncing=!0,this.trees.forEach(function(s){if(s.id!==e){var n=s.tree.getManager().getTreeNodeModelFromRowID(t);n&&i(n)}}),this.syncing=!1)}})}),define("DS/ReviseFromWidget/controls/TreesContainer",["UWA/Controls/Abstract"],function(e){"use strict";return e.extend({name:"treesContainer",init:function(e){this._panels=[],this._parent(e),this._buildLayout()},addPanel:function(e){e.inject(this.getContent()),this._panels.push(e),e.addEvent("collapseChange",this._updateLayout.bind(this))},_updateLayout:function(){var e=this._panels.reduce(function(e,t){return e+(t.isCollapsed()?0:1)},0);2!==e&&3!==e||this._panels.forEach(function(t){t.isCollapseable()&&(2===e?t.setSize50pct():t.setSize33pct())})},_buildLayout:function(){var e={class:this.getClassNames("-root")};this.elements.container=new UWA.Element("div",UWA.merge(this.options,e)),this._render()},_render:function(){}})}),define("DS/ReviseFromWidget/ReviseFromConstants",[],function(){"use strict";return{ActionOption:{Revise:"revise",ReviseTree:"revisetree",Reuse:"reuse",Exclude:"exclude",InsertNew:"insertnew",ReuseReference:"reuse_reference"}}}),define("DS/ReviseFromWidget/controls/TreePanel",["UWA/Controls/Abstract"],function(e){"use strict";return e.extend({name:"treePanel",defaultOptions:{caption:"-",addClass:"",collapseable:!1,UIcollapseable:!0},init:function(e){this._parent(e),this._isCollapsed=!1,this._isMaximized=!1,this.setSize33pct(),this._buildLayout()},_buildLayout:function(){var e=this,t=" ";this.options.collapseable&&(t+=this.expandClass);var i={class:this.getClassNames("-root")+t+" "+this.options.addClass};this.elements.container=new UWA.Element("div",i);var s=new UWA.Element("div",{class:this.getClassNames("-panelHeader")});s.inject(this.elements.container),this.elements.headerText=new UWA.Element("span",{class:this.getClassNames("-headerText"),html:this.options.caption}),this.elements.headerText.inject(s),this.elements.contentContainer=new UWA.Element("div",{class:this.getClassNames("-contentContainer")}),this.elements.contentContainer.inject(this.elements.container);var n="";this.options.collapseable&&(n="treePanel-content-hide-expander"),this.elements.contentHide=new UWA.Element("div",{class:this.getClassNames("-content-hide")+" "+n,events:{click:function(){e.options.UIcollapseable&&e.options.collapseable&&e.toggleCollapsed()}}}),this.elements.contentHide.inject(this.elements.contentContainer),this.elements.captionCollapsed=new UWA.Element("span",{class:this.getClassNames("-caption-collapsed"),html:this.options.caption}),this.elements.captionCollapsed.inject(this.elements.contentHide),this.elements.content=new UWA.Element("div",{class:this.getClassNames("-content")}),this.elements.content.inject(this.elements.contentContainer),this.options.collapseable&&(this.elements.headerBtn=new UWA.Element("div",{class:this.getClassNames("-headerButton"),events:{click:function(){e.toggleCollapsed()}}}),this.elements.headerBtnIcon=new UWA.Element("div",{class:"fonticon fonticon-double-chevron-left treePanel-headerButtonIcon"}),this.elements.headerBtnIcon.inject(this.elements.headerBtn),this.elements.headerBtn.inject(s)),this._render()},_render:function(){},isCollapsed:function(){return this._isCollapsed},isCollapseable:function(){return this.options.collapseable},setUICollapseable:function(e){this.options.UIcollapseable!==e&&((this.options.UIcollapseable=e)?(this.elements.headerBtn.removeClassName("treePanel-hidden"),this.elements.contentHide.addClassName("treePanel-content-hide-expander")):(this.elements.headerBtn.addClassName("treePanel-hidden"),this.elements.contentHide.removeClassName("treePanel-content-hide-expander")))},hide:function(){this.elements.container.addClassName("treePanel-hidden")},show:function(){this.elements.container.removeClassName("treePanel-hidden")},_setCollapsed:function(e){this._isCollapsed=e,this.dispatchEvent("collapseChange",{isCollapsed:e})},setSize33pct:function(){this._setSizepct("treePanel-expandedPanel33")},setSize50pct:function(){this._setSizepct("treePanel-expandedPanel50")},_setSizepct:function(e){this.expandClass!==e&&(!this.isCollapsed()&&this.elements.container&&this.elements.container.removeClassName(this.expandClass),this.expandClass=e,!this.isCollapsed()&&this.elements.container&&this.elements.container.addClassName(this.expandClass))},collapse:function(){this.isCollapseable()&&(this.isCollapsed()||(this.elements.container.removeClassName(this.expandClass),this.elements.container.addClassName("treePanel-collapsedPanel"),this.elements.contentHide.style.display="block",this.elements.headerText.style.display="none",this.elements.headerBtnIcon.removeClassName("fonticon-double-chevron-left"),this.elements.headerBtnIcon.addClassName("fonticon-double-chevron-right"),this._setCollapsed(!0)))},expand:function(){this.isCollapseable()&&this.isCollapsed()&&(this.elements.container.addClassName(this.expandClass),this.elements.container.removeClassName("treePanel-collapsedPanel"),this.elements.contentHide.style.display="none",this.elements.headerText.style.display="block",this.elements.headerBtnIcon.addClassName("fonticon-double-chevron-left"),this.elements.headerBtnIcon.removeClassName("fonticon-double-chevron-right"),this._setCollapsed(!1))},toggleCollapsed:function(){this.isCollapsed()?this.expand():this.collapse()},maximize:function(){this._isMaximized||(this._isMaximized=!0,this.elements.container.addClassName("treePanel-maximized"))},restore:function(){this._isMaximized&&(this._isMaximized=!1,this.elements.container.removeClassName("treePanel-maximized"))}})}),define("DS/ReviseFromWidget/ReviseFromModel",["UWA/Controls/Abstract"],function(e){"use strict";return e.extend({init:function(){this.histLinksNodes={},this.histLinksConnections={},this.graphs=[]},setHistLinksData:function(e){var t=e;t.hasOwnProperty("nodes")&&(this.histLinksNodes=t.nodes),t.hasOwnProperty("connections")&&(this.histLinksConnections=t.connections)},getVersionGraphData:function(){return this.graphs},setVersionGraphData:function(e){var t=e;t.hasOwnProperty("graphs")&&(this.graphs=t.graphs)},getHistLinksNodes:function(){return this.histLinksNodes},getHistLinksConnections:function(){return this.histLinksConnections},getSources:function(e,t){var i=[],s=null;return t&&this.graphs.some(function(t){return t.versions.some(function(t){return t.id===e&&(s=t.copyFrom,!0)})}),this.graphs.forEach(function(n){n.versions.forEach(function(n){if(n.id!==e){if(t&&(n.copyFrom!==e&&n.id!==s||n.logicalid===e))return;i.push(n)}})}),i},getDuplicates:function(e,t){for(var i,s=[],n=[],r=0;r<this.histLinksNodes.length;++r)if(this.histLinksNodes[r].id===e){i=this.histLinksNodes[r].nId;break}for(var o=0;o<this.histLinksConnections.length;++o){var a=(d=this.histLinksConnections[o]).typ;d.src===i?("duplicate"===a||t&&("evolution"===a||"revision"===a||"revisionFrom"===a))&&n.push(d.trg):t&&d.trg===i&&("duplicate"!==a&&"evolution"!==a&&"revision"!==a&&"revisionFrom"!==a||n.push(d.src))}for(var c=0;c<n.length;++c)for(var l=0;l<this.histLinksConnections.length;++l){var d;a=(d=this.histLinksConnections[l]).typ;d.src===n[c]?("revision"===a||"revisionFrom"===a||t&&("duplicate"===a||"evolution"===a))&&d.trg!=i&&n.indexOf(d.trg)<0&&n.push(d.trg):t&&d.trg===n[c]&&("duplicate"!==a&&"evolution"!==a&&"revision"!==a&&"revisionFrom"!==a||d.src!=i&&n.indexOf(d.src)<0&&n.push(d.src))}return n.length>0&&(s=this.histLinksNodes.filter(function(e){for(var t=0;t<n.length;++t)if(n[t]===e.nId)return!0;return!1})),s}})}),define("DS/ReviseFromWidget/ReviseFromController",["UWA/Controls/Abstract","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleServicesSettings","DS/ReviseFromWidget/ReviseFromModel","DS/WAFData/WAFData","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","DS/LifecycleServices/LifecycleCommandManager","DS/LifecycleCmd/MessageMediator","i18n!DS/LifecycleServices/assets/nls/LifecycleServicesNls"],function(e,t,i,s,n,r,o,a,c){"use strict";return e.extend({tenant:null,context:null,init:function(){this.model=new s,this.commandManager=new o},setContext:function(e){this.context=e},_dispatchError:function(e,t){this.dispatchEvent("onError",{message:e,options:t})},_dispatchNotification:function(e,t){this.dispatchEvent("onNotification",{message:e,options:t})},_onFailure:function(e,i,s){var n=this;t.showWebServiceError(i,s,function(e,t,i,s,r){t?n._dispatchNotification(c.reviseTimeoutInfo,{sticky:!0}):n._dispatchError(e,{title:i,subtitle:s,submessage:r})},e),console.log("Failed to retrive data from the server")},_onTimeout:function(e,t){e?this._dispatchNotification(c.reviseTimeoutInfo,{sticky:!0}):this._dispatchError(r.timeout),console.log("Timeout error")},getDuplicates:function(e){var i=this;t.getSecurityContextPromise(this.tenant,this.context).then(function(t){i.getRevisionHistory(e,t)})},getSources:function(e){var i=this;t.getSecurityContextPromise(this.tenant,this.context).then(function(t){i.getVersionGraph(e,t)})},getObjectInfo:function(e,i){var s=this;t.getSecurityContextPromise(this.tenant,this.context).then(function(t){s.getAttributes(e,t,i)})},getNextRevisionInfo:function(e){var i=this;return new UWA.Class.Promise(function(s,n){t.getSecurityContextPromise(i.tenant,i.context).then(t=>i.getVersionNumberProposal(e,t)).then(e=>{s(e)}).catch(e=>{i._dispatchError(t.parseWebServiceError(e).toString())})})},getVersionNumberProposal:function(e,t){var s=this;return new UWA.Class.Promise(function(r,o){var a=[],c=[];e.forEach(function(e){(c=[]).push({semantic:"LAST",id:e}),a.push({copyId:e,ancestors:c})});var l=i.get3DSpaceWSUrl(s.tenant,"/resources/v1/dslc/getversionnumberproposal",null);n.authenticatedRequest(l,{type:"json",method:"POST",headers:i.getHeaders(encodeURIComponent(t)),timeout:6e5,data:JSON.stringify({addRequests:a}),onComplete:function(e){var t="string"==typeof e?JSON.parse(e):e;r(t)},onTimeout:s._onTimeout.bind(s,!1),onFailure:s._onFailure.bind(s,!1)})})},getReviseAccessInfo:function(e){var i=this,s=["majorid.lastmajorid.bestsofar.current.access[majorrevise]","majorid.lastmajorid.bestsofar.physicalid","last.current.majorrevisionable","last.current.revisionable"];return new UWA.Class.Promise(function(n,r){t.getSecurityContextPromise(i.tenant,i.context).then(t=>i.getAttributesPromise(e,s,t)).then(e=>{n(e)}).catch(e=>{i._dispatchError(t.parseWebServiceError(e).toString())})})},getAttributesPromise:function(e,t,s){var r=this;return new UWA.Class.Promise(function(o,a){var c={data:[],attributes:t};e.forEach(function(e){if(-1===c.data.findIndex(t=>t.physicalid===e)){var t={physicalid:e};c.data.push(t)}});var l=i.get3DSpaceWSUrl(r.tenant,"/resources/lifecycle/product/attributeList",null);n.authenticatedRequest(l,{type:"json",method:"POST",headers:i.getHeaders(encodeURIComponent(s)),timeout:6e5,data:JSON.stringify(c),onComplete:function(e){var t="string"==typeof e?JSON.parse(e):e;o(t)},onTimeout:r._onTimeout.bind(r,!1),onFailure:r._onFailure.bind(r,!1)})})},createNewRevisionFrom:function(e){var i=this;t.getSecurityContextPromise(this.tenant,this.context).then(function(t){i.reviseFromServiceRequest(e,t)})},getRevisionHistory:function(e,t){var s=this,r=i.get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/history/links",null);e.hasOwnProperty("physicalid")&&n.authenticatedRequest(r,{method:"GET",headers:i.getHeaders(t),timeout:6e5,onComplete:function(e){console.log("getRevisionHistory: COMPLETED"),s.onObjectLinksDownloaded(e)},data:"physicalid="+e.physicalid+"&depth=100",onTimeout:this._onTimeout.bind(this,!1),onFailure:this._onFailure.bind(this,!1),type:"json"})},getVersionGraph:function(e,t){var s=this,r=[];r.push({id:e.physicalid});var o=i.get3DSpaceWSUrl(this.tenant,"/resources/v1/dslc/versiongraph","withIsLastVersion=1&withCopyFrom=1&withAdjacentVersion=1");e.hasOwnProperty("physicalid")&&n.authenticatedRequest(o,{method:"POST",headers:i.getHeaders(t),timeout:6e5,onComplete:function(t){s.onVersionGraphDownloaded(e,t)},data:JSON.stringify({graphRequests:r}),onTimeout:this._onTimeout.bind(this,!1),onFailure:this._onFailure.bind(this,!1),type:"json"})},onObjectLinksDownloaded:function(e){this.model.setHistLinksData(e),this.dispatchEvent("onDuplicatesRetrieved")},isRootAccessible:function(e,t){var i=!0;for(const s of t.graphs)if(s.item.vid===e){"#DENIED!"===s.item.code&&(i=!1);break}return i},onVersionGraphDownloaded:function(e,t){if(t.errorID){console.log("Version graph service error:"+t.errorID+" key:"+t.key),console.log("Version graph service error message:"+t.errorMessage);var i=t.errorMessage,s=e.displayName?e.displayName:e.name,n=r.replace(r.get("noReviseOfName"),{dispName:s});return 101!=t.errorID&&i||(i=r.objectNotFound),void this._dispatchError(i,{title:n,subtitle:i})}var o=!0,a=0===this.model.getVersionGraphData().length;if(!a||this.isRootAccessible(e.physicalid,t)){if(this.model.setVersionGraphData(t),a&&1===this.model.getSources(e.physicalid,!1).length){var c=this.model.getSources(e.physicalid,!0);if(1===c.length){o=!1;var l={physicalid:c[0].id};this.getSources(l)}}o&&this.dispatchEvent("onSourcesRetrieved")}else{i=r.objectNotFound,s=e.displayName?e.displayName:e.name,n=r.replace(r.get("noReviseOfName"),{dispName:s});this._dispatchError(i,{title:n,subtitle:i})}},getAttributes:function(e,t,s){var r=JSON.stringify(e),o=i.get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/product/attributeList",null);n.authenticatedRequest(o,{method:"POST",headers:i.getHeaders(t),timeout:6e5,onComplete:s,data:r,onTimeout:this._onTimeout.bind(this,!1),onFailure:this._onFailure.bind(this,!1),type:"json"})},reviseFromServiceRequest:function(e,t){var s=this;console.log("reviseFrom:");e.notificationTimeout=600;var o=JSON.stringify(e),c=i.get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/revise/from",null);n.authenticatedRequest(c,{method:"POST",headers:i.getHeaders(t),timeout:6e5,onComplete:function(t){if(console.log("reviseFrom: COMPLETED"),null!=t&&t.hasOwnProperty("status")&&t.hasOwnProperty("report")&&"failure"===t.status){for(var i=r.reviseFailed,n=null,o=0;o<t.report.length;o++){var c=t.report[o];if(c.ENOVersioningErrorKey&&("NonLinearVersioning.Error.NoReviseAccess"===c.ENOVersioningErrorKey||"NonLinearVersioning.Error.AccessRights"===c.ENOVersioningErrorKey||"NonLinearVersioning.Error.POVCarryOver"===c.ENOVersioningErrorKey)){n={title:r.reviseFailed,subtitle:r.get("verifyCredentials"),submessage:r.get("lackingReviseAccessRole")},console.log("Revise from failed with error: "+c.error);break}if(c.error&&c.error!==i){i=c.error;break}}s._dispatchError(i,n)}else{var l={created:[],deleted:[],modified:[]};l.context=s.context;var d=t.results,h=e.data[0].treeData.findIndex(function(e){return 0==e.level}),u=e.data[0].treeData[h],f=[];f.push(u),s.commandManager.findObjectDerivedFromSelection(d,f).forEach(function(e){var t=!1;e.hasOwnProperty("derivedfromphysicalid")&&(t=!0);var i={physicalid:e.physicalid,sourceObjectId:e.derivedfromphysicalid,sourceContentObjectId:u.physicalid_dup,operation:"Revise",refreshPSD:t};e.hasOwnProperty("folders")&&(l.refreshFolder=!0,i.folders=e.folders),l.created.push(i),d.forEach(function(t){if(t.derivedfromphysicalid!==e.derivedfromphysicalid){var i={physicalid:t.derivedfromphysicalid,operation:"Revise"};l.modified.push(i)}})}),a.dispatchEvent("onModification",l),s.dispatchEvent("onReviseSuccess")}},data:o,onTimeout:this._onTimeout.bind(this,!0),onFailure:this._onFailure.bind(this,!0),type:"json"})},setTenant:function(e){this.tenant=e}})}),define("DS/ReviseFromWidget/NewRevisionFromTree",["UWA/Class","UWA/Class/Events","DS/UIKIT/Mask","DS/LifecycleServices/LifecycleServicesSettings","DS/LifecycleServices/LifecycleServices","DS/WAFData/WAFData","DS/LifecycleControls/AssemblyTreeList","DS/UIKIT/Input/Select","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","DS/LifecycleServices/AssemblyJson","DS/LifecycleServices/ArrayFunctions","DS/ReviseFromWidget/ReviseFromConstants"],function(e,t,i,s,n,r,o,a,c,l,d,h){"use strict";return e.extend(t,{init:function(e,t,i,s){this.roots=[],this.tenant=t,this.context=i;for(var n=0;n<e.length;++n)this.roots.push({id:e[n]});this.filterDuplicateInstances=s},openAdvancedTree:function(e,t,s){this.container||(this.container=e,i.mask(this.container),s?this.createTree(s,t):this.createExpandedTree(t))},getAssembly:function(){return this.assembly},getAssemblyHelper:function(){return this.assemblyHelper},getInstances:function(e){return this.treeList.getSameNodes(e)},getNewRevFromData:function(e,t,i){var s=this.treeList.tree.getDocument().getNthRoot(0),n=[];this.addNodeData(n,s,[],0,e,t);var r={physicalid:s.options.physicalId,treeData:n,useSourceTitle:i};document.debugNRF&&(r.Dbg_label=s.options.label);var o=[];return o.push(r),o},addNodeData:function(e,t,i,s,n,r){if(-1===i.indexOf(t.options.nodeId)){i.push(t.options.nodeId);var o={occId:t.options.occId},a=t.dropdownListSelectedIndex,c=a?a.action:this.getDefSelIndex(o,t),l=this.getOptions(o,t).options[c];if(l!==h.ActionOption.Exclude){var d=this.assemblyHelper.getNode(t.options.nodeId);l!==h.ActionOption.ReuseReference||d.clonedFromPhysicalid&&d.clonedFromPhysicalid!==t.options.physicalId||(l=h.ActionOption.Reuse);var u=l===h.ActionOption.InsertNew,f=l===h.ActionOption.Reuse,p=l===h.ActionOption.ReuseReference,v=this.assemblyHelper.getOccurence(t.options.occId);if(!(u&&r&&v.insertedInstance)){var m={physicalid:u?"":d.clonedFromPhysicalid?d.clonedFromPhysicalid:t.options.physicalId,operation:l,physicalid_dup:t.options.physicalId,level:s};if(document.debugNRF&&(m.Dbg_label=t.options.label),!f&&!p&&t.hasChildren()){m.children=[];var g=t.getChildren(),y=g.length,R=0;for(R=0;R<y;R++){var I=g[R],T=this.assemblyHelper.getNode(I.options.nodeId),b={occId:I.options.occId},N=I.dropdownListSelectedIndex,S=N?N.action:this.getDefSelIndex(b,I),C=this.getOptions(b,I).options[S];if(C!==h.ActionOption.Exclude){C!==h.ActionOption.ReuseReference||T.clonedFromPhysicalid&&T.clonedFromPhysicalid!==I.options.physicalId||(C=h.ActionOption.Reuse);var F=C===h.ActionOption.InsertNew,D=C===h.ActionOption.Reuse,O=C===h.ActionOption.ReuseReference,P=this.assemblyHelper.getOccurence(I.options.occId);if(!(F&&r&&P.insertedInstance)){var w={physicalid:F?"":T.clonedFromPhysicalid?T.clonedFromPhysicalid:I.options.physicalId,operation:C,physicalid_dup:I.options.physicalId};document.debugNRF&&(w.Dbg_label=I.options.label),n&&(P.refOccRelId&&(w.rel_physicalid=P.refOccRelId),P.relId&&(w.rel_physicalid_dup=P.relId)),m.children.push(w),D&&O||F&&!r||!I.hasChildren()||this.addNodeData(e,I,i,s+1,n,r)}}}}e.push(m)}}}},hideNodes:function(e){var t=this.treeList.getNodes(function(t){if(e.includes(t.options.nodeId))return!0});this.treeList.tree.getDocument().prepareUpdate(),t.forEach(function(e){e._treeNode.hide()}),this.treeList.tree.getDocument().pushUpdate()},getOptions:function(e,t){var i=this.assemblyHelper.getOccurence(e.occId),s=[],n=[];if(i.actionInfo){if(i.actionInfo.revise){var r=t&&t._options&&t._options.children?t._options.children:[];s.push(h.ActionOption.Revise),n.push(c.revise),r.length>0&&!r[0]._isHidden&&(s.push(h.ActionOption.ReviseTree),n.push(c.reviseTree))}i.actionInfo.reuse&&(s.push(h.ActionOption.Reuse),n.push({text:c.reuse,disabled:!!i.actionInfo.disableReuse})),i.actionInfo.reuseref&&(s.push(h.ActionOption.ReuseReference),n.push({text:c.reuseReference,disabled:!!i.actionInfo.disableReuseref})),i.actionInfo.insertnew&&(s.push(h.ActionOption.InsertNew),n.push(c.insert)),i.actionInfo.exclude&&(s.push(h.ActionOption.Exclude),n.push(c.exclude))}else s.push(""),n.push("");return{options:s,translated:n}},getDefSelIndex:function(e,t){var i=0,s=this.assemblyHelper.getOccurence(e.occId);if(s.actionInfo&&s.actionInfo.defAction){var n=this.getOptions(e,t).options.indexOf(s.actionInfo.defAction);n>-1&&(i=n)}return i},createExpandedTree:function(e){var t=this;n.getSecurityContextPromise(this.tenant,this.context).then(function(s){t.expandStructure(s,function(s){i.unmask(t.container),t.assembly=l.convertFromExpandFormat(s),t.updateAssemblyNodesWithParentInfo(),t.createAdvancedTree(e);t.dispatchEvent("onTreeCreated",{})})})},createTree:function(e,t){i.unmask(this.container),this.assembly=e,this.createAdvancedTree(t);this.dispatchEvent("onTreeCreated",{})},createAdvancedTree:function(e){var t=["revision"];e.addActionCol&&t.push("action"),this.treeList=new o({getChildrenInTreeOrder:e.getChildrenInTreeOrder,allCols:t});var s={filterDuplicates:this.filterDuplicateInstances};this.container.setContent(this.treeList);var n=this;if(e.addActionCol){var r={column:"action",translated:c.action};this.treeList.insertDropdownListCol(0,r.column,r.translated,function(e,t){return n.getOptions(e,t).translated},function(e,t,s){var o={occId:s.options.occId},a=n.getOptions(o,s).options,l=a[t],d=a[e];i.mask(n.container,c.updatingMessage);var u=n.treeList.getSameNodes(s.options.nodeId);setTimeout(function(){u.forEach(function(e){e.getAllDescendants().forEach(function(e){var t=n.treeList.getSameNodes(e.options.nodeId);n.treeList.setDropdownSelectionIf(t,0,r.column)})});var s={preSelIdx:e,selIdx:t,prevSelOp:d,selOp:l,selNodes:u};n.dispatchEvent("onDropdownListChange",s),n.treeList.tree.getManager().updateView(),i.unmask(n.container)},50),l===h.ActionOption.ReviseTree&&n.treeList.setDropdownSelectionIf(u,0,"action")},void 0,void 0,function(e,t){return n.getDefSelIndex(e,t)})}!0===e.filter3DShapes&&(s.loadFilter=function(e){return"3DShape"===e.type}),this.assemblyHelper=l.AssemblyHelper(this.assembly),this.treeList.load(this.assembly,t,s),this.treeList.tree.getManager().onReady(function(){n.dispatchEvent("onTreeReady"),n._sortColumn&&n.treeList.tree.getManager().sortColumnContent(n._sortColumn.sortColumnID,{sortOrder:n._sortColumn.sort})}),this.treeList.tree.getManager().onSortColumnContent(function(e){n._sortColumn={sortColumnID:e.columnDataIndex,sort:e.sortOrder}}),this.treeList.tree.getDocument().expandAll()},setTreeNodeChildrenToAction:function(e,t,i){var s=this;e.hasChildren()&&e.getChildren().forEach(function(e){s.treeList.getSameNodes(e.options.nodeId).forEach(function(n){var r,o=n.options.occId,a=s.assemblyHelper.getOccurence(o);if(a.actionInfo.revise&&(a.actionInfo.reuse||a.actionInfo.reuseref)){var c=e._options&&e._options.children?e._options.children:[];r=c.length>0&&!c[0]._isHidden?i===h.ActionOption.Reuse?2:3:i===h.ActionOption.Reuse?1:2,s.treeList.setDropdownSelectionIf([n],r,"action")}else a.actionInfo.insertnew&&a.actionInfo.reuse&&(r=i===h.ActionOption.Reuse?0:1,s.treeList.setDropdownSelectionIf([n],r,"action"),s.setTreeNodeChildrenToAction(e,t,i))})})},updateAssemblyNodesWithParentInfo:function(){this.assembly.nodes.forEach(function(e){void 0===e.followsParent&&(e.followsParent="CATIA Embedded Component"===e.type||"3DShape"===e.type||"BundleFastener"===e.type)})},adjustHeight:function(){},sortOccRelsOnOrder:function(){this.assembly&&this.assembly.occurrencerelationships&&this.assembly.occurrencerelationships.sort(function(e,t){if(e.parent>t.parent)return 1;if(e.parent<t.parent)return-1;if(e.order&&t.order){if(e.order>t.order)return 1;if(e.order<t.order)return-1}return 0})},collapsedNodes:[],isNodeCollapsed:function(e){if(e.isExpanded())return!1;var t=e.getChildren();return!!t&&(t.length>1||0==t[0].isHidden())},storeAllCollapsed:function(){this.treeList&&this.treeList.tree&&this.treeList.tree.getDocument().getAllDescendants().forEach(function(e){this.isNodeCollapsed(e)&&this.collapsedNodes.push(e._options.occId)},this)},restoreAllCollapsed:function(){this.treeList&&this.treeList.tree&&(this.treeList.tree.getDocument().getAllDescendants().forEach(function(e){this.collapsedNodes.includes(e._options.occId)&&e.collapse()},this),this.collapsedNodes=[])},expandStructure:function(e,t){var i=this,n={intent:"explore_2D",debug:!1,type_filter_bo:["CATProduct","CATProcess","CATPart","CATDrawing","CATAnalysis","CATIA Embedded Component","CATIA CGR","CATShape","CATIA V4 Model","CATIA Design Table","VPMReference","VPMRepReference","3DShape"],roots:this.roots,level:"-1",source:"cstorage",authored:!0,root_physicalid:this.roots[0].id},o=s.get3DSpaceWSUrl(this.tenant,"/resources/enopad/lwc/expand",null);r.authenticatedRequest(o,{method:"POST",headers:s.getHeaders(e),timeout:6e5,data:JSON.stringify(n),type:"json",onComplete:function(e){t(e)},onFailure:function(e){var t=e;e.hasOwnProperty("error")?t=e.error:e.hasOwnProperty("message")&&(t=e.message),i.dispatchEvent("onError",{message:t}),console.error("NewRevisionFromTree.expandStructure: onFailure -> "+e)},onTimeout:function(e){i.dispatchEvent("onError",{message:c.connectionTimeout}),console.log("NewRevisionFromTree.expandStructure timeout error -> "+e)}})}})}),define("DS/ReviseFromWidget/ReviseFromPrefs",["UWA/Class","UWA/Promise","DS/ReviseFromWidget/ReviseFromPrefsDlg","DS/LifecycleServices/LifecycleServices","i18n!DS/ReviseFromWidget/assets/nls/ReviseFromPrefsDlg","DS/WidgetServices/WidgetServices","DS/WAFData/WAFData"],function(e,t,i,s,n,r,o){"use strict";return e.extend({init:function(e,t){this._parent({}),this._hWidget=e,this._appId=t,this._globalStorageName="NewRevisionFromSettings",this._useSourceTitle=!1,this._showWarningNoRevise=!1,this._defaultSettings={useSourceTitle:this._useSourceTitle,showWarningNoRevise:this._showWarningNoRevise}},_updateSettings:function(e){this._useSourceTitle=e.titleFromSource,this._showWarningNoRevise=e.warningNoRevise},_getPreferenceName:function(){return this._appId.slice(0,this._appId.length-1)+"_"+this._globalStorageName},getUseSourceTitle:function(){return this._useSourceTitle},getShowWarningNoRevise:function(){return this._showWarningNoRevise},loadSettingsPromise:function(){var e=this,i=this._getPreferenceName();return new t(function(t,s){r.getCompassUrlAsync({onComplete:function(s){var n=encodeURI(s+"/resources/AppsMngt/user/getPreferences?name="+i);o.authenticatedRequest(n,{method:"GET",timeout:5e3,headers:{Accept:"application/json",SecurityContext:void 0},cache:!1,onComplete:function(i){var s=null;s=null!=i&&""!=i?JSON.parse(i):e._defaultSettings,e._updateSettings(s),t(e)},onFailure:function(e){console.log("NRFSettings: failed getting value")}})}})})},save:function(e){this._updateSettings(e);var t=this._getPreferenceName();r.getCompassUrlAsync({onComplete:function(i){var s=encodeURI(i+"/resources/AppsMngt/user/setPreferences?name="+t+"&value="+JSON.stringify(e));o.authenticatedRequest(s,{method:"GET",timeout:5e3,headers:{Accept:"application/json",SecurityContext:void 0},cache:!1,onComplete:function(e){},onFailure:function(e){console.log("NRFSettings: failed setting ")}})}})},showPreferencesDlg:function(e){var t=this;i.showDialog({title:n.SettingsTitle,parent:document.body,titleFromSource:this.getUseSourceTitle(),warningNoRevise:this.getShowWarningNoRevise(),onShow:function(t){e&&e.onShow&&e.onShow(t)},onOk:function(i){var s={};void 0!==i.titleFromSource&&(s.titleFromSource=i.titleFromSource),void 0!==i.warningNoRevise&&(s.warningNoRevise=i.warningNoRevise),t.save(s),e&&e.onOk&&e.onOk(t)}})}})}),define("DS/ReviseFromWidget/ReviseFromWidget",["css!DS/ReviseFromWidget/ReviseFromWidget","UWA/Core","UWA/Controls/Abstract","DS/UIKIT/Mask","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleCommandManager","DS/LifecycleServices/LifecycleServicesSettings","DS/LifecycleServices/LifecycleAlert","DS/ReviseFromWidget/ReviseFromController","DS/ReviseFromWidget/util/TreeSyncMgr","DS/WAFData/WAFData","DS/ReviseFromWidget/NewRevisionFromTree","DS/LifecycleServices/AssemblyJson","DS/LifecycleControls/CommandDialog","DS/LifecycleServices/DictionaryServices","DS/ReviseFromWidget/controls/TreesContainer","DS/ReviseFromWidget/controls/TreePanel","DS/ReviseFromWidget/ReviseFromConstants","DS/ReviseFromWidget/ReviseFromPrefs","DS/ReportingPanel/ReportingPanel"],function(e,t,i,s,n,r,o,a,c,l,d,h,u,f,p,v,m,g,y,R,I){"use strict";return i.extend({securityContext:null,context:null,tenant:null,sources:null,pickDialog:null,refReviseFromTree:null,srcReviseFromTree:null,resReviseFromTree:null,newTreeResult:null,folderId:null,filterDuplicateInstances:!1,irpcBehavior:!1,activePDTabElPath:".facets-list > .facet.interactive.tab-behavior.selected",activePDTabName:null,activePDTabNameWidgetPref:"LCS_NRF_LastPDActiveTabName",reuseReferenceEnabled:!1,reuseReferenceEnabledExpr:"ReuseReferenceEnabled",init:function(){this.physicalIds=[],this.onCompleteFnArr=[],this.resultRevisionCalculated=!1,this.everythingIsRevisionable=!1,this.commandManager=new o,this.controller=new l,this.settings=new R(widget,"ENOLCMI_AP")},executeCmd:function(e,t,i){var s=this;this._setupEventHandlers(e,i),this.context=t.context||{},this.folderId=t.targetFolderId,this.context.displayNotification=(e=>{this._displayNotification(e)});try{if(void 0!==a.getActiveFolder){var n=a.getActiveFolder();void 0!==n.id&&null!==n.id&&""!==n.id&&(this.folderId=n.id,this.securityContex=""!==n.sc&&void 0!==n.sc?n.sc:this.securityContex,require(["DS/PlatformAPI/PlatformAPI"],function(e){e.publish("FolderEditor.ActiveFolderCallBack",{id:n.id,label:n.label})}))}}catch(e){this.folderId=t.targetFolderId,this.securityContex=a.getCurrentFolderSecurityContext()}this.controller.setContext(this.context),this.settings.loadSettingsPromise().then(function(t){s.setObjects(e)})},_handleError:function(e){document.body.style.cursor="default",this.showError(e.message,e.options),this._onComplete()},_handleNotification:function(e){document.body.style.cursor="default",this.showNotification(e.message,e.options),this._onComplete()},_storePickdialogTab:function(){this.activePDTabName&&widget.setValue(this.activePDTabNameWidgetPref,this.activePDTabName)},_verifySources:function(e,t){if(e.length<1){var i=n.replace(n.get("noReviseOfName"),{dispName:t[0].displayName?t[0].displayName:t[0].name}),s={title:i,subtitle:n.get("noSourcesAvailable"),submessage:n.get("sourceTypes")};this.showError(i,s),this._onComplete()}else this.sources=e,this.dispatchEvent("onReady")},_setupEventHandlers:function(e,t){this.addEvent("onReady",function(){this._showCommandUI(e)},this),this.addEvent("onComplete",function(){this._storePickdialogTab(),this.onCompleteFnArr.forEach(function(e){e.apply(this)},this),t()},this),this.controller.addEvent("onDuplicatesRetrieved",function(){document.body.style.cursor="default";var t=this.controller.model.getDuplicates(this.physicalIds[0],this.irpcBehavior);this._verifySources(t,e)},this),this.controller.addEvent("onSourcesRetrieved",function(){document.body.style.cursor="default";var t=this.controller.model.getSources(this.physicalIds[0]);this._verifySources(t,e)},this),this.controller.addEvent("onError",this._handleError.bind(this)),this.controller.addEvent("onNotification",this._handleNotification.bind(this)),this.controller.addEvent("onReviseSuccess",function(e){document.body.style.cursor="default",this.commandDialog&&this.commandDialog.unmaskBody(),this.showNotification(n.reviseSuccessful,{type:"success"}),this._onComplete()},this)},_showCommandUI:function(e){var t=this,i="";if(Array.isArray(e)&&e.length&&e[0].name){i=" - "+e[0].name+(e[0].revision?" "+e[0].revision:"")}this.refReviseFromTree=new u([this.physicalIds[0]],this.tenant,this.context,this.filterDuplicateInstances),this.refReviseFromTree.addEvent("onTreeCreated",this._handleRefTreeCreated.bind(this)),this.refReviseFromTree.addEvent("onError",this._handleError.bind(this)),this.resReviseFromTree=new u([this.physicalIds[0]],this.tenant,this.context,this.filterDuplicateInstances);var r=this._renderDialogContent(e[0].displayName),o=new p,a=o.create(r,{title:n.newRevisionFrom+i,OKBtnText:n.NRFOK,imageUrl:e[0].imageUrl||"",resizable:!0,powerMaximize:!0,closeButton:!0,settingsButton:!0,settingsCallback:function(){t.showSettings()},onOk:function(){this.createNewRevision()},onClose:function(){this._onComplete()},enableCmd:function(){return this.resultRevisionCalculated&&this.everythingIsRevisionable},events:{onResizeFloating:function(){}}},this);o.setPowermaximizeVisibility(!1),o.addEvent("widget-maxmized-changed",function(e){e&&o.maximize(!0)}),this.commandDialog=o,a.inject(widget.body),a.setNewSize({width:900,height:500}),o.isWidgetMaximized()&&o.maximize(!0),this.onCompleteFnArr.push(function(){o.destroy()}),this.addEvent("ResultRevisionCalculated",function(){this.createResultTree(),t.everythingIsRevisionable=this.verifyEverythingIsRevisionable(),o.updateUI(),this.treeSyncMgr=new d,this.treeSyncMgr.add(this.refReviseFromTree.treeList.tree),this.treeSyncMgr.add(this.srcReviseFromTree.treeList.tree),this.resTreeSyncId=this.treeSyncMgr.add(this.resReviseFromTree.treeList.tree),this.dispatchEvent("ResultCreated")},this),this.resReviseFromTree.addEvent("onTreeReady",function(){var e=t.resPanel.elements.contentContainer;e&&s.isMasked(e)&&s.unmask(e)})},_renderDialogContent:function(e){var i=document.createElement("div");i.className="reviseFrom_popup";var s=t.createElement("div",{class:"mainDiv",styles:{height:"100%"}});return this.treesContainer=new m,this.refPanel=new g({caption:n.refStructure,addClass:"treePanel-ref ",collapseable:!0}),this.srcPanel=new g({caption:n.srcStructure,addClass:"treePanel-src ",collapseable:!0}),this.resPanel=new g({caption:n.resPreview,addClass:"treePanel-res"}),this.treesContainer.addPanel(this.refPanel),this.treesContainer.addPanel(this.srcPanel),this.treesContainer.addPanel(this.resPanel),this.treesContainer.inject(s),this.pickHiddenEl=UWA.createElement("div",{id:42,styles:{display:"none"}}),this.pickHiddenEl.inject(s),this.refReviseFromTree.openAdvancedTree(this.refPanel.elements.content,{addActionCol:!1,getChildrenInTreeOrder:!0,filter3DShapes:!0}),i.appendChild(s),i},_onComplete:function(){this.dispatchEvent("onComplete")},setObjects:function(e){var t=this;if(!e||0===e.length)throw n.noObject;if(e.length>1)throw n.multipleSelection;var i=e[0];if(i.hasOwnProperty("physicalid")&&""===i.physicalid)throw n.epmtyPhysicalId;this.physicalIds.push(i.physicalid),this.tenant=i.tenant,void 0!==this.tenant&&null!==this.tenant||(this.tenant="OnPremise"),this.commandManager.setTenant(this.tenant),this.controller.setTenant(this.tenant),r.getAllowedSemanticsPromise(this.physicalIds,this.context).then(function(e){r.isBaselineMode(i.physicalid,e)?t._handleError({message:n.objectTypeNotSupported}):i.hasOwnProperty("type")&&v.getIsKindOfPromise(t.tenant,["CATPart","CATProduct","VPMReference","SoftwareLogicalItem"],i.type).then(function(e){e?v.getIsKindOfPromise(t.tenant,["PLMReference"],i.type).then(function(e){t.irpcBehavior=e,document.body.style.cursor="wait",t.irpcBehavior?t.controller.getSources(i):t.controller.getDuplicates(i)}):t._handleError({message:n.objectTypeNotSupported})})},function(e){t._handleError({message:n.serviceError})})},_handleRefTreeCreated:function(e){1===this.sources.length?this._renderDuplicateTree(this.sources[0].id,this.srcPanel.elements.content):this._renderSelectionList(this.srcPanel.elements.content,this.pickHiddenEl);var t=this.refReviseFromTree.getAssembly(),i=[];t.nodes.forEach(function(e){i.push(e.physicalid)}),this.nextRevInfoPromise=this.controller.getNextRevisionInfo(i),this.reviseAccessInfoPromise=this.controller.getReviseAccessInfo(i)},_handleSrcTreeCreated:function(e){this.getObjectInfo()},addPhysIdsToData:function(e,t){for(var i=e.nodes,s=i.length,n=0;n<s;n++){var r=i[n];function o(e){return e.physicalid===r.physicalid}if(-1===t.findIndex(o)){var a={physicalid:r.physicalid};t.push(a)}}},getObjectInfo:function(){document.body.style.cursor="wait";var e={data:[],attributes:["physicalid","attribute[MCADInteg-ClonedFrom]","attribute[PLMReference.V_DerivedFrom]","attribute[PLMEntity.V_usage]","attribute[PLMCoreRepReference.V_isOnceInstantiable]","firstRevision","displayType","last.current","last.attribute[Title]","last.attribute[PLMEntity.V_Name]","logicalid","attribute[PLMReference.V_fromExternalID]","attribute[PLMEntity.PLM_ExternalID]","revision","attribute[XCADEmbeddedCmp.V_IsEmbeddedComponent]","type.kindof[BundleFastenerAbstract]","majorids.bestsofar.physicalid","majorids.bestsofar.revision","majorid.lastmajorid.bestsofar.physicalid","majorid.lastmajorid.bestsofar.revision"],expressions:[this.reuseReferenceEnabledExpr]};this.irpcBehavior&&(e.attributes.push("majorids.bestsofar.attribute[PLMReference.V_DerivedFrom]"),e.attributes.push("majorid.lastmajorid.bestsofar.attribute[PLMEntity.V_Name]"));var t=this.srcReviseFromTree.getAssembly();this.addPhysIdsToData(t,e.data);var i=this.refReviseFromTree.getAssembly();this.addPhysIdsToData(i,e.data);var s=this;this.controller.getObjectInfo(e,function(e){document.body.style.cursor="default",s.onCompleteGetObjectInfo(e)})},addObjectInfo:function(e,t,i,s,n){var r=t.nodes,o=new Set;r.forEach(function(e){o.add(e.physicalid)});for(var a=e.filter(function(e){return!o.has(e.physicalid)}),c=r.length,l=e.length,d=a.length,h=[],u=0;u<l;u++)for(var f=e[u],p=0;p<c;p++){var v=r[p];if(f.physicalid===v.physicalid){if(i.addClonedFrom){var m=!1,g=null,y=f["attribute[MCADInteg-ClonedFrom]"];if(y)m=!0;else{for(var R,I=f.logicalid,T=0;T<d;T++){if((D=a[T]).physicalid!=f.physicalid&&D.logicalid===I){y=D.physicalid,m=!0;break}}if(!m&&(y=f["attribute[PLMReference.V_DerivedFrom]"]))for(T=0;T<d;T++){if((D=a[T]).physicalid===y){m=!0;break}}if(!m)for(T=0;T<d;T++){var b=(D=a[T])["attribute[PLMReference.V_DerivedFrom]"];if(b&&b===f.physicalid){y=D.physicalid,m=!0;break}}if(!m){var N=f["majorids.bestsofar.physicalid"];if(N){var S=N.split("");for(T=0;T<d;T++){if((D=a[T]).physicalid!==f.physicalid){var C=D["majorids.bestsofar.attribute[PLMReference.V_DerivedFrom]"];if(C)if(C.split("").some(function(e){return S.indexOf(e)>=0})){y=D.physicalid,m=!0;break}}}}}if(!m)if(R=f["attribute[PLMReference.V_fromExternalID]"])for(T=0;T<d;T++){var F=(D=a[T])["attribute[PLMEntity.PLM_ExternalID]"];if((F+=" "+D.revision)===R){y=D.physicalid,m=!0;break}}if(!m)if(R=f["attribute[PLMReference.V_fromExternalID]"])for(T=0;T<d;T++){var D;F=(D=a[T])["attribute[PLMEntity.PLM_ExternalID]"];if(D.physicalid!=f.physicalid&&R.startsWith(F)){y=D.physicalid,m=!0;break}}}if(m&&y)g=y.split("|")[0];v.clonedFromPhysicalid=g}i.addFirstRevision&&(v.firstRevision=f.firstRevision),i.addNextRevision&&(v.nextRevision=s.getNextRev(f.physicalid)),i.addIsRevisionable&&(v.isRevisionable=n.isRevisionable(f.physicalid),v.hasReviseAccess=n.hasReviseAccess(f.physicalid),v.hasAccess=n.hasAccess(f.physicalid),v.isLatestRevision=n.isLatestRevision(f.physicalid)),i.addLatestRevTitle&&(v.latestRevTitle=f["last.attribute[Title]"],v.latestRevTitle||(v.latestRevTitle=f["last.attribute[PLMEntity.V_Name]"],v.bsfRevTitle=f["majorid.lastmajorid.bestsofar.attribute[PLMEntity.V_Name]"]),v.latestPhysicalid=f["majorid.lastmajorid.bestsofar.physicalid"],v.latestRevision=f["majorid.lastmajorid.bestsofar.revision"]);var O="TRUE"===f["attribute[PLMCoreRepReference.V_isOnceInstantiable]"];if("3DShape"===v.type){var P=f["attribute[PLMEntity.V_usage]"];P&&("3DPart"===P?(O&&(v.onceInstantiable3DShape=!0),v.followsParent=!0):"3DShape"===P&&O?(v.followsParent=!0,v.onceInstantiable3DShape=!0):v.followsParent=!1)}var w="TRUE"===f["attribute[XCADEmbeddedCmp.V_IsEmbeddedComponent]"],A="TRUE"===f["type.kindof[BundleFastenerAbstract]"];(O||w||A)&&(v.followsParent=!0),v.onceInstantiable3DShape&&h.push(v.nodeid),v.displayType=f.displayType;break}}return{shapeNodes:h}},getNodeFromPhysicalId:function(e,t){for(var i=e.nodes,s=i.length,n=0;n<s;n++){var r=i[n];if(r.physicalid===t)return r}return null},verifyRootIsRevisionable:function(e){var t=f.getRootOccurenceId(e),i=f.getNodeIdFromOccurenceId(e,t),s=f.getNode(e,i);return!(!s.isRevisionable||!s.hasReviseAccess||s.followsParent)||(s.followsParent?this.showError(n.selectParentToPerformOperation):this.showRootNotRevisionableErrMsg(s),!1)},showRootNotRevisionableErrMsg:function(e){var t,i="<b>"+e.Title+"</b>",s=null;if(e.isRevisionable)if(e.hasAccess||e.isLatestRevision){t="noReviseAccess",s={title:n.replace(n.get("noReviseOfType"),{dispType:e.displayType}),subtitle:n.get("verifyCredentials"),submessage:n.get("lackingReviseAccessRole")}}else{t="noReviseAccess",s={title:n.replace(n.get("noReviseOfName"),{dispName:e.Title}),subtitle:n.replace(n.get("noPermissionToLatestRevision"),{dispName:e.Title})}}else t="cannotBeRevised";var r=n.replace(n.get(t),{dispName:i});this.showError(r,s)},verifyEverythingIsRevisionable:function(){if(!this.settings.getShowWarningNoRevise())return!0;var e=this.refReviseFromTree.getAssembly(),t=[];return e.nodes.forEach(function(e){e.isRevisionable&&e.hasReviseAccess||e.followsParent||e.isExcluded||"0"===e.physicalid||t.push(e)}),0==t.length||(this.launchReportingPanel(t),!1)},verifyNoMultipleDuplicates:function(e,t){for(var i={},s=e.nodes,n=s.length,r=0;r<n;r++){var o=s[r];if(o.clonedFromPhysicalid){var a=i[o.clonedFromPhysicalid];if(a){if(o.physicalid!==a){var c=this.getNodeFromPhysicalId(t,o.clonedFromPhysicalid),l=this.getNodeFromPhysicalId(e,a);return this.showMultiDupeErrMsg(c,o,l),!1}}else i[o.clonedFromPhysicalid]=o.physicalid}}return!0},showMultiDupeErrMsg:function(e,t,i){var s=e.Title+" "+e.revision,r=t.Title+" "+t.revision,o=i.Title+" "+i.revision,a="<b>"+s+"</b>",c=n.replace(n.get("multipleDuplicates"),{dupeSource:a});c=(c=(c+="<br>")+"&nbsp;&nbsp;<b>"+r+"</b><br>")+"&nbsp;&nbsp;<b>"+o+"</b><br>",c+=n.pleaseUpdateStruct,this.showError(c)},onCompleteGetObjectInfo:function(e){var t=this,i=e.expressions;i&&Array.isArray(i)&&i.forEach(function(e){e.name===t.reuseReferenceEnabledExpr&&(t.reuseReferenceEnabled=e.value)}),UWA.Promise.all([this.nextRevInfoPromise,this.reviseAccessInfoPromise]).then(i=>{var s=i[0],n=i[1];s.getNextRev=function(e){return this.addRequests.find(t=>t.copyId===e).code},n.isLatestRevision=function(e){return this.results.find(t=>t.physicalid===e)["majorid.lastmajorid.bestsofar.physicalid"]===e},n.hasAccess=function(e){return"#DENIED!"!==this.results.find(t=>t.physicalid===e)["majorid.lastmajorid.bestsofar.current.access[majorrevise]"]},n.hasReviseAccess=function(e){return"TRUE"===this.results.find(t=>t.physicalid===e)["majorid.lastmajorid.bestsofar.current.access[majorrevise]"]},n.isRevisionable=function(e){var t=this.results.find(t=>t.physicalid===e),i=t["last.current.majorrevisionable"];return void 0===i&&(i=t["last.current.revisionable"]),"TRUE"===i};var r=e.results,o=t.srcReviseFromTree.getAssembly(),a=t.addObjectInfo(r,o,{addClonedFrom:!0,addFirstRevision:!0,addNextRevision:!1,addIsRevisionable:!1,addLatestRevTitle:!1},s,n);t.srcReviseFromTree.shapeNodes=a.shapeNodes;var c=t.refReviseFromTree.getAssembly();a=t.addObjectInfo(r,c,{addClonedFrom:!1,addFirstRevision:!1,addNextRevision:!0,addIsRevisionable:!0,addLatestRevTitle:!0},s,n),t.refReviseFromTree.shapeNodes=a.shapeNodes;var l=f.getRootOccurenceId(o),d=f.getNodeIdFromOccurenceId(o,l),h=f.getNode(o,d);if(!h.clonedFromPhysicalid){var u=f.getRootOccurenceId(c),p=f.getNodeIdFromOccurenceId(c,u),v=f.getNode(c,p);h.clonedFromPhysicalid=v.physicalid}t.verifyRootIsRevisionable(c)?!0===t.verifyNoMultipleDuplicates(o,c)?(t.resultRevisionCalculated=!0,t.dispatchEvent("ResultRevisionCalculated")):t._onComplete():t._onComplete()})},createResultTree:function(){var e=this,t=this.refReviseFromTree.getAssembly(),i=this.srcReviseFromTree.getAssembly(),s={uicontroltype:"piecewisecgrviewer",version:2,rootoccurrence:0,nodes:[],occurrences:[],occurrencerelationships:[]},n=function(e){return 1e3*Math.ceil(e/1e3)},r={resOccId:0,resNodeId:0,refOccId:n(t.occurrences.length),refNodeId:n(t.nodes.length),srcOccId:n(i.occurrences.length),srcNodeId:n(i.nodes.length)},o=f.getRootOccurenceId(t),a=f.getRootOccurenceId(i);this.newTreeResult=this.addNode(s,r,t,o,i,a,null,null,null,1),this.srcReviseFromTree.sortOccRelsOnOrder(),this.refReviseFromTree.createAdvancedTree({addActionCol:!1,getChildrenInTreeOrder:!0}),this.refReviseFromTree.hideNodes(this.refReviseFromTree.shapeNodes),this.srcReviseFromTree.createAdvancedTree({addActionCol:!0,getChildrenInTreeOrder:!1}),this.srcReviseFromTree.hideNodes(this.srcReviseFromTree.shapeNodes),this.resReviseFromTree.openAdvancedTree(this.resPanel.elements.content,{addActionCol:!1,getChildrenInTreeOrder:!1},s),this.resReviseFromTree.hideNodes(this.newTreeResult.shapeNodes),this.srcReviseFromTree.addEvent("onDropdownListChange",function(t){e.resReviseFromTree.storeAllCollapsed();var i=e.refReviseFromTree.getAssemblyHelper(),s=e.srcReviseFromTree.getAssemblyHelper(),n=e.resReviseFromTree.getAssemblyHelper(),r=e.settings.getUseSourceTitle(),o=new Set;t.selNodes.forEach(function(a){var c=a.options.occId,l=s.getOccurence(c),d=n.getNodeIdFromOccurenceId(l.resOccId),h=n.getNode(d),u=l.actionInfo.insertnew,f=a._options.children,p=!!(f&&f.length>0)&&!f[0]._isHidden,v=!u&&0===t.selIdx,m=p&&!u&&1===t.selIdx,g=u&&1===t.selIdx,R=!u&&(p&&2===t.selIdx||!p&&1===t.selIdx)||u&&0===t.selIdx,I=!(v||m||g||R);v||m?(h.revision=h.nextRevision,h.Title=h.latestRevTitle):R?(h.revision=h.currentRevision,u?l.canBeInsertedNew=!0:h.Title=r?h.latestRevTitle:h.currentRevTitle):I&&!u?(h.revision=h.refRevision,h.Title=h.refTitle):g&&(h.revision=h.firstRevision,l.canBeInsertedNew=!1);var T=v?y.ActionOption.Revise:m?y.ActionOption.ReviseTree:R?y.ActionOption.Reuse:I?y.ActionOption.ReuseReference:g?y.ActionOption.InsertNew:null;e.setChildrenToAction(T,i,s,n,c,o),v&&e.srcReviseFromTree.setTreeNodeChildrenToAction(a,t.selOp,t.prevSelOp)}),e.resReviseFromTree.createAdvancedTree({addActionCol:!1,getChildrenInTreeOrder:!1}),e.resReviseFromTree.hideNodes(e.newTreeResult.shapeNodes),e.resReviseFromTree.restoreAllCollapsed(),e.treeSyncMgr.remove(e.resTreeSyncId),e.resTreeSyncId=e.treeSyncMgr.add(e.resReviseFromTree.treeList.tree,!0),e.dispatchEvent("DropDownRebuildComplete")})},updateInsertNewResNodeForReviseOrReuse:function(e,t,i){var s=f.getNodeIdFromOccurenceId(t,i),n=f.getNode(t,s);this.irpcBehavior||e?(delete n.revision,delete n.Title,delete n.type_icon_url):(n.revision="",n.Title="",n.type_icon_url="");for(var r=f.getChildOccurenceIds(t,i,this.filterDuplicateInstances),o=r.length,a=0;a<o;a++){var c=r[a];this.updateInsertNewResNodeForReviseOrReuse(e,t,c)}},updateExcludeResNodeForReviseOrReuse:function(e,t,i,s){if(!this.irpcBehavior){var n=i.getNodeIdFromOccurenceId(s),r=i.getNode(n),o=i.getOccurence(s),a=t.getNodeIdFromOccurenceId(o.refOccId),c=t.getNode(a);e?(delete r.revision,delete r.Title,delete r.type_icon_url):(r.revision=c.revision,r.Title=c.Title,r.type_icon_url=c.attributes.type_icon_url);for(var l=i.getChildOccurenceIds(s,this.filterDuplicateInstances),d=l.length,h=0;h<d;h++){var u=l[h];r=i.getNode(n);this.updateExcludeResNodeForReviseOrReuse(e,t,i,u)}}},setChildrenToAction:function(e,t,i,s,n,r){for(var o=this,a=o.settings.getUseSourceTitle(),c=e===y.ActionOption.Revise,l=e===y.ActionOption.ReviseTree,d=e===y.ActionOption.Reuse,h=e===y.ActionOption.ReuseReference,u=e===y.ActionOption.InsertNew,f=i.getNodeIdFromOccurenceId(n),p=i.getChildOccurenceIds(n,this.filterDuplicateInstances),v=p.length,m=e,g=function(e){var p=e.options.occId,v=i.getNodeIdFromOccurenceId(p),g=i.getNode(v),R=i.getOccurence(p);if(r.add(p),R.actionInfo){var I=i.getParentOccurence(p);if(R.actionInfo.exclude)o.updateExcludeResNodeForReviseOrReuse(c,t,s,R.resOccId);else{var T,b=s.getNodeIdFromOccurenceId(R.resOccId),N=s.getNode(b),S=!1,C=d||h||l;if((d||h)&&R.actionInfo.revise)R.actionInfo.revise=!1,d?(N.revision=N.currentRevision,N.Title=a?N.latestRevTitle:N.currentRevTitle):h&&(N.revision=N.refRevision,N.Title=N.refTitle),R.canBeRevised=!0,g.followsParent?(R.actionInfo.reuse=d,R.actionInfo.reuseref=h):d?R.actionInfo.reuseref=!1:h&&(R.actionInfo.reuseref=!0,R.actionInfo.reuse=!1),I.nodeid!==f&&(d?I.actionInfo.disableReuseref=!0:h&&(I.actionInfo.disableReuse=!0)),S=!0;else if((d||h)&&R.actionInfo.insertnew)N.revision=N.currentRevision,N.currentRevTitle=N.srcTitle,R.actionInfo.insertnew=!1,R.canBeInsertedNew=!0,g.followsParent?(R.actionInfo.reuse=d,R.actionInfo.reuseref=h):d?R.actionInfo.reuseref=!1:h&&(R.actionInfo.reuse=!1,R.actionInfo.reuseref=!0,N.revision="",N.Title="",N.type_icon_url=""),S=!0;else if(d||h)d?(N.revision=N.currentRevision?N.currentRevision:N.revision,N.Title=a?N.latestRevTitle:N.currentRevTitle,N.type_icon_url=N.attributes.type_icon_url):h&&(R.canBeInsertedNew?(R.actionInfo.reuseref=!0,N.revision="",N.Title="",N.type_icon_url=""):(N.revision=N.refRevision,N.Title=N.refTitle)),R.canBeReused=R.actionInfo.reuse,R.actionInfo.reuse=d,R.actionInfo.reuseref=h,I.nodeid!==f&&I.actionInfo.revise&&(d?(I.actionInfo.disableReuseref=!0,I.actionInfo.disableReuse=!1):h&&(I.actionInfo.disableReuseref=!1,I.actionInfo.disableReuse=!0)),S=!0;else if(u&&!R.actionInfo.insertnew&&R.canBeInsertedNew)R.actionInfo.insertnew=!0,R.canBeInsertedNew=!0,R.actionInfo.reuse=!0,R.actionInfo.reuseref=!1,N.revision=N.currentRevision,N.Title=N.currentRevTitle,N.type_icon_url=N.attributes.type_icon_url,C=!0,m=y.ActionOption.InsertNew,g.followsParent&&(R.actionInfo.reuse=!1),S=!0;else if(!c&&!u||R.actionInfo.revise)l&&(R.canBeRevised?(R.actionInfo.revise=!0,R.actionInfo.reuse=!0,R.actionInfo.reuseref=0===I.occurrenceid?R.actionInfo.reuseref:I.actionInfo.reuseref,N.revision=N.nextRevision,N.Title=N.latestRevTitle,g.followsParent&&(R.actionInfo.reuse=!1,R.actionInfo.reuseref=!1)):R.actionInfo.insertnew?R.canBeInsertedNew?C=!1:(R.actionInfo.reuse&&e.dropdownList&&(e.dropdownList.action.selectedIndex=1)&&(e.dropdownListSelectedIndex.action=1),R.canBeInsertedNew=!1,C=!0):R.canBeInsertedNew?(R.actionInfo.insertnew=!0,R.actionInfo.reuse=!0,N.revision=N.currentRevision,N.Title=N.currentRevTitle,N.type_icon_url=N.attributes.type_icon_url,R.actionInfo.reuseref?(e.dropdownList&&(e.dropdownList.action.selectedIndex=1)&&(e.dropdownListSelectedIndex.action=1),R.canBeInsertedNew=!1,R.actionInfo.reuseref=!1):C=!1):R.canBeReused&&(R.actionInfo.insertnew=!1,R.actionInfo.reuse=!0,R.actionInfo.reuseref=!1,N.revision=N.currentRevision,N.Title=a?N.latestRevTitle:N.currentRevTitle),S=!0);else{if(R.canBeRevised||R.canBeInsertedNew||R.canBeReused)(T=e.options.nodeId,o.srcReviseFromTree.getInstances(T).every(function(e){var t=e.getParent();if(t.options.occId===n||t.options.nodeId===f)return!0;var i={occId:t.options.occId},s=t.dropdownListSelectedIndex,r=s?s.action:o.srcReviseFromTree.getDefSelIndex(i);return o.srcReviseFromTree.getOptions(i).options[r]===y.ActionOption.Revise}))&&(R.canBeRevised?(R.actionInfo.revise=!0,R.actionInfo.reuse=!0,R.actionInfo.reuseref=I.actionInfo.reuseref):R.canBeInsertedNew?(C=u||c&&R.actionInfo.reuseref,R.actionInfo.insertnew=!0,R.actionInfo.reuse=!0,R.actionInfo.reuseref=!1,N.revision=N.currentRevision,N.Title=N.currentRevTitle,N.type_icon_url=N.attributes.type_icon_url,m=y.ActionOption.InsertNew):R.canBeReused&&(R.actionInfo.insertnew=!1,R.actionInfo.reuse=!0,R.actionInfo.reuseref=!1,N.revision=N.currentRevision,N.Title=a?N.latestRevTitle:N.currentRevTitle,C=!0,m=y.ActionOption.Reuse),g.followsParent&&(R.actionInfo.reuse=!1,R.actionInfo.reuseref=!1,N.revision=N.nextRevision,N.Title=N.latestRevTitle),I.nodeid!==f&&I.actionInfo.revise&&(I.actionInfo.disableReuseref=!1,I.actionInfo.disableReuse=!1),S=!0)}S&&(C||g.followsParent)&&o.setChildrenToAction(m,t,i,s,p,r)}}},R=0;R<v;R++){var I=p[R];if(!r.has(I)){var T=i.getNodeIdFromOccurenceId(I);this.srcReviseFromTree.getInstances(T).forEach(g)}}},addNode:function(e,t,i,s,n,r,o,a,c,l,d){var h=this.settings.getUseSourceTitle(),u=null,p=null,v={revise:!1,reuse:!1,insertnew:!1,exclude:!1,reuseref:!1},m=d||{shapeNodes:[]};if(null===r){v.exclude=!0;var g={nodeid:t.srcNodeId,physicalid:"0",Title:"",mod:"",type:"",cgrurl:"",attributes:{type_icon_url:""}};n.nodes.push(g),t.srcNodeId=t.srcNodeId+1;var R={occurrenceid:t.srcOccId,nodeid:g.nodeid,actionInfo:v};if(r=t.srcOccId,t.srcOccId=t.srcOccId+1,n.occurrences.push(R),null!==c){var I={parent:c,child:R.occurrenceid,order:l};n.occurrencerelationships.push(I)}null!==a&&(R.refOccRelId=f.getRelationshipId(i,a,s));var T={nodeid:t.resNodeId,physicalid:"0",Title:"",mod:"",type:"",cgrurl:"",attributes:{type_icon_url:""}};if(e.nodes.push(T),t.resNodeId=t.resNodeId+1,(p={occurrenceid:t.resOccId,nodeid:T.nodeid}).refOccId=s,R.resOccId=t.resOccId,u=t.resOccId,t.resOccId=t.resOccId+1,e.occurrences.push(p),null!==o){var b={parent:o,child:p.occurrenceid,order:l};e.occurrencerelationships.push(b)}var N=f.getNodeIdFromOccurenceId(i,s);(S=f.getNode(i,N))&&!0===S.onceInstantiable3DShape&&(m.shapeNodes.push(T.nodeid),this.srcReviseFromTree.shapeNodes.push(g.nodeid)),S&&!UWA.is(S.isExcluded)&&(S.isExcluded=!0)}else{var S;N=f.getNodeIdFromOccurenceId(i,s);(S=f.getNode(i,N)).isExcluded=!1;var C=Object.create(S);C.nodeid=t.resNodeId,e.nodes.push(C);var F={occurrenceid:u=t.resOccId,nodeid:C.nodeid};if(F.refOccId=s,e.occurrences.push(F),t.resNodeId=t.resNodeId+1,t.resOccId=t.resOccId+1,null!==o){var D={parent:o,child:F.occurrenceid,order:l};e.occurrencerelationships.push(D)}var O=f.getNodeIdFromOccurenceId(n,r),P=f.getNode(n,O),w=f.getOccurence(n,r),A=!1,_=!1,x=!1;if(null!==a){var E=f.getNodeIdFromOccurenceId(i,a),L=f.getNode(i,E);L.followsParent&&(S.followsParent=L.followsParent);var W=f.getOccurence(n,c);A=W.actionInfo.reuse&&!W.actionInfo.revise,_=W.actionInfo.reuse&&W.actionInfo.revise&&W.actionInfo.defAction===y.ActionOption.Reuse,x=W.canBeRevised}if(P.followsParent=S.followsParent,P.onceInstantiable3DShape=S.onceInstantiable3DShape,C.currentRevision=this.irpcBehavior?P.revision:C.revision,C.nextRevision=S.nextRevision,C.currentRevTitle=this.irpcBehavior&&!h?P.Title:C.Title,C.latestRevTitle=h?P.Title:S.latestRevTitle,C.refTitle=S.Title,C.refLatestRevTitle=S.latestRevTitle,C.refRevision=S.revision,C.srcTitle=P.Title,C.srcRevision=P.revision,!S.isRevisionable||!S.hasReviseAccess||A&&!x||!this.irpcBehavior&&S.physicalid===P.physicalid)v.reuse=!0,this.irpcBehavior&&(C.revision=P.revision,C.Title=P.Title);else{w.canBeRevised=!0,_||A||(v.revise=!0,S.physicalid===P.physicalid&&(v.defAction=y.ActionOption.Reuse));var M=f.getRootOccurenceId(n);r===M||S.followsParent||(v.reuse=!0),!this.reuseReferenceEnabled||_||A||r===M||S.followsParent||(v.reuseref=!0),!0===v.revise&&v.defAction!==y.ActionOption.Reuse&&(C.revision=C.nextRevision,C.Title=C.latestRevTitle)}w.actionInfo=v,w.resOccId=u,null!==c&&(w.relId=f.getRelationshipId(n,c,r)),null!==a&&(w.refOccRelId=f.getRelationshipId(i,a,s))}var k=f.getChildOccurenceIdsTreeOrder(i,s,this.filterDuplicateInstances),U=k.length,j=[];null!==n&&null!==r&&(j=f.getChildOccurenceIdsTreeOrder(n,r,this.filterDuplicateInstances));for(var B=j.length,H=[],V=0;V<U;V++){for(var z=k[V],q=f.getNodeIdFromOccurenceId(i,z),G=f.getNode(i,q),J=null,K=0;K<B;K++){var X=j[K];if(-1===H.indexOf(X)){var Q=f.getNodeIdFromOccurenceId(n,X),Y=f.getNode(n,Q);if(Y.clonedFromPhysicalid&&Y.clonedFromPhysicalid===G.physicalid||Y.physicalid===G.physicalid){J=X,H.push(J);break}}}var Z=V+1;this.addNode(e,t,i,z,n,J,u,s,r,Z,m),f.setOccurenceRelationshipOrder(i,s,z,Z),null!==J&&(f.setOccurenceRelationshipOrder(n,r,J,Z),this.filterDuplicateInstances&&this.updateMatchingChildOccurrenceData(n,r,J,Z))}var $=H.length;if($<B)for(var ee=U,te=0;te<B;te++){for(var ie=j[te],se=!1,ne=0;ne<$;ne++){if(ie===H[ne]){se=!0;break}}se||this.addNodeForInsertNew(i,n,e,t,r,ie,s,u,ee,m)}return C&&C.onceInstantiable3DShape&&m.shapeNodes.push(C.nodeid),m},updateMatchingChildOccurrenceData:function(e,t,i,s){var n=f.getOccurence(e,i);f.getChildOccurenceIds(e,t,!1).forEach(function(r){if(r!==i){var o=f.getOccurence(e,r);o.nodeid===n.nodeid&&(o.actionInfo=n.actionInfo,o.canBeRevised=n.canBeRevised,o.resOccId=n.resOccId,f.setOccurenceRelationshipOrder(e,t,r,s))}})},addNodeForInsertNew:function(e,t,i,s,n,r,o,a,c,l){var d=f.getNodeIdFromOccurenceId(t,r),h=f.getNode(t,d),u={revise:!1,reuse:!1,insertnew:!0,exclude:!1,reuseref:!1};this.irpcBehavior&&(h.followsParent||(u.reuse=!0),u.defAction=y.ActionOption.InsertNew);var p=f.getOccurence(t,r);p.actionInfo=u,null!==n&&(p.relId=f.getRelationshipId(t,n,r)),c+=1;var v={nodeid:s.refNodeId,physicalid:"0",Title:"",mod:"",type:"",cgrurl:"",attributes:{type_icon_url:""}};e.nodes.push(v),s.refNodeId=s.refNodeId+1;var m={occurrenceid:s.refOccId,nodeid:v.nodeid};if(s.refOccId=s.refOccId+1,e.occurrences.push(m),null!==o){var g={parent:o,child:m.occurrenceid,order:c};e.occurrencerelationships.push(g)}var R=Object.create(h);R.srcTitle=h.Title,R.srcRevision=h.revision;var I=null,T=!1;if(h.clonedFromPhysicalid&&h.clonedFromPhysicalid.length>0&&(I=f.getNodeFromPhysicalId(e,h.clonedFromPhysicalid)),I?T=!0:I=f.getNodeFromPhysicalId(e,h.physicalid),this.irpcBehavior)if(I){R.currentRevision=T?h.revision:I.revision,R.nextRevision=I.nextRevision,R.currentRevTitle=T?h.Title:I.Title,R.latestRevTitle=I.latestRevTitle,R.refTitle=I.Title,R.refLatestRevTitle=I.latestRevTitle,R.refRevision=I.revision;var b=f.getOccurence(t,n),N=b.actionInfo.reuse&&b.actionInfo.defAction===y.ActionOption.Reuse;T?(R.revision=I.nextRevision,R.Title=I.latestRevTitle,p.insertedInstance=!0,p.actionInfo.insertnew=!1,p.actionInfo.revise=!0,p.actionInfo.reuse=!I.followsParent,p.actionInfo.reuseref=!(I.followsParent||!this.reuseReferenceEnabled)):p.actionInfo.reuse&&(R.revision=I.revision,R.Title=I.Title,N&&(p.actionInfo.insertnew=!1,p.canBeInsertedNew=!0),p.actionInfo.defAction=y.ActionOption.Reuse)}else R.currentRevision=R.revision,R.firstRevision=h.firstRevision,R.revision=R.firstRevision;R.nodeid=s.resNodeId,i.nodes.push(R);var S={occurrenceid:s.resOccId,nodeid:R.nodeid};if(S.refOccId=m.occurrenceid,i.occurrences.push(S),p.resOccId=s.resOccId,s.resNodeId=s.resNodeId+1,s.resOccId=s.resOccId+1,null!==a){var C={parent:a,child:S.occurrenceid,order:c};i.occurrencerelationships.push(C)}h.onceInstantiable3DShape&&(R.onceInstantiable3DShape=v.onceInstantiable3DShape=h.onceInstantiable3DShape,l.shapeNodes.push(R.nodeid),this.refReviseFromTree.shapeNodes.push(v.nodeid)),f.setOccurenceRelationshipOrder(t,n,r,c),this.filterDuplicateInstances&&this.updateMatchingChildOccurrenceData(t,n,r,c);for(var F=f.getChildOccurenceIdsTreeOrder(t,r,this.filterDuplicateInstances),D=F.length,O=0;O<D;O++){var P=F[O];this.addNodeForInsertNew(e,t,i,s,r,P,m.occurrenceid,S.occurrenceid,c,l)}},_renderDuplicateTree:function(e,t){this.srcReviseFromTree=new u([e],this.tenant,this.context,this.filterDuplicateInstances),this.srcReviseFromTree.addEvent("onTreeCreated",this._handleSrcTreeCreated.bind(this)),this.srcReviseFromTree.openAdvancedTree(t,{addActionCol:!0,getChildrenInTreeOrder:!0,filter3DShapes:!0})},_expandSourceContainer:function(){this.resPanel.hide(),this.refPanel.collapse(),this.refPanel.setUICollapseable(!1),this.srcPanel.setUICollapseable(!1),this.srcPanel.maximize()},_restoreSourceContainer:function(){this.resPanel.show(),this.refPanel.expand(),this.refPanel.setUICollapseable(!0),this.srcPanel.setUICollapseable(!0),this.srcPanel.restore()},_renderSelectionList:function(e,t){var i=this,s=null;this._expandSourceContainer();var r=a.get3DSpaceBaseUrl(i.tenant);document.body.style.cursor="wait";require(["DS/CompareWidget/PickDialog","i18n!DS/CompareWidget/assets/nls/CompareWidget"],function(o,a){var c=a.noRevision,l=a.noAlternateDesign;a.noRevision=n.noRevisions,a.noAlternateDesign=n.noDuplicates,document.body.style.cursor="default",s=new o(e,t,r,"passport",!i.irpcBehavior),i.onCompleteFnArr.push(function(){a.noRevision=c,a.noAlternateDesign=l});var d=widget.getValue(i.activePDTabNameWidgetPref);if(d||(d="historyGraphFacet"),null===i.pickDialog){var h={physicalid:i.physicalIds[0]};s.load(h,function(t){var s=e.getElement(i.activePDTabElPath);s&&(i.activePDTabName=s.dataset.name),i._restoreSourceContainer(),i._renderDuplicateTree(t.physicalid,e)},d,!i.irpcBehavior,i.irpcBehavior?"all":"direct",i.irpcBehavior?"all":"derivedFrom",i.context,i.tenant,!0,!0),i.pickDialog=s}},function(e){document.body.style.cursor="default",i.showError(n.commandNotSupported),i._onComplete()})},clone:function(e){return JSON.parse(JSON.stringify(e))},addRelationsAndAppendInstances:function(e,t,i,s){i.sort(),s.sort();for(var n=Math.max(i.length,s.length),r=0;r<n;++r){var o=t;r>0&&(o=this.clone(t),e.push(o)),o.rel_physicalid=i.length>r?i[r]:null,o.rel_physicalid_dup=s.length>r?s[r]:null}},attachRelationships:function(e){for(var t=e.length,i=0;i<t;++i){var s=f.getNodeFromPhysicalId(this.refReviseFromTree.assembly,e[i].physicalid),n=f.getNodeFromPhysicalId(this.srcReviseFromTree.assembly,e[i].physicalid_dup);if(e[i].hasOwnProperty("children"))for(var r=e[i].children.length,o=0;o<r;++o){var a=f.getNodeFromPhysicalId(this.refReviseFromTree.assembly,e[i].children[o].physicalid),c=f.getNodeFromPhysicalId(this.srcReviseFromTree.assembly,e[i].children[o].physicalid_dup),l=[],d=[];null!==s&&null!==a&&(l=f.getRelationships(this.refReviseFromTree.assembly,s.nodeid,a.nodeid)),null!==n&&null!==c&&(d=f.getRelationships(this.srcReviseFromTree.assembly,n.nodeid,c.nodeid)),this.addRelationsAndAppendInstances(e[i].children,e[i].children[o],l,d)}}},updateTitleInResultAssembly:function(){s.mask(this.resPanel.elements.contentContainer);var e=this.resReviseFromTree.getAssembly();this.resReviseFromTree.storeAllCollapsed();var t=this.settings.getUseSourceTitle();e.nodes.forEach(function(e){if(e.Title&&e.currentRevTitle&&e.latestRevTitle&&e.Title.length>0){var i=e.Title==e.latestRevTitle,s=e.Title==e.refTitle,n=!t&&i&&e.currentRevision==e.revision,r=s&&e.revision==e.refRevision,o=e.currentRevTitle;e.currentRevTitle=e.latestRevTitle,e.latestRevTitle=o,r||(e.Title=n?e.currentRevTitle:e.latestRevTitle)}}),this.resReviseFromTree.createAdvancedTree({addActionCol:!1,getChildrenInTreeOrder:!1}),this.resReviseFromTree.hideNodes(this.newTreeResult.shapeNodes),this.resReviseFromTree.restoreAllCollapsed(),this.treeSyncMgr.remove(this.resTreeSyncId),this.resTreeSyncId=this.treeSyncMgr.add(this.resReviseFromTree.treeList.tree,!0)},createNewRevision:function(){var e={};e.data=this.srcReviseFromTree.getNewRevFromData(!this.filterDuplicateInstances,this.irpcBehavior,this.settings.getUseSourceTitle()),e.folderid=this.folderId,this.filterDuplicateInstances&&this.attachRelationships(e.data[0].treeData),document.body.style.cursor="wait",this.commandDialog&&this.commandDialog.maskBody(n.revisingText),this.controller.createNewRevisionFrom(e)},showNotification:function(e,t){if("function"==typeof this.context.displayNotification){var i={eventID:"string"==typeof t.type?t.type:"primary",msg:e,sticky:t.sticky||!1};this.context.displayNotification(i)}else alert(e)},showError:function(e,t){if(t=t||{},"function"==typeof this.context.displayNotification){var i={eventID:"error",msg:t.title||t.subtitle?t.submessage:e,title:t.title,subtitle:t.subtitle,sticky:t.sticky||!1};this.context.displayNotification(i)}else alert(e)},_displayNotification:function(e){c.displayNotification(e)},showSettings:function(e){var t=this,i=this.settings.getUseSourceTitle(),s=this.settings.getShowWarningNoRevise();this.settings.showPreferencesDlg({onOk:function(e){t.resTreeSyncId&&(e.getUseSourceTitle()!=i&&t.updateTitleInResultAssembly(),s!=e.getShowWarningNoRevise()&&(t.everythingIsRevisionable=t.verifyEverythingIsRevisionable(),t.commandDialog&&t.commandDialog.updateUI()))},onShow:e&&e.onShow?e.onShow:null})},launchReportingPanel:function(e){var t=[];e.forEach(function(e){var i=[];i.push(e.latestPhysicalid?e.latestPhysicalid:e.physicalid),i.push(n.deleteFailedShort),i.push("Failed"),i.push(e.bsfRevTitle?e.bsfRevTitle:e.Title),i.push(e.displayType?e.displayType:e.type),i.push(e.latestRevision?e.latestRevision:e.revision);var s,r="";e.attributes&&e.attributes.locker&&(r=e.attributes.locker),i.push(r),s=e.isRevisionable?"noReviseAccess":"cannotBeRevised";var o=n.replace(n.get(s),{dispName:e.latestRevTitle?e.latestRevTitle:e.Title});i.push(o),t.push(i)});var i=[{text:"ID",dataIndex:"ID",isHidden:!0},{text:"StatusToolTipColumn",dataIndex:"statusTooltip",isHidden:!0,tooltipColumn:"Status"},{text:n.status,dataIndex:"Status",typeRepresentation:"icon"},{text:n.title,dataIndex:"Title"},{text:n.type,dataIndex:"Type"},{text:n.revision,dataIndex:"Revision"},{text:r.getAttributeDisplayName("locker"),dataIndex:"Locker"},{text:n.message,dataIndex:"Message"}];I.launchReportingPanel(t,i,null)}})});