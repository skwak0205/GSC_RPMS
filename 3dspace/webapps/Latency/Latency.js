define("DS/Latency/TestReportFormatter",["UWA/Core","UWA/String","i18n!DS/Latency/assets/nls/latency"],function(t,e,n){"use strict";return{formatFile:function(o){var r=t.Utils.Client,a=o.testResults,i=o.date||new Date,s=o.buildDeploy,l=o.geolocation,c=t.Utils.Client.getSize(),u="----"+Array(n.configurationFile.length+1).join("-");return"\t\t\t"+u+"\r\n\t\t\t| "+n.configurationFile+" |\r\n\t\t\t"+u+"\r\n\r\n\t"+e.format(n.colon,n.date,i.toLocaleDateString(window.dsLang,{timeZone:"UTC",weekday:"long",year:"numeric",month:"2-digit",day:"2-digit",hour:"numeric",minute:"numeric",timeZoneName:"short"}))+"\r\n\r\n\t"+e.format(n.separator,e.format(n.colon,n.browser,r.Engine.name.ucfirst()),e.format(n.colon,n.version,r.Engine.version))+"\r\n\r\n\t"+e.format(n.colon,n.operationSystem,r.Platform.name)+"\r\n\r\n\t"+e.format(n.colon,n.orientation,n[r.getOrientation()])+"\r\n\t"+e.format(n.colon,n.resolution,"")+"\r\n\t\t"+e.format(n.colon,n.screen,"")+"\r\n\t\t\t"+e.format(n.colon,n.width,window.screen.width)+"\r\n\t\t\t"+e.format(n.colon,n.height,window.screen.height)+"\r\n\t\t"+e.format(n.colon,n.viewport,"")+"\r\n\t\t\t"+e.format(n.colon,n.width,c.width)+"\r\n\t\t\t"+e.format(n.colon,n.height,c.height)+"\r\n\t"+(l?n.geolocation+"\r\n\t\t"+e.format(n.colon,n.latitude,l.coords.latitude)+"\r\n\t\t"+e.format(n.colon,n.longitude,l.coords.longitude)+"\r\n":"")+"\r\n\t"+n.platforms+":\r\n"+a.map(function(t){return"\t\t"+e.format(n.colon,n.name,t.platformId)+"\r\n\t\t\t"+e.format(n.valueInMilliseconds,e.format(n.colon,n.latency,t.latency.toFixed(1)))+"\r\n\t\t\t"+e.format(n.valueInMegabitsPerSecond,e.format(n.colon,n.downloadRate,t.downloadRate.toFixed(1)))+"\r\n"}).join("")+"\r\n\t"+e.format(n.colon,e.format(n.separator,n.build,n.deploy),s)+"\r\n"},formatFileName:function(t){return"browserInformation_"+((t=t||{}).date||new Date).toISOString().replace("T","_").replace(":","-").split(":")[0]+".txt"}}}),define("DS/Latency/ReportModel",["UWA/Class/Model"],function(t){"use strict";var e="good",n="average",o="bad";return t.extend({defaults:{latency:-1,downloadRate:-1,platformId:""},getLatencyScore:function(){var t=this.get("latency");return t<=120?e:t>350?o:n},getDownloadRateScore:function(){var t=this.get("downloadRate");return t>=16?e:t<4?o:n}})}),define("DS/Latency/TestRunner",["UWA/Core","UWA/Class","DS/WebappsUtils/Performance","DS/i3DXCompassServices/i3DXCompassServices"],function(t,e,n,o){"use strict";var r={idle:"idle",running:"running",aborting:"aborting"},a={path:"/webapps/LatencyResources/assets/images/latency_small.png",sizeMb:0},i={path:"/webapps/LatencyResources/assets/images/download_20mb.jpg",sizeMb:160},s={tenants:null};function l(){try{return n.now()}catch(t){return Date.now()}}return e.extend({init:function(t){t=t||{},this._tenantId=t.tenantId,this._state=r.idle},start:function(){var t=this,e=[];return t._checkState("start",r.idle),t._state=r.running,t._getTenantsUnderTest().then(function(n){return n.map(function(e){return t._runTestOnTenant.bind(t,e)}).reduce(function(t,n){return t.then(n).then(function(t){e.push(t)})},Promise.resolve()).then(function(){return t._state=r.idle,e},function(e){throw t._state=r.idle,e})})},abort:function(){this._checkState("abort",r.running),this._state=r.aborting},_checkState:function(t,e){if(this._state!==e)throw new Error("Cannot "+t+" test during non-"+e+" state")},_getTenantsUnderTest:function(){var t=this;return(s.tenants?Promise.resolve(s.tenants):t._getTenantData("3DSwym").catch(function(){return t._getTenantData("3DSpace")})).then(function(e){return s.tenants=e,t._tenantId?e.filter(function(e){return e.platformId===t._tenantId}):e})},_getTenantData:function(t){return new Promise(function(e,n){o.getServiceUrl({serviceName:t,onComplete:function(t){t.length>0&&t[0].url?e(t):n(t)},onFailure:function(t){n(t)}})})},_runTestOnTenant:function(e){var n=this,o=e.url,r=t.clone(e);return n._runLatencyTest(o).then(function(t){return r.latency=t,n._runDownloadRateTest(o)}).then(function(t){return r.downloadRate=t,r})},_runLatencyTest:function(t){return this._getResponseTime({baseUrl:t,testResourcePath:a.path,totalRequests:10}).then(function(t){return t/2})},_runDownloadRateTest:function(t){return this._getResponseTime({baseUrl:t,testResourcePath:i.path,totalRequests:2}).then(function(t){return i.sizeMb/(t/Math.pow(10,3))})},_getResponseTime:function(e){var n=this,o=e.baseUrl,a=e.testResourcePath,i=e.totalRequests,s=[];return new Promise(function(e,c){!function u(){var d;d=l(),t.createElement("img",{src:o+a+"?random="+Math.random(),events:{load:function(){if(s.push(l()-d),n._state===r.aborting)return c({reason:"aborted"});s.length<i?u():e(s.reduce(function(t,e){return t+e},0)/i)},error:c}})}()})}})}),define("DS/Latency/ReportItemView",["UWA/Class/View","UWA/String","i18n!DS/Latency/assets/nls/latency","css!DS/Latency/Latency"],function(t,e,n){"use strict";return t.extend({render:function(){var t,o=this.model.collection.length>1,r=o?"h4":"h2",a=o?"h4":"h1";t=[{tag:"div",class:"rate-element latency",html:[{tag:"div",class:r+" latency-label",text:n.latency},{tag:"div",class:a+" latency-value "+this.model.getLatencyScore(),text:e.format(n.valueInMilliseconds,this.model.get("latency").toFixed(1))}]},{tag:"div",class:"rate-element download",html:[{tag:"div",class:r+" download-label",text:n.downloadRate},{tag:"div",class:a+" download-value "+this.model.getDownloadRateScore(),text:e.format(n.valueInMegabitsPerSecond,this.model.get("downloadRate").toFixed(1))}]}],o&&t.unshift({tag:"div",class:"h5",text:e.format(n.colon,n.platformName,this.model.get("platformId"))}),this.container.addContent(t)}})}),define("DS/Latency/ReportCollectionView",["UWA/Class/View","DS/Latency/ReportItemView"],function(t,e){"use strict";return t.extend({render:function(){this.collection.map(function(t){return new e({model:t,collection:this.collection,container:this.container})},this).forEach(function(t){t.render()})}})}),define("DS/Latency/ReportCollection",["UWA/Class/Collection","DS/Latency/ReportModel"],function(t,e){"use strict";return t.extend([],{model:e})}),define("DS/Latency/SupportDialogBuilder",["UWA/Core","DS/UIKIT/Alert","DS/UIKIT/Spinner","DS/UIKIT/Input/Button","DS/Latency/TestRunner","DS/Latency/TestReportFormatter","DS/Latency/ReportModel","DS/Latency/ReportCollection","DS/Latency/ReportCollectionView","i18n!DS/Latency/assets/nls/latency","css!DS/Latency/Latency"],function(t,e,n,o,r,a,i,s,l,c){"use strict";return{build:function(u){var d,m,f,h,g,p,w=u.container,y=u.tenantId,v=u.buildDeploy,b=new r({tenantId:y}),S=w.getBody().getElement(".template-cont");return navigator.geolocation.getCurrentPosition(function(t){g=t}),S.empty(),S.setAttribute("class","template-cont"),S.addClassName("support"),S.setStyle("height","355px"),S.setStyle("padding","10px"),S.appendChild(t.createElement("div",{html:{tag:"h3",class:"network-title",text:c.networkPerformance}})),d=t.createElement("div",{class:"spinner-support"}).inject(S),(new n).inject(d).show(),m=new o({className:"input-submit primary",value:c.downloadInformationFile,disabled:!0,events:{onClick:function(){var e=new Date;!function(e){var n,o=e.content,r=e.name,a=new Blob([o],{type:"text/html"});if("ie"===t.Utils.Client.Engine.name)window.navigator.msSaveBlob(a,r);else if(t.Utils.Client.Platform.ios||t.Utils.Client.Platform.ipad){var i=window.open("about:blank",r);i.document.write("<pre>"+o+"</pre>"),i.document.close(),i.document.title=r}else n=t.createElement("a",{text:c.download,href:URL.createObjectURL(a),target:"_blank",download:r}),document.body.appendChild(n),n.click(),document.body.removeChild(n)}({name:a.formatFileName({date:e}),content:a.formatFile({testResults:h,date:e,buildDeploy:v,geolocation:g})})}}}),f=new e({closable:!1,visible:!0,messages:[{message:c.errorLatency,className:"warning"}]}),w.getFooter().show(),w.setFooter(m),(p=new MutationObserver(function(t){[].forEach.call(t[0].removedNodes,function(t){if(t.hasClassName("network-title")||t.getElement(".network-title")){p.disconnect();try{b.abort()}catch(t){}}})})).observe(S.parentElement,{childList:!0,subtree:!0}),b.start().then(function(e){h=e;var n=new s,o=new l({collection:n,container:t.createElement("div").inject(S)}),r=e.map(function(e){return new i(t.extend({collection:n},e))});n.add(r),d.remove(),m.setDisabled(!1),o.render()},function(e){t.is(e,"object")&&"aborted"===e.reason||(d.remove(),f.inject(S))})}}});