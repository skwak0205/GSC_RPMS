define("DS/RTCollaborateAPI/RTCollaborateAPI",["UWA/Class","UWA/Class/Events","DS/PlatformAPI/PlatformAPI","i18n!DS/RTCollaborateAPI/assets/nls/feed"],function(t,a,e,o){"use strict";UWA.log("3DIM - RTCollaborateAPI load");var n=function(t){return"string"==typeof t?UWA.log("RTCollaborateAPIlogger - "+t):UWA.log(t)};return t.extend(a,{init:function(t){if(this.PlatformAPI=t.PlatformAPI||e,!t)return n("no arg provided");if(t.collabType="coreview",!t.onCollabStart)return n("onCollabStart not defined");if("function"!=typeof t.onCollabStart)return n("onCollabStart must be a function");if(!t.onCollabStop)return n("onCollabStop not defined");if("function"!=typeof t.onCollabStop)return n("onCollabStop must be a function");if(!t.onDataReceived)return n("onDataReceived not defined");if("function"!=typeof t.onDataReceived)return n("onDataReceived must be a function");var a;if(this.ManagerChannel="fromwidgetim.ds.com",this.channel=t.channel||"collab.im.ds.com",this.id=this.channel,this.isCollabStarted=!1,this.isMaster=!1,this.onCollabStart=function(a){return this.isCollabStarted?n("onCollabStart has been called but the collab is already started"):a.room_id?(this.isCollabStarted=!0,this.isMaster=a.isMaster,this.room_id=a.room_id,t.onCollabStart(a)):n("onCollabStart has been called witout room_id")},this.onCollabStop=function(a){return this.isCollabStarted||n("onCollabStop has been called but the collab is not started"),this.isCollabStarted=!1,t.onCollabStop(a)},this.onDataReceived=function(a){if(!a||!a.data)return n("onDataReceived bad data format");if(a.room_id!=this.room_id)return n("onDataReceived for another room_id");if(!this.isCollabStarted)return n("onDataReceived has been called but the collab is not started");var e;try{e=JSON.parse(atob(a.data.data||a.data))}catch(t){n("onDataReceived failed to decode and parse received data")}return t.onDataReceived(e&&e.data||a.data.data||a.data)},this.onChangeMasterReceived=function(a){if(this.isCollabStarted||n("onChangeMasterReceived has been called but the collab is not started"),t.onChangeMasterReceived&&"function"==typeof t.onChangeMasterReceived)return t.onChangeMasterReceived(a);n("onChangeMasterReceived but no function to launch with")},this.platformListenner=(a=this,function(t){switch(t.action=t.action||t.evenement,t.room_id=t.room_id||t.data&&t.data.room_id,t.action){case"startCollab":a.onCollabStart(t);break;case"stopCollab":a.onCollabStop(t);break;case"dataCollabReceived":a.onDataReceived(t);break;case"changeMaster":a.onChangeMasterReceived(t);break;default:n("received an unknown action : "+t.action)}}),this.subscribeToChannel=function(t){return t&&this.onDataReceived&&this.onCollabStop&&this.onCollabStart?(this.PlatformAPI.subscribe(this.channel,this.platformListenner),!0):n("subscribeToChannel bad args")},this.subscribeToChannel(this.channel),this.logins=t.data&&t.data.logins||[],!t.logins&&t.data&&"object"==typeof t.data.login&&t.data.login.length)for(var o in t.data.login)this.logins.push(t.data.login[o].login);t.logins=this.logins,this.communityId=t.data&&t.data.communityId,this.mediaId=t.data&&t.data.mediaId,"initCoreview"==t.action?(this.PlatformAPI.publish(this.ManagerChannel,t),t.noCall||this.PlatformAPI.publish("im.ds.com",{action:"startCall",type:t.callType||"video",logins:t.logins})):"acceptCoreview"==t.action&&this.onCollabStart(t)},destroy:function(){this.stop(),this.onCollabStop()},start:function(){if(!this.logins)return console.error("can not start coreview without logins");this.PlatformAPI.publish(this.channel,{action:"startCollab",channel:this.channel,logins:this.logins})},stop:function(){this.isMaster&&this.PlatformAPI.publish(this.ManagerChannel,{action:"stopCollab",room_id:this.room_id})},sendData:function(t){if(!this.isCollabStarted)return n("sendData raised but the collab has not been started yet");if(!t)return n("sendData raised without data");if(!this.channel)return n("sendData raised but the PlatformAPI channel is not set");if(!this.room_id)return n("sendData raised but the room_id is not set");var a=UWA.Json.prune(t,{fallback:function(t,a){return"circular"==a?null:t}});this.PlatformAPI.publish("fromwidgetim.ds.com",{evenement:"coreview",data:{room_id:this.room_id,data:a}})}})});