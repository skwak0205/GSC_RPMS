define("DS/Magnifier/Magnifier",["UWA/Class","UWA/Controls/Abstract","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/VisuEvents/ScreenEvent","DS/VisuEvents/EventsManager"],function(e,t,i,n,s,a,o){"use strict";return t.extend({defaultOptions:{activated:!0,viewer:null,dim:83,shiftVector:{x:-40,y:110}},init:function(e){this._parent(e),this._buildView(),this.displayed=!1,this.enableSelection=!1,this.devicePixelRatio=n.getDevicePixelRatio()||1,this.container=this.elements.container,this.content=this.elements.container.firstChild,this.setUpCBs(),this.setOption(this.options),this.viewer.divCssElement.appendChild(this.container),this.onRenderCB=null},setOption:function(e){e.viewer&&(this.viewer=e.viewer),e.dim&&this._setDimension(e.dim),e.shiftVector?this.shiftVector=e.shiftVector:this.shiftVector=new n.Vector2,e.activated?this._activate():this._desactivate()},_buildView:function(){this.elements.container=UWA.Element("div",{id:"magnify-div",html:[{tag:"canvas",id:"magnify-canvas"}],styles:{position:"absolute",display:"none","box-shadow":"-1px 2px 5px 1px rgba(0, 0, 0, 0.7)",border:"1px solid #ccc"}})},_setDimension:function(e){this.dim=e%2==0?e+1:e,this.container.setStyle("width",this.dim),this.container.setStyle("height",this.dim),this.container.setStyle("overflow","hidden"),this.container.setStyle("border-radius","50%"),this.content.setStyle("width","100%"),this.content.setStyle("height","100%"),this.content.width=this.dim*this.devicePixelRatio,this.content.height=this.dim*this.devicePixelRatio},_updateMagnifier:function(e){var t=this.viewer.devicePixelRatio;t!==this.devicePixelRatio&&(this.devicePixelRatio=t,this._setDimension(this.dim));var i={x:this.viewer.renderer.deviceWidth,y:this.viewer.renderer.deviceHeight},n={x:Math.round(this.dim*t),y:Math.round(this.dim*t)},s=Math.min(Math.max(0,e.xPix+this.shiftVector.x*t),i.x-n.x),a=Math.min(Math.max(0,e.yPix-this.shiftVector.y*t),i.y-n.y);this.container.show(),this.displayed=!0,this._renderOffscreen(this.viewer,this.viewer.currentViewpoint,this.content,i,n,e),this.container.setStyles({left:Math.round(s/t),top:Math.round(a/t)})},_renderOffscreen:function(e,t,i,n,s,a){var o={x:a.xPix-s.x/2,y:a.yPix+s.y/2},r={data:null,width:s.x,height:s.y,x:Math.round(o.x),y:Math.round(n.y-o.y)};e.renderToTarget(r,t,!0);for(var h=i.getContext("2d"),d=h.getImageData(0,0,s.x,s.y),c=d.data,l=0;l<d.height;l++)for(var v=0;v<d.width;v++){var f=this._getBufferIndex(v,l,d.width,d.height,!1),u=this._getBufferIndex(v,l,r.width,r.height,!0);c[4*f]=r.data[4*u],c[4*f+1]=r.data[4*u+1],c[4*f+2]=r.data[4*u+2],c[4*f+3]=r.data[4*u+3]}h.putImageData(d,0,0),h.drawImage(h.canvas,0,0,s.x,s.y);var g=Math.floor(s.x/2)+.5,w=Math.floor(s.y/2)+.5;h.fillStyle="rgba(0, 255, 255, 0.5)",h.fillRect(g-2,w-8,4,16),h.fillRect(g-8,w-2,16,4),h.fillStyle="rgba(0, 0, 0, 0.5)",h.fillRect(g-1.5,w-7.5,3,15),h.fillRect(g-7.5,w-1.5,15,3),h.fillStyle="rgba(255, 255, 255, 1)",h.fillRect(g-.5,w-6.5,1,13),h.fillRect(g-6.5,w-.5,13,1),this.onRenderCB&&this.onRenderCB()},_getBufferIndex:function(e,t,i,n,s){return s?(t=n-t,i*Math.floor(t-1)+Math.floor(e)):i*Math.floor(t)+Math.floor(e)},_activate:function(){this.active=!0,o.addEvent(this.viewer.canvas,"onLongHold",this.startCB)},_desactivate:function(){this.active=!1,o.removeEvent(this.viewer.canvas,"onLongHold",this.startCB)},setUpCBs:function(){var e=this;e.displayed=!1,this.startCB=function(t){e.viewer.currentViewpoint.control.isMiddleButtonPressed()||e.viewer.currentViewpoint.control.isRightButtonPressed()||(e._updateMagnifier(e.viewer.getMousePosition(t.from[0].getCurrentPosition(e.viewer.canvas))),o.addEvent(e.viewer.canvas,"onSwipe",e.moveCB),o.addEvent(e.viewer.canvas,"onRelease",e.endCB))},this.moveCB=function(t){t.from[0].deltaPosition.length()<300?e._updateMagnifier(e.viewer.getMousePosition(t.from[0].getCurrentPosition(e.viewer.canvas))):e.container.hide(),t.from[0].offsetPosition.length()>10&&(e.enableSelection=!0)},this.endCB=function(){e.container.hide(),o.removeEvent(e.viewer.canvas,"onSwipe",e.moveCB),o.removeEvent(e.viewer.canvas,"onRelease",e.endCB)}}})}),define("Magnifier/Magnifier",["DS/Magnifier/Magnifier","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Magnifier/Magnifier"),e});