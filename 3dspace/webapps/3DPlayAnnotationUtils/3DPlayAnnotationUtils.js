define("DS/3DPlayAnnotationUtils/CurvedLayout",["UWA/Core","UWA/Class"],function(t,e){"use strict";return e.extend({init:function(e){if(this._parent(e),!e||!e.childCount)return console.error("CurvedLayout: Cannot create layout, params missing."),!1;e.layoutOpts||(e.layoutOpts={});var i=e.childCount,n=0==i%2,s=e.layoutOpts.containerHeight,o=e.layoutOpts.containerWidth,a=(s*s+4*o*o)/(8*o),r=Math.atan(s/(2*(a-o))),l=e.layoutOpts.offsetX||0,h=e.layoutOpts.offsetY||0,p=2*r/i;this.contentArray=[];var c=.5,u=new t.Element("div",{styles:{width:a,height:a,position:"absolute",top:-a/2+"px"}}).inject(e.containerElement),d=function(e){var i=l,n=h;i+=a-a*Math.cos(e),n+=a-a*Math.sin(e);var s=new t.Element("div");return s.setStyle("position","absolute"),s.setStyle("left",i+"px"),s.setStyle("top",n+"px"),s.inject(u),s};n||(i--,this.contentArray.push(d(0)),c=1);for(var x=0;x<i/2;x++){var g=p*(x+c);this.contentArray.unshift(d(-g))}for(x=0;x<i/2;x++){g=p*(x+c);this.contentArray.push(d(g))}}})}),define("DS/3DPlayAnnotationUtils/AnnotationUtilities",[],function(){"use strict";return{_lockDirection:function(t,e){if(t.x===e[0].x&&t.y===e[0].y)return;let i=t.y-e[0].y,n=t.x-e[0].x;if(Math.abs(n)>Math.abs(i)){t.setY(e[0].y),n>0?e.push(t):n<0&&e.unshift(t);var s="horizontal"}else if(Math.abs(i)>Math.abs(n)){t.setX(e[0].x),i>0?e.push(t):i<0&&e.unshift(t);s="vertical"}return s},_addPositionToViewerPoints:function(t){return t.isShiftKeyDown?void 0!==t.direction?"horizontal"===t.direction?(t.position.setY(t.viewerPoints[0].y),t.position.x>t.viewerPoints[1].x?t.viewerPoints[1].setX(t.position.x):t.position.x<t.viewerPoints[0].x&&t.viewerPoints[0].setX(t.position.x)):"vertical"===t.direction&&(t.position.setX(t.viewerPoints[0].x),t.position.y>t.viewerPoints[1].y?t.viewerPoints[1].setY(t.position.y):t.position.y<t.viewerPoints[0].y&&t.viewerPoints[0].setY(t.position.y)):t.direction=this._lockDirection(t.position,t.viewerPoints):t.viewerPoints.push(t.position),t.direction}}}),define("DS/3DPlayAnnotationUtils/ShapeUtils",["DS/WebUtils/Vector2","DS/WebUtils/GeometryUtils","DS/WebSystem/Settings","DS/Visualization/ThreeJS_DS","DS/CATMathNTSJSOpe/CATMathRghDiscretize","DS/CATMathNTSJSOpe/CATMathRghImproveCR","DS/CATMathNTSJSOpe/CATMathRghLiftingDPR","DS/MathematicsES/MathsDef"],function(t,e,i,n,s,o,a,r){"use strict";var l=i.get("3DPlay.Annotation.PerformanceMode");return{shapeEval:function(i,n=null){var s=i,o=i.slice(0);if(0!=i.length){if(1==i.length)return(s=[])[0]=new t(i[0].x-.1,i[0].y-.1),s[1]=new t(i[0].x+.1,i[0].y-.1),s[2]=new t(i[0].x+.1,i[0].y+.1),s[3]=new t(i[0].x-.1,i[0].y+.1),s.type="unknownOpen",{input:o,convexHull:o,boundingBox:o,_largestEnclosedTriangle:o,shape:s};if(2==o.length)return(s=[])[0]=i[0],s[1]=i[i.length-1],(s=this._interpolateStraightLine(s)).type="line",{input:o,convexHull:o,boundingBox:o,_largestEnclosedTriangle:o,shape:s};var a=this._isClosed(o),r=e.convexHullCompute(o);if(2==r.length)return(s=[])[0]=i[0],s[1]=i[i.length-1],(s=this._interpolateStraightLine(s)).type="line",{input:i,convexHull:o,boundingBox:o,_largestEnclosedTriangle:o,shape:s};var l=this._polyPerimeter(r),h=this._polyArea(r),p=e.boundingBoxCompute(r),c=this._largestEnclosedTriangle(r),u=this._annotLength(o),d=l*l/h;if(d<13.35&&a&&u/l<1.1&&u/l>.9){var x=new t((p[0].x+p[2].x)/2,(p[0].y+p[2].y)/2),g=(p[0].distanceTo(p[1])+p[1].distanceTo(p[2]))/4;(s=this._getCircle(x,g)).type="circle"}else if(d>110){var m,y=i[i.length-1];(m=i[i.length-1].x==i[0].x?90:180*(m=Math.atan(Math.abs(i[i.length-1].y-i[0].y)/Math.abs(i[i.length-1].x-i[0].x)))/Math.PI)<=5?y=new t(i[i.length-1].x,i[0].y):m>=85&&(y=new t(i[0].x,i[i.length-1].y)),s=[i[0],y],(s=this._interpolateStraightLine(s)).type="line"}else{var f=this._triangleArea(c[0],c[1],c[2]),v=h/(p[0].distanceTo(p[1])*p[1].distanceTo(p[2]));if(f/h>.73&&.25<v&&.7>v)if(a&&l/u<1.2&&l/u>.8)s=c,(s=this._interpolateClosedPolygon(s)).push(s[0]),s.type="triangle",s.data={vertices:c};else{var b=this._getArrowhead(o,c);this._annotLength(b);(s=o).type="unknownOpen",n&&"line"===n.type&&d>=50&&d<=110&&(s.type="line")}else if(l/this._polyPerimeter(p)>.9&&a){var w=p[0].distanceTo(p[1])/p[1].distanceTo(p[2]);if(w<1.2&&w>.8){x=new t((p[0].x+p[2].x)/2,(p[0].y+p[2].y)/2);var C=(p[0].distanceTo(x)+p[1].distanceTo(x))/2,T=new t((p[2].x-p[0].x)/2,(p[2].y-p[0].y)/2);T.normalize().multiplyScalar(C),(s=this._getSquare(x,T)).type="square"}else(s=this._getRectangle(p,h)).type="rectangle"}else{if(h*h/(p[0].distanceTo(p[1])*p[1].distanceTo(p[2])*f)>1.6&&a&&u/l<1.2&&u/l>.8){x=new t((p[0].x+p[2].x)/2,(p[0].y+p[2].y)/2);var S=p[0].distanceTo(p[1])/2,P=p[1].distanceTo(p[2])/2,A=new t(p[1].x-p[0].x,p[1].y-p[0].y);(s=this._getEllipse(x,S,P,A.normalize())).type="ellipse"}else(s=o).type="unknownOpen",n&&"line"===n.type&&d>=50&&d<=110&&(s.type="line")}}return{input:i,convexHull:r,boundingBox:p,_largestEnclosedTriangle:c,shape:s}}},shapeUnEval:function(i,n){var s=i,o=i.slice(0);if(0!=i.length){if(1==i.length)return(s=[])[0]=new t(i[0].x-.1,i[0].y-.1),s[1]=new t(i[0].x+.1,i[0].y-.1),s[2]=new t(i[0].x+.1,i[0].y+.1),s[3]=new t(i[0].x-.1,i[0].y+.1),s.type="unknownOpen",{input:o,convexHull:o,boundingBox:o,_largestEnclosedTriangle:o,shape:s};this._isClosed(o);var a=e.convexHullCompute(o);if(2==a.length)return(s=o).type="unknownOpen",{input:i,convexHull:o,boundingBox:o,_largestEnclosedTriangle:o,shape:s};var r=e.boundingBoxCompute(a),l=this._largestEnclosedTriangle(a);return(s=o).type="unknownOpen",{input:i,convexHull:a,boundingBox:r,_largestEnclosedTriangle:l,shape:s}}},filterAndSmoothPoints:function(t,e){var i=this._InputsPointsToDSMathVector3D(t),n=new a;return n.setListOfPoints(i),e&&(n._isLinearFiltered=!0),n.setMinimalStep(.15*6),n.setMaximumError(.85),i=n.getListOfPoints(),i=this._SmoothPoints(i),i=this._DiscretizePoints(i),i=this._DSMathVectorToTHREEVector2(i)},_SmoothPoints:function(t){var e=new o;return e.setListOfPoints(t),e},_DiscretizePoints:function(t){var e=new s;return e.setFunctionToDiscretize(t),e.setDiscretizationType(1,5),e.getListOfPoints()},_InputsPointsToDSMathVector3D:function(t){for(var e=[],i=0;i<t.length;i++){var n=new r.Vector3D(t[i].x,t[i].y,0);e.push(n)}return e},_DSMathVectorToTHREEVector2:function(t){for(var e=[],i=0;i<t.length;i++){var s=new n.Vector2(t[i].x,t[i].y);e.push(s)}return e},onScreenProjection:function(t,e){var i;if(e){var s,o=e.getRootNode();if(o&&o.children)for(var a=0;a<o.children.length;a++)if("RootBag"==o.children[a].name){s=o.children[a];break}}s&&(i=s.getMatrixWorld());var r,l=[],h=e.currentViewpoint.getCamera(),p=h.matrixWorldInverse,c=h.projectionMatrix,u=e.SCREEN_WIDTH,d=e.SCREEN_HEIGHT;for(a=0;a<t.length;a++)r=t[a].clone(),r=new n.Vector4(r.x,r.y,r.z,1),i&&r.applyMatrix4(i),r.applyMatrix4(p),r.applyMatrix4(c),r.divideScalar(r.w),r.x=u/2+r.x*u/2,r.y=d/2-r.y*d/2,l.push(new n.Vector2(Math.round(r.x),Math.round(r.y)));return l},_largestEnclosedTriangle:function(t){var e,i,n,s,o,a;e=0,i=1,n=2,s=0,o=1,a=2;do{for(;(n+1)%t.length!=e&&i!=n;){for(;this._triangleArea(t[e],t[i],t[n])<=this._triangleArea(t[e],t[i],t[(n+1)%t.length]);)n=(n+1)%t.length;if(!((i+1)%t.length!=n&&this._triangleArea(t[e],t[i],t[n])<=this._triangleArea(t[e],t[(i+1)%t.length],t[n])))break;i=(i+1)%t.length}this._triangleArea(t[e],t[i],t[n])>this._triangleArea(t[s],t[o],t[a])&&(s=e,o=i,a=n),(e=(e+1)%t.length)==i&&(i=(i+1)%t.length),i==n&&(n=(n+1)%t.length)}while(0!=e);return[t[s],t[o],t[a]]},_triangleArea:function(t,e,i){return null==t||null==e||null==i?0:((e.x-t.x)*(i.y-t.y)-(i.x-t.x)*(e.y-t.y))/2},_polyArea:function(t){for(var e=0,i=0;i<t.length;i++)e+=t[(i+1)%t.length].x*(t[(i+2)%t.length].y-t[i%t.length].y);return e/2},_isClosed:function(t){t[0].distanceTo(t[t.length-1]),this._polyPerimeter(t);return t[0].distanceTo(t[t.length-1])<this._polyPerimeter(t)/7},_polyPerimeter:function(t){for(var e=0,i=0;i<t.length;i++)e+=t[i].distanceTo(t[(i+1)%t.length]);return e},_interpolateStraightLine:function(e){var i=e[0].distanceTo(e[1])/4;l&&(i=4);var n=e[1].x-e[0].x,s=e[1].y-e[0].y,o=[];o.push(e[0].clone());for(var a=0;a<i;a++)o.push(new t(e[0].x+a/i*n,e[0].y+a/i*s));return o.push(e[1].clone()),o},_interpolateStraightLineLow:function(e){if(l)return this._interpolateStraightLine(e);var i=e[0].distanceTo(e[1])/8,n=e[1].x-e[0].x,s=e[1].y-e[0].y,o=[];o.push(e[0].clone());for(var a=0;a<i;a++)o.push(new t(e[0].x+a/i*n,e[0].y+a/i*s));return o.push(e[1].clone()),o},_interpolateClosedPolygon:function(t){for(var e=[],i=0;i<t.length-1;i++)this._interpolateStraightLine([t[i],t[i+1]]).forEach(function(t){e.push(t)});return this._interpolateStraightLine([t[t.length-1],t[0]]).forEach(function(t){e.push(t)}),e},_interpolate2D:function(e,i,n,s){i=void 0!==i?i:.5,n=n||!1,s=l?s||3:s||10;var o,a,r,h,p,c,u,d,x,g,m,y=[],f=[];for(y=e.slice(0),n?(y.unshift(e[e.length-1]),y.unshift(e[e.length-1]),y.push(e[0])):(y.unshift(e[0]),y.push(e[e.length-1])),u=1;u<y.length-2;u+=1)for(d=(y[u+1].x-y[u-1].x)*i,x=(y[u+1].y-y[u-1].y)*i,g=(y[u+2].x-y[u].x)*i,m=(y[u+2].y-y[u].y)*i,c=0;c<=s;c++){p=c/s,o=2*Math.pow(p,3)-3*Math.pow(p,2)+1,a=-2*Math.pow(p,3)+3*Math.pow(p,2),r=Math.pow(p,3)-2*Math.pow(p,2)+p,h=Math.pow(p,3)-Math.pow(p,2);var v=new t(o*y[u].x+a*y[u+1].x+r*d+h*g,o*y[u].y+a*y[u+1].y+r*x+h*m);f.push(v)}return f},_annotLength:function(t){for(var e=0,i=1;i<t.length;i++)e+=t[i-1].distanceTo(t[i]);return e},_distPointToSegment:function(t,e,i){var n;function s(t,e){return Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)}var o=s(e,i);if(0==o)return s(t,e);var a=((t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y))/o;return a<0?s(t,e):a>1?s(t,i):(n=s(t,{x:e.x+a*(i.x-e.x),y:e.y+a*(i.y-e.y)}),Math.sqrt(n))},_getCircle:function(e,i){var n=[],s=Math.PI/i;l&&(s=Math.PI/8);for(var o=0;o<2*Math.PI;o+=s)n.push(new t(e.x+i*Math.cos(o),e.y+i*Math.sin(o)));return l&&n.push(new t(e.x+i*Math.cos(0),e.y+i*Math.sin(0))),n.data={centre:e,radius:i},n},_getEllipse:function(e,i,n,s){var o,a,r=[],h=s.y,p=s.x,c=2*Math.PI/(i+n);l&&(c=Math.PI/8);for(var u=0;u<2*Math.PI;u+=c)o=Math.cos(u),a=Math.sin(u),r.push(new t(e.x+i*o*p-n*a*h,e.y+i*o*h+n*a*p));l&&(o=Math.cos(0),a=Math.sin(0),r.push(new t(e.x+i*o*p-n*a*h,e.y+i*o*h+n*a*p)));var d=180*Math.atan2(s.y,s.x)/Math.PI;return r.data={centre:e,radius1:i,radius2:n,angle:d},r},_getSquare:function(e,i){var n=[];n[0]=new t(e.x+i.x,e.y+i.y),n[1]=new t(e.x+i.y,e.y-i.x),n[2]=new t(e.x-i.x,e.y-i.y),n[3]=new t(e.x-i.y,e.y+i.x);var s=[];return s=s.concat(n),(n=this._interpolateClosedPolygon(n)).data={vertices:s},n},_getRectangle:function(e,i){var n=[],s=i/(e[0].distanceTo(e[1])*e[1].distanceTo(e[2]));s+=(1-s)/2;for(var o=new t((e[0].x+e[2].x)/2,(e[0].y+e[2].y)/2),a=0;a<4;a++)n[a]=e[a].clone(),n[a].sub(o).multiplyScalar(s).add(o);var r=[];return r=r.concat(n),n.push(n[0]),(n=this._interpolateClosedPolygon(n)).data={vertices:r},n},_getArrowhead:function(t,e){for(var i,n=[],s=Number.MAX_VALUE,o=Number.MAX_VALUE,a=0,r=0,l=0;l<3;l++)(i=t[0].distanceTo(e[l]))<s&&(s=i,a=l),(i=t[t.length-1].distanceTo(e[l]))<o&&(o=i,r=l);n[0]=e[a],n[2]=e[r];for(l=0;l<3;l++)l!=a&&l!=r&&(n[1]=e[l]);return n}}}),define("DS/3DPlayAnnotationUtils/AnnotationSettings",["UWA/Core","DS/WebSystem/Settings","DS/CoreEvents/Events"],function(t,e,i){function n(){var t,n,s,o,a,r;this.init=function(){t=e.get("3DPlay.Annotation.Color","#FF0000"),n=e.get("3DPlay.Annotation.Thickness","6"),s=e.get("3DPlay.Annotation.Opacity","1"),o="30",a=e.get("3DPlay.Annotation.HighlightOpacity","0.3"),r=e.get("3DPlay.Annotation.LastPosition","0.4,0.4"),_settings_Thickness_Eraser=e.get("3DPlay.Annotation.EraserThickness","30"),_settings_Opacity_Eraser=e.get("3DPlay.Annotation.EraserOpacity","0.1")},this._publishChange=function(){i.publish({event:"3DPlay.Annotation.SettingsChanged",data:{color:this.getColor(),thickness:this.getThickness(),opacity:this.getOpacity(),thickness_highlight:this.getHighlightThickness(),opacity_highlight:this.getHighlightOpacity()}})},this.setColor=function(i){t=i,e.set("3DPlay.Annotation.Color",t),this._publishChange()},this.getColor=function(){return t},this.setThickness=function(t){n=t,e.set("3DPlay.Annotation.Thickness",n),this._publishChange()},this.getThickness=function(){return n},this.setOpacity=function(t){s=t,e.set("3DPlay.Annotation.Opacity",s),this._publishChange()},this.getOpacity=function(){return s},this.setHighlightThickness=function(t){o=t,e.set("3DPlay.Annotation.HighlightThickness",o),this._publishChange()},this.getHighlightThickness=function(){return o},this.setEraserThickness=function(t){_settings_Thickness_Eraser=t,e.set("3DPlay.Annotation.EraserThickness",_settings_Thickness_Eraser),this._publishChange()},this.getEraserThickness=function(){return _settings_Thickness_Eraser},this.setHighlightOpacity=function(t){a=t,e.set("3DPlay.Annotation.HighlightOpacity",a),this._publishChange()},this.getHighlightOpacity=function(){return a},this.setEraserOpacity=function(t){_settings_Opacity_Eraser=t,e.set("3DPlay.Annotation.EraserOpacity",_settings_Opacity_Eraser),this._publishChange()},this.getEraserOpacity=function(){return _settings_Opacity_Eraser},this.setLastPosition=function(t){(t.x<0||t.x>=1)&&(t.x=.4),(t.y<0||t.y>=1)&&(t.y=.4),r=t.x+","+t.y,e.set("3DPlay.Annotation.LastPosition",r)},this.getLastPosition=function(){var t=r.split(",");return{x:t[0],y:t[1]}}}var s;return t.namespace("DS/3DPlayAnnotationUtils/AnnotationSettings",function(){return!1===t.typeOf(s)&&(s=new n).init(),s})}),define("DS/3DPlayAnnotationUtils/AnnotationAbbreviations",["UWA/Class"],function(t){"use strict";var e={l:"line",c:"circle",e:"ellipse",r:"rectangle",s:"square",t:"triangle",a:"arrow",ca:"curvedArrow",dha:"doubleHeadedArrow",cda:"curvedDoubleHeadedArrow",uo:"unknownOpen",tt:"text",ep:"eyePosition",ud:"upDirection",sd:"sightDirection",td:"targetDistance",vs:"viewpoints",vp:"viewpointInfo",annot:"annotList",at:"type",om:"onModel",g:"geometry",gp:"graphicalProp",pc:"pointsCount",apn:"annotPlaneNormal",asp:"annotStartPoint",co:"color",op:"opacity",fs:"fontSize",fw:"fontWeight",cen:"center",ra:"radius",maa:"majorAxis",mia:"minorAxis",len:"length",v:"vertices",ps:"points",sc:"scale",w:"width",h:"height",oh:"offsetHeight",ls:"lineStart",le:"lineEnd",cs:"curveStart",ce:"curveEnd",cp:"curvePoints",st:"start",en:"end",p:"point",ah:"arrowhead",es:"explodeStates",d:"diamond",li:"linkID",th:"thickness",pa:"path",an:"angle",da:"data",uc:"unknownClosed"},i={};return Object.keys(e).forEach(function(t){i[e[t]]=t}),t.extend({init:function(t){this._parent(t)},processJSON:function(t,n){var s;"expand"===n?s=e:"minify"===n&&(s=i);for(var o={},a=Object.keys(t),r=0;r<a.length;r++){var l=a[r],h=t[l];if(Array.isArray(h)){for(var p=[],c=0;c<h.length;c++){var u="string"==typeof h[c]?h[c]:this.processJSON(h[c],n);p.push(u)}h=p}else"object"==typeof h&&Object.keys(h).length>0?h=this.processJSON(h,n):"string"==typeof h&&s[h]&&(h=s[h]);var d=s[l];d?o[d]=h:o[l]=h}return o}})}),define("DS/3DPlayAnnotationUtils/CursorManager",["UWA/Class","DS/WebappsUtils/WebappsUtils","DS/WebSystem/DetectBrowser"],function(t,e,i){"use strict";return t.extend({init:function(t){this._parent(t),this.curBrowser=i().browser.name,this.currentCurSize=null,this.currentCurFill=null,this.currentCur=null},_buildCursor:function(t,i){if("custom"===t||"custom_highlight"===t||"custom_eraser"==t){var n="#000000",s="11",o="1";if(i?i.getColor?(n=""+i.getColor(),"custom"===t?(s=""+i.getThickness(),o=""+i.getOpacity()):"custom_highlight"===t?(s=""+i.getHighlightThickness(),o="0.5"):"custom_eraser"===t&&(n="#FFFFFF",s=""+i.getEraserThickness(),o="0")):(n="#"+i.getSettingsColor().getHexString(),s=""+i.getSettingsPencilThickness()):"custom_eraser"===t&&(n="#FFFFFF",s="30",o="0"),"ie"===this.curBrowser&&this.currentCurSize!==s)this.currentCurSize=s,this.currentCurFill=n,this._cursorType="url("+e.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/cur/",this._cursorType+=s<=4?"4x4.cur":s>4&&s<=8?"8x8.cur":"16x16.cur",this._cursorType+="), auto",this.currentCur=this._cursorType;else if("ie"===this.curBrowser||this.currentCurSize===s&&this.currentCurFill===n)this._cursorType=this.currentCur;else{this.currentCurSize=s,this.currentCurFill=n;var a=""+(parseInt(s)+2),r='<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="';r+=a,r+='" height="',r+=a,r+='"><circle cx="',r+=s/2+1,r+='" cy="',r+=s/2+1,r+='" r="',r+=s/2,r+='" stroke="#A3A3A3" stroke-width="1" style="fill: ',r+=n,r+="; fill-opacity:",r+=o,r+=';"/></svg>';var l=btoa(r);this._cursorType="url(data:image/svg+xml;base64,"+l+")",this._cursorType+=" "+s/2+" "+s/2,this._cursorType+=", auto",this.currentCur=this._cursorType}}else"erase"===t?(this._cursorType="url("+e.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_AnnotationRubber.png), auto",this.currentCur=this._cursorType):"edit"===t&&(this._cursorType="url("+e.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_AnnotationEdit.png), auto",this.currentCur=this._cursorType)},setMouseCursor:function(t){if(!t||!t.container)return!1;this.container=t.container,this._cursorType="auto",t.type&&""!==t.type&&t.type!==this._cursorType&&this._buildCursor(t.type,t.drawSettings),this.container.setStyle?this.container.setStyle("cursor",this._cursorType):this.container.style.setProperty("cursor",this._cursorType)},dispose:function(){this.container=null,this._cursorType=null,this.curBrowser=null,this.currentCurSize=null,this.currentCurFill=null,this.currentCur=null},setTouchCursor:function(t){if(!t||!t.container)return!1;document.getElementById("touchCursor")?(this._cursorSVG=document.getElementById("touchCursor"),this._cursorSVG.lastElementChild&&this._cursorSVG.lastElementChild.remove()):(this._cursorSVG=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._cursorSVG.id="touchCursor",this._cursorSVG.style.zIndex="10",t.container.appendChild(this._cursorSVG)),this._cursorSVG.style.width=null,this._cursorSVG.style.height=null,this._buildTouchCursor(t.type,t.drawSettings,t.position)},deleteTouchCursor:function(){this._cursorSVG&&(this._cursorSVG.lastElementChild&&this._cursorSVG.lastElementChild.remove(),this._cursorSVG.style.width="0px",this._cursorSVG.style.height="0px",this._cursorSVG=null)},_buildTouchCursor:function(t,e,i){var n=e.getEraserThickness();this._cursorSVG.lastElementChild&&this._cursorSVG.lastElementChild.remove(),this._cursorSVG.style.position="absolute",this._cursorSVG.style.left=i[0]-n/2-1+"px",this._cursorSVG.style.top=i[1]-n/2-1+"px";var s=document.createElementNS("http://www.w3.org/2000/svg","circle");s.setAttribute("cx",n/2+1),s.setAttribute("cy",n/2+1),s.setAttribute("r",n/2),s.setAttribute("stroke-width",1),s.setAttribute("stroke","#A3A3A3"),s.setAttribute("style","fill: #FFFFFF; fill-opacity:0.0"),this._cursorSVG.appendChild(s)}})}),define("DS/3DPlayAnnotationUtils/CanvasShapes",["UWA/Class","DS/WebUtils/GeometryUtils","DS/WebUtils/Vector2"],function(t,e,i){"use strict";var n="#D3D3D3",s=.8,o="#00BFFF",a=1;function r(t){var e=t.settings;return{id:Date.now(),type:t.shapeData.type,graphicalProp:{color:e.color,thickness:e.thickness,transparency:e.transparency},linkID:[],data:{}}}function l(t){var e=t.shape.graphicalProp,i=t.canvas.getContext("2d");return t.lowLightMode?(i.strokeStyle=n,i.fillStyle=n,i.globalAlpha=s,i.setLineDash([])):t.editMode?(i.setLineDash([15,10]),i.strokeStyle=o,i.fillStyle=o,i.globalAlpha=a):(i.strokeStyle=e.color,i.fillStyle=e.color,i.globalAlpha=e.transparency,t.transparency&&(i.globalAlpha=t.transparency),i.setLineDash([])),i.lineCap="round",i.lineJoin="round",i.lineWidth=e.thickness*t.scale,i}function h(t,e,i){var n=e.length;t.beginPath(),t.moveTo(e[0].x,e[0].y);for(var s=1;s<n;++s)t.lineTo(e[s].x,e[s].y);i&&t.closePath(),t.stroke()}function p(t,e,i){if(i.indexOf(t)<0){i.push(t);var n=e[t];if(n)for(var s=n.linkID,o=0;o<s.length;++o){p(s[o].id,e,i)}}return i.length>0}var c={createunknownOpen:function(t){var e=r(t),i=t.shapeData;return e.data={path:i},e},drawunknownOpen:function(t){var e=t.shape,i=l(t),n=e.data.path,s=e.data.path.thicknesses;const o=(t,e,i)=>i.indexOf(t)===e;var a=[];if(s&&(a=s.filter(o)),1!==a.length&&s&&n.length-1===s.length){for(var r,p,c=n.length,u=0;u<c-1;++u){(x=[]).push({x:n[u].x*t.scale,y:n[u].y*t.scale}),x.push({x:n[u+1].x*t.scale,y:n[u+1].y*t.scale}),0===u?r=x[0]:c-2===u&&(p=x[1]);var d=s[u];i.lineWidth=d*t.scale,h(i,x,!1)}return{lastPosition:r.x-p.x>=0?r:p}}var x=[];for(c=n.length,u=0;u<c;++u)x.push({x:n[u].x*t.scale,y:n[u].y*t.scale});return h(i,x,!1),{lastPosition:x[0].x-x[c-1].x>=0?x[0]:x[c-1]}},isIntersectunknownOpen:function(t){for(var i=t.shape,n=i.data.path,s=0;s<n.length-1;++s)if(e._isInsidePolygon(n[s],t.referenceShapePath))return i.id;return!1},isOverlapunknownOpen:function(t){for(var i=t.shape,n=i.data.path,s=t.thickness,o=t.point.x,a=t.point.y,r=2*Math.PI/10,l=[],h=0;h<2*Math.PI;h+=r)l.push({x:o+s*Math.cos(h),y:a+s*Math.sin(h)});return!!e.isIntersect(l,n)&&i.id},getDrawPathunknownOpen:function(t){return t.shape.data.path},createline:function(t){for(var e=r(t),n=t.shapeData,s=[],o=0;o<n.length;o++)s.push(new i(n[o].x,n[o].y));return e.data={start:{x:n[0].x,y:n[0].y},end:{x:n[n.length-1].x,y:n[n.length-1].y},path:s},e},drawline:function(t){var e=t.shape,i=l(t),n=[];return n.push({x:e.data.start.x*t.scale,y:e.data.start.y*t.scale}),n.push({x:e.data.end.x*t.scale,y:e.data.end.y*t.scale}),h(i,n,!1),{lastPosition:{x:n[1].x,y:n[1].y}}},isIntersectline:function(t){return c.isIntersectunknownOpen(t)},isOverlapline:function(t){return c.isOverlapunknownOpen(t)},getDrawPathline:function(t){return c.getDrawPathunknownOpen(t)},isIntersectarrowhead:function(t){return c.isIntersectunknownOpen(t)},isOverlaparrowhead:function(t){return c.isOverlapunknownOpen(t)},getDrawPatharrowhead:function(t){return c.getDrawPathunknownOpen(t)},createcircle:function(t){for(var e=r(t),n=t.shapeData,s=[],o=0;o<n.length;o++)s.push(new i(n[o].x,n[o].y));return e.data={radius:n.data.radius,centre:{x:n.data.centre.x,y:n.data.centre.y},path:s},e},drawcircle:function(t){var e=t.shape,i=l(t),n=e.data.centre.x*t.scale,s=e.data.centre.y*t.scale,o=e.data.radius*t.scale;return i.beginPath(),i.arc(n,s,o,0,2*Math.PI),i.stroke(),{lastPosition:{x:n,y:s}}},isIntersectcircle:function(t){for(var i=t.shape,n=i.data.radius,s=i.data.centre.x,o=i.data.centre.y,a=2*Math.PI/300,r=[],l=0;l<2*Math.PI;l+=a)r.push({x:s+n*Math.cos(l),y:o+n*Math.sin(l)});for(var h=0;h<r.length-1;++h)if(e._isInsidePolygon(r[h],t.referenceShapePath))return i.id;return!1},isOverlapcircle:function(t){return c.isOverlapunknownOpen(t)},getDrawPathcircle:function(t){for(var e=t.shape,i=e.data.radius,n=e.data.centre.x,s=e.data.centre.y,o=2*Math.PI/10,a=[],r=0;r<2*Math.PI;r+=o)a.push({x:n+i*Math.cos(r),y:s+i*Math.sin(r)});return a},createellipse:function(t){for(var e=t.shapeData,n=r(t),s=[],o=0;o<e.length;o++)s.push(new i(e[o].x,e[o].y));return n.data={radiusX:e.data.radius1,radiusY:e.data.radius2,centre:{x:e.data.centre.x,y:e.data.centre.y},angle:e.data.angle,path:s},n},drawellipse:function(t){var e=t.shape,i=l(t),n=e.data.centre.x*t.scale,s=e.data.centre.y*t.scale,o=e.data.radiusX*t.scale,a=e.data.radiusY*t.scale,r=e.data.angle*Math.PI/180;return i.save(),i.beginPath(),i.translate(n,s),i.rotate(r),i.translate(-o,-a),i.scale(o,a),i.arc(1,1,1,0,2*Math.PI),i.restore(),i.stroke(),{lastPosition:{x:n,y:s}}},isIntersectellipse:function(t){var i,n=t.shape;i=n.data.path;for(var s=0;s<i.length-1;++s)if(e._isInsidePolygon(i[s],t.referenceShapePath))return n.id;return!1},isOverlapellipse:function(t){return c.isOverlapunknownOpen(t)},getDrawPathellipse:function(t){var e=t.shape,n=e.data.centre.x,s=e.data.centre.y,o=e.data.radiusX,a=e.data.radiusY,r=e.data.angle*Math.PI/180,l=[];return l.push(new i(n+o,s+a).rotateAround({x:n,y:s},r)),l.push(new i(n-o,s+a).rotateAround({x:n,y:s},r)),l.push(new i(n-o,s-a).rotateAround({x:n,y:s},r)),l.push(new i(n+o,s-a).rotateAround({x:n,y:s},r)),l},createpolygon:function(t){var e=t.shapeData,i=r(t);i.data={},i.data.path=[];for(var n=0;n<e.data.vertices.length;++n)i.data.path.push({x:e.data.vertices[n].x,y:e.data.vertices[n].y});return i},drawpolygon:function(t){for(var e=t.shape,i=l(t),n=null,s=null,o=e.data.path,a=[],r=o.length,p=0;p<r;++p)a.push({x:o[p].x*t.scale,y:o[p].y*t.scale}),(null===n||n<a[p].x)&&(n=a[p].x),(null===s||s>a[p].y)&&(s=a[p].y);return h(i,a,!0),{lastPosition:{x:n,y:s}}},isAlignedtoAxis:function(t){var e=!0,i=t.shapeData,n=[],s=t.shapeData.data.vertices,o=(s[1].y-s[0].y)/(s[1].x-s[0].x),a=Math.atan(o),r=180/Math.PI*a;if(r<0&&(r+=360),r>0&&r<6?r=0:r>84&&r<96?r=90:r>174&&r<186?r=180:r>264&&r<276?r=270:r>354?r=360:e=!1,e){var l=function(t,e){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)},h=l(i.data.vertices[1],i.data.vertices[0]),p=l(i.data.vertices[1],i.data.vertices[2]),c=i.data.vertices[0],u=i.data.vertices[2],d={x:(u.x+c.x)/2,y:(u.y+c.y)/2};return 0===r||180===r||360===r?(n.push({x:d.x-.5*h,y:d.y-.5*p}),n.push({x:d.x+.5*h,y:d.y-.5*p}),n.push({x:d.x+.5*h,y:d.y+.5*p}),n.push({x:d.x-.5*h,y:d.y+.5*p})):90!==r&&270!==r||(n.push({x:d.x-.5*p,y:d.y-.5*h}),n.push({x:d.x+.5*p,y:d.y-.5*h}),n.push({x:d.x+.5*p,y:d.y+.5*h}),n.push({x:d.x-.5*p,y:d.y+.5*h})),n}return e},isIntersectpolygon:function(t){for(var i=t.shape,n=i.data.path,s=(n.length,[]),o=0;o<n.length;++o){var a,r=n[o];a=o+1==n.length?n[0]:n[o+1];for(var l=1;l<100;++l)s.push({x:(r.x*(100-l)+a.x*l)/100,y:(r.y*(100-l)+a.y*l)/100})}s.push(n);for(o=0;o<s.length-1;++o)if(e._isInsidePolygon(s[o],t.referenceShapePath))return i.id;return!1},isOverlappolygon:function(t){for(var i=t.shape,n=i.data.path,s=(n.length,[]),o=0;o<n.length;++o){var a,r=n[o];a=o+1==n.length?n[0]:n[o+1];for(var l=1;l<100;++l)s.push({x:(r.x*(100-l)+a.x*l)/100,y:(r.y*(100-l)+a.y*l)/100})}s.push(n);for(var h=t.thickness,p=t.point.x,c=t.point.y,u=2*Math.PI/10,d=[],x=0;x<2*Math.PI;x+=u)d.push({x:p+h*Math.cos(x),y:c+h*Math.sin(x)});return!!e.isIntersect(d,s)&&i.id},getDrawPathpolygon:function(t){return c.getDrawPathunknownOpen(t)},createrectangle:function(t){var e=c.isAlignedtoAxis(t);return e&&(t.shapeData.data.vertices=e),c.createpolygon(t)},drawrectangle:function(t){return c.drawpolygon(t)},isIntersectrectangle:function(t){return c.isIntersectpolygon(t)},isOverlaprectangle:function(t){return c.isOverlappolygon(t)},getDrawPathrectangle:function(t){return c.getDrawPathpolygon(t)},createsquare:function(t){var e=c.isAlignedtoAxis(t);return e&&(t.shapeData.data.vertices=e),c.createpolygon(t)},drawsquare:function(t){return c.drawpolygon(t)},isIntersectsquare:function(t){return c.isIntersectpolygon(t)},isOverlapsquare:function(t){return c.isOverlappolygon(t)},getDrawPathsquare:function(t){return c.getDrawPathpolygon(t)},createtriangle:function(t){return c.createpolygon(t)},drawtriangle:function(t){return c.drawpolygon(t)},isIntersecttriangle:function(t){return c.isIntersectpolygon(t)},isOverlaptriangle:function(t){return c.isOverlappolygon(t)},getDrawPathtriangle:function(t){return c.getDrawPathpolygon(t)},createtext:function(t){var e=r(t);return e.data=t.shapeData,e},drawtext:function(t){var e=t.shape,i=e.data,n=t.angle,s=t.height,o=t.width,a=i.point.x*t.scale,r=i.point.y*t.scale,h=l(t);h.save();var p=n-e.angle;switch(p){case 0:break;case-270:case 90:h.translate(o*t.scale,0),h.rotate(p*Math.PI/180);break;case-180:case 180:h.translate(o*t.scale,s*t.scale),h.rotate(p*Math.PI/180);break;case 270:case-90:h.translate(0,s*t.scale),h.rotate(p*Math.PI/180);break;default:console.log("error in angle")}var c=i.fontSize*t.scale*i.controlScale+'px "3ds"';h.font=c,h.textAlign="center";for(var u=0;u<i.text.length;++u){var d=r+(null==h.measureText(i.text[u]).fontBoundingBoxAscent?h.measureText(i.text[u]).actualBoundingBoxAscent+h.measureText(i.text[u]).actualBoundingBoxDescent:h.measureText(i.text[u]).fontBoundingBoxAscent+h.measureText(i.text[u]).fontBoundingBoxDescent)+u*i.offsetHeight*t.scale*i.controlScale;h.fillText(i.text[u],a,d)}return h.restore(),{lastPosition:{x:a,y:r}}},isIntersecttext:function(t){var i=[];if(t.shape.data.path)i.push({x:t.shape.data.path.topLeft[0],y:t.shape.data.path.topLeft[1]}),i.push({x:t.shape.data.path.topRight[0],y:t.shape.data.path.topRight[1]}),i.push({x:t.shape.data.path.bottomLeft[0],y:t.shape.data.path.bottomLeft[1]}),i.push({x:t.shape.data.path.bottomRight[0],y:t.shape.data.path.bottomRight[1]});else{var n=t.shape.data.point.x,s=t.shape.data.point.y,o=t.shape.data.width,a=t.shape.data.height;i.push({x:n,y:s}),i.push({x:n,y:s+a}),i.push({x:n+o,y:s+a}),i.push({x:n+o,y:s})}for(var r=0;r<i.length-1;++r)if(e._intersect(i[r],i[r+1],t.startPoint,t.endPoint))return t.shape.id;return!1},isOverlaptext:function(t){var i=[];if(t.shape.data.path)i.push({x:t.shape.data.path.topLeft[0],y:t.shape.data.path.topLeft[1]}),i.push({x:t.shape.data.path.topRight[0],y:t.shape.data.path.topRight[1]}),i.push({x:t.shape.data.path.bottomRight[0],y:t.shape.data.path.bottomRight[1]}),i.push({x:t.shape.data.path.bottomLeft[0],y:t.shape.data.path.bottomLeft[1]});else{var n=t.shape.data.point.x-t.shape.data.width/2,s=t.shape.data.point.y,o=t.shape.data.width,a=t.shape.data.height;i.push({x:n,y:s}),i.push({x:n,y:s+a}),i.push({x:n+o,y:s+a}),i.push({x:n+o,y:s})}return!!e._isInsidePolygon(t.point,i)&&t.shape.id},getDrawPathtext:function(t){var e=[];if(t.shape.data.path)e.push({x:t.shape.data.path.topLeft[0],y:t.shape.data.path.topLeft[1]}),e.push({x:t.shape.data.path.topRight[0],y:t.shape.data.path.topRight[1]}),e.push({x:t.shape.data.path.bottomLeft[0],y:t.shape.data.path.bottomLeft[1]}),e.push({x:t.shape.data.path.bottomRight[0],y:t.shape.data.path.bottomRight[1]});else{var i=t.shape.data.point.x,n=t.shape.data.point.y,s=t.shape.data.width,o=t.shape.data.height;e.push({x:i,y:n}),e.push({x:i,y:n+o}),e.push({x:i+s,y:n+o}),e.push({x:i+s,y:n})}return e}};return{createShapeFromJSON:function(t){},createShape:function(t){var e=c["create"+t.shapeData.type];return e||(e=c.createunknownOpen),e(t)},drawShape:function(t){var e=c["draw"+t.shape.type];return e||(e=c.drawunknownOpen),e(t)},isIntersectShape:function(t){var e=c["isIntersect"+t.shape.type];e||(e=c.isIntersectunknownOpen);var i=!1,n=e(t);return n&&(i=[],p(n,t.shapeList,i)),i},isOverlapShape:function(t){var e=c["isOverlap"+t.shape.type];e||(e=c.isOverlapunknownOpen);var i=!1,n=e(t);return n&&(i=[],p(n,t.shapeList,i)),i},getDrawPath:function(t){return(0,c.getDrawPathunknownOpen)(t)}}}),define("DS/3DPlayAnnotationUtils/AnnotationShapeManipulator",["UWA/Class","DS/Core/PointerEvents","DS/VisuEvents/EventsManager","DS/WebSystem/Environment","DS/WebUtils/Vector2","DS/WebInfraUI/FloatingBarManager"],function(t,e,i,n,s,o){"use strict";var a=["Bottom","Top","Left","Right","Center","TopLeft","TopRight","BottomLeft","BottomRight","Rotate"];return t.extend({init:function(t){this._parent(t),this._mapipulatorElements=[],this._bBoxElement=void 0,this._bBoxRotateElement=void 0,this.viewer=t.viewer,this.frameWindow=t.frameWindow,this.eventTarget=t.eventTarget,this.beginMove=t.beginMove,this.move=t.move,this.endMove=t.endMove,this.cancel=t.onCancel,this.startShapeEdit=t.startShapeEdit,this.editShape=t.editShape,this.endShapeEdit=t.endShapeEdit,this.onTap=t.onTap,this.mouseLeave=t.mouseLeave,this.context=t.context,this.coordinateScaling=t.coordinateScaling,this.floatingbarCallback=t.floatingbarCallback,this.floatingBarContainer=t.floatingBarContainer,this.manipulation=!1,this.manipulatorType="",this.touchStartBind=this._ontouchstart.bind(this),this.touchMoveBind=this._ontouchmove.bind(this),this.touchEndBind=this._ontouchend.bind(this),this.eventTarget.addEventListener("touchstart",this.touchStartBind,!0),this.eventTarget.addEventListener("touchmove",this.touchMoveBind,!0),this.eventTarget.addEventListener("touchend",this.touchEndBind,!0),this.onTap&&(this.tapBind=this._onTap.bind(this)),this.beginManipulateBind=this._beginManipulate.bind(this),this.manipulateBind=this._manipulate.bind(this),this.endManipulateBind=this._endManipulate.bind(this),this.shapeManipulatorEnterBind=this._shapeManipulatorEnter.bind(this),this.shapeManipulatorLeaveBind=this._shapeManipulatorLeave.bind(this),this.onTap&&i.addEvent(this.eventTarget,"onTap",this.tapBind),i.addEvent(this.eventTarget,"onLeftMouseDown",this.beginManipulateBind),i.addEvent(this.eventTarget,"onMouseMove",this.manipulateBind),i.addEvent(this.eventTarget,"onLeftMouseUp",this.endManipulateBind),this.eventTarget.addEventListener("mouseenter",this.shapeManipulatorEnterBind,!0),this.eventTarget.addEventListener("mouseleave",this.shapeManipulatorLeaveBind,!0)},destroy:function(){this.eventTarget.removeEventListener("touchstart",this.touchStartBind,!0),this.eventTarget.removeEventListener("touchmove",this.touchMoveBind,!0),this.eventTarget.removeEventListener("touchend",this.touchEndBind,!0),this.onTap&&i.removeEvent(this.eventTarget,"onTap",this.tapBind),i.removeEvent(this.eventTarget,"onLeftMouseDown",this.beginManipulateBind),i.removeEvent(this.eventTarget,"onMouseMove",this.manipulateBind),i.removeEvent(this.eventTarget,"onLeftMouseUp",this.endManipulateBind),this.eventTarget.removeEventListener("mouseenter",this.shapeManipulatorEnterBind,!0),this.eventTarget.removeEventListener("mouseleave",this.shapeManipulatorLeaveBind,!0),this.cleanManipulators(),this.viewer=void 0,this.eventTarget=void 0},createManipulators:function(t){this.cleanManipulators();var e,n,s={x:(t.bbox[3].x+t.bbox[2].x)/2,y:(t.bbox[3].y+t.bbox[2].y)/2},r={x:(t.bbox[0].x+t.bbox[1].x)/2,y:(t.bbox[0].y+t.bbox[1].y)/2},l=(t.bbox[0].x+t.bbox[3].x)/2,h=(t.bbox[0].y+t.bbox[3].y)/2,p=(t.bbox[2].x+t.bbox[1].x)/2,c=(t.bbox[2].y+t.bbox[1].y)/2,u=(t.bbox[3].x+t.bbox[1].x)/2,d=(t.bbox[3].y+t.bbox[1].y)/2,x=t.bbox[2].y-t.bbox[1].y,g=t.bbox[1].x-t.bbox[0].x;1==t.flipRotatePosition?((e={x:(t.bbox[2].x+t.bbox[3].x)/2,y:(t.bbox[2].y+t.bbox[3].y)/2}).y=e.y+30,n=s):((e={x:(t.bbox[0].x+t.bbox[1].x)/2,y:(t.bbox[0].y+t.bbox[1].y)/2}).y=e.y-30,n=r);var m,y=0;(x<=30||g<=30)&&(y=-7.5);for(var f=0;f<a.length;f++){var v,b,w;if("Bottom"==a[f]?(v=s.y-7.5,b=s.x-7.5):"Top"==a[f]?(v=r.y-7.5,b=r.x-7.5):"Left"==a[f]?(v=h-7.5,b=l-7.5):"Right"==a[f]?(v=c-7.5,b=p-7.5):"Center"==a[f]?(v=d-x/2+7.5+y,b=u-g/2+7.5+y):"TopLeft"==a[f]?(v=t.bbox[0].y-7.5,b=t.bbox[0].x-7.5):"TopRight"==a[f]?(v=t.bbox[1].y-7.5,b=t.bbox[1].x-7.5):"BottomLeft"==a[f]?(v=t.bbox[3].y-7.5,b=t.bbox[3].x-7.5):"BottomRight"==a[f]?(v=t.bbox[2].y-7.5,b=t.bbox[2].x-7.5):"Rotate"==a[f]&&(v=e.y-7.5,b=e.x-7.5),"Center"==a[f])w=new UWA.Element("div",{id:"manipulator-"+a[f],context:this.context,styles:{height:x-15-2*y+"px",width:g-15-2*y+"px",position:"absolute",top:v+"px",left:b+"px","background-color":"transparent","z-index":7}}).inject(t.container);else{w=new UWA.Element("div",{id:"manipulator-"+a[f]+"manipulator-shell",context:this.context,styles:{height:"30px",width:"30px",position:"absolute",top:v-7.5+"px",left:b-7.5+"px","border-radius":"50%","z-index":7}}).inject(t.container);new UWA.Element("div",{id:"manipulator-"+a[f],context:this.context,styles:{height:"15px",width:"15px",position:"relative",top:"7.5px",left:"7.5px","border-radius":"50%","background-color":"white",border:"2px solid","border-color":"rgba(54,142,196, 1)","z-index":7}}).inject(w)}this._mapipulatorElements.push(w),this.shapeEditBind=this._beginShapeEdit.bind(this),i.addEvent(w,"onLeftMouseDown",this.shapeEditBind)}this._bBoxElement=new UWA.Element("div",{id:"bBoxOutlineMain",context:this.context,styles:{height:x+"px",width:g+"px",position:"absolute",top:t.bbox[0].y+"px",left:t.bbox[0].x+"px",border:"2px solid","border-color":"rgba(54,142,196, 1)",outline:"solid","outline-width":"1px","outline-color":"rgba(255,255,255,1)","z-index":6}}).inject(t.container),m=1==t.flipRotatePosition?n:e,this._bBoxRotateElement=new UWA.Element("div",{id:"bBoxOutlinerotate",context:this.context,styles:{height:Math.abs(e.y-n.y)+"px",width:"0px",position:"absolute",top:m.y-1+"px",left:m.x-1+"px","border-left":"2px solid","border-color":"rgba(54,142,196, 1)",outline:"solid","outline-width":"1px","outline-color":"rgba(255,255,255,1)","z-index":6}}).inject(t.container);var C=0,T=0,S=0;1==t.flipRotatePosition?T=30:(C=-30,t.bbox[0].y+C<=57&&(T=30)),this.floatingBarContainer!=t.container&&(C+=parseFloat(t.container.style.top),S+=parseFloat(t.container.style.left)),this.bar=new o({frameWindow:this.frameWindow,container:this.floatingBarContainer}),this.bar.addCommands([{id:"Color3DPlay",color:t.color,onclick:this.floatingbarCallback},{id:"Delete3DPlay",onclick:this.floatingbarCallback}],{top:t.bbox[0].y+C,left:t.bbox[0].x+S,height:x+T,width:g,defaultAlignment:"right"})},moveManipulators:function(t){this.bar&&(this.bar.dispose(),this.bar=void 0);var e,i,n={x:(t.bbox[3].x+t.bbox[2].x)/2,y:(t.bbox[3].y+t.bbox[2].y)/2},s={x:(t.bbox[0].x+t.bbox[1].x)/2,y:(t.bbox[0].y+t.bbox[1].y)/2},o=(t.bbox[0].x+t.bbox[3].x)/2,r=(t.bbox[0].y+t.bbox[3].y)/2,l=(t.bbox[2].x+t.bbox[1].x)/2,h=(t.bbox[2].y+t.bbox[1].y)/2,p=(t.bbox[3].x+t.bbox[1].x)/2,c=(t.bbox[3].y+t.bbox[1].y)/2,u=t.bbox[2].y-t.bbox[1].y,d=t.bbox[1].x-t.bbox[0].x;1==t.flipRotatePosition?((e={x:(t.bbox[2].x+t.bbox[3].x)/2,y:(t.bbox[2].y+t.bbox[3].y)/2}).y=e.y+30,i=n):((e={x:(t.bbox[0].x+t.bbox[1].x)/2,y:(t.bbox[0].y+t.bbox[1].y)/2}).y=e.y-30,i=s);var x,g=0;(u<=30||d<=30)&&(g=-7.5);for(var m=0;m<a.length;m++){var y,f;"Bottom"==a[m]?(y=n.y-7.5,f=n.x-7.5):"Top"==a[m]?(y=s.y-7.5,f=s.x-7.5):"Left"==a[m]?(y=r-7.5,f=o-7.5):"Right"==a[m]?(y=h-7.5,f=l-7.5):"Center"==a[m]?(y=c-u/2+7.5+g,f=p-d/2+7.5+g):"TopLeft"==a[m]?(y=t.bbox[0].y-7.5,f=t.bbox[0].x-7.5):"TopRight"==a[m]?(y=t.bbox[1].y-7.5,f=t.bbox[1].x-7.5):"BottomLeft"==a[m]?(y=t.bbox[3].y-7.5,f=t.bbox[3].x-7.5):"BottomRight"==a[m]?(y=t.bbox[2].y-7.5,f=t.bbox[2].x-7.5):"Rotate"==a[m]&&(y=e.y-7.5,f=e.x-7.5);var v=this._mapipulatorElements[m];if(v.childNodes.length){v.style.setProperty("top",y-7.5+"px"),v.style.setProperty("left",f-7.5+"px"),v.childNodes[0].style.setProperty("top","7.5px"),v.childNodes[0].style.setProperty("left","7.5px")}else v.style.setProperty("top",y+"px"),v.style.setProperty("left",f+"px")}this._bBoxElement.style.setProperty("height",u+"px"),this._bBoxElement.style.setProperty("width",d+"px"),this._bBoxElement.style.setProperty("top",t.bbox[0].y+"px"),this._bBoxElement.style.setProperty("left",t.bbox[0].x+"px"),x=1==t.flipRotatePosition?i:e,this._bBoxRotateElement.style.setProperty("height",Math.abs(e.y-i.y)+"px"),this._bBoxRotateElement.style.setProperty("top",x.y-1+"px"),this._bBoxRotateElement.style.setProperty("left",x.x-1+"px")},moveRotateManipulators:function(t){this.bar&&(this.bar.dispose(),this.bar=void 0);var e=t.y-15,i=t.x-15;(s=this._mapipulatorElements[9]).style.setProperty("top",e+"px"),s.style.setProperty("left",i+"px");for(var n=0;n<a.length;n++){var s;if("Rotate"!=a[n])(s=this._mapipulatorElements[n]).style.setProperty("display","none")}this._bBoxElement.style.setProperty("display","none"),this._bBoxRotateElement.style.setProperty("display","none")},cleanManipulators:function(){for(var t=0;t<this._mapipulatorElements.length;t++)i.removeEvent(this._mapipulatorElements[t],"onLeftMouseDown",this.shapeEditBind),this._mapipulatorElements[t].remove();this._mapipulatorElements=[],this._bBoxElement&&this._bBoxElement.remove(),this._bBoxRotateElement&&this._bBoxRotateElement.remove(),this.manipulation=!1,this.manipulatorType="",this.bar&&(this.bar.dispose(),this.bar=void 0)},_beginManipulate:function(t){if(!this.frameWindow.getViewer().checkContext||this.frameWindow.getViewer().checkContext(t)){var e=t;t.gesture&&(e=t.gesture.events[0].event);var i=!1;if(e&&e.path&&e.path.length){for(var n=0;n<e.path.length;n++)if("CAT3DPlay-FloatingMenuContainer"==e.path[n].className||"ContextualBar_Panel"==e.path[n].className||"play3d-annot-palette"==e.path[n].className||"play3d-annot-colorButton"==e.path[n].className){i=!0;break}}else for(var s=e.target;s;){if("CAT3DPlay-FloatingMenuContainer"==s.className||"ContextualBar_Panel"==s.className||"play3d-annot-palette"==s.className||"play3d-annot-colorButton"==s.className){i=!0;break}s=s.parentElement}if(0==i){e.preventDefault&&e.preventDefault();var o=!1,r=e.target.id.split("manipulator-");if(r&&r.length>=2){var l=r[1];a.indexOf(l>=0)&&(o=!0)}0==o&&this.beginMove(e)}}},_manipulate:function(t){if(!this.frameWindow.getViewer().checkContext||this.frameWindow.getViewer().checkContext(t))if(0==this.manipulation){var e=t;t.gesture&&(e=t.gesture.events[0].event),e.preventDefault&&e.preventDefault(),this.move(e)}else{e=t;if(t.gesture&&(e=t.gesture.events[0].event),e.preventDefault&&e.preventDefault(),this.manipulation&&e){var i,n,o,a,r,l,h,p,c,u=this.coordinateScaling(e),d=u.x,x=u.y;if("Bottom"==this.manipulatorType||"Top"==this.manipulatorType)"Bottom"==this.manipulatorType?(r="BottomWithCenter",i=parseFloat(this._mapipulatorElements[0].style.left)+15,n=parseFloat(this._mapipulatorElements[0].style.top)+15,l=this._mapipulatorElements[0].style.getPropertyValue("cursor")):(r="TopWithCenter",i=parseFloat(this._mapipulatorElements[1].style.left)+15,n=parseFloat(this._mapipulatorElements[1].style.top)+15,l=this._mapipulatorElements[1].style.getPropertyValue("cursor"));else if("Left"==this.manipulatorType||"Right"==this.manipulatorType)"Left"==this.manipulatorType?(r="LeftWithCenter",i=parseFloat(this._mapipulatorElements[2].style.left)+15,n=parseFloat(this._mapipulatorElements[2].style.top)+15,l=this._mapipulatorElements[2].style.getPropertyValue("cursor")):(r="RightWithCenter",i=parseFloat(this._mapipulatorElements[3].style.left)+15,n=parseFloat(this._mapipulatorElements[3].style.top)+15,l=this._mapipulatorElements[3].style.getPropertyValue("cursor"));else if("TopLeft"==this.manipulatorType||"BottomRight"==this.manipulatorType)"TopLeft"==this.manipulatorType?(r="LeftWithTop",i=parseFloat(this._mapipulatorElements[5].style.left)+15,n=parseFloat(this._mapipulatorElements[5].style.top)+15,l=this._mapipulatorElements[5].style.getPropertyValue("cursor")):(r="RightWithBottom",i=parseFloat(this._mapipulatorElements[8].style.left)+15,n=parseFloat(this._mapipulatorElements[8].style.top)+15,l=this._mapipulatorElements[8].style.getPropertyValue("cursor"));else if("TopRight"==this.manipulatorType||"BottomLeft"==this.manipulatorType)"TopRight"==this.manipulatorType?(r="RightWithTop",i=parseFloat(this._mapipulatorElements[6].style.left)+15,n=parseFloat(this._mapipulatorElements[6].style.top)+15,l=this._mapipulatorElements[6].style.getPropertyValue("cursor")):(r="LeftWithBottom",i=parseFloat(this._mapipulatorElements[7].style.left)+15,n=parseFloat(this._mapipulatorElements[7].style.top)+15,l=this._mapipulatorElements[7].style.getPropertyValue("cursor"));else if("Center"==this.manipulatorType)i=parseFloat(this._mapipulatorElements[4].style.left)+parseFloat(this._mapipulatorElements[4].style.width)/2,n=parseFloat(this._mapipulatorElements[4].style.top)+parseFloat(this._mapipulatorElements[4].style.height)/2,r="BothWithCenter",l=this._mapipulatorElements[4].style.getPropertyValue("cursor");else if("Rotate"==this.manipulatorType){i=parseFloat(this._mapipulatorElements[9].style.left)+15,n=parseFloat(this._mapipulatorElements[9].style.top)+15,r="Rotate";var g=parseFloat(this._mapipulatorElements[4].style.left)+parseFloat(this._mapipulatorElements[4].style.width)/2,m=parseFloat(this._mapipulatorElements[4].style.top)+parseFloat(this._mapipulatorElements[4].style.height)/2,y=new s(i-g,n-m),f=y.angle();h=new s(d-g,x-m).angle()-f,y.rotateAround({x:0,y:0},h),p=y.x+g,c=y.y+m}"Rotate"!=this.manipulatorType&&(o=d-i,a=x-n),this.editShape({event:e,deltaX:o,deltaY:a,deltaType:r,cursor:l,deltaAngle:h,finalX:p,finalY:c})}}},_endManipulate:function(t){if(!this.frameWindow.getViewer().checkContext||this.frameWindow.getViewer().checkContext(t))if(0==this.manipulation){var e=t;t.gesture&&(e=t.gesture.events[0].event),e.preventDefault&&e.preventDefault(),this.endMove(e)}else{var i;e=t;if(t.gesture&&(e=t.gesture.events[0].event),e.preventDefault&&e.preventDefault(),this.manipulation&&e)"Bottom"==this.manipulatorType||"Top"==this.manipulatorType?i="Bottom"==this.manipulatorType?"BottomWithCenter":"TopWithCenter":"Left"==this.manipulatorType||"Right"==this.manipulatorType?i="Left"==this.manipulatorType?"LeftWithCenter":"RightWithCenter":"TopLeft"==this.manipulatorType||"BottomRight"==this.manipulatorType?i="TopLeft"==this.manipulatorType?"LeftWithTop":"RightWithBottom":"TopRight"==this.manipulatorType||"BottomLeft"==this.manipulatorType?i="TopRight"==this.manipulatorType?"RightWithTop":"LeftWithBottom":"Center"==this.manipulatorType?i="BothWithCenter":"Rotate"==this.manipulatorType&&(i="Rotate"),this.manipulation=!1,this.manipulatorType="",this.endShapeEdit({deltaType:i})}},_isPalm:function(t){if(!this.frameWindow.getViewer().checkContext||this.frameWindow.getViewer().checkContext(t)){if(t&&t.touches&&t.touches.length>0){var e=t.touches[0];if(e.radiusX>35||e.radiusY>35)return!0}return!1}},_ontouchstart:function(t){if(!this.frameWindow.getViewer().checkContext||this.frameWindow.getViewer().checkContext(t))if(t.preventDefault&&t.preventDefault(),1===t.touches.length){var e=!1;if(t&&t.path&&t.path.length){for(var i=0;i<t.path.length;i++)if("CAT3DPlay-FloatingMenuContainer"==t.path[i].className||"ContextualBar_Panel"==t.path[i].className||"play3d-annot-palette"==t.path[i].className||"play3d-annot-colorButton"==t.path[i].className){e=!0;break}}else for(var n=t.target;n;){if("CAT3DPlay-FloatingMenuContainer"==n.className||"ContextualBar_Panel"==n.className||"play3d-annot-palette"==n.className||"play3d-annot-colorButton"==n.className){e=!0;break}n=n.parentElement}if(0==e&&!this._isPalm(t)){var s=t.touches[0],o=!1,r=s.target.id.split("manipulator-");if(r&&r.length>=2){var l=r[1];a.indexOf(l>=0)&&(o=!0)}!1===o?this._beginManipulate(s):this._beginShapeEdit(s)}}else this.cancel&&this.cancel()},_ontouchmove:function(t){if(!this.frameWindow.getViewer().checkContext||this.frameWindow.getViewer().checkContext(t))if(t.preventDefault&&t.preventDefault(),t.touches&&1===t.touches.length&&!this._isPalm(t)){var e=t.touches[0],i=!1,n=e.target.id.split("manipulator-");if(n&&n.length>=2){var s=n[1];a.indexOf(s>=0)&&(i=!0)}!1===this.manipulation&&!0===i||this._manipulate(e)}else this.cancel&&this.cancel()},_ontouchend:function(t){if(!this.frameWindow.getViewer().checkContext||this.frameWindow.getViewer().checkContext(t))if(t.preventDefault&&t.preventDefault(),t.touches&&0===t.touches.length&&1===t.changedTouches.length&&!this._isPalm(t)){var e=t.changedTouches[0],i=e.target.id.split("manipulator-");if(i&&i.length>=2){var n=i[1];a.indexOf(n>=0)&&!0}this._endManipulate(e)}else this.cancel&&this.cancel()},_onTap:function(t){if(!this.frameWindow.getViewer().checkContext||this.frameWindow.getViewer().checkContext(t)){var e=t.gesture.events[0].event;e.preventDefault&&e.preventDefault(),this.onTap(e.changedTouches[0])}},_beginShapeEdit:function(t){var e,i,n=t;t.gesture&&(n=t.gesture.events[0].event),n.preventDefault&&n.preventDefault(),this.manipulation=!0,this.manipulatorType=n.target.id.split("manipulator-")[1],"Bottom"==this.manipulatorType||"Top"==this.manipulatorType?"Bottom"==this.manipulatorType?(e=this._mapipulatorElements[0].style.getPropertyValue("cursor"),i="BottomWithCenter"):(e=this._mapipulatorElements[1].style.getPropertyValue("cursor"),i="topWithCenter"):"Left"==this.manipulatorType||"Right"==this.manipulatorType?"Left"==this.manipulatorType?(e=this._mapipulatorElements[2].style.getPropertyValue("cursor"),i="LeftWithCenter"):(e=this._mapipulatorElements[3].style.getPropertyValue("cursor"),i="RightWithCenter"):"TopLeft"==this.manipulatorType||"BottomRight"==this.manipulatorType?"TopLeft"==this.manipulatorType?(e=this._mapipulatorElements[5].style.getPropertyValue("cursor"),i="LeftWithTop"):(e=this._mapipulatorElements[8].style.getPropertyValue("cursor"),i="RightWithBottom"):"TopRight"==this.manipulatorType||"BottomLeft"==this.manipulatorType?"TopRight"==this.manipulatorType?(e=this._mapipulatorElements[6].style.getPropertyValue("cursor"),i="RightWithTop"):(e=this._mapipulatorElements[7].style.getPropertyValue("cursor"),i="LeftWithBottom"):"Center"==this.manipulatorType?(e=this._mapipulatorElements[4].style.getPropertyValue("cursor"),i="BothWithCenter"):"Rotate"==this.manipulatorType&&(e=this._mapipulatorElements[9].style.getPropertyValue("cursor"),i="Rotate"),this.startShapeEdit({cursor:e,deltaType:i})},_shapeManipulatorEnter:function(t){if((!this.frameWindow.getViewer().checkContext||this.frameWindow.getViewer().checkContext(t))&&t.target){var e,i=!1,n=t.target.id.split("manipulator-");if(n&&n.length>=2){var s=n[1];a.indexOf(s>=0)&&(i=!0)}if(i&&0==this.manipulation)e="Bottom"==t.target.id.split("manipulator-")[1]||"Top"==t.target.id.split("manipulator-")[1]?"ns-resize":"Left"==t.target.id.split("manipulator-")[1]||"Right"==t.target.id.split("manipulator-")[1]?"ew-resize":"TopLeft"==t.target.id.split("manipulator-")[1]||"BottomRight"==t.target.id.split("manipulator-")[1]?"nwse-resize":"TopRight"==t.target.id.split("manipulator-")[1]||"BottomLeft"==t.target.id.split("manipulator-")[1]?"nesw-resize":"Center"==t.target.id.split("manipulator-")[1]?"move":"Rotate"==t.target.id.split("manipulator-")[1]?"grabbing":"auto",t.target.style.setProperty("cursor",e)}},_shapeManipulatorLeave:function(t){if(!this.frameWindow.getViewer().checkContext||this.frameWindow.getViewer().checkContext(t)){var e,i=!1;if(t.toElement?e=t.toElement:t.relatedTarget&&(e=t.relatedTarget),e){if((p=e.id.split("manipulator-"))&&p.length>=2){var n=p[1];a.indexOf(n>=0)&&(i=!0)}(c=e.id.split("bBoxOutline"))&&c.length>=2&&(i=!0)}var s=!1;if(t.path&&t.path.length){for(var o=0;o<t.path.length;o++)if(this.eventTarget==t.path[o]){s=!0;break}}else for(var r=t.target;r;){if(this.eventTarget==r){s=!0;break}r=r.parentElement}var l=!1,h=!1;if(t.target){var p,c;if((p=t.target.id.split("manipulator-"))&&p.length>=2){n=p[1];a.indexOf(n>=0)&&(l=!0)}(c=t.target.id.split("bBoxOutline"))&&c.length>=2&&(h=!0)}i&&s&&0==l||t.target&&(l||h?0==this.manipulation&&t.target.style.setProperty("cursor","auto"):this.mouseLeave(t))}}})}),define("DS/3DPlayAnnotationUtils/AnnotationText",["UWA/Core","UWA/Controls/Abstract","css!DS/3DPlayAnnotationUtils/AnnotationText","DS/WebSystem/Nls","DS/CoreEvents/Events","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/Core/PointerEvents","DS/VisuEvents/EventsManager","DS/WebUtils/GeometryUtils","DS/3DPlayAnnotationUtils/ShapeUtils","DS/WebSystem/Environment","DS/WebInfraUI/FloatingBarManager","i18n!DS/3DPlayAnnotationUtils/assets/nls/3DPlayAnnotation"],function(t,e,i,n,s,o,a,r,l,h,p,c,u){"use strict";var d;return e.extend({defaultOptions:{className:"SmartAnnot3DPlayWebTextControl",canvas:null},mScale:1,boundingLimits:{top:void 0,left:void 0,width:void 0,height:void 0},size:{height:void 0,width:void 0,maxHeight:void 0,maxWidth:void 0},containerSize:{height:void 0,width:void 0,maxHeight:void 0,maxWidth:void 0},position:{x:void 0,y:void 0},init:function(e){this._parent(e),this.index=e.index?e.index:0,this.viewer=e.viewer,this.viewerScale=this.viewer.getCurrentZoomScale?this.viewer.getCurrentZoomScale():1,this.proportion=1/this.viewerScale,this.viewerScale=1,this.mode=e.mode,this.textEdit=!1,this.floatingbarCallback=e.floatingbarCallback,this.floatingBarContainer=e.floatingBarContainer,this.listnerContainer=e.listnerContainer,e.container?this.container=e.container:e.frameWindow&&(this.container=new t.Element("div",{id:"outerContainer",class:"textAnnot3DPlay-outerContainer",styles:{position:"absolute",top:"0px",left:"0px",height:"100%",width:"100%"}}).inject(e.viewerFrame)),this.onTypeStartCB=e.onTypeStartCB,this.drawSettings=new o,this._buildUI(e.containerStyle,e.data),e.disabled?(this.disable(),this.disabled=!0):(this.disabled=!1,this.setFocus()),this.defaultPos={top:"22%",left:"40%"}},destroy:function(){this.container&&(this.container.removeEventListener("pointerup",this.bindStopDragResizeHandler),this.container.removeEventListener("pointermove",this.bindDragResizeHandler),this.container.removeEventListener("touchend",this.bindStopDragResizeHandler),this.container.removeEventListener("touchmove",this.bindTouchDragResizeHandler),this.container.removeEventListener("mouseup",this.bindStopDragResizeHandler),this.container.removeEventListener("mousemove",this.bindDragResizeHandler),this.container.removeEventListener("mouseup",this.bindParentMouseUp),this.container.removeEventListener("mousemove",this.bindParentMove)),this._unSubscribeListners(),s.unsubscribe(this.tokenSettingsChanged),this.textContainer&&(this.textContainer.destroy(),this.textContainer=void 0),this.dummyContainer&&(this.dummyContainer.destroy(),this.dummyContainer=void 0),!document.getElementById("outerContainer")||document.getElementById("outerContainer").destroy(),this.container=void 0,this.onTypeStartCB=void 0,this.drawSettings=void 0,this.bar&&(this.bar.dispose(),this.bar=void 0)},_setTextProperties:function(t){var e;t?(this.elements.textAreaField.style.color=t.color,this.elements.textAreaField.style["caret-color"]=t.color,100*(parseInt(t.thickness)-3),e=t.color):(this.elements.textAreaField.style.color=this.drawSettings.getColor(),100*(parseInt(this.drawSettings.getThickness())-3),e=this.drawSettings.getColor()),this._setPlaceHolderColor(e)},_setTextPropertiesForEdit:function(t){var e;if(t)if(t.annotationData&&t.annotationData.data){var i=1;"video"===this.mode?i=this.viewer.scale:void 0!==t.pageNumber&&(i=this.viewer.getPageFromNumber(t.pageNumber).getScale()),this.elements.textAreaField.style.color=t.annotationData.graphicalProp.color,e=t.annotationData.graphicalProp.color;t.annotationData.graphicalProp.thickness}else if("3D"===this.mode&&t.annotationData){e=t.annotationData.graphicalProp.color,this.elements.textAreaField.style.color=t.annotationData.graphicalProp.color;parseInt(this.drawSettings.getThickness())}this._setPlaceHolderColor(e)},_setPlaceHolderColor:function(t){for(var e="",i=[{value:"#FF0000",colorName:"red"},{value:"#FF9900",colorName:"orange"},{value:"#FFFF00",colorName:"yellow"},{value:"#00CC00",colorName:"green"},{value:"#0033CC",colorName:"blue"},{value:"#660099",colorName:"purple"},{value:"#000000",colorName:"black"},{value:"#FFFFFF",colorName:"white"}],n=0;n<i.length;n++)if(i[n].value===t.toUpperCase()){e=i[n].colorName;break}for(n=0;n<i.length;n++){var s="CAT3DPlay"+i[n].colorName;this.elements.textAreaField.hasClassName(s)&&this.elements.textAreaField.removeClassName(s)}var o="CAT3DPlay"+e;this.elements.textAreaField.addClassName(o)},_buildUI:function(e,i){var n=this.container.clientWidth,o=this.container.clientHeight;this.options.x||Math.round(.4*n),this.options.y||Math.round(.3*o);this.placeHolderText="New text",this.cancelText="Cancel",this.validateText="Validate",this.nextText="Next",void 0!==u&&void 0!==u.PlaceHolder&&""!==u.PlaceHolder&&(this.placeHolderText=u.PlaceHolder),this.elements&&this.elements.mBlankText&&this.elements.mBlankText.setHTML(this.placeHolderText),void 0!==u&&void 0!==u.cancelText&&""!==u.cancelText&&(this.cancelText=u.cancelText),this.elements&&this.elements.cancelSpanElement&&this.elements.cancelSpanElement.setHTML(this.cancelText),void 0!==u&&void 0!==u.validateText&&""!==u.validateText&&(this.validateText=u.validateText),this.elements&&this.elements.validateSpanElement&&this.elements.validateSpanElement.setHTML(this.validateText),void 0!==u&&void 0!==u.nextText&&""!==u.nextText&&(this.nextText=u.nextText),this.elements&&this.elements.nextSpanElement&&this.elements.nextSpanElement.setHTML(this.nextText),this.dummyContainer=new t.Element("div",{id:"dummycontainer"+this.index,styles:{position:"absolute",top:"0px",left:"0px",height:"100%",width:"100%","pointer-events":"auto","z-index":3}}).inject(this.container),this._buildDesktopUI(n,o,i),this.textContainer.inject(this.dummyContainer),i?this._setTextPropertiesForEdit(i):this._setTextProperties(),this.tokenSettingsChanged=s.subscribe({event:"3DPlay.Annotation.SettingsChanged"},function(t){this._setTextProperties(t)}.bind(this)),this._exp&&!1===this._exp.collabMode?this.textContainer.contentEditable=!1:this._subscribeListners(),this.controlsHidden=!1,this.reallyDragged=!1},_buildDesktopUI:function(e,i,n){this.textContainer=new t.Element("div",{id:"textAnnot3DPlay-editor-text-container-"+this.index,class:"textAnnot3DPlay-editor-text-container",styles:{height:"36px",width:"110px"}}),this.textContainerLower=new t.Element("div",{id:"textAnnot3DPlay-editor-text-container-Lower"+this.index,class:"textAnnot3DPlay-editor-text-container-lower",styles:{height:"36px"}}).inject(this.textContainer),this.elements.textAreaField=new t.Element("textarea",{class:"textAnnot3DPlay-text-field",id:"editor-field-textArea",WRAP:"hard",rows:"1",placeholder:this.placeHolderText,autofocus:"autofocus",readonly:!0,styles:{pointerEvents:"none","text-align":"center",height:"auto",width:"90px","min-width":Math.min(100,e-20)+"px"}}).inject(this.textContainerLower),this.elements.bottomRightResizeHandler=new t.Element("div",{id:"textAnnot3DPlay-resize-handler-bottom-right-"+this.index,class:"textAnnot3DPlay-resize-handler",styles:{right:"-11.5px",bottom:"-11.5px"}}).inject(this.textContainer),this.elements.resizeHandlerArrow=new t.Element("div",{class:"textAnnot3DPlay-resize-image textAnnot3DPlay-resize-cursor1"}).inject(this.elements.bottomRightResizeHandler),this.elements.topLeftResizeHandler=new t.Element("div",{id:"textAnnot3DPlay-resize-handler-top-left-"+this.index,class:"textAnnot3DPlay-resize-handler",styles:{top:"-16px",left:"-15px"}}).inject(this.textContainer),this.elements.resizeHandlerArrow2=new t.Element("div",{class:"textAnnot3DPlay-resize-image textAnnot3DPlay-resize-cursor2"}).inject(this.elements.topLeftResizeHandler),this.elements.topRightResizeHandler=new t.Element("div",{id:"textAnnot3DPlay-resize-handler-top-right-"+this.index,class:"textAnnot3DPlay-resize-handler",styles:{right:"-11.5px",top:"-15px"}}).inject(this.textContainer),this.elements.resizeHandlerArrow3=new t.Element("div",{class:"textAnnot3DPlay-resize-image textAnnot3DPlay-resize-cursor3"}).inject(this.elements.topRightResizeHandler),this.elements.bottomLeftResizeHandler=new t.Element("div",{id:"textAnnot3DPlay-resize-handler-bottom-left-"+this.index,class:"textAnnot3DPlay-resize-handler textAnnot3DPlay-resize-cursor4",styles:{left:"-15px",bottom:"-11.5px"}}).inject(this.textContainer),this.elements.resizeHandlerArrow4=new t.Element("div",{class:"textAnnot3DPlay-resize-image"}).inject(this.elements.bottomLeftResizeHandler)},_subscribeListners:function(){this._subscribeListnersDesktop()},_subscribeListnersDesktop:function(){this.dragPointerDown=function(t){this.mDragging=!0,this.reallyDragged=!1,this.startDragPosition={x:t.clientX-this.dummyContainer.offsetLeft,y:t.clientY-this.dummyContainer.offsetTop},d={x:t.clientX-this.dummyContainer.offsetLeft,y:t.clientY-this.dummyContainer.offsetTop}}.bind(this),this.bindKeyDown=this.keyDownListner.bind(this),this.bindKeyUp=this.keyUpListner.bind(this),this.elements.textAreaField.addEventListener("keydown",this.bindKeyDown),this.elements.textAreaField.addEventListener("keyup",this.bindKeyUp),this.pointerDown=function(t){if(t&&t.path&&t.path.length)for(var e=0;e<t.path.length;e++){if(this.elements.bottomRightResizeHandler===t.path[e]){this.onDownResizeHandler(t,1);break}if(this.elements.topLeftResizeHandler===t.path[e]){this.onDownResizeHandler(t,2);break}if(this.elements.topRightResizeHandler===t.path[e]){this.onDownResizeHandler(t,3);break}if(this.elements.bottomLeftResizeHandler===t.path[e]){this.onDownResizeHandler(t,4);break}if(this.elements.textAreaField===t.path[e])break;if(this.textContainer===t.path[e]){this.textEdit&&t.touchFlag||this.dragPointerDown(t);break}if("CAT3DPlay-FloatingMenuContainer"===t.path[e].className)break;if(this.listnerContainer===t.path[e]){this.validate(t);break}}else for(var i=t.target;i;){if(this.elements.bottomRightResizeHandler===i){this.onDownResizeHandler(t,1);break}if(this.elements.topLeftResizeHandler===i){this.onDownResizeHandler(t,2);break}if(this.elements.topRightResizeHandler===i){this.onDownResizeHandler(t,3);break}if(this.elements.bottomLeftResizeHandler===i){this.onDownResizeHandler(t,4);break}if(this.elements.textAreaField===i)break;if(this.textContainer===i){this.textEdit&&t.touchFlag||(this.dragPointerDown(t),this.elements.textAreaField.blur());break}if("CAT3DPlay-FloatingMenuContainer"===i.className)break;if(this.listnerContainer===i){this.validate(t);break}i=i.parentElement}}.bind(this),this.pointerMove=function(t){this.mEnable&&(this.mDragging&&(this.reallyDragged=!0,this.dragTextControl(t)),this.mResizing&&this.dragResizeHandler(t.clientX,1),this.mResizing2&&this.dragResizeHandler(t.clientX,2),this.mResizing3&&this.dragResizeHandler(t.clientX,3),this.mResizing4&&this.dragResizeHandler(t.clientX,4))}.bind(this),this.dragTextControl=function(t){var e={x:t.clientX-this.dummyContainer.offsetLeft,y:t.clientY-this.dummyContainer.offsetTop};if(d){var i=e.x-d.x,n=e.y-d.y,s=this.textContainer.offsetLeft+i,o=this.textContainer.offsetTop+n;this.showControls(s,o),d=e}},this.pointerup=function(t){if(this.mDragging||this.mResizing||this.mResizing2||this.mResizing3||this.mResizing4){if(!0===this.reallyDragged){var e={x:t.clientX-this.dummyContainer.offsetLeft,y:t.clientY-this.dummyContainer.offsetTop};Math.abs(e.x-this.startDragPosition.x)<10&&Math.abs(e.y-this.startDragPosition.y)<10&&(this.reallyDragged=!1)}!1===this.reallyDragged&&this.mDragging&&!1===this.textEdit&&(this.textEdit=!0,this.elements.textAreaField.style.pointerEvents="auto",this.elements.textAreaField.removeAttribute("readonly"),this.elements.textAreaField.placeholder="",this.elements.textAreaField.focus(),this.elements.bottomRightResizeHandler.style.display="none",this.elements.topLeftResizeHandler.style.display="none",this.elements.topRightResizeHandler.style.display="none",this.elements.bottomLeftResizeHandler.style.display="none",this.elements.textAreaField.select()),this.mDragging=!1,this.mResizing=!1,this.mResizing2=!1,this.mResizing3=!1,this.mResizing4=!1,this.updateTextFieldSize(),this.setTextcontainerPosition()}this.stopTyping=!1}.bind(this),this.mouseleave=function(t){(this.mDragging||this.mResizing||this.mResizing2||this.mResizing3||this.mResizing4)&&(this.mDragging=!1,this.mResizing2=!1,this.mResizing3=!1,this.mResizing4=!1,this.mResizing=!1,this.updateTextFieldSize(),this.setTextcontainerPosition())}},_unSubscribeListners:function(){this._unSubscribeListnersDesktop()},_unSubscribeListnersDesktop:function(){this.elements.textAreaField.removeEventListener("keydown",this.bindKeyDown),this.elements.textAreaField.removeEventListener("keyup",this.bindKeyUp)},_onKeyPress:function(t){this._exp&&!1===this._exp.collabMode?this.setFieldText(t):(this._exp&&!0===this._exp.collabMode&&setTimeout(function(){this._exp.notifyAction&&this._exp.notifyAction("annotTextKeyPress",[this.getFieldText()])},200),9===t.keyCode&&t.preventDefault&&t.preventDefault(),this.stopTyping&&(8===t.keyCode||46===t.keyCode?this.stopTyping=!1:13===t.keyCode?(t.preventDefault&&t.preventDefault(),setTimeout(function(){this._exp&&!0===this._exp.collabMode&&this._exp.notifyAction("annotTextValidate"),this.validate(),this.stopTyping=!1},200)):37!==t.keyCode&&38!==t.keyCode&&39!==t.keyCode&&40!==t.keyCode&&t.preventDefault&&t.preventDefault()))},cancel:function(t){this.textfocus=!1,t&&(t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault()),this.clearTextField(),this.hideControls(),this.options.onCancel()},validate:function(t){this.updateTextFieldSize(),this.textfocus=!1,this.updateDimensions(),t&&(t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault());var e=this.getFieldText();if(this.container)var i=this.container.getBoundingClientRect().top?this.container.getBoundingClientRect().top:0,n=this.container.getBoundingClientRect().left?this.container.getBoundingClientRect().left:0;var s=0,o=0;if(e){var a,r,l,h,p;p=this.position.x+5,r=this.position.y+0+5,s=5*this.mScale,o=0,l=this.size.width-10,h=this.size.height-0-10,a=this.position.x+this.size.width/2,this.offsetHeight=26,this.options.onOk({type:"text",text:e,w:l,h:h,x:a,y:r,ox:p,adjustY:i,adjustX:n,paddingH:s,paddingW:o,scale:this.mScale*this.viewerScale,offsetHeight:this.offsetHeight,fontSize:20,index:this.index?this.index:0,color:this.elements.textAreaField.style.color},t)}else this.cancel()},clearTextField:function(){this.getFieldText();this.setFieldText("")},isEnabled:function(){return this.mEnable},enable:function(t){if(this.mEnable=!0,this.disabled=!1,this.dummyContainer.setStyle("display","block"),this.elements.textAreaField.disabled=!1,this.elements.bottomRightResizeHandler.show(),t){this.elements.textAreaField.style.color=t.color,this.mScale=t.scale,this.viewerScale=t.viewerScale,this.elements.textAreaField.style.width=t.width.toString()+"px",this.setFieldText(t.text);var e=this.dummyContainer.getBoundingClientRect();this.showControls(t.pos.x-e.left,t.pos.y-e.top),this.updateTextFieldSize()}else this.showControls();this.setFocus(),this.options.data&&this.options.directEdit&&(this.textEdit=!0,this.elements.textAreaField.style.pointerEvents="auto",this.elements.textAreaField.removeAttribute("readonly"),this.elements.textAreaField.focus(),this.elements.bottomRightResizeHandler.style.display="none",this.elements.topLeftResizeHandler.style.display="none",this.elements.topRightResizeHandler.style.display="none",this.elements.bottomLeftResizeHandler.style.display="none",this.elements.textAreaField.select())},disable:function(){this.mEnable=!1,this.disabled=!0,this.elements.textAreaField.disabled=!0,this.elements.textAreaField.blur(),this.elements.textAreaField.selectionEnd=0,this.elements.textAreaField.selectionStart=0,this.setFieldText(this.getFieldText()),this.hideControls()},hideControls:function(){this.textContainer.hide(),this.elements.textAreaField.hide(),this.controlsHidden=!0},showControls:function(t,e){if(this.textContainer.show(),this.elements.textAreaField.show(),this.controlsHidden=!1,void 0!==t&&void 0!==e){var i=this.checkBoundingLimits({x:t,y:e});this.setTextcontainerPosition({left:i.x+"px",top:i.y+"px"})}else this.setTextcontainerPosition({left:this.defaultPos.left,top:this.defaultPos.top})},checkBoundingLimits:function(t){var e=t.width?t.width:this.textContainer.offsetWidth,i=t.height?t.height:this.textContainer.offsetHeight,n=void 0!==t.x?t.x:this.textContainer.offsetLeft,s=void 0!==t.y?t.y:this.textContainer.offsetTop;return{x:n<=0?0:n>=this.dummyContainer.offsetWidth-e?this.dummyContainer.offsetWidth-e:n,y:s<=0?0:s>=this.dummyContainer.offsetHeight-i?this.dummyContainer.offsetHeight-i:s}},removeSelection:function(){this.elements.textAreaField.classList.remove("no_select")},getColor:function(){return this.elements.textAreaField.style.color},getScale:function(){return this.mScale},getViewerScale:function(){return this.viewerScale},getWidth:function(){return parseFloat(this.elements.textAreaField.style.width)},getFieldText:function(){return this.elements.textAreaField.value},setDragging:function(t){this.mDragging=t},setFieldText:function(t){this.elements.textAreaField.value=t},setFocus:function(){this.elements.textAreaField.focus(),this.textfocus=!0},updateDimensions:function(){this.textContainer&&(this.size.height=this.textContainer.offsetHeight,this.size.width=parseFloat(this.textContainer.style.width),this.position.x=this.textContainer.offsetLeft,this.position.y=this.textContainer.offsetTop,this.offsetHeight=this.textContainer.getBoundingClientRect().height)},setTextControlPos:function(t){var e=t.top+t.height/2-40+"px",i=t.left+(t.width-110)/2+"px";this.defaultPos={top:e,left:i},this.setTextcontainerPosition({left:i,top:e})},setTextControlPosForEdit:function(t){if(t.annotationData&&t.annotationData.data){var e;e="video"===this.mode?this.viewer.scale:this.viewer.getPageFromNumber(t.pageNumber).getPhysicalScale(),"video"===this.mode?this.mScale=t.annotationData.data.controlScale:this.mScale=t.annotationData.data.controlScale/(t.annotationData.data.viewerScale*this.proportion);t.annotationData.data.height;var i=parseInt(t.annotationData.data.width/this.mScale*e),n=(t.annotationData.data.point.x-t.annotationData.data.width/2)*e-5,s=t.annotationData.data.point.y*e-0-5,o="translate("+this.elements.textAreaField.clientWidth*(this.mScale-1)/2+"px, "+this.elements.textAreaField.clientHeight*(this.mScale-1)/2+"px) scale("+this.mScale+")";this.elements.textAreaField.setStyle("transform",o),this.elements.textAreaField.setStyle("-webkit-transform",o),this.setTextcontainerPosition({left:n+"px",top:s+"px"}),this.defaultPos.left=n+"px",this.defaultPos.top=s+"px",this.elements.textAreaField.rows=t.annotationData.data.text.length,this.elements.textAreaField.setStyle("width",i+"px");for(var a=t.annotationData.data.text,r="",p=0;p<a.length;p++)r+=a[p],p!==a.length-1&&(r+="\n");a.length>1?this.elements.textAreaField.wrap="hard":this.elements.textAreaField.wrap="off",this.setFieldText(r),this.updateTextFieldSize()}else if("3D"===this.mode&&t.annotationData){t.annotationData.height,i=t.annotationData.width+5;var c,u=t.annotationData.get3DGeometry(t.annotationData.points),d=[];c=h.onScreenProjection(u.vertices,this.viewer),d.push(l.boundingBoxCompute(l.convexHullCompute(c)));n=d[0][1].x-5,s=d[0][1].y-0;this.mScale=t.annotationData.scale,s-=5,i/=this.mScale;o="translate("+this.elements.textAreaField.clientWidth*(this.mScale-1)/2+"px, "+this.elements.textAreaField.clientHeight*(this.mScale-1)/2+"px) scale("+this.mScale+")";this.elements.textAreaField.setStyle("transform",o),this.elements.textAreaField.setStyle("-webkit-transform",o),this.textContainerLower.setStyle("height",this.elements.textAreaField.clientHeight*this.mScale*this.viewerScale+10+"px"),this.setTextcontainerPosition({left:n+"px",top:s+"px"}),this.defaultPos.left=n+"px",this.defaultPos.top=s+"px",this.elements.textAreaField.setStyle("width",i+"px");for(a=t.annotationData.text,r="",p=0;p<a.length;p++)r+=a[p],p!==a.length-1&&(r+="\n");a.length>1?this.elements.textAreaField.wrap="hard":this.elements.textAreaField.wrap="off",this.setFieldText(r),this.updateTextFieldSize()}},setTextcontainerPosition:function(t){if(this.textContainer&&t&&(this.textContainer.setStyle("top",t.top?t.top:"initial"),this.textContainer.setStyle("left",t.left?t.left:"initial"),this.textContainer.setStyle("bottom",t.bottom?t.bottom:"initial"),this.textContainer.setStyle("right",t.right?t.right:"initial")),this.bar&&(this.bar.dispose(),this.bar=void 0),!1===this.mDragging&&!1===(this.mResizing||this.mResizing2||this.mResizing3||this.mResizing4)&&!1===this.disabled&&this.floatingbarCallback){var e=parseFloat(this.textContainer.style.top),i=parseFloat(this.textContainer.style.left),n=parseFloat(this.textContainer.style.height),s=parseFloat(this.textContainer.style.width),o=0,a=0;this.floatingBarContainer!=this.container&&(o+=parseFloat(this.container.style.top),a+=parseFloat(this.container.style.left)),this.bar=new c({frameWindow:this.frameWindow,container:this.floatingBarContainer}),this.bar.addCommands([{id:"Color3DPlay",color:this.elements.textAreaField.style.color.rgbToHex(),onclick:this.floatingbarCallback},{id:"Delete3DPlay",onclick:this.floatingbarCallback}],{top:e+o,left:i+a,height:n+0,width:s,defaultAlignment:"right"})}},zoom:function(t){var e=this.textContainer.offsetLeft*(t.zoomScale*this.proportion)/this.viewerScale,i=this.textContainer.offsetTop*(t.zoomScale*this.proportion)/this.viewerScale;this.viewerScale=t.zoomScale*this.proportion,this.showControls(e,i),this.updateTextFieldSize()},mDragging:!1,mResizing:!1,mResizing2:!1,mResizing3:!1,mResizing4:!1,mResizePrevX:0,mResizeDiffX:0,updateTextFieldSize:function(t){var e,i,n=this.getFieldText();this.position.x=this.textContainer.offsetLeft,this.position.y=this.textContainer.offsetTop,this.size.maxWidth=(this.dummyContainer.offsetWidth-this.textContainer.offsetLeft-10)/(this.mScale*this.viewerScale),this.size.maxHeight=Math.max(26,(this.dummyContainer.offsetHeight-this.textContainer.offsetTop-0)/(this.mScale*this.viewerScale));var s=Math.max(26,this.elements.textAreaField.scrollHeight),o=Math.max(this.elements.textAreaField.scrollWidth+1,parseFloat(this.elements.textAreaField.style.width)),a=Math.max(100,o);if(n){var r='20px "3ds"';e=(p=l.wrapText({text:n,width:"off"===this.elements.textAreaField.wrap?this.size.maxWidth:a,height:this.elements.textAreaField.scrollHeight,font:r})).wrappedLines.length,i=p.width}else e=1,i=0;if(s=26*e,1===e&&i<=a&&a<Math.floor(this.size.maxWidth))a=Math.max(100,i),this.stopTyping=!1,this.elements.textAreaField.wrap="off";else if(a>=this.size.maxWidth&&(a=this.size.maxWidth),i<this.size.maxWidth&&1===e)s=26*e,a=Math.max(100,i),this.stopTyping=!1,this.elements.textAreaField.wrap="off";else if(e<=Math.floor(this.size.maxHeight/26))s=26*e,this.stopTyping=!1,this.elements.textAreaField.wrap="hard";else{var h=Math.floor(this.size.maxHeight/26);for(s=this.size.maxHeight-this.size.maxHeight%26,this.stopTyping=!0,this.elements.textAreaField.wrap="hard",t&&(!t.stopPropagation||t.stopPropagation());h<e;){var p;this.elements.textAreaField.value=this.elements.textAreaField.value.slice(0,-1),e=(p=l.wrapText({text:this.getFieldText(),width:"off"===this.elements.textAreaField.wrap?this.size.maxWidth:a,height:this.elements.textAreaField.scrollHeight,font:r})).wrappedLines.length,i=p.width}h>=e&&(this.stopTyping=!1)}this.elements.textAreaField.rows=e;var c=Math.ceil(i);i<100&&(c=100),this.elements.textAreaField.style.minWidth=c+"px",this.elements.textAreaField.style.width=c.toString()+"px";var u="translate("+this.elements.textAreaField.clientWidth*(this.mScale*this.viewerScale-1)/2+"px, "+this.elements.textAreaField.clientHeight*(this.mScale*this.viewerScale-1)/2+"px) scale("+this.mScale*this.viewerScale+")";this.elements.textAreaField.setStyle("transform",u),this.elements.textAreaField.setStyle("-webkit-transform",u),this.textContainerLower.setStyle("height",s*this.mScale*this.viewerScale+10+"px"),this.textContainer.style.width=a*this.mScale*this.viewerScale+10+"px",this.textContainer.style.height=s*this.mScale*this.viewerScale+0+0+10+"px";let d=parseFloat(this.textContainer.getStyle("top")),x=parseFloat(this.textContainer.getStyle("left"));this.setTextcontainerPosition({top:d,left:x})},resizeText:function(t,e){if(t){var i=this.elements.textAreaField.scrollWidth*this.viewerScale;this.elements.textAreaField.style.width=this.elements.textAreaField.scrollWidth,this.minWidthSet&&(i=parseInt(this.elements.textAreaField.style.minWidth));var n=this.textContainer.offsetWidth,s=n+t;!0===(this.mResizing||this.mResizing2||this.mResizing3||this.mResizing4)&&this.mScale<=5&&this.mScale>=1&&t?s>i&&s<5*i&&(this.elements.textAreaField.scrollHeight*this.mScale<this.textContainer.offsetHeight||t<0)&&(this.textContainer.style.width=Math.max(35,s)+"px"):(this.textContainer.style.width=Math.max(35,i*this.mScale+10).toString()+"px",this.elements.textAreaField.style.width=this.textContainer.style.width-10);var o=s/n*this.mScale;o=(o=o<.1?.1:o)>5?5:o,this.mResizing&&this.textContainer.offsetLeft+this.elements.textAreaField.offsetWidth*o*this.viewerScale<this.dummyContainer.offsetWidth-10&&this.textContainer.offsetTop+this.elements.textAreaField.offsetHeight*o*this.viewerScale<this.dummyContainer.offsetHeight-10&&(this.mScale=o),this.mResizing2&&this.textContainer.offsetLeft+this.textContainer.offsetWidth-this.elements.textAreaField.offsetWidth*o*this.viewerScale>this.dummyContainer.offsetLeft&&this.textContainer.offsetTop+this.textContainer.offsetHeight-this.elements.textAreaField.offsetHeight*o*this.viewerScale>this.dummyContainer.offsetTop&&(this.mScale=o),this.mResizing3&&this.textContainer.offsetLeft+this.elements.textAreaField.offsetWidth*o*this.viewerScale<this.dummyContainer.offsetWidth-10&&this.textContainer.offsetTop+this.textContainer.offsetHeight-this.elements.textAreaField.offsetHeight*o*this.viewerScale>this.dummyContainer.offsetTop&&(this.mScale=o),this.mResizing4&&this.textContainer.offsetTop+this.elements.textAreaField.offsetHeight*o*this.viewerScale<this.dummyContainer.offsetHeight-10&&this.textContainer.offsetLeft+this.textContainer.offsetWidth-this.elements.textAreaField.offsetWidth*o*this.viewerScale>this.dummyContainer.offsetLeft&&(this.mScale=o);var a=this.elements.textAreaField.clientWidth*(this.mScale*this.viewerScale-1)/2,r=this.elements.textAreaField.clientHeight*(this.mScale*this.viewerScale-1)/2,l=this.elements.textAreaField.clientHeight*this.mScale*this.viewerScale,h=parseFloat(this.textContainer.getStyle("top")),p=parseFloat(this.textContainer.getStyle("left")),c=parseFloat(this.textContainer.getStyle("bottom")),u=parseFloat(this.textContainer.getStyle("right")),d="translate("+a+"px, "+r+"px) scale("+this.mScale*this.viewerScale+")";switch(this.elements.textAreaField.setStyle("transform",d),this.elements.textAreaField.setStyle("-webkit-transform",d),this.textContainerLower.setStyle("height",l+10+"px"),this.textContainer.style.height=l+0+0+10+"px",this.textContainer.style.width=this.elements.textAreaField.scrollWidth*this.mScale*this.viewerScale+10+"px",e){case 1:this.textContainer.setStyle("bottom",""),this.textContainer.setStyle("right",""),this.textContainer.setStyle("top",h),this.textContainer.setStyle("left",p);break;case 2:this.textContainer.setStyle("top",""),this.textContainer.setStyle("left",""),this.textContainer.setStyle("bottom",c),this.textContainer.setStyle("right",u);break;case 3:this.textContainer.setStyle("top",""),this.textContainer.setStyle("right",""),this.textContainer.setStyle("bottom",c),this.textContainer.setStyle("left",p);break;case 4:this.textContainer.setStyle("left",""),this.textContainer.setStyle("bottom",""),this.textContainer.setStyle("top",h),this.textContainer.setStyle("right",u)}}},initDragResizeHandler:function(t){this.elements.textAreaField.blur(),this.mResizePrevX=t,this._exp&&!0===this._exp.collabMode&&this._exp.notifyAction&&this._exp.notifyAction("annotTextInitResize",[t])},dragResizeHandler:function(t,e){if((this.mResizing||this.mResizing2||this.mResizing3||this.mResizing4)&&this.mScale>=.01&&0===this.mResizeDiffX){var i=t;switch(e){case 1:case 3:this.mResizeDiffX=i-this.mResizePrevX;break;case 2:case 4:this.mResizeDiffX=this.mResizePrevX-i}this.mResizePrevX=i,this._exp&&!0===this._exp.collabMode&&this._exp.notifyAction&&this._exp.notifyAction("annotTextResize",[t])}this.resizeText(this.mResizeDiffX,e),this.mResizeDiffX=0,this.updateDimensions()},onDownResizeHandler:function(t,e){if(this.mEnable){switch(t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),e){case 1:this.mResizing=!0;break;case 2:this.mResizing2=!0;break;case 3:this.mResizing3=!0;break;case 4:this.mResizing4=!0}return this.initDragResizeHandler(t.clientX),this.setTextcontainerPosition(),!1}},keyDownListner:function(t){!this.options.data&&this.elements.textAreaField.readOnly&&!1===this.textEdit&&(this.textEdit=!0,this.elements.textAreaField.style.pointerEvents="auto",this.elements.textAreaField.removeAttribute("readonly"),this.elements.textAreaField.placeholder="",this.elements.textAreaField.focus(),this.elements.bottomRightResizeHandler.style.display="none",this.elements.topLeftResizeHandler.style.display="none",this.elements.topRightResizeHandler.style.display="none",this.elements.bottomLeftResizeHandler.style.display="none",this.elements.textAreaField.select()),this.updateTextFieldSize(t),this._onKeyPress(t)},keyUpListner:function(t){this.updateTextFieldSize(t),this._onKeyPress(t)}})}),define("DS/3DPlayAnnotationUtils/AnnotationTools",["UWA/Class","DS/3DPlayAnnotationUtils/CurvedLayout","DS/3DPlayAnnotationUtils/AnnotationSettings","css!DS/3DPlayAnnotationUtils/AnnotationTools","DS/CoreEvents/Events"],function(t,e,i,n,s){"use strict";var o,a=["#FF0000","#FF9900","#FFFF00","#00CC00","#0033CC","#660099","#000000","#FFFFFF"];return t.extend({init:function(t){o=this,this.drawSettings=new i,this.frame=t.container,this.holdingContainer=t.holdingContainer,this.viewerFrame=t.frameWindow.getViewerFrame(),t.frameWindow.getViewer().setContextualBarPosition&&(this.rightShiftOption=t.frameWindow.getViewer().setContextualBarPosition());var e=t.frameWindow.getActionBar();e&&e.MAB&&(this.MAB=e.MAB),this.exp=t.frameWindow.experience;this._createAnnotPanel(),this.exp&&this.exp.registerCollabAction&&this.exp.registerCollabAction("annotChangeSettings",function(t){o.drawSettings.setColor(t.color),o.drawSettings.setThickness(t.thickness),o.drawSettings.setOpacity(t.opacity)}.bind(this)),this.exp&&this.exp.notifyAction&&!0===this.exp.collabMode&&(this.tokenSettingsChanged=s.subscribe({event:"3DPlay.Annotation.SettingsChanged"},function(t){o.exp.notifyAction("annotChangeSettings",[t])}))},dispose:function(){var t;if(this.tokenSettingsChanged&&s.unsubscribe(this.tokenSettingsChanged),this.MAB&&this.MAB.onVisibilityChangeUnsubscribe("PlayWeb-colorPalette"),this.buttonsColor){for(;this.buttonsColor.length>0;)(t=this.buttonsColor.pop()).btn.removeEvent("click",t.mouseCB),t.btn.removeEvent("touchstart",t.touchCB),t.btnMAB.removeEvent("click",t.mouseCB),t.btnMAB.removeEvent("touchstart",t.touchCB);this.buttonsColor=null}if(this.colorPalette&&(this.colorPalette.remove(),this.colorPalette=void 0),this.buttonsThickness){for(;this.buttonsThickness.length>0;)(t=this.buttonsThickness.pop()).btn.removeEvent("click",t.mouseCB),t.btn.removeEvent("touchstart",t.touchCB),t.btnMAB.removeEvent("click",t.mouseCB),t.btnMAB.removeEvent("touchstart",t.touchCB);this.buttonsThickness=null}this.drawSettings=void 0,this.frame=void 0,this.MAB=null,o=void 0},delayedDispose:function(){this.colorPaletteVisible&&(this.colorPalette.addEventListener("transitionend",function(){o.dispose()}),this.hideColorPalette())},_createAnnotPanel:function(){this.colorPalette=this._createColorContent(),this.colorPalette.inject(this.frame)},getColorPaletteVisibility:function(){return this.colorPaletteVisible},showColorPalette:function(){this._firstLaunchAfterCreation?(this._firstLaunchAfterCreation=void 0,this.colorPalette.style.display="none"):(this.MAB?0==this.MAB.state.visible&&(this.colorPalette.style.display="block"):this.colorPalette.style.display="block",this.colorPalette.style.right=-this.colorPalette.clientWidth+"px",this.colorPalette.style.transition="right 0.5s ease",this.MAB&&this.MAB.showToolMenu(this.buttonsColor),this.colorPalette.style.right="0px",this.rightShiftOption&&(this.colorPalette.style.right=this.rightShiftOption.value),this.colorPaletteVisible=!0)},hideColorPalette:function(){this.MAB&&this.MAB.hideToolMenu(this.buttonsColor),this.colorPalette.style.transition="right 0.5s ease",this.colorPalette.style.right=-this.colorPalette.clientWidth+"px",this.colorPaletteVisible=!1,this.colorPalette.style.display="none"},_createColorContent:function(){var t=this.drawSettings.getColor(),i=new UWA.Element("div",{class:"play3d-annot-palette"}),n=new UWA.Element("div",{class:"play3d-annot-colorDiv"}).inject(i);this._firstLaunchAfterCreation=!0;var s=this.holdingContainer;return setTimeout(function(){if(o){var r,l,h=new e({childCount:a.length,containerElement:n,layoutOpts:{containerHeight:n.clientHeight,containerWidth:n.clientWidth,offsetX:10,offsetY:0}});o.buttonsColor=[];for(var p=0;p<a.length;++p){var c=new UWA.Element("button",{class:"play3d-annot-colorButton",id:a[p],styles:{"background-color":a[p]}}).inject(h.contentArray[p]),u=new UWA.Element("button",{class:"play3d-annot-colorButton",id:a[p],styles:{"background-color":a[p]}});r=function(t){o._setColorSelectButton(this.id)},l=function(t){o._setColorSelectButton(this.id)},c.addEvent("click",r),c.addEvent("touchstart",l),u.addEvent("click",r),u.addEvent("touchstart",l),t===a[p]&&(c.addClassName("selected"),u.addClassName("selected")),o.buttonsColor.push({btn:c,btnMAB:u,touch:l,mouse:r})}i.style.top=s?s.offsetHeight/2-i.offsetHeight/2+"px":o.viewerFrame.offsetHeight/2-i.offsetHeight/2+"px",o.showColorPalette()}},0),this.MAB&&(this.MAB.state.visible&&(i.style.display="none"),this.MAB.onVisibilityChangeSubscribe("PlayWeb-colorPalette",function(t){"hidden"!==t&&(i.style.display="none")})),i},_setColorSelectButton:function(t){for(var e=0;e<this.buttonsColor.length;++e){var i=this.buttonsColor[e].btn,n=this.buttonsColor[e].btnMAB;i.id&&i.id===t?(i.addClassName("selected"),n.addClassName("selected")):(i.removeClassName("selected"),n.removeClassName("selected"))}this.drawSettings.setColor(t)}})}),define("DS/3DPlayAnnotationUtils/AnnotationToolsMenu",["UWA/Class","DS/WebInfraUI/ContextualBarManager","DS/3DPlayAnnotationUtils/AnnotationTools","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/CoreEvents/Events"],function(t,e,i,n,s){"use strict";return t.extend({init:function(t){this._newToolsUI=t.newToolsUI,this.contextualMenu=t.contextualMenu,this.frameWindow=t.frameWindow,this.container=t.container;var e=t.frameWindow.getActionBar();e&&e.MAB&&(this.MAB=e.MAB),this.exp=t.frameWindow.experience,this.exp&&this.exp.registerCollabAction&&(this.exp.registerCollabAction("annotAddTools",this._addTools.bind(this)),this.exp.registerCollabAction("annotRemoveTools",this._removeTools.bind(this))),this.drawSettings=new n,this.viewerFrame=this.frameWindow.getViewerFrame(),this.viewerFrameheight=this.viewerFrame.clientHeight,this.viewerFramewidth=this.viewerFrame.clientWidth,this._onResize=function(){this.viewerFrameheight==this.viewerFrame.clientHeight&&this.viewerFramewidth==this.viewerFrame.clientWidth||(this.viewerFrameheight=this.viewerFrame.clientHeight,this.viewerFramewidth=this.viewerFrame.clientWidth,this._removeTools(),this._newToolsUI&&(this.removeToolsButton(),this._addToolsButtonNewMenu()))}.bind(this),this.viewerFrame.addEvent("resize",this._onResize)},dispose:function(){this.viewerFrame.removeEvent("resize",this._onResize),this._removeTools(),this.removeToolsButton(!0),this.contextualMenu=void 0,this.frameWindow=void 0,this.drawSettings=void 0},_buildToolsButton:function(t,e){var i=UWA.Element("div",{styles:{width:e+"px",height:e+"px","background-color":t,"border-radius":"50%",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)","z-index":"-1","box-shadow":"rgb(0, 0, 0, 0.28) 2px 2px 10px 0px inset"}});return this._newToolsUI&&(i.style.border="1px solid #3d3d3d"),i},showColorPalette:function(){this.contextualMenu.panel.removeBackground(),this.colorTool.showColorPalette()},hideColorPalette:function(t){this.colorTool&&this.colorTool.getColorPaletteVisibility()&&(!1!==t&&(!this.uncheckColorPalette||this.uncheckColorPalette()),this.contextualMenu.panel.addDefaultBackground(),this.colorTool.hideColorPalette())},addToolsButton:function(){this._newToolsUI&&this._addToolsButtonNewMenu()},_addToolsButtonNewMenu:function(){var t=this.frameWindow.getUIFrame();this.container&&(t=this.container),this.colorTool=new i({container:t,frameWindow:this.frameWindow,holdingContainer:this.container}),this.colorPaletClickCB=function(t){this.uncheckColorPalette=t.uncheck,this.colorTool&&!this.colorTool.getColorPaletteVisibility()?this.showColorPalette():this.hideColorPalette(!1)}.bind(this);var e={type:this.contextualMenu.Button.Check,id:"Color",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",onclickCB:this.colorPaletClickCB};this.toolsButtonToken=this.contextualMenu.addButtons([e],{barType:this.contextualMenu.Toolbar.Append,showContextBarBackground:!0}),this._updateToolsButtons(),this.hideColorPalette(),this.tokenSettingsChanged=s.subscribe({event:"3DPlay.Annotation.SettingsChanged"},function(t){this._updateToolsButton(t),this.colorTool.getColorPaletteVisibility()&&this.hideColorPalette()}.bind(this))},removeToolsButton:function(t){s.unsubscribe(this.tokenSettingsChanged),this.toolsButtonToken&&this.contextualMenu&&(this.contextualMenu.removeButtons(this.toolsButtonToken,t),this.toolsButtonToken=void 0)},removeTools:function(){this._removeTools()},_updateToolsButton:function(t){this._newToolsUI?this._updateToolsButtonNewMenu(t):this._updateToolsButtonOldMenu(t)},_updateToolsButtonNewMenu:function(t){var e=t?t.color:this.drawSettings.getColor();this.drawSettings.getThickness();this.contextualMenu.updateButton({id:"Color",getButtonContent:function(){return this._buildToolsButton(e,28)}.bind(this)})},_updateToolsButtonOldMenu:function(t){var e=t?t.color:this.drawSettings.getColor(),i=t?t.thickness:this.drawSettings.getThickness();this.contextualMenu.updateButton({id:"PencilTools",getButtonContent:function(){return this._buildToolsButton(e,i)}.bind(this)})},_addTools:function(){this.pencilTools=new i({container:this.frameWindow.getUIFrame(),frameWindow:this.frameWindow});var t=[{type:this.contextualMenu.Button.Radio,content:[{id:"AnnotToolsColor",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",selected:!0}],onclickCB:function(t){switch(t.id){case"AnnotToolsColor":this.pencilTools.showColorPalette()}}},{type:this.contextualMenu.Button.Master,id:"AnnotToolsBack",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",onclickCB:function(){this._removeTools(!this.MAB||!0!==this.MAB.state.visible),this.exp&&!0===this.exp.collabMode&&this.exp.notifyAction&&this.exp.notifyAction("annotRemoveTools")}.bind(this)}];this.toolsToken=this.contextualMenu.addButtons(t,{barType:this.contextualMenu.Toolbar.New,showContextBarBackground:!1,mab:{flyoutLevel:2,backCB:t[1].onclickCB}}),this.pencilTools.showColorPalette(),this._updateToolsButtons()},_updateToolsButtons:function(t){return this._newToolsUI?this._updateToolsButtonsNewMenu(t):this._updateToolsButtonsOldMenu(t)},_updateToolsButtonsNewMenu:function(t){var e=t?t.color:this.drawSettings.getColor();t?t.thickness:this.drawSettings.getThickness();this.contextualMenu.updateButton({id:"Color",getButtonContent:function(){return this._buildToolsButton(e,28)}.bind(this)})},_updateToolsButtonsOldMenu:function(t){var e=t?t.color:this.drawSettings.getColor(),i=t?t.thickness:this.drawSettings.getThickness();this.contextualMenu.updateButton({id:"AnnotToolsColor",getButtonContent:function(){return this._buildToolsButton(e,28)}.bind(this)}),this.contextualMenu.updateButton({id:"AnnotToolsThick",getButtonContent:function(){return this._buildToolsButton(e,i)}.bind(this)})},_removeTools:function(t){this._newToolsUI&&this.colorTool&&(this.hideColorPalette(),!this.colorTool.dispose||this.colorTool.dispose(),this.colorTool=void 0),this.pencilTools&&this.pencilTools.dispose&&(t?this.pencilTools.delayedDispose():this.pencilTools.dispose(),this.pencilTools=void 0),this.contextualMenu&&this.toolsToken&&(this.contextualMenu.removeButtons(this.toolsToken),this.toolsToken=void 0,this.contextualMenu.setSelected({token:this.contextualMenuToken,id:"PencilTools",state:!1}),this._updateToolsButton())}})});