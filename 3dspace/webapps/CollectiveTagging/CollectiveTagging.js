/*!  COPYRIGHT DASSAULT SYSTEMES 2014   */
define("DS/CollectiveTagging/CollectiveTaggingHelpers",["UWA/Core","UWA/Class","UWA/Class/Debug","UWA/Promise","UWA/Element","DS/WAFData/WAFData","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/UIKIT/Input/Button","DS/UIKIT/Modal","DS/Controls/Editor","DS/TagNavigator/userTags/UserTagsModel","DS/TagNavigator/userTags/UserTagsView","DS/TagNavigator/userTags/utils/UserTagsUtils","DS/SNInfraUX/SearchUtils","DS/SNInfraUX/Logger","DS/SNResultUX/utils/SearchServices","i18n!DS/SNResultUX/assets/nls/SNResultUX.json"],function(e,t,i,n,s,o,a,r,l,c,u,d,g,m,_,f,h){"use strict";let T=t.singleton(i,{_urlAddIdea:"/api/idea/add",_communityGet:"/api/community/get",_swymURLPromise:null,_3DSearchURLPromise:null,_CsrfTokenPromise:null,_communityIdPromise:null,_CsrfToken:void 0,_communityId:"",_modal:null,init:function(){_.log("DS/CollectiveTagging/CollectiveTaggingHelpers Init"),this._swymURLPromise=T._getSericeURLPromise("3DSwym"),this._3DSearchURLPromise=T._getSericeURLPromise("3DSearch"),this._CsrfTokenPromise=T._getCsrfTokenPromise(),this._communityIdPromise=T._communityIdPromise()},displayModalAddTag:function(e){this._currentTab="add",this._buildModalTag(e)},requestRemoveTag:function(e){this._currentTab="remove",this._sendrequest(e)},getCsrfTokenPromise:function(){return this._CsrfTokenPromise},getCommunityIdPromise:function(){return this._communityIdPromise},addNewTagIdea:function(e,t,i,s){let a=this;return new n(function(n,r){let l={};T._getswymSericeURLPromise().then(function(c){let u=c+a._urlAddIdea,d={"X-DS-SWYM-CSRFTOKEN":e,"content-type":"application/json;charset=UTF-8"},g={params:{community_id:t,title:i,message:s,published:1}},m={method:"POST",type:"json",timeout:12e4,headers:d,data:l=JSON.stringify(g),onComplete:n,onFailure:function(e,t){r(e,t)}};o.authenticatedRequest(u,m)})})},_getswymSericeURLPromise:function(){return this._swymURLPromise},_get3DSearchSericeURLPromise:function(){return this._3DSearchURLPromise},destroy:function(){this._parent()},_getCsrfTokenPromise:function(){let e=this;return new n(function(t,i){T._getswymSericeURLPromise().then(function(n){let s=n+"/api/index/tk",a={method:"GET",type:"json",onComplete:function(i){let n=i.result.ServerToken;UWA.is(n,"string")&&(e._CsrfToken=n,t(e._CsrfToken))},onFailure:function(e,t){i(e,t)}};o.authenticatedRequest(s,a)})})},_getSericeURLPromise:function(e){let t=this;return new n(function(i,n){let s=t._getTenant();a.getServiceUrl({serviceName:e,platformId:s,onComplete:function(s){s?("3DSwym"===e&&(t._swymUrl=s),i(s)):n()},onFailure:function(e){n(e)}})})},_communityIdPromise:function(){let t=this;return new n(function(i,n){let s='[ds6w:type]:"swym:Community" AND ';s+="(",s+='[ds6w:label]:"'+h.get("Company_Community_Name")+'"',s+=")";let a=t._getFedSearchServiceData({query:s,source:["swym"],order_by:"asc",order_field:"ds6w:label",nresults:1});T._get3DSearchSericeURLPromise().then(function(n){a.onComplete=function(n){let s=JSON.parse(n);e.is(s)&&e.is(s.results,"array")&&(t._communityId=s.results[0].attributes[0].value,i(t._communityId),_.log("DS/CollectiveTagging/CollectiveTaggingHelpers _getCommunityIdFromTitle: ",t._communityId))},o.authenticatedRequest(n+"/search",a)})})},_getFedSearchServiceData:function(e){return{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},data:JSON.stringify({with_indexing_date:!0,with_nls:!1,label:"label-1574068635089",locale:window&&window.dsLang?window.dsLang:"en",query:e.query,refine:e.refine?e.refine:{},specific_source_parameter:e.specific_source_parameter,select_predicate:["ds6w:label","ds6w:description"],source:e.source,tenant:this._getTenant(),nresults:e.nresults?e.nresults:1,order_by:e.order_by,order_field:e.order_field,start:0,with_synthesis:!0}),onComplete:function(e,t){}}},_getTenant:function(){return m.getActiveTenant()},_buildModalTag:function(t){if(!e.is(t))return;let i=this;i.okBtn=new r({className:"primary addTagBtn",value:h.get("collectiveTagging.sendButton"),disabled:!0,events:{onClick:function(){i._sendrequest(t),i._modal.destroy()}}}),i._modal=new l({header:h.get("collectiveTagging.title"),className:"collectiveTagging",closable:!0,body:"",events:{onHide:function(){i._modal.destroy()}},footer:[i.okBtn,new r({value:h.get("CancelButton"),className:"cancelTagBtn default",events:{onClick:function(){i._modal.destroy()}}})]}).inject(document.body),i._modal.setBody(this._buildaddTagTab(t)),i._modal.show()},_buildaddTagTab:function(t){if(!e.is(t))return;let i=s.create("div",{class:"collectiveAddTag"}),n=s.create("div",{class:"collectiveAddTagText"});n.inject(i);let o=s.create("span",{class:"collectiveAddTagText-text"});o.setText(h.get("collectiveTagging.addTagsText")),o.inject(n),this._buildaddTagForm(t).inject(n);let a=s.create("div",{class:"collectiveAddTagDescription"});return a.inject(i),(o=s.create("span",{class:"collectiveAddTagText-text"})).setText(h.get("collectiveTagging.addTagsDesc")),o.inject(a),this._description=new c({placeholder:h.get("collectiveTagging.addPlace"),requiredFlag:!1,nbRows:4,newLineMode:"enter"}),this._description.inject(a),i},_sendrequest:function(t){let i=this;T.getCsrfTokenPromise().then(function(n){T.getCommunityIdPromise().then(function(s){let o,a;if("add"===i._currentTab){let t=i._userTagsView._autoComplete;if(e.is(t)){let e=t.value;o=h.get("collectiveTagging.addRequest");let n=e.length;for(let t=0;t<n;t++){o+=e[t],o+=" "}a=i._description.value}}else if("remove"===i._currentTab){let i=t._userTagsView._autoComplete;if(e.is(i)){let e=i.value;o=h.get("collectiveTagging.removeRequest");let n=e.length;for(let t=0;t<n;t++){o+=e[t],o+=" "}a=t._description.value}}a+="<br>",a+='<span class="labelAddTagRequest" style="font-weight: bold">'+h.get("collectiveTagging.addobjecturl")+"</span>";let r=decodeURI(i._buildLink(t));a+=r='<a href="'+r+'">'+r+"</a>",T.addNewTagIdea(n,s,o,a).then(function(e){f._displayAlert({message:h.get("collectiveTagging.commit"),className:"success"})})})})},_buildLink:function(t){if(!e.is(t))return;let i="/#",n="/",s=this._communityId.split(":");s.length>2&&(i+=s[s.length-2],i+=":",i+=s[s.length-1]);let o=t.object_id.split(":");return o.length>2&&(n+=o[o.length-2],n+=":",n+=o[o.length-1]),this._swymUrl+i+n},_buildaddTagForm:function(e){var t=s.create("form",{class:"formAddTag"}),i=s.create("div",{class:"divAddTag"});i.inject(t);let n=e.actionsHelper.getPlatformID({id:e.object_ids[0]}),o=[],a=e.object_ids,r=[];for(let t of a)r.push(e.collection.get(t));o=m.getTaggerSubjectURIForMultipleSources(r,n);var l=new u({subjects:o,applicativeSuggestions:[],platformId:n,readOnly:!1});let c=e.collection.search_ressources.getActiveTenant(),_=this._getContainerId(r);if(1==this._getSubjectUriCount(o)&&_){let e={appName:"3DSearch",currentUser:m.getUserId(),platformId:c,vocabSuggestions:!1,communityTags:!0,communityId:_};g.getSuggestionsFor3DSwymContent(e).then(function(e){UWA.is(e,"object")&&UWA.is(e.suggestions,"array")&&l.set("applicativeSuggestions",e.suggestions)})}return this._userTagsView=new d({model:l,suggestsInfo:{placeHolder:h.get("add_tag.add_tag_default_text"),filterMessage:"customFilterMessage...",allowFreeText:!0,vocabSuggestions:!0},manageDirtyState:!0,onCommit:this._actionOnCommit.bind(this),onFailure:this._actionOnFailure.bind(this),onSuggestDisplayed:function(){},touchMode:!1,onSelectionChange:T._onSelectionChangeInView.bind(this)}).render().inject(i),t},_actionOnCommit:function(){},_actionOnFailure:function(){},_onSelectionChangeInView:function(e){this.okBtn&&(e>0?this.okBtn.enable():this.okBtn.disable())},_getContainerId:function(t){let i;for(let n of t)if(i=n.get("ds6w:containerUid"),e.is(i))break;return i},_getSubjectUriCount:function(e){return e.filter(e=>e.uri).length}});return T});