/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Ruler/RulerManipulator",["DS/Visualization/ThreeJS_DS","DS/Manipulators/Manipulator"],function(e,t){"use strict";return t.extend({init:function(e){const t=e||{};this._parent(t.viewer),this.axis=t.axis,this.clickGradManipulator=!1,this.axis?this.axis.normalize():(this.clickGradManipulator=!0,this.associatedValue=t.value,this.linkedNode=t.linkedNode),this.setPrePickingDuringManipulation(!1),this.setPreActivationDuringManipulation(!1),this.setPickingDuringManipulation(!1),this.setExclusive(!0),this.magnitude=1e3,this.setValue=function(e){this.associatedValue=e}},BeginManipulate:function(t,i,a){this._parent(t,i,a),this.clickEvent=!0,this.clickGradManipulator||(this.initial3dIntersectionPoint=a.position,this.initial3dIntersectionPointTranslated=(new e.Vector3).copy(this.initial3dIntersectionPoint),this.initial3dIntersectionPointTranslated.add(this.axis)),this.publish("BeginManipulate",{eventChannel:"BeginManipulate",paths:this.manipulatedPaths,event:i,manipulator:this})},Manipulate:function(t,i){if(this._parent(t,i),!this.clickGradManipulator){let t=(new e.Vector2).copy(i.from[0].getCurrentPosition(this.viewer.canvas)),a=this.viewer.currentViewpoint.create3DRayFrom2DPoint(t).computeShortestPointToLine(this.initial3dIntersectionPoint,this.initial3dIntersectionPointTranslated),n=(new e.Vector3).subVectors(a,this.initial3dIntersectionPoint);Math.round(100*n.length())>this.magnitude&&(this.clickEvent=!1,this.publish("Manipulate",{event:i,eventChannel:"Manipulate",paths:this.manipulatedPaths,translationVector:n,manipulator:this}))}},EndManipulate:function(e,t){this._parent(e,t),this.clickGradManipulator||(this.clickEvent?this.publish("Click",{eventChannel:"Click",paths:this.manipulatedPaths,event:t,manipulator:this}):this.publish("EndManipulate",{eventChannel:"EndManipulate",paths:this.manipulatedPaths,manipulator:this,event:t}))},PrimaryPointerClick:function(e,t){this._parent(e,t),this.publish("Click",{eventChannel:"Click",paths:this.manipulatedPaths,event:t,manipulator:this,value:this.clickGradManipulator?this.associatedValue:void 0})},BeginPreactivate:function(e,t){this._parent(e,t),this.publish("BeginPreactivate",{eventChannel:"BeginPreactivate",preactivated:this.preactivated,manipulator:this,event:t,node:this.clickGradManipulator?this.linkedNode:void 0})},Preactivate:function(e,t){this._parent(e,t),this.publish("Preactivate",{eventChannel:"Preactivate",preactivated:this.preactivated,manipulator:this,event:t,node:this.clickGradManipulator?this.linkedNode:void 0})},EndPreactivate:function(e,t){this._parent(e,t),this.publish("EndPreactivate",{eventChannel:"EndPreactivate",preactivated:this.preactivated,manipulator:this,event:t,node:this.clickGradManipulator?this.linkedNode:void 0})}})}),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Ruler/AngularRulerManipulator",["DS/Visualization/ThreeJS_DS","DS/Manipulators/Manipulator"],function(e,t){"use strict";return t.extend({init:function(t){const i=t||{};this._parent(i.viewer),this.axis=i.axis,this.clickGradManipulator=!1,this.axis?(this.axis.normalize(),this.centerPosition=new e.Vector3,this.projector=new e.Projector):(this.clickGradManipulator=!0,this.associatedValue=i.value,this.linkedNode=i.linkedNode),this.setPrePickingDuringManipulation&&this.setPrePickingDuringManipulation(!1),this.setPreActivationDuringManipulation&&this.setPreActivationDuringManipulation(!1),this.setPickingDuringManipulation&&this.setPickingDuringManipulation(!1),this.centerPosition=i.center,this.setExclusive(!0)},BeginManipulate:function(e,t,i){this._parent(e,t,i),this.initial3dIntersectionPoint=i.position,this.clickEvent=!0,this.publish("BeginManipulate",{event:t})},Manipulate:function(t,i){if(this._parent(t,i),!this.clickGradManipulator){let t=(new e.Vector2).copy(i.from[0].getCurrentPosition(this.viewer.canvas)),a=i.viewer.currentViewpoint.create3DRayFrom2DPoint(t),n=(new e.Plane).setFromNormalAndCoplanarPoint(this.axis,this.initial3dIntersectionPoint),r=a.intersectPlane(n),l=(new e.Vector3).subVectors(this.initial3dIntersectionPoint,this.centerPosition);l.projectOnPlane(this.axis),l.normalize();let o=(new e.Vector3).subVectors(r,this.centerPosition);o.projectOnPlane(this.axis),o.normalize();let s=new e.Vector3;s.crossVectors(l,o),s.normalize();let u=l.angleTo(o),d=(new e.Matrix4).makeRotationAxis(s,u);Math.round(180*u/Math.PI)>.05&&(this.clickEvent=!1,this.publish("Manipulate",{rotationMatrix:d,angle:u,axis:s,center:this.centerPosition,event:i}))}},EndManipulate:function(e,t){this._parent(e,t),this.clickGradManipulator||(this.clickEvent?this.publish("Click",{event:t}):this.publish("EndManipulate",{event:t}))},PrimaryPointerClick:function(e,t){this._parent(e,t),this.publish("Click",{event:t,value:this.clickGradManipulator?this.associatedValue:void 0})},BeginPreactivate:function(e,t){this._parent(e,t),this.publish("BeginPreactivate",{event:t,preactivated:this.preactivated,node:this.clickGradManipulator?this.linkedNode:void 0})},Preactivate:function(e,t){this._parent(e,t),this.publish("Preactivate",{preactivated:this.preactivated,event:t,node:this.clickGradManipulator?this.linkedNode:void 0})},EndPreactivate:function(e,t){this._parent(e,t),this.publish("EndPreactivate",{preactivated:this.preactivated,event:t,node:this.clickGradManipulator?this.linkedNode:void 0})}})}),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Ruler/RulerEditor",["UWA/Core","DS/SceneGraphNodes/CSS2DNode","DS/VisuEvents/EventsManager","DS/Controls/LineEditor","i18n!DS/Ruler/assets/nls/Ruler","css!DS/Ruler/Ruler.css"],function(e,t,i,a,n){"use strict";return t.extend({init:function(t){let r=t||{},l=e.createElement("div",{id:"WEB3DUXRulersValueEditor",class:"WEB3DUXRulersValueEditor"}),o=new a({autoCommitFlag:!0,touchMode:!0,pattern:"^[+-]?[0-9]*.?[0-9]*$",value:parseFloat(r.value)}).inject(l);l.setStyles({opacity:0}),o.getContent().addClassName("WEB3DUXValueEditor");let s=o.getContent().childNodes[0];s.setStyles({border:"none"}),s.addClassName("WEB3DUXRulersValueEditorField");let u=setTimeout(()=>{u=null,l&&s&&(l.setStyles({opacity:1}),s.select(),s.focus())},100),d=e.createElement("span",{id:"WEB3DUXCancelRulerEditionButton",class:"fonticon fonticon-cancel WEB3DUXCancelRulerEditionButton"}).inject(l),h=e.createElement("span",{id:"WEB3DUXAcceptRulerEditionButton",class:"fonticon fonticon-check WEB3DUXAcceptRulerEditionButton"}).inject(l),c=e.createElement("span",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attention WEB3DUXAcceptRulerEditionWarningDiv"}).inject(l);c.setStyles({visibility:"hidden"}),this._parent({html:l,name:"immersiveEditor2DNode"}),this._getExcludeFromCSO=function(){return!0},this.css2DNode.primitive=!0,navigator.userAgent.match(/(iPhone|iPad)/i)&&t.frmWindow&&t.frmWindow.getUIFrame().appendChild(l.parentNode);let p,g=null;o.addEventListener("change",function(){let e=g;g=isNaN(o.value)?n.warningBadValueEntered:"number"==typeof r.startValue&&parseFloat(o.value)<r.startValue?n.warningValueTooSmall+r.startValue:"number"==typeof r.endValue&&parseFloat(o.value)>r.endValue?n.warningValueTooBig+r.endValue:null,c.title=g||"",(e&&!g||!e&&g)&&c.setStyles({visibility:g?"":"hidden"})});let M=function(e){null===g&&(r.okCB(e),p())},f=function(e){r.cancelCB(e),p()},m=function(e){let t=e.which||e.keyCode;13===t?M({event:e}):27===t&&f({event:e}),13!==t&&27!==t||(e.preventDefault(),e.stopPropagation())};p=function(){u&&clearTimeout(u),u=null,i.removeEvent(h,"onPrimaryPointerClick",M),i.removeEvent(d,"onPrimaryPointerClick",f),s&&s.removeEventListener("keydown",m)},i.addEvent(h,"onPrimaryPointerClick",M),i.addEvent(d,"onPrimaryPointerClick",f),s.addEventListener("keydown",m),this.getInputValue=function(){return o?o.value:null},this.validateEditor=function(){null===g&&o.value&&parseFloat(o.value)!==r.value?M():f()}}})}),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Ruler/AngularRuler",["UWA/Class","DS/Ruler/RulerEditor","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Ruler/AngularRulerManipulator","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/Mesh/MeshUtils","DS/SceneGraphNodes/CSS2DNode","i18n!DS/Ruler/assets/nls/Ruler"],function(e,t,i,a,n,r,l,o,s,u,d,h,c,p){"use strict";const g=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator.png"),void 0,null,null,!0);g.flipY=!1;const M=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Over.png"),void 0,null,null,!0);M.flipY=!1;const f=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_On.png"),void 0,null,null,!0);f.flipY=!1;const m=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half.png"),void 0,null,null,!0);m.flipY=!1;const b=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_Over.png"),void 0,null,null,!0);b.flipY=!1;const v=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0);v.flipY=!1;const w=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half.png"),void 0,null,null,!0),y=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_Over.png"),void 0,null,null,!0),T=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0),C=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerZeroArrowManip.png"),void 0,null,null,!0),x=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0),S=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerZeroArrowManip.png"),void 0,null,null,!0);S.flipY=!1;const R=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0);R.flipY=!1;const N=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLight.png"),void 0,null,null,!0),V=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLightOver.png"),void 0,null,null,!0),I=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLightOn.png"),void 0,null,null,!0),P=new i.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLightZeroManip.png"),void 0,null,null,!0),D=e.extend({init:function(e,_){if(!e)return void window.console.error("Ruler - Frame window argument missing");const E=_||{};this._parent(E);const U=[];U.push({unit:D.DEG_UNIT,nls:String.fromCharCode(176)}),U.push({unit:D.RAD_UNIT,nls:p.radLbl}),U.push({unit:D.GRAD_UNIT,nls:p.gradLbl}),U.push({unit:D.MRAD_UNIT,nls:p.mradLbl}),U.push({unit:D.INPERFOOT_UNIT,nls:p.inPerFootLbl}),U.push({unit:D.PERCENT_UNIT,nls:String.fromCharCode(37)}),this.value=0,this.initValue=0,this.origin=new i.Vector3,this.direction=new i.Vector3(0,0,1),this.originVector=null,this.radius=E.radius,this.worldRadius=E.worldRadius,this.openingAngle=E.openingAngle,this.mainGrad=E.mainGrad,this.nbSecondaryGrads=E.nbSecondaryGrads,this.startValue=E.startValue,this.endValue=E.endValue,this.lightDisplay=E.lightDisplay,this.displayRulerDuringLocalTransfo=E.displayRulerDuringLocalTransfo,this.displayOrigin=E.displayOrigin,this.unit=E.unit,this.displayUnit=E.displayUnit,this.graduationsDisplay=E.graduationsDisplay,this.originValue=E.originValue,this.hideOnEmptySelection=E.hideOnEmptySelection,this.nbDecimals=E.nbDecimals;const k=this;let A,O,G,B,L,F,W,H,X,Y,q,z,K,Z,j,J,$,Q,ee,te,ie,ae,ne,re,le,oe=null,se=null,ue=null,de=null,he=new i.Vector2,ce=1,pe=1,ge=0,Me=0,fe=15,me=1,be=35,ve=15,we=14,ye=10,Te=.33*be,Ce=100,xe="255, 128, 0",Se="115, 195, 225",Re="130, 190, 220",Ne="40, 90, 120",Ve="80, 80, 80",Ie="0,0,0",Pe=!1,De=1,_e=new u,Ee=e.getViewer(),Ue=e.getViewpoint(),ke=new a("rulerMainNode");ke.setVisibilityInTree(!1),ke.side=i.DoubleSide,ke.exludeFromBounding(!0),ke._getExcludeFromCSO=function(){return!0},ke.setNoZ(!0);let Ae=new a("rulerMainNodeNoPick");Ae.setVisibilityInTree(!1),Ae.side=i.DoubleSide,Ae.exludeFromBounding(!0),Ae._getExcludeFromCSO=function(){return!0},Ae.setNoZ(!0),Ae.setPickable(h.PICKTHROUGH);let Oe,Ge,Be,Le=new a,Fe=new a,We=new a,He=new a("rulerGraduationNode"),Xe=new a,Ye=new a,qe=new a,ze=new a,Ke=new a,Ze=new a,je=new a,Je=null,$e=new a,Qe=new a,et=100,tt=[],it=[],at=0,nt=0,rt=null,lt=0,ot=null,st=0,ut=null,dt=0,ht=0,ct=null,pt=!1,gt=!1,Mt=!1,ft=!1,mt=!0,bt=!1,vt=!1,wt=!1,yt=!1,Tt=!1,Ct=!1,xt=!1,St=!1,Rt=!1,Nt=!1,Vt=!1,It=!1,Pt=document.createElement("canvas"),Dt=document.createElement("canvas"),_t=document.createElement("canvas"),Et=document.createElement("canvas"),Ut=document.createElement("canvas"),kt=document.createElement("canvas"),At=document.createElement("canvas");kt.width=1,kt.height=1;let Ot=kt.getContext("2d");Ot.clearRect(0,0,kt.width,kt.height),Ot.rect(0,0,kt.width,kt.height),Ot.fillStyle="rgba(0,0,0,0)",Ot.fill();let Gt=new i.Texture,Bt=new i.Texture,Lt=new i.Texture,Ft=new i.Texture,Wt=new i.Texture;Wt.image=kt,Wt.needsUpdate=!0;let Ht,Xt,Yt,qt,zt=new i.Texture;function Kt(e){if(k.__performanceMeasures){for(let t=0;t<k.__performanceMeasures.measures.length;t++)if(k.__performanceMeasures.measures[t].id===e)return void(k.__performanceMeasures.measures[t].mark=(new Date).getTime());k.__performanceMeasures.measures.push({id:e,mark:(new Date).getTime(),cumulatedTime:0,nbCalls:0})}}function Zt(e){if(k.__performanceMeasures)for(let t=0;t<k.__performanceMeasures.measures.length;t++)if(k.__performanceMeasures.measures[t].id===e)return k.__performanceMeasures.measures[t].cumulatedTime+=(new Date).getTime()-k.__performanceMeasures.measures[t].mark,void(k.__performanceMeasures.measures[t].nbCalls+=1)}function jt(e,t,i){let a=e;return L===D.SYMETRIC_GRADUATIONS&&e>180?a=e-360:L===D.ORIENTED_GRADUATIONS&&e>180?a=360-e:L===D.FULLSYMETRIC_GRADUATIONS&&-1===ce&&-360===(a=e-360)&&(a=0),i||(a*=Y),t?a:Math.round(a*$)/$}function Jt(e){let t,i=e;if(null!=i)return(i<-360||i>360)&&(i%=360),i<0&&(i=360+i),void 0!==q&&void 0!==z?q<z?i>=q&&i<=z?i:(((t=q-(360-(z-q))/2)<-360||t>360)&&(t%=360),t<0&&(t=360+t),i>=0&&i<q||i>=t?q:z):i>=q||i<=z?i:(((t=z+(q-z)/2)<-360||t>360)&&(t%=360),t<0&&(t=360+t),i>=t?q:z):i}function $t(){return!se||Math.abs(se.dot(Ue.getSightDirection()))<=.2}function Qt(e){if("@onPrimaryPointerMoveUniqueEvent"!==e.eventType){if(gt)gt=!1;else if(e&&!Nt&&!Mt){let t=qe.children[0];!t&&k.getVisibleFlag()?setTimeout(function(){let t=null;if(yt&&(t="ruler"),null===t){let i=Ee.getMousePosition(e.from[0].getCurrentPosition(Ee.canvas)),a=Ee.pick(i,"primHybrid",!1);if(0!==a.path.length&&a.path[0]||0!==(a=Ee.pick(i,"mesh",!1)).path.length&&a.path[0]||(t=""),null===t){let e=a.path[0];if(e&&e.externalPath)for(let i=0;i<e.externalPath.length;i++)"rulerMainNode"===e.externalPath[i].name&&(t="ruler")}}""===t&&J&&k.clear()},0):t&&t.validateEditor()}}else!e.from[0].currentPosition||isNaN(e.from[0].currentPosition.x)||isNaN(e.from[0].currentPosition.y)||(he.x=e.from[0].currentPosition.x,he.y=e.from[0].currentPosition.y)}function ei(e,t){if((!Rt||e!==He&&e!==Xe&&e!==Ke)&&e){e.getMaterial()&&(e.getMaterial().map&&t&&e.getMaterial().map.dispose(),e.getMaterial().dispose());for(let i=e.children.length-1;i>=0;i--)ei(e.children[i],t);e.removeChildren()}}function ti(e,t){return _e.publish({event:e,data:t,context:this})}function ii(e){Kt("_stroke"),e.stroke(),Zt("_stroke")}function ai(e){let t;Kt("_generateMainCanvas");let a=e?Et:Pt;a.width=Math.round(re),a.height=Math.round(re);let n=a.getContext("2d");n.clearRect(0,0,a.width,a.height);n.translate(Math.round(re/2),Math.round(re/2));let r,l,o=e?Math.min(1.5*B,Math.PI):B,s=Math.round(Math.cos(o)*(A+be)),u=Math.round(Math.sin(o)*(A+be)),d=Math.round(A+be),h=Math.round(Math.sin(o-Math.PI/4)*(A+be)*Math.sqrt(2)),c=F?.25:.4,p=F?Ve:"255, 255, 255";if((t=n.createLinearGradient(s,u,d,h)).addColorStop(0,"rgba("+p+",0)"),t.addColorStop(e||F?.75:.25,"rgba("+p+","+c+")"),o!==Math.PI?n.strokeStyle=t:n.strokeStyle="rgba("+p+","+c+")",F||(n.beginPath(),n.arc(0,0,Math.round(A+be/2),0,o,!1),n.lineWidth=be,ii(n)),o!==Math.PI?n.strokeStyle=t:n.strokeStyle="rgba("+p+","+c+")",n.lineWidth=2*me,n.beginPath(),n.arc(0,0,A,0,o,!1),ii(n),F||(n.beginPath(),n.arc(0,0,A+be,0,o,!1),ii(n)),s=Math.round(Math.cos(-o)*(A+be)),u=Math.round(Math.sin(-o)*(A+be)),h=Math.round(Math.sin(-o+Math.PI/4)*(A+be)*Math.sqrt(2)),(t=n.createLinearGradient(s,u,d,h)).addColorStop(0,"rgba("+p+",0)"),t.addColorStop(e||F?.75:.25,"rgba("+p+","+c+")"),o!==Math.PI?n.strokeStyle=t:n.strokeStyle="rgba("+p+","+c+")",F||(n.beginPath(),n.arc(0,0,Math.round(A+be/2),-o,0,!1),n.lineWidth=be,ii(n)),o!==Math.PI?n.strokeStyle=t:n.strokeStyle="rgba("+p+","+c+")",n.lineWidth=2*me,n.beginPath(),n.arc(0,0,A,-o,0,!1),ii(n),F||(n.beginPath(),n.arc(0,0,A+be,-o,0,!1),ii(n)),c=F?.8:.5,H){let e=de-j;(e<-360||e>360)&&(e%=360),e<0&&(e=360+e),e*=Math.PI/180;let i=Se;if((vt||wt)&&(i=xe),0!==e){let a=e>Math.PI?-1:1;s=Math.round(Math.cos(Pe?-e:e)*(A+be)),u=Math.round(Math.sin(Pe?-e:e)*(A+be)),d=Math.round(A+be),h=Pe?Math.round(a<0?0:A+be):Math.round(a<0?A+be:0),(t=n.createLinearGradient(s,u,d,h)).addColorStop(0,"rgba("+i+",0)"),t.addColorStop(.6,"rgba("+i+","+c+")"),n.strokeStyle=t,n.beginPath();let r=1===a?0:-(2*Math.PI-e),l=1===a?e:0;Pe&&(r=1===a?-e:0,l=1===a?0:-e);let o=F?A:Math.round(vt?A+(Ce+be+ne)/2:A+be/2);n.arc(0,0,o,r,l,!1),n.lineWidth=F?2*me:Math.round(vt?Ce+be+ne:be),ii(n)}else F||(r=Math.min(.2*o,Math.PI/8),s=Math.round(Math.cos(r)*(A+be)),u=Math.round(Math.sin(r)*(A+be)),d=Math.round(A+be),h=0,(t=n.createLinearGradient(s,u,d,h)).addColorStop(0,"rgba("+i+",0)"),t.addColorStop(1,"rgba("+i+","+c+")"),n.strokeStyle=t,n.beginPath(),n.arc(0,0,Math.round(vt?A+be/2+Ce/2:A+be/2),0,r,!1),n.lineWidth=Math.round(vt?Ce+be:be),ii(n),r=2*Math.PI-r,s=Math.round(Math.cos(r)*(A+be)),u=Math.round(Math.sin(r)*(A+be)),(t=n.createLinearGradient(s,u,d,h)).addColorStop(0,"rgba("+i+",0)"),t.addColorStop(1,"rgba("+i+","+c+")"),n.strokeStyle=t,n.beginPath(),n.arc(0,0,Math.round(vt?A+be/2+Ce/2:A+be/2),0,r,!0),n.lineWidth=Math.round(vt?Ce+be:be),ii(n))}if(c=F?.8:.7,!e&&!H&&(vt||wt))if(0!==de){l=0,r=0;let e=(new i.Vector3).copy(Ue.getSightDirection()).normalize(),a=se.dot(e),p=!1;de<180&&de>0?r=de>180*o/Math.PI?o:de*Math.PI/180:de>=180&&de<360&&(r=de*Math.PI/180,p=!0),s=Math.round(Math.cos(r)*(A+be)),u=Math.round(Math.sin(r)*(A+be)),d=Math.round(A+be),h=0,t=null,a<0?((t=n.createLinearGradient(s,u,d,h)).addColorStop(0,"rgba("+xe+",0)"),t.addColorStop(1,"rgba("+xe+","+c+")")):(s=Math.round(Math.cos(-r)*(A+be)),u=Math.round(Math.sin(-r)*(A+be)),(t=n.createLinearGradient(d,h,s,u)).addColorStop(0,"rgba("+xe+","+c+")"),t.addColorStop(1,"rgba("+xe+",0)")),n.strokeStyle=t,n.beginPath(),n.arc(0,0,F?A:Math.round(vt?A+be/2+Ce/2+ne/2:A+be/2),a<0?0:-r,a<0?r:0,p),n.lineWidth=F?2*me:Math.round(vt?Ce+be+ne:be),ii(n)}else F||(r=Math.min(.2*o,Math.PI/8),s=Math.round(Math.cos(r)*(A+be)),u=Math.round(Math.sin(r)*(A+be)),d=Math.round(A+be),h=0,(t=n.createLinearGradient(s,u,d,h)).addColorStop(0,"rgba("+xe+",0)"),t.addColorStop(1,"rgba("+xe+","+c+")"),n.strokeStyle=t,n.beginPath(),n.arc(0,0,Math.round(vt?A+be/2+Ce/2:A+be/2),0,r,!1),n.lineWidth=Math.round(vt?Ce+be:be),ii(n),r=2*Math.PI-r,s=Math.round(Math.cos(r)*(A+be)),u=Math.round(Math.sin(r)*(A+be)),(t=n.createLinearGradient(s,u,d,h)).addColorStop(0,"rgba("+xe+",0)"),t.addColorStop(1,"rgba("+xe+","+c+")"),n.strokeStyle=t,n.beginPath(),n.arc(0,0,Math.round(vt?A+be/2+Ce/2:A+be/2),0,r,!0),n.lineWidth=Math.round(vt?Ce+be:be),ii(n));return Zt("_generateMainCanvas"),a}function ni(){let e=Ee.currentViewpoint.create3DRayFrom2DPoint(he),t=(new i.Plane).setFromNormalAndCoplanarPoint(se,oe);return e.intersectPlane(t)}function ri(e){return void 0===q||void 0===z||(q<z?e>=q&&e<=z:e>=q||e<=z)}function li(e){return e<.1?0:e>=.1&&e<.4?.25:e>=.4&&e<.7?.55:e>=.7&&e<.9?.75:1}function oi(e){let t=k.getMatrix().elements,a=new i.Vector3(t[4],t[5],t[6]),n=(de-e)*Math.PI/180;Pe||(n=-n);let r=(new i.Matrix4).makeRotationAxis(se,n);return a.applyMatrix4(r),a.dot(Ue.getUpDirection())<0}function si(e){e.setSSAO(!1),e.setShadow(!1,!1),e.setRenderDepth(0),e.excludeFromCSO(!0),e.excludeFromHighlight(!0,!0),e.setFrustumCulled(!1)}function ui(e){let t=de,i=e.value;L===D.FULLSYMETRIC_GRADUATIONS&&-1===ce&&-360===(i-=360)&&(i=0),Mt=!0,k.setValue(i),Mt=!1,yt=!1,ti("AngularRulerManipulateBegin",{eventName:"AngularRulerManipulateBegin",direction:se,value:de,event:e.event}),ti("AngularRulerManipulate",{eventName:"AngularRulerManipulate",direction:se,value:de,diffAngle:de-t,rulerDragged:!1,event:e.event}),ti("AngularRulerManipulateEnd",{eventName:"AngularRulerManipulateEnd",status:"Validated",direction:se,value:de,event:e.event})}function di(e){if(Mt)return void(yt=!1);yt=!0;let t=e.node;t&&(t.setRatio(1.05),Ee.setTemporaryCursor("pointer"),Ee.render())}function hi(e){if(Mt)return;yt=!1;let t=e.node;t&&(t.setRatio(1),Ee.unsetTemporaryCursor(),Ee.render())}function ci(e,t,i){Kt("_drawTextCanvas");let a=i||{},n=a.isCurrentValue||!1,r=a.onManipulatorPreactivated||!1,l=n&&Mt?1:2,o=fe*l*(n?1.2:1),s=a.reverse;t.width=n?(ne+Ce)*l:Ce*l,t.height=2*o;let u=t.getContext("2d");u.globalAlpha=a.alpha,u.clearRect(0,0,t.width,t.height);let d,h=0,c=0;!s||n&&Mt&&Vt&&It?(h=10*l,c=t.height-10*l):(u.rotate(Math.PI),u.textAlign="right",h=-10*l,c=-10*l),u.translate(h,c),d=n?vt||wt?"rgba("+xe+",1)":xt?"rgba("+Ne+",1)":r?"rgba("+Re+",1)":"rgba("+Ie+", 1)":"rgba("+Ve+",1)";let p=jt(e);X&&n&&(p=p.toString()+" "+le);let g=u.font.split(" "),M=F?"bold ":"900 ";return u.font=M+o+"pt "+g[g.length-1],n&&(vt||xt&&"220,220,220"===Ve&&!wt)&&(u.shadowColor="white",u.shadowBlur=3*l),u.fillStyle=d,u.fillText(p,0,0),t.textDisplayed=p,Zt("_drawTextCanvas"),t}function pi(e,t){Kt("_createGraduationNode");let l,s,u=null,d=null,h=t.alpha,c=t.color,p=jt(e,!1,!0),g=(de-e)*Math.PI/180;for(Pe&&(g=-g),l=0;l<tt.length;l++)if(!1===tt[l].toDispose&&tt[l].associatedValue===e){d=tt[l];break}if(!d){for(l=0;l<tt.length;l++)if(!0===tt[l].toDispose){(d=tt[l]).manipulator.associatedValue=e,d.texture.dispose();break}if(!d){d={};let t=ge>=7?Math.floor(ge/2)-1:ge-1,l=180*B/(Math.PI*t),u=n.createRectangleNode({width:Ce,height:2*fe,fill:!0,noEdge:!0});si(u),u.setMatrix((new i.Matrix4).makeTranslation(0,-fe,0));let h=new o({ratio:1});h.addChild(u),d.texture=new i.Texture,(s=new i.MeshBasicMaterial({map:d.texture,transparent:!0,enableClipPlanes:!1})).force=!0,s.depthTest=!1,h.setMaterial(s);let c=n.createCircleNode({radius:(A+be+Ce+ne)*Me,segments:32,fill:!0,noEdge:!0,startAngle:-l*Math.PI/180,endAngle:l*Math.PI/180});si(c),(s=new i.MeshBasicMaterial({map:Wt,transparent:!0,enableClipPlanes:!1})).force=!0,s.depthTest=!1,c.setMaterial(s),c.setMatrix((new i.Matrix4).makeTranslation(-(A+be)*Me,0,-2*De));let p=new r({viewer:Ee,value:e,linkedNode:h});d.manipulator=p,p.subscribe("Click",ui),p.subscribe("BeginManipulate",null),p.subscribe("Manipulate",null),p.subscribe("EndManipulate",null),p.subscribe("BeginPreactivate",di),p.subscribe("EndPreactivate",hi),d.manipNode=new a,d.manipNode.addChild(h),d.manipNode.addChild(c),d.token=p.linkToNode(d.manipNode),tt.push(d)}d.associatedValue=e}for(l=0;l<it.length;l++)if(!1===it[l].toDispose&&it[l].associatedValue===p&&it[l].associatedAlpha===h&&it[l].associatedColor===c&&it[l].reverse===t.reverse){u=it[l];break}if(!u){if(it.length===et){for(l=0;l<it.length;l++)if(!0===it[l].toDispose){u=it[l];break}}else u={canvas:document.createElement("canvas")},it.push(u);u.canvas=ci(e,u.canvas,t),u.associatedValue=p,u.associatedAlpha=h,u.associatedColor=c,u.reverse=t.reverse}u.toDispose=!1,d.texture.image=u.canvas,d.texture.needsUpdate=!0,d.toDispose=!1;let M=-Math.sin(g)*(A+be+ye)*Me,f=(-re/2-Math.cos(B)*A)*Me+Math.cos(g)*(A+be+ye)*Me,m=(new i.Matrix4).makeTranslation(f,M,0),b=(new i.Matrix4).makeRotationZ(-1*g);d.manipNode.setMatrix(m.multiply(b)),d.manipNode.setVisibility(!0),He.addChild(d.manipNode),Zt("_createGraduationNode")}function gi(){Kt("_generateGraduations");let e=Mt||Nt?1:2,t=Dt;t.width=Math.round(e*re),t.height=Math.round(e*re);let i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),i.translate(Math.round(e*re/2),Math.round(e*re/2));let a=1,n=1,r=de*Math.PI/180,l=180*(r-B)/Math.PI;l=(Math.floor(l/K)*K).valueOf();let o=K;ge>=7&&(o=2*K);let s=2*ve*e,u=0,d=0,h=0,c=0,p=0,g=0,M=0,f=0,m=!1,b=[];i.textBaseline="middle";let v,w,y=[],T=[],C=(A+be)*Math.sin(B)*e;for(v=0;v<=ge;v++){if(d=(v*K+l)*Math.PI/180,u=Pe?d-r:r-d,h=Math.sin(u)*(A+be)*e,c=Math.cos(u)*(A+be)*e,p=Math.sin(u)*A*e,g=Math.cos(u)*A*e,M=Math.sin(u)*(A+.75*be)*e,f=Math.cos(u)*(A+.75*be)*e,B===Math.PI)a=1;else if(Math.abs(u)<=Math.PI/2)if(B<Math.PI/2){let e=C-Math.abs(h);a=e<s?e/s:1}else a=1;else{let t=(A+be)*Math.abs(Math.cos(B))*e-Math.abs(c);a=t<s?t/s:1}Math.abs(u)<=Math.PI/4&&Math.abs(h)<s?(n=Math.max(Math.abs(h)/s*2-1,0),m=!0):(n=a,m=!1);let t,i,x,S=d=v*K+l;if(d<0?S=360+d:d>=360&&(S=d-360),d%o==0&&(((t=Math.round(10*Math.max(n-.2,0))/10)<.1||m&&!bt&&t<.8)&&(t=0),0!==t&&(t=li(t+.1),ri(S)||(t=0),0!==t&&b.push({val:S,alpha:t,nearCurrentValue:m}))),ri(S)&&0!==(t=Math.round(10*Math.max(n-.2,0))/10)&&0!==(t=li(t+.1))){let i={moveTo:{x:Math.round(g),y:Math.round(p)},alpha:t,lineWidth:me*e*2};i.lineTo=d%o!=0?{x:Math.round(f),y:Math.round(M)}:{x:Math.round(c),y:Math.round(h)},y.push(i),-1===T.indexOf(t)&&T.push(t)}for(w=1;w<Z;w++)if(x=i=(v+w/Z)*K+l,i<0?x=360+i:i>=360&&(x=i-360),ri(x)){let t=i*Math.PI/180-r;if(Pe||(t=-t),Math.abs(t)>B)continue;h=Math.sin(t)*(A+Te)*e,c=Math.cos(t)*(A+Te)*e,p=Math.sin(t)*A*e,g=Math.cos(t)*A*e;let n=Math.abs(p)<s?Math.max(2*Math.abs(p)/s-1,0):a;if(B===Math.PI&&Math.cos(t)<0&&(n=1),0===(n=li(n)))continue;let l={moveTo:{x:Math.round(g),y:Math.round(p)},alpha:n,lineWidth:me*e};l.lineTo={x:Math.round(c),y:Math.round(h)},y.push(l),-1===T.indexOf(n)&&T.push(n)}}let x=[me*e*2,me*e];for(let e=0;e<x.length;e++)for(v=0;v<T.length;v++){for(i.beginPath(),i.strokeStyle=0===e&&vt||1===e&&wt?"rgba("+xe+","+T[v]+")":"rgba(0,0,0,"+T[v]+")",w=0;w<y.length;w++)y[w].alpha===T[v]&&x[e]===y[w].lineWidth&&(i.lineWidth=y[w].lineWidth,i.moveTo(y[w].moveTo.x,y[w].moveTo.y),i.lineTo(y[w].lineTo.x,y[w].lineTo.y));ii(i)}for(v=0;v<tt.length;v++)tt[v].toDispose=!0,tt[v].manipNode.setVisibility(!1);for(v=0;v<it.length;v++)it[v].toDispose=!0;for(v=0;v<b.length;v++){let e=jt(b[v].val);for(w=0;w<tt.length;w++)tt[w].associatedValue===b[v].val&&(tt[w].toDispose=!1);for(w=0;w<it.length;w++)it[w].associatedValue===e&&it[w].associatedAlpha===b[v].alpha&&it[w].associatedColor===Ve&&(it[w].toDispose=!1)}for(v=0;v<b.length;v++){let e=oi(b[v].val);pi(b[v].val,{alpha:b[v].alpha,nearCurrentValue:b[v].nearCurrentValue,color:Ve,reverse:e})}return Zt("_generateGraduations"),t}function Mi(e){xt=!1,yt=!1;let t=de,i=e?e.event?e.event:e.from[0].event:null;if(!Ct&&qe.children.length){let e=qe.children[0].getInputValue();if(!isNaN(e)&&e&&""!==e){let a=parseFloat(e)/Y;ft=!0,k.setValue(a),ft=!1,ti("AngularRulerManipulate",{eventName:"AngularRulerManipulate",direction:se,value:de,diffAngle:de-t,rulerDragged:!1,event:i,fromEditor:!0})}}Xt(),ti("AngularRulerManipulateEnd",{eventName:"AngularRulerManipulateEnd",status:"Validated",direction:se,value:de,event:i})}function fi(e){xt=!1,yt=!1,e&&e.doNotRefresh||Xt();let t=e?e.event?e.event:e.from?e.from[0].event:null:null;ti("AngularRulerManipulateEnd",{eventName:"AngularRulerManipulateEnd",status:"Cancelled",direction:se,value:de,event:t})}function mi(a){if(Mt=!1,!qe.children.length){let n=jt(de,!0),l=$;l<1?l/=Q>0?10:100:l*=Q>0?10:100,n=Math.round(n*l)/l;let o=new t({value:n,okCB:Mi,cancelCB:fi,startValue:q*Y,endValue:z*Y,frmWindow:e});new r({viewer:Ee}).linkToNode(o),qe.addChild(o),a.event.from[0].currentPosition.x&&(he.x=a.event.from[0].currentPosition.x),a.event.from[0].currentPosition.y&&(he.y=a.event.from[0].currentPosition.y);let s=ni(),u=(new i.Matrix4).makeTranslation(s.x,s.y,s.z),d=(new i.Matrix4).getInverse(ke.getMatrix());qe.setMatrix(d.multiply(u));let h=-30,c=-30,p=155,g=30;(s=a.event.from[0].currentPosition).x+h<0?h=-1*s.x+15:s.x+h+p>Ee.SCREEN_WIDTH&&Ee.SCREEN_WIDTH>p&&(h=h+-1*(s.x+h+p-Ee.SCREEN_WIDTH)-15),s.y+c<0?c=-1*s.y+15:s.y+c+g>Ee.SCREEN_HEIGHT&&Ee.SCREEN_HEIGHT>g&&(c=c+-1*(s.y+c+g-Ee.SCREEN_HEIGHT)-15),o.setOffset(new i.Vector2(h,c)),Xe.setVisibility(!1),gt=!0,Ee.render()}}function bi(){let e=de-j;e<0&&(e=360+e);let t,i,a,n=Pe?e<=180:e>180;F?(t=N,i=I,a=V):(t=n&&H?w:H?m:g,i=n&&H?T:H?v:f,a=n&&H?y:H?b:M);let r=!0===Ct?i:Tt?a:t;Oe.getMaterial().map!==r&&(Oe.getMaterial().map=r),Ee.render()}function vi(){Mt||(Ft.dispose(),Ft.image=ci(de,_t,{isCurrentValue:!0,onManipulatorPreactivated:!0,alpha:1,reverse:oi(de)}),Ft.needsUpdate=!0,Je.setRatio(1.05),yt=!0,Ee.setTemporaryCursor("pointer"),Ee.render())}function wi(){Mt?yt=!1:(Ft.dispose(),Ft.image=ci(de,_t,{isCurrentValue:!0,onManipulatorPreactivated:!1,alpha:1,reverse:oi(de)}),Ft.needsUpdate=!0,Je.setRatio(1),yt=!1,Ee.unsetTemporaryCursor(),Ee.render())}function yi(e){Kt("_entireManipulationMeasure"),k.initValue=de,Mt=!0,Vt=e&&e.event&&e.event.from&&e.event.from.length&&"Touch"===e.event.from[0].type,Ee.setTemporaryCursor("-webkit-grabbing",10),ti("AngularRulerManipulateBegin",{eventName:"AngularRulerManipulateBegin",value:de,direction:se,event:e.event})}function Ti(e){Kt("_manipulateCB");let t=k.getSnappedRotationValue(e),i=t.snappedRotationAngle;if(0!==t.returnCode||void 0===i)return;let a=de;k.setValue(i+k.initValue),ti("AngularRulerManipulate",{eventName:"AngularRulerManipulate",value:i,diffAngle:de-a,rulerDragged:!0,direction:se,event:e.event}),Zt("_manipulateCB")}function Ci(e,t){vt=!1,wt=!1,Ee.unsetTemporaryCursor(),t||!1||Xt(),ti("AngularRulerManipulateEnd",{eventName:"AngularRulerManipulateEnd",status:"Validated",direction:se,value:de,event:e.event}),Mt=!1,Zt("_entireManipulationMeasure")}function xi(e){e.event.from[0].currentPosition.x&&(he.x=e.event.from[0].currentPosition.x),e.event.from[0].currentPosition.y&&(he.y=e.event.from[0].currentPosition.y);let t=(new i.Vector3).copy(ni()).sub(oe),a=de,n=180*te.angleTo(t)/Math.PI;if((new i.Vector3).copy(te).cross(t).dot(se)<0&&(n=360-n),Math.abs(a-n)>=5){let t=K/Z;n=Math.round(n/t)*t,k.setValue(n),yi(e),ti("AngularRulerManipulate",{eventName:"AngularRulerManipulate",direction:se,value:de,diffAngle:de-a,rulerDragged:!1,event:e.event})}else yi(e);Ct=!0}function Si(e){if(Mt)return void(yt=!1);e.event.from[0].currentPosition.x&&(he.x=e.event.from[0].currentPosition.x),e.event.from[0].currentPosition.y&&(he.y=e.event.from[0].currentPosition.y);let t=(new i.Vector3).copy(ni()).sub(oe),a=de,n=180*te.angleTo(t)/Math.PI;(new i.Vector3).copy(te).cross(t).dot(se)<0&&(n=360-n),Tt=!1,Math.abs(a-n)<5?(Tt=!0,F||(We.setVisibility(!1),Le.setVisibility(!0))):F||(We.setVisibility(!0),Le.setVisibility(!1)),Ee.setTemporaryCursor("pointer"),bi()}function Ri(){yt=!1,Tt=!1,Mt||(We.setVisibility(!1),Le.setVisibility(!0),Ee.unsetTemporaryCursor(),bi())}function Ni(){if(Kt("_initRulerParameters"),!St){if(!k.origin)return;if(oe=(new i.Vector3).copy(k.origin),!k.direction)return;se=(new i.Vector3).copy(k.direction).normalize();let e,t=D.DEG_UNIT,a=!1;if(Y=1,"number"==typeof k.unit||"string"==typeof k.unit)k.unit&D.RAD_UNIT||"rad"===k.unit?(t=D.RAD_UNIT,Y=Math.PI/180):k.unit&D.GRAD_UNIT||"grad"===k.unit?(t=D.GRAD_UNIT,Y=1/.9):k.unit&D.MRAD_UNIT||"mrad"===k.unit?(t=D.MRAD_UNIT,Y=1e3*Math.PI/180):k.unit&D.INPERFOOT_UNIT||"inchperfoot"===k.unit?(t=D.INPERFOOT_UNIT,Y=1/4.77464829):(k.unit&D.PERCENT_UNIT||"percent"===k.unit)&&(t=D.PERCENT_UNIT,Y=100/360);else if(window.widget&&window.widget.hasPreference&&window.widget.hasPreference("Angle")){let e=window.widget.getValue("Angle");if(e)switch(e){case"deg":t=D.DEG_UNIT,Y=1;break;case"rad":t=D.RAD_UNIT,Y=Math.PI/180}}for(let e=0;e<U.length;e++)if(t===U[e].unit&&le!==U[e].nls){a=!0,le=U[e].nls;break}if(X="boolean"!=typeof k.displayUnit||k.displayUnit,O="number"==typeof k.radius&&!isNaN(k.radius)&&k.radius>=0?k.radius:0,G="number"==typeof k.worldRadius&&!isNaN(k.worldRadius)&&k.worldRadius>=0?k.worldRadius:0,k.originVector&&(ue=(new i.Vector3).copy(k.originVector).normalize()),ue&&Math.round(100*ue.dot(se))/100!=0)return;if("number"!=typeof k.openingAngle||isNaN(k.openingAngle)?B=45:((k.openingAngle<-360||k.openingAngle>360)&&(k.openingAngle=k.openingAngle%360),k.openingAngle<0&&(k.openingAngle=360+k.openingAngle),0===k.openingAngle&&(k.openingAngle=360),B=k.openingAngle/2),B*=Math.PI/180,K="number"==typeof k.mainGrad&&!isNaN(k.mainGrad)&&k.mainGrad>0?k.mainGrad:10,Z="number"==typeof k.nbSecondaryGrads&&!isNaN(k.nbSecondaryGrads)&&k.nbSecondaryGrads>=0?k.nbSecondaryGrads+1:5,q="number"!=typeof k.startValue||isNaN(k.startValue)?void 0:k.startValue,z="number"!=typeof k.endValue||isNaN(k.endValue)?void 0:k.endValue,void 0!==q&&void 0!==z&&((q<-360||q>360)&&(q%=360),q<0&&(q=360+q),(z<-360||z>360)&&(z%=360),z<0&&(z=360+z),q===z&&(z=void 0,q=void 0)),j=Jt(j="number"!=typeof k.originValue||isNaN(k.originValue)?0:k.originValue),L=k.graduationsDisplay===D.SYMETRIC_GRADUATIONS||k.graduationsDisplay===D.FULLSYMETRIC_GRADUATIONS||k.graduationsDisplay===D.ORIENTED_GRADUATIONS?k.graduationsDisplay:D.DEFAULT_GRADUATIONS,F="boolean"==typeof k.lightDisplay&&k.lightDisplay,W="boolean"==typeof k.displayRulerDuringLocalTransfo&&k.displayRulerDuringLocalTransfo,H="boolean"==typeof k.displayOrigin&&k.displayOrigin,J="boolean"!=typeof k.hideOnEmptySelection||k.hideOnEmptySelection,Q=0,"number"==typeof k.nbDecimals&&(k.nbDecimals>=0&&k.nbDecimals<=9?Q=k.nbDecimals:k.nbDecimals<0?Q=0:k.nbDecimals>9&&(Q=9)),ne=0,X)if(t!==D.DEG_UNIT&&t!==D.PERCENT_UNIT){let e=At.getContext("2d"),t=e.font.split(" "),i=F?"bold ":"900 ";e.font=i+1.1*fe+"pt "+t[t.length-1],ne=Math.round(10*e.measureText(" "+le).width)/10}else ne=5;if(Kt("_updateGraduationColors"),255*new i.Color(Ee.backgroundColor).getHSL().l>120?(Ve="80, 80, 80",Ie="0,0,0"):(Ve="220,220,220",Ie="240,240,240"),Zt("_updateGraduationColors"),Mt=!1,vt=!1,wt=!1,Ct=!1,xt=!1,bt=!1,1===Ue.getProjectionType())e=Ue.camera.top-Ue.camera.bottom;else{let t=Ue.getAngle()*Math.PI/180,a=(new i.Vector3).copy(Ue.getEyePosition()),n=(new i.Vector3).copy(oe),r=(new i.Vector3).subVectors(n,a);e=2*Math.tan(.5*t)*r.length()}let n=Ue.camera.height&&Ue.camera.fullHeight?Ue.camera.height/Ue.camera.fullHeight:1;(Me=e*n/Ee.SCREEN_HEIGHT)<1&&(De=Me),A=Math.max(G/Me,0),A+=O,A=Math.max(A,100);let r=Ce;if($=1,Q>0?(Ce=100+15*Q,$=Math.pow(10,Q)):Ce=100,re=2*(A+be+Ce+ne),(Ce!==r||a)&&(H&&(Ut=document.createElement("canvas")),it.length=0,Rt=!1),ae=(new i.Vector3).copy(se),ue?te=(new i.Vector3).copy(ue):(0===(ie=new i.Vector3(ae.y,ae.x,0).normalize()).x&&0===ie.y&&0===ie.z&&(ie=new i.Vector3(ae.z,0,ae.x).normalize()),te=(new i.Vector3).crossVectors(ae,ie).normalize()),ie=(new i.Vector3).crossVectors(ae,te).normalize(),ae.dot(Ue.getSightDirection())>0?(ie.multiplyScalar(-1),ae.multiplyScalar(-1),Pe=!0):Pe=!1,ge=Math.round(2*B*180/(Math.PI*K)),ge++,0===nt){let e=!1,t=function(){if(qe&&qe.children.length&&fi({doNotRefresh:!0}),W){let t=(new i.Vector3).copy(se).dot(Ue.getSightDirection());Pe===t>0?Rt=!0:e=!0,$t()?(ke.setVisibility(!1),Ae.setVisibility(!1)):(e&&Rt&&Nt&&(Rt=!1,e=!1),Xt()),Rt=!1}else!0===k.getVisibleFlag()&&(k.setVisibleFlag(!1),e=!0),Nt||(ee&&(clearTimeout(ee),ee=null),ee=setTimeout(Ht,200))};Ht=function(){W||e&&(k.setVisibleFlag(!0),0===G?($t()?(ke.setVisibility(!1),Ae.setVisibility(!1)):Xt(),Nt=!1):(Nt=!1,Xt())),e=!1},nt=s.subscribe({event:"/VISU/"},function(e){"@onViewpointBeginMove"===e.eventType?Nt=!0:"@onViewpointChange"===e.eventType?t():"@onViewpointEndMove"===e.eventType&&(Ht(),Nt=!1)}),at=Ee.onBackgroundModify(function(){k.getVisibleFlag()&&Xt()}),d.addEvent(Ee.canvas,"onPrimaryPointerClick",Qt),d.addEvent(Ee.canvas,"onPrimaryPointerMoveUnique",Qt)}St=!0}Zt("_initRulerParameters")}Xt=function(){Kt("_internalDisplay"),Yt(),Ni(),qt();let e=k.value;L===D.FULLSYMETRIC_GRADUATIONS&&-1===ce&&-360===(e-=360)&&(e=0),k.setValue(e),Zt("_internalDisplay")},Yt=function(){if(Kt("_internalClear"),St){if(ee&&Ht&&(clearTimeout(ee),ee=null,Ht(),Ht=null),!Rt){for(let e=0;e<tt.length;e++)tt[e].manipulator&&0!==tt[e].token&&tt[e].manipulator.unlink(tt[e].token),ei(tt[e].manipNode,!1),tt[e].texture.dispose();tt.splice(0,tt.length),0!==ht&&ct.unlink(ht),0!==st&&rt.unlink(st),st=0,ht=0,ct=null,rt=null}0!==dt&&ut.unlink(dt),0!==lt&&ot.unlink(lt),lt=0,dt=0,ot=null,ut=null,ei(ke,!1),ei(Ae,!1),Ee.removeNode(ke),Ee.removeNode(Ae),0===nt||W&&(!W||Nt)||(s.unsubscribe(nt),Ee.unsubscribe(at),d.removeEvent(Ee.canvas,"onPrimaryPointerClick",Qt),d.removeEvent(Ee.canvas,"onPrimaryPointerMoveUnique",Qt),nt=0),St=!1,de=null}Zt("_internalClear")},qt=function(){if(Kt("_internalBuild"),!St)return;let e;if(A<Ee.SCREEN_WIDTH||A<Ee.SCREEN_HEIGHT){let t,a;if(si(Le=n.createRectangleNode({width:re*Me,height:re*Me,fill:!0,noEdge:!0})),(e=new i.MeshBasicMaterial({map:Gt,transparent:!0,enableClipPlanes:!1})).force=!0,e.depthTest=!1,Le.setMaterial(e),Le.setMatrix((new i.Matrix4).makeTranslation(-(re+A*Math.cos(B))*Me,-re*Me/2,-3*De)),(!Nt&&0===G||0!==G)&&(pt=!0),F||(si(We=n.createRectangleNode({width:re*Me,height:re*Me,fill:!0,noEdge:!0})),!H&&pt&&(Lt.dispose(),Lt.image=ai(!0),Lt.needsUpdate=!0),(e=new i.MeshBasicMaterial({map:Lt,transparent:!0,enableClipPlanes:!1})).force=!0,e.depthTest=!1,We.setMaterial(e),We.setMatrix((new i.Matrix4).makeTranslation(-(re+A*Math.cos(B))*Me,-re*Me/2,-3*De)),si(Fe=n.createRectangleNode({width:re*Me,height:re*Me,fill:!0,noEdge:!0})),(e=new i.MeshBasicMaterial({map:Bt,transparent:!0,enableClipPlanes:!1})).force=!0,e.depthTest=!1,Fe.setMaterial(e),Fe.setMatrix((new i.Matrix4).makeTranslation(-(re+A*Math.cos(B))*Me,-re*Me/2,-2*De))),!Rt){si(a=n.createRectangleNode({width:ne+Ce,height:2.4*fe,fill:!0,noEdge:!0})),a.setMatrix((new i.Matrix4).makeTranslation(0,1.2*-fe,0)),(Je=new o({ratio:1})).addChild(a),Je.setVisibility(!0),(e=new i.MeshBasicMaterial({map:Ft,transparent:!0,enableClipPlanes:!1})).force=!0,Je.setMaterial(e),Xe.addChild(Je),t=Math.PI/12;let l=n.createCircleNode({radius:(A+be+Ce+ne)*Me,segments:32,fill:!0,noEdge:!0,startAngle:-t,endAngle:t});if(si(l),(e=new i.MeshBasicMaterial({map:Wt,transparent:!0,enableClipPlanes:!1})).force=!0,e.depthTest=!1,l.setMaterial(e),l.setMatrix((new i.Matrix4).makeTranslation(-(A+be)*Me,0,0)),Xe.addChild(l),!F){let a=n.createCircleNode({radius:(A+be+Ce+ne)*Me,segments:32,fill:!0,noEdge:!0,startAngle:-2*t,endAngle:2*t});si(a),(e=new i.MeshBasicMaterial({map:Wt,transparent:!0,enableClipPlanes:!1})).force=!0,e.depthTest=!1,a.setMaterial(e),a.setMatrix((new i.Matrix4).makeTranslation(-(A+be)*Me,0,-2*De)),Xe.addChild(a)}let s=F?(-re/2+(1-Math.cos(B))*A+ye)*Me:(-re/2+(1-Math.cos(B))*A+be+ye)*Me;if(Xe.setMatrix((new i.Matrix4).makeTranslation(s,0,0)),0===st){(rt=new r({viewer:Ee,axis:(new i.Vector3).copy(se),center:oe})).subscribe("Click",mi),rt.subscribe("BeginManipulate",function(e){Ct=!1,xt=!0,yi(e)});let e=!0;rt.subscribe("Manipulate",function(t){e=!1,Ti(t)}),rt.subscribe("EndManipulate",function(t){Ct=!1,xt=!1,Ci(t,e)}),rt.subscribe("BeginPreactivate",vi),rt.subscribe("EndPreactivate",wi),st=rt.linkToNode(Xe)}}(t=1.5*B)>Math.PI&&(t=Math.PI);let s=(A+be/2)*Me,u=n.createCircleNode({radius:s,segments:32,fill:!0,noEdge:!0,startAngle:-t,endAngle:t});si(u),Ze.addChild(u),(e=new i.MeshBasicMaterial({map:Wt,transparent:!0,enableClipPlanes:!1})).force=!0,e.depthTest=!1,Ze.setMaterial(e),Ze.setMatrix((new i.Matrix4).makeTranslation(-(re/2+A*Math.cos(B))*Me,0,De)),0===dt&&((ut=new r({viewer:Ee,axis:(new i.Vector3).copy(se),center:oe})).subscribe("BeginManipulate",xi),ut.subscribe("Manipulate",Ti),ut.subscribe("EndManipulate",function(e){Ct=!1,Ci(e)}),ut.subscribe("Click",function(e){Ct=!1,Ci(e)}),ut.subscribe("Preactivate",Si),ut.subscribe("EndPreactivate",Ri),dt=ut.linkToNode(Ze)),t=Math.min(-2*B,Math.PI),s=F?(A-be/2)*Me:A*Me;let d,h,c=n.createCircleNode({radius:s,segments:32,fill:!0,noEdge:!0,startAngle:-t,endAngle:t});if(si(c),je.addChild(c),(e=new i.MeshBasicMaterial({map:Wt,transparent:!0,enableClipPlanes:!1})).force=!0,e.depthTest=!1,je.setMaterial(e),je.setMatrix((new i.Matrix4).makeTranslation(-(re/2+A*Math.cos(B))*Me,0,2*De)),H){if(!Rt&&!F){si(a=n.createRectangleNode({width:Ce,height:2*fe,fill:!0,noEdge:!0})),a.setMatrix((new i.Matrix4).makeTranslation(0,-fe,0));let l=new o({ratio:1});l.addChild(a),zt.image=ci(j,Ut,{alpha:1,reverse:oi(j)}),zt.needsUpdate=!0,(e=new i.MeshBasicMaterial({map:zt,transparent:!0,enableClipPlanes:!1})).force=!0,e.depthTest=!1,l.setMaterial(e),Ke.addChild(l);let s=ge>=7?Math.floor(ge/2)-1:ge-1;t=B/s;let u=n.createCircleNode({radius:(A+be+Ce+ne)*Me,segments:32,fill:!0,noEdge:!0,startAngle:-t,endAngle:t});si(u),(e=new i.MeshBasicMaterial({map:Wt,transparent:!0,enableClipPlanes:!1})).force=!0,e.depthTest=!1,u.setMaterial(e),u.setMatrix((new i.Matrix4).makeTranslation(-(A+be)*Me,0,-2*De)),Ke.addChild(u),(ct=new r({viewer:Ee,value:j,linkedNode:l})).subscribe("Click",ui),ct.subscribe("BeginManipulate",null),ct.subscribe("Manipulate",null),ct.subscribe("EndManipulate",null),ct.subscribe("BeginPreactivate",di),ct.subscribe("EndPreactivate",hi),ht=ct.linkToNode(Ke)}F?(d=16*Me,h=16*Me):(d=(be+we+4*me)*Me,h=H?(ve/2+2*me)*Me:(ve+me)*Me),si(Ge=n.createRectangleNode({width:d,height:h,fill:!0,noEdge:!0})),(e=new i.MeshBasicMaterial({map:F?P:C,transparent:!0,enableClipPlanes:!1})).force=!0,e.depthTest=!1,Ge.setMaterial(e)}if(F?(d=20*Me,h=20*Me):(d=(be+we+4*me)*Me,h=H?(ve/2+2*me)*Me:(ve+me)*Me),si(Oe=n.createRectangleNode({width:d,height:h,fill:!0,noEdge:!0})),(e=new i.MeshBasicMaterial({map:F?N:H?m:g,side:i.DoubleSide,transparent:!0,alphaTest:.05,enableClipPlanes:!1})).force=!0,e.depthTest=!1,Oe.setMaterial(e),Oe.setVisibility(!0),0===lt&&((ot=new r({viewer:Ee,axis:(new i.Vector3).copy(se),center:oe})).subscribe("Click",null),ot.subscribe("BeginManipulate",function(e){Ct=!0,xt=!1,yi(e)}),ot.subscribe("Manipulate",Ti),ot.subscribe("EndManipulate",function(e){Ct=!1,xt=!1,Ci(e)}),ot.subscribe("BeginPreactivate",function(){Tt=!0,Ee.setTemporaryCursor("pointer"),bi()}),ot.subscribe("EndPreactivate",function(){Tt=!1,Ee.unsetTemporaryCursor(),bi()}),lt=ot.linkToNode(Oe)),H)if(ke.addChild(Qe),F){let e=new l({type:"Spherical"});e.addChild(Ge),Ge.setMatrix((new i.Matrix4).makeTranslation(-20*Me*.4,-20*Me*.4,0)),Qe.addChild(e)}else Qe.addChild(Ge),ke.addChild(Ke);if(Ae.addChild(Le),ke.addChild(Xe),ke.addChild(Ze),ke.addChild(je),ke.addChild(Ye),ke.addChild(qe),F){let e=new l({type:"Spherical"});e.addChild(Oe),Oe.setMatrix((new i.Matrix4).makeTranslation(-20*Me/2,-20*Me/2,0)),Ye.addChild(e)}else Ye.addChild(Oe),Ae.addChild(We),Ae.addChild(Fe),ke.addChild(He);ke.addChild(ze)}let t=new i.Vector3((-re/2+(1-Math.cos(B))*A-we+10)*Me,0,0),a=new i.Vector3((-re/2-Math.cos(B)*A)*Me,0,0),s=n.createLineNode({points:[t,a]});si(s),(e=new i.LineBasicMaterial({color:"80, 80, 80"===Ve?0:16777215,opacity:.5,transparent:!0})).force=!0,e.depthTest=!1,s.setMaterial(e),Ae.addChild(s),H&&(t=new i.Vector3((-re/2+(1-Math.cos(B))*A-we+10)*Me,0,0),a=new i.Vector3((-re/2-Math.cos(B)*A)*Me,0,0),si(s=n.createLineNode({points:[t,a]})),$e.addChild(s),(e=new i.LineBasicMaterial({color:"80, 80, 80"===Ve?0:16777215,opacity:.5,transparent:!0})).force=!0,e.depthTest=!1,$e.setMaterial(e),Ae.addChild($e)),Ee.addNode(ke,!1),Ee.addNode(Ae,!1);let u=(new i.Vector3).copy(te).multiplyScalar((re/2+A*Math.cos(B))*Me),d=(new i.Vector3).copy(oe).add(u);Be=new i.Matrix4(te.x,ie.x,ae.x,d.x,te.y,ie.y,ae.y,d.y,te.z,ie.z,ae.z,d.z,0,0,0,1),ke.setMatrix(Be),Ae.setMatrix(Be),de=null,Zt("_internalBuild")},this.setValue=function(e){Kt("setValue");let t=this.value,a=e;ft&&!Mt&&L===D.ORIENTED_GRADUATIONS&&t>180&&t!==a&&(a=360-a),a=Jt(a),Mt&&a%360==0&&(t>=180?a=360:t<180&&(a=0)),pe=ce,L===D.FULLSYMETRIC_GRADUATIONS&&(Mt&&(a>300||a<60)?t<=180&&a>180&&t<a?ce=-1:t>180&&a<=180&&t>a&&(ce=1):Mt||(ce=e<0?-1:e>0?1:ce)),this.value=a,this.getVisibleFlag()&&function(){if(Kt("_internalRefresh"),!St)return void Xt();let e=(new i.Matrix4).makeRotationAxis(se,k.value*Math.PI/180),t=(new i.Matrix4).setPosition(oe),a=(new i.Matrix4).getInverse(t).multiply(Be),n=(new i.Matrix4).copy(e).multiply(a),r=(new i.Matrix4).copy(t).multiply(n);if(ke.setMatrix(r),Ae.setMatrix(r),(A<Ee.SCREEN_WIDTH||A<Ee.SCREEN_HEIGHT)&&k.value!==de){if(de=k.value,qe.removeChildren(),Le.setVisibility(!0),We.setVisibility(!1),Rt){0!==G&&((pt||H)&&(Gt.dispose(),Gt.image=ai(!1),Gt.needsUpdate=!0),pt=!1,H&&!F&&(Lt.dispose(),Lt.image=ai(!0),Lt.needsUpdate=!0),F||(Bt.dispose(),Bt.image=gi(),Bt.needsUpdate=!0));for(let e=0;e<tt.length;e++)if(!1===tt[e].toDispose){let t=(de-tt[e].associatedValue)*Math.PI/180;Pe&&(t=-t);let a=-Math.sin(t)*(A+be+ye)*Me,n=(-re/2-Math.cos(B)*A)*Me+Math.cos(t)*(A+be+ye)*Me;tt[e].manipNode.setMatrix((new i.Matrix4).makeTranslation(n,a,0).multiply((new i.Matrix4).makeRotationZ(-1*t)))}let e=F?(-re/2+(1-Math.cos(B))*A+ye)*Me:(-re/2+(1-Math.cos(B))*A+be+ye)*Me;Xe.setMatrix((new i.Matrix4).makeTranslation(e,0,0))}else He.removeChildren(),(pt||H)&&(Gt.dispose(),Gt.image=ai(!1),Gt.needsUpdate=!0),pt=!1,H&&!F&&(Lt.dispose(),Lt.image=ai(!0),Lt.needsUpdate=!0),F||(Bt.dispose(),Bt.image=gi(),Bt.needsUpdate=!0),Ft.dispose(),Ft.image=ci(de,_t,{isCurrentValue:!0,onManipulatorPreactivated:!1,alpha:1,reverse:oi(de)}),Ft.needsUpdate=!0;H&&L&&D.FULLSYMETRIC_GRADUATIONS&&pe!==ce&&(zt.dispose(),zt.image=ci(j,Ut,{alpha:1,reverse:oi(j)}),zt.needsUpdate=!0);let e=0;e=H?(ve/2+2*me)*Me:(ve+me)*Me;let n=de-j;n<0&&(n=360+n);let l,o,s=Pe?n<=180:n>180;F?(l=N,o=I):(l=s&&H?w:H?m:g,o=s&&H?T:H?v:f);let u=!0===Ct?o:l;Oe.getMaterial().map!==u&&(Oe.getMaterial().map=u);let d=new i.Matrix4;if(F?(d.makeTranslation((-re/2+(1-Math.cos(B))*A)*Me,0,0),Ye.setMatrix(d)):(H?d.makeTranslation((-re/2+(1-Math.cos(B))*A-we)*Me,s?-e:0,0):d.makeTranslation((-re/2+(1-Math.cos(B))*A-we)*Me,-e/2,0),Ye.setMatrix(d)),H){let n=(de-j)*Math.PI/180;Pe&&(n=-n);let l=!0;for(let e=0;e<tt.length;e++)tt[e].associatedValue===j&&(l=!1);if(l&&!F){let e=Math.abs(de-j);if(e<180&&e*Math.PI/180>B||e>=180&&(360-e)*Math.PI/180>B){let e=(new i.Matrix4).makeTranslation((-re/2-Math.cos(B)*A)*Me+Math.cos(n)*(A+be+ye)*Me,-Math.sin(n)*(A+be+ye)*Me,0);Ke.setMatrix(e.multiply((new i.Matrix4).makeRotationZ(-n)))}else l=!1}if(Ke.setVisibility(l),!F){let e=!0===Ct?s?R:x:s?S:C;Ge.getMaterial().map!==e&&(Ge.getMaterial().map=e)}let o=(new i.Matrix4).makeRotationAxis(se,j*Math.PI/180),u=(new i.Matrix4).copy(t).multiply(o.multiply(a)),d=new i.Matrix4;F?d.makeTranslation((-re/2+(1-Math.cos(B))*A)*Me,0,0):d.makeTranslation((-re/2+(1-Math.cos(B))*A-we)*Me,s?0:-e,0),Qe.setMatrix((new i.Matrix4).getInverse(r).multiply(u).multiply(d))}if(Mt&&Vt&&It){if(Xe.setVisibility(!1),!ze.children.length&&Ft){let e=new c({html:Ft.image});ze.setMatrix((new i.Matrix4).makeTranslation((-re/2+(1-Math.cos(B))*A)*Me,0,0)),ze.addChild(e)}ze.children[0].setOffset(new i.Vector2(-Ft.image.getContext("2d").measureText(Ft.image.textDisplayed).width/2,-85))}else Xe.setVisibility(!0),ze.removeChildren();bt=!0,yt=!1}if(H){let e=(new i.Matrix4).copy(t).multiply((new i.Matrix4).makeRotationAxis(se,j*Math.PI/180).multiply(a));$e.setMatrix((new i.Matrix4).getInverse(r).multiply(e))}ke.setVisibility(!$t()&&mt),Ae.setVisibility(!$t()&&mt),Ee.render(),Zt("_internalRefresh")}(),Zt("setValue")},this.getDisplayedValue=function(e){return jt(this.value,"boolean"!=typeof e||!e)},this.getMatrix=function(){return ke?(new i.Matrix4).copy(ke.getMatrixWorld()):null},this.setVisibleFlag=function(e){if(e!==mt){if(mt=e,ke.setVisibility(!$t()&&mt),Ae.setVisibility(!$t()&&mt),mt){let e=this.value;L===D.FULLSYMETRIC_GRADUATIONS&&-1===ce&&-360===(e-=360)&&(e=0),this.setValue(e)}Ee.render()}},this.getVisibleFlag=function(){return St?mt:null},this.setVisibilityFree=function(e){ke&&Ae&&ke.setVisibilityFree&&Ae.setVisibilityFree&&(Ae.setVisibilityFree(e),ke.setVisibilityFree(e))},this.getVisibilityFree=function(){return ke?ke.visibilityFree:null},this.clear=function(){pt=!1,gt=!1,Mt=!1,bt=!1,vt=!1,wt=!1,yt=!1,Tt=!1,Ct=!1,xt=!1,Rt=!1,Nt=!1,Vt=!1,It=!1,Yt()},this.subscribe=function(e,t){if(e&&t&&("AngularRulerManipulateBegin"===e||"AngularRulerManipulate"===e||"AngularRulerManipulateEnd"===e))return _e.subscribe({event:e},t)},this.unsubscribe=function(e){null!=e&&_e.unsubscribe(e)},this.getSnappedRotationValue=function(e){Kt("getSnappedRotationValue");let t=se.dot(e.axis)<0?2*Math.PI-e.angle:e.angle;t=180*t/Math.PI,(vt||wt)&&(pt=!0),vt=!1,wt=!1,It=!1;let a=ni(),n=(new i.Vector3).copy(a).sub(oe),r=ke.getMatrix().elements,l=new i.Vector3(r[0],r[1],r[2]),o=Math.abs(l.angleTo(n)),s=n.length(),u=1.5*B;if(u>Math.PI&&(u=Math.PI),s<(F?(A+be)*Me:(A+be+Ce+ne)*Me)&&o<u){let e;if("noSnap"!==(e=!F&&s<A*Me||F&&s<(A-be)*Me?"noSnap":!F&&s<(A+be)*Me||F&&s<(A+be)*Me?"snappingSmallGrads":F?"noSnap":"snappingMainGrads")){It=!0,pt=!0,vt="snappingMainGrads"===e,wt="snappingSmallGrads"===e,t+=this.initValue;let i="snappingSmallGrads"===e?K/Z:K;t=Jt(t=Math.round(t/i)*i),t-=this.initValue}}else F&&(It=s>A*Me&&s<(A+be/2+Ft.image.getContext("2d").measureText(Ft.image.textDisplayed).width)*Me);return Zt("getSnappedRotationValue"),{snappedRotationAngle:t,axis:se,returnCode:0}},this.beginManipulation=function(){Mt=!0,ke.setPickable(h.PICKTHROUGH)},this.endManipulation=function(){ke.setPickable(h.PICKABLE),Mt=!1,vt=!1,wt=!1},this.display=function(){pt=!1,gt=!1,Mt=!1,bt=!1,vt=!1,wt=!1,yt=!1,Tt=!1,Ct=!1,xt=!1,Rt=!1,Nt=!1,Vt=!1,It=!1,Xt()},this.refresh=function(){this.setValue(this.value)}}});return D.DEFAULT_GRADUATIONS=0,D.ORIENTED_GRADUATIONS=1,D.SYMETRIC_GRADUATIONS=2,D.FULLSYMETRIC_GRADUATIONS=3,D.DEG_UNIT=1,D.RAD_UNIT=2,D.GRAD_UNIT=4,D.MRAD_UNIT=8,D.INPERFOOT_UNIT=16,D.PERCENT_UNIT=32,D}),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Ruler/Ruler",["UWA/Core","UWA/Class","DS/CoreEvents/ModelEvents","DS/Ruler/RulerEditor","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Ruler/RulerManipulator","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/VisuEvents/EventsManager","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/SceneGraphNodes/CSS2DNode","i18n!DS/Ruler/assets/nls/Ruler"],function(e,t,i,a,n,r,l,o,s,u,d,h,c,p,g){"use strict";const M=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator.png"),void 0,null,null,!0);M.flipY=!1;const f=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Over.png"),void 0,null,null,!0);f.flipY=!1;const m=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_On.png"),void 0,null,null,!0);m.flipY=!1;const b=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half.png"),void 0,null,null,!0);b.flipY=!1;const v=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_Over.png"),void 0,null,null,!0);v.flipY=!1;const w=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0);w.flipY=!1;const y=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half.png"),void 0,null,null,!0),T=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_Over.png"),void 0,null,null,!0),C=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0),x=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerZeroArrowManip.png"),void 0,null,null,!0),S=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0),R=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_Over.png"),void 0,null,null,!0),N=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerZeroArrowManip.png"),void 0,null,null,!0);N.flipY=!1;const V=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_On.png"),void 0,null,null,!0);V.flipY=!1;const I=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerArrowManipulator_Half_Over.png"),void 0,null,null,!0);I.flipY=!1;const P=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLight.png"),void 0,null,null,!0),D=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLightOver.png"),void 0,null,null,!0),_=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLightOn.png"),void 0,null,null,!0),E=new n.ImageUtils.loadTexture(require.toUrl("DS/Ruler/assets/textures/Web3DUX_RulerLightZeroManip.png"),void 0,null,null,!0),U=require.toUrl("DS/Ruler/assets/textures/Web3DUX_OriginManipulator.png"),k=require.toUrl("DS/Ruler/assets/textures/Web3DUX_OriginManipulatorOn.png"),A=require.toUrl("DS/Ruler/assets/textures/Web3DUX_OriginManipulatorOver.png"),O=t.extend({init:function(t,G){if(!t)return void window.console.error("Ruler - Frame window argument missing");const B=G||{};this._parent(B),this.value=0,this.initValue=0,this.origin=new n.Vector3,this.direction=new n.Vector3(0,0,1),this.offset=B.offset,this.worldOffset=B.worldOffset,this.mainGrad=B.mainGrad,this.nbSecondaryGrads=B.nbSecondaryGrads,this.startValue=B.startValue,this.endValue=B.endValue,this.lightDisplay=B.lightDisplay,this.displayOrigin=B.displayOrigin,this.originDisplay=B.originDisplay,this.lockedOrigin=B.lockedOrigin,this.onOriginManipulator=B.onOriginManipulator,this.unit=B.unit,this.displayUnit=B.displayUnit,this.displayRulerDuringLocalTransfo=B.displayRulerDuringLocalTransfo,this.graduationsDisplay=B.graduationsDisplay,this.rulerDisplay=B.rulerDisplay,this.originValue=B.originValue,this.hideOnEmptySelection=B.hideOnEmptySelection,this.nbDecimals=B.nbDecimals,this.scale=B.scale;const L=this;let F,W,H,X,Y,q,z,K,Z,j,J,$,Q,ee,te,ie,ae,ne,re,le,oe,se,ue,de,he,ce,pe,ge,Me,fe,me=new n.Vector3,be=null,ve=null,we=new n.Vector2,ye=!0,Te=350,Ce=150,xe=14,Se=16,Re=1,Ne=30,Ve=15,Ie=10,Pe=20,De=.33*Ne,_e="255, 128, 0",Ee="115, 195, 225",Ue="130, 190, 220",ke="40, 90, 120",Ae="80, 80, 80",Oe="0,0,0",Ge=1,Be=0,Le=1,Fe=!1,We=te,He=te,Xe=new i,Ye=t.getViewer(),qe=t.getViewpoint(),ze=new l("rulerMainNode");ze.setVisibilityInTree(!1),ze.exludeFromBounding(!0),ze._getExcludeFromCSO=function(){return!0},ze.setNoZ(!0);let Ke,Ze,je=new l("rulerGraduationNode"),Je=new l,$e=new l,Qe=new l;Qe.setPickable(h.PICKTHROUGH);let et,tt,it,at,nt,rt=new l("originArrowMNode"),lt=new l("originManipMNode"),ot=null,st=0,ut=new l,dt=new l,ht=new l,ct=new s({constraintAxis:new n.Vector3(0,1,0),type:"Cylindrical"}),pt=null,gt=null,Mt=60,ft=[],mt=[],bt=0,vt=0,wt=0,yt=0,Tt=null,Ct=null,xt=null,St=0,Rt=0,Nt=null,Vt=!1,It=!1,Pt=!1,Dt=!1,_t=!1,Et=!0,Ut=!1,kt=!1,At=!1,Ot=!1,Gt=!1,Bt=!1,Lt=!1,Ft=!1,Wt=!1,Ht=!1,Xt=!1,Yt=!1,qt=!1,zt=null,Kt=document.createElement("canvas"),Zt=document.createElement("canvas"),jt=document.createElement("canvas"),Jt=document.createElement("canvas"),$t=document.createElement("canvas"),Qt=document.createElement("canvas"),ei=document.createElement("canvas");Qt.width=1,Qt.height=1;let ti=Qt.getContext("2d");ti.clearRect(0,0,Qt.width,Qt.height),ti.rect(0,0,Qt.width,Qt.height),ti.fillStyle="rgba(0,0,0,0)",ti.fill();let ii=new n.Texture,ai=new n.Texture,ni=new n.Texture,ri=new n.Texture;ri.image=Qt,ri.needsUpdate=!0;let li=new n.Texture;const oi={};let si,ui,di,hi;function ci(e){if(L.__performanceMeasures){for(let t=0;t<L.__performanceMeasures.measures.length;t++)if(L.__performanceMeasures.measures[t].id===e)return void(L.__performanceMeasures.measures[t].mark=(new Date).getTime());L.__performanceMeasures.measures.push({id:e,mark:(new Date).getTime(),cumulatedTime:0,nbCalls:0})}}function pi(e){if(L.__performanceMeasures)for(let t=0;t<L.__performanceMeasures.measures.length;t++)if(L.__performanceMeasures.measures[t].id===e)return L.__performanceMeasures.measures[t].cumulatedTime+=(new Date).getTime()-L.__performanceMeasures.measures[t].mark,void(L.__performanceMeasures.measures[t].nbCalls+=1)}function gi(){let e=Te*ce;return ne===O.SYMMETRIC&&(e+=2*Math.abs(ve-(re||0))),e}function Mi(e){e.setSSAO(!1),e.setShadow(!1,!1),e.setRenderDepth(1),e.excludeFromCSO(!0),e.excludeFromHighlight(!0,!0),e.setFrustumCulled(!1)}function fi(e){return e<.15?0:e>=.15&&e<.4?.25:e>=.4&&e<.7?.55:e>=.7&&e<.9?.75:1}function mi(e,t,i,a,n){ci("_fillRect"),e.fillRect(t,i,a,n),pi("_fillRect")}function bi(e,t){if(e){e.getMaterial()&&(e.getMaterial().map&&t&&e.getMaterial().map.dispose(),e.getMaterial().dispose());for(let i=e.children.length-1;i>=0;i--)bi(e.children[i],t);e.removeChildren()}}function vi(e,t){return Xe.publish({event:e,data:t,context:this})}function wi(e){if("@onPrimaryPointerMoveUniqueEvent"!==e.eventType){if(Vt)Vt=!1;else if(e&&!Dt&&!It){let t=ut.children[0];if(!t&&L.getVisibleFlag()){let t=Ye.getMousePosition(e.from[0].getCurrentPosition(Ye.canvas));setTimeout(function(){let e=null;if((Ot||Gt)&&(e="ruler"),null===e){let i=Ye.pick(t,"primHybrid",!1);if(0!==i.path.length&&i.path[0]||0!==(i=Ye.pick(t,"mesh",!1)).path.length&&i.path[0]||(e=""),null===e){let t=i.path[0];if(t&&t.externalPath)for(let i=0;i<t.externalPath.length;i++)"rulerMainNode"===t.externalPath[i].name&&(e="ruler")}}""===e&&oe&&L.clear()},0)}else t&&t.validateEditor()}}else!e.from[0].currentPosition||isNaN(e.from[0].currentPosition.x)||isNaN(e.from[0].currentPosition.y)||(we.x=e.from[0].currentPosition.x,we.y=e.from[0].currentPosition.y)}function yi(){ci("_getRatio");let e,t=0;if(1===qe.getProjectionType())e=qe.camera.top-qe.camera.bottom;else{let t=qe.getAngle()*Math.PI/180,i=qe.getEyePosition(),a=(new n.Vector3).copy(be).multiplyScalar(L.value),r=(new n.Vector3).copy(me).add(a),l=(new n.Vector3).subVectors(r,i);e=2*Math.tan(.5*t)*l.length()}return t=e*(qe.camera.height&&qe.camera.fullHeight?qe.camera.height/qe.camera.fullHeight:1)/Ye.SCREEN_HEIGHT,pi("_getRatio"),t}function Ti(e){Wt=!1,Ot=!1,Gt=!1;let t=ve,i=e?e.event?e.event:e.from[0].event:null;if(!Bt&&ut.children.length){let e=ut.children[0].getInputValue();if(!isNaN(e)&&e&&""!==e){let a=parseFloat(e)/j;_t=!0,L.setValue(a),_t=!1,vi("RulerManipulate",{eventName:"RulerManipulate",translationVector:(new n.Vector3).copy(be).multiplyScalar(ve-t),value:ve,direction:be,rulerDragged:!1,event:i,fromEditor:!0})}}vi("RulerManipulateEnd",{eventName:"RulerManipulateEnd",value:ve,direction:be,status:"Validated",event:i}),ui()}function Ci(e){Wt=!1,Ot=!1,Gt=!1;let t=e?e.event?e.event:e.from[0].event:null;vi("RulerManipulateEnd",{eventName:"RulerManipulateEnd",value:ve,direction:be,status:"Cancelled",event:t}),ui()}function xi(){return!be||Math.abs(be.dot(qe.getSightDirection()))>.95}function Si(){if(ci("_initRulerParameters"),!Ht){if(!L.origin)return;if(me=(new n.Vector3).copy(L.origin),!L.direction)return;be=(new n.Vector3).copy(L.direction).normalize(),F=L.scale||1,L.initOrigin||(L.initOrigin=(new n.Vector3).copy(L.origin));let e=O.MM_UNIT;if(j=1,"number"==typeof L.unit||"string"==typeof L.unit)L.unit&O.NM_UNIT||"nm"===L.unit?(e=O.NM_UNIT,j=Math.pow(10,6)):L.unit&O.MICRON_UNIT||"micron"===L.unit?(e=O.MICRON_UNIT,j=Math.pow(10,3)):L.unit&O.CM_UNIT||"cm"===L.unit?(e=O.CM_UNIT,j=Math.pow(10,-1)):L.unit&O.M_UNIT||"m"===L.unit?(e=O.M_UNIT,j=Math.pow(10,-3)):L.unit&O.HM_UNIT||"hm"===L.unit?(e=O.HM_UNIT,j=Math.pow(10,-5)):L.unit&O.KM_UNIT||"km"===L.unit?(e=O.KM_UNIT,j=Math.pow(10,-6)):L.unit&O.INCH_UNIT||"inch"===L.unit?(e=O.INCH_UNIT,j=1/25.4):L.unit&O.FOOT_UNIT||"foot"===L.unit?(e=O.FOOT_UNIT,j=1/304.8):L.unit&O.YARD_UNIT||"yard"===L.unit?(e=O.YARD_UNIT,j=1/914.4):L.unit&O.MILE_UNIT||"mile"===L.unit?(e=O.MILE_UNIT,j=1/1609344):(L.unit&O.NMILE_UNIT||"nmile"===L.unit)&&(e=O.NMILE_UNIT,j=1/1852e3);else if(window.widget&&window.widget.hasPreference&&window.widget.hasPreference("Length")){let t=window.widget.getValue("Length");if(t)switch(t){case"mm":e=O.MM_UNIT,j=1;break;case"cm":e=O.CM_UNIT,j=Math.pow(10,-1);break;case"m":e=O.M_UNIT,j=Math.pow(10,-3);break;case"km":e=O.KM_UNIT,j=Math.pow(10,-6);break;case"inch":e=O.INCH_UNIT,j=1/25.4;break;case"foot":e=O.FOOT_UNIT,j=1/304.8}}j*=F,ge=oi[e],Z="boolean"!=typeof L.displayUnit||L.displayUnit,H="number"==typeof L.offset&&!isNaN(L.offset)&&L.offset>=0?L.offset:0,X="number"==typeof L.worldOffset&&!isNaN(L.worldOffset)&&L.worldOffset>=0?L.worldOffset:0,Q="number"!=typeof L.startValue||isNaN(L.startValue)?void 0:L.startValue,ee="number"!=typeof L.endValue||isNaN(L.endValue)?void 0:L.endValue,void 0!==Q&&void 0!==ee&&ee<=Q&&(Q=void 0,ee=void 0),re="number"!=typeof L.originValue||isNaN(L.originValue)?0:L.originValue,void 0!==Q&&re<Q&&(re=Q),void 0!==ee&&re>ee&&(re=ee),te="number"==typeof L.mainGrad&&!isNaN(L.mainGrad)&&L.mainGrad>0?L.mainGrad:10,ie="number"==typeof L.nbSecondaryGrads&&!isNaN(L.nbSecondaryGrads)&&L.nbSecondaryGrads>=0?L.nbSecondaryGrads+1:10,Y="boolean"==typeof L.displayOrigin&&L.displayOrigin,q=L.originDisplay===O.ORIGIN_SYMMETRIC?L.originDisplay:O.ORIGIN_DEFAULT,z="boolean"!=typeof L.lockedOrigin||L.lockedOrigin,K="function"==typeof L.onOriginManipulator?L.onOriginManipulator:null,$="boolean"==typeof L.displayRulerDuringLocalTransfo&&L.displayRulerDuringLocalTransfo,J="boolean"==typeof L.lightDisplay&&L.lightDisplay,ae=L.graduationsDisplay===O.ORIENTED_GRADUATIONS?L.graduationsDisplay:O.DEFAULT_GRADUATIONS,ne=L.rulerDisplay===O.SYMMETRIC?L.rulerDisplay:O.DEFAULT,oe="boolean"!=typeof L.hideOnEmptySelection||L.hideOnEmptySelection,se=0,"number"==typeof L.nbDecimals&&(L.nbDecimals>=0&&L.nbDecimals<=9?se=L.nbDecimals:L.nbDecimals<0?se=0:L.nbDecimals>9&&(se=9)),Te=J?200:350;let t=ei.getContext("2d"),i=t.font.split(" "),a=J?"bold ":"900 ";if(t.font=a+Se+"pt "+i[i.length-1],pe=Z?Math.round(10*t.measureText(" "+ge).width)/10:0,ce=yi()){It=!1,Pt=!1,kt=!1,At=!1,Bt=!1,Lt=!1,Wt=!1,Ut=!1,He=te,ci("_updateGraduationColors"),255*new n.Color(Ye.backgroundColor).getHSL().l>120?(Ae="80,80,80",Oe="0,0,0"):(Ae="220,220,220",Oe="240,240,240"),pi("_updateGraduationColors"),W=Math.max(X/ce,0),W+=H;let e=Math.floor(1.2*gi()/He),i=He,a=e,r=gi()/(Te*ce),l=3*r,o=15*r,s=function(e,t){let n=Math.floor(1.2*gi()/e);return n<o&&n>a&&(a=n,i=e),n>=l&&n<=o?e:n<l&&n<t?e:n>o&&n>t?i:n<l?s(e/ie,n):n>o?s(e*ie,n):e};He=s(He,e),We=He,e=Math.floor(1.2*gi()/He);let u=Math.round(L.value)+Math.round(e/2)*He*j,h=Math.round(L.value)-Math.round(e/2)*He*j;Be=Math.abs(u-h),de=(new n.Vector3).copy(be);let p=new n.Vector3(1,0,0);if(he=(new n.Vector3).crossVectors(p,de).normalize(),(de.angleTo(p)<.001||0===he.x&&0===he.y&&0===he.z)&&(p=new n.Vector3(0,0,1),he=(new n.Vector3).crossVectors(p,de).normalize()),ue=(new n.Vector3).crossVectors(de,he),qe.getSightDirection().angleTo(ue)<Math.PI/4||qe.getSightDirection().angleTo(ue)>3*Math.PI/4){let e=(new n.Vector3).copy(ue);ue.copy(he).negate(),he.copy(e)}he.dot(qe.getSightDirection())>0&&(ue.multiplyScalar(-1),he.multiplyScalar(-1)),Fe=de.dot(qe.getUpDirection())<0,Ge=-1,ce<1&&(Ge=-ce);let g=Be.toExponential(),M=g.toString().indexOf("e"),f=parseFloat(g.toString().substring(M+1));Le=1;for(let e=1;e>f;e--)Le*=10;ye=!0,Le>Math.pow(10,se)?ye=!1:Le=Math.pow(10,se);let m,b,v=Math.abs(Math.round(L.value*j*Le)/Le).toString(),w=Math.abs(Math.round(h*Le)/Le).toString(),y=Math.abs(Math.round(u*Le)/Le).toString(),T=Math.abs(Math.round(He/ie*Le)/Le).toString(),C="";(se>0||-1!==T.indexOf(".")||-1!==w.indexOf(".")||-1!==y.indexOf(".")||-1!==v.indexOf("."))&&(C+="."),(h<0||Math.round(L.value*j*Le)/Le<0)&&(C+="-");let x=w.split("."),S=y.split("."),R=v.split("."),N=T.split(".");m=Math.max(x[0].length,S[0].length),m=Math.max(m,R[0].length),ye?b=se:(b=void 0!==x[1]?x[1].length:0,void 0!==S[1]&&(b=Math.max(b,S[1].length)),void 0!==R[1]&&(b=Math.max(b,R[1].length)),void 0!==N[1]&&(b=Math.max(b,N[1].length)));let V=m+b;for(let e=0;e<V;e++)C+="A";let I=Math.round(10*t.measureText(C).width)/10,P=Ce;if((Ce=xe+Ne+pe+I)!==P&&(mt.length=0),0===St){let e,t=null,i=null,a=null,n=function(){if(ut&&ut.children.length&&Ci(),null===a&&(a=Et),$){null===t&&null===i&&(t=ce,i=ce);let e=yi();if(!e||xi())ze.setVisibility(!1);else if(e!==i){let t=!1;Math.abs((e-i)/i)>.1&&(t=!0),!t&&Dt||(Xt=!0),ui(),t&&(i=ce)}else ze.setVisibility(!0)}else!0===L.getVisibleFlag()&&L.setVisibleFlag(!1),Dt||(e&&clearTimeout(e),e=setTimeout(function(){si()},200))};si=function(){if(Dt=!1,$)a&&ui();else if(a){L.setVisibleFlag(!0);let e=yi();!e||xi()?ze.setVisibility(!1):e!==t?ui():ze.setVisibility(!0),t=null}a=null},St=c.subscribe({event:"/VISU/"},function(t){"@onViewpointBeginMove"===t.eventType?(Dt=!0,e&&clearTimeout(e)):"@onViewpointChange"===t.eventType?n():"@onViewpointEndMove"===t.eventType&&si()}),bt=Ye.onBackgroundModify(function(){L.getVisibleFlag()&&ui()}),d.addEvent(Ye.canvas,"onPrimaryPointerClick",wi),d.addEvent(Ye.canvas,"onPrimaryPointerMoveUnique",wi)}Ht=!0}}pi("_initRulerParameters")}function Ri(e,t,i){let a=e;return ae===O.ORIENTED_GRADUATIONS&&a<0&&(a*=-1),i||(a*=j),t?a:Math.round(a*Le)/Le}function Ni(e,t,i){ci("_drawTextCanvas");let a=i||{},n=a.isCurrentValue||!1,r=a.onManipulatorPreactivated||!1,l=n&&It?1:2,o=Se*l*(n?1.1:1);t.height=2*o,t.width=(Ce-Ne)*l;let s,u=t.getContext("2d");u.globalAlpha=a.alpha,u.clearRect(0,0,t.width,t.height),!Fe||n&&It&&Yt&&qt?u.translate(10*l,t.height-10*l):(u.rotate(Math.PI),u.textAlign="right",u.translate(-10*l,-10*l)),s=n?kt||At?"rgba("+_e+",1)":Wt?"rgba("+ke+",1)":r?"rgba("+Ue+",1)":"rgba("+Oe+", 1)":"rgba("+Ae+",1)";let d=Ri(e);Z&&n&&(d=d+" "+ge);let h=u.font.split(" "),c=J?"bold ":"900 ";return u.font=c+o+"pt "+h[h.length-1],n&&(kt||Wt&&"220,220,220"===Ae&&!At)&&(u.shadowColor="white",u.shadowBlur=3*l),u.fillStyle=s,u.fillText(d,0,0),t.textDisplayed=d,pi("_drawTextCanvas"),t}function Vi(){let e=Ye.currentViewpoint.create3DRayFrom2DPoint(we),t=(new n.Vector3).copy(ue).multiplyScalar(W*ce),i=(new n.Vector3).copy(be).multiplyScalar(ve).add(t),a=(new n.Vector3).copy(me).add(i),r=(new n.Matrix4).multiplyMatrices(ze.getMatrix(),ct.getMatrix().rotateX(.5*Math.PI)).elements,l=new n.Vector3(r[8],r[9],r[10]),o=(new n.Plane).setFromNormalAndCoplanarPoint(l,a);return e.intersectPlane(o)}function Ii(){if(!z){let e=!0===Lt?k:Gt?A:U;it.setStyle("backgroundImage",'url("'+e+'")'),Lt||Gt||!me.equals(L.initOrigin)?it.setOpacity(1):it.setOpacity(.5),Ye.render()}Y&&function(){let e,t,i;if(!Y)return;J?(t=D,e=P,i=_):(t=ve>=re?R:I,e=ve>=re?x:N,i=ve>=re?S:V);let a=!0===Lt?i:Gt?t:e;et.getMaterial().map!==a&&(et.getMaterial().map=a),Ye.render()}()}function Pi(){let e,t,i;J?(t=D,e=P,i=_):(t=ve<re&&Y?T:Y?v:f,e=ve<re&&Y?y:Y?b:M,i=ve<re&&Y?C:Y?w:m);let a=!0===Bt?i:Ft?t:e;Ke.getMaterial().map!==a&&(Ke.getMaterial().map=a),Ye.render()}function Di(){if(It)return;let e=Math.round(ve*Le)/Le;ai.dispose(),ai.image=Ni(e,jt,{isCurrentValue:!0,onManipulatorPreactivated:!0,alpha:1}),ai.needsUpdate=!0,nt.setRatio(1.05),Ot=!0,Ye.setTemporaryCursor("pointer"),Ye.render()}function _i(){if(It)return void(Ot=!1);let e=Math.round(ve*Le)/Le;ai.dispose(),ai.image=Ni(e,jt,{isCurrentValue:!0,onManipulatorPreactivated:!1,alpha:1}),ai.needsUpdate=!0,nt.setRatio(1),Ot=!1,Ye.unsetTemporaryCursor(),Ye.render()}function Ei(e){ci("_entireManipulationMeasure"),Yt=e&&e.event&&e.event.from&&e.event.from.length&&"Touch"===e.event.from[0].type,pt=new n.Vector3(0,0,0),L.initValue=ve,It=!0,Ye.setTemporaryCursor("-webkit-grabbing",10),vi("RulerManipulateBegin",{eventName:"RulerManipulateBegin",value:ve,direction:be,event:e.event})}function Ui(e){!z&&le&&(ze.removeChild(le),le=null),ci("_manipulateCB");let t=L.getSnappedTranslationVector(e),i=t.snappedTranslationVector;if(0!==t.returnCode||(kt||At)&&i.x===e.translationVector.x&&i.y===e.translationVector.y&&i.z===e.translationVector.z)return;let a=(new n.Vector3).copy(i).sub(pt),r=a.dot(be),l=a.length();r<0&&(l*=-1);let o=ve;L.setValue(ve+l),ve!==o+l&&a.setLength(ve-o),pt.add(a),a.length()&&(Ye.render(),vi("RulerManipulate",{eventName:"RulerManipulate",translationVector:a,value:ve,direction:be,rulerDragged:!0,event:e.event})),pi("_manipulateCB")}function ki(e,t){kt=!1,At=!1,It=!1,Yt=!1,Ye.unsetTemporaryCursor(),Ye.render(),t||!1||ui(),vi("RulerManipulateEnd",{eventName:"RulerManipulateEnd",value:ve,direction:be,status:"Validated",event:e.event}),pi("_entireManipulationMeasure")}function Ai(e){ci("_entireOriginManipulationMeasure"),Yt=e&&e.event&&e.event.from&&e.event.from.length&&"Touch"===e.event.from[0].type,gt=new n.Vector3(0,0,0),It=!0,Pt=!0,Lt=!0,ze.setPickable(h.PICKTHROUGH),lt.setPickable(h.PICKTHROUGH),tt.setPickable(h.PICKTHROUGH),zt=new n.Line3(me,(new n.Vector3).copy(me).add(be)),Ye.setTemporaryCursor("-webkit-grabbing",10),vi("OriginManipulateBegin",{eventName:"OriginManipulateBegin",origin:me,value:ve,direction:be,event:e.event})}function Oi(e){let t=null;if(!z&&le&&(ze.removeChild(le),le=null),K){let i=null,a=K(e);if(function(){if(ci("refreshOrigin"),L.displayOrigin!==Y){Y=L.displayOrigin;for(let e=0;e<ft.length;e++)ft[e].manipulator&&0!==ft[e].token&&ft[e].manipulator.unlink(ft[e].token),bi(ft[e].manipNode,!1),ft[e].texture.dispose();ft.splice(0,ft.length),bi(ze,!1),Ye.removeNode(ze),hi(),L.setValue(L.value)}pi("refreshOrigin")}(),a){t=(i=zt.closestPointToPoint(a,!1)).sub(me),gt=new n.Vector3,L.origin3DPos=(new n.Vector3).copy(a);let e=(new n.Vector3).copy(Vi()),r=(new n.Matrix4).getInverse(lt.getParents()[0].getMatrixWorld()).multiply((new n.Matrix4).setPosition(e));lt.setMatrix(r)}}if(t){let i=(new n.Vector3).copy(t).sub(gt),a=i.length();if(0!==a){me.add(i),L.origin=(new n.Vector3).copy(me),i.dot(be)>0&&(a*=-1),L.setValue(ve+a),gt.add(i),vi("OriginManipulate",{eventName:"OriginManipulate",origin:me,translationVector:i,value:ve,direction:be,rulerDragged:!0,event:e.event})}Ye.render(),pi("_manipulateOriginCB")}}function Gi(e){kt=!1,At=!1,It=!1,Lt=!1,Yt=!1,zt=null,ze.setPickable(h.PICKABLE),lt.setPickable(h.PICKABLE),tt.setPickable(h.PICKABLE),Ye.unsetTemporaryCursor(),Ye.render(),ui(),Pt=!1,vi("OriginManipulateEnd",{eventName:"OriginManipulateEnd",value:me,direction:be,status:"Validated",event:e.event}),pi("_entireOriginManipulationMeasure")}function Bi(){Gt=!0,Ye.setTemporaryCursor("pointer"),Ii()}function Li(){Gt=!1,It||(Ye.unsetTemporaryCursor(),Ii())}function Fi(e){let t=(new n.Vector3).copy(ue).multiplyScalar(W*ce),i=(new n.Vector3).copy(me).add(t);e.event.from[0].currentPosition.x&&(we.x=e.event.from[0].currentPosition.x),e.event.from[0].currentPosition.y&&(we.y=e.event.from[0].currentPosition.y);let a=(new n.Vector3).copy(Vi()).sub(i),r=ve,l=a.dot(de);if(Y){let e=(Ve/2+2*Re)*ce;l>=0?l-=e/2:l+=e/2}let o=Y?(Ve/2+2*Re)*ce:(Ve+2*Re)*ce;if(Math.abs(r-l)>=o){let t=We/ie;l=Math.round(l/t)*t,L.setValue(l),Ei(e),vi("RulerManipulate",{eventName:"RulerManipulate",translationVector:(new n.Vector3).copy(be).setLength(ve-r),value:ve,direction:be,rulerDragged:!1,event:e.event})}else Ei(e);Bt=!0}function Wi(e){if(It)return void(Ot=!1);Ot=!0;let t=(new n.Vector3).copy(ue).multiplyScalar(W*ce),i=(new n.Vector3).copy(me).add(t);e.event.from[0].currentPosition.x&&(we.x=e.event.from[0].currentPosition.x),e.event.from[0].currentPosition.y&&(we.y=e.event.from[0].currentPosition.y);let a=(new n.Vector3).copy(Vi()).sub(i),r=ve,l=a.dot(de);if(Y){let e=(Ve/2+2*Re)*ce;l>=0?l-=e/2:l+=e/2}let o=Y?(Ve/2+2*Re)*ce:(Ve+2*Re)*ce;Ft=Math.abs(r-l)<o,Ye.setTemporaryCursor("pointer"),Pi()}function Hi(){Ot=!1,Ft=!1,It||(Ye.unsetTemporaryCursor(),Pi())}function Xi(e){let t=ve;It=!0,L.setValue(e.value),It=!1;let i=(new n.Vector3).copy(be).multiplyScalar(ve-t);Ot=!1,Gt=!1,Ye.render(),vi("RulerManipulateBegin",{eventName:"RulerManipulateBegin",value:ve,direction:be,event:e.event}),vi("RulerManipulate",{eventName:"RulerManipulate",translationVector:i,value:ve,direction:be,rulerDragged:!1,event:e.event}),vi("RulerManipulateEnd",{eventName:"RulerManipulateEnd",value:ve,direction:be,status:"Validated",event:e.event})}function Yi(e){if(It)return void(Ot=!1);Ot=!0;let t=e.node;t&&(t.setRatio(1.05),Ye.setTemporaryCursor("pointer"),Ye.render())}function qi(e){if(It)return;Ot=!1;let t=e.node;t&&(t.setRatio(1),Ye.unsetTemporaryCursor(),Ye.render())}function zi(e,t,i){ci("_createGraduationNode");let a,s=null,d=null,h=i.alpha,c=i.color,p=!1,g=Ri(e,!1,!0);for(a=0;a<ft.length;a++)if(!1===ft[a].toDispose&&ft[a].associatedValue===e&&ft[a].associatedAlpha===h){d=ft[a],p=!0;break}let M=t;if(!d){for(a=0;a<ft.length;a++)if(!0===ft[a].toDispose){(d=ft[a]).manipulator.associatedValue=e,d.texture.dispose();break}if(!d){d={};let t=r.createRectangleNode({width:Ce-Ne,height:2*Se,fill:!0,noEdge:!0});Mi(t);let i=new u({ratio:1});i.name="textNode",i.addChild(t),d.texture=new n.Texture;let a=new n.MeshBasicMaterial({map:d.texture,transparent:!0,enableClipPlanes:!1});if(a.force=!0,a.depthTest=!1,i.setMaterial(a),!M){let e=i.getBoundingBox();M=Math.abs(e.max.y-e.max.x)}i.setMatrix((new n.Matrix4).makeTranslation(0,M/2-ce*Se,0));let s=r.createRectangleNode({width:(Ce-Ne)*ce,height:M,fill:!0,noEdge:!0});Mi(s),(a=new n.MeshBasicMaterial({map:ri,transparent:!0,enableClipPlanes:!1})).force=!0,a.depthTest=!1,s.setMaterial(a);let h=new o({viewer:Ye,value:e,linkedNode:i});d.manipulator=h,h.subscribe("Click",Xi),h.subscribe("BeginManipulate",null),h.subscribe("Manipulate",null),h.subscribe("EndManipulate",null),h.subscribe("BeginPreactivate",Yi),h.subscribe("EndPreactivate",qi),d.manipNode=new l,d.manipNode.addChild(s),d.manipNode.addChild(i),d.token=h.linkToNode(d.manipNode),ft.push(d)}d.associatedValue=e,d.associatedAlpha=h,d.ratio=ce}if(!p){for(a=0;a<mt.length;a++)if(!1===mt[a].toDispose&&mt[a].associatedValue===g&&mt[a].associatedAlpha===h&&mt[a].associatedColor===c&&mt[a].reverse===Fe){s=mt[a];break}if(!s){if(mt.length===Mt){for(a=0;a<mt.length;a++)if(!0===mt[a].toDispose){s=mt[a];break}}else s={canvas:document.createElement("canvas")},mt.push(s);s.canvas=Ni(e,s.canvas,i),s.associatedValue=g,s.associatedAlpha=h,s.associatedColor=c,s.reverse=Fe}d.texture.image=s.canvas,d.texture.needsUpdate=!0,s.toDispose=!1}if(!M){let e=d.manipNode.getChildByName("textNode").getBoundingBox();M=Math.abs(e.max.y-e.max.x)}d.toDispose=!1;let f=ve-.5*Te*ce,m=(new n.Matrix4).makeTranslation((Ne+Ie+xe)*ce,Ge,e-f-M/2);d.manipNode.setMatrix(m.rotateX(.5*Math.PI)),je.addChild(d.manipNode),pi("_createGraduationNode")}function Ki(e){if(It=!1,!ut.children.length){let i=Ri(ve,!0),r=Le;r<1?r/=se>0?10:1e3:r*=se>0?10:1e3;let l=new a({value:Math.round(i*r)/r,okCB:Ti,cancelCB:Ci,startValue:Q*j,endValue:ee*j,frmWindow:t});new o({viewer:Ye}).linkToNode(l),ut.addChild(l),e.event.from[0].currentPosition.x&&(we.x=e.event.from[0].currentPosition.x),e.event.from[0].currentPosition.y&&(we.y=e.event.from[0].currentPosition.y);let s=Vi(),u=(new n.Matrix4).makeTranslation(s.x,s.y,s.z),d=(new n.Matrix4).getInverse(ze.getMatrix());ut.setMatrix(d.multiply(u));let h=-30,c=-30,p=155,g=30;(s=e.event.from[0].currentPosition).x+h<0?h=-1*s.x+15:s.x+h+p>Ye.SCREEN_WIDTH&&Ye.SCREEN_WIDTH>p&&(h=h+-1*(s.x+h+p-Ye.SCREEN_WIDTH)-15),s.y+c<0?c=-1*s.y+15:s.y+c+g>Ye.SCREEN_HEIGHT&&Ye.SCREEN_HEIGHT>g&&(c=c+-1*(s.y+c+g-Ye.SCREEN_HEIGHT)-15),l.setOffset(new n.Vector2(h,c)),Je.setVisibility(!1),Vt=!0,Ye.render()}}function Zi(e){ct.removeChild(fe),Mi(fe=r.createRectangleNode({width:(Ne+xe)*ce,height:gi(),fill:!0,noEdge:!0})),fe.setRenderDepth(-1);let t=new n.MeshBasicMaterial({map:ii,transparent:!0,enableClipPlanes:!1});t.force=!0,t.depthTest=!1,fe.setMaterial(t),fe.setMatrix((new n.Matrix4).makeTranslation(0,-1.9*Ge,e).rotateX(.5*Math.PI)),ct.addChild(fe)}function ji(e){Me&&ct.removeChild(Me),Mi(Me=r.createRectangleNode({width:Ce*ce,height:gi(),fill:!0,noEdge:!0})),Me.setRenderDepth(-1);let t=new n.MeshBasicMaterial({map:ni,transparent:!0,enableClipPlanes:!1});t.force=!0,t.depthTest=!1,Me.setMaterial(t),Me.setMatrix((new n.Matrix4).makeTranslation(0,-2*Ge,e).rotateX(.5*Math.PI)),ct.addChild(Me)}function Ji(){if(ci("_internalRefresh"),Ht){if(L.value!==ve){ve=L.value;let e=0;ne===O.SYMMETRIC&&(re?ve>re&&(e=2*(re-ve)):ve>0&&(e=-2*ve));let t=(new n.Vector3).copy(ue).multiplyScalar(W*ce),i=(new n.Vector3).copy(be).multiplyScalar(ve-.5*Te*ce).add(t),a=(new n.Vector3).copy(me).add(i);if(ze.setMatrix(ze.getMatrix().setPosition(a)),W<1.5*Ye.SCREEN_WIDTH||W<1.5*Ye.SCREEN_HEIGHT){ut.removeChildren(),je.removeChildren();let t=null;if((Xt||ne===O.SYMMETRIC)&&(ni.dispose(),ni.image=function(){ci("_generateMainCanvas");let e=Math.round(ve*Le)/Le,t=Zt;t.width=Ce,t.height=gi()/ce;let i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);let a,n,r,l=.7,o=re||0,s=(ne===O.SYMMETRIC?o:e)-.5*t.height*ce,u=(ne===O.SYMMETRIC?o:e)+.5*t.height*ce;if(J)a=Ae,l=.5,(n=i.createLinearGradient(0,0,0,t.height)).addColorStop(0,"rgba("+a+",0)"),n.addColorStop(.15,"rgba("+a+","+l+")"),n.addColorStop(.85,"rgba("+a+","+l+")"),n.addColorStop(1,"rgba("+a+",0)"),i.fillStyle=n,mi(i,0,0,Re,t.height),l=.7,At&&(Y||(e>o?s>o?((r=i.createLinearGradient(xe,.5*t.height,xe,t.height)).addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,mi(i,0,.5*t.height,Re,.5*t.height)):((r=i.createLinearGradient(xe,.5*t.height,xe,t.height-Math.abs(s)/ce)).addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,mi(i,0,.5*t.height,Re,.5*t.height-Math.abs(s)/ce)):e<o&&(u<0?((r=i.createLinearGradient(xe,0,xe,.5*t.height)).addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,mi(i,0,0,Re,.5*t.height)):((r=i.createLinearGradient(xe,u/ce,xe,.5*t.height)).addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,mi(i,0,u/ce,Re,.5*t.height-u/ce)))));else{a="255, 255, 255",(n=i.createLinearGradient(0,0,0,t.height)).addColorStop(0,"rgba("+a+",0)"),n.addColorStop(.2,"rgba("+a+",0.4)"),n.addColorStop(.8,"rgba("+a+",0.4)"),n.addColorStop(1,"rgba("+a+",0)"),i.fillStyle=n,mi(i,xe-2*Re,0,Ne+4*Re,t.height),(n=i.createLinearGradient(0,0,0,t.height)).addColorStop(0,"rgba("+a+",0)"),n.addColorStop(.15,"rgba("+a+",0.8)"),n.addColorStop(.85,"rgba("+a+",0.8)"),n.addColorStop(1,"rgba("+a+",0)"),i.fillStyle=n,mi(i,xe-2*Re,0,3*Re,t.height),mi(i,xe+Ne,0,3*Re,t.height);let d=.05*t.height;!Y&&At?e>o?ne===O.SYMMETRIC?((r=i.createLinearGradient(xe,.5*t.height-Math.abs(e-o)/ce,xe,.5*t.height)).addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,mi(i,xe,.5*t.height-Math.abs(e-o)/ce,Ne,Math.abs(e-o)/ce)):s>o?((r=i.createLinearGradient(xe,.5*t.height,xe,t.height)).addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,mi(i,xe,.5*t.height,Ne,.5*t.height)):((r=i.createLinearGradient(xe,.5*t.height,xe,t.height-Math.abs(o-s)/ce)).addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,mi(i,xe,.5*t.height,Ne,.5*t.height-Math.abs(o-s)/ce)):e<o?ne===O.SYMMETRIC?((r=i.createLinearGradient(xe,.5*t.height+Math.abs(o-e)/ce,xe,.5*t.height)).addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,mi(i,xe,.5*t.height,Ne,Math.abs(o-e)/ce)):u<o?((r=i.createLinearGradient(xe,0,xe,.5*t.height)).addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,mi(i,xe,0,Ne,.5*t.height)):((r=i.createLinearGradient(xe,Math.abs(u-o)/ce,xe,.5*t.height)).addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,mi(i,xe,Math.abs(u-o)/ce,Ne,.5*t.height-Math.abs(u-o)/ce)):((r=i.createLinearGradient(xe,.5*t.height,xe,.5*t.height+d)).addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,mi(i,xe,.5*t.height,Ne,d),(r=i.createLinearGradient(xe,.5*t.height-d,xe,.5*t.height)).addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,mi(i,xe,.5*t.height-d,Ne,d)):!Y&&kt&&(e>o?ne===O.SYMMETRIC?((r=i.createLinearGradient(xe,.5*t.height-Math.abs(e-o)/ce,xe,.5*t.height)).addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,mi(i,xe,.5*t.height-Math.abs(e-o)/ce,t.width-xe,Math.abs(e-o)/ce)):s>o?((r=i.createLinearGradient(xe,.5*t.height,xe,t.height)).addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,mi(i,xe,.5*t.height,t.width-xe,.5*t.height)):((r=i.createLinearGradient(xe,.5*t.height,xe,t.height-Math.abs(o-s)/ce)).addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,mi(i,xe,.5*t.height,t.width-xe,.5*t.height-Math.abs(o-s)/ce)):e<o?ne===O.SYMMETRIC?((r=i.createLinearGradient(xe,.5*t.height+Math.abs(o-e)/ce,xe,.5*t.height)).addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,mi(i,xe,.5*t.height,t.width-xe,Math.abs(o-e)/ce)):u<o?((r=i.createLinearGradient(xe,0,xe,.5*t.height)).addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,mi(i,xe,0,t.width-xe,.5*t.height)):((r=i.createLinearGradient(xe,Math.abs(u-o)/ce,xe,.5*t.height)).addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,mi(i,xe,Math.abs(u-o)/ce,t.width-xe,.5*t.height-Math.abs(u-o)/ce)):((r=i.createLinearGradient(xe,.5*t.height,xe,.5*t.height+d)).addColorStop(0,"rgba("+_e+","+l+")"),r.addColorStop(1,"rgba("+_e+",0)"),i.fillStyle=r,mi(i,xe,.5*t.height,t.width-xe,d),(r=i.createLinearGradient(xe,.5*t.height-d,xe,.5*t.height)).addColorStop(0,"rgba("+_e+",0)"),r.addColorStop(1,"rgba("+_e+","+l+")"),i.fillStyle=r,mi(i,xe,.5*t.height-d,t.width-xe,d)))}return pi("_generateMainCanvas"),t}(),ni.needsUpdate=!0,ne===O.SYMMETRIC&&ji(e)),Xt=!1,J||(ii.dispose(),ii.image=function(){ci("_generateGraduations");let e=It||Dt?1:2,t=Kt;t.width=Math.round(e*(Ne+xe));let i=gi()/ce;t.height=Math.round(e*i);let a=t.getContext("2d");a.clearRect(0,0,t.width,t.height);let n=ce/e,r=Math.floor(t.height*n*1.2/He);r++;let l=ne===O.SYMMETRIC?null:r>=7?Math.floor(r/2)-1:r-1,o=gi()/(Te*ce),s=ve;ne===O.SYMMETRIC&&(s=re||0);let u=s-.5*t.height*n,d=ne===O.SYMMETRIC?t.height-(ve-u)/n:.5*t.height,h=He;r>=7*o&&(h=2*He),h*=Le,u=(Math.floor(u/He)*He).valueOf(),a.textBaseline="middle";let c,p,g,M,f,m,b=2*Ve*e,v=1,w=1,y=!1,T=[],C=[],x=[];for(p=0;p<=r;p++)if((f=.5*t.height+(s-p*He-u)/n)>0&&f<t.height){v=f<b?f/b:f>t.height-b?(t.height-f)/b:1,y=!1,Math.abs(f-d)<b?(w=Math.max(Math.abs(f-d)/b*2-1,0),y=!0):(w=v,y=!1);let i=Math.round((p*He+u)*Le)/Le,a=i*Le%h==0;a&&(((c=Math.round(10*Math.max(w-.2,0))/10)<.1||y&&!Ut&&c<.8)&&(c=0),0!==c&&(c=fi(c+.1),(void 0!==Q&&i<Q||void 0!==ee&&i>ee)&&(c=0),0!==c&&T.push({val:i,alpha:c,nearCurrentValue:y}))),void 0!==Q&&i<Q||void 0!==ee&&i>ee||0!=(c=Math.round(10*Math.max(w-.2,0))/10)&&0!==(c=fi(c+.1))&&((m={moveTo:{x:Math.round(e*xe),y:Math.round(f)},alpha:c,lineWidth:Re*e*2}).lineTo=a?{x:Math.round(e*(Ne+xe)),y:Math.round(f)}:{x:Math.round(e*(xe+.75*Ne)),y:Math.round(f)},C.push(m),-1===x.indexOf(c)&&x.push(c))}for(p=0;p<=r;p++)for(g=1;g<ie;g++){let i=Math.round(((p-g*(1/ie))*He+u)*Le)/Le;if(!(void 0!==Q&&i<Q||void 0!==ee&&i>ee)){v=(f=.5*t.height+(s-(p-g*(1/ie))*He-u)/n)<b?f/b:f>t.height-b?(t.height-f)/b:1;let i=Math.abs(f-d)<b?Math.max(Math.abs(f-d)/b*2-1,0):v;0!==(i=fi(i))&&((m={moveTo:{x:Math.round(e*xe),y:Math.round(f)},alpha:i,lineWidth:Re*e}).lineTo={x:Math.round(e*(De+xe)),y:Math.round(f)},C.push(m),-1===x.indexOf(i)&&x.push(i))}}let S=[Re*e*2,Re*e];for(M=0;M<S.length;M++)for(p=0;p<x.length;p++){for(a.beginPath(),a.lineWidth=S[M],a.strokeStyle=0===M&&kt||1===M&&At?"rgba("+_e+","+x[p]+")":"rgba(0,0,0,"+x[p]+")",g=0;g<C.length;g++)C[g].alpha===x[p]&&C[g].lineWidth===S[M]&&(a.moveTo(C[g].moveTo.x,C[g].moveTo.y),a.lineTo(C[g].lineTo.x,C[g].lineTo.y));R=a,ci("_stroke"),R.stroke(),pi("_stroke")}var R;if(!Dt&&q!==O.ORIGIN_SYMMETRIC){for(p=0;p<ft.length;p++)ft[p].toDispose=!0;for(p=0;p<mt.length;p++)mt[p].toDispose=!0;for(p=0;p<T.length;p++){let e=Ri(T[p].val);for(g=0;g<ft.length;g++)ft[g].associatedValue===T[p].val&&ft[g].associatedAlpha===T[p].alpha&&Math.abs(ft[g].ratio-ce)/ft[g].ratio<.2&&(ft[g].toDispose=!1);for(g=0;g<mt.length;g++)mt[g].associatedValue===e&&mt[g].associatedAlpha===T[p].alpha&&mt[g].associatedColor===Ae&&mt[g].reverse===Fe&&(mt[g].toDispose=!1)}for(p=0;p<T.length;p++)zi(T[p].val,l?Te*ce/l:null,{alpha:T[p].alpha,reverse:Fe,nearCurrentValue:T[p].nearCurrentValue,color:Ae})}return pi("_generateGraduations"),t}(),ii.needsUpdate=!0,ne===O.SYMMETRIC&&Zi(e)),!Dt){ai.dispose(),ai.image=Ni(ve,jt,{isCurrentValue:!0,onManipulatorPreactivated:!1,alpha:1}),ai.needsUpdate=!0;let e=ve-.5*Te*ce,i=1.2*Se*2,a=J?Ie*ce:(Ne+Ie+xe)*ce;t=(new n.Matrix4).makeTranslation(a,0,ve-e-ce*i/2),Je.setMatrix(t.rotateX(.5*Math.PI)),Tt.magnitude=Be/j,ot&&(ot.magnitude=Be/j)}let i,a,l=0;l=J?Pe*ce:Y?(Ve/2+2*Re)*ce:(Ve+Re)*ce,J?(i=P,a=_):(i=ve<re&&Y?y:Y?b:M,a=ve<re&&Y?C:Y?w:m);let o=!0===Bt?a:i;Ke.getMaterial().map!==o&&(Ke.getMaterial().map=o),t=new n.Matrix4,J?(t.makeTranslation(0,0,Te/2*ce),$e.setMatrix(t.rotateX(.5*Math.PI))):(Y?ve>=re?t.makeTranslation(0,-1.5*Ge,Te/2*ce):t.makeTranslation(0,-1.5*Ge,Te/2*ce-l):t.makeTranslation(0,-1.5*Ge,Te/2*ce-l/2),$e.setMatrix(t.rotateX(.5*Math.PI))),xt.magnitude=Be/j,Ct.magnitude=Be/j;let s=Te*ce;if((At||kt)&&(s=20*Te*ce),t=J?(new n.Matrix4).makeTranslation(-Ne/4*ce,0,e+(Te*ce-s)/2):(new n.Matrix4).makeTranslation(xe*ce,-Ge,e+(Te*ce-s)/2),at.setMatrix(t.rotateX(.5*Math.PI).multiply((new n.Matrix4).makeScale(1,gi()/at.originalLength,1))),Y||!z){Qe.removeChildren();let e,i,a=null;i=J?2*Re*ce:kt?Ce*ce:Ne*ce,(e=ve!==re?(q===O.ORIGIN_SYMMETRIC?2*Math.abs(ve-re):Math.abs(ve-re))+ce:.1*Te*ce)>0&&(Mi(a=r.createRectangleNode({width:i,height:e,fill:!0,noEdge:!0})),a.setRenderDepth(0),Qe.addChild(a),li.dispose(),li.image=function(){ci("_generateOriginTexture");let e=Ee;(kt||At)&&(e=_e);let t=$t.getContext("2d");t.clearRect(0,0,$t.width,$t.height),$t.width=J?3*Re:kt?Ne:Ce-xe;let i,a=Math.round(ve*Le)/Le;return a!==re?($t.height=(a-re)/ce,i=t.createLinearGradient(0,0,0,$t.height),a>re?(i.addColorStop(0,"rgba("+e+",0.7)"),i.addColorStop(1,"rgba("+e+",0)")):(i.addColorStop(0,"rgba("+e+",0)"),i.addColorStop(1,"rgba("+e+",0.7)")),t.fillStyle=i,mi(t,0,0,$t.width,$t.height)):J||($t.height=.1*Te,(i=t.createLinearGradient(0,0,0,$t.height)).addColorStop(0,"rgba("+e+",0)"),i.addColorStop(.5,"rgba("+e+",0.7)"),i.addColorStop(1,"rgba("+e+",0)"),t.fillStyle=i,mi(t,0,0,$t.width,$t.height)),pi("_generateOriginTexture"),$t}(),li.needsUpdate=!0),t=new n.Matrix4;let o=(q===O.ORIGIN_SYMMETRIC?2*ve:ve)-.5*Te*ce,s=q===O.ORIGIN_SYMMETRIC?2*re:re;ve<re?t.makeTranslation(J?-Re*ce:xe*ce,0,.5*Te*ce):ve>re?t.makeTranslation(J?-Re*ce:xe*ce,0,-o+s):t.makeTranslation(J?-Re*ce:xe*ce,0,.45*Te*ce),Qe.setMatrix(t.rotateX(.5*Math.PI));let u=!0;if(q!==O.ORIGIN_SYMMETRIC)for(let e=0;e<ft.length;e++)ft[e].associatedValue===re&&(u=!1);if(J)o=(q===O.ORIGIN_SYMMETRIC?2*ve:ve)-Te/2*ce,t=(new n.Matrix4).makeTranslation(0,0,-o+s);else{if(o=(q===O.ORIGIN_SYMMETRIC?2*ve:ve)-.5*Te*ce,q===O.ORIGIN_SYMMETRIC||u&&!(ve+.15*Be>re&&ve-.15*Be<re)){let e=Math.floor(Te*ce*1.2/He),i=e>=7?Math.floor(e/2):e,a=Te*ce/i;t=(new n.Matrix4).makeTranslation((Ne+Ie+xe)*ce,Ge,-o-a/2+s),ht.setMatrix(t.rotateX(.5*Math.PI)),ht.setVisibility(!0)}else ht.setVisibility(!1);Ii(),t=(new n.Matrix4).makeTranslation(0,0,ve>=re?-o-l+ce+s:-o+s)}if(Y&&rt.setMatrix(t.rotateX(.5*Math.PI)),!z)if(L.displayOrigin&&L.origin3DPos){let e=(new n.Matrix4).getInverse(lt.getParents()[0].getMatrixWorld()).multiply((new n.Matrix4).setPosition(L.origin3DPos));lt.setMatrix(e)}else lt.setMatrix((new n.Matrix4).setPosition(new n.Vector3(0,Te/2*ce,0)))}if(It&&Yt&&qt){if(Je.setVisibility(!1),!dt.children.length&&ai){let e=new p({html:ai.image});dt.setMatrix((new n.Matrix4).makeTranslation(0,0,Te/2*ce)),dt.addChild(e)}let e=-ai.image.getContext("2d").measureText(ai.image.textDisplayed).width/2;e+=J?-(Ne/4+2*Re):Ne/2+xe/2-4*Re,dt.children[0].setOffset(new n.Vector2(e,-85))}else Je.setVisibility(!0),dt.removeChildren();Ut=!0,Ot=!1,Gt=!1}if(W>0&&Y&&(Ze.setMatrix((new n.Matrix4).makeTranslation(0,Te/2*ce-ve+re,0)),function(){if(!z&&!Pt&&L.origin3DPos&&!L.origin.equals(L.initOrigin)){le&&ze.removeChild(le);let e=(new n.Matrix4).getInverse(ze.getMatrixWorld()),t=ve?Te/2*ce-ve+re:0,i=e.multiply((new n.Matrix4).setPosition(L.origin3DPos)),a=new n.Vector3(-ce*W,t,0),l=(new n.Vector3).getPositionFromMatrix(i);Mi(le=r.createLineNode({points:[a,l]}));let o=new n.LineBasicMaterial({color:"80,80,80"===Ae?0:16777215,opacity:.5,dashPattern:[3,2],scale:3});o.force=!0,o.depthTest=!1,le.setMaterial(o),ze.addChild(le);let s=r.createSphereNode({matrix:(new n.Matrix4).setPosition(l),radius:.3,fill:!0});Mi(s),le.addChild(s)}}(),L.origin3DPos)){let e=(new n.Matrix4).getInverse(lt.getParents()[0].getMatrixWorld()).multiply((new n.Matrix4).setPosition(L.origin3DPos));lt.setMatrix(e)}Ye.render()}pi("_internalRefresh")}else ui()}oi[O.NM_UNIT]=g.nmLbl,oi[O.MICRON_UNIT]=g.micronLbl,oi[O.MM_UNIT]=g.mmLbl,oi[O.CM_UNIT]=g.cmLbl,oi[O.M_UNIT]=g.mLbl,oi[O.HM_UNIT]=g.hmLbl,oi[O.KM_UNIT]=g.kmLbl,oi[O.INCH_UNIT]=g.inLbl,oi[O.FOOT_UNIT]=g.ftbl,oi[O.YARD_UNIT]=g.yardLbl,oi[O.MILE_UNIT]=g.mileLbl,oi[O.NMILE_UNIT]=g.nmiLbl,di=function(){if(ci("_internalClear"),Ht){for(let e=0;e<ft.length;e++)ft[e].manipulator&&0!==ft[e].token&&ft[e].manipulator.unlink(ft[e].token),bi(ft[e].manipNode,!1),ft[e].texture.dispose();ft.splice(0,ft.length),0!==Rt&&Nt.unlink(Rt),0!==st&&ot.unlink(st),0!==vt&&Tt.unlink(vt),0!==yt&&Ct.unlink(yt),0!==wt&&xt.unlink(wt),wt=0,vt=0,yt=0,Rt=0,st=0,Nt=null,ot=null,it&&it.destroy(),it=null,Tt=null,Ct=null,xt=null,bi(ze,!1),Ye.removeNode(ze),0===St||Dt||(c.unsubscribe(St),Ye.unsubscribe(bt),d.removeEvent(Ye.canvas,"onPrimaryPointerClick",wi),d.removeEvent(Ye.canvas,"onPrimaryPointerMoveUnique",wi),St=0),Ht=!1,ve=null}pi("_internalClear")},ui=function(){ci("_internalDisplay"),di(),Si(),hi(),L.setValue(L.value),pi("_internalDisplay")},hi=function(){let t,i,a,l;if(ci("_internalBuild"),!Ht)return;let d,c,g=gi();if(W<1.5*Ye.SCREEN_WIDTH||W<1.5*Ye.SCREEN_HEIGHT){if(ne!==O.SYMMETRIC&&(ji(0),(!Dt&&0===X||0!==X)&&(Xt=!0),J||Zi(0)),!Dt){Mi(t=r.createRectangleNode({width:Ce-Ne,height:2.4*Se,fill:!0,noEdge:!0})),(nt=new u({ratio:1})).addChild(t),nt.setVisibility(!0),(l=new n.MeshBasicMaterial({map:ai,transparent:!0,enableClipPlanes:!1})).force=!0,nt.setMaterial(l),nt.setMatrix((new n.Matrix4).makeTranslation(0,0,-2*Ge)),Je.addChild(nt),i=(Ce-Ne)*ce,a=Te*ce/10;let e=r.createRectangleNode({width:i,height:a,fill:!0,noEdge:!0});if(Mi(e),(l=new n.MeshBasicMaterial({map:ri,transparent:!0,enableClipPlanes:!1})).force=!0,l.depthTest=!1,e.setMaterial(l),e.setMatrix((new n.Matrix4).makeTranslation(0,0,-2*Ge)),Je.addChild(e),!J){a=.5*ce*Te;let e=r.createRectangleNode({width:i,height:a,fill:!0,noEdge:!0});Mi(e),(l=new n.MeshBasicMaterial({map:ri,transparent:!0,enableClipPlanes:!1})).force=!0,l.depthTest=!1,e.setMaterial(l),e.setMatrix((new n.Matrix4).makeTranslation(0,-a/2+Se*ce*1.2,0)),Je.addChild(e)}if(0===vt){(Tt=new o({viewer:Ye,axis:(new n.Vector3).copy(be)})).subscribe("Click",Ki),Tt.subscribe("BeginManipulate",function(e){Bt=!1,Lt=!1,Wt=!0,Ei(e)});let e=!0;Tt.subscribe("Manipulate",function(t){e=!1,Ui(t)}),Tt.subscribe("EndManipulate",function(t){Bt=!1,Lt=!1,Wt=!1,ki(t,e)}),Tt.subscribe("BeginPreactivate",Di),Tt.subscribe("EndPreactivate",_i),vt=Tt.linkToNode(Je)}}let d,c,f,m=J?Ne/2*ce:Ne*ce,v=g;if((At||kt)&&(v=20*g),(at=r.createRectangleNode({width:m,height:v,fill:!0,noEdge:!0})).originalLength=g,Mi(at),(l=new n.MeshBasicMaterial({map:ri,transparent:!0,enableClipPlanes:!1})).force=!0,l.depthTest=!1,at.setMaterial(l),ct.addChild(at),0===yt&&((Ct=new o({viewer:Ye,axis:(new n.Vector3).copy(be)})).subscribe("BeginManipulate",Fi),Ct.subscribe("Manipulate",Ui),Ct.subscribe("EndManipulate",function(e){Bt=!1,Lt=!1,ki(e)}),Ct.subscribe("Click",function(e){Bt=!1,Lt=!1,ki(e)}),Ct.subscribe("Preactivate",Wi),Ct.subscribe("EndPreactivate",Hi),yt=Ct.linkToNode(at)),!z){let t=new n.Vector2(-10.8,-36);(it=e.createElement("div",{class:"originPinMainDiv"})).setStyle("width",21.6),it.setStyle("height",36),it.setStyle("backgroundImage",'url("'+U+'")'),(tt=new p({html:it})).height=36,tt.width=21.6,Pt&&tt.setPickable(h.PICKTHROUGH),tt.setOffset(t),(ot=new o({viewer:Ye,axis:(new n.Vector3).copy(be),linkedNode:tt})).subscribe("BeginManipulate",Ai),ot.subscribe("Manipulate",Oi),ot.subscribe("EndManipulate",Gi),ot.subscribe("BeginPreactivate",Bi),ot.subscribe("EndPreactivate",Li),st=ot.linkToNode(tt)}if(Y&&((l=new n.MeshBasicMaterial({map:li,transparent:!0,enableClipPlanes:!1})).force=!0,l.depthTest=!1,Qe.setMaterial(l),J?(d=.8*Pe*ce,c=.8*Pe*ce):(d=(Ne+xe+2*Re)*ce,c=Y?(Ve/2+2*Re)*ce:(Ve+Re)*ce),Mi(et=r.createRectangleNode({width:d,height:c,fill:!0,noEdge:!0})),(l=new n.MeshBasicMaterial({map:J?E:N,transparent:!0,enableClipPlanes:!1})).force=!0,l.depthTest=!1,et.setMaterial(l),!Dt&&!J)){let e=Ce-Ne+10,s=2*Se;Mi(t=r.createRectangleNode({width:e,height:s,fill:!0,noEdge:!0}));let d=new u({ratio:1});d.addChild(t);let h=new n.Texture;h.image=Ni(re,Jt,{alpha:1}),h.needsUpdate=!0,(l=new n.MeshBasicMaterial({map:h,transparent:!0,enableClipPlanes:!1})).force=!0,l.depthTest=!1,d.setMaterial(l),ht.addChild(d);let c=Math.floor(Te*ce*1.2/He);i=(Ce-Ne)*ce;let p=c>=7?Math.floor(c/2):c;a=Te*ce/p;let g=r.createRectangleNode({width:i,height:a,fill:!0,noEdge:!0});Mi(g),(l=new n.MeshBasicMaterial({map:ri,transparent:!0,enableClipPlanes:!1})).force=!0,l.depthTest=!1,g.setMaterial(l),ht.addChild(g),(Nt=new o({viewer:Ye,value:re,linkedNode:d})).subscribe("Click",Xi),Nt.subscribe("BeginManipulate",null),Nt.subscribe("Manipulate",null),Nt.subscribe("EndManipulate",null),Nt.subscribe("BeginPreactivate",Yi),Nt.subscribe("EndPreactivate",qi),d.setMatrix((new n.Matrix4).makeTranslation(0,(a-s*ce)/2,0)),Rt=Nt.linkToNode(ht)}J?(d=Pe*ce,c=Pe*ce):(d=(Ne+xe+2*Re)*ce,c=Y?(Ve/2+2*Re)*ce:(Ve+Re)*ce),Mi(Ke=r.createRectangleNode({width:d,height:c,fill:!0,noEdge:!0})),(l=new n.MeshBasicMaterial({map:J?P:Y?b:M,side:n.DoubleSide,transparent:!0,enableClipPlanes:!1})).force=!0,l.depthTest=!1,Ke.setMaterial(l),0===wt&&((xt=new o({viewer:Ye,axis:(new n.Vector3).copy(be)})).subscribe("Click",null),xt.subscribe("BeginManipulate",function(e){Bt=!0,Lt=!1,Wt=!1,Ei(e)}),xt.subscribe("Manipulate",Ui),xt.subscribe("EndManipulate",function(e){Bt=!1,Lt=!1,Wt=!1,ki(e)}),xt.subscribe("BeginPreactivate",function(){Ft=!0,Ye.setTemporaryCursor("pointer"),Pi()}),xt.subscribe("EndPreactivate",function(){Ft=!1,Ye.unsetTemporaryCursor(),Pi()}),wt=xt.linkToNode(Ke)),ct.addChild(Je),ct.addChild($e),J?((f=new s({type:"Spherical"})).addChild(Ke),Ke.setMatrix((new n.Matrix4).makeTranslation(-Pe*ce/2,-Pe*ce/2,0)),$e.addChild(f)):($e.addChild(Ke),ct.addChild(je)),Y&&(ct.addChild(Qe),ct.addChild(rt),J?((f=new s({type:"Spherical"})).addChild(et),et.setMatrix((new n.Matrix4).makeTranslation(-Pe*ce*.4,-Pe*ce*.4,0)),rt.addChild(f)):(rt.addChild(et),ct.addChild(ht))),z||(ze.addChild(lt),lt.addChild(tt)),ze.addChild(ct),ze.addChild(ut),ct.addChild(dt)}if(W>0){let e;d=new n.Vector3(0,Te/2*ce,0),c=new n.Vector3(-ce*W,Te/2*ce,0),Mi(e=r.createLineNode({points:[d,c]})),(l=new n.LineBasicMaterial({color:"80,80,80"===Ae?0:16777215,opacity:.5,transparent:!0})).force=!0,l.depthTest=!1,e.setMaterial(l),ze.addChild(e),Y&&(d=new n.Vector3(0,0,0),c=new n.Vector3(-ce*W,0,0),Mi(Ze=r.createLineNode({points:[d,c]})),(l=new n.LineBasicMaterial({color:"80,80,80"===Ae?0:16777215,opacity:.5,transparent:!0})).force=!0,l.depthTest=!1,Ze.setMaterial(l),ze.addChild(Ze))}ze.setVisibility(!xi()&&Et),Ye.addNode(ze,!1),ze.setMatrix(new n.Matrix4(ue.x,de.x,he.x,0,ue.y,de.y,he.y,0,ue.z,de.z,he.z,0,0,0,0,1)),ve=null,pi("_internalBuild")},this.setValue=function(e){ci("setValue");let t=e;_t&&ae===O.ORIENTED_GRADUATIONS&&!It&&this.value<0&&(t*=-1),this.value=void 0!==Q&&t<Q?Q:void 0!==ee&&t>ee?ee:t,this.getVisibleFlag()&&Ji(),pi("setValue")},this.getDisplayedValue=function(e){return Ri(this.value,"boolean"!=typeof e||!e)},this.getMatrix=function(){if(ze)return(new n.Matrix4).copy(ze.getMatrixWorld())},this.setVisibleFlag=function(e){e!==Et&&(Et=e,ze.setVisibility(!xi()&&Et),e&&this.setValue(this.value),Ye.render())},this.getVisibleFlag=function(){return Ht?Et:null},this.setVisibilityFree=function(e){ze&&ze.setVisibilityFree&&ze.setVisibilityFree(e)},this.getVisibilityFree=function(){if(ze)return ze.visibilityFree},this.clear=function(){Vt=!1,It=!1,Dt=!1,Ut=!1,kt=!1,At=!1,Ot=!1,Gt=!1,Bt=!1,Lt=!1,Ft=!1,Wt=!1,Xt=!1,Yt=!1,qt=!1,di()},this.subscribe=function(e,t){if(e&&t&&("RulerManipulateBegin"===e||"RulerManipulate"===e||"RulerManipulateEnd"===e||"OriginManipulateBegin"===e||"OriginManipulate"===e||"OriginManipulateEnd"===e))return Xe.subscribe({event:e},t)},this.unsubscribe=function(e){null!=e&&Xe.unsubscribe(e)},this.getSnappedTranslationVector=function(e){ci("getSnappedTranslationVector");let t=(new n.Vector3).copy(e.translationVector);(kt||At)&&(Xt=!0),kt=!1,At=!1,qt=!1;let i=Ye.currentViewpoint.create3DRayFrom2DPoint(we),a=(new n.Vector3).copy(ue).multiplyScalar(W*ce),r=(new n.Vector3).copy(be).multiplyScalar(ve).add(a),l=(new n.Vector3).copy(me).add(r),o=(new n.Matrix4).multiplyMatrices(ze.getMatrix(),ct.getMatrix().rotateX(.5*Math.PI)).elements,s=new n.Vector3(o[0],o[1],o[2]),u=new n.Vector3(o[8],o[9],o[10]),d=(new n.Plane).setFromNormalAndCoplanarPoint(u,l),h=i.intersectPlane(d);J||l.add((new n.Vector3).copy(s).multiplyScalar(xe*ce));let c=(new n.Vector3).copy(h).sub(l).dot(s),p=this.initValue+e.translationVector.length()*(be.dot(e.translationVector)>0?1:-1),g=J?-Ne*ce:0;if(c<g||c>(J?Ne*ce:ce*Ce))J&&c>g&&c<(Ne+ai.image.getContext("2d").measureText(ai.image.textDisplayed).width)*ce&&(qt=!0),void 0!==Q&&p<Q?t=(new n.Vector3).copy(be).multiplyScalar(Q-this.initValue):void 0!==ee&&p>ee&&(t=(new n.Vector3).copy(be).multiplyScalar(ee-this.initValue));else{let e=c>Ne*ce?"snappingMainGrads":"snappingSmallGrads";qt=!0,J&&(e="snappingSmallGrads"),Xt=!0,kt="snappingMainGrads"===e,At="snappingSmallGrads"===e;let i="snappingMainGrads"===e?We:We/ie;p=Math.round(p/i)*i,void 0!==Q&&p<Q?p=Q:void 0!==ee&&p>ee&&(p=ee),p-=this.initValue,t=(new n.Vector3).copy(be).multiplyScalar(p)}return pi("getSnappedTranslationVector"),{snappedTranslationVector:t,returnCode:0}},this.beginManipulation=function(){It=!0,ze.setPickable(h.PICKTHROUGH)},this.endManipulation=function(){ze.setPickable(h.PICKABLE),It=!1,kt=!1,At=!1},this.display=function(){Vt=!1,It=!1,Pt=!1,Dt=!1,Ut=!1,kt=!1,At=!1,Ot=!1,Gt=!1,Bt=!1,Lt=!1,Ft=!1,Wt=!1,Xt=!1,Yt=!1,qt=!1,ui()},this.refresh=function(){this.setValue(this.value)}}});return O.DEFAULT=0,O.SYMMETRIC=1,O.DEFAULT_GRADUATIONS=0,O.ORIENTED_GRADUATIONS=1,O.ORIGIN_DEFAULT=0,O.ORIGIN_SYMMETRIC=1,O.NM_UNIT=1,O.MICRON_UNIT=2,O.MM_UNIT=4,O.CM_UNIT=8,O.M_UNIT=16,O.HM_UNIT=32,O.KM_UNIT=64,O.INCH_UNIT=128,O.FOOT_UNIT=256,O.YARD_UNIT=512,O.MILE_UNIT=1024,O.NMILE_UNIT=2048,O});