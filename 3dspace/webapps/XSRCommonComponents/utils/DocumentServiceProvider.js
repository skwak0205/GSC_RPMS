define("DS/XSRCommonComponents/utils/DocumentServiceProvider",["UWA/Class/Model","UWA/Promise","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/utils/Constants","DS/DocumentManagement/DocumentManagement","DS/XSRCommonComponents/utils/XInfraRequestUtil","DS/XSRCommonComponents/utils/RequestUtil"],function(e,t,n,o,r,a,i){"use strict";var l;return e.extend({convertb64toBlob:function(e,t,n){t=t||"",n=n||512;for(var o=atob(e),r=[],a=0;a<o.length;a+=n){for(var i=o.slice(a,a+n),l=new Array(i.length),d=0;d<i.length;d++)l[d]=i.charCodeAt(d);var c=new Uint8Array(l);r.push(c)}return new Blob(r,{type:t})},defaults:{generatePDF:!1},setup:function(e){this.id=e&&e.id?e.id:"",l=i.getPlatformId()},getDocumentsFromParent:function(e,n){return new t(function(t,a){console.log("************start********"+new Date);var l={getVersions:!0,relInfo:{parentId:e,parentRelName:n||o.RELATED_DOC_REL_NAME,parentDirection:"from"},tenant:i.getPlatformId(),tenantUrl:i.get3DSpaceURL(),securityContext:i.getSecurityContext(),additionalHeaders:i.getWorkUnderHeaders(),onComplete:function(e){Array.isArray(e.data)&&(console.log("************end********"+new Date),t(e.data))},onFailure:function(e){a(e)}};r.getDocumentsFromParent(l)})},createDocument:function(e,n,a){return new t(function(t,l){var d=a.title||e.name,c=a.description?a.description:"",u=a.type?a.type:"",s=a.policy?a.policy:"",m=a.relationName?a.relationName:"",f={title:d,description:c,type:u,policy:s};e&&(f.fileInfo={comments:"",file:e}),n&&(f.relInfo={parentId:n,parentRelName:m||o.RELATED_DOC_REL_NAME,parentDirection:"from"});var p={tenant:i.getPlatformId(),securityContext:i.getSecurityContext(),tenantUrl:i.get3DSpaceURL(),additionalHeaders:i.getWorkUnderHeaders(),onFailure:l,onComplete:function(e){Array.isArray(e.data)&&t(e.data)}};r.createDocument(f,p)})},deleteDocument:function(e){var n=e;if(n)return new t(function(e,t){var o={tenant:i.getPlatformId(),securityContext:i.getSecurityContext(),additionalHeaders:i.getWorkUnderHeaders(),tenantUrl:i.get3DSpaceURL(),onComplete:e,onFailure:t};r.deleteDocument(n,o)})},detachDocuments:function(e,n,o){var r=this,a=[];return new t(function(i,l){e.length&&e.length>0&&(e.forEach(function(e){var t=r.removeDocument(e,n,o);t&&a.push(t)}),t.all(a).then(i.bind(this)).catch(l.bind(this)))})},removeDocument:function(e,n,a){var l=e;if(l)return new t(function(e,t){var d={relInfo:{parentId:n,parentRelName:a||o.RELATED_DOC_REL_NAME,parentDirection:"from"},tenant:i.getPlatformId(),securityContext:i.getSecurityContext(),additionalHeaders:i.getWorkUnderHeaders(),tenantUrl:i.get3DSpaceURL(),onComplete:e,onFailure:t};r.disconnectDocumentFromParent(l,d)})},attachDocument:function(e,n,a){return new t(function(t,l){var d={relInfo:{parentId:e,parentRelName:a||o.RELATED_DOC_REL_NAME,parentDirection:"from"},tenant:i.getPlatformId(),securityContext:i.getSecurityContext(),additionalHeaders:i.getWorkUnderHeaders(),tenantUrl:i.get3DSpaceURL(),onComplete:t,onFailure:l};r.connectDocumentToParent(n,d)})},uploadFile:function(e){var n=(e=e.data).itemPid,o=e.files[0]||e.files,a=e.fileComments?e.fileComments:" ",l=i.getSecurityContext(),d=this,c={};return c.file=o,c.fileName=o.name,a&&(c.comments=a),"modify"!==e.mode?new t(function(e,t){var o={securityContext:l,additionalHeaders:i.getWorkUnderHeaders(),tenant:i.getPlatformId(),tenantUrl:i.get3DSpaceURL(),onComplete:function(t){e.call(d,t)},onFailure:t};r.addFileToDocument({id:n,fileInfo:c},o)}):new t(function(e,t){var o={securityContext:l,additionalHeaders:i.getWorkUnderHeaders(),tenant:i.getPlatformId(),tenantUrl:i.get3DSpaceURL(),onComplete:function(t){e.call(d,t)},onFailure:t};r.modifyDocument({id:n,fileInfo:c,newFile:!1},o)})},updateAttributes:function(e){var n={requests:[]},o={method:"PATCH",body:[],queryParams:{select:["physicalid","modified"]}},r=e.request;o.path="model/bus/"+e.itemid,o.body=[];for(var a=0;a<r.length;a++){var d={},c=r[a];d.op="replace",d.path=c.attribute,d.value=c.value,o.body.push(d),c.isBasicAttribute?o.queryParams.select.push(c.attribute):o.queryParams.select.push("attribute["+c.attribute+"]")}return n.requests.push(o),new t(function(e,t){i.send3DSpaceRequest("resources/v1/collabServices/attributes/op/update?="+l,"PUT",{type:"json",headers:{"Content-type":"application/json;"},data:JSON.stringify(n)},e,t)})},lockDocument:function(e){return new a({id:"lock"}).invoke(e)},getDocumentInfo:function(e){return new t(function(t,n){var o=this,a=e.data,l=!!a.getVersions,d=a.itemPid&&Array.isArray(a.itemPid)?a.itemPid:[a.itemPid],c={getVersions:l,tenant:i.getPlatformId(),tenantUrl:i.get3DSpaceURL(),securityContext:i.getSecurityContext(),additionalHeaders:i.getWorkUnderHeaders(),onComplete:function(e){var n=e.data;n&&UWA.is(n,"array")&&(n=n[0]),t.call(o,n)},onFailure:n};r.getDocuments(d,c)})},unlockDocument:function(e){return new a({id:"unlock"}).invoke(e)},deleteVersion:function(e){var n=(e=e.data).itemPid,o=e.versionId,a=e.latestVersionId,l=e.deleteAllVersions,d=i.getSecurityContext(),c=this;return new t(l?function(e,t){var a={securityContext:d,tenant:i.getPlatformId(),additionalHeaders:i.getWorkUnderHeaders(),tenantUrl:i.get3DSpaceURL(),onComplete:function(t){e.call(c,t)},onFailure:t};r.deleteFile(n,o,a)}:function(e,t){var l={securityContext:d,additionalHeaders:i.getWorkUnderHeaders(),tenantUrl:i.get3DSpaceURL(),tenant:i.getPlatformId(),onComplete:function(t){e.call(c,t)},onFailure:t};r.deleteVersion(n,a,o,l)})},downloadFile:function(e){var n=e.data,o=n.itemPid,a=n.versionId,l=n.checkout,d=(n.filename,i.getSecurityContext());return new t(l?function(e,t){var n={securityContext:d,tenant:i.getPlatformId(),tenantUrl:i.get3DSpaceURL(),additionalHeaders:i.getWorkUnderHeaders(),autoDownload:!0,onComplete:e,onFailure:t};r.downloadDocument(o,a,l,n)}:function(e,t){var n={securityContext:d,tenant:i.getPlatformId(),tenantUrl:i.get3DSpaceURL(),additionalHeaders:i.getWorkUnderHeaders(),autoDownload:!0,onComplete:e,onFailure:t};r.downloadDocument(a,void 0,l,n)})},downloadDocuments:function(e){var n=this,o=e.itemIds;return new t(function(e,t){var a={tenant:i.getPlatformId(),securityContext:i.getSecurityContext(),tenantUrl:i.get3DSpaceURL(),additionalHeaders:i.getWorkUnderHeaders(),autoDownload:!0,onFailure:function(e){var n=e.data&&e.data[0]?e.data[0].updateMessage:e;t(n)},onComplete:function(e){e&&Array.isArray(e)&&e.forEach(function(e){var t=e.downloadUrl,o=e.fileName,r=e.errorMessage;r?console.log("Failed to download : "+r):n.downloadFileFromFCS(t,o)})}.bind(this)};r.downloadDocuments(o,a)})},downloadFileFromFCS:function(e,t){var n=this,o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="blob",o.onload=function(e){200==this.status&&function(e,t){n.downloadFileonBrowser({blob:e,fileName:t})}(this.response,t)},o.onerror=function(e){console.log("error")},o.send()},generatePDFReport:function(e){return this.set("generatePDF",!0),new a({id:"generatePDFReport"}).invoke({data:e})},checkout:function(e){var n=this;return new t(function(t,o){(function(t,o){var r=new a({id:e.webservice?e.webservice:"downloadPDFReport"}),i={data:e};r.invoke(i).then(function(e){var o=n.convertb64toBlob(e.fileContent,"application/pdf");t({blob:o,generatedTime:e.generatedTime,fileName:e.fileName,isTemplateObsolete:e.isTemplateObsolete})},o)}).call(n,t,o)})},downloadPDFReport:function(e){this.checkout.call(this,e).then(this.downloadFileonBrowser.bind(this))},mailPDFReport:function(e){},downloadFileonBrowser:function(e){n.downloadFileonBrowser(e)},isPDFReportCheckedIn:function(e){return new a({id:"isPDFReportCheckedIn"}).invoke({data:e})}})});