define("DS/XSRCommonComponents/utils/RequestUtil",["UWA/Class","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI","DS/Utilities/TouchUtils","DS/XSRCommonComponents/utils/PlatformDataProvider","DS/XSRCommonComponents/utils/Constants"],function(e,t,n,r,i,o){"use strict";return e.singleton({_TenantList:[],ReadModesEnum:{SERVER:1,CACHE:2},WriteModesEnum:{SERVER:1,CACHE:2},getTenantList:function(){return this._TenantList},BrowserEnum:{OPERA:0,CHROME:1,FIREFOX:2,IE:3,SAFARI:4,EDGE:6,SAFARI_IPAD:7,SAFARI_IPHONE:8,UNKNOWN:99},m3DSpaceURL:"../..",m3DSearchURL:"",mUserLogin:"",m3DSpaceCSRFToken:null,mSourcingCSRFToken:null,mLanguage:null,widgetTitle:"",_theListSC:[],_theListSC_NLS:[],_theListCollabSpace:[],CREDENTIALS_SEPARATOR:" ● ",_platforms:null,_SCPreferredDB:null,_callback:null,init:function(){return this._allowFullScreen(),this},detectBrowser:function(){return!document.documentMode&&window.StyleMedia?this.BrowserEnum.EDGE:window.opera||navigator.userAgent.indexOf(" OPR/")>=0?this.BrowserEnum.OPERA:window.chrome?this.BrowserEnum.CHROME:"undefined"!=typeof InstallTrigger?this.BrowserEnum.FIREFOX:document.documentMode?this.BrowserEnum.IE:/^((?!chrome|android).)*safari/i.test(navigator.userAgent)?this.BrowserEnum.SAFARI:this.BrowserEnum.UNKNOWN},getLanguage:function(){if(this.mLanguage)return this.mLanguage;try{if(window.parent&&window.parent.dsLang)return window.parent.dsLang;if(widget)return widget.lang}catch(e){}var e="en";return(e=navigator.browserLanguage?navigator.browserLanguage:navigator.language).indexOf("fr")>-1?"fr":e.indexOf("en")>-1?"en":e.indexOf("es")>-1?"es":e.indexOf("it")>-1?"it":e.indexOf("de")>-1?"de":e.indexOf("ja")>-1?"ja":e.indexOf("zh")>-1?"zh":"en"},isSafarionIPadorPod:function(){if(this.BrowserEnum.SAFARI!==this.detectBrowser())return!1;var e=null!==navigator.userAgent.match(/iPad/i),t=null!==navigator.userAgent.match(/iPhone/i)||null!==navigator.userAgent.match(/iPod/i);return e&&(t=!1),!(!e&&!t)||void 0},isMobile:function(){return/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase())},getTouchMode:function(){return r.getTouchMode()},_allowFullScreen:function(){var e=window.top.document.getElementById("frame-"+widget.id);e&&!e.getAttribute("allowfullscreen")&&e.setAttribute("allowfullscreen",!0)},get3DSpaceURL:function(){return this.m3DSpaceURL||""},get3DSearchURL:function(){return this.m3DSearchURL||""},getSecurityToken:function(){return this.getloginUser().login+"|"+this.getSecurityContext()+"|"+o.KEY_PREFERRED},getCVRequestLabel:function(e){return"XSR-"+this.getloginUser().login+"-"+e},setWidgetTitle:function(e){return e||""},getAppTenantName:function(){if(this._platforms&&this.isCloud()){let e=this.getPlatformId(),t=this.getTenantDisplayName(e);if(t)return" ("+t+")"}return""},setCSRFToken:function(){var e=this,t=function(t){(t.csrf||null!==t.csrf)&&e.set3DSpaceCSRFToken(t.csrf.value)},n=function(e){console.log("getCSRFToken:Failure..."+e)};this.send3DSpaceRequest("resources/v1/application/E6WFoundation/CSRF","GET",{async:!1,timeout:5e3,type:"json",headers:{"Content-type":"application/json;"}},function(e){t&&t(e)},function(e){n&&n(e)})},setMEICSRFToken:function(){var e=this,t=function(t){(t.csrf||null!==t.csrf)&&e.setSourcingCSRFToken(t.csrf.value)},n=function(e){console.log("getSourcingCSRFToken:Failure..."+e)};this.sendSourcingRequest("sourcing","resources/v1/application/E6WFoundation/CSRF","GET",{async:!1,timeout:5e3,type:"json",headers:{"Content-type":"application/json;"}},function(e){t&&t(e)},function(e){n&&n(e)})},getPlatformId:function(){try{return this._platformId=widget&&widget.getValue("x3dPlatformId")?widget.getValue("x3dPlatformId"):"OnPremise",this._platformId}catch(e){return"OnPremise"}},retrieveSCList:function(e){if(e&&e.callback){var t="resources/modeler/pno/person?current=true&select=collabspaces&select=preferredcredentials&tenant="+this.getPlatformId();this._callback=e.callback;var n=this,r=function(e){var t,r,i,o=!1,a=e.preferredcredentials;if(a.collabspace&&a.role&&a.organization){var s=a.collabspace,u=a.role,c=a.organization;t=s.name,r=u.name,i=c.name,n._SCPreferredDB=r+"."+i+"."+t}var l=e.collabspaces;if(l&&l.length>0){for(var d,g=!1,h=0;h<l.length;h++){for(var f=(m=l[h]).couples||[],S=0;S<f.length;S++){var p=f[S];if(void 0===d&&(d=p.organization.name),d!==p.organization.name){g=!0;break}}if(g)break}for(h=0;h<l.length;h++){var m,R=(m=l[h]).name,C=m.title?m.title:m.name;for(f=m.couples,S=0;S<f.length;S++){var L=f[S],E=L.organization,y=L.role,T=E.name,A=y.name,_=y.nls,v=A+"."+T+"."+R,D=g?C+n.CREDENTIALS_SEPARATOR+T+n.CREDENTIALS_SEPARATOR+_:C+n.CREDENTIALS_SEPARATOR+_;let e={};e[R]=C,n._theListSC.push(v),n._theListSC_NLS.push(D),n._theListCollabSpace.push(e),n._SCPreferredDB?i===T&&r===A&&t===R&&(o=!0):o=!0}}}n._callback(o)},i=function(e){console.log(e)};this.send3DSpaceRequest(t,"GET",{async:!1,timeout:5e3,type:"json",headers:{"Content-type":"application/json;"}},function(e){r&&r(e)},function(e){i&&i(e)})}},getCurrentSCCollabSpaceTitle:function(){let e=this.getSecurityContext().split("."),t=e[e.length-1];if(Array.isArray(this._theListCollabSpace)&&this._theListCollabSpace.length>0)for(let e=0;e<this._theListCollabSpace.length;e++){let n=this._theListCollabSpace[e];if(n[t])return n[t]}return""},getSCPreferenceList:function(e){for(var t=[],n={name:"Current_security_credentials",type:"list",label:e,options:[]},r=0;r<this._theListSC.length;r++)t.push({label:this._theListSC_NLS[r],value:this._theListSC[r]});return t.sort((e,t)=>e.label.localeCompare(t.label)),n.options=t,n},setSecurityContext:function(){var e=this,t=null,n=widget.getValue("Current_security_credentials");if(null!=n&&""!==n)t="ctx::"+n,e._securityContext=t;else{var r,i=(new Date).getTime();r="resources/modeler/pno/person?current=true&select=collabspaces&select=preferredcredentials&tenant="+e.getPlatformId(),r+="&timestamp="+i;var o=function(n){if((t=n.SecurityContext)&&null!==t)console.log("Error!! Unable to get preferred security context!!!");else{var r=n.preferredcredentials;if(r&&r.role&&r.organization&&r.collabspace){var i="ctx::";i+=r.role.name+"."+r.organization.name+"."+r.collabspace.name,console.info("Setting security Context: "+t),e._securityContext=i}else console.log("Error!! Unable to get preferred security context!!!")}},a=function(e){console.log("getSecurityContext:Failure..."+e)};this.send3DSpaceRequest(r,"GET",{async:!1,timeout:5e3,type:"json",headers:{"Content-type":"application/json;"}},function(e){o&&o(e)},function(e){a&&a(e)})}},getSecurityContext:function(){return this._securityContext||""},getloginUser:function(){return this.mUserLogin?this.mUserLogin:(this.mUserLogin=n.getUser(),this.mUserLogin)},populateTenantList:function(e){let t=this;Object.keys(e).forEach(function(n){t._TenantList.push({displayName:e[n].displayName,name:e[n].platformId})})},getTenantDisplayName:function(e){let t=this,n=e;return t._TenantList&&Array.isArray(t._TenantList)&&t._TenantList.some(function(t){if(t.name==e)return n=t.displayName}),n},set3DSpaceURL:function(){var e=this;return new Promise(function(t,n){i.getAllPlatforms().then(function(n){e._platforms=n,e.populateTenantList(n);var r=e.getPlatformId(),o=i.getServiceURL("3DSpace",r);e.m3DSpaceURL=o,t()},n)})},set3DSpaceCSRFToken:function(e){this.m3DSpaceCSRFToken=e},setSourcingCSRFToken:function(e){this.mSourcingCSRFToken=e},get3DSpaceCSRFToken:function(){return this.m3DSpaceCSRFToken},getSourcingCSRFToken:function(){return this.mSourcingCSRFToken},send3DSpaceRequest:function(e,t,n,r,i){this.sendRequest(this.m3DSpaceURL+"/"+e,t,n,r,function(e,t){i(t)})},send3DSearchRequest:function(e,n,r,i,o){return r.method=n,r.onComplete=i,r.onFailure=o,t.authenticatedRequest(this.m3DSearchURL+"/"+e,r)},sendSourcingRequest:function(e,t,n,r,o,a){var s=this.getPlatformId();this.mSourcingURL=i.getServiceURL(e,s),this.mSourcingURL&&this.sendRequestForSourcing(e,this.mSourcingURL+"/"+t,n,r,o,function(e,t){a(t)})},sendRequest:function(e,t,n,r,i){n.method=t,n.onComplete=r,n.onFailure=i,this.sendRequestSimple(e,n)},sendRequestForSourcing:function(e,t,n,r,i,o){r.method=n,r.onComplete=i,r.onFailure=o,this.sendRequestSimpleForSourcing(e,t,r)},sendRequestSimpleForSourcing:function(e,n,r){return r.headers||(r.headers={},r.headers["Content-Type"]="application/json"),r.type||(r.type="json"),r.data||(r.data=""),r.headers["Accept-Language"]||(r.headers["Accept-Language"]=this.getLanguage()),this.mSourcingCSRFToken&&"sourcing"===e&&(r.headers["X-Requested-With"]="csrf protection",r.headers["X-Request"]=this.mSourcingCSRFToken,r.headers.ENO_CSRF_TOKEN=this.mSourcingCSRFToken),t.authenticatedRequest(n,r)},sendRequestSimple:function(e,n){return n.headers||(n.headers={},n.headers["Content-type"]="text/html"),n.type||(n.type="text"),n.data||(n.data=""),!n.headers.SecurityContext&&this.getSecurityContext()&&(n.headers.SecurityContext=encodeURIComponent(this.getSecurityContext())),n.headers["Accept-Language"]||(n.headers["Accept-Language"]=this.getLanguage()),this.m3DSpaceCSRFToken&&(n.headers["X-Requested-With"]="csrf protection",n.headers["X-Request"]=this.m3DSpaceCSRFToken,n.headers.ENO_CSRF_TOKEN=this.m3DSpaceCSRFToken),void 0!==n.canAddWorkUnderHeader&&!0!==n.canAddWorkUnderHeader||(n.headers=this.addAdditionaWorkUnderlHeader(n.headers)),t.authenticatedRequest(e,n)},get3DSearchURL:function(){var e=this.getPlatformId();return i.getServiceURL("3DSearch",e)},addAdditionaWorkUnderlHeader:function(e){return Object.assign(e,this.getWorkUnderHeaders())},getWorkUnderHeaders:function(){return this.workUnderContext?this.workUnderContext.getWorkUnderHeaders():{}},setWorkUnderContext:function(e){this.workUnderContext=e},multiExpand:function(e,t,n){var r=(new Date).getTime(),i=encodeURIComponent(this.getSecurityToken()),o="cvservlet/multiexpand?tenant="+this.getPlatformId()+"&_="+r,a=this;return new Promise(function(t,n){a.send3DSpaceRequest(o,"POST",{type:"json",headers:{"Content-type":"application/json",SecurityToken:i},data:JSON.stringify(e)},t,n)})},isCloud:function(){var e;return void 0===e&&(e=!1,"undefined"!=typeof widget&&"OnPremise"!==widget.getValue("x3dPlatformId")&&(e=!0)),e},isPerformanceSpecEnabled:function(){return new Promise((e,t)=>{this.send3DSpaceRequest("resources/v1/modeler/characteristics/config/isperformancespecenabled","GET",{async:!1,timeout:5e3,type:"json",headers:{"Content-type":"application/json;"}},function(t){e(t)},function(e){t(e)})})}})});