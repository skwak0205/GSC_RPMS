/*!  COPYRIGHT DASSAULT SYSTEMES 2020   */
define("DS/ViewerCommandsExt/ViewerScreenshotUtils",[],function(){"use strict";function e(){return"object"==typeof e.instance?e.instance:(e.instance=this,this)}return e.prototype.saveScreenshot=function(e){this._viewer=e.viewer,this.__pictureFlash().then(this.__getScreenShot.bind(this)).then(t=>{this.__downloadSreenShot(t,e.filenamePrefix)})},e.prototype.b64Screenshot=function(e){return new Promise(t=>{this._viewer=e.viewer,this.__pictureFlash().then(this.__getScreenShot.bind(this)).then(t).catch(function(){t("")})})},e.prototype.__pictureFlash=function(e){return new Promise(t=>{var i=this._viewer.getContent().getParent(),n=new UWA.Element("div",{id:"_ViewScreenShot-Flash",styles:{position:"absolute",top:0,left:0,width:this._viewer.SCREEN_WIDTH+"px",height:this._viewer.SCREEN_HEIGHT+"px","background-color":"white"}}).inject(i),o=1,r=function(){o-=.02,n.setStyle("opacity",o),o<0?(i.removeChild(n),"function"==typeof e&&e()):requestAnimationFrame(r)};r(),t()})},e.prototype.__getScreenShot=function(e,t){return new Promise(i=>{this._viewer.save&&this._viewer.save();var n=document.createElement("CANVAS"),o=n.getContext("2d"),r=this._viewer.currentViewpoint,h={data:null,width:this._viewer.SCREEN_WIDTH,height:this._viewer.SCREEN_HEIGHT};n.width=e||h.width,n.height=t||h.height,r.getControl().update(),this._viewer.renderToTarget(h,r);var a=o.getImageData(0,0,n.width,n.height);a.width!==n.width&&(console.error("ViewerScreenshot:: Image width not matching with canvas width"),i(void 0)),a.height!==n.height&&(console.error("ViewerScreenshot:: Image height not matching with canvas height"),i(void 0));var s=(h.width-1)/(a.width-1),c=(h.height-1)/(a.height-1),d=h.data,w=a.data,l=function(e,t,i,n,o){return o?(t=n-t,i*Math.floor(t-1)+Math.floor(e)):i*Math.floor(t)+Math.floor(e)};if(1===s&&1===c)for(var g=a.height,_=a.width,u=4*_,v=0;v<g;++v)for(var f=v*_*4,p=(g-v)*_*4,m=u;m>0;--m)w[f+m]=d[p+m];else{var S=a.height,y=a.width;for(v=0;v<S;++v)for(m=0;m<y;++m){f=4*l(m,v,a.width,a.height,!1),p=4*l(m,v,h.width,h.height,!0);w[f]=d[p],w[f+1]=d[p+1],w[f+2]=d[p+2],w[f+3]=d[p+3]}}o.putImageData(a,0,0,0,0,n.width,n.height),i(n.toDataURL("image/png"))})},e.prototype.__downloadSreenShot=function(e,t){if("download"in document.createElement("a")){var i=this.__toBlob(e),n=t?t+".png":"Viewer_Screenshot.png",o=new UWA.Element("a",{href:i,download:n,styles:{visibility:"hidden"}}).inject(document.body);o.click(),document.body.removeChild(o)}else console.warn("Unsupported device for this device")},e.prototype.__toBlob=function(e){for(var t=e.match(/data:([^;]*)(;base64)?,([0-9A-Za-z+/]+)/),i=atob(t[3]),n=new ArrayBuffer(i.length),o=new Uint8Array(n),r=0;r<o.length;++r)o[r]=i.charCodeAt(r);var h=new Blob([o],{type:t[1]});return window.URL.createObjectURL(h)},new e});