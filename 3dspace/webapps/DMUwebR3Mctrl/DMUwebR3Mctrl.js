/*!  Copyright 2021 Dassault Systemes. All rights reserved. */
define("DS/DMUwebR3Mctrl/DMUwebR3Mctrl",["UWA/Class","UWA/Core","UWA/Utils/InterCom","DS/DMUwebR3Mux/DMUwebR3Mlist","DS/ENOXTriptych/js/ENOXTriptych","DS/EditPropWidget/EditPropWidget","DS/EditPropWidget/constants/EditPropConstants","DS/EditPropWidget/utils/EditPropUtils","DS/DMUwebR3Mutils/DMUwebR3MserverRequests","DS/DMUwebR3Mutils/DMUwebR3MwidgetUtils","DS/CoreEvents/ModelEvents","DS/PlatformAPI/PlatformAPI","i18n!DS/DMUwebR3Mctrl/assets/nls/DMUwebR3Mctrl.json","css!DS/DMUwebR3Mux/assets/css/DMUwebR3Mux"],function(e,t,n,i,a,r,s,o,l,d,c,u,p){"use strict";function f(){return(65536*(1+Math.random())|0).toString(16).substring(1)}var h=e.extend({init:function(e){let h,g,S,y,v,m,w,b,D,M=new c,I=e.parent,O={},E={},P=f(),x=0,C=[],T={all:[],pending:[],completed:[],timeout:[],running:[]},k=Object.freeze({rvw:1,isr:1,msr:1,mkp:0,owner:0,released:0,obsolete:0});function R(e){if(O[e])return[e];let t=[];return Object.keys(O).forEach(n=>{(function e(t,n){if(n){if(n[t])return 1;if(n.children)return n.children&&n.children[t]?1:Object.keys(n.children).some(i=>e(t,n.children[i]))}})(e,O[n])&&t.push(n)}),t}function U(e){var t=Object.keys(O).length;d.getWidget().setTitle(e?"":0===t?p.noValidObj:p["validObj"+(1===t?"":"s")]+t)}function W(e){if(void 0===e.validState)return;if(e.validStateWarning="",l.getIsrTypes().indexOf(e.type)>-1)"InProgress"===e.validState?"donenoko"!==e.analysisState&&"donewithko"!==e.analysisState||(e.validStateWarning=p.itfwarningAnalyzed):"Failed"===e.validState?"notcomputed"===e.analysisState?e.validStateWarning=p.itfwarningNotComputed:"startednoko"===e.analysisState?e.validStateWarning=p.itfwarningNotAnalyzed:"donenoko"===e.analysisState&&(e.validStateWarning=p.itfwarningNotReported):"Passed"===e.validState&&("notcomputed"===e.analysisState?e.validStateWarning=p.itfwarningNotComputed:"startednoko"===e.analysisState||"startedwithko"===e.analysisState?e.validStateWarning=p.itfwarningNotAnalyzed:"donewithko"===e.analysisState&&(e.validStateWarning=p.itfwarningReported));else{let t=e.children&&e.children[e.id+"_check"];if(!(t=t&&t.children?Object.keys(t.children).map(e=>E[e]).filter(e=>e):null)||!t.length)return;"InProgress"!==e.validState||t.some(t=>t.validState===e.validState)?"Failed"!==e.validState||t.some(t=>t.validState===e.validState)?"Passed"!==e.validState||t.every(e=>"Passed"===e.validState)||(e.validStateWarning=p.warningpassed):e.validStateWarning=p.warningfailed:e.validStateWarning=p.warninginprogress}}function j(e,t,n){if(!e||!t)return;let i,a=n||t.issue&&t.issue.length&&t.ca&&t.ca.length;return["issue","ca"].forEach(n=>{if(!t[n]||!t[n].length)return;i=!0;let r=e.children||(e.children={});if(a){let i=e.id+"_"+n;r[i]={id:i,title:p[n+(t[n].length>1?"s":"")],children:{}},r=r[i].children}t[n].forEach(e=>{r[e.id]=e}),delete t[n]}),!n&&a&&(e.noSort=!0),i}function V(e){var t,n=[],i=[],a=[],r=[],s=l.getRvwTypes(),o=l.getIsrTypes(),d=l.getMkpTypes(),c=l.getMsrTypes();Object.keys(e).forEach(function(e){t=this[e].type,s.indexOf(t)>-1?n.push(e):o.indexOf(t)>-1?i.push(e):d.indexOf(t)>-1?a.push(e):c.indexOf(t)>-1&&r.push(e)},e);var u={rvwIds:n,isrIds:i,mkpIds:a,msrIds:r};l.navigate(u).then(function(e){var t={};[0,1,2,3].forEach(function(e){Object.keys(this[e]).forEach(function(e){let n=O[e];if(!n)return void window.console.log("id: "+e+" not in validated objects list");let i=["validated","check","highlight","issue","ca"].some(t=>this[e][t]&&this[e][t].length);["context","validated","check","highlight"].forEach(function(t){if(!this[t]||!this[t].length)return;let a=n.children||(n.children={});if(i){let n=e+"_"+t;a[n]={id:n,title:p[t+(this[t].length>1?"s":"")],children:{}},"validated"===t&&(a[n].validatedPath=this.validatedPath),"highlight"===t&&this[t].forEach(e=>j(e,e,!1)),a=a[n].children}this[t].forEach(function(e){a[e.id]=O[e.id]||e}),delete this[t]},this[e]),j(n,this[e],!0),function e(t){t&&t.id&&(E[t.id]||(E[t.id]=t),Object.keys(t.children||{}).forEach(n=>e(t.children[n])))}(n),W(n),i&&(n.noSort=!0),t[e]=n},this[e])},e),g.updateValidations(t)})}function A(){m&&m.dialog&&m.dialog.destroy(),m=null,w&&w.clean(),w=null,C&&C.forEach(e=>e.cancel()),C=[],d.perfoMark("refreshGrid_"+ ++x);const e=t.createElement("div",{class:"r3mLoadingValidations mask wux-datagridview-emptycontentmessage"}).inject(I),n=t.createElement("div",{class:"spinner spinner-lg spinning fade in",styles:{display:"flex","justify-content":"center"}}).inject(e);t.createElement("span",{class:"spinner-bar"}).inject(n),t.createElement("span",{class:"spinner-bar spinner-bar1"}).inject(n),t.createElement("span",{class:"spinner-bar spinner-bar2"}).inject(n),t.createElement("span",{class:"spinner-bar spinner-bar3"}).inject(n),t.createElement("div",{class:"r3mWelcomeText",html:p.validationLoad,styles:{}}).inject(e),U(!0),O={},E={};const i=l.search(b,function(e,t){O=Object.assign(O,e),E=Object.assign(E,e),0===t&&g.removeAll(),g.updateValidations(e),g.checkFilterAndFetchValue(),V(e),U()});i.promise.finally(function(){e.destroy(),d.perfoMeasure("refreshGrid_"+this)}.bind(x)),C.push(i)}function N(e,t){function n(e,t){return e.some(function(e){return t.length===e.length&&e.every(function(e,n){return e===t[n]})})}g.getSelectedRows().forEach(function(i){if(!i||!i.id||!E[i.id])return void window.console.error("Unidentified object");let a;(a=i.id.search("_")>-1?Object.values(E[i.id].children):[E[i.id]]).forEach(function(i){var a;i.validatedPath&&i.validatedPath.length>2?(a=i.validatedPath.map(function(e){return t[e.pid]||(t[e.pid]={type:e.type}),e.pid}),n(e,a)||e.push(a)):(t[i.pid||i.id]||(t[i.pid||i.id]={type:i.type}),a=[i.pid||i.id],n(e,a)||e.push(a))})})}function F(e,t,n){t.forEach(function(t){e.push({envId:d.getPlatformId(),serviceId:"3DSpace",contextId:d.getSecurityContext(),objectId:t[t.length-1],objectType:n[t[t.length-1]].type,path:t.length>2?t.map(function(e){return{resourceid:e,type:n[e].type}}):void 0})})}function _(e,t){var n={protocol:"3DXContent",version:"1.0",source:d.getWidgetAppId(),data:{items:[]}};return F(n.data.items,e,t),n}function X(e){var t,i=[],a={};if(N(i,a),t=i.map(function(e){var t=e[e.length-1],n=a[t].type,i={getID:function(){return t},tenant:d.getPlatformId(),type:n};return e.length>2&&(i.getRelationID=function(){return e[e.length-2]}),o.getModelFromSelectedNode(i)}),h.getRightOpen()&&S.initDatas(t),!e){var r={version:"1.1",paths:i,attributes:a,tenant:d.getPlatformId()},s={uid:f(),originUid:P,timestamp:Date.now(),appid:d.getWidgetAppId(),originWidgetId:d.getWidgetId()};u.publish("DS/PADUtils/PADCommandProxy/select",{data:r,metadata:s}),y||(v=d.getWidgetAppId()+"_CompassSocket_"+d.getWidgetId(),(y=new n.Socket(v)).subscribeServer("com.ds.compass",window.parent)),i.length?y.dispatchEvent("onSetX3DContent",_(i,a),v):y.dispatchEvent("onResetX3DContent",{},v)}}function L(){X()}function q(){X()}function B(e){var t;["rvw","isr","mkp","msr","owner","released","obsolete"].forEach(function(n){e[n]!==b[n]&&(t=!0,b[n]=e[n])}),t&&(A(),localStorage.setItem("R3MwebPrefs",JSON.stringify(b)))}function z(){var e=h.getRightOpen();M.publish({event:e?"triptych-hide-panel":"triptych-show-panel",data:"right"}),g.setInfoState(!e),e||X(!0)}function K(){var e=[],t={};return N(e,t),e.filter(e=>!(e&&1===e.length&&t[e[0]]&&"DMUValidationCheck"===t[e[0]].type))}function J(){require(["DS/TransientWidget/TransientWidget"].concat([]),function(e){var t=[],n={};N(t,n),e.showWidget("ENORIPE_AP","",{X3DContentId:JSON.stringify(_(t,n))},{mode:"panel",width:700,height:800})})}function H(){let e=g.getSelectedRows();if(!e.length)return;let t=[];return e.forEach(e=>{let n=O[e.id],i=n&&-1!==l.getRvwTypes().concat(l.getIsrTypes()).indexOf(n.type)&&n.id;i&&t.push({physicalid:i,tenant:d.getPlatformId()})}),t}function G(){require(["DS/MaturityWidget/MaturityWidget"].concat([]),function(e){m&&m.dialog&&m.dialog.destroy(),(m=new e({externalSettings:d.getPlatformIdServices()})).addEvent("onMaturityCanceled",()=>{m=null}),m.addEvent("onMaturityTransitionEnd",e=>{if(!e||!e.data)return;let t={},n=[];e.data.forEach(e=>{let i=O[e.physicalid];if(!i)return;i.maturityDisp=l.getMaturityNlsValue(i.maturity="VPLM_SMB_Evaluation."+e.tostate);let a=e.tostate.toLowerCase();"released"===a&&!b.released||"obsolete"===a&&!b.obsolete?n.push(e.physicalid):t[e.physicalid]=i}),g.updateValidations(t),g.removeValidation(n)}),m.executeCmd(H(),{context:{getSecurityContext:()=>({SecurityContext:d.getSecurityContext()})}},()=>{})})}function Q(e){l.getFeatureStateInfo(e).then(t=>{let n=O[e.validatedObjId];if(n.children[e.text]&&n.children[e.text].children){let i=n.children[e.text].children[e.objectId];if(i){i.dateCreat=t.result[0].grid["ds6w:created"],i.dateModif=t.result[0].grid["ds6w:modified"],i.icon=t.result[0].icon,i.ownerid=t.result[0].grid.owner,i.owner=t.result[0].grid["ds6w:responsible"],i.title=t.result[0]["ds6w:label"],i.type=t.result[0].type;let e={};e[i.id]=i,g.updateValidations(e,!1,!0)}}})}function Y(e){function t(e,t,n,i){e.analysisState=t,e.analysisStateDisp=l.getAnalysisStateNlsValue(t),e.analysisStateNbKO=n;let a={};W(e),a[e.id]=e,g.updateValidations(a,i)}let n=O[e[0]];if(n&&0===n.executionState)return void t(n,"notcomputed",0);function i(e){let t=T.pending.indexOf(e);if(t>-1&&T.pending.splice(t,1),-1===(t=T.completed.indexOf(e))&&T.completed.push(e),(t=T.running.indexOf(e))>-1&&T.running.splice(t,1),T.pending.length>0){let e=T.running.length;T.pending.forEach(function(t){(0===T.running.length||T.running.length>0&&T.running.indexOf(t))&&(Y([t]),e+=1)})}}function a(e,t,n){let i=O[e];if(i){i.analysisStateProgress=Math.ceil(n/t*100);let e={};e[i.id]=i,g.updateValidations(e,!1)}}function r(e){let n="error",a=0;if("timeout"===e.status)i(e.simIds[0]);else if("failure"!==e.status&&Array.isArray(e.output))e.output.forEach(function(e){let i=e.nbTotalItf,r=e.nbOK,s=e.nbKO,o=e.nbTotalItf-(e.nbKO+e.nbOK),l=e.simPid;"0"===e.ExecStatus?n="notcomputed":r===i?n="donenoko":o&&s?(n="startedwithko",a=s):o&&0===s&&r?n="startednoko":o&&0===s&&0===r?(n="computed",a=i):i===s+r?(n="donewithko",a=s):n="startednoko",O[l]&&O[l].analysisState!==n&&(t(O[l],n,a),g.updateStatusBar(O[l].id,"success"))}),i(e.output[0].simPid);else{let r=e.simIds?e.simIds[0]:"";O[r]&&O[r].analysisState!==n&&(t(O[r],n,a),g.updateStatusBar(O[r].id,"failure")),i(e.simIds[0])}}let s=e[0];for(-1===T.all.indexOf(s)&&T.all.push(s),-1===T.pending.indexOf(s)&&T.pending.push(s);T.running.length<4&&-1===T.running.indexOf(s);){let e=O[s];if(!e)return;let n=l.getIsrTypes(),i=e.type;n.indexOf(i)>-1&&("unknown"===e.analysisState&&t(e,"running",0,!0),-1===T.running.indexOf(s)&&(T.running.push(s),l.evalAnalysisStatus(e,r,a)))}}function Z(){let e=g.getSelectedRows();if(1!==e.length)return;let t=[];return e.forEach(e=>{let n=O[e.id],i=n&&(-1!==l.getRvwTypes().indexOf(n.type)||-1!==l.getIsrTypes().indexOf(n.type))&&n.id;if(!i)return;let a=n.validState;a="Failed"===a?"failed":"Passed"===a?"passed":"inProgress";let r=-1!==l.getIsrTypes().indexOf(n.type);t.push({title:n.title,physicalid:i,status:a,isrType:r})}),t}function $(e,t){let n=O[e];return n.validState="passed"===t?"Passed":"failed"===t?"Failed":"InProgress",n.validStateDisp=l.getValidStateNlsValue(n.validState),W(n),n}function ee(){require(["DS/CATWebUXCVS/CATWebUXCVSComponent"].concat([]),function(e){w&&w.clean(),w=null;let t=Z();t&&1===t.length&&(t=t[0],w=new e({title:t.title,physicalId:t.physicalid,current:t.status,isrType:t.isrType,parent:I,platformSettings:d.getPlatformIdServices(),tenant:d.getPlatformId(),securityContext:{getSecurityContext:()=>({SecurityContext:d.getSecurityContext()})},onChangeValidationStateCompleted:function(e){if(w&&w.clean(),w=null,!e)return;let n=$(t.physicalid,e.sValidationState);n&&g.updateValidations({[t.physicalid]:n})},onChangeValidationStateClose:function(){w&&w.clean(),w=null},onChangeValidationStateFailure:function(){w&&w.clean(),w=null}}))})}b=t.extend(t.clone(k,!0),JSON.parse(localStorage.getItem("R3MwebPrefs")||"{}")),U(),d.onTenantModified(e=>{D||(D=!0,g.removeAll(),e.then(()=>{D=!1,A()}))}),l.onTenantModified(()=>{l.getColumnsNls().then(g.onTenantModified)}),d.getWidget().addEvent("onRefresh",()=>!D&&A()),this.buildUX=function(){return h?Promise.resolve():new Promise(function(e){var n=t.createElement("div",{class:"r3mMainView",styles:{width:"100%",height:"100%"}}),o=t.createElement("div",{class:"r3mRightView"});function c(e){e.stopPropagation()}function u(e,t){if(!g||!t)return!1;var n={protocol:"3DXContent",version:"1.1",data:{items:[]},source:d.getWidgetAppId(),widgetId:d.getWidgetId()},i=[],a={};return N(i,a),F(n.data.items,i,a),e.dataTransfer.setData("Text",JSON.stringify(n)),!1}o.style.height="100%",(h=new a).init({withtransition:!0,container:this,right:{withClose:!1},modelEvents:M},null,n,o),l.getColumnsNls().then(t=>{(g=new i({parent:n,onSelect:L,onUnselect:q,getFilterValues:function(){return Object.assign({},b)},getIsrTypes:function(){return l.getIsrTypes()},getFeatureStateInfo:Q,onFiltersModified:B,onInfo:z,allowRelations:K,onRelations:J,allowMaturityState:H,onMaturityState:G,onAnalysisState:Y,allowValidationState:Z,onValidationState:ee,columns:t,cbDnD:{onDragStartCell:u,onDragOverCell:c,onDragEnterBlank:c,onDragOverBlank:c,onDragStartRowHeader:u,onDragOverRowHeader:c}}))&&g.checkFilterAndFetchValue(),(S=new r({className:"r3mProperties",setEditButton:!0,readOnly:!1,setCloseButton:!0,typeOfDisplay:s.ALL,displayType:s.STANDARD,selectionType:s.NO_SELECTION,multiselection:s.MULTISEL_STD,collapseTabs:!1,actions:[{name:"closeSidePanel",text:p.closeSidePanel,icon:"close",handler:function(){M.publish({event:"triptych-hide-panel"}),g.setInfoState(!1)}}]}).inject(o)).initDatas([]);let a=require("DS/DMUwebR3Mutils/DMUwebR3MwidgetUtils"),d={requestUtils:{get3DSpaceUrl:a.get3DSpaceUrl,getPlatformId:a.getPlatformId,getSecurityContext:a.getSecurityContext,getLang:a.getLang},onFacetModification:function(e){let t=[];Object.keys(e||{}).forEach(function(e){let n=E[e];n&&Object.keys(this[e]||{}).forEach(function(i){let a;"sValidationState"===i?(a=!0,$(e,this[i])):"iCheckState"===i?(a=!0,l.updateCheckStateValue(this[i],n)):"title"!==i&&"description"!==i||(a=!0,n[i]=this[i]),a&&-1===t.indexOf(e)&&t.push(e)},this[e])},e);let n={};t.forEach(e=>{R(e).forEach(e=>{n[e]||(n[e]=O[e])})}),g.updateValidations(n)}};S.addFacets([{position:1,require:"DS/PIMwebPropertiesTabs/PIMwebIsrPropContextTab",supportMerge:!0,options:d,facet:{name:"interference_context",text:p.context,icon:"6w-what"}},{position:2,require:"DS/PIMwebPropertiesTabs/PIMwebIsrPropSpecTab",supportMerge:!0,options:d,facet:{name:"interference_specification",text:p.specifications,icon:"6w-how"}},{position:1,require:"DS/DMUReviewFacets/DMUwebR3MinfoRvwCheckTab",supportMerge:!0,options:d,facet:{name:"review_check",text:p.checks,icon:"check-review"}},{position:2,require:"DS/DMUReviewFacets/DMUwebR3MinfoRvwHighlightTab",supportMerge:!0,options:d,facet:{name:"review_highlight",text:p.highlights,icon:"highlight-review"}}]),e()})}.bind(this))}.bind(I),this.refresh=A,this.destroy=function(){window.console.error("TODO!!")}}}),g=[],S=function(e){return e&&e.id?(g.some(function(n){return n.id===e.id&&(t=n.enveloppe)}),t):null;var t};return Object.freeze({giveCtrl:function(e){return S(e)},getCtrl:function(e){if(!e||!e.id)return null;var t=S(e);if(!t){var n=new h({parent:e.parent}),i={buildUX:function(){return n?n.buildUX.apply(null,arguments):null},refresh:function(){return n?n.refresh.apply(null,arguments):null},destroy:function(){n&&(n.destroy.apply(null,arguments),n=null,g.some(function(e,t){if(e.enveloppe===i)return g.splice(t,1),i=null,!0}))}};Object.freeze(i),g.push({id:e.id,enveloppe:i}),t=i}return t}})});