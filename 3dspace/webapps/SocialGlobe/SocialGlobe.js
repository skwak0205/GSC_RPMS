define("DS/SocialGlobe/Globals",["DS/Visualization/ThreeJS_DS","UWA/Utils/Client","DS/Visualization/Detector","DS/WebappsUtils/WebappsUtils","UWA/Promise","DS/WAFData/WAFData","i18n!DS/SocialGlobe/assets/nls/GlobeViewer"],function(e,t,i,o,s,n,r){"use strict";var a={path:"./",defaultTheme:"satellite",theme:void 0,sendMessage:void 0};return a.defaultMaterial=new e.MeshLambertMaterial({color:16777215}),a.tilespath=o.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/satellite/tiles/"),a.tileExtension=".basis",a.localTilesMaxLevel=7,a.countries=null,a.downloadWithCors=function(e,t){var i=!0;for(var o in a.credentials)-1!==e.indexOf(o)&&(i=a.credentials[o]);return UWA.Data.request(e,{cors:i,async:!0,onComplete:t})},a.latlonToXYZ=function(t,i,o){var s,n,r,a=1;return o&&o>0&&(a=1+o/6371e3),s=a*Math.cos(-t*Math.PI/180)*Math.cos(-i*Math.PI/180),n=-a*Math.sin(-t*Math.PI/180),r=a*Math.cos(-t*Math.PI/180)*Math.sin(-i*Math.PI/180),new e.Vector3(s,n,r)},a.XYZToLatlon=function(t){var i,o=new e.Vector3(t.x,0,t.z);return o.normalize(),0,i=180*(o.z>0?-1:1)*Math.acos(o.x)/Math.PI,{lat:-180*Math.asin(-t.y)/Math.PI,lon:i}},a.tile2lon=function(e,t){return t/Math.pow(2,e)*360-180},a.tile2lat=function(e,t){var i=Math.PI-2*Math.PI*t/Math.pow(2,e);return 180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))},a.lon2tileFlt=function(e,t){return(e+180)/360*Math.pow(2,t)},a.lat2tileFlt=function(e,t){return(1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,t)},a.loadTextureCube=function(t,i){var s=[o.getWebappsAssetUrl("SocialGlobe","textures/")+t+"_E."+i,o.getWebappsAssetUrl("SocialGlobe","textures/")+t+"_W."+i,o.getWebappsAssetUrl("SocialGlobe","textures/")+t+"_N."+i,o.getWebappsAssetUrl("SocialGlobe","textures/")+t+"_S."+i,o.getWebappsAssetUrl("SocialGlobe","textures/")+t+"_F."+i,o.getWebappsAssetUrl("SocialGlobe","textures/")+t+"_B."+i];return e.ImageUtils.crossOrigin="use-credentials",e.ImageUtils.loadTextureCube(s)},a.toHex=function(e){return e=parseInt(255*e,10),isNaN(e)?"00":(e=Math.max(0,Math.min(e,255)),"0123456789ABCDEF".charAt((e-e%16)/16)+"0123456789ABCDEF".charAt(e%16))},a.rgbToHtml=function(e){return e?"#"+a.toHex(e[0])+a.toHex(e[1])+a.toHex(e[2]):"#FFFFFF"},a.htmlToRGB=function(e){return[parseInt(e.substring(1,3),16)/255,parseInt(e.substring(3,5),16)/255,parseInt(e.substring(5,7),16)/255]},a.convertColorCode=function(e){var t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c","indigo ":"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return void 0!==t[e.toLowerCase()]?t[e.toLowerCase()]:e},a.isBrowserSupported=function(){return i.webgl},a.buttonStyle={"font-family":'"3dsweblight",Helvetica,Arial,sans-serif',color:"#77797c","font-size":"1em","font-weight":"normal","white-space":"nowrap",padding:".625em 1em",border:"1px solid #b4b6ba","-webkit-box-shadow":"none","-moz-box-shadow":"none","-o-box-shadow":"none","-ms-box-shadow":"none","box-shadow":"none",cursor:"pointer",zIndex:"51000"},a.createCurvePath=function(t,i,o,s){var n=void 0!==t[2]?t[2]:10,r=void 0!==i[2]?t[2]:10,l=(n+r)/2+o,h=a.latlonToXYZ(t[1],t[0],n),c=a.latlonToXYZ(i[1],i[0],r),d=a.latlonToXYZ((t[1]+i[1])/2,(t[0]+i[0])/2,l);null!==s&&s&&(h=a.latlonToXYZ(t[0],t[1],n),c=a.latlonToXYZ(i[0],i[1],r),d=a.latlonToXYZ((t[0]+i[0])/2,(t[1]+i[1])/2,l));var u=new e.QuadraticBezierCurve3(h,d,c),g=new e.CurvePath;return g.add(u),g},a.isCountriesLoaded=function(){return!(null===a.countries)},a.loadCountries=function(){return new s(function(e,t){if(a.countries)e(a.countries);else{var i=o.getWebappsAssetUrl("SocialGlobe","data/countries-light-properties.geojson"),s={method:"GET",type:"json",onComplete:function(t){if(t&&t.features){var i=[];a.countries={};for(var o=0;o<t.features.length;o++){var s=t.features[o];s&&s.properties&&s.properties.ISO3&&-1===i.indexOf(s.properties.ISO3)&&(a.countries[s.properties.ISO3]=r.get("GlobeViewer.Countries.ISO3."+s.properties.ISO3),i.push(s.properties.ISO3))}}e(a.countries)},onFailure:t};n.authenticatedRequest(i,s)}})},a}),define("DS/SocialGlobe/Disposer",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D"],function(e,t,i){return e.SceneGraphUtils={traverseV6:function(t,i,o){if(!0===o(t,i))for(var s=0,n=t.children.length;s<n;s++)t.children[s]!=t&&e.SceneGraphUtils.traverseV6(t.children[s],i,o)},dispose:function(o,s,n){if(!o)return console.error("Error in disposer: element null"),!1;if(o instanceof Array)for(var r=0;r<o.length;r++)this.dispose(o[r],s,n);if(o.observers)for(var a=o.observers.length;a--;)o.observers[a](o);if(!0!==s&&void 0!==o.shared&&o.shared>0)return!1;var l=!1;if(o instanceof e.Texture||o instanceof e.DataTexture)o.dispatchEvent({type:"dispose"}),o.img=null;else if(o instanceof i){var h=o.mesh3js;void 0!==h.material&&this.dispose(h.material,s),void 0!==h.geometry&&this.dispose(h.geometry,s)}else o.dispose&&(o.dispose(),void 0!==o.needsUpdate&&(o.needsUpdate=!0));return o instanceof t&&(l=!0),l},disposeV6:function(e,t){this.traverseV6(e,t,this.dispose.bind(this))}},e.SceneGraphUtils}),define("DS/SocialGlobe/PlanarQuadTree",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=function(e,t,i,o){this.levelMax=0,this.base={I:0,J:0},this.P={X:0,Y:0},this.levelMin=e,this.leafOnly=t,this.earlyCulled=0,this.horizonCulled=0,this.circular=!1,this.quads=[{LOD:0,I:0,J:0,X:0,Y:0,Size:1,Stitching_North:!1,Stitching_West:!1,Stitching_South:!1,Stitching_East:!1}],this.cropBox=i,this.cropIJBox={},this.lod=2,this.isCircular=o};return t.prototype={build:function(e,t,i,o){var s,n,r,a,l,h,c,d=this.getBaseIJ(t,i,o);this.P={X:i,Y:o},this.base=d,this.quads.length=0,this.earlyCulled=0,this.horizonCulled=0;for(var u,g=1,p=0,m=1,f=0;t>=this.levelMin;){d=this.getBaseIJ(t,i,o),0,c=(u=1<<t)-1,m<f&&(m===c&&(m-=c,f-=c),0===f&&(m+=c,f+=c)),this.leafOnly?d.J=Math.min(Math.max(d.J,2),c-3):d.J=Math.min(Math.max(d.J,1),c-1),l=(l=d.I-Math.min(2,Math.floor(c/2)))%2!=0?l-1:l,this.isCircular||(l=Math.max(l,0)),h=(h=d.I+Math.min(2,Math.floor(c/2)))%2==0?h+1:h,h=this.isCircular?Math.min(h,l+c):Math.min(h,c);var v=void 0,b=void 0;if(b=this.leafOnly?(v=Math.max(d.J-2,0))+5:(v=Math.max(d.J-this.lod,0))+2*this.lod+1,b=Math.min(b,c),void 0!==this.cropBox){this.cropBox.getIJBox(t,this.cropIJBox);var w=Math.max(l,this.cropIJBox.IMin),y=Math.min(h,this.cropIJBox.IMax),M=Math.max(v,this.cropIJBox.JMin),S=Math.min(b,this.cropIJBox.JMax)}for(r=l;r<=h;r+=1)for(a=v;a<=b;a+=1)s=(r+u)%u,n=a,void 0!==this.cropBox&&(s<w||n<M||s>y||n>S)||this.leafOnly&&r>=m&&r<=f&&a>=g&&a<=p||this.addQuad(t,s,n,a===b,r===l,a===v,r===h,Math.abs(s-d.I)+Math.abs(n-d.J),void 0!==this.cropBox&&(s===w||n===M||s===y||n===S));1,2,t-=1,m=Math.floor(l/2),g=Math.floor(v/2),f=Math.floor(h/2),p=Math.floor(b/2)}return!0},getBaseIJ:function(e,t,i){var o=1<<e,s={I:Math.floor(t*o),J:Math.floor(i*o)};return this.leafOnly&&(s.J=2*Math.floor(s.J/2)),s},getXY:function(t,i,o){return new e.Vector2((i+.5)/t,(o+.5)/t)},getXYVector:function(e,t,i,o){o.set((t+.5)/e,(i+.5)/e)},addQuad:function(e,t,i,o,s,n,r,a,l){var h=1/(1<<e);this.quads.push({LOD:e,I:t,J:i,X:t*h,Y:i*h,Size:h,Length:a,Stitching_North:o,Stitching_West:s,Stitching_South:n,Stitching_East:r,intersectCropBox:l})}},t}),define("DS/SocialGlobe/Matrix4d",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t,i,o,s,n,r;e.Matrix4d=function(e,t,i,o,s,n,r,a,l,h,c,d,u,g,p,m){var f=this.elements=new Float64Array(16);f[0]=void 0!==e?e:1,f[4]=t||0,f[8]=i||0,f[12]=o||0,f[1]=s||0,f[5]=void 0!==n?n:1,f[9]=r||0,f[13]=a||0,f[2]=l||0,f[6]=h||0,f[10]=void 0!==c?c:1,f[14]=d||0,f[3]=u||0,f[7]=g||0,f[11]=p||0,f[15]=void 0!==m?m:1},e.Matrix4d.prototype={constructor:e.Matrix4d,set:function(e,t,i,o,s,n,r,a,l,h,c,d,u,g,p,m){var f=this.elements;return f[0]=e,f[4]=t,f[8]=i,f[12]=o,f[1]=s,f[5]=n,f[9]=r,f[13]=a,f[2]=l,f[6]=h,f[10]=c,f[14]=d,f[3]=u,f[7]=g,f[11]=p,f[15]=m,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},copy:function(e){var t=e.elements;return this.set(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]),this},setRotationFromEuler:function(e,t){var i=this.elements,o=e.x,s=e.y,n=e.z,r=Math.cos(o),a=Math.sin(o),l=Math.cos(s),h=Math.sin(s),c=Math.cos(n),d=Math.sin(n);if(void 0===t||"XYZ"===t){var u=r*c,g=r*d,p=a*c,m=a*d;i[0]=l*c,i[4]=-l*d,i[8]=h,i[1]=g+p*h,i[5]=u-m*h,i[9]=-a*l,i[2]=m-u*h,i[6]=p+g*h,i[10]=r*l}else if("YXZ"===t){var f=l*c,v=l*d,b=h*c,w=h*d;i[0]=f+w*a,i[4]=b*a-v,i[8]=r*h,i[1]=r*d,i[5]=r*c,i[9]=-a,i[2]=v*a-b,i[6]=w+f*a,i[10]=r*l}else if("ZXY"===t){f=l*c,v=l*d,b=h*c,w=h*d;i[0]=f-w*a,i[4]=-r*d,i[8]=b+v*a,i[1]=v+b*a,i[5]=r*c,i[9]=w-f*a,i[2]=-r*h,i[6]=a,i[10]=r*l}else if("ZYX"===t){u=r*c,g=r*d,p=a*c,m=a*d;i[0]=l*c,i[4]=p*h-g,i[8]=u*h+m,i[1]=l*d,i[5]=m*h+u,i[9]=g*h-p,i[2]=-h,i[6]=a*l,i[10]=r*l}else if("YZX"===t){var y=r*l,M=r*h,S=a*l,C=a*h;i[0]=l*c,i[4]=C-y*d,i[8]=S*d+M,i[1]=d,i[5]=r*c,i[9]=-a*c,i[2]=-h*c,i[6]=M*d+S,i[10]=y-C*d}else if("XZY"===t){y=r*l,M=r*h,S=a*l,C=a*h;i[0]=l*c,i[4]=-d,i[8]=h*c,i[1]=y*d+C,i[5]=r*c,i[9]=M*d-S,i[2]=S*d-M,i[6]=a*c,i[10]=C*d+y}return this},setRotationFromQuaternion:function(e){var t=this.elements,i=e.x,o=e.y,s=e.z,n=e.w,r=i+i,a=o+o,l=s+s,h=i*r,c=i*a,d=i*l,u=o*a,g=o*l,p=s*l,m=n*r,f=n*a,v=n*l;return t[0]=1-(u+p),t[4]=c-v,t[8]=d+f,t[1]=c+v,t[5]=1-(h+p),t[9]=g-m,t[2]=d-f,t[6]=g+m,t[10]=1-(h+u),this},lookAt:(i=new e.Vector3,o=new e.Vector3,s=new e.Vector3,function(e,t,n){var r=this.elements;return s.subVectors(e,t).normalize(),0===s.length()&&(s.z=1),i.crossVectors(n,s).normalize(),0===i.length()&&(s.x+=1e-4,i.crossVectors(n,s).normalize()),o.crossVectors(s,i),r[0]=i.x,r[4]=o.x,r[8]=s.x,r[1]=i.y,r[5]=o.y,r[9]=s.y,r[2]=i.z,r[6]=o.z,r[10]=s.z,this}),multiply:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Matrix4's .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)},multiplyMatrices:function(e,t){var i=e.elements,o=t.elements,s=this.elements,n=i[0],r=i[4],a=i[8],l=i[12],h=i[1],c=i[5],d=i[9],u=i[13],g=i[2],p=i[6],m=i[10],f=i[14],v=i[3],b=i[7],w=i[11],y=i[15],M=o[0],S=o[4],C=o[8],k=o[12],x=o[1],D=o[5],T=o[9],P=o[13],A=o[2],G=o[6],E=o[10],I=o[14],V=o[3],L=o[7],_=o[11],F=o[15];return s[0]=n*M+r*x+a*A+l*V,s[4]=n*S+r*D+a*G+l*L,s[8]=n*C+r*T+a*E+l*_,s[12]=n*k+r*P+a*I+l*F,s[1]=h*M+c*x+d*A+u*V,s[5]=h*S+c*D+d*G+u*L,s[9]=h*C+c*T+d*E+u*_,s[13]=h*k+c*P+d*I+u*F,s[2]=g*M+p*x+m*A+f*V,s[6]=g*S+p*D+m*G+f*L,s[10]=g*C+p*T+m*E+f*_,s[14]=g*k+p*P+m*I+f*F,s[3]=v*M+b*x+w*A+y*V,s[7]=v*S+b*D+w*G+y*L,s[11]=v*C+b*T+w*E+y*_,s[15]=v*k+b*P+w*I+y*F,this},multiplyToArray:function(e,t,i){var o=this.elements;return this.multiplyMatrices(e,t),i[0]=o[0],i[1]=o[1],i[2]=o[2],i[3]=o[3],i[4]=o[4],i[5]=o[5],i[6]=o[6],i[7]=o[7],i[8]=o[8],i[9]=o[9],i[10]=o[10],i[11]=o[11],i[12]=o[12],i[13]=o[13],i[14]=o[14],i[15]=o[15],this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},multiplyVector3:function(e){return console.warn("DEPRECATED: Matrix4's .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) or vector.applyProjection( matrix ) instead."),e.applyProjection(this)},multiplyVector4:function(e){return console.warn("DEPRECATED: Matrix4's .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector3Array:(t=new e.Vector3,function(e){for(var i=0,o=e.length;i<o;i+=3)t.x=e[i],t.y=e[i+1],t.z=e[i+2],t.applyProjection(this),e[i]=t.x,e[i+1]=t.y,e[i+2]=t.z;return e}),rotateAxis:function(e){console.warn("DEPRECATED: Matrix4's .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),e.transformDirection(this)},crossVector:function(t){var i=this.elements,o=new e.Vector4;return o.x=i[0]*t.x+i[4]*t.y+i[8]*t.z+i[12]*t.w,o.y=i[1]*t.x+i[5]*t.y+i[9]*t.z+i[13]*t.w,o.z=i[2]*t.x+i[6]*t.y+i[10]*t.z+i[14]*t.w,o.w=t.w?i[3]*t.x+i[7]*t.y+i[11]*t.z+i[15]*t.w:1,o},determinant:function(){var e=this.elements,t=e[0],i=e[4],o=e[8],s=e[12],n=e[1],r=e[5],a=e[9],l=e[13],h=e[2],c=e[6],d=e[10],u=e[14];return e[3]*(+s*a*c-o*l*c-s*r*d+i*l*d+o*r*u-i*a*u)+e[7]*(+t*a*u-t*l*d+s*n*d-o*n*u+o*l*h-s*a*h)+e[11]*(+t*l*c-t*r*u-s*n*c+i*n*u+s*r*h-i*l*h)+e[15]*(-o*r*h-t*a*c+t*r*d+o*n*c-i*n*d+i*a*h)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},flattenToArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},flattenToArrayOffset:function(e,t){var i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e},getPosition:function(){var t=new e.Vector3;return function(){console.warn("DEPRECATED: Matrix4's .getPosition() has been removed. Use Vector3.getPositionFromMatrix( matrix ) instead.");var e=this.elements;return t.set(e[12],e[13],e[14])}}(),setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getInverse:function(e,t){var i=this.elements,o=e.elements,s=o[0],n=o[4],r=o[8],a=o[12],l=o[1],h=o[5],c=o[9],d=o[13],u=o[2],g=o[6],p=o[10],m=o[14],f=o[3],v=o[7],b=o[11],w=o[15];i[0]=c*m*v-d*p*v+d*g*b-h*m*b-c*g*w+h*p*w,i[4]=a*p*v-r*m*v-a*g*b+n*m*b+r*g*w-n*p*w,i[8]=r*d*v-a*c*v+a*h*b-n*d*b-r*h*w+n*c*w,i[12]=a*c*g-r*d*g-a*h*p+n*d*p+r*h*m-n*c*m,i[1]=d*p*f-c*m*f-d*u*b+l*m*b+c*u*w-l*p*w,i[5]=r*m*f-a*p*f+a*u*b-s*m*b-r*u*w+s*p*w,i[9]=a*c*f-r*d*f-a*l*b+s*d*b+r*l*w-s*c*w,i[13]=r*d*u-a*c*u+a*l*p-s*d*p-r*l*m+s*c*m,i[2]=h*m*f-d*g*f+d*u*v-l*m*v-h*u*w+l*g*w,i[6]=a*g*f-n*m*f-a*u*v+s*m*v+n*u*w-s*g*w,i[10]=n*d*f-a*h*f+a*l*v-s*d*v-n*l*w+s*h*w,i[14]=a*h*u-n*d*u-a*l*g+s*d*g+n*l*m-s*h*m,i[3]=c*g*f-h*p*f-c*u*v+l*p*v+h*u*b-l*g*b,i[7]=n*p*f-r*g*f+r*u*v-s*p*v-n*u*b+s*g*b,i[11]=r*h*f-n*c*f-r*l*v+s*c*v+n*l*b-s*h*b,i[15]=n*c*u-r*h*u+r*l*g-s*c*g-n*l*p+s*h*p;var y=o[0]*i[0]+o[1]*i[4]+o[2]*i[8]+o[3]*i[12];if(0==y){var M="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(M);return console.warn(M),this.identity(),this}return this.multiplyScalar(1/y),this},extractPosition:function(e){var t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this},extractRotation:function(){var t=new e.Vector3;return function(e){var i=this.elements,o=e.elements,s=1/t.set(o[0],o[1],o[2]).length(),n=1/t.set(o[4],o[5],o[6]).length(),r=1/t.set(o[8],o[9],o[10]).length();return i[0]=o[0]*s,i[1]=o[1]*s,i[2]=o[2]*s,i[4]=o[4]*n,i[5]=o[5]*n,i[6]=o[6]*n,i[8]=o[8]*r,i[9]=o[9]*r,i[10]=o[10]*r,this}}(),translate:function(e){var t=this.elements,i=e.x,o=e.y,s=e.z;return t[12]=t[0]*i+t[4]*o+t[8]*s+t[12],t[13]=t[1]*i+t[5]*o+t[9]*s+t[13],t[14]=t[2]*i+t[6]*o+t[10]*s+t[14],t[15]=t[3]*i+t[7]*o+t[11]*s+t[15],this},rotateX:function(e){var t=this.elements,i=t[4],o=t[5],s=t[6],n=t[7],r=t[8],a=t[9],l=t[10],h=t[11],c=Math.cos(e),d=Math.sin(e);return t[4]=c*i+d*r,t[5]=c*o+d*a,t[6]=c*s+d*l,t[7]=c*n+d*h,t[8]=c*r-d*i,t[9]=c*a-d*o,t[10]=c*l-d*s,t[11]=c*h-d*n,this},rotateY:function(e){var t=this.elements,i=t[0],o=t[1],s=t[2],n=t[3],r=t[8],a=t[9],l=t[10],h=t[11],c=Math.cos(e),d=Math.sin(e);return t[0]=c*i-d*r,t[1]=c*o-d*a,t[2]=c*s-d*l,t[3]=c*n-d*h,t[8]=c*r+d*i,t[9]=c*a+d*o,t[10]=c*l+d*s,t[11]=c*h+d*n,this},rotateZ:function(e){var t=this.elements,i=t[0],o=t[1],s=t[2],n=t[3],r=t[4],a=t[5],l=t[6],h=t[7],c=Math.cos(e),d=Math.sin(e);return t[0]=c*i+d*r,t[1]=c*o+d*a,t[2]=c*s+d*l,t[3]=c*n+d*h,t[4]=c*r-d*i,t[5]=c*a-d*o,t[6]=c*l-d*s,t[7]=c*h-d*n,this},rotateByAxis:function(e,t){var i=this.elements;if(1===e.x&&0===e.y&&0===e.z)return this.rotateX(t);if(0===e.x&&1===e.y&&0===e.z)return this.rotateY(t);if(0===e.x&&0===e.y&&1===e.z)return this.rotateZ(t);var o=e.x,s=e.y,n=e.z,r=Math.sqrt(o*o+s*s+n*n),a=(o/=r)*o,l=(s/=r)*s,h=(n/=r)*n,c=Math.cos(t),d=Math.sin(t),u=1-c,g=o*s*u,p=o*n*u,m=s*n*u,f=o*d,v=s*d,b=n*d,w=a+(1-a)*c,y=g+b,M=p-v,S=g-b,C=l+(1-l)*c,k=m+f,x=p+v,D=m-f,T=h+(1-h)*c,P=i[0],A=i[1],G=i[2],E=i[3],I=i[4],V=i[5],L=i[6],_=i[7],F=i[8],U=i[9],W=i[10],O=i[11];return i[0]=w*P+y*I+M*F,i[1]=w*A+y*V+M*U,i[2]=w*G+y*L+M*W,i[3]=w*E+y*_+M*O,i[4]=S*P+C*I+k*F,i[5]=S*A+C*V+k*U,i[6]=S*G+C*L+k*W,i[7]=S*E+C*_+k*O,i[8]=x*P+D*I+T*F,i[9]=x*A+D*V+T*U,i[10]=x*G+D*L+T*W,i[11]=x*E+D*_+T*O,this},scale:function(e){var t=this.elements,i=e.x,o=e.y,s=e.z;return t[0]*=i,t[4]*=o,t[8]*=s,t[1]*=i,t[5]*=o,t[9]*=s,t[2]*=i,t[6]*=o,t[10]*=s,t[3]*=i,t[7]*=o,t[11]*=s,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],o=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,Math.max(i,o)))},makeTranslation:function(e,t,i){return this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var i=Math.cos(t),o=Math.sin(t),s=1-i,n=e.x,r=e.y,a=e.z,l=s*n,h=s*r;return this.set(l*n+i,l*r-o*a,l*a+o*r,0,l*r+o*a,h*r+i,h*a-o*n,0,l*a-o*r,h*a+o*n,s*a*a+i,0,0,0,0,1),this},makeScale:function(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this},makeFrustum:function(e,t,i,o,s,n){var r=this.elements,a=2*s/(t-e),l=2*s/(o-i),h=(t+e)/(t-e),c=(o+i)/(o-i),d=-(n+s)/(n-s),u=-2*n*s/(n-s);return r[0]=a,r[4]=0,r[8]=h,r[12]=0,r[1]=0,r[5]=l,r[9]=c,r[13]=0,r[2]=0,r[6]=0,r[10]=d,r[14]=u,r[3]=0,r[7]=0,r[11]=-1,r[15]=0,this},makePerspective:function(t,i,o,s){var n=o*Math.tan(e.Math.degToRad(.5*t)),r=-n,a=r*i,l=n*i;return this.makeFrustum(a,l,r,n,o,s)},makeOrthographic:function(e,t,i,o,s,n){var r=this.elements,a=t-e,l=i-o,h=n-s,c=(t+e)/a,d=(i+o)/l,u=(n+s)/h;return r[0]=2/a,r[4]=0,r[8]=0,r[12]=-c,r[1]=0,r[5]=2/l,r[9]=0,r[13]=-d,r[2]=0,r[6]=0,r[10]=-2/h,r[14]=-u,r[3]=0,r[7]=0,r[11]=0,r[15]=1,this},clone:function(){var t=this.elements;return new e.Matrix4d(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15])}},e.extend(e.Matrix4d.prototype,{compose:(n=new e.Matrix4,r=new e.Matrix4,function(e,t,i){var o=this.elements;return n.identity(),n.setRotationFromQuaternion(t),r.makeScale(i.x,i.y,i.z),this.multiplyMatrices(n,r),o[12]=e.x,o[13]=e.y,o[14]=e.z,this}),decompose:function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3,s=new e.Matrix4d;return function(n,r,a){var l=this.elements;return t.set(l[0],l[1],l[2]),i.set(l[4],l[5],l[6]),o.set(l[8],l[9],l[10]),n=n instanceof e.Vector3?n:new e.Vector3,r=r instanceof e.Quaternion?r:new e.Quaternion,(a=a instanceof e.Vector3?a:new e.Vector3).x=t.length(),a.y=i.length(),a.z=o.length(),n.x=l[12],n.y=l[13],n.z=l[14],s.copy(this),s.elements[0]/=a.x,s.elements[1]/=a.x,s.elements[2]/=a.x,s.elements[4]/=a.y,s.elements[5]/=a.y,s.elements[6]/=a.y,s.elements[8]/=a.z,s.elements[9]/=a.z,s.elements[10]/=a.z,r.setFromRotationMatrix(s),[n,r,a]}}()})}),define("DS/SocialGlobe/CmdAdvanced",["UWA/Core","DS/ApplicationFrame/Command"],function(e,t){"use strict";var i=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},beginExecute:function(){this.widget=this.getFrameWindow().globe,this.widget.widget.getValue("tilemapserver")&&""!==this.widget.widget.getValue("tilemapserver")&&this.widget.tmsInput.setValue(this.widget.widget.getValue("tilemapserver")),this.widget.widget.getValue("tileextension")&&""!==this.widget.widget.getValue("tileextension")&&this.widget.tileextensionInput.setValue(this.widget.widget.getValue("tileextension")),this.widget.widget.getValue("tilemapserver-max")&&""!==this.widget.widget.getValue("tilemapserver-max")&&(6!=this.widget.widget.getValue("tilemapserver-max")?this.widget.tmsmaxlevelInput.setValue(this.widget.widget.getValue("tilemapserver-max")):this.widget.tmsmaxlevelInput.setValue("")),this.widget.widget.getValue("cors-exception")&&""!==this.widget.widget.getValue("cors-exception")&&this.widget.corsserverInput.setValue(this.widget.widget.getValue("cors-exception")),this.widget.showAdvancedPanel(!0)},execute:function(){},endExecute:function(){this.widget.showAdvancedPanel(!1)}});return e.namespace("SocialGlobe/CmdAdvanced",i)}),define("DS/SocialGlobe/Renderer",["UWA/Class"],function(e){"use strict";return e.extend({init:function(e){this.renderContext=e},switchToProjection:function(e){},setSwitchProjectionModeCB:function(e){}})}),define("DS/SocialGlobe/RenderPassManager",["UWA/Class","DS/Core/Events","DS/Plugins/ClearPass"],function(e,t,i){"use strict";return e.extend({init:function(e){this._passes={},this._passesID=[],this._mainComposer=e;var t=new i("ClearDepthPass");t.defaults.clear=!1,t.defaults.doClearDepth=!0,this.addPass("ClearDepthPass",t,{post:!0})},addPass:function(e,i,o,s){if(void 0!==i)if(void 0===this._passes[e]){var n;if(void 0!==o)if(void 0!==o.before){if(void 0===(n=this.getPass(o.before))||void 0!==s&&s!==o.before)return void t.subscribeOnce({event:"/RenderPassManager/onNewPassAdded"},this.addPass.bind(this,e,i,o));this._mainComposer.insertCustomPassBefore(i,n)}else if(void 0!==o.after){if(void 0===(n=this.getPass(o.after))||void 0!==s&&s!==o.after)return void t.subscribeOnce({event:"/RenderPassManager/onNewPassAdded"},this.addPass.bind(this,e,i,o));this._mainComposer.insertCustomPassAfterPass(i,n)}else o.pre?this._mainComposer.insertCustomPassBefore(i):this._mainComposer.insertCustomPassAfterPass(i);else this._mainComposer.insertCustomPassAfterPass(i);this._mainComposer.updateComposerContexts(),this._passesID.push(e),this._passes[e]=i,t.publish({event:"/RenderPassManager/onNewPassAdded",data:e})}else console.warn("A pass with ID '"+e+"' is already defined");else console.warn("Undefined pass: '"+e+"'")},enablePass:function(e){var t=this.getPass(e);if(void 0!==t){var i,o=this._mainComposer.contexts.length;for(i=0;i<o;++i)this._mainComposer.contexts[i].enablePass(t,!0)}},disablePass:function(e){var t=this.getPass(e);if(void 0!==t){var i,o=this._mainComposer.contexts.length;for(i=0;i<o;++i)this._mainComposer.contexts[i].enablePass(t,!1)}},getPass:function(e){return this._passes[e]},getPassList:function(){return this._passesID}})}),define("DS/SocialGlobe/CmdDisplayHelp",["UWA/Core","DS/ApplicationFrame/Command"],function(e,t){"use strict";var i=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},beginExecute:function(){this.globe=this.getFrameWindow().globe},execute:function(){window.open("http://apps.uwglobe.com/Docs/GlobeViewer/index.html","_blank"),this.end()},endExecute:function(){}});return UWA.namespace("SocialGlobe/CmdDisplayHelp",i)}),define("DS/SocialGlobe/CmdTheme",["UWA/Core","DS/ApplicationFrame/Command"],function(e,t){"use strict";var i=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},beginExecute:function(){this.widget=this.getFrameWindow().globe,this.widget.showThemePanel(!0),"satellite"===this.widget.widget.getValue("theme")?this.widget.satelliteThemeButton.checkFlag=!0:"minimal"===this.widget.widget.getValue("theme")?this.widget.minimalThemeButton.checkFlag=!0:this.widget.naturalThemeButton.checkFlag=!0,""!==this.widget.widget.getValue("backcolor")&&(this.widget.themecolorPicker.value=this.widget.widget.getValue("backcolor").replace("#",""),this.widget.backgroundcolorButton.checkFlag=!0)},execute:function(){},endExecute:function(){this.widget.widget.getValue("theme");this.widget.showThemePanel(!1)}});return e.namespace("SocialGlobe/CmdTheme",i)}),define("DS/SocialGlobe/PolylineMaker",["UWA/Class"],function(e){"use strict";return e.extend({init:function(e){this.scene=e}})}),define("DS/SocialGlobe/Vector2",["UWA/Class"],function(e){"use strict";var t=e.extend({init:function(e,t){this.x=e,this.y=t},normalize:function(e){var t=Math.sqrt(this.x*this.x+this.y*this.y);return t>e&&(this.x/=t,this.y/=t,!0)}});return t.AB=function(e,i){return new t(i.x-e.x,i.y-e.y)},t.dot=function(e,t){return e.x*t.x+e.y*t.y},t.dist=function(e,t){return Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))},t.isTriangleDirect=function(e,t,i){var o=t.x-e.x,s=t.y-e.y,n=i.x-e.x;return o*(i.y-e.y)-s*n>=0},t.isLoopClockwise=function(e){var t,i,o=0,s=0;for(s=0;s<e.length;s++)t=e[s],o+=((i=e[(s+1)%e.length]).x-t.x)*(i.y+t.y);return o>=0},t.toClockwise=function(e,t){return t!==this.isLoopClockwise(e)?e.reverse():e},t.lineIntersect=function(e,t,i,o){var s,n,r=(t.x-e.x)*(o.y-i.y)-(t.y-e.y)*(o.x-i.x);return!(Math.abs(r)<1e-8)&&(s=((e.y-i.y)*(o.x-i.x)-(e.x-i.x)*(o.y-i.y))/r,n=((e.y-i.y)*(t.x-e.x)-(e.x-i.x)*(t.y-e.y))/r,s<=1&&s>=0&&n<=1&&n>=0)},t}),define("DS/SocialGlobe/OffscreenCanvas2DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils"],function(e,t,i,o){"use strict";var s=t.extend({init:function(t,i){this._parent(t.name),this.hotspot=t.hotspot||new e.Vector2(0,0),this.canvasNodeTexture=t.canvasNodeTexture;var o=this.canvasNodeTexture._getCanvas2DTexture(),n=new e.MeshBasicMaterial({transparent:!0,side:e.DoubleSide,depthTest:!1,force:!0});this.canvas2DMaterial=n,n.activatePDSFX();var r={hotspot:{type:"v2",value:this.hotspot},pixelSize:{type:"v2",value:new e.Vector2(.005,.005)},size:{type:"v2",value:new e.Vector2(this.canvasNodeTexture.width,this.canvasNodeTexture.height)},canvas2DTexture:{type:"t2",value:o},highlight:{type:"b",value:!1,stage:e.FragmentStage},angle:{type:"f",value:t.angle||0}};n.setPDSFXUniforms(r);n.setPDSFXVaryings({_uv:{type:"v2"},screenPosition:{type:"v2"}});var a={ProcessClipSpacePosition:["void ProcessClipSpacePosition(inout vec4 ioPosition) { ","  _uv = vGetAttribTexCoord0().xy;","  float dx, dy;","  dx = ioPosition.w * (pixelSize.x*(-hotspot.x + _uv.x*size.x));","  dy = ioPosition.w * (pixelSize.y*(-hotspot.y + _uv.y*size.y));;","  float ratio = pixelSize.x / pixelSize.y;","  ioPosition.x += cos(angle)*dx - sin(angle)*dy*ratio;","  ioPosition.y += sin(angle)*dx/ratio + cos(angle)*dy;","}"].join("\n")},l={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = ioFinalColor * texture2D(canvas2DTexture, _uv);","if (highlight) {","  float norm = length(ioFinalColor.xyz);","  ioFinalColor.xyz = (norm/1.73205)*vec3(0.0, 0.6, 1.0);","}","}"].join("\n")};n.setPDSFXOverridableFunctions(a,l),this.rectangle=s._createRectangle(n,i);this.rectangle._occurrences[0].renderable;n._refreshPDSFXUniforms_private=function(t,i){var o;if(!t._smallTargetPicking||t.materialToUse!==e.MaterialToUse.pickingMaterial&&t.materialToUse!==e.MaterialToUse.pickingMaterialInstancing&&t.materialToUse!==e.MaterialToUse.normalMaterial&&t.materialToUse!==e.MaterialToUse.depthMaterial)o=new e.Vector2(2/t.domElement.width,2/t.domElement.height);else{var s=2*t._gpuPickingTolerance+1;o=new e.Vector2(2/s,2/s)}if(this.updatePDSFXUniform("pixelSize",o),window.activateCanvas2DSuperHighlight){var n=i._occurrence.node._occurrences.length>1;this.updatePDSFXUniform("highlight",!(n||!i.highlight))}},this.rectangle.setFrustumCulled(!1),this.rectangle.setMirror(!1),this.rectangle.setShadow(!1,!1),this.addChild(this.rectangle),this.rectangle.setRenderPasses(["canvas2D"]),this.exludeFromBounding(!0);var h=this;return this.rectangle._setBeforeRenderCB(function(e,t){o.redrawRequested&&h.canvasNodeTexture._redrawCanvas2DTexture()}),this},excludeFromHighlight:function(e,t){this.rectangle.excludeFromHighlight(e,t)},setHotspot:function(e){e&&this.canvas2DMaterial.updatePDSFXUniform("hotspot",e.clone())},getHotspot:function(){return this.canvas2DMaterial.getPDSFXUniform("hotspot").value.clone()},setAngle:function(e){this.canvas2DMaterial.updatePDSFXUniform("angle",e)},getAngle:function(){return this.canvas2DMaterial.getPDSFXUniform("angle").value}});return s._createRectangle=function(e,t){var i,s,n,r,a,l,h,c,d,u,g,p,m,f,v;for(10,(i=new o.PrimitiveGroup).fillAttr=new o.FillAttributes,i.lineAttr=new o.LineAttributes,i.pointAttr=new o.PointAttributes,(s=new o.Buffer).size=12,s.component=o.VertexComponentEnum.POSITION,s.format=o.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(s.size),(n=new o.Buffer).size=3,n.component=o.VertexComponentEnum.NORMAL,n.format=o.DataTypeEnum.FLOAT,n.dimension=3,n.data=new Float32Array(n.size),(r=new o.Buffer).size=12,r.component=o.VertexComponentEnum.TEX_COORD_0,r.format=o.DataTypeEnum.FLOAT,r.dimension=3,r.data=new Float32Array(r.size),(a=new o.Buffer).indexBuffer=!0,a.size=4,a.format=o.DataTypeEnum.UINT,a.dimension=1,a.data=new Uint16Array(a.size),(l=new o.Buffer).indexBuffer=!0,l.size=4,l.format=o.DataTypeEnum.UINT,l.dimension=1,l.data=new Uint16Array(l.size),(h=new o.Buffer).indexBuffer=!0,h.size=4,h.format=o.DataTypeEnum.UINT,h.dimension=1,h.data=new Uint16Array(h.size),i.addBuffer(0,s),i.addBuffer(1,n),i.addBuffer(2,a),i.addBuffer(3,l),i.addBuffer(4,r),i.addBuffer(5,h),m=0,(v=a.data)[m++]=0,v[m++]=1,v[m++]=3,v[m++]=2,v=l.data,m=0,f=0;f<1;f++)v[m++]=f,v[m++]=f,v[m++]=f,v[m++]=f;for(m=0,(v=h.data)[m++]=0,v[m++]=1,v[m++]=3,v[m++]=2,v=s.data,m=0,m=0;m<12;m++)v[m]=0;for(m=0,(v=n.data)[m++]=0,v[m++]=0,v[m++]=1,m=0,(v=r.data)[m++]=0,v[m++]=0,v[m++]=0,v[m++]=1,v[m++]=0,v[m++]=0,v[m++]=1,v[m++]=1,v[m++]=0,v[m++]=0,v[m++]=1,v[m++]=0,f=0;f<1;f++)(c=new o.Primitive).nbIndices=4,c.connectivity=o.ConnectivityTypeEnum.TRIANGLE_STRIP,c.attr={fill:new o.FillAttributes(new o.Color(1-f/6,0,f/6,1),1),line:new o.LineAttributes,point:new o.PointAttributes},(d=new o.VertexComponent).component=o.VertexComponentEnum.POSITION,d.nbVertices=4,d.nbValuesPerVertex=3,d.format=o.DataTypeEnum.FLOAT,d.cardinality=0,d.bufferId=0,d.indices=new o.IndexArray,d.indices.format=o.DataTypeEnum.UINT,d.indices.bufferId=2,d.indices.offset=4*f,(u=new o.VertexComponent).component=o.VertexComponentEnum.NORMAL,u.nbVertices=4,u.nbValuesPerVertex=3,u.format=o.DataTypeEnum.FLOAT,u.cardinality=0,u.bufferId=1,u.indices=new o.IndexArray,u.indices.format=o.DataTypeEnum.UINT,u.indices.bufferId=3,u.indices.offset=4*f,(g=new o.VertexComponent).component=o.VertexComponentEnum.TEX_COORD_0,g.nbVertices=4,g.nbValuesPerVertex=3,g.format=o.DataTypeEnum.FLOAT,g.cardinality=0,g.bufferId=4,g.indices=new o.IndexArray,g.indices.format=o.DataTypeEnum.UINT,g.indices.bufferId=5,g.indices.offset=0,c.addVertexComponent(d),c.addVertexComponent(u),c.addVertexComponent(g),i.addPrimitive(c);return(p=t.createMeshNode(i,e)).setShadow(!1),p},s}),define("DS/SocialGlobe/GlobeNotifications",["UWA/Core","DS/WebappsUtils/Console","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen"],function(e,t,i,o){"use strict";var s={notificationsManager:null,handleSuccess:function(e,t){s.display({level:"success",title:e,subtitle:t})},handleError:function(t,i,o){var n={};n.subtitle=i,n.title=t,n.message="";var r=e.typeOf(o);"error"===r?n.message=o.message:"object"===r&&o.response&&(n.message=e.is(o.response,"string")?o.response:o.response.data),s.display({level:"error",title:n.title,subtitle:n.subtitle,message:n.message})},display:function(n){if(null===s.notificationsManager&&(s.notificationsManager=i,o.setNotificationManager(s.notificationsManager),o.setStackingPolicy(9)),!e.is(n.level,"string")||"success"!==n.level&&"error"!==n.level&&"warning"!==n.level&&"info"!==n.level)throw new Error("Invalid input argument in options.level (GlobeNotifications.display).");if(!e.is(n.title,"string")||!e.is(n.subtitle,"string")||""===n.title||""===n.subtitle)throw new Error("Invalid input argument in options.[sub]title (GlobeNotifications.display).");if(n.message&&(!e.is(n.message,"string")||""===n.message))throw new Error("Invalid input argument in options.message (GlobeNotifications.display).");"error"===n.level&&t.error("Globe Viewer Error: "+n.message);var r={level:n.level,title:n.title,subtitle:n.subtitle,message:n.message?n.message:"",sticky:"error"===n.level,action:n.action,category:"3DXCity"};s.notificationsManager.addNotif(r)},clearAll:function(){o.removeNotifications()},displayWithAction:function(t){if(null===s.notificationsManager&&(s.notificationsManager=i,o.setNotificationManager(s.notificationsManager),o.setStackingPolicy(0)),!e.is(t.level,"string")||"success"!==t.level&&"error"!==t.level&&"warning"!==t.level&&"info"!==t.level)throw new Error("Invalid input argument in options.level (GlobeNotifications.display).");if(!e.is(t.title,"string")||""===t.title)throw new Error("Invalid input argument in options.[sub]title (GlobeNotifications.display).");if(!e.is(t.action,"object")||t.action==={})throw new Error("Invalid input argument in options.[sub]title (GlobeNotifications.display).");var n={level:t.level,title:t.title,action:t.action,sticky:!0,category:"3DXCity"};s.notificationsManager.addNotif(n)}};return s}),define("DS/SocialGlobe/Utils",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","UWA/Data"],function(e,t){"use strict";var i=null;function o(){if(null!==i)throw new Error("Cannot instantiate more than one MySingleton, use MySingleton.getInstance()");this.initialize()}return o.prototype={initialize:function(){window.Utils=this,this.nbImages=20,this.conccurentTextureLoading=0,this.images=new Array(this.nbImages),this.current=0;for(var e=0;e<this.nbImages;e++)this.images[e]=new Image},loadShader:function(e,t,i){if(void 0!==this[t])return this[t];var o=i;void 0!==e.baseURL&&"http"!==i.substring(0,4)&&(o=e.baseURL+i);var s="",n=this;return UWA.Data.request(o,{cors:!0,async:!0,onComplete:function(e){var i=document.createElement("div");i.innerHTML=e,s=i.firstChild.firstChild.data,n[t]=s},onFailure:function(e){alert("Unable to load config file")}}),s},loadTexture:function(t,o,s){i.conccurentTextureLoading++;var n=s;if(void 0!==t.baseURL&&"http"!==s.substring(0,4)&&(n=t.baseURL+s),i.current===i.nbImages-1){i.current=0;for(var r=0;r<i.nbImages;r++)i.images[r]=new Image}var a=i.images[i.current];i.current++;var l=new e.Texture(a,void 0),h=e.ImageUtils,c=function(e){i.conccurentTextureLoading--,l.image=e.image,l.needsUpdate=!0,o(l,!0)},d=function(e){i.conccurentTextureLoading--,o(void 0,!1)},u=t.credentials.default,g=Object.keys(t.credentials);r=0;for(r=0;r<g.length;r++){var p=g[r];-1!==s.indexOf(p)&&(u=t.credentials[p])}n.contains(".basis")?l=h.loadBasisTexture(n,void 0,c,d,u,e.BasisUsage.RGBA):(h.loadTexture(n,void 0,c,d,u),l.sourceFile=n)}},o.getInstance=function(){return null===i&&(i=new o),i},o.getInstance()}),define("DS/SocialGlobe/Renderable",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return e.extend({init:function(e){this.scene=e}})}),define("DS/SocialGlobe/CmdInteraction",["UWA/Core","DS/ApplicationFrame/Command","UWA/Controls/ToolTip"],function(e,t,i){"use strict";var o=t.extend({init:function(t){this._parent(t,{isAsynchronous:!0}),this.widget=this.getFrameWindow().globe,this.widget.coordinatesInput.setValue(this.widget.widget.getValue("initGeoloc")),this.flagCheck=!1;var o=e.extendElement(this.widget.coordinatesInput.getInputElement());o.oninput||(o.oninput=function(e){e.checkLatLon(this)}.bind(o,this)),this.coordinatesInputToolTip=new i(o,"Should be at (lat,lon) format",{showOver:!1})},beginExecute:function(){this.widget.showInteractionPanel(!0)},execute:function(){this.checkLatLon(this.widget.coordinatesInput.getInputElement())},endExecute:function(){this.flagCheck&&this.enableIcon(),this.widget.showInteractionPanel(!1)},disableIcon:function(){var e=this;WUX.Events.publish({event:e._evtID+"/DISABLE",data:e}),WUX.Events.publish({event:e._globalEvtID+"/DISABLE",data:e}),e.flagCheck=!0},enableIcon:function(){var e=this;WUX.Events.publish({event:e._evtID+"/ENABLE",data:e}),WUX.Events.publish({event:e._globalEvtID+"/ENABLE",data:e}),e.flagCheck=!1,this.coordinatesInputToolTip.hide()},checkLatLon:function(e){""!==e.value?/^-?\d{1,2}(\.\d+)?,(-?\d{1,3}(\.\d+)?)$/i.test(e.value)?(e.removeClassName("input-coordinates-warning"),this.enableIcon(),this.coordinatesInputToolTip.hide()):(e.addClassName("input-coordinates-warning"),this.disableIcon(),this.coordinatesInputToolTip.show({x:"right",y:"top"},!1)):(e.removeClassName("input-coordinates-warning"),this.enableIcon(),this.coordinatesInputToolTip.hide())}});return e.namespace("SocialGlobe/CmdInteraction",o)}),define("DS/SocialGlobe/GlobePlatformIntegration",["UWA/Core","UWA/Promise","DS/WAFData/WAFData","DS/i3DXCompassServices/i3DXCompassServices","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(e,t,i,o,s){"use strict";var n="/resources/3ddrive/v1/bos/",r="/fileurl";function a(e,t){return-1===e.indexOf("?")?e+"?tenant="+t:e+"&tenant="+t}var l={url3DDrive:"",i3DXplatformServices:{},addTenantId:a,retrieve3DDriveUrl:function(i){return function(e){return new t(function(t,i){o.getServiceUrl({serviceName:"3DDrive",platformId:e,onComplete:t,onFailure:i})})}(i).then(function(i){return e.is(i,"string")&&""!==i?(l.url3DDrive=i,l.i3DXplatformServices["3DDrive"]=i,t.resolve(l.url3DDrive)):t.reject(new Error("Unable to retrieve 3DDrive service URL."))})},retrieveDocumentTypes:function(o,s,r){return function(e,o,s){var r=e+n+o;return r=a(r,s),new t(function(e,t){var o={method:"GET",type:"json",onComplete:e,onFailure:t};i.authenticatedRequest(r,o)})}(o,s,r).then(function(i){return e.is(i,"object")?e.is(i.id,"string")&&""!==i.id?e.is(i.extension,"string")&&""!==i.extension?t.resolve({extension:i.extension,driveUrl:o}):t.reject(new Error("Invalid value for attribute 'extension' found in response")):t.reject(new Error("Invalid value for attribute 'id' found in response")):t.reject(new Error("Invalid response type (should be an object)"))})},retrieveDocumentURL:function(o,s,l){return function(e,o,s){var l=e+n+o+r;return l=a(l,s),new t(function(e,t){var o={method:"GET",type:"json",onComplete:e,onFailure:t};i.authenticatedRequest(l,o)})}(o,s,l).then(function(i){return e.is(i,"object")?e.is(i.url,"string")&&""!==i.url?e.is(i.extension,"string")&&""!==i.extension?t.resolve(i.url):t.reject(new Error("Invalid value for attribute 'extension' found in response")):t.reject(new Error("Invalid value for attribute 'url' found in response")):t.reject(new Error("Invalid response type (should be an object)"))})},getDocumentContent:function(e,o){return function(e,o){var s=e;return s=a(s,o),new t(function(e,t){var o={method:"GET",type:"json",onComplete:e,onFailure:t};i.authenticatedRequest(s,o)})}(e,o)}};return l}),define("DS/SocialGlobe/CmdSave",["UWA/Core","DS/ApplicationFrame/Command","DS/SocialGlobe/GlobeNotifications","i18n!DS/SocialGlobe/assets/nls/GlobeViewer"],function(e,t,i,o){"use strict";var s=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},beginExecute:function(){this.widget=this.getFrameWindow().globe},execute:function(){this.widget.helpDisplayed&&this.widget.displayHelp(!1);var e=this.widget.saveAll();console.log(e),console.log(this.widget.widget.getValue("context")),i.handleSuccess(o.get("GlobeViewer.Save.Notification.Save"),o.get("GlobeViewer.Save.Notification.DataSaveSuccessfully")),this.end()}});return e.namespace("SocialGlobe/CmdSave",s)}),define("DS/SocialGlobe/Mesh",["DS/SocialGlobe/Renderable","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils"],function(e,t,i,o){"use strict";var s=e.extend({init:function(e,t,i,o){this.scene=e,this.texCoords=[],this.texDim=[],this._parent(e),this.vertexTmp=[],this.normalTmp=[],this.texCoordsTmp=[],this.facesTmp=[],this.clue=t,this.passID=o,this.pickIndex=i>=0?i:-1},setMaterial:function(e){this.threeMaterial=e||new t.MeshLambertMaterial({color:65280})},setPickMaterial:function(e){this.threePickMaterial=e},setVisibility:function(e){this.v6Node.setVisibility(e)},setColorRGB:function(e,i){this.threeMaterial.uniforms[e].value=new t.Vector4(i[0],i[1],i[2],1),this.threeMaterial.force=!0},setColorRGBA:function(e,i){this.threeMaterial.uniforms[e].value=new t.Vector4(i[0],i[1],i[2],i[3]),this.threeMaterial.force=!0},addVertex:function(e,t,i,o,s,n,r){var a;if(0===this.vertexTmp.length&&r)for(a=0;a<r.length;a++)this.texDim.push(r[a].length);this.vertexTmp.push([e,t,i]),this.normalTmp.push([o,s,n]),this.texCoordsTmp.push(r)},addFace:function(e){this.facesTmp.push(e)},endMesh:function(e){if(this.threeMaterial){if(this.v6Node=this.buildMesh(this.scene.v6SceneGraph,this.threeMaterial),e.pickable)switch(e.pickable){case"pickable":this.v6Node.setPickable(o.PICKABLE);break;case"occulting":this.v6Node.setPickable(o.NOPICKABLE);break;default:this.v6Node.setPickable(o.NODRAWHL)}else this.v6Node.setPickable(o.NODRAWHL);this.clue&&(this.v6Node.clue=this.clue),this.passID&&this.v6Node.setRenderPasses([this.passID]),this.v6Node.DSSocialGlobeMesh=this}},buildMesh:function(e,t){var n,r,a,l,h,c,d,u,g,p,m,f,v,b,w,y;for((n=new o.PrimitiveGroup).fillAttr=new o.FillAttributes,n.lineAttr=new o.LineAttributes,n.pointAttr=new o.PointAttributes,(r=new o.Buffer).size=3*this.vertexTmp.length,r.component=o.VertexComponentEnum.POSITION,r.format=o.DataTypeEnum.FLOAT,r.dimension=3,r.data=new Float32Array(r.size),(a=new o.Buffer).indexBuffer=!0,a.size=3*this.facesTmp.length,a.format=o.DataTypeEnum.UINT,a.dimension=1,a.data=new Uint16Array(a.size),(l=new o.Buffer).size=3*this.texCoordsTmp.length,l.component=o.VertexComponentEnum.TEX_COORD_0,l.format=o.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(l.size),(h=new o.Buffer).indexBuffer=!0,h.size=3*this.facesTmp.length,h.format=o.DataTypeEnum.UINT,h.dimension=1,h.data=new Uint16Array(h.size),(c=new o.Buffer).size=3*this.vertexTmp.length,c.component=o.VertexComponentEnum.NORMAL,c.format=o.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(r.size),(d=new o.Buffer).indexBuffer=!0,d.size=3*this.facesTmp.length,d.format=o.DataTypeEnum.UINT,d.dimension=1,d.data=new Uint16Array(h.size),g=0,p=0,m=0,m=0;m<this.vertexTmp.length;m++)c.data[g]=this.normalTmp[m][0],r.data[g++]=this.vertexTmp[m][0],c.data[g]=this.normalTmp[m][1],r.data[g++]=this.vertexTmp[m][1],c.data[g]=this.normalTmp[m][2],r.data[g++]=this.vertexTmp[m][2],l.data[p++]=this.texCoordsTmp[m][0][0],l.data[p++]=this.texCoordsTmp[m][0][1],l.data[p++]=0;for(u=0,m=0;m<this.facesTmp.length;m++)h.data[u]=this.facesTmp[m][0],d.data[u]=this.facesTmp[m][0],a.data[u++]=this.facesTmp[m][0],h.data[u]=this.facesTmp[m][1],d.data[u]=this.facesTmp[m][1],a.data[u++]=this.facesTmp[m][1],h.data[u]=this.facesTmp[m][2],d.data[u]=this.facesTmp[m][2],a.data[u++]=this.facesTmp[m][2];return n.addBuffer(0,r),n.addBuffer(1,l),n.addBuffer(2,a),n.addBuffer(3,h),n.addBuffer(4,c),n.addBuffer(5,d),(f=new o.Primitive).nbIndices=3*this.facesTmp.length,f.connectivity=o.ConnectivityTypeEnum.TRIANGLES,0,(v=new o.VertexComponent).component=o.VertexComponentEnum.POSITION,v.nbVertices=this.vertexTmp.length,v.nbValuesPerVertex=3,v.format=o.DataTypeEnum.FLOAT,v.cardinality=0,v.bufferId=0,v.indices=new o.IndexArray,v.indices.format=o.DataTypeEnum.UINT,v.indices.bufferId=2,v.indices.offset=0,(b=new o.VertexComponent).component=o.VertexComponentEnum.TEX_COORD_0,b.nbVertices=this.texCoordsTmp.length,b.nbValuesPerVertex=3,b.format=o.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=1,b.indices=new o.IndexArray,b.indices.format=o.DataTypeEnum.UINT,b.indices.bufferId=3,b.indices.offset=0,(w=new o.VertexComponent).component=o.VertexComponentEnum.NORMAL,w.nbVertices=this.vertexTmp.length,w.nbValuesPerVertex=3,w.format=o.DataTypeEnum.FLOAT,w.cardinality=0,w.bufferId=4,w.indices=new o.IndexArray,w.indices.format=o.DataTypeEnum.UINT,w.indices.bufferId=5,w.indices.offset=0,f.addVertexComponent(v),f.addVertexComponent(b),f.addVertexComponent(w),n.addPrimitive(f),(y=i.createMeshNode(n,t)).name="DSSocialglobeMesh"+s.nameCounter,s.nameCounter++,y},onMouseOver:function(){this.threeMesh.material=this.threeMaterial_highlight},onMouseOut:function(){this.threeMesh.material=this.threeMaterial},updateMaterial:function(e,t){var i=this.threeMaterial.uniforms.uMixProj,o=!1;i&&(i.value=e,o=!0),(i=this.threeMaterial.uniforms.uZoom)&&(i.value=this.scene.camera.getZoomCoeff(),o=!0),(i=this.threeMaterial.uniforms.uAspectRatio)&&(i.value=t,o=!0),o&&(this.threeMaterial.force=!0)},dispose:function(){this.threeMaterial.uniform.OSMTexture&&this.threeMaterial.uniform.OSMTexture.dispatchEvent({type:"dispose"}),this.threeMaterial.dispose()}});return s.nameCounter=0,s}),define("DS/SocialGlobe/Marker",["UWA/Class","DS/SocialGlobe/Globals","marked/marked","DS/SocialGlobe/assets/purify/purify.min"],function(e,t,i,o){"use strict";return e.extend({init:function(e,i,o,s,n,r,a,l,h,c){this.setPositionFromLatLon(e,i,o),this.level=a,this.fid=h,this.color=t.convertColorCode(s),this.colorBackup=t.convertColorCode(s),this.colorOverride=void 0,this.title=n,this.point_count=l,this.description=r,this.popup=void 0,this.image=void 0,this.onclick=void 0,this.ondoubleclick=void 0,this.onmouseover=void 0,this.html=void 0,this.link=void 0,this.width=void 0,this.height=void 0,this.persist=!1,this.uuid=void 0,c?(c.popup&&(this.popup=c.popup),c.image&&(this.image=c.image),c.onclick&&(this.onclick=c.onclick),c.ondoubleclick&&(this.ondoubleclick=c.ondoubleclick),c.onmouseover&&(this.onmouseover=c.onmouseover),c.html&&(this.html=c.html),c.link&&(this.link=c.link),c.width&&(this.width=c.width),c.height&&(this.height=c.height),c.descriptionType?this.descriptionType=c.descriptionType:this.link?this.descriptionType="html":this.descriptionType="text",c.persist&&(this.persist=c.persist),c.uuid&&(this.uuid=c.uuid)):this.descriptionType="text",this.position=t.latlonToXYZ(e,i,o),this.id=-1},type:"Marker",getID:function(e){return this.id},setId:function(e){this.id=e},getTitle:function(){return this.title},getDescription:function(){return this.description},htmlContent:function(){if("marked"===this.descriptionType)return this.htmlEncode(i(this.description));if(void 0!==this.html)return this.htmlEncode(this.html);var e=(void 0!==this.title&&""!==this.title?"<b>"+this.title+"</b><br>":"")+this.description;return this.htmlEncode(e)},htmlDefined:function(){return void 0!==this.html},htmlEncode:function(e){return o.sanitize(e)},textToHTML:function(e){if(function(){if(!window.DOMParser)return!1;var e=new DOMParser;try{e.parseFromString("x","text/html")}catch(e){return!1}return!0}())return(new DOMParser).parseFromString(e,"text/html").body.innerHTML;var t=document.createElement("div");return t.innerHTML=e,t},overrideHtmlColor:function(e){return this.colorOverride=e,this._manager&&!this._manager._clustering&&this._manager.refresh(this),this},setColor:function(e){return this.color=e,this._manager&&!this._manager._clustering&&this._manager.refresh(this),this},setImage:function(e){return this.image=e,this._manager&&!this._manager._clustering&&this._manager.refresh(this),this},getCurrentColor:function(){return this.colorOverride?this.colorOverride:this.color},setPositionFromLatLon:function(e,i,o){this.lat=e,this.lon=i,this.altitude=o,this.position=t.latlonToXYZ(e,i,o)},isValidContent:function(){return void 0!==this.link&&""!==this.link||void 0!==this.title&&""!==this.title||void 0!==this.description&&""!==this.description}})}),
/*!
  Script: DSSocialGlobeUWA.js

    This file is part of UWA JS Runtime.

  About: License

    Copyright 2006-2013 Dassault Systèmes company.
    All rights reserved.
*/
window.DSSocialGlobe={},define("DS/SocialGlobe/UIMarkerCountryCreator",["UWA/Class","DS/SocialGlobe/Globals","i18n!DS/SocialGlobe/assets/nls/GlobeViewer"],function(e,t,i){"use strict";return e.extend({init:function(e,t){this._parent(t),this.options=t,this.enable=!1,this.manager=e,this.arraySelectName=[],this.selection=[],this.container=this.buildSkeleton(),this._evtID="/SG/UICE/CMD/"+t.ID},buildSkeleton:function(){var e;this.options;switch(this.options.ID){case"ColorMarker":s=i.get("GlobeViewer.Marker.Create.Notification.Title"),e=i.get("GlobeViewer.Marker.Create.Notification.Action.Label");break;case"ColorArea":s=i.get("GlobeViewer.Areas.Create.Notification.Title"),e=i.get("GlobeViewer.Areas.Create.Notification.Action.Label")}this.container=new UWA.Element("div",{class:"globe-select-dialog"});var t=new UWA.Element("ul",{class:"wux-notification-screen"}).inject(this.container),o=new UWA.Element("div",{class:"wux-notification-container"}).inject(t),s=new UWA.Element("div",{class:"wux-notification-title",html:s}).inject(o);return this.label=new UWA.Element("a",{class:"wux-notification-action",html:e,target:"_blank",events:{click:this.options.showSelectorUI.bind(this)}}).inject(o),this.container},setCountry:function(e){e&&this.options.cmdEndSelect&&this.options.cmdEndSelect(e)},setMarker:function(e){e&&this.options.cmdEndSelect&&this.options.cmdEndSelect(e)}})}),define("DS/SocialGlobe/MarkerInfo",["UWA/Class","DS/SocialGlobe/Globals","UWA/Controls/Web","DS/SocialGlobe/GlobeNotifications","i18n!DS/SocialGlobe/assets/nls/GlobeViewer"],function(e,t,i,o,s){"use strict";return e.extend({init:function(e,t){this.markerPanelDisplayed=!1,this.markerPanel=new UWA.Element("div",{styles:{position:"absolute",zIndex:5e4,display:"none",overflow:"hidden"},events:{resize:this.resize.bind(this)}}).inject(e,"top"),this.panelDimensions=t},resize:function(){!this.markerPanel.isHidden()&&this.control&&(this.control.getIFrame().width=this.markerPanel.style.width,this.control.getIFrame().height=this.markerPanel.style.height,this.control.width=this.markerPanel.style.width,this.control.height=this.markerPanel.style.height)},show:function(e,t,i,o=!1,s=!0){if(this.markerPanelDisplayed=e,this.markerPanel.empty(),e&&t&&t.isValidContent()){if(s&&this.isValidLink(t)&&t.persist)return;var n=new UWA.Element("div",{html:t.htmlContent(),class:"marked"===t.descriptionType?"remove-uwa-styles":""});this.markerPanel.addContent(n);var r=t.width?t.width+"px":"100%",a=t.height?t.height+"px":"100%",l=t&&t.width?t.width+"px":"",h=t&&t.height?t.height+"px":"";this.panelDimensions&&void 0!==this.panelDimensions.width&&void 0!==this.panelDimensions.height&&(l=r=this.panelDimensions.width-10+"px",h=a=this.panelDimensions.height-10+"px"),this.isValidLink(t)&&(this.markerPanel.empty(),this.control=new UWA.Controls.Web({url:t.link,width:l,height:h,withMessage:!0}),this.controlMarker=t,o||this.markerPanel.setStyle("resize","both"),this.control.elements.loadingMessage.hide(),this.markerPanel.addContent(this.control),this.markerPanel.style.height=a,this.markerPanel.style.width=r,this.markerPanel.style.left="0",this.markerPanel.style.top="0",this.markerPanel.style.display="block"),t.htmlDefined()?(this.markerPanel.style.height=a,this.markerPanel.style.width=r,this.markerPanel.style.left="0",this.markerPanel.style.top="0",this.markerPanel.style.display="block"):(this.markerPanel.style.height=h,this.markerPanel.style.width=l,this.markerPanel.style.left=i[0]+"px",this.markerPanel.style.top=i[1]+"px",this.markerPanel.style.display="block"),"marked"===t.descriptionType&&(this.markerPanel.setStyle("resize","both"),this.markerPanel.setStyle("overflow","auto"))}else this.markerPanel.style.display="none",this.control=null,this.markerPanel.setStyle("resize","none"),this.markerPanel.setStyle("overflow","hidden")},changeSkin:function(e,t){this.markerPanel.className="natural"},getID:function(e){return this.id},setId:function(e){this.id=e},isValidLink:function(e){return"html"===e.descriptionType&&e.link&&UWA.Utils.isValidUrl(e.link)}})}),define("DS/SocialGlobe/MarkerInfoManager",["UWA/Core","UWA/Class","DS/SocialGlobe/MarkerInfo","DS/Windows/ImmersiveFrame","DS/Windows/Panel","i18n!DS/SocialGlobe/assets/nls/GlobeViewer"],function(e,t,i,o,s,n){"use strict";return t.singleton({init:function(t){this._parent(t),this.markerInfos={},this.immersiveFrame=new o({identifier:"WebUIImmersiveFrame_MarkerInfoManager"}),this.frmWindow=void 0,this.widget=void 0,this.highlightedObject=void 0,this.webUXMarkerIdentifier="WUXPanel_Marker"+Math.round(1e5*Math.random()),this.webUXCountryIdentifier="WUXPanel_Country"+Math.round(1e5*Math.random()),this.container=new e.Element("div"),this.immersiveFrame.inject(this.container)},setFrameWindow:function(e){this.frmWindow=e;var t=this.frmWindow.getUIFrame();this.container.inject(t,"top")},getFrameWindow:function(){return this.frmWindow},setWidget:function(e){this.widget=e},getWidget:function(e){return this.widget},isValidLink:function(t){return"html"===t.descriptionType&&t.link&&e.Utils.isValidUrl(t.link)},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},createMarker:function(t,o,n){var r=this,a=new e.Element("div",{styles:{width:n.width?n.width+"px":"100%",height:n.height?n.height+"px":"100%"}});n.uuid=n.uuid?n.uuid:this.uuidv4();var l=n.width?parseInt(n.width)+10:0,h=n.height?parseInt(n.height)+10:0,c=n.uuid,d=new s({title:t,immersiveFrame:this.immersiveFrame,content:a,width:l,height:h,resizableFlag:!0,movableFlag:!0,floatableFlag:!0,collapsibleFlag:!1,pinnedFlag:!1,closeButtonFlag:!1,snappableFlag:!1,allowedDockAreas:WUXDockAreaEnum.NoneDockArea,identifier:c});if(this.hasNoPanelPreference(d)){var u=this.frmWindow.globe.getPanelPreference(c);this.updatePanelOptions(d,u)}var g={width:d.width,height:d.height},p=new i(a,g);return d.addEventListener("close",this.removeMarkerInfo.bind(this,o,!0)),d.addEventListener("resize",function(e){var t=e.dsModel.width-10,i=e.dsModel.height-10;p.markerPanel.style.width=t+"px",p.markerPanel.style.height=i+"px",p.resize(),r.updatePanelPreferences(c,e.dsModel)}),d.addEventListener("stopWindowDrag",function(e){r.updatePanelPreferences(c,e.dsModel)}),d.addEventListener("stopResize",function(e){var t=e.dsModel.width-10,i=e.dsModel.height-10;r.updateMarkerDimensions(n,t,i)}),d.addEventListener("mousedown",function(e){r.highlightFrame(n),r.frmWindow.globe.getGlobe().setSelection([n])}),d.windowGroup&&d.windowGroup.addEventListener("mousedown",function(e){var t=e.path[0].innerText,i=r.getMarkerInfoByName(t);i&&(r.highlightFrame(i.controlMarker),r.frmWindow.globe.getGlobe().setSelection([i.controlMarker]))}),{id:o,immersiveFrame:this.immersiveFrame,panelContent:a,panel:d,container:this.container,markerInfo:p}},addMarkerInfo:function(e,t=!1){e.uuid=e.uuid?e.uuid:this.uuidv4();var i=e.uuid;this.removeMarkerInfo(i);var o=e.title;t&&(o=n.get("GlobeViewer.Countries.ISO3."+o));var s=this.createMarker(o,i,e);return s.markerInfo.setId(i),s.markerInfo.show(!0,e,[0,0],!0,!1),this.markerInfos[i]=s,s},removeMarkerInfo:function(e,t){if(this.markerInfos[e]){var i=this.getMarkerPanelId(this.markerInfos[e]);this.frmWindow.globe.removePanelPreference(i),this.markerInfos[e].markerInfo.show(!1,void 0,null),this.markerInfos[e].markerInfo.markerPanel.empty(),t||this.markerInfos[e].panel.close(),this.highlightedObject&&this.highlightedObject.id===e&&(this.highlightedObject=void 0),delete this.markerInfos[e]}},highlightFrame:function(e){if(this.clearHighlight(),e){var t=e.uuid?e.uuid:e.getID(),i=this.markerInfos[t];i.panel.elements.container.addClassName("highlight-container"),i.panel.windowGroup&&i.panel.windowGroup.elements.container.addClassName("highlight-container"),i.panel.ensureVisible(),i.panel.bringToFront(),this.highlightedObject=i}},clearHighlight:function(){this.highlightedObject&&(this.highlightedObject.panel.elements.container.removeClassName("highlight-container"),this.highlightedObject.panel.windowGroup&&this.highlightedObject.panel.windowGroup.elements.container.removeClassName("highlight-container"))},getMarkerInfoByName:function(e){for(var t in this.markerInfos)if(this.markerInfos.hasOwnProperty(t)&&this.markerInfos[t]&&this.markerInfos[t].markerInfo.controlMarker.title===e)return this.markerInfos[t].markerInfo},getMarkerPanelId:function(e){return e.panel.identifier},resetAll:function(){for(var e in this.markerInfos)this.markerInfos.hasOwnProperty(e)&&this.markerInfos[e]&&this.removeMarkerInfo(e,!1)},updateMarkerDimensions:function(e,t,i){e&&(e.width=t,e.height=i,this.frmWindow.globe.saveMarker(e))},updatePanelPreferences:function(e,t){if(t){var i=t.position.offsetX,o=t.position.offsetY,s={id:e,width:t.width,height:t.height,offsetX:i,offsetY:o};this.frmWindow.globe.updatePanelPreference(e,s)}},updatePanelOptions:function(e,t){t&&(e.position.offsetX=t.offsetX,e.position.offsetY=t.offsetY,e.width=t.width,e.height=t.height,e.fire("move"))},hasNoPanelPreference:function(e){return void 0===e._getPositionFromPreferences()&&void 0===e._getDimensionsFromPreferences()}})}),define("DS/SocialGlobe/CmdReset",["UWA/Core","DS/ApplicationFrame/Command","DS/SocialGlobe/GlobeNotifications","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/SocialGlobe/MarkerInfoManager"],function(e,t,i,o,s){"use strict";var n=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},beginExecute:function(){this.globe=this.getFrameWindow().globe},execute:function(){this.globe.helpDisplayed&&this.globe.displayHelp(!1),this.globe.options.use2D?(this.globe.clearGeoJSONData(),this.globe.clearGeoJSONFieldsPref(),this.globe.clearGeoJSONInput(),this.globe.getGlobe().unclusteredLayerGroup=null):(this.globe.clearCountries(),this.globe.clearMarkers(),s.resetAll()),this.globe.clearDrivePreferences(),this.globe.removeAllPanelPreferences(),i.handleSuccess(o.get("GlobeViewer.Reset.Notification.Reset"),o.get("GlobeViewer.Reset.Notification.DataResetSuccessfully")),this.end()}});return e.namespace("SocialGlobe/CmdReset",n)}),
/*!
  Script: DSSocialGlobeUWA.js

    This file is part of UWA JS Runtime.

  About: License

    Copyright 2006-2013 Dassault Systèmes company.
    All rights reserved.
*/
window.DSSocialGlobe={},define("DS/SocialGlobe/UIFieldsChoice",["UWA/Core","UWA/Class","UWA/Controls/Abstract","DS/SocialGlobe/Globals","DS/Core/Events","UWA/Controls/Input","DS/Windows/ImmersiveFrame","DS/Windows/Panel","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/SocialGlobe/GlobeNotifications","DS/WebappsUtils/WebappsUtils","DS/Controls/ComboBox","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/Controls/Button","DS/SocialGlobe/MarkerInfoManager","DS/SocialGlobe/assets/purify/purify.min"],function(e,t,i,o,s,n,r,a,l,h,c,d,u,g,p,m,f){"use strict";return t.extend({init:function(e,t,i,o,s){this._parent(i),this.options=i,this.enable=!1,this.widget=e,this.globe=t,this.validated=!1,this._cmdEndExecute=o,this.geojson=s,this.container=this.buildSkeleton(),this.noContainerRemove=!0},buildSkeleton:function(){this.options;this.fieldsContainer=new UWA.Element("div"),console.log(this.widget),this.frmWindow=this.widget.frmWindow;var e=this.frmWindow.getUIFrame();return this.fieldsContainer.inject(e,"top"),this.immersiveFrame=new r({}),this.immersiveFrame.inject(this.fieldsContainer),this.panelContent=new UWA.Element("div",{class:"globe-panel-select",styles:{width:"100%",height:"100%"}}),this.buildTitleDescriptionInputs(this.panelContent),this.panel=new a({immersiveFrame:this.immersiveFrame,title:"GeoJSON Fields Chooser",content:this.panelContent,position:{my:"center",at:"center"},allowedDockAreas:0,identifier:"WUXPanel_FieldsChooser_"+m.webUXMarkerIdentifier}),this.addButtons(this.panelContent),this.panel.addEventListener("close",function(){this.onFieldsChooserClose()}.bind(this)),this.fieldsContainer},buildTitleDescriptionInputs:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),i=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"Title",styles:{width:"50px","padding-right":"15px"}}).inject(t),new UWA.Element("li",{class:"country-combo-box",styles:{width:"60%"}}).inject(t));this.arraySelectTitle=new u;for(var o=Object.keys(this.geojson.features[0].properties).sort(),s=0;s<o.length;s++){(a=o[s])&&this.arraySelectTitle.addChild(new g({label:a,value:a}))}this.arraySelectTitle.expandAll(),this.titleField=new d({enableSearchFlag:!0,elementsTree:this.arraySelectTitle,displayStyle:"normal",selectedIndex:-1!=this.options.titleIndex?this.options.titleIndex:0}).inject(i);var n=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),r=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"Description",styles:{width:"50px","padding-right":"15px"}}).inject(n),new UWA.Element("li",{class:"country-combo-box",styles:{width:"60%"}}).inject(n));this.arraySelectDesc=new u;for(o=Object.keys(this.geojson.features[0].properties).sort(),s=0;s<o.length;s++){var a;(a=o[s])&&this.arraySelectDesc.addChild(new g({label:a,value:a}))}this.arraySelectDesc.expandAll(),this.descriptionField=new d({enableSearchFlag:!0,elementsTree:this.arraySelectDesc,displayStyle:"normal",selectedIndex:-1!=this.options.descIndex?this.options.descIndex:1}).inject(r)},addButtons:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),i=new UWA.Element("li",{class:"country-buttons"}).inject(t);new p({label:l.get("GlobeViewer.Areas.Editor.Apply"),emphasize:"primary",onClick:this.apply.bind(this)}).inject(i)},validateInputs:function(){this.chosenTitle=this.htmlEncode(this.titleField.value),this.chosenDescription=this.htmlEncode(this.descriptionField.value);var e=this.chosenTitle,t=this.chosenDescription;return void 0===e||""===e?{ok:!1,error:new Error("Please choose a field for features title")}:void 0===t||""===t?{ok:!1,error:new Error("Please choose a field for features description")}:{ok:!0}},onFieldsChooserClose:function(){this._cmdEndExecute?this._cmdEndExecute:this.validated||widget.setValue("3DDriveGeoJSONManagement","")},apply:function(){var e=this.validateInputs();if(e.ok){if(this.globe.use2D){this._cmdEndExecute?(this._cmdEndExecute(),this.from3DDrive=!1):this.from3DDrive=!0,this.chosenFields={chosenTitle:this.chosenTitle,chosenDescription:this.chosenDescription,from3DDrive:this.from3DDrive};var t=widget.getPreference("jsonFieldsPrefURL").value,i=widget.getPreference("jsonFieldsPref3DDrive").value;0==this.from3DDrive?t=this.chosenFields:i=this.chosenFields,widget.setValue("jsonFieldsPrefURL",t),widget.setValue("jsonFieldsPref3DDrive",i),0==this.from3DDrive?this.loadOptions=widget.getPreference("jsonFieldsPrefURL").value:this.loadOptions=widget.getPreference("jsonFieldsPref3DDrive").value,this.globe.loadGeoJSON(this.geojson,!0,this._current6wtags,this.globe._taggerProxy,this.loadOptions)}else this.globe.loadGeoJSON(this.geojson,!0,this._current6wtags,this.globe._taggerProxy);return this.from3DDrive&&h.display({level:"success",title:l.get("GlobeViewer.DragAndDrop.Notification.DragAndDropSuccess"),subtitle:l.get("GlobeViewer.DragAndDrop.Notification.DragAndDropSuccessfulLoad",{name:this.options.name}),message:l.get("GlobeViewer.AddContent.Notification.GeojsonSuccessfulload")}),this.validated=!0,this.panel.close(),!0}var o=e.error;return o.title="Field Selector Error",o.subtitle=l.get("GlobeViewer.Marker.Create.Select.Notification.Error.ContentAdditionError"),h.display({level:"error",title:o.title,subtitle:o.subtitle,message:o.message}),!1},htmlEncode:function(e){return f.sanitize(e)}})}),define("DS/SocialGlobe/CmdImportFile",["UWA/Core","DS/ApplicationFrame/Command","DS/SocialGlobe/MarkerInfoManager","DS/SocialGlobe/UIFieldsChoice"],function(e,t,i,o){"use strict";var s=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0});var t=this;WUX.Events.subscribe({event:"/SG/UICE/CMD//Geojson/IMPORT"},function(e){e.geojson&&t.createChoiceUI(e.geojson)})},createChoiceUI:function(e){var t=Object.keys(e.features[0].properties).sort().indexOf("title"),i=Object.keys(e.features[0].properties).sort().indexOf("description");this.widget.topBars.FieldsChoice=new o(this.widget,this.widget.getGlobe(),{ID:"GeojsonFieldsChoice",titleIndex:t,descIndex:i},this.end.bind(this),e),this._topBar=this.widget.topBars.FieldsChoice},beginExecute:function(){this.widget=this.getFrameWindow().globe,console.log(this.widget),this.widget.widget.getValue("feedUrl")&&""!==this.widget.widget.getValue("feedUrl")&&this.widget.georssInput.setValue(this.widget.widget.getValue("feedUrl")),this.widget.widget.getValue("jsonFile")&&""!==this.widget.widget.getValue("jsonFile")&&(this.widget.geojsonInput.setValue(this.widget.widget.getValue("jsonFile")),this.widget.getGlobe().use2D||this.widget.georssInput.setDisabled(!0)),this.widget.widget.getValue("enableproxypassport")&&""!==this.widget.widget.getValue("enableproxypassport")&&(this.widget.enableProxyPassportButton.checkFlag=this.widget.widget.getValue("enableproxypassport")),this.widget.showLoadDataPanel(!0)},execute:function(){console.log("import file")},endExecute:function(){this.widget.showLoadDataPanel(!1)},resetManualData:function(){this.widget.clearCountries(),this.widget.clearMarkers(),this.widget.clearDrivePreferences(),i.resetAll(),this.widget.removeAllPanelPreferences(),this.widget.saveAll()}});return e.namespace("SocialGlobe/CmdImportFile",s)}),
/*!
  Script: DSSocialGlobeUWA.js

    This file is part of UWA JS Runtime.

  About: License

    Copyright 2006-2013 Dassault Systèmes company.
    All rights reserved.
*/
window.DSSocialGlobe={},define("DS/SocialGlobe/UIMarkerSelector",["UWA/Core","UWA/Class","UWA/Controls/Abstract","DS/SocialGlobe/Globals","DS/Core/Events","UWA/Controls/Input","UWA/Controls/ColorPicker","DS/Windows/Panel","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/SocialGlobe/GlobeNotifications","DS/Controls/ColorPicker","DS/Controls/Toggle","DS/Controls/ButtonGroup","DS/WebappsUtils/WebappsUtils","DS/Controls/ComboBox","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/Controls/Button","DS/SocialGlobe/MarkerInfoManager"],function(e,t,i,o,s,n,r,a,l,h,c,d,u,g,p,m,f,v,b){"use strict";return t.extend({init:function(e,t){this._parent(t),this.options=t,this.enable=!1,this.globe=e,this.container=this.buildSkeleton(),this.noContainerRemove=!0,this.globe.markerAdditionOnClick(!1),this._evtID="/SG/UICE/CMD/"+t.ID},buildSkeleton:function(){this.options;return this.panelContent=new UWA.Element("div",{class:"globe-panel-select",styles:{width:"100%",height:"100%"}}),this.buildLatLonInputs(this.panelContent),this.panel=new a({immersiveFrame:b.immersiveFrame,title:l.get("GlobeViewer.Marker.Create.Select.title"),content:this.panelContent,allowedDockAreas:0,identifier:"WUXPanel_MarkerSelector_"+b.webUXMarkerIdentifier}),this.addButtons(this.panelContent),this.panel.addEventListener("close",this.options.cmdEndExecute),b.container},buildLatLonInputs:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),i=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Marker.Create.Select.Latitude"),styles:{width:"50px"}}).inject(t),new UWA.Element("li",{class:"country-combo-box",styles:{width:"60%"}}).inject(t));this.leLatitude=new UWA.Controls.Input.Text({attributes:{type:"number",min:"-85.0",max:"85.0"}}).inject(i);var o=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),s=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Marker.Create.Select.Longitude"),styles:{width:"50px"}}).inject(o),new UWA.Element("li",{class:"country-combo-box",styles:{width:"60%"}}).inject(o));this.leLongitude=new UWA.Controls.Input.Text({attributes:{type:"number",min:"-180.0",max:"180.0"}}).inject(s)},addButtons:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),i=new UWA.Element("li",{class:"country-buttons"}).inject(t);new v({label:l.get("GlobeViewer.Areas.Editor.Apply"),emphasize:"primary",onClick:this.apply.bind(this)}).inject(i)},validateInputs:function(){var e=this.leLatitude.getValue(),t=this.leLongitude.getValue();return void 0===e||""===e||isNaN(e)||parseFloat(e)<-85||parseFloat(e)>85?{ok:!1,error:new Error(l.get("GlobeViewer.Marker.Create.Select.Notification.Error.InvalidLatitude"))}:void 0===t||""===t||isNaN(t)||parseFloat(t)<-180||parseFloat(t)>180?{ok:!1,error:new Error(l.get("GlobeViewer.Marker.Create.Select.Notification.Error.InvalidLongitude"))}:{ok:!0}},apply:function(){var e=this.validateInputs();if(e.ok){var t={lat:parseFloat(this.leLatitude.getValue()),lon:parseFloat(this.leLongitude.getValue())};return this.options.cmdEndSelect(t,!0),this.globe.flyToLatLon(t.lat,t.lon),this.options.cmdEndExecute(),this.panel.close(),!0}var i=e.error;return i.title=l.get("GlobeViewer.Marker.Create.Select.Notification.Error.InputError"),i.subtitle=l.get("GlobeViewer.Marker.Create.Select.Notification.Error.ContentAdditionError"),h.display({level:"error",title:i.title,subtitle:i.subtitle,message:i.message}),!1}})}),define("DS/SocialGlobe/CmdAddMarker",["UWA/Core","DS/ApplicationFrame/Command","DS/SocialGlobe/UIMarkerSelector","DS/SocialGlobe/UIMarkerCountryCreator","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Globals","DS/SocialGlobe/Marker"],function(e,t,i,o,s,n,r){"use strict";var a="/SG/UICE/CMD/",l=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},showSelectorUI:function(){this.widget.topBars.MarkerSelector=new i(this.widget.getGlobe(),{ID:"SelectMarker",cmdEndExecute:this.end.bind(this),cmdEndSelect:this.widget.getGlobe().use2D?this.editMarker2D.bind(this):this.editMarker.bind(this)}),this.widget.setTopBar("MarkerSelector")},editMarker:function(e){var t=this.widget.addMarker(e.lat,e.lon,0,"#ff0000","","",{});this.widget.getGlobe().setSelection([t]),this.done(),this.end(),WUX.Events.publish({event:a+"/ColorMarker/EDIT",data:{fromCreateMarker:!0,marker:t}})},editMarker2D:function(e){var t=this.widget.addMarker2D(e);this.done(),this.end(),WUX.Events.publish({event:a+"/ColorMarker/EDIT",data:{fromCreateMarker:!0,marker:t}})},addMarker:function(e){var t=this.widget.addMarker(e);this.done(),this.end(),WUX.Events.publish({event:a+"/ColorMarker/EDIT",data:{fromCreateMarker:!0,marker:t}})},addMarker2D:function(e){var t=this.widget.addMarker2D(e);this.done(),this.end(),WUX.Events.publish({event:a+"/ColorMarker/EDIT",data:{fromCreateMarker:!0,marker:t}})},beginExecute:function(){this.widget=this.getFrameWindow().globe,this.widget.getGlobe().use2D?(this.widget.getGlobe().markerAdditionOnClick(!0),console.log("toggling polygon and marker popup to false"),this.widget.getGlobe().polygonPopupOnClick(!1),this.widget.getGlobe().markerPopupOnClick(!1)):this.widget.getGlobe().clearSelection(),this.widget.topBars.Marker=new o(this.widget.getGlobe(),{ID:"ColorMarker",cmdEndExecute:this.end.bind(this),cmdEndSelect:this.widget.getGlobe().use2D?this.editMarker2D.bind(this):this.editMarker.bind(this),showSelectorUI:this.showSelectorUI.bind(this)}),this._topBar=this.widget.topBars.Marker},execute:function(){this.widget.helpDisplayed&&this.widget.displayHelp(!1);var e=this.widget.getGlobe();this.widget.setTopBar("Marker");var t=this;if(this.widget.getGlobe().use2D)e.map.on("click",function(i){e.map.markerAdditionOnClick&&(e.markerAdditionOnClick(!1),e.markerDetailsOnClick(!1),t.addMarker2D(i.latlng))});else{e.clearMouseOver();e.markerBag;var i={onMouseMove:function(t,i,o){t.length?e.getDataModel().hover(t[0]):e.getDataModel().hover()},onMouseOut:function(){},onMouseDoubleClick:function(e,t,i){},onMouseClick:function(e,i,o){if(e.length)t._topBar.setMarker(e[0]),t.widget.getGlobe().setSelection(e);else{var r=t.getFrameWindow().getViewerFrame(),a={lat:0,lon:0};if(t.widget.mode2d){var l=.97*r.clientWidth,h=360*((i-r.clientWidth/2)/r.clientWidth),c=l/1.5,d=((c-r.clientHeight)/2+o-c/2)/c,u=0;0!==d&&(u=-d/Math.abs(d)*this.computeLatWithYclick(Math.abs(d))),a={lat:u,lon:h}}else{var g=new s.Projector,p=new s.Vector3(i/r.clientWidth*2-1,-o/r.clientHeight*2+1,0),m=g.pickingRay(p,t.widget.getGlobe().camera.threeCamera).ray,f=m.origin,v=m.direction,b=new s.Vector3(0,0,0).sub(f),w=b.dot(v);b.copy(v).multiplyScalar(w).add(f);var y=b.lengthSq();if(y>1)return;var M=w-Math.sqrt(1-y),S=v.clone().multiplyScalar(M).add(f);a=n.XYZToLatlon(S)}t.editMarker(a)}},computeLatWithYclick:function(e){return e<.089655?20*e/.089655:e<.189655?20+20*(e-.089655)/.1:e<.327585?40+20*(e-.189655)/.13793:60+15*(e-.327585)/.172415},onClearCountries:function(){}};this.widget.setMouseOverCountryManager(),this.widget.setMouseOverMarkersManager(i);var o=t.widget.getGlobe().getSelection();o.length&&"Marker"===o[0].type&&t._topBar.setMarker(o[0]),e.markerInfo.show(!1,void 0,null)}},endExecute:function(){this.widget.getGlobe().use2D?(globe.markerAdditionOnClick(!1),globe.markerPopupOnClick(!0),globe.polygonPopupOnClick(!0)):(this.widget.getGlobe().clearMouseOver(),this.widget.getGlobe().clearSelection()),this.widget.setTopBar()}});return e.namespace("SocialGlobe/CmdAddMarker",l)}),
/*!
  Script: DSSocialGlobeUWA.js

    This file is part of UWA JS Runtime.

  About: License

    Copyright 2006-2013 Dassault Systèmes company.
    All rights reserved.
*/
window.DSSocialGlobe={},define("DS/SocialGlobe/UIMarkerEditor",["UWA/Core","UWA/Class","UWA/Controls/Abstract","DS/SocialGlobe/Globals","DS/Core/Events","UWA/Controls/Input","UWA/Controls/ColorPicker","DS/Windows/Panel","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/Controls/ColorPicker","DS/Controls/Toggle","DS/Controls/ButtonGroup","DS/WebappsUtils/WebappsUtils","DS/Controls/ComboBox","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/Controls/Button","DS/SocialGlobe/GlobeNotifications","DS/Controls/Popup","DS/SocialGlobe/UIMarkerSelector","DS/SocialGlobe/MarkerInfoManager","DS/SocialGlobe/assets/purify/purify.min"],function(e,t,i,o,s,n,r,a,l,h,c,d,u,g,p,m,f,v,b,w,y,M){"use strict";return t.extend({init:function(e,t,i,o,s,n){this._parent(t),this.options=t,this.enable=!1,this.globe=e,this.arraySelectName=[],this.selection=[],this.deleteMode={marker:!0,country:!1},this._cmdEndExecute=i,this._cmdSelectArea=o,this._runByCreatedMarkerCmd=n,this.container=this.buildSkeleton(),this._evtID="/SG/UICE/CMD/"+t.ID,this.noContainerRemove=!0,this.selectedMarker=s,this.globe.use2D&&(this.draggingEnabled=!1,this.applyOnClose=!1),this.setMarker(s)},buildSkeleton:function(){this.options;this.panelContent=new UWA.Element("div",{styles:{width:"100%",height:"100%"}});var e=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.panelContent),t=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Color"),styles:{width:"5em"}}).inject(e),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root-color"}).inject(e));this.globe.use2D?(this.leMarkerColor=new h({value:"143E5A",styles:{background:"#143E5A"}}).inject(t),this.leMarkerColor.addEventListener("liveChange",function(e){var t=this.selectedMarker.options.uuid;document.getElementById(t).setAttribute("fill","#"+e.dsModel.value)}.bind(this))):this.leMarkerColor=new h({value:"ffffff"}).inject(t);var i=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.panelContent),o=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Marker.Edit.Name"),styles:{width:"5em"}}).inject(i),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root"}).inject(i));return this.leName=new UWA.Controls.Input.Text({id:"markername"}).inject(o),this.buildLatLonInputs(this.panelContent),this.buildDescriptionSkeletun(this.panelContent),this.panel=new a({immersiveFrame:y.immersiveFrame,title:l.get("GlobeViewer.Marker.Edit.title"),content:this.panelContent,allowedDockAreas:0,snappableFlag:!1,identifier:"WUXPanel_MarkerEditor_"+y.webUXMarkerIdentifier}),this.panel.bringToFront(),this.addButtons(this.panelContent),this.globe.use2D&&this.panel.addEventListener("close",function(){if([...document.querySelectorAll('[wux-identifier^="WUXPanel_MarkerEditor_"]')].length<2&&(this.globe.openedEditMarker=!1),!this.applyOnClose&&!this._runByCreatedMarkerCmd){var e=this.selectedMarker.options.uuid;document.getElementById(e).setAttribute("fill",this.selectedMarker.style_properties.color)}}.bind(this)),this._runByCreatedMarkerCmd&&(this.panel.addEventListener("close",this._cmdEndExecute),this.globe.use2D&&this.panel.addEventListener("close",function(){this.validateInputs().ok&&this.applyOnClose?this.selectedMarker&&this.selectedMarker.dragging.disable():this.globe.map.removeLayer(this.selectedMarker)}.bind(this))),y.container},buildLatLonInputs:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block"}}).inject(e),i=new UWA.Element("li",{class:"wux-controls-switch-label",styles:{width:"5em"}}).inject(t);new UWA.Element("b",{html:l.get("GlobeViewer.Marker.Edit.Geolocation")}).inject(i);if(this.globe.use2D){var o=new c({type:"switch",label:"Edit coordinates by dragging",checkFlag:this.draggingEnabled}).inject(t);o.addEventListener("change",function(e){this.draggingEnabled=o.checkFlag,this.draggingEnabled?this.selectedMarker.dragging.enable():this.selectedMarker.dragging.disable()}.bind(this))}var s=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),n=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Marker.Create.Select.Latitude"),styles:{width:"5em"}}).inject(s),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root"}).inject(s));this.globe.use2D?this.leLatitude=new UWA.Controls.Input.Text({id:"latitude",attributes:{type:"number",min:"-85.0",max:"85.0"},events:{onChange:function(e){var t=new L.LatLng(parseFloat(e.target.value),parseFloat(this.leLongitude.getValue()));this.selectedMarker.setLatLng(t)}.bind(this)}}).inject(n):this.leLatitude=new UWA.Controls.Input.Text({id:"latitude",attributes:{type:"number",min:"-85.0",max:"85.0"}}).inject(n);var r=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),a=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Marker.Create.Select.Longitude"),styles:{width:"5em"}}).inject(r),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root"}).inject(r));this.globe.use2D?this.leLongitude=new UWA.Controls.Input.Text({id:"longitude",attributes:{type:"number",min:"-180.0",max:"180.0"},events:{onChange:function(e){var t=new L.LatLng(parseFloat(this.leLatitude.getValue()),parseFloat(e.target.value));this.selectedMarker.setLatLng(t)}.bind(this)}}).inject(a):this.leLongitude=new UWA.Controls.Input.Text({id:"longitude",attributes:{type:"number",min:"-180.0",max:"180.0"}}).inject(a)},addTextInputs:function(e){this.textDiv=new UWA.Element("div").inject(e);var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.textDiv),i=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type.Text"),styles:{width:"5em"}}).inject(t),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root"}).inject(t));this.leMarkerDesc=new UWA.Controls.Input.Text({id:"markerdescription",attributes:{placeholder:"Desc..."}}).inject(i);new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","min-height":"50px"}}).inject(this.textDiv)},addMarkedInputs:function(e){this.markedDiv=new UWA.Element("div",{styles:{display:"None"}}).inject(e);var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.markedDiv),i=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type.TextArea"),styles:{width:"5em"}}).inject(t),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root"}).inject(t));this.leMarkerMarkdown=new UWA.Element("textarea",{styles:{resize:"vertical",width:"14.7em","min-height":"83px"},attributes:{placeholder:"Desc..."}}).inject(i)},addHtmlInputs:function(e){this.htmlDiv=new UWA.Element("div",{styles:{display:"None"}}).inject(e);var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.htmlDiv),i=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type.URL"),styles:{width:"5em"}}).inject(t),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root-help"}).inject(t));this.htmlURLText=new UWA.Controls.Input.Text({id:"markerurl",attributes:{placeholder:"URL...",type:"url"}}).inject(i);var o=new UWA.Element("span",{html:"",class:"uwa-input-button display-help-button",styles:{background:"url("+u.getWebappsAssetUrl("SocialGlobe","icons/32/I_CFHelp.png")+")"}}).inject(i);this.buildHelpSkeletun(o);var s=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","min-height":"50px"}}).inject(this.htmlDiv),n=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{"padding-bottom":"10px",display:"inline-block","max-width":"14em"}}).inject(s),r=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type.Width"),styles:{width:"4em"}}).inject(n),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-inline-double"}).inject(n));this.leWidthDesc=new UWA.Controls.Input.Text({id:"iframe-width",attributes:{type:"number",step:"1"},value:"300"}).inject(r);var a=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{"padding-bottom":"10px",display:"inline-block","max-width":"14em"}}).inject(s),h=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type.Height"),styles:{width:"4em"}}).inject(a),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-inline-double"}).inject(a));this.leHeightDesc=new UWA.Controls.Input.Text({id:"iframe-height",attributes:{type:"number",step:"1"},value:"300"}).inject(h);var d=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.htmlDiv);this.persistToggle=new c({type:"switch",label:l.get("GlobeViewer.Marker.Edit.PersistFrame"),checkFlag:!1}),this.persistToggle.inject(d)},buildHelpSkeletun:function(e){var t=new UWA.Element("div",{class:"wux-controls-switch-container inner-width",styles:{width:"100%",height:"100%"}}),i=l.get("GlobeViewer.Areas.Edit.Help.URL");new UWA.Element("p",{html:i,class:"wux-controls-switch-container inner-width",styles:{width:"100%",height:"100%"}}).inject(t);return new b({target:e,trigger:"click"}).setBody(t)},buildDescriptionSkeletun:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block"}}).inject(e),i=new UWA.Element("li",{class:"wux-controls-switch-label",styles:{width:"5em"}}).inject(t),o=(new UWA.Element("b",{html:l.get("GlobeViewer.Areas.Editor.Description.Group")}).inject(i),new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e)),s=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type"),styles:{width:"5em"}}).inject(o),new UWA.Element("li").inject(o));this.descriptionTypeButtonGroup=new d({type:"radio"}).inject(s);var n=new c({type:"radio",class:"country-inline",label:l.get("GlobeViewer.Areas.Editor.Description.Type.Text"),value:0,checkFlag:!0});n.elements.container.classList.add("country-inline");var r=new c({type:"radio",label:l.get("GlobeViewer.Areas.Editor.Description.Type.Html"),value:1});r.elements.container.classList.add("country-inline");var a=new c({type:"radio",label:l.get("GlobeViewer.Areas.Editor.Description.Type.Marked"),value:2});a.elements.container.classList.add("country-inline"),this.descriptionTypeButtonGroup.addChild(n),this.descriptionTypeButtonGroup.addChild(r),this.descriptionTypeButtonGroup.addChild(a),this.descriptionTypeButtonGroup.addEventListener("change",function(e){var t=e.dsModel.value[0];1==t?(this.textDiv.hide(),this.markedDiv.hide(),this.htmlDiv.show()):2==t?(this.textDiv.hide(),this.htmlDiv.hide(),this.markedDiv.show()):(this.markedDiv.hide(),this.htmlDiv.hide(),this.textDiv.show())}.bind(this)),this.addTextInputs(e),this.addHtmlInputs(e),this.addMarkedInputs(e)},addButtons:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),i=new UWA.Element("li",{class:"country-buttons"}).inject(t);new f({domId:"apply-button",label:l.get("GlobeViewer.Areas.Editor.Apply"),emphasize:"primary",onClick:this.apply.bind(this)}).inject(i),new f({label:l.get("GlobeViewer.Areas.Editor.Remove"),emphasize:"secondary",onClick:this.remove.bind(this)}).inject(i)},setMarker:function(e){if(this.globe.use2D&&e.on("drag",function(){this.leLatitude.setValue(e._latlng.lat.toFixed(5)),this.leLongitude.setValue(e._latlng.lng.toFixed(5))}.bind(this)),e){switch(this.selectedMarker=e,this.leName.setValue(e.title?e.title:""),this.globe.use2D?(this.leLatitude.setValue(e._latlng.lat.toFixed(5)),this.leLongitude.setValue(e._latlng.lng.toFixed(5))):(this.leLatitude.setValue(e.lat.toFixed(5)),this.leLongitude.setValue(e.lon.toFixed(5))),e.descriptionType){case"text":this.descriptionTypeButtonGroup.selectIndex(0);break;case"html":this.descriptionTypeButtonGroup.selectIndex(1);break;case"marked":this.descriptionTypeButtonGroup.selectIndex(2)}"text"===e.descriptionType?this.leMarkerDesc.setValue(e.description?e.description:""):"marked"===e.descriptionType&&(this.leMarkerMarkdown.value=e.description?e.description:""),this.htmlURLText.setValue(e.link?e.link:""),this.leWidthDesc.setValue(e.width?e.width:"300"),this.leHeightDesc.setValue(e.height?e.height:"300");void 0!==o.theme?o.theme:o.defaultTheme;var t=e.image;if(t||(t=u.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/natural/marker/markerBack128.png")),this.globe.use2D){var i="#143E5A";e&&e.style_properties.color&&(i=e.style_properties.color)}else{i="#ff0000";e&&e.color&&(i=e.color)}this.leMarkerColor.value=i.replace("#",""),this.persistToggle.checkFlag=e.persist}else this.selectedMarker=void 0,this.leName.setValue(""),this.leLatitude.setValue(""),this.leLongitude.setValue(""),this.lineZ.setValue(""),this.leMarkerDesc.setValue(""),this.htmlURLText.setValue(""),this.leWidthDesc.setValue("300"),this.leHeightDesc.setValue("300"),this.leMarkerMarkdown.value="",this.persistToggle.checkFlag=!1},remove:function(){this.globe.use2D?(this.selectedMarker&&(this.selectedObject=this.selectedMarker,this.objectType="marker"),this.globe.map.removeLayer(this.selectedObject),0==this.globe.getMarkersNb()&&this._cmdEndExecute()):(this.selectedMarker.persist&&y.removeMarkerInfo(this.selectedMarker.uuid,!1),this.globe.getDataModel().deleteSelection([this.selectedMarker],this.deleteMode),this.clearDescriptionInputs(),0===this.globe.markerBag.getMarkersSize()&&this._cmdEndExecute()),this.panel.close()},validateInputs:function(){if(this.selectedMarker){var e=this.leLatitude.getValue(),t=this.leLongitude.getValue();if(void 0===e||""===e||isNaN(e)||parseFloat(e)<-85||parseFloat(e)>85)return{ok:!1,error:new Error(l.get("GlobeViewer.Marker.Create.Select.Notification.Error.InvalidLatitude"))};if(void 0===t||""===t||isNaN(t)||parseFloat(t)<-180||parseFloat(t)>180)return{ok:!1,error:new Error(l.get("GlobeViewer.Marker.Create.Select.Notification.Error.InvalidLongitude"))}}if(!this.htmlEncode(this.leName.getValue()))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidName"))};var i=this.descriptionTypeButtonGroup;if(1==i.value[0]){var o=this.htmlEncode(this.htmlURLText.getValue()),s=this.htmlEncode(this.leWidthDesc.getValue()),n=this.htmlEncode(this.leHeightDesc.getValue());this.htmlEncode(this.leName.getValue());if(void 0!==o&&!UWA.Utils.isValidUrl(o)||!o&&(""!==s||""!==n))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidLink"))};if(void 0!==s&&isNaN(s))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidWidth"))};if(void 0!==n&&isNaN(n))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidHeight"))}}else if(2==i.value[0]){var r=this.leMarkerMarkdown.value;if(void 0!==r&&!UWA.is(r,"string"))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidDescription"))}}else{var a=this.leMarkerDesc.getValue();if(void 0!==(a=this.htmlEncode(a))&&!UWA.is(a,"string"))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidDescription"))}}return{ok:!0}},apply:function(){var e=this.validateInputs();if(this.selectedMarker&&(this.selectedObject=this.selectedMarker,this.objectType="marker"),e.ok){if(this.selectedObject){if(this.globe.use2D){if(this.selectedObject.style_properties.color="#"+this.leMarkerColor.value,this.currentUuid=this.selectedObject.options.uuid,"marker"===this.objectType)document.getElementById(this.currentUuid).setAttribute("fill",this.selectedObject.style_properties.color)}else this.selectedMarker.setColor("#"+this.leMarkerColor.value);this.selectedObject.title=this.htmlEncode(this.leName.getValue());var t=this.descriptionTypeButtonGroup;if(1===t.value[0]?(this.selectedObject.descriptionType="html",this.selectedObject.link=this.htmlEncode(this.htmlURLText.getValue()),this.selectedObject.width=this.leWidthDesc.getValue(),this.selectedObject.height=this.leHeightDesc.getValue()):2===t.value[0]?(this.selectedObject.descriptionType="marked",this.selectedObject.description=this.leMarkerMarkdown.value,this.selectedObject.width=void 0,this.selectedObject.height=void 0):(this.selectedObject.descriptionType="text",this.selectedObject.description=this.htmlEncode(this.leMarkerDesc.getValue()),this.selectedObject.width=void 0,this.selectedObject.height=void 0),this.globe.use2D){if(this.selectedObject.getPopup()?this.globe.editPopup(this.selectedObject):this.globe.setBehavior(this.selectedObject),"marker"===this.objectType){var i=new L.LatLng(parseFloat(this.leLatitude.getValue()),parseFloat(this.leLongitude.getValue()));this.selectedObject.setLatLng(i)}this.applyOnClose=!0,this.selectedObject.dragging.disable()}else this.selectedMarker.setPositionFromLatLon(parseFloat(this.leLatitude.getValue()),parseFloat(this.leLongitude.getValue())),this.selectedObject.persist&&y.removeMarkerInfo(this.selectedObject.uuid,!1),this.selectedObject.persist=this.persistToggle.checkFlag,this.selectedObject.isEdited=!0,1===this.descriptionTypeButtonGroup.value[0]&&this.persistToggle.checkFlag&&y.addMarkerInfo(this.selectedObject)}this.panel.close()}else{var o=e.error;o.title=l.get("GlobeViewer.Marker.Edit.Notification.Error.InputError"),o.subtitle=l.get("GlobeViewer.Areas.Edit.Notification.Error.ContentAdditionError"),v.display({level:"error",title:o.title,subtitle:o.subtitle,message:o.message})}return e.ok},clearDescriptionInputs:function(){this.descriptionTypeButtonGroup.selectIndex(0),this.htmlURLText.setValue(void 0),this.leWidthDesc.setValue(void 0),this.leHeightDesc.setValue(void 0),this.leMarkerDesc.setValue(void 0),this.persistToggle.checkFlag=!1,this.leMarkerMarkdown.value=""},clearSelection:function(){var e=this;this.selection.map(function(t){-1===e.manager.getSelectedCountries().indexOf(t)&&t.setHtmlColor(null)}),this.selection=[]},getColor:function(){return this.leMarkerColor.value},htmlEncode:function(e){return M.sanitize(e)}})}),define("DS/SocialGlobe/CmdEditMarker",["UWA/Core","DS/ApplicationFrame/Command","DS/SocialGlobe/UIMarkerEditor","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Globals","DS/Core/Events","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/SocialGlobe/GlobeNotifications"],function(e,t,i,o,s,n,r,a){"use strict";var l=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0}),this.runByCreatedMarkerCmd=!1,this.widget=this.getFrameWindow().globe;var t=this;WUX.Events.subscribe({event:"/SG/UICE/CMD//ColorMarker/EDIT"},function(e){if(!t.widget.getGlobe().use2D){if(!e||!e.marker)return;t.widget.getGlobe().setSelection([e.marker])}e.fromCreateMarker?(t.runByCreatedMarkerCmd=!0,t.createUI(e.marker),t.begin()):t.widget.getGlobe().use2D&&t.createUI(e.marker)})},selectArea:function(e){this.widget.getGlobe().setSelection([e])},createUI:function(e){var t=this.widget.getGlobe();this.widget.topBars.MarkerEditor=new i(t,{ID:"EditMarker"},this.end.bind(this),this.selectArea.bind(this),e,this.runByCreatedMarkerCmd),this._topBar=this.widget.topBars.MarkerEditor,t.openedEditMarker=!0},beginExecute:function(){var e=this.widget.getGlobe();if(e.use2D){var t=e.getMarkersNb();if(e.markerDetailsOnClick(!0),e.markerPopupOnClick(!1),e.polygonPopupOnClick(!1),!this.runByCreatedMarkerCmd)if(!t)(i=new Error(r.get("GlobeViewer.Marker.Info.Edit.NoDataError"))).title=r.get("GlobeViewer.Marker.Info.Edit.CreateDataError"),i.subtitle=r.get("GlobeViewer.Marker.Info.Edit.NoSelectedError"),a.display({level:"info",title:i.title,subtitle:i.subtitle,message:i.message}),this.end(),this.done()}else{var i;t=e.markerBag.getMarkersSize();if(!this.runByCreatedMarkerCmd&&!t)(i=new Error(r.get("GlobeViewer.Marker.Info.Edit.NoDataError"))).title=r.get("GlobeViewer.Marker.Info.Edit.CreateDataError"),i.subtitle=r.get("GlobeViewer.Marker.Info.Edit.NoSelectedError"),a.display({level:"info",title:i.title,subtitle:i.subtitle,message:i.message}),this.end(),this.done();this.runByCreatedMarkerCmd&&(this.runByCreatedMarkerCmd=!1)}},execute:function(){this.widget.helpDisplayed&&this.widget.displayHelp(!1);var e=this.widget.getGlobe();e.clearMouseOver(),this.widget.setTopBar("MarkerEditor");var t=this;if(!e.use2D){e.markerBag;var i={onMouseMove:function(t,i,o){t.length?e.getDataModel().hover(t[0]):e.getDataModel().hover()},onMouseOut:function(){},onMouseDoubleClick:function(e,t,i){},onMouseClick:function(e,i,o){e.length&&(t.createUI(e[0]),t.widget.setTopBar("MarkerEditor"),t._topBar.setMarker(e[0]),t.widget.getGlobe().setSelection(e))},computeLatWithYclick:function(e){return e<.089655?20*e/.089655:e<.189655?20+20*(e-.089655)/.1:e<.327585?40+20*(e-.189655)/.13793:60+15*(e-.327585)/.172415},onClearCountries:function(){}};this.widget.setMouseOverCountryManager(),this.widget.setMouseOverMarkersManager(i);var o=t.widget.getGlobe().getSelection();o.length&&"Marker"===o[0].type&&t._topBar&&t._topBar.setMarker(o[0]),e.markerInfo.show(!1,void 0,null)}},endExecute:function(){var e=this.widget.getGlobe();e.use2D?(e.markerDetailsOnClick(!1),e.markerPopupOnClick(!0),e.polygonPopupOnClick(!0)):(e.clearMouseOver(),e.clearSelection()),this.widget.setTopBar(),this.runByCreatedMarkerCmd&&(this.runByCreatedMarkerCmd=!1)}});return e.namespace("SocialGlobe/CmdEditMarker",l)}),define("DS/SocialGlobe/CmdPublish",["UWA/Core","DS/ApplicationFrame/Command","DS/SocialGlobe/UIMarkerEditor","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Globals","DS/SocialGlobe/Marker"],function(e,t,i,o,s,n){"use strict";var r=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},beginExecute:function(){this.widget=this.getFrameWindow().globe,this.widget.widget.setValue("editMode","false")},execute:function(){},endExecute:function(){this.widget.widget.setValue("editMode","true")}});return e.namespace("SocialGlobe/CmdPublish",r)}),
/*!
  Script: DSSocialGlobeUWA.js

    This file is part of UWA JS Runtime.

  About: License

    Copyright 2006-2013 Dassault Systèmes company.
    All rights reserved.
*/
window.DSSocialGlobe={},define("DS/SocialGlobe/UICountryEditor",["UWA/Core","UWA/Class","UWA/Controls/Abstract","DS/SocialGlobe/Globals","DS/Core/Events","UWA/Controls/Input","UWA/Controls/ColorPicker","DS/Windows/Panel","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/Controls/ColorPicker","DS/Controls/Toggle","DS/Controls/ButtonGroup","DS/WebappsUtils/WebappsUtils","DS/Controls/ComboBox","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/Controls/Button","DS/SocialGlobe/GlobeNotifications","DS/Controls/Popup","DS/SocialGlobe/MarkerInfoManager","DS/SocialGlobe/assets/purify/purify.min"],function(e,t,i,o,s,n,r,a,l,h,c,d,u,g,p,m,f,v,b,w,y){"use strict";return t.extend({init:function(e,t,i,o,s,n){this._parent(t),this.options=t,this.enable=!1,this.globe=e,this.manager=e.getCountryManager(),this.arraySelectName=[],this.selection=[],this._cmdEndExecute=i,this._cmdSelectArea=o,this._runByCreatedAreaCmd=n,this.container=this.buildSkeleton(),this._evtID="/SG/UICE/CMD/"+t.ID,this.noContainerRemove=!0,this.globe.use2D?(this.selectedPolygon=s,this.setPolygon(s)):s&&this.setCountry(s)},buildSkeleton:function(){this.options;this.panelContent=new UWA.Element("div",{styles:{width:"100%",height:"100%"}});var e=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.panelContent);new UWA.Element("li",{class:"wux-controls-switch-label",html:this.globe.use2D?"Name":l.get("GlobeViewer.Areas.Editor.country"),styles:{width:"5em"}}).inject(e);if(this.globe.use2D){var t=new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root"}).inject(e);this.lePolygonName=new UWA.Controls.Input.Text({id:"polygonname"}).inject(t)}else{var i=new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root"}).inject(e);this.arraySelectName=new p;for(var s=Object.keys(this.manager.ISO3Table).sort(function(e,t){var i=o.countries[e],s=o.countries[t];return i<s?-1:i>s?1:0}),n=0;n<s.length;n++){var r=s[n];r&&this.arraySelectName.addChild(new m({label:o.countries[r],iso3:r,value:this.manager.ISO3Table[r]}))}this.arraySelectName.expandAll(),this.leCountryName=new g({enableSearchFlag:!0,elementsTree:this.arraySelectName,displayStyle:"normal"}).inject(i),this.leCountryName.addEventListener("change",this.changeCountry.bind(this))}if(this.globe.use2D){var c=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","min-height":"50px"}}).inject(this.panelContent);f=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"inline-block","padding-bottom":"10px"}}).inject(c),new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Color"),styles:{width:"4em"}}).inject(f),v=new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root-color",styles:{"min-width":"5em"}}).inject(f);this.leCountryColor=new h({value:"448FAB"}).inject(v),this.leCountryColor.addEventListener("liveChange",function(e){this.selectedPolygon.setStyle({fillColor:"#"+e.dsModel.value,fillOpacity:.7})}.bind(this));var d=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"inline-block","padding-bottom":"10px"}}).inject(c),u=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"Stroke Color",styles:{width:"7em"}}).inject(d),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root-color",styles:{"min-width":"7em"}}).inject(d));this.lePolygonStrokeColor=new h({value:"3388FF"}).inject(u),this.lePolygonStrokeColor.addEventListener("liveChange",function(e){this.selectedPolygon.setStyle({color:"#"+e.dsModel.value,fillOpacity:.7})}.bind(this))}else{var f=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.panelContent),v=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Color"),styles:{width:"5em"}}).inject(f),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root-color"}).inject(f));this.leCountryColor=new h({value:"ffffff"}).inject(v)}return this.buildDescriptionSkeletun(this.panelContent),this.panel=new a({immersiveFrame:w.immersiveFrame,title:l.get("GlobeViewer.Areas.Editor.title"),content:this.panelContent,allowedDockAreas:WUXDockAreaEnum.NoneDockArea,snappableFlag:!1,identifier:"WUXPanel_CountryEditor_"+w.webUXCountryIdentifier}),this.panel.bringToFront(),this.addButtons(this.panelContent),this._runByCreatedAreaCmd&&this.panel.addEventListener("close",this._cmdEndExecute),this.globe.use2D&&this.panel.addEventListener("close",function(){this.validateInputs().ok||this.globe.map.removeLayer(this.selectedPolygon)}.bind(this)),w.container},setCountry:function(e,t){if(this.selectedMarker=e,this.clearSelection(),e&&e.ISO3.length){this.selection.push(e);for(var i=!1,s=1;s<this.arraySelectName.getChildren().length&&!i;s++)this.arraySelectName.getChildren()[s].options.iso3===e.ISO3[0]&&(this.leCountryName.value=o.countries[e.ISO3[0]],i=!0)}else this.leCountryName.value="";var n="#ff0000";if(e&&e.color&&(n=o.rgbToHtml(e.color),this.leCountryColor.value=n.replace("#","")),e&&(this.persistToggle.checkFlag=e.persist),e&&e.descriptionType)switch(e.descriptionType){case"text":this.descriptionTypeButtonGroup.selectIndex(0),e.description&&this.leCountryDesc.setValue(e.description);break;case"html":this.descriptionTypeButtonGroup.selectIndex(1),e.link&&this.htmlURLText.setValue(e.link),void 0!==e.width&&this.leWidthDesc.setValue(e.width),void 0!==e.height&&this.leHeightDesc.setValue(e.height);break;case"marked":this.descriptionTypeButtonGroup.selectIndex(2),e.description&&(this.leMarkerMarkdown.value=polygon.description)}},setPolygon:function(e,t){if(e){switch(console.log(e),this.selectedPolygon=e,this.lePolygonName.setValue(e.title?e.title:""),e.descriptionType){case"text":this.descriptionTypeButtonGroup.selectIndex(0);break;case"html":this.descriptionTypeButtonGroup.selectIndex(1);break;case"marked":this.descriptionTypeButtonGroup.selectIndex(2)}"text"===e.descriptionType?this.leCountryDesc.setValue(e.description?e.description:""):"marked"===e.descriptionType&&(this.leCountryMarkdown.value=e.description?e.description:""),this.htmlURLText.setValue(e.link?e.link:""),this.leWidthDesc.setValue(e.width?e.width:"300"),this.leHeightDesc.setValue(e.height?e.height:"300");void 0!==o.theme?o.theme:o.defaultTheme;var i=e.image;i||(i=u.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/natural/marker/markerBack128.png"));var s="#448FAB";e&&e.style_properties.color&&(s=e.style_properties.color),this.leCountryColor.value=s.replace("#","");var n="#006698";e&&e.strokeColor&&(n=e.strokeColor),this.lePolygonStrokeColor.value=n.replace("#","")}else this.selectedPolygon=void 0,this.lePolygonName.setValue(""),this.leCountryDesc.setValue(""),this.htmlURLText.setValue(""),this.leWidthDesc.setValue("300"),this.leHeightDesc.setValue("300"),this.leCountryMarkdown.value="",this.persistToggle.checkFlag=!1},changeCountry:function(){this.clearSelection();for(var e=this.arraySelectName.getSelectedNodes(),t=0;t<e.length;t++){var i=e[t].options.iso3;this.selection.push(this.manager.get(this.manager.getIndexFromISO3(i)))}this.selection[0].persist&&w.removeMarkerInfo(this.selection[0].uuid,!1),this.selection[0].color&&(this.leCountryColor.value=o.rgbToHtml(this.selection[0].color).replace("#","")),this.persistToggle.checkFlag=this.selection[0].persist,this.selection[0].ID&&(s.publish({event:this._evtID+"/SELECT",data:this.selection[0]}),this._cmdSelectArea(this.selection[0]))},addTextInputs:function(e){this.textDiv=new UWA.Element("div").inject(e);var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.textDiv),i=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type.Text"),styles:{width:"60px"}}).inject(t),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root"}).inject(t));this.leCountryDesc=new UWA.Controls.Input.Text({attributes:{placeholder:"Desc..."}}).inject(i);new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","min-height":"50px"}}).inject(this.textDiv)},addMarkedInputs:function(e){this.markedDiv=new UWA.Element("div",{styles:{display:"None"}}).inject(e);var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.markedDiv),i=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type.TextArea"),styles:{width:"5em"}}).inject(t),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root"}).inject(t));this.leMarkerMarkdown=new UWA.Element("textarea",{styles:{resize:"vertical",width:"14.7em","min-height":"83px"},attributes:{placeholder:"Desc..."}}).inject(i)},addHtmlInputs:function(e){this.htmlDiv=new UWA.Element("div",{styles:{display:"None"}}).inject(e);var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.htmlDiv),i=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type.URL"),styles:{width:"5em"}}).inject(t),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-root-help"}).inject(t));this.htmlURLText=new UWA.Controls.Input.Text({attributes:{placeholder:"URL...",type:"url"}}).inject(i);var o=new UWA.Element("span",{html:"",class:"uwa-input-button display-help-button",styles:{background:"url("+u.getWebappsAssetUrl("SocialGlobe","icons/32/I_CFHelp.png")+")"}}).inject(i);this.buildHelpSkeletun(o);var s=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","min-height":"50px"}}).inject(this.htmlDiv),n=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{"padding-bottom":"10px",display:"inline-block","max-width":"14em"}}).inject(s),r=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type.Width"),styles:{width:"4em"}}).inject(n),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-inline-double"}).inject(n));this.leWidthDesc=new UWA.Controls.Input.Text({attributes:{type:"number",step:"1"},value:"300"}).inject(r);var a=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{"padding-bottom":"10px",display:"inline-block","max-width":"14em"}}).inject(s),h=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type.Height"),styles:{width:"4em"}}).inject(a),new UWA.Element("li",{class:"uwa-select uwa-select-root uwa-input uwa-input-root globe-uwa-input-inline-double"}).inject(a));this.leHeightDesc=new UWA.Controls.Input.Text({attributes:{type:"number",step:"1"},value:"300"}).inject(h);var d=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.htmlDiv);this.persistToggle=new c({type:"switch",label:l.get("GlobeViewer.Marker.Edit.PersistFrame"),checkFlag:!1}),this.persistToggle.inject(d)},buildHelpSkeletun:function(e){var t=new UWA.Element("div",{class:"wux-controls-switch-container inner-width",styles:{width:"100%",height:"100%"}}),i=l.get("GlobeViewer.Areas.Edit.Help.URL");new UWA.Element("p",{html:i,class:"wux-controls-switch-container inner-width",styles:{width:"100%",height:"100%"}}).inject(t);return new b({target:e,trigger:"click"}).setBody(t)},buildDescriptionSkeletun:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block"}}).inject(e),i=new UWA.Element("li",{class:"wux-controls-switch-label",styles:{width:"5em"}}).inject(t),o=(new UWA.Element("b",{html:l.get("GlobeViewer.Areas.Editor.Description.Group")}).inject(i),new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e)),s=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.Description.Type"),styles:{width:"5em"}}).inject(o),new UWA.Element("li").inject(o));this.descriptionTypeButtonGroup=new d({type:"radio"}).inject(s);var n=new c({type:"radio",class:"country-inline",label:l.get("GlobeViewer.Areas.Editor.Description.Type.Text"),value:0,checkFlag:!0});n.elements.container.classList.add("country-inline");var r=new c({type:"radio",label:l.get("GlobeViewer.Areas.Editor.Description.Type.Html"),value:1});r.elements.container.classList.add("country-inline");var a=new c({type:"radio",label:l.get("GlobeViewer.Areas.Editor.Description.Type.Marked"),value:2});a.elements.container.classList.add("country-inline"),this.descriptionTypeButtonGroup.addChild(n),this.descriptionTypeButtonGroup.addChild(r),this.descriptionTypeButtonGroup.addChild(a),this.descriptionTypeButtonGroup.addEventListener("change",function(e){var t=e.dsModel.value[0];1==t?(this.textDiv.hide(),this.markedDiv.hide(),this.htmlDiv.show()):2==t?(this.textDiv.hide(),this.htmlDiv.hide(),this.markedDiv.show()):(this.markedDiv.hide(),this.htmlDiv.hide(),this.textDiv.show())}.bind(this)),this.addTextInputs(e),this.addHtmlInputs(e),this.addMarkedInputs(e)},addButtons:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),i=new UWA.Element("li",{class:"country-buttons"}).inject(t);new f({label:l.get("GlobeViewer.Areas.Editor.Apply"),emphasize:"primary",onClick:this.apply.bind(this)}).inject(i),new f({label:l.get("GlobeViewer.Areas.Editor.Remove"),emphasize:"secondary",onClick:this.remove.bind(this)}).inject(i)},remove:function(){var e=this;this.selectedMarker?(this.selection.map(function(t){t.persist&&(w.removeMarkerInfo(t.uuid,!1),t.uuid=void 0,t.persist=!1);var i=e.manager.getSelectedCountries().map(function(e){return e.getTitle()[0]}).indexOf(t.getTitle()[0]);-1!==i&&e.manager.getSelectedCountries().splice(i,1),t.setHtmlColor(null),t.initDescription(),t.isEdited=!1}),this.clearDescriptionInputs(),this.globe.clearSelection(),this.panel.close(),0===e.manager.getCountries().length&&this._cmdEndExecute()):this.selectedPolygon&&(this.globe.map.removeLayer(this.selectedPolygon),0==this.globe.getPolygonsNb()&&this._cmdEndExecute(),this.panel.close())},validateInputs:function(){if(this.globe.use2D&&!this.htmlEncode(this.lePolygonName.getValue()))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidName"))};var e=this.descriptionTypeButtonGroup;if(1==e.value[0]){var t=this.htmlURLText.getValue(),i=this.leWidthDesc.getValue(),o=this.leHeightDesc.getValue();if(void 0!==t&&!UWA.Utils.isValidUrl(t)||!t&&(""!==i||""!==o))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidLink"))};if(void 0!==i&&isNaN(i))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidWidth"))};if(void 0!==o&&isNaN(o))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidHeight"))}}else if(2==e.value[0]){var s=this.leMarkerMarkdown.value;if(void 0!==s&&!UWA.is(s,"string"))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidDescription"))}}else{var n=this.leCountryDesc.getValue();if(void 0!==n&&!UWA.is(n,"string"))return{ok:!1,error:new Error(l.get("GlobeViewer.Areas.Edit.Notification.Error.InvalidDescription"))}}return{ok:!0}},apply:function(){var e=this,t=this.validateInputs();if(t.ok){if(this.selectedMarker)this.selectedMarker.setHtmlColor(null),this.selectedMarker.initDescription(),this.selectedMarker.isEdited=!1,this.selection.map(function(t){t.setHtmlColor("#"+e.leCountryColor.value);var i=e.descriptionTypeButtonGroup;1===i.value[0]?(t.descriptionType="html",t.link=e.htmlURLText.getValue(),t.width=e.leWidthDesc.getValue(),t.height=e.leHeightDesc.getValue(),t.uuid=void 0):2===i.value[0]?(t.descriptionType="marked",t.description=e.leMarkerMarkdown.value,t.width=void 0,t.height=void 0):(t.descriptionType="text",t.description=e.leCountryDesc.getValue()),e.manager.getSelectedCountries().push(t),t.persist&&w.removeMarkerInfo(t.uuid,!1),t.persist=e.persistToggle.checkFlag,1===e.descriptionTypeButtonGroup.value[0]&&e.persistToggle.checkFlag&&w.addMarkerInfo(t,!0),t.isEdited=!0});else if(this.selectedPolygon){this.selectedPolygon.style_properties.color="#"+this.leCountryColor.value,this.selectedPolygon.strokeColor="#"+this.lePolygonStrokeColor.value,this.selectedPolygon.setStyle({fillColor:this.selectedPolygon.style_properties.color,color:this.selectedPolygon.strokeColor,fillOpacity:.7}),this.selectedPolygon.title=this.htmlEncode(this.lePolygonName.getValue());var i=this.descriptionTypeButtonGroup;1===i.value[0]?(this.selectedPolygon.descriptionType="html",this.selectedPolygon.link=this.htmlEncode(this.htmlURLText.getValue()),this.selectedPolygon.width=this.leWidthDesc.getValue(),this.selectedPolygon.height=this.leHeightDesc.getValue()):2===i.value[0]?(this.selectedPolygon.descriptionType="marked",this.selectedPolygon.description=this.leMarkerMarkdown.value,this.selectedPolygon.width=void 0,this.selectedPolygon.height=void 0):(this.selectedPolygon.descriptionType="text",this.selectedPolygon.description=this.htmlEncode(this.leCountryDesc.getValue()),this.selectedPolygon.width=void 0,this.selectedPolygon.height=void 0),this.selectedPolygon.getPopup()?this.globe.editPopup(this.selectedPolygon):this.globe.setBehavior(this.selectedPolygon)}this.panel.close()}else{var o=t.error;o.title=l.get("GlobeViewer.Areas.Edit.Notification.Error.InputError"),o.subtitle=l.get("GlobeViewer.Areas.Edit.Notification.Error.ContentAdditionError"),v.display({level:"error",title:o.title,subtitle:o.subtitle,message:o.message})}return t.ok},clearDescriptionInputs:function(){this.descriptionTypeButtonGroup.selectIndex(0),this.htmlURLText.setValue(void 0),this.leWidthDesc.setValue(void 0),this.leHeightDesc.setValue(void 0),this.leCountryDesc.setValue(void 0),this.leMarkerMarkdown.value="",this.persistToggle.checkFlag=!1},clearSelection:function(){var e=this;this.selection.map(function(t){-1===e.manager.getSelectedCountries().indexOf(t)&&e.selectedMarker!==t&&t.setHtmlColor(null)}),this.selection=[]},getColor:function(){return this.leCountryColor.value},htmlEncode:function(e){return y.sanitize(e)}})}),define("DS/SocialGlobe/CountryManager",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Utils","DS/SocialGlobe/Globals","marked/marked","DS/SocialGlobe/assets/purify/purify.min"],function(e,t,i,o,s,n){"use strict";var r=e.extend({init:function(e,t,i){this._manager=e,this.ID=t,this.ISO3=i,this.title=i,this.infos=null,this.color=null,this.colorOverride=null,this.initDescription(),this.isEdited=!1,this.persist=!1},initDescription:function(){this.descriptionType="text",this.description="",this.link=void 0,this.width=void 0,this.height=void 0},getID:function(e){return this.ID},type:"Country",getTitle:function(){return this.ISO3},getDescription:function(){return this.description},htmlDefined:function(){return!1},htmlContent:function(){var e=this.description;return"marked"===this.descriptionType&&(e=s(this.description),e=this.htmlEncode(e)),o.countries?(void 0!==this.title&&""!==this.title?"<b>"+o.countries[this.title]+"</b><br>":"")+e:(void 0!==this.title&&""!==this.title?"<b>"+this.title+"</b><br>":"")+e},setColor:function(e){return this.color=e,this._manager&&this._manager.refreshCountry(this.ID),this},overrideHtmlColor:function(e){return this.colorOverride=e?o.htmlToRGB(e):null,this._manager&&this._manager.refreshCountry(this.ID),this},getHtmlColor:function(){return this.color?o.rgbToHtml(this.color):""},setHtmlColor:function(e){return this.color=e?o.htmlToRGB(e):null,this._manager&&this._manager.refreshCountry(this.ID),this},isValidContent:function(){return void 0!==this.title&&""!==this.title||void 0!==this.description&&""!==this.description||void 0!==this.link&&""!==this.link},htmlEncode:function(e){return n.sanitize(e)}});return e.extend({init:function(e){this._scene=e,this.countries=[],this.selectedCountries=[],this.ISO3Table={ABW:0,AFG:1,AGO:2,AIA:3,ALB:4,ALA:5,ARE:7,ARG:8,ATF:10,ATG:11,AUS:12,AUT:13,AZE:14,BDI:15,BEL:16,BEN:17,BFA:18,BGD:19,BGR:20,BHR:21,BHS:22,BIH:23,BLM:24,BLR:25,BLZ:26,BMU:27,BOL:28,BRA:29,BRB:30,BRN:31,BTN:32,BWA:33,CAF:34,CHE:35,CHN:36,CIV:37,CMR:38,COD:39,COG:40,COK:41,COL:42,COM:43,CPV:44,CRI:45,CUB:46,CUW:47,CYM:48,CYP:50,CZE:51,DEU:52,DJI:53,DMA:54,DNK:55,DOM:56,DZA:57,EGY:58,ERI:59,ESP:60,EST:61,ETH:62,FIN:63,FJI:64,FLK:65,FRA:66,FRO:67,FSM:68,GAB:69,GBR:71,GEO:72,GHA:73,GIN:74,GMB:75,GNB:76,GNQ:77,GRC:78,GRD:79,GRL:80,GTM:81,GUM:82,GUY:83,HKG:84,HMD:85,HND:86,HRV:87,HTI:88,HUN:89,IDN:90,IMN:91,IND:92,IOT:94,IRL:95,IRN:96,IRQ:97,ISL:98,ISR:99,ITA:100,JAM:101,JEY:102,JOR:103,JPN:104,KAZ:105,KEN:106,KGZ:107,KHM:108,KIR:109,KNA:110,KOR:111,KWT:113,LAO:114,LBN:115,LBR:116,LBY:117,LCA:118,LIE:119,LKA:120,LSO:121,LTU:122,LUX:123,LVA:124,MAF:125,MAR:126,MDA:127,MDG:128,MDV:129,MEX:130,MHL:131,MKD:132,MLI:133,MLT:134,MMR:135,MNE:136,MNG:137,MNP:138,MOZ:139,MRT:140,MSR:141,MUS:142,MWI:143,MYS:144,NAM:145,NCL:146,NER:147,NGA:148,NIC:149,NIU:150,NLD:151,NOR:152,NPL:153,NRU:154,NZL:155,OMN:156,PAK:157,PAN:158,PCN:159,PER:160,PHL:161,PLW:162,PNG:163,POL:164,PRI:165,PRK:166,PRT:167,PRY:168,PYF:169,QAT:170,ROU:171,RUS:232,RWA:173,SAU:174,SDN:175,SEN:177,SSD:176,SGS:178,SHN:179,SJM:180,SLB:181,SLE:182,SLV:183,SOM:184,SPM:185,SRB:186,STP:187,SUR:188,SVK:189,SVN:190,SWE:191,SWZ:192,SXM:193,SYC:194,SYR:195,TCA:196,TCD:197,TGO:198,THA:199,TJK:200,TKM:201,TLS:202,TON:203,TTO:204,TUN:205,TUR:206,TWN:207,TZA:208,UGA:209,UKR:210,URY:211,USA:212,UZB:213,VCT:214,VNM:217,VUT:218,WLF:220,WSM:221,YEM:222,ZMB:223,ZWE:224,ZAF:225,VEN:226,CAN:227,GGY:230,CHL:229,ECU:230,SOM2:231,RUS2:235,"":219}},getIndexFromISO3:function(e){var t=this.ISO3Table[e];return null!==t?t:-1},getISO3FromIndex:function(e){var t=this.ISO3Table;return Object.keys(t).filter(function(i){return t[i]==e})},getCountries:function(){for(var e=[],t=0;t<this.countries.length;t++)this.countries[t]&&(this.countries[t].color||this.countries[t].description)&&e.push(this.countries[t]);return e},get:function(e){var t=this.countries[e];return t||(t=new r(this,e,this.getISO3FromIndex(e)),this.countries[e]=t),t},setColor:function(e,t){this.get(e).setColor(t);return this},getColor:function(e){var t=this.countries[e];return t?t.color:null},clear:function(){this.clearColors(),this.countries=[]},clearColors:function(){for(var e=0;e<this.countries.length;e++)this.countries[e]&&this.countries[e].color&&(this.countries[e].color=null,this._renderer&&this._renderer.refreshCountry(this.countries[e]))},setRenderer:function(e){this._renderer=e;for(var t=0;t<this.countries.length;t++)this.countries[t]&&this._renderer&&this._renderer.refreshCountry(this.countries[t])},refreshCountry:function(e){this._renderer&&this._renderer.refreshCountry(this.countries[e])},refresh:function(){for(var e in this.countries)this.countries[e].color&&this._renderer&&this._renderer.refreshCountry(this.countries[e])},getSelectedCountries:function(){return this.selectedCountries}})}),define("DS/SocialGlobe/Renderer3D",["DS/SocialGlobe/Globals","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Renderer","DS/Visualization/WebGLV6Viewer","DS/Visualization/Node3D","DS/Visualization/OccurrencePath","DS/SocialGlobe/RenderPassManager"],function(e,t,i,o,s,n,r){"use strict";return i.extend({init:function(e,t,i,n,a){this._parent(e,t,i,n,a),this.pickCanvas=a,this.wantedProjection=!1,this.started=!1,this.meshes=[],this.visibleMeshes=[],this.switchToProjection(!1),this.lastProjection=!1,this.mixProjA=0,this.mixProjASpeed=Math.PI/500,this.mixProj=Math.cos(this.mixProjA),this.lastTime=-1,this.v6Viewer=new o({div:t,antiAliasing:"FSAA",useShadowMap:!1,infinitePlane:!1,displayGrid:!1,debugShadowLight:!1,debugBSphere:!1,debugBBox:!1,autoUpdateFrustum:!1,backgroundAlpha:0}),this.canvas=this.v6Viewer.canvas,this.v6Viewer.setVignetting(!1),this.v6Viewer.setToneMapping({enable:!0,gamma:1}),this.v6Viewer.setPicking({activated:!1}),this.v6Viewer.setPrePicking({activated:!1,displayHL:!0,gpu:!0,computeNormalDepth:!1,primitive:!1}),this.v6Viewer.usePostProcessing=!0,this.v6Viewer.usePicking=!1,this.v6SceneGraph=new s(this.v6Viewer.getWebGLContext()),this.v6Viewer.addNode(this.v6SceneGraph),this.renderPassManager=new r(this.v6Viewer.renderer.mainComposer)},switchToProjection:function(e){},setSwitchProjectionModeCB:function(e){this.switchProjectionModeCB=e},setCamera:function(e){this.camera=e,this.v6Viewer.addViewpoint(e.v6Viewpoint)},addClusterNode:function(e){this.visibleMeshes.indexOf(e)<0&&(this.visibleMeshes.push(e),this.v6SceneGraph.add(e))},addObject:function(e){this.visibleMeshes.indexOf(e)<0&&(this.visibleMeshes.push(e),e.v6Node&&(e.v6Node.setVisibility(!0),this.dbgAddRemove&&UWA.log("adding object "+e.clue),this.v6SceneGraph.add(e.v6Node)))},setBackgroundColor:function(e,t){this.v6Viewer.setBackgroundColor(e,t)},pickCountryIndex:function(e,i,o){var s=new t.Vector2(e,i),n=this.v6Viewer.getMousePosition(s),r=this.v6Viewer.pick(n,"mesh",!1);return r&&r.path.length>0&&r.path[0].getLastElement().DSSocialGlobeMesh?r.path[0].getLastElement().DSSocialGlobeMesh.pickIndex:-1},removeClusterNode:function(e){var t=this.visibleMeshes.indexOf(e);t>=0&&(this.visibleMeshes.splice(t,1),this.v6SceneGraph.remove(e))},removeObject:function(e){var t=this.visibleMeshes.indexOf(e);t>=0&&(this.visibleMeshes.splice(t,1),e.v6Node&&(e.v6Node.setVisibility(!1),this.dbgAddRemove&&UWA.log("removing object "+e.clue),this.v6SceneGraph.remove(e.v6Node)))},render:function(){var e,t=(new Date).getTime(),i=(this.lastTime>0&&this.lastTime,this.getCanvas()),o=i.width/i.height;for(this.lastTime=t,this.camera.autoMove(),this.camera.updateCamera(),this.mixProj=1-.5*(1+Math.cos(this.mixProjA)),e=0;e<this.visibleMeshes.length;e++)this.visibleMeshes[e].updateMaterial&&this.visibleMeshes[e].updateMaterial(this.mixProj,o);this.v6Viewer.render()},getCanvas:function(){return this.v6Viewer.canvas},getMarkerSize:function(){return.0125*this.canvas.height},getRenderPassManager:function(){return this.renderPassManager},computeMarkerPositionOnScreen:function(i){var o,s,n,r=this.v6Viewer.SCREEN_WIDTH/this.v6Viewer.SCREEN_HEIGHT;i.screenPosition=null,this.mixProj<1e-4?i.position.dot(this.camera.threeCamera.position)>0&&((o=new t.Vector4(i.position.x,i.position.y,i.position.z,1)).applyMatrix4(this.camera.totalTransfo),s=this.camera.dist-1,(n=new t.Vector2(o.x/o.w,o.y/o.w+1/(s*s))).normalize(),i.screenPosition={x:this.v6Viewer.SCREEN_WIDTH*(.5+.5*o.x/o.w+.02625*n.x/r),y:this.v6Viewer.SCREEN_HEIGHT*(.5-.5*o.y/o.w-.02625*n.y)}):this.mixProj>.9999&&(i.screenPosition={x:this.canvas.width*e.lon2tileFlt(i.lon,0),y:.5*this.canvas.height*.9475-.5*this.canvas.width+this.canvas.width*e.lat2tileFlt(i.lat,0)})}})}),define("DS/SocialGlobe/Camera",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/Vector2"],function(e,t,i){"use strict";return e.extend({init:function(e,o){this.lat=0,this.lon=0,this.renderer=e,this.camPosition=new i(t.lon2tileFlt(this.lon,0),t.lat2tileFlt(this.lat,0)),this.minlevel=2,this.maxlevel=o?t.localTilesMaxLevel:17,this.level=0,this.dist=8,this.mindist=1.0001,this.maxdist=15,this.zoomCoeff=.3,this.deltaXCamera=0,this.deltaYCamera=0,this.lastTime=-1,this.autoTurn=0,this.moveToStart=null,this.moveToVector=null,this.moveToDistance=null,this.moveToStartTime=-1,this.moveToDuration=500,this.zoomAllowed=!0,this.changed=!1},moveToLatLon:function(e,t){this.moveToStartTime=(new Date).getTime(),this.moveToStart={lat:this.lat,lon:this.lon,dist:this.dist};var i=e.lon-this.lon;i>180?i-=360:i<-180&&(i+=360),t&&(t=Math.max(t,this.mindist),this.moveToDistance=t-this.dist),this.moveToVector={deltaLat:e.lat-this.lat,deltaLon:i}},correctLon:function(e){return(e%=360)<-180?e+360:e>180?e-360:e},correctLat:function(e){return(e%=360)<-180?e+360:e>180?e-360:e},autoMove:function(){var e,o,s=(new Date).getTime(),n=!1;this.autoTurn&&(e=this.lastTime>0?s-this.lastTime:0,this.lon-=360*this.autoTurn*e/6e4,this.lon=this.correctLon(this.lon),n=!0),this.moveToVector&&((e=s-this.moveToStartTime)>=this.moveToDuration?(e=this.moveToDuration,this.lat=this.moveToStart.lat+this.moveToVector.deltaLat,this.lon=this.moveToStart.lon+this.moveToVector.deltaLon,this.dist=this.moveToStart.dist+this.moveToDistance,this.moveToStart=null,this.moveToVector=null,this.moveToDistance=null,this.moveToStartTime=-1):(o=Math.sin(Math.PI/2*e/this.moveToDuration),this.lat=this.moveToStart.lat+o*this.moveToVector.deltaLat,this.lon=this.moveToStart.lon+o*this.moveToVector.deltaLon,null!==this.moveToDistance&&(this.dist=this.moveToStart.dist+this.moveToDistance*e/this.moveToDuration)),this.lon=this.correctLon(this.lon),n=!0),n&&(this.camPosition=new i(t.lon2tileFlt(this.lon,0),t.lat2tileFlt(this.lat,0)),this.updateCamera()),this.lastTime=s},setDelta:function(e,t){this.deltaXCamera=e,this.deltaYCamera=t,this.updateCamera()},getMoveFactor:function(){return 1},allowZoom:function(e){this.zoomAllowed=e},zoom:function(e,t){this.zoomAllowed&&(this.dist=t?1+(this.dist-1)*(1+e):1+(this.dist-1)*(1+e/Math.abs(e)*this.zoomCoeff),this.dist=Math.max(this.mindist,this.dist),this.dist=Math.min(this.maxdist,this.dist),this.changed=!0)},getTileTab:function(){var e,i=[];for(e=0;e<20;e++)i.push({tx:t.lon2tileFlt(this.lon,e),ty:t.lat2tileFlt(this.lat,e)});return i}})}),define("DS/SocialGlobe/VisuPatchGround",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/SocialGlobe/Matrix4d"],function(e,t,i,o,s){"use strict";var n=e.extend({init:function(e,i,o){this._parent(),this.tileBag=e,this.quad=void 0,this._mesh=void 0,this.store=i,this.scene=o,this.raster={},this.worldSize=1,this.updated=!1,this.prepareMatrix=new t.Matrix4d,this.matrix=this.prepareMatrix,this.matrixCulling=this.prepareMatrix,this.scale=1,this.halfLength=0,this.normalizedLevel=0,this.scaleXYZ=new t.Vector3(0,0,0),this.pos=new t.Vector3(0,0,0),this.halfHeight=0,this.bc=new t.Color(1,1,1),this.frameId=-1},clone:function(){return new n(this.patchInstance,this.store,this.scene)},update:function(e){this.quad=e,this.normalizedLevel=this.quad.LOD/20;var i=e.Size*this.worldSize;this.halfLength=.5*i,this.pos.x=(e.X+e.Size/2)*this.worldSize,this.pos.y=(e.Y+e.Size/2)*this.worldSize,this.pos.z=0,this.halfHeight=.5*Number.MAX_VALUE,this.prepareMatrix.identity(),this.prepareMatrix.setPosition(this.pos),this.scale=this.halfHeight,this.prepareMatrix.scale(new t.Vector3(this.scale,this.scale,1)),this.updated=!0},display:function(e){if(this.updated&&(this._mesh=this.tileBag.getTile(this.quad.LOD,this.quad.I,this.quad.J),this.scene.addObject(this._mesh),this.updated=!1),!0!==this.done){var t=this.store.getOrDownloadData("ortho",this.quad.LOD,this.quad.I,this.quad.J,e);if(void 0!==t&&((t.LOD===this.quad.LOD||t.isLeaf)&&(this.done=!0),this.raster=t,t.data)){var i=this._mesh.threeMaterial;i.uniforms.uOSMSampler.value=t.data,i.uniforms.offset.value.set(t.offset.x,t.offset.y,t.scale),i.needsUpdate=!0,i.force=!0}}else this.store.updateTimeStamp("ortho",this.raster.LOD,this.raster.I,this.raster.J);return!0},clear:function(){this.scene.removeObject(this._mesh),this.done=!1,void 0!==this._mesh&&this._mesh.threeMaterial,this.quad={}},updateTimeStamp:function(e){this.raster&&this.store.updateTimeStamp("ortho",this.raster.LOD,this.raster.I,this.raster.J)},updateBound:function(){return!0}});return n}),
/*!
  Script: DSSocialGlobeUWA.js

    This file is part of UWA JS Runtime.

  About: License

    Copyright 2006-2013 Dassault Systèmes company.
    All rights reserved.
*/
window.DSSocialGlobe={},define("DS/SocialGlobe/UICountrySelector",["UWA/Core","UWA/Class","UWA/Controls/Abstract","DS/SocialGlobe/Globals","DS/Core/Events","UWA/Controls/Input","UWA/Controls/ColorPicker","DS/Windows/Panel","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/Controls/ColorPicker","DS/Controls/Toggle","DS/Controls/ButtonGroup","DS/WebappsUtils/WebappsUtils","DS/Controls/ComboBox","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/Controls/Button","DS/SocialGlobe/GlobeNotifications","DS/SocialGlobe/MarkerInfoManager"],function(e,t,i,o,s,n,r,a,l,h,c,d,u,g,p,m,f,v,b){"use strict";return t.extend({init:function(e,t,i,o,s){this._parent(t),this.options=t,this.enable=!1,this.manager=e,this.arraySelectName=[],this.selection=[],this._cmdEndExecute=i,this._cmdEndSelect=o,this._cmdSelectArea=s,this.container=this.buildSkeleton(),this.noContainerRemove=!0,this._evtID="/SG/UICE/CMD/"+t.ID},buildSkeleton:function(){this.options;this.panelContent=new UWA.Element("div",{class:"globe-panel-select",styles:{width:"100%",height:"100%"}});var e=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.panelContent),t=(new UWA.Element("li",{class:"wux-controls-switch-label",html:l.get("GlobeViewer.Areas.Editor.country"),styles:{width:"60px"}}).inject(e),new UWA.Element("li",{class:"country-combo-box",styles:{width:"65%"}}).inject(e));this.arraySelectName=new p;for(var i=Object.keys(this.manager.ISO3Table).sort(function(e,t){var i=o.countries[e],s=o.countries[t];return i<s?-1:i>s?1:0}),s=0;s<i.length;s++){var n=i[s];n&&this.arraySelectName.addChild(new m({label:o.countries[n],iso3:n,value:this.manager.ISO3Table[n]}))}return this.arraySelectName.expandAll(),this.leCountryName=new g({enableSearchFlag:!0,elementsTree:this.arraySelectName,displayStyle:"normal"}).inject(t),this.leCountryName.addEventListener("change",this.changeCountry.bind(this)),this.panel=new a({immersiveFrame:b.immersiveFrame,title:l.get("GlobeViewer.Areas.Selector.title"),content:this.panelContent,allowedDockAreas:0,identifier:"WUXPanel_CountrySelector_"+b.webUXCountryIdentifier}),this.addButtons(this.panelContent),this.panel.addEventListener("close",this._cmdEndExecute),b.container},changeCountry:function(){this.clearSelection();for(var e=this.arraySelectName.getSelectedNodes(),t=0;t<e.length;t++){var i=e[t].options.iso3;this.selection.push(this.manager.get(this.manager.getIndexFromISO3(i)))}this.selection[0].ID&&(s.publish({event:this._evtID+"/SELECT",data:this.selection[0]}),this._cmdSelectArea(this.selection[0]))},addButtons:function(e){var t=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(e),i=new UWA.Element("li",{class:"country-buttons"}).inject(t);new f({label:l.get("GlobeViewer.Areas.Editor.Apply"),emphasize:"primary",onClick:this.apply.bind(this)}).inject(i)},apply:function(){if(!this.selection.length){var e=new Error(l.get("GlobeViewer.Areas.Info.Edit.NoDataError"));return e.title=l.get("GlobeViewer.Areas.Info.Edit.CreateDataError"),e.subtitle=l.get("GlobeViewer.Areas.Info.Edit.NoSelectedError"),v.display({level:"info",title:e.title,subtitle:e.subtitle,message:e.message}),!1}var t=this;return this.selection.map(function(e){t._cmdEndSelect(e)}),this.clearSelection(),this._cmdEndExecute(),this.panel.close(),!0},clearSelection:function(){var e=this;this.selection.map(function(t){-1===e.manager.getSelectedCountries().indexOf(t)&&t.setHtmlColor(null)}),this.selection=[]}})}),define("DS/SocialGlobe/MarkerMaker3D",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/Mesh","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils","DS/Plugins/RenderPass","DS/Plugins/ClearPass"],function(e,t,i,o,s,n,r){"use strict";return e.extend({init:function(e){this.scene=e;var t=new r("MakerClearDepthPass");if(t.defaults.clear=!1,t.defaults.doClearDepth=!0,this.scene.getRenderPassManager().addPass("MakerClearDepthPass",t,{after:"CountryPassID"}),this._Maker3DPassID="noz",void 0===this.scene.getRenderPassManager().getPass(this._Maker3DPassID)){var i=new n(null,null,void 0,!0,!0,!1,this._Maker3DPassID);i.idString=this._Maker3DPassID,this.scene.getRenderPassManager().addPass(this._Maker3DPassID,i,{after:"MakerClearDepthPass"})}this.vertShader=["///attribute vec3 position;","//attribute vec2 uv;","attribute vec2 aTextureCoord;","uniform mat4 uMBWMatrix;   ","uniform mat4 uMVMatrix;","uniform mat4 uMPMatrix;","uniform int uFlip;","uniform int uNormalize;","uniform float uMixProj;","uniform float uDz2D;","uniform int uOSMMode;","uniform float uAspectRatio;","const float PI = 3.14159;","varying vec3 vTextureCoord;","varying vec3 vNormal;","varying vec3 vTangent;","varying vec3 vBinormal;","uniform float uMarkerScale;","void main() ","{","/*            gl_Position =   projectionMatrix * ","                        viewMatrix * ","                        modelMatrix * ","                        vec4(position,1.0);","    ","    return;*/","   // Move vertex to proper world position (initial geometry is a cube)","   vec3 OP =  vec4(position,1.0).xyz;  ","   vec3 VP;","   float radius = 1.0;","   float dz = 0.0;","   if(uNormalize == 1)","   {","//     radius = 0.985;","       radius = 0.998;","       VP = normalize(OP);","       vTextureCoord = VP; ","       vNormal = normal;","       vTangent = normalize(cross(vec3(0,1,0), vNormal));","       vBinormal = normalize(cross(vTangent, vNormal));","   }","   else","   {","       VP = OP;","       // Sampling texture in a cube map -> UV are then xyz of normal vector...","       //  which happen to be the vertices positions for a unit sphere","       //vec3 P2 =  normalize( (uMBWMatrix * vec4(position,1.0)).xyz );    ","       vec3 P2 =  VP;  ","       ","       // Sampling texture in a cube map -> UV are then xyz of normal vector...","       //  which happen to be the vertices positions for a unit sphere","       vTextureCoord = vec3(vec2(0.5+0.5*uv.x, 0.5+0.5*uv.y), 1.0);    ","       vNormal = normal;","       vTangent = normalize(cross(vec3(0,1,0), VP));","       vBinormal = normalize(cross(vTangent, VP));","   }","   ","   vec3 projP = vec3(VP.x, 0.0, VP.z);","   if(length(projP) < 0.001)","   {","       projP = vec3(1.0, 0.0, 1.0);","   }","   vec3 normalizedProjP = normalize(projP);","   float sign = 0.0;","   if(normalizedProjP.z > 0.0) ","       sign = -1.0;","   else","       sign = 1.0;","   float angle = sign*acos(normalizedProjP.x);","   if(uFlip != 0 && angle > 0.0)","   {","       angle -= 2.0*PI;","   }","   float x = angle / PI;","   vec4 pre_gl_Position_2d;","   float yangle = asin(VP.y);","   float minangle = 1.31;","   if(yangle < -minangle)","   {","       yangle = -minangle;","   }","   else","   {","       if(yangle > minangle)","       {","           yangle = minangle;","       }","   }   ","   float y2d = uAspectRatio*log(tan(PI/4.0+yangle*0.5))/ PI;","   pre_gl_Position_2d = vec4(x+0.04*uv.x/uAspectRatio, y2d+0.04*(1.0+uv.y), uDz2D, 1.0);","   ","   ","   ","   ","   float MixProj  = uOSMMode != 2 ? uMixProj : 0.0;","   // Final position in projected view space","   vec4 pre_gl_Position_3d;","   vec4 pos = ( viewMatrix  * modelMatrix * (vec4(radius*VP, 1.0)/*+ vec4(0.5*uv, 0, 0)*/));","   pre_gl_Position_3d = projectionMatrix * pos;","   vec2 posOnScreen = (1.0/pre_gl_Position_3d.w)*pre_gl_Position_3d.xy;","   float distanceToGround = length(cameraPosition) - 1.0;","   vec2 dp = vec2(posOnScreen.x, posOnScreen.y+1.0/(distanceToGround*distanceToGround));","   vec2 vy = uMarkerScale*0.04*normalize(vec2(dp.x, dp.y));","   vec2 vx = uMarkerScale*0.04*normalize(vec2(dp.y, -dp.x));","    if(dot(cameraPosition, VP) > 0.0)","    {","        pre_gl_Position_3d += pre_gl_Position_3d.w*vec4((uv.x*vx.x+(1.0+uv.y)*vy.x)/uAspectRatio, uv.x*vx.y+(1.0+uv.y)*vy.y, 0,0);","    }","   ","   gl_Position = MixProj*pre_gl_Position_2d + (1.0 - MixProj)*pre_gl_Position_3d;","   //gl_Position = pre_gl_Position_3d;","}",""].join("\n"),this.fragShader=["precision highp float;","const float Eta = 1.0/1.2;","const float FresnelPower1 = 0.6;","const float FresnelPower2 = 2.0;","const float F = ((1.0 - Eta) * (1.0 - Eta)) / ((1.0 + Eta) * (1.0 + Eta));","const float PI = 3.14159;","uniform mat4 uMBWMatrix;   ","uniform mat4 uMVMatrix;","uniform mat4 uMPMatrix;","varying vec3 vTextureCoord;","varying vec3 vNormal;","varying vec3 vTangent;","varying vec3 vBinormal;","//uniform vec3 uViewer;","uniform vec2 uOSMX0;","uniform vec2 uOSMX1;","uniform vec4 myColor;","uniform float uFirst;","uniform sampler2D uBackSampler;","uniform sampler2D uColorSampler;","void main() ","{","   vec4 back = texture2D(uBackSampler, vTextureCoord.xy);","   vec4 colorIntensity = texture2D(uColorSampler, vTextureCoord.xy);","   gl_FragColor.rgba = vec4(colorIntensity.a * colorIntensity.r * vNormal.r + (1.0 - colorIntensity.a) * back.r,","       colorIntensity.a * colorIntensity.g * vNormal.g + (1.0 - colorIntensity.a) * back.g,","       colorIntensity.a * colorIntensity.b * vNormal.b + (1.0 - colorIntensity.a) * back.b,","       back.a);","   if(gl_FragColor.a < 0.5) discard;","}",""].join("\n"),this.fragShaderCustom=["precision highp float;","const float Eta = 1.0/1.2;","const float FresnelPower1 = 0.6;","const float FresnelPower2 = 2.0;","const float F = ((1.0 - Eta) * (1.0 - Eta)) / ((1.0 + Eta) * (1.0 + Eta));","const float PI = 3.14159;","uniform mat4 uMBWMatrix;","uniform mat4 uMVMatrix;","uniform mat4 uMPMatrix;","varying vec3 vTextureCoord;","varying vec3 vNormal;","varying vec3 vTangent;","varying vec3 vBinormal;","//uniform vec3 uViewer;","uniform vec2 uOSMX0;","uniform vec2 uOSMX1;","uniform vec4 myColor;","uniform float uFirst;","uniform sampler2D uBackSampler;","uniform sampler2D uColorSampler;","void main()","{","    gl_FragColor = texture2D(uBackSampler, vTextureCoord.xy);","    //vec4 colorIntensity = texture2D(uColorSampler, vTextureCoord.xy);","}",""].join("\n"),this.fragShader_pick=["precision highp float;","const float Eta = 1.0/1.2;","const float FresnelPower1 = 0.6;","const float FresnelPower2 = 2.0;","const float F = ((1.0 - Eta) * (1.0 - Eta)) / ((1.0 + Eta) * (1.0 + Eta));","const float PI = 3.14159;","uniform mat4 uMBWMatrix;   ","uniform mat4 uMVMatrix;","uniform mat4 uMPMatrix;","varying vec3 vTextureCoord;","varying vec3 vNormal;","varying vec3 vTangent;","varying vec3 vBinormal;","//uniform vec3 uViewer;","uniform vec2 uOSMX0;","uniform vec2 uOSMX1;","uniform vec4 myColor;","uniform float uFirst;","uniform sampler2D uBackSampler;","uniform sampler2D uColorSampler;","void main() ","{","   vec4 back = texture2D(uBackSampler, vTextureCoord.xy);","   gl_FragColor.rgba = vec4(vNormal.xyz, back.a < 1.0 ? 0.0 : 1.0);","}",""].join("\n"),this.materials=this.createMarkerMaterials(),this.customMarkerMaterials=[]},incrementShadersLoaded:function(e,t){t},createRenderable:function(e,o,s){var n,r,a=new i(this.scene,"MarkerMaker",void 0,this._Maker3DPassID);for(n=0;n<e.length;n++)if(void 0!==(r=!0===s?e[n]:e[n][0])){var l=t.htmlToRGB(r.getCurrentColor());a.addVertex(r.position.x,r.position.y,r.position.z,l[0],l[1],l[2],[[-1,-1]]),a.addVertex(r.position.x,r.position.y,r.position.z,l[0],l[1],l[2],[[-1,1]]),a.addVertex(r.position.x,r.position.y,r.position.z,l[0],l[1],l[2],[[1,1]]),a.addVertex(r.position.x,r.position.y,r.position.z,l[0],l[1],l[2],[[1,-1]]),a.addFace([1+4*n,4*n,2+4*n]),a.addFace([2+4*n,4*n,3+4*n])}return o?(a.setMaterial(o.material),a.setPickMaterial(o.pickMaterial)):(a.setMaterial(this.materials.material),a.setPickMaterial(this.materials.pickMaterial)),a.endMesh({depth:0,pickable:"occulting"}),[a]},createMarkerMaterials:function(){if(this.shadersLoaded<4)return{material:t.defaultMaterial,pickMaterial:t.defaultMaterial};void 0!==t.theme?t.theme:t.defaultTheme;var e=s.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/natural/marker/"),i=o.ImageUtils.loadTexture(e+"markerBack128.png",void 0,function(){},void 0,!0),n=o.ImageUtils.loadTexture(e+"markerColor.png",void 0,function(){},void 0,!0),r=this.scene.canvas,a={uAspectRatio:{type:"f",value:1},uBackSampler:{type:"t",value:i},uColorSampler:{type:"t",value:n},uMixProj:{type:"f",value:.5},uMarkerScale:{type:"f",value:1}},l=new o.ShaderMaterial({uniforms:a,vertexShader:this.vertShader,fragmentShader:this.fragShader});l.force=!0,l.transparent=!0,l.side=o.FrontSide,l.forceSide=!0;var h=o.ImageUtils.loadTexture(e+"markerBack64.png",void 0,function(){},void 0,!0),c={uAspectRatio:{type:"f",value:r.width/r.height},uBackSampler:{type:"t",value:0,texture:h},uMarkerScale:{type:"f",value:1}},d=new o.ShaderMaterial({uniforms:c,vertexShader:this.vertShader,fragmentShader:this.fragShader_pick});return d.depthTest=!1,d.force=!0,{material:l,pickMaterial:d}},createMarkerCustomMaterials:function(e){if(this.shadersLoaded<4)return{material:t.defaultMaterial,pickMaterial:t.defaultMaterial};var i,s,n=o.ImageUtils.loadTexture(e,void 0,function(){},void 0,!1),r=(this.scene.canvas,{uAspectRatio:{type:"f",value:2},uBackSampler:{type:"t",value:n},uMixProj:{type:"f",value:.5},uMarkerScale:{type:"f",value:1}}),a=new o.ShaderMaterial({uniforms:r,vertexShader:this.vertShader,fragmentShader:this.fragShaderCustom});return a.depthTest=!1,a.force=!0,a.transparent=!0,i={uAspectRatio:{type:"f",value:1},uBackSampler:{type:"t",value:0,texture:n},uMarkerScale:{type:"f",value:1}},(s=new o.ShaderMaterial({uniforms:i,vertexShader:this.vertShader,fragmentShader:this.fragShader_pick})).depthTest=!1,s.force=!0,{material:a,pickMaterial:s}},updateMaterialUniforms:function(e){var t=this.scene.canvas;e.uniforms.uAspectRatio.value=t.width/t.height,e.uniforms&&e.uniforms.uMarkerScale&&(e.uniforms.uMarkerScale.value=.25*(this.scene.camera.level>6?6:this.scene.camera.level+1)),e.needsUpdate=!0},updateMaterialBeforeDraw:function(){this.updateMaterialUniforms(this.materials.material),this.updateMaterialUniforms(this.materials.pickMaterial)}})}),define("DS/SocialGlobe/TileBag",["UWA/Class","DS/SocialGlobe/Globals"],function(e,t){"use strict";return e.extend({init:function(e){this.scene=e,this.tileMap={},this.imageMap={},this.beingLoadedImageMap={},this.currentlyLoading=[],this.imageQueue=[],this.firstToDelete=null,this.lastToDelete=null,this.maxLoadingImages=10,this.nbLoadingImages=0,this.imageCounter=0,this.numToDelete=0,this.maxNumToDelete=256}})});var dataGlobal,clusterFactory=null;define("DS/SocialGlobe/ClusterFactory",["UWA/Class","DS/WAFData/WAFData","DS/SocialGlobe/Globals","DS/WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/SocialGlobe/OffscreenCanvas2DNode","DS/SceneGraphNodes/CanvasNodeTexture"],function(e,t,i,o,s,n,r,a,l,h){"use strict";var c=UWA.Class.extend({init:function(){this.drawing=new Image;var e=void 0!==i.theme?i.theme:i.defaultTheme,t=o.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/"+e+"/marker/");this.drawing.src=t+"markerColor.png",this.drawing.onload=function(){console.log("loaded")}},measure:function(e){var t=document.createElement("canvas").getContext("2d"),i=this.wrapText(t,e,.5*e.style.maxWidth,e.fontHeight);return i.height+=20,i},wrapText:function(e,t,i,o){e.font=t.style.font,e.textAlign=t.style.textAlign;var s=t.fontHeight,n=t.name;return e.strokeText(n,i,30),e.fillText(n,i,30),{width:e.measureText(n).width,height:s}},wrapText2:function(e,t,i,o){e.font=t.style.font,e.textAlign=t.style.textAlign;for(var s=t.fontHeight,n=t.name.split(" "),r="",a=t.style.maxWidth,l=!1,h=0;h<n.length;h++){var c=r+n[h]+" ",d=e.measureText(c).width;a=d,d>t.style.maxWidth&&h>0?(l=!0,e.strokeText(r,i,o),e.fillText(r,i,o),r=n[h]+" ",o+=s):r=c}return e.strokeText(r,i,o),e.fillText(r,i,o),l&&(a=t.style.maxWidth),{width:a,height:o}},build:function(e){e.name;var t=e.pos,i=e.style,o=(e.size,this);var r=new h({width:e.size.width,height:e.size.height,drawCB:function(t,s,n){s.font=i.font,s.textAlign=i.textAlign;var r=t.width,a=t.height;s.fillStyle=i.fillStyle,s.globalAlpha=1,s.strokeStyle="#5d97c1",s.lineWidth=2,s.fillStyle=i.fillStyle;var l,h,c,d=Math.max(25*e.name.length/4,14);l=.5*r,h=.5*a,c=d,s.beginPath(),s.fillStyle="#005685",s.arc(l,h,c,0,2*Math.PI,!1),s.fill(),s.lineWidth=3,s.strokeStyle="#dddddd",s.stroke(),s.strokeStyle="#5d97c1",s.fillStyle=i.fillStyle,o.wrapText(s,e,.5*e.size.width,.5*e.fontHeight)},alphaTest:.02}),c=new l({canvasNodeTexture:r},a);c.setHotspot(new s.Vector2(e.size.width/2,e.size.height/2));var d=new n;d.addChild(c);var u=new s.Matrix4;return u.setPosition(t),d.setMatrix(u),d}});return c.getInstance=function(){return null===clusterFactory&&(clusterFactory=new c),clusterFactory},c.getInstance()}),define("DS/SocialGlobe/VisuQuadTree",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Disposer","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/SocialGlobe/VisuPatchGround"],function(e,t,i,o,s,n){"use strict";return e.extend({init:function(e,i,o){this.qt=e,this.tilebag=o.tileBag,this.camera=o.camera.threeCamera,this.scene=o.renderer,this.visuStore=o.visuStore,this.levelMax=o.camera.maxlevel,this.projMat=new t.Matrix4,this.frustum=new t.Frustum,this.frameId=0,this.size=1,this.maxNbPatches=i,this.patches={},this.patchReserve=[],this.nbVisiblePatches=0,this.nbPatches=0,this.heightUnderCamera=0,this.boxCulling=0,this.screenBoundingBox=new Array(8),this.boundingBox=[];for(var s=0;s<8;s++)this.boundingBox[s]=new t.Vector4(0,0,0,1);this.outsideFrustum=new Array(5),this.cameraPositionVec4=new t.Vector4(0,0,0,1),this.center=new t.Vector3(0,0,0),this.build()},build:function(){for(var e=0;e<this.maxNbPatches;e++)this.patchReserve.push(this.createPatch())},createPatch:function(){return new n(this.tilebag,this.visuStore,this.scene)},dispose:function(){for(var e in this.patches)this.patches[e].clear(),i.disposeV6(this.patches[e],!0);for(var t=0;t<this.patchReserve.length;t++)i.disposeV6(this.patchReserve[t],!0)},isQuadVisible:function(e){return!0},update:function(e){this.frameId++;var t,i,o,s;this.frameId;for(this.faceCulling=0,this.frustrumCulling=0,t=0,i=this.qt.quads.length;t<i;t++)(o=this.qt.quads[t]).LOD<=this.levelMax&&this.isQuadVisible(o)&&(n=o.LOD+"_"+o.I+"_"+o.J,void 0===(r=this.patches[n])?(void 0===(s=this.patchReserve.pop())&&(s=this.createPatch(),this.maxNbPatches++),s.frameId=this.frameId,s.update(o),this.patches[n]=s):(r.frameId=this.frameId,!0===e&&(r.clear(),r.update(o))));for(var n in this.patches){var r;(r=this.patches[n]).frameId<this.frameId&&(this.patchReserve.push(r),r.clear(),delete this.patches[n])}},traverse:function(e){for(var t in this.patches)e(this.patches[t])},clear:function(){for(var e in this.patches)this.patchReserve.push(this.patches[e]),this.patches[e].clear(),delete this.patches[e]},display:function(e){this.projMat.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),this.frustum.setFromMatrix(this.projMat),this.nbVisiblePatches=0,this.boxCulling=0;var t=this.camera.position;for(var i in this.cameraPositionVec4.set(t.x,t.y,t.z,1),this.nbPatches=this.maxNbPatches-this.patchReserve.length,this.patches){if(this.patches.hasOwnProperty(i))this.patches[i].display(e)&&this.nbVisiblePatches++}}})}),define("DS/SocialGlobe/GeocodingAndReverse",["UWA/Core","UWA/Class/View","DS/Controls/LineEditor","DS/Controls/ComboBox","DS/Controls/Button","DS/Controls/Loader","DS/Controls/ModalContainer","DS/Controls/TooltipModel","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/Tree/TreeListView","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Globals","DS/WAFData/WAFData","i18n!DS/SocialGlobe/assets/nls/GlobeViewer"],function(e,t,i,o,s,n,r,a,l,h,c,d,u,g,p){"use strict";function m(e){return e.dsModel?e.dsModel.value:e.currentTarget.dsModel.value}function f(e){return isNaN(e)?e.trim().length>=3:e.length>0}return t.extend({tagName:"div",elements:{},_config:{},_listenWorldClick:!1,_processUserInputTimeout:void 0,_treeDocument:void 0,_worldClickPointLayer:void 0,_addressResultLayer:void 0,_prevValues:{},setup:function(e){this._config={renderID:e.renderID||"",folder:e.folder,domId:e.domId},this._treeDocument=new l({useAsyncPreExpand:!0,shouldAcceptDrag:function(e){return e}}),this._createUIElements(),this._renderUI(),this._setListeners()},_getReferentialInfo:function(e,t){xCity.widgetData.currentReferential.get("uuid")},_createUIElements:function(){this.elements.title=new e.Element("div",{class:"xct-title",html:"Geocoding / Reverse Geocoding"}),this.elements.inputFreeForm=new i({domId:"xct-geocoding-input",placeholder:"Enter address or coordinates",autoCommitFlag:!0,sizeInCharNumber:34,selectAllOnFocus:!0}),this.elements.loadingIndicator=new n,this.elements.comboInputType=new o({elementsList:[],mainElementVisibleFlag:!1}),this.elements.btnLocator=new s({domId:"locator",type:"check",emphasize:"secondary",showLabelFlag:!1,displayStyle:"icon",iconSize:"1x",icon:{iconName:"location",fontIconFamily:WUXManagedFontIcons.Font3DS}}),this.elements.btnLocator.tooltipInfos=new a({shortHelp:"Locate and get address",longHelp:"Click to toggle then click on desired location on map to get nearest address"}),this.elements.inputComponents=[],this.elements.datagrid=new e.Element("div",{styles:{position:"relative","min-height":"150px"}})},_renderUI:function(t){this.elements.title.inject(this.container);var i=new e.Element("div",{class:"xct-parameter",html:[this.elements.inputFreeForm,new e.Element("i",{class:"xct-geocoding-input-icon wux-ui-3ds wux-ui-3ds-search"})]});this.elements.addressFreeFormContainer=i;var o=new e.Element("div",{domId:"addressComponents",styles:{display:"none"}});this.elements.addressComponentsContainer=o;var s=new e.Element("div",{styles:{display:"flex"},html:[{tag:"div",class:"xct-geocoding-controls",html:[i,o]},{tag:"div",styles:{display:"flex","align-items":"center",height:"24px"},html:[this.elements.comboInputType,new e.Element("div",{class:"xct-separator-vertical"}),this.elements.btnLocator]}]}).inject(this.container);this.elements.controlsContainer=s,new e.Element("div",{class:"xct-separator"}).inject(this.container),this.elements.datagrid.inject(this.container)},_createComponentInputFields:function(t,o){if(t)for(var s=0;s<t.length;s++){var n=t[s].trim().replace("$","");if(o.includes(n)){var r=new i({domId:"xct-geocoding-input",placeholder:"Enter search value",autoCommitFlag:!0,sizeInCharNumber:27,selectAllOnFocus:!0});r.fieldName=n,r.addEventListener("click",this._onInputFieldClick.bind(this)),r.addEventListener("change",this._onComponentInputValueChange.bind(this)),this.elements.inputComponents.push(r),new e.Element("div",{class:"xct-parameter",html:[{tag:"div",class:"xct-label",html:p.get("3DXCity.GeocodingAndReverse.LineEditor."+n)},{tag:"div",class:"xct-input",html:{tag:"div",class:"xct-parameter",html:[r,new e.Element("i",{class:"xct-geocoding-input-icon wux-ui-3ds wux-ui-3ds-search"})]}}]}).inject(this.elements.addressComponentsContainer)}}},_updateElementsVisibility:function(e){e?(this.elements.controlsContainer.show(),this.elements.datagrid.show()):(this.elements.controlsContainer.hide(),this.elements.datagrid.hide())},_setListeners:function(){this.elements.btnLocator.addEventListener("buttonclick",this._onLocateButtonClick.bind(this)),this.elements.inputFreeForm.addEventListener("click",this._onInputFieldClick.bind(this)),this.elements.inputFreeForm.addEventListener("change",this._onFreeFormInputValueChange.bind(this)),this.elements.comboInputType.addEventListener("change",this._onComboInputTypeChange.bind(this))},_onInputFieldClick:function(e){m(e);this._listenWorldClick=!1,this.elements.btnLocator.checkFlag=!1},_onFreeFormInputValueChange:function(e){var t=m(e).trim();f(t)&&(clearTimeout(this._processUserInputTimeout),this._clearAddressResultPoints(),this._clearWorldClickPoint(),this._processUserInputTimeout=setTimeout(this._processFreeFormUserInput.bind(this,t),1e3))},_onComponentInputValueChange:function(e){var t=m(e).trim();if(""==t||f(t)){clearTimeout(this._processUserInputTimeout);for(var i={},o=0;o<this.elements.inputComponents.length;o++){var s=this.elements.inputComponents[o],n=s.value.trim();""!=n&&(f(n)&&(i[s.fieldName]=n))}JSON.stringify(this._prevValues)!=JSON.stringify(i)&&(this._clearAddressResultPoints(),this._clearWorldClickPoint(),this._processUserInputTimeout=setTimeout(this._geocode.bind(this,i),1e3))}},_onLocateButtonClick:function(e){this._listenWorldClick?(this.elements.btnLocator.checkFlag=!1,this._listenWorldClick=!1):(this.elements.btnLocator.checkFlag=!0,this._listenWorldClick=!0,this._launchClicks())},_onComboInputTypeChange:function(e){switch(m(e)){case"free-form":this.elements.addressFreeFormContainer.show(),this.elements.addressComponentsContainer.hide();break;case"components":this.elements.addressFreeFormContainer.hide(),this.elements.addressComponentsContainer.show()}},_locatorReverseGeocode:function(e){if(this._listenWorldClick){this.elements.datagrid.empty(),this._toggleLoading(!0),this._clearAddressResultPoints(),e.lat=parseFloat(e.lat.toFixed(1)),e.lon=parseFloat(e.lon.toFixed(1)),this.elements.inputFreeForm.disabled=!0,this.elements.inputFreeForm.value=e.lat+", "+e.lon,this.elements.inputFreeForm.disabled=!1;this._reverseGeocodeNominatimPromise(e,{limit:10}).then(this._processReverseGeocodingResponse.bind(this,e),this._displayError.bind(this,"3DXCity.GeocodingAndReverse.Error.Generic"))}},_inputReverseGeocode(e){this._toggleLoading(!1),this.elements.datagrid.empty(),e={x:parseFloat(e[0]),y:parseFloat(e[1]),z:parseFloat(e[2]||0)}},_processReverseGeocodingResponse:function(e,t){e.lat=parseFloat(e.lat.toFixed(1)),e.lon=parseFloat(e.lon.toFixed(1)),this._prevValues=e,this._listenWorldClick=!1,this.elements.btnLocator.checkFlag=!1,this._toggleLoading(!1),this._populateAddressResults(!1,t)},_processFreeFormUserInput:function(e){var t;if((e=e.replace(/\s+/g," ").trim()).contains(",")?t=e.split(","):e.contains(" ")&&(t=e.split(" ")),t&&!t.some(isNaN)){if(t.indexOf("")>0||t.length>3)return void this._displayError("3DXCity.GeocodingAndReverse.Error.InputInvalidOrContainsError");this._inputReverseGeocode(t)}else this._geocode(e)},_geocode:function(e){this.elements.datagrid.empty(),this._toggleLoading(!0);var t=this;t._geocodeNominatimPromise(e,{limit:10}).then(function(i){i=t._filterOnPointsOnly(i),t._prevValues=e,t._populateAddressResults(!0,i)},this._displayError.bind(this,"3DXCity.GeocodingAndReverse.Error.Generic"))},_displayError:function(e){this.elements.datagrid.innerHTML=p.get(e)},_toggleLoading:function(e){e?(r.createModal(this.elements.datagrid,this.elements.loadingIndicator.elements.container),this.elements.loadingIndicator.on("Searching...")):(this.elements.loadingIndicator.off(),r.removeModal(this.elements.datagrid))},_populateAddressResults:function(e,t){this._toggleLoading(!1),this.elements.datagrid.empty(),e||(t=[t]),this._treeDocument.empty();for(var i=0;i<t.length;i++){var o=t[i],s=new h({label:o.display_name,grid:{tree:o.display_name,address:o.display_name,x:o.lat,y:o.lon,score:100*o.importance,feature:o}});this._treeDocument.addChild(s)}var n={treeDocument:this._treeDocument,show:{rowHeaders:!1,columnHeaders:!0},selection:{toggle:!1,canMultiSelect:!1},apiVersion:2,columns:[{text:"Actions",dataIndex:"tree",width:60,onCellRequest:this._resultLocateButton.bind(this)},{text:"Address",dataIndex:"address",width:"auto"},{text:"Scoring",dataIndex:"score",width:70,onCellRequest:this._customScoreCell.bind(this)}]};this.listView=new c(n),this.listView.onNodeClick(this._onNodeClick.bind(this)),this.listView.inject(this.elements.datagrid),this.listView.getRoots()[0].select(),this._visualizeAddressResultPoint(t[0],this._config)},_resultLocateButton:function(e){var t=new s({showLabelFlag:!1,displayStyle:"lite",iconSize:"1x",icon:{iconName:"location-arrow",fontIconFamily:WUXManagedFontIcons.FontAwesome}});if(t.tooltipInfos=new a({shortHelp:"Move to Location"}),t.addEventListener("buttonclick",function(){var t=e.nodeModel.options.grid;parseFloat(t.x),parseFloat(t.y);this.globe.turnGlobeToLatLon(parseFloat(t.x),parseFloat(t.y),4)}.bind(this)),e.nodeModel&&e.nodeModel.options){var i=e.cellView.getContent();i.style.textAlign="center",i.setContent(t)}},_customScoreCell:function(t){if(t.nodeModel&&t.nodeModel.options){var i,o=t.cellView.getContent(),s="white",n=t.nodeModel.options.grid.score;n>=75?i="mediumseagreen":n>=50?(i="#fde000",s="black"):i=n>=25?"darkorange":"orangered";var r=e.createElement("span",{text:n+" %",styles:{color:s,"background-color":i,"border-radius":"4px",padding:"4px"}});o.setContent(r)}},_onNodeClick:function(e){this._clearAddressResultPoints();var t=e.nodeModel.getAttributeValue("feature");this._visualizeAddressResultPoint(t,this._config)},_highlightResultInList:function(e){if(e.get("name").toString().contains("suggested-addresss")){this.listView.getRoots().forEach(e=>e.unselect());var t=e.get("userData").postalAddress,i=this.listView.getRoots().find(e=>e.options.grid.address==t);i&&i.select()}},_visualizeWorldClickPoint:function(e){e.z=xCity.getGroundHeight(e),this._worldClickPointLayer&&this._clearWorldClickPoint();var t=this._config.folder.id,i=xCity.findItem({id:t});i||(i=xCity.getTemporaryFolder(t,this._config.folder.name));var o={type:"FeatureCollection",name:"Origin",features:[{type:"Feature",properties:{STRID:"Origin",NAME:e.address||e.x+", "+e.y},geometry:{type:"Point",coordinates:[e.x,e.y,e.z]}}]},s={className:"Feature",name:e.address||e.x+", "+e.y,id:this._config.domId+Date.now(),visible:!0,Content:{className:"Marker",renderID:this._config.renderID,position:e,geojson:o,userData:o}};this._worldClickPointLayer=xCity.add3DContent({feature:s,parentFolder:i||null})},_clearWorldClickPoint:function(){if(function(e){if(e){var t=e.parentFolder();if(t){var i=t.parentFolder();return!(!i||"TemporaryItems"!=i.get("id"))}}return!1}(this._worldClickPointLayer))try{xCity.removeChild(this._worldClickPointLayer)}catch(e){this._worldClickPointLayer=void 0}},_clearAddressResultPoints:function(){this._geolocMarker&&this.globe.markerBag.removeMarkers([this._geolocMarker])},_visualizeAddressResultPoint:function(e){e&&(this._clearAddressResultPoints(),this._geolocMarker=this.globe.addMarker(parseFloat(e.lat),parseFloat(e.lon),0,"#ff0000","Geocoding result",e.display_name))},_cancelLocate:function(){this._listenWorldClick=!1,this.elements.btnLocator.checkFlag=!1},cleanup:function(){this._listenWorldClick=!1,this._prevValues={},this._clearAddressResultPoints(),this._clearWorldClickPoint(),this.elements.btnLocator.checkFlag=!1,this.elements.inputFreeForm.value="",this.elements.datagrid.empty()},_geocodeNominatimPromise:function(e,t={}){var i=this;return new Promise(function(o,s){i._geocodeNominatim(e,t,o,s,0)})},_geocodeNominatim:function(e,t,i,o,s){var n,r=this.url+"/search.php",a="q="+e,l={method:"GET",type:"json",data:a+="&polygon_geojson=1&format=jsonv2",headers:{"Content-Type":"application/json"},onComplete:function(e){i(e)},onFailure:function(r){429==n.xhr.status&&s<5?setTimeout(_geocode.bind(this,e,t,i,o,++s),1e3):o(r)}};n=g.request(r,l)},_filterOnPointsOnly:function(e){var t,i=[];for(t=0;t<e.length;t++){var o=e[t];"Point"==o.geojson.type&&i.push(o)}return i},_reverseGeocodeNominatimPromise:function(e,t={}){var i=this;return new Promise(function(o,s){i._reverseGeocodeNominatim(e,t,o,s,0)})},_reverseGeocodeNominatim:function(e,t,i,o,s){var n,r=this.url+"/reverse.php",a="lat="+e.lat+"&lon="+e.lon+"&zoom=18",l={method:"GET",type:"json",data:a+="&format=jsonv2",headers:{"Content-Type":"application/json"},onComplete:function(e){i(e)},onFailure:function(e){429==n.xhr.status&&s<5?setTimeout(_geocode.bind(this,address,t,i,o,++s),1e3):o(e)}};n=g.request(r,l)},_filterOnPointsOnly:function(e){return e},_launchClicks:function(){this.globe.clearMouseOver();this.globe.markerBag;var e=this,t={onMouseMove:function(e,t,i){},onMouseOut:function(){},onMouseDoubleClick:function(e,t,i){},onMouseClick:function(t,i,o){var s,n=e.frmWindow.getViewerFrame(),r=new d.Projector,a=new d.Vector3(i/n.clientWidth*2-1,-o/n.clientHeight*2+1,0),l=r.pickingRay(a,e.globe.camera.threeCamera).ray,h=l.origin,c=l.direction,g=new d.Vector3(0,0,0).sub(h),p=g.dot(c);g.copy(c).multiplyScalar(p).add(h);var m=g.lengthSq();if(!(m>1)){var f=p-Math.sqrt(1-m),v=c.clone().multiplyScalar(f).add(h);s=u.XYZToLatlon(v),this._locatorReverseGeocode(s)}}.bind(this),computeLatWithYclick:function(e){return e<.089655?20*e/.089655:e<.189655?20+20*(e-.089655)/.1:e<.327585?40+20*(e-.189655)/.13793:60+15*(e-.327585)/.172415},onClearCountries:function(){}};this.globe.mouseOverCountryManager=void 0,this.globe.mouseOverMarkersManager=t}})}),define("DS/SocialGlobe/TileBag3D",["DS/SocialGlobe/Globals","DS/SocialGlobe/Mesh","DS/SocialGlobe/TileBag","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils"],function(e,t,i,o,s){"use strict";return i.extend({init:function(t){this._parent(t),this.earthShadow=e.loadTextureCube("shadow","png"),this.reflection=e.loadTextureCube("R","png"),this.vertShader=["uniform int uFlip;","uniform int uNormalize;","uniform float uMixProj;","uniform float uDz2D;","uniform int uOSMMode;","uniform float uAspectRatio;","uniform vec3 offset;","const float PI = 3.14159;","varying vec3 vTextureCoord;","varying vec3 vNormal;","varying vec3 vTangent;","varying vec3 vBinormal;","void main() {","vTextureCoord = vec3(uv, 1.0);","if(offset.z != 0.0) {","vTextureCoord.xy = offset.z * uv;","}","if(offset.x != 0.0 || offset.y != 0.0) {","vTextureCoord.xy = vTextureCoord.xy + offset.xy;","}","vNormal = position;","vTangent = normalize(cross(vec3(0,1,0), position.xyz));","vBinormal = normalize(cross(vTangent, position.xyz));","gl_Position = projectionMatrix * viewMatrix  * modelMatrix * vec4(position.xyz, 1.0);","}"].join("\n"),this.fragShader=["precision highp float;","const float Eta = 1.0/1.2;","const float FresnelPower1 = 0.6;","const float FresnelPower2 = 2.0;","const float F = ((1.0 - Eta) * (1.0 - Eta)) / ((1.0 + Eta) * (1.0 + Eta));","const float PI = 3.14159;","varying vec3 vTextureCoord;","varying vec3 vNormal;","varying vec3 vTangent;","varying vec3 vBinormal;","uniform samplerCube uShadowSampler;","uniform sampler2D uOSMSampler;","uniform samplerCube uReflection;","void main() {","float uRefraction = 0.95;","float uLinesThickness = 1.0;","float uOccultancy = 1.0;","float uMixProj = 0.0;","float Eta = 1.0/uRefraction;","float F = ((1.0 - Eta) * (1.0 - Eta)) / ((1.0 + Eta) * (1.0 + Eta));","vec3 ttt = vec3(-vNormal.z, vNormal.y, vNormal.x);","vec4 OSMColor = texture2D(uOSMSampler, vTextureCoord.xy);","vec3 ocean = vec3(181.0/255.0, 208.0/255.0, 208.0/255.0);","OSMColor.a = 0.1 + 0.9*OSMColor.a;","vec4 shadow;","shadow = vec4(1.0, 1.0, 1.0, 1.0);","vec3 bump = vNormal; //vTextureCoord.xyz;","vec3 ecPosition3  = vNormal.xyz - cameraPosition;","vec3 i = normalize(ecPosition3);","vec3 n = bump;","float vRatio2 = F + (1.0 - F)*pow(1.0-clamp(dot(-i, n), 0.0, 1.0), FresnelPower2);","vec3 vReflect = reflect(i, n);","vec3 vRefract = refract(i,n,Eta);","float k = -2.0*dot(vRefract, vNormal);","vec3 vRR = k*vRefract + vNormal;","vRefract = vRR;","vec3 ttt1 = vec3(-vReflect.z, vReflect.y, vReflect.x);","vec4 reflection2 = vec4(vRatio2*textureCube(uReflection, ttt1).rgb, 0);","vRefract = normalize(vRefract);","vec4 diffuse2;","diffuse2 = textureCube(uShadowSampler, vec3(-vRefract.z, vRefract.y, vRefract.x));","diffuse2.a = 1.0 - diffuse2.r;","if(uLinesThickness > 0.0) {","float distance = 0.4*sqrt(length(cameraPosition)-1.0);","float lat = 180.0*acos(vRefract.y)/3.1459;","float lon = 180.0*asin(vRefract.z/sqrt(vRefract.z*vRefract.z + vRefract.x*vRefract.x))/3.1459;","if(vRefract.x < 0.0) {","lon = 180.0 - lon;","}","float modlat = mod(360.0+lat+10.0, 20.0);","float modlon = mod(360.0+lon, 20.0);","if(abs(modlat) < 0.25*uLinesThickness*distance || abs(modlon) < 0.5*uLinesThickness*distance ) {","diffuse2.a = 1.0;","}","lat = 180.0*acos(vNormal.y)/3.1459;","lon = 180.0*asin(vNormal.z/sqrt(vNormal.z*vNormal.z + vNormal.x*vNormal.x))/3.1459;","if(vNormal.x < 0.0) {","lon = 180.0 - lon;","}","modlat = mod(360.0+lat+10.0, 20.0);","modlon = mod(360.0+lon, 20.0);","if(abs(modlat) < 0.25*uLinesThickness*distance|| abs(modlon) < 0.5*uLinesThickness*distance ) {","OSMColor = OSMColor.a * OSMColor + (1.0 - OSMColor.a)*vec4(1.0, 1.0, 1.0, 1.0);","}","}","vec4 reflection;","vec4 diffuse1 = vec4(0.0*vec3(77.0/255.0,132.0/255.0,175.0/255.0), 0.7);//k/uOccultancy);","reflection = reflection2;","if (diffuse2.a > 0.5) diffuse2 = vec4(0.2,0.2,0.2,1);","else diffuse2 = vec4(0,0,0,0.0);","vec4 tmpCol;","tmpCol.rgb = (1.0-uMixProj)*1.5*reflection.rgb + diffuse1.a*diffuse1.rgb + (1.0-diffuse1.a)*diffuse2.rgb;","tmpCol.a = max(diffuse1.a, diffuse2.a);","float kk = 0.5;","gl_FragColor.rgb = OSMColor.rgb;","gl_FragColor.a = 1.0;","}"].join("\n"),this.showMeridians=!0,this.whitetexture=new o.DataTexture(new Float32Array([1,1,1,.5]),1,1,o.RGBAFormat,o.FloatType),this.whitetexture.flipY=!1,this.whitetexture.minFilter=o.LinearFilter,this.whitetexture.magFilter=o.LinearFilter,this.whitetexture.generateMipmaps=!0,this.whitetexture.needsUpdate=!0},getTileInfo:function(t,i,o){var s=t+"/"+i+"/"+o,n=this.tileMap[s];return n?n.tileInfo.pos:{center:e.latlonToXYZ(e.tile2lat(t,o+.5),e.tile2lon(t,i+.5)),ULcorner:e.latlonToXYZ(e.tile2lat(t,o+1),e.tile2lon(t,i)),LLcorner:e.latlonToXYZ(e.tile2lat(t,o),e.tile2lon(t,i)),URcorner:e.latlonToXYZ(e.tile2lat(t,o+1),e.tile2lon(t,i+1)),LRcorner:e.latlonToXYZ(e.tile2lat(t,o),e.tile2lon(t,i+1))}},getTile:function(i,s,n){var r,a,l,h,c,d,u,g,p,m,f,v,b,w=i+"/"+s+"/"+n,y=this.tileMap[w];if(y)return y;for(r=a=Math.max(2,64/(1<<i)),(l=new t(this.scene,"tile:"+i+"/"+s+"/"+n)).loaded=!0,l.setMaterial(this.createPlanetMaterial()),l.setPickMaterial(new o.MeshBasicMaterial({color:16711935})),h=0;h<=r;h++)for(u=s+(d=h/r),g=e.tile2lon(i,u),c=0;c<=a;c++)m=n+(p=c/a),f=e.tile2lat(i,m),v=e.latlonToXYZ(f,g),b=[d,1-p],l.addVertex(v.x,v.y,v.z,v.x,v.y,v.z,[b]);for(h=0;h<r;h++)for(c=0;c<a;c++)l.addFace([(r+1)*(h+1)+c,(r+1)*h+c,(r+1)*h+c+1]),l.addFace([(r+1)*(h+1)+c+1,(r+1)*(h+1)+c,(r+1)*h+c+1]);return l.endMesh({depth:i,pickable:"invisible"}),l.tileKey=w,l.tileInfo={level:i,tx:s,ty:n,pos:this.getTileInfo(i,s,n)},this.tileMap[w]=l,l},createPlanetMaterial:function(){if(""===this.fragShader||""===this.vertShader||""===this.fragShaderSolidOcean)return e.defaultMaterial;var t={uShadowSampler:{type:"t",value:this.earthShadow},uOSMSampler:{type:"t",value:this.whitetexture},offset:{type:"v3",value:new o.Vector3(0,0,1)},uReflection:{type:"t",value:this.reflection},uMixProj:{type:"f",value:0},uAspectRatio:{type:"f",value:1}},i=new o.ShaderMaterial({vertexShader:this.vertShader,uniforms:t,fragmentShader:this.fragShader});return i.side=o.FrontSide,i.forceSide=!0,i.force=!0,i.needsUpdate=!0,i},loadTexture:function(e,t,i,s){var n=new o.Texture,r=function(e){e.needsUpdate=!0,s(e)}.bind(this,n);return n.image=this.getTileImage(e,t,i,r),n.counter=this.textureCounter,n},destroyTile_internal:function(e){e.dispose(),this.destroyTileImage_internal(e)},unloadTextures:function(){var e;for(e in this.tileMap){this.tileMap[e].threeMaterial.uniforms.uOSMSampler.value=this.whitetexture}}})}),define("DS/SocialGlobe/MarkerBag",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/Marker","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/ClusterFactory"],function(e,t,i,o,s){"use strict";return e.extend({init:function(e){this.renderer=e,this.markerMaker=e.renderContext.buildMarkerMaker(e),this.markerTiles={},this.meshes={},this.clusters={},this.clusterLevel=0,this.maxLevel=10,this.allMarkers=[],this.markers=[],this._clustering=!1,this.allMarkersByLevel=[],this.allMarkersNodeByLevel=[];for(var t=0;t<15;t++)this.markers.push(new Array),this.allMarkersByLevel.push(new Array),this.allMarkersNodeByLevel.push(new Array);this.markerSkins={},this.somethingHasChanged=!1,this.needClearMeshes=!0,this.needClearClusters=!0},createCluster:function(e,t,o,s,n,r,a,l,h,c=!1){var d=new i(e,t,o,s,n,r,l,h,a);return d._manager=this,c&&(d.readOnly=c),this.addCluster(d),d},createMarker:function(e,t,o,s,n,r,a,l,h,c=!1){var d=new i(e,t,o,s,n,r,l,-1,h,a);return d._manager=this,c&&(d.readOnly=c),!0===this._clustering?this.addMarker2(d):this.addMarker(d),d},getMarkerRep:function(e,t,i,o){this.needClearMeshes&&(this.meshes={},this.needClearMeshes=!1);var s=[],n=[],r=[];if(!this.markerMaker)return null;var a,l=e+"/"+t+"/"+i;if(!this.meshes[l]&&(a=this.markerTiles[e+"/"+t+"/"+i])){for(var h=0;h<a.length;h++){var c=a[h];if(void 0!==c[0].image)n.push(c);else if(!0===o){for(var d=[],u=0;u<c.length;u++)c[u].level===this.clusterLevel&&d.push(c[u]);s.push(d)}else s.push(c)}for(u=0;u<n.length;u++){var g=n[u];void 0===this.markerSkins[g[0].image]&&(this.markerSkins[g[0].image]=this.markerMaker.createMarkerCustomMaterials(g[0].image));var p=this.markerMaker.createRenderable([g],this.markerSkins[g[0].image],this._clustering);r=r.concat(p)}s.length>0&&(void 0===this.markerSkins.default&&(this.markerSkins.default=this.markerMaker.createMarkerMaterials()),this.meshes[l]=this.markerMaker.createRenderable(s,this.markerSkins.default,this._clustering))}return this.meshes[l]?this.meshes[l]=this.meshes[l].concat(r):r.length>0&&(this.meshes[l]=r),this.meshes[l]},getMarkerRep2:function(e,t){void 0===this.markerSkins.default&&(this.markerSkins.default=this.markerMaker.createMarkerMaterials());for(var i=[],o=0;o<this.markers[e].length;o++){var s=this.markers[e][o];s.lat>t.point.lat-t.distance&&s.lat<t.point.lat+t.distance&&s.lon>t.point.lon-t.distance&&s.lon<t.point.lon+t.distance&&i.push(s)}return this.markerMaker.createRenderable(i,this.markerSkins.default,this._clustering)},getClusterRep:function(e,t){for(var i=[],o=[],n=0;n<this.allMarkersByLevel[e].length;n++){var r=this.allMarkersByLevel[e][n];if(r.lat>t.point.lat-t.distance&&r.lat<t.point.lat+t.distance&&r.lon>t.point.lon-t.distance&&r.lon<t.point.lon+t.distance){i.push(r);var a=this.allMarkersNodeByLevel[e][n];if(null==a){var l={uuid:0,name:""+r.point_count,style:{fillStyle:"#FFFFFF",font:"bold 14px Arial",maxWidth:200,strokeStyle:"#000000",textAlign:"center"},fontHeight:14,size:{width:53,height:53},pos:r.position};a=s.build(l),this.allMarkersNodeByLevel[e][n]=a}o.push(a)}}return o},updateMaterialBeforeDraw:function(){if(this.markerMaker)for(var e in this.markerMaker.updateMaterialBeforeDraw(),this.markerSkins){var t=this.markerSkins[e];this.markerMaker.updateMaterialUniforms(t.material),this.markerMaker.updateMaterialUniforms(t.pickMaterial)}},getAllMarkersWithOnScrenPosition:function(e,t,i){var o,s=e+"/"+t+"/"+i,n=this.markerTiles[s];if(n)for(o=0;o<n.length;o++)this.renderer.computeMarkerPositionOnScreen(n[o][0]);return n},getAllMarkersWithOnScrenPosition2:function(e){var t=this.markers[e];if(t)for(var i=0;i<t.length;i++)this.renderer.computeMarkerPositionOnScreen(t[i]);return t},addCluster:function(e){return this.allMarkersByLevel[e.level].push(e),e.id=this.allMarkersByLevel[e.level].length,e},addMarker2:function(e){return this.somethingHasChanged=!0,this.needClearMeshes=!0,e.id=e.fid,this.markers[e.level].push(e),e},addMarker:function(e){if(e.id<0){this.somethingHasChanged=!0,this.needClearMeshes=!0;var i,o,s,n,r,a,l=0;for(l=0;l<this.maxLevel;l++)if(i=.05/Math.pow(2,l),o=l+"/"+Math.floor(t.lon2tileFlt(e.lon,l))+"/"+Math.floor(t.lat2tileFlt(e.lat,l)),s=this.markerTiles[o]){for(n=!1,r=0,r=0;r<s.length&&!n;r++)a=s[r],e.position.distanceTo(a[0].position)<i&&(a.push(e),n=!0);n||s.push([e])}else s=[],this.markerTiles[o]=s,s.push([e]);return e.id=this.allMarkers.length,this.allMarkers.push(e),e}},removeMarkers:function(e){var t,i,o;for(o=this.allMarkers,this.clearMarkers(),t=0;t<o.length;t++)o[t].id=-1;for(t=0;t<e.length;t++)(i=o.indexOf(e[t]))>=0&&o.splice(i,1);for(t=0;t<o.length;t++)this.addMarker(o[t])},updateMarkerPosition:function(e){this.removeMarkers(e),this.addMarker(e)},getMarker:function(e){return this.allMarkers[e]},get:function(e){return this.allMarkers[e]},clearMarkers:function(){this.somethingHasChanged=!0,this.needClearMeshes=!0,this.markerTiles={},this.allMarkers=[],this.markers=[],this.allMarkersByLevel=[],this.allMarkersNodeByLevel=[],this.needClearClusters=!0;for(var e=0;e<15;e++)this.markers.push(new Array),this.allMarkersByLevel.push(new Array),this.allMarkersNodeByLevel.push(new Array)},refresh:function(e){this.removeMarkers(e);for(var t=0;t<e.length;t++)this.addMarker(e[t])},getMarkersSize:function(){return this.allMarkers.length}})}),define("DS/SocialGlobe/Feature",["UWA/Class","DS/SocialGlobe/Globals"],function(e,t){"use strict";return e.extend({init:function(e,t,i){this.geometry=e,this.properties=t,this.featureType=i}})}),define("DS/SocialGlobe/MessageDispatcher",["UWA/Class","DS/SocialGlobe/Globals","UWA/Class/Listener"],function(e,t,i){"use strict";return e.extend(i,{init:function(e,t,i,o){this.globe=e,this.dispatch=i,this.listen=o,this.widget=t,this.globe.getGlobe().addEvent("zoomEvent",this.emitZoom.bind(this)),this.globe.getGlobe().camera.addEvent("cameraMoveStart",this.emitCameraMoveStart.bind(this)),this.globe.getGlobe().camera.addEvent("cameraMoveEnd",this.emitCameraMoveEnd.bind(this)),this.globe.getGlobe().addEvent("emitMessage",this.emitMessage.bind(this)),this.listen.addListener("GlobeViewer.Marker.add",this.addMarkerEvent.bind(this)),this.listen.addListener("GlobeViewer.Marker.clear",this.clearMarkersEvent.bind(this)),this.listen.addListener("GlobeViewer.Country.add",this.addCountryEvent.bind(this)),this.listen.addListener("GlobeViewer.Country.clear",this.clearCountriesEvent.bind(this)),this.listen.addListener("GlobeViewer.Camera.move",this.cameraMoveEvent.bind(this)),this.listen.addListener("GlobeViewer.loadJSON",this.loadJSONEvent.bind(this))},addMarkerEvent:function(e){var t=e.text.split(",");this.globe.addMarker(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),t[3],t[4],t[5])},clearMarkersEvent:function(e){this.globe.clearMarkers()},addCountryEvent:function(e){var t=e.text.split(","),i=this.globe.getCountryManager().get(this.globe.getCountryManager().getIndexFromISO3(t[0]));i.setHtmlColor(t[1]),i.description=t[2]},clearCountriesEvent:function(e){this.globe.clearCountries()},cameraMoveEvent:function(e){var t=e.text.split(",");3===t.length&&this.globe.turnGlobeToLatLon(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))},loadJSONEvent:function(e){this.globe.displayJSONData(!0,e.text)},emitZoom:function(){var e=this.globe.getGlobe().getBBox(),t=e.point.lat+" "+e.point.lon+" "+e.distance+" "+this.globe.getGlobe().camera.level+" "+this.globe.getGlobe().camera.dist;this.sendMessage("Globe.Camera.Zoom",t)},emitCameraMoveStart:function(){var e=this.globe.getGlobe().getBBox(),t=e.point.lat+" "+e.point.lon+" "+e.distance+" "+this.globe.getGlobe().camera.level;this.sendMessage("Globe.Camera.MoveStart",t)},emitCameraMoveEnd:function(){var e=this.globe.getGlobe().getBBox(),t=e.point.lat+" "+e.point.lon+" "+e.distance+" "+this.globe.getGlobe().camera.level;this.sendMessage("Globe.Camera.MoveEnd",t)},emitMessage:function(e){this.sendMessage(e.key,e.text)},sendMessage:function(e,t){void 0!==this.widget.environment.socket&&this.widget.environment.socket.dispatchEvent(e,{widgetID:this.widget.id,text:t})}})}),define("DS/SocialGlobe/GlobeLoader",["UWA/Class","DS/SocialGlobe/Globals","DS/WebappsUtils/WebappsUtils"],function(e,t,i){"use strict";return e.extend({init:function(){this.countryColors=[],this.defaultColor=null,this.randomize=!1,this.randomAmplitude=.1,this.randomTable=[],this.colorsHaveChanged=!1},loadBinaryFile:function(e){this.request=function(){try{return new XMLHttpRequest}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}throw new Error("Could not create HTTP request object.")}(),this.request.open("GET",i.getWebappsAssetUrl("SocialGlobe","data/dssocialglobe.bin"),!0),this.request.responseType="arraybuffer";var t=this;this.request.onload=function(){t.onLoad(),e.getDataModel()&&e.getDataModel().refresh()},this.request.send()},setDefaultColor:function(e,i,o){this.defaultColor=t.htmlToRGB(e),this.randomize=i,this.randomAmplitude=o,this.dirty=!0},getCountryColor:function(e){var t,i,o=this.countryColors[e];if(!o&&this.defaultColor)if(this.randomize){for(;!this.randomTable[e];)this.randomTable[e]=Math.random()-.5;for(o=[],t=0;t<3;t++)i=this.defaultColor[t]+this.randomAmplitude*this.randomTable[e],o[t]=i>=0?i<=1?i:1:0}else o=this.defaultColor;else o||(o=null);return o},refresh:function(){this.dirty&&(this.refreshColors_internal(),this.dirty=!1)},onLoad:function(){function e(e){return 2*Math.PI*e/Math.pow(2,16)}var t,i,o,s,n,r,a,l,h,c,d,u,g,p,m,f,v,b=this.request.response,w=new Uint16Array(b),y=0,M=w[y++];for(t=0;t<M;t++){for(this.newCountryMesh(t),i=w[y++],o=0;o<i;o++)s=Math.PI/2-e(w[y++]),n=e(w[y++])+Math.PI,this.addCountryVertex(s,n,t);for(y++,r=w[y++],a=0,a=0;a<r;a++)h=w[y++],c=w[y++],d=w[y++],this.addCountryFace([h,c,d]);for(u=w[y++],g=0,g=0;g<u;g++)for(this.newCountryPolygon(),m=w[y++],p=0;p<m;p++)for(this.startCountryPolygonLoop(0===p),v=w[y++],f=0;f<v;f++)l=w[y++],this.addCoutryPolygonLoopVertex(l),s=Math.PI/2-e(w[y++]),n=e(w[y++])+Math.PI;this.endCountryMesh()}this.endLoad(),this.dirty=!0},endLoad:function(){}})}),define("DS/SocialGlobe/GlobeLoader3D",["DS/SocialGlobe/Globals","DS/SocialGlobe/GlobeLoader","DS/SocialGlobe/Mesh","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils","DS/Plugins/RenderPass","DS/Plugins/ClearPass"],function(e,t,i,o,s,n,r){"use strict";return t.extend({init:function(e,t){this._parent(),this.scene=e;var i=new r("CountryClearDepthPass");if(i.defaults.clear=!1,i.defaults.doClearDepth=!0,this.scene.getRenderPassManager().addPass("CountryClearDepthPass",i,{post:!0}),this._Globe3DPassID="CountryPassID",void 0===this.scene.getRenderPassManager().getPass(this._Globe3DPassID)){var o=new n(null,null,void 0,!0,!0,!1,this._Globe3DPassID);o.idString=this._Globe3DPassID,o.setDisableBackFaceCulling(!1),this.scene.getRenderPassManager().addPass(this._Globe3DPassID,o,{after:"CountryClearDepthPass"})}this.vertShader=["///attribute vec3 position;","//attribute vec2 uv;","uniform int uFlip;","uniform int uNormalize;","uniform float uMixProj;","uniform float uDz2D;","uniform int uOSMMode;","uniform float uAspectRatio;","uniform vec3 offset;","const float PI = 3.14159;","varying vec3 vTextureCoord;","varying vec3 vNormal;","varying vec3 vTangent;","varying vec3 vBinormal;","void main()","{","/*            gl_Position =   projectionMatrix *","                        viewMatrix *","                        modelMatrix *","                        vec4(position,1.0);","    return;*/","   // Move vertex to proper world position (initial geometry is a cube)","   vec3 OP =  vec4(position,1.0).xyz;","   vec3 VP;","   float radius = 1.0;","   float dz = 0.0;","   if(uNormalize == 1)","   {","//     radius = 0.985;","       radius = 0.998;","       VP = normalize(OP);","       vTextureCoord = VP;","        //vTextureCoord.xy = VP.xy*offset.z + offset.xy;","       vNormal = VP;","       vTangent = normalize(cross(vec3(0,1,0), vNormal));","       vBinormal = normalize(cross(vTangent, vNormal));","   }","   else","   {","       VP = OP;","       // Sampling texture in a cube map -> UV are then xyz of normal vector...","       //  which happen to be the vertices positions for a unit sphere","       //vec3 P2 =  normalize( (uMBWMatrix * vec4(position,1.0)).xyz );","       vec3 P2 =  VP;","       // Sampling texture in a cube map -> UV are then xyz of normal vector...","       //  which happen to be the vertices positions for a unit sphere","       vTextureCoord = vec3(uv, 1.0);","        vTextureCoord.xy = offset.z * uv + offset.xy;","       vNormal = position;","       vTangent = normalize(cross(vec3(0,1,0), VP));","       vBinormal = normalize(cross(vTangent, VP));","   }","   vec3 projP = vec3(VP.x, 0.0, VP.z);","   if(length(projP) < 0.001)","   {","       projP = vec3(1.0, 0.0, 1.0);","   }","   vec3 normalizedProjP = normalize(projP);","   float sign = 0.0;","   if(normalizedProjP.z > 0.0)","       sign = -1.0;","   else","       sign = 1.0;","   float angle = sign*acos(normalizedProjP.x);","    if (normalizedProjP.x > 0.99999)","        angle = 0.0;","    if (normalizedProjP.x < -0.99999)","        angle = 0.0;","   if(uFlip != 0 && angle > 0.0)","   {","       angle -= 2.0*PI;","   }","   float x = angle / PI;","   float MixProj  = uOSMMode != 2 ? uMixProj : 0.0;","   // Final position in projected view space","   vec4 pre_gl_Position_3d;","   vec4 pos = ( viewMatrix  * modelMatrix * vec4(radius*VP, 1.0) );","   pre_gl_Position_3d = projectionMatrix * pos;","   vec4 pre_gl_Position_2d;","   float yangle = asin(VP.y);","   float minangle = 1.31;","   if(yangle < -minangle)","   {","       yangle = -minangle;","   }","   else","   {","       if(yangle > minangle)","       {","           yangle = minangle;","       }","   }","   float y2d = uAspectRatio*log(tan(PI/4.0+yangle*0.5))/ PI;","   pre_gl_Position_2d = vec4(x, y2d, uDz2D, 1.0);","   gl_Position = MixProj*pre_gl_Position_2d + (1.0 - MixProj)*pre_gl_Position_3d;","   //gl_Position = pre_gl_Position_3d;","}",""].join("\n"),this.fragShader=["precision lowp float;","uniform vec4 uColor;","void main() ","{  ","   gl_FragColor = uColor;","   return;","}",""].join("\n"),this.countryMeshes=[],this.polylineMeshes=[],this.loadBinaryFile(t),this.dirty=!0},incrementShadersLoaded:function(e,t){t},createPlanetMaterial:function(t,i,s){if(""===this.fragShader||""===this.vertShader)return e.defaultMaterial;var n={uColor:{type:"v4",value:new o.Vector4(t,i,s,1)},uMixProj:{type:"f",value:.5},uAspectRatio:{type:"f",value:1}},r=new o.ShaderMaterial({uniforms:n,vertexShader:this.vertShader,fragmentShader:this.fragShader});return r.transparent=!0,r.side=o.FrontSide,r.forceSide=!0,r.force=!0,r},newCountryMesh:function(e){var t=this.createPlanetMaterial(e/255,e/255,e/255),o=new i(this.scene,"country_"+e,e,this._Globe3DPassID);o.setMaterial(t),this.countryMeshes.push(o)},addCountryVertex:function(e,t){var i=Math.cos(-e)*Math.cos(-t),o=-Math.sin(-e),s=Math.cos(-e)*Math.sin(-t),n=(t+Math.PI)/Math.PI,r=(e+Math.PI)/(2*Math.PI);this.countryMeshes[this.countryMeshes.length-1].addVertex(i,o,s,i,o,s,[[n,r]])},addCountryFace:function(e){this.countryMeshes[this.countryMeshes.length-1].addFace(e)},endCountryMesh:function(){var e=this.countryMeshes[this.countryMeshes.length-1];e.endMesh({depth:300,pickable:"pickable"}),this.scene.addObject(e),e.setVisibility(!0),e.setColorRGBA("uColor",[0,0,0,0])},refreshCountry:function(e){var t=e.color;e.colorOverride&&(t=e.colorOverride);var i=this.countryMeshes[e.ID];i&&(t?(i.setVisibility(!0),i.setColorRGB("uColor",t)):(i.setVisibility(!0),i.setColorRGBA("uColor",[0,0,0,0]))),this.dirty=!0},refreshColors_internal:function(){},newCountryPolygon:function(){},startCountryPolygonLoop:function(e){},addCoutryPolygonLoopVertex:function(e){}})}),define("DS/SocialGlobe/GeoJSONItem",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/Vector2","DS/SocialGlobe/Marker","DS/SocialGlobe/Feature"],function(e,t,i,o,s){"use strict";return e.extend({init:function(){this.features=[]},build:function(e){this.handleNode(e)},handleNode:function(e,i){switch(e.type){case"FeatureCollection":this.handleFeatureCollection(e);break;case"Feature":this.handleFeature(e);break;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":case"Polygon":case"MultiPolygon":this.features.push(new s(e,i,e.type));break;default:t.alert("Unknown GeoJSON node type")}},handleFeatureCollection:function(e){var t,i=e.features;for(t=0;t<i.length;t++)this.handleNode(i[t])},handleFeature:function(e){this.handleNode(e.geometry,e.properties)},addToRenderer:function(e){var t=0;for(t=0;t<this.markers.length;t++)this.markerBag.addMarker(this.markers[t]);for(t=0;t<this.objects.length;t++)e.addObject(this.objects[t])},removeFromRenderer:function(e){this.markerBag.removeMarkers(this.markers);var t=0;for(t=0;t<this.objects.length;t++)e.removeObject(this.objects[t])},floatsToVectors:function(e){var t=0,o=[];for(t=0;t<e.length;t++){var s=0;e[t][2]&&(s=e[t][2]),o.push(new i(e[t][0],e[t][1],s))}return o},getFeatures:function(){return this.features}})}),define("DS/SocialGlobe/VisuStore",["UWA/Class","UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Disposer","DS/SocialGlobe/Globals"],function(e,t,i,o,s){"use strict";return e.extend(t,{init:function(e){this.stores=[],this.params={},this.params.baseUrl=e,this.params.credentials=s.credentials,this.vqt=void 0,this.dlSize=0,this.inProcessDL=0,this.maxAllowedDL=6,this.DLQueue=[],this.inProcess=!0,this.buildSize=0,this.inProcessBuild=0,this.maxAllowedBuild=1,this.buildQueue=[],this.timeStamp=0,this.cleanupTime=0,this.numGetOrDownload=0,this.cleanlodBias=-100,this.frameCleanUp=0,this.loadBind=this.load.bind(this),this.buildBind=this.build.bind(this)},makeStore:function(e,t,i,o,s,n,r,a,l,h,c){var d={storeId:e,url:t,loader:o,builder:s,loadedCount:0,type:i,toClean:!1,priority:n,priorityOffset:0,limit:r,childCanUseParent:a,childNeedParent:l,levelMin:h,levelMax:Number.MAX_VALUE,levelMinCache:h,data:{}};return this[e]=d,this.stores.push(this[e]),this[e].size=0,this[e].lodBias=0,void 0!==c&&(this[e].levelMax=c),a&&0==d.levelMin&&this.addToDLQueue(e,0,0,0,void 0,100,100),d},makeStoreByJSON:function(e,t,i,o,s,n){var r={storeId:e,url:t.url,loader:i,builder:o,priority:2,priorityOffset:0,cache:200,childCanUseParent:s,childNeedParent:n,levelMin:0,levelMax:Number.MAX_VALUE,size:0,lodBias:0,loadedCount:0,invertY:!1,toClean:!1,levelMinCache:0,data:{}};for(var a in r)r.hasOwnProperty(a)&&void 0!==t[a]&&(r[a]=t[a]);return this[e]=r,this.stores.push(this[e]),s&&0==r.levelMin&&this.addToDLQueue(e,0,0,0,void 0,100,100),r},getData:function(e,t,i,o){var s,n=this[e];if(null!=n){if(n.invertY&&(o=(1<<t)-1-o),void 0!==(s=n.data[t+"_"+i+"_"+o])&&void 0!==s.data)return this.touch(s);if(n.childCanUseParent){var r,a=2,l=i,h=o;for(r=t-1;r>=0;r-=1){if(l=Math.floor(i/a),h=Math.floor(o/a),void 0!==(s=n.data[r+"_"+l+"_"+h])&&void 0!==s.data)return this.touch(s),{data:s.data,LOD:r,scale:1/a,offset:{x:i/a-l,y:o/a-h},isLeaf:r===Math.max(0,n.levelMax-n.lodBias)};a*=2}}}else console.log("Error store unknow: "+e)},updateTimeStamp:function(e,t,i,o){var s=this[e];this.touch(s.data[t+"_"+i+"_"+o])},getOrDownloadData:function(e,t,i,o,s,n){this.numGetOrDownload++,void 0===n&&(n=0);var r=this[e];if(null!=r){!0===r.invertY&&(o=(1<<t)-1-o);var a,l=t,h=i,c=o,d=1,u=r.lodBias;l-r.levelMax>u&&(u=l-r.levelMax),u>0&&(l-=u=Math.min(l,u),d=1<<u,h=Math.floor(i/d),c=Math.floor(o/d));var g=l+"_"+h+"_"+c,p=void 0;if(void 0!==(a=this.touch(r.data[g]))){if(void 0!==a.data)return u>0?{data:a.data,LOD:l,I:h,J:c,scale:1/d,offset:{x:i/d-h,y:!0!==r.invertY?1-1/d-(o/d-c):1-1/d-o/d-c}}:a;void 0!==a.lodParentTest&&(p=a.lodParentTest)}var m=void 0,f=void 0,v=l-1;if(r.childCanUseParent){y=2*d;var b=i,w=o;for(v=l-1;v>=r.levelMin&&void 0===m;v-=1)b=Math.floor(i/y),w=Math.floor(o/y),void 0!==(f=r.data[v+"_"+b+"_"+w])&&(this.touch(f),void 0!==f.data?m={data:f.data,LOD:v,I:b,J:w,scale:1/y,offset:{x:i/y-b,y:!0!==r.invertY?1-1/y-(o/y-w):o/y-w},isLeaf:f.isLeaf||p&&p.LOD==v}:p&&(f.lodParentTest&&f.lodParentTest.LOD<=p.LOD?(p.LOD=f.lodParentTest.LOD,f.lodParentTest=p):p.LOD=v-1)),y*=2}if(r.childNeedParent){if(void 0!==a&&void 0===a.data)return a;if(l===r.levelMin)this.addToDLQueue(e,l,h,c,s,l+n,0);else{var y=2*d;b=h,w=c;for(v=l-1;v>=r.levelMin;v-=1){b=Math.floor(i/y),w=Math.floor(o/y);var M=r.data[v+"_"+b+"_"+w];if(v===l-1&&void 0!==M&&void 0!==M.data&&!0!==M.isLeaf)return this.addToDLQueue(e,l,h,c,s,l+n,0),m;if(void 0!==M&&(void 0===M.data||!0===M.isLeaf))return a;y*=2}}}else{var S=!1,C=4*Math.floor(l/4);if(p&&(C=4*Math.floor(p.LOD/4)),l>C+1)for(var k=C;k>v+1&&!1===S;k-=4){var x=Math.floor(1*h/(1<<l-k)),D=Math.floor(1*c/(1<<l-k));void 0===r.data[k+"_"+x+"_"+D]&&(S=!0,this.addToDLQueue(e,k,x,D,s,l+n,l-v))}0==S&&(void 0===a?this.addToDLQueue(e,l,h,c,s,l+n,l-v):m&&p&&p.LOD>m.LOD&&this.addToDLQueue(e,p.LOD,Math.floor(1*h/(1<<l-p.LOD)),Math.floor(1*c/(1<<l-p.LOD)),s,l+n,l-v))}return m}console.log("Error store unknow: "+e)},addToDLQueue:function(e,t,i,o,s,n,r){var a=e+"_"+t+"_"+i+"_"+o,l=this.DLQueue[a];if(void 0!==l)return this.touch(l),void(l.priority=Math.max(l.priority,this[e].priority*n+this[e].priorityOffset*r));var h=this.buildQueue[a];void 0===h?this.DLQueue[a]={storeId:e,LOD:t,I:i,J:o,timeStamp:this.timeStamp,priority:this[e].priority*n+this[e].priorityOffset*r,isPending:!1}:this.touch(h)},load:function(e,t,i,o){this.inProcessDL+=1;var s=this[e].url.replace("%l",t).replace("%x",i).replace("%y",o),n=e+"_"+t+"_"+i+"_"+o,r=this;this[e].loader(this.params,function(a,l,h){if(r.inProcessDL-=1,!r.DLQueue[n].disabled){var c=t+"_"+i+"_"+o;204===h||a&&(0==a.byteLength||0==a.size||""===a)?r[e].data[c]=r.touch({data:void 0,LOD:t,I:i,J:o,scale:1,offset:{x:0,y:0},isLeaf:!0,lodParentTest:{LOD:t-1}}):void 0!==a&&!0===l?(a.url=s,void 0!==r[e].builder?r.buildQueue[n]=r.touch({storeId:e,file:a,LOD:t,I:i,J:o,isPending:!1,priority:r.DLQueue[n].priority,isLeaf:207===h||t===Math.max(0,r[e].levelMax-r[e].lodBias)}):r[e].data[c]=r.touch({data:a,LOD:t,I:i,J:o,scale:1,offset:{x:0,y:0},isLeaf:207===h||t===Math.max(0,r[e].levelMax-r[e].lodBias)})):r[e].data[c]=r.touch({data:void 0,LOD:t,I:i,J:o,scale:1,offset:{x:0,y:0},isLeaf:!0,lodParentTest:{LOD:t-1}})}delete r.DLQueue[n]},s,t,i,o)},build:function(e,t,i,o){this.inProcessBuild+=1;var s=t+"_"+i+"_"+o,n=e+"_"+s,r=this;this[e].builder(function(a,l,h){r.inProcessBuild-=1,!0!==r.buildQueue[n].disabled&&(!0===l||!1===l&&void 0===a)&&(void 0===r.buildQueue[n]||(r[e].data[s]=r.touch({data:a,LOD:t,I:i,J:o,scale:1,offset:{x:0,y:0},isLeaf:h||r.buildQueue[n].isLeaf}))),delete r.buildQueue[n]},this.buildQueue[n].file,t,i,o)},pollQueues:function(){var e=this.dlSize>0||this.buildSize>0;this.inProcessDL<this.maxAllowedDL&&(this.dlSize=this.pollQueue(this.DLQueue,this.inProcessDL,this.maxAllowedDL,this.loadBind)),this.inProcessBuild<this.maxAllowedBuild&&(this.buildSize=this.pollQueue(this.buildQueue,this.inProcessBuild,this.maxAllowedBuild,this.buildBind)),e=e||this.inProcessDL>0||this.inProcessBuild>0,this.inProcess!==e&&(this.inProcess=e,this.dispatchEvent("onProcess",e))},pollQueue:function(e,t,i,o){var s=[],n=[];for(var r in e){var a=e[r];!1===a.isPending&&(void 0!==a.timeStamp&&a.timeStamp>=this.timeStamp||0===a.LOD?s.push(e[r]):n.push(r))}for(var l=0;l<n.length;l++)delete e[n[l]];var h=s.length;s.sort(function(e,t){return e.priority-t.priority});var c=Math.min(s.length,i-t);for(l=s.length-1;l>=s.length-c;l--)s[l].isPending=!0,o(s[l].storeId,s[l].LOD,s[l].I,s[l].J);return h},touch:function(e){return void 0!==e&&(e.timeStamp=this.timeStamp,e.data&&e.data.update&&e.data.update(this.timeStamp)),e},cleanupStores:function(){if(this.frameCleanUp%60==0){this.frameCleanUp=0;for(var e=Date.now(),t=0;t<this.stores.length;t++)this.cleanupStore(this.stores[t]);this.cleanupTime=Date.now()-e}this.frameCleanUp++},traverse:function(e,t){var i=this[e];for(var o in i.data){var s=i.data[o];s.data&&t(s.data)}},clearBuild:function(e){for(var t in this.buildQueue)t.split("_")[0]===e&&(this.buildQueue[t].disabled=!0)},cleanupStore:function(e){var t=[],i=0;for(var o in e.data){(l=e.data[o]).LOD>e.levelMinCache&&(this.timeStamp>l.timeStamp&&null==l.shared&&(l.name=o,t.push(l)),i++)}if(e.size=i,!(i<=e.cache)){var s=this.cleanlodBias;t.sort(function(e,t){return t.timeStamp-e.timeStamp+s*(t.LOD-e.LOD)});for(var n=Math.max(0,Math.min(t.length,i-Math.floor(.75*e.cache))),r=t.length-n,a=t.length;r<a;r++){var l;null!==(l=t[r]).data&&this.dispose(l.data),l.data=void 0,delete e.data[l.name],t[r]=void 0}}},dispose:function(e){void 0!==e&&o.disposeV6(e)},clean:function(e){if(e){var t=this[e];this.clearBuild(e),this.traverse(e,this.dispose),t.data={}}else for(var i in this.stores)this.clearBuild(i),this.traverse(i,this.dispose),this.stores[i].data={}},_debug:function(e){var t="DL queue : "+this.dlSize+"<br />Build queue : "+this.buildSize+"<br />Cleanup time : "+this.cleanupTime+"<br />Poll time: "+this.pollTime;this.numGetOrDownload=0;for(var i=0;i<this.stores.length;i++)t+="<br />- "+this.stores[i].storeId+": "+this.stores[i].size+" / "+this.stores[i].cache,this.stores[i].nodeClean=0;return t},_cleanupTime:function(e){var t=this.cleanupTime;return this.cleanupTime=0,t},_getStoreLength:function(){for(var e=0,t=0;t<this.stores.length;t++)e+=Object.keys(this.stores[t]).length;return e}})}),define("DS/SocialGlobe/Halo3D",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/Mesh","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils"],function(e,t,i,o,s){"use strict";return e.extend({init:function(e){this.scene=e,this.vertShader=["///attribute vec3 position;","//attribute vec2 uv;","/*","uniform mat4 uMBWMatrix;   ","uniform mat4 uMVMatrix;","uniform mat4 uMPMatrix;","uniform int uFlip;","uniform int uNormalize;","uniform float uMixProj;","uniform float uDz2D;","uniform int uOSMMode;","*/","const float PI = 3.14159;","varying vec3 vTextureCoord;","varying vec3 vNormal;","varying vec3 vTangent;","varying vec3 vBinormal;","void main() ","{","    mat4 mvMat = viewMatrix * modelMatrix;","    vec3 up = vec3(mvMat[0][0], mvMat[1][0], mvMat[2][0]);","    vec3 right = vec3(mvMat[0][1], mvMat[1][1], mvMat[2][1]);","    vec3 posi = 2.0*uv.x*right + 2.0*uv.y*up;","    vTextureCoord = posi;","    gl_Position =   projectionMatrix * ","                mvMat * ","     // 0.00001*position.x: needed because otherwise position will be removed by optimizer and then generate a warning","               vec4(posi,1.0+0.00001*position.x);","    ","    return;","}",""].join("\n"),this.fragShader=["precision lowp float;","uniform vec4 uColor;","uniform float uIntensity;","varying vec3 vTextureCoord;","uniform float uMixProj;","void main() ","{  ","   vec3 vdir  = vTextureCoord.xyz - cameraPosition;","   float d = length(cross(cameraPosition, vdir))/length(vdir) - 1.0;","    bool neg = d < 0.0;","    ","    float uStartRadius = 1.0;","    float uEndRadius = 1.05;","   float sigma = uEndRadius - uStartRadius;","    float ddd = (neg ? 2.0 : 1.0)*(1.0+d - uStartRadius)/sigma;","    float k = 0.75*exp(-0.5*ddd*ddd)*uIntensity;","    ","   gl_FragColor = vec4(uColor.rgb, (1.0-sqrt(uMixProj))*k);","   return;","}",""].join("\n"),this.color="#efefff",this.intensity=1},createMesh:function(){var e=new i(this.scene,"halo"),t=this.createHaloMaterial();return e.setMaterial(t),e.setPickMaterial(new o.MeshBasicMaterial({color:16711935})),e.addVertex(0,0,0,0,0,0,[[-1,-1,0]]),e.addVertex(0,0,0,0,0,0,[[1,-1,0]]),e.addVertex(0,0,0,0,0,0,[[1,1,0]]),e.addVertex(0,0,0,0,0,0,[[-1,1,0]]),e.addFace([0,2,1]),e.addFace([3,2,0]),e.endMesh({depth:1,pickable:"invisible"}),e},createHaloMaterial:function(){if(""===this.fragShader||""===this.vertShader)return t.defaultMaterial;var e=t.htmlToRGB(this.color),i={uMixProj:{type:"f",value:.5},uColor:{type:"v4",value:new o.Vector4(e[0],e[1],e[2],1)},uIntensity:{type:"f",value:this.intensity},uAspectRatio:{type:"f",value:1}},s=new o.ShaderMaterial({uniforms:i,vertexShader:this.vertShader,fragmentShader:this.fragShader});return s.transparent=!0,s.side=o.FrontSide,s.forceSide=!0,s.force=!0,s}})}),define("DS/SocialGlobe/PoleCreator3D",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/Mesh","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Utils","DS/WebappsUtils/WebappsUtils","DS/Plugins/RenderPass"],function(e,t,i,o,s,n,r){"use strict";return e.extend({init:function(e,t,i){if(this.skin=i,this.scene=e,this._PolePassID="PolePassID",void 0===this.scene.getRenderPassManager().getPass(this._PolePassID)){var s=new r(null,null,void 0,!0,!0,!1,this._PolePassID);s.idString=this._PolePassID,s.setDisableBackFaceCulling(!1),this.scene.getRenderPassManager().addPass(this._PolePassID,s,{pre:!0})}this.vertShader=t.vertShader,this.fragShader=t.fragShader,this.earthShadow=t.earthShadow,this.reflection=t.reflection,this.showMeridians=!0,this.whitetexture=new o.DataTexture(new Float32Array([1,1,1,1]),1,1,o.RGBAFormat,o.FloatType),this.whitetexture.flipY=!1,this.whitetexture.minFilter=o.LinearFilter,this.whitetexture.magFilter=o.LinearFilter,this.whitetexture.generateMipmaps=!1,this.whitetexture.needsUpdate=!0},createMesh:function(e){var s,r,a=n.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/"+this.skin+"/poles/"),l=new i(this.scene,"pole",void 0,this._PolePassID),h=10,c=e?1:-1,d=e?a+"NE2_HR_LC_SR_W_cm_N"+t.tileExtension:a+"NE2_HR_LC_SR_W_cm_S"+t.tileExtension;"tms-user"===this.skin&&e?d=t.tilespath+"2/0/0"+t.tileExtension:"tms-user"!==this.skin||e||(d=t.tilespath+"2/2/3"+t.tileExtension);var u=this.createPoleMaterial(l,d,e);for(l.setMaterial(u),s=0;s<=h;s++)for(r=0;r<=h;r++){var g=new o.Vector3(.018*s-.09,c,.018*r-.09);g.normalize(),e?l.addVertex(g.x,g.y,g.z,g.x,g.y,g.z,[[.545-.09*r/h,.545-.09*s/h]]):l.addVertex(g.z,g.y,g.x,g.z,g.y,g.x,[[.545-.09*s/h,.455+.09*r/h]])}for(s=0;s<h;s++)for(r=0;r<h;r++)l.addFace([11*(s+1)+r,11*s+r,11*s+r+1]),l.addFace([11*(s+1)+r+1,11*(s+1)+r,11*s+r+1]);return l.endMesh({depth:0,pickable:"occulting"}),l},createPoleMaterial:function(e,i,n){var r={uShadowSampler:{type:"t",value:this.earthShadow},uOSMSampler:{type:"t",value:this.whitetexture},uReflection:{type:"t",value:this.reflection},uMixProj:{type:"f",value:.5},uAspectRatio:{type:"f",value:1},offset:{type:"v3",value:new o.Vector3(0,0,1)},externalFactor:{type:"f",value:n?1.07:1},externalAlpha:{type:"f",value:n?1/255:1},externalThickness:{type:"f",value:this.showMeridians?1:0}},a=new o.ShaderMaterial({vertexShader:this.vertShader,uniforms:r,fragmentShader:this.fragShader}),l={};l.credentials=t.credentials;s.loadTexture(l,function(t){e.loaded=!0,a.uniforms.uOSMSampler.value=t,a.needsUpdate=!0},i);return a.depthTest=!1,a.depthWrite=!1,a.force=!0,a.side=o.FrontSide,a.forceSide=!0,a}})}),define("DS/SocialGlobe/Camera3D",["UWA/Class/Events","DS/SocialGlobe/Globals","DS/SocialGlobe/Camera","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/Gestures/MouseDownGesture","DS/Gestures/MouseUpGesture","DS/Gestures/MouseMoveGesture","DS/Gestures/MouseOutGesture","DS/Gestures/MouseWheelGesture","DS/Gestures/DoubleClickGesture","DS/Gestures/ClickGesture","DS/Gestures/TouchGesture","DS/Gestures/PinchGesture","DS/Gestures/ReleaseGesture","DS/Gestures/PanGesture"],function(e,t,i,o,s,n,r,a,l,h,c,d,u,g,p,m,f,v){"use strict";return i.extend(e,{init:function(e,t){this._parent(e,t),this.viewAngle=25,this.near=9e-5,this.far=25,this.lookAt=new o.Vector3(0,0,0),this.moving=!1,this.unzoomButton=null;var i,p=e.getCanvas();i=p.width/p.height,this.v6Viewpoint=new s({viewer:e.v6Viewer}),this.threeCamera=new o.PerspectiveCamera(this.viewAngle,i,this.near,this.far),this.v6Viewpoint.camera=this.threeCamera,this.control=this.v6Viewpoint.control,n.addGestureRecognizer(new h),n.addGestureRecognizer(new d),n.addGestureRecognizer(new c),n.addGestureRecognizer(new a(r.MouseButton.LEFT)),n.addGestureRecognizer(new a(r.MouseButton.RIGHT)),n.addGestureRecognizer(new a(r.MouseButton.WHEEL)),n.addGestureRecognizer(new a(r.MouseButton.MIDDLE)),n.addGestureRecognizer(new l(r.MouseButton.LEFT)),n.addGestureRecognizer(new l(r.MouseButton.RIGHT)),n.addGestureRecognizer(new l(r.MouseButton.MIDDLE)),n.addGestureRecognizer(new m);var f=new g(r.MouseButton.LEFT),v=new u(r.MouseButton.LEFT);v.requireGesture(f),v.maxTime=400,n.addGestureRecognizer(f),n.addGestureRecognizer(v),this.updateCamera()},updateCamera:function(){if(Math.abs(this.deltaXCamera)>1e-4||Math.abs(this.deltaYCamera)>1e-4){var e=.005*(this.dist-1);this.camPosition.x-=this.deltaXCamera*e,this.camPosition.y=Math.min(1,Math.max(0,this.camPosition.y-this.deltaYCamera*e)),this.lat=t.tile2lat(0,this.camPosition.y),this.lon=t.tile2lon(0,this.camPosition.x),this.lon=this.correctLon(this.lon),this.deltaXCamera-=.1*this.deltaXCamera,this.deltaYCamera-=.1*this.deltaYCamera,this.changed=!0,this.moving||(this.dispatchEvent("cameraMoveStart",["null"]),this.moving=!0)}else this.deltaXCamera=0,this.deltaYCamera=0,this.moving&&(this.moving=!1,this.dispatchEvent("cameraMoveEnd",["null"]));null!==this.unzoomButton&&this.dist<6?this.unzoomButton.style.display="block":null!==this.unzoomButton&&(this.unzoomButton.style.display="none");var i=this.level,s=this.getLevel(256,this.maxlevel,0,this.dist-1);!isNaN(s)&&this.minlevel<=s?this.level=s:this.level=this.minlevel,this.level!=i&&(this.levelChanged=!0,this.changed=!0);var n=.25*(this.level>6?6:this.level+1);this.level<=6?this.near=.01/n:this.near=9e-5/(n/4e-6),this.threeCamera.near=this.near,this.updateSingleThreeCamera(this.threeCamera),this.threeCamera.updateProjectionMatrix(),this.threeCamera.projectionMatrixInverse.getInverse(this.threeCamera.projectionMatrix),this.threeCamera.updateMatrixWorld(),this.threeCamera.matrixWorldInverse.getInverse(this.threeCamera.matrixWorld),this.totalTransfo=new o.Matrix4,this.totalTransfo.multiplyMatrices(this.threeCamera.projectionMatrix,this.threeCamera.matrixWorldInverse)},getLevel:function(e,t,i,o){var s=this.minlevel;if(0===this.renderer.mixProj)for(var n=Math.min(5,Math.ceil(Math.max(this.renderer.getCanvas().width,this.renderer.getCanvas().height)/e)),r=n/(1<<s-1),a=2*Math.tan(this.threeCamera.fov/2*Math.PI/180)*o;r>a&&s<this.maxlevel;)r=n/(1<<++s-1);return s},updateSingleThreeCamera:function(e){var i=t.latlonToXYZ(this.lat,this.lon);i.multiplyScalar(this.dist),e.position=i,e.lookAt(this.lookAt)},getTilesToDisplay:function(){var e=2+Math.ceil(Math.max(this.renderer.getCanvas().width,this.renderer.getCanvas().height)/256);return{xtile0:Math.max(0,Math.floor(t.lon2tileFlt(this.lon,this.level-1))-Math.floor(e/2)),ytile0:Math.max(0,Math.floor(t.lat2tileFlt(this.lat,this.level-1))-Math.floor(e/2)),size:Math.min(e,1<<this.level-1),level:this.level-1}},getZoomCoeff:function(){return(this.maxdist-1)/(this.dist-1)},computeDist:function(e,i,o,s,n,r){var a=360*Math.pow(2,-o),l=t.latlonToXYZ(0,0-.5*a),h=t.latlonToXYZ(0,0+.5*a),c=l.distanceTo(h),d=Math.PI*n/180;return 400*c/(2*r*Math.tan(d/2))}})}),define("DS/SocialGlobe/PolygonMaker",["UWA/Class","DS/SocialGlobe/Vector2"],function(e,t){"use strict";var i=e.extend({init:function(){},removeSmallEdges:function(e,i){var o,s,n,r,a,l=0,h=0,c=[];for(c.push(e[0]),o=e[0],l=1;l<e.length;l++)s=e[h],n=e[l],r=t.dist(s,n),a=t.dist(o,n),r>i&&a>i&&(c.push(n),h=l);return c},reduceLoop:function(e,t){var i,o=[];for(i=0;i<e.length;i+=t)o.push(e[i]);return o}});return i.maxDeltaAngle=5,i.minDeltaAngle=.001,i}),define("DS/SocialGlobe/MarkerCluster",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/Marker","DS/Supercluster/supercluster.min"],function(e,t,i,o){"use strict";return e.extend({init:function(e){this.index=new o({radius:50,maxZoom:e})},load:function(e){for(var t=0;t<e.length;t++)e[t].properties.fid=t;this.index.load(e)},getClusters:function(e,t){return this.index.getClusters(e,t)}})}),define("DS/SocialGlobe/PolygonMaker3D",["DS/SocialGlobe/Globals","DS/SocialGlobe/PolygonMaker","DS/SocialGlobe/Mesh","DS/SocialGlobe/Vector2","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils"],function(e,t,i,o,s,n){"use strict";return t.extend({init:function(e){this._parent(),this.scene=e,this.vertShader=["///attribute vec3 position;","//attribute vec2 uv;","uniform int uFlip;","uniform int uNormalize;","uniform float uMixProj;","uniform float uDz2D;","uniform int uOSMMode;","uniform float uAspectRatio;","uniform vec3 offset;","const float PI = 3.14159;","varying vec3 vTextureCoord;","varying vec3 vNormal;","varying vec3 vTangent;","varying vec3 vBinormal;","void main()","{","/*            gl_Position =   projectionMatrix *","                        viewMatrix *","                        modelMatrix *","                        vec4(position,1.0);","    return;*/","   // Move vertex to proper world position (initial geometry is a cube)","   vec3 OP =  vec4(position,1.0).xyz;","   vec3 VP;","   float radius = 1.0;","   float dz = 0.0;","   if(uNormalize == 1)","   {","//     radius = 0.985;","       radius = 0.998;","       VP = normalize(OP);","       vTextureCoord = VP;","        //vTextureCoord.xy = VP.xy*offset.z + offset.xy;","       vNormal = VP;","       vTangent = normalize(cross(vec3(0,1,0), vNormal));","       vBinormal = normalize(cross(vTangent, vNormal));","   }","   else","   {","       VP = OP;","       // Sampling texture in a cube map -> UV are then xyz of normal vector...","       //  which happen to be the vertices positions for a unit sphere","       //vec3 P2 =  normalize( (uMBWMatrix * vec4(position,1.0)).xyz );","       vec3 P2 =  VP;","       // Sampling texture in a cube map -> UV are then xyz of normal vector...","       //  which happen to be the vertices positions for a unit sphere","       vTextureCoord = vec3(uv, 1.0);","        vTextureCoord.xy = offset.z * uv + offset.xy;","       vNormal = position;","       vTangent = normalize(cross(vec3(0,1,0), VP));","       vBinormal = normalize(cross(vTangent, VP));","   }","   vec3 projP = vec3(VP.x, 0.0, VP.z);","   if(length(projP) < 0.001)","   {","       projP = vec3(1.0, 0.0, 1.0);","   }","   vec3 normalizedProjP = normalize(projP);","   float sign = 0.0;","   if(normalizedProjP.z > 0.0)","       sign = -1.0;","   else","       sign = 1.0;","   float angle = sign*acos(normalizedProjP.x);","    if (normalizedProjP.x > 0.99999)","        angle = 0.0;","    if (normalizedProjP.x < -0.99999)","        angle = 0.0;","   if(uFlip != 0 && angle > 0.0)","   {","       angle -= 2.0*PI;","   }","   float x = angle / PI;","   float MixProj  = uOSMMode != 2 ? uMixProj : 0.0;","   // Final position in projected view space","   vec4 pre_gl_Position_3d;","   vec4 pos = ( viewMatrix  * modelMatrix * vec4(radius*VP, 1.0) );","   pre_gl_Position_3d = projectionMatrix * pos;","   vec4 pre_gl_Position_2d;","   float yangle = asin(VP.y);","   float minangle = 1.31;","   if(yangle < -minangle)","   {","       yangle = -minangle;","   }","   else","   {","       if(yangle > minangle)","       {","           yangle = minangle;","       }","   }","   float y2d = uAspectRatio*log(tan(PI/4.0+yangle*0.5))/ PI;","   pre_gl_Position_2d = vec4(x, y2d, uDz2D, 1.0);","   gl_Position = MixProj*pre_gl_Position_2d + (1.0 - MixProj)*pre_gl_Position_3d;","   //gl_Position = pre_gl_Position_3d;","}",""].join("\n"),this.fragShader=["precision lowp float;","uniform vec4 uColor;","void main() ","{  ","   gl_FragColor = uColor;","   return;","}",""].join("\n")}})}),define("DS/SocialGlobe/DataModel",["UWA/Class","DS/SocialGlobe/Globals","DS/SocialGlobe/MarkerBag","DS/SocialGlobe/CountryManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Visualization/GeometryHelper","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/SocialGlobe/MarkerInfoManager","DS/SocialGlobe/MarkerCluster"],function(e,t,i,o,s,n,r,a,l,h,c){"use strict";return e.extend({init:function(e){this.globe=e,this.globe.use2D?this.layersToLoop=[]:(this.markerBag=new i(this.globe.renderer),this.countryManager=new o(this.globe.renderer),this._selections=[],this._lastSelectedCountry=null,this.tagsSet=!1,this._loadedFeatures=null,this._filteredFeatures=[],this._markerCluster=null,this._clustering=!1,this.maxLevel=10)},build:function(e,i,o,n){if(this._loadedFeatures=new Map,this.globe.use2D){this.firstLaunch=!0;for(c=0;c<e.length;c++){if((d=e[c]).geometry&&("Point"==d.geometry.type||"Polygon"==d.geometry.type)){u=d.properties;function l(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}g=l();if(u.tags){f="";for(p=0;p<u.tags.length;p++){f+=JSON.stringify({tagName:u.tags[p].tagName,tagValue:u.tags[p].tagValue})}(m=this._loadedFeatures.get(f))?m.push(d):m=[d],this._loadedFeatures.set(f,m)}else this._loadedFeatures.set(g,[d])}}n&&(console.log("update loaded data 2d"),this.updateLoadedData2D(n,!1))}else{this.inverseLatLon=i;for(var c=0;c<e.length;c++){var d;if((d=e[c]).geometry)switch(d.geometry.type){case"Point":var u=d.properties;function l(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}d.properties.color&&(d.properties.colorBackup=d.properties.color);var g=l();if(u.tags){var p,m,f="";for(p=0;p<u.tags.length;p++){f+=JSON.stringify({tagName:u.tags[p].tagName,tagValue:u.tags[p].tagValue})}(m=this._loadedFeatures.get(f))?m.push(d):m=[d],this._loadedFeatures.set(f,m)}else this._loadedFeatures.set(g,[d]);break;case"LineString":var v=d.geometry.coordinates,u=d.properties;if(v){var b=this.globe.renderer.v6SceneGraph,w=u.color,y=u.altitude,M=(u.tesselate&&u.tesselate,u.altitudeScale?u.altitudeScale:1);if("clamptoground"===y||"auto"===y)for(var S=0;S<v.length-1;S++){var C=v[S],k=v[S+1],x=0;"auto"===y&&(x=2e6*M);var D=t.createCurvePath(C,k,x,i);(A=new s.LineBasicMaterial({color:w,linewidth:40})).force=!0;var T=(new a).createLine(D.createPointsGeometry(40).vertices),P=r.createMeshNode(T,A);b.add(P)}else if("relative"===y){var A=new s.LineBasicMaterial({color:w,linewidth:40});T=(new a).createLine(v),P=r.createMeshNode(T,A);b.add(P)}}break;case"Polygon":u=d.properties;var G=this.globe.getCountryManager().get(this.globe.getCountryManager().getIndexFromISO3(u.ISO3));G.setHtmlColor(u.color),u.descriptionType?G.descriptionType=u.descriptionType:u.link&&(options.descriptionType="html"),G.description=u.description,G.link=u.link,G.width=u.width,G.height=u.height,G.persist=u.persist,G.uuid=u.uuid,G&&"html"===G.descriptionType&&G.persist&&h.addMarkerInfo(G,!0)}}n?this.updateLoadedData(n,!1):this.buildFeatures(e,this.inverseLatLon)}},build2:function(e,i,o,n){var c=new Map;this._loadedFeatures=new Map;for(var d=0;d<e.length;d++){var u=e[d];if(u.geometry)switch(u.geometry.type){case"Point":var g=u.geometry.coordinates,p=u.properties;if(g){var m=0,f="#3399cc",v="",b="";g[2]&&(m=parseFloat(g[2])),p.color&&(f=p.color),p.title&&(v=p.title),p.description&&(b=p.description);var w={};if(p.popup&&""!==p.popup&&(w.popup=p.popup),p.image&&""!==p.image&&(w.image=p.image),p.html&&""!==p.html&&(w.html=p.html),p.link&&""!==p.link&&(w.link=p.link),p.descriptionType&&""!==p.descriptionType?w.descriptionType=p.descriptionType:p.link&&(w.descriptionType="html"),p.width&&""!==p.width&&(w.width=p.width),p.height&&""!==p.height&&(w.height=p.height),p.persist&&""!==p.persist&&(w.persist=p.persist),p.uuid&&""!==p.uuid&&(w.uuid=p.uuid),p.onclick&&""!==p.onclick){var y;if(w.onclick=p.onclick,"message"===(y=p.onclick.split(";"))[0]){var M={key:y[1],text:y[2]};w.onclick=this.globe.dispatchEvent.bind(this.globe,"emitMessage",[M])}if("turnTo"===y[0]){var S=y[1].split(";");w.onclick=this.globe.turnGlobeToLatLon.bind(this.globe,parseFloat(S[0]),parseFloat(S[1]),parseFloat(S[2]))}}if(p.ondoubleclick&&""!==p.ondoubleclick)if(w.ondoubleclick=p.ondoubleclick,"message"===(y=p.ondoubleclick.split(";"))[0]){M={key:y[1],text:y[2]};w.ondoubleclick=this.globe.dispatchEvent.bind(this.globe,"emitMessage",[M])}if(p.onmouseover&&""!==p.onmouseover)if(w.onmouseover=p.onmouseover,"message"===(y=p.onmouseover.split(";"))[0]){M={key:y[1],text:y[2]};w.onmouseover=this.globe.dispatchEvent.bind(this.globe,"emitMessage",[M])}var C,k=!1;if(p.is3DDriveContent&&(k=p.is3DDriveContent),w.uuid=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)),(C=null!==i&&i?this.addMarker(g[1],g[0],m,f,v,b,w,k):this.addMarker(g[0],g[1],m,f,v,b,w,k))&&"html"===C.descriptionType&&C.persist&&h.addMarkerInfo(C),p.tags){var x,D="";for(x=0;x<p.tags.length;x++){var T=JSON.stringify({tagName:p.tags[x].tagName,tagValue:p.tags[x].tagValue});D+=T;var P=c.get(T);P?P++:P=1,c.set(T,P)}var A=[g[1],g[0],m,f,v,b,w,k,p.tags];this._loadedFeatures.set(D,A)}}break;case"LineString":g=u.geometry.coordinates,p=u.properties;if(g){var G=this.globe.renderer.v6SceneGraph,E=p.color,I=p.altitude,V=(p.tesselate&&p.tesselate,p.altitudeScale?p.altitudeScale:1);if("clamptoground"===I||"auto"===I)for(var L=0;L<g.length-1;L++){var _=g[L],F=g[L+1],U=0;"auto"===I&&(U=2e6*V);var W=t.createCurvePath(_,F,U,i);(B=new s.LineBasicMaterial({color:E,linewidth:40})).force=!0;var O=(new a).createLine(W.createPointsGeometry(40).vertices),N=r.createMeshNode(O,B);G.add(N)}else if("relative"===I){var B=new s.LineBasicMaterial({color:E,linewidth:40});O=(new a).createLine(g),N=r.createMeshNode(O,B);G.add(N)}}break;case"Polygon":p=u.properties;var j=this.globe.getCountryManager().get(this.globe.getCountryManager().getIndexFromISO3(p.ISO3));j.setHtmlColor(p.color),p.descriptionType?j.descriptionType=p.descriptionType:p.link&&(w.descriptionType="html"),j.description=p.description,j.link=p.link,j.width=p.width,j.height=p.height,j.persist=p.persist,j.uuid=p.uuid,j&&"html"===j.descriptionType&&j.persist&&h.addMarkerInfo(j,!0)}}if(/*!this.tagsSet && */n){var z=[];c.forEach(function(e,t,i){var o=JSON.parse(t),s=o.tagName,n=o.tagValue,r=e,a=l.get("GlobeViewer.Tags."+s),h={sixw:a=a.contains("GlobeViewer.Tags.")?s:a,object:n,count:r,field:"implicit",dispValue:n};""!=h.dispValue&&z.push(h)}),n.setTags(void 0,z),this.tagsSet=!0}this.globe.loadingInfo.hide()},saveToGeoJSON:function(){return this.exportToFeatures()},exportToFeatures:function(){var e=[],t={type:"FeatureCollection",features:e};if(this.globe.use2D)this.globe.map.eachLayer(function(t){if(!t.external&&(t instanceof L.Marker&&(console.log(t.style_properties.color),e.push({type:"Feature",properties:{title:t.title,description:t.description,link:t.link,image:t.image,descriptionType:t.descriptionType,width:t.width,height:t.height,persist:t.persist,uuid:t.options.uuid,saved:!0},style_properties:{color:t.style_properties.color},geometry:{type:"Point",coordinates:[t._latlng.lng,t._latlng.lat]}})),t instanceof L.Polygon)){var i=t.toGeoJSON().geometry;e.push({type:"Feature",properties:{title:t.title,color:t.color,strokeColor:t.strokeColor,description:t.description,link:t.link,image:t.image,descriptionType:t.descriptionType,width:t.width,height:t.height,persist:t.persist,uuid:t.options.uuid,saved:!0},geometry:i})}});else{for(var i=this.markerBag.allMarkers,o=0;o<i.length;o++){var s=i[o];s.readOnly||e.push({type:"Feature",properties:{title:s.title,color:s.color,altitude:s.alt,description:s.description,link:s.link,image:s.image,descriptionType:s.descriptionType,width:s.width,height:s.height,persist:s.persist,uuid:s.uuid},geometry:{type:"Point",coordinates:[s.lat,s.lon]}})}var n=this.countryManager.getCountries();for(o=0;o<n.length;o++){var r=n[o];r.readOnly||e.push({type:"Feature",properties:{color:r.getHtmlColor(),ISO3:r.ISO3,description:r.description,descriptionType:r.descriptionType,link:r.link,width:r.width,height:r.height,persist:r.persist,uuid:r.uuid},geometry:{type:"Polygon"}})}}return t},getMarkerManager:function(){return this.markerBag},getCountryManager:function(){return this.countryManager},getPolylineManager:function(){},refresh:function(){this.countryManager.refresh()},addMarker2:function(e,t,i,o,s,n,r,a=!1){return this.markerBag.createMarker(e,t,i,o,s,n,r,a)},addMarker:function(e,t,i,o,s,n,r,a,l,h=!1){return this.markerBag.createMarker(e,t,i,o,s,n,r,a,l,h)},addCluster:function(e,t,i,o,s,n,r,a,l,h=!1){return this.markerBag.createCluster(e,t,i,o,s,n,r,a,l,h)},deleteSelection:function(e,t){var i=[];if(t.marker){for(var o=0;o<e.length;o++)"Marker"===e[o].type&&(e[o].overrideHtmlColor(),i.push(e[o]));i.length&&this.markerBag.removeMarkers(i)}if(t.country)for(o=0;o<e.length;o++)"Country"===e[o].type&&(e[o].setColor(),e[o].overrideHtmlColor());this.globe.markerInfo.show(!1)},getSelection:function(){return this._selections},setSelection:function(e){for(var t=0;t<this._selections.length;t++)this._selections[t].overrideHtmlColor();this._selections=e;for(t=0;t<e.length;t++)e[t].overrideHtmlColor("#006699")},getLastSelectedCountry:function(){return this._lastSelectedCountry},setLastSelectedCountry:function(e){this._lastSelectedCountry=e},clearSelection:function(){for(var e=0;e<this._selections.length;e++)this._selections[e].overrideHtmlColor();this._selections=[]},hover:function(e){e?(this.elementHovered&&e.getID()===this.elementHovered.getID()||(!this.elementHovered||this._selections.length&&this._selections[0].getID()===this.elementHovered.getID()||this.elementHovered.overrideHtmlColor(),this._selections.length&&this._selections[0].getID()===e.getID()||e.overrideHtmlColor("#3399cc")),this.elementHovered=e):this.elementHovered&&(this._selections.length&&this._selections[0].getID()===this.elementHovered.getID()||this.elementHovered.overrideHtmlColor(),this.elementHovered=void 0)},addMarkerInfosFrames:function(){for(var e=this.markerBag.allMarkers,t=0;t<e.length;t++){var i=e[t];i&&"html"===i.descriptionType&&i.persist&&h.addMarkerInfo(i)}},updateLoadedData:function(e,t,i){this._filteredFeatures=[];var o=0,s=0,n=[];if(e){if(n=e.getCurrentFilter().allfilters,this.myTags=new Map,this._loadedFeatures&&this._loadedFeatures.forEach(function(e,t,i){if(n&&Object.keys(n).length>0){var r=!0;for(var a in t=t.replace("[","").replace("]",""),n)if(n.hasOwnProperty(a)){var h=l.get("GlobeViewer.TagsReverse."+a);h=h.contains("GlobeViewer.TagsReverse.")?a:h;var c=JSON.stringify({tagName:h,tagValue:n[a][0].object});c=c.replace("[","").replace("]","").replace("}",""),r=r&&t.includes(c)}if(r){for(d=0;d<e.length;d++)this._filteredFeatures.push(e[d]),o+=e[d].geometry.coordinates[1],s+=e[d].geometry.coordinates[0];if(e.length>0&&e[0].properties.tags){for(u=0;u<e[0].properties.tags.length;u++){g=JSON.stringify({tagName:e[0].properties.tags[u].tagName,tagValue:e[0].properties.tags[u].tagValue}),(p=this.myTags.get(g))?p+=e.length:p=e.length,this.myTags.set(g,p)}}}}else{var d;for(d=0;d<e.length;d++)this._filteredFeatures.push(e[d]),o+=e[d].geometry.coordinates[1],s+=e[d].geometry.coordinates[0];if(e.length>0&&e[0].properties.tags){var u;for(u=0;u<e[0].properties.tags.length;u++){var g,p;g=JSON.stringify({tagName:e[0].properties.tags[u].tagName,tagValue:e[0].properties.tags[u].tagValue}),(p=this.myTags.get(g))?p+=e.length:p=e.length,this.myTags.set(g,p)}}}}.bind(this)),i&&(i=i.toLowerCase(),this._filteredFeatures=this._filteredFeatures.filter(function(e){var t,n=!1;if(e.properties)for(t in Object.keys(e.properties)){var r=Object.keys(e.properties)[t];n=(n=n||r.toLowerCase().contains(i))||JSON.stringify(e.properties[r]).toLowerCase().contains(i)}return n||(s-=e.geometry.coordinates[0],o-=e.geometry.coordinates[1]),n})),this._filteredFeatures.length>0&&t&&(this.inverseLatLon?this.globe.turnGlobeToLatLon(o/this._filteredFeatures.length,s/this._filteredFeatures.length,4):this.globe.turnGlobeToLatLon(s/this._filteredFeatures.length,o/this._filteredFeatures.length,4)),e){var r=[];this.myTags.forEach(function(e,t,i){var o=JSON.parse(t),s=o.tagName,n=o.tagValue,a=e,h=l.get("GlobeViewer.Tags."+s),c={sixw:h=h.contains("GlobeViewer.Tags.")?s:h,object:n,count:a,field:"implicit",dispValue:n};""!=c.dispValue&&r.push(c)}),e.setTags(void 0,r),this.tagsSet=!0}!0===this._clustering?(this._markerCluster=new c(this.maxLevel),this._markerCluster.load(this._filteredFeatures),this.buildClusters(this._filteredFeatures,this.inverseLatLon)):this.buildFeatures(this._filteredFeatures,this.inverseLatLon)}this.globe.loadingInfo.hide()},updateLoadedData2D:function(e,t,i,o){t?this.saved3DSearch=i?null:t:i&&(this.saved3DSearch=null),this._filteredFeatures=[];var s=[];if(e){if(s=e.getCurrentFilter().allfilters,this.myTags=new Map,this._loadedFeatures){if(this.firstLaunch)this._loadedFeatures.forEach(function(e,t,i){if(s&&Object.keys(s).length>0){var o=!0;for(var n in t=t.replace("[","").replace("]",""),s)if(s.hasOwnProperty(n)){var r=l.get("GlobeViewer.TagsReverse."+n);r=r.contains("GlobeViewer.TagsReverse.")?n:r;var a=JSON.stringify({tagName:r,tagValue:s[n][0].object});a=a.replace("[","").replace("]","").replace("}",""),o=o&&t.includes(a)}if(o){for(h=0;h<e.length;h++)this._filteredFeatures.push(e[h]);if(e.length>0&&e[0].properties.tags){for(c=0;c<e[0].properties.tags.length;c++){d=JSON.stringify({tagName:e[0].properties.tags[c].tagName,tagValue:e[0].properties.tags[c].tagValue}),(u=this.myTags.get(d))?u+=e.length:u=e.length,this.myTags.set(d,u)}}}}else{var h;for(h=0;h<e.length;h++)this._filteredFeatures.push(e[h]);if(e.length>0&&e[0].properties.tags){var c;for(c=0;c<e[0].properties.tags.length;c++){var d,u;d=JSON.stringify({tagName:e[0].properties.tags[c].tagName,tagValue:e[0].properties.tags[c].tagValue}),(u=this.myTags.get(d))?u+=e.length:u=e.length,this.myTags.set(d,u)}}}}.bind(this)),this.firstLaunch=!1;else{var n=0,r=0;this.layersToLoop=[],o?this.layersToLoop=this.unclusteredLayerGroup:this.globe.map.eachLayer(function(e){this.layersToLoop.push(e),e._latlng&&(n+=e._latlng.lat,r+=e._latlng.lng)}.bind(this));for(var a=this.layersToLoop.length,h=0;h<this.layersToLoop.length;h++){if((S=this.layersToLoop[h])instanceof L.Marker||S instanceof L.Polygon){var c=S.feature_properties;([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16));if(c.tags){var d="";for(w=0;w<c.tags.length;w++){d+=v=JSON.stringify({tagName:c.tags[w].tagName,tagValue:c.tags[w].tagValue})}S.feature_properties.tagKeys=d}else S.feature_properties.tagKeys="";if(s&&Object.keys(s).length>0){var u=S.feature_properties.tagKeys,g=!0;for(var p in u=u.replace("[","").replace("]",""),s)if(s.hasOwnProperty(p)){var m=l.get("GlobeViewer.TagsReverse."+p);m=m.contains("GlobeViewer.TagsReverse.")?p:m;var f=JSON.stringify({tagName:m,tagValue:s[p][0].object});f=f.replace("[","").replace("]","").replace("}",""),g=g&&u.includes(f)}if(g||(this.globe.hideLayer(S),a-=1,n-=S._latlng.lat,r-=S._latlng.lng,S instanceof L.Marker?S.tagFiltered=!1:S instanceof L.Polygon&&(S._path.tagFiltered=!1)),g&&(S instanceof L.Marker?(S.tagFiltered=!0,(!this.saved3DSearch||this.saved3DSearch&&S.searchFiltered)&&this.globe.showLayer(S)):S instanceof L.Polygon&&(S._path.tagFiltered=!0,(!this.saved3DSearch||this.saved3DSearch&&S._path.searchFiltered)&&this.globe.showLayer(S)),S&&S.feature_properties.tags)){d="";for(w=0;w<S.feature_properties.tags.length;w++){d+=v=JSON.stringify({tagName:S.feature_properties.tags[w].tagName,tagValue:S.feature_properties.tags[w].tagValue}),(b=this.myTags.get(v))?b+=1:b=1,this.myTags.set(v,b)}}}else if(S instanceof L.Marker?(S.tagFiltered=!0,S._icon&&"none"!=S._icon.style.display||!S.searchFiltered||this.globe.showLayer(S)):S instanceof L.Polygon&&(S._path.tagFiltered=!0,S._path.classList.contains("hidden-layer")&&S._path.searchFiltered&&this.globe.showLayer(S)),S&&S.feature_properties.tags){d="";for(w=0;w<S.feature_properties.tags.length;w++){var v,b;d+=v=JSON.stringify({tagName:S.feature_properties.tags[w].tagName,tagValue:S.feature_properties.tags[w].tagValue}),(b=this.myTags.get(v))?b+=1:b=1,this.myTags.set(v,b)}}}}}if(t||this.saved3DSearch){if(t)t=t.toLowerCase();else t=this.saved3DSearch.toLowerCase();for(h=0;h<this.layersToLoop.length;h++){var w,y=!1;if((S=this.layersToLoop[h]).feature_properties)for(w in Object.keys(S.feature_properties)){var M=Object.keys(S.feature_properties)[w];y=(y=y||M.toLowerCase().contains(t))||JSON.stringify(S.feature_properties[M]).toLowerCase().contains(t)}else S.title&&(y=S.title.toString().toLowerCase().contains(t)),S.description&&(y=y||S.description.toString().toLowerCase().contains(t));y?S instanceof L.Marker?(console.log(S),S._icon&&"none"!=S._icon.style.display||!S.tagFiltered||this.globe.showLayer(S),S.searchFiltered=!0):S instanceof L.Polygon&&S._path.classList.contains("hidden-layer")&&S._path.tagFiltered&&this.globe.showLayer(S):(S instanceof L.Marker?S.searchFiltered=!1:S instanceof L.Polygon&&(S._path.searchFiltered=!1),a-=1,n-=S._latlng.lat,r-=S._latlng.lng,this.globe.hideLayer(S))}}else for(h=0;h<this.layersToLoop.length;h++){var S;(S=this.layersToLoop[h])instanceof L.Polygon?(S._path.searchFiltered=!0,S._path.tagFiltered&&S._path.searchFiltered&&this.globe.showLayer(S)):S instanceof L.Marker&&(S.searchFiltered=!0,S.tagFiltered&&S.searchFiltered&&this.globe.showLayer(S))}}if(a>0){var C=4;a===this.layersToLoop.length&&(C=2),this.globe.flyToLatLon(n/a,r/a,C)}if(e){var k=[];this.myTags.forEach(function(e,t,i){var o=JSON.parse(t),s=o.tagName,n=o.tagValue,r=e,a=l.get("GlobeViewer.Tags."+s),h={sixw:a=a.contains("GlobeViewer.Tags.")?s:a,object:n,count:r,field:"implicit",dispValue:n};""!=h.dispValue&&k.push(h)}),e.setTags(void 0,k),this.tagsSet=!0}}},saveClusteredMarker:function(e){console.log(e),this.savedClusteredMarkers||(this.savedClusteredMarkers=[]),this.savedClusteredMarkers.push(e),console.log(this.savedClusteredMarkers)},colorize:function(e,t){var i,o=[];for(i=0;i<this._filteredFeatures.length;i++){var s,n=this._filteredFeatures[i];if(n.properties&&n.properties.tags)for(s=0;s<t.tagColors.length;s++){var r,a=t.tagColors[s];for(r=0;r<n.properties.tags.length;r++){var h=n.properties.tags[r];if(h.tagName&&h.tagName){var d=l.get("GlobeViewer.Tags."+h.tagName);(d=d.contains("GlobeViewer.Tags.")?h.tagName:d)===a.predicate&&h.tagValue&&(h.tagValue===a.dispValue||h.tagValue.includes(a.dispValue))&&(n.properties.color=a.color)}}}o.push(n)}!0===this._clustering?(this._markerCluster=new c(this.maxLevel),this._markerCluster.load(o),this.buildClusters(o,this.inverseLatLon)):this.buildFeatures(o,this.inverseLatLon),this.globe.loadingInfo.hide()},colorize2D:function(e,t,i){console.log("colorize 2D"),this.layersToColorize=[],i?this.layersToColorize=this.unclusteredLayerGroup:this.globe.map.eachLayer(function(e){this.layersToColorize.push(e)}.bind(this));for(var o=0;o<this.layersToColorize.length;o++){var s,n=this.layersToColorize[o];if(!i&&n instanceof L.Marker&&"none"!=n._icon.style.display||n instanceof L.Polygon&&!n._path.classList.contains("hidden-layer")||i)if(n.feature_properties&&n.feature_properties.tags)for(console.log(n),s=0;s<t.tagColors.length;s++){var r,a=t.tagColors[s];for(r=0;r<n.feature_properties.tags.length;r++){var h=n.feature_properties.tags[r];if(h.tagName&&h.tagName){var c=l.get("GlobeViewer.Tags."+h.tagName);if((c=c.contains("GlobeViewer.Tags.")?h.tagName:c)===a.predicate&&h.tagValue&&(h.tagValue===a.dispValue||h.tagValue.includes(a.dispValue)))if(n.style_properties.color=a.color,n._icon){var d=n.options.uuid;document.getElementById(d).setAttribute("fill",n.style_properties.color)}else n instanceof L.Polygon&&n.setStyle({fillColor:n.style_properties.color})}}}}},unColorize:function(e){var t;for(t=0;t<this._filteredFeatures.length;t++){var i=this._filteredFeatures[t];null!=i.properties.colorBackup?i.properties.color=i.properties.colorBackup:i.properties.color="#3399cc"}!0===this._clustering?(this._markerCluster=new c(this.maxLevel),this._markerCluster.load(this._filteredFeatures),this.buildClusters(this._filteredFeatures,this.inverseLatLon)):this.buildFeatures(this._filteredFeatures,this.inverseLatLon),this.globe.loadingInfo.hide()},unColorize2D:function(e,t){this.layersToColorize=[],t?this.layersToColorize=this.unclusteredLayerGroup:this.globe.map.eachLayer(function(e){this.layersToColorize.push(e)}.bind(this));for(var i=0;i<this.layersToColorize.length;i++){var o=this.layersToColorize[i];if((!t&&o instanceof L.Marker&&"none"!=o._icon.style.display||o instanceof L.Polygon&&!o._path.classList.contains("hidden-layer")||t)&&o.feature_properties&&o.feature_properties.tags)if(null!=o.style_properties.colorBackup&&(o.style_properties.color=o.style_properties.colorBackup),o._icon){var s=o.options.uuid;document.getElementById(s).setAttribute("fill",o.style_properties.color)}else o instanceof L.Polygon&&o.setStyle({fillColor:o.style_properties.color})}},buildClusters:function(e,t,i){for(var o=0;o<=this.maxLevel+1;o++)for(var s=this._markerCluster.getClusters([-180,-90,180,90],o),n=0;n<s.length;n++){var r=s[n];if(r.geometry)switch(r.geometry.type){case"Point":var a=r.geometry.coordinates,l=r.properties;if(a){var c=0,d="#3399cc",u="",g=0,p="";a[2]&&(c=parseFloat(a[2])),l.color&&(d=l.color),l.title&&(u=l.title),l.point_count&&(g=l.point_count),l.description&&(p=l.description);var m={};if(l.popup&&""!==l.popup&&(m.popup=l.popup),l.image&&""!==l.image&&(m.image=l.image),l.html&&""!==l.html&&(m.html=l.html),l.link&&""!==l.link&&(m.link=l.link),l.descriptionType&&""!==l.descriptionType?m.descriptionType=l.descriptionType:l.link&&(m.descriptionType="html"),l.width&&""!==l.width&&(m.width=l.width),l.height&&""!==l.height&&(m.height=l.height),l.persist&&""!==l.persist&&(m.persist=l.persist),l.uuid&&""!==l.uuid&&(m.uuid=l.uuid),l.onclick&&""!==l.onclick){var f;if(m.onclick=l.onclick,"message"===(f=l.onclick.split(";"))[0]){var v={key:f[1],text:f[2]};m.onclick=this.globe.dispatchEvent.bind(this.globe,"emitMessage",[v])}if("turnTo"===f[0]){var b=f[1].split(";");m.onclick=this.globe.turnGlobeToLatLon.bind(this.globe,parseFloat(b[0]),parseFloat(b[1]),parseFloat(b[2]))}}if(l.ondoubleclick&&""!==l.ondoubleclick)if(m.ondoubleclick=l.ondoubleclick,"message"===(f=l.ondoubleclick.split(";"))[0]){v={key:f[1],text:f[2]};m.ondoubleclick=this.globe.dispatchEvent.bind(this.globe,"emitMessage",[v])}if(l.onmouseover&&""!==l.onmouseover)if(m.onmouseover=l.onmouseover,"message"===(f=l.onmouseover.split(";"))[0]){v={key:f[1],text:f[2]};m.onmouseover=this.globe.dispatchEvent.bind(this.globe,"emitMessage",[v])}var w,y=!1;l.is3DDriveContent&&(y=l.is3DDriveContent);var M=a[0],S=a[1];null!==t&&t&&(M=a[1],S=a[0]),(w=g>0?this.addCluster(M,S,c,d,u,p,m,o,g,y):this.addMarker(M,S,c,d,u,p,m,o,0,y))&&"html"===w.descriptionType&&w.persist&&h.addMarkerInfo(w)}}}},buildFeatures:function(e,t,i){for(var o=0;o<e.length;o++){var s=e[o];if(s.geometry)switch(s.geometry.type){case"Point":var n=s.geometry.coordinates,r=s.properties;if(n){var a=0,l="#3399cc",c="",d="";n[2]&&(a=parseFloat(n[2])),r.color&&(l=r.color),r.title&&(c=r.title),r.description&&(d=r.description);var u={};if(r.popup&&""!==r.popup&&(u.popup=r.popup),r.image&&""!==r.image&&(u.image=r.image),r.html&&""!==r.html&&(u.html=r.html),r.link&&""!==r.link&&(u.link=r.link),r.descriptionType&&""!==r.descriptionType?u.descriptionType=r.descriptionType:r.link&&(u.descriptionType="html"),r.width&&""!==r.width&&(u.width=r.width),r.height&&""!==r.height&&(u.height=r.height),r.persist&&""!==r.persist&&(u.persist=r.persist),r.uuid&&""!==r.uuid&&(u.uuid=r.uuid),r.onclick&&""!==r.onclick){var g;if(u.onclick=r.onclick,"message"===(g=r.onclick.split(";"))[0]){var p={key:g[1],text:g[2]};u.onclick=this.globe.dispatchEvent.bind(this.globe,"emitMessage",[p])}if("turnTo"===g[0]){var m=g[1].split(";");u.onclick=this.globe.turnGlobeToLatLon.bind(this.globe,parseFloat(m[0]),parseFloat(m[1]),parseFloat(m[2]))}}if(r.ondoubleclick&&""!==r.ondoubleclick)if(u.ondoubleclick=r.ondoubleclick,"message"===(g=r.ondoubleclick.split(";"))[0]){p={key:g[1],text:g[2]};u.ondoubleclick=this.globe.dispatchEvent.bind(this.globe,"emitMessage",[p])}if(r.onmouseover&&""!==r.onmouseover)if(u.onmouseover=r.onmouseover,"message"===(g=r.onmouseover.split(";"))[0]){p={key:g[1],text:g[2]};u.onmouseover=this.globe.dispatchEvent.bind(this.globe,"emitMessage",[p])}var f,v=!1;r.is3DDriveContent&&(v=r.is3DDriveContent),(f=null!==t&&t?this.addMarker(n[1],n[0],a,l,c,d,u,-1,-1,v):this.addMarker(n[0],n[1],a,l,c,d,u,-1,-1,v))&&"html"===f.descriptionType&&f.persist&&h.addMarkerInfo(f)}}}},updateLoadedData2:function(e){var t=[];if(e){t=e.getCurrentFilter().allfilters;var i=0,o=0,s=0,n=new Map;if(this._loadedFeatures.forEach(function(e,r,a){if(Object.keys(t).length>0){var h=!0;for(var c in r=r.replace("[","").replace("]",""),t)if(t.hasOwnProperty(c)){var d=l.get("GlobeViewer.TagsReverse."+c);d=d.contains("GlobeViewer.TagsReverse.")?c:d;var u=JSON.stringify({tagName:d,tagValue:t[c][0].object});u=u.replace("[","").replace("]","").replace("}",""),h=h&&r.includes(u)}if(h){var g=e;if(this.addMarker(g[0],g[1],g[2],g[3],g[4],g[5],g[6],g[7]),i+=g[0],o+=g[1],s++,g[8]){for(p=0;p<g[8].length;p++){m=JSON.stringify({tagName:g[8][p].tagName,tagValue:g[8][p].tagValue}),(f=n.get(m))?f++:f=1,n.set(m,f)}}}}else{g=e;if(this.addMarker(g[0],g[1],g[2],g[3],g[4],g[5],g[6],g[7]),i+=g[0],o+=g[1],s++,g[8]){var p;for(p=0;p<g[8].length;p++){var m,f;m=JSON.stringify({tagName:g[8][p].tagName,tagValue:g[8][p].tagValue}),(f=n.get(m))?f++:f=1,n.set(m,f)}}}}.bind(this)),s>0&&this.globe.turnGlobeToLatLon(i/s,o/s,4),e){var r=[];n.forEach(function(e,t,i){var o=JSON.parse(t),s=o.tagName,n=o.tagValue,a=e,h=l.get("GlobeViewer.Tags."+s),c={sixw:h=h.contains("GlobeViewer.Tags.")?s:h,object:n,count:a,field:"implicit",dispValue:n};""!=c.dispValue&&r.push(c)}),e.setTags(void 0,r),this.tagsSet=!0}}this.globe.loadingInfo.hide()}})}),define("DS/SocialGlobe/CmdEditArea",["UWA/Core","DS/ApplicationFrame/Command","DS/SocialGlobe/UICountryEditor","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Globals","DS/Core/Events","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/SocialGlobe/GlobeNotifications"],function(e,t,i,o,s,n,r,a){"use strict";var l=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0}),this.countryHoveredID=null,this.countrySelectedID=null,this.runByCreatedAreaCmd=!1,this.widget=this.getFrameWindow().globe;var t=this;WUX.Events.subscribe({event:"/SG/UICE/CMD//ColorArea/EDIT"},function(e){if(t.widget.getGlobe().use2D)e.fromCreateArea?(t.runByCreatedAreaCmd=!0,t.createUI(e.polygon),t.begin()):(t.runByCreatedAreaCmd=!1,t.createUI(e.polygon));else{if(!e||!e.country)return;t.widget.getGlobe().setSelection([e.country]),e.fromCreateArea&&(t.runByCreatedAreaCmd=!0,t.createUI(e.country),t.begin())}})},selectArea:function(e){this.widget.getGlobe().setSelection([e])},createUI:function(e){this.widget.topBars.CountryEditor=new i(this.widget.getGlobe(),{ID:"EditArea"},this.end.bind(this),this.selectArea.bind(this),e,this.runByCreatedAreaCmd),this._topBar=this.widget.topBars.CountryEditor},beginExecute:function(){if(this.widget.getGlobe().use2D){var e=this.widget.getGlobe().getPolygonsNb();if(this.widget.getGlobe().polygonDetailsOnClick(!0),this.widget.getGlobe().polygonPopupOnClick(!1),this.widget.getGlobe().markerDetailsOnClick(!1),this.widget.getGlobe().markerPopupOnClick(!1),!e)(t=new Error(r.get("GlobeViewer.Areas.Info.Edit.NoDataError"))).title=r.get("GlobeViewer.Areas.Info.Edit.CreateDataError"),t.subtitle=r.get("GlobeViewer.Areas.Info.Edit.NoSelectedError"),a.display({level:"info",title:t.title,subtitle:t.subtitle,message:t.message}),this.end(),this.done()}else{var t,i=this.widget.getGlobe().countryManager.getCountries();if(this.runByCreatedAreaCmd||i.length)this.widget.getGlobe().countryManager.getCountries().map(function(e){e.isEdited||(e.isEdited=!0)});else(t=new Error(r.get("GlobeViewer.Areas.Info.Edit.NoDataError"))).title=r.get("GlobeViewer.Areas.Info.Edit.CreateDataError"),t.subtitle=r.get("GlobeViewer.Areas.Info.Edit.NoSelectedError"),a.display({level:"info",title:t.title,subtitle:t.subtitle,message:t.message}),this.end(),this.done();this.runByCreatedAreaCmd&&(this.runByCreatedAreaCmd=!1)}},execute:function(){this.widget.helpDisplayed&&this.widget.displayHelp(!1);var e=this.widget.getGlobe();e.use2D&&!this.runByCreatedAreaCmd?(e.map.polygonDetailsOnClick=!0,e.map.polygonPopupOnClick=!1,console.log("set details to true and popup to false")):e.clearMouseOver();var t=this;if(this.widget.setTopBar("CountryEditor"),!e.use2D){var i={onMouseMove:function(t,i,o){t.length&&t[0].isEdited?e.getDataModel().hover(t[0]):e.getDataModel().hover()},onMouseOut:function(){},onMouseClick:function(e,i,o){if(e.length&&e[0].isEdited){var s=e[0];t.createUI(s),""===s.getHtmlColor()&&(t._topBar.getColor()?s.setHtmlColor("#"+t._topBar.getColor()):s.setHtmlColor("#ff0000")),t._topBar.setCountry(s),t._turnGlobeToXY(i,o),t.widget.setTopBar("CountryEditor")}else t.widget.getGlobe().clearSelection()},onClearCountries:function(){}};this.widget.setMouseOverCountryManager(i),this.widget.setMouseOverMarkersManager(),i.uwaglobe=this.widget;var o=e.getSelection();t._topBar&&o.length&&"CountryEditor"===o[0].type&&t._topBar.setCountry(o[0]),e.markerInfo.show(!1,void 0,null)}},endExecute:function(){console.log("end execute");var e=this.widget.getGlobe();e.use2D?(e.polygonDetailsOnClick(!1),e.polygonPopupOnClick(!0),e.markerPopupOnClick(!0)):(this.widget.getGlobe().clearMouseOver(),this.widget.getGlobe().clearSelection()),this.widget.setTopBar(),e.use2D||this._topBar&&(this._topBar.changeDescription&&this._topBar.changeDescription(),this._topBar.setCountry())},_turnGlobeToXY:function(e,t){var i=this.getFrameWindow().getViewerFrame(),n=new o.Projector,r=new o.Vector3(e/i.clientWidth*2-1,-t/i.clientHeight*2+1,0),a=n.pickingRay(r,this.widget.getGlobe().camera.threeCamera).ray,l=a.origin,h=a.direction,c=new o.Vector3(0,0,0).sub(l),d=c.dot(h);c.copy(h).multiplyScalar(d).add(l);var u=c.lengthSq();if(!(u>1)){var g=d-Math.sqrt(1-u),p=h.clone().multiplyScalar(g).add(l),m=s.XYZToLatlon(p);this.widget.turnGlobeToLatLon(m.lat,m.lon)}}});return e.namespace("SocialGlobe/CmdEditArea",l)}),define("DS/SocialGlobe/CmdCreateArea",["UWA/Core","DS/ApplicationFrame/Command","DS/SocialGlobe/UIMarkerCountryCreator","DS/SocialGlobe/UICountrySelector","DS/Visualization/ThreeJS_DS","DS/SocialGlobe/Globals","DS/Core/Events","DS/SocialGlobe/GlobeNotifications","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/SocialGlobe/CmdEditArea"],function(e,t,i,o,s,n,r,a,l,h){"use strict";var c=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0}),this.countryHoveredID=null,this.countrySelectedID=null,this.countrySelectNotification=null,this.widget=this.getFrameWindow().globe;var t=this;WUX.Events.subscribe({event:"/SG/UICE/CMD//ColorArea/CREATE"},function(e){t.widget.getGlobe().setSelection([e])})},showSelectorUI:function(){this.widget.topBars.CountrySelector=new o(this.widget.getGlobe().countryManager,{ID:"ColorArea"},this.end.bind(this),this.editArea.bind(this),this.selectArea.bind(this)),this.widget.setTopBar("CountrySelector")},editArea:function(e){this.widget.getGlobe().setSelection([e]),this.end(),this.done(),WUX.Events.publish({event:"/SG/UICE/CMD//ColorArea/EDIT",data:{fromCreateArea:!0,country:e}})},beginExecute:function(){this.widget.topBars.Country=new i(this.widget.getGlobe().countryManager,{ID:"ColorArea",cmdEndExecute:this.end.bind(this),cmdEndSelect:this.editArea.bind(this),showSelectorUI:this.showSelectorUI.bind(this)}),this._topBar=this.widget.topBars.Country},execute:function(){this.widget.helpDisplayed&&this.widget.displayHelp(!1);var e=this.widget.getGlobe();e.clearMouseOver();var t=this;this.widget.setTopBar("Country");var i={onMouseMove:function(t,i,o){t.length?e.getDataModel().hover(t[0]):e.getDataModel().hover()},onMouseOut:function(){},onMouseClick:function(e,i,o){if(e.length){var s=e[0];t._topBar.setCountry(s),t._turnGlobeToXY(i,o)}else t.widget.getGlobe().clearSelection(),t._topBar.setCountry()},onClearCountries:function(){}};this.widget.setMouseOverCountryManager(i),this.widget.setMouseOverMarkersManager(),i.uwaglobe=this.widget;var o=e.getSelection();o.length&&"Country"===o[0].type&&t._topBar.setCountry(o[0]),e.markerInfo.show(!1,void 0,null)},endExecute:function(){this.widget.getGlobe().clearMouseOver(),this.widget.setTopBar(),this.widget.getGlobe().clearSelection(),this._topBar.setCountry()},selectArea:function(e){this.widget.getGlobe().setSelection([e])},_turnGlobeToXY:function(e,t){var i=this.getFrameWindow().getViewerFrame(),o=new s.Projector,r=new s.Vector3(e/i.clientWidth*2-1,-t/i.clientHeight*2+1,0),a=o.pickingRay(r,this.widget.getGlobe().camera.threeCamera).ray,l=a.origin,h=a.direction,c=new s.Vector3(0,0,0).sub(l),d=c.dot(h);c.copy(h).multiplyScalar(d).add(l);var u=c.lengthSq();if(!(u>1)){var g=d-Math.sqrt(1-u),p=h.clone().multiplyScalar(g).add(l),m=n.XYZToLatlon(p);this.widget.turnGlobeToLatLon(m.lat,m.lon)}}});return e.namespace("SocialGlobe/CmdCreateArea",c)}),define("DS/SocialGlobe/PolylineMaker3D",["DS/SocialGlobe/Globals","DS/SocialGlobe/Mesh","DS/SocialGlobe/PolylineMaker","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils"],function(e,t,i,o,s){"use strict";return i.extend({init:function(e){this._parent(e),this.vertShader=["///attribute vec3 position;","//attribute vec2 uv;","uniform int uFlip;","uniform int uNormalize;","uniform float uMixProj;","uniform float uDz2D;","uniform int uOSMMode;","uniform float uAspectRatio;","uniform vec3 offset;","const float PI = 3.14159;","varying vec3 vTextureCoord;","varying vec3 vNormal;","varying vec3 vTangent;","varying vec3 vBinormal;","void main()","{","/*            gl_Position =   projectionMatrix *","                        viewMatrix *","                        modelMatrix *","                        vec4(position,1.0);","    return;*/","   // Move vertex to proper world position (initial geometry is a cube)","   vec3 OP =  vec4(position,1.0).xyz;","   vec3 VP;","   float radius = 1.0;","   float dz = 0.0;","   if(uNormalize == 1)","   {","//     radius = 0.985;","       radius = 0.998;","       VP = normalize(OP);","       vTextureCoord = VP;","        //vTextureCoord.xy = VP.xy*offset.z + offset.xy;","       vNormal = VP;","       vTangent = normalize(cross(vec3(0,1,0), vNormal));","       vBinormal = normalize(cross(vTangent, vNormal));","   }","   else","   {","       VP = OP;","       // Sampling texture in a cube map -> UV are then xyz of normal vector...","       //  which happen to be the vertices positions for a unit sphere","       //vec3 P2 =  normalize( (uMBWMatrix * vec4(position,1.0)).xyz );","       vec3 P2 =  VP;","       // Sampling texture in a cube map -> UV are then xyz of normal vector...","       //  which happen to be the vertices positions for a unit sphere","       vTextureCoord = vec3(uv, 1.0);","        vTextureCoord.xy = offset.z * uv + offset.xy;","       vNormal = position;","       vTangent = normalize(cross(vec3(0,1,0), VP));","       vBinormal = normalize(cross(vTangent, VP));","   }","   vec3 projP = vec3(VP.x, 0.0, VP.z);","   if(length(projP) < 0.001)","   {","       projP = vec3(1.0, 0.0, 1.0);","   }","   vec3 normalizedProjP = normalize(projP);","   float sign = 0.0;","   if(normalizedProjP.z > 0.0)","       sign = -1.0;","   else","       sign = 1.0;","   float angle = sign*acos(normalizedProjP.x);","    if (normalizedProjP.x > 0.99999)","        angle = 0.0;","    if (normalizedProjP.x < -0.99999)","        angle = 0.0;","   if(uFlip != 0 && angle > 0.0)","   {","       angle -= 2.0*PI;","   }","   float x = angle / PI;","   float MixProj  = uOSMMode != 2 ? uMixProj : 0.0;","   // Final position in projected view space","   vec4 pre_gl_Position_3d;","   vec4 pos = ( viewMatrix  * modelMatrix * vec4(radius*VP, 1.0) );","   pre_gl_Position_3d = projectionMatrix * pos;","   vec4 pre_gl_Position_2d;","   float yangle = asin(VP.y);","   float minangle = 1.31;","   if(yangle < -minangle)","   {","       yangle = -minangle;","   }","   else","   {","       if(yangle > minangle)","       {","           yangle = minangle;","       }","   }","   float y2d = uAspectRatio*log(tan(PI/4.0+yangle*0.5))/ PI;","   pre_gl_Position_2d = vec4(x, y2d, uDz2D, 1.0);","   gl_Position = MixProj*pre_gl_Position_2d + (1.0 - MixProj)*pre_gl_Position_3d;","   //gl_Position = pre_gl_Position_3d;","}",""].join("\n"),this.fragShader=["precision lowp float;","uniform vec4 uColor;","void main() ","{  ","   gl_FragColor = uColor;","   return;","}",""].join("\n"),this.material=this.createPolylineMaterial()}})}),define("DS/SocialGlobe/RenderContext",["UWA/Class","DS/SocialGlobe/TileBag3D","DS/SocialGlobe/PolygonMaker3D","DS/SocialGlobe/PolylineMaker3D","DS/SocialGlobe/MarkerMaker3D","DS/SocialGlobe/Renderer3D","DS/SocialGlobe/Camera3D","DS/SocialGlobe/GlobeLoader3D"],function(e,t,i,o,s,n,r,a){"use strict";return e.extend({init:function(e){this.type=e},buildTileBag:function(e){var i=new t(e);return i.renderContext=this,i},buildMarkerMaker:function(e){var t=new s(e);return t&&(t.renderContext=this),t},buildPolylineMaker:function(e){var t=new o(e);return t&&(t.renderContext=this),t},buildPolygonMaker:function(e){var t=new i(e);return t&&(t.renderContext=this),t},buildGlobeLoader:function(e,t){var i=new a(e,t);return i&&(i.renderContext=this),i},buildRenderer3D:function(e,t,i){return new n(this,e,t,i)},buildCamera:function(e,t){var i=new r(e,t);return i.renderContext=this,i}})}),define("DS/SocialGlobe/Globe",["UWA/Class","UWA/Class/Events","UWA/Utils/Client","UWA/Controls/Web","DS/WAFData/WAFData","DS/Visualization/ThreeJS_DS","DS/Visualization/Detector","DS/SocialGlobe/RenderContext","DS/SocialGlobe/DataModel","DS/SocialGlobe/MarkerInfo","DS/SocialGlobe/GlobeLoader3D","DS/SocialGlobe/Vector2","DS/SocialGlobe/Halo3D","DS/SocialGlobe/PoleCreator3D","DS/SocialGlobe/GeoJSONItem","DS/SocialGlobe/Globals","DS/Core/Events","DS/SocialGlobe/PlanarQuadTree","DS/SocialGlobe/VisuQuadTree","DS/SocialGlobe/VisuStore","DS/SocialGlobe/Utils","DS/Visualization/Mesh3D","DS/WebappsUtils/WebappsUtils","DS/SocialGlobe/MarkerInfoManager","DS/Controls/Button","marked/marked","SocialGlobe/assets/leaflet/leaflet","css!SocialGlobe/assets/leaflet/leaflet.css","SocialGlobe/assets/leaflet/leaflet-markercluster","css!SocialGlobe/MarkerCluster.css"],function(e,t,o,s,n,r,a,l,h,c,d,u,g,p,m,f,v,b,w,y,M,S,C,k,x,D){"use strict";return e.extend(t,{init:function(e,t,i,o,s){if(window.globe=this,this.version="2018.02.06",this.div=e,this.use2D=o,this.use2D)this.dataModel=new h(this);else{this.renderContext=new l("3D"),this.renderer=this.renderContext.buildRenderer3D(e,t,i),this.camera=this.renderContext.buildCamera(this.renderer,s),this.renderer.setCamera(this.camera),this.started=!1,this.globeLoader=this.renderContext.buildGlobeLoader(this.renderer,this),this.tileBag=this.renderContext.buildTileBag(this.renderer),f.credentials={default:!0},this.visuStore=new y(f.tilespath),this.params={type:"texture",levelMax:this.camera.maxlevel,levelMinCache:2,cache:50,url:f.tilespath+"%l/%x/%y"+f.tileExtension,credentials:f.credentials},this.loader=M.loadTexture,this.builder=function(e,t){t.generateMipmaps=!0,t.magFilter=r.LinearFilter,t.minFilter=r.LinearFilter,t.anisotropy=4,t.wrapS=r.ClampToEdgeWrapping,t.wrapT=r.ClampToEdgeWrapping,e(t,!0)},this.visuStore.makeStoreByJSON("ortho",this.params,this.loader,this.builder,!0,!1),this.planarQT=new b(0,!0,void 0,!0),this.visuQT=new w(this.planarQT,128,this),this.visuStore.vqt=this.visuQT,this.eventTokenList=[];var n=this.camera.threeCamera.position.clone().negate();this.planarQT.build(n,this.camera.level,f.lon2tileFlt(this.camera.lon,0),f.lat2tileFlt(this.camera.lat,0)),this.visuQT.update(!0),this.skin="satellite",this.countrySelectionActivated=!0,this.haloMaker=new g(this.renderer),this.poleMaker=new p(this.renderer,this.tileBag,this.skin),this.polygonMaker=this.renderContext.buildPolygonMaker(this.renderer),this.stop=!1,this.oldTiles=[],this.toLoadTiles=[],this.loadedTiles=[],this.visibleTiles=[],this.permanentTiles=[],this.camera.levelChanged=!1,this.markerMeshes=[],this.invalidateTiles=!0,this.clusterLevel=0,this.clusterMeshes=[],this.dataModel=new h(this),this.markerBag=this.dataModel.getMarkerManager(),this.countryManager=this.dataModel.getCountryManager(),this.countryManager.setRenderer(this.globeLoader),this.overlayDisplayed=!1,this.inertia=10,this.countryJsonObject=null,this.setHalo("#66ccff",.5),this.setBackgroundColor("#00163C",1),this.editMode=!1,this.markerInfo=new c(this.div),this.deleteMode={marker:!1,country:!1},this.setDefaultMarkerMouseOver()}},getDataModel:function(){return this.dataModel},getCountryManager:function(){return this.countryManager},getCountryIndexFromISO3:function(e){return this.countryManager.getIndexFromISO3(e)},loadGeoJSON:function(e,t,i,o,s){if(e)if(this.use2D){var n;a=o||null;(r=new m).build(e),this.dataModel.build(r.getFeatures(),t,i,a),n=!!s;L.geoJSON(e,{onEachFeature:function(e,t){var i=t.feature.properties;if(t instanceof L.Marker)if(i.saved)o=this.addMarkerSaved(t,!0);else var o=this.addMarker2D(t._latlng);else if(t instanceof L.Polygon)if(i.saved)o=this.addPolygonSaved(t,!0);else var o=this.addPolygon(t,n);if(o.feature_properties=i,o instanceof L.Marker){o.feature_properties.color?o.style_properties.color=o.feature_properties.color:o.style_properties.color||(o.style_properties.color="#143E5A");var r=o.options.uuid;document.getElementById(r).setAttribute("fill",o.style_properties.color)}else o instanceof L.Polygon&&(o.feature_properties.color?o.style_properties.color=o.feature_properties.color:o.style_properties.color="#448FAB");if(o.external=n,!i.saved&&s&&s.chosenTitle&&s.chosenDescription){var a=i[s.chosenTitle],l=i[s.chosenDescription];o.title=a||"Unnamed",o.description=l||""}else o.title=i.title?i.title:"",o.description=i.description?i.description:"";s&&(s.from3DDrive?o.fromURL=!1:o.fromURL=!0),o.descriptionType=o.descriptionType?o.descriptionType:"text",this.setBehavior(o),this.clustering&&(this.unclusteredLayerGroup||(this.unclusteredLayerGroup=L.layerGroup()),this.unclusteredLayerGroup.addLayer(o),this.map.removeLayer(o))}.bind(this)});this.clustering&&(this.allMarkersCluster&&this.map.removeLayer(this.allMarkersCluster),this.allMarkersCluster=L.markerClusterGroup({maxClusterRadius:80,showCoverageOnHover:!1,removeOutsideVisibleBounds:!1,iconCreateFunction:function(e){return L.divIcon({html:e.getChildCount(),className:"customCluster",iconSize:L.point(40,40)})}}),this.allMarkersCluster.addLayers(this.unclusteredLayerGroup),this.map.addLayer(this.allMarkersCluster))}else{var r,a=o||null;(r=new m).build(e),this._loadedFeatures=r.getFeatures(),this.dataModel.build(r.getFeatures(),t,i,a)}},getCountry:function(e){return this.countryManager.get(e)},clearGeoJSONData:function(){this.map.eachLayer(function(e){e.toGeoJSON&&this.map.removeLayer(e)}.bind(this)),this.allMarkersCluster=null,this.dataModel.layersToLoop=[]},clearGeoJSONFromURL:function(){this.map.eachLayer(function(e){this.clustering?this.clustering&&(this.allMarkersCluster&&this.allMarkersCluster.eachLayer(function(e){e.toGeoJSON&&e.fromURL&&this.allMarkersCluster.removeLayer(e)}.bind(this)),this.unclusteredLayerGroup&&this.unclusteredLayerGroup.eachLayer(function(e){e.toGeoJSON&&e.fromURL&&this.unclusteredLayerGroup.removeLayer(e)}.bind(this))):e.toGeoJSON&&e.fromURL&&this.map.removeLayer(e)}.bind(this)),this.dataModel.layersToLoop=[]},hideExternalMarkers2D:function(){this.map.eachLayer(function(e){e.external&&e instanceof L.Marker&&(e._icon.style.display="none")})},showExternalMarkers2D:function(){this.map.eachLayer(function(e){e.external&&e instanceof L.Marker&&(e._icon.style.display="block")})},hideLayer:function(e){console.log(e),this.clustering?e instanceof L.Marker?this.allMarkersCluster.removeLayer(e):e instanceof L.Polygon&&e._path.classList.add("hidden-layer"):e instanceof L.Marker?e._icon.style.display="none":e instanceof L.Polygon&&e._path.classList.add("hidden-layer")},showLayer:function(e){this.clustering?e instanceof L.Marker?(console.log(e),this.allMarkersCluster.addLayer(e)):e instanceof L.Polygon&&e._path.classList.add("hidden-layer"):e instanceof L.Marker?e._icon.style.display="block":e instanceof L.Polygon&&e._path.classList.remove("hidden-layer")},clearCountries:function(){var e=this.getSelection();e.length>0&&(e[0].lat||(this.clearSelection(),this.markerInfo.show(!1,void 0,null)));return this.countryManager.clear(),this},clearMarkers:function(e){var t=this.getSelection();t.length>0&&(t[0].lat&&(this.clearSelection(),this.markerInfo.show(!1,void 0,null)));this.markerBag.clearMarkers(),this.mouseOverMarkersManager&&this.mouseOverMarkersManager.onClearMarkers&&this.mouseOverMarkersManager.onClearMarkers(),this._taggerProxy&&e&&this._taggerProxy.unsetTags()},setCursor:function(e,t){this.renderer.camera.control._setCursor(e,t)},getSelection:function(){return this.getDataModel().getSelection()},setSelection:function(e){for(var t=0;t<e.length;t++)if(e[t].ID&&99===e[t].ID){var i=this.countryManager.get(219);e.push(i)}if(e.length>0&&e[0].ID&&219===e[0].ID){var o=this.countryManager.get(99);e.unshift(o);var s=[0,0];this.lastCoords&&(s=this.lastCoords),this.markerInfo.show(!0,o,s)}this.deleteMode.marker||this.deleteMode.country?this.getDataModel().deleteSelection(e,this.deleteMode):this.getDataModel().setSelection(e)},clearSelection:function(){this.getDataModel().clearSelection()},clearMouseOver:function(){this.mouseOverCountryManager=void 0,this.mouseOverMarkersManager=void 0,this.setDefaultMarkerMouseOver()},setCountryColor:function(e,t){console.log("Globe:setCountryColor",e,t),this.getCountryManager().get(e).setHtmlColor(t)},showFrontiers:function(e){},setCountrySelection:function(e){this.countrySelectionActivated=e,this.setDefaultMarkerMouseOver(),e||(this.clearSelection(),this.markerInfo.show(!1,void 0,null))},getCanvas:function(){return this.renderer.getCanvas()},areTilesRangeEqual:function(e,t){return e.level===t.level&&e.xtile0===t.xtile0&&e.ytile0===t.ytile0&&e.size===t.size},allowZoom:function(e){this.camera.allowZoom(e)},enableZoom:function(e){this.use2D?e?this.map.scrollWheelZoom.enable():this.map.scrollWheelZoom.disable():this.camera.allowZoom(e)},setZoomDistance:function(e,t){this.use2D?(t||this.map.setZoom(e),this.updateUnzoomButton(e)):this.turnGlobeToLatLon(this.camera.lat,this.camera.lon,e)},updateUnzoomButton:function(e){null!==this.unzoomButton&&(this.unzoomButton.style.display=e>2.5?"block":"none")},setFragShader:function(e){f.downloadWithCors(e,this.setTileBagShader.bind(this)),f.downloadWithCors(e,this.setPoleMakerShader.bind(this))},setTileBagShader:function(e){this.tileBag.fragShader=e},setPoleMakerShader:function(e){this.poleMaker.fragShader=e},updateShader:function(e){this.setFragShader(e),this.poleN.threeMaterial.fragmentShader=this.tileBag.fragShader,this.poleN.threeMaterial.needsUpdate=!0,this.poleS.threeMaterial.fragmentShader=this.tileBag.fragShader,this.poleS.threeMaterial.needsUpdate=!0;for(var t=0;t<this.loadedTiles.length;t++)this.loadedTiles[t].threeMaterial.fragmentShader=this.tileBag.fragShader,this.loadedTiles[t].threeMaterial.needsUpdate=!0},setEditMode:function(e){this.editMode=e},addMarker:function(e,t,i,o,s,n,r){return this.markerBag.createMarker(e,t,i,o,s,n,r)},addMarkerSaved:function(e){console.log("add saved marker"),console.log(e);var t=e.feature.properties,i=e.feature.style_properties,o=L.divIcon({html:'\n        <svg width="19.3" height="29.3" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1">\n        <g>\n          <path fill="#D8D8D8" d="m9.61934,0.58429c-3.33513,0 -6.46574,1.89953 -8.02178,4.84767c-0.80586,1.52762 -1.15571,3.27655 -1.00801,4.99773c0.18707,2.16894 1.17771,3.79277 2.44755,5.48663c2.79341,3.72497 4.51054,8.14451 6.16326,12.47658c0.237,0.62102 0.62163,0.62047 0.85856,-0.00055c1.61862,-4.23707 3.30036,-8.53327 5.97273,-12.22171c1.13433,-1.56591 2.16718,-2.98116 2.51359,-4.94212c0.32326,-1.83174 0.07191,-3.74872 -0.72177,-5.43161c-1.48237,-3.14448 -4.72542,-5.21262 -8.20412,-5.21262l0,0l0,-0.00001l-0.00001,0.00001zm0,11.76232c-1.5653,0 -2.87223,-1.30753 -2.87223,-2.87283c0,-1.56585 1.30692,-2.87278 2.87223,-2.87278c1.56591,0 2.87344,1.30692 2.87344,2.87278c-0.00006,1.5653 -1.30759,2.87283 -2.87344,2.87283z" id="svg_3" stroke="#9e9e9b"/>\n          <ellipse id="'+t.uuid+'" stroke="#9e9e9b" stroke-width="0.4" fill="'+i.color+'" cx="9.58535" cy="9.39305" id="svg_19" rx="4.34928" ry="4.34928"/>\n        </g>\n\n        </svg>',className:"",iconSize:[19.3,29.3],iconAnchor:[9.65,29.3]}),s=new L.marker(e._latlng,{icon:o,pmIgnore:!0});return s.title=t.title,s.description=t.description,s.descriptionType=t.descriptionType,s.style_properties=i,s.width=t.width,s.height=t.height,s.link=t.link,s.image=t.image,s.options.uuid=t.uuid,console.log(s),s.addTo(this.map),s},addMarkerFromAPI:function(e,t,i,o,s){var n=new L.LatLng(e,t),r=this.addMarker2D(n);if(r.title=i,r.description=o,r.descriptionType="text",this.setBehavior(r),s){r.color=s;var a=r.options.uuid;document.getElementById(a).setAttribute("fill",s)}return r},selectMarkerFromAPI:function(e){this._selectFromAPI=!0;var t=void 0;this.map.eachLayer(function(i){i.title==e&&(t=i)}),t.fireEvent("click")},unselectAll:function(){this.map.closePopup()},removeMarkerFromAPI:function(e){this.map.eachLayer(function(t){t.title==e&&this.map.removeLayer(t)}.bind(this))},addMarker2D:function(e){var t=this.uuidv4(),i=L.divIcon({html:'\n        <svg width="19.3" height="29.3" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1">\n        <g>\n          <path fill="#D8D8D8" d="m9.61934,0.58429c-3.33513,0 -6.46574,1.89953 -8.02178,4.84767c-0.80586,1.52762 -1.15571,3.27655 -1.00801,4.99773c0.18707,2.16894 1.17771,3.79277 2.44755,5.48663c2.79341,3.72497 4.51054,8.14451 6.16326,12.47658c0.237,0.62102 0.62163,0.62047 0.85856,-0.00055c1.61862,-4.23707 3.30036,-8.53327 5.97273,-12.22171c1.13433,-1.56591 2.16718,-2.98116 2.51359,-4.94212c0.32326,-1.83174 0.07191,-3.74872 -0.72177,-5.43161c-1.48237,-3.14448 -4.72542,-5.21262 -8.20412,-5.21262l0,0l0,-0.00001l-0.00001,0.00001zm0,11.76232c-1.5653,0 -2.87223,-1.30753 -2.87223,-2.87283c0,-1.56585 1.30692,-2.87278 2.87223,-2.87278c1.56591,0 2.87344,1.30692 2.87344,2.87278c-0.00006,1.5653 -1.30759,2.87283 -2.87344,2.87283z" id="svg_3" stroke="#9e9e9b"/>\n          <ellipse id="'+t+'" stroke="#9e9e9b" stroke-width="0.4" fill="#143E5A" cx="9.58535" cy="9.39305" id="svg_19" rx="4.34928" ry="4.34928"/>\n        </g>\n\n        </svg>',className:"",iconSize:[19.3,29.3],iconAnchor:[9.65,29.3]}),o=new L.marker(e,{icon:i,uuid:t,pmIgnore:!0});return o.feature_properties={},o.style_properties={},o.addTo(this.map),o},addPolygon:function(e,t){var i=new L.polygon(e._latlngs,{fillColor:"#448FAB",fillOpacity:.7,color:"#006698",pmIgnore:!0}).addTo(this.map);return i.style_properties={},t||this.setBehavior(i),i},addPolygonSaved:function(e){var t=e.feature.properties,i=new L.polygon(e._latlngs,{fillColor:t.color,color:t.strokeColor,fillOpacity:.7,pmIgnore:!0});return i.title=t.title,i.description=t.description,i.descriptionType=t.descriptionType,i.color=t.color,i.strokeColor=t.strokeColor,i.width=t.width,i.height=t.height,i.link=t.link,i.image=t.image,i.uuid=t.uuid,i.addTo(this.map),i},setBehavior:function(e){var t,i={offset:L.point(0,-1)},o=e.width?e.width+"px":"100%",s=e.height?e.height+"px":"100%";"text"===e.descriptionType&&(t="<b>"+e.title+"</b><br>"+e.description),"marked"===e.descriptionType?t="<div style='overflow:auto'><b>"+e.title+"</b><br>"+D(e.description)+"</div>":"html"===e.descriptionType&&(t="<iframe id='iframe' style='width:"+o+"; height:"+s+"' src="+e.link+"></iframe>",i.maxWidth=o),e.bindPopup(t,i),e.on("click",function(t){if(this._selectFromAPI)this._selectFromAPI=!1;else{if(this._onSelectCallback&&t.sourceTarget&&t.sourceTarget.title){var i=[t.sourceTarget.title];this._onSelectCallback(i)}if(!this.map.markerPopupOnClick||!this.map.polygonPopupOnClick){if(e.getPopup(),e.closePopup(),e instanceof L.Marker&&this.map.markerDetailsOnClick){this.openMarkerDetails(e);var o=e.options.uuid;document.getElementById(o).setAttribute("fill",e.style_properties.color)}e instanceof L.Polygon&&this.map.polygonDetailsOnClick&&this.openPolygonDetails(e),e instanceof L.Polygon&&this.map.markerAdditionOnClick&&(this.map.fireEvent("click",{latlng:t.latlng}),this.polygonPopupOnClick(!1),this.markerPopupOnClick(!1))}}}.bind(this)),e.on("mouseover",function(){if(e instanceof L.Marker&&!this.openedEditMarker){var t=e.options.uuid;document.getElementById(t).setAttribute("fill","#368ec4")}}.bind(this)),e.on("mouseout",function(){if(e instanceof L.Marker&&!this.openedEditMarker){var t=e.options.uuid;document.getElementById(t).setAttribute("fill",e.color)}}.bind(this))},editPopup:function(e){var t,i=e.getPopup(),o=e.width?e.width+"px":"100%",s=e.height?e.height+"px":"100%";"text"===e.descriptionType&&(t="<b>"+e.title+"</b><br>"+e.description),"marked"===e.descriptionType?t="<div style='overflow:auto'><b>"+e.title+"</b><br>"+D(e.description)+"</div>":"html"===e.descriptionType&&(t="<iframe id='iframe' style='width:"+o+"; height:"+s+"' src="+e.link+"></iframe>",i.options.maxWidth=o),i.setContent(t)},markerPopupOnClick:function(e){this.map.markerPopupOnClick=e},markerDetailsOnClick:function(e){this.map.markerDetailsOnClick=e},markerAdditionOnClick:function(e){this.map.markerAdditionOnClick=e},polygonAdditionOnClick:function(e){this.map.polygonAdditionOnClick=e},polygonPopupOnClick:function(e){this.map.polygonPopupOnClick=e},polygonDetailsOnClick:function(e){this.map.polygonDetailsOnClick=e},openMarkerDetails:function(e){this.map.markerDetailsOnClick&&WUX.Events.publish({event:"/SG/UICE/CMD//ColorMarker/EDIT",data:{fromCreateMarker:!1,marker:e}})},openPolygonDetails:function(e){this.map.polygonDetailsOnClick&&WUX.Events.publish({event:"/SG/UICE/CMD//ColorArea/EDIT",data:{fromCreateArea:!1,polygon:e}})},turnGlobeToLatLon:function(e,t,i){this.camera.moveToLatLon({lat:e,lon:t},i)},flyToLatLon:function(e,t,i){this.map.flyTo(new L.LatLng(e,t),i,{animate:!0,duration:2.5})},getGeobjectsNb:function(){var e=0;return this.map.eachLayer(function(t){(t instanceof L.Marker||t instanceof L.Polygon)&&(e+=1)}),e},getMarkersNb:function(){var e=0;return this.map.eachLayer(function(t){t instanceof L.Marker&&!t.middleMarker&&(e+=1)}),e},getPolygonsNb:function(){var e=0;return this.map.eachLayer(function(t){t instanceof L.Polygon&&(e+=1)}),e},_getEvent:function(e){return e.from&&e.from.length?e.from[0].event:null},relMouseCoords:function(e,t){t.touches&&t.touches.length>0&&(t=t.touches[0]);var i=0,o=0,s=e;do{i+=s.offsetLeft,o+=s.offsetTop,s=s.offsetParent}while(s);return{x:t.pageX-i,y:t.pageY-o}},handleMouseDown:function(e){var t=this._getEvent(e);if(this.mouseMoved=!1,!(t.path&&t.path[0]!==this.renderer.canvas||t.target&&t.target!==this.renderer.canvas)){this.mouseDown=!0,this.mouseMove=!1;var i=this.relMouseCoords(this.renderer.canvas,t);this.lastMouseX=i.x,this.lastMouseY=i.y,this.mouseDownX=i.x,this.mouseDownY=i.y,this.markerInfo.show(!1,void 0,null)}},handleMouseRightDown:function(e){this.setCursor("Auto")},handleMouseClick:function(e){var t=this._getEvent(e);if(this.overlayDisplayed)this.displayHelp(!1);else if(!(t.path&&t.path[0]!==this.renderer.canvas||t.target&&t.target!==this.renderer.canvas)){var i=this.relMouseCoords(this.renderer.canvas,t);"@onTapEvent"===e.eventType&&(i.x=parseInt(e.gesture.events[0].startPosition.x),i.y=parseInt(e.gesture.events[0].startPosition.y)),this.pickAndInvoke(i,t,"onMouseClick")}},handleMouseDoubleClick:function(e){var t=this._getEvent(e),i=this.relMouseCoords(this.renderer.canvas,t);this.pickAndInvoke(i,t,"onMouseDoubleClick")},handleMouseUp:function(e){this.setCursor("Auto");this._getEvent(e);this.mouseDown=!1,this.mouseMove=!1,this.mouseMoved=!1},handleMouseOut:function(e){this._getEvent(e);this.mouseOverMarkersManager&&this.mouseOverMarkersManager.onMouseOut&&this.mouseOverMarkersManager.onMouseOut(),this.mouseOverCountryManager&&this.mouseOverCountryManager.onMouseOut&&this.mouseOverCountryManager.onMouseOut()},handleMouseMove:function(e){if(!this.overlayDisplayed){var t=this._getEvent(e);if(t.path&&t.path[0]!==this.renderer.canvas)return;if(t.target&&t.target!==this.renderer.canvas)return;var i=this.relMouseCoords(this.renderer.canvas,t);(Math.abs(i.x-this.mouseDownX)>10||Math.abs(i.y-this.mouseDownY)>10)&&(this.mouseMoved=!0);var o,s,n,r=i.x,a=i.y;this.mouseDown?(this.mouseMove=!0,this.renderer.camera.changed=!0,this.setCursor("Pan",0),s=(o=this.renderer.camera.getMoveFactor())*(r-this.lastMouseX)/this.inertia,n=o*(a-this.lastMouseY)/this.inertia,0===s&&0===n||this.renderer.camera.setDelta(s,n),this.tilesRange=this.renderer.camera.getTilesToDisplay(),this.lastMouseX=r,this.lastMouseY=a):(this.pickAndInvoke(i,t,"onMouseMove"),this.setCursor("Auto"))}},handleKeyDown:function(){},handleMouseWheel:function(e){this.setCursor("Auto",0);var t=1;if("@onMouseDownEvent"!=e.eventType)t=e.gesture.initDistance>e.gesture.lastDistance?1:-1;else{var i=this._getEvent(e);if(i.target&&i.target!==this.renderer.canvas)return;i.wheelDelta?t=-i.wheelDelta/10:i.detail&&(t=.3*i.detail)}"@onPinchEvent"===e.eventType?(t=.0345*parseFloat(t),this.renderer.camera.zoom(t,!0)):this.renderer.camera.zoom(t),this.tilesRange=this.renderer.camera.getTilesToDisplay(),this.dispatchEvent("zoomEvent",["null"])},pickMarkers:function(e,t){this.tilesRange=this.renderer.camera.getTilesToDisplay();var i,o,s,n,r,a,l=e.x,h=e.y,c=this.tilesRange.size,d=this.tilesRange.xtile0,u=this.tilesRange.ytile0,g=this.tilesRange.level,p=this.renderer.getMarkerSize(),m=p*p,f=[];for(i=d;i<d+c;i++)for(o=u;o<u+c;o++)if(n=this.markerBag.getAllMarkersWithOnScrenPosition(g,i,o))for(s=0;s<n.length;s++)if((r=n[s]&&n[s].length>0?n[s][0]:null).screenPosition){var v=(this.renderer.camera.level+1)/3;((a=(l-r.screenPosition.x)*(l-r.screenPosition.x)+(h-r.screenPosition.y)*(h-r.screenPosition.y))<m*v||a<25)&&(f=f.concat(n[s]))}return f},pickMarkers2:function(e,t){var i,o,s,n=e.x,r=e.y,a=this.renderer.getMarkerSize(),l=a*a,h=[];if(this.tilesRange=this.renderer.camera.getTilesToDisplay(),o=this.markerBag.getAllMarkersWithOnScrenPosition2(this.clusterLevel))for(i=0;i<o.length;i++)if((s=o[i])&&s.screenPosition){var c,d=(this.renderer.camera.level+1)/3;((c=(n-s.screenPosition.x)*(n-s.screenPosition.x)+(r-s.screenPosition.y)*(r-s.screenPosition.y))<l*d||c<25)&&(h=h.concat(o[i]))}return h},pickCountry:function(e,t){e.x,e.y;var i=this.renderer.pickCountryIndex(e.x,e.y,t);return i>=0?[this.countryManager.get(i)]:[]},pickAndInvoke:function(e,t,i){var o;if((!t.path||t.path[0]===this.renderer.canvas)&&(this.lastCoords=e,o=globe.dataModel._clustering?this.pickMarkers2(e,t):this.pickMarkers(e,t),this.mouseOverMarkersManager&&this.mouseOverMarkersManager[i]&&this.mouseOverMarkersManager[i](o,e.x,e.y),0===o.length&&this.mouseOverCountryManager&&this.mouseOverCountryManager[i])){var s=this.pickCountry(e,t);this.mouseOverCountryManager[i](s,e.x,e.y)}},subscribeToEvent:function(e){if(e)0!==this.eventTokenList.length&&this.subscribeToEvent(!1),this.eventTokenList.push(v.subscribe({event:"/VISU/onMouseDown"},this.handleMouseWheel.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onLeftMouseDown"},this.handleMouseDown.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onRightMouseDown"},this.handleMouseRightDown.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onLeftMouseUp"},this.handleMouseUp.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onMouseMove"},this.handleMouseMove.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onMouseOut"},this.handleMouseOut.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onTouch"},this.handleMouseDown.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onRelease"},this.handleMouseUp.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onPan"},this.handleMouseMove.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onSwipe"},this.handleMouseMove.bind(this))),this.eventTokenList.push(v.subscribe({event:"/VISU/onPinch"},this.handleMouseWheel.bind(this)));else{var t;for(t=0;t<this.eventTokenList.length;++t)v.unsubscribe(this.eventTokenList[t]);this.eventTokenList=[]}},switchToProjection:function(e){},changeSkin:function(e,t){if(this.use2D){var i={};this.map&&(this.map.eachLayer(function(e){e._tiles&&this.map.removeLayer(e)}.bind(this)),L.tileLayer(e,{maxNativeZoom:18,maxZoom:18,noWrap:!0}).addTo(this.map))}else{(i={}).credentials=f.credentials;var o=C.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/"+e+"/");if(t?(f.theme=e,this.skin=e,f.tilespath=o+"tiles/",this.markerInfo.changeSkin(e)):(f.tilespath=e,this.markerInfo.changeSkin(f.defaultTheme)),this.markerBag&&this.markerBag.markerSkins&&this.markerBag.markerSkins.default){var s=this.markerBag,n=function(e){s.markerSkins.default.material.uniforms.uBackSampler.value=e,s.markerSkins.default.material.needsUpdate=!0};M.loadTexture(i,n,C.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/")+"natural/marker/markerBack128.png");n=function(e){s.markerSkins.default.material.uniforms.uColorSampler.value=e,s.markerSkins.default.material.needsUpdate=!0};M.loadTexture(i,n,C.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/")+"natural/marker/markerColor.png")}if(this.visuStore.params.baseUrl=f.tilespath,this.visuStore.ortho.url=f.tilespath+"%l/%x/%y"+f.tileExtension,this.tileBag.unloadTextures(),this.visuStore.clean("ortho"),t&&void 0!==this.poleN){this.skin=e;var r=this.poleN,a=(n=function(e){r.threeMaterial.uniforms.uOSMSampler.value=e,r.threeMaterial.needsUpdate=!0},M.loadTexture(i,n,o+"poles/NE2_HR_LC_SR_W_cm_N"+f.tileExtension),this.poleS),l=function(e){a.threeMaterial.uniforms.uOSMSampler.value=e,a.threeMaterial.needsUpdate=!0};M.loadTexture(i,l,o+"poles/NE2_HR_LC_SR_W_cm_S"+f.tileExtension)}else if(t)this.skin=e,void 0!==this.poleMaker&&(this.poleMaker.skin=e);else if(void 0!==this.poleN)n=function(e){this.poleN.threeMaterial.uniforms.uOSMSampler.value=e,this.poleN.threeMaterial.needsUpdate=!0},M.loadTexture(i,n.bind(this),e+"2/0/0"+f.tileExtension),l=function(e){this.poleS.threeMaterial.uniforms.uOSMSampler.value=e,this.poleS.threeMaterial.needsUpdate=!0},M.loadTexture(i,l.bind(this),e+"2/2/3"+f.tileExtension);else void 0!==this.poleMaker&&(this.poleMaker.skin="tms-user");this.visuQT.clear()}},changeTileExtension:function(e){f.tileExtension=e,this.use2D||(this.visuStore.ortho.url=f.tilespath+"%l/%x/%y"+f.tileExtension,this.tileBag.unloadTextures(),this.visuStore.clean("ortho"),this.visuQT.clear())},showMeridians:function(e){this.tileBag.showMeridians=e,this.poleMaker.showMeridians=e;var t=0;e&&(t=1),this.poleN.threeMaterial.externalThickness=t,this.poleN.threeMaterial.needsUpdate=!0,this.poleS.threeMaterial.externalThickness=t,this.poleS.threeMaterial.needsUpdate=!0;for(var i=0;i<this.loadedTiles.length;i++)this.loadedTiles[i].threeMaterial.uniforms.externalThickness.value=t,this.loadedTiles[i].threeMaterial.needsUpdate=!0},setBackgroundColor:function(e,t){this.renderer.setBackgroundColor(e,t)},setDefaultMarkerMouseOver:function(){var e=this,t={onMouseMove:function(t,i,o){t.length?e.getDataModel().hover(t[0]):e.getDataModel().hover()},onMouseClick:function(t,i,o){if(k.clearHighlight(),t.length>0){var s=[i,o],n=t[0];k.isValidLink(n)&&n.persist&&k.highlightFrame(n),e.markerInfo.show(!0,n,s,!1,!0),void 0!==t[0].onclick&&t[0].onclick(),e.setSelection(t)}else e.markerInfo.show(!1,void 0,null),e.setSelection([])},onMouseDoubleClick:function(e,t,i){e.length>0&&void 0!==e[0].ondoubleclick&&(e[0].ondoubleclick(),console.log("double click manager",e[0]))},onMouseOut:function(){},onClearMarkers:function(){}};this.mouseOverMarkersManager=t;var i={onMouseClick:function(e,t,i){},onMouseOut:function(){},onClearMarkers:function(){}};this.countrySelectionActivated&&(i={onMouseClick:function(t,i,o){if(k.clearHighlight(),t.length>0&&e.dataModel.getLastSelectedCountry(t)!==t[0]){var s=[i,o];e.markerInfo.show(!0,t[0],s),void 0!==t[0].onclick&&t[0].onclick(),e.setSelection(t),e.dataModel.setLastSelectedCountry(t[0]),k.isValidLink(t[0])&&t[0].persist&&k.highlightFrame(t[0])}else e.markerInfo.show(!1,void 0,null),e.setSelection([]),e.dataModel.setLastSelectedCountry(null)},onMouseOut:function(){},onClearMarkers:function(){}}),this.mouseOverCountryManager=i},setHalo:function(e,t){this.haloMaker&&(this.haloMaker.color=e,this.haloMaker.intensity=t,this.halo&&(this.renderer.removeObject(this.halo),this.halo=this.haloMaker.createMesh(),this.renderer.addObject(this.halo)))},updateCluster:function(){var e=globe.camera.threeCamera.position.length(),t=1-(Math.max(Math.min(e,5),1.015)-1.015)/(5-1.015),o=Math.pow(t,13),s=Math.floor(11*o);for(s=Math.max(1,s),this.clusterLevel=s,this.markerBag.clusterLevel=this.clusterLevel,i=0;i<this.clusterMeshes.length;i++)this.renderer.removeClusterNode(this.clusterMeshes[i]);this.clusterMeshes=[];var n=this.markerBag.getClusterRep(s,globe.getBBox());if(n)for(var r=0;r<n.length;r++)this.clusterMeshes.push(n[r]),this.renderer.addClusterNode(n[r])},updateMarkerRep:function(e){var t,i,o,s,n,r,a=e.size,l=e.xtile0,h=e.ytile0,c=e.level,d=Math.pow(2,c);for(t=0,i=0,t=0;t<this.markerMeshes.length;t++)this.renderer.removeObject(this.markerMeshes[t]);for(this.markerMeshes=[],t=l;t<l+a;t++)for(i=h;i<h+a;i++)if((o=t%d)<0&&(o+=d),s=i%d,n=this.markerBag.getMarkerRep(c,o,s,globe.dataModel._clustering))for(r=0;r<n.length;r++)this.markerMeshes.push(n[r]),this.renderer.addObject(n[r])},updateMarkerRep2:function(e){for(var t=this.clusterLevel,i=0;i<this.markerMeshes.length;i++)this.renderer.removeObject(this.markerMeshes[i]);this.markerMeshes=[];var o=this.markerBag.getMarkerRep2(t,globe.getBBox());if(o)for(var s=0;s<o.length;s++)this.markerMeshes.push(o[s]),this.renderer.addObject(o[s])},setDeleteMode:function(e,t){this.deleteMode[e]=t},setInertia:function(e){this.inertia=e},setMaxLevel:function(e){console.log("set max level"),this.use2D?(Object.values(this.map._layers)[0].options.maxNativeZoom=e,console.log(Object.values(this.map._layers)[0].options.maxNativeZoom)):(this.visuStore.ortho.levelMax=e,this.visuQT.levelMax=e,this.camera.maxlevel=e)},getBBox:function(){var e=90,t=Math.PI*this.camera.viewAngle/180;if(Math.tan(t*this.camera.threeCamera.aspect/2)*this.camera.dist<1){var i=(this.camera.dist-1)/this.camera.dist*Math.asin(Math.tan(t*this.camera.threeCamera.aspect/2)*this.camera.dist);e=Math.min(90,1.5*i*180/Math.PI)}return{point:{lat:this.camera.lat,lon:this.camera.lon},distance:e}},getBBox2:function(){var e=90,t=Math.PI*this.camera.viewAngle/180,i=Math.PI-t-Math.asin(1/this.camera.dist*Math.sin(t));(i=180*i/Math.PI,Math.tan(t*this.camera.threeCamera.aspect/2)*this.camera.dist<1)&&(e=180*((this.camera.dist-1)/this.camera.dist*Math.asin(Math.tan(t*this.camera.threeCamera.aspect/2)*this.camera.dist))/Math.PI);return{point:{lat:this.camera.lat,lon:this.camera.lon},distance:e}},start:function(){if(!this.started){if(this.use2D){var e;e=this.initialGeoloc?new L.latLng(this.initialGeoloc.split(",")[0],this.initialGeoloc.split(",")[1]):[27.25,2.52];var t=this.initialTileMapValue,i=(this.initialMaxLevel,this.initialZoomLevel),o=this.initialGeoJSON,s=L.map(this.div,{zoomControl:!1,maxBounds:[[-90,-180],[90,180]],maxBoundsViscosity:1}).setView(e,i);s.on("zoomend",function(e){var t=s.getZoom();0!=a-t&&this.updateUnzoomButton(t),a=t}.bind(this)),L.DomUtil.addClass(s._container,"crosshair-cursor-enabled");var n,r=L.tileLayer("https://3dmap-raster.uwglobe.com/3ds/{z}/{x}/{y}.png ",{maxNativeZoom:20,maxZoom:20,noWrap:!0});n=t?L.tileLayer(t,{maxNativeZoom:20,maxZoom:20,noWrap:!0}):r,s.addLayer(n),this.map=s,this.markerDetailsOnClick(!1),this.markerPopupOnClick(!0),this.polygonDetailsOnClick(!1),this.polygonPopupOnClick(!0),this.loadGeoJSON(o);var a=this.map.getZoom();return s}var l=this.renderer,h=this,c=(l.getCanvas(),l.camera),d=null;this.mouseMoved=!1,this.mouseDown=!1,this.mouseMove=!1,this.mouseDownX=-1,this.mouseDownY=-1,this.lastMouseX=null,this.lastMouseY=null,this.haloMaker&&this.haloMaker.intensity>0&&(this.halo=this.haloMaker.createMesh(),this.renderer.addObject(this.halo)),this.poleMaker&&(this.poleN=this.poleMaker.createMesh(!0),this.renderer.addObject(this.poleN),this.poleS=this.poleMaker.createMesh(!1),this.renderer.addObject(this.poleS)),this.started=!0;this.subscribeToEvent(!0),v.subscribe({event:"/VISU/onLeftClick"},this.handleMouseClick.bind(this)),v.subscribe({event:"/VISU/onLeftDoubleClick"},this.handleMouseDoubleClick.bind(this)),v.subscribe({event:"/VISU/onTap"},this.handleMouseClick.bind(this)),v.subscribe({event:"/VISU/onDoubleTap"},this.handleMouseDoubleClick.bind(this)),function e(){h.stop||requestAnimationFrame(e),function(){if(h.visuStore.pollQueues(),h.visuStore.cleanupStores(),h.visuStore.timeStamp=Date.now(),d&&l.onMouseOver(d),h.camera.threeCamera){var e=h.camera.threeCamera.position.clone().negate();h.planarQT.build(e,h.camera.level,f.lon2tileFlt(h.camera.lon,0),f.lat2tileFlt(h.camera.lat,0)),h.visuQT.update(),h.camera.changed=!1}h.visuQT.display(),h.markerBag.updateMaterialBeforeDraw(),h.tilesRange=c.getTilesToDisplay(),!0===h.dataModel._clustering?(h.updateCluster(),h.updateMarkerRep2(h.tilesRange)):h.updateMarkerRep(h.tilesRange),h.globeLoader&&h.globeLoader.refresh(),l.render()}()}(),this.dispatchEvent("onGlobeReady",!0)}},onFilterChange:function(){this.loadingInfo.show(),this.clearMarkers(),k.resetAll(),this.dataModel.updateLoadedData(this._taggerProxy,!0)},onFilterChange2D:function(){var e=this.clustering;this.dataModel.updateLoadedData2D(this._taggerProxy,!1,!1,e)},onSearch:function(e){this.loadingInfo.show(),this.clearMarkers(),k.resetAll(),this.dataModel.updateLoadedData(this._taggerProxy,!0,e)},onSearch2D:function(e){var t=this.clustering;this.dataModel.updateLoadedData2D(this._taggerProxy,e,!1,t)},onResetSearch:function(){this.loadingInfo.show(),this.clearMarkers(),k.resetAll(),this.dataModel.updateLoadedData(this._taggerProxy,!0)},onResetSearch2D:function(){var e=this.clustering;this.dataModel.updateLoadedData2D(this._taggerProxy,null,!0,e)},onColorize:function(e){this.loadingInfo.show(),this.clearMarkers(),k.resetAll(),this.dataModel.colorize(this._taggerProxy,e)},onColorize2D:function(e){console.log("colorize"),this.dataModel.colorize2D(this._taggerProxy,e,this.clustering)},onUnColorize:function(){this.loadingInfo.show(),this.clearMarkers(!1),k.resetAll(),this.dataModel.unColorize(this._taggerProxy)},onUnColorize2D:function(){console.log("uncolorize"),console.log(this.clustering),this.dataModel.unColorize2D(this._taggerProxy,this.clustering)},setClustering:function(e){if(globe.dataModel._clustering=e,globe.markerBag._clustering=e,!0===e)this.clearMarkers(),k.resetAll();else{var t;for(t=0;t<this.clusterMeshes.length;t++)this.renderer.removeClusterNode(this.clusterMeshes[t]);this.clusterMeshes=[]}},setClustering2D:function(e){if(e){this.clustering=!0,console.log(this.clustering),console.log("setclustering2D"),this.unclusteredLayerGroup=L.layerGroup(),this.allMarkersCluster=L.markerClusterGroup({maxClusterRadius:80,showCoverageOnHover:!1,removeOutsideVisibleBounds:!1,iconCreateFunction:function(e){return L.divIcon({html:e.getChildCount(),className:"customCluster",iconSize:L.point(40,40)})}}),this.map.eachLayer(function(e){e instanceof L.Marker&&(this.unclusteredLayerGroup.addLayer(e),this.map.removeLayer(e))}.bind(this)),this.allMarkersCluster.addLayers(this.unclusteredLayerGroup),this.dataModel.unclusteredLayerGroup=this.unclusteredLayerGroup.getLayers(),this.map.addLayer(this.allMarkersCluster),console.log(this.allMarkersCluster._featureGroup._layers);for(const[e,i]of Object.entries(this.allMarkersCluster._featureGroup._layers))if(i instanceof L.Marker&&!i.hasOwnProperty("_markers")){var t=i.options.uuid;document.getElementById(t).setAttribute("fill",i.style_properties.color)}this.map.on("layeradd",function(e){if(this.clustering&&e.layer instanceof L.Marker&&!e.layer.hasOwnProperty("_markers")){var t=e.layer.options.uuid;document.getElementById(t).setAttribute("fill",e.layer.style_properties.color)}}.bind(this))}else this.clustering=!1,this.map.hasLayer(this.allMarkersCluster)&&(this.map.removeLayer(this.allMarkersCluster),this.map.addLayer(this.unclusteredLayerGroup)),this.allMarkersCluster=null,this.unclusteredLayerGroup&&this.unclusteredLayerGroup.eachLayer(function(e){e.getElement().getElementsByTagName("ellipse")[0].setAttribute("fill",e.style_properties.color)})},uuidv4:function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}})}),define("DS/SocialGlobe/GlobeItf",["UWA/Class","DS/SocialGlobe/Globe","DS/SocialGlobe/Marker","DS/SocialGlobe/Globals"],function(e,t,i,o){"use strict";var s=e.extend({init:function(e){this.globe=e,this.debugMsg=!1},getCountryManager:function(){return this.globe.getCountryManager()},addMarker:function(e,t,i,o,s,n,r){return this.globe.addMarker(e,t,i,o,s,n,r)},addMarker2D:function(e){return console.log("add marker 2D globeitf"),this.globe.addMarker2D(e)},getMarker:function(e){return this.globe.markerBag.getMarker(e)},clearMarkers:function(){this.globe.clearMarkers()},setMouseOverMarkersManager:function(e){this.globe.mouseOverMarkersManager=e},getCountryIndexFromISO3:function(e){return this.globe.getCountryIndexFromISO3(e)},setMouseOverCountryManager:function(e){this.globe.mouseOverCountryManager=e},setCountryColor:function(e,t){this.globe.setCountryColor(e,t)},clearCountries:function(){this.globe.clearCountries()},clearGeoJSONData:function(e){this.globe.clearGeoJSONData()},clearGeoJSONFromURL:function(){this.globe.clearGeoJSONFromURL()},showFrontiers:function(e){this.globe.showFrontiers(e)},setCountrySelection:function(e){this.globe.setCountrySelection(e)},getCountryObject:function(e){return this.globe.getCountry(e)},setDefaultColor:function(e,t,i){this.globe.globeLoader.setDefaultColor(e,t,i)},setBackgroundColor:function(e,t){this.globe.setBackgroundColor(e,t)},setHalo:function(e,t){this.globe.setHalo(e,t)},go:function(){this.globe.start()},destroy:function(){this.clearMarkers(),this.clearCountries(),this.globe.stop=!0},turnGlobeToLatLon:function(e,t,i){this.globe.turnGlobeToLatLon(e,t,i)},flyToLatLon:function(e,t,i){this.globe.flyToLatLon(e,t,i)},autoTurn:function(e){this.globe.camera.autoTurn=e},loadJSONData:function(e,t){UWA.Data.request(e,{type:"",onComplete:this.displayJSONData.bind(this,t)})},displayJSONData:function(e,t){if(!this.use2D){this.clearCountries(),this.clearMarkers();var i=JSON.parse(t)}this.loadGeoJSON(i,e),this.use2D||this.globe.setDefaultMarkerMouseOver()},loadGeoJSON:function(e,t,i,o){return this.globe.loadGeoJSON(e,t,null,i,o)},allowZoom:function(e){this.enableZoom(e)},enableZoom:function(e){this.globe.enableZoom(e)},setZoomDistance:function(e,t){this.globe.setZoomDistance(e,t)},setFragShader:function(e){this.globe.setFragShader(e)},updateShader:function(e){this.globe.updateShader(e)},changeSkin:function(e,t){this.globe.changeSkin(e,t)},changeTileExtension:function(e){this.globe.changeTileExtension(e)},showMeridians:function(e){this.globe.showMeridians(e)},log:function(e){this.debugMsg&&UWA.log("GLOBE: "+e)},setInertia:function(e){this.globe.setInertia(e)},setEditMode:function(e){this.globe.setEditMode(e)},setMaxLevel:function(e){this.globe.setMaxLevel(e)}});return s.create=function(e,i,n){if(o.isBrowserSupported()){var r=new t(e,null,null,i,n);return new s(r)}return e.innerHTML=o.getBrowserErrorMsg(),e.style.backgroundColor="white",null},s}),
/*!
  Script: DSSocialGlobeUWA.js

    This file is part of UWA JS Runtime.

  About: License

    Copyright 2006-2013 Dassault Systèmes company.
    All rights reserved.
*/
window.DSSocialGlobe={},define("DS/SocialGlobe/GlobeUWA",["UWA/Core","UWA/Controls/Abstract","UWA/Controls/ToolTip","DS/SocialGlobe/GlobeItf","DS/SocialGlobe/Globals","DS/Core/Events","UWA/Utils/InterCom","DS/SocialGlobe/MessageDispatcher","DS/ApplicationFrame/FrameWindow","DS/WebappsUtils/WebappsUtils","DS/Controls/Toggle","DS/Controls/Timeline","DS/Controls/TileView","UWA/Controls/Input","UWA/Controls/ColorPicker","DS/TagNavigatorProxy/TagNavigatorProxy","DS/WAFData/WAFData","DS/SocialGlobeServices/i3DDashboard/i3DDriveServices","DS/SocialGlobe/GlobeNotifications","i18n!DS/SocialGlobe/assets/nls/GlobeViewer","DS/Controls/ColorPicker","DS/Controls/Popup","DS/Controls/Button","DS/Windows/ImmersiveFrame","DS/Windows/Panel","DS/Controls/ProgressBar","DS/SocialGlobe/MarkerInfoManager","DS/SocialGlobe/UIFieldsChoice","DS/SocialGlobe/GeocodingAndReverse"],function(e,t,i,o,s,n,r,a,l,h,c,d,u,g,p,m,f,v,b,w,y,M,S,C,k,x,D,T,P){"use strict";return t.extend({defaultOptions:{path:"./"},init:function(e,t){if(void 0!==t.baseUrlRedefined&&h.setWebappsBaseUrl(t.baseUrlRedefined),this._parent(t),this.widgetHeight=t.height,this.fullscreenMode=!1,this.widget=e,this.options.use2D?(e.addEvent("onSearch",this.onSearch2D.bind(this)),e.addEvent("onResetSearch",this.onResetSearch2D.bind(this))):(e.addEvent("onSearch",this.onSearch.bind(this)),e.addEvent("onResetSearch",this.onResetSearch.bind(this))),this.options.use2D||e.hasPreference("areasManagement")||e.addPreference({name:"areasManagement",type:"boolean",label:"Areas Management",defaultValue:!1}),e.hasPreference("3DDriveGeoJSONManagement")||e.addPreference({name:"3DDriveGeoJSONManagement",type:"hidden",label:"3DDrive GeoJSON Management",defaultValue:""}),e.hasPreference("wuxPanelManagement")||e.addPreference({name:"wuxPanelManagement",type:"hidden",label:"WUXPanel Management",defaultValue:"",value:""}),this.options.use2D?e.endEdit=this.endEdit2D.bind(this):e.endEdit=this.loadPreferences.bind(this),e.onEdit=this.onEdit.bind(this),e.onRefresh=this.onRefresh.bind(this),this.buildSkeleton(),!this.options.use2D){s.sendMessage=this.send,this.sockets={},this.sockets.dispatch=new r.Socket("Globe.Dispatch"+e.id),this.sockets.listen=new r.Socket("Globe.Listen"+e.id);var i=e.getValue("uwaServer");""===i&&(i="uwa.embedded"),this.sockets.dispatch.subscribeServer(i),this.sockets.listen.subscribeServer(i),this.msgDispatcher=new a(this,this.widget,this.sockets.dispatch,this.sockets.listen)}this.widget.id&&(this.getGlobe()._taggerProxy=m.createProxy({widgetId:this.widget.id,filteringMode:"FilteringOnServer",colorize:!0,events:{addFilterChangeListener:this.onFilterChange.bind(this)}}),this.options.use2D?(this.getGlobe()._taggerProxy.addEvent("colorize",this.onColorize2D.bind(this)),this.getGlobe()._taggerProxy.addEvent("unColorize",this.onUnColorize2D.bind(this))):(this.getGlobe()._taggerProxy.addEvent("colorize",this.onColorize.bind(this)),this.getGlobe()._taggerProxy.addEvent("unColorize",this.onUnColorize.bind(this)))),this._current6wtags=[],this.widget.body.addEventListener("drop",this.onDrop.bind(this),!1),this.widget.body.addEventListener("dragover",this.onDragOver,!1),"high-tech"==e.getValue("theme")&&(this.setTheme("satellite"),b.display({level:"warning",title:w.get("GlobeViewer.DisplaySettings.Theme.ThemeUpdate.Title"),subtitle:w.get("GlobeViewer.DisplaySettings.Theme.ThemeUpdate.Subtitle"),message:w.get("GlobeViewer.DisplaySettings.Theme.ThemeUpdate.Message")}))},onDragOver:function(e){e.preventDefault()},buildSkeleton:function(){var t=this.options,n=this.options.use2D;t.canvas?this.elements.container=t.div:this.elements.container=e.createElement("div",{id:"map",styles:{position:"relative",backgroundColor:"transparent",width:"100%",height:"100%"}}),s.isBrowserSupported()?this.globe=o.create(this.elements.container,t.use2D,!0):this.elements.container.innerHTML=s.getBrowserErrorMsg(),this.helpDisplayed=!1,this.customPanelDisplayed=!1,this.markersManager=void 0,this.editMode=!1,this.helpPanel=new UWA.Element("div",{styles:{width:"100%",height:"100%",position:"absolute",background:"rgba(0,0,0,0.5)",zIndex:5e4,display:"none",color:"white"}}),this.customPanel=new UWA.Element("div",{styles:{position:"absolute",background:"rgba(0,0,0,0.5)",padding:"5px",zIndex:5e4,display:"none",color:"white"}}),this.infoPanel=new UWA.Element("div",{html:"this is the content",styles:{position:"absolute",background:"rgba(0,0,0,0)",width:"50%",height:"50px",zIndex:52e3,color:"white",bottom:"-25px",left:"25%"}}),this.mapPanel=new UWA.Element("div",{styles:{position:"absolute",background:"rgba(0,0,0,0)",zIndex:52e3,color:"white",bottom:"-25px",right:"15px"}}),this.unzoomPanel=new UWA.Element("div",{styles:{position:"absolute",background:"rgba(0,0,0,0)",zIndex:52e3,color:"white",bottom:"-25px",left:"15px"}}),this.unzoomButton=new UWA.Element("button",{html:"",styles:{width:32,height:32,border:"none",color:"white",background:"url("+h.getWebappsAssetUrl("SocialGlobe","icons/32/icon_pov.png")+")"}}).inject(this.unzoomPanel),n?(this.unzoomButton.addEventListener("click",this.unzoomAll2D.bind(this)),this.unzoomPanel.style.display="none",this.globe.globe.unzoomButton=this.unzoomPanel):(this.unzoomButton.onclick=this.unzoomAll.bind(this),this.unzoomButton.addEvent("touchstart",this.unzoomAll.bind(this)),this.globe.globe.camera.unzoomButton=this.unzoomPanel);new i(this.unzoomButton,"Zoom out",{width:"90px",offsetX:10,offsetY:0}),new UWA.Element("div",{html:"<br>THIS IS THE HELP CONTENT."}).inject(this.helpPanel);this.topBars={},this.panelDiv=new UWA.Element("div",{styles:{position:"absolute",zIndex:52e3,bottom:"32px",left:"0px",right:"0px",overflow:"auto"}}),this.globe.globe.loadingInfo=new UWA.Element("div",{styles:{position:"absolute",zIndex:51e3,bottom:"50%",right:"50%",transform:"translate(50%, 50%)","pointer-events":"none"}});new UWA.Element("span",{html:"Loading data...",styles:{padding:"10px"}}).inject(this.globe.globe.loadingInfo);if(new x({displayStyle:"lite"}).inject(this.globe.globe.loadingInfo).show().infiniteFlag=!0,this.globe.globe.loadingInfo.hide(),this.interactionPanel=new UWA.Element("div",{styles:{position:"relative",zIndex:52e3,"padding-left":"40px","padding-right":"40px","padding-top":"10px","padding-bottom":"10px",fontWeight:200,borderBottom:"1px solid #F0F0F0",borderTop:"1px solid #f0F0F0",backgroundColor:"#FAFAFA",overflow:"auto","min-width":"500px","max-width":"600px",margin:"0 auto"}}).inject(this.panelDiv),this.interactionPanel.hide(),this.themePanel=new UWA.Element("div",{styles:{position:"relative",zIndex:52e3,"padding-left":"40px","padding-right":"40px","padding-top":"10px","padding-bottom":"10px",fontWeight:200,borderBottom:"1px solid #F0F0F0",borderTop:"1px solid #f0F0F0",backgroundColor:"#FAFAFA",overflow:"auto",margin:"0 auto","max-width":"400px","min-height":"280px"}}).inject(this.panelDiv),this.themePanel.hide(),this.advancedPanel=new UWA.Element("div",{styles:{position:"relative",zIndex:52e3,"padding-left":"40px","padding-right":"40px","padding-top":"10px","padding-bottom":"10px",fontWeight:200,borderBottom:"1px solid #F0F0F0",borderTop:"1px solid #f0F0F0",backgroundColor:"#FAFAFA",overflow:"auto",margin:"0 auto","max-width":"500px"}}).inject(this.panelDiv),this.advancedPanel.hide(),this.loaddataPanel=new UWA.Element("div",{styles:{position:"relative",zIndex:52e3,"padding-left":"40px","padding-right":"40px","padding-top":"10px","padding-bottom":"10px",fontWeight:200,borderBottom:"1px solid #F0F0F0",borderTop:"1px solid #f0F0F0",backgroundColor:"#FAFAFA",overflow:"auto",margin:"0 auto","max-width":"500px"}}).inject(this.panelDiv),this.loaddataPanel.hide(),this.allowZoomButton=new c({domId:"enable-zoom-toggle",label:"Enable zoom",internalLabelsFlag:!0,type:"switch",checkFlag:!!n||""}),this.allowZoomButton.inject(this.interactionPanel),this.allowZoomButton.addEventListener("change",function(){this.enableZoom(this.allowZoomButton.checkFlag)}.bind(this)),!n){var r=new UWA.Element("div",{styles:{position:"absolute"}});this.interactionPanel.addContent(r);var a=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{}}).inject(this.interactionPanel),l=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"Auto-rotation speed",styles:{height:"42px","margin-top":"15px"}}).inject(a),new UWA.Element("li",{class:"wux-controls-switch-container inner-width",styles:{}}).inject(a));this.rotationspeedButton=new d({domId:"rotation-speed-slider",minValue:0,maxValue:2,value:0,stepValue:.1,dynamicGraduations:!1,dynamicGaugeColor:!1,graduationsLabel:!0,showCursorLabel:!1,eventsList:[{label:"OFF",value:0},{label:"Low",value:.5},{label:"Medium",value:1},{label:"Fast",value:2}],activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(l),this.rotationspeedButton.addEventListener("change",function(){this.autoTurn(this.rotationspeedButton.getValue())}.bind(this));var u=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{}}).inject(this.interactionPanel),p=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"Globe inertia",styles:{height:"42px","margin-top":"15px"}}).inject(u),new UWA.Element("li",{class:"wux-controls-switch-container inner-width",styles:{}}).inject(u));this.interactionspeedButton=new d({domId:"interaction-speed-slider",minValue:10,maxValue:180,value:70,stepValue:5,dynamicGraduations:!1,dynamicGaugeColor:!1,graduationsLabel:!0,showCursorLabel:!1,eventsList:[{label:"Low",value:10},{label:"Medium",value:75},{label:"High",value:180}],activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(p),this.interactionspeedButton.addEventListener("change",function(){this.setInertia(this.interactionspeedButton.getValue())}.bind(this))}var m=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{}}).inject(this.interactionPanel),f=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"Initial zoom level",styles:{height:"42px","margin-top":"15px"}}).inject(m),new UWA.Element("li",{class:"wux-controls-switch-container inner-width",styles:{}}).inject(m));this.initialzoomButton=n?new d({domId:"initial-zoom-slider",minValue:2.3,maxValue:20,value:2,stepValue:1,dynamicGraduations:!1,dynamicGaugeColor:!1,graduationsLabel:!0,showCursorLabel:!1,eventsList:[{label:"World",value:2.3},{label:"Continent",value:5},{label:"Country",value:6.5},{label:"Town",value:12},{label:"Building",value:20}],activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC",firstLaunch:!0}).inject(f):new d({domId:"initial-zoom-slider",minValue:1.01,maxValue:7,value:7,stepValue:.01,dynamicGraduations:!1,dynamicGaugeColor:!1,graduationsLabel:!0,showCursorLabel:!1,eventsList:[{label:"Town",value:1.01},{label:"Country",value:1.8},{label:"Continent",value:3.9},{label:"Planet",value:6}],activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(f),this.globe.globe.initialZoomButton=this.initialzoomButton,this.initialzoomButton.addEventListener("change",function(){this.initialzoomButton.firstLaunch?(this.setZoomDistance(this.initialzoomButton.getValue(),!0),this.initialzoomButton.firstLaunch=!1):this.setZoomDistance(this.initialzoomButton.getValue(),!1)}.bind(this));var v=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{}}).inject(this.interactionPanel),b=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"Initial coordinates (lat,lon)"}).inject(v),new UWA.Element("li",{class:"wux-controls-switch-container inner-width",styles:{height:"20px"}}).inject(v));if(this.coordinatesInput=new g.Text({attributes:{id:"coordinates-input",placeholder:"Ex: 48.857617,2.334014"}}).inject(b),this.globe.globe.initialCoordinates=this.initialCoordinates,this.coordinatesInput.addEvent("onChange",function(){this.setInitialCoordinates(this.coordinatesInput.getValue())}.bind(this)),!n){var M=new UWA.Element("div",{id:"satellite-preview",styles:{"background-image":"url("+h.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/prev-satellite.jpg")+")",width:"100%",height:"40px","padding-top":"10px"}}).inject(this.themePanel);this.satelliteThemeButton=new c({label:" ",internalLabelsFlag:!0,type:"switch"}).inject(M),this.satelliteThemeButton.addEventListener("change",function(){this.satelliteThemeButton.checkFlag&&(this.setTheme("satellite"),this.naturalThemeButton.checkFlag=!1,this.minimalThemeButton.checkFlag=!1)}.bind(this));var S=new UWA.Element("div",{id:"natural-preview",styles:{"background-image":"url("+h.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/prev-natural.jpg")+")",width:"100%",height:"40px","padding-top":"10px"}}).inject(this.themePanel);this.naturalThemeButton=new c({label:" ",internalLabelsFlag:!0,type:"switch"}).inject(S),this.naturalThemeButton.addEventListener("change",function(){this.naturalThemeButton.checkFlag&&(this.setTheme("natural"),this.satelliteThemeButton.checkFlag=!1,this.minimalThemeButton.checkFlag=!1)}.bind(this));var C=new UWA.Element("div",{id:"minimal-preview",styles:{"background-image":"url("+h.getWebappsAssetUrl("SocialGlobe","skins/GlobeViewerSkins/prev-minimal.jpg")+")",width:"100%",height:"40px","padding-top":"10px"}}).inject(this.themePanel);this.minimalThemeButton=new c({label:" ",internalLabelsFlag:!0,type:"switch"}).inject(C),this.minimalThemeButton.addEventListener("change",function(){this.minimalThemeButton.checkFlag&&(this.setTheme("minimal"),this.naturalThemeButton.checkFlag=!1,this.satelliteThemeButton.checkFlag=!1)}.bind(this)),this.naturalThemeButton.elements.container.style.textAlign="right",this.satelliteThemeButton.elements.container.style.textAlign="right",this.minimalThemeButton.elements.container.style.textAlign="right",this.naturalThemeButton.addEvent("change",function(e){this.naturalThemeButton.checkFlag&&(this.satelliteThemeButton.checkFlag=!1,this.minimalThemeButton.checkFlag=!1)}.bind(this)),this.satelliteThemeButton.addEvent("change",function(e){this.satelliteThemeButton.checkFlag&&(this.naturalThemeButton.checkFlag=!1,this.minimalThemeButton.checkFlag=!1)}.bind(this)),this.minimalThemeButton.addEvent("change",function(e){this.minimalThemeButton.checkFlag&&(this.naturalThemeButton.checkFlag=!1,this.satelliteThemeButton.checkFlag=!1)}.bind(this)),this.backgroundcolorButton=new c({domId:"background-color-toggle",label:"Override background color",internalLabelsFlag:!0,type:"switch"}).inject(this.themePanel),this.backgroundcolorButton.addEventListener("change",function(){if(this.backgroundcolorButton.checkFlag){this.widget.setValue("backcolor","#"+this.themecolorPicker.value),this.setBackgroundColor("#"+this.themecolorPicker.value,1);try{this.backgroundColor.show()}catch(e){console.log("Cannot hide element")}}else{if(this.setTheme(this.currentTheme),this.themecolorPicker){this.themecolorPicker.value="005685";try{this.backgroundColor.hide()}catch(e){console.log("Cannot hide element")}}this.widget.setValue("backcolor","")}}.bind(this)),this.backgroundColor=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"none"}}).inject(this.themePanel);var k=new UWA.Element("li",{class:"wux-controls-abstract wux-controls-toggle wux-controls-switch"}).inject(this.backgroundColor);new UWA.Element("label",{html:w.get("GlobeViewer.DisplaySettings.Text.BackgroundColor"),class:"display-background-label"}).inject(k);this.themecolorPicker=new y({domId:"background-color-picker",value:"005685"}).inject(k),this.themecolorPicker.elements.container.setStyles({left:"5px"}),this.themecolorPicker.addEventListener("change",function(){this.backgroundcolorButton.checkFlag&&(this.widget.setValue("backcolor","#"+this.themecolorPicker.value),this.setBackgroundColor("#"+this.themecolorPicker.value,1))}.bind(this))}var D=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.advancedPanel),T=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"TMS (Tile Map Service) URL"}).inject(D),new UWA.Element("li",{class:"wux-controls-switch-container",styles:{width:"300px",height:"20px"}}).inject(D)),P=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.advancedPanel),A=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"Tile extension (default .basis)"}).inject(P),new UWA.Element("li",{class:"wux-controls-switch-container",styles:{width:"300px",height:"20px"}}).inject(P)),G=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.advancedPanel),E=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"TMS max level"}).inject(G),new UWA.Element("li",{class:"wux-controls-switch-container",styles:{width:"300px",height:"20px"}}).inject(G)),I=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.advancedPanel),V=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"CORS exception servers"}).inject(I),new UWA.Element("li",{class:"wux-controls-switch-container",styles:{width:"300px",height:"20px"}}).inject(I));this.tmsInput=new g.Text({attributes:{id:"tms-input",placeholder:"Ex: https://the.path.before/Z/Y/X.ext"}}).inject(T),this.addHelpPopup(T,"URL");var L=widget.getValue("tilemapserver"),_=widget.getValue("tileextension");if(this.tmsInput.addEvent("onChange",function(){(L=this.tmsInput.getValue(),n)?""!==L?(_?L.includes("{z}/{x}/{y}")?this.changeSkin(L+_,!1):this.changeSkin(L+"{z}/{x}/{y}"+_,!1):L.includes("{z}/{x}/{y}")?this.changeSkin(L+".png",!1):this.changeSkin(L+"{z}/{x}/{y}.png",!1),this.widget.setValue("tilemapserver",L)):(_&&""!=_?this.changeSkin("https://3dmap-raster.uwglobe.com/3ds/{z}/{x}/{y}"+_,!1):this.changeSkin("https://3dmap-raster.uwglobe.com/3ds/{z}/{x}/{y}.png",!1),this.widget.setValue("tilemapserver","")):""!==L?(this.changeSkin(L,!1),""===widget.getValue("cors-exception")&&(this.setCorsExceptions(L),this.widget.setValue("tilemapserver",L))):(this.changeSkin(this.currentTheme,!0),this.widget.setValue("tilemapserver",L))}.bind(this)),this.tileextensionInput=new g.Text({attributes:{id:"tile-extension-input",placeholder:"Ex: .jpg - Default: .png"}}).inject(A),this.addHelpPopup(A,"Extension"),this.tileextensionInput.addEvent("onChange",function(){if(_=this.tileextensionInput.getValue(),n){var e=this.tmsInput.getValue();""!==_?(this.changeTileExtension(_),e?e.includes("{z}/{x}/{y}")?this.changeSkin(e+_,!1):this.changeSkin(e+"{z}/{x}/{y}"+_,!1):this.changeSkin("https://3dmap-raster.uwglobe.com/3ds/{z}/{x}/{y}"+_,!1),this.widget.setValue("tileextension",_)):e?e.includes("{z}/{x}/{y}")?this.changeSkin(e+".png"):this.changeSkin(e+"{z}/{x}/{y}.png"):this.changeSkin("https://3dmap-raster.uwglobe.com/3ds/{z}/{x}/{y}.png",!1)}else""!==_?(this.changeTileExtension(_),this.widget.setValue("tileextension",_)):(this.changeTileExtension(".basis"),this.widget.setValue("tileextension",""))}.bind(this)),this.tmsmaxlevelInput=new g.Text({attributes:{id:"tms-max-level-input",placeholder:"Ex: 12 - Default: 18"}}).inject(E),this.addHelpPopup(E,"MaxLevel"),this.tmsmaxlevelInput.addEvent("onChange",function(){var e=this.tmsmaxlevelInput.getValue();""!==e&&""!==this.tmsInput.getValue()?(this.setMaxLevel(parseInt(e)),this.widget.setValue("tilemapserver-max",e)):n?(this.setMaxLevel(20),this.widget.setValue("tilemapserver-max",20)):(this.setMaxLevel(6),this.widget.setValue("tilemapserver-max",6))}.bind(this)),this.corsserverInput=new g.Text({attributes:{id:"cors-server-input",placeholder:"Ex: https://the.path.before/"}}).inject(V),this.addHelpPopup(V,"CorsException"),this.corsserverInput.addEvent("onChange",function(){var e=this.corsserverInput.getValue(),t=this.tmsInput.getValue();""!==e||"https://tile.openstreetmap.org/"===t&&""===e?(this.setCorsExceptions(e),this.widget.setValue("cors-exception",e)):this.widget.setValue("cors-exception","")}.bind(this)),!n)var F=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.loaddataPanel),U=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"GeoRSS feed url"}).inject(F),new UWA.Element("li",{class:"wux-controls-switch-container",styles:{width:"300px",height:"20px"}}).inject(F));var W=new UWA.Element("ul",{class:"wux-ui-stack-h wux-controls-switch wux-ui-size-small",styles:{display:"block","padding-bottom":"10px"}}).inject(this.loaddataPanel),O=(new UWA.Element("li",{class:"wux-controls-switch-label",html:"GeoJSON data url"}).inject(W),new UWA.Element("li",{class:"wux-controls-switch-container",styles:{width:"300px",height:"20px"}}).inject(W));return n||(this.georssInput=new g.Text({attributes:{id:"georss-input",placeholder:"GeoRSS feed"}}).inject(U),this.georssInput.addEvent("onChange",function(){var e=this.georssInput.getValue();this.widget.setValue("feedUrl",this.georssInput.getValue()),""!==e?(UWA.log("... loading "+e),this.loadRSSData(e)):(this.clearCountries(),this.globe.clearMarkers())}.bind(this))),this.geojsonInput=new g.Text({attributes:{id:"geojson-input",placeholder:"JSON data url"}}).inject(O),this.geojsonInput.addEvent("onChange",function(){var e=this.geojsonInput.getValue();this.widget.setValue("jsonFile",this.geojsonInput.getValue()),""!==e?(UWA.log("... loading "+e),n?UWA.Data.request(e,{type:"",onComplete:this.clearAndLoad2D.bind(this,e)}):this.loadJSONData(e,!0)):n?(this.globe.clearGeoJSONFromURL(),this.widget.setValue("jsonFile",""),this.widget.setValue("jsonFieldsPrefURL","")):(this.clearCountries(),this.globe.clearMarkers())}.bind(this)),this.enableProxyPassportButton=new c({domId:"sso-toggle",label:"Enable SSO for GeoJSON data url",internalLabelsFlag:!0,type:"switch"}),this.enableProxyPassportButton.inject(this.loaddataPanel),this.enableProxyPassportButton.addEventListener("change",function(){this.enableProxyPassport=this.enableProxyPassportButton.checkFlag,this.widget.setValue("enableproxypassport",this.enableProxyPassportButton.checkFlag)}.bind(this)),this.widget.getValue("GeocodingTool")&&this.createGeocodingPanel(),this.elements.container},clearAndLoad2D:function(e,t){var i=JSON.parse(t);this.globe.globe.jsonUrlContent=JSON.parse(t);var o=Object.keys(i.features[0].properties).sort().indexOf("start_city"),s=Object.keys(i.features[0].properties).sort().indexOf("end_city");-1!=o&&-1!=s||this.globe.clearGeoJSONFromURL(),this.loadJSONData(e,!0)},send:function(e){var t={widgetID:this.widget.id,text:e};this.sockets.dispatch.dispatchEvent("Globe.NewMessage",t)},tagging6w:function(e){e.hasFiltersTEMP?this._current6wtags=e.filteredSubjectList:this._current6wtags=[];var t=this.widget.getValue("feedUrl"),i=widget.getValue("jsonFile");""!==i?this.loadJSONData(i,!1):""!==t&&this.loadRSSData(t)},onFilterChange:function(e){this.options.use2D?(console.log("filter change"),this.getGlobe().onFilterChange2D(e)):this.getGlobe().onFilterChange(e)},onSearch:function(e){WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable(),WUX.AFR.CommandsManager.getCommand("Reset").disable(),this.getGlobe().onSearch(e)},onSearch2D:function(e){WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable(),WUX.AFR.CommandsManager.getCommand("Reset").disable(),WUX.AFR.CommandsManager.getCommand("CreateArea").disable(),WUX.AFR.CommandsManager.getCommand("EditArea").disable(),this.getGlobe().onSearch2D(e)},onResetSearch:function(){widget.getValue("clustering")?WUX.AFR.CommandsManager.getCommand("Reset").enable():(WUX.AFR.CommandsManager.getCommand("Save").enable(),WUX.AFR.CommandsManager.getCommand("AddMarker").enable(),WUX.AFR.CommandsManager.getCommand("EditMarker").enable(),WUX.AFR.CommandsManager.getCommand("Reset").enable()),this.getGlobe().onResetSearch()},onResetSearch2D:function(){widget.getValue("clustering")?WUX.AFR.CommandsManager.getCommand("Reset").enable():(WUX.AFR.CommandsManager.getCommand("Save").enable(),WUX.AFR.CommandsManager.getCommand("AddMarker").enable(),WUX.AFR.CommandsManager.getCommand("EditMarker").enable(),WUX.AFR.CommandsManager.getCommand("Reset").enable(),WUX.AFR.CommandsManager.getCommand("CreateArea").enable(),WUX.AFR.CommandsManager.getCommand("EditArea").enable()),this.getGlobe().onResetSearch2D()},onColorize:function(e){this.getGlobe().onColorize(e),WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable(),WUX.AFR.CommandsManager.getCommand("Reset").disable()},onColorize2D:function(e){console.log("colorize"),this.getGlobe().onUnColorize2D(),this.getGlobe().onColorize2D(e),WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable(),WUX.AFR.CommandsManager.getCommand("Reset").disable(),WUX.AFR.CommandsManager.getCommand("CreateArea").disable(),WUX.AFR.CommandsManager.getCommand("EditArea").disable()},onUnColorize:function(){console.log("uncolorize"),this.getGlobe().onUnColorize(),widget.getValue("clustering")?WUX.AFR.CommandsManager.getCommand("Reset").enable():(WUX.AFR.CommandsManager.getCommand("Save").enable(),WUX.AFR.CommandsManager.getCommand("AddMarker").enable(),WUX.AFR.CommandsManager.getCommand("EditMarker").enable(),WUX.AFR.CommandsManager.getCommand("Reset").enable())},onUnColorize2D:function(){this.getGlobe().onUnColorize2D(),widget.getValue("clustering")?WUX.AFR.CommandsManager.getCommand("Reset").enable():(WUX.AFR.CommandsManager.getCommand("Save").enable(),WUX.AFR.CommandsManager.getCommand("AddMarker").enable(),WUX.AFR.CommandsManager.getCommand("EditMarker").enable(),WUX.AFR.CommandsManager.getCommand("CreateArea").enable(),WUX.AFR.CommandsManager.getCommand("EditArea").enable(),WUX.AFR.CommandsManager.getCommand("Reset").enable())},setTopBar:function(e){if(this._topbar&&!this._topbar.noContainerRemove&&this._topbar.container.remove(),this._topbar=this.topBars[e],this._topbar&&!this._topbar.noContainerRemove){var t=this.frmWindow.getUIFrame();this._topbar.container.inject(t,"top")}},getCountryManager:function(){return this.globe.getCountryManager()},getGlobe:function(){return this.globe.globe},addMarker:function(e,t,i,o,s,n,r){return console.log("add marker 3D"),this.globe.addMarker(e,t,i,o,s,n,r)},addMarker2D:function(e){return console.log("add marker 2D"),this.globe.addMarker2D(e)},getMarker:function(e){return this.globe.getMarker(e)},clearMarkers:function(){this.globe.clearMarkers()},setMouseOverMarkersManager:function(e){this.globe.setMouseOverMarkersManager(e)},getCountryIndexFromISO3:function(e){return this.globe.getCountryIndexFromISO3(e)},setMouseOverCountryManager:function(e){this.globe.setMouseOverCountryManager(e)},setCountryColor:function(e,t){this.globe.setCountryColor(e,t)},clearCountries:function(){this.globe.clearCountries()},clearGeoJSONData:function(){this.globe.clearGeoJSONData()},clearGeoJSONFieldsPref:function(){widget.hasPreference("jsonFieldsPrefURL")&&widget.setValue("jsonFieldsPrefURL",""),widget.hasPreference("jsonFieldsPref3DDrive")&&widget.setValue("jsonFieldsPref3DDrive","")},clearGeoJSONInput:function(){this.geojsonInput.setValue(""),this.widget.setValue("jsonFile","")},showFrontiers:function(e){this.globe.showFrontiers(e)},setCountrySelection:function(e){this.globe.setCountrySelection(e),this.widget.setValue("countrySelection",e.toString()),s.isCountriesLoaded()||s.loadCountries().then(function(){console.info("Countries load success.")},function(e){throw console.error(e),e})},getCountryObject:function(e){return this.globe.getCountryObject(e)},setDefaultColor:function(e,t,i){this.globe.setDefaultColor(e,t,i)},setBackgroundColor:function(e,t){this.globe.setBackgroundColor(e,t)},setHalo:function(e,t){this.globe.setHalo(e,t)},go:function(){this.globe.go()},destroy:function(){this.globe.destroy()},flyToLatLon:function(e,t,i){this.globe.flyToLatLon(e,t,i)},turnGlobeToLatLon:function(e,t,i){this.globe.turnGlobeToLatLon(e,t,i)},autoTurn:function(e){this.globe.autoTurn(e),this.rotationspeedButton.getValue()!=e&&this.rotationspeedButton.setValue(e),this.widget.setValue("autoTurn",e)},loadGeoJSON:function(e,t,i,o){return this.globe.loadGeoJSON(e,t,i,o)},enableZoom:function(e){this.globe.enableZoom(e),this.allowZoomButton.checkFlag!==e&&(this.allowZoomButton.checkFlag=e),this.widget.setValue("allowZoom",e.toString())},setZoomDistance:function(e,t){this.globe.setZoomDistance(e,t),this.options.use2D?this.widget.setValue("initDistance2D",parseFloat(e)):this.widget.setValue("initDistance",parseFloat(e))},setInitialCoordinates:function(e){var t=e,i=null;/^-?\d{1,2}(\.\d+)?,(-?\d{1,3}(\.\d+)?)$/i.test(t)&&(i=t.split(",")),null!==i&&2===i.length&&(parseFloat(i[0])<-85&&(i[0]=-85),parseFloat(i[0])>85&&(i[0]=85),Math.abs(parseFloat(i[1]))>180&&(i[1]%=180),this.options.use2D?this.flyToLatLon(i[0],parseFloat(i[1]),this.initialzoomButton.getValue()):this.turnGlobeToLatLon(i[0],parseFloat(i[1]),this.initialzoomButton.getValue()),this.widget.setValue("initGeoloc",i[0]+","+i[1])),""==t&&this.widget.setValue("initGeoloc","")},setTheme:function(e){this.currentTheme=e,this.widget.setValue("theme",e),""!==e&&""===this.widget.getValue("tilemapserver")&&this.changeSkin(e,!0),"satellite"==e?(this.setHalo("#0d324e",.8),this.backgroundcolorButton.checkFlag||this.setBackgroundColor("#005686",1)):"minimal"==e?(this.setHalo("#828282",.15),this.backgroundcolorButton.checkFlag||this.setBackgroundColor("#ffffff",1)):(this.setHalo("#40a5de",.3),this.backgroundcolorButton.checkFlag||this.setBackgroundColor("#005686",1))},setFragShader:function(e){this.globe.setFragShader(e)},updateShader:function(e){this.globe.updateShader(e)},changeSkin:function(e,t){this.globe.changeSkin(e,t)},changeTileExtension:function(e){this.globe.changeTileExtension(e)},showMeridians:function(e){this.globe.showMeridians(e)},displayHelp:function(e){this.helpDisplayed=e,this.helpDisplayed?(this.helpPanel.style.display="block",this.globe.globe.overlayDisplayed=!0):(this.helpPanel.style.display="none",this.globe.globe.overlayDisplayed=!1)},displayCustomPanel:function(e,t,i){this.customPanelDisplayed=e,this.globe.globe.overlayDisplayed=e,this.customPanelDisplayed?(this.customPanel.style.left=t.toString()+"px",this.customPanel.style.top=i.toString()+"px",this.customPanel.style.display="block"):this.customPanel.style.display="none"},resetCustomPanel:function(){this.customPanel.empty()},addContentToCustomPanel:function(e){this.customPanel.addContent(e)},loadJSONData:function(e,t){this.options.use2D?UWA.Data.request(e,{type:"",onComplete:this.displayJSONData.bind(this,t)}):(this.resetManualData(),UWA.Data.request(e,{type:"",onComplete:this.displayJSONData.bind(this,t)}))},loadRSSData:function(e){this.resetManualData(),UWA.Data.request(e,{timeout:15e3,method:"GET",type:"feed",proxy:"feed",cache:900,auth:{disable_passport:1},onComplete:this.displayRSSData.bind(this),onFailure:function(t){console.log("Failed to load",e,t)}})},displayRSSData:function(e){this.getGlobe()._taggerProxy&&this.getGlobe()._taggerProxy.setSubjectsTags(e.tagData),this.clearCountries(),this.clearMarkers();for(var t=!1,i=0;i<e.items.length;i++){var o=e.items[i];if(this._current6wtags&&0===this._current6wtags.length||this._current6wtags.indexOf(o.id)>-1)if(o.geo&&o.geo.geometry&&"Point"===o.geo.geometry.type){t=!0;var s="#ff0000";if(o.geo.properties&&o.geo.properties.relationshipTag&&o.geo.properties.relationshipTag.length>0&&(s=o.geo.properties.relationshipTag[0].replace("color=","")),o.geo.geometry&&"Point"===o.geo.geometry.type){var n=o.geo.geometry.coordinates;this.addMarker(n[1],n[0],0,s,o.title,o.content,null)}}else if(o.geo&&o.geo.properties&&o.geo.properties.featureTypeTag&&"country"===o.geo.properties.featureTypeTag[0]){!0;var r="#ff0000";if(o.geo.properties&&o.geo.properties.relationshipTag&&o.geo.properties.relationshipTag.length>0){var a=this.getCountryManager(),l=o.geo.properties.relationshipTag[0].split("/"),h=l[0].replace("countrycode=",""),c=a.getIndexFromISO3(h);r=l[1].replace("color=","");var d=a.get(c);d.title=o.title,d.description=o.description,d.setHtmlColor(r)}}}t&&this.globe.globe.setDefaultMarkerMouseOver()},displayJSONData:function(e,t){console.log("display json data");var i=JSON.parse(t);if(this.options.use2D)if(""!=widget.getPreference("jsonFieldsPrefURL").value&&(this.loadOptions=widget.getPreference("jsonFieldsPrefURL").value),this.jsonUrlFromPref)console.log("json url from pref"),this.globe.globe.jsonUrlContent=JSON.parse(t),this.globe.globe.loadGeoJSON(i,!0,this._current6wtags,this.globe._taggerProxy,this.loadOptions),this.jsonUrlFromPref=!1,widget.getValue("clustering")&&""==widget.getPreference("3DDriveGeoJSONManagement").value&&(this.getGlobe().setClustering2D(!0),WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable(),WUX.AFR.CommandsManager.getCommand("CreateArea").disable(),WUX.AFR.CommandsManager.getCommand("EditArea").disable());else{WUX.Events.publish({event:"/SG/UICE/CMD//Geojson/IMPORT",data:{geojson:i}})}else this.clearCountries(),this.clearMarkers(),this.globe.globe.loadGeoJSON(i,!0,this._current6wtags,this.getGlobe()._taggerProxy),this.globe.globe.setDefaultMarkerMouseOver()},unzoomAll:function(){this.turnGlobeToLatLon(this.globe.globe.camera.lat,this.globe.globe.camera.lon,8),this.unzoomPanel.style.display="none",setTimeout(function(){this.globe.globe.dispatchEvent("zoomEvent",["null"])}.bind(this),750)},unzoomAll2D:function(e){this.setZoomDistance(2,!1)},setInertia:function(e){this.globe.setInertia(e),this.interactionspeedButton.getValue()!=e&&this.interactionspeedButton.setValue(e),this.widget.setValue("inertia",e)},setEditMode:function(e){this.editMode=e,this.globe.setEditMode(e)},setMaxLevel:function(e){this.globe.setMaxLevel(e)},setCorsExceptions:function(e){"none"===e&&(s.credentials={});for(var t=e.split(" "),i=0;i<t.length;i++)s.credentials[t[i]]=!1},createFrameWindow:function(e){this.widget.setValue("webafr_IsActionBarCollapsed",!0),console.log("Globe Viewer v"+this.globe.globe.version),this.options.use2D?this.frmWindow=new l({workbench:"GlobeViewer2D.xml",workbenchModule:"SocialGlobe",viewer:"none",minHeight:"200",height:"100%"}):this.frmWindow=new l({workbench:"GlobeViewer.xml",workbenchModule:"SocialGlobe",viewer:"none",minHeight:"200",height:"100%"}),this.frmWindow.inject(this.widget.body);var t=this.frmWindow.getUIFrame(),i=this.frmWindow.getViewerFrame();this.elements.container.inject(i),t.onclick=function(e){e.stopPropagation()},this.helpPanel.inject(t,"top"),this.customPanel.inject(t,"top"),this.mapPanel.inject(t,"top"),this.unzoomPanel.inject(t,"top"),this.panelDiv.inject(t,"top"),this.globe.globe.loadingInfo.inject(this.widget.body,"top"),this.actionBar=this.frmWindow._actionBar,this.actionBar.onActionBarClose(function(){WUX.AFR.CommandsManager.endAll()}),this.actionBar.onSectionChange(function(){WUX.AFR.CommandsManager.endAll()});widget.getValue("editMode"),widget.body.clientHeight>105&&widget.body.clientWidth;this.frmWindow.globe=this;var o=this.actionBar;if(!this.options.use2D)var s=o.onActionBarReady(function(){o.close(),o.removeCallback(s),widget.getPreference("areasManagement").value&&o.loadModel({file:"GlobeViewer_areas.xml",module:"SocialGlobe",merge:!0}),widget.getValue("clustering")?(WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable()):(WUX.AFR.CommandsManager.getCommand("Save").enable(),WUX.AFR.CommandsManager.getCommand("AddMarker").enable(),WUX.AFR.CommandsManager.getCommand("EditMarker").enable())});D.setFrameWindow(this.frmWindow),this.widget.getValue("GeocodingTool")&&(this.GeocodingAndReverse.frmWindow=this.frmWindow);var n=this.widget.getValue("context");n&&(this.options.use2D?this.globe.globe.initialGeoJSON=n:this.getGlobe().getDataModel().build(n.features,!1,null,this.getGlobe()._taggerProxy))},endEdit2D:function(){this.geojsonReload2D=!1,this.loadPreferences.bind(this)},loadPreferences:function(){this.preferencesOpened=!0;var e=this.options.use2D,t=this.widget;this.globe.globe.initialMaxLevel=18;var i=t.getValue("widgetTitle");if(t.setTitle(i),!e){var o=parseFloat(t.getValue("autoTurn"));this.autoTurn(o);var n=t.getPreference("areasManagement").value;this.setCountrySelection(n);var r="true"===t.getValue("showFrontiers");this.showFrontiers(r);var a=parseFloat(t.getValue("inertia"));this.setInertia(a);var l="true"===t.getValue("allowZoom");this.enableZoom(l)}if(""!==(c=t.getValue("tilemapserver")))if(e){c+="{z}/{x}/{y}";var h=t.getValue("tileextension");this.globe.globe.initialTileMapValue=""!==h?c+h:c+".png",this.changeSkin(c+h,!1)}else{this.changeSkin(c,!1),""===(u=t.getValue("cors-exception"))&&this.setCorsExceptions(c)}if(!e){var c,d=t.getValue("theme");if(""!==d&&(this.globe.globe.skin=d,s.theme=d,this.currentTheme=d),""!==(c=t.getValue("tilemapserver")))this.changeSkin(c,!1),""===(u=t.getValue("cors-exception"))&&this.setCorsExceptions(c);""!==(h=t.getValue("tileextension"))&&this.changeTileExtension(h);var u,g=t.getValue("tilemapserver-max");""!==g&&""!==c&&this.setMaxLevel(parseInt(g)),""!==(u=t.getValue("cors-exception"))&&this.setCorsExceptions(u),""!==d&&""===c&&this.changeSkin(d,!0),"satellite"==d?(this.setHalo("#0d324e",.8),this.setBackgroundColor("#005686",1)):"minimal"==d?(this.setHalo("#828282",.15),this.setBackgroundColor("#ffffff",1)):(this.setHalo("#40a5de",.3),this.setBackgroundColor("#005686",1));var p=t.getValue("backcolor");""!==p&&this.setBackgroundColor(p,1)}if(e){var m=t.getValue("initDistance2D");""!==m&&(this.globe.globe.initialZoomLevel=m,this.initialzoomButton.firstLaunch=!0,this.initialzoomButton.setValue(this.globe.globe.initialZoomLevel));var f=t.getValue("initGeoloc");""!==f&&(this.globe.globe.initialGeoloc=f)}else{var v=parseFloat(t.getValue("initDistance"));this.setZoomDistance(v);var b=t.getValue("initGeoloc"),w=null;""!==b&&(w=b.split(",")),null!==w&&2===w.length&&this.turnGlobeToLatLon(parseFloat(w[0]),parseFloat(w[1]),parseFloat(t.getValue("initDistance")))}this.enableProxyPassport=t.getValue("enableproxypassport");var y=t.getValue("feedUrl");""!==y&&(UWA.log("... loading "+y),this.loadRSSData(y));var M=t.getValue("jsonFile");e?""!==M&&!1!==this.geojsonReload2D&&(UWA.log("... loading "+M),this.jsonUrlFromPref=!0,this.loadJSONData(M,!0)):""!==M&&(UWA.log("... loading "+M),this.jsonUrlFromPref=!0,this.loadJSONData(M,!0));t.getValue("widgetHeight").toString();var S="true"===t.getValue("editMode");this.setEditMode(S);var C,k=t.getPreference("3DDriveGeoJSONManagement").value;""!==k&&(e?!1!==this.geojsonReload2D&&(C=0)<(k=JSON.parse(k)).length&&this.addGeoJsonDroppedFiles(this,C,k,!0):(C=0)<(k=JSON.parse(k)).length&&this.addGeoJsonDroppedFiles(this,C,k,!0));t.addPreference({name:"clustering",type:"boolean",label:"Activate Clustering",defaultValue:!1}),e?t.getValue("clustering")&&(this.getGlobe().clustering=!0):this.getGlobe().setClustering(t.getValue("clustering"))},onEdit:function(){this.preferencesOpened=!0},onRefresh:function(){var e=this.options.use2D;if(this.preferencesOpened)if(e)this.actionBar.loadModel({file:"GlobeViewer2D.xml",module:"SocialGlobe",merge:!1}),widget.getValue("clustering")?(this.getGlobe().setClustering2D(!0),WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable()):(this.getGlobe().setClustering2D(!1),WUX.AFR.CommandsManager.getCommand("Save").enable(),WUX.AFR.CommandsManager.getCommand("AddMarker").enable(),WUX.AFR.CommandsManager.getCommand("EditMarker").enable());else{this.actionBar.loadModel({file:"GlobeViewer.xml",module:"SocialGlobe",merge:!1});var t=this.actionBar,i=t.onActionBarReady(function(){t.close(),t.removeCallback(i),widget.getPreference("areasManagement").value&&t.loadModel({file:"GlobeViewer_areas.xml",module:"SocialGlobe",merge:!0}),widget.getValue("clustering")?(WUX.AFR.CommandsManager.getCommand("Save").disable(),WUX.AFR.CommandsManager.getCommand("AddMarker").disable(),WUX.AFR.CommandsManager.getCommand("EditMarker").disable()):(WUX.AFR.CommandsManager.getCommand("Save").enable(),WUX.AFR.CommandsManager.getCommand("AddMarker").enable(),WUX.AFR.CommandsManager.getCommand("EditMarker").enable())})}else;this.preferencesOpened=!1},updateHeight:function(e,t,i){},showInteractionPanel:function(e){e?(this.panelDiv.show(),this.interactionPanel.show()):this.interactionPanel.hide()},showThemePanel:function(e){e?(this.panelDiv.show(),this.themePanel.show()):(this.panelDiv.hide(),this.themePanel.hide())},showAdvancedPanel:function(e){e?(this.panelDiv.show(),this.advancedPanel.show()):(this.panelDiv.hide(),this.advancedPanel.hide())},showLoadDataPanel:function(e){e?(this.panelDiv.show(),this.loaddataPanel.show()):(this.panelDiv.hide(),this.loaddataPanel.hide())},onDrop:function(e){if(e.stopPropagation(),e.preventDefault(),""!=widget.getValue("3DDriveGeoJSONManagement")){var t=new Error(w.get("GlobeViewer.DragAndDrop.Notification.DocumentIdErrorMessage"));return t.title=w.get("GlobeViewer.DragAndDrop.Notification.NoMoreFileTitle"),t.subtitle=w.get("GlobeViewer.DragAndDrop.Notification.NoMoreFileSubtitle"),void b.display({level:"error",title:t.title,subtitle:t.subtitle})}try{var i=e.dataTransfer;if(0===i.types.length)throw new Error(w.get("GlobeViewer.DragAndDrop.Notification.DropUnknownTypeErrorMessage"));if("Files"===i.types[0])throw new Error(w.get("GlobeViewer.DragAndDrop.Notification.DropFileErrorMessage"));var o=i.getData("text"),s=JSON.parse(o);0<s.data.items.length&&this.addGeoJsonDroppedFiles(this,0,s.data.items)}catch(t){throw t instanceof SyntaxError&&(t.message=w.get("GlobeViewer.DragAndDrop.Notification.InvalidJsonContentErrorMessage")),new Error(t.message)}},addGeoJsonDroppedFiles:function(e,t,i,o=!1){var s=i[t];if(!UWA.is(s,"object"))throw new Error(w.get("GlobeViewer.DragAndDrop.Notification.InvalidJsonContentErrorMessage"));var n=s.envId,r=s.objectId;if(!UWA.is(r,"string")||""===r){var a=new Error(w.get("GlobeViewer.DragAndDrop.Notification.DocumentIdErrorMessage"));throw a.title=w.get(o?"GlobeViewer.DragAndDrop.Notification.ReloadError":"GlobeViewer.DragAndDrop.Notification.DragAndDropError"),a.subtitle=w.get("GlobeViewer.DragAndDrop.Notification.InvalidContentErrorMessage",{name:s.displayName}),b.display({level:"error",title:a.title,subtitle:a.subtitle,message:a.message}),new Error(a.message)}v.retrieve3DDriveUrl(n).then(function(e){return Promise.resolve(e)}).then(function(e){return v.retrieveDocumentTypes(e,s.objectId,n)}).then(function(e){if("GEOJSON"!==e.extension.toUpperCase()){var t=new Error(w.get("GlobeViewer.AddContent.Notification.UnsupportedFileTypeErrorMessage",{format:e.extension.toUpperCase()}));throw t.title=w.get(o?"GlobeViewer.DragAndDrop.Notification.ReloadError":"GlobeViewer.DragAndDrop.Notification.DragAndDropError"),t.subtitle=w.get("GlobeViewer.AddContent.Notification.ContentAdditionError",{name:s.displayName}),b.display({level:"error",title:t.title,subtitle:t.subtitle,message:t.message}),new Error(t.message)}return v.retrieveDocumentURL(e.driveUrl,s.objectId,n)}).then(function(e){return v.retrieveDocumentContent(e,n)}).then(function(n){e.addGeoJSONContent(n,s,o);++t<i.length&&b.display({level:"warning",title:w.get("GlobeViewer.AddContent.Notification.OnlyOneFile.Title"),subtitle:w.get("GlobeViewer.AddContent.Notification.OnlyOneFile.Subtitle"),message:w.get("GlobeViewer.AddContent.Notification.OnlyOneFile.Message")})}).catch(function(e){console.log(e),(e=new Error(w.get("GlobeViewer.AddContent.Notification.UnaccessibleData"))).title=w.get("GlobeViewer.AddContent.Notification.DataAccessError"),e.subtitle=w.get("GlobeViewer.AddContent.Notification.ContentAdditionError",{name:s.displayName}),b.display({level:"error",title:e.title,subtitle:e.subtitle,message:e.message}),this.globe.globe.loadingInfo.hide()}.bind(this))},checkGeojsonContent:function(e){try{var t;if(UWA.is(e,"string"))t=JSON.parse(e);else{if(!UWA.is(e,"object"))return{ok:!1,error:new Error(w.get("GlobeViewer.DragAndDrop.Notification.InvalidGeoJsonContentErrorMessage"))};t=e}if("FeatureCollection"!==t.type)return{ok:!1,error:new Error(w.get("GlobeViewer.DragAndDrop.Notification.InvalidGeoJsonContentErrorMessage"))};if(0===t.features.length)return{ok:!1,error:new Error(w.get("GlobeViewer.AddContent.Notification.EmptyGeojsonFile"))};for(var i=0;i<t.features.length;i++){var o=t.features[i];if(!o.geometry)return{ok:!1,error:new Error(w.get("GlobeViewer.DragAndDrop.Notification.InvalidGeoJsonContentErrorMessage"))};if(this.options.use2D){if("Point"!==o.geometry.type&&"Polygon"!==o.geometry.type&&"MultiPolygon"!==o.geometry.type&&"LineString"!==o.geometry.type)return{ok:!1,error:new Error(w.get("GlobeViewer.AddContent.Notification.UnsupportedFeatureTypeErrorMessage",{type:o.geometry.type}))}}else{if("Point"!==o.geometry.type)return{ok:!1,error:new Error(w.get("GlobeViewer.AddContent.Notification.UnsupportedFeatureTypeErrorMessage",{type:o.geometry.type}))};o.properties&&void 0===o.properties.is3DDriveContent&&(o.properties.is3DDriveContent=!0)}}return{ok:!0,content:t}}catch(e){return{ok:!1,error:new Error(w.get("GlobeViewer.DragAndDrop.Notification.InvalidGeoJsonContentErrorMessage"))}}},addGeoJSONContent:function(e,t,i=!1){var o=this.checkGeojsonContent(e);if(!o.ok){var s=o.error;return s.title=w.get(i?"GlobeViewer.DragAndDrop.Notification.ReloadError":"GlobeViewer.DragAndDrop.Notification.DragAndDropError"),s.subtitle=w.get("GlobeViewer.AddContent.Notification.ContentAdditionError",{name:t.displayName}),b.display({level:"error",title:s.title,subtitle:s.subtitle,message:s.message}),o}if(this.options.use2D)if(i)this.loadOptions=widget.getPreference("jsonFieldsPref3DDrive").value,b.display({level:"success",title:w.get(i?"GlobeViewer.DragAndDrop.Notification.ReloadSuccess":"GlobeViewer.DragAndDrop.Notification.DragAndDropSuccess"),subtitle:w.get("GlobeViewer.DragAndDrop.Notification.DragAndDropSuccessfulLoad",{name:t.displayName}),message:w.get("GlobeViewer.AddContent.Notification.GeojsonSuccessfulload")}),this.loadGeoJSON(o.content,!0,this.getGlobe()._taggerProxy);else{var n=Object.keys(o.content.features[0].properties).sort().indexOf("title"),r=Object.keys(o.content.features[0].properties).sort().indexOf("description");new T(this,this.globe.globe,{ID:"GeojsonFieldsChoice",name:t.displayName,titleIndex:n,descIndex:r},null,o.content),this.addGeoJSONFileToPreference(t)}else this.loadGeoJSON(o.content,!0,this.getGlobe()._taggerProxy),i||this.addGeoJSONFileToPreference(t);return o},addGeoJSONFileToPreference:function(e){var t=widget.getPreference("3DDriveGeoJSONManagement").value;this.use2D?(t=e,widget.setValue("3DDriveGeoJSONManagement",JSON.stringify(t))):-1===(t=""!==t?JSON.parse(t):[]).map(function(e){return e.objectId}).indexOf(e.objectId)&&(t.push(e),widget.setValue("3DDriveGeoJSONManagement",JSON.stringify(t)));console.log(widget.getPreference("3DDriveGeoJSONManagement").value)},clearDrivePreferences:function(){widget.hasPreference("3DDriveGeoJSONManagement")&&widget.setValue("3DDriveGeoJSONManagement","")},addHelpPopup:function(e,t){var i=new UWA.Element("span",{html:"",class:"uwa-input-button display-help-button",styles:{background:"url("+h.getWebappsAssetUrl("SocialGlobe","icons/32/I_CFHelp.png")+")"}}).inject(e),o=new UWA.Element("div",{class:"wux-controls-switch-container inner-width",styles:{width:"100%",height:"100%"}});switch(t){case"URL":case"Extension":case"MaxLevel":case"CorsException":var s=w.get("GlobeViewer.DisplaySettings.TMS.help."+t);new UWA.Element("p",{html:s,class:"wux-controls-switch-container inner-width",styles:{width:"100%",height:"100%"}}).inject(o)}if("URL"===t){var n=new UWA.Element("div",{html:"<br/> <br/>"+w.get("GlobeViewer.DisplaySettings.TMS.TilesPoliciesRespect"),class:"wux-controls-switch-container inner-width",styles:{width:"100%",height:"100%"}}).inject(o);new UWA.Element("a",{html:w.get("GlobeViewer.DisplaySettings.TMS.link"),class:"wux-controls-switch-container inner-width",href:"https://wiki.openstreetmap.org/wiki/Tile_servers",target:"_blank"}).inject(n),new UWA.Element("p",{html:w.get("GlobeViewer.DisplaySettings.TMS.help.URLCors"),class:"wux-controls-switch-container inner-width",styles:{width:"100%",height:"100%"}}).inject(o)}return new M({target:i,trigger:"click"}).setBody(o)},clearAll:function(){this.tmsInput.setValue(""),this.tileextensionInput.setValue(""),this.tmsmaxlevelInput.setValue(""),this.corsserverInput.setValue(""),this.tmsInput.events.input.change(),this.tileextensionInput.events.input.change(),this.tmsmaxlevelInput.events.input.change(),this.corsserverInput.events.input.change()},saveAll:function(){var e=this.getGlobe().getDataModel().saveToGeoJSON();return this.widget.setValue("context",e),e},saveMarker:function(e){if(e){var t=this.widget.getValue("context"),i=UWA.clone(t);if(i&&i.features&&i.features.length){for(var o=0;o<i.features.length;o++){var s=i.features[o];s&&s.properties&&s.properties.descriptionType===e.descriptionType&&s.properties.link===e.link&&(s.properties.title&&s.properties.title===e.title||s.properties.ISO3&&s.properties.ISO3[0]===e.title[0])&&s.properties.persist===e.persist&&(s.properties.width=e.width,s.properties.height=e.height)}this.widget.setValue("context",i)}}},updatePanelPreference:function(e,t){var i,o=this.widget.getPreference("wuxPanelManagement").value;(i=""!==o?JSON.parse(o):{})[e]=t,this.widget.setValue("wuxPanelManagement",JSON.stringify(i))},removePanelPreference:function(e){var t=this.widget.getPreference("wuxPanelManagement").value;if(""!==t){var i=JSON.parse(t);delete i[e],this.widget.setValue("wuxPanelManagement",JSON.stringify(i))}},removeAllPanelPreferences:function(){this.widget.setValue("wuxPanelManagement","")},getPanelPreference:function(e){var t=this.widget.getPreference("wuxPanelManagement").value;if(""!==t)return JSON.parse(t)[e]},resetManualData:function(){this.options.use2D||(this.clearCountries(),this.clearMarkers(),this.clearDrivePreferences(),D.resetAll(),this.removeAllPanelPreferences(),this.saveAll())},createGeocodingPanel:function(){new Date;var e=new UWA.Element("div",{html:""});this.geocodingImmersiveFrame=new C({identifier:"WebUIImmersiveFrame_Geocoding"}),this.geocodingImmersiveFrame.inject(this.widget.body),this.GeocodingAndReverse=new P({domId:"origin",renderID:"defaultCityRenderingGeocodingMarker",folder:{id:"geocoding-folder",name:"to be deifned"}}).inject(e),this.GeocodingAndReverse.globe=this.getGlobe(),null!=widget.getValue("GeocodingServerUrl")&&""!=widget.getValue("GeocodingServerUrl")?this.GeocodingAndReverse.url=widget.getValue("GeocodingServerUrl"):b.display({level:"error",title:"Geocoding issue",subtitle:"Invalid Geocoding server url",message:"Please define a correct server url using 'GeocodingServerUrl' preference"}),this.geocodingPanel=new k({immersiveFrame:this.geocodingImmersiveFrame,title:"Geocoding",content:e})}})});