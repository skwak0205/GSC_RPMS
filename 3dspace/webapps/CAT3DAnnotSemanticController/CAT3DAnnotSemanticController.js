/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotSemanticController/CAT3DAnnotSemanticController",[],function(){}),define("DS/CAT3DAnnotSemanticController/CAT3DAnnotSemanticContInstance",["DS/CAT3DAnnotationExpController/CAT3DAnnotExpControllerInstance","DS/Selection/CSOManager","DS/CATWebUXSlideShow/CATWebUXSlideShowController"],function(t,e,n){"use strict";return t.extend({init:function(t){var o=t||{};o.workbenchName="CAT3DAnnotSemanticWidgetWkb",o.moduleName="CAT3DAnnotSemanticWidget",this._parent(o);var a=this,i=o.ctxViewer,r=this.setActiveState;this.setActiveState=function(t){r(t);var e=n.giveSlideShowController({context:i.getFrameWindow(),id:"CAT3DAnnotationSlideShow"});e&&e.setListOfCommandsAllowed(["CAT3DAnnotInsightWidgetDefaultHdr"])},this.getAnnotationControllerType=function(){return"3DAnnotationInsight"};var s=this.clearController;this.clearController=function(){s(),i=a=null};var l=this._onCommandStartCB;this._onCommandStartCB=function(t){l(t);for(var e=["CAT3DAnnotSemanticShowGeomAttachHdr","CAT3DAnnotSemanticShowRelatedAnnotHdr"],n=function(){setTimeout(a._refreshContextualBar)},o=0;o<e.length;o++)t._id===e[o]&&t.onEnd(n)};var g=this.getAnnotControllerPrototype;this.getAnnotControllerPrototype=function(){var t=g();return t.getReferencedAnnotations=function(t){if(a)return a.getReferencedAnnotations(t)},t};var h=this.getContextualCommandList;this.getContextualCommandList=function(){if(!i)return[];var t,n,o,r=h(),s=[],l=e.get(),g=i.getRootBagPath(),A=!1,f=!0;for(t=0;t<l.length;t++)if(l[t].pathElement&&g.isAParentOf(l[t].pathElement)){s.push(l[t].pathElement);var m=l[t].pathElement.getLastElement(!0);if(!m.getAnnotationClassType){f=!1;break}if(A=!0,"tps"!==m.getAnnotationClassType()){f=!1;break}}if(f)for(o=!1,t=0;t<s.length&&!o;t++)if(s[t].getLastElement(!0).isVisible()){var c=s[t].getLastElement(!0),u=void 0!==c.getGeometricalAttachmentList?c.getGeometricalAttachmentList():null;if(u&&u.length){var d=s[t].getParentPath().getParentPath().getLastElement(!0).children;for(n=0;n<d.length;n++){if("RootViews"!==d[n].getAnnotationType()&&"RootCaptures"!==d[n].getAnnotationType()&&"RootGeometries"!==d[n].getAnnotationType())for(var C=d[n].children,p=0;p<C.length;p++){if(-1!==u.indexOf(C[p].getAnnotationID())&&!C[p].isVisible()){r.unshift({name:"CAT3DAnnotInsightShowGeomAttachStr",line:1,hdr_list:["CAT3DAnnotSemanticShowGeomAttachHdr"]}),o=!0;break}}if(o)break}}}if(!A)for(o=!1,t=0;t<s.length&&!o;t++){var v=a.getPontingAnnotations(s[t]);if(v&&v.length)for(n=0;n<v.length;n++)if(!v[n].getLastElement(!0).isVisible()){r.unshift({name:"CAT3DAnnotInsightShowRelatedAnnotStr",line:1,hdr_list:["CAT3DAnnotSemanticShowRelatedAnnotHdr"]}),o=!0;break}}return r},this.getReferencedAnnotations=function(t){var e=t.getLastElement(!0);if("tps"!==e.getAnnotationClassType())return[];var n,o,i=a._getParentAnnotationSetPath(t),r=void 0!==e.getAnnotationReferenceFrame?e.getAnnotationReferenceFrame():null,s=[];if(r||32===e.getAnnotationType()){var l,g=i.getLastElement(!0).getReferenceFrames();for(n=0;n<g.length;n++)if(g[n].tpsID===r||e.getAnnotationUuid()===g[n].uuid){l=g[n].datums;break}if(void 0!==l){var h=i.getLastElement(!0).getRootAnnotationNode("RootDatums"),A=h.children,f=i.clone();for(f.addElement(h),n=0;n<l.length;n++)for(o=0;o<A.length;o++)if(A[o].getAnnotationID()===l[n]){var m=f.clone();m.addElement(A[o]),s.push(m);break}}}return s};var A=function(t,e){return e&&e.length&&(t=t&&t.length?t.concat(e):e),t},f=a.getPointedPaths;this.getPointedPaths=function(t){var e=f(t);if(i.getRootBagPath().isAParentOf(t)){var n=t.getLastElement(!0);if(n.getAnnotationClassType&&"tps"===n.getAnnotationClassType())if(e=A(e,a.getRelatedGeometryPaths([t])),e=A(e,a.getReferencedAnnotations(t)),8===n.getAnnotationSupertype())e=A(e,a.getPontingAnnotations(t));else{var o=a._getParentAnnotationSetPath(t);o&&(e=A(e,function(t,e){var n,o=t.getLastElement(!0);if(o.getDatumTargetList&&o.getDatumTargetList()){var a=o.getDatumTargetList(),i=e.getLastElement(!0).getRootAnnotationNode("RootDatums"),r=e.clone();r.addElement(i);var s=r.getChildrenPathes();n=[];for(var l=0;l<s.length;l++)-1!==a.indexOf(s[l].getLastElement(!0).getAnnotationID())&&n.push(s[l].clone())}return n}(t,o)),e=A(e,function(t,e){var n,o=t.getLastElement(!0);if(o.getAssociatedBasicDims&&o.getAssociatedBasicDims()){var a=o.getAssociatedBasicDims(),i=e.getChildrenPathes();n=[];for(var r=0;r<i.length;r++){var s=i[r].getLastElement(!0);if("RootViews"!==s.getAnnotationType()&&"RootCaptures"!==s.getAnnotationType()&&"RootGeometries"!==s.getAnnotationType())for(var l=i[r].getChildrenPathes(),g=0;g<l.length;g++)-1!==a.indexOf(l[g].getLastElement(!0).getAnnotationID())&&n.push(l[g].clone())}}return n}(t,o)),e=A(e,function(t,e){var n,o=t.getLastElement(!0),a=o.getAuxiliaryFeatures?o.getAuxiliaryFeatures():null;if(a&&(a.annotations||a.cgs)){var i=e.getChildrenPathes();n=[];for(var r=0;r<i.length;r++){var s=i[r].getLastElement(!0);if("RootViews"!==s.getAnnotationType()&&"RootCaptures"!==s.getAnnotationType()){var l,g=0;if("RootGeometries"===s.getAnnotationType()&&a.cgs.length)for(l=i[r].getChildrenPathes(),g=0;g<l.length;g++)-1!==a.cgs.indexOf(l[g].getLastElement(!0).getAnnotationID())&&n.push(l[g].clone());else if("RootGeometries"!==s.getAnnotationType()&&a.annotations.length)for(l=i[r].getChildrenPathes(),g=0;g<l.length;g++)-1!==a.annotations.indexOf(l[g].getLastElement(!0).getAnnotationID())&&n.push(l[g].clone())}}}return n}(t,o)),e=A(e,function(t,e){var n=[];if(t&&t.getLastElement(!0).getAnnotationSCSReframeArea&&t.getLastElement(!0).getAnnotationSCSReframeArea()){let l=t.getLastElement(!0).getAnnotationSCSReframeArea(),g=[];l.upperLimit&&l.upperLimit.length&&(g=g.concat(l.upperLimit)),l.lowerLimit&&l.lowerLimit.length&&(g=g.concat(l.lowerLimit));for(var o=e.getChildrenPathes(),a=0;a<o.length;a++){var i=o[a].getLastElement(!0);if("RootViews"!==i.getAnnotationType()&&"RootCaptures"!==i.getAnnotationType()&&"RootGeometries"!==i.getAnnotationType())for(var r=o[a].getChildrenPathes(),s=0;s<r.length;s++)-1!==g.indexOf(r[s].getLastElement(!0).getAnnotationID())&&n.push(r[s].clone())}}return n}(t,o)))}else e=A(e,a.getPontingAnnotations(t))}return e}}})});