/*!  COPYRIGHT DASSAULT SYSTEMES 2019   */
define("DS/3DPlayVideoExperience/3DPlayVideoLoader",["UWA/Core","UWA/Class"],function(e,t){"use strict";return t.extend({init:function(e){this._parent(e)},load:function(t){var n=function(e){var i=t.frameWindow.getActionBar();t.frameWindow.onActionBarReady(function(){i&&i.close()}),t.videoContainer.removeEventListener("canplaythrough",n),t.loadCB.done()};t.videoContainer.inject(t.viewer),t.videoContainer.addEventListener("canplaythrough",n),new e.Element("source",{src:t.asset.filename||t.asset,type:"video/"+t.asset.format}).inject(t.videoContainer).addEventListener("error",function(e){t.loadCB.failed()})},dispose:function(){}})}),define("DS/3DPlayVideoExperience/3DPlayVideoControls",["UWA/Core","UWA/Class","DS/Controls/Timeline","DS/CoreEvents/Events","css!DS/3DPlayVideoExperience/3DPlayVideoControls","DS/VisuEvents/EventsManager","DS/UIKIT/Input/Button","css!DS/UIKIT/UIKIT"],function(e,t,n,i,o,a,s,r){"use strict";return t.extend({init:function(t){var o=this;this._viewer=t.viewer,this._frmWnd=t.frmWnd,this._uiContainer=e.Element("div",{class:"_3DPlay-VideoControlBar",styles:{"background-color":"#F2F5F7","z-index":1600}});this._frmWnd.getUIFrame();this._uiContainer.inject(this._viewer.viewerContainer);var r=new e.Element("div",{class:"_3DPlay-VideoControlBar-ChildContainer"});r.inject(this._uiContainer);var l=new e.Element("div",{id:"_3DPlay.Video.Timeline",styles:{margin:"-10px 50px 30px 50px"}});l.inject(r);var d=this._viewer.getLength(),h=new n({id:"MaintimeLine",minValue:0,maxValue:d,value:0,displayFunction:function(e){return e?new Date(1e3*e).toUTCString().match(/(\d\d:\d\d:\d\d)/)[0]:null},dynamicGaugeColor:!1,eventsList:[{label:"",value:0},{label:"",value:d}],stepValue:.01}).inject(l),c=new e.Element("div",{styles:{position:"absolute","font-family":"3ds",left:"0%",top:"9%",width:"50px","text-align":"right"},content:new Date(1e3*this._viewer.getCurrentTime()).toUTCString().match(/(\d\d:\d\d:\d\d)/)[0]}).inject(r);new e.Element("div",{styles:{"font-family":"3ds",position:"absolute",right:"2%",top:"9%",width:"50px","text-align":"left"},content:new Date(1e3*this._viewer.getLength()).toUTCString().match(/(\d\d:\d\d:\d\d)/)[0]}).inject(r);h.addEvent("change",function(){var e=h.getValue();o._viewer.setCurrentTime(e),c.innerHTML=new Date(1e3*e).toUTCString().match(/(\d\d:\d\d:\d\d)/)[0],o._viewer.isPaused()?(o._viewer.pauseVideo(),g.setIcon("fonticon-play right")):(o._viewer.playVideo(),g.setIcon("fonticon-pause right"))});var u=new e.Element("div",{class:"_3DPlay-VideoControlBar-ChildContainer",styles:{display:"inline-block","margin-top":"3px"}});u.inject(this._uiContainer);var m=new e.Element("div",{styles:{display:"inline-block",margin:"-15px 0px 10px 10px"}}).inject(u),g=new s({id:"playPauseCmd",icon:"fonticon-pause  right"}).inject(m);g.addEvent("onClick",function(){o._viewer.isPaused()?(o._viewer.playVideo(),g.setIcon("fonticon-pause right")):(o._viewer.pauseVideo(),g.setIcon("fonticon-play right"))});var v=new e.Element("div",{styles:{display:"inline-block",margin:"-15px 0px 10px 10px"}}).inject(u),p=new s({icon:"fonticon-sound  right"}).inject(v);p.addEvent("onClick",function(){o._viewer.toggleAudio(),0==o._viewer.getVolume()?p.setIcon("fonticon-sound-off  right"):p.setIcon("fonticon-sound right")});var y=new e.Element("div",{styles:{display:"inline-block",width:"200px",margin:"-15px 0px -12px -10px"}}).inject(u),f=new n({minValue:0,maxValue:100,value:100,dynamicGaugeColor:!1,eventsList:[{label:"",value:0},{label:"",value:100}]}).inject(y);f.addEvent("change",function(){var e=f.getValue();0==e?p.setIcon("fonticon-sound-off  right"):p.setIcon("fonticon-sound right"),o._viewer.setVolume(e/100)}),this.setFadeAnimation(this._uiContainer,this._viewer.viewerContainer,"add"),this.videoTimeChangeToken=i.subscribe({event:"/3DPlay/VIDEO/TIME_CHANGE"},function(e){h.setValue(e.cTime,!1),c.innerHTML=new Date(1e3*o._viewer.getCurrentTime()).toUTCString().match(/(\d\d:\d\d:\d\d)/)[0]}),this.videoPlayingStateToken=i.subscribe({event:"/3DPlay/VIDEO/PLAYING"},function(e){g.setIcon("fonticon-pause right")}),this.videoPausedStateToken=i.subscribe({event:"/3DPlay/VIDEO/PAUSED"},function(e){g.setIcon("fonticon-play right")}),this.videoStoppedStateToken=i.subscribe({event:"/3DPlay/VIDEO/STOPPED"},function(e){g.setIcon("fonticon-play right")}),this.videoAnnotationStartToken=i.subscribe({event:"/3DPlay/ANNOTATIONVIDEO/STARTED"},function(e){o._uiContainer.style.display="none"}),this.videoAnnotationEndToken=i.subscribe({event:"/3DPlay/ANNOTATIONVIDEO/ENDED"},function(e){o._uiContainer.style.display=""}),this._togglePlayPauseOnSpace=function(e){e&&e.from[0]&&e.from[0].event&&(32===(e&&e.from[0]&&e.from[0].event).keyCode&&(o._viewer.isPaused()?(o._viewer.playVideo(),g.setIcon("fonticon-pause right")):(o._viewer.pauseVideo(),g.setIcon("fonticon-play right"))))},a.addEvent(document,"onKeyDown",this._togglePlayPauseOnSpace)},setFadeAnimation:function(e,t,n){var i=1,o=!0,a=[],s=function(){o=!0,i=1,e.setStyles({opacity:i}),a.length>0&&a.forEach(function(e){clearTimeout(e)});var t=setTimeout(function(){var t;o=!1,t=setInterval(function(){0==i||o?clearInterval(t):(i-=.1,e.setStyles({opacity:i}))},50)},2e3);a.push(t)},r=function(){t.addEventListener("mousemove",s),s()},l=function(){a.length>0&&(a.forEach(function(e){clearTimeout(e)}),a.splice(0,a.length),t.removeEventListener("mousemove",s))};"add"==n?(t.addEventListener("mousemove",s),e.addEventListener("mouseenter",l),e.addEventListener("mouseleave",r),s()):"remove"==n&&(t.removeEventListener("mousemove",s),e.removeEventListener("mouseenter",l),e.removeEventListener("mouseleave",r))},destroyUI:function(){this.videoPlayingStateToken&&(i.unsubscribe(this.videoPlayingStateToken),this.videoPlayingStateToken=null),this.videoPausedStateToken&&(i.unsubscribe(this.videoPausedStateToken),this.videoPausedStateToken=null),this.videoTimeChangeToken&&(i.unsubscribe(this.videoTimeChangeToken),this.videoTimeChangeToken=null),this.videoStoppedStateToken&&(i.unsubscribe(this.videoStoppedStateToken),this.videoStoppedStateToken=null),this.videoAnnotationStartToken&&(i.unsubscribe(this.videoAnnotationStartToken),this.videoAnnotationStartToken=null),this.videoAnnotationEndToken&&(i.unsubscribe(this.videoAnnotationEndToken),this.videoAnnotationEndToken=null),this.setFadeAnimation(this._uiContainer,this._viewer.viewerContainer,"remove"),a.removeEvent(this.viewer,"onKeyDown",this._togglePlayPauseOnSpace)}})}),define("DS/3DPlayVideoExperience/3DPlayVideoViewer",["UWA/Core","UWA/Class","DS/Logger/Logger","DS/CoreEvents/Events","DS/3DPlayAnnotationUtils/CanvasShapes","DS/WebUtils/Vector2","DS/WebUtils/ContextedSingleton","DS/WebappsUtils/WebappsUtils","DS/ApplicationFrame/CommandsManager","DS/WebSystem/BrowserInfos","UWA/String"],function(e,t,n,i,o,a,s,r,l,d,h){"use strict";var c;return t.extend({getNodes:function(){return[]},init:function(e){c=this,this.logger=n.getLogger("DS/3DPlay/Document"),this.logger.debug=this.logger.log,this.frameWindow=e.frmWnd,this.exp=e.exp,null===this.frameWindow._actionBar||void 0===this.frameWindow._actionBar||""===this.frameWindow._actionBar.elements.container.style.height?this.actionBarHeight=0:this.actionBarHeight=this.frameWindow._actionBar.elements.container.style.height,this.ctx=this.frameWindow.options.context,this.phaseProgress=e.phaseProgress,this._CreateViewer()},loadDocument:function(e,t){var n=e.asset;null==n&&(n={}),this.progressCB=t.loadFinished,this.progressErrorCB=t.loadError,t.loadStart();var o=this;require(["DS/DSVideoJS/DSVideoJS","DS/DSVideoJS/DSVideoResolutionSwitcherPlugin","DS/DSVideoJS/DSVideoThumbnailPlugin"],function(e,t,a){o.frameWindow.getViewer().type="video";var s,h=[],c=[],u=[],m=[],g={oncontextmenu:"return false;"},v="HD",p=!1;v="";if(n.swymAttr&&n.swymAttr.play&&n.swymAttr.play.av_streams){p=!0;for(var y=[],f=n.swymAttr.play.av_streams,w=0,C=f.length;w<C;w++){var D=f[w];y.push({file:D.transient_url,format:D.format,label:D.alias,default:"480p"===D.alias})}w=0;for(var P=y.length;w<P;w++)h.push({tag:"source",src:y[w].file,label:y[w].label,res:y[w].label,type:"video/"+n.format}),0===w&&(y[w].label,v=y[parseInt(P/2,10)-1].label);for(w=0,C=(u=n.swymAttr.play.subtitles).length;w<C;w++)c.push({tag:"track",kind:"subtitles",src:u[w]?u[w].transient_url:"",label:u[w]?u[w].alias:""});var A=n.swymAttr.play.preview_scans;const e=A.filter(e=>"jpg"===e.format),t=A.filter(e=>"vtt"===e.format),i=e.length>0;(i||t.length>0)&&(c.push({tag:"track",kind:"metadata",src:t[0].transient_url}),s=i?e[0].transient_url:(s=(s=t[0].transient_url.split("/")).slice(0,s.length-1)).join("/")+"/");for(w=0,C=(m=n.swymAttr.play.chapters).length;w<C;w++)c.push({tag:"track",src:m[w]?m[w].transient_url:"",kind:"chapters"})}else h.push({tag:"source",src:n.filename||n.url,label:"HD",res:"HD",type:"video/"+n.format});o.viewerContainer.clientHeight&&(g.height=o.viewerContainer.clientHeight+""),o._videoTag.setAttributes(g),o._videoTag.addContent(h),!0===p&&o._videoTag.addContent(c),o.myPlayer=videojs("VideotagContainer",{fluid:!0,controls:!0,autoplay:!0,preload:"auto",loop:!1,muted:!0,controlBar:{fullscreenToggle:!0,volumePanel:{inline:!1}},playsinline:!0,textTrackSettings:!1,plugins:!0===p?{thumbnails:{basePath:s},videoJsResolutionSwitcher:{default:v,dynamicLabel:!0}}:{}}),o.myPlayer.controlBar.el().style.zIndex=3;var b="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_AnnotationDrawsmall.png)",S=videojs.getComponent("Button"),T=videojs.extend(S,{constructor:function(){S.apply(this,arguments),this.controlText("Annotate"),this.el().style.backgroundImage=b,this.el().style.backgroundRepeat="no-repeat",this.el().style.backgroundPosition="center center"},handleClick:()=>{var e=o.exp.args.ctx;l.getCommands(e).AnnotationCommands&&(l.getCommands(e).AnnotationCommands.isRunning()?l.getCommands(e).AnnotationCommands.end():l.getCommands(e).AnnotationCommands.begin())},buildCSSClass:function(){return"vjs-control vjs-button"}});videojs.registerComponent("AnnotateButton",T),o.myPlayer.controlBar.addChild("AnnotateButton",{}),b="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_3DSHAREAnnotationTextsmall.png)";var E=videojs.extend(S,{constructor:function(){S.apply(this,arguments),this.controlText("AnnotateText"),this.el().style.backgroundImage=b,this.el().style.backgroundRepeat="no-repeat",this.el().style.backgroundPosition="center center"},handleClick:()=>{var e=o.exp.args.ctx;l.getCommands(e).AnnotationCommandsVideoText&&(l.getCommands(e).AnnotationCommandsVideoText.isRunning()?l.getCommands(e).AnnotationCommandsVideoText.end():l.getCommands(e).AnnotationCommandsVideoText.begin())},buildCSSClass:function(){return"vjs-control vjs-button"}});videojs.registerComponent("textAnnotateButton",E),o.myPlayer.controlBar.addChild("textAnnotateButton",{});var _=videojs.extend(S,{constructor:function(){S.apply(this,arguments),this.controlText("AnnotateTour"),this.el().style.backgroundImage="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_3DSHAREAnnotationToursmall_disable.png)",this.el().style.backgroundRepeat="no-repeat",this.el().style.backgroundPosition="center center"},handleClick:e=>{var t=o.exp.args.ctx;l.getCommands(t).AnnotationTour&&l.getCommands(t).AnnotationTour.isEnabled()&&(l.getCommands(t).AnnotationTour.isRunning()?(e.currentTarget?e.currentTarget.style.backgroundImage="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_3DSHAREAnnotationToursmall.png)":e.target&&(e.target.style.backgroundImage="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_3DSHAREAnnotationToursmall.png)"),l.getCommands(t).AnnotationTour.end()):(e.currentTarget?e.currentTarget.style.backgroundImage="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_3DSHAREAnnotationToursmall_active.png)":e.target&&(e.target.style.backgroundImage="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_3DSHAREAnnotationToursmall_active.png)"),l.getCommands(t).AnnotationTour.begin()))},buildCSSClass:function(){return"vjs-control vjs-button"}});videojs.registerComponent("annotateTourButton",_),o.myPlayer.controlBar.addChild("annotateTourButton",{});var x=videojs.extend(S,{constructor:function(){S.apply(this,arguments),this.controlText("VideoTour"),this.el().style.backgroundImage="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_3DSHAREtoursmall.png)",this.el().style.backgroundRepeat="no-repeat",this.el().style.backgroundPosition="center center"},handleClick:e=>{var t=o.exp.args.ctx;l.getCommands(t).VideoTour&&(l.getCommands(t).VideoTour.isRunning()?(e.currentTarget?e.currentTarget.style.backgroundImage="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_3DSHAREtoursmall.png)":e.target&&(e.target.style.backgroundImage="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_3DSHAREtoursmall.png)"),l.getCommands(t).VideoTour.end()):(e.currentTarget?e.currentTarget.style.backgroundImage="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_3DSHAREtoursmall_active.png)":e.target&&(e.target.style.backgroundImage="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_3DSHAREtoursmall_active.png)"),l.getCommands(t).VideoTour.begin()))},buildCSSClass:function(){return"vjs-control vjs-button"}});videojs.registerComponent("videoTourButton",x),o.myPlayer.controlBar.addChild("videoTourButton",{});var V=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},I=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},B=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},W=videojs.getComponent("MenuButton"),M=videojs.getComponent("Menu"),k=(videojs.getComponent("Component"),videojs.getComponent("MenuItem")),U=function(e){function t(n){return V(this,t),B(this,e.call(this,n,{}))}return I(t,e),t.prototype.createItems=function(){return[]},t.prototype.createMenu=function(){var e=new M(this.player_,{_VideoJsButtonClass:this});if(this.hideThreshold_=0,this.items=this.createItems(),this.items)for(var t=0;t<this.items.length;t++)e.addItem(this.items[t]);return e},t}(W),N=function(e){function t(t,n,i){var o=B(this,e.call(this,t,{label:n.label,selectable:!0,selected:n.selected||!1}));return o.item=n,o.shareMenu=i,o}return I(t,e),t.prototype.handleClick=function(){var e=o.exp.args.ctx;"shareAsDownload"==this.item.id?l.getCommands(e).ShareDownload&&(l.getCommands(e).ShareDownload.isRunning()?l.getCommands(e).ShareDownload.end():l.getCommands(e).ShareDownload.begin()):"shareAsSwym"==this.item.id&&l.getCommands(e).ShareTo3DSwYm&&(l.getCommands(e).ShareTo3DSwYm.isRunning()?l.getCommands(e).ShareTo3DSwYm.end():l.getCommands(e).ShareTo3DSwYm.begin())},t}(k),R=new U(o.myPlayer),L=o.myPlayer.controlBar.addChild(R);L.addClass("vjs-quality-selector"),b="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/SWXWebSharePicture20.png)",L.menuButton_.el().style.backgroundImage=b,L.menuButton_.el().style.backgroundRepeat="no-repeat",L.menuButton_.el().style.backgroundPosition="center center",L.removeClass("vjs-hidden");var O=new N(o.myPlayer,{id:"shareAsDownload",selected:!1,label:"Screenshot"},R),j=new N(o.myPlayer,{id:"shareAsSwym",selected:!1,label:"Swym"},R),H=[];H.push(O),H.push(j),R&&(R.createItems=function(){return H},R.update()),o.myPlayer.one("ready",o._ready.bind(o)),o.myPlayer.on("play",function(){o.exp.args.ctx;o.myPlayer.controls(!0)}),o.myPlayer.on("pause",function(){o.myPlayer.controls(!0)}),o.myPlayer.on("timeupdate",function(){if(o.myPlayer.controls(!0),0!=o.myPlayer.videoHeight()){null==o.canvas&&o._loadingDone();o.frameWindow.getActionBar();o.frameWindow.onActionBarReady(function(){var e=o._checkIfAnyRunningCmds();o.frameWindow.getViewerFrame().offsetHeight>240&&o.frameWindow.getViewerFrame().offsetWidth>240&&(o.frameWindow.getActionBar().hide(),e||(d.isMobile()||o.frameWindow.getActionBar().MAB&&!0===o.frameWindow.getActionBar().MAB.state.visible)&&o.frameWindow.getActionBar().MAB.showNone())});var e=o._checkIfAnyRunningCmds();o.frameWindow.getViewerFrame().offsetHeight>240&&o.frameWindow.getViewerFrame().offsetWidth>240&&(o.frameWindow.getActionBar().hide(),e||(d.isMobile()||o.frameWindow.getActionBar().MAB&&!0===o.frameWindow.getActionBar().MAB.state.visible)&&o.frameWindow.getActionBar().MAB.showNone()),i.publish({event:"/3DPlay/VIDEO/TIME_CHANGE",data:{cTime:o.myPlayer.currentTime()}}),o.myPlayer.ended()&&o.stopVideo()}})})},_ready:function(){this.progressCB()},_loadingDone:function(){var t=this;if(this.currentVolume=1,this.canvas=new e.Element("canvas",{id:"VideoCanvas",styles:{position:"absolute","pointer-events":"none",top:0,left:0}}).inject(document.getElementById("VideotagContainer")),this.onViewerResize=function(){var e=t._checkIfAnyRunningCmds();t.frameWindow.getViewerFrame().offsetHeight>240&&t.frameWindow.getViewerFrame().offsetWidth>240&&(t.frameWindow.getActionBar().hide(),e||(d.isMobile()||t.frameWindow.getActionBar().MAB&&!0===t.frameWindow.getActionBar().MAB.state.visible)&&t.frameWindow.getActionBar().MAB.showNone());var n=t.viewerContainer;t.myPlayer.isFullscreen()&&(n=t.getVideoContainer()),t.myPlayer.aspectRatio(n.clientWidth+":"+n.clientHeight);var o=n.clientWidth/t.myPlayer.videoWidth(),a=n.clientHeight/t.myPlayer.videoHeight();t.scale=Math.min(o,a);var r=t._computeCanvasDimensionsAndPosition(n,t.myPlayer);t.canvas.style.left=r.left+"px",t.canvas.style.top=r.top+"px",t.canvas.width=r.width,t.canvas.height=r.height;var l=s.get(t.ctx,"ANNOTATION_MANAGER");l&&l.drawShapes({cTime:t.getCurrentTime()}),i.publish({event:"/3DPlay/VIDEO/RESIZE",data:{}})},this.viewerContainer.addEvent("resize",this.onViewerResize),this.onViewerResize(),this.enableTouchEvents(),d.isMobile()||this.enableCATIAEvents(),t.fps=20,t._videoTag.requestVideoFrameCallback){let e=0,n=0;const i=(o,a)=>{0===n&&(n=o);const s=(++e/((o-n)/1e3)).toFixed(3);t.fps=isFinite(s)?s:0,console.log(t.fps),e<60&&t._videoTag.requestVideoFrameCallback(i)};t._videoTag.requestVideoFrameCallback(i)}},_computeCanvasDimensionsAndPosition:function(e,t){var n=t.videoWidth()/t.videoHeight(),i=e.clientWidth/e.clientHeight,o=0,a=0,s=0,r=0;return i==n?(o=e.clientWidth,a=e.clientHeight):i>n?(o=(a=e.clientHeight)*n,s=(e.clientWidth-o)/2,r=0):i<n&&(a=(o=e.clientWidth)/n,s=0,r=(e.clientHeight-a)/2),{height:a,left:s,top:r,width:o}},_loadingFailed:function(){this.progressErrorCB()},_CreateViewer:function(){this.viewerContainer=e.Element("div"),this.viewerContainer.setAttribute("id","PlayWebDocScreen"),this.viewerContainer.setAttribute("style","width:100%;height:100%;");var t=this.frameWindow.getViewerFrame();t.appendChild(this.viewerContainer),this._videoTag=new e.Element("video",{id:"VideotagContainer",class:"video-js vjs-big-play-centered"}),this._videoTag.inject(this.viewerContainer)},getViewerPositionFromMouse:function(e){var t=this.viewerContainer.getBoundingClientRect(),n=e.x-t.left,i=e.y-t.top;return n>0&&i>0&&n<this.currentWidth&&i<this.currentHeight&&{x:n/=this.scale,y:i/=this.scale}},getContainer:function(){return this.viewerContainer},getVideoContainer:function(){var e=document.getElementById("VideotagContainer");return e.addClassName||(e.addClassName=function(t){return e.hasClassName.call(this,t)||this.setClassName(this,(this.getClassName(this).trim()+" "+t).trim()),this}),e.removeClassName||(e.removeClassName=function(e){return this.setClassName(this,this.getClassName(this).replace(new RegExp("(^|\\s)"+e+"(?:\\s|$)"),"$1").trim()),this}),e.setClassName||(e.setClassName=function(e,t){"string"==typeof e.className?e.className=t:e.setAttribute("class",t)}),e.hasClassName||(e.hasClassName=function(e){var t=this.getClassName(this);return Boolean(t&&h.contains(t,e," "))}),e.getClassName||(e.getClassName=function(e){var t="string"==typeof e.className?e.className:e.getAttribute("class");return t||""}),e},deactivateCommandButton:function(e){if(this.myPlayer&&this.myPlayer.controlBar)for(var t=this.myPlayer.controlBar.children(),n=0;n<t.length;n++)if(t[n].controlText&&t[n].controlText()==e){var i=t[n].el();i&&("AnnotateTour"==e?i.style.backgroundImage="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_3DSHAREAnnotationToursmall.png)":"VideoTour"==e&&(i.style.backgroundImage="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_3DSHAREtoursmall.png)"));break}},enabledisableCommandButton:function(e,t){if(this.myPlayer&&this.myPlayer.controlBar)for(var n=this.myPlayer.controlBar.children(),i=0;i<n.length;i++)if(n[i].controlText&&n[i].controlText()==e){var o=n[i].el();o&&"AnnotateTour"==e&&("enable"==t?o.style.backgroundImage="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_3DSHAREAnnotationToursmall.png)":"disable"==t&&(o.style.backgroundImage="url("+r.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_3DSHAREAnnotationToursmall_disable.png)"));break}},getViewerContainer:function(){return this.viewerContainer},getCanvas:function(){return this.canvas},getVideo:function(){return this._videoTag},getLength:function(){return this.myPlayer.duration()},getCurrentTime:function(){return this.myPlayer.currentTime()},setCurrentTime:function(e){this.myPlayer.currentTime(e)},isPaused:function(){return this.myPlayer.paused()},isFullscreen:function(){return this.myPlayer.isFullscreen()},playVideo:function(){this.myPlayer&&(this.myPlayer.play(),i.publish({event:"/3DPlay/VIDEO/PLAYING",data:{}}))},pauseVideo:function(){this.myPlayer&&(this.myPlayer.pause(),i.publish({event:"/3DPlay/VIDEO/PAUSED",data:{}}))},stopVideo:function(){this.myPlayer&&(this.myPlayer.currentTime(0),this.myPlayer.pause(),i.publish({event:"/3DPlay/VIDEO/STOPPED",data:{}}))},hideVideoControl:function(){this.myPlayer&&this.myPlayer.controlBar.hide()},showVideoControl:function(){this.myPlayer&&this.myPlayer.controlBar.show()},setVolume:function(e){},getVolume:function(){},toggleAudio:function(){},translateToViewerPosition:function(e){var t=this.canvas.getBoundingClientRect();if(this._isPointerInAnnotationDrawingSpace(e)){var n=(e.x-t.left)/this.scale,i=(e.y-t.top)/this.scale;return new a(n,i)}return!1},_isPointerInAnnotationDrawingSpace:function(e){if(this.canvas){var t=this.canvas.getBoundingClientRect(),n=e.x>=t.left&&e.x<=t.left+t.width,i=e.y>=t.top&&e.y<=t.top+t.height;return n&&i}},drawShapes:function(e){this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height);var t=e.shapeList.alphaVal;for(var n in e.shapeList)if("alphaVal"!=n){var i=e.shapeList[""+n],a=t[""+n];o.drawShape({shape:i,canvas:this.canvas,scale:this.scale,transparency:a,editMode:e.shapeList[""+n].editMode})}},drawShapeForErase:function(e){for(var t=e.shapeList,n=0;n<t.length;++n){var i=t[n];o.drawShape({shape:i,canvas:this.canvas,scale:this.scale,lowLightMode:e.lowLightMode})}},drawPreview:function(e){if(e.canvas||this.canvas){var t;if(e.canvas?t=e.canvas.getContext("2d"):this.canvas&&(t=this.canvas.getContext("2d")),e.startPoint&&e.endPoint){t.beginPath();var n=e.startPoint.x*this.scale,i=e.startPoint.y*this.scale,o=e.endPoint.x*this.scale,a=e.endPoint.y*this.scale;t.moveTo(n,i),t.lineTo(o,a),t.stroke()}else if(e.viewerPoints){var s=e.viewerPoints.length;t.moveTo(e.viewerPoints[0].x*this.scale,e.viewerPoints[0].y*this.scale);for(var r=1;r<s;++r)t.lineTo(e.viewerPoints[r].x*this.scale,e.viewerPoints[r].y*this.scale)}t.stroke()}},drawPreviewWithShapeData:function(e){this.canvas&&e.shapeData&&o.drawShape({shape:JSON.parse(JSON.stringify(e.shapeData)),canvas:this.canvas,scale:this.scale})},enableCATIAEvents:function(){this.onmousedown=this.onMouseDown.bind(this),this.onmousemove=this.onMouseMove.bind(this),this.onmouseup=this.onMouseUp.bind(this),this.getVideoContainer().addEventListener("mousedown",this.onmousedown,!0),this.getVideoContainer().addEventListener("mousemove",this.onmousemove,!0),this.getVideoContainer().addEventListener("mouseup",this.onmouseup,!0)},disableCATIAEvents:function(){this.getVideoContainer().removeEventListener("mousedown",this.onmousedown,!0),this.getVideoContainer().removeEventListener("mousemove",this.onmousemove,!0),this.getVideoContainer().removeEventListener("mouseup",this.onmouseup,!0)},enableTouchEvents:function(){this.ontouchstart=this.onTouchStart.bind(this),this.ontouchmove=this.onTouchMove.bind(this),this.ontouchend=this.onTouchEnd.bind(this),this.getVideoContainer().addEventListener("touchstart",this.ontouchstart,!0),this.getVideoContainer().addEventListener("touchmove",this.ontouchmove,!0),this.getVideoContainer().addEventListener("touchend",this.ontouchend,!0)},disableTouchEvents:function(){this.getVideoContainer().removeEventListener("touchstart",this.ontouchstart,!0),this.getVideoContainer().removeEventListener("touchmove",this.ontouchmove,!0),this.getVideoContainer().removeEventListener("touchend",this.ontouchend,!0)},onMouseDown:function(e){var t=this._checkIfAnyRunningCmds();if(0===e.button){if(1==this.launchAnnotationEdition(e))e.stopPropagation();else if(t){var n=new a(e.clientX,e.clientY);this._isPointerInAnnotationDrawingSpace(n)||e.stopPropagation()}}},onMouseMove:function(e){},onMouseUp:function(e){},onTouchStart:function(e){var t=this._checkIfAnyRunningCmds();if(this.touchClientX=e.touches[0].clientX,this.touchClientY=e.touches[0].clientY,this.touchPositions=[],1===e.touches.length){var n={x:e.touches[0].clientX,y:e.touches[0].clientY};if(this.touchPositions.push(n),1==this.launchAnnotationEdition({clientX:e.touches[0].clientX,clientY:e.touches[0].clientY}))e.stopPropagation();else if(t){var i=new a(e.touches[0].clientX,e.touches[0].clientY);this._isPointerInAnnotationDrawingSpace(i)}}},onTouchMove:function(e){if(1===e.touches.length){e.preventDefault();var t={x:e.touches[0].clientX,y:e.touches[0].clientY};this.touchPositions.push(t)}},onTouchEnd:function(e){this.touchPositions;0===e.touches.length&&1===e.changedTouches.length&&this.touchPositions.length>1&&(this.touchPositions=[])},_checkIfAnyRunningCmds:function(){var e=!1,t=l.getCommands(this.frameWindow.experience.ctx);if(t)for(var n=Object.keys(t),i=0;i<n.length;i++){var o=n[i];if("myDefaultCmd"!=o){var a=t[o];if(a&&a.isRunning()){e=!0;break}}}return e},launchAnnotationEdition:function(e){var t=!1,n=this._checkIfAnyRunningCmds(),i=new a(e.clientX,e.clientY),o=this.translateToViewerPosition(i);if(o&&0==n&&this.frameWindow.getViewerFrame().offsetHeight>240&&this.frameWindow.getViewerFrame().offsetWidth>240){var s=this.getUnderneathAnnotations(o);if(s&&s.annotIDDelList&&s.annotIDDelList.length){s.annotIDDelList;t=!0;var r=s.annotationData,d=this.frameWindow.experience.ctx;r&&"text"==r.type?(this.shapeEditionData={point:i},l.getCommands(d).AnnotationCommandsVideoText&&l.getCommands(d).AnnotationCommandsVideoText.begin()):(this.shapeEditionData={point:i},l.getCommands(d).AnnotationCommandsVideoEditShape&&l.getCommands(d).AnnotationCommandsVideoEditShape.begin())}}return t},getUnderneathAnnotations:function(e){var t,n,i=[],r=[],l=[],d=[],h=s.get(this.ctx,"ANNOTATION_MANAGER");if(e&&h){var c=h.getAllAnnotationwithCurrTime({currTime:this.getCurrentTime()});for(var u in c)if("alphaVal"!=u){var m=o.isOverlapShape({shape:c[u],point:{x:e.x,y:e.y},scale:this.scale,shapeList:c,thickness:c[u].graphicalProp.thickness});if(m){var g=h.getAnnotationInformation({annotID:m});g&&(i.push(m),r.push(g.shape),l.push(g.bbox),d.push(g.dataPoints))}}}if(0<i.length){for(var v,p=0,y=0;y<i.length;y++){var f=0;if(d[y].length){for(var w=0;w<d[y].length;w++){var C=new a(d[y][w].x,d[y][w].y);f+=e.distanceTo(C)}f/=d[y].length}0===y?(v=f,p=0):f<v&&(v=f,p=y)}i=[i[p]],t=r[p],n=l[p]}return{annotationData:t,annotIDDelList:i,bBox:n}},dispose:function(){this.disableCATIAEvents(),this.disableTouchEvents();var e=s.get(c.ctx,"ANNOTATION_MANAGER");e&&(e.dispose(),s.remove(c.ctx,"ANNOTATION_MANAGER")),this.myPlayer&&(this.myPlayer.dispose(),c.myPlayer=void 0),this.viewerContainer.removeEvent("resize",this.onViewerResize),this.viewerContainer&&this.frameWindow.getViewerFrame().removeChild(this.viewerContainer),this.frameWindow&&(this.frameWindow.getViewer=void 0),this.exp=null,this._videoTag=null,this.canvas=null,this.viewerContainer=null}})}),define("DS/3DPlayVideoExperience/3DPlayVideoExperience",["DS/3DPlayExperienceModule/3DPlayExperience","DS/3DPlay/3DPlay","DS/WebSystem/Nls","DS/3DPlayVideoExperience/3DPlayVideoViewer","DS/3DPlayVideoExperience/3DPlayVideoControls","DS/ApplicationFrame/FrameWindow","DS/WebUtils/ContextedSingleton","DS/3DPlayVideoAnnotation/AnnotationManager","DS/3DPlayUtils/PanelManager","DS/3DPlayAnnotationUtils/CanvasShapes","DS/WebSystem/App","DS/WebInfraUI/MobileActionBar","i18n!DS/3DPlay/assets/nls/3DPlay"],function(e,t,n,i,o,a,s,r,l,d,h,c,u){"use strict";return e.extend({init:function(e){this._parent(e),this.viewer=void 0,(e=e||{}).FrameWindow=a,e.workbenchs=[],e.workbenchs.unshift({name:"3DPlayVideoViewer",module:"3DPlayVideoExperience"}),this._iOS?e.workbenchs.push({name:"3DPlayShare_iOS",module:"3DPlay"}):e.workbenchs.push({name:"3DPlayShare",module:"3DPlay"}),h.is3DPlay()&&e.workbenchs.push({name:"RightPanel",module:"3DPlay2DExperience"})},onPreCreate:function(){var e;(this._parent(),this.tabletMabModel={speeddial:[{id:"AnnotationCommands",rsc:"3DPlay/3DPlayExperience3D"},{id:"AnnotationTour",rsc:"3DPlay/3DPlayExperience3D"},{id:"Share",icon:"3DPlay/assets/icons/32/I_3DSHAREShare.png",flyout:[]}],sections:[]},this.mabModel={speeddial:[{id:"AnnotationCommands",rsc:"3DPlay/3DPlayExperience3D"},{id:"AnnotationTour",rsc:"3DPlay/3DPlayExperience3D"},{id:"Share",icon:"3DPlay/assets/icons/32/I_3DSHAREShare.png",flyout:[]}],sections:[]},h.is3DPlay()&&(this.tabletMabModel.sections.push({id:"RightSidePanel",rsc:"PADUtils/PADUtils",nls:"PADUtils/PADUtils"}),this.mabModel.sections.push({id:"RightSidePanel",rsc:"PADUtils/PADUtils",nls:"PADUtils/PADUtils"})),this._iOS)?((e=this.tabletMabModel.speeddial.filter(function(e){return"Share"===e.id}))&&(e[0].flyout=[{id:"ShareTo3DSwYm",rsc:"3DPlay/3DPlay"},{id:"SharePrint",rsc:"3DPlay/3DPlay"}]),this.mabModel.speeddial[2].flyout=[{id:"ShareTo3DSwYm",rsc:"3DPlay/3DPlay"},{id:"SharePrint",rsc:"3DPlay/3DPlay"}]):((e=this.tabletMabModel.speeddial.filter(function(e){return"Share"===e.id}))&&(e[0].flyout=[{id:"ShareTo3DSwYm",rsc:"3DPlay/3DPlay"},{id:"ShareDownload",rsc:"3DPlay/3DPlay"},{id:"SharePrint",rsc:"3DPlay/3DPlay"}]),this.mabModel.speeddial[2].flyout=[{id:"ShareTo3DSwYm",rsc:"3DPlay/3DPlay"},{id:"ShareDownload",rsc:"3DPlay/3DPlay"},{id:"SharePrint",rsc:"3DPlay/3DPlay"}])},computeViewerStats:function(){return this.viewer&&this.viewer.loader?this.viewer.loader.stats:{}},postCreate:function(){},createDom:function(e,t){this._parent(e),this.viewer&&(this.viewer.dispose(),this.viewer=void 0),this.viewer=new i({phaseProgress:this.getPhaseProgress(),frmWnd:this.frmWindow,exp:this});var n=this.viewer;this.frmWindow.getViewer=function(){return n},t&&t.apply(this)},_onModelLoadingCompleted:function(){var e;this.getMABContainer&&(e=this.getMABContainer());var t=this.frmWindow.getActionBar();t&&this.mabModel&&(t.MAB&&t.MAB.dispose(),this.tabletMabModel?t.MAB=new c({ctx:this.ctx,frameWnd:this.frmWindow,exp:this,actionBar:t,model:this.mabModel,actionBarContainer:e,modelTablet:this.tabletMabModel,panelManager:this.PanelManager,alwaysOn:this._iOS||this._android||window.WinJS&&Environment.isSet("3DPlay.MabWin10"),ios:this._iOS,pdf:this.isCurrentDocumentPDF,actionBarBlackout:!0,video:!0}):t.MAB=new c({ctx:this.ctx,frameWnd:this.frmWindow,exp:this,actionBar:t,model:this.mabModel,actionBarContainer:e,panelManager:this.PanelManager,alwaysOn:this._iOS||this._android||window.WinJS&&Environment.isSet("3DPlay.MabWin10"),ios:this._iOS,pdf:this.isCurrentDocumentPDF,actionBarBlackout:!0,video:!0})),this._parent()},testBrowser:function(){return BrowserSupport.ok},loadAsset:function(e,t){this.annotationManager=s.get(this.args.ctx,"ANNOTATION_MANAGER"),this.annotationManager||(this.annotationManager=new r({frameWindow:this.frmWindow}),s.add(this.args.ctx,"ANNOTATION_MANAGER",this.annotationManager)),this.PanelManager.createTopMenu({ctx:this.args.ctx,container:this.frmWindow.getUIFrame(),experience:this,showBubbleMenu:this.args.options.showBubbleMenu}),this.PanelManager.createDefaultHelp();var n=this;if(this.loadingCompletedToken=this.subscribe("ASSET/LOADINGFINISHED/",function(){n.unsubscribe(n.loadingCompletedToken),n=void 0}),this.args&&this.args.ctx){this.args.ctx;this.modelName="video",this.viewer.loadDocument(e,{loadFinished:this.onModelLoadingCompleted,loadProgress:this.onModelLoadingProgression,loadStart:this.onModelLoadingStarted,loadError:this.onModelLoadingError,clearScene:!0})}},getScreenShot:function(e){var t=this.frmWindow.getViewer();!1===t.isPaused()&&t.pauseVideo();var n=t.getCanvas(),i=t.getVideo(),o={data:null,width:n.width,height:n.height},a=document.createElement("canvas");a.width=e.width?e.width:o.width,a.height=e.height?e.height:o.height,a.getContext("2d").drawImage(i,0,0,a.width,a.height);var s=this.annotationManager.getAllAnnotationwithCurrTime({currTime:t.getCurrentTime()}),r=s.alphaVal;for(var l in s)if("alphaVal"!==l){var h=s[""+l],c=r[""+l];d.drawShape({shape:h,canvas:a,scale:t.scale,transparency:c})}var u=e.type?"image/"+e.type:"png";"jpeg"===e.type?a.toBlob(function(t){e.onSuccess(t)},"image/jpeg"):e.onSuccess(a.toDataURL(u))},getMABContainer:function(){if(this.viewer)return this.viewer.getVideoContainer()},getIfToDealyMABCreation:function(){return!0},dispose:function(){if(t.endAllCommands({ctx:this.ctx,resetDefaultCmd:!0}),void 0!==this.frmWindow){var e=this.frmWindow.getViewer();void 0!==e&&void 0!==e.dispose&&e.dispose()}this._videoControl&&this._videoControl.destroyUI(),this._videoControl=null,this.annotationManager&&(s.remove(this._ctx,"ANNOTATION_MANAGER"),this.annotationManager=void 0),this.publish("3DPLAY/EXPERIENCE2D/DISPOSE",{ctx:this.args.ctx}),this._parent()}})});