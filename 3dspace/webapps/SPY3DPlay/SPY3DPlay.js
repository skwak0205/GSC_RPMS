define("DS/SPY3DPlay/Publish",["DS/3DPlay/3DPlay","UWA/Class","DS/WebSystem/Environment","DS/Notifications/NotificationsManagerUXMessages","i18n!DS/3DPlay/assets/nls/3DPlay","i18n!DS/SPY3DPlay/assets/nls/Publish","i18n!DS/SPY3DPlay/assets/nls/PublishFeedbacks"],function(e,t,i,s,n,o,r){"use strict";return t.extend({_getServerToken:function(e){var t=this._urlSwym+"/api/index/tk",i={method:"GET",type:"json",onComplete:function(t){t&&t.result&&t.result.ServerToken?e.onComplete(t.result.ServerToken):e.onFailed&&e.onFailed()},onFailure:e.onFailed};this._wafData.authenticatedRequest(t,i)},_upload:function(e){var t=this._urlSwym+"/api/media/add",i=new FormData;i.append("userFile",e.file,e.filename),i.append("published",1),i.append("title",e.name),i.append("community_id",this._communityId),this._publishForm&&"media"!==this._publishForm._currentType&&i.append("is_illustration","true");var s={method:"POST",type:"json",headers:{"X-DS-SWYM-CSRFTOKEN":e.serverToken},data:i,onComplete:function(t){t.errorcode&&e.onFailed&&e.onFailed(t),this._mediaId=t.result.id,this._publishForm.addEvent("ContentCreated",function(t){var i=JSON.parse(t);i&&i.success?e.onComplete(i):e.onFailed(i)},!1);var i=this._publishForm.getControl("descriptionInput").getValue();this._publishForm.setContentDescription(i),this._publishForm.createContent(this._mediaId)}.bind(this),onFailure:function(t,i,s){if(e.onFailed){var n={error:t,response:i,headers:s};e.onFailed(n)}}};this._wafData.authenticatedRequest(t,s)},_getModal:function(){return!this._modal&&this._modalConstruct&&(this._modal=new this._modalConstruct({closable:!0,className:"publishSwymPanel_3DPlay"}),this._modal.inject(document.body),this._modal.show()),this._modal},_close:function(){this._publishTypeForm&&(this._publishTypeForm.destroy(),this._publishTypeForm=void 0),this._publishForm&&(this._publishForm.destroy(),this._publishForm=void 0),this._modal&&(this._modal.destroy(),this._modal=void 0)},_closeWithSuccess:function(e){var t={level:"success",title:r.publishSucceeded,subtitle:""};e&&e.containerType&&(t.message=r[e.containerType+"MediaProcessing"]),s.addNotif(t),this._close()},_closeWithError:function(e){var t={level:"error",title:r.publishFailed,subtitle:r.unknownError};if(e&&(console.warn(" 3DPlay could not publish - error:",e),e.response&&e.response.errorcode))switch(e.response.errorcode){case"ERROR_FILE_SIZE_EXCEEDED":t.subtitle=r.sizeExceededSubtitle,t.message=r.sizeExceededMsg}s.addNotif(t),this._close()},init:function(t,i){if(this._ctx=t.ctx,this._experience=e.getExperience(t.ctx),this._experience){var s=this._experience.args.input.tenantID||this._experience.args.input.asset.tenant;s&&(this._idSwym=s);require(["DS/UIKIT/Modal","DS/SwymPublishForm/script/publish-form-view","DS/WAFData/WAFData","css!DS/3DPlayUtils/PublishToSwym"],function(e,t,i){this._wafData=i,this._modalConstruct=e,this._publishFormViewConstruct=t,this._experience.getScreenShot&&(this._experience.getExperienceMedia&&this._experience.getExperienceMediaMeta?this.preparePublishTypeSelection({onCancel:function(){this._close()}.bind(this),onNext:function(e){if(e)switch(e){case"screenshot":this._close(),this.publishScreenshot();break;case"simulationMedia":this._close(),this.publishMedia();break;default:this._close()}}.bind(this)}):this.publishScreenshot())}.bind(this),function(t){if("scripterror"===t.requireType){var i=t.requireModules.join(",");console.error("3DPlay ScripNotFoundError: ",i)}else console.error(t);e.sendEvent(this._ctx,eventType.notif,notification.error,{msg:n.ScripNotFoundError})}.bind(this))}},publishScreenshot:function(){this._experience&&this._experience.getScreenShot({onSuccess:function(e){if(i.isSet("ODT_3DPlay_PanelManager"))require(["DS/CoreEvents/Events"],function(e){e.publish({event:i.get("ODT_3DPlay_PanelManager")})});else{var t=function(t){var i={title:t.title,description:t.description,mode:"base64",base64image:e,onCancel:this._close.bind(this),onContentCreated:this._close.bind(this)};this._idSwym&&(i.platformId=this._idSwym),this._publishForm=new this._publishFormViewConstruct(i),this._publishForm.setContentTitle(t.title),this._publishForm.setContentDescription(t.description);var s=this._getModal();s&&(s.setHeader("<h4>"+n.ShareSwymTitle+"</h4>"),s.setBody(this._publishForm.render("publish_to_sywm_wrapper_id")))}.bind(this);this._experience.getPublishingInfo?this._experience.getPublishingInfo({onComplete:function(e){t(e)}}):t({title:"title",description:"description"})}}.bind(this),onFail:function(){NLS.nls("3DPlay/3DPlay","UnableToCreateScreenshot",function(t){e.sendEvent(this._ctx,eventType.notif,notification.error,{msg:t})})}})},prepareMediaPublish:function(e){var t=function(t){this._publishForm=new this._publishFormViewConstruct({mode:"jsevent"}),this._publishForm.setContentTitle(t.title),this._publishForm.setContentDescription(t.description);var i=this._getModal();i&&(i.setHeader("<h4>Publish "+e.mediaData.typeName+"</h4>"),i.setBody(this._publishForm.render("publish_to_sywm_wrapper_id"))),this._publishForm.addEvent("CancelShare",function(){e.onCancel()},!1),this._publishForm.addEvent("StartUpload",function(t){var i=JSON.parse(t);this._communityId=i.community_id,this._urlSwym=i.platform_instance,e.onPublish()}.bind(this),!1),this._publishForm.render()}.bind(this);this._experience.getPublishingInfo?this._experience.getPublishingInfo({onComplete:function(e){t(e)}}):t({title:"title",description:"description"})},publishMedia:function(){this._experience.getExperienceMediaMeta(function(e){this.prepareMediaPublish({mediaData:e,titlePrefix:o.publishMediaTitlePrefix,onPublish:function(){this._experience.getExperienceMedia({onComplete:function(t){this._getServerToken({onComplete:function(i){this._upload({serverToken:i,file:t,filename:e.name+"."+e.format,name:e.name,onComplete:function(e){this._closeWithSuccess(e)}.bind(this),onFailed:function(e){this._closeWithError(e)}.bind(this)})}.bind(this),onFailed:function(e){this._closeWithError(e)}.bind(this)})}.bind(this),onFailed:function(e){this._close(e)}.bind(this),onProgress:function(){}})}.bind(this),onCancel:function(){this._close()}.bind(this)})}.bind(this))},preparePublishTypeSelection:function(e){e&&e.onNext&&e.onCancel&&require(["DS/SPY3DPlay/PublishTypeFormView","DS/WebappsUtils/WebappsUtils","i18n!DS/SPY3DPlay/assets/nls/PublishTypeFormView"],function(t,i,s){this._publishTypeForm=new t({types:{media3d:{id:"simulationMedia",nls:s.simulationMedia,icon:i.getWebappsBaseUrl()+"SPY3DPlay/assets/icons/I_PublishSimulationMedia.svg"},screenshot:{id:"screenshot",nls:s.screenshot,icon:i.getWebappsBaseUrl()+"SPY3DPlay/assets/icons/I_PublishScreenshot.svg"}},onNext:e.onNext,onCancel:e.onCancel,onReady:function(){var e=this._getModal();e&&(e.setHeader("<h4>"+s.publishModalTitle+"</h4>"),e.setBody(this._publishTypeForm.render("publish_to_sywm_wrapper_id")))}.bind(this)})}.bind(this))}})}),define("DS/SPY3DPlay/PublishTypeFormView",["UWA/Class"],function(e){"use strict";return e.extend({destroy:function(){this._internalForm&&this._internalForm.destroy()},render:function(e){return this._internalForm?this._internalForm.render(e):null},init:function(e){require(["DS/SwymUICore/script/lib/view/generic/swym-view","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Button","i18n!DS/SPY3DPlay/assets/nls/PublishTypeFormView","css!SwymPublishForm/SwymPublishForm","css!DS/SPY3DPlay/PublishTypeFormView"],function(t,i,s,n){var o=t.extend({name:"publish-type-form-view",_createSelector:function(e){e&&(e.media3d&&(this._media3dButton=this.addControl("media3d",new s({className:"btn-image",value:""})),this._media3dButton.elements.content.style.backgroundImage="url("+e.media3d.icon+")",this._media3dButton.addEvent("onClick",this._onMedia3dButtonClick.bind(this)),this._media3dToggle=this.addControl("media3dToggle",new i({name:"publishType",value:e.media3d.id,className:"primary checked",label:e.media3d.nls,checked:!0})),this._media3dToggle.addEvent("onChange",this._onMedia3dToggleChange.bind(this)),this._selectedTypeId=e.media3d.id),e.screenshot&&(this._screenshotButton=this.addControl("screenshot",new s({className:"btn-image",value:""})),this._screenshotButton.elements.content.style.backgroundImage="url("+e.screenshot.icon+")",this._screenshotButton.addEvent("onClick",this._onScreenshotButtonClick.bind(this)),this._screenshotToggle=this.addControl("screenshotToggle",new i({name:"publishType",value:e.screenshot.id,className:"primary",label:e.screenshot.nls})),this._screenshotToggle.addEvent("onChange",this._onScreenshotToggleChange.bind(this))))},_onScreenshotButtonClick:function(){this._screenshotToggle.setCheck(!0),this._screenshotToggle.dispatchOnChange()},_onMedia3dButtonClick:function(){this._media3dToggle.setCheck(!0),this._media3dToggle.dispatchOnChange()},_onScreenshotToggleChange:function(){this._screenshotToggle.isChecked()&&(this._screenshotToggle.elements.container.classList.add("checked"),this._media3dToggle.elements.container.classList.remove("checked"),this._selectedTypeId=this._config.types.screenshot.id)},_onMedia3dToggleChange:function(){this._media3dToggle.isChecked()&&(this._media3dToggle.elements.container.classList.add("checked"),this._screenshotToggle.elements.container.classList.remove("checked"),this._selectedTypeId=this._config.types.media3d.id)},_createContent:function(){var e=this;return{class:"publish-form",html:[{class:"publish-form-body",html:[{class:"thread-selector-cnt",html:[{class:"image-toggle-cnt",html:[e.getControl("media3d"),e.getControl("media3dToggle")]},{class:"image-toggle-cnt",html:[e.getControl("screenshot"),e.getControl("screenshotToggle")]}]}]},{class:"footer-cnt",html:[{class:"button-cnt",html:[e.addControl("cancelButton",new s({className:"cancel-share-button default",value:n.cancel,events:{onClick:function(){e._config.onCancel?e._config.onCancel():e.hide()}}}))]},{class:"button-cnt",html:[e.addControl("nextButton",new s({className:"next-share-button primary",value:n.next,events:{onClick:function(){e._config.onNext&&e._config.onNext(e._selectedTypeId)}}}))]}]}]}},setup:function(e){return this._config=e,this._parent.apply(this,arguments),this._createSelector(e.types),this}});this._internalForm=new o(e),e&&e.onReady&&e.onReady()}.bind(this))}})}),define("DS/SPY3DPlay/CmdPublish",["DS/WebSystem/Environment","DS/3DPlayCommands/CmdShareBase","DS/SPY3DPlay/Publish"],function(e,t,i){"use strict";return t.extend({shareWithPanelManager:function(){new i({ctx:this._ctx})}})});