define("DS/SceneGraphTree/SceneGraphTree",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/SceneGraph","DS/Controls/Tree","DS/Controls/TreeNode","DS/Controls/Tile","DS/CoreEvents/Events"],function(e,t,n,r,i,o,l,s){"use strict";var a=r.getWebappsAssetUrl("Visualization","icons/"),d=function(){if(!this.isExpanded()){var e,t=this.getChildren().length?this.getNthChild(0):null,n=this.options.tree.options.viewer;if(t&&"__dummy__"===t.options.label){this.removeChildren();var r=this.options.pathElement;if(r.getLastElement()instanceof i){var o=r._getUniqueOccurrence(n);if(!o)return;for(s=0;s<o.children.length;s++){var l=o.children[s];if(l.node.getVisibilityInTree()){var s,h=l.node._occurrences,c="",p=l.node._iconInTree?l.node._iconInTree:a+"SWXUiConvertEntitiesHeader.png";if(l.node.isInstance()){for(e=0;e<h.length&&h[e]!==l;e++);c=" (inst_"+e+")"}var u=r.clone();u.addElement(l.node);var g=l.node.name+c;""===g&&(g="-");var v=new WUX.Controls.TreeNode({backgroundColor:"rgba(255, 255,255,0.5)",label:g,pathElement:u,icons:[p],renderSaver:0});if(this.addChild(v),l._getVisible()?v.options.UI=this.getTree().options.UI:v.options.UI=UWA.extend(UWA.clone(this.getTree().options.UI,"false"),{label:{filter:"grayscale(100%)",opacity:.3}}),l.children.length){var _=new WUX.Controls.TreeNode({label:"__dummy__"});v.addChild(_),v.onPreExpand(d)}}}}}}},h=e.extend({init:function(e,n){var r={viewer:n};this.tree=new WUX.Controls.Tree(r),this.tree.inject(document.body);var i=this;return this.toUnsubscribe=t.subscribe({event:"/VISU/onSceneGraphUpdate"},function(e){if(i._sg){var t,n,r=e.fromNode,o=e.toNode,s=[];for(t=0;t<r._occurrences.length;t++){var h=r._occurrences[t];(p=new l).setFromOccurrence(h),p&&s.push(p)}var c=[];for(t=0;t<s.length;t++){var p=s[t];(g=i.getTreeNode(p))&&c.push(g)}var u=[];for(t=0;t<c.length;t++){var g=c[t];if(o){var v=g.getChildren(),_=v&&v.length?g.getNthChild(0):null;if(!_||"__dummy__"!==_.options.label)if(v){var E=g.getPathElement?g.getPathElement():null;if(!E&&g.options&&g.options.pathElement&&(E=g.options.pathElement),"REMOVE"===e.eventType||"REMOVETREE"===e.eventType){var f=g.getChildren().length;for(n=0;n<f;n++){var m=g.getNthChild(n);if(m.getPathElement())m.getPathElement().getLastElement()===o&&u.push({fromNode:g,toNode:m})}}else if(("ADD"===e.eventType||"ADDTREE"===e.eventType)&&o.getVisibilityInTree()){var T=E.clone();T.addElement(o);var C=o.name;""===C&&(C="-");var b=o._iconInTree?o._iconInTree:a+"SWXUiConvertEntitiesHeader.png",U=new WUX.Controls.TreeNode({backgroundColor:"rgba(255, 255,255,0.5)",label:C,pathElement:T,icons:[b]});if(g.addChild(U),o.children.length){var N=new WUX.Controls.TreeNode({label:"__dummy__"});U.addChild(N),U.onPreExpand(d)}}}else{N=new WUX.Controls.TreeNode({label:"__dummy__"});g.addChild(N),g.onPreExpand(d)}}else"CHANGEICON"===e.eventType?g.setIcon({picture:r._iconInTree}):"CHANGENAME"===e.eventType?g.setLabel(r.name):"SHOWTREE"!==e.eventType&&"HIDETREE"!==e.eventType||i._applyVisibilityToTreeNodes(g,r._occurrences[t])}for(t=0;t<u.length;t++){var y=u[t];y.fromNode.removeChild(y.toNode,!1)}}}),this},setSceneGraph:function(e){this._sg=null;var t=null;if(this.tree.getRoots().length)(t=this.tree.getNthRoot(0)).removeChildren(),t.collapse(),t._updateView&&t._updateView(!0);else{var n=null;n=e instanceof s?e._private_root._occurrences[0]:e._occurrences[0];var r=new l;r.setFromOccurrence(n);var i=n.node.name;""===i&&(i="-"),this.tree.addRoot({backgroundColor:"rgba(255, 255, 255, 0.498039)",label:i,pathElement:r,icons:[a+"SWXUiCustomizeHeader.png"]}),t=this.tree.getNthRoot(0)}var o=new WUX.Controls.TreeNode({label:"__dummy__"});t.addChild(o),t.onPreExpand(d),this._sg=e},getTreeNode:function(e){var t=this.tree.getNthRoot(0);if(t){var n={node:null};return this.traverse(t,function(t,n){var r=t.getPathElement?t.getPathElement():null;return!r&&t.options&&t.options.pathElement&&(r=t.options.pathElement),!(!r||!r.isEqual(e))&&(n.node=t,!0)},n),n.node}},traverse:function(e,t,n){var r,i,o=!1;if(o=t(e,n),i=e.getChildren()?e.getChildren().length:0,!o)for(r=0;r<i&&!(o=this.traverse(e.getNthChild(r),t,n));r++);return o},dispose:function(){t.unsubscribe(this.toUnsubscribe),this.toUnsubscribe=null,this.tree.remove(),this._sg=null},_applyVisibilityToTreeNodes:function(e,t){if(e&&t){t._getVisible()?e.options.UI=e.getTree().options.UI:e.options.UI=UWA.extend(UWA.clone(e.getTree().options.UI,"false"),{label:{filter:"grayscale(100%)",opacity:.3}});for(var n=0;n<t.children.length;n++)this._applyVisibilityToTreeNodes(e.getNthChild(n),t.children[n]);e._updateView(!0)}}});return UWA.namespace("THREEDS/SceneGraphTree",h)});