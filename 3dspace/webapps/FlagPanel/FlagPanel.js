/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/FlagPanel/FlagPanelEnums",[],function(){"use strict";var e={fieldsTypeEnum:{STRING:1,INTEGER:2,DOUBLE:3,BUTTON:4,BOOLEAN:5,RADIO:6}};return e}),
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/FlagPanel/FlagPanel",["UWA/Core","DS/FlagPanel/FlagPanelEnums","UWA/Class","DS/Visualization/Node3D","DS/SceneGraphNodes/CSS2DNode","DS/Visualization/ThreeJS_DS","DS/Controls/LineEditor","DS/Core/Events","DS/VisuEvents/EventsManager","DS/Mesh/MeshUtils","DS/Manipulators/ScreenPlaneManipulator","UWA/Utils/Client","css!DS/UIKIT/UIKIT","css!DS/FlagPanel/FlagPanel.css"],function(e,n,t,i,a,l,o,s,c,r,d,f){"use strict";var u={},g=t.extend({init:function(t,r){var g,p,m,h,v,b,y,P=this,E=0,R=r||{};"object"==typeof t&&(R.className=R.className||"",this._parent(),this._viewer=t,this.options=R,this.screenPlaneManipulator=new d,this.screenPlaneManipulator.setExclusive(!0),this.flagRoot=new i("FlagPanelRoot"),this.flagRoot.setVisibilityInTree(!1),this.flagRoot._getExcludeFromCSO=function(){return!0},this._viewer.addNode(this.flagRoot),a._zIndexManager=function(){},P.canvas=e.createElement("canvas",{class:"WUXFlagLeader"}),P.flagLeader=new a({name:"FlagPanel2DLeader",html:P.canvas}),P.flagLeader.getElement().getParent().style["line-height"]="0",P.flagLeader.setPickability(!1),P.flagRoot.addChild(P.flagLeader),"object"==typeof R.position&&R.position instanceof l.Matrix4&&this.flagRoot.setMatrix(R.position),p=function(t,i){var a,l,s,r,d,f,g,p,m,h,v,b=null,y=u[t.type];switch(t.type){case n.fieldsTypeEnum.BOOLEAN:h=e.createElement("div",{class:"WUXFlagPanelDialog WUXFlagPanelBtnDialog",events:{click:function(e){e.stopPropagation(),h.toggleClassName("activated"),p=!p,"function"==typeof t.fnCallback&&t.fnCallback(p)}}}).inject(i),p="boolean"==typeof t.value&&t.value,e.createElement("img",{class:"WUXFlagPanelImgBtn",src:t.iconUrl}).inject(h),!0===p&&h.addClassName("activated");break;case n.fieldsTypeEnum.RADIO:if(t.radios&&Array.isArray(t.radios))for(l=t.radios.length,r=e.Utils.getUUID(),h=e.createElement("div",{class:"WUXFlagPanelDialog WUXFlagPanelBtnDialog WUXFlagPanelDropDown",events:{click:function(e){e.stopPropagation(),d.isHidden()?(d.show(),c.addEvent(P._viewer.canvas,"onPrimaryPointerClick",d.hideMe)):d.hideMe()}}}).inject(i),(d=e.createElement("div",{class:"WUXFlagPanelRadios",styles:{top:"-"+(34*l+12)+"px"}}).inject(h)).hideMe=function(){c.removeEvent(P._viewer.canvas,"onPrimaryPointerClick",d.hideMe),d.hide()},d.hide(),f=e.createElement("img",{class:"WUXFlagPanelImgBtn"}).inject(h),e.createElement("div",{class:"WUXFlagPanelDropDownBtn wux-afr-dropdown-arrow",html:'<span class="fonticon fonticon-expand-down"></span>'}).inject(h),v=function(e){f.set("src",e.target.parentElement.getElement("img").src),d.hideMe(),c.removeEvent(P._viewer.canvas,"onPrimaryPointerClick",d.hideMe),d.getElement(".checked").removeClassName("checked"),this.addClassName("checked"),"function"==typeof t.fnCallback&&t.fnCallback(e.target.value)},a=0;a<l;++a)s=e.createElement("label",{class:"WUXFlagPanelRadio",events:{change:v}}).inject(d),c.addEvent(P._viewer.canvas,"onPrimaryPointerClick",d.hideMe),e.createElement("input",{type:"radio",name:r,value:t.radios[a].value}).inject(s),e.createElement("img",{src:t.radios[a].iconUrl}).inject(s),e.createElement("span",{html:t.radios[a].label?t.radios[a].label:""}).inject(s),t.radios[a].isdefault&&(s.addClassName("checked"),s.getChildren()[0].set("checked","true"),f.set("src",t.radios[a].iconUrl));break;default:g=t.prefix||"",p=t.value||u[t.type].defaultValue,m=t.suffix||"",h=e.createElement("div",{class:"WUXFlagPanelDialog btn-link",events:{click:function(n){var a,l,s=function(){i.closeActiveEditor=null,a.elements.container.childNodes[0].removeEventListener("keydown",l),c.removeEvent(P._viewer.canvas,"onPrimaryPointerClick",s),a.elements.container.removeClassName("error"),b.hide(),h.removeClassName("active"),"function"==typeof t.fnCallback&&t.fnCallback(p),b.destroy(),b=null},r=function(){"function"!=typeof y.fnValid||y.fnValid(a.value)?(p=a.value,h.setHTML(g+" "+p+" "+m),s()):a.elements.container.addClassName("error")};l=function(e){var n=e.which||e.keyCode,t=i.getElementsByClassName("WUXFlagPanelDialog btn-link"),a=[].indexOf.call(t,h),l=t.length;if(n&&-1!==[9,13,27].indexOf(n))switch(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n){case 9:setTimeout(function(){e.shiftKey?a>0?t[a-1].click():t[l-1].click():a<l-1?t[a+1].click():t[0].click()},10),r();break;case 13:r();break;case 27:s()}},"function"==typeof i.closeActiveEditor&&i.closeActiveEditor(),e.Event.stop(n),a=new o({disabled:!1,value:p,selectAllOnFocus:!0,autoCommitFlag:!0,pattern:y.pattern?y.pattern:null}),b=e.createElement("div",{class:"WUXFlagPanelEdition",html:[{tag:"span",class:"WUXFlagPanelCancelBtn WUXFlagPaneleditor",html:'<span class="fonticon fonticon-close"></span>',events:{click:function(){s()}}},{tag:"div",class:"WUXFlagPanelCloseBtn WUXFlagPaneleditor btn-primary",html:[{tag:"span",class:"fonticon fonticon-check"}],events:{click:function(){r()}}}]}).inject(i),a.inject(b,"top"),a.elements.container.addClassName("WUXFlagPanelInput"),a.elements.container.childNodes[0].select(),a.elements.container.childNodes[0].focus(),a.elements.container.childNodes[0].addEventListener("keydown",l,!0),c.addEvent(P._viewer.canvas,"onPrimaryPointerClick",s),h.addClassName("active"),i.closeActiveEditor=s}},html:g+" "+p+" "+m}).inject(i)}return b},m=function(){var e,n,t,i,a=10,o=P.flagPanel.getElement().getBoundingClientRect(),s=o.height,c=o.width,r={},d={},f=0,u=[{id:0,x:P.flagPanel.css2DNode.offset.x,y:P.flagPanel.css2DNode.offset.y+s/2,len:0},{id:1,x:P.flagPanel.css2DNode.offset.x+c/2,y:P.flagPanel.css2DNode.offset.y,len:0},{id:2,x:P.flagPanel.css2DNode.offset.x+c,y:P.flagPanel.css2DNode.offset.y+s/2,len:0},{id:3,x:P.flagPanel.css2DNode.offset.x+c/2,y:P.flagPanel.css2DNode.offset.y+s,len:0}];for(i=0;i<4;++i)u[i].len=new l.Vector2(u[i].x,u[i].y).length();switch(u.sort(function(e,n){return e.len-n.len}),(u[f=0].x<a+1&&0===u[f].id||u[f].x>a+1&&2===u[f].id||u[f].y<a+1&&1===u[f].id||u[f].y>a+1&&3===u[f].id)&&(t=u.filter(function(e){return 0===u[f].id||2===u[f].id?1===e.id||3===e.id:0===e.id||2===e.id})),t&&(f=u.indexOf(t[0].len<t[1].len?t[0]:t[1]),t=null),(Math.abs(u[f].x)<a+1&&(0===u[f].id||2===u[f].id)||Math.abs(u[f].y)<a+1&&(1===u[f].id||3===u[f].id))&&(f=0,a=0),u[f].x>0?(r.x=0,d.x=u[f].x-1):(r.x=-u[f].x,d.x=1),u[f].y>0?(r.y=0,d.y=u[f].y-1):(r.y=-u[f].y,d.y=1),n=new l.Vector2(u[f].x>0?0:u[f].x,u[f].y>0?0:u[f].y),e=P.canvas.getContext("2d"),P.canvas.width=Math.abs(r.x-d.x)+1,P.canvas.height=Math.abs(r.y-d.y)+1,e.clearRect(0,0,P.canvas.width,P.canvas.height),e.beginPath(),e.moveTo(d.x,d.y),u[f].id){case 1:e.lineTo(d.x,d.y-a);break;case 2:e.lineTo(d.x+a,d.y);break;case 3:e.lineTo(d.x,d.y+a);break;default:e.lineTo(d.x-a,d.y)}e.lineTo(r.x,r.y),e.lineWidth=1,e.strokeStyle="#000000",e.stroke(),P.flagLeader.setOffset(n),P._viewer.render()},y=function(e,n,t){var i=new l.Vector2(e.event.from[0].event.clientX,e.event.from[0].event.clientY).sub(n).sub(t);P.flagPanel.setOffset(i),m(),P._viewer.render(),s.publish({event:"FlagPanel_Moved",data:{id:P.flagPanel.id}})},function(){var n,t,i,o,s=e.createElement("div",{class:"WUXFlagPanel "+P.options.className});if("string"==typeof P.options.iconUrl&&(P._icon=e.createElement("div",{class:"WUXFlagPanelTypeIcon"}),P._icon.inject(s),P.setIcon(P.options.iconUrl)),"string"==typeof P.options.label&&e.createElement("div",{class:"WUXFlagPanelLabel",html:P.options.label}).inject(s),void 0!==P.options.dialogs&&Array.isArray(P.options.dialogs)&&P.options.dialogs.length>0)for(o=e.createElement("section",{class:"WUXFlagPanelDialogs"}).inject(s),t=P.options.dialogs.length,n=0;n<t;++n)u.hasOwnProperty(P.options.dialogs[n].type)&&p(P.options.dialogs[n],o);!0!==P.options.closeButton&&void 0!==P.options.closeButton||e.createElement("div",{class:"WUXFlagPanelCloseBtn btn-default",html:'<span class="fonticon fonticon-close"></span>',events:{click:function(){"function"==typeof P.options.closeCB&&P.options.closeCB(),P.destroy()}}}).inject(s),i=P.options.offset?P.options.offset:new l.Vector2(50,-50),P.flagRoot.removeChild(P.flagPanel),P.flagPanel=new a({html:s,class:"WUXFlagPanel "+P.options.className,name:"FlagPanel2D",offset:i}),P.flagPanel.setAlwaysOnTopIndex(999),P.flagPanel._getExcludeFromCSO=function(){return!0},P.flagPanel.css2DNode.primitive=!0,P.flagRoot.addChild(P.flagPanel)}(),g=setInterval(function(){var e,n,t=P.flagPanel.getElement().getBoundingClientRect();(0===t.height||0===t.width)&&E<1e3?E+=10:(clearInterval(g),m(),h=function(t){var i,a=P._viewer.currentViewpoint.project((new l.Vector3).getPositionFromMatrix(P.flagRoot.getMatrixWorld()));e=new l.Vector2(a.x,a.y),i={x:a.x+P.flagPanel.getOffset().x,y:a.y+P.flagPanel.getOffset().y},n=new l.Vector2(t.event.from[0].event.clientX,t.event.from[0].event.clientY).sub(i)},v=function(t){void 0!==f.Engine.ie?window.requestAnimationFrame(function(){y(t,e,n)}):y(t,e,n)},b=function(e){P._viewer.setCursor("auto"),v(e)},P._tokenBeginManipulate=P.screenPlaneManipulator.subscribe("BeginManipulate",h),P._tokenManipulate=P.screenPlaneManipulator.subscribe("Manipulate",v),P._tokenEndManipulate=P.screenPlaneManipulator.subscribe("EndManipulate",b),P.manipToken=P.screenPlaneManipulator.linkToNode(P.flagPanel),P.refresh=function(){m()})},10))},setIcon:function(e){this.options.iconUrl=e,this._icon&&this._icon.setStyle("background-image",'url("'+e+'")')},getOffset:function(){return this.flagPanel.getOffset()},setOffset:function(e){this.flagPanel.setOffset(e),"function"==typeof this.refresh&&this.refresh()},destroy:function(){this.manipToken&&(this.screenPlaneManipulator.unsubscribe(this._tokenBeginManipulate),this.screenPlaneManipulator.unsubscribe(this._tokenManipulate),this.screenPlaneManipulator.unsubscribe(this._tokenEndManipulate),this.screenPlaneManipulator.unlink(this.manipToken),this.manipToken=null,this.screenPlaneManipulator=null),this.flagRoot&&(this._viewer.removeNode(this.flagRoot),this.flagRoot=null)}});return u[n.fieldsTypeEnum.STRING]={defaultValue:"",fnValid:function(e){return"string"==typeof e&&e.length>0}},u[n.fieldsTypeEnum.INTEGER]={defaultValue:"1",pattern:"^[+-]?[0-9]*$",fnValid:function(e){return"number"==typeof e||!!("string"==typeof e&&e.length>0&&e.match(u[n.fieldsTypeEnum.INTEGER].pattern))}},u[n.fieldsTypeEnum.DOUBLE]={defaultValue:"1.0",pattern:"^[+-]?[0-9]*.?[0-9]+$",fnValid:function(e){return"number"==typeof e||!!("string"==typeof e&&e.length>0&&e.match(u[n.fieldsTypeEnum.DOUBLE].pattern))}},u[n.fieldsTypeEnum.BUTTON]={title:"",iconUrl:"",fnCallback:null},u[n.fieldsTypeEnum.BOOLEAN]={title:"",iconUrl:"",defaultValue:!1,fnCallback:null},u[n.fieldsTypeEnum.RADIO]={title:"",iconUrl:"",fnCallback:null},g}),
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/FlagPanel/FlagPanelManager",["UWA/Core","UWA/Class","DS/FlagPanel/FlagPanel","DS/Visualization/ThreeJS_DS","DS/Core/Events"],function(e,n,t,i,a){"use strict";return n.extend({init:function(e,n){var t,l,o,s,c,r=this,d={};this._onViewpointToken=a.subscribe({event:"/VISU/"},function(e){var n;if("@onViewpointEndMove"===e.eventType)for(n in d)d.hasOwnProperty(n)&&t(d[n])}),this.destroy=function(){r._onViewpointToken&&a.unsubscribe(r._onViewpointToken)},"object"==typeof e&&(this._parent(),this._viewer=e,this.options=n,l=function(e){var n,t=!1;return e?(n=e.item.getOffset(),o(e.id),e.boundingRect.left<5&&(n.x+=5-e.boundingRect.left,e.item.setOffset(n),t=!0,o(e.id)),e.boundingRect.right>r._viewer.SCREEN_WIDTH-5&&(n.x+=r._viewer.SCREEN_WIDTH-5-e.boundingRect.right,e.item.setOffset(n),t=!0,o(e.id)),e.boundingRect.top<5&&(n.y+=5-e.boundingRect.top,e.item.setOffset(n),t=!0,o(e.id)),e.boundingRect.bottom>r._viewer.SCREEN_HEIGHT-5&&(n.y+=r._viewer.SCREEN_HEIGHT-5-e.boundingRect.bottom,e.item.setOffset(n),t=!0,o(e.id)),t):null},c=function(e,n){var t,i,a=l(e);if(!((n=n||0)>1e3)&&e)for(t in d)if(d.hasOwnProperty(t)&&t!==e.id.toString()&&(o(e.id),e.boundingRect.left=e.boundingRect.left>0?e.boundingRect.left:0,e.boundingRect.right=e.boundingRect.right<r._viewer.SCREEN_WIDTH?e.boundingRect.right:r._viewer.SCREEN_WIDTH,e.boundingRect.top=e.boundingRect.top>0?e.boundingRect.top:0,e.boundingRect.bottom=e.boundingRect.bottom<r._viewer.SCREEN_HEIGHT?e.boundingRect.bottom:r._viewer.SCREEN_HEIGHT,!(e.boundingRect.top>d[t].boundingRect.bottom+5||e.boundingRect.bottom<d[t].boundingRect.top-5||e.boundingRect.left>d[t].boundingRect.right+5||e.boundingRect.right<d[t].boundingRect.left-5)&&(i=e.item.getOffset().clone(),!a&&e.boundingRect.top<d[t].boundingRect.bottom+5&&e.boundingRect.top>d[t].boundingRect.top-5&&(i.y=s(t).y+d[t].item.getOffset().y+d[t].boundingRect.height+5-s(e.id).y,a=!0),!a&&e.boundingRect.bottom<d[t].boundingRect.bottom+5&&e.boundingRect.bottom>d[t].boundingRect.top-5&&(i.y=s(t).y+d[t].item.getOffset().y-e.boundingRect.height-5-s(e.id).y,a=!0),a))){n++,e.item.setOffset(i),c(e,n);break}},t=function(e){l(e)},s=function(e){return d.hasOwnProperty(e)?r._viewer.currentViewpoint.project((new i.Vector3).getPositionFromMatrix(d[e].item.flagPanel.getMatrixWorld())):null},o=function(e){var n,t,i;d.hasOwnProperty(e)&&(n=s(e),t=d[e].item.flagPanel.getElement().getBoundingClientRect(),i=d[e].item.getOffset(),n.x+=i.x,n.y+=i.y,d[e].boundingRect={bottom:n.y+t.height,height:t.height,left:n.x,right:n.x+t.width,top:n.y,width:t.width})},r.addFlag=function(e){var n=e.flagPanel.id;d[n]={id:n,item:e,boundingRect:{},listener:a.subscribe({event:"FlagPanel_Moved"},function(e){t(d[e.id])})},setTimeout(function(){o(n),c(d[n]),t(d[n])},25)},r.removeFlag=function(e){e.flagPanel.id&&void 0!==d[e.flagPanel.id]&&(a.unsubscribe(d[e.flagPanel.id].listener),delete d[e.flagPanel.id])},r.removeAll=function(){d={}})}})});