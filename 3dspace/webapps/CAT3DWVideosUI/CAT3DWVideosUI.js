define("DS/CAT3DWVideosUI/CAT3DWVideo",["DS/CAT3DWPhoto/CAT3DWImage","DS/CAT3DWVideosUI/CAT3DWVideoView","DS/CAT3DWInfraUI/CAT3DWCanvasServices","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils","DS/CAT3DWVideosUI/CAT3DWVideosController","DS/CoreEvents/Events"],function(e,t,i,n,o,s,a){"use strict";var r=e.extend({init:function(e){this._isVideo=!0===e.isVideo,this._videoData=null,this._videosControllers=e.videosController,this._videosControllers.setViewSettings(e.viewSettings),this._parent(e),this.getDataService().setValue("selected",!1);var t=e.url.lastIndexOf("/id/");if(t>0){var i=e.url.slice(t+4);i=i.slice(0,i.indexOf("/")),this.getDataService().setValues({id:i})}this._file=e.file},dispose:function(){this._videosControllers.removeVideo(this._videoData),this._videoData=null,this._videosControllers=null,this.getView()&&this.getView().dispose(),this._parent()},createMediaView:function(e,i){return new t(this,e,i.viewSettings)},isPublished:function(){return this.getDataService().getValue("published")},select:function(){this._mediaView.activateSelectionFeedback(),this.isSelected()||(this.getDataService().setValue("selected",!0),a.publish({event:"CAT3DSKSelectMediaEvent",data:{mediaID:this.getID(),type:this.getType()}}))},deselect:function(){this._mediaView.deactivateSelectionFeedback(),this.isSelected()&&(this.getDataService().setValue("selected",!1),a.publish({event:"CAT3DSKDeselectMediaEvent",data:{mediaID:this.getID(),type:this.getType()}}))},isSelected:function(){return this.getDataService().getValue("selected")},getImageBlob:function(){var e=new i,t=e.getDataUrlFromImg(this.getTexture().image);return e.getBlobFromDataUrl(t)},getCopyData:function(){var e=this._parent();return e.url=this._videoData.getSrc(),e.isVideo=this._isVideo,e.published=this.getDataService().getValue("published"),e.mediaId=this.getDataService().getValue("mediaId"),e.title=this.getDataService().getValue("title"),e.extension=this.getDataService().getValue("extension"),e.filetype=this.getDataService().getValue("filetype"),e.type=this.getType(),e.mediaType=this.getDataService().getValue("mediaType"),e},getFile:function(){return this._file},setTexture:function(e,t){var i="";if(i=e||o.getWebappsAssetUrl("CAT3DWPhoto","graphics/G_NXGAddImage.png"),this._bIsTextureLoading)this._queuedTexture.urlOrTexture=i,this._queuedTexture.callback=t;else if(this._bIsTextureLoading=!0,"string"==typeof i){if(!0===this._isVideo){var s=this.getView().getCorners();this._videosControllers.createVideo({videoNode:this._mediaView.parents[0],urlOrTexture:i,viewer:this._viewer,controlPosition:this.getView().getCenter(),videoDimension:new n.Vector2(this._viewer.currentViewpoint.project(s.topLeft).distanceTo(this._viewer.currentViewpoint.project(s.topRight)),this._viewer.currentViewpoint.project(s.topLeft).distanceTo(this._viewer.currentViewpoint.project(s.bottomLeft)))}).then(function(e){this._videoData=e,this._texture=this._videoData.getTexture(),setTimeout(this._onTextureLoaded.bind(this,t))}.bind(this))}}else"object"==typeof i&&(this._texture=i,setTimeout(this._onTextureLoaded.bind(this,t)))},getVideoData:function(){return this._videoData},pause:function(){this.getVideoData()&&this.getVideoData().pause()},play:function(){this.getVideoData()&&this.getVideoData().play()},isPlaying:function(){return!!this.getVideoData()&&this.getVideoData().isPlaying()},isVideo:function(){return this._isVideo},getType:function(){return"CAT3DWVideo"},getCreationData:function(){var e=this._parent();return e.image=this._texture.image.currentSrc,e}});return UWA.namespace("DS/CAT3DWVideosUI/CAT3DWVideo",r)}),define("DS/CAT3DWVideosUI/CAT3DWVideosController",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/MaterialApplication","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/SceneGraphNodes/FixedSizeNode3D","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWVisu/CAT3DWVisuServices","DS/WebappsUtils/WebappsUtils","UWA/Core"],function(e,t,i,n,o,s,a,r,h,l,d){"use strict";var u={registerVideoController:function(e){this.videosControllers.push(e)},removeVideoController:function(e){var t=this.videosControllers.findIndex(function(t){return e===t});t>=0&&this.videosControllers.splice(t,1)},pauseVideosControllers:function(e){this.videosControllers.forEach(function(t){t.pauseAllVideos(e)})},muteVideosControllers:function(){this.videosControllers.forEach(function(e){e.muteVideos(!0)})},videosControllers:[]},c=e.extend({init:function(){return this._videoAnimationToken=null,this._videos=[],this._viewSettings=null,u.registerVideoController(this),this},dispose:function(){this._videoAnimationToken=null,this._videos=[],this._viewSettings=null,u.removeVideoController(this)},setViewSettings:function(e){this._viewSettings=e},pauseAllVideos:function(e){this._videos.forEach(function(t){t!==e&&t.isPlaying()&&t.pause()})},createVideo:function(e){e.viewSettings=this.viewSettings;var c=document.createElement("video");return c.type="video/mp4",c.width=640,c.height=360,c.loop=!0,c.setAttribute("playsinline","playsinline"),c.muted=!0,c.crossOrigin=r.getPreferenceValue("CrossOrigin"),c.crossOrigin||(c.crossOrigin="use-credentials"),new Promise(function(t){c.addEventListener("loadedmetadata",function(){if(this.videoWidth&&this.videoHeight){var e=this.videoWidth/this.videoHeight;c.width=640*Math.min(e,1),c.height=640/Math.max(e,1)}t()}),c.src=e.urlOrTexture}).then(function(){return new Promise(function(r){var _=new t.Texture(c);_.minFilter=t.LinearFilter,_.magFilter=t.LinearFilter,_.format=t.RGBFormat;var p={_videosController:this,_texture:_,_video:c,_src:e.urlOrTexture,_paused:!0,_pausedVideoAnimation:!1,_viewer:e.viewer,_playButton:e.controlPosition?function(e,r){var h={_btnNode:null,_viewer:e.viewer,_fitting:!0,_canvasNode:null,_img:null,_videoNode:r,drawCanvas:function(e,t,i,n){t.drawImage(this._img,0,0,this._img.width,this._img.height)},load:function(){this._btnNode=new n("playButtonNode"),this._fixedNode=new a({name:"fixedPlayNode",ratio:1}),this._btnNode.addChild(this._fixedNode),this._videoNode.addChild(this._btnNode);var e=l.getWebappsAssetUrl("CAT3DWVideosUI","graphics/videoplay.png");window&&window.ds&&window.ds.env&&"MOBILE"===window.ds.env&&(e=d.Data.proxifyUrl(e,{proxy:"passport"})),this._texture=t.ImageUtils.loadTexture(e,void 0,this._onTextureLoaded.bind(this,this._fixedNode),this.onLoadImageError,!1)},_onTextureLoaded:function(n){this._rectangle=o.createRectangleNode({width:100,height:100,fill:!0,color:new s.Color(255,255,255,0)}),e&&e.viewSettings&&this._rectangle.setRenderPasses([e.viewSettings.getBeforeMainPass()]);var a=new t.Matrix4;a.set(0,-1,0,0,1,0,0,0,0,0,1,0,0,0,0,1),a.setPosition(new t.Vector3(50,-50,0)),this._rectangle.setMatrix(a),this._rectangle.setPickable(s.NODRAWHL),n.addChild(this._rectangle);var r=new t.LineBasicMaterial({opacity:0}),h=new t.MeshBasicMaterial({map:this._texture,force:!0,side:t.DoubleSide});h.transparent=!0,h.color=new t.Color,e&&"number"==typeof e.renderDepth&&(h.depthTest=!1,this._rectangle.setRenderDepth(e.renderDepth)),this._rectangle.removeMaterialApplication();var l=new i({faceMaterial:h,lineMaterial:r});this._rectangle.setMaterialApplication(l),this._viewer.render()},update:function(e,t){if(this._btnNode){this._fitting=!t||t.x>100&&t.y>100;var i=this._btnNode.getMatrix();i.setPosition(e),this._btnNode.setMatrix(i),this._btnNode.setVisibility(this._fitting&&this._playButtonVisibility)}},setVisibility:function(e){this._playButtonVisibility=e,this._btnNode&&this._btnNode.setVisibility(this._fitting&&e)},isPicked:function(e){if(this._btnNode){var i=this._viewer.currentViewpoint.project((new t.Vector3).getPositionFromMatrix(this._btnNode.getMatrixWorld()));return e.distanceTo(new t.Vector2(i.x,i.y,0))<=50}return!1},dispose:function(){this._btnNode&&this._viewer&&(this._videoNode.removeChild(this._btnNode),this._btnNode=null),this._viewer=null,this._videoNode=null}};return h.load(),h.update(e.controlPosition,e.videoDimension),h.setVisibility(!0),h}(e,e.videoNode):null,_onVideoPlayStart:function(e){e&&u.pauseVideosControllers(e)},_startUpdateTexture:function(e){if(!this._updateTextureRequest){this._videPlayData={start:0,currentTime:null,startPlayTime:e};var t=function(e){e=e||performance.now(),this._videPlayData.start&&this._video.readyState>=this._video.HAVE_CURRENT_DATA&&this._videPlayData.startPlayTime&&e-this._videPlayData.start>=this._videPlayData.startPlayTime&&(this._videPlayData.startPlayTime=0,this._paused)?this._stopUpdateTexture():(!this._videPlayData.start&&this._video.readyState>=this._video.HAVE_CURRENT_DATA&&(this._videPlayData.start=e),this._video.readyState>=this._video.HAVE_CURRENT_DATA&&(null===this._videPlayData.currentTime||this._videPlayData.currentTime!==this._video.currentTime)&&(this._texture.needsUpdate=!0,this._videPlayData.currentTime=this._video.currentTime),this._updateTextureRequest=h.requestAnimationFrame(t))}.bind(this);this._updateTextureRequest=h.requestAnimationFrame(t)}},_stopUpdateTexture:function(){this._updateTextureRequest&&h.cancelAnimationFrame(this._updateTextureRequest),this._updateTextureRequest=null},updateVideoControls:function(e,t){this._playButton&&this._playButton.update(e,t)},getTexture:function(){return this._texture},getSrc:function(){return this._src},pauseVideoAnimation:function(e){this._video&&(e||this._paused?this._video.pause()&&this._stopUpdateTexture():this._video.play()&&this._startUpdateTexture()),this._pausedVideoAnimation=e},play:function(){u.muteVideosControllers(),this.mute(!1),this._video&&!this._pausedVideoAnimation&&(this._video.play(),this._startUpdateTexture()),this._paused=!1,this._playButton&&this._playButton.setVisibility(!1),this._onVideoPlayStart&&this._onVideoPlayStart(this)},pause:function(){this._video&&this._video.pause(),this._paused=!0,this._playButton&&(this._playButton.setVisibility(!0),this._viewer.render())},reset:function(){this._video&&(this._video.currentTime=0)},mute:function(e){this._video.muted=e},isPlaying:function(){return this._video&&!this._paused},processPickInVideo:function(e){return!this.isPlaying()&&(!this._playButton||this._playButton&&this._playButton.isPicked(e))?(this.play(),!0):!!this.isPlaying()&&(this.pause(),!0)},dispose:function(){this._video&&(this.pause(),this._video.removeAttribute("src"),this._video.load(),this.video=null),this._playButton&&(this._playButton.dispose(),this._playButton=null),this._texture&&(this._texture.dispose(),this.texture=null)}};this._videos.length||(this._viewer=e.viewer,this.startVideosAnimation()),this._videos.push(p),c.play().then(()=>{c.pause(),c.currentTime=0,this._updateTextureRequest=h.requestAnimationFrame(()=>{p._texture.needsUpdate=!0,this._updateTextureRequest=void 0})}),r(p)}.bind(this))}.bind(this))},muteVideos:function(e){this._videos.forEach(function(t){t.mute(e)})},removeVideo:function(e){var t=this._videos.findIndex(function(t){return e===t});t>=0&&this._videos.splice(t,1)[0].dispose();this._videos.length||(this.stopVideosAnimation(),this._viewer=null)},startVideosAnimation:function(){if(!this._videoAnimationToken){var e=0;this._videos.forEach(function(e){e.pauseVideoAnimation(!1)});var t=function(i){this._videoAnimationToken=h.requestAnimationFrame(t),(i=i||performance.now())-e>33&&(e=i,this._videos.some(function(e){return e.isPlaying()})&&this._viewer&&this._viewer.render())}.bind(this);this._videoAnimationToken=h.requestAnimationFrame(t)}},stopVideosAnimation:function(){this._videos.forEach(function(e){e.isPlaying()&&e.pauseVideoAnimation(!0)}),this._videoAnimationToken&&h.cancelAnimationFrame(this._videoAnimationToken),this._videoAnimationToken=null},isVideosAnimation:function(){return null!==this._videoAnimationToken}});return d.namespace("DS/CAT3DWVideosUI/CAT3DWVideosController",c)}),define("DS/CAT3DWVideosUI/CAT3DWVideoView",["DS/CAT3DWPhoto/CAT3DWImageView","DS/CAT3DWVisu/CAT3DWDataFactory","DS/Mesh/MeshUtils","DS/Visualization/MaterialApplication","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/VisuEvents/EventsManager","DS/WebUtils/ContextedSingleton","DS/CAT3DWInfra/CAT3DWPreferenceManager"],function(e,t,i,n,o,s,a,r,h){"use strict";var l=e.extend({init:function(e,t,i){this._viewSettings=i,this._parent(e,t),this._sketchBorderMaterial=new s.LineBasicMaterial({color:new s.Color("orange"),lineWidth:2}),this._onTapToken||(this._onTapToken=a.addEvent(this._viewer.canvas,"onTap",this._onTapClick.bind(this))),this._onClickToken||(this._onClickToken=a.addEvent(this._viewer.canvas,"onLeftClick",this._onTapClick.bind(this))),this._onViewPointMove||(this._onViewPointMove=this._viewer.currentViewpoint.onMove(function(){this.updateVideoControls()}.bind(this))),this._appMode=h.getPreferenceValue("appMode")},_createRectangle:function(){this._parent(),this._rectangle.setRenderPasses([this._viewSettings.getBeforeMainPass()]),this.setImagePickable(!0)},_getCornerPoint:function(){return new s.Vector2(.5*this._width,.5*this._height)},resize:function(e,t){e&&t&&(this._width=this._defaultRectangleValue*e,this._height=this._defaultRectangleValue*t,this._createRectangle())},dispose:function(){this._onTapToken&&a.removeEventFromToken(this._onTapToken),this._onTapToken=null,this._onClickToken&&a.removeEventFromToken(this._onClickToken),this._onClickToken=null,this._onViewPointMove&&this._viewer.currentViewpoint.unsubscribe(this._onViewPointMove),this._onMovePrevCB=null,this._setDepthInterval&&clearInterval(this._setDepthInterval),this._parent()},setDepth:function(e){var t=this.getMediaObj()?this.getMediaObj().getVideoData():null,i=[];if(t&&t._playButton&&t._playButton._rectangle)i[0]={node:t._playButton._rectangle,offset:1};else{var n=this._parent;this._setDepthInterval&&clearInterval(this._setDepthInterval),this._setDepthInterval=setInterval(function(){t&&t._playButton&&t._playButton._rectangle&&(clearInterval(this._setDepthInterval),this._setDepthInterval=void 0,i[0]={node:t._playButton._rectangle,offset:1},n.call(this,e,i),this._viewer.render())}.bind(this),1)}this._parent(e,i)},updateVideoControls:function(){var e=this.getMediaObj()?this.getMediaObj().getVideoData():null;if(e){var t=this.getCorners();e.updateVideoControls(this.getCenter(),new s.Vector2(this._viewer.currentViewpoint.project(t.topLeft).distanceTo(this._viewer.currentViewpoint.project(t.topRight)),this._viewer.currentViewpoint.project(t.topLeft).distanceTo(this._viewer.currentViewpoint.project(t.bottomLeft))))}},setMatrix:function(e,t){this._parent(e,t),this.updateVideoControls()},applyMatrix:function(e){this._parent(e),this.updateVideoControls()},isPickedObject:function(e){var i=r.get(null,"ANNOTATION_MANAGER").getPickingController(),n=i.getPickingMask();i.setCPUPicking(),i.setPickingMask(t.SupportTypes.IMAGE);var o=i.pick(e,!0);return i.setPickingMask(n),i.setHybridPicking(),o&&o.path&&o.path.externalPath[0]&&o.path.externalPath[1]===this},_onTapClick:function(e){var t=this.getMediaObj()?this.getMediaObj().getVideoData():null;if(t){var i=e.gesture.getEvents()[0].getCurrentPosition();"video"!==e.state&&this.isPickedObject(i)&&t.processPickInVideo(i)&&(e.state="video")}},_getRectShadowMaterial:function(e,t,i,n){var o=new s.MeshBasicMaterial({color:new s.Color("black"),transparent:!0,polygonOffset:!0,depthTest:!0,force:!0,side:s.DoubleSide});o.activatePDSFX();var a={width:{type:"f",value:e},height:{type:"f",value:t},widthDiff:{type:"f",value:i},heightDiff:{type:"f",value:n}};o.setPDSFXUniforms(a),o.setPDSFXVaryings({locPos:{type:"v3"}});var r={ComputeOpacity:["float ComputeOpacity() {","  float myX = locPos.x + width / 2.0;","  float myY = locPos.y + height / 2.0;","  bool smallx = (myX < widthDiff);","  bool smally = (myY < heightDiff);","  bool bigx = (myX > width - widthDiff);","  bool bigy = (myY > height - heightDiff);","  float normalizedx = 0.0;","  float normalizedy = 0.0;","  float opacity = 0.25;","","  if (smallx) {","    normalizedx = myX / widthDiff;","    if (smally) {","      normalizedy = myY / heightDiff;","      return pow( normalizedx * normalizedy, 2.0 ) * opacity;","    }","    if (bigy) {","      normalizedy = 1.0 - (myY - height + heightDiff) / heightDiff;","      return pow( normalizedx * normalizedy, 2.0 ) * opacity;","    }","    return pow( normalizedx, 2.0 ) * opacity;","  }","  if (bigx) {","    normalizedx = 1.0 - (myX - width + widthDiff) / widthDiff;","    if (smally) {","      normalizedy = myY / heightDiff;","      return pow( normalizedx * normalizedy, 2.0 ) * opacity;","    }","    if (bigy) {","      normalizedy = 1.0 - (myY - height + heightDiff) / heightDiff;","      return pow( normalizedx * normalizedy, 2.0 ) * opacity;","    }","    return pow( normalizedx, 2.0 ) * opacity;","  }","  if (smally && !smallx && !bigx) {","    return pow( myY / heightDiff, 2.0 ) * opacity;","  }","  if (bigy && !smallx && !bigx) {","    return pow( 1.0 - (myY - height + heightDiff) / heightDiff, 2.0 ) * opacity;","  }","  return 0.0;","}"].join("\n")};return o.setPDSFXOverridableFunctions({ComputeVaryingValues:"void ComputeVaryingValues() { locPos = vGetAttribPosition() ;}"},r),o},setSelected:function(e){e?this._media.select():this._media.deselect()},activateSelectionFeedback:function(){this.selectionGroupID||(this.addSketchBorderMaterial(),this.showSelectionNode())},deactivateSelectionFeedback:function(){this.removeSketchBorderMaterial(),this.hideSelectionNode()},activateThirdPartySelectionFeedback:function(e){this._createThirdPartySelectionNode(e)},deactivateThirdPartySelectionFeedback:function(){this._thirdPartySelectionNode&&(this.removeChild(this._thirdPartySelectionNode),this._thirdPartySelectionNode=null)},updateThirdPartySelectionNode:function(){if(this._thirdPartySelectionNode){var e=this._width/2,t=this._height/2,i=this._thirdPartySelectionNode.mesh3js.geometry[0].vertexPositionArray;i[0]=e,i[1]=t,i[3]=-e,i[4]=t,i[6]=-e,i[7]=-t,i[9]=e,i[10]=-t,i[12]=e,i[13]=t}},_createThirdPartySelectionNode:function(e){if(!this._thirdPartySelectionNode){var t=this._rectangle.mesh3js.geometry[0].vertexPositionArray,a=[new s.Vector3(t[0],t[1],t[2]),new s.Vector3(t[3],t[4],t[5]),new s.Vector3(t[6],t[7],t[8]),new s.Vector3(t[9],t[10],t[11])];a[4]=a[0],this._thirdPartySelectionNode=o.createLineNode({points:a}),this._thirdPartySelectionNode.setMatrix(this._rectangle.getMatrix()),this._thirdPartySelectionNode.setPickable(i.NODRAWHL),this._thirdPartySelectionNode.setExcludeFromBounding(!0),this._thirdPartySelectionNode.setMaterialApplication(new n({lineMaterial:new s.LineBasicMaterial({color:e||new s.Color("rgb(92,92,92)"),force:!0,transparent:!0,opacity:.75,lineWidth:2})})),this.addChild(this._thirdPartySelectionNode)}},addSketchBorderMaterial:function(){},removeSketchBorderMaterial:function(){},_getRectangleCorners:function(e){if(this._rectangle){var t=this._rectangle.mesh3js.geometry[0].vertexPositionArray;return{bottomLeft:new s.Vector3(t[0],t[1],t[2]).applyMatrix4(e),bottomRight:new s.Vector3(t[3],t[4],t[5]).applyMatrix4(e),topLeft:new s.Vector3(t[9],t[10],t[11]).applyMatrix4(e),topRight:new s.Vector3(t[6],t[7],t[8]).applyMatrix4(e)}}var i=new s.Vector3(this._defaultRectangleValue/2,this._defaultRectangleValue/2,0),n=new s.Vector3(-this._defaultRectangleValue/2,this._defaultRectangleValue/2,0),o=new s.Vector3(this._defaultRectangleValue/2,-this._defaultRectangleValue/2,0),a=new s.Vector3(-this._defaultRectangleValue/2,-this._defaultRectangleValue/2,0);return i.applyMatrix4(e),n.applyMatrix4(e),o.applyMatrix4(e),a.applyMatrix4(e),{bottomLeft:i,bottomRight:n,topLeft:o,topRight:a}}});return UWA.namespace("DS/CAT3DWVideosUI/CAT3DWVideoView",l)});