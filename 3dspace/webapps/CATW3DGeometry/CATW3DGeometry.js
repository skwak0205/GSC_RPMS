/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CATW3DGeometry/CATW3DGeometryEnums",[],function(){"use strict";var e={GeometryType:{POINT:0,CURVE:2,LINE:3,CIRCLE:4,SURFACE:5,PLANE:6,CYLINDER:7,CONE:8,SPHERE:9,AXISSYSTEM:11,AXISSYSTEMAXIS:12,AXISSYSTEMORIGIN:13,AXIS:14,AXISX:15,AXISY:16,AXISZ:17,REFPLANE:18},GeometryMode:{REAL:0,TRANSIENT:1}};return Object.freeze(e)}),define("DS/CATW3DGeometry/CATW3DEquivalentGeometry",["UWA/Class","UWA/Core","UWA/Utils","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUPreVisuNode3D","DS/DMUMeasurable/DMUMeshRecognition","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,r,n,o,i,a,y,m,p){"use strict";var c={};window.c3dUrlComplementForODT&&(c=r.parseQuery(window.c3dUrlComplementForODT)),""!==window.location.search&&(t.extend(c,r.parseQuery(window.location.search)),c.widgetDomain&&t.extend(c,r.parseQuery(c.widgetDomain)));var l="authoring3d"in c,s=new y.Matrix4,E={},T=n.GeometryType,u=e.extend({init:function(e){var t,r=e.pathElement,a=e.type,m=e.mode,p=e.direction,c=e.origin,l=e.geom,s=e.viewer,E=function(e){return e||void 0!==t||(t=new y.Matrix4),r.getWorldMatrix(null,e||t)};if(this.getPathElement=function(){return r.clone()},this.getType=function(){return a},this.getMode=function(){return m},a!==n.GeometryType.AXISSYSTEM&&a!==n.GeometryType.AXISSYSTEMAXIS&&a!==n.GeometryType.AXISSYSTEMORIGIN){if(a===n.GeometryType.REFPLANE)return m=n.GeometryMode.REAL,this.getPlane=function(){var e=E();return{origin:(new y.Vector3).getPositionFromMatrix(E()),normal:(new y.Vector3).getColumnFromMatrix(2,e)}},void(this.getNormal=function(e){var t=E();return(e||new y.Vector3).getColumnFromMatrix(2,t)});if(a===n.GeometryType.AXIS||a===n.GeometryType.AXISX||a===n.GeometryType.AXISY||a===n.GeometryType.AXISZ)return this.getDirection=(T=new y.Matrix4,function(e){return T.extractRotation(E()),(e||new y.Vector3).copy(p).applyMatrix4(T).normalize()}),this.getOrigin=function(e){return(e||new y.Vector3).copy(c).applyMatrix4(E())},void(this.getAxis=function(){var e=E();return{origin:c.clone().applyMatrix4(e),direction:p.clone().transformDirection(e)}});var T;switch(m=n.GeometryMode.REAL,l.type){case o.GeometryType.POINT:a=n.GeometryType.POINT;break;case o.GeometryType.CURVE:a=n.GeometryType.CURVE;break;case o.GeometryType.LINE:a=n.GeometryType.LINE;break;case o.GeometryType.CIRCLE:a=n.GeometryType.CIRCLE;break;case o.GeometryType.SURFACE:a=n.GeometryType.SURFACE;break;case o.GeometryType.PLANE:a=n.GeometryType.PLANE;break;case o.GeometryType.CYLINDER:a=n.GeometryType.CYLINDER;break;case o.GeometryType.CONE:a=n.GeometryType.CONE;break;case o.GeometryType.SPHERE:a=n.GeometryType.SPHERE;break;default:a=null,window.console.log("Unknown DMU geometry type!!!")}s&&a&&(this.getPrevisuNode=function(e,t){var r=new i(s);return r.buildPreVisuNode({data:this,point:e,normal:t}),r}),a===n.GeometryType.POINT&&(this.getPoint=function(e){return(e||new y.Vector3).copy(l.position).applyMatrix4(E())}),a!==n.GeometryType.LINE&&a!==n.GeometryType.CURVE&&a!==n.GeometryType.CYLINDER&&a!==n.GeometryType.CONE||(this.getEndPoints=function(){var e=E();return{beginPoint:l.point1.clone().applyMatrix4(e),endPoint:l.point2.clone().applyMatrix4(e)}},this.getPoints=this.getEndPoints),a===n.GeometryType.PLANE&&(this.getPlane=function(){var e=E();return{origin:l.origin.clone().applyMatrix4(e),normal:l.normal.clone().transformDirection(e)}},this.getNormal=function(e){return(e||new y.Vector3).copy(l.normal).transformDirection(E())}),a!==n.GeometryType.CIRCLE&&a!==n.GeometryType.CYLINDER&&a!==o.GeometryType.SPHERE||(this.getRadius=function(){return l.radius}),a!==n.GeometryType.CIRCLE&&a!==n.GeometryType.SPHERE||(this.getCenter=function(e){return(e||new y.Vector3).copy(l.center).applyMatrix4(E())}),a===n.GeometryType.CIRCLE&&(this.getNormal=function(e){return(e||new y.Vector3).copy(l.normal).transformDirection(E())},this.getAxis=this.getNormal),a===n.GeometryType.CONE&&(this.getApex=function(e){return(e||new y.Vector3).copy(l.apex).applyMatrix4(E())},this.getSemiAngle=function(){return l.semiAngle},this.getAxis=function(e){return(e||new y.Vector3).copy(l.axis).transformDirection(E())})}else a===n.GeometryType.AXISSYSTEMAXIS?function(e){var t=r.getParentPath(),n=new y.Matrix4,o=new y.Matrix4;e.getOrigin=function(e){return t.getWorldMatrix(null,n),(e||new y.Vector3).getPositionFromMatrix(n)},e.getDirection=function(e){return o.extractRotation(E()),(e||new y.Vector3).set(0,0,1).applyMatrix4(o).normalize()}}(this):a===n.GeometryType.AXISSYSTEMORIGIN?this.getOrigin=function(e){return(e||new y.Vector3).getPositionFromMatrix(E())}:this.getMatrix=function(e){return E(e)}}});function G(e){var t=new m(e.externalPath),r=t.getLastElement(!0);if(r&&(p.isInstance(r)||p.isRepInstance(r))&&1===r.children.length)t.addElement(r.children[0]);else for(;t&&(r=t.getLastElement(!0))&&(!p.isPLMNode(r)||!p.is3DLeaf(r)&&!p.isReference(r));)t=t.getParentPath();return t}return E.getEquivalentGeometry=function(e){if(e&&e.pathElement&&e.pathElement.externalPath&&!(e.pathElement.externalPath.length<2)&&"RootBag"===e.pathElement.externalPath[0].name){for(var t,r,i,c,E,S=e.pathElement,g=-1,h=-1,I=S.externalPath.length-1;I>=0;--I){var A=S.externalPath[I];if(A){if("AxisSystems"===A.name){g=I;break}if("RefPlanes"===A.name){h=I;break}if(p.isPLMNode(A))break}}if(-1===g&&-1===h&&S.internalPath.length){var d=S.getLastElement().sgNode;d&&(E=(c=!1!==e.canonicGeometry?a.recognizeCanonicGeometry(d,s,!0):{returnCode:-1}).type,0!==c.returnCode||E!==o.GeometryType.POINT&&E!==o.GeometryType.CURVE&&E!==o.GeometryType.LINE&&E!==o.GeometryType.CIRCLE&&E!==o.GeometryType.SURFACE&&E!==o.GeometryType.PLANE&&E!==o.GeometryType.CYLINDER&&E!==o.GeometryType.CONE&&E!==o.GeometryType.SPHERE?0===c.returnCode||!1!==e.canonicGeometry&&!0!==e.nonCanonicGeometry||(E=(c=a.recognizeNonCanonicGeometry(d,s,!0)).type,0!==c.returnCode||E!==o.GeometryType.POINT&&E!==o.GeometryType.CURVE&&E!==o.GeometryType.LINE&&E!==o.GeometryType.CIRCLE&&E!==o.GeometryType.SURFACE&&E!==o.GeometryType.PLANE&&E!==o.GeometryType.CYLINDER&&E!==o.GeometryType.CONE&&E!==o.GeometryType.SPHERE||(r={pathElement:e.pathElement.clone(),geom:c,viewer:e.viewer},t=new u(r))):(r={pathElement:e.pathElement.clone(),geom:c,viewer:e.viewer},t=new u(r)))}else g>=0&&g+1<S.externalPath.length?(r={pathElement:new m(S.externalPath.slice(0,g+2))},!0===e.axisSystemOrigin?(r.type=n.GeometryType.AXISSYSTEMORIGIN,r.mode=n.GeometryMode.TRANSIENT):(r.mode=n.GeometryMode.REAL,g+2<S.externalPath.length&&!0===e.axisSystemSub?(r.type=n.GeometryType.AXISSYSTEMAXIS,r.pathElement.addElement(S.externalPath[g+2])):r.type=n.GeometryType.AXISSYSTEM),t=new u(r)):h>=0?(r={pathElement:e.pathElement.clone(),type:n.GeometryType.REFPLANE},t=new u(r)):l&&(e.direction&&e.direction instanceof y.Vector3&&e.origin&&e.origin instanceof y.Vector3?(i=G(S))&&((r={pathElement:i}).type=n.GeometryType.AXIS,r.mode=n.GeometryMode.TRANSIENT,r.origin=e.origin.clone(),r.direction=e.direction.clone().normalize(),t=new u(r)):e.axis!==T.AXISX&&e.axis!==T.AXISY&&e.axis!==T.AXISZ||(i=G(S))&&((r={pathElement:i,origin:new y.Vector3,type:e.axis}).mode=n.GeometryMode.TRANSIENT,r.direction=e.axis===T.AXISX?new y.Vector3(1,0,0):e.axis===T.AXISY?new y.Vector3(0,1,0):new y.Vector3(0,0,1),t=new u(r)));return t}},Object.freeze(E),E});