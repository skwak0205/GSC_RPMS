/*!  COPYRIGHT DASSAULT SYSTEMES 2014   */
/*! based on Three.js Copyright Â© 2010-2014 three.js authors */
/*! Uses SMAA. Copyright (C) 2011 by Jorge Jimenez, Jose I. Echevarria,
Belen Masia, Fernando Navarro and Diego Gutierrez. */
!function(){var e=["UWA/Core","UWA/Class"];"file:"!==window.location.protocol&&e.push("text!DS/QualityManager/assets/mdl_GIVisualQualityPresets.json"),define("DS/QualityManager/QMGIPresetStreamer",e,function(e,t,i){"use strict";return t.singleton({init:function(){this.GIQualityPresets=this.getQualityPresets(),e.is(this.GIQualityPresets)},setItem:function(t,i){if(e.is(localStorage)&&e.is(this.GIQualityPresets))for(var r=this.GIQualityPresets,n=t.split("/"),a=n.length,s=0;s<a;s++)s==a-1?e.is(r)&&(r[n[s]]=i):e.is(r)&&(r=r[n[s]])},getItem:function(t){if(!e.is(localStorage)||!e.is(this.GIQualityPresets))return null;for(var i=this.GIQualityPresets,r=t.split("/"),n=r.length,a=0;a<n;a++)e.is(i)&&(i=i[r[a]]);return i},getQualityPresets:function(){var t=null;if(!e.is(localStorage))return t;var i=localStorage.getItem("GIQualityPresets");if(e.is(i))try{t=JSON.parse(i)}catch(e){console.error("Error parsing GIQualityPresets:",e)}else t=this.buidQualityPresets();return t},commit:function(){e.is(localStorage)&&e.is(this.GIQualityPresets)&&localStorage.setItem("GIQualityPresets",JSON.stringify(this.GIQualityPresets))},retoreDB:function(){this.GIQualityPresets=this.getQualityPresets()},buidQualityPresets:function(){return this.GIQualityPresets=i?JSON.parse(i):null,e.is(this.GIQualityPresets)&&this.commit(),this.GIQualityPresets}})})}(),function(){var e=["UWA/Core","UWA/Class"];"file:"!==window.location.protocol&&e.push("text!DS/QualityManager/assets/mdl_QualityManagerPreset.json"),define("DS/QualityManager/QMPresetStreamer",e,function(e,t,i){"use strict";return t.singleton({init:function(){this.databaseKey=null,this.qualityPresets=null},initDataBase:function(t){this.databaseKey=t,null==this.databaseKey&&(this.databaseKey="default_qualityPresets"),this.qualityPresets=this.getQualityPresets(),e.is(this.qualityPresets)},setItem:function(t,i){if(e.is(localStorage)&&e.is(this.qualityPresets))for(var r=this.qualityPresets,n=t.split("/"),a=n.length,s=0;s<a;s++)s==a-1?e.is(r)&&(r[n[s]]=i):e.is(r)&&(r=r[n[s]])},_addItem:function(t,i){if(e.is(localStorage)&&e.is(this.qualityPresets))for(var r=this.qualityPresets,n=t.split("/"),a=n.length,s=0;s<a;s++)s==a-1?(e.is(r[n[s]])||(r[n[s]]={}),r[n[s]]=i):(e.is(r[n[s]])||(r[n[s]]={}),r=r[n[s]])},_removeItem:function(t){if(e.is(localStorage)&&e.is(this.qualityPresets))for(var i=this.qualityPresets,r=t.split("/"),n=r.length,a=0;a<n;a++)if(a==n-1){if(!e.is(i[r[a]]))break;delete i[r[a]]}else{if(!e.is(i[r[a]]))break;i=i[r[a]]}},getItem:function(t){if(!e.is(localStorage)||!e.is(this.qualityPresets))return null;for(var i=this.qualityPresets,r=t.split("/"),n=r.length,a=0;a<n;a++)e.is(i)&&(i=i[r[a]]);return i},getQualityPresets:function(){var t=null;if(!e.is(localStorage))return t;var i=localStorage.getItem(this.databaseKey);if(e.is(i))try{t=JSON.parse(i)}catch(e){console.error("Error parsing qualityPresets:",e)}else t=this.buidQualityPresets();return t},commit:function(){e.is(localStorage)&&e.is(this.qualityPresets)&&localStorage.setItem(this.databaseKey,JSON.stringify(this.qualityPresets))},retoreDB:function(){this.qualityPresets=this.getQualityPresets()},buidQualityPresets:function(){return this.qualityPresets=i?JSON.parse(i):null,e.is(this.qualityPresets)&&this.commit(),this.qualityPresets}})})}();var Stats=function(){var e,t,i,r,n,a,s,o,l=0,c=0,h=Date.now(),u=h,d=h,p=0,f=1e3,m=0,g=[[16,16,48],[0,255,255]],v=0,S=1e3,_=0,y=[[16,48,16],[0,255,0]];for((e=document.createElement("div")).style.cursor="pointer",e.style.width="80px",e.style.opacity="0.9",e.style.zIndex="10001",e.addEventListener("mousedown",function(e){e.preventDefault(),0==(l=(l+1)%2)?(i.style.display="block",a.style.display="none"):(i.style.display="none",a.style.display="block")},!1),(i=document.createElement("div")).style.textAlign="left",i.style.lineHeight="1.2em",i.style.backgroundColor="rgb("+Math.floor(g[0][0]/2)+","+Math.floor(g[0][1]/2)+","+Math.floor(g[0][2]/2)+")",i.style.padding="0 0 3px 3px",e.appendChild(i),(r=document.createElement("div")).style.fontFamily="Helvetica, Arial, sans-serif",r.style.fontSize="9px",r.style.color="rgb("+g[1][0]+","+g[1][1]+","+g[1][2]+")",r.style.fontWeight="bold",r.innerHTML="FPS",i.appendChild(r),(n=document.createElement("div")).style.position="relative",n.style.width="74px",n.style.height="30px",n.style.backgroundColor="rgb("+g[1][0]+","+g[1][1]+","+g[1][2]+")",i.appendChild(n);n.children.length<74;)(t=document.createElement("span")).style.width="1px",t.style.height="30px",t.style.cssFloat="left",t.style.backgroundColor="rgb("+g[0][0]+","+g[0][1]+","+g[0][2]+")",n.appendChild(t);for((a=document.createElement("div")).style.textAlign="left",a.style.lineHeight="1.2em",a.style.backgroundColor="rgb("+Math.floor(y[0][0]/2)+","+Math.floor(y[0][1]/2)+","+Math.floor(y[0][2]/2)+")",a.style.padding="0 0 3px 3px",a.style.display="none",e.appendChild(a),(s=document.createElement("div")).style.fontFamily="Helvetica, Arial, sans-serif",s.style.fontSize="9px",s.style.color="rgb("+y[1][0]+","+y[1][1]+","+y[1][2]+")",s.style.fontWeight="bold",s.innerHTML="MS",a.appendChild(s),(o=document.createElement("div")).style.position="relative",o.style.width="74px",o.style.height="30px",o.style.backgroundColor="rgb("+y[1][0]+","+y[1][1]+","+y[1][2]+")",a.appendChild(o);o.children.length<74;)(t=document.createElement("span")).style.width="1px",t.style.height=30*Math.random()+"px",t.style.cssFloat="left",t.style.backgroundColor="rgb("+y[0][0]+","+y[0][1]+","+y[0][2]+")",o.appendChild(t);return{domElement:e,update:function(){h=Date.now(),v=h-u,S=Math.min(S,v),_=Math.max(_,v),s.textContent=v+" MS ("+S+"-"+_+")";var e=Math.min(30,30-v/200*30);o.appendChild(o.firstChild).style.height=e+"px",u=h,c++,h>d+1e3&&(p=Math.round(1e3*c/(h-d)),f=Math.min(f,p),m=Math.max(m,p),r.textContent=p+" FPS ("+f+"-"+m+")",e=Math.min(30,30-p/100*30),n.appendChild(n.firstChild).style.height=e+"px",d=h,c=0)}}};define("DS/VisuUnstreamers/StreamObject",["UWA/Class"],function(e){"use strict";var t=e.extend({init:function(e,t){return this.blob=e,this.filename=t,this.blob&&!this.blob.userData&&(this.blob.userData={}),this},open:function(){},close:function(){},getUserData:function(){return this.blob?this.blob.userData:null},readAsArrayBuffer:function(){},readAsBlob:function(){},readAsText:function(){},readAsXML:function(){}});return UWA.namespace("THREEDS/StreamObject",t)}),define("VisuUnstreamers/StreamObject",["DS/VisuUnstreamers/StreamObject","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuUnstreamers/StreamObject"),e});for(var _materialsBase="DS/Materials/",_toLoad=["DeferrableMaterial","DeferredCaches","LineBasicMaterial","LineDSMaterial","Material","MeshBasicMaterial","MeshLambertMaterial","MeshPhongMaterial","ParticleBasicMaterial","PhysicalMaterial","CATGraphicalMaterial","ShaderMaterial","ShaderMaterialDS","DSPBR19x","DSPBR21x","DSPBR22x","DSPBR23x","GASPBR","OutlineMaterial","SectionBuilderMaterial","OldInfraMaterial","CubeMapMaterial","FiniteEnvMapMaterial","FiniteTransitionEnvMapMaterial","GradientBackgroundMaterials","LatLongMapMaterial","SimpleMapMaterial","GridMaterial","SmallPlaneMaterial","PlaneMaterial","ShaderDynamicPrefixBuilder"],i=0;i<_toLoad.length;i++)_toLoad[i]=_materialsBase+_toLoad[i];_toLoad.push("DS/Mesh/ThreeJS_Base"),define("DS/Visualization/Materials",_toLoad,function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E,T,A,I){"use strict";return{cleanPredefinedMaterialTextureCache:function(){for(var e=t._loadPredefinedMaterialTextures(!0,function(){},!0),i=0;i<e.length;i++)e[i].loadEndStatus===I.AssetLoadingStatus.READY&&e[i].dispose()},cleanPredefinedMaterialCache:function(){for(var e=[t.PredefinedMaterials],i=0;i<e.length;i++)e[i].forEach(function(e,t,i){var r,n;if(e.material.dispose)e.material.dispose();else for(r in e.material)(n=e.material[r])&&n.dispose&&n.dispose();i.delete(t)})},cleanDeferredCache:function(e){for(var i=[t.DefaultNormalDepthMaterials,t.DefaultShadowDepthMaterials,t.DefaultPickingMaterials,t.DefaultHighlightMaterials,t.DefaultMaterials,t.GeomTypeMaterials,t.PredefinedMaterials],r=0;r<i.length;r++)i[r].forEach(function(t,i,r){if(t.usedBy.delete(e),t.usedBy.size<1){var n,a;if(t.material.dispose)t.material.dispose();else for(n in t.material)(a=t.material[n])&&a.dispose&&a.dispose();r.delete(i)}})},DeferrableMaterial:e,LineBasicMaterial:i,LineDSMaterial:r,Material:n,MeshBasicMaterial:a,MeshLambertMaterial:s,MeshPhongMaterial:o,ParticleBasicMaterial:l,PhysicalMaterial:c,_CATGraphicalMaterial:h,ShaderMaterial:u,ShaderMaterialDS:d,DSPBR19xMaterial:p,DSPBR21xMaterial:f,DSPBR22xMaterial:m,DSPBR23xMaterial:g,_GASPBRMaterial:v,_OutlineMaterial:S._OutlineMaterial,_WideOutlineMaterial:S._WideOutlineMaterial,_SectionMaterial:_._SectionMaterial,_WideSectionMaterial:_._WideSectionMaterial,_OldInfraMaterial:y,CubeMapMaterial:x,FiniteEnvMapMaterial:M,FiniteTransitionEnvMapMaterial:P,GradientBackgroundMaterial2:C.GradientBackgroundMaterial2,GradientBackgroundMaterial3:C.GradientBackgroundMaterial3,GradientBackgroundMaterial4:C.GradientBackgroundMaterial4,LatLongMapMaterial:b,SimpleMapMaterial:D,GridMaterial:w,SmallPlaneMaterial:E,PlaneMaterial:T,ShaderDynamicPrefixBuilder:A}}),define("DS/Visualization/IdPathWatcher",["DS/CoreEvents/Events"],function(e){"use strict";var t=function(t){this.viewer=t.viewer,this.onIdPathActiveCB=t.onIdPathActiveCB,this.onIdPathInactiveCB=t.onIdPathInactiveCB,this.idPathes=new Map,this.macroNodes=new Map,this.token=e.subscribe({event:"/VISU/onSceneGraphUpdate"},this.onSceneGraphUpdate.bind(this))};t.prototype.addIdPath=function(e,t){var r=this.idPathes.get(t);r||(r=new i(t),this.idPathes.set(t,r),this.addIdPath_internal(e,r))},t.prototype.removeIdObject=function(e){var t=this.idPathes.get(e);if(t){var i,r,n=t.firstNode;if(n.single)(i=n.macroNode).removeSingleNode(n),i.isEmpty()&&this.macroNodes.delete(i.id),n.macroNode=null;else for(;null!==n;)(i=n.macroNode).removeNode(n),i.isEmpty()&&this.macroNodes.delete(i.id),n.macroNode=null,r=n.nextNode,n.nextNode=null,n=r;t.firstNode=null,this.idPathes.delete(e)}},t.prototype.addIdPath_internal=function(e,t){var i,r=e.ids,n=1===r.length;if(t.count+=r.length,0!==r.length){var s=this.viewer.getIdPathMatcher(),o=null,l=this.createNode(r[0],t,n),c=null,h=s.idToNode(r[0]);for(t.firstNode=l,i=0;i<r.length-1;i++)o=l,l=this.createNode(r[i+1],t),o.nextNode=l,a(c=h,h=s.idToNode(l.macroNode.id))&&(o.active=!0,t.count--);o=l,c=h,n?o.single=!0:t.count--,o.single&&c&&c._hasOccurrenceInViewer(this.viewer)&&(o.active=!0,t.count--),0===t.count&&this.onIdPathActiveCB(t.idObject)}},t.prototype.getMacroNode=function(e){var t=this.macroNodes.get(e);return t||(t=new r(e),this.macroNodes.set(e,t)),t},t.prototype.createNode=function(e,t,i){var r=this.getMacroNode(e);return i?r.createSingleNode(t):r.createNode(t)},t.prototype.onSceneGraphUpdate=function(e){"ADD"===e.eventType?this.onAddChild(e.fromNode,e.toNode):"REMOVE"===e.eventType&&this.onRemoveChild(e.fromNode,e.toNode)},t.prototype.onAddChild=function(e,t){var i=this.viewer.getIdPathMatcher(),r=i.nodeToId(e),n=i.nodeToId(t),a=this.macroNodes.get(r),s=this.macroNodes.get(n);s&&a&&a.onAddChild(s,this,e),a&&a.onAddSingle(this,e),s&&s.onAddSingle(this,t)},t.prototype.onRemoveChild=function(e,t){var i=this.viewer.getIdPathMatcher(),r=i.nodeToId(e),n=i.nodeToId(t),a=this.macroNodes.get(r),s=this.macroNodes.get(n);s&&a&&(a.onRemoveChild(s,this),s.onRemoveSingle(this))},t.prototype.getIdPathMatcher=function(){return this.viewer.getIdPathMatcher()},t.prototype.dispose=function(){this.token&&(e.unsubscribe(this.token),this.token=null)};var i=function(e){this.idObject=e,this.count=0,this.firstNode=null},r=function(e){this.id=e,this.firstChainedNode=null,this.firstChainedSingleNode=null};r.prototype.getNode3D=function(e){return e.getIdPathMatcher().idToNode(this.id)},r.prototype.createNode=function(e){var t=new n(this);return t.idPath=e,t.nextChainedNode=this.firstChainedNode,this.firstChainedNode=t,t},r.prototype.createSingleNode=function(e){var t=new n(this);return t.idPath=e,t.nextChainedNode=this.firstChainedSingleNode,this.firstChainedSingleNode=t,t},r.prototype.onAddChild=function(e,t,i){for(var r=this.firstChainedNode;r;)r.nextNode&&r.nextNode.macroNode===e&&r.activate(t),r=r.nextChainedNode},r.prototype.onAddSingle=function(e,t){for(var i=this.firstChainedSingleNode;i;)i.activate(e),i=i.nextChainedNode},r.prototype.onRemoveChild=function(e,t){for(var i=this.firstChainedNode;i;)i.nextNode&&i.nextNode.macroNode===e&&i.deactivate(t),i=i.nextChainedNode},r.prototype.onRemoveSingle=function(e){for(var t=this.firstChainedSingleNode,i=null;t;)t.single&&t.active&&(null===i&&(i=this.getNode3D(e)),null!=i&&0!==i.parents.length||t.deactivate(e)),t=t.nextChainedNode},r.prototype.removeNode=function(e){var t=this.firstChainedNode;if(t===e)this.firstChainedNode=e.nextChainedNode;else{for(;null!==t.nextChainedNode&&t.nextChainedNode!==e;)t=t.nextChainedNode;t.nextChainedNode===e&&(t.nextChainedNode=e.nextChainedNode)}},r.prototype.removeSingleNode=function(e){var t=this.firstChainedSingleNode;if(t===e)this.firstChainedSingleNode=e.nextChainedNode;else{for(;null!==t.nextChainedNode&&t.nextChainedNode!==e;)t=t.nextChainedNode;t.nextChainedNode===e&&(t.nextChainedNode=e.nextChainedNode)}},r.prototype.isEmpty=function(){return null===this.firstChainedNode&&null===this.firstChainedSingleNode};var n=function(e){this.macroNode=e,this.idPath=null,this.nextNode=null,this.active=!1,this.single=!1,this.nextChainedNode=null};function a(e,t){var i;if(e&&t)if(e.children.length<t.parents.length){for(i=0;i<e.children.length;i++)if(e.children[i]===t)return!0}else for(i=0;i<t.parents.length;i++)if(t.parents[i]===e)return!0;return!1}return n.prototype.activate=function(e){this.active||(this.active=!0,this.idPath.count--,0===this.idPath.count&&e.onIdPathActiveCB(this.idPath.idObject))},n.prototype.deactivate=function(e){var t=this.idPath.count;this.active&&(this.active=!1,this.idPath.count++,0===t&&e.onIdPathInactiveCB(this.idPath.idObject))},t}),function(){var e="file:"!==window.location.protocol?"text!Visualization/assets/svgmode.json":null;define("DS/Visualization/GetSVGMode",[e],function(e){var t=e&&JSON.parse(e);return{getWebGLMode:function(){return!(t&&"svg"===t.svgMode||window.v6ViewerSVGBrowserMode)}}})}(),define("DS/VisuStateOverride/SceneGraphState",["DS/SceneGraphOverrides/SceneGraphState"],function(e){return e}),define("VisuStateOverride/SceneGraphState",["DS/SceneGraphOverrides/SceneGraphState"],function(e){return e}),define("DS/VisuDataAccess/Ox4XHRWithProxyAbstraction",["UWA/Class","UWA/Data","UWA/Utils","UWA/Utils/Client","UWA/Ajax","UWA/Json","DS/WAFData/WAFData"],function(e,t,i,r,n,a,s){"use strict";var o=function(){this.executeGetHttpRequest=function(t,i,r,n){if(2===o.proxyUsage){var a=new Object;a.headers=new Object,a.data=new Object,a.data.GET=r,a.method="GET",a.async=!0,a.proxy=o.proxymode,a.authentication=o.authentication,a.onComplete=n,a.type=i;s.handleRequest(t,a)}else{1===o.proxyUsage&&(t=e(t,o.server,o.sport));var l=new XMLHttpRequest;l.open("GET",t,!0),l.onload=function(e){n(this.response)},l.setRequestHeader("X-Requested-With","XMLHttpRequest"),"arraybuffer"===i&&(l.responseType=i),l.send(r)}},this.executePostHttpRequest=function(t,i,r,n){if(2==o.proxyUsage){var a={timeout:3e5,method:"POST",data:r,type:"text",proxy:o.proxymode,authentication:o.authentication,headers:{"Content-type":i,Accept:"text/plain"},onComplete:n,onFailure:function(e){UWA.log("arguments onFailure"),UWA.log(arguments)}};o.securityToken&&(a.headers.SecurityToken=o.securityToken);s.handleRequest(t,a)}else{1==o.proxyUsage&&(t=e(t,o.server,o.sport));var l=new XMLHttpRequest;l.open("POST",t),l.onload=function(e){n(this.response)},l.setRequestHeader("Content-type",i),l.setRequestHeader("Accept","text/plain"),l.send(r)}},this.executePostHttpRequestWithOptions=function(t,i){if(2==o.proxyUsage){i.timeout=3e5,i.method="POST",i.type=i.type?i.type:"text",i.proxy=o.proxymode,i.authentication=o.authentication,i.onFailure=i.onFailure?i.onFailure:function(e){UWA.log("arguments onFailure"),UWA.log(arguments)},!i.headers||i.headers,!i.headers.Accept||i.headers.Accept;s.handleRequest(t,i)}else{1==o.proxyUsage&&(t=e(t,o.server,o.sport));var r=new XMLHttpRequest;r.open("POST",t),r.onload=function(e){callback(this.response)},r.setRequestHeader("Content-type",i.headers.Content-type),r.setRequestHeader("Accept",i.headers.Accept?i.headers.Accept:"text/plain"),r.send(postParams)}},this.executePostHttpRequest2=function(t,i,r,n,a){if(2==o.proxyUsage){var l={timeout:3e5,method:"POST",data:r,type:"text",proxy:o.proxymode,authentication:o.authentication,headers:{"Content-type":i,Accept:"text/plain"},onComplete:n,onFailure:function(e){UWA.log("arguments onFailure"),UWA.log(arguments)}};null!=a.responseType&&(l.type=a.responseType);s.handleRequest(t,l)}else{1==o.proxyUsage&&(t=e(t,o.server,o.sport));var c=new XMLHttpRequest;c.open("POST",t),c.onload=function(e){n(this.response)},c.setRequestHeader("Content-type",i),c.setRequestHeader("Accept","application/octet-stream"),null!=a.responseType&&(c.responseType=a.responseType),c.send(r)}},this.executeSyncPostHttpRequest=function(t,i,r){if(2==o.proxyUsage){var n,a={timeout:3e5,method:"POST",data:r,type:"text",proxy:o.proxymode,authentication:o.authentication,async:!1,headers:{"Content-type":i,Accept:"text/plain"},onComplete:function(e){console.warn("retour >data",e),n=e},onFailure:function(e){console.log("arguments onFailure"),console.log(arguments)}};o.securityToken&&(a.headers.SecurityToken=o.securityToken);s.handleRequest(t,a);return n}1==o.proxyUsage&&(t=e(t,o.server,o.sport));var l=new XMLHttpRequest;return l.open("POST",t,!1),l.setRequestHeader("Content-type",i),l.setRequestHeader("Accept","text/plain"),l.send(r),l.responseText},this.transformUrlIntoRealUrl=function(t){if(2==o.proxyUsage){console.log("WAFData No Proxyfication");new Object;return t}return 1==o.proxyUsage?t=e(t,o.server,o.sport):t},this.asyncTransformFCSUrlIntoRealUrl=function(e,t,i){var r=e.url,n=e.data,a="application/xml";"boolean"==typeof t&&t&&(a="application/xmql"),this.executePostHttpRequest(r,a,n,function(t){var r=/\{\{([^\}]*)\}\{([^\}]*)\}\}/.exec(t),n=r[1],a="posthttp:"+r[2]+":postparams:__fcs__jobTicket="+encodeURIComponent(n);i(e,a)})};var e=function(e,t,i){var r=e.indexOf("/"),n=e.indexOf("/",r+2);return e.slice(0,r)+"//"+t+":"+i+e.slice(n,e.length)}};return o.useNoProxy=function(){o.proxyUsage=0,o.server=null,o.sport=null},o.useProxyDefinedBy=function(e,t){o.proxyUsage=1,o.server=e,o.sport=t},o.useUWAProxy=function(e){o.proxyUsage=2,o.server=null,o.sport=null,o.proxymode=e.proxymode,o.authentication=e.proxymode,e.contextid&&e.login&&(o.securityToken=e.login+"|"+e.contextid)},o}),define("VisuDataAccess/Ox4XHRWithProxyAbstraction",["DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/Ox4XHRWithProxyAbstraction"),e}),define("DS/Visualization/OccurrencePath",["UWA/Class"],function(e){"use strict";var t=e.extend({init:function(e){this.path=[],this.setFromArray(e)},getSize:function(){return this.path.length},getNodeName:function(e){return e<0||e>=this.path.length?null:this.path[e]},add:function(e){this.path.push(e)},setFromArray:function(e){var t;if(void 0!==e&&e instanceof Array)for(t=0;t<e.length;t++)""!==e[t]&&this.path.push(e[t])},isEqual:function(e){var t;if(this.path.length!==e.path.length)return!1;for(t=0;t<e.path.length;t++)if(this.path[t]!==e.path[t])return!1;return!0},isIncludedIn:function(e){var t,i,r,n=!1;for(i=0;i<this.path.length;i++){for(t=this.path[i],n=!1,r=0;r<e.path.length;r++)if(t===e.path[r]){n=!0;break}if(!n)return!1}return!0}});return UWA.namespace("THREEDS/OccurrencePath",t)}),define("Visualization/OccurrencePath",["DS/Visualization/OccurrencePath","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/OccurrencePath"),e}),define("DS/Visualization/PLMMaterialServicesItf",[],function(){"use strict";var e=function(){this.implementation=null};return e.prototype.setImplementation=function(e){this.implementation=e},e.prototype.loadMaterials=function(e,t,i){this.implementation.loadMaterials(e,t,i)},e.prototype.loadMaterialConnections=function(e,t){this.implementation.loadMaterialConnections(e,t)},new e}),define("DS/Visualization/IdPathMatcher",[],function(){"use strict";var e=function(e){this._idToNodeCB=e.idToNodeCB,this._nodeToIdCB=e.nodeToIdCB,this._isNodeRepRefCB=e.isNodeRepRefCB};return e.prototype.idToNode=function(e){return this._idToNodeCB(e)},e.prototype.nodeToId=function(e){return this._nodeToIdCB(e)},e.prototype.isNodeRepRef=function(e){return this._isNodeRepRefCB(e)},e}),define("DS/VisuDataAccess/Ox4DataAccessObjectFactory",[],function(){"use strict";var e=function(){};return e.createServerDefinition2=function(e,t,i,r){var n=new Object;return void 0===e?(console.log("No Hostname in CreateServerDefinition"),null):(n.hostname=e,void 0===t?(console.log("No RootUri in CreateServerDefinition"),null):(n.rooturi=t,n.isSecure=!1,void 0!==i&&i&&(n.isSecure=!0),n.port=-1,void 0!==r&&(n.port=r),n.xmqlServiceUri=function(e){var t="http://";this.isSecure&&(t="https://");var i=t+this.hostname;return-1!=this.port&&(i+=":"+this.port),i+="/"+this.rooturi+"/i3dx/services/xmql","boolean"==typeof e&&e&&(i+="?raw=true"),i},n))},e.createServerDefinition=function(e,t,i){var r=new Object;return r.hostname=e,r.port=t,r.rooturi=i,r.xmqlServiceUri=function(){return"http://"+this.hostname+":"+this.port+"/"+this.rooturi+"/i3dx/services/xmql?raw=true"},r},e.createDisplayObjectSpecification=function(e,t){var i=new Object;return i.physicalid=e,i.serverdefinition=t,i},e}),define("VisuDataAccess/Ox4DataAccessObjectFactory",["DS/VisuDataAccess/Ox4DataAccessObjectFactory","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/Ox4DataAccessObjectFactory"),e}),define("DS/VisuDataAccess/Ox4TaskPlanner",[],function(){"use strict";return function(){var e=new Array,t=0,i=null;this.addSequentialTask=function(t){var i=new Array;i.push(t),e.push(i)},this.addEndingTask=function(e){i=e},this.endingTask=function(){return i},this.next=function(){return t<e.length?e[(t+=1)-1]:null},this.resetIterator=function(){t=0},this.tasksCount=function(){return e.length},this.currentTaskIndex=function(){return t}}}),define("VisuDataAccess/Ox4TaskPlanner",["DS/VisuDataAccess/Ox4TaskPlanner","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/Ox4TaskPlanner"),e}),define("DS/Shaders/LowLightShaders",[],function(){"use strict";return{backgroundviewmode_lowlight_fragment:"\n\t\t\t#ifdef USE_BACKGROUNDVIEWMODE_LOWLIGHT\n\t\t\t\tif(background_view_mode_control.w > 0.0)\n\t\t\t\t{\n\t\t\t\t\tgl_FragColor.xyz *= 0.55;\n\t\t\t\t}\n\t\t\t#endif\n\t\t"}}),define("DS/Visualization/SessionNodesWithSectionProfile",[],function(){"use strict";return null}),define("DS/Shaders/DefaultShaders",[],function(){"use strict";var e=["uniform int mappingType;","uniform mat3 mappingNormTransformation;","uniform mat4 mappingObjTransformation;","uniform mat3 mappingUVTransformation;","uniform int mappingTransformSemantic;","mat4 mappingTranspose(in mat4 m){","vec4 i0 = m[0];","vec4 i1 = m[1];","vec4 i2 = m[2];","vec4 i3 = m[3];","mat4 outMatrix = mat4(","vec4(i0.x, i1.x, i2.x, i3.x),","vec4(i0.y, i1.y, i2.y, i3.y),","vec4(i0.z, i1.z, i2.z, i3.z),","vec4(i0.w, i1.w, i2.w, i3.w));","return outMatrix;","}","vec2 applyMappingOperator(in vec2 inUV, in vec3 pos, in vec3 norm, in int type, inout vec3 outTangent,inout vec3 outBinormal) {","vec2 outUV = inUV;","mat4 invMappingObjTransformation = mappingTranspose(mappingObjTransformation);","vec3 x = vec3(invMappingObjTransformation[0]);","vec3 y = vec3(invMappingObjTransformation[1]);","vec3 z = vec3(invMappingObjTransformation[2]);","vec3 localpos = (mappingObjTransformation * vec4(pos, 1.0)).xyz; ","vec3 localnorm = (mappingObjTransformation * vec4(norm, 0.0)).xyz; ","if (type == 1) {","outUV = localpos.xy;","outTangent = x;","outBinormal = y;","} else if (type == 2) {","float radius3d = max(0.000001,length(localpos.xyz));","float z_by_radius3d = localpos.z / radius3d;","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float phiMapping   = asin(z_by_radius3d );","float u=thetaMapping*radius3d;","float v=phiMapping*radius3d;","outUV = vec2(u, v);","float cos_theta = cos(thetaMapping);","float sin_theta = sin(thetaMapping);","float cos_phi = cos(phiMapping);","float sin_phi = z_by_radius3d;","outTangent = -sin_theta*x + cos_theta*y;","outBinormal = -cos_theta*sin_phi*x - sin_theta*sin_phi*y + cos_phi*z;","} else if (type == 6) {","float radius3d = max(0.000001,length(localpos.xyz));","float z_by_radius3d = localpos.z / radius3d;","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float phiMapping   = asin(z_by_radius3d );","float u=thetaMapping/3.14159;","float v=phiMapping/3.14159;","outUV = vec2(u, v);","float cos_theta = cos(thetaMapping);","float sin_theta = sin(thetaMapping);","float cos_phi = cos(phiMapping);","float sin_phi = z_by_radius3d;","outTangent = -sin_theta*x + cos_theta*y;","outBinormal = -cos_theta*sin_phi*x - sin_theta*sin_phi*y + cos_phi*z;","} else if (type == 3) {","vec3 absolute_normal = abs(localnorm);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","#ifdef DSPBR","vec3 n = normalize(localnorm);","if(dot(localpos,localnorm)<0.0){","n = -n;","}","#else","vec3 n = normalize(localpos);","#endif","vec3 s;","s.x = n.x >= -0.0000001 ?  1.0 : -1.0;","s.y = n.y >= -0.0000001 ? -1.0 :  1.0;","s.z = n.z >= -0.0000001 ?  1.0 : -1.0;","if(maxima_normal == absolute_normal.x){","outUV = vec2(s.x * localpos.y, localpos.z );","outTangent = s.x * y;","outBinormal = z;","}","else if(maxima_normal == absolute_normal.y){","outUV = vec2(s.y * localpos.x, localpos.z );","outTangent = s.y * x;","outBinormal = z;","}","else{","outUV = vec2(s.z * localpos.x, localpos.y );","outTangent = s.z * x;","outBinormal = y;","}","} else if (type == 4) {","vec3 n = localnorm;","#ifdef DSPBR","if(dot(localpos,localnorm)<0.0){","n = -n;","}","#endif","float radius2d = length(localpos.xy);","vec3 absolute_normal = abs(n);","float maxima_normal = max(absolute_normal.x, max(absolute_normal.y, absolute_normal.z));","if(maxima_normal == absolute_normal.z){","float s = localpos.z >= 0.0 ?  1.0 : -1.0;","outUV.x = s * localpos.x;","outUV.y = localpos.y;","outTangent = s * x;","outBinormal = y;","}else{","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0){","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","outUV = vec2(u , localpos.z);","float cos_theta = cos(thetaMapping);","float sin_theta = sin(thetaMapping);","outTangent = -sin_theta*x + cos_theta*y;","outBinormal = z;","}","} else if (type == 5) {","float radius2d = length(localpos.xy);","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping*radius2d;","outUV = vec2(u, localpos.z);","float cos_theta = cos(thetaMapping);","float sin_theta = sin(thetaMapping);","outTangent = -sin_theta*x + cos_theta*y;","outBinormal = z;","} else if (type == 7) {","float radius2d = length(localpos.xy);","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping/3.14159;","outUV = vec2(u, localpos.z/(radius2d*3.14159));","float cos_theta = cos(thetaMapping);","float sin_theta = sin(thetaMapping);","outTangent = -sin_theta*x + cos_theta*y;","outBinormal = z;","} else if (type == 8) {","float thetaMapping=0.0;","if (localpos.y!=0.0 || localpos.x!=0.0) {","thetaMapping = atan(localpos.y, localpos.x);}","float u=thetaMapping/3.14159;","outUV = vec2(u, localpos.z);","float cos_theta = cos(thetaMapping);","float sin_theta = sin(thetaMapping);","outTangent = -sin_theta*x + cos_theta*y;","outBinormal = z;","}","if(type >0){","outTangent= normalize(cross(outBinormal,norm));","outBinormal= normalize(cross(norm,outTangent));","}","if (mappingTransformSemantic==1){","   return (mappingUVTransformation * vec3(outUV, 1.0)).xy;","}else{","   return outUV;","}","}","vec2 applyMappingOperator(in vec2 inUV, in vec3 pos, in vec3 norm, inout vec3 outTangent,inout vec3 outBinormal) {","return applyMappingOperator(inUV, pos, norm, mappingType, outTangent, outBinormal);","}","vec2 applyMappingOperator(in vec2 inUV, in vec3 pos, in vec3 norm, in int type) {","vec3 bogusTangent;","vec3 bogusBinormal;","return applyMappingOperator(inUV,pos,norm,type, bogusTangent,bogusBinormal);","}","vec2 applyMappingOperator(in vec2 inUV, in vec3 pos, in vec3 norm) {","vec3 bogusTangent;","vec3 bogusBinormal;","return applyMappingOperator(inUV,pos,norm,bogusTangent,bogusBinormal);","}"].join("\n");return{model_view_transformation_vertex:["#if defined(BILLBOARD) || defined(FIXED_SIZE)","setSimpleNodeData();","#endif","auxPosMV = position;","#ifdef BILLBOARD","auxPosMV = (simpleNodeData.billboardMatrix * vec4(auxPosMV,1.0)).xyz;","#endif","#ifdef FIXED_SIZE","auxPosMV *= simpleNodeData.fixedSizeScale;","#ifdef FIXED_SIZE_CENTER","auxPosMV += simpleNodeData.fixedSizeScaleCenter * fixedSizeCenterRatio.xyz;","#endif","#endif","vec4 mvPosition = computeModelViewPosition(auxPosMV);"].join("\n"),model_view_projection_transformation_vertex:["#if defined(BILLBOARD) || defined(FIXED_SIZE)","setSimpleNodeData();","#endif","auxPosMVP = position;","#ifdef BILLBOARD","auxPosMVP = (simpleNodeData.billboardMatrix * vec4(auxPosMVP,1.0)).xyz;","#endif","#ifdef FIXED_SIZE","auxPosMVP *= simpleNodeData.fixedSizeScale;","#ifdef FIXED_SIZE_CENTER","auxPosMVP += simpleNodeData.fixedSizeScaleCenter * fixedSizeCenterRatio.xyz;","#endif","#endif","gl_Position = projectionMatrix * computeModelViewPosition(auxPosMVP);"].join("\n"),model_view_normal_vertex:["#if defined(BILLBOARD) || defined(FIXED_SIZE)","setSimpleNodeData();","#endif","vec3 mvNormal = normal;","#if defined(BILLBOARD)","mvNormal = (simpleNodeData.billboardMatrix * vec4(mvNormal,0.0)).xyz;","#endif","if (use_normal_matrix)","mvNormal = normalMatrix * mvNormal;","else {","mvNormal = vec3(modelViewMatrix * vec4(mvNormal, 0.0));","}","mvNormal = normalize( mvNormal );"].join("\n"),getModelViewTransformationChunk:function(e,t){return["#if defined(BILLBOARD) || defined(FIXED_SIZE)","setSimpleNodeData();","#endif","auxPosMVPFunc = "+t+";","#ifdef BILLBOARD","auxPosMVPFunc = simpleNodeData.billboardMatrix * auxPosMVPFunc;","#endif","#ifdef FIXED_SIZE","auxPosMVPFunc.xyz *= simpleNodeData.fixedSizeScale;","#ifdef FIXED_SIZE_CENTER","auxPosMVPFunc.xyz += auxPosMVPFunc.w * simpleNodeData.fixedSizeScaleCenter * fixedSizeCenterRatio.xyz;","#endif","#endif",e+" = computeModelViewPosition(auxPosMVPFunc.xyz);"].join("\n")},getModelViewUnitVectorTransformationChunk:function(e,t){return["#if defined(BILLBOARD) || defined(FIXED_SIZE)","setSimpleNodeData();","#endif","MVUnit = "+t+";","#if defined(BILLBOARD)","MVUnit = (simpleNodeData.billboardMatrix * vec4(MVUnit,0.0)).xyz;","#endif",e+" = vec3(modelViewMatrix * vec4(MVUnit, 0.0));"].join("\n")},map_pars_vertex:["#if defined(MAPPING_OPERATOR)",e,"#endif","#if defined (MAPPING_OPERATOR) && !defined (USE_MAPPING_OPERATOR_VERTEX)","varying vec3 localPosition;","varying vec3 localNormal;","#endif"].join("\n"),map_pars_fragment:["#if defined (MAPPING_OPERATOR)",e,"#endif","#if defined (USE_MAPPING_OPERATOR_FRAGMENT) && defined (MAPPING_OPERATOR)","varying vec3 localPosition;","varying vec3 localNormal;","#endif"].join("\n"),rgbe_sample_methods:["vec4 texture2DFromRGBE(sampler2D textureSampler, vec2 uv) {","vec4 texelRGBE = texture2D(textureSampler, uv);","float exponent = pow(2.0, 255.0 * texelRGBE.w - 128.0);","return vec4(texelRGBE.xyz * exponent, 1.0);","}","vec4 texture2DBilinearFromRGBE(sampler2D textureSampler, vec2 uv, vec2 textureSize, vec2 texelSize) {","vec2 st = uv * textureSize - 0.5;","vec2 iuv = (floor(st) + vec2(0.5)) * texelSize;","vec2 fuv = fract(st);","vec4 tl = texture2DFromRGBE(textureSampler, iuv);","vec4 tr = texture2DFromRGBE(textureSampler, iuv + vec2(texelSize.x, 0.0));","vec4 bl = texture2DFromRGBE(textureSampler, iuv + vec2(0.0, texelSize.y));","vec4 br = texture2DFromRGBE(textureSampler, iuv + vec2(texelSize.x, texelSize.y));","vec4 tA = mix(tl, tr, fuv.x);","vec4 tB = mix(bl, br, fuv.x);","return mix(tA, tB, fuv.y);","}","vec2 get2DBilinearFromRGBEwBOXUV(in vec2 iuv, in vec2 offset, in vec2 factor, in vec2 start) {","float x = mod(iuv.x + offset.x, factor.x) + start.x;","float y = iuv.y + offset.y;","return vec2(x,y);","}","vec4 texture2DBilinearFromRGBEwBox(sampler2D textureSampler, vec4 uvBox, vec2 uv, vec2 textureSize, vec2 texelSize) {","#ifdef NON_REPEAT_IBL_SAMPLING","return texture2DBilinearFromRGBE(textureSampler, uvBox.xy, textureSize, texelSize);","#else","vec2 start = uvBox.xy;","vec2 factor = uvBox.zw;","vec2 fetchUVToUse = factor* uv + start;","vec2 st = fetchUVToUse * textureSize - 0.5;","vec2 iuv = (floor(st) + vec2(0.5)) * texelSize;","vec2 fuv = fract(st);","vec4 tl = texture2DFromRGBE(textureSampler, get2DBilinearFromRGBEwBOXUV(iuv, vec2(0.0, 0.0), factor, start));","vec4 tr = texture2DFromRGBE(textureSampler, get2DBilinearFromRGBEwBOXUV(iuv, vec2(texelSize.x, 0.0), factor, start));","vec4 bl = texture2DFromRGBE(textureSampler, get2DBilinearFromRGBEwBOXUV(iuv, vec2(0.0, texelSize.y), factor, start));","vec4 br = texture2DFromRGBE(textureSampler, get2DBilinearFromRGBEwBOXUV(iuv, vec2(texelSize.x, texelSize.y), factor, start));","vec4 tA = mix(tl, tr, fuv.x);","vec4 tB = mix(bl, br, fuv.x);","return mix(tA, tB, fuv.y);","#endif","}"].join("\n"),normal_viewposition_pars_vertex:["#ifndef PDSFX","varying vec3 vViewPosition;","varying vec3 vNormal;","#endif"].join("\n"),normal_viewposition_vertex:["#ifndef PDSFX","vNormal = normalize( transformedNormal );","vViewPosition = -mvPosition.xyz;","#else","transformedNormal = _viewTangentSpace.Normal;","#endif"].join("\n"),normal_viewposition_pars_fragment:["#ifndef PDSFX","varying vec3 vViewPosition;","varying vec3 vNormal;","#else","vec3 vViewPosition;","#endif"].join("\n"),normal_viewposition_fragment:["#ifdef PDSFX","vec3 normal = _DSvNormal;","#else","vec3 normal = normalize( vNormal );","#endif","#ifdef DOUBLE_SIDED","normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","vec3 viewPosition = normalize( vViewPosition );","vec3 vPos = vViewPosition;"].join("\n")}}),define("DS/VisuDataAccess/Ox4StreamUnStreamerTaskDefinition",[],function(){"use strict";return function(e,t,i){var r=e;this.streamReceived=t,this.streamsNumber=i,this.responseType=null,this.typeRequested=function(){return r}}}),define("DS/Visualization/WebGLObjectManager",[],function(){"use strict";var e=function(e,t){this.object=t,this.frustumCulled=t.frustumCulled};e.prototype._performCulling=function(e,t,i,r){var n=i.worldCenter,a=i.worldRadius;r.currentRenderPointsOnly=!1;var s=!1;if(e.pixelCulling>0){var o=e.pixelCullingCst;if(!e.isOrtho){var l=e.matrixWorldInverse.elements;o*=Math.abs(l[2]*n.x+l[6]*n.y+l[10]*n.z+l[14])}a<o&&(!1===i.hasPoint?s=!0:r.currentRenderPointsOnly=!0)}return r.previousRenderPointsOnly!==r.currentRenderPointsOnly&&(r.invalidated=!0,r.previousRenderPointsOnly=r.currentRenderPointsOnly),!s&&t.performFrustumCulling(a,n)};var t=function(t,i){e.call(this,t,i)};(t.prototype=Object.create(e.prototype))._performCulling=function(e,t,i,r){var n=i.worldCenter,a=i.worldRadius;if(e.pixelCulling>0){var s=e.pixelCullingCst;if(!e.isOrtho){var o=e.matrixWorldInverse.elements;s*=Math.abs(o[2]*n.x+o[6]*n.y+o[10]*n.z+o[14])}if(a<s)return!1}return t.performFrustumCulling(a,n)};var i=function(e,i){t.call(this,e,i)};(i.prototype=Object.create(t.prototype))._performCulling=function(e,i,r,n){var a=t.prototype._performCulling.call(this,e,i,r,n);return a&&r._computeLOD(e,n),a};var r=function(t,i){e.call(this,t,i)};(r.prototype=Object.create(e.prototype))._performCulling=function(e,t,i,r){var n=i.worldCenter,a=i.worldRadius;r.currentRenderPointsOnly=!1;var s=!1,o=e.pixelCulling,l=e.matrixWorldInverse.elements;if(o>0&&a<o&&(!1===i.hasPoint?s=!0:r.currentRenderPointsOnly=!0),r.previousRenderPointsOnly!==r.currentRenderPointsOnly&&(r.invalidated=!0,r.previousRenderPointsOnly=r.currentRenderPointsOnly),s)return!1;var c=a*e.fixedSizeCameraConstant;return e.isOrtho||(c*=Math.abs(l[2]*n.x+l[6]*n.y+l[10]*n.z+l[14])),t.performFrustumCulling(c,n)};var n=function(){this.objects=[],this.idMap=new Map,this.nullCount=0,this.lastCleanFrame=0};return n.prototype._clean=function(){if(this.nullCount>1e3){this.idMap.clear(),this.objects=this.objects.filter(function(e){return null!==e}),this.nullCount=0;for(var e=0;e<this.objects.length;e++)this.idMap.has(this.objects[e].object)?this.idMap.get(this.objects[e].object).push(e):this.idMap.set(this.objects[e].object,[e])}},n.prototype.getObjects=function(e){return this._tryClean(e),this.objects},n.prototype._tryClean=function(e){if(0===this.lastCleanFrame&&e)this.lastCleanFrame=e;else if(this.nullCount>0&&(!e||e-this.lastCleanFrame>60)){if(this.idMap.clear(),this.nullCount===this.objects.length)this.objects=[];else{this.objects=this.objects.filter(function(e){return null!==e});for(var t=0;t<this.objects.length;t++)this.idMap.has(this.objects[t].object)?this.idMap.get(this.objects[t].object).push(t):this.idMap.set(this.objects[t].object,[t])}this.lastCleanFrame=e,this.nullCount=0}},n.prototype.add=function(e){null!==e&&(this.idMap.has(e.object)?this.idMap.get(e.object).push(this.objects.length):this.idMap.set(e.object,[this.objects.length]),this.objects.push(e))},n.prototype._remove=function(e){if(null===e)return!1;if(this.idMap.has(e)){for(var t=this.idMap.get(e),i=0;i<t.length;i++)this.objects[t[i]]=null,this.nullCount++;return this.idMap.delete(e),!0}return!1},n.prototype.remove=function(e){this._remove(e)&&this._clean()},n.prototype.removeCollection=function(e){var t=0,i=this;e.forEach(function(e,r,n){i._remove(e)&&t++}),t>0&&this._clean()},n.prototype.clear=function(){this.objects=[],this.nullCount=0,this.lastCleanFrame=0,this.idMap.clear()},n.__WebGLObject=e,n.__WebGLObjectNoPoints=t,n.__WebGLObjectCurvedPipe=i,n.__WebGLObjectFixedSize=r,n}),define("DS/Plugins/UserRenderList",["UWA/Class"],function(e){"use strict";var t=0;return e.extend({init:function(e){this.name=e,this.id=t++},_getIdString:function(){return"_userIdString_"+this.id+(this.name?"_"+this.name:"")}})}),define("DS/VisuDataAccess/Ox4TreeTarget",[],function(){"use strict";return function(e,t){var i={},r={},n=e,a=t;i[n.physicalid]=a("Node"),i[n.physicalid].id=n.physicalid;var s=i[n.physicalid];s.ident=n.physicalid,s.isrel=!1,null!=n.dtype&&(s.plmtype=n.dtype),this.FindRootNodeWorkType=function(){n.typeHelper.IsBusA(s.plmtype,n.shapeType)?s.worktype=n.shapeType:n.typeHelper.IsBusA(s.plmtype,"VPMReference")&&(s.worktype="VPMReference"),r[s.plmtype]=[s],s.worktype!==s.plmtype&&(r[s.worktype]=[s])},this.rootNode=function(){return s},this.registerRelationship=function(e){var t=this.findNodeByPhysicalId(e.phyid);t.boid=e.ident,t.id=e.phyid,t.plmtype=e.plmtype,t.worktype=e.plmtype,t.title=e.title,t.plmexternalId=e.realName,t.owner=e.owner,t.isrel=!0;var i=this.findNodeByPhysicalId(e.to.phyid);i.boid=e.to.ident,i.id=e.to.phyid,i.plmtype=e.to.plmtype,i.worktype=i.plmtype,i.title=e.to.title,i.plmexternalId=e.to.realName,i.owner=e.to.owner,i.isrel=!1,e.from.add(t),t.add(i)},this.countObjects=function(){var e=0;for(var t in i)i.hasOwnProperty(t)&&e++;return e},this.dumpObjects=function(){for(var e in i)i.hasOwnProperty(e)&&console.log(i[e]);return 0},this.FindWorkTypes=function(e,t){n.typeHelper.RegisterParentsTypes(e,function(){for(var e in i){i[e].isrel?n.typeHelper.IsRelA(i[e].plmtype,n.instanceType)&&(i[e].worktype=n.instanceType):n.referenceType&&n.typeHelper.IsBusA(i[e].plmtype,n.referenceType)?i[e].worktype=n.referenceType:n.typeHelper.IsBusA(i[e].plmtype,n.shapeType)&&(i[e].worktype=n.shapeType);var a=i[e].plmtype,s=i[e].worktype;r.hasOwnProperty(a)||(r[a]=[]),r[a].push(i[e]),s!==a&&(r.hasOwnProperty(s)||(r[s]=[]),r[s].push(i[e]))}t()})},this.findNodeByPhysicalId=function(e){return void 0===i[e]&&(i[e]=a("Node"),i[e].id=e),i[e]},this.findNodeByType=function(e){var t=[];return r.hasOwnProperty(e)&&(t=r[e]),t},this.findNodeByPLMTypeExpressedAsPhyIdSeparatedByComma=function(e){var t=[];r.hasOwnProperty(e)&&(t=r[e]);var i="";return t.forEach(function(e,r){i+=e.id,r<t.length-1&&(i+=",")}),i},this.findNodeByPLMTypeExpressedAsPhyIdAsJSON=function(e){var t=this.findNodeByType(e),i=[];return t.length>0?(t.forEach(function(e,t){i.push(e.id)}),JSON.stringify(i)):[]}}}),define("VisuDataAccess/Ox4TreeTarget",["DS/VisuDataAccess/Ox4TreeTarget","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/Ox4TreeTarget"),e}),window.disposedViewers=[];var __WebGLViewer_prereqs=["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/Viewpoint","DS/Visualization/InternalSceneGraph","DS/Mesh/MeshUtils","DS/Animation/AnimationEngine","DS/Visualization/WebGLV6Renderer","DS/Visualization/OccurrencePath","UWA/Controls/Abstract","DS/Magnifier/Magnifier","DS/Visualization/TrapSelection","DS/Visualization/MaterialManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/SubElement","DS/VisuEvents/EventsManager","DS/Manipulators/ManipulatorManager","DS/Visualization/SceneGraph","DS/Visualization/SceneGraphUtils","DS/Visualization/SceneGraphFactory","DS/Visualization/HighlightSelection","DS/CoreEvents/ModelEvents","DS/Plugins/UserPassManager","DS/Effects/BlurShadowEffect","DS/Visualization/PlaneGrid","DS/Manipulators/TrapSelectionManipulator","DS/Visualization/ClippingContext","DS/Visualization/GetSVGMode","DS/Visualization/RenderPriorityManager","DS/WebRecordEnabler/Adapter","DS/Effects/ConvertCubemapToLatlong","DS/Visualization/Ambience","DS/Visualization/RenderMode","DS/Visualization/RenderStyle","DS/Visualization/BudgetedRenderManager","DS/Visualization/WorldOrientation","DS/EKEventsWeb/EKEvents","DS/VisuEvents/MouseEvent","DS/Visualization/DecalManager","DS/Intersection/VolumeIntersection","DS/Visualization/WebGLViewerEffectSettings","DS/Visualization/ViewpointManager","DS/Visualization/PickingMode"];"file:"!==window.location.protocol&&(__WebGLViewer_prereqs.push("text!Visualization/assets/ambiences.json"),__WebGLViewer_prereqs.push("text!Visualization/assets/compare.json")),define("DS/Visualization/WebGLViewer",__WebGLViewer_prereqs,function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E,T,A,I,R,L,O,N,F,V,U,B,k,G,z,H,W,j,X,q,Z,Y,K){"use strict";var J=t.NoOccurrences,Q="true"===localStorage.getItem("WebVisuForceHaloHL"),$=0,ee=t.__visibleInCurrentSpace,te={Shaded:["Shading","ShadingEdges","ShadingEdgesHiddenEdges","ShadingEdgesHalfSmoothEdges","ShadingEdgesHalfSmoothEdgesHiddenEdges","ShadingEdgesNoSmoothEdges","ShadingEdgesNoSmoothEdgesHiddenEdges","ShadingMaterial","ShadingMaterialEdges","ShadingMaterialEdgesHalfSmoothEdges","ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges","ShadingMaterialEdgesHiddenEdges","ShadingMaterialEdgesNoSmoothEdges","ShadingMaterialEdgesNoSmoothEdgesHiddenEdges"],Illustration:["ShadingIllustration"],Wireframe:["Wireframe"]},ie={WithEdges:["ShadingEdges","ShadingIllustration","Wireframe","ShadingMaterialEdges"],NoEdges:["Shading","ShadingMaterial"],WithEdgesHiddenEdges:["ShadingEdgesHiddenEdges","ShadingMaterialEdgesHiddenEdges"],WithEdgesHalfSmoothEdges:["ShadingEdgesHalfSmoothEdges","ShadingMaterialEdgesHalfSmoothEdges"],WithEdgesHalfSmoothEdgesHiddenEdges:["ShadingEdgesHalfSmoothEdgesHiddenEdges","ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges"],WithEdgesNoSmoothEdges:["ShadingEdgesNoSmoothEdges","ShadingMaterialEdgesNoSmoothEdges"],WithEdgesNoSmoothEdgesHiddenEdges:["ShadingEdgesNoSmoothEdgesHiddenEdges","ShadingMaterialEdgesNoSmoothEdgesHiddenEdges"]},re={true:["ShadingMaterial","ShadingMaterialEdges","ShadingMaterialEdgesHalfSmoothEdges","ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges","ShadingMaterialEdgesHiddenEdges","ShadingMaterialEdgesNoSmoothEdges","ShadingMaterialEdgesNoSmoothEdgesHiddenEdges"],false:["Shading","ShadingEdges","ShadingEdgesHalfSmoothEdges","ShadingEdgesHalfSmoothEdgesHiddenEdges","ShadingEdgesHiddenEdges","ShadingEdgesNoSmoothEdges","ShadingEdgesNoSmoothEdgesHiddenEdges","ShadingIllustration","Wireframe"]};let ne=(new t.Color).setRGB(150/255,185/255,165/255);var ae=p.extend({init:function(i){this.id=$++,window.debugWebGLV6Viewer=this;var r,n=this;i.uniqueName&&(this.uniqueName=i.uniqueName),i.pageObjectName&&(this.pageObjectName=i.pageObjectName),this.clearThis=function(){n=null},this.version="9.0",this._familyName=i.familyName?i.familyName:"",this.debugWebgl2=!!i.debugWebgl2,this._parent(),this._worldOrientation=G.ZUpYRight,this.idPathMatcher=null,this._refPlaneCounter=0,this._refPlaneMap=new Map,this._manipulators={},this.trapSelectionManipulator=null,this.disposed=!1,this._fillXSOMode=!0,this.lastViewerWidth=0,this.lastViewerHeight=0,i=i||{},this._svgMode=!!i.svgMode,this._2DMode=!1,this.div=null,this.divCssElement=null,this.materialManager=null,this.context2D=null,this._nearFarBigScale=!!window.nearFarBigScale,this._sceneGraph=null,this._sceneGraphOverrideSetManager=null,this._sceneGraphStateVersion=null,this._oocManager=null,this._userPassManager=new E(this),this._renderPriorityManager=null,this._modelEvent=new w,this.trapSelection=null,this._renderStyle=null,this._pickingMode=new Z,this._forceSceneMinValue=null,this._backgroundViewMode=t.BackgroundViewMode.NORMAL,this._invertBackgroundNodes=!1,this._pickBackgroundNodes=!0,this._planeViewMode={mode:t.PlaneViewMode.NORMAL,plane:new t.Plane},i.capturer&&(this.capturer=i.capturer,this.capturer.setViewer(this),i.preserveDrawingBuffer=!0),void 0!==i.div&&(this.div=i.div),void 0!==i.divCssElement&&(this.divCssElement=i.divCssElement),this._useDefaultAmbiancesIBL=void 0===i.useDefaultAmbiancesIBL||i.useDefaultAmbiancesIBL,this.buildSkeleton(),this.buildSkeletonCss(),window.DSWebRecord&&(console.log("registering viewer#"+this.id),x._record_registerObject(this,"WebGLV6Viewer",[this.canvas,this.divTrap])),this.previousMaxSectionPolyLineSize=0,this.ODTMode=i.ODTMode||!1,this.ODTMode&&(t._BinaryPrimitives=!t.IsIE11),this.fetchMePreferenceSettings=void 0===i.usePlatformSettings||i.usePlatformSettings,this._configAmbiences=null,this._compareSettings=null,Y&&(this._configAmbiences=JSON.parse(Y)),K&&(this._compareSettings=JSON.parse(K)),this.ODTMode&&i.ODTAmbiences&&(this._configAmbiences=JSON.parse(i.ODTAmbiences));var a=t.isAppleDevice();if(this._configAmbiences&&this._configAmbiences.effects&&void 0!==this._configAmbiences.effects.FallbackForApple&&(a=!!this._configAmbiences.effects.FallbackForApple),this._configAmbiences&&this._configAmbiences.effects&&void 0!==this._configAmbiences.effects.UnrolledHighlightForApple){var d=!!this._configAmbiences.effects.UnrolledHighlightForApple;t.__unrolledHighlight=function(){return d}}var p=t.isMobile();this.mobile=p||!!i.shouldBeMobile,void 0===i.mobile||a||(this.mobile=i.mobile,console.warn("Warning: Detected mobile mode override. DO NOT USE IN PRODUCTION.")),t.mobileVersion=this.mobile,t._mobileDevice=this.mobile||p,t._visuFaceMaterialsAsPBR=void 0!==i.visuFaceMaterialsAsPBR&&i.visuFaceMaterialsAsPBR,t._GASFaceMaterialsAsPBR=void 0!==i.GASFaceMaterialsAsPBR&&i.GASFaceMaterialsAsPBR,t._visuFaceMaterialsAsPBR&&(t._GASFaceMaterialsAsPBR=!0),t._GASFaceMaterialsAsPBR&&(t._visuFaceMaterialsAsPBR=!0),this.useHDR=!a&&(void 0===i.hdr||i.hdr),this.multiViewer=void 0!==i.multiViewer&&i.multiViewer,this.multiViewerFix=!0,this.defaultAnimationLoop=void 0===i.defaultAnimationLoop||i.defaultAnimationLoop,N.isReplaying()&&(this.defaultAnimationLoop=!1),this.autoUpdateFrustum=void 0===i.autoUpdateFrustum||i.autoUpdateFrustum,this.autoUpdateLights=!0,this.triLights=void 0!==i.triLights&&i.triLights,this.ambience=new V({viewer:this,v2:!0}),this.ambience.setBackgroundColor(void 0!==i.backgroundColor?i.backgroundColor:0),this.ambience.setBackgroundAlpha(void 0!==i.backgroundAlpha?i.backgroundAlpha:1),this.__tempBackgroundColorODT=void 0!==i.backgroundColor?i.backgroundColor:0,this.planeColor=new t.Color(15658734),this.gridColor=new t.Color(15658734),this.showBgAlpha=this.ambience.getBackgroundAlpha(),this.showBgColor=this.ambience.getBackgroundColor().getHex(),this.showPlaneColor=new t.Color(this.planeColor.getHex()),this.showGridColor=new t.Color(this.gridColor.getHex()),this.showGradientBackground=[],this.visibleSpace=void 0!==i.visibleSpace?i.visibleSpace:1,this._updateStaticOverrides=!1,this.visuShadingMode={preset:null,face:null,edge:null,point:null,before2DModeLinesFilter:null,before2DModePointsFilter:null,before2DModeVerticesFilter:null,outline:!1},this.axisFilterStatus=null,this.planesFilterStatus=null,this.pointsFilterStatus=null,this.linesFilterStatus=null,this.verticesFilterStatus=null,this.lockedRenderMode=new Map,this.sceneGraphState=null,this.cameraSystem=null,this.cameraSystemUpdated=!1,this.lastNbTexturesBeingLoaded=0,this._pageObjectData=null,this._immFrame=null,this.highlightColor=null,this.highlightSets=[],this.picking={activated:!0,trapSelection:!1,showDivTrap:!0,displayHL:!0,forceVisibility:!1,gpu:!0,trapGPU:!1,_trapPrimitiveUsed:!1,trapPrimitive:!1,computeNormalDepth:!0,primitive:!1,tolerance:2},Object.defineProperty(this.picking,"trapSelectionMesh",{set:function(e){console.warn("Invalid useage, please use setPicking API")},get:function(){return console.warn("DEPRECATED: please use .trapSelection and .trapPrimitive instead"),this.trapSelection&&!this.trapPrimitive}}),void 0!==i.highlight&&this.setPicking(i.highlight),this.pPicking={activated:!1,trapSelection:!1,displayHL:!0,forceVisibility:!1,gpu:!0,computeNormalDepth:!1,primitive:!1,disableWhileMoving:!0,tolerance:2},this._showHighlight=!0,void 0!==i.pHighlight&&this.setPrePicking(i.pHighlight),this.lastAddedToPSO=null,void 0===i.usePicking&&void 0===i.usePickingGPU||console.log("usePicking and usePickingGPU parameters are deprecated.\n Use highlight and pHighlight objects instead."),void 0!==i.usePicking&&(this.picking.activated=i.usePicking),void 0!==i.usePickingGPU&&(this.picking.gpu=i.usePickingGPU),void 0!==i.useTrapGPU&&(this.picking.trapGPU=i.useTrapGPU),this.infinitePlane=void 0===i.infinitePlane||i.infinitePlane,this._infinitePlane=this.infinitePlane,this.displayGrid=void 0!==i.displayGrid&&i.displayGrid,this._displayGrid=this.displayGrid,this.displayGridFromBelow=!1,this.autoUpdatePlane=void 0===i.autoUpdatePlane||i.autoUpdatePlane,this.useMirror=void 0!==i.mirror&&(!this.mobile&&i.mirror),this.blurryMirror=!1,this.planeAttenuation=!1,this.useShadowPlane=this._infinitePlane,this.useDefaultLights=void 0===i.defaultLights||i.defaultLights,this.useGroundShadow=void 0!==i.useGroundShadow&&i.useGroundShadow,this.useShadowMap=void 0===i.useShadowMap||i.useShadowMap,this.mobile&&(this.useShadowMap=!1),this.shadowFilter="PCF",this.shadowQuality="Low",this.shadowMapWidth=void 0!==i.shadowMapWidth?i.shadowMapWidth:4096,this.shadowMapHeight=void 0!==i.shadowMapHeight?i.shadowMapHeight:4096,this.deferred=void 0!==i.deferred&&i.deferred,this.antiAliasing=void 0!==i.antiAliasing?i.antiAliasing:"NoAA",!0===this.antiAliasing?this.antiAliasing="SMAA":!1===this.antiAliasing&&(this.antiAliasing="NoAA");var f=void 0!==i.useOIT&&i.useOIT;i.svgMode&&(f=!1),this.forceRender=!1,this._renderingToTarget=!1,this.visuEnv="None",void 0!==i.displayHighlight&&(this.displayHighlight=i.displayHighlight,this.setPicking({activated:this.displayHighlight,displayHL:this.displayHighlight})),this.useVignetting=void 0!==i.useVignetting&&i.useVignetting,this.useSSAO=void 0!==i.ssao&&i.ssao,this.useSSAOIterative=void 0!==i.ssaoIterative&&i.ssaoIterative,this.useSSLR=void 0!==i.sslr&&i.sslr,this.useSSLRDirect=!1,this.useSSLRefraction=!1,this.useBloom=void 0!==i.bloom&&i.bloom,this.useFlare=void 0!==i.flare&&i.flare,this.useDOF=void 0!==i.dof&&i.dof,a?this._viewerEffectSettings=new X.None(this,{enableOIT:f}):this.mobile?this._viewerEffectSettings=new X.Mobile(this,{enableOIT:f}):this.useHDR?this._viewerEffectSettings=new X.Desktop(this,{enableOIT:f}):this._viewerEffectSettings=new X.NoHDR(this,{enableOIT:f}),this.ssaoParams={dynamicRadius:!0,adaptativeRadius:!0,radius:.04,radiusMin:.01,radiusMax:.12,minPixelRadius:14,attenuation:1,contrast:2,power:1,thresholdAngle:1.35},this.magnifier=null,this.debugShadowLight=void 0!==i.debugShadowLight&&i.debugShadowLight,this.debugBSphere=void 0!==i.debugBSphere&&i.debugBSphere,this.debugPrimitiveBSphere=void 0!==i.debugPrimitiveBSphere&&i.debugPrimitiveBSphere,this.debugRepBBox=void 0!==i.debugRepBBox&&i.debugRepBBox,this.debugPicking=void 0!==i.debugPicking&&i.debugPicking,this.debugNormals=void 0!==i.debugNormals&&i.debugNormals,this.debugBackfaceCulling=void 0!==i.debugBackfaceCulling&&i.debugBackfaceCulling,this.debugPickHybrid=!1;this.debugPostProcessing=!1,this.debugShadowMaps=!1,this.debugEvents=0,this.debugFPS=!1,this.debugFPSInfos={fpsCounter:null,fpsArray:[],fpsIndex:0,fpsValue:30,fpsCumul:1200,fpsWindow:40,fpsLastTime:0},this._viewpointManager=new q(this),this.viewpoints=[],this.currentViewpoint=null,this.trackingViewpoint=null,this.internalSceneGraph=null,this._safeInternalSceneGraph=null,this.manipulatorManager=null,this.temporaryEmptyScene=new t.Scene,this.centerMouseDownCB=null,this.mouseMoveCB=null,this.centerMouseUpCB=null,this.leftMouseDownCB=null,this.leftMouseUpCB=null,this.rightMouseUpCB=null,this._defaultPicking=null,this.setDefaultPicking(!0),this.pickingPriorityMapping=null,this.forceMultiSel=!1,this.sceneBackground=new t.Scene,this.sceneBackground.isBackground=!0,this.cameraBackgroundNear=1e-4,this.cameraBackgroundFar=1,this.cameraBackground=new t.PerspectiveCamera,this.cameraBackground._renderingRole=t._CameraRoles.BACKGROUND,this.sceneBackground.add(this.cameraBackground),this.cameraReflected=new t.PerspectiveCamera,this.cameraReflected._renderingRole=t._CameraRoles.REFLECTED,this.planeGridOrientation=new t.Matrix4,this.infPlane=null,this.infPlaneSmall=null,this.planeSize=200,this.grid=null,this.bigGrid=null,this.gridSize=200,this.gridUnit=1,this.gridStep=.005,this.gridNbSteps=5,this.offsetPlaneSmall=new t.Vector3,this.offsetPlaneBackground=new t.Vector3,this.planeV2=void 0!==i.planeV2&&i.planeV2,this._planeV2Appli=this.planeV2,this.planeGrid=this.planeV2?new A(this):null,this.ground=null,this.envMap=null,this.envMap2=null,this.envMapExposure=1,this.envMapOffset=0,this.envMapBlur=0,this.sphereEnv=null,this.isRenderIteration=!0,this._lockRenderIteration=!1,this.renderIteration=0,this.timeIter0=0,this.delayBeforeIteration=500,this.devicePixelRatio=t.getDevicePixelRatio()||1,this.SCREEN_WIDTH=800,this.SCREEN_HEIGHT=600,this.lazyResize=void 0!==i.lazyResize&&i.lazyResize,this.lazyResizeTime=300,this.oldCanvasSize={width:this.SCREEN_WIDTH,height:this.SCREEN_HEIGHT,dpr:this.devicePixelRatio,time:(new Date).getTime()},this.initMousePos=null,this.currMousePos=null,this.bSphere=null,this.bBox=null,this.primitiveBSphere=null,this.debugPickingNode=null,this.debugNormalNode=new t.Object3D,this.renderer=null,this._requestRender=!1,this._onlyPostProcess=!0,this._renderParams=[],this.renderFrameCB=null,this.beginRenderFrameCB=null,this.ambientLight=new t.AmbientLight(new t.Color(0)),this.directionalLight=null,this.directionalLight2=null,this.directionalLight3=null,this.dirLightGroundShadow=null,this.groundShadowLatitude=0,this.groundShadowLongitude=0,this.dirLightLatitude=.25,this.dirLightLongitude=0,this.dirLightVector=new t.Vector3(2,1.5,2.5),this.dirLight2Vector=new t.Vector3(0,0,1),this.dirLight3Vector=new t.Vector3(0,0,1),this.dirLightType=[!1,!1,!1],this.lights=[],this.clipPlanes=[],t.intensityCorrection=!0,this.budgetedRenderManager=new k(this),r=new Date,this._oldTime=r.getTime(),this.overrideCursors=!0,this._changeCursorDelay=null,this._temporaryCursorData=null,this._forcePRZ=!1,this.startPan=function(e){var t=this.currentViewpoint.getControl();null!==t&&t.startPan(e),this._forcePRZ=!0},this.startRotate=function(e){var t=this.currentViewpoint.getControl();null!==t&&t.startRotate(e),this._forcePRZ=!0},this.startZoom=function(e){var t=this.currentViewpoint.getControl();null!==t&&t.startZoom(e),this._forcePRZ=!0},this.endPan=function(e){var t=this.currentViewpoint.getControl();null!==t&&(t.endPan(e),this.setCursor("Auto",0)),this._forcePRZ=!1},this.endRotate=function(e){var t=this.currentViewpoint.getControl();null!==t&&(t.endRotate(e),this.setCursor("Auto",0)),this._forcePRZ=!1},this.endZoom=function(e){var t=this.currentViewpoint.getControl();null!==t&&(t.endZoom(e),this.setCursor("Auto",0)),this._forcePRZ=!1},this._getPaths=function(e,t,i,r){var n,a;if(t.count!=t.stop){t.count++,i.push(e);var s=e.children;for(a=s.length,n=0;n<a;n++)this._getPaths(s[n],t,i,r);i.pop(),t.count--}else r.push(i.slice(0))},this.addPathToHso=function(e){var t=[],i=S;this._getPaths(this.getRootNode().children[0],{count:0,stop:e},[],t);for(var r=0;r<t.length;r++)i.add({pathElement:new s(t[r])});return t},this.render=function(e){null!=n&&(void 0===e&&(e={}),e.budgeted?n.budgetedRenderManager._askForRender(e):(void 0===e.budgeted&&n.budgetedRenderManager._resetShift(),n._renderParams.push(e),n._requestRender=!0,e&&e.onlyPostProcess||(n._onlyPostProcess=!1)))},this._QMTimer=null,this._QMMode=!1,this._getQMMode=function(e,t,i){if(this._QMMode=!!this._QMTimer&&!i||e.isMoving()||e._isAnimated()||!!t,this._QMTimer&&!i&&clearTimeout(this._QMTimer),this._QMMode){var r=this;this._QMTimer=setTimeout(function(){clearTimeout(r._QMTimer),r._QMTimer=null,r.render()},r.delayBeforeIteration||500)}return this._QMMode},this.glRenderMultiVP=function(e){this.budgetedRenderManager._isActive&&this.budgetedRenderManager._setAsRenderFrame(),this.beginRenderFrameCB&&this.beginRenderFrameCB(),this.renderer.renderer._dBufferNextFrame&&(this.renderer.renderer.requestDBuffer=!0,this.renderer.renderer._dBufferNextFrame=!1),this.renderer.renderer._politeDBufferNextFrame&&(this.renderer.renderer._requestPoliteDepthBuffer=!0,this.renderer.renderer._politeDBufferNextFrame=!1);let i=!1,r=this.renderer.renderer.getViewport();if(void 0!==e.viewpoint)i=this.glRender(e);else{let t=this._viewpointManager.getVpList();for(let n=0;n<t.length;n++){let a=this._viewpointManager.getViewpointScenegraph(t[n]),s=this.internalSceneGraph;a&&(this.internalSceneGraph=a),this.autoUpdateFrustum&&this._updateNearFar(t[n]),t[n].camera.updateProjectionMatrix(),t[n].camera.projectionMatrixInverse.getInverse(t[n].camera.projectionMatrix);let o=this.renderer.renderer.gammaOutput,l=this,c=function(){l.internalSceneGraph=s,l.renderer.renderer.gammaOutput=o,l.renderer.useAuxiliaryAsForward=!1,l.renderer.renderer.setViewport(r.x,r.y,r.width,r.height)};if(!t[n]._isMain){if(!this.renderer.mainComposer.composerContext||this.renderer.mainComposer.composerContext.id!=this.renderer.compForwardComposerContext.id){c();continue}this.renderer.auxiliaryViewpointComposerContext||this.renderer.initComposer("auxiliaryViewpoint"),this.renderer.useAuxiliaryAsForward=!0,this.renderer.renderer.gammaOutput=!1}let h=this._viewpointManager.getViewpointViewport(t[n]);h&&this.renderer.renderer.setViewport(h.x,h.y,h.width,h.height);let u=[...e,{viewpoint:t[n]}];i=this.glRender(u)||i,c()}}return this.renderer.renderer.requestDBuffer=!1,this.renderer.renderer._requestPoliteDepthBuffer&&(this.renderer.politeDepthBuffer=null),this.renderer.renderer._requestPoliteDepthBuffer=!1,this.ODTMode&&t.ImageUtils.nbTexturesBeingLoaded>0?this.render():this.renderFrameCB&&this.renderFrameCB(),i},this.glRender=function(e){var i,r,a,s,o,l,h,u,d,p,f,m,g,v;this.renderer.renderer.maxPolyLineSize!==this.previousMaxSectionPolyLineSize&&(this.previousMaxSectionPolyLineSize=this.renderer.renderer.maxPolyLineSize,this.renderer&&this.renderer.recompileAllShaders(null)),t.webGLStats&&t.webGLStats.reset();var S=!1,_=null,y=!1,x=!1,M=n.currentViewpoint,P=!0,D=!!e.length,w=!!e.length,E=!1,T=512,A=0,I=0,R=!1,L=!1,O=!1,N=!1,F=!1;for(ee=0;ee<e.length;ee++)void 0!==e[ee].needReframe&&(S=e[ee].needReframe),void 0!==e[ee].reframeSpace&&(_=e[ee].reframeSpace),void 0!==e[ee].updateInfinitePlane&&(y=y||e[ee].updateInfinitePlane),void 0!==e[ee].updateInfinitePlaneFast&&(x=x||e[ee].updateInfinitePlaneFast),void 0!==e[ee].renderIteration&&(I=e[ee].renderIteration),void 0!==e[ee].isStillFrame&&(R=e[ee].isStillFrame),void 0!==e[ee].forceRender&&(L=e[ee].forceRender),void 0!==e[ee].viewpoint&&(M=e[ee].viewpoint),void 0!==e[ee].toScreen&&(P=e[ee].toScreen),e[ee].onlyPostProcess||(D=!1),e[ee].onlyForward||(w=!1),void 0!==e[ee].cubemap&&(E=e[ee].cubemap),void 0!==e[ee].cubemapResolution&&(T=e[ee].cubemapResolution),void 0!==e[ee].cubeFace&&(A=e[ee].cubeFace),O||!0!==e[ee].ekTrace||(O=!0),!0===e[ee].forceStaticMode&&(forceStaticMode=!0),!0===e[ee].forceDynamicMode&&(F=!0),!0===e[ee].overrideEffects&&(N=!0);O&&(O=z.Trace.traceStart("techno_webvisu","webgl_frame_display"));let V=null!==M&&M.isMain();var U=N?"override":this._getQMMode(M,F,L)?"dynamic":"static",B=N?"override":0===I?"dynamic":"static";if(this._viewerEffectSettings.updateViewerSettings(U,B),n._modelEvent.publish({event:"PreRender",data:{viewer:n,viewpoint:M,trackingViewpoint:n.trackingViewpoint,onlyPostProcess:D}}),f=M.camera,se=null===n.internalSceneGraph?n.temporaryEmptyScene:n.internalSceneGraph.scene,(p=null===n.internalSceneGraph?new t.Sphere(new t.Vector3(0,0,0),100):n.getSceneBoundingSphere(this.visibleSpace?"visibleSpace":"invisibleSpace")).pixelRadius>0){var k=f.getWorldSizeFromPixelSize(1,p.center,this._getDivClientHeight());if(void 0!==f.fullWidth&&f.fullWidth>0)k*=Ce=Math.max(1*f.width/f.fullWidth,1*f.height/f.fullHeight);p.radius+=k*p.pixelRadius}if(null!==M&&(f.updateMatrix(),f.matrixWorld.copy(f.matrix),f.matrixWorldInverse.getInverse(f.matrixWorld),this._viewerEffectSettings.updateAmbienceBackScale(U),this.blurShadowEffect&&this.dirLightGroundShadow&&this.ambience.getGround().needsUpdateShadowIntensity&&(this.ambience.getGround().needsUpdateShadowIntensity=!1,this.blurShadowEffect.setIntensity(this.ambience.getGround().getShadowIntensity()),this.dirLightGroundShadow.updateShadowMap=!0),this.sphereEnv&&this.ambience.updateCamera(M,this.renderer,f)),n.directionalLight&&(n.directionalLight.shadowCameraVisible=n.debugShadowLight),V){if(n.debugBSphere){if(n.bSphere)n.bSphere.visibilityFree=!0,n.bSphere.visible=!0,n.bSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(p.radius,p.radius,p.radius),i.setPosition(p.center),n.bSphere.setMatrix(i);else if(null!==se){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.2,transparent:!0,force:!0,forceSide:!0}),(X=b.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.bSphere=X._occurrences[0].renderable,n.bSphere.frustumCulled=!1,n.bSphere.noPickThrough=!1,se.add(n.bSphere)}}else n.bSphere&&(n.bSphere.visibilityFree=!0,n.bSphere.visible=!1);if(n.debugNodeBSphere){var G=null,H=null;if((Q=WUX.Selection.HSOManager.get())[0])G=(Z=(q=Q[0].pathElement).getLastElement(!0)).getBoundingSphere(),H=q.getWorldMatrix(this);if(G){if(n.nodeBSphere)n.nodeBSphere.visible=!0,n.nodeBSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(G.radius,G.radius,G.radius),i.setPosition(G.center),H.multiplyMatrices(H,i),n.nodeBSphere.setMatrix(H);else if(null!==se){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(X=b.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.nodeBSphere=X._occurrences[0].renderable,n.nodeBSphere.frustumCulled=!1,se.add(n.nodeBSphere)}}else n.nodeBSphere&&(n.nodeBSphere.visible=!1)}if(n.debugPrimitiveBSphere){var W=null;H=null;if((Q=WUX.Selection.HSOManager.get())[0])(Z=(q=Q[0].pathElement).getLastElement()).sgNode&&Z.sgNode.boundingSphere&&(W=Z.sgNode.boundingSphere,H=q.getWorldMatrix(this));if(W){if(n.primitiveBSphere)n.primitiveBSphere.visible=!0,n.primitiveBSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(W.radius,W.radius,W.radius),i.setPosition({x:W.center[0],y:W.center[1],z:W.center[2]}),H.multiplyMatrices(H,i),n.primitiveBSphere.setMatrix(H);else if(null!==se){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(X=b.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.primitiveBSphere=X._occurrences[0].renderable,n.primitiveBSphere.frustumCulled=!1,se.add(n.primitiveBSphere)}}else n.primitiveBSphere&&(n.primitiveBSphere.visible=!1)}if(n.debugRepBSphere){var j=null;H=null;if((Q=WUX.Selection.HSOManager.get())[0])(Z=(q=Q[0].pathElement).getLastElement()).sgNode&&Z.sgNode.rep&&Z.sgNode.rep.boundingSphere&&(j=Z.sgNode.rep.boundingSphere,H=q.getWorldMatrix(this));if(j){if(n.repBSphere)n.repBSphere.visible=!0,n.repBSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(j.radius,j.radius,j.radius),i.setPosition({x:j.center[0],y:j.center[1],z:j.center[2]}),H.multiplyMatrices(H,i),n.repBSphere.setMatrix(H);else if(null!==se){var X;r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(X=b.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.repBSphere=X._occurrences[0].renderable,n.repBSphere.frustumCulled=!1,se.add(n.repBSphere)}}else n.repBSphere&&(n.repBSphere.visible=!1)}if(n.debugRepBBox){var q,Z,Y=null;H=null;if((Q=WUX.Selection.HSOManager.get())[0])(Z=(q=Q[0].pathElement).getLastElement()).getBoundingBox()&&(Y=Z.getBoundingBox(),H=q.getWorldMatrix(this));else Y=this.getSceneBoundingBox(),H=this.internalSceneGraph.root.getMatrix();if(Y)if(n.bBox)n.bBox.visible=!0,n.bBox.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(Y.max.x-Y.min.x,Y.max.y-Y.min.y,Y.max.z-Y.min.z),i.setPosition({x:Y.min.x+(Y.max.x-Y.min.x)/2,y:Y.min.y+(Y.max.y-Y.min.y)/2,z:Y.min.z+(Y.max.z-Y.min.z)/2}),H.multiplyMatrices(H,i),n.bBox.setMatrix(H);else if(null!==se){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0});var K=b.createCuboidNode({cornerPoint:new t.Vector3(-.5,-.5,-.5),firstAxis:new t.Vector3(1,0,0),secondAxis:new t.Vector3(0,1,0),thirdAxis:new t.Vector3(0,0,1),material:r});n.bBox=K._occurrences[0].renderable,n.bBox.frustumCulled=!1,n.bBox.pickable=!1,se.add(n.bBox)}}else n.bBox&&(n.bBox.visible=!1);if(n.debugLocalBBox){var J=(new t.Matrix4).identity();n.debugHandleMatrix&&J.copy(n.currentViewpoint.camera.matrix);for(var Q=WUX.Selection.HSOManager.get(),$=[],ee=0;ee<Q.length;ee++)$.push(Q[ee].pathElement);var te=C.getOrientedBoundingBoxFromPathElements($,J,n).localBBox;if(te){if(n.localBBox)n.localBBox.visible=!0,n.localBBox.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(te.max.x-te.min.x,te.max.y-te.min.y,te.max.z-te.min.z),i.setPosition({x:te.min.x+.5*(te.max.x-te.min.x),y:te.min.y+.5*(te.max.y-te.min.y),z:te.min.z+.5*(te.max.z-te.min.z)}),J.multiplyMatrices(J,i),n.localBBox.setMatrix(J);else if(se){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(K=b.createCuboidNode({cornerPoint:new t.Vector3(-.5,-.5,-.5),firstAxis:new t.Vector3(1,0,0),secondAxis:new t.Vector3(0,1,0),thirdAxis:new t.Vector3(0,0,1),material:r})).setPickable(2),n.localBBox=K._occurrences[0].renderable,n.localBBox.frustumCulled=!1,se.add(n.localBBox)}}else n.localBBox&&(n.localBBox.visible=!1)}if(n.debugBBox){J=(new t.Matrix4).identity();n.debugHandleMatrix&&J.copy(n.currentViewpoint.camera.matrix);var ie=this.computeSceneAccurateBoundingBox(n.visibleSpace?"visibleSpace":"invisibleSpace",n.debugHandleMatrix?J:null);if(ie){if(n.BBox)n.BBox.visible=!0,n.BBox.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(ie.max.x-ie.min.x,ie.max.y-ie.min.y,ie.max.z-ie.min.z),i.setPosition({x:ie.min.x+.5*(ie.max.x-ie.min.x),y:ie.min.y+.5*(ie.max.y-ie.min.y),z:ie.min.z+.5*(ie.max.z-ie.min.z)}),J.multiplyMatrices(J,i),n.BBox.setMatrix(J);else if(se){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(K=b.createCuboidNode({cornerPoint:new t.Vector3(-.5,-.5,-.5),firstAxis:new t.Vector3(1,0,0),secondAxis:new t.Vector3(0,1,0),thirdAxis:new t.Vector3(0,0,1),material:r})).setPickable(2),n.BBox=K._occurrences[0].renderable,n.BBox.frustumCulled=!1,se.add(n.BBox)}}else n.BBox&&(n.BBox.visible=!1)}else n.BBox&&(n.BBox.visible=!1);var re=this.getRootNode();re&&!n.debugPicking&&null!==n.debugPickingNode&&(n.debugPickingNode.removeChildren(),re.removeChild(n.debugPickingNode),n.debugPickingNode=null),n.debugNormals?(n.debugNormalNode.children.length||function(){if(null===n.internalSceneGraph)return;var e,i,r,a,s,o,l,h,u,d,p,f,m,g,v,S,_,y,x=n.internalSceneGraph.scene.getMeshInstances();for(S=0;S<x.length;S++){for(e=x[S],i=.05*e.boundingSphere.radius,r=null,a=0,e.geometry.length>=0?(r=e.geometry[0],a=e.geometry.length):2===e.geometry._type&&(r=e.geometry,a=1),s=[],y=0;y<a;y++){if(o=r.vertexPositionArray,null!==(l=r.vertexNormalArray))for(_=0;_<o.length;_+=3)s.push({x:o[_],y:o[_+1],z:o[_+2]}),s.push({x:o[_]+i*l[_],y:o[_+1]+i*l[_+1],z:o[_+2]+i*l[_+2]});r=e.geometry[y+1]}if(s.length){for((h=new c.PrimitiveGroup).fillAttr=new c.FillAttributes,h.lineAttr=new c.LineAttributes,h.pointAttr=new c.PointAttributes,(u=new c.Buffer).size=3*s.length,u.component=c.VertexComponentEnum.POSITION,u.format=c.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(u.size),h.addBuffer(0,u),v=u.data,y=0,_=0;_<s.length;_++)v[y++]=s[_].x,v[y++]=s[_].y,v[y++]=s[_].z;for(d=Math.ceil(s.length/65534),p=0,_=0;_<d;_++)(f=new c.Primitive).nbIndices=Math.min(s.length-p,65534),f.connectivity=c.ConnectivityTypeEnum.LINES,f.attr={fill:new c.FillAttributes,line:new c.LineAttributes(new c.Color(0,0,1,1)),point:new c.PointAttributes},(m=new c.VertexComponent).component=c.VertexComponentEnum.POSITION,m.nbVertices=3*Math.min(s.length-p,65534),m.nbValuesPerVertex=3,m.format=c.DataTypeEnum.FLOAT,m.cardinality=0,m.bufferId=0,m.offset=p,m.indices=null,f.addVertexComponent(m),h.addPrimitive(f),p+=65534;(g=b.createMeshNode(h)).mesh3js.setMatrix((new t.Matrix4).copy(e.matrixWorld)),g.setPickable(!1),g.mesh3js.castShadow=!1,g.mesh3js.receiveShadow=!1,n.debugNormalNode.add(g.mesh3js)}}}(),se.add(n.debugNormalNode)):(se.remove(n.debugNormalNode),n.debugNormalNode.children=[])}for(ee=0;ee<se.__lights.length;ee++){var ne,ae=!1;(ne=se.__lights[ee])._occurrence&&(ae=ne._occurrence.node._attachedToVpt),ae&&(ne._vptUp=M.getUpDirection(),ne._vptSight=M.getSightDirection(),ne._vptPosition=M.getEyePosition()),ne._sceneShadow&&ne.updateShadowParameters(p,n.renderer.renderer.baseLightDirection)}if(V&&this.ambience){var se=this.internalSceneGraph&&this.internalSceneGraph.scene;this.ambience.updateLights(M,se,p,n.useShadowMap,this.sceneBackground)}if(V&&n.useDefaultLights){if(ne=n.directionalLight,a=n.directionalLight2,s=n.directionalLight3,null!==p){if(n.triLights){var oe=M.getUpDirection(),le=M.getSightDirection(),ce=(new t.Vector3).crossVectors(le,oe);n.autoUpdateLights?(o=new t.Vector3(2*p.radius,2*p.radius,2*p.radius),ne.position=(new t.Vector3).copy(p.center).add(o),ne.lookAt(p.center),l=(new t.Vector3).copy(oe).sub(le).sub(ce).multiplyScalar(2*p.radius),a.position=(new t.Vector3).copy(p.center).add(l),a.lookAt(p.center),h=(new t.Vector3).copy(ce).sub(le).multiplyScalar(2*p.radius),s.position=(new t.Vector3).copy(p.center).add(h),s.lookAt(p.center)):(n.dirLightType[0]?(o=new t.Vector3(ce.x*n.dirLightVector.x+oe.x*n.dirLightVector.y-le.x*n.dirLightVector.z,ce.y*n.dirLightVector.x+oe.y*n.dirLightVector.y-le.y*n.dirLightVector.z,ce.z*n.dirLightVector.x+oe.z*n.dirLightVector.y-le.z*n.dirLightVector.z).multiplyScalar(p.radius),ne.updateShadowMap=!0):o=(new t.Vector3).copy(n.dirLightVector).multiplyScalar(p.radius),ne.position=(new t.Vector3).copy(p.center).add(o),ne.lookAt(p.center),l=n.dirLightType[1]?new t.Vector3(ce.x*n.dirLight2Vector.x+oe.x*n.dirLight2Vector.y-le.x*n.dirLight2Vector.z,ce.y*n.dirLight2Vector.x+oe.y*n.dirLight2Vector.y-le.y*n.dirLight2Vector.z,ce.z*n.dirLight2Vector.x+oe.z*n.dirLight2Vector.y-le.z*n.dirLight2Vector.z).multiplyScalar(p.radius):(new t.Vector3).copy(n.dirLight2Vector).multiplyScalar(p.radius),a.position=(new t.Vector3).copy(p.center).add(l),a.lookAt(p.center),h=n.dirLightType[2]?new t.Vector3(ce.x*n.dirLight3Vector.x+oe.x*n.dirLight3Vector.y-le.x*n.dirLight3Vector.z,ce.y*n.dirLight3Vector.x+oe.y*n.dirLight3Vector.y-le.y*n.dirLight3Vector.z,ce.z*n.dirLight3Vector.x+oe.z*n.dirLight3Vector.y-le.z*n.dirLight3Vector.z).multiplyScalar(p.radius):(new t.Vector3).copy(n.dirLight3Vector).multiplyScalar(p.radius),s.position=(new t.Vector3).copy(p.center).add(h),s.lookAt(p.center))}else if(n.autoUpdateLights){if(n.dirLightType[0])g=f.getLookAt(),o=new t.Vector3(-2*g.x*p.radius,-2*g.y*p.radius,-2*g.z*p.radius),ne.position=(new t.Vector3).copy(p.center).add(o);else{var he=2;ce=1.5,oe=2.5;n.dirLightVector=(new t.Vector3).copy(n._worldOrientation.frontVector).multiplyScalar(he).add((new t.Vector3).copy(n._worldOrientation.rightVector).multiplyScalar(ce)).add((new t.Vector3).copy(n._worldOrientation.upVector).multiplyScalar(oe)),ne.position=(new t.Vector3).copy(n.dirLightVector).multiplyScalar(p.radius).add(p.center)}he=-2,ce=1.5,oe=2.5;(l=(new t.Vector3).copy(n._worldOrientation.frontVector).multiplyScalar(he).add((new t.Vector3).copy(n._worldOrientation.rightVector).multiplyScalar(ce)).add((new t.Vector3).copy(n._worldOrientation.upVector).multiplyScalar(oe))).multiplyScalar(p.radius),a.position=(new t.Vector3).copy(p.center).add(l)}else{ne.position=(new t.Vector3).copy(n.dirLightVector).multiplyScalar(2*p.radius).add(p.center);he=-2,ce=1.5,oe=2.5;(l=(new t.Vector3).copy(n._worldOrientation.frontVector).multiplyScalar(he).add((new t.Vector3).copy(n._worldOrientation.rightVector).multiplyScalar(ce)).add((new t.Vector3).copy(n._worldOrientation.upVector).multiplyScalar(oe))).multiplyScalar(p.radius),a.position=(new t.Vector3).copy(p.center).add(l)}ne.lookAt(p.center),ne.target.position.copy(p.center),ne.target.updateMatrixWorld(),a.target.position.copy(p.center),a.target.updateMatrixWorld(),s&&(s.target.position.copy(p.center),s.target.updateMatrixWorld())}if(n.useShadowMap&&ne.intensity){if(ne.castShadow=!0,null!==p){u=ne.position.distanceTo(p.center);var ue=Math.PI*Math.max(.1,.5-n.dirLightLatitude),de=Math.sin(ue)+(Math.cos(ue)+1)/Math.tan(ue);ne.shadowCamera&&!ne.LiSPSM?(ne.updateShadowMap=ne.updateShadowMap||ne.shadowCamera.top!==p.radius,ne.shadowCamera.far=u+de*p.radius,ne.shadowCamera.near=Math.max(.001*ne.shadowCamera.far,u-p.radius),ne.shadowCamera.left=-p.radius,ne.shadowCamera.right=p.radius,ne.shadowCamera.bottom=-p.radius,ne.shadowCamera.top=p.radius,ne.shadowCamera.updateProjectionMatrix()):(ne.shadowCameraFar=u+de*p.radius,ne.shadowCameraNear=Math.max(.001*ne.shadowCameraFar,u-p.radius),ne.updateShadowMap=!0)}}else ne.castShadow=!1}if(V&&(n._infinitePlane||n._displayGrid)&&n.updateBackgroundLights(),this._2DMode?(this.ground&&(this.ground.visible=!1),this.sphereEnv&&(this.sphereEnv.visible=!1)):this.ambience.getGround().isActivated()&&"physical"==this.ambience.getGround().getType()?(this.ground||this._setPhysicalGround(this.ambience.getGroundGeometry()),this.ambience.updateGround(this.ground)):this.ground&&(this.ground.visible=!1),V&&!this.ambience.needUpdateIBL.has(this)){var pe=this.ambience.getIblMap(),fe=this.ambience.getRoughnessMap();pe?(this.internalSceneGraph.scene.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(!0),n.internalSceneGraph.scene.envMipMap[0]=pe,n.internalSceneGraph.scene.envMipMap[1]=fe,this.sceneBackground.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(!0),this.sceneBackground.envMipMap[0]=pe,this.sceneBackground.envMipMap[1]=fe):(n.internalSceneGraph.scene.envMipMap=[],this.sceneBackground.envMipMap=[]),n.renderer.renderer.ambianceGenerators._decreaseSceneUseCount(n.internalSceneGraph.scene),n.renderer&&n.renderer.recompileAllShaders(null),this.ambience.needUpdateIBL.add(this)}if(!n._displayGrid&&(null!==n.grid&&n.grid.visible||null!==n.bigGrid&&n.bigGrid.visible)&&n._removeGrid(),!n._displayGrid&&n.planeGrid&&n.planeGrid.updateVisibility(),m=100,V&&null!==p&&(n._displayGrid||n._infinitePlane||n.useShadowPlane||n.ambience.getGround().isActivated()||n.ambience.isFiniteMode())){"yup"===this._worldOrientation._woName?(n.offsetPlaneSmall.x=p.center.x,n.offsetPlaneSmall.z=p.center.z):(n.offsetPlaneSmall.x=p.center.x,n.offsetPlaneSmall.y=p.center.y);var me=2*p.radius;n._updateOffsetPlane(p,f,y,x);var ge=n._getPlaneSize(p,f,n.gridUnit,n.gridStep);ge!==n.planeSize&&(n.planeSize=ge,n.autoUpdateFrustum&&n._updateNearFar(M)),d=-f.getLookAt().dot(this._worldOrientation.upVector);var ve=f.position.dot(this._worldOrientation.upVector)-n.offsetPlaneBackground.dot(this._worldOrientation.upVector);if((m=f.isOrtho?d:ve)>0&&n.useShadowPlane&&!n._2DMode){var Se=(new t.Vector3).copy(n.offsetPlaneSmall);Se.x-=.001*m*this._worldOrientation.upVector.x,Se.y-=.001*m*this._worldOrientation.upVector.y,Se.z-=.001*m*this._worldOrientation.upVector.z;ue=Math.PI*Math.max(.1,.5-n.dirLightLatitude);me*=de=Math.sin(ue)+(Math.cos(ue)+1)/Math.tan(ue),n.createInfinitePlane(n.infPlaneSmall,0,me,Se)}else n._removeInfinitePlane(n.infPlaneSmall);if(n.planeV2&&n.planeGrid||n.ambience.usePlaneV2?(n._removeGrid(),n.planeGrid.createPlaneGrid(n.planeSize,n.offsetPlaneBackground,M,n.ambience.isAutoGroundOffset(),n.planeGridOrientation,n.renderer.renderer.simpleGamma)):(n._infinitePlane&&n.createInfinitePlane(n.infPlane,1,n.planeSize,n.offsetPlaneBackground),n._displayGrid&&(m>0||this.displayGridFromBelow?n.createGrid(n.planeSize,n.offsetPlaneBackground,Math.abs(ve),Math.abs(d),y):n._removeGrid()),(v=(new t.Vector3).copy(n.offsetPlaneBackground)).applyMatrix4(f.matrixWorldInverse),null!==this.grid&&(this.grid.material.updatePDSFXUniform("gridCenter",v.clone()),null!==this.bigGrid&&this.bigGrid.material.updatePDSFXUniform("gridCenter",v.clone()))),n.useGroundShadow){var _e=n.dirLightGroundShadow;o=new t.Vector3(0,0,2*p.radius);he=Math.sin(Math.PI*this.groundShadowLatitude)*Math.cos(2*Math.PI*this.groundShadowLongitude),ce=Math.sin(Math.PI*this.groundShadowLatitude)*Math.sin(2*Math.PI*this.groundShadowLongitude),oe=Math.cos(Math.PI*this.groundShadowLatitude);var ye=(new t.Vector3).copy(this._worldOrientation.frontVector).multiplyScalar(he).add((new t.Vector3).copy(this._worldOrientation.rightVector).multiplyScalar(ce)).add((new t.Vector3).copy(this._worldOrientation.upVector).multiplyScalar(oe));_e.position=(new t.Vector3).copy(ye).multiplyScalar(2*p.radius).add(p.center),_e.lookAt(p.center),_e.target.position.copy(p.center),_e.target.updateMatrixWorld(),_e.castGroundShadow=!0,u=_e.position.distanceTo(p.center),_e.shadowCamera?(_e.updateShadowMap=!_e.blockUpdate&&(_e.updateShadowMap||_e.shadowCamera.top!==.5*me),_e.shadowCamera.far=u+p.radius,_e.shadowCamera.near=Math.max(.001*_e.shadowCamera.far,u-p.radius),_e.shadowCamera.left=-.5*me,_e.shadowCamera.right=.5*me,_e.shadowCamera.bottom=-.5*me,_e.shadowCamera.top=.5*me,_e.shadowCamera.updateProjectionMatrix()):(_e.shadowCameraFar=u+p.radius,_e.shadowCameraNear=Math.max(.001*_e.shadowCameraFar,u-p.radius),_e.shadowCameraLeft=-.5*me,_e.shadowCameraRight=.5*me,_e.shadowCameraBottom=-.5*me,_e.shadowCameraTop=.5*me,_e.updateShadowMap=!0),_e._matrixWorldReceiver||(_e._matrixWorldReceiver=new t.Matrix4),n.infPlaneSmall&&_e._matrixWorldReceiver.copy(n.infPlaneSmall.matrix)}else n.dirLightGroundShadow.castGroundShadow=!1}if(!this._2DMode)if(this.ambience.getBackground().isActivated()){var xe=this.trackingViewpoint?this.trackingViewpoint:M,Me=(new t.Vector3).copy(xe.camera.position);this.sphereEnv&&(this.sphereEnv.visible=!0),this.sphereEnv||this._setSphereEnv(this.ambience.getSphere()),this.internalSceneGraph.scene.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(!0);var Pe=.1*this.cameraBackgroundFar;if(f.isOrtho){var Ce,be=1;if(f.fullWidth)(Ce=f.height/f.fullHeight)>1&&(be*=Ce),(Ce=f.width/f.fullWidth)>1&&(be*=Ce);var De=Math.sqrt(Math.pow(f.right,2)+Math.pow(f.top,2));De*=be,this.ambience.getBackground().setRatio(be),(Pe=Math.max(Pe,De))+this.cameraBackgroundNear>this.cameraBackgroundFar&&(this.cameraBackgroundFar=Pe+this.cameraBackgroundNear);var we=this.currentViewpoint.getSightDirection().normalize();Me.addVectors(Me,we.multiplyScalar(this.cameraBackgroundNear))}this.ambience.updateSphere(Pe,Me,this.sphereEnv)}else this.removeEnvMap();if(n.useGroundShadow&&n.useShadowPlane&&!n._2DMode&&n._setGroundShadow(),V&&this._updateStaticOverrides&&(this._updateStaticOverrides=!1,this.internalSceneGraph.updateStaticOverrides()),this.cameraSystem){this.renderer.renderer._VRFrameBuffer=this.cameraSystem._extFrameBuffer;var Ee,Te,Ae=this.trackingViewpoint||M;if(2===(Ee=this.cameraSystem.computeCameraArray(M,Ae.camera.near,Ae.camera.far)).length&&(Ee[0]._renderingRole=t._CameraRoles.STEREO,Ee[1]._renderingRole=t._CameraRoles.STEREO),this.cameraSystem.useExternalProjectionMatrix){var Ie=1e-4*this.cameraBackgroundFar;this._nearFarBigScale&&(Ie=Math.min(.001,Ie)),Te=this.cameraSystem.computeCameraArray(M,Ie,this.cameraBackgroundFar)}var Re=[],Le=this.renderer.renderer.getViewportSize();for(ee=0;ee<Ee.length;ee++){if(this.renderer.renderer.cameraSystem_cameraIndex=ee,Re.push("cameraSystem"+ee),this.mobile||!this.useHDR?this.renderer.renderer.setSplitScreenMode(ee*Le.width,0):this.renderer.renderer.removeSplitScreenMode(),this.sphereEnv&&this.sphereEnv.material){var Oe=Ee[ee],Ne=this.sphereEnv.material;Oe.fullWidth?(Ne.invScreenSize.x=1/Oe.width,Ne.invScreenSize.y=1/Oe.height,Ne.startOffset.x=Oe.x/Oe.fullWidth,Ne.endOffset.y=1-Oe.y/Oe.fullHeight,Ne.endOffset.x=(Oe.x+Oe.width)/Oe.fullWidth,Ne.startOffset.y=1-(Oe.y+Oe.height)/Oe.fullHeight):(Ne.invScreenSize.x=1/Le.width,Ne.invScreenSize.y=1/Le.height,Ne.startOffset.x=0,Ne.startOffset.y=0,Ne.endOffset.x=1,Ne.endOffset.y=1)}this.renderCamera(Ee[ee],Te&&Te[ee],!1,D,w,E,T,A,I,R,Re[ee],m)}!this.mobile&&this.useHDR?this.renderer.combineResults(Re,P,this.cameraSystem)||this.render():this.renderer.renderer.enableScissorTest(!1)}else this.renderer.renderer._VRFrameBuffer=null,this.renderCamera(f,null,P,D,w,E,T,A,I,R,"main",m);return null!==M&&S&&null!==p&&(M.resetCameraOrientation(),M.reframe(void 0,void 0,void 0,_)),t.webGLStats&&t.webGLStats.dump(),O&&O.End(),n._viewerEffectSettings._setDownsamplingFactor(U),!D},this._requestShadowMapUpdate=e.subscribe({event:"/VISU/requestShadowMapUpdate"},function(e){n._updateShadowMaps()}),this._requestVisuUpdate=e.subscribe({event:"/VISU/requestVisuUpdate"},function(e){n.render()}),this.renderCamera=function(e,i,r,n,a,s,o,l,c,h,u,d){if((S=this.currentViewpoint)._renderedCamera=e,this.internalSceneGraph&&S&&(this.internalSceneGraph.selectionHL.updateHighlight(S),this.internalSceneGraph.selectionPreHL.updateHighlight(S),this.renderer.updateEffects(this.internalSceneGraph,this.currentViewpoint,c,n)),i)this.sceneBackground.remove(this.cameraBackground),this.cameraBackground=i,this.sceneBackground.add(this.cameraBackground);else{!this.cameraBackground.isOrtho&&!e.isOrtho||this.cameraBackground.isOrtho&&e.isOrtho?e.clone(this.cameraBackground):(this.sceneBackground.remove(this.cameraBackground),this.cameraBackground=e.clone(),this.sceneBackground.add(this.cameraBackground));var p=1e-4*this.cameraBackgroundFar;this._nearFarBigScale&&(p=Math.min(.001,p)),this.cameraBackground.near=p,this.cameraBackground.far=this.cameraBackgroundFar,this.cameraBackground.isOrtho&&(this.cameraBackground.near=this.cameraBackgroundNear),this.cameraBackground.updateProjectionMatrix(),this.cameraBackground.projectionMatrixInverse.getInverse(this.cameraBackground.projectionMatrix)}this.cameraBackground._setBackgroundRenderingRoleFromPrincipal(e),!this.cameraReflected.isOrtho&&!e.isOrtho||this.cameraReflected.isOrtho&&e.isOrtho?e.clone(this.cameraReflected):this.cameraReflected=e.clone(),this.cameraReflected.matrixAutoUpdate=!1;var f="zup"===this._worldOrientation._woName,m=new t.Matrix4(1,0,0,0,0,f?1:-1,0,0,0,0,f?-1:1,0,0,0,0,1),g=2*this._worldOrientation.upVector.dot(this.offsetPlaneBackground);m.setPosition((new t.Vector3).copy(this._worldOrientation.upVector).multiplyScalar(g));var v=(new t.Matrix4).copy(e.matrixWorld);if(m.multiply(v),this.cameraReflected.setMatrix(m),this.cameraReflected._setReflectedRenderingRoleFromPrincipal(e),this.SCREEN_WIDTH&&this.SCREEN_HEIGHT){var S,_=d>0&&this.useMirror,y=this._infinitePlane||this._displayGrid||this.ambience.getBackground().isActivated()||_,x=this.useShadowMap&&(this.useDefaultLights||this.isShadowMap());(S=this.currentViewpoint)._updateRobotCamera(this.internalSceneGraph),this.planeV2&&this.planeGrid&&this.planeGrid.updateLabels(S);var M={main:e,cameraBackground:this.cameraBackground,connectedRobotCamera:S.connectedRobotCamera,robotCameraOrtho:S.robotCameraOrtho,mirrorCamera:this.cameraReflected};if(this.renderer.render(y,_,x,this.sceneBackground,M,this.internalSceneGraph,this.infPlaneSmall,this.ambience.getGroundGlossiness(),r,n,this.hasSceneGraphOverrideSet(),a,s,o,l,c,h,u,!this._showHighlight,this.clipPlanes,this.directionalLight),window.__debugLoop__)for(var P=performance.now(),C=0;C<600;)C=performance.now()-P}},this.renderToTarget=function(e,i,r,a,s){this._viewerEffectSettings.copySettings("override","static"),s&&Object.entries(this._QMSettings).forEach(e=>{void 0!==n._QMSettings[e[0]].value.override&&(n._QMSettings[e[0]].value.override=e[1].value.static)}),this.renderer.recompileAllShaders([t.RendererMode.override]);var o=n.useSSAOIterative;a?(this._viewerEffectSettings._setFromJson("override",a),void 0!==a.IterativeSSAO&&n.setIterativeSSAO(!!a.IterativeSSAO)):(n.setIterativeSSAO(!1),"MSAA"===n._viewerEffectSettings.getSetting("AntiAliasing","override")&&n._viewerEffectSettings.setSetting("AntiAliasing","override","SMAA"));var l=n._viewerEffectSettings.getSSAO("override"),c="MSAA"===n._viewerEffectSettings.getAntiAliasing("override"),h="FSAA"===n._viewerEffectSettings.getAntiAliasing("override"),u=l&&n.useSSAOIterative||c,d=a&&a.NbIterations?Math.min(a.NbIterations,128):32,p=!1;if(n.SCREEN_WIDTH&&n.SCREEN_HEIGHT){n._renderingToTarget=!0;var f=this.devicePixelRatio||1;h&&(f*=2);var m=Math.floor(f*n.SCREEN_WIDTH),g=Math.floor(f*n.SCREEN_HEIGHT);e||(e={data:null,width:m,height:g,bufferWidth:0,bufferHeight:0,x:0,y:0}),(e.width>m||e.height>g)&&(p=!0),null===e.data||e.bufferWidth<e.width||e.bufferHeight<e.height?h?(e.data=new Uint8Array(4*e.width*e.height*4),e.bufferWidth=2*e.width,e.bufferHeight=2*e.height):(e.data=new Uint8Array(4*e.width*e.height),e.bufferWidth=e.width,e.bufferHeight=e.height):(e.bufferWidth=e.width,e.bufferHeight=e.height),e.x||(e.x=0),e.y||(e.y=0),n.autoUpdateFrustum&&n._updateNearFar();var v=i.camera;v.updateProjectionMatrix(),v.projectionMatrixInverse.getInverse(v.projectionMatrix);var S=n.getWebGLContext(),_=n.getRenderer();if(_.removeSplitScreenMode(),p){var y=0,x=-1;l&&(y=32,a&&a.MaxOverlap&&(y=a.MaxOverlap),n.renderer.SSAOEffect&&(x=n.renderer.SSAOEffect.maxPixelRadius,n.renderer.SSAOEffect.maxPixelRadius=y));var M=m-2*y,P=g-2*y,C=Math.ceil(e.width/M),b=Math.ceil(e.height/P),D=e.width,w=e.height,E=w-b*P,T=0,A=0,I=D,R=w,L=M,O=P,N=1,F=1;if(i.camera.fullWidth){var V={fullWidth:i.camera.fullWidth,fullHeight:i.camera.fullHeight,x:i.camera.x,y:i.camera.y,width:i.camera.width,height:i.camera.height};I=V.fullWidth,R=V.fullHeight,T=V.x,A=V.y,L*=N=V.width/D,O*=F=V.height/w}for(var U=i.camera,B=new Uint8Array(4*M*P),k=0;k<b;k++)for(var G=0;G<C;G++){var z=Math.min(M,e.width-G*M),H=Math.min(P,e.height-k*P),W=U.clone();if(W._renderingRole=U._renderingRole,W.setViewOffsetInternal(I,R,G*L+T-y*N,k*O+A-y*F,L+2*y*N,O+2*y*F),i.camera=W,u)for(var j=0;j<d;j++)n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0,renderIteration:j}]);else n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0}]);S.readPixels(y,y,M,P,S.RGBA,S.UNSIGNED_BYTE,B);var X=b-k-1,q=0;X>0&&(q=X*P+E);for(var Z=0;Z<H;Z++)for(var Y=0;Y<z;Y++){var K=D*(q+Z)+G*M+Y,J=(P-H+Z)*M+Y;e.data[4*K]=B[4*J],e.data[4*K+1]=B[4*J+1],e.data[4*K+2]=B[4*J+2],e.data[4*K+3]=B[4*J+3]}}i.camera=U,x>0&&(n.renderer.SSAOEffect.maxPixelRadius=x)}else if(r){var Q={xMin:Math.max(0,-e.x),xMax:Math.max(0,e.x+e.width-m),yMin:Math.max(0,-e.y),yMax:Math.max(0,e.y+e.height-g)},$=Q.xMin>0||Q.xMax>0||Q.yMin>0||Q.yMax>0,ee=e.x,te=e.y;if($)(ie=(U=i.camera).clone())._renderingRole=U._renderingRole,ie.setViewOffsetInternal(m,g,Q.xMin>0?-Q.xMin:Q.xMax>0?Q.xMax:0,Q.yMin>0?Q.yMin:Q.yMax>0?-Q.yMax:0,m,g),i.camera=ie,ee=Q.xMin>0?0:Q.xMax>0?m-e.width:e.x,te=Q.yMin>0?0:Q.yMax>0?g-e.height:e.y;if(_.setScissor(ee,te,e.width,e.height),_.enableScissorTest(!0),u)for(j=0;j<d;j++)n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0,renderIteration:j}]);else n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0}]);_.enableScissorTest(!1),$&&(i.camera=U),S.readPixels(ee,te,e.width,e.height,S.RGBA,S.UNSIGNED_BYTE,e.data)}else{var ie;(ie=(U=i.camera).clone())._renderingRole=U._renderingRole;ee=.5*(m-e.bufferWidth),te=.5*(g-e.bufferHeight);if(U.fullWidth){ee=0,te=g-e.bufferHeight;var re=e.width/e.bufferHeight*U.height;ie.x-=.5*(re-ie.width),ie.width=re;var ne=m/e.bufferWidth,ae=g/e.bufferHeight;ie.width*=ne,ie.height*=ae,this.ambience.setRenderTargetSize(e.width,e.bufferHeight,ee,te)}else this.ambience.setRenderTargetSize(e.width,e.bufferHeight,ee,te),ie.setViewOffsetInternal(e.bufferWidth,e.bufferHeight,-.5*(m-e.bufferWidth),-.5*(g-e.bufferHeight),m,g);if(ie.updateProjectionMatrix(),ie.projectionMatrixInverse.getInverse(ie.projectionMatrix),i.camera=ie,_.setScissor(Math.max(0,ee-8),Math.max(0,te-8),Math.min(m,e.bufferWidth+16),Math.min(g,e.bufferHeight+16)),_.enableScissorTest(!0),this.ambience.updateParameters(),u)for(j=0;j<d;j++)n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0,renderIteration:j}]);else n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0}]);this.ambience.setRenderTargetSize(0,0,0,0),this.ambience.updateParameters(),this.ambience.setRenderTargetSize(0,0,0,0),_.enableScissorTest(!1),i.camera=U,S.readPixels(ee,te,e.bufferWidth,e.bufferHeight,S.RGBA,S.UNSIGNED_BYTE,e.data)}this.ambience.updateParameters(),n.setIterativeSSAO(o),n.mobile?n.glRender([{viewpoint:i,onlyPostProcess:!1}]):n.render({onlyPostProcess:!1}),n._renderingToTarget=!1}},this._renderToCanvas=function(e,t){var i,r;if(this.svgRootNode){var n;(n=this.svgRootNode.cloneNode(!0)).setAttributeNS(null,"width",this.canvas.width),n.setAttributeNS(null,"height",this.canvas.height),n.style.left=0,n.style.top=0,n.style.width=this.canvas.width+"px",n.style.height=this.canvas.height+"px";var a=n.outerHTML?n.outerHTML:(new XMLSerializer).serializeToString(n),s=new Blob([a],{type:"image/svg+xml;charset=utf-8"}),o=window.URL.createObjectURL(s),l=new Image,c=this;l.onload=function(){i=c.canvas.width,r=c.canvas.height,l.width=i,l.height=r;var t={width:i,height:r,data:null};c.renderToTarget(t,c.currentViewpoint);var n=document.createElement("canvas");n.width=i,n.height=r;for(var a=n.getContext("2d"),s=a.createImageData(i,r),h=s.data,u=0;u<s.height;u++)for(var d=0;d<s.width;d++){var p=d+u*i,f=d+(r-u-1)*i;h[4*p]=t.data[4*f],h[4*p+1]=t.data[4*f+1],h[4*p+2]=t.data[4*f+2],h[4*p+3]=t.data[4*f+3]}a.putImageData(s,0,0),setTimeout(function(){var t=document.createElement("canvas");t.width=i,t.height=r;var a=t.getContext("2d");a.drawImage(l,0,0),a.drawImage(n,0,0),window.URL.revokeObjectURL(o),e(t)},100)},l.onerror=function(){window.URL.revokeObjectURL(o),t()},l.src=o}else{i=this.canvas.width,r=this.canvas.height;var h={width:i,height:r,data:null};this.renderToTarget(h,this.currentViewpoint);var u=document.createElement("canvas");u.width=i,u.height=r;for(var d=u.getContext("2d"),p=d.createImageData(i,r),f=p.data,m=0;m<p.height;m++)for(var g=0;g<p.width;g++){var v=g+m*i,S=g+(r-m-1)*i;f[4*v]=h.data[4*S],f[4*v+1]=h.data[4*S+1],f[4*v+2]=h.data[4*S+2],f[4*v+3]=h.data[4*S+3]}d.putImageData(p,0,0),e(u)}},this.renderCubemap=function(e,i,r,a,s){var l=new o(this,90,void 0,void 0,!1),c=l.camera;c.aspect=1,c.position=e,c.useQuaternion=!0;for(var h=new t.Vector3,u=0;u<6;u++){switch(u){case 0:c.up.set(0,-1,0),c.lookAt(h.addVectors(e,new t.Vector3(1,0,0)));break;case 1:c.up.set(0,-1,0),c.lookAt(h.addVectors(e,new t.Vector3(-1,0,0)));break;case 2:c.up.set(0,0,1),c.lookAt(h.addVectors(e,new t.Vector3(0,1,0)));break;case 3:c.up.set(0,0,-1),c.lookAt(h.addVectors(e,new t.Vector3(0,-1,0)));break;case 4:c.up.set(0,-1,0),c.lookAt(h.addVectors(e,new t.Vector3(0,0,1)));break;case 5:c.up.set(0,-1,0),c.lookAt(h.addVectors(e,new t.Vector3(0,0,-1)))}c.updateMatrix(),n.autoUpdateFrustum&&n._updateNearFar(),c.updateProjectionMatrix(),c.projectionMatrixInverse.getInverse(c.projectionMatrix),n.glRender([{viewpoint:l,toScreen:!1,onlyForward:!0,cubemap:!0,cubemapResolution:i,cubeFace:u}])}var d=this.renderer.compForwardComposerContext.renderResults.main;require(["DS/EffectsDebug/ConvertCubemapToLatlong","DS/Visualization/AmbianceGenerator"],function(e,i){if(n.renderer.compConvertCubeMapToLatLong||(n.renderer.compConvertCubeMapToLatLong=new e(n.renderer.renderer,n.renderer.renderTargetPool)),r){n.renderer.compConvertCubeMapToLatLong.setEnvMap(d);var o=n.getRenderer().ambianceGenerators;o.manager||(o.manager=new i(o.cb));var l=n.renderer.compConvertCubeMapToLatLong.composers[1],c=o.manager._getGenerator("shoot360",!1);c.setCallBack(function(){var e=n.renderer.compConvertCubeMapToLatLong.saveComposer.composerContext.getResult(void 0,!0);e.hdr=!0,e.mapping=new t.LatLongReflectionMapping;var i=c._getResult();if(a){var r={map0:e,map1:i,position:a.position,geomProxy:new t.Box3(a.minAABB,a.maxAABB)};n.internalSceneGraph.scene.reflectionProbes.push(r),n.renderer.recompileAllShaders(null)}else n.internalSceneGraph.scene.envMipMap[0]=e,n.internalSceneGraph.scene.envMipMap[1]=i;n.renderer.renderer.ambianceGenerators._decreaseSceneUseCount(n.internalSceneGraph.scene),s&&s()}),c.setValues(l),n.renderer.compConvertCubeMapToLatLong.execute(),n.renderer.compConvertCubeMapToLatLong.encodeRGBE(),c.execute(),o.manager._disposeGenerator("shoot360",!1)}else n.renderer.compConvertCubeMapToLatLong.setEnvMap(d),n.renderer.compConvertCubeMapToLatLong.execute(),n.renderer.compConvertCubeMapToLatLong.renderToScreen(),n.renderer.compConvertCubeMapToLatLong.saveAsHDR("reflection"),s&&s()})},this.grabDepthBuffer=function(e){if(n.SCREEN_WIDTH&&n.SCREEN_HEIGHT){var t=this.devicePixelRatio||1,i=Math.floor(t*n.SCREEN_WIDTH),r=Math.floor(t*n.SCREEN_HEIGHT);e||(e={data:null,_dataUint8:null,width:i,height:r,bufferWidth:0,bufferHeight:0}),(e.width>i||e.height>r)&&(e.width=i,e.height=r),(!e._dataUint8||e.bufferWidth<e.width||e.bufferHeight<e.height)&&(e._dataUint8=new Uint8Array(4*e.width*e.height),e.data=null,e.bufferWidth=e.width,e.bufferHeight=e.height);var a=n.getWebGLContext();return this.renderer.computeDepthBuffer(this.internalSceneGraph,this.currentViewpoint,!0),a.readPixels(0,0,e.width,e.height,a.RGBA,a.UNSIGNED_BYTE,e._dataUint8),e.data=new Float32Array(e._dataUint8.buffer),e}};var m=this._getForceRenderTargetSize();switch(m?(this.SCREEN_WIDTH=m.width/this.devicePixelRatio,this.SCREEN_HEIGHT=m.height/this.devicePixelRatio):this.useOffscreenCanvas?(this.SCREEN_WIDTH=this.canvas.width,this.SCREEN_HEIGHT=this.canvas.height):(this.SCREEN_WIDTH=this.canvas.offsetWidth,this.SCREEN_HEIGHT=this.canvas.offsetHeight),this.ambience.resize(this.SCREEN_WIDTH,this.SCREEN_HEIGHT,this.devicePixelRatio,this.renderer),this.initResources(this.canvas),this.onWebGLContextLost=function(e){console.log("WebGL context Lost !"),e.preventDefault()},this._contextMenu=function(e){e.preventDefault()},this.canvas.addEventListener("webglcontextlost",this.onWebGLContextLost,!1),this.onWebGLContextRestore=function(){window.__debugLoop__=!1,n.renderer.renderer.restoreGLContext(),n.render()},this.canvas.addEventListener("webglcontextrestored",this.onWebGLContextRestore,!1),this.renderer=new u({canvas:this.canvas,context:this.materialManager.getContext(),debugWebgl2:this.debugWebgl2,divCSS:this.divCss3DElement,useOffscreenCanvas:this.useOffscreenCanvas,deferred:this.deferred,useCompositing:!this.mobile&&this.useHDR,tonemapping:1,bgColor:this.ambience.getBackgroundColor().getHex(),bgAlpha:this.ambience.getBackgroundAlpha(),viewer:this,visibleSpace:this.visibleSpace,compareSettings:this._compareSettings,antiAliasing:!(this.useHDR&&!this.mobile||!this.antiAliasing||"NoAA"===this.antiAliasing)||"NoAA",forcePostProHighlight:!!i.forcePostProHighlight&&!t.isIOS(),preserveDrawingBuffer:i.preserveDrawingBuffer,debugContext:i.debugContext}),this._viewerEffectSettings._checkCompatibility(),this.renderer.renderer.precomputedTexture=this.materialManager.precomputedTexture,this.renderer.renderer.noiseTexture3D=this.materialManager.noiseTexture3D,this.renderer.renderer.precomputedAreaGGX1texture=this.materialManager.precomputedAreaGGX1texture,this.renderer.renderer.precomputedAreaGGX2texture=this.materialManager.precomputedAreaGGX2texture,this.renderer.renderer.precomputedAreaAshikmintexture=this.materialManager.precomputedAreaAshikmintexture,this.renderer.renderer.precomputedAreaEsteveztexture=this.materialManager.precomputedAreaEsteveztexture,this.renderer.renderer.precomputedAreaBeckmanntexture=this.materialManager.precomputedAreaBeckmanntexture,this.renderer.renderer.ambianceGenerators=t._AmbianceGenerators,this.renderer.renderer.ambianceGenerators.viewers.push(this),this.renderer.renderer.sssGenerator=t._SSSGenerator,this.renderer.renderer.sssGenerator.viewers.push(this),this.renderer.renderer.visibleSpace=this.visibleSpace,this.renderer.renderer.newMaterialInheritance=window.newMaterialInheritance,this.antiAliasing){case"NoAA":break;case"FXAA":this.renderer.setEffect("FXAA",!0);break;case"MLAA":this.renderer.setEffect("MLAA",!0);break;case"SMAA":this.renderer.setEffect("SMAA",!0);break;case"MSAA":this.renderer.setEffect("MSAA",!0);break;case"TAA":this.renderer.setEffect("TAA",!0);break;case"FSAA":case"SSAA":this.renderer.setEffect("FSAA",!0)}function g(i,r){if(n){n.fpsCounter&&n.fpsCounter.onAnimate(),x.RecordEventsManager&&x.RecordEventsManager.pushRecordAnimateEvent(n),n._idPathOverrideWatcher&&n._idPathOverrideWatcher.update(),!r&&n.defaultAnimationLoop&&requestAnimationFrame(g),n.isRenderIteration||(n.renderIteration=0),n.capturer&&n.capturer.capture(n.canvas,n.renderIteration);var a,s,o,l,c,u,d,p,f=new h,m=new Date,v=m.getTime()-n._oldTime;n._oldTime=m.getTime(),f.step(v),l=!1,p=n.renderer.renderer._renderScale*(t.getDevicePixelRatio()||1);var S=n._getForceRenderTargetSize();S?(u=S.width,d=S.height,n.div.offsetWidth===n.lastViewerWidth&&n.div.offsetHeight===n.lastViewerHeight||(n.currentViewpoint.camera.aspect=n.SCREEN_WIDTH/n.SCREEN_HEIGHT,n.lastViewerWidth=n.div.offsetWidth,n.lastViewerHeight=n.div.offsetHeight,n.canvas.style.width=n.lastViewerWidth+"px",n.canvas.style.height=n.lastViewerHeight+"px")):n.useOffscreenCanvas?(u=n.canvas.width||1,d=n.canvas.height||1):(u=n.div.offsetWidth||1,d=n.div.offsetHeight||1);var _=!1;if(n.lazyResize?n.oldCanvasSize.width!==u||n.oldCanvasSize.height!==d||n.oldCanvasSize.dpr!==p?(n.oldCanvasSize.width=u,n.oldCanvasSize.height=d,n.oldCanvasSize.dpr=p,n.oldCanvasSize.time=(new Date).getTime(),l=!0):n.oldCanvasSize.time>=0&&(new Date).getTime()-n.oldCanvasSize.time>300&&(n.oldCanvasSize.time=-1,_=!0):n.SCREEN_WIDTH===u&&n.SCREEN_HEIGHT===d&&n.devicePixelRatio===p||(_=!0,l=!0),n.devicePixelRatio=p,l&&n.currentViewpoint&&(n.currentViewpoint.camera._hasChanged=!0),n.cameraSystemUpdated&&(n.cameraSystemUpdated=!1,_=2),_&&function(e,t){var i,r;(l=n._getForceRenderTargetSize())?(n.SCREEN_WIDTH=l.width/n.devicePixelRatio,n.SCREEN_HEIGHT=l.height/n.devicePixelRatio):n.useOffscreenCanvas?(n.SCREEN_WIDTH=n.canvas.width||1,n.SCREEN_HEIGHT=n.canvas.height||1):(n.SCREEN_WIDTH=n.div.offsetWidth||1,n.SCREEN_HEIGHT=n.div.offsetHeight||1);n.svgRoot&&n._updateSVGVisu();if(n.multiViewer){var a=Math.max(1,Math.floor(n.devicePixelRatio*n.SCREEN_WIDTH)),s=Math.max(1,Math.floor(n.devicePixelRatio*n.SCREEN_HEIGHT));n.materialManager.setCanvasSize(this,a,s)}if(n.cameraSystem){var o=n.cameraSystem.getViewportSize(n.SCREEN_WIDTH,n.SCREEN_HEIGHT);i=o.width,r=o.height}else i=n.SCREEN_WIDTH,r=n.SCREEN_HEIGHT;var l,c=void 0,h=void 0;(l=n._getForceRenderTargetSize())&&(c=n.div.offsetWidth,h=n.div.offsetHeight);n.renderer.setRendererSize(n.SCREEN_WIDTH,n.SCREEN_HEIGHT,n.useOffscreenCanvas||t,i,r,n.devicePixelRatio,c,h),n._viewpointManager.resize(i,r),n.ambience.resize(i,r,n.devicePixelRatio,n.renderer),n.renderIteration=0,n.render()}(0,2===_),null!==n.currentViewpoint){if(null!==(s=n.currentViewpoint.getControl())&&s.update(),(a=n.currentViewpoint.camera)&&(a.updateMatrix(),a.matrixWorld.copy(a.matrix),a.matrixWorldInverse.getInverse(a.matrixWorld)),n.autoUpdateFrustum)n._updateNearFar()&&(n.renderIteration=0);a.updateProjectionMatrix(),a.projectionMatrixInverse.getInverse(a.projectionMatrix),(o=a.getLookAt()).add(a.position),l&&(e.publish({event:"/VISU/onWindowResized",data:{eventChannel:"/VISU/onWindowResized",eventType:"@onWindowResized",viewpoint:n.currentViewpoint,cameraEye:a.position,cameraTarget:o,cameraUp:a.up}}),n._modelEvent.publish({event:"Resize",data:{width:u,height:d}})),t.ImageUtils.nbTexturesBeingLoaded<n.lastNbTexturesBeingLoaded&&n.render(),n.lastNbTexturesBeingLoaded=t.ImageUtils.nbTexturesBeingLoaded;var y=n._requestRender;y&&!n._onlyPostProcess&&(n.renderIteration=0),n._onlyPostProcess=!0;var M=!1;n._viewerEffectSettings._setAntiAliasing(n.renderIteration>0?"static":"dynamic"),n.renderIteration<n.renderer.getMaxIterationEffects()&&(M=!0),M=M&&!n.forceRender;var P=!n._QMMode,C=P&&1===n.renderIteration,b=P&&n.renderIteration>0;if(y||b&&M||n.forceRender||C){if(n._requestRender=!1,c=n._renderParams,n._renderParams=[],c.length?(c[0].renderIteration=n.renderIteration,c[0].isStillFrame=b,c[0].forceRender=n.forceRender,c[0].onlyPostProcess=c[0].onlyPostProcess&&!M):c.push({renderIteration:n.renderIteration,isStillFrame:b,forceRender:n.forceRender}),n.forceRender=!1,n.debugFPS){var D=performance.now()-n.debugFPSInfos.fpsLastTime;n.debugFPSInfos.fpsLastTime=performance.now();var w=1e3/Math.max(D,.1);n.debugFPSInfos.fpsCumul+=w,n.debugFPSInfos.fpsCumul-=n.debugFPSInfos.fpsArray[n.debugFPSInfos.fpsIndex],n.debugFPSInfos.fpsValue=n.debugFPSInfos.fpsCumul/n.debugFPSInfos.fpsWindow,n.debugFPSInfos.fpsArray[n.debugFPSInfos.fpsIndex]=w,n.debugFPSInfos.fpsIndex=(n.debugFPSInfos.fpsIndex+1)%n.debugFPSInfos.fpsWindow,n.debugFPSInfos.fpsCounter.setHTML(Math.ceil(n.debugFPSInfos.fpsValue).toString())}var E=n.glRenderMultiVP(c);if(!n)return;if(0===n.renderIteration&&(n.timeIter0=m.getTime()),E&&(M||n.renderIteration<2)&&n.renderIteration++,n.renderer.renderer._texturesToResize.size&&n.renderer.resizeNPOTTexture(),n.multiViewer){var T=n.materialManager.getCanvas();n.context2D.globalCompositeOperation="copy",n.context2D.drawImage(T,0,T.height-n.canvas.height,n.canvas.width,n.canvas.height,0,0,n.canvas.width,n.canvas.height)}n._modelEvent.publish({event:"PostRender",data:{viewer:n,viewpoint:n.currentViewpoint}})}}}}return this.renderer.setEffect("Vignetting",this.useVignetting),this.renderer.setEffect("SSAO",this.useSSAO&&!this.useSSAOIterative),this.renderer.setEffect("SSAOIterative",this.useSSAO&&this.useSSAOIterative),this.renderer.setEffect("SSLR",this.useSSLR),this.renderer.setEffect("DOF",this.useDOF),this.renderer.setEffect("Bloom",this.useBloom),this.renderer.setEffect("Flare",this.useFlare),this.renderer.setEffect("OIT",f),this.renderer.setEffect("OITnoZ",f),this.setPicking({}),this.setPrePicking({}),this.useDefaultLights&&function(){n.setAmbientLight(2236962),n.directionalLight=new t.DirectionalLight(16777215,.81*Math.PI),n.directionalLight._phongReduction=!0;var e=n.directionalLight;e.position.set(40,40,40),e.castShadow=n.useShadowMap,e.shadowCameraNear=40,e.shadowCameraFar=150,e.shadowBias=-.001,e.shadowDarkness=.65,e.shadowMapWidth=n.shadowMapWidth,e.shadowMapHeight=n.shadowMapHeight,n.renderer.renderer.shadowMapAutoUpdate=!0,e.shadowCascade=!1,n.triLights?(e.intensity=.49*Math.PI,e.shadowDarkness=.3,n.directionalLight2=new t.DirectionalLight(16777215,.49*Math.PI),n.directionalLight2._phongReduction=!0,n.directionalLight3=new t.DirectionalLight(16777215,.49*Math.PI),n.directionalLight3._phongReduction=!0,n.directionalLight3.position.set(40,-40,40)):(n.directionalLight2=new t.DirectionalLight(3827071,1*Math.PI),n.directionalLight2._phongReduction=!0);n.directionalLight2.position.set(40,-40,40)}(),function(){n.dirLightGroundShadow=new t.DirectionalLight(16777215,0);var e=n.dirLightGroundShadow;e.position.set(0,0,40),e.castGroundShadow=n.useGroundShadow,e.onlyShadow=!0,e.shadowCascade=!1,e.shadowMapWidth=n.shadowMapWidth,e.shadowMapHeight=n.shadowMapHeight,e.shadowCameraNear=40,e.shadowCameraFar=150,e.shadowBias=-.001,e.shadowDarkness=.65}(),function(e){this.div.appendChild(this.renderer.renderer.domElement),e||document.addEventListener("contextmenu",this._contextMenu,!0);void 0===x._isInit&&x.init();this.manipulatorManager=new M(this)}.apply(this,[i.enableDocumentContextMenu]),this.defaultAnimationLoop&&g(0,!1),this.animate=g,this.addEvent("onPostInject",function(){g(0,!0)}),this.internalSceneGraph=new l(this,this.multiViewerFix,!i.showReferenceAxisSystem),this._safeInternalSceneGraph=this.internalSceneGraph,null!==this.currentViewpoint&&this.internalSceneGraph.scene.add(this.currentViewpoint.getCamera()),this.internalSceneGraph.scene.add(this.ambientLight),this.useDefaultLights&&(this.internalSceneGraph.scene.add(this.directionalLight),this.internalSceneGraph.scene.add(this.directionalLight2),this.triLights&&this.internalSceneGraph.scene.add(this.directionalLight3)),this.internalSceneGraph.scene.add(this.dirLightGroundShadow),this._glFPSCounter=null,this._glInfoCounter=null,this._glNodeCounter=null,this.fpsCounter=null,this.blurShadowEffect=null,this.displayHighlight=!1,this.name="",this.debugLocalBBox=!1,this.debugBBox=!1,this.debugHandleMatrix=!1,this.localBBox=null,this.BBox=null,(Q=Q||this.ODTMode)||this.setAdvancedPoliteHighlight(null,null),this},setWorldOrientation:function(e){var t;for(this._worldOrientation=e,t=0;t<this.viewpoints.length;t++)this.viewpoints[t]._setWorldOrientation(e);this._setPlaneGridOrientation(),this.internalSceneGraph.setWorldOrientation(e),this.renderer.renderer._setWorldOrientation(e),this._updateDirectionalLightWorldOrientation(e),this.ambience.setWorldOrientation(e),this.render({updateInfinitePlane:!0})},getWorldOrientation:function(){return this._worldOrientation},buildSkeleton:function(){null===this.div?(this.elements.container=UWA.createElement("div"),this.div=this.elements.container,this.div.setStyles({width:"100%",height:"100%"})):this.elements.container=UWA.extendElement(this.div),this.div.style["-ms-touch-action"]="none",this.canvas=UWA.createElement("canvas");this.canvas.webGLViewer=this,N.isActive()&&(this.canvas.setAttribute("data-rec-id","FakeRecManager"),N.registerElement(this.canvas,"DS/WebVisuRecord/FakeRec",!0));var e={width:"100%",height:"100%"};if(this._svgMode&&!L.getWebGLMode()){e.zIndex=10,e.position="absolute",e.left="0px";var t=document.createElementNS(this.getSvgNS(),"svg");t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.top="0px",t.style.left="0px",t.style.backgroundColor="white",t.style.zIndex=0,this.svgRootNode=t,this.svgRoot=document.createElementNS(this.getSvgNS(),"g"),this.svgRootNode.appendChild(this.svgRoot),this.div.appendChild(this.svgRootNode)}this.canvas.setStyles(e),this.useOffscreenCanvas&&(this.canvas.width=this.div.width,this.canvas.height=this.div.height),this.div.appendChild(this.canvas),N.isActive()&&(this.canvas.webGLViewer=this,this.canvas.isWebGLCanvas=function(){return!0})},getSvgNS:function(){return"http://www.w3.org/2000/svg"},addBackgroundSVGNode:function(e){e&&e._cssSVGNode&&(this.renderer.resetGSSOCache(),this.internalSceneGraph.svgRoot.addChild(e),this._updateSVGVisu())},removeBackgroundSVGNode:function(e){e&&e._cssSVGNode&&(this.renderer.resetGSSOCache(),this.internalSceneGraph.svgRoot.removeChild(e),this._updateSVGVisu())},getAllBackgroundSVGNodes:function(){return this.internalSceneGraph.svgRoot.children.concat([])},clearBackgroundSVGNodes:function(){this.renderer.resetGSSOCache();var e,t=this.getAllBackgroundSVGNodes();for(e=0;e<t.length;e++)this.removeBackgroundSVGNode(t[e])},buildSkeletonCss:function(){null===this.divCssElement?(this.divCssElement=UWA.createElement("div"),this.divCssElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),this.div.appendChild(this.divCssElement)):this.divCssElement=UWA.extendElement(this.divCssElement),this.divCssElement.style.WebkitTransformStyle="preserve-3d",this.divCssElement.style.MozTransformStyle="preserve-3d",this.divCssElement.style.oTransformStyle="preserve-3d",this.divCssElement.style.transformStyle="preserve-3d",this.divCssElement.id="divCssElement",this.divCss3DElement=UWA.createElement("div"),this.divCss3DElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),this.divCss3DElement.style.WebkitTransformStyle="preserve-3d",this.divCss3DElement.style.MozTransformStyle="preserve-3d",this.divCss3DElement.style.oTransformStyle="preserve-3d",this.divCss3DElement.style.transformStyle="preserve-3d",this.divCss3DElement.id="divCss3DElement",this.divCssElement.appendChild(this.divCss3DElement),this.divCss2DElement=UWA.createElement("div"),this.divCss2DElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),this.divCss2DElement.id="divCss2DElement",this.divCssElement.appendChild(this.divCss2DElement),this.divTrap=UWA.createElement("div",{id:"trapSelection"}),this.div.appendChild(this.divTrap)},initResources:function(e){var t=(!this.useHDR||this.mobile)&&this.antiAliasing&&"NoAA"!==this.antiAliasing;this.materialManager=new g(u.testMode.testMode,this.multiViewer,t,this),this.multiViewer=this.materialManager.multiViewer,this.multiViewer&&(this.materialManager.setCanvasSize(this,e.offsetWidth,e.offsetHeight),this.context2D=e.getContext("2d"))},getCanvasSize:function(){return{width:Math.floor(this.devicePixelRatio*this.SCREEN_WIDTH),height:Math.floor(this.devicePixelRatio*this.SCREEN_HEIGHT)}},onBackgroundModify:function(e){return this._modelEvent.subscribe({event:"VisuBackgroundColor",data:this.ambience.getBackgroundColor().getHex()},e)},onSwapVisibleSpace:function(e){return this._modelEvent.subscribe({event:"SwapVisibleSpace"},e)},onViewerResize:function(e){return this._modelEvent.subscribe({event:"Resize"},e)},onPreRender:function(e){return this._modelEvent.subscribe({event:"PreRender"},e)},onPostRender:function(e){return this._modelEvent.subscribe({event:"PostRender"},e)},onActivate:function(e){return this._modelEvent.subscribe({event:"Activate"},e)},onPreactivate:function(e){return this._modelEvent.subscribe({event:"Preactivate"},e)},onContext:function(e){return this._modelEvent.subscribe({event:"Context"},e)},unsubscribe:function(e){this._modelEvent.unsubscribe(e)},unsubscribeFromArray:function(e){if(e&&e.length)for(var t=0;t<e.length;t++)this.unsubscribe(e[t])},setMaterialMode:function(e){var t=this.renderer.renderer.materialMode!==e;this._renderStyle&&(this._renderStyle.setMaterialMode(e),this.internalSceneGraph.root.forceUpdate()),t&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.renderer.resetGSSOCache(),this.renderer.renderer.materialMode=!!e,this.render(),this._modelEvent.publish({event:"MaterialMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getMaterialMode:function(){return this.renderer.renderer.getMaterialMode(null,!1)},onMaterialModeChange:function(e){return this._modelEvent.subscribe({event:"MaterialMode"},e)},setPlaneViewMode({mode:e,plane:t}){let i=!1;null!=e&&e!==this._planeViewMode.mode&&(this._planeViewMode.mode=e,i=!0),t&&(this._planeViewMode.plane.copy(t).normalize(),i=!0),i&&(this.renderer.renderer._planeViewMode=this._planeViewMode,this.renderer.resetGSSOCache(),this.renderer.recompileAllShaders())},getPlaneViewMode(){return{mode:this._planeViewMode.mode,plane:this._planeViewMode.plane.clone()}},setBackgroundViewMode(e){this._backgroundViewMode!==e&&(this._backgroundViewMode=e,this.renderer.renderer._backgroundViewMode=e,this.renderer.resetGSSOCache(),this.renderer.recompileAllShaders())},getBackgroundViewMode(){return this._backgroundViewMode},invertNodeBackgroundView(e){this._invertBackgroundNodes!==e&&(this._invertBackgroundNodes=e,this.renderer.renderer._invertBackgroundNodes=e,this.renderer.resetGSSOCache(),this.renderer.recompileAllShaders())},isNodeBackgroundViewInverted(){return this._invertBackgroundNodes},pickNodeBackgroundView(e){this._pickBackgroundNodes!==e&&(this._pickBackgroundNodes=e,this.renderer.renderer._pickBackgroundNodes=e,this.renderer.resetGSSOCache())},isNodeBackgroundViewPickable(){return this._pickBackgroundNodes},setGasLookMode:function(e){this.setVisuAppearanceMode(e?t.DefaultAppearanceMode._GASLOOK_OLD:t.DefaultAppearanceMode.BASIC)},setVisuAppearanceMode:function(e){var i=this.renderer.renderer._defaultAppearanceType;if(this.renderer.renderer._defaultAppearanceType=e,i!==this.renderer.renderer._defaultAppearanceType){if(this.renderer.resetGSSOCache(),e!==t.DefaultAppearanceMode.__QA_AUTOMATION__&&i!==t.DefaultAppearanceMode.__QA_AUTOMATION__)switch(i){case t.DefaultAppearanceMode.GASLOOK:case t.DefaultAppearanceMode._GASLOOK_OLD:case t.DefaultAppearanceMode.GENERIC_PLASTIC:case t.DefaultAppearanceMode.GENERIC_METAL:case t.DefaultAppearanceMode._TRANSPARENT:t.cleanPredefinedMaterialCache();break;case t.DefaultAppearanceMode.CAST_ALUMINUM:case t.DefaultAppearanceMode.MACHINED_ALUMINUM:case t.DefaultAppearanceMode.CAST_STEEL:case t.DefaultAppearanceMode.BRUSHED_STEEL:case t.DefaultAppearanceMode.MACHINED_STAINLESS_STEEL:case t.DefaultAppearanceMode.COPPER:case t.DefaultAppearanceMode.BRASS:t.cleanPredefinedMaterialTextureCache()}this.render(),e!==t.DefaultAppearanceMode.__QA_AUTOMATION__&&this._modelEvent.publish({event:"VisuAppearanceMode",data:{viewer:this,value:this.getVisuAppearanceMode()}})}},getVisuAppearanceMode:function(){for(var e=Object.keys(t.DefaultAppearanceMode),i=0;i<e.length;i++)if(t.DefaultAppearanceMode[e[i]]===this.renderer.renderer._defaultAppearanceType)return e[i];return""},onVisuAppearanceModeChange:function(e){return this._modelEvent.subscribe({event:"VisuAppearanceMode"},e)},_setDebugMaterial:function(e){this.renderer.renderer._debugMaterialMode!==e&&(this.renderer.renderer._debugMaterialMode=e,this.renderer.recompileAllShaders(null),this.renderer.resetGSSOCache(),this.render())},setCustomMaterialModeParameters:function(e){if(e&&this.renderer){var i=this.renderer.renderer._customMaterialModeParams,r=!1;if(void 0!==e.useColorFromGAS&&(e.useColorFromGAS!==i.colorFromGAS&&(t.cleanPredefinedMaterialCache(),r=!0),i.colorFromGAS=e.useColorFromGAS),void 0!==e.color){var n=new t.Color(e.color);r=r||i.color.getHex()!==n.getHex(),i.color.copy(n)}void 0!==e.shininess&&(r=r||i.shininess!==e.shininess,i.shininess=e.shininess),void 0!==e.opacity&&(r=r||i.opacity!==e.opacity,i.opacity=e.opacity),r&&(this.renderer.resetGSSOCache(),this.render(),this._modelEvent.publish({event:"CustomMaterialModeParameters",data:{viewer:this,value:i}}))}},getCustomMaterialModeParameters:function(){return this.renderer?this.renderer.renderer._customMaterialModeParams:null},onCustomMaterialModeParametersChange:function(e){return this._modelEvent.subscribe({event:"CustomMaterialModeParameters"},e)},setDefaultPicking:function(i){this._defaultPicking=!!i;if(i){var r=WUX.Selection.PSOManager;this.centerMouseDownCB=function(e,t){},this.mouseMoveCB=function(t,i){var n=t.view;if(!x.RecordEventsManager||n){var o=t.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(n!==o&&!n.renderable){for(;n!==o&&n.parentElement&&!n.renderable;)n=n.parentElement;if(!n.renderable)return void(this.lastAddedToPSO&&!this.lastAddedToPSO.ownedByUser?(r.remove(this.lastAddedToPSO),this.lastAddedToPSO=null):this._modelEvent.publish({event:"Preactivate",data:{viewer:this,event:t,pickingResult:null,ctrl:i.isCtrlKeyPressed(),shift:i.isShiftKeyPressed()}}))}if(i&&!i.isMiddleButtonPressed()){var l,c,h,u;if(l=this.getMousePosition(t.getCurrentPosition(this.canvas)),this.pPicking.activated&&(!this.manipulatorManager||!this.manipulatorManager.isInManipulation(!0,!0))&&(!this.pPicking.disableWhileMoving||this.pPicking.disableWhileMoving&&this.currentViewpoint&&!this.currentViewpoint.isMoving())){if(u="mesh",u=this.pPicking.gpu?2===this.pPicking.primitive?"repHybrid":this.pPicking.primitive?"primHybrid":"mesh":2===this.pPicking.primitive?"repCPU":this.pPicking.primitive?"primCPU":"mesh",c=this.pick(l,u,this.pPicking.computeNormalDepth),h=!1,r.isEmpty()&&!c.path.length||(h=!0),this._fillXSOMode)if(c.path.length){if(this.pPicking.displayHL){var d=null;if(c.path[0]&&(d=c.path[0].getLastElement(!0)),d instanceof a&&!d._getExcludeFromPreHL()&&!d._getExcludeFromPSO()){for(var p,f=c.path[0];f&&f.getLastElement(!0).getPickParent();)f=f.getParentPath();if(!this.multiViewerFix&&!window.userRootOutOfPathElements)if((p=f)&&p.externalPath.length>1){var m=p.externalPath.concat([]);m.shift(),f=new s,void 0!==p.instanceId&&(f.instanceId=p.instanceId),f.setFromArray(m,p.internalPath)}var g={pathElement:f,event:t};if(!r.isIn(g)||r.get().length>1){var v=r.get().slice();r.remove(v),r.add(g)}this.lastAddedToPSO=g}}}else r.isEmpty()||(this.lastAddedToPSO=null,r.empty());this._modelEvent.publish({event:"Preactivate",data:{viewer:this,event:t,pickingResult:c,ctrl:i.isCtrlKeyPressed(),shift:i.isShiftKeyPressed()}})}h&&this.render({onlyPostProcess:!0});var S,_="@pickNothing";if(c&&c.path.length){var y=c.path[0].getLastElement();y instanceof THREEDS.SubElement?"primitive"===y.getType()?_="@pickPrimitive":"rep"===y.getType()&&(_="@pickRep"):null!==y&&(_="@pickMesh")}S="@pickNothing"===_?{eventChannel:"/VISU/",eventType:"@onMoveEvent",eventID:_,event:t}:{eventChannel:"/VISU/",eventType:"@onMoveEvent",eventID:_,event:t,from:c.path[0],point:c.position,normal:c.normal,tangent:c.tangent,uv:c.uv,ray:c.ray},e.publish({event:"/VISU/",data:S}),this.debugEvents>=6&&console.log(S)}}},this.centerMouseUpCB=function(i,r){if(r&&r.isMiddleClick()){var n,a;n=this.getMousePosition(i.getCurrentPosition(this.canvas)),r.lockPan||r.lockReframeOnDblTap||null===this.currentViewpoint||(null!==(a=this.pick(n,"mesh",!0)).position?this.currentViewpoint.centerCamera(a.position):r._2DMode&&this.currentViewpoint.centerCameraSVG(new t.Vector2(.5*this.div.clientWidth,.5*this.div.clientHeight),new t.Vector2(n.xPix,n.yPix)));var s={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@middleClick",event:i};e.publish({event:"/VISU/",data:s}),this.debugEvents>=6&&console.log(s)}},this.leftMouseDownCB=function(t,i){var r=t.view;if(!x.RecordEventsManager||r){var n=t.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap,a=t.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(r===n&&(r=a),r!==a&&!r.renderable){for(;r!==a&&r.parentElement&&!r.renderable;)r=r.parentElement;if(!r.renderable)return}if(i&&!i.isMiddleButtonPressed()&&i.isLeftClick()){if(this.picking.trapSelection&&this.trapSelection){var s=this.getMousePosition(t.getCurrentPosition(this.canvas)),o=this.pick(s,"mesh",!1);if(o&&o.path&&o.path.length)for(var l=o.path[0].externalPath,c=0;c<l.length;c++)if(l[c].getIsManipulator()){this.trapSelection.interrupt();break}}var h={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@leftClickDown",event:t};e.publish({event:"/VISU/",data:h}),this.debugEvents>=6&&console.log(h)}}},this.leftMouseUpCB=function(e,t){this._doPickingFromMouseEvent(e,t,null)},this._doPickingFromMouseEvent=function(t,i,r){if(this._defaultPicking){var n,a=r||this.trapSelection,o=t.view;if(!x.RecordEventsManager||o){var l=t.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap,c=t.path&&this.canvas.impl?this.canvas.impl:this.canvas;o===l&&(o=c);var h=!1;if(this.picking.trapSelection&&a&&(h=void 0!==(n=a.getExtremities()).pt&&(n.xPix!=n.pt.xPix||n.yPix!=n.pt.yPix)),!h&&o!==c&&!o.renderable){for(;o!==c&&o.parentElement&&!o.renderable;)o=o.parentElement;if(!o.renderable)return void null}if(i&&!i.isMiddleButtonPressed()){if(this.picking.activated){var u,d;null,null,null,null,h||(n=this.getMousePosition(t.getCurrentPosition(this.canvas)));var p=a&&a.isActive,f=this.magnifier&&this.magnifier.active&&"Touch"===t.getType(),m=t.contextButton?i.isRightClick():i.isLeftClick();if(!p&&(!f||window.magnifierCheckDistance&&!this.magnifier.displayed)&&!m)return;if(window.magnifierCheckDistance&&f&&this.magnifier.displayed){if(this.magnifier.displayed=!1,!this.magnifier.enableSelection)return;this.magnifier.enableSelection=!1}if(!r&&this.manipulatorManager&&this.manipulatorManager.isInManipulation())return;o!==c&&(n.event=t),d="mesh",d=h&&this.picking.trapSelection?this.picking.trapGPU?2===this.picking.trapPrimitive?"repHybrid":this.picking.trapPrimitive?"primHybrid":"mesh":2===this.picking.trapPrimitive?"repCPU":this.picking.trapPrimitive?"primCPU":"meshCPU":this.picking.gpu?2===this.picking.primitive?"repHybrid":this.picking.primitive?"primHybrid":"mesh":2===this.picking.primitive?"repCPU":this.picking.primitive?"primCPU":a&&n.pt?"meshCPU":"mesh",u=this.pick(n,d,this.picking.computeNormalDepth,void 0,r);var g,v,S=i.isShiftKeyPressed(),_=i.isCtrlKeyPressed()||this.forceMultiSel,y=(h=void 0!==n.pt&&(n.xPix!=n.pt.xPix||n.yPix!=n.pt.yPix),0);if(!this.multiViewerFix&&!window.userRootOutOfPathElements)for(y=0;y<u.path.length;y++)if((g=u.path[y])&&g.externalPath.length>1){var M=g.externalPath.concat([]);M.shift(),u.path[y]=new s,u.path[y].setFromArray(M,g.internalPath),void 0!==g.instanceId&&(u.path[y].instanceId=g.instanceId)}if(this._fillXSOMode&&(v=this.addToCSOHSO(u,{event:t,multiSel:_,additiveMode:S,trapSel:h})),null!==this.internalSceneGraph){if(this._fillXSOMode){var P="@pickNothing";if(u.path.length){var C=u.path[0].getLastElement();C instanceof THREEDS.SubElement?"primitive"===C.getType()?P="@pickPrimitive":"rep"===C.getType()&&(P="@pickRep"):null!==C&&(P="@pickMesh")}var b={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:P,event:t,from:u.path[0],addedToCSO:v.addedToCSO,removedFromCSO:v.removedFromCSO,point:u.position,normal:u.normal,tangent:u.tangent,uv:u.uv,ray:u.ray};e.publish({event:"/VISU/",data:b}),this.debugEvents>=6&&console.log(b)}this._modelEvent.publish({event:"Activate",data:{viewer:this,event:t,pickingResult:u,ctrl:i.isCtrlKeyPressed(),shift:i.isShiftKeyPressed(),trapSelection:h,contextButton:!!t.contextButton}})}this.render({onlyPostProcess:!0})}else{var D;(D=WUX.Selection.HSOManager).isEmpty()||(D.empty(),this.render({onlyPostProcess:!0}))}null}else null}}},this.rightMouseUpCB=function(t,i){if(t.view===this.canvas&&i&&!i.isMiddleButtonPressed()&&!i.isLeftButtonPressed()&&i.isRightClick()){this.picking.contextPick&&(t.contextButton=!0,this.leftMouseUpCB(t,i));var r={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@rightClick",event:t};e.publish({event:"/VISU/",data:r}),this._modelEvent.publish({event:"Context",data:{viewer:this,event:t,ctrl:i.isCtrlKeyPressed()}}),this.debugEvents>=6&&console.log(r)}}}else this.centerMouseDownCB=null,this.mouseMoveCB=null,this.leftMouseDownCB=null,this.leftMouseUpCB=function(e,t){var i=e.view;if(!x.RecordEventsManager||i){var r=e.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap,n=e.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(i===r&&(i=n),i!==n&&!i.renderable){for(;i!==n&&i.parentElement&&!i.renderable;)i=i.parentElement;if(!i.renderable)return}t&&!t.isMiddleButtonPressed()&&(this.trapSelection&&(!this.trapSelection||this.trapSelection.isActive)||t.isLeftClick())&&(this.manipulatorManager&&this.manipulatorManager.isInManipulation()||this._modelEvent.publish({event:"Activate",data:{viewer:this,event:e,ctrl:t.isCtrlKeyPressed(),shift:t.isShiftKeyPressed()}}))}},this.rightMouseUpCB=null},getDefaultPicking:function(){return this._defaultPicking},setCurrentHighlightSet:function(e){this.renderer.resetGSSOCache(),this.highlightColor=e?e.sceneHL.highlightData:null},setRenderSettings:function(e){!e||void 0!==e.type&&"rasterizer"!==e.type||(e.ambientOcclusion&&e.ambientOcclusion.activation&&(this.setSSAOParameters({dynamicRadius:!1,adaptativeRadius:!0,radius:e.ambientOcclusion.radius?e.ambientOcclusion.radius:100,radiusMin:.005,radiusMax:.12,minPixelRadius:14,attenuation:.984,contrast:e.ambientOcclusion.intensity?e.ambientOcclusion.intensity:1,power:1,thresholdAngle:1.32645023152}),viewer.setSSAO(!0)),e.reflection&&e.reflection.activation&&viewer.setSSLR(!0))},setAmbience:function(e,t){this.renderer.resetGSSOCache();var i=this.internalSceneGraph&&this.internalSceneGraph.scene;this.ambience.removeLights(i,this.sceneBackground);"Custom"!==this.visuEnv&&(this.visuEnv="Custom",this._modelEvent.publish({event:"VisuEnv",data:{viewer:this,value:"Custom"}})),this.ambience.isOCA&&this.ambience.dispose(),this.ambience=e,this.ambience.resize(this.SCREEN_WIDTH,this.SCREEN_HEIGHT,this.devicePixelRatio,this.renderer),t&&(this.setGroundOptions({groundSize:100,groundShadow:!1,displayPlane:!1,displayGrid:!1,displayGridFromBelow:!1,gridNbSteps:5,gridLabels:null,gridLabelCallback:null,gridDisplayLabelCallback:null,planeMirror:!1,blurryMirror:!1,planeColor:"#EEEEEE",planeOpacity:1,planeTexture:null,planeTextureScale:1,gridColor:"#EEEEEE",gridFalloff:0,planeFalloff:0,planeBorder:!1,planeBorderColor:"#FFFFFF"}),this.setGroundOptions(e.getGroundOptions())),this.ambience.updateAmbience()},removeAmbience:function(){var e=this.internalSceneGraph&&this.internalSceneGraph.scene;this.ambience.removeLights(e,this.sceneBackground),this.removeEnvMap(),this.ambience.needUpdateIBL.delete(this),this.renderer.SkyScatteringEffect&&this.renderer.SkyScatteringEffect.setEnabled(!1),this.ambience.isOCA&&this.ambience.dispose();var t=new V({viewer:this,v2:!0});this.setAmbience(t,!0)},createHighlightSet:function(e,t,i,r){i=null==i?!Q:!!i;var n=null;if(!(!t&&r)&&(n=this._getHighlightSet(e,t,i)))return n;if((n=new D(this.internalSceneGraph)).setHighlightData(i,e),n.setMultiColorMode(!0),this.renderer._postProHighlight){var a=this.getEffect("Highlight");a.addScene(n),(a=this.getEffect("Canvas2DHighlight")).addScene(n)}else this.renderer._HighlightMobileNonEffect.addScene(n);return t||n.detachToHSO(),this.highlightSets.push(n),n},removeHighlightSet:function(e){this.renderer.resetGSSOCache();this._removeHighlightSet(e.getHighlightData(),e.linkToHSO);if(this.renderer._postProHighlight){var t=this.getEffect("Highlight");t.removeScene(e),(t=this.getEffect("Canvas2DHighlight")).removeScene(e)}else this.renderer._HighlightMobileNonEffect.removeScene(e);e.detachToHSO(),e.clearAll()},_getHighlightSet:function(e,t,i){for(var r=this.highlightSets,n=0;n<r.length;n++){var a=r[n];if(a.linkToHSO==t&&a.getHighlightData().isEqual(e)&&a.getHighlightData()._needsDepth===i)return a}return null},_removeHighlightSet:function(e,t){for(var i=this.highlightSets,r=0;r<i.length;r++){var n=i[r];if(n.linkToHSO==t&&n.getHighlightData().isEqual(e))return i.splice(r,1),!0}return!1},addToCSOHSO:function(e,t){function i(i,n,a,s){var o,l,c={removed:[],added:[]};a&&(c.removed=function(e){for(var t=e.get(),i=[],r=0;r<t.length;r++){var n=t[r],a=n.pathElement;!a&&n.options&&(a=n.options.pathElement),a&&i.push(a)}return i}(n),n.empty());var h,u,d,p,f=[],m=[],g={highlightColor:r.highlightColor};for(h=n.get(),o=0;o<i.length;o++){for(u=i[o],d=!1,l=0;l<h.length&&!d;l++)!(p=h[l]).pathElement&&p.options&&p.options.pathElement,u.isEqual(h[l].pathElement)&&(h[l].position&&(h[l].position=e.position),f.push(h[l]),d=!0);d||m.push({pathElement:u,event:t.event,position:e.position,parameters:g})}if(s)for(f.length>0&&n.remove(f),o=0;o<f.length;o++)c.removed.push(f[o].pathElement);for(m.length>0&&n.add(m),o=0;o<m.length;o++)c.added.push(m[o].pathElement);return c}var r=this,n=WUX.Selection.HSOManager,a=WUX.Selection.CSOManager,s=function(t){var i,r,n=[],a=!1;for(i=0;i<e.path.length&&!a;i++)(r=e.path[i]).getLastElement(!0)._getExcludeFromCSO()||(n.push(r),t||(a=!0));if(!n.length&&e.path.length)return null;var s,o,l,c,h={CSO:[],HSO:[]},u=[];for(i=0;i<n.length;i++){for(r=n[i],s=!1;r.getLastElement(!0).getPickParent();)r=r.getParentPath(),s=!0;if(l=!1,s){for(o=0;o<u.length;o++)u[o].isEqual(r)&&(l=!0);l||u.push(r)}l||(h.CSO.push(r),(c=r.getLastElement(!0))._getExcludeFromHL()||c._getExcludeFromHSO()||h.HSO.push(r))}return h}(t.trapSel);if(!s)return{addedToCSO:[],removedFromCSO:[]};var o=!t.multiSel,l=!t.additiveMode,c=i(s.CSO,a,o,l);return this.picking.displayHL&&i(s.HSO,n,o,l),{addedToCSO:c.added,removedFromCSO:c.removed}},getVersion:function(){return this.version},getWebGLContext:function(){return this.renderer.renderer.getContext()},getRenderer:function(){return this.renderer.renderer},getInfos:function(){return this.renderer.getInfos()},addViewpoint:function(e,t){null!==e&&(e._setWorldOrientation(this._worldOrientation),e._setNode(this.internalSceneGraph.root),this._2DMode&&e._set2DMode(!0,t),this.viewpoints.push(e)),1===this.viewpoints.length&&this.selectViewpoint(0),this.internalSceneGraph.onAddViewpoint(),this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}})},addMultiViewpoint:function(e,t,i){e._setWorldOrientation(this._worldOrientation),i&&e._setNode(this.internalSceneGraph.root),t?this._viewpointManager.addMainViewpoint(e,!!i):this._viewpointManager.addViewpoint(e,!!i)},addNodeToViewpoint:function(e,t){this._viewpointManager.addNodeToViewpoint(e,t)},removeViewpoint:function(e){e<0||e>=this.viewpoints.length||(this.viewpoints[e]==this.currentViewpoint&&(null!==this.internalSceneGraph&&this.internalSceneGraph.scene.remove(this.currentViewpoint.getCamera()),this.currentViewpoint=null),this.viewpoints.splice(e,1),this.viewpoints.length>0&&this.selectViewpoint(0))},selectViewpoint:function(e,t){!t&&(e<0||e>=this.viewpoints.length)||(null!==this.currentViewpoint&&null!==this.internalSceneGraph&&this.internalSceneGraph.scene.remove(this.currentViewpoint.getCamera()),this.currentViewpoint&&this._viewpointManager.removeViewpoint(this.currentViewpoint),this.currentViewpoint=t||this.viewpoints[e],this._viewpointManager.addMainViewpoint(this.currentViewpoint,!0),this.fetchMePreferenceSettings&&this.currentViewpoint._setApplicationDefaultController(),this.internalSceneGraph.onSelectViewpoint(),null!==this.internalSceneGraph&&this.internalSceneGraph.scene.add(this.currentViewpoint.getCamera()),this.render({updateInfinitePlane:!0}))},getViewpoints:function(){return this.viewpoints},setTrackingViewpoint:function(e){this.trackingViewpoint=e},getTrackingViewpoint:function(){return this.trackingViewpoint},updatePlatformPreferences:function(){if(this.fetchMePreferenceSettings){this.currentViewpoint._setApplicationDefaultController(!0)}},attachScene:function(e){if(null!==e){"I solemnly swear that I am up to no good."!==e.passcode&&n.DEPRECATED_SceneGraph(new Error),e.parentSceneGraph=this.internalSceneGraph;var t=this._sceneGraph;this._sceneGraph=null,t&&this.removeNode(t),this.addNode(e._private_root),this._sceneGraph=e}},addNode:function(e,t){if(e instanceof P)throw new Error("addNode with SceneGraph");this.internalSceneGraph&&this.internalSceneGraph.addUserNode(e,null!==this._sceneGraph),this.render({updateInfinitePlane:!!t})},removeNode:function(e,t){this.internalSceneGraph&&(this.internalSceneGraph.removeUserNode(e,null!==this._sceneGraph),this.render({updateInfinitePlane:!!t}))},getNodes:function(){return this.internalSceneGraph?this.internalSceneGraph.getUserNodes(null!==this._sceneGraph):null},getRootNode:function(){return this.internalSceneGraph?this.internalSceneGraph.getUserRoot(null!==this._sceneGraph):null},setClippingPlanes:function(e){this.renderer.resetGSSOCache();var t=this.getRenderer();if(null===t)return!1;if(e&&!this.clipPlanes.length)return!1;var i=t.clipPlanesEnabled;return t.clipPlanesEnabled=e,i!==e&&null!==this.internalSceneGraph&&this.render(),!0},getClippingPlanes:function(){var e=this.getRenderer();return null===e?null:e.clipPlanes},addClippingPlane:function(e,t){return this.renderer.resetGSSOCache(),this._requestClippingUpdate(),this.clipPlanes.indexOf(e)<0&&this.clipPlanes.push(e),this._addClippingPlane(e),this.setSectionCappingMaterial(e,t),!0},setSectionCappingMaterial:function(e,t){this._requestClippingUpdate(),this.renderer.setSectionCappingMaterial(e,t)},removeClippingPlane:function(e){this._requestClippingUpdate(),this.renderer.resetGSSOCache();var t=this.clipPlanes.indexOf(e);t>=0&&this.clipPlanes.splice(t,1),this._removeClippingPlane(e)},setClippingPlaneUpVector:function(e,t){this._requestClippingUpdate(),e.upVector=t.clone(),e.upVector.normalize()},setSectionCapping:function(e){return this._requestClippingUpdate(),this.renderer.resetGSSOCache(),e&&this.getRenderPriority()?(console.warn("Section capping is not compatible with render priority mode"),!1):(this.renderer.renderer.sectionCappingEnabled=!!e,this.render(),!0)},getSectionCapping:function(){return this.renderer.renderer.sectionCappingEnabled},_updateShadowMaps:function(){let e=this._getScenegraphs();this.renderer.resetGSSOCache();for(let r=0;r<e.length;r++){var t=e[r].root3js;if(null!==t&&void 0!==typeof t)for(var i=0;i<t.parent.__lights.length;i++)t.parent.__lights[i].updateShadowMap=!0}},getVisibleSpace:function(){return this.visibleSpace},swapVisibleSpace:function(){this.renderer.resetGSSOCache(),this.visibleSpace=(this.visibleSpace+1)%2,this.renderer.visibleSpace=this.visibleSpace,this.renderer.renderer.visibleSpace=this.visibleSpace;var e,i,r=new t.Color(this.showBgColor);if(this.ambience.setBackgroundAlpha(this.showBgAlpha),this.visibleSpace||r.desaturate(1).alphaBlend(ne,.5),this.ambience.setBackgroundColor(r.getHex()),this._setBackgroundColor(),this._svgMode&&this.svgRootNode)for(i="#"+ne.getHexString(),this.svgRootNode.style.backgroundColor=this.visibleSpace?"#ffffff":i,e=0;e<this.internalSceneGraph.svgRoot.children.length;e++)this.internalSceneGraph.svgRoot.children[e]._updateSVGVisibility();if(this.ambience.getBackground().hasGradient()){var n=this.ambience.getBackground().getColors(),a=[];for(e=0;e<n.length;e++)this.visibleSpace?a.push(new t.Color(this.showGradientBackground[e].getHex())):a.push(n[e].desaturate(1).alphaBlend(ne,.5));this.ambience.getBackground().setColors(a)}this._displayGrid&&(this.visibleSpace?this.gridColor.copy(this.showGridColor):this.gridColor.desaturate(1).alphaBlend(ne,.5)),this._infinitePlane&&(this.visibleSpace?this.planeColor.copy(this.showPlaneColor):this.planeColor.desaturate(1).alphaBlend(ne,.5)),this.getRobot()&&this.getRobot().isTargetGone(this.visibleSpace)&&this.getRobot().setConnectionState(!1),this._updateShadowMaps(),this.render({updateInfinitePlane:!0}),this._modelEvent.publish({event:"SwapVisibleSpace",data:{viewer:this,visibleSpace:this.visibleSpace}})},getMousePosition:function(e){if(!(e instanceof t.Vector2)&&(console.warn("DEPRECATED: WebGLViewer.getMousePosition() now only accepts THREEDS.Core.Vector2 2D position on the screen as argument."),e.changedTouches)){var i=e.changedTouches.length?e.changedTouches[0]:e,r=this.canvas.getBoundingClientRect(),n=i.pageX-r.left,a=i.pageY-r.top;e=new t.Vector2(n,a)}var s=this.devicePixelRatio;return{x:e.x/this.canvas.offsetWidth*2-1,y:-e.y/this.canvas.offsetHeight*2+1,xPix:e.x*s,yPix:e.y*s}},computeDistanceFromCamera:function(e){return this.renderer.computePositionGPU(this.internalSceneGraph,this.currentViewpoint,e).distanceTo(this.currentViewpoint.camera.position)},invalidatePickingBuffer:function(){this.renderer.pickingGPUComposerContext&&(this.renderer.pickingGPUComposerContext.needsUpdate=!0,this.renderer.meshesGPU={},this.renderer.resetGSSOCache())},setPickingPriority:function(e){this.pickingPriorityMapping=e,this.renderer.resetGSSOCache()},pick:function(e,i,r,n,a,o){null!==this._pageObjectData&&(void 0!==e.x&&void 0!==e.y||(e=this.getMousePosition(new t.Vector2(e.xPix,e.yPix))));var l,c,h,u={ray:null},d=n||this.pickingPriorityMapping,p=!1;this.infPlaneSmall&&d&&(p=this.infPlaneSmall.visible,this.infPlaneSmall.visible=!1),c={path:[],position:null,normal:null,tangent:null,uv:null,positions:[],normals:[],tangents:[],uvs:[],ray:null},this.renderer.overrideUpdate(this.internalSceneGraph,this.getCurrentSceneGraphState());var f=!1;switch(i){case"mesh":for(l=this.computeIntersection(e,!0,!1,r,u,d,a,o),h=0;h<l.length;++h)l[h].object?(l[h].path=new s,l[h].path.setFromOccurrence(l[h].object._occurrence)):l[h].path=null;break;case"meshCPU":for(l=this.computeIntersection(e,!1,!1,r,u,d,a,o),f=!0,h=0;h<l.length;++h)l[h].object?(l[h].path=new s,l[h].path.setFromOccurrence(l[h].object._occurrence)):l[h].path=null;break;case"primHybrid":for(l=this.computeIntersection(e,!0,!0,r,u,d,a,o),h=0;h<l.length;++h){var m=l[h].object?l[h].object._occurrence:null;if(l[h].primitive&&m){var g=!0===l[h].primitive?null:THREEDS.SubElement.getFromSGNode(l[h].primitive);l[h].path=new s,l[h].path.setFromOccurrence(m,g,void 0,!0)}else l[h].object&&l[h].object._instancingInfos&&l[h].object._instancingInfos.isInstanceNode3D?(l[h].path=new s,l[h].path.setFromOccurrence(m)):m&&m.node&&!1===m.node.primitivePicking?(l[h].path=new s,l[h].path.setFromOccurrence(m)):l[h].path=null}break;case"prim":case"primCPU":for(l=this.computeIntersection(e,!1,!0,r,u,d,a,o),f=!0,h=0;h<l.length;++h)if(l[h].primitive&&l[h].object._occurrence){g=!0===l[h].primitive?null:THREEDS.SubElement.getFromSGNode(l[h].primitive);l[h].path=new s,l[h].path.setFromOccurrence(l[h].object._occurrence,g,void 0,!0)}else l[h].path=null;break;case"rep":case"repCPU":for(l=this.computeIntersection(e,!1,!0,r,u,d,a,o),f=!0,h=0;h<l.length;++h)if(l[h].primitive&&l[h].object._occurrence){g=!0===l[h].primitive?null:THREEDS.SubElement.getFromSGNode(l[h].primitive.getRep());l[h].path=new s,l[h].path.setFromOccurrence(l[h].object._occurrence,g,void 0,!0)}else l[h].path=null;break;case"repHybrid":for(l=this.computeIntersection(e,!0,!0,!1,u,d,a,o),h=0;h<l.length;++h)if(l[h].primitive&&l[h].object._occurrence){g=!0===l[h].primitive?null:THREEDS.SubElement.getFromSGNode(l[h].primitive.getRep());l[h].path=new s,l[h].path.setFromOccurrence(l[h].object._occurrence,g,void 0,!0)}else l[h].object&&l[h].object._instancingInfos&&l[h].object._instancingInfos.isInstanceNode3D?(l[h].path=new s,l[h].path.setFromOccurrence(l[h].object._occurrence)):l[h].path=null}c.ray=u.ray;var v=!1;for(h=0;h<l.length;++h)if(null!==l[h].path)void 0!==l[h].instanceId&&(l[h].path.instanceId=l[h].instanceId),c.path.push(l[h].path),v||(v=!0,c.position=l[h].point,c.normal=l[h].normal,c.tangent=l[h].tangent,c.uv=l[h].uv),c.positions.push(l[h].point?l[h].point:null),c.normals.push(l[h].normal?l[h].normal:null),c.tangents.push(l[h].tangent?l[h].tangent:null),c.uvs.push(l[h].uv?l[h].uv:null);else if(!f)break;if(!v)if((this._displayGrid||this._infinitePlane)&&c.ray&&c.ray.direction.z<0){c.normal=new t.Vector3(0,0,1);var S=new t.Plane(c.normal,this.offsetPlaneSmall.z);c.position=c.ray.intersectPlane(S)}else l.length&&(c.position=l[0].point,c.normal=l[0].normal);return this.infPlaneSmall&&d&&(this.infPlaneSmall.visible=p),c},pickInVolume:function(e,i,r){if(!e||!i)return{inside:[],partial:[],outside:[]};var n=this.internalSceneGraph.scene,a=[];if(r)a=a.concat(r._getRenderableOccurrences(this,!1));else if(n instanceof t.Mesh)a=[n];else{for(var o=this._getUserPassManager()._getActiveRenderLists(),l=[],c=0;c<o.length;c++)l=l.concat(n.getWebGLObjects(o[c],0));for(c=0;c<l.length;c++)null!==l[c]&&a.push(l[c].object)}var[h,u,d]=this.getRenderMode().getMasks(),p=new t.Sphere;if(e instanceof t.Box3){var f=e.getPoints(i),m=[[0,2,1],[4,0,5],[6,4,7],[2,6,3],[5,1,7],[4,6,0]],g=[],v=new t.Vector3,S=new t.Vector3;for(c=0;c<m.length;c++){var _=m[c];v.copy(f[_[1]]).sub(f[_[0]]),S.copy(f[_[2]]).sub(f[_[0]]),v.cross(S).normalize(),g.push((new t.Plane).setFromNormalAndCoplanarPoint(v,f[_[0]]))}p=new t.Frustum(g[0],g[1],g[2],g[3],g[4],g[5])}else{if(!(e instanceof t.Sphere))return{inside:[],partial:[],outside:[]};(p=e.clone()).applyMatrix4(i)}var y=[{path:[]},{path:[]},{path:[]}],x=[],M=[],P=[],C=[x,M,P];for(c=0;c<a.length;c++){var b=a[c];ee(b.visible,b.visibilityFree,this.visibleSpace,b.layer,b._occurrence)&&!1!==b.noPickThrough&&((void 0===b.pickable||b.pickable)&&j._meshIntersectVolume(b,p,h,d,u,x,M,P,this.visibleSpace))}for(var D=0;D<C.length;D++){var w=C[D];for(c=0;c<w.length;++c)w[c].object?(w[c].path=new s,w[c].path.setFromOccurrence(w[c].object._occurrence)):w[c].path=null}for(D=0;D<C.length;D++)for(w=C[D],c=0;c<w.length;++c)null!==w[c].path&&(void 0!==w[c].instanceId&&(w[c].path.instanceId=w[c].instanceId),y[D].path.push(w[c].path));return{inside:y[0],outside:y[1],partial:y[2]}},computeIntersection:function(e,i,r,a,s,l,c,h){var u,d,p,f,m,g,v,S,_,y,x,M=this.trapSelection||c,P=[];if(d=new t.Projector,v=void 0!==i&&i,g=void 0!==r&&r,S=void 0!==a&&a,this.debugPickHybrid&&(S=!0),x=!(!this.picking.trapSelection||!M||void 0===e.pt||e.pt.xPix===e.xPix&&e.pt.yPix===e.yPix),null===this.currentViewpoint||null===this.internalSceneGraph)return P;var C=this.devicePixelRatio;if(u=new t.Vector2(e.xPix/C,e.yPix/C),p=this.currentViewpoint.create3DRayFrom2DPoint(u),void 0!==s&&void 0!==s.ray&&(s.ray=p),!x&&e.event){var D=e.event.getView(),w=D.renderable;if(!w)for(;D!==this.canvas&&(D.parentElement||D.parentNode)&&!w;)w=(D=D.parentElement||D.parentNode).renderable;if(w&&w.noPickThrough){var E,T;if(w instanceof t.CSS3DNode){var A=(new t.Matrix4).multiplyMatrices(w.matrixWorld,w.scaleCSS),I=e.event.getCurrentPosition(D);(E=new t.Vector3(I.x,I.y,0)).applyMatrix4(A);var R=A.elements;T=new t.Vector3(R[8],R[9],R[10])}else{var L=w.position.clone(),O=(this.currentViewpoint.camera.getLookAt(),(new t.Plane).setFromNormalAndCoplanarPoint(this.currentViewpoint.camera.getLookAt(),L)),N=(w.element.getBoundingClientRect(),this.getMousePosition(new t.Vector2(e.xPix,e.yPix)));N=new t.Vector3(N.x,N.y,1),d.unprojectVector(N,this.currentViewpoint.camera),E=new t.Ray(this.currentViewpoint.camera.position,N.clone().sub(this.currentViewpoint.camera.position).normalize()).intersectPlane(O),T=O.normal}return P[0]={object:w,primitive:!(!w||!w.primitive),point:E,normal:T},P}}if(x){if(S=!1,e.x===e.pt.x||e.y===e.pt.y)return P;if(g||!v){var F,V,U,B,k,G;y=new t.Vector3(e.pt.x,e.pt.y,1);var z=this.currentViewpoint.camera,H=z.position,W=z.getLookAt();if(k=(new t.Plane).setFromNormalAndCoplanarPoint(W,H.clone().add(W.clone().multiplyScalar(z.near))),G=(new t.Plane).setFromNormalAndCoplanarPoint(W.clone().multiplyScalar(-1),H.clone().add(W.clone().multiplyScalar(z.far))),this.currentViewpoint.getProjectionType()===o.PERSPECTIVE){var j=new t.Vector3(e.x,e.y,1);d.unprojectVector(j,z),j.sub(H).normalize();var X=new t.Vector3(e.pt.x,e.y,1);d.unprojectVector(X,z),X.sub(H).normalize();var q=new t.Vector3(e.pt.x,e.pt.y,1);d.unprojectVector(q,z),q.sub(H).normalize();var Z=new t.Vector3(e.x,e.pt.y,1);d.unprojectVector(Z,z),Z.sub(H).normalize();var Y=new t.Vector3;Y.copy(j),U=(new t.Plane).setFromNormalAndCoplanarPoint(j.cross(X).normalize(),H),V=(new t.Plane).setFromNormalAndCoplanarPoint(X.cross(q).normalize(),H),B=(new t.Plane).setFromNormalAndCoplanarPoint(q.cross(Z).normalize(),H),F=(new t.Plane).setFromNormalAndCoplanarPoint(Z.cross(Y).normalize(),H)}else{var K=z.up.clone(),J=new t.Vector3(1,0,0).applyQuaternion(z.quaternion),Q=new t.Vector3(e.x,e.y,1);d.unprojectVector(Q,z);var $=new t.Vector3(e.pt.x,e.pt.y,1);d.unprojectVector($,z),U=(new t.Plane).setFromNormalAndCoplanarPoint(K.clone().negate(),Q),V=(new t.Plane).setFromNormalAndCoplanarPoint(J.clone().negate(),$),B=(new t.Plane).setFromNormalAndCoplanarPoint(K,$),F=(new t.Plane).setFromNormalAndCoplanarPoint(J,Q)}_=new t.Frustum(F,V,U,B,k,G)}}var ee,[te,ie,re]=this.getRenderMode().getMasks(),ne=t.getDevicePixelRatio();if(v){if(this.currentViewpoint._updateRobotCamera(this.internalSceneGraph),this.renderer.smallTargetPicking?(P=this.renderer.computeIntersectionGPUSmallTarget(this.internalSceneGraph,this.currentViewpoint,e,S,x,l,v&&g&&!x),this.currentViewpoint.camera.fullWidth&&(this.lockRenderIteration(),this.internalSceneGraph.onViewpointChange(),this.unlockRenderIteration())):P=this.renderer.computeIntersectionGPU(this.internalSceneGraph,this.currentViewpoint,e,S,x,null,null,null,l,v&&g&&!x,!!this._pageObjectData),P.length&&g){for(var ae=[],se=0;se<P.length;++se){var oe=P[se];oe.object&&oe.object._instancingInfos&&oe.object._instancingInfos.isInstanceNode3D?ae.push(oe):!(oe.object instanceof t.Mesh)||oe.object._occurrence&&oe.object._occurrence.node&&!1===oe.object._occurrence.node.primitivePicking||(ee=this._getUserPassManager()._getActiveRenderLists(),ae=x?ae.concat(p.intersectMeshInstancesZones3D(oe.object,this.currentViewpoint.camera,new t.Vector3(e.x,e.y,1),y,_,r,te,ie,re,this.renderer.deviceWidth,this.renderer.deviceHeight,!M.forwardSelect,{renderLists:ee,inVisibleSpace:this.visibleSpace,useViewerPickingRules:!0})):ae.concat(p.intersectMeshInstances(oe,this.currentViewpoint.camera,new t.Vector3(e.x,e.y,1),te,ie,re,this.renderer.deviceWidth,this.renderer.deviceHeight,this.picking.tolerance,{debugPickHybrid:this.debugPickHybrid,renderLists:ee,inVisibleSpace:this.visibleSpace,devicePixelRatio:ne,candidatesOnly:!1,useViewerPickingRules:!0})))}ae.length&&(P=ae),p._cleanIntersectionsList(P,!x)}}else{if(ee=this._getUserPassManager()._getActiveRenderLists(),P=x?P.concat(p.intersectMeshInstancesZones3D(this.internalSceneGraph.scene,this.currentViewpoint.camera,new t.Vector3(e.x,e.y,1),y,_,r,te,ie,re,this.renderer.deviceWidth,this.renderer.deviceHeight,!M.forwardSelect,{renderLists:ee,inVisibleSpace:this.visibleSpace,useViewerPickingRules:!0})):p.intersectMeshInstances({object:this.internalSceneGraph.scene},this.currentViewpoint.camera,new t.Vector3(e.x,e.y,1),te,ie,re,this.renderer.deviceWidth,this.renderer.deviceHeight,this.picking.tolerance,{debugPickHybrid:!1,renderLists:ee,inVisibleSpace:this.visibleSpace,devicePixelRatio:ne,candidatesOnly:!1,useViewerPickingRules:!0}),l){for(var le=[],ce=0;ce<l.length;ce++)le[l[ce].id]=l[ce].priority;P.sort(function(e,t){var i=0,r=0;if(e.object.pickingPriorityID){var n=e.object.pickingPriorityID.points;!e.primitive||!e.primitive.getGroup||e.primitive.getGroup().glType>=4?n=e.object.pickingPriorityID.faces:e.primitive.getGroup().glType>=1&&(n=e.object.pickingPriorityID.edges),n&&le[n]&&(i=le[n])}if(t.object.pickingPriorityID){var a=t.object.pickingPriorityID.points;!t.primitive||!t.primitive.getGroup||t.primitive.getGroup().glType>=4?a=t.object.pickingPriorityID.faces:t.primitive.getGroup().glType>=1&&(a=t.object.pickingPriorityID.edges),a&&le[a]&&(r=le[a])}return i>r?-1:i<r?1:e.distance-t.distance})}p._cleanIntersectionsList(P,!x)}var he=this.getRootNode();if(he&&this.debugPicking&&(null===this.debugPickingNode?(this.debugPickingNode=new n,this.debugPickingNode.exludeFromBounding(!0),he.addChild(this.debugPickingNode)):0===this.debugPickingNode.parents.length&&he.addChild(this.debugPickingNode)),this.debugPicking){if(this.debugPickingNode.removeChildren(),P.length>0&&P[0].object&&P[0].point){f=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.8,transparent:!0,force:!0,forceSide:!0});var ue=b.createSphereNode({radius:1,sag:32,material:f});ue.setPickable(2),ue._setRatio(4),ue.setFrustumCulled(!1),ue.setMatrix((new t.Matrix4).setPosition(P[0].point)),ue.setSSAO(!1),ue.setMirror(!1),ue.setShadow(!1),this.debugPickingNode.addChild(ue),m=t.MaterialUtils.createMatteFaceMaterial({color:4474111,opacity:1,transparent:!1,force:!0,forceSide:!0});var de=b.createSphereNode({radius:1,sag:32,material:m});if(de.setPickable(2),de._setRatio(8),de.setFrustumCulled(!1),de.setSSAO(!1),de.setMirror(!1),de.setShadow(!1),de.setMatrix((new t.Matrix4).setPosition(this.currentViewpoint.camera.position)),this.debugPickingNode.addChild(de),P[0].normal){var pe=new t.LineBasicMaterial({color:4474111,opacity:1,force:!0,lineWidth:2}),fe=new t.Vector3(P[0].normal.x,P[0].normal.y,P[0].normal.z);fe.multiplyScalar(.2*P[0].object.boundingSphere.radius);var me=(new t.Vector3).addVectors(P[0].point,fe);(Me=b.createLineNode({points:[P[0].point,me],material:pe}))._occurrences[0].renderable,Me.setPickable(2),Me.setSSAO(!1),Me.setMirror(!1),Me.setShadow(!1),this.debugPickingNode.addChild(Me)}var ge=P[0].primitive,ve=ge&&ge.getBoundingSphere();if(ve){var Se=t.MaterialUtils.createMatteFaceMaterial({color:4521796,opacity:.2,transparent:!1,force:!0,forceSide:!0}),_e=b.createSphereNode({radius:1,sag:32,material:Se});_e.setPickable(2),_e.setFrustumCulled(!1),_e.setSSAO(!1),_e.setMirror(!1),_e.setShadow(!1);var ye=new t.Sphere(new t.Vector3(ve.center.x,ve.center.y,ve.center.z),ve.radius);ye.applyMatrix4(P[0].object.matrix);var xe=(new t.Matrix4).setPosition(ye.center);xe.scale(new t.Vector3(ye.radius,ye.radius,ye.radius)),_e.setMatrix(xe),this.debugPickingNode.addChild(_e)}var Me;pe=new t.LineBasicMaterial({color:16729156,opacity:1,force:!0,lineWidth:1});(Me=b.createLineNode({points:[p.origin,P[0].point],material:pe}))._occurrences[0].renderable,Me.setPickable(2),Me.setSSAO(!1),Me.setMirror(!1),Me.setShadow(!1),this.debugPickingNode.addChild(Me)}this.render()}for(se=0;se<P.length;se++){var Pe=P[se];if(Pe.object&&Pe.primitive){var Ce=Pe.object.getSelectionGroup(Pe.primitive);Ce&&(Pe.primitive=Ce)}}return 0===P.length&&P.push({object:null}),v&&!r||(P=this._filterClippedIntersections(P)),P},_updateSVGVisu:function(){if(this._svgMode&&this.svgRoot&&this._2DMode){var e=this.currentViewpoint.camera,t=this.SCREEN_HEIGHT/e.visualizedHeight,i="matrix("+t+" 0 0 "+t+" "+0*(1-t)+" "+0*(1-t)+") ",r="translate ("+(.5*this.SCREEN_WIDTH-e.position.x*t+0*t-0)+" "+(.5*this.SCREEN_HEIGHT+e.position.y*t-0*t-0)+") ";this.svgRoot.setAttribute("transform",r+i)}},_updateOffsetPlane:function(e,i,r,n){var a,s="zup"===this._worldOrientation._woName;if(r&&((this.ambience.getGround().isActivated()&&"physical"==this.ambience.getGround().getType()||this.ambience.isFiniteMode())&&this.ambience.getBackgroundGeometry().isAutoUpdateSize()&&this.ambience.getBackgroundGeometry().setSize(4*e.radius),this.ambience.isAutoGroundOffset()&&null!==(a=null!==this._forceSceneMinValue?this._forceSceneMinValue:null===this.internalSceneGraph?0:this.internalSceneGraph.getSceneMin(n,this._worldOrientation))&&this.ambience.updateScene(new t.Vector3(e.center.x,s?e.center.y:a,s?a:e.center.z))),this.offsetPlaneBackground.copy(this.ambience.getGroundPosition()),this.ambience.isAutoGroundOffset()&&!this.ambience.isFiniteMode()&&"physical"!=this.ambience.getGround().getType()){var o=i.getLookAt();if(this.planeV2)this.offsetPlaneBackground.x=e.center.x,s?this.offsetPlaneBackground.y=e.center.y:this.offsetPlaneBackground.z=e.center.z;else if(s){var l=Math.abs(o.z)>1e-4?1/o.z:0;this.offsetPlaneBackground.x=.5*(e.center.x+i.position.x-(i.position.z-this.offsetPlaneBackground.z)*o.x*l),this.offsetPlaneBackground.y=.5*(e.center.y+i.position.y-(i.position.z-this.offsetPlaneBackground.z)*o.y*l)}else{l=Math.abs(o.y)>1e-4?1/o.y:0;this.offsetPlaneBackground.x=.5*(e.center.x+i.position.x-(i.position.y-this.offsetPlaneBackground.y)*o.x*l),this.offsetPlaneBackground.z=.5*(e.center.z+i.position.z-(i.position.y-this.offsetPlaneBackground.y)*o.z*l)}}s?(this.offsetPlaneBackground.z+=this.ambience.getOffset(),this.offsetPlaneSmall.z=this.offsetPlaneBackground.z):(this.offsetPlaneBackground.y+=this.ambience.getOffset(),this.offsetPlaneSmall.y=this.offsetPlaneBackground.y)},_getPlaneSize:function(e,t,i,r){return this.ambience.isAutoGroundOffset()?this.planeV2?20*e.radius:Math.max(20*(this.offsetPlaneBackground.distanceTo(e.center)+e.radius),5*this.offsetPlaneBackground.distanceTo(t.position)):this.planeV2&&this.planeGrid?this.planeGrid.size:this.gridUnit/this.gridStep},_castRayFunc:function(e,t,i,r){return console.warning("Internal method: use castRay or castRayOnOccurrence instead"),e._cast(t,i,r,s)},castRay:function(e,t,i,r){var n,a=0,o=0,l=(r=r||{}).iDoNotUseDefaultRenderPasses?[]:["main","noz","noEffectNoZ","afterHighlightNoZ","dialog"];if(r.iAdditionalRenderPasses)for(o=0;o<r.iAdditionalRenderPasses.length;o++)n=r.iAdditionalRenderPasses[o],l.push(n&&n._getIdString?n._getIdString():n);var c=[];if(t)for(a=0;a<t._occurrences.length;a++)c=c.concat(t._occurrences[a]._getRenderableOccurrences());else{var h=this.internalSceneGraph.scene;for(o=0;o<l.length;o++)c=c.concat(h.getWebGLObjects(l[o],0))}return e._cast(c,i,r,s)},castRayOnOccurrence:function(e,t,i,r){var n=0,a=["main","noz","noEffectNoZ","afterHighlightNoZ"],o=[];if(t){o=t._getRenderableOccurrences(this,!1);var l=t._getUniqueOccurrence(this);null===l?console.log("castRayIntoOccurrences ERROR: the path element is either invalid or doesn't define a unique occurrence."):l.node._tryOverridesUpdate(this)}else{var c=this.internalSceneGraph.scene;for(n=0;n<a.length;n++)o=o.concat(c.getWebGLObjects(a[n],0))}return e._cast(o,i,r,s)},displayFaces:function(e){this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),this.setRenderMode("Face",e),this.setRenderMode("AxisSystem",e),this.setRenderMode("InfiniteFace",e)},setBoundaryEdgeColor:function(e){this.renderer.renderer.boundaryEdgeMaterialInfo.color.copy(e),this.render()},displayBoundaryEdgeColor:function(e){this.renderer.resetGSSOCache(),this.renderer.renderer.boundaryEdgeMaterialInfo.enabled=e,this.render()},displayBlankingPolygon:function(e){this.renderer.resetGSSOCache(),this.materialManager&&this.materialManager.displayBlankingPolygon(e,this)},displayLines:function(e){this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),this.setRenderMode("@Edge",e)},displayHiddenEdges:function(e){this.renderer.resetGSSOCache(),this.renderer.renderer.renderHiddenEdges=e,this.render()},displayHalVisibleSmoothEdges:function(e){this.renderer.resetGSSOCache(),this.renderer.renderer.halfVisibleSmoothEdges=e,this.render()},setRenderLineMode:function(e){switch(this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),e){case t.HideAllRenderLineMode:this.setRenderMode("@Edge",!1);break;case t.HideSmoothEdgesRenderLineMode:this.setRenderMode("@Edge",!0),this.setRenderMode("InternalSmoothEdge",!1);break;case t.HideWireEdgesRenderLineMode:this.setRenderMode("@Edge",!0),this.setRenderMode("WireEdge",!1);break;case t.HideInternalEdgesRenderLineMode:this.setRenderMode("@Edge",!0),this.setRenderMode("InternalSmoothEdge",!1),this.setRenderMode("InternalSharpEdge",!1);break;case t.ShowAllRenderLineMode:this.setRenderMode("@Edge",!0);break;case t.SmoothEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("InternalSmoothEdge",!0);break;case t.SharpEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("InternalSharpEdge",!0);break;case t.WireEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("WireEdge",!0);break;case t.BoundaryEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("BoundaryEdge",!0)}},addRenderModeLock:function(e,t){this.lockedRenderMode.set(e,t),this.applyRenderModeLock()},removeRenderModeLock:function(e){this.lockedRenderMode.has(e)&&this.lockedRenderMode.delete(e)},clearRenderModeLock:function(){this.lockedRenderMode.clear()},applyRenderModeLock:function(){var e=this;this.lockedRenderMode.forEach(function(t,i,r){e._setRenderMode(i,t)})},getPlanesFilter:function(){return!!this.planesFilterStatus},onPlanesFilterChange:function(e){return this._modelEvent.subscribe({event:"RefPlaneFilterMode"},e)},getVerticesFilter:function(){return!!this.verticesFilterStatus},_setVerticesFilter:function(e){e=!!e,this.addRenderModeLock("BoundaryPoint",e),this.addRenderModeLock("SharpPoint",e),this.addRenderModeLock("SmoothPoint",e)},setVerticesFilter:function(e){this.verticesFilterStatus!==e&&(this.verticesFilterStatus=e,!1!==this.linesFilterStatus&&this._setVerticesFilter(e),this.render(),this._modelEvent.publish({event:"VerticesFilterMode",data:{viewer:this,state:this.verticesFilterStatus}}))},onVerticesFilterChange:function(e){return this._modelEvent.subscribe({event:"VerticesFilterMode"},e)},getAxisFilter:function(){return!!this.axisFilterStatus},setAxisFilter:function(e){var t=this.axisFilterStatus!==e,i=this.getBagNode?this.getBagNode():this.getRootNode?this.getRootNode():null;if(i){var r=i.getChildrenByName("AxisSystems");r&&r.length>0&&r.forEach(function(t){t.setVisibility(e),t.setVisibilityFree(!e)});var n=i.getChildrenByName("RefPlanes");n&&n.length>0&&n.forEach(function(t){t.setVisibility(e),t.setVisibilityFree(!e)})}t&&(this.axisFilterStatus=e,this.planesFilterStatus=e,this.addRenderModeLock("InfiniteFace",e),this.addRenderModeLock("AxisSystem",e),this._modelEvent.publish({event:"AxisFilterMode",data:{viewer:this,state:this.axisFilterStatus}}),this._modelEvent.publish({event:"RefPlaneFilterMode",data:{viewer:this,state:this.planesFilterStatus}})),this.render()},onAxisFilterChange:function(e){return this._modelEvent.subscribe({event:"AxisFilterMode"},e)},getLinesFilter:function(){return!!this.linesFilterStatus},setLinesFilter:function(e){this.linesFilterStatus!==e&&(this.linesFilterStatus=e,this.addRenderModeLock("WireEdge",e),this._setVerticesFilter(!!e&&(null===this.verticesFilterStatus||this.verticesFilterStatus)),this.render(),this._modelEvent.publish({event:"LinesFilterMode",data:{viewer:this,state:this.linesFilterStatus}}))},onLinesFilterChange:function(e){return this._modelEvent.subscribe({event:"LinesFilterMode"},e)},getPointsFilter:function(){return!!this.pointsFilterStatus},setPointsFilter:function(e){this.pointsFilterStatus!==e&&(this.pointsFilterStatus=e,this.addRenderModeLock("FreePoint",e),this.render(),this._modelEvent.publish({event:"PointsFilterMode",data:{viewer:this,state:this.pointsFilterStatus}}))},onPointsFilterChange:function(e){return this._modelEvent.subscribe({event:"PointsFilterMode"},e)},_setRenderMode:function(e,t){this.renderer.resetGSSOCache();var i=new U;i._setFromMasks(this.renderer.renderer.renderPointMode,this._getInternalRenderLineMode(),this._getInternalRenderFaceMode()),i.setRenderMode(e,t),this.renderer.renderer.renderPointMode=i.getMask()&U.pointsMask,this._setInternalRenderFaceMode(i.getMask()&U.facesMask),this._setInternalRenderLineMode(i.getMask()&U.linesMask)},setRenderMode:function(e,t){if(this._renderStyle)return this._renderStyle.setRenderMode(e,t),void this.setRenderStyle(this._renderStyle);this._setRenderMode(e,t),this.applyRenderModeLock()},setRenderStyle:function(e){this.renderer.resetGSSOCache(),this._renderStyle=e.clone(),this.setMaterialMode(e._materialMode);var t=this._renderStyle._renderMode;this.renderer.renderer.renderPointMode=t.getMask()&U.pointsMask,this.renderer.renderer.outlineWidth=t._outlineWidth,this._setInternalRenderFaceMode(t.getMask()&U.facesMask),this._setInternalRenderLineMode(t.getMask()&U.linesMask),this.applyRenderModeLock(),this.internalSceneGraph.root.forceUpdate()},requestViewPanelClose:function(){this._modelEvent.publish({event:"RequestViewPanelClose",data:{viewer:this}})},onRequestViewPanelClose:function(e){return this._modelEvent.subscribe({event:"RequestViewPanelClose"},e)},setRenderFaceMode:function(e){this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),this._setInternalRenderFaceMode(e)},displayPoints:function(e){this.renderer.resetGSSOCache(),e?(this.setRenderMode("@Point",!0),this.setRenderMode("SurfacicPoint",!1),U.defaultMask=U.defaultMask|t.GeomTypeEnum.UNKNOWN_0D):(this.setRenderMode("@Point",!1),U.defaultMask=U.defaultMask&~t.GeomTypeEnum.UNKNOWN_0D)},displaySurfacicPoints:function(e){this.renderer.resetGSSOCache(),this.setRenderMode("SurfacicPoint",e)},_setGradientBackgroundShader:function(){var e;if(null!==this.sphereEnv){var i=this.ambience.getBackground().getColors();switch(i){case 2:e=t.GradientBackgroundMaterial2;break;case 3:e=t.GradientBackgroundMaterial3;break;case 4:e=t.GradientBackgroundMaterial4;break;default:return void this.removeEnvMap()}var r=new e({force:!0,side:t.DoubleSide,forceSide:!0,depthTest:!1});r.colors=[];for(var n=r.colors,a=0;a<i.length;a++){var s=i[a];n.push(s.r),n.push(s.g),n.push(s.b)}this.sphereEnv.material=r}},setGradientBackground:function(e){if(this.renderer.resetGSSOCache(),this.showGradientBackground=[],!e||e.length<2||e.length>4)this.removeEnvMap();else{for(var i=[],r=0;r<e.length;r++){var n=new t.Color(e[r]);this.visibleSpace||n.desaturate(1).alphaBlend(ne,.5),this.showGradientBackground.push(new t.Color(e[r])),i.push(n)}this.ambience.getBackground().setColors(i)}},_setBackgroundColor:function(){this._svgMode&&this._2DMode&&!L.getWebGLMode()?this.renderer.setBackgroundColor(0,0):this.renderer.setBackgroundColor(this.ambience.getBackgroundColor().getHex(),this.ambience.getBackgroundAlpha()),this._modelEvent.publish({event:"VisuBackgroundColor",data:this.ambience.getBackgroundColor().getHex()})},setBackgroundColor:function(e,i){if(this.__tempBackgroundColorODT=e,this.renderer.resetGSSOCache(),this.ambience.setBackgroundAlpha(void 0!==i?i:1),this.showBgColor=new t.Color(e).getHex(),this.showBgAlpha=this.ambience.getBackgroundAlpha(),this.visibleSpace)this.ambience.setBackgroundColor(e);else{var r=new t.Color(e);r.desaturate(1).alphaBlend(ne,.5),this.ambience.setBackgroundColor(r.getHex())}this._setBackgroundColor(),this.render()},setPlaneColor:function(e){this.renderer.resetGSSOCache(),this.planeColor.set(e),this.showPlaneColor.set(e),this.visibleSpace||this.planeColor.desaturate(1).alphaBlend(ne,.5),this.render()},setGridColor:function(e){this.renderer.resetGSSOCache(),this.gridColor.set(e),this.showGridColor.set(e),this.visibleSpace||this.gridColor.desaturate(1).alphaBlend(ne,.5),this.render()},setSecondaryLightColor:function(e){var i;this.renderer.resetGSSOCache(),"number"==typeof e||"string"==typeof e?i=new t.Color(e):e&&(i=e),null!==this.directionalLight2&&this.directionalLight2.color.copyToLinear(i,this.renderer.renderer.simpleGamma),this.render()},setShadow:function(e,t,i){this._viewerEffectSettings.setShadow(e,t,i)},getShadow:function(e){return this._viewerEffectSettings.getShadow(e)},setAllowShadow(e,t){this._viewerEffectSettings.setAllowShadow(e,t)},getAllowShadow:function(e){return this._viewerEffectSettings.getAllowShadow(e)},setTransparentShadow:function(e,t){this._viewerEffectSettings.setTransparentShadow(e,t)},getTransparentShadow:function(e){return this._viewerEffectSettings.getTransparentShadow(e)},setAllowTransparentShadow(e,t){this._viewerEffectSettings.setAllowTransparentShadow(e,t)},getAllowTransparentShadow:function(e){return this._viewerEffectSettings.getAllowTransparentShadow(e)},setOIT:function(e,t){this._viewerEffectSettings.setOIT(e,t)},getOIT:function(e){return this._viewerEffectSettings.getOIT(e)},setFlakesQuality:function(e,t){this._viewerEffectSettings.setFlakesQuality(e,t)},getFlakesQuality:function(e){return this._viewerEffectSettings.getFlakesQuality(e)},setDownsamplingFactor:function(e){this._viewerEffectSettings.setDownsamplingFactor(e)},getDownsamplingFactor:function(){this._viewerEffectSettings.getDownsamplingFactor()},setDefaultMaterialQuality:function(e){this._viewerEffectSettings.setDefaultMaterialQuality(e)},getDefaultMaterialQuality:function(){this._viewerEffectSettings.getDefaultMaterialQuality(iQuality)},enableZPrePass:function(e,t){this._viewerEffectSettings.enableZPrePass(e,t)},zPrePassEnabled:function(e){return this._viewerEffectSettings.zPrePassEnabled(iOnOff,e)},setShadowFilter:function(e,t){this._viewerEffectSettings.setShadowFilter(e,t)},getShadowFilter:function(e){return this._viewerEffectSettings.getShadowFilter(e)},setShadowQuality:function(e,t){this._viewerEffectSettings.setShadowQuality(e,t)},getShadowQuality:function(e){return this._viewerEffectSettings.getShadowQuality(e)},setShadowCascade:function(e,t,i){this.renderer.resetGSSOCache();var r=this.directionalLight,n=t||1024,a=!1;if(null!==r){this.getRenderer()&&(this.getRenderer().shadowMapCascade=e),this.shadowMapWidth===n&&this.shadowMapHeight===n||(a=!0,this.shadowMapWidth=n,this.shadowMapHeight=n,e||(r.shadowMap=null,r.shadowMapWidth=n,r.shadowMapHeight=n)),r.shadowCascade=e,r.shadowCascadeCount=i||3,r.shadowCascadeWidth=[],r.shadowCascadeHeight=[],r.shadowCascadeBias=[],r.shadowCascadeNearZ=[],r.shadowCascadeFarZ=[];for(var s=0;s<r.shadowCascadeCount;s++)r.shadowCascadeWidth[s]=n,r.shadowCascadeHeight[s]=n,r.shadowCascadeBias[s]=-.005;if(r.shadowCascadeOffset.set(0,0,-10),a&&r.shadowCascadeArray)for(s=0;s<r.shadowCascadeArray.length;s++){var o=r.shadowCascadeArray[s];o.shadowMap=null,o.shadowMapWidth=n,o.shadowMapHeight=n,o.shadowBias=-.005}this.renderer&&this.renderer.recompileAllShaders(null)}},removePlaneV2:function(){this.ambience.usePlaneV2&&!this._planeV2Appli&&(this.setGroundOptions({displayPlane:!1,displayGrid:!1,planeFalloff:0}),this.planeGrid&&this.planeGrid.mesh&&(this.planeGrid.mesh.visible=!1),this.planeV2=!1)},setGroundShadow:function(e,t){this._viewerEffectSettings.setGroundShadow(e,t)},getGroundShadow:function(e){return this._viewerEffectSettings.getGroundShadow(e)},setAllowGroundShadow:function(e,t){this._viewerEffectSettings.setAllowGroundShadow(e,t)},getAllowGroundShadow:function(e){return this._viewerEffectSettings.getAllowGroundShadow(e)},setGroundShadowAutomaticUpdate:function(e){this.dirLightGroundShadow.blockUpdate=!e,e&&(this.dirLightGroundShadow.updateShadowMap=!0)},setGroundShadowDirection:function(e,t){this.groundShadowLatitude=e,this.groundShadowLongitude=t,this.dirLightGroundShadow.updateShadowMap=!0},_setGroundShadow:function(){this.blurShadowEffect||(this.blurShadowEffect=new T(this.renderer.renderer,this.renderer.renderTargetPool),this.dirLightGroundShadow.blurShadowEffect=this.blurShadowEffect);var e=this.dirLightGroundShadow.groundMaterial;e&&(e.getPDSFXUniform("groundShadow").value||(e.defines.GROUND_SHADOW=1,e.needsUpdate=!0))},setGrid:function(e,t){this.renderer.resetGSSOCache(),this.displayGrid!==e&&(this.displayGrid=e,this._modelEvent.publish({event:"DisplayGrid",data:{viewer:this,value:e}})),this._updateGridDisplay(),void 0!==t&&(this.displayGridFromBelow=t,this.planeV2&&(this.planeGrid.displayGridFromBelow=t?1:0)),this.render()},getGrid:function(){return this.displayGrid},onGridChange:function(e){return this._modelEvent.subscribe({event:"DisplayGrid"},e)},_updateGridDisplay:function(){var t=!this._2DMode&&this.displayGrid;this._displayGrid!==t&&(this._displayGrid=t,this.planeV2&&(this.planeGrid.displayGrid=t?1:0),e.publish({event:"/WUX/AFR/CMD/VisuGrid/"+(t?"BEGIN":"END")}))},getGridUnit:function(){return this.planeV2&&this.planeGrid?this.planeGrid.gridUnit:this.gridUnit},onProjectionTypeChange:function(e){var t=0,i=this;return this.onPreRender(function(){i.currentViewpoint.getProjectionType()!==t&&(t=i.currentViewpoint.getProjectionType(),e({viewer:i,state:t}))})},displayInfinitePlane:function(e,t){this.renderer.resetGSSOCache(),this.infinitePlane=e,this.planeAttenuation=void 0!==t&&t,this._updateInfinitePlaneDisplay()},_updateInfinitePlaneDisplay:function(){this._infinitePlane=!this._2DMode&&this.infinitePlane,this.planeV2&&(this.planeGrid.displayPlane=this._infinitePlane?1:0),this._infinitePlane?(this.render({updateInfinitePlane:!0}),this.useShadowPlane=!0):!this.planeV2&&this._removeInfinitePlane(this.infPlane)},setShadowPlane:function(e){this.renderer.resetGSSOCache(),this.useShadowPlane=e,this._updateShadowPlaneDisplay()},_updateShadowPlaneDisplay:function(e){!this._2DMode&&this.useShadowPlane?this.render({updateInfinitePlane:!0}):!this._infinitePlane&&this._removeInfinitePlane(this.infPlaneSmall)},setAutomaticPlaneUpdate:function(e){this.ambience.setAutoGroundOffset(e)},setPlanePositionAndScale:function(e,t){this.offsetPlaneBackground.copy(e),this.offsetPlaneSmall.z=e.z,this.ambience.updateScene(e),this.gridUnit=t},setGridNbSteps:function(e){if(this.renderer.resetGSSOCache(),this.gridNbSteps=Math.min(Math.max(e,1),10),this.planeV2)this.planeGrid.setGridNbSteps(this.gridNbSteps);else{if(!this.bigGrid)return;this._createBigGridGeometry()}},setGroundOptions:function(e){this.renderer.resetGSSOCache(),void 0!==e.groundCenter&&(this.offsetPlaneBackground.copy(e.groundCenter),this.offsetPlaneSmall.z=e.groundCenter.z,this.ambience.updateScene(e.groundCenter)),void 0!==e.groundSize&&this.planeV2&&(this.planeGrid.size=e.groundSize),void 0!==e.groundShadow&&this.setGroundShadow(!!e.groundShadow),void 0!==e.displayPlane&&this.displayInfinitePlane(!!e.displayPlane,e.planeAttenuation),void 0!==e.displayGrid?this.setGrid(!!e.displayGrid,e.displayGridFromBelow):void 0!==e.displayGridFromBelow&&this.setGrid(this.displayGrid,e.displayGridFromBelow),void 0!==e.gridNbSteps&&this.setGridNbSteps(e.gridNbSteps),void 0!==e.gridLabels&&this.planeV2&&this.planeGrid&&this.planeGrid.setLabels(e.gridLabels),void 0!==e.gridLabelColor&&this.planeV2&&this.planeGrid&&this.planeGrid.setLabelColor(e.gridLabelColor),void 0!==e.gridLabelCallback&&this.planeV2&&this.planeGrid&&this.planeGrid.setLabelCallback(e.gridLabelCallback),void 0!==e.gridDisplayLabelCallback&&this.planeV2&&this.planeGrid&&this.planeGrid.setDisplayLabelCallback(e.gridDisplayLabelCallback),void 0!==e._onlyDiffuse&&this.planeV2&&this.planeGrid&&(this.planeGrid._onlyDiffuse=e._onlyDiffuse),void 0!==e.planeMirror&&this.setMirror(!!e.planeMirror,e.blurryMirror),void 0!==e.planeColor&&this.setPlaneColor(e.planeColor),this.planeV2&&this.planeGrid&&(void 0!==e.planeOpacity&&(this.planeGrid.planeOpacity=e.planeOpacity),void 0!==e.planeTexture&&(this.planeGrid.planeTexture=e.planeTexture),void 0!==e.planeTextureScale&&(this.planeGrid.planeTextureScale=e.planeTextureScale),void 0!==e.planeFalloff&&(this.planeGrid.planeFalloff=e.planeFalloff),void 0!==e.gridFalloff&&(this.planeGrid.gridFalloff=e.gridFalloff),void 0!==e.planeBorder&&(this.planeGrid.planeBorder=e.planeBorder),void 0!==e.planeBorderColor&&this.planeGrid.edgeColor.set(e.planeBorderColor)),void 0!==e.gridColor&&this.setGridColor(e.gridColor)},getGroundOptions:function(){return{groundCenter:this.offsetPlaneBackground,groundSize:this.planeGrid?this.planeGrid.size:void 0,groundShadow:this.useGroundShadow,displayPlane:this.infinitePlane,displayGrid:this.displayGrid,displayGridFromBelow:this.displayGridFromBelow,gridNbSteps:this.gridNbSteps,gridLabels:!!this.planeGrid&&this.planeGrid.displayLabels,planeMirror:this.useMirror,blurryMirror:this.blurryMirror,planeColor:this.planeColor.getHexString(),gridColor:this.gridColor.getHexString(),gridFalloff:this.planeGrid?this.planeGrid.gridFalloff:void 0,planeFalloff:this.planeGrid?this.planeGrid.planeFalloff:void 0,planeBorder:!!this.planeGrid&&this.planeGrid.planeBorder,planeBorderColor:this.planeGrid?this.planeGrid.edgeColor.getHexString():void 0}},_getGroundOptions:function(){return{groundCenter:this.offsetPlaneBackground,groundSize:this.planeGrid?this.planeGrid.size:void 0,groundShadow:this.useGroundShadow,displayPlane:this.infinitePlane,onlyDiffuse:this.planeGrid?this.planeGrid._onlyDiffuse:0,displayGrid:this.displayGrid,displayGridFromBelow:this.displayGridFromBelow,gridNbSteps:this.gridNbSteps,gridLabels:this.planeGrid?this.planeGrid.displayLabels:null,gridLabelCallback:this.planeGrid?this.planeGrid.labelCB:null,gridDisplayLabelCallback:this.planeGrid?this.planeGrid.displayLabelCB:null,planeMirror:this.useMirror,blurryMirror:this.blurryMirror,planeColor:"#"+this.planeColor.getHexString(),planeOpacity:this.planeGrid?this.planeGrid.planeOpacity:1,planeTexture:this.planeGrid?this.planeGrid.planeTexture:null,planeTextureScale:this.planeGrid?this.planeGrid.planeTextureScale:1,gridColor:"#"+this.gridColor.getHexString(),gridFalloff:this.planeGrid?this.planeGrid.gridFalloff:void 0,planeFalloff:this.planeGrid?this.planeGrid.planeFalloff:void 0,planeBorder:!!this.planeGrid&&this.planeGrid.planeBorder,planeBorderColor:this.planeGrid?"#"+this.planeGrid.edgeColor.getHexString():void 0}},setMirror:function(e,t,i,r,n){this._viewerEffectSettings.setMirror(e,t,i,r,n)},getMirror:function(e){return this._viewerEffectSettings.getMirror(e)},setAllowMirror:function(e,t){this._viewerEffectSettings.setAllowMirror(e,t)},getAllowMirror:function(e){return this._viewerEffectSettings.getAllowMirror(e)},setVignetting:function(e){this.useVignetting!==e&&(this.renderer.setEffect("Vignetting",e),this.useVignetting=e,this.render())},setHighlight:function(e){this.displayHighlight!==e&&(this.displayHighlight=e,this.setPicking({activated:e,displayHL:e}),this.renderer.setEffect("Highlight",e),this.renderer.setEffect("Canvas2DHighlight",e),this.render())},showHighlight:function(e){this._showHighlight!==e&&(this._showHighlight=e,this.render())},setRenderIteration:function(e){this.isRenderIteration=e},lockRenderIteration:function(){this._lockRenderIteration=!0},unlockRenderIteration:function(){this._lockRenderIteration=!1},setAntiAliasing:function(e,t){this._viewerEffectSettings.setAntiAliasing(e,t)},getAntiAliasing:function(e){return this._viewerEffectSettings.getAntiAliasing(e)},setPixelCulling:function(e,t){this._viewerEffectSettings.setPixelCulling(e,t)},getPixelCulling:function(e){return this._viewerEffectSettings.getPixelCulling(e)},setSSAO:function(e,t){this._viewerEffectSettings.setSSAO(e,t)},getSSAO:function(e){this._viewerEffectSettings.getSSAO(e)},setAllowSSAO:function(e,t){this._viewerEffectSettings.setAllowSSAO(e,t)},getAllowSSAO:function(e){this._viewerEffectSettings.getAllowSSAO(e)},setSSAOParameters:function(e,t){var i=this.ssaoParams;void 0!==e.dynamicRadius&&(i.dynamicRadius=e.dynamicRadius),void 0!==e.adaptativeRadius&&(i.adaptativeRadius=e.adaptativeRadius),void 0!==e.radius&&(i.radius=e.radius),void 0!==e.radiusMin&&(i.radiusMin=e.radiusMin),void 0!==e.radiusMax&&(i.radiusMax=e.radiusMax),void 0!==e.minPixelRadius&&(i.minPixelRadius=e.minPixelRadius),void 0!==e.attenuation&&(i.attenuation=e.attenuation),void 0!==e.contrast&&(i.contrast=e.contrast),void 0!==e.power&&(i.power=e.power),void 0!==e.thresholdAngle&&(i.thresholdAngle=e.thresholdAngle),8!==e.nbOfSamples&&16!==e.nbOfSamples&&32!==e.nbOfSamples||this._viewerEffectSettings.setSSAONbSamples(e.nbOfSamples,t)},setIterativeSSAO:function(e){this.useSSAOIterative=e},setDOF:function(e,t){return this._viewerEffectSettings.setDOF(e,t)},getDOF:function(e){return this._viewerEffectSettings.getDOF(e)},setAllowDOF:function(e,t){return this._viewerEffectSettings.setAllowDOF(e,t)},getAllowDOF:function(e){return this._viewerEffectSettings.getAllowDOF(e)},setIterativeDOF:function(e){this.useDOFIterative=e},setSSLR:function(e,t){this._viewerEffectSettings.setSSLR(e,t)},getSSLR:function(e){return this._viewerEffectSettings.getSSLR(e)},setAllowSSLR:function(e,t){this._viewerEffectSettings.setAllowSSLR(e,t)},getAllowSSLR:function(e){return this._viewerEffectSettings.getAllowSSLR(e)},setSSLRefraction:function(e,t){this._viewerEffectSettings.setSSLRefraction(e,t)},getSSLRefraction:function(e){return this._viewerEffectSettings.getSSLRefraction(e)},setAllowSSLRefraction:function(e,t){this._viewerEffectSettings.setAllowSSLRefraction(e,t)},getAllowSSLRefraction:function(e){return this._viewerEffectSettings.getAllowSSLRefraction(e)},setBloom:function(e,t){this._viewerEffectSettings.setBloom(e,t)},getBloom:function(e){return this._viewerEffectSettings.getBloom(e)},setAllowBloom:function(e,t){this._viewerEffectSettings.setAllowBloom(e,t)},getAllowBloom:function(e){return this._viewerEffectSettings.getBloom(e)},setAdvancedPoliteHighlight:function(e,t){var i=this.internalSceneGraph.selectionHL,r=this.internalSceneGraph.selectionPreHL;i&&i.setHighlightData(!0,e),r&&r.setHighlightData(!0,t),this.render()},setHaloHighlight:function(e,t){var i=this.internalSceneGraph.selectionHL,r=this.internalSceneGraph.selectionPreHL;i&&i.setHighlightData(!1,e),r&&r.setHighlightData(!1,t),this.render()},getHighlightData:function(){var e=this.internalSceneGraph.selectionHL,t=this.internalSceneGraph.selectionPreHL,i={highlightData:null,preHighlightData:null};return e&&(i.highlightData=e.getHighlightData()),t&&(i.preHighlightData=t.getHighlightData()),i},setPreHighlightColor:function(e,i){console.warn("Warning: Deprecated API, please use setAdvancedPoliteHighlight or setHaloHighlight instead"),this.internalSceneGraph.selectionPreHL&&(e instanceof t.Color?this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{outlineColor:e,outlineThickness:1}):i instanceof t.Color&&this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{outlineColor:i,outlineThickness:1}),i instanceof t.Color?this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{haloColor:i,haloIntensity:500,haloThickness:1}):e instanceof t.Color&&this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{haloColor:e,haloIntensity:500,haloThickness:1}))},getEffect:function(e){var t=null;switch(e){case"xRevealStructure":t=this.renderer.XRevealStructureEffect;break;case"ToneMapping":case"Vignetting":t=this.renderer.ToneMappingEffect;break;case"Bloom":t=this.renderer.BloomEffect;break;case"DOF":t=this.renderer.BokehDOFEffect;break;case"SSLR":t=this.renderer.SSLREffect;break;case"SSLRDirect":t=this.renderer.SSLRDirectEffect;break;case"VolumeRendering":t=this.renderer.VolumeRenderingEffect;break;case"SSAO":t=this.renderer.SSAOEffect;break;case"SSAOIterative":t=this.renderer.SSAOIterativeEffect;break;case"PreHighlight":t=this.renderer.PreHighlightEffect;break;case"Canvas2DPreHighlight":t=this.renderer.Canvas2DPreHighlightEffect;break;case"Highlight":t=this.renderer.HighlightEffect;break;case"Canvas2DHighlight":t=this.renderer.Canvas2DHighlightEffect}return t},setFlare:function(e){this.useFlare!==e&&(this.renderer.setEffect("Flare",e),this.useFlare=e,this.render())},setMagnifier:function(e){e.viewer||(e.viewer=this),null===this.magnifier?this.magnifier=new f(e):this.magnifier.setOption(e),this.pPicking.activated||this.setPrePicking({activated:!0,displayHL:!1,gpu:!1,computeNormalDepth:!0})},setFillXSOMode:function(e){this._fillXSOMode=e},setPicking:function(e,t){"boolean"==typeof e&&console.log("boolean is DEPRECATED in setPicking() method.\n Use object instead."),void 0!==e.activated&&(this.picking.activated=e.activated);var i=e.divTrap,r=function(){var e=this.picking.trapSelection;!1!==window.enableNewTrapSelection?e?(this.trapSelectionManipulator||(this.trapSelectionManipulator=new I(this),this.trapSelectionManipulator._linkToViewer()),this.trapSelectionManipulator.enable(),this.trapSelectionManipulator.setAdvanced("advanced"===e),void 0!==i?this.trapSelectionManipulator.setShowDivTrap(!!i):this.trapSelectionManipulator.setShowDivTrap(this.picking.showDivTrap)):this.trapSelectionManipulator&&this.trapSelectionManipulator.disable():(this.trapSelection||(this.trapSelection=new m(this)),this.trapSelection.set(e))};void 0!==e.contextPick&&(this.picking.contextPick=e.contextPick),void 0!==e.displayHL&&(this.picking.displayHL=e.displayHL),void 0!==e.gpu&&(this.picking.gpu=e.gpu),void 0!==e.trapGPU&&(this.picking.trapGPU=e.trapGPU),void 0!==e.computeNormalDepth&&(this.picking.computeNormalDepth=e.computeNormalDepth),void 0!==e.primitive&&(this.picking.primitive=e.primitive,this.picking._trapPrimitiveUsed||(this.picking.trapPrimitive=!!e.primitive)),void 0!==e.pickingTolerance&&(this.renderer.gpuPickingTolerance=e.pickingTolerance,this.picking.tolerance=e.pickingTolerance),void 0!==e.forceVisibility&&this.picking.forceVisibility!==e.forceVisibility&&(this.picking.forceVisibility=e.forceVisibility,this.internalSceneGraph.forceHighlightVisibility(e.forceVisibility)),void 0!==e.trapSelection&&(this.picking.trapSelection=e.trapSelection,r.call(this)),void 0!==e.trapSelectionMesh&&(console.warn("DEPRECATED: please use trapPrimitive to control trap selection granularity instead"),this.picking.trapSelection=e.trapSelectionMesh,this.picking._trapPrimitiveUsed=!e.trapSelectionMesh,this.picking.trapPrimitive=!this.picking.trapSelection&&this.picking.trapPrimitive,r.call(this)),void 0!==e.trapPrimitive&&(this.picking.trapPrimitive=e.trapPrimitive,this.picking._trapPrimitiveUsed=!0),void 0!==e.showDivTrap&&(this.picking.showDivTrap=e.showDivTrap,this.trapSelectionManipulator&&this.trapSelectionManipulator.setShowDivTrap(this.picking.showDivTrap)),this.renderer&&(this.renderer.setEffect("Highlight",this.picking.activated&&this.picking.displayHL),this.renderer.setEffect("Canvas2DHighlight",this.picking.activated&&this.picking.displayHL));var n=!0;void 0!==t&&(n=t),this.setDefaultPicking(n)},setPrePicking:function(e,t){void 0!==e.activated&&(this.pPicking.activated=e.activated),void 0!==e.trapSelection&&(this.pPicking.trapSelection=e.trapSelection),void 0!==e.displayHL&&(this.pPicking.displayHL=e.displayHL),void 0!==e.gpu&&(this.pPicking.gpu=e.gpu),void 0!==e.computeNormalDepth&&(this.pPicking.computeNormalDepth=e.computeNormalDepth),void 0!==e.primitive&&(this.pPicking.primitive=e.primitive),void 0!==e.disableWhileMoving&&(this.pPicking.disableWhileMoving=e.disableWhileMoving),void 0!==e.forceVisibility&&this.pPicking.forceVisibility!==e.forceVisibility&&(this.pPicking.forceVisibility=e.forceVisibility,this.internalSceneGraph.forcePreHighlightVisibility(e.forceVisibility)),this.renderer&&(this.renderer.setEffect("PreHighlight",this.pPicking.activated&&this.pPicking.displayHL),this.renderer.setEffect("Canvas2DPreHighlight",this.pPicking.activated&&this.pPicking.displayHL));var i=!0;void 0!==t&&(i=t),this.setDefaultPicking(i)},setPickingGPU:function(e){this.picking.gpu!==e&&(this.picking.gpu=e)},setSmallRenderTargetPicking:function(e){this.renderer.smallTargetPicking!==e&&(this.renderer.smallTargetPicking=e)},setIntensityCorrection:function(e){},activateNoMeshInRAM:function(e){console.warn("DEPRECATED: noMeshInRAM should be activated on the modelLoader")},setManipulators:function(e){if(!this.manipulatorManager)return!1;void 0!==e.activated&&this.manipulatorManager.setActivate(e.activated),void 0!==e.preActivate&&this.manipulatorManager.setPreActivate(e.preActivate)},getManipulators:function(){return!!this.manipulatorManager&&this.manipulatorManager.getActivate()},setOverrideCursors:function(e){this.overrideCursors=e},getCursor:function(){return this.canvas.style.cursor},setCursor:function(e,t,r){if(this.overrideCursors){var n=this,a="auto";if(-1!==["auto","-webkit-grabbing","pointer"].indexOf(e))a=e;else if("Auto"!==e)if(r)a=e;else{var s=i.getWebappsAssetUrl("Visualization","")+"icons/";a="url('"+s+"WebViewer"+e+".png'), url('"+s+"WebViewer"+e+".cur'), auto"}this._changeCursorDelay&&(clearTimeout(this._changeCursorDelay),this._changeCursorDelay=null);var o=function(e){n.canvas.style.cursor=e};t>0?this._changeCursorDelay=setTimeout(function(){o(a)},t):o(a)}},setTemporaryCursor:function(e){var t=this._temporaryCursorData;t||(t={oldCursor:this.getCursor()||null},this._temporaryCursorData=t,this.setCursor(e))},unsetTemporaryCursor:function(){var e=this._temporaryCursorData;if(e){var t=e.oldCursor||"auto";this.setCursor(t,0,!0),this._temporaryCursorData=null}},setForceMultiSelection:function(e){this.forceMultiSel=e},setForcePickingFaces:function(e){this._pickingMode._setPickingMode(U.facesMask,e?1:2),this._setPickingMode()},setForcePickingLines:function(e){this._pickingMode._setPickingMode(U.linesPickingMask,e?1:2),this._setPickingMode()},setForcePickingPoints:function(e){this._pickingMode._setPickingMode(U.pointsMask,e?1:2),this._setPickingMode()},setFacePickingMode:function(e){this._pickingMode._setPickingMode(U.facesMask,e),this._setPickingMode()},setLinePickingMode:function(e){this._pickingMode._setPickingMode(U.linesPickingMask,e),this._setPickingMode()},setPointPickingMode:function(e){this._pickingMode._setPickingMode(U.pointsMask,e),this._setPickingMode()},setPickingMode:function(e,t){this._pickingMode.setPickingMode(e,t),this._setPickingMode()},_setPickingMode:function(){this.renderer.renderer.pickingModeLSB=this._pickingMode.pickingModeLSB,this.renderer.renderer.pickingModeMSB=this._pickingMode.pickingModeMSB,this.invalidatePickingBuffer(),this.renderer.resetGSSOCache()},getPickingMode:function(){return this._pickingMode.clone()},setFromPickingNode:function(e){this._pickingMode=e.clone(),this._setPickingMode()},getRenderMode:function(){return this.renderer.renderer.getRenderMode().clone()},setDebugPostProcessing:function(e){this.debugPostProcessing!==e&&(this.renderer.setEffect("DebugPass",e),this.debugPostProcessing=e,this.render())},showPerfo:function(e,t,i,r,n){if(e&&!this._glFPSCounter){var a=this;require(["DS/VisuTools/FPSCounter"],function(e){n&&e.setAutoRefresh(!1),a._glFPSCounter=e,a._glFPSCounter.setActivated(a,!0,i),window.webVisuPerfo.setEnabled(!!t),r&&r()})}else this._glFPSCounter&&(this._glFPSCounter.setActivated(this,e,i),window.webVisuPerfo.setEnabled(!!t))},showInfos:function(e,t){if(e&&!this._glInfoCounter){var i=this;require(["DS/VisuTools/InfoCounter"],function(e){i._glInfoCounter=new e(i,t)})}else this._glInfoCounter&&this._glInfoCounter.activate(e)},showNodeCounter:function(e,t){if(e&&!this._glNodeCounter){var i=this;require(["DS/VisuTools/NodeCounter"],function(e){i._glNodeCounter=new e(i,t)})}else this._glNodeCounter&&this._glNodeCounter.activate(e)},setDebugFPS:function(e,t){this.debugFPS=e,this.debugFPSInfos.fpsLastTime=performance.now(),this.debugFPSInfos.fpsWindow=t||40,this.debugFPSInfos.fpsIndex=0,this.debugFPSInfos.fpsCumul=30*this.debugFPSInfos.fpsWindow,this.debugFPSInfos.fpsValue=30,this.debugFPSInfos.fpsArray=[];for(var i=0;i<this.debugFPSInfos.fpsWindow;i++)this.debugFPSInfos.fpsArray[i]=30;e?this.debugFPSInfos.fpsCounter?this.debugFPSInfos.fpsCounter.show():(this.debugFPSInfos.fpsCounter=new UWA.Element("div",{html:"FPS",styles:{fontFamily:"arial, sans-serif",fontSize:"20px",position:"absolute",top:"20px",right:"10px",textAlign:"left",verticalAlign:"middle",backgroundColor:"#333",color:"white"}}),this.div.appendChild(this.debugFPSInfos.fpsCounter)):this.debugFPSInfos.fpsCounter&&this.debugFPSInfos.fpsCounter.hide()},setDebugShadowMaps:function(e){this.debugShadowMaps!==e&&(this.renderer.setEffect("DebugShadowMaps",e),this.debugShadowMaps=e,this.render())},setDebugEvents:function(e){this.debugEvents=e,x.setDebugEvents(e)},getDisplayFaces:function(){return!!(this.renderer.renderer.renderFaceMode&t.GeomTypeEnum.FACE)},getDisplayLines:function(){return this.renderer.renderer.renderLineMode!==t.HideAllRenderLineMode},getDisplayPoints:function(){return this.renderer.renderer.renderPointMode>0},getInfinitePlane:function(){return this.infinitePlane},getMirror:function(){return this.useMirror},_setPlaneGridOrientation:function(e){e?this.planeGridOrientation.copy(e):this.planeGridOrientation.makeBasis(this._worldOrientation.frontVector,this._worldOrientation.rightVector,this._worldOrientation.upVector)},createInfinitePlane:function(e,i,r,n){if(!J){var a,s=null===this.internalSceneGraph?this.temporaryEmptyScene:this.internalSceneGraph.scene,o=new t.Vector3,l=new t.Vector3,c=(new t.Matrix4).copy(this.planeGridOrientation);if(o.copy(this._worldOrientation.frontVector),o.multiplyScalar(n.dot(this._worldOrientation.frontVector)-.5*r),l.copy(this._worldOrientation.rightVector),l.multiplyScalar(n.dot(this._worldOrientation.rightVector)-.5*r),o.add(l),l.copy(this._worldOrientation.upVector),l.multiplyScalar(n.dot(this._worldOrientation.upVector)),o.add(l),c.setPosition(o),c.scale(new t.Vector3(r,r,r)),null===e){if(1===i)(a=new t.PlaneMaterial)._firstDirOnly=this.triLights,a.ambient.copy(new t.Color(328965)),a.color.copy(this.planeColor),(u=new t.Color).copyToLinear(this.ambience.getBackgroundColor(),this.renderer.renderer.simpleGamma),a.updatePDSFXUniform("border",u),a.updatePDSFXUniform("borderAlpha",this.ambience.getBackgroundAlpha()),a.updatePDSFXUniform("attenuation",this.planeAttenuation?1:0),(h=b.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:a}))._setIsAlwaysInForeground(!0),this.infPlane=h._occurrences[0].renderable,(e=this.infPlane).receiveShadow=!1,e.renderDepth=1,this.sceneBackground.add(e);else if(0===i){var h;a=new t.SmallPlaneMaterial(void 0),this.dirLightGroundShadow.groundMaterial=a,(h=b.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:a}))._setIsAlwaysInForeground(!0),this.infPlaneSmall=h._occurrences[0].renderable,(e=this.infPlaneSmall).__invisiblePlane=!0,e.receiveShadow=!0,e.castShadow=!1,e.renderDepth=-Number.MAX_VALUE,s.add(e)}e.pickable=!1,e.frustumCulled=!1,e.visibilityFree=!0,e.setMatrix(c)}else{var u;e.visible=!0,e.visibilityFree=!0,1===i&&e.material&&(e.material.color.copy(this.planeColor),(u=new t.Color).copyToLinear(this.ambience.getBackgroundColor(),this.renderer.renderer.simpleGamma),e.material.updatePDSFXUniform("border",u),e.material.updatePDSFXUniform("borderAlpha",this.ambience.getBackgroundAlpha()),e.material.updatePDSFXUniform("attenuation",this.planeAttenuation?1:0)),e.setMatrix(c)}}},_removeInfinitePlane:function(e){null!==e&&e.visible&&(e.visible=!1,this.render())},createGrid:function(e,r,n,a,s){if(!J){a=Math.pow(Math.max(0,a),.4);var o,l,h,u,d=this.mobile;o=function(t){var i=Math.tan(.125*Math.PI);return i*=t/e,Math.ceil(100*i)}(n),l=this.ambience.isAutoGroundOffset()?function(e){for(var t=.25*e,i=2e-4,r=0;i<t;){switch(r%3){case 0:i*=2;break;case 1:i*=2.5;break;case 2:i*=2}r++}return i}(e*o):e,null!==this.grid&&(this.grid.visibilityFree=!0,this.grid.material.color=this.gridColor),null!==this.bigGrid&&(this.bigGrid.visibilityFree=!0,this.bigGrid.material.color=this.gridColor);var p=new t.Vector3,f=new t.Vector3,m=(new t.Matrix4).copy(this.planeGridOrientation);m.scale(new t.Vector3(l,l,l)),this.gridSize=l,this.gridUnit=l*this.gridStep;var g,v=new t.Vector3(0,0,r.dot(this._worldOrientation.upVector));if(v.x=this.gridNbSteps*this.gridUnit*Math.floor(r.dot(this._worldOrientation.frontVector)/(this.gridNbSteps*this.gridUnit)),v.y=this.gridNbSteps*this.gridUnit*Math.floor(r.dot(this._worldOrientation.rightVector)/(this.gridNbSteps*this.gridUnit)),d?(p.copy(this._worldOrientation.frontVector),p.multiplyScalar(v.x-.5*l),f.copy(this._worldOrientation.rightVector),f.multiplyScalar(v.y-.5*l),p.add(f),f.copy(this._worldOrientation.upVector),f.multiplyScalar(v.z),p.add(f)):(p.copy(this._worldOrientation.frontVector),p.multiplyScalar(v.x),f.copy(this._worldOrientation.rightVector),f.multiplyScalar(v.y),p.add(f),f.copy(this._worldOrientation.upVector),f.multiplyScalar(v.z),p.add(f)),m.setPosition(p),null!==this.grid)return this.grid.visibilityFree=!0,this.grid.setMatrix(m),this.grid.material.updatePDSFXUniform("gridSize",e),this.grid.material.updatePDSFXUniform("attenuation",this.grid.map?.9*a:.6*a),this.grid.visible=!0,null!==this.bigGrid&&(this.bigGrid.visibilityFree=!0,this.bigGrid.setMatrix(m),this.bigGrid.material.updatePDSFXUniform("gridSize",e),this.bigGrid.material.updatePDSFXUniform("attenuation",a),this.bigGrid.visible=!0),!0;if(h=new t.GridMaterial,d){var S=i.getWebappsAssetUrl("Visualization","");(g=new t.ImageUtils.loadTexture(S+"grid512.png",void 0,null,null,t.ImageUtils.crossOriginPolicy)).wrapS=t.RepeatWrapping,g.wrapT=t.RepeatWrapping,g.anisotropy=8,g.repeat=new t.Vector2(.2/this.gridStep,.2/this.gridStep),h.setGridTexture(g)}if(h.updatePDSFXUniform("gridSize",e),h.updatePDSFXUniform("attenuation",d?.9*a:.6*a),d){var _=b.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:h});this.grid=_._occurrences[0].renderable,this.grid.frustumCulled=!1}else{var y=new c.PrimitiveGroup,x=2/this.gridStep,M=6*x,P=8*x,C=new c.Buffer({component:c.VertexComponentEnum.POSITION,data:new Float32Array(3*M)}),D=new Uint16Array(P),w=new c.Buffer({indexBuffer:!0,data:D});y.addBuffer(0,C),y.addBuffer(1,w);var E=0,T=0,A=C.data,I=w.data;for(u=0;u<x;u++)A[E++]=u*this.gridStep-1,A[E++]=-1,A[E++]=0,A[E++]=u*this.gridStep-1,A[E++]=0,A[E++]=0,A[E++]=u*this.gridStep-1,A[E++]=1,A[E++]=0,A[E++]=-1,A[E++]=u*this.gridStep-1,A[E++]=0,A[E++]=0,A[E++]=u*this.gridStep-1,A[E++]=0,A[E++]=1,A[E++]=u*this.gridStep-1,A[E++]=0;for(u=0;u<4*x;u++)I[T++]=3*u,I[T++]=3*u+1,I[T++]=3*u+1,I[T++]=3*u+2;var R=new c.Primitive({nbIndices:P,connectivity:c.ConnectivityTypeEnum.LINES,fillGAS:new c.FillAttributes(new c.Color(.2,.2,.2,1))}),L=new c.VertexComponent({nbVertices:M,bufferId:0,indices:new c.IndexArray({bufferId:1,offset:0})});R.addVertexComponent(L),y.addPrimitive(R);var O=b.createMeshNode(y,h);O._setIsAlwaysInForeground(!0),this.grid=O._occurrences[0].renderable,this.grid.frustumCulled=!1}return this.grid.pickable=!1,this.grid.receiveShadow=!0,this.grid.renderDepth=0,this.grid.visibilityFree=!0,this.sceneBackground.add(this.grid),d||(this._createBigGridGeometry(),this.bigGrid.setMatrix(m),this.bigGrid.material.updatePDSFXUniform("gridSize",e),this.bigGrid.material.updatePDSFXUniform("attenuation",a),this.bigGrid.material.color=this.gridColor),this.grid.setMatrix(m),this.grid.material.color=this.gridColor,!0}},_createBigGridGeometry:function(){this.bigGrid&&this.sceneBackground.remove(this.bigGrid);var e=new t.GridMaterial,i=this.gridNbSteps*this.gridStep,r=.02*this.gridStep,n=new c.PrimitiveGroup,a=2/this.gridStep,s=12*a,o=24*a,l=new c.Buffer({component:c.VertexComponentEnum.POSITION,data:new Float32Array(3*s)}),h=new c.Buffer({component:c.VertexComponentEnum.NORMAL,data:new Float32Array(3)}),u=new c.Buffer({indexBuffer:!0,data:new Uint16Array(o)}),d=new c.Buffer({indexBuffer:!0,data:new Uint16Array(o)});n.addBuffer(0,l),n.addBuffer(1,h),n.addBuffer(2,u),n.addBuffer(3,d);var p=0,f=0,m=0,g=l.data,v=u.data,S=h.data,_=d.data;S[0]=0,S[1]=0,S[2]=1;for(var y=0;y<a;y++)g[p++]=y*i-1-r,g[p++]=-1,g[p++]=0,g[p++]=y*i-1-r,g[p++]=0,g[p++]=0,g[p++]=y*i-1-r,g[p++]=1,g[p++]=0,g[p++]=y*i-1+r,g[p++]=1,g[p++]=0,g[p++]=y*i-1+r,g[p++]=0,g[p++]=0,g[p++]=y*i-1+r,g[p++]=-1,g[p++]=0,g[p++]=-1,g[p++]=y*i-1-r,g[p++]=0,g[p++]=0,g[p++]=y*i-1-r,g[p++]=0,g[p++]=1,g[p++]=y*i-1-r,g[p++]=0,g[p++]=1,g[p++]=y*i-1+r,g[p++]=0,g[p++]=0,g[p++]=y*i-1+r,g[p++]=0,g[p++]=-1,g[p++]=y*i-1+r,g[p++]=0;for(y=0;y<24*a;y++)_[m++]=0;var x=0;for(y=0;y<a;y++)v[f++]=x,v[f++]=x+4,v[f++]=x+1,v[f++]=x,v[f++]=x+5,v[f++]=x+4,v[f++]=x+1,v[f++]=x+3,v[f++]=x+2,v[f++]=x+1,v[f++]=x+4,v[f++]=x+3,x+=6,v[f++]=x,v[f++]=x+1,v[f++]=x+4,v[f++]=x,v[f++]=x+4,v[f++]=x+5,v[f++]=x+1,v[f++]=x+2,v[f++]=x+3,v[f++]=x+1,v[f++]=x+3,v[f++]=x+4,x+=6;var M=new c.Primitive({nbIndices:o,connectivity:c.ConnectivityTypeEnum.TRIANGLES,fillGAS:new c.FillAttributes(new c.Color(.2,.2,.2,1))}),P=new c.VertexComponent({nbVertices:s,bufferId:0,indices:new c.IndexArray({bufferId:2,offset:0})}),C=new c.VertexComponent({nbVertices:1,bufferId:1,indices:new c.IndexArray({bufferId:3,offset:0})});M.addVertexComponent(P),M.addVertexComponent(C),n.addPrimitive(M);var D=b.createMeshNode(n,e);D._setIsAlwaysInForeground(!0),this.bigGrid=D._occurrences[0].renderable,this.bigGrid.frustumCulled=!1,this.bigGrid.visibilityFree=!0,this.bigGrid.pickable=!1,this.bigGrid.receiveShadow=!0,this.bigGrid.renderDepth=0,this.sceneBackground.add(this.bigGrid)},_removeGrid:function(){var e=!1;return null!==this.grid&&(this.grid.visible=!1,e=!0),null!==this.bigGrid&&(this.bigGrid.visible=!1,e=!0),e},setAmbientLight:function(e){"number"==typeof e||"string"==typeof e?this.ambientLight.color=new t.Color(e):e&&(this.ambientLight.color=e)},_updateDirectionalLightWorldOrientation:function(e){var i=this.directionalLight,r=null===this.internalSceneGraph?100:this.internalSceneGraph.getBoundingSphere().radius,n=null===this.internalSceneGraph?new t.Vector3(0,0,0):this.internalSceneGraph.getBoundingSphere().center,a=Math.sin(Math.PI*this.dirLightLatitude)*Math.cos(2*Math.PI*this.dirLightLongitude),s=Math.sin(Math.PI*this.dirLightLatitude)*Math.sin(2*Math.PI*this.dirLightLongitude),o=Math.cos(Math.PI*this.dirLightLatitude);this.dirLightVector=(new t.Vector3).copy(e.frontVector).multiplyScalar(a).add((new t.Vector3).copy(e.rightVector).multiplyScalar(s)).add((new t.Vector3).copy(e.upVector).multiplyScalar(o)),this.useDefaultLights&&(i.position=(new t.Vector3).copy(this.dirLightVector).multiplyScalar(2*r).add(n),i.lookAt(n),i.target.position=n,i.target.updateMatrixWorld(),i.updateShadowMap=!0)},setDirectionalLight:function(e,i,r,n){this.renderer.resetGSSOCache(),this.autoUpdateLights=!1,this.dirLightLatitude=e,this.dirLightLongitude=i;var a=this.directionalLight;this._updateDirectionalLightWorldOrientation(this._worldOrientation),this.useDefaultLights&&("number"==typeof r||"string"==typeof r?a.color=new t.Color(r):r&&(a.color=r),a.intensity=n,a.updateShadowMap=!0),this.renderer.resetClippingScene(),this.render()},setLightParameters:function(e){var i=[this.directionalLight,this.directionalLight2,this.directionalLight3],r=[this.dirLightVector,this.dirLight2Vector,this.dirLight3Vector],n=e.lightIndex?e.lightIndex:0,a=i[n],s=r[n];return!!a&&(this.autoUpdateLights=!1,0==e.isPhysical?a._phongReduction=!1:a._phongReduction=!0,e.color&&(a.color=new t.Color(e.color)),void 0!==e.intensity&&(a.intensity=e.intensity),e.direction&&(s.copy(e.direction),0===n&&(a.updateShadowMap=!0)),e.directionType&&(this.dirLightType[n]="camera"===e.directionType,0===n&&(a.updateShadowMap=!0)),this.renderer.resetClippingScene(),this.render(),!0)},setAutoUpdateLights:function(e){this.renderer.resetGSSOCache(),this.autoUpdateLights=e},setLightOnViewpoint:function(e){this.renderer.resetGSSOCache(),this.dirLightType[0]=e},setToneMapping:function(e){var t=this.renderer.ToneMappingEffect;if(t){var i=!0;void 0!==e.gamma&&(t.setGamma(e.gamma),i=!1),void 0!==e.enable&&(e.enable?t.setToneMapping(i?1:2):t.setToneMapping(0))}},setAutoExposure:function(e,t){var i=this.getEffect("ToneMapping");i&&(t||(t={}),i.setAutoExposure(e,t.weightTexture,t.clampMin,t.clampMax))},setV6Ambience:function(){var e=window.__karma__&&!this.ODTMode?"V6":"None";this.setVisuEnv(e)},_removeBackgroundLight:function(){this.renderer.resetGSSOCache()},_cleanAmbience:function(){this.renderer.resetGSSOCache(),this.ambience._removePhysicalGround(),this.removePlaneV2(),this.setGradientBackground(),this.removeAmbience(),this.renderer.setEffect("ToneMapping",!0);var e=this.renderer.ToneMappingEffect;e&&(this.setBloom(!1),e.setBrightness(0),e.setToneMapping(2)),this.renderer.renderer.resetInlinedPostProcess(),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setGroundShadow(!1),this.setShadowPlane(!0),this.setSSLR(!1),this.setSSLRefraction(!1),this.setAmbientLight(3158064),this.useDefaultLights&&(this.setTriLights(!1),this.directionalLight.intensity=0,this.directionalLight2.intensity=0,this.directionalLight.castShadow=!1,this.directionalLight2.castShadow=!1)},setVisuEnvOCA:function(e,r,n){var a=null,s=new V({viewer:this,v2:!0});s.keepIBLTexture=!1,s.keepBackgroundTexture=!1,s.isOCA=!0;var o=i.getWebappsAssetUrl("Visualization",""),l=i.getWebappsAssetUrl("Ambiances",""),c=this,h=0,u=function(){if(--h<=0){c._cleanAmbience();var i=c.renderer.ToneMappingEffect,n=c.renderer.renderer.inlinedPostProcess;if(c.setAmbience(s),a){if(void 0!==a.backgroundColor&&c.setBackgroundColor(a.backgroundColor),a.grid&&(c.setGrid(!0),c.setGridColor(a.gridColor)),a.shadowPlane&&c.setShadowPlane(!0),a.ssao){c.setSSAO(!0);var o=c.ssaoParams;o.minPixelRadius=a.ssao.minPixelRadius,o.dynamicRadius=a.ssao.dynamicRadius,o.adaptativeRadius=a.ssao.adaptativeRadius,o.attenuation=a.ssao.attenuation,o.contrast=a.ssao.contrast,o.power=a.ssao.power,o.radius=a.ssao.radius,o.radiusMin=a.ssao.radiusMin,o.radiusMax=a.ssao.radiusMax,o.thresholdAngle=a.ssao.thresholdAngle}a.ambientLight&&c.setAmbientLight(a.ambientLight),i?(a.toneMapping&&i.setToneMapping(a.toneMapping.type,a.toneMapping.params),a.brightness&&i.setBrightness(a.brightness),a.bloom&&(c.setBloom(!0),c.getEffect("Bloom")._setBloom(a.bloom))):a.inlinedPostProcess&&(n.activated=a.inlinedPostProcess.activated,n.brightness=a.inlinedPostProcess.brightness,n.tonemapping=a.inlinedPostProcess.tonemapping,n.crushblacks=a.inlinedPostProcess.crushblacks,n.burnhighlights=a.inlinedPostProcess.burnhighlights),a.planeV2&&(c.planeV2=!0,c.planeGrid||(c.planeGrid=new A(c)),c.setGroundOptions({displayPlane:!0,planeColor:a.planeV2.planeColor,planeFalloff:a.planeV2.planeFalloff,_onlyDiffuse:a.planeV2._onlyDiffuse})),a.shadow&&(c.setShadow(!0),c.setTransparentShadow(!0)),a.sslr&&c._useQM&&(c.setSSLR(!0),c.setSSLRefraction(!0))}if(c.ambience.updateAmbience(),c.render({updateInfinitePlane:!0}),c.ambience.getBackground().hasGradient()){c.showGradientBackground=[];for(var l=c.ambience.getBackground().getColors(),u=[],d=0;d<l.length;d++)c.showGradientBackground.push(new t.Color(l[d])),c.visibleSpace||u.push(l[d].desaturate(1).alphaBlend(ne,.5));u.length&&c.ambience.getBackground().setColors(u)}var p=e+"OCA";p!==c.visuEnv&&(c.visuEnv=p,c._modelEvent.publish({event:"VisuEnv",data:{viewer:c,value:p}})),r&&r({ambiance:c.ambience})}},d=function(e,i,r,n){var a=2*(e/r-.5)*Math.PI,s=-((n-i)/n-1)*Math.PI;return new t.Vector3(Math.cos(a)*Math.sin(s),Math.sin(a)*Math.sin(s),Math.cos(s))};switch(e){case"Basic":this._cleanAmbience(),this.setVisuEnv("No"),this.useDefaultLights&&(this.directionalLight.castShadow=!1,this.directionalLight2.castShadow=!1);var p=e+"OCA";return void(p!==this.visuEnv&&(this.visuEnv=p,this._modelEvent.publish({event:"VisuEnv",data:{viewer:this,value:p}})));case"WhiteDesign":a={backgroundColor:15132390,grid:!0,gridColor:8355711,shadowPlane:!1},s.getBackground().setFromJson({colors:[[.980392217636108,.980392217636108,.980392217636108,1],[.921568691730499,.921568691730499,.921568691730499,1],[.901960849761963,.901960849761963,.901960849761963,1],[.901960849761963,.901960849761963,.901960849761963,1]],horizonHeight:0,intensity:1,type:"gradientWithHorizon"}),s.generateIBLFromColor([81,81,81,128]);var f=new t.DirectionalLight(16777215,.628318548202515);s.setLights(f,!1,new t.Vector3(0,0,1));var m=new t.DirectionalLight(16777215,1.884955644607544);s.setLights(m,!0,new t.Vector3(-.5,.5,.707107));var g=new t.DirectionalLight(16777215,.942477822303772);s.setLights(g,!0,new t.Vector3(.683012,.183015,.707107));var v=new t.DirectionalLight(16777215,.942477822303772);s.setLights(v,!0,new t.Vector3(-.5,.5,-.707107));break;case"BlueDesign":a={backgroundColor:3958400,grid:!0,gridColor:16777215,shadowPlane:!1},s.getBackground().setFromJson({colors:[[.39607846736908,.549019634723663,.643137276172638,1],[.243137270212173,.415686309337616,.521568655967712,1],[.235294133424759,.400000035762787,.501960813999176,1],[.235294133424759,.400000035762787,.501960813999176,1]],horizonHeight:0,intensity:1,type:"gradientWithHorizon"});f=new t.DirectionalLight(16777215,.628318548202515);s.setLights(f,!1,new t.Vector3(0,0,1));m=new t.DirectionalLight(16777215,1.884955644607544);s.setLights(m,!0,new t.Vector3(-.5,.5,.707107));g=new t.DirectionalLight(16777215,.942477822303772);s.setLights(g,!0,new t.Vector3(.683012,.183015,.707107));v=new t.DirectionalLight(16777215,.942477822303772);s.setLights(v,!0,new t.Vector3(-.5,.5,-.707107)),s.generateIBLFromColor([81,81,81,128]);break;case"DarkDesign":a={backgroundColor:2960685,grid:!0,gridColor:8355711,shadowPlane:!1},s.getBackground().setFromJson({colors:[[.274509817361832,.274509817361832,.274509817361832,1],[.196078449487686,.196078449487686,.196078449487686,1],[.176470592617989,.176470592617989,.176470592617989,1],[.176470592617989,.176470592617989,.176470592617989,1]],horizonHeight:0,intensity:1,type:"gradientWithHorizon"});f=new t.DirectionalLight(16777215,.628318548202515);s.setLights(f,!1,new t.Vector3(0,0,1));m=new t.DirectionalLight(16777215,1.884955644607544);s.setLights(m,!0,new t.Vector3(-.5,.5,.707107));g=new t.DirectionalLight(16777215,.942477822303772);s.setLights(g,!0,new t.Vector3(.683012,.183015,.707107));v=new t.DirectionalLight(16777215,.942477822303772);s.setLights(v,!0,new t.Vector3(-.5,.5,-.707107)),s.generateIBLFromColor([81,81,81,128]);break;case"Studio":a={backgroundColor:15527149,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:1.22,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.22},sslr:!0};var S=new t.DirectionalLight(16777215,1.572345066070557);s.setLights(S,!1,new t.Vector3(0,0,1));m=new t.DirectionalLight(15774860,1.884955644607544);s.setLights(m,!0,new t.Vector3(-.883779,-.413691,.218621));g=new t.DirectionalLight(4214874,2.04);s.setLights(g,!0,new t.Vector3(.865806,-.442989,-.232682));v=new t.DirectionalLight(7895160,.9424);s.setLights(v,!0,new t.Vector3(0,0,1)),h=2,s.getBackground().setFromJson({colors:[[.921568691730499,.921568691730499,.9294117,1],[1,1,1,1]],intensity:1,type:"gradient"}),(w=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1});var _={url:l+"OCA/ambianceStudio.png",pngHdr:!0,doneCallback:u};s.setIblMap(_);var y={url:l+"OCA/ambianceStudio_rmips.png",pngHdr:!0,doneCallback:u,hasDiffuse:!0};s.setRoughnessMap(y),(E=s.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.792156934738159,type:"transparent"});break;case"PureWhite":a={backgroundColor:15527149,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:2.125,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.22},sslr:!0};m=new t.DirectionalLight(7895160,.6911);s.setLights(m,!0,new t.Vector3(0,0,1));var x=s._getEnvironmentLightMatrix();f=new t.DirectionalPhongLight(16777215,1);s.setLights(f,!1,d(171,416,2048,1024).applyMatrix4(x));S=new t.DirectionalPhongLight(16777215,1);s.setLights(S,!1,d(852,416,2048,1024).applyMatrix4(x));var M=new t.DirectionalPhongLight(16777215,1);s.setLights(M,!1,d(1536,416,2048,1024).applyMatrix4(x));var P=new t.DirectionalPhongLight(16777215,1);s.setLights(P,!1,d(1024,0,2048,1024).applyMatrix4(x)),s.getBackground().setFromJson({colors:[[.9254,.9254,.9294,1],[1,1,1,1]],intensity:1,type:"gradient"}),(w=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1}),h=2;_={url:l+"OCA/pureWhite.png",pngHdr:!0,doneCallback:u};s.setIblMap(_);y={url:l+"OCA/pureWhite_rmips.png",pngHdr:!0,doneCallback:u,hasDiffuse:!0};s.setRoughnessMap(y),(E=s.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.69803923368454,type:"transparent"});break;case"NeoPureWhite":case"WhiteExperience":a={backgroundColor:14607334,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:2.125,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.22},ambientLight:10066329,sslr:!0,planeV2:{planeColor:"#FFFFFF",planeFalloff:.25,_onlyDiffuse:1}};x=s._getEnvironmentLightMatrix(),f=new t.DirectionalPhongLight(8956671,1);s.setLights(f,!1,d(1957,651,2048,1024).applyMatrix4(x));S=new t.DirectionalPhongLight(16755336,1);s.setLights(S,!1,d(1151,511,2048,1024).applyMatrix4(x));M=new t.DirectionalPhongLight(16777215,1);s.setLights(M,!1,d(0,215,2048,1024).applyMatrix4(x));P=new t.DirectionalPhongLight(16777215,1);s.setLights(P,!1,d(1024,215,2048,1024).applyMatrix4(x)),s.getBackground().setIntensity(1),(w=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1]}),w.setSpecularIntensity(1),w.setDiffuseIntensity(1),h=3;var C={url:l+"OCA/neoPureWhiteBackground.png",mapping:new t.LatLongEnvMapping,doneCallback:u};s.setBackGroundMap(C);_={url:l+"OCA/neoPureWhite.png",pngHdr:!0,doneCallback:u};s.setIblMap(_);y={url:l+"OCA/neoPureWhite_rmips.png",pngHdr:!0,doneCallback:u,hasDiffuse:!0};s.setRoughnessMap(y),n&&n.from3dx?s.getBackgroundGeometry().setAutoUpdateSize(!1):s.getBackgroundGeometry().setAutoUpdateSize(!0),(E=s.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.569,type:"transparent"}),s.usePlaneV2=!0;break;case"WhiteMirror":a={backgroundColor:16777215,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.932,contrast:3.088,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.31},sslr:!0},s.getBackground().setFromJson({colors:[[1,1,1,1],[1,1,1,1]],intensity:1,type:"gradient"}),(w=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1});x=s._getEnvironmentLightMatrix(),f=new t.DirectionalPhongLight(16777215,1);s.setLights(f,!1,d(171,416,2048,1024).applyMatrix4(x));S=new t.DirectionalPhongLight(16777215,1.5);s.setLights(S,!1,d(852,416,2048,1024).applyMatrix4(x));M=new t.DirectionalPhongLight(16777215,1);s.setLights(M,!1,d(1536,416,2048,1024).applyMatrix4(x));P=new t.DirectionalPhongLight(16777215,1.5);s.setLights(P,!1,d(1024,0,2048,1024).applyMatrix4(x)),h=2;_={url:l+"OCA/whiteMirror.png",pngHdr:!0,doneCallback:u};s.setIblMap(_);y={url:l+"OCA/whiteMirror_rmips.png",pngHdr:!0,doneCallback:u,hasDiffuse:!0};s.setRoughnessMap(y),(E=s.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.69803923368454,type:"transparent"});break;case"WhiteReview":a={backgroundColor:14474460,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:1.032,contrast:2.5,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.31},sslr:!0},s.getBackground().setFromJson({colors:[[.8627,.8627,.8627,1],[1,1,1,1]],intensity:1,type:"gradient"}),(w=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1});x=s._getEnvironmentLightMatrix(),f=new t.DirectionalPhongLight(16777215,1.1);s.setLights(f,!1,d(171,416,2048,1024).applyMatrix4(x));S=new t.DirectionalPhongLight(16777215,1.25);s.setLights(S,!1,d(852,416,2048,1024).applyMatrix4(x));M=new t.DirectionalPhongLight(16777215,1.1);s.setLights(M,!1,d(1536,416,2048,1024).applyMatrix4(x));P=new t.DirectionalPhongLight(16777215,1.25);s.setLights(P,!1,d(1024,0,2048,1024).applyMatrix4(x)),h=2;_={url:o+"OCA/whiteReview.png",pngHdr:!0,doneCallback:u};s.setIblMap(_);y={url:o+"OCA/whiteReview_rmips.png",pngHdr:!0,doneCallback:u,hasDiffuse:!0};s.setRoughnessMap(y),(E=s.getGround()).setFromJson({glossiness:0,height:0,reflectivity:0,shadowIntensity:.423529446125031,type:"transparent"});break;case"DarkMirror":a={backgroundColor:1118481,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},toneMapping:{type:6,params:{crushblacks:.75,burnhighlights:.12,saturation:1}},brightness:1,bloom:{nbIterations:6,bloomFactor:.22,threshold:0},inlinedPostProcess:{activated:!0,brightness:1,tonemapping:6,crushblacks:.75,burnhighlights:.12},shadow:!0,sslr:!0},(f=new t.DirectionalLight(16777215,1.633628129959106)).castShadow=!0,f.shadowMapWidth=this.shadowMapWidth,f.shadowMapHeight=this.shadowMapHeight,f._sceneShadow=!0,s.setLights(f,!1,new t.Vector3(-.588439,0,.808542)),(S=new t.DirectionalLight(16777215,1.633628129959106)).castShadow=!0,S.shadowMapWidth=this.shadowMapWidth,S.shadowMapHeight=this.shadowMapHeight,S._sceneShadow=!0,s.setLights(S,!1,new t.Vector3(.588439,0,.808542)),s.getBackground().setIntensity(1),h=3;C={url:o+"OCA/darkMirror.png",pngHdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:u};s.setBackGroundMap(C),(w=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:.600000023841858});_={url:o+"OCA/darkMirror.png",pngHdr:!0,doneCallback:u};s.setIblMap(_);y={url:o+"OCA/darkMirror_rmips.png",pngHdr:!0,doneCallback:u,hasDiffuse:!0};s.setRoughnessMap(y),(E=s.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.5,shadowIntensity:0,type:"transparent"});break;case"DarkReview":h=2,a={backgroundColor:3289650,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:1.032,contrast:2.5,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.31},sslr:!0},s.getBackground().setFromJson({colors:[[.196,.196,.196,1],[.3529,.3529,.3529,1]],intensity:1,type:"gradient"}),(w=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1});x=s._getEnvironmentLightMatrix(),f=new t.DirectionalPhongLight(16777215,1);s.setLights(f,!1,d(171,416,2048,1024).applyMatrix4(x));S=new t.DirectionalPhongLight(16777215,1);s.setLights(S,!1,d(852,416,2048,1024).applyMatrix4(x));M=new t.DirectionalPhongLight(16777215,1);s.setLights(M,!1,d(1536,416,2048,1024).applyMatrix4(x));P=new t.DirectionalPhongLight(16777215,1);s.setLights(P,!1,d(1024,0,2048,1024).applyMatrix4(x));_={url:o+"OCA/darkReview.png",pngHdr:!0,doneCallback:u};s.setIblMap(_);y={url:o+"OCA/darkReview_rmips.png",pngHdr:!0,doneCallback:u,hasDiffuse:!0};s.setRoughnessMap(y),(E=s.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:.447058856487274,type:"transparent"});break;case"Outdoor":a={backgroundColor:15463679,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:1,contrast:1.8,power:1,radius:.06,radiusMin:.001,radiusMax:.1,thresholdAngle:1.31},toneMapping:{type:6,params:{crushblacks:1,burnhighlights:.01,saturation:1}},bloom:{nbIterations:5,bloomFactor:.22,threshold:0},inlinedPostProcess:{activated:!0,brightness:1,tonemapping:6,crushblacks:1,burnhighlights:.01},shadow:!0,sslr:!0};f=new t.DirectionalLight(16704193,18.8);var b=new t.DirectionalLight(16704193,18.8);s.setLights(f,!1,new t.Vector3(-.182353,.741268,.645963),b),f.castShadow=!0,f.shadowMapWidth=this.shadowMapWidth,f.shadowMapHeight=this.shadowMapHeight,f._sceneShadow=!0,b.castShadow=!1,s.getBackground().setIntensity(1),h=3;C={url:l+"OCA/outdoor.png",pngHdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:u};s.setBackGroundMap(C),(w=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1]}),w.setSpecularIntensity(.6),w.setDiffuseIntensity(.5);_={url:l+"OCA/outdoor.png",pngHdr:!0,doneCallback:u};s.setIblMap(_);y={url:l+"OCA/outdoor_rmips.png",pngHdr:!0,doneCallback:u,hasDiffuse:!0};s.setRoughnessMap(y),(E=s.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:0,type:"physical",planeColor:new t.Color(16768178)});var D=s.getBackgroundGeometry();n&&n.from3dx?D.setAutoUpdateSize(!1):D.setAutoUpdateSize(!0),E.setGroundOutDoor();break;case"Indoor":a={backgroundColor:13421772,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},brightness:1,toneMapping:{type:6,params:{crushblacks:.5,burnhighlights:.01,saturation:1}},bloom:{nbIterations:4,bloomFactor:.1,threshold:0},inlinedPostProcess:{activated:!0,brightness:1,tonemapping:6,crushblacks:.5,burnhighlights:.01},shadow:!0,sslr:!0};f=new t.DirectionalLight(16777215,2.513274192810059);s.setLights(f,!1,new t.Vector3(0,.961181,.27592));S=new t.DirectionalLight(16777215,1.256637096405029);s.setLights(S,!1,new t.Vector3(0,.516689,.856173)),S.castShadow=!0,S.shadowMapWidth=this.shadowMapWidth,S.shadowMapHeight=this.shadowMapHeight,S._sceneShadow=!0;M=new t.DirectionalLight(16777215,1.256637096405029);s.setLights(M,!1,new t.Vector3(0,-.506721,.86211)),s.getBackground().setIntensity(1),h=3;C={url:l+"OCA/indoor.png",pngHdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:u};s.setBackGroundMap(C),(w=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:.600000023841858});D=s.getBackgroundGeometry();n&&!n.from3dx&&D.setAutoUpdateSize(!0),n&&n.from3dx?D.setAutoUpdateSize(!1):D.setAutoUpdateSize(!0),D.setFromJson({shootPosition:[0,0,0]});_={url:l+"OCA/indoor.png",pngHdr:!0,doneCallback:u};s.setIblMap(_);y={url:l+"OCA/indoor_rmips.png",pngHdr:!0,doneCallback:u,hasDiffuse:!0};s.setRoughnessMap(y),(E=s.getGround()).setFromJson({glossiness:0,height:0,reflectivity:.400000005960464,shadowIntensity:0,type:"transparent"}),s.setAutoGroundOffset(!0),s.setGroundHeight(new t.Vector3(0,0,.2)),s.setSceneHeight(new t.Vector3(0,0,.2)),this.render({updateInfinitePlane:!0});break;case"City":a={backgroundColor:13421772,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},brightness:1.7,toneMapping:{type:6,params:{crushblacks:.24,burnhighlights:.08,saturation:1}},bloom:{nbIterations:6,bloomFactor:.1,threshold:0},inlinedPostProcess:{activated:!0,brightness:1.7,tonemapping:6,crushblacks:.24,burnhighlights:.08},shadow:!0,sslr:!0};f=new t.DirectionalLight(16777215,1.25);s.setLights(f,!1,new t.Vector3(.727313,-.001712,.686304)),f.castShadow=!0,f.shadowMapWidth=this.shadowMapWidth,f.shadowMapHeight=this.shadowMapHeight,f._sceneShadow=!0,s.getBackground().setIntensity(1),h=3;C={url:l+"OCA/city.png",pngHdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:u};s.setBackGroundMap(C),(w=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1]}),w.setSpecularIntensity(1),w.setDiffuseIntensity(.6);D=s.getBackgroundGeometry();n&&n.from3dx?D.setAutoUpdateSize(!1):D.setAutoUpdateSize(!0),D.setFromJson({shootPosition:[0,0,.5]});_={url:l+"OCA/city.png",pngHdr:!0,doneCallback:u};s.setIblMap(_);y={url:l+"OCA/city_rmips.png",pngHdr:!0,doneCallback:u,hasDiffuse:!0};s.setRoughnessMap(y),(E=s.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:0,type:"transparent"}),s.setAutoGroundOffset(!0),s.setGroundHeight(new t.Vector3(0,0,.2)),s.setSceneHeight(new t.Vector3(0,0,.2));break;case"Road":a={backgroundColor:13421772,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},brightness:.8,toneMapping:{type:6,params:{crushblacks:.2,burnhighlights:.17,saturation:1}},bloom:{nbIterations:4,bloomFactor:.058,threshold:0},inlinedPostProcess:{activated:!0,brightness:.8,tonemapping:6,crushblacks:.2,burnhighlights:.17},shadow:!0,sslr:!0};f=new t.DirectionalLight(16777215,2.51);s.setLights(f,!1,new t.Vector3(.46785,-.847623,.250302)),f.castShadow=!0,f.shadowMapWidth=this.shadowMapWidth,f.shadowMapHeight=this.shadowMapHeight,f._sceneShadow=!0,s.getBackground().setIntensity(1),h=3;var w;C={url:l+"OCA/road.png",pngHdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:u};s.setBackGroundMap(C),(w=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:.8});D=s.getBackgroundGeometry();n&&n.from3dx?D.setAutoUpdateSize(!1):D.setAutoUpdateSize(!0),D.setFromJson({shootPosition:[0,0,0]});_={url:l+"OCA/road.png",pngHdr:!0,doneCallback:u};s.setIblMap(_);var E;y={url:l+"OCA/road_rmips.png",pngHdr:!0,doneCallback:u,hasDiffuse:!0};s.setRoughnessMap(y),(E=s.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:1,type:"transparent"}),s.setAutoGroundOffset(!0),s.setGroundHeight(new t.Vector3(0,0,.17)),s.setSceneHeight(new t.Vector3(0,0,.43)),this.render({updateInfinitePlane:!0});break;default:return a={backgroundColor:0},s.updateAmbience(),void u()}return 0==h&&(u(),!0)},setVisuEnv:function(e){this.renderer.resetGSSOCache(),this.ambience._removePhysicalGround(),this.setGradientBackground();var r=this.internalSceneGraph&&this.internalSceneGraph.scene;r&&this.ambience.removeLights(r,this.sceneBackground),this._useDefaultAmbiancesIBL&&this.ambience.dispose(),this.removePlaneV2(),this.renderer.setEffect("ToneMapping",!0);var n=this.renderer.ToneMappingEffect;n&&(this.setBloom(!1),n.setBrightness(0),n.setToneMapping(this.renderer.tonemapping)),this.renderer.renderer.resetInlinedPostProcess();var a="SMAA",s=!0,o=null;this._configAmbiences&&this._configAmbiences.effects&&(o=this._configAmbiences.effects);var l=i.getWebappsAssetUrl("Visualization","");switch(this.setGroundShadow(!1),e){case"None":case"No":if(this.ODTMode&&o&&!o.force){this.setGrid(!1),this.displayInfinitePlane(!1),this.setShadowPlane(!1),this.setBackgroundColor(14414586),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),s=!1;break}var c=!1,h=!1,u=!1,d=!1,p=!1,f=new t.Color,m=new t.Color,g=new t.Color;if(o){var v=o.BackgroundColor;"false"===o.AntiAliasing&&(a="NoAA"),c="false"!==o.Plane,h="false"!==o.Grid,u="false"!==o.Mirror,d="false"!==o.Shadow,p="false"!==o.SSAO,v&&(f.r=void 0!==v.red?v.red:1,f.g=void 0!==v.green?v.green:1,f.b=void 0!==v.blue?v.blue:1)}this.setGrid(h),this.displayInfinitePlane(c),this.setShadowPlane(c);var S=Math.min(Math.max(0,.2126*f.r+.7152*f.g+.0722*f.b),1)>=.5?0:1;m.r=.4*S+.6*f.r,m.g=.4*S+.6*f.g,m.b=.4*S+.6*f.b,g.r=.05*S+.95*f.r,g.g=.05*S+.95*f.g,g.b=.05*S+.95*f.b,this.setBackgroundColor(f.getHex()),this.setPlaneColor(g.getHex()),this.setGridColor(m.getHex()),this.setSSAO(p);var _=this.ssaoParams;p&&(_.dynamicRadius=!0,_.adaptativeRadius=!0,_.radius=.04,_.radiusMin=.01,_.radiusMax=.12,_.minPixelRadius=14,_.attenuation=1,_.contrast=2,_.power=1,_.thresholdAngle=1.35),this.setShadow(d),this.setTransparentShadow(d),this.setMirror(u,!0),this._useDefaultAmbiancesIBL&&this.ambience.generateIBLFromColor([81,81,81,128]),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15});break;case"V6":if(this.setGrid(!0),this.displayInfinitePlane(!0,!1),this.setBackgroundColor(15527148),this.setPlaneColor(16514043),this.setGridColor(13421772),this.setSSAO(!0),(_=this.ssaoParams).dynamicRadius=!0,_.adaptativeRadius=!0,_.radius=.04,_.radiusMin=.01,_.radiusMax=.12,_.minPixelRadius=14,_.attenuation=1,_.contrast=2.5,_.power=1,_.thresholdAngle=1.35,this.setShadow(!0),this.setTransparentShadow(!0),this.setMirror(!0,!0),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){var y={url:l+"OCA/whiteReview.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[0,153,153,153,127]};this.ambience.setIblMap(y);var x={url:l+"OCA/whiteReview_rmips.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[1,153,153,153,127],hasDiffuse:!0};this.ambience.setRoughnessMap(x)}break;case"CleanSpace":if(this.setGrid(!1),this.displayInfinitePlane(!0,!1),this.setBackgroundColor(15527148),this.setPlaneColor(16514043),this.setSSAO(!0),(_=this.ssaoParams).dynamicRadius=!0,_.adaptativeRadius=!0,_.radius=.04,_.radiusMin=.01,_.radiusMax=.12,_.minPixelRadius=14,_.attenuation=1,_.contrast=2.5,_.power=1,_.thresholdAngle=1.35,this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){y={url:l+"OCA/whiteReview.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[0,153,153,153,127]};this.ambience.setIblMap(y);x={url:l+"OCA/whiteReview_rmips.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[1,153,153,153,127],hasDiffuse:!0};this.ambience.setRoughnessMap(x)}break;case"DarkBlue":this.setGrid(!0),this.displayInfinitePlane(!1),this.setBackgroundColor(3958400),this.setGradientBackground([6728399,3958400,1848912]),this.setGridColor(8362924),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),this._useDefaultAmbiancesIBL&&this.ambience.generateIBLFromColor([81,81,81,128]),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15});break;case"DarkGrey":if(this.setGrid(!0),this.displayInfinitePlane(!0,!1),this.setBackgroundColor(3881787),this.setPlaneColor(2960685),this.setGridColor(7303023),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){y={url:l+"OCA/darkReview.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[0,153,153,153,125]};this.ambience.setIblMap(y);x={url:l+"OCA/darkReview_rmips.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[1,153,153,153,125],hasDiffuse:!0};this.ambience.setRoughnessMap(x)}break;case"Shiny":if(this.setGrid(!1),this.displayInfinitePlane(!0,!0),this.setBackgroundColor(1118481),this.setGradientBackground([6710886,2105376,0]),this.setPlaneColor(6710886),this.setSSAO(!0),(_=this.ssaoParams).dynamicRadius=!0,_.adaptativeRadius=!0,_.radius=.04,_.radiusMin=.01,_.radiusMax=.12,_.minPixelRadius=14,_.attenuation=1,_.contrast=2.8,_.power=1,_.thresholdAngle=1.35,this.setShadow(!0),this.setTransparentShadow(!0),this.setMirror(!0,!0),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){y={url:l+"OCA/darkMirror.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[0,153,153,153,125]};this.ambience.setIblMap(y);x={url:l+"OCA/darkMirror_rmips.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[1,153,153,153,125],hasDiffuse:!0};this.ambience.setRoughnessMap(x)}break;case"Studio":if(this.setGrid(!1),this.displayInfinitePlane(!1),this.setBackgroundColor(15527148),this.setGradientBackground([7497556,15131615,9668981]),this.setPlaneColor(16119027),this.setSSAO(!0),(_=this.ssaoParams).dynamicRadius=!0,_.adaptativeRadius=!0,_.radius=.04,_.radiusMin=.01,_.radiusMax=.12,_.minPixelRadius=14,_.attenuation=1,_.contrast=2.5,_.power=1,_.thresholdAngle=1.35,this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!0,!0),this._useDefaultAmbiancesIBL){y={url:l+"OCA/darkMirror.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[0,153,153,153,126]};this.ambience.setIblMap(y);x={url:l+"OCA/darkMirror_rmips.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[1,153,153,153,126],hasDiffuse:!0};this.ambience.setRoughnessMap(x)}this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15});break;default:return}var M=e;M!==this.visuEnv&&(this.visuEnv=M,this._modelEvent.publish({event:"VisuEnv",data:{viewer:this,value:M}})),this.ODTMode&&this.setAntiAliasing(a),this.setTriLights(s),this.triLights?this.dirLightLatitude=.34:(this.setSecondaryLightColor(15527148),this.setDirectionalLight(.34,.16,16777215,.95*Math.PI))},getVisuEnv:function(){return this.visuEnv},onVisuEnvChange:function(e){return this._modelEvent.subscribe({event:"VisuEnv"},e)},setTriLights:function(e){if(e!==this.triLights){this.triLights=e;var i=this.directionalLight,r=this.directionalLight2,n=this.directionalLight3;e?(i&&(i.intensity=.49*Math.PI,i.shadowDarkness=.3),r&&(r.intensity=.49*Math.PI,r.color=new t.Color(16777215)),n||(this.directionalLight3=new t.DirectionalLight(16777215,.49*Math.PI),this.directionalLight3._phongReduction=!0,n=this.directionalLight3),n.position.set(40,-40,40),n.target=new t.Object3D,this.internalSceneGraph&&this.internalSceneGraph.scene.add(n)):(i&&(i.intensity=.81*Math.PI,i.shadowDarkness=.65),r&&(r.intensity=1*Math.PI,r.color=new t.Color(3827071)),n&&this.internalSceneGraph&&this.internalSceneGraph.scene.remove(n)),this.infPlane&&this.infPlane.material&&(this.infPlane.material._firstDirOnly=e,this.infPlane.material.needsUpdate=!0)}},setLightProbe:function(e){console.warn("Light probes are deprecated and won't work on PBR materials, please use an ambiance instead, phongs are deprecated"),console.warn("setLightProbe API disabled")},showEnvMap:function(e){this.renderer.resetGSSOCache();var t=this.ambience.getBackground();t.isActivated()!==e&&(e?(t.withImage()||t.hasGradient())&&t.setActivated(e):t.setActivated(e))},setEnvMap:function(e,i,r){if(this.renderer.resetGSSOCache(),2===i){console.warn("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation.");var n=this,a=0,s=2===e.length?e[0]:null,o=2===e.length?e[1]:null;s||(s=t.ImageUtils.loadHDRTexture(e+".hdr",new t.LatLongReflectionMapping)),s.minFilter=t.NearestFilter,s.magFilter=t.NearestFilter,s.wrapS=t.RepeatWrapping,s.wrapT=t.RepeatWrapping,o||(o=t.ImageUtils.loadHDRTexture(e+"_rmips.hdr",new t.LatLongReflectionMapping)),o.minFilter=t.NearestFilter,o.magFilter=t.NearestFilter,o.wrapS=t.RepeatWrapping,o.wrapT=t.RepeatWrapping;var l=function(){2===++a&&(n.internalSceneGraph.scene.envMipMap[0]=s,n.internalSceneGraph.scene.envMipMap[1]=o,n.renderer.renderer.ambianceGenerators._decreaseSceneUseCount(n.internalSceneGraph.scene),n.render(),r&&r())};return s&&s.onLoadCallbacks.push(l),o&&o.onLoadCallbacks.push(l),s}null!==e?e.length||e instanceof t.Texture?(console.warn("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation."),2===e.length?(this.ambience.setBackGroundMap({texture:e[0]}),this.ambience.setRoughnessMap({texture:e[1]})):this.ambience.setBackGroundMap({texture:e})):this._setEnvMap(e):console.warn("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation.")},_setSphereEnv:function(e){e&&(this.sphereEnv=e,this.sceneBackground.add(e))},_setPhysicalGround:function(e){e&&(this.ground=e,this.sceneBackground.add(e))},_setEnvMap:function(e){var i=void 0,n=0,a=0,s=function(){++a===n&&e.doneCallback&&e.doneCallback()};e.roughnessMap instanceof t.Texture?(n++,this.ambience.setRoughnessMap({texture:e.roughnessMap,doneCallback:s}),i=!0):null===e.roughnessMap&&(i=null);if(e.IBLMap){if(e.IBLMap instanceof t.Texture)n++,this.ambience.setIblMap({texture:e.IBLMap,doneCallback:s});else if(""!==e.IBLMap){var o="dds"===r.getExtension(e.IBLMap);n++,o?this.ambience.setReflectionMap({url:e.IBLMap,doneCallback:s}):this.ambience.setIblMap({url:e.IBLMap+".hdr",mapping:new t.LatLongReflectionMapping,hdr:!0,doneCallback:s}),i||o||(n++,this.ambience.setRoughnessMap({url:e.IBLMap+"_rmips.hdr",doneCallback:s}))}}else null===e.IBLMap&&(null,i=null);if(e.envMap)if(e.envMap instanceof t.Texture)n++,this.ambience.setBackGroundMap({texture:e.envMap,doneCallback:s});else if(""!==e.envMap){(o="dds"===r.getExtension(e.envMap))?(n++,this.ambience.setBackGroundMap({url:e.envMap,hdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:s})):(n++,this.ambience.setBackGroundMap({url:e.envMap+".hdr",hdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:s}))}},setEnvMapBlur:function(e){this.envMapBlur=e,this.ambience.setEnvMapBlur(e)},setEnvMapOffset:function(e){},setEnvMapExposure:function(e){this.envMapExposure=e,this.ambience.setExposure(e),this.sphereEnv&&this.sphereEnv.material&&(this.sphereEnv.material.envMapExposure=e),this.internalSceneGraph.scene.envMipMap[0]&&(this.internalSceneGraph.scene.envMipMap[0].envMapExposureSpecular=e,this.internalSceneGraph.scene.envMipMap[0].envMapExposureDiffuse=e)},addReflectionProbe:function(e,i,r,n,a){var s=this,o=t.ImageUtils.loadHDRTexture(e+".hdr",new t.LatLongReflectionMapping,a);o.onLoadCallbacks.push(function(){s.render()}),o.minFilter=t.NearestFilter,o.magFilter=t.NearestFilter,o.wrapS=t.RepeatWrapping,o.wrapT=t.RepeatWrapping;var l=t.ImageUtils.loadHDRTexture(e+"_rmips.hdr",new t.LatLongReflectionMapping);l.onLoadCallbacks.push(function(){s.render()}),l.minFilter=t.NearestFilter,l.magFilter=t.NearestFilter,l.wrapS=t.RepeatWrapping,l.wrapT=t.RepeatWrapping;var c={map0:o,map1:l,position:i,geomProxy:new t.Box3(r,n)};this.internalSceneGraph.scene.reflectionProbes.push(c)},removeReflectionProbes:function(){this.internalSceneGraph.scene.reflectionProbes=[]},setEnvMapAmbient:function(e){this.sphereEnv&&this.sphereEnv.material&&this.sphereEnv.material.ambient.copyToLinear(e,this.renderer.renderer.simpleGamma)},removeEnvMap:function(){var e=!1;return this.ambience.getBackground().isActivated()&&(e=!0,this.ambience.getBackground().setActivated(!1)),null!==this.sphereEnv&&(this.sphereEnv.visible=!1),e},updateBackgroundLights:function(){for(var e=(null===this.internalSceneGraph?this.temporaryEmptyScene:this.internalSceneGraph.scene).__lights,t=[],i=-1,r=[],n=0;n<this.lights.length;n++){i=-1;for(var a=0;a<e.length;a++)if(this.lights[n].fgLight===e[a]){i=n;break}-1===i&&(this.sceneBackground.remove(this.lights[n].bgLight),r.push(n))}for(n=r.length;n>0;n--)this.lights.splice(r[n],1);for(n=0;n<e.length;n++){var s=e[n];if(i=-1,!s.isVirtual){for(a=0;a<this.lights.length;a++)if(this.lights[a].fgLight===s){i=a;break}if(-1===i){var o=s.clone();o.castShadow=!1,this.sceneBackground.add(o),t.push({fgLight:s,bgLight:o})}else{var l=this.lights[i].bgLight;s.clone(l),l.castShadow=!1}}}for(n=0;n<t.length;n++){var c=t[n];this.lights.push(c)}},getSceneBoundingSphere:function(e,i,r){"show"===e&&(console.warn("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace");let n=r||this.internalSceneGraph;return n?(n.root._tryOverridesUpdate(this),n.getBoundingSphere(e,i)):i?null:new t.Sphere},getSceneBoundingBox:function(e,i){"show"===e&&(console.warn("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace");let r=i||this.internalSceneGraph;if(!r)return new t.Box3;var n=r.root;return n._tryOverridesUpdate(this),n._occurrences[0].getBoundingBox(e)},computeSceneAccurateBoundingBox:function(e,i,r,n,a){let s=a||this.internalSceneGraph;if(!s)return new t.Box3;var o=s.root;o._tryOverridesUpdate(this),r=r||t.FixedSizeFiltering.Include,n=n||[];for(var l=0,c=0;c<n.length;c++){l|=n[c]}return o._occurrences[0].computeAccurateBoundingBox(e,i,r,l)},_updateNearFar:function(e){var i=this.trackingViewpoint?this.trackingViewpoint:e||this.currentViewpoint,r=i.camera;if(!r)return!1;var n=r.near,a=r.far,s=null===this.internalSceneGraph?new t.Sphere(new t.Vector3(0,0,0),100):this.getSceneBoundingSphere(this.visibleSpace?"visibleSpace":"invisibleSpace");if(!s)return!1;var o=0;if(s.pixelRadius>0){var l=r.getWorldSizeFromPixelSize(1,s.center,this._getDivClientHeight());if(void 0!==r.fullWidth&&r.fullWidth>0)l*=Math.max(1*r.width/r.fullWidth,1*r.height/r.fullHeight);o=l*s.pixelRadius}this._updateOffsetPlane(s,r,!1);var c=this._getPlaneSize(s,r,this.gridUnit,this.gridStep);c!==this.planeSize&&(this.planeSize=c);var h,u=(new t.Vector3).subVectors(s.center,r.position),d=(new t.Vector3).subVectors(this.offsetPlaneBackground,r.position),p=r.getLookAt(),f=u.dot(p),m=d.dot(p),g=f,v=Math.PI*Math.max(.1,.5-this.dirLightLatitude),S=Math.sin(v)+(Math.cos(v)+1)/Math.tan(v),_=this._infinitePlane||this._displayGrid;if(_)if(this.cameraBackgroundFar=Math.max(m+this.planeSize,f+s.radius),this._nearFarBigScale){var y=(new t.Sphere).copy(s);y.center.z-=s.radius;var x=new t.Sphere;s.mergeWithSphere(y,x),u.subVectors(x.center,r.position),g=u.dot(p)}else u.z-=s.radius,g=u.dot(p);if(this.cameraBackgroundNear=m-this.planeSize,this._nearFarBigScale&&(this.cameraBackgroundNear=Math.max(this.cameraBackgroundNear,.001)),this.ambience.getBackground().isActivated()&&!this._2DMode)if(this.ambience.isFiniteMode()){if(!r.isOrtho){var M=S*this.ambience.getRadiusEnvMap();this.cameraBackgroundFar=g+M;var P=Math.max(g-M,.001*this.cameraBackgroundFar);P>this.cameraBackgroundNear&&(this.cameraBackgroundNear=P)}0==this.internalSceneGraph.scene.useFiniteEnvMap&&(this.internalSceneGraph.scene.useFiniteEnvMap=!0,this.renderer&&this.renderer.recompileAllShaders(null)),this.internalSceneGraph.scene.parallaxCorrectionParameters.sphereCenter=this.ambience.getCenter(),this.internalSceneGraph.scene.parallaxCorrectionParameters.sphereRadius=this.ambience.getRadius(),this.internalSceneGraph.scene.parallaxCorrectionParameters.projectionCenter=this.ambience.getProjectionCenter()}else 1==this.internalSceneGraph.scene.useFiniteEnvMap&&(this.internalSceneGraph.scene.useFiniteEnvMap=!1,this.renderer&&this.renderer.recompileAllShaders(null)),this.cameraBackgroundFar=Math.max(m+this.planeSize,f+s.radius);if(h=this._nearFarBigScale?S*(_?x.radius+o:s.radius+o):S*(s.radius+o),r.far=g+h,r.near=Math.max(g-h,.001*r.far),this._nearFarBigScale){var C=i.control.distanceToTarget,b=Math.max(0,g-h);r.near=C>50?Math.min(Math.max(C/50,b),r.near):Math.min(Math.max(.1,b),r.near)}return r.isOrtho?r.near=g-h:r.far<0&&(r.near=5,r.far=50),n!==r.near||a!==r.far},isShadowMap:function(){for(var e=(null===this.internalSceneGraph?this.temporaryEmptyScene:this.internalSceneGraph.scene).__lights,t=0;t<e.length;t++)if(!e[t].isVirtual&&(e[t].castShadow||e[t].castGroundShadow))return!0;return!1},dispose:function(){e.publish({event:"/VISU/VIEWER/VIEWER_DISPOSED",data:{eventChannel:"/VISU/VIEWER/VIEWER_DISPOSED",eventType:"@VIEWER_DISPOSED",parameters:{viewer:this}}}),disposedViewers.push(this.id),this.canvas.removeEventListener("webglcontextlost",this.onWebGLContextLost),this.canvas.removeEventListener("webglcontextrestored",this.onWebGLContextRestore),this.canvas.webGLViewer=null;for(var i=0;i<this.highlightSets.length;i++)this.highlightSets[i]&&this.highlightSets[i]._detachEvents(!1,!1);this.highlightSets=[],this._oocManager&&this._oocManager._dispose(),this._oocManager=null,this._sceneGraphOverrideSetManager&&(this._sceneGraphOverrideSetManager.dispose(),this._sceneGraphOverrideSetManager=null),this.disposed=!0,this.setDefaultPicking(!1),this.infPlane&&this.infPlane.dispose(),this.infPlaneSmall&&this.infPlaneSmall.dispose(),this.grid&&this.grid.dispose(),this.ambience&&this.ambience.needUpdateIBL.delete(this),this.renderer.renderer.ambianceGenerators._decreaseSceneUseCount(this.internalSceneGraph.scene),this.bigGrid&&this.bigGrid.dispose(),this.internalSceneGraph&&(this.internalSceneGraph.dispose(),this.internalSceneGraph=null,this._safeInternalSceneGraph=null),e.unsubscribe(this._requestShadowMapUpdate),e.unsubscribe(this._requestVisuUpdate),this.requestViewPanelClose(),t.cleanPredefinedMaterialCache(),t.cleanPredefinedMaterialTextureCache(),this.sceneBackground.dispose(),this.sceneBackground=null,this.manipulatorManager&&(this.manipulatorManager._detachEvents(),this.manipulatorManager=null),this.renderer.renderer.ambianceGenerators.dispose(this),this.renderer.renderer.sssGenerator.dispose(this),this._viewpointManager.dispose(),this._viewpointManager=null;for(i=0;i<this.viewpoints.length;i++)this.viewpoints[i].setDefaultController(!1),this.viewpoints[i]._setNode(null);this.materialManager.viewerList.delete(this.id),this.materialManager.cleanAll(),this.materialManager=null,this._userPassManager._dispose(),this.renderer&&this.renderer.dispose(),this.renderer=null,x.disconnectFrom(this.canvas),x._dispose(this.canvas),document.removeEventListener("contextmenu",this._contextMenu,!0),window.debugWebGLV6Viewer=null,this.div&&(this.canvas&&this.div===this.canvas.parentNode&&this.div.removeChild(this.canvas),this.divCssElement&&this.div===this.divCssElement.parentNode&&this.div.removeChild(this.divCssElement),this.divTrap&&this.div===this.divTrap.parentNode&&this.div.removeChild(this.divTrap),this.svgRootNode&&this.div===this.svgRootNode.parentNode&&this.div.removeChild(this.svgRootNode)),this.canvas.webGLV6Viewer&&delete this.canvas.webGLV6Viewer,this.canvas=null,this.infPlane=null,this.infPlaneSmall=null,this.grid=null,this.bigGrid=null,this.sceneBackground=null,this.cameraBackground=null,this.ambientLight=null,this.directionalLight=null,this.directionalLight2=null,this.directionalLight3=null,this.dirLightGroundShadow=null,this.lights=[],this.currentViewpoint=null,this.viewpoints=[],this.trackingViewpoint=null,this.materialManager=null,this.cameraReflected=null,this.renderer=null,this.debugPickingNode=null,this.debugNormalNode=null,this.temporaryEmptyScene=null,this._modelEvent.destroy(),this.trapSelectionManipulator=null,W.detachViewer(this),this.clearThis(),this._refPlaneMap.clear(),this._refPlaneCounter=0},setRenderFrameCB:function(e,t){this.renderFrameCB=e,this.beginRenderFrameCB=t},getCurrentSceneGraphState:function(){return this.sceneGraphState},getSceneGraphOverrideSetManager:function(){return this._sceneGraphOverrideSetManager},hasSceneGraphOverrideSet:function(){return!!(this.sceneGraphState||this._sceneGraphOverrideSetManager&&this._sceneGraphOverrideSetManager.hasSceneGraphOverrideSet())},getUserPassManager:function(){return this._getUserPassManager()},clearScene:function(e,t){this.empty(e,t)},empty:function(e,t){this.internalSceneGraph&&this.internalSceneGraph.clearScene(e,t,this._sceneGraph?"deprecated":void 0),e&&this.render({updateInfinitePlane:t,needReframe:t}),this.divCss2DElement.empty()},isEmpty:function(){return this._sceneGraph?0===this._sceneGraph._private_root.children.length:this.internalSceneGraph?0===this.internalSceneGraph.userRoot.children.length:void 0},setDisableBackFaceCulling:function(e){this.renderer.setDisableBackFaceCulling(e)},setCameraSystem:function(e){e!==this.cameraSystem&&(this.cameraSystem=e,this.renderer.clearCameraSystemData(),this.cameraSystemUpdated=!0),e||this.renderer.renderer.removeSplitScreenMode(),this.renderer.resetGSSOCache()},set2DMode:function(e,t,i){this._2DMode=e,this._setBackgroundColor(),this._updateGridDisplay(),this._updateInfinitePlaneDisplay(),this._updateShadowPlaneDisplay(),this.currentViewpoint&&this.currentViewpoint._set2DMode(e,t),this._updateSVGVisu(),this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}})},get2DMode:function(){return this._2DMode},getCameraSystem:function(){return this.cameraSystem},_updateShaders:function(){this.internalSceneGraph&&this.internalSceneGraph.updateShaders()},_addRobot:function(e,t){t.addRobotNode(e)},addDebugPoint:function(e,i){var r=b.createSphereNode({radius:3,material:new t.MeshBasicMaterial({color:i,force:!0,enableClipPlanes:!1,forceSide:!0})});r.setNoZ(!0);var n=b.createFixedSizeNode();n.addChild(r),this.internalSceneGraph.addDebugNode(n),n.setPickable(c.PICKTHROUGH);var a=this;function s(e){var i=new t.Matrix4;e instanceof Array&&(e={x:e[0],y:e[1],z:e[2]}),i.setPosition(e),n.setMatrix(i)}return s(e),{setPosition:function(e){s(e)},remove:function(){a.internalSceneGraph.removeDebugNode(n)},add:function(){a.internalSceneGraph.addDebugNode(n)}}},_initRenderStyle:function(){if(!this._renderStyle){var e=new B;e.setFaceMode("COLOR"),e.setMaterialMode(!!this.renderer.renderer.materialMode),e._renderMode._setMask(this.renderer.renderer.renderPointMode|this.renderer.renderer.renderFaceMode|this.renderer.renderer.renderLineMode),e._renderMode._outlineWidth=this.renderer.renderer.outlineWidth,this.setRenderStyle(e)}},setVisuShadingMode:function(t){if(t&&(this._initRenderStyle(),this.visuShadingMode.preset!==t)){switch(this.visuShadingMode.preset=null,t){case"NoShadingEdges":case"Wireframe":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Wireframe"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("NoPoints");break;case"Shading":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("NoEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingEdgesHiddenEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHiddenEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingEdgesHalfSmoothEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdgesHalfSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdgesNoSmoothEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdgesNoSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingIllustration":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Illustration"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingMaterial":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("NoEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingMaterialEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesHalfSmoothEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesHiddenEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHiddenEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesNoSmoothEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingMaterialEdgesNoSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("NoPoints");break;case"Unknown":break;default:throw"Unknown mode in setVisuShadingMode"}this.visuShadingMode.preset=t,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:t}}),e.publish({event:"/VISU/onViewModeChanged",data:{eventChannel:"/VISU/onViewModeChanged",eventType:"@onViewModeChanged",viewer:this}}),this.setRenderStyle(this._renderStyle),this.render()}},_solveVisuShadingPreset:function(){if(null===this.visuShadingMode.preset&&null!==this.visuShadingMode.face&&null!==this.visuShadingMode.edge){for(var e=this.getMaterialMode().toString(),t=re[e],i=this.visuShadingMode.face,r=te[i],n=this.visuShadingMode.edge,a=ie[n],s=0;s<t.length;s++)for(var o=t[s],l=0;l<r.length;l++){var c=r[l];if(c===o)for(var h=0;h<a.length;h++){var u=a[h];if(u===c)return this.visuShadingMode.preset=u,void this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:u}})}}this.visuShadingMode.preset="Unknown",this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:"Unknown"}})}},getVisuShadingMode:function(){return this.visuShadingMode.preset},onVisuShadingModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingMode"},e)},_setVisuShadingFaceMode:function(e){if(e){switch(this._initRenderStyle(),e){case"Shaded":this._renderStyle.setRenderMode("Face",!0),this._renderStyle.setRenderMode("Outline",this.visuShadingMode.outline),this._renderStyle.setFaceMode("COLOR"),this._setVisuShadingEdgeMode(this.visuShadingMode.edge),this._setVisuShadingPointMode(this.visuShadingMode.point);break;case"Illustration":this._renderStyle.setRenderMode("Face",!0),this._renderStyle.setRenderMode("Outline",!0),this._renderStyle.setFaceMode("BACKGROUND"),this._setVisuShadingEdgeMode("WithEdges"),this._setVisuShadingPointMode("NoPoints");break;case"Wireframe":this._renderStyle.setRenderMode("Face",!1),this._renderStyle.setRenderMode("Outline",this.visuShadingMode.outline),this._renderStyle.setFaceMode("COLOR"),this._setVisuShadingEdgeMode("WithEdges"),this._setVisuShadingPointMode("WithPoints");break;default:throw"Unknown mode in setVisuShadingFaceMode"}this.setRenderStyle(this._renderStyle),this.render()}},setVisuShadingFaceMode:function(e){e&&e!==this.visuShadingMode.face&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.visuShadingMode.face=e,this._setVisuShadingFaceMode(e),this._modelEvent.publish({event:"VisuShadingFaceMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getVisuShadingFaceMode:function(){return this.visuShadingMode.face},onVisuShadingFaceModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingFaceMode"},e)},_setVisuOutlineMode:function(e){"Illustration"!==this.visuShadingMode.face&&(this._initRenderStyle(),this.visuShadingMode.outline!==e&&(this._renderStyle.setRenderMode("Outline",e),this.visuShadingMode.outline=e,this._modelEvent.publish({event:"VisuOutlineMode",data:{viewer:this,value:e}}),this.setRenderStyle(this._renderStyle),this.render()))},_getVisuOutlineMode:function(){return this.visuShadingMode.outline},_onVisuOutlineModeChange:function(e){return this._modelEvent.subscribe({event:"VisuOutlineMode"},e)},_setVisuShadingPointMode:function(e){if(e){switch(this._initRenderStyle(),e){case"WithPoints":this._renderStyle.setRenderMode("BoundaryPoint",!0),this._renderStyle.setRenderMode("SharpPoint",!0),this._renderStyle.setRenderMode("SmoothPoint",!0),this._renderStyle.setRenderMode("SurfacicPoint",!0);break;case"NoPoints":this._renderStyle.setRenderMode("BoundaryPoint",!1),this._renderStyle.setRenderMode("SharpPoint",!1),this._renderStyle.setRenderMode("SmoothPoint",!1),this._renderStyle.setRenderMode("SurfacicPoint",!1);break;default:throw"Unknown mode in setVisuShadingPointMode"}this.setRenderStyle(this._renderStyle),this.render()}},setVisuShadingPointMode:function(e){e&&e!==this.visuShadingMode.point&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.visuShadingMode.point=e,"Wireframe"!==this.visuShadingMode.face&&"Illustration"!==this.visuShadingMode.face&&this._setVisuShadingPointMode(e),this._modelEvent.publish({event:"VisuShadingPointMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getVisuShadingPointMode:function(){return this.visuShadingMode.point},onVisuShadingPointModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingPointMode"},e)},_setVisuShadingEdgeMode:function(e){if(e){switch(this._initRenderStyle(),e){case"WithEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesHalfSmoothEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!0);break;case"NoEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!1),this._renderStyle.setRenderMode("Edge",!1),this._renderStyle.setRenderMode("InternalSmoothEdge",!1),this._renderStyle.setRenderMode("BoundaryEdge",!1),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesHiddenEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(1),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesHalfSmoothEdgesHiddenEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(1),this.displayHalVisibleSmoothEdges(!0);break;case"WithEdgesNoSmoothEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!1),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesNoSmoothEdgesHiddenEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!1),this.displayHiddenEdges(1),this.displayHalVisibleSmoothEdges(!1);break;default:throw"Unknown mode in setVisuShadingEdgeMode"}this.setRenderStyle(this._renderStyle),this.render()}},setVisuShadingEdgeMode:function(e){e&&e!==this.visuShadingMode.edge&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.visuShadingMode.edge=e,"Wireframe"!==this.visuShadingMode.face&&"Illustration"!==this.visuShadingMode.face&&this._setVisuShadingEdgeMode(e),this._modelEvent.publish({event:"VisuShadingEdgeMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getVisuShadingEdgeMode:function(){return this.visuShadingMode.edge},onVisuShadingEdgeModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingEdgeMode"},e)},restoreVisualizationMode:function(e){var i=[],r=0,n=t.ShowAllFaces,a=t.ShowAllRenderLineMode,s=0;e&&(void 0!==e.materialMode&&null!==e.materialMode&&(r=e.materialMode),void 0!==e.renderFaceMode&&null!==e.renderFaceMode&&(n=e.renderFaceMode),void 0!==e.renderLineMode&&null!==e.renderLineMode&&(a=e.renderLineMode),void 0!==e.displayHiddenEdges&&null!==e.displayHiddenEdges&&(s=e.displayHiddenEdges));var o=localStorage.getItem("visuShadingMode");if(o)localStorage.removeItem("renderFaceMode"),localStorage.removeItem("renderLineMode"),localStorage.removeItem("displayHiddenEdges"),localStorage.removeItem("materialMode"),this.setVisuShadingMode(o),i.push("Visu"+o+"Cmd"),i.push("Visu"+o);else{if(!localStorage.getItem("materialMode")||"BACKGROUND"!==localStorage.getItem("materialMode")&&"ZONLY"!==localStorage.getItem("materialMode")){var l=localStorage.getItem("materialMode")?parseInt(localStorage.getItem("materialMode"),10):r;this.setMaterialMode(l)}else{var c=new B;c.setFaceMode(localStorage.getItem("materialMode")),this.setRenderStyle(c)}var h=localStorage.getItem("renderFaceMode")?parseInt(localStorage.getItem("renderFaceMode"),10):n,u=localStorage.getItem("renderLineMode")?parseInt(localStorage.getItem("renderLineMode"),10):a;this._setInternalRenderFaceMode(h),this._setInternalRenderLineMode(u);var d=localStorage.getItem("displayHiddenEdges")?parseInt(localStorage.getItem("displayHiddenEdges"),10):s;this.displayHiddenEdges(d)}var p=localStorage.getItem("axisState");p&&(this.setAxisFilter("true"===p),this.getAxisFilter()&&(i.push("VisuFilterAxis"),i.push("VisuFilterAxisEnableCmd")));var f=localStorage.getItem("linesState");f&&(this.setLinesFilter("true"===f),this.getLinesFilter()&&(i.push("VisuFilterLines"),i.push("VisuFilterLinesEnableCmd")));var m=localStorage.getItem("pointsState");return m&&(this.setPointsFilter("true"===m),this.getPointsFilter()&&(i.push("VisuFilterPoints"),i.push("VisuFilterPointsEnableCmd"))),this.applyRenderModeLock(),i},restoreProjectionMode:function(){var e=[];return this.currentViewpoint&&localStorage.getItem("projectionMode")&&!this._2DMode&&(this.currentViewpoint.setProjectionType(parseInt(localStorage.getItem("projectionMode"),10)),1===this.currentViewpoint.getProjectionType()?(e.push("VisuOrthographicViewCmd"),e.push("VisuOrthographicView")):(e.push("VisuPerspectiveViewCmd"),e.push("VisuPerspectiveView"))),e},restoreAmbiance:function(){var e=[],t=localStorage.getItem("visuEnv");return t?t.includes("OCA")?(e.push("Visu"+t+"Cmd"),t=t.replace("OCA",""),this.setVisuEnvOCA(t)):(e.push("Visu"+t+"Env"),e.push("Visu"+t+"EnvCmd"),this.setVisuEnv(t)):this.setV6Ambience(),e},getWidgetID:function(){var e=window.widget;return void 0!==e?e.getValue("x3DAppId"):"no-app"},setRobotAndRefAxisSystemEnabled:function(e){this.internalSceneGraph.setRobotAndRefAxisSystemEnabled(e)},getRobotAndRefAxisSystemEnabled:function(){var e=this.getRobot();return e&&e._isEnabled()},setRenderPriority:function(e){return this.renderer.resetGSSOCache(),e&&this.getSectionCapping()?(console.warn("Render priority mode is not compatible with section capping"),!1):(e&&this.setOIT(!1),this._renderPriorityManager||(this._renderPriorityManager=new O(this)),this._renderPriorityManager.setEnabled(e),!0)},getRenderPriority:function(){return!(!this._renderPriorityManager||!this._renderPriorityManager.enabled)},setRenderPriorityDefaultOpacity:function(e){this.getRenderer().renderPriorityDefaultOpacity=e},forceSceneMin:function(e){this._forceSceneMin(e),this.render({updateInfinitePlane:!0})},_getDivClientWidth:function(){return(this._pageObjectData?this.canvas.width:this.div.clientWidth)||1},_getDivClientHeight:function(){return(this._pageObjectData?this.canvas.height:this.div.clientHeight)||1},_getCanvasOffsetWidth:function(){return this._pageObjectData?this.canvas.width:this.canvas.offsetWidth},_getCanvasOffsetHeight:function(){return this._pageObjectData?this.canvas.height:this.canvas.offsetHeight},_getForceRenderTargetSize:function(){return this._pageObjectData&&this._pageObjectData.forceRenderTargetSize},_forceSceneMin:function(e){this._forceSceneMinValue=e},_addClippingPlane:function(e){},_removeClippingPlane:function(e){},_addManipulator:function(e,t){this._manipulators[t]=e},_removeManipulator:function(e){delete this._manipulators[e]},_filterClippedIntersections:function(e){var t,i,r=[],n=this.getRenderer();n.clipPlanesEnabled&&(t=new R(n.clipPlanes));var a,s=0;for(s=0;s<e.length;s++)(i=(a=e[s]).object&&(t||a.object._occurrence.clippingContext))&&a.point&&!i.isPointVisible(a.point)||r.push(a);return r},setIdPathMatcher:function(e){this.idPathMatcher=e},setImmersiveFrame:function(e){this._immFrame=e},getFreeZone:function(){var e=this._pageObjectData?this._pageObjectData.getFreeZone():null;return e||this._immFrame&&this._immFrame.getFreeZone()},getIdPathMatcher:function(){return this.idPathMatcher},_deprecated_useBackfaceCullingWithNoCapping:function(e){this.renderer.renderer.useBackfaceCullingWithNoCapping=e},useCustomCappingForClipPolyline:function(e){this.renderer.renderer.useCustomCappingForClipPolyline=!!e},_setPageObjectData:function(e){this._pageObjectData=e},_dbgQuickHighlight:function(e){if(e){var t=new s([e]);S.add({pathElement:t})}else S.empty()},_getScenegraphs:function(){let e=this._viewpointManager.getAuxiliaryScenegraphs();return this._safeInternalSceneGraph&&e.push(this._safeInternalSceneGraph),e},_requestClippingUpdate:function(){let e=this._getScenegraphs();for(let t=0;t<e.length;t++)e[t]._needClippingUpdate=!0},_getUserPassManager:function(){return this._userPassManager},_setOOCManager:function(e){this._oocManager=e},_getOOCManager:function(){return this._oocManager},_setInternalRenderFaceMode:function(e){this.renderer.renderer.renderFaceMode=e},_getInternalRenderFaceMode:function(){return this.renderer.renderer.renderFaceMode},_setInternalRenderLineMode:function(e){this.renderer.renderer.renderLineMode=e},_getInternalRenderLineMode:function(){return this.renderer.renderer.renderLineMode},_DEPRECATED_setRenderFooMode:function(e){console.warn("[WebGLViewer] Deprecated setRenderLineMode/setRenderFaceMode method.\nUse setRenderMode() instead\n"+e.stack)},_remoteRenderInfos:{eventToken:null,div:null,cvs:null,img:null,tex:null,useDiv:!1},enableRemoteRender:function(e){this.renderer.setEffect("xRevealStructure",e)},setupRemoteRender:function(e){var t=this;if(this._remoteRenderInfos.eventToken&&(t.unsubscribe(t._remoteRenderInfos.eventToken),!e&&t._remoteRenderInfos.div&&t._remoteRenderInfos.div.destroy()),e||t.renderer.setEffect("xRevealStructure",!1),e){if(t._remoteRenderInfos.useDiv&&!t._remoteRenderInfos.div){t._remoteRenderInfos.div=UWA.createElement("div"),t._remoteRenderInfos.div.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"});let e=UWA.createElement("img"),i=UWA.createElement("canvas");i.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),t.div.insertBefore(t._remoteRenderInfos.div,t.div.firstChild),t._remoteRenderInfos.div.append(e),t._remoteRenderInfos.div.append(i),t._remoteRenderInfos.img=e,t._remoteRenderInfos.cvs=i}if(t._remoteRenderInfos.useDiv||this.getEffect("xRevealStructure")||this.renderer.initEffect("xRevealStructure"),t.renderer.setEffect("xRevealStructure",!0),"function"==typeof e){t._remoteRenderInfos.eventToken=t.onPreRender(function(){var i=e(t.currentViewpoint,[t.SCREEN_WIDTH,t.SCREEN_HEIGHT]);i&&i.then(t._onRemoteImageReceived).catch(()=>{})})}}},setRemoteVideo:function(e){let i=new t.ImageUtils.loadVideoTexture(e);viewer.getEffect("xRevealStructure").updateTexture(i)},_onRemoteImageReceived:function(e){let i=this;if(e.data)if(i._remoteRenderInfos.useDiv){if("blob"==e.format||"arrayBuffer"==e.format||"url"==e.format)URL.revokeObjectURL(i._remoteRenderInfos.img.src),"blob"==e.format?i._remoteRenderInfos.img.src=URL.createObjectURL(e.data):"arrayBuffer"==e.format?i._remoteRenderInfos.img.src=URL.createObjectURL(new Blob([e.data])):"url"==e.format&&(i._remoteRenderInfos.img.src=e.data),i._remoteRenderInfos.img.width=i.SCREEN_WIDTH,i._remoteRenderInfos.img.height=i.SCREEN_HEIGHT,i._remoteRenderInfos.cvs.width=0,i._remoteRenderInfos.cvs.height=0;else if("uint8Array"==e.format){i._remoteRenderInfos.img.width=0,i._remoteRenderInfos.img.height=0,i._remoteRenderInfos.cvs.width=e.width,i._remoteRenderInfos.cvs.height=e.height;var r=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height);i._remoteRenderInfos.cvs.getContext("2d").putImageData(r,0,0)}}else{var n=null,a=!0;"uint8Array"==e.format?((n=new t.DataTexture(e.data,e.width,e.height,t.RGBAFormat,t.UnsignedByteType)).flipY=!1,n.needsUpdate=!0,a=!1):"blob"==e.format?n=new t.ImageUtils.loadTexture(URL.createObjectURL(e.data)):"arrayBuffer"==e.format?n=new t.ImageUtils.loadTexture(URL.createObjectURL(new Blob([e.data]))):"url"==e.format&&(n=new t.ImageUtils.loadTexture(e.data)),a?n.onLoadCallbacks.push(function(e){i._remoteRenderInfos.tex&&i._remoteRenderInfos.tex.dispose(),i._remoteRenderInfos.tex=e,i.getEffect("xRevealStructure").updateTexture(e)}):(i._remoteRenderInfos.tex&&i._remoteRenderInfos.tex.dispose(),i._remoteRenderInfos.tex=n,i.getEffect("xRevealStructure").updateTexture(n))}}});return Object.defineProperty(ae.prototype,"backgroundColor",{get:function(){return this.__tempBackgroundColorODT}}),Object.defineProperty(ae.prototype,"sceneGraph",{get:function(){return n.DEPRECATED_SceneGraph(new Error,!0),this.getRootNode()}}),UWA.namespace("THREEDS/WebGLViewer",ae)}),define("DS/VisuDataAccess/Ox4SelectTask",[],function(){"use strict";return function(e,t){var i=e,r=t,n=function(e,t,i,r){var n=e,a=t,s=function(e,t,i){var r=/\{(.*?)\}[\s\}]/g;i=i.substring(1,i.length-1);for(var s,o=-1,l=new Array;null!==(s=r.exec(i));){for(s[0]=s[0].trim(),0==s[0].indexOf("{{")&&(s[0]=s[0].substring(2,s[0].length)),0==s[0].indexOf("{")&&(s[0]=s[0].substring(1,s[0].length)),s[0].indexOf("}")==s[0].length-1&&(s[0]=s[0].substring(0,s[0].length-1));s[0].startsWith("{")||s[0].endsWith("}");)s[0].startsWith("{")&&(s[0]=s[0].substring(1,s[0].length)),s[0].endsWith("}")&&(s[0]=s[0].substring(0,s[0].length-1));l.push(s[0]),r.lastIndex===o&&(isILinenfiniteLoop=!0),o=r.lastIndex}n.injectRowInto(t,l,a)};!function(e){for(var t,a=/[^\r\n]+/g,o=/^paths:.*/g,l=-1,c=!1,h="fetch";null!==(t=a.exec(i))&&!c;)n.hasPathAttrs()&&"fetch"===h&&null!==o.exec(t[0])&&(h="path"),s(n,h,t[0]),a.lastIndex===l&&(c=!0),l=a.lastIndex;r()}()},a=function(){var e="start transaction ;\n";return 0==i.boOrRel?e+="query connection type %1  where \"physicalid matchlist '%2'','\"  select %3 dump | tcl;\n":e+="temporary query businessobject  %1 * *  where \"physicalid matchlist '%2'','\"  select %3 dump | tcl;\n",e+="abort transaction ;\n"},s=function(){var e='<?xml version="1.0" encoding="utf-8"?>\n';return e+='<executeSequence xmlns="http://www.3ds.com/xmql/query">\n',e+="\t<execute>\n",0==i.boOrRel?e+="\t\t<function>query_connection_set":e+="\t\t<function>query_bus_set",i.hasPathAttrs()&&(e+="_sr"),e+="</function>\n",e+="\t\t<version>2.0.0</version>\n",e+="\t\t<params>\n",e+='\t\t\t<param name="label">fetch</param>\n',e+='\t\t\t<param name="setname">%s</param>\n',0!=i.boOrRel&&(e+='\t\t\t<param name="name">*</param>\n',e+='\t\t\t<param name="revision">*</param>\n'),e+='\t\t\t<param name="vault">*</param>\n',e+='\t\t\t<param name="orderbykw"/>\n',e+='\t\t\t<param name="orderby"/>\n',e+='\t\t\t<param name="limitkw"/>\n',e+='\t\t\t<param name="limit"/>\n',e+='\t\t\t<param name="rootids">%2</param>\n',e+='\t\t\t<param name="select">%3</param>\n',e+='\t\t\t<param name="type">%1</param>\n',i.hasPathAttrs()&&(e+='\t\t\t<param name="labelSR">paths</param>\n',e+='\t\t\t<param name="selectpath">%4</param>\n'),e+='\t\t\t<param name="notsubstitute">true</param>\n',e+='\t\t\t<param name="dump">|</param>\n',e+="\t\t</params>\n",e+="\t</execute>\n",e+="</executeSequence>\n"},o=r.rawmode?a():s();this.run=function(e,t,a,s,l){console.log("running Ox4xMQLSelectTask");var c=r.xmqlServiceUri(),h=i.typeRequested(),u=e.findNodeByPLMTypeExpressedAsPhyIdAsJSON(h);if(u.length>0){var d=o.replace("%s",t.SetName);d=(d=(d=d.replace("%1",h)).replace("%2",u)).replace("%3",i.marshallAsMQLListOfFetchAttributesAsJSON()),i.hasPathAttrs()&&(d=d.replace("%4",i.marshallAsMQLListOfPathAttributesAsJSON())),t.executePostHttpRequest(c,r.rawmode,d,function(t){new n(i,e,t,function(){s(this)})})}else s(this)}}}),define("VisuDataAccess/Ox4SelectTask",["DS/VisuDataAccess/Ox4SelectTask","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/Ox4SelectTask"),e}),define("DS/QualityManager/QMGIController",["UWA/Core","UWA/Class","DS/QualityManager/QMGIPresetStreamer"],function(e,t,i){"use strict";return t.singleton({init:function(){this.isInitialized=!0,this.initPresetDB(),this.properties={},this._QMSettings={MaxSamples:{value:{Static:!0,Batch:!1}},MinSamples:{value:{Static:!0,Batch:!1}},Clamping:{value:{Static:!0,Batch:!0}},GaussFilter:{value:{Static:!0,Batch:!0}},Size:{value:{Static:!0,Batch:!0}},CenterWeight:{value:{Static:!0,Batch:!0}},MAxTraceDepth:{value:{Static:!0,Batch:!0}},GlossyThreshold:{value:{Static:!0,Batch:!0}},RenderRefractiveShadow:{value:{Static:!0,Batch:!0}},LocationBasedSampling:{value:{Static:!0,Batch:!0}},Distribution:{value:{Static:!0,Batch:!0}},Factor:{value:{Static:!0,Batch:!0}},PathTerminationDepth:{value:{Static:!0,Batch:!0}},VisualizationMode:{value:{Static:!0,Batch:!1}},EnableFinalGathering:{value:{Static:!0,Batch:!0}},NoOfPhotons:{value:{Static:!0,Batch:!0}},PathDepth:{value:{Static:!0,Batch:!0}},PhotonRadius:{value:{Static:!0,Batch:!0}},RefineMap:{value:{Static:!0,Batch:!0}},PrecalculateIrradiance:{value:{Static:!0,Batch:!0}},Caustics:{value:{Static:!0,Batch:!0}},CausticsPhotonNumber:{value:{Static:!0,Batch:!0}},CausticsPathDepth:{value:{Static:!0,Batch:!0}},CausticRadius:{value:{Static:!0,Batch:!0}},CausticRefinePhotonMap:{value:{Static:!0,Batch:!0}},RayOffset:{value:{Static:!0,Batch:!0}},AllowGroundShadows:{value:{Static:!0,Batch:!0}},AllowReflectionsOnGround:{value:{Static:!0,Batch:!0}},AllowBloom:{value:{Static:!0,Batch:!0}},AllowDepthOfField:{value:{Static:!0,Batch:!0}},DownsamplingFctor:{value:{Static:!0,Batch:!1}}}},initPresetDB:function(){i.init(),this.currentUser=i.getItem("currentUser");var e="Users/"+this.currentUser+"/currentPreset";this.currentPreset=i.getItem(e),this.prestToModify="Custom"},setCurrentUser:function(t){var r="Users/"+t,n=i.getItem(r);e.is(n)&&(i.setItem("currentUser",t),this.currentUser=t)},setCurrentPreset:function(t){var r="Users/"+this.currentUser+"/currentPreset",n=i.getItem(r);e.is(n)&&(i.setItem(r,t),this.currentPreset=t)},getCurrentUserPresetQuery:function(){return"Users/"+this.currentUser+"/Preset/"},getCurrentPreset:function(){var e="Users/"+this.currentUser+"/currentPreset";return i.getItem(e)},validateAttribute:function(e,t){var i=!0;return"ReflectionsOnGround"!=e&&"Preset"!=e||(i=!1),i},setAttribute:function(e,t,i,r,n){this.setAttributeOnDB(e,t,i,r,n)},setAttributeOnDB:function(e,t,r,n,a){var s=this.getCurrentUserPresetQuery()+e+"/"+this.prestToModify+"/"+r+"/",o=s+n;i.setItem(o,a);var l=s+"Preset";i.setItem(l,t)},setProperty:function(e,t,i){this.setPropertyOnDB(e,t,i)},setPropertyOnDB:function(t,r,n){var a=this.getCurrentUserPresetQuery()+t+"/"+r,s=i.getItem(a);if(!e.is(s))return!1;var o=s[n];if(!e.is(o))return!1;for(var l in o)if(o.hasOwnProperty(l)){var c=o[l];this.setAttributeOnDB(t,r,n,l,c)}},setGlobalPreset:function(e,t,i){this.setGlobalPresetOnDB(e,t,i)},setGlobalPresetOnDB:function(t,r,n){var a=this.getCurrentUserPresetQuery()+t+"/currentGlobalPreset";if(i.setItem(a,r),n){a=this.getCurrentUserPresetQuery()+t+"/"+r;var s=i.getItem(a);if(!e.is(s))return!1;for(var o in s)s.hasOwnProperty(o)&&this.setPropertyOnDB(t,r,o)}},getCurrentGlobalPreset:function(e){var t=this.getCurrentUserPresetQuery()+e+"/currentGlobalPreset";return i.getItem(t)},getPresetValue:function(e,t){var r=this.getCurrentUserPresetQuery()+e+"/"+t;return i.getItem(r)},commitToDB:function(){i.commit()},restoreFromDB:function(){i.retoreDB();var e=this.getCurrentPreset(),t=this.getCurrentGlobalPreset(e);this.setGlobalPreset(e,t,!1)},setQMsetting:function(e,t,i){var r=this._QMSettings[e];r.value[t]="true"==i},getQMsetting:function(e,t){return this._QMSettings[e].value[t]}})}),define("DS/VisuLoaders/WebSocketLoader",[],function(){"use strict";var e=window.mySocket,t=function(e,t,i,r){this.msg=e,this.msgData=t,this.answer=i,this.onCompletedCB=r};t.emit=function(){};var i=function(){this.pendingRequests=[],this.pending=0,this.maxPending=5};return i.prototype.isEnabled=function(){return!!e},i.prototype.emit=function(e,i,r,n){if(this.pending<this.maxPending)this._emit(e,i,r,n);else{var a=new t(e,i,r,n);this.pendingRequests.push(a)}},i.prototype._emitNext=function(){if(this.pending<this.maxPending&&this.pendingRequests.length>0){var e=this.pendingRequests.shift();this._emit(e.msg,e.msgData,e.answer,e.onCompletedCB)}},i.prototype._emit=function(t,i,r,n){this.pending++,e.emit(t,i);var a=this;e.on(r,function(e){n(e),a.pending--,a._emitNext()})},new i}),define("DS/VisuDataAccess/Ox4ExpandTask",[],function(){"use strict";return function(e,t,i){this.oid=e,this.serverdefinition=t,this.relationship=i;var r=null;this.generateMQL=function(){return this.serverdefinition.rawmode?this.generateRawMQL():this.generateProcMQL()},this.generateRawMQL=function(){var e="start transaction ;\n";return e+="expand businessobject  %oid% from relationship "+this.relationship+"  recurse to all size 1000 terse select bus physicalid type select relationship id physicalid dump | tcl;\n",e+="abort transaction ;\n"},this.generateProcMQL=function(){var e='<?xml version="1.0" encoding="utf-8"?>\n';return e+='<executeSequence xmlns="http://www.3ds.com/xmql/query">\n',e+="\t<execute>\n",e+="\t\t<function>expand_bus</function>\n",e+="\t\t<version>2.0.0</version>\n",e+="\t\t<params>\n",e+='\t\t\t<param name="label">expand</param>\n',e+='\t\t\t<param name="rootid">%oid%</param>\n',e+='\t\t\t<param name="from">true</param>\n',e+='\t\t\t<param name="to"></param>\n',e+='\t\t\t<param name="typepattern">*</param>\n',e+='\t\t\t<param name="relpattern">'+this.relationship+"</param>\n",e+='\t\t\t<param name="fixedpointskw"/>\n',e+='\t\t\t<param name="fixedpointsids">[]</param>\n',e+='\t\t\t<param name="withroots">true</param>\n',e+='\t\t\t<param name="preventduplicates">false</param>\n',e+='\t\t\t<param name="recurselevel">all</param>\n',e+='\t\t\t<param name="size">1000</param>\n',e+='\t\t\t<param name="terse">true</param>\n',e+='\t\t\t<param name="selectbo"> ["physicalid", "type", "attribute[PLMEntity.V_Name]", "attribute[PLMEntity.PLM_ExternalID]", "owner"]</param>\n',e+='\t\t\t<param name="wherebokw"/>\n',e+='\t\t\t<param name="wherebo"/>\n',e+='\t\t\t<param name="selectrel">["id","physicalid", "attribute[PLMInstance.V_Name]", "attribute[PLMInstance.PLM_ExternalID]", "owner"]</param>\n',e+='\t\t\t<param name="whererel"/>\n',e+='\t\t\t<param name="dump">|</param>\n',e+='\t\t\t<param name="notsubstitute">true</param>\n',e+="\t\t</params>\n",e+="\t</execute>\n",e+="</executeSequence>\n"};var n=this.generateMQL();this.run=function(i,a,s,l,c){r=i,console.log("running Ox4xMQLExpandTask");var h=t.xmqlServiceUri(),u=n.replace("%oid%",this.oid);a.executePostHttpRequest(h,t.rawmode,u,function(t){console.log("callback has been called"),new o(e,i,t,function(){l(this)})})},this.dataSet=function(){return r};var a={bus:[],rel:[]},s=function(e,t){var i=t,r=new Array;this.setFatherLevel=function(e){var t=r.length-1;if(e>t);else if(e<=t){for(var i=t;i!=e;)r.pop(),i-=1;r.pop()}},this.lastNode=function(){return r[r.length-1]},this.pushNode=function(e){r.push(e)},this.getRootNode=function(){return i.rootNode()},this.pushNode(i.rootNode()),this.registerRelationship=function(e,t){i.registerRelationship(t);var r=i.findNodeByPhysicalId(t.to.phyid);this.pushNode(r)}},o=function(e,t,i,r){var n=new s(e,t),o=function(e){var t,i=/\{([^\{\}]*)}/g,r=-1,s=0,o=new Object;o.to=new Object;for(var l=-1;null!==(t=i.exec(e));){var c=t[1];if("0"===l)6===s?n.getRootNode().title=c:7===s?n.getRootNode().plmexternalId=c:8===s&&(n.getRootNode().owner=c);else if(0===s){if("0"===(l=c)){s+=1;continue}n.setFatherLevel(l)}else 1===s?(o.plmtype=c,-1===a.rel.indexOf(c)&&a.rel.push(c)):2===s||(3===s?o.to.ident=c:4===s?o.to.phyid=c:5===s?(o.to.plmtype=c,-1===a.bus.indexOf(c)&&a.bus.push(c)):6===s?o.to.title=c:7===s?o.to.realName=c:8===s?o.to.owner=c:9===s?o.ident=c:10===s?o.phyid=c:11===s?o.title=c:12===s?o.realName=c:13===s&&(o.owner=c));s+=1,i.lastIndex===r&&(isILinenfiniteLoop=!0),r=i.lastIndex}if("0"!==l&&void 0!==o.phyid){var h=n.lastNode();o.from=h,n.registerRelationship(l,o)}};!function(e){for(var n,s=/[^\r\n]+/g,l=-1,c=!1;null!==(n=s.exec(i))&&!c;)o(n[0]),s.lastIndex===l&&(c=!0),l=s.lastIndex;t.FindWorkTypes(a,function(){r()})}()}}}),define("VisuDataAccess/Ox4ExpandTask",["DS/VisuDataAccess/Ox4ExpandTask","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/Ox4ExpandTask"),e}),define("DS/Animation/ANIM",[],function(){"use strict";var e={assert:function(e){if(!e)throw"ANIM.assert failed"},assertX:function(e,t){if(!e)throw"ANIM.assert failed:"+t},State:{RUNNING:0,STOPPED:1,PAUSED:2},Direction:{FORWARD:0,BACKWARD:1}};return e}),define("Animation/ANIM",["DS/Animation/ANIM","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Animation/ANIM"),e}),define("DS/Effects/SaveAsHDR",[],function(){"use strict";return{writeHDRHeader:function(e,t){var i=function(e,t,i){for(var r=0;r<t.length;r++)e[i++]=t.charCodeAt(r);return i},r="# Made with Dassault Systemes HDR mipmap roughness generator - TZW",n="-Y "+t+" +X "+e,a=new Uint8Array("#?RADIANCE".length+1+r.length+1+"FORMAT=32-bit_rle_rgbe".length+2+n.length+1+e*t*4),s=0;return s=i(a,"#?RADIANCE",s),a[s++]=10,s=i(a,r,s),a[s++]=10,s=i(a,"FORMAT=32-bit_rle_rgbe",s),a[s++]=10,a[s++]=10,s=i(a,n,s),a[s++]=10,{buffer:a,offset:s,width:e,height:t}},writeTexture:function(e,t,i,r){for(var n=4*t.width*r,a=4*i,s=e.height-1,o=0;o<e.height;o++){for(var l=e.width-1,c=0;c<e.width;c++){for(var h=0;h<4;h++)t.buffer[t.offset+n+a+4*c+h]=255*e.buffer[4*(e.width*s+l)+h];l--}n+=4*t.width,s--}},compressHDR:function(e){for(var t=function(e){for(var t=new Uint8Array(2*e.length),i=0;i<e.length;i++)t[i]=e[i];return t},i=e.offset,r=i,n=new Uint8Array(e.buffer.length),a=0;a<i;a++)n[a]=e.buffer[a];for(var s=new Uint8Array(4+5*e.width),o=0;o<e.height;o++){var l=0;s[l++]=2,s[l++]=2,s[l++]=e.width>>8,s[l++]=255&e.width;for(var c=0;c<4;c++){var h=[];for(a=0;a<e.width;){for(var u=0,d=e.buffer[i+4*(o*e.width+a)+c],p=d;a<e.width&&p===d&&u<127;)u++,a++,d=p,p=e.buffer[i+4*(o*e.width+a)+c];if(u>3){if(h.length){s[l++]=h.length;for(var f=0;f<h.length;f++)s[l++]=h[f];h=[]}s[l++]=128+u,s[l++]=d}else{if(h.length+u>127){s[l++]=h.length;for(f=0;f<h.length;f++)s[l++]=h[f];h=[]}h.push(d),u>1&&h.push(d),u>2&&h.push(d)}}if(h.length){s[l++]=h.length;for(f=0;f<h.length;f++)s[l++]=h[f]}}r+l>=n.length&&(n=t(n));for(var m=0;m<l;m++)n[r++]=s[m]}var g=new Uint8Array(r);for(a=0;a<r;a++)g[a]=n[a];e.buffer=g}}}),define("DS/VisuDataAccess/Ox4SetTask",[],function(){"use strict";return function(e,t){var i=e,r=t,n=function(){var e="start transaction ;\n";return e+=i?"label deleteset delete set %1":"label addset add set %1 type temporary hidden;",e+="commit transaction;"},a=function(){var e='<?xml version="1.0" encoding="utf-8"?>\n';return e+='<executeSequence xmlns="http://www.3ds.com/xmql/query">\n',e+="\t<execute>\n",e+=i?"\t\t<function>delete_set</function>\n":"\t\t<function>add_set</function>\n",e+="\t\t<version>2.0.0</version>\n",e+="\t\t<params>\n",e+=i?'\t\t\t<param name="label">deleteset</param>\n':'\t\t\t<param name="label">addset</param>\n',e+='\t\t\t<param name="setname">%1</param>\n',e+="\t\t</params>\n",e+="\t</execute>\n",e+="</executeSequence>\n"},s=r.rawmode?n():a();this.run=function(e,t,n,a,o){console.log("running Ox4MQLSetTask");var l=r.xmqlServiceUri(),c=s.replace("%1",t.SetName);t.executePostHttpRequest(l,r.rawmode,c,function(e){console.log((i?"Delete":"Add")+" Set: OK!"),a(this)})}}}),define("DS/VisuDataAccess/Ox4TicketGeneratorTask",[],function(){"use strict";return function(e,t){var i=e,r=t;this.generateRequest=function(){return{url:r.xmqlServiceUri(),data:i}}}}),define("VisuDataAccess/Ox4TicketGeneratorTask",["DS/VisuDataAccess/Ox4TicketGeneratorTask","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/Ox4TicketGeneratorTask"),e}),define("DS/GPUFormats/VertexAttribute",[],function(){"use strict";return{float16:{base:"float16",components:1,normalized:!1,size:2,native:void 0},float16x2:{base:"float16",components:2,normalized:!1,size:4,native:void 0},float16x3:{base:"float16",components:3,normalized:!1,size:6,native:void 0},float16x4:{base:"float16",components:4,normalized:!1,size:8,native:void 0},float32:{base:"float32",components:1,normalized:!1,size:4,native:void 0},float32x2:{base:"float32",components:2,normalized:!1,size:8,native:void 0},float32x3:{base:"float32",components:3,normalized:!1,size:12,native:void 0},float32x4:{base:"float32",components:4,normalized:!1,size:16,native:void 0},sint8:{base:"sint8",components:1,normalized:!1,size:1,native:void 0},sint8x2:{base:"sint8",components:2,normalized:!1,size:2,native:void 0},sint8x3:{base:"sint8",components:3,normalized:!1,size:3,native:void 0},sint8x4:{base:"sint8",components:4,normalized:!1,size:4,native:void 0},sint16:{base:"sint16",components:1,normalized:!1,size:2,native:void 0},sint16x2:{base:"sint16",components:2,normalized:!1,size:4,native:void 0},sint16x3:{base:"sint16",components:3,normalized:!1,size:6,native:void 0},sint16x4:{base:"sint16",components:4,normalized:!1,size:8,native:void 0},sint32:{base:"sint32",components:1,normalized:!1,size:4,native:void 0},sint32x2:{base:"sint32",components:2,normalized:!1,size:8,native:void 0},sint32x3:{base:"sint32",components:3,normalized:!1,size:12,native:void 0},sint32x4:{base:"sint32",components:4,normalized:!1,size:16,native:void 0},snorm8:{base:"sint8",components:1,normalized:!0,size:1,native:void 0},snorm8x2:{base:"sint8",components:2,normalized:!0,size:2,native:void 0},snorm8x3:{base:"sint8",components:3,normalized:!0,size:3,native:void 0},snorm8x4:{base:"sint8",components:4,normalized:!0,size:4,native:void 0},snorm16:{base:"sint16",components:1,normalized:!0,size:2,native:void 0},snorm16x2:{base:"sint16",components:2,normalized:!0,size:4,native:void 0},snorm16x3:{base:"sint16",components:3,normalized:!0,size:6,native:void 0},snorm16x4:{base:"sint16",components:4,normalized:!0,size:8,native:void 0},uint8:{base:"uint8",components:1,normalized:!1,size:1,native:void 0},uint8x2:{base:"uint8",components:2,normalized:!1,size:2,native:void 0},uint8x3:{base:"uint8",components:3,normalized:!1,size:3,native:void 0},uint8x4:{base:"uint8",components:4,normalized:!1,size:4,native:void 0},uint16:{base:"uint16",components:1,normalized:!1,size:2,native:void 0},uint16x2:{base:"uint16",components:2,normalized:!1,size:4,native:void 0},uint16x3:{base:"uint16",components:3,normalized:!1,size:6,native:void 0},uint16x4:{base:"uint16",components:4,normalized:!1,size:8,native:void 0},uint32:{base:"uint32",components:1,normalized:!1,size:4,native:void 0},uint32x2:{base:"uint32",components:2,normalized:!1,size:8,native:void 0},uint32x3:{base:"uint32",components:3,normalized:!1,size:12,native:void 0},uint32x4:{base:"uint32",components:4,normalized:!1,size:16,native:void 0},unorm8:{base:"uint8",components:1,normalized:!0,size:1,native:void 0},unorm8x2:{base:"uint8",components:2,normalized:!0,size:2,native:void 0},unorm8x3:{base:"uint8",components:3,normalized:!0,size:3,native:void 0},unorm8x4:{base:"uint8",components:4,normalized:!0,size:4,native:void 0},unorm16:{base:"uint16",components:1,normalized:!0,size:2,native:void 0},unorm16x2:{base:"uint16",components:2,normalized:!0,size:4,native:void 0},unorm16x3:{base:"uint16",components:3,normalized:!0,size:6,native:void 0},unorm16x4:{base:"uint16",components:4,normalized:!0,size:8,native:void 0}}}),define("DS/VisuDataAccess/Ox4DECSelectTask",[],function(){"use strict";return function(e,t,i){var r=e,n=t,a=function(e,t,i,r){var n=e,a=t,s=function(e,t){var i=/\{([^\}]*)}/g;t=t.substring(1,t.length-1);for(var r,s=-1,o=new Array;null!==(r=i.exec(t));)0==r[0].indexOf("{{")&&(r[0]=r[0].substring(2,r[0].length)),0==r[0].indexOf("{")&&(r[0]=r[0].substring(1,r[0].length)),r[0].indexOf("}")==r[0].length-1&&(r[0]=r[0].substring(0,r[0].length-1)),o.push(r[0]),i.lastIndex===s&&(isILinenfiniteLoop=!0),s=i.lastIndex;n.injectRowInto(o,a)};!function(e){for(var t,a=/[^\r\n]+/g,o=-1,l=!1;null!==(t=a.exec(i))&&!l;)s(n,t[0]),a.lastIndex===o&&(l=!0),o=a.lastIndex;r()}()},s=function(){var e="start transaction ;\n";return 0==r.boOrRel?e+="query connection type '%1'  where \"physicalid matchlist '%2'','\"  select %3 dump | tcl;\n":1==r.boOrRel?e+="temporary query businessobject  '%1' * *  where \"physicalid matchlist '%2'','\"  select %3 dump | tcl;\n":2==r.boOrRel?e+="temporary query businessobject  * * *  where \"physicalid matchlist '"+i+"'','\"  select %3 dump | tcl;\n":e+=" expand businessobject "+i+' from relationship "CAD SubComponent" recurse to all size 1000 terse select bus physicalid name dump | tcl;\n',e+="abort transaction ;\n"},o=function(){var e='<?xml version="1.0" encoding="utf-8"?>\n';return e+='<executeSequence xmlns="http://www.3ds.com/xmql/query">\n',e+="\t<execute>\n",r.boOrRel>=0&&r.boOrRel<=2?(0==r.boOrRel?e+="\t\t<function>query_connection</function>\n":e+="\t\t<function>query_bus</function>\n",e+="\t\t<version>2.2.1</version>\n",e+="\t\t<params>\n",e+='\t\t\t<param name="label">select</param>\n',0!=r.boOrRel&&(e+='\t\t\t<param name="name">*</param>\n',e+='\t\t\t<param name="revision">*</param>\n'),e+='\t\t\t<param name="vault">*</param>\n',e+='\t\t\t<param name="orderbykw"/>\n',e+='\t\t\t<param name="orderby"/>\n',e+='\t\t\t<param name="limitkw"/>\n',e+='\t\t\t<param name="limit"/>\n',e+='\t\t\t<param name="where">where</param>\n',e+='\t\t\t<param name="select">%3</param>\n',2==r.boOrRel?(e+='\t\t\t<param name="type">*</param>\n',e+='\t\t\t<param name="where">physicalid matchlist \''+i+"'','</param>\n"):(e+='\t\t\t<param name="type">%1</param>\n',e+="\t\t\t<param name=\"where\">physicalid matchlist '%2'','</param>\n"),e+='\t\t\t<param name="notsubstitute">true</param>\n',e+='\t\t\t<param name="dump">|</param>\n',e+="\t\t</params>\n"):(e+="\t\t<function>expand_bus</function>\n",e+="\t\t<version>2.0.0</version>\n",e+="\t\t<params>\n",e+='\t\t\t<param name="label">expand</param>\n',e+='\t\t\t<param name="rootid">'+i+"</param>\n",e+='\t\t\t<param name="from">true</param>\n',e+='\t\t\t<param name="to"/>\n',e+='\t\t\t<param name="typepattern">*</param>\n',e+='\t\t\t<param name="relpattern">"CAD SubComponent"</param>\n',e+='\t\t\t<param name="fixedpointskw"/>\n',e+='\t\t\t<param name="fixedpointsids">[]</param>\n',e+='\t\t\t<param name="withroots">false</param>\n',e+='\t\t\t<param name="preventduplicates">false</param>\n',e+='\t\t\t<param name="recurselevel">all</param>\n',e+='\t\t\t<param name="selectbo"> ["physicalid", "name"]</param>\n',e+='\t\t\t<param name="wherebo"/>\n',e+='\t\t\t<param name="selectrel"/>\n',e+='\t\t\t<param name="whererelkw"/>\n',e+='\t\t\t<param name="whererel"/>\n',e+='\t\t\t<param name="dump">|</param>\n',e+="\t\t</params>\n"),e+="\t</execute>\n",e+="</executeSequence>\n"},l=n.rawmode?s():o();this.run=function(e,t,i,a,s){console.log("running Ox4xMQLSelectTask");var o=n.xmqlServiceUri(),h=r.typeRequested(),u=e.findNodeByPLMTypeExpressedAsPhyIdSeparatedByComma(h);if(u.length>0){var d=l.replace("%1",h);d=(d=d.replace("%3",r.marshallAsMQLListOfFetchAttributesAsJSON())).replace("%2",u),t.executePostHttpRequest(o,n.rawmode,d,function(t){c(t,e,a)})}else a(this)};var c=function(e,t,i){new a(r,t,e,function(){i(this)})}}}),define("VisuDataAccess/Ox4DECSelectTask",["DS/VisuDataAccess/Ox4DECSelectTask","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/Ox4DECSelectTask"),e}),define("DS/Shaders/CompositeShader",[],function(){"use strict";return{defines:{USE_BLOOM:0},uniforms:{tDiffuse:{type:"t",value:null},gradingMap:{type:"t",value:null},gradingDepth:{type:"f",value:16},brightness:{type:"f",value:0},tAutoExposure:{type:"t",value:null},fAutoExposure:{type:"f",value:1},gamma:{type:"f",value:2.2},crushblacks:{type:"f",value:0},burnhighlights:{type:"f",value:0},saturation:{type:"f",value:1},colorCorrection:{type:"v3",value:{x:1,y:1,z:1}},power:{type:"f",value:0},sensorSize:{type:"f",value:35},screenRatio:{type:"f",value:1},focalLength:{type:"f",value:38.6}},fragmentShader:["varying vec2 texCoord;","uniform sampler2D tDiffuse;","uniform float brightness;","#if(USE_AUTO_EXPOSURE > 0)","\tuniform sampler2D tAutoExposure;","\tuniform float fAutoExposure;","#endif","#if defined( COLOR_GRADING )","uniform sampler2D gradingMap;","uniform float gradingDepth;","#endif","uniform float gamma;","uniform float crushblacks;","uniform float burnhighlights;","uniform float saturation;","uniform vec3 colorCorrection;","uniform float power;","uniform float sensorSize;","uniform float screenRatio;","uniform float focalLength;","#if defined (TONEMAP_FILMIC)","\t#define FILMIC_NRE_A 0.22","\t#define FILMIC_NRE_B 0.3","\t#define FILMIC_NRE_C 0.1","\t#define FILMIC_NRE_D 0.2","\t#define FILMIC_NRE_E 0.01","\t#define FILMIC_NRE_F 0.3","\t#define FILMIC_NRE_W 11.2","#endif","#if defined (TONEMAP_PHOTOGRAPHIC)","   float luminance_RGB (vec3 iColor) {","\t\tvec3 luminance_weight=vec3(0.176204,0.812985,0.0108109);","\t\treturn dot(iColor,luminance_weight);","\t}","#endif","#ifdef TONEMAP_UNCHARTED","   const float A = 0.15;","   const float B = 0.50;","   const float C = 0.10;","   const float D = 0.20;","   const float E = 0.02;","   const float F = 0.30;","   const float W = 11.2;","   vec3 Uncharted2Tonemap( vec3 x ) {","       return ( ( x * ( A * x + C * B ) + D * E ) / ( x * ( A * x + B ) + D * F ) ) - E / F;","   }","#endif","float dither = 0.004;","float random(vec3 scale, float seed) {","  return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","vec3 Random3D(float seed) {","vec3 res;","res.x = random(vec3(12.9898, 78.233, 151.7182), seed);","res.y = random(vec3(63.7264, 10.873, 623.6736), seed);","res.z = random(vec3(125.5736, 34.485, 437.2873), seed);","return res;","}","vec4 chromaticAberration(const in sampler2D tex, const in vec2 uv, const in float factor) {","vec2 dist = uv - 0.5;","vec2 offset = factor * dist * length(dist);","vec4 col;","col.r  = texture2D(tex, uv - offset).r;","col.ga = texture2D(tex, uv).ga;","col.b  = texture2D(tex, uv + offset).b;","return col;","}","float RGBToL(const in vec3 color) {","float fmin = min(min(color.r, color.g), color.b);","float fmax = max(max(color.r, color.g), color.b);","return (fmax + fmin) / 2.0;","}","vec3 colorBalance(const in vec3 color, const in vec3 lrgb, const in vec3 mrgb, const in vec3 hrgb) {","float lightness = RGBToL(color);","lightness = (1.5 * lightness) / (lightness + 0.5);","float a = 0.25;","float b = 0.333;","float scale = 0.7;","vec3 low = lrgb * clamp((lightness - b) / -a + 0.5, 0.0, 1.0);","vec3 mid = mrgb * clamp((lightness - b) / a + 0.5, 0.0, 1.0) * clamp((lightness + b - 1.0) / -a + 0.5, 0.0, 1.0);","vec3 high = hrgb * clamp((lightness + b - 1.0) / a + 0.5, 0.0, 1.0);","vec3 newColor = color + (low + mid + high) * scale;","newColor = clamp(newColor, 0.0, 1.0);","return normalize(newColor) * length(color);","}","void main() {","   vec4 inColorAlpha = texture2D( tDiffuse, texCoord );","   vec3 inColor = inColorAlpha.xyz;","inColor *= pow(2.0,brightness);","#if (USE_AUTO_EXPOSURE > 0)","\tvec2 ae_uv = vec2(0.0);","\tvec2 sums = vec2(0.0);","\tfor(int i = 0;i < USE_AUTO_EXPOSURE;i++){","\t\tae_uv.x = (0.5+float(i))/float(USE_AUTO_EXPOSURE);","\t\tfor(int j = 0;j < USE_AUTO_EXPOSURE;j++){","\t\t\tae_uv.y = (0.5+float(j))/float(USE_AUTO_EXPOSURE);","\t\t\tsums += texture2D(tAutoExposure,ae_uv).rg;","\t\t}","\t}","\tfloat fAuto = 0.2176/exp(sums.x/sums.y);","\tinColor *=fAuto;","#endif","vec2 pos = texCoord - 0.5;","pos.y = pos.y * screenRatio;"," float f2 = focalLength*focalLength;"," float s2 = sensorSize*sensorSize;"," float vignetting = pow(f2/(s2*(pos.x*pos.x+pos.y*pos.y)+f2),power);"," inColor = inColor * vignetting;"," inColorAlpha.a = max(inColorAlpha.a, (1.0-sqrt(vignetting)));","   vec3 outColor;","   #if defined( TONEMAP_REINHARD )","       outColor = inColor / ( 1.0 + inColor );","   #elif defined( TONEMAP_FILMIC )","\t\tvec4 tmpCol = vec4(inColor.xyz, FILMIC_NRE_W);","\t\ttmpCol = ((tmpCol*(FILMIC_NRE_A*tmpCol+FILMIC_NRE_C*FILMIC_NRE_B)+FILMIC_NRE_D*FILMIC_NRE_E)","\t\t/(tmpCol*(FILMIC_NRE_A*tmpCol+FILMIC_NRE_B)+FILMIC_NRE_D*FILMIC_NRE_F))","\t\t-FILMIC_NRE_E/FILMIC_NRE_F;","\t\toutColor = tmpCol.xyz/tmpCol.w;","   #elif defined( TONEMAP_UNCHARTED )","       float ExposureBias = 2.0;","       vec3 curr = Uncharted2Tonemap( ExposureBias * inColor );","       vec3 whiteScale = vec3( 1.0 ) / Uncharted2Tonemap( vec3( W ) );","       vec3 color = curr * whiteScale;","   #elif defined( TONEMAP_PHOTOGRAPHIC )","\t\tvec3 c = inColor.xyz * colorCorrection;","\t\tc *= (c*burnhighlights+1.0)/(c+1.0); ","\t\tc = mix(vec3(luminance_RGB(c)),c,saturation);","\t\tfloat intens = luminance_RGB(c);","\t\tif(intens<1.0){","\t\t\tfloat _crushblacks = 2.0* crushblacks +1.0;","\t\t\tintens = sqrt(intens);","\t\t\tfloat oms2 = 1.0 - intens;"," \t\t\tc.x = c.x*intens + pow(c.x,_crushblacks)*oms2;","\t\t\tc.y = c.y*intens + pow(c.y,_crushblacks)*oms2;"," \t\t\tc.z = c.z*intens + pow(c.z,_crushblacks)*oms2;","\t\t}","\t\toutColor = c;","   #else","       outColor = inColor;","   #endif","#if defined( GAMMA_SIMPLE )","   outColor = sqrt( outColor );","#elif defined( GAMMA_CORRECTION )","\toutColor = pow( outColor, vec3( 1.0 / gamma ) );","#elif defined( SRGB_CORRECTION )","\toutColor.r = (outColor.r < 0.0031308)    ? (outColor.r*12.92) : 1.055*pow(outColor.r,1.0/2.4)-0.055;","\toutColor.g = (outColor.g < 0.0031308)    ? (outColor.g*12.92) : 1.055*pow(outColor.g,1.0/2.4)-0.055;","\toutColor.b = (outColor.b < 0.0031308)    ? (outColor.b*12.92) : 1.055*pow(outColor.b,1.0/2.4)-0.055;","#endif","#if defined( COLOR_GRADING )","\tfloat threshold = (gradingDepth-1.0)/gradingDepth;","\tfloat halfTexelOffset = 0.5/gradingDepth;","\tfloat r = clamp (outColor.r,0.0,1.0) * threshold + halfTexelOffset;","\tfloat g = clamp (outColor.g,0.0,1.0) * threshold + halfTexelOffset;","\tfloat b = clamp (outColor.b,0.0,1.0) *(gradingDepth - 1.0);","   float bFloor = floor(b);","   float bFract = b-bFloor;","\tvec2 uv1 = vec2((bFloor+r)/(gradingDepth),g);","\tvec2 uv2 = vec2((bFloor+1.0+r)/(gradingDepth),g);","\tvec3 c1 = texture2D(gradingMap,uv1).rgb;","\tvec3 c2 = texture2D(gradingMap,uv2).rgb;","\toutColor = bFract*c2+(1.0-bFract)*c1;","\tvec2 uvtest = vec2((15.0+0.5/16.0)/16.0,0.5/16.0);","#endif","   outColor += 2.0 * dither * (Random3D(texCoord.x + texCoord.y) - vec3(0.5));","   gl_FragColor = vec4( outColor, inColorAlpha.a );","}"].join("\n"),vertexShader:["varying vec2 texCoord;","void main() {","   vec4 pos = vec4( sign( position.xy ), 0.0, 1.0 );","   texCoord = pos.xy * vec2( 0.5 ) + 0.5;","   gl_Position = pos;","}"].join("\n")}}),define("Shaders/CompositeShader",["DS/Shaders/CompositeShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/CompositeShader"),e}),define("DS/Visualization/Detector",[],function(){"use strict";return{canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{return!(!window.WebGLRenderingContext||!document.createElement("canvas").getContext("experimental-webgl")&&!document.createElement("canvas").getContext("webgl"))}catch(e){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e;return this.webgl||(e=window.WebGLRenderingContext?'Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />':'Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>',e+='Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'),e}}}),define("Visualization/Detector",["DS/Visualization/Detector","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Detector"),e}),define("DS/VisuDataAccess/Ox4xMQLSelectTaskDefinition",[],function(){"use strict";return function(e,t,i,r){var n=e,a=t;this.boOrRel=r,this.injectRowInto=i;var s=function(e){for(var t="",i=0;i<e.length;i++)t=t+" "+e[i];return t};this.typeRequested=function(){return n},this.attributes=function(){return listOfAttributes},this.marshallAsMQLListOfFetchAttributes=function(){if(null===a.Fetch)throw"no fetch attributes selected";return s(a.Fetch)},this.marshallAsMQLListOfFetchAttributesAsJSON=function(){if(null===a.Fetch)throw"no fetch attributes selected";return JSON.stringify(a.Fetch)},this.hasPathAttrs=function(){return void 0!==a.Path&&null!==a.Path},this.marshallAsMQLListOfPathAttributes=function(){if(null===a.Path)throw"no path attributes selected";return s(a.Path)},this.marshallAsMQLListOfPathAttributesAsJSON=function(){if(null===a.Fetch)throw"no fetch attributes selected";return JSON.stringify(a.Path)}}}),define("VisuDataAccess/Ox4xMQLSelectTaskDefinition",["DS/VisuDataAccess/Ox4xMQLSelectTaskDefinition","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/Ox4xMQLSelectTaskDefinition"),e}),define("DS/VisuDataAccess/Ox4PLMDataHelper",[],function(){"use strict";return function(e){var t=e,i=t.threedexpServiceUri(),r=function(){return"start transaction ;\nget checkout ticket nozip mcsurl %1 \n store %2 \nbusinessobjectproxy physicalid %3 format %4 filename %5 tcl;\nabort transaction ;\n"},n=function(){return'<?xml version="1.0" encoding="utf-8"?>\n<executeSequence xmlns="http://www.3ds.com/xmql/query">\n\t<execute>\n\t\t<function>get_checkout_ticket</function>\n\t\t<version>2.0.0</version>\n\t\t<params>\n\t\t\t<param name="label">checkout</param>\n\t\t\t<param name="zipkw">nozip</param>\n\t\t\t<param name="mcsurl">%1</param>\n\t\t\t<param name="bops">[{"store": "%2", "bops": [{"physicalid": "%3", "format": "%4", "filename": "%5"}]}]</param>\n\t\t</params>\n\t</execute>\n</executeSequence>\n'},a=t.rawmode?r():n();this.transformSelectedFileIntoTicketRequest=function(e,t,i,r){return o(e,i,t,r)},this.transformSelectedSDByRoleAndFormatIntoTicketRequest=function(e,t,i,r,n,a){return 0==t.indexOf("SDv2")?this.transformSelectedSDv2ByRoleAndFormatIntoTicketRequest(e,t,i,r,n,a):0==t.indexOf("SDV0")?this.transformSelectedSDv0ByRoleAndFormatIntoTicketRequest(e,t,i,r,n,a):"E_NOTIMPLEMENTED"},this.transformSelectedSDv0ByRoleAndFormatIntoTicketRequest=function(e,t,i,r,n,a){var o=c(t),h=l(o,i,r,n),u=null;return null!==h&&(u=s(e,h,a)),u},this.transformSelectedSDv2ByRoleAndFormatIntoTicketRequest=function(e,t,i,r,n,a){var o=u(t),c=l(o,i,r,n),h=null;return null!==c&&(h=s(e,c,a)),h};var s=function(e,t,r){var n=e+"_"+t.role+"."+t.format;return void 0!==t.persistancyname&&t.persistancyname.length>0&&(n+="="+t.persistancyname),n+="",a.replace("%1",i).replace("%2",r).replace("%3",e).replace("%4",t.format).replace("%5",n)},o=function(e,t,r,n){return a.replace("%1",i).replace("%2",t).replace("%3",e).replace("%4",r).replace("%5",n)},l=function(e,t,i,r){for(var n=0;n<r.length;n++)for(var a=r[n],s=0;s<e.length;s++){var o=e[s];if(o.role==i&&o.format==a&&o.latetype==t)return o}return null},c=function(e){for(var t,i=/[^:]+/g,r=-1,n=[];null!==(t=i.exec(e));){var a=h(t[0]);n.push(a),i.lastIndex===r&&(isILinenfiniteLoop=!0),r=i.lastIndex}return n},h=function(e){return function(e,t){var i,r=/[^,]+/g,n=-1,a=0,s=new Object;for(s.sdtype=e;null!==(i=r.exec(t));)0===a?s.format=i[0]:1===a?s.role=i[0]:2===a?s.latetype=i[0]:3===a&&(s.watermarkstamp=i[0]),a+=1,r.lastIndex===n&&(isILinenfiniteLoop=!0),n=r.lastIndex;return s}(e.slice(3,4),e.slice(5,e.length-1))};var u=function(e){for(var t,i=/[^:]+/g,r=-1,n=[];null!==(t=i.exec(e));){var a=d(t[0]);n.push(a),i.lastIndex===r&&(isILinenfiniteLoop=!0),r=i.lastIndex}return n},d=function(e){return function(e,t){var i,r=/[^,]+/g,n=-1,a=0,s=new Object;for(s.sdtype=e;null!==(i=r.exec(t));)0===a?s.format=i[0]:1===a?s.role=i[0]:2===a?s.latetype=i[0]:3===a?s.watermarkstamp=i[0]:4===a?s.synchrostamp=i[0]:5===a?s.persistancytype=i[0].replace(/[']+/g,""):6===a&&(s.persistancyname=i[0].replace(/[']+/g,"")),a+=1,r.lastIndex===n&&(isILinenfiniteLoop=!0),n=r.lastIndex;return s}(e.slice(3,4),e.slice(5,e.length-1))}}}),define("VisuDataAccess/Ox4PLMDataHelper",["DS/VisuDataAccess/Ox4PLMDataHelper","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/Ox4PLMDataHelper"),e});var _shaderChunkBase="DS/Shaders/";for(_toLoad=["LineDSShaders","ScenegraphShaders","PDSFXShaders","PhongShaders","LambertShaders","ShadowingShaders","FogShaders","LowLightShaders","ClipShaders","MappingShaders","EnvMapShaders","AlphaShaders","ColorShaders","VerticeShaders"],i=0;i<_toLoad.length;i++)_toLoad[i]=_shaderChunkBase+_toLoad[i];define("DS/Visualization/ShaderChunk",_toLoad,function(e,t,i,r,n,a,s,o,l,c,h,u,d,p){"use strict";var f={Default_uniforms_declaration:["#ifdef GLSL300ES","uniform FrameUBO {","mat4 viewMatrix;","mat4 projectionMatrix;","vec3 cameraPosition;","};","#else","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform vec3 cameraPosition;","#endif","uniform mat4 _modelMatrixForDoubleGPU;","mat4 modelMatrix;","vec3 lowPartModelTranslation;","#if defined(MODELVIEW_CPU)","uniform mat4 modelViewMatrix;","#elif defined(USE_TANGENT_BINORMAL) && defined(MAPPING_OPERATOR)","varying mat4 modelViewMatrix;","#else","mat4 modelViewMatrix;","#endif",""].join("\n"),normalMatrix_uniforms_declaration:["#ifdef USE_NORMAL_MATRIX","bool use_normal_matrix = true;","uniform mat3 normalMatrix;","#else","bool use_normal_matrix = false;","mat3 normalMatrix;","#endif"].join("\n"),double_emulation_utilities:["// http://andrewthall.org/papers/df64_qf128.pdf","vec2 quickTwoSum(float a, float b) {","    float s = a + b;","    float e = b - (s-a);","    return vec2(s,e);","}","","vec4 twoSumComp(vec2 a, vec2 b) {","    vec2 s = a + b;","    vec2 v = s - a;","    vec2 e = (a - (s-v)) + (b-v);","    return vec4(s.x,e.x,s.y,e.y);","}","","vec2 df64_add(vec2 a, vec2 b) {","    vec4 st = twoSumComp(a,b);","    st.y += st.z;","    st.xy = quickTwoSum(st.x,st.y);","    st.y += st.w;","    return  quickTwoSum(st.x,st.y);","}","","vec3 _computeModelPosition(in vec3 position, in vec3 cameraPos, in vec3 lowPartCameraPos, in mat4 matrix, in vec3 lowPartTranslation) {","   vec2 Tmx = vec2(matrix[3][0],lowPartTranslation.x);","   vec2 Tmy = vec2(matrix[3][1],lowPartTranslation.y);","   vec2 Tmz = vec2(matrix[3][2],lowPartTranslation.z);","   vec2 Tcx = -vec2(cameraPos.x,lowPartCameraPos.x);","   vec2 Tcy = -vec2(cameraPos.y,lowPartCameraPos.y);","   vec2 Tcz = -vec2(cameraPos.z,lowPartCameraPos.z);","   vec2 Tx = df64_add(Tmx, Tcx);","   vec2 Ty = df64_add(Tmy, Tcy);","   vec2 Tz = df64_add(Tmz, Tcz);","   vec4 worldPos = matrix * vec4(position.xyz,0.0);","   return worldPos.xyz + vec3(Tx.x, Ty.x, Tz.x);","}","vec3 _computeModelViewPosition(in vec3 position, in vec3 cameraPos, in vec3 lowPartCameraPos, in mat4 matrix, in vec3 lowPartTranslation, in mat4 viewMatrix) {","   return (viewMatrix * vec4(_computeModelPosition(position, cameraPos, lowPartCameraPos, matrix, lowPartTranslation), 0.0)).xyz;","}"].join("\n"),double_emulation_vertex:["uniform vec3 lowPartCameraPosition;","vec4 computeModelViewPosition(in vec4 position) {","#if defined(MODELVIEW_CPU)","return modelViewMatrix * position;","#else","return vec4(_computeModelViewPosition(position.xyz,cameraPosition,lowPartCameraPosition, modelMatrix, lowPartModelTranslation, viewMatrix),1.0);","#endif","}","vec4 computeModelViewPosition(in vec3 position) {","return computeModelViewPosition(vec4(position, 1.0));","}","vec4 computeModelViewDirection(in vec3 direction) {","return modelViewMatrix * vec4(direction, 0.0);","}","vec4 computeModelViewPositionCustom(in vec4 position, in mat4 matrix, in vec3 lowPartTranslation) {","   return vec4(_computeModelViewPosition(position.xyz,cameraPosition,lowPartCameraPosition, matrix, lowPartTranslation, viewMatrix),1.0);","}","vec4 computeModelViewPositionCustom(in vec3 position, in mat4 matrix, in vec3 lowPartTranslation) {","   return vec4(_computeModelViewPosition(position.xyz,cameraPosition,lowPartCameraPosition, matrix, lowPartTranslation, viewMatrix),1.0);","}","vec4 computeModelViewDirectionCustom(in vec3 direction, in mat4 matrix) {","return viewMatrix * (matrix * vec4(direction, 0.0));","}","#if defined(USE_SHADOWMAP) && !defined(DECAL)","vec4 computeShadowCoord(in vec3 position,in mat4 shadowMat,in vec3 shadowCameraPos, in vec3 lowPartShadowCameraPos) {","   vec4 worldPos = vec4(_computeModelPosition(position,shadowCameraPos,lowPartShadowCameraPos, modelMatrix, lowPartModelTranslation),1.0);","   return shadowMat * worldPos;","}","#endif"].join("\n"),double_emulation_fragment:["#if defined(USE_SHADOWMAP) && defined(DECAL)","vec4 computeShadowCoord(in vec3 position,in mat4 shadowMat,in vec3 shadowCameraPos, in vec3 lowPartShadowCameraPos) {","   vec4 worldPos = vec4(_computeModelPosition(position,shadowCameraPos,lowPartShadowCameraPos, modelMatrix, lowPartModelTranslation),1.0);","   return shadowMat * worldPos;","}","#endif"].join("\n"),bumpmap_pars_fragment:["#if defined(USE_BUMPMAP) && !defined(DSPBR)","uniform sampler2D bumpMap;","uniform float bumpScale;","#ifndef SPECGLOSS","vec2 dHdxy_fwd() {","vec2 dSTdx = dFdx( vUv );","vec2 dSTdy = dFdy( vUv );","float Hll = bumpScale * texture2D( bumpMap, vUv ).x;","float dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;","float dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;","return vec2( dBx, dBy );","}","#endif","vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {","vec3 vSigmaX = dFdx( surf_pos );","vec3 vSigmaY = dFdy( surf_pos );","vec3 vN = surf_norm;","vec3 R1 = cross( vSigmaY, vN );","vec3 R2 = cross( vN, vSigmaX );","float fDet = dot( vSigmaX, R1 );","vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );","return normalize( abs( fDet ) * surf_norm - vGrad );","}","#endif"].join("\n"),normalmap_pars_fragment:["#ifdef USE_NORMALMAP","uniform sampler2D normalMap;","#ifndef DSPBR","uniform vec2 normalScale;","#ifndef SPECGLOSS","vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {","vec3 q0 = dFdx( eye_pos.xyz );","vec3 q1 = dFdy( eye_pos.xyz );","vec2 st0 = dFdx( uvToUse.st );","vec2 st1 = dFdy( uvToUse.st );","float alphaT = step(0.00001, abs(st0.y) + abs(st1.y));","float alphaB = step(0.00001, abs(st0.x) + abs(st1.x));","float alphaBT = 1.0 - max(alphaB, alphaT);","st0.y = alphaT * st0.y - (1.0 - alphaT)*(alphaB * st1.x);","st1.y = alphaT * st1.y + (1.0 - alphaT)*(alphaB * st0.x) + alphaBT;","st0.x = alphaB * st0.x - (1.0 - alphaB)*(alphaT * st1.y) + alphaBT;","st1.x = alphaB * st1.x + (1.0 - alphaB)*(alphaT * st0.y);","vec3 S = normalize(  q0 * st1.t - q1 * st0.t );","vec3 T = normalize( -q0 * st1.s + q1 * st0.s );","vec3 N = normalize( surf_norm );","vec3 mapN = texture2D( normalMap, uvToUse ).xyz * 2.0 - 1.0;","mapN.xy = normalScale * mapN.xy;","#ifdef NORMALFLIPY","mapN.y = - mapN.y;","#endif","mat3 tsn = mat3( S, T, N );","return normalize( tsn * mapN );","}","#endif","#endif","#endif"].join("\n"),specularmap_pars_fragment:["#ifdef USE_SPECULARMAP","uniform sampler2D specularMap;","#endif"].join("\n"),specularmap_fragment:["float specularStrength;","#ifdef USE_SPECULARMAP","vec2 specularUV=uvToUse;","vec4 texelSpecular = texture2D( specularMap, specularUV );","specularStrength = texelSpecular.r;","#ifdef PHONG","if (shininessInSpecMap) {","shininessValue = texelSpecular.a;","}","#endif","#else","specularStrength = 1.0;","#endif"].join("\n"),large_scale_VS:["","modelMatrix = mat4(_modelMatrixForDoubleGPU);","lowPartModelTranslation = vec3(modelMatrix[0][3],modelMatrix[1][3],modelMatrix[2][3]);","modelMatrix[0][3] = 0.0;","modelMatrix[1][3] = 0.0;","modelMatrix[2][3] = 0.0;","#if !defined(MODELVIEW_CPU)","modelViewMatrix = viewMatrix*modelMatrix;","#endif",""].join("\n"),large_scale_FS:["","modelMatrix = mat4(_modelMatrixForDoubleGPU);","lowPartModelTranslation = vec3(modelMatrix[0][3],modelMatrix[1][3],modelMatrix[2][3]);","modelMatrix[0][3] = 0.0;","modelMatrix[1][3] = 0.0;","modelMatrix[2][3] = 0.0;",""].join("\n"),rgba_packing_pars:["float unpackRGBA( const in vec4 rgba ) {","const vec4 bit_shift = vec4( 1.0 / ( 255.0 * 255.0 * 255.0 ), 1.0 / ( 255.0 * 255.0 ), 1.0 / 255.0, 1.0 );","#ifdef MOBILE_DEVICE_MODE","float unpack = dot( floor(255.0 * rgba + 0.5) / 255.0, bit_shift );","#else","float unpack = dot( rgba, bit_shift );","#endif","return unpack;","}","float unpackRGB( const in vec3 rgb ) {","const vec3 bit_shift = vec3(1.0 / ( 255.0 * 255.0 ), 1.0 / 255.0, 1.0 );","#ifdef MOBILE_DEVICE_MODE","float unpack = dot( floor(255.0 * rgb + 0.5) / 255.0, bit_shift );","#else","float unpack = dot( rgb, bit_shift );","#endif","return unpack;","}","vec4 packRGBA( const in float value ) {","const vec4 bit_shift = vec4( 255.0 * 255.0 * 255.0, 255.0 * 255.0, 255.0, 1.0 );","const vec4 bit_mask  = vec4( 0.0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0 );","vec4 res = value * bit_shift;","res -= floor(res);","res -= res.xxyz * bit_mask;","return res;","}","vec3 packRGB( const in float value ) {","const vec3 bit_shift = vec3(255.0 * 255.0, 255.0, 1.0 );","const vec3 bit_mask  = vec3( 0.0, 1.0 / 255.0, 1.0 / 255.0 );","vec3 res = value * bit_shift;","res -= floor(res);","res -= res.xxy * bit_mask;","return res;","}"].join("\n")};return Object.assign(f,e.LineShaders),Object.assign(f,t),Object.assign(f,i),Object.assign(f,r),Object.assign(f,n),Object.assign(f,a),Object.assign(f,s),Object.assign(f,o),Object.assign(f,l),Object.assign(f,c),Object.assign(f,h),Object.assign(f,u),Object.assign(f,d),Object.assign(f,p),f}),define("DS/SWXCoreManipulation/xAppControlPreferencesPanel",["UWA/Core","UWA/Class","i18n!SWXCoreManipulation/assets/nls/xAppControlPreferencesPanel","css!SWXCoreManipulation/xAppControlPreferencesPanel"],function(e,t,i){"use strict";var r=t.extend({_profile:0,_resources:i.get("MouseControlPreferences"),init:function(){Object.defineProperty(this,"profile",{get(){return this._profile},set(e){this._profile=e}}),Object.defineProperty(this,"resources",{get(){return this._resources}})},_cleanup:function(){this._dialog&&(this._dialog.immersiveFrame.destroy(),this._dialog.destroy()),this._dialog=null},show:function(){if(this._dialog)return Promise.reject(new Error("xAppMouseControlPreferences.show() - Dialog already displayed."));var t=this;return new Promise(i=>{require(["DS/Windows/ImmersiveFrame","DS/Windows/Dialog","DS/Controls/Toggle","DS/Controls/ButtonGroup","DS/Controls/Button","DS/Controls/Popup"],function(r,n,a,s,o,l){let c=new r({});c.inject(document.body);let h=e.createElement("div",{class:"visu-preferences-dialog-content"}),u=e.createElement("div",{class:"visu-preferences-profiles-title"}).inject(h);e.createElement("h5").inject(u).innerText=t.resources.Profiles.Title;let d=new l({target:e.createElement("div",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-info help-icon"}).inject(u),trigger:"hover",arrowBoxFlag:!0,position:"bottom",alignment:"center",offset:{x:0,y:3}}),p=e.createElement("div",{class:"visu-preferences-popup-content"});e.createElement("p",{class:"visu-preferences-profiles-information"}).inject(p).innerText=t.resources.Information.Description,d.setBody(p),e.createElement("p",{class:"visu-preferences-profiles-description"}).inject(h).innerText=t.resources.Profiles.Description_part_1;let f=new s({id:"GroupButtonMouseProfile",type:"radio"});["3DEXPERIENCE","CATIA","SOLIDWORKS"].forEach((e,i)=>f.addChild(new a({type:"radio",label:t.resources.Profiles[e],value:i}))),f.selectValue(t.profile),f.inject(h),e.createElement("p",{class:"visu-preferences-profiles-description"}).inject(h).innerText=t.resources.Profiles.Description_part_2,e.createElement("p",{class:"visu-preferences-profiles-description"}).inject(h).innerText=t.resources.Profiles.Description_part_3,t._dialog=new n({immersiveFrame:c,modalFlag:!0,title:t.resources.Title,content:h,closeButtonFlag:!0,minWidth:285,width:285,visibleFlag:!0,buttons:{Ok:new o({onClick:async()=>{t._validated=!0,t.profile="array"===e.typeOf(f.value)?f.value[0]:f.value,t._dialog.close()}})}}),t._dialog.addEventListener("close",()=>{t._cleanup(),i(t._validated?t.profile:-1)})})})},close:function(){this._dialog&&this._dialog.close()}});return e.namespace("DS/SWXCoreManipulation/xAppControlPreferencesPanel",r)}),define("DS/Plugins/UserPass",["UWA/Class"],function(e){"use strict";var t=0;return e.extend({init:function(e){this.id=t++,this.manager=e.manager,this.name=e.name,this.renderList=e.renderList,this.enabled=!0,this._passes=[],this._inserted=!1,this._cameraName=null},enable:function(e){var t;for(this.enabled=!!e,t=0;t<this._passes.length;t++)this._passes[t].disabledByDefault=!this.enabled;this.manager._getMainComposer().enableCustomPassNEW(this._passes)},_setupPasses:function(){var e;for(e=0;e<this._passes.length-1;e++)this._passes[e].userPass=this},_setCameraName:function(e){this._cameraName=e}})}),define("DS/VisuIdentification/Pattern",["UWA/Class"],function(e){"use strict";var t=e.extend({init:function(e,t,i){return this.space=e,this.context=t,this.shared=i,this},getSpace:function(){return this.space},getContext:function(){return this.context},getSharability:function(){return this.shared},setSpace:function(e){this.space=e},setContext:function(e){this.context=e},setSharability:function(e){this.shared=e},copy:function(e){return this.space=e.space,this.context=e.context,this.shared=e.shared,this},isEqual:function(e){return this.space===e.space&&this.context===e.context&&this.shared===e.shared}});return UWA.namespace("THREEDS/Identification/Pattern",t)}),"object"==typeof exports&&this==exports&&(module.exports=EasySAXParser);var StringArrayReader=function(e){this.nbChunks=e.length,this.strArray=e,this.chunkSize=this.nbChunks>0?e[0].length:0,this.log=""};function EasySAXParser(){if(!this)return null;function e(){}var t,i,r,n,a,s,o,l,c=e,h=e,u=e,d=e,p=e,f=!1,m={xmlns:void 0},g=!1;this.on=function(o,l){if("function"==typeof l||null===l)switch(o){case"error":p=l||e;break;case"startNode":h=l||e;break;case"endNode":u=l||e;break;case"textNode":c=l||e;break;case"cdata":d=l||e;break;case"comment":t=l,n=!!l;break;case"question":i=l,a=!!l;break;case"attention":r=l,s=!!l}},this.ns=function(e,t){if(e&&"string"==typeof e&&t){var i,r,n,a={};for(n in t)"string"==typeof(r=t[n])&&(e===r&&(i=!0),a[n]=r);i&&(f=!0,l=e,o=a)}},this.parse=function(e){"string"==typeof e&&(e=[e]),e=new StringArrayReader(e),f?(m={xmlns:l},C(e),m=!1):C(e),y=!0,console.log(e.log)};var v={constructor:!1,hasOwnProperty:!1,isPrototypeOf:!1,propertyIsEnumerable:!1,toLocaleString:!1,toString:!1,valueOf:!1,quot:'"',QUOT:'"',amp:"&",AMP:"&",nbsp:"Â ",apos:"'",lt:"<",LT:"<",gt:">",GT:">",copy:"Â©",laquo:"Â«",raquo:"Â»",reg:"Â®",deg:"Â°",plusmn:"Â±",sup2:"Â²",sup3:"Â³",micro:"Âµ",para:"Â¶"};function S(e,t,i,r){return r?v[r]||"":t?String.fromCharCode(t):String.fromCharCode(parseInt(i,16))}function _(e,t){return(e=String(e)).length>3&&-1!==e.indexOf("&")&&(-1!==e.indexOf("&gt;")&&(e=e.replace(/&gt;/g,">")),-1!==e.indexOf("&lt;")&&(e=e.replace(/&lt;/g,"<")),-1!==e.indexOf("&quot;")&&(e=e.replace(/&quot;/g,'"')),-1!==e.indexOf("&")&&(e=e.replace(/&#(\d+);|&#x([0123456789abcdef]+);|&(\w+);/gi,S))),e}var y,x="",M=0;function P(){if(null!==y)return y;var e,t,i,r,n,a,s,l,c={},h=x,u=M,d=h.length,p=!!g&&[],v="",S=!1;e:for(;u<d;u++)if(!(32===(i=h.charCodeAt(u))||i<14&&i>8)){if(i<65||i>122||i>90&&i<97)return y=!1;for(t=u+1;t<d;t++)if(!((i=h.charCodeAt(t))>96&&i<123||i>64&&i<91||i>47&&i<59||45===i||95===i)){for(var P=t;32===i;)i=h.charCodeAt(++P);if(61!==i)return y=!1;break}if(e=h.substring(u,t),t=P,S=!0,"xmlns:xmlns"===e)return y=!1;for(i=h.charCodeAt(t+1);32==i;)i=h.charCodeAt(++t+1);if(34===i)t=h.indexOf('"',u=t+2);else{if(39!==i)return y=!1;t=h.indexOf("'",u=t+2)}if(-1===t)return y=!1;if(t+1<d&&((i=h.charCodeAt(t+1))>32||i<9||i<32&&i>13))return y=!1;if(v=h.substring(u,t),u=t+1,f){if(g){if(l="xmlns"===e?"xmlns":120===e.charCodeAt(0)&&"xmlns:"===e.substr(0,6)&&e.substr(6)){if(s=o[_(v)]){if(m[l]!==s){if(!a){for(n in a=!0,r={},m)r[n]=m[n];m=r}m[l]=s}}else if(m[l]){if(!a){for(n in a=!0,r={},m)r[n]=m[n];m=r}m[l]=!1}c[e]=v;continue}p.push(e,v);continue}for(i=e.length;--i;)if(58===e.charCodeAt(i)){(i=m[e.substring(0,i)])&&(c[i+e.substr(i)]=v);continue e}}c[e]=v}if(!S)return y=!0;if(g)e:for(u=0,d=p.length;u<d;u++){for(i=(e=p[u++]).length;--i;)if(58===e.charCodeAt(i)){(i=m[e.substring(0,i)])&&(c[i+e.substr(i)]=p[u]);continue e}c[e]=p[u]}return y=c}function C(e){var o,l,v,S,C,b,D,w,E=[],T=[],A=!1,I=!1,R=0,L=0,O=0;function N(){return e.substring(L,R+1)}for(;-1!==R;){if(D=O>0,-1===(L=60===e.charCodeAt(R)?R:e.indexOf("<",R)))return E.length?void p("end file"):void 0;if(R!==L&&!D&&!1===c(e.substring(R,L),_))return;if(33!==(C=e.charCodeAt(L+1)))if(63!==C){if(-1==(R=e.indexOf(">",L+1)))return void p("...>");if(y=!0,47===C){if(I=!1,A=!0,l=o=E.pop(),S=L+2+l.length,e.substring(L+2,S)!==l)return void p("close tagname");for(;S<R;S++)if(!(32===(C=e.charCodeAt(S))||C>8&&C<14))return void p("close tag")}else{if(47===e.charCodeAt(R-1)?(l=o=e.substring(L+1,R-1),I=!0,A=!0):(l=o=e.substring(L+1,R),I=!0,A=!1),!(C>96&&C<123||C>64&&C<91))return void p("first char nodeName");for(S=1,v=l.length;S<v;S++)if(!((C=l.charCodeAt(S))>96&&C<123||C>64&&C<91||C>47&&C<59||45===C||95===C)){if(32===C||C<14&&C>8){o=l.substring(0,S),y=null;break}return void p("invalid nodeName")}A||E.push(o)}if(f){if(D){A?I||0==--O&&(m=T.pop()):O+=1,R+=1;continue}if(w=m,A||(T.push(m),!0!==y&&(g=-1!==l.indexOf("xmlns",S))&&(x=l,M=S,P(),g=!1)),-1!==(C=o.indexOf(":"))?(b=m[o.substring(0,C)],o=o.substr(C+1)):b=m.xmlns,!b){A?m=I?w:T.pop():(O=1,y=!0),R+=1;continue}o=b+":"+o}if(I){if(x=l,M=S,!1===h(o,P,_,A,N))return;y=!0}if(A){if(!1===u(o,_,I,N))return;f&&(m=I?w:T.pop())}R+=1}else{if(-1===(R=e.indexOf("?>",L)))return void p("...?>");if(a&&!1===i(e.substring(L,R+2)))return;R+=2}else{if(91===(C=e.charCodeAt(L+2))&&"CDATA["===e.substr(L+3,6)){if(-1===(R=e.indexOf("]]>",L)))return void p("cdata");if(!D&&!1===d(e.substring(L+9,R),!1))return;R+=3;continue}if(45===C&&45===e.charCodeAt(L+3)){if(-1===(R=e.indexOf("--\x3e",L)))return void p("expected --\x3e");if(n&&!D&&!1===t(e.substring(L+4,R),_))return;R+=3;continue}if(-1===(R=e.indexOf(">",L+1)))return void p('expected ">"');if(s&&!D&&!1===r(e.substring(L,R+1),_))return;R+=1}}}}StringArrayReader.prototype.getStringIndexFromIndex=function(e){return Math.floor(e/this.chunkSize)},StringArrayReader.prototype.getLocalIndex=function(e){return e%this.chunkSize},StringArrayReader.prototype.indexOf=function(e,t){if(1===this.nbChunks)return this.strArray[0].indexOf(e,t);for(var i=this.getStringIndexFromIndex(t),r=this.getLocalIndex(t),n=i*this.chunkSize,a=this.strArray[i].indexOf(e,r);-1===a&&i<this.nbChunks-1;)n+=this.chunkSize,a=this.strArray[i+1].indexOf(e,0),i++;return-1!==a?n+a:a},StringArrayReader.prototype.substring=function(e,t){if(1===this.nbChunks)return this.strArray[0].substring(e,t);var i=this.getStringIndexFromIndex(e),r=this.getStringIndexFromIndex(t-1),n=this.getLocalIndex(e);if(i===r)return this.strArray[i].substring(n,this.getLocalIndex(t));var a=this.strArray[i].substring(n),s=t-e,o=this.chunkSize-n;for(i++;i<r;)a+=this.strArray[i],o+=this.strArray[i].length,i++;var l=s-o;return a+=this.strArray[r].substring(0,l)},StringArrayReader.prototype.charCodeAt=function(e){if(1===this.nbChunks)return this.strArray[0].charCodeAt(e);var t=this.getStringIndexFromIndex(e),i=this.getLocalIndex(e);return this.strArray[t].charCodeAt(i)},StringArrayReader.prototype.substr=function(e,t){if(1===this.nbChunks)return this.strArray[0].substr(e,t);var i=this.getStringIndexFromIndex(e),r=this.getLocalIndex(e);if(r+t<=this.chunkSize)return this.strArray[i].substr(r,t);var n=t-(this.chunkSize-r);return this.strArray[i].substr(localId1)+this.strArray[id2].substr(0,n)},define("DS/EasySax/EasySax",function(){return EasySAXParser}),define("EasySax/EasySax",["DS/EasySax/EasySax","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("EasySax/EasySax"),e}),define("DS/Mesh/ThreeJS_Base",[],function(){"use strict";var e=e||{REVISION:"57"};e.extend=function(e,t){if(Object.keys)for(var i=Object.keys(t),r=0,n=i.length;r<n;r++){var a=i[r];Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}else{var s={}.hasOwnProperty;for(var a in t)s.call(t,a)&&(e[a]=t[a])}return e},String.prototype.hashCode=function(){var e,t=0;if(0===this.length)return t;for(e=0;e<this.length;e++)t=(t<<5)-t+this.charCodeAt(e),t|=0;return t},e.SplitTrimStickString=function(e){return e.split("\n").map(e=>e.trim()).filter(e=>e.length>0&&!e.startsWith("//")).join("\n")},String.prototype.includes||(String.prototype.includes=function(e,t){return"number"!=typeof t&&(t=0),!(t+e.length>this.length)&&-1!==this.indexOf(e,t)}),Array.prototype.findLastIndex||Object.defineProperty(Array.prototype,"findLastIndex",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');if("function"!=typeof e)throw new TypeError("predicate must be a function");return Array.from(this).reverse().findIndex(e)},configurable:!0,writable:!0}),Uint32Array.prototype.slice||Object.defineProperty(Uint32Array.prototype,"slice",{value:function(e,t){return new Uint32Array(Array.prototype.slice.call(this,e,t))}}),Float32Array.prototype.slice||Object.defineProperty(Float32Array.prototype,"slice",{value:function(e,t){return new Float32Array(Array.prototype.slice.call(this,e,t))}}),"function"!=typeof Object.values&&Object.defineProperty(Object,"values",{value:function(e){var t=[];for(var i in e)e.hasOwnProperty(i)&&t.push(e[i]);return t},writable:!0,configurable:!0}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(e),r=1;r<arguments.length;r++){var n=arguments[r];if(null!=n)for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(i[a]=n[a])}return i},writable:!0,configurable:!0}),Array.prototype.fill||Object.defineProperty(Array.prototype,"fill",{value:function(e){if(null==this)throw new TypeError("this is null or not defined");for(var t=Object(this),i=t.length>>>0,r=arguments[1]>>0,n=r<0?Math.max(i+r,0):Math.min(r,i),a=arguments[2],s=void 0===a?i:a>>0,o=s<0?Math.max(i+s,0):Math.min(s,i);n<o;)t[n]=e,n++;return t}}),Float32Array.prototype.fill||(Float32Array.prototype.fill=Array.prototype.fill),Uint32Array.prototype.fill||(Uint32Array.prototype.fill=Array.prototype.fill),e.getWebVisualizationLevel=function(){return 425},e.getWebVisualizationFDLevel=function(){return 1},e._webglPerformanceProfile=function(){return"true"===localStorage.getItem("__WEBVISU_USE_HIGHPERFORMANCE_PROFILE__")?"high-performance":"default"},e.GeomTypeEnum={EDGE:1,WIRE_EDGE:2,BOUNDARY_EDGE:4,SHARP_EDGE:8,SMOOTH_EDGE:16,HIDDEN_SEAM_EDGE:32,BOUNDARY_POINT:64,SHARP_POINT:128,SMOOTH_POINT:256,SURFACIC_POINT:512,FREE_POINT:1024,HIDDEN_SEAM_POINT:2048,INFINITE_FACE:4096,FACE:8192,UNKNOWN:16384,_OUTLINE:32768,_SECTION_LINE:65536,AXIS_SYSTEM:1<<17,UNKNOWN_2D:1<<18,UNKNOWN_1D:1<<19,UNKNOWN_0D:1<<20},e.AllGeomTypesMask=2097151,e._VisuFilterType={GAS_INHERIT:0,POLYGON_OFFSET:1,ZMODE:2,GEOM_TYPE:3,DO_NOT_PICK_UNDER:4,LOOK:5,_STATIC_GEOM_TYPE:6,FURTIVE:7,_MATERIAL_TO_USE:8},e.FixedSizeFiltering={Include:0,Exclude:1,CenterOnly:2},e.PriorityMode={ClassicPriority:0,SceneGraphOrder:1,Advanced:2,DepthPriority:3,ClassicPriority2D:4},e.AlphaTestMode={DISCARD:0,DISCARD_OR_OPAQUE:1},e.FilterMode={Replace:0,Cumulative:1,None:2,V4Master:3},e.PolygonOffsetForceStatus={DEFAULT:0,ENABLED:1,DISABLED:2},e.TextureBlendOperations={DECAL:0,MODULATE:1,BLEND:2,REPLACE:3,IGNORE:4,KEEP_DEFAULT:5},e.AnchorPoint={BOTTOM_LEFT:0,BOTTOM_CENTER:1,BOTTOM_RIGHT:2,BASE_LEFT:3,BASE_CENTER:4,BASE_RIGHT:5,TOP_LEFT:6,TOP_CENTER:7,TOP_RIGHT:8},e.MappingType={DISABLED:-1,NONE:0,PLANAR:1,SPHERICAL:2,CUBIC:3,FINITE_CYLINDRICAL:4,INFINITE_CYLINDRICAL:5,SPHERICAL_NORMALIZED:6,INFINITE_CYLINDRICAL_NORMALIZED:7,INFINITE_CYLINDRICAL_NORM_ANGLE_PRES:8},e.MappingTransformSemantic={DEFAULT:1,SEPARATE_TRANSLATION:2,ROTATION_AROUND_CENTER:3},e._BinaryPrimitives=!1,e.IsIE11=null!=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),e.isIOS=function(){return/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1},e.isAndroid=function(){return navigator.userAgent.match(/(Android)/i)},e.isMacOS=function(){return!e.isIOS()&&navigator.platform.toUpperCase().indexOf("MAC")>=0},e.isAppleDevice=function(){return e.isIOS()||e.isMacOS()},e.isMobile=function(){return e.isIOS()||e.isAndroid()},e.__unrolledHighlight=function(){return e.isAppleDevice()};var t=["LARGE_SCALE","NON_UNIFORM_SCALE","OIT","COMPRESSED_VERTICES","COMPRESSED_UVS","COMPRESSED_COLORS","COMPRESSED_NORMALS","FIXED_SIZE","FIXED_SIZE_CENTER","BILLBOARD","LIGHT_MAP","POLITE_HIGHLIGHT","PRIMITIVE_HIGHLIGHT","ADJACENCE_HIGHLIGHT","NOZ_OBJECT","DECALS","MAPPING_OPERATOR","MAPPING_OPERATOR_VERTEX","SKIP_TRANSPAR","SKINNING","SKINNING_INSTANCING","VERTEX_COLORS"];if(t.length>24)throw"too many program ids";for(var i,r,n,a,s,o=new Object,l=0;l<t.length;l++)o[t[l]]=1<<l+6;e.ProgramIDs=o,e.AssetSource={MANUAL:0,MATERIAL_MANAGER:1},e.__visibleInCurrentSpaceSimple=function(e,t,i,r){var n=!0;if(!(n=t?e:i?e:!e)&&r&&r.layers)for(var a=r&&r.layers,s=0;s<a.length;s++){var o=a[s].drawableInterval;if(o&&!o.skip(null,null)&&o.gas&&o.gas.isGAS&&(!o.gas._show||o.gas._showFree))return!0}return n},e.__visibleInCurrentSpace=function(t,i,r,n,a){var s=e.__visibleInCurrentSpaceSimple(t,i,r,n);return a&&a._isFurtiveFiltered()&&(s=!1),s},e.setValuesToObject=function(t,i,r){if(i)for(var n in i){var a=i[n];if(void 0!==a&&!r.has(n)&&n in t){var s=t[n];s instanceof e.Color&&a instanceof e.Color?s.copy(a):s instanceof e.Color?s.set(a):s instanceof e.Vector3&&a instanceof e.Vector3?s.copy(a):s instanceof e.Vector2&&a instanceof e.Vector2?s.copy(a):s instanceof Float32Array&&a instanceof Float32Array?t[n]=new Float32Array(a):t[n]=a}}},e.EventDispatcher=function(){var e={};this.addEventListener=function(t,i){void 0===e[t]&&(e[t]=[]),-1===e[t].indexOf(i)&&e[t].push(i)},this.removeEventListener=function(t,i){var r=e[t].indexOf(i);-1!==r&&(e[t][r]=null)},this.dispatchEvent=function(t){var i=e[t.type];if(void 0!==i){t.target=this;for(var r=!1,n=0,a=i.length;n<a;n++)i[n]?i[n].call(this,t):r=!0;if(r){var s=[];for(n=0,a=i.length;n<a;n++)i[n]&&s.push(i[n]);e[t.type]=s}}}},e.VisualizationTraces={_traces:[],info:function(e){var t=new Error,i=e+" - "+(t.stack?t.stack.split("\n")[2]:"");this._traces.push(i)},displayInfo:function(){console.log(this._traces)}},e.Quaternion=function(e,t,i,r){this.x=e||0,this.y=t||0,this.z=i||0,this.w=void 0!==r?r:1},e.Quaternion.prototype={constructor:e.Quaternion,set:function(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},createJSON:function(){return{x:this.x,y:this.y,z:this.z,w:this.w}},setFromJSON:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},setFromEuler:function(e,t){var i=Math.cos(e.x/2),r=Math.cos(e.y/2),n=Math.cos(e.z/2),a=Math.sin(e.x/2),s=Math.sin(e.y/2),o=Math.sin(e.z/2);return void 0===t||"XYZ"===t?(this.x=a*r*n+i*s*o,this.y=i*s*n-a*r*o,this.z=i*r*o+a*s*n,this.w=i*r*n-a*s*o):"YXZ"===t?(this.x=a*r*n+i*s*o,this.y=i*s*n-a*r*o,this.z=i*r*o-a*s*n,this.w=i*r*n+a*s*o):"ZXY"===t?(this.x=a*r*n-i*s*o,this.y=i*s*n+a*r*o,this.z=i*r*o+a*s*n,this.w=i*r*n-a*s*o):"ZYX"===t?(this.x=a*r*n-i*s*o,this.y=i*s*n+a*r*o,this.z=i*r*o-a*s*n,this.w=i*r*n+a*s*o):"YZX"===t?(this.x=a*r*n+i*s*o,this.y=i*s*n+a*r*o,this.z=i*r*o-a*s*n,this.w=i*r*n-a*s*o):"XZY"===t&&(this.x=a*r*n-i*s*o,this.y=i*s*n-a*r*o,this.z=i*r*o+a*s*n,this.w=i*r*n+a*s*o),this},setFromAxisAngle:function(e,t){var i=t/2,r=Math.sin(i);return this.x=e.x*r,this.y=e.y*r,this.z=e.z*r,this.w=Math.cos(i),this},toEuler:function(){var t=new e.Vector3;return t.x=Math.atan2(2*(this.w*this.x+this.y*this.z),1-2*(this.x*this.x+this.y*this.y)),t.y=Math.asin(2*(this.w*this.y-this.z*this.x)),t.z=Math.atan2(2*(this.w*this.z+this.x*this.y),1-2*(this.y*this.y+this.z*this.z)),t},setFromRotationMatrix:function(e){var t,i=e.elements,r=i[0],n=i[4],a=i[8],s=i[1],o=i[5],l=i[9],c=i[2],h=i[6],u=i[10],d=r+o+u;return d>0?(t=.5/Math.sqrt(d+1),this.w=.25/t,this.x=(h-l)*t,this.y=(a-c)*t,this.z=(s-n)*t):r>o&&r>u?(t=2*Math.sqrt(1+r-o-u),this.w=(h-l)/t,this.x=.25*t,this.y=(n+s)/t,this.z=(a+c)/t):o>u?(t=2*Math.sqrt(1+o-r-u),this.w=(a-c)/t,this.x=(n+s)/t,this.y=.25*t,this.z=(l+h)/t):(t=2*Math.sqrt(1+u-r-o),this.w=(s-n)/t,this.x=(a+c)/t,this.y=(l+h)/t,this.z=.25*t),this},toRotationMatrix:function(){var t=2*this.x,i=2*this.y,r=2*this.z,n=t*this.w,a=i*this.w,s=(this.w,t*this.x),o=(this.x,r*this.x),l=i*this.y,c=r*this.y;this.z,(new e.Matrix3).elements;return new e.Vector3(o-a,c+n,1-(s+l))},inverse:function(){return this.conjugate().normalize(),this},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var e=this.length();return 0===e?(this.x=0,this.y=0,this.z=0,this.w=1):(e=1/e,this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e),this},add:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},sub:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},multiply:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Quaternion's .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)},multiplyQuaternions:function(e,t){var i=e.x,r=e.y,n=e.z,a=e.w,s=t.x,o=t.y,l=t.z,c=t.w;return this.x=i*c+a*s+r*l-n*o,this.y=r*c+a*o+n*s-i*l,this.z=n*c+a*l+i*o-r*s,this.w=a*c-i*s-r*o-n*l,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},multiplyVector3:function(e){return console.warn("DEPRECATED: Quaternion's .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),e.applyQuaternion(this)},log:function(){if(Math.abs(this.w)>=1)return this.w=0,this;var e=Math.acos(this.w),t=Math.sin(e);if(this.w=0,Math.abs(t)<.001)return this;var i=e/t;return this.x*=i,this.y*=i,this.z*=i,this},exp:function(){var e=this.length();this.w=Math.cos(e);var t=Math.sin(e);if(Math.abs(e)<.001)return this;var i=t/e;return this.x*=i,this.y*=i,this.z*=i,this},slerp:function(e,t){var i=this.x,r=this.y,n=this.z,a=this.w,s=a*e.w+i*e.x+r*e.y+n*e.z;if(s<0?(this.w=-e.w,this.x=-e.x,this.y=-e.y,this.z=-e.z,s=-s):this.copy(e),s>=1)return this.w=a,this.x=i,this.y=r,this.z=n,this;var o=Math.acos(s),l=Math.sqrt(1-s*s);if(Math.abs(l)<.001)return this.w=.5*(a+this.w),this.x=.5*(i+this.x),this.y=.5*(r+this.y),this.z=.5*(n+this.z),this;var c=Math.sin((1-t)*o)/l,h=Math.sin(t*o)/l;return this.w=a*c+this.w*h,this.x=i*c+this.x*h,this.y=r*c+this.y*h,this.z=n*c+this.z*h,this},intermediatePoint:function(t,n,a){return i||(i=new e.Quaternion),r||(r=new e.Quaternion),i.copy(n).inverse().multiply(t).log(),r.copy(n).inverse().multiply(a).log(),i.add(r).multiplyScalar(-.25),this.copy(n).multiply(i.exp()),this.normalize(),this},squad:function(t,i,r,n,a){this.copy(t).slerp(n,a,!1),this.normalize();var s=(new e.Quaternion).copy(i).slerp(r,a);return s.normalize(),this.slerp(s,2*a*(1-a)).normalize()},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},clone:function(){return new e.Quaternion(this.x,this.y,this.z,this.w)}},e.Quaternion.slerp=function(e,t,i,r){return i.copy(e).slerp(t,r)},e.Curve=function(){},e.Curve.prototype.getPoint=function(e){return console.log("Warning, getPoint() not implemented!"),null},e.Curve.prototype.getPointAt=function(e,t){var i=this.getUtoTmapping(e,t);return this.getPoint(i)},e.Curve.prototype.getPoints=function(e){e||(e=5);var t,i=[];for(t=0;t<=e;t++)i.push(this.getPoint(t/e));return i},e.Curve.prototype.getSpacedPoints=function(e){e||(e=5);var t,i=[];for(t=0;t<=e;t++)i.push(this.getPointAt(t/e));return i},e.Curve.prototype.getLength=function(e){var t=this.getLengths();if(void 0!==e){var i=e*(t.length-1),r=Math.floor(i),n=i-r;return r+1>=t.length?t[r]:(1-n)*t[r]+n*t[r+1]}return t[t.length-1]},e.Curve.prototype.getLengths=function(e){if(e||(e=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length==e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t,i,r=[],n=this.getPoint(0),a=0;for(r.push(0),i=1;i<=e;i++)a+=(t=this.getPoint(i/e)).distanceTo(n),r.push(a),n=t;return this.cacheArcLengths=r,r},e.Curve.prototype.updateArcLengths=function(){this.needsUpdate=!0,this.getLengths()},e.Curve.prototype.getUtoTmapping=function(e,t){var i,r=this.getLengths(),n=0,a=r.length;i=t||e*r[a-1];for(var s,o=0,l=a-1;o<=l;)if((s=r[n=Math.floor(o+(l-o)/2)]-i)<0)o=n+1;else{if(!(s>0)){l=n;break}l=n-1}if(r[n=l]==i)return n/(a-1);var c=r[n];return(n+(i-c)/(r[n+1]-c))/(a-1)},e.Curve.prototype.getTangent=function(e){var t=e-1e-4,i=e+1e-4;t<0&&(t=0),i>1&&(i=1);var r=this.getPoint(t);return this.getPoint(i).clone().sub(r).normalize()},e.Curve.prototype.getTangentAt=function(e){var t=this.getUtoTmapping(e);return this.getTangent(t)},e.Curve.create=function(t,i){return t.prototype=Object.create(e.Curve.prototype),t.prototype.getPoint=i,t},e.Curve.Utils={tangentQuadraticBezier:function(e,t,i,r){return 2*(1-e)*(i-t)+2*e*(r-i)},tangentCubicBezier:function(e,t,i,r,n){return-3*t*(1-e)*(1-e)+3*i*(1-e)*(1-e)-6*e*i*(1-e)+6*e*r*(1-e)-3*e*e*r+3*e*e*n},tangentSpline:function(e,t,i,r,n){return 6*e*e-6*e+(3*e*e-4*e+1)+(-6*e*e+6*e)+(3*e*e-2*e)},interpolate:function(e,t,i,r,n){var a=.5*(i-e),s=.5*(r-t),o=n*n;return(2*t-2*i+a+s)*(n*o)+(-3*t+3*i-2*a-s)*o+a*n+t}},e.QuaternionSpline=function(e){this.controlPts=[],this.tangentPts=[],this.setPoints(e)},e.QuaternionSpline.prototype={constructor:e.QuaternionSpline,setPoints:function(e){this.controlPts=e,e&&this._updateTangents()},clear:function(){this.controlPts=[],this.tangentPts=[]},getNbPoints:function(){return this.controlPts.length},addPoint:function(e){this.controlPts.push(e),this._updateTangents()},insertPoint:function(e,t){return!(e<0||e>this.controlPts.length)&&(this.controlPts.splice(e,0,t),this._updateTangents(),!0)},updatePoint:function(e,t){return!(e<0||e>=this.controlPts.length)&&(this.controlPts[e]=t,this._updateTangents(),!0)},removePoint:function(e){return!(e<0||e>=this.controlPts.length)&&(this.controlPts.splice(e,1),this._updateTangents(),!0)},interpolate:function(e){var t=e*(this.controlPts.length-1),i=Math.floor(t);return this._interpolate(i,t-i)},_interpolate:function(t,i){return t===this.controlPts.length-1?this.controlPts[t]:0===i?this.controlPts[t]:1===i?this.controlPts[t+1]:(new e.Quaternion).squad(this.controlPts[t],this.tangentPts[t],this.tangentPts[t+1],this.controlPts[t+1],i)},_updateTangents:function(){var t=this.controlPts.length;if(!(t<2)){this.controlPts[t-1].normalize();for(var i=t-1;i>0;i--)this.controlPts[i-1].normalize(),this.controlPts[i-1].dot(this.controlPts[i])<=0&&this.controlPts[i-1].multiplyScalar(-1);var r=this.controlPts[0].equals(this.controlPts[t-1]);for(i=0;i<t;++i){var n,a,s=this.controlPts[i];i?i===t-1?(n=this.controlPts[i-1],a=r?this.controlPts[1]:s):(n=this.controlPts[i-1],a=this.controlPts[i+1]):(a=this.controlPts[1],n=r?this.controlPts[t-2]:s),this.tangentPts[i]||(this.tangentPts[i]=new e.Quaternion),this.tangentPts[i].intermediatePoint(n,s,a)}}}},e.PositionSpline=function(e){this.controlPts=[],e&&this.setPoints(e)},e.PositionSpline.prototype={constructor:e.PositionSpline,getPointAt:e.Curve.prototype.getPointAt,getLength:e.Curve.prototype.getLength,getLengths:e.Curve.prototype.getLengths,updateArcLengths:e.Curve.prototype.updateArcLengths,getUtoTmapping:e.Curve.prototype.getUtoTmapping,getPoint:function(e){var t=e*(this.controlPts.length-1),i=Math.floor(t);return this._interpolate(i,t-i)},getNbPoints:function(){return this.controlPts.length},setPoints:function(e){this.controlPts=e,this._updateCurve()},clear:function(){this.controlPts=[],this._updateCurve()},addPoint:function(e){this.controlPts.push(e),this._updateCurve()},insertPoint:function(e,t){return!(e<0||e>this.controlPts.length)&&(this.controlPts.splice(e,0,t),this._updateCurve(),!0)},updatePoint:function(e,t){return!(e<0||e>=this.controlPts.length)&&(this.controlPts[e]=t,this._updateCurve(),!0)},removePoint:function(e){return!(e<0||e>=this.controlPts.length)&&(this.controlPts.splice(e,1),this._updateCurve(),!0)},_updateCurve:function(){this.updateArcLengths()},_interpolate:function(t,i){var r=this.controlPts.length;if(r<2)return null;if(t===r-1)return this.controlPts[t];if(0===i)return this.controlPts[t];if(1===i)return this.controlPts[t+1];var n,a,s,o=this.controlPts[0].equals(this.controlPts[r-1]),l=this.controlPts[t];o?(n=t?this.controlPts[t-1]:this.controlPts[r-2],a=t>r-2?this.controlPts[1]:this.controlPts[t+1],s=t===r-1?this.controlPts[2]:t===r-2?this.controlPts[1]:this.controlPts[t+2]):(n=t?this.controlPts[t-1]:l,a=t>r-2?l:this.controlPts[t+1],s=t>r-3?a:this.controlPts[t+2]);var c=void 0!==this.controlPts[0].w,h=c?new e.Vector4:new e.Vector3;return h.x=this._CatmullInterpolate(n.x,l.x,a.x,s.x,i),h.y=this._CatmullInterpolate(n.y,l.y,a.y,s.y,i),h.z=this._CatmullInterpolate(n.z,l.z,a.z,s.z,i),c&&(h.w=this._CatmullInterpolate(n.w,l.w,a.w,s.w,i)),h},_CatmullInterpolate:function(e,t,i,r,n){var a=.5*(i-e),s=.5*(r-t),o=n*n;return(2*t-2*i+a+s)*(n*o)+(-3*t+3*i-2*a-s)*o+a*n+t}},e.Vector2=function(e,t){this.x=e||0,this.y=t||0},e.Vector2.prototype={constructor:e.Vector2,set:function(e,t){return this.x=e,this.y=t,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}},copy:function(e){return this.x=e.x,this.y=e.y,this},add:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Vector2's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this)},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},addScalar:function(e){return this.x+=e,this.y+=e,this},sub:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Vector2's .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this},divideScalar:function(e){return 0!==e?(this.x/=e,this.y/=e):this.set(0,0),this},min:function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this},max:function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this},clamp:function(e,t){return this.x<e.x?this.x=e.x:this.x>t.x&&(this.x=t.x),this.y<e.y?this.y=e.y:this.y>t.y&&(this.y=t.y),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,i=this.y-e.y;return t*t+i*i},setLength:function(e){var t=this.length();return 0!==t&&e!==t&&this.multiplyScalar(e/t),this},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},equals:function(e){return e.x===this.x&&e.y===this.y},toArray:function(){return[this.x,this.y]},clone:function(){return new e.Vector2(this.x,this.y)}},e.Vector3=function(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0},e.Vector3.prototype={constructor:e.Vector3,set:function(e,t,i){return this.x=e,this.y=t,this.z=i,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},barycentricCoordinates:function(t,i,r){var n=(new e.Vector3).subVectors(t,this),a=(new e.Vector3).subVectors(i,this),s=(new e.Vector3).subVectors(r,this),o=(new e.Vector3).subVectors(t,i),l=(new e.Vector3).subVectors(t,r),c=1/(new e.Vector3).crossVectors(o,l).length();return{alpha:(new e.Vector3).crossVectors(a,s).length(),beta:(new e.Vector3).crossVectors(s,n).length(),gamma:(new e.Vector3).crossVectors(n,a).length(),normalisationFactor:c}},setFromJSON:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},setFromArray:function(e){return this.x=e[0],this.y=e[1],this.z=e[2],this},createJSON:function(){return{x:this.x,y:this.y,z:this.z}},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},getMaxAxis:function(){var e=0,t=this.x;return this.y>t&&(e=1,t=this.y),this.z>t&&(e=2,t=this.z),e},add:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Vector3's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},sub:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Vector3's .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},multiply:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Vector3's .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},multiplyVectors:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},applyMatrix3:function(e){var t=this.x,i=this.y,r=this.z,n=e.elements;return this.x=n[0]*t+n[3]*i+n[6]*r,this.y=n[1]*t+n[4]*i+n[7]*r,this.z=n[2]*t+n[5]*i+n[8]*r,this},applyMatrix4:function(e){if(!e)return this;var t=this.x,i=this.y,r=this.z,n=e.elements;return this.x=n[0]*t+n[4]*i+n[8]*r+n[12],this.y=n[1]*t+n[5]*i+n[9]*r+n[13],this.z=n[2]*t+n[6]*i+n[10]*r+n[14],this},applyRotation:function(e){if(!e)return this;var t=this.x,i=this.y,r=this.z,n=e.elements;return this.x=n[0]*t+n[4]*i+n[8]*r,this.y=n[1]*t+n[5]*i+n[9]*r,this.z=n[2]*t+n[6]*i+n[10]*r,this},applyProjection:function(e){var t=this.x,i=this.y,r=this.z,n=e.elements,a=1/(n[3]*t+n[7]*i+n[11]*r+n[15]);return this.x=(n[0]*t+n[4]*i+n[8]*r+n[12])*a,this.y=(n[1]*t+n[5]*i+n[9]*r+n[13])*a,this.z=(n[2]*t+n[6]*i+n[10]*r+n[14])*a,this},applyQuaternion:function(e){var t=this.x,i=this.y,r=this.z,n=e.x,a=e.y,s=e.z,o=e.w,l=o*t+a*r-s*i,c=o*i+s*t-n*r,h=o*r+n*i-a*t,u=-n*t-a*i-s*r;return this.x=l*o+u*-n+c*-s-h*-a,this.y=c*o+u*-a+h*-n-l*-s,this.z=h*o+u*-s+l*-a-c*-n,this},transformDirection:function(e){var t=this.x,i=this.y,r=this.z,n=e.elements;return this.x=n[0]*t+n[4]*i+n[8]*r,this.y=n[1]*t+n[5]*i+n[9]*r,this.z=n[2]*t+n[6]*i+n[10]*r,this.normalize(),this},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){return 0!==e?(this.x/=e,this.y/=e,this.z/=e):(this.x=0,this.y=0,this.z=0),this},min:function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this.z>e.z&&(this.z=e.z),this},max:function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this.z<e.z&&(this.z=e.z),this},clamp:function(e,t){return this.x<e.x?this.x=e.x:this.x>t.x&&(this.x=t.x),this.y<e.y?this.y=e.y:this.y>t.y&&(this.y=t.y),this.z<e.z?this.z=e.z:this.z>t.z&&(this.z=t.z),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){var t=this.length();return 0!==t&&e!==t&&this.multiplyScalar(e/t),this},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},cross:function(e,t){if(void 0!==t)return console.warn("DEPRECATED: Vector3's .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t);var i=this.x,r=this.y,n=this.z;return this.x=r*e.z-n*e.y,this.y=n*e.x-i*e.z,this.z=i*e.y-r*e.x,this},crossVectors:function(e,t){return this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this},applyAxisAngle:function(t,i){return void 0===s&&(s=new e.Quaternion),this.applyQuaternion(s.setFromAxisAngle(t,i)),this},projectOnVector:function(t){return void 0===n&&(n=new e.Vector3),n.copy(t).normalize(),a=this.dot(n),this.copy(n).multiplyScalar(a)},projectOnPlane:function(){var t;return function(i){return void 0===t&&(t=new e.Vector3),t.copy(this).projectOnVector(i),this.sub(t)}}(),reflect:function(){var t;return function(i){return void 0===t&&(t=new e.Vector3),this.sub(t.copy(i).multiplyScalar(2*this.dot(i)))}}(),angleTo:function(t){var i=this.dot(t)/(this.length()*t.length());return Math.acos(e.Math.clamp(i,-1,1))},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,i=this.y-e.y,r=this.z-e.z;return t*t+i*i+r*r},getPositionFromMatrix:function(e){return this.x=e.elements[12],this.y=e.elements[13],this.z=e.elements[14],this},getColumnFromMatrix:function(e,t){var i=4*e,r=t.elements;return this.x=r[i],this.y=r[i+1],this.z=r[i+2],this},setEulerFromRotationMatrix:function(e,t){function i(e){return Math.min(Math.max(e,-1),1)}var r=e.elements,n=r[0],a=r[4],s=r[8],o=r[1],l=r[5],c=r[9],h=r[2],u=r[6],d=r[10];return void 0===t||"XYZ"===t?(this.y=Math.asin(i(s)),Math.abs(s)<.99999?(this.x=Math.atan2(-c,d),this.z=Math.atan2(-a,n)):(this.x=Math.atan2(u,l),this.z=0)):"YXZ"===t?(this.x=Math.asin(-i(c)),Math.abs(c)<.99999?(this.y=Math.atan2(s,d),this.z=Math.atan2(o,l)):(this.y=Math.atan2(-h,n),this.z=0)):"ZXY"===t?(this.x=Math.asin(i(u)),Math.abs(u)<.99999?(this.y=Math.atan2(-h,d),this.z=Math.atan2(-a,l)):(this.y=0,this.z=Math.atan2(o,n))):"ZYX"===t?(this.y=Math.asin(-i(h)),Math.abs(h)<.99999?(this.x=Math.atan2(u,d),this.z=Math.atan2(o,n)):(this.x=0,this.z=Math.atan2(-a,l))):"YZX"===t?(this.z=Math.asin(i(o)),Math.abs(o)<.99999?(this.x=Math.atan2(-c,l),this.y=Math.atan2(-h,n)):(this.x=0,this.y=Math.atan2(s,d))):"XZY"===t&&(this.z=Math.asin(-i(a)),Math.abs(a)<.99999?(this.x=Math.atan2(u,l),this.y=Math.atan2(s,n)):(this.x=Math.atan2(-c,d),this.y=0)),this},setEulerFromQuaternion:function(e,t){function i(e){return Math.min(Math.max(e,-1),1)}var r=e.x*e.x,n=e.y*e.y,a=e.z*e.z,s=e.w*e.w;return void 0===t||"XYZ"===t?(this.x=Math.atan2(2*(e.x*e.w-e.y*e.z),s-r-n+a),this.y=Math.asin(i(2*(e.x*e.z+e.y*e.w))),this.z=Math.atan2(2*(e.z*e.w-e.x*e.y),s+r-n-a)):"YXZ"===t?(this.x=Math.asin(i(2*(e.x*e.w-e.y*e.z))),this.y=Math.atan2(2*(e.x*e.z+e.y*e.w),s-r-n+a),this.z=Math.atan2(2*(e.x*e.y+e.z*e.w),s-r+n-a)):"ZXY"===t?(this.x=Math.asin(i(2*(e.x*e.w+e.y*e.z))),this.y=Math.atan2(2*(e.y*e.w-e.z*e.x),s-r-n+a),this.z=Math.atan2(2*(e.z*e.w-e.x*e.y),s-r+n-a)):"ZYX"===t?(this.x=Math.atan2(2*(e.x*e.w+e.z*e.y),s-r-n+a),this.y=Math.asin(i(2*(e.y*e.w-e.x*e.z))),this.z=Math.atan2(2*(e.x*e.y+e.z*e.w),s+r-n-a)):"YZX"===t?(this.x=Math.atan2(2*(e.x*e.w-e.z*e.y),s-r+n-a),this.y=Math.atan2(2*(e.y*e.w-e.x*e.z),s+r-n-a),this.z=Math.asin(i(2*(e.x*e.y+e.z*e.w)))):"XZY"===t&&(this.x=Math.atan2(2*(e.x*e.w+e.y*e.z),s-r+n-a),this.y=Math.atan2(2*(e.x*e.z+e.y*e.w),s+r-n-a),this.z=Math.asin(i(2*(e.z*e.w-e.x*e.y)))),this},getScaleFromMatrix:function(e){var t=this.set(e.elements[0],e.elements[1],e.elements[2]).length(),i=this.set(e.elements[4],e.elements[5],e.elements[6]).length(),r=this.set(e.elements[8],e.elements[9],e.elements[10]).length();return this.x=t,this.y=i,this.z=r,this},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},toArray:function(){return[this.x,this.y,this.z]},clone:function(){return new e.Vector3(this.x,this.y,this.z)},isNaN:function(){return!(isFinite(this.x)&&isFinite(this.y)&&isFinite(this.z))}},e.Vector4=function(e,t,i,r){this.x=e||0,this.y=t||0,this.z=i||0,this.w=void 0!==r?r:1},e.Vector4.prototype={constructor:e.Vector4,set:function(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setW:function(e){return this.w=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this},add:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Vector4's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},sub:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Vector4's .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},applyMatrix4:function(e){if(!e)return this;var t=this.x,i=this.y,r=this.z,n=this.w,a=e.elements;return this.x=a[0]*t+a[4]*i+a[8]*r+a[12]*n,this.y=a[1]*t+a[5]*i+a[9]*r+a[13]*n,this.z=a[2]*t+a[6]*i+a[10]*r+a[14]*n,this.w=a[3]*t+a[7]*i+a[11]*r+a[15]*n,this},divideScalar:function(e){return 0!==e?(this.x/=e,this.y/=e,this.z/=e,this.w/=e):(this.x=0,this.y=0,this.z=0,this.w=1),this},setAxisAngleFromQuaternion:function(e){this.w=2*Math.acos(e.w);var t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this},setAxisAngleFromRotationMatrix:function(e){var t,i,r,n,a=e.elements,s=a[0],o=a[4],l=a[8],c=a[1],h=a[5],u=a[9],d=a[2],p=a[6],f=a[10];if(Math.abs(o-c)<.01&&Math.abs(l-d)<.01&&Math.abs(u-p)<.01){if(Math.abs(o+c)<.1&&Math.abs(l+d)<.1&&Math.abs(u+p)<.1&&Math.abs(s+h+f-3)<.1)return this.set(1,0,0,0),this;t=Math.PI;var m=(s+1)/2,g=(h+1)/2,v=(f+1)/2,S=(o+c)/4,_=(l+d)/4,y=(u+p)/4;return m>g&&m>v?m<.01?(i=0,r=.707106781,n=.707106781):(r=S/(i=Math.sqrt(m)),n=_/i):g>v?g<.01?(i=.707106781,r=0,n=.707106781):(i=S/(r=Math.sqrt(g)),n=y/r):v<.01?(i=.707106781,r=.707106781,n=0):(i=_/(n=Math.sqrt(v)),r=y/n),this.set(i,r,n,t),this}var x=Math.sqrt((p-u)*(p-u)+(l-d)*(l-d)+(c-o)*(c-o));return Math.abs(x)<.001&&(x=1),this.x=(p-u)/x,this.y=(l-d)/x,this.z=(c-o)/x,this.w=Math.acos((s+h+f-1)/2),this},getColumnFromMatrix:function(e,t){var i=4*e,r=t.elements;return this.x=r[i],this.y=r[i+1],this.z=r[i+2],this.w=1,this},min:function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this.z>e.z&&(this.z=e.z),this.w>e.w&&(this.w=e.w),this},max:function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this.z<e.z&&(this.z=e.z),this.w<e.w&&(this.w=e.w),this},clamp:function(e,t){return this.x<e.x?this.x=e.x:this.x>t.x&&(this.x=t.x),this.y<e.y?this.y=e.y:this.y>t.y&&(this.y=t.y),this.z<e.z?this.z=e.z:this.z>t.z&&(this.z=t.z),this.w<e.w?this.w=e.w:this.w>t.w&&(this.w=t.w),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(e,t){return Math.sqrt(this.distanceToSquared(e,t))},distanceToSquared:function(e,t){var i=this.x-e.x,r=this.y-e.y,n=this.z-e.z,a=i*i+r*r+n*n;return t&&(a+=this.w-e.w),a},setLength:function(e){var t=this.length();return 0!==t&&e!==t&&this.multiplyScalar(e/t),this},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},toArray:function(){return[this.x,this.y,this.z,this.w]},clone:function(){return new e.Vector4(this.x,this.y,this.z,this.w)}},e.Matrix3=function(e,t,i,r,n,a,s,o,l){this.elements=new Float32Array(9),this.set(void 0!==e?e:1,t||0,i||0,r||0,void 0!==n?n:1,a||0,s||0,o||0,void 0!==l?l:1)},e.Matrix3.prototype={constructor:e.Matrix3,set:function(e,t,i,r,n,a,s,o,l){var c=this.elements;return c[0]=e,c[3]=t,c[6]=i,c[1]=r,c[4]=n,c[7]=a,c[2]=s,c[5]=o,c[8]=l,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},isIdentity:function(){var e=this.elements;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&1===e[4]&&0===e[5]&&0===e[6]&&0===e[7]&&1===e[8]},copy:function(e){var t=e.elements;return this.set(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]),this},multiplyVector3:function(e){return console.warn("DEPRECATED: Matrix3's .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},multiplyVector3Array:function(){var t=new e.Vector3;return function(e){for(var i=0,r=e.length;i<r;i+=3)t.x=e[i],t.y=e[i+1],t.z=e[i+2],t.applyMatrix3(this),e[i]=t.x,e[i+1]=t.y,e[i+2]=t.z;return e}}(),multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},multiplyMatrices:function(e,t){if(!t)return this.copy(e),this;var i=e.elements,r=t.elements,n=this.elements,a=i[0],s=i[3],o=i[6],l=i[1],c=i[4],h=i[7],u=i[2],d=i[5],p=i[8],f=r[0],m=r[3],g=r[6],v=r[1],S=r[4],_=r[7],y=r[2],x=r[5],M=r[8];return n[0]=a*f+s*v+o*y,n[3]=a*m+s*S+o*x,n[6]=a*g+s*_+o*M,n[1]=l*f+c*v+h*y,n[4]=l*m+c*S+h*x,n[7]=l*g+c*_+h*M,n[2]=u*f+d*v+p*y,n[5]=u*m+d*S+p*x,n[8]=u*g+d*_+p*M,this},determinant:function(){var e=this.elements,t=e[0],i=e[1],r=e[2],n=e[3],a=e[4],s=e[5],o=e[6],l=e[7],c=e[8];return t*a*c-t*s*l-i*n*c+i*s*o+r*n*l-r*a*o},getInverse:function(e,t){var i=e.elements,r=this.elements;r[0]=i[10]*i[5]-i[6]*i[9],r[1]=-i[10]*i[1]+i[2]*i[9],r[2]=i[6]*i[1]-i[2]*i[5],r[3]=-i[10]*i[4]+i[6]*i[8],r[4]=i[10]*i[0]-i[2]*i[8],r[5]=-i[6]*i[0]+i[2]*i[4],r[6]=i[9]*i[4]-i[5]*i[8],r[7]=-i[9]*i[0]+i[1]*i[8],r[8]=i[5]*i[0]-i[1]*i[4];var n=i[0]*r[0]+i[1]*r[3]+i[2]*r[6];if(0===n){var a="Matrix3.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(a);return console.warn(a),this.identity(),this}return this.multiplyScalar(1/n),this},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},getNormalMatrix:function(e){return this.getInverse(e).transpose(),this},transposeIntoArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},clone:function(){var t=this.elements;return new e.Matrix3(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8])},flattenToArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},scale:function(e){var t=this.elements,i=e.x,r=e.y;return t[0]*=i,t[3]*=r,t[1]*=i,t[4]*=r,t[2]*=i,t[5]*=r,this},getMatrix4:function(){var e=this.elements;return new Matrix4(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1)}},e._Float32Matrix4=function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m){this.elements=new Float32Array(16)},e._Float32Matrix4.prototype={constructor:e._Float32Matrix4,set:function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m){var g=this.elements;return g[0]=e,g[4]=t,g[8]=i,g[12]=r,g[1]=n,g[5]=a,g[9]=s,g[13]=o,g[2]=l,g[6]=c,g[10]=h,g[14]=u,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this},_fromMatrix4WithLowPartTranslation(e){this.elements.set(e.elements);var t=e.getLowPartTranslation();return this.elements[3]=t.x,this.elements[7]=t.y,this.elements[11]=t.z,this},isIdentity:function(){var e=this.elements;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]},_multiplyMatricesMV:function(e,t){var i=e.elements,r=t.elements,n=this.elements,a=i[0],s=i[4],o=i[8],l=i[12],c=i[1],h=i[5],u=i[9],d=i[13],p=i[2],f=i[6],m=i[10],g=i[14],v=r[0],S=r[4],_=r[8],y=r[12],x=r[1],M=r[5],P=r[9],C=r[13],b=r[2],D=r[6],w=r[10],E=r[14];return n[0]=a*v+s*x+o*b,n[4]=a*S+s*M+o*D,n[8]=a*_+s*P+o*w,n[12]=a*y+s*C+o*E+l,n[1]=c*v+h*x+u*b,n[5]=c*S+h*M+u*D,n[9]=c*_+h*P+u*w,n[13]=c*y+h*C+u*E+d,n[2]=p*v+f*x+m*b,n[6]=p*S+f*M+m*D,n[10]=p*_+f*P+m*w,n[14]=p*y+f*C+m*E+g,n[3]=0,n[7]=0,n[11]=0,n[15]=1,this},multiplyMatricesAndInverse:function(t,i){var r=(new e.Matrix4).multiplyMatrices(t,i);return this.getInverse(r)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},getInverse:function(e,t){var i=this.elements,r=e.elements,n=r[0],a=r[4],s=r[8],o=r[12],l=r[1],c=r[5],h=r[9],u=r[13],d=r[2],p=r[6],f=r[10],m=r[14],g=r[3],v=r[7],S=r[11],_=r[15];i[0]=h*m*v-u*f*v+u*p*S-c*m*S-h*p*_+c*f*_,i[4]=o*f*v-s*m*v-o*p*S+a*m*S+s*p*_-a*f*_,i[8]=s*u*v-o*h*v+o*c*S-a*u*S-s*c*_+a*h*_,i[12]=o*h*p-s*u*p-o*c*f+a*u*f+s*c*m-a*h*m,i[1]=u*f*g-h*m*g-u*d*S+l*m*S+h*d*_-l*f*_,i[5]=s*m*g-o*f*g+o*d*S-n*m*S-s*d*_+n*f*_,i[9]=o*h*g-s*u*g-o*l*S+n*u*S+s*l*_-n*h*_,i[13]=s*u*d-o*h*d+o*l*f-n*u*f-s*l*m+n*h*m,i[2]=c*m*g-u*p*g+u*d*v-l*m*v-c*d*_+l*p*_,i[6]=o*p*g-a*m*g-o*d*v+n*m*v+a*d*_-n*p*_,i[10]=a*u*g-o*c*g+o*l*v-n*u*v-a*l*_+n*c*_,i[14]=o*c*d-a*u*d-o*l*p+n*u*p+a*l*m-n*c*m,i[3]=h*p*g-c*f*g-h*d*v+l*f*v+c*d*S-l*p*S,i[7]=a*f*g-s*p*g+s*d*v-n*f*v-a*d*S+n*p*S,i[11]=s*c*g-a*h*g-s*l*v+n*h*v+a*l*S-n*c*S,i[15]=a*h*d-s*c*d+s*l*p-n*h*p-a*l*f+n*c*f;var y=r[0]*i[0]+r[1]*i[4]+r[2]*i[8]+r[3]*i[12];if(0==y){var x="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(x);return console.warn(x),this.identity(),this}return this.multiplyScalar(1/y),this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}};var c=new Float32Array(1);e.SplitFloat32=function(e){c[0]=e;var t=c[0];return{low:e-t,high:t}},e._SplitFloat32PositiveError=function(e){c[0]=e;var t=c[0],i=e-t;return i<0&&(t-=2*(i=-i)),{low:i,high:t}};var h,u,d,p,f,m;return e.Matrix4=function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m){this.elements=void 0!==e?[e,n,l,d,t,a,c,p,i,s,h,f,r,o,u,m]:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},e.Matrix4.prototype={constructor:e.Matrix4,getLowPartTranslation:function(){var t=e.SplitFloat32(this.elements[12]),i=e.SplitFloat32(this.elements[13]),r=e.SplitFloat32(this.elements[14]),n=new e.Vector3;return n.x=t.low,n.y=i.low,n.z=r.low,n},set:function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m){var g=this.elements;return g[0]=e,g[4]=t,g[8]=i,g[12]=r,g[1]=n,g[5]=a,g[9]=s,g[13]=o,g[2]=l,g[6]=c,g[10]=h,g[14]=u,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this},getValue:function(e,t){return this.elements[4*(t-1)+e-1]},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},isIdentity:function(){var e=this.elements;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]},copy:function(e){var t=e.elements;return this.set(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]),this},createJSON:function(){if(this.isIdentity())return"identity";var e,t=[],i=this.elements;if(1===i[0]&&0===i[1]&&0===i[2]&&0===i[3]&&0===i[4]&&1===i[5]&&0===i[6]&&0===i[7]&&0===i[8]&&0===i[9]&&1===i[10]&&0===i[11]&&1===i[15])t.push(i[12]),t.push(i[13]),t.push(i[14]);else for(e=0;e<16;e++)t.push(this.elements[e]);return t},setFromJSON:function(e){if("identity"===e)this.identity();else if(3===e.length)this.identity(),this.elements[12]=e[0],this.elements[13]=e[1],this.elements[14]=e[2];else{var t;for(t=0;t<16;t++)this.elements[t]=e[t]}return this},setRotationFromEuler:function(e,t){var i=this.elements,r=e.x,n=e.y,a=e.z,s=Math.cos(r),o=Math.sin(r),l=Math.cos(n),c=Math.sin(n),h=Math.cos(a),u=Math.sin(a);if(void 0===t||"XYZ"===t){var d=s*h,p=s*u,f=o*h,m=o*u;i[0]=l*h,i[4]=-l*u,i[8]=c,i[1]=p+f*c,i[5]=d-m*c,i[9]=-o*l,i[2]=m-d*c,i[6]=f+p*c,i[10]=s*l}else if("YXZ"===t){var g=l*h,v=l*u,S=c*h,_=c*u;i[0]=g+_*o,i[4]=S*o-v,i[8]=s*c,i[1]=s*u,i[5]=s*h,i[9]=-o,i[2]=v*o-S,i[6]=_+g*o,i[10]=s*l}else if("ZXY"===t){g=l*h,v=l*u,S=c*h,_=c*u;i[0]=g-_*o,i[4]=-s*u,i[8]=S+v*o,i[1]=v+S*o,i[5]=s*h,i[9]=_-g*o,i[2]=-s*c,i[6]=o,i[10]=s*l}else if("ZYX"===t){d=s*h,p=s*u,f=o*h,m=o*u;i[0]=l*h,i[4]=f*c-p,i[8]=d*c+m,i[1]=l*u,i[5]=m*c+d,i[9]=p*c-f,i[2]=-c,i[6]=o*l,i[10]=s*l}else if("YZX"===t){var y=s*l,x=s*c,M=o*l,P=o*c;i[0]=l*h,i[4]=P-y*u,i[8]=M*u+x,i[1]=u,i[5]=s*h,i[9]=-o*h,i[2]=-c*h,i[6]=x*u+M,i[10]=y-P*u}else if("XZY"===t){y=s*l,x=s*c,M=o*l,P=o*c;i[0]=l*h,i[4]=-u,i[8]=c*h,i[1]=y*u+P,i[5]=s*h,i[9]=x*u-M,i[2]=M*u-x,i[6]=o*h,i[10]=P*u+y}return this},setRotationFromQuaternion:function(e){var t=this.elements,i=e.x,r=e.y,n=e.z,a=e.w,s=i+i,o=r+r,l=n+n,c=i*s,h=i*o,u=i*l,d=r*o,p=r*l,f=n*l,m=a*s,g=a*o,v=a*l;return t[0]=1-(d+f),t[4]=h-v,t[8]=u+g,t[1]=h+v,t[5]=1-(c+f),t[9]=p-m,t[2]=u-g,t[6]=p+m,t[10]=1-(c+d),this},makeRotationFromQuaternion:function(e){var t=this.elements,i=e.x,r=e.y,n=e.z,a=e.w,s=i+i,o=r+r,l=n+n,c=i*s,h=i*o,u=i*l,d=r*o,p=r*l,f=n*l,m=a*s,g=a*o,v=a*l;return t[0]=1-(d+f),t[4]=h-v,t[8]=u+g,t[1]=h+v,t[5]=1-(c+f),t[9]=p-m,t[2]=u-g,t[6]=p+m,t[10]=1-(c+d),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},lookAt:(h=new e.Vector3,u=new e.Vector3,d=new e.Vector3,function(e,t,i){var r=this.elements;return d.subVectors(e,t).normalize(),0===d.length()&&(d.z=1),h.crossVectors(i,d).normalize(),0===h.length()&&(d.x+=1e-4,h.crossVectors(i,d).normalize()),u.crossVectors(d,h),r[0]=h.x,r[4]=u.x,r[8]=d.x,r[1]=h.y,r[5]=u.y,r[9]=d.y,r[2]=h.z,r[6]=u.z,r[10]=d.z,this}),multiply:function(e,t){return void 0!==t?(console.warn("DEPRECATED: Matrix4's .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)},multiplyMatrices:function(e,t){if(!t)return this.copy(e),this;var i=e.elements,r=t.elements,n=this.elements,a=i[0],s=i[4],o=i[8],l=i[12],c=i[1],h=i[5],u=i[9],d=i[13],p=i[2],f=i[6],m=i[10],g=i[14],v=i[3],S=i[7],_=i[11],y=i[15],x=r[0],M=r[4],P=r[8],C=r[12],b=r[1],D=r[5],w=r[9],E=r[13],T=r[2],A=r[6],I=r[10],R=r[14],L=r[3],O=r[7],N=r[11],F=r[15];return n[0]=a*x+s*b+o*T+l*L,n[4]=a*M+s*D+o*A+l*O,n[8]=a*P+s*w+o*I+l*N,n[12]=a*C+s*E+o*R+l*F,n[1]=c*x+h*b+u*T+d*L,n[5]=c*M+h*D+u*A+d*O,n[9]=c*P+h*w+u*I+d*N,n[13]=c*C+h*E+u*R+d*F,n[2]=p*x+f*b+m*T+g*L,n[6]=p*M+f*D+m*A+g*O,n[10]=p*P+f*w+m*I+g*N,n[14]=p*C+f*E+m*R+g*F,n[3]=v*x+S*b+_*T+y*L,n[7]=v*M+S*D+_*A+y*O,n[11]=v*P+S*w+_*I+y*N,n[15]=v*C+S*E+_*R+y*F,this},multiplyToArray:function(e,t,i){var r=this.elements;return this.multiplyMatrices(e,t),i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=r[3],i[4]=r[4],i[5]=r[5],i[6]=r[6],i[7]=r[7],i[8]=r[8],i[9]=r[9],i[10]=r[10],i[11]=r[11],i[12]=r[12],i[13]=r[13],i[14]=r[14],i[15]=r[15],this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},multiplyVector3:function(e){return console.warn("DEPRECATED: Matrix4's .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) or vector.applyProjection( matrix ) instead."),e.applyProjection(this)},multiplyVector4:function(e){return console.warn("DEPRECATED: Matrix4's .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector3Array:function(){var t=new e.Vector3;return function(e){for(var i=0,r=e.length;i<r;i+=3)t.x=e[i],t.y=e[i+1],t.z=e[i+2],t.applyProjection(this),e[i]=t.x,e[i+1]=t.y,e[i+2]=t.z;return e}}(),rotateAxis:function(e){console.warn("DEPRECATED: Matrix4's .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),e.transformDirection(this)},crossVector:function(t){var i=this.elements,r=new e.Vector4;return r.x=i[0]*t.x+i[4]*t.y+i[8]*t.z+i[12]*t.w,r.y=i[1]*t.x+i[5]*t.y+i[9]*t.z+i[13]*t.w,r.z=i[2]*t.x+i[6]*t.y+i[10]*t.z+i[14]*t.w,r.w=t.w?i[3]*t.x+i[7]*t.y+i[11]*t.z+i[15]*t.w:1,r},determinant:function(){var e=this.elements,t=e[0],i=e[4],r=e[8],n=e[12],a=e[1],s=e[5],o=e[9],l=e[13],c=e[2],h=e[6],u=e[10],d=e[14];return e[3]*(+n*o*h-r*l*h-n*s*u+i*l*u+r*s*d-i*o*d)+e[7]*(+t*o*d-t*l*u+n*a*u-r*a*d+r*l*c-n*o*c)+e[11]*(+t*l*h-t*s*d-n*a*h+i*a*d+n*s*c-i*l*c)+e[15]*(-r*s*c-t*o*h+t*s*u+r*a*h-i*a*u+i*o*c)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},flattenToArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},setFromArray:function(e){var t=this.elements;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this},flattenToArrayOffset:function(e,t){var i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e},getPosition:function(){var t=new e.Vector3;return function(){console.warn("DEPRECATED: Matrix4's .getPosition() has been removed. Use Vector3.getPositionFromMatrix( matrix ) instead.");var e=this.elements;return t.set(e[12],e[13],e[14])}}(),setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getInverse:function(e,t){var i=this.elements,r=e.elements,n=r[0],a=r[4],s=r[8],o=r[12],l=r[1],c=r[5],h=r[9],u=r[13],d=r[2],p=r[6],f=r[10],m=r[14],g=r[3],v=r[7],S=r[11],_=r[15];i[0]=h*m*v-u*f*v+u*p*S-c*m*S-h*p*_+c*f*_,i[4]=o*f*v-s*m*v-o*p*S+a*m*S+s*p*_-a*f*_,i[8]=s*u*v-o*h*v+o*c*S-a*u*S-s*c*_+a*h*_,i[12]=o*h*p-s*u*p-o*c*f+a*u*f+s*c*m-a*h*m,i[1]=u*f*g-h*m*g-u*d*S+l*m*S+h*d*_-l*f*_,i[5]=s*m*g-o*f*g+o*d*S-n*m*S-s*d*_+n*f*_,i[9]=o*h*g-s*u*g-o*l*S+n*u*S+s*l*_-n*h*_,i[13]=s*u*d-o*h*d+o*l*f-n*u*f-s*l*m+n*h*m,i[2]=c*m*g-u*p*g+u*d*v-l*m*v-c*d*_+l*p*_,i[6]=o*p*g-a*m*g-o*d*v+n*m*v+a*d*_-n*p*_,i[10]=a*u*g-o*c*g+o*l*v-n*u*v-a*l*_+n*c*_,i[14]=o*c*d-a*u*d-o*l*p+n*u*p+a*l*m-n*c*m,i[3]=h*p*g-c*f*g-h*d*v+l*f*v+c*d*S-l*p*S,i[7]=a*f*g-s*p*g+s*d*v-n*f*v-a*d*S+n*p*S,i[11]=s*c*g-a*h*g-s*l*v+n*h*v+a*l*S-n*c*S,i[15]=a*h*d-s*c*d+s*l*p-n*h*p-a*l*f+n*c*f;var y=r[0]*i[0]+r[1]*i[4]+r[2]*i[8]+r[3]*i[12];if(0==y){var x="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(x);return console.warn(x),this.identity(),this}return this.multiplyScalar(1/y),this},extractBasis:function(e,t,i){var r=this.elements;return e.set(r[0],r[1],r[2]),t.set(r[4],r[5],r[6]),i.set(r[8],r[9],r[10]),this},makeBasis:function(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this},extractPosition:function(e){var t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this},extractRotation:function(t){var i=new e.Vector3;return function(e){var t=this.elements,r=e.elements,n=1/i.set(r[0],r[1],r[2]).length(),a=1/i.set(r[4],r[5],r[6]).length(),s=1/i.set(r[8],r[9],r[10]).length();return t[0]=r[0]*n,t[1]=r[1]*n,t[2]=r[2]*n,t[4]=r[4]*a,t[5]=r[5]*a,t[6]=r[6]*a,t[8]=r[8]*s,t[9]=r[9]*s,t[10]=r[10]*s,this}}(),extractMatrix3:function(t){new e.Vector3;return function(e){var t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[8]=i[8],t[9]=i[9],t[10]=i[10],this}}(),translate:function(e){var t=this.elements,i=e.x,r=e.y,n=e.z;return t[12]=t[0]*i+t[4]*r+t[8]*n+t[12],t[13]=t[1]*i+t[5]*r+t[9]*n+t[13],t[14]=t[2]*i+t[6]*r+t[10]*n+t[14],t[15]=t[3]*i+t[7]*r+t[11]*n+t[15],this},rotateX:function(e){var t=this.elements,i=t[4],r=t[5],n=t[6],a=t[7],s=t[8],o=t[9],l=t[10],c=t[11],h=Math.cos(e),u=Math.sin(e);return t[4]=h*i+u*s,t[5]=h*r+u*o,t[6]=h*n+u*l,t[7]=h*a+u*c,t[8]=h*s-u*i,t[9]=h*o-u*r,t[10]=h*l-u*n,t[11]=h*c-u*a,this},rotateY:function(e){var t=this.elements,i=t[0],r=t[1],n=t[2],a=t[3],s=t[8],o=t[9],l=t[10],c=t[11],h=Math.cos(e),u=Math.sin(e);return t[0]=h*i-u*s,t[1]=h*r-u*o,t[2]=h*n-u*l,t[3]=h*a-u*c,t[8]=h*s+u*i,t[9]=h*o+u*r,t[10]=h*l+u*n,t[11]=h*c+u*a,this},rotateZ:function(e){var t=this.elements,i=t[0],r=t[1],n=t[2],a=t[3],s=t[4],o=t[5],l=t[6],c=t[7],h=Math.cos(e),u=Math.sin(e);return t[0]=h*i+u*s,t[1]=h*r+u*o,t[2]=h*n+u*l,t[3]=h*a+u*c,t[4]=h*s-u*i,t[5]=h*o-u*r,t[6]=h*l-u*n,t[7]=h*c-u*a,this},rotateByAxis:function(e,t){var i=this.elements;if(1===e.x&&0===e.y&&0===e.z)return this.rotateX(t);if(0===e.x&&1===e.y&&0===e.z)return this.rotateY(t);if(0===e.x&&0===e.y&&1===e.z)return this.rotateZ(t);var r=e.x,n=e.y,a=e.z,s=Math.sqrt(r*r+n*n+a*a),o=(r/=s)*r,l=(n/=s)*n,c=(a/=s)*a,h=Math.cos(t),u=Math.sin(t),d=1-h,p=r*n*d,f=r*a*d,m=n*a*d,g=r*u,v=n*u,S=a*u,_=o+(1-o)*h,y=p+S,x=f-v,M=p-S,P=l+(1-l)*h,C=m+g,b=f+v,D=m-g,w=c+(1-c)*h,E=i[0],T=i[1],A=i[2],I=i[3],R=i[4],L=i[5],O=i[6],N=i[7],F=i[8],V=i[9],U=i[10],B=i[11];return i[0]=_*E+y*R+x*F,i[1]=_*T+y*L+x*V,i[2]=_*A+y*O+x*U,i[3]=_*I+y*N+x*B,i[4]=M*E+P*R+C*F,i[5]=M*T+P*L+C*V,i[6]=M*A+P*O+C*U,i[7]=M*I+P*N+C*B,i[8]=b*E+D*R+w*F,i[9]=b*T+D*L+w*V,i[10]=b*A+D*O+w*U,i[11]=b*I+D*N+w*B,this},scale:function(e){var t=this.elements,i=e.x,r=e.y,n=e.z;return t[0]*=i,t[4]*=r,t[8]*=n,t[1]*=i,t[5]*=r,t[9]*=n,t[2]*=i,t[6]*=r,t[10]*=n,t[3]*=i,t[7]*=r,t[11]*=n,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],r=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,Math.max(i,r)))},getScaleOnAxisX:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];return Math.sqrt(t)},getScaleOnAxisY:function(){var e=this.elements,t=e[4]*e[4]+e[5]*e[5]+e[6]*e[6];return Math.sqrt(t)},getScaleOnAxisZ:function(){var e=this.elements,t=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(t)},makeTranslation:function(e,t,i){return this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var i=Math.cos(t),r=Math.sin(t),n=1-i,a=e.x,s=e.y,o=e.z,l=n*a,c=n*s;return this.set(l*a+i,l*s-r*o,l*o+r*s,0,l*s+r*o,c*s+i,c*o-r*a,0,l*o-r*s,c*o+r*a,n*o*o+i,0,0,0,0,1),this},makeScale:function(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this},makeFrustum:function(e,t,i,r,n,a){var s=this.elements,o=2*n/(t-e),l=2*n/(r-i),c=(t+e)/(t-e),h=(r+i)/(r-i),u=-(a+n)/(a-n),d=-2*a*n/(a-n);return s[0]=o,s[4]=0,s[8]=c,s[12]=0,s[1]=0,s[5]=l,s[9]=h,s[13]=0,s[2]=0,s[6]=0,s[10]=u,s[14]=d,s[3]=0,s[7]=0,s[11]=-1,s[15]=0,this},makePerspective:function(t,i,r,n,a,s){var o=r*Math.tan(e.Math.degToRad(.5*t)),l=-o,c=l*i,h=o*i;return a&&(c+=a*=Math.abs(h-c),h+=a),s&&(l+=s*=Math.abs(o-l),o+=s),this.makeFrustum(c,h,l,o,r,n)},makeOrthographic:function(e,t,i,r,n,a){var s=this.elements,o=t-e,l=i-r,c=a-n,h=(t+e)/o,u=(i+r)/l,d=(a+n)/c;return s[0]=2/o,s[4]=0,s[8]=0,s[12]=-h,s[1]=0,s[5]=2/l,s[9]=0,s[13]=-u,s[2]=0,s[6]=0,s[10]=-2/c,s[14]=-d,s[3]=0,s[7]=0,s[11]=0,s[15]=1,this},clone:function(){var t=this.elements;return new e.Matrix4(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15])},setRotation:function(e){var t=this.elements;return t[0]=e[0],t[4]=e[1],t[8]=e[2],t[1]=e[3],t[5]=e[4],t[9]=e[5],t[2]=e[6],t[6]=e[7],t[10]=e[8],this},equals:function(e,t){var i=this.elements,r=e.elements;if(void 0===t){for(var n=0;n<16;n++)if(i[n]!==r[n])return!1}else for(n=0;n<16;n++)if(Math.abs(i[n]-r[n])>t)return!1;return!0}},e.IdentityMatrix=new e.Matrix4,e.extend(e.Matrix4.prototype,{compose:(p=new e.Matrix4,f=new e.Matrix4,function(e,t,i){var r=this.elements;return p.identity(),p.setRotationFromQuaternion(t),f.makeScale(i.x,i.y,i.z),this.multiplyMatrices(p,f),r[12]=e.x,r[13]=e.y,r[14]=e.z,this}),decompose:function(){var t=new e.Vector3,i=new e.Vector3,r=new e.Vector3,n=new e.Matrix4;return function(a,s,o){var l=this.elements;return t.set(l[0],l[1],l[2]),i.set(l[4],l[5],l[6]),r.set(l[8],l[9],l[10]),a=a instanceof e.Vector3?a:new e.Vector3,s=s instanceof e.Quaternion?s:new e.Quaternion,(o=o instanceof e.Vector3?o:new e.Vector3).x=t.length(),o.y=i.length(),o.z=r.length(),a.x=l[12],a.y=l[13],a.z=l[14],n.copy(this),n.elements[0]/=o.x,n.elements[1]/=o.x,n.elements[2]/=o.x,n.elements[4]/=o.y,n.elements[5]/=o.y,n.elements[6]/=o.y,n.elements[8]/=o.z,n.elements[9]/=o.z,n.elements[10]/=o.z,s.setFromRotationMatrix(n),[a,s,o]}}()}),e.Color=function(e){return void 0!==e&&this.set(e),this},e.Color.prototype={constructor:e.Color,r:1,g:1,b:1,set:function(e){switch(typeof e){case"number":this.setHex(e);break;case"string":this.setStyle(e);break;case"object":if(e.length&&e.length>=3){this.setRGB(e[0],e[1],e[2]);break}this.copy(e)}return this},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this},setRGB:function(e,t,i){return this.r=e,this.g=t,this.b=i,this},setHSV:function(e,t,i){return console.log("DEPRECATED: Color's .setHSV() will be removed. Use .setHSL( h, s, l ) instead."),this.setHSL(e,t*i/((e=(2-t)*i)<1?e:2-e),e/2)},setHSL:function(e,t,i){if(0===t)this.r=this.g=this.b=i;else{var r=function(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+6*(t-e)*(2/3-i):e},n=i<=.5?i*(1+t):i+t-i*t,a=2*i-n;this.r=r(a,n,e+1/3),this.g=r(a,n,e),this.b=r(a,n,e-1/3)}return this},setStyle:function(t){if(/^rgb\((\d+),(\d+),(\d+)\)$/i.test(t)){var i=/^rgb\((\d+),(\d+),(\d+)\)$/i.exec(t);return this.r=Math.min(255,parseInt(i[1],10))/255,this.g=Math.min(255,parseInt(i[2],10))/255,this.b=Math.min(255,parseInt(i[3],10))/255,this}if(/^rgb\((\d+)\%,(\d+)\%,(\d+)\%\)$/i.test(t)){i=/^rgb\((\d+)\%,(\d+)\%,(\d+)\%\)$/i.exec(t);return this.r=Math.min(100,parseInt(i[1],10))/100,this.g=Math.min(100,parseInt(i[2],10))/100,this.b=Math.min(100,parseInt(i[3],10))/100,this}if(/^\#([0-9a-f]{6})$/i.test(t)){i=/^\#([0-9a-f]{6})$/i.exec(t);return this.setHex(parseInt(i[1],16)),this}if(/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.test(t)){i=/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(t);return this.setHex(parseInt(i[1]+i[1]+i[2]+i[2]+i[3]+i[3],16)),this}if(/^(\w+)$/i.test(t))return this.setHex(e.ColorKeywords[t]),this},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyToLinear:function(e,t){return t?(this.r=e.r*e.r,this.g=e.g*e.g,this.b=e.b*e.b):(this.r=e.r<.04045?e.r/12.92:Math.pow((e.r+.055)/1.055,2.4),this.g=e.g<.04045?e.g/12.92:Math.pow((e.g+.055)/1.055,2.4),this.b=e.b<.04045?e.b/12.92:Math.pow((e.b+.055)/1.055,2.4)),this},copyGammaToLinear:function(e){return this.r=e.r*e.r,this.g=e.g*e.g,this.b=e.b*e.b,this},copyLinearToGamma:function(e){return this.r=Math.sqrt(e.r),this.g=Math.sqrt(e.g),this.b=Math.sqrt(e.b),this},convertGammaToLinear:function(){var e=this.r,t=this.g,i=this.b;return this.r=e*e,this.g=t*t,this.b=i*i,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:(m={h:0,s:0,l:0},function(){var e,t,i=this.r,r=this.g,n=this.b,a=Math.max(i,r,n),s=Math.min(i,r,n),o=(s+a)/2;if(s===a)e=0,t=0;else{var l=a-s;switch(t=o<=.5?l/(a+s):l/(2-a-s),a){case i:e=(r-n)/l+(r<n?6:0);break;case r:e=(n-i)/l+2;break;case n:e=(i-r)/l+4}e/=6}return m.h=e,m.s=t,m.l=o,m}),getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},offsetHSL:function(e,t,i){var r=this.getHSL();return r.h+=e,r.s+=t,r.l+=i,this.setHSL(r.h,r.s,r.l),this},add:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this},addColors:function(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this},addScalar:function(e){return this.r+=e,this.g+=e,this.b+=e,this},multiply:function(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this},multiplyScalar:function(e){return this.r*=e,this.g*=e,this.b*=e,this},desaturate:function(e){var t=.587*this.g+.299*this.r+.114*this.b,i=Math.min(Math.max(1-e,1e-5),1);return this.r=this.r*i+e*t,this.g=this.g*i+e*t,this.b=this.b*i+e*t,this},saturate:function(e){var t=.587*this.g+.299*this.r+.114*this.b,i=1/Math.min(Math.max(1-e,1e-5),1);return this.r=(this.r-e*t)*i,this.g=(this.g-e*t)*i,this.b=(this.b-e*t)*i,this},alphaBlend:function(e,t){var i=1-(t=Math.min(Math.max(t,0),.99999));return this.r=e.r*t+this.r*i,this.g=e.g*t+this.g*i,this.b=e.b*t+this.b*i,this},negative:function(){return this.r=1-this.r,this.g=1-this.g,this.b=1-this.b,this},lerp:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},equals:function(e){return e.r===this.r&&e.g===this.g&&e.b===this.b},clone:function(){return(new e.Color).setRGB(this.r,this.g,this.b)},toArray:function(){return[this.r,this.g,this.b]}},e.ColorKeywords={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},e}),define("Mesh/ThreeJS_Base",["DS/Mesh/ThreeJS_Base","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Mesh/ThreeJS_Base"),e}),define("DS/Visualization/SectionCappingPassCreator",["UWA/Class"],function(e){"use strict";return e.extend({init:function(){},setupViewer:function(e){}})}),define("Visualization/SectionCappingPassCreator",["DS/Visualization/SectionCappingPassCreator","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SectionCappingPassCreator"),e}),define("DS/VisuDataAccess/Ox4FeatureModeler",["DS/ZipJS/zip"],function(e){"use strict";var t={rootFeature:new function(){this.startupFacade=function(){this.attributes={}},this.featureFacade=new this.startupFacade},fmZipReader:function(t){var i=this;i.archive=new e.BlobReader(t),i.entries=null,i.entriesCount=0,i.entriesRead=0,i.readNextEntry=function(t,r){var n,a=i.entries[i.entriesRead];n=a.filename,a.getData(new e.TextWriter,function(e){t(n,e.target.result),++i.entriesRead==i.entriesCount?r():i.readNextEntry(t,r)})},i.read=function(t,r){e.createReader(i.archive,function(e){e.getEntries(function(e){i.entries=e,i.entriesCount=e.length,i.readNextEntry(t,r)})})}},unstreamDocument:function(e,i){var r={containers:{},links:{},features:{}};t.representations.hasOwnProperty(e.representationId)?console.log("[E] FM: representation already loaded"):(t.representations[e.representationId]={uuid:{},component:{},specobject:{}},new t.fmZipReader(e.stream).read(function(i,n){var a=null!==/91ACA40B\\0\.8\\(data.json)/g.exec(i)?"containers":null!==/D182A118\\0\.8\\(data.json)/g.exec(i)?"links":null!==/BFC0DC13\\0\.8\\(data.json)/g.exec(i)?"features":null;a&&t.unstreamDomain[a]({domainDependencyTable:r[a],externalDependencies:function(e,t){return r[e][t]},representationId:e.representationId,repRef:e.repRef,stream:n})},i))},unstreamDomain:{containers:function(e){var i,r=void 0!==e.resourceName?t.resources[e.resourceName]:t.representations[e.representationId];for(i in r.containers=e.stream?JSON.parse(e.stream):void 0,r.containers)e.domainDependencyTable[i]=r.containers[i]},links:function(e){var i,r=void 0!==e.resourceName?t.resources[e.resourceName]:t.representations[e.representationId];for(i in r.links=e.stream?JSON.parse(e.stream):void 0,r.links){var n=r.links[i];n.relationTarget=e.repRef.SemanticRelations[n.RelationId],e.domainDependencyTable[i]=n}},features:function(e){var i=null;try{i=JSON.parse(e.stream)}catch(e){throw"[F] FM: JSON error)"}var r,n={};for(r in i){var a=i[r];n[r]=new t.Feature(a,n,e)}for(r in i)t.unstreamFeature2(n[r],n,e)}},unstreamFeature2:function(e,i,r){var n,a,s=null!=r.resourceName?t.resources[r.resourceName]:t.representations[r.representationId];for(n in e.data.attributes){var o=e.data.attributes[n],l=o.value instanceof Array?o.value:[o.value];switch(o.type){case"external":if(void 0!==r.representationId)for(a=0;a<l.length;a++)l[a]=null!==l[a]?r.externalDependencies("links",l[a].id):void 0;break;case"component":case"specobject":for(a=0;a<l.length;a++){var c=null!==l[a]?i[l[a].id]:void 0;if(c){l[a]=c.featureFacade;var h=c.data.uuid;if("component"===o.type&&s[o.type][h])throw"[F] FM: AGG error";s[o.type][h]||(s[o.type][h]=[]),s[o.type][h].push({source:e,attrName:n})}}}o.value instanceof Array?Object.freeze(o.value):o.value=l[0]}},Feature:function(e,i,r){var n=this;n.data={properties:e.properties,attributes:e.values,startupProperties:e.startup,name:e.system.name,diezele:e.readonly.diezele,uuid:e.readonly.uuid},e.hasOwnProperty("ancestor")?e.ancestor.hasOwnProperty("resource")?n.data.ancestor=t.rootFeature:n.data.ancestor=i[e.ancestor.id]:n.data.ancestor=t.rootFeature,n.featureFacade=new n.data.ancestor.featureFacade.constructor,n.featureFacade.name=n.data.name,n.featureFacade.attributes=Object.create(n.data.ancestor.featureFacade.attributes);var a;for(a in Object.defineProperty(n.featureFacade,"name",{get:function(){return n.data.name},enumerable:!0}),n.data.attributes)Object.defineProperty(n.featureFacade.attributes,a,function(e){return{get:function(){return t.getValue(n.data.attributes[e])},enumerable:!0}}(a));if(n.data.uuid in t.representations[r.representationId].uuid)throw"[F] FM: uuid already defined in same scope";t.representations[r.representationId].uuid[n.data.uuid]=n},getValue:function(e){var t,i=e.value;switch(e.type){case"external":var r=i instanceof Array?i:[i];for(t=0;t<r.length;t++)r[t]=r[t].relationTarget;!i instanceof Array&&(i=r[0])}return i}};return{init:function(){t.representations={}},loadRepresentation:function(e,i,r,n){t.unstreamDocument({stream:r,representationId:i,repRef:e},n)},loadResource:function(e,i){t.unstreamDocument({stream:i,resourceName:e})},listRootFeatures:function(e){var i,r=[];for(i in t.representations[e].uuid)if(void 0===t.representations[e].component[i]){var n=t.representations[e].uuid[i];r.push(n.featureFacade)}return r},containFeatures:function(e){return t.representations.hasOwnProperty(e)}}}),define("DS/Visualization/ProxyAbstraction",["DS/WAFData/WAFData"],function(e){"use strict";return class{useNoProxy(e){this.proxyUsage=0,this.server=null,this.sport=null,this.withCredentials=e}useProxyDefinedBy(e,t){this.proxyUsage=1,this.server=e,this.sport=t}useUWAProxy(e){this.proxyUsage=2,this.server=null,this.sport=null,this.proxymode=e.proxymode,this.requestsOptions=e.requestsOptions}rewriteUrlUsingProxyDef(e,t,i){var r=e.indexOf("/"),n=e.indexOf("/",r+2);return e.slice(0,r)+"//"+t+":"+i+e.slice(n,e.length)}executeGetHttpRequest(t,i,r,n,a,s){var o,l,c=(o=a,l=t,function(e){o&&o({url:l,type:"LOAD",responseCode:e})});if(2===this.proxyUsage){var h=this.requestsOptions||{};h.headers=h.headers||new Object,s&&(h.headers.Accept=s),h.data&&(h.data.GET=h.data.GET||r),h.method=h.method||"GET",h.timeout=36e5,h.async=!0,h.onComplete=n,h.onFailure=function(e){for(var t=e.message.split('"'),i=null,r=0;r<t.length-1;r++)-1!=t[r].search("return ResponseCode with value")&&(i=parseInt(t[r+1]));i&&c(i)},h.onTimeout=function(e){c(408)},h.type=i,h.proxymode&&(h.authentication=h.proxymode),e.handleRequest(t,h)}else{1===this.proxyUsage&&(t=this.rewriteUrlUsingProxyDef(t,this.server,this.sport));var u=new XMLHttpRequest;u.open("GET",t,!0),u.onload=function(e){var t=u.status;200===t||0===t&&this.response&&this.response.byteLength>0?n(this.response):c(t)},u.onerror=function(e){c(u.status)},u.ontimeout=function(e){c(408)},u.timeout=36e5,this.withCredentials&&(u.withCredentials=!0),"arraybuffer"===i&&(u.responseType=i),"blob"===i&&(u.responseType=i),u.send(r)}}fetchUint8Array(e,t,i,r){return new Promise((n,a)=>{this.executeGetHttpRequest(e,t,i,e=>n(new Uint8Array(e)),a,r)})}}}),define("DS/VisuUnstreamers/UnstreamTaskDriver",["UWA/Class"],function(e){"use strict";var t=e.singleton({init:function(){return this},getTask:function(e,t,i,r){require(["DS/VisuUnstreamers/"+e+"UnstreamTask"],function(e){var n=new e(t,i);r&&r(n)})}});return UWA.namespace("THREEDS/UnstreamTaskDriver",t)}),define("VisuUnstreamers/UnstreamTaskDriver",["DS/VisuUnstreamers/UnstreamTaskDriver","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuUnstreamers/UnstreamTaskDriver"),e}),define("DS/DSMigration/DSMigration",function(){return new function(){this.deprecateModule=function(e){if(console.log("DS AMD module migration : use 'DS/"+e+"' instead of '"+e+"' in your define/require calls. Modules that still reference '"+e+"' :"),requirejs&&requirejs.s&&requirejs.s.contexts&&requirejs.s.contexts._.registry){var t=requirejs.s.contexts._.registry;for(var i in t)if(t[i]&&t[i].depMaps){var r=t[i].depMaps;if(r&&r.length)for(var n=0;n<r.length;++n)r[n]&&r[n].id==e&&console.log("     "+i)}}}}}),define("DS/Visualization/OccurrenceInterfaceFactory",["UWA/Class"],function(e){"use strict";return e.extend({init:function(e,t){this._occurrenceExplorer=e,this.viewer=t},getOccurrenceItf:function(e){var t=e._getUniqueOccurrence(this.viewer);return t?this._occurrenceExplorer.getOccurrenceInterface(t):null},getOccurrenceItfMulti:function(e){var t,i=e._getOccurrences(this.viewer),r=[];for(t=0;t<i.length;t++)r.push(this._occurrenceExplorer.getOccurrenceInterface(i[t]));return r},getUserRootOccurrenceItf:function(){var e=this.viewer.internalSceneGraph.userRoot._occurrences[0];return this._occurrenceExplorer.getOccurrenceInterface(e)}})});for(_shaderChunkBase="DS/MaterialLibs/",_toLoad=["LineBasicLib","MeshBasicLib","MeshLambertLib","MeshPhongLib","ParticleBasicLib","CubeMapLib","FiniteEnvMapLib","FiniteTransitionEnvMapLib","GradientBackgroundLibs","LatLongMapLib","SimpleMapLib"],i=0;i<_toLoad.length;i++)_toLoad[i]=_shaderChunkBase+_toLoad[i];define("DS/Visualization/ShaderLib",_toLoad,function(e,t,i,r,n,a,s,o,l,c,h){"use strict";return{basic:t,lambert:i,phong:r,particle_basic:n,line:e,finiteenvmap:s,gradient2:l.GradientBackgroundLib2,gradient3:l.GradientBackgroundLib3,gradient4:l.GradientBackgroundLib4,latlong:c,cubemap:a,finitetransition:o,simplemap:h}}),define("DS/Shaders/VerticeShaders",["DS/Shaders/DefaultShaders"],function(e){"use strict";var t=["#if defined(USE_TANGENT_BINORMAL)","varying vec3 vTangent;","varying vec3 vBinormal;","#endif"].join("\n"),i=["vec4 mvPosition;","#if defined(USE_SKINNING) && !defined( USE_DISPLACEMENTMAP ) ",e.getModelViewTransformationChunk("mvPosition","skinned"),"#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHTARGETS ) && !defined( USE_DISPLACEMENTMAP )",e.getModelViewTransformationChunk("mvPosition","vec4( morphed, 1.0 )"),"#endif","#if defined(USE_DISPLACEMENTMAP)",e.getModelViewTransformationChunk("mvPosition","vec4( displacedPosition, 1.0 )"),"#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHTARGETS ) && ! defined( USE_DISPLACEMENTMAP )",e.getModelViewTransformationChunk("mvPosition","vec4( position, 1.0 )"),"#endif","mvPosition.w = 1.0;"].join("\n"),r=["ProcessViewTangentSpace(_viewTangentSpace);","mvPosition.xyz = _viewTangentSpace.Position;","#ifdef USE_SIZEATTENUATION","mvPosForAttenuation = mvPosition.xyz;","#endif","#if defined(USE_TANGENT_BINORMAL)","vTangent = _viewTangentSpace.Tangent;","vBinormal = _viewTangentSpace.Binormal;","#endif"].join("\n");return{basic_pars:["varying vec3 vViewPosition;","varying vec3 vNormal;"].join("\n"),tangent_Binormal_pars:t,basic_vertex:[e.model_view_transformation_vertex,e.model_view_normal_vertex,"vNormal = mvNormal;","vViewPosition = normalize(-mvPosition.xyz);","gl_Position = projectionMatrix * mvPosition;"].join("\n"),tangent_Binormal_vertex:["#if defined(USE_TANGENT_BINORMAL)","tangent = _DStangent;","binormal = _DSbinormal;","#ifdef USE_SKINNING","vec3 objectTangent = vec3(skinMatrix * vec4( tangent, 0.0 ));","#else","vec3 objectTangent = tangent;","#endif","vec3 mvTangent;","if (use_normal_matrix)","mvTangent = normalMatrix * objectTangent;","else {",e.getModelViewUnitVectorTransformationChunk("mvTangent","objectTangent"),"}","vTangent = normalize( mvTangent );","#ifdef PDSFX","_viewTangentSpace.Tangent = vTangent;","#endif","#ifdef USE_SKINNING","vec3 objectBinormal = vec3(skinMatrix * vec4( binormal, 0.0 ));","#else","vec3 objectBinormal = binormal;","#endif","vec3 mvBinormal;","if (use_normal_matrix)","mvBinormal = normalMatrix * objectBinormal;","else {",e.getModelViewUnitVectorTransformationChunk("mvBinormal","objectBinormal"),"}","vBinormal = normalize( mvBinormal );","#ifdef PDSFX","_viewTangentSpace.Binormal = vBinormal;","#endif","#endif"].join("\n"),basic_fragment:["float Pi = 3.14159265358979323846264;","vec3 normal = normalize( vNormal );","vec3 viewPosition = normalize( vViewPosition );","normal *= sign( dot( normal, -viewPosition ) );"].join("\n"),tangent_Binormal_pars_fragment:[t,"#if defined(USE_TANGENT_BINORMAL)","void computeGPUTB(in vec3 i_viewPosition,vec3 i_normal,inout vec3 io_tangent,inout vec3 io_binormal){","vec3 p_x = dFdx( -i_viewPosition.xyz );","vec3 p_y = dFdy( -i_viewPosition.xyz );","#if defined( NEEDS_UVTOUSE )","vec2 tc_x = dFdx( uvToUse.st );","vec2 tc_y = dFdy( uvToUse.st );","#else","vec2 tc_x = vec2(0.0);","vec2 tc_y = vec2(0.0);","#endif","float alphaT = step(0.00001, abs(tc_x.y) + abs(tc_y.y));","float alphaB = step(0.00001, abs(tc_x.x) + abs(tc_y.x));","float alphaBT = 1.0 - max(alphaB, alphaT);","tc_x.y = alphaT * tc_x.y - (1.0 - alphaT)*(alphaB * tc_y.x);","tc_y.y = alphaT * tc_y.y + (1.0 - alphaT)*(alphaB * tc_x.x) + alphaBT;","tc_x.x = alphaB * tc_x.x - (1.0 - alphaB)*(alphaT * tc_y.y) + alphaBT;","tc_y.x = alphaB * tc_y.x + (1.0 - alphaB)*(alphaT * tc_x.y);","float texDet = 1.0;","io_tangent = normalize(  p_x * tc_y.y - p_y * tc_x.y );","io_binormal = normalize(  p_y * tc_x.x - p_x * tc_y.x);","vec3 x = cross(i_normal,io_tangent);","io_tangent = normalize(cross(x,i_normal)*texDet);","x = cross(io_binormal,i_normal);","io_binormal = normalize(cross(i_normal,x)*texDet);","}","bool isVectorValid(in vec3 vector){","\treturn (( vector.x < 0.0 || 0.0 < vector.x || vector.x == 0.0 ) && ( vector.y < 0.0 || 0.0 < vector.y || vector.y == 0.0 ) && ( vector.z < 0.0 || 0.0 < vector.z || vector.z == 0.0 ) && length(vector)!=0.0);","}","#endif"].join("\n"),tangent_Binormal_fragment:["#if defined(USE_TANGENT_BINORMAL)","vec3 fragmentTangent;","vec3 fragmentBinormal;","#if defined(PDSFX)","vec3 viewPositionTB = vViewPosition;","vec3 normalTB = _DSvNormal;","#elif defined(DECAL)","vec3 viewPositionTB = dViewPosition;","vec3 normalTB = decalNormal;","#else","vec3 viewPositionTB = vViewPosition;","vec3 normalTB = vNormal;","#endif","#ifdef GPU_TANGENT_BINORMAL","computeGPUTB(viewPositionTB,normalTB,fragmentTangent,fragmentBinormal);","#else","#ifdef PDSFX","\tfragmentTangent =  _DSviewTangent ;","\tfragmentBinormal = _DSviewBinormal ;","#else","\tfragmentTangent = vTangent;","\tfragmentBinormal = vBinormal;","#endif","#endif","#if defined(MAPPING_OPERATOR) && defined(USE_MAPPING_OPERATOR_FRAGMENT) && !defined(DECAL)","if(mappingType>0){","fragmentTangent = normalize( tangent );","fragmentBinormal = normalize( binormal );","if (use_normal_matrix){","fragmentTangent = normalMatrix * fragmentTangent;","fragmentBinormal = normalMatrix * fragmentBinormal;","}else {",e.getModelViewUnitVectorTransformationChunk("fragmentTangent","fragmentTangent"),e.getModelViewUnitVectorTransformationChunk("fragmentBinormal","fragmentBinormal"),"}","}","#endif","if(!isVectorValid(fragmentTangent) || !isVectorValid(fragmentBinormal) ){","computeGPUTB(viewPositionTB,normalTB,fragmentTangent,fragmentBinormal);","}","\ttangent = normalize(fragmentTangent);","\tbinormal = normalize(fragmentBinormal);","#endif"].join("\n"),worldpos_vertex:["#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined( PHYSICALDS ) || defined ( USE_SHADOWMAP )","#if defined(USE_SKINNING) && !defined( USE_DISPLACEMENTMAP )","vec4 worldPosition = modelMatrix * skinned;","#endif","#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING ) && !defined( USE_DISPLACEMENTMAP )","vec4 worldPosition = modelMatrix * vec4( morphed, 1.0 );","#endif","#if defined(USE_DISPLACEMENTMAP)","vec4 worldPosition = modelMatrix * vec4( displacedPosition, 1.0 );","#endif","#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING ) && !defined( USE_DISPLACEMENTMAP )","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","#endif","#endif"].join("\n"),morphtarget_pars_vertex:["#ifdef USE_MORPHTARGETS","#ifndef USE_MORPHNORMALS","uniform float morphTargetInfluences[ 8 ];","#else","uniform float morphTargetInfluences[ 4 ];","#endif","#endif"].join("\n"),morphtarget_vertex:["#ifdef USE_MORPHTARGETS","vec3 morphed = vec3( 0.0 );","morphed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];","morphed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];","morphed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];","morphed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];","#ifndef USE_MORPHNORMALS","morphed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];","morphed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];","morphed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];","morphed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];","#endif","morphed += position;","#endif"].join("\n"),morphnormal_vertex:["#ifdef USE_MORPHNORMALS","vec3 morphedNormal = vec3( 0.0 );","morphedNormal +=  ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];","morphedNormal +=  ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];","morphedNormal +=  ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];","morphedNormal +=  ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];","morphedNormal += normal;","#endif"].join("\n"),skinning_pars_vertex:["#ifdef USE_SKINNING","#ifdef USE_SKINNING_ANGLES","mat4 getMatrixFromEulerAngles(const in vec3 angles, const in vec3 offset) {","float cosx = cos(angles.y);","float cosy = cos(angles.z);","float cosz = cos(angles.x);","float sinx = sin(angles.y);","float siny = sin(angles.z);","float sinz = sin(angles.x);","float a11, a12, a13, a21, a22, a23, a31, a32, a33;","float cosycosz = cosy*cosz;","float sinxsiny = sinx*siny;","a11 = cosycosz - sinxsiny*sinz;","a12 = -cosx*sinz;","a13 = cosz*siny + cosy*sinx*sinz;","a21 = cosz*sinxsiny + cosy*sinz;","a22 = cosx*cosz;","a23 = siny*sinz - cosycosz*sinx;","a31 = -cosx*siny;","a32 = sinx;","a33 = cosx*cosy;","mat4 bone = mat4(","vec4(a11, a21, a31, 0.0),","vec4(a12, a22, a32, 0.0),","vec4(a13, a23, a33, 0.0),","vec4(offset, 1.0));","return bone;","}","#endif","#ifdef IS_MULTI_INSTANCED","uniform sampler2D skinningInstancingMaps[NB_INSTANCING_SKIN_MAPS];","mat4 getBoneMatrix( const in float i ) {","if (i >= 0.0) {","float real_instanceId = instanceId/5.0 -1.0;","#ifdef USE_SKINNING_ANGLES","float matId = real_instanceId * NB_BONES * 2.0 + 2.0 * i;","#else","float matId = real_instanceId * NB_BONES * 4.0 + 4.0 * i;","#endif","int texId = int(floor(matId/(MAX_MAP_SIZE*MAX_MAP_SIZE)));","float dx, dy;","float x, y;","float xyInTex = matId - float(texId) * (MAX_MAP_SIZE*MAX_MAP_SIZE);","if (texId == NB_INSTANCING_SKIN_MAPS - 1) {","dx = 1.0 / LAST_INSTANCING_SKIN_MAP_SIZE_X;","dy = 1.0 / LAST_INSTANCING_SKIN_MAP_SIZE_Y;","y = floor(xyInTex/LAST_INSTANCING_SKIN_MAP_SIZE_X);","x = xyInTex - y*LAST_INSTANCING_SKIN_MAP_SIZE_X;","} else {","dx = 1.0 / MAX_MAP_SIZE;","dy = 1.0 / MAX_MAP_SIZE;","y = floor(xyInTex/MAX_MAP_SIZE);","x = xyInTex - y*MAX_MAP_SIZE;","}","vec3 v0, v1, v2, v3;","v0 = texture2D( skinningInstancingMaps[texId], vec2( dx * ( x + 0.5 ), dy * ( y + 0.5 ) ) ).xyz;","v1 = texture2D( skinningInstancingMaps[texId], vec2( dx * ( x + 1.5 ), dy * ( y + 0.5 ) ) ).xyz;","#ifndef USE_SKINNING_ANGLES","v2 = texture2D( skinningInstancingMaps[texId], vec2( dx * ( x + 2.5 ), dy * ( y + 0.5 ) ) ).xyz;","v3 = texture2D( skinningInstancingMaps[texId], vec2( dx * ( x + 3.5 ), dy * ( y + 0.5 ) ) ).xyz;","#endif","#ifdef USE_SKINNING_ANGLES","vec3 offset = v0;","vec3 angles = v1;","mat4 bone = getMatrixFromEulerAngles(angles, offset);","#else","mat4 bone = mat4(vec4(v0, 0.0), vec4(v1, 0.0), vec4(v2, 0.0), vec4(v3, 1.0));","#endif","return bone;","} else ","return mat4(1.0);","}","#else","uniform sampler2D skinningMap;","mat4 getBoneMatrix( const in float i ) {","if (i >= 0.0) {","#ifdef USE_SKINNING_ANGLES","float j = i * 2.0;","#else","float j = i * 4.0;","#endif","float x = mod( j, N_BONE_PIXEL_X );","float y = floor( j / N_BONE_PIXEL_X );","const float dx = 1.0 / N_BONE_PIXEL_X;","const float dy = 1.0 / N_BONE_PIXEL_Y;","y = dy * ( y + 0.5 );","vec3 v0 = texture2D( skinningMap, vec2( dx * ( x + 0.5 ), y ) ).xyz;","vec3 v1 = texture2D( skinningMap, vec2( dx * ( x + 1.5 ), y ) ).xyz;","#ifndef USE_SKINNING_ANGLES","vec3 v2 = texture2D( skinningMap, vec2( dx * ( x + 2.5 ), y ) ).xyz;","vec3 v3 = texture2D( skinningMap, vec2( dx * ( x + 3.5 ), y ) ).xyz;","#endif","#ifdef USE_SKINNING_ANGLES","vec3 offset = v0;","vec3 angles = v1;","mat4 bone = getMatrixFromEulerAngles(angles, offset);","#else","mat4 bone = mat4(vec4(v0, 0.0), vec4(v1, 0.0), vec4(v2, 0.0), vec4(v3, 1.0));","#endif","return bone;","} else ","return mat4(1.0);","}","#endif","#endif"].join("\n"),skinbase_vertex:["#ifdef USE_SKINNING","mat4 boneMatX = getBoneMatrix( skinIndex.x );","mat4 boneMatY = getBoneMatrix( skinIndex.y );","mat4 boneMatZ = getBoneMatrix( skinIndex.z );","mat4 boneMatW = getBoneMatrix( skinIndex.w );","mat4 skinMatrix = skinWeight.x * boneMatX;","skinMatrix \t+= skinWeight.y * boneMatY;","skinMatrix \t+= skinWeight.z * boneMatZ;","skinMatrix \t+= skinWeight.w * boneMatW;","#endif"].join("\n"),skinning_vertex:["#ifdef USE_SKINNING","#ifdef USE_MORPHTARGETS","vec4 skinVertex = vec4( morphed, 1.0 );","#else","vec4 skinVertex = vec4( position, 1.0 );","#endif","vec4 skinned  = skinMatrix * skinVertex;","#endif"].join("\n"),skinnormal_vertex:["#ifdef USE_SKINNING","#ifdef USE_MORPHNORMALS","vec4 skinnedNormal = skinMatrix * vec4( morphedNormal, 0.0 );","#else","vec4 skinnedNormal = skinMatrix * vec4( normal, 0.0 );","#endif","#endif"].join("\n"),default_vertex:[i,"#ifdef PDSFX","_viewTangentSpace.Position = mvPosition.xyz;",r,"#endif","gl_Position = projectionMatrix * mvPosition;"].join("\n"),default_vertex_with_normal:[i].join("\n"),defaultnormal_vertex:["vec3 objectNormal;","#if defined(USE_SKINNING) && !defined( USE_DISPLACEMENTMAP )","objectNormal = skinnedNormal.xyz;","#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHNORMALS ) && !defined( USE_DISPLACEMENTMAP )","objectNormal = morphedNormal;","#endif","#if defined( USE_DISPLACEMENTMAP )","objectNormal = displacedNormal;","#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHNORMALS ) && !defined( USE_DISPLACEMENTMAP )","objectNormal = normal;","#endif","#ifdef FLIP_SIDED","objectNormal = -objectNormal;","#endif","if (length(objectNormal) < 1e-6) {","if (projectionMatrix[3][3] > 0.5) {","objectNormal = vec3(0.0,0.0,1.0);","} else {","objectNormal = normalize(-mvPosition.xyz);","}","#if defined(BILLBOARD) || defined(FIXED_SIZE)","setSimpleNodeData();","#endif","objectNormal = (vec4(objectNormal, 0.0) * modelViewMatrix).xyz;","#if defined(BILLBOARD)","objectNormal = (vec4(objectNormal, 0.0) * simpleNodeData.billboardMatrix).xyz;","#endif","objectNormal = normalize(objectNormal);","}","vec3 transformedNormal;","if (use_normal_matrix)","transformedNormal = normalMatrix * objectNormal;","else {",e.getModelViewUnitVectorTransformationChunk("transformedNormal","objectNormal"),"}","transformedNormal = normalize(transformedNormal);","#ifdef PDSFX","_viewTangentSpace.Position = mvPosition.xyz;","_viewTangentSpace.Normal = transformedNormal;",r,"#endif","gl_Position = projectionMatrix * mvPosition;"].join("\n")}}),define("DS/VisuDataAccess/Ox4StreamLoader",["DS/VisuDataAccess/Ox4PLMDataHelper","DS/VisuDataAccess/Ox4TicketGeneratorTask","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/WAFData/WAFData"],function(e,t,i,r){"use strict";var n=null,a=null,s=function(e,t,i){var r='<?xml version="1.0" encoding="utf-8"?>\n';return r+='<executeSequence xmlns="http://www.3ds.com/xmql/query">\n',r+="\t<execute>\n",r+="\t\t<function>query_bus</function>\n",r+="\t\t<version>2.0.0</version>\n",r+="\t\t<params>\n",r+='\t\t\t<param name="type">'+t+"</param>\n",r+='\t\t\t<param name="name">*</param>\n',r+='\t\t\t<param name="revision">*</param>\n',r+='\t\t\t<param name="vault">*</param>\n',r+='\t\t\t<param name="where">physicalid=='+e+"</param>\n",r+='\t\t\t<param name="select">'+JSON.stringify(i)+"</param>\n",r+='\t\t\t<param name="dump">,</param>\n',r+="\t\t</params>\n",r+="\t</execute>\n",r+="</executeSequence>\n"},o=function(e,t,r){var n,o,l,c,h,u,d,p=null;e.IRPC?(n=e.physicalid,o=e.boType,l=e.format,c=e.role,h=e.lateType,u=e.persistancyType,d=e.persistancyName,p={mqlCmd:s(n,o,["attribute[StreamDescriptors]","format.file.name","format.file.store"]),parseTCLRow:function(e){for(var t=/{{.*} {.*} {.*} {{(.*)}} {({.*})} {({.*})}}/.exec(e),i=t[1],r=t[2],a=t[3],s=i.split(":"),o=[],p=0;p<s.length;p++){var f=/SDv2\((.*),'(.*)',(.*),.*,.*,'(.*)','(.*)'\)/.exec(s[p]);o.push({format:f[1],role:f[2],lateType:f[3],persistancyType:f[4],persistancyName:f[5]})}for(var m=/{([^{}]*)}/g,g=null,v=[];null!==(g=m.exec(r));)v.push(g[1]);for(var S=[];null!==(g=m.exec(a));)S.push(g[1]);var _={name:"",store:""};for(p=0;p<o.length;p++){var y=o[p];void 0!==l&&l!==y.format||void 0!==c&&c!==y.role||void 0!==h&&h!==y.lateType||void 0!==u&&u!==y.persistancyType||void 0!==d&&d!==y.persistancyName||(""===_.name?(_.name=n+"_'"+y.role+"'."+y.format,y.persistancyName&&(_.name+="="+y.persistancyName),_.format=y.format):(_.tooManyFilesError=!0,_.name=""))}if(""!==_.name)for(p=0;""===_.store&&p<v.length;p++)_.name===v[p]&&(_.store=S[p]);return""!==_.name&&""!==_.store||(_.noStreamRetrieved=!0,_.name="",_.store=""),_}}):p=function(e,t,i){return{mqlCmd:s(e,t,["format["+i+"].file.name","format["+i+"].file.store"]),parseTCLRow:function(e){var t=/{{.*} {.*} {.*} {{([^{}]*)}} {{([^{}]*)}}}/.exec(e);return null===t?{tooManyFilesError:!0}:{name:t[1],store:t[2]}}}}(e.physicalid,e.boType,e.format);(new i).executePostHttpRequest(a.xmqlServiceUri(),"application/xml",p.mqlCmd,function(i){var n=p.parseTCLRow(i);n.tooManyFilesError?r("Too many streams retrieved"):n.noStreamRetrieved?r("No stream retrieved"):(n.physicalid=e.physicalid,void 0===n.format&&void 0!==e.format&&(n.format=e.format),void 0!==n.format?t(n):r("Stream format has to be specified"))})};return{Load:function(s){var l,c;null!==n&&null!==a&&a.url===s.serverUrl||(a={rawmode:!1,url:s.serverUrl},c=(l=a).url,l.xmqlServiceUri=function(){return c+"/i3dx/services/xmql"},l.threedexpServiceUri=function(){return c},i.useUWAProxy({proxymode:"passport"}),n=new e(a)),o(s,function(e){!function(e,r,s){var o=n.transformSelectedFileIntoTicketRequest(e.physicalid,e.format,e.store,e.name),l=new t(o,a);(new i).asyncTransformFCSUrlIntoRealUrl(l.generateRequest(),!1,function(e,t){r(t)})}(e,function(e){!function(e,t,i,n){if("posthttp"==e.slice(0,8)){var a=e.indexOf(":postparams:"),s=e.slice(9,a),o={cors:!0,timeout:1e5,method:"POST",data:e.slice(a+12,e.length),responseType:t,async:!0,headers:{Accept:"text/plain"},onComplete:i,onFailure:n};r.authenticatedRequest(s,o)}}(e,s.streamType,s.onStreamLoaded,s.onError)},s.onError)},s.onError)}}}),define("DS/VisuLoaders/ThreeDXResourcesLibrary",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t=function(){this.refImages={},this.imagesToRequest=new Map};return t.prototype.addImageToRequest=function(e,t,i){this.imagesToRequest.set(e,{map:t,format:i})},t.prototype.getImageToRequest=function(e){return this.imagesToRequest.get(e)},t.prototype.removeImageToRequest=function(e){this.imagesToRequest.delete(e)},t.prototype.getRequestedUids=function(){var e=[];return this.imagesToRequest.forEach(function(t,i){e.push(i)}),e},t.prototype.getIdFromParameters=function(e){var t="";return void 0!==e.wrapS&&(t+="wS"+e.wrapS),void 0!==e.wrapT&&(t+="wT"+e.wrapT),void 0!==e.anisotropy&&(t+="anis"+e.anisotropy),void 0!==e.minFilter&&(t+="minF"+e.minFilter),void 0!==e.magFilter&&(t+="magF"+e.magFilter),e.borderColor&&(t+="borderColor"+e.borderColor.x+"-"+e.borderColor.y+"-"+e.borderColor.z+"-"+e.borderColor.w),void 0!==e.repeat&&(t+="rpt"+e.repeat.x+"-"+e.repeat.y),void 0!==e.sRGB&&(t+="srgb"+e.sRGB),"id"+t.hashCode()},t.prototype.getIdFromTexture=function(e){var t="";return void 0!==e.wrapS&&(t+="wS"+e.wrapS),void 0!==e.wrapT&&(t+="wT"+e.wrapT),void 0!==e.anisotropy&&(t+="anis"+e.anisotropy),void 0!==e.minFilter&&(t+="minF"+e.minFilter),void 0!==e.magFilter&&(t+="magF"+e.magFilter),e.borderColor&&(t+="borderColor"+e.borderColor.x+"-"+e.borderColor.y+"-"+e.borderColor.z+"-"+e.borderColor.w),void 0!==e.repeat&&(t+="rpt"+e.repeat.x+"-"+e.repeat.y),void 0!==e.sRGB&&(t+="srgb"+e.sRGB),"id"+t.hashCode()},t.prototype.getImage=function(e){var t=this.refImages[e];return t?t.values().next().value:null},t.prototype.addImage=function(e,t){if(!t)return!1;var i=this.getIdFromTexture(t),r=this.refImages[e];return!r&&((r=new Map).set(i,t),this.refImages[e]=r,!0)},t.prototype.removeImage=function(e){delete this.refImages[e]},t.prototype.getTexture=function(e,t){var i=this.getIdFromParameters(t),r=this.refImages[e];return r&&r.has(i)?r.get(i):null},t.prototype.addTexture=function(e,t,i){if(!t)return!1;var r=this.getIdFromParameters(i),n=this.refImages[e];return n||(n=new Map,this.refImages[e]=n),n.set(r,t),this.subscribeToImageLoading(t,n),!0},t.prototype.subscribeToImageLoading=function(t,i){i.forEach(function(i,r,n){if(i===t)return;let a=function(i){t.image=i.image,i.loadEndStatus===e.AssetLoadingStatus.READY&&(t.loadEndStatus=e.AssetLoadingStatus.READY),t.format=i.format,t.type=i.type,t.needsUpdate=!0,i.hdr&&(t.minFilter=i.minFilter,t.magFilter=i.magFilter)};if(i.loadEndStatus==e.AssetLoadingStatus.READY)a(i);else if(i.loadEndStatus!==e.AssetLoadingStatus.LOADING)return;i.onLoadCallbacks.push(a)})},t.prototype.debug=function(){for(var e in console.log("=============== ThreeDXResourcesLibrary ==================="),this.refImages){var t=this.refImages[e];t&&(console.log("image "+e+" :"),t.forEach(function(e,t,i){console.log("["+t+"] = "+e.id+" status "+e.loadEndStatus)}))}console.log("===========================================================")},t}),define("DS/Shaders/EnvMapShaders",["DS/Shaders/DefaultShaders"],function(e){"use strict";return{envmap_pars_fragment:["#if defined( USE_MAP_HDR ) || defined( USE_ENVMAP_HDR )","uniform vec2 mapHDRSize;","uniform vec2 envMapHDRSize;","uniform float envMapHDRToMipsRatio;",e.rgbe_sample_methods,"#endif","#ifdef USE_ENVMAP","const float PI = 3.1415926535898;","const float INV_PI = 0.31830988618;","uniform float reflectivity;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","uniform sampler2D envMap;","uniform mat4 ambienceMatrix;","uniform float envMapExposureSpecular;","uniform float envMapExposureDiffuse;","#else","uniform samplerCube envMap;","#endif","uniform int combine;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHYSICALDS )","uniform bool useRefract;","uniform float refractionRatio;","#if defined( USE_REFRACTIONRATIOMAP )","uniform sampler2D refractionRatioMap;","#endif","#else","varying vec3 vReflect;","#endif","#endif"].join("\n"),envmap_fragment:["#ifdef USE_ENVMAP","vec3 reflectVec;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","#ifndef DECAL","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","#else","vec3 cameraToVertex = normalize( dWorldPosition - cameraPosition );","#endif","vec3 worldNormal = normalize( vec3( vec4( normal, 0.0 ) * viewMatrix ) );","if ( useRefract ) {","#if defined( USE_REFRACTIONRATIOMAP )","reflectVec = refract( cameraToVertex, worldNormal, texture2D(refractionRatioMap, uvToUse).r );","#else","reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );","#endif","} else { ","reflectVec = reflect( cameraToVertex, worldNormal );","}","#else","reflectVec = vReflect;","#endif","vec3 flipReflectVec;","#ifdef DOUBLE_SIDED","float flipNormal = 1.0;","flipReflectVec = flipNormal * reflectVec;","#else","flipReflectVec = reflectVec;","#endif","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_LIGHTPROBEMAP","flipReflectVec = vec3(flipReflectVec.y, flipReflectVec.z, flipReflectVec.x);","flipReflectVec = (ambienceMatrix*vec4(flipReflectVec,0.0)).xyz;","float probeR = INV_PI * acos( flipReflectVec.z ) / length(flipReflectVec.xy);","#ifdef USE_ENVMAP_HDR","vec2 texelSizeEnvMap = vec2(1.0 / envMapHDRSize);","vec4 cubeColor = texture2DBilinearFromRGBE( envMap, 0.5 * (probeR * flipReflectVec.xy + 1.0), envMapHDRSize, texelSizeEnvMap );","#else","vec4 cubeColor = texture2D( envMap, 0.5 * (probeR * flipReflectVec.xy + 1.0) );","#endif","#else","flipReflectVec = (ambienceMatrix*vec4(flipReflectVec,0.0)).xyz;","float phi = atan(flipReflectVec.y, flipReflectVec.x);","float theta = acos(flipReflectVec.z);","#if defined(USE_ENVMAP_HDR) && !defined(USE_ENVMAP_RGB_HDR)","vec2 texelSizeEnvMap = vec2(1.0 / envMapHDRSize);","vec4 cubeColor = envMapExposureSpecular * texture2DBilinearFromRGBE( envMap, vec2(0.5 + 0.5 * INV_PI * phi, 1.0 - INV_PI * theta), envMapHDRSize, texelSizeEnvMap );","#else","vec4 cubeColor = envMapExposureSpecular * texture2D( envMap, vec2(0.5 + 0.5 * INV_PI * phi, 1.0 - INV_PI * theta) );","#endif","#endif","#else","#if defined(CUBEMAP_ZUP)","vec4 cubeColor = textureCube( envMap, vec3(-flipReflectVec.x, flipReflectVec.zy) );","#else","vec4 cubeColor = textureCube( envMap, flipReflectVec );","#endif","#endif","if ( combine == 1 ) {","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );","} else if ( combine == 2 ) {","gl_FragColor.xyz += cubeColor.xyz * specularStrength * reflectivity;","} else {","gl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );","}","#endif"].join("\n"),envmap_pars_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP ) && ! defined( PHYSICALDS )","varying vec3 vReflect;","uniform float refractionRatio;","uniform bool useRefract;","#if defined( USE_REFRACTIONRATIOMAP )","uniform sampler2D refractionRatioMap;","#endif","#endif"].join("\n"),envmap_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP ) && ! defined( PHYSICALDS )","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","worldNormal = normalize( worldNormal );","vec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );","if ( useRefract ) {","#if defined( USE_REFRACTIONRATIOMAP )","vReflect = refract( cameraToVertex, worldNormal, texture2D(refractionRatioMap, uvToUse).r );","#else","vReflect = refract( cameraToVertex, worldNormal, refractionRatio );","#endif","} else {","vReflect = reflect( cameraToVertex, worldNormal );","}","#endif"].join("\n"),envMaps_pars:["varying vec3 vReflect;"].join("\n"),envMaps_vertex:["vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vec3 objectNormal = normal;","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","worldNormal = normalize( worldNormal );","vec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );","vReflect = reflect( cameraToVertex, worldNormal );"].join("\n"),environment_fragment:["dirAmbient += vec3(0.34);","vec3 reflected_DS= vReflect;","const mat3 DS_to_OpenGL = mat3(","\t0.0, 1.0, 0.0,","\t0.0, 0.0,-1.0,","\t1.0, 0.0, 0.0",");","vec3 reflected_OpenGL = reflected_DS * DS_to_OpenGL;","vec4 texture_environment_lookup = textureCube(ReflectionCUBEMap,-reflected_OpenGL);","vec3 environment_lookup          = texture_environment_lookup.rgb;"].join("\n"),environment_blur_fragment:["dirAmbient += vec3(0.34);","vec3 reflected_DS= vReflect;","const mat3 DS_to_OpenGL = mat3(","\t0.0, 1.0, 0.0,","\t0.0, 0.0,-1.0,","\t1.0, 0.0, 0.0",");","vec3 reflected_OpenGL = reflected_DS * DS_to_OpenGL;","float ddWeight = mix(0.75,0.0,pow(refl_gloss,2.0));","vec3 reflecteddx = ddWeight*dFdx(reflected_OpenGL);","vec3 reflecteddy = ddWeight*dFdy(reflected_OpenGL);","float anisotropyRefl = 1.0/mix(0.3,1.0,pow(refl_gloss,4.0));","float anisotropydd = length(0.5*(reflecteddx+reflecteddy));","float anisotropyWeight = mix(20.0*anisotropydd,0.0,pow(refl_gloss,5.0));","float bias = anisotropydd * anisotropyRefl;","vec4 texture_environment_lookup = textureCube(ReflectionCUBEMap,-reflected_OpenGL,bias );","#ifdef USE_TANGENT_BINORMAL","if(refl_gloss<1.0) {","texture_environment_lookup  += textureCube( ReflectionCUBEMap, normalize(-reflected_OpenGL-anisotropyWeight*tangent),bias );","texture_environment_lookup  += textureCube( ReflectionCUBEMap, normalize(-reflected_OpenGL+anisotropyWeight*tangent),bias );","texture_environment_lookup  += textureCube( ReflectionCUBEMap, normalize(-reflected_OpenGL-anisotropyWeight*binormal),bias  );","texture_environment_lookup  += textureCube( ReflectionCUBEMap, normalize(-reflected_OpenGL+anisotropyWeight*binormal),bias  );","texture_environment_lookup *= 0.2;","}","#endif","vec3 environment_lookup          = texture_environment_lookup.rgb;"].join("\n")}}),define("DS/Shaders/ShadowingShaders",["DS/Shaders/DefaultShaders"],function(e){"use strict";return{shadowmap_pars_fragment:["#if defined (USE_SHADOWMAP) || defined(USE_SHADOWMAP_CUBE)","float unpackDepthESM( const in vec4 rgba_depth ) {","\tfloat depth = unpackRGB(rgba_depth.xyz) * pow(10.0,rgba_depth.w*255.0);","\treturn depth;","}","float unpackDepth( const in vec4 rgba_depth ) {","return unpackRGBA(rgba_depth);","}","float randomValue(vec3 scale, float seed) {","return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","#endif","#ifdef USE_SHADOWMAP","uniform sampler2D shadowMap[ MAX_SHADOWS ];","#ifdef USE_TRANSPARENTSHADOWMAP","uniform sampler2D transparentShadowMap[ MAX_SHADOWS ];","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColorNoIntensity[ MAX_DIR_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColorNoIntensity[ MAX_SPOT_LIGHTS ];","#endif","#endif","uniform vec2 shadowMapSize[ MAX_SHADOWS ];","uniform float shadowDarkness[ MAX_SHADOWS ];","uniform float shadowBias[ MAX_SHADOWS ];","#ifdef USE_SUBSURFACE","uniform float shadowMapNear[ MAX_SHADOWS ];","uniform float shadowMapFar[ MAX_SHADOWS ];","#endif","#define SHADOWS_DIR_END MAX_SHADOWS_DIR","#define SHADOWS_SPOT_START SHADOWS_DIR_END","#define SHADOWS_SPOT_END SHADOWS_SPOT_START + MAX_SHADOWS_SPOT","#define SHADOWS_DIR_IBL_START SHADOWS_SPOT_END","#define SHADOWS_DIR_IBL_END SHADOWS_DIR_IBL_START + MAX_SHADOWS_DIR_IBL","#define SHADOWS_CASTABLE_END SHADOWS_DIR_IBL_START","#if defined(SHADOWMAP_TYPE_PCF_POISSON) ||defined(SHADOWMAP_TYPE_PCF_INTERPOL)","#if defined(SHADOWMAP_QUALITY_MEDIUM)","uniform vec2 poissonDisk[25];","const int poissonCount = 25;","const float poissonInvSamples = 0.04;","#elif defined(SHADOWMAP_QUALITY_HIGH)","uniform vec2 poissonDisk[49];","const int poissonCount = 49;","const float poissonInvSamples = 0.020408;","#else","uniform vec2 poissonDisk[9];","const int poissonCount = 9;","const float poissonInvSamples = 0.111111;","#endif","#endif","#ifndef DECAL","varying vec4 vShadowCoord[ MAX_SHADOWS ];","#else","vec4 vShadowCoord[ MAX_SHADOWS ];","uniform mat4 shadowMatrix[ MAX_SHADOWS ];","uniform vec3 shadowCameraPosition[ MAX_SHADOWS ];","uniform vec3 lowPartShadowCameraPosition[ MAX_SHADOWS ];","#endif","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","float esmLinearSampling(sampler2D shadowMap, vec2 coord,vec2 shadowMapSize,vec2 invSize) {","#ifdef USE_UINT_ESM","   vec2 fractCoord = fract(coord*shadowMapSize + 0.5);","   vec2 centroidUV = (coord*shadowMapSize - fractCoord) * invSize;","   float lb = unpackDepthESM(texture2D(shadowMap, centroidUV));","   float lt = unpackDepthESM(texture2D(shadowMap, centroidUV + vec2(0.0, invSize.y)));","   float rb = unpackDepthESM(texture2D(shadowMap, centroidUV + vec2(invSize.x, 0.0)));","   float rt = unpackDepthESM(texture2D(shadowMap, centroidUV + invSize));","   float a = mix(lb, lt, fractCoord.y);","   float b = mix(rb, rt, fractCoord.y);","   return mix(a, b, fractCoord.x);","#else","\treturn texture2D(shadowMap, coord).x;","#endif","}","float compESM(sampler2D shadowMap, vec2 coord, float depthFrag, vec2 shadowMapSize, vec2 shadowPixelSize) {","float result = esmLinearSampling(shadowMap, coord,shadowMapSize,shadowPixelSize) * exp(-80.0 * depthFrag);","result *= result * result;","return result;","}","float texture2DESMToPCFCompare(sampler2D shadowMap, vec2 coord, float depthFrag, vec2 shadowMapSize, vec2 shadowPixelSize) {","float depthShadowMap = log(esmLinearSampling(shadowMap, coord,shadowMapSize,shadowPixelSize)) / 80.0;","return step(depthShadowMap, depthFrag);","}","float texture2DShadowESMLerp(sampler2D shadowMap, vec2 shadowMapSize, vec2 shadowPixelSize, vec2 coord, float depthFrag) {","vec2 fractCoord = fract(coord * shadowMapSize + 0.5);","vec2 centroidUV = (coord * shadowMapSize - fractCoord) * shadowPixelSize;","float lb = clamp(compESM(shadowMap, centroidUV, depthFrag,shadowMapSize,shadowPixelSize), 0.0, 1.0);","float lt = clamp(compESM(shadowMap, centroidUV + vec2(0.0, shadowPixelSize.y), depthFrag,shadowMapSize,shadowPixelSize), 0.0, 1.0);","float rb = clamp(compESM(shadowMap, centroidUV + vec2(shadowPixelSize.x, 0.0), depthFrag,shadowMapSize,shadowPixelSize), 0.0, 1.0);","float rt = clamp(compESM(shadowMap, centroidUV + shadowPixelSize, depthFrag,shadowMapSize,shadowPixelSize), 0.0, 1.0);","float a = mix(lb, lt, fractCoord.y);","float b = mix(rb, rt, fractCoord.y);","return 1.0 - mix(a, b, fractCoord.x);","}","#endif","float texture2DCompare(sampler2D shadowMap, vec2 coord, float depthFrag) {","float depthShadowMap = unpackDepth(texture2D(shadowMap, coord));","return step(depthShadowMap, depthFrag);","}","float texture2DShadowLerp(sampler2D shadowMap, vec2 shadowMapSize, vec2 shadowPixelSize, vec2 coord, float depthFrag) {","vec2 fractCoord = fract(coord * shadowMapSize + 0.5);","vec2 centroidUV = (coord * shadowMapSize - fractCoord) * shadowPixelSize;","float lb = texture2DCompare(shadowMap, centroidUV, depthFrag);","float lt = texture2DCompare(shadowMap, centroidUV + vec2(0.0, shadowPixelSize.y), depthFrag);","float rb = texture2DCompare(shadowMap, centroidUV + vec2(shadowPixelSize.x, 0.0), depthFrag);","float rt = texture2DCompare(shadowMap, centroidUV + shadowPixelSize, depthFrag);","float a = mix(lb, lt, fractCoord.y);","float b = mix(rb, rt, fractCoord.y);","return mix(a, b, fractCoord.x);","}","#if defined( SHADOWMAP_TYPE_PCF )","float getExposurePCF(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize) {","float shadow = 0.0;","#if defined( SHADOWMAP_QUALITY_LOW )","const float shadowDelta = 1.0 / 9.0;","const int fetchCount = 3;","#elif defined( SHADOWMAP_QUALITY_MEDIUM )","const float shadowDelta = 1.0 / 25.0;","const int fetchCount = 5;","#elif defined( SHADOWMAP_QUALITY_HIGH )","const float shadowDelta = 1.0 / 49.0;","const int fetchCount = 7;","#endif","float xPixelOffset = 1.0 / shadowMapSize.x;","float yPixelOffset = 1.0 / shadowMapSize.y;","float dx0 = -1.25 * float((fetchCount-1)/2) *xPixelOffset;","float dy0 = -1.25 * float((fetchCount-1)/2) *yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","float fDepth;","vec2 delta = vec2(dx0,dy0);","for  (int i = 0; i < fetchCount; i ++) {","for  (int j = 0; j < fetchCount; j ++) {","shadow += shadowDelta * texture2DCompare(shadowMap,shadowCoord.xy + delta,shadowCoord.z);","delta.y +=dy1;","}","delta.y =dy0;","delta.x +=dx1;","}","return shadow;","}","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","float getExposurePCFSoft(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize){","float shadow = 0.0;","float xPixelOffset = 1.0 / shadowMapSize.x;","float yPixelOffset = 1.0 / shadowMapSize.y;","float dx0 = -1.0 * xPixelOffset;","float dy0 = -1.0 * yPixelOffset;","float dx1 = 1.0 * xPixelOffset;","float dy1 = 1.0 * yPixelOffset;","mat3 shadowKernel;","vec2 delta = vec2(dx0,dy0);","for  (int i = 0; i < 3; i ++) {","for  (int j = 0; j < 3; j ++) {","shadowKernel[i][j]= 0.25 * texture2DCompare(shadowMap,shadowCoord.xy + delta,shadowCoord.z);","delta.y +=dy1;","}","delta.y =dy0;","delta.x +=dx1;","}","vec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * shadowMapSize.xy );","shadowKernel[0] = mix( shadowKernel[1], shadowKernel[0], fractionalCoord.x );","shadowKernel[1] = mix( shadowKernel[2], shadowKernel[1], fractionalCoord.x );","vec4 shadowValues;","shadowValues.x = mix( shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y );","shadowValues.y = mix( shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y );","shadowValues.z = mix( shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y );","shadowValues.w = mix( shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y );","shadow = dot( shadowValues, vec4( 1.0 ) );","return shadow;","}","#elif defined( SHADOWMAP_TYPE_PCF_INTERPOL )","float getExposurePCFInterpol(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize){","float shadow = 0.0;","const float dimFilter = 4.0;","const float sizeFilter = dimFilter * dimFilter;","const float shadowDelta = 1.0 / sizeFilter;","vec2 shadowPixelSize = 1.0 / shadowMapSize;","for (float xFilter = -0.5 * dimFilter + 0.5; xFilter <= 0.5 * dimFilter; xFilter += 1.0) {","for (float yFilter = -0.5 * dimFilter + 0.5; yFilter <= 0.5 * dimFilter; yFilter += 1.0) {","shadow += texture2DShadowLerp(shadowMap, shadowMapSize, shadowPixelSize, shadowCoord.xy + shadowPixelSize * vec2(xFilter, yFilter), shadowCoord.z);","}","}","shadow *= shadowDelta;","return shadow;","}","#elif defined( SHADOWMAP_TYPE_PCF_POISSON )","float getExposurePCFPoisson(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize) {","float shadow = 0.0;","float xPixelOffset = 1.0/ shadowMapSize.x;","float yPixelOffset = 1.0 / shadowMapSize.y;","float randAngle = randomValue(shadowCoord.xyz,fract(shadowCoord.x*shadowCoord.y)) * 2.0 * 3.14159265359;","for  (int i = 0; i < poissonCount; i ++) {","vec2 p = poissonDisk[i];","float posX = (cos(randAngle)*p.x-sin(randAngle)*p.y)*xPixelOffset;","float posY = (sin(randAngle)*p.x+cos(randAngle)*p.y)*yPixelOffset;","shadow += texture2DCompare(shadowMap,shadowCoord.xy + vec2(posX,posY),shadowCoord.z);","}","shadow *= poissonInvSamples;","return shadow;","}","#elif defined( SHADOWMAP_TYPE_PCF_OPTI )","float getExposurePCFOpti(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize) {","float shadow = 0.0;","vec2 fractCoord = fract(shadowCoord.xy * shadowMapSize + 0.5);","vec2 pixelOffset = vec2(1.0) / shadowMapSize;","vec2 base_uv = (shadowCoord.xy * shadowMapSize - fractCoord) * pixelOffset;","#if defined(SHADOWMAP_QUALITY_LOW)","float uw0 = (3.0 - 2.0 * fractCoord.x);","float uw1 = (1.0 + 2.0 * fractCoord.x);","float u0 = ((2.0 - fractCoord.x) / uw0 - 1.0) * pixelOffset.x;","float u1 = (fractCoord.x / uw1 + 1.0) * pixelOffset.x;","float vw0 = (3.0 - 2.0 * fractCoord.y);","float vw1 = (1.0 + 2.0 * fractCoord.y);","float v0 = ((2.0 - fractCoord.y) / vw0 - 1.0) * pixelOffset.y;","float v1 = (fractCoord.y / vw1 + 1.0) * pixelOffset.y;","shadow += uw0 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v0), shadowCoord.z);","shadow += uw1 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v0), shadowCoord.z);","shadow += uw0 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v1), shadowCoord.z);","shadow += uw1 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v1), shadowCoord.z);","shadow *= 0.0625;","#elif defined(SHADOWMAP_QUALITY_MEDIUM)","float uw0 = (4.0 - 3.0 * fractCoord.x);","float uw1 = 7.0;","float uw2 = (1.0 + 3.0 * fractCoord.x);","float u0 = ((3.0 - 2.0 * fractCoord.x) / uw0 - 2.0) * pixelOffset.x;","float u1 = ((3.0 + fractCoord.x) / uw1) * pixelOffset.x;","float u2 = (fractCoord.x / uw2 + 2.0) * pixelOffset.x;","float vw0 = (4.0 - 3.0 * fractCoord.y);","float vw1 = 7.0;","float vw2 = (1.0 + 3.0 * fractCoord.y);","float v0 = ((3.0 - 2.0 * fractCoord.y) / vw0 - 2.0) * pixelOffset.y;","float v1 = ((3.0 + fractCoord.y) / vw1) * pixelOffset.y;","float v2 = (fractCoord.y / vw2 + 2.0) * pixelOffset.y;","shadow += uw0 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v0), shadowCoord.z);","shadow += uw1 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v0), shadowCoord.z);","shadow += uw2 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v0), shadowCoord.z);","shadow += uw0 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v1), shadowCoord.z);","shadow += uw1 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v1), shadowCoord.z);","shadow += uw2 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v1), shadowCoord.z);","shadow += uw0 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v2), shadowCoord.z);","shadow += uw1 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v2), shadowCoord.z);","shadow += uw2 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v2), shadowCoord.z);","shadow *= 0.0069444;","#elif defined(SHADOWMAP_QUALITY_HIGH)","float uw0 = (5.0 * fractCoord.x - 6.0);","float uw1 = (11.0 * fractCoord.x - 28.0);","float uw2 = -(11.0 * fractCoord.x + 17.0);","float uw3 = -(5.0 * fractCoord.x + 1.0);","float u0 = ((4.0 * fractCoord.x - 5.0) / uw0 - 3.0) * pixelOffset.x;","float u1 = ((4.0 * fractCoord.x - 16.0) / uw1 - 1.0) * pixelOffset.x;","float u2 = (-(7.0 * fractCoord.x + 5.0) / uw2 + 1.0) * pixelOffset.x;","float u3 = (-fractCoord.x / uw3 + 3.0) * pixelOffset.x;","float vw0 = (5.0 *fractCoord.y - 6.0);","float vw1 = (11.0 *fractCoord.y - 28.0);","float vw2 = -(11.0 *fractCoord.y + 17.0);","float vw3 = -(5.0 *fractCoord.y + 1.0);","float v0 = ((4.0 *fractCoord.y - 5.0) / vw0 - 3.0) * pixelOffset.y;","float v1 = ((4.0 *fractCoord.y - 16.0) / vw1 - 1.0) * pixelOffset.y;","float v2 = (-(7.0 *fractCoord.y + 5.0) / vw2 + 1.0) * pixelOffset.y;","float v3 = (-fractCoord.y / vw3 + 3.0) * pixelOffset.y;","shadow += uw0 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v0), shadowCoord.z) ;","shadow += uw1 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v0), shadowCoord.z);","shadow += uw2 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v0), shadowCoord.z);","shadow += uw3 * vw0 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u3,v0), shadowCoord.z);","shadow += uw0 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v1), shadowCoord.z);","shadow += uw1 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v1), shadowCoord.z);","shadow += uw2 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v1), shadowCoord.z);","shadow += uw3 * vw1 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u3,v1), shadowCoord.z);","shadow += uw0 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v2), shadowCoord.z);","shadow += uw1 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v2), shadowCoord.z);","shadow += uw2 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v2), shadowCoord.z);","shadow += uw3 * vw2 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u3,v2), shadowCoord.z);","shadow += uw0 * vw3 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0,v3), shadowCoord.z);","shadow += uw1 * vw3 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1,v3), shadowCoord.z);","shadow += uw2 * vw3 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2,v3), shadowCoord.z);","shadow += uw3 * vw3 * texture2DShadowLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u3,v3), shadowCoord.z);","shadow *= 0.0003698225;","#endif","return shadow;","}","#elif defined( SHADOWMAP_TYPE_ESM )","float getExposureESM(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize) {","float shadow = 0.0;","float depthFragOffset = shadowCoord.z;","vec2 pixelOffset = 1.0 / shadowMapSize.xy;","shadow = compESM(shadowMap, shadowCoord.xy, depthFragOffset,shadowMapSize,pixelOffset);","float zMaxNeighbor = 0.0;","vec2 coordDetect = shadowCoord.xy + vec2(-pixelOffset.x, pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, esmLinearSampling(shadowMap, coordDetect,shadowMapSize,pixelOffset));","coordDetect = shadowCoord.xy + vec2(pixelOffset.x, pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, esmLinearSampling(shadowMap, coordDetect,shadowMapSize,pixelOffset));","coordDetect = shadowCoord.xy + vec2(-pixelOffset.x, -pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, esmLinearSampling(shadowMap, coordDetect,shadowMapSize,pixelOffset));","coordDetect = shadowCoord.xy + vec2(pixelOffset.x, -pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, esmLinearSampling(shadowMap, coordDetect,shadowMapSize,pixelOffset));","coordDetect = shadowCoord.xy + vec2(pixelOffset.x, 0.0);","zMaxNeighbor = max(zMaxNeighbor, esmLinearSampling(shadowMap, coordDetect,shadowMapSize,pixelOffset));","coordDetect = shadowCoord.xy + vec2(0.0, pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, esmLinearSampling(shadowMap, coordDetect,shadowMapSize,pixelOffset));","coordDetect = shadowCoord.xy + vec2(-pixelOffset.x, 0.0);","zMaxNeighbor = max(zMaxNeighbor, esmLinearSampling(shadowMap, coordDetect,shadowMapSize,pixelOffset));","coordDetect = shadowCoord.xy + vec2(0.0, -pixelOffset.y);","zMaxNeighbor = max(zMaxNeighbor, esmLinearSampling(shadowMap, coordDetect,shadowMapSize,pixelOffset));","zMaxNeighbor = log(zMaxNeighbor) * 0.0125;","if(zMaxNeighbor < 0.9999999 && (shadowCoord.z + 0.015) < zMaxNeighbor) {","shadow = 0.0;","vec2 fractCoord = fract(shadowCoord.xy * shadowMapSize + 0.5);","vec2 base_uv = (shadowCoord.xy * shadowMapSize - fractCoord) * pixelOffset;","float uw0 = (4.0 - 3.0 * fractCoord.x);","float uw1 = 7.0;","float uw2 = (1.0 + 3.0 * fractCoord.x);","float u0 = ((3.0 - 2.0 * fractCoord.x) / uw0 - 2.0) * pixelOffset.x;","float u1 = ((3.0 + fractCoord.x) / uw1) * pixelOffset.x;","float u2 = (fractCoord.x / uw2 + 2.0) * pixelOffset.x;","float vw0 = (4.0 - 3.0 * fractCoord.y);","float vw1 = 7.0;","float vw2 = (1.0 + 3.0 * fractCoord.y);","float v0 = ((3.0 - 2.0 * fractCoord.y) / vw0 - 2.0) * pixelOffset.y;","float v1 = ((3.0 + fractCoord.y) / vw1) * pixelOffset.y;","float v2 = (fractCoord.y / vw2 + 2.0) * pixelOffset.y;","shadow += uw0 * vw0 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0, v0), depthFragOffset);","shadow += uw1 * vw0 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1, v0), depthFragOffset);","shadow += uw2 * vw0 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2, v0), depthFragOffset);","shadow += uw0 * vw1 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0, v1), depthFragOffset);","shadow += uw1 * vw1 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1, v1), depthFragOffset);","shadow += uw2 * vw1 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2, v1), depthFragOffset);","shadow += uw0 * vw2 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0, v2), depthFragOffset);","shadow += uw1 * vw2 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1, v2), depthFragOffset);","shadow += uw2 * vw2 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u2, v2), depthFragOffset);","shadow *= 0.0069444;","shadow = clamp(shadow * 2.0, 0.0, 1.0);","} else {","shadow *= shadow * shadow;","shadow = 1.0 - clamp(shadow, 0.0, 1.0);","}","return shadow;","}","#elif defined( SHADOWMAP_TYPE_ESM_IMPROVED )","float getExposureESMImproved(sampler2D shadowMap,vec3 shadowCoord, vec2 shadowMapSize) {","float shadow = 0.0;","float depthFragOffset = shadowCoord.z;","vec2 uv = shadowCoord.xy * shadowMapSize;","vec2 pixelOffset = 1.0 / shadowMapSize.xy;","vec2 base_uv = floor(uv + 0.5);","vec2 fractCoord = uv + 0.5 - base_uv;","base_uv = (base_uv - 0.5) * pixelOffset;","float uw0 = (3.0 - 2.0 * fractCoord.x);","float uw1 = (1.0 + 2.0 * fractCoord.x);","float u0 = ((2.0 - fractCoord.x) / uw0 - 1.0) * pixelOffset.x;","float u1 = (fractCoord.x / uw1 + 1.0 ) * pixelOffset.x;","float vw0 = (3.0 - 2.0 * fractCoord.y);","float vw1 = (1.0 + 2.0 * fractCoord.y);","float v0 = ((2.0 - fractCoord.y) / vw0 - 1.0) * pixelOffset.y;","float v1 = (fractCoord.y / vw1 + 1.0) * pixelOffset.y;","shadow += uw0 * vw0 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0, v0), depthFragOffset);","shadow += uw1 * vw0 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1, v0), depthFragOffset);","shadow += uw0 * vw1 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u0, v1), depthFragOffset);","shadow += uw1 * vw1 * texture2DShadowESMLerp(shadowMap, shadowMapSize, pixelOffset, base_uv + vec2(u1, v1), depthFragOffset);","shadow *= 0.0625;","shadow = clamp(shadow * 1.5, 0.0, 1.0);","return shadow;","}","#endif","float getExposure(vec4 vShadowCoord,sampler2D shadowMap,float shadowBias,vec2 shadowMapSize) {","vec3 shadowCoord = vShadowCoord.xyz / vShadowCoord.w;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );","float exposureResult = 0.0;","bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","bool frustumTest = all( frustumTestVec );","if ( frustumTest ) {","shadowCoord.z += shadowBias;","#if defined( SHADOWMAP_TYPE_PCF )","exposureResult = getExposurePCF(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","exposureResult = getExposurePCFSoft(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_PCF_INTERPOL )","exposureResult = getExposurePCFInterpol(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_PCF_POISSON )","exposureResult = getExposurePCFPoisson(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_PCF_OPTI )","exposureResult = getExposurePCFOpti(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_ESM )","exposureResult = getExposureESM(shadowMap,shadowCoord,shadowMapSize);","#elif defined( SHADOWMAP_TYPE_ESM_IMPROVED )","exposureResult = getExposureESMImproved(shadowMap,shadowCoord,shadowMapSize);","#else","exposureResult = texture2DCompare(shadowMap,shadowCoord.xy,shadowCoord.z);","#endif","}","return max(1.0-exposureResult,0.0);","}","getExposureFromIndexPlaceholder","#ifdef SHADOWMAP_CASCADE","float getExposureCascaded(vec4 vShadowCoord[MAX_SHADOWS],sampler2D shadowMap[MAX_SHADOWS],float shadowBias[MAX_SHADOWS],vec2 shadowMapSize[MAX_SHADOWS],inout vec4 transparentExposure) {","float exposure = 1.0;","int inFrustumCount = 0;","#ifdef SHADOWMAP_DEBUG","vec3 frustumColors[3];","frustumColors[0] = vec3( 1.0, 0.5, 0.0 );","frustumColors[1] = vec3( 0.0, 1.0, 0.8 );","frustumColors[2] = vec3( 0.0, 0.5, 1.0 );","#endif","cascadedunrolledloop","return exposure;","}","#endif","#endif","#ifdef USE_SHADOWMAP_CUBE","uniform samplerCube shadowMapCube[ MAX_SHADOWS_CUBE ];","#ifdef USE_TRANSPARENTSHADOWMAP","uniform samplerCube transparentShadowMapCube[ MAX_SHADOWS_CUBE ];","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColorNoIntensity[ MAX_POINT_LIGHTS ];","#endif","#endif","uniform float shadowDarknessCube[ MAX_SHADOWS_CUBE ];","uniform float shadowBiasCube[ MAX_SHADOWS_CUBE ];","uniform float shadowNearCube[ MAX_SHADOWS_CUBE ];","uniform float shadowFarCube[ MAX_SHADOWS_CUBE ];","uniform float shadowMapSizeCube[ MAX_SHADOWS_CUBE ];","uniform vec3 shadowPointPosition[ MAX_SHADOWS_CUBE ];","float textureCubeCompare(samplerCube shadowMap, vec3 coord, float depthFrag) {","float depthShadowMap = unpackDepth(textureCube(shadowMap, coord));","return step(depthShadowMap, depthFrag);","}","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","float esmLinearSamplingCube(samplerCube shadowMap, vec3 coord,float shadowMapSize) {","#ifdef USE_UINT_ESM","\tvec3 absCoord = abs(coord);","\tfloat mainComp = max(max(absCoord.x,absCoord.y),absCoord.z);","\tvec3 mainDir = step(vec3(mainComp),absCoord);","\tif(dot(mainDir,vec3(1.0))>1.0){","\t\treturn unpackDepthESM(textureCube(shadowMap, coord));","\t}else{","\t\tfloat smSize=shadowMapSize; ","\t\tvec2 uv;","\t\tvec3 uv3;","\t\tfloat lengthRatio;","\t\tif(mainDir.x == 1.0){","\t\t\tuv = coord.yz;","\t\t\tlengthRatio = abs(coord.x);","\t\t}else if(mainDir.y == 1.0){","\t\t\tuv = coord.xz;","\t\t\tlengthRatio = abs(coord.y);","\t\t}else{","\t\t\tuv = coord.xy;","\t\t\tlengthRatio = abs(coord.z);","\t\t}","\t\tuv/=lengthRatio;","\t\tuv = (uv+vec2(1.0))/vec2(2.0);","\t\tvec2 invSize = vec2(1.0/smSize);","   \tvec2 fractCoord = fract(uv*smSize + vec2(0.5));","   \tvec2 centroidUV = (uv*smSize - fractCoord) * invSize;","\t\tvec2 ltUv =centroidUV + vec2(0.0, invSize.y);","\t\tvec2 rbUv =centroidUV + vec2(invSize.x, 0.0);","\t\tvec2 rtUv =centroidUV + invSize;","\t\tcentroidUV = (centroidUV*2.0)-1.0;","\t\tltUv = (ltUv*2.0)-1.0;","\t\trbUv = (rbUv*2.0)-1.0;","\t\trtUv = (rtUv*2.0)-1.0;","\t\tcentroidUV *= lengthRatio;","\t\tltUv *= lengthRatio;","\t\trbUv *= lengthRatio;","\t\trtUv *= lengthRatio;","   \tvec3 centroidCoord;","\t\tvec3 ltCoord;","\t\tvec3 rbCoord;","\t\tvec3 rtCoord;","\t\tif(mainDir.x == 1.0){","   \t\tcentroidCoord = normalize(vec3(coord.x,centroidUV));","\t\t\tltCoord = normalize(vec3(coord.x,ltUv));","\t\t\trbCoord = normalize(vec3(coord.x,rbUv));","\t\t\trtCoord = normalize(vec3(coord.x,rtUv));","\t\t}else if(mainDir.y == 1.0){","   \t\tcentroidCoord = normalize(vec3(centroidUV.x,coord.y,centroidUV.y));","\t\t\tltCoord = normalize(vec3(ltUv.x,coord.y,ltUv.y));","\t\t\trbCoord = normalize(vec3(rbUv.x,coord.y,rbUv.y));","\t\t\trtCoord = normalize(vec3(rtUv.x,coord.y,rtUv.y));","\t\t}else{","   \t\tcentroidCoord = normalize(vec3(centroidUV,coord.z));","\t\t\tltCoord = normalize(vec3(ltUv,coord.z));","\t\t\trbCoord = normalize(vec3(rbUv,coord.z));","\t\t\trtCoord = normalize(vec3(rtUv,coord.z));","\t\t}","   \tfloat lb = unpackDepthESM(textureCube(shadowMap, centroidCoord));","   \tfloat lt = unpackDepthESM(textureCube(shadowMap, ltCoord));","   \tfloat rb = unpackDepthESM(textureCube(shadowMap, rbCoord));","   \tfloat rt = unpackDepthESM(textureCube(shadowMap, rtCoord));","   \tfloat a = mix(lb, rb, fractCoord.x);","   \tfloat b = mix(lt, rt, fractCoord.x);","   \treturn mix(a, b, fractCoord.y);","   }","#else","\treturn textureCube(shadowMap, coord).x;","#endif","}","float compESMCube(samplerCube shadowMap, vec3 coord, float depthFrag,float shadowMapSize) {","float result = esmLinearSamplingCube(shadowMap, coord,shadowMapSize) * exp(-80.0 * depthFrag);","result *= result * result * result * result;","result = clamp(result,0.0,1.0);","return 1.0-result;","}","#endif","#if defined (SHADOWMAP_TYPE_PCF_OPTI) || defined (SHADOWMAP_TYPE_PCF_POISSON) || defined (SHADOWMAP_TYPE_PCF)","float getExposureCubePCF(vec3 normPointVector,float shadowMapSize,samplerCube shadowMapCube,float depth) {","vec3 rndseed = vec3(12.9898,78.233,45.5432);","vec3 randomDir = vec3( dot(normPointVector,rndseed) , dot(normPointVector.yzx,rndseed) , dot(normPointVector.zxy,rndseed) );","randomDir = fract(sin(randomDir) * 43758.5453);","float pixelSize = 2.0 / shadowMapSize;","vec3 xvec = normalize(cross(normPointVector,randomDir))* pixelSize *1.1;","vec3 yvec = normalize(cross(normPointVector,xvec))* pixelSize *1.1;","float inShadow = 0.0;","inShadow += textureCubeCompare(shadowMapCube,normPointVector+xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+xvec-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-xvec-yvec,depth);","#if defined(SHADOWMAP_QUALITY_HIGH) || defined(SHADOWMAP_QUALITY_MEDIUM)","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*xvec-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*xvec-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*yvec+xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*yvec-xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*yvec+xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*yvec-xvec,depth);","#endif","#if defined(SHADOWMAP_QUALITY_HIGH)","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*xvec-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*xvec+yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*xvec-yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*yvec+xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+3.0*yvec-xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*yvec+xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-3.0*yvec-xvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*xvec+2.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector+2.0*xvec-2.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*xvec-2.0*yvec,depth);","inShadow += textureCubeCompare(shadowMapCube,normPointVector-2.0*xvec+2.0*yvec,depth);","#endif","#if defined(SHADOWMAP_QUALITY_LOW)","inShadow = inShadow/ 8.0;","#elif defined(SHADOWMAP_QUALITY_MEDIUM)","inShadow = inShadow/ 20.0;","#else","inShadow = inShadow/ 36.0;","#endif","return inShadow;","}","#endif","#ifdef DECAL","vec4 decalShadowCubeWorldPosition;","#endif","float getExposure(vec3 pointPosition,samplerCube shadowMap,float shadowBias,float shadowMapSize,float shadowNear, float shadowFar) {","vec4 lPosition =  vec4( pointPosition, 1.0 );","#ifdef DECAL","vec3 pointVector = decalShadowCubeWorldPosition.xyz-lPosition.xyz;","#else","vec3 pointVector = vWorldPosition.xyz-lPosition.xyz;","#endif","float exposureResult = 0.0;","vec3 absVector = abs(pointVector);","float localZComp = max(absVector.x,max(absVector.y,absVector.z));","float normZComp = (shadowFar+shadowNear)/(shadowFar-shadowNear)-(2.0*shadowFar*shadowNear)/(shadowFar-shadowNear)/localZComp;","normZComp = (normZComp + 1.0) * 0.5;","float depthCube = normZComp +shadowBias;","vec3 normPointVector = normalize( pointVector );","#if defined (SHADOWMAP_TYPE_PCF_OPTI) || defined (SHADOWMAP_TYPE_PCF_POISSON) || defined (SHADOWMAP_TYPE_PCF)","exposureResult = getExposureCubePCF(normPointVector,shadowMapSize,shadowMap,depthCube);","#elif defined (SHADOWMAP_TYPE_ESM)","exposureResult = compESMCube(shadowMap, normPointVector, depthCube,shadowMapSize);","#else","exposureResult = textureCubeCompare(shadowMap,normPointVector,depthCube);","#endif","return 1.0-exposureResult;","}","getExposureFromIndexCubePlaceholder","#endif"].join("\n"),shadowmap_fragment:["float shadowExposure = 1.0;","vec4 transparentExposure = vec4(1.0);","#if defined(USE_SHADOWMAP) || defined(USE_SHADOWMAP_CUBE)","#ifdef USE_SHADOWMAP","float currentExposure = 1.0;","vec4 currentTransparentExposure = vec4(1.0);","#ifdef SHADOWMAP_CASCADE","currentExposure  = getExposureCascaded(vShadowCoord,shadowMap,shadowBias,shadowMapSize,currentTransparentExposure);","#else","currentExposure = getExposure(vShadowCoord[ 0 ],shadowMap[ 0 ],shadowBias[ 0 ],shadowMapSize[ 0 ]);","#ifdef USE_TRANSPARENTSHADOWMAP","currentTransparentExposure = getTransparentExposureFromIndex(0);","#endif","#endif","if (currentExposure < 1.0) {","shadowExposure *=1.0 - (shadowDarkness[ 0 ] * (1.0-currentExposure));","}","transparentExposure *= vec4(1.0) - (shadowDarkness[ 0 ] * (vec4(1.0)-currentTransparentExposure));","#ifdef SHADOWMAP_CASCADE","if (MAX_SHADOWS>MAX_SHADOWS_DIR){","for( int i = MAX_SHADOWS_DIR; i < MAX_SHADOWS; i ++ ) {","float currentExposure = 1.0;","currentExposure = getExposureFromIndex(i);","#ifdef USE_TRANSPARENTSHADOWMAP","currentTransparentExposure = getTransparentExposureFromIndex(i);","#endif","if (currentExposure < 1.0) {","shadowExposure *=1.0 - (shadowDarkness[ i ] * (1.0-currentExposure));","}","transparentExposure *= vec4(1.0) - (shadowDarkness[ i ] * (vec4(1.0)-currentTransparentExposure));","}","}","#else","if (MAX_SHADOWS>1){","for( int i = 1; i < MAX_SHADOWS; i ++ ) {","float currentExposure = 1.0;","currentExposure = getExposureFromIndex(i);","#ifdef USE_TRANSPARENTSHADOWMAP","currentTransparentExposure = getTransparentExposureFromIndex(i);","#endif","if (currentExposure < 1.0) {","shadowExposure *=1.0 - (shadowDarkness[ i ] * (1.0-currentExposure));","}","transparentExposure *= vec4(1.0) - (shadowDarkness[ i ] * (vec4(1.0)-currentTransparentExposure));","}","}","#endif","#endif","#ifdef USE_SHADOWMAP_CUBE","for ( int i = 0; i < MAX_SHADOWS_CUBE; i ++ ) {","float currentExposure = getExposureFromIndexCube(i);","vec4 currentTransparentExposure = vec4(1.0);","#ifdef USE_TRANSPARENTSHADOWMAP","currentTransparentExposure = getTransparentExposureFromIndexCube(i);","#endif","if (currentExposure < 1.0) {","shadowExposure *= 1.0 - (shadowDarknessCube[ i ] * (1.0-currentExposure));","}","transparentExposure *= vec4(1.0) - (shadowDarknessCube[ i ] * (vec4(1.0)-currentTransparentExposure));","}","#endif","#endif","gl_FragColor.xyz *= transparentExposure.rgb * min(shadowExposure,transparentExposure.a);"].join("\n"),shadowmap_pars_vertex:["#ifdef USE_SHADOWMAP","#ifndef DECAL","varying vec4 vShadowCoord[ MAX_SHADOWS ];","uniform mat4 shadowMatrix[ MAX_SHADOWS ];","uniform vec3 shadowCameraPosition[ MAX_SHADOWS ];","uniform vec3 lowPartShadowCameraPosition[ MAX_SHADOWS ];","#endif","#endif"].join("\n"),shadowmap_vertex:["#if defined(USE_SHADOWMAP) && !defined(DECAL)","#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined( PHYSICALDS ) || defined ( USE_SHADOWMAP )","#if defined(USE_SKINNING) && !defined( USE_DISPLACEMENTMAP )","vec4 oldPosition = skinned;","#endif","#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING ) && !defined( USE_DISPLACEMENTMAP )","vec4 oldPosition = vec4( morphed, 1.0 );","#endif","#if defined(USE_DISPLACEMENTMAP)","vec4 oldPosition = vec4( displacedPosition, 1.0 );","#endif","#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING ) && !defined( USE_DISPLACEMENTMAP )","vec4 oldPosition = vec4( position, 1.0 );","#endif","#endif","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = computeShadowCoord(oldPosition.xyz, shadowMatrix[i],shadowCameraPosition[i],lowPartShadowCameraPosition[i]);","}","#endif"].join("\n")}}),define("DS/Shaders/MappingShaders",["DS/Shaders/DefaultShaders"],function(e){"use strict";return{map_pars_vertex:["#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","varying vec2 vUv;","uniform vec2 offsetBumpMap;","uniform vec2 repeatBumpMap;",e.map_pars_vertex,"#endif"].join("\n"),map_pars_fragment:["#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","varying vec2 vUv;",e.map_pars_fragment,"#endif","#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_vertex:["#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","vUv = uv * repeatBumpMap + offsetBumpMap;","#if defined (MAPPING_OPERATOR)","#if defined (USE_MAPPING_OPERATOR_VERTEX)","vUv = applyMappingOperator(vUv, position, normal);","#else","localPosition=position;","localNormal=normal;","#endif","#endif","#endif"].join("\n"),uvmapping_fragment:["#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","uvToUse = vUv;","#if defined (USE_MAPPING_OPERATOR_FRAGMENT) && defined (MAPPING_OPERATOR)","uvToUse = applyMappingOperator(uvToUse, localPosition, localNormal);","#endif","#ifdef PDSFX","_uvToUse = uvToUse;","#endif","#endif"].join("\n"),map_fragment:["#if defined(USE_MAP) || defined(PDSFX_USE_MAP)","vec4 texelColor = vec4(1.0, 1.0, 1.0, 1.0);","#ifdef USE_MAP","#if defined(USE_ENVMAP_HDR) && !defined(USE_ENVMAP_RGB_HDR)","vec2 texelSizeMap = vec2(1.0 / mapHDRSize);","texelColor = texture2DBilinearFromRGBE( map, uvToUse, mapHDRSize, texelSizeMap );","#else","texelColor = texture2D( map, uvToUse );","#ifdef GAMMA_INPUT","texelColor.xyz = convertToLinear(texelColor.xyz);","#endif","#endif","#endif","#ifdef PDSFX_USE_MAP","vec4 pdsfxDiffTexel = _ComputeDiffuseTexel();","#ifdef GAMMA_INPUT","pdsfxDiffTexel.xyz = convertToLinear(pdsfxDiffTexel.xyz);","#endif","texelColor *= pdsfxDiffTexel;","#endif","gl_FragColor = gl_FragColor * texelColor;","#endif"].join("\n")}}),define("DS/Shaders/ClipShaders",["DS/Shaders/DefaultShaders"],function(e){"use strict";return{clip_pars_vertex:["#ifdef USE_CLIPPINGPLANES","uniform lowp int nbClipPlanes;","uniform vec4 clipPlaneEquations[ 6 ];","varying float clipDist[ 6 ];","vec4 getClipPlaneEquation(in int index) {","if (index == 0) return clipPlaneEquations[0];","if (index == 1) return clipPlaneEquations[1];","if (index == 2) return clipPlaneEquations[2];","if (index == 3) return clipPlaneEquations[3];","if (index == 4) return clipPlaneEquations[4];","if (index == 5) return clipPlaneEquations[5];","return clipPlaneEquations[0];","}","#endif","#ifdef USE_CLIPPINGPOLYGON","// UNROLL_CLIPPINGPOLYGON","varying vec2 extrusionPlaneUV/*#i*/[NB_CLIPPINGPOLYGON/*#i*/];","uniform vec3 extrusionPlaneU/*#i*/[NB_CLIPPINGPOLYGON/*#i*/];","uniform vec3 extrusionPlaneV/*#i*/[NB_CLIPPINGPOLYGON/*#i*/];","// UNROLL_CLIPPINGPOLYGON_END","#endif","#ifdef USE_CLIPPINGCYLINDER","// UNROLL_CLIPPINGCYLINDER","varying vec2 cylinderAxisUV/*#i*/;","uniform vec3 cylinderCenter/*#i*/;","uniform vec3 cylinderAxisU/*#i*/;","uniform vec3 cylinderAxisV/*#i*/;","// UNROLL_CLIPPINGCYLINDER_END","#endif","#ifdef USE_SCISSORPOLYGON","// UNROLL_SCISSORPOLYGON","#ifndef PDSFX","  varying vec4 scissorClipPos;","#endif","// UNROLL_SCISSORPOLYGON_END","#endif",""].join("\n"),clip_vertex:["#ifdef USE_CLIPPINGPLANES","if(nbClipPlanes > 0) {","clipDist[ 0 ] = dot( mvPosition.xyz, clipPlaneEquations[ 0 ].xyz ) + clipPlaneEquations[ 0 ].w;","clipDist[ 1 ] = dot( mvPosition.xyz, clipPlaneEquations[ 1 ].xyz ) + clipPlaneEquations[ 1 ].w;","clipDist[ 2 ] = dot( mvPosition.xyz, clipPlaneEquations[ 2 ].xyz ) + clipPlaneEquations[ 2 ].w;","clipDist[ 3 ] = dot( mvPosition.xyz, clipPlaneEquations[ 3 ].xyz ) + clipPlaneEquations[ 3 ].w;","clipDist[ 4 ] = dot( mvPosition.xyz, clipPlaneEquations[ 4 ].xyz ) + clipPlaneEquations[ 4 ].w;","clipDist[ 5 ] = dot( mvPosition.xyz, clipPlaneEquations[ 5 ].xyz ) + clipPlaneEquations[ 5 ].w;","}","#endif","#if defined(USE_CLIPPINGPOLYGON) || defined(USE_SCISSORPOLYGON)","vec3 positionWorld = (modelMatrix*vec4(position.xyz, 1)).xyz;","#endif","#ifdef USE_CLIPPINGPOLYGON","// UNROLL_CLIPPINGPOLYGON","for(int i=0; i < NB_CLIPPINGPOLYGON; i++) {","  extrusionPlaneUV/*#i*/[i] = vec2(dot(mvPosition.xyz, extrusionPlaneU/*#i*/[i]), dot(mvPosition.xyz, extrusionPlaneV/*#i*/[i]));","}","// UNROLL_CLIPPINGPOLYGON_END","#endif","#ifdef USE_SCISSORPOLYGON","#ifndef PDSFX","  scissorClipPos = gl_Position;","#endif","#endif","#ifdef USE_CLIPPINGCYLINDER","// UNROLL_CLIPPINGCYLINDER","vec3 posWorldCylinder/*#i*/ = (modelMatrix * vec4(position.xyz, 1)).xyz - cylinderCenter/*#i*/;","cylinderAxisUV/*#i*/ = vec2(dot(posWorldCylinder/*#i*/, cylinderAxisU/*#i*/), dot(posWorldCylinder/*#i*/, cylinderAxisV/*#i*/));","// UNROLL_CLIPPINGCYLINDER_END","#endif",""].join("\n"),clip_pars_fragment:["#ifdef USE_CLIPPINGPLANES","uniform lowp int nbClipPlanes;","varying float clipDist[ 6 ];","uniform int clipPlaneActive[ 6 ];","uniform lowp float clipFrontOpacity;","uniform lowp float clipBackOpacity;","#endif","#ifdef USE_CLIPPINGPOLYGON","// UNROLL_CLIPPINGPOLYGON","uniform sampler2D polygonPoints/*#i*/;","uniform int polygonSize/*#i*/[NB_CLIPPINGPOLYGON];","varying vec2 extrusionPlaneUV/*#i*/[NB_CLIPPINGPOLYGON];","// UNROLL_CLIPPINGPOLYGON_END","#endif","#ifdef USE_SCISSORPOLYGON","#ifndef PDSFX","  varying vec4 scissorClipPos;","#endif","// UNROLL_SCISSORPOLYGON","uniform sampler2D scissorPoints/*#i*/;","uniform int scissorSize/*#i*/[NB_SCISSOR/*#i*/];","// UNROLL_SCISSORPOLYGON_END","#endif","#if defined(USE_CLIPPINGPOLYGON) || defined(USE_SCISSORPOLYGON)","vec2 getPolygonPoint(const sampler2D sampler, const int size, const in int index) {","    return texture2D(sampler, vec2((float(index)+0.5)*1.0/float(size),0.5)).rg;","}","","bool isPointInsidePolygon(const sampler2D sampler, const int size, const in vec2 point, const int offset, const int totalSize) {","    vec2 previousPoint, currentPoint;","    previousPoint = getPolygonPoint(sampler, totalSize, size-1+offset);","    bool result = false;","    for(int i=0; i < MAX_POLYGON_SIZE;i++) {","        if(i < size) {","            currentPoint = getPolygonPoint(sampler, totalSize, i+offset);","            if ( ((currentPoint.y>point.y) != (previousPoint.y>point.y)) &&","                 (point.x < (previousPoint.x-currentPoint.x) * (point.y-currentPoint.y) / (previousPoint.y-currentPoint.y) + currentPoint.x) ) {","                result = !result;","            }","            previousPoint = currentPoint;","        }","    }","    return result;","}","#endif","","#ifdef USE_CLIPPINGCYLINDER","// UNROLL_CLIPPINGCYLINDER","varying vec2 cylinderAxisUV/*#i*/;","uniform int cylinderClipZone/*#i*/;","// UNROLL_CLIPPINGCYLINDER_END","#endif",""].join("\n"),clip_fragment:["#ifdef USE_CLIPPINGPLANES","float clipOpacity = -1.0;","if(nbClipPlanes > 0) {","if (0 < nbClipPlanes && clipDist[ 0 ] < 0.0 && clipPlaneActive[ 0 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 0 < nbClipPlanes && clipPlaneActive[ 0 ] > 0) { clipOpacity = clipFrontOpacity; }","if (1 < nbClipPlanes && clipDist[ 1 ] < 0.0 && clipPlaneActive[ 1 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 1 < nbClipPlanes && clipPlaneActive[ 1 ] > 0) { clipOpacity = clipFrontOpacity; }","if (2 < nbClipPlanes && clipDist[ 2 ] < 0.0 && clipPlaneActive[ 2 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 2 < nbClipPlanes && clipPlaneActive[ 2 ] > 0) { clipOpacity = clipFrontOpacity; }","if (3 < nbClipPlanes && clipDist[ 3 ] < 0.0 && clipPlaneActive[ 3 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 3 < nbClipPlanes && clipPlaneActive[ 3 ] > 0) { clipOpacity = clipFrontOpacity; }","if (4 < nbClipPlanes && clipDist[ 4 ] < 0.0 && clipPlaneActive[ 4 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 4 < nbClipPlanes && clipPlaneActive[ 4 ] > 0) { clipOpacity = clipFrontOpacity; }","if (5 < nbClipPlanes && clipDist[ 5 ] < 0.0 && clipPlaneActive[ 5 ] > 0) { clipOpacity = clipBackOpacity; }","else if (clipOpacity == -1.0 && 5 < nbClipPlanes && clipPlaneActive[ 5 ] > 0) { clipOpacity = clipFrontOpacity; }","if(clipOpacity == 0.0) discard;","}","#endif","#ifdef USE_CLIPPINGPOLYGON","int offset_polygon;","// UNROLL_CLIPPINGPOLYGON","offset_polygon = 0;","int totalSize_polyon = 0;","for(int ipolygon = 0; ipolygon < NB_CLIPPINGPOLYGON/*#i*/; ipolygon++) {","  totalSize_polyon += polygonSize/*#i*/[ipolygon];","}","for(int ipolygon = 0; ipolygon < NB_CLIPPINGPOLYGON/*#i*/; ipolygon++) {","  int size = polygonSize/*#i*/[ipolygon];","  if(size > 0) {","    if(!isPointInsidePolygon(polygonPoints/*#i*/, polygonSize/*#i*/[ipolygon], extrusionPlaneUV/*#i*/[ipolygon], offset_polygon, totalSize_polyon)) {","      discard;","    }","    offset_polygon+=size;","  }","}","// UNROLL_CLIPPINGPOLYGON_END","#endif","#ifdef USE_SCISSORPOLYGON","int offset_scissor;","// UNROLL_SCISSORPOLYGON","offset_scissor = 0;","int totalSize_scissor = 0;","for(int iscissor = 0; iscissor < NB_SCISSOR/*#i*/; iscissor++) {","  totalSize_scissor += scissorSize/*#i*/[iscissor];","}","for(int iscissor = 0; iscissor < NB_SCISSOR/*#i*/; iscissor++) {","  int size = scissorSize/*#i*/[iscissor];","#ifdef PDSFX","  vec4 clipSpacePosition = vGetClipSpacePosition();","#else","  vec4 clipSpacePosition = scissorClipPos;","#endif","  vec2 position2d = clipSpacePosition.xy / clipSpacePosition.w;","  if(size > 0) {","    if(!isPointInsidePolygon(scissorPoints/*#i*/, scissorSize/*#i*/[iscissor], position2d, offset_scissor, totalSize_scissor)) {","      discard;","    }","    offset_scissor+=size;","  }","}","// UNROLL_SCISSORPOLYGON_END","#endif","","#ifdef USE_CLIPPINGCYLINDER","// UNROLL_CLIPPINGPOLYGON","if(cylinderClipZone/*#i*/ != 0) {","\tbool isInside = dot(cylinderAxisUV/*#i*/, cylinderAxisUV/*#i*/) <= 1.0;","\tbool removeInside = cylinderClipZone/*#i*/ < 0;","\tif(isInside == removeInside) discard;","}","// UNROLL_CLIPPINGPOLYGON_END","#endif",""].join("\n")}}),define("DS/Shaders/ScenegraphShaders",["DS/Shaders/DefaultShaders"],function(e){"use strict";return{gpu_scenegraph_nodes:["#ifdef BILLBOARD","uniform mat4 modelInvRotMatrix;","uniform int billboardType;","uniform int billboardRotationEnabled;","uniform mat4 billboardRotation;","uniform vec3 billCameraPos;","uniform vec3 billCameraLookAt;","uniform vec3 billCameraUp;","mat4 lookAt(vec3 eye, vec3 target, vec3 up) {","vec3 z = eye - target;","if (length(z) < 1e-6) {","z.z = 1.0;","}","z = normalize(z);","vec3 x = cross(up, z);","if (length(x) < 1e-6) {","z.x += 0.001;","x = cross(up, z);","}","x = normalize(x);","vec3 y = cross(z,x);","return mat4(vec4(x, 0.0), vec4(y, 0.0), vec4(z, 0.0), vec4(0.0,0.0,0.0,1.0));","}","uniform vec3 billboardAxis;","uniform mat4 invViewMatrix;","uniform mat4 invProjectionMatrix;","vec3 applyProjection(vec4 vector, mat4 proj) {","vec4 res = proj * vector;","return res.xyz / max(abs(res.w),1e-6);","}","mat4 getBillboardMatrix() {","vec3 cameraTarget = billCameraLookAt + billCameraPos;","mat4 billMat;","if (billboardType == 1) {","billMat = lookAt(billCameraPos, cameraTarget, billCameraUp);","} else {","vec3 axis = normalize((modelMatrix * vec4(billboardAxis, 0.0)).xyz);","vec3 objToCam = vec3(0.0);","if (billboardType == 3) {","vec3 worldPosOrigin = modelMatrix[3].xyz;","objToCam = worldPosOrigin - billCameraPos;","vec3 tmp = worldPosOrigin + axis;","mat4 proj = projectionMatrix * viewMatrix;","vec3 projOrig = applyProjection(vec4(worldPosOrigin,1.0), proj);","tmp = applyProjection(vec4(tmp,1.0), proj);","tmp.z = projOrig.z;","tmp = applyProjection(vec4(tmp,1.0), invViewMatrix * invProjectionMatrix);","tmp -= worldPosOrigin;","axis = normalize(tmp);","} else {","objToCam = billCameraLookAt;","}","objToCam = normalize(objToCam);","vec3 crossX = cross(objToCam, axis);","if (length(crossX) < 1e-6) {","crossX = abs(objToCam.z) < 0.999 ? cross(vec3(0.0,0.0,1.0), objToCam) : cross(vec3(1.0,0.0,0.0), objToCam);","}","crossX = normalize(crossX);","vec3 crossY = normalize(cross(axis, crossX));","billMat = mat4(vec4(crossX, 0.0), vec4(crossY, 0.0), vec4(axis, 0.0), vec4(0.0,0.0,0.0,1.0));","}","if (billboardRotationEnabled == 1) {","return modelInvRotMatrix * billMat * billboardRotation;","} else {","return modelInvRotMatrix * billMat;","}","}","#endif","#ifdef FIXED_SIZE","#ifdef FIXED_SIZE_CENTER","uniform vec4 fixedSizeCenterRatio;","#else","uniform float fixedSizeRatio;","#endif","uniform float cameraConstant;","vec2 getScale() {","vec3 xAxis = vec3(modelViewMatrix[0][0],modelViewMatrix[1][0],modelViewMatrix[2][0]);","vec3 yAxis = vec3(modelViewMatrix[0][1],modelViewMatrix[1][1],modelViewMatrix[2][1]);","vec3 zAxis = vec3(modelViewMatrix[0][2],modelViewMatrix[1][2],modelViewMatrix[2][2]);","float radius = max(length(xAxis),max(length(yAxis),length(zAxis)));","float screenRadius = 1.0;","if (projectionMatrix[3][3] > 0.5) {","screenRadius = radius;","} else {","vec4 aux = computeModelViewPosition(vec3(0.0));","float constant = abs(aux.z);","screenRadius = radius / constant;","}","#ifdef FIXED_SIZE_CENTER","float scaleFactorCenter = 1.0 / screenRadius * cameraConstant;","if (projectionMatrix[3][3] > 0.5) {","screenRadius = radius;","} else {","vec4 aux2 = computeModelViewPosition(scaleFactorCenter*fixedSizeCenterRatio.xyz);","float constant2 = abs(aux2.z);","screenRadius = radius / constant2;","}","float scaleFactor = fixedSizeCenterRatio.w / screenRadius * cameraConstant;","#else","float scaleFactor = fixedSizeRatio / screenRadius * cameraConstant;","float scaleFactorCenter = scaleFactor;","#endif","return vec2(scaleFactor, scaleFactorCenter);","}","#endif","#if defined(BILLBOARD) || defined(FIXED_SIZE)","struct SimpleNodeData {","mat4 billboardMatrix;","float fixedSizeScale;","float fixedSizeScaleCenter;","};","SimpleNodeData simpleNodeData;","bool simpleSizeDataSet = false;","void setSimpleNodeData() {","if (simpleSizeDataSet) return;","#ifdef BILLBOARD","simpleNodeData.billboardMatrix = getBillboardMatrix();","#endif","#ifdef FIXED_SIZE","vec2 fixedSizeData = getScale();","simpleNodeData.fixedSizeScale = fixedSizeData.x;","simpleNodeData.fixedSizeScaleCenter = fixedSizeData.y;","#endif","simpleSizeDataSet = true;","}","#endif","vec3 auxPosMV;","vec3 auxPosMVP;","vec4 auxPosMVPFunc;","vec3 MVUnit;"].join("\n"),decompress_normals_pars:["vec2 unpack_2unorm12_in_2floats(in float iEncodedNormal) {","vec2 res;","res.x = floor(iEncodedNormal/4096.0)/4095.0;","res.y = mod(iEncodedNormal, 4096.0)/4095.0;","return res;","}","float signNotZero(in float k) {","return k >= 0.0 ? 1.0 : -1.0;","}","vec2 signNotZero(in vec2 v) {","return vec2( signNotZero(v.x), signNotZero(v.y) );","}","vec3 decodeOct24Normal(in vec2 iEncodedNormal) {","float x = iEncodedNormal.x*2.0 - 1.0;","float y = iEncodedNormal.y*2.0 - 1.0;","vec3 v = vec3(x, y, 1.0 - abs(x) - abs(y));","if (v.z <= 0.0) {","vec2 sgn = signNotZero(v.xy);","v.xy = - abs(v.yx)*sgn + sgn;","}","return normalize(v);","}","vec3 decodeOct24Normal(in float iEncodedNormal) {","return decodeOct24Normal(unpack_2unorm12_in_2floats(iEncodedNormal));","}"].join("\n"),decompress_vertices_pars:["vec3 unpack_3unorm16_in_3floats(in vec2 iEncodedPosition) {","vec3 res;","res.x = floor(iEncodedPosition.x/256.0);","res.y = mod(iEncodedPosition.x, 256.0) *256.0 + mod(iEncodedPosition.y, 256.0);","res.z = floor(iEncodedPosition.y/256.0);","return res;","}","vec3 decodePosition(in vec2 iEncodedPosition, in vec3 quantized, in vec3 offset) {","vec3 res = unpack_3unorm16_in_3floats(iEncodedPosition);","return quantized * (res + offset);","}"].join("\n"),decompress_colors_pars:["vec4 unpack_4unorm8_in_4floats(in vec2 iEncodedColor) {","vec4 res;","res.x = floor(iEncodedColor.x/65536.0);","res.y = mod(floor(iEncodedColor.x/256.0), 256.0);","res.z = mod(iEncodedColor.x, 256.0);","res.w = iEncodedColor.y;","return res;","}","vec4 decodeColor(in vec2 iEncodedColor) {","vec4 res = unpack_4unorm8_in_4floats(iEncodedColor);","return res / 255.0;","}"].join("\n"),decompress_uvs_pars:["vec2 unpack_2unorm16_in_2floats(in vec2 iEncodedUV) {","vec2 res;","res.x = floor(iEncodedUV.x/256.0);","res.y = mod(iEncodedUV.x, 256.0) *256.0 + mod(iEncodedUV.y, 256.0);","return res;","}","vec2 decodeUV(in vec2 iEncodedUV) {","vec2 res = unpack_2unorm16_in_2floats(iEncodedUV);","return res / 65535.0;","}"].join("\n")}}),define("DS/Shaders/ColorShaders",["DS/Shaders/DefaultShaders"],function(e){"use strict";return{postprocess_pars_fragment:["#if defined (GAMMA_OUTPUT) && defined(INLINED_POSTPROCESS)","uniform float brightness;","#if defined (TONEMAP_PHOTOGRAPHIC)","\tfloat luminance_RGB (vec3 iColor) {","\t\tvec3 luminance_weight=vec3(0.176204,0.812985,0.0108109);","\t\treturn dot(iColor,luminance_weight);","\t}","\tuniform float crushblacks;","\tuniform float burnhighlights;","#endif","#endif"].join("\n"),postprocess_fragment:["#if defined (GAMMA_OUTPUT) && defined(INLINED_POSTPROCESS)","   gl_FragColor.xyz *= pow(2.0,brightness);","#if defined (TONEMAP_PHOTOGRAPHIC)","\tfloat saturation = 1.0;","\tvec3 colorCorrection = vec3(1.0);","\tvec3 c = gl_FragColor.xyz * colorCorrection;","\tc *= (c*burnhighlights+1.0)/(c+1.0); ","\tc = mix(vec3(luminance_RGB(c)),c,saturation);","\tfloat intens = luminance_RGB(c);","\tif(intens<1.0){","\t\tfloat _crushblacks = 2.0* crushblacks +1.0;","\t\tintens = sqrt(intens);","\t\tfloat oms2 = 1.0 - intens;"," \t\tc.x = c.x*intens + pow(c.x,_crushblacks)*oms2;","\t\tc.y = c.y*intens + pow(c.y,_crushblacks)*oms2;"," \t\tc.z = c.z*intens + pow(c.z,_crushblacks)*oms2;","\t}","\tgl_FragColor.xyz = c;","#endif","#endif"].join("\n"),linear_to_gamma_fragment:["#ifdef GAMMA_OUTPUT","#ifdef SIMPLE_GAMMA","gl_FragColor.xyz = sqrt( gl_FragColor.xyz );","#else","\tgl_FragColor.r = (gl_FragColor.r < 0.0031308)    ? (gl_FragColor.r*12.92) : 1.055*pow(gl_FragColor.r,1.0/2.4)-0.055;","\tgl_FragColor.g = (gl_FragColor.g < 0.0031308)    ? (gl_FragColor.g*12.92) : 1.055*pow(gl_FragColor.g,1.0/2.4)-0.055;","\tgl_FragColor.b = (gl_FragColor.b < 0.0031308)    ? (gl_FragColor.b*12.92) : 1.055*pow(gl_FragColor.b,1.0/2.4)-0.055;","#endif","#endif"].join("\n"),color_pars_fragment:["#ifdef USE_COLOR","varying vec4 vColor;","#endif"].join("\n"),color_fragment:["#ifdef USE_COLOR","gl_FragColor *= vColor;","#endif"].join("\n"),color_pars_vertex:["#ifdef USE_COLOR","#ifdef OBJECT_USE_COLOR","uniform float objectColorBufferType;","#else","uniform float colorBufferType;","#endif","varying vec4 vColor;","const float VertexColorsFace = 1.0;","const float VertexColorsRGBA = 2.0;","const float VertexColorsRGB = 3.0;","const float VertexColorsA = 4.0;","const float VertexColorsR = 8.0;","const float VertexColorsG = 16.0;","const float VertexColorsB = 32.0;","vec3 GetVertexColorMult(in vec3 colorValue) {","#ifdef OBJECT_USE_COLOR","#ifndef ALLOW_OBJECT_COLOR","return vec3(1.0);","#endif","float colorTypeToUse = objectColorBufferType;","#else","float colorTypeToUse = colorBufferType;","#endif","if (colorTypeToUse <= VertexColorsRGB) {","return colorValue.rgb;","}","vec3 res = vec3(1.0);","float maskR = floor(colorTypeToUse / VertexColorsR);","if (mod(maskR, 2.0) > 0.5) {","res.r = colorValue.r;","}","float maskG = floor(colorTypeToUse / VertexColorsG);","if (mod(maskG, 2.0) > 0.5) {","res.g = colorValue.g;","}","float maskB = floor(colorTypeToUse / VertexColorsB);","if (mod(maskB, 2.0) > 0.5) {","res.b = colorValue.b;","}","return res;","}","float GetVertexAlphaMult(in float alphaValue) {","#ifdef OBJECT_USE_COLOR","#ifndef ALLOW_OBJECT_COLOR","return 1.0;","#endif","float colorTypeToUse = objectColorBufferType;","#else","float colorTypeToUse = colorBufferType;","#endif","if (colorTypeToUse < VertexColorsRGB) {","return alphaValue;","}","float maskA = floor(colorTypeToUse / VertexColorsA);","if (mod(maskA, 2.0) > 0.5) {","return alphaValue;","}","return 1.0;","}","#endif"].join("\n"),color_vertex:["#ifdef USE_COLOR","vColor = vec4(GetVertexColorMult(color.rgb), GetVertexAlphaMult(color.a));","#ifdef GAMMA_INPUT","vColor.rgba *= vColor.rgba;","#endif","#endif"].join("\n"),sRGB_conversion:["vec3 convertToLinear(in vec3 color){","vec3 res;","#ifdef SIMPLE_GAMMA","\tres = color*color;","#else","\tres.r = (color.r < 0.04045)    ? (color.r/12.92) : pow((color.r + 0.055)/1.055, 2.4);","\tres.g = (color.g < 0.04045)    ? (color.g/12.92) : pow((color.g + 0.055)/1.055, 2.4);","\tres.b = (color.b < 0.04045)    ? (color.b/12.92) : pow((color.b + 0.055)/1.055, 2.4);","#endif","return res;","}"].join("\n")}}),define("DS/Shaders/FogShaders",["DS/Shaders/DefaultShaders"],function(e){"use strict";return{fog_pars_vertex:"\n\t\t\t#if defined(USE_BACKGROUNDVIEWMODE_FOG)\n\t\t\t\tvarying float bvm_depth;\n\t\t\t#endif\n\t\t",fog_vertex:"\n\t\t\t#if defined(USE_BACKGROUNDVIEWMODE_FOG)\n\t\t\t\tbvm_depth = gl_Position.w;\n\t\t\t#endif\n\t\t",fog_pars_fragment:"\n\t\t\t#if defined(USE_BACKGROUNDVIEWMODE_FOG)\n\t\t\t\tuniform vec4 background_view_mode_control;\n\t\t\t\tuniform vec2 background_view_mode_near_far;\n\t\t\t\tvarying float bvm_depth;\n\t\t\t#endif\n\t\t",fog_fragment:"\n\t\t\t#if defined(USE_BACKGROUNDVIEWMODE_FOG)\n\t\t\t\tif(background_view_mode_control.w > 0.5)\n\t\t\t\t{\n\t\t\t\t\tfloat isOrtho = projectionMatrix[2].w < 0.0 ? 0.0 : 1.0;\n\t\t\t\t\tfloat bvm_fog_depth = (bvm_depth - background_view_mode_near_far.x) / (background_view_mode_near_far.y - background_view_mode_near_far.x);\n\t\t\t\t\tfloat fog_mix = gl_FragCoord.z * gl_FragCoord.w * isOrtho + (1.0 - isOrtho) * bvm_fog_depth;\n\t\t\t\t\tfog_mix = min(max(fog_mix, 0.0), 1.0);\n\t\t\t\t\tgl_FragColor.xyz = gl_FragColor.xyz * (1.0 - fog_mix) + background_view_mode_control.xyz * fog_mix;\n\t\t\t\t}\n\t\t\t#endif\n\t\t"}}),define("DS/Shaders/PhongShaders",["DS/Shaders/DefaultShaders"],function(e){"use strict";return{lights_phong_pars_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( ENV_MAP ) || defined(USE_SHADOWMAP_CUBE)","varying vec3 vWorldPosition;","#endif"].join("\n"),lights_phong_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","vPointLight[ i ] = vec4( lVector, lDistance );","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","vSpotLight[ i ] = vec4( lVector, lDistance );","}","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( ENV_MAP ) || defined(USE_SHADOWMAP_CUBE)","vWorldPosition = worldPosition.xyz;","#endif"].join("\n"),lights_phong_pars_fragment:["uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_DIR_PHONG_LIGHTS > 0","uniform vec3 directionalPhongLightColor[ MAX_DIR_PHONG_LIGHTS ];","uniform vec3 directionalPhongLightDirection[ MAX_DIR_PHONG_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform int pointLightPhysicalAttenuation[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#else","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightInnerAngleCos[ MAX_SPOT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform int spotLightPhysicalAttenuation[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#else","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined(USE_SHADOWMAP_CUBE)","varying vec3 vWorldPosition;","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif",e.normal_viewposition_pars_fragment].join("\n"),lights_phong_fragment:[e.normal_viewposition_fragment,"#ifdef USE_NORMALMAP","normal = perturbNormal2Arb( -vPos, normal );","#elif defined( USE_BUMPMAP )","normal = perturbNormalArb( -vPos, normal, dHdxy_fwd() );","#endif","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse  = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vPos.xyz;","float lDistance = 1.0;","if (pointLightPhysicalAttenuation[ i ]> 0){","lDistance = 1.0 / (dot(lVector,lVector) * pointLightDistance[ i ]);","}else {","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","}","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vPointLight[ i ].xyz );","float lDistance = vPointLight[ i ].w;","#endif","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dotProduct, 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dotProduct, 0.0 );","#endif","pointDiffuse  += diffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;","vec3 pointHalfVector = normalize( lVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularStrength * max( pow( pointDotNormalHalf, shininessValue ), 0.0 );","pointSpecular += specular * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance;","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse  = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vPos.xyz;","float lDistance = 1.0;","if (spotLightPhysicalAttenuation[ i ]> 0){","lDistance =1.0 / (dot(lVector,lVector) * spotLightDistance[ i ]);","}else {","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","}","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vSpotLight[ i ].xyz );","float lDistance = vSpotLight[ i ].w;","#endif","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = 1.0 - smoothstep( spotLightInnerAngleCos[ i ],spotLightAngleCos[ i ],spotEffect );","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dotProduct, 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dotProduct, 0.0 );","#endif","spotDiffuse += diffuse * spotLightColor[ i ] * spotDiffuseWeight * lDistance * spotEffect;","vec3 spotHalfVector = normalize( lVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularStrength * max( pow( spotDotNormalHalf, shininessValue ), 0.0 );","spotSpecular += specular * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * spotEffect;","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, dirVector );","#ifdef WRAP_AROUND","float dirDiffuseWeightFull = max( dotProduct, 0.0 );","float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dotProduct, 0.0 );","#endif","dirDiffuse  += diffuse * directionalLightColor[ i ] * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininessValue ), 0.0 );","dirSpecular += specular * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight;","}","#endif","#if MAX_DIR_PHONG_LIGHTS > 0","vec3 dirPhongDiffuse  = vec3( 0.0 );","vec3 dirPhongSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_PHONG_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalPhongLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, dirVector );","#ifdef WRAP_AROUND","float dirDiffuseWeightFull = max( dotProduct, 0.0 );","float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dotProduct, 0.0 );","#endif","dirPhongDiffuse  += diffuse * directionalPhongLightColor[ i ] * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininessValue ), 0.0 );","dirPhongSpecular += specular * directionalPhongLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight;","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_DIR_PHONG_LIGHTS > 0","totalDiffuse += dirPhongDiffuse;","totalSpecular += dirPhongSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient + totalSpecular );","#else","#if (defined(USE_MAP) || defined(PDSFX_USE_MAP)) && TEXTURE_BLENDING != 5","vec4 texture = texelColor;","#if TEXTURE_BLENDING == 1","gl_FragColor.xyz = texture.xyz * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif","#if TEXTURE_BLENDING == 2","gl_FragColor.xyz = ((1.0-texture.xyz) * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular) + texture.xyz;","#endif","#if TEXTURE_BLENDING == 0","gl_FragColor.xyz = ((1.0-texture.a) * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular) + texture.a * texture.xyz;","#endif","#if TEXTURE_BLENDING == 3","#if TEXTURE_FORMAT == 1021","gl_FragColor.a = texture.a;","#endif","#endif","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif","#endif"].join("\n"),lights_phong_firstdironly_fragment:[e.normal_viewposition_fragment,"#ifdef USE_NORMALMAP","normal = perturbNormal2Arb( -vPos, normal );","#elif defined( USE_BUMPMAP )","normal = perturbNormalArb( -vPos, normal, dHdxy_fwd() );","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ 0 ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, dirVector );","#ifdef WRAP_AROUND","float dirDiffuseWeightFull = max( dotProduct, 0.0 );","float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dotProduct, 0.0 );","#endif","dirDiffuse  += diffuse * 3.0 * directionalLightColor[ 0 ] * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininess ), 0.0 );","dirSpecular += specular * directionalLightColor[ 0 ] * dirSpecularWeight * dirDiffuseWeight;","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient + totalSpecular );","#else","#if (defined(USE_MAP) || defined(PDSFX_USE_MAP)) && TEXTURE_BLENDING != 5","vec4 texture = texelColor;","#if TEXTURE_BLENDING == 1","gl_FragColor.xyz = texture.xyz * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif","#if TEXTURE_BLENDING == 2","gl_FragColor.xyz = ((1.0-texture.xyz) * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular) + texture.xyz;","#endif","#if TEXTURE_BLENDING == 0","gl_FragColor.xyz = ((1.0-texture.a) * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular) + texture.a * texture.xyz;","#endif","#if TEXTURE_BLENDING == 3","#if TEXTURE_FORMAT == 1021","gl_FragColor.a = texture.a;","#endif","#endif","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif","#endif"].join("\n")}}),define("DS/Materials/ShaderDynamicPrefixBuilder",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t=function(t){const i=e.MaterialToUse;switch(t){case i.originalMaterial:return"ORIGINAL_MATERIAL";case i.normalMaterial:return"NORMAL_MATERIAL";case i.depthMaterial:return"DEPTH_MATERIAL";case i.normalDepthIoRRoughnessMaterial:return"NORMAL_DEPTH_IOR_ROUGHNESS_MATERIAL";case i.shadowMapDepthMaterial:return"SHADOWMAP_MATERIAL";case i.highlightMaterial:return"HIGHLIGHT_MATERIAL";case i.pickingMaterial:return"PICKING_MATERIAL";case i.pickingMaterialInstancing:return"PICKING_INSTANCING_MATERIAL";case i.oitAccumMaterial:return"OIT_ACCUM_MATERIAL";case i.oitRevealMaterial:return"OIT_REVEAL_MATERIAL";case i.ZOnlyMaterial:return"ZONLY_MATERIAL";case i.depthRGBAMaterial:return"DEPTH_RGBA_MATERIAL";case i.decalNormalStencilDepthMaterial:return"DECAL_NORMAL_STENCIL_DEPTH_MATERIAL";case i.normalDepthMaterial:return"NORMAL_DEPTH_MATERIAL";case i.transparentShadowMaterial:return"TRANSPARENT_SHADOWMAP_MATERIAL";case i.texCoordMaterial:return"TEXTURE_COORDINATES_MATERIAL";default:throw"Invalid Material to use "+t}};function i(i){var r=e._isSelectionMaterial;return["#define "+t(i.materialToUse),r(i.materialToUse)?"#define SELECTION_MATERIAL":"",i.mobile?"#define MOBILE_MODE":"",i.mobileDevice?"#define MOBILE_DEVICE_MODE":"",i.noCompositing?"#define NO_COMPOSITING":"",i.mobileHL?"#define MOBILE_HIGHLIGHT_MODE":"",i.primitiveHighlight?"#define PRIMITIVE_HIGHLIGHT":"",i.adjacenceHighlight?"#define ADJACENCE_HIGHLIGHT":"",i.deferrable?"#define DEFERRABLE_MATERIAL":"",i.politeHighlight?"#define HIGHLIGHT_POLITE 1":"#define HIGHLIGHT_POLITE 0",i.noZObject?"#define NOZ_OBJECT":"",i.largeScale?"#define MODELVIEW_GPU":"#define MODELVIEW_CPU",i.useNormalMatrix?"#define USE_NORMAL_MATRIX":"",i.depthDebugMaterial?"#define DEBUG_DEPTH":"",i.normalDebugMaterial?"#define DEBUG_NORMAL":"",i.shadowMapDebugMaterial?"#define DEBUG_SHADOW":"",i.geomUVDebug?"#define DEBUG_GEOM_UVS":"",i.mappingUVDebug?"#define DEBUG_MAPPING_UVS":"",i.geomUV2Debug?"#define DEBUG_GEOM_UV2S":"",i.mappingUV2Debug?"#define DEBUG_MAPPING_UV2S":"","#define MAX_DIR_LIGHTS "+i.maxDirLights,"#define MAX_DIR_IBL_LIGHTS "+i.maxDirIBLLights,"#define MAX_DIR_PHONG_LIGHTS "+i.maxDirPhongLights,"#define MAX_POINT_LIGHTS "+i.maxPointLights,"#define MAX_SPOT_LIGHTS "+i.maxSpotLights,"#define MAX_SPHERE_LIGHTS "+i.maxSphereLights,"#define MAX_TUBE_LIGHTS "+i.maxTubeLights,"#define MAX_DISK_LIGHTS "+i.maxDiskLights,"#define MAX_AREA_LIGHTS "+i.maxAreaLights,"#define MAX_IES_LIGHTS "+i.maxIESLights,i.lightMap?"#define USE_LIGHTMAP":"","#define MAX_SHADOWS "+i.maxShadows,"#define MAX_SHADOWS_DIR "+i.maxDirShadows,"#define MAX_SHADOWS_DIR_IBL "+i.maxDirIBLShadows,"#define MAX_SHADOWS_SPOT "+i.maxSpotShadows,"#define MAX_SHADOWS_CUBE "+i.maxShadowsCube,i.shadowMapEnabled?"#define USE_SHADOWMAP":"","#define "+i.shadowMapTypeDefine,"#define "+i.shadowMapQualityDefine,i.shadowMapCubeEnabled?"#define USE_SHADOWMAP_CUBE":"",i.transparentShadowEnabled?"#define USE_TRANSPARENTSHADOWMAP":"",i.uintESM?"#define USE_UINT_ESM":"",i.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",i.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",i.useUV?"#define NEEDS_UVTOUSE":"",0==i.mappingUseFragment?"#define USE_MAPPING_OPERATOR_VERTEX":"",1==i.mappingUseFragment?"#define USE_MAPPING_OPERATOR_FRAGMENT":"",i.mappingType>-1?"#define MAPPING_OPERATOR":"",i.needTangentBinormal?"#define USE_TANGENT_BINORMAL":"",i.clipPlanesEnabled?"#define USE_CLIPPINGPLANES":"",i.fogViewMode?"#define USE_BACKGROUNDVIEWMODE_FOG":"",i.lowlightViewMode?"#define USE_BACKGROUNDVIEWMODE_LOWLIGHT":"",i.perPixel?"#define PHONG_PER_PIXEL":"",i.wrapAround?"#define WRAP_AROUND":"",(i.doubleSided,"#define DOUBLE_SIDED"),i.flipSided?"#define FLIP_SIDED":"",i.vertexColors||i.objectVertexColors?"#define USE_COLOR":"",i.objectVertexColors?"#define USE_OBJECT_COLOR":"",i.allowObjectVertexColors?"#define ALLOW_OBJECT_COLOR":"",i.gpuTangentBinormal?"#define GPU_TANGENT_BINORMAL":"",i.specgloss?"#define SPECGLOSS":"",i.specglossNRE?"#define SPECGLOSS_NRE":"",i.dspbr?"#define DSPBR":"",i.dspbr19x?"#define DSPBR19x":"",i.dspbr21x?"#define DSPBR21x":"",i.dspbr22x?"#define DSPBR22x":"",i.dspbr23x?"#define DSPBR23x":"",i.NRECompatibility?"#define NRE_COMPATIBILITY":"",i.fromGLTF?"#define PBR_FROM_GLTF "+i.fromGLTF:"",i.isDecal?"#define DECAL":"",i.useOIT?"#define USE_OIT":"",i.PDSFX?"#define PDSFX":"",i.pdsfxUseMap?"#define PDSFX_USE_MAP":"",i.refractionRatioMap?"#define USE_REFRACTIONRATIOMAP":"",i.newSslr?"#define USE_NEWSSLR":"",i.sslrefractionEnabled?"#define SSLREFRACTION_ENABLED":"",i.sslreflectionEnabled?"#define SSLREFLECTION_ENABLED":"",i.isMultiInstanced?"#define IS_MULTI_INSTANCED":"",i._definePickingInstancing?"#define PICKING_INSTANCING":"",i.specialPickingInstancing?"#define SPECIAL_PICKING_INSTANCING":"",i.envMap?"#define USE_ENVMAP":"",1===i.envMapping?"#define USE_LIGHTPROBEMAP":"",2===i.envMapping?"#define USE_LATLONGMAP":"",i.useFiniteEnvMap?"#define USE_FINITE_ENVMAP":"",i.reflectionProbes?"#define USE_REFLECTION_PROBE":"",i.dashedLine?"#define USE_DASHEDLINE":"",i.cpuPattern?"#define CPU_PATTERN":"",i.worldSizePattern?"#define WORLD_SIZE_PATTERN":"",i.invertedPattern?"#define DASHEDLINE_INVERTED":"",i.patternSize?"#define PATTERN_LENGTH "+i.patternSize:"",i.wideLine?"#define USE_WIDELINE":"",i.wideLine&&i.polygonBorderMode?"#define USE_POLYGON_BORDER_MODE":"",i.wideLine&&i.linejoin?"#define USE_"+i.linejoin.toUpperCase()+"JOIN":"",i.wideLine&&i.linecap?"#define USE_"+i.linecap.toUpperCase()+"CAP":""].join("\n")}return{_FragmentPrefixBuilder:function(t){return e.SplitTrimStickString([i(t),t.alphaTest?"#define ALPHATEST "+t.alphaTest.toFixed(5):"",t.discardOrOpaque?"#define DISCARD_OR_OPAQUE":"",t.inlinedPostProActivated?"#define INLINED_POSTPROCESS":"",6==t.inlinedPostProTonemapping?"#define TONEMAP_PHOTOGRAPHIC":"",t.useLighting?"#define USE_LIGHTING":"",t.reflectivityEnvMap?"#define REFLECTIVITY_ENVMAP":"",1===t.lightMapMode?"#define LIGHTMAP_IRRADIANCE_MODE":"",t.lightMapLinear?"#define USE_LIGHTMAP_LINEAR":"",t.phongFirstDir?"#define PHONG_FIRST_DIR_ONLY":"",void 0!==t.textureBlending?"#define TEXTURE_BLENDING "+t.textureBlending:"",t.map?"#define TEXTURE_FORMAT "+t.textureFormat.format:"#define TEXTURE_FORMAT 0",t.bumpMap?"#define USE_BUMPMAP":"",t.bumpMap&&t.bumpScaleMap?"#define USE_BUMPSCALEMAP":"",t.bumpMap&&t.bumpScaleMulCoef&&t.bumpScaleAddCoef?"#define USE_BUMPSCALE_COEFFICIENTS":"",t.normalMap?"#define USE_NORMALMAP":"",t.normalMap&&t.normalMulCoef&&t.normalAddCoef?"#define USE_NORMAL_COEFFICIENTS":"",t.normalMapFlipY?"#define NORMALFLIPY":"",t.normalMap&&t.normalScaleMap?"#define USE_NORMALSCALEMAP":"",t.normalMap&&t.normalScaleMulCoef&&t.normalScaleAddCoef?"#define USE_NORMALSCALE_COEFFICIENTS":"",t.map?"#define USE_MAP":"",t.mapHDR?"#define USE_MAP_HDR":"",t.diffuseMulCoef&&t.diffuseAddCoef?"#define USE_DIFFUSE_COEFFICIENTS":"",t.diffuseBorderColorU?"#define USE_DIFFUSEMAP_BORDER_COLOR_U":"",t.diffuseBorderColorV?"#define USE_DIFFUSEMAP_BORDER_COLOR_V":"",t.useAlphaFromDiffuseMap?"#define USE_ALPHA_FROM_MAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.specularMulCoef&&t.specularAddCoef?"#define USE_SPECULAR_COEFFICIENTS":"",t.specularMapLinear?"#define SPECULAR_LINEAR":"",t.metalnessMap?"#define USE_METALNESSMAP":"",t.metalnessMulCoef&&t.metalnessAddCoef?"#define USE_METALNESS_COEFFICIENTS":"",t.specularContribMap?"#define USE_SPECULARCONTRIBMAP":"",t.specularContribMulCoef&&t.specularContribAddCoef?"#define USE_SPECULARCONTRIB_COEFFICIENTS":"",t.emissionColorMap?"#define USE_EMISSIONCOLORMAP":"",t.emissionColorMulCoef&&t.emissionColorAddCoef?"#define USE_EMISSIONCOLOR_COEFFICIENTS":"",t.emissionNormalized?"#define USE_NORMALIZED_EMISSION":"",t.emissionColorMapLinear?"#define EMISSION_LINEAR":"",t.transparencyMap?"#define USE_TRANSPARENCYMAP":"",t.transparencyMulCoef&&t.transparencyAddCoef?"#define USE_TRANSPARENCY_COEFFICIENTS":"",t.opacityMap?"#define USE_OPACITYMAP":"",t.opacityBorderColorU?"#define USE_OPACITYMAP_BORDER_COLOR_U":"",t.opacityBorderColorV?"#define USE_OPACITYMAP_BORDER_COLOR_V":"",t.opacityMulCoef&&t.opacityAddCoef?"#define USE_OPACITY_COEFFICIENTS":"",t.translucencyMap?"#define USE_TRANSLUCENCYMAP":"",t.translucencyMulCoef&&t.translucencyAddCoef?"#define USE_TRANSLUCENCY_COEFFICIENTS":"",t.translucencyColorMap?"#define USE_TRANSLUCENCY_COLOR_MAP":"",t.translucencyColorMapLinear?"#define TRANSLUCENCY_COLOR_LINEAR":"",t.translucencyColorMulCoef&&t.translucencyColorAddCoef?"#define USE_TRANSLUCENCY_COLOR_COEFFICIENTS":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.glossinessMap?"#define USE_GLOSSINESSMAP":"",t.roughnessMulCoef&&t.roughnessAddCoef?"#define USE_ROUGHNESS_COEFFICIENTS":"",t.glossinessMulCoef&&t.glossinessAddCoef?"#define USE_GLOSSINESS_COEFFICIENTS":"",t.anisotropy?"#define USE_ANISOTROPY":"",t.anisotropyMap?"#define USE_ANISOTROPYMAP":"",t.anisotropyMulCoef&&t.anisotropyAddCoef?"#define USE_ANISOTROPY_COEFFICIENTS":"",t.anisotropyAngleMap?"#define USE_ANISOTROPYANGLEMAP":"",t.anisotropyAngleMulCoef&&t.anisotropyAngleAddCoef?"#define USE_ANISOTROPYANGLE_COEFFICIENTS":"",t.sheen?"#define USE_SHEEN":"",t.sheenMap?"#define USE_SHEEN_MAP":"",t.sheenMulCoef&&t.sheenAddCoef?"#define USE_SHEEN_COEFFICIENTS":"",t.sheenColorMap?"#define USE_SHEEN_COLOR_MAP":"",t.sheenColorMulCoef&&t.sheenColorAddCoef?"#define USE_SHEEN_COLOR_COEFFICIENTS":"",t.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESS_MAP":"",t.sheenRoughnessMulCoef&&t.sheenRoughnessAddCoef?"#define USE_SHEEN_ROUGHNESS_COEFFICIENTS":"",t.sheenMode?"#define "+t.sheenMode:"",t.sheenColorMapLinear?"#define SHEEN_COLOR_LINEAR":"",t.specGlossFlakes?"#define USE_SPECGLOSS_FLAKES":"",t.dspbrFlakes?"#define USE_DSPBR_FLAKES":"",t.specGlossFlakes&&t.flakesMode<2?"#define ADVANCED_FLAKES_BLENDING":"",t.specGlossFlakes&&t.flakesMode<2?"#define ADVANCED_PRESENCE_NOISE":"",t.specGlossFlakes&&t.flakesMode<1?"#define FLAKES_NORMAL_PERTURBATION":"",t.specGlossFlakes&&t.flakesMode<1?"#define PEARL_FLAKES_ACTIVATED":"",t.dspbrFlakes&&0===t.flakesMode?"#define DSPBR_FLAKES_FULL_GRID":"",t.dspbrFlakes&&t.flakesMode<=1?"#define DSPBR_FLAKES_THREE_LAYERS":"",t.dspbrFlakes&&2===t.flakesMode?"#define DSPBR_FLAKES_TWO_LAYERS":"",t.dspbrFlakes&&3===t.flakesMode?"#define DSPBR_FLAKES_ONE_LAYER":"",t.flakesCoverageMap?"#define USE_FLAKESCOVERAGE_MAP":"",t.flakesCoverageMulCoef&&t.flakesCoverageAddCoef?"#define USE_FLAKESCOVERAGE_COEFFICIENTS":"",t.flakesRoughnessMap?"#define USE_FLAKESROUGHNESS_MAP":"",t.flakesRoughnessMulCoef&&t.flakesRoughnessAddCoef?"#define USE_FLAKESROUGHNESS_COEFFICIENTS":"",t.flakesColorMap?"#define USE_FLAKESCOLOR_MAP":"",t.flakesColorMulCoef&&t.flakesColorAddCoef?"#define USE_FLAKESCOLOR_COEFFICIENTS":"",t.flakesSizeMap?"#define USE_FLAKESSIZE_MAP":"",t.flakesSizeMulCoef&&t.flakesSizeAddCoef?"#define USE_FLAKESSIZE_COEFFICIENTS":"",t.flakesColorMapLinear?"#define FLAKES_LINEAR":"",t.flipFlop?"#define USE_FLIPFLOP":"",t.flipFlopColorMap?"#define USE_FLIPFLOP_COLOR_MAP":"",t.flipFlopColorMulCoef&&t.flipFlopColorAddCoef?"#define USE_FLIPFLOP_COLOR_COEFFICIENTS":"",t.flipFlopColorMapLinear?"#define FLIPFLOP_COLOR_LINEAR":"",t.flipFlopMap?"#define USE_FLIPFLOP_MAP":"",t.flipFlopMulCoef&&t.flipFlopAddCoef?"#define USE_FLIPFLOP_COEFFICIENTS":"",t.clearCoat?"#define CLEAR_COAT":"",t.clearCoatMap?"#define CLEAR_COAT_MAP":"",t.clearCoatMulCoef&&t.clearCoatAddCoef?"#define USE_CC_COEFFICIENTS":"",t.clearCoatColorMap?"#define CLEAR_COAT_COLORMAP":"",t.clearCoatColorMulCoef&&t.clearCoatColorAddCoef?"#define USE_CC_COLOR_COEFFICIENTS":"",t.clearCoatNormalMap?"#define CLEAR_COAT_NORMALMAP":"",(t.clearCoatNormalMap||t.orangePeel)&&t.clearCoatNormalMulCoef&&t.clearCoatNormalAddCoef?"#define USE_CC_NORMAL_COEFFICIENTS":"",t.clearCoatNormalMapFlipY?"#define CLEAR_COAT_NORMALMAPFLIPY":"",t.clearCoatRoughnessMap?"#define USE_CC_ROUGHNESSMAP":"",t.coatingGlossinessMap?"#define USE_CC_GLOSSINESSMAP":"",t.coatingGlossinessMulCoef&&t.coatingGlossinessAddCoef?"#define USE_CC_GLOSSINESS_COEFFICIENTS":"",t.clearCoatRoughnessMulCoef&&t.clearCoatRoughnessAddCoef?"#define USE_CC_ROUGHNESS_COEFFICIENTS":"",t.orangePeel?"#define USE_ORANGE_PEEL":"",t.clearCoatColorMapLinear?"#define CLEARCOAT_LINEAR":"",t.subsurface?"#define USE_SUBSURFACE":"",t.sssLUT?"#define USE_SSSLUT":"",t.thickness?"#define USE_THICKNESS":"",t.thicknessMap?"#define USE_THICKNESSMAP":"",t.thicknessAddCoef&&t.thicknessMulCoef?"#define USE_THICKNESS_COEFFICIENTS":"",t.envMapSheen?"#define USE_ENVMAP_SHEEN":"",t.envMapDiffuse?"#define USE_ENVMAP_DIFFUSE":"",t.envMapHDR?"#define USE_ENVMAP_HDR":"",t.envMapRGBHDR?"#define USE_ENVMAP_RGB_HDR":"",t.envMapRGBsRGB?"#define USE_ENVMAP_RGB_SRGB":"",t.thinWalled?"#define THIN_WALLED":"",t.iridescence?"#define USE_IRIDESCENCE":"",t.iridescenceMap?"#define USE_IRIDESCENCE_MAP":"",t.iridescenceAddCoef&&t.iridescenceMulCoef?"#define USE_IRIDESCENCE_COEFFICIENTS":"",t.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESS_MAP":"",t.iridescenceThicknessAddCoef&&t.iridescenceThicknessMulCoef?"#define USE_IRIDESCENCE_THICKNESS_COEFFICIENTS":"",t.instancingMeshSelectionMode?"#define INSTANCING_MESH_SELECTION":"",t.skipTranspar?"#define SKIP_TRANSPARENT":"",t.isFromGAS?"#define PBR_FROM_GAS":"",t.metal?"#define METAL":""].join("\n"))},_VertexPrefixBuilder:function(t){return e.SplitTrimStickString([i(t),t.morphTargets?"#define USE_MORPHTARGETS":"",t.morphNormals?"#define USE_MORPHNORMALS":"",t.fixedSize?"#define FIXED_SIZE":"",t.fixedSizeCenter?"#define FIXED_SIZE_CENTER":"",t.billboard?"#define BILLBOARD":"",t.skinning?"#define USE_SKINNING":"",t.useEulerAngles?"#define USE_SKINNING_ANGLES":"",t.skinningMapWidth&&!t.isMultiInstanced?"#define N_BONE_PIXEL_X "+t.skinningMapWidth.toFixed(1):"",t.skinningMapHeight&&!t.isMultiInstanced?"#define N_BONE_PIXEL_Y "+t.skinningMapHeight.toFixed(1):"",t.skinningInstancingMapsInfo&&t.isMultiInstanced?"#define NB_INSTANCING_SKIN_MAPS "+t.skinningInstancingMapsInfo.nbTextures+"\n#define NB_BONES "+t.skinningInstancingMapsInfo.nbBones.toFixed(1)+"\n#define MAX_MAP_SIZE "+t.skinningInstancingMapsInfo.maxTextureSize.toFixed(1)+"\n#define LAST_INSTANCING_SKIN_MAP_SIZE_X "+t.skinningInstancingMapsInfo.lastTextureSizeX.toFixed(1)+"\n#define LAST_INSTANCING_SKIN_MAP_SIZE_Y "+t.skinningInstancingMapsInfo.lastTextureSizeY.toFixed(1)+"\n":"",t.sizeAttenuation?"#define USE_SIZEATTENUATION":"",t.map?"#define USE_MAP":"",t.bumpMap?"#define USE_BUMPMAP":"",t.normalMap?"#define USE_NORMALMAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.glossinessMap?"#define USE_GLOSSINESSMAP":"",t.anisotropy?"#define USE_ANISOTROPY":"",t.anisotropyMap?"#define USE_ANISOTROPYMAP":"",t.anisotropyAngleMap?"#define USE_ANISOTROPYANGLEMAP":"",t.anisotropy?"#define USE_TANGENT_BINORMAL":"",t.displacementMap?"#define USE_DISPLACEMENTMAP":"",t.displacementMap&&t.displacementAddCoef&&t.displacementMulCoef?"#define USE_DISPLACEMENT_COEFFICIENTS":"",t.dspbrFlakes?"#define USE_DSPBR_FLAKES":"",t.specGlossFlakes?"#define USE_SPECGLOSS_FLAKES":"",t.orangePeel?"#define USE_ORANGE_PEEL":"",t.subsurface?"#define USE_SUBSURFACE":"",t.compressedVertices?"#define COMPRESSED_VERTICES":"",t.compressedNormals?"#define COMPRESSED_NORMALS":"",t.compressedUVs?"#define COMPRESSED_UVS":"",t.compressedColors?"#define COMPRESSED_COLORS":""].join("\n"))}}}),define("DS/Shaders/LambertShaders",["DS/Shaders/DefaultShaders"],function(e){"use strict";return{lights_lambert_pars_vertex:["uniform vec3 ambient;","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightInnerAngleCos[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif"].join("\n"),lights_lambert_vertex:["vLightFront = vec3( 0.0 );","#ifdef DOUBLE_SIDED","vLightBack = vec3( 0.0 );","#endif","transformedNormal = normalize( transformedNormal );","#if MAX_DIR_LIGHTS > 0","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, dirVector );","vec3 directionalLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 directionalLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","directionalLightWeighting = mix( directionalLightWeighting, directionalLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","directionalLightWeightingBack = mix( directionalLightWeightingBack, directionalLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += directionalLightColor[ i ] * directionalLightWeighting;","#ifdef DOUBLE_SIDED","vLightBack += directionalLightColor[ i ] * directionalLightWeightingBack;","#endif","}","#endif","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 pointLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 pointLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","pointLightWeighting = mix( pointLightWeighting, pointLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","pointLightWeightingBack = mix( pointLightWeightingBack, pointLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += pointLightColor[ i ] * pointLightWeighting * lDistance;","#ifdef DOUBLE_SIDED","vLightBack += pointLightColor[ i ] * pointLightWeightingBack * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - worldPosition.xyz ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = 1.0 - smoothstep( spotLightInnerAngleCos[ i ],spotLightAngleCos[ i ],spotEffect );","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 spotLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 spotLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","spotLightWeighting = mix( spotLightWeighting, spotLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","spotLightWeightingBack = mix( spotLightWeightingBack, spotLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += spotLightColor[ i ] * spotLightWeighting * lDistance * spotEffect;","#ifdef DOUBLE_SIDED","vLightBack += spotLightColor[ i ] * spotLightWeightingBack * lDistance * spotEffect;","#endif","}","}","#endif","vLightFront = vLightFront * diffuse + ambient * ambientLightColor + emissive;","#ifdef DOUBLE_SIDED","vLightBack = vLightBack * diffuse + ambient * ambientLightColor + emissive;","#endif"].join("\n")}}),define("DS/Shaders/AlphaShaders",["DS/Shaders/DefaultShaders"],function(e){"use strict";return{alphatest_fragment:["#if defined(ALPHATEST)","if ( gl_FragColor.a < ALPHATEST ) discard;","#endif","#ifdef DISCARD_OR_OPAQUE","gl_FragColor.a = 1.0;","#endif","#if defined(SKIP_TRANSPARENT)","if ( gl_FragColor.a < 1.0 - 1e-3) discard;","#endif"].join("\n")}});var multiTabDecorations=function(){var e=null,t=[],i=0,r=0;this.addDecoration=function(n){e||(e=new Uint8Array(2048),t=[e]);var a=i;if(r+n.length>2048){var s=2048-r,o=r+n.length-2048;this.writeDecoration(n,0,s),r=0,e=new Uint8Array(2048),t.push(e),this.writeDecoration(n,s,o)}else this.writeDecoration(n,0,n.length);return i+=n.length,a+1},this.writeDecoration=function(t,i,n){for(var a=0;a<n;a++)e[r++]=t[i+a]},this.getConcatenatedBlocks=function(){if(0==i)return null;for(var e=new Uint8Array(i),r=0,n=0;n<t.length;n++)for(var a=0;a<2048;a++)e[r++]=t[n][a];return e}};define("DS/Mesh/Mesh",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t=-2,i=i||{REVISION:"1"},r=new Set,n=null!=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),a=new RegExp("Edge","i").test(navigator.userAgent);i.VertexComponentEnum={POSITION:0,NORMAL:1,DIFFUSE_COLOR:2,TEX_COORD_0:3,TEX_COORD_1:4,TEX_COORD_2:5,TEX_COORD_3:6,TEX_COORD_4:7,TEX_COORD_5:8,TEX_COORD_6:9,TEX_COORD_7:10,USER_COMPONENT_0:11},i.DataTypeEnum={UCHAR:0,USHORT:1,UINT:2,CHAR:3,SHORT:4,INT:5,FLOAT:6,DOUBLE:7},i.GeomTypeString={},function(){var t,r,n=["EDGE","WIRE_EDGE","BOUNDARY_EDGE","SHARP_EDGE","SMOOTH_EDGE","HIDDEN_SEAM_EDGE","BOUNDARY_POINT","SHARP_POINT","SMOOTH_POINT","HIDDEN_SEAM_POINT","SURFACIC_POINT","FREE_POINT","INFINITE_FACE","FACE","UNKNOWN","AXIS_SYSTEM"];for(t=0;t<n.length;t++)r=n[t],i.GeomTypeString[e.GeomTypeEnum[r]]=r}(),i.sizeOfDataType=function(e){switch(e){case i.DataTypeEnum.FLOAT:case i.DataTypeEnum.INT:case i.DataTypeEnum.UINT:return 4;case i.DataTypeEnum.CHAR:case i.DataTypeEnum.UCHAR:return 1;case i.DataTypeEnum.SHORT:case i.DataTypeEnum.USHORT:return 2;case i.DataTypeEnum.DOUBLE:return 8;default:return 0}},i.ConnectivityTypeEnum={TRIANGLES:0,TRIANGLE_FAN:1,TRIANGLE_STRIP:2,LINES:3,LINE_STRIP:4,LINE_LOOP:5,POINTS:6},i.PointSymbolEnum={CROSS:0,PLUS:1,CONCENTRIC:2,COINCIDENT:3,FULLCIRCLE:4,FULLSQUARE:5,STAR:6,DOT:7,SMALLDOT:8},i.LinePatternEnum={UNKNOWN:0,SOLID:1,DOTTED:2,DASHED:3,DOTDASHED:4,PHANTOM:5,SMALLDOTTED:6,JISAXIS:7},i.NOPICKABLE=0,i.PICKABLE=1,i.PICKTHROUGH=2;var s=0;Object.defineProperty(i,"NODRAWHL",{get:function(){return s<20&&(e.getWebVisualizationLevel()>425?console.error("NODRAWHL deprecated, use PICKTHROUGH instead"):console.warn("NODRAWHL deprecated, use PICKTHROUGH instead"),s++),i.PICKTHROUGH},set:function(e){}}),i.INVISIBLE=2,i.PICK_NEVER=0,i.PICK_ALWAYS=1,i.PICK_VISIBLE=2,i.PICK_INVISIBLE=3,i.Color=function(e,t,i,r){this.r=e||0,this.g=t||0,this.b=i||0,this.a=null==r?1:r},i.Color.prototype={constructor:i.Color,setRGBA:function(e,t,i,r){this.r=e,this.g=t,this.b=i,this.a=r},copy:function(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a},isEqual:function(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a},clone:function(){return new i.Color(this.r,this.g,this.b,this.a)}},i.FillAttributes=function(e,t,r){this.color=e||new i.Color,this.solid=t||this.solid||0,this.basic=r||this.basic||!1},i.FillAttributes.prototype={constructor:i.FillAttributes,isEqual:function(e){return null!==e&&this.color.isEqual(e.color)&&this.solid===e.solid&&this.basic===e.basic},clone:function(){return new i.FillAttributes(this.color.clone(),this.solid)}},i.LineAttributes=function(e,t,r){this.color=e||new i.Color,this.thickness=Math.round(t)>1?Math.round(t):1,this.pattern=r||i.LinePatternEnum.SOLID,this.forceMaterial=!1},i.LineAttributes.prototype={constructor:i.LineAttributes,isEqual:function(e){return null!==e&&this.color.isEqual(e.color)&&this.thickness===e.thickness&&this.pattern===e.pattern&&this.forceMaterial===e.forceMaterial&&(this.forceLineWidth===e.forceLineWidth||1==this.thickness)},clone:function(){return new i.LineAttributes(this.color.clone(),this.thickness,this.pattern)}},i.PointAttributes=function(e,t,r){this.color=e||new i.Color,this.size=t||1,this.symbol=r||i.PointSymbolEnum.CROSS,this.forceMaterial=!1},i.PointAttributes.prototype={constructor:i.PointAttributes,isEqual:function(e){return null!==e&&this.color.isEqual(e.color)&&this.size===e.size&&this.forceMaterial===e.forceMaterial&&this.symbol===e.symbol},clone:function(){return new i.PointAttributes(this.color.clone(),this.size,this.symbol)}};var o=new i.FillAttributes,l=new i.LineAttributes,c=new i.PointAttributes;i.PrimitiveGroup=function(e){this.identifier=0,this.nbPrimitives=0,this.primitives=[],this.nbBuffers=0,this.buffers=[],this.material=null,this.fillAttr=o,this.lineAttr=l,this.pointAttr=c,this.noz=!1,this.editable=!1,e&&(void 0!==e.fillGAS&&(this.fillAttr=e.fillGAS),void 0!==e.lineGAS&&(this.lineAttr=e.lineGAS),void 0!==e.pointGAS&&(this.pointAttr=e.pointGAS),void 0!==e.identifier&&(this.identifier=e.identifier),void 0!==e.editable&&(this.editable=e.editable),void 0!==e.noz&&(this.noz=e.noz))},i.PrimitiveGroup.prototype={constructor:i.PrimitiveGroup,addPrimitive:function(e){return this.primitives.push(e),this.nbPrimitives++,this},addBuffer:function(e,t){return this.buffers[e]=t,this.nbBuffers++,this},removeBuffer:function(e){this.buffers[e]=null,this.nbBuffers--},getBuffer:function(e){var t;for(t in this.buffers){var i=this.buffers[t];if(i.component===e)return i}return null},getBufferFromId:function(e){var t=this.buffers[e];return void 0!==t?t:null}},i.Buffer=function(e){this.indexBuffer=!1,this.size=0,this.component=i.VertexComponentEnum.POSITION,this.format=i.DataTypeEnum.FLOAT,this.dimension=3,this.data=null,e&&(e.indexBuffer&&(this.indexBuffer=!0),void 0!==e.component&&(this.component=e.component),void 0!==e.format&&(this.format=e.format),e.dimension&&(this.dimension=e.dimension),e.data&&(this.data=e.data))},i.Primitive=function(e){this.identifier=0,this.nbIndices=0,this.connectivity=i.ConnectivityTypeEnum.TRIANGLES,this.nbVertexComponents=0,this.geomType=null,this.vertexComponents=[],this.attr=null,this.material=null,e&&(void 0!==e.nbIndices&&(this.nbIndices=e.nbIndices),void 0!==e.connectivity&&(this.connectivity=e.connectivity),void 0!==e.geomType&&(this.geomType=e.geomType),void 0!==e.identifier&&(this.identifier=e.identifier),(e.fillGAS||e.lineGAS||e.pointGAS)&&(this.attr||(this.attr={fill:o,line:l,point:c}),e.fillGAS&&(this.attr.fill=e.fillGAS),e.lineGAS&&(this.attr.line=e.lineGAS),e.pointGAS&&(this.attr.point=e.pointGAS)))},i.Primitive.prototype={constructor:i.Primitive,addVertexComponent:function(e){return this.vertexComponents.push(e),this.nbVertexComponents++,this},_usedVertexColor:function(){for(var e=0;e<this.vertexComponents.length;e++)if(2==this.vertexComponents[e].component)return this.vertexComponents[e];return!1}},i.VertexComponent=function(e){this.component=i.VertexComponentEnum.POSITION,this.nbVertices=0,this.nbValuesPerVertex=0,this.format=i.DataTypeEnum.FLOAT,this.cardinality=0,this.bufferId="",this.offset=0,this.indices=null,e&&(void 0!==e.nbVertices&&(this.nbVertices=e.nbVertices),void 0!==e.cardinality&&(this.cardinality=e.cardinality),void 0!==e.bufferId&&(this.bufferId=e.bufferId),void 0!==e.indices&&(this.indices=e.indices),void 0!==e.offset&&(this.offset=e.offset))},i.IndexArray=function(e){this.format=i.DataTypeEnum.UINT,this.bufferId="",this.offset=0,e&&(void 0!==e.bufferId&&(this.bufferId=e.bufferId),void 0!==e.offset&&(this.offset=e.offset))},i.Material=function(){this.type="material",this.identifier=0,this.colorAmbient=[],this.colorDiffuse=[],this.colorSpecular=[],this.shininess=0,this.ambientCoef=0,this.diffuseCoef=0,this.specularCoef=0,this.transparent=0,this.reflectivityCoef=0,this.textureId=-1,this.textureImageNumberComposante=0,this.textureBlending=e.TextureBlendOperations.BLEND,this.magFilter=0,this.minFilter=0,this.mappingFunction=0,this.textureWrapS=0,this.textureWrapT=0,this.addedComposantInTexEnv=0,this.shaderMaterial=null},i.Material.prototype={constructor:i.Material,clone:function(){return new i.Material}},i.SGNode=function(e){this.type=0,this.modelIdentification=null,e?(this.cgmId=void 0!==e.cgmId?e.cgmId:-1,void 0!==e.parent?this.parents=[e.parent]:void 0!==e.parents?this.parents=e.parents.slice():this.parents=[],this.solid=void 0!==e.solid&&e.solid):(this.cgmId=-1,this.parents=[],this.solid=!1)},i.SGNode.prototype={constructor:i.SGNode,getModelIdentification:function(){return this.modelIdentification},setModelIdentification:function(e){this.modelIdentification=e},getIdentificationObject:function(){return this.modelIdentification},setIdentificationObject:function(e){this.modelIdentification=e}},Object.defineProperty(i.SGNode.prototype,"parent",{get:function(){return this.parents.length?this.parents[0]:null},set:function(e){this.parents[0]=e}}),i.ThicknessTable=[1,1,2,3,4,5,6,7,8],i.GraphicAttributeSet=function(e,t){this.set=e||0,this.rgba=t||0},i.GraphicAttributeSet.prototype={constructor:i.GraphicAttributeSet,setConnectivity:function(e){var t;switch(e){case i.ConnectivityTypeEnum.POINTS:this.set=4278194171&this.set,t=0;break;case i.ConnectivityTypeEnum.LINES:case i.ConnectivityTypeEnum.LINE_STRIP:case i.ConnectivityTypeEnum.LINE_LOOP:this.set=268435451&this.set,t=1;break;case i.ConnectivityTypeEnum.TRIANGLES:case i.ConnectivityTypeEnum.TRIANGLE_STRIP:case i.ConnectivityTypeEnum.TRIANGLE_FAN:case i.ConnectivityTypeEnum.TRIANGLE_FAN:t=2,this.set=251662335&this.set;break;default:t=2}this.set&=-4,this.set|=3&t},isEqual:function(e){return this.set==e.set&&this.rgba==e.rgba},getBlankingRep:function(){var e=this.getPriority();this.set=0,this.rgba=0,this.setConnectivity(2),this.setPriority(e),this.setBasic(),this.set&=-4194305,this.set|=1<<22},setColor:function(e){this.set&=~(15<<24),this.set|=(15&e)<<24},setSymbol:function(e){this.set&=268435455,this.set|=(15&e)<<28},setRGBAColorRGBChannel:function(e,t,i){this.rgba&=255,this.rgba|=(16777215&(e<<16|t<<8|i))<<8},setRGBAColorAlphaChannel:function(e){this.rgba&=-256,this.rgba|=255&e},setLinetype:function(e){this.set&=-3932161,this.set|=(15&e)<<18},setPriority:function(e){this.set&=-3841,this.set|=(15&e)<<8},setBasic:function(){this.set&=-5,this.set|=4},setVertexColor:function(){this.set&=-8388609,this.set|=1<<23},setType:function(e){this.set&=-49,this.set|=(3&e)<<4},setShowMode:function(e){this.set&=-9,this.set|=(1&e)<<3},setLineThickness:function(e){this.set&=-258049,this.set|=(63&e)<<12},getColor:function(){return this.set>>24&15},getSymbol:function(){return this.set>>28&15},getRGBAColor:function(){var e=[];return e[0]=this.rgba>>24&255,e[1]=this.rgba>>16&255,e[2]=this.rgba>>8&255,e[3]=255&this.rgba,e},getDisplayedColor:function(){if(15==this.getColor())return this.getRGBAColor();var e=[];switch(this.getColor()){case 14:case 13:e[0]=0,e[1]=0,e[2]=0,e[3]=255;break;case 12:e[0]=62,e[1]=102,e[2]=85,e[3]=255;break;case 11:case 10:e[0]=255,e[1]=128,e[2]=0,e[3]=255;break;case 9:e[0]=0,e[1]=0,e[2]=0,e[3]=255;break;case 8:e[0]=255,e[1]=255,e[2]=255,e[3]=255;break;case 7:e[0]=255,e[1]=0,e[2]=0,e[3]=255;break;case 6:e[0]=0,e[1]=255,e[2]=0,e[3]=255;break;case 5:e[0]=0,e[1]=0,e[2]=255,e[3]=255;break;case 4:e[0]=255,e[1]=255,e[2]=0,e[3]=255;break;case 3:e[0]=255,e[1]=0,e[2]=255,e[3]=255;break;case 2:e[0]=0,e[1]=255,e[2]=255,e[3]=255;break;case 1:e[0]=0,e[1]=255,e[2]=0,e[3]=255;break;case 0:e[0]=255,e[1]=0,e[2]=0,e[3]=255;break;default:e[0]=0,e[1]=0,e[2]=0,e[3]=255}return e},getAdvancedLinetype:function(){return 64*(this.set>>12&63)+(this.set>>18&63)},getLinetype:function(){return this.set>>18&15},getLineThickness:function(){var e=this.set>>12&63;return e=e>i.ThicknessTable.length?1:i.ThicknessTable[e]},isBackgroundColor:function(){return 14==(this.set>>24&15)},getType:function(){return this.set>>4&3},getPriority:function(){return this.set>>8&15},getSymbol:function(){return this.set>>28&15},isNoZ:function(){return 0==this.getType()},isSolid:function(){return 3==this.getType()?1:0},isHidden:function(){return this.set>>3&1},isTransparent:function(){return this.set>>7&1},clone:function(){return new i.GraphicAttributeSet(this.set,this.rgba)}},i.SGBag=function(e){i.SGNode.call(this,e),e=e||{},this.type=1,this.matrix=void 0!==e.matrix?e.matrix:null,this.children=void 0!==e.children?e.children:[],this.namingContext=void 0!==e.namingContext?e.namingContext:0,this.uuid_1=void 0!==e.uuid_1?e.uuid_1:null,this.uuid_2=void 0!==e.uuid_2?e.uuid_2:null,this.uuid_3=void 0!==e.uuid_3?e.uuid_3:null,this.uuid_4=void 0!==e.uuid_4?e.uuid_4:null,this.noShow=void 0!==e.noShow&&e.noShow},i.SGBag.prototype=Object.create(i.SGNode.prototype),i.SGBag.prototype.constructor=i.SGBag,i.SGBag.prototype.childClone=function(){var e=new Array;for(var t in this.children)e[t]="object"==typeof this.children[t]?this.children[t].clone():this.children[t];return e},i.SGBag.prototype.clone=function(){return new i.SGBag({cgmId:this.cgmId,type:this.type,children:this.childClone(),matrix:null!==this.matrix?this.matrix.clone():null,parents:this.parents,solid:this.solid,uuid_1:this.uuid_1,uuid_2:this.uuid_2,uuid_3:this.uuid_3,uuid_4:this.uuid_4,noShow:this.noShow})},i.SGBag.prototype.copyNoChildren=function(e){this.cgmId=e.cgmId,this.matrix=e.matrix,this.parents=e.parents.slice(),this.solid=e.solid,this.namingContext=e.namingContext,this.noShow=e.noShow,e.uuid_1&&(this.uuid_1=e.uuid_1,this.uuid_2=e.uuid_2,this.uuid_3=e.uuid_3,this.uuid_4=e.uuid_4)},i.SGBag.prototype.computeBoundingSphere=function(t){var i,r=new e.Sphere;for((t=t||new e.Sphere).reset(),i=0;i<this.children.length;i++)this.children[i].computeBoundingSphere(r),r.mergeWithSphere(t,t);return t},i.SGBag.prototype._computeOrientedBoundingBox=function(t,i,r,n,a){for(var s,o=new e.Box3,l=0;l<this.children.length;l++){(s=this.children[l]._computeOrientedBoundingBox(t,i,r,n,a))&&(o=o.union(s))}return o},i.UUID=function(){this.uuid_1=0,this.uuid_2=0,this.uuid_3=0,this.uuid_4=0},i.UUID.prototype={constructor:i.UUID,setFromUint32:function(e,t,i,r){this.uuid_1=e,this.uuid_2=t,this.uuid_3=i,this.uuid_4=r},toString:function(){return this.uuid_1.toString(16)+"_"+this.uuid_2.toString(16)+"_"+this.uuid_3.toString(16)+"_"+this.uuid_4.toString(16)},isEqual:function(e){return this.uuid_1===e.uuid_1&&this.uuid_2===e.uuid_2&&this.uuid_3===e.uuid_3&&this.uuid_4===e.uuid_4},clone:function(){var e=new i.UUID;return e.uuid_1=this.uuid_1,e.uuid_2=this.uuid_2,e.uuid_3=this.uuid_3,e.uuid_4=this.uuid_4,e}},i.SGRep=function(e){i.SGNode.call(this,e),this.type=2,e?(this.matrix=void 0!==e.matrix?e.matrix:null,this._primitives=void 0!==e.primitives?e.primitives:[],this.boundingSphere=void 0!==e.boundingSphere?e.boundingSphere:null,this.sag=void 0!==e.sag?e.sag:null,this.namingContext=void 0!==e.namingContext?e.namingContext:0):(this.matrix=null,this._primitives=[],this.boundingSphere=null,this.sag=null,this.namingContext=0),this._binary=!1},i.SGRep.prototype=Object.create(i.SGNode.prototype),Object.assign(i.SGRep.prototype,{constructor:i.SGRep,primitivesClone:function(){for(var e=[],t=0;t<this._primitives.length;t++){var i=this._primitives[t];i.clone?e.push(i.clone()):e.push(i)}return e},clone:function(){var e=new i.SGRep({cgmId:this.cgmId,type:this.type,primitives:this.primitivesClone(),matrix:this.matrix?this.matrix.clone():null,parent:this.parent,solid:this.solid,sag:this.sag,boundingSphere:this.boundingSphere?{radius:this.boundingSphere.radius,center:[this.boundingSphere.center[0],this.boundingSphere.center[1],this.boundingSphere.center[2]]}:null});return e._binary=this._binary,e},_getIndex:function(e){var t={ind:-1,subInd:-1};if(!this._binary)return t.ind=e,t;for(var i=0,r=0;r<this._primitives.length;r++){var n=this._primitives[r];if(e<i+n.count){t.ind=r,t.subInd=e-i+n.start;break}i+=n.count}return t},getPrimitiveCgmId:function(e){var t=this._getIndex(e),i=this._primitives[t.ind];return-1!==t.subInd?i.binary.getPrimitiveCgmId(t.subInd):i.cgmId},_setPrimitiveCgmId:function(e,t){var i=this._getIndex(t),r=this._primitives[i.ind];-1===i.subInd?r.cgmId=e:r.binary._setPrimitiveCgmId(e,i.subInd)},getPrimitiveType:function(e){var t=this._getIndex(e),i=this._primitives[t.ind];return-1!==t.subInd?i.binary.getPrimitiveType(t.subInd):i.type},_getSGPrimitive:function(e,t){var i=this._getIndex(e),r=this._primitives[i.ind];return-1!==i.subInd?r.binary._getSGPrimitive(i.subInd,t):t?r:r.clone()},_getPrimitiveInternalNode:function(e){var t=this._getIndex(e),i=this._primitives[t.ind];return-1!==t.subInd?i.binary._getPrimitiveInternalNode(t.subInd):i.internalNode},_setPrimitiveRep:function(e,t){var i=this._getIndex(t),r=this._primitives[i.ind];-1===i.subInd?r.rep=e:r.binary._setPrimitiveRep(e,i.subInd)},_setPrimitiveInternalNode:function(e,t){var i=this._getIndex(t),r=this._primitives[i.ind];-1===i.subInd?r.internalNode=e:r.binary._setPrimitiveInternalNode(e,i.subInd)},getPrimitiveRep:function(e){var t=this._getIndex(e),i=this._primitives[t.ind];return-1!==t.subInd?i.binary.getPrimitiveRep(t.subInd):i.rep},_setPrimitiveStart:function(e,t){var i=this._getIndex(t),r=this._primitives[i.ind];-1===i.subInd?r.start=e:r.binary._setPrimitiveStart(e,i.subInd)},_setPrimitiveCount:function(e,t){var i=this._getIndex(t),r=this._primitives[i.ind];-1===i.subInd?r.count=e:r.binary._setPrimitiveCount(e,i.subInd)},getPrimitiveStart:function(e){var t=this._getIndex(e),i=this._primitives[t.ind];return-1!==t.subInd?i.binary.getPrimitiveStart(t.subInd):i.start},getPrimitiveCount:function(e){var t=this._getIndex(e),i=this._primitives[t.ind];return-1!==t.subInd?i.binary.getPrimitiveCount(t.subInd):i.count},getPrimitiveGroup:function(e){var t=this._getIndex(e),i=this._primitives[t.ind];return-1!==t.subInd?i.binary.getPrimitiveGroup(t.subInd):i.group},getPrimitiveDecoration:function(e){var t=this._getIndex(e),i=this._primitives[t.ind];return-1!==t.subInd?i.binary.getPrimitiveDecoration(t.subInd):i.decoration},getPrimitiveBoundingSphere:function(e){var t=this._getIndex(e),i=this._primitives[t.ind];return-1!==t.subInd?i.binary.getPrimitiveBoundingSphere(t.subInd):i.boundingSphere},setPrimitiveBoundingSphere:function(e,t){var i=this._getIndex(e),r=this._primitives[i.ind];-1===i.subInd?r.boundingSphere=t:r.binary.setPrimitiveBoundingSphere(i.subInd,t)},getPrimitivesCount:function(){if(!this._binary)return this._primitives.length;for(var e=0,t=0;t<this._primitives.length;t++){e+=this._primitives[t].count}return e},getPrimitiveIdentificationObject:function(e){var t=this._getIndex(e),i=this._primitives[t.ind];return-1!==t.subInd?i.binary.getPrimitiveIdentificationObject(t.subInd):i.IdentObj},setPrimitiveIdentificationObject:function(e,t){var i=this._getIndex(t),r=this._primitives[i.ind];-1!==i.subInd&&r.binary.setPrimitiveIdentificationObject(e,i.subInd),r.IdentObj=e},computePrimitiveBoundingSphere:function(e){var t=this._getIndex(e),i=this._primitives[t.ind];return-1!==t.subInd?i.binary.computePrimitiveBoundingSphere(t.subInd):i.computeBoundingSphere()},startIteration:function(){return!0},endIteration:function(){return!0},computeBoundingSphere:function(t){if(!this.boundingSphere){this.boundingSphere=new e.Sphere;var i,r,n,a=new e.Sphere;for(i=0;i<this._primitives.length;i++)if(this._binary)for(n=(r=this._primitives[i]).start;n<r.start+r.count;n++)r.binary.computePrimitiveBoundingSphere(n,a),a.mergeWithSphere(this.boundingSphere,this.boundingSphere);else this._primitives[i].computeBoundingSphere(a),a.mergeWithSphere(this.boundingSphere,this.boundingSphere)}return t?(t.copy(this.boundingSphere),t):this.boundingSphere},_computeOrientedBoundingBox:function(t,i,r,n,a){var s,o,l,c,h=new e.Box3;for(s=0;s<this._primitives.length;s++)if(c=this._primitives[s],this._binary)for(o=c.start;o<c.start+c.count;o++)null!==(l=c.binary._computePrimitiveOrientedBoundingBox(o,t,i,r,n,a))&&(h=h.union(l));else null!==(l=c._computeOrientedBoundingBox(t,i,r,n,a))&&(h=h.union(l));return h},_computePrimitiveOrientedBoundingBox:function(e,t,i,r,n,a){var s=this._getIndex(e),o=this._primitives[s.ind];return-1!==s.subInd?o.binary._computePrimitiveOrientedBoundingBox(s.subInd,t,i,r,n,a):o._computeOrientedBoundingBox(t,i,r,n,a)}});var h=0;Object.defineProperty(i.SGRep.prototype,"primitives",{get:function(){if(h<10){var e=new Error,t="#PrimApi - SGRep.GetPrimitives - "+(e.stack?e.stack.split("\n")[1]+" - "+e.stack.split("\n")[2]:"");r.has(t.hashCode())||(r.add(t.hashCode()),console.error(t),h++)}return this._primitives},set:function(){throw"NO"}}),i.BinarySGPrimitiveArray=function(e,t,i,r,n){this.data=e,this.size=n,this.sgRep=i,this.dg=t,this.bSpheres=r||null,this.IdentObj=[],this.internalNodes=[]},i.BinarySGPrimitiveArray.prototype.constructor=i.BinarySGPrimitiveArray,i.BinarySGPrimitiveArray.prototype.clone=function(){return new i.BinarySGPrimitiveArray(this.data.slice(),this.dg,this.sgRep,this.bSpheres?this.bSpheres.slice():null,this.size)},i.BinarySGPrimitiveArray.prototype._compactArrays=function(){var e=this.IdentObj;this.IdentObj=new Array(e.length);for(var t=0;t<e.length;t++)this.IdentObj[t]=e[t];var i=this.internalNodes;this.internalNodes=new Array(i.length);for(t=0;t<i.length;t++)this.internalNodes[t]=i[t]},i.BinarySGPrimitiveArray.prototype._getSGPrimitive=function(e,t){var r=this.size*e,n=this.data,a=n[r]-1,s=this.getPrimitiveRep(e),o=n[r+2],l=n[r+3],c=n[r+4],h=this.getPrimitiveBoundingSphere(e),u=new i.SGPrimitive;return u.decoration=c,u.group=this.dg,u.rep=s,u.count=l,u.start=o,u.cgmId=a,u.boundingSphere=h,u},i.BinarySGPrimitiveArray.prototype.getPrimitiveCgmId=function(e){var t=this.size*e;return this.data[t]-1},i.BinarySGPrimitiveArray.prototype._setPrimitiveCgmId=function(e,t){if("number"!=typeof e)throw"Cgmid must be a number";var i=this.size*t;this.data[i]=e+1},i.BinarySGPrimitiveArray.prototype.getPrimitiveType=function(e){return 3},i.BinarySGPrimitiveArray.prototype._getPrimitiveInternalNode=function(e){return this.internalNodes[e]},i.BinarySGPrimitiveArray.prototype._setPrimitiveInternalNode=function(e,t){0===this.internalNodes.length&&(this.internalNodes=new Array(this.getPrimitivesCount())),this.internalNodes[t]=e},i.BinarySGPrimitiveArray.prototype._setPrimitiveRep=function(e,t){var i=this.sgRep.indexOf(e);i>=0?this.data[this.size*t+1]=i:(this.sgRep.push(e),this.data[this.size*t+1]=this.sgRep.length-1)},i.BinarySGPrimitiveArray.prototype.getPrimitiveRep=function(e){var t=this.data[this.size*e+1];return this.sgRep[t]},i.BinarySGPrimitiveArray.prototype.getPrimitiveStart=function(e){var t=this.size*e;return this.data[t+2]},i.BinarySGPrimitiveArray.prototype.getPrimitiveGroup=function(e){return this.dg},i.BinarySGPrimitiveArray.prototype._setPrimitiveStart=function(e,t){var i=this.size*t;this.data[i+2]=e},i.BinarySGPrimitiveArray.prototype.getPrimitiveCount=function(e){var t=this.size*e;return this.data[t+3]},i.BinarySGPrimitiveArray.prototype._setPrimitiveCount=function(e,t){var i=this.size*t;this.data[i+3]=e},i.BinarySGPrimitiveArray.prototype.getPrimitiveDecoration=function(e){var t=this.size*e;return this.data[t+4]},i.BinarySGPrimitiveArray.prototype.getPrimitiveBoundingSphere=function(t){if(null!==this.bSpheres){var i=new e.Sphere;return i.setSimple(this.bSpheres[4*t],this.bSpheres[4*t+1],this.bSpheres[4*t+2],this.bSpheres[4*t+3]),i.radius>=0?i:null}return null},i.BinarySGPrimitiveArray.prototype._computePrimitiveOrientedBoundingBox=function(e,t,i,r,n,a){return this.dg._computeOrientedBoundingBox(t,i,r,n,this.getPrimitiveStart(e),this.getPrimitiveCount(e),a)},i.BinarySGPrimitiveArray.prototype.setPrimitiveBoundingSphere=function(e,t){null===this.bSpheres&&(this.bSpheres=new Float32Array(4*this.getPrimitivesCount()),this.bSpheres.fill(-1)),null===t?(this.bSpheres[4*e]=-1,this.bSpheres[4*e+1]=-1,this.bSpheres[4*e+2]=-1,this.bSpheres[4*e+3]=-1):(this.bSpheres[4*e]=t.center.x,this.bSpheres[4*e+1]=t.center.y,this.bSpheres[4*e+2]=t.center.z,this.bSpheres[4*e+3]=t.radius)},i.BinarySGPrimitiveArray.prototype.getPrimitivesCount=function(){return this.data.length/this.size},i.BinarySGPrimitiveArray.prototype.getPrimitiveIdentificationObject=function(e){return this.IdentObj[e]},i.BinarySGPrimitiveArray.prototype.setPrimitiveIdentificationObject=function(e,t){0===this.IdentObj.length&&(this.IdentObj=new Array(this.getPrimitivesCount())),this.IdentObj[t]=e},i.BinarySGPrimitiveArray.prototype.computePrimitiveBoundingSphere=function(t,i){var r=this.getPrimitiveStart(t),n=this.getPrimitiveCount(t);if(0!=n){var a=this.dg.geometry,s=0,o=(t=a.vertexIndexArray[r],new e.Vector3);a.getVertexPosition(t,o);for(var l=o.x,c=o.y,h=o.z,u=l,d=c,p=h,f=1;f<n;++f){t=a.vertexIndexArray[r+f],a.getVertexPosition(t,o),(_=o.x)<l?l=_:_>u&&(u=_),(y=o.y)<c?c=y:y>d&&(d=y),(S=o.z)<h?h=S:S>p&&(p=S)}var m=(l+u)/2,g=(c+d)/2,v=(h+p)/2;for(s=0,f=0;f<n;++f){t=a.vertexIndexArray[r+f],a.getVertexPosition(t,o);var S,_=o.x,y=o.y,x=((S=o.z)-v)*(S-v)+(y-g)*(y-g)+(_-m)*(_-m);x>s&&(s=x)}return s=Math.sqrt(s),(i=i||new e.Sphere).setSimple(m,g,v,s),i}},i.SGPrimitive=function(e){this.type=3,this.IdentObj=null,this.internalNode=null,e?(this.cgmId=void 0!==e.cgmId?e.cgmId:-1,this.rep=void 0!==e.rep?e.rep:null,this.group=void 0!==e.group?e.group:null,this.start=void 0!==e.start?e.start:0,this.count=void 0!==e.count?e.count:0,this.boundingSphere=void 0!==e.boundingSphere?e.boundingSphere:void 0,this.decoration=void 0!==e.decoration?e.decoration:0):(this.cgmId=-1,this.rep=null,this.group=null,this.start=0,this.count=0,this.boundingSphere=void 0,this.decoration=0)},i.SGPrimitive.prototype={constructor:i.SGPrimitive,getIdentificationObject:function(){return this.IdentObj},setIdentificationObject:function(e){this.IdentObj=e},isEqual:function(e){return this.getGroup()===e.getGroup()&&this.getRep()===e.getRep()&&this.getStart()===e.getStart()&&this.getCount()===e.getCount()&&this.getCgmId()===e.getCgmId()},computeBoundingSphere:function(t){t=t||new e.Sphere;var i=this.start,r=this.count;if(0!=r){var n=this.group.geometry,a=n.vertexIndexArray,s=0,o=a[i],l=new e.Vector3;n.getVertexPosition(o,l);for(var c=l.x,h=l.y,u=l.z,d=c,p=h,f=u,m=1;m<r;++m){o=a[i+m],n.getVertexPosition(o,l),(y=l.x)<c?c=y:y>d&&(d=y),(x=l.y)<h?h=x:x>p&&(p=x),(_=l.z)<u?u=_:_>f&&(f=_)}var g=(c+d)/2,v=(h+p)/2,S=(u+f)/2;for(s=0,m=0;m<r;++m){o=a[i+m],n.getVertexPosition(o,l);var _,y=l.x,x=l.y,M=((_=l.z)-S)*(_-S)+(x-v)*(x-v)+(y-g)*(y-g);M>s&&(s=M)}return s=Math.sqrt(s),t.setSimple(g,v,S,s),t}},_computeOrientedBoundingBox:function(e,t,i,r,n){return this.group._computeOrientedBoundingBox(e,t,i,r,this.start,this.count,n)},getCgmId:function(){return this.cgmId},_setCgmId:function(e){this.cgmId=e},getType:function(){return this.type},_getInternalNode:function(){return this.internalNode},_setInternalNode:function(e){this.internalNode=e},getRep:function(){return this.rep},getStart:function(){return this.start},getCount:function(){return this.count},getGroup:function(){return this.group},getDecoration:function(){return this.decoration},getBoundingSphere:function(){return this.boundingSphere},startIteration:function(){return this.group.startIteration()},endIteration:function(){return this.group.endIteration()},_copyPrimitive:function(e){this.cgmId=e.cgmId,this.rep=e.rep,this.group=e.group,this.start=e.start,this.count=e.count,this.boundingSphere=e.boundingSphere?{radius:e.boundingSphere.radius,center:[e.boundingSphere.center[0],e.boundingSphere.center[1],e.boundingSphere.center[2]]}:void 0,this.decoration=e.decoration},clone:function(){var e=new i.SGPrimitive;return e._copyPrimitive(this),e}},i.SGPrimitiveHelper=function(){this.container=null,this.index=-1},i.SGPrimitiveHelper.prototype={constructor:i.SGPrimitiveHelper,clone:function(){var e=new i.SGPrimitiveHelper;return e.set(this.container,this.index),e},set:function(e,t){if(!e instanceof i.DrawingGroup||!e instanceof i.SGRep)throw"Error: container must be a Mesh.DrawingGroup or Mesh.SGRep";this.container=e,this.index=t},isEqual:function(e){return this.getGroup()===e.getGroup()&&this.getRep()===e.getRep()&&this.getStart()===e.getStart()&&this.getCount()===e.getCount()&&this.getCgmId()===e.getCgmId()},getCgmId:function(){return this.container.getPrimitiveCgmId(this.index)},_setCgmId:function(e){this.container._setPrimitiveCgmId(e,this.index)},getType:function(){return this.container.getPrimitiveType(this.index)},_getSGPrimitive:function(e){return this.container._getSGPrimitive(this.index,e)},_getInternalNode:function(){return this.container._getPrimitiveInternalNode(this.index)},_setInternalNode:function(e){this.container._setPrimitiveInternalNode(e,this.index)},_setRep:function(e){return this.container._setPrimitiveRep(e,this.index)},getRep:function(){return this.container.getPrimitiveRep(this.index)},getStart:function(){return this.container.getPrimitiveStart(this.index)},getCount:function(){return this.container.getPrimitiveCount(this.index)},getGroup:function(){return this.container.getPrimitiveGroup(this.index)},getDecoration:function(){return this.container.getPrimitiveDecoration(this.index)},getBoundingSphere:function(){return this.container.getPrimitiveBoundingSphere(this.index)},setBoundingSphere:function(e){this.container.setPrimitiveBoundingSphere(this.index,e)},getIdentificationObject:function(){return this.container.getPrimitiveIdentificationObject(this.index)},setIdentificationObject:function(e){this.container.setPrimitiveIdentificationObject(e,this.index)},computeBoundingSphere:function(e){return this.container.computePrimitiveBoundingSphere(this.index,e)},_computeOrientedBoundingBox:function(e,t,i,r,n){return this.container._computePrimitiveOrientedBoundingBox(this.index,e,t,i,r,n)},startIteration:function(){return this.container.startIteration()},endIteration:function(){return this.container.endIteration()}};var u=0;Object.defineProperty(i.SGPrimitiveHelper.prototype,"start",{get:function(){if(u<25){var e=new Error,t="#PrimApi - helper.GetStart - "+(e.stack?e.stack.split("\n")[1]+" - "+e.stack.split("\n")[2]:"");r.has(t.hashCode())||(r.add(t.hashCode()),console.error(t)),u++}return this.getStart()},set:function(){throw"NO"}}),Object.defineProperty(i.SGPrimitiveHelper.prototype,"count",{get:function(){if(u<25){var e=new Error,t="#PrimApi - helper.GetCount - "+(e.stack?e.stack.split("\n")[1]+" - "+e.stack.split("\n")[2]:"");r.has(t.hashCode())||(r.add(t.hashCode()),console.error(t)),u++}return this.getCount()},set:function(){throw"NO"}}),Object.defineProperty(i.SGPrimitiveHelper.prototype,"cgmId",{get:function(){if(u<25){var e=new Error,t="#PrimApi - helper.GetCgmId - "+(e.stack?e.stack.split("\n")[1]+" - "+e.stack.split("\n")[2]:"");r.has(t.hashCode())||(r.add(t.hashCode()),console.error(t)),u++}return this.getCgmId()},set:function(e){if(u<25){var t=new Error,i="#PrimApi - helper.SetCgmId - "+(t.stack?t.stack.split("\n")[1]+" - "+t.stack.split("\n")[2]:"");r.has(i.hashCode())||(r.add(i.hashCode()),console.error(i)),u++}this._setCgmId(e)}}),Object.defineProperty(i.SGPrimitiveHelper.prototype,"rep",{get:function(){if(u<25){var e=new Error,t="#PrimApi - helper.GetRep - "+(e.stack?e.stack.split("\n")[1]+" - "+e.stack.split("\n")[2]:"");r.has(t.hashCode())||(r.add(t.hashCode()),console.error(t)),u++}return this.getRep()},set:function(){throw"NO"}}),Object.defineProperty(i.SGPrimitiveHelper.prototype,"boundingSphere",{get:function(){if(u<25){var e=new Error,t="#PrimApi - helper.GetBS - "+(e.stack?e.stack.split("\n")[1]+" - "+e.stack.split("\n")[2]:"");r.has(t.hashCode())||(r.add(t.hashCode()),console.error(t)),u++}return this.getBoundingSphere()},set:function(){throw"NO"}}),Object.defineProperty(i.SGPrimitiveHelper.prototype,"type",{get:function(){if(u<25){var e=new Error,t="#PrimApi - helper.GetType - "+(e.stack?e.stack.split("\n")[1]+" - "+e.stack.split("\n")[2]:"");r.has(t.hashCode())||(r.add(t.hashCode()),console.error(t)),u++}return this.getType()},set:function(){throw"NO"}}),Object.defineProperty(i.SGPrimitiveHelper.prototype,"group",{get:function(){if(u<25){var e=new Error,t="#PrimApi - helper.GetGroup - "+(e.stack?e.stack.split("\n")[1]+" - "+e.stack.split("\n")[2]:"");r.has(t.hashCode())||(r.add(t.hashCode()),console.error(t)),u++}return this.getGroup()},set:function(){throw"NO"}}),Object.defineProperty(i.SGPrimitiveHelper.prototype,"decoration",{get:function(){if(u<25){var e=new Error,t="#PrimApi - helper.GetDeco - "+(e.stack?e.stack.split("\n")[1]+" - "+e.stack.split("\n")[2]:"");r.has(t.hashCode())||(r.add(t.hashCode()),console.error(t)),u++}return this.getDecoration()},set:function(){throw"NO"}});var d={EDGE:1,WIRE_EDGE:2,BOUNDARY_EDGE:3,SHARP_EDGE:4,SMOOTH_EDGE:5,BOUNDARY_POINT:6,SHARP_POINT:7,SMOOTH_POINT:8,SURFACIC_POINT:9,FREE_POINT:10,INFINITE_FACE:11,FACE:12,UNKNOWN:13};i.getConvertedVec3=function(t,i){var r=[t[i],t[i+1],t[i+2]];return new e.Vector3(r[0],r[1],r[2])},i.isEqualGAS=function(e,t){return null==e&&null==t||!(null==e&&null!=t||null!=e&&null==t)&&(e.fill.isEqual(t.fill)&&e.line.isEqual(t.line)&&e.point.isEqual(t.point))},i.isEqualMaterial=function(e,t){return null==e&&null==t||!(null==e&&null!=t||null!=e&&null==t)&&(e.id==t.id&&e.file==t.file)},i.convertToMaterial3js=function(t,i){if(null==t)return null;var r=null,n=1,a=null;switch(i){case 0:n=null==t.point.color.a?1:t.point.color.a,a=new e.Color,t.point.color&&(a.setRGB(t.point.color.r,t.point.color.g,t.point.color.b),r={color:a,opacity:n,symbol:t.point.symbol,pointsize:t.point.size},t.point.forceMaterial&&(r.forceMaterial=!0));break;case 1:n=null==t.line.color.a?1:t.line.color.a,a=new e.Color,t.line.color&&(a.setRGB(t.line.color.r,t.line.color.g,t.line.color.b),r={color:a,opacity:n,lineWidth:t.line.thickness,pattern:t.line.pattern},t.line.forceMaterial&&(r.forceMaterial=!0));break;case 2:n=null==t.fill.color.a?1:t.fill.color.a,a=new e.Color,t.fill.color&&(a.setRGB(t.fill.color.r,t.fill.color.g,t.fill.color.b),r={color:a,opacity:n,solid:t.fill.solid,basic:t.fill.basic})}return r},i.areEqualGraphicProperties=function(e,t){return null!=e.color&&null!=t.color&&(e.color.r==t.color.r&&e.color.g==t.color.g&&e.color.b==t.color.b&&((!e.thickness||!t.thickness||e.thickness==t.thickness)&&((!e.pointsize||!t.pointsize||e.pointsize==t.pointsize)&&e.opacity==t.opacity)))},i.validatePrimitiveGroup=function(e){var t,r;for(t=0;t<e.buffers.length;t++){(s=e.buffers[t])&&(s.size=s.data.byteLength/i.sizeOfDataType(s.format),s.indexBuffer&&(s.format=i.DataTypeEnum.UINT,s.dimension=1))}for(t=0;t<e.primitives.length;t++){var n=e.primitives[t];for(n.attr||(n.attr={fill:e.fillAttr,line:e.lineAttr,point:e.pointAttr}),r=0;r<n.nbVertexComponents;r++){var a=n.vertexComponents[r],s=e.getBufferFromId(a.bufferId);a.component=s.component,a.nbValuesPerVertex=s.dimension,a.format=s.format}}},i.checkMeshOptimizable=function(e){for(var t=null,r=[],n=0;n<e.buffers.length;n++){var a=e.buffers[n];if(a)if(a.indexBuffer){if(t)return!1;t=a}else{if(r[a.component])return!1;r[a.component]=a}}for(var s=0;s<e.primitives.length;s++){var o=e.primitives[s];if(o.connectivity===i.ConnectivityTypeEnum.TRIANGLE_STRIP||o.connectivity===i.ConnectivityTypeEnum.TRIANGLE_FAN||o.connectivity===i.ConnectivityTypeEnum.LINE_STRIP)return!1}return!0},i.createGeometryOptimized=function(t,r){var n=new i.Mesh;n.rep=r;for(var a=0;a<t.buffers.length;a++){var s=t.buffers[a],o=s.component,l=s.data;if(s.indexBuffer)n.vertexIndexArray=l;else switch(o){case i.VertexComponentEnum.POSITION:n.vertexPositionArray=l;break;case i.VertexComponentEnum.NORMAL:n.vertexNormalArray=l;break;case i.VertexComponentEnum.DIFFUSE_COLOR:n.vertexColorArray=l;break;case i.VertexComponentEnum.TEX_COORD_0:n.vertexUvArray=l;break;case i.VertexComponentEnum.TEX_COORD_1:n.vertexUv2Array=l;break;case i.VertexComponentEnum.TEX_COORD_2:n.vertexTangentArray=l;break;case i.VertexComponentEnum.TEX_COORD_3:n.vertexBinormalArray=l}}var c=[],h=[],u=t.nbPrimitives;for(a=0;a<u;a++){var p=t.primitives[a],f=!!p.vertexComponents[0].indices,m=0,g=c.length;if(f){for(m=0;m<g;m++){var v=c[m];if(v.connectivity==p.connectivity&&v.geomType==p.geomType&&i.isEqualGAS(v.gas,p.attr)&&(null==v.material&&null==p.material||v.material.id==p.material.id&&v.material.file==p.material.file)){v.set.push(p),v.nbIndices+=p.nbIndices;break}}if(m===c.length){var S={connectivity:p.connectivity,geomType:p.geomType,gas:p.attr,material:p.material,nbIndices:p.nbIndices,set:[p]};c.push(S)}}else h.push(p)}c.sort(function(e,t){if(e.connectivity<t.connectivity)return-1;if(e.connectivity>t.connectivity)return 1;if(e.geomType&&t.geomType){var i=d[e.geomType],r=d[t.geomType];if(i&&r)return i-r}return 0});for(a=0;a<c.length;a++)c[a].set.sort(function(e,t){var i=e.vertexComponents[0].indices,r=t.vertexComponents[0].indices;return i&&r?i.offset-r.offset:0});for(a=0;a<c.length;a++)for(var _=c[a],y=[],x=_.set[0].vertexComponents[0].indices.offset,M=_.set[0].vertexComponents[0].indices.offset,P=0,C=0;C<_.set.length;)for(m=C;m<_.set.length;m++){var b=_.set[m];if(!b.vertexComponents[0].indices||b.vertexComponents[0].indices.offset!==M||m===_.set.length-1){m===_.set.length-1?(y.push(b),P+=b.nbIndices,C=m+1):C=m;var D=4===(A=_.connectivity===i.ConnectivityTypeEnum.TRIANGLES?4:_.connectivity===i.ConnectivityTypeEnum.LINES?1:0)?2:A;(I=new i.DrawingGroup(i.convertToMaterial3js(_.gas,D),_.material,A,x,P,void 0,void 0,e.GeomTypeEnum[_.geomType]))._geomType=_.geomType?e.GeomTypeEnum[_.geomType]:0,n.drawingGroups.push(I);for(var w=0;w<y.length;w++){var E=y[w],T=new i.SGPrimitive({cgmId:E.identifier,rep:n.rep,group:I,start:E.vertexComponents[0].indices.offset,count:E.nbIndices});I._primitives.push(T),n.rep._primitives.push(T)}x=b.vertexComponents[0].indices.offset,M=b.vertexComponents[0].indices.offset,P=0,y.length=0;break}y.push(b),M+=b.nbIndices,P+=b.nbIndices}for(a=0;a<h.length;a++){var A,I;D=4===(A=(E=h[a]).connectivity===i.ConnectivityTypeEnum.TRIANGLES?4:E.connectivity===i.ConnectivityTypeEnum.LINES?1:0)?2:A;(I=new i.DrawingGroup(i.convertToMaterial3js(E.attr,D),E.material,A,E.vertexComponents[0].offset,E.nbIndices,void 0,void 0,e.GeomTypeEnum[E.geomType]))._geomType=E.geomType?e.GeomTypeEnum[E.geomType]:0,I.nonIndexed=!0,n.drawingGroups.push(I);T=new i.SGPrimitive({cgmId:E.identifier,rep:n.rep,group:I,start:E.vertexComponents[0].offset,count:E.nbIndices});I._primitives.push(T),n.rep._primitives.push(T)}var R=new e.Color,L=new e.Color,O=new e.Color;t.fillAttr.color&&R.setRGB(t.fillAttr.color.r,t.fillAttr.color.g,t.fillAttr.color.b),t.lineAttr.color&&L.setRGB(t.lineAttr.color.r,t.lineAttr.color.g,t.lineAttr.color.b),n.gas.fill={color:R,opacity:null==t.fillAttr.color.a?1:t.fillAttr.color.a,solid:t.fillAttr.solid},n.gas.line={color:L,opacity:null==t.lineAttr.color.a?1:t.lineAttr.color.a,lineWidth:t.lineAttr.thickness,pattern:t.lineAttr.pattern||1},t.pointAttr&&(t.pointAttr.color&&O.setRGB(t.pointAttr.color.r,t.pointAttr.color.g,t.pointAttr.color.b),n.gas.point={color:O,opacity:null==t.pointAttr.color.a?1:t.pointAttr.color.a,pointsize:t.pointAttr.size});var N=[0,0,0],F=[0,0,0];if(n.vertexPositionArray){const e=n.vertexPositionArray;var V=e.length;if(V>=3){N=[e[0],e[1],e[2]],F=[e[0],e[1],e[2]];for(var U=0;U<V;U+=3)e[U]<N[0]&&(N[0]=e[U]),e[U+1]<N[1]&&(N[1]=e[U+1]),e[U+2]<N[2]&&(N[2]=e[U+2]),e[U]>F[0]&&(F[0]=e[U]),e[U+1]>F[1]&&(F[1]=e[U+1]),e[U+2]>F[2]&&(F[2]=e[U+2])}}return n.AABB={min:N,max:F},n},i.convertToGeometry3js=function(t,r,n,a,s,o,l){var c=a,h=[],u=0,p=0,f=t.nbPrimitives,m=i.isEqualGAS;o&&(m=function(e,t){return e.set==t.set&&e.rgba==t.rgba});for(var g=0;g<f;g++){var v=t.primitives[g],S=0,_=h.length;for(S=0;S<_;S++){var y=h[S];if(y.connectivity==v.connectivity&&y.geomType==v.geomType&&m(y.gas,v.attr)&&(null==y.material&&null==v.material||y.material.id==v.material.id&&y.material.file==v.material.file)){switch(u+=v.nbIndices,y.connectivity){case i.ConnectivityTypeEnum.TRIANGLE_STRIP:case i.ConnectivityTypeEnum.TRIANGLE_FAN:p+=2*(v.nbIndices-3),y.more_indices+=2*(v.nbIndices-3);break;case i.ConnectivityTypeEnum.LINE_STRIP:p+=v.nbIndices-2,y.more_indices+=v.nbIndices-2}y.set.push(v),y.nbIndices+=v.nbIndices;break}}if(S==h.length)switch((M={}).connectivity=v.connectivity,M.geomType=v.geomType,M.gas=v.attr,M.material=v.material,M.nbIndices=v.nbIndices,M.more_indices=0,M.set=[],M.set.push(v),h.push(M),u+=v.nbIndices,h[S].connectivity){case i.ConnectivityTypeEnum.TRIANGLE_STRIP:case i.ConnectivityTypeEnum.TRIANGLE_FAN:p+=2*(v.nbIndices-3),M.more_indices=2*(v.nbIndices-3);break;case i.ConnectivityTypeEnum.LINE_STRIP:p+=v.nbIndices-2,M.more_indices=v.nbIndices-2}}h.sort(function(e,t){if(e.connectivity<t.connectivity)return-1;if(e.connectivity>t.connectivity)return 1;if(e.geomType&&t.geomType){var i=d[e.geomType],r=d[t.geomType];if(i&&r)return i-r}return 0});var x=[];for(S=0;S<h.length;S++){var M=h[S];for(g=0;g<M.set.length;g++)x.push(M.set[g])}var P=null;P=null==s||"multi"==s?void 0!==r?i.deMultiIndex(x,t.buffers,r,n):i.deMultiIndex(x,t.buffers):void 0!==r?i.monoIndex(x,t.buffers,r,n):i.monoIndex(x,t.buffers);var C=new i.Mesh;C.vertexPositionArray=P.VB[0],C.vertexNormalArray=P.VB[1],C.vertexColorArray=P.VB[2],C.vertexUvArray=P.VB[3],C.vertexUv2Array=P.VB[4],C.vertexTangentArray=P.VB[5],C.vertexBinormalArray=P.VB[6];for(var b=new Uint32Array(u+p),D=0,w=0,E=0;E<h.length;E++){var T,A=null==(M=h[E]).material?t.material:M.material;switch(M.connectivity){case i.ConnectivityTypeEnum.TRIANGLES:(N=M.gas)&&!N.set&&(N=i.convertToMaterial3js(M.gas,2)),(T=new i.DrawingGroup(N,A,4,w,M.nbIndices,void 0,void 0,e.GeomTypeEnum[M.geomType],void 0,l))._geomType=M.geomType?e.GeomTypeEnum[M.geomType]:0,C.drawingGroups.push(T);for(g=0;g<M.set.length;g++){v=M.set[g];var I=new i.MeshPrimitive(v.identifier,T,w,v.nbIndices);v.cgmId&&(I.cgmId=v.cgmId),v.decoration&&(I.decoration=v.decoration),v.boundingSphere&&(I.boundingSphere=v.boundingSphere),T._primitives.push(I);for(S=0;S<v.nbIndices;S++)b[w++]=P.IB[D++]}break;case i.ConnectivityTypeEnum.TRIANGLE_FAN:(N=M.gas)&&!N.set&&(N=i.convertToMaterial3js(M.gas,2)),(T=new i.DrawingGroup(N,A,4,w,M.nbIndices+M.more_indices,void 0,void 0,e.GeomTypeEnum[M.geomType],void 0,l))._geomType=M.geomType?e.GeomTypeEnum[M.geomType]:0,C.drawingGroups.push(T);for(g=0;g<M.set.length;g++){v=M.set[g];var R=w,L=D;for(S=0;S<v.nbIndices-2;S++)b[w++]=P.IB[L],b[w++]=P.IB[D+1],b[w++]=P.IB[D+2],D++;D+=2;I=new i.MeshPrimitive(v.identifier,T,R,w-R);v.cgmId&&(I.cgmId=v.cgmId),v.decoration&&(I.decoration=v.decoration),v.boundingSphere&&(I.boundingSphere=v.boundingSphere),T._primitives.push(I)}break;case i.ConnectivityTypeEnum.TRIANGLE_STRIP:(N=M.gas)&&!N.set&&(N=i.convertToMaterial3js(M.gas,2)),(T=new i.DrawingGroup(N,A,4,w,M.nbIndices+M.more_indices,void 0,void 0,e.GeomTypeEnum[M.geomType],void 0,l))._geomType=M.geomType?e.GeomTypeEnum[M.geomType]:0,C.drawingGroups.push(T);for(g=0;g<M.set.length;g++){v=M.set[g],R=w;var O=0;for(S=0;S<v.nbIndices-2;S++)b[w++]=P.IB[D],b[w++]=P.IB[D+1+O],b[w++]=P.IB[D+2-O],D++,O=1-O;D+=2;I=new i.MeshPrimitive(v.identifier,T,R,w-R);v.cgmId&&(I.cgmId=v.cgmId),v.decoration&&(I.decoration=v.decoration),v.boundingSphere&&(I.boundingSphere=v.boundingSphere),T._primitives.push(I)}break;case i.ConnectivityTypeEnum.LINES:A&&(A.shading="Basic"),(N=M.gas)&&!N.set&&(N=i.convertToMaterial3js(M.gas,1)),(T=new i.DrawingGroup(N,A,1,w,M.nbIndices,void 0,void 0,e.GeomTypeEnum[M.geomType],void 0,l))._geomType=M.geomType?e.GeomTypeEnum[M.geomType]:0,C.drawingGroups.push(T);for(g=0;g<M.set.length;g++){v=M.set[g],I=new i.MeshPrimitive(v.identifier,T,w,v.nbIndices);v.cgmId&&(I.cgmId=v.cgmId),v.decoration&&(I.decoration=v.decoration),v.boundingSphere&&(I.boundingSphere=v.boundingSphere),T._primitives.push(I);for(S=0;S<v.nbIndices;S++)b[w++]=P.IB[D++]}break;case i.ConnectivityTypeEnum.LINE_STRIP:A&&(A.shading="Basic"),(N=M.gas)&&!N.set&&(N=i.convertToMaterial3js(M.gas,1)),(T=new i.DrawingGroup(N,A,1,w,M.nbIndices+M.more_indices,void 0,void 0,e.GeomTypeEnum[M.geomType],void 0,l))._geomType=M.geomType?e.GeomTypeEnum[M.geomType]:0,C.drawingGroups.push(T);for(g=0;g<M.set.length;g++){for(v=M.set[g],R=w,S=0;S<v.nbIndices-1;S++)b[w++]=P.IB[D++],b[w++]=P.IB[D];D++;I=new i.MeshPrimitive(v.identifier,T,R,w-R);v.cgmId&&(I.cgmId=v.cgmId),v.decoration&&(I.decoration=v.decoration),v.boundingSphere&&(I.boundingSphere=v.boundingSphere),T._primitives.push(I)}break;case i.ConnectivityTypeEnum.POINTS:var N;(N=M.gas)&&!N.set&&(N=i.convertToMaterial3js(M.gas,0)),(T=new i.DrawingGroup(N,A,0,w,M.nbIndices,void 0,void 0,e.GeomTypeEnum[M.geomType],void 0,l))._geomType=M.geomType?e.GeomTypeEnum[M.geomType]:0,C.drawingGroups.push(T);for(g=0;g<M.set.length;g++){v=M.set[g],I=new i.MeshPrimitive(v.identifier,T,w,v.nbIndices);v.cgmId&&(I.cgmId=v.cgmId),v.decoration&&(I.decoration=v.decoration),v.boundingSphere&&(I.boundingSphere=v.boundingSphere),T._primitives.push(I);for(S=0;S<v.nbIndices;S++)b[w++]=P.IB[D++]}}}C.vertexIndexArray=b;var F=new e.Color,V=new e.Color,U=new e.Color;if(t.fillAttr.color&&F.setRGB(t.fillAttr.color.r,t.fillAttr.color.g,t.fillAttr.color.b),t.lineAttr.color&&V.setRGB(t.lineAttr.color.r,t.lineAttr.color.g,t.lineAttr.color.b),C.gas.fill={color:F,opacity:null==t.fillAttr.color.a?1:t.fillAttr.color.a,solid:t.fillAttr.solid},C.gas.line={color:V,opacity:null==t.lineAttr.color.a?1:t.lineAttr.color.a,lineWidth:t.lineAttr.thickness,pattern:t.lineAttr.pattern||1},t.pointAttr&&(t.pointAttr.color&&U.setRGB(t.pointAttr.color.r,t.pointAttr.color.g,t.pointAttr.color.b),C.gas.point={color:U,opacity:null==t.pointAttr.color.a?1:t.pointAttr.color.a,pointsize:t.pointAttr.size}),!c){var B=[0,0,0],k=[0,0,0];if(C.vertexPositionArray){const e=C.vertexPositionArray;var G=e.length;if(G>=3){B=[e[0],e[1],e[2]],k=[e[0],e[1],e[2]];for(var z=0;z<G;z+=3)e[z]<B[0]&&(B[0]=e[z]),e[z+1]<B[1]&&(B[1]=e[z+1]),e[z+2]<B[2]&&(B[2]=e[z+2]),e[z]>k[0]&&(k[0]=e[z]),e[z+1]>k[1]&&(k[1]=e[z+1]),e[z+2]>k[2]&&(k[2]=e[z+2])}}C.AABB={min:B,max:k}}return C},i.monoIndex=function(t,r,n,a){for(var s=0,o=0;o<t.length;o++)s+=t[o].nbIndices;var l=[];for(o=0;o<i.NumberOfComponents;o++)l[o]=[];var c=0;for(o=0;o<r.length;o++){if(null!=(v=r[o])&&(!(v.component>=i.NumberOfComponents)&&!v.indexBuffer&&v.data.length&&(void 0===v._isPlanar||!v._isPlanar))){var h=0;if(f=l[v.component].length){var u=l[v.component][f-1];h=u.offset+u.buffer.data.length/3}l[v.component].push({buffer:v,offset:h}),v._newOffset=h,h+v.data.length/3>c&&(c=h+v.data.length/3)}}for(o=0;o<r.length;o++){if(null!=(v=r[o])&&(!(v.component>=i.NumberOfComponents)&&!v.indexBuffer&&v.data.length&&null!=v._isPlanar&&v._isPlanar)){h=c;l[v.component].push({buffer:v,offset:h}),v._newOffset=h}}var d=new Uint32Array(s),p=[];for(o=0;o<i.NumberOfComponents;o++){var f;if(f=l[o].length){var m=l[o][f-1];p[o]=new Float32Array(3*m.offset+m.buffer.data.length);h=0;for(var g=0;g<f;g++){var v,S=(v=l[o][g]).buffer.data.length,_=v.buffer.data;if(h<3*v.offset){for(var y=h;y<3*v.offset;y++)p[o][y]=0;h=3*v.offset}if(null==n)p[o].set(_,h);else for(y=0;y<S;y+=3){var x=new e.Vector3(_[y],_[y+1],_[y+2]);1==o?x.applyMatrix4(a):0==o&&x.applyMatrix4(n),p[o][h+y]=x.x,p[o][h+y+1]=x.y,p[o][h+y+2]=x.z}h+=S}}else p[o]=null}var M=0;for(o=0;o<t.length;o++){var P=t[o],C=P.vertexComponents[0],b=r[C.bufferId];if(null!=b){var D=b._newOffset;if(null!=C.indices){var w=r[C.indices.bufferId];for(y=0;y<P.nbIndices;y++)d[M+y]=w.data[C.indices.offset+y]+C.offset+D}else for(y=0;y<P.nbIndices;y++)d[M+y]=D+C.offset+y;M+=P.nbIndices}}return{IB:d,VB:p}},i.deMultiIndex=function(t,r,n,a){null!=n&&null!=a||(n=null),void 0!==a&&a instanceof e.Matrix4&&((a=(new e.Matrix4).copy(a)).elements[12]=0,a.elements[13]=0,a.elements[14]=0);for(var s=0,o=0;o<t.length;o++)s+=t[o].nbIndices;var l=[],c=[],h=0;for(o=0;o<i.NumberOfComponents;o++)l[o]=null;for(o=0;o<t.length;o++){for(var u=t[o],d=0;d<u.nbVertexComponents;d++){var p=u.vertexComponents[d];if(null==l[p.component]){l[p.component]=[],c[p.component]=p.bufferId;for(var f=0;f<s;f++)l[p.component][f]=null}r[p.bufferId];var m=null;if(null!=p.indices&&(m=r[p.indices.bufferId]),null!=m)for(f=0;f<u.nbIndices;f++)l[p.component][h+f]={bufferId:p.bufferId,index:p.offset+m.data[p.indices.offset+f]};else for(f=0;f<u.nbIndices;f++)l[p.component][h+f]={bufferId:p.bufferId,index:p.offset+f}}h+=u.nbIndices}var g=[];for(d=0;d<s;d++){(M=new i.MultiIndexMultiBuffer).old_index=d;for(o=0;o<i.NumberOfComponents;o++)null!==l[o]&&(M.comp[o]=l[o][d]);g.push(M)}g.sort(function(e,t){for(var r=0,n=0,a=0;a<i.NumberOfComponents;a++)if(null!=e.comp[a]&&null!=t.comp[a]){if(e.comp[a].index<t.comp[a].index)return-1;if(e.comp[a].index>t.comp[a].index)return 1;if(e.comp[a].bufferId<t.comp[a].bufferId)return-1;if(e.comp[a].bufferId>t.comp[a].bufferId)return 1}else null==e.comp[a]&&r++,null==t.comp[a]&&n++;return r<n?-1:r>n?1:0});var v=new Uint32Array(s),S=[];for(o=0;o<i.NumberOfComponents;o++)if(null!==l[o]){var _=r[c[o]].dimension;S[o]=new Float32Array(_*s)}else S[o]=null;var y=-1,x=null;for(o=0;o<g.length;o++){var M,P=(M=g[o]).old_index;if(!o||!M.componentsEqual(x)){y++,x=M;for(d=0;d<i.NumberOfComponents;d++)if(null!=M.comp[d]){var C=r[M.comp[d].bufferId].data,b=r[M.comp[d].bufferId].dimension;if(null==n)for(f=0;f<b;f++)S[d][b*y+f]=C[b*l[d][M.old_index].index+f];else{var D=new e.Vector3(C[3*l[d][M.old_index].index],C[3*l[d][M.old_index].index+1],C[3*l[d][M.old_index].index+2]);1==d?(D.applyMatrix4(a),S[d][3*y]=D.x,S[d][3*y+1]=D.y,S[d][3*y+2]=D.z):0==d?(D.applyMatrix4(n),S[d][3*y]=D.x,S[d][3*y+1]=D.y,S[d][3*y+2]=D.z):(S[d][3*y]=D.x,S[d][3*y+1]=D.y,S[d][3*y+2]=D.z)}}}v[P]=y}var w=[];for(o=0;o<i.NumberOfComponents;o++){var E=S[o];if(null!==E){var T=r[c[o]].dimension*(y+1),A=new Float32Array(T);for(d=0;d<T;d++)A[d]=E[d];w[o]=A}else w[o]=null}return{IB:v,VB:w}},i.MeshContextEnum={UNKNOWN:0,DATA:1,FLOATBUFFER:2,INDEXBUFFER:3,COMPRESSEDBUFFER:4,PRIMITIVE:5,VERTEXCOMPONENT:6,GRAPHICPROPERTIES:7,APPEARANCE:8,BAG:9,MESH:10,TEXT:11},i.NumberOfComponents=7,i.MultiIndex=function(){this.old_index=0,this.comp=[],this.comp[0]=-1,this.comp[1]=-1,this.comp[2]=-1,this.comp[3]=-1,this.comp[4]=-1,this.comp[5]=-1,this.comp[6]=-1},i.MultiIndex.prototype={constructor:i.MultiIndex,componentsEqual:function(e){for(var t=0;t<i.NumberOfComponents;t++)if(-1!=this.comp[t]&&-1!=e.comp[t]&&this.comp[t]!=e.comp[t])return!1;return!0}},i.MultiIndexMultiBuffer=function(){this.old_index=0,this.comp=[];for(var e=0;e<i.NumberOfComponents;e++)this.comp[e]=null},i.MultiIndexMultiBuffer.prototype={constructor:i.MultiIndexMultiBuffer,componentsEqual:function(e){for(var t=0;t<i.NumberOfComponents;t++)if(null!=this.comp[t]&&null!=e.comp[t]){if(this.comp[t].bufferId!=e.comp[t].bufferId)return!1;if(this.comp[t].index!=e.comp[t].index)return!1}return!0}},i.Node=function(e,t,i,r,n,a,s){this.id=void 0!==e?e:"",this.type=void 0!==t?t:"Bag",this.childNodes=void 0!==i?i:[],this.matrix=void 0!==r?r:null,this.position=void 0!==n?n:{},this.rotation=void 0!==a?a:{},this.scale=void 0!==s?s:{}},i.Node.prototype={constructor:i.Node,add:function(e){null!=e&&this.childNodes.push(e)},childClone:function(){var e=new Array;for(var t in this.childNodes)e[t]="object"==typeof this.childNodes[t]?this.childNodes[t].clone():this.childNodes[t];return e},matrixClone:function(){if(this.matrix){var t=new e.Matrix4;return t.copy(this.matrix),t}},clone:function(){return new i.Node(this.id,this.type,this.childClone(),this.matrixClone(),this.position,this.rotation,this.scale)}},i.Mesh=function(e,t,r,n,a,s,o,l,c,h,u,d){this.id=void 0!==e?e:"",this.type=void 0!==t?t:"Mesh",this.vertexPositionArray=void 0!==r?r:null,this.vertexNormalArray=void 0!==n?n:null,this.vertexIndexArray=void 0!==a?a:null,this.vertexUvArray=void 0!==s?s:null,this.drawingGroups=void 0!==o?o:[],this.gas=void 0!==l?l:{fill:{},line:{}},this.AABB=void 0!==c?c:{},this._radius=0,this.material=void 0!==h?h:null,this.matrix=void 0!==d?d:null,this.rep=void 0!==u?new i.SGRep({cgmId:u.cgmId}):new i.SGRep},i.Mesh.prototype={constructor:i.Mesh,setMatrix:function(e){this.matrix=e},indexCopy:function(){if(this.vertexIndexArray instanceof Uint32Array)return new Uint32Array(this.vertexIndexArray)},tabCopy:function(e){if(e instanceof Float32Array)return new Float32Array(e)},gasCopy:function(){var e;return this.gas&&(e={fill:this.gas.fill,line:this.gas.line}),e},AABBCopy:function(){return this.AABB.min&&this.AABB.max?{min:[this.AABB.min[0],this.AABB.min[1],this.AABB.min[2]],max:[this.AABB.max[0],this.AABB.max[1],this.AABB.max[2]]}:{}},dGCopy:function(){var e=new Array;for(var t in this.drawingGroups)e[t]="object"==typeof this.drawingGroups[t]?this.drawingGroups[t].clone():this.drawingGroups[t];return e},clone:function(){var e=new i.Mesh(this.id,this.type,this.tabCopy(this.vertexPositionArray),this.tabCopy(this.vertexNormalArray),this.indexCopy(),this.tabCopy(this.vertexUvArray),this.dGCopy(),this.gasCopy(),this.AABBCopy(),this.material,this.rep);return this.vertexBinormalArray&&(e.vertexBinormalArray=this.tabCopy(this.vertexBinormalArray)),this.vertexTangentArray&&(e.vertexTangentArray=this.tabCopy(this.vertexTangentArray)),e}},i.MeshPrimitive=function(e,t,i,r,n){this.cgmId=e||0,this.groupIndex=t||0,this.start=i||0,this.count=r||0,this.boundingSphere=void 0,this.rep=0,this.decoration=n||0},i.MeshPrimitive.prototype={constructor:i.MeshPrimitive,clone:function(){if(this.boundingSphere){var e=new i.MeshPrimitive(this.cgmId,this.groupIndex,this.start,this.count,this.decoration);return e.boundingSphere={center:this.boundingSphere.center,radius:this.boundingSphere.radius},e}return this}},i.DrawingGroup=function(e,t,r,n,a,s,o,l,c,h){this.gas=e||null,this.material=t||null,this.glType=r,this._geomType=l||0,this.gasIndex=c,this.start=n||0,this.count=a||0,this._primitives=void 0!==s?s:[],this.geometry=null,this.vbStart=-1,this._noZPriority=void 0!==h?h:-1,this.ib=null,this.nonIndexed=!1,this.cullingData=null,this._nonBinary=!(this._primitives instanceof i.BinarySGPrimitiveArray),this._dimension=-1,this._instancingInfos=null,this._dependentDGs=null,this._updateLineWithShapes=null},i.DrawingGroup.prototype={constructor:i.DrawingGroup,clone:function(){var e=new i.DrawingGroup(this.gas,this.material,this.glType,this.start,this.count,void 0,void 0,this._geomType,this.gasIndex,this._noZPriority);if(e.copyPrimitives(this._primitives),e.geometry=this.geometry,e._dimension=this._dimension,e._instancingInfos=this._instancingInfos,e._instancingInfos){const t=e._instancingInfos.instanceAttribArrays;for(let e in t)"id"!==e&&(t[e].buffer=null)}return e._updateLineWithShapes=this._updateLineWithShapes,e},setInstancingParameters:function(i,r,n){let a={};if(null!==this._instancingInfos){let e=this._instancingInfos.instanceAttribArrays;for(let t in e)"id"!==t&&null!==e[t].buffer&&void 0!==e[t].buffer&&(a[t]=e[t].buffer)}t--,this._instancingInfos={nbInstances:i,instancingSelectionMode:n||"instance",instanceAttribArrays:{id:t},pickedInstanceId:-1,staleGLBuffers:[]};let s=this._instancingInfos.instanceAttribArrays,o=new Float32Array(i);for(var l=0;l<i;l++)o[l]=5+5*l;s.instanceId={},s.instanceId.array=o,s.instanceId.buffer=null,s.instanceId.itemSize=1,this.material.isInstancingMaterial=!0,this.material.attributes={instanceId:{type:"f"}};for(let e=0;e<r.length;e++){const t=r[e];switch(this.material.attributes[t.attribName]={type:t.type},s[t.attribName]={isMat4:!1,itemSize:0,array:t.isFlattened?new Float32Array(t.data):null,buffer:null},t.type){case"f":s[t.attribName].itemSize=1;break;case"v2":s[t.attribName].itemSize=2;break;case"v3":s[t.attribName].itemSize=3;break;case"v4":s[t.attribName].itemSize=4;break;case"m4":s[t.attribName].itemSize=4,s[t.attribName].isMat4=!0}if(!t.isFlattened)switch(t.type){case"v2":s[t.attribName].array=new Float32Array(2*i);for(var c=0;c<i;c++)s[t.attribName].array[2*c+0]=t.data[c].x,s[t.attribName].array[2*c+1]=t.data[c].y;break;case"v3":s[t.attribName].array=new Float32Array(3*i);for(c=0;c<i;c++)s[t.attribName].array[3*c+0]=t.data[c].x,s[t.attribName].array[3*c+1]=t.data[c].y,s[t.attribName].array[3*c+2]=t.data[c].z;break;case"v4":s[t.attribName].array=new Float32Array(4*i);for(c=0;c<i;c++)s[t.attribName].array[4*c+0]=t.data[c].x,s[t.attribName].array[4*c+1]=t.data[c].y,s[t.attribName].array[4*c+2]=t.data[c].z,s[t.attribName].array[4*c+3]=t.data[c].w;break;case"m4":s[t.attribName].array=new Float32Array(16*t.data.length);for(var h=0;h<t.data.length;h++){var u=new Float32Array(16);u=t.data[h].elements;for(l=0;l<16;l++)s[t.attribName].array[16*h+l]=u[l]}}}for(let e in a)void 0!==s[e]?(s[e].buffer=a[e],s[e].isDynamic=!0):this._instancingInfos.staleGLBuffers.push(a[e]);if(this.material._PDSFXData&&this.material._PDSFXData.PDSFX){let t="";for(let i=0;i<r.length;i++)t+="attribute "+e.ToGLSLTypes[r[i].type].t+" "+r[i].attribName+";\n";this.material._PDSFXData.pdsfxAttributesCode=t}},_compactArrays:function(){if(this._nonBinary){var e=this._primitives;this._primitives=new Array(e.length);for(var t=0;t<e.length;t++)this._primitives[t]=e[t]}else this._primitives._compactArrays()},_getDimension:function(e,t){var i=2,r=this;if(r._geomType)i=e[r._geomType];else switch(r.glType){case 0:i=0;break;case 1:i=1;break;default:i=2}return 2===i&&(i=t&&t._bodyDim>0?3===t._bodyDim?5:2:r.gas&&0===r.gas.side?5:2),this._dimension=i,i},copyPrimitives:function(e){var t=null;if(e instanceof i.BinarySGPrimitiveArray)return this._primitives=e.clone(),void(this._nonBinary=!1);this._nonBinary=!0,this._primitives=new Array(e.length);for(var r=0;r<e.length;r++)if((t=e[r])instanceof i.SGPrimitive)this._primitives[r]=t.clone();else{var n=new i.SGPrimitive;n.cgmId=t.cgmId,n.rep=t.rep,n.group=this,n.start=t.start,n.count=t.count,this._primitives[r]=n}},_computeOrientedBoundingBox:function(t,i,r,n,a,s,o){if(!t||this.isFiltered(i,o)||n&&r===e.FixedSizeFiltering.Exclude)return null;if(n&&r===e.FixedSizeFiltering.CenterOnly)return new e.Box3(new e.Vector3(0,0,0),new e.Vector3(0,0,0)).applyMatrix4(t);var l=new e.Vector3,c=new e.Vector3,h=new e.Vector3,u=new e.Vector3,d=null!==a?a:this.start,p=null!==s?s:this.count,f=this.geometry.vertexIndexArray;if(this.geometry.getVertexCount()){var m=f[d];this.geometry.getVertexPosition(m,u),c.set(u.x,u.y,u.z).applyMatrix4(t),h.set(u.x,u.y,u.z).applyMatrix4(t);for(var g=d+1;g<d+p;g++)m=f[g],this.geometry.getVertexPosition(m,u),l.set(u.x,u.y,u.z).applyMatrix4(t),l.x<c.x&&(c.x=l.x),l.y<c.y&&(c.y=l.y),l.z<c.z&&(c.z=l.z),l.x>h.x&&(h.x=l.x),l.y>h.y&&(h.y=l.y),l.z>h.z&&(h.z=l.z)}return new e.Box3(c,h)},_computePrimitiveOrientedBoundingBox:function(e,t,i,r,n,a){return this._nonBinary?this._primitives[e]._computeOrientedBoundingBox(t,i,r,n,a):this._primitives._computePrimitiveOrientedBoundingBox(e,t,i,r,n,a)},disabled:function(e,t,i){return console.warn("Deprecated, use isFiltered instead"),t=t||0,this.isFiltered(e&~t,i)},isFiltered:function(e,t){var i=t||this._geomType;return!(e<0||0===i)&&!((i&e)>0)},getPrimitiveCgmId:function(e){return this._nonBinary?this._primitives[e].cgmId:this._primitives.getPrimitiveCgmId(e)},_setPrimitiveCgmId:function(e,t){this._nonBinary?this._primitives[t].cgmId=e:this._primitives._setPrimitiveCgmId(e,t)},getPrimitiveType:function(e){return this._nonBinary?this._primitives[e].type:this._primitives.getPrimitiveType(e)},getPrimitiveRep:function(e){return this._nonBinary?this._primitives[e].rep:this._primitives.getPrimitiveRep(e)},_getSGPrimitive:function(e,t){return this._nonBinary?t?this._primitives[e]:this._primitives[e].clone():this._primitives._getSGPrimitive(e,t)},_getPrimitiveInternalNode:function(e){return this._nonBinary?this._primitives[e].internalNode:this._primitives._getPrimitiveInternalNode(e)},_setPrimitiveRep:function(e,t){this._nonBinary?this._primitives[t].rep=e:this._primitives._setPrimitiveRep(e,t)},_setPrimitiveInternalNode:function(e,t){this._nonBinary?this._primitives[t].internalNode=e:this._primitives._setPrimitiveInternalNode(e,t)},_setPrimitiveStart:function(e,t){this._nonBinary?this._primitives[t].start=e:this._primitives._setPrimitiveStart(e,t)},_setPrimitiveCount:function(e,t){this._nonBinary?this._primitives[t].count=e:this._primitives._setPrimitiveCount(e,t)},getPrimitiveStart:function(e){return this._nonBinary?this._primitives[e].start:this._primitives.getPrimitiveStart(e)},getPrimitiveCount:function(e){return this._nonBinary?this._primitives[e].count:this._primitives.getPrimitiveCount(e)},getPrimitiveGroup:function(e){return this._nonBinary?this._primitives[e].group:this._primitives.getPrimitiveGroup(e)},getPrimitiveDecoration:function(e){return this._nonBinary?this._primitives[e].decoration:this._primitives.getPrimitiveDecoration(e)},getPrimitiveBoundingSphere:function(e){return this._nonBinary?this._primitives[e].boundingSphere:this._primitives.getPrimitiveBoundingSphere(e)},setPrimitiveBoundingSphere:function(e,t){this._nonBinary?this._primitives[e].boundingSphere=t:this._primitives.setPrimitiveBoundingSphere(e,t)},getPrimitivesCount:function(){return this._nonBinary?this._primitives.length:this._primitives.getPrimitivesCount()},getPrimitiveIdentificationObject:function(e){return this._nonBinary?this._primitives[e].IdentObj:this._primitives.getPrimitiveIdentificationObject(e)},setPrimitiveIdentificationObject:function(e,t){this._nonBinary?this._primitives[t].IdentObj=e:this._primitives.setPrimitiveIdentificationObject(e,t)},computePrimitiveBoundingSphere:function(e,t){return this._nonBinary?this._primitives[e].computeBoundingSphere(t):this._primitives.computePrimitiveBoundingSphere(e,t)},startIteration:function(){return!0},endIteration:function(){return!0}},Object.defineProperty(i.DrawingGroup.prototype,"geomType",{get:function(){return console.warn("[Mesh.DrawingGroup] DOT NOT ACCESS geomType directly !\n"),i.GeomTypeString[this._geomType]},set:function(t){console.warn("[Mesh.DrawingGroup] DOT NOT ACCESS geomType directly !\n"),this._geomType=e.GeomTypeEnum[t]}});var p=0;Object.defineProperty(i.DrawingGroup.prototype,"primitives",{get:function(){if(p<10){var e=new Error,t="#PrimApi - DG.GetPrimitives - "+(e.stack?e.stack.split("\n")[1]+" - "+e.stack.split("\n")[2]:"");r.has(t.hashCode())||(r.add(t.hashCode()),console.error(t)),p++}return this._primitives},set:function(){throw"NO"}}),i.SelectionGroup=function(){this.geometries={}},i.SelectionGroup.prototype={constructor:i.SelectionGroup,contains:function(e){for(var t in this.geometries)for(var i=this.geometries[t],r=0;r<i.length;r++)for(var n=i[r].primitives,a=0;a<n.length;a++)if(n[a].isEqual(e))return!0;return!1},getFirstPrimitive:function(){for(var e in this.geometries){var t=this.geometries[e];if(t.length&&t[0].primitives.length)return t[0].primitives[0]}return null},getPrimitives:function(){var e=[];for(var t in this.geometries)for(var i=this.geometries[t],r=0;r<i.length;r++)for(var n=i[r].primitives,a=0;a<n.length;a++)e.push(n[a]);return e},addPrimitive:function(e){var t=0,i=e.getGroup(),r=i.geometry.id,n=this.geometries[r];for(n||(n=[],this.geometries[r]=n),t=0;t<n.length;t++)if(n[t].drawingGroup===i){n[t].primitives.push(e);break}t===n.length&&n.push({drawingGroup:i,primitives:[e]})},clone:function(){var e=new i.SelectionGroup;for(var t in this.geometries){var r=this.geometries[t];e.geometries[t]=[];for(var n=0;n<r.length;n++)e.geometries[t][n]={drawingGroup:r[n].drawingGroup,primitives:r[n].primitives.slice()}}return e},getIdentificationObject:function(){var e,t=this.getFirstPrimitive();return t&&t.getIdentificationObject&&(e=t.getIdentificationObject()),e},computeBoundingSphere:function(){for(var t=null,i=new e.Sphere,r=this.getPrimitives(),n=0;n<r.length;n++){r[n].computeBoundingSphere(i),t?i.mergeWithSphere(t,t):t=i.clone()}return t},_computeOrientedBoundingBox:function(t,i,r,n,a){for(var s,o=new e.Box3,l=this.getPrimitives(),c=0;c<l.length;c++){(s=l[c]._computeOrientedBoundingBox(t,i,r,n,a))&&(o=o.union(s))}return o}},i.processRepsCGR=function(t,r,n,a,s,o){var l=0,c=0,h=!r,u=[];o&&(u=o);for(var d=a||{},p=!1,f=!1,m=!1,g=!1,v=!1,S=!1,_=0;_<t.length;_++)l+=t[_].vertexPositionArray?t[_].vertexPositionArray.length:0,c+=t[_].vertexIndexArray.length,p||null===t[_].vertexNormalArray||(p=!0),f||null===t[_].vertexUvArray||(f=!0),!m&&t[_].vertexUv2Array&&(m=!0),!g&&t[_].vertexTangentArray&&(g=!0),!v&&t[_].vertexBinormalArray&&(v=!0),!S&&t[_].vertexColorArray&&(S=!0);var y,x=new Float32Array(l);y=l/3<65535?new Uint16Array(c):new Uint32Array(c);var M=p?new Float32Array(l):null,P=f?new Float32Array(l):null,C=m?new Float32Array(l):null,b=g?new Float32Array(l):null,D=v?new Float32Array(l):null,w=S?new Float32Array(4*l/3):null,E=0;for(_=0;_<t.length;_++){var T=t[_],A=T.vertexPositionArray;A&&(x.set(A,E),null!==M&&T.vertexNormalArray&&M.set(T.vertexNormalArray,E),null!==P&&T.vertexUvArray&&P.set(T.vertexUvArray,E),null!==C&&T.vertexUv2Array&&C.set(T.vertexUv2Array,E),null!==b&&T.vertexTangentArray&&b.set(T.vertexTangentArray,E),null!==D&&T.vertexBinormalArray&&D.set(T.vertexBinormalArray,E),null!==w&&T.vertexColorArray&&w.set(T.vertexColorArray,E));for(var I=0;I<T.drawingGroups.length;I++){(ae=T.drawingGroups[I]).vbStart=E/3,ae.ib=T.vertexIndexArray,ae.geometry=t[_],null==ae.gas&&(4==ae.glType||5==ae.glType?ae.gas=t[_].gas.fill:1==ae.glType?ae.gas=t[_].gas.line:0==ae.glType&&(ae.gas=t[_].gas.point));for(var R=0;R<ae._primitives.length;R++){if((ne=ae._primitives[R]).rep=T.rep,ne.boundingSphere){var L=new e.Vector3(ne.boundingSphere.center[0],ne.boundingSphere.center[1],ne.boundingSphere.center[2]);!!T.globalMatrix&&!T.globalMatrix.isIdentity()&&(L.applyMatrix4(t[_].globalMatrix),ne.boundingSphere.center=[L.x,L.y,L.z],ne.boundingSphere.radius*=t[_].globalMatrix.getMaxScaleOnAxis())}}a.withSceneGraphOrder||u.push(ae)}E+=A?A.length:0}a.withSceneGraphOrder||u.sort(function(e,t){if(e.glType<t.glType)return-1;if(e.glType>t.glType)return 1;if(null==e.material&&null!=t.material)return-1;if(null!=e.material&&null==t.material)return 1;if(null!=e.material&&null!=t.material){if(e.material.id<t.material.id)return-1;if(e.material.id>t.material.id)return 1;if(e.material.file<t.material.file)return-1;if(e.material.file>t.material.file)return 1}if(null==e.gas&&null!=t.gas)return-1;if(null!=e.gas&&null==t.gas)return-1;if(null!=e.gas&&null!=t.gas){if(e.gas.set<t.gas.set)return 1;if(t.gas.set<e.gas.set)return-1;if(e.gas.rgba<t.gas.rgba)return 1;if(t.gas.rgba<e.gas.rgba)return-1}if(e._geomType&&t._geomType){if(e._geomType<t._geomType)return-1;if(e._geomType>t._geomType)return 1;if(n){if(e.geometry._radius<t.geometry._radius)return 1;if(e.geometry._radius>t.geometry._radius)return-1}}if(n){if(e.geometry._radius<t.geometry._radius)return 1;if(e.geometry._radius>t.geometry._radius)return-1}return 0});var O=[],N=u.length>0?u[0].gas:null,F=u.length>0?u[0].material:null,V=u.length>0?u[0].glType:0,U=u.length>0?u[0]._geomType:0,B=0,k=0,G=0,z=0,H=N,W=[],j=[],X=d.withBoundingElement;for(_=0;_<u.length;_++){if((ae=u[_]).glType==V&&ae._geomType===U&&N.isEqual(ae.gas)&&(null==F&&null==ae.material||null!=F&&null!=ae.material&&F.id==ae.material.id&&F.file==ae.material.file)){n&&W.push({start:B,count:ae.count,radius:ae.geometry._radius,rep:ae.geometry.rep}),G+=ae.count,j.push(ae);for(I=0;I<ae.count;I++)y[B++]=ae.vbStart+ae.ib[ae.start+I]}else{var q=null;if(G>0){q=new i.DrawingGroup(N,u[_-1].material,V,k,G,void 0,void 0,U,z),n&&(q.cullingData=W);for(var Z=0,Y=0;Y<j.length;++Y)Z+=j[Y]._primitives.length;var K=new Uint32Array(5*Z),J=null;X&&q.glType>0&&(J=new Float32Array(4*Z));for(var Q=0,$=k,ee=[],te=0;te<j.length;++te){var ie=j[te],re=5*Q;if(ie.geometry.noShow&&d.containNoShow)for(Y=0;Y<ie._primitives.length;Y++){var ne=ie._primitives[Y];if(ee.push(Q),K[re++]=ne.cgmId+1,K[re++]=ne.rep,K[re++]=$,K[re++]=ne.count,K[re++]=ne.decoration,J&&ne.boundingSphere)J[se=4*Q]=ne.boundingSphere.center[0],J[se+1]=ne.boundingSphere.center[1],J[se+2]=ne.boundingSphere.center[2],J[se+3]=ne.boundingSphere.radius;Q++,$+=ne.count}else for(Y=0;Y<ie._primitives.length;Y++){ne=ie._primitives[Y];if(K[re++]=ne.cgmId+1,K[re++]=ne.rep,K[re++]=$,K[re++]=ne.count,K[re++]=ne.decoration,J&&ne.boundingSphere)J[se=4*Q]=ne.boundingSphere.center[0],J[se+1]=ne.boundingSphere.center[1],J[se+2]=ne.boundingSphere.center[2],J[se+3]=ne.boundingSphere.radius;Q++,$+=ne.count}}q._primitives=J?{prims:K,bs:J}:K,ee.length&&(q.noShowPrim=ee),O.push(q)}j=[],W=[],H.isEqual(ae.gas)||(H=ae.gas,z++),V=ae.glType,U=ae._geomType,N=ae.gas,F=ae.material,k=B,G=ae.count,j.push(ae),n&&W.push({start:B,count:ae.count,radius:ae.geometry._radius,rep:ae.geometry.rep});for(I=0;I<ae.count;I++)y[B++]=ae.vbStart+ae.ib[ae.start+I]}}if(G>0){q=new i.DrawingGroup(N,u[u.length-1].material,V,k,G,void 0,void 0,U,z);n&&(q.cullingData=W);for(Z=0,Y=0;Y<j.length;++Y)Z+=j[Y]._primitives.length;K=new Uint32Array(5*Z),J=null;X&&q.glType>0&&(J=new Float32Array(4*Z));for($=k,Q=0,ee=[],te=0;te<j.length;++te){var ae;re=5*Q;if((ae=j[te]).geometry.noShow&&d.containNoShow)for(Y=0;Y<ae._primitives.length;Y++){ne=ae._primitives[Y];if(ee.push(Q),K[re++]=ne.cgmId+1,K[re++]=ne.rep,K[re++]=$,K[re++]=ne.count,K[re++]=ne.decoration,J&&ne.boundingSphere)J[se=4*Q]=ne.boundingSphere.center[0],J[se+1]=ne.boundingSphere.center[1],J[se+2]=ne.boundingSphere.center[2],J[se+3]=ne.boundingSphere.radius;Q++,$+=ne.count}else for(Y=0;Y<ae._primitives.length;Y++){var se;ne=ae._primitives[Y];if(K[re++]=ne.cgmId+1,K[re++]=ne.rep,K[re++]=$,K[re++]=ne.count,K[re++]=ne.decoration,J&&ne.boundingSphere)J[se=4*Q]=ne.boundingSphere.center[0],J[se+1]=ne.boundingSphere.center[1],J[se+2]=ne.boundingSphere.center[2],J[se+3]=ne.boundingSphere.radius;Q++,$+=ne.count}}q._primitives=J?{prims:K,bs:J}:K,ee.length&&(q.noShowPrim=ee),O.push(q)}var oe=new i.Mesh;if(oe.vertexPositionArray=x,oe.vertexNormalArray=M,oe.vertexUvArray=P,oe.vertexUv2Array=C,oe.vertexTangentArray=b,oe.vertexBinormalArray=D,oe.vertexIndexArray=y,oe.vertexColorArray=w,oe.drawingGroups=O,void 0===t[0]){var le=new e.Color;le.setRGB(.5,.5,.5),oe.gas.fill={color:le,opacity:1,solid:0},oe.gas.line={color:le,opacity:1,lineWidth:1},oe.gas.point={color:le,opacity:1,pointsize:1}}else oe.gas=t[0].gas;if(h){var ce=[0,0,0],he=[0,0,0];if(l>=3){ce=[x[0],x[1],x[2]],he=[x[0],x[1],x[2]];for(_=0;_<l;_+=3)x[_]<ce[0]&&(ce[0]=x[_]),x[_+1]<ce[1]&&(ce[1]=x[_+1]),x[_+2]<ce[2]&&(ce[2]=x[_+2]),x[_]>he[0]&&(he[0]=x[_]),x[_+1]>he[1]&&(he[1]=x[_+1]),x[_+2]>he[2]&&(he[2]=x[_+2])}oe.AABB={min:ce,max:he}}return oe},i.processReps=function(t,r,n){for(var a=0,s=0,o=!r,l=[],c=!1,h=!1,u=!1,d=!1,p=!1,f=0;f<t.length;f++)a+=t[f].vertexPositionArray?t[f].vertexPositionArray.length:0,s+=t[f].vertexIndexArray.length,c||null===t[f].vertexNormalArray||(c=!0),h||null===t[f].vertexUvArray||(h=!0),!u&&t[f].vertexUv2Array&&(u=!0),!d&&t[f].vertexTangentArray&&(d=!0),!p&&t[f].vertexBinormalArray&&(p=!0);var m,g=new Float32Array(a);m=a/3<65535?new Uint16Array(s):new Uint32Array(s);var v=c?new Float32Array(a):null,S=h?new Float32Array(a):null,_=u?new Float32Array(a):null,y=d?new Float32Array(a):null,x=p?new Float32Array(a):null,M=0;for(f=0;f<t.length;f++){if(t[f].vertexPositionArray)for(var P=0;P<t[f].vertexPositionArray.length;P++)g[M+P]=t[f].vertexPositionArray[P],null!==v&&(v[M+P]=null!==t[f].vertexNormalArray?t[f].vertexNormalArray[P]:0),null!==S&&(S[M+P]=null!==t[f].vertexUvArray?t[f].vertexUvArray[P]:0),null!==_&&(_[M+P]=t[f].vertexUv2Array?t[f].vertexUv2Array[P]:0),null!==y&&(y[M+P]=t[f].vertexTangentArray?t[f].vertexTangentArray[P]:0),null!==x&&(x[M+P]=t[f].vertexBinormalArray?t[f].vertexBinormalArray[P]:0);for(P=0;P<t[f].drawingGroups.length;P++){(U=t[f].drawingGroups[P]).vbStart=M/3,U.ib=t[f].vertexIndexArray,U.geometry=t[f],null==U.gas&&(4==U.glType||5==U.glType?U.gas=t[f].gas.fill:1==U.glType?U.gas=t[f].gas.line:0==U.glType&&(U.gas=t[f].gas.point));for(var C=0;C<U._primitives.length;C++){if((G=U._primitives[C]).rep=t[f].rep,G.boundingSphere){var b=new e.Vector3(G.boundingSphere.center[0],G.boundingSphere.center[1],G.boundingSphere.center[2]);!!t[f].globalMatrix&&!t[f].globalMatrix.isIdentity()&&(b.applyMatrix4(t[f].globalMatrix),G.boundingSphere.center=[b.x,b.y,b.z],G.boundingSphere.radius*=t[f].globalMatrix.getMaxScaleOnAxis())}}l.push(U)}M+=t[f].vertexPositionArray?t[f].vertexPositionArray.length:0}l.sort(function(e,t){if(e.glType<t.glType)return-1;if(e.glType>t.glType)return 1;if(null==e.material&&null!=t.material)return-1;if(null!=e.material&&null==t.material)return 1;if(null!=e.material&&null!=t.material){if(e.material.id<t.material.id)return-1;if(e.material.id>t.material.id)return 1;if(e.material.file<t.material.file)return-1;if(e.material.file>t.material.file)return 1}if(null==e.gas&&null!=t.gas)return-1;if(null!=e.gas&&null==t.gas)return-1;if(null!=e.gas&&null!=t.gas){var r=i.compareGASMaterial(e.gas,t.gas);if(r)return r}if(e._geomType&&t._geomType){if(e._geomType<t._geomType)return-1;if(e._geomType>t._geomType)return 1;if(e.geometry._radius<t.geometry._radius)return 1;if(e.geometry._radius>t.geometry._radius)return-1}return e.geometry._radius<t.geometry._radius?1:e.geometry._radius>t.geometry._radius?-1:0});var D=[],w=[],E=l.length>0?l[0].gas:null,T=l.length>0?l[0].material:null,A=l.length>0?l[0].glType:0,I=l.length>0?l[0]._geomType:0,R=0,L=0,O=0,N=0,F=E,V=[];for(f=0;f<l.length;f++){var U;if((U=l[f]).glType==A&&U._geomType===I&&!i.compareGASMaterial(E,U.gas)&&(null==T&&null==U.material||null!=T&&null!=U.material&&T.id==U.material.id&&T.file==U.material.file)){n&&V.push({start:R,count:U.count,radius:U.geometry._radius,rep:U.geometry.rep}),O+=U.count;for(var B=R,k=0;k<U._primitives.length;k++){var G=U._primitives[k],z=new i.SGPrimitive({cgmId:G.cgmId,rep:G.rep,start:B,count:G.count});G.decoration&&(z.decoration=G.decoration),G.boundingSphere&&(z.boundingSphere=G.boundingSphere),w.push(z),G.rep._primitives.push(z),B+=G.count}for(P=0;P<U.count;P++)m[R++]=U.vbStart+U.ib[U.start+P]}else{var H=null;if(O>0){(H=new i.DrawingGroup(E,T,A,L,O,void 0,void 0,I,N))._primitives=w,n&&(H.cullingData=V);for(var W=0;W<w.length;W++)w[W].group=H;D.push(H)}w=[],V=[],0!==i.compareGASMaterial(F,U.gas)&&(F=U.gas,N++),A=U.glType,I=U._geomType,E=U.gas,T=U.material,L=R,O=U.count,n&&V.push({start:R,count:U.count,radius:U.geometry._radius,rep:U.geometry.rep});for(B=R,k=0;k<U._primitives.length;k++){G=U._primitives[k],z=new i.SGPrimitive({cgmId:G.cgmId,rep:G.rep,start:B,count:G.count});G.decoration&&(z.decoration=G.decoration),G.boundingSphere&&(z.boundingSphere=G.boundingSphere),w.push(z),G.rep._primitives.push(z),B+=G.count}for(P=0;P<U.count;P++)m[R++]=U.vbStart+U.ib[U.start+P]}}if(O>0){(H=new i.DrawingGroup(E,T,A,L,O,void 0,void 0,I,N))._primitives=w,n&&(H.cullingData=V);for(W=0;W<w.length;W++)w[W].group=H;D.push(H)}var j=new i.Mesh;if(j.vertexPositionArray=g,j.vertexNormalArray=v,j.vertexUvArray=S,j.vertexUv2Array=_,j.vertexTangentArray=y,j.vertexBinormalArray=x,j.vertexIndexArray=m,j.drawingGroups=D,void 0===t[0]){var X=new e.Color;X.setRGB(.5,.5,.5),j.gas.fill={color:X,opacity:1,solid:0},j.gas.line={color:X,opacity:1,lineWidth:1},j.gas.point={color:X,opacity:1,pointsize:1}}else j.gas=t[0].gas;if(o){var q=[0,0,0],Z=[0,0,0];if(a>=3){q=[g[0],g[1],g[2]],Z=[g[0],g[1],g[2]];for(f=0;f<a;f+=3)g[f]<q[0]&&(q[0]=g[f]),g[f+1]<q[1]&&(q[1]=g[f+1]),g[f+2]<q[2]&&(q[2]=g[f+2]),g[f]>Z[0]&&(Z[0]=g[f]),g[f+1]>Z[1]&&(Z[1]=g[f+1]),g[f+2]>Z[2]&&(Z[2]=g[f+2])}j.AABB={min:q,max:Z}}return j},i.divideRep=function(e,t,r){var n=e.vertexPositionArray?e.vertexPositionArray.length:0,a=(e.vertexIndexArray.length,[]),s=r||{};if(t)for(var o=0,l=(s=r||{}).withBoundingElement,c=0;c<e.drawingGroups.length;c++){null==(S=e.drawingGroups[c]).gas&&(4==S.glType||5==S.glType?S.gas=e.gas.fill:1==S.glType?S.gas=e.gas.line:0==S.glType&&(S.gas=e.gas.point)),o=S._primitives.length;var h=new Uint32Array(5*o),u=null;l&&S.glType>0&&(u=new Float32Array(4*o));var d=0,p=0;if(e.noShow&&s.containNoShow)for(var f=0;f<S._primitives.length;f++){var m=S._primitives[f];noShowPrim.push(f),h[d++]=m.cgmId+1,h[d++]=e.rep,h[d++]=m.start,h[d++]=m.count,h[d++]=m.decoration,u&&m.boundingSphere&&(u[p++]=m.boundingSphere.center[0],u[p++]=m.boundingSphere.center[1],u[p++]=m.boundingSphere.center[2],u[p++]=m.boundingSphere.radius)}else for(f=0;f<S._primitives.length;f++){m=S._primitives[f];h[d++]=m.cgmId+1,h[d++]=e.rep,h[d++]=m.start,h[d++]=m.count,h[d++]=m.decoration,u&&m.boundingSphere&&(u[p++]=m.boundingSphere.center[0],u[p++]=m.boundingSphere.center[1],u[p++]=m.boundingSphere.center[2],u[p++]=m.boundingSphere.radius)}S._primitives=u?{prims:h,bs:u}:h}else for(f=0;f<e.drawingGroups.length;f++){null==(S=e.drawingGroups[f]).gas&&(4==S.glType||5==S.glType?S.gas=e.gas.fill:1==S.glType?S.gas=e.gas.line:0==S.glType&&(S.gas=e.gas.point));for(c=0;c<S._primitives.length;c++){m=S._primitives[c];var g=new i.SGPrimitive({cgmId:m.cgmId,rep:e.rep,group:S,start:m.start,count:m.count});m.decoration&&(g.decoration=m.decoration),m.boundingSphere&&(g.boundingSphere=m.boundingSphere),S._primitives[c]=g,e.rep._primitives.push(g)}}var v,S,_=e.vertexIndexArray;v=n/3<65535?new Uint16Array(_.length):new Uint32Array(_.length);for(var f=0;f<_.length;f++)v[f]=_[f];return e.vertexIndexArray=v,i.unindexPoints(e),a.push(e),a},i.unindexPoints=function(e){if(!n&&!a)return!1;if(!e.vertexPositionArray)return!1;var t,i,r=!1,s=e.vertexPositionArray.length/3,o=new Int32Array(s);for(t=0;t<s;t++)o[t]=-1;var l=0;for(t=0;t<e.drawingGroups.length;t++){if(!((h=e.drawingGroups[t]).glType>0)){for(r=!0,i=h.start;i<h.start+h.count;i++){-1===o[u=e.vertexIndexArray[i]]?(e.vertexIndexArray[i]=l,o[u]=l,l++):e.vertexIndexArray[i]=o[u]}h.nonIndexed=!0,h.start=e.vertexIndexArray[h.start]}}if(!r)return!1;var c=l;for(t=0;t<l;t++)if(-1===o[t])for(;c<s;){if(-1!==o[c]){o[t]=c,c++;break}o[c]=c,c++}for(;c<s;)-1===o[c]&&(o[c]=c),c++;for(t=0;t<e.drawingGroups.length;t++){var h;if(0!==(h=e.drawingGroups[t]).glType)for(i=h.start;i<h.start+h.count;i++){var u=e.vertexIndexArray[i];e.vertexIndexArray[i]=o[u]}}var d=[];e.vertexPositionArray&&d.push(e.vertexPositionArray),e.vertexNormalArray&&d.push(e.vertexNormalArray),e.vertexUvArray&&d.push(e.vertexUvArray),e.vertexUv2Array&&d.push(e.vertexUv2Array),e.vertexTangentArray&&d.push(e.vertexTangentArray),e.vertexBinormalArray&&d.push(e.vertexBinormalArray);var p=new Float32Array(3*d.length),f=new Float32Array(3*d.length);for(t=0;t<s;t++){var m=t,g=o[m];if(g!==m&&-1!==g){for(i=0;i<d.length;i++){var v=d[i];p[3*i]=v[3*m],p[3*i+1]=v[3*m+1],p[3*i+2]=v[3*m+2]}for(;-1!==g;){for(i=0;i<d.length;i++){v=d[i];f[3*i]=v[3*g],f[3*i+1]=v[3*g+1],f[3*i+2]=v[3*g+2],v[3*g]=p[3*i],v[3*g+1]=p[3*i+1],v[3*g+2]=p[3*i+2],p[3*i]=f[3*i],p[3*i+1]=f[3*i+1],p[3*i+2]=f[3*i+2]}o[m]=-1,g=o[m=g]}}}return!0},i.compareGASMaterial=function(e,t){if(e.opacity<t.opacity)return-1;if(e.opacity>t.opacity)return 1;if(e.color.r<t.color.r)return-1;if(e.color.r>t.color.r)return 1;if(e.color.g<t.color.g)return-1;if(e.color.g>t.color.g)return 1;if(e.color.b<t.color.b)return-1;if(e.color.b>t.color.b)return 1;if(e.thickness&&t.thickness){if(e.thickness<t.thickness)return-1;if(e.thickness>t.thickness)return 1}if(e.lineWidth&&t.lineWidth){if(e.pattern<t.pattern)return-1;if(e.pattern>t.pattern)return 1;if(e.lineWidth<t.lineWidth)return-1;if(e.lineWidth>t.lineWidth)return 1;if((e.forceMaterial||t.forceMaterial)&&(!e.forceMaterial||!t.forceMaterial))return e.forceMaterial?-1:1}if(e.pointsize&&t.pointsize){if(e.pointsize<t.pointsize)return-1;if(e.pointsize>t.pointsize)return 1;if((e.forceMaterial||t.forceMaterial)&&(!e.forceMaterial||!t.forceMaterial))return e.forceMaterial?-1:1}if(e.symbol&&t.symbol){if(e.symbol<t.symbol)return-1;if(e.symbol>t.symbol)return 1;if(e.symbol.id<t.symbol.id)return-1;if(e.symbol.id>t.symbol.id)return 1}if(null!=e.solid&&null!=t.solid){if(e.solid<t.solid)return-1;if(e.solid>t.solid)return 1}return 0},i.applyMat=function(t,i,r,n){if(null!=i){if(t.vertexNormalArray)for(var a=0;a<t.vertexNormalArray.length;a+=3){(s=new e.Vector3(t.vertexNormalArray[a],t.vertexNormalArray[a+1],t.vertexNormalArray[a+2])).applyMatrix4(n),t.vertexNormalArray[a]=s.x,t.vertexNormalArray[a+1]=s.y,t.vertexNormalArray[a+2]=s.z}if(t.vertexPositionArray){for(a=0;a<t.vertexPositionArray.length;a+=3){var s;(s=new e.Vector3(t.vertexPositionArray[a],t.vertexPositionArray[a+1],t.vertexPositionArray[a+2])).applyMatrix4(i),t.vertexPositionArray[a]=s.x,t.vertexPositionArray[a+1]=s.y,t.vertexPositionArray[a+2]=s.z}var o=t.drawingGroups;for(a=0;a<o.length;++a){var l=(p=o[a]).material;if(!(!l||l.id<0||!r[l.id].physicalMaterial||!r[l.id].physicalMaterial.PhysicalMaterial.MappingOperator&&!r[l.id].mapping||r[l.id].physicalMaterial.PhysicalMaterial.MappingOperator&&"None"==r[l.id].physicalMaterial.PhysicalMaterial.MappingOperator.Type||r[l.id].mapping&&r[l.id].mapping.type<0)){var c=(new e.Matrix4).getInverse(i),h=JSON.parse(JSON.stringify(r[l.id])),u=h.physicalMaterial.PhysicalMaterial.MappingOperator;u||(u=h.mapping),u&&u.UvTransformation&&(u.UvTransformation=u.UvTransformation.slice(0));var d=new e.Matrix4;u&&u.ObjectTransformation&&(d.elements=u.ObjectTransformation.slice(0)),d.multiply(c),u.ObjectTransformation=d.elements,p.material.id=r.length,r.push(h)}}if(i.determinant()<0)for(a=0;a<o.length;++a){var p;if(4==(p=o[a]).glType)for(var f=p.count/3,m=0;m<f;m++){var g=t.vertexIndexArray[p.start+3*m],v=t.vertexIndexArray[p.start+3*m+1];t.vertexIndexArray[p.start+3*m]=v,t.vertexIndexArray[p.start+3*m+1]=g}}}}},i.computeBB=function(e){var t=[0,0,0],i=[0,0,0];if(e.vertexPositionArray){var r=e.vertexPositionArray.length;if(r>=3){t=[e.vertexPositionArray[0],e.vertexPositionArray[1],e.vertexPositionArray[2]],i=[e.vertexPositionArray[0],e.vertexPositionArray[1],e.vertexPositionArray[2]];for(var n=0;n<r;n+=3)e.vertexPositionArray[n]<t[0]&&(t[0]=e.vertexPositionArray[n]),e.vertexPositionArray[n+1]<t[1]&&(t[1]=e.vertexPositionArray[n+1]),e.vertexPositionArray[n+2]<t[2]&&(t[2]=e.vertexPositionArray[n+2]),e.vertexPositionArray[n]>i[0]&&(i[0]=e.vertexPositionArray[n]),e.vertexPositionArray[n+1]>i[1]&&(i[1]=e.vertexPositionArray[n+1]),e.vertexPositionArray[n+2]>i[2]&&(i[2]=e.vertexPositionArray[n+2])}}e.AABB={min:t,max:i}},i._getCurrentSag=function(e,t){if(!e)return console.warn("No sag setting"),.2;let i=.2,r=e.scale?e.scale:1;switch(e.sagMode){case 0:t>0&&(i=.01*t*e.sag);break;case 1:i=e.sag*r;break;case 2:i=.2*r;break;case 3:i=.4*r}return i<.01&&(i=.01),t>0&&i>.1*t&&(i=.1*t),i},i._computeMaxAngleStep=function(e,t){let i=2*Math.acos(1-e/t);return i<.001&&(i=.001),i},i._computeAngleStep=function(e,t){return e/t},i._computeNbCirclePoints=function(e,t){let i=Math.PI/4;t>i&&(t=i);let r=Math.ceil(e/t);return r<3&&(r=3),[r,t=this._computeAngleStep(e,r)]},i._createCustomCylindricalMesh=function(t,r,n,a,s,o,l,c,h,u){var d=a>0,p=n>0,f=new e.Vector3(r[0],r[1],r[2]),m=new e.Vector3(t[0],t[1],t[2]),_=new e.Vector4;_.subVectors(f,m),_.w=0,_.normalize();var y=new e.Matrix4;0===_.x&&0===_.y?y.identity():y.set(_.x/Math.sqrt(_.x*_.x+_.y*_.y),_.y/Math.sqrt(_.x*_.x+_.y*_.y),0,0,-_.y/Math.sqrt(_.x*_.x+_.y*_.y),_.x/Math.sqrt(_.x*_.x+_.y*_.y),0,0,0,0,1,0,0,0,0,1);var x=new e.Matrix4;0===_.x&&0===_.y&&0===_.z?x.identity():x.set(_.z/Math.sqrt(_.x*_.x+_.y*_.y+_.z*_.z),0,-Math.sqrt(_.x*_.x+_.y*_.y)/Math.sqrt(_.x*_.x+_.y*_.y+_.z*_.z),0,0,1,0,0,Math.sqrt(_.x*_.x+_.y*_.y)/Math.sqrt(_.x*_.x+_.y*_.y+_.z*_.z),0,_.z/Math.sqrt(_.x*_.x+_.y*_.y+_.z*_.z),0,0,0,0,1);var M=new e.Matrix4;M.multiplyMatrices(x,y),M.transpose();var P=new e.Vector3(m.x,m.y,m.z),C=M.clone();M.elements[12]=P.x,M.elements[13]=P.y,M.elements[14]=P.z;var b=Math.sqrt((m.x-f.x)*(m.x-f.x)+(m.y-f.y)*(m.y-f.y)+(m.z-f.z)*(m.z-f.z));let D=Math.max(n,a),w=this._getCurrentSag(l,D),E=this._computeMaxAngleStep(w,D),T=0;[T,E]=this._computeNbCirclePoints(2*Math.PI,E);var A=(n-a)/b,I=6*T,R=2*T,L=2*T;d&&(I+=3*(T-2)+2*T,T,L+=T,R+=T),p&&(I+=3*(T-2)+2*T,T,L+=T,R+=T);for(var O=6*T+(d?3*(T-2):0)+(p?3*(T-2):0),N=(d?2*T:0)+(p?2*T:0),F=new Uint16Array(I),V=F,U=0,B=0;B<T-1;++B){var k=B+1;V[U++]=B,V[U++]=k,V[U++]=T+k,V[U++]=B,V[U++]=T+k,V[U++]=T+B}k=0;if(V[U++]=T-1,V[U++]=k,V[U++]=T+k,V[U++]=T-1,V[U++]=T+k,V[U++]=T+T-1,d)for(B=0;B<T-2;B++)V[U++]=2*T,V[U++]=2*T+B+1,V[U++]=2*T+B+2;if(p)if(d)for(B=0;B<T-2;B++)V[U++]=3*T,V[U++]=3*T+B+2,V[U++]=3*T+B+1;else for(B=0;B<T-2;B++)V[U++]=2*T,V[U++]=2*T+B+2,V[U++]=2*T+B+1;if(d){for(B=0;B<T-1;++B)V[U++]=T+B,V[U++]=T+B+1;V[U++]=T+T-1,V[U++]=T}if(p){for(B=0;B<T-1;++B)V[U++]=B,V[U++]=B+1;V[U++]=T-1,V[U++]=0}var G=new Float32Array(3*R),z=new Float32Array(3*R),H=G,W=z,j=0;for(B=0;B<T;B++,j+=3){var X=B/T*2*Math.PI;H[j]=n*Math.cos(X),H[j+1]=n*Math.sin(X),H[j+2]=0,W[j]=B/T,W[j+1]=1,W[j+2]=0}j=3*T;for(B=0;B<T;B++,j+=3){X=B/T*2*Math.PI;H[j]=a*Math.cos(X),H[j+1]=a*Math.sin(X),H[j+2]=b,W[j]=B/T,W[j+1]=0,W[j+2]=0}if(d){X=0;for(var q=0;q<T;q++)X=q/T*2*Math.PI,H[j]=H[3*(T+q)],W[j++]=(Math.cos(X)+1)/2,H[j]=H[3*(T+q)+1],W[j++]=1-(Math.sin(X)+1)/2,H[j]=H[3*(T+q)+2],W[j++]=0}if(p)for(X=0,q=0;q<T;q++)X=q/T*2*Math.PI,H[j]=H[3*q],W[j++]=(Math.cos(X)+1)/2,H[j]=H[3*q+1],W[j++]=1-(Math.sin(X)+1)/2,H[j]=H[3*q+2],W[j++]=0;var Z=new Float32Array(3*L);H=Z;j=0;for(var Y=0;Y<2;Y++)for(B=0;B<T;B++){X=B/T*2*Math.PI;(K=new e.Vector3).x=G[3*B],K.y=G[3*B+1],K.z=G[3*B+2],K.z=Math.sqrt(K.x*K.x+K.y*K.y)*A,K.normalize(),H[j++]=K.x,H[j++]=K.y,H[j++]=K.z}if(d)for(Y=0;Y<T;Y++)H[j++]=0,H[j++]=0,H[j++]=1;if(p)for(Y=0;Y<T;Y++)H[j++]=0,H[j++]=0,H[j++]=-1;for(q=0;q<R;q++){(K=new e.Vector3).x=G[3*q],K.y=G[3*q+1],K.z=G[3*q+2],K.applyMatrix4(M),G[3*q]=K.x,G[3*q+1]=K.y,G[3*q+2]=K.z}for(q=0;q<L;q++){var K;(K=new e.Vector3).x=Z[3*q],K.y=Z[3*q+1],K.z=Z[3*q+2],K.applyMatrix4(C),Z[3*q]=K.x,Z[3*q+1]=K.y,Z[3*q+2]=K.z}var J,Q=new i.Mesh;Q.vertexPositionArray=G,Q.vertexNormalArray=Z,Q.vertexUVArray=z,Q.vertexIndexArray=F,Q.gas=s,Q.matId=o,c?(s.setConnectivity(0),(J=u).setConnectivity(3)):J=s.line?s.line:s;var $=new i.DrawingGroup(s,o,4,0,O,[],null,e.GeomTypeEnum.FACE),ee=new i.DrawingGroup(J,o,1,O,N,[],null,e.GeomTypeEnum.SHARP_EDGE);O=6*T+(d?3*(T-2):0)+(p?3*(T-2):0),N=(d?2*T:0)+(p?2*T:0);let te=0,ie=[r[0]-t[0],r[1]-t[1],r[2]-t[2]];if(d||p){let e=new i.SGPrimitive({cgmId:te++,group:ee,start:O,count:2*T});if(ee._primitives.push(e),h){let i;i=d?S(r,ie,a):S(t,ie,n),e.decoration=h.addDecoration(i)}}if(d&&p){let e=new i.SGPrimitive({cgmId:te++,group:ee,start:O+2*T,count:2*T});if(ee._primitives.push(e),h){let i=S(t,ie,n);e.decoration=h.addDecoration(i)}}var re=new i.SGPrimitive({cgmId:te++,group:$,start:0,count:6*T});if($._primitives.push(re),h)if(a==n){let e=g(t,ie,a);re.decoration=h.addDecoration(e)}else{if(a>n){let e=t;t=r,r=e,e=n,n=a,a=e}let i=[t[0]-r[0],t[1]-r[1],t[2]-r[2]],s=new e.Vector3(i[0],i[1],i[2]).length(),o=s/(1-a/n);i[0]*=o/s,i[1]*=o/s,i[2]*=o/s;let l=[t[0]-i[0],t[1]-i[1],t[2]-i[2]],c=180*Math.atan(n/o)/Math.PI,u=v(l,i,c);re.decoration=h.addDecoration(u)}return(d||p)&&(re=new i.SGPrimitive({cgmId:te++,group:$,start:6*T,count:3*(T-2)}),$._primitives.push(re)),d&&p&&(re=new i.SGPrimitive({cgmId:te++,group:$,start:6*T+3*(T-2),count:3*(T-2)}),$._primitives.push(re)),Q.drawingGroups.push($),Q.drawingGroups.push(ee),i.computeBB(Q),Q},i._createCustomSphereMesh=function(t,r,n,a,s,o,l,c,h,u,d,p){var m=new e.Vector3(o[0],o[1],o[2]),g=new e.Vector3(l[0],l[1],l[2]),v=m.length();t<-Math.PI/2&&(t=-Math.PI/2),t>Math.PI/2&&(t=Math.PI/2),r<-Math.PI/2&&(r=-Math.PI/2),r>Math.PI/2&&(r=Math.PI/2);var S=r-t;S<0&&(S=0),n<0&&(n=0),n>2*Math.PI&&(n=2*Math.PI),a<0&&(a=0),a>2*Math.PI&&(a=2*Math.PI);var _=a-n;_<0&&(_=0);let y=this._getCurrentSag(u,v),x=this._computeMaxAngleStep(y,v),M=0,P=0,C=0,b=0;[M,C]=this._computeNbCirclePoints(_,x),[P,b]=this._computeNbCirclePoints(2*S,x),M+=1,P+=1;this._computeAngleStep(_,M-1),this._computeAngleStep(S,P-1);for(var D=3*(M+1)*P,w=6*M*(P-1),E=new Float32Array(D),T=new Float32Array(D),A=new Float32Array(D),I=new Uint16Array(w),R=E,L=T,O=A,N=m.normalize(),F=g.normalize(),V=(new e.Vector3).crossVectors(N,F),U=I,B=0,k=0;k<P-1;k++)for(Z=0;Z<M;Z++)U[B++]=k*(M+1)+Z,U[B++]=(k+1)*(M+1)+Z+1,U[B++]=(k+1)*(M+1)+Z,U[B++]=k*(M+1)+Z,U[B++]=k*(M+1)+Z+1,U[B++]=(k+1)*(M+1)+Z+1;B=0;var G=1/(P-1),z=(new e.Vector3,new e.Vector3),H=new e.Vector3,W=new e.Vector3;for(k=0;k<P;k++)for(var j=k*G,X=Math.sin(t+j*S),q=Math.cos(t+j*S),Z=0;Z<=M;Z++,B+=3){var Y=Z/M,K=Math.sin(n+Y*_),J=Math.cos(n+Y*_);z.copy(N),z.multiplyScalar(J),H.copy(F),H.multiplyScalar(K),W.copy(V),W.multiplyScalar(X),z.add(H),z.multiplyScalar(q),z.add(W);var Q=z;L[B]=Q.x,R[B]=s[0]+Q.x*v,O[B]=Y,L[B+1]=Q.y,R[B+1]=s[1]+Q.y*v,O[B+1]=k/P,L[B+2]=Q.z,R[B+2]=s[2]+Q.z*v,O[B+2]=0}var $=new i.Mesh;$.vertexPositionArray=E,$.vertexNormalArray=T,$.vertexUVArray=A,$.vertexIndexArray=I,$.gas=c,$.matId=h,d&&c.setConnectivity(0);var ee=new i.DrawingGroup(c,h,4,0,w,[],null,e.GeomTypeEnum.FACE),te=new i.SGPrimitive({cgmId:0,group:ee,start:0,count:w});if(p){let e=f(s,v);te.decoration=p.addDecoration(e)}return ee._primitives.push(te),$.drawingGroups.push(ee),i.computeBB($),$},i._buildCurvedPipeDataFromTorus=function(t,i,r,n,a,s){var o=[],l=(new e.Vector3).copy(i),c=(new e.Vector3).copy(r);let h=l.length();s&&(h+=s);let u=this._getCurrentSag(a,h),d=this._computeMaxAngleStep(u,h),p=0;[p,d]=this._computeNbCirclePoints(n,d);for(var f=0,m=0;m<p+1;m++){var g=Math.cos(f),v=Math.sin(f);l.copy(i).multiplyScalar(g),c.copy(r).multiplyScalar(v),l.add(c).add(t),o.push(l.x),o.push(l.y),o.push(l.z),f+=d}if(i.normalize(),r.normalize(),n==2*Math.PI){o.push(o[0]),o.push(o[1]),o.push(o[2]);var S=[-r.x,-r.y,-r.z],_=[r.x,r.y,r.z]}else{S=[-r.x,-r.y,-r.z];l.crossVectors(i,r);var y=o.length;c.set(o[y-3],o[y-2],o[y-1]).sub(t).normalize(),l.cross(c).normalize();_=[l.x,l.y,l.z]}return{centers:o,startNormal:S,endNormal:_}},i._createTorusMesh=function(t,r,n,a,s,o,l,c,h){var u=new e.Vector3,d=new e.Vector3;u.subVectors(r[0],t);let p=u.length();d.crossVectors(u,a).normalize();let f=this._getCurrentSag(l,n[0]),g=this._computeMaxAngleStep(f,n[0]),v=0;[v,g]=this._computeNbCirclePoints(2*Math.PI,g);for(var S=3*r.length*v,_=6*v*(r.length-1),y=new Float32Array(S),x=new Float32Array(S),M=new Float32Array(S),P=new Uint16Array(_),C=y,b=x,D=M,w=P,E=new e.Vector3,T=new e.Vector3,A=new e.Vector3,I=new e.Vector3,R=0,L=0;L<r.length;L++){0==L||L==r.length-1?E.copy(a).negate():(A.subVectors(r[L],r[L-1]),E.subVectors(r[L+1],r[L]),E.add(A)),E.normalize(),T.crossVectors(E,d),T.normalize();for(var O=0,N=0;N<v;N++)A.copy(T).multiplyScalar(Math.cos(O)),I.copy(d).multiplyScalar(Math.sin(O)),A.add(I),b[R]=A.x,b[R+1]=A.y,b[R+2]=A.z,A.multiplyScalar(n[L]),A.add(r[L]),C[R]=A.x,C[R+1]=A.y,C[R+2]=A.z,D[R++]=N/v,D[R++]=L/r.length,D[R++]=0,O+=g}R=0;for(L=0;L<r.length-1;L++)for(N=0;N<v;N++){var F=(N+1)%v;w[R++]=L*v+N,w[R++]=(L+1)*v+N,w[R++]=(L+1)*v+F,w[R++]=L*v+N,w[R++]=(L+1)*v+F,w[R++]=L*v+F}var V=new i.Mesh;V.vertexPositionArray=y,V.vertexNormalArray=x,V.vertexUVArray=M,V.vertexIndexArray=P,V.gas=s,V.matId=o,c&&s.setConnectivity(0);var U=new i.DrawingGroup(s,o,4,0,_,[],null,e.GeomTypeEnum.FACE),B=new i.SGPrimitive({cgmId:0,group:U,start:0,count:6*v*(r.length-1)});if(U._primitives.push(B),h){let e=m(t,d,n[0],p);B.decoration=h.addDecoration(e)}return V.drawingGroups.push(U),i.computeBB(V),V},i._createCurvedPipeMesh=function(t,r,n,a,s,o,l,c,h,u,d,p){let f=r[0];for(let e=1;e<r.length;e++)r[e]>f&&(f=r[e]);let g=this._getCurrentSag(c,f),v=this._computeMaxAngleStep(g,f),S=0;[S,v]=this._computeNbCirclePoints(2*Math.PI,v);var _=3*t.length*S,y=6*S*(t.length-1),x=0;s&&(_+=6*S,y+=6*(S-2),x=4*S);var M=new Float32Array(_),P=new Float32Array(_),C=new Float32Array(_),b=new Uint16Array(y+x),D=M,w=P,E=C,T=b,A=new e.Vector3,I=new e.Vector3,R=new e.Vector3,L=new e.Vector3,O=new e.Vector3;if(t.length>=3)L.subVectors(t[1],t[0]),R.subVectors(t[2],t[1]),A.crossVectors(L,R).normalize(),L.copy(n).negate(),R.crossVectors(L,A);else{L.copy(n).negate();var N=Math.abs(L.x),F=Math.abs(L.y),V=Math.abs(L.z),U=.001;N>F?F>V?O.set(0,F+U,V+U):N>V?O.set(0,F+U,V+U):O.set(N+U,F+U,0):N>V?O.set(N+U,0,V+U):F>V?O.set(N+U,0,V+U):O.set(N+U,F+U,0),R.crossVectors(L,O)}for(var B=0,k=0;k<t.length;k++){R.normalize(),0==k?I.copy(n).negate():k==t.length-1?I.copy(a):(L.subVectors(t[k],t[k-1]),I.subVectors(t[k+1],t[k]),I.add(L)),I.normalize(),A.crossVectors(R,I),A.normalize(),k>0&&R.crossVectors(I,A);for(var G=0,z=0;z<S;z++)L.copy(R).multiplyScalar(Math.cos(G)),O.copy(A).multiplyScalar(Math.sin(G)),L.add(O),w[B]=L.x,w[B+1]=L.y,w[B+2]=L.z,L.multiplyScalar(r[k]),L.add(t[k]),D[B]=L.x,D[B+1]=L.y,D[B+2]=L.z,E[B++]=z/S,E[B++]=k/t.length,E[B++]=0,G+=v}if(s){for(z=0;z<S;z++)w[B]=n.x,w[B+1]=n.y,w[B+2]=n.z,D[B++]=D[3*z],D[B++]=D[3*z+1],D[B++]=D[3*z+2];var H=S*(t.length-1)*3;for(z=0;z<S;z++)w[B]=a.x,w[B+1]=a.y,w[B+2]=a.z,D[B++]=D[H+3*z],D[B++]=D[H+3*z+1],D[B++]=D[H+3*z+2]}B=0;for(k=0;k<t.length-1;k++)for(z=0;z<S;z++){var W=(z+1)%S;T[B++]=k*S+z,T[B++]=(k+1)*S+z,T[B++]=(k+1)*S+W,T[B++]=k*S+z,T[B++]=(k+1)*S+W,T[B++]=k*S+W}if(s){for(k=0;k<S-2;k++)T[B++]=t.length*S,T[B++]=t.length*S+k+1,T[B++]=t.length*S+k+2;for(k=0;k<S-2;k++)T[B++]=(t.length+1)*S,T[B++]=(t.length+1)*S+k+2,T[B++]=(t.length+1)*S+k+1;for(k=0;k<S;k++)T[B++]=t.length*S+k,T[B++]=t.length*S+(k+1)%S;for(k=0;k<S;k++)T[B++]=(t.length+1)*S+k,T[B++]=(t.length+1)*S+(k+1)%S}var j=new i.Mesh;j.vertexPositionArray=M,j.vertexNormalArray=P,j.vertexUVArray=C,j.vertexIndexArray=b,j.gas=o,j.matId=l,h&&o.setConnectivity(0);var X=new i.DrawingGroup(o,l,4,0,y,[],null,e.GeomTypeEnum.FACE);let q=0;var Z=new i.SGPrimitive({cgmId:q++,group:X,start:0,count:6*S*(t.length-1)});if(X._primitives.push(Z),u&&d){let t=new e.Vector3(d.center[0],d.center[1],d.center[2]),i=new e.Vector3(d.firstAxis[0],d.firstAxis[1],d.firstAxis[2]),n=i.length(),a=new e.Vector3(d.secondAxis[0],d.secondAxis[1],d.secondAxis[2]),s=(new e.Vector3).crossVectors(i.normalize(),a.normalize()),o=m(t,s,r[0],n);Z.decoration=u.addDecoration(o)}if(Z=new i.SGPrimitive({cgmId:q++,group:X,start:6*S*(t.length-1),count:3*(S-2)}),X._primitives.push(Z),Z=new i.SGPrimitive({cgmId:q++,group:X,start:6*S*(t.length-1)+3*(S-2),count:3*(S-2)}),X._primitives.push(Z),j.drawingGroups.push(X),x){var Y;h?(Y=p).setConnectivity(3):Y=o.line?o.line:o;var K=new i.DrawingGroup(Y,l,1,y,x,[],null,e.GeomTypeEnum.SHARP_EDGE);Z=new i.SGPrimitive({cgmId:q++,group:K,start:y,count:x/2}),K._primitives.push(Z),Z=new i.SGPrimitive({cgmId:q++,group:K,start:y+x/2,count:x/2}),K._primitives.push(Z),j.drawingGroups.push(K)}return i.computeBB(j),j},i._createCuboidMesh=function(t,r,n,a,s,o,l,c,h){var u=new i.Mesh;u.gas=s,u.matId=o;var d=new e.Vector3(t[0],t[1],t[2]),p=new e.Vector3(r[0],r[1],r[2]),f=new e.Vector3(n[0],n[1],n[2]),m=(new e.Vector3).crossVectors(p,f).normalize().multiplyScalar(a);u.vertexPositionArray=new Float32Array(72),u.vertexNormalArray=new Float32Array(72),u.vertexUVArray=new Float32Array(72);var g=u.vertexPositionArray,v=u.vertexNormalArray,S=u.vertexUVArray,_=new e.Vector3,y=new e.Vector3;y.copy(m).normalize();var x=new e.Vector3;x.copy(y).negate();var M=new e.Vector3;M.copy(f).normalize();var P=new e.Vector3;P.copy(M).negate();var C=new e.Vector3;C.copy(p).normalize();var b=new e.Vector3;b.copy(C).negate();var D=new e.Vector3(d.x,d.y,d.z),w=new e.Vector3(d.x,d.y,d.z),E=new e.Vector3(0,0,0),T=new e.Vector3(1,0,0),A=new e.Vector3(1,1,0),I=new e.Vector3(0,1,0);_.addVectors(d,m),D.min(_),w.max(_),g[9]=_.x,g[10]=_.y,g[11]=_.z,g[24]=_.x,g[25]=_.y,g[26]=_.z,g[48]=_.x,g[49]=_.y,g[50]=_.z,v[9]=y.x,v[10]=y.y,v[11]=y.z,v[24]=P.x,v[25]=P.y,v[26]=P.z,v[48]=b.x,v[49]=b.y,v[50]=b.z,S[9]=I.x,S[10]=I.y,S[11]=I.z,S[24]=E.x,S[25]=E.y,S[26]=E.z,S[48]=E.x,S[49]=E.y,S[50]=E.z,_.add(p),D.min(_),w.max(_),g[6]=_.x,g[7]=_.y,g[8]=_.z,g[27]=_.x,g[28]=_.y,g[29]=_.z,g[60]=_.x,g[61]=_.y,g[62]=_.z,v[6]=y.x,v[7]=y.y,v[8]=y.z,v[27]=P.x,v[28]=P.y,v[29]=P.z,v[60]=C.x,v[61]=C.y,v[62]=C.z,S[6]=A.x,S[7]=A.y,S[8]=A.z,S[27]=T.x,S[28]=T.y,S[29]=T.z,S[60]=E.x,S[61]=E.y,S[62]=E.z,_.add(f),D.min(_),w.max(_),g[3]=_.x,g[4]=_.y,g[5]=_.z,g[36]=_.x,g[37]=_.y,g[38]=_.z,g[63]=_.x,g[64]=_.y,g[65]=_.z,v[3]=y.x,v[4]=y.y,v[5]=y.z,v[36]=M.x,v[37]=M.y,v[38]=M.z,v[63]=C.x,v[64]=C.y,v[65]=C.z,S[3]=T.x,S[4]=T.y,S[5]=T.z,S[36]=E.x,S[37]=E.y,S[38]=E.z,S[63]=T.x,S[64]=T.y,S[65]=T.z,_.addVectors(d,m),_.add(f),D.min(_),w.max(_),g[0]=_.x,g[1]=_.y,g[2]=_.z,g[39]=_.x,g[40]=_.y,g[41]=_.z,g[57]=_.x,g[58]=_.y,g[59]=_.z,v[0]=y.x,v[1]=y.y,v[2]=y.z,v[39]=M.x,v[40]=M.y,v[41]=M.z,v[57]=b.x,v[58]=b.y,v[59]=b.z,S[0]=E.x,S[1]=E.y,S[2]=E.z,S[39]=T.x,S[40]=T.y,S[41]=T.z,S[57]=I.x,S[58]=I.y,S[59]=I.z,_.addVectors(d,f),D.min(_),w.max(_),g[21]=_.x,g[22]=_.y,g[23]=_.z,g[42]=_.x,g[43]=_.y,g[44]=_.z,g[54]=_.x,g[55]=_.y,g[56]=_.z,v[21]=x.x,v[22]=x.y,v[23]=x.z,v[42]=M.x,v[43]=M.y,v[44]=M.z,v[54]=b.x,v[55]=b.y,v[56]=b.z,S[21]=I.x,S[22]=I.y,S[23]=I.z,S[42]=A.x,S[43]=A.y,S[44]=A.z,S[54]=A.x,S[55]=A.y,S[56]=A.z,_.add(p),D.min(_),w.max(_),g[18]=_.x,g[19]=_.y,g[20]=_.z,g[45]=_.x,g[46]=_.y,g[47]=_.z,g[66]=_.x,g[67]=_.y,g[68]=_.z,v[18]=x.x,v[19]=x.y,v[20]=x.z,v[45]=M.x,v[46]=M.y,v[47]=M.z,v[66]=C.x,v[67]=C.y,v[68]=C.z,S[18]=A.x,S[19]=A.y,S[20]=A.z,S[45]=I.x,S[46]=I.y,S[47]=I.z,S[66]=A.x,S[67]=A.y,S[68]=A.z,_.addVectors(d,p),D.min(_),w.max(_),g[15]=_.x,g[16]=_.y,g[17]=_.z,g[30]=_.x,g[31]=_.y,g[32]=_.z,g[69]=_.x,g[70]=_.y,g[71]=_.z,v[15]=x.x,v[16]=x.y,v[17]=x.z,v[30]=P.x,v[31]=P.y,v[32]=P.z,v[69]=C.x,v[70]=C.y,v[71]=C.z,S[15]=T.x,S[16]=T.y,S[17]=T.z,S[30]=A.x,S[31]=A.y,S[32]=A.z,S[69]=I.x,S[70]=I.y,S[71]=I.z,g[12]=d.x,g[13]=d.y,g[14]=d.z,g[33]=d.x,g[34]=d.y,g[35]=d.z,g[51]=d.x,g[52]=d.y,g[53]=d.z,v[12]=x.x,v[13]=x.y,v[14]=x.z,v[33]=P.x,v[34]=P.y,v[35]=P.z,v[51]=b.x,v[52]=b.y,v[53]=b.z,S[12]=E.x,S[13]=E.y,S[14]=E.z,S[33]=I.x,S[34]=I.y,S[35]=I.z,S[51]=T.x,S[52]=T.y,S[53]=T.z,u.vertexIndexArray=new Uint16Array(60);for(var R=u.vertexIndexArray,L=0,O=0;O<6;O++)R[L++]=4*O,R[L++]=4*O+2,R[L++]=4*O+1,R[L++]=4*O,R[L++]=4*O+3,R[L++]=4*O+2;for(O=0;O<2;O++)R[L++]=4*O,R[L++]=4*O+1,R[L++]=4*O+1,R[L++]=4*O+2,R[L++]=4*O+2,R[L++]=4*O+3,R[L++]=4*O+3,R[L++]=4*O;R[L++]=0,R[L++]=7,R[L++]=1,R[L++]=6,R[L++]=2,R[L++]=5,R[L++]=3,R[L++]=4,l&&s.setConnectivity(0);var N,F=new i.DrawingGroup(s,o,4,0,36,[],null,e.GeomTypeEnum.FACE);l?(N=h).setConnectivity(3):N=s.line?s.line:s;var V=new i.DrawingGroup(N,o,1,36,24,[],null,e.GeomTypeEnum.SHARP_EDGE);let U=0;for(O=0;O<6;O++){var B=new i.SGPrimitive({cgmId:U++,cgmId:O,group:F,start:6*O,count:6});F._primitives.push(B)}for(O=0;O<12;O++){B=new i.SGPrimitive({cgmId:U++,cgmId:O,group:V,start:36+2*O,count:2});V._primitives.push(B)}u.drawingGroups.push(F),u.drawingGroups.push(V);var k=[D.x,D.y,D.z],G=[w.x,w.y,w.z];return u.AABB={min:k,max:G},u};let f=function(e,t){let i=[0,52,53];return x(i,e[0]),x(i,e[1]),x(i,e[2]),x(i,t),i[0]=i.length,i},m=function(e,t,i,r){let n=[0,52,56];return x(n,e.x),x(n,e.y),x(n,e.z),x(n,t.x),x(n,t.y),x(n,t.z),x(n,r),x(n,i),n[0]=n.length,n},g=function(e,t,i){let r=[0,52,51];return x(r,e[0]),x(r,e[1]),x(r,e[2]),x(r,t[0]),x(r,t[1]),x(r,t[2]),x(r,i),r[0]=r.length,r},v=function(e,t,i){let r=[0,52,52];return x(r,e[0]),x(r,e[1]),x(r,e[2]),x(r,t[0]),x(r,t[1]),x(r,t[2]),x(r,i),r[0]=r.length,r},S=function(e,t,i){let r=[0,52,55];return x(r,e[0]),x(r,e[1]),x(r,e[2]),x(r,t[0]),x(r,t[1]),x(r,t[2]),x(r,i),r[0]=r.length,r},_=new Uint8Array(8),y=new DataView(_.buffer,0,8),x=function(e,t){y.setFloat64(0,t),e.push(_[0]),e.push(_[1]),e.push(_[2]),e.push(_[3]),e.push(_[4]),e.push(_[5]),e.push(_[6]),e.push(_[7])},M=new Uint8Array(4);new DataView(M.buffer,0,4);return i}),define("Mesh/Mesh",["DS/Mesh/Mesh","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Mesh/Mesh"),e}),define("DS/Intersection/VolumeIntersection",["DS/Mesh/ThreeJS_Base","DS/Mesh/Mesh"],function(e,t){"use strict";var i=function(i,r,n,a,s,o,l,c,h,u,d,p){var f=new e.Vector3,m=new e.Vector3,g=new e.Vector3,v=new e.Sphere,S=r.vertexIndexArray;if(!r.vertexIndexArray)return console.log("Warning: no CPU picking in noMeshInRam"),0;!function(e,i,r,n,a,s,o){if(!s.vertexIndexArray)return console.log("Warning: no CPU picking in noMeshInRam"),0;for(var l=s.drawingGroups,c=0;c<l.length;c++){var h=l[c],u=0;switch(h.glType){case 4:case 5:if(!i)continue;u=3;break;case 1:if(!n)continue;u=2;break;case 0:if(!r)continue;u=1;break;default:continue}var d=null;a.layer&&(d=a.layer.getIntervals(geometry,h));for(var p=new t.SGPrimitiveHelper,f=0;f<h.getPrimitivesCount();f++){if(p.set(h,f),null!==d){for(var m=!1,g=d.length-1;g>=0;g--)if(d[g].start<=p.getStart()){d[g].skip(a,o)&&(m=!0);break}if(m)continue}if(e(u,p))return}}}(function(t,a){var s;switch(t){case 1:s=function(e){for(var t=!0,i=!1,a=e.getStart();a<e.getStart()+e.getCount();a++){r.getVertexPosition(S[a],f),f.applyMatrix4(u);var s=n.containsPoint(f);if(i=i||s,!(t=t&&s)&&i)break}return{insideb:t,partialb:i}}(a);break;case 2:s=function(t){for(var i=!0,a=!1,s=t.getStart();s<t.getStart()+t.getCount();s+=2){r.getVertexPosition(S[s],f),f.applyMatrix4(u),r.getVertexPosition(S[s+1],m),m.applyMatrix4(u);var o=n.containsPoint(f),l=n.containsPoint(m);if((i=i&&o&&l)?a=!0:(v.setFromCenterAndPoints(new e.Vector3((f.x+m.x)/2,(f.y+m.y)/2,(f.z+m.z)/2),[f,m]),a=a||o||l||n.intersectsSphere(v)&&n.intersectsLine([f,m])),!i&&a)break}return{insideb:i,partialb:a}}(a);break;case 3:s=function(t){for(var i=!0,a=!1,s=t.getStart();s+2<t.getStart()+t.getCount();s++){r.getVertexPosition(S[s],f),f.applyMatrix4(u),r.getVertexPosition(S[s+1],m),m.applyMatrix4(u),r.getVertexPosition(S[s+2],g),g.applyMatrix4(u);var o=n.containsPoint(f),l=n.containsPoint(m),c=n.containsPoint(g);if((i=i&&o&&l&&c)?a=!0:(v.setFromCenterAndPoints(new e.Vector3((f.x+m.x+g.x)/3,(f.y+m.y+g.y)/3,(f.z+m.z+g.z)/3),[f,m,g]),a=a||o||l||c||n.intersectsSphere(v)&&n.intersectsTriangle([f,m,g])),!i&&a)break}return{insideb:i,partialb:a}}(a);break;default:return void console.error("Error: requiredVectors can't be equal to 0")}var o={primitive:a.clone(),object:i};if(s.insideb)l.push(o);else{if(s.partialb)return h.push(o),d;c.push(o)}return!1},a,s,o,i,r,p)},r=function(e,t,r,n,a,s,o,l){if(!t.vertexIndexArray)return console.log("Warning: no CPU picking in noMeshInRam"),0;var c=[],h=[],u=[];return i(e,t,r,n,a,s,c,u,h,o,!0,l),h.length>0||u.length>0&&c.length>0?1:u.length>0?0:2};return{_meshIntersectVolume:function(t,i,n,a,s,o,l,c,h){if(!function(t,i,r,n){var a=new e.Sphere,s=t._getMMMatrix();return null!==t.boundingSphere&&a.copy(t.boundingSphere),a.applyMatrix4(s),i.containsSphere(a)?(n.push({object:t}),!0):!i.intersectsSphere(a)&&(r.push({object:t}),!0)}(t,i,l,o)){var u=t._getMMMatrix(),d=t.geometry;2===d._type&&(d=[d]);for(var p=0;p<d.length;p++){var f=d[p];switch(r(t,f,i,n,a,s,u,h)){case 0:l.push({object:t});break;case 1:c.push({object:t});break;case 2:o.push({object:t});break;default:return}}}}}}),define("DS/Visualization/Utils",["UWA/Class","UWA/Utils","DS/Visualization/ProxyAbstraction"],function(e,t,i){"use strict";var r=e.extend({init:function(){}});return r.parseUrl=function(e){return t.parseUrl(e)},r.getExtension=function(e){var t=e.replace(/\.\./g,"");if(1===(t=t.split(".")).length||""===t[0]&&2===t.length)return"";var i=t.pop(),r=i.indexOf("?")+1;return t=r?i.substring(0,r-1):i,null!==new RegExp(/^[a-zA-Z0-9_]+$/).exec(t)?t:""},r.getDomain=function(e){var i=e;return t.isAbsoluteUrl(e)||(i=window.location),r.parseUrl(i).hostname},r.getWorkerFromSpec=function(e,t){var n=window.URL||window.webkitURL,a=new i;r.setProxyFromSpec(e,a);var s=e.serverurl?e.serverurl:"";s+=e.filename?e.filename:"";a.executeGetHttpRequest(s,"blob",null,function(e){var i=n.createObjectURL(e),r=new Worker(i);t&&t(r)})},r.getJSFromSpec=function(e,t){var n=new i;r.setProxyFromSpec(e,n);var a=e.serverurl?e.serverurl:"";a+=e.filename?e.filename:"",e.module&&e.filename&&(a=require.toUrl("DS/"+e.module+"/"+e.filename));n.executeGetHttpRequest(a,"text",null,function(e){t&&t(e)},null,"text/plain, text/javascript, application/javascript, application/x-javascript")},r.getWorkerFromSpecs=function(e,t){var i=window.URL||window.webkitURL,n="",a=function(s){r.getJSFromSpec(e[s],function(r){if(n+=r,s<e.length-1)a(s+1);else if(t){var o=new Blob([n],{type:"application/javascript"}),l=i.createObjectURL(o),c=new Worker(l);t(c)}})};a(0)},r.getWorkerBlobFromSpecs=function(e,t){var i=window.URL||window.webkitURL,n="",a=function(s){r.getJSFromSpec(e[s],function(r){if(n+=r,s<e.length-1)a(s+1);else if(t){var o=new Blob([n],{type:"application/javascript"}),l=i.createObjectURL(o);t(l)}})};a(0)},r.getFileURLFromSpec=function(e,t){var n=window.URL||window.webkitURL,a=new i;r.setProxyFromSpec(e,a);var s=e.serverurl?e.serverurl:"";s+=e.filename?e.filename:"";a.executeGetHttpRequest(s,"blob",null,function(e){var i=n.createObjectURL(e);t&&t(i)})},r.getFilesURLFromSpec=function(e,t){var i=[],n=function(a){r.getFileURLFromSpec(e[a],function(r){i.push(r),a<e.length-1?n(a+1):t&&t(i)})};n(0)},r.setProxyFromSpec=function(e,t){if(e.proxyurl)if("none"===e.proxyurl)t.useNoProxy(e.withCredentials);else{var i=r.parseUrl(e.proxyurl);if(null===i)t.useUWAProxy();else if(null!=i.hostname)t.useProxyDefinedBy(i.hostname,i.port);else if(0==(n=e.proxyurl.indexOf("http://127.0.0.1"))){var n=e.proxyurl.lastIndexOf(":"),a=e.proxyurl.slice(n+1,e.proxyurl.length);a=a.replace("/",""),t.useProxyDefinedBy("127.0.0.1",8023)}}else t.useUWAProxy({proxymode:e.requiredAuth,requestsOptions:e.requestsOptions,login:e.login,contextid:e.contextid})},UWA.namespace("THREEDS/Utils",r)}),define("Visualization/Utils",["DS/Visualization/Utils","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Utils"),e}),define("DS/Visualization/UniformsUtils",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";return{merge:function(e){var t,i,r,n={};for(t=0;t<e.length;t++)for(i in r=this.clone(e[t]))n[i]=r[i];return n},mergeNoClone:function(e){var t,i,r,n={};for(t=0;t<e.length;t++)for(i in r=e[t])n[i]=r[i];return n},clone:function(t){var i,r,n,a={};for(i in t)for(r in a[i]={},t[i])(n=t[i][r])instanceof e.Color||n instanceof e.Vector2||n instanceof e.Vector3||n instanceof e.Vector4||n instanceof e.Matrix4?a[i][r]=n.clone():n instanceof Array?a[i][r]=n.slice():a[i][r]=n;return a}}}),define("DS/MaterialLibs/UniformsLib",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";return{common:{diffuse:{type:"c",value:new e.Color(16777215)},opacity:{type:"f",value:1},colorBufferType:{type:"f",value:0},map:{type:"t",value:null},mapHDRSize:{type:"v2",value:new e.Vector4(2048,1024)},offsetBumpMap:{type:"v2",value:new e.Vector4(0,0)},repeatBumpMap:{type:"v2",value:new e.Vector4(1,1)},specularMap:{type:"t",value:null},envMap:{type:"t",value:null},envMapExposureSpecular:{type:"f",value:1},envMapExposureDiffuse:{type:"f",value:1},envMapHDRSize:{type:"v2",value:new e.Vector4(2048,1024)},envMapHDRToMipsRatio:{type:"f",value:1},ambienceMatrix:{type:"m4",value:new e.Matrix4},flipEnvMap:{type:"f",value:1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:.98},refractionRatioMap:{type:"t",value:null},combine:{type:"i",value:0},reflectivityEnvMap:{type:"t",value:null},morphTargetInfluences:{type:"f",value:0},renderIteration:{type:"i",value:0},mappingType:{type:"i",value:0},mappingTransformSemantic:{type:"i",value:1},mappingNormTransformation:{type:"m3",value:new e.Matrix3},mappingObjTransformation:{type:"m4",value:new e.Matrix4},mappingUVTransformation:{type:"m3",value:new e.Matrix3}},bump:{bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1}},normalmap:{normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new e.Vector2(1,1)}},lights:{ambientLightColor:{type:"fv",value:[],sceneUniform:!0},directionalLightDirection:{type:"fv",value:[],sceneUniform:!0},directionalLightColor:{type:"fv",value:[],sceneUniform:!0},directionalIBLLightDirection:{type:"fv",value:[],sceneUniform:!0},directionalIBLLightColor:{type:"fv",value:[],sceneUniform:!0},directionalPhongLightDirection:{type:"fv",value:[],sceneUniform:!0},directionalPhongLightColor:{type:"fv",value:[],sceneUniform:!0},pointLightColor:{type:"fv",value:[],sceneUniform:!0},pointLightPosition:{type:"fv",value:[],sceneUniform:!0},pointLightPhysicalAttenuation:{type:"iv",value:[],sceneUniform:!0},pointLightDistance:{type:"fv1",value:[],sceneUniform:!0},spotLightColor:{type:"fv",value:[],sceneUniform:!0},spotLightPosition:{type:"fv",value:[],sceneUniform:!0},spotLightDirection:{type:"fv",value:[],sceneUniform:!0},spotLightPhysicalAttenuation:{type:"iv",value:[],sceneUniform:!0},spotLightDistance:{type:"fv1",value:[],sceneUniform:!0},spotLightAngleCos:{type:"fv1",value:[],sceneUniform:!0},spotLightInnerAngleCos:{type:"fv1",value:[],sceneUniform:!0},iesLightColor:{type:"fv",value:[],sceneUniform:!0},iesLightPosition:{type:"fv",value:[],sceneUniform:!0},iesLightDistance:{type:"fv1",value:[],sceneUniform:!0},iesLightTexture:{type:"tv",value:[],sceneUniform:!0},matrixWorldInv:{type:"m4v",value:[],sceneUniform:!0},sphereLightColor:{type:"fv",value:[],sceneUniform:!0},sphereLightPosition:{type:"fv",value:[],sceneUniform:!0},sphereLightData:{type:"fv",value:[],sceneUniform:!0},diskLightColor:{type:"fv",value:[],sceneUniform:!0},diskLightPosition:{type:"fv",value:[],sceneUniform:!0},diskLightData:{type:"fv",value:[],sceneUniform:!0},diskLightNormal:{type:"fv",value:[],sceneUniform:!0},diskLightUp:{type:"fv",value:[],sceneUniform:!0},tubeLightColor:{type:"fv",value:[],sceneUniform:!0},tubeLightPosition:{type:"fv",value:[],sceneUniform:!0},tubeLightData:{type:"fv",value:[],sceneUniform:!0},tubeLightRight:{type:"fv",value:[],sceneUniform:!0},areaLightColor:{type:"fv",value:[],sceneUniform:!0},areaLightPosition:{type:"fv",value:[],sceneUniform:!0},areaLightNormal:{type:"fv",value:[],sceneUniform:!0},areaLightUp:{type:"fv",value:[],sceneUniform:!0},areaLightData:{type:"fv",value:[],sceneUniform:!0},precomputedAreaGGX1texture:{type:"t",value:null,sceneUniform:!0},precomputedAreaGGX2texture:{type:"t",value:null,sceneUniform:!0},precomputedAreaAshikmintexture:{type:"t",value:null,sceneUniform:!0},precomputedAreaEsteveztexture:{type:"t",value:null,sceneUniform:!0},precomputedAreaBeckmanntexture:{type:"t",value:null,sceneUniform:!0}},clipPlanes:{nbClipPlanes:{type:"i",value:0,clipPlanesUniform:!0},clipPlaneEquations:{type:"fv4",value:[],clipPlanesUniform:!0,loadOnlyIfUniformNotZero:"nbClipPlanes"},clipPlaneActive:{type:"iv1",value:[],clipPlanesUniform:!0,loadOnlyIfUniformNotZero:"nbClipPlanes"},clipFrontOpacity:{type:"f",value:1,clipPlanesUniform:!0,loadOnlyIfUniformNotZero:"nbClipPlanes"},clipBackOpacity:{type:"f",value:0,clipPlanesUniform:!0,loadOnlyIfUniformNotZero:"nbClipPlanes"},polygonSize:{type:"iv1",value:[0],clipPlanesUniform:!0},polygonPoints:{type:"t",value:null,clipPlanesUniform:!0,loadOnlyIfUniformNotZero:"polygonSize"},extrusionPlaneU:{type:"fv3",value:[0,0,1],clipPlanesUniform:!0,loadOnlyIfUniformNotZero:"polygonSize"},extrusionPlaneV:{type:"fv3",value:[1,0,0],clipPlanesUniform:!0,loadOnlyIfUniformNotZero:"polygonSize"},cylinderClipZone:{type:"i",value:0,clipPlanesUniform:!0},cylinderCenter:{type:"v3",value:null,clipPlanesUniform:!0,loadOnlyIfUniformNotZero:"cylinderClipZone"},cylinderAxisU:{type:"v3",value:new e.Vector3(0,0,1),clipPlanesUniform:!0,loadOnlyIfUniformNotZero:"cylinderClipZone"},cylinderAxisV:{type:"v3",value:new e.Vector3(1,0,0),clipPlanesUniform:!0,loadOnlyIfUniformNotZero:"cylinderClipZone"},scissorSize:{type:"iv1",value:[],clipPlanesUniform:!0},scissorPoints:{type:"t",value:null,clipPlanesUniform:!0,loadOnlyIfUniformNotZero:"scissorSize"}},particle:{diffuse:{type:"c",value:new e.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null}},shadowmap:{shadowMap:{type:"tv",value:[],sceneUniform:!0},transparentShadowMap:{type:"tv",value:[],sceneUniform:!0},shadowMapSize:{type:"v2v",value:[],sceneUniform:!0},shadowBias:{type:"fv1",value:[],sceneUniform:!0},shadowDarkness:{type:"fv1",value:[],sceneUniform:!0},shadowMapNear:{type:"fv1",value:[],sceneUniform:!0},shadowMapFar:{type:"fv1",value:[],sceneUniform:!0},shadowMapCube:{type:"tcv",value:[],sceneUniform:!0},transparentShadowMapCube:{type:"tcv",value:[],sceneUniform:!0},shadowPointPosition:{type:"v3v",value:[],sceneUniform:!0},shadowNearCube:{type:"fv1",value:[],sceneUniform:!0},shadowFarCube:{type:"fv1",value:[],sceneUniform:!0},shadowMapSizeCube:{type:"fv1",value:[],sceneUniform:!0},shadowBiasCube:{type:"fv1",value:[],sceneUniform:!0},shadowDarknessCube:{type:"fv1",value:[],sceneUniform:!0},shadowMatrix:{type:"m4v",value:[],sceneUniform:!0},poissonDisk:{type:"v2v",value:[],sceneUniform:!0},shadowCameraPosition:{type:"fv",value:[],sceneUniform:!0},lowPartShadowCameraPosition:{type:"fv",value:[],sceneUniform:!0},directionalLightColorNoIntensity:{type:"fv",value:[],sceneUniform:!0},spotLightColorNoIntensity:{type:"fv",value:[],sceneUniform:!0},pointLightColorNoIntensity:{type:"fv",value:[],sceneUniform:!0}},lines:{scale:{type:"f",value:1},totalSize:{type:"f",value:0},halfWidth:{type:"f",value:.5},pixelSize:{type:"v2",value:new e.Vector2(.01,.01)},dashPattern:{type:"fv1",value:new Float32Array(2)},patternOffset:{type:"f",value:0}},postprocess:{brightness:{type:"f",value:0},crushblacks:{type:"f",value:0},burnhighlights:{type:"f",value:0},saturation:{type:"f",value:1},colorCorrection:{type:"v3",value:{x:1,y:1,z:1}}},deferred:{pickingColor:{type:"c",value:new e.Color(0)},rgbaDepth:{type:"t",value:null},highlightID:{type:"f",value:1},iHighlightColor:{type:"v4",value:new e.Vector4(0,.6,1,1)},iHighlightLineicColor:{type:"v4",value:new e.Vector4(0,1,1,1)},iHighlightIntensity:{type:"v2",value:new e.Vector2(1,-1)}}}}),define("DS/MaterialLibs/FiniteTransitionEnvMapLib",["DS/MaterialLibs/UniformsLib","DS/Shaders/DefaultShaders","DS/Visualization/ShaderChunk","DS/Visualization/UniformsUtils","DS/Mesh/ThreeJS_Base"],function(e,t,i,r,n){"use strict";return{uniforms:r.merge([e.postprocess,{tEnvMap:{type:"t",value:null},tEnvMap2:{type:"t",value:null},envMapHDRSize:{type:"v2",value:new n.Vector2(2048,1024)},envMapHDRSize2:{type:"v2",value:new n.Vector2(2048,1024)},invScreenSize:{type:"v2",value:new n.Vector2},tFlip:{type:"f",value:-1},ambienceMatrix:{type:"m4",value:new n.Matrix4},ambienceMatrix2:{type:"m4",value:new n.Matrix4},groundPosition:{type:"v3",value:new n.Vector3(0,0,0)},groundPosition2:{type:"v3",value:new n.Vector3(0,0,0)},groundRadius:{type:"f",value:5e3},groundRadius2:{type:"f",value:5e3},transitionCoef:{type:"f",value:0},groundScale:{type:"f",value:.78},groundScale2:{type:"f",value:.78},envMapExposure:{type:"f",value:1},envMapExposure2:{type:"f",value:1},ambient:{type:"c",value:new n.Color(16777215)}}]),vertexShader:["#define FINITE_TRANSITION","varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;",t.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#define FINITE_TRANSITION","#if defined( LATLONG_MAP ) ","uniform sampler2D tEnvMap;","uniform sampler2D tEnvMap2;","#else","uniform samplerCube tEnvMap;","uniform samplerCube tEnvMap2;","#endif","uniform float transitionCoef;","uniform float envMapExposure;","uniform float envMapExposure2;","uniform float tFlip;","uniform vec3 ambient;","uniform vec3 groundPosition;","uniform vec3 groundPosition2;","uniform float groundRadius;","uniform float groundRadius2;","uniform float groundScale;","uniform float groundScale2;","uniform vec2 invScreenSize;","uniform vec2 invScreenSize2;","uniform mat4 ambienceMatrix;","uniform mat4 ambienceMatrix2;","varying vec3 vWorldPosition;","const float PI = 3.14159;","const float INV_PI = 0.31830988618;","#if defined( HDR ) &&  !defined(HDR_FLOAT) ","uniform vec2 envMapHDRSize;","uniform vec2 envMapHDRSize2;",t.rgbe_sample_methods,"#endif","vec2 MapNormalToTextureCoordinate(vec3 iNormal) {","float phi = atan(iNormal.y, iNormal.x);","float theta = acos(iNormal.z);","vec2 reflectionUV = vec2(fract(0.5 + 0.5 * INV_PI * phi), 1.0 - INV_PI * theta);","return reflectionUV;","}","float IntersectPlane(vec3 iPos, vec3 iRay, vec3 iPlaneOrig, vec3 iPlaneNormal) {","float t = dot(iPlaneNormal, iPlaneOrig-iPos);","float cosNormalDir = dot(iPlaneNormal, iRay);","if (cosNormalDir==0.0) return 0.0;","t = t/cosNormalDir;","return t;","}","float IntersectSphereFar(vec3  iSphereCenter, float iSphereRadius, vec3 iRayDir, vec3  iRayOrig) {","   vec3 dist = iRayOrig - iSphereCenter;","   float B = 2.0*dot(iRayDir, dist);","   float C = dot(dist, dist) - iSphereRadius*iSphereRadius;","   float disc = B*B - 4.0*C;","   if (disc < 0.0)","       return -1.0;","   float t = (-B + sqrt(disc)) / 2.0;","   return t;","}",i.postprocess_pars_fragment,"vec3 getN(vec3 isphereCenter,float isphereRadius,vec3 inRay, vec3 iCameraPosition,vec3 iplaneNormal,vec3 igroundPos) {","vec3 rayDir      = inRay;","vec3 rayOrig     = iCameraPosition;","float t =  IntersectSphereFar(isphereCenter, isphereRadius, rayDir, rayOrig);","if (t>0.0) {","vec3 hitPos = rayOrig + t*rayDir;","vec3 sn = (hitPos - isphereCenter);","rayDir = normalize(sn);","}","return rayDir;","}","void main() {","vec3 inputRay = normalize(vWorldPosition - cameraPosition);","vec3 groundNor = vec3(0.0);","vec3 sphereCenter  = groundPosition;","vec3 sphereCenter2  = groundPosition2;","vec3 groundPos = vec3(0.0);","float sphereRadius  = groundRadius * groundScale;","float sphereRadius2  = groundRadius2 * groundScale2;","vec3 n = getN(sphereCenter,sphereRadius,inputRay,cameraPosition,groundNor,groundPos);","vec3 n2 = getN(sphereCenter2,sphereRadius2,inputRay,cameraPosition,groundNor,groundPos);","#if defined( LATLONG_MAP ) ","n = (ambienceMatrix * vec4(n, 0.0)).xyz;","n2 = (ambienceMatrix2 * vec4(n2, 0.0)).xyz;","#if defined( HDR )","#else","n.y *= -1.0;","n2.y *= -1.0;","#endif","vec2 coords = MapNormalToTextureCoordinate(n);","vec2 coords2 = MapNormalToTextureCoordinate(n2);","#if defined( HDR ) &&  !defined(HDR_FLOAT) ","vec2 texelSize = vec2(1.0 / envMapHDRSize);","vec2 texelSize2 = vec2(1.0 / envMapHDRSize2);","vec3 c1 = texture2DBilinearFromRGBE( tEnvMap, coords, envMapHDRSize, texelSize ).xyz;","vec3 c2 = texture2DBilinearFromRGBE( tEnvMap2, coords2, envMapHDRSize2, texelSize2 ).xyz;","gl_FragColor.xyz = c2*transitionCoef+c1*(1.0-transitionCoef);","#else","vec3 c1 = texture2D( tEnvMap, coords ).xyz;","vec3 c2 = texture2D( tEnvMap2, coords2 ).xyz;","gl_FragColor.xyz = c2*transitionCoef+c1*(1.0-transitionCoef);","#endif","#else","n = (ambienceMatrix * vec4(n, 0.0)).xyz;","gl_FragColor.xyz = textureCube(tEnvMap, vec3(n.x, -n.z,n.y)).xyz;","#endif","gl_FragColor.w = 1.0;","#if !defined( GAMMA_OUTPUT ) && defined( sRGB )","gl_FragColor.xyz = convertToLinear(gl_FragColor.xyz);","#endif","gl_FragColor.xyz *=envMapExposure;","gl_FragColor*= vec4(ambient, 1.0);",i.postprocess_fragment,"#if defined( GAMMA_OUTPUT ) && defined( HDR )",i.linear_to_gamma_fragment,"#endif","}"].join("\n")}}),define("DS/MaterialLibs/SimpleMapLib",["DS/MaterialLibs/UniformsLib","DS/Shaders/DefaultShaders","DS/Visualization/ShaderChunk","DS/Visualization/UniformsUtils","DS/Mesh/ThreeJS_Base"],function(e,t,i,r,n){"use strict";return{uniforms:r.merge([e.postprocess,{tEnvMap:{type:"t",value:null},envMapExposure:{type:"f",value:1},ambient:{type:"c",value:new n.Color(16777215)},backgroundColor:{type:"c",value:new n.Color(0)},backgroundAlpha:{type:"f",value:1},offset:{type:"v2",value:new n.Vector2(0,0)},invSize:{type:"v2",value:new n.Vector2(512,512)},envMapHDRSize:{type:"v2",value:new n.Vector2(2048,1024)}}]),vertexShader:["#define SIMPLEMAP","void main() {",t.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#define SIMPLEMAP","uniform sampler2D tEnvMap;","#if defined( ENVMAP2 ) ","uniform sampler2D tEnvMap2;","#endif","uniform vec3 ambient;","uniform vec3 backgroundColor;","uniform float backgroundAlpha;","uniform vec2 invSize;","uniform vec2 offset;","uniform float envMapExposure;","#if defined( HDR ) &&  !defined(HDR_FLOAT) ","uniform vec2 envMapHDRSize;",t.rgbe_sample_methods,"#endif",i.postprocess_pars_fragment,"void main() {","vec2 coord = (gl_FragCoord.xy - offset) * invSize;","vec4 color = vec4(0.0);","#if defined( HDR ) &&  !defined(HDR_FLOAT) ","coord.x = 1.0 - coord.x;","vec2 texelSize = vec2(1.0 / envMapHDRSize);","color = texture2DFromRGBE( tEnvMap, coord );","#else","color = texture2D( tEnvMap, coord );","#endif","#if defined( GAMMA_INPUT ) && defined( sRGB )","color.rgb = convertToLinear(color.rgb);","#endif","vec2 edge = step(vec2(0.0), coord) - step(vec2(1.0), coord);","color.rgb *= envMapExposure;","gl_FragColor = color * vec4(ambient, 1.0) * (edge.x * edge.y) + vec4(backgroundColor,backgroundAlpha) * (1.0 - (edge.x * edge.y)) ;",i.postprocess_fragment,i.linear_to_gamma_fragment,"}"].join("\n")}}),define("DS/MaterialLibs/GradientBackgroundLibs",["DS/MaterialLibs/UniformsLib","DS/Shaders/DefaultShaders","DS/Visualization/ShaderChunk","DS/Visualization/UniformsUtils"],function(e,t,i,r){"use strict";var n={colors:{type:"fv3",value:[]},YUp:{type:"i",value:0},ratio:{type:"f",value:1}};return{GradientBackgroundLib2:{uniforms:r.merge([e.postprocess,n]),vertexShader:["#define GRADIENT_BACKGROUND2","uniform vec3 colors[2];","uniform int YUp;","uniform float ratio;","varying vec3 vColor;","void main() {","if (YUp == 0){","vColor = mix(colors[0], colors[1], smoothstep(-1.0, 1.0, position.z));","} else {","vColor = mix(colors[0], colors[1], smoothstep(-1.0, 1.0, position.y));","}",t.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#define GRADIENT_BACKGROUND2","varying vec3 vColor;",i.postprocess_pars_fragment,"void main() {","gl_FragColor = vec4(vColor, 1.0);","gl_FragColor.xyz = convertToLinear(gl_FragColor.xyz);",i.postprocess_fragment,i.linear_to_gamma_fragment,"}"].join("\n")},GradientBackgroundLib3:{uniforms:r.merge([e.postprocess,n]),vertexShader:["#define GRADIENT_BACKGROUND3","uniform vec3 colors[3];","uniform int YUp;","varying vec3 vColor;","uniform float ratio;","void main() {","vec3 borderColor;","float a;","if (YUp == 0){","borderColor = mix(colors[2], colors[0], step(0.0, position.z));","a = sign(position.z) * position.z;","} else {","borderColor = mix(colors[2], colors[0], step(0.0, position.y));","a = sign(position.y) * position.y;","}","vColor = mix(colors[1], borderColor, a);",t.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#define GRADIENT_BACKGROUND3","varying vec3 vColor;",i.postprocess_pars_fragment,"void main() {","gl_FragColor = vec4(vColor, 1.0);","gl_FragColor.xyz = convertToLinear(gl_FragColor.xyz);",i.postprocess_fragment,i.linear_to_gamma_fragment,"}"].join("\n")},GradientBackgroundLib4:{uniforms:r.merge([e.postprocess,n,{horizonHeight:{type:"f",value:0},skylineFading:{type:"f",value:0}}]),vertexShader:["#define GRADIENT_BACKGROUND4","uniform int YUp;","varying float vPositionZ;","uniform float ratio;","void main() {","if (YUp == 0){","vPositionZ = position.z;","} else {","vPositionZ = position.y;","}",t.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#define GRADIENT_BACKGROUND4","uniform vec3 colors[4];","uniform float horizonHeight;","uniform float skylineFading;","varying float vPositionZ;",i.postprocess_pars_fragment,"void main() {","float positionSign = step(horizonHeight, vPositionZ);","vec3 centerColor = positionSign * colors[1] + ((1.0 - positionSign) * colors[3]);","vec3 borderColor = positionSign * colors[0] + ((1.0 - positionSign) * colors[2]);","float minHeight = positionSign * horizonHeight + ((1.0 - positionSign) * -1.0);","float maxHeight = positionSign + ((1.0 - positionSign) * horizonHeight);","vec3 color = mix(centerColor, borderColor, smoothstep(minHeight, maxHeight, vPositionZ));","if ((skylineFading > 0.0) && (positionSign == 1.0)) {"," color = vec3(smoothstep(horizonHeight, horizonHeight + skylineFading, vPositionZ));"," }","gl_FragColor = vec4(color, 1.0);","gl_FragColor.xyz = convertToLinear(gl_FragColor.xyz);",i.postprocess_fragment,i.linear_to_gamma_fragment,"}"].join("\n")}}}),define("DS/MaterialLibs/CubeMapLib",["DS/MaterialLibs/UniformsLib","DS/Shaders/DefaultShaders","DS/Visualization/ShaderChunk","DS/Visualization/UniformsUtils","DS/Mesh/ThreeJS_Base"],function(e,t,i,r,n){"use strict";return{uniforms:r.merge([{tEnvMap:{type:"t",value:null},tFlip:{type:"f",value:-1},envMapExposure:{type:"f",value:1},ambienceMatrix:{type:"m4",value:new n.Matrix4},ambient:{type:"c",value:new n.Color(16777215)}}]),vertexShader:["#define CUBEMAP","varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;",t.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#define CUBEMAP","uniform samplerCube tEnvMap;","uniform float tFlip;","uniform vec3 ambient;","uniform float envMapExposure;","uniform mat4 ambienceMatrix;","varying vec3 vWorldPosition;","void main() {","vec3 relPos = vWorldPosition - cameraPosition;","relPos = (ambienceMatrix * vec4(relPos,0.0)).xyz;","#if defined(CUBEMAP_ZUP)","gl_FragColor = vec4(ambient, 1.0) * textureCube( tEnvMap, vec3( -relPos.x, relPos.zy ) );","#else","gl_FragColor = vec4(ambient, 1.0) * textureCube( tEnvMap, vec3( relPos.x, -relPos.z, relPos.y ) );","#endif","}"].join("\n")}}),define("DS/MaterialLibs/LatLongMapLib",["DS/MaterialLibs/UniformsLib","DS/Shaders/DefaultShaders","DS/Visualization/ShaderChunk","DS/Visualization/UniformsUtils","DS/Mesh/ThreeJS_Base"],function(e,t,i,r,n){"use strict";return{uniforms:r.merge([e.postprocess,{tEnvMap:{type:"t",value:null},tEnvMap2:{type:"t",value:null},envMapHDRSize:{type:"v2",value:new n.Vector4(2048,1024)},envMapHDRToMipsRatio:{type:"f",value:1},invScreenSize:{type:"v2",value:new n.Vector2},cameraSight:{type:"v3",value:new n.Vector3},cameraUp:{type:"v3",value:new n.Vector3},cameraRight:{type:"v3",value:new n.Vector3},startOffset:{type:"v2",value:new n.Vector2(0,0)},endOffset:{type:"v2",value:new n.Vector2(1,1)},ambienceMatrix:{type:"m4",value:new n.Matrix4},blurCoef:{type:"f",value:0},envMapExposure:{type:"f",value:1},ambient:{type:"c",value:new n.Color(16777215)},planeColor:{type:"c",value:new n.Color(16777215)},withPlane:{type:"f",value:0}}]),vertexShader:["#define LATLONGMAP","void main() {",t.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#define LATLONGMAP","uniform sampler2D tEnvMap;","#if defined( ENVMAP2 ) ","uniform sampler2D tEnvMap2;","#endif","uniform mat4 ambienceMatrix;","uniform float blurCoef;","uniform float envMapExposure;","uniform vec3 ambient;","uniform vec3 planeColor;","uniform float withPlane;","uniform vec2 invScreenSize;","uniform vec3 cameraSight;","uniform vec3 cameraUp;","uniform vec3 cameraRight;","uniform vec2 startOffset;","uniform vec2 endOffset;","const float INV_PI = 0.31830988618379;","const float PI = 3.14159265359;","#if defined( HDR ) &&  !defined(HDR_FLOAT) ","uniform vec2 envMapHDRSize;","uniform float envMapHDRToMipsRatio;",t.rgbe_sample_methods,"vec4 sampleMipMapRoughness(vec2 uv, float mip, float coef, sampler2D map0, sampler2D map1, vec2 textureSize, vec2 texelSize) {","vec4 color1;","vec4 color2;","vec2 uv1;","vec2 uv2;","if (mip < 1.0) {","color1 = texture2DBilinearFromRGBE(map0, uv, textureSize, texelSize);","} else {","textureSize *= envMapHDRToMipsRatio * vec2(1.0,2.0);","texelSize /= envMapHDRToMipsRatio * vec2(1.0,2.0);","float level1 = clamp(floor(mip) - 1.0, 0.0, 4.0);","float t10 = pow(2.0, -floor(log2(level1 + 1.0)));","float t11 = 2.0 - (level1 + 2.0) * t10;","float t12 = 0.5 * t10;","uv1 = vec2(t11 + 1.5 * texelSize.x + (2.0 * t12 - 3.0 * texelSize.x) * uv.x, t12 + 1.5 * texelSize.x + (t12 - 3.0 * texelSize.x) * uv.y);","color1 = texture2DBilinearFromRGBE(map1, uv1, textureSize, texelSize);","}","float level2 = clamp(floor(mip), 0.0, 5.0);","float t20 = pow(2.0, -floor(log2(level2 + 1.0)));","float t21 = 2.0 - (level2 + 2.0) * t20;","float t22 = 0.5 * t20;","uv2 = vec2(t21 + 1.5 * texelSize.x + (2.0 * t22 - 3.0 * texelSize.x) * uv.x, t22 + 1.5 * texelSize.x + (t22 - 3.0 * texelSize.x) * uv.y);","color2 = texture2DBilinearFromRGBE(map1, uv2, textureSize, texelSize);","return mix(color1, color2, coef);","}","#endif",i.postprocess_pars_fragment,"void main() {","vec2 screenOffset = 2.0 * mix(startOffset, endOffset, gl_FragCoord.xy * invScreenSize) - 1.0;","vec3 dir = normalize(cameraSight + screenOffset.x * cameraRight + screenOffset.y * cameraUp);","dir = (ambienceMatrix * vec4(dir,0.0)).xyz;","#if defined( HDR ) && !defined(HDR_FLOAT) ","#else","dir.y *= -1.0;","#endif","float phi = atan(dir.y, dir.x);","float theta = acos(dir.z);","vec2 texelCoord = vec2(fract(0.5 + 0.5 * INV_PI * phi), 1.0 - INV_PI * theta);","float plane = step(texelCoord.y, 0.5) * withPlane;","vec3 planeColor2 = convertToLinear(planeColor.xyz) ;","gl_FragColor.w = 1.0 + plane * 0.4;","#if defined( HDR ) &&  !defined(HDR_FLOAT) ","vec2 texelSize = vec2(1.0 / envMapHDRSize);","#if defined( ENVMAP2 )","float mipValue = max(6.0 + 1.15 * log2(blurCoef + 0.0000001), 0.0);","float mipCoef = fract(mipValue);","if (mipValue > 6.0) {","mipValue = 6.0;","mipCoef = 1.0;","}","gl_FragColor.xyz = ((sampleMipMapRoughness( texelCoord, mipValue, mipCoef, tEnvMap, tEnvMap2, envMapHDRSize, texelSize ).xyz) * (1.0 -plane)) + (plane * planeColor2);","#else","gl_FragColor.xyz = ((texture2DBilinearFromRGBE( tEnvMap, texelCoord, envMapHDRSize, texelSize ).xyz) * (1.0 -plane)) + (plane * planeColor2);","#endif","#else","gl_FragColor.xyz = ((texture2D( tEnvMap, texelCoord ).xyz) * (1.0 -plane)) + (plane * planeColor2);","#endif","#if !defined( GAMMA_OUTPUT ) && defined( sRGB )","gl_FragColor.xyz = convertToLinear(gl_FragColor.xyz);","#endif","gl_FragColor.xyz *=envMapExposure;","gl_FragColor*= vec4(ambient, 1.0);",i.postprocess_fragment,"#if defined( GAMMA_OUTPUT ) && defined( HDR )",i.linear_to_gamma_fragment,"#endif","}"].join("\n")}}),define("DS/MaterialLibs/FiniteEnvMapLib",["DS/MaterialLibs/UniformsLib","DS/Shaders/DefaultShaders","DS/Visualization/ShaderChunk","DS/Visualization/UniformsUtils","DS/Mesh/ThreeJS_Base"],function(e,t,i,r,n){"use strict";return{uniforms:r.merge([e.postprocess,{tEnvMap:{type:"t",value:null},tEnvMap2:{type:"t",value:null},envMapHDRSize:{type:"v2",value:new n.Vector2(2048,1024)},envMapHDRToMipsRatio:{type:"f",value:1},cameraSight:{type:"v3",value:new n.Vector3},cameraUp:{type:"v3",value:new n.Vector3},cameraRight:{type:"v3",value:new n.Vector3},startOffset:{type:"v2",value:new n.Vector2(0,0)},endOffset:{type:"v2",value:new n.Vector2(1,1)},invScreenSize:{type:"v2",value:new n.Vector2},tFlip:{type:"f",value:-1},ambienceMatrix:{type:"m4",value:new n.Matrix4},groundPosition:{type:"v3",value:new n.Vector3(0,0,0)},groundNormal:{type:"v3",value:new n.Vector3(0,0,1)},sceneHeight:{type:"v3",value:new n.Vector3(0,0,.15)},groundHeight:{type:"v3",value:new n.Vector3(0,0,.23)},groundOffset:{type:"f",value:0},groundRadius:{type:"f",value:5e3},blurCoef:{type:"f",value:0},withGround:{type:"f",value:0},groundScale:{type:"f",value:.78},intensity:{type:"f",value:1},envMapExposure:{type:"f",value:1},ambient:{type:"c",value:new n.Color(16777215)},near:{type:"f",value:1},right:{type:"f",value:1},up:{type:"f",value:1},projectionConic:{type:"f",value:1}}]),vertexShader:["#define FINITEENVMAP","varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;",t.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#define FINITEENVMAP","#if defined( LATLONG_MAP ) ","uniform sampler2D tEnvMap;","#else","uniform samplerCube tEnvMap;","#endif","#if defined( ENVMAP2 ) ","uniform sampler2D tEnvMap2;","#endif","uniform float blurCoef;","uniform float withGround;","uniform float envMapExposure;","uniform float tFlip;","uniform vec3 ambient;","uniform vec3 groundPosition;","uniform vec3 groundNormal;","uniform vec3 sceneHeight;","uniform vec3 groundHeight;","uniform float groundOffset;","uniform float groundRadius;","uniform float groundScale;","uniform float intensity;","uniform vec2 invScreenSize;","uniform vec3 cameraSight;","uniform vec3 cameraUp;","uniform vec3 cameraRight;","uniform float near;","uniform float right;","uniform float up;","uniform vec2 startOffset;","uniform vec2 endOffset;","uniform mat4 ambienceMatrix;","uniform float projectionConic;","varying vec3 vWorldPosition;","const float PI = 3.14159;","const float INV_PI = 0.31830988618;","#if defined( HDR ) &&  !defined(HDR_FLOAT) ","uniform vec2 envMapHDRSize;","uniform float envMapHDRToMipsRatio;",t.rgbe_sample_methods,"vec4 sampleMipMapRoughness(vec2 uv, float mip, float coef, sampler2D map0, sampler2D map1, vec2 textureSize, vec2 texelSize) {","vec4 color1;","vec4 color2;","vec2 uv1;","vec2 uv2;","if (mip < 1.0) {","color1 = texture2DBilinearFromRGBE(map0, uv, textureSize, texelSize);","} else {","textureSize *= envMapHDRToMipsRatio * vec2(1.0,2.0);","texelSize /= envMapHDRToMipsRatio * vec2(1.0,2.0);","float level1 = clamp(floor(mip) - 1.0, 0.0, 4.0);","float t10 = pow(2.0, -floor(log2(level1 + 1.0)));","float t11 = 2.0 - (level1 + 2.0) * t10;","float t12 = 0.5 * t10;","uv1 = vec2(t11 + 1.5 * texelSize.x + (2.0 * t12 - 3.0 * texelSize.x) * uv.x, t12 + 1.5 * texelSize.x + (t12 - 3.0 * texelSize.x) * uv.y);","color1 = texture2DBilinearFromRGBE(map1, uv1, textureSize, texelSize);","}","float level2 = clamp(floor(mip), 0.0, 5.0);","float t20 = pow(2.0, -floor(log2(level2 + 1.0)));","float t21 = 2.0 - (level2 + 2.0) * t20;","float t22 = 0.5 * t20;","uv2 = vec2(t21 + 1.5 * texelSize.x + (2.0 * t22 - 3.0 * texelSize.x) * uv.x, t22 + 1.5 * texelSize.x + (t22 - 3.0 * texelSize.x) * uv.y);","color2 = texture2DBilinearFromRGBE(map1, uv2, textureSize, texelSize);","return mix(color1, color2, coef);","}","#endif","vec2 MapNormalToTextureCoordinate(vec3 iNormal) {","float phi = atan(iNormal.y, iNormal.x);","float theta = acos(iNormal.z);","vec2 reflectionUV = vec2(fract(0.5 + 0.5 * INV_PI * phi), 1.0 - INV_PI * theta);","return reflectionUV;","}","float IntersectPlane(vec3 iPos, vec3 iRay, vec3 iPlaneOrig, vec3 iPlaneNormal) {","float t = dot(iPlaneNormal, iPlaneOrig-iPos);","float cosNormalDir = dot(iPlaneNormal, iRay);","if (cosNormalDir==0.0) return 0.0;","t = t/cosNormalDir;","return t;","}","float IntersectSphereFar(vec3  iSphereCenter, float iSphereRadius, vec3 iRayDir, vec3  iRayOrig) {","   vec3 dist = iRayOrig - iSphereCenter;","   float B = 2.0*dot(iRayDir, dist);","   float C = dot(dist, dist) - iSphereRadius*iSphereRadius;","   float disc = B*B - 4.0*C;","   if (disc < 0.0)","       return -1.0;","   float t = (-B + sqrt(disc)) / 2.0;","   return t;","}",i.postprocess_pars_fragment,"void main() {","vec3 n = normalize(vWorldPosition - cameraPosition);","vec3 groundPos = (ambienceMatrix * vec4(groundPosition, 1.0)).xyz;","vec3 groundNor = (ambienceMatrix * vec4(groundNormal, 0.0)).xyz;","vec3  sphereCenter  = groundPos + groundNor * sceneHeight * groundRadius;","vec3  offset  = vec3(0.0,0.0,groundOffset);","offset = (ambienceMatrix * vec4(offset, 0.0)).xyz;","#if defined( AMBIENCE_V2 ) ","groundNor = groundNormal;","sphereCenter  = groundPosition +  sceneHeight * groundRadius;","offset = groundOffset * groundNor;","groundPos = groundPosition + offset;","#endif","float sphereRadius  = groundRadius * groundScale;","vec3  rayDir      = vec3(0.0);","vec3  rayOrig     = vec3(0.0);","if (sphereRadius > 0.0) {","if (projectionConic > 0.0 ) { ","rayDir      = n;","rayOrig     = cameraPosition;","}else{","vec2 screenOffset = 2.0 * mix(startOffset, endOffset, gl_FragCoord.xy * invScreenSize) - 1.0;","vec3 centerPosition = cameraPosition - (cameraSight * near);","n = normalize(cameraSight + screenOffset.x * cameraRight + screenOffset.y * cameraUp);","rayOrig = centerPosition + screenOffset.x * (cameraRight*right) + screenOffset.y * (cameraUp * up);","rayDir = cameraSight;","}","float t =  IntersectSphereFar(sphereCenter, sphereRadius, rayDir, rayOrig);","vec3  planeNormal = groundNor;","if (t>0.0) {","if (dot(planeNormal, rayDir)<0.0){","#if defined( AMBIENCE_V2 ) ","float planeT  = IntersectPlane(rayOrig, rayDir, groundPos, planeNormal);","#else","float planeT  = IntersectPlane(rayOrig, rayDir, groundPos + offset, planeNormal);","#endif","planeT = planeT * withGround;","if (projectionConic > 0.0 ) { ","t = (planeT>0.0) ? min(planeT,t) : t;","}else{","t =  min(planeT,t);","}","}","vec3 hitPos = rayOrig + t*rayDir;","#if defined( AMBIENCE_V2 ) ","vec3 projectionCenter = groundPosition + groundHeight * sphereRadius; ","#else","vec3 projectionCenter = groundPos + offset ; ","projectionCenter += groundNor * groundHeight*groundRadius;","#endif","vec3 sn = (hitPos - projectionCenter);","n = normalize(sn);","}","}","#if defined( LATLONG_MAP ) ","n = (ambienceMatrix * vec4(n, 0.0)).xyz;","#if defined( HDR )","#else","n.y *= -1.0;","#endif","vec2 coords = MapNormalToTextureCoordinate(n);","#if defined( HDR ) &&  !defined(HDR_FLOAT) ","vec2 texelSize = vec2(1.0 / envMapHDRSize);","#if defined( ENVMAP2 )","float mipValue = max(6.0 + 1.15 * log2(blurCoef + 0.0000001), 0.0);","float mipCoef = fract(mipValue);","if (mipValue > 6.0) {","mipValue = 6.0;","mipCoef = 1.0;","}","gl_FragColor.xyz =  sampleMipMapRoughness( coords, mipValue, mipCoef, tEnvMap, tEnvMap2, envMapHDRSize, texelSize ).xyz;","#else","gl_FragColor.xyz = texture2DBilinearFromRGBE( tEnvMap, coords, envMapHDRSize, texelSize ).xyz;","#endif","#else","gl_FragColor.xyz = texture2D( tEnvMap, coords ).xyz;","#endif","#else","n = (ambienceMatrix * vec4(n, 0.0)).xyz;","gl_FragColor.xyz = textureCube(tEnvMap, vec3(n.x, -n.z,n.y)).xyz;","#endif","gl_FragColor.w = 1.0;","#if !defined( GAMMA_OUTPUT ) && defined( sRGB )","gl_FragColor.xyz = convertToLinear(gl_FragColor.xyz);","#endif","gl_FragColor.xyz *=envMapExposure;","gl_FragColor*= vec4(ambient, 1.0);",i.postprocess_fragment,"#if defined( GAMMA_OUTPUT ) && defined( HDR )",i.linear_to_gamma_fragment,"#endif","}"].join("\n")}}),define("DS/Materials/DeferredCaches",["DS/Mesh/ThreeJS_Base","WebappsUtils/WebappsUtils"],function(e,t){"use strict";var i=new Map,r=new Map,n=new Map,a=new Map,s=new Map,o=new Map,l=new Map,c=t.getWebappsAssetUrl("Visualization","")+"textures/predefinedMaterials/",h=[],u=function(e){this.material=e,this.usedBy=new Set};u.prototype.get=function(e){return this.usedBy.add(e.id),this.material};return{_loadPredefinedMaterialTextures:function(t,i,r){if(h.length>0||r)return h;h.push(e.ImageUtils.loadBasisTexture(c+"Appearance_Brass_Albedo.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),h.push(e.ImageUtils.loadBasisTexture(c+"Appearance_Brass_roughness.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),h.push(e.ImageUtils.loadBasisTexture(c+"Appearance_BrushedSteel_Albedo.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),h.push(e.ImageUtils.loadBasisTexture(c+"Appearance_BrushedSteel_Anisotropy.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),h.push(e.ImageUtils.loadTexture(c+"Appearance_BrushedSteel_Normal.png",void 0,i,null,!0,!1,t)),h.push(e.ImageUtils.loadBasisTexture(c+"Appearance_BrushedSteel_Roughness.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),h.push(e.ImageUtils.loadBasisTexture(c+"Appearance_CastAluminum_Albedo.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),h.push(e.ImageUtils.loadTexture(c+"Appearance_CastAluminum_Normal.png",void 0,i,null,!0,!1,t)),h.push(e.ImageUtils.loadBasisTexture(c+"Appearance_CastAluminum_Roughness.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),h.push(e.ImageUtils.loadBasisTexture(c+"Appearance_CastSteel_Albedo.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),h.push(e.ImageUtils.loadBasisTexture(c+"Appearance_CastSteel_Roughness.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),h.push(e.ImageUtils.loadBasisTexture(c+"Appearance_Copper_Albedo.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),h.push(e.ImageUtils.loadTexture(c+"Appearance_Copper_Normal.png",void 0,i,null,!0,!1,t)),h.push(e.ImageUtils.loadBasisTexture(c+"Appearance_Copper_Roughness.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),h.push(e.ImageUtils.loadBasisTexture(c+"Appearance_MachinedAluminum_Albedo.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),h.push(e.ImageUtils.loadTexture(c+"Appearance_MachinedAluminum_Normal.png",void 0,i,null,!0,!1,t)),h.push(e.ImageUtils.loadBasisTexture(c+"Appearance_MachinedAluminum_Roughness.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),h.push(e.ImageUtils.loadBasisTexture(c+"Appearance_MachinedStainlessSteel_Albedo.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),h.push(e.ImageUtils.loadTexture(c+"Appearance_MachinedStainlessSteel_Normal.png",void 0,i,null,!0,!1,t)),h.push(e.ImageUtils.loadBasisTexture(c+"Appearance_MachinedStainlessSteel_Roughness.basis",void 0,i,null,!0,e.BasisUsage.RGB,t));for(var n=0;n<h.length;n++)h[n].wrapS=e.RepeatWrapping,h[n].wrapT=e.RepeatWrapping,h[n].flipY=!1;return h},DeferredMaterial:u,DefaultNormalDepthMaterials:i,DefaultShadowDepthMaterials:r,DefaultPickingMaterials:n,DefaultHighlightMaterials:a,DefaultMaterials:s,PredefinedMaterials:o,GeomTypeMaterials:l}}),define("DS/Materials/PDSFXData",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t=[/(\W+)modelViewMatrix(\W+)/,/(\W+)viewMatrix(\W+)/,/(\W+)projectionMatrix(\W+)/],i=["modelViewMatrix","viewMatrix","projectionMatrix"],r=["vGetWorldViewMatrix()","vGetViewMatrix()","vGetProjectionMatrix()"],n=function(e){for(var n=i.length,a="",s=0;s<n;s++){e.search(t[s])>=0&&(a||(a=['BAD PDSFX USAGE!!!: DO NOT USE THE "'+i[s]+'" token in your overridden function!',"This is henceforth an internal PRIVATE variable. Use the following appropriate PDSFX getter function: "+r[s],"Please take time to correct your PDSFX materials by using the getters/setters provided by the API."].join("\n")),console.warn(a))}},a=function(){this.PDSFX=!1,this.PDSFX_OverridableFunctions_VS={},this.PDSFX_OverridableFunctions_FS={},this.pdsfxUniformsCode={common:"",vertex:"",fragment:""},this.pdsfxUniforms=null,this._pdsfxUniformsList=null,this.pdsfxVaryingsCode="",this.pdsfxGlobalVariablesCode_VS="",this.pdsfxGlobalVariablesCode_FS="",this.pdsfxAttributesCode="",this.PDSFX_hasAlbedo=!1,this.PDSFX_hasOpacity=!1,this.PDSFX_hasHalfWidth=!1,this.PDSFX_hasEmissive=!1,this.PDSFX_hasSpecular=!1,this.pdsfxUseMap=!1,this.CPULargeScale=!1};return a.prototype.clone=function(){var t=new a;return t.PDSFX=!0,t.PDSFX_OverridableFunctions_VS=this.PDSFX_OverridableFunctions_VS,t.PDSFX_OverridableFunctions_FS=this.PDSFX_OverridableFunctions_FS,this.pdsfxUniformsCode&&(t.pdsfxUniformsCode=this.pdsfxUniformsCode),this.pdsfxUniforms&&(t.pdsfxUniforms=e.UniformsUtils.clone(this.pdsfxUniforms)),this.pdsfxVaryingsCode&&(t.pdsfxVaryingsCode=this.pdsfxVaryingsCode),this.pdsfxGlobalVariablesCode_VS&&(t.pdsfxGlobalVariablesCode_VS=this.pdsfxGlobalVariablesCode_VS),this.pdsfxGlobalVariablesCode_FS&&(t.pdsfxGlobalVariablesCode_FS=this.pdsfxGlobalVariablesCode_FS),this.pdsfxAttributesCode&&(t.pdsfxAttributesCode=this.pdsfxAttributesCode),this.PDSFX_hasAlbedo&&(t.PDSFX_hasAlbedo=!0),this.PDSFX_hasOpacity&&(t.PDSFX_hasOpacity=!0),this.PDSFX_hasHalfWidth&&(t.PDSFX_hasHalfWidth=!0),this.PDSFX_hasEmissive&&(t.PDSFX_hasEmissive=!0),this.PDSFX_hasSpecular&&(t.PDSFX_hasSpecular=!0),this.pdsfxUseMap&&(t.pdsfxUseMap=!0),t.CPULargeScale=this.CPULargeScale,t._setUniformsList(),t},a.prototype._setUniformsList=function(){if(this.pdsfxUniforms)for(var e in this._pdsfxUniformsList=new Map,this.pdsfxUniforms)this._pdsfxUniformsList.set(e,this.pdsfxUniforms[e])},a.prototype._setPDSFXOverridableFunctions=function(e,t){var i;for(i in e)this.PDSFX_OverridableFunctions_VS[i]&&e[i]&&(n(e[i]),this.PDSFX_OverridableFunctions_VS[i]=e[i]);for(i in t)this.PDSFX_OverridableFunctions_FS[i]&&t[i]&&(n(t[i]),this.PDSFX_OverridableFunctions_FS[i]=t[i])},a}),define("DS/Shaders/DeferrableShaders",["DS/Shaders/DefaultShaders"],function(e){"use strict";return{picking_pars_vertex:"\n        #ifdef PICKING_MATERIAL\n          #ifdef SPECIAL_PICKING_INSTANCING\n            varying vec3 pickingColor;\n          #endif\n        #endif\n        ",picking_vertex:"\n        #ifdef PICKING_MATERIAL\n          #ifdef SPECIAL_PICKING_INSTANCING\n            pickingColor = specialMeshPicking;\n          #endif\n        #endif\n        ",picking_pars_fragment:"\n        #ifdef PICKING_MATERIAL\n          #ifdef SPECIAL_PICKING_INSTANCING\n            varying vec3 pickingColor;\n          #else\n            uniform vec3 pickingColor;\n          #endif\n        #endif\n        ",picking_fragment:"\n        #ifdef PICKING_MATERIAL\n          gl_FragColor = vec4( pickingColor, 1.0 );\n        #endif\n        ",picking_instancing_pars_vertex:"\n        #ifdef PICKING_INSTANCING_MATERIAL\n          varying vec3 vInstancePickingColor;\n        #endif\n        ",picking_instancing_vertex:"\n        #ifdef PICKING_INSTANCING_MATERIAL\n          if (instanceId > 16777215.0) vInstancePickingColor = vec3(0.0);\n          else {\n            vInstancePickingColor.r = floor(instanceId / 65536.0);\n            vInstancePickingColor.g = floor((instanceId - vInstancePickingColor.r * 65536.0) / 256.0);\n            vInstancePickingColor.b = floor(instanceId - vInstancePickingColor.r * 65536.0 - vInstancePickingColor.g * 256.0);\n            vInstancePickingColor /= 255.0;\n          }\n        #endif\n        ",picking_instancing_pars_fragment:"\n        #ifdef PICKING_INSTANCING_MATERIAL\n          varying vec3 vInstancePickingColor;\n        #endif\n        ",picking_instancing_fragment:"\n        #ifdef PICKING_INSTANCING_MATERIAL\n          gl_FragColor = vec4(vInstancePickingColor, 1.0);\n        #endif\n        ",depth_pars_vertex:"\t\n        #if defined(DEPTH_MATERIAL) || defined(DEPTH_RGBA_MATERIAL) || defined(NORMAL_DEPTH_MATERIAL) || defined(NORMAL_DEPTH_IOR_ROUGHNESS_MATERIAL) || defined(DECAL_NORMAL_STENCIL_DEPTH_MATERIAL)\t\n          #if !defined(DECAL) && !defined PDSFX\n            varying vec4 DS_clipPosition;\n          #endif\n        #endif\n        ",depth_vertex:"\n        #if defined(DEPTH_MATERIAL) || defined(DEPTH_RGBA_MATERIAL) || defined(NORMAL_DEPTH_MATERIAL) || defined(NORMAL_DEPTH_IOR_ROUGHNESS_MATERIAL) || defined(DECAL_NORMAL_STENCIL_DEPTH_MATERIAL)\t\n          #if !defined(DECAL) && !defined PDSFX\n            DS_clipPosition = gl_Position;\n          #endif\n        #endif\n        ",depth_pars_fragment:"\n        #if defined(DEPTH_MATERIAL) || defined(DEPTH_RGBA_MATERIAL) || defined(NORMAL_DEPTH_MATERIAL) || defined(NORMAL_DEPTH_IOR_ROUGHNESS_MATERIAL) || defined(DECAL_NORMAL_STENCIL_DEPTH_MATERIAL)\t\n          #if !defined(DECAL) && !defined PDSFX\n            varying vec4 DS_clipPosition;\n          #endif\n        #endif\n        #if defined(DEPTH_MATERIAL) || defined(DEPTH_RGBA_MATERIAL)\n            float shift_right(float v, float amt) {\n              v = floor(v) + 0.5;\n              return floor(v / exp2(amt));\n                }\n\n                float shift_left(float v, float amt) {\n              return floor(v * exp2(amt) + 0.5);\n                }\n            float mask_last(float v, float bits) {\n              return mod(v, shift_left(1.0, bits));\n            }\n            float extract_bits(float num, float from, float to) {\n              from = floor(from + 0.5);\n              to = floor(to + 0.5);\n              return mask_last(shift_right(num, from), to - from);\n            }\n            vec4 encode_float(float val) {\n              if (val == 0.0)\n                return vec4(0, 0, 0, 0);\n              float sign = val > 0.0 ? 0.0 : 1.0;\n                  val = abs(val);\n                  float exponent = floor(log2(val));\n                  float biased_exponent = exponent + 127.0;\n                  float fraction = ((val / exp2(exponent)) - 1.0) * 8388608.0;\n              float t = biased_exponent / 2.0;\n                  float last_bit_of_biased_exponent = fract(t) * 2.0;\n                  float remaining_bits_of_biased_exponent = floor(t);\n              float byte4 = extract_bits(fraction, 0.0, 8.0) / 255.0;\n                  float byte3 = extract_bits(fraction, 8.0, 16.0) / 255.0;\n                  float byte2 = (last_bit_of_biased_exponent * 128.0 + extract_bits(fraction, 16.0, 23.0)) / 255.0;\n                  float byte1 = (sign * 128.0 + remaining_bits_of_biased_exponent) / 255.0;\n                  return vec4(byte4, byte3, byte2, byte1);\n              }\n\n            vec4 packRGBAFace( const in float depth ) {\n              float depthToUse = depth;\n              #if defined(GL_OES_standard_derivatives) || defined(GLSL300ES)\n                float dx = dFdx(depth);\n                float dy = dFdy(depth);\n                depthToUse += sqrt(dx*dx + dy*dy) + DEPTH_PRECISION;\n              #else\n                depthToUse += 2.0 *DEPTH_PRECISION;\n              #endif\n              return packRGBA(depthToUse);\n            }\n        #endif\n        ",depth_fragment_face:"\n        #if defined(DEPTH_MATERIAL) || defined(DEPTH_RGBA_MATERIAL)\n          #ifdef DECAL\n            #ifdef DEPTH_RGBA_MATERIAL\n              vec4 encode = packRGBAFace(gl_FragDepthEXT);\n            #else\n              vec4 encode = encode_float(gl_FragDepthEXT);\n            #endif\n          #else\n            #ifdef PDSFX\n              float depthValue = 0.5 + 0.5 * _DSclipPosition.z / _DSclipPosition.w;\n            #else\n              float depthValue = 0.5 + 0.5 * DS_clipPosition.z / DS_clipPosition.w;\n            #endif\n            #ifdef DEPTH_RGBA_MATERIAL\n              vec4 encode = packRGBAFace(depthValue);\n            #else\n              vec4 encode = encode_float(depthValue);\n            #endif\n          #endif\n          gl_FragColor = encode;\n        #endif\n        ",depth_fragment:"\n        #if defined(DEPTH_MATERIAL) || defined(DEPTH_RGBA_MATERIAL)\n          #ifdef PDSFX\n            float depthValue = 0.5 + 0.5 * _DSclipPosition.z / _DSclipPosition.w;\n          #else\n            float depthValue = 0.5 + 0.5 * DS_clipPosition.z / DS_clipPosition.w;\n          #endif\n          #ifdef DEPTH_RGBA_MATERIAL\n            vec4 encode = packRGBA(depthValue);\n          #else\n            vec4 encode = encode_float(depthValue);\n          #endif\n          gl_FragColor = encode;\n        #endif\n        ",normal_fragment:"\n        #if defined(NORMAL_MATERIAL)\n          gl_FragColor.xyz = normal * 0.5 + 0.5;\n        #endif\n        ",lineic_normal_fragment:"\n        #if defined(NORMAL_MATERIAL)         \n          gl_FragColor.xyz = vec3(0.5);\n        #endif\n        ",decal_normal_depth_pars_fragment:"\n        #ifdef DECAL_NORMAL_STENCIL_DEPTH_MATERIAL\n          uniform float decalStencilValue;\n        #endif\n\n        #if defined(DECAL_NORMAL_STENCIL_DEPTH_MATERIAL) || (defined(NORMAL_DEPTH_MATERIAL) && !defined(RENDER_TO_FLOAT_TEXTURE))\n          vec2 normalToOct22(in vec3 normal) {\n            float manNorm = abs(normal.x) + abs(normal.y) + abs(normal.z);\n            float oNx = normal.x / manNorm;\n            float oNy = normal.y / manNorm;\n            if (normal.z < 0.0) {\n              float tmpx = (1.0 - abs(oNy)) * (oNx >= 0.0 ? 1.0 : -1.0);\n              float tmpy = (1.0 - abs(oNx)) * (oNy >= 0.0 ? 1.0 : -1.0);\n              oNx = tmpx;\n              oNy = tmpy;\n            }\n            return floor((2047.0 * (0.5 * vec2(oNx, oNy) + 0.5))+0.5);\n          }\n        #endif\n\n        \n        #if defined(NORMAL_DEPTH_IOR_ROUGHNESS_MATERIAL)\t\n          float normalToOct24(in vec3 normal) {\n            float manNorm = abs(normal.x) + abs(normal.y) + abs(normal.z);\n            float oNx = normal.x / manNorm;\n            float oNy = normal.y / manNorm;\n            if (normal.z < 0.0) {\n              float tmpx = (1.0 - abs(oNy)) * (oNx >= 0.0 ? 1.0 : -1.0);\n              float tmpy = (1.0 - abs(oNx)) * (oNy >= 0.0 ? 1.0 : -1.0);\n              oNx = tmpx;\n              oNy = tmpy;\n            }\n            vec2 compNormal = floor((4095.0 * (0.5 * vec2(oNx, oNy) + 0.5))+0.5);\n            return compNormal.x * 4096.0 + compNormal.y;\n          }\n        #endif\n        ",normal_depth_fragment:"\n        #if defined(NORMAL_DEPTH_MATERIAL) || defined(NORMAL_DEPTH_IOR_ROUGHNESS_MATERIAL) || defined(DECAL_NORMAL_STENCIL_DEPTH_MATERIAL)\n          #if defined(DECAL_NORMAL_STENCIL_DEPTH_MATERIAL)\n            gl_FragColor.xy = normalToOct22(normal); \n            gl_FragColor.z = decalStencilValue;\n          #elif defined(NORMAL_DEPTH_MATERIAL)\n            gl_FragColor.xyz = normal * 0.5 + 0.5;\n          #else\n            gl_FragColor.x = normalToOct24(normal);\n            #if defined(DSPBR) || defined(SPECGLOSS)\n              #ifdef USE_NEWSSLR\n                gl_FragColor.z = materialData.roughness;\n              #else\n                float oldSSRFactor = materialData.roughness * materialData.roughness;\n                gl_FragColor.z = 1.0 - oldSSRFactor;\n              #endif\n              gl_FragColor.y = 0.0;\n              #if defined(DSPBR)\n                #ifndef THIN_WALLED\n                    if (materialData.transparency > 0.0 && materialData.metalness < 1.0) {\n                      gl_FragColor.y = materialData.adjustedIoR;\n                    }\n                #else\n                    if (materialData.transparency > 0.0 && materialData.metalness < 1.0) {\n                      gl_FragColor.y = 1.0;\n                    }\n                #endif\n              #endif\n            #else\n              gl_FragColor.y = 0.0;\n              #if defined(PHONG) \n                gl_FragColor.z = reflectionCoef;\n              #else\n                gl_FragColor.z = 0.0;\n              #endif\n            #endif\n          #endif\n          #ifdef DECAL\n            gl_FragColor.w = gl_FragDepthEXT;\n          #else\n            #ifdef PDSFX\n              float depthValue = 0.5 + 0.5 * _DSclipPosition.z / _DSclipPosition.w;\n            #else\n              float depthValue = 0.5 + 0.5 * DS_clipPosition.z / DS_clipPosition.w;\n            #endif\n            gl_FragColor.w = depthValue;\n          #endif\n          #if !defined(RENDER_TO_FLOAT_TEXTURE) && defined(NORMAL_DEPTH_MATERIAL)\n            gl_FragColor.xy = normalToOct22(normal); \n            float convertedDepth = 8388608.0 * gl_FragColor.w;\n            gl_FragColor.z = floor(convertedDepth / 4096.0);\n            gl_FragColor.w = mod(convertedDepth, 4096.0);\n          #endif\n        #endif\n        ",shadowmap_pars_fragment:"\n        #if defined(SHADOWMAP_MATERIAL)\n\n            vec4 pack_depth_esm(const in float depth) {\n              #ifdef USE_UINT_ESM\n                float esmDepth = exp(80.0*depth);\n                float exposant = ceil(log(esmDepth)/log(10.0));\n                float normDepth = esmDepth/pow(10.0,exposant);\n                return vec4(packRGB(normDepth),exposant/255.0);\n              #else\n                return vec4(exp(80.0*depth),0.0,0.0,1.0);\n              #endif\n            }\n\n          vec4 pack_depth( const in float depth ) {\n            return packRGBA(depth);\n          }\n        #endif\n        ",shadowmap_fragment:"\n        #if defined(SHADOWMAP_MATERIAL)\n          #ifndef USE_SUBSURFACE\n            if (gl_FragColor.a < 1.0 - 1e-3) {\n              discard;\n            }\n          #endif\n          vec4 finalData;\n          #ifdef DECAL\n            float depth = gl_FragDepthEXT;\n          #else\n            float depth = gl_FragCoord.z;\n          #endif\n          #if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED)\n            finalData = pack_depth_esm( depth );\n          #else\n            finalData = pack_depth( depth );\n          #endif\n          \n          #ifdef GLSL300ES\n            outFragColor = finalData;\t\t\t\t\n          #else\n            gl_FragColor = finalData;\n          #endif\n        #endif\n        #if defined(TRANSPARENT_SHADOWMAP_MATERIAL)\n          #ifdef USE_SUBSURFACE\n            discard;\n          #endif\n        #endif\n        ",highlight_pars_vertex:"\n          #ifdef HIGHLIGHT_MATERIAL\t\t\n            #if HIGHLIGHT_POLITE == 1 && !defined(PDSFX)\n              varying vec4 DS_clipPosition;\n            #endif\n          #endif\n        ",highlight_vertex:"\n          #ifdef HIGHLIGHT_MATERIAL\t\t\n            #if HIGHLIGHT_POLITE == 1 && !defined(PDSFX)\n              DS_clipPosition = gl_Position;;\n            #endif\n          #endif\n        ",highlight_pars_fragment:"\n          #ifdef HIGHLIGHT_MATERIAL\t\n            #ifdef MOBILE_HIGHLIGHT_MODE\n              #if defined(LINEBASIC) || defined(PARTICLEBASIC)\n                uniform vec4 iHighlightLineicColor;\n              #else\n                uniform vec4 iHighlightColor;\n              #endif\n              uniform vec2 iHighlightIntensity;\n            #else\n              uniform float highlightID;\n            #endif\n            #if HIGHLIGHT_POLITE == 1 && !defined(PDSFX)\n              varying vec4 DS_clipPosition;\n            #else\n              vec4 DS_clipPosition;\n            #endif\n            #if HIGHLIGHT_POLITE == 1\n              #ifdef NOZ_OBJECT\n                const int noZ = 1;\n              #else\n                const int noZ = 0;\n              #endif\n              uniform sampler2D rgbaDepth;\n\n              const float highlightBack = 0.66;\n              const float highlightFront = 0.33;\n\n              float depthSampleTest(in vec2 coord, in float depth) {\n                float fDepth = unpackRGBA(texture2D(rgbaDepth, coord));\n                if ( fDepth  < depth) return highlightBack;\n                return highlightFront;\n              }\n\n              float getDepthTestResult(float depth) {\n                vec2 coord = 0.5 + 0.5*DS_clipPosition.xy/DS_clipPosition.w;\n                return depthSampleTest(coord, depth - 2.38418579e-7);\n              }\n\n              float getFaceDepthValue() {\n                if (noZ == 1) {\n                  return highlightFront;\n                }\n                #ifdef DECAL\n                  float depth = gl_FragDepthEXT;\n                #else\n                  float depth = 0.5 + 0.5 * DS_clipPosition.z / DS_clipPosition.w;\n                #endif\n                float faceDepth = depth;\n                #if defined(GL_OES_standard_derivatives) || defined(GLSL300ES)\n                  float dx = dFdx(depth);\n                  float dy = dFdy(depth);\n                  #if defined(MOBILE_HIGHLIGHT_MODE) && !defined(MOBILE_DEVICE_MODE)\n                    faceDepth += 0.5 * (sqrt(dx*dx + dy*dy) + DEPTH_PRECISION);\n                  #else\n                    faceDepth += 0.9 * (sqrt(dx*dx + dy*dy) + DEPTH_PRECISION);\n                  #endif\n                #else\n                  faceDepth += 1.5 *DEPTH_PRECISION;\n                #endif\n                return getDepthTestResult(faceDepth);\n              }\n\n              float getDepthValue() {\n                if (noZ == 1) {\n                  return highlightFront;\n                }\n                float depth = 0.5 + 0.5 * DS_clipPosition.z / DS_clipPosition.w;\n                return getDepthTestResult(depth);\n              }\n            #endif\n          #endif\n        ",highlight_fragment_face:"\n          #ifdef HIGHLIGHT_MATERIAL\t\t\n            vec3 I = vec3(0.0, 0.0, 1.0);\n            if (!(projectionMatrix[3][3] > 0.0)) {\n              I = normalize( vPos.xyz );\n            }\n            float reflectionFactor = abs( dot( I, normal ) );\n            #if HIGHLIGHT_POLITE == 1              \n              #ifdef PDSFX\n                DS_clipPosition = _DSclipPosition;\n              #endif\n              float depthValue = getFaceDepthValue();\n              reflectionFactor = noZ == 1 ? 0.8 : depthValue < 0.5 ? (1.0 - 1.0 / 3.141) * reflectionFactor + 1.0/3.141 : reflectionFactor;\n              #ifdef MOBILE_HIGHLIGHT_MODE\n                gl_FragColor = vec4( iHighlightColor.xyz * reflectionFactor, depthValue > 0.5 ? iHighlightIntensity.y : iHighlightIntensity.x);\n                gl_FragColor.a = min(gl_FragColor.a, 1.0);\n              #else\n                gl_FragColor = vec4( highlightID / 255.0, reflectionFactor, depthValue , 0.0 );\n              #endif\n            #else\n              reflectionFactor = 1.0 - reflectionFactor;\n              #ifdef MOBILE_HIGHLIGHT_MODE\n                gl_FragColor = vec4( iHighlightColor.xyz, (0.6 * reflectionFactor*reflectionFactor + 0.2)* iHighlightIntensity.x );\n                gl_FragColor.a = min(gl_FragColor.a, 1.0);\n              #else\n                gl_FragColor = vec4( highlightID / 255.0, reflectionFactor * reflectionFactor , 0.0, 0.0 );\n              #endif\n            #endif\n          #endif\n        ",highlight_fragment_edge:"\n          #ifdef HIGHLIGHT_MATERIAL\t\t\n            #if HIGHLIGHT_POLITE == 1\n              #ifdef PDSFX\n                DS_clipPosition = _DSclipPosition;\n              #endif\n              #ifdef MOBILE_HIGHLIGHT_MODE\n                #ifdef USE_WIDELINE\n                gl_FragColor = vec4( iHighlightLineicColor.xyz, halfWidth > 0.5 ? 0.8 : 1.0);\n                #else\n                gl_FragColor = vec4( iHighlightLineicColor.xyz, 1.0);\n                #endif\n                gl_FragColor.a = min(gl_FragColor.a, 1.0);\n              #else\n                float wValue = 1.0 / 255.0;\n                #ifdef PRIMITIVE_HIGHLIGHT\n                  wValue = 2.0 / 255.0;\n                #endif\n                #ifdef ADJACENCE_HIGHLIGHT\n                  gl_FragColor = vec4( highlightID / 255.0, 1.0, highlightFront , wValue );\n                #else\n                \tgl_FragColor = vec4( highlightID / 255.0, 1.0, getDepthValue() , wValue );\n              \t#endif\n              #endif\n            #else\n              #ifdef MOBILE_HIGHLIGHT_MODE\n                gl_FragColor = vec4( iHighlightLineicColor.xyz, 0.8 * iHighlightIntensity.x );\n                gl_FragColor.a = min(gl_FragColor.a, 1.0);\n              #else              \n                float wValue = 1.0 / 255.0;\n                gl_FragColor = vec4( highlightID / 255.0, 1.0 , 0.0, wValue );\n              #endif\n            #endif\n          #endif\n        ",highlight_fragment_point:"\n          #ifdef HIGHLIGHT_MATERIAL\t\t\t\n            #ifdef MOBILE_HIGHLIGHT_MODE\t\t\n              #if HIGHLIGHT_POLITE == 1         \n                #ifdef PDSFX\n                  DS_clipPosition = _DSclipPosition;\n                #endif\n                gl_FragColor = vec4( iHighlightLineicColor.xyz, 0.8);\n              #else\n                gl_FragColor = vec4( iHighlightLineicColor.xyz, 0.8 * iHighlightIntensity.x );\n              #endif\n              gl_FragColor.a = min(gl_FragColor.a, 1.0);\n            #else\n              float wValue = 3.0 / 255.0;\n              #if HIGHLIGHT_POLITE == 1\n                #ifdef PDSFX\n                  DS_clipPosition = _DSclipPosition;\n                #endif\n                #ifdef PRIMITIVE_HIGHLIGHT\t\t\n                    wValue = 4.0 / 255.0;\n                    gl_FragColor = vec4( highlightID / 255.0, 1.0 , getDepthValue(), wValue );\n                #else\n                    gl_FragColor = vec4( highlightID / 255.0, 1.0 , 0.0, wValue);\n                #endif\n              #else\n                gl_FragColor = vec4( highlightID / 255.0, 1.0 , 0.0, wValue );\n              #endif\n            #endif\n          #endif\n        ",texcoord_pars_vertex:"\n          #ifdef TEXTURE_COORDINATES_MATERIAL\n            varying vec2 vUv_deferred;\n            varying vec2 vUv2_deferred;\n          #endif\n        ",texcoord_vertex:"\n          #ifdef TEXTURE_COORDINATES_MATERIAL\n            vUv_deferred = uv;\n            vUv2_deferred = uv2;\n          #endif\n        ",texcoord_pars_fragment:"\n          #ifdef TEXTURE_COORDINATES_MATERIAL\n            varying vec2 vUv_deferred;\n            varying vec2 vUv2_deferred;\n          #endif\n        ",texcoord_fragment:"\n            #ifdef TEXTURE_COORDINATES_MATERIAL\n              gl_FragColor = vec4( vUv_deferred.x, vUv_deferred.y ,vUv2_deferred.x, vUv2_deferred.y);\n            #endif\n        ",_debug_common_face_fragment:"\n            #ifdef DEBUG_DEPTH\n                gl_FragColor.a = 1.0;\n                gl_FragColor.rgb = vec3(gl_FragCoord.z);\n            #endif\n            #ifdef DEBUG_NORMAL\n                gl_FragColor.a = 1.0;\n                #ifdef GPU_OUTLINES\n                    gl_FragColor.rgb = vec3(0.5);\n                #else\n                    gl_FragColor.rgb = 0.5 * normalize((vec4(normal.xyz, 0.0) * viewMatrix).xyz) + 0.5;\n                #endif\n            #endif\n            #ifdef DEBUG_SHADOW\n                gl_FragColor.a = 1.0;\n                #if !defined(SPECGLOSS) && !defined(DSPBR)\n                    discard;\n                #endif\n            #endif          \n            #if defined(DEBUG_GEOM_UVS)\n                gl_FragColor.a = 1.0;\n                #ifdef NEEDS_UVTOUSE            \n                    gl_FragColor.rgb = vec3(mod(vUv.x, 1.0), mod(vUv.y, 1.0), 0.0);\n                #else\n                    gl_FragColor.rgb = vec3(0.0);\n                #endif\n            #endif\n            #if defined(DEBUG_MAPPING_UVS)\n                gl_FragColor.a = 1.0;\n                #ifdef NEEDS_UVTOUSE\n                    gl_FragColor.rgb = vec3(mod(uvToUse.x, 1.0), mod(uvToUse.y, 1.0), 0.0);\n                #else          \n                    gl_FragColor.rgb = vec3(0.0);\n                #endif\n            #endif\n            \n            #if defined(DEBUG_GEOM_UV2S)\n                gl_FragColor.a = 1.0;\n                #if defined(NEEDS_UVTOUSE) && (defined(SPECGLOSS) || defined(DSPBR))       \n                    gl_FragColor.rgb = vec3(mod(vUv2.x, 1.0), mod(vUv2.y, 1.0), 0.0);\n                #else\n                    gl_FragColor.rgb = vec3(0.0);\n                #endif\n            #endif\n            #if defined(DEBUG_MAPPING_UV2S)\n                gl_FragColor.a = 1.0;\n                #if defined(NEEDS_UVTOUSE) && (defined(SPECGLOSS) || defined(DSPBR))\n                    gl_FragColor.rgb = vec3(mod(uv2ToUse.x, 1.0), mod(uv2ToUse.y, 1.0), 0.0);\n                #else          \n                    gl_FragColor.rgb = vec3(0.0);\n                #endif\n            #endif\n        ",_debug_common_lineic_fragment:"\n            #ifdef DEBUG_DEPTH\n                gl_FragColor.a = 1.0;\n                gl_FragColor.rgb = vec3(gl_FragCoord.z);\n            #endif\n            #ifdef DEBUG_NORMAL\n                gl_FragColor.a = 1.0;\n                gl_FragColor.rgb = vec3(0.5);\n            #endif\n            #if defined(DEBUG_SHADOW) || defined(DEBUG_GEOM_UVS) || defined(DEBUG_MAPPING_UVS) || defined(DEBUG_MAPPING_UV2S) || defined(DEBUG_GEOM_UV2S)\n                discard;\n            #endif\n        ",oit_pars_vertex:["#ifdef USE_OIT","#ifdef OIT_ACCUM_MATERIAL","   varying float depthOITValue;","#endif","#endif"].join("\n"),oit_vertex:["#ifdef USE_OIT","#ifdef OIT_ACCUM_MATERIAL",e.getModelViewTransformationChunk("vec4 aux","vec4(position.xyz, 1.0)"),"   depthOITValue = aux.z;","   float normalizeValue;","       float m22 = projectionMatrix[2][2];","       float m32 = projectionMatrix[3][2];","       float near = m32 / (m22 - 1.0);","       float far = ((m22 - 1.0)*near)/(m22 + 1.0);","       normalizeValue = far + near;","   depthOITValue /= 0.5*normalizeValue;","#endif","#endif"].join("\n"),oit_vertex_point:[""].join("\n"),oit_pars_fragment:["#ifdef USE_OIT","#ifdef OIT_ACCUM_MATERIAL","   varying float depthOITValue;","   float getOITWeight() {","       float distanceTerm = 0.3/ (1e-3 + pow(abs(depthOITValue), 4.0));","       distanceTerm = clamp(distanceTerm, 1e-3, 3e3);","       float alphaTerm = gl_FragColor.a ;","       return alphaTerm * alphaTerm * distanceTerm;","   }","#endif","#endif"].join("\n"),oit_fragment:["#ifdef DEBUG_DECAL","if (length(dViewPosition) < 2e-6) {","gl_FragColor.rgba = vec4(1.0,0.0,0.0, 0.5);","}","#endif","#ifdef USE_OIT","#if defined(OIT_ACCUM_MATERIAL) || defined(OIT_REVEAL_MATERIAL)","if (gl_FragColor.a > 1.0 - 1e-2) {","discard;","}","#elif defined(ORIGINAL_MATERIAL)","if (gl_FragColor.a < 1.0 - 1e-2){","discard;","}","gl_FragColor.a = 1.0;","#endif","#if defined(OIT_ACCUM_MATERIAL)","gl_FragColor = vec4(gl_FragColor.rgb, 1.0)* getOITWeight();","#elif defined(OIT_REVEAL_MATERIAL)","gl_FragColor.r = gl_FragColor.a;","#endif","#endif"].join("\n"),oit_fragment_point:["#ifdef USE_OIT","   #if defined(OIT_ACCUM_MATERIAL) || defined(OIT_REVEAL_MATERIAL)","      discard;","   #endif","#endif"].join("\n")}}),define("DS/VisuDataAccess/Ox4TypeHelper",["DS/Visualization/Utils","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(e,t){"use strict";var i=function(e){var t='<?xml version="1.0" encoding="utf-8"?>\n';return t+='<executeSequence xmlns="http://www.3ds.com/xmql/query">\n',t+="\t<execute>\n",t+=e?"\t\t<function>get_parents_rel_type</function>\n":"\t\t<function>get_parents_bus_type</function>\n",t+="\t\t<version>1.0.0</version>\n",t+="\t\t<params>\n",t+='\t\t\t<param name="type">%1</param>\n',t+="\t\t</params>\n",t+="\t</execute>\n",t+="</executeSequence>\n"},r=null,n=i(!1),a=i(!0),s=function(e,i,s){var o=new t,l=i?a:n;if(l=l.replace("%1",e),null===s){var c=[];try{c=JSON.parse(o.executeSyncPostHttpRequest(r,"application/xml",l)),Array.isArray(c)||(c=[])}catch(e){c=[]}return c}var h={data:l,type:"json",headers:{"Content-type":"application/xml",Accept:"application/json"},onComplete:function(e){var t=[];try{t=JSON.parse(e.xmql_response.body.result[2].output),Array.isArray(t)||(t=[])}catch(e){t=[]}s(t)}};o.executePostHttpRequestWithOptions(r,h)},o=function(e,t,i){var r=i;if(void 0===r&&(r=null),"string"!=typeof e){if(null===r)return[];r([])}else if(c[t].hasOwnProperty(e)){if(null===r)return c[t][e];r(c[t][e])}else{if(null===r){var n=s(e,"rel"===t,null);for(c[t][e]=n;n.length>0;)n=n.slice(0),c[t][n.shift()]=n;return console.warn("[Ox4TypeHelper]: Synchronous server call is deprecated, switch to asynchronous version"),c[t][e]}s(e,"rel"===t,function(i){for(c[t][e]=i;i.length>0;)i=i.slice(0),c[t][i.shift()]=i;r(c[t][e])})}},l=function(e,t){return c[e].hasOwnProperty(t)},c={bus:{},rel:{}};return{IsInit:function(){return null!=r},Init:function(i,n,a){var s={requiredAuth:n,proxyurl:a};void 0===s.requiredAuth&&(s.requiredAuth=null),void 0===s.proxyurl&&(s.proxyurl=null),e.setProxyFromSpec(s,t),r=function(e){if(void 0===e.hostname)return console.log("Ox4TypeHelper:No Hostname in ServerDefinition"),null;var t=e.hostname;if(void 0===e.rooturi)return console.log("Ox4TypeHelper:No RootUri in ServerDefinition"),null;var i=e.rooturi,r="http://";void 0!==e.protocol&&"https"===e.protocol&&(r="https://");var n=-1;void 0!==e.port&&(n=e.port);var a=r+t;return-1!=n&&(a+=":"+n),a+="/"+i+"/i3dx/services/xmql"}(i)},InitWithUrl:function(i,n,a,s){var o={requiredAuth:a,proxyurl:s};void 0===o.requiredAuth&&(o.requiredAuth=null),void 0===o.proxyurl&&(o.proxyurl=null),e.setProxyFromSpec(o,t),r=i+"/i3dx/services/xmql","string"==typeof n&&(r+="?tenant="+n)},RegisterParentsTypes:function(e,t){var i=function(e,t,r){for(var n=e.pop();n&&l(t,n);)n=e.pop();n?o(n,t,function(){i(e,t,r)}):r()},r=0,n=function(){2==++r&&t()};i(e.bus,"bus",n),i(e.rel,"rel",n)},GetParentsBusType:function(e,t){return o(e,"bus",t)},GetParentsRelType:function(e,t){return o(e,"rel",t)},IsBusA:function(e,t,i){var r=i;if(void 0===r&&(r=null),"string"!=typeof e||"string"!=typeof t){if(null===r)return!1;r(!1)}else if(e===t){if(null===r)return!0;r(!0)}else{if(null===r)return this.GetParentsBusType(e).indexOf(t)>=0;this.GetParentsBusType(e,function(e){r(e.indexOf(t)>=0)})}},IsRelA:function(e,t,i){var r=i;if(void 0===r&&(r=null),"string"!=typeof e||"string"!=typeof t){if(null===r)return!1;r(!1)}else if(e===t){if(null===r)return!0;r(!0)}else{if(null===r)return this.GetParentsRelType(e).indexOf(t)>=0;this.GetParentsRelType(e,function(e){r(e.indexOf(t)>=0)})}}}}),define("VisuDataAccess/Ox4TypeHelper",["DS/VisuDataAccess/Ox4TypeHelper","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/Ox4TypeHelper"),e}),define("DS/Visualization/WidelinesHelper",["DS/Mesh/ThreeJS_Base","DS/Mesh/Mesh"],function(e,t){"use strict";return{_computeLineDistances:function(t,i){t.cpuPatternMode=!1;for(var r,n,a=0,s=[],o=t.vertexIndexArray,l=i&&i.length===o.length,c=new e.Vector3,h=new e.Vector3,u=0;u<t.drawingGroups.length;u++)for(var d=t.drawingGroups[u],p=d.start,f=d.count,m=0;m<f;m++){a=0;var g=m+p,v=0;if(l&&(v=i[g]),m>0){if((r=o[g])===(n=o[g-1]))continue;t.getVertexPosition(r,c),t.getVertexPosition(n,h),a=c.distanceTo(h),Math.abs(a)>1e-6&&!(m%2)?(s[2*r]=v,s[2*r+1]=v):(s[2*r]=v+a+s[2*n],s[2*r+1]=v+a+s[2*n])}else{var S=o[g];s[2*S]=v,s[2*S+1]=v}}t.needsUpdate=!0,t.vertexLineDistancesArray=new Float32Array(s)},_computeWideLineDistances:function(e){this._computeLineDistances(e.wideLinesLinker.parentGeometry,[]),e.cpuPatternMode=!1;for(var t=[],i=e.wideLinesLinker.parentGeometry.vertexLineDistancesArray,r=e.wideLinesLinker.lineStructureMap,n=0;n<e.drawingGroups.length;n++)for(var a=e.drawingGroups[n],s=r.get(a),o=s.sides,l=s.primitives,c=0,h=0;h<l.length;h++)for(var u=l[h],d=0;d<u.length;d++)for(var p=u[d],f=!p.endLine&&!p.begLine||p.isLoopedWith||p.fusedWith?4:2,m=0;m<f;m++){var g=i[2*p.cur];if(o[c]%2==0)if(t.push(g),p.isLoopedWith)t.push(g);else if(p.fusedWith){var v=l[p.fusedWith.primIndex][0];v=i[2*v.cur],Math.abs(v-g)<1e-6?t.push(i[2*p.next]):t.push(g)}else t.push(i[2*p.next]);else t.push(i[2*p.prev]),t.push(g);c++}e.needsUpdate=!0,e.vertexLineDistancesArray=new Float32Array(t)},_computePixelLineDistances:function(t,i,r,n,a){if(!(t.cpuPatternFrame>=a)){t.cpuPatternMode=!0,t.cpuPatternFrame=a;var s=0,o=[],l=new e.Matrix4;l.multiplyMatrices(r,i);for(var c,h,u=t.vertexIndexArray,d=new e.Vector4,p=new e.Vector4,f=new e.Vector2,m=new e.Vector2,g=0;g<t.drawingGroups.length;g++)for(var v=t.drawingGroups[g],S=v.start,_=0,y=v.count;_<y;_++){s=0;var x=_+S;if(_>0){if((c=u[x])===(h=u[x-1]))continue;t.getVertexPosition(c,d),t.getVertexPosition(h,p),d.w=1,d.applyMatrix4(l),p.w=1,p.applyMatrix4(l),f.x=.5*(d.x/d.w+1)*n.width,f.y=.5*(d.y/d.w+1)*n.height,m.x=.5*(p.x/p.w+1)*n.width,m.y=.5*(p.y/p.w+1)*n.height,s=f.distanceTo(m),Math.abs(s)>1e-6&&!(_%2)?(o[2*c]=0,o[2*c+1]=0):(o[2*c]=s+o[2*h],o[2*c+1]=s+o[2*h])}else{var M=u[x];o[2*M]=0,o[2*M+1]=0}}t.needsUpdate=!0,t.vertexLineDistancesArray=new Float32Array(o)}},_computePixelWideLineDistances:function(e,t,i,r,n){if(!(e.cpuPatternFrame>=n)){e.cpuPatternMode=!0,e.cpuPatternFrame=n,this._computePixelLineDistances(e.wideLinesLinker.parentGeometry,t,i,r,n);for(var a=[],s=e.wideLinesLinker.parentGeometry.vertexLineDistancesArray,o=e.wideLinesLinker.lineStructureMap,l=0;l<e.drawingGroups.length;l++)for(var c=e.drawingGroups[l],h=o.get(c),u=h.sides,d=h.primitives,p=0,f=0;f<d.length;f++)for(var m=d[f],g=0;g<m.length;g++)for(var v=m[g],S=!v.endLine&&!v.begLine||v.isLoopedWith||v.fusedWith?4:2,_=0;_<S;_++){var y=s[2*v.cur];if(u[p]%2==0)if(a.push(y),v.isLoopedWith)a.push(y);else if(v.fusedWith){var x=d[v.fusedWith.primIndex][0];x=s[2*x.cur],Math.abs(x-y)<1e-6?a.push(s[2*v.next]):a.push(y)}else a.push(s[2*v.next]);else a.push(s[2*v.prev]),a.push(y);p++}e.needsUpdate=!0,e.vertexLineDistancesArray=new Float32Array(a)}},_computeWideLineDG:function(i,r,n,a,s){var o=i.wideLinesLinker,l=o.originalDGToWideDG.get(n);if(l)return l;if(!i.vertexIndexArray)return null;l=new t.DrawingGroup,n instanceof t.DrawingGroup?l=n.clone():(l.gas=n.gas,l.gasIndex=n.gasIndex,l._geomType=n._geomType,l.layers=n.layers,l.material=n.material,l.copyPrimitives(n.primitives),l.count=n.count),l.geometry=r,l.glType=4,o.originalDGToWideDG.set(n,l);var c=new e.Vector3,h=new e.Vector3,u=function(e,t){return i.getVertexPosition(e,c),i.getVertexPosition(t,h),Math.abs(c.x-h.x)<1e-6&&Math.abs(c.y-h.y)<1e-6&&Math.abs(c.z-h.z)<1e-6},d=function(){for(var e=[],r=0,a=new t.SGPrimitiveHelper,s=0;s<n.getPrimitivesCount();s++){a.set(n,s),e.push([]);for(var o=a.getStart();o<a.getStart()+a.getCount();o++){var l=(o-a.getStart())%2,c={cur:r=i.vertexIndexArray[o],prev:l?i.vertexIndexArray[o-1]:r,next:l?r:i.vertexIndexArray[o+1],begLine:!1,endLine:!1,fusedBack:!1,fusedWith:null};e[s].push(c)}}return e}(),p=function(e,t){for(var i=0;i<e.length;i++){var r=e[i];if(!(r.length<1))for(var n=0;n<r.length;n++){t(r[n],r,n)}}};p(d=function(e){for(var t=[],i=0;i<e.length;i++)if(t.push([]),!((P=e[i]).length<1))for(var r=0;r<P.length;r++){var n=P[r];if(n.cur!==n.next)t[i].push(n);else if(r<P.length-1){var a=r+1,s=P[a];if(n.cur===s.cur){for(var o=r+2;o<P.length&&n.cur===P[o].cur;o++)a=o;s=P[a];var l={cur:n.cur,next:s.next,prev:n.prev,begLine:!1,endLine:!1,fusedBack:!1,fusedWith:null};r=a,t[i].push(l)}else t[i].push(n)}else t[i].push(n)}return t}(d),function(e){e.next===e.cur?e.endLine=!0:e.prev===e.cur&&(e.begLine=!0)});p(d,function(e,t,i){if(e.endLine&&i<t.length-1){var r=t[i+1];r.begLine&&u(e.cur,r.cur)&&(e.endLine=!1,r.begLine=!1)}});p(d,function(e,t,i){if(u(e.cur,e.next)&&!e.endLine&&!e.begLine)for(var r=i+1;r<t.length;r++){var n=t[r];if(!u(e.cur,n.cur))break;if(n.prev=e.prev,n.endLine)break;u(n.next,n.cur)?n.colorIndex||(n.colorIndex=e.cur):(e.next=n.next,e.endSkip=!0,n.baseSkip=!0)}});!function(e){if(!(e.length<2)){for(var t=[],r=0;r<e.length;r++)if(!((d=e[r]).length<1)){var n=d[d.length-1],a=d[0];u(n.cur,n.next)&&(i.getVertexPosition(n.cur,c),t.push([c.x,c.y,c.z,r,1])),u(a.prev,a.cur)&&(i.getVertexPosition(a.cur,c),t.push([c.x,c.y,c.z,r,0]))}t.sort(function(e,t){var i=e[0]-t[0];if(Math.abs(i)<1e-6){var r=e[1]-t[1];if(Math.abs(r)<1e-6){var n=e[2]-t[2];if(Math.abs(n)<1e-6){var a=e[3]-t[3];return 0===a?0:a>0?1:-1}return n>0?1:-1}return r>0?1:-1}return i>0?1:-1});for(var s=0;s<t.length;s++){var o=t[s];if(0!==o[4])for(var l=s+1;l<t.length;l++){var h=t[l];if(1!==h[4]&&h[3]!==o[3]){if(Math.abs(o[0]-h[0])<1e-6&&Math.abs(o[1]-h[1])<1e-6&&Math.abs(o[2]-h[2])<1e-6){n=(d=e[o[3]])[d.length-1];var d,p=e[h[3]][0];if(!p.fusedBack){n.next=p.next,p.prev=n.prev,n.fusedWith={primIndex:h[3]},p.fusedBack=!0;break}}break}}}}}(d);p(d,function(e,t,i){var r=t.length;if(e.begLine)for(var n=i+1;n<r;n++){var a=t[n];if(a.endLine){n-i>1&&u(a.cur,e.cur)&&(a.isLoopedWith=!0,e.prev=a.prev,a.next=e.next);break}}});for(var f=[],m=[],g=[],v=[],S=0,_=new e.Vector3,y=new e.Vector3,x=new e.Vector3,M=0;M<d.length;M++)for(var P=d[M],C=0;C<P.length;C++){var b=!(O=P[C]).endLine&&!O.begLine||O.isLoopedWith||O.fusedWith?4:2;O.indRef=S,O.inds=[];for(var D=0;D<b;D++)O.inds.push(S),v[S]=D%2==0?1:-1,4===b?v[S]*=D<2?1:2:O.begLine&&(v[S]*=2),i.getVertexPosition(O.cur,_),i.getVertexPosition(O.prev,y),i.getVertexPosition(O.next,x),f[3*S]=_.x,f[3*S+1]=_.y,f[3*S+2]=_.z,m[3*S]=y.x,m[3*S+1]=y.y,m[3*S+2]=y.z,g[3*S]=x.x,g[3*S+1]=x.y,g[3*S+2]=x.z,S++}o.lineStructureMap.set(l,{sides:v.slice(0),primitives:d.slice(0)});var w=null;if(i.vertexColorArray){var E=new e.Vector4;w=[];for(S=0,M=0;M<d.length;M++)for(P=d[M],C=0;C<P.length;C++)for(b=!(O=P[C]).endLine&&!O.begLine||O.isLoopedWith||O.fusedWith?4:2,D=0;D<b;D++){var T=O.colorIndex>=0?O.colorIndex:O.cur;i.getVertexColor(T,E),w[4*S]=E.x,w[4*S+1]=E.y,w[4*S+2]=E.z,w[4*S+3]=E.w,S++}}var A=null;const I=i.vertexPatternStartEndArray;if(I){A=[];for(S=0,M=0;M<d.length;M++)for(P=d[M],C=0;C<P.length;C++)for(b=!(O=P[C]).endLine&&!O.begLine||O.isLoopedWith||O.fusedWith?4:2,D=0;D<b;D++){T=O.cur;for(var R=0;R<2;R++)A[2*S+R]=I[2*T+R];S++}}var L=null;if(!i.vertexLineDistancesArray&&a.isDashedLine&&this._computeLineDistances(i,[]),!i.vertexLineDistancesArray&&a.politeMaterial&&this._computeLineDistances(i,[]),i.vertexLineDistancesArray&&s&&this._computeLineDistances(i,[]),i.vertexLineDistancesArray){const e=i.vertexLineDistancesArray;L=[];for(S=0,M=0;M<d.length;M++)for(P=d[M],C=0;C<P.length;C++){var O;for(b=!(O=P[C]).endLine&&!O.begLine||O.isLoopedWith||O.fusedWith?4:2,D=0;D<b;D++){var N=e[2*O.cur];if(v[S]%2==0)if(L.push(N),O.isLoopedWith)L.push(N);else if(O.fusedWith){var F=d[O.fusedWith.primIndex][0];F=e[2*F.cur],Math.abs(F-N)<1e-6?L.push(e[2*O.next]):L.push(N)}else L.push(e[2*O.next]);else L.push(e[2*O.prev]),L.push(N);S++}}}var V=[],U=0;for(M=0;M<d.length;M++){if(!((P=d[M]).length<1)){l._setPrimitiveCount(0,M);C=0;for(C=0;C<P.length;C++){var B=P[C],k=B.inds;if(B.endLine||B.begLine){if(B.endLine){B.isLoopedWith&&(V.push(k[0]),V.push(k[1]),V.push(k[2]),V.push(k[3]),V.push(k[2]),V.push(k[1]),l._setPrimitiveCount(l.getPrimitiveCount(M)+6,M));continue}var G=P[C+1].inds;V.push(k[0]),V.push(k[1]),V.push(G[0]),V.push(G[1]),V.push(G[0]),V.push(k[1]),l._setPrimitiveCount(l.getPrimitiveCount(M)+6,M)}else if(B.baseSkip||(V.push(k[0]),V.push(k[1]),V.push(k[2]),V.push(k[3]),V.push(k[2]),V.push(k[1]),l._setPrimitiveCount(l.getPrimitiveCount(M)+6,M)),!B.endSkip){G=P[C+1].inds;V.push(k[2]),V.push(k[3]),V.push(G[0]),V.push(G[1]),V.push(G[0]),V.push(k[3]),l._setPrimitiveCount(l.getPrimitiveCount(M)+6,M)}}if(P[P.length-1].fusedWith){var z=P[C-1].inds;V.push(z[0]),V.push(z[1]),V.push(z[2]),V.push(z[3]),V.push(z[2]),V.push(z[1]),l._setPrimitiveCount(l.getPrimitiveCount(M)+6,M)}l._setPrimitiveStart(U,M),U+=l.getPrimitiveCount(M)}}var H={count:V.length,start:0},W=0;return r.vertexPositionArray&&(W=r.vertexPositionArray.length/3,f=Array.prototype.slice.call(r.vertexPositionArray).concat(f)),r.vertexPreviousPositionArray&&(m=Array.prototype.slice.call(r.vertexPreviousPositionArray).concat(m)),r.vertexNextPositionArray&&(g=Array.prototype.slice.call(r.vertexNextPositionArray).concat(g)),r.vertexSideExtrusionArray&&(v=Array.prototype.slice.call(r.vertexSideExtrusionArray).concat(v)),r.vertexColorArray&&(w=Array.prototype.slice.call(r.vertexColorArray).concat(w)),r.vertexPatternStartEndArray&&(A=Array.prototype.slice.call(r.vertexPatternStartEndArray).concat(A)),r.vertexLineDistancesArray?(W-r.vertexLineDistancesArray.length/2>0&&this._computeWideLineDistances(r),L=Array.prototype.slice.call(r.vertexLineDistancesArray).concat(L)):null!==L&&L.length>0&&W>0&&(this._computeWideLineDistances(r),L=Array.prototype.slice.call(r.vertexLineDistancesArray).concat(L)),r.vertexIndexArray&&(H.start=r.vertexIndexArray.length,V.forEach(function(e,t,i){i[t]+=W}),V=Array.prototype.slice.call(r.vertexIndexArray).concat(V)),r.needsUpdate=!0,r.vertexPositionArray=f,r.vertexPreviousPositionArray=m,r.vertexNextPositionArray=g,r.vertexSideExtrusionArray=v,w&&(r.vertexColorArray=w),L&&(r.vertexLineDistancesArray=L),A&&(r.vertexPatternStartEndArray=A),r.vertexIndexArray=V,l.start=H.start,l.count=H.count,r.drawingGroups.push(l),l}}}),define("DS/Visualization/FixedSizeArrayPool",["DS/Visualization/WidelinesHelper"],function(e){var t=function(){},i=0,r=0,n=new Map,a=null,s=null;localStorage.getItem("curvedPipesDebug")&&"true"===localStorage.getItem("curvedPipesDebug")&&(s={nbTokens:0,nbInstData:0,tokens:{},tokenPool:a,instData:{},maxNbInstances:{},instDataPool:n},window._debugTokenPool=s);var o=function(e,t,r){this.id=i++,this.idsArray=new Float32Array(2*e),this.idsBuffer=null,this.includesPicking=t,this.pickingColorArray=t?new Float32Array(3*e):null,this.pickingColorBuffer=null,this.lastId=-1,this.igId=r,this._maxNbInstances=e,this.key="",this.objectToIdInArray=new Map,this.idToObjectArray=new Map,this.updateData=!0,this._next=null,s&&(s.nbInstData++,s.instData[this.id]=this,s.maxNbInstances[e]?s.maxNbInstances[e]++:s.maxNbInstances[e]=1)};o.prototype.addInstance=function(e,t,i,r,n){if(this.lastId!==this._maxNbInstances-1){this.lastId++;var a=i.dgIndex+"_"+i.index,s=this.objectToIdInArray.get(a);void 0===s?(this.objectToIdInArray.set(a,this.lastId),this.idToObjectArray.set(this.lastId,a),s=this.lastId):console.log("what!!");var o=t.idInMaps,l=t.matrixId4,c=2*s;if(this.idsArray[c]=l,this.idsArray[c+1]=o*n,this.pickingColorArray){var h=3*s;this.pickingColorArray[h]=r.r,this.pickingColorArray[h+1]=r.g,this.pickingColorArray[h+2]=r.b}this.updateData=!0}else console.error("there has been an issue : not enough room to add instances")},o.prototype.removeInstances=function(e,t,i){for(var r=0;r<i.length&&-1!==this.lastId;r++){i[r].bin===this.igId&&this.removeInstance(e,t,r)}return-1===this.lastId},o.prototype.removeInstance=function(e,t,i){var r=e+"_"+t+"_"+i,n=this.objectToIdInArray.get(r),a=this.idToObjectArray.get(this.lastId);if(void 0!==n){if(this.objectToIdInArray.delete(r),this.idToObjectArray.delete(n),n!==this.lastId){var s=this.idsArray[2*this.lastId],o=this.idsArray[2*this.lastId+1];if(this.idsArray[2*n]=s,this.idsArray[2*n+1]=o,this.pickingColorArray){var l=this.pickingColorArray[3*this.lastId],c=this.pickingColorArray[3*this.lastId+1],h=this.pickingColorArray[3*this.lastId+2];this.pickingColorArray[3*n]=l,this.pickingColorArray[3*n+1]=c,this.pickingColorArray[3*n+2]=h}var u=this.objectToIdInArray.get(a);this.objectToIdInArray.set(a,n),this.idToObjectArray.delete(u),this.idToObjectArray.set(n,a),this.updateData=!0}this.lastId--}},o.prototype.copyDataTo=function(e){for(var t=this.idsArray.length,i=0;i<t;i++)e.idsArray[i]=this.idsArray[i];if(this.pickingColorArray){var r=this.pickingColorArray.length;for(i=0;i<r;i++)e.pickingColorArray[i]=this.pickingColorArray[i]}this.objectToIdInArray.forEach(function(t,i){e.objectToIdInArray.set(i,t)}),this.idToObjectArray.forEach(function(t,i){e.idToObjectArray.set(i,t)}),e.lastId=this.lastId,e.includesPicking=this.includesPicking,e.updateData=!0},o.prototype.resetForReuse=function(e){this.lastId=-1,this.igId=e,this.objectToIdInArray?this.objectToIdInArray.clear():this.objectToIdInArray=new Map,this.idToObjectArray?this.idToObjectArray.clear():this.idToObjectArray=new Map,null===this.idsArray&&(this.idsArray=new Float32Array(2*this._maxNbInstances)),this.includesPicking&&null===this.pickingColorArray&&(this.pickingColorArray=new Float32Array(3*this._maxNbInstances)),this.updateData=!0};var l=function(e,i,n,a,o,l,c){this.object=e,this.geometry=i,this.dg=n,this.start=a,this.count=o,this.attachment=null,this.next=null,this.doRenderLineModePolygonOffset={doIt:!1,enable:!1,unit:1,factor:1},this.doSetMaterialFaces={doubleSided:!1,forceSide:!1,flipSided:!1},this.draw=t,this.updateLineInfos=!1,this.matApp=l,this.gas=c,this._programID=0,e&&(this._programID|=e._programID),l&&(this._programID|=l._programID),s&&(this.__id=r++)};l.prototype.reset=function(){this.object=null,this.geometry=null,this.dg=null,this.start=0,this.count=0,this.matApp=null,this.gas=null,this._programID=0},l.prototype._updateWideLineAndPatternStuff=function(t,i,r,n){if(t.isWideLine||t.is2DLine){if(!i.renderVolumesOnly){t.pixelSize||(t.pixelSize=new n.Vector2);var a=i.domElement;if(t.pixelSize.x=2/a.width,t.pixelSize.y=2/a.height,r.fullWidth&&r.pickingRatioW&&(t.pixelSize.x/=r.pickingRatioW,t.pixelSize.y/=r.pickingRatioH),(l=this.geometry)&&t.isDashedLine&&t.isCPUPattern){var s=this.object;o=(new n.Matrix4).multiplyMatrices(r.matrixWorldInverse,s._getMMMatrix()),e._computePixelWideLineDistances(l,o,r.projectionMatrix,a,i.currentFrameIndex)}}}else if(t.isDashedLine&&!t.is2DLine){t.pixelSize||(t.pixelSize=new n.Vector2);a=i.domElement;if(t.pixelSize.x=2/a.width,t.pixelSize.y=2/a.height,t.isCPUPattern){var o;s=this.object;o=(new n.Matrix4).multiplyMatrices(r.matrixWorldInverse,s._getMMMatrix());var l=this.geometry;e._computePixelLineDistances(l,o,r.projectionMatrix,a,i.currentFrameIndex)}}if(this.dg&&this.dg._updateLineWithShapes){const e=new n.Matrix4(i.domElement.width/2,0,0,0,0,i.domElement.height/2,0,0,0,0,1,0,0,0,0,1).multiply(r.projectionMatrix).multiply(r.matrixWorldInverse).multiply(this.object._getMMMatrix());this.dg._updateLineWithShapes(e)}};var c=function(e,t,i,r,n,a,o,c){l.call(this,e,t,i,r,n,null,null),s&&(s.nbTokens++,s.tokens[this.__id]=this),this.autoInstancingData=h.prototype.allocate_autoInstData(a,o,c),this.instanced=!0};c.prototype.releaseAutoInstData=function(){var e=n.get(this.autoInstancingData.key)||null;this.autoInstancingData._next=e,n.set(this.autoInstancingData.key,this.autoInstancingData),s&&(s.nbInstData--,s.maxNbInstances[this.autoInstancingData._maxNbInstances]--,delete s.instData[this.autoInstancingData.id])};var h=function(){this.bySizePools={},this.pool5=this.bySizePools[5]={list:[],nextAvailable:0,lastCount:0},this.timerClean=void 0},u=null;return h.prototype.allocate=function(e,i,r,n,a,s,o){var c=null;if(u){c=u;u=u.next,c.object=e,c.geometry=i,c.dg=r,c.start=n,c.count=a,c.attachment=null,c.next=null,c.doRenderLineModePolygonOffset.doIt=!1,c.doRenderLineModePolygonOffset.enable=!1,c.doRenderLineModePolygonOffset.unit=1,c.doRenderLineModePolygonOffset.factor=1,c.doSetMaterialFaces.doubleSided=!1,c.doSetMaterialFaces.forceSide=!1,c.doSetMaterialFaces.flipSided=!1,c.draw=t,c.matApp=s,c.gas=o,c._programID=0,e&&(c._programID|=e._programID),s&&(c._programID|=s._programID)}else c=new l(e,i,r,n,a,s,o);return c},h.prototype.release=function(e){e.next=u,u=e,e.reset()},h.prototype.allocateInstancedCurvedPipeSection=function(e,i,r,n,o,l,u,d){var p=null;if(a){p=a;a=a.next,p.object=e,p.geometry=i,p.dg=r,p.start=n,p.count=o,p.attachment=null,p.next=null,p.higher=null,p.lower=null,p.doRenderLineModePolygonOffset.doIt=!1,p.doRenderLineModePolygonOffset.enable=!1,p.doRenderLineModePolygonOffset.unit=1,p.doRenderLineModePolygonOffset.factor=1,p.doSetMaterialFaces.doubleSided=!1,p.doSetMaterialFaces.forceSide=!1,p.doSetMaterialFaces.flipSided=!1,p.draw=t,p.autoInstancingData=h.prototype.allocate_autoInstData(l,u,d),s&&(s.nbTokens++,s.tokens[p.__id]=p)}else p=new c(e,i,r,n,o,l,u,d);return p},h.prototype.releaseInstanced=function(e){e.releaseAutoInstData(),e.autoInstancingData=null,e.next=a,a=e,s&&(s.nbTokens--,delete s.tokens[e.__id])},h.prototype.allocate_autoInstData=function(e,t,i){var r=e.toString()+(t?"p":""),a=n.get(r)||null,l=null;a?(l=a,n.set(r,a._next),l._next=null,l.resetForReuse(i),s&&(s.nbInstData++,s.maxNbInstances[e]?s.maxNbInstances[e]++:s.maxNbInstances[e]=1,s.instData[l.id]=l)):(l=new o(e,t,i)).key=r;var c=debugWebGLV6Viewer.renderer.renderer.context;return l.idsBuffer||(l.idsBuffer=c.createBuffer()),c.bindBuffer(c.ARRAY_BUFFER,l.idsBuffer),c.bufferData(c.ARRAY_BUFFER,l.idsArray,c.DYNAMIC_DRAW),t&&(l.pickingColorBuffer||(l.pickingColorBuffer=c.createBuffer()),c.bindBuffer(c.ARRAY_BUFFER,l.pickingColorBuffer),c.bufferData(c.ARRAY_BUFFER,l.pickingColorArray,c.DYNAMIC_DRAW)),l},h.prototype.dispose=function(){u=null,a=null,n.clear()},h}),define("Visualization/FixedSizeArrayPool",["DS/Visualization/FixedSizeArrayPool","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/FixedSizeArrayPool"),e}),define("DS/Animation/AnimationPath",["DS/Animation/ANIM"],function(e){"use strict";var t=function(t,i,r){this._startValue=t,this._endValue=i,this._duration=r,this._easingCurve=function(t){return e.assert(0<=t&&t<=1),t},this._interpolator=function(e,t,i){return t+(i-t)*e}};return t.prototype.startValue=function(){return this._startValue},t.prototype.setStartValue=function(e){this._startValue=e},t.prototype.endValue=function(){return this._endValue},t.prototype.setEndValue=function(e){this._endValue=e},t.prototype.duration=function(){return this._duration},t.prototype.setDuration=function(e){this._duration=e},t.prototype.easingCurve=function(){return this._easingCurve},t.prototype.setEasingCurve=function(e){this._easingCurve=e},t.prototype.interpolator=function(){return this._interpolator},t.prototype.setInterpolator=function(e){this._interpolator=e},t.prototype.valueAt=function(t){e.assert(0<=t&&t<=this._duration);var i=t/this._duration,r=this._easingCurve(i);return this._interpolator(r,this._startValue,this._endValue)},t}),define("Animation/AnimationPath",["DS/Animation/AnimationPath","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Animation/AnimationPath"),e}),define("DS/GPUFormats/FormatEnums",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t={UVMapping:function(){},CubeReflectionMapping:function(){},CubeRefractionMapping:function(){},SphericalReflectionMapping:function(){},SphericalRefractionMapping:function(){},LatLongReflectionMapping:function(){},LatLongRefractionMapping:function(){},SimpleEnvMapping:function(){},SimpleEnvMappingPreserveRatio:function(){},SimpleEnvMappingFit:function(){},SimpleEnvMappingFitWidth:function(){},SimpleEnvMappingFitHeight:function(){},SimpleEnvMappingCustom:function(){},CubeEnvMapping:function(){},LightProbeEnvMapping:function(){},LatLongEnvMapping:function(){},RepeatWrapping:1e3,ClampToEdgeWrapping:1001,MirroredRepeatWrapping:1002,_ClampToBorderWrapping:1025,NearestFilter:1003,NearestMipMapNearestFilter:1004,NearestMipMapLinearFilter:1005,LinearFilter:1006,LinearMipMapNearestFilter:1007,LinearMipMapLinearFilter:1008,UnsignedByteType:1009,ByteType:1010,ShortType:1011,UnsignedShortType:1012,IntType:1013,UnsignedIntType:1014,FloatType:1015,HalfFloatType:1024,UnsignedShort4444Type:1016,UnsignedShort5551Type:1017,UnsignedShort565Type:1018,AlphaFormat:1019,RGBFormat:1020,RGBAFormat:1021,LuminanceFormat:1022,LuminanceAlphaFormat:1023,CompressedFormats:2e3,MaxDDSFormats:2013,RGB_S3TC_DXT1_Format:2001,RGBA_S3TC_DXT1_Format:2002,RGBA_S3TC_DXT3_Format:2003,RGBA_S3TC_DXT5_Format:2004,RED_RGTC1_Format:2005,RED_RGTC1_S_Format:2006,REDGREEN_RGTC2_Format:2007,REDGREEN_RGTC2_S_Format:2008,RGBA_BPTC_UNORM_Format:2009,SRGB_ALPHA_BPTC_UNORM_Format:2010,RGB_BPTC_SIGNED_FLOAT_Format:2011,RGB_BPTC_UNSIGNED_FLOAT_Format:2012,RGB_ETC1_Format:2201,RGB_PVRTC_2BPPV1_Format:2301,RGB_PVRTC_4BPPV1_Format:2302,RGBA_PVRTC_2BPPV1_Format:2303,RGBA_PVRTC_4BPPV1_Format:2304,R11_EAC_Format:2401,SIGNED_R11_EAC_Format:2402,RG11_ETC2_EAC_Format:2403,SIGNED_RG11_ETC2_EAC_Format:2404,RGB8_ETC2_Format:2405,RGBA8_ETC2_EAC_Format:2406,SRGB8_ETC2_Format:2407,SRGB8_ALPHA8_ETC2_EAC_Format:2408,RGB8_PUNCHTHROUGH_ALPHA1_ETC2_Format:2409,SRGB8_PUNCHTHROUGH_ALPHA1_ETC2_Format:2410},i=["4x4","5x4","5x5","6x5","6x6","8x5","8x6","8x8","10x5","10x6","10x8","10x10","12x10","12x12"];return function(){for(var e=0;e<i.length;e++){var r=i[e],n=2*e;t["RGBA_ASTC_"+r+"_Format"]=2100+n+1,t["SRGB8_ALPHA8_ASTC_"+r+"_Format"]=2100+n+2}}(),t}),define("DS/VisuUnstreamers/FileInZipStreamObject",["DS/VisuUnstreamers/StreamObject","WebappsUtils/WebappsUtils","DS/ZipJS2/ZipJS2"],function(e,t,i){"use strict";var r=0,n=[],a=e.extend({init:function(e,t){return this._parent(e,t),this},open:function(){},close:function(){},read:function(e,t){var r=this,n=function(){r.blob.waitingEntries||(r.blob.waitingEntries=[]),r.blob.waitingEntries.push({cb:e,type:t,context:r})};if(void 0===this.blob.zipEntries){this.blob.zipEntries="Loading",n();var a=new i.fs.FS;a.importBlob(this.blob).then(()=>{r.blob.zipEntries=a;for(var e=0;e<r.blob.waitingEntries.length;e++){var t=r.blob.waitingEntries[e];t.context.read(t.cb,t.type)}})}else if("Loading"===this.blob.zipEntries)n();else{var s=this.blob.zipEntries.find(this.filename);s?this._unzipData(s,t,e):(console.warn({msg:"Missing "+this.filename+" in the zip.",zip:this.blob.zipEntries}),e&&e(null))}},readAsArrayBuffer:function(e){this.read(e,"arraybuffer")},readAsBlob:function(e){this.read(e,"blob")},readAsText:function(e){this.read(e,"text")},readAsXML:function(e){this.read(e,"xml")},_unzipData:function(e,t,i){if(r<2){r++;const n=e=>{this._popUnzipItem(),i&&i(e)},a=e=>{this._popUnzipItem(),i&&i((new DOMParser).parseFromString(e,"text/xml"))};"text"===t?e.getText().then(n):"xml"===t?e.getText().then(a):"blob"===t?e.getBlob("text/plain").then(n):"arraybuffer"===t?e.getUint8Array().then(n):console.error("Unknown type to read : "+t)}else n.push({entry:e,type:t,onsuccess:i})},_popUnzipItem:function(){if(r--,n.length>0){var e=n[0];this._unzipData(e.entry,e.type,e.onsuccess),n.splice(0,1)}}});return UWA.namespace("THREEDS/FileInZipStreamObject",a)}),define("VisuUnstreamers/FileInZipStreamObject",["DS/VisuUnstreamers/FileInZipStreamObject","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuUnstreamers/FileInZipStreamObject"),e}),define("DS/GPUFormats/Texture",["DS/Mesh/ThreeJS_Base","DS/GPUFormats/FormatEnums"],function(e,t){"use strict";function i(e,t,i){var r=i?e.mipmaps[0]:e.image;if(r.width<=t&&r.height<=t)return e;var n=Math.max(r.width,r.height),a=Math.floor(r.width*t/n),s=Math.floor(r.height*t/n),o=document.createElement("canvas");return o.width=a,o.height=s,o.getContext("2d").drawImage(r,0,0,r.width,r.height,0,0,a,s),i?e.mipmaps[0]=o:e.image=o,e}var r=0,n=function(i,n,a,s,o,l,c,h,u){e.EventDispatcher.call(this),this.id=r++,this.name="",this._useCount=0,this._source=e.AssetSource.MANUAL,this.forceUpdate=!1,this.hdr=!1,this.rgbHdr=!1,this.hasDiffuse=!1,this.sRGB=!0,this.image=i,this.mipmaps=[],this.extraFaces=null,this.mapping=void 0!==n?n:new t.UVMapping,this.wrapS=void 0!==a?a:t.ClampToEdgeWrapping,this.wrapT=void 0!==s?s:t.ClampToEdgeWrapping,this.magFilter=void 0!==o?o:t.LinearFilter,this.minFilter=void 0!==l?l:t.LinearMipMapLinearFilter,this.anisotropy=void 0!==u?u:1,this.format=void 0!==c?c:t.RGBAFormat,this.type=void 0!==h?h:t.UnsignedByteType,this.offset=new e.Vector2(0,0),this.repeat=new e.Vector2(1,1),this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.needsUpdate=!1,this.onUpdate=null,this.onRequest=null,this.borderColor=null,this.loadEndStatus=e.AssetLoadingStatus.INIT,this.onLoadCallbacks=[],this.__webglInit=!1,this.__webglTexture=null};return n.Face=function(e,t){this.image=e,this.mipmaps=t},n.prototype={constructor:n,clone:function(t){return void 0===t&&(t=new n),t.hdr=this.hdr,t.sRGB=this.sRGB,t.image=this.image,t.mipmaps=this.mipmaps.slice(0),t.mapping=this.mapping,t.wrapS=this.wrapS,t.wrapT=this.wrapT,t.magFilter=this.magFilter,t.minFilter=this.minFilter,t.anisotropy=this.anisotropy,t.format=this.format,t.type=this.type,t.offset.copy(this.offset),t.repeat.copy(this.repeat),t.generateMipmaps=this.generateMipmaps,t.premultiplyAlpha=this.premultiplyAlpha,t.flipY=this.flipY,t.unpackAlignment=this.unpackAlignment,t.needsUpdate=!0,t.loadEndStatus=this.loadEndStatus,this.borderColor&&(t.borderColor=new e.Vector4,t.borderColor.copy(this.borderColor)),t},_sendTextureToGPU:function(e,t,i,r,n,a,s,o){i?console.error("Error: Texture can't be a compressed format"):e.texImage2D(t,r,n,s,o,a)},_useBorderColor:function(){var e={u:!1,v:!1};return this.borderColor&&(this.wrapS===t._ClampToBorderWrapping&&(e.u=!0),this.wrapT===t._ClampToBorderWrapping&&(e.v=!0)),e},isCubeMap:function(){return!!this.extraFaces&&5===this.extraFaces.length},_setupTexture:function(e,r,a,s,o,l,c,h,u){if(!this.needsUpdate&&!this.forceUpdate)return;this.__webglInit||(this.__webglInit=!0,this.addEventListener("dispose",c),this.__webglTexture=e.createTexture(),r.info.memory.textures++,r.__glResources__.texture.push(this));const d=this.format>t.CompressedFormats,p=this.isCubeMap(),f=p?e.TEXTURE_CUBE_MAP:e.TEXTURE_2D,m=p?e.TEXTURE_CUBE_MAP_POSITIVE_X:e.TEXTURE_2D,g=this.mipmaps.length>0,v=this.mipmaps.length>1;let S=this.generateMipmaps&&!v,_=[new n.Face(this.image,this.mipmaps)];if(p&&(_=_.concat(this.extraFaces),!d&&u))for(let e=0;e<_.length;e++)_[e]=i(_[e],u,g);const y=g?_[0].mipmaps[0]:_[0].image,x=a(y.width)&&a(y.height);if(!x&&!this.nPot&&!p){let e=!1;if(!(d&&this.format<t.MaxDDSFormats)||this.wrapS===t.ClampToEdgeWrapping&&this.wrapT===t.ClampToEdgeWrapping||(e=!0),e)return void r._texturesToResize.add(this)}const M=s(this.format),P=s(this.type),C=o(M,P,S);let b=this.flipY;d&&(b&&(b=!1),S&&(S=!1)),!g||v||S||(this.minFilter!==t.NearestMipMapNearestFilter&&this.minFilter!==t.LinearMipMapNearestFilter||(this.minFilter=t.NearestFilter),this.minFilter!==t.NearestMipMapLinearFilter&&this.minFilter!==t.LinearMipMapLinearFilter||(this.minFilter=t.LinearFilter)),this.magFilter!==t.NearestMipMapNearestFilter&&this.magFilter!==t.LinearMipMapNearestFilter||(this.magFilter=t.NearestFilter),this.magFilter!==t.NearestMipMapLinearFilter&&this.magFilter!==t.LinearMipMapLinearFilter||(this.magFilter=t.LinearFilter),null!=h&&e.activeTexture(e.TEXTURE0+h),e.bindTexture(f,this.__webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,b),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,this.unpackAlignment),l(f,this,x);for(let t=0;t<_.length;t++){const i=_[t];if(g)for(let r=0;r<i.mipmaps.length;r++){const n=i.mipmaps[r];this._sendTextureToGPU(e,m+t,d,r,C,n,M,P)}else this._sendTextureToGPU(e,m+t,d,0,C,i.image,M,P)}S&&x&&e.generateMipmap(f),this.needsUpdate=!1,this.onUpdate&&this.onUpdate()},dispose:function(){this.dispatchEvent({type:"dispose"})},setAsLOD:function(e){this.lods=[],this.textures=[],this.usedTexture=-1,this.lastUsedTexture=-1,this.switchLODTextureCB=e},chooseTexture:function(e,t){if(this.switchLODTextureCB?this.usedTexture=this.switchLODTextureCB({camera:e,object:t,texture:this,lods:this.lods,bSphere:t.geometry.boundingSphere,bBox:t.geometry.boundingBox,matrix:t.matrixWorld}):this.usedTexture=-1,-1!==this.usedTexture){var i=this.lods[this.usedTexture];!this.textures[this.usedTexture]&&i.loadCB&&(this.textures[this.usedTexture]=i.loadCB(this))}}},n}),define("DS/MaterialLibs/GenericLib",["DS/Mesh/ThreeJS_Base","DS/MaterialLibs/UniformsLib","DS/Shaders/DefaultShaders","DS/Visualization/ShaderChunk","DS/Visualization/UniformsUtils"],function(e,t,i,r,n){"use strict";return{cube:{uniforms:{tCube:{type:"t",value:null},tFlip:{type:"f",value:-1}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;",i.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform samplerCube tCube;","uniform float tFlip;","varying vec3 vWorldPosition;","void main() {","gl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );","}"].join("\n")},depthRGBA:{uniforms:n.merge([t.clipPlanes,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new e.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new e.Vector4(1,1)}}]),vertexShaderPars:["#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif"].join("\n"),vertexShaderBody:["#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif"].join("\n"),fragmentShaderPars:["vec4 pack_depth_esm(const in float depth) {","#ifdef USE_UINT_ESM","\tfloat esmDepth = exp(80.0*depth);","\tfloat exposant = ceil(log(esmDepth)/log(10.0));","\tfloat normDepth = esmDepth/pow(10.0,exposant);","\treturn vec4(packRGB(normDepth),exposant/255.0);","#else","\treturn vec4(exp(80.0*depth),0.0,0.0,1.0);","#endif","}","vec4 pack_depth( const in float depth ) {","return packRGBA(depth);","}","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif"].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vUvMap ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","vec4 finalData;","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","finalData = pack_depth_esm( gl_FragCoord.z );","#else","finalData = pack_depth( gl_FragCoord.z );","#endif","#ifdef GLSL300ES","outFragColor = finalData;","#else","gl_FragData[ 0 ] = finalData;","#endif",""].join("\n"),vertexShader:[r.clip_pars_vertex,r.morphtarget_pars_vertex,r.skinning_pars_vertex,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","#ifdef PDSFX_USE_MAP","varying vec2 vUv;","#endif","void main() {",r.PDSFX_start_vertex,r.skinbase_vertex,r.morphtarget_vertex,r.skinning_vertex,r.default_vertex,r.clip_vertex,"#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif",r.PDSFX_end_vertex,"#ifdef PDSFX_USE_MAP","vUv = uv;","#endif","}"].join("\n"),fragmentShader:[r.clip_pars_fragment,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","#ifdef PDSFX_USE_MAP","varying vec2 vUv;","#endif","vec4 pack_depth_esm(const in float depth) {","#ifdef USE_UINT_ESM","\tfloat esmDepth = exp(80.0*depth);","\tfloat exposant = ceil(log(esmDepth)/log(10.0));","\tfloat normDepth = esmDepth/pow(10.0,exposant);","\treturn vec4(packRGB(normDepth),exposant/255.0);","#else","\treturn vec4(exp(80.0*depth),0.0,0.0,1.0);","#endif","}","vec4 pack_depth( const in float depth ) {","return packRGBA(depth);","}","void main() {",r.PDSFX_map_fragment,"#ifdef PDSFX","ComputeCommonValues();",r.PDSFX_discard_fragment,"#endif",r.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vUvMap ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","vec4 finalData;","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","finalData = pack_depth_esm( gl_FragCoord.z );","#else","finalData = pack_depth( gl_FragCoord.z );","#endif","#ifdef GLSL300ES","outFragColor = finalData;","#else","gl_FragData[ 0 ] = finalData;","#endif","}"].join("\n")}}}),define("DS/VisuIdentification/Node",["UWA/Class","DS/VisuIdentification/Pattern"],function(e,t){"use strict";var i=[],r=e.extend({init:function(e,t){return this.pattern=this._findOrCreatePattern(e),this.localId=t,this},getLocalId:function(){return this.localId},getPattern:function(){return this.pattern},getSpace:function(){return this.pattern.space},getContext:function(){return this.pattern.context},getSharability:function(){return this.pattern.shared},setLocalId:function(e){this.localId=e},setPattern:function(e){this.pattern=this._findOrCreatePattern(e)},computeId:function(){var e="";return this.pattern?(e+=this.pattern.getContext(),e+=r.delimiter,e+=this.localId):e},_findOrCreatePattern:function(e){for(var r=0;r<i.length;r++){var n=i[r];if(n.isEqual(e))return n}return new t(e.space,e.context,e.shared)}});return r.delimiter="#",r.atomicDelimiter="/",UWA.namespace("THREEDS/Identification/Node",r)}),define("DS/RenderEngineUtils/DisplayRangeList",["DS/Mesh/ThreeJS_Base","DS/Visualization/FixedSizeArrayPool"],function(e,t){"use strict";var i=null;const r=e._VisuFilterType;var n=function(e,t,i,r,n,a){const s=t.geometry.indexBufferGPU;e.drawElements(e.LINE_STRIP,i,s.glFormat,t.start*s.bytesPerIndex)},a=function(e,t,i,r,n,a){e.drawArrays(t.dg.glType,t.geometry.vertexIndexArray[t.start],i)},s=function(e,t,i,r,n,a){e.drawArrays(t.dg.glType,t.start,i)},o=function(e,t,i,r,n,a){const s=t.geometry,o=s.indexBufferGPU;e.drawElements(t.dg.glType,i,o.glFormat,(s.indexOffsetGPU+t.start)*o.bytesPerIndex)},l=function(e,t,i,r,n,a){const s=t.geometry.indexBufferGPU;r._setVertexAttribDivisors(1,n,a),r.drawElementsInstanced(e.LINE_STRIP,i,s.glFormat,t.start*s.bytesPerIndex,t.object.nbInstances),r._setVertexAttribDivisors(0,n,a)},c=function(e,t,i,r,n,a){const s=t.geometry.indexBufferGPU,o=t.dg&&t.dg._instancingInfos?t.dg._instancingInfos.nbInstances:t.object.nbInstances;r._setVertexAttribDivisors(1,n,a),r.drawElementsInstanced(t.dg.glType,i,s.glFormat,t.start*s.bytesPerIndex,o),r._setVertexAttribDivisors(0,n,a)},h=function(e,t,i,r,n,a){if(a.specialMeshIds>=0){const n=t.geometry.indexBufferGPU;var s=t.autoInstancingData.updateData;t.autoInstancingData.updateData=!1,e.bindBuffer(e.ARRAY_BUFFER,t.autoInstancingData.idsBuffer),e.vertexAttribPointer(a.specialMeshIds,2,e.FLOAT,!1,0,0),s&&e.bufferData(e.ARRAY_BUFFER,t.autoInstancingData.idsArray,e.DYNAMIC_DRAW),r.vertexAttribDivisor(a.specialMeshIds,1),a.specialMeshPicking>=0&&(e.bindBuffer(e.ARRAY_BUFFER,t.autoInstancingData.pickingColorBuffer),e.vertexAttribPointer(a.specialMeshPicking,3,e.FLOAT,!1,0,0),s&&e.bufferData(e.ARRAY_BUFFER,t.autoInstancingData.pickingColorArray,e.DYNAMIC_DRAW),r.vertexAttribDivisor(a.specialMeshPicking,1));const o=t.autoInstancingData.lastId+1;r.drawElementsInstanced(t.dg.glType,i,n.glFormat,t.start*n.bytesPerIndex,o),r.vertexAttribDivisor(a.specialMeshIds,0),a.specialMeshPicking>=0&&r.vertexAttribDivisor(a.specialMeshPicking,0)}},u=function(t,r,n,a,s){this.material=t,this.material._displayRangeLists.set(a,this),this.occurrenceRenderingOverride=r,this.materialOverride=null,this.tree=new Map,this.ssrId=n,this.dl=s,null===i&&(i=e.Constants)};return u.prototype.getSortId=function(e,t){return e.isCurvedPipe?t.id:t.vertexBufferGPU?t.vertexBufferGPU.id:-1},u.prototype.insert=function(t,u,d,p,f,m,g,v){var S=this.getSortId(u,d),_=this.tree,y=_.get(S);if(y){var x=!0,M=y.next;if(p.cullingData||1!==p.glType||M.object.id===u.id&&M.geometry===d&&M.dg.glType===p.glType&&M.start+M.count===f&&(M.count+=m,x=!1),x){var P=y.next;y.next=t,t.attachment=y,t.next=P,null!==P&&(P.attachment=t)}}else y={tree:_,sortId:S,next:t},t.attachment=y,_.set(S,y);if(t.attachment){var C=!1,b=p?p.glType:-1;if(p){C=4===b||5===b;var D=u._getFilter(r.POLYGON_OFFSET);D?(t.doRenderLineModePolygonOffset.doIt=!0,t.doRenderLineModePolygonOffset.enable=D.enabled(),t.doRenderLineModePolygonOffset.unit=D.unit,t.doRenderLineModePolygonOffset.factor=D.factor):C&&!this.material.polygonOffset&&(t.doRenderLineModePolygonOffset.doIt=!0,t.doRenderLineModePolygonOffset.enable=0!==u.renderLineMode&&!(this.material.isWideLine||this.material.is2DLine),t.doRenderLineModePolygonOffset.unit=1,t.doRenderLineModePolygonOffset.factor=1);var w=null!==(p._instancingInfos?p._instancingInfos.instanceAttribArrays:u._instancingInfos?u._instancingInfos.instanceAttribArrays:null);u.isCurvedPipe?t.draw=h:this.material.wireframe&&C?t.draw=w?l:n:w?t.draw=c:0===b&&d.vertexPositionArray&&d.vertexPositionArray.nonindexedPoints?t.draw=a:p.nonIndexed?t.draw=s:t.draw=o}var E=v||(p?p.gas:null),T=!(!E||this.material.forceSide)?E:this.material,A=T.side===i.BackSide;return u._isDecal()&&(A=A||g!==e.MaterialToUse.highlightMaterial&&g!==e.MaterialToUse.pickingMaterial),u._bodyDim>0?t.doSetMaterialFaces.doubleSided=2===u._bodyDim:t.doSetMaterialFaces.doubleSided=T.side!==i.BackSide&&T.side!==i.FrontSide,t.doSetMaterialFaces.forceSide=T.forceSide,t.doSetMaterialFaces.flipSided=A,(u._occurrence&&u._occurrence.isInNozPass()||this.dl.noz)&&(t._programID|=e.ProgramIDs.NOZ_OBJECT),t.updateLineInfos=this.material.isWideLine||this.material.is2DLine||this.material.isDashedLine&&!this.material.is2DLine||p&&p._updateLineWithShapes,!0}return!1},u.prototype._setRenderingInfos=function(t,i){var r=this.material,n=(t.ssr.overridableMaterial||r.deferrable)&&r.overridable&&this.occurrenceRenderingOverride&&this.occurrenceRenderingOverride.materialOverride?this.occurrenceRenderingOverride.materialOverride:null;return n&&n.internalMaterialOverride&&n.internalMaterialOverride.material===r&&(n=null),this.materialOverride=n,!(r.overridable&&n&&0===n.getOpacity()||!n&&0===r.getOpacity())||e._isSelectionMaterial(i)},u.prototype.flagObjectsAsGSSOInvalidated=function(){this.tree.forEach(function(e,t){for(var i=e.next;null!==i;i=i.next)i.object._flagAsGSSOInvalidated()})},u.prototype.add=function({object:r,geometry:n,dg:a,dgInterval:s,renderMode:o,renderVolumesOnly:l,materialToUse:c,matApp:h,gasMaterial:u,cpInfos:d=null,qaAutomationMode:p}){var f=!0,m=o?o._maskWithDefault:e.RenderMode.defaultMask,g=c===e.MaterialToUse.pickingMaterial||c===e.MaterialToUse.highlightMaterial;if(g||(m&=~i.SurfacicPointRenderPointMask),a){var v=r&&r.getFilterGeomType(),S=v||a._geomType;if(S||(S=0===a.glType?e.GeomTypeEnum.UNKNOWN_0D:e.GeomTypeEnum.UNKNOWN),f=(S&m)>0,l){var _=u?u.side:a.gas?a.gas.side:-1;0===a.glType||1===a.glType||S&e.RenderMode.pointsMask||S&e.RenderMode.linesMask?f=!1:0===r._bodyDim&&_===e.DoubleSide?f=!1:r&&0!==r._bodyDim&&3!==r._bodyDim&&(f=!1)}if(p){var y=e.__QA_AUTOMATION_MASK__;f&&(f=(S&y)>0),g&&(f=(S&(y|=e.GeomTypeEnum.SMOOTH_EDGE|e.GeomTypeEnum.SHARP_EDGE|e.GeomTypeEnum.BOUNDARY_EDGE))>0)}}if(f){var x=s?s.start:0,M=s?s.count:0;if(r.isCurvedPipe){var P=e.InstancedCurvedPipeManager,C=P._perRenderableData.get(d.dgIndex);if(!C)return;var b=C[d.index],D=this.tree.get(n.id),w=D?D.next:null,E=P._geometryToInstancingGroup.get(n.id);if(!E)return;var T=2,A=c===e.MaterialToUse.pickingMaterial,I=!1;if(w)if(w.autoInstancingData){if(w.autoInstancingData.lastId+1>=w.autoInstancingData._maxNbInstances){T=2*w.autoInstancingData._maxNbInstances;var R=t.prototype.allocate_autoInstData(T,A,b.bin);w.autoInstancingData.copyDataTo(R),w.releaseAutoInstData(),w.autoInstancingData=R}}else w.autoInstancingData=t.prototype.allocate_autoInstData(T,A,b.bin);else I=!0,(w=t.prototype.allocateInstancedCurvedPipeSection(r,n,a,x,M,T,A,b.bin)).next=null,this.insert(w,r,n,a,x,M,c);var L=null;if(A){var O=r.pickingID>>16&255,N=(r.pickingID>>8&255)/255,F=(255&r.pickingID)/255;O|=128,L=(new e.Color).setRGB(O/255,N,F)}w.autoInstancingData.addInstance(r,b,d,L,E._nbCurvePointsPlus2),r._tokens[this.ssrId]||(r._tokens[this.ssrId]=[]);var V=r._tokens[this.ssrId];I=!0;for(var U=0;U<V.length;U++)if(V[U]===w){I=!1;break}I&&V.push(w)}else{var B=t.prototype.allocate(r,n,a,x,M,h,this.material.useGASColor||this.material.useGASOpacity?u:null);if(B.next=null,this.insert(B,r,n,a,x,M,c,u))r._tokens[this.ssrId]||(r._tokens[this.ssrId]=[]),(V=r._tokens[this.ssrId]).push(B)}}},u.prototype.getFirstDrawable=function(){if(this.tree.values)var e=this.tree.values().next().value;else{e=null;this.tree.forEach(function(t,i){null===e&&(e=t)})}return e?e.next:null},u}),define("DS/VisuDataAccess/Ox4DECPlanRunner",["DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(e){"use strict";return function(t,i,r,n,a){var s=i,o=t,l=new function(){this.executePostHttpRequest=function(t,i,r,n){var a="application/xml";"boolean"==typeof i&&i&&(a="application/xmql"),(new e).executePostHttpRequest(t,a,r,n)},this.executeSyncPostHttpRequest=function(t,i,r){var n="application/xml";return"boolean"==typeof i&&i&&(n="application/xmql"),(new e).executeSyncPostHttpRequest(t,n,r)}},c=n,h=a,u=function(e){console.log("onNextTask");var i=t.next();null==i?d():i[0].run(s,l,r,u,a)},d=function(){console.log("----------------Finished--------\x3e");var e=t.endingTask()(s);e.geometryNodes.length>0?c(e):h({type:"NO_GEOMETRY",msg:"No 3D geometry on this product"})};this.executePlan=function(){console.log("Beginning Ox4PlanRunner runPlan"),o.next()[0].run(s,l,null,u,null),console.log("Ending Ox4PlanRunner runPlan")}}}),define("VisuDataAccess/Ox4DECPlanRunner",["DS/VisuDataAccess/Ox4DECPlanRunner","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/Ox4DECPlanRunner"),e}),define("DS/Animation/AnimationEngine",["DS/Animation/ANIM"],function(e){"use strict";var t=function(){if(t.prototype.instance)return t.prototype.instance;t.prototype.instance=this,this._animations=[]};return t.prototype._register=function(e){this._animations.push(e)},t.prototype._unregister=function(e){this._animations.splice(this._animations.indexOf(e),1)},t.prototype.step=function(t){for(var i=this._animations,r=[],n=[],a=0;a<i.length;++a){var s=i[a];s.direction()===e.Direction.FORWARD?s.setTime(s.time()+t):i.setTime(i.time()-t),(s.direction()===e.Direction.FORWARD&&s.time()===s.duration()||s.direction()===e.Direction.BACKWARD&&0===s.time())&&(s.loop()?n.push(s):r.push(s))}for(a=0;a<r.length;++a)r[a].stop();for(a=0;a<n.length;++a)n[a].start()},t}),define("Animation/AnimationEngine",["DS/Animation/AnimationEngine","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Animation/AnimationEngine"),e}),define("DS/Animation/AbstractAnimation",["DS/Animation/ANIM","DS/Animation/AnimationEngine"],function(e,t){"use strict";var i=function(t){this._state=e.State.STOPPED,this._direction=e.Direction.FORWARD,this._loop=0,this._time=0,this._onStateChange=t,this._group=null};return i.prototype.state=function(){return this._state},i.prototype.direction=function(){return this._direction},i.prototype.setDirection=function(t){e.assert(null===this._group),this._direction=t,this._updateDirection(t)},i.prototype.loop=function(){return this._loop},i.prototype.setLoop=function(t){e.assert(null===this._group),this._loop=t},i.prototype.time=function(){return this._time},i.prototype.setTime=function(t){e.assert(null===this._group);var i=Math.max(0,Math.min(this.duration(),t));this._time=i,this._updateCurrentTime(i)},i.prototype.duration=function(){e.assert(!1)},i.prototype.group=function(){return this._group},i.prototype.isRunning=function(){return this._state===e.State.RUNNING},i.prototype.start=function(){(e.assert(null===this._group),this.rewind(),this._state!==e.State.RUNNING)&&((new t)._register(this),this._state=e.State.RUNNING,this._updateState(this._state))},i.prototype.pause=function(){(e.assert(null===this._group),this._state===e.State.RUNNING)&&((new t)._unregister(this),this._state=e.State.PAUSED,this._updateState(this._state))},i.prototype.resume=function(){(e.assert(null===this._group),this._state===e.State.PAUSED)&&((new t)._register(this),this._state=e.State.RUNNING,this._updateState(this._state))},i.prototype.stop=function(){(e.assert(null===this._group),this._state!==e.State.STOPPED)&&((new t)._unregister(this),this._state=e.State.STOPPED,this._updateState(this._state))},i.prototype.rewind=function(){this._direction===e.Direction.FORWARD?this.setTime(0):this.setTime(this.duration())},i.prototype._updateCurrentTime=function(){e.assert(!1)},i.prototype._updateState=function(e){this._onStateChange&&this._onStateChange(e)},i.prototype._updateDirection=function(){},i}),define("Animation/AbstractAnimation",["DS/Animation/AbstractAnimation","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Animation/AbstractAnimation"),e}),define("DS/Animation/PropertyAnimation",["DS/Animation/ANIM","DS/Animation/AbstractAnimation"],function(e,t){"use strict";var i=function(e,i,r,n){t.call(this,n),this._target=e,this._property=i,this._path=r};return(i.prototype=new t).target=function(){return this._target},i.prototype.setTarget=function(t){e.assert(this.state()===e.State.STOPPED),this._target=t},i.prototype.property=function(){return this._property},i.prototype.setProperty=function(t){e.assert(this.state()===e.State.STOPPED),this._property=t},i.prototype.path=function(){return this._path},i.prototype.setPath=function(t){e.assert(this.state()===e.State.STOPPED),this._path=t},i.prototype.duration=function(){return this._path.duration()},i.prototype._updateCurrentTime=function(e){this._target[this._property]instanceof Function?this._target[this._property](this._path.valueAt(e)):this._target[this._property]=this._path.valueAt(e)},i}),define("Animation/PropertyAnimation",["DS/Animation/PropertyAnimation","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Animation/PropertyAnimation"),e}),define("DS/VisuDataAccess/Ox4PlanRunner",["DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(e){"use strict";return function(t,i,r,n,a,s){var o=i,l=t,c=new function(){this.SetName=r,this.executePostHttpRequest=function(t,i,r,n){var a="application/xml";"boolean"==typeof i&&i&&(a="application/xmql"),(new e).executePostHttpRequest(t,a,r,n)}}(r),h=a,u=s,d=function(e){if(null!==n){var i=t.currentTaskIndex()/t.tasksCount()*100;n(i)}console.log("onNextTask");var r=t.next();null==r?p():r[0].run(o,c,n,d,s)},p=function(){console.log("----------------Finished--------\x3e");var e=t.endingTask()(o);e.geometryNodes.length>0?h(e):u({type:"NO_GEOMETRY",msg:"No 3D geometry on this product"})};this.executePlan=function(){console.log("Beginning Ox4PlanRunner runPlan"),l.next()[0].run(o,c,null,d,null),console.log("Ending Ox4PlanRunner runPlan")}}}),define("VisuDataAccess/Ox4PlanRunner",["DS/VisuDataAccess/Ox4PlanRunner","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/Ox4PlanRunner"),e}),define("DS/Visualization/Curves",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";let t={LineCurve:function(e,t){this.v1=e,this.v2=t}};return t.LineCurve.prototype=Object.create(e.Curve.prototype),t.LineCurve.prototype.getPoint=function(e){var t=this.v2.clone().sub(this.v1);return t.multiplyScalar(e).add(this.v1),t},t.LineCurve.prototype.getPointAt=function(e){return this.getPoint(e)},t.LineCurve.prototype.getTangent=function(e){return this.v2.clone().sub(this.v1).normalize()},t.QuadraticBezierCurve=function(e,t,i){this.v0=e,this.v1=t,this.v2=i},t.QuadraticBezierCurve.prototype=Object.create(e.Curve.prototype),t.QuadraticBezierCurve.prototype.getPoint=function(t){var i,r;return i=e.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x),r=e.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y),new e.Vector2(i,r)},t.QuadraticBezierCurve.prototype.getTangent=function(t){var i,r;i=e.Curve.Utils.tangentQuadraticBezier(t,this.v0.x,this.v1.x,this.v2.x),r=e.Curve.Utils.tangentQuadraticBezier(t,this.v0.y,this.v1.y,this.v2.y);var n=new e.Vector2(i,r);return n.normalize(),n},t.CubicBezierCurve=function(e,t,i,r){this.v0=e,this.v1=t,this.v2=i,this.v3=r},t.CubicBezierCurve.prototype=Object.create(e.Curve.prototype),t.CubicBezierCurve.prototype.getPoint=function(t){var i,r;return i=e.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),r=e.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y),new e.Vector2(i,r)},t.CubicBezierCurve.prototype.getTangent=function(t){var i,r;i=e.Curve.Utils.tangentCubicBezier(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),r=e.Curve.Utils.tangentCubicBezier(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y);var n=new e.Vector2(i,r);return n.normalize(),n},t.SplineCurve=function(e){this.points=null==e?[]:e},t.SplineCurve.prototype=Object.create(e.Curve.prototype),t.SplineCurve.prototype.getPoint=function(t){var i,r,n,a=new e.Vector2,s=[],o=this.points;return n=(i=(o.length-1)*t)-(r=Math.floor(i)),s[0]=0==r?r:r-1,s[1]=r,s[2]=r>o.length-2?o.length-1:r+1,s[3]=r>o.length-3?o.length-1:r+2,a.x=e.Curve.Utils.interpolate(o[s[0]].x,o[s[1]].x,o[s[2]].x,o[s[3]].x,n),a.y=e.Curve.Utils.interpolate(o[s[0]].y,o[s[1]].y,o[s[2]].y,o[s[3]].y,n),a},t.EllipseCurve=function(e,t,i,r,n,a,s){this.aX=e,this.aY=t,this.xRadius=i,this.yRadius=r,this.aStartAngle=n,this.aEndAngle=a,this.aClockwise=s},t.EllipseCurve.prototype=Object.create(e.Curve.prototype),t.EllipseCurve.prototype.getPoint=function(t){var i=this.aEndAngle-this.aStartAngle;this.aClockwise||(t=1-t);var r=this.aStartAngle+t*i,n=this.aX+this.xRadius*Math.cos(r),a=this.aY+this.yRadius*Math.sin(r);return new e.Vector2(n,a)},t.LineCurve3=e.Curve.create(function(e,t){this.v1=e,this.v2=t},function(t){var i=new e.Vector3;return i.subVectors(this.v2,this.v1),i.multiplyScalar(t),i.add(this.v1),i}),t.QuadraticBezierCurve3=e.Curve.create(function(e,t,i){this.v0=e,this.v1=t,this.v2=i},function(t){var i,r,n;return i=e.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x),r=e.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y),n=e.Shape.Utils.b2(t,this.v0.z,this.v1.z,this.v2.z),new e.Vector3(i,r,n)}),t.CubicBezierCurve3=e.Curve.create(function(e,t,i,r){this.v0=e,this.v1=t,this.v2=i,this.v3=r},function(t){var i,r,n;return i=e.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),r=e.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y),n=e.Shape.Utils.b3(t,this.v0.z,this.v1.z,this.v2.z,this.v3.z),new e.Vector3(i,r,n)}),t.SplineCurve3=e.Curve.create(function(e){this.points=null==e?[]:e},function(t){var i,r,n,a=new e.Vector3,s=[],o=this.points;n=(i=(o.length-1)*t)-(r=Math.floor(i)),s[0]=0==r?r:r-1,s[1]=r,s[2]=r>o.length-2?o.length-1:r+1,s[3]=r>o.length-3?o.length-1:r+2;var l=o[s[0]],c=o[s[1]],h=o[s[2]],u=o[s[3]];return a.x=e.Curve.Utils.interpolate(l.x,c.x,h.x,u.x,n),a.y=e.Curve.Utils.interpolate(l.y,c.y,h.y,u.y,n),a.z=e.Curve.Utils.interpolate(l.z,c.z,h.z,u.z,n),a}),e.ClosedSplineCurve3=e.Curve.create(function(e){this.points=null==e?[]:e},function(t){var i,r,n,a=new e.Vector3,s=[],o=this.points;return n=(i=(o.length-0)*t)-(r=Math.floor(i)),r+=r>0?0:(Math.floor(Math.abs(r)/o.length)+1)*o.length,s[0]=(r-1)%o.length,s[1]=r%o.length,s[2]=(r+1)%o.length,s[3]=(r+2)%o.length,a.x=e.Curve.Utils.interpolate(o[s[0]].x,o[s[1]].x,o[s[2]].x,o[s[3]].x,n),a.y=e.Curve.Utils.interpolate(o[s[0]].y,o[s[1]].y,o[s[2]].y,o[s[3]].y,n),a.z=e.Curve.Utils.interpolate(o[s[0]].z,o[s[1]].z,o[s[2]].z,o[s[3]].z,n),a}),t.CurvePath=function(){this.curves=[],this.bends=[],this.autoClose=!1},t.CurvePath.prototype=Object.create(e.Curve.prototype),t.CurvePath.prototype.add=function(e){this.curves.push(e)},t.CurvePath.prototype.checkConnection=function(){},t.CurvePath.prototype.closePath=function(){var t=this.curves[0].getPoint(0),i=this.curves[this.curves.length-1].getPoint(1);t.equals(i)||this.curves.push(new e.LineCurve(i,t))},t.CurvePath.prototype.getPoint=function(e){for(var t,i=e*this.getLength(),r=this.getCurveLengths(),n=0;n<r.length;){if(r[n]>=i){var a=1-(r[n]-i)/(t=this.curves[n]).getLength();return t.getPointAt(a)}n++}return null},t.CurvePath.prototype.getLength=function(){var e=this.getCurveLengths();return e[e.length-1]},t.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length)return this.cacheLengths;var e,t=[],i=0,r=this.curves.length;for(e=0;e<r;e++)i+=this.curves[e].getLength(),t.push(i);return this.cacheLengths=t,t},t.CurvePath.prototype.getBoundingBox=function(){var t,i,r,n,a,s,o,l,c,h,u=this.getPoints();t=i=Number.NEGATIVE_INFINITY,n=a=Number.POSITIVE_INFINITY;var d=u[0]instanceof e.Vector3;for(h=d?new e.Vector3:new e.Vector2,l=0,c=u.length;l<c;l++)(o=u[l]).x>t?t=o.x:o.x<n&&(n=o.x),o.y>i?i=o.y:o.y<a&&(a=o.y),d&&(o.z>r?r=o.z:o.z<s&&(s=o.z)),h.add(o);var p={minX:n,minY:a,maxX:t,maxY:i,centroid:h.divideScalar(c)};return d&&(p.maxZ=r,p.minZ=s),p},t.CurvePath.prototype.createPointsGeometry=function(e){var t=this.getPoints(e,!0);return this.createGeometry(t)},t.CurvePath.prototype.createSpacedPointsGeometry=function(e){var t=this.getSpacedPoints(e,!0);return this.createGeometry(t)},t.CurvePath.prototype.createGeometry=function(t){for(var i=new e.Geometry,r=0;r<t.length;r++)i.vertices.push(new e.Vector3(t[r].x,t[r].y,t[r].z||0));return i},t.CurvePath.prototype.addWrapPath=function(e){this.bends.push(e)},t.CurvePath.prototype.getTransformedPoints=function(e,t){var i,r,n=this.getPoints(e);for(t||(t=this.bends),i=0,r=t.length;i<r;i++)n=this.getWrapPoints(n,t[i]);return n},t.CurvePath.prototype.getTransformedSpacedPoints=function(e,t){var i,r,n=this.getSpacedPoints(e);for(t||(t=this.bends),i=0,r=t.length;i<r;i++)n=this.getWrapPoints(n,t[i]);return n},t.CurvePath.prototype.getWrapPoints=function(e,t){var i,r,n,a,s,o,l=this.getBoundingBox();for(i=0,r=e.length;i<r;i++){a=(n=e[i]).x,s=n.y,o=a/l.maxX,o=t.getUtoTmapping(o,a);var c=t.getPoint(o),h=t.getNormalVector(o).multiplyScalar(s);n.x=c.x+h.x,n.y=c.y+h.y}return e},t.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"quadraticCurveTo",BEZIER_CURVE_TO:"bezierCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc",ELLIPSE:"ellipse"},t.Path=function(e){t.CurvePath.call(this),this.actions=[],e&&this.fromPoints(e)},t.Path.prototype=Object.create(t.CurvePath.prototype),t.Path.prototype.fromPoints=function(e){this.moveTo(e[0].x,e[0].y);for(var t=1,i=e.length;t<i;t++)this.lineTo(e[t].x,e[t].y)},t.Path.prototype.moveTo=function(t,i){var r=Array.prototype.slice.call(arguments);this.actions.push({action:e.PathActions.MOVE_TO,args:r})},t.Path.prototype.lineTo=function(t,i){var r=Array.prototype.slice.call(arguments),n=this.actions[this.actions.length-1].args,a=n[n.length-2],s=n[n.length-1],o=new e.LineCurve(new e.Vector2(a,s),new e.Vector2(t,i));this.curves.push(o),this.actions.push({action:e.PathActions.LINE_TO,args:r})},t.Path.prototype.quadraticCurveTo=function(t,i,r,n){var a=Array.prototype.slice.call(arguments),s=this.actions[this.actions.length-1].args,o=s[s.length-2],l=s[s.length-1],c=new e.QuadraticBezierCurve(new e.Vector2(o,l),new e.Vector2(t,i),new e.Vector2(r,n));this.curves.push(c),this.actions.push({action:e.PathActions.QUADRATIC_CURVE_TO,args:a})},t.Path.prototype.bezierCurveTo=function(t,i,r,n,a,s){var o=Array.prototype.slice.call(arguments),l=this.actions[this.actions.length-1].args,c=l[l.length-2],h=l[l.length-1],u=new e.CubicBezierCurve(new e.Vector2(c,h),new e.Vector2(t,i),new e.Vector2(r,n),new e.Vector2(a,s));this.curves.push(u),this.actions.push({action:e.PathActions.BEZIER_CURVE_TO,args:o})},t.Path.prototype.splineThru=function(t){var i=Array.prototype.slice.call(arguments),r=this.actions[this.actions.length-1].args,n=r[r.length-2],a=r[r.length-1],s=[new e.Vector2(n,a)];Array.prototype.push.apply(s,t);var o=new e.SplineCurve(s);this.curves.push(o),this.actions.push({action:e.PathActions.CSPLINE_THRU,args:i})},t.Path.prototype.arc=function(e,t,i,r,n,a){var s=this.actions[this.actions.length-1].args,o=s[s.length-2],l=s[s.length-1];this.absarc(e+o,t+l,i,r,n,a)},t.Path.prototype.absarc=function(e,t,i,r,n,a){this.absellipse(e,t,i,i,r,n,a)},t.Path.prototype.ellipse=function(e,t,i,r,n,a,s){var o=this.actions[this.actions.length-1].args,l=o[o.length-2],c=o[o.length-1];this.absellipse(e+l,t+c,i,r,n,a,s)},t.Path.prototype.absellipse=function(t,i,r,n,a,s,o){var l=Array.prototype.slice.call(arguments),c=new e.EllipseCurve(t,i,r,n,a,s,o);this.curves.push(c);var h=c.getPoint(o?1:0);l.push(h.x),l.push(h.y),this.actions.push({action:e.PathActions.ELLIPSE,args:l})},t.Path.prototype.getSpacedPoints=function(e,t){e||(e=40);for(var i=[],r=0;r<e;r++)i.push(this.getPoint(r/e));return i},t.Path.prototype.getPoints=function(t,i){if(this.useSpacedPoints)return console.log("tata"),this.getSpacedPoints(t,i);t=t||12;var r,n,a,s,o,l,c,h,u,d,p,f,m,g,v,S,_,y,x=[];for(r=0,n=this.actions.length;r<n;r++)switch(s=(a=this.actions[r]).action,o=a.args,s){case e.PathActions.MOVE_TO:case e.PathActions.LINE_TO:x.push(new e.Vector2(o[0],o[1]));break;case e.PathActions.QUADRATIC_CURVE_TO:for(l=o[2],c=o[3],d=o[0],p=o[1],x.length>0?(f=(g=x[x.length-1]).x,m=g.y):(f=(g=this.actions[r-1].args)[g.length-2],m=g[g.length-1]),v=1;v<=t;v++)S=v/t,_=e.Shape.Utils.b2(S,f,d,l),y=e.Shape.Utils.b2(S,m,p,c),x.push(new e.Vector2(_,y));break;case e.PathActions.BEZIER_CURVE_TO:for(l=o[4],c=o[5],d=o[0],p=o[1],h=o[2],u=o[3],x.length>0?(f=(g=x[x.length-1]).x,m=g.y):(f=(g=this.actions[r-1].args)[g.length-2],m=g[g.length-1]),v=1;v<=t;v++)S=v/t,_=e.Shape.Utils.b3(S,f,d,h,l),y=e.Shape.Utils.b3(S,m,p,u,c),x.push(new e.Vector2(_,y));break;case e.PathActions.CSPLINE_THRU:g=this.actions[r-1].args;var M=[new e.Vector2(g[g.length-2],g[g.length-1])],P=t*o[0].length;M=M.concat(o[0]);var C=new e.SplineCurve(M);for(v=1;v<=P;v++)x.push(C.getPointAt(v/P));break;case e.PathActions.ARC:var b=o[0],D=o[1],w=o[2],E=o[3],T=o[4],A=!!o[5],I=T-E,R=2*t;for(v=1;v<=R;v++)S=v/R,A||(S=1-S),L=E+S*I,_=b+w*Math.cos(L),y=D+w*Math.sin(L),x.push(new e.Vector2(_,y));break;case e.PathActions.ELLIPSE:b=o[0],D=o[1];var L,O=o[2],N=o[3];E=o[4],T=o[5],A=!!o[6],I=T-E,R=2*t;for(v=1;v<=R;v++)S=v/R,A||(S=1-S),L=E+S*I,_=b+O*Math.cos(L),y=D+N*Math.sin(L),x.push(new e.Vector2(_,y))}var F=x[x.length-1];return Math.abs(F.x-x[0].x)<1e-10&&Math.abs(F.y-x[0].y)<1e-10&&x.splice(x.length-1,1),i&&x.push(x[0]),x},t.Path.prototype.toShapes=function(){var i,r,n,a,s,o=[],l=new t.Path;for(i=0,r=this.actions.length;i<r;i++)s=(n=this.actions[i]).args,(a=n.action)==e.PathActions.MOVE_TO&&0!=l.actions.length&&(o.push(l),l=new t.Path),l[a].apply(l,s);if(0!=l.actions.length&&o.push(l),0==o.length)return[];var c,h,u=[],d=!e.Shape.Utils.isClockWise(o[0].getPoints());if(1==o.length)return c=o[0],(h=new e.Shape).actions=c.actions,h.curves=c.curves,u.push(h),u;if(d)for(h=new e.Shape,i=0,r=o.length;i<r;i++)c=o[i],e.Shape.Utils.isClockWise(c.getPoints())?(h.actions=c.actions,h.curves=c.curves,u.push(h),h=new e.Shape):h.holes.push(c);else{for(i=0,r=o.length;i<r;i++)c=o[i],e.Shape.Utils.isClockWise(c.getPoints())?(h&&u.push(h),(h=new e.Shape).actions=c.actions,h.curves=c.curves):h.holes.push(c);u.push(h)}return u},t}),define("DS/GPUFormats/WebGLRenderTarget",["DS/Mesh/ThreeJS_Base","DS/GPUFormats/FormatEnums"],function(e,t){"use strict";var i=0,r=function(t,r,n){e.EventDispatcher.call(this),this.uniqueID=i++,this.id=this.uniqueID,this.width=t,this.height=r,n&&(this.originalMagFilter=n.magFilter,this.originalMinFilter=n.minFilter),this.loadEndStatus=e.AssetLoadingStatus.READY,this.reset(n)};return r.prototype.clone=function(){var e=new r(this.width,this.height);return e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.minFilter=this.minFilter,e.anisotropy=this.anisotropy,e.offset.copy(this.offset),e.repeat.copy(this.repeat),e.format=this.format,e.type=this.type,e.depthBuffer=this.depthBuffer,e.stencilBuffer=this.stencilBuffer,e.generateMipmaps=this.generateMipmaps,e.mapping=this.mapping,e.shareDepthFrom=this.shareDepthFrom,this.originalMagFilter&&(e.originalMagFilter=this.originalMagFilter),this.originalMinFilter&&(e.originalMinFilter=this.originalMinFilter),e},r.prototype.reset=function(i){i=i||{},this.wrapS=void 0!==i.wrapS?i.wrapS:t.ClampToEdgeWrapping,this.wrapT=void 0!==i.wrapT?i.wrapT:t.ClampToEdgeWrapping,this.magFilter=void 0!==i.magFilter?i.magFilter:t.LinearFilter,this.minFilter=void 0!==i.minFilter?i.minFilter:t.LinearMipMapLinearFilter,this.anisotropy=void 0!==i.anisotropy?i.anisotropy:1,this.offset=new e.Vector2(0,0),this.repeat=new e.Vector2(1,1),this.format=void 0!==i.format?i.format:t.RGBAFormat,this.type=void 0!==i.type?i.type:t.UnsignedByteType,this.depthBuffer=void 0===i.depthBuffer||i.depthBuffer,this.stencilBuffer=void 0===i.stencilBuffer||i.stencilBuffer,this.generateMipmaps=!0,this.mapping=new t.UVMapping,this.shareDepthFrom=null,this.hdr=!1,this.rgbHdr=!1,this.hasDiffuse=!1,this.sRGB=!1,this.useCount=0},r.prototype.dispose=function(){this.dispatchEvent({type:"dispose"})},r}),define("DS/VisuDataAccess/Ox4DECRunner",["DS/VisuDataAccess/Ox4TreeTarget","DS/VisuDataAccess/Ox4DECPlanRunner","DS/VisuDataAccess/Ox4TaskPlanner","DS/VisuDataAccess/Ox4ExpandTask","DS/VisuDataAccess/Ox4xMQLSelectTaskDefinition","DS/VisuDataAccess/Ox4DECSelectTask","DS/VisuDataAccess/Ox4PLMDataHelper","DS/VisuDataAccess/Ox4TicketGeneratorTask","DS/VisuDataAccess/Ox4TypeHelper"],function(e,t,i,r,n,a,s,o,l){"use strict";return function(c,h){var u,d,p=(u=c,d=new Object,void 0===u.serverdefinition.hostname?(console.log("checkAndEnrichSpecification:No Hostname in CreateServerDefinition"),null):(d.hostname=u.serverdefinition.hostname,void 0===u.serverdefinition.rooturi?(console.log("checkAndEnrichSpecification:No RootUri in CreateServerDefinition"),null):(d.rooturi=u.serverdefinition.rooturi,d.isSecure=!1,void 0!==u.serverdefinition.protocol&&"https"===u.serverdefinition.protocol&&(d.isSecure=!0),d.port=-1,void 0!==u.serverdefinition.port&&(d.port=u.serverdefinition.port),d.rawmode=u.rawmode,d.xmqlServiceUri=function(){var e="http://";this.isSecure&&(e="https://");var t=e+this.hostname;return-1!=this.port&&(t+=":"+this.port),t+="/"+this.rooturi+"/i3dx/services/xmql","boolean"==typeof d.rawmode&&d.rawmode&&(t+="?raw=true"),t},d.threedexpServiceUri=function(){var e="http://";this.isSecure&&(e="https://");var t=e+this.hostname;return-1!=this.port&&(t+=":"+this.port),t+="/"+this.rooturi},u.serverdefinition=d,u.typeHelper=l,u.shapeType="CgrViewable",u.instanceType=u.dtype,u))),f=new e(p,h),m=null,g=null,v=null;this.run=function(e,i,r){console.log("---\x3e Entering Ox4DECRunner"),m=e,g=i,v=r,console.log("---\x3e Building a plan for");var n=p.expand,a=new Array;if("true"===n){var s=(new S).buildPlan(p,a);new t(s,f,m,g,v).executePlan()}else a[0]=p.physicalid;0==a.length&&(a[0]=p.physicalid);for(var o=0;o<a.length;o++){p.physicalid=a[o];var l=(new _).buildPlan(p);console.log("---\x3e Plan Constructed "),new t(l,f,m,g,v).executePlan()}};var S=function(){this.buildPlan=function(e,t){var r=new i,s=e.physicalid,o=e.dtype,l=0,c=new Array;c.push("physicalid");var h=new n(e.instanceType,c,function(e,i){for(var r=0;r<e.length;r++)t[l]=e[4];l++},3),u=new a(h,e.serverdefinition,s);return r.addSequentialTask(u),r.addEndingTask(function(e){return{rootNode:e.rootNode(),geometryNodes:e.findNodeByType(o)}}),r}},_=function(){this.buildPlan=function(e){console.log("---\x3eOx4DOSPlanifier:Beginning BuildPlan"),console.log(e),console.log("specification.physicalid"+e.physicalid),console.log("dtype:  "+e.dtype);var t=new i,l=e.physicalid,c=(e.dtype,new r(e.physicalid,e.serverdefinition,"Viewable"));t.addSequentialTask(c);var h={Fetch:new Array};h.Fetch.push("physicalid"),h.Fetch.push("attribute[LPAbstractInstance.V_matrix_1]"),h.Fetch.push("attribute[LPAbstractInstance.V_matrix_2]"),h.Fetch.push("attribute[LPAbstractInstance.V_matrix_3]"),h.Fetch.push("attribute[LPAbstractInstance.V_matrix_4]"),h.Fetch.push("attribute[LPAbstractInstance.V_matrix_5]"),h.Fetch.push("attribute[LPAbstractInstance.V_matrix_6]"),h.Fetch.push("attribute[LPAbstractInstance.V_matrix_7]"),h.Fetch.push("attribute[LPAbstractInstance.V_matrix_8]"),h.Fetch.push("attribute[LPAbstractInstance.V_matrix_9]"),h.Fetch.push("attribute[LPAbstractInstance.V_matrix_10]"),h.Fetch.push("attribute[LPAbstractInstance.V_matrix_11]"),h.Fetch.push("attribute[LPAbstractInstance.V_matrix_12]");var u=new n(e.instanceType,h,function(e,t){var i=t.findNodeByPhysicalId(e[1]),r=i.getMatrix();r.set(parseFloat(e[2]),parseFloat(e[5]),parseFloat(e[8]),1e3*parseFloat(e[11]),parseFloat(e[3]),parseFloat(e[6]),parseFloat(e[9]),1e3*parseFloat(e[12]),parseFloat(e[4]),parseFloat(e[7]),parseFloat(e[10]),1e3*parseFloat(e[13]),0,0,0,1),i.setMatrix(r)},0),d=new a(u,e.serverdefinition,l);t.addSequentialTask(d);var p={Fetch:new Array};p.Fetch.push("physicalid"),p.Fetch.push("attribute[StreamDescriptors]"),p.Fetch.push("format.file.store"),p.Fetch.push("format[CGR].file");var f=new s(e.serverdefinition),m=new n(e.shapeType,p,function(t,i){var r=i.findNodeByPhysicalId(t[3]),n=t[6].split(":"),a="";(a=1==n.length?n[0]:n[1]).search(" ")>=0&&(a='"'+a+'"');var s=f.transformSelectedFileIntoTicketRequest(t[3],"CGR",t[5],a);r.ticketRequest=new o(s,e.serverdefinition)},1),g=new a(m,e.serverdefinition,l);return t.addSequentialTask(g),t.addEndingTask(function(t){return{rootNode:t.rootNode(),geometryNodes:t.findNodeByType(e.shapeType)}}),console.log("---\x3eOx4DOSPlanifier:Beginning BuildPlan Done"),t}}}}),define("VisuDataAccess/Ox4DECRunner",["DS/VisuDataAccess/Ox4DECRunner","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/Ox4DECRunner"),e}),define("DS/GPUFormats/CompressedTexture",["DS/Mesh/ThreeJS_Base","DS/GPUFormats/Texture"],function(e,t){"use strict";var i=function(e,i,r,n,a,s,o,l,c,h,u){t.call(this,{width:i,height:r,data:null},s,o,l,c,h,n,a,u),this.mipmaps=e||[]};return(i.prototype=Object.create(t.prototype)).clone=function(){var e=new i;return t.prototype.clone.call(this,e),e},i.prototype._sendTextureToGPU=function(e,t,i,r,n,a,s,o){a.data?i?e.compressedTexImage2D(t,r,s,a.width,a.height,0,a.data):e.texImage2D(t,r,n,a.width,a.height,0,s,o,a.data):console.error("Error: wrong CompressedTexture usage, no data found")},i}),define("DS/Visualization/ImplicitGeometries",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t,i,r,n,a,s={};class o{constructor(t,i){this.origin=void 0!==t?t:new e.Vector3,this.axis=void 0!==i?i.normalize():new e.Vector3}at(t,i){return i||(i=new e.Vector3),i.copy(this.axis).multiplyScalar(t).add(this.origin)}parameter(t,i){return(i||new e.Vector3).subVectors(t,this.origin).dot(this.axis)}project(t,i){i||(i=new e.Vector3);const r=this.parameter(t,i);return this.at(r/this.axis.lengthSq(),i)}distanceToSquared(e,t){return this.project(e,t).distanceToSquared(e)}distanceTo(e,t){return Math.sqrt(this.distanceToSquared(e,t))}applyMatrix4(e){return this.origin.applyMatrix4(e),this.axis.transformDirection(e),this}clone(){return new o(this.origin,this.axis)}}return s.InfiniteLine3=o,s.Line3=function(t,i){this.start=void 0!==t?t:new e.Vector3,this.end=void 0!==i?i:new e.Vector3},s.Line3.prototype={constructor:s.Line3,set:function(e,t){return this.start.copy(e),this.end.copy(t),this},copy:function(e){return this.start.copy(e.start),this.end.copy(e.end),this},center:function(t){return(t||new e.Vector3).addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(t){return(t||new e.Vector3).subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(t,i){var r=i||new e.Vector3;return this.delta(r).multiplyScalar(t).add(this.start)},closestPointToPointParameter:(t=new e.Vector3,i=new e.Vector3,function(r,n){t.subVectors(r,this.start),i.subVectors(this.end,this.start);var a=i.dot(i),s=i.dot(t)/a;return n&&(s=e.Math.clamp(s,0,1)),s}),closestPointToPoint:function(t,i,r){var n=this.closestPointToPointParameter(t,i),a=r||new e.Vector3;return this.delta(a).multiplyScalar(n).add(this.start)},applyMatrix4:function(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this},equals:function(e){return e.start.equals(this.start)&&e.end.equals(this.end)},clone:function(){return(new s.Line3).copy(this)}},s.Box2=function(t,i){this.min=void 0!==t?t:new e.Vector2(1/0,1/0),this.max=void 0!==i?i:new e.Vector2(-1/0,-1/0)},s.Box2.prototype={constructor:s.Box2,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){if(e.length>0){var t=e[0];this.min.copy(t),this.max.copy(t);for(var i=1,r=e.length;i<r;i++)(t=e[i]).x<this.min.x?this.min.x=t.x:t.x>this.max.x&&(this.max.x=t.x),t.y<this.min.y?this.min.y=t.y:t.y>this.max.y&&(this.max.y=t.y)}else this.makeEmpty();return this},setFromCenterAndSize:(r=new e.Vector2,function(e,t){var i=r.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}),copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},singlePoint:function(){return this.max.x<=this.min.x&&this.max.y<=this.min.y},center:function(t){return(t||new e.Vector2).addVectors(this.min,this.max).multiplyScalar(.5)},size:function(t){return(t||new e.Vector2).subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y},getParameter:function(t){return new e.Vector2((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))},isIntersectionBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)},clampPoint:function(t,i){return(i||new e.Vector2).copy(t).clamp(this.min,this.max)},distanceToPoint:function(){var t=new e.Vector2;return function(e){return t.copy(e).clamp(this.min,this.max).sub(e).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)},clone:function(){return(new s.Box2).copy(this)}},s.Box3=function(t,i){this.min=void 0!==t?t:new e.Vector3(1/0,1/0,1/0),this.max=void 0!==i?i:new e.Vector3(-1/0,-1/0,-1/0)},s.Box3.prototype={constructor:s.Box3,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setValues:function(e,t,i,r,n,a){this.min.x=e,this.min.y=t,this.min.z=i,this.max.x=r,this.max.y=n,this.max.z=a},setFromPoints:function(e){if(e.length>0){var t=e[0];this.min.copy(t),this.max.copy(t);for(var i=1,r=e.length;i<r;i++)(t=e[i]).x<this.min.x?this.min.x=t.x:t.x>this.max.x&&(this.max.x=t.x),t.y<this.min.y?this.min.y=t.y:t.y>this.max.y&&(this.max.y=t.y),t.z<this.min.z?this.min.z=t.z:t.z>this.max.z&&(this.max.z=t.z)}else this.makeEmpty();return this},setFromCenterAndSize:function(){var t=new e.Vector3;return function(e,i){var r=t.copy(i).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this}}(),createJSON:function(){return[this.min.x,this.min.y,this.min.z,this.max.x,this.max.y,this.max.z]},setFromJSON:function(e){this.min.set(e[0],e[1],e[2]),this.max.set(e[3],e[4],e[5])},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},singlePoint:function(){return this.max.x<=this.min.x&&this.max.y<=this.min.y&&this.max.z<=this.min.z},center:function(t){return(t||new e.Vector3).addVectors(this.min,this.max).multiplyScalar(.5)},size:function(t){return(t||new e.Vector3).subVectors(this.max,this.min)},getArea:function(){var e=this.size();return 2*(e.x*e.y+e.x*e.z+e.y*e.z)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},getParameter:function(t){return new e.Vector3((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))},isIntersectionBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},clampPoint:function(t,i){return(i||new e.Vector3).copy(t).clamp(this.min,this.max)},distanceToPoint:function(){var t=new e.Vector3;return function(e){return t.copy(e).clamp(this.min,this.max).sub(e).length()}}(),getBoundingSphere:function(){var t=new e.Vector3;return function(e){var i=e||new s.Sphere;return i.center=this.center(),i.radius=.5*this.size(t).length(),i}}(),isIntersectingWith:function(t,i){function r(e,t){let i=1/0,r=-1/0;for(let n=0;n<t.length;n++){const a=e.dot(t[n]);a<i&&(i=a),a>r&&(r=a)}return[i,r]}const n=t.getPoints(i).map(e=>e.clone()),a=this.getPoints();function s(e){if(e.lengthSq()<=1e-6)return!1;const t=r(e,a),i=r(e,n);return t[1]<=i[0]||i[1]<=t[0]}const o=[new e.Vector3(1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,1),(new e.Vector3).copy(n[4]).sub(n[0]),(new e.Vector3).copy(n[2]).sub(n[0]),(new e.Vector3).copy(n[1]).sub(n[0])];for(let e=0;e<6;e++)if(s(o[e]))return!1;const l=new e.Vector3;for(let e=0;e<3;e++){l.copy(o[e]);for(let e=0;e<3;e++)if(l.cross(o[e+3]),s(l))return!1}return!0},intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:(n=[new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3],function(e){return n[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),n[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),n[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),n[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),n[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),n[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),n[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),n[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.makeEmpty(),this.setFromPoints(n),this}),getPoints:function(){var t=[new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3];return function(e){return t[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),t[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),t[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),t[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),t[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),t[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),t[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),t[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),t}}(),translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)},clone:function(){return(new s.Box3).copy(this)},mergeWithBox:function(e){this.expandByPoint(e.min),this.expandByPoint(e.max)},isNaN:function(){return!(!this.min.isNaN()&&!this.max.isNaN())},fromDGBoundingBoxArray:function(e){var t=this,i=e.length;if(i>1){var r=function(t){for(var r=e[0],n=1;n<i;n++){var a=e[n];r.fastBBox.min[t]>a.fastBBox.min[t]&&(r=a)}return r},n=function(t){for(var r=e[0],n=1;n<i;n++){var a=e[n];r.fastBBox.max[t]<a.fastBBox.max[t]&&(r=a)}return r},a=function(e){for(var i=r(e);t.min[e]>=i.fastBBox.min[e];)i.flagMinAttr(e),t.min[e]=Math.min(i.getMinAttr(e),t.min[e]),i=r(e)};a("x"),a("y"),a("z");var s=function(e){for(var i=n(e);t.max[e]<=i.fastBBox.max[e];)i.flagMaxAttr(e),t.max[e]=Math.max(i.getMaxAttr(e),t.max[e]),i=n(e)};s("x"),s("y"),s("z")}else if(i>0){var o=e[0];this.union(o.getRealBBox())}return this},getPlanes:function(){var t=new e.Vector3,i=new e.Vector3,r=null,n=[];return t.set(this.min.x,this.max.y,this.min.z),i.set(this.min.x,this.min.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.min,i,t),n.push(r),t.set(this.max.x,this.min.y,this.min.z),(r=new e.Plane).setFromCoplanarPoints(this.min,t,i),n.push(r),i.set(this.min.x,this.max.y,this.min.z),(r=new e.Plane).setFromCoplanarPoints(this.min,i,t),n.push(r),t.set(this.max.x,this.max.y,this.min.z),i.set(this.max.x,this.min.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.max,i,t),n.push(r),i.set(this.min.x,this.max.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.max,t,i),n.push(r),t.set(this.max.x,this.min.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.max,i,t),n.push(r),n}},s.DGBoundingBoxArray=function(e){this.fastBBox=e.fastBBox.clone(),this._realBBox=e.fastBBox.singlePoint()?e.fastBBox.clone():null,this.matrix=e.matrix.clone(),this.renderable=e.renderable,this.obj=[]},s.DGBoundingBoxArray.prototype.computeFunction=function(){for(var t=new e.Box3,i=0;i<this.obj.length;i++){var r=this.obj[i]._computeOrientedBoundingBox(this.matrix,-1,0,!1,null,null,0);t.union(r)}this._realBBox=t},s.DGBoundingBoxArray.prototype.getRealBBox=function(){return null===this._realBBox&&this.computeFunction(),this._realBBox},s.DGBoundingBoxArray.prototype.getMinAttr=function(e){return null===this._realBBox&&this.computeFunction(),this._realBBox.min[e]},s.DGBoundingBoxArray.prototype.getMaxAttr=function(e){return null===this._realBBox&&this.computeFunction(),this._realBBox.max[e]},s.DGBoundingBoxArray.prototype.flagMaxAttr=function(e){this.fastBBox.max[e]=-1/0},s.DGBoundingBoxArray.prototype.flagMinAttr=function(e){this.fastBBox.min[e]=1/0},s.DGBoundingBoxArray.prototype.addDG=function(e){this.obj.push(e)},s.DGBoundingBoxArray.prototype.setDGs=function(e){this.obj=e},s.DGBoundingBoxArray.prototype.empty=function(){return 0===this.obj.length},s.Sphere=function(t,i){this.center=void 0!==t?t:new e.Vector3,this.radius=void 0!==i?i:0,this.pixelRadius=0},s.Sphere.prototype={constructor:s.Sphere,set:function(e,t){return this.center.copy(e),this.radius=t,this},setSimple:function(e,t,i,r){return this.center.set(e,t,i),this.radius=r,this.pixelRadius=0,this},reset:function(){return this.setSimple(0,0,0,0)},createJSON:function(){return[this.center.x,this.center.y,this.center.z,this.radius]},setFromJSON:function(e){this.center.set(e[0],e[1],e[2]),this.radius=e[3]},setFromCenterAndPoints:function(e,t){for(var i=0,r=0,n=t.length;r<n;r++){var a=e.distanceToSquared(t[r]);i=Math.max(i,a)}return this.center=e,this.radius=Math.sqrt(i),this},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this.pixelRadius=e.pixelRadius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius+1e-6},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},containsSphere:function(e){return this.center.distanceTo(e.center)<=this.radius-e.radius},intersectsSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},intersectsLine:function(e){var t=e[1].clone().sub(e[0]),i=this.center.clone().sub(e[0]),r=t.dot(i),n=t.dot(t),a=e[0].clone().add(t.clone().multiplyScalar(r/n));if(!this.containsPoint(a))return!1;var s=a.sub(e[0]).dot(t);return s>=0&&s<=n},intersectsTriangle:function(e){return this.intersectsLine([e[0],e[1]])||this.intersectsLine([e[1],e[2]])||this.intersectsLine([e[2],e[0]])},clampPoint:function(t,i){var r=this.center.distanceToSquared(t),n=i||new e.Vector3;return n.copy(t),r>this.radius*this.radius&&(n.sub(this.center).normalize(),n.multiplyScalar(this.radius).add(this.center)),n},getBoundingBox:function(t){var i=t||new e.Box3;return i.set(this.center,this.center),i.expandByScalar(this.radius),i},applyMatrix4:function(e){return e&&(this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis()),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius},clone:function(){return(new s.Sphere).copy(this)},mergeWithSphere:function(e,t){var i,r,n;this.radius<e.radius?(i=this,r=e):(i=e,r=this);var a,s=r.center.distanceTo(i.center),o=Math.max(e.pixelRadius,t.pixelRadius);s+i.radius<=r.radius?t.copy(r):(a=((n=.5*(i.radius+r.radius+s))-r.radius)/s,t.radius=n,t.center.x=a*i.center.x+(1-a)*r.center.x,t.center.y=a*i.center.y+(1-a)*r.center.y,t.center.z=a*i.center.z+(1-a)*r.center.z),t.pixelRadius=o},isNaN:function(){return!(isFinite(this.radius)&&!this.center.isNaN())},_updateRatio:function(t){0!==t&&(this.pixelRadius+=this.center.length()*t,this.set(new e.Vector3,this.radius+this.center.length()),this.radius*=t,this.pixelRadius=Math.max(this.pixelRadius,this.radius),this.radius=0)}},s.BoundingSphere=function(e,t,i){s.Sphere.call(this,e,t),this.state=0,i&&this.setState(i)},s.BoundingSphere.prototype=Object.create(s.Sphere.prototype),s.BoundingSphere.prototype.states=["EMPTY","NORMAL","INFINITE"],s.BoundingSphere.prototype.setState=function(e){this.state=this.states.indexOf(e)},s.BoundingSphere.prototype.getState=function(){return this.states[this.state]},s.Triangle=function(t,i,r){this.a=void 0!==t?t:new e.Vector3,this.b=void 0!==i?i:new e.Vector3,this.c=void 0!==r?r:new e.Vector3},s.Triangle.normal=(a=new e.Vector3,function(t,i,r,n){var s=n||new e.Vector3;s.subVectors(r,i),a.subVectors(t,i),s.cross(a);var o=s.lengthSq();return o>0?s.multiplyScalar(1/Math.sqrt(o)):s.set(0,0,0)}),s.Triangle.barycoordFromPoint=function(){var t=new e.Vector3,i=new e.Vector3,r=new e.Vector3;return function(n,a,s,o,l){t.subVectors(o,a),i.subVectors(s,a),r.subVectors(n,a);var c=t.dot(t),h=t.dot(i),u=t.dot(r),d=i.dot(i),p=i.dot(r),f=c*d-h*h,m=l||new e.Vector3;if(0==f)return m.set(-2,-1,-1);var g=1/f,v=(d*u-h*p)*g,S=(c*p-h*u)*g;return m.set(1-v-S,S,v)}}(),s.Triangle.containsPoint=function(){var t=new e.Vector3;return function(e,i,r,n){var a=s.Triangle.barycoordFromPoint(e,i,r,n,t);return a.x>=0&&a.y>=0&&a.x+a.y<=1}}(),s.Triangle.prototype={constructor:s.Triangle,set:function(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this},setFromPointsAndIndices:function(e,t,i,r){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[r]),this},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},area:function(){var t=new e.Vector3,i=new e.Vector3;return function(){return t.subVectors(this.c,this.b),i.subVectors(this.a,this.b),.5*t.cross(i).length()}}(),midpoint:function(t){return(t||new e.Vector3).addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(e){return s.Triangle.normal(this.a,this.b,this.c,e)},plane:function(e){return(e||new s.Plane).setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(e,t){return s.Triangle.barycoordFromPoint(e,this.a,this.b,this.c,t)},containsPoint:function(e){return s.Triangle.containsPoint(e,this.a,this.b,this.c)},equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)},clone:function(){return(new s.Triangle).copy(this)}},s.Spline=function(t){this.points=t;var i,r,n,a,s,o,l,c,h,u=[],d={x:0,y:0,z:0};function p(e,t,i,r,n,a,s){var o=.5*(i-e),l=.5*(r-t);return(2*(t-i)+o+l)*s+(-3*(t-i)-2*o-l)*a+o*n+t}this.initFromArray=function(e){this.points=[];for(var t=0;t<e.length;t++)this.points[t]={x:e[t][0],y:e[t][1],z:e[t][2]}},this.getPoint=function(e){return i=(this.points.length-1)*e,r=Math.floor(i),n=i-r,u[0]=0===r?r:r-1,u[1]=r,u[2]=r>this.points.length-2?this.points.length-1:r+1,u[3]=r>this.points.length-3?this.points.length-1:r+2,o=this.points[u[0]],l=this.points[u[1]],c=this.points[u[2]],h=this.points[u[3]],s=n*(a=n*n),d.x=p(o.x,l.x,c.x,h.x,n,a,s),d.y=p(o.y,l.y,c.y,h.y,n,a,s),d.z=p(o.z,l.z,c.z,h.z,n,a,s),d},this.getControlPointsArray=function(){var e,t,i=this.points.length,r=[];for(e=0;e<i;e++)t=this.points[e],r[e]=[t.x,t.y,t.z];return r},this.getLength=function(t){var i,r,n,a,s=0,o=0,l=0,c=new e.Vector3,h=new e.Vector3,u=[],d=0;for(u[0]=0,t||(t=100),n=this.points.length*t,c.copy(this.points[0]),i=1;i<n;i++)r=i/n,a=this.getPoint(r),h.copy(a),d+=h.distanceTo(c),c.copy(a),s=(this.points.length-1)*r,(o=Math.floor(s))!=l&&(u[o]=d,l=o);return u[u.length]=d,{chunks:u,total:d}},this.reparametrizeByArcLength=function(t){var i,r,n,a,s,o,l,c,h=[],u=new e.Vector3,d=this.getLength();for(h.push(u.copy(this.points[0]).clone()),i=1;i<this.points.length;i++){for(o=d.chunks[i]-d.chunks[i-1],l=Math.ceil(t*o/d.total),a=(i-1)/(this.points.length-1),s=i/(this.points.length-1),r=1;r<l-1;r++)n=a+r*(1/l)*(s-a),c=this.getPoint(n),h.push(u.copy(c).clone());h.push(u.copy(this.points[i]).clone())}this.points=h}},s.Plane=function(t,i){this.normal=void 0!==t?t:new e.Vector3(1,0,0),this.constant=void 0!==i?i:0},s.Plane.prototype={constructor:s.Plane,set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,i,r){return this.normal.set(e,t,i),this.constant=r,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(){var t=new e.Vector3,i=new e.Vector3;return function(e,r,n){var a=t.subVectors(n,r).cross(i.subVectors(e,r)).normalize();return this.setFromNormalAndCoplanarPoint(a,e),this}}(),copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToPointSquared:function(e){const t=this.distanceToPoint(e);return t*t},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return this.orthoPoint(e,t).sub(e).negate()},orthoPoint:function(t,i){var r=this.distanceToPoint(t);return(i||new e.Vector3).copy(this.normal).multiplyScalar(r)},isIntersectionLine:function(e){var t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0},intersectLine:function(){var t=new e.Vector3;return function(i,r){var n=r||new e.Vector3,a=i.delta(t),s=this.normal.dot(a);if(0==s)return 0==this.distanceToPoint(i.start)?n.copy(i.start):void 0;var o=-(i.start.dot(this.normal)+this.constant)/s;return o<0||o>1?void 0:n.copy(a).multiplyScalar(o).add(i.start)}}(),containsPoint(e,t=1e-9){return this.distanceToPointSquared(e)<t},containsInfiniteLine(e,t=1e-9){return this.normal.dot(e.axis)<t&&this.containsPoint(e.origin,t)},containsPlane(e,t=1e-9){return Math.abs(this.normal.dot(e.normal))>1-t&&e.containsPoint(this.coplanarPoint())},coplanarPoint:function(t){return(t||new e.Vector3).copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var t=new e.Vector3,i=new e.Vector3;return function(r,n){n=n||(new e.Matrix3).getInverse(r).transpose();var a=t.copy(this.normal).applyMatrix3(n),s=this.coplanarPoint(i);return s.applyMatrix4(r),this.setFromNormalAndCoplanarPoint(a,s),this}}(),translate:function(e){return this.constant=this.constant-e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant==this.constant},clone:function(){return(new s.Plane).copy(this)}},s.Frustum=function(e,t,i,r,n,a){this.planes=[void 0!==e?e:new s.Plane,void 0!==t?t:new s.Plane,void 0!==i?i:new s.Plane,void 0!==r?r:new s.Plane,void 0!==n?n:new s.Plane,void 0!==a?a:new s.Plane]},s.Frustum.prototype={constructor:s.Frustum,set:function(e,t,i,r,n,a){var s=this.planes;return s[0].copy(e),s[1].copy(t),s[2].copy(i),s[3].copy(r),s[4].copy(n),s[5].copy(a),this},copy:function(e){for(var t=this.planes,i=0;i<6;i++)t[i].copy(e.planes[i]);return this},setFromMatrix:function(e){var t=this.planes,i=e.elements,r=i[0],n=i[1],a=i[2],s=i[3],o=i[4],l=i[5],c=i[6],h=i[7],u=i[8],d=i[9],p=i[10],f=i[11],m=i[12],g=i[13],v=i[14],S=i[15];return t[0].setComponents(s-r,h-o,f-u,S-m).normalize(),t[1].setComponents(s+r,h+o,f+u,S+m).normalize(),t[2].setComponents(s+n,h+l,f+d,S+g).normalize(),t[3].setComponents(s-n,h-l,f-d,S-g).normalize(),t[4].setComponents(s-a,h-c,f-p,S-v).normalize(),t[5].setComponents(s+a,h+c,f+p,S+v).normalize(),this},intersectsSphere:function(e){for(var t=this.planes,i=e.center,r=-e.radius,n=0;n<6;n++){if(t[n].distanceToPoint(i)<r)return!1}return!0},containsSphere:function(e){for(var t=this.planes,i=0;i<6;i++)if(t[i].distanceToPoint(e.center)-e.radius<0)return!1;return!0},containsPoint:function(e){for(var t=this.planes,i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0},clone:function(){return(new s.Frustum).copy(this)},computeOutcode:function(e){var t=0;return e.dot(this.planes[0].normal)+this.planes[0].constant<0&&(t|=1),e.dot(this.planes[1].normal)+this.planes[1].constant<0&&(t|=2),e.dot(this.planes[2].normal)+this.planes[2].constant<0&&(t|=4),e.dot(this.planes[3].normal)+this.planes[3].constant<0&&(t|=8),e.dot(this.planes[4].normal)+this.planes[4].constant<0&&(t|=16),e.dot(this.planes[5].normal)+this.planes[5].constant<0&&(t|=32),t},intersectsLine:function(t){var i=[],r=[new e.Vector3,new e.Vector3];r[0].copy(t[0]),r[1].copy(t[1]),i[0]=this.computeOutcode(r[0]),i[1]=this.computeOutcode(r[1]);for(var n=0;n<4;n++){if(0===i[0]||0===i[1])return!0;if(0!=(i[0]&i[1]))break;var a=new e.Vector3(r[0].x-r[1].x,r[0].y-r[1].y,r[0].z-r[1].z),s=0,o=null;1&i[0]?o=this.planes[0]:2&i[0]?o=this.planes[1]:4&i[0]?o=this.planes[2]:8&i[0]?o=this.planes[3]:16&i[0]?o=this.planes[4]:32&i[0]&&(o=this.planes[5]),o&&(s=-(r[0].dot(o.normal)+o.constant)/a.dot(o.normal)),r[0].add(a.multiplyScalar(s)),i[0]=this.computeOutcode(r[0])}return!1},intersectsTriangle:function(e){return this.intersectsLine([e[0],e[1]])||this.intersectsLine([e[1],e[2]])||this.intersectsLine([e[2],e[0]])},__v2:!0,intersectsObject:function(t,i,r){var n=this.planes,a=t._getMMMatrix(),s=t.geometry.boundingSphere,o=-s.radius*a.getMaxScaleOnAxis(),l=e.Frustum.__v2;null!==s?l.copy(s.center):l.set(0,0,0),l.applyMatrix4(a);for(var c=0;c<6;c++)if(n[c].distanceToPoint(l)<=o)return!1;return!0},performFrustumCulling:function(e,t){for(var i=this.planes,r=-e,n=null,a=null,s=0;s<6;s++)if((a=(n=i[s]).normal).x*t.x+a.y*t.y+a.z*t.z+n.constant<=r)return!1;return!0},performFrustumCullingNoNearFar:function(e,t){for(var i=this.planes,r=-e,n=null,a=null,s=0;s<4;s++)if((a=(n=i[s]).normal).x*t.x+a.y*t.y+a.z*t.z+n.constant<=r)return!1;return!0},getCorners:function(){var t=[],i=new e.Matrix4,r=new e.Matrix4,n=this;function a(t,a,s){var o=n.planes[t],l=n.planes[a],c=n.planes[s];i.set(o.normal.x,o.normal.y,o.normal.z,0,l.normal.x,l.normal.y,l.normal.z,0,c.normal.x,c.normal.y,c.normal.z,0,0,0,0,1),r.getInverse(i);var h=(new e.Vector4).set(-o.constant,-l.constant,-c.constant,1);return h.applyMatrix4(r),h}return t[0]=a(1,2,5),t[1]=a(0,2,5),t[2]=a(0,3,5),t[3]=a(1,3,5),t[4]=a(1,2,4),t[5]=a(0,2,4),t[6]=a(0,3,4),t[7]=a(1,3,4),t}},s.Face4=function(t,i,r,n,a,s,o){this.a=t,this.b=i,this.c=r,this.d=n,this.normal=a instanceof e.Vector3?a:new e.Vector3,this.vertexNormals=a instanceof Array?a:[],this.color=s instanceof e.Color?s:new e.Color,this.vertexColors=s instanceof Array?s:[],this.vertexTangents=[],this.materialIndex=void 0!==o?o:0,this.centroid=new e.Vector3},s.Face4.prototype={constructor:s.Face4,clone:function(){var e,t,i=new s.Face4(this.a,this.b,this.c,this.d);for(i.normal.copy(this.normal),i.color.copy(this.color),i.centroid.copy(this.centroid),i.materialIndex=this.materialIndex,e=0,t=this.vertexNormals.length;e<t;e++)i.vertexNormals[e]=this.vertexNormals[e].clone();for(e=0,t=this.vertexColors.length;e<t;e++)i.vertexColors[e]=this.vertexColors[e].clone();for(e=0,t=this.vertexTangents.length;e<t;e++)i.vertexTangents[e]=this.vertexTangents[e].clone();return i}},s.Face3=function(t,i,r,n,a,s){this.a=t,this.b=i,this.c=r,this.normal=n instanceof e.Vector3?n:new e.Vector3,this.vertexNormals=n instanceof Array?n:[],this.color=a instanceof e.Color?a:new e.Color,this.vertexColors=a instanceof Array?a:[],this.vertexTangents=[],this.materialIndex=void 0!==s?s:0,this.centroid=new e.Vector3},s.Face3.prototype={constructor:s.Face3,clone:function(){var e,t,i=new s.Face3(this.a,this.b,this.c);for(i.normal.copy(this.normal),i.color.copy(this.color),i.centroid.copy(this.centroid),i.materialIndex=this.materialIndex,e=0,t=this.vertexNormals.length;e<t;e++)i.vertexNormals[e]=this.vertexNormals[e].clone();for(e=0,t=this.vertexColors.length;e<t;e++)i.vertexColors[e]=this.vertexColors[e].clone();for(e=0,t=this.vertexTangents.length;e<t;e++)i.vertexTangents[e]=this.vertexTangents[e].clone();return i}},s.mergeBoundingSphereInto=function(e,t,i,r){if(t&&!t.isNaN()){var n=t.clone();r&&n._updateRatio(r),i&&n.applyMatrix4(i),e?e.mergeWithSphere(n,e):e=n}return e},s.mergeBoundingBoxInto=function(t,i,r,n){if(i&&!i.isNaN()){var a=i.clone();n&&(a.max=new e.Vector3(0,0,0),a.min=new e.Vector3(0,0,0)),r&&a.applyMatrix4(r),t?t.mergeWithBox(a):t=a}return t},s}),define("DS/Visualization/BufferGPUManager",["UWA/Class","DS/Mesh/ThreeJS_Base"],function(e,t){"use strict";var i=e.singleton({init:function(){return this.reset(),this},reset:function(){this._gl=null,this._infos=new Map,this.initAtLoading=!1,this.sharedGeometriesToInit=new Map,this.intermediaryArray=null,this.sharingIntermediaryArray=null,this.sharingIntermediaryIndex16Array=null,this.sharingIntermediaryIndex32Array=null,this.fillMapGeomBufferSize=!1,this.mapGeomBufferSize=new Map},addToMapGeomBufferSize:function(e){this.fillMapGeomBufferSize&&this.mapGeomBufferSize.set(e.id,e.getBuffersMemorySize())},addGeometryFromObject:function(e){if(e.geometry&&!(2!==e.geometry._type&&e.geometry.length<0)){var t=e.geometry;if(2===t._type&&(t=[t]),t[0])if(t[0].sharedBuffers)this.sharedGeometriesToInit.has(t[0].id)||(this.sharedGeometriesToInit.set(t[0].id,t),this.initAtLoading&&this.allocateShared(!1));else if(this.initAtLoading)for(var i=0;i<t.length;i++)this.allocateDirect(t[i],e),this.allocateInstancingBuffers(e,null)}},geometryInfoDecrement:function(){this._infos.forEach(function(e,t,i){e.memory.geometries--})},geometryInfoIncrement:function(){this._infos.forEach(function(e,t,i){e.memory.geometries++})},sharedBufferInfoIncrement:function(){this._infos.forEach(function(e,t,i){e.memory.sharedbuffers++})},allocateDirect:function(e){e.wideLinesLinker&&!e.wideLinesLinker._isParent(e)&&e.__setTypedArraysForWidelines();let i=!1;if(!e.vertexBufferGPU){const r=e.getVertexCount(),n=r>0?e.layout.clone():null;if(r>0&&n&&n.size()>0){this.addToMapGeomBufferSize(e);let a=void 0,s=void 0,o=n.getFullInterleaving();if(o)a=e.buffers[o.bufferId],s=o.stride;else{n.interleave();const t=(s=n.getFullInterleaving().stride)*r;!e.editable&&this.intermediaryArray&&this.intermediaryArray.byteLength>=t?a=this.intermediaryArray.subarray(0,t):(a=new Uint8Array(t),e.editable||(this.intermediaryArray=a)),e.exportRaw({target_array:a,target_layout:n})}const l=new t.GLVertexBuffer({gl:this._gl});l.nbGeometries=1,l.numVertices=r,l.layout=n,e.vertexBufferGPU=l,e.vertexOffsetGPU=0,e.vertexCountGPU=r,this._gl.bindBuffer(this._gl.ARRAY_BUFFER,l.buffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,a,e.editable?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),e.editable&&(l.interleavedData=a),this.geometryInfoIncrement(),e._markAllAttributesClean(),i=!0}}if(!e.indexBufferGPU){let r=e.vertexIndexArray;if(0!==e.vertexOffsetGPU){const t=e.vertexOffsetGPU;r=e.vertexIndexArray.map(e=>e+t)}const n=new t.GLIndexBuffer({gl:this._gl,data:r});n.nbGeometries=1,e.indexBufferGPU=n,e.indexOffsetGPU=0,e._markIndexClean(),i=!0}i&&e.noMeshInRAM&&!e.sharedBuffers&&!e.editable&&e.clearMeshInRAM(!1)},allocateInstancingBuffers:function(e,t){let i=t&&t._instancingInfos?t._instancingInfos:e&&e._instancingInfos?e._instancingInfos:null;if(i&&i.instanceAttribArrays){var r=i.instanceAttribArrays;for(var n in r)"id"!==n&&null!==r[n].array&&null===r[n].buffer&&(r[n].buffer=this._gl.createBuffer(),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,r[n].buffer),r[n].isDynamic?this._gl.bufferData(this._gl.ARRAY_BUFFER,r[n].array,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.ARRAY_BUFFER,r[n].array,this._gl.STATIC_DRAW),r[n].buffer.itemSize=r[n].itemSize,r[n].buffer.numItems=i.nbInstances)}},allocateShared:function(e){if(0==this.sharedGeometriesToInit.size)return;let i=Number.MAX_SAFE_INTEGER;if(navigator.userAgent.toLowerCase().indexOf("firefox")>-1){parseFloat(navigator.userAgent.substr(navigator.userAgent.length-4))>=60&&(i=250)}const r=[],n={};if(this.sharedGeometriesToInit.forEach(e=>{for(let t=0;t<e.length;t++){const a=e[t];if(!a)continue;if(a.vertexBufferGPU&&a.vertexBufferGPU.isShared)continue;if(!a.vertexIndexArray){console.warn("no geometry available, are you trying to reattach a mesh while noMeshInRAM has been activated?");continue}const s=a.layout.getSignature();let o=n[s];o||(o={geoms:[],dgCount:0,vertexCount:0,indexCount:0},n[s]=o),o.geoms.push(a),o.vertexCount+=a.getVertexCount(),o.indexCount+=a.vertexIndexArray.length,o.dgCount+=a.drawingGroups.length,(o.vertexCount>2097152||o.dgCount>i)&&(r.push(o),n[s]=null)}}),e)for(let e in n){const t=n[e];t&&t.dgCount>0&&r.push(t)}for(let e=0;e<r.length;e++){const i=r[e],n=new t.GLVertexBuffer({gl:this._gl});n.numVertices=i.vertexCount,n.nbGeometries=i.geoms.length,n.isShared=!0,n.layout=i.geoms[0].layout.clone();const s=new t.GLIndexBuffer({gl:this._gl,numIndices:i.indexCount,use32bitIndexBuffer:t.supportedExtensions.elementIndexUint&&n.numVertices>65535});s.nbGeometries=i.geoms.length,s.isShared=!0,this.sharedBufferInfoIncrement();for(let e=0;e<i.geoms.length;e++){const t=i.geoms[e];this.sharedGeometriesToInit.delete(t.id),(t.vertexBufferGPU||t.indexBufferGPU)&&(t.deallocate(this._gl,null),this.geometryInfoDecrement()),t.vertexBufferGPU=n,t.indexBufferGPU=s;for(var a=0;a<t.meshList.length;a++)t.meshList[a]._flagAsGSSOInvalidated()}this._gl.bindBuffer(this._gl.ARRAY_BUFFER,n.buffer),n.layout.interleave();const o=n.layout.getFullInterleaving().stride,l=o*i.vertexCount;this._gl.bufferData(this._gl.ARRAY_BUFFER,l,this._gl.STATIC_DRAW);let c=0;for(let e=0;e<i.geoms.length;e++){const t=i.geoms[e],r=t.getVertexCount(),a=r*o;t.vertexOffsetGPU=c/o,t.vertexCountGPU=r;let s=null;this.sharingIntermediaryArray&&this.sharingIntermediaryArray.length>=a?s=this.sharingIntermediaryArray.subarray(0,a):(s=new Uint8Array(a),this.sharingIntermediaryArray=s),t.exportRaw({target_array:s,target_layout:n.layout}),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,c,s),c+=a,t.noMeshInRAM&&t.clearMeshInRAM(!0),this.geometryInfoIncrement()}0,this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,s.buffer);let h=s.numIndices*s.bytesPerIndex;this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,h,this._gl.STATIC_DRAW);let u=0;for(let e=0;e<i.geoms.length;e++){let t=i.geoms[e];const r=t.vertexIndexArray.length;t.indexOffsetGPU=u;let n=null;{let e=s.use32bitIndexBuffer?this.sharingIntermediaryIndex32Array:this.sharingIntermediaryIndex16Array;e&&e.length>=r?n=e.subarray(0,r):s.use32bitIndexBuffer?(n=new Uint32Array(r),this.sharingIntermediaryIndex32Array=n):(n=new Uint16Array(r),this.sharingIntermediaryIndex16Array=n)}for(let e=0;e<r;e++)n[e]=t.vertexOffsetGPU+t.vertexIndexArray[e];this._gl.bufferSubData(this._gl.ELEMENT_ARRAY_BUFFER,u*s.bytesPerIndex,n),u+=r,t.noMeshInRAM&&(t.vertexIndexArray=null)}0}e&&(this.sharingIntermediaryArray=null,this.sharingIntermediaryIndex16Array=null,this.sharingIntermediaryIndex32Array=null)},deallocate:function(e){if(null!=e)for(let t=0;t<e.length;t++)_gl.deleteBuffer(e[t])},setGLContext:function(e,t,i){this._gl=t,this._infos.set(e,i)},dispose:function(e){this._infos.delete(e),0==this._infos.size&&this.reset()}});return UWA.namespace("THREEDS/BufferGPUManager",i)}),define("DS/Visualization/GeometryProcessing",["DS/Mesh/ThreeJS_Base","DS/Visualization/ImplicitGeometries"],function(e,t){"use strict";const i=new Uint32Array(2),r=new Float64Array(i.buffer);function n(e,t){return e>t?(i[0]=e,i[1]=t):(i[0]=t,i[1]=e),Number.isFinite(r[0])?r[0]:`${e}:${t}`}const a=(1+Math.sqrt(5))/2,s=2*Math.PI*a,o=Math.PI*Math.sqrt(5),l=1/Math.sqrt(5),c=1/Math.log(a+1),h={PLANE:3,AXIS:2,POINT:1,NONE:0,space_none:()=>({type:h.NONE}),space_point:e=>({type:h.POINT,point:e}),space_axis:e=>({type:h.AXIS,axis:e}),space_plane:e=>({type:h.PLANE,plane:e}),compute(i,r=null){if(r||(r=[0,i.vertexIndexArray.length]),2!==r.length||r[1]<=r[0])return this.space_none();const n=i.vertexIndexArray;let a=r[0];const s=r[1];function o(e){return i.getVertexPosition(n[a],e),e}const l=new e.Vector3;o(l),a++;const c=new e.Vector3;for(;a<s&&o(c).distanceToSquared(l)<1e-6;)a++;if(a>=s)return this.space_point(l);const h=new t.InfiniteLine3(l,(new e.Vector3).subVectors(c,l));a++;const u=new e.Vector3;for(;a<s&&h.distanceToSquared(o(c),u)<1e-6;)a++;if(a>=s)return this.space_axis(h);const d=(new e.Vector3).crossVectors(h.axis,u.subVectors(c,l)).normalize(),p=new t.Plane(d,-d.dot(l));for(a++;a<s&&p.distanceToPointSquared(o(c))<1e-6;)a++;return a>=s?this.space_plane(p):this.space_none()},combine(e,t,i=1e-9){if(!e||!t)return e||t;switch(e.type){case h.POINT:switch(t.type){case h.POINT:return this._combine_point_point(e.point,t.point,i);case h.AXIS:return this._combine_point_axis(e.point,t.axis,i);case h.PLANE:return this._combine_point_plane(e.point,t.plane,i)}case h.AXIS:switch(t.type){case h.POINT:return this._combine_point_axis(t.point,e.axis,i);case h.AXIS:return this._combine_axis_axis(e.axis,t.axis,i);case h.PLANE:return this._combine_axis_plane(e.axis,t.plane,i)}case h.PLANE:switch(t.type){case h.POINT:return this._combine_point_plane(t.point,e.plane,i);case h.AXIS:return this._combine_axis_plane(t.axis,e.plane,i);case h.PLANE:return this._combine_plane_plane(e.plane,t.plane,i)}}return this.space_none()},fit({plane:e,space:t,transform:i}){switch(t.type){case h.NONE:return!1;case h.POINT:return e.containsPoint(t.point.clone().applyMatrix4(i));case h.AXIS:return e.containsInfiniteLine(t.axis.clone().applyMatrix4(i));case h.PLANE:return e.containsPlane(t.plane.clone().applyMatrix4(i));default:return!1}},_combine_point_point(t,i,r){return t.distanceToSquared(i)<r?this.space_point(t):this.space_axis(t,(new e.Vector3).subVectors(i,t))},_combine_point_axis(i,r,n){const a=new e.Vector3;return r.distanceToSquared(i,a)<n?this.space_axis(r):(a.subVectors(i,r.origin).cross(r.axis).normalize(),this.space_plane(new t.Plane(a,-a.dot(i))))},_combine_point_plane(e,t,i){return t.containsPoint(e,i)?this.space_plane(t):this.space_none()},_combine_axis_axis(i,r,n){const a=new e.Vector3;return i.distanceToSquared(r.origin,a)<n&&Math.abs(i.axis.dot(r.axis))>1-n?this.space_axis(i):(a.crossVectors(i.axis,r.axis).normalize(),this.space_plane(new t.Plane(a,-a.dot(i.origin))))},_combine_axis_plane(e,t,i){return t.containsInfiniteLine(e,i)?this.space_plane(t):this.space_none()},_combine_plane_plane(e,t,i){return e.containsPlane(t,i)?this.space_plane(e):this.space_none()}};return{deduplicateVerticesExactMatch:function(e,t=3){const i=e.length/t,r=new Float32Array(t),n=new Uint16Array(r.buffer);let a=null;switch(t){case 2:a=function(t){const i=2*t;return r[0]=e[i],r[1]=e[i+1],String.fromCharCode(n[0],n[1],n[2],n[3])};break;case 3:a=function(t){const i=3*t;return r[0]=e[i],r[1]=e[i+1],r[2]=e[i+2],String.fromCharCode(n[0],n[1],n[2],n[3],n[4],n[5])};break;default:a=function(i){const a=i*t;for(let i=0;i<t;i++)r[i]=e[a+i];return String.fromCharCode(...n)}}const s=new Map,o=i>65535?new Uint32Array(i):new Uint16Array(i);for(let e=0;e<i;e++){const t=a(e);let i=s.get(t);void 0===i&&s.set(t,i=e),o[e]=i}return o},mergeIndexBuffers:function(e){let t=!1,i=0;for(let r=0;r<e.length;r++)e[r]instanceof Uint32Array&&(t=!0),i+=e[r].length;const r=t?new Uint32Array(i):new Uint16Array(i);let n=0;for(let t=0;t<e.length;t++)r.set(e[t],n),n+=e[t].length;return r},computeFaceNormals:function({geom:t,index_ranges:i,alloc_output:r=null}){const n=t.vertexPositionArray,a=t.vertexIndexArray,s=r?r(a.length):new Float32Array(a.length);function o(e,t){e*=3,t.x=n[e],t.y=n[e+1],t.z=n[e+2]}const l=new e.Vector3,c=new e.Vector3,h=new e.Vector3;for(let e=0;e<i.length;e++){const t=i[e][0],r=i[e][1];for(let e=t;e<r;e+=3)o(a[e],l),o(a[e+1],c),o(a[e+2],h),h.sub(c),c.sub(l),c.cross(h),s[e]=c.x,s[e+1]=c.y,s[e+2]=c.z}return s},FitPlaneSpace:h,FibonacciSpiral:{get:function(t,i,r=null){const n=1-(2*t+1)/i,a=Math.sqrt(1-n*n),o=t*s,l=a*Math.cos(o),c=a*Math.sin(o);return r?r.set(l,c,n):r=new e.Vector3(l,c,n),r},inv:function(t,i){const r=1-1/i,n=Math.min(Math.atan2(t.y,t.x),Math.PI),s=t.z,h=e=>e-Math.floor(e),u=Math.max(2,Math.floor(Math.log(i*(1-s*s)*o)*c)),d=Math.pow(a,u)*l,p=Math.round(d),f=Math.round(d*a),m=2*p/i,g=2*f/i,v=2*Math.PI*(h((p+1)*a)-(a-1)),S=2*Math.PI*(h((f+1)*a)-(a-1)),_=1/(g*v-m*S),y=Math.floor(_*(g*n+S*(s-r))),x=Math.floor(_*(-m*n-v*(s-r)));let M=8,P=0,C=new e.Vector3;for(let e=0;e<4;e++){const r=Math.floor(e/2),n=e-2*r,a=Math.floor(p*(n+y)+f*(r+x));this.get(a,i,C);const s=t.distanceToSquared(C);s<M&&(M=s,P=a)}return P}},computeAdjacencyTriangleToTriangle:function({geom:e,index_ranges:t,deduplication:i=null,bijective:r=!0,result:a=null}){a||(a=new Uint32Array(e.vertexIndexArray.length));const s=new Map;function o(e,t,i,o){const l=n(e,t),c=s.get(l);void 0===c?s.set(l,4*i+o):(a[(c>>>2)+c%4]=1+4*i+o,r&&(a[i+o]=1+c),s.delete(l))}const l=e.vertexIndexArray,c=i?e=>i[l[e]]:e=>l[e];for(let e=0;e<t.length;e++){const i=t[e][0],r=t[e][1];for(let e=i;e<r;e+=3){const t=c(e+0),i=c(e+1),r=c(e+2);o(t,i,e,0),o(i,r,e,1),o(r,t,e,2)}}return{adjacency:a,boundary:s}},extractBoundaryEdges:function(e,t){let i=e.values(),r=i.next();const n=[];for(;!r.done;){const e=r.value>>>2,a=r.value%4;n.push(t[e+a]),n.push(t[e+(a+1)%3]),r=i.next()}return Uint32Array.from(n)},edgeKey:n}}),define("DS/Object3D/Object3D",["DS/Mesh/ThreeJS_Base","DS/Visualization/FixedSizeArrayPool","DS/Visualization/GeometryProcessing"],function(e,t,i){"use strict";var r=0,n=new e.Matrix4;const a=e._VisuFilterType,s=e.ProgramIDs;var o,l,c=function(t){if(t.geometry&&t.geometry.boundingSphere&&0!==t.geometry.boundingSphere.radius){var i=new e.Vector3(.259873987,.2768791234,.2458947843);i.multiplyScalar(t.geometry.boundingSphere.radius);var r=(new e.Matrix4).extractMatrix3(t._matrixWorldForDoubleGPU),n=(new e.Vector3).copy(i).applyMatrix4(r);n.x=e.SplitFloat32(n.x).high,n.y=e.SplitFloat32(n.y).high,n.z=e.SplitFloat32(n.z).high;var a=(new e.Matrix4).extractMatrix3(t.matrixWorld),o=(new e.Vector3).copy(i).applyMatrix4(a);n.sub(o),n.length()>.01?t._programID&=~s.LARGE_SCALE:(t._programID|=s.LARGE_SCALE,t._modelViewMatrix=null)}},h=function(){this.id=r++,this.name="",this.parent=void 0,this.children=[],this.up=new e.Vector3(0,1,0),this.position=new e.Vector3,this.rotation=new e.Vector3,this.eulerOrder=h.defaultEulerOrder,this.scale=new e.Vector3(1,1,1),this.worldCenter=new e.Vector3,this.worldRadius=0,this._ratioData=null,this._billboardData=null,this._programID=s.LARGE_SCALE,this.renderDepth=null,this.rotationAutoUpdate=!0,this.matrix=new e.Matrix4,this.matrixWorld=new e.Matrix4,this._matrixWorldForDoubleGPU=new e._Float32Matrix4,this._mElements=this._matrixWorldForDoubleGPU.elements,this.matrixRotationWorld=new e.Matrix4,this.modelViewInvTranspMatrix=null,this.modelViewInvMatrix=null,this.modelInvTranspMatrix=null,this._modelInvRotMatrix=null,this.matrixAutoUpdate=!0,this.matrixWorldNeedsUpdate=!0,this.quaternion=new e.Quaternion,this.useQuaternion=!1,this.visible=!0,this.visibilityFree=!1,this._castShadow=!1,this._receiveShadow=!1,this.applyBackgroundViewMode=!1,this._planeSpace=null,this._applyPlaneViewMode=!1,this._frustumCulled=!0,this.userData={},this.__webglActive=null,this.__webglInit=!1,this._modelViewMatrix=null,this._normalMatrix=null,this.orientation=0,this.boundingSphere=null,this.boundingBox=null,this.isUniformlyScaled=!0};new Float32Array(3);return h.prototype={constructor:h,_updateBackgroundViewMode(e){this.applyBackgroundViewMode=this._occurrence&&!this._occurrence._isAlwaysInForeground()&&this._occurrence.node.getLinkedToSceneGraph()&&this._occurrence.isInBackground()!==e},_computePlaneSpace(){let e=this.geometry;e.length||0===e.length||(e=[e]);let t=null;for(let r=0;r<e.length;r++){const n=e[r].drawingGroups;for(let e=0;e<n.length;e++){const r=n[e],a=i.FitPlaneSpace.compute(r.geometry,[r.start,r.start+r.count]);t=i.FitPlaneSpace.combine(t,a)}}return t||i.FitPlaneSpace.space_none()},_updatePlaneSpace(){this._planeSpace||(this._planeSpace=this._computePlaneSpace())},_canBeFittedByPlane(e){return this._updatePlaneSpace(),i.FitPlaneSpace.fit({plane:e,space:this._planeSpace,transform:this.matrixWorld})},_updatePlaneViewMode(e){this._applyPlaneViewMode=this._occurrence&&this._occurrence.node.getLinkedToSceneGraph()&&!this._canBeFittedByPlane(e)},applyMatrix:(l=new e.Matrix4,function(e){this.matrix.multiplyMatrices(e,this.matrix),this.position.getPositionFromMatrix(this.matrix),this.scale.getScaleFromMatrix(this.matrix),this.isUniformlyScaled=Math.abs(this.scale.x-this.scale.y)<1e-4&&Math.abs(this.scale.z-this.scale.y)<1e-4,this.isUniformlyScaled?this._programID&=~s.NON_UNIFORM_SCALE:this._programID|=s.NON_UNIFORM_SCALE,this._updateWorldCenterAndRadius(),l.extractRotation(this.matrix),!0===this.useQuaternion?this.quaternion.setFromRotationMatrix(l):this.rotation.setEulerFromRotationMatrix(l,this.eulerOrder)}),_getMMMatrix:function(){return this.matrixWorld},_getFilter:function(e){return this._occurrence?this._occurrence._getFilter(e):null},getFilterGeomType:function(){var e=this._getFilter(a._STATIC_GEOM_TYPE)||this._getFilter(a.GEOM_TYPE);return e?e._geomType:0},_updateWorldCenterAndRadius:function(){var t=this.matrixWorld,i=this.geometry&&this.geometry.boundingSphere;if(i?(this.worldCenter.copy(i.center),this.worldRadius=i.radius,this._billboardData&&0!==this._billboardData.type&&(this.worldRadius+=this.worldCenter.length(),this.worldCenter.set(0,0,0)),this._ratioData&&this._ratioData.ratio>0?(this._ratioData.center&&(this.worldRadius+=this._ratioData.center.length()/this._ratioData.ratio),this.worldRadius+=this.worldCenter.length(),this.worldRadius*=this._ratioData.ratio,this.worldCenter.set(0,0,0)):this.worldRadius*=t.getMaxScaleOnAxis()):(this.worldCenter.set(0,0,0),this.worldRadius=0),this.worldCenter.applyMatrix4(t),this._ratioData&&this._ratioData.ratio>0?this._programID|=s.FIXED_SIZE:this._programID&=~s.FIXED_SIZE,this._ratioData&&this._ratioData.center?this._programID|=s.FIXED_SIZE_CENTER:this._programID&=~s.FIXED_SIZE_CENTER,this._billboardData&&this._billboardData.type>=1?this._programID|=s.BILLBOARD:(this._modelInvRotMatrix=null,this._programID&=~s.BILLBOARD),this.geometry){var r=null,n=0;this.geometry.length>=0?(r=this.geometry[0],n=this.geometry.length):2===this.geometry._type&&(r=this.geometry,n=1);for(var a=0;a<n;a++){var o=this.geomWorldBE[a];r.boundingSphere&&(o||(this.geomWorldBE[a]={radius:0,center:new e.Vector3},o=this.geomWorldBE[a]),o.center.copy(r.boundingSphere.center),o.radius=r.boundingSphere.radius,this._billboardData&&0!==this._billboardData.type&&(o.radius+=o.center.length(),o.center.set(0,0,0)),this._ratioData&&this._ratioData.ratio>0?(this._ratioData.center&&(o.radius+=this._ratioData.center.length()/this._ratioData.ratio),o.radius+=o.center.length(),o.radius*=this._ratioData.ratio,o.center.set(0,0,0)):o.radius*=t.getMaxScaleOnAxis(),o.center.applyMatrix4(t)),r=this.geometry[a+1]}}},_removeFromAllStateSortingResults:function(){var e=this._tokens;if(e){for(var t in e)this._removeFromStateSortingResult(t);e={}}},_removeFromStateSortingResult:function(i){var r=this._tokens?this._tokens[i]:null;if(r){for(var n=0;n<r.length;++n){var a=r[n];if(this.isCurvedPipe){for(var s=!1,o=0;o<this.geometry.drawingGroups.length;o++){var l=this.id+"_"+o,c=e.InstancedCurvedPipeManager._perRenderableData.get(l);s=a.autoInstancingData.removeInstances(this.id,o,c)}if(!s)continue}var h=a.attachment;a.attachment=null,h.next=a.next,a.next&&(a.next.attachment=h),a.next=null;var u=h.tree;u&&null===h.next&&u.delete(h.sortId),a.instanced?t.prototype.releaseInstanced(a):t.prototype.release(a)}delete this._tokens[i]}},_flagAsGSSOInvalidated:function(){},_flagAsFrustumCulled:function(){},translate:(o=new e.Vector3,function(e,t){return o.copy(t),!0===this.useQuaternion?o.applyQuaternion(this.quaternion):o.applyEuler(this.rotation,this.eulerOrder),o.multiplyScalar(e),this.position.add(o),this}),translateX:function(){var t=new e.Vector3(1,0,0);return function(e){return this.translate(e,t)}}(),translateY:function(){var t=new e.Vector3(0,1,0);return function(e){return this.translate(e,t)}}(),translateZ:function(){var t=new e.Vector3(0,0,1);return function(e){return this.translate(e,t)}}(),lookAt:function(){var t=new e.Matrix4;return function(e){t.lookAt(e,this.position,this.up),!0===this.useQuaternion?this.quaternion.setFromRotationMatrix(t):this.rotation.setEulerFromRotationMatrix(t,this.eulerOrder)}}(),add:function(e,t){if(e!==this){if(e instanceof h){void 0!==e.parent&&e.parent.remove(e),e.parent=this,this.children.push(e);var i=this.getScene();i&&i.__addObject(e,t)}}else console.warn("Object3D.add: An object can't be added as a child of itself.")},remove:function(e){var t=this.children.indexOf(e);if(-1!==t){e.parent=void 0,this.children.splice(t,1);var i=this.getScene();i&&i.__removeObject(e)}},traverse:function(e){e(this);for(var t=0,i=this.children.length;t<i;t++)this.children[t].traverse(e)},traverseObject3DWithCondition:function(e){if(e(this))for(var t=0,i=this.children.length;t<i;t++)this.children[t].traverseObject3DWithCondition(e)},getChildByName:function(e,t){for(var i=0,r=this.children.length;i<r;i++){var n=this.children[i];if(n.name===e)return n;if(!0===t&&void 0!==(n=n.getChildByName(e,t)))return n}},getDescendants:function(e){void 0===e&&(e=[]),Array.prototype.push.apply(e,this.children);for(var t=0,i=this.children.length;t<i;t++)this.children[t].getDescendants(e);return e},updateMatrix:function(){if(this.matrix.setPosition(this.position),!1===this.useQuaternion?this.matrix.setRotationFromEuler(this.rotation,this.eulerOrder):this.matrix.setRotationFromQuaternion(this.quaternion),1===this.scale.x&&1===this.scale.y&&1===this.scale.z||this.matrix.scale(this.scale),this.isUniformlyScaled=Math.abs(this.scale.x-this.scale.y)<1e-4&&Math.abs(this.scale.z-this.scale.y)<1e-4,this.isUniformlyScaled?this._programID&=~s.NON_UNIFORM_SCALE:this._programID|=s.NON_UNIFORM_SCALE,this._updateWorldCenterAndRadius(),null!==this.modelInvTranspMatrix&&this.modelInvTranspMatrix.getInverse(this.matrixWorld).transpose(),null!==this._modelInvRotMatrix){var t=(new e.Matrix4).getInverse(this.matrixWorld);this._modelInvRotMatrix.extractRotation(t)}this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(t){if(!this.isRoot3ds){if(!0===this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldNeedsUpdate||!0===t){if(void 0===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this._updateWorldCenterAndRadius(),this._matrixWorldForDoubleGPU._fromMatrix4WithLowPartTranslation(this.matrixWorld),c(this),null!==this.modelInvTranspMatrix&&this.modelInvTranspMatrix.getInverse(this.matrixWorld).transpose(),null!==this._modelInvRotMatrix){var i=(new e.Matrix4).getInverse(this.matrixWorld);this._modelInvRotMatrix.extractRotation(i)}this.matrixWorldNeedsUpdate=!1,t=!0}for(var r=0,n=this.children.length;r<n;r++)this.children[r].updateMatrixWorld(t)}},clone:function(t){void 0===t&&(t=new h),t.name=this.name,t.up.copy(this.up),t.position.copy(this.position),t.rotation instanceof e.Vector3&&t.rotation.copy(this.rotation),t.eulerOrder=this.eulerOrder,t.scale.copy(this.scale),t.renderDepth=this.renderDepth,t.rotationAutoUpdate=this.rotationAutoUpdate,t.matrix.copy(this.matrix),t.matrixWorld.copy(this.matrixWorld),t._matrixWorldForDoubleGPU._fromMatrix4WithLowPartTranslation(t.matrixWorld),t.matrixRotationWorld.copy(this.matrixRotationWorld),t.matrixAutoUpdate=this.matrixAutoUpdate,t.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate,t.quaternion.copy(this.quaternion),t.useQuaternion=this.useQuaternion,t.visible=this.visible,t.visibilityFree=this.visibilityFree,t.castShadow=this.castShadow,t.receiveShadow=this.receiveShadow,t._programID=this._programID,t.frustumCulled=this.frustumCulled;for(var i=0;i<this.children.length;i++){var r=this.children[i];t.add(r.clone())}return t},getWebGLObjects:function(){return null},getScene:function(){return null!=this.parent?this.parent.getScene():null},getUniqueColor:function(){var t=Number(this.id).toString(16);return this.id>=4194303&&console.warn("max  number of pickingId values reached"),(t="000000".substr(0,6-t.length)+t).toUpperCase(),t="#"+t,new e.Color(t)},recompileShaders:function(e){var t,i;for(t=0,i=this.children.length;t<i;t++)this.children[t].recompileShaders(e)},getMeshInstances:function(){if(!this.parent)return[];for(var e=this;void 0!==e.parent;)e=e.parent;return e.getMeshInstances()},containsLensFlare:function(t){if(t instanceof e.LensFlare){var i=this.getScene();if(i&&i.__webglFlares&&-1!==i.__webglFlares.indexOf(t))return!0}return!1},containsLight:function(t){if(t instanceof e.Light){var i=this.getScene();if(i&&-1!==i.__lights.indexOf(t))return!0}return!1},containsMesh:function(t){if(t instanceof e.Mesh||t instanceof e.CSS2DNode){var i=this.getScene();if(i&&i.__objects.has(t))return!0}return!1},containsObject:function(e){for(var t=this;void 0!==t.parent;)t=t.parent;var i=e.parent;if(void 0===i)return!1;for(;void 0!==i.parent;)i=i.parent;return i===t},setMatrix:function(t,i){if(this.matrix=t,t){this.scale.getScaleFromMatrix(this.matrix);var r=n.extractRotation(this.matrix);this.rotation.setEulerFromRotationMatrix(r,this.eulerOrder),this.position.getPositionFromMatrix(this.matrix)}else this.scale.set(1,1,1),this.rotation.set(0,0,0),this.position.set(0,0,0);this.isUniformlyScaled=Math.abs(this.scale.x-this.scale.y)<1e-4&&Math.abs(this.scale.z-this.scale.y)<1e-4,this.isUniformlyScaled?this._programID&=~s.NON_UNIFORM_SCALE:this._programID|=s.NON_UNIFORM_SCALE,!1===i?(this.matrixWorldNeedsUpdate=!1,this.matrixWorld=this.matrix||e.IdentityMatrix):this.matrixWorldNeedsUpdate=!0,this._updateWorldCenterAndRadius(),this._matrixWorldForDoubleGPU._fromMatrix4WithLowPartTranslation(this.matrixWorld),c(this),null!==this.modelInvTranspMatrix&&this.modelInvTranspMatrix.getInverse(this.matrixWorld).transpose()},getLookAt:function(){var t=this._getMMMatrix().elements;return new e.Vector3(-t[8],-t[9],-t[10])},cloneSimple:function(t){return void 0===t&&(t=new h),t.name=this.name,t.up.copy(this.up),t.position.copy(this.position),t.rotation instanceof e.Vector3&&t.rotation.copy(this.rotation),t.eulerOrder=this.eulerOrder,t.scale.copy(this.scale),t.renderDepth=this.renderDepth,t.rotationAutoUpdate=this.rotationAutoUpdate,t.matrix.copy(this.matrix),t.matrixWorld.copy(this.matrixWorld),t._matrixWorldForDoubleGPU._fromMatrix4WithLowPartTranslation(t.matrixWorld),t.matrixRotationWorld.copy(this.matrixRotationWorld),t.matrixAutoUpdate=this.matrixAutoUpdate,t.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate,t.quaternion.copy(this.quaternion),t.useQuaternion=this.useQuaternion,t.visible=this.visible,t.visibilityFree=this.visibilityFree,t._noZPriority=this._noZPriority,t._programID=this._programID,t.castShadow=this.castShadow,t.receiveShadow=this.receiveShadow,t.frustumCulled=this.frustumCulled,t.isUniformlyScaled=this.isUniformlyScaled,t},_isDecal:function(){return!1},_isReceivingDecal:function(){return!1},_isInDecalPass:function(){return!1}},Object.defineProperty(h.prototype,"receiveShadow",{get:function(){if(this._occurrence){var e=this._occurrence._getShadow()[1];return null===e?this._receiveShadow:e}return this._receiveShadow},set:function(e){this._receiveShadow=e}}),Object.defineProperty(h.prototype,"castShadow",{get:function(){if(this._occurrence){var e=this._occurrence._getShadow()[0];return null===e?this._castShadow:e}return this._castShadow},set:function(e){this._castShadow=e}}),Object.defineProperty(h.prototype,"frustumCulled",{set:function(e){this._flagAsFrustumCulled(e),this._frustumCulled=e},get:function(){return this._frustumCulled}}),h.defaultEulerOrder="XYZ",h}),define("DS/Object3D/Camera",["DS/Mesh/ThreeJS_Base","DS/Object3D/Object3D"],function(e,t){"use strict";var i,r="undefined"!=typeof EXPERIENCE_PLAYER,n=window.SIMULATE_EXPERIENCE_PLAYER,a={NONE:0,PRINCIPAL:1,REFLECTED:2,BACKGROUND:3,ROBOT_CONNECTED:4,ROBOT_ORTHO:5,FULL_SCREEN:6,STEREO:7,STEREO_BACKGROUND:8,STEREO_REFLECTED:9},s=function(){t.call(this),this.matrixWorldInverse=new e.Matrix4,this.projectionMatrix=new e.Matrix4,this.projectionMatrixInverse=new e.Matrix4,this.realProjectionMatrixInverse=new e.Matrix4,this.pixelCulling=4.5,this.isOrtho=!1,this._hasChanged=!0,this.externalProjectionMatrix=!1,this.fixedSizeCameraConstant=1,this.pixelCullingCst=0,this._cstLOD=0,this._viewpoint=null,this.aspect=1,this._renderingRole=a.NONE};(s.prototype=Object.create(t.prototype))._setBackgroundRenderingRoleFromPrincipal=function(e){switch(e._renderingRole){case a.STEREO:this._renderingRole=a.STEREO_BACKGROUND;break;case a.PRINCIPAL:default:this._renderingRole=a.BACKGROUND}},s.prototype._setReflectedRenderingRoleFromPrincipal=function(e){switch(e._renderingRole){case a.STEREO:this._renderingRole=a.STEREO_REFLECTED;break;case a.PRINCIPAL:default:this._renderingRole=a.REFLECTED}},s.prototype.clone=function(e){return void 0===e&&(e=new s),t.prototype.cloneSimple.call(this,e),e.matrixWorldInverse.copy(this.matrixWorldInverse),e.projectionMatrix.copy(this.projectionMatrix),e.projectionMatrixInverse.copy(this.projectionMatrixInverse),e.fixedSizeCameraConstant=this.fixedSizeCameraConstant,e.pixelCullingCst=this.pixelCullingCst,e._viewpoint=this._viewpoint,e.aspect=this.aspect,e.pixelCulling=this.pixelCulling,e},s.prototype.lookAt=(i=new e.Matrix4,function(e){i.lookAt(this.position,e,this.up),!0===this.useQuaternion?this.quaternion.setFromRotationMatrix(i):this.rotation.setEulerFromRotationMatrix(i,this.eulerOrder)}),s.prototype.setViewOffsetInternal=function(e,t,i,r,n,a,s,o){(this.fullWidth!=e||this.fullHeight!=t||this.x!=i||this.y!=r||this.width!=n||this.height!=a||this.pickingRatio)&&(this.fullWidth=e,this.fullHeight=t,this.x=i,this.y=r,this.width=n,o||(s&&this.height?this.visualizedHeight=this.height:this.visualizedHeight=0,this._hasChanged=!0),s?(this.pickingRatioW=s.ratioW,this.pickingRatioH=s.ratioH):(this.pickingRatioW=null,this.pickingRatioH=null),this.height=a,this.realProjectionMatrixInverse=this.projectionMatrixInverse.clone(),this.updateProjectionMatrix())},s.prototype.setViewOffset=function(e,t,i,r,n,a){console.warn("deprecated ! use viewpoint.setViewOffset instead"),this.setViewOffsetInternal(e,t,i,r,n,a)};var o=function(e,t,i,r,n,a){s.call(this),this.left=e,this.right=t,this.top=i,this.bottom=r,this.near=void 0!==n?n:.1,this.far=void 0!==a?a:2e3,this.fov=45,this.isOrtho=!0,this.updateProjectionMatrix(),this.visualizedHeight=400};(o.prototype=Object.create(s.prototype)).clone=function(e){return void 0===e&&(e=new o),s.prototype.clone.call(this,e),this.fullWidth?(e.fullWidth=this.fullWidth,e.fullHeight=this.fullHeight,e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height):(e.fullWidth&&delete e.fullWidth,e.fullHeight&&delete e.fullHeight),e.left=this.left,e.right=this.right,e.top=this.top,e.bottom=this.bottom,e.near=this.near,e.far=this.far,this.visualizedHeight&&(e.visualizedHeight=this.visualizedHeight),e.updateProjectionMatrix(),e},o.prototype.getCameraConstant=function(e,t){return e*(this.top-this.bottom)/(t||1)},o.prototype.getWorldSizeFromPixelSize=function(e,t,i){return e*(this.top-this.bottom)/(i||1)},o.prototype.updateProjectionMatrix=function(e,t){var i=Math.abs(this.right-this.left),r=Math.abs(this.top-this.bottom),n=e||0,a=t||0;if(this.fullWidth){this.aspect=this.fullWidth/this.fullHeight;var s=this.fullWidth/this.fullHeight,o=this.top,l=o-r,c=s*l,h=s*o;i=Math.abs(h-c),r=Math.abs(o-l);this.projectionMatrix.makeOrthographic(c+(this.x+n*this.width)/this.fullWidth*i,c+(this.x+(1+n)*this.width)/this.fullWidth*i,o-(this.y+a*this.height)/this.fullHeight*r,o-(this.y+(1+a)*this.height)/this.fullHeight*r,this.near,this.far)}else this.projectionMatrix.makeOrthographic(this.left+n*i,this.right+n*i,this.top+a*r,this.bottom+a*r,this.near,this.far);this.projectionMatrixInverse.getInverse(this.projectionMatrix)},o.prototype.setVisualizedHeight=function(e,t,i){this.fov=i||(this.fov?this.fov:45);var r=this.visualizedHeight;this.visualizedHeight=e?2*e*Math.tan(Math.PI*this.fov/360):this.visualizedHeight?this.visualizedHeight:400,this.visualizedHeight!==r&&(this._hasChanged=!0),this.aspect=t||(this.aspect?this.aspect:1),this.top=this.visualizedHeight/2,this.bottom=-this.top,this.left=this.aspect*this.bottom,this.right=-this.left,this.updateProjectionMatrix()},o.prototype.setViewportInfos=function(e,t,i,r){e==this.top&&t==this.bottom&&i==this.left&&r==this.right||(this._hasChanged=!0,this.top=e,this.bottom=t,this.left=i,this.right=r,this.updateProjectionMatrix())};var l=function(e,t,i,r){s.call(this),this.fov=void 0!==e?e:50,this.aspect=void 0!==t?t:1,this.near=void 0!==i?i:.1,this.far=void 0!==r?r:2e3,this.offsetX=0,this.offsetY=0,this.sensorSizeHeight=24,this.sensorSizeWidth=36,this.focalLength=.5*this.sensorSizeHeight/Math.tan(this.fov*Math.PI/360),this.aperture=.9,this.blades=0,this.updateProjectionMatrix()};return(l.prototype=Object.create(s.prototype)).clone=function(e){return void 0===e&&(e=new l),s.prototype.clone.call(this,e),e.fov=this.fov,e.aspect=this.aspect,e.near=this.near,e.far=this.far,e.externalProjectionMatrix=this.externalProjectionMatrix,e.sensorSizeHeight=this.sensorSizeHeight,e.sensorSizeWidth=this.sensorSizeWidth,e.focalLength=this.focalLength,e.aperture=this.aperture,e.blades=this.blades,this.fullWidth?(e.fullWidth=this.fullWidth,e.fullHeight=this.fullHeight,e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height):(e.fullWidth&&delete e.fullWidth,e.fullHeight&&delete e.fullHeight),e.updateProjectionMatrix(),e},l.prototype.setLens=function(t,i,r){i&&i.length&&(this.sensorSizeHeight=i[1],this.sensorSizeWidth=i[0]),this.focalLength=t||this.focalLength,this.fov=r?2*e.Math.radToDeg(Math.atan(this.sensorSizeWidth/(2*this.focalLength))):2*e.Math.radToDeg(Math.atan(this.sensorSizeHeight/(2*this.focalLength))),this.updateProjectionMatrix()},l.prototype.setAperture=function(e,t){this.aperture=e,this.blades=void 0!==t?t:0},l.prototype.getCameraConstant=function(e,t){return 2*Math.tan(.5*this.fov*Math.PI/180)*e/(t||1)},l.prototype.getWorldSizeFromPixelSize=function(e,t,i){var r=this.matrixWorldInverse.elements;return 2*Math.abs(r[2]*t.x+r[6]*t.y+r[10]*t.z+r[14])*Math.tan(.5*this.fov*Math.PI/180)*e/(i||1)},l.prototype.performPixelAndFrustumCullingOnGeometry=function(e,t,i,r){if(2!==r._type||!i.frustumCulled)return!0;var n=r===i.geometry?r:i.geometry.indexOf(r),a=i.geomWorldBE[n];if(!a)return!0;var s=a.center,o=a.radius,l=this.pixelCulling,c=this.matrixWorldInverse.elements;if(l>0){var h=l;if(!i._ratioData||0===i._ratioData.ratio){var u=Math.abs(c[2]*s.x+c[6]*s.y+c[10]*s.z+c[14]);h=this.pixelCullingCst*u}if(o<h)return!1}var d=o;if(i._ratioData&&i._ratioData.ratio>0){u=Math.abs(c[2]*s.x+c[6]*s.y+c[10]*s.z+c[14]);d*=this.fixedSizeCameraConstant*u}return e.performFrustumCulling(d,s)},l.prototype.performPixelCullingOnDG=function(e,t,i,a,s,o){if(r&&!EXPERIENCE_PLAYER||!r&&!n){var l=t.geometry.indexOf(i),c=t.geomWorldBE[l];if(!c)return o;if(this.pixelCulling>0){var h=c.center,u=c.radius,d=0,p=a.cullingData.length-1,f=this.matrixWorldInverse.elements,m=this.pixelCulling,g=!t._ratioData||0===t._ratioData.ratio,v=t.matrixWorld.getMaxScaleOnAxis(),S=t._ratioData.ratio/v;if(g){var _=Math.abs(f[2]*h.x+f[6]*h.y+f[10]*h.z+f[14])-u;m=this.pixelCullingCst*_}for(;p-d>1;){var y=Math.floor(.5*(d+p));(P=a.cullingData[y]).start;if(P.start<s&&(d=y),P.start>s+o)return o;var x=P.radius*v;g||(x*=S),x<m?p=y:d=y}var M=p;if(d!==p){x=(P=a.cullingData[d]).radius*v;g||(x*=S),x<m&&(M=d)}if(M<a.cullingData.length-1){var P=a.cullingData[M];return Math.max(P.start-s,0)}x=(P=a.cullingData[M]).radius*v;if(g||(x*=S),x<m)return Math.max(P.start-s,0)}return o}},l.prototype.updateProjectionMatrix=function(t,i){if(!this.externalProjectionMatrix){var r=t||0;r+=this.offsetX?this.offsetX:0;var n=i||0;if(n+=this.offsetY?this.offsetY:0,this.fullWidth){var a=this.fullWidth/this.fullHeight,s=a*(u=-(h=Math.tan(e.Math.degToRad(.5*this.fov))*this.near)),o=a*h,l=Math.abs(o-s),c=Math.abs(h-u);this.projectionMatrix.makeFrustum(s+(this.x+r*this.width)/this.fullWidth*l,s+(this.x+(1+r)*this.width)/this.fullWidth*l,h-(this.y+(1+n)*this.height)/this.fullHeight*c,h-(this.y+n*this.height)/this.fullHeight*c,this.near,this.far)}else if(this._viewpoint&&this._viewpoint._nativeTranslationOffset){var h,u=-(h=Math.tan(e.Math.degToRad(.5*this.fov))*this.near);s=this.aspect*u,o=this.aspect*h,l=Math.abs(o-s),c=Math.abs(h-u);this.projectionMatrix.makeFrustum(s+this._viewpoint._nativeTranslationOffset.x*this.near,o+this._viewpoint._nativeTranslationOffset.x*this.near,u+this._viewpoint._nativeTranslationOffset.y*this.near,h+this._viewpoint._nativeTranslationOffset.y*this.near,this.near,this.far)}else this.projectionMatrix.makePerspective(this.fov,this.aspect,this.near,this.far,r,n);this.projectionMatrixInverse.getInverse(this.projectionMatrix)}},{_CameraRoles:a,_FrameTypes:{MAIN:0,GPU_INTERSECTION:1,GPU_INTERSECTION_SMALL:2,COLLISION:3},BaseCamera:s,OrthographicCamera:o,PerspectiveCamera:l}}),define("DS/Visualization/OutlineBuilder",["DS/Mesh/Mesh","DS/Visualization/GeometryProcessing"],function(e,t){"use strict";var i;class r{constructor(e){this.type=e,this.array=null}get(e=0){return(!this.array||this.array.length<e)&&(this.array=new this.type(this._alloc_size(e))),0===e?new this.type(this.array.buffer):new this.type(this.array.buffer,0,e)}realloc(e=0){if(!this.array)return this.get(e);if(0===e||this.array.length<e){const t=new this.type(this._alloc_size(e));t.set(this.array),this.array=t}return 0===e?new this.type(this.array.buffer):new this.type(this.array.buffer,0,e)}_alloc_size(e){return Math.max(this.array?2*this.array.length:10,e)}}new r(Uint32Array),new r(Uint32Array);function n({geom:e,adjTri2Tri:t,index_ranges:i=null}){const r=e.vertexIndexArray,n=e.vertexPositionArray;function a(e){const t=3*r[e+0],i=3*r[e+1],a=3*r[e+2],s=n[t],o=n[t+1],l=n[t+2],c=n[i],h=n[i+1],u=n[i+2],d=n[a]-s,p=n[a+1]-o,f=n[a+2]-l,m=c-s,g=h-o,v=u-l;return[p*v-f*g,f*m-d*v,d*g-p*m]}let s=[];function o(e,i,r){const n=t[i+r];n&&(function(e,t){const i=e[1]*t[2]-e[2]*t[1],r=e[2]*t[0]-e[0]*t[2],n=e[0]*t[1]-e[1]*t[0];return 0===i&&0===r&&0===n}(e,a(n-1>>>2))||s.push(4*i+r))}for(let e=0;e<i.length;e++){const t=i[e][0],r=i[e][1];for(let e=t;e<r;e+=3){const t=a(e);o(t,e,0),o(t,e,1),o(t,e,2)}}return new Uint32Array(s)}function a(e,t,i,r,n,a,s,o){for(let l=i;l<r;l+=3){const i=3*t[l],r=3*t[l+1],c=3*t[l+2],h=e[i],u=e[i+1],d=e[i+2],p=e[r],f=e[r+1],m=e[r+2],g=e[c]-h,v=e[c+1]-u,S=e[c+2]-d,_=p-h,y=f-u,x=m-d,M=n*(v*x-S*y)+a*(S*_-g*x)+s*(g*y-v*_);o[l+1]=M<0?-1:M>0?1:0}}const s=new r(Int8Array);new r(Uint32Array);const o=new r(Uint32Array);function l(e,i,r,l){const c=performance.now();let h=e.__deduplication;h||(h=e.__deduplication=t.deduplicateVerticesExactMatch(e.vertexPositionArray,e.compressedVertices?2:3));const u=performance.now();e.__segmentEdges||(e.__segmentEdges=new Map);let d=e.__segmentEdges.get(r);if(!d){const a=t.computeAdjacencyTriangleToTriangle({geom:e,index_ranges:i,deduplication:h,bijective:!1,result:e.__adjTri2Tri});d={boundary:t.extractBoundaryEdges(a.boundary,e.vertexIndexArray),inner:n({geom:e,adjTri2Tri:a.adjacency,index_ranges:i})},e.__adjTri2Tri=a.adjacency,e.__segmentEdges.set(r,d)}const p=e.__adjTri2Tri,f=performance.now(),m=function({geom:e,view_direction:t,index_ranges:i}){const r=e.vertexIndexArray,n=e.vertexPositionArray,o=s.get(e.vertexIndexArray.length);for(let e=0;e<i.length;e++)a(n,r,i[e][0],i[e][1],t.x,t.y,t.z,o);return o}({geom:e,view_direction:l,index_ranges:i}),g=performance.now(),v=function({indices:e,adjTri2Tri:t,grouped_edges:i,tri_visibility:r}){let n=o.get(),a=0;function s(t){a+1>=n.length&&(n=o.realloc());const i=t>>>2,r=t%4;n[a++]=e[i+r],n[a++]=e[i+(r+1)%3]}const l=i.boundary,c=l.length;if(c>0)for(let e=0;e<c;e++)a>=n.length&&(n=o.realloc()),n[a++]=l[e];const h=i.inner,u=h.length;for(let e=0;e<u;e++){const i=h[e],n=i>>>2,a=t[n+i%4],o=a-1>>>2;a&&r[n+1]*r[o+1]<=0&&s(i)}return n.slice(0,a)}({indices:e.vertexIndexArray,adjTri2Tri:p,grouped_edges:d,index_ranges:i,tri_visibility:m}),S=performance.now();return window.time_outlines.dedup+=u-c,window.time_outlines.adj+=f-u,window.time_outlines.visibility+=g-f,window.time_outlines.outlines+=S-g,v}function c(e,t,r=!1){let n=new Map;function a(e,t,i,r){const a=n.get(e),s=a.get(t);s?s.push([i,i+r]):a.set(t,[[i,i+r]])}function s(e){n.get(e)||n.set(e,new Map)}if(e.layer)for(let r=0;r<e.layer.layers.length;r++){const n=e.layer.layers[r].drawableGroup,o=e.layer.layers[r].drawableInterval;o.skip(e,t)||(s(n.geometry),n._geomType===i.GeomTypeEnum.FACE&&a(n.geometry,0,o.start,o.count))}else{const t=e.geometry.length;for(let r=0;r<t;r++){const t=e.geometry[r];s(t);for(let e=0;e<t.drawingGroups.length;e++){const r=t.drawingGroups[e];if(r._geomType!==i.GeomTypeEnum.FACE)continue;const n=r.getPrimitivesCount();for(let e=0;e<n;e++){const i=r.getPrimitiveRep(e);a(t,i?i.cgmId:0,r.getPrimitiveStart(e),r.getPrimitiveCount(e))}0===n&&a(t,0,r.start,r.count)}}}const o=[];return n.forEach((e,t)=>{const i=[];e.forEach((e,t)=>i.push({ranges:function(e){if(e.length<2)return e;e.sort((e,t)=>e[0]-t[0]);let t=0;for(let i=1;i<e.length;i++){const r=e[t],n=e[i];n[0]>r[1]?e[++t]=n:n[1]>r[1]&&(r[1]=n[1])}return e.length=t+1,e}(e),id:t})),(r||i.length>0)&&o.push({geom:t,components:i})}),o.sort((e,t)=>e.geom.id-t.geom.id),o}function h(e,t,i=!1){let r=e.__outline_segments;return r||(r=e.__outline_segments=c(e,t,i)),r}function u({geom:e,new_indices:t=null,gl:i}){if(t){e.indexBufferGPU&&e.indexBufferGPU.numIndices<t.length?(e.indexBufferGPU.deallocate(i),e.indexBufferGPU=null):(e.markIndexStale(0,t.length),e.vertexBufferGPU&&(e.vertexBufferGPU.needsUpdate=!0)),e.vertexIndexArray=t;const r=e.drawingGroups[0];r.count=r._primitives[0].count=e.vertexIndexArray.length,e.wideLinesLinker&&e.wideLinesLinker.linkedGeometry.dispose()}return e}function d({width:e,color:t="#000000",show_hidden:r=!1,polite_color:n="#aaaaaa"}){const a=new i.Color(t),s=new i.Color(n),o={ProcessClipSpacePosition:"void ProcessClipSpacePosition(inout vec4 pos)\n\t\t\t\t{\n\t\t\t\t\t#ifndef USE_WIDELINE\n\t\t\t\t\t\tcP = pos;\n\t\t\t\t\t#else\n\t\t\t\t\t\tcP = vGetProjectionMatrix() * vGetWorldViewMatrix() * vec4(vGetAttribPosition(), 1.0);\n\t\t\t\t\t#endif\n\t\t\t\t}"},l=r?{ComputeAlbedo:`vec3 ComputeAlbedo()\n\t\t\t{\n\t\t\t\tbool occluded = correctZFighting();\n\t\t\t\tgl_FragDepthEXT = occluded ? 0.001 : 0.0;\n\t\t\t\treturn occluded ? vec3(${s.r}, ${s.g}, ${s.b}) : vec3(${a.r}, ${a.g}, ${a.b});\n\t\t\t}`}:{ComputeDiscard:"bool ComputeDiscard() { return correctZFighting(); }"};let c=new i.LineBasicMaterial({color:a,lineWidth:e,depthTest:r,force:!0});return c.activatePDSFX(),c.setPDSFXGlobalShaderCode("","\n\t\t\t#ifdef RENDER_TO_FLOAT_TEXTURE\n\n\t\t\t\tvec4 getNormalDepth(in vec2 coord)\n\t\t\t\t{\n\t\t\t\t\tvec4 res = texture2D( depthBuffer, coord );\n\t\t\t\t\tvec3 normal = normalize(2.0 * res.xyz - 1.0);\n\t\t\t\t\tfloat depth = res.w;\n\t\t\t\t\tif (depth < 0.01) depth = 1.0;\n\t\t\t\t\treturn vec4(normal,depth);\n\t\t\t\t}\n\n\t\t\t\tfloat getPolygonOffset(in vec2 coord,in vec3 vN, in float depth)\n\t\t\t\t{\n\t\t\t\t\tmat4 P = projectionMatrix;\n\t\t\t\t\tbool isPersp = P[2][3] == -1.0;\n\n\t\t\t\t\tfloat slopeFactor = isPersp ? 1.0 : 0.1;\n\n\t\t\t\t\tvec2 sr = vec2(2.0)/depthMapSize;\n\t\t\t\t\tvec2 vC = (gl_FragCoord.xy - 0.5) / depthMapSize;\n\t\t\t\t\tvC = 2.0*vC - 1.0;\n\n\t\t\t\t\tfloat K = dot(vec3(P[1][1] * (vC.x + P[2][0]), P[0][0] * (vC.y + P[2][1]), -P[0][0] * P[1][1]), vN);\n\t\t\t\t\tvec2 offset = vec2(P[1][1] * vN.x*sr.x, P[0][0] * vN.y*sr.y);\n\n\t\t\t\t\tfloat factor = (-depth - 0.5 * (P[2][2] - 1.0)) / K;\n\t\t\t\t\tfloat dFdxOfZ = abs(offset.x * factor);\n\t\t\t\t\tfloat dFdyOfZ = abs(offset.y * factor);\n\n\t\t\t\t\tfloat slope = max(dFdxOfZ, dFdyOfZ);\n\t\t\t\t\tslope = min(max(slope, 1e-6), 1e-3);\n\n\t\t\t\t\treturn (slope * slopeFactor) + (DEPTH_PRECISION * 1.5);\n\t\t\t\t}\n\n\t\t\t\tfloat getOffsetedDepth(in vec2 coord)\n\t\t\t\t{\n\t\t\t\t\tvec4 nDepth = getNormalDepth(coord);\n\t\t\t\t\tfloat offset = getPolygonOffset(coord,nDepth.xyz,nDepth.w);\n\t\t\t\t\treturn nDepth.w + offset;\n\t\t\t\t}\n\n\t\t\t\tfloat getDepth(in vec2 coord) { return getOffsetedDepth(coord); }\n\n\t\t\t#else\n\n\t\t\t\tfloat getDepth(in vec2 coord)\n\t\t\t\t{\n\t\t\t\t\tvec4 rgba_depth = texture2D( depthBuffer, coord );\n\t\t\t\t\tfloat depth = unpackRGBA(rgba_depth);\n\t\t\t\t\treturn depth > 1e-6 ? depth + 1.0* DEPTH_PRECISION : 1.0;\n\t\t\t\t}\n\n\t\t\t#endif\n\n\t\t\tfloat depthSampleTest(in vec2 coord, in float depth)\n\t\t\t{\n\t\t\t\tfloat fDepth = getDepth(coord);\n\t\t\t\treturn fDepth < depth ? 1.0 : 0.0;\n\t\t\t}\n\n\t\t\tbool correctZFighting()\n\t\t\t{\n\t\t\t\tvec2 coord  = 0.5 + 0.5 * cP.xy / cP.w;\n\t\t\t\tfloat depth = 0.5 + 0.5 * cP.z / cP.w - 0.00002;\n\n\t\t\t\tfloat dx0 = -0.5 / depthMapSize.x;\n\t\t\t\tfloat dy0 = -0.5 / depthMapSize.y;\n\t\t\t\tfloat dx1 = -dx0;\n\t\t\t\tfloat dy1 = -dy0;\n\n\t\t\t\tif(depth <= getDepth(coord)) return false;\n\n\t\t\t\tfloat num_closer = 0.0;\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( dx0, dy0 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( 0.0, dy0 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( dx1, dy0 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( dx0, 0.0 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( dx1, 0.0 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( dx0, dy1 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( 0.0, dy1 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( dx1, dy1 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer /= 8.0;\n\n\t\t\t\t// if at this point enough tests failed, discard\n\t\t\t\treturn num_closer > 0.8;\n\t\t\t}"),c.setPDSFXOverridableFunctions(o,l),c.setPDSFXUniforms({depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new i.Vector2(.01,.01)}}),c.setPDSFXVaryings({cP:{type:"v4"}}),c._refreshPDSFXUniforms_private=function(e,t){e.requestRealDepthBuffer(),e.dBuffer&&(c.updatePDSFXUniform("depthBuffer",e.dBuffer),c.updatePDSFXUniform("depthMapSize",new i.Vector2(e.dBuffer.width,e.dBuffer.height)))},c}window.time_outlines={dedup:0,adj:0,visibility:0,outlines:0,total:0,old_setup:0,old_add_edges:0,old_sort_edges:0,old_process_edges:0,old_total:0,print_cpu:function(e=10){const t=t=>t.toFixed(1).padStart(e),i=["dedup".padStart(e),"adj".padStart(e),"visibility".padStart(e),"outlines".padStart(e),"total".padStart(e)].join(" / "),r=[t(this.dedup),t(this.adj),t(this.visibility),t(this.outlines),t(this.total)].join("   ").replaceAll(".",",");console.log(`Outline statistics (CPU):\n${i}\n${r}\n\n`)},print_gpu:function(e=10){const t=t=>t.toFixed(1).padStart(e),i=["setup".padStart(e),"add".padStart(e),"sort".padStart(e),"process".padStart(e),"total".padStart(e)].join(" / "),r=[t(this.old_setup),t(this.old_add_edges),t(this.old_sort_edges),t(this.old_process_edges),t(this.old_total)].join("   ").replaceAll(".",",");console.log(`Outline statistics (GPU):\n${i}\n${r}\n\n`)},print:function(e=10){this.print_cpu(e),this.print_gpu(e)}};let p=null,f=null;function m({width:e,showHiddenOutlines:t}){t&&!f?f=d({width:e,show_hidden:!0}):t||p||(p=d({width:e,show_hidden:!1}));const i=t?f:p;return i.setLineWidth(e),i}var g=function(e){for(var t=1;t<e;)t*=2;return t};class v{constructor(e){this._renderable=e,this.indexArray=null,this.firstIndicesArray=null,this.lastIndexArray=null,this._Id=0,this._edgeId=0,this.width=1}createNewGeometry(e){const t=THREEDS.Core,i=this.createMaterial(),r=this.createDg(i),n=new t.BufferGeometryDS;return n.drawingGroups=[],r.geometry=n,n.drawingGroups.push(r),n.vertexPositionArray=this.firstIndicesArray,n.vertexNormalArray=this.lastIndexArray,n.vertexIndexArray=this.indexArray,n.boundingSphere=this._renderable.boundingSphere,n.boundingBox=this._renderable.boundingBox,y.TexturesManager.addGeometriesOfRenderable(this._renderable,e),n}}class S extends v{constructor(e){super(e),this.width=1}initArrays(){this.indexArray=[],this.firstIndicesArray=[],this.lastIndexArray=[]}createFinalArrays(){this.indexArray=new Uint32Array(this.indexArray),this.firstIndicesArray=new Float32Array(this.firstIndicesArray),this.lastIndexArray=new Float32Array(this.lastIndexArray)}addFullEdgeIndices(e,t,i,r){const n=this.firstIndicesArray,a=this.lastIndexArray,s=this._edgeId;n[6*s]=e,n[6*s+1]=t,n[6*s+2]=i,n[6*s+3]=t,n[6*s+4]=e,n[6*s+5]=r,a[6*s]=r,a[6*s+1]=0,a[6*s+2]=0,a[6*s+3]=i,a[6*s+4]=0,a[6*s+5]=0,this._edgeId++}createMaterial(){return y.TexturesManager.createSimpleMaterial()}createDg(t){const i=this.firstIndicesArray.length/3,r=THREEDS.Core,n=new e.DrawingGroup(t,t,1,0,i,void 0,void 0,r.GeomTypeEnum._OUTLINE);return n.nonIndexed=!0,n}}class _ extends v{constructor(e,t){super(e),this.width=t,this.curr_Id=0}initArrays(){this.indexArray=[],this.firstIndicesArray=[],this.lastIndexArray=[]}createFinalArrays(){this.indexArray=new Uint32Array(this.indexArray),this.firstIndicesArray=new Float32Array(this.firstIndicesArray),this.lastIndexArray=new Float32Array(this.lastIndexArray)}addFullEdgeIndices(e,t,i,r){const n=this.indexArray,a=this.firstIndicesArray,s=this.lastIndexArray;n[this._Id++]=this.curr_Id,n[this._Id++]=this.curr_Id+1,n[this._Id++]=this.curr_Id+2,n[this._Id++]=this.curr_Id+2,n[this._Id++]=this.curr_Id+1,n[this._Id++]=this.curr_Id+3,this.curr_Id+=4;const o=this._edgeId;a[12*o]=e,a[12*o+1]=t,a[12*o+2]=i,a[12*o+3]=t,a[12*o+4]=e,a[12*o+5]=r,a[12*o+6]=e,a[12*o+7]=t,a[12*o+8]=i,a[12*o+9]=t,a[12*o+10]=e,a[12*o+11]=r,s[12*o]=r,s[12*o+1]=-1,s[12*o+2]=0,s[12*o+3]=i,s[12*o+4]=2,s[12*o+5]=0,s[12*o+6]=r,s[12*o+7]=1,s[12*o+8]=0,s[12*o+9]=i,s[12*o+10]=-2,s[12*o+11]=0,this._edgeId++}createMaterial(){return y.TexturesManager.createWideMaterial(.5*this.width)}createDg(t){const i=this.indexArray.length,r=THREEDS.Core;return new e.DrawingGroup(t,t,4,0,i,void 0,void 0,r.GeomTypeEnum._OUTLINE)}}class y{constructor(e,t,i,r){this._renderable=e,this._oGeometry=1===t?new S(e):new _(e,t),y.TexturesManager.sortCount!==i&&(y.TexturesManager.clean(r),y.TexturesManager.sortCount=i)}computeOutlineGeometry(e){const i=performance.now();this._oGeometry.initArrays();const r=c(this._renderable,e,!0);if(0===r.length)return null;let a=0;for(let e=0;e<r.length;e++){const i=r[e],l=i.geom;l.__adjTri2Tri=null;const c=(e,t,i,r)=>{e!==t&&e!==i&&e!==r&&t!==i&&t!==r&&this._oGeometry.addFullEdgeIndices(a+e,a+t,a+i,a+r)};let h=l.__deduplication;h||(h=l.__deduplication=t.deduplicateVerticesExactMatch(l.vertexPositionArray,l.compressedVertices?2:3));const u=l.vertexIndexArray,d=e=>h[u[e]];function s(e,t){const i=e>>>2,r=e%4,n=t[i+r]-1,a=n>>>2,s=n%4;c(d(i+r),d(i+(r+1)%3),d(i+(r+2)%3),d(a+(s+2)%3))}function o(e){const t=e>>>2,i=e%4,r=d(t+(i+2)%3);c(d(t+i),d(t+(i+1)%3),r,r)}for(let e=0;e<i.components.length;e++){const r=i.components[e].ranges,a=t.computeAdjacencyTriangleToTriangle({geom:l,index_ranges:r,deduplication:h,bijective:!1,result:l.__adjTri2Tri});l.__adjTri2Tri=a.adjacency;{let e=a.boundary.values(),t=e.next();for(;!t.done;)o(t.value),t=e.next()}n({geom:l,adjTri2Tri:a.adjacency,index_ranges:r}).forEach(e=>s(e,a.adjacency))}a+=l.vertexPositionArray.length/3}const l=performance.now();return window.time_outlines.old_total+=l-i,this._oGeometry.createFinalArrays(),this._oGeometry.createNewGeometry(e)}}y.halfEdgesArray=[],y.convertOutlineGeometry=function(t,i,r,n){y.ConversionMaterialsManager.sortCount!==n&&(y.ConversionMaterialsManager.clean(),y.ConversionMaterialsManager.sortCount=n);var a=THREEDS.Core,s=null,o=null,l=null,c=0,h=0,u=t.vertexPositionArray,d=t.vertexNormalArray,p=t.vertexPositionArray.length,f=0,m=t.drawingGroups[0].material,g=0,v=0,S=0,_=0,x=0,M=0,P=0,C=0,b=null,D=0;if(i<r){D=4,g=(f=p/3)/2,c=2*p,h=3*f,s=new Float32Array(c),o=new Float32Array(c),l=new Uint32Array(h);for(var w=0;w<g;w++)l[P++]=C,l[P++]=C+1,l[P++]=C+2,l[P++]=C+2,l[P++]=C+1,l[P++]=C+3,C+=4,v=u[6*w],S=u[6*w+1],_=u[6*w+2],x=d[6*w],M=d[6*w+2],s[12*w]=v,s[12*w+1]=S,s[12*w+2]=_,s[12*w+3]=S,s[12*w+4]=v,s[12*w+5]=x,s[12*w+6]=v,s[12*w+7]=S,s[12*w+8]=_,s[12*w+9]=S,s[12*w+10]=v,s[12*w+11]=x,o[12*w]=x,o[12*w+1]=-1,o[12*w+2]=M,o[12*w+3]=_,o[12*w+4]=2,o[12*w+5]=M,o[12*w+6]=x,o[12*w+7]=1,o[12*w+8]=M,o[12*w+9]=_,o[12*w+10]=-2,o[12*w+11]=M;b=y.ConversionMaterialsManager.createWideMaterialFromOther(m,.5*r)}else{D=1,g=(f=t.vertexIndexArray.length)/6,c=p/2,h=f/3,s=new Float32Array(c),o=new Float32Array(c);for(w=0;w<g;w++)v=u[12*w],S=u[12*w+1],_=u[12*w+2],x=d[12*w],M=d[12*w+2],s[6*w]=v,s[6*w+1]=S,s[6*w+2]=_,s[6*w+3]=S,s[6*w+4]=v,s[6*w+5]=x,o[6*w]=x,o[6*w+1]=0,o[6*w+2]=M,o[6*w+3]=_,o[6*w+4]=0,o[6*w+5]=M;b=y.ConversionMaterialsManager.createSimpleMaterialFromWide(m)}a=THREEDS.Core;var E=new e.DrawingGroup(b,b,D,0,h,void 0,void 0,a.GeomTypeEnum._OUTLINE);E.nonIndexed=1===D;var T=new a.BufferGeometryDS;return T.drawingGroups=[],E.geometry=T,T.drawingGroups.push(E),T.vertexPositionArray=s,T.vertexNormalArray=o,T.vertexIndexArray=l,T.boundingSphere=t.boundingSphere,T.boundingBox=t.boundingBox,t.dispose(),t=null,T},y.convertWideWidth=function(e,t,i){y.ConversionMaterialsManager.sortCount!==i&&(y.ConversionMaterialsManager.clean(),y.ConversionMaterialsManager.sortCount=i);var r=e.drawingGroups[0].material,n=y.ConversionMaterialsManager.createWideMaterialFromOther(r,.5*t);e.drawingGroups[0].material=n},y.TexturesManager={sortCount:-1,nbVertices:0,newSimpleMaterial:function(e,t){return new THREEDS.Core._OutlineMaterial(e,t)},newWideMaterial:function(e,t,i){return new THREEDS.Core._WideOutlineMaterial(e,t,i)},addGeometriesOfRenderable:function(e,t){this.isClean=!1;var i=e.geometry.length,r=null,n=0;if(e.layer){var a={},s=[];for(l=0;l<e.layer.layers.length;l++){var o=e.layer.layers[l].drawableGroup;e.layer.layers[l].drawableInterval.skip(e,t)||(a[o.geometry.id]=o.geometry)}for(var l in a)s.push(a[l]);for(l=0;l<s.length;l++)this.geometriesAssociated.push({renderable:e,geom:s[l],renderableOffset:this.nbVertices}),n+=s[l].vertexPositionArray.length/3}else for(var l=0;l<i;l++)r=e.geometry[l],this.geometriesAssociated.push({renderable:e,geom:r,renderableOffset:this.nbVertices}),n+=r.vertexPositionArray.length/3;this.nbVertices+=n,this._updateTextureDefines()},_updateTextureDefines:function(){var e=this.nbVertices;this.textureDefines.NB_OUTLINE_MAPS=Math.ceil(e/this.maxTextureTotalSize);var t=e-Math.floor(e/this.maxTextureTotalSize)*this.maxTextureTotalSize,i=Math.sqrt(t),r=g(i),n=g(t/r);this.textureDefines.LAST_OUTLINE_MAP_SIZE_X=r,this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y=n},geometriesAssociated:[],textureDefines:{NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:-1,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0},maxTextureTotalSize:-1,isClean:!0,simpleOutlineMaterial:null,wideOutlineMaterials:null,createSimpleMaterial:function(){if(null!==this.simpleOutlineMaterial)return this.simpleOutlineMaterial;var e=this.newSimpleMaterial(null,null);return this.simpleOutlineMaterial=e,e},createWideMaterial:function(e){if(null===this.wideOutlineMaterials&&(this.wideOutlineMaterials={}),this.wideOutlineMaterials[e])return this.wideOutlineMaterials[e];var t=this.newWideMaterial(null,null,e);return this.wideOutlineMaterials[e]=t,t},finalize:function(){var e=THREEDS.Core,t=this.textureDefines.NB_OUTLINE_MAPS;if(0!==t){for(var i=this.maxTextureTotalSize,r=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X,n=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y,a=3*((t-1)*i+r*n),s=new Float32Array(a),o=0,l=this.geometriesAssociated,c=l.length,h=null,u=(h=null,null),d=0,p=null,f=0;f<c;f++){h=l[f].geom,d=l[f].renderableOffset,u=l[f].renderable,s.set(h.vertexPositionArray,o);for(var m=(p=u.outlinesGeometry.geometry).vertexNormalArray.length/3,g=0;g<m;g++)p.vertexNormalArray[3*g+2]=d;o+=h.vertexPositionArray.length}for(var v=[],S=0;S<t-1;S++){(_=new e.DataTexture(s.subarray(S*i*3,(S+1)*i*3),maxTextureSize,maxTextureSize,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,_.magFilter=e.NearestFilter,_.generateMipmaps=!1,_.flipY=!1,_.needsUpdate=!0,v.push(_)}var _;if((_=new e.DataTexture(s.subarray((t-1)*i*3,a),r,n,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,_.magFilter=e.NearestFilter,_.generateMipmaps=!1,_.flipY=!1,_.needsUpdate=!0,v.push(_),null!==this.simpleOutlineMaterial){this.simpleOutlineMaterial.defines.NB_OUTLINE_MAPS=this.textureDefines.NB_OUTLINE_MAPS,this.simpleOutlineMaterial.defines.MAX_OUTLINE_MAP_SIZE=this.textureDefines.MAX_OUTLINE_MAP_SIZE.toFixed(1),this.simpleOutlineMaterial.defines.LAST_OUTLINE_MAP_SIZE_X=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X.toFixed(1),this.simpleOutlineMaterial.defines.LAST_OUTLINE_MAP_SIZE_Y=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y.toFixed(1);var y={occludedColor:{type:"v3",value:new e.Vector3(this.simpleOutlineMaterial.occludedColor.r,this.simpleOutlineMaterial.occludedColor.g,this.simpleOutlineMaterial.occludedColor.b)},outlinePositionMaps:{type:"t2v",value:v,length:this.simpleOutlineMaterial.defines.NB_OUTLINE_MAPS},depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new e.Vector2(.01,.01)}};this.simpleOutlineMaterial.setPDSFXUniforms(y)}if(null!==this.wideOutlineMaterials){var x=null;for(var M in this.wideOutlineMaterials){(x=this.wideOutlineMaterials[M]).defines.NB_OUTLINE_MAPS=this.textureDefines.NB_OUTLINE_MAPS,x.defines.MAX_OUTLINE_MAP_SIZE=this.textureDefines.MAX_OUTLINE_MAP_SIZE.toFixed(1),x.defines.LAST_OUTLINE_MAP_SIZE_X=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X.toFixed(1),x.defines.LAST_OUTLINE_MAP_SIZE_Y=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y.toFixed(1);y={occludedColor:{type:"v3",value:new e.Vector3(x.occludedColor.r,x.occludedColor.g,x.occludedColor.b)},outlinePositionMaps:{type:"t2v",value:v,length:x.defines.NB_OUTLINE_MAPS},depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new e.Vector2(.01,.01)},outlineHalfWidth:{type:"f",value:parseFloat(M)},pixelSize:{type:"v2",value:new e.Vector2}};x.setPDSFXUniforms(y)}}}},clean:function(e){if(this.isClean=!0,this.simpleOutlineMaterial=null,this.wideOutlineMaterials=null,this.nbVertices=0,this.textureDefines.MAX_OUTLINE_MAP_SIZE<0){var t=e.getParameter(e.MAX_TEXTURE_SIZE);this.textureDefines.MAX_OUTLINE_MAP_SIZE=t,this.maxTextureTotalSize=t*t}this.textureDefines.NB_OUTLINE_MAPS=0,this.textureDefines.LAST_OUTLINE_MAP_SIZE_X=0,this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y=0,this.geometriesAssociated.length=0}},y.ConversionMaterialsManager={sortCount:-1,simpleOutlineMaterials:null,wideOutlineMaterials:null,createSimpleMaterialFromWide:function(e){null===this.simpleOutlineMaterials&&(this.simpleOutlineMaterials={});var t=e.getPDSFXUniform("outlinePositionMaps").value;if(this.simpleOutlineMaterials[t[0].id])return this.simpleOutlineMaterials[t[0].id];var i=e.defines,r=y.TexturesManager.newSimpleMaterial(i,t);return this.simpleOutlineMaterials[t[0].id]=r,r},createWideMaterialFromOther:function(e,t){null===this.wideOutlineMaterials&&(this.wideOutlineMaterials={});var i=e.getPDSFXUniform("outlinePositionMaps").value;if(this.wideOutlineMaterials[t]||(this.wideOutlineMaterials[t]={}),this.wideOutlineMaterials[t][i[0].id])return this.wideOutlineMaterials[t][i[0].id];var r=e.defines,n=y.TexturesManager.newWideMaterial(r,i,t);return this.wideOutlineMaterials[t][i[0].id]=n,n},clean:function(){this.simpleOutlineMaterials=null,this.wideOutlineMaterials=null}};const x={fetchFromOccurrences({object:e,width:t,viewDirection:i}){let r=e.outlinesGeometry;if(r&&r.geometry||e.layer)return r;const n=e._occurrence.node._occurrences;for(let a=0;a<n.length;a++){const s=n[a].renderable,o=s.outlinesGeometry;if(s!==e&&o&&o.geometry&&!s.layer&&(t===o.outlineWidth&&!i==!o.viewDirection&&(!i||i.equals(o.viewDirection)))){r&&r.dispose(),e.outlinesGeometry=r=o,r.refs++;break}}return r},implementation(e){const t=e.outlinesGeometry;if(t)return t.viewDirection?"cpu":"gpu"},isOutdated({object:e,viewDirection:t}){let i=e.outlinesGeometry;return!!i&&(!i.upToDate||e.layer&&!e.layer.upToDate||i.viewDirection&&!t)},updateMaterialGPU({object:e,width:t,showHiddenOutlines:i,_sortCount:r}){const n=e.outlinesGeometry;let a=n&&n.geometry;if(!a)return;a.drawingGroups[0].material.setShowHiddenOutlines(i);const s=n.outlineWidth;s!==t&&(n.outlineWidth=t,1===s||1===t?(e.clearOutlines(),e.layer&&(e.layer.upToDate=!0)):y.convertWideWidth(n.geometry,t,r))},updateMaterialCPU({object:e,width:t,showHiddenOutlines:i}){const r=e.outlinesGeometry;let n=r&&r.geometry;if(!n)return;if(!(r.outlineWidth!==t||r.showHiddenOutlines!==i))return;r.outlineWidth=t,r.showHiddenOutlines=i;const a=m({width:t,showHiddenOutlines:i});for(let e=0;e<n.length;e++)n[e].drawingGroups[0].material=a},create({object:t,viewDirection:r,width:n,_sortCount:a,_gl:s,showHiddenOutlines:o,visibleSpace:l}){let c=null;if(r){const r=m({width:n,showHiddenOutlines:o});c=h(t).map(n=>(function({renderable:t,material:r,vertexSourceGeometry:n=null,indices:a=null}){const s=new i.BufferGeometryDS;s.vertexIndexArray=a,n&&(s.vertexPositionArray=n.vertexPositionArray,s.vertexBufferGPU=n.vertexBufferGPU,s.vertexOffsetGPU=n.vertexOffsetGPU),s.vertexBufferGPU&&s.vertexBufferGPU.nbGeometries++,s.boundingSphere=t.boundingSphere,s.boundingBox=t.boundingBox;const o=a?a.length:0,l={start:0,count:o},c=new e.DrawingGroup(r,r,1,0,o,[l],void 0,i.GeomTypeEnum._OUTLINE);return s.drawingGroups=[c],c.geometry=s,s})({renderable:t,material:r,vertexSourceGeometry:n.geom})),y.TexturesManager.sortCount!==a&&(y.TexturesManager.clean(s),y.TexturesManager.sortCount=a)}else{(c=new y(t,n,a,s).computeOutlineGeometry(l))&&(c.noMeshInRAM=!0,c.drawingGroups[0].material.setShowHiddenOutlines(o))}return c?(t.outlinesGeometry={geometry:c,outlineWidth:n,showHiddenOutlines:o,viewDirection:r,upToDate:!0,refs:1,dispose(){this.refs--,0===this.refs&&(Array.isArray(this.geometry)?this.geometry.forEach(e=>e.dispose()):this.geometry&&this.geometry.dispose()),this.geometry=null}},c):null},prepare({object:e,width:t,viewDirection:r,_sortCount:n,_gl:a,showHiddenOutlines:s,visibleSpace:o}){if(i=THREEDS.Core,e._isDecal())return{outlineBG:[],created:!1,invalidateGSSO:!1};switch(x.fetchFromOccurrences({object:e,width:t,viewDirection:r}),x.isOutdated({object:e,viewDirection:r})&&(e.clearOutlines(),e.layer&&(e.layer.upToDate=!0)),x.implementation(e)){case"cpu":x.updateMaterialCPU({object:e,width:t,showHiddenOutlines:s});break;case"gpu":x.updateMaterialGPU({object:e,width:t,showHiddenOutlines:s,_sortCount:n})}let l=e.outlinesGeometry&&e.outlinesGeometry.geometry,c=!1;null===l&&(c=!!(l=x.create({object:e,viewDirection:r,width:t,_sortCount:n,_gl:a,showHiddenOutlines:s,visibleSpace:o})));const h=l&&!e.outlinesGeometry.viewDirection;return l?Array.isArray(l)||(l=[l]):l=[],{outlineBG:l,created:c,invalidateGSSO:h}},refresh({object:e,viewDirection:r,width:n,gl:a,visibleSpace:s}){i=THREEDS.Core;let o=e.outlinesGeometry;if(!o)return;let c=o.geometry;if(c)if(!r==!o.viewDirection){if(r){if(0===c.length)return;x.updateMaterialCPU({object:e,width:n,showHiddenOutlines:o.showHiddenOutlines});let i=!1;for(let e=0;e<c.length;e++)c[e].vertexIndexArray||(i=!0);if(!i&&o.viewDirection.equals(r))return;!function({renderable:e,view_direction:i,geometry:r=null,gl:n,visibleSpace:a}){const s=performance.now();let o=h(e,a);r||(r=Array(o.length));for(let e=0;e<o.length;e++){const a=o[e],s=a.geom;let c=[];for(let e=0;e<a.components.length;e++){const t=a.components[e];c.push(l(s,t.ranges,t.id,i))}c=t.mergeIndexBuffers(c),u({geom:r[e],new_indices:c,gl:n})}const c=performance.now();window.time_outlines.total+=c-s}({renderable:e,view_direction:r,geometry:c,gl:a,visibleSpace:s}),o.viewDirection=r}else if(o.outlineWidth!==n)return void e._flagAsGSSOInvalidated()}else e._flagAsGSSOInvalidated()}};return y.prepareOutlines=function(e){return x.prepare(e)},y.refreshOutlines=function(e){return x.refresh(e)},y}),define("DS/Object3D/Light",["DS/Mesh/ThreeJS_Base","DS/Object3D/Object3D"],function(e,t){"use strict";var i=new e.Color,r={LUMINOUS_POWER:0,LUMINOUS_EXITANCE:1},n=1e6/Math.PI,a=function(i){t.call(this),this.onlyShadow=!1,i=i instanceof e.Color?i:new e.Color(i),this.color=i,this.sRGB=!1,this._vptPosition=null,this._phongReduction=!0,this._sceneShadow=!1};(a.prototype=Object.create(t.prototype)).clone=function(e){return void 0===e&&(e=new a),t.prototype.clone.call(this,e),e.color.copy(this.color),e.sRGB=this.sRGB,e._vptPosition=this._vptPosition,e._phongReduction=this._phongReduction,e._sceneShadow=this._sceneShadow,e},a.prototype._sortKey=0,a.prototype.allocateShadows=function(e,t){return 0},a.prototype.setup=function(e,t,i,r){},a.prototype.allocate=function(e){},a.prototype.updateShadowParameters=function(e,t){},a.prototype.dispose=function(){};var s=function(e){a.call(this,e)};(s.prototype=Object.create(a.prototype)).clone=function(e){return void 0===e&&(e=new s),a.prototype.clone.call(this,e),e},s.prototype.setup=function(e,t,r,n){if(this.visible){var a=this.color;if(n.gammaInput&&!this.sRGB){var s=i.copyToLinear(a,n.simpleGamma);e.ambient.r+=s.r,e.ambient.g+=s.g,e.ambient.b+=s.b}else e.ambient.r+=a.r,e.ambient.g+=a.g,e.ambient.b+=a.b}};var o=function(e,t,i,n){a.call(this,e),this.intensity=void 0!==t?t:1,this.radius=void 0!==i?i:1,this.mode=void 0!==n?n:r.LUMINOUS_EXITANCE,this._internalScale=1};(o.prototype=Object.create(a.prototype)).clone=function(e){return void 0===e&&(e=new o),a.prototype.clone.call(this,e),e.intensity=this.intensity,e.radius=this.radius,e.mode=this.mode,e._internalScale=this._internalScale,e},o.prototype.setup=function(t,i,a,s){if(t.sphere.sphereCount+=1,this.visible){var o=3*t.sphere.sphereLength,l=this.matrixWorld.getMaxScaleOnAxis()/this._internalScale*this.radius,c=this.mode===r.LUMINOUS_POWER?n*this.intensity/(l*l*4*Math.PI):this.intensity;s.gammaInput&&!this.sRGB?i(t.sphere.sphereColors,o,this.color,c,s.simpleGamma):a(t.sphere.sphereColors,o,this.color,c);var h=new e.Vector3;h.getPositionFromMatrix(this.matrixWorld),t.sphere.spherePositions[o]=h.x,t.sphere.spherePositions[o+1]=h.y,t.sphere.spherePositions[o+2]=h.z,t.sphere.sphereData[o]=l,t.sphere.sphereData[o+1]=0,t.sphere.sphereData[o+2]=0,t.sphere.sphereLength+=1}},o.prototype.allocate=function(e){e.sphereLights++};var l=function(e,t,i,n){a.call(this,e),this.intensity=void 0!==t?t:1,this.radius=void 0!==i?i:1,this.mode=void 0!==n?n:r.LUMINOUS_EXITANCE,this._internalScale=1};(l.prototype=Object.create(a.prototype)).clone=function(e){return void 0===e&&(e=new l),a.prototype.clone.call(this,e),e.intensity=this.intensity,e.radius=this.radius,e.mode=this.mode,e._internalScale=this._internalScale,e},l.prototype.setup=function(t,i,a,s){if(t.disk.diskCount+=1,this.visible){var o=3*t.disk.diskLength,l=Math.max(this.matrixWorld.getScaleOnAxisX(),this.matrixWorld.getScaleOnAxisY())/this._internalScale*this.radius,c=this.mode===r.LUMINOUS_POWER?n*this.intensity/(l*l*Math.PI):this.intensity;s.gammaInput&&!this.sRGB?i(t.disk.diskColors,o,this.color,c,s.simpleGamma):a(t.disk.diskColors,o,this.color,c);var h=new e.Vector3;h.getPositionFromMatrix(this.matrixWorld),t.disk.diskPositions[o]=h.x,t.disk.diskPositions[o+1]=h.y,t.disk.diskPositions[o+2]=h.z;var u=new e.Vector4;u.getColumnFromMatrix(2,this.matrixWorld),u.w=0,u.normalize(),t.disk.diskNormals[o]=u.x,t.disk.diskNormals[o+1]=u.y,t.disk.diskNormals[o+2]=u.z,u.getColumnFromMatrix(1,this.matrixWorld),u.w=0,u.normalize(),t.disk.diskUps[o]=u.x,t.disk.diskUps[o+1]=u.y,t.disk.diskUps[o+2]=u.z,t.disk.diskData[o]=l,t.disk.diskData[o+1]=0,t.disk.diskData[o+2]=0,t.disk.diskLength+=1}},l.prototype.allocate=function(e){e.diskLights++};var c=function(e,t,i,n,s){a.call(this,e),this.intensity=void 0!==t?t:1,this.radius=void 0!==i?i:1,this.width=void 0!==n?n:1,this.mode=void 0!==s?s:r.LUMINOUS_EXITANCE,this._internalScale=1};(c.prototype=Object.create(a.prototype)).clone=function(e){return void 0===e&&(e=new c),a.prototype.clone.call(this,e),e.intensity=this.intensity,e.radius=this.radius,e.width=this.width,e.mode=this.mode,e._internalScale=this._internalScale,e},c.prototype.setup=function(t,i,a,s){if(t.tube.tubeCount+=1,this.visible){var o=3*t.tube.tubeLength,l=this.matrixWorld.getScaleOnAxisX()/this._internalScale,c=this.matrixWorld.getScaleOnAxisY()/this._internalScale*this.radius,h=l*this.width,u=this.mode===r.LUMINOUS_POWER?n*this.intensity/(2*Math.PI*h*c+c*c*4*Math.PI):this.intensity;s.gammaInput&&!this.sRGB?i(t.tube.tubeColors,o,this.color,u,s.simpleGamma):a(t.tube.tubeColors,o,this.color,u);var d=new e.Vector3;d.getPositionFromMatrix(this.matrixWorld),t.tube.tubePositions[o]=d.x,t.tube.tubePositions[o+1]=d.y,t.tube.tubePositions[o+2]=d.z;var p=new e.Vector4;p.getColumnFromMatrix(1,this.matrixWorld),p.w=0,p.normalize(),t.tube.tubeRights[o]=p.x,t.tube.tubeRights[o+1]=p.y,t.tube.tubeRights[o+2]=p.z,t.tube.tubeData[o]=c,t.tube.tubeData[o+1]=h,t.tube.tubeData[o+2]=0,t.tube.tubeLength+=1}},c.prototype.allocate=function(e){e.tubeLights++};var h=function(e,t,i,n,s){a.call(this,e),this.intensity=void 0!==t?t:1,this.height=void 0!==n?n:1,this.width=void 0!==i?i:1,this.mode=void 0!==s?s:r.LUMINOUS_EXITANCE,this._internalScale=1};(h.prototype=Object.create(a.prototype)).clone=function(e){return void 0===e&&(e=new h),a.prototype.clone.call(this,e),e.intensity=this.intensity,e.width=this.width,e.height=this.height,e.mode=this.mode,e._internalScale=this._internalScale,e},h.prototype.setup=function(t,i,a,s){if(t.area.areaCount+=1,this.visible){var o=3*t.area.areaLength,l=this.matrixWorld.getScaleOnAxisX()/this._internalScale,c=this.matrixWorld.getScaleOnAxisY()/this._internalScale*this.height,h=l*this.width,u=this.mode===r.LUMINOUS_POWER?n*this.intensity/(c*h):this.intensity;s.gammaInput&&!this.sRGB?i(t.area.areaColors,o,this.color,u,s.simpleGamma):a(t.area.areaColors,o,this.color,u);var d=new e.Vector3;d.getPositionFromMatrix(this.matrixWorld),t.area.areaPositions[o]=d.x,t.area.areaPositions[o+1]=d.y,t.area.areaPositions[o+2]=d.z;var p=new e.Vector4;p.getColumnFromMatrix(2,this.matrixWorld),p.w=0,p.normalize(),t.area.areaNormals[o]=p.x,t.area.areaNormals[o+1]=p.y,t.area.areaNormals[o+2]=p.z,p.getColumnFromMatrix(1,this.matrixWorld),p.w=0,p.normalize(),t.area.areaUps[o]=p.x,t.area.areaUps[o+1]=p.y,t.area.areaUps[o+2]=p.z,t.area.areaData[o]=h,t.area.areaData[o+1]=c,t.area.areaData[o+2]=0,t.area.areaLength+=1}},h.prototype.allocate=function(e){e.areaLights++};var u=function(i,r){a.call(this,i),this.position.set(0,1,0),this.target=new t,this.intensity=void 0!==r?r:1,this.castShadow=!1,this.onlyShadow=!1,this.castGroundShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraLeft=-500,this.shadowCameraRight=500,this.shadowCameraTop=500,this.shadowCameraBottom=-500,this.shadowCameraVisible=!1,this.shadowCameraHelperToUpdate=!0,this.shadowBias=-.005,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512,this.shadowCascade=!1,this.shadowCascadeOffset=new e.Vector3(0,0,-1e3),this.shadowCascadeCount=2,this.shadowCascadeBias=[0,0,0],this.shadowCascadeWidth=[512,512,512],this.shadowCascadeHeight=[512,512,512],this.shadowCascadeNearZ=[-1,.99,.998],this.shadowCascadeFarZ=[.99,.998,1],this.shadowCascadeArray=[],this.updateShadowMap=!0,this.blockUpdate=!1,this.shadowMap=null,this.transparentShadowMap=null,this.shadowMapSize=null,this.shadowCamera=null,this.transparentShadowCamera=null,this.shadowMatrix=null,this.LiSPSM=!1};(u.prototype=Object.create(a.prototype))._sortKey=32,u.prototype.clone=function(e){return void 0===e&&(e=new u),a.prototype.clone.call(this,e),null!==this.target?this.target.clone(e.target):e.target=null,e.intensity=this.intensity,e.castShadow=this.castShadow,e.onlyShadow=this.onlyShadow,e},u.prototype.allocateShadows=function(e,t){return this.shadowCascade||this.isVirtual&&!e.shadowMapCascade||(t.tex2d++,t.dirLight++),0},u.prototype._getLightDirection=function(t){var i=new e.Vector3;new e.Vector3;if(this.target)i.getPositionFromMatrix(this.matrixWorld),i.sub(this.target.position),0===i.x&&0===i.y&&0===i.z&&(i.copy(t),i.applyMatrix4((new e.Matrix4).extractRotation(this.matrixWorld)));else if(i.copy(t),i.applyMatrix4((new e.Matrix4).extractRotation(this.matrixWorld)),this._occurrence&&this._occurrence.node._attachedToVpt){var r=(new e.Vector3).crossVectors(this._vptSight,this._vptUp);i=new e.Vector3(r.x*i.x+this._vptUp.x*i.y-this._vptSight.x*i.z,r.y*i.x+this._vptUp.y*i.y-this._vptSight.y*i.z,r.z*i.x+this._vptUp.z*i.y-this._vptSight.z*i.z)}return i.normalize(),i},u.prototype.setup=function(e,t,i,r){if(e.directional.dirCount+=1,this.visible){var n=this._getLightDirection(r.baseLightDirection);if(0!==n.x||0!==n.y||0!==n.z){var a=3*e.directional.dirLength;e.directional.dirPositions[a]=n.x,e.directional.dirPositions[a+1]=n.y,e.directional.dirPositions[a+2]=n.z,r.gammaInput&&!this.sRGB?(t(e.directional.dirColors,a,this.color,this.intensity,r.simpleGamma,e.directional.dirColorsNoIntensity),t(e.directional.dirColorsPhong,a,this.color,this.intensity,r.simpleGamma)):(i(e.directional.dirColors,a,this.color,this.intensity,e.directional.dirColorsNoIntensity),i(e.directional.dirColorsPhong,a,this.color,this.intensity)),this._phongReduction&&(e.directional.dirColorsPhong[a]/=Math.PI,e.directional.dirColorsPhong[a+1]/=Math.PI,e.directional.dirColorsPhong[a+2]/=Math.PI),e.directional.dirLength+=1}}},u.prototype.allocate=function(e){e.dirLights++},u.prototype.updateShadowParameters=function(t,i){if(null!==t){var r=this._getLightDirection(i),n=null!==this.target?this.target.position:t.center;this.position=(new e.Vector3).copy(r).multiplyScalar(2*t.radius).add(n);var a=this.position.distanceTo(t.center),s=-.5*r.dot(i)+.5;Math.PI,Math.max(.1,.5-s);this.shadowCamera&&!this.LiSPSM?(this.updateShadowMap=this.updateShadowMap||this.shadowCamera.top!==t.radius,this.shadowCamera.far=a+2.64*t.radius,this.shadowCamera.near=Math.max(.001*this.shadowCamera.far,a-t.radius),this.shadowCamera.left=-t.radius,this.shadowCamera.right=t.radius,this.shadowCamera.bottom=-t.radius,this.shadowCamera.top=t.radius,this.shadowCamera.updateProjectionMatrix()):(this.shadowCameraFar=a+2.64*t.radius,this.shadowCameraNear=Math.max(.001*this.shadowCameraFar,a-t.radius),this.updateShadowMap=!0)}},u.prototype.dispose=function(){this.shadowMap&&this.shadowMap.dispose(),this.transparentShadowMap&&this.transparentShadowMap.dispose()};var d=function(e,t){u.call(this,e,t),this.castShadow=!0};(d.prototype=Object.create(u.prototype))._sortKey=8,d.prototype.clone=function(e){return void 0===e&&(e=new d),u.prototype.clone.call(this,e),e},d.prototype.allocateShadows=function(e,t){return this.shadowCascade||this.isVirtual&&!e.shadowMapCascade||t.dirIBLLight++,0},d.prototype.setup=function(e,t,i,r){if(e.directionalIBL.dirIBLCount+=1,this.visible){var n=this._getLightDirection(r.baseLightDirection);if(0!==n.x||0!==n.y||0!==n.z){var a=3*e.directionalIBL.dirIBLLength;e.directionalIBL.dirIBLPositions[a]=n.x,e.directionalIBL.dirIBLPositions[a+1]=n.y,e.directionalIBL.dirIBLPositions[a+2]=n.z,i(e.directionalIBL.dirIBLColors,a,this.color,this.intensity),e.directionalIBL.dirIBLLength+=1}}},d.prototype.allocate=function(e){e.dirIBLLights++};var p=function(e,t){u.call(this,e,t),this.castShadow=!1};(p.prototype=Object.create(u.prototype))._sortKey=0,p.prototype.clone=function(e){return void 0===e&&(e=new p),u.prototype.clone.call(this,e),e},p.prototype.allocateShadows=function(e,t){return 0},p.prototype.setup=function(e,t,i,r){if(e.directionalPhong.dirPhongCount+=1,this.visible){var n=this._getLightDirection(r.baseLightDirection);if(0!==n.x||0!==n.y||0!==n.z){var a=3*e.directionalPhong.dirPhongLength;e.directionalPhong.dirPhongPositions[a]=n.x,e.directionalPhong.dirPhongPositions[a+1]=n.y,e.directionalPhong.dirPhongPositions[a+2]=n.z,i(e.directionalPhong.dirPhongColors,a,this.color,this.intensity),e.directionalPhong.dirPhongColors[a]/=Math.PI,e.directionalPhong.dirPhongColors[a+1]/=Math.PI,e.directionalPhong.dirPhongColors[a+2]/=Math.PI,e.directionalPhong.dirPhongLength+=1}}},p.prototype.allocate=function(e){e.dirPhongLights++};var f=function(e,t,i){a.call(this,e),this.intensity=void 0!==t?t:1,this.distance=void 0!==i?i:0,this.isPhysicallyAttenuated=!1,this.attenuationScale=1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraFov=90,this.shadowCameraVisible=!1,this.shadowCameraHelperToUpdate=!0,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512,this.updateShadowMap=!0,this.shadowMap=null,this.transparentShadowMap=null,this.shadowMapSize=null,this.shadowCameras=null,this.transparentShadowCameras=null,this.shadowMatrix=null};(f.prototype=Object.create(a.prototype))._sortKey=4,f.prototype.clone=function(e){return void 0===e&&(e=new f),a.prototype.clone.call(this,e),e.intensity=this.intensity,e.distance=this.distance,e.isPhysicallyAttenuated=this.isPhysicallyAttenuated,e.attenuationScale=this.attenuationScale,e.castShadow=this.castShadow,e.onlyShadow=this.onlyShadow,e},f.prototype.allocateShadows=function(e,t){t.texCube++},f.prototype.setup=function(t,i,r,n){if(t.point.pointCount+=1,this.visible){var a=3*t.point.pointLength;n.gammaInput&&!this.sRGB?(i(t.point.pointColors,a,this.color,this.intensity,n.simpleGamma,t.point.pointColorsNoIntensity),i(t.point.pointColorsPhong,a,this.color,this.intensity,n.simpleGamma)):(r(t.point.pointColors,a,this.color,this.intensity,t.point.pointColorsNoIntensity),r(t.point.pointColorsPhong,a,this.color,this.intensity)),this._phongReduction&&(t.point.pointColorsPhong[a]/=Math.PI,t.point.pointColorsPhong[a+1]/=Math.PI,t.point.pointColorsPhong[a+2]/=Math.PI);var s=new e.Vector3;this._occurrence&&this._occurrence.node._attachedToVpt?s.copy(this._vptPosition):s.getPositionFromMatrix(this.matrixWorld),t.point.pointPositions[a]=s.x,t.point.pointPositions[a+1]=s.y,t.point.pointPositions[a+2]=s.z,t.point.pointPhysicalAttenuations[t.point.pointLength]=this.isPhysicallyAttenuated,t.point.pointDistances[t.point.pointLength]=this.isPhysicallyAttenuated?this.attenuationScale:this.distance,t.point.pointLength+=1}},f.prototype.setupShadowPositions=function(t){if(this.visible){var i=new e.Vector3;this._occurrence&&this._occurrence.node._attachedToVpt?i.copy(this._vptPosition):i.getPositionFromMatrix(this.matrixWorld),t.push(i.x),t.push(i.y),t.push(i.z)}},f.prototype.allocate=function(e){e.pointLights++},f.prototype.dispose=function(){this.shadowMap&&this.shadowMap.dispose(),this.transparentShadowMap&&this.transparentShadowMap.dispose()};var m=function(e,i,r,n,s){a.call(this,e),this.position.set(0,1,0),this.target=new t,this.intensity=void 0!==i?i:1,this.distance=void 0!==r?r:0,this.angle=void 0!==n?n:Math.PI/2,this.innerAngle=void 0!==s?s:this.angle-.001,this.exponent=1,this.isPhysicallyAttenuated=!1,this.attenuationScale=1,this.castShadow=!1,this.onlyShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraFov=50,this.shadowCameraVisible=!1,this.shadowCameraHelperToUpdate=!0,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512,this.updateShadowMap=!0,this.shadowMap=null,this.transparentShadowMap=null,this.shadowMapSize=null,this.shadowCamera=null,this.transparentShadowCamera=null,this.shadowMatrix=null};(m.prototype=Object.create(a.prototype))._sortKey=16,m.prototype.clone=function(e){return void 0===e&&(e=new m),a.prototype.clone.call(this,e),null!==this.target?this.target.clone(e.target):e.target=null,e.intensity=this.intensity,e.localDirection=this.localDirection,e.distance=this.distance,e.angle=this.angle,e.innerAngle=this.innerAngle,e.exponent=this.exponent,e.castShadow=this.castShadow,e.onlyShadow=this.onlyShadow,e.isPhysicallyAttenuated=this.isPhysicallyAttenuated,e.attenuationScale=this.attenuationScale,e},m.prototype.allocateShadows=function(e,t){t.tex2d++,t.spotLight++},m.prototype.setup=function(t,i,r,n){if(t.spot.spotCount+=1,this.visible){var a=3*t.spot.spotLength;n.gammaInput&&!this.sRGB?(i(t.spot.spotColors,a,this.color,this.intensity,n.simpleGamma,t.spot.spotColorsNoIntensity),i(t.spot.spotColorsPhong,a,this.color,this.intensity,n.simpleGamma)):(r(t.spot.spotColors,a,this.color,this.intensity,t.spot.spotColorsNoIntensity),r(t.spot.spotColorsPhong,a,this.color,this.intensity)),this._phongReduction&&(t.spot.spotColorsPhong[a]/=Math.PI,t.spot.spotColorsPhong[a+1]/=Math.PI,t.spot.spotColorsPhong[a+2]/=Math.PI);var s=new e.Vector3,o=new e.Vector3;if(this._occurrence&&this._occurrence.node._attachedToVpt)s.copy(this._vptPosition),o.copy(this._vptSight),o.negate();else{s.getPositionFromMatrix(this.matrixWorld);var l=t.spot.spotLength;t.spot.spotPhysicalAttenuations[l]=this.isPhysicallyAttenuated,t.spot.spotDistances[l]=this.isPhysicallyAttenuated?this.attenuationScale:this.distance,this.target?(o.copy(s),o.sub(this.target.position),0===o.x&&0===o.y&&0===o.z&&(o.set(0,0,1),o.applyMatrix4((new e.Matrix4).extractRotation(this.matrixWorld)))):(o.set(0,0,1),o.applyMatrix4((new e.Matrix4).extractRotation(this.matrixWorld)))}o.normalize(),t.spot.spotPositions[a]=s.x,t.spot.spotPositions[a+1]=s.y,t.spot.spotPositions[a+2]=s.z,t.spot.spotDirections[a]=o.x,t.spot.spotDirections[a+1]=o.y,t.spot.spotDirections[a+2]=o.z,t.spot.spotAnglesCos[l]=Math.cos(this.angle),t.spot.spotInnerAnglesCos[l]=Math.cos(this.innerAngle),t.spot.spotLength+=1}},m.prototype.allocate=function(e){e.spotLights++},m.prototype.dispose=function(){this.shadowMap&&this.shadowMap.dispose(),this.transparentShadowMap&&this.transparentShadowMap.dispose()};var g=function(e,t,i,r){a.call(this,e),this.intensity=void 0!==t?t:1,this.distance=void 0!==i?i:0,this.iesTexture=r};return(g.prototype=Object.create(a.prototype)).clone=function(e){return void 0===e&&(e=new g),a.prototype.clone.call(this,e),e.intensity=this.intensity,e.distance=this.distance,e.iesTexture=this.iesTexture,e},g.prototype.setup=function(t,i,r,n){if(t.ies.iesCount+=1,this.visible){var a=3*t.ies.iesLength;n.gammaInput&&!this.sRGB?i(t.ies.iesColors,a,this.color,this.intensity,n.simpleGamma):r(t.ies.iesColors,a,this.color,this.intensity);var s=new e.Vector3;this._occurrence&&this._occurrence.node._attachedToVpt?s.copy(this._vptPosition):s.getPositionFromMatrix(this.matrixWorld),t.ies.iesPositions[a]=s.x,t.ies.iesPositions[a+1]=s.y,t.ies.iesPositions[a+2]=s.z,t.ies.iesDistances[t.ies.iesLength]=this.distance,t.ies.iesLightTexture[t.ies.iesCount-1]=this.iesTexture;var o=new e.Matrix4;t.ies.matrixWorldInv[t.ies.iesCount-1]=o.getInverse(this.matrixWorld),t.ies.iesLength+=1}},g.prototype.allocate=function(e){e.iesLights++},{AreaLightUnits:r,BaseLight:a,PointLight:f,SpotLight:m,DirectionalLight:u,DirectionalIBLLight:d,DirectionalPhongLight:p,AreaLight:h,TubeLight:c,DiskLight:l,SphereLight:o,AmbientLight:s,IESLight:g}}),define("DS/Visualization/CullingSystem",["DS/Visualization/WebGLObjectManager","DS/Object3D/Camera"],function(e,t){"use strict";var i=0,r={_INVISIBLE:0,_VISIBLE:1,_FRESH:2},n={_GSSO:0,_REMOVE_AND_GSSO:1,_REMOVE:2,_NOTHING:3,_SKIP:4},a=function(e){this.webglObject=e,this.invalidated=!0,this.previousCullingStatus=r._FRESH,this.action=n._NOTHING,this.previousRenderPointsOnly=!1,this.currentRenderPointsOnly=!1,this.object=e.object},s=function(){this.map=new Map};s.prototype.get=function(e,t){var i=null,r=this.map.get(e.id);return r||(r=new Map,this.map.set(e.id,r)),(i=r.get(t))||(i=new l(e),r.set(t,i),e._cullingSystems.push(i)),i},s.prototype.resetCullingStatuses=function(e){this.map.forEach(function(t,i){t.forEach(function(t,i){t._resetCullingStatuses(e)})})},s.prototype.dispose=function(){this.map.clear()};var o=new s,l=function(e){this.id=i++,this.scene=e,this.objectManagers={},this.lastComposerContextsSeen=new Set,this.currComposerContextsSeen=new Set};return l.prototype.isSet=function(e){return!!this.objectManagers[e]},l.prototype.setFromIdString=function(t,i){this.objectManagers[t]={list:new e,frame:-1};for(var r=this.objectManagers[t].list,n=this.scene.getWebGLObjects(t,i),s=n.length,o=0;o<s;o++)r.add(null===n[o]?null:new a(n[o]))},l.prototype.getWebGLObjects=function(e,t){this.scene.getWebGLObjects(this.idString,t);return this.objectManagers&&this.objectManagers[e]&&this.objectManagers[e].list?this.objectManagers[e].list.getObjects(t):[]},l.prototype._resetCullingStatuses=function(e){for(var t in this.objectManagers)this.objectManagers[t].frame=-1;if(this.currComposerContextsSeen.size>0){var i=this;this.lastComposerContextsSeen.clear(),this.currComposerContextsSeen.forEach(function(e){i.lastComposerContextsSeen.add(e)}),this.currComposerContextsSeen.clear()}},{WebGLObjectCullingStatus:a,__CullingSystemFactory:o,CullingSystem:l,VISIBILITY_STATUS:r,INCREMENTAL_ACTIONS:n}}),define("DS/GPUFormats/NonPowerOfTwoTexture",["DS/Mesh/ThreeJS_Base","DS/GPUFormats/CompressedTexture"],function(e,t){"use strict";var i=function(i,r,n,a,s,o,l,c,h,u,d,p){t.call(this,{width:n,height:a,data:null},l,c,h,u,d,s,o,p),this.image=i.image,this.mapping=i.mapping,this.wrapS=e.ClampToEdgeWrapping,this.wrapT=e.ClampToEdgeWrapping,this.magFilter=e.LinearFilter,this.minFilter=e.LinearFilter,this.anisotropy=i.anisotropy,this.format=i.format,this.type=i.type,this.needsUpdate=!0,this.generateMipmaps=!1,r.length&&(this.image=r[0]),this.nPot=!0};return(i.prototype=Object.create(t.prototype)).clone=function(){var e=new t;return Texture.prototype.clone.call(this,e),e},i}),define("DS/Visualization/Shapes",["DS/Mesh/ThreeJS_Base","DS/Visualization/Curves"],function(e,t){"use strict";let i={};var r,n,a;return i.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},loadFace:function(e){var t=e.familyName.toLowerCase();this.faces[t]=this.faces[t]||{},this.faces[t][e.cssFontWeight]=this.faces[t][e.cssFontWeight]||{},this.faces[t][e.cssFontWeight][e.cssFontStyle]=e;this.faces[t][e.cssFontWeight][e.cssFontStyle]=e;return e},drawText:function(e){var i,r=this.getFace(),n=this.size/r.resolution,a=0,s=String(e).split(""),o=s.length,l=[];for(i=0;i<o;i++){var c=new t.Path,h=this.extractGlyphPoints(s[i],r,n,a,c);a+=h.offset,l.push(h.path)}return{paths:l,offset:a/2}},extractGlyphPoints:function(e,t,r,n,a){var s,o,l,c,h,u,d,p,f,m,g,v,S,_,y,x,M,P,C=[],b=t.glyphs[e]||t.glyphs["?"];if(b){if(b.o)for(h=(c=b._cachedOutline||(b._cachedOutline=b.o.split(" "))).length,u=r,d=r,s=0;s<h;)switch(c[s++]){case"m":p=c[s++]*u+n,f=c[s++]*d,a.moveTo(p,f);break;case"l":p=c[s++]*u+n,f=c[s++]*d,a.lineTo(p,f);break;case"q":if(m=c[s++]*u+n,g=c[s++]*d,_=c[s++]*u+n,y=c[s++]*d,a.quadraticCurveTo(_,y,m,g),P=C[C.length-1])for(v=P.x,S=P.y,o=1,l=this.divisions;o<=l;o++){var D=o/l;i.Shape.Utils.b2(D,v,_,m),i.Shape.Utils.b2(D,S,y,g)}break;case"b":if(m=c[s++]*u+n,g=c[s++]*d,_=c[s++]*u+n,y=c[s++]*-d,x=c[s++]*u+n,M=c[s++]*-d,a.bezierCurveTo(m,g,_,y,x,M),P=C[C.length-1])for(v=P.x,S=P.y,o=1,l=this.divisions;o<=l;o++)D=o/l,i.Shape.Utils.b3(D,v,_,x,m),i.Shape.Utils.b3(D,S,y,M,g)}return{offset:b.ha*r,path:a}}}},i.FontUtils.generateShapes=function(e,t){var r=void 0!==(t=t||{}).size?t.size:100,n=void 0!==t.curveSegments?t.curveSegments:4,a=void 0!==t.font?t.font:"helvetiker",s=void 0!==t.weight?t.weight:"normal",o=void 0!==t.style?t.style:"normal";i.FontUtils.size=r,i.FontUtils.divisions=n,i.FontUtils.face=a,i.FontUtils.weight=s,i.FontUtils.style=o;for(var l=i.FontUtils.drawText(e).paths,c=[],h=0,u=l.length;h<u;h++)Array.prototype.push.apply(c,l[h].toShapes());return c},r=i.FontUtils,n=function(e){for(var t=e.length,i=0,r=t-1,n=0;n<t;r=n++)i+=e[r].x*e[n].y-e[n].x*e[r].y;return.5*i},a=function(e,t,i,r,n,a){var s,o,l,c,h,u,d,p,f,m,g,v,S,_,y;if(o=e[a[t]].x,l=e[a[t]].y,c=e[a[i]].x,h=e[a[i]].y,u=e[a[r]].x,1e-10>(c-o)*((d=e[a[r]].y)-l)-(h-l)*(u-o))return!1;for(m=u-c,g=d-h,v=o-u,S=l-d,_=c-o,y=h-l,s=0;s<n;s++)if(s!==t&&s!==i&&s!==r&&(p=e[a[s]].x,m*((f=e[a[s]].y)-h)-g*(p-c)>=0&&v*(f-d)-S*(p-u)>=0&&_*(f-l)-y*(p-o)>=0))return!1;return!0},r.Triangulate=function(e,t){var i=e.length;if(i<3)return null;var r,s,o,l=[],c=[],h=[];if(n(e)>0)for(s=0;s<i;s++)c[s]=s;else for(s=0;s<i;s++)c[s]=i-1-s;var u=i,d=2*u;for(s=u-1;u>2;){if(d--<=0)return console.log("Warning, unable to triangulate polygon!"),t?h:l;if(u<=(r=s)&&(r=0),u<=(s=r+1)&&(s=0),u<=(o=s+1)&&(o=0),a(e,r,s,o,u,c)){var p,f,m,g,v;for(p=c[r],f=c[s],m=c[o],l.push([e[p],e[f],e[m]]),h.push([c[r],c[s],c[o]]),g=s,v=s+1;v<u;g++,v++)c[g]=c[v];d=2*--u}}return t?h:l},r.Triangulate.area=n,i.Shape=function(){t.Path.apply(this,arguments),this.holes=[]},i.Shape.prototype=Object.create(t.Path.prototype),i.Shape.prototype.extrude=function(t){return new e.ExtrudeGeometry(this,t)},i.Shape.prototype.makeGeometry=function(t){return new e.ShapeGeometry(this,t)},i.Shape.prototype.getPointsHoles=function(e){var t,i=this.holes.length,r=[];for(t=0;t<i;t++)r[t]=this.holes[t].getTransformedPoints(e,this.bends);return r},i.Shape.prototype.getSpacedPointsHoles=function(e){var t,i=this.holes.length,r=[];for(t=0;t<i;t++)r[t]=this.holes[t].getTransformedSpacedPoints(e,this.bends);return r},i.Shape.prototype.extractAllPoints=function(e){return{shape:this.getTransformedPoints(e),holes:this.getPointsHoles(e)}},i.Shape.prototype.extractPoints=function(e){return this.useSpacedPoints?this.extractAllSpacedPoints(e):this.extractAllPoints(e)},i.Shape.prototype.extractAllSpacedPoints=function(e){return{shape:this.getTransformedSpacedPoints(e),holes:this.getSpacedPointsHoles(e)}},i.Shape.Utils={removeHoles:function(t,i){var r,n,a,s,o,l,c,h,u,d,p,f,m,g,v,S,_=t.concat(),y=_.concat(),x=[];for(o=0;o<i.length;o++){for(c=i[o],Array.prototype.push.apply(y,c),h=Number.POSITIVE_INFINITY,l=0;l<c.length;l++){p=c[l];var M=[];for(d=0;d<_.length;d++)f=_[d],u=p.distanceToSquared(f),M.push(u),u<h&&(h=u,a=l,s=d)}r=s-1>=0?s-1:_.length-1,n=a-1>=0?a-1:c.length-1;var P=[c[a],_[s],_[r]],C=e.FontUtils.Triangulate.area(P),b=[c[a],c[n],_[s]],D=e.FontUtils.Triangulate.area(b),w=s,E=a;a+=-1,(s+=1)<0&&(s+=_.length),s%=_.length,a<0&&(a+=c.length),a%=c.length,r=s-1>=0?s-1:_.length-1,n=a-1>=0?a-1:c.length-1,P=[c[a],_[s],_[r]];var T=e.FontUtils.Triangulate.area(P);b=[c[a],c[n],_[s]],C+D>T+e.FontUtils.Triangulate.area(b)&&(a=E,(s=w)<0&&(s+=_.length),s%=_.length,a<0&&(a+=c.length),a%=c.length,r=s-1>=0?s-1:_.length-1,n=a-1>=0?a-1:c.length-1),m=_.slice(0,s),g=_.slice(s),v=c.slice(a),S=c.slice(0,a);var A=[c[a],_[s],_[r]],I=[c[a],c[n],_[s]];x.push(A),x.push(I),_=m.concat(v).concat(S).concat(g)}return{shape:_,isolatedPts:x,allpoints:y}},triangulateShape:function(t,r){var n,a,s,o,l,c,h=i.Shape.Utils.removeHoles(t,r),u=h.shape,d=h.allpoints,p=h.isolatedPts,f=e.FontUtils.Triangulate(u,!1),m={};for(n=0,a=d.length;n<a;n++)void 0!==m[l=d[n].x+":"+d[n].y]&&console.log("Duplicate point",l),m[l]=n;for(n=0,a=f.length;n<a;n++)for(o=f[n],s=0;s<3;s++)void 0!==(c=m[l=o[s].x+":"+o[s].y])&&(o[s]=c);for(n=0,a=p.length;n<a;n++)for(o=p[n],s=0;s<3;s++)void 0!==(c=m[l=o[s].x+":"+o[s].y])&&(o[s]=c);return f.concat(p)},isClockWise:function(t){return e.FontUtils.Triangulate.area(t)<0},b2p0:function(e,t){var i=1-e;return i*i*t},b2p1:function(e,t){return 2*(1-e)*e*t},b2p2:function(e,t){return e*e*t},b2:function(e,t,i,r){return this.b2p0(e,t)+this.b2p1(e,i)+this.b2p2(e,r)},b3p0:function(e,t){var i=1-e;return i*i*i*t},b3p1:function(e,t){var i=1-e;return 3*i*i*e*t},b3p2:function(e,t){return 3*(1-e)*e*e*t},b3p3:function(e,t){return e*e*e*t},b3:function(e,t,i,r,n){return this.b3p0(e,t)+this.b3p1(e,i)+this.b3p2(e,r)+this.b3p3(e,n)}},i}),define("DS/RenderEngineUtils/StateSortingCacheItem",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t=function({dlIndex:e,resetFrameIndex:t,material:i,object:r,geometry:n,dg:a,dgInterval:s,renderMode:o,renderVolumesOnly:l,renderLineMode:c,geomDisposeFunc:h,materialToUse:u,matApp:d,gasMaterial:p,cpInfos:f=null}){this._args={material:i,object:r,geometry:n,dg:a,dgInterval:s,renderMode:o,renderVolumesOnly:l,geomDisposeFunc:h,materialToUse:u,matApp:d,gasMaterial:p,cpInfos:f},this.dlIndex=e,this.resetFrameIndex=t,this.renderLineMode=c};return t.prototype.addDrawable=function(e,t){var i=e[this.dlIndex],r={qaAutomationMode:t};Object.assign(r,this._args),i.addDrawable(r)},t}),define("DS/RenderEngineUtils/InheritanceSolver",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";const t=e._VisuFilterType;let i=null,r=0,n=0,a=0,s=0,o=null,l=null,c=null;function h(e,t){let i=e;return t.glType!=a&&t.glType!=s||!e.line||(i=e.line),t.glType==n&&e.point&&(i=e.point),i._deferredMaterialsInit||i.updateDeferredMaterials(),i}function u(e){if("true"===localStorage.getItem("forceCPUOutlines"))return e.isOrtho;return e._viewpoint&&e._viewpoint._2DMode&&e.isOrtho}function d(e,t){return e._viewpoint&&e._viewpoint.isNative2D()&&e._viewpoint._depthMode?t._depthPriority:-1}let p=null;return class{constructor(e){this.renderer=e,this.gl=null,this.reset(),this._objectsWithOutlines=null,this.camera=null}_useCPUOutlines(e){return u(e)}enableOutlineHanding(t,i){if(!this.camera)throw"Globals are not set, camera not found";if(this.outlineStruct=null,t){const t=this.camera;this.outlineStruct=i;let r=null;u(t)&&(r=new e.Vector4(0,0,1,0).applyMatrix4(t.matrixWorld)),i.outlinesCameraDirection=r;const n=this._objectsWithOutlines&&this._objectsWithOutlines.cameraDir,a=!!r!=!!n||r&&!r.equals(n);this._objectsWithOutlines&&a&&(this._objectsWithOutlines.cameraDir=r,this._objectsWithOutlines.objects.forEach(e=>e._flagAsGSSOInvalidated()),this._objectsWithOutlines.objects.clear())}}setContext(t,i,h){this.gl=t,r=e.GeomTypeEnum.FACE,n=t.POINTS,a=t.LINES,s=t.LINE_STRIP,o=i,l=h,c||(c=new e.MeshBasicMaterial)}setGlobals(t,i,r,n,a,s,o,l){this.getDLFromObject=t,this.onGeometryDisposeDS=i,this.camera=r,this.defaultAppearanceType=n,this.QAAutomationMode=n===e.DefaultAppearanceMode.__QA_AUTOMATION__,this.stateSortingResultID=s,this.enableGSSOCache=a,this.zOnlyPass=o,this.pickingPass=l}reset(){this.getDLFromObject=null,this.onGeometryDisposeDS=null,this.QAAutomationMode=!1,this.defaultAppearanceType=-1,this.stateSortingResultID=-1,this.enableGSSOCache=!1,this.outlineStruct=null,this.object=null,this.cappingMaterial=null,this.zOnlyPass=!1,this.pickingPass=!1}_registerObjectWithOutlines(){this._objectsWithOutlines||(this._objectsWithOutlines={cameraDir:this.outlineStruct.outlinesCameraDirection,objects:new Set}),this._objectsWithOutlines.objects.add(this.object)}_handleOutlines(t){if(!this.outlineStruct)return;const i=this.object,r=this.renderer,n=this.outlineStruct,a=(this.getDLFromObject,this.onGeometryDisposeDS);if(i.fromLoadedModel&&t&&t.getMask()&e.OutlineMask)if(i.geometry&&i.geometry.length&&i.geometry[0]&&i.geometry[0].vertexIndexArray){let s=null;const l=n.outlinesCameraDirection;l&&((s=l.clone()).applyMatrix4((new e.Matrix4).getInverse(i.matrixWorld)),s=new e.Vector3(s.x,s.y,s.z).normalize());let{outlineBG:c,created:h,invalidateGSSO:u}=o.prepareOutlines({object:i,width:t._outlineWidth,viewDirection:s,_sortCount:n.sortCount,_gl:this.gl,visibleSpace:r.visibleSpace,showHiddenOutlines:1===t._hiddenEdges});c.length>0&&(this._registerObjectWithOutlines(),u&&n.objectWithTransientGSSO.add(i),h&&(n.outlinesCreated=!0));for(let e=0;e<c.length;e++){const i=c[e];h&&i.addEventListener("dispose",a);const r=i.drawingGroups[0];this._addDGToDL({geometry:i,dg:r,dgInterval:r,material:r.material,originalMaterial:r.material,renderMode:t})}}else r._NoMeshInRamWarningCount<10&&(console.warn("OutlineBuilding unavailable, make sure noMeshInRAM is inactive"),r._NoMeshInRamWarningCount++)}_handleSectionLines(t){let i=null;if(t&&t._maskWithDefault&e.SectionLineMask){const e=this.object,r=this.renderer,n=(this.getDLFromObject,this.onGeometryDisposeDS);if(e.geometry&&e.geometry.length&&e.geometry[0]&&e.geometry[0].vertexIndexArray){let a=e.sectionLinesBuilder&&e.sectionLinesBuilder.sectionLineGeometry;const s=e.occurrenceRenderingOverride&&e.occurrenceRenderingOverride.sectionLinesProperties,o=s?s.color:null,c=s?s.width:1,h=e.occurrenceRenderingOverride&&e.occurrenceRenderingOverride.clipPlanes;let u=null;e.occurrenceRenderingOverride&&e.occurrenceRenderingOverride.clippingContext&&(u=e.occurrenceRenderingOverride.clippingContext._getSectionLinesArray());const d=a&&e.layer&&!e.layer.upToDate,p=!d&&e.sectionLinesBuilder&&e.sectionLinesBuilder.update({width:c,color:o,clipPlanes:h,sectionLines:u});if(!d&&p||(e.sectionLinesBuilder&&e.sectionLinesBuilder.dispose(),e.sectionLinesBuilder=null,a=null,e.layer&&(e.layer.upToDate=!0)),!a&&!e.sectionLinesBuilder){const t=new l({renderable:e,renderer:r,lineWidth:c,color:o,clipPlanes:h,sectionLines:u});t.computeSectionLineGeometry(),(a=t.sectionLineGeometry)&&a.addEventListener("dispose",n),e.sectionLinesBuilder=t}if(a){const e=a.drawingGroups[0];null===o&&(i=e.material),this._addDGToDL({geometry:a,dg:e,dgInterval:e,material:e.material,originalMaterial:e.material,renderMode:t})}}else r._NoMeshInRamWarningCount<10&&(console.warn("SectionLineBuilding unavailable, make sure noMeshInRAM is inactive"),r._NoMeshInRamWarningCount++)}return i}_handleObjectSectionCapping(e,t,i){const n=this.renderer,a=this.object,s=a.renderPointsOnly;let o=null;if(n.cuttingScene||t){for(let t=0;t<e.length;t++){const a=e[t].drawingGroups;let l=0;for(let e=0;e<a.length;e++){const t=a[e];t._geomType!==r||s||t.count>l&&(o=i&&t.material?t.material:t.gas.isGAS?t.gas.getMaterial(null,4,t.gas,n):t.gas,l=t.count)}}t&&!n.cuttingScene&&o&&o.color&&(a.sectionLinesBuilder.setColor(o.color),o=null)}return o}_getModifiedOriginalMaterial(e,t,i,n,a,s){const o=this.renderer,l=this.object._occurrence;let c=t;!n&&l&&l.__solvedSubstituteMaterials&&l.__solvedSubstituteMaterials.has(t)&&(c=l.__solvedSubstituteMaterials.get(t));let h=a;return i||(c=c.getGeomTypeDeferredMaterial(e._geomType,{boundaryEdge:o.boundaryEdgeMaterialInfo,smoothEdge:s._halfVisibleSmoothEdges>0})),(n&&e._geomType===r||this.QAAutomationMode)&&(c=c.getPredefinedMaterial(o.noiseTexture3D,this.defaultAppearanceType,o._customMaterialModeParams),h=null),c._deferredMaterialsInit||c.updateDeferredMaterials(),[c,h]}_getBackgroundViewModeMaterial(t,i){return this.renderer._backgroundViewMode===e.BackgroundViewMode.GHOST&&t.applyBackgroundViewMode?p||((p=new e.MeshBasicMaterial({force:!0,side:e.Constants.DoubleSide,color:new e.Color(16711680),transparent:!0})).activatePDSFX(),p.setPDSFXOverridableFunctions({},{ProcessFinalColor:"void ProcessFinalColor(inout vec4 color) { color = vec4(1.0, 1.0, 1.0, 0.1); }"}),p):i}_handleOldWorkFlowCommon(e,n,a,s,o,l,u,d){const p=this.object,f=this.renderer;let m=null,g=!1,v=!1;if(l&&u)m=h(u,n);else{const e=p.material||c,t=o||!p.fromLoadedModel,i=e.force&&"forceGeomTypeFACE"!==e.force,a=e.force&&"forceGeomTypeFACE"===e.force,s=t&&i;m=h(e,n),s||(o&&n.material&&n.material.updateDeferredMaterials?m=h(n.material,n):(m=h(n.gas,n),g=!0),a&&n._geomType===r&&(m=e,g=!1,v=!0))}m=this._getBackgroundViewModeMaterial(p,m),!l&&d&&n._geomType===r&&(m=d);const S=p._getFilter(t.LOOK);if(S){const e=S.material;e&&(v=!0,g=!1,m=h(e,n))}[m,i]=this._getModifiedOriginalMaterial(n,m,v,g,null,e);const _=f.materialToUse;let y=m._deferredMaterials[_];if(y){if(l&&f.cuttingScene&&n.glType>=4&&(null!==this.cappingMaterial?y=this.cappingMaterial:this.cappingMaterial=y),m.backMaterial){const t=m.backMaterial._deferredMaterials[_];t&&this._addDGToDL({geometry:s,dg:n,dgInterval:a,material:t,originalMaterial:m,renderMode:e,materialMode:o})}this._addDGToDL({geometry:s,dg:n,dgInterval:a,material:y,originalMaterial:m,renderMode:e,materialMode:o})}}_handleLayerOldWorkflow(e,t,i,r){const n=e.drawableGroup,a=e.drawableInterval,s=e.geometry;this._handleOldWorkFlowCommon(i,n,a,s,r,!0,t,null)}_handleGeometryOldWorkflow(e,t,i,r){const a=this.object,s=this.renderer,o=a.renderPointsOnly,l=a.material||c,h=i||!a.fromLoadedModel,u=l.force&&"forceGeomTypeFACE"!==l.force;let d=null;h&&u||(d=this._handleObjectSectionCapping(e,r,i)),d&&!s.cuttingScene&&("forceGeomTypeFACE"!==l.force||this.QAAutomationMode||(d=l));for(let r=0;r<e.length;r++){const a=e[r],s=a.drawingGroups;for(let e=0;e<s.length;e++){const r=s[e],l=r.glType;o&&l!=n||this._handleOldWorkFlowCommon(t,r,r,a,i,!1,null,d)}}}_handleNewWorkFlowCommon(i,r,n,a,s,o,l,c,u){const p=this.object,f=this.renderer,m=r.glType;let g=!1,v=null,S=!1;const _=p.material;s&&l||!_||!_.force||(l=h(_,r));const y=p.gas;let x=null;if(y?(v=y.getMaterial(o,m,r.gas.isGAS?r.gas:null,f,d(this.camera,p)),x=o.isGAS?o.clone().merge(y):y):(v=o.isGAS?o.getMaterial(null,m,r.gas,f,d(this.camera,p)):o,x=o.isGAS?o:null),x){if(this.pickingPass&&x._noPick)return;const i=p._getFilter(t.ZMODE)||f._GlobalZModeFilter;i&&(x._type===e.GASTypeEnum.NOZ&&i.enableZ?(x=x.clone())._type=e.GASTypeEnum.SKIN:x._type===e.GASTypeEnum.NOZ||i.enableZ||((x=x.clone())._type=e.GASTypeEnum.NOZ))}v&&!l&&(l=v,g=!0);const M=p._getFilter(t.LOOK);if(M){const e=M.material;e&&(S=!0,g=!1,l=h(e,r))}l=this._getBackgroundViewModeMaterial(p,l),[l,c]=this._getModifiedOriginalMaterial(r,l,S,g,c,i);const P=f.materialToUse;let C=l._deferredMaterials[P];if(C){if(this.getDLFromObject,this.onGeometryDisposeDS,l.backMaterial){const e=l.backMaterial._deferredMaterials[P];e&&this._addDGToDL({geometry:a,dg:r,dgInterval:n,material:e,originalMaterial:l,renderMode:i,matApp:c,gasMaterial:v,gasStruct:x,materialMode:s})}u&&f.cuttingScene&&m>=4&&(null!==this.cappingMaterial?l=C=this.cappingMaterial:this.cappingMaterial=C),this._addDGToDL({geometry:a,dg:r,dgInterval:n,material:C,originalMaterial:l,renderMode:i,matApp:c,gasMaterial:v,gasStruct:x,materialMode:s})}}_handleLayerNewWorkflow(e,t,i,r,n){const a=this.object,s=e.drawableGroup,o=s.glType;let l=null,c=null;if(n){const e=a.matApp;let i=e&&e._getMaterialFromGLType(o,s._geomType);t&&(t.isMatApp&&(c=(l=t.solveInheritance(e,a._occurrence.depth))===e?i:t._getMaterialFromGLType(o,s._geomType)),c||t.isMatApp||(l=i?e:null,c=i||t)),c||(l=e,c=i)}this._handleNewWorkFlowCommon(r,s,e.drawableInterval,e.geometry,n,i,c,l,!0)}_handleGeometryNewWorkflow(t,i,a,s){const o=this.object,l=o.renderPointsOnly,c=function(e){return e&&e.materialMode<2}(o);let h=this._handleObjectSectionCapping(t,s,a);const u=c?a:a||!o.fromLoadedModel;for(let s=0;s<t.length;s++){const c=t[s],d=c.drawingGroups;for(let t=0;t<d.length;t++){const s=d[t],p=s.glType;if(l&&p!=n)continue;let f=null,m=null;if(u){const t=o.matApp;let i=t&&t._getMaterialFromGLType(p,s._geomType);s.material&&(s.material.isMatApp&&(m=(f=s.material.solveInheritance(t,o._occurrence.depth))===t?i:s.material._getMaterialFromGLType(p,s._geomType)),m||s.material.isMatApp||(f=i?t:null,(m=i)||(m=s.material instanceof e.Material?s.material:null))),m||(f=t,m=i),!h||t&&f===t||s._geomType!==r||(m=h)}this._handleNewWorkFlowCommon(i,s,s,c,a,s.gas,m,f,!1)}}}_handleObjectWithLayers(e,t,i){const r=this.object,a=r.layer,s=this.renderer,o=r.renderPointsOnly,l=a.layers.length;this.cappingMaterial=null;for(let c=0;c<l;c++){const l=a.layers[c];let h=l.drawableInterval.getMaterial();if(l.drawableInterval.skip(r,s.visibleSpace))continue;const u=l.drawableGroup,d=u.glType;if(!o||d==n)if(e||h&&h.isMatApp){h||(h=u.material);let e=l.drawableInterval.gas;e||(e=u.gas),this._handleLayerNewWorkflow(l,h,e,t,i)}else this._handleLayerOldWorkflow(l,h,t,i)}}_handleObject(e,t,i,r){let n=this.object.geometry;n.length||0===n.length||(n=[n]),e?this._handleGeometryNewWorkflow(n,t,i,r):this._handleGeometryOldWorkflow(n,t,i,r)}_addDGToDL({material:e,originalMaterial:t,dg:i=null,dgInterval:r=null,geometry:n,renderMode:a=null,matApp:s=null,gasMaterial:o=null,gasStruct:l=null,materialMode:c=!1}){this.renderer.addDGToDL({object:this.object,geometry:n||this.object.geometry,dg:i,dgInterval:r,material:e,originalMaterial:t,renderMode:a,matApp:s,gasMaterial:o,gasStruct:l,getDLFromObjectFunc:this.getDLFromObject,geomDisposeFunc:this.onGeometryDisposeDS,enableGSSOCache:this.enableGSSOCache,camera:this.camera,materialMode:c})}solve(i){this.object=i;const r=this.object._occurrence,n=this.renderer,a=n.materialToUse,s=i.material;let o=null;const l=i.matApp,c=n.newMaterialInheritance||!!function(e){if(!e.geometry.length)return!1;const t=e.geometry[0].drawingGroups;return!(!t||!t.length)&&t[0].gas&&t[0].gas.isGAS}(i)||!!l;var h=i._getFilter(t._MATERIAL_TO_USE);if(h&&h.materialToUse!==a)return;if(r&&r._isFurtiveFiltered())return;if(!c&&s&&(s._deferredMaterialsInit||s.updateDeferredMaterials(),s.line&&!s.line._deferredMaterialsInit&&s.line.updateDeferredMaterials(),s.point&&!s.point._deferredMaterialsInit&&s.point.updateDeferredMaterials(),o=s._deferredMaterials[a]),void 0===o&&(o=s),null===i._gsso_cache&&(i._gsso_cache={}),i._gsso_cache[this.stateSortingResultID]||(i._gsso_cache[this.stateSortingResultID]=[]),i._updateBackgroundViewMode(this.renderer._invertBackgroundNodes),n._backgroundViewMode===e.BackgroundViewMode.NO_DISPLAY&&i.applyBackgroundViewMode)return;if(n._planeViewMode&&n._planeViewMode.mode!==e.PlaneViewMode.NORMAL&&(i._updatePlaneViewMode(n._planeViewMode.plane),i._applyPlaneViewMode)){const t=n._planeViewMode.mode;if(t===e.PlaneViewMode.NO_DISPLAY)return;if(this.pickingPass&&t===e.PlaneViewMode.LOWLIGHT_NO_PICK)return}this.getDLFromObject,this.onGeometryDisposeDS,this.camera;const u=n.getRenderMode(i);if(i.renderLineMode=u.getMasks()[1],2===i.geometry._type||i.geometry.length>=0){const e=i.layer,t=n.getMaterialMode(i,this.zOnlyPass);this._handleOutlines(u);const r=this._handleSectionLines(u);e?this._handleObjectWithLayers(c,u,t):this._handleObject(c,u,t,r)}else c&&s?(s._deferredMaterialsInit||s.updateDeferredMaterials(),s.backMaterial&&this._addDGToDL({material:s.backMaterial._deferredMaterials[a],originalMaterial:s}),this._addDGToDL({material:s._deferredMaterials[a],originalMaterial:s})):(o.backMaterial&&this._addDGToDL({material:o.backMaterial._deferredMaterials[a],originalMaterial:s}),this._addDGToDL({material:o,originalMaterial:s}))}}}),define("DS/Visualization/Info",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";const t=function(){this.programs=0,this.geometries=0,this.textures=0,this.renderTargets=0,this.sharedbuffers=0};t.prototype.reset=function(){this.programs=0,this.geometries=0,this.textures=0,this.renderTargets=0,this.sharedbuffers=0};const i=function(e){this.name=e||"",this._duration=0,this._parent=null,this.children=[]};i.prototype.push=function(e){e._parent=this,this.children.push(e)},i.prototype.start=function(){this._duration=performance.now()},i.prototype.end=function(){this._duration=performance.now()-this._duration};const r=function(){this.activated=!1,this.curNode=null,this.frameTypeMap=new Map};r.prototype.enable=function(e){this.activated=e,this.curNode=null,e&&this.frameTypeMap.clear()},r.prototype.pushRoot=function(e){this.activated&&(this.curNode=new i,this.frameTypeMap.set(e,this.curNode),this.curNode.start())},r.prototype.popRoot=function(){this.activated&&(this.curNode&&this.curNode.end(),this.curNode=null)},r.prototype.push=function(e){if(this.curNode){var t=new i(e);this.curNode.push(t),this.curNode=t,this.curNode.start()}},r.prototype.pop=function(){this.curNode&&(this.curNode.end(),this.curNode=this.curNode._parent)};const n=function(){this.calls=0,this.vertices=0,this.faces=0,this.lines=0,this.points=0,this.objectUniformCalls=0,this.swapMaterials=0,this.swapPrograms=0,this.swapBuffers=0,this.unsharedBuffers=0,this.swapScenes=0,this.cullingCalls=0,this.culledMeshes=0,this.culledGeometries=0,this.culledDGTriangles=0,this.culledDGLines=0,this.nbDGs=0,this.nbReps=0,this.nbDGsSSBProcessed=0};return n.prototype.reset=function(){this.calls=0,this.vertices=0,this.faces=0,this.lines=0,this.points=0,this.objectUniformCalls=0,this.swapMaterials=0,this.swapPrograms=0,this.swapBuffers=0,this.unsharedBuffers=0,this.swapScenes=0,this.cullingCalls=0,this.culledMeshes=0,this.culledGeometries=0,this.culledDGTriangles=0,this.culledDGLines=0,this.nbDGs=0,this.nbReps=0,this.nbDGsSSBProcessed=0},n.prototype.getRendering=function(){return{swapMaterials:this.swapMaterials,swapPrograms:this.swapPrograms,swapScenes:this.swapScenes,objectUniformCalls:this.objectUniformCalls,swapBuffers:this.swapBuffers,unsharedBuffers:this.unsharedBuffers}},n.prototype.getGeometries=function(){return{calls:this.calls,vertices:this.vertices,faces:this.faces,lines:this.lines,points:this.points,nbDGs:this.nbDGs,nbReps:this.nbReps,nbDGsSSBProcessed:this.nbDGsSSBProcessed}},n.prototype.getCulling=function(){return{cullingCalls:this.cullingCalls,culledMeshes:this.culledMeshes,culledGeometries:this.culledGeometries,culledDGTriangles:this.culledDGTriangles,culledDGLines:this.culledDGLines}},{MemoryInfo:t,RenderTimeInfo:r,RenderInfo:n}}),define("DS/Visualization/HighlightData",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t="true"===localStorage.getItem("__1x3HL__"),i=function(){this._needsDepth=!1,this.outlineEnabled=!0,this.outlineColor=(new e.Color).setRGB(1,1,1),this.outlineAlpha=1,this.outlineThickness=1,this.haloEnabled=!0,this.haloColor=(new e.Color).setRGB(1,1,1),this.haloIntensity=2,this.haloThickness=4,this.color=(new e.Color).setRGB(1,1,1),this.colorEnabled=!0,this._id=0,this.priority=1,this.clearDepth=!1};i.prototype._setOutlineData=function(e){this.outlineEnabled=void 0!==e.outlineEnabled?e.outlineEnabled:this.outlineEnabled,void 0!==e.outlineColor&&this.outlineColor.copy(e.outlineColor),this.outlineAlpha=void 0!==e.outlineAlpha?e.outlineAlpha:this.outlineAlpha,this.outlineThickness=void 0!==e.outlineThickness?e.outlineThickness:this.outlineThickness},i.prototype._setHaloData=function(e){this.haloEnabled=void 0!==e.haloEnabled?e.haloEnabled:this.haloEnabled,void 0!==e.haloColor&&this.haloColor.copy(e.haloColor),this.haloIntensity=void 0!==e.haloIntensity?e.haloIntensity:this.haloIntensity,this.haloThickness=void 0!==e.haloThickness?e.haloThickness:this.haloThickness,this.haloThickness=Math.min(this.haloThickness,4)},i.prototype._setGenericData=function(e){void 0!==e.priority&&0!==this.priority&&0!==e.priority&&(this.priority=e.priority),void 0!==e.clearDepth&&0!==this.priority&&(this.clearDepth=e.clearDepth)},i.prototype._setColorData=function(e){this.colorEnabled=void 0!==e.colorEnabled?e.colorEnabled:this.colorEnabled,void 0!==e.color&&this.color.copy(e.color)},i.prototype.isEqual=function(e){return(void 0===e.outlineEnabled||e.outlineEnabled===this.outlineEnabled)&&((void 0===e.outlineAlpha||e.outlineAlpha===this.outlineAlpha)&&((void 0===e.haloEnabled||e.haloEnabled===this.haloEnabled)&&((void 0===e.haloIntensity||e.haloIntensity===this.haloIntensity)&&(!(void 0!==e.outlineColor&&!this.outlineColor.equals(e.outlineColor))&&((void 0===e.outlineThickness||this.outlineThickness===e.outlineThickness)&&(!(void 0!==e.haloColor&&!this.haloColor.equals(e.haloColor))&&(!(void 0!==e.color&&!this.color.equals(e.color))&&((void 0===e.colorEnabled||e.colorEnabled===this.colorEnabled)&&((void 0===e.priority||e.priority===this.priority)&&(void 0===e.clearDepth||e.clearDepth===this.clearDepth))))))))))},i.prototype._updateMixPassUniforms=function(e,t){this._id=t;var i=t-1,r=3*i;e.iHaloColors.value[r]=this.haloEnabled?this.haloColor.r:0,e.iHaloColors.value[r+1]=this.haloEnabled?this.haloColor.g:0,e.iHaloColors.value[r+2]=this.haloEnabled?this.haloColor.b:0,e.iOutlineColors.value[r]=this.outlineEnabled?this.outlineColor.r:0,e.iOutlineColors.value[r+1]=this.outlineEnabled?this.outlineColor.g:0,e.iOutlineColors.value[r+2]=this.outlineEnabled?this.outlineColor.b:0,e.iOutlineAlphas.value[i]=this.outlineEnabled?this.outlineAlpha:-1,e.iOutlineThicknesses.value[i]=this.outlineEnabled?this.outlineThickness:0,e.iColors.value[r]=this.colorEnabled?this.color.r:0,e.iColors.value[r+1]=this.colorEnabled?this.color.g:0,e.iColors.value[r+2]=this.colorEnabled?this.color.b:0},i.prototype._updateMaterialUniforms=function(e,t){var i=e.uniforms;i&&(i.highlightID&&(i.highlightID.value=this._id),i.iHighlightColor&&(i.iHighlightColor.value.x=this.color.r,i.iHighlightColor.value.y=this.color.g,i.iHighlightColor.value.z=this.color.b),i.iHighlightLineicColor&&(i.iHighlightLineicColor.value.x=this.outlineColor.r,i.iHighlightLineicColor.value.y=this.outlineColor.g,i.iHighlightLineicColor.value.z=this.outlineColor.b))};var r=function(e){i.call(this),this.intensity=1,this._setData(e)};(r.prototype=Object.create(i.prototype))._updateMixPassUniforms=function(e,t){i.prototype._updateMixPassUniforms.call(this,e,t);var r=t-1,n=2*r;e.iHaloIntensities.value[r]=this.haloEnabled?this.haloIntensity*this.haloIntensity:0,e.iColorIntensities.value[n]=this.colorEnabled?this.intensity:0,e.iColorIntensities.value[n+1]=-1},r.prototype.isEqual=function(e){return!!i.prototype.isEqual.call(this,e)&&(void 0===e.intensity||e.intensity===this.intensity)},r.prototype._updateMaterialUniforms=function(e,t){i.prototype._updateMaterialUniforms.call(this,e,t);var r=e.uniforms;r&&r.iHighlightIntensity&&(r.iHighlightIntensity.value.x=this.colorEnabled?this.intensity:0,r.iHighlightIntensity.value.y=-1)},r.prototype._setColorData=function(e){i.prototype._setColorData.call(this,e),this.intensity=void 0!==e.intensity?e.intensity:this.intensity},r.prototype._setData=function(e){e=e||{},this._setColorData(e),this._setHaloData(e),this._setOutlineData(e),this._setGenericData(e)};var n=function(t){i.call(this),this._needsDepth=!0,this.visibleAlpha=1,this.occludedAlpha=1,this.lineicOutlineColor=(new e.Color).setRGB(1,1,1),this.lineicHaloColor=(new e.Color).setRGB(1,1,1),this._setData(t)};return(n.prototype=Object.create(i.prototype)).isEqual=function(e){return!!i.prototype.isEqual.call(this,e)&&((void 0===e.visibleAlpha||e.visibleAlpha===this.visibleAlpha)&&((void 0===e.occludedAlpha||e.occludedAlpha===this.occludedAlpha)&&(!(void 0!==e.lineicOutlineColor&&!this.lineicOutlineColor.equals(e.lineicOutlineColor))&&!(void 0!==e.lineicHaloColor&&!this.lineicHaloColor.equals(e.lineicHaloColor)))))},n.prototype._updateMixPassUniforms=function(e,t){i.prototype._updateMixPassUniforms.call(this,e,t);var r=t-1,n=2*r,a=3*r;e.iHaloIntensities.value[r]=this.haloEnabled?1.4*this.haloIntensity:0,e.iColorIntensities.value[n]=this.colorEnabled?this.visibleAlpha:0,e.iColorIntensities.value[n+1]=this.colorEnabled?this.occludedAlpha:0,e.iLineicOutlineColors.value[a]=this.outlineEnabled?this.lineicOutlineColor.r:0,e.iLineicOutlineColors.value[a+1]=this.outlineEnabled?this.lineicOutlineColor.g:0,e.iLineicOutlineColors.value[a+2]=this.outlineEnabled?this.lineicOutlineColor.b:0,e.iLineicHaloColors.value[a]=this.haloEnabled?this.lineicHaloColor.r:0,e.iLineicHaloColors.value[a+1]=this.haloEnabled?this.lineicHaloColor.g:0,e.iLineicHaloColors.value[a+2]=this.haloEnabled?this.lineicHaloColor.b:0},n.prototype._updateMaterialUniforms=function(e,t){i.prototype._updateMaterialUniforms.call(this,e,t);var r=e.uniforms;r&&(r.rgbaDepth&&(r.rgbaDepth.value=t.politeDepthBuffer),r.iHighlightIntensity&&(r.iHighlightIntensity.value.x=Math.max(this.visibleAlpha,.3),r.iHighlightIntensity.value.y=Math.max(this.occludedAlpha,.1)))},n.prototype._setPoliteData=function(e){i.prototype._setColorData.call(this,e),this.visibleAlpha=void 0!==e.visibleAlpha?e.visibleAlpha:this.visibleAlpha,this.occludedAlpha=void 0!==e.occludedAlpha?e.occludedAlpha:this.occludedAlpha},n.prototype._setData=function(e){e=e||{},this._setPoliteData(e),this._setHaloData(e),this._setOutlineData(e),this._setGenericData(e),void 0!==e.lineicOutlineColor&&this.lineicOutlineColor.copy(e.lineicOutlineColor),void 0!==e.lineicHaloColor&&this.lineicHaloColor.copy(e.lineicHaloColor)},{DefaultHighlightData:{halo:new r({colorEnabled:!0,color:(new e.Color).setRGB(0,.6,1),intensity:1,haloEnabled:!0,haloColor:(new e.Color).setRGB(0,.6,1),haloThickness:4,haloIntensity:2,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(0,1,1),outlineAlpha:1,outlineThickness:1}),advancedpolite:new n({colorEnabled:!0,color:(new e.Color).setRGB(0,.6,1),visibleAlpha:.6,occludedAlpha:.15,haloEnabled:!0,haloColor:(new e.Color).setRGB(0,.6,1),lineicHaloColor:t?(new e.Color).setRGB(0,.85,1):(new e.Color).setRGB(0,1,1),haloIntensity:2,haloThickness:4,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(0,1,1),lineicOutlineColor:t?(new e.Color).setRGB(0,1,1):(new e.Color).setRGB(0,.6,1),outlineAlpha:1,outlineThickness:1})},DefaultPreHighlightData:{halo:new r({colorEnabled:!1,color:(new e.Color).setRGB(0,.6,1),intensity:1,haloEnabled:!0,haloColor:(new e.Color).setRGB(0,.6,1),haloIntensity:2,haloThickness:1,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(0,1,1),outlineAlpha:1,outlineThickness:1}),advancedpolite:new n({colorEnabled:!0,color:(new e.Color).setRGB(.97,.97,.97),visibleAlpha:.3,occludedAlpha:0,haloEnabled:!0,haloColor:(new e.Color).setRGB(.67,.67,.69),lineicHaloColor:t?(new e.Color).setRGB(.7,.7,.72):(new e.Color).setRGB(1,1,1),haloIntensity:1.3,haloThickness:4,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(.97,.97,.97),lineicOutlineColor:t?(new e.Color).setRGB(1,1,1):(new e.Color).setRGB(.7,.7,.72),outlineAlpha:1,outlineThickness:1})},HaloHighlightData:r,AdvancedPoliteHighlightData:n}}),define("DS/Visualization/SkinningTransformation",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";const t=function(){this.useEulerAngles=!1,this.skinningMap=null,this.skinningMapWidth=0,this.skinningMapWidth=0};t.prototype.setSkinningMatrices=function(t,i){var r;this.skinningMapWidth&&this.skinningMapHeight||(r=i>256?64:i>64?32:i>16?16:8,this.skinningMapWidth=r,this.skinningMapHeight=r);if(this.useEulerAngles=!1,this.skinningMap)this.skinningMap.image.data.set(t,0);else{var n=new Float32Array(this.skinningMapWidth*this.skinningMapHeight*3);n.set(t,0),this.skinningMap=new e.DataTexture(n,this.skinningMapWidth,this.skinningMapHeight,e.RGBFormat,e.FloatType),this.skinningMap.minFilter=e.NearestFilter,this.skinningMap.magFilter=e.NearestFilter,this.skinningMap.generateMipmaps=!1,this.skinningMap.flipY=!1}this.skinningMap.needsUpdate=!0},t.prototype.setSkinningEulerAngles=function(t,i){var r;this.skinningMapWidth&&this.skinningMapHeight||(r=i>512?64:i>128?32:i>32?16:8,this.skinningMapWidth=r,this.skinningMapHeight=r);if(this.useEulerAngles=!0,this.skinningMap)this.skinningMap.image.data.set(t,0);else{var n=new Float32Array(this.skinningMapWidth*this.skinningMapHeight*3);n.set(t,0),this.skinningMap=new e.DataTexture(n,this.skinningMapWidth,this.skinningMapHeight,e.RGBFormat,e.FloatType),this.skinningMap.minFilter=e.NearestFilter,this.skinningMap.magFilter=e.NearestFilter,this.skinningMap.generateMipmaps=!1,this.skinningMap.flipY=!1}this.skinningMap.needsUpdate=!0},t.prototype.dispose=function(){this.skinningMap&&this.skinningMap.dispose()};const i=function(){this.useEulerAngles=!1,this.skinningInstancingMaps=null,this.skinningInstancingMapsInfo=null};return i.prototype.setInstancingSkinningMatrices=function(t,i,r){var n,a;if(this.useEulerAngles=!1,this.skinningInstancingMapsInfo&&this.nbBones===i)n=this.skinningInstancingMapsInfo;else{var s=function(e){for(var t=1;t<e;)t*=2;return t},o=debugWebGLV6Viewer.renderer.renderer.context,l=o.getParameter(o.MAX_TEXTURE_SIZE),c=l*l,h=i*r*4,u=Math.ceil(h/c),d=h-Math.floor(h/c)*c,p=s(Math.sqrt(d)),f=s(d/p),m=3*((u-1)*c+p*f);n={nbBones:i,maxTextureSize:l,nbTextures:u,lastTextureSizeX:p,lastTextureSizeY:f},this.skinningInstancingMapsInfo=n}this.skinningInstancingMaps||(this.skinningInstancingMaps=new Array(n.nbTextures),(a=new Float32Array(m)).set(t,0));for(var g=0;g<n.nbTextures-1;g++){var v;if(this.skinningInstancingMaps[g])this.skinningInstancingMaps[g].image.data.set(t.subarray(g*n.maxTextureTotalSize*3,(g+1)*n.maxTextureTotalSize*3),0);else(v=new e.DataTexture(a.subarray(g*n.maxTextureTotalSize*3,(g+1)*n.maxTextureTotalSize*3),n.maxTextureSize,n.maxTextureSize,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,v.magFilter=e.NearestFilter,v.generateMipmaps=!1,v.flipY=!1,this.skinningInstancingMaps[g]=v;this.skinningInstancingMaps[g].needsUpdate=!0}this.skinningInstancingMaps[n.nbTextures-1]?this.skinningInstancingMaps[n.nbTextures-1].image.data.set(t.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,t.length),0):((v=new e.DataTexture(a.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,a.length),n.lastTextureSizeX,n.lastTextureSizeY,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,v.magFilter=e.NearestFilter,v.generateMipmaps=!1,v.flipY=!1,this.skinningInstancingMaps[n.nbTextures-1]=v);this.skinningInstancingMaps[n.nbTextures-1].needsUpdate=!0},i.prototype.setInstancingSkinningEulerAngles=function(t,i,r){var n,a;if(this.useEulerAngles=!0,this.skinningInstancingMapsInfo&&this.nbBones===i)n=this.skinningInstancingMapsInfo;else{var s=function(e){for(var t=1;t<e;)t*=2;return t},o=debugWebGLV6Viewer.renderer.renderer.context,l=o.getParameter(o.MAX_TEXTURE_SIZE),c=l*l,h=i*r*2,u=Math.ceil(h/c),d=h-Math.floor(h/c)*c,p=s(Math.sqrt(d)),f=s(d/p),m=3*((u-1)*c+p*f);n={nbBones:i,maxTextureSize:l,nbTextures:u,lastTextureSizeX:p,lastTextureSizeY:f},this.skinningInstancingMapsInfo=n}this.skinningInstancingMaps||(this.skinningInstancingMaps=new Array(n.nbTextures),(a=new Float32Array(m)).set(t,0));for(var g=0;g<n.nbTextures-1;g++){var v;if(this.skinningInstancingMaps[g])this.skinningInstancingMaps[g].image.data.set(t.subarray(g*n.maxTextureTotalSize*3,(g+1)*n.maxTextureTotalSize*3),0);else(v=new e.DataTexture(a.subarray(g*n.maxTextureTotalSize*3,(g+1)*n.maxTextureTotalSize*3),n.maxTextureSize,n.maxTextureSize,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,v.magFilter=e.NearestFilter,v.generateMipmaps=!1,v.flipY=!1,this.skinningInstancingMaps[g]=v;this.skinningInstancingMaps[g].needsUpdate=!0}this.skinningInstancingMaps[n.nbTextures-1]?this.skinningInstancingMaps[n.nbTextures-1].image.data.set(t.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,t.length),0):((v=new e.DataTexture(a.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,a.length),n.lastTextureSizeX,n.lastTextureSizeY,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,v.magFilter=e.NearestFilter,v.generateMipmaps=!1,v.flipY=!1,this.skinningInstancingMaps[n.nbTextures-1]=v);this.skinningInstancingMaps[n.nbTextures-1].needsUpdate=!0},i.prototype.dispose=function(){if(this.skinningInstancingMaps)for(var e=0;e<this.skinningInstancingMaps.length;e++){var t=this.skinningInstancingMaps[e];t&&t.dispose()}},{SkinningTransformations:t,SkinningTransformationsInstancing:i}}),define("DS/VisuDataAccess/ProxyAbstraction",["DS/Visualization/ProxyAbstraction"],function(e){"use strict";return e}),define("VisuDataAccess/ProxyAbstraction",["DS/VisuDataAccess/ProxyAbstraction","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/ProxyAbstraction"),e}),define("DS/Animation/AnimationGroup",["DS/Animation/ANIM","DS/Animation/AbstractAnimation"],function(e,t){"use strict";var i=function(){t.call(this),this._children=[]};return(i.prototype=new t).duration=function(){for(var e=0,t=0;t<this._children.length;++t)e=Math.max(e,this._children[t].offset+this._children[t].animation.duration());return e},i.prototype.animationCount=function(){return this._children.length},i.prototype.animationAt=function(t){return e.assert(0<=t&&t<this.animationCount()),this._children[t].animation},i.prototype.indexOfAnimation=function(e){for(var t=0;t<this._children.length;++t)if(this._children[t].animation===e)return t;return-1},i.prototype.addAnimation=function(t,r){e.assert(r&&this.state()===e.State.STOPPED&&r.state()===e.State.STOPPED),e.assert(!(r instanceof i)||!r.isAncestorOf(this)),r._group&&r._group.removeAnimation(r),r.setDirection(this.direction()),r.setLoop(0),this._children.push({offset:t,animation:r}),r._group=this},i.prototype.removeAnimation=function(t){e.assert(t&&t._group===this&&this.state()===e.State.STOPPED);var i=this.indexOfAnimation(t);this._children.splice(i,1),t._group=null},i.prototype.moveAnimation=function(t,i){e.assert(t&&t._group===this&&this.state()===e.State.STOPPED);var r=this.indexOfAnimation(t);this._children[r].offset=i},i.prototype.clear=function(){e.assert(this.state()===e.State.STOPPED);for(var t=0;t<this._children.length;++t)this._children[t].animation._group=null;this._children=[]},i.prototype.isAncestorOf=function(e){for(;e;){if(e===this)return!0;e=e._group}return!1},i.prototype._updateCurrentTime=function(t){for(var i=e.State.STOPPED,r=0;r<this._children.length;++r){var n=this._children[r];n.animation._time=t-n.offset,n.animation._updateCurrentTime(n.animation._time),i=n.offset<this.time()&&this.time()<n.offset+n.animation.duration()?this.state():e.State.STOPPED,n.animation._state!==i&&(n.animation._state=i,n.animation._updateState(i))}},i.prototype._updateState=function(t){for(var i=e.State.STOPPED,r=0;r<this._children.length;++r){var n=this._children[r];i=n.offset<this.time()&&this.time()<n.offset+n.animation.duration()?this.state():e.State.STOPPED,n.animation._state!==i&&(n.animation._state=i,n.animation._updateState(i))}},i.prototype._updateDirection=function(e){for(var t=0;t<this._children.length;++t){var i=this._children[t];i.animation._direction=e,i.animation._updateDirection(e)}},i}),define("Animation/AnimationGroup",["DS/Animation/AnimationGroup","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Animation/AnimationGroup"),e}),define("DS/RenderEngineUtils/DisplayRangeListBackToFront",["DS/RenderEngineUtils/DisplayRangeList"],function(e){"use strict";var t=function(t,i,r,n,a){e.call(this,t,i,r,n,a)};return(t.prototype=Object.create(e.prototype)).getSortId=function(e,t){return 0},t.prototype.sortDrawablesBackToFront=function(e){var t=e.matrixWorldInverse.elements,i=this.tree.get(0),r=i?i.next:null;if(r)for(var n=null;null!==r;){if(null!==(n=r.object).renderDepth)n.z=n.renderDepth;else{var a=n.worldRadius,s=n.worldCenter,o=t[2]*s.x+t[6]*s.y+t[10]*s.z+t[14];n.z=o+a}for(var l=r.attachment,c=!1;l!==i&&n.z<l.object.z;)l=l.attachment,c=!0;var h=r.next;if(c){var u=r.attachment;u.next=h,h&&(h.attachment=u);var d=l.next;l.next=r,r.next=d,r.attachment=l,d&&(d.attachment=r)}r=h}},t}),define("DS/RenderEngineUtils/DisplayList",["DS/Mesh/ThreeJS_Base","DS/Visualization/WidelinesHelper","DS/RenderEngineUtils/DisplayRangeList","DS/RenderEngineUtils/DisplayRangeListBackToFront"],function(e,t,i,r){"use strict";var n=0,a=0,s=function(t){this.name="",this.string_id=n.toString(),n++,this.active=!0,this.priority=0,this.zSort=e.FrontToBack,this.side=e.DoubleSide,this.clearDepth=!1,this.clearStencil=!1,this.useStencil=!1,this.pickingPriority=!1,this.depthTest=!0,this.depthWrite=!0,this.depthFunc=null,this.polygonOffset=!1,this.polygonOffsetFactor=1,this.polygonOffsetUnits=1,this.canOIT=!1,this.canForceSideOnSolids=!1,this.hasTranspar=!1,this.hasDecal=!1,this.neverSort=!1,this.hasPoliteDepth=!0,this.hasOcclusionDepth=!0,this.noz=!1,this.sortByGLType=!1,this.setValues(t),this._materialList=[],this._displayRangeLists=new Map,this.index=-1,this.ssrId=-1,this.mustZSort=!1,this._sortByProgramNextFrame=!0,this._fatherDL=null},o=function(e,t,i,r,n,a,s,o){this.material=e,this.occurrenceRenderingOverride=t,this.id=i,this.occurrenceRenderingOverrideId=r,this.decalSortID=n,this.glType=a,this.materialToUse=s,this._objectsTransparentOnGPU=o};return s.prototype.addDrawable=function({material:n,object:s,geometry:l,dg:c,dgInterval:h,renderMode:u,renderVolumesOnly:d,geomDisposeFunc:p,materialToUse:f,matApp:m,gasMaterial:g,cpInfos:v=null,qaAutomationMode:S}){var _=!1,y=null,x=f+"-"+n.id;c&&this.canForceSideOnSolids&&0===f&&n._autoForceSide&&(5===c._dimension||g&&0===g.side)&&(s._forceBackFacesOnSolid=!0);var M=!1,P=null;s&&s.occurrenceRenderingOverride&&(M=(y=s.occurrenceRenderingOverride).isPurePGP(),x=x+"#"+(P=y.getGSSOId(M)));var C=-1;this.hasDecal&&s&&s._isInDecalPass()&&(x=x+"!"+s._decalData.stencilID+"?"+s._decalData.key,C=s._decalData.key);var b=!1;if(s._vertexColors&&n._allowObjectColor){x=x+"VC"+s._vertexColors;var D=s._vertexColors;b=(D&e.VertexColorType.A)>0||D<=e.VertexColorType.RGBA}this.neverSort&&(x+=a++);var w=this._displayRangeLists.get(x);if(M&&w){let e=w.occurrenceRenderingOverride;e&&e.getGSSOId(e.isPurePGP())!==P&&(w=null)}if(!w){var E=x.toString()+"_"+this.string_id;w=this.mustZSort?new r(n,y,this.ssr.id,E,this):new i(n,y,this.ssr.id,E,this),this._displayRangeLists.set(x,w),(_=w._setRenderingInfos(this,f))||this._displayRangeLists.delete(x)}if(n.isWideLine||n.is2DLine){if(!d){var T=l.computeWideLine(c,n);if(!T)return!1;if(l.wideLinesLinker&&(l.wideLinesLinker.linkedGeometry.addEventListener("dispose",p),n.isDashedLine&&(n.isCPUPattern||!l.wideLinesLinker.linkedGeometry.cpuPatternMode&&l.wideLinesLinker.linkedGeometry.vertexLineDistancesArray||t._computeWideLineDistances(l.wideLinesLinker.linkedGeometry))),h===c)h=T;else{var A=T.getPrimitiveStart(h.primitiveStart),I=T.getPrimitiveStart(h.primitiveStart+h.primitiveCount-1),R=T.getPrimitiveCount(h.primitiveStart+h.primitiveCount-1);A>=0&&I>=0&&(h={start:A,count:I-A+R},T.getPrimitiveStart(0)!==T.start&&(h.start+=T.start))}w.add({object:s,geometry:l.wideLinesLinker.linkedGeometry,dg:T,dgInterval:h,renderMode:u,renderVolumesOnly:d,materialToUse:f,matApp:m,gasMaterial:g,qaAutomationMode:S})}}else{if(n.isDashedLine&&!n.is2DLine)if(n.isCPUPattern);else if(l.cpuPatternMode||!l.vertexLineDistancesArray||l.isAttributeStale("position")){if(l&&!l.vertexIndexArray)return!1;t._computeLineDistances(l)}w.add({object:s,geometry:l,dg:c,dgInterval:h,renderMode:u,renderVolumesOnly:d,materialToUse:f,matApp:m,gasMaterial:g,cpInfos:v,qaAutomationMode:S})}if(_){var L=this._materialList,O=new o(n,y,x,y?y.id:-1,C,c?c.glType:-1,f,b);this._sortByProgramNextFrame=!0,L.push(O)}},s.prototype.empty=function(){for(var e=this._materialList,t=e.length,i=this._displayRangeLists,r=0;r<t;r++){var n=i.get(e[r].id);n&&n.material._displayRangeLists.delete(e[r].id.toString()+"_"+this.string_id)}e.length=0,i.clear()},s.prototype.cleanMaterialListAndDRLs=function(){for(var e=this._displayRangeLists,t=0,i=0,r=0,n=-1,a=this._materialList;t<a.length;){n=a[t].id;var s=e.get(n);s&&s.getFirstDrawable()?r>0?(a.splice(i,r),t=++i,r=0):i=++t:(r++,e.delete(n),s&&s.material._displayRangeLists.delete(n.toString()+"_"+this.string_id),t++)}r>0&&a.splice(i,r)},s.prototype.init=function(){},s.prototype.finalize=function(){},s.prototype.setValues=function(e){if(void 0!==e)for(var t in e){var i=e[t];void 0!==i?t in this&&(this[t]=i):console.warn("DisplayList: '"+t+"' parameter is undefined.")}},s}),define("DS/Materials/WebGLProgramManager",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t=function(e,t){this.program=e,this.shaderVersion=t};t.prototype.disposeProgram=function(e,t){e(t,this.program.program,!1)};var i,r=function(){this.programs=new Map};r.prototype.disposeAllPrograms=function(e,t){this.programs.forEach(function(i,r,n){i.disposeProgram(e,t)}),this.programs.clear()};var n=function(){this.renderers=new Array(i);for(var e=0;e<i;e++)this.renderers[e]=new Map};n.prototype.getActive=function(e,t){var i=this.renderers[t];return i.has(e)||i.set(e,new r),i.get(e)},n.prototype.disposeAllPrograms=function(e,t){for(var i=0;i<this.renderers.length;i++){var r=this.renderers[i];r.forEach(function(i,r,n){i.disposeAllPrograms(e,t)}),r.clear()}},n.prototype.disposeAllRendererPrograms=function(e,t,i){for(var r=0;r<this.renderers.length;r++){var n=this.renderers[r];n.has(i)&&(n.get(i).disposeAllPrograms(e,t),n.delete(i))}};var a=function(t){i=e.RendererMode._count,this.material=t,this.programPools=new Map,this.activeProgramPool=null,this.currentContextId=-1,this.currentRendererId=-1,this.currentRendererMode=-1};a.prototype.setActive=function(e,t,i){this.programPools.has(e)||this.programPools.set(e,new n),this.activeProgramPool=this.programPools.get(e).getActive(t,i).programs,this.currentContextId=e,this.currentRendererId=t,this.currentRendererMode=i},a.prototype.getProgram=function(e,t,i){var r=this.activeProgramPool.get(e);return r?r.shaderVersion!==t?(this.disposeCurrentProgram(i,e),null):r.program:null},a.prototype.addProgram=function(e,i,r){this.activeProgramPool.set(e,new t(i,r))},a.prototype.disposeAllPrograms=function(e){var t=this;this.programPools.forEach(function(i,r,n){i.disposeAllPrograms(e,t.material)}),this.programPools.clear(),this.activeProgramPool=null,this.currentContextId=-1,this.currentRendererId=-1,this.currentRendererMode=-1},a.prototype.disposeAllRendererPrograms=function(e,t,i){this.programPools.has(t)&&this.programPools.get(t).disposeAllRendererPrograms(e,this.material,i)},a.prototype.disposeCurrentProgram=function(e,t){if(this.activeProgramPool.has(t)){var i=this.activeProgramPool.get(t);this.activeProgramPool.delete(t),e(this.material,i.program,!1)}};Math.pow(2,31);return a.prototype.getProgramID=function(e,t,i){var r=e?e._programID:0,n=t?t._programID:0;return i+(r|this.material._programID|n)},a.prototype.getTokenProgramID=function(e,t){return t+((e?e._programID:0)|this.material._programID)},a}),define("DS/Materials/Material",["DS/Mesh/ThreeJS_Base","DS/Materials/WebGLProgramManager","DS/Materials/DeferredCaches","DS/CoreEvents/Events"],function(e,t,i,r){"use strict";var n=0,a=new e.Matrix3,s=new e.Matrix4;const o=new Set;o.add("programManager"),o.add("program"),o.add("_displayRangeLists"),o.add("_PDSFXData"),o.add("_deferredMaterials"),o.add("_deferredMaterialsInit"),o.add("_dspbrFlakes"),o.add("_specGlossFlakes"),o.add("_clearCoat"),o.add("_volume"),o.add("_sheenData"),o.add("_sheen"),o.add("_anisotropy"),o.add("_displacement"),o.add("_iridescence"),o.add("_thickness"),o.add("_fromGLTF"),o.add("__physicalMode");var l=function(){e.EventDispatcher.call(this),this._usePhongLighting=!1,this.id=n++,this._sceneGraphOrderMode=0,this.name="",this._useCount=0,this._source=e.AssetSource.MANUAL,this._side=e.Constants.FrontSide,this.forceSide=!1,this._opacity=1,this._transparent=!1,this.blending=e.NormalBlending,this.blendSrc=e.SrcAlphaFactor,this.blendDst=e.OneMinusSrcAlphaFactor,this.blendEquation=e.AddEquation,this.depthTest=!0,this.depthFunc=null,this.depthWrite=!0,this.colorWrite=!0,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.vertexColors=e.VertexColorType.NoColors,this.polite=!1,this.politeMaterial=null,this.useGASColor=!1,this.useGASOpacity=!1,this._alphaTest=0,this.alphaTestMode=e.AlphaTestMode.DISCARD,this._visible=!0,this.enableClipPlanes=!0,this.clipPlaneIndex=0,this.clipPlaneUseModelMaterial=null,this.mappingType=-1,this.mappingTransformSemantic=1,this.mappingObjTransformation=s,this.mappingNormTransformation=a,this.mappingUVTransformation=a,this.mappingUseFragment=!1,this.needsUpdate=!0,this.overridable=!0,this._forceAllowFullMaterialOverride=!1,this.force=!1,this.context=null,this.backMaterial=null,this.isBackMaterial=!1,this.isOIT=!1,this.useBlending=!1,this.previousOccurrenceRenderingOverride=null,this._programID=0,this.uniforms=null,this.vertexShader=null,this.fragmentShader=null,this.program=null,this.programManager=new t(this),this.shaderID=0,this.attributes=null,this._definePickingInstancing=!1,this.isInstancingMaterial=!1,this.enableReceiveShadowOnCapping=!1,this._renderedClipPlane=null,this.line=null,this.point=null,this._allowObjectColor=!1,this._PDSFXData=null,this.isWideLine=!1,this.isDashedLine=!1,this.is2DLine=!1,this.isCPUPattern=!1,this.refreshUniforms=function(e,t,i){},this._refreshPDSFXUniforms_private=function(e,t,i){this.refreshPDSFXUniforms&&this.refreshPDSFXUniforms()},this.refreshPDSFXUniforms=function(){},this._displayRangeLists=new Map,this._deferredMaterialsInit=!1,this._deferredMaterials=[];for(var i=0;i<e.MaterialToUse.totalMaterial;i++)this._deferredMaterials[i]=null;this._deferredMaterials[e.MaterialToUse.originalMaterial]=this,this._loadingTextures=null};l.prototype.isPDSFX=function(){return!!this._PDSFXData&&this._PDSFXData.PDSFX},l.prototype._needsUpdateIfTexturesAreReady=function(){var t=this;if(this.needsUpdate)for(var i=this._getTextures(!1),r=0;r<i.length;r++){var n=i[r];n&&n.onLoadCallbacks&&n.loadEndStatus!==e.AssetLoadingStatus.READY&&n.loadEndStatus!==e.AssetLoadingStatus.INIT&&(this._loadingTextures||(this._loadingTextures=new Set),this._loadingTextures.has(n)||(this._loadingTextures.add(n),n.onLoadCallbacks.push(function(){t._sendEvent("requestVisuUpdate")}),n.onRequest&&n.onRequest()))}if(this._loadingTextures){var a=!0;this._loadingTextures.forEach(function(t){a=a&&(t.loadEndStatus===e.AssetLoadingStatus.READY||t.loadEndStatus===e.AssetLoadingStatus.INIT||t.loadEndStatus===e.AssetLoadingStatus.ERROR),t.onRequest&&t.onRequest()}),a&&(this._loadingTextures=null,this.needsUpdate=!0)}},l.prototype._isTextureAvailable=function(t){return!!this[t]&&(this[t].loadEndStatus===e.AssetLoadingStatus.READY||this[t].loadEndStatus===e.AssetLoadingStatus.INIT)},l.prototype.requireTangentBinormal=function(){return!1},l.prototype.requireVertexTangentBinormal=function(){return!1},l.prototype.deferrable=!1,l.prototype.isPhysicalMaterial=!1,l.prototype._autoForceSide=!1,l.prototype._setMaterialShaderOptions=function(e,t,i,r,n,a){var s={};(t||i||r)&&Object.assign(s,{normalMap:this._isTextureAvailable("normalMap"),normalMapFlipY:!!this.normalMapFlipY,bumpMap:this._isTextureAvailable("bumpMap")}),Object.assign(e,s)},l.prototype._dump=function(){return{type:this.getType(),pdsfx:this.isPDSFX(),opacity:this.opacityMap?"texture":this._opacity,useGASColor:this.useGASColor}},l.prototype._getTextures=function(e){return[]},l.prototype._transparencyOnGPU=function(t){if(this.isPDSFX()||this.alphaTest>0)return!0;var i=!1;return t&&t._vertexColors>0?i=this._allowObjectColor&&((t._vertexColors&e.VertexColorType.A)>0||t._vertexColors<=e.VertexColorType.RGBA):this.vertexColors>0&&(i=(this.vertexColors&e.VertexColorType.A)>0||this.vertexColors<=e.VertexColorType.RGBA),i},l.prototype._isTransparent=function(e){return this._transparent||this._opacity<1||this._transparencyOnGPU(e)},l.prototype._loadTextureInfo=function(e,t,i,r,n,a){},l.prototype._loadMappingInfo=function(e,t,i,r){if(r.mappingType){var n=e.mappingNormTransformation;i.uniformMatrix3fv(r.mappingNormTransformation,!1,t.float32Matrix3x3Temp.setDoubles(n.elements)),n=e.mappingUVTransformation,i.uniformMatrix3fv(r.mappingUVTransformation,!1,t.float32Matrix3x3Temp.setDoubles(n.elements)),n=e.mappingObjTransformation,i.uniformMatrix4fv(r.mappingObjTransformation,!1,t.float32Matrix4x4Temp.setDoubles(n.elements)),i.uniform1i(r.mappingType,e.mappingType),i.uniform1i(r.mappingTransformSemantic,e.mappingTransformSemantic)}},l.prototype._computeAmbianceKeyAndProcessMaterial=function(){return this._needsUpdateIfTexturesAreReady(),0},Object.defineProperty(l.prototype,"opacity",{set:function(e){this.setOpacity(e)},get:function(){return this._opacity}}),Object.defineProperty(l.prototype,"alphaTest",{set:function(e){this.setAlphaTest(e)},get:function(){return this._alphaTest}}),Object.defineProperty(l.prototype,"transparent",{set:function(e){e!==this._transparent&&this._invalidateDisplayRangeLists(),this._transparent=e},get:function(){return this._transparent}}),Object.defineProperty(l.prototype,"side",{set:function(e){this._side!==e&&this._invalidateDisplayRangeLists(),this._side=e},get:function(){return this._side}}),Object.defineProperty(l.prototype,"visible",{set:function(e){this._visible!==e&&this._invalidateDisplayRangeLists(),this._visible=e},get:function(){return this._visible}}),Object.defineProperty(l.prototype,"PDSFX_OverridableFunctions_FS",{get:function(){return this._PDSFXData?this._PDSFXData.PDSFX_OverridableFunctions_FS:null}}),Object.defineProperty(l.prototype,"pdsfxUniforms",{get:function(){return console.warn("Do not access the 'pdsfxUniforms' property! Use one of these API functions instead: Material.getPDSFXUniform, Material.setPDSFXUniforms, or Material.updatePDSFXUniform."),this._PDSFXData?this._PDSFXData.pdsfxUniforms:null}}),Object.defineProperty(l.prototype,"PDSFX",{get:function(){return console.warn("Please call the Material.isPDSFX function instead."),this.isPDSFX()}}),l.prototype._invalidateDisplayRangeLists=function(){this._displayRangeLists.forEach(function(e,t){e.flagObjectsAsGSSOInvalidated()})},l.prototype._notifyDLtoBeSortedNextFrame=function(){this._displayRangeLists.forEach(function(e,t){e.dl._sortByProgramNextFrame=!0})},l.prototype.setPDSFXUniforms=function(t){if(this._PDSFXData&&this._PDSFXData.PDSFX){var i=!1,r=0,n=this._PDSFXData.pdsfxUniformsCode,a=null;for(var s in t)if(a=e.ToGLSLTypes[t[s].type]){a.isTexture&&(this._PDSFXData.pdsfxUseMap=!0),i=a.isArray;var o=a.isInt?t[s].stage===e.FragmentStage?"fragment":"vertex":"common";i?t[s].length>0&&(r=t[s].length,n[o]+="uniform "+a.t+" "+s+"["+r+"];\n"):n[o]+="uniform "+a.t+" "+s+";\n"}this._PDSFXData.pdsfxUniforms=t,this._PDSFXData._setUniformsList(),this.needsUpdate=!0}},l.prototype.updatePDSFXUniform=function(e,t){this._PDSFXData&&this._PDSFXData.PDSFX&&void 0!==this._PDSFXData.pdsfxUniforms[e]&&(this._PDSFXData.pdsfxUniforms[e].value=t)},l.prototype.getPDSFXUniform=function(e){if(this._PDSFXData&&this._PDSFXData.PDSFX)return this._PDSFXData.pdsfxUniforms&&void 0!==this._PDSFXData.pdsfxUniforms[e]?{name:e,value:this._PDSFXData.pdsfxUniforms[e].value}:null},l.prototype.setBackMaterial=function(e){this.isBackMaterial?console.warn("You can't set a back material on a back material"):(this.backMaterial=e,null!==this.backMaterial&&(this.backMaterial.polygonOffset=!0,this.backMaterial.polygonOffsetFactor=-10,this.backMaterial.polygonOffsetUnits=-10,this.backMaterial.isCPUPattern=this.isCPUPattern,this.backMaterial.isBackMaterial=!0,this.targetPrimitiveType!==this.backMaterial.targetPrimitiveType||this.is2DLine&&!this.backMaterial.is2DLine?(console.warn("The back material you are using is not compatible with the main material: primitive types don't match"),this.backMaterial=null):this.needsUpdate=!0),this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())},l.prototype.setPDSFXVaryings=function(t){if(this._PDSFXData&&this._PDSFXData.PDSFX){var i=0,r="",n=null;for(var a in t)(n=e.ToGLSLTypes[t[a].type])&&(n.canBeVarying||console.warn("setPDSFXVaryings - The type "+t[a].type+" cannot be used for a varying."),n.isArray&&t[a].length>0?(i=t[a].length,r+="varying "+n.t+" "+a+"["+i+"];\n"):r+="varying "+n.t+" "+a+";\n");this._PDSFXData.pdsfxVaryingsCode=r,this.needsUpdate=!0}},l.prototype.setPDSFXGlobalShaderCode=function(e,t){this._PDSFXData&&this._PDSFXData.PDSFX&&(this._PDSFXData.pdsfxGlobalVariablesCode_VS=e,this._PDSFXData.pdsfxGlobalVariablesCode_FS=t,this.needsUpdate=!0)},l.prototype.setPDSFXPolygonOffset=function(t){if(this._PDSFXData&&this._PDSFXData.PDSFX){this.polygonOffset=!0;var i=e.PDSFXPolygonOffsetParams[t];i&&(this.polygonOffsetFactor=i[0],this.polygonOffsetUnits=i[1])}},l.prototype.setMappingOperator=function(t,i,r,n){if(t.length)switch(t){case"PLANAR":t=1;break;case"SPHERICAL":t=2;break;case"CUBIC":t=3;break;case"CYLINDRICAL":t=4;break;case"INFINITE_CYLINDRICAL":t=5;break;case"SPHERICAL_NORMALIZED":t=6;break;case"INFINITE_CYLINDRICAL_NORMALIZED":t=7;break;case"INFINITE_CYLINDRICAL_NORM_ANGLE_PRES":t=8}this.mappingType=t,void 0!==n&&(this.mappingUseFragment=n),i instanceof e.Matrix4&&(this.mappingObjTransformation=i,this.mappingObjTransformation.isIdentity()?(this.mappingObjTransformation=s,this.mappingNormTransformation=a):this.mappingNormTransformation=(new e.Matrix3).getInverse(i).transpose()),r instanceof e.Matrix3&&(this.mappingUVTransformation=r,this.mappingUVTransformation.isIdentity()&&(this.mappingUVTransformation=a)),this.needsUpdate=!0},l.prototype.getType=function(){return"Unknown"},l.prototype.areTexturesLoaded=function(){return!this.map||!this._alphaTest||this.map.loadEndStatus!==e.AssetLoadingStatus.LOADING&&this.map.loadEndStatus!==e.AssetLoadingStatus.PAUSED},l.prototype._sendEvent=function(e,t){t=t||{},r.publish({event:"/VISU/"+e,data:{eventChannel:"/VISU/"+e,eventType:"@"+e,extraData:t}})},l.prototype.setOpacity=function(e){(1===this._opacity&&e<1||this._opacity<1&&1===e)&&this._invalidateDisplayRangeLists(),this._opacity=e},l.prototype.setAlphaTest=function(e){this._alphaTest!==e&&(this.needsUpdate=!0,this._deferredMaterialsInit&&this.updateDeferredMaterials()),(0===this._alphaTest&&e>0||this._alphaTest>0&&0===e)&&this._invalidateDisplayRangeLists(),this._alphaTest=e},l.prototype.getOpacity=function(){return this._opacity},l.prototype.setValues=function(t){void 0!==t&&(e.setValuesToObject(this,t,o),null!==this.backMaterial&&(this.backMaterial.polygonOffset=!0,this.backMaterial.polygonOffsetFactor=-10,this.backMaterial.polygonOffsetUnits=-10,this.backMaterial.isCPUPattern=this.isCPUPattern,this.backMaterial.isBackMaterial=!0,(this.targetPrimitiveType!==this.backMaterial.targetPrimitiveType||this.is2DLine&&!this.backMaterial.is2DLine)&&(console.warn("The back material you are using is not compatible with the main material: primitive types don't match"),this.backMaterial=null)),this.alphaTest&&this.alphaTestMode===e.AlphaTestMode.DISCARD&&(this.transparent=!0),null===this.mappingObjTransformation||this.mappingObjTransformation.isIdentity()?(this.mappingObjTransformation=s,this.mappingNormTransformation=a):this.mappingNormTransformation=(new e.Matrix3).getInverse(this.mappingObjTransformation).transpose(),(null===this.mappingUVTransformation||this.mappingUVTransformation.isIdentity())&&(this.mappingUVTransformation=a))},l.prototype._defaultPDSFXOverridableFunctions=function(){return{vertex:{ComputeCommonValues:e.ShaderChunk.PDSFXComputeCommonValues_VS,ComputeObjectPosition:e.ShaderChunk.PDSFXComputeObjectPosition_VS,ComputeObjectNormal:e.ShaderChunk.PDSFXComputeObjectNormal_VS,ComputeObjectTexCoord0:e.ShaderChunk.PDSFXComputeObjectTexCoord0_VS,ComputeObjectTexCoord1:e.ShaderChunk.PDSFXComputeObjectTexCoord1_VS,ComputeObjectTexCoord2:e.ShaderChunk.PDSFXComputeObjectTexCoord2_VS,ComputeObjectTangent:e.ShaderChunk.PDSFXComputeObjectTangent_VS,ComputeObjectBinormal:e.ShaderChunk.PDSFXComputeObjectBinormal_VS,ProcessViewTangentSpace:e.ShaderChunk.PDSFXProcessViewTangentSpace_VS,ProcessClipSpacePosition:e.ShaderChunk.PDSFXProcessClipSpacePosition_VS,ComputeVaryingValues:e.ShaderChunk.PDSFXComputeVaryingValues_VS},fragment:{ComputeCommonValues:e.ShaderChunk.PDSFXComputeCommonValues_FS,ComputeDiscard:e.ShaderChunk.PDSFXComputeDiscard_FS,ComputeAlbedo:e.ShaderChunk.PDSFXComputeAlbedo_FS,_ComputeDiffuseTexel:e.ShaderChunk.PDSFX_ComputeDiffuseTexel_FS,ComputeViewPosition:e.ShaderChunk.PDSFXComputeViewPosition_FS,ComputeViewNormal:e.ShaderChunk.PDSFXComputeViewNormal_FS,ComputeOpacity:e.ShaderChunk.PDSFXComputeOpacity_FS,ProcessFinalColor:e.ShaderChunk.PDSFXProcessFinalColor_FS}}},l.prototype._setDefaultPDSFXOverridableFunctions=function(){var e=this._defaultPDSFXOverridableFunctions();Object.assign(this._PDSFXData.PDSFX_OverridableFunctions_VS,e.vertex),Object.assign(this._PDSFXData.PDSFX_OverridableFunctions_FS,e.fragment),this.needsUpdate=!0},l.prototype._getPDSFXOverridableFunctions_VS=function(){return this._PDSFXData?Object.values(this._PDSFXData.PDSFX_OverridableFunctions_VS).join("\n"):""},l.prototype._getPDSFXOverridableFunctions_FS=function(){return this._PDSFXData?Object.values(this._PDSFXData.PDSFX_OverridableFunctions_FS).join("\n"):""},l.prototype.activatePDSFX=function(){throw"Called abstract activatePDSFX"},l.prototype.setPDSFXOverridableFunctions=function(e,t){this._PDSFXData&&this._PDSFXData.PDSFX?(this._PDSFXData._setPDSFXOverridableFunctions(e,t),this.needsUpdate=!0):console.warn("Not a PDSFX material: please call activatePDSFX() first.")},l.prototype._canUseLights=function(){return!0},l.prototype.clone=function(e){return void 0===e&&(e=new l),e.name=this.name,e.side=this.side,e.forceSide=this.forceSide,e._opacity=this._opacity,e.transparent=this.transparent,e.blending=this.blending,e.blendSrc=this.blendSrc,e.blendDst=this.blendDst,e.blendEquation=this.blendEquation,e.useGASColor=this.useGASColor,e.useGASOpacity=this.useGASOpacity,e.depthTest=this.depthTest,e.depthFunc=this.depthFunc,e.depthWrite=this.depthWrite,e.colorWrite=this.colorWrite,e.polygonOffset=this.polygonOffset,e.polygonOffsetFactor=this.polygonOffsetFactor,e.polygonOffsetUnits=this.polygonOffsetUnits,e.polite=this.polite,e.politeMaterial=this.politeMaterial,e.alphaTest=this.alphaTest,e.alphaTestMode=this.alphaTestMode,e.visible=this.visible,e.force=this.force,e.vertexColors=this.vertexColors,e.enableClipPlanes=this.enableClipPlanes,e.clipPlaneIndex=this.clipPlaneIndex,e.clipPlaneUseModelMaterial=this.clipPlaneUseModelMaterial,e.overridable=this.overridable,e.mappingType=this.mappingType,e.mappingUseFragment=this.mappingUseFragment,e.mappingNormTransformation=this.mappingNormTransformation,e.mappingObjTransformation=this.mappingObjTransformation,e.mappingUVTransformation=this.mappingUVTransformation,this._definePickingInstancing&&(e._definePickingInstancing=this._definePickingInstancing),this.isInstancingMaterial&&(e.isInstancingMaterial=this.isInstancingMaterial),this._PDSFXData&&this._PDSFXData.PDSFX&&(e._PDSFXData=this._PDSFXData.clone(),this.refreshPDSFXUniforms&&(e.refreshPDSFXUniforms=this.refreshPDSFXUniforms),this._refreshPDSFXUniforms_private&&(e._refreshPDSFXUniforms_private=this._refreshPDSFXUniforms_private)),e.isOIT=this.isOIT,e.backMaterial=this.backMaterial,e.isBackMaterial=this.isBackMaterial,e.previousOccurrenceRenderingOverride=this.previousOccurrenceRenderingOverride,e.useBlending=this.useBlending,e._programID=this._programID,e.uniforms=this.uniforms,e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader,e.program=this.program,e.attributes=Object.assign(this.attributes?this.attributes:{},e.attributes),e.enableReceiveShadowOnCapping=this.enableReceiveShadowOnCapping,e._renderedClipPlane=this._renderedClipPlane,e.line=this.line,e.point=this.point,e.isWideLine=this.isWideLine,e.isDashedLine=this.isDashedLine,e.is2DLine=this.is2DLine,e.isCPUPattern=this.isCPUPattern,e.refreshUniforms=this.refreshUniforms,e._allowObjectColor=this._allowObjectColor,e._usePhongLighting=this._usePhongLighting,e},l.prototype.updateDeferredMaterials=function(e){this._deferredMaterialsInit=!0},l.prototype.getGeomTypeDeferredMaterial=function(e,t){return this},l.prototype.dispose=function(){this.dispatchEvent({type:"dispose"})},l.prototype._needsIBLLightExtraction=function(){return!1},l.prototype._shaderID=null,l.prototype._forceOpaqueShadowMapPass=function(){return!1},l.prototype.recompileShaders=function(e,t){if(t&&t.onlyDeferred||(t&&t.callback&&t.callback(this),this.needsUpdate=!0),this._deferredMaterialsInit){var i=this._deferredMaterials,r=t?t.deferredChannels:null;if(r&&r.length>0)for(var n=0;n<r.length;n++){(a=i[r[n]])&&(t&&t.callback&&t.callback(a),a.needsUpdate=!0)}else for(n=0;n<i.length;n++){var a;(a=i[n])&&(t&&t.callback&&t.callback(a),a.needsUpdate=!0)}}e&&(this.line&&this.line.recompileShaders(!1,t),this.point&&this.point.recompileShaders(!1,t))},l.prototype.getBaseId=function(){var e="id";return this._PDSFXData&&this._PDSFXData.PDSFX&&(e+=this._getPDSFXOverridableFunctions_FS(),e+=this._getPDSFXOverridableFunctions_VS(),null!==this._PDSFXData.pdsfxUniforms&&(e+=this.id)),e};var c=new e.Matrix3(.01,0,0,0,-.01,0,0,.01,1);return l.prototype.getPredefinedMaterial=function(t,r,n){if(r===e.DefaultAppearanceMode.BASIC)return this;var a=this,s=i._loadPredefinedMaterialTextures(!0,function(){a._sendEvent("requestVisuUpdate")},!1),o=this.getBaseId();switch(o+="Lighted",o+="S"+this.side,o+="CP"+this.enableClipPlanes,o+="Type"+r,r){case e.DefaultAppearanceMode._GASLOOK_OLD:if(o+="Col"+this.color.getHex(),o="id"+(o+="O"+this._opacity).hashCode(),!i.PredefinedMaterials.has(o)){(m=new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,ior:1.576,roughness:.3,color:this.color,opacity:this._opacity})).activatePDSFX();var l={noiseVolume:{type:"t2",value:t}};m.setPDSFXUniforms(l);m.setPDSFXVaryings({noiseCoords:{type:"v3"}});var h=[].join("\n"),u=["#define SLICE_SIDE 64.0","#define SLICES_PER_ROW 8.0","#define INV_SLICES_PER_ROW 1.0 / SLICES_PER_ROW","#define MAP_INVSIZE 0.001953125","vec4 sample3DTexture(vec3 pos) {","pos *= (SLICE_SIDE - 1.0);","float rowID = floor(pos.z * INV_SLICES_PER_ROW);","float rowID2 = rowID;","float colID = mod(floor(pos.z), SLICES_PER_ROW);","float colID2 = mod(ceil(pos.z), SLICES_PER_ROW);","if (colID2 == 0.0) { rowID2 = rowID2 + 1.0; }","float x1 = colID  * SLICE_SIDE + pos.x + 0.5;","float x2 = colID2 * SLICE_SIDE + pos.x + 0.5;","float y1 = rowID  * SLICE_SIDE + pos.y + 0.5;","float y2 = rowID2 * SLICE_SIDE + pos.y + 0.5;","vec2 mapUV  = vec2(x1 * MAP_INVSIZE, 1.0 - y1 * MAP_INVSIZE);","vec2 mapUV2 = vec2(x2 * MAP_INVSIZE, 1.0 - y2 * MAP_INVSIZE);","vec4 alpha1 = texture2D(noiseVolume, mapUV);","vec4 alpha2 = texture2D(noiseVolume, mapUV2);","return mix(alpha1, alpha2, fract(pos.z));","}"].join("\n");m.setPDSFXGlobalShaderCode(h,u);var d={ComputeVaryingValues:["void ComputeVaryingValues() {","noiseCoords = vGetAttribPosition();","}"].join("\n")},p={ComputeViewNormal:["vec3 ComputeViewNormal() {","vec3 vNormal;","vNormal = vGetViewNormal();","vec3 bumpNorm = sample3DTexture(fract(noiseCoords * 0.5)).xxx * 0.04;","bumpNorm = (vGetViewMatrix() * vec4(bumpNorm, 0.0)).xyz;","vNormal += bumpNorm;","vNormal = normalize(vNormal);","return vNormal;","}"].join("\n")};m.setPDSFXOverridableFunctions(d,p);var f=new i.DeferredMaterial(m);i.PredefinedMaterials.set(o,f)}break;case e.DefaultAppearanceMode.GASLOOK:if(o+="Col"+this.color.getHex(),o="id"+(o+="O"+this._opacity).hashCode(),!i.PredefinedMaterials.has(o)){var m=new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,ior:1.5,roughness:.3,color:(new e.Color).set(this.color).multiplyScalar(.85),opacity:this._opacity,clearCoat:.918,clearCoatRoughness:.1,_allowObjectColor:!0});f=new i.DeferredMaterial(m);i.PredefinedMaterials.set(o,f)}break;case e.DefaultAppearanceMode._TRANSPARENT:if(o="id"+(o+="Col"+(v=this.color).getHex()).hashCode(),!i.PredefinedMaterials.has(o)){f=new i.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:v,opacity:.25,roughness:.34,ior:1.5,_allowObjectColor:!0}));i.PredefinedMaterials.set(o,f)}break;case e.DefaultAppearanceMode.CLAY:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){f=new i.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:(new e.Color).setRGB(.64,.34,.26),specular:(new e.Color).setRGB(.996,.851,.694),roughness:.41,ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0}));i.PredefinedMaterials.set(o,f)}break;case e.DefaultAppearanceMode.WHITE_MAT_PLASTER:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){f=new i.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:(new e.Color).setRGB(.922,.922,.922),roughness:1,ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0}));i.PredefinedMaterials.set(o,f)}break;case e.DefaultAppearanceMode.GREY_SHINY_PLASTIC:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){f=new i.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:(new e.Color).setRGB(.584,.584,.584),roughness:.045,ior:1.5,overridable:!1}));i.PredefinedMaterials.set(o,f)}break;case e.DefaultAppearanceMode.CAST_ALUMINUM:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){(g=new e.DSPBR19xMaterial({color:11184810,map:s[6],side:this.side,normalMap:s[7],enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.6,roughnessMap:s[8],ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0})).setMappingOperator(e.MappingType.CUBIC,null,c,!0);f=new i.DeferredMaterial(g);i.PredefinedMaterials.set(o,f)}break;case e.DefaultAppearanceMode.MACHINED_ALUMINUM:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){(g=new e.DSPBR19xMaterial({color:11184810,map:s[14],side:this.side,normalMap:s[15],enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.6,roughnessMap:s[16],ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0})).setMappingOperator(e.MappingType.CUBIC,null,c,!0);f=new i.DeferredMaterial(g);i.PredefinedMaterials.set(o,f)}break;case e.DefaultAppearanceMode.CAST_STEEL:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){(g=new e.DSPBR19xMaterial({color:8947848,map:s[9],side:this.side,enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.4,roughnessMap:s[10],ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0})).setMappingOperator(e.MappingType.CUBIC,null,c,!0);f=new i.DeferredMaterial(g);i.PredefinedMaterials.set(o,f)}break;case e.DefaultAppearanceMode.BRUSHED_STEEL:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){(g=new e.DSPBR19xMaterial({color:11184810,map:s[2],side:this.side,normalMap:s[4],enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.15,roughnessMap:s[5],anisotropyMap:s[3],anisotropyAngle:.14,ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0})).setMappingOperator(e.MappingType.CUBIC,null,c,!0);f=new i.DeferredMaterial(g);i.PredefinedMaterials.set(o,f)}break;case e.DefaultAppearanceMode.MACHINED_STAINLESS_STEEL:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){(g=new e.DSPBR19xMaterial({color:11184810,map:s[17],side:this.side,normalMap:s[18],enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.15,roughnessMap:s[19],anisotropy:.17,anisotropyAngle:.09,ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0})).setMappingOperator(e.MappingType.CUBIC,null,c,!0);f=new i.DeferredMaterial(g);i.PredefinedMaterials.set(o,f)}break;case e.DefaultAppearanceMode.COPPER:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){(g=new e.DSPBR19xMaterial({color:13809841,map:s[11],side:this.side,normalMap:s[12],enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.4,roughnessMap:s[13],ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0})).setMappingOperator(e.MappingType.CUBIC,null,c,!0);f=new i.DeferredMaterial(g);i.PredefinedMaterials.set(o,f)}break;case e.DefaultAppearanceMode.BRASS:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){var g;(g=new e.DSPBR19xMaterial({color:14472604,map:s[0],side:this.side,enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.4,roughnessMap:s[1],ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0})).setMappingOperator(e.MappingType.CUBIC,null,c,!0);f=new i.DeferredMaterial(g);i.PredefinedMaterials.set(o,f)}break;case e.DefaultAppearanceMode.GENERIC_PLASTIC:case e.DefaultAppearanceMode.GENERIC_METAL:var v=n.colorFromGAS?this.color:n.color;if(o="id"+(o+="Col"+(n.colorFromGAS?this.color.getHex():"Custom")).hashCode(),!i.PredefinedMaterials.has(o)){f=new i.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,ior:1.5,color:this.color,overridable:n.colorFromGAS,_forceAllowFullMaterialOverride:!0,_allowObjectColor:n.colorFromGAS}));i.PredefinedMaterials.set(o,f)}(m=i.PredefinedMaterials.get(o).get(this)).color.copy(v),m.metalness=r===e.DefaultAppearanceMode.GENERIC_PLASTIC?0:1,m.roughness=1-n.shininess,m._opacity=n.opacity;break;case e.DefaultAppearanceMode.__QA_AUTOMATION__:var S=this.map||0===this.color.getHex()?new e.Color(11184810):this.color,_=this.opacityMap?1:this._opacity;if(o+="Col"+S.getHex(),o="id"+(o+="Op"+_).hashCode(),!i.PredefinedMaterials.has(o)){(m=new e.MeshBasicMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:S,opacity:_})).activatePDSFX();p={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","vec3 color = ComputeAlbedo();","ioFinalColor.a = ComputeOpacity();","mat4 viewMat = vGetViewMatrix();","vec3 light1 = normalize((viewMat*vec4(0.0,0.0,1.0,0.0)).xyz);","vec3 light2 = normalize((viewMat*vec4(0.0,-1.0,-1.0,0.0)).xyz);","vec3 light3 = normalize((viewMat*vec4(0.0,1.0,-1.0,0.0)).xyz);","vec3 viewNorm = vGetViewNormal();","float ambientCoef = 0.11;","ioFinalColor.rgb = 2.0 * color * (ambientCoef + 0.44*clamp(dot(viewNorm, light1), 0.0, 1.0) + 0.22*clamp(dot(viewNorm, light2), 0.0, 1.0) + 0.22*clamp(dot(viewNorm, light3), 0.0, 1.0));","#ifdef GAMMA_OUTPUT","ioFinalColor.rgb = sqrt(ioFinalColor.rgb);","#endif","}"].join("\n")};m.setPDSFXOverridableFunctions({},p);f=new i.DeferredMaterial(m);i.PredefinedMaterials.set(o,f)}}return i.PredefinedMaterials.get(o).get(this)},l.prototype.__getGAS=function(e){return this},l.prototype._deallocate=function(t){if(this._deferredMaterialsInit){var i=e.MaterialToUse;e.cleanDeferredCache(this.id),this._deferredMaterialsInit=!1,this._deferredMaterials=[];for(var r=0;r<i.totalMaterial;r++)this._deferredMaterials[r]=null;this._deferredMaterials[i.originalMaterial]=this,this.backMaterial&&this._deferredMaterials[i.pickingMaterial]&&this._deferredMaterials[i.pickingMaterial].dispose()}this.needsUpdate=!0},l.prototype.getZOnlyMaterial=function(){var t=this.transparent||this._opacity<1,r="ZOnly-Tr"+t;if(r="id"+r.hashCode(),i.DefaultMaterials.has(r))return i.DefaultMaterials.get(r).get(this);var n=new e.MeshBasicMaterial({force:!0});n.blending=e.CustomBlending,n.useBlending=!0,n.blendDst=e.OneFactor,n.blendSrc=e.ZeroFactor,n.transparent=t,n._opacity=t?.5:1,n.overridable=!1;var a=new i.DeferredMaterial(n);return i.DefaultMaterials.set(r,a),a.get(this)},l.prototype.__dimension=2,l.prototype.targetPrimitiveType="FACES",l.prototype.useClippingTolerance=!1,l}),define("DS/Materials/GradientBackgroundMaterials",["DS/Mesh/ThreeJS_Base","DS/Materials/Material"],function(e,t){"use strict";var i=function(e){this.colors=null,this.YUp=0,this.ratio=1,t.call(this,e)};(i.prototype=Object.create(t.prototype)).clone=function(){throw"Unsupported operation"},i.prototype.getPredefinedMaterial=function(e,t,i){return this},i.prototype.loadUniforms=function(e,t,i,r,n,a){t.uniform1i(i.YUp,this.YUp),t.uniform1f(i.ratio,this.ratio),t.uniform3fv(i.colors,this.colors)},i.prototype.getType=function(){throw"Abstract Gradient material"};var r=function(e){i.call(this,e)};(r.prototype=Object.create(i.prototype)).getType=function(){return"GradientBackground2"},r.prototype._shaderID="gradient2";var n=function(e){i.call(this,e)};(n.prototype=Object.create(i.prototype)).getType=function(){return"GradientBackground3"},n.prototype._shaderID="gradient3";var a=function(e){this.skylineFading=0,this.horizonHeight=0,i.call(this,e)};return(a.prototype=Object.create(i.prototype)).loadUniforms=function(e,t,r,n,a,s){i.prototype.loadUniforms.call(this,e,t,r,n,a,s),t.uniform1f(r.skylineFading,this.skylineFading),t.uniform1f(r.horizonHeight,this.horizonHeight)},a.prototype._shaderID="gradient4",a.prototype.getType=function(){return"GradientBackground4"},{GradientBackgroundMaterial2:r,GradientBackgroundMaterial3:n,GradientBackgroundMaterial4:a}}),define("DS/Materials/DeferrableMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/Material"],function(e,t){"use strict";var i=function(){t.call(this)};return(i.prototype=Object.create(t.prototype)).updateDeferredMaterials=function(t){e.cleanDeferredCache(this.id);for(var i=0;i<this._deferredMaterials.length;i++)this._deferredMaterials[i]=this;this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial]=null,this._deferredMaterials[e.MaterialToUse.ZOnlyMaterial]=this.getZOnlyMaterial(),this._deferredMaterialsInit=!0},i.prototype._setMaterialShaderOptions=function(e,i,r,n,a,s){t.prototype._setMaterialShaderOptions.call(this,e,i,r,n,a,s)},i.prototype.clone=function(e){return void 0===e&&(e=new i),t.prototype.clone.call(this,e),e},i.prototype.deferrable=!0,i}),define("DS/Materials/AbstractAmbianceMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/Material"],function(e,t){"use strict";var i=function(i){this.ambienceMatrix=new e.Matrix4,this.ambienceMatrix2=new e.Matrix4,this.tEnvMap=null,this.tEnvMap2=null,this.envMapExposure=1,this.envMapExposure2=1,this.blurCoef=0,this.intensity=1,this.invScreenSize=new e.Vector2,this.invSize=new e.Vector2,this.offset=new e.Vector2,this.startOffset=new e.Vector2,this.endOffset=new e.Vector2,this.ambient=new e.Color(16777215),this.backgroundColor=new e.Color(16777215),this.backgroundAlpha=1,this.groundPosition=new e.Vector3,this.groundPosition2=new e.Vector3,this.groundNormal=new e.Vector3(0,0,1),this.groundHeight=new e.Vector3(0,0,.23),this.groundRadius=5e3,this.groundRadius2=5e3,this.groundOffset=0,this.groundScale=.78,this.groundScale2=.78,this.transitionCoef=0,this.withGround=0,this.withPlane=0,this.planeColor=new e.Color(16777215),this.tFlip=-1,this.cameraSize=new e.Vector3,this.cameraSight=new e.Vector3,this.cameraUp=new e.Vector3,this.cameraRight=new e.Vector3,this.sceneHeight=new e.Vector3(0,0,.15),this.near=1,this.right=1,this.up=1,this.projectionConic=1,this.defines={},this.enableClipPlanes=!1,t.call(this,i),i&&i.defines&&Object.assign(this.defines,i.defines)};return(i.prototype=Object.create(t.prototype)).clone=function(){throw"Unsupported operation"},i.prototype.getPredefinedMaterial=function(e,t,i){return this},i.prototype.loadUniforms=function(e,t,i,r,n,a){t.uniform1f(i.envMapExposure,this.envMapExposure),t.uniform1f(i.tFlip,this.tFlip),t.uniform1f(i.groundRadius,this.groundRadius),t.uniform1f(i.groundScale,this.groundScale),t.uniform1f(i.groundOffset,this.groundOffset),t.uniform1f(i.projectionConic,this.projectionConic),t.uniform1f(i.up,this.up),t.uniform1f(i.right,this.right),t.uniform1f(i.near,this.near),t.uniform1f(i.intensity,this.intensity),t.uniform1f(i.withGround,this.withGround),t.uniform1f(i.blurCoef,this.blurCoef),t.uniform1f(i.envMapExposure2,this.envMapExposure2),t.uniform1f(i.groundRadius2,this.groundRadius2),t.uniform1f(i.groundScale2,this.groundScale2),t.uniform1f(i.transitionCoef,this.transitionCoef),t.uniform1f(i.withPlane,this.withPlane),t.uniform1f(i.backgroundAlpha,this.backgroundAlpha),t.uniform2f(i.startOffset,this.startOffset.x,this.startOffset.y),t.uniform2f(i.endOffset,this.endOffset.x,this.endOffset.y),t.uniform2f(i.invScreenSize,this.invScreenSize.x,this.invScreenSize.y),t.uniform2f(i.invSize,this.invSize.x,this.invSize.y),t.uniform2f(i.offset,this.offset.x,this.offset.y),t.uniform3f(i.ambient,this.ambient.r,this.ambient.g,this.ambient.b),t.uniform3f(i.groundPosition,this.groundPosition.x,this.groundPosition.y,this.groundPosition.z),t.uniform3f(i.groundPosition2,this.groundPosition2.x,this.groundPosition2.y,this.groundPosition2.z),t.uniform3f(i.groundNormal,this.groundNormal.x,this.groundNormal.y,this.groundNormal.z),t.uniform3f(i.groundHeight,this.groundHeight.x,this.groundHeight.y,this.groundHeight.z),t.uniform3f(i.cameraSize,this.cameraSize.x,this.cameraSize.y,this.cameraSize.z),t.uniform3f(i.cameraSight,this.cameraSight.x,this.cameraSight.y,this.cameraSight.z),t.uniform3f(i.cameraUp,this.cameraUp.x,this.cameraUp.y,this.cameraUp.z),t.uniform3f(i.cameraRight,this.cameraRight.x,this.cameraRight.y,this.cameraRight.z),t.uniform3f(i.sceneHeight,this.sceneHeight.x,this.sceneHeight.y,this.sceneHeight.z),t.uniform3f(i.planeColor,this.planeColor.r,this.planeColor.g,this.planeColor.b),t.uniform3f(i.backgroundColor,this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b),t.uniformMatrix4fv(i.ambienceMatrix,!1,e.float32Matrix4x4Temp.setDoubles(this.ambienceMatrix.elements)),t.uniformMatrix4fv(i.ambienceMatrix2,!1,e.float32Matrix4x4Temp.setDoubles(this.ambienceMatrix2.elements)),i.tEnvMap&&e.loadTexture(t,i.tEnvMap,this.tEnvMap),i.tEnvMap2&&e.loadTexture(t,i.tEnvMap2,this.tEnvMap2);var s=1,o=1;if(this.tEnvMap.hdr&&i.envMapHDRSize&&(this.tEnvMap.image?(s=parseInt(this.tEnvMap.image.width),o=parseInt(this.tEnvMap.image.height)):(s=parseInt(this.tEnvMap.width),o=parseInt(this.tEnvMap.height)),t.uniform2f(i.envMapHDRSize,s,o)),this.tEnvMap2&&(i.envMapHDRToMipsRatio||i.envMapHDRSize2)){var l=1;l=this.tEnvMap2.image?parseInt(this.tEnvMap2.image.width)/s:parseInt(this.tEnvMap2.width)/s,t.uniform1f(i.envMapHDRToMipsRatio,l),this.tEnvMap2.image?(s=parseInt(this.tEnvMap2.image.width),o=parseInt(this.tEnvMap2.image.height)):(s=parseInt(this.tEnvMap2.width),o=parseInt(this.tEnvMap2.height)),t.uniform2f(i.envMapHDRSize2,s,o)}},i.prototype._setMaterialShaderOptions=function(e,i,r,n,a,s){t.prototype._setMaterialShaderOptions.call(this,e,i,r,n,a,s)},i.prototype.areTexturesLoaded=function(){return!!t.prototype.areTexturesLoaded.call(this)&&((!this.tEnvMap||this.tEnvMap.loadEndStatus!==e.AssetLoadingStatus.LOADING)&&(!this.tEnvMap2||this.tEnvMap2.loadEndStatus!==e.AssetLoadingStatus.LOADING))},i}),define("DS/Materials/CubeMapMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/AbstractAmbianceMaterial"],function(e,t){"use strict";var i=function(e){t.call(this,e)};return(i.prototype=Object.create(t.prototype)).getType=function(){return"CubeMap"},i.prototype._shaderID="cubemap",i}),define("DS/Materials/LatLongMapMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/AbstractAmbianceMaterial"],function(e,t){"use strict";var i=function(e){t.call(this,e)};return(i.prototype=Object.create(t.prototype))._shaderID="latlong",i.prototype._setMaterialShaderOptions=function(e,i,r,n,a,s){t.prototype._setMaterialShaderOptions.call(this,e,i,r,n,a,s)},i.prototype.getType=function(){return"LatLongMap"},i}),define("DS/Materials/SimpleMapMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/AbstractAmbianceMaterial"],function(e,t){"use strict";var i=function(e){t.call(this,e)};return(i.prototype=Object.create(t.prototype))._shaderID="simplemap",i.prototype.getType=function(){return"SimpleMap"},i}),define("DS/Materials/FiniteTransitionEnvMapMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/AbstractAmbianceMaterial"],function(e,t){"use strict";var i=function(e){t.call(this,e)};return(i.prototype=Object.create(t.prototype))._shaderID="finitetransition",i.prototype._setMaterialShaderOptions=function(e,i,r,n,a,s){t.prototype._setMaterialShaderOptions.call(this,e,i,r,n,a,s)},i.prototype.getType=function(){return"LatLongMap"},i}),define("DS/Materials/FiniteEnvMapMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/AbstractAmbianceMaterial"],function(e,t){"use strict";var i=function(e){t.call(this,e)};return(i.prototype=Object.create(t.prototype))._shaderID="finiteenvmap",i.prototype._setMaterialShaderOptions=function(e,i,r,n,a,s){t.prototype._setMaterialShaderOptions.call(this,e,i,r,n,a,s)},i.prototype.getType=function(){return"FiniteEnvMap"},i}),define("DS/Materials/PhysicalMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData"],function(e,t,i){"use strict";const r={GGX:0,ASHIKMIN:1,BECKMANN:2,ESTEVEZKULLA:3};e._BRDFS=r;const n=function(e){this.hdr=e.hdr||null,this.brdf=r.GGX,this.direct=e.direct||!1,this.name=e.name||"",this.mips=e.mips||null,this.curID=-1};n.prototype._useCustom=function(){return null!==this.hdr},n.prototype.clone=function(){return new n({hdr:this.hdr,direct:this.direct,name:this.name,mips:this.mips})},e.IBLOverrider=n;const a=0,s=.5,o=1,l=2,c=3,h=4;e.DSPBRSubTypes={Generic:0,Metal:1,Glass:2,Plastic:3,Textile:4,Leather:5,"Car Paint":6,Emissive:7,Basic:8,Wood:9};const u={_NO_SHEEN:"NONE",VELVET:"USE_VELVET",VELVET_SOFT:"USE_SOFT_VELVET",SATIN:"USE_SATIN"};e.SheenMode=u;const d={None:-1,Apple:0,Chicken1:1,Chicken2:2,Cream:3,Ketchup:4,Marble:5,Potato:6,Skimmilk:7,Skin1:8,Skin2:9,Wholemilk:10};e.SubsurfaceScatteringPresets=d;var p=[{absorptionCoeffs:[.003,.0034,.046],scatteringCoeffs:[2.29,2.39,1.97]},{absorptionCoeffs:[.015,.077,.19],scatteringCoeffs:[.15,.21,.38]},{absorptionCoeffs:[.018,.088,.2],scatteringCoeffs:[.19,.25,.32]},{absorptionCoeffs:[2e-4,.0028,.0163],scatteringCoeffs:[7.38,5.47,3.15]},{absorptionCoeffs:[.061,.97,1.45],scatteringCoeffs:[.18,.07,.03]},{absorptionCoeffs:[.0021,.0041,.0071],scatteringCoeffs:[2.19,2.62,3]},{absorptionCoeffs:[.0024,.009,.12],scatteringCoeffs:[.68,.7,.55]},{absorptionCoeffs:[.0014,.0025,.0142],scatteringCoeffs:[.7,1.22,1.9]},{absorptionCoeffs:[.032,.17,.48],scatteringCoeffs:[.74,.88,1.01]},{absorptionCoeffs:[.013,.07,.145],scatteringCoeffs:[1.09,1.59,1.79]},{absorptionCoeffs:[.0011,.0024,.014],scatteringCoeffs:[2.55,3.21,3.77]}],f=function(e){this.envMipMap=e.envMipMap||null,this.overrideIBL=e.overrideIBL||null};f.prototype.clone=function(){return new f({envMipMap:this.envMipMap,overrideIBL:null!==this.overrideIBL?this.overrideIBL.clone():null})},f.prototype._useCustom=function(){return null!==this.overrideIBL&&this.overrideIBL._useCustom()};var m=new e.Matrix3,g=new e.Color,v=function(e,t){e[t+"Map"]=null,e[t+"AddCoef"]=null,e[t+"MulCoef"]=null,e[t+"UvTransform"]=m,e[t+"UvSlot"]=1},S=function(e,t,i){e[t]=i,v(e,t)},_=function(e,t,i){t[i+"Map"]=e[i+"Map"],t[i+"AddCoef"]=e[i+"AddCoef"],t[i+"MulCoef"]=e[i+"MulCoef"],t[i+"UvTransform"]=e[i+"UvTransform"],t[i+"UvSlot"]=e[i+"UvSlot"]},y=function(e,t,i,r){r?t[i].copy(e[i]):t[i]=e[i],_(e,t,i)},x=function(e){return null===e||e.isIdentity()?m:e};const M=new Set;M.add("__parent__"),M.add("__needDisplacementUpdate"),M.add("_sssLUT"),M.add("_scatteringCoeffs"),M.add("_absorptionCoeffs"),M.add("_translucencyDepth"),M.add("_updateSSS"),M.add("_subsurface");var P=function(e,t){this.__parent__=t,this.setParameters(e)};P.prototype.loadUniforms=function(e,t,i,r){},P.prototype.setParameters=function(t){var i=this.__parent__,r={};if(i&&!i.needsUpdate&&this.setMaterialShaderOptions(r),e.setValuesToObject(this,t,M),i&&!i.needsUpdate){var n={};this.setMaterialShaderOptions(n);for(var a=Object.keys(r),s=0;s<a.length;s++)if(r[a[s]]!==n[a[s]]){i.needsUpdate=!0;break}}},P.prototype.isEnabled=function(){return!1},P.prototype.setMaterialShaderOptions=function(){},P.prototype.getTextures=function(){return[]},P.prototype._isTextureAvailable=t.prototype._isTextureAvailable,P.prototype.clone=function(e){return null};var C=function(t,i){S(this,"flakesCoverage",0),S(this,"flakesSize",0),S(this,"flakesRoughness",0),S(this,"flakesColor",new e.Color(16777215)),S(this,"flipFlopColor",new e.Color(16777215)),S(this,"flipFlop",0),P.call(this,t,i)};(C.prototype=Object.create(P.prototype)).loadUniforms=function(e,t,i,r){var n;this.isEnabled()&&(i.flakesColor&&(n=e.gammaInput?g.copyToLinear(this.flakesColor,e.simpleGamma):this.flakesColor,t.uniform3f(i.flakesColor,n.r,n.g,n.b)),i.flakesColorMap&&e.loadTexture(t,i.flakesColorMap,this.flakesColorMap),i.flakesColorMulCoef&&(t.uniform3f(i.flakesColorMulCoef,this.flakesColorMulCoef.x,this.flakesColorMulCoef.y,this.flakesColorMulCoef.z),t.uniform3f(i.flakesColorAddCoef,this.flakesColorAddCoef.x,this.flakesColorAddCoef.y,this.flakesColorAddCoef.z)),i.flakesCoverage&&t.uniform1f(i.flakesCoverage,this.flakesCoverage),i.flakesCoverageMap&&e.loadTexture(t,i.flakesCoverageMap,this.flakesCoverageMap),i.flakesCoverageMulCoef&&(t.uniform1f(i.flakesCoverageMulCoef,this.flakesCoverageMulCoef),t.uniform1f(i.flakesCoverageAddCoef,this.flakesCoverageAddCoef)),i.flakesSize&&t.uniform1f(i.flakesSize,this.flakesSize),i.flakesSizeMap&&e.loadTexture(t,i.flakesSizeMap,this.flakesSizeMap),i.flakesSizeMulCoef&&(t.uniform1f(i.flakesSizeMulCoef,this.flakesSizeMulCoef),t.uniform1f(i.flakesSizeAddCoef,this.flakesSizeAddCoef)),i.flakesRoughness&&t.uniform1f(i.flakesRoughness,this.flakesRoughness),i.flakesRoughnessMap&&e.loadTexture(t,i.flakesRoughnessMap,this.flakesRoughnessMap),i.flakesRoughnessMulCoef&&(t.uniform1f(i.flakesRoughnessMulCoef,this.flakesRoughnessMulCoef),t.uniform1f(i.flakesRoughnessAddCoef,this.flakesRoughnessAddCoef)),i.flipFlop&&t.uniform1f(i.flipFlop,this.flipFlop),i.flipFlopMap&&e.loadTexture(t,i.flipFlopMap,this.flipFlopMap),i.flipFlopMulCoef&&(t.uniform1f(i.flipFlopMulCoef,this.flipFlopMulCoef),t.uniform1f(i.flipFlopAddCoef,this.flipFlopAddCoef)),i.flipFlopColor&&(n=e.gammaInput?g.copyToLinear(this.flipFlopColor,e.simpleGamma):this.flipFlopColor,t.uniform3f(i.flipFlopColor,n.r,n.g,n.b)),i.flipFlopColorMap&&e.loadTexture(t,i.flipFlopColorMap,this.flipFlopColorMap),i.flipFlopColorMulCoef&&(t.uniform3f(i.flipFlopColorMulCoef,this.flipFlopColorMulCoef.x,this.flipFlopColorMulCoef.y,this.flipFlopColorMulCoef.z),t.uniform3f(i.flipFlopColorAddCoef,this.flipFlopColorAddCoef.x,this.flipFlopColorAddCoef.y,this.flipFlopColorAddCoef.z)))},C.prototype.isEnabled=function(){return this.flakesCoverage>0||this._isTextureAvailable("flakesCoverageMap")},C.prototype.clone=function(e){return new C(this,e)},C.prototype.setParameters=function(e){P.prototype.setParameters.call(this,e),this.flakesRoughnessUvTransform=x(this.flakesRoughnessUvTransform),this.flakesSizeUvTransform=x(this.flakesSizeUvTransform),this.flakesCoverageUvTransform=x(this.flakesCoverageUvTransform),this.flakesColorUvTransform=x(this.flakesColorUvTransform),this.flipFlopUvTransform=x(this.flipFlopUvTransform),this.flipFlopColorUvTransform=x(this.flipFlopColorUvTransform)},C.prototype.setMaterialShaderOptions=function(e){var t=this.isEnabled(),i=t&&(this._isTextureAvailable("flipFlopMap")||this.flipFlop>0);Object.assign(e,{dspbrFlakes:t,flakesSizeMap:t&&this._isTextureAvailable("flakesSizeMap"),flakesSizeMulCoef:t&&null!==this.flakesSizeMulCoef,flakesSizeAddCoef:t&&null!==this.flakesSizeAddCoef,flakesCoverageMap:t&&this._isTextureAvailable("flakesCoverageMap"),flakesCoverageMulCoef:t&&null!==this.flakesCoverageMulCoef,flakesCoverageAddCoef:t&&null!==this.flakesCoverageAddCoef,flakesRoughnessMap:t&&this._isTextureAvailable("flakesRoughnessMap"),flakesRoughnessMulCoef:t&&null!==this.flakesRoughnessMulCoef,flakesRoughnessAddCoef:t&&null!==this.flakesRoughnessAddCoef,flakesColorMap:t&&this._isTextureAvailable("flakesColorMap"),flakesColorMapLinear:t&&!!this.flakesColorMap&&this.flakesColorMap.hdr,flakesColorMulCoef:t&&null!==this.flakesColorMulCoef,flakesColorAddCoef:t&&null!==this.flakesColorAddCoef,flipFlop:i,flipFlopColorMap:i&&this._isTextureAvailable("flipFlopColorMap"),flipFlopColorMapLinear:i&&!!this.flipFlopColorMap&&this.flipFlopColorMap.hdr,flipFlopColorMulCoef:i&&null!==this.flipFlopColorMulCoef,flipFlopColorAddCoef:i&&null!==this.flipFlopColorAddCoef,flipFlopMap:i&&this._isTextureAvailable("flipFlopMap"),flipFlopMulCoef:i&&null!==this.flipFlopMulCoef,flipFlopAddCoef:i&&null!==this.flipFlopAddCoef})},C.prototype.getTextures=function(){return[this.flakesSizeMap,this.flakesCoverageMap,this.flakesRoughnessMap,this.flakesColorMap,this.flipFlopColorMap,this.flipFlopMap]};var b=function(t,i){this.flakes=!1,this.flakesColor=new e.Color(0),this.flakesBump=0,this.flakesDensity=0,this.flakesScale=0,this.flakesRoughness=0,this.flakesColorMulCoef=new e.Vector3(1,1,1),this.flakesColorAddCoef=new e.Vector3(0,0,0),this.pearlFlakesColor=new e.Color(0),this.pearlFlakesBump=0,this.pearlFlakesDensity=0,this.pearlFlakesColorMulCoef=new e.Vector3(1,1,1),this.pearlFlakesColorAddCoef=new e.Vector3(0,0,0),P.call(this,t,i)};(b.prototype=Object.create(P.prototype)).loadUniforms=function(e,t,i,r){var n;this.isEnabled()&&(i.flakesColor&&(n=e.gammaInput?g.copyToLinear(this.flakesColor,e.simpleGamma):this.flakesColor,t.uniform3f(i.flakesColor,n.r,n.g,n.b)),i.pearlFlakesColor&&(n=e.gammaInput?g.copyToLinear(this.pearlFlakesColor,e.simpleGamma):this.pearlFlakesColor,t.uniform3f(i.pearlFlakesColor,n.r,n.g,n.b)),i.flakesBump&&t.uniform1f(i.flakesBump,this.flakesBump),i.flakesDensity&&t.uniform1f(i.flakesDensity,this.flakesDensity),i.flakesScale&&t.uniform1f(i.flakesScale,this.flakesScale),i.flakesRoughness&&t.uniform1f(i.flakesRoughness,this.flakesRoughness),i.pearlFlakesDensity&&t.uniform1f(i.pearlFlakesDensity,this.pearlFlakesDensity),i.pearlFlakesBump&&t.uniform1f(i.pearlFlakesBump,this.pearlFlakesBump),this.flakesColorMulCoef&&i.flakesColorMulCoef&&t.uniform3f(i.flakesColorMulCoef,this.flakesColorMulCoef.x,this.flakesColorMulCoef.y,this.flakesColorMulCoef.z),this.flakesColorAddCoef&&i.flakesColorAddCoef&&t.uniform3f(i.flakesColorAddCoef,this.flakesColorAddCoef.x,this.flakesColorAddCoef.y,this.flakesColorAddCoef.z),this.pearlFlakesColorMulCoef&&i.pearlFlakesColorMulCoef&&t.uniform3f(i.pearlFlakesColorMulCoef,this.pearlFlakesColorMulCoef.x,this.pearlFlakesColorMulCoef.y,this.pearlFlakesColorMulCoef.z),this.pearlFlakesColorAddCoef&&i.pearlFlakesColorAddCoef&&t.uniform3f(i.pearlFlakesColorAddCoef,this.pearlFlakesColorAddCoef.x,this.pearlFlakesColorAddCoef.y,this.pearlFlakesColorAddCoef.z))},b.prototype.isEnabled=function(){return this.flakes},b.prototype.clone=function(e){return new b(this,e)},b.prototype.setMaterialShaderOptions=function(e){Object.assign(e,{specGlossFlakes:this.isEnabled()})};var D=function(t,i){S(this,"clearCoat",0),S(this,"clearCoatRoughness",0),S(this,"clearCoatColor",new e.Color(3684408)),this.coatingGlossinessMap=null,this.coatingGlossinessMulCoef=null,this.coatingGlossinessAddCoef=null,v(this,"clearCoatNormal"),this.clearCoatNormalMapFlipY=!1,this.clearCoatNormalScaleMulCoef=1,this.clearCoatNormalScaleAddCoef=0,this.clearCoatNormalScale=1,this.orangePeel=!1,this.orangePeelScale=0,P.call(this,t,i)};(D.prototype=Object.create(P.prototype)).loadUniforms=function(e,t,i,r){if(this.isEnabled()){var n;if(i.clearCoat&&t.uniform1f(i.clearCoat,this.clearCoat),i.clearCoatMap&&e.loadTexture(t,i.clearCoatMap,this.clearCoatMap),i.clearCoatMulCoef&&t.uniform1f(i.clearCoatMulCoef,this.clearCoatMulCoef),i.clearCoatAddCoef&&t.uniform1f(i.clearCoatAddCoef,this.clearCoatAddCoef),i.clearCoatRoughness&&t.uniform1f(i.clearCoatRoughness,this.clearCoatRoughness),i.clearCoatRoughnessMap&&e.loadTexture(t,i.clearCoatRoughnessMap,this.clearCoatRoughnessMap),i.clearCoatRoughnessMulCoef&&(t.uniform1f(i.clearCoatRoughnessMulCoef,this.clearCoatRoughnessMulCoef),t.uniform1f(i.clearCoatRoughnessAddCoef,this.clearCoatRoughnessAddCoef)),i.coatingGlossinessMap&&e.loadTexture(t,i.coatingGlossinessMap,this.coatingGlossinessMap),i.coatingGlossinessMulCoef&&(t.uniform1f(i.coatingGlossinessMulCoef,this.coatingGlossinessMulCoef),t.uniform1f(i.coatingGlossinessAddCoef,this.coatingGlossinessAddCoef)),i.clearCoatNormalMap&&e.loadTexture(t,i.clearCoatNormalMap,this.clearCoatNormalMap),i.clearCoatNormalMulCoef&&(t.uniform3f(i.clearCoatNormalAddCoef,this.clearCoatNormalAddCoef.x,this.clearCoatNormalAddCoef.y,this.clearCoatNormalAddCoef.z),t.uniform3f(i.clearCoatNormalMulCoef,this.clearCoatNormalMulCoef.x,this.clearCoatNormalMulCoef.y,this.clearCoatNormalMulCoef.z)),i.clearCoatNormalScale&&t.uniform1f(i.clearCoatNormalScale,this.clearCoatNormalScaleMulCoef*this.clearCoatNormalScale+this.clearCoatNormalScaleAddCoef),i.clearCoatColor)n=e.gammaInput?g.copyToLinear(this.clearCoatColor,e.simpleGamma):this.clearCoatColor,t.uniform3f(i.clearCoatColor,n.r,n.g,n.b);i.clearCoatColorMap&&e.loadTexture(t,i.clearCoatColorMap,this.clearCoatColorMap),i.clearCoatColorMulCoef&&(t.uniform3f(i.clearCoatColorMulCoef,this.clearCoatColorMulCoef.x,this.clearCoatColorMulCoef.y,this.clearCoatColorMulCoef.z),t.uniform3f(i.clearCoatColorAddCoef,this.clearCoatColorAddCoef.x,this.clearCoatColorAddCoef.y,this.clearCoatColorAddCoef.z)),i.orangePeelScale&&i.orangePeelScale&&t.uniform1f(i.orangePeelScale,this.orangePeelScale)}},D.prototype.isEnabled=function(){return this.clearCoat>0||this._isTextureAvailable("clearCoatMap")},D.prototype.setMaterialShaderOptions=function(e){var t=this.isEnabled();Object.assign(e,{clearCoat:t,clearCoatMap:t&&this._isTextureAvailable("clearCoatMap"),clearCoatMulCoef:t&&null!==this.clearCoatMulCoef,clearCoatAddCoef:t&&null!==this.clearCoatAddCoef,clearCoatRoughnessMap:t&&this._isTextureAvailable("clearCoatRoughnessMap"),clearCoatRoughnessMulCoef:t&&null!==this.clearCoatRoughnessMulCoef,clearCoatRoughnessAddCoef:t&&null!==this.clearCoatRoughnessAddCoef,clearCoatColorMap:t&&this._isTextureAvailable("clearCoatColorMap"),clearCoatColorMapLinear:t&&!!this.clearCoatColorMap&&this.clearCoatColorMap.linear,clearCoatColorMulCoef:t&&null!==this.clearCoatColorMulCoef,clearCoatColorAddCoef:t&&null!==this.clearCoatColorAddCoef,coatingGlossinessMap:t&&!e.dspbr&&this._isTextureAvailable("coatingGlossinessMap"),coatingGlossinessMulCoef:t&&!e.dspbr&&null!==this.coatingGlossinessMulCoef,coatingGlossinessAddCoef:t&&!e.dspbr&&null!==this.coatingGlossinessAddCoef,clearCoatNormalMap:t&&this._isTextureAvailable("clearCoatNormalMap"),clearCoatNormalMapFlipY:t&&this.clearCoatNormalMapFlipY,clearCoatNormalMulCoef:t&&null!==this.clearCoatNormalMulCoef,clearCoatNormalAddCoef:t&&null!==this.clearCoatNormalAddCoef,orangePeel:t&&this.orangePeel&&!this.clearCoatNormalMap})},D.prototype.getTextures=function(){return[this.clearCoatMap,this.clearCoatColorMap,this.coatingGlossinessMap,this.clearCoatRoughnessMap,this.clearCoatNormalMap]},D.prototype.setParameters=function(e){P.prototype.setParameters.call(this,e),this.clearCoatUvTransform=x(this.clearCoatUvTransform),this.clearCoatRoughnessUvTransform=x(this.clearCoatRoughnessUvTransform),this.clearCoatColorUvTransform=x(this.clearCoatColorUvTransform),this.clearCoatNormalUvTransform=x(this.clearCoatNormalUvTransform)},D.prototype.clone=function(e){return new D(this,e)};var w=function(t,i){this.attenuationColor=new e.Color(16777215),this.attenuationDistance=1e6,this.subsurfaceColor=new e.Color(0),this.subsurfaceAnisotropy=0,this._sssLUT=null,this._scatteringCoeffs=null,this._absorptionCoeffs=null,this._translucencyDepth=null,this._updateSSS=0,this._subsurface=!1,P.call(this,t,i)};(w.prototype=Object.create(P.prototype)).loadUniforms=function(e,t,i,r){this.isEnabled()&&(i.sssLUT?(e.loadTexture(t,i.sssLUT,this._sssLUT),t.uniform3f(i.maxTranslucencyDepth,this._translucencyDepth[0],this._translucencyDepth[1],this._translucencyDepth[2])):i.absorptionCoefficients&&t.uniform3f(i.absorptionCoefficients,this._absorptionCoeffs[0],this._absorptionCoeffs[1],this._absorptionCoeffs[2]))},w.prototype.isEnabled=function(){return this._subsurface},w.prototype.setMaterialShaderOptions=function(e){var t=this.isEnabled();Object.assign(e,{subsurface:t,sssLUT:t&&!!this._sssLUT})},w.prototype.getTextures=function(){return[]},w.prototype.setParameters=function(t){var i=this.__parent__,r=this._subsurface,n=void 0!==t.subsurfacePreset&&t.subsurfacePreset!==d.None,a=t.subsurfaceColor?t.subsurfaceColor:this.subsurfaceColor,s=t.attenuationColor?t.attenuationColor:this.attenuationColor;this._subsurface=a.getHex()>0||n;var o=!0;if(!this._subsurface&&s.getHex()<16711422&&(o=!1,this._subsurface=!0),this._subsurface=this._subsurface&&!i.thinWalled,P.prototype.setParameters.call(this,t),this._subsurface){if(n){var l=p[t.subsurfacePreset];this.subsurfaceColor=new e.Color(16777215),this._absorptionCoeffs=l.absorptionCoeffs.slice(0),this._scatteringCoeffs=l.scatteringCoeffs.slice(0)}else{var c=this.attenuationColor,h=Math.max(this.attenuationDistance,1e-6),u=this.subsurfaceColor,f=new e.Color(0);f.r=-Math.log(Math.min(.999,Math.max(c.r,.001)))/h,f.b=-Math.log(Math.min(.999,Math.max(c.b,.001)))/h,f.g=-Math.log(Math.min(.999,Math.max(c.g,.001)))/h;var m=new e.Color(0);m.r=1-Math.pow(4.09712+4.20863*u.r-Math.sqrt(9.59217+41.6808*u.r+17.7126*u.r*u.r),2),m.b=1-Math.pow(4.09712+4.20863*u.b-Math.sqrt(9.59217+41.6808*u.b+17.7126*u.b*u.b),2),m.g=1-Math.pow(4.09712+4.20863*u.g-Math.sqrt(9.59217+41.6808*u.g+17.7126*u.g*u.g),2);var g=new e.Color(0);g.r=f.r*(1-m.r),g.g=f.g*(1-m.g),g.b=f.b*(1-m.b),this._absorptionCoeffs=g.toArray();var v=new e.Color(0);v.r=f.r*m.r,v.g=f.g*m.g,v.b=f.b*m.b,this._scatteringCoeffs=v.toArray()}this._updateSSS=o?2:1}i&&this._subsurface!==r&&(i.needsUpdate=!0)},w.prototype.clone=function(e){return new w(this,e)};var E=function(e,t){S(this,"thickness",0),P.call(this,e,t)};(E.prototype=Object.create(P.prototype)).loadUniforms=function(e,t,i,r){this.isEnabled()&&(i.thickness&&t.uniform1f(i.thickness,this.thickness),i.thicknessMap&&e.loadTexture(t,i.thicknessMap,this.thicknessMap),i.thicknessAddCoef&&(t.uniform1f(i.thicknessMulCoef,this.thicknessMulCoef),t.uniform1f(i.thicknessAddCoef,this.thicknessAddCoef)))},E.prototype.isEnabled=function(){return!this.__parent__.thinWalled&&(this.thickness>0||this._isTextureAvailable("thicknessMap"))},E.prototype.setMaterialShaderOptions=function(e,t){var i=this.isEnabled();Object.assign(e,{thicknessMap:i&&this._isTextureAvailable("thicknessMap"),thickness:i,thicknessMulCoef:i&&null!==this.thicknessMulCoef,thicknessAddCoef:i&&null!==this.thicknessAddCoef})},E.prototype.getTextures=function(){return[this.thicknessMap]},E.prototype.setParameters=function(e){P.prototype.setParameters.call(this,e),this.thicknessUvTransform=x(this.thicknessUvTransform)},E.prototype.clone=function(){return new E(this)};var T=function(e,t){S(this,"anisotropy",0),S(this,"anisotropyAngle",0),P.call(this,e,t)};(T.prototype=Object.create(P.prototype)).loadUniforms=function(e,t,i,r){this.isEnabled()&&(i.anisotropy&&t.uniform1f(i.anisotropy,this.anisotropy),i.anisotropyMap&&e.loadTexture(t,i.anisotropyMap,this.anisotropyMap),i.anisotropyMulCoef&&(t.uniform1f(i.anisotropyMulCoef,this.anisotropyMulCoef),t.uniform1f(i.anisotropyAddCoef,this.anisotropyAddCoef)),i.anisotropyAngle&&t.uniform1f(i.anisotropyAngle,this.anisotropyAngle),i.anisotropyAngleMap&&e.loadTexture(t,i.anisotropyAngleMap,this.anisotropyAngleMap),i.anisotropyAngleMulCoef&&(t.uniform1f(i.anisotropyAngleMulCoef,this.anisotropyAngleMulCoef),t.uniform1f(i.anisotropyAngleAddCoef,this.anisotropyAngleAddCoef)))},T.prototype.isEnabled=function(){return this.anisotropy>0||this._isTextureAvailable("anisotropyMap")},T.prototype.setMaterialShaderOptions=function(e){var t=this.isEnabled();Object.assign(e,{anisotropy:t,anisotropyMap:t&&this._isTextureAvailable("anisotropyMap"),anisotropyMulCoef:t&&null!==this.anisotropyMulCoef,anisotropyAddCoef:t&&null!==this.anisotropyAddCoef,anisotropyAngleMap:t&&this._isTextureAvailable("anisotropyAngleMap"),anisotropyAngleMulCoef:t&&null!==this.anisotropyAngleMulCoef,anisotropyAngleAddCoef:t&&null!==this.anisotropyAngleAddCoef})},T.prototype.getTextures=function(){return[this.anisotropyMap,this.anisotropyAngleMap]},T.prototype.setParameters=function(e,t){P.prototype.setParameters.call(this,e,t),this.anisotropyUvTransform=x(this.anisotropyUvTransform),this.anisotropyAngleUvTransform=x(this.anisotropyAngleUvTransform)},T.prototype.clone=function(e){return new T(this,e)};var A=function(e,t){v(this,"displacement"),this.displacementScale=1,this.displacementBias=0,this.__needDisplacementUpdate=!1,P.call(this,e,t)};(A.prototype=Object.create(P.prototype)).loadUniforms=function(e,t,i,r){if(this.isEnabled()&&i.displacementMap){if(e.loadTexture(t,i.displacementMap,this.displacementMap),this.__needDisplacementUpdate)if(this.__needDisplacementUpdate=!("complete"===this.displacementMap.loadEndStatus||"error"===this.displacementMap.loadEndStatus),!this.__needDisplacementUpdate)this.__parent__._sendEvent("requestShadowMapUpdate");i.displacementBias&&t.uniform1f(i.displacementBias,this.displacementBias),i.displacementMapSize&&t.uniform2f(i.displacementMapSize,this.displacementMap.image.width,this.displacementMap.image.height),i.displacementScale&&t.uniform1f(i.displacementScale,this.displacementScale),i.displacementAddCoef&&(t.uniform3f(i.displacementAddCoef,this.displacementAddCoef.x,this.displacementAddCoef.y,this.displacementAddCoef.z),t.uniform3f(i.displacementMulCoef,this.displacementMulCoef.x,this.displacementMulCoef.y,this.displacementMulCoef.z))}},A.prototype.isEnabled=function(){return this._isTextureAvailable("displacementMap")},A.prototype.setMaterialShaderOptions=function(e){var t=this.__parent__.__physicalMode,i=!e._isDecal&&this.isEnabled()&&(e.specgloss||t>=l);Object.assign(e,{displacementMap:i,displacementAddCoef:i&&null!==this.displacementAddCoef,displacementMulCoef:i&&null!==this.displacementMulCoef})},A.prototype.getTextures=function(){return[this.displacementMap]},A.prototype.setParameters=function(t){P.prototype.setParameters.call(this,t),this.displacementUvTransform=x(this.displacementUvTransform),this.__needDisplacementUpdate=this.displacementMap&&this.displacementMap.loadEndStatus!==e.AssetLoadingStatus.READY},A.prototype.clone=function(e){return new A(this,e)};var I=function(e,t){S(this,"iridescence",0),S(this,"iridescenceThickness",1),this.iridescenceIoR=1.5,this.iridescenceThicknessAddCoef=.1,this.iridescenceThicknessMulCoef=.3,P.call(this,e,t)};(I.prototype=Object.create(P.prototype)).loadUniforms=function(e,t,i,r){this.isEnabled()&&(t.uniform1f(i.iridescenceIoR,this.iridescenceIoR),i.iridescence&&t.uniform1f(i.iridescence,this.iridescence),i.iridescenceMap&&e.loadTexture(t,i.iridescenceMap,this.iridescenceMap),i.iridescenceAddCoef&&(t.uniform1f(i.iridescenceAddCoef,this.iridescenceAddCoef),t.uniform1f(i.iridescenceMulCoef,this.iridescenceMulCoef)),i.iridescenceThickness&&t.uniform1f(i.iridescenceThickness,this.iridescenceThickness),i.iridescenceThicknessMap&&e.loadTexture(t,i.iridescenceThicknessMap,this.iridescenceThicknessMap),i.iridescenceThicknessAddCoef&&(t.uniform1f(i.iridescenceThicknessAddCoef,this.iridescenceThicknessAddCoef),t.uniform1f(i.iridescenceThicknessMulCoef,this.iridescenceThicknessMulCoef)))},I.prototype.isEnabled=function(){return this.iridescence>0||this._isTextureAvailable("iridescenceMap")},I.prototype.setMaterialShaderOptions=function(e){var t=this.isEnabled();Object.assign(e,{iridescence:t,iridescenceMap:t&&this._isTextureAvailable("iridescenceMap"),iridescenceAddCoef:t&&null!==this.iridescenceAddCoef,iridescenceMulCoef:t&&null!==this.iridescenceAddCoef,iridescenceThicknessMap:t&&this._isTextureAvailable("iridescenceThicknessMap"),iridescenceThicknessAddCoef:t&&null!==this.iridescenceThicknessAddCoef,iridescenceThicknessMulCoef:t&&null!==this.iridescenceThicknessMulCoef})},I.prototype.getTextures=function(){return[this.iridescenceMap,this.iridescenceThicknessMap]},I.prototype.setParameters=function(e){P.prototype.setParameters.call(this,e),this.iridescenceThicknessUvTransform=x(this.iridescenceThicknessUvTransform),this.iridescenceUvTransform=x(this.iridescenceUvTransform)},I.prototype.clone=function(e){return new I(this,e)};var R=function(t,i){S(this,"sheen",0),S(this,"sheenRoughness",0),S(this,"sheenColor",new e.Color(0)),this.sheenMode=u._NO_SHEEN,P.call(this,t,i)};(R.prototype=Object.create(P.prototype)).loadUniforms=function(e,t,i,r){if(this.isEnabled()){var n;i.sheen&&t.uniform1f(i.sheen,this.sheen),i.sheenMap&&e.loadTexture(t,i.sheenMap,this.sheenMap),i.sheenMulCoef&&(t.uniform1f(i.sheenMulCoef,this.sheenMulCoef),t.uniform1f(i.sheenAddCoef,this.sheenAddCoef)),i.sheenRoughness&&t.uniform1f(i.sheenRoughness,this.sheenRoughness),i.sheenRoughnessMap&&e.loadTexture(t,i.sheenRoughnessMap,this.sheenRoughnessMap),i.sheenRoughnessMulCoef&&(t.uniform1f(i.sheenRoughnessMulCoef,this.sheenRoughnessMulCoef),t.uniform1f(i.sheenRoughnessAddCoef,this.sheenRoughnessAddCoef)),i.sheenColor&&(n=e.gammaInput?g.copyToLinear(this.sheenColor,e.simpleGamma):this.sheenColor,t.uniform3f(i.sheenColor,n.r,n.g,n.b)),i.sheenColorMap&&e.loadTexture(t,i.sheenColorMap,this.sheenColorMap),i.sheenColorMulCoef&&(t.uniform3f(i.sheenColorMulCoef,this.sheenColorMulCoef.x,this.sheenColorMulCoef.y,this.sheenColorMulCoef.z),t.uniform3f(i.sheenColorAddCoef,this.sheenColorAddCoef.x,this.sheenColorAddCoef.y,this.sheenColorAddCoef.z));var a=this.__parent__;i.envMapSheen&&null!==a._sheenData&&e.loadTexture(t,i.envMapSheen,a._sheenData.envMipMap)}},R.prototype.isEnabled=function(){return this.sheen>0||!!this._isTextureAvailable("sheenMap")},R.prototype.setMaterialShaderOptions=function(e){var t=this.isEnabled();Object.assign(e,{sheen:t,sheenMap:t&&this._isTextureAvailable("sheenMap"),sheenMulCoef:t&&null!==this.sheenMulCoef,sheenAddCoef:t&&null!==this.sheenAddCoef,sheenColorMap:t&&this._isTextureAvailable("sheenColorMap"),sheenColorMapLinear:t&&!!this.sheenColorMap&&this.sheenColorMap.hdr,sheenColorMulCoef:t&&null!==this.sheenColorMulCoef,sheenColorAddCoef:t&&null!==this.sheenColorAddCoef,sheenRoughnessMap:t&&this._isTextureAvailable("sheenRoughnessMap"),sheenRoughnessMulCoef:t&&null!==this.sheenRoughnessMulCoef,sheenRoughnessAddCoef:t&&null!==this.sheenRoughnessAddCoef,sheenMode:t&&this.sheenMode})},R.prototype.getTextures=function(){return[this.sheenMap,this.sheenColorMap,this.sheenRoughnessMap]},R.prototype.setParameters=function(e){P.prototype.setParameters.call(this,e),this.sheenUvTransform=x(this.sheenUvTransform),this.sheenRoughnessUvTransform=x(this.sheenRoughnessUvTransform),this.sheenColorUvTransform=x(this.sheenColorUvTransform)},R.prototype.clone=function(e){return new R(this,e)};var L=function(i){t.call(this),i=i||{},this.__physicalMode=o,i&&i.dspbr21x&&(this.__physicalMode=l),i&&i.dspbr22x&&(this.__physicalMode=c),i&&i.dspbr23x&&(this.__physicalMode=h),this._phongFallbackMaterial=null,this.lights=!0,this.thinWalled=!0,this.color=new e.Color(16777215),this.map=null,this.diffuseUvSlot=1,this.diffuseUvTransform=m,this.diffuseMulCoef=null,this.diffuseAddCoef=null,S(this,"specular",new e.Color(16777215)),S(this,"metalness",0),S(this,"specularContrib",1),S(this,"emissionColor",new e.Color(16777215)),this.emissionValue=0,this.emissionNormalized=!1,S(this,"transparency",0),S(this,"opacity",1),this.useAlphaFromDiffuseMap=!0,this.ior=1.4,S(this,"roughness",0),this.glossinessMap=null,this.glossinessMulCoef=null,this.glossinessAddCoef=null,this.reflectionProbes=null,this.envMipMap=null,this.envMap=null,this.overrideIBL=null,S(this,"translucency",0),S(this,"translucencyColor",new e.Color(0)),this.bumpMap=null,this.bumpUvSlot=1,this.bumpUvTransform=m,S(this,"bumpScale",1),v(this,"normal"),this.normalMapFlipY=!1,S(this,"normalScale",new e.Vector2(1,1)),this.useLighting=!0,this.perPixel=!0,this.needTangent=!1,this.needTangentBinormal=!1,this.NRECompatibility=!0,this.setValues(i),this.normalUvTransform=x(this.normalUvTransform),this.bumpUvTransform=x(this.bumpUvTransform),this.bumpScaleUvTransform=x(this.bumpScaleUvTransform),this.normalScaleUvTransform=x(this.normalScaleUvTransform),this.diffuseUvTransform=x(this.diffuseUvTransform),this.specularUvTransform=x(this.specularUvTransform),this.metalnessUvTransform=x(this.metalnessUvTransform),this.emissionColorUvTransform=x(this.emissionColorUvTransform),this.specularContribUvTransform=x(this.specularContribUvTransform),this.transparencyUvTransform=x(this.transparencyUvTransform),this.opacityUvTransform=x(this.opacityUvTransform),this.translucencyUvTransform=x(this.translucencyUvTransform),this.translucencyColorUvTransform=x(this.translucencyColorUvTransform),this.roughnessUvTransform=x(this.roughnessUvTransform),this._dspbrFlakes=null,this.setDSPBRFlakes(i),this._specGlossFlakes=null,this._dspbrFlakes||this.setSpecGlossFlakes(i),this._clearCoat=null,this.setClearCoat(i),this._volume=null,this.setVolume(i),this._mapFromOldParameters(i),this._sheenData=null,this._sheen=null,this.setSheen(i),this._anisotropy=null,this.setAnisotropy(i),this._displacement=null,this.setDisplacement(i),this._iridescence=null,this.setIridescence(i),this._thickness=null,this.setThickness(i),this.ambienceMatrix=new e.Matrix4,this.useFiniteEnvMap=!1,this.parallaxCorrectionParameters=null,this._fromGLTF=i&&i._fromGLTF?1:0,this._fromGLTF=i&&i._fromGLTF_SpecGloss?2:this._fromGLTF};return(L.prototype=Object.create(t.prototype)).isPhysicalMaterial=!0,L.prototype._setTypeParams=function(e){e.specGloss=!1,e.specGlossNRE=!1,e.dspbr19x=!1,e.dspbr21x=!1,e.dspbr22x=!1,e.dspbr23x=!1},L.prototype._shaderID="physicalDS",L.prototype.requireVertexTangentBinormal=function(){return this._displacement&&this._displacement.isEnabled()},L.prototype._dump=function(){var e=t.prototype._dump.call(this);e.subType=this.getSubType(),e.color=this.color.toArray(),e.specular=this.specular.toArray(),this.specularMap&&(e.specularMap="textured"),e.roughness=this.roughness,this.roughnessMap&&(e.roughness="textured");var i=this.getType();return i.includes("DSPBR")?(this.map&&(e.color="textured"),e.transparency=this.transparency,this.transparencyMap&&(e.transparency="textured"),e.emissionColor=this.emissionColor.toArray(),this.emissionColorMap&&(e.emissionColor="textured"),e.emissionValue=this.emissionValue,e.metalness=this.metalness,this.metalnessMap&&(e.metalness="textured"),e.specularContribution=this.specularContrib,this.specularContribMap&&(e.specularContribution="textured"),e.ior=this.ior):i.includes("SpecGloss")?(this.map&&(e.color="textured"),e.transparency=this.transparency,this.transparencyMap&&(e.transparency="textured"),e.emissionColor=this.emissionColor.toArray(),this.emissionColorMap&&(e.emissionColor="textured")):"CATGraphicalMaterial"===i&&this.map&&(e.texture=!0),e},L.prototype.requireTangentBinormal=function(){return this.needTangentBinormal||this._anisotropy&&this._anisotropy.isEnabled()||!!this.normalMap||!(!this._clearCoat||!this._clearCoat.clearCoatNormalMap)||this.requireVertexTangentBinormal()},L.prototype.getSubType=function(){return"Generic"},L.prototype.getType=function(){switch(this.__physicalMode){case a:case s:return"SpecGloss";case o:return"DSPBR19x";case l:return"DSPBR21x";case c:return"DSPBR22x";case h:return"DSPBR23x"}return"DSPBR19x"},L.prototype._deallocate=function(e){t.prototype._deallocate.call(this,e),e&&(e.ambianceGenerators&&(e.ambianceGenerators.decreaseUseCount("m"+this.id),e.ambianceGenerators.decreaseUseCount("ms"+this.id)),e.sssGenerator&&this._volume&&this._volume._sssLUT&&e.sssGenerator.decreaseUseCount(this._volume._sssLUT.id)),this._phongFallbackMaterial&&this._phongFallbackMaterial.dispose()},L.prototype._autoForceSide=!0,L.prototype._transparencyOnGPU=function(e){return t.prototype._transparencyOnGPU.call(this,e)||this.opacityMap||this.transparencyMap||this.opacityAddCoef>0||this.transparencyAddCoef>0||this.map&&(this.useAlphaFromDiffuseMap||this.transparency>0)},L.prototype._isTransparent=function(e){return t.prototype._isTransparent.call(this,e)||this.transparency>0},L.prototype._mapFromOldParameters=function(e){this.__physicalMode>=l||(e.hasOwnProperty("emissive")&&(this.emissionColor.copy(e.emissive),this.emissionColorMap=e.hasOwnProperty("emissiveMap")?e.emissiveMap:this.emissionColorMap,this.emissionColorAddCoef=e.hasOwnProperty("emissiveAddCoef")?e.emissiveAddCoef:this.emissionColorAddCoef,this.emissionColorMulCoef=e.hasOwnProperty("emissiveMulCoef")?e.emissiveMulCoef:this.emissionColorMulCoef,this.emissionColorUvSlot=e.hasOwnProperty("emissiveUvSlot")?e.emissiveUvSlot:this.emissionColorUvSlot,this.emissionColorUvTransform=e.hasOwnProperty("emissiveUvTransform")?e.emissiveUvTransform:this.emissionColorUvTransform,this.emissionValue=1,this.emissionNormalized=!1),e.hasOwnProperty("coating")&&(this._clearCoat||(this._clearCoat=new D(e)),this._clearCoat.clearCoat=e.coating),e.hasOwnProperty("glossiness")&&(this.metalness<1e-6&&null===this.metalnessMap&&(this.__physicalMode=a,this.metalness=0,this.metalnessMap=null),this.roughness=1-e.glossiness,this.roughnessMap=null,this.thinWalled=!0),e.hasOwnProperty("glossinessMap")&&(this.metalness<1e-6&&null===this.metalnessMap&&(this.__physicalMode=a,this.metalness=0,this.metalnessMap=null),this.roughnessMap=null,this.thinWalled=!0,this.roughnessUvSlot=e.hasOwnProperty("glossinessUvSlot")?e.glossinessUvSlot:this.roughnessUvSlot,this.roughnessUvTransform=e.hasOwnProperty("glossinessUvTransform")?e.glossinessUvTransform:this.roughnessUvTransform),this._clearCoat&&(e.hasOwnProperty("coatingGlossiness")&&(this.metalness<1e-6&&null===this.metalnessMap&&(this.__physicalMode=a,this.metalness=0,this.metalnessMap=null),this._clearCoat.clearCoatRoughness=1-e.coatingGlossiness),e.hasOwnProperty("coatingGlossinessMap")&&(this.metalness<1e-6&&null===this.metalnessMap&&(this.__physicalMode=a,this.metalness=0,this.metalnessMap=null),this._clearCoat.clearCoatRoughnessMap=null,this.thinWalled=!0,this._clearCoat.clearCoatRoughnessUvSlot=e.hasOwnProperty("coatingGlossinessUvSlot")?e.coatingGlossinessUvSlot:this._clearCoat.clearCoatRoughnessUvSlot,this._clearCoat.clearCoatRoughnessUvTransform=e.hasOwnProperty("coatingGlossinessUvTransform")?e.coatingGlossinessUvTransform:this._clearCoat.clearCoatRoughnessUvTransform)),e.specGloss&&(this.__physicalMode=a,this.metalness=0,this.metalnessMap=null),e.specGlossNRE&&(this.__physicalMode=s,this.metalness=0,this.metalnessMap=null))},L.prototype._canUseLights=function(){return this.useLighting},L.prototype._setMaterialShaderOptions=function(e,i,r,n,u,d){t.prototype._setMaterialShaderOptions.call(this,e,i,r,n,u,d);var p={specgloss:this.__physicalMode===a||this.__physicalMode===s,specglossNRE:this.__physicalMode===s,dspbr:this.__physicalMode>=o,dspbr19x:this.__physicalMode===o,dspbr21x:this.__physicalMode===l,dspbr22x:this.__physicalMode===c,dspbr23x:this.__physicalMode===h,NRECompatibility:!!this.NRECompatibility,thinWalled:this.thinWalled,useAlphaFromDiffuseMap:this.useAlphaFromDiffuseMap,fromGLTF:this._fromGLTF};Object.assign(p,{diffuseMulCoef:null!==this.diffuseMulCoef,diffuseAddCoef:null!==this.diffuseAddCoef,diffuseBorderColorU:!!this.map&&this.map._useBorderColor().u,diffuseBorderColorV:!!this.map&&this.map._useBorderColor().v,specularContribMap:this._isTextureAvailable("specularContribMap"),specularContribMulCoef:null!==this.specularContribMulCoef,specularContribAddCoef:null!==this.specularContribAddCoef,specularMap:this._isTextureAvailable("specularMap"),specularMapLinear:!!this.specularMap&&this.specularMap.hdr,specularMulCoef:null!==this.specularMulCoef,specularAddCoef:null!==this.specularAddCoef,transparencyMap:this._isTextureAvailable("transparencyMap"),transparencyMulCoef:null!==this.transparencyMulCoef,transparencyAddCoef:null!==this.transparencyAddCoef,metalnessMap:this._isTextureAvailable("metalnessMap"),metalnessMulCoef:null!==this.metalnessMulCoef,metalnessAddCoef:null!==this.metalnessAddCoef,opacityMap:this._isTextureAvailable("opacityMap"),opacityBorderColorU:!!this.opacityMap&&this.opacityMap._useBorderColor().u,opacityBorderColorV:!!this.opacityMap&&this.opacityMap._useBorderColor().v,opacityMulCoef:null!==this.opacityMulCoef,opacityAddCoef:null!==this.opacityAddCoef}),this._thickness&&this._thickness.setMaterialShaderOptions(p),this._volume&&this._volume.setMaterialShaderOptions(p),this._displacement&&(p._isDecal=e._isDecal,this._displacement.setMaterialShaderOptions(p)),i&&(Object.assign(p,{emissionColorMap:this._isTextureAvailable("emissionColorMap"),emissionNormalized:this.emissionNormalized,emissionColorMapLinear:/*!!material.emissionColorMapLinear || */!!this.emissionColorMap&&this.emissionColorMap.hdr,emissionColorMulCoef:null!==this.emissionColorMulCoef,emissionColorAddCoef:null!==this.emissionColorAddCoef,translucencyMap:this._isTextureAvailable("translucencyMap"),translucencyMulCoef:null!==this.translucencyMulCoef,translucencyAddCoef:null!==this.translucencyAddCoef,translucencyColorMap:this._isTextureAvailable("translucencyColorMap"),translucencyColorMapLinear:!!this.translucencyColorMap&&this.translucencyColorMap.hdr,translucencyColorMulCoef:null!==this.translucencyColorMulCoef,translucencyColorAddCoef:null!==this.translucencyColorAddCoef}),this._dspbrFlakes?this._dspbrFlakes.setMaterialShaderOptions(p):this._specGlossFlakes&&this._specGlossFlakes.setMaterialShaderOptions(p),this._clearCoat&&this._clearCoat.setMaterialShaderOptions(p),this._sheen&&this._sheen.setMaterialShaderOptions(p),this._anisotropy&&this._anisotropy.setMaterialShaderOptions(p),this._iridescence&&this._iridescence.setMaterialShaderOptions(p),p.useFlakes=p.dspbrFlakes||p.specGlossFlakes),(i||r||n)&&Object.assign(p,{normalScaleMap:this._isTextureAvailable("normalScaleMap"),normalMulCoef:null!==this.normalMulCoef,normalAddCoef:null!==this.normalAddCoef,normalScaleMulCoef:null!==this.normalScaleMulCoef,normalScaleAddCoef:null!==this.normalScaleAddCoef,bumpScaleMap:this._isTextureAvailable("bumpScaleMap"),bumpScaleMulCoef:null!==this.bumpScaleMulCoef,bumpScaleAddCoef:null!==this.bumpScaleAddCoef}),(i||u||n)&&Object.assign(p,{roughnessMap:this._isTextureAvailable("roughnessMap"),glossinessMap:!p.dspbr&&this._isTextureAvailable("glossinessMap"),glossinessMulCoef:!p.dspbr&&null!==this.glossinessMulCoef,glossinessAddCoef:!p.dspbr&&null!==this.glossinessAddCoef,roughnessMulCoef:null!==this.roughnessMulCoef,roughnessAddCoef:null!==this.roughnessAddCoef}),Object.assign(e,p),e.subsurface&&!e.thickness&&(e.maxDirIBLShadows=e._maxDirIBLShadows,e.maxShadows+=e._maxDirIBLShadows,e.shadowMapEnabled=e._shadowMapEnabled&&e.maxShadows>0)},L.prototype.getOpacity=function(){return 1-Math.max(1-this.opacity,Math.min(this.transparency,.99))},L.prototype._getTextures=function(e){var i=t.prototype._getTextures.call(this,e);return i=i.concat([this.map,this.specularMap,this.metalnessMap,this.specularContribMap,this.emissionColorMap,this.transparencyMap,this.opacityMap,this.translucencyMap,this.translucencyColorMap,this.normalScaleMap,this.bumpScaleMap,this.roughnessMap,this.glossinessMap,this.bumpMap,this.normalMap]),this._dspbrFlakes?i=i.concat(this._dspbrFlakes.getTextures()):this._specGlossFlakes&&(i=i.concat(this._specGlossFlakes.getTextures())),this._clearCoat&&(i=i.concat(this._clearCoat.getTextures())),this._volume&&!e&&(i=i.concat(this._volume.getTextures())),this._thickness&&(i=i.concat(this._thickness.getTextures())),this._sheen&&(i=i.concat(this._sheen.getTextures())),this._anisotropy&&(i=i.concat(this._anisotropy.getTextures())),this._displacement&&(i=i.concat(this._displacement.getTextures())),this._iridescence&&(i=i.concat(this._iridescence.getTextures())),i},L.prototype.clone=function(e){return e||(e=new L),e.__physicalMode=this.__physicalMode,t.prototype.clone.call(this,e),e.useLighting=this.useLighting,e.perPixel=this.perPixel,e.thinWalled=this.thinWalled,e.color.copy(this.color),e.map=this.map,e.diffuseUvSlot=this.diffuseUvSlot,e.diffuseUvTransform=this.diffuseUvTransform,e.diffuseMulCoef=this.diffuseMulCoef,e.diffuseAddCoef=this.diffuseAddCoef,y(this,e,"specular",!0),y(this,e,"metalness",!1),y(this,e,"specularContrib",!1),y(this,e,"emissionColor",!0),e.emissionValue=this.emissionValue,e.emissionNormalized=this.emissionNormalized,y(this,e,"transparency",!1),y(this,e,"opacity",!1),e.useAlphaFromDiffuseMap=this.useAlphaFromDiffuseMap,e.ior=this.ior,y(this,e,"roughness",!1),e.glossinessMap=this.glossinessMap,e.glossinessMulCoef=this.glossinessMulCoef,e.glossinessAddCoef=this.glossinessAddCoef,e.reflectionProbes=this.reflectionProbes,e.envMipMap=this.envMipMap,e.envMap=this.envMap,e.overrideIBL=null!==this.overrideIBL?this.overrideIBL.clone():null,y(this,e,"translucency",!1),y(this,e,"translucencyColor",!0),e.bumpMap=this.bumpMap,e.bumpUvSlot=this.bumpUvSlot,e.bumpUvTransform=this.bumpUvTransform,y(this,e,"bumpScale",!1),_(this,e,"normal"),e.normalMapFlipY=this.normalMapFlipY,y(this,e,"normalScale",!0),this._dspbrFlakes?e._dspbrFlakes=this._dspbrFlakes.clone(e):this._specGlossFlakes&&(e._specGlossFlakes=this._specGlossFlakes.clone(e)),this._clearCoat&&(e._clearCoat=this._clearCoat.clone(e)),this._volume&&(e._volume=this._volume.clone(e)),e._sheenData=null!==this._sheenData?this._sheenData.clone():null,this._sheen&&(e._sheen=this._sheen.clone(e)),this._anisotropy&&(e.anisotropy=this._anisotropy.clone(e)),this._displacement&&(e._displacement=this._displacement.clone(e)),this._iridescence&&(e._iridescence=this._iridescence.clone(e)),this._thickness&&(e._thickness=this._thickness.clone(e)),e.needTangent=this.needTangent,e.needTangentBinormal=this.needTangentBinormal,e.NRECompatibility=this.NRECompatibility,e.ambienceMatrix=this.ambienceMatrix,e.parallaxCorrectionParameters=this.parallaxCorrectionParameters,e.useFiniteEnvMap=this.useFiniteEnvMap,e._fromGLTF=this._fromGLTF,e},L.prototype.setOverrideIBL=function(e){this.overrideIBL=new n(e),null!==this._sheenData&&(this._sheenData.overrideIBL.hdr=this.overrideIBL.hdr),this.needsUpdate=!0},L.prototype._needsIBLLightExtraction=function(){var e=this._volume&&this._volume.isEnabled(),t=this._thickness&&(this._thickness.thickness>0||!!this._thickness.thicknessMap);return e&&!t},L.prototype._forceOpaqueShadowMapPass=function(){var e=this._volume&&this._volume.isEnabled(),t=this._thickness&&(this._thickness.thickness>0||!!this._thickness.thicknessMap);return e&&!t},L.prototype.setAnisotropy=function(e){e&&(this._anisotropy?this._anisotropy.setParameters(e):(e.anisotropyMap||e.anisotropy>0)&&(this._anisotropy=new T(e,this),this.needsUpdate=!0))},L.prototype.setDisplacement=function(e){e&&(this._displacement?this._displacement.setParameters(e):e.displacementMap&&(this._displacement=new A(e,this),this.needsUpdate=!0))},L.prototype.setIridescence=function(e){e&&(this._iridescence?this._iridescence.setParameters(e):(e.iridescence>0||e.iridescenceMap)&&(this._iridescence=new I(e,this),this.needsUpdate=!0))},L.prototype.setThickness=function(e){e&&(!this._thickness&&(e.thicknessMap||e.thickness>0)?(this._thickness=new E(e,this),this.needsUpdate=!0):this._thickness&&this._thickness.setParameters(e))},L.prototype.setVolume=function(e){if(e){var t=this.thinWalled;this.thinWalled=void 0!==e.thinWalled?!!e.thinWalled:this.thinWalled,this.ior=e.ior?e.ior:this.ior,!this._volume&&(e.subsurfacePreset||e.subsurfaceColor&&e.subsurfaceColor.getHex()>0||e.attenuationColor&&e.attenuationColor.getHex()<16711422)?(this._volume=new w(e,this),this.needsUpdate=!0):this._volume&&this._volume.setParameters(e),t!==this.thinWalled&&(this.needsUpdate=!0),this.needsUpdate&&this._volume&&(this._sendEvent("requestShadowMapUpdate"),this._invalidateDisplayRangeLists())}},L.prototype._updateSubsurfaceScattering=function(e){var t=this._volume;if(e.manager){this.needsUpdate=this.needsUpdate||null===t._sssLUT;var i=t._sssLUT;if(1===t._updateSSS)i&&e.decreaseUseCount(i.id),t._sssLUT=null,t._translucencyDepth=null,i&&(this.needsUpdate=!0);else{var r={absorptionCoeffs:t._absorptionCoeffs,scatteringCoeffs:t._scatteringCoeffs,eta:this.ior,subsurfaceAnisotropy:t.subsurfaceAnisotropy,color:t.subsurfaceColor.toArray()},n=e.getTextures(r);t._sssLUT=n.sssLUT,t._translucencyDepth=n.translucencyDepth,null!==i&&i.id!==t._sssLUT.id&&e.decreaseUseCount(i.id)}t._updateSSS=0}else e.init()},L.prototype.activatePDSFX=function(e){e=e||{},this._PDSFXData=new i,this._PDSFXData.PDSFX=!0,this._setDefaultPDSFXOverridableFunctions()},L.prototype.setDSPBRFlakes=function(e){e&&(null===this._dspbrFlakes&&(e.flakesCoverageMap||e.flakesCoverage>0)?(this._dspbrFlakes=new C(e,this),this._specGlossFlakes&&(this._specGlossFlakes=null),this.needsUpdate=!0):this._dspbrFlakes&&this._dspbrFlakes.setParameters(e))},L.prototype.setSpecGlossFlakes=function(e){e&&(null===this._specGlossFlakes&&e.flakes?(this._specGlossFlakes=new b(e,this),this._dspbrFlakes&&(this._dspbrFlakes=null),this.needsUpdate=!0):this._specGlossFlakes&&this._specGlossFlakes.setParameters(e))},L.prototype.setClearCoat=function(e){e&&(null===this._clearCoat&&(e.clearCoat>0||e.clearCoatMap)?(this._clearCoat=new D(e,this),this.needsUpdate=!0):this._clearCoat&&this._clearCoat.setParameters(e))},L.prototype.setSheen=function(t){var i={};Object.assign(i,t);var a=!1;if(this.__physicalMode>=c?(i.sheen=void 0,i.sheenMap=void 0,i.sheenMulCoef=void 0,i.sheenAddCoef=void 0,i.sheenUvSlot=void 0,i.sheenUvTransform=void 0,!i.sheenColor||i.sheenColor instanceof e.Color||(i.sheenColor=new e.Color(i.sheenColor)),i.sheenColor&&i.sheenColor.getHex()>0||i.sheenColorMap?(i.sheen=1,a=!0):i.sheenColor&&0===i.sheenColor.getHex()&&(i.sheen=0)):(i.sheen>0||i.sheenMap)&&(a=!0),this._sheen?this._sheen.setParameters(i):a&&(i.sheenMode||(i.sheenMode=this.__physicalMode>=l?u.VELVET_SOFT:u.VELVET),this._sheen=new R(i,this),this.needsUpdate=!0),this._sheen){var s=this._sheen;if(s.sheenMode!==u._NO_SHEEN){var o=null;switch(null===this._sheenData?(null!==this.overrideIBL?(o=this.overrideIBL.clone()).mips=null:o=new n({}),this._sheenData=new f({overrideIBL:o})):(o=this._sheenData.overrideIBL,null!==this.overrideIBL&&(o.hdr=this.overrideIBL.hdr)),s.sheenMode){case u.VELVET:o.brdf=r.ASHIKMIN;break;case u.SATIN:o.brdf=r.BECKMANN;break;case u.VELVET_SOFT:o.brdf=r.ESTEVEZKULLA}}}},L.prototype.loadUniforms=function(e,t,i,r,n,a){if(e.loadUniformsCommon(t,this,i,r,n,a),e.loadUniformsNormalMap(t,this,i),i.reflectionColorTexture&&(t.uniform2f(i.invScreenSize,1/e.domElement.width,1/e.domElement.height),e.loadTexture(t,i.reflectionColorTexture,e._getReflectionColorBufferResult())),i.refractionColorTexture&&(t.uniform2f(i.invScreenSize,1/e.domElement.width,1/e.domElement.height),e.loadTexture(t,i.refractionColorTexture,e._getRefractionColorBufferResult())),i.normalMap&&(i.normalScale&&t.uniform2f(i.normalScale,this.normalScale.x,this.normalScale.y),i.normalScaleMap&&e.loadTexture(t,i.normalScaleMap,this.normalScaleMap),i.normalScaleAddCoef&&(t.uniform1f(i.normalScaleAddCoef,this.normalScaleAddCoef),t.uniform1f(i.normalScaleMulCoef,this.normalScaleMulCoef)),i.normalAddCoef&&(t.uniform3f(i.normalAddCoef,this.normalAddCoef.x,this.normalAddCoef.y,this.normalAddCoef.z),t.uniform3f(i.normalMulCoef,this.normalMulCoef.x,this.normalMulCoef.y,this.normalMulCoef.z))),i.bumpMap&&(i.bumpScale&&t.uniform1f(i.bumpScale,this.bumpScale),i.bumpScaleAddCoef&&(t.uniform1f(i.bumpScaleAddCoef,this.bumpScaleAddCoef),t.uniform1f(i.bumpScaleMulCoef,this.bumpScaleMulCoef)),i.bumpMap&&e.loadTexture(t,i.bumpMap,this.bumpMap),i.bumpScaleMap&&e.loadTexture(t,i.bumpScaleMap,this.bumpScaleMap)),i.diffuseAddCoef&&(t.uniform3f(i.diffuseAddCoef,this.diffuseAddCoef.x,this.diffuseAddCoef.y,this.diffuseAddCoef.z),t.uniform3f(i.diffuseMulCoef,this.diffuseMulCoef.x,this.diffuseMulCoef.y,this.diffuseMulCoef.z)),i.diffuseBorderColor){var s={r:(l=this.map.borderColor).x,g:l.y,b:l.z};e.gammaInput&&(s=g.copyToLinear(s,e.simpleGamma)),t.uniform4f(i.diffuseBorderColor,s.r,s.g,s.b,l.w)}if(i.specular){var o=this.specular;s=e.gammaInput?g.copyToLinear(o,e.simpleGamma):o,t.uniform3f(i.specular,s.r,s.g,s.b)}if(i.specularAddCoef&&(t.uniform3f(i.specularAddCoef,this.specularAddCoef.x,this.specularAddCoef.y,this.specularAddCoef.z),t.uniform3f(i.specularMulCoef,this.specularMulCoef.x,this.specularMulCoef.y,this.specularMulCoef.z)),i.metalness&&t.uniform1f(i.metalness,this.metalness),i.metalnessMap&&e.loadTexture(t,i.metalnessMap,this.metalnessMap),i.metalnessMulCoef&&(t.uniform1f(i.metalnessMulCoef,this.metalnessMulCoef),t.uniform1f(i.metalnessAddCoef,this.metalnessAddCoef)),i.specularContrib&&t.uniform1f(i.specularContrib,this.specularContrib),i.specularContribMap&&e.loadTexture(t,i.specularContribMap,this.specularContribMap),i.specularContribMulCoef&&(t.uniform1f(i.specularContribMulCoef,this.specularContribMulCoef),t.uniform1f(i.specularContribAddCoef,this.specularContribAddCoef)),i.emissionColor){s=this.emissionColor;e.gammaInput&&(s=g.copyToLinear(this.emissionColor,e.simpleGamma)),t.uniform3f(i.emissionColor,s.r,s.g,s.b)}if(i.emissionColorMap&&e.loadTexture(t,i.emissionColorMap,this.emissionColorMap),i.emissionColorAddCoef&&(t.uniform3f(i.emissionColorAddCoef,this.emissionColorAddCoef.x,this.emissionColorAddCoef.y,this.emissionColorAddCoef.z),t.uniform3f(i.emissionColorMulCoef,this.emissionColorMulCoef.x,this.emissionColorMulCoef.y,this.emissionColorMulCoef.z)),i.emissionValue&&t.uniform1f(i.emissionValue,this.emissionValue),i.transparency&&t.uniform1f(i.transparency,this.transparency),i.transparencyMap&&e.loadTexture(t,i.transparencyMap,this.transparencyMap),i.transparencyMulCoef&&(t.uniform1f(i.transparencyMulCoef,this.transparencyMulCoef),t.uniform1f(i.transparencyAddCoef,this.transparencyAddCoef)),i.opacityMap&&(e.loadTexture(t,i.opacityMap,this.opacityMap),i.opacityBorderValue)){var l=this.opacityMap.borderColor;t.uniform1f(i.opacityBorderValue,l.x)}if(i.opacityMulCoef&&(t.uniform1f(i.opacityMulCoef,this.opacityMulCoef),t.uniform1f(i.opacityAddCoef,this.opacityAddCoef)),i.ior&&t.uniform1f(i.ior,this.ior),i.translucency&&t.uniform1f(i.translucency,this.translucency),i.translucencyMap&&e.loadTexture(t,i.translucencyMap,this.translucencyMap),i.translucencyMulCoef&&(t.uniform1f(i.translucencyMulCoef,this.translucencyMulCoef),t.uniform1f(i.translucencyAddCoef,this.translucencyAddCoef)),i.translucencyColor){s=this.translucencyColor;e.gammaInput&&(s=g.copyToLinear(this.emissionColor,e.simpleGamma)),t.uniform3f(i.translucencyColor,s.r,s.g,s.b)}if(i.translucencyColorMap&&e.loadTexture(t,i.translucencyMap,this.translucencyMap),i.translucencyColorMulCoef&&(t.uniform3f(i.translucencyColorMulCoef,this.translucencyColorMulCoef.x,this.translucencyColorMulCoef.y,this.translucencyColorMulCoef.z),t.uniform3f(i.translucencyColorAddCoef,this.translucencyColorAddCoef.x,this.translucencyColorAddCoef.y,this.translucencyColorAddCoef.z)),i.roughness&&t.uniform1f(i.roughness,this.roughness),i.roughnessMap&&e.loadTexture(t,i.roughnessMap,this.roughnessMap),i.roughnessMulCoef&&(t.uniform1f(i.roughnessMulCoef,this.roughnessMulCoef),t.uniform1f(i.roughnessAddCoef,this.roughnessAddCoef)),i.glossinessMap&&e.loadTexture(t,i.glossinessMap,this.glossinessMap),i.glossinessMulCoef&&(t.uniform1f(i.glossinessMulCoef,this.glossinessMulCoef),t.uniform1f(i.glossinessAddCoef,this.glossinessAddCoef)),this.useFiniteEnvMap&&(i.sphereCenter&&t.uniform3f(i.sphereCenter,this.parallaxCorrectionParameters.sphereCenter.x,this.parallaxCorrectionParameters.sphereCenter.y,this.parallaxCorrectionParameters.sphereCenter.z),i.projectionCenter&&t.uniform3f(i.projectionCenter,this.parallaxCorrectionParameters.projectionCenter.x,this.parallaxCorrectionParameters.projectionCenter.y,this.parallaxCorrectionParameters.projectionCenter.z),i.sphereRadius&&t.uniform1f(i.sphereRadius,this.parallaxCorrectionParameters.sphereRadius)),this._dspbrFlakes?this._dspbrFlakes.loadUniforms(e,t,i,r):this._specGlossFlakes&&this._specGlossFlakes.loadUniforms(e,t,i,r),this._clearCoat&&this._clearCoat.loadUniforms(e,t,i,r),this._sheen&&this._sheen.loadUniforms(e,t,i,r,this),this._volume&&this._volume.loadUniforms(e,t,i,r),this._thickness&&this._thickness.loadUniforms(e,t,i,r),this._anisotropy&&this._anisotropy.loadUniforms(e,t,i,r),this._displacement&&this._displacement.loadUniforms(e,t,i,r,this),this._iridescence&&this._iridescence.loadUniforms(e,t,i,r),i.precomputedTexture){var c=e.precomputedTexture;e.loadTexture(t,i.precomputedTexture,c)}if(i.envMap&&this.envMipMap&&this.envMipMap[0]){var h=1,u=1;if(i.envMap&&e.loadTexture(t,i.envMap,this.envMipMap[0]),i.envMap2&&e.loadTexture(t,i.envMap2,this.envMipMap[1]),this.envMipMap[0].hdr&&i.envMapHDRSize&&(this.envMipMap[0].image?(h=parseInt(this.envMipMap[0].image.width),u=parseInt(this.envMipMap[0].image.height)):(h=parseInt(this.envMipMap[0].width),u=parseInt(this.envMipMap[0].height)),t.uniform2f(i.envMapHDRSize,h,u)),this.envMipMap[1]&&i.envMapHDRToMipsRatio){var d=1;d=this.envMipMap[1].image?parseInt(this.envMipMap[1].image.width)/h:parseInt(this.envMipMap[1].width)/h,t.uniform1f(i.envMapHDRToMipsRatio,d)}var p=this.envMipMap[0].envMapExposureSpecular,f=this.envMipMap[0].envMapExposureDiffuse;i.envMapExposureSpecular&&t.uniform1f(i.envMapExposureSpecular,p||0===p?p:1),i.envMapExposureDiffuse&&t.uniform1f(i.envMapExposureDiffuse,f||0===f?f:1),i.ambienceMatrix&&t.uniformMatrix4fv(i.ambienceMatrix,!1,e.float32Matrix4x4Temp.setDoubles(this.ambienceMatrix.elements))}i.reflectionProbe&&this.reflectionProbes&&this.reflectionProbes.length&&(i.reflectionProbe&&e.loadTexture(t,i.reflectionProbe,this.reflectionProbes[0].map0),i.reflectionProbeMips&&e.loadTexture(t,i.reflectionProbeMips,this.reflectionProbes[0].map1),i.reflectionProbePos&&t.uniform3f(i.reflectionProbePos,this.reflectionProbes[0].position.x,this.reflectionProbes[0].position.y,this.reflectionProbes[0].position.z),i.reflectionProbeProxyMin&&t.uniform3f(i.reflectionProbeProxyMin,this.reflectionProbes[0].geomProxy.min.x,this.reflectionProbes[0].geomProxy.min.y,this.reflectionProbes[0].geomProxy.min.z),i.reflectionProbeProxyMax&&t.uniform3f(i.reflectionProbeProxyMax,this.reflectionProbes[0].geomProxy.max.x,this.reflectionProbes[0].geomProxy.max.y,this.reflectionProbes[0].geomProxy.max.z),i.envMapHDRToMipsRatio&&t.uniform1f(i.envMapHDRToMipsRatio,1)),a&&a._mappingOperator||this._loadTextureInfo(this,this,e,t,i,!1)},L.prototype._loadTextureInfo=function(e,t,i,r,n,a){var s=e,o=t;n.normalUvTransform&&(r.uniform1i(n.normalUvSlot,o.normalUvSlot),r.uniformMatrix3fv(n.normalUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.normalUvTransform.elements))),n.bumpUvTransform&&(r.uniform1i(n.bumpUvSlot,o.bumpUvSlot),r.uniformMatrix3fv(n.bumpUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.bumpUvTransform.elements))),n.bumpScaleUvTransform&&(r.uniform1i(n.bumpScaleUvSlot,o.bumpScaleUvSlot),r.uniformMatrix3fv(n.bumpScaleUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.bumpScaleUvTransform.elements))),n.normalScaleUvTransform&&(r.uniform1i(n.normalScaleUvSlot,o.normalScaleUvSlot),r.uniformMatrix3fv(n.normalScaleUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.normalScaleUvTransform.elements))),n.diffuseUvTransform&&(r.uniform1i(n.diffuseUvSlot,o.diffuseUvSlot),r.uniformMatrix3fv(n.diffuseUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.diffuseUvTransform.elements))),n.specularUvTransform&&(r.uniform1i(n.specularUvSlot,o.specularUvSlot),r.uniformMatrix3fv(n.specularUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.specularUvTransform.elements))),n.metalnessUvTransform&&(r.uniform1i(n.metalnessUvSlot,o.metalnessUvSlot),r.uniformMatrix3fv(n.metalnessUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.metalnessUvTransform.elements))),n.emissionColorUvTransform&&(r.uniform1i(n.emissionColorUvSlot,o.emissionColorUvSlot),r.uniformMatrix3fv(n.emissionColorUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.emissionColorUvTransform.elements))),n.specularContribUvTransform&&(r.uniform1i(n.specularContribUvSlot,o.specularContribUvSlot),r.uniformMatrix3fv(n.specularContribUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.specularContribUvTransform.elements))),n.transparencyUvTransform&&(r.uniform1i(n.transparencyUvSlot,o.transparencyUvSlot),r.uniformMatrix3fv(n.transparencyUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.transparencyUvTransform.elements))),n.opacityUvTransform&&(r.uniform1i(n.opacityUvSlot,o.opacityUvSlot),r.uniformMatrix3fv(n.opacityUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.opacityUvTransform.elements))),n.translucencyUvTransform&&(r.uniform1i(n.translucencyUvSlot,o.translucencyUvSlot),r.uniformMatrix3fv(n.translucencyUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.translucencyUvTransform.elements))),n.translucencyColorUvTransform&&(r.uniform1i(n.translucencyColorUvSlot,o.translucencyColorUvSlot),r.uniformMatrix3fv(n.translucencyColorUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.translucencyColorUvTransform.elements))),n.roughnessUvTransform&&(r.uniform1i(n.roughnessUvSlot,o.roughnessUvSlot),r.uniformMatrix3fv(n.roughnessUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.roughnessUvTransform.elements))),n.anisotropy&&(s=a?e:e._anisotropy,o=a?t:t._anisotropy,n.anisotropyUvTransform&&(r.uniform1i(n.anisotropyUvSlot,o.anisotropyUvSlot),r.uniformMatrix3fv(n.anisotropyUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.anisotropyUvTransform.elements))),n.anisotropyAngleUvTransform&&(r.uniform1i(n.anisotropyAngleUvSlot,o.anisotropyAngleUvSlot),r.uniformMatrix3fv(n.anisotropyAngleUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.anisotropyAngleUvTransform.elements)))),n.displacementUvTransform&&(s=a?e:e._displacement,o=a?t:t._displacement,r.uniform1i(n.displacementUvSlot,o.displacementUvSlot),r.uniformMatrix3fv(n.displacementUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.displacementUvTransform.elements))),n.iridescenceUvTransform&&(s=a?e:e._iridescence,o=a?t:t._iridescence,r.uniform1i(n.iridescenceUvSlot,o.iridescenceUvSlot),r.uniformMatrix3fv(n.iridescenceUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.iridescenceUvTransform.elements))),n.iridescenceThicknessUvTransform&&(s=a?e:e._iridescence,o=a?t:t._iridescence,r.uniform1i(n.iridescenceThicknessUvSlot,o.iridescenceThicknessUvSlot),r.uniformMatrix3fv(n.iridescenceThicknessUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.iridescenceThicknessUvTransform.elements))),(n.sheen||n.sheenMap||n.sheenColor||n.sheenColorMap)&&(s=a?e:e._sheen,o=a?t:t._sheen,n.sheenUvTransform&&(r.uniform1i(n.sheenUvSlot,o.sheenUvSlot),r.uniformMatrix3fv(n.sheenUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.sheenUvTransform.elements))),n.sheenRoughnessUvTransform&&(r.uniform1i(n.sheenRoughnessUvSlot,o.sheenRoughnessUvSlot),r.uniformMatrix3fv(n.sheenRoughnessUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.sheenRoughnessUvTransform.elements))),n.sheenColorUvTransform&&(r.uniform1i(n.sheenColorUvSlot,o.sheenColorUvSlot),r.uniformMatrix3fv(n.sheenColorUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.sheenColorUvTransform.elements)))),(n.clearCoat||n.clearCoatMap)&&(s=a?e:e._clearCoat,o=a?t:t._clearCoat,n.clearCoatRoughnessUvTransform&&(r.uniform1i(n.clearCoatRoughnessUvSlot,o.clearCoatRoughnessUvSlot),r.uniformMatrix3fv(n.clearCoatRoughnessUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.clearCoatRoughnessUvTransform.elements))),n.clearCoatUvTransform&&(r.uniform1i(n.clearCoatUvSlot,o.clearCoatUvSlot),r.uniformMatrix3fv(n.clearCoatUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.clearCoatUvTransform.elements))),n.clearCoatNormalUvTransform&&(r.uniform1i(n.clearCoatNormalUvSlot,o.clearCoatNormalUvSlot),r.uniformMatrix3fv(n.clearCoatNormalUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.clearCoatNormalUvTransform.elements))),n.clearCoatColorUvTransform&&(r.uniform1i(n.clearCoatColorUvSlot,o.clearCoatColorUvSlot),r.uniformMatrix3fv(n.clearCoatColorUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.clearCoatColorUvTransform.elements)))),n.thicknessUvTransform&&(s=a?e:e._thickness,o=a?t:t._thickness,r.uniform1i(n.thicknessUvSlot,o.thicknessUvSlot),r.uniformMatrix3fv(n.thicknessUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.thicknessUvTransform.elements))),(n.flakesCoverage||n.flakesCoverageMap)&&(s=a?e:e._dspbrFlakes,o=a?t:t._dspbrFlakes,n.flakesRoughnessUvTransform&&(r.uniform1i(n.flakesRoughnessUvSlot,o.flakesRoughnessUvSlot),r.uniformMatrix3fv(n.flakesRoughnessUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.flakesRoughnessUvTransform.elements))),n.flakesSizeUvTransform&&(r.uniform1i(n.flakesSizeUvSlot,o.flakesSizeUvSlot),r.uniformMatrix3fv(n.flakesSizeUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.flakesSizeUvTransform.elements))),n.flakesCoverageUvTransform&&(r.uniform1i(n.flakesCoverageUvSlot,o.flakesCoverageUvSlot),r.uniformMatrix3fv(n.flakesCoverageUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.flakesCoverageUvTransform.elements))),n.flakesColorUvTransform&&(r.uniform1i(n.flakesColorUvSlot,o.flakesColorUvSlot),r.uniformMatrix3fv(n.flakesColorUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.flakesColorUvTransform.elements))),n.flipFlopUvTransform&&(r.uniform1i(n.flipFlopUvSlot,o.flipFlopUvSlot),r.uniformMatrix3fv(n.flipFlopUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.flipFlopUvTransform.elements))),n.flipFlopColorUvTransform&&(r.uniform1i(n.flipFlopColorUvSlot,o.flipFlopColorUvSlot),r.uniformMatrix3fv(n.flipFlopColorUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(s.flipFlopColorUvTransform.elements))))},L.prototype.areTexturesLoaded=function(){return!!t.prototype.areTexturesLoaded.call(this)&&((!this.envMipMap||!this.envMipMap[0]||this.envMipMap[0].loadEndStatus!==e.AssetLoadingStatus.LOADING)&&(!this.envMipMap||!this.envMipMap[1]||this.envMipMap[1].loadEndStatus!==e.AssetLoadingStatus.LOADING))},L.prototype._computeAmbianceKeyAndProcessMaterial=function(e,t,i,n,a,s){if(this._needsUpdateIfTexturesAreReady(),this._volume&&this._volume._updateSSS>0&&this._updateSubsurfaceScattering(n),!e)return 0;if(t.envMipMap.length>0&&t.envMipMap[0].hdr&&(null===t.envMipMap[1]||t.envMipMapID)){var o=t.envMipMap[0],l=t.id+"s"+o.id,c=o.id;c+="-"+r.GGX,t.envMipMapID&&t.envMipMapID!==l&&i.decreaseUseCount(t.envMipMapID),t.envMipMapID=l,i.manager?t.envMipMap[1]=i.getAmbiance(c,!0,{hdr:o,brdf:r.GGX},l).ambiance:(i.init(0),t.envMipMap[1]=i._dummyRoughnessTexture)}var h=null!==this.overrideIBL&&this.overrideIBL._useCustom();if(t.envMipMap.length>0&&t.envMipMap[1]||h){if(h){l="m"+this.id,o=(g=this.overrideIBL).hdr,c=g.name;c+="-"+o.id,c+="-"+g.brdf,this.overrideIBL.curID&&this.overrideIBL.curID!==o.id&&i.decreaseUseCount(l),this.overrideIBL.curID=o.id;var u=null;null!==g.mips?u=g.mips:i.manager?u=i.getAmbiance(c,!g.direct,{hdr:o,brdf:g.brdf},l).ambiance:(i.init(0),u=i._dummyRoughnessTexture),null!==u&&(this.envMap=o,this.envMipMap=[o,u])}else this.envMipMap=t.envMipMap,this.envMap=t.envMipMap[0];this.ambienceMatrix=t.ambienceMatrix}else t.reflectionProbes.length||(this.envMipMap=null,this.envMap=null);if(this._sheenData){var d=this._sheenData,p=null!==d.overrideIBL,f=p&&d._useCustom(),m=p&&!f&&t.envMipMap.length>0;if(p=f||m){var g=d.overrideIBL;if(m){o=t.envMipMap[0],l=t.id+"s"+o.id;c=o.id;c+="-"+g.brdf,t.envMipMapSheenID&&t.envMipMapSheenID!==l&&i.decreaseUseCount(t.envMipMapSheenID),t.envMipMapSheenID=l}else{l="ms"+this.id,o=g.hdr;c=g.name;c+="-"+o.id,c+="-"+g.brdf,d.overrideIBL.curID&&d.overrideIBL.curID!==o.id&&i.decreaseUseCount(l),d.overrideIBL.curID=o.id}u=null;i.manager?u=i.getAmbiance(c,!g.direct,{hdr:o,brdf:g.brdf},l).ambiance:(i.init(1),u=i._dummyRoughnessTexture),this._sheenData.envMipMap=u}}return this._needsIBLLightExtraction()&&this.envMap&&0===a.dirIBLLights&&this._sendEvent("requestIBLLightExtraction",{rendererID:s}),t.reflectionProbes.length?(this.envMap=t.reflectionProbes[0].map0,this.reflectionProbes=t.reflectionProbes):this.reflectionProbes=null,t.useFiniteEnvMap?(this.useFiniteEnvMap=t.useFiniteEnvMap,this.parallaxCorrectionParameters=t.parallaxCorrectionParameters):this.useFiniteEnvMap=!1,(this.envMap?1:0)|(this.reflectionProbes?2:0)|(this._sheenData&&this._sheenData.envMipMap?4:0)|(this.useFiniteEnvMap?8:0)|(this.envMap&&this.envMap.rgbHdr?16:0)|(this.envMipMap&&this.envMipMap[1]&&this.envMipMap[1].hasDiffuse?32:0)},L.prototype._defaultPDSFXOverridableFunctions=function(){var i=t.prototype._defaultPDSFXOverridableFunctions.call(this);return Object.assign(i.fragment,{ComputeViewNormal:e.ShaderChunk.PDSFXComputeViewNormal_FS,ComputeSpecularReflectance:e.ShaderChunk.PDSFXComputeSpecularReflectance_FS,ComputeEmissive:e.ShaderChunk.PDSFXComputeEmissive_FS,ComputeRoughness:e.ShaderChunk.PDSFXComputeRoughness_FS,ComputeTransparency:e.ShaderChunk.PDSFXComputeTransparency_FS}),i},L.prototype.updateDeferredMaterials=function(i){t.prototype.updateDeferredMaterials.call(this,i),this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial]=this},L}),define("DS/Materials/DSPBR21x",["DS/Mesh/ThreeJS_Base","DS/Materials/PhysicalMaterial"],function(e,t){"use strict";var i=function(e){e=e||{};var i={};Object.assign(i,e),this._setTypeParams(i),i.dspbr21x=!0,t.call(this,i)};return(i.prototype=Object.create(t.prototype)).clone=function(){var e=new i;return t.prototype.clone.call(this,e),e},i}),define("DS/Materials/DSPBR23x",["DS/Mesh/ThreeJS_Base","DS/Materials/PhysicalMaterial"],function(e,t){"use strict";const i=e.DSPBRSubTypes;var r=function(e){e=e||{};var r={};Object.assign(r,e),this._setTypeParams(r),r.DSPBR23x=!0,this._subtype=void 0!==r._subtype?r._subtype:i.Generic,t.call(this,r)};return(r.prototype=Object.create(t.prototype)).getSubType=function(){switch(this._subtype){case i.Metal:return"Metal";case i.Glass:return"Glass";case i.Plastic:return"Plastic";case i.Textile:return"Textile";case i.Leather:return"Leather";case i["Car Paint"]:return"Car Paint";case i.Emissive:return"Emissive";case i.Basic:return"Basic";case i.Wood:return"Wood"}return"Generic"},r.prototype.clone=function(){var e=new r;return t.prototype.clone.call(this,e),e._subtype=this._subtype,e},r}),define("DS/Materials/DSPBR22x",["DS/Mesh/ThreeJS_Base","DS/Materials/PhysicalMaterial"],function(e,t){"use strict";const i=e.DSPBRSubTypes;var r=function(e){e=e||{};var r={};Object.assign(r,e),this._setTypeParams(r),r.dspbr22x=!0,this._subtype=void 0!==r._subtype?r._subtype:i.Generic,t.call(this,r)};return(r.prototype=Object.create(t.prototype)).getSubType=function(){switch(this._subtype){case i.Metal:return"Metal";case i.Glass:return"Glass";case i.Plastic:return"Plastic";case i.Textile:return"Textile";case i.Leather:return"Leather";case i["Car Paint"]:return"Car Paint";case i.Emissive:return"Emissive";case i.Basic:return"Basic";case i.Wood:return"Wood"}return"Generic"},r.prototype.clone=function(){var e=new r;return t.prototype.clone.call(this,e),e._subtype=this._subtype,e},r}),define("DS/Materials/MeshBasicMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData","DS/Materials/DeferredCaches"],function(e,t,i,r){"use strict";var n=function(i){t.call(this),this.color=new e.Color(16777215),this.map=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this._depthValue=0,this._sceneGraphOrderMode=0,this.morphTargets=!1,this.numSupportedMorpTargets=0,this.canvasNodeTextureSaveParams=null,this.setValues(i)};return(n.prototype=Object.create(t.prototype))._getTextures=function(e){var i=t.prototype._getTextures.call(this,e);return i=i.concat([this.map])},n.prototype.getType=function(){return"Basic"},n.prototype._dump=function(){var e=t.prototype._dump.call(this);return e.color=this.color.toArray(),this.map&&(e.color="textured"),e},n.prototype._canUseLights=function(){return!1},n.prototype._shaderID="basic",n.prototype._transparencyOnGPU=function(e){return t.prototype._transparencyOnGPU.call(this,e)||this.map&&this.transparent},n.prototype.getPredefinedMaterial=function(t,i,a){var s=this.getBaseId();switch(s+="NonLighted",s+="S"+this.side,s+="CP"+this.enableClipPlanes,s+="Type"+i,i){case e.DefaultAppearanceMode.__QA_AUTOMATION__:var o=this.map?new e.Color(11184810):this.color;if(s+="Col"+o.getHex(),s="id"+(s+="Op"+this._opacity).hashCode(),!r.PredefinedMaterials.has(s)){var l=new n({side:this.side,enableClipPlanes:this.enableClipPlanes,color:o,opacity:this._opacity});l.activatePDSFX();var c={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor.rgb = ComputeAlbedo();","ioFinalColor.a = ComputeOpacity();","#ifdef GAMMA_OUTPUT","ioFinalColor.rgb = sqrt(ioFinalColor.rgb);","#endif","}"].join("\n")};l.setPDSFXOverridableFunctions({},c);var h=new r.DeferredMaterial(l);r.PredefinedMaterials.set(s,h)}break;default:return this}return r.PredefinedMaterials.get(s).get(this)},n.prototype.clone=function(e){return e||(e=new n),t.prototype.clone.call(this,e),e.color.copy(this.color),e.map=this.map,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.wireframeLinecap=this.wireframeLinecap,e.wireframeLinejoin=this.wireframeLinejoin,e.morphTargets=this.morphTargets,e.numSupportedMorpTargets=this.numSupportedMorpTargets,e.canvasNodeTextureSize=this.canvasNodeTextureSize,e.canvasNodeTextureSaveParams=this.canvasNodeTextureSaveParams,e},n.prototype.activatePDSFX=function(e){e=e||{},this._PDSFXData=new i,this._PDSFXData.PDSFX=!0,this._setDefaultPDSFXOverridableFunctions(),this._PDSFXData.PDSFX_hasAlbedo=!0,this._PDSFXData.PDSFX_hasOpacity=!0},n.prototype.loadUniforms=function(e,t,i,r,n,a){e.loadUniformsCommon(t,this,i,r,n,a),e.loadUniformsDepthLayer(t,this,i)},n}),define("DS/Materials/GridMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/MeshBasicMaterial"],function(e,t){"use strict";let i=["float mixDistance;"].join("\n"),r=["void ComputeCommonValues() {","vec3 vecDist = vGetViewPosition() - gridCenter;","mixDistance = 16.0 * dot(vecDist, vecDist);","mixDistance /= (gridSize * gridSize);","mixDistance = clamp(mixDistance, 0.0, 1.0);","}"].join("\n"),n=["vec3 ComputeAlbedo() {","vec3 cCenter = _DSalbedo_.xyz;","vec3 cBorder = cCenter*cCenter;","return mix(cCenter, cBorder, mixDistance);","}"].join("\n"),a=["void ProcessFinalColor(inout vec4 ioFinalColor) {","vec4 texelColor = texture2D( gridTexture, gridRepeat * vGetTexCoord0().xy + gridOffset );","vec3 cCenter = _DSalbedo_.rgb * texelColor.rgb;","vec3 cBorder = cCenter*cCenter;","ioFinalColor.rgb = mix(cCenter, cBorder, mixDistance);","ioFinalColor.a = texelColor.a * _DSopacity_ * mix(attenuation, 0.0, mixDistance);","#ifdef GAMMA_OUTPUT","ioFinalColor.rgb = sqrt(ioFinalColor.rgb);","#endif","}"].join("\n"),s=["float ComputeOpacity() {","return _DSopacity_ * mix(attenuation, 0.0, mixDistance);","}"].join("\n"),o=function(){t.call(this,{}),this.useBlending=!0,this.side=e.DoubleSide,this.depthTest=!1,this.force=!0,this.opacity=1,this.transparent=!0,this.enableClipPlanes=!1,this.activatePDSFX();let a={gridCenter:{type:"v3",value:new e.Vector3},gridSize:{type:"f",value:1},attenuation:{type:"f",value:1},gridTexture:{type:"t2",value:null},gridOffset:{type:"v2",value:new e.Vector2},gridRepeat:{type:"v2",value:new e.Vector2}};this.setPDSFXUniforms(a),this.setPDSFXGlobalShaderCode("",i),this.setPDSFXOverridableFunctions({},{ComputeCommonValues:r,ComputeAlbedo:n,ComputeOpacity:s}),this._refreshPDSFXUniforms_private=function(e,t){var i=this.getPDSFXUniform("gridTexture").value;i&&(this.updatePDSFXUniform("gridOffset",i.offset),this.updatePDSFXUniform("gridRepeat",i.repeat))}};return(o.prototype=Object.create(t.prototype)).getType=function(){return"Grid"},o.prototype.setGridTexture=function(t){this.updatePDSFXUniform("gridTexture",t),this.needsUpdate=!0,t?this.setPDSFXOverridableFunctions({},{ComputeCommonValues:r,ComputeAlbedo:e.ShaderChunk.PDSFXComputeAlbedo_FS,ProcessFinalColor:a,ComputeOpacity:e.ShaderChunk.PDSFXComputeOpacity_FS}):this.setPDSFXOverridableFunctions({},{ComputeCommonValues:r,ComputeAlbedo:n,ProcessFinalColor:e.ShaderChunk.PDSFXProcessFinalColor_FS,ComputeOpacity:s})},o.prototype._setMaterialShaderOptions=function(e,i,r,n,a,s){e.inlinedPostProActivated=!1,t.prototype._setMaterialShaderOptions.call(this,e,i,r,n,a,s)},o.prototype.getPredefinedMaterial=function(e,t,i){return this},o.prototype.updateDeferredMaterials=function(e){t.prototype.updateDeferredMaterials.call(this,e);for(let e=1;e<this._deferredMaterials.length;e++)this._deferredMaterials[e]=null},o}),define("DS/Materials/OutlineMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/MeshBasicMaterial"],function(e,t){"use strict";const i="\n\t\tvoid ComputeCommonValues() {\n\n\t\t\tvec3 _position = vGetAttribPosition();\n\t\t\tvec3 _normal = vGetAttribNormal();\n\t\t\tfloat texSharingOffset = _normal.z; //in rgb pixel\n\n\t\t\tfloat i1 = _position.x+texSharingOffset;\n\t\t\tfloat i2 = _position.y+texSharingOffset;\n\t\t\tfloat i3 = _position.z+texSharingOffset;\n\t\t\tfloat i4 = _normal.x+texSharingOffset;\n\n\t\t\tfloat maxMapTotalSize = MAX_OUTLINE_MAP_SIZE*MAX_OUTLINE_MAP_SIZE; //both dimension\n\t\t\tint texId_1 = int(floor(i1/maxMapTotalSize));\n\t\t\tint texId_2 = int(floor(i2/maxMapTotalSize));\n\t\t\tint texId_3 = int(floor(i3/maxMapTotalSize));\n\t\t\tint texId_4 = int(floor(i4/maxMapTotalSize));\n\n\t\t\tfloat dx_1, dx_2, dx_3, dx_4;\n\t\t\tfloat dy_1, dy_2, dy_3, dy_4;\n\t\t\tfloat x_1, x_2, x_3, x_4;\n\t\t\tfloat y_1, y_2, y_3, y_4;\n\n\n\t\t\tfloat idInTexture_1 = i1 - float(texId_1)*maxMapTotalSize;\n\t\t\tfloat idInTexture_2 = i2 - float(texId_2)*maxMapTotalSize;\n\t\t\tfloat idInTexture_3 = i3 - float(texId_3)*maxMapTotalSize;\n\t\t\tfloat idInTexture_4 = i4 - float(texId_4)*maxMapTotalSize;\n\n\n\t\t\tif (texId_1 == NB_OUTLINE_MAPS - 1) {\n\t\t\t\tdx_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t\tdy_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;\n\t\t\t\ty_1 = floor(idInTexture_1/LAST_OUTLINE_MAP_SIZE_X);\n\t\t\t\tx_1 = idInTexture_1 - y_1*LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t} else {\n\t\t\t\tdx_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\tdy_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\ty_1 = floor(idInTexture_1/MAX_OUTLINE_MAP_SIZE);\n\t\t\t\tx_1 = idInTexture_1 - y_1*MAX_OUTLINE_MAP_SIZE;\n\t\t\t}\n\n\t\t\tif (texId_2 == NB_OUTLINE_MAPS - 1) {\n\t\t\t\tdx_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t\tdy_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;\n\t\t\t\ty_2 = floor(idInTexture_2/LAST_OUTLINE_MAP_SIZE_X);\n\t\t\t\tx_2 = idInTexture_2 - y_2*LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t} else {\n\t\t\t\tdx_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\tdy_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\ty_2 = floor(idInTexture_2/MAX_OUTLINE_MAP_SIZE);\n\t\t\t\tx_2 = idInTexture_2 - y_2*MAX_OUTLINE_MAP_SIZE;\n\t\t\t}\n\n\t\t\tif (texId_3 == NB_OUTLINE_MAPS - 1) {\n\t\t\t\tdx_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t\tdy_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;\n\t\t\t\ty_3 = floor(idInTexture_3/LAST_OUTLINE_MAP_SIZE_X);\n\t\t\t\tx_3 = idInTexture_3 - y_3*LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t} else {\n\t\t\t\tdx_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\tdy_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\ty_3 = floor(idInTexture_3/MAX_OUTLINE_MAP_SIZE);\n\t\t\t\tx_3 = idInTexture_3 - y_3*MAX_OUTLINE_MAP_SIZE;\n\t\t\t}\n\n\t\t\tif (texId_4 == NB_OUTLINE_MAPS - 1) {\n\t\t\t\tdx_4 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t\tdy_4 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;\n\t\t\t\ty_4 = floor(idInTexture_4/LAST_OUTLINE_MAP_SIZE_X);\n\t\t\t\tx_4 = idInTexture_4 - y_4*LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t} else {\n\t\t\t\tdx_4 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\tdy_4 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\ty_4 = floor(idInTexture_4/MAX_OUTLINE_MAP_SIZE);\n\t\t\t\tx_4 = idInTexture_4 - y_4*MAX_OUTLINE_MAP_SIZE;\n\t\t\t}\n\n\n\t\t\tvec3 current = sampleOutlineMaps(texId_1, vec2( dx_1 * ( x_1 + 0.5 ), dy_1 * ( y_1 + 0.5 ) ) ).xyz;\n\t\t\tvec3 opposite = sampleOutlineMaps(texId_2, vec2( dx_2 * ( x_2 + 0.5 ), dy_2 * ( y_2 + 0.5 ) ) ).xyz;\n\t\t\tvec3 firstSide = sampleOutlineMaps(texId_3, vec2( dx_3 * ( x_3 + 0.5 ), dy_3 * ( y_3 + 0.5 ) ) ).xyz;\n\t\t\tvec3 secondSide = sampleOutlineMaps(texId_4, vec2( dx_4 * ( x_4 + 0.5 ), dy_4 * ( y_4 + 0.5 ) ) ).xyz;\n\n\n\t\t\tmat4 PM = vGetProjectionMatrix();\n\n\t\t\tviewCurrent = vec3(computeModelViewPosition(vec4(current, 1.0)));\n\t\t\tviewOpposite = vec3(computeModelViewPosition(vec4(opposite, 1.0)));\n\t\t\tvec3 viewFirst = vec3(computeModelViewPosition(vec4(firstSide, 1.0)));\n\t\t\tvec3 viewSecond = vec3(computeModelViewPosition(vec4(secondSide, 1.0)));\n\n\t\t\tisPersp = PM[2][3] == -1.0;\n\n\t\t\tnewViewPosition = vec4(viewCurrent, 1.0);\n\n\t\t\tvec3 mvNormal = vec3(0.0,0.0,0.0);\n\n\t\t\t//first side normal\n\t\t\tvec3 mv_firstNormal = normalize(cross(opposite-current, firstSide-current));\n\t\t\tmv_firstNormal = normalize(computeModelViewDirection(mv_firstNormal).xyz);\n\t\t\t//second side normal\n\t\t\tvec3 mv_secondNormal = normalize(cross(secondSide-current,opposite-current));\n\t\t\tmv_secondNormal = normalize(computeModelViewDirection(mv_secondNormal).xyz);\n\n\n\t\t\tisOutline=false;\n\t\t\tif (isPersp) {\n\t\t\t\tisOutline = isOutlinePerspective(viewCurrent, viewOpposite, viewFirst, viewSecond, mv_firstNormal, mv_secondNormal);\n\t\t\t} else {\n\t\t\t\tisOutline = isOutlineOrthographic(mv_firstNormal, mv_secondNormal);\n\t\t\t}\n\t\t}\n\t",r="\n\t\tvoid ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {\n\t\t\tfloat far = vGetNearFarLogFactor().y;\n\t\t\tif (isPersp) {\n\t\t\t\tif (!isOutline) newViewPosition.xyz*=(1000000000.0*far); //if both side normals are on the same side with respect to the camera plan\n\t\t\t} else {\n\t\t\t\tif (!isOutline) newViewPosition.z = 1000000000.0*far; //if both side normals are on the same side with respect to the camera plan\n\t\t\t}\n\t\t\tioWorldViewTS.Position = newViewPosition.xyz;\n\t\t}\n\t",n={VS_global:"\n\t\t\t#define GPU_OUTLINES\n\t\t\tbool isOutline;\n\t\t\tvec4 newViewPosition;\n\n\t\t\tvec3 viewCurrent;\n\t\t\tvec3 viewOpposite;\n\n\t\t\tfloat far;\n\t\t\tfloat near;\n\t\t\tbool isPersp;\n\n\t\t\tbool isOutlinePerspective(vec3 viewCurrent, vec3 viewOpposite, vec3 viewFirstSide, vec3 viewSecondSide, vec3 mv_firstNormal, vec3 mv_secondNormal) {\n\n\t\t\t\tvec3 viewRayCurrent = normalize(viewCurrent);\n\t\t\t\tvec3 viewRayOpposite = normalize(viewOpposite);\n\t\t\t\tvec3 viewRayFirst = normalize(viewFirstSide);\n\t\t\t\tvec3 viewRaySecond = normalize(viewSecondSide);\n\n\t\t\t\t//first triangle\n\t\t\t\tfloat dot_curr_first = dot(viewRayCurrent,mv_firstNormal);\n\t\t\t\tfloat dot_opp_first = dot(viewRayOpposite,mv_firstNormal);\n\t\t\t\tfloat dot_first_first = dot(viewRayFirst,mv_firstNormal);\n\n\t\t\t\t//second triangle\n\t\t\t\tfloat dot_curr_second = dot(viewRayCurrent,mv_secondNormal);\n\t\t\t\tfloat dot_opp_second = dot(viewRayOpposite,mv_secondNormal);\n\t\t\t\tfloat dot_second_second = dot(viewRaySecond,mv_secondNormal);\n\n\t\t\t\tif (dot_curr_first*dot_opp_first > 0.0\n\t\t\t\t\t&& dot_curr_first*dot_first_first > 0.0\n\t\t\t\t\t&& dot_curr_second*dot_opp_second > 0.0\n\t\t\t\t\t&& dot_curr_second*dot_second_second > 0.0)\n\t\t\t\t{\n\t\t\t\t\tif (dot_first_first*dot_second_second < 0.0) return true;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\n\t\t\t}\n\n\t\t\tbool isOutlineOrthographic(in vec3 mv_firstNormal, in vec3 mv_secondNormal) {\n\t\t\t\treturn mv_firstNormal.z*mv_secondNormal.z < 0.0;\n\t\t\t}\n\n\t\t\tvec4 sampleOutlineMaps(in int idInTextureArray, in vec2 texCoords) {\n\t\t\t\t__OUTLINES_MAPS_SAMPLING__\n\t\t\t}\n\t\t",FS_global:"\n\t\t\t#define GPU_OUTLINES\n\t\t\t#ifdef RENDER_TO_FLOAT_TEXTURE\n\n\t\t\t\tvec4 getNormalDepth(in vec2 coord) {\n\t\t\t\t\tvec4 res = texture2D( depthBuffer, coord );\n\t\t\t\t\tvec3 normal = normalize(2.0 * res.xyz - 1.0);\n\t\t\t\t\tfloat depth = res.w;\n\t\t\t\t\tif (depth < 0.01) depth = 1.0;\n\t\t\t\t\treturn vec4(normal,depth);\n\t\t\t\t}\n\n\t\t\t\tfloat getPolygonOffset(in vec2 coord,in vec3 vN, in float depth) {\n\t\t\t\t\tmat4 P = projectionMatrix;\n\t\t\t\t\tbool isPersp = P[2][3] == -1.0;\n\n\t\t\t\t\tfloat slopeFactor = isPersp ? 1.0 : 0.1;\n\n\t\t\t\t\tvec2 sr = vec2(2.0)/depthMapSize;\n\t\t\t\t\tvec2 vC = (gl_FragCoord.xy - 0.5) / depthMapSize;\n\t\t\t\t\tvC = 2.0*vC - 1.0;\n\n\t\t\t\t\tfloat K = dot(vec3(P[1][1] * (vC.x + P[2][0]), P[0][0] * (vC.y + P[2][1]), -P[0][0] * P[1][1]), vN);\n\t\t\t\t\tvec2 offset = vec2(P[1][1] * vN.x*sr.x, P[0][0] * vN.y*sr.y);\n\n\t\t\t\t\tfloat factor = (-depth - 0.5 * (P[2][2] - 1.0)) / K;\n\t\t\t\t\tfloat dFdxOfZ = abs(offset.x * factor);\n\t\t\t\t\tfloat dFdyOfZ = abs(offset.y * factor);\n\n\t\t\t\t\tfloat slope = max(dFdxOfZ, dFdyOfZ);\n\t\t\t\t\tslope = min(max(slope, 1e-6), 1e-3);\n\n\t\t\t\t\treturn (slope * slopeFactor) + (DEPTH_PRECISION * 1.5);\n\t\t\t\t}\n\n\t\t\t\tfloat getOffsetedDepth(in vec2 coord) {\n\t\t\t\t\tvec4 nDepth = getNormalDepth(coord);\n\t\t\t\t\tfloat offset = getPolygonOffset(coord,nDepth.xyz,nDepth.w);\n\n\t\t\t\t\treturn nDepth.w + offset;\n\t\t\t\t}\n\n\t\t\t\tfloat depthSampleTest(in vec2 coord, in float delta, in float depth) {\n\t\t\t\t\tfloat fDepth = getOffsetedDepth(coord);\n\t\t\t\t\tif ( fDepth < depth ) return delta;\n\t\t\t\t\treturn 0.0;\n\t\t\t\t}\n\n\t\t\t#else\n\n\n\t\t\t\tfloat getDepth(in vec2 coord) {\n\t\t\t\t\tvec4 rgba_depth = texture2D( depthBuffer, coord );\n\n\t\t\t\t\tfloat depth = unpackRGBA(rgba_depth);\n\t\t\t\t\treturn depth > 1e-6 ? depth + 1.0* DEPTH_PRECISION : 1.0;\n\n\t\t\t\t}\n\n\t\t\t\tfloat depthSampleTest(in vec2 coord, in float delta, in float depth) {\n\t\t\t\t\tfloat fDepth = getDepth(coord);\n\t\t\t\t\tif ( fDepth < depth ) return delta;\n\t\t\t\t\treturn 0.0;\n\t\t\t\t}\n\n\t\t\t#endif\n\n\n\t\t\tbool correctZFighting() {\n\n\n\n\t\t\t\tvec2 coord = 0.5 + 0.5*cP.xy/cP.w;\n\t\t\t\tfloat depth = 0.5 + 0.5 * cP.z / cP.w;\n\t\t\t\tfloat delta = 1.0/9.0;\n\t\t\t\tfloat test = 0.0;\n\n\t\t\t\tfloat dx0 =  -0.5/depthMapSize.x;\n\t\t\t\tfloat dy0 = -0.5/depthMapSize.y;\n\t\t\t\tfloat dx1 = -dx0;\n\t\t\t\tfloat dy1 = -dy0;\n\n\n\t\t\t\ttest += depthSampleTest(coord,delta, depth);\n\t\t\t\ttest += depthSampleTest(coord + vec2(dx0,dy0),delta, depth);\n\t\t\t\ttest += depthSampleTest(coord.xy + vec2( 0.0, dy0 ),delta, depth);\n\t\t\t\ttest += depthSampleTest(coord.xy + vec2( dx1, dy0 ),delta, depth);\n\t\t\t\ttest += depthSampleTest(coord.xy + vec2( dx0, 0.0 ),delta, depth);\n\t\t\t\ttest += depthSampleTest(coord.xy + vec2( dx1, 0.0 ),delta, depth);\n\t\t\t\ttest += depthSampleTest(coord.xy + vec2( dx0, dy1 ),delta, depth);\n\t\t\t\ttest += depthSampleTest(coord.xy + vec2( 0.0, dy1 ),delta, depth);\n\t\t\t\ttest += depthSampleTest(coord.xy + vec2( dx1, dy1 ),delta, depth);\n\t\t\t\t// if at this point 80% of the tests failed, discard\n\t\t\t\tif (test > 0.8) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t}\n\t\t",SimpleOutlinesShader:{VS_overridables:{ComputeCommonValues:i,ProcessViewTangentSpace:r,ProcessClipSpacePosition:"void ProcessClipSpacePosition(inout vec4 ioPosition) { cP = ioPosition; }"},FS_overridables:{ComputeAlbedo:"vec3 ComputeAlbedo()\n\t\t\t\t\t{\n\t\t\t\t\t\t#ifdef OUTLINES_SHOW_OCCLUDED\n\t\t\t\t\t\t\tbool occluded = correctZFighting();\n\t\t\t\t\t\t\tgl_FragDepthEXT = occluded ? 0.001 : 0.0;\n\t\t\t\t\t\t\treturn occluded ? occludedColor : _DSalbedo_;\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\treturn _DSalbedo_;\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}",ComputeDiscard:"bool ComputeDiscard()\n\t\t\t\t\t{\n\t\t\t\t\t\t#ifdef OUTLINES_SHOW_OCCLUDED\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\treturn correctZFighting();\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}"}},WideOutlinesShader:{VS_overridables:{ComputeCommonValues:i,ProcessViewTangentSpace:r,ProcessClipSpacePosition:"\n\t\t\t\t\tvoid ProcessClipSpacePosition(inout vec4 ioPosition) {\n\t\t\t\t\t\tmat4 PM = vGetProjectionMatrix();\n\t\t\t\t\t\tif (isOutline) {\n\t\t\t\t\t\t\tfloat sideExtrusion = vGetAttribNormal().y;\n\t\t\t\t\t\t\tbool isOpposite = mod(abs(sideExtrusion), 2.0) == 0.0;\n\n\n\t\t\t\t\t\t\tvec4 mvpCurr = PM*vec4(viewCurrent,1.0);\n\t\t\t\t\t\t\tvec4 mvpOpp = PM*vec4(viewOpposite,1.0);\n                            \n                            \n                            //from wideLineClip chunk: in case curr or opp have a negative w component (i.e. behind the camera)\n\t\t\t\t\t\t\tvec2 testClip = vec2(sign(mvpCurr.w + mvpCurr.z), sign(mvpOpp.w + mvpOpp.z));\n\t\t\t\t\t\t\tif ( testClip.x * testClip.y < 0.0 ){\n\t\t\t\t\t\t\t\t\tfloat a = (mvpCurr.w + mvpCurr.z)/((mvpCurr.w + mvpCurr.z) - (mvpOpp.w + mvpOpp.z));\n\t\t\t\t\t\t\t\t\tif (testClip.y < 0.0) {\n\t\t\t\t\t\t\t\t\t\tmvpOpp = (1.0 - a) * mvpCurr + a * mvpOpp;\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tmvpCurr = (1.0 - a) * mvpCurr + a * mvpOpp;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t//curr and opp in real pixel\n\t\t\t\t\t\t\tscreenCurr = (mvpCurr.xy / mvpCurr.w + 1.0) / pixelSize; // in [0,w]x[0,h] in pixel\n\t\t\t\t\t\t\tscreenOpp = (mvpOpp.xy / mvpOpp.w + 1.0) / pixelSize; // in [0,w]x[0,h] in pixel\n                            \n                            //extrusion of the wide outline quad + computing the z so the quad is flat\n\t\t\t\t\t\t\tvec3 ndcCurr = mvpCurr.xyz/mvpCurr.w;\n\t\t\t\t\t\t\tvec3 ndcOpp = mvpOpp.xyz/mvpOpp.w;\n\n\t\t\t\t\t\t\tfloat offset = sign(sideExtrusion) * outlineHalfWidth;\n\t\t\t\t\t\t\tvec2 line = normalize(screenOpp - screenCurr);\n\t\t\t\t\t\t\tvec2 lineNormal = vec2(-line.y, line.x);\n\n\t\t\t\t\t\t\tvec2 px_pos;\n\n\t\t\t\t\t\t\tpx_pos = screenCurr + offset*lineNormal - outlineHalfWidth*line;\n\n\t\t\t\t\t\t\tvec3 ndcPos = vec3((px_pos*pixelSize - 1.0), mvpCurr.z/mvpCurr.w);\n                            \n                            \n                            //so the 4 vertices of the outline have the same curr and opp for fragment shader treatment\n\t\t\t\t\t\t\tif (isOpposite) {\n\t\t\t\t\t\t\t\tvec2 tmp = screenCurr;\n\t\t\t\t\t\t\t\tscreenCurr = screenOpp;\n\t\t\t\t\t\t\t\tscreenOpp = tmp;\n\t\t\t\t\t\t\t}\n                            \n                            //Final position\t\n\t\t\t\t\t\t\tvec4 clipSpacePos = vec4(ndcPos*mvpCurr.w, mvpCurr.w);\n\t\t\t\t\t\t\tioPosition = clipSpacePos;\n\t\t\t\t\t\t\tcP = mvpCurr;\n\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tioPosition = PM*newViewPosition;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t"},FS_overridables:{ComputeAlbedo:"vec3 ComputeAlbedo()\n\t\t\t\t\t{\n\t\t\t\t\t\t#ifdef OUTLINES_SHOW_OCCLUDED\n\t\t\t\t\t\t\tbool occluded = correctZFighting();\n\t\t\t\t\t\t\tgl_FragDepthEXT = occluded ? 0.001 : 0.0;\n\t\t\t\t\t\t\treturn occluded ? occludedColor : _DSalbedo_;\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\treturn _DSalbedo_;\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}",ComputeDiscard:"\n\t\t\t\t\tbool ComputeDiscard()\n\t\t\t\t\t{\n\t\t\t\t\t\t#ifdef OUTLINES_SHOW_OCCLUDED\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\tbool toDiscard = correctZFighting();\n\t\t\t\t\t\t\tif (toDiscard) return toDiscard;\n\t\t\t\t\t\t\tvec2 fCoord = vGetFragCoord().xy;\n\n\t\t\t\t\t\t\tvec2 currOpp = screenOpp - screenCurr;\n\t\t\t\t\t\t\tvec2 currFcoord = fCoord - screenCurr;\n\t\t\t\t\t\t\tvec2 oppFcoord = fCoord - screenOpp;\n\n\t\t\t\t\t\t\ttoDiscard = false;\n                            \n                            //round caps so each individual line can nicely connect to its neighbour\n\t\t\t\t\t\t\tif (dot(currOpp, currFcoord ) < 0.0) {\n\t\t\t\t\t\t\t\tif (length(currFcoord) > outlineHalfWidth) toDiscard = true;\n\t\t\t\t\t\t\t} else if (dot(-currOpp, oppFcoord ) < 0.0) {\n\t\t\t\t\t\t\t\tif (length(oppFcoord) > outlineHalfWidth) toDiscard = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn toDiscard;\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}\n\t\t\t\t"}}};class a extends t{constructor(){super(),this.__dimension=1,this.activatePDSFX(),this.enableClipPlanes=!0,this.depthTest=!1,this.force=!0,this.color=new e.Color(0),this.occludedColor=new e.Color(11184810),this.showHidden=!1}getPredefinedMaterial(e,t,i){return this}setShowHiddenOutlines(e){this.showHidden!==!!e&&(this.showHidden=!!e,this.showHidden?this.defines.OUTLINES_SHOW_OCCLUDED=1:delete this.defines.OUTLINES_SHOW_OCCLUDED,this.depthTest=this.showHidden,this.needsUpdate=!0)}}class s extends a{constructor(t,i){if(super(),this.setPDSFXGlobalShaderCode(n.VS_global,n.FS_global),this.setPDSFXOverridableFunctions(n.SimpleOutlinesShader.VS_overridables,n.SimpleOutlinesShader.FS_overridables),t){this.defines={NB_OUTLINE_MAPS:t.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:t.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:t.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:t.LAST_OUTLINE_MAP_SIZE_Y};var r={occludedColor:{type:"v3",value:new e.Vector3(this.occludedColor.r,this.occludedColor.g,this.occludedColor.b)},outlinePositionMaps:{type:"t2v",value:i,length:this.defines.NB_OUTLINE_MAPS},depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new e.Vector2(.01,.01)}};this.setPDSFXUniforms(r)}else this.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0};this.setPDSFXVaryings({cP:{type:"v4"}}),this._refreshPDSFXUniforms_private=function(t,i){this.updatePDSFXUniform("occludedColor",new e.Vector3(this.occludedColor.r,this.occludedColor.g,this.occludedColor.b)),t.requestRealDepthBuffer(),t.dBuffer&&(this.updatePDSFXUniform("depthBuffer",t.dBuffer),this.updatePDSFXUniform("depthMapSize",new e.Vector2(t.dBuffer.width,t.dBuffer.height)))}}getType(){return"Outline"}clone(){let e=new s;return super.clone(e),e}}class o extends a{constructor(t,i,r){if(super(),this.forceSide=!0,this.side=e.DoubleSide,this.setPDSFXGlobalShaderCode(n.VS_global,n.FS_global),this.setPDSFXOverridableFunctions(n.WideOutlinesShader.VS_overridables,n.WideOutlinesShader.FS_overridables),t){this.defines={NB_OUTLINE_MAPS:t.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:t.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:t.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:t.LAST_OUTLINE_MAP_SIZE_Y};var a={occludedColor:{type:"v3",value:new e.Vector3(this.occludedColor.r,this.occludedColor.g,this.occludedColor.b)},outlinePositionMaps:{type:"t2v",value:i,length:this.defines.NB_OUTLINE_MAPS},depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new e.Vector2(.01,.01)},outlineHalfWidth:{type:"f",value:r},pixelSize:{type:"v2",value:new e.Vector2}};this.setPDSFXUniforms(a)}else this.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0};this.setPDSFXVaryings({screenCurr:{type:"v2"},screenOpp:{type:"v2"},cP:{type:"v4"}}),this._refreshPDSFXUniforms_private=function(t,i){this.updatePDSFXUniform("occludedColor",new e.Vector3(this.occludedColor.r,this.occludedColor.g,this.occludedColor.b)),this.updatePDSFXUniform("pixelSize",new e.Vector2(2/t.domElement.width,2/t.domElement.height)),t.requestRealDepthBuffer(),t.dBuffer&&(this.updatePDSFXUniform("depthBuffer",t.dBuffer),this.updatePDSFXUniform("depthMapSize",new e.Vector2(t.dBuffer.width,t.dBuffer.height)))}}getType(){return"WideOutline"}clone(){let e=new o;return super.clone(e),e}}return{_OutlineMaterial:s,_WideOutlineMaterial:o}}),define("DS/Materials/SectionBuilderMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/MeshBasicMaterial"],function(e,t){"use strict";var i={};i.VS_global=["#define SECTION_BUILDER","vec4 getClipPlaneEquation(in int index);","float getDist(vec4 pos) {","  vec4 clipPlaneEquation = getClipPlaneEquation(currentClipPlane);","  float dist = dot( pos.xyz, clipPlaneEquation.xyz ) + clipPlaneEquation.w;","  return dist;","}","vec4 getIntersection( vec4 M, vec4 N) {","  vec4 clipPlaneEquation = getClipPlaneEquation(currentClipPlane);","  vec3 direction = vec3(N.x - M.x, N.y - M.y, N.z - M.z);","  vec4 result;","  float t;","  float denominator = dot(direction, clipPlaneEquation.xyz);","  if(denominator == 0.0) {","    return M;","  } else {","    t = -(dot(M.xyz, clipPlaneEquation.xyz) + clipPlaneEquation.w) / denominator;","    result = vec4(t*direction+M.xyz, 1.0);","    return result;","  }","}","float far;","float near;","bool hide;","vec4 mvCurrInter;","vec4 mvOtherInter;","float linearizeNDC(in float iNonLinearNDC) {","\tfloat z01 = 0.5*iNonLinearNDC + 0.5;","\tfloat res = 2.0*near/(far + near - z01*(far - near));","\tres = res *2.0 - 1.0;","\treturn res;","}"].join("\n"),i.FS_global="#define SECTION_BUILDER";var r=["vec3 _position = vGetAttribPosition();","float i1 = _position.x;","float i2 = _position.y;","float i3 = _position.z;","float maxMapTotalSize = MAX_OUTLINE_MAP_SIZE*MAX_OUTLINE_MAP_SIZE;","int texId_1 = int(floor(i1/maxMapTotalSize));","int texId_2 = int(floor(i2/maxMapTotalSize));","int texId_3 = int(floor(i3/maxMapTotalSize));","float dx_1, dx_2, dx_3;","float dy_1, dy_2, dy_3;","float x_1, x_2, x_3;","float y_1, y_2, y_3;","float idInTexture_1 = i1 - float(texId_1)*maxMapTotalSize;","float idInTexture_2 = i2 - float(texId_2)*maxMapTotalSize;","float idInTexture_3 = i3 - float(texId_3)*maxMapTotalSize;","if (texId_1 == NB_OUTLINE_MAPS - 1) {","dx_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_1 = floor(idInTexture_1/LAST_OUTLINE_MAP_SIZE_X);","x_1 = idInTexture_1 - y_1*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_1 = floor(idInTexture_1/MAX_OUTLINE_MAP_SIZE);","x_1 = idInTexture_1 - y_1*MAX_OUTLINE_MAP_SIZE;","}","if (texId_2 == NB_OUTLINE_MAPS - 1) {","dx_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_2 = floor(idInTexture_2/LAST_OUTLINE_MAP_SIZE_X);","x_2 = idInTexture_2 - y_2*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_2 = floor(idInTexture_2/MAX_OUTLINE_MAP_SIZE);","x_2 = idInTexture_2 - y_2*MAX_OUTLINE_MAP_SIZE;","}","if (texId_3 == NB_OUTLINE_MAPS - 1) {","dx_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_3 = floor(idInTexture_3/LAST_OUTLINE_MAP_SIZE_X);","x_3 = idInTexture_3 - y_3*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_3 = floor(idInTexture_3/MAX_OUTLINE_MAP_SIZE);","x_3 = idInTexture_3 - y_3*MAX_OUTLINE_MAP_SIZE;","}","vec3 P = texture2D( outlinePositionMaps[texId_1], vec2( dx_1 * ( x_1 + 0.5 ), dy_1 * ( y_1 + 0.5 ) ) ).xyz;","vec3 M = texture2D( outlinePositionMaps[texId_2], vec2( dx_2 * ( x_2 + 0.5 ), dy_2 * ( y_2 + 0.5 ) ) ).xyz;","vec3 N = texture2D( outlinePositionMaps[texId_3], vec2( dx_3 * ( x_3 + 0.5 ), dy_3 * ( y_3 + 0.5 ) ) ).xyz;","mat4 PM = vGetProjectionMatrix();","float m22 = PM[2][2];","float m32 = PM[3][2];","bool isPersp = PM[2][3] == -1.0;","if (isPersp) {","near = m32 / (m22 - 1.0);","far = ((m22 - 1.0)*near)/(m22 + 1.0);","} else {","near = (m32+1.0)/m22;","far = near - 2.0/m22;","}","vec4 mvP = computeModelViewPosition(vec4(P, 1.0));","vec4 mvM = computeModelViewPosition(vec4(M, 1.0));","vec4 mvN = computeModelViewPosition(vec4(N, 1.0));","mvCurrInter = mvP;","mvOtherInter = mvM;","hide = true;"].join("\n");i.SimpleSectionShader={VS_overridables:{ComputeCommonValues:["void ComputeCommonValues() {",r,"if (vGetAttribTexCoord0().x > 0.0 && getDist(mvP) > 0.0 && getDist(mvM) < 0.0) {","  mvCurrInter = getIntersection(mvP, mvM);","  hide = false;","}","if (vGetAttribTexCoord0().x < 0.0 && getDist(mvP) < 0.0 && getDist(mvN) > 0.0) {","  if(getDist(mvM) < 0.0) {","    mvCurrInter = getIntersection(mvM, mvN);","  } else {","    mvCurrInter = getIntersection(mvM, mvP);","  }","  hide = false;","}","}"].join("\n"),ProcessViewTangentSpace:["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","ioWorldViewTS.Position = mvCurrInter.xyz;","}"].join("\n"),ProcessClipSpacePosition:["void ProcessClipSpacePosition(inout vec4 ioPosition) {","if (hide) ioPosition.z = 10000000.0 * far;","}"].join("\n")},FS_overridables:{}},i.WideSectionShader={VS_overridables:{ComputeCommonValues:["void ComputeCommonValues() {",r,"if (vGetAttribTexCoord0().x > 0.0 && getDist(mvP) > 0.0 && getDist(mvM) < 0.0) {","  mvCurrInter = getIntersection(mvP, mvM);","  if(getDist(mvN) > 0.0) {","    mvOtherInter = getIntersection(mvM, mvN);","  } else {","    mvOtherInter = getIntersection(mvN, mvP);","  }","  hide = false;","}","if (vGetAttribTexCoord0().x < 0.0 && getDist(mvP) < 0.0 && getDist(mvN) > 0.0) {","  if(getDist(mvM) < 0.0) {","    mvCurrInter = getIntersection(mvM, mvN);","  } else {","    mvCurrInter = getIntersection(mvM, mvP);","  }","  mvOtherInter = getIntersection(mvN, mvP);","  hide = false;","}","}"].join("\n"),ProcessViewTangentSpace:["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","ioWorldViewTS.Position = mvCurrInter.xyz;","}"].join("\n"),ProcessClipSpacePosition:["void ProcessClipSpacePosition(inout vec4 ioPosition) {","mat4 PM = vGetProjectionMatrix();","vec4 mvpCurr = PM*vec4(mvCurrInter.xyz,1.0);","vec4 mvpOpp = PM*vec4(mvOtherInter.xyz,1.0);","screenCurr = (mvpCurr.xy / mvpCurr.w + 1.0) / pixelSize;","screenOpp = (mvpOpp.xy / mvpOpp.w + 1.0) / pixelSize;","vec3 ndcCurr = mvpCurr.xyz/mvpCurr.w;","vec3 ndcOpp = mvpOpp.xyz/mvpOpp.w;","float sideExtrusion = vGetAttribTexCoord0().y * vGetAttribTexCoord0().x;","float offset = sign(sideExtrusion) * sectionLineHalfWidth;","vec2 line = normalize(screenOpp - screenCurr);","vec2 lineNormal = vec2(-line.y, line.x);","vec2 ptAlongLine = screenCurr - sectionLineHalfWidth*line;","vec2 ndcPtAlongLine = ptAlongLine*pixelSize - 1.0;","float ndcD = length(ndcCurr.xy - ndcPtAlongLine);","float lengthCurrOpp = length(ndcCurr.xy - ndcOpp.xy);","float ndcZDelta = ndcD*abs(ndcCurr.z-ndcOpp.z)/lengthCurrOpp;","float ndcZDeltaLin = ndcD*abs(linearizeNDC(ndcCurr.z)-linearizeNDC(ndcOpp.z))/lengthCurrOpp;","vec2 px_pos;","if (ndcZDeltaLin > 0.7*ndcD) {","px_pos = screenCurr + offset*lineNormal;","ndcZDelta = 0.0;","} else {","px_pos = screenCurr + offset*lineNormal - sectionLineHalfWidth*line;","}","ndcZDelta *= sign(ndcCurr.z - ndcOpp.z);","float ndcFinalZ = mvpCurr.z/mvpCurr.w + ndcZDelta;","vec3 ndcPos = vec3((px_pos*pixelSize - 1.0), ndcFinalZ);","if (vGetAttribTexCoord0().x < 0.0) {","vec2 tmp = screenCurr;","screenCurr = screenOpp;","screenOpp = tmp;","}","vec4 clipSpacePos = vec4(ndcPos*mvpCurr.w, mvpCurr.w);","ioPosition = clipSpacePos;","if (hide) ioPosition.z = 10000000.0 * far;","}"].join("\n")},FS_overridables:{ComputeDiscard:["bool ComputeDiscard() { ","vec2 fCoord = gl_FragCoord.xy;","vec2 currOpp = screenOpp - screenCurr;","vec2 currFcoord = fCoord - screenCurr;","vec2 oppFcoord = fCoord - screenOpp;","bool toDiscard = false;","if (dot(currOpp, currFcoord ) < 0.0) {","if (length(currFcoord) > sectionLineHalfWidth) toDiscard = true;","} else if (dot(-currOpp, oppFcoord ) < 0.0) {","if (length(oppFcoord) > sectionLineHalfWidth) toDiscard = true;","}","return toDiscard;","}"].join("\n")}};var n=function(){t.call(this),this.activatePDSFX(),this.force=!0,this.enableClipPlanes=!0,this.side=e.DoubleSide,this.polygonOffset=!0,this.clipPlaneIndex=0};(n.prototype=Object.create(t.prototype)).getPredefinedMaterial=function(e,t,i){return this},n.prototype.__dimension=1,n.prototype.__isSectionLine=!0;var a=function(e,t){if(n.call(this),this.setPDSFXGlobalShaderCode(i.VS_global,i.FS_global),this.setPDSFXOverridableFunctions(i.SimpleSectionShader.VS_overridables,i.SimpleSectionShader.FS_overridables),e){this.defines={NB_OUTLINE_MAPS:e.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:e.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:e.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:e.LAST_OUTLINE_MAP_SIZE_Y};var r={outlinePositionMaps:{type:"t2v",value:t,length:this.defines.NB_OUTLINE_MAPS},currentClipPlane:{type:"i",value:0}};this.setPDSFXUniforms(r)}else this.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0};this.refreshPDSFXUniforms=function(){this.updatePDSFXUniform("currentClipPlane",this.clipPlaneIndex-1)}};(a.prototype=Object.create(n.prototype)).getType=function(){return"Section"},a.prototype.clone=function(){var e=new a;return n.prototype.clone.call(this,e),e};var s=function(t,r,a){if(n.call(this),this.forceSide=!0,this.side=e.DoubleSide,this.setPDSFXGlobalShaderCode(i.VS_global,i.FS_global),this.setPDSFXOverridableFunctions(i.WideSectionShader.VS_overridables,i.WideSectionShader.FS_overridables),t){this.defines={NB_OUTLINE_MAPS:t.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:t.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:t.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:t.LAST_OUTLINE_MAP_SIZE_Y};var s={outlinePositionMaps:{type:"t2v",value:r,length:this.defines.NB_OUTLINE_MAPS},currentClipPlane:{type:"i",value:0},sectionLineHalfWidth:{type:"f",value:a},pixelSize:{type:"v2",value:new e.Vector2}};this.setPDSFXUniforms(s)}else this.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0};this.setPDSFXVaryings({screenCurr:{type:"v2"},screenOpp:{type:"v2"}}),this._refreshPDSFXUniforms_private=function(t,i){this.updatePDSFXUniform("pixelSize",new e.Vector2(2/t.domElement.width,2/t.domElement.height)),this.updatePDSFXUniform("currentClipPlane",this.clipPlaneIndex-1)}};return(s.prototype=Object.create(n.prototype)).getType=function(){return"WideSection"},s.prototype.clone=function(){var e=new s;return n.prototype.clone.call(this,e),e},{_SectionMaterial:a,_WideSectionMaterial:s}}),define("DS/MaterialLibs/MeshBasicLib",["DS/MaterialLibs/UniformsLib","DS/Shaders/DefaultShaders","DS/Shaders/DeferrableShaders","DS/Visualization/ShaderChunk","DS/Visualization/UniformsUtils","DS/Materials/MeshBasicMaterial"],function(e,t,i,r,n,a){"use strict";var s=a.prototype.deferrable,o="",l="",c="",h="";return s&&(o=[i.depth_pars_vertex,i.picking_pars_vertex,i.picking_instancing_pars_vertex,i.highlight_pars_vertex,i.texcoord_pars_vertex].join("\n"),c=[i.depth_vertex,i.picking_vertex,i.picking_instancing_vertex,i.highlight_vertex,i.texcoord_vertex].join("\n"),l=[i.picking_pars_fragment,i.picking_instancing_pars_fragment,i.depth_pars_fragment,i.decal_normal_depth_pars_fragment,i.shadowmap_pars_fragment,i.highlight_pars_fragment,i.texcoord_pars_fragment].join("\n"),h=[i.picking_fragment,i.picking_instancing_fragment,i.depth_fragment_face,i.normal_fragment,i.normal_depth_fragment,i.shadowmap_fragment,i.highlight_fragment_face,i.texcoord_fragment].join("\n")),{uniforms:n.merge([e.common,e.shadowmap,e.clipPlanes,e.postprocess,s?e.deferred:{}]),vertexShader:["#define BASIC",t.normal_viewposition_pars_vertex,r.clip_pars_vertex,r.map_pars_vertex,r.color_pars_vertex,r.morphtarget_pars_vertex,r.skinning_pars_vertex,r.fog_pars_vertex,i.oit_pars_vertex,o,"void main() {",r.PDSFX_start_vertex,r.map_vertex,r.color_vertex,r.morphnormal_vertex,r.skinbase_vertex,r.skinnormal_vertex,r.morphtarget_vertex,r.skinning_vertex,r.default_vertex_with_normal,r.defaultnormal_vertex,r.clip_vertex,r.fog_vertex,t.normal_viewposition_vertex,r.worldpos_vertex,i.oit_vertex,c,r.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:["#define BASIC",r.PDSFX_albedo_pars_fragment,r.PDSFX_opacity_pars_fragment,"#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","vec2 uvToUse;","#endif",t.normal_viewposition_pars_fragment,r.clip_pars_fragment,r.color_pars_fragment,r.map_pars_fragment,r.fog_pars_fragment,i.oit_pars_fragment,l,r.postprocess_pars_fragment,"void main() {","#ifdef PDSFX",r.PDSFX_map_fragment,r.PDSFX_mapping_fragment,"ComputeCommonValues();",r.PDSFX_discard_fragment,r.PDSFX_albedo_fragment,r.PDSFX_opacity_fragment,r.PDSFX_viewNormal_fragment,"vViewPosition = -ComputeViewPosition();","#endif","#if defined(SELECTION_MATERIAL)","gl_FragColor = vec4( diffuse, 1.0 );","#else","gl_FragColor = vec4( diffuse, opacity );","#endif","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","uvToUse=vUv;","#endif",t.normal_viewposition_fragment,r.clip_fragment,r.uvmapping_fragment,r.map_fragment,r.alphatest_fragment,r.color_fragment,r.postprocess_fragment,r.linear_to_gamma_fragment,r.PDSFX_end_fragment,r.fog_fragment,r.backgroundviewmode_lowlight_fragment,i._debug_common_face_fragment,i.oit_fragment,h,"}"].join("\n")}}),define("DS/Materials/DSPBR19x",["DS/Mesh/ThreeJS_Base","DS/Materials/PhysicalMaterial"],function(e,t){"use strict";var i=function(e){e=e||{};var i={};Object.assign(i,e),this._setTypeParams(i),i.dspbr19x=!0,t.call(this,i)};return(i.prototype=Object.create(t.prototype)).clone=function(e){return e||(e=new i),t.prototype.clone.call(this,e),e},i}),define("DS/Materials/SmallPlaneMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DSPBR19x"],function(e,t){"use strict";var i=function(){t.call(this,{specularContrib:0,metalness:0,ior:1,transparency:0,opacity:1,color:new e.Color(16777215)}),this.useLighting=!0,this.transparent=!1,this.useBlending=!0,this.blending=e.GroundShadowBlending,this.depthWrite=!1,this.side=e.DoubleSide,this.force=!0,this.polygonOffset=!0,this.polygonOffsetFactor=2,this.polygonOffsetUnits=1,this.enableClipPlanes=!1,this.defines={GROUND_SHADOW:0,INVISIBLE_PLANE_MATERIAL:!0},this.activatePDSFX();this.setPDSFXUniforms({groundShadow:{type:"t2",value:null}}),this.setPDSFXGlobalShaderCode("",""),this.setPDSFXOverridableFunctions({},{ComputeDiscard:"\n                bool ComputeDiscard() {\n                    vec3 I = vec3(0.0,0.0,1.0);\n                    if (!(vGetProjectionMatrix()[3][3] > 0.0)) {\n                        I = normalize(-vGetViewPosition());\n                    }\n                    return dot(I, vGetViewNormal()) < 0.0;\n                }\n            ",ProcessFinalColor:"\n            void ProcessFinalColor(inout vec4 ioFinalColor) {\n                ioFinalColor.rgb = clamp(ioFinalColor.rgb, vec3(0.0), vec3(1.0));\n                #ifdef GAMMA_OUTPUT\n                ioFinalColor.rgb *= ioFinalColor.rgb;\n                #endif\n                vec2 uv = vGetTexCoord0().xy;\n                #if GROUND_SHADOW == 1\n                    float shadowCoeff = texture2D(groundShadow, uv).x;\n                    ioFinalColor.xyz *= shadowCoeff;\n                #endif\n                vec2 toCenter = 2.0 * (vec2(0.5) - uv);\n                float distToCenter = min(1.0, dot(toCenter, toCenter));\n                float alpha = 1.0-max(ioFinalColor.x,max(ioFinalColor.y,ioFinalColor.z));\n                ioFinalColor = vec4(mix(ioFinalColor.xyz, vec3(1.0), distToCenter), alpha);\n                #ifdef GAMMA_OUTPUT\n                ioFinalColor.rgb = sqrt(ioFinalColor.rgb);\n                #endif\n                ioFinalColor.rgb = clamp(ioFinalColor.rgb, vec3(0.0), vec3(1.0));\n            }\n            "})};return(i.prototype=Object.create(t.prototype)).getType=function(){return"Small Plane"},i.prototype.getPredefinedMaterial=function(e,t,i){return this},i.prototype._setMaterialShaderOptions=function(e,i,r,n,a,s){e.useOIT=!1,e.inlinedPostProActivated=!1,e.invisiblePlaneMaterial=!0,e.maxDirIBLLights=0,e.maxDirPhongLights=0,e.maxSphereLights=0,e.maxTubeLights=0,e.maxDiskLights=0,e.maxAreaLights=0,e.maxIESLights=0,t.prototype._setMaterialShaderOptions.call(this,e,i,r,n,a,s)},i.prototype.areTexturesLoaded=function(){return!0},i.prototype.updateDeferredMaterials=function(i){t.prototype.updateDeferredMaterials.call(this,i),this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial]=null,this._deferredMaterials[e.MaterialToUse.pickingMaterial]=null,this._deferredMaterials[e.MaterialToUse.depthMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalMaterial]=null,this._deferredMaterials[e.MaterialToUse.highlightMaterial]=null,this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepth]=null,this._deferredMaterials[e.MaterialToUse.oitAccumMaterial]=null,this._deferredMaterials[e.MaterialToUse.oitRevealMaterial]=null},i}),define("DS/Materials/GASPBR",["DS/Mesh/ThreeJS_Base","DS/Materials/DSPBR19x"],function(e,t){"use strict";var i=function(e,i){if(!i)throw"Missing low quality material";t.call(this,e),this._phongFallbackMaterial=i,i._isGAS=!0,this._allowObjectColor=!0,i._allowObjectColor=!0};return(i.prototype=Object.create(t.prototype)).clone=function(){var e=new i(null,this._phongFallbackMaterial);return t.prototype.clone.call(this,e),e},i.prototype.getSubType=function(){return"GAS"},i.prototype.getType=function(){return"GAS"},i}),define("DS/Materials/CATGraphicalMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DSPBR19x"],function(e,t){"use strict";var i={User:0,ObjectLinearPlanar:1,EyeLinearPlanar:2,Environment:3},r={VisuBasic_diffuseTexCoord:{type:"v4"}},n=[null,["vec4 VisuBasic_ComputeDiffuseTexCoord() {","vec4 res = vec4(0.0);","vec4 pos = vec4(vGetAttribPosition(), 1.0);","res.s = dot(VisuBasic_ProjectionPlaneS, pos);","res.t = dot(VisuBasic_ProjectionPlaneT, pos);","return res;","}"].join("\n"),["mat4 VisuBasic_Transpose(in mat4 m) {","mat4 mT;","mT[0] = vec4(m[0][0], m[1][0], m[2][0], m[3][0]);","mT[1] = vec4(m[0][1], m[1][1], m[2][1], m[3][1]);","mT[2] = vec4(m[0][2], m[1][2], m[2][2], m[3][2]);","mT[3] = vec4(m[0][3], m[1][3], m[2][3], m[3][3]);","return mT;","}","vec4 VisuBasic_ComputeDiffuseTexCoord() {","vec4 res = vec4(0.0);","vec4 pos = vec4(vGetAttribPosition(), 1.0);","pos = computeModelViewPosition(pos);","mat4 modelViewInv = VisuBasic_Transpose(vGetViewInverseTransposeMatrix() * vGetWorldInverseTransposeMatrix()); ","res.s = dot(modelViewInv*VisuBasic_ProjectionPlaneS, pos);","res.t = dot(modelViewInv*VisuBasic_ProjectionPlaneT, pos);","return res;","}"].join("\n"),["vec4 VisuBasic_ComputeDiffuseTexCoord() {","vec4 res = vec4(0.0);","vec4 pos = vec4(vGetAttribPosition(), 1.0);","pos = computeModelViewPosition(pos);","res.xyz = normalize(pos.xyz);","return res;","}"].join("\n")],a=["VisuBasic_diffuseTexCoord = VisuBasic_ComputeDiffuseTexCoord();"].join("\n"),s=["#define _VISUBASIC_FORCE_PHYSICAL_DIFFUSE_UV","vec2 VisuBasic_diffuseTexUvToUse;","vec2 VisuBasic_ComputeSphereMapCoord(in vec3 r)","{","r.z+=1.0;","float m = 0.5/sqrt(dot(r,r));","return vec2(r.x*m+0.5, r.y*m+0.5);","}"].join("\n"),o=["VisuBasic_diffuseTexUvToUse = VisuBasic_diffuseTexCoord.xy;"].join("\n"),l=[null,o,o,["vec3 VisuBasic_orientedViewNormal = vGetViewNormal();","vec3 VisuBasic_dir = reflect(VisuBasic_diffuseTexCoord.xyz, VisuBasic_orientedViewNormal);","VisuBasic_diffuseTexUvToUse = VisuBasic_ComputeSphereMapCoord(VisuBasic_dir).st;"].join("\n")],c=function(o){o=o||{};var c={};Object.assign(c,o),c.textureMapping=o.textureMapping||"User",c.sheen=0,c.flakesCoverage=0,c.specularContrib=1,c.clearCoat=0,c.thinWalled=!0,t.call(this,c),this.reflectivity=void 0!==c.reflectivity?c.reflectivity:1,this.reflectivityEnvMap=void 0!==c.reflectivityEnvMap?c.reflectivityEnvMap:null,this.combine=void 0!==c.combine?c.combine:e.MultiplyOperation,this.textureBlending=void 0!==c.textureBlending?c.textureBlending:e.TextureBlendOperations.KEEP_DEFAULT;var h=i[c.textureMapping],u=n[h];if(this._internalPDSFXData=null,null!==u){var d={VisuBasic_ProjectionPlaneS:{type:"v4",value:new e.Vector4(1,0,0,0)},VisuBasic_ProjectionPlaneT:{type:"v4",value:new e.Vector4(0,1,0,0)}};if(void 0!==typeof c.projectionPlaneS){var p=c.projectionPlaneS;d.VisuBasic_ProjectionPlaneS.x=p[0],d.VisuBasic_ProjectionPlaneS.y=p[1],d.VisuBasic_ProjectionPlaneS.z=p[2],d.VisuBasic_ProjectionPlaneS.w=p[3]}if(void 0!==typeof c.projectionPlaneT){p=c.projectionPlaneT;d.VisuBasic_ProjectionPlaneT.x=p[0],d.VisuBasic_ProjectionPlaneT.y=p[1],d.VisuBasic_ProjectionPlaneT.z=p[2],d.VisuBasic_ProjectionPlaneT.w=p[3]}this._internalPDSFXData={uniforms:d,varyings:r,VS_global:u,FS_global:s,ComputeVaryingValuesVSBody:a,ComputeCommonValuesFSBody:l[h]},this.diffuseAddCoef=new e.Vector3,this.diffuseMulCoef=new e.Vector3(1,1,1),h===i.Environment&&(this.diffuseMulCoef=new e.Vector3(this.reflectivity,this.reflectivity,this.reflectivity)),this.activatePDSFX(),this.setPDSFXUniforms(null),this.setPDSFXVaryings(null),this.setPDSFXGlobalShaderCode(null,null),this.setPDSFXOverridableFunctions(null,null)}};return(c.prototype=Object.create(t.prototype)).clone=function(){var e=new c;return t.prototype.clone.call(this,e),e.reflectivity=this.reflectivity,e.reflectivityEnvMap=this.reflectivityEnvMap,e.combine=this.combine,e.textureBlending=this.textureBlending,e._internalPDSFXData=this._internalPDSFXData,e},c.prototype.setPDSFXUniforms=function(e){this._internalPDSFXData&&(e||(e={}),Object.assign(e,this._internalPDSFXData.uniforms)),t.prototype.setPDSFXUniforms.call(this,e)},c.prototype.setPDSFXVaryings=function(e){this._internalPDSFXData&&(e||(e={}),Object.assign(e,this._internalPDSFXData.varyings)),t.prototype.setPDSFXVaryings.call(this,e)},c.prototype.setPDSFXGlobalShaderCode=function(e,i){this._internalPDSFXData&&(e||(e=""),i||(i=""),i+="\n"+this._internalPDSFXData.FS_global,e+="\n"+this._internalPDSFXData.VS_global),t.prototype.setPDSFXGlobalShaderCode.call(this,e,i)},c.prototype.setPDSFXOverridableFunctions=function(e,i){if(this._internalPDSFXData){var r;if(e||(e={}),i||(i={}),e.ComputeVaryingValues){if(-1!==(r=e.ComputeVaryingValues.lastIndexOf("}"))){var n=e.ComputeVaryingValues;e.ComputeVaryingValues=n.substring(0,r)+"\n"+this._internalPDSFXData.ComputeVaryingValuesVSBody+"\n"+n.substring(r)}}else e.ComputeVaryingValues=["void ComputeVaryingValues() {",this._internalPDSFXData.ComputeVaryingValuesVSBody,"}"].join("\n");if(i.ComputeCommonValues){if(-1!==(r=i.ComputeCommonValues.lastIndexOf("}"))){n=i.ComputeCommonValues;i.ComputeCommonValues=n.substring(0,r)+"\n"+this._internalPDSFXData.ComputeCommonValuesFSBody+"\n"+n.substring(r)}}else i.ComputeCommonValues=["void ComputeCommonValues() {",this._internalPDSFXData.ComputeCommonValuesFSBody,"}"].join("\n")}t.prototype.setPDSFXOverridableFunctions.call(this,e,i)},c.prototype.getSubType=function(){return"CATGraphicalMaterial"},c.prototype.getType=function(){return"CATGraphicalMaterial"},c.prototype._transparencyOnGPU=function(i){return t.prototype._transparencyOnGPU.call(this,i)||this.map&&(this.textureBlending===e.TextureBlendOperations.BLEND||this.textureBlending===e.TextureBlendOperations.MODULATE)},c.prototype._getTextures=function(e){var i=t.prototype._getTextures.call(this,e);return e||(i=i.concat([this.reflectivityEnvMap])),i},c}),define("DS/Object3D/Mesh",["DS/Mesh/ThreeJS_Base","DS/Object3D/Object3D","DS/Mesh/Mesh","DS/Materials/MeshBasicMaterial"],function(e,t,i,r){"use strict";var n=1,a=[],s=function(e){0!=e&&a.push(e)},o=function(i,n,a){t.call(this),this.geometry=[],i&&(i.length?this.geometry=i.slice():void 0===i.length&&(this.geometry=i),this.geometry.boundingSphere=i.boundingSphere,this.geometry.boundingBox=i.boundingBox),e.disableJHGDev?this.material=void 0!==n?n:new r({color:16777215*Math.random(),wireframe:!1}):this.material=void 0!==n?n:null,this.matApp=null,this.gas=null,this.geometry&&null===this.geometry.boundingSphere&&this.geometry.computeBoundingSphere(),this.geometry.boundingSphere||(this.geometry.boundingSphere=new e.Sphere),this.geometry.boundingBox||(this.geometry.boundingBox=new e.Box3),this.beforeRenderCB=null,this._meshRef=0,this.pickable=!0,this.pickingID=0,this.sceneGraph=null,this.highLight=null,this.noPickThrough=!0,this.enableNormalDepth=!0,this.__invisiblePlane=!1,this.visible=!0,this.visibilityFree=!1,this._noZPriority=!1,this._priorityMode=e.PriorityMode.ClassicPriority,this._depthPriority=0,this.filtered=!1,this.layer=null,this.selectionGroups=null,this.outlinesGeometry=null,this.sectionLinesBuilder=null,this._bodyDim=0,this.hasPoint=!1,this.renderPointsOnly=!1,this._checkGeometry(),this.boundingSphere=this.geometry.boundingSphere,this.boundingBox=this.geometry.boundingBox,this.geomWorldBE=[],this.__webglInit=!1,this.__webglActive=null,this._normalMatrix=null,this.render=!0,this.z=0,this.renderLineMode=null,this._occurrence=null,this.pickingPriorityID=0,this.occurrenceRenderingOverride=null,this._centerZ=0,this.highlightMeshes=null,this.preHighlight=null,this._instancingInfos=null,this.clippingPlane=null,this.disableMirror=0,this._manipulators=void 0,this._3dxmlMaterial=null,this._gsso_cache=null,this._advancedPriority=!1,this.fromLoadedModel=!1,this.materialMode=2,this.isCurvedPipe=!1,this.geometry.length&&(i[0].compressedVertices&&(this._programID|=e.ProgramIDs.COMPRESSED_VERTICES),i[0].compressedNormals&&(this._programID|=e.ProgramIDs.COMPRESSED_NORMALS),i[0].compressedUVs&&(this._programID|=e.ProgramIDs.COMPRESSED_UVS),i[0].compressedColors&&(this._programID|=e.ProgramIDs.COMPRESSED_COLORS)),this._vertexColors=e.VertexColorType.NoColors,this._skinning=null,this._skinningInstancing=null,this.lightMapData=null,this._decalData=null,this._tokens={},this._scenes=null,a||window.sealWebVisuObjects&&Object.seal(this),this._forceBackFacesOnSolid=!1,this.kdTree=null};return(o.prototype=Object.create(t.prototype))._isDecal=function(){return this._decalData&&this._decalData.key>0&&this._decalData.key%2==1},o.prototype._isReceivingDecal=function(){return this._decalData&&this._decalData.key>0&&this._decalData.key%2==0},o.prototype._isInDecalPass=function(){return this._decalData&&this._decalData.stencilID>0&&this._decalData.key>0},o.prototype._forceGeomType=function(t){for(var i="string"==typeof t?e.GeomTypeEnum[t]:t,r=0;r<this.geometry.length;r++)for(var n=this.geometry[r],a=0;a<n.drawingGroups.length;a++){n.drawingGroups[a]._geomType=i}},o.prototype.getMorphTargetIndexByName=function(e){return void 0!==this.morphTargetDictionary[e]?this.morphTargetDictionary[e]:(console.log("Mesh.getMorphTargetIndexByName: morph target "+e+" does not exist. Returning 0."),0)},o.prototype.clone=function(e){return void 0===e&&(e=new o(this.geometry,this.material)),this.matApp&&(e.matApp=this.matApp),t.prototype.clone.call(this,e),e._vertexColors=this._vertexColors,e._skinningInstancing=this._skinningInstancing,e._skinning=this._skinning,e},o.prototype.setVertexColors=function(t){this._vertexColors=t,t?this._programID|=e.ProgramIDs.VERTEX_COLORS:this._programID&=~e.ProgramIDs.VERTEX_COLORS,this._flagAsGSSOInvalidated()},o.prototype.setSkinningTransformations=function(t){this._skinning=t,this._skinningInstancing=null,this._programID&=~e.ProgramIDs.SKINNING_INSTANCING,t?this._programID|=e.ProgramIDs.SKINNING:this._programID&=~e.ProgramIDs.SKINNING,this._flagAsGSSOInvalidated()},o.prototype.setSkinningTransformationsInstancing=function(t){this._skinning=null,this._skinningInstancing=t,this._programID&=~e.ProgramIDs.SKINNING,t?this._programID|=e.ProgramIDs.SKINNING_INSTANCING:this._programID&=~e.ProgramIDs.SKINNING_INSTANCING,this._flagAsGSSOInvalidated()},o.prototype.getOwningScene=function(){return this.getScene()},o.prototype._flagAsGSSOInvalidated=function(){this._gsso_cache=null;var e,t=this;if(this._scenes){this._scenes.length;this._scenes.forEach(function(e){null!==e&&e.flagAsGSSOInvalidated(t)})}if(this.highlightMeshes)for(e=0;e<this.highlightMeshes.length;e++)this.highlightMeshes[e].renderable._flagAsGSSOInvalidated();this.preHighlight&&this.preHighlight._flagAsGSSOInvalidated()},o.prototype._compactArrays=function(e){for(var t=0;t<this.geometry.length;t++)this.geometry[t]._compactArrays(e)},o.prototype.recompileShaders=function(t){var i;if(this.material&&this.material.recompileShaders(!0,iParams),this.matApp&&this.matApp.recompileShaders(iParams),this.userData&&this.userData.oldMaterial&&this.userData.oldMaterial.recompileShaders(!0,iParams),this.layer&&this.layer.layers)for(i=0;i<this.layer.layers.length;i++){var r=this.layer.layers[i].drawableInterval.material;r&&r.recompileShaders(!0,iParams)}var n=null,a=0;this.geometry.length>=0?(n=this.geometry[0],a=this.geometry.length):2===this.geometry._type&&(n=this.geometry,a=1);for(var s=0;s<a;s++){for(var o=n.drawingGroups,l=0;l<o.length;l++)o[l].gas&&!o[l].gas.isGAS&&o[l].gas.recompileShaders(!1,iParams),o[l].material&&o[l].material instanceof e.Material&&o[l].material.recompileShaders(!1,iParams);n=this.geometry[s+1]}},o.prototype._getMMMatrix=function(){var i,r=null,n=function(e){return e&&e.parent&&e.parent.scene3js?e.parent.scene3js.viewer.currentViewpoint:null};if(this._billboardData&&this._billboardData.type>=1&&this.matrixWorld&&(i=n(this._occurrence))){var a=(x=i.camera).getLookAt();a.add(x.position);var s=(new e.Matrix4).extractRotation(this.matrixWorld),o=(new e.Matrix4).getInverse(s),l=null;if(1===this._billboardData.type)l=(new e.Matrix4).lookAt(x.position,a,x.up);else{var c=this._billboardData.axis,h=new e.Vector3,u=new e.Vector3,d=new e.Vector3,p=new e.Vector3,f=new e.Vector3,m=new e.Vector3,g=new e.Vector3;if(c?u.copy(c).transformDirection(this.matrixWorld).normalize():u.set(this.matrixWorld.elements[8],this.matrixWorld.elements[9],this.matrixWorld.elements[10]).normalize(),3===this._billboardData.type){var v=new e.Projector;g.getPositionFromMatrix(this.matrixWorld),h.subVectors(g,x.position),m.addVectors(g,u);var S=g.clone();v.projectVector(S,x),v.projectVector(m,x),m.z=S.z,v.unprojectVector(m,x),m.sub(g),m.normalize(),u.copy(m)}else h.subVectors(a,x.position);if(h.normalize(),d.crossVectors(h,u),d.lengthSq()<1e-10){var _=Math.abs(h.z)<.999?f.set(0,0,1):f.set(1,0,0);d.crossVectors(_,h)}d.normalize(),p.crossVectors(u,d),p.normalize(),l=(new e.Matrix4).set(d.x,p.x,u.x,0,d.y,p.y,u.y,0,d.z,p.z,u.z,0,0,0,0,1)}r=(new e.Matrix4).multiplyMatrices(o,l);this._billboardData.rotation&&(r=(new e.Matrix4).multiplyMatrices(r,this._billboardData.rotation))}if(this._ratioData&&this._ratioData.ratio>0&&this.matrixWorld&&(i=n(this._occurrence))){var y=new e.Vector3;y.getPositionFromMatrix(this.matrixWorld);var x,M=1/this.matrixWorld.getMaxScaleOnAxis();(x=i[this._ratioData.cameraName?this._ratioData.cameraName:"camera"]).fullWidth&&(M*=x.height/x.fullHeight);var P=M*x.getWorldSizeFromPixelSize(1,y,i.viewer._getDivClientHeight()),C=new e.Matrix4;if(this._ratioData.center){var b=(new e.Vector3).copy(this._ratioData.center);b.multiplyScalar(P);var D=(new e.Vector3).copy(b);D.applyMatrix4(this.matrixWorld),P=this._ratioData.ratio*M*x.getWorldSizeFromPixelSize(1,D,i.viewer._getDivClientHeight()),C.makeScale(P,P,P),C.setPosition(b)}else P*=this._ratioData.ratio,C.makeScale(P,P,P);var w=new e.Matrix4;if(w.multiplyMatrices(this.matrixWorld,C),r){var E=new e.Matrix4;return E=(new e.Matrix4).multiplyMatrices(w,r)}return w}return r&&this.matrixWorld?((E=new e.Matrix4).multiplyMatrices(this.matrixWorld,r),E):t.prototype._getMMMatrix.call(this)},o.prototype.computeKDTree=function(t){if(!this._occurrence||!e.KDTree)return null;var i=this._occurrence.node.mesh3js;if(i.kdTree)return this.kdTree=i.kdTree,i.kdTree;var r=new e.KDTree(100,20),n="build kd-tree for renderable "+this.id,a=performance.now();return r.buildFromMesh(i,!!t),n+=" took "+(performance.now()-a)/1e3+" s",e.VisualizationTraces.info(n),r.getNbNodes()>1&&r.getNbTotalElts()>100?(this.kdTree=r,i.kdTree=r,r):(console.warn("kdTree too small to be used"),this.kdTree=null,i.kdTree=null,null)},o.prototype._flagAsFrustumCulled=function(e){this._frustumCulled=e;var t,i=this;if(this._scenes){this._scenes.length;this._scenes.forEach(function(t){null!==t&&t.flagAsFrustumCulled(i,e)})}if(this.highlightMeshes)for(t=0;t<this.highlightMeshes.length;t++)this.highlightMeshes[t].renderable._flagAsFrustumCulled(e);this.preHighlight&&this.preHighlight._flagAsFrustumCulled(e)},Object.defineProperty(o.prototype,"instanceAttribArrays",{get:function(){return this._instancingInfos?this._instancingInfos.instanceAttribArrays:null},set:function(e){this._instancingInfos&&(this._instancingInfos.instanceAttribArrays=e)}}),Object.defineProperty(o.prototype,"instancingSelectionMode",{get:function(){return this._instancingInfos?this._instancingInfos.instancingSelectionMode:""},set:function(e){this._instancingInfos&&(this._instancingInfos.instancingSelectionMode=e)}}),Object.defineProperty(o.prototype,"nbInstances",{get:function(){return this._instancingInfos?this._instancingInfos.nbInstances:-1},set:function(e){this._instancingInfos&&(this._instancingInfos.nbInstances=e)}}),o.prototype.copyInstancingInfos=function(e){this._instancingInfos&&(e._instancingInfos={isInstanceNode3D:this._instancingInfos.isInstanceNode3D,nbInstances:this._instancingInfos.nbInstances,instancingSelectionMode:this._instancingInfos.instancingSelectionMode,instanceAttribArrays:this._instancingInfos.instanceAttribArrays,pickedInstanceId:[]})},o.prototype.addRefVBO=function(e){var t;e||(0==this._meshRef&&(this.pickingID=((t=a.length?a.pop():n++)>=4194303&&console.warn("max  number of pickingId values reached"),t)),this._meshRef++);var i=null,r=0;this.geometry.length>=0?(i=this.geometry[0],r=this.geometry.length):2===this.geometry._type&&(i=this.geometry,r=1);for(var s=0;s<r;s++)i.addRefVBO(this,e),i=this.geometry[s+1]},o.prototype.releaseVBO=function(e){e||(this._meshRef--,0==this._meshRef&&(s(this.pickingID),this.pickingID=0));var t=null,i=0;this.geometry.length>=0?(t=this.geometry[0],i=this.geometry.length):2===this.geometry._type&&(t=this.geometry,i=1);for(var r=0;r<i;r++)t.releaseVBO(this,e),t=this.geometry[r+1];this.clearOutlines()},o.prototype.clearOutlines=function(){this.outlinesGeometry&&(this.outlinesGeometry.dispose(),this.outlinesGeometry=null)},o.prototype.dispose=function(){var e=null,t=0;s(this.pickingID),this.pickingID=0,this.geometry.length>=0?(e=this.geometry[0],t=this.geometry.length):2===this.geometry._type&&(e=this.geometry,t=1);for(var i=0;i<t;i++)e.dispose(),e=this.geometry[i+1]},o.prototype.computeTangents=function(e){var t=null,i=0;this.geometry.length>=0?(t=this.geometry[0],i=this.geometry.length):2===this.geometry._type&&(t=this.geometry,i=1);for(var r=0;r<i;r++)t.computeTangents(e),t=this.geometry[r+1]},o.prototype.computeUVs=function(){var e=null,t=0;this.geometry.length>=0?(e=this.geometry[0],t=this.geometry.length):2===this.geometry._type&&(e=this.geometry,t=1);for(var i=0;i<t;i++)e.computeUVs(this.geometry.boundingBox),e=this.geometry[i+1]},o.prototype.detachGeometry=function(e){if(e&&this.layer){for(var t=this.layer.getIntervals(e,null,!0),i=0;i<t.length;i++)-1!==(r=this.layer.layers.indexOf(t[i]))&&(this.layer.layers.splice(r,1),this.layer.upToDate=!1);if(this.geometry&&this.geometry.length){var r=this.geometry.indexOf(e);-1!==r&&this.geometry.splice(r,1)}}},o.prototype.removeGeometry=function(e){if(e){for(var t=e.meshList,i=0;i<t.length;i++){if((n=t[i]).layer){var r=n.layer.getIntervals(e,null,!0);for(i=0;i<r.length;i++)-1!==(a=n.layer.layers.indexOf(r[i]))&&(n.layer.layers.splice(a,1),n.layer.upToDate=!1)}}for(i=0;i<t.length;i++){var n;if((n=t[i]).geometry&&n.geometry.length){var a=n.geometry.indexOf(e);-1!==a&&n.geometry.splice(a,1)}}}},o.prototype.addGeometry=function(t,r,n){for(var a=!1,s=0;s<this.geometry.length;s++)if(this.geometry[s]===t){a=!0;break}if(a)if(n){this.layer||this.initLayers(1);for(var o=0;o<n.length;o++){var l=n[o],c=l.drawableInterval;if(1===c.layerNum||c.material){for(var h=[],u=Math.min(l.drawableGroup.getPrimitivesCount(),c.primitiveStart+c.primitiveCount),d=c.primitiveStart;d<u;d++){var p=new i.SGPrimitiveHelper;p.set(l.drawableGroup,d),h.push(p)}this.layer.addPrimitivesToLayer(t,l.drawableGroup,h,c.layerNum,c.material)}}}else this._initLayersForGeometry(1,t);else{if(t.boundingBox||t.computeBoundingBox(),this.geometry.boundingBox||(this.geometry.boundingBox=new e.Box3),r&&this.geometry.boundingBox.expandByPoint(t.boundingBox.min),r&&this.geometry.boundingBox.expandByPoint(t.boundingBox.max),t.boundingSphere||t.computeBoundingSphere(),this.geometry.boundingSphere||(this.geometry.boundingSphere=new e.Sphere),r&&this.geometry.boundingSphere.clone().mergeWithSphere(t.boundingSphere,this.geometry.boundingSphere),this._occurrence&&this._occurrence.scene3js&&t.addRefVBO(this,!1),!this.layer&&!n)return this.geometry.push(t),void this._checkGeometry();this.layer||this.initLayers(1),this.geometry.push(t),n?this._copyLayers(n):this._initLayersForGeometry(1,t),this._checkGeometry()}},o.prototype.getRenderablesFromGeometries=function(){if(this.geometry&&this.geometry.length){for(var e={},t=0;t<this.geometry.length;t++)for(var i=this.geometry[t],r=0;r<i.meshList.length;r++){var n=i.meshList[r];e[n.id]=n}var a=[];for(var t in e)a.push(e[t]);return a}},o.prototype.optimizeBuffers=function(){},o.prototype.isMeshHiddenByLayer=function(){if(null===this.layer||!this.layer.layers.length)return!1;for(var e=0;e<this.layer.layers.length;e++){if(0!==this.layer.layers[e].drawableInterval.layerNum)return!1}return!0},o.prototype._findHLIndexOrAdd=function(e){var t,i=-1,r=this.highLight;r.map.has(e.container)?(t=r.map.get(e.container)).has(e.index)?i=t.get(e.index):t.set(e.index,r.primitives.length):((t=new Map).set(e.index,r.primitives.length),r.map.set(e.container,t));return i},o.prototype._removeHLIndex=function(e){var t=this.highLight;if(t.map.has(e.container)){var i=t.map.get(e.container);i.has(e.index)&&(i.delete(e.index),0===i.size&&t.map.delete(e.container))}},o.prototype._findHLIndex=function(e){var t=-1,i=this.highLight;if(i.map.has(e.container)){var r=i.map.get(e.container);r.has(e.index)&&(t=r.get(e.index))}return t},o.prototype.addHighLightPrimitive=function(e){if(this.highLight){var t=this.highLight,i=this._findHLIndexOrAdd(e);if(-1===i){var r=e.clone();t.primitives.push(r),t.nbSelected.push(1),null===this.layer&&this.initLayers(),this.layer.addPrimitivesToLayers([r],1)}else t.nbSelected[i]++}},o.prototype.addHighLightRep=function(e){if(this.highLight){for(var t=this.highLight,r=[],n=new i.SGPrimitiveHelper,a=0;a<e.getPrimitivesCount();a++){n.set(e,a);var s=this._findHLIndexOrAdd(n);if(-1===s){var o=n.clone();t.primitives.push(o),t.nbSelected.push(1),r.push(o)}else t.nbSelected[s]++}null===this.layer&&this.initLayers(),this.layer.addPrimitivesToLayers(r,1)}},o.prototype.removeHighLightPrimitive=function(e){if(this.highLight){var t=this._findHLIndex(e);if(-1!==t&&null!==this.layer){var i=this.highLight;i.nbSelected[t]--,i.nbSelected[t]||(this._removeHLIndex(e),i.primitives.splice(t,1),i.nbSelected.splice(t,1),this.layer.addPrimitivesToLayers([e.clone()],0))}}},o.prototype.removeHighLightRep=function(t){if(this.highLight){for(var r=[],n=this.highLight,a=new i.SGPrimitiveHelper,s=new Set,o=0;o<t.getPrimitivesCount();o++){a.set(t,o);var l=this._findHLIndex(a);-1!==l&&(n.nbSelected[l]--,n.nbSelected[l]||(this._removeHLIndex(a),s.add(l),r.push(a.clone())))}if(s.size>0){var c=new Array(n.primitives.length-s.size),h=new Array(n.nbSelected.length-s.size),u=0;for(o=0;o<n.primitives.length;o++)s.has(o)||(c[u]=n.primitives[o],h[u++]=n.nbSelected[o]);n.primitives=c,n.nbSelected=h}null===this.layer&&(this.layer=new e.BufferLayer(this)),this.layer.addPrimitivesToLayers(r,0)}},o.prototype.removeHighLight=function(){this.highLight&&(this.layer=null,this.highLight.map.clear(),this.highLight.primitives=[],this.highLight.nbSelected=[])},o.prototype.initLayers=function(t){if(null===this.layer){this.layer=new e.BufferLayer(this);var i=1,r=this.geometry;this.geometry.length>=0&&(r=this.geometry[0],i=this.geometry.length);for(var n=0;n<i;n++)this._initLayersForGeometry(t,r),r=this.geometry[n+1]}},o.prototype._initLayersForGeometry=function(t,i){this.layer||(this.layer=new e.BufferLayer(this));for(var r=this.layer.getIntervals(i,null,!0),n=0;n<r.length;n++){var a=this.layer.layers.indexOf(r[n]);-1!==a&&this.layer.layers.splice(a,1)}for(var s=0;s<i.drawingGroups.length;s++){var o=i.drawingGroups[s],l=new e.DrawableInterval(t,o.start,o.count);l.primitiveStart=0,l.primitiveCount=o.getPrimitivesCount();var c=new e.LayerInterval(i,o,l);this.layer.layers.push(c)}},o.prototype._copyLayers=function(t){this.layer||(this.layer=new e.BufferLayer(this));for(var i=0;i<t.length;i++){var r=t[i];this.layer.layers.push(r.clone())}},o.prototype.hasPriorityManipulators=function(){if(this._manipulators)for(var e in this._manipulators)if(this._manipulators[e].active&&this._manipulators[e].getPickingPriority())return!0;return!1},o.prototype.getManipulators=function(){for(var e={},t=this._occurrence;t;){if(t._manipulators)for(var i in t._manipulators){var r=t._manipulators[i];e[i]=r}t=t.parent}return e},o.prototype.hasManipulators=function(){if(this._manipulators)for(var e in this._manipulators)if(this._manipulators[e].active)return!0;return!1},o.prototype._checkGeometry=function(){var e,t,i,r,n,a;if(this.geometry.length)for(e=this.geometry.length,i=0;i<e;i++)if(2===(n=this.geometry[i])._type)for(t=(a=n.drawingGroups).length,r=0;r<t;r++)if(0===a[r].glType)return this.hasPoint=!0,!0;return!1},o.prototype.getNode=function(){return this._occurrence&&this._occurrence.node},o.prototype.getSelectionGroup=function(e){if(!this.selectionGroups)return null;for(var t=0;t<this.selectionGroups.length;t++){var i=this.selectionGroups[t];if(i.contains(e))return i}return null},o.prototype.removeSelectionGroup=function(e){if(!this.selectionGroups)return null;for(var t=0;t<this.selectionGroups.length;t++){if(this.selectionGroups[t].contains(e)){this.selectionGroups.splice(t,1);break}}},o.prototype.addSelectionGroup=function(e){this.selectionGroups||(this.selectionGroups=[]),this.selectionGroups.push(e)},o.prototype._performFrustumCulling=function(e,t,i,r,n){return t.performFrustumCulling(i,r)},o.prototype.getMin=function(t){var i,r,n,a,s,o=void 0!==t?t:"z",l=null,c=new e.Vector3;for(r=null,n=0,this.geometry.length>=0?(r=this.geometry[0],n=this.geometry.length):2===this.geometry._type&&(r=this.geometry,n=1),a=0;a<n;a++){if(null===r.vertexPositionArray){r=this.geometry[a+1];continue}i=this._getMMMatrix();const e=r.getVertexCount();for(s=0;s<e;s++)r.getVertexPosition(s,c),c.applyMatrix4(i),(c[o]<l||null===l)&&(l=c[o]);r=this.geometry[a+1]}return l},Object.defineProperty(o.prototype,"drawInHLRender",{get:function(){return e.getWebVisualizationLevel()>425?console.error("drawInHLRender deprecated, use noPickThrough instead"):console.warn("drawInHLRender deprecated, use noPickThrough instead"),this.noPickThrough},set:function(t){e.getWebVisualizationLevel()>425?console.error("drawInHLRender deprecated, use noPickThrough instead"):console.warn("drawInHLRender deprecated, use noPickThrough instead"),this.noPickThrough=t}}),o}),define("DS/Materials/MeshPhongMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData"],function(e,t,i){"use strict";var r=new e.Color,n=function(i){t.call(this),this.color=new e.Color(16777215),this.ambient=new e.Color(16777215),this.emissive=new e.Color(0),this.specular=new e.Color(1118481),this.shininess=30,this.shininessInSpecMap=!1,this.metal=!1,this.perPixel=!0,this.wrapAround=!1,this.wrapRGB=new e.Vector3(1,1,1),this._isGAS=!1,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new e.Vector2(1,1),this._firstDirOnly=!1,this.specularMap=null,this.envMap=null,this.combine=e.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.refractionRatioMap=null,this.reflectionCoef=0,this.shading=e.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.morphTargets=!1,this.morphNormals=!1,this.textureBlending=e.TextureBlendOperations.KEEP_DEFAULT,this.lights=!0,this.numSupportedMorphTargets=0,this.numSupportedMorphNormals=0,this._usePhongLighting=!0,this.setValues(i)};return(n.prototype=Object.create(t.prototype))._transparencyOnGPU=function(i){return t.prototype._transparencyOnGPU.call(this,i)||this.map&&(this.textureBlending===e.TextureBlendOperations.KEEP_DEFAULT||this.textureBlending===e.TextureBlendOperations.BLEND||this.textureBlending===e.TextureBlendOperations.MODULATE)},n.prototype._shaderID="phong",n.prototype._getTextures=function(e){var i=t.prototype._getTextures.call(this,e);return i=i.concat([this.map,this.specularMap,this.bumpMap,this.normalMap,this.refractionRatioMap])},n.prototype._dump=function(){var e=t.prototype._dump.call(this);return e.color=this.color.toArray(),this.map&&(e.color="textured"),e.specular=this.specular.toArray(),this.specularMap&&(e.specular="textured"),e.shininess=this.shininess,e},n.prototype.areTexturesLoaded=function(){return!!t.prototype.areTexturesLoaded.call(this)&&(!this.envMap||this.envMap.loadEndStatus!==e.AssetLoadingStatus.LOADING)},n.prototype.clone=function(){var e=new n;return t.prototype.clone.call(this,e),e.color.copy(this.color),e.ambient.copy(this.ambient),e.emissive.copy(this.emissive),e.specular.copy(this.specular),e.shininess=this.shininess,e.shininessInSpecMap=this.shininessInSpecMap,e.reflectionCoef=this.reflectionCoef,e.metal=this.metal,e.perPixel=this.perPixel,e.wrapAround=this.wrapAround,e.wrapRGB.copy(this.wrapRGB),e.map=this.map,e.bumpMap=this.bumpMap,e.bumpScale=this.bumpScale,e.normalMap=this.normalMap,e.normalScale.copy(this.normalScale),e.specularMap=this.specularMap,e.envMap=this.envMap,e.combine=this.combine,e.reflectivity=this.reflectivity,e.refractionRatio=this.refractionRatio,e.refractionRatioMap=this.refractionRatioMap,e.shading=this.shading,e._firstDirOnly=this._firstDirOnly,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.wireframeLinecap=this.wireframeLinecap,e.wireframeLinejoin=this.wireframeLinejoin,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e.textureBlending=this.textureBlending,e.numSupportedMorphTargets=this.numSupportedMorphTargets,e.numSupportedMorphNormals=this.numSupportedMorphNormals,e._isGAS=this._isGAS,e},n.prototype._autoForceSide=!0,n.prototype.getType=function(){return this._isGAS?"GAS":"Phong"},n.prototype.activatePDSFX=function(e){e=e||{},this._PDSFXData=new i,this._PDSFXData.PDSFX=!0,this._setDefaultPDSFXOverridableFunctions(),this._PDSFXData.PDSFX_hasAlbedo=!0,this._PDSFXData.PDSFX_hasEmissive=!0,this._PDSFXData.PDSFX_hasSpecular=!0,this._PDSFXData.PDSFX_hasOpacity=!0},n.prototype._defaultPDSFXOverridableFunctions=function(){var i=t.prototype._defaultPDSFXOverridableFunctions.call(this);return Object.assign(i.fragment,{ComputeEmissive:e.ShaderChunk.PDSFXComputeEmissive_FS,ComputeSpecularReflectance:e.ShaderChunk.PDSFXComputeSpecularReflectance_FS}),i},n.prototype._setMaterialShaderOptions=function(e,i,r,n,a,s){t.prototype._setMaterialShaderOptions.call(this,e,i,r,n,a,s),e.phongFirstDir=this._firstDirOnly,i&&Object.assign(e,{refractionRatioMap:this._isTextureAvailable("refractionRatioMap")})},n.prototype.loadUniforms=function(e,t,i,n,a,s){var o;i.ambient&&(o=this.ambient,this._isGAS&&(o=this.color,n&&n.getColor()&&(o=r.set(n.getColor()))),e.gammaInput&&(o=r.copyToLinear(o,e.simpleGamma)),t.uniform3f(i.ambient,o.r,o.g,o.b)),i.emissive&&(o=e.gammaInput?r.copyToLinear(this.emissive,e.simpleGamma):this.emissive,t.uniform3f(i.emissive,o.r,o.g,o.b)),i.specular&&(o=e.gammaInput?r.copyToLinear(this.specular,e.simpleGamma):this.specular,t.uniform3f(i.specular,o.r,o.g,o.b)),i.shininess&&t.uniform1f(i.shininess,Math.max(this.shininess,1e-6)),i.reflectionCoef&&t.uniform1f(i.reflectionCoef,this.reflectionCoef),i.shininessInSpecMap&&t.uniform1i(i.shininessInSpecMap,this.shininessInSpecMap),i.wrapRGB&&this.wrapAround&&t.uniform3f(i.wrapRGB,this.wrapRGB.x,this.wrapRGB.y,this.wrapRGB.z),e.loadUniformsCommon(t,this,i,n,a,s),e.loadUniformsBump(t,this,i),e.loadUniformsNormalMap(t,this,i)},n}),define("DS/Materials/PlaneMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/MeshPhongMaterial"],function(e,t){"use strict";var i=function(){t.call(this,{ambient:328965,specular:1118481}),this.lights=!0,this._usePhongLighting=!0,this.useBlending=!0,this.depthTest=!1,this.depthWrite=!1,this.side=e.DoubleSide,this.force=!0,this.enableClipPlanes=!1,this.activatePDSFX();let i={border:{type:"c",value:new e.Color(516)},borderAlpha:{type:"f",value:1},attenuation:{type:"i",value:0,stage:e.FragmentStage},displayGrid:{type:"f",value:1},displayPlane:{type:"f",value:1},gridFromBelow:{type:"f",value:1},planeMap:{type:"t2",value:null},gridTexture:{type:"t2",value:null},gridTexture2:{type:"t2",value:null},gridTexture3:{type:"t2",value:null},gridTexture4:{type:"t2",value:null},nbSteps:{type:"f",value:5},gridUnit:{type:"f",value:1},gridOffset:{type:"v2",value:new e.Vector2},gridCoeff:{type:"f",value:0},gridColor:{type:"c",value:new e.Color(16777215)},planeSize:{type:"f",value:100},planeBorder:{type:"f",value:1},planeFalloff:{type:"f",value:0},onlyDiffuse:{type:"f",value:0},gridFalloff:{type:"f",value:0},uvScale:{type:"f",value:1},planeOpacity:{type:"f",value:1}};this._v2Plane=!0,this.setPDSFXUniforms(i),this.setPlaneV2(!1)};return(i.prototype=Object.create(t.prototype)).getType=function(){return"Plane"},i.prototype.setPlaneV2=function(e){this._v2Plane!==e&&(this._v2Plane=e,e?(this.setPDSFXGlobalShaderCode("","\n        float stepFactor;\n        vec4 borderColor;\n        float fresnelFactor;\n        vec4 gridCol;\n        float planeAlpha;\n\n        const float alphaSlope = 0.66666666667;\n        const float alphaSlope2 = 0.44444444444;\n        const float edgeSize = 0.01;\n        const float stepSize = 0.001;\n        const float small2GridWidth = 0.0005;\n        const float smallGridWidth = 0.0005;\n        const float bigGridWidth = 0.0005;\n\n        #ifdef PLANE_MAP\n            vec4 planeMapColor;\n        #endif\n    "),this.setPDSFXOverridableFunctions({},{ComputeCommonValues:"\n        void ComputeCommonValues() {\n            vec3 I = vec3(0.0,0.0,1.0);\n            if (!(vGetProjectionMatrix()[3][3] > 0.0)) {\n                I = normalize(-vGetViewPosition());\n            }\n            fresnelFactor = dot(I, vGetViewNormal());\n\n            vec2 planeUV = vGetTexCoord0().xy * 2.0 - 1.0;\n            stepFactor = length(planeUV);\n            float borderMask = planeBorder * smoothstep(1.0 - 2.0 * edgeSize, 1.0 - 2.0 * edgeSize + stepSize, stepFactor) * smoothstep(1.0 - edgeSize + stepSize, 1.0 - edgeSize, stepFactor);\n            borderColor = vec4(border, borderMask);\n\n            float a2 = max(1.0 - alphaSlope2 * (1.0 + gridCoeff) * (1.0 + gridCoeff), 0.0);\n            float a1 = 1.0 - alphaSlope2 * gridCoeff * gridCoeff;\n            float a0 = 1.0 - alphaSlope2 * (1.0 - gridCoeff) * (1.0 - gridCoeff);\n            float a00 = max(1.0 - alphaSlope2 * (2.0 - gridCoeff) * (2.0 - gridCoeff), 0.0);\n            vec2 div = 0.5 * planeSize * planeUV + gridOffset;\n            vec2 big2Div = (1.0 / (nbSteps * nbSteps)) * div / gridUnit;\n            vec2 bigDiv = (1.0 / nbSteps) * div / gridUnit;\n            vec2 smallDiv = div / gridUnit;\n            vec2 small2Div = nbSteps * div / gridUnit;\n\n            float gridAlpha = texture2D(gridTexture, small2Div).a;\n            gridAlpha *= a2;\n            gridAlpha += a1 * texture2D(gridTexture2, smallDiv).a;\n            gridAlpha += a0 * texture2D(gridTexture3, bigDiv).a;\n            gridAlpha += a00 * texture2D(gridTexture4, big2Div).a;\n            gridAlpha = min(1.0, gridAlpha);\n\n            planeAlpha = 1.0001 - smoothstep(planeFalloff, 1.0, stepFactor);\n            gridAlpha *= 1.0001 - smoothstep(gridFalloff, 1.0, stepFactor);\n\n            planeAlpha *= planeOpacity * step(0.0, fresnelFactor) * displayPlane;\n            gridAlpha *= step(-gridFromBelow, fresnelFactor) * displayGrid;\n\n            gridCol = vec4(gridColor * gridColor, gridAlpha);\n\n            #ifdef PLANE_MAP\n                vec4 planeMapColor = texture2D( map,  vGetTexCoord0().xy * uvScale );\n            #endif\n        }   \n    ",ComputeDiscard:"\n        bool ComputeDiscard() {\n            return false;\n        }       \n    ",ProcessFinalColor:"\n                    void ProcessFinalColor(inout vec4 ioFinalColor) {\n                        #ifdef GAMMA_OUTPUT\n                        ioFinalColor.rgb *= ioFinalColor.rgb;\n                        #endif\n                        \n        vec3 cCenter = (ioFinalColor.xyz * (1.0 - onlyDiffuse)) + (onlyDiffuse * _DSalbedo_);\n        #ifdef PLANE_MAP\n            #ifdef GAMMA_INPUT\n                planeMapColor.xyz = convertToLinear(planeMapColor.xyz);\n            #endif\n            cCenter = mix(cCenter, planeMapColor.xyz, planeMapColor.a);\n        #endif\n        vec4 planeCol = vec4(mix(mix(cCenter, border, planeBorder), cCenter, planeAlpha), mix(planeAlpha, 1.0, planeBorder));\n        vec4 gridOverPlaneColor = vec4((gridCol.xyz * gridCol.a + planeCol.xyz * planeCol.a * (1.0 - gridCol.a)) / (0.0001 + gridCol.a + planeCol.a * (1.0 - gridCol.a)), gridCol.a + planeCol.a * (1.0 - gridCol.a));\n        ioFinalColor = mix(gridOverPlaneColor, borderColor, step(1.0 - 2.0 * edgeSize, stepFactor));\n    \n                        #ifdef GAMMA_OUTPUT\n                        ioFinalColor.rgb = sqrt(ioFinalColor.rgb);\n                        #endif\n                    }\n                "}),this.getPDSFXUniform("planeMap").value?this.defines={PLANE_MAP:1}:this.defines={}):(this.defines={},this.setPDSFXGlobalShaderCode("","\n        float fresnelFactor;\n        bool discardPlane;\n    "),this.setPDSFXOverridableFunctions({},{ComputeCommonValues:"\n        void ComputeCommonValues() {\n\n            vec3 I = vec3(0.0,0.0,1.0);\n            if (!(vGetProjectionMatrix()[3][3] > 0.0)) {\n                I = normalize(-vGetViewPosition());\n            }\n            fresnelFactor = dot(I, vGetViewNormal());\n\n            discardPlane = fresnelFactor < 0.0;\n            if (attenuation == 0) {\n                fresnelFactor = 1.0;\n            }\n        }   \n    ",ComputeDiscard:"\n        bool ComputeDiscard() {\n            return discardPlane;\n        }       \n    ",ProcessFinalColor:"\n                    void ProcessFinalColor(inout vec4 ioFinalColor) {\n                        #ifdef GAMMA_OUTPUT\n                        ioFinalColor.rgb *= ioFinalColor.rgb;\n                        #endif\n                        \n        vec2 dUV = 2.0 * (vGetTexCoord0().xy * 2.0 - 1.0);\n        float dist = dot(dUV, dUV);\n        float dist2 = clamp(dist * dist, 0.0, 1.0);\n        dist = clamp(dist, 0.0, 1.0);\n        ioFinalColor = vec4(mix(ioFinalColor.rgb, mix(ioFinalColor.rgb, border.rgb, borderAlpha), dist), fresnelFactor*(1.0 - dist2));\n    \n                        #ifdef GAMMA_OUTPUT\n                        ioFinalColor.rgb = sqrt(ioFinalColor.rgb);\n                        #endif\n                    }\n                "})),this.needsUpdate=!0)},i.prototype.setPlaneTexture=function(e){(this.getPDSFXUniform("planeMap").value?!e:e)&&(this.defines={},this.updatePDSFXUniform("planeMap",e),e&&this._v2Plane&&(this.defines={PLANE_MAP:1}),this.needsUpdate=!0)},i.prototype.getPredefinedMaterial=function(e,t,i){return this},i.prototype._setMaterialShaderOptions=function(e,i,r,n,a,s){e.useOIT=!1,t.prototype._setMaterialShaderOptions.call(this,e,i,r,n,a,s)},i.prototype.updateDeferredMaterials=function(i){t.prototype.updateDeferredMaterials.call(this,i),this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial]=null,this._deferredMaterials[e.MaterialToUse.pickingMaterial]=null,this._deferredMaterials[e.MaterialToUse.depthMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalMaterial]=null,this._deferredMaterials[e.MaterialToUse.highlightMaterial]=null,this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepth]=null,this._deferredMaterials[e.MaterialToUse.oitAccumMaterial]=null,this._deferredMaterials[e.MaterialToUse.oitRevealMaterial]=null},i}),define("DS/MaterialLibs/MeshPhongLib",["DS/Mesh/ThreeJS_Base","DS/MaterialLibs/UniformsLib","DS/Shaders/DefaultShaders","DS/Shaders/DeferrableShaders","DS/Visualization/ShaderChunk","DS/Visualization/UniformsUtils","DS/Materials/MeshPhongMaterial"],function(e,t,i,r,n,a,s){"use strict";var o=s.prototype.deferrable,l="",c="",h="",u="";return o&&(l=[r.depth_pars_vertex,r.picking_pars_vertex,r.picking_instancing_pars_vertex,r.highlight_pars_vertex,r.texcoord_pars_vertex].join("\n"),h=[r.depth_vertex,r.picking_vertex,r.picking_instancing_vertex,r.highlight_vertex,r.texcoord_vertex].join("\n"),c=[r.picking_pars_fragment,r.picking_instancing_pars_fragment,r.depth_pars_fragment,r.decal_normal_depth_pars_fragment,r.shadowmap_pars_fragment,r.highlight_pars_fragment,r.texcoord_pars_fragment].join("\n"),u=[r.picking_fragment,r.picking_instancing_fragment,r.depth_fragment_face,r.normal_fragment,r.normal_depth_fragment,r.shadowmap_fragment,r.highlight_fragment_face,r.texcoord_fragment].join("\n")),{uniforms:a.merge([t.common,t.bump,t.normalmap,t.lights,t.shadowmap,t.clipPlanes,{ambient:{type:"c",value:new e.Color(16777215)},emissive:{type:"c",value:new e.Color(0)},specular:{type:"c",value:new e.Color(1118481)},shininess:{type:"f",value:30},shininessInSpecMap:{type:"i",value:0},wrapRGB:{type:"v3",value:new e.Vector3(1,1,1)},reflectionCoef:{type:"f",value:0}},t.postprocess,o?t.deferred:{}]),vertexShader:["#define PHONG",i.normal_viewposition_pars_vertex,n.clip_pars_vertex,n.map_pars_vertex,n.envmap_pars_vertex,n.lights_phong_pars_vertex,n.color_pars_vertex,n.morphtarget_pars_vertex,n.skinning_pars_vertex,n.shadowmap_pars_vertex,n.fog_pars_vertex,r.oit_pars_vertex,l,"void main() {",n.PDSFX_start_vertex,n.map_vertex,n.color_vertex,n.morphnormal_vertex,n.skinbase_vertex,n.skinnormal_vertex,n.morphtarget_vertex,n.skinning_vertex,n.default_vertex_with_normal,n.defaultnormal_vertex,n.clip_vertex,n.fog_vertex,i.normal_viewposition_vertex,n.worldpos_vertex,n.envmap_vertex,n.lights_phong_vertex,n.shadowmap_vertex,r.oit_vertex,h,n.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:["#define PHONG",n.PDSFX_albedo_pars_fragment,n.PDSFX_opacity_pars_fragment,"uniform vec3 ambient;",n.PDSFX_emissive_pars_fragment,n.PDSFX_specular_pars_fragment,"uniform float shininess;","uniform float reflectionCoef;","uniform bool shininessInSpecMap;","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","vec2 uvToUse;","#endif",n.clip_pars_fragment,n.color_pars_fragment,n.map_pars_fragment,n.envmap_pars_fragment,n.lights_phong_pars_fragment,n.shadowmap_pars_fragment,n.bumpmap_pars_fragment,n.normalmap_pars_fragment,n.specularmap_pars_fragment,n.fog_pars_fragment,r.oit_pars_fragment,c,n.postprocess_pars_fragment,"void main() {","#ifdef PDSFX",n.PDSFX_map_fragment,n.PDSFX_mapping_fragment,"ComputeCommonValues();",n.PDSFX_discard_fragment,n.PDSFX_albedo_fragment,n.PDSFX_opacity_fragment,n.PDSFX_emissive_fragment,n.PDSFX_specular_fragment,n.PDSFX_viewNormal_fragment,"vViewPosition = -ComputeViewPosition();","#endif","#if defined(SELECTION_MATERIAL)","gl_FragColor = vec4( vec3(1.0), 1.0 );","#else","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );","#endif","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","uvToUse=vUv;","#endif",n.clip_fragment,n.uvmapping_fragment,n.map_fragment,n.alphatest_fragment,"float shininessValue = shininess;",n.specularmap_fragment,"#ifndef PHONG_FIRST_DIR_ONLY",n.lights_phong_fragment,"#else",n.lights_phong_firstdironly_fragment,"#endif",n.color_fragment,n.envmap_fragment,n.shadowmap_fragment,n.postprocess_fragment,n.linear_to_gamma_fragment,n.PDSFX_end_fragment,n.fog_fragment,n.backgroundviewmode_lowlight_fragment,r._debug_common_face_fragment,r.oit_fragment,u,"}"].join("\n")}}),define("DS/Visualization/ExplicitGeometries",["DS/Mesh/ThreeJS_Base","DS/Object3D/Object3D","DS/Object3D/Mesh"],function(e,t,i){"use strict";var r={LegacyGeometry:function(){e.EventDispatcher.call(this),this.id=e.GeometryIdCount++,this.name="",this._type=0,this.vertices=[],this.colors=[],this.normals=[],this.faces=[],this.faceUvs=[[]],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphColors=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.hasTangents=!1,this.dynamic=!0,this.verticesNeedUpdate=!1,this.elementsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.tangentsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.buffersNeedUpdate=!1}};return r.LegacyGeometry.prototype={constructor:r.LegacyGeometry,applyMatrix:function(t){for(var i=(new e.Matrix3).getInverse(t).transpose(),r=0,n=this.vertices.length;r<n;r++){this.vertices[r].applyMatrix4(t)}for(r=0,n=this.faces.length;r<n;r++){var a=this.faces[r];a.normal.applyMatrix3(i).normalize();for(var s=0,o=a.vertexNormals.length;s<o;s++)a.vertexNormals[s].applyMatrix3(i).normalize();a.centroid.applyMatrix4(t)}},computeCentroids:function(){var t,i,r;for(t=0,i=this.faces.length;t<i;t++)(r=this.faces[t]).centroid.set(0,0,0),r instanceof e.Face3?(r.centroid.add(this.vertices[r.a]),r.centroid.add(this.vertices[r.b]),r.centroid.add(this.vertices[r.c]),r.centroid.divideScalar(3)):r instanceof e.Face4&&(r.centroid.add(this.vertices[r.a]),r.centroid.add(this.vertices[r.b]),r.centroid.add(this.vertices[r.c]),r.centroid.add(this.vertices[r.d]),r.centroid.divideScalar(4))},computeFaceNormals:function(){for(var t=new e.Vector3,i=new e.Vector3,r=0,n=this.faces.length;r<n;r++){var a=this.faces[r],s=this.vertices[a.a],o=this.vertices[a.b],l=this.vertices[a.c];t.subVectors(l,o),i.subVectors(s,o),t.cross(i),t.normalize(),a.normal.copy(t)}},computeVertexNormals:function(t){var i,r,n,a,s,o;if(void 0===this.__tmpVertices){for(this.__tmpVertices=new Array(this.vertices.length),o=this.__tmpVertices,i=0,r=this.vertices.length;i<r;i++)o[i]=new e.Vector3;for(n=0,a=this.faces.length;n<a;n++)(s=this.faces[n])instanceof e.Face3?s.vertexNormals=[new e.Vector3,new e.Vector3,new e.Vector3]:s instanceof e.Face4&&(s.vertexNormals=[new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3])}else for(o=this.__tmpVertices,i=0,r=this.vertices.length;i<r;i++)o[i].set(0,0,0);if(t){var l,c,h,u,d=new e.Vector3,p=new e.Vector3,f=new e.Vector3,m=new e.Vector3,g=new e.Vector3;for(n=0,a=this.faces.length;n<a;n++)(s=this.faces[n])instanceof e.Face3?(l=this.vertices[s.a],c=this.vertices[s.b],h=this.vertices[s.c],d.subVectors(h,c),p.subVectors(l,c),d.cross(p),o[s.a].add(d),o[s.b].add(d),o[s.c].add(d)):s instanceof e.Face4&&(l=this.vertices[s.a],c=this.vertices[s.b],h=this.vertices[s.c],u=this.vertices[s.d],f.subVectors(u,c),p.subVectors(l,c),f.cross(p),o[s.a].add(f),o[s.b].add(f),o[s.d].add(f),m.subVectors(u,h),g.subVectors(c,h),m.cross(g),o[s.b].add(m),o[s.c].add(m),o[s.d].add(m))}else for(n=0,a=this.faces.length;n<a;n++)(s=this.faces[n])instanceof e.Face3?(o[s.a].add(s.normal),o[s.b].add(s.normal),o[s.c].add(s.normal)):s instanceof e.Face4&&(o[s.a].add(s.normal),o[s.b].add(s.normal),o[s.c].add(s.normal),o[s.d].add(s.normal));for(i=0,r=this.vertices.length;i<r;i++)o[i].normalize();for(n=0,a=this.faces.length;n<a;n++)(s=this.faces[n])instanceof e.Face3?(s.vertexNormals[0].copy(o[s.a]),s.vertexNormals[1].copy(o[s.b]),s.vertexNormals[2].copy(o[s.c])):s instanceof e.Face4&&(s.vertexNormals[0].copy(o[s.a]),s.vertexNormals[1].copy(o[s.b]),s.vertexNormals[2].copy(o[s.c]),s.vertexNormals[3].copy(o[s.d]))},computeTangents:function(){var t,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E=[],T=[],A=new e.Vector3,I=new e.Vector3,R=new e.Vector3,L=new e.Vector3,O=new e.Vector3;for(r=0,n=this.vertices.length;r<n;r++)E[r]=new e.Vector3,T[r]=new e.Vector3;function N(e,t,i,r,n,a,s){c=e.vertices[t],h=e.vertices[i],u=e.vertices[r],d=l[n],p=l[a],f=l[s],m=h.x-c.x,g=u.x-c.x,v=h.y-c.y,S=u.y-c.y,_=h.z-c.z,y=u.z-c.z,x=p.x-d.x,M=f.x-d.x,P=p.y-d.y,C=f.y-d.y,b=1/(x*C-M*P),A.set((C*m-P*g)*b,(C*v-P*S)*b,(C*_-P*y)*b),I.set((x*g-M*m)*b,(x*S-M*v)*b,(x*y-M*_)*b),E[t].add(A),E[i].add(A),E[r].add(A),T[t].add(I),T[i].add(I),T[r].add(I)}for(t=0,i=this.faces.length;t<i;t++)o=this.faces[t],l=this.faceVertexUvs[0][t],o instanceof e.Face3?N(this,o.a,o.b,o.c,0,1,2):o instanceof e.Face4&&(N(this,o.a,o.b,o.d,0,1,3),N(this,o.b,o.c,o.d,1,2,3));var F=["a","b","c","d"];for(t=0,i=this.faces.length;t<i;t++)for(o=this.faces[t],a=0;a<o.vertexNormals.length;a++)O.copy(o.vertexNormals[a]),s=o[F[a]],D=E[s],R.copy(D),R.sub(O.multiplyScalar(O.dot(D))).normalize(),L.crossVectors(o.vertexNormals[a],D),w=L.dot(T[s])<0?-1:1,o.vertexTangents[a]=new e.Vector4(R.x,R.y,R.z,w);this.hasTangents=!0},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new e.Box3),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new e.Sphere),this.boundingSphere.setFromCenterAndPoints(this.boundingSphere.center,this.vertices)},mergeVertices:function(){var t,i,r,n,a,s,o,l,c,h={},u=[],d=[],p=Math.pow(10,4);for(this.__tmpVertices=void 0,r=0,n=this.vertices.length;r<n;r++)t=this.vertices[r],void 0===h[i=[Math.round(t.x*p),Math.round(t.y*p),Math.round(t.z*p)].join("_")]?(h[i]=r,u.push(this.vertices[r]),d[r]=u.length-1):d[r]=d[h[i]];var f=[];for(r=0,n=this.faces.length;r<n;r++)if((a=this.faces[r])instanceof e.Face3){a.a=d[a.a],a.b=d[a.b],a.c=d[a.c],s=[a.a,a.b,a.c];for(var m=-1,g=0;g<3;g++)if(s[g]==s[(g+1)%3]){m=g,f.push(r);break}}else if(a instanceof e.Face4){a.a=d[a.a],a.b=d[a.b],a.c=d[a.c],a.d=d[a.d],s=[a.a,a.b,a.c,a.d];for(m=-1,g=0;g<4;g++)s[g]==s[(g+1)%4]&&(m>=0&&f.push(r),m=g);if(m>=0){s.splice(m,1);var v=new e.Face3(s[0],s[1],s[2],a.normal,a.color,a.materialIndex);for(o=0,l=this.faceVertexUvs.length;o<l;o++)(c=this.faceVertexUvs[o][r])&&c.splice(m,1);a.vertexNormals&&a.vertexNormals.length>0&&(v.vertexNormals=a.vertexNormals,v.vertexNormals.splice(m,1)),a.vertexColors&&a.vertexColors.length>0&&(v.vertexColors=a.vertexColors,v.vertexColors.splice(m,1)),this.faces[r]=v}}for(r=f.length-1;r>=0;r--)for(this.faces.splice(r,1),o=0,l=this.faceVertexUvs.length;o<l;o++)this.faceVertexUvs[o].splice(r,1);var S=this.vertices.length-u.length;return this.vertices=u,S},clone:function(){for(var t=new r.LegacyGeometry,i=this.vertices,n=0,a=i.length;n<a;n++)t.vertices.push(i[n].clone());var s=this.faces;for(n=0,a=s.length;n<a;n++)t.faces.push(s[n].clone());var o=this.faceVertexUvs[0];for(n=0,a=o.length;n<a;n++){for(var l=o[n],c=[],h=0,u=l.length;h<u;h++)c.push(new e.Vector2(l[h].x,l[h].y));t.faceVertexUvs[0].push(c)}return t},dispose:function(){this.dispatchEvent({type:"dispose"})}},r.ParticleSystem=function(i,r){t.call(this),this.geometry=i,this.material=void 0!==r?r:new e.ParticleBasicMaterial({color:16777215*Math.random()}),this.sortParticles=!1,this.geometry&&null===this.geometry.boundingSphere&&this.geometry.computeBoundingSphere(),this.frustumCulled=!1,console.log("ExplicitGeometries.ParticleSystem is deprecated. Please use SceneGraphFactory.createMeshNode instead.")},r.ParticleSystem.prototype=Object.create(t.prototype),r.ParticleSystem.prototype.clone=function(e){return void 0===e&&(e=new r.ParticleSystem(this.geometry,this.material)),e.sortParticles=this.sortParticles,t.prototype.clone.call(this,e),e},r.Line=function(i,r,n){t.call(this),this.geometry=i,this.material=void 0!==r?r:new e.LineBasicMaterial({color:16777215*Math.random()}),this.type=void 0!==n?n:e.LineStrip,this.geometry&&(this.geometry.boundingSphere||this.geometry.computeBoundingSphere())},r.Line.prototype=Object.create(t.prototype),r.Line.prototype.clone=function(e){return void 0===e&&(e=new r.Line(this.geometry,this.material,this.type)),t.prototype.clone.call(this,e),e},r.SkinnedMesh=function(t,r,n){i.call(this,t,r,!0),this.useVertexTexture=void 0===n||n,this.identityMatrix=new e.Matrix4,this.bones=[],this.boneMatrices=[],window.sealWebVisuObjects&&Object.seal(this)},r.SkinnedMesh.prototype=Object.create(i.prototype),r.CircleGeometry=function(t,i,n,a){r.LegacyGeometry.call(this),t=t||50,n=void 0!==n?n:0,a=void 0!==a?a:2*Math.PI,i=void 0!==i?Math.max(3,i):8;var s,o=[],l=new e.Vector3,c=new e.Vector2(.5,.5);for(this.vertices.push(l),o.push(c),s=0;s<=i;s++){var h=new e.Vector3,u=n+s/i*a;h.x=t*Math.cos(u),h.y=t*Math.sin(u),this.vertices.push(h),o.push(new e.Vector2((h.x/t+1)/2,-(h.y/t+1)/2+1))}var d=new e.Vector3(0,0,-1);for(s=1;s<=i;s++){var p=s,f=s+1;this.faces.push(new e.Face3(p,f,0,[d,d,d])),this.faceVertexUvs[0].push([o[s],o[s+1],c])}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new e.Sphere(new e.Vector3,t)},r.CircleGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.CubeGeometry=function(t,i,n,a,s,o){r.LegacyGeometry.call(this);var l=this;this.width=t,this.height=i,this.depth=n,this.widthSegments=a||1,this.heightSegments=s||1,this.depthSegments=o||1;var c=this.width/2,h=this.height/2,u=this.depth/2;function d(t,i,r,n,a,s,o,c){var h,u,d,p=l.widthSegments,f=l.heightSegments,m=a/2,g=s/2,v=l.vertices.length;"x"===t&&"y"===i||"y"===t&&"x"===i?h="z":"x"===t&&"z"===i||"z"===t&&"x"===i?(h="y",f=l.depthSegments):("z"===t&&"y"===i||"y"===t&&"z"===i)&&(h="x",p=l.depthSegments);var S=p+1,_=f+1,y=a/p,x=s/f,M=new e.Vector3;for(M[h]=o>0?1:-1,d=0;d<_;d++)for(u=0;u<S;u++){var P=new e.Vector3;P[t]=(u*y-m)*r,P[i]=(d*x-g)*n,P[h]=o,l.vertices.push(P)}for(d=0;d<f;d++)for(u=0;u<p;u++){var C=u+S*d,b=u+S*(d+1),D=u+1+S*(d+1),w=u+1+S*d,E=new e.Face4(C+v,b+v,D+v,w+v);E.normal.copy(M),E.vertexNormals.push(M.clone(),M.clone(),M.clone(),M.clone()),E.materialIndex=c,l.faces.push(E),l.faceVertexUvs[0].push([new e.Vector2(u/p,1-d/f),new e.Vector2(u/p,1-(d+1)/f),new e.Vector2((u+1)/p,1-(d+1)/f),new e.Vector2((u+1)/p,1-d/f)])}}d("z","y",-1,-1,this.depth,this.height,c,0),d("z","y",1,-1,this.depth,this.height,-c,1),d("x","z",1,1,this.width,this.depth,h,2),d("x","z",1,-1,this.width,this.depth,-h,3),d("x","y",1,-1,this.width,this.height,u,4),d("x","y",-1,-1,this.width,this.height,-u,5),this.computeCentroids(),this.mergeVertices()},r.CubeGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.CylinderGeometry=function(t,i,n,a,s,o){r.LegacyGeometry.call(this),t=void 0!==t?t:20,i=void 0!==i?i:20;var l,c,h=(n=void 0!==n?n:100)/2,u=a||8,d=s||1,p=[],f=[];for(c=0;c<=d;c++){var m=[],g=[],v=c/d,S=v*(i-t)+t;for(l=0;l<=u;l++){var _=l/u,y=new e.Vector3;y.x=S*Math.sin(_*Math.PI*2),y.y=-v*n+h,y.z=S*Math.cos(_*Math.PI*2),this.vertices.push(y),m.push(this.vertices.length-1),g.push(new e.Vector2(_,1-v))}p.push(m),f.push(g)}var x,M,P=(i-t)/n;for(l=0;l<u;l++)for(0!==t?(x=this.vertices[p[0][l]].clone(),M=this.vertices[p[0][l+1]].clone()):(x=this.vertices[p[1][l]].clone(),M=this.vertices[p[1][l+1]].clone()),x.setY(Math.sqrt(x.x*x.x+x.z*x.z)*P).normalize(),M.setY(Math.sqrt(M.x*M.x+M.z*M.z)*P).normalize(),c=0;c<d;c++){var C=p[c][l],b=p[c+1][l],D=p[c+1][l+1],w=p[c][l+1],E=x.clone(),T=x.clone(),A=M.clone(),I=M.clone(),R=f[c][l].clone(),L=f[c+1][l].clone(),O=f[c+1][l+1].clone(),N=f[c][l+1].clone();this.faces.push(new e.Face4(C,b,D,w,[E,T,A,I])),this.faceVertexUvs[0].push([R,L,O,N])}if(!o&&t>0)for(this.vertices.push(new e.Vector3(0,h,0)),l=0;l<u;l++){C=p[0][l],b=p[0][l+1],D=this.vertices.length-1,E=new e.Vector3(0,1,0),T=new e.Vector3(0,1,0),A=new e.Vector3(0,1,0),R=f[0][l].clone(),L=f[0][l+1].clone(),O=new e.Vector2(L.u,0);this.faces.push(new e.Face3(C,b,D,[E,T,A])),this.faceVertexUvs[0].push([R,L,O])}if(!o&&i>0)for(this.vertices.push(new e.Vector3(0,-h,0)),l=0;l<u;l++){C=p[c][l+1],b=p[c][l],D=this.vertices.length-1,E=new e.Vector3(0,-1,0),T=new e.Vector3(0,-1,0),A=new e.Vector3(0,-1,0),R=f[c][l+1].clone(),L=f[c][l].clone(),O=new e.Vector2(L.u,1);this.faces.push(new e.Face3(C,b,D,[E,T,A])),this.faceVertexUvs[0].push([R,L,O])}this.computeCentroids(),this.computeFaceNormals()},r.CylinderGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.ExtrudeGeometry=function(e,t){void 0!==e?(r.LegacyGeometry.call(this),e=e instanceof Array?e:[e],this.shapebb=e[e.length-1].getBoundingBox(),this.addShapeList(e,t),this.computeCentroids(),this.computeFaceNormals()):e=[]},r.ExtrudeGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.ExtrudeGeometry.prototype.addShapeList=function(e,t){for(var i=e.length,r=0;r<i;r++){var n=e[r];this.addShape(n,t)}},r.ExtrudeGeometry.prototype.addShape=function(t,i){var n,a,s,o,l,c,h,u,d=void 0!==i.amount?i.amount:100,p=void 0!==i.bevelThickness?i.bevelThickness:6,f=void 0!==i.bevelSize?i.bevelSize:p-2,m=void 0!==i.bevelSegments?i.bevelSegments:3,g=void 0===i.bevelEnabled||i.bevelEnabled,v=void 0!==i.curveSegments?i.curveSegments:12,S=void 0!==i.steps?i.steps:1,_=i.extrudePath,y=!1,x=i.material,M=i.extrudeMaterial,P=void 0!==i.UVGenerator?i.UVGenerator:r.ExtrudeGeometry.WorldUVGenerator;this.shapebb;_&&(n=_.getSpacedPoints(S),y=!0,g=!1,a=void 0!==i.frames?i.frames:new e.TubeGeometry.FrenetFrames(_,S,!1),s=new e.Vector3,o=new e.Vector3,l=new e.Vector3),g||(m=0,p=0,f=0);var C=this,b=this.vertices.length,D=t.extractPoints(v),w=D.shape,E=D.holes,T=!e.Shape.Utils.isClockWise(w);if(T){for(w=w.reverse(),h=0,u=E.length;h<u;h++)c=E[h],e.Shape.Utils.isClockWise(c)&&(E[h]=c.reverse());T=!1}var A=e.Shape.Utils.triangulateShape(w,E),I=w;for(h=0,u=E.length;h<u;h++)c=E[h],w=w.concat(c);function R(e,t,i){return t||console.log("die"),t.clone().multiplyScalar(i).add(e)}var L,O,N,F,V,U,B=w.length,k=A.length;I.length,Math.PI;function G(t,i,n){return function(t,i,n){var a,s,o,l,c,h=r.ExtrudeGeometry.__v1,u=r.ExtrudeGeometry.__v2,d=r.ExtrudeGeometry.__v3,p=r.ExtrudeGeometry.__v4,f=r.ExtrudeGeometry.__v5,m=r.ExtrudeGeometry.__v6;if(h.set(t.x-i.x,t.y-i.y),u.set(t.x-n.x,t.y-n.y),a=h.normalize(),s=u.normalize(),d.set(-a.y,a.x),p.set(s.y,-s.x),f.copy(t).add(d),m.copy(t).add(p),f.equals(m))return p.clone();f.copy(i).add(d),m.copy(n).add(p),o=a.dot(p),l=m.sub(f).dot(p),0===o&&(console.log("Either infinite or no solutions!"),0===l?console.log("Its finite solutions."):console.log("Too bad, no solutions."));if((c=l/o)<0)return function(t,i,r){var n=Math.atan2(i.y-t.y,i.x-t.x),a=Math.atan2(r.y-t.y,r.x-t.x);n>a&&(a+=2*Math.PI);var s=(n+a)/2,o=-Math.cos(s),l=-Math.sin(s);return new e.Vector2(o,l)}(t,i,n);return a.multiplyScalar(c).add(f).sub(t).clone()}(t,i,n)}for(var z=[],H=0,W=I.length,j=W-1,X=H+1;H<W;H++,j++,X++){j===W&&(j=0),X===W&&(X=0);I[H],I[j],I[X];z[H]=G(I[H],I[j],I[X])}var q,Z,Y=[],K=z.concat();for(h=0,u=E.length;h<u;h++){for(c=E[h],q=[],H=0,j=(W=c.length)-1,X=H+1;H<W;H++,j++,X++)j===W&&(j=0),X===W&&(X=0),q[H]=G(c[H],c[j],c[X]);Y.push(q),K=K.concat(q)}for(L=0;L<m;L++){for(F=p*(1-(N=L/m)),O=f*Math.sin(N*Math.PI/2),H=0,W=I.length;H<W;H++)Q((V=R(I[H],z[H],O)).x,V.y,-F);for(h=0,u=E.length;h<u;h++)for(c=E[h],q=Y[h],H=0,W=c.length;H<W;H++)Q((V=R(c[H],q[H],O)).x,V.y,-F)}for(O=f,H=0;H<B;H++)V=g?R(w[H],K[H],O):w[H],y?(o.copy(a.normals[0]).multiplyScalar(V.x),s.copy(a.binormals[0]).multiplyScalar(V.y),l.copy(n[0]).add(o).add(s),Q(l.x,l.y,l.z)):Q(V.x,V.y,0);for(Z=1;Z<=S;Z++)for(H=0;H<B;H++)V=g?R(w[H],K[H],O):w[H],y?(o.copy(a.normals[Z]).multiplyScalar(V.x),s.copy(a.binormals[Z]).multiplyScalar(V.y),l.copy(n[Z]).add(o).add(s),Q(l.x,l.y,l.z)):Q(V.x,V.y,d/S*Z);for(L=m-1;L>=0;L--){for(F=p*(1-(N=L/m)),O=f*Math.sin(N*Math.PI/2),H=0,W=I.length;H<W;H++)Q((V=R(I[H],z[H],O)).x,V.y,d+F);for(h=0,u=E.length;h<u;h++)for(c=E[h],q=Y[h],H=0,W=c.length;H<W;H++)V=R(c[H],q[H],O),y?Q(V.x,V.y+n[S-1].y,n[S-1].x+F):Q(V.x,V.y,d+F)}function J(e,t){var i,r;for(H=e.length;--H>=0;){i=H,(r=H-1)<0&&(r=e.length-1);var n=0,a=S+2*m;for(n=0;n<a;n++){var s=B*n,o=B*(n+1);ee(t+i+s,t+r+s,t+r+o,t+i+o,e,n,a,i,r)}}}function Q(t,i,r){C.vertices.push(new e.Vector3(t,i,r))}function $(r,n,a,s){r+=b,n+=b,a+=b,C.faces.push(new e.Face3(r,n,a,null,null,x));var o=s?P.generateBottomUV(C,t,i,r,n,a):P.generateTopUV(C,t,i,r,n,a);C.faceVertexUvs[0].push(o)}function ee(r,n,a,s,o,l,c,h,u){r+=b,n+=b,a+=b,s+=b,C.faces.push(new e.Face4(r,n,a,s,null,null,M));var d=P.generateSideWallUV(C,t,o,i,r,n,a,s,l,c,h,u);C.faceVertexUvs[0].push(d)}!function(){if(g){var e=0,t=B*e;for(H=0;H<k;H++)$((U=A[H])[2]+t,U[1]+t,U[0]+t,!0);for(t=B*(e=S+2*m),H=0;H<k;H++)$((U=A[H])[0]+t,U[1]+t,U[2]+t,!1)}else{for(H=0;H<k;H++)$((U=A[H])[2],U[1],U[0],!0);for(H=0;H<k;H++)$((U=A[H])[0]+B*S,U[1]+B*S,U[2]+B*S,!1)}}(),function(){var e=0;for(J(I,e),e+=I.length,h=0,u=E.length;h<u;h++)J(c=E[h],e),e+=c.length}()},r.ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(t,i,r,n,a,s){var o=t.vertices[n].x,l=t.vertices[n].y,c=t.vertices[a].x,h=t.vertices[a].y,u=t.vertices[s].x,d=t.vertices[s].y;return[new e.Vector2(o,l),new e.Vector2(c,h),new e.Vector2(u,d)]},generateBottomUV:function(e,t,i,r,n,a){return this.generateTopUV(e,t,i,r,n,a)},generateSideWallUV:function(t,i,r,n,a,s,o,l,c,h,u,d){var p=t.vertices[a].x,f=t.vertices[a].y,m=t.vertices[a].z,g=t.vertices[s].x,v=t.vertices[s].y,S=t.vertices[s].z,_=t.vertices[o].x,y=t.vertices[o].y,x=t.vertices[o].z,M=t.vertices[l].x,P=t.vertices[l].y,C=t.vertices[l].z;return Math.abs(f-v)<.01?[new e.Vector2(p,1-m),new e.Vector2(g,1-S),new e.Vector2(_,1-x),new e.Vector2(M,1-C)]:[new e.Vector2(f,1-m),new e.Vector2(v,1-S),new e.Vector2(y,1-x),new e.Vector2(P,1-C)]}},r.ExtrudeGeometry.__v1=new e.Vector2,r.ExtrudeGeometry.__v2=new e.Vector2,r.ExtrudeGeometry.__v3=new e.Vector2,r.ExtrudeGeometry.__v4=new e.Vector2,r.ExtrudeGeometry.__v5=new e.Vector2,r.ExtrudeGeometry.__v6=new e.Vector2,r.ShapeGeometry=function(e,t){r.LegacyGeometry.call(this),e instanceof Array==!1&&(e=[e]),this.shapebb=e[e.length-1].getBoundingBox(),this.addShapeList(e,t),this.computeCentroids(),this.computeFaceNormals()},r.ShapeGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.ShapeGeometry.prototype.addShapeList=function(e,t){for(var i=0,r=e.length;i<r;i++)this.addShape(e[i],t);return this},r.ShapeGeometry.prototype.addShape=function(t,i){void 0===i&&(i={});var n,a,s,o=void 0!==i.curveSegments?i.curveSegments:12,l=i.material,c=void 0===i.UVGenerator?r.ExtrudeGeometry.WorldUVGenerator:i.UVGenerator,h=(this.shapebb,this.vertices.length),u=t.extractPoints(o),d=u.shape,p=u.holes,f=!e.Shape.Utils.isClockWise(d);if(f){for(d=d.reverse(),n=0,a=p.length;n<a;n++)s=p[n],e.Shape.Utils.isClockWise(s)&&(p[n]=s.reverse());f=!1}var m=e.Shape.Utils.triangulateShape(d,p),g=d;for(n=0,a=p.length;n<a;n++)s=p[n],d=d.concat(s);var v,S,_=d.length,y=m.length;g.length;for(n=0;n<_;n++)v=d[n],this.vertices.push(new e.Vector3(v.x,v.y,0));for(n=0;n<y;n++){var x=(S=m[n])[0]+h,M=S[1]+h,P=S[2]+h;this.faces.push(new e.Face3(x,M,P,null,null,l)),this.faceVertexUvs[0].push(c.generateBottomUV(this,t,i,x,M,P))}},r.PlaneGeometry=function(t,i,n,a){var s,o;r.LegacyGeometry.call(this),this.width=t,this.height=i,this.widthSegments=n||1,this.heightSegments=a||1;var l=t/2,c=i/2,h=this.widthSegments,u=this.heightSegments,d=h+1,p=u+1,f=this.width/h,m=this.height/u,g=new e.Vector3(0,0,1);for(o=0;o<p;o++)for(s=0;s<d;s++){var v=s*f-l,S=o*m-c;this.vertices.push(new e.Vector3(v,-S,0))}for(o=0;o<u;o++)for(s=0;s<h;s++){var _=s+d*o,y=s+d*(o+1),x=s+1+d*(o+1),M=s+1+d*o,P=new e.Face4(_,y,x,M);P.normal.copy(g),P.vertexNormals.push(g.clone(),g.clone(),g.clone(),g.clone()),this.faces.push(P),this.faceVertexUvs[0].push([new e.Vector2(s/h,1-o/u),new e.Vector2(s/h,1-(o+1)/u),new e.Vector2((s+1)/h,1-(o+1)/u),new e.Vector2((s+1)/h,1-o/u)])}this.computeCentroids()},r.PlaneGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.SphereGeometry=function(t,i,n,a,s,o,l){r.LegacyGeometry.call(this),this.radius=t||50,this.widthSegments=Math.max(3,Math.floor(i)||8),this.heightSegments=Math.max(2,Math.floor(n)||6),a=void 0!==a?a:0,s=void 0!==s?s:2*Math.PI,o=void 0!==o?o:0,l=void 0!==l?l:Math.PI;var c,h,u=[],d=[];for(h=0;h<=this.heightSegments;h++){var p=[],f=[];for(c=0;c<=this.widthSegments;c++){var m=c/this.widthSegments,g=h/this.heightSegments,v=new e.Vector3;v.x=-this.radius*Math.cos(a+m*s)*Math.sin(o+g*l),v.y=this.radius*Math.cos(o+g*l),v.z=this.radius*Math.sin(a+m*s)*Math.sin(o+g*l),this.vertices.push(v),p.push(this.vertices.length-1),f.push(new e.Vector2(m,1-g))}u.push(p),d.push(f)}for(h=0;h<this.heightSegments;h++)for(c=0;c<this.widthSegments;c++){var S=u[h][c+1],_=u[h][c],y=u[h+1][c],x=u[h+1][c+1],M=this.vertices[S].clone().normalize(),P=this.vertices[_].clone().normalize(),C=this.vertices[y].clone().normalize(),b=this.vertices[x].clone().normalize(),D=d[h][c+1].clone(),w=d[h][c].clone(),E=d[h+1][c].clone(),T=d[h+1][c+1].clone();Math.abs(this.vertices[S].y)===this.radius?(this.faces.push(new e.Face3(S,y,x,[M,C,b])),this.faceVertexUvs[0].push([D,E,T])):Math.abs(this.vertices[y].y)===this.radius?(this.faces.push(new e.Face3(S,_,y,[M,P,C])),this.faceVertexUvs[0].push([D,w,E])):(this.faces.push(new e.Face4(S,_,y,x,[M,P,C,b])),this.faceVertexUvs[0].push([D,w,E,T]))}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new e.Sphere(new e.Vector3,t)},r.SphereGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.TextGeometry=function(t,i){var n=e.FontUtils.generateShapes(t,i);i.amount=void 0!==i.height?i.height:50,void 0===i.bevelThickness&&(i.bevelThickness=10),void 0===i.bevelSize&&(i.bevelSize=8),void 0===i.bevelEnabled&&(i.bevelEnabled=!1),r.ExtrudeGeometry.call(this,n,i)},r.TextGeometry.prototype=Object.create(r.ExtrudeGeometry.prototype),r}),define("DS/VisuUnstreamers/BufferStreamObject",["UWA/Class","DS/VisuUnstreamers/StreamObject"],function(e,t){"use strict";var i=t.extend({init:function(e,t){return this._parent(e,t),this},open:function(){},close:function(){},readAsArrayBuffer:function(e){var t,i=new FileReader;i.onload=function(){t=this.result,e&&e(t)},i.readAsArrayBuffer(this.blob)}});return UWA.namespace("THREEDS/BufferStreamObject",i)}),define("VisuUnstreamers/BufferStreamObject",["DS/VisuUnstreamers/BufferStreamObject","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuUnstreamers/BufferStreamObject"),e}),define("DS/Materials/LineDSMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData","DS/Materials/DeferredCaches"],function(e,t,i,r){"use strict";var n=function(i){if(t.call(this),this.color=new e.Color(16777215),this.scale=6.66666,this.dashSize=0,this.gapSize=0,this.dashPattern=new Float32Array(2),this.dashType="None",this.patternOffset=0,this.linecap="square",this.linejoin="miter",this.lineWidth=1,this.pixelSize=new e.Vector2(.001,.001),this.side=e.Constants.DoubleSide,this.setValues(i),this._invertedPattern=i&&!!i.invertedPattern,"None"!==this.dashType&&(this.dashSize=this.gapSize=-1,this._setDashPatternType()),(this.dashSize>0&&this.gapSize>0||this.dashPattern[0]>1e-6)&&(this.isDashedLine=!0,this.dashSize>0&&this.gapSize>0&&(console.error("DEPRECATED: Usage of dashSize and gapSize is deprecated, use dashPattern instead."),this.dashPattern[0]=this.dashSize,this.dashPattern[1]=this.gapSize,this.dashSize=-1,this.gapSize=-1),this.dashPattern[0]>1e-6))for(var r=1;r<this.dashPattern.length;r++)this.dashPattern[r]+=this.dashPattern[r-1];this.isDashedLine&&"None"===this.dashType&&(this.dashType="Custom")};return(n.prototype=Object.create(t.prototype)).clone=function(e){return void 0===e&&(e=new n),t.prototype.clone.call(this,e),e.color.copy(this.color),e.scale=this.scale,e.dashPattern=new Float32Array(this.dashPattern),e.dashType=this.dashType,e.patternOffset=this.patternOffset,e.lineWidth=this.lineWidth,e.linecap=this.linecap,e.linejoin=this.linejoin,e.pixelSize=this.pixelSize,e.side=this.side,e._invertedPattern=this._invertedPattern,e},n.prototype._dump=function(){var e=t.prototype._dump.call(this);return e.color=this.color.toArray(),e.dashPattern=Array.from(this.dashPattern),e.lineWidth=this.lineWidth,e},n.prototype._canUseLights=function(){return!1},n.prototype._setMaterialShaderOptions=function(e,i,r,n,a,s){t.prototype._setMaterialShaderOptions.call(this,e,i,r,n,a,s);var o={};s||Object.assign(o,{dashedLine:this.isDashedLine,patternSize:this.isDashedLine&&this.dashPattern?this.dashPattern.length:0,invertedPattern:this._invertedPattern}),Object.assign(o,{wideLine:this.isWideLine||this.is2DLine,linejoin:this.linejoin,linecap:this.linecap}),Object.assign(e,o)},n.prototype.setPatternOffset=function(e){this.patternOffset=e,this.isDashedLine&&(this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())},n.prototype.setScale=function(e){this.scale=e,this.isDashedLine&&(this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())},n.prototype.setDashPatternArray=function(e){e&&0!==e.length||(e=[0,0]),this.dashPattern=new Float32Array(e),this.dashType="Custom";for(var t=1;t<this.dashPattern.length;t++)this.dashPattern[t]+=this.dashPattern[t-1];this.isDashedLine=this.dashPattern[0]>0,this.needsUpdate=!0,this._invalidateDisplayRangeLists(),this.updateDeferredMaterials()},n.prototype._setDashPatternType=function(){switch(this._invertedPattern=!1,this.dashType){case 1:this.dashType="Solid";case"Solid":this.dashPattern[0]=-1;break;case 2:this.dashType="Dotted";case"Dotted":this.dashPattern=new Float32Array(2),this.dashPattern[0]=2,this.dashPattern[1]=2;break;case 3:this.dashType="Dashed";case"Dashed":this.dashPattern=new Float32Array(2),this.dashPattern[0]=3,this.dashPattern[1]=1;break;case 4:this.dashType="Dot-Dashed";case"Dot-Dashed":this.dashPattern=new Float32Array(4),this.dashPattern[0]=3,this.dashPattern[1]=2,this.dashPattern[2]=1,this.dashPattern[3]=2;break;case 5:this.dashType="Phantom";case"Phantom":this.dashPattern=new Float32Array(6),this.dashPattern[0]=6,this.dashPattern[1]=2,this.dashPattern[2]=2,this.dashPattern[3]=2,this.dashPattern[4]=2,this.dashPattern[5]=2;break;case 6:this.dashType="Small-Dotted";case"Small-Dotted":this.dashPattern=new Float32Array(2),this.dashPattern[0]=1,this.dashPattern[1]=1,this._invertedPattern=!0;break;case 7:this.dashType="JIS Axis";case"JIS Axis":this.dashPattern=new Float32Array(4),this.dashPattern[0]=2,this.dashPattern[1]=1,this.dashPattern[2]=12,this.dashPattern[3]=1;break;default:this.dashType="None",this.dashPattern[0]=-1}},n.prototype.setDashPatternType=function(e){this.dashType=e,this._setDashPatternType();for(var t=1;t<this.dashPattern.length;t++)this.dashPattern[t]+=this.dashPattern[t-1];this.isDashedLine=this.dashPattern[0]>0,this.needsUpdate=!0,this._invalidateDisplayRangeLists(),this.updateDeferredMaterials()},n.prototype.activatePDSFX=function(e){e=e||{},this._PDSFXData=new i,this._PDSFXData.PDSFX=!0,this._setDefaultPDSFXOverridableFunctions(),this._PDSFXData.PDSFX_hasAlbedo=!0,this._PDSFXData.PDSFX_hasHalfWidth=!0,this._PDSFXData.PDSFX_hasOpacity=!0},n.prototype.loadUniforms=function(e,t,i,r,n,a){e.loadGASUniforms(t,this,i,r,null),i.pixelSize&&t.uniform2f(i.pixelSize,this.pixelSize.x,this.pixelSize.y),this.isDashedLine&&(i.dashPattern&&t.uniform1fv(i.dashPattern,this.dashPattern),i.totalSize&&t.uniform1f(i.totalSize,this.dashPattern[this.dashPattern.length-1]),i.patternOffset&&t.uniform1f(i.patternOffset,this.patternOffset))},n.prototype.getPredefinedMaterial=function(t,i,n){var a=this.getBaseId();switch(a+="Line",a+="S"+this.side,a+="CP"+this.enableClipPlanes,a+="Type"+i,i){case e.DefaultAppearanceMode.__QA_AUTOMATION__:if(a+="Col"+this.color.getHex(),a="id"+(a+="Op"+this._opacity).hashCode(),!r.PredefinedMaterials.has(a)){var s=new e.LineBasicMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:this.color,opacity:this._opacity});s.activatePDSFX();var o={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor.rgb = ComputeAlbedo();","ioFinalColor.a = ComputeOpacity();","#ifdef GAMMA_OUTPUT","ioFinalColor.rgb = sqrt(ioFinalColor.rgb);","#endif","}"].join("\n")};s.setPDSFXOverridableFunctions({},o);var l=new r.DeferredMaterial(s);r.PredefinedMaterials.set(a,l)}break;default:return this}return r.PredefinedMaterials.get(a).get(this)},n.prototype.getZOnlyMaterial=function(){return this},n.prototype._defaultPDSFXOverridableFunctions=function(){var i=t.prototype._defaultPDSFXOverridableFunctions.call(this);return Object.assign(i.vertex,{ComputeObjectFollowingPosition:e.ShaderChunk.PDSFXComputeObjectFollowingPosition_VS,ComputeObjectPreviousPosition:e.ShaderChunk.PDSFXComputeObjectPreviousPosition_VS,ProcessLineDistance:e.ShaderChunk.PDSFXProcessLineDistance_VS,ComputeHalfWidth:e.ShaderChunk.PDSFXComputeHalfWidth_VS}),Object.assign(i.fragment,{ComputeHalfWidth:e.ShaderChunk.PDSFXComputeHalfWidth_FS,ProcessLinePattern:e.ShaderChunk.PDSFXProcessLinePattern_FS}),i},n.prototype._getBodyEdgeMaterial=function(){return this},n.prototype.updateDeferredMaterials=function(i){t.prototype.updateDeferredMaterials.call(this,i),this._deferredMaterials[e.MaterialToUse.shadowMapDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalDepthIoRRoughnessMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.texCoordMaterial]=null},n.prototype.targetPrimitiveType="LINES",n.prototype.useClippingTolerance=!0,n.prototype.__dimension=1,n}),define("DS/Materials/MeshLambertMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData"],function(e,t,i){"use strict";var r=new e.Color,n=function(i){t.call(this),this.color=new e.Color(16777215),this.ambient=new e.Color(16777215),this.emissive=new e.Color(0),this.wrapAround=!1,this.wrapRGB=new e.Vector3(1,1,1),this.map=null,this.specularMap=null,this.envMap=null,this.combine=e.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.shading=e.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.morphTargets=!1,this.morphNormals=!1,this.lights=!0,this.numSupportedMorphTargets=0,this.numSupportedMorphNormals=0,this._usePhongLighting=!0,this.setValues(i)};return(n.prototype=Object.create(t.prototype))._getTextures=function(e){var i=t.prototype._getTextures.call(this,e);return i=i.concat([this.map,this.specularMap])},n.prototype._dump=function(){var e=t.prototype._dump.call(this);return e.color=this.color.toArray(),this.map&&(e.color="textured"),e},n.prototype._shaderID="lambert",n.prototype._transparencyOnGPU=function(e){return t.prototype._transparencyOnGPU.call(this,e)||this.map&&this.transparent},n.prototype.getType=function(){return"Lambert"},n.prototype.areTexturesLoaded=function(){return!!t.prototype.areTexturesLoaded.call(this)&&(!this.envMap||this.envMap.loadEndStatus!==e.AssetLoadingStatus.LOADING)},n.prototype.clone=function(){var e=new n;return t.prototype.clone.call(this,e),e.color.copy(this.color),e.ambient.copy(this.ambient),e.emissive.copy(this.emissive),e.wrapAround=this.wrapAround,e.wrapRGB.copy(this.wrapRGB),e.map=this.map,e.specularMap=this.specularMap,e.envMap=this.envMap,e.combine=this.combine,e.reflectivity=this.reflectivity,e.refractionRatio=this.refractionRatio,e.shading=this.shading,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.wireframeLinecap=this.wireframeLinecap,e.wireframeLinejoin=this.wireframeLinejoin,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e.numSupportedMorphTargets=this.numSupportedMorphTargets,e.numSupportedMorphNormals=this.numSupportedMorphNormals,e},n.prototype._autoForceSide=!0,n.prototype.activatePDSFX=function(e){e=e||{},this._PDSFXData=new i,this._PDSFXData.PDSFX=!0,this._setDefaultPDSFXOverridableFunctions(),this._PDSFXData.PDSFX_hasOpacity=!0},n.prototype.loadUniforms=function(e,t,i,n,a,s){var o;i.ambient&&(o=e.gammaInput?r.copyToLinear(this.ambient,e.simpleGamma):this.ambient,t.uniform3f(i.ambient,o.r,o.g,o.b)),i.emissive&&(o=e.gammaInput?r.copyToLinear(this.emissive,e.simpleGamma):this.emissive,t.uniform3f(i.emissive,o.r,o.g,o.b)),i.wrapRGB&&this.wrapAround&&t.uniform3f(i.wrapRGB,this.wrapRGB.x,this.wrapRGB.y,this.wrapRGB.z),e.loadUniformsCommon(t,this,i,n,a,s)},n}),define("DS/MaterialLibs/MeshLambertLib",["DS/Mesh/ThreeJS_Base","DS/MaterialLibs/UniformsLib","DS/Shaders/DefaultShaders","DS/Shaders/DeferrableShaders","DS/Visualization/ShaderChunk","DS/Visualization/UniformsUtils","DS/Materials/MeshLambertMaterial"],function(e,t,i,r,n,a,s){"use strict";var o=s.prototype.deferrable,l="",c="",h="",u="";return o&&(l=[r.depth_pars_vertex,r.picking_pars_vertex,r.picking_instancing_pars_vertex,r.highlight_pars_vertex,r.texcoord_pars_vertex].join("\n"),h=[r.depth_vertex,r.picking_vertex,r.picking_instancing_vertex,r.highlight_vertex,r.texcoord_vertex].join("\n"),c=[r.picking_pars_fragment,r.picking_instancing_pars_fragment,r.depth_pars_fragment,r.decal_normal_depth_pars_fragment,r.shadowmap_pars_fragment,r.highlight_pars_fragment,r.texcoord_pars_fragment].join("\n"),u=[r.picking_fragment,r.picking_instancing_fragment,r.depth_fragment_face,r.normal_fragment,r.normal_depth_fragment,r.shadowmap_fragment,r.highlight_fragment_face,r.texcoord_fragment].join("\n")),{uniforms:a.merge([t.common,t.lights,t.shadowmap,t.clipPlanes,{ambient:{type:"c",value:new e.Color(16777215)},emissive:{type:"c",value:new e.Color(0)},wrapRGB:{type:"v3",value:new e.Vector3(1,1,1)}},t.postprocess,o?t.deferred:{}]),vertexShader:["#define LAMBERT","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",i.normal_viewposition_pars_vertex,n.clip_pars_vertex,n.map_pars_vertex,n.envmap_pars_vertex,n.lights_lambert_pars_vertex,n.color_pars_vertex,n.morphtarget_pars_vertex,n.skinning_pars_vertex,n.shadowmap_pars_vertex,n.fog_pars_vertex,r.oit_pars_vertex,l,"void main() {",n.PDSFX_start_vertex,n.map_vertex,n.color_vertex,n.morphnormal_vertex,n.skinbase_vertex,n.skinnormal_vertex,n.morphtarget_vertex,n.skinning_vertex,n.default_vertex_with_normal,n.defaultnormal_vertex,n.clip_vertex,n.fog_vertex,i.normal_viewposition_vertex,n.worldpos_vertex,n.envmap_vertex,n.lights_lambert_vertex,n.shadowmap_vertex,r.oit_vertex,h,n.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:["#define LAMBERT","uniform float opacity;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif","#if defined( NEEDS_UVTOUSE )","vec2 uvToUse;","#endif",i.normal_viewposition_pars_fragment,n.clip_pars_fragment,n.color_pars_fragment,n.map_pars_fragment,n.envmap_pars_fragment,n.shadowmap_pars_fragment,n.specularmap_pars_fragment,n.fog_pars_fragment,r.oit_pars_fragment,c,n.postprocess_pars_fragment,"void main() {","#ifdef PDSFX","ComputeCommonValues();",n.PDSFX_viewNormal_fragment,"vViewPosition = -ComputeViewPosition();","#endif",i.normal_viewposition_fragment,"#if defined(SELECTION_MATERIAL)","gl_FragColor = vec4( vec3(1.0), 1.0 );","#else","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );","#endif","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","uvToUse=vUv;","#endif",n.clip_fragment,n.uvmapping_fragment,n.map_fragment,n.alphatest_fragment,n.specularmap_fragment,"#ifdef DOUBLE_SIDED","if ( gl_FrontFacing )","gl_FragColor.xyz *= vLightFront;","else","gl_FragColor.xyz *= vLightBack;","#else","gl_FragColor.xyz *= vLightFront;","#endif",n.color_fragment,n.envmap_fragment,n.shadowmap_fragment,n.postprocess_fragment,n.linear_to_gamma_fragment,n.PDSFX_end_fragment,n.fog_fragment,n.backgroundviewmode_lowlight_fragment,r._debug_common_face_fragment,r.oit_fragment,u,"}"].join("\n")}}),define("DS/Materials/LineBasicMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/LineDSMaterial","DS/Materials/DeferredCaches","DS/Mesh/Mesh"],function(e,t,i,r){"use strict";const n={createDiskXY:function(t,i=.5){const n=new Uint16Array(3*t),a=new Float32Array(3*(t+1));a[0]=0,a[1]=0,a[2]=i;for(let e=0;e<t;e++){let r=2*Math.PI*e/t;a[3*(e+1)+0]=Math.cos(r),a[3*(e+1)+1]=Math.sin(r),a[3*(e+1)+2]=i,n[3*e+0]=0,n[3*e+1]=e+1,n[3*e+2]=e+1==t?1:e+2}let s=new e.BufferGeometryDS;s.vertexIndexArray=n,s.vertexPositionArray=a;const o=new r.DrawingGroup(null,null,4,0,n.length);return o.geometry=s,s.drawingGroups=[o],s},homogeneousDistance:function(e,t){const i=e.x/e.w-t.x/t.w,r=e.y/e.w-t.y/t.w,n=e.z/e.w-t.z/t.w;return Math.sqrt(i*i+r*r+n*n)},screenDistance:function(t,i,r=NaN){function n(e,t){const i=e.x/e.w-t.x/t.w,r=e.y/e.w-t.y/t.w;return Math.sqrt(i*i+r*r)}const a=Math.abs(t.z)>Math.abs(t.w),s=Math.abs(i.z)>Math.abs(i.w);if(!a&&!s)return n(t,i);if(a&&s)return r;const o=-(t.w+t.z)/(i.z-t.z+(i.w-t.w)),l=new e.Vector4(t.x+o*(i.x-t.x),t.y+o*(i.y-t.y),t.z+o*(i.z-t.z),t.w+o*(i.w-t.w));return a?n(l,i):n(t,l)}},a=function({points_flattened:t,is_triangle_mesh:i}){const r=t.length/3,n={lineNumPoints:{type:"i",value:r},linePoints:{type:"fv3",value:t,length:r},lineScreenDists:{type:"fv1",value:Array(r).fill(0),length:r},lineShapeColor:{type:"v3",value:new e.Vector3(1,1,1)},lineScreenSpace:{type:"b",value:!0},lineShapeThickness:{type:"f",value:1},lineCurvilinearScale:{type:"f",value:1},lineShapeTransform:{type:"m4",value:new e.Matrix4}},a=["mat4 transpose(mat4 m)","{","mat4 n;","n[0] = vec4(m[0][0], m[1][0], m[2][0], m[3][0]);","n[1] = vec4(m[0][1], m[1][1], m[2][1], m[3][1]);","n[2] = vec4(m[0][2], m[1][2], m[2][2], m[3][2]);","n[3] = vec4(m[0][3], m[1][3], m[2][3], m[3][3]);","return n;","}","mat4 GetClip2Screen()","{","vec2 v = vec2(vGetViewportSize()) / 2.0;","return mat4(","\tv.x, 0.0, 0.0, 0.0,","\t0.0, v.y, 0.0, 0.0,","\t0.0, 0.0, 1.0, 0.0,","\tv.x, v.y, 0.0, 1.0",");","}","mat4 GetScreen2Clip()","{","vec2 v = vec2(vGetViewportSize()) / 2.0;","return mat4(","\t1.0/v.x,     0.0, 0.0, 0.0,","\t    0.0, 1.0/v.y, 0.0, 0.0,","\t    0.0,     0.0, 1.0, 0.0,","\t   -1.0,    -1.0, 0.0, 1.0",");","}","int GetLinePtRangeBegin() { return int(lineShapeSegment.z); }","int GetLinePtRangeEnd()   { return int(lineShapeSegment.w); }","float GetLineMaxDistance() { return lineScreenDists[GetLinePtRangeEnd() - 1]; }","int GetLineSegment(float lx)","{","int begin = GetLinePtRangeBegin();","int end   = GetLinePtRangeEnd();","int i = begin + 1;","for(int _=0; _<64; _++)","{","if(i >= end) break;","if(lx <= lineScreenDists[i]) return i - 1;","i++;","}","return end - 2;","}","mat4 GetLineBase2Clip(float lx, vec4 Pi, vec4 Pj)","{","vec2 half_screen = vec2(vGetViewportSize()) / 2.0;","vec4 D = Pj - Pi;","D.xy *= half_screen;","float t = (lx - Pi.w) / D.w;","vec2 sXY = vec2(length(D.xy) / D.w) / half_screen;","float sZ = D.z / D.w;","mat4 frame;","frame[0] = vec4(sXY * normalize(vec2(D.x,  D.y)), sZ, 0.0);","frame[1] = vec4(sXY * normalize(vec2(-D.y, D.x)), 0.0, 0.0);","frame[2] = vec4(0.0);","frame[3] = vec4(Pi.xy + t * D.xy / half_screen, Pi.z + t * D.z, 1.0);","return frame;","}","mat4 GetLineBase2Model(float lx, vec4 Pi, vec4 Pj)","{","vec4 D = Pj - Pi;","vec3 N = normalize(cross(vec3(0.0, 0.0, 1.0), D.xyz));","if(dot(N, N) < 0.9) N = vec3(0.0, 1.0, 0.0);","float t = (lx - Pi.w) / D.w;","float len = length(D.xyz);","mat4 frame;","frame[0] = vec4(D.xyz / D.w, 0.0);","frame[1] = vec4(N * len / D.w, 0.0);","frame[2] = vec4(0.0);","frame[3] = vec4(Pi.xyz + t * D.xyz, 1.0);","return frame;","}","void GetLineEndpoints(int segment, out vec4 Pi, out vec4 Pj)","{","int i = segment, j = segment + 1;","Pi = vec4(linePoints[i].xyz, lineScreenDists[i]);","Pj = vec4(linePoints[j].xyz, lineScreenDists[j]);","}","bool ClipLineSegment(inout vec4 Pi, inout vec4 Pj, mat4 obj2clip)","{","vec4 Pi4 = obj2clip * vec4(Pi.xyz, 1.0);","vec4 Pj4 = obj2clip * vec4(Pj.xyz, 1.0);","float dist_i = Pi.w;","float dist_j = Pj.w;","bool clip_i = abs(Pi4.z) > abs(Pi4.w);","bool clip_j = abs(Pj4.z) > abs(Pj4.w);","if(clip_i && clip_j) return true;","if(clip_i != clip_j)","{","float t = -(Pi4.w + Pi4.z) / (Pj4.z - Pi4.z + (Pj4.w - Pi4.w));","vec4 Pclipped = Pi4 + t * (Pj4 - Pi4);","if(clip_i) Pi4 = Pclipped;","else       Pj4 = Pclipped;","float new_delta = length((Pj4.xy / Pj4.w - Pi4.xy / Pi4.w) * vec2(vGetViewportSize()) / 2.0) / lineCurvilinearScale;","if(clip_i) dist_i = dist_j - new_delta;","else       dist_j = dist_i + new_delta;","}","Pi = vec4(Pi4.xyz / Pi4.w, dist_i);","Pj = vec4(Pj4.xyz / Pj4.w, dist_j);","return false;","}","vec3 ComputeModelPosition(vec3 input_position, out vec3 curvilinear)","{","const int lineKeepShapeAspect = 1;","vec4 base = lineShapeTransform * vec4(input_position, 1.0);","base /= base.w;","float inst_cx = lineShapeSegment.x;","curvilinear = vec3(inst_cx + base.x * lineShapeSegment.y, base.y, GetLineMaxDistance());","float cx = inst_cx + base.z * lineShapeSegment.y;","base.x -= base.z;","vec4 Pi, Pj;","GetLineEndpoints(GetLineSegment(cx), Pi, Pj);","if(lineScreenSpace && ClipLineSegment(Pi, Pj, vGetProjectionMatrix() * vGetWorldViewMatrix()))","return vec3(0.0 / 0.0);","if(lineScreenSpace)","{","mat4 base2Clip = GetLineBase2Clip(cx, Pi, Pj);","base2Clip[0].xyz *= lineShapeSegment.y;","if(lineKeepShapeAspect != 0)","base2Clip[1].xyz *= lineShapeSegment.y;","else","base2Clip[1] = GetScreen2Clip() * normalize(GetClip2Screen() * base2Clip[1]) * lineShapeThickness;","vec4 clip = base2Clip * base;","mat4 clip2obj = transpose(vGetWorldViewInvTranspMatrix()) * vGetProjectionInvMatrix();","vec4 model = clip2obj * clip;","return model.xyz / model.w;","}","else","{","mat4 base2Model = GetLineBase2Model(cx, Pi, Pj);","base2Model[0].xyz *= lineShapeSegment.y;","base2Model[1].xyz *= lineShapeSegment.y;","vec4 model = base2Model * base;","return model.xyz / model.w;","}","}"].join("\n");let s=new(i?e.MeshBasicMaterial:e.LineBasicMaterial)({color:16777215,force:!0});return s.activatePDSFX(),s.setPDSFXUniforms(n),s.setPDSFXVaryings({curvilinear:{type:"v3"}}),s.setPDSFXGlobalShaderCode(a,""),s.setPDSFXOverridableFunctions({ComputeObjectPosition:"vec3 ComputeObjectPosition()                   {           return ComputeModelPosition(vGetAttribPosition(), curvilinear); }",ComputeObjectFollowingPosition:"vec3 ComputeObjectFollowingPosition() { vec3 tmp; return ComputeModelPosition(vGetAttribFollowingPosition(), tmp); }",ComputeObjectPreviousPosition:"vec3 ComputeObjectPreviousPosition()   { vec3 tmp; return ComputeModelPosition(vGetAttribPreviousPosition(), tmp); }"},{ComputeViewNormal:"vec3 ComputeViewNormal() { return vec3(0.0, 0.0, -1.0); }",ComputeAlbedo:"vec3 ComputeAlbedo() { return lineShapeColor * lineShapeColor; }",ComputeDiscard:"bool ComputeDiscard() { return curvilinear.x > curvilinear.z || curvilinear.x < 0.0; }"}),s.side=e.Constants.DoubleSide,s},s=function(t,i){void 0!==i.distances&&t.updatePDSFXUniform("lineScreenDists",i.distances),void 0!==i.color&&t.updatePDSFXUniform("lineShapeColor",new e.Vector3(i.color.r,i.color.g,i.color.b)),void 0!==i.thickness&&(t.updatePDSFXUniform("lineShapeThickness",i.thickness),t.setLineWidth&&t.setLineWidth(i.thickness)),void 0!==i.scale&&t.updatePDSFXUniform("lineCurvilinearScale",i.scale),void 0!==i.screenSpace&&t.updatePDSFXUniform("lineScreenSpace",i.screenSpace),void 0!==i.shapeTransform&&t.updatePDSFXUniform("lineShapeTransform",i.shapeTransform)},o={isValidPattern:e=>Array.isArray(e)||ArrayBuffer.isView(e),isDashPatternArray:e=>e.length>0&&"number"==typeof e[0],segmentIsDash:e=>e.length>0&&(void 0===e.shape||null===e.shape),segmentIsShape:e=>e.length>0&&void 0!==e.shape&&null!==e.shape,segmentIsPoint:e=>0===e.length,collapseSameSign:function(e){if(0===e.length)return e;let t=0;for(let i=1;i<e.length;i++){const r=e[i];Math.sign(e[t])*Math.sign(r)>-.5?e[t]+=r:++t!==i&&(e[t]=r)}return e.length=t+1,e},instantiatePatternPoints:function(e,t,i,r){let a=!1;for(let n=0;n<e.length;n++){let s=e[n];this.segmentIsPoint(s)&&(s.length=i/r,s.shape=t.length,a=!0)}return a&&t.push(n.createDiskXY(31).drawingGroups[0]),a},extractDashPattern:function(e){const t=this.collapseSameSign(e.map(e=>this.segmentIsShape(e)?-e.length:e.length));return Float32Array.from(t,Math.abs)},trimUnusedShapes:function(e,t){let i=new Set(e.filter(this.segmentIsShape).map(e=>e.shape));if(0===(i=[...i].sort((e,t)=>e-t)).length)return[];if(i[i.length-1]>=t.length)return console.error(`Complex line pattern requires shape nÂ°${i[i.length-1]}, but only ${t.length} were specified. No shapes will be used.`),[];for(let t=0;t<e.length;t++){let r=e[t];this.segmentIsShape(r)&&(r.shape=i.indexOf(r.shape))}return i.map(e=>t[e])},setSegmentTransforms4x4:function(t){for(let i=0;i<t.length;i++){const r=t[i];if(r.matrix)if(16!==r.matrix.elements.length){let t=r.matrix.elements;r.matrix=new e.Matrix4,r.matrix.elements=[t[0],t[1],0,t[2],t[3],t[4],0,t[5],0,0,1,0,t[6],t[7],0,t[8]]}else if(!(r.matrix instanceof e.Matrix4)){const t=r.matrix.elements;r.matrix=new e.Matrix4,r.matrix.elements=t}}},computeOffsetsAndStride:function(e){let t=0;for(let i=0;i<e.length;i++){let r=e[i];r.offset=t,t+=Math.abs(r.length)}return t},computeBaseTransform:function(t){const i=1/t.size().x,r=new e.Vector3(-i*t.min.x,-i*(t.min.y+t.max.y)/2,0);let n=(new e.Matrix4).makeScale(i,i,1);return n.setPosition(r),n},normalizeSegments:function(t,i){for(let r=0;r<t.length;r++){let n=t[r];if(!this.segmentIsShape(n))continue;const a=i[n.shape],s=a.start,o=a.start+a.count,l=new e.Box3,c=new e.Vector3;for(let e=s;e<o;e++)a.geometry.getVertexPosition(a.geometry.vertexIndexArray[e],c),l.expandByPoint(c);const h=this.computeBaseTransform(l);n.matrix?n.matrix.multiply(h):n.matrix=h}},deduplicatePoints:function(e){const t=e=>Math.round(2e5*e-.5)/2e5,i=e=>Math.round(2e5*e+.5)/2e5;const r=e.length/3;let n={},a=r>65535?new Uint32Array(r):new Uint16Array(r);for(let c=0;c<r;c++){const r=(s=e[3*c+0],o=e[3*c+1],l=e[3*c+2],[t(s)+";"+t(o)+";"+t(l),t(s)+";"+t(o)+";"+i(l),t(s)+";"+i(o)+";"+t(l),t(s)+";"+i(o)+";"+i(l),i(s)+";"+t(o)+";"+t(l),i(s)+";"+t(o)+";"+i(l),i(s)+";"+i(o)+";"+t(l),i(s)+";"+i(o)+";"+i(l)]);let h=void 0;for(let e=0;e<r.length&&void 0===h;e++)h=n[r[e]];if(void 0===h){h=c;for(let e=0;e<r.length;e++)n[r[e]]=c}a[c]=h}var s,o,l;return a},extractLineStrips:function(e,t,i){function r(e){const r=t[e];return i?i[r]:r}const n=e.length/3;let a=Array.from({length:n},()=>new Set),s=Array.from({length:n},()=>new Set);for(let e=0;e<t.length;e+=2){const t=r(e),i=r(e+1);s[t].add(i),a[i].add(t)}function o(e,t,i){const r=t[e].values().next().value;return void 0===r?r:(t[e].delete(r),i[r].delete(e),r)}let l=[];for(let e=0;e<n;e++){if(0===a[e].size&&0===s[e].size)continue;let t=[];function c(e,i,r){let n=e;for(;void 0!==n;)t.push(n),n=o(n,i,r)}c(e,a,s),t.reverse().pop(),c(e,s,a),l.push(t)}let h=[],u=[];for(let t=0;t<l.length;t++){const i=l[t];u.push(h.length/3);for(let t=0;t<i.length;t++){const r=i[t];h.push(e[3*r+0]),h.push(e[3*r+1]),h.push(e[3*r+2])}}return{points:new Float32Array(h),starts:h.length>65535?new Uint32Array(u):new Uint16Array(u)}},distanceAndSubStrips:function({scale:t,strips:i,pointTransform:r,distanceFunction:n,initial_dist:a=0}){let s=new e.Vector4,o=new e.Vector4;function l(e){s.copy(o),o.set(i.points[3*e+0],i.points[3*e+1],i.points[3*e+2],1).applyMatrix4(r)}const c=i.points.length/3,h=i.starts.length,u=a/t;let d=new Float32Array(c),p=[];for(let e=0;e<h;e++){const r=i.starts[e],a=e+1<h?i.starts[e+1]:c;l(r),d[r]=u,p.push(r);for(let e=r;e+1<a;e++){l(e+1);const i=n(s,o)/t;Number.isFinite(i)?d[e+1]=d[e]+i:(d[e+1]=u,p.push(e+1))}}return{distances:d,starts:p}},computeInstancePlacements:function({pattern:e,stride:t,scale:i,strips:r,pointTransform:n,distanceFunction:a,initial_dist:s=0,wholePatternsOnly:o=!1}){const l=this.distanceAndSubStrips({scale:i,strips:r,pointTransform:n,distanceFunction:a,initial_dist:s});let c=e.map(e=>Number.isInteger(e.shape)?{count:function(){return this.attrib.data.length/4},transform:e.matrix,attrib:{attribName:"lineShapeSegment",type:"v4",isFlattened:!0,data:[]}}:null);function h(i,r,n,a,s=0){if(i>r)return;const o=Math.floor(i/t),l=Math.ceil(r/t);for(let h=o;h<l;h++){const o=h*t;for(let t=0;t<e.length;t++){if(null===c[t])continue;const l=e[t],h=o+l.offset;h<i||h>=r||c[t].attrib.data.push(h+s,l.length,n,a)}}}function u(i,r,n){const a=t*Math.floor(i/t);for(let t=0;t<e.length;t++){if(null===c[t])continue;const s=e[t],o=a+s.offset,l=o+s.length;o>=i||l<=i||c[t].attrib.data.push(o,s.length,r,n)}}function d(e){for(let t=0;t<c.length;t++){if(null===c[t])continue;const i=c[t].count();if(i<1)continue;let r=c[t].attrib;const n=r.data[4*(i-1)+3];(n<0||n>e)&&(r.data[4*(i-1)+3]=e)}}const p=r.points.length/3,f=l.starts.length,m=l.distances;for(let e=0;e<f;e++){const i=l.starts[e],r=e+1<f?l.starts[e+1]:p;if(o){const e=m[i],n=m[r-1]-e,a=t*Math.floor(n/t),s=e+(n-a)/2;for(let t=i;t+1<r;t++)h(m[t]-e,Math.min(m[t+1]-e,a),t,-1,s)}else{u(m[i],i,-1);for(let e=i;e+1<r;e++)h(m[e],m[e+1],e,-1)}d(r)}for(let e=0;e<c.length;e++){if(null===c[e])continue;const t=c[e].count();let i=c[e].attrib;if(t<1)continue;let r=p;for(let e=t-1;e>=0;e--){let t=i.data[4*e+3];t>=0&&t<r&&(r=t),t=i.data[4*e+2];const n=Math.max(i.data[4*e+0],i.data[4*e+0]+i.data[4*e+1]);for(;n>m[t]&&t<r;)t++;t<r&&t++,i.data[4*e+3]=t,t<r&&(r=t)}}let g=null;if(o){g=[];const i=this.collapseSameSign(e.map(e=>this.segmentIsShape(e)?-e.length:e.length));for(let e=0;e<f;e++){const r=l.starts[e],n=e+1<f?l.starts[e+1]:p,a=m[r],s=m[n-1]-a,o=Math.floor(s/t);if(o<1){g.push(s+2*a);continue}const c=a+(s-t*o)/2;g.push(c);for(let e=0;e<i.length*o;e++)g.push(i[e%i.length]);g.push(c)}g=Float32Array.from(this.collapseSameSign(g),Math.abs)}return{distances:m,instances:c.filter(e=>null!==e),dashes:g}},createShapeDrawingGroup:function(e,t){let i=a({points_flattened:t,is_triangle_mesh:4===e.glType});const n=new r.DrawingGroup(void 0,i,e.glType,e.start,e.count);return n._primitives=[{group:n,start:n.start,count:n.count}],n.geometry=e.geometry,n},computeDependentDGs:function(t,i,r,a){let o=e=>this.computeDependentDGs(t,i,r,e),l=t._dependentDGs;if(!i._isLineWithShapes||0===i._patternShapes.length)return l&&l.lineShapes&&delete l.lineShapes,[];if(l||(l=t._dependentDGs={}),!l.lineShapes){const e=this.extractLineStrips(r.vertexPositionArray,r.vertexIndexArray.subarray(t.start,t.start+t.count),i._wholePatternsOnly?null:this.deduplicatePoints(r.vertexPositionArray)),n=i._pattern.map(e=>Number.isInteger(e.shape)?i._patternShapes[e.shape]:null).filter(e=>null!==e);l.lineShapes={obj2screen:null,strips:e,drawingGroups:n.map(t=>this.createShapeDrawingGroup(t,e.points))};for(let e=0;e<l.lineShapes.drawingGroups.length;e++)l.lineShapes.drawingGroups[e]._updateLineWithShapes=o}if(!l.lineShapes.obj2screen||!l.lineShapes.obj2screen.equals(a)){l.lineShapes.obj2screen=a;const t=!i._worldSizePattern,r=this.computeInstancePlacements({pattern:i._pattern,stride:i._patternStride,scale:i.scale,strips:l.lineShapes.strips,pointTransform:t?l.lineShapes.obj2screen:new e.Matrix4,distanceFunction:t?n.screenDistance:n.homogeneousDistance,initial_dist:"butt"!=i.linecap?i.lineWidth/2:0,wholePatternsOnly:i._wholePatternsOnly});r.dashes&&i.setDashPatternArray(r.dashes);for(let e=0;e<r.instances.length;e++){const n=l.lineShapes.drawingGroups[e],a=r.instances[e];n.setInstancingParameters(a.count(),[a.attrib],"mesh"),s(n.material,{distances:r.distances,color:i.color,scale:i.scale,thickness:i.lineWidth,screenSpace:t,shapeTransform:a.transform});const o=n.geometry.wideLinesLinker&&n.geometry.wideLinesLinker.originalDGToWideDG.get(n);o&&o.setInstancingParameters(a.count(),[a.attrib],"mesh")}}return l.lineShapes.drawingGroups}};var l=function(e){this._isLineWithShapes=!1,this._isBidimLine=!1,this._pattern=null,this._patternShapes=[],this._patternStride=NaN,t.call(this,e),this._worldSizePattern=e&&!!e._worldSizePattern,this._wholePatternsOnly=e&&!!e._wholePatternsOnly,this.polygonBorderMode=e&&!!e.polygonBorderMode,this._worldSizePattern&&(this.backMaterial&&this.backMaterial._worldSizePattern!==this._worldSizePattern&&(console.error("Non matching pattern units in back material"),this.setBackMaterial(null)),this.isCPUPattern&&(console.error("CPU Pattern not possible in model space unit"),this.setCPUPattern(!1)),this.linecap="butt"),this.isWideLine=this.lineWidth>1||this.isCPUPattern&&this.isDashedLine,this.backMaterial&&(this.backMaterial.isWideLine=this.backMaterial.lineWidth>1||this.isCPUPattern&&this.backMaterial.isDashedLine),this.polygonBorderMode&&(this.polygonOffset=this.polygonOffset?this.polygonOffset:this.lineWidth>1,this.polygonOffsetFactor=this.polygonOffsetFactor?this.polygonOffsetFactor:-1,this.polygonOffsetUnits=this.polygonOffsetUnits?this.polygonOffsetUnits:-10),e&&e.pattern&&this.setPattern({pattern:e.pattern,shapes:e.patternShapes}),this._wholePatternsOnly&&(this._isBidimLine=!1,this._invertedPattern=!1)};function c(e,t,i){var r=e.getBaseId();if(r+="GT-Edge"+t+"S"+e.side+"CP"+e.enableClipPlanes+"TR"+(e.transparent||e.getOpacity()<1)+"LW"+e.lineWidth,r+="PBM"+e.polygonBorderMode,r+="LC"+e.linecap+"LJ"+e.linejoin,r+="O"+e.opacity,e.isDashedLine){r+="SC"+e.scale,r+="IP"+e._invertedPattern+"WS"+e._worldSizePattern+"CPU"+e.isCPUPattern;for(var n=0;n<e.dashPattern.length;n++){r+=n+"p"+e.dashPattern[n]}}return r="id"+(r+=i||"").hashCode()}function h(t,i){var r={color:i||new e.Color,opacity:t.opacity,side:t.side,lineWidth:t.lineWidth,enableClipPlanes:t.enableClipPlanes,linejoin:t.linejoin,linecap:t.linecap,scale:t.scale,pixelSize:t.pixelSize,isCPUPattern:t.isCPUPattern,patternOffset:t.patternOffset,transparent:t.transparent||t.getOpacity()<1,polygonBorderMode:t.polygonBorderMode,invertedPattern:t._invertedPattern,_worldSizePattern:t._worldSizePattern};if(t.isDashedLine){r.dashPattern=new Float32Array(t.dashPattern);for(var n=r.dashPattern.length-1;n>0;n--)r.dashPattern[n]-=r.dashPattern[n-1]}return r}return(l.prototype=Object.create(t.prototype)).clone=function(){var e=new l;return t.prototype.clone.call(this,e),e.polygonBorderMode=this.polygonBorderMode,e._isBidimLine=this._isBidimLine,e._isLineWithShapes=this._isLineWithShapes,e._pattern=this._pattern,e._patternShapes=this._patternShapes,e._patternStride=this._patternStride,e},l.prototype._shaderID="line",l.prototype._setMaterialShaderOptions=function(e,i,r,n,a,s){t.prototype._setMaterialShaderOptions.call(this,e,i,r,n,a,s);var o={};s||Object.assign(o,{worldSizePattern:this._worldSizePattern,cpuPattern:this.isCPUPattern}),Object.assign(o,{polygonBorderMode:this.polygonBorderMode}),Object.assign(e,o)},l.prototype.setPattern=function(e){if(!e||!e.pattern)return this._isLineWithShapes=!1,this._isBidimLine=!1,this._pattern=null,this._patternShapes=[],this._patternStride=NaN,void this.setDashPatternArray([]);if(!o.isValidPattern(e.pattern))return void console.error("Invalid pattern: expected an array (of numbers or of segments), got: ",e.pattern);if(o.isDashPatternArray(e.pattern))return void this.setDashPatternArray(e.pattern);let t=JSON.parse(JSON.stringify(e.pattern)),i=(e.shapes||[]).slice();o.setSegmentTransforms4x4(t),o.instantiatePatternPoints(t,i,this.lineWidth,this.scale),this._invertedPattern=!o.segmentIsDash(t[0]),this.setDashPatternArray(o.extractDashPattern(t)),0!==(i=o.trimUnusedShapes(t,i)).length&&(o.normalizeSegments(t,i),this._pattern=t,this._patternShapes=i,this._patternStride=o.computeOffsetsAndStride(this._pattern),this._isLineWithShapes=!0,this._isBidimLine=!this._pattern.some(o.segmentIsDash))},l.prototype.loadUniforms=function(e,i,r,n,a,s){if(t.prototype.loadUniforms.call(this,e,i,r,n,a,s),r.halfWidth&&i.uniform1f(r.halfWidth,this.lineWidth?e._renderScale*this.lineWidth/2:.5),r.scale){var o=this._worldSizePattern?1:e._renderScale;i.uniform1f(r.scale,this.scale?o*this.scale:.15)}},l.prototype.getType=function(){return"Line"},l.prototype._computeDependentDGs=function(e,t,i){return o.computeDependentDGs(e,this,t,i)},l.prototype.setLineWidth=function(e){e<1&&(e=1);var t=Math.round(e);if(Math.abs(this.lineWidth-t)>1e-6){var i=this.isWideLine;this.lineWidth=t,this.polygonBorderMode&&(this.polygonOffset=this.polygonOffset?this.polygonOffset:this.lineWidth>1,this.polygonOffsetFactor=this.polygonOffsetFactor?this.polygonOffsetFactor:-1,this.polygonOffsetUnits=this.polygonOffsetUnits?this.polygonOffsetUnits:-10),this.isWideLine=this.lineWidth>1||this.isCPUPattern&&this.isDashedLine,this.needsUpdate=i!==this.isWideLine,this._invalidateDisplayRangeLists(),this.updateDeferredMaterials()}},l.prototype.getGeomTypeDeferredMaterial=function(t,i){switch(t){case e.GeomTypeEnum.BOUNDARY_EDGE:return this._getBoundaryEdgeMaterial(i.boundaryEdge);case e.GeomTypeEnum.SMOOTH_EDGE:return this._getSmoothEdgeMaterial(i.smoothEdge)}return this},l.prototype.setBackMaterial=function(t){t&&t._worldSizePattern!==this._worldSizePattern?console.error("Non matching pattern units in back material"):(e.DeferrableMaterial.prototype.setBackMaterial.call(this,t),this.backMaterial&&(this.backMaterial.isWideLine=this.backMaterial.lineWidth>1||this.isCPUPattern&&this.backMaterial.isDashedLine),this.updateDeferredMaterials())},l.prototype.setDashPatternArray=function(e){t.prototype.setDashPatternArray.call(this,e),this.needsUpdate&&(this.isWideLine=this.lineWidth>1||this.isCPUPattern&&this.isDashedLine,this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())},l.prototype.setDashPatternType=function(e){t.prototype.setDashPatternType.call(this,e),this.needsUpdate&&(this.isWideLine=this.lineWidth>1||this.isCPUPattern&&this.isDashedLine,this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())},l.prototype.setCPUPattern=function(e){this._worldSizePattern&&e&&(console.error("CPU Pattern not possible in model space unit"),e=!1),this.isCPUPattern!==e&&(this.isCPUPattern=e,this.needsUpdate=!0,this.isWideLine=this.lineWidth>1||this.isCPUPattern&&this.isDashedLine,null!==this.backMaterial&&(this.backMaterial.isCPUPattern=this.isCPUPattern,this.backMaterial.isWideLine=this.backMaterial.lineWidth>1||this.isCPUPattern&&this.backMaterial.isDashedLine,this.backMaterial.needsUpdate=!0,this.backMaterial._invalidateDisplayRangeLists(),this.backMaterial.updateDeferredMaterials()),this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())},l.prototype._getBoundaryEdgeMaterial=function(t){if(!t.enabled)return this;var r=c(this,e.GeomTypeEnum.BOUNDARY_EDGE);if(i.GeomTypeMaterials.has(r))return i.GeomTypeMaterials.get(r).get(this);var n=h(this,null),a=new l(n);a.color=t.color;var s=new i.DeferredMaterial(a);return i.GeomTypeMaterials.set(r,s),s.get(this)},l.prototype._getSmoothEdgeMaterial=function(t){if(!t)return this;var r=c(this,e.GeomTypeEnum.SMOOTH_EDGE,"Col"+this.color.getHex());if(i.GeomTypeMaterials.has(r))return i.GeomTypeMaterials.get(r).get(this);var n=h(this,this.color);n.opacity*=.5;var a=new l(n),s=new i.DeferredMaterial(a);return i.GeomTypeMaterials.set(r,s),s.get(this)},l.prototype._getBodyEdgeMaterial=function(){var e=this.getBaseId();if(e+="BodyEdgeS"+this.side+"CP"+this.enableClipPlanes+"TR"+(this.transparent||this.getOpacity()<1),e+="O"+this.opacity,e="id"+(e+="Col"+this.color.getHex()).hashCode(),i.GeomTypeMaterials.has(e))return i.GeomTypeMaterials.get(e).get(this);var t={color:this.color,opacity:this.opacity,side:this.side,enableClipPlanes:this.enableClipPlanes,transparent:this.transparent||this.getOpacity()<1},r=new l(t),n=new i.DeferredMaterial(r);return i.GeomTypeMaterials.set(e,n),n.get(this)},l}),define("DS/MaterialLibs/LineBasicLib",["DS/MaterialLibs/UniformsLib","DS/Shaders/DeferrableShaders","DS/Visualization/ShaderChunk","DS/Visualization/UniformsUtils","DS/Materials/LineBasicMaterial"],function(e,t,i,r,n){"use strict";var a=n.prototype.deferrable,s="",o="",l="",c="";return a&&(s=[t.depth_pars_vertex,t.picking_pars_vertex,t.picking_instancing_pars_vertex,t.highlight_pars_vertex].join("\n"),l=[t.depth_vertex,t.picking_vertex,t.picking_instancing_vertex,t.highlight_vertex].join("\n"),o=[t.picking_pars_fragment,t.picking_instancing_pars_fragment,t.depth_pars_fragment,t.highlight_pars_fragment].join("\n"),c=[t.picking_fragment,t.picking_instancing_fragment,t.depth_fragment,t.lineic_normal_fragment,t.highlight_fragment_edge].join("\n")),{uniforms:r.merge([e.common,e.clipPlanes,e.lines,e.postprocess,a?e.deferred:{}]),vertexShader:["#define LINEBASIC",i.clip_pars_vertex,i.map_pars_vertex,i.color_pars_vertex,i.morphtarget_pars_vertex,i.skinning_pars_vertex,i.lines_pars_vertex,i.fog_pars_vertex,t.oit_pars_vertex,s,"void main() {",i.PDSFX_start_vertex,"#ifdef PDSFX",i.PDSFX_halfWidth_fragment_vertex,"#endif",i.map_vertex,i.color_vertex,i.skinbase_vertex,i.morphtarget_vertex,i.skinning_vertex,i.default_vertex,i.clip_vertex,i.fog_vertex,i.worldpos_vertex,i.lines_vertex,t.oit_vertex,l,i.PDSFX_end_vertex,"}"].join("\n"),fragmentShader:["#define LINEBASIC","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","vec2 uvToUse;","#endif",i.lines_pars_fragment,i.clip_pars_fragment,i.color_pars_fragment,i.map_pars_fragment,i.fog_pars_fragment,t.oit_pars_fragment,o,i.postprocess_pars_fragment,"void main() {","#ifdef PDSFX",i.PDSFX_map_fragment,i.PDSFX_mapping_fragment,"ComputeCommonValues();",i.PDSFX_discard_fragment,i.PDSFX_albedo_fragment,i.PDSFX_halfWidth_fragment_vertex,i.PDSFX_opacity_fragment,"#endif","#if defined(SELECTION_MATERIAL)","gl_FragColor = vec4( diffuse, 1.0 );","#else","gl_FragColor = vec4( diffuse, opacity );","#endif",i.lines_fragment,"#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","uvToUse=vUv;","#endif",i.clip_fragment,i.uvmapping_fragment,i.map_fragment,i.alphatest_fragment,i.color_fragment,i.postprocess_fragment,i.linear_to_gamma_fragment,i.PDSFX_end_fragment,i.fog_fragment,i.backgroundviewmode_lowlight_fragment,t._debug_common_lineic_fragment,t.oit_fragment,c,"}"].join("\n")}}),define("DS/Materials/OldInfraMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/Material","DS/Materials/DeferredCaches","DS/MaterialLibs/GenericLib"],function(e,t,i,r){"use strict";var n=function(){t.call(this)};return(n.prototype=Object.create(t.prototype))._setMaterialShaderOptions=function(e,i,r,n,a,s){t.prototype._setMaterialShaderOptions.call(this,e,i,r,n,a,s)},n.prototype.clone=function(e){return void 0===e&&(e=new n),t.prototype.clone.call(this,e),e},n.prototype.copyPDSFXParameters=function(e){this._PDSFXData&&this._PDSFXData.PDSFX&&(e.activatePDSFX(),e.setPDSFXOverridableFunctions(this._PDSFXData.PDSFX_OverridableFunctions_VS,this._PDSFXData.PDSFX_OverridableFunctions_FS),this._PDSFXData.pdsfxVaryingsCode&&(e._PDSFXData.pdsfxVaryingsCode=this._PDSFXData.pdsfxVaryingsCode),this._PDSFXData.pdsfxUniformsCode&&(e._PDSFXData.pdsfxUniformsCode=this._PDSFXData.pdsfxUniformsCode),this._PDSFXData.pdsfxUniforms&&(e._PDSFXData.pdsfxUniforms=this._PDSFXData.pdsfxUniforms),this._PDSFXData.pdsfxGlobalVariablesCode_VS&&(e._PDSFXData.pdsfxGlobalVariablesCode_VS=this._PDSFXData.pdsfxGlobalVariablesCode_VS),this._PDSFXData.pdsfxGlobalVariablesCode_FS&&(e._PDSFXData.pdsfxGlobalVariablesCode_FS=this._PDSFXData.pdsfxGlobalVariablesCode_FS),this._PDSFXData.pdsfxAttributesCode&&(e._PDSFXData.pdsfxAttributesCode=this._PDSFXData.pdsfxAttributesCode),this._PDSFXData.pdsfxUseMap&&(e._PDSFXData.pdsfxUseMap=!0),e._PDSFXData.CPULargeScale=this._PDSFXData.CPULargeScale,e.refreshPDSFXUniforms=this.refreshPDSFXUniforms,e._refreshPDSFXUniforms_private=this._refreshPDSFXUniforms_private,!e.line||e.line._PDSFXData&&e.line._PDSFXData.PDSFX||this.copyPDSFXParameters(e.line),!e.point||e.point._PDSFXData&&e.point._PDSFXData.PDSFX||this.copyPDSFXParameters(e.point),e.defines=this.defines,e._PDSFXData._setUniformsList())},n.prototype.copyPDSFXParametersPicking=function(e){if(this._PDSFXData&&this._PDSFXData.PDSFX){e.activatePDSFX();var t={ComputeCommonValues:this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeCommonValues,ComputeDiscard:this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeDiscard,ComputeHalfWidth:this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeHalfWidth,ProcessLinePattern:this._PDSFXData.PDSFX_OverridableFunctions_FS.ProcessLinePattern};e.setPDSFXOverridableFunctions(this._PDSFXData.PDSFX_OverridableFunctions_VS,t),this._PDSFXData.pdsfxVaryingsCode&&(e._PDSFXData.pdsfxVaryingsCode=this._PDSFXData.pdsfxVaryingsCode),this._PDSFXData.pdsfxUniformsCode&&(e._PDSFXData.pdsfxUniformsCode=this._PDSFXData.pdsfxUniformsCode),this._PDSFXData.pdsfxUniforms&&(e._PDSFXData.pdsfxUniforms=this._PDSFXData.pdsfxUniforms),this._PDSFXData.pdsfxGlobalVariablesCode_VS&&(e._PDSFXData.pdsfxGlobalVariablesCode_VS=this._PDSFXData.pdsfxGlobalVariablesCode_VS),this._PDSFXData.pdsfxGlobalVariablesCode_FS&&(e._PDSFXData.pdsfxGlobalVariablesCode_FS=this._PDSFXData.pdsfxGlobalVariablesCode_FS),this._PDSFXData.pdsfxAttributesCode&&(e._PDSFXData.pdsfxAttributesCode=this._PDSFXData.pdsfxAttributesCode),this._PDSFXData.pdsfxUseMap&&(e._PDSFXData.pdsfxUseMap=!0),e._PDSFXData.CPULargeScale=this._PDSFXData.CPULargeScale,e.refreshPDSFXUniforms=this.refreshPDSFXUniforms,e._refreshPDSFXUniforms_private=this._refreshPDSFXUniforms_private,e.defines=this.defines,e._PDSFXData._setUniformsList()}},n.prototype.updateGenericDeferredMaterials=function(t){var i=this._deferredMaterials[e.MaterialToUse.normalMaterial];i.force=!0,i.wireframe=this.wireframe,i.vertexColors=this.vertexColors,i.attributes=Object.assign(i.attributes?i.attributes:{},this.attributes),this.copyPDSFXParameters(i);var r=this._deferredMaterials[e.MaterialToUse.depthMaterial];r.force=!0,r.defines||(r.defines={}),r.wireframe=this.wireframe,r.vertexColors=this.vertexColors,r.attributes=Object.assign(r.attributes?r.attributes:{},this.attributes),this.copyPDSFXParameters(r);var n=this._deferredMaterials[e.MaterialToUse.depthRGBAMaterial];n.force=!0,n.defines||(n.defines={}),n.wireframe=this.wireframe,n.vertexColors=this.vertexColors,n.attributes=Object.assign(n.attributes?n.attributes:{},this.attributes),this.copyPDSFXParameters(n);var a=this._deferredMaterials[e.MaterialToUse.normalDepthIoRRoughnessMaterial];this.reflectionCoef&&this.reflectionCoef>0&&(a.uniforms.reflectionCoef={type:"f",value:this.reflectionCoef}),a.force=!0,a.wireframe=this.wireframe,a.vertexColors=this.vertexColors,a.attributes=Object.assign(a.attributes?a.attributes:{},this.attributes),this.copyPDSFXParameters(a);var s=this._deferredMaterials[e.MaterialToUse.normalDepthMaterial];s.force=!0,s.wireframe=this.wireframe,s.vertexColors=this.vertexColors,s.attributes=Object.assign(s.attributes?s.attributes:{},this.attributes),this.copyPDSFXParameters(s);var o=this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepthMaterial];o.force=!0,o.wireframe=this.wireframe,o.vertexColors=this.vertexColors,o.attributes=Object.assign(o.attributes?o.attributes:{},this.attributes),this.copyPDSFXParameters(o);var l=this._deferredMaterials[e.MaterialToUse.shadowMapDepthMaterial];l.force=!0,l.wireframe=this.wireframe,l.vertexColors=this.vertexColors,l.attributes=Object.assign(l.attributes?l.attributes:{},this.attributes),this.copyPDSFXParameters(l);var c=this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial];c&&(c.force=!0,c.wireframe=this.wireframe,c.vertexColors=this.vertexColors,c.attributes=Object.assign(c.attributes?c.attributes:{},this.attributes),this.copyPDSFXParameters(c));var h=this._deferredMaterials[e.MaterialToUse.highlightMaterial];e._mobileHighlight&&(h.useBlending=!0,h.blending=e.CustomBlending,h.depthTest=!1,h.depthWrite=!1),h.vertexColors=this.vertexColors,h.attributes=Object.assign(h.attributes?h.attributes:{},this.attributes),this.copyPDSFXParameters(h);var u=this._deferredMaterials[e.MaterialToUse.pickingMaterial],d=this._deferredMaterials[e.MaterialToUse.pickingMaterialInstancing];this.isInstancingMaterial&&d&&(d.vertexColors=this.vertexColors,d.attributes=Object.assign(d.attributes?d.attributes:{},this.attributes),d.force=!0,d.transparent=this.transparent,this.copyPDSFXParametersPicking(d)),u.attributes=Object.assign(u.attributes?u.attributes:{},this.attributes),u.force=!0,this.copyPDSFXParametersPicking(u),this.backMaterial&&!this.backMaterial._deferredMaterialsInit&&(this.backMaterial.updateDeferredMaterials(),this._deferredMaterials[e.MaterialToUse.pickingMaterial]=this._deferredMaterials[e.MaterialToUse.pickingMaterial].clone(),this._deferredMaterials[e.MaterialToUse.pickingMaterial].backMaterial=this.backMaterial._deferredMaterials[e.MaterialToUse.pickingMaterial]),this instanceof e.ParticleBasicMaterial||(this._deferredMaterials[e.MaterialToUse.oitAccumMaterial]=this,this._deferredMaterials[e.MaterialToUse.oitRevealMaterial]=this),this._deferredMaterials[e.MaterialToUse.ZOnlyMaterial]=this.getZOnlyMaterial();for(var p=0;p<e.MaterialToUse.totalMaterial;p++){var f=this._deferredMaterials[p];null!==f&&(f.isBackMaterial=this.isBackMaterial)}var m=this.getTexCoordMaterial();this.copyPDSFXParameters(m),this._deferredMaterials[e.MaterialToUse.texCoordMaterial]=m,this._deferredMaterialsInit=!0},n.prototype.updateDeferredMaterials=function(t){e.cleanDeferredCache(this.id),this._deferredMaterials[e.MaterialToUse.normalMaterial]=this.getNormalMaterial(),this._deferredMaterials[e.MaterialToUse.depthMaterial]=this.getDepthMaterial(0),this._deferredMaterials[e.MaterialToUse.depthRGBAMaterial]=this.getDepthMaterial(1),this._deferredMaterials[e.MaterialToUse.normalDepthIoRRoughnessMaterial]=this.getNormalDepthIoRRoughnessMaterial(t),this._deferredMaterials[e.MaterialToUse.shadowMapDepthMaterial]=this.getShadowDepthMaterial(),this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial]=this.getTransparentShadowMaterial(),this._deferredMaterials[e.MaterialToUse.highlightMaterial]=e._mobileHighlight?this.getHighlightMaterial("HighlightMobile"):this.getHighlightMaterial("Highlight");var i=this.getPickingMaterial(),r=i.pickingMaterial,n=i.pickingMaterialInstancing;this._deferredMaterials[e.MaterialToUse.normalDepthMaterial]=this.getNormalDepthMaterial("NormalDepth"),this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepthMaterial]=this.getNormalDepthMaterial("DecalNormalStencilDepth"),this._deferredMaterials[e.MaterialToUse.pickingMaterialInstancing]=n,this._deferredMaterials[e.MaterialToUse.pickingMaterial]=r,this.updateGenericDeferredMaterials(t)},n.prototype.getInvisibleMaterial=function(){var t=this.getBaseId();if(t="id"+(t+="TInvisible").hashCode(),i.DefaultMaterials.has(t))return i.DefaultMaterials.get(t).get(this);var r=new e.ShaderMaterial;r.visible=!1,r.force=!0;var n=new i.DeferredMaterial(r);return i.DefaultMaterials.set(t,n),n.get(this)},n.prototype.getTexCoordMaterial=function(){var t=this.getBaseId();if(t+="TTexCoord",t+=this.map?this.map.id:this.map,t+="AT"+this.alphaTest,t="id"+(t+="BM"+this.isBackMaterial).hashCode(),i.DefaultMaterials.has(t))return i.DefaultMaterials.get(t).get(this);var r,n=e._DeferredShaders.TextureCoordinate,a={uniforms:e.UniformsUtils.clone(n.uniforms),fragmentShader:n.fragmentShader,vertexShader:n.vertexShader,side:e.DoubleSide,enableClipPlanes:this.enableClipPlanes};this.map&&this.alphaTest?(a.defines={USE_MAP_ALPHATEST:!0,ALPHATEST:this.alphaTest.toFixed(5)},a.uniforms.map.value=this.map,a.uniforms.offsetAlphaMap.value=this.map.offset,a.uniforms.repeatAlphaMap.value=this.map.repeat,r=new e.ShaderMaterial(a)):(a.force=!0,r=new e.ShaderMaterial(a));var s=new i.DeferredMaterial(r);return i.DefaultMaterials.set(t,s),s.get(this)},n.prototype.getHighlightInfo=function(t){var i,r="Highlight";switch(t){case"Highlight":i=e._AdvancedHighlightShader,r="Highlight";break;case"HighlightMobile":i=e._AdvancedHighlightShaderSinglePass,r="Highlight"}return{shaderLib:i,shaderName:r}},n.prototype.getHighlightMaterial=function(t){var r=this.getBaseId();if(r+="T"+t,r+="GTFace",r+="CP"+this.enableClipPlanes,r+="M",r+=this.map?this.map.id:this.map,r+="AT"+this.alphaTest,r="id"+(r+="BM"+this.isBackMaterial).hashCode(),i.DefaultHighlightMaterials.has(r))return i.DefaultHighlightMaterials.get(r).get(this);var n,a=this.getHighlightInfo(t),s=a.shaderLib,o=a.shaderName;o+="Face";var l={uniforms:e.UniformsUtils.clone(s[o].uniforms),fragmentShader:s[o].fragmentShader,vertexShader:s[o].vertexShader,side:e.DoubleSide,enableClipPlanes:this.enableClipPlanes};this.map&&this.alphaTest?(l.defines={USE_MAP_ALPHATEST:!0,ALPHATEST:this.alphaTest.toFixed(5)},l.uniforms.map.value=this.map,l.uniforms.offsetAlphaMap.value=this.map.offset,l.uniforms.repeatAlphaMap.value=this.map.repeat,n=new e.ShaderMaterial(l)):(l.force=!0,n=new e.ShaderMaterial(l));var c=new i.DeferredMaterial(n);return i.DefaultHighlightMaterials.set(r,c),c.get(this)},n.prototype.getPickingMaterial=function(){var t=this.getBaseId();if(t+="GTFaceS"+this.side+"CP"+this.enableClipPlanes+"TR"+(this.transparent||this.getOpacity()<1),t+="SD"+this.shading,t+="M",t+=this.map?this.map.id:this.map,t+="AT"+this.alphaTest,t="id"+(t+="BM"+this.isBackMaterial).hashCode(),i.DefaultPickingMaterials.has(t))return i.DefaultPickingMaterials.get(t).get(this);var r=null,n=null;if(this.map&&this.alphaTest){var a=e._DeferredShaders.PickingFragment,s=e.UniformsUtils.clone(a.uniforms),o={USE_MAP_ALPHATEST:!0};o.ALPHATEST=this.alphaTest.toFixed(5),s.map.value=this.map,s.offsetAlphaMap.value=this.map.offset,s.repeatAlphaMap.value=this.map.repeat,r=new e.ShaderMaterial({uniforms:s,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,defines:o,blending:e.NoBlending,transparent:this.transparent||this.getOpacity()<1,side:this.side,enableClipPlanes:this.enableClipPlanes}),this.shading&&(r.shading=this.shading),r.uniforms.pickingColor={type:"c",value:new e.Color},this.isInstancingMaterial&&(n=new e.ShaderMaterial({uniforms:s,vertexShader:e._DeferredShaders.PickingFragmentInstancing.vertexShader,fragmentShader:e._DeferredShaders.PickingFragmentInstancing.fragmentShader,defines:o,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,transparent:this.transparent||this.getOpacity()<1}),this.shading&&(n.shading=this.shading))}else r=new e.MeshBasicMaterial({color:new e.Color,side:this.side,enableClipPlanes:this.enableClipPlanes,transparent:this.transparent||this.getOpacity()<1}),this.isInstancingMaterial&&((n=r.clone())._definePickingInstancing=!0,n.isInstancingMaterial=!0);var l={pickingMaterial:r,pickingMaterialInstancing:n},c=new i.DeferredMaterial(l);return i.DefaultPickingMaterials.set(t,c),c.get(this)},n.prototype.getShadowDepthMaterial=function(){var t,n=this.getBaseId();if(n+="S"+this.side+"CP"+this.enableClipPlanes+"SD"+this.shading,n+="M",n+=this.map?this.map.id:this.map,n+="AT"+this.alphaTest,n="id"+(n+="BM"+this.isBackMaterial).hashCode(),i.DefaultShadowDepthMaterials.has(n))return i.DefaultShadowDepthMaterials.get(n).get(this);var a=r.depthRGBA,s=e.UniformsUtils.clone(a.uniforms);if(this.map&&this.alphaTest){var o={USE_MAP_ALPHATEST:!0};o.ALPHATEST=this.alphaTest.toFixed(5),s.map.value=this.map,s.offsetAlphaMap.value=this.map.offset,s.repeatAlphaMap.value=this.map.repeat,t=new e.ShaderMaterial({uniforms:s,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,defines:o,blending:e.NoBlending,side:e.DoubleSide,enableClipPlanes:this.enableClipPlanes}),this.shading&&(t.shading=this.shading),t.force=!0,t.wireframe=this.wireframe,t.vertexColors=this.vertexColors}else t=new e.ShaderMaterial({uniforms:s,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,side:e.DoubleSide,enableClipPlanes:this.enableClipPlanes});t.attributes=Object.assign(t.attributes?t.attributes:{},this.attributes);var l=new i.DeferredMaterial(t);return i.DefaultShadowDepthMaterials.set(n,l),l.get(this)},n.prototype.getTransparentShadowMaterial=function(){return this.isPhysicalMaterial?((t=this.clone()).useLighting=!1,t.useBlending=!0,t.blending=e.TransparentShadowBlending,t):null;var t},n.prototype.getNormalDepthMaterialCommons=function(t){var r=this.getBaseId();if(r+="T"+t+"GTFaceS"+this.side+"CP"+this.enableClipPlanes+"SD"+this.shading,r+="M",r+=this.map?this.map.id:this.map,r+="AT"+this.alphaTest,r+="BM",r+=this.bumpMap?this.bumpMap.id:this.bumpMap,r+="NM",r+=this.normalMap?this.normalMap.id:this.normalMap,r+="Ro",r+=this.roughness,r+="RM",r+=this.roughnessMap?this.roughnessMap.id:this.roughnessMap,r+="GM",r+=this.glossinessMap?this.glossinessMap.id:this.glossinessMap,r+="MT"+this.morphTargets,r+="MN"+this.morphNormals,r="id"+(r+="BM"+this.isBackMaterial).hashCode(),i.DefaultNormalDepthMaterials.has(r))return{id:r,materialParams:null,material:i.DefaultNormalDepthMaterials.get(r).get(this)};var n=t,a=e._DeferredShaders[n];return{id:r,materialParams:{uniforms:e.UniformsUtils.clone(a.uniforms),vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,side:this.side,enableClipPlanes:this.enableClipPlanes},material:null}},n.prototype.getNormalMaterial=function(){var t=this.getNormalDepthMaterialCommons("Normal");if(null!==t.material)return t.material;var r=t.materialParams;if(this.bumpMap||this.map&&this.alphaTest){var n={};this.map&&this.alphaTest&&(n.USE_MAP_ALPHATEST=!0,n.ALPHATEST=this.alphaTest.toFixed(5),r.uniforms.map.value=this.map,r.uniforms.offsetAlphaMap.value=this.map.offset,r.uniforms.repeatAlphaMap.value=this.map.repeat),this.bumpMap&&(n.USE_BUMPMAP=!0,r.uniforms.bumpMap.value=this.bumpMap,r.uniforms.bumpScale.value=this.bumpScale,r.uniforms.offsetBumpMap.value=this.bumpMap.offset,r.uniforms.repeatBumpMap.value=this.bumpMap.repeat),r.defines=n,this.shading&&(r.shading=this.shading),this.morphTargets&&(r.morphTargets=this.morphTargets),this.morphNormals&&(r.morphNormals=this.morphNormals),r.blending=e.NoBlending}var a=new e.ShaderMaterial(r),s=new i.DeferredMaterial(a);return i.DefaultNormalDepthMaterials.set(t.id,s),s.get(this)},n.prototype.getNormalDepthIoRRoughnessMaterial=function(t){var r=this.getNormalDepthMaterialCommons("NormalDepthIoRRoughness");if(null!==r.material)return r.material;var n=r.materialParams;n.uniforms.roughness.value=this.roughness;var a={};(this.bumpMap||this.normalMap||this.roughnessMap||this.map&&this.alphaTest)&&(this.map&&this.alphaTest&&(a.USE_MAP_ALPHATEST=!0,a.ALPHATEST=this.alphaTest.toFixed(5),n.uniforms.map.value=this.map,n.uniforms.offsetAlphaMap.value=this.map.offset,n.uniforms.repeatAlphaMap.value=this.map.repeat),this.bumpMap&&(a.USE_BUMPMAP=!0,n.uniforms.bumpMap.value=this.bumpMap,n.uniforms.bumpScale.value=this.bumpScale,n.uniforms.offsetBumpMap.value=this.bumpMap.offset,n.uniforms.repeatBumpMap.value=this.bumpMap.repeat),this.normalMap&&(a.USE_NORMALMAP=!0,n.uniforms.normalMap.value=this.normalMap),this.roughnessMap?(a.USE_ROUGHNESSMAP=!0,n.uniforms.roughnessMap.value=this.roughnessMap):this.glossinessMap&&(a.USE_GLOSSINESSMAP=!0,n.uniforms.glossinessMap.value=this.glossinessMap),this.shading&&(n.shading=this.shading),this.morphTargets&&(n.morphTargets=this.morphTargets),this.morphNormals&&(n.morphNormals=this.morphNormals),n.blending=e.NoBlending),n.defines=a;var s=new e.ShaderMaterial(n),o=new i.DeferredMaterial(s);return i.DefaultNormalDepthMaterials.set(r.id,o),o.get(this)},n.prototype.getDepthMaterial=function(t){var r=this.getNormalDepthMaterialCommons(0===t?"Depth":"DepthRGBA");if(null!==r.material)return r.material;var n=r.materialParams;if(this.map&&this.alphaTest){var a={USE_MAP_ALPHATEST:!0};a.ALPHATEST=this.alphaTest.toFixed(5),n.defines=a,n.uniforms.map.value=this.map,n.uniforms.offsetAlphaMap.value=this.map.offset,n.uniforms.repeatAlphaMap.value=this.map.repeat,this.shading&&(n.shading=this.shading),this.morphTargets&&(n.morphTargets=this.morphTargets),this.morphNormals&&(n.morphNormals=this.morphNormals),n.blending=e.NoBlending}var s=new e.ShaderMaterial(n),o=new i.DeferredMaterial(s);return i.DefaultNormalDepthMaterials.set(r.id,o),o.get(this)},n.prototype.getNormalDepthMaterial=function(t){var r=this.getNormalDepthMaterialCommons(t);if(r.material)return r.material;var n=r.materialParams;n.uniforms.roughness.value=this.roughness;var a={};(this.bumpMap||this.normalMap||this.roughnessMap||this.map&&this.alphaTest)&&(this.map&&this.alphaTest&&(a.USE_MAP_ALPHATEST=!0,a.ALPHATEST=this.alphaTest.toFixed(5),n.uniforms.map.value=this.map,n.uniforms.offsetAlphaMap.value=this.map.offset,n.uniforms.repeatAlphaMap.value=this.map.repeat),this.bumpMap&&(a.USE_BUMPMAP=!0,n.uniforms.bumpMap.value=this.bumpMap,n.uniforms.bumpScale.value=this.bumpScale,n.uniforms.offsetBumpMap.value=this.bumpMap.offset,n.uniforms.repeatBumpMap.value=this.bumpMap.repeat),this.normalMap&&(a.USE_NORMALMAP=!0,n.uniforms.normalMap.value=this.normalMap),this.roughnessMap?(a.USE_ROUGHNESSMAP=!0,n.uniforms.roughnessMap.value=this.roughnessMap):this.glossinessMap&&(a.USE_GLOSSINESSMAP=!0,n.uniforms.glossinessMap.value=this.glossinessMap),this.shading&&(n.shading=this.shading),this.morphTargets&&(n.morphTargets=this.morphTargets),this.morphNormals&&(n.morphNormals=this.morphNormals),n.blending=e.NoBlending),n.defines=a;var s=new e.ShaderMaterial(n),o=new i.DeferredMaterial(s);return i.DefaultNormalDepthMaterials.set(r.id,o),o.get(this)},n}),define("DS/Object3D/Scene",["DS/Mesh/ThreeJS_Base","DS/Object3D/Object3D","DS/Object3D/Light","DS/Object3D/Camera","DS/Object3D/Mesh","DS/Visualization/WebGLObjectManager","DS/Visualization/CullingSystem","DS/Visualization/BufferGPUManager"],function(e,t,i,r,n,a,s,o){"use strict";var l=function(){t.call(this),this.overrideMaterial=null,this.matrixAutoUpdate=!1,this.envMipMap=[],this.envMipMapID=null,this.envMipMapSheenID=null,this.ambienceMatrix=new e.Matrix4,this.reflectionProbes=[],this.useFiniteEnvMap=!1,this.parallaxCorrectionParameters={sphereCenter:[],sphereRadius:1,projectionCenter:[]},this._cullingSystems=[],this.__objects=new Set,this.__lights=[],this.__objectsAdded=new Map,this.__objectsRemoved=new Set,this.__objectsUpdated=new Map,this.defaultRenderList="main",this.isBackground=!1,this.highlightData=null,this.initWebGLObjectFrameIndex=-1,this.__webglObjects=null,this.__webglObjectsAll=null,this.__webglObjectsToDraw=null,this.__webglObjectsSharedToInit=null,this.__webglSprites=null,this.__webglFlares=null,this.renderResultIndices=null};(l.prototype=Object.create(t.prototype)).constructor=l,l.prototype._lightSort=function(e,t){var i=e._sortKey,r=t._sortKey;return i=e.onlyShadow?0:i,r=t.onlyShadow?0:r,i+=e.castShadow?1:0,r+=t.castShadow?1:0,i+=e.shadowCascade?2:0,(r+=t.shadowCascade?2:0)-i},l.prototype.__addObject=function(t,n){t instanceof i.BaseLight?(-1===this.__lights.indexOf(t)&&(this.__lights.push(t),this.__lights.sort(this._lightSort)),t.target&&void 0===t.target.parent&&this.add(t.target)):t instanceof e.LensFlare?(this.__webglFlares||(this.__webglFlares=[]),this.__webglFlares.push(t)):t instanceof r.BaseCamera||t instanceof e.Bone||(t._scenes||(t._scenes=new Set),t._scenes.add(this),this.__objects.add(t),this.__objectsUpdated.has(t)?this.__objectsUpdated.set(t,n):this.__objectsAdded.set(t,n),o.addGeometryFromObject(t),this.__objectsRemoved.delete(t));for(var a=0;a<t.children.length;a++)this.__addObject(t.children[a])},l.prototype.dispose=function(){var e,t=this.children.length;for(e=0;e<this.__lights.length;e++){var i=this.__lights[e];i.shadowMap&&i.shadowMap.dispose&&i.shadowMap.dispose()}for(e=0;e<t;e++)this.remove(this.children[0]);if(this.__objects.clear(),this.__lights=[],this.__objectsAdded.clear(),this.__objectsRemoved.clear(),this.__objectsUpdated.clear(),this.__webglObjects={main:new a},this.__webglObjectsAll=new a,this.__webglObjectsToDraw=[],this.__webglSprites=[],this._cullingSystems=[],s.__CullingSystemFactory){var r=s.__CullingSystemFactory.map,n=r.get(this.id);n&&(n.clear(),r.delete(this.id))}},l.prototype.updateObjectPasses=function(t,n){t instanceof i.BaseLight||t instanceof e.LensFlare||t instanceof r.BaseCamera||t instanceof e.Bone||(this.__objectsAdded.has(t)?this.__objectsAdded.set(t,n||null):this.__objectsUpdated.set(t,n||null))},l.prototype.getScene=function(){return this},l.prototype.getMeshInstances=function(){var e=[],t=this.getWebGLObjects("main",0);if(!t)return e;for(var i=0;i<t.length;i++){var r=t[i].object;r instanceof n&&e.push(r)}return e},l.prototype.__removeObject=function(t){if(t instanceof i.BaseLight)-1!==(n=this.__lights.indexOf(t))&&this.__lights.splice(n,1);else if(t instanceof e.LensFlare){var n;-1!==(n=this.__webglFlares.indexOf(t))&&this.__webglFlares.splice(n,1)}else t instanceof r.BaseCamera||this.__objects.delete(t)&&(this.__objectsRemoved.add(t),t._scenes&&t._scenes.delete(this),this.flagAsGSSOInvalidated(t),t._removeFromAllStateSortingResults(),this.__objectsAdded.delete(t));for(var a=0;a<t.children.length;a++)this.__removeObject(t.children[a])},l.prototype.getWebGLObjects=function(e,t){var i=this.__webglObjects[e&&"main"!==e?e:this.defaultRenderList];return i?i.getObjects(t):[]},l.prototype.flagAsGSSOInvalidated=function(e){if(null!==e)for(var t=this._cullingSystems,i=0;i<t.length;i++){var r=t[i];for(var n in r.objectManagers){var a=r.objectManagers[n].list.idMap;if(a.has(e))for(var s=a.get(e),o=0;o<s.length;o++)r.objectManagers[n].list.objects[s[o]].invalidated=!0}}},l.prototype.flagAsFrustumCulled=function(e,t){if(null!==e){var i=this.__webglObjectsAll;if(null!==i){var r=i.idMap;if(r.has(e))for(var n=r.get(e),a=0;a<n.length;a++)i.objects[n[a]].frustumCulled=t}}},l.prototype.getNbWebGLObjects=function(e){return this.__webglObjects?this.getWebGLObjects(e,0).length:0},l.prototype.getAllWebGLObjects=function(e){return this.__webglObjectsAll.getObjects(e)},l.prototype.getNbAllWebGLObjects=function(){return this.__webglObjects?this.getAllWebGLObjects(0).length:0},l.prototype.computeLightsKey=function(){for(var e=this.__lights,t={dirLights:0,dirIBLLights:0,dirPhongLights:0,pointLights:0,spotLights:0,sphereLights:0,areaLights:0,diskLights:0,tubeLights:0,iesLights:0,key:0},i={dirLight:0,dirIBLLight:0,spotLight:0,tex2d:0,texCube:0},r=e.length,n=0;n<r;n++){var a=e[n];a.onlyShadow||(a.allocate(t),a.castShadow&&a.allocateShadows(null,i))}var s=t.iesLights;return s=16*(s=16*(s=16*(s=16*(s=16*(s=16*(s=16*(s=16*(s=16*(s=16*(s=16*(s=16*(s=16*s+t.pointLights)+t.spotLights)+t.dirLights)+t.dirIBLLights)+t.dirPhongLights)+t.areaLights)+t.sphereLights)+t.diskLights)+t.tubeLights)+i.texCube)+i.spotLight)+i.dirLight)+i.dirIBLLight,t.key=s,t};const c=["main"],h=s.WebGLObjectCullingStatus,u=a.__WebGLObject,d=a.__WebGLObjectNoPoints,p=a.__WebGLObjectCurvedPipe,f=a.__WebGLObjectFixedSize;function m(e,t,i,r){var n,s,o=e.__webglObjects,l=e.__webglObjectsAll,m=e._cullingSystems,g=null;r||(r=c);var v=null;for(v=i.isCurvedPipe?new p(t,i):i._ratioData&&i._ratioData.ratio>0?new f(t,i):i.hasPoint?new u(t,i):new d(t,i),n=0;n<r.length;n++){o[s=r[n]]||(o[s]=new a),o[s].add(v);for(var S=0;S<m.length;S++){(g=m[S]).objectManagers[s]||(g.objectManagers[s]={list:new a,frame:-1});var _=new h(v);g.objectManagers[s].list.add(_),g.objectManagers[s].frame=-2}}l.add(v)}function g(t,i,r){var n,a,s=t.object,o=t.passes,l=!1;s.__webglActive===i?l=!0:s.__webglActive instanceof Array&&s.__webglActive.indexOf(i)>=0&&(l=!0);var c=null;if(!l){var h=!0;if(s instanceof e.Mesh){if(1===(a=s.geometry)._type)m(i,a,s,o);else if(2===a._type||a.length>=0)m(i,a,s,o);else if(0===a._type)for(n in a.geometryGroups)m(i,a.geometryGroups[n],s,o)}else s instanceof e.Line||s instanceof e.ParticleSystem?m(i,a=s.geometry,s,o):s instanceof e.Sprite?(i.__webglSprites.push(s),h=!1):s instanceof e.CSS2DNode?m(i,null,s,["css2d"]):s instanceof e.CSS3DNode&&m(i,null,s,["css3d"]);s.__webglActive?s.__webglActive instanceof Array?s.__webglActive.push(i):s.__webglActive=[s.__webglActive,i]:s.__webglActive=i,r&&(c=h?i.__webglObjectsAll.objects[i.__webglObjectsAll.objects.length-1]:{object:s})}return c}function v(t,i,r){t instanceof e.Mesh||t instanceof e.ParticleSystem||t instanceof e.Line||t instanceof e.CSS2DNode||t instanceof e.CSS3DNode?(r&&function(e,t){var i,r=e.__webglObjects,n=e.__webglObjectsAll;for(i in r)r[i].remove(t);n.remove(t);for(var a=e._cullingSystems,s=null,o=0;o<a.length;o++)for(i in(s=a[o]).objectManagers)s.objectManagers[i].list.remove(t),s.objectManagers[i].frame=-2}(i,t),t._removeFromAllStateSortingResults()):t instanceof e.Sprite&&function(e,t){for(var i=e.length-1;i>=0;i--)e[i]===t&&e.splice(i,1)}(i.__webglSprites,t);var n,a=t.__webglActive;a&&(a instanceof Array?(n=a.indexOf(i))<=0&&(a.splice(n,1),1===a.length&&(t.__webglActive=a[0])):t.__webglActive=!1)}return l.prototype.__processAddedObjects=function(e){var t=this;this.__objectsAdded.forEach(function(i,r,n){e({object:r,passes:i},t,!1,g)}),this.__objectsAdded.clear()},l.prototype.__processUpdatedObjects=function(e){var t=this;this.__objectsUpdated.forEach(function(i,r,n){v(r,t,!0),e({object:r,passes:i},t,!0,g)}),this.__objectsUpdated.clear()},l.prototype.__processRemovedObjects=function(e){var t=this;e.removeGeometryList(this.__objectsRemoved),this.__objectsRemoved.forEach(function(e,i,r){v(e,t,!1)}),function(e){var t,i=e.__webglObjects,r=e.__webglObjectsAll,n=e.__objectsRemoved;for(t in i)i[t].removeCollection(n);r.removeCollection(n);for(var a=e._cullingSystems,s=null,o=0;o<a.length;o++)for(t in(s=a[o]).objectManagers)s.objectManagers[t].list.removeCollection(n),s.objectManagers[t].frame=-2}(this),this.__objectsRemoved.clear()},l}),define("DS/Materials/ShaderMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/OldInfraMaterial","DS/Materials/PDSFXData"],function(e,t,i){"use strict";var r=function(i){t.call(this),this.fragmentShader="void main() {}",this.vertexShader="void main() {}",this.uniforms={},this.defines={},this.attributes=null,this.shaderID=-1,this.shading=e.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.lights=!1,this.morphTargets=!1,this.morphNormals=!1,this.enableClipPlanes=!1,this.physical=!1,this.enableOIT=!0,this.uniformsList=null,this.numSupportedMorphTargets=0,this.numSupportedMorphNormals=0,this.map=null,this.setValues(i)};return(r.prototype=Object.create(t.prototype))._getTextures=function(e){var i=t.prototype._getTextures.call(this,e);return i=i.concat([this.map])},r.prototype.getType=function(){return"Custom"},r.prototype.getPredefinedMaterial=function(e,t,i){return this},r.prototype.clone=function(i){var n=void 0!==i?i:new r;return t.prototype.clone.call(this,n),n.fragmentShader=this.fragmentShader,n.vertexShader=this.vertexShader,n.uniforms=e.UniformsUtils.clone(this.uniforms),n.attributes=this.attributes,n.defines=this.defines,n.shading=this.shading,n.wireframe=this.wireframe,n.wireframeLinewidth=this.wireframeLinewidth,n.lights=this.lights,n.morphTargets=this.morphTargets,n.morphNormals=this.morphNormals,n.physical=this.physical,n.enableOIT=this.enableOIT,n.uniformsList=this.uniformsList,n.numSupportedMorphTargets=this.numSupportedMorphTargets,n.numSupportedMorphNormals=this.numSupportedMorphNormals,n.map=this.map,n},r.prototype.activatePDSFX=function(e){e=e||{},this._PDSFXData=new i,this._PDSFXData.PDSFX=!0,this._setDefaultPDSFXOverridableFunctions(),this._PDSFXData.PDSFX_hasOpacity=!0},r.prototype.getPickingMaterial=function(){var t=e.UniformsUtils.mergeNoClone([this.uniforms]),i=this.clone();return i.fragmentShader=e._DeferredShaders.PickingFragment.fragmentShader,i.uniforms=t,i.uniforms.pickingColor={type:"c",value:new e.Color},i.vertexColors=this.vertexColors,{pickingMaterial:i,pickingMaterialInstancing:null}},r.prototype.getTexCoordMaterial=function(){return this.getInvisibleMaterial()},r.prototype._dump=function(){throw"Unsupported operation"},r}),define("DS/Materials/ShaderMaterialDS",["DS/Mesh/ThreeJS_Base","DS/Materials/ShaderMaterial","DS/MaterialLibs/GenericLib"],function(e,t,i){"use strict";var r=function(i){console.error("ShaderMaterialDS is deprecated, please use a usual material (Basic, DSPBR19x, LineBasic, ...) with PDSFX instead."),this.vertexShaderPars="",this.fragmentShaderPars="",this.vertexShaderBody="",this.fragmentShaderBody="",this.originalMaterialRef=null,this.needTangentBinormal=!1,t.call(this,i),this.enableOIT&&(this.vertexShaderPars=[this.vertexShaderPars,e.DeferredShaderChunk.oit_pars_vertex].join("\n"),this.vertexShaderBody=[this.vertexShaderBody,e.DeferredShaderChunk.oit_vertex].join("\n"),this.fragmentShaderPars=[this.fragmentShaderPars,e.DeferredShaderChunk.oit_pars_fragment].join("\n"),this.fragmentShaderBody=[this.fragmentShaderBody,e.DeferredShaderChunk.oit_fragment].join("\n")),this.update()};return(r.prototype=Object.create(t.prototype)).clone=function(){var e=new r;return t.prototype.clone.call(this,e),e.vertexShaderPars=this.vertexShaderPars,e.fragmentShaderPars=this.fragmentShaderPars,e.vertexShaderBody=this.vertexShaderBody,e.fragmentShaderBody=this.fragmentShaderBody,e.originalMaterialRef=this,e.needTangentBinormal=this.needTangentBinormal,e},r.prototype.requireTangentBinormal=function(){return this.needTangentBinormal},r.prototype.setShaders=function(e,t,i,r){this.vertexShaderPars=e,this.fragmentShaderPars=i,this.vertexShaderBody=t,this.fragmentShaderBody=r,this.update()},r.prototype.update=function(){var e="";e=[e,this.vertexShaderPars,""].join("\n"),e+="void main() { \n",e+=this.vertexShaderBody,e+="\n",e+="}",this.vertexShader=e;var t="";t+="#if defined( NEEDS_UVTOUSE )\n",t+="vec2 uvToUse; \n",t=[t+="#endif \n",this.fragmentShaderPars,""].join("\n"),t+="void main() { \n",t+="#if defined( NEEDS_UVTOUSE )\n",t+="uvToUse=vUv; \n",t+="#endif \n",t+=this.fragmentShaderBody,t+="\n",t+="}",this.fragmentShader=t,this.needsUpdate=!0},r.prototype.updateDeferredMaterials=function(t){if(this.originalMaterialRef&&this.originalMaterialRef._deferredMaterialsInit){this._deferredMaterials[0]=this;for(var n=1;n<this.originalMaterialRef._deferredMaterials.length;n++)if(this.originalMaterialRef._deferredMaterials[n]instanceof r)for(var a in this._deferredMaterials[n]=this.originalMaterialRef._deferredMaterials[n].clone(),this._deferredMaterials[n].uniforms)a in this.uniforms&&(this._deferredMaterials[n].uniforms[a]=this.uniforms[a]);this._deferredMaterialsInit=!0}else{var s=e.UniformsUtils.mergeNoClone([this.uniforms,e.UniformsUtils.clone(e._DeferredShaders.Normal.uniforms)]),o=e.UniformsUtils.mergeNoClone([this.uniforms,e.UniformsUtils.clone(e._DeferredShaders.Depth.uniforms)]),l=e.UniformsUtils.mergeNoClone([this.uniforms,e.UniformsUtils.clone(e._DeferredShaders.NormalDepthIoRRoughness.uniforms)]),c=e.UniformsUtils.mergeNoClone([this.uniforms,e.UniformsUtils.clone(e._DeferredShaders.NormalDepth.uniforms)]),h=i.depthRGBA,u=e.UniformsUtils.mergeNoClone([this.uniforms,e.UniformsUtils.clone(h.uniforms)]),d=(e._mobileHighlight?e._AdvancedHighlightShaderSinglePass:e._AdvancedHighlightShader).HighlightFace,p=e.UniformsUtils.mergeNoClone([this.uniforms,e.UniformsUtils.clone(d.uniforms)]),f=e._DeferredShaders.PickingFragment,m=e.UniformsUtils.mergeNoClone([this.uniforms,e.UniformsUtils.clone(f.uniforms)]),g=this.defines?this.defines:{};if(this.map&&this.alphaTest){g.USE_MAP_ALPHATEST=!0,g.ALPHATEST=this.alphaTest.toFixed(5),s.map.value=this.map,o.map.value=this.map,l.map.value=this.map,c.map.value=this.map,u.map.value=this.map,p.map.value=this.map,m.map.value=this.map;var v=this.map.offset,S=this.map.repeat;s.offsetAlphaMap.value=v,s.repeatAlphaMap.value=S,o.offsetAlphaMap.value=v,o.repeatAlphaMap.value=S,l.offsetAlphaMap.value=v,l.repeatAlphaMap.value=S,c.offsetAlphaMap.value=v,c.repeatAlphaMap.value=S,u.offsetAlphaMap.value=v,u.repeatAlphaMap.value=S,p.offsetAlphaMap.value=v,p.repeatAlphaMap.value=S,m.offsetAlphaMap.value=v,m.repeatAlphaMap.value=S}var _=new r({uniforms:s,vertexShaderPars:[this.vertexShaderPars,e._DeferredShaders.Normal.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,e._DeferredShaders.Normal.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,e._DeferredShaders.Normal.fragmentShaderPars].join("\n"):e._DeferredShaders.Normal.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,e._DeferredShaders.Normal.fragmentShaderBody].join("\n"):e._DeferredShaders.Normal.fragmentShaderBody,shading:this.shading,defines:g,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:!1});this._deferredMaterials[e.MaterialToUse.normalMaterial]=_;var y=new r({uniforms:o,vertexShaderPars:[this.vertexShaderPars,e._DeferredShaders.Depth.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,e._DeferredShaders.Depth.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,e._DeferredShaders.Depth.fragmentShaderPars].join("\n"):e._DeferredShaders.Depth.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,e._DeferredShaders.Depth.fragmentShaderBody].join("\n"):e._DeferredShaders.Depth.fragmentShaderBody,defines:g,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:!1});this._deferredMaterials[e.MaterialToUse.depthMaterial]=y;var x=new r({uniforms:o,vertexShaderPars:[this.vertexShaderPars,e._DeferredShaders.DepthRGBA.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,e._DeferredShaders.DepthRGBA.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,e._DeferredShaders.DepthRGBA.fragmentShaderPars].join("\n"):e._DeferredShaders.DepthRGBA.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,e._DeferredShaders.DepthRGBA.fragmentShaderBody].join("\n"):e._DeferredShaders.DepthRGBA.fragmentShaderBody,defines:g,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:!1});this._deferredMaterials[e.MaterialToUse.depthRGBAMaterial]=x;var M=new r({uniforms:l,vertexShaderPars:[this.vertexShaderPars,e._DeferredShaders.NormalDepthIoRRoughness.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,e._DeferredShaders.NormalDepthIoRRoughness.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,e._DeferredShaders.NormalDepthIoRRoughness.fragmentShaderPars].join("\n"):e._DeferredShaders.NormalDepthIoRRoughness.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,e._DeferredShaders.NormalDepthIoRRoughness.fragmentShaderBody].join("\n"):e._DeferredShaders.NormalDepthIoRRoughness.fragmentShaderBody,shading:this.shading,defines:g,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:!1});this._deferredMaterials[e.MaterialToUse.normalDepthIoRRoughnessMaterial]=M;var P=new r({uniforms:c,vertexShaderPars:[this.vertexShaderPars,e._DeferredShaders.NormalDepth.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,e._DeferredShaders.NormalDepth.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,e._DeferredShaders.NormalDepth.fragmentShaderPars].join("\n"):e._DeferredShaders.NormalDepth.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,e._DeferredShaders.NormalDepth.fragmentShaderBody].join("\n"):e._DeferredShaders.NormalDepth.fragmentShaderBody,shading:this.shading,defines:g,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes});this._deferredMaterials[e.MaterialToUse.normalDepthMaterial]=P;var C=new r({uniforms:c,vertexShaderPars:[this.vertexShaderPars,e._DeferredShaders.DecalNormalStencilDepth.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,e._DeferredShaders.DecalNormalStencilDepth.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,e._DeferredShaders.DecalNormalStencilDepth.fragmentShaderPars].join("\n"):e._DeferredShaders.DecalNormalStencilDepth.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,e._DeferredShaders.DecalNormalStencilDepth.fragmentShaderBody].join("\n"):e._DeferredShaders.DecalNormalStencilDepth.fragmentShaderBody,shading:this.shading,defines:g,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes});this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepthMaterial]=C;var b=new r({uniforms:u,vertexShaderPars:[this.vertexShaderPars,h.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,h.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,h.fragmentShaderPars].join("\n"):h.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,h.fragmentShaderBody].join("\n"):h.fragmentShaderBody,shading:this.shading,defines:g,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:!1});this._deferredMaterials[e.MaterialToUse.shadowMapDepthMaterial]=b,this.copyPDSFXParameters(this._deferredMaterials[e.MaterialToUse.shadowMapDepthMaterial]);var D=new r({uniforms:p,defines:g,vertexShaderPars:[this.vertexShaderPars,d.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,d.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,d.fragmentShaderPars].join("\n"):d.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,d.fragmentShaderBody].join("\n"):d.fragmentShaderBody,blending:e.NoBlending,enableOIT:!1});D.side=e.DoubleSide,D.enableClipPlanes=this.enableClipPlanes,D.vertexColors=this.vertexColors,this._deferredMaterials[e.MaterialToUse.highlightMaterial]=D;var w=new r({uniforms:m,vertexShaderPars:[this.vertexShaderPars,f.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,f.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,f.fragmentShaderPars].join("\n"):f.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,f.fragmentShaderBody].join("\n"):f.fragmentShaderBody,shading:this.shading,defines:g,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:!1});if(w.uniforms.pickingColor={type:"c",value:new e.Color},w.wireframe=this.wireframe,w.vertexColors=this.vertexColors,this.isInstancingMaterial){var E=new r({uniforms:m,vertexShaderPars:[this.vertexShaderPars,f.vertexShaderPars,"varying vec3 vInstancePickingColor;"].join("\n"),vertexShaderBody:[this.vertexShaderBody,f.vertexShaderBody,e._DeferredShaders.Chunks.picking_instancing_vertex].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,f.fragmentShaderPars,"varying vec3 vInstancePickingColor;"].join("\n"):[f.fragmentShaderPars,"varying vec3 vInstancePickingColor;"].join("\n"),fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,f.fragmentShaderBody,e._DeferredShaders.Chunks.picking_instancing_fragment].join("\n"):[f.fragmentShaderBody,e._DeferredShaders.Chunks.picking_instancing_fragment].join("\n"),shading:this.shading,defines:g,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:!1});E.wireframe=this.wireframe,E.vertexColors=this.vertexColors,this._deferredMaterials[e.MaterialToUse.pickingMaterialInstancing]=E}else this._deferredMaterials[e.MaterialToUse.pickingMaterialInstancing]=null;this._deferredMaterials[e.MaterialToUse.pickingMaterial]=w,this._deferredMaterials[e.MaterialToUse.pickingMaterial].refreshUniforms=this.refreshUniforms,this._deferredMaterials[e.MaterialToUse.normalMaterial].refreshUniforms=this.refreshUniforms,this._deferredMaterials[e.MaterialToUse.depthMaterial].refreshUniforms=this.refreshUniforms,this._deferredMaterials[e.MaterialToUse.depthRGBAMaterial].refreshUniforms=this.refreshUniforms,null!==this._deferredMaterials[e.MaterialToUse.pickingMaterialInstancing]&&(this._deferredMaterials[e.MaterialToUse.pickingMaterialInstancing].refreshUniforms=this.refreshUniforms),this.updateGenericDeferredMaterials(t)}},r}),define("DS/Materials/ParticleBasicMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData","DS/Materials/DeferredCaches"],function(e,t,i,r){"use strict";var n=function(i){t.call(this),this.color=new e.Color(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.setValues(i)};return(n.prototype=Object.create(t.prototype))._getTextures=function(e){var i=t.prototype._getTextures.call(this,e);return i=i.concat([this.map])},n.prototype._shaderID="particle_basic",n.prototype._dump=function(){var e=t.prototype._dump.call(this);return e.color=this.color.toArray(),this.map&&(e.color="textured"),e.size=this.size,e},n.prototype.clone=function(){var e=new n;return t.prototype.clone.call(this,e),e.color.copy(this.color),e.map=this.map,e.size=this.size,e.sizeAttenuation=this.sizeAttenuation,e},n.prototype.getType=function(){return"Point"},n.prototype.activatePDSFX=function(e){e=e||{},this._PDSFXData=new i,this._PDSFXData.PDSFX=!0,this._setDefaultPDSFXOverridableFunctions(),this._PDSFXData.PDSFX_hasAlbedo=!0,this._PDSFXData.PDSFX_hasOpacity=!0},n.prototype._canUseLights=function(){return!1},n.prototype.loadUniforms=function(e,t,i,r,n,a){e.loadGASUniforms(t,this,i,r,null),i.scale&&t.uniform1f(i.scale,e.domElement.height/2),i.size&&t.uniform1f(i.size,this.size?this.size:1),i.map&&e.loadTexture(t,i.map,this.map)},n.prototype.getPredefinedMaterial=function(t,i,a){var s=this.getBaseId();switch(s+="Point",s+="S"+this.side,s+="CP"+this.enableClipPlanes,s+="Type"+i,i){case e.DefaultAppearanceMode.__QA_AUTOMATION__:if(s+="Col"+this.color.getHex(),s+="Op"+this._opacity,s="id"+(s+="SA"+this.sizeAttenuation).hashCode(),!r.PredefinedMaterials.has(s)){var o=new n({size:5,side:this.side,enableClipPlanes:this.enableClipPlanes,color:this.color,sizeAttenuation:this.sizeAttenuation,opacity:this._opacity});o.activatePDSFX();var l={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor.rgb = _DSalbedo_.rgb;","ioFinalColor.a = _DSopacity_;","#if defined(GAMMA_INPUT)","ioFinalColor.rgb = sqrt(ioFinalColor.rgb);","#endif","#if defined(GAMMA_OUTPUT)","ioFinalColor.rgb = sqrt(ioFinalColor.rgb);","#endif","}"].join("\n")};o.setPDSFXOverridableFunctions({},l);var c=new r.DeferredMaterial(o);r.PredefinedMaterials.set(s,c)}break;default:return this}return r.PredefinedMaterials.get(s).get(this)},n.prototype.__dimension=0,n.prototype.getZOnlyMaterial=function(){return this},n.prototype._defaultPDSFXOverridableFunctions=function(){var i=t.prototype._defaultPDSFXOverridableFunctions.call(this);return Object.assign(i.vertex,{ComputePointSize:e.ShaderChunk.PDSFXComputePointSize_VS}),i},n.prototype.updateDeferredMaterials=function(i){t.prototype.updateDeferredMaterials.call(this,i),this._deferredMaterials[e.MaterialToUse.shadowMapDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalDepthIoRRoughnessMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.oitAccumMaterial]=null,this._deferredMaterials[e.MaterialToUse.oitRevealMaterial]=null,this._deferredMaterials[e.MaterialToUse.texCoordMaterial]=null},n.prototype.targetPrimitiveType="POINTS",n.prototype.useClippingTolerance=!0,n}),define("DS/MaterialLibs/ParticleBasicLib",["DS/MaterialLibs/UniformsLib","DS/Shaders/DeferrableShaders","DS/Visualization/ShaderChunk","DS/Visualization/UniformsUtils","DS/Materials/ParticleBasicMaterial"],function(e,t,i,r,n){"use strict";var a=n.prototype.deferrable,s="",o="",l="",c="";return a&&(s=[t.depth_pars_vertex,t.picking_pars_vertex,t.picking_instancing_pars_vertex,t.highlight_pars_vertex].join("\n"),l=[t.depth_vertex,t.picking_vertex,t.picking_instancing_vertex,t.highlight_vertex].join("\n"),o=[t.picking_pars_fragment,t.picking_instancing_pars_fragment,t.depth_pars_fragment,t.highlight_pars_fragment].join("\n"),c=[t.picking_fragment,t.picking_instancing_fragment,t.depth_fragment,t.lineic_normal_fragment,t.highlight_fragment_point].join("\n")),{uniforms:r.merge([e.particle,e.clipPlanes,e.postprocess,a?e.deferred:{}]),vertexShader:["#define PARTICLEBASIC","uniform float size;","uniform float scale;","#ifdef PDSFX_USE_MAP","varying vec2 vUv;","#endif",i.clip_pars_vertex,i.color_pars_vertex,i.fog_pars_vertex,t.oit_pars_vertex,s,"void main() {",i.PDSFX_start_particle_vertex,i.PDSFX_start_vertex,i.color_vertex,i.default_vertex,i.PDSFX_point_size_vertex,i.worldpos_vertex,i.clip_vertex,i.fog_vertex,t.oit_vertex_point,l,i.PDSFX_end_vertex,"#ifdef PDSFX_USE_MAP","vUv = uv;","#endif","}"].join("\n"),fragmentShader:["#define PARTICLEBASIC","#if defined(SELECTION_MATERIAL) && !defined(ALPHATEST)","#define ALPHATEST 0.01","#endif",i.PDSFX_albedo_pars_fragment,i.PDSFX_opacity_pars_fragment,"uniform float size;","#ifdef PDSFX_USE_MAP","varying vec2 vUv;","#endif",i.clip_pars_fragment,i.color_pars_fragment,i.fog_pars_fragment,"#ifdef USE_MAP","uniform sampler2D map;","#endif",t.oit_pars_fragment,i.postprocess_pars_fragment,o,"void main() {","#ifdef PDSFX","_DSsize_ = size;",i.PDSFX_map_fragment,"ComputeCommonValues();",i.PDSFX_discard_fragment,i.PDSFX_albedo_fragment,i.PDSFX_opacity_fragment,"#endif","#if defined(SELECTION_MATERIAL)","gl_FragColor = vec4( diffuse, 1.0 );","#else","gl_FragColor = vec4( diffuse, opacity );","#endif",i.clip_fragment,"#ifdef USE_MAP","vec4 texelColor = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );","#if defined(GAMMA_INPUT) && !defined(USE_MAP_HDR)","texelColor.rgb = convertToLinear(texelColor.rgb);","#endif","gl_FragColor = gl_FragColor * texelColor;","#endif",i.alphatest_fragment,i.color_fragment,i.postprocess_fragment,i.linear_to_gamma_fragment,i.PDSFX_end_fragment,i.fog_fragment,i.backgroundviewmode_lowlight_fragment,t._debug_common_lineic_fragment,t.oit_fragment_point,c,"}"].join("\n")}}),define("DS/GPUFormats/WebGLRenderTargetCube",["DS/GPUFormats/WebGLRenderTarget"],function(e){"use strict";var t=function(t,i,r){e.call(this,t,i,r),this.activeCubeFace=0};return t.prototype=Object.create(e.prototype),t}),define("DS/GPUFormats/DataTexture",["DS/Mesh/ThreeJS_Base","DS/GPUFormats/Texture"],function(e,t){"use strict";var i=function(e,i,r,n,a,s,o,l,c,h,u){t.call(this,{data:e,width:i,height:r},s,o,l,c,h,n,a,u)};return(i.prototype=Object.create(t.prototype)).clone=function(){var e=new i;return t.prototype.clone.call(this,e),e},i.prototype._sendTextureToGPU=function(e,t,i,r,n,a,s,o){a.data?i?console.error("Error: DataTexture can't be a compressed format"):e.texImage2D(t,r,n,a.width,a.height,0,s,o,a.data):console.error("Error: wrong DataTexture usage, no data found")},i}),define("DS/VisuDataAccess/Ox4StreamUnStreamerTask",["DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(e){"use strict";return function(t,i){var r=t,n=i;this.run=function(t,i,a,s,o){for(var l=new e,c=t.findNodeByType(r.typeRequested()),h=0,u=0;u<c.length;u++)!function(e){var i=new Array;if(null!=e.ticketRequest)i.push(e.ticketRequest),delete e.ticketRequest;else if(null!=e.ticketRequests)for(var a=e.ticketRequests,o=0;o<a.length;o++)i.push(a[o]);r.streamsNumber(i.length),h+=i.length;for(var c=0;c<i.length;c++)if(window.hasOwnProperty("ODTNoFCSCalls")&&window.ODTNoFCSCalls)h--,r.streamReceived(e,null,t);else{var u=i[c].generateRequest();l.asyncTransformFCSUrlIntoRealUrl(u,n.rawmode,function(i,n){if("posthttp"==n.slice(0,8)){var a=n.indexOf(":postparams:"),o=n.slice(9,a),c=n.slice(a+12,n.length),u=new Object;null!=r.responseType&&(console.log("registering otherParams reponsetype "+r.responseType),u.responseType=r.responseType),l.executePostHttpRequest2(o,"application/x-www-form-urlencoded",c,function(i){r.streamReceived(e,i,t),0==--h&&s(this)},u)}})}}(c[u]);0==h&&s(this)}}}),define("DS/RenderEngineUtils/StateSortingResult",["DS/Mesh/ThreeJS_Base","DS/RenderEngineUtils/DisplayList"],function(e,t){"use strict";var i=null,r=null;e.displayListPriorityEnum={},e.displayListPriorityEnum.dlSolids=71,e.displayListPriorityEnum.dlSurfaces=70,e.displayListPriorityEnum.dlSurfacesCurvedPipes=69,e.displayListPriorityEnum.dlSurfacesCurvedPipesTranspar=68,e.displayListPriorityEnum.dlEdges=67,e.displayListPriorityEnum.dlBack=66,e.displayListPriorityEnum.dlPoints=65,e.displayListPriorityEnum.dlDecals=64,e.displayListPriorityEnum.dlTranspar1D=63,e.displayListPriorityEnum.dlTranspar=62,e.displayListPriorityEnum.dlEdgeAdjacenceSelection=61,e.displayListPriorityEnum.dlEdgePrimitiveSelection=60,e.displayListPriorityEnum.dlPointPrimitiveSelection=59,e.displayListPriorityEnum.dlNoZ=58,e.displayListPriorityEnum.dlNoZTranspar=57,e.displayListPriorityEnum.dlDepthValue=56,e.displayListPriorityEnum.dlDepthValue2=55,e.displayListPriorityEnum.OTHER3D_2DMODE=54,e.displayListPriorityEnum.OTHER3D=36,e.displayListPriorityEnum.priority0=53,e.displayListPriorityEnum.priority1=51,e.displayListPriorityEnum.priority2=49,e.displayListPriorityEnum.priority3=47,e.displayListPriorityEnum.priority4=45,e.displayListPriorityEnum.priority5=43,e.displayListPriorityEnum.priority6=41,e.displayListPriorityEnum.priority7=39,e.displayListPriorityEnum.priority8=37,e.displayListPriorityEnum.priority9=34,e.displayListPriorityEnum.priority10=32,e.displayListPriorityEnum.priority11=30,e.displayListPriorityEnum.priority12=28,e.displayListPriorityEnum.priority13=26,e.displayListPriorityEnum.priority14=24,e.displayListPriorityEnum.priority15=22,e.displayListPriorityEnum.priorityP0=52,e.displayListPriorityEnum.priorityP1=50,e.displayListPriorityEnum.priorityP2=48,e.displayListPriorityEnum.priorityP3=46,e.displayListPriorityEnum.priorityP4=44,e.displayListPriorityEnum.priorityP5=42,e.displayListPriorityEnum.priorityP6=40,e.displayListPriorityEnum.priorityP7=38,e.displayListPriorityEnum.priorityP8=35,e.displayListPriorityEnum.priorityP9=33,e.displayListPriorityEnum.priorityP10=31,e.displayListPriorityEnum.priorityP11=29,e.displayListPriorityEnum.priorityP12=27,e.displayListPriorityEnum.priorityP13=25,e.displayListPriorityEnum.priorityP14=23,e.displayListPriorityEnum.priorityP15=21,e.displayListPriorityEnum.HEDGE=20,e.displayListPriorityEnum.HOTHER=19,e.displayListPriorityEnum.FURTIVE_EDGE=18,e.displayListPriorityEnum.FURTIVE=17,e.displayListPriorityEnum.OTHER2D=16,e.displayListPriorityEnum.TRANSPAR2DP15=15,e.displayListPriorityEnum.TRANSPAR2DP14=14,e.displayListPriorityEnum.TRANSPAR2DP13=13,e.displayListPriorityEnum.TRANSPAR2DP12=12,e.displayListPriorityEnum.TRANSPAR2DP11=11,e.displayListPriorityEnum.TRANSPAR2DP10=10,e.displayListPriorityEnum.TRANSPAR2DP9=9,e.displayListPriorityEnum.TRANSPAR2DP8=8,e.displayListPriorityEnum.TRANSPAR2DP7=7,e.displayListPriorityEnum.TRANSPAR2DP6=6,e.displayListPriorityEnum.TRANSPAR2DP5=5,e.displayListPriorityEnum.TRANSPAR2DP4=4,e.displayListPriorityEnum.TRANSPAR2DP3=3,e.displayListPriorityEnum.TRANSPAR2DP2=2,e.displayListPriorityEnum.TRANSPAR2DP1=1,e.displayListPriorityEnum.TRANSPAR2DP0=0,e.displayListPriorityEnum.priority=[e.displayListPriorityEnum.priority0,e.displayListPriorityEnum.priority1,e.displayListPriorityEnum.priority2,e.displayListPriorityEnum.priority3,e.displayListPriorityEnum.priority4,e.displayListPriorityEnum.priority5,e.displayListPriorityEnum.priority6,e.displayListPriorityEnum.priority7,e.displayListPriorityEnum.priority8,e.displayListPriorityEnum.priority9,e.displayListPriorityEnum.priority10,e.displayListPriorityEnum.priority11,e.displayListPriorityEnum.priority12,e.displayListPriorityEnum.priority13,e.displayListPriorityEnum.priority14,e.displayListPriorityEnum.priority15],e.displayListPriorityEnum.priorityP=[e.displayListPriorityEnum.priorityP0,e.displayListPriorityEnum.priorityP1,e.displayListPriorityEnum.priorityP2,e.displayListPriorityEnum.priorityP3,e.displayListPriorityEnum.priorityP4,e.displayListPriorityEnum.priorityP5,e.displayListPriorityEnum.priorityP6,e.displayListPriorityEnum.priorityP7,e.displayListPriorityEnum.priorityP8,e.displayListPriorityEnum.priorityP9,e.displayListPriorityEnum.priorityP10,e.displayListPriorityEnum.priorityP11,e.displayListPriorityEnum.priorityP12,e.displayListPriorityEnum.priorityP13,e.displayListPriorityEnum.priorityP14,e.displayListPriorityEnum.priorityP15];var n=0,a=function(t,a){null===i&&(i=e.Constants,r=e.MaterialToUse),this.id=n++,this._displayLists=[],this._resetGSSOCacheIndex=-1,this._pickingPriorityMapping=null,this.pass=t,this.materialToUse=a,this.overridableMaterial=a===r.originalMaterial||a===r.oitAccumMaterial||a===r.oitRevealMaterial||a===r.transparentShadowMaterial||a===r.ZOnlyMaterial};return a.prototype.init=function(){for(var r=new t({name:"SOLID",priority:e.displayListPriorityEnum.dlSolids,zSort:e.FrontToBack,side:i.FrontSide,polygonOffset:!0}),n=new t({name:"SURFACE",priority:e.displayListPriorityEnum.dlSurfaces,zSort:e.FrontToBack,side:i.DoubleSide,polygonOffset:!0}),a=new t({name:"EDGE",priority:e.displayListPriorityEnum.dlEdges,zSort:e.FrontToBack,side:i.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1}),s=new t({name:"SURFACE_CURVED_PIPE",priority:e.displayListPriorityEnum.dlSurfacesCurvedPipes,zSort:e.FrontToBack,side:e.DoubleSide,polygonOffset:!0}),o=new t({name:"SURFACE_CURVED_PIPE_TRANSPAR",priority:e.displayListPriorityEnum.dlSurfacesCurvedPipesTranspar,zSort:e.BackToFront,side:i.DoubleSide,polygonOffset:!0,depthWrite:!1,hasTranspar:!0,canOIT:!0,hasOcclusionDepth:!1}),l=new t({name:"BACK",priority:e.displayListPriorityEnum.dlBack,zSort:e.FrontToBack,side:i.DoubleSide,polygonOffset:!0,depthWrite:!1,depthFunc:"GREATER",canOIT:!0,hasPoliteDepth:!1,hasOcclusionDepth:!1}),c=new t({name:"POINT",priority:e.displayListPriorityEnum.dlPoints,zSort:e.FrontToBack,side:i.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1}),h=new t({name:"DECALS",priority:e.displayListPriorityEnum.dlDecals,zSort:e.FrontToBack,side:i.DoubleSide,polygonOffset:!0,hasTranspar:!0,hasDecal:!0,hasPoliteDepth:!1,hasOcclusionDepth:!1,canOIT:!0}),u=new t({name:"TRANSPAR1D",priority:e.displayListPriorityEnum.dlTranspar1D,zSort:e.BackToFront,side:i.DoubleSide,polygonOffset:!0,depthWrite:!1,hasTranspar:!0,canOIT:!0,hasOcclusionDepth:!1}),d=new t({name:"TRANSPAR",priority:e.displayListPriorityEnum.dlTranspar,zSort:e.BackToFront,side:i.DoubleSide,polygonOffset:!0,depthWrite:!1,hasTranspar:!0,canOIT:!0,hasOcclusionDepth:!1,canForceSideOnSolids:!0}),p=new t({name:"EDGEADJACENCESELECTION",priority:e.displayListPriorityEnum.dlEdgeAdjacenceSelection,zSort:e.FrontToBack,side:i.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1,depthTest:!1}),f=new t({name:"EDGEPRIMITIVESELECTION",priority:e.displayListPriorityEnum.dlEdgePrimitiveSelection,zSort:e.FrontToBack,side:i.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1,depthTest:!1}),m=new t({name:"POINTPRIMITIVESELECTION",priority:e.displayListPriorityEnum.dlPointPrimitiveSelection,zSort:e.FrontToBack,side:i.DoubleSide,polygonOffset:!1,hasOcclusionDepth:!1,depthTest:!1}),g=new t({name:"NOZ",priority:e.displayListPriorityEnum.dlNoZ,zSort:e.FrontToBack,side:i.DoubleSide,polygonOffset:!0,clearDepth:!0,hasPoliteDepth:!1,noz:!0,hasOcclusionDepth:!1}),v=new t({name:"DEPTHVALUE2",priority:e.displayListPriorityEnum.dlDepthValue2,zSort:e.BackToFront,side:i.DoubleSide,hasPoliteDepth:!1,depthTest:!1,noz:!0,neverSort:!0,hasOcclusionDepth:!1}),S=new t({name:"DEPTHVALUE",priority:e.displayListPriorityEnum.dlDepthValue,zSort:e.FrontToBack,side:i.DoubleSide}),_=new t({name:"NOZTRANSPAR",priority:e.displayListPriorityEnum.dlNoZTranspar,zSort:e.BackToFront,side:i.DoubleSide,polygonOffset:!0,hasPoliteDepth:!1,noz:!0,hasOcclusionDepth:!1}),y=new t({name:"OTHER2D",priority:e.displayListPriorityEnum.OTHER2D,zSort:e.FrontToBack,side:i.DoubleSide}),x=0;x<16;x++){var M=new t({name:"NOZPRIORITY"+x,priority:e.displayListPriorityEnum.priority[x],zSort:e.FrontToBack,side:i.DoubleSide,polygonOffset:!0,depthTest:!1,hasOcclusionDepth:!0,hasPoliteDepth:!1,sortByGLType:!0,noz:!0});this.addDisplayList(M)}for(x=0;x<16;x++){M=new t({name:"NOZPRIORITYP"+x,priority:e.displayListPriorityEnum.priorityP[x],zSort:e.FrontToBack,side:i.DoubleSide,polygonOffset:!0,depthTest:!0,depthFunc:"ALWAYS",hasOcclusionDepth:!0,hasPoliteDepth:!1,sortByGLType:!0,noz:!0});this.addDisplayList(M)}for(x=0;x<16;x++){M=new t({name:"TRANSPAR2DP"+x,priority:e.displayListPriorityEnum.TRANSPAR2DP0+1,zSort:e.BackToFront,side:i.DoubleSide,polygonOffset:!0,depthTest:!0,depthFunc:"ALWAYS",hasTranspar:!0,canOIT:!0,hasOcclusionDepth:!1,canForceSideOnSolids:!0});this.addDisplayList(M)}this.addDisplayList(r),this.addDisplayList(n),this.addDisplayList(s),this.addDisplayList(o),this.addDisplayList(a),this.addDisplayList(l),this.addDisplayList(c),this.addDisplayList(h),this.addDisplayList(d),this.addDisplayList(u),this.addDisplayList(p),this.addDisplayList(f),this.addDisplayList(m),this.addDisplayList(g),this.addDisplayList(_),this.addDisplayList(y),this.addDisplayList(S),this.addDisplayList(v)},a.prototype.addDisplayList=function(t){var i,r=!1;if(this._displayLists.length&&void 0!==t.priority)for(i=0;i<this._displayLists.length&&!r;i++){var n=this._displayLists[i].priority;t.priority>n&&(this.insertDisplayList(t,i),r=!0)}for(r||this._displayLists.push(t),i=0;i<this._displayLists.length;i++)this._displayLists[i].index=i;return t.ssrId=this.id,t.ssr=this,t.zSort===e.BackToFront&&(t.mustZSort=!0),t},a.prototype.insertDisplayList=function(e,t){this._displayLists.splice(t,0,e)},a.prototype.getDisplayListByPriority=function(e){for(var t=0;t<this._displayLists.length;t++)if(this._displayLists[t].priority===e)return this._displayLists[t];return null},a.prototype.getDisplayListByName=function(e){for(var t=0;t<this._displayLists.length;t++)if(this._displayLists[t].name===e)return this._displayLists[t];return null},a}),define("DS/RenderEngineUtils/RenderEngineUtils",["DS/RenderEngineUtils/StateSortingResult","DS/RenderEngineUtils/DisplayList","DS/RenderEngineUtils/InheritanceSolver","DS/RenderEngineUtils/StateSortingCacheItem"],function(e,t,i,r){"use strict";return{StateSortingResult:e,DisplayList:t,InheritanceSolver:i,StateSortingCacheItem:r}}),define("DS/Visualization/SectionBuilder",["DS/Mesh/Mesh"],function(e){"use strict";var t;function i({geom:e,index_ranges:t,plane:i,deduplication:r=null}){const n=e.vertexPositionArray;function a(e){const t=3*e;return i.x*n[t]+i.y*n[t+1]+i.z*n[t+2]+i.w}const s=[];function o(e){const t=3*e;s.push(n[t],n[t+1],n[t+2])}function l(e,t,i){const r=3*e,a=3*t,o=(1-i)*n[r]+i*n[a],l=(1-i)*n[r+1]+i*n[a+1],c=(1-i)*n[r+2]+i*n[a+2];s.push(o,l,c)}const c=e.vertexIndexArray,h=r?e=>r[c[e]]:e=>c[e];for(let e=0;e<t.length;e++){const i=t[e][0],r=t[e][1];for(let e=i;e<r;e+=3){const t=h(e),i=h(e+1),r=h(e+2),n=a(t),s=a(i),c=a(r),u=n*s<=0?-n/(s-n):null,d=s*c<=0?-s/(c-s):null,p=c*n<=0?-c/(n-c):null;if(null===u&&null===d&&null===p)continue;let f=!1;Number.isNaN(u)&&(o(t),o(i),f=!0),Number.isNaN(d)&&(o(i),o(r),f=!0),Number.isNaN(p)&&(o(r),o(t),f=!0),f||(null!==u&&u<1&&l(t,i,u),null!==d&&d<1&&l(i,r,d),null!==p&&p<1&&l(r,t,p))}}return new Float32Array(s)}function r(e,t){const i=e.length;for(let r=0;r<i;r+=3)e[r]+=t.x,e[r+1]+=t.y,e[r+2]+=t.z}function n({renderable:n,clipPlanes:a,sectionLines:s,lineWidth:o=1,color:l="#000000",visibleSpace:c}){if(0===a.length)return null;const h=(new t.Matrix4).copy(n.matrixWorld).transpose(),u=a.map(e=>new t.Vector4(e.normal.x,e.normal.y,e.normal.z,e.constant).applyMatrix4(h)),d=function(e,i){let r=new Map;function n(e,t,i){const n=r.get(e);n?n.push([t,t+i]):r.set(e,[[t,t+i]])}if(e.layer)for(let r=0;r<e.layer.layers.length;r++){const a=e.layer.layers[r].drawableGroup;if(a._geomType!==t.GeomTypeEnum.FACE)continue;const s=e.layer.layers[r].drawableInterval;s.skip(e,i)||n(a.geometry,s.start,s.count)}else{const i=e.geometry.length;for(let r=0;r<i;r++){const i=e.geometry[r];for(let e=0;e<i.drawingGroups.length;e++){const r=i.drawingGroups[e];r._geomType===t.GeomTypeEnum.FACE&&n(i,r.start,r.count)}}}return r}(n,c),p=[];d.forEach((e,n)=>{const a=function({geom:e,index_ranges:n,planes:a,clipPlanes:s,sectionLines:o,deduplication:l=null}){const c=[];for(let s=0;s<a.length;s++)if(o[s]){const o=a[s],h=i({geom:e,index_ranges:n,plane:o,deduplication:l});r(h,new t.Vector3(o.x,o.y,o.z).normalize().multiplyScalar(5e-4)),c.push(h)}else c.push([]);const h=[];for(let e=0;e<c.length;e++){const t=c[e];let i=t.length;for(let r=0;r<a.length;r++){if(r===e)continue;const n=a[r];let s=0;for(let e=0;e<i;e+=6){const i=t[e],r=t[e+1],a=t[e+2],o=t[e+3],l=t[e+4],c=t[e+5],h=n.x*i+n.y*r+n.z*a+n.w,u=n.x*o+n.y*l+n.z*c+n.w;let d=null;h*u<=0?0==(d=-h/(u-h))&&u<0?d=null:1===d&&h<0&&(d=null):h>0&&(d=NaN),Number.isNaN(d)?s!==e?(t[s++]=i,t[s++]=r,t[s++]=a,t[s++]=o,t[s++]=l,t[s++]=c):s+=6:null!==d&&(t[s++]=(1-d)*i+d*o,t[s++]=(1-d)*r+d*l,t[s++]=(1-d)*a+d*c,h>0?(t[s++]=i,t[s++]=r,t[s++]=a):(t[s++]=o,t[s++]=l,t[s++]=c))}i=s}0!==i&&h.push(t.subarray(0,i))}return h}({geom:n,index_ranges:e=function(e){if(e.length<2)return e;e.sort((e,t)=>e[0]-t[0]);let t=0;for(let i=1;i<e.length;i++){const r=e[t],n=e[i];n[0]>r[1]?e[++t]=n:n[1]>r[1]&&(r[1]=n[1])}return e.length=t+1,e}(e),planes:u,sectionLines:s});p.push(...a)});let f=0;for(let e=0;e<p.length;e++)f+=p[e].length;const m=new Float32Array(f);let g=0;for(let e=0;e<p.length;e++)m.set(p[e],g),g+=p[e].length;let v=[];for(let e=0;e<f/3;e++)v.push(e);v=new Uint32Array(v);const S=new t.BufferGeometryDS;S.vertexPositionArray=m,S.vertexIndexArray=v,S.boundingSphere=n.boundingSphere,S.boundingBox=n.boundingBox;const _=new t.LineBasicMaterial({color:l,lineWidth:o,force:!0});_.enableClipPlanes=!1,_.side=t.DoubleSide,_.polygonOffset=!0,_.polygonOffsetFactor=-1.5,_.polygonOffsetUnits=-10;const y={start:0,count:S.vertexIndexArray.length},x=new e.DrawingGroup(_,_,1,0,S.vertexIndexArray.length,[y],void 0,0);return S.drawingGroups=[x],x.geometry=S,S}var a=function(e){for(var t=1;t<e;)t*=2;return t};return class{constructor({renderable:e,renderer:i,lineWidth:r,color:n,clipPlanes:a,sectionLines:s}){t=THREEDS.Core,this._color=new t.Color(n||0),this.lineWidth=r||1,this.wide=this.lineWidth>1,this._renderable=e,this.clipPlanes=a,this.sectionLines=this.computeInternalSectionLineArray(a,s),this.resetBuffers(),this.renderer=i,this.sectionLineGeometry=null}resetBuffers(){this.indexArray=null,this.currentsArray=null,this.edgeLastIndexArray=null,this._Id=0,this._edgeId=0,this.halfEdges=[],this.halfEdgesStructure=null,this._positionArray=null}allocateArrays(e){if(this.wide){this.indexArray=new Uint32Array(3*e*2);var t=6*e;this.currentsArray=new Float32Array(2*t),this.edgeLastIndexArray=new Float32Array(6*e*2)}else this.indexArray=new Uint32Array(2*e),t=6*e,this.currentsArray=new Float32Array(t),this.edgeLastIndexArray=new Float32Array(6*e)}addEdgeIndices(e,t,i){var r=this.indexArray,n=this.currentsArray,a=this.edgeLastIndexArray,s=this._edgeId;if(this.wide){var o=4*s,l=4*s+1,c=4*s+2,h=4*s+3;r[6*s]=o,r[6*s+1]=c,r[6*s+2]=h,r[6*s+3]=o,r[6*s+4]=h,r[6*s+5]=l,n[12*s]=e,n[12*s+1]=t,n[12*s+2]=i,n[12*s+3]=e,n[12*s+3+1]=t,n[12*s+3+2]=i,n[12*s+6]=t,n[12*s+6+1]=i,n[12*s+6+2]=e,n[12*s+9]=t,n[12*s+9+1]=i,n[12*s+9+2]=e,a[12*s]=1,a[12*s+1]=1,a[12*s+2]=0,a[12*s+3]=1,a[12*s+3+1]=-1,a[12*s+3+2]=0,a[12*s+6]=-1,a[12*s+6+1]=1,a[12*s+6+2]=0,a[12*s+9]=-1,a[12*s+9+1]=-1,a[12*s+9+2]=0}else r[2*s]=2*s,r[2*s+1]=2*s+1,n[6*s]=e,n[6*s+1]=t,n[6*s+2]=i,n[6*s+3]=t,n[6*s+4]=i,n[6*s+5]=e,a[6*s]=1,a[6*s+1]=0,a[6*s+2]=0,a[6*s+3]=-1,a[6*s+4]=0,a[6*s+5]=0;this._edgeId++}processTriangleIndices(e,t,i){this.addEdgeIndices(e,t,i),this.addEdgeIndices(t,i,e),this.addEdgeIndices(i,e,t)}computeSectionLineGeometry(){!!localStorage.getItem("useCPUSection")||(this.clipPlanes=null),this.clipPlanes?this.sectionLineGeometry=n({renderable:this._renderable,clipPlanes:this.clipPlanes,sectionLines:this.sectionLines,lineWidth:this.lineWidth,color:this._color,visibleSpace:this.renderer.visibleSpace}):this.computeSectionLineGeometry_old()}setColor(e){if(null===e)return;const t=this.sectionLineGeometry&&this.sectionLineGeometry.drawingGroups[0].material;t&&t.color.set(e)}computeInternalSectionLineArray(e,t){let i=null;if(t||!e)i=t;else{let t;for(i=[],t=0;t<e.length;t++)i.push(!0)}return i}update({width:e,color:t,clipPlanes:i,sectionLines:r}){this.setColor(t);const n=this.sectionLineGeometry&&this.sectionLineGeometry.drawingGroups[0].material;if(this.clipPlanes){if(n){if(!i||this.clipPlanes.length!==i.length)return!1;const t=this.computeInternalSectionLineArray(i,r);for(let e=0;e<this.clipPlanes.length;e++)if(!this.clipPlanes[e].equals(i[e])||this.sectionLines[e]!==t[e])return!1;return n.setLineWidth(e),!0}return!1}return this.lineWidth===e}dispose(){this.sectionLineGeometry&&this.sectionLineGeometry.dispose(),this.sectionLineGeometry=null}computeSectionLineGeometry_old(){var e,t,i,r,n,a,s=THREEDS.Core,o=this._renderable,l=[],c=this.renderer.visibleSpace,h=0;if(o.layer){var u={};for(d=0;d<o.layer.layers.length;d++)D=o.layer.layers[d].drawableGroup,(P=o.layer.layers[d].drawableInterval).skip(o,c)||(u[D.geometry.id]=D.geometry,h+=D._geomType===s.GeomTypeEnum.FACE?P.count:0);for(var d in u)l.push(u[d])}else{l=o.geometry;for(var p=o.geometry.length,d=0;d<p;d++){(b=o.geometry[d]).drawingGroups.length;for(var f=0;f<b.drawingGroups.length;f++)h+=(D=b.drawingGroups[f])._geomType===s.GeomTypeEnum.FACE?D.count:0}}if(0===h)return null;this.allocateArrays(h);var m=0,g=0,v=[],S=[];for(d=0;d<l.length;d++)v[d]=m,S[d]=g,m+=l[d].vertexIndexArray.length,g+=l[d].vertexPositionArray.length;if(1===l.length)e=l[0].vertexIndexArray,t=l[0].vertexPositionArray;else{e=new Uint32Array(m),t=new Float32Array(g);var _=0,y=0;for(d=0;d<l.length;d++){for(var x=l[d],M=0;M<x.vertexIndexArray.length;M++)e[_]=S[d]/3+x.vertexIndexArray[M],_++;for(M=0;M<x.vertexPositionArray.length;M++)t[y]=x.vertexPositionArray[M],y++}}if(this.halfEdgesStructure={},a=e.length,this.maxIndices=a,this._positionArray=t,o.layer)for(d=0;d<o.layer.layers.length;d++){var P;if(D=o.layer.layers[d].drawableGroup,!(P=o.layer.layers[d].drawableInterval).skip(o,c)&&D._geomType===s.GeomTypeEnum.FACE){var C=l.indexOf(D.geometry);for(w=v[C]+P.start;w<v[C]+P.start+P.count;w+=3)i=e[w],r=e[w+1],n=e[w+2],i!==r&&r!==n&&i!==n&&this.processTriangleIndices(i,r,n,a)}}else for(p=l.length,d=0;d<p;d++){var b=l[d];for(f=0;f<b.drawingGroups.length;f++){var D;if((D=b.drawingGroups[f])._geomType===s.GeomTypeEnum.FACE)for(var w=v[d]+D.start;w<v[d]+D.start+D.count;w+=3)i=e[w],r=e[w+1],n=e[w+2],i!==r&&r!==n&&i!==n&&this.processTriangleIndices(i,r,n,a)}}this.sectionLineGeometry=this.createNewGeometry(),this.resetBuffers()}createNewGeometry(t){var i,r=THREEDS.Core,n=this.indexArray.length,s=[],o=debugWebGLV6Viewer.renderer.renderer.context,l=o.getParameter(o.MAX_TEXTURE_SIZE),c=l*l,h=this._positionArray.length/3,u=Math.ceil(h/c),d=h-Math.floor(h/c)*c,p=Math.sqrt(d),f=a(p),m=a(d/f),g=3*((u-1)*c+f*m),v=new Float32Array(g);v.set(this._positionArray);for(var S=0;S<u-1;S++){var _;(_=new r.DataTexture(v.subarray(S*c*3,(S+1)*c*3),l,l,r.RGBFormat,r.FloatType)).minFilter=r.NearestFilter,_.magFilter=r.NearestFilter,_.generateMipmaps=!1,_.flipY=!1,_.needsUpdate=!0,s.push(_)}(_=new r.DataTexture(v.subarray((u-1)*c*3,g),f,m,r.RGBFormat,r.FloatType)).minFilter=r.NearestFilter,_.magFilter=r.NearestFilter,_.generateMipmaps=!1,_.flipY=!1,_.needsUpdate=!0,s.push(_);var y={NB_OUTLINE_MAPS:u,MAX_OUTLINE_MAP_SIZE:l.toFixed(1),LAST_OUTLINE_MAP_SIZE_X:f.toFixed(1),LAST_OUTLINE_MAP_SIZE_Y:m.toFixed(1)};(i=this.wide?new r._WideSectionMaterial(y,s,.5*this.lineWidth):new r._SectionMaterial(y,s)).color.set(this._color);var x=new e.DrawingGroup(i,i,this.wide?4:1,0,n),M=new r.BufferGeometryDS;return M.drawingGroups=[],x.geometry=M,M.drawingGroups.push(x),M.vertexPositionArray=this.currentsArray,M.vertexUvArray=this.edgeLastIndexArray,M.vertexIndexArray=this.indexArray,M.boundingSphere=this._renderable.boundingSphere,M.boundingBox=this._renderable.boundingBox,M}}}),define("DS/Shaders/PDSFXShaders",["DS/Shaders/DefaultShaders"],function(e){"use strict";var t={PDSFX_header_vertex:["#ifdef CPU_PATTERN","#define PDSFX_PIXEL_LINEDISTANCE","#endif","#ifdef COMPRESSED_VERTICES","attribute vec2 _DSposition;","#else","attribute vec3 _DSposition;","#endif","#ifdef COMPRESSED_NORMALS","attribute float _DSnormal;","#else","attribute vec3 _DSnormal;","#endif","attribute vec2 _DSuv;","attribute vec2 _DSuv2;","attribute vec3 _DStangent;","attribute vec3 _DSbinormal;",["vec3 _DS_position;","vec3 _DS_normal;","vec2 _DS_uv;","vec2 _DS_uv2;","vec3 position;","vec3 normal;","vec2 uv;","vec2 uv2;","vec3 tangent;","vec3 binormal;"].join("\n"),"#ifdef USE_DASHEDLINE","attribute vec2 _DSlineDistance;","#ifdef WORLD_SIZE_PATTERN2","attribute vec2 patternStartEnd;","#endif","vec2 lineDistance;","#else","vec2 _DSlineDistance;","#endif","#ifdef USE_WIDELINE","attribute vec3 _DSpreviousPos;","attribute vec3 _DSfollowingPos;","vec3 previousPos;","vec3 followingPos;","#else","vec3 _DSpreviousPos;","vec3 _DSfollowingPos;","#endif"].join("\n"),PDSFX_start_vertex:["","#ifdef COMPRESSED_VERTICES","position = decodePosition(_DSposition, quantizedVector, offsetVector);","#endif","#ifdef COMPRESSED_NORMALS","normal = decodeOct24Normal(_DSnormal);","#endif","#ifdef COMPRESSED_UVS","uv = decodeUV(_DSuv);","uv2 = decodeUV(_DSuv2);","#endif","#if defined(COMPRESSED_COLORS)","color = decodeColor(_DScolor);","#endif","#ifdef PDSFX","#ifdef COMPRESSED_VERTICES","_DS_position = position;","#else","_DS_position = _DSposition;","#endif","#ifdef COMPRESSED_NORMALS","_DS_normal = normal;","#else","_DS_normal = _DSnormal;","#endif","#ifdef COMPRESSED_UVS","_DS_uv = uv;","_DS_uv2 = uv2;","#else","_DS_uv = _DSuv;","_DS_uv2 = _DSuv2;","#endif","ComputeCommonValues();","position = ComputeObjectPosition();","normal = ComputeObjectNormal();","#ifdef USE_DASHEDLINE","lineDistance = _DSlineDistance;","#endif","#ifdef USE_WIDELINE","previousPos = ComputeObjectPreviousPosition();","followingPos = ComputeObjectFollowingPosition();","#endif","#ifdef USE_DASHEDLINE","ProcessLineDistance(lineDistance);","#endif","uv = ComputeObjectTexCoord0().xy;","uv2 = ComputeObjectTexCoord1().xy;","#if defined(USE_TANGENT_BINORMAL)","tangent = ComputeObjectTangent();","binormal = ComputeObjectBinormal();","#endif","TangentSpace _viewTangentSpace;","vec3 _MVNormal;","#if defined( NEEDS_UVTOUSE )","#if defined (MAPPING_OPERATOR)","_DSmappingUVTransformation = mappingUVTransformation;","#endif","#endif","#endif",""].join("\n"),PDSFX_start_particle_vertex:["#ifdef PDSFX","_DSsize_ = size;","_DSscale_ = scale;","#endif"].join("\n"),PDSFX_point_size_vertex:["#ifdef PDSFX","gl_PointSize = ComputePointSize();","#else","#ifdef USE_SIZEATTENUATION","gl_PointSize = size * ( scale / length( mvPosition.xyz ) );","#else","gl_PointSize = size;","#endif","#endif","#if defined(PRIMITIVE_HIGHLIGHT) && defined(MOBILE_HIGHLIGHT_MODE)","gl_PointSize += 2.0;","#endif"].join("\n"),PDSFX_end_vertex:["","#ifdef PDSFX","#ifdef LINE_DS_VERTEX","vec4 copy_gl_Position = vec4(gl_Position);","ProcessClipSpacePosition(copy_gl_Position);","#else","ProcessClipSpacePosition(gl_Position);","#endif","ComputeVaryingValues();","_DSclipPosition = gl_Position;","_DSviewPosition = _viewTangentSpace.Position;","_DSviewNormal = _viewTangentSpace.Normal;","_DSviewTangent = _viewTangentSpace.Tangent;","_DSviewBinormal = _viewTangentSpace.Binormal;","#endif","#ifndef DEFERRABLE_MATERIAL","#ifdef PICKING_INSTANCING","if (instanceId > 16777215.0) vInstancePickingColor = vec3(0.0);","else {","vInstancePickingColor.r = floor(instanceId / 65536.0);","vInstancePickingColor.g = floor((instanceId - vInstancePickingColor.r * 65536.0) / 256.0);","vInstancePickingColor.b = floor(instanceId - vInstancePickingColor.r * 65536.0 - vInstancePickingColor.g * 256.0);","vInstancePickingColor /= 255.0;","}","#endif","#ifdef SPECIAL_PICKING_INSTANCING","vInstancePickingColor = specialMeshPicking;","#endif","#endif",""].join("\n")},i={PDSFXComputeCommonValues_VS:["void ComputeCommonValues() {","}"].join("\n"),PDSFXComputeObjectPosition_VS:["vec3 ComputeObjectPosition() {","\treturn _DS_position;","}"].join("\n"),PDSFXComputeObjectPreviousPosition_VS:["vec3 ComputeObjectPreviousPosition() {","\treturn _DSpreviousPos;","}"].join("\n"),PDSFXComputeObjectFollowingPosition_VS:["vec3 ComputeObjectFollowingPosition() {","\treturn _DSfollowingPos;","}"].join("\n"),PDSFXComputeObjectNormal_VS:["vec3 ComputeObjectNormal() {","\treturn _DS_normal;","}"].join("\n"),PDSFXComputeObjectTexCoord0_VS:["vec4 ComputeObjectTexCoord0() {","\treturn vec4(_DS_uv, 0.0, 0.0);","}"].join("\n"),PDSFXComputeObjectTexCoord1_VS:["vec4 ComputeObjectTexCoord1() {","\treturn vec4(_DS_uv2, 0.0, 0.0);","}"].join("\n"),PDSFXComputeObjectTexCoord2_VS:["vec4 ComputeObjectTexCoord2() {","\treturn vec4(0.0);","}"].join("\n"),PDSFXComputeObjectTangent_VS:["vec3 ComputeObjectTangent() {","\treturn _DStangent;","}"].join("\n"),PDSFXComputeObjectBinormal_VS:["vec3 ComputeObjectBinormal() {","\treturn _DSbinormal;","}"].join("\n"),PDSFXProcessViewTangentSpace_VS:["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","}"].join("\n"),PDSFXProcessLineDistance_VS:["void ProcessLineDistance(inout vec2 lineDistance) {","}"].join("\n"),PDSFXProcessClipSpacePosition_VS:["void ProcessClipSpacePosition(inout vec4 ioPosition) {","}"].join("\n"),PDSFXComputePointSize_VS:["float ComputePointSize() {","#ifdef USE_SIZEATTENUATION","return _DSsize_ * ( _DSscale_ / length( mvPosForAttenuation.xyz ) );","#else","return _DSsize_;","#endif","}"].join("\n"),PDSFXComputeVaryingValues_VS:["void ComputeVaryingValues() {","}"].join("\n"),PDSFXComputeHalfWidth_VS:["float ComputeHalfWidth() {","return _DShalfWidth_;","}"].join("\n")},r={PDSFX_albedo_pars_fragment:["#ifdef PDSFX","uniform vec3 _DSalbedo;","vec3 diffuse;","#else","uniform vec3 diffuse;","#endif"].join("\n"),PDSFX_opacity_pars_fragment:["#ifdef PDSFX","uniform float _DSopacity;","float opacity;","#else","uniform float opacity;","#endif"].join("\n"),PDSFX_emissive_pars_fragment:["#ifdef PDSFX","uniform vec3 _DSemissive;","vec3 emissive;","#else","uniform vec3 emissive;","#endif"].join("\n"),PDSFX_specular_pars_fragment:["#ifdef PDSFX","uniform vec3 _DSspecular;","vec3 specular;","#else","uniform vec3 specular;","#endif"].join("\n"),PDSFX_albedo_fragment:["_DSalbedo_ = _DSalbedo;","diffuse = ComputeAlbedo();"].join("\n"),PDSFX_opacity_fragment:["_DSopacity_ = _DSopacity;","opacity = ComputeOpacity();"].join("\n"),PDSFX_emissive_fragment:["_DSemissive_ = _DSemissive;","emissive = ComputeEmissive();"].join("\n"),PDSFX_specular_fragment:["_DSspecular_ = _DSspecular;","specular = ComputeSpecularReflectance();"].join("\n")},n={PDSFX_map_fragment:["#ifdef PDSFX_USE_MAP","_uvToUse = vUv;","#ifdef PHYSICALDS","_uvToUse2 = vUv2;","#endif","#endif"].join("\n"),PDSFX_mapping_fragment:["#if defined( NEEDS_UVTOUSE )","#if defined (MAPPING_OPERATOR)","_DSmappingUVTransformation = mappingUVTransformation;","#endif","#endif"].join("\n"),PDSFX_discard_fragment:["bool isDiscarded = ComputeDiscard();","if (isDiscarded) discard;"].join("\n"),PDSFX_viewNormal_fragment:["vec3 _DSvNormal = ComputeViewNormal();"].join("\n"),PDSFX_end_fragment:["#ifdef PDSFX","ProcessFinalColor(gl_FragColor);","#endif","#ifndef DEFERRABLE_MATERIAL","#if defined(PICKING_INSTANCING) || defined(SPECIAL_PICKING_INSTANCING)","gl_FragColor = vec4(vInstancePickingColor, 1.0);","#endif","#endif"].join("\n")},a=[],s={PDSFXComputeCommonValues_FS:["void ComputeCommonValues() {","}"].join("\n"),PDSFXComputeDiscard_FS:["bool ComputeDiscard() {","\treturn false;","}"].join("\n"),PDSFX_ComputeDiffuseTexel_FS:["vec4 _ComputeDiffuseTexel() {","\treturn vec4(1.0);","}"].join("\n"),PDSFXComputeViewPosition_FS:["vec3 ComputeViewPosition() {","\treturn _DSviewPosition;","}"].join("\n"),PDSFXComputeViewNormal_FS:["vec3 ComputeViewNormal() {","\treturn normalize(_DSviewNormal);","}"].join("\n"),PDSFXProcessFinalColor_FS:["void ProcessFinalColor(inout vec4 ioFinalColor) {","}"].join("\n"),PDSFXProcessLinePattern_FS:["void ProcessLinePattern(inout float patternValue, in float currentPixelDistance) {","}"].join("\n")},o=function(e,t,i){var r=[i+" "+e+"() {","return "+t+";","}"].join("\n");a.push(i+" "+t+";"),s["PDSFX"+e+"_FS"]=r},l=function(e,t){o(e,t,"float")},c=function(e,t){o(e,t,"vec3")};l("ComputeHalfWidth","_DShalfWidth_"),l("ComputeOpacity","_DSopacity_"),l("ComputeTransparency","_DStransparency_"),l("ComputeRoughness","_DSroughness_"),c("ComputeEmissive","_DSemissive_"),c("ComputeSpecularReflectance","_DSspecular_"),c("ComputeAlbedo","_DSalbedo_");var h={PDSFX_common_pars:["/**** PDSFX Common Getters ****/","","float _DSsize_;","","mat4 vGetWorldViewMatrix() {","return modelViewMatrix;","}","","uniform mat4 modelViewInvTranspMatrix;","mat4 vGetWorldViewInvTranspMatrix() {","return modelViewInvTranspMatrix;","}","","mat4 vGetViewMatrix() {","return viewMatrix;","}","","mat4 vGetProjectionMatrix() {","return projectionMatrix;","}","","mat4 vGetViewProjectionMatrix() {","return projectionMatrix * viewMatrix;","}","","uniform mat4 viewInvMatrix;","mat4 vGetViewInvMatrix() {","return viewInvMatrix;","}","","uniform mat4 projectionInvMatrix;","mat4 vGetProjectionInvMatrix() {","return projectionInvMatrix;","}","","mat4 vGetViewProjectionInvMatrix() {","return viewInvMatrix * projectionInvMatrix;","}","","uniform mat4 viewInvTranspMatrix;","mat4 vGetViewInvTranspMatrix() {","return viewInvTranspMatrix;","}","","mat3 _DSmappingUVTransformation;","mat4 vGetTextureMatrix() {","#if defined( NEEDS_UVTOUSE )","#if defined (MAPPING_OPERATOR)","mat4 matrix;","matrix[0] = vec4(_DSmappingUVTransformation[0], 0.0);","matrix[1] = vec4(_DSmappingUVTransformation[1], 0.0);","matrix[2] = vec4(_DSmappingUVTransformation[2], 0.0);","return matrix;","#endif","#endif","return mat4(1.0);","}","","vec3 vGetWorldEyePos() {","return cameraPosition;","}","","vec3 vGetLowlightColor() {","return vec3(0.0);","}","","float vGetDefaultPointSize() {","return _DSsize_;","}","","uniform vec3 nearFarLogFactor;","vec3 vGetNearFarLogFactor() {","return nearFarLogFactor;","}","","uniform vec2 viewportSize;","ivec2 vGetViewportSize() {","return ivec2(viewportSize);","}","","mat3 vGet3x3WorldMatrix() {","return mat3(modelMatrix);","}","","uniform mat4 modelInvTranspMatrix;","mat3 vGet3x3WorldInvTranspMatrix() {","return mat3(modelInvTranspMatrix);","}",""].join("\n"),PDSFX_attribute_getters_vertex:["","float _DSscale_;","#ifdef USE_SIZEATTENUATION","vec3 mvPosForAttenuation;","#endif","","int vGetInstanceID() {","#ifdef IS_MULTI_INSTANCED","\treturn int(instanceId/5.0 - 1.0);","#else","\treturn 0;","#endif","}","","vec3 vGetAttribPosition() {","return _DS_position;","}","vec3 vGetAttribPreviousPosition() {","return _DSpreviousPos;","}","vec3 vGetAttribFollowingPosition() {","return _DSfollowingPos;","}","","vec3 vGetAttribNormal() {","return _DS_normal;","}","","vec3 vGetAttribColor() {","return color.xyz;","}","float _vGetAttribColorAlpha() {","return color.a;","}","","vec4 vGetAttribTexCoord0() {","return vec4(_DS_uv, 0.0, 0.0);","}","","vec4 vGetAttribTexCoord1() {","return vec4(_DS_uv2, 0.0, 0.0);","}","","vec4 vGetAttribTexCoord2() {","return vec4(0.0);","}","","vec3 vGetAttribTangent() {","return _DStangent;","}","","vec3 vGetAttribBinormal() {","return _DSbinormal;","}","float _DShalfWidth_;",""].join("\n"),PDSFX_varying_getters_fragment:["#ifdef PDSFX","","vec4 vGetFragCoord() {","return gl_FragCoord;","}","","void vSetFragDepth(in float iDepth) {","#ifdef GLSL300ES","gl_FragDepth = iDepth;","#endif","#ifdef FRAG_DEPTH_EXT","gl_FragDepthEXT = iDepth;","#endif","}","","bool vIsFrontFacing() {","return gl_FrontFacing;","}","","vec2 vGetPointCoord() {","return gl_PointCoord;","}","","vec3 vGetViewPosition() {","return _DSviewPosition;","}","","vec3 vGetViewNormal() {","return normalize(_DSviewNormal);","}","","vec3 vGetViewTangent() {","return normalize(_DSviewTangent);","}","","vec3 vGetViewBinormal() {","return normalize(_DSviewBinormal);","}","","vec2 _uvToUse;","vec4 vGetTexCoord0() {","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","return vec4(_uvToUse, 0.0, 0.0);","#else","return vec4(0.0);","#endif","}","","vec2 _uvToUse2;","vec4 vGetTexCoord1() {","#if defined( NEEDS_UVTOUSE ) || defined(PDSFX_USE_MAP)","return vec4(_uvToUse2, 0.0, 0.0);","#else","return vec4(0.0);","#endif","}","","vec4 vGetTexCoord2() {","return vec4(0.0);","}","","vec4 vGetClipSpacePosition() {","return _DSclipPosition;","}",a.join("\n"),"#endif",""].join("\n"),PDSFX_varyings_pars:["","#ifdef PDSFX","varying vec3 _DSviewPosition;","varying vec3 _DSviewNormal;","varying vec3 _DSviewTangent;","varying vec3 _DSviewBinormal;","varying vec4 _DSclipPosition;","#endif",""].join("\n")},u={PDSFX_halfWidth_pars_vertex_fragment:["#ifdef PDSFX","uniform float _DShalfWidth;","float halfWidth;","#else","uniform float halfWidth;","#endif","float getHalfWidth() {","#if defined(PRIMITIVE_HIGHLIGHT) && defined(MOBILE_HIGHLIGHT_MODE)","return halfWidth > 0.5 ? halfWidth + 0.5 : halfWidth;","#else","return halfWidth;","#endif","}"].join("\n"),PDSFX_halfWidth_fragment_vertex:["#ifdef USE_WIDELINE","_DShalfWidth_ = _DShalfWidth;","halfWidth = ComputeHalfWidth();","#endif"].join("\n")};return Object.assign(u,h),Object.assign(u,t),Object.assign(u,i),Object.assign(u,r),Object.assign(u,n),Object.assign(u,s),u}),define("DS/QualityManager/GPULists",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t=["Google SwiftShader","Microsoft Basic Render","WebVisu Profile No GPU"],i=["Quadro 400","Quadro 410","Quadro 500M","Quadro 600","Quadro 1000M","Quadro 2000","Quadro 2000M","Quadro M600M","Quadro M620","Quadro M500M","Quadro M520","Quadro K600","Quadro K420","Quadro K600","Quadro K610M","Quadro K1000M","Quadro P400","Quadro P500","GeForce GTX 750","GeForce GTX 750 Ti","GeForce GTX 760","GeForce GTX 775M","GeForce GTX 780M","GeForce GTX 950","GeForce GTX 950M","GeForce GTX 960M","GeForce GTX 965M","GeForce GTX 970M","GeForce GTX 1050","GeForce GTX 1050 Ti","GeForce GTX 1650","GeForce GTX 1650 SUPER","GeForce GTX 1650 Super","GeForce GTX 1650 Ti","Graphics 530","Graphics P530","Graphics 630","Graphics P630","Graphics 730","WebVisu Profile Very Low","WebVisu Profile Unknown"],r=["Quadro 3000M","Quadro 4000","Quadro 4000M","Quadro 5000","Quadro 5000M","Quadro 5010M","Quadro 6000","Quadro K620","Quadro K620M","Quadro K1200","Quadro K2000","Quadro K2000M","Quadro K2200","Quadro K2100M","Quadro K2200M","Quadro K3000M","Quadro K1100M","Quadro M1000","Quadro M1000M","Quadro M1200","Quadro M1200M","Quadro M2000","Quadro M2000M","Quadro M2200","Quadro P520","Quadro P600","Quadro P620","Quadro P1000","Quadro P1200","Quadro P2000","Quadro P2200","Quadro T400","Quadro T600","Quadro T1000","GeForce GTX 770","GeForce GTX 880","GeForce GTX 780","GeForce GTX 960","GeForce GTX 970","GeForce GTX 980M","GeForce GTX 1060","GeForce GTX 1060 SUPER","GeForce GTX 1060 Super","GeForce GTX 1070","GeForce GTX 1650","GeForce GTX 1650 SUPER","GeForce GTX 1650 Super","GeForce GTX 1650 Ti","GeForce GTX 1660","GeForce GTX 1660 SUPER","GeForce GTX 1660 Super","GeForce GTX 2050","GeForce GTX 2050 Ti","GeForce RTX 2060","GeForce RTX 3050","FirePro M5950","FirePro V4900","FirePro V3900","FirePro V4800","FirePro W4170M","FirePro M4100","FirePro W2100","Pro WX 3100","Pro WX 2100","Pro WX 4150","Pro 5300M","Pro 5500M","Pro 555X","Pro 560","Pro 560X","Mobility Radeon WX 4130","Mobility Radeon WX 4150","RX 470","RX 480","RX 480X","RX 570","RX 570X","RX 5300","RX 5300 XT","RX 5500","RX 5500 XT","RX 5600","Graphics 540","Graphics 550","Graphics 580","Graphics P555","Graphics P580","Graphics 640","Graphics 645","Graphics 650","Graphics 655","Graphics 750","UHD Graphics Direct3D11","Iris(R) Plus Graphics","Iris(TM) Plus Graphics","Xe Graphics","Adreno (TM) 540","Adreno (TM) 630","Mali-G57","Mali-G68","Mali-G72","Adreno (TM) 640","Adreno (TM) 642","Adreno (TM) 650","Adreno (TM) 660","Adreno (TM) 675","Adreno (TM) 680","Adreno (TM) 685","Mali-G76","Mali-G77","Mali-G78","WebVisu Profile Low"],n=["Quadro K3100M","Quadro K4000","Quadro K4000M","Quadro K4100M","Quadro K4200","Quadro K5000M","Quadro K5100M","Quadro K5200","Quadro K6000","Quadro M3000M","Quadro P3000","Quadro T2000","Quadro RTX 3000","Quadro RTX A2000","Quadro RTX A3000","FirePro V8800","FirePro V7800","FirePro V7900","FirePro W7000","FirePro M8900","FirePro V5800","FirePro M7820","FirePro W5100","FirePro M6100","FirePro W4300","FirePro W4000","FirePro W5170M","FirePro M6000","FirePro M5100","FirePro W4100","FirePro W5130M","FirePro M4000","FirePro V5900","Pro WX 5100","Pro WX 4100","Quadro M4000M","Quadro M5000M","Quadro P3200","Quadro T2000","Quadro RTX 3000","GeForce GTX 780 Ti","GeForce GTX 880 Ti","GeForce RTX 980","GeForce RTX 980 Ti","GeForce GTX 1070 Ti","GeForce RTX 1080","GeForce GTX 1660 Ti","GeForce RTX 2060 SUPER","GeForce RTX 2060 Super","GeForce RTX 2070","GeForce RTX 2070 SUPER","GeForce RTX 2070 Super","GeForce RTX 3050 Ti","GeForce RTX 3060","GeForce RTX 3060 Ti","RX 490","RX 490X","RX 580","RX 580X","RX 590","RX Vega 56","RX Vega 64","RX 5600 XT","RX 5700","RX 5700 XT","RX 5800","RX 5800 XT","RX 5900","RX 6600","RX 6600 XT","RX 6700","RX 6700 XT","RX 6800","WebVisu Profile Medium"],a=["Quadro K5000","Quadro M4000","Quadro M5000","Quadro M6000","Quadro P4000","Quadro P4200","Quadro P5000","Quadro P5200","Quadro P6000","GRID K2","Quadro GP100","Quadro GV100","Quadro RTX 4000","Quadro RTX 5000","Quadro RTX 6000","Quadro RTX 8000","Quadro RTX A4000","Quadro RTX A4500","Quadro RTX A5000","Quadro RTX A5500","Quadro RTX A6000","GeForce RTX 1080 Ti","GeForce GTX TITAN","GeForce RTX 2080","GeForce RTX 2080 Ti","GeForce RTX 2080 SUPER","GeForce RTX 2080 Super","GeForce RTX 3070","GeForce RTX 3070 Ti","GeForce RTX 3080","GeForce RTX 3080 Ti","GeForce RTX 3090","GeForce RTX 4080","GeForce RTX 4080 Ti","GeForce RTX 4090","FirePro W9100","FirePro W8100","FirePro W9000","FirePro W7170M","FirePro W8000","FirePro W7100","Mobility Radeon WX 7100","Pro WX 7100","VII","RX 5900 XT","RX 5950","RX 5950 XT","RX 6800 XT","RX 6900","RX 6900 XT","WebVisu Profile High"],s=["WebVisu Profile Ultra"],o=[{value:s,preset:"Ultra",unknownOrVeryLow:!1},{value:a,preset:"High",unknownOrVeryLow:!1},{value:n,preset:"Medium",unknownOrVeryLow:!1},{value:r,preset:"Low",unknownOrVeryLow:!1},{value:i,preset:"Low",unknownOrVeryLow:!0},{value:t,preset:"Low",unknownOrVeryLow:!0,warning:"Software rendering mode. Please enable hardware acceleration."}];return e.VisualizationTraces.info("Known GPUs :"+(i.length+r.length+n.length+a.length+s.length+t.length)),o}),define("DS/QualityManager/QMController",["UWA/Core","UWA/Class","DS/QualityManager/QMPresetStreamer","DS/QualityManager/GPULists","DS/Mesh/ThreeJS_Base"],function(e,t,i,r,n){"use strict";var a=1,s=2,o=3,l=4,c=5,h=5;var u=r;return t.singleton({init:function(){this.isInitialized=!0,i.init(),this.version=-1,this.currentUser=null,this.currentPreset=null,this.defaultPreset=null,this.unknownOrVeryLowGPU=!0,this.isLinked=null,this.prestToModify=null,this._webGLV6Viewers=[],this.activateLocalCache=!0,this.forceLocalCache=void 0},_checkPreset:function(e,t,i,r){for(var n=0;n<t.length;n++){var a=t[n];if(a&&0!==a.length&&(a="\\b"+(a=(a=a.replace("(","\\(")).replace(")","\\)"))+"\\b",null!==e.match(a)))return this.defaultPreset=i,this.unknownOrVeryLowGPU=r,this._updateDefaultPresets(),!0}return!1},computeDefaultPreset:function(){if(null==this.defaultPreset&&0!==this._webGLV6Viewers.length){if(window.__karma__&&!localStorage.getItem("WebVisu_GPU_Profile"))return this.defaultPreset="Medium",void(this.unknownOrVeryLowGPU=!0);var e=localStorage.getItem("WebVisu_GPU_Profile")||(this._webGLV6Viewers[0]._viewerEffectSettings._lqFallback?"WebVisu Profile Very Low":this._webGLV6Viewers[0].renderer.renderer.getRendererInfo().gpu);if(localStorage.getItem("WebVisu_Show_GPU_Profile")&&alert(e),this.defaultPreset="Low",this.unknownOrVeryLowGPU=!0,e&&0!=e.length){null!==(e.match("\\bIntel\\b")||e.match("\\bIntel(R)\\b")||e.match("\\bIntel(TM)\\b"))&&console.warn("Integrated GPU detected, please enable your dedicated GPU if possible.");for(var t=0;t<u.length;t++){var i=u[t];if(this._checkPreset(e,i.value,i.preset,i.unknownOrVeryLow))return i.warning&&console.warn("Warning: "+i.warning),void(localStorage.getItem("WebVisu_Show_GPU_Profile")&&alert(this.defaultPreset))}localStorage.getItem("WebVisu_Show_GPU_Profile")&&alert(this.defaultPreset)}else this._updateDefaultPresets()}},_updateDefaultPresets:function(){this.isInitialized&&(this._modifyAttributeOnDB("Static","Low","Material","DefaultMaterialQuality",this.unknownOrVeryLowGPU?"Low":"High"),this._modifyAttributeOnDB("Static","Medium","Material","DefaultMaterialQuality",this.unknownOrVeryLowGPU?"Low":"High"))},getDBVersion:function(){return i.getItem("DBVersion")},setDBVersion:function(e){this.version=e,i.setItem("DBVersion",e),this.commitToDB()},linkToViewer:function(e){this._webGLV6Viewers.push(e)},initPresetDB:function(e){i.initDataBase(e),this.currentUser=i.getItem("currentUser");var t="Users/"+this.currentUser+"/currentPreset";this.currentPreset=i.getItem(t);t="Users/"+this.currentUser+"/isLinked";this.isLinked=i.getItem(t),this.prestToModify="Custom",this.version=this.getDBVersion(),this.version>h?console.error("Detected unknown QM database version"):(this.version<a&&this.setDBVersion(a),this.version<s&&(this._modifyAttributeOnDB("Static","Low","AmbientOcclusion","NoOfSamples",0),this._modifyAttributeOnDB("Dynamic","Low","AmbientOcclusion","NoOfSamples",0),this.setDBVersion(s)),this.version<o&&(this._addAttributeOnDB("Static","Low","Refractions","AllowInterObjectRefractions",!1),this._addAttributeOnDB("Static","Medium","Refractions","AllowInterObjectRefractions",!1),this._addAttributeOnDB("Static","High","Refractions","AllowInterObjectRefractions",!1),this._addAttributeOnDB("Static","Ultra","Refractions","AllowInterObjectRefractions",!1),this._addAttributeOnDB("Dynamic","Low","Refractions","AllowInterObjectRefractions",!1),this._addAttributeOnDB("Dynamic","Medium","Refractions","AllowInterObjectRefractions",!1),this._addAttributeOnDB("Dynamic","High","Refractions","AllowInterObjectRefractions",!1),this._addAttributeOnDB("Dynamic","Ultra","Refractions","AllowInterObjectRefractions",!1),this._addAttributeOnDB("Static","Custom","Refractions","AllowInterObjectRefractions",!1),this._addAttributeOnDB("Static","Custom","Refractions","Preset","Medium"),this._addAttributeOnDB("Dynamic","Custom","Refractions","AllowInterObjectRefractions",!1),this._addAttributeOnDB("Dynamic","Custom","Refractions","Preset","Medium"),this.setDBVersion(o)),this.version<l&&(this._modifyAttributeOnDB("Static","High","Reflections","AllowInterObjectReflections",!0),this._modifyAttributeOnDB("Static","Ultra","Reflections","AllowInterObjectReflections",!0),this._modifyAttributeOnDB("Dynamic","High","Reflections","AllowInterObjectReflections",!0),this._modifyAttributeOnDB("Dynamic","Ultra","Reflections","AllowInterObjectReflections",!0),this._modifyAttributeOnDB("Static","High","Refractions","AllowInterObjectRefractions",!0),this._modifyAttributeOnDB("Static","Ultra","Refractions","AllowInterObjectRefractions",!0),this._modifyAttributeOnDB("Dynamic","High","Refractions","AllowInterObjectRefractions",!0),this._modifyAttributeOnDB("Dynamic","Ultra","Refractions","AllowInterObjectRefractions",!0),this.setDBVersion(l)),this.version<c&&(this._modifyAttributeOnDB("Static","Medium","Shadows","AllowTransparentObjectShadows",!0),this._modifyAttributeOnDB("Static","High","Shadows","AllowTransparentObjectShadows",!0),this._modifyAttributeOnDB("Static","Ultra","Shadows","AllowTransparentObjectShadows",!0),this._modifyAttributeOnDB("Dynamic","Medium","Shadows","AllowTransparentObjectShadows",!0),this._modifyAttributeOnDB("Dynamic","High","Shadows","AllowTransparentObjectShadows",!0),this._modifyAttributeOnDB("Dynamic","Ultra","Shadows","AllowTransparentObjectShadows",!0),this.setDBVersion(c)))},setCurrentUser:function(t){var r="Users/"+t,n=i.getItem(r);e.is(n)&&(i.setItem("currentUser",t),this.currentUser=t)},setCurrentRenderMode:function(t){var r="Users/"+this.currentUser+"/currentPreset",n=i.getItem(r);e.is(n)&&(i.setItem(r,t),this.currentPreset=t)},getCurrentRenderMode:function(){var e="Users/"+this.currentUser+"/currentPreset";return i.getItem(e)},setLinkedPresetStatus:function(t){var r="Users/"+this.currentUser+"/isLinked",n=i.getItem(r);e.is(n)&&(i.setItem(r,t),this.isLinked=t)},getLinkedPresetStatus:function(){var e="Users/"+this.currentUser+"/isLinked";return i.getItem(e)},getCurrentUserPresetQuery:function(){return"Users/"+this.currentUser+"/Preset/"},validateAttribute:function(e,t){var i=!0;return"ReflectionsOnGround"!=e&&"Preset"!=e||(i=!1),i},setAttribute:function(e,t,i,r,n){this.setAttributeOnViewer(e,r,n),this.setAttributeOnDB(e,t,i,r,n)},setAttributeOnViewer:function(e,t,i){if(!this.validateAttribute(t,i))return!1;var r,n=!1,a="Dynamic"===e?"dynamicValue":"staticValue";r="string"==typeof i?JSON.parse('{"'+t+'":"'+i+'"}'):JSON.parse('{"'+t+'":'+i+"}");for(var s=0;s<this._webGLV6Viewers.length;s++){var o=this._webGLV6Viewers[s],l=o.getQMSetting(t);if(l[a]!==i)o._setQMSettings(r,e),o.getQMSetting(t)[a]!==l[a]&&(n=!0)}return n},_modifyAttributeOnDB:function(e,t,r,n,a){var s=this.getCurrentUserPresetQuery()+e+"/"+t+"/"+r+"/"+n;i.setItem(s,a),i.commit()},_addAttributeOnDB:function(e,t,r,n,a){var s=this.getCurrentUserPresetQuery()+e+"/"+t+"/"+r+"/"+n;i._addItem(s,a),i.commit()},_removeAttributeOnDB:function(e,t,r,n){var a=this.getCurrentUserPresetQuery()+e+"/"+t+"/"+r+"/"+n;i._removeItem(a),i.commit()},setAttributeOnDB:function(e,t,r,n,a){var s=this.getCurrentUserPresetQuery()+e+"/"+this.prestToModify+"/"+r+"/",o=s+n;i.setItem(o,a);var l=s+"Preset";i.setItem(l,t)},setAttributeOnDynamicMode:function(e,t,r,n,a){var s=this.getCurrentUserPresetQuery()+e+"/"+t+"/"+r+"/"+n;i.setItem(s,a),this.setGlobalPresetOnViewer(e,t),this.setPropertyOnViewer(e,t,r),this.setAttributeOnViewer(e,n,a)},setProperty:function(e,t,i){this.setPropertyOnViewer(e,t,i),this.setPropertyOnDB(e,t,i)},setPropertyOnViewer:function(t,r,n){"Default"===r&&(r=this.defaultPreset);var a=this.getCurrentUserPresetQuery()+t+"/"+r,s=i.getItem(a);if(!e.is(s))return!1;var o=s[n];if(!e.is(o))return!1;for(var l in o)if(o.hasOwnProperty(l)){var c=o[l];this.setAttributeOnViewer(t,l,c)}},setPropertyOnDB:function(t,r,n){var a=r;"Default"===r&&(a=this.defaultPreset);var s=this.getCurrentUserPresetQuery()+t+"/"+a,o=i.getItem(s);if(!e.is(o))return!1;var l=o[n];if(!e.is(l))return!1;for(var c in l)if(l.hasOwnProperty(c)){var h=l[c];this.setAttributeOnDB(t,r,n,c,h)}},_addPropertyOnDB:function(e,t,r){var n=this.getCurrentUserPresetQuery()+e+"/"+t+"/"+r;i._addItem(n,{}),i.commit()},_removePropertyOnDB:function(e,t,r){var n=this.getCurrentUserPresetQuery()+e+"/"+t+"/"+r;i._removeItem(n),i.commit()},setGlobalPreset:function(e,t,i){this.setGlobalPresetOnViewer(e,t),this.setGlobalPresetOnDB(e,t,i)},setBatching:function(e){this.setBatchingOnDB(e,!0)},setLocalCache:function(e){this.setLocalCacheOnDB(e,!0)},setGlobalPresetOnViewer:function(t,r){"Default"===r&&(r=this.defaultPreset);var n=this.getCurrentUserPresetQuery()+t+"/"+r,a=i.getItem(n);if(!e.is(a))return!1;for(var s in a)a.hasOwnProperty(s)&&this.setPropertyOnViewer(t,r,s)},setGlobalPresetOnDB:function(t,r,n){var a=r;"Default"===r&&(a=this.defaultPreset);var s=this.getCurrentUserPresetQuery()+t+"/currentGlobalPreset";if(i.setItem(s,r),n){s=this.getCurrentUserPresetQuery()+t+"/"+a;var o=i.getItem(s);if(!e.is(o))return!1;for(var l in o)o.hasOwnProperty(l)&&this.setPropertyOnDB(t,r,l)}},getBatchingQuery:function(){return"Users/"+this.currentUser+"/Batching"},setBatchingOnDB:function(e,t){var r=this.getBatchingQuery();i.setItem(r,!!e)},getBatching:function(){var e=this.getBatchingQuery();return!!i.getItem(e)},getLocalCacheQuery:function(){return"Users/"+this.currentUser+"/LocalCache"},setLocalCacheOnDB:function(e,t){var r=this.getLocalCacheQuery();i.setItem(r,!!e)},getLocalCache:function(){if(void 0!==this.forceLocalCache)return this.forceLocalCache;if(!this.activateLocalCache||window.__karma__||"undefined"!=typeof dscef)return!1;var e=this.getLocalCacheQuery(),t=i.getItem(e);return!(void 0!==t&&!t)},getLocalCacheSizeQuery:function(){return"Users/"+this.currentUser+"/LocalCacheSize"},setLocalCacheSizeOnDB:function(e,t){var r=this.getLocalCacheSizeQuery();i.setItem(r,e)},getLocalCacheSize:function(){var e=this.getLocalCacheSizeQuery(),t=i.getItem(e),r=parseInt(t);return isFinite(r)&&r>=0&&r<=2048?r:2048},getCurrentGlobalPreset:function(e){var t=this.getCurrentUserPresetQuery()+e+"/currentGlobalPreset";return i.getItem(t)},getPresetValue:function(e,t){"Default"===t&&(t=this.defaultPreset);var r=this.getCurrentUserPresetQuery()+e+"/"+t;return i.getItem(r)},commitToDB:function(){i.commit()},restoreFromDB:function(){i.retoreDB();var e=this.getCurrentGlobalPreset("Static");this.setGlobalPreset("Static",e,!1),e=this.getCurrentGlobalPreset("Dynamic"),this.setGlobalPreset("Dynamic",e,!1)},dispose:function(){this._webGLV6Viewers=[]}})}),define("DS/GPUFormats/TextureLODPool",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t=function(){this.totalSize=0,this.textures=[]};return t.prototype.removeUnusedTextures=function(){for(var t=[],i=0;i<this.textures.length;i++){var r=this.textures[i];if(r.textureLOD.usedTexture!==r.lod){var n=r.textureLOD.textures[r.lod],a=r.textureLOD.textures[r.textureLOD.usedTexture];a&&a.loadEndStatus!==e.AssetLoadingStatus.READY?t.push(r):(n.dispose(),r.textureLOD.textures[r.lod]=null,this.totalSize-=r.size)}else t.push(r)}this.textures=t},t.prototype.add=function(e){this.totalSize+=e.size,this.textures.push(e)},t}),define("DS/GPUFormats/GPUFormats",["DS/GPUFormats/FormatEnums","DS/GPUFormats/Texture","DS/GPUFormats/CompressedTexture","DS/GPUFormats/DataTexture","DS/GPUFormats/TextureLODPool","DS/GPUFormats/WebGLRenderTarget","DS/GPUFormats/WebGLRenderTargetCube","DS/GPUFormats/NonPowerOfTwoTexture","DS/GPUFormats/VertexAttribute"],function(e,t,i,r,n,a,s,o,l){"use strict";var c={VertexAttribute:l,Texture:t,AssetLoadingStatus:{INIT:null,PAUSED:"pause",LOADING:"loading",ERROR:"error",READY:"complete"},CompressedTexture:i,DataTexture:r,TextureLODPool:n,NonPowerOfTwoTexture:o,WebGLRenderTargetProperties:function(e,t,i){this.width=e,this.height=t,this.options=i},WebGLRenderTarget:a,WebGLRenderTargetCube:s};return Object.assign(c,e),c}),define("DS/Shaders/LineDSShaders",["DS/Shaders/DefaultShaders","DS/Shaders/PDSFXShaders"],function(e,t){"use strict";var i=["   bool isNull(float x) {","       return abs(x) < 1e-6;","   }","   vec2 vNormalize(in vec2 v) {","       float len = length(v);","       if (!isNull(len)) {","           return v/len;","       }","       return vec2(0.0);","   }","   vec3 vNormalize(in vec3 v) {","       float len = length(v);","       if (!isNull(len)) {","           return v/len;","       }","       return vec3(0.0);","   }","   vec4 vNormalize(in vec4 v) {","       float len = length(v);","       if (!isNull(len)) {","           return v/len;","       }","       return vec4(0.0);","   }"].join("\n"),r={dashedParsVertex:["#ifdef USE_DASHEDLINE","   varying vec2 vLineDistance;","#ifdef WORLD_SIZE_PATTERN","       varying vec2 vPatternStartEnd;","       varying vec3 vPointCurr;","   #ifdef USE_WIDELINE","       varying vec3 vPointNext;","       varying vec3 vPointPrec;","       varying float vLineDistanceAlt;","       varying float resetSecondDist;","       varying vec3 vConstantNext;","       varying vec3 vConstantCurr;","       varying vec3 vConstantPrec;","   #endif","#else","   #ifdef USE_WIDELINE","       varying vec2 vPointNext;","       varying vec2 vPointPrec;","       varying float vLineDistanceAlt;","       varying vec2 vLineDistanceLeft;","       varying vec2 vLineDistanceRight;","       varying float resetSecondDist;","       varying vec2 vConstantNext;","       varying vec2 vConstantCurr;","       varying vec2 vConstantPrec;","   #endif","#endif","#endif"].join("\n"),wideParsVertex:["#ifdef USE_WIDELINE",t.PDSFX_halfWidth_pars_vertex_fragment,"       float getSegmentDepthValue(in vec3 dir, in vec3 posToComp) {","           vec3 nDir = vNormalize(dir);","           return min(1e18,(dot(posToComp,nDir) * nDir).z);","       }","       float getFinalZ(in bool clipped, in bvec2 precNext, in vec3 pmvPosition, in vec3 pmvPositionPrec, in vec3 pmvPositionSuiv, in vec2 pos, in float oldW, in vec3 mvPosition, in float worldSizeToPixel) {","\t\t\tvec3 computedPosition = vec3(pos.x, pos.y,pmvPosition.z);","\t\t\tfloat finalZ = pmvPosition.z;","       #ifndef USE_POLYGON_BORDER_MODE","           if (!clipped) {","\t\t\t\treturn finalZ;","           }","\t\t\tif (precNext.x) {","\t\t\t\tfinalZ = getSegmentDepthValue(pmvPosition.xyz - pmvPositionPrec.xyz,computedPosition.xyz - pmvPosition.xyz) + pmvPosition.z;","\t\t\t} else if (precNext.y) {","\t\t\t\tfinalZ = getSegmentDepthValue(pmvPositionSuiv.xyz - pmvPosition.xyz,computedPosition.xyz - pmvPosition.xyz) + pmvPosition.z;","\t\t\t}","\t\t\treturn finalZ;","       #else","           vec3 precDir, nextDir;","           if (precNext.y) {","               nextDir = pmvPositionSuiv.xyz - pmvPosition.xyz;","           }","           if (precNext.x) {","               precDir = pmvPosition.xyz - pmvPositionPrec.xyz;","           }","           if (precNext.x && precNext.y && length(cross(nextDir,precDir)) > 1e-6) {","               vec4 equationP = getPlanEquation(nextDir,precDir,pmvPosition.xyz);","               finalZ = - (equationP.x * computedPosition.x + equationP.y * computedPosition.y + equationP.w)/equationP.z;","               vec3 mvComputedPos = getViewSpaceConvertedPosition(pos, vec2(finalZ,1.0),oldW);","               vec3 positionToComputed = mvComputedPos.xyz - mvPosition;","               if (abs(positionToComputed.z) > 10.0*getHalfWidth() / worldSizeToPixel) {","                   mvComputedPos.z = mvPosition.z + 10.0*getHalfWidth() / worldSizeToPixel * sign(positionToComputed.z);","               }","               vec4 mvpComputedPos = projectionMatrix * vec4(mvComputedPos,1.0);","               mvpComputedPos /= abs(mvpComputedPos.w);","               finalZ = mvpComputedPos.z;","           } else if (precNext.x) {","               finalZ = getSegmentDepthValue(precDir,computedPosition.xyz - pmvPosition.xyz) + pmvPosition.z;","           } else if (precNext.y) {","               finalZ = getSegmentDepthValue(nextDir,computedPosition.xyz - pmvPosition.xyz) + pmvPosition.z;","           }","           return 0.99999*finalZ;","       #endif","       }","#endif"].join("\n"),roundCapParsVertex:["#ifdef USE_ROUNDCAP","   varying vec2 infos;","   varying vec2 centerLeft;","   varying vec2 centerCap;","   varying vec2 centerRight;","#endif"].join("\n"),roundJoinParsVertex:["#ifdef USE_ROUNDJOIN","   varying vec4 centerJoin;","   varying vec4 centerRightJoin;","   varying vec4 centerLeftJoin;","#endif"].join("\n"),polygonBorderModeParsVertex:["   #if defined(USE_POLYGON_BORDER_MODE) || (defined(USE_DASHEDLINE) && defined(WORLD_SIZE_PATTERN))","       vec4 getPlanEquation(in vec3 v1, in vec3 v2, in vec3 randomPosition) {","           vec3 normal = cross(v1,v2);","           normal = vNormalize(normal);","           float d;","           d = -dot(normal,randomPosition);","           return vec4(normal,d);","       }","","       vec3 getViewSpaceConvertedPosition(in vec2 pos, in vec2 zw, in float w){","           vec4 res = vec4(pos,zw);","           res *= w;","           res.y *= pixelSize.y/pixelSize.x;","           mat4 inverseProjection = mat4(projectionMatrix);","           if (! isNull(projectionMatrix[3][3]) ) {","               inverseProjection[0][0] = 1.0 / projectionMatrix[0][0];","               inverseProjection[1][1] = 1.0 / projectionMatrix[1][1];","               inverseProjection[2][2] = 1.0 / projectionMatrix[2][2];","               inverseProjection[3][2] = -projectionMatrix[3][2] / projectionMatrix[2][2];","               inverseProjection[3][3] = 1.0;","           } else {","               inverseProjection[0][0] = 1.0 / projectionMatrix[0][0];","               inverseProjection[1][1] = 1.0 / projectionMatrix[1][1];","               inverseProjection[2][2] = 0.0;","               inverseProjection[2][3] = 1.0 / projectionMatrix[3][2];","               inverseProjection[3][2] = 1.0 / projectionMatrix[2][3];","               inverseProjection[3][3] = -projectionMatrix[2][2] / (projectionMatrix[3][2] * projectionMatrix[2][3]);","           }","           res = inverseProjection * res;","           return res.xyz/res.w;","       }","   #endif"].join("\n"),wideParsFragment:["#ifdef USE_WIDELINE",t.PDSFX_halfWidth_pars_vertex_fragment,"#endif"].join("\n"),dashedParsFragment:["#ifdef USE_DASHEDLINE","   uniform float dashSize;","   uniform float scale;","   uniform float totalSize;","   uniform float patternOffset;","   #ifdef PATTERN_LENGTH","       uniform float dashPattern[PATTERN_LENGTH];","   #endif","   varying vec2 vLineDistance;","#ifdef WORLD_SIZE_PATTERN","varying vec2 vPatternStartEnd;","varying vec3 vPointCurr;","   #ifdef USE_WIDELINE","       varying vec3 vPointNext;","       varying vec3 vPointPrec;","       varying float vLineDistanceAlt;","       varying float resetSecondDist;","       varying vec3 vConstantCurr;","       varying vec3 vConstantNext;","       varying vec3 vConstantPrec;","   #endif","   float getDistance(in vec3 next, in vec3 prev) {","       vec3 resPoint = vec3(0.0);","       vec3 direction = next-prev;","       float lxy = length(direction.xy);","       vec2 dirXY = vNormalize(direction.xy);","       resPoint.xy = dot(vPointCurr.xy - prev.xy, dirXY) * dirXY;","       resPoint.z = length(resPoint.xy) / lxy * direction.z;","       return clamp(length(resPoint), 0.0, length(direction));","   }","   float getDistance(in vec3 next, in vec3 prev, in vec3 origin) {","       vec3 resPoint = vec3(0.0);","       vec3 direction = next-prev;","       float lxy = length(direction.xy);","       vec2 dirXY = vNormalize(direction.xy);","       resPoint.xy = dot(vPointCurr.xy - origin.xy, dirXY) * dirXY;","       resPoint.z = length(resPoint.xy) / lxy * direction.z;","       return clamp(length(resPoint), 0.0, length(direction));","   }","#else","   #ifdef USE_WIDELINE","       varying vec2 vPointNext;","       varying vec2 vPointPrec;","       varying float vLineDistanceAlt;","       varying vec2 vLineDistanceLeft;","       varying vec2 vLineDistanceRight;","       varying float resetSecondDist;","       varying vec2 vConstantNext;","       varying vec2 vConstantCurr;","       varying vec2 vConstantPrec;","   #endif","   float getDistance(in vec2 next, in vec2 prev) {","       float res = 0.0;","       vec2 direction = next-prev;","       float l = length(direction);","       res = dot(gl_FragCoord.xy  - prev, direction)/(l*l);","       return res * (vLineDistance.y - vLineDistance.x);","   }","   float getDistance(in vec2 next, in vec2 prev, in vec2 origin, in float ratio) {","       float res = 0.0;","       vec2 direction = next-prev;","       float l = length(direction);","       res = dot(gl_FragCoord.xy - origin, direction)/(l*l);","       return res* ratio;","   }","#endif","   #ifdef PATTERN_LENGTH","       vec3 getPatternInfo(in float dist) {","           int index = 0;","           float prec = 0.0, cur = 0.0;","           for (int i = 0; i < PATTERN_LENGTH; i++) {","               cur = max(scale,1e-6)*dashPattern[i];","               if (cur > dist) {","                   break;","               }","               prec = cur;","               index++;","           }","           return vec3(float(index),prec,cur);","       }","\t\tfloat getPatternDistance(in float dist) {","           #ifdef USE_BUTTCAP","           \treturn dist + patternOffset;","\t\t\t#else","\t\t\t\t#if !defined(USE_WIDELINE) || defined(WORLD_SIZE_PATTERN)","           \t   return dist + patternOffset;","               #else","           \t   return dist + getHalfWidth() + patternOffset;","\t\t\t\t#endif","           #endif","\t\t}","       float getPatternAlpha(in float dist) {","           float mDist = mod( dist, max(scale,1e-6)*totalSize );","           #ifdef WORLD_SIZE_PATTERN2","if (vPatternStartEnd.x > -0.5) {","mDist -= vPatternStartEnd.x;","if (mDist < 0.0 || mDist > vPatternStartEnd.y - vPatternStartEnd.x) {","return 1.0;","}","}","           #endif","           vec3 patternInfo = getPatternInfo(mDist);","\t\t\t#ifdef DASHEDLINE_INVERTED","           \tif (abs(mod(patternInfo.x,2.0)) < 0.5) {","               \treturn 1.0;","           \t}","\t\t\t\treturn 0.0;","\t\t\t#else","           \tif (abs(mod(patternInfo.x,2.0)) < 0.5) {","               \treturn 0.0;","           \t}","\t\t\t\treturn 1.0;","\t\t\t#endif","       }","   #endif","#endif"].join("\n"),roundCapParsFragment:["#ifdef USE_ROUNDCAP","   varying vec2 infos;","   varying vec2 centerLeft;","   varying vec2 centerCap;","   varying vec2 centerRight;","   bool doLeftCap(in bool leftSide) {","       bool leftCap = leftSide && infos.x < 0.0;","       if (!leftCap) {","           return false;","       }","       float distanceL = length(gl_FragCoord.xy - centerLeft)/getHalfWidth();","       if (distanceL > 1.0) {","           discard;","       }","       return true;","   }","   bool doRightCap(in bool rightSide) {","       bool rightCap = rightSide  && infos.x > length(centerRight - centerCap);","       if (!rightCap) {","           return false;","       }","       float distanceR = length(gl_FragCoord.xy - centerRight) / getHalfWidth();","       if (distanceR > 1.0) {","            discard;","       }","\t\treturn true;","   }","   void doRoundCap() {","       bool centerSide = abs(length(fwidth(centerCap))) < 1e-2;","       bool capToCap = abs(fwidth(infos.y)) < 1e-2 && infos.y > 0.0;","       bool leftSide = abs(length(fwidth(centerLeft))) < 1e-2 ;","       bool rightSide = abs(length(fwidth(centerRight))) < 1e-2 ;","       bool toTreat = ! (leftSide && rightSide && centerSide) || capToCap;","       if (!toTreat) {","           return;","       }","       bool leftCap = doLeftCap(leftSide);","       bool rightCap = doRightCap(rightSide && centerSide);","   }","#endif"].join("\n"),roundJoinParsFragment:["#ifdef USE_ROUNDJOIN","   varying vec4 centerJoin;","   varying vec4 centerRightJoin;","   varying vec4 centerLeftJoin;","   void doCentralJoin() {","       float distanceJoin = 0.0;","       float varJoinC = 0.0;","       if (dot(gl_FragCoord.xy - centerJoin.xy, centerJoin.zw) <= 0.0) {","           return;","       }","       distanceJoin = length(gl_FragCoord.xy - centerJoin.xy) / getHalfWidth();","       if (distanceJoin > 1.0) {","           discard;","       }","   }","   void doSideJoins() {","       bool rightJoin = abs(length(fwidth(centerRightJoin))) < 1e-2 && dot(gl_FragCoord.xy - centerRightJoin.xy, centerRightJoin.zw) > 0.0;","       bool leftJoin =  abs(length(fwidth(centerLeftJoin))) < 1e-2 && dot(gl_FragCoord.xy - centerLeftJoin.xy, centerLeftJoin.zw) > 0.0;","       float distanceRight = 0.0;","       float distanceLeft = 0.0;","       float varJoinR = 0.0;","       float varJoinL = 0.0;","       if (rightJoin) {","           distanceRight = length(gl_FragCoord.xy - centerRightJoin.xy) / getHalfWidth();","           if (distanceRight > 1.0) {","               discard;","           }","       }","       if (leftJoin) {","           distanceLeft = length(gl_FragCoord.xy - centerLeftJoin.xy) / getHalfWidth();","           if (distanceLeft > 1.0) {","               discard;","           }","       }","   }","   void doRoundJoins() {","       bool isOnJoin = abs(length(fwidth(centerJoin))) < 1e-2;","       if (isOnJoin) {","           doCentralJoin();","           return;","       }","       doSideJoins();","    }","#endif"].join("\n"),dashedLineInWide:["   #ifdef USE_DASHEDLINE","       vLineDistanceAlt = vLineDistance.x;","#ifdef WORLD_SIZE_PATTERN","       vConstantNext = getViewSpaceConvertedPosition(pmvPositionSuiv.xy, vec2(pmvPositionSuiv.z, pmvPositionSuiv.w), oldWSuiv);","       vConstantPrec = getViewSpaceConvertedPosition(pmvPositionPrec.xy, vec2(pmvPositionPrec.z, pmvPositionPrec.w), oldWPrec);","       vConstantCurr = getViewSpaceConvertedPosition(pmvPosition.xy, vec2(pmvPosition.z, pmvPosition.w), oldW);","          vLineDistance.x = lineDistance.x* modelMatrixScaleX;","          vLineDistance.y = lineDistance.y* modelMatrixScaleX;","       resetSecondDist = 0.0;","       if (!parity){","          vLineDistanceAlt = vLineDistance.y;","          vPointPrec = vConstantPrec.xyz;","          vPointNext = vConstantCurr.xyz;","       } else {","          vLineDistanceAlt = vLineDistance.x;","          vPointPrec = vConstantCurr.xyz;","          vPointNext = vConstantNext.xyz;","          if (abs(lineDistance.x - lineDistance.y) < 1e-6) {","               resetSecondDist = 1.0;","          }","       }","#else","\t\tvec4 mvpPositionPrec = projectionMatrix * mvPositionPrec; ","       vec4 mvpPosition = projectionMatrix * mvPosition;","       vec4 mvpPositionSuiv = projectionMatrix * mvPositionSuiv;","       vConstantNext = (mvpPositionSuiv.xy / mvpPositionSuiv.w + 1.0)/ pixelSize;","       vConstantPrec = (mvpPositionPrec.xy / mvpPositionPrec.w + 1.0) / pixelSize;","       vConstantCurr = (mvpPosition.xy / mvpPosition.w + 1.0) / pixelSize;","\t#ifdef CPU_PATTERN","       vLineDistance.x = lineDistance.x ;","       vLineDistance.y = lineDistance.y ;","\t#endif","       float worldSizeToPixelPrec = computeWorldSizeToPixel(mvpPositionPrec);","       float worldSizeToPixelNext = computeWorldSizeToPixel(mvpPositionSuiv);","       resetSecondDist = 0.0;","       if (!parity){","           vLineDistanceAlt = vLineDistance.y;","           vPointPrec = vConstantPrec;","           vPointNext = vConstantCurr;","\t#ifdef CPU_PATTERN","           vLineDistanceLeft.x = lineDistance.x;","           vLineDistanceLeft.y = lineDistance.y;","           vLineDistanceRight.x = lineDistance.y;","           vLineDistanceRight.y = (lineDistance.y + length(vConstantNext.xy - vConstantCurr.xy));","\t#else","           vLineDistance.x = lineDistance.x * modelMatrixScaleX * worldSizeToPixelPrec;","           vLineDistance.y = lineDistance.y * modelMatrixScaleX * worldSizeToPixelCurr;","           vLineDistanceLeft.x = lineDistance.x * modelMatrixScaleX * worldSizeToPixelPrec;","           vLineDistanceLeft.y = lineDistance.y * modelMatrixScaleX * worldSizeToPixelCurr;","           vLineDistanceRight.x = lineDistance.y * modelMatrixScaleX * worldSizeToPixelCurr;","           vLineDistanceRight.y = (lineDistance.y + length(followingPos.xyz - position.xyz)) * modelMatrixScaleX * worldSizeToPixelNext;","\t#endif","       } else {","           vLineDistanceAlt = vLineDistance.x;","           vPointPrec = vConstantCurr;","           vPointNext = vConstantNext;","\t#ifdef CPU_PATTERN","           vLineDistanceLeft.x = (lineDistance.x - length(vConstantCurr.xy - vConstantPrec.xy));","           vLineDistanceLeft.y = lineDistance.x;","           vLineDistanceRight.x = lineDistance.x;","           vLineDistanceRight.y = lineDistance.y;","\t#else","           vLineDistance.x = lineDistance.x * modelMatrixScaleX* worldSizeToPixelCurr;","           vLineDistance.y = lineDistance.y * modelMatrixScaleX* worldSizeToPixelNext;","           vLineDistanceLeft.x = (lineDistance.x - length(position.xyz - previousPos.xyz)) * modelMatrixScaleX * worldSizeToPixelPrec;","           vLineDistanceLeft.y = lineDistance.x * modelMatrixScaleX * worldSizeToPixelCurr;","           vLineDistanceRight.x = lineDistance.x * modelMatrixScaleX * worldSizeToPixelCurr;","           vLineDistanceRight.y = lineDistance.y * modelMatrixScaleX * worldSizeToPixelNext;","\t#endif","           if (isNull(lineDistance.x - lineDistance.y)) {","\t\t\t#ifdef CPU_PATTERN","               vLineDistanceRight.y += length(vConstantNext.xy -  vConstantCurr.xy );","\t\t\t#else","               vLineDistanceRight.y += length(followingPos.xyz -  position.xyz )* modelMatrixScaleX * worldSizeToPixelNext;","\t\t\t#endif","               resetSecondDist = 1.0;","           }","       }","#endif","   #endif"].join("\n"),roundCapVertex:["#ifdef USE_ROUNDCAP","       vec2 following = (mvpPositionSuivR.xy / mvpPositionSuivR.w + 1.0)/ pixelSize;","       vec2 previous = (mvpPositionPrecR.xy / mvpPositionPrecR.w + 1.0) / pixelSize;","       vec2 current = (mvpPositionR.xy / mvpPositionR.w + 1.0) / pixelSize;","       vec2 computedCurrent = (auxVec.xy + 1.0) / pixelSize;","   if (!bPrecCurr) {","       centerLeft = current.xy;","       centerCap = current.xy;","       centerRight = following.xy;","       infos.x = -getHalfWidth();","       infos.y = 1.0;","   } else if (!bCurrNext) {","       centerLeft = previous.xy;","       centerCap = previous.xy;","       centerRight = current.xy;","       infos.x = length(current.xy-previous.xy) + getHalfWidth();","       infos.y = 1.0;","   } else {","       infos.y = 0.0;","       centerLeft = previous.xy;","       centerCap = current.xy;","       centerRight = following.xy;","       if (parity) {","           infos.x = dot(computedCurrent.xy - current.xy,  vNormalize(following.xy - current.xy));","       } else {","           infos.x = length(current.xy - previous.xy) + dot(computedCurrent.xy - current.xy, vNormalize(current.xy - previous.xy));","       }","   }","#endif"].join("\n"),roundJoinVertex:["#ifdef USE_ROUNDJOIN","   vec2 followingJoin = (mvpPositionSuivR.xy / mvpPositionSuivR.w + 1.0)/ pixelSize;","   vec2 previousJoin = (mvpPositionPrecR.xy / mvpPositionPrecR.w + 1.0) / pixelSize;","   vec2 currentJoin = (mvpPositionR.xy / mvpPositionR.w + 1.0) / pixelSize;","   centerLeftJoin = vec4(0.0);","   centerRightJoin = vec4(0.0);","   centerJoin = vec4(0.0);","   if (!bPrecCurr) {","       centerLeftJoin.xy = followingJoin.xy;","       centerJoin.xy = currentJoin.xy;","       centerRightJoin.xy = followingJoin.xy;","       centerRightJoin.zw = dirCurrNext;","   } else if (!bCurrNext) {","       centerLeftJoin.xy = previousJoin.xy;","       centerJoin.xy = currentJoin.xy;","       centerRightJoin.xy = previousJoin.xy;","       centerLeftJoin.zw = -dirPrecCurr;","   } else {","       if (parity) {","           centerLeftJoin.xy = currentJoin.xy;","           centerJoin.xy = currentJoin.xy;","           centerRightJoin.xy = followingJoin.xy;","           centerLeftJoin.zw = -dirCurrNext;","           centerRightJoin.zw = dirCurrNext;","           centerJoin.zw = -dir;","       } else {","           centerLeftJoin.xy = previousJoin.xy;","           centerJoin.xy = currentJoin.xy;","           centerRightJoin.xy = currentJoin.xy;","           centerLeftJoin.zw = -dirPrecCurr;","           centerRightJoin.zw = dirPrecCurr;","           centerJoin.zw = -dir;","       }","   }","#endif"].join("\n"),wideLineExtrusion:["   if (bPrecCurr){","       dirPrecCurr = pmvPosition.xy - pmvPositionPrec.xy;","       dirPrecCurr = vNormalize(dirPrecCurr);","       posPrecCurr = pmvPosition.xy + offset * orientation * vec2(-dirPrecCurr.y, dirPrecCurr.x);","   } else if (bCurrNext) {","       dirPrecCurr = pmvPosition.xy - pmvPositionSuiv.xy;","       dirPrecCurr = vNormalize(dirPrecCurr);","       posPrecCurr = pmvPosition.xy + offset * dirPrecCurr.xy;","   }","","   if (bCurrNext){","       dirCurrNext = pmvPositionSuiv.xy - pmvPosition.xy;","       dirCurrNext = vNormalize(dirCurrNext);","       posCurrNext = pmvPosition.xy + offset * orientation * vec2(-dirCurrNext.y, dirCurrNext.x);","   } else if (bPrecCurr) {","       dirCurrNext = pmvPosition.xy - pmvPositionPrec.xy;","       dirCurrNext = vNormalize(dirCurrNext);","       posCurrNext = pmvPosition.xy + offset * dirCurrNext.xy;","   }","","   vec2 dir = vNormalize(dirCurrNext.xy - dirPrecCurr.xy);","   bool col = false;","   if ( bPrecCurr && bCurrNext){","       if (isNull(length(dir))){","           dir = vec2(-dirCurrNext.y, dirCurrNext.x);","           col = true;","       }","       bool realCol = length(vNormalize(followingPos.xyz - position.xyz) - vNormalize(position.xyz - previousPos.xyz)) < 1e-2;","       float sinAlpha = dir.y * dirPrecCurr.x - dir.x * dirPrecCurr.y;","       float alpha = asin(abs(sinAlpha));","       float distPoints = min(distance(pmvPosition.xy, pmvPositionPrec.xy), distance(pmvPosition.xy, pmvPositionSuiv.xy)) + offset;","       float dist = offset/ sinAlpha;","       if (sign(sinAlpha) == -orientation) {","           if ( alpha < radians(45.0)) {","           #if defined(USE_ROUNDJOIN)","               if (parity){","                   pos = pmvPosition.xy - sign(sinAlpha) * offset * vec2(-dirCurrNext.y,dirCurrNext.x);","                   pos -= offset * dirCurrNext;","               } else {","                   pos = pmvPosition.xy - sign(sinAlpha) *offset * vec2(-dirPrecCurr.y,dirPrecCurr.x);","                   pos += offset * dirPrecCurr;","               }","           #else","               if (parity){","                   pos = posCurrNext - offset * dirCurrNext;","               } else {","                   pos = posPrecCurr + offset * dirPrecCurr;","               }","           #endif","           } else {","               pos = pmvPosition.xy - dir *abs(dist);","           }","           if (col && !realCol) {","               if (parity){","                   pos += dist * dirCurrNext*orientation;","               } else {","                   pos -= dist * dirPrecCurr *orientation;","               }","           }","       } else {","           if (max(distPoints, offset) < abs(dist)){","               dist = max(distPoints - offset, offset)*sign(sinAlpha);","               if (alpha < radians(22.5)){","                   if (parity){","                       pos = posCurrNext + dist * dirCurrNext*orientation;","                   } else {","                       pos = posPrecCurr - dist * dirPrecCurr *orientation;","                   }","                   if (col && !realCol) {","                       if (parity){","                           pos += dist * dirCurrNext*orientation;","                       } else {","                           pos -= dist * dirPrecCurr *orientation;","                       }","                   }","               } else {","                   pos = pmvPosition.xy + dir * max(distPoints, offset);","                   if (col && !realCol) {","                       if (parity){","                           pos += dist * dirCurrNext*orientation;","                       } else {","                           pos -= dist * dirPrecCurr *orientation;","                       }","                   }","               }","           } else {","               pos = pmvPosition.xy + dir *abs(dist);","               if (col && !realCol) {","                   if (parity){","                       pos += dist * dirCurrNext*orientation;","                   } else {","                       pos -= dist * dirPrecCurr *orientation;","                   }","               }","           }","       }","   } else if(bPrecCurr || bCurrNext) {","       #if defined(USE_BUTTCAP)","           pos = pmvPosition.xy + offset * vec2(-dirCurrNext.y, dirCurrNext.x)*orientation;","\t\t#else","\t\t\tpos = (posCurrNext - pmvPosition.xy)  + posPrecCurr;","\t\t#endif","   } else {","       pos = pmvPosition.xy + offset;","   }"].join("\n"),wideLineClip:["       bool clipped = false;","       vec3 testClip = vec3(sign(pmvPositionPrec.w + pmvPositionPrec.z), sign(pmvPosition.w + pmvPosition.z), sign(pmvPositionSuiv.w + pmvPositionSuiv.z));","       if (bPrecCurr && testClip.x * testClip.y < 0.0 ){","           float a = (pmvPositionPrec.w + pmvPositionPrec.z)/((pmvPositionPrec.w + pmvPositionPrec.z) - (pmvPosition.w + pmvPosition.z));","           if (testClip.x < 0.0) {","               pmvPositionPrec = (1.0 - a) * pmvPositionPrec + a * pmvPosition;","               clipped = true;","           } else if (mod(sideExtrusion,2.0) == 1.0) {","              pmvPosition = (1.0 - a) * pmvPositionPrec + a * pmvPosition;","               pmvPositionSuiv = pmvPosition;","               bCurrNext = false;","               clipped = true;","           }","       }","       if (bCurrNext && testClip.y * testClip.z < 0.0 ){","           float a = (pmvPosition.w + pmvPosition.z)/((pmvPosition.w + pmvPosition.z) - (pmvPositionSuiv.w + pmvPositionSuiv.z));","           if (testClip.z < 0.0) {","               pmvPositionSuiv = (1.0 - a) * pmvPosition + a * pmvPositionSuiv;","               clipped = true;","           } else if (mod(sideExtrusion,2.0) == 0.0){","               pmvPosition = (1.0 - a) * pmvPosition + a * pmvPositionSuiv;","               pmvPositionPrec = pmvPosition;","               bPrecCurr = false;","               clipped = true;","           }","       }","#if defined(USE_ROUNDCAP) || defined(USE_ROUNDJOIN)","       vec4 mvpPositionPrecR = pmvPositionPrec; ","       vec4 mvpPositionR = pmvPosition;","       vec4 mvpPositionSuivR = pmvPositionSuiv;","#endif"].join("\n")};return{LineShaders:{lines_pars_vertex:["#define LINE_DS_VERTEX","   uniform vec2 pixelSize;","   float computeWorldSizeToPixel(in vec4 pos) {","      return abs(projectionMatrix[0][0]/pos.w)/pixelSize.x;","   }",i,r.dashedParsVertex,r.polygonBorderModeParsVertex,r.wideParsVertex,r.roundCapParsVertex,r.roundJoinParsVertex].join("\n"),lines_vertex:["#if defined(USE_DASHEDLINE) || defined(USE_WIDELINE)","\tfloat worldSizeToPixelCurr = computeWorldSizeToPixel(gl_Position);","#endif","#ifdef USE_DASHEDLINE","\t#ifndef CPU_PATTERN","\t\tfloat modelMatrixScaleX = length(modelMatrix[0]);","#ifdef FIXED_SIZE","modelMatrixScaleX *= simpleNodeData.fixedSizeScale;","#endif","#ifdef WORLD_SIZE_PATTERN","\t\tvLineDistance = modelMatrixScaleX * lineDistance;","#else","\t\tvLineDistance = worldSizeToPixelCurr * modelMatrixScaleX * lineDistance;","#endif","\t#else","\t\tvLineDistance = lineDistance;","\t#endif","#endif","#ifdef USE_DASHEDLINE","#ifdef WORLD_SIZE_PATTERN","   vPointCurr = mvPosition.xyz;","#endif","#ifdef WORLD_SIZE_PATTERN2","   vPatternStartEnd = patternStartEnd;","#endif","#endif","#ifdef USE_WIDELINE",e.getModelViewTransformationChunk("mvPosition","vec4(position, 1.0)"),e.getModelViewTransformationChunk("vec4 mvPositionPrec","vec4(previousPos.xyz, 1.0)"),e.getModelViewTransformationChunk("vec4 mvPositionSuiv","vec4(followingPos.xyz, 1.0)"),"   vec4 pmvPosition = projectionMatrix * mvPosition;","   vec4 pmvPositionPrec = projectionMatrix * mvPositionPrec;","   vec4 pmvPositionSuiv = projectionMatrix * mvPositionSuiv;","","   vec3 eps = vec3(1e-6);","   bool bPrecCurr = !all(lessThan(abs(position.xyz - previousPos.xyz), eps));","   bool bCurrNext = !all(lessThan(abs(followingPos.xyz - position.xyz), eps));","",r.wideLineClip,"   pmvPosition.y *= pixelSize.x/pixelSize.y;","   pmvPositionPrec.y *= pixelSize.x/pixelSize.y;","   pmvPositionSuiv.y *= pixelSize.x/pixelSize.y;","   float oldW = abs(pmvPosition.w);","   float oldWPrec = abs(pmvPositionPrec.w);","   float oldWSuiv = abs(pmvPositionSuiv.w);","   pmvPosition /= oldW;","   pmvPositionPrec /= oldWPrec;","   pmvPositionSuiv /= oldWSuiv;","","   float offset = getHalfWidth()  * pixelSize.x ;","   vec2 pos, posPrecCurr, posCurrNext;","   vec2 dirPrecCurr, dirCurrNext;","   float orientation = sign(sideExtrusion);","   bool parity = mod(sideExtrusion,2.0) < 0.5;","","   if (isNull(length(pmvPosition.xy - pmvPositionPrec.xy))) {","       bPrecCurr = false;","   }","   if (isNull(length(pmvPositionSuiv.xy - pmvPosition.xy))) {","       bCurrNext = false;","   }",r.wideLineExtrusion,"#if defined(USE_DASHEDLINE) || defined(USE_ROUNDCAP) || defined(USE_ROUNDJOIN)","       vec3 auxVec = vec3(pos.x, pos.y * pixelSize.y/pixelSize.x,0.0);","#endif","#ifdef USE_DASHEDLINE","#ifdef WORLD_SIZE_PATTERN","   vPointCurr = getViewSpaceConvertedPosition(pos.xy, vec2(pmvPosition.z, pmvPosition.w), oldW);","#endif","#endif","   float finalZ = getFinalZ(clipped,bvec2(bPrecCurr && !col,bCurrNext), pmvPosition.xyz, pmvPositionPrec.xyz, pmvPositionSuiv.xyz, pos, oldW, mvPosition.xyz,worldSizeToPixelCurr);",r.dashedLineInWide,r.roundCapVertex,r.roundJoinVertex,"   gl_Position = vec4(pos.x, pos.y * pixelSize.y/pixelSize.x,finalZ, pmvPosition.w);","#endif"].join("\n"),lines_pars_fragment:[t.PDSFX_albedo_pars_fragment,t.PDSFX_opacity_pars_fragment,i,r.wideParsFragment,r.dashedParsFragment,r.roundCapParsFragment,r.roundJoinParsFragment].join("\n"),lines_fragment:["#ifdef USE_DASHEDLINE","       float dist = vLineDistance.x;","       float dist2 = 0.0;","   #ifdef USE_WIDELINE","       bool isConnection = length(fwidth(vConstantCurr)) < 1e-10;","       bool resetDist2 = fwidth(resetSecondDist) > 1e-2;","\t\tif (!isConnection){","           dist += getDistance(vPointNext,vPointPrec);","\t\t} else  {","#ifdef WORLD_SIZE_PATTERN","           dist = vLineDistanceAlt + getDistance(vConstantCurr,vConstantPrec, vConstantCurr);","           dist2 = getDistance(vConstantNext,vConstantCurr, vConstantCurr);","#else","           dist = vLineDistanceAlt + getDistance(vConstantCurr,vConstantPrec, vConstantCurr, vLineDistanceLeft.y - vLineDistanceLeft.x);","           dist2 = getDistance(vConstantNext,vConstantCurr, vConstantCurr, vLineDistanceRight.y - vLineDistanceRight.x);","#endif","\t\t\tdist2 += resetDist2 ? 0.0 : vLineDistanceAlt;","\t\t}","   #endif","   #ifdef PATTERN_LENGTH","\t\tfloat ajdustedDist = getPatternDistance(dist);","       float patternAlpha = getPatternAlpha(ajdustedDist);","       #ifdef PDSFX","           ProcessLinePattern(patternAlpha, ajdustedDist);","       #endif","       if (abs(dist2) > 1e-6) {","\t\t\tfloat ajdustedDist2 = getPatternDistance(dist2);","           float patternAlpha2 = getPatternAlpha(ajdustedDist2);","           #ifdef PDSFX","               ProcessLinePattern(patternAlpha2, ajdustedDist2);","           #endif","           patternAlpha = min(patternAlpha, patternAlpha2);","       }","       if (patternAlpha > 0.5) {","           discard;","       }","   #endif","#endif","#ifdef USE_ROUNDCAP","   doRoundCap();","#endif","#ifdef USE_ROUNDJOIN","   doRoundJoins();","#endif"].join("\n")},LineShaderLib:r}}),define("DS/Visualization/ImageUtils",["DS/Mesh/ThreeJS_Base","DS/GPUFormats/GPUFormats"],function(e,t){"use strict";let i={};var r=null;i.BasisUsage={NOT_BASIS:-1,NO_TRANSCODE:0,RGB:t.RGB_S3TC_DXT1_Format,RGBA:t.RGBA_S3TC_DXT5_Format,RGBHQ:t.RGBA_BPTC_UNORM_Format,NORMAL_MAP:t.REDGREEN_RGTC2_Format,GRAYSCALE:t.RED_RGTC1_Format,BC1:t.RGB_S3TC_DXT1_Format,BC3:t.RGBA_S3TC_DXT5_Format,BC7:t.RGBA_BPTC_UNORM_Format,BC5:t.REDGREEN_RGTC2_Format,BC4:t.RED_RGTC1_Format};var n={__initBasis__:function(e){null===r?require(["DS/BasisLoader/BasisLoader"],function(t){(r=t)(function(){e()})}):r(function(){e()})}};i.Utils=n;var a=function(t,i,r,n,a,s){var o=r.s3tcSupport,l=r.astcSupport,c=r.etcSupport,h=r.etc1Support,u=r.pvrtcSupport,d=r.rgtcSupport,p=r.bptcSupport,f=r.basisUsage,m=!1;switch(f){case 0:return t.textureFormat=e.RGBAFormat,t.transcodeFormat=i.cTFRGBA32,void(t.textureType=e.UnsignedByteType);case e.RGB_S3TC_DXT1_Format:if(o)return t.textureFormat=f,void(t.transcodeFormat=i.cTFBC1_RGB);break;case e.RGBA_S3TC_DXT5_Format:if(o)return t.textureFormat=f,void(t.transcodeFormat=i.cTFBC3_RGBA);break;case e.RED_RGTC1_Format:if(d)return t.textureFormat=f,void(t.transcodeFormat=i.cTFBC4_R);m=!0;break;case e.REDGREEN_RGTC2_Format:if(d)return t.textureFormat=f,void(t.transcodeFormat=i.cTFBC5_RG);m=!0;break;case e.RGBA_BPTC_UNORM_Format:if(p)return t.textureFormat=f,void(t.transcodeFormat=n?i.cTFBC7_M5_RGBA:i.cTFBC7_M6_RGB);if(o)return t.textureFormat=n?e.RGBA_S3TC_DXT5_Format:e.RGB_S3TC_DXT1_Format,void(t.transcodeFormat=n?i.cTFBC3_RGBA:i.cTFBC1_RGB);m=!0}if(l)return t.textureFormat=e.RGBA_ASTC_4x4_Format,void(t.transcodeFormat=i.cTFASTC_4x4_RGBA);if(u)if(t.textureFormat=e.RGB_PVRTC_4BPPV1_Format,t.transcodeFormat=i.cTFPVRTC1_4_RGB,n&&(t.textureFormat=e.RGBA_PVRTC_4BPPV1_Format,t.transcodeFormat=i.cTFPVRTC1_4_RGBA),0!=(a&a-1)||0!=(s&s-1))console.error("ERROR: PVRTC1 requires square power of 2 textures");else{if(a==s)return;console.error("ERROR: PVRTC1 requires square power of 2 textures")}else{if(h&&!n)return t.textureFormat=e.RGB_ETC1_Format,void(t.transcodeFormat=i.cTFETC1_RGB);if(c)return t.textureFormat=e.RGBA8_ETC2_EAC_Format,void(t.transcodeFormat=i.cTFETC2_RGBA)}m?(e.VisualizationTraces.info("No supported compression format for basis/ktx2, rgba 8888 fallback"),t.textureFormat=e.RGBAFormat,t.transcodeFormat=i.cTFRGBA32,t.textureType=e.UnsignedByteType):n?(e.VisualizationTraces.info("No supported compression format for basis/ktx2, rgba 4444 fallback"),t.textureFormat=e.RGBAFormat,t.transcodeFormat=i.cTFRGBA4444,t.textureType=e.UnsignedShort4444Type):(e.VisualizationTraces.info("No supported compression format for basis/ktx2, rgb ushort565 fallback"),t.textureFormat=e.RGBFormat,t.transcodeFormat=i.cTFRGB565,t.textureType=e.UnsignedShort565Type)},s=function(e,t,i,r,n){var a=document.createElement("canvas");a.width=t,a.height=i;var s=a.getContext("2d"),o=s.getImageData(0,0,t,i);o.data.set(new Uint8ClampedArray(e)),s.putImageData(o,0,0);var l=document.createElement("canvas"),c=l.getContext("2d");return l.width=r,l.height=n,c.drawImage(a,0,0,t,i,0,0,r,n),o=c.getImageData(0,0,r,n),new Uint8Array(o.data)};n.loadKTX2Texture=function(t,i,o,l,c,h,u){var d,p=!!e.supportedExtensions.compressedTexturesS3TC,f=!!e.supportedExtensions.compressedTexturesRGTC,m=!!e.supportedExtensions.compressedTexturesBPTC,g=!!e.supportedExtensions.compressedTexturesASTC,v=!!e.supportedExtensions.compressedTexturesETC,S=!!e.supportedExtensions.compressedTexturesETC1,_=!!e.supportedExtensions.compressedTexturesPVRTC,y=new e.CompressedTexture;return y.image={},y.loadEndStatus=u?e.AssetLoadingStatus.PAUSED:e.AssetLoadingStatus.LOADING,i&&(y.mapping=i),null===h||h===e.BasisUsage.NOT_BASIS?(console.error("Missing required format parameter"),y):(d=function(i,r){if(!i)return console.error("Missing KTX2File in BasisLoader"),void(l&&l());!function(t,i,r,o,l,c,h,u,d){var p=function(o){var l=function(t,i){console.warn(i),r.loadEndStatus=e.AssetLoadingStatus.ERROR,h&&h(),t.close(),t.delete()},u=new t(new Uint8Array(o));if(u.isValid()){var p=u.getLevels();if(p<1)l(u,"No levels in .ktx2 file");else{var f=u.getFaces();if(f>1)if(6!==f)f=1;else{r.extraFaces=new Array(5);for(var m=0;m<5;m++)r.extraFaces[m]=new e.Texture.Face(null,[])}if(u.getHeader().pixelDepth>0)l(u,"Non 2D textures are not supported in .ktx2 files");else if(u.getLayers()>1)l(u,"Array textures are not supported in .ktx2 files");else if(u.startTranscoding()){var g=u.getWidth(),v=u.getHeight(),S={textureFormat:0,transcodeFormat:0,textureType:0},_=u.getHasAlpha();a(S,i,d,_,g,v);var y=!1;n.is_pow2(g)&&n.is_pow2(v)||(console.error("Non power of two compressed ktx2 texture, full rgba 8888 decompression for resizing"),y=!0,S.textureFormat=e.RGBAFormat,S.transcodeFormat=i.cTFRGBA32,S.textureType=e.UnsignedByteType),r.format=S.textureFormat,0!==S.textureType&&(r.flipY=0===d.basisUsage,r.type=S.textureType),r.sRGB=2===u.getDFDTransferFunc(),r.premultipliedAlpha=(1&u.getDFDFlags())>0;for(var x=0;x<f;x++){const t=0===x?r.mipmaps:r.extraFaces[x-1].mipmaps;for(var M=0;M<p;M++){var P=u.getImageLevelInfo(M,0,x);g=P.origWidth,v=P.origHeight;var C={data:null,width:0,height:0};t.push(C);var b=u.getImageTranscodedSizeInBytes(M,0,0,S.transcodeFormat),D=new Uint8Array(b);if(!u.transcodeImage(D,M,0,0,S.transcodeFormat,_,-1,-1))return void l(u,"transcodeImage failed");var w=g>=4?g+3&-4:g,E=v>=4?v+3&-4:v;C.width=w,C.height=E,y?n.is_pow2(g)&&n.is_pow2(v)?C.data=D:(e.VisualizationTraces.info("Resizing ktx2 texture to power of two"),C.width=n.nearest_smaller_pow2(g),C.height=n.nearest_smaller_pow2(v),C.data=s(D,g,v,C.width,C.height)):S.textureType===e.UnsignedShort565Type||S.textureType===e.UnsignedShort4444Type?C.data=new Uint16Array(D.buffer):C.data=D}}for(u.close(),u.delete(),r.loadEndStatus=e.AssetLoadingStatus.READY,r.needsUpdate=!0,c&&c(r),m=0;m<r.onLoadCallbacks.length;m++)r.onLoadCallbacks[m](r)}else l(u,"startTranscoding failed")}}else l(u,"Invalid .ktx2 file")};if("string"==typeof o){var f=new XMLHttpRequest;f.withCredentials=!!l,f.responseType="arraybuffer",f.open("GET",o,!0),f.onload=function(){n.nbTexturesBeingLoaded--,p(f.response)},f.onerror=function(){r.loadEndStatus=e.AssetLoadingStatus.ERROR,h&&h(),n.nbTexturesBeingLoaded--},u?(r.loadEndStatus=e.AssetLoadingStatus.PAUSED,r.onRequest=function(){n.nbTexturesBeingLoaded++,r.loadEndStatus=e.AssetLoadingStatus.LOADING,f.send(null),r.onRequest=null}):(n.nbTexturesBeingLoaded++,r.loadEndStatus=e.AssetLoadingStatus.LOADING,f.send(null))}else{if(!(o instanceof Uint8Array))return void console.error("Invalid ktx2 data: returning empty texture");p(o.buffer)}}(i,r,y,t,c,o,l,u,{s3tcSupport:p,astcSupport:g,etc1Support:S,etcSupport:v,pvrtcSupport:_,rgtcSupport:f,bptcSupport:m,basisUsage:h})},null===r?require(["DS/BasisLoader/BasisLoader"],function(e){(r=e)(function(e){d(e.KTX2File,e.BasisFormat)})}):r(function(e){d(e.KTX2File,e.BasisFormat)}),y)};n.loadBasisTexture=function(t,i,o,l,c,h,u,d){var p,f=!!e.supportedExtensions.compressedTexturesS3TC,m=!!e.supportedExtensions.compressedTexturesRGTC,g=!!e.supportedExtensions.compressedTexturesBPTC,v=!!e.supportedExtensions.compressedTexturesASTC,S=!!e.supportedExtensions.compressedTexturesETC,_=!!e.supportedExtensions.compressedTexturesETC1,y=!!e.supportedExtensions.compressedTexturesPVRTC,x=d||new e.CompressedTexture;return x.loadEndStatus=u?e.AssetLoadingStatus.PAUSED:e.AssetLoadingStatus.LOADING,x.image={},i&&(x.mapping=i),null===h||h===e.BasisUsage.NOT_BASIS?(console.error("Missing required format parameter"),x):(p=function(i,r){if(!i)return console.error("Missing BasisFile in BasisLoader"),void(l&&l());!function(t,i,r,o,l,c,h,u,d){var p=function(o){var l=function(t,i){console.warn(i),r.loadEndStatus=e.AssetLoadingStatus.ERROR,h&&h(),t.close(),t.delete()},u=new t(new Uint8Array(o)),p=u.getNumImages(),f=u.getNumLevels(0);if(p&&f)if(u.startTranscoding()){var m=u.getImageWidth(0,0),g=u.getImageHeight(0,0),v={textureFormat:0,transcodeFormat:0,textureType:0},S=u.getHasAlpha();a(v,i,d,S,m,g);var _=!1;n.is_pow2(m)&&n.is_pow2(g)||(console.error("Non power of two compressed basis texture, full rgba 8888 decompression for resizing"),_=!0,v.textureFormat=e.RGBAFormat,v.transcodeFormat=i.cTFRGBA32,v.textureType=e.UnsignedByteType),r.format=v.textureFormat,0!==v.textureType&&(r.flipY=0===d.basisUsage,r.type=v.textureType);for(var y=0;y<f;y++){m=u.getImageWidth(0,y),g=u.getImageHeight(0,y);var x={data:null,width:0,height:0};r.mipmaps.push(x);var M=u.getImageTranscodedSizeInBytes(0,y,v.transcodeFormat),P=new Uint8Array(M);if(!u.transcodeImage(P,0,y,v.transcodeFormat,0,S))return void l(u,"transcodeImage failed");var C=m>=4?m+3&-4:m,b=g>=4?g+3&-4:g;x.width=C,x.height=b,_?n.is_pow2(m)&&n.is_pow2(g)?x.data=P:(e.VisualizationTraces.info("Resizing basis texture to power of two"),x.width=n.nearest_smaller_pow2(m),x.height=n.nearest_smaller_pow2(g),x.data=s(P,m,g,x.width,x.height)):v.textureType===e.UnsignedShort565Type||v.textureType===e.UnsignedShort4444Type?x.data=new Uint16Array(P.buffer):x.data=P}u.close(),u.delete(),r.loadEndStatus=e.AssetLoadingStatus.READY,r.needsUpdate=!0,c&&c(r);for(var D=0;D<r.onLoadCallbacks.length;D++)r.onLoadCallbacks[D](r)}else l(u,"startTranscoding failed");else l(u,"Invalid .basis file")};if("string"==typeof o){var f=new XMLHttpRequest;f.withCredentials=!!l,f.responseType="arraybuffer",f.open("GET",o,!0),f.onload=function(){n.nbTexturesBeingLoaded--,p(f.response)},f.onerror=function(){r.loadEndStatus=e.AssetLoadingStatus.ERROR,h&&h(),n.nbTexturesBeingLoaded--},u?(r.loadEndStatus=e.AssetLoadingStatus.PAUSED,r.onRequest=function(){n.nbTexturesBeingLoaded++,r.loadEndStatus=e.AssetLoadingStatus.LOADING,f.send(null),r.onRequest=null}):(n.nbTexturesBeingLoaded++,r.loadEndStatus=e.AssetLoadingStatus.LOADING,f.send(null))}else{if(!(o instanceof Uint8Array))return void console.error("Invalid basis data: returning empty texture");p(o.buffer)}}(i,r,x,t,c,o,l,u,{s3tcSupport:f,astcSupport:v,etc1Support:_,etcSupport:S,pvrtcSupport:y,rgtcSupport:m,bptcSupport:g,basisUsage:h})},null===r?require(["DS/BasisLoader/BasisLoader"],function(e){(r=e)(function(e){p(e.BasisFile,e.BasisFormat)})}):r(function(e){p(e.BasisFile,e.BasisFormat)}),x)},n.nbTexturesBeingLoaded=0,n.crossOrigin="anonymous",n.is_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.floor(t)===t},n.nearest_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.round(t))},n.nearest_greater_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.ceil(t))},n.nearest_smaller_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.floor(t))},n._loadTextureWithProxy=function(t,i,r,n,a,s,o,l){return window.ds&&window.ds.env&&"MOBILE"===window.ds.env&&(t=UWA.Data.proxifyUrl(t,{proxy:"passport"})),e.ImageUtils.loadTexture(t,i,r,n,a,s,o,l)},n.loadTexture=function(t,i,r,a,s,o,l,c){var h=this,u=document.createElement("canvas");u.width=16,u.height=16;var d=c;d?(d.image=u,d.mapping=i):d=new e.Texture(u,i),d.loadEndStatus=e.AssetLoadingStatus.LOADING;var p=null!=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),f=!t.startsWith("data:");if(p&&f&&(void 0===s||!1===s)){var m={headers:new Object,method:"GET",authentication:"ajax",timeout:36e5,async:!0,type:"blob",onComplete:function(t){var i=URL.createObjectURL(t),s=new Image,l=new e.ImageLoader;l.addEventListener("load",function(t){var i,a;n.nbTexturesBeingLoaded--,d.needsUpdate=!0,d.loadEndStatus=e.AssetLoadingStatus.READY,!o||h.is_pow2(s.width)&&h.is_pow2(s.height)?d.image=s:(i=h.nearest_pow2(s.width),a=h.nearest_pow2(s.height),d.image.width=i,d.image.height=a,d.image.getContext("2d").drawImage(s,0,0,i,a)),r&&r(d);for(var l=0;l<d.onLoadCallbacks.length;l++)d.onLoadCallbacks[l](d)}),l.addEventListener("error",function(t){n.nbTexturesBeingLoaded--,a&&a(t.message),d.loadEndStatus=e.AssetLoadingStatus.ERROR}),l.load(i,s)},onFailure:function(t){n.nbTexturesBeingLoaded--,a&&a(event.message),d.loadEndStatus=e.AssetLoadingStatus.ERROR},onTimeout:function(){n.nbTexturesBeingLoaded--,a&&a(event.message),d.loadEndStatus=e.AssetLoadingStatus.ERROR}};UWA.Data.request(t,m)}else{var g=new Image;null!==s&&(g.crossOrigin=s?"use-credentials":"anonymous");var v=new e.ImageLoader;v.addEventListener("load",function(t){var i,a;n.nbTexturesBeingLoaded--,d.needsUpdate=!0,d.loadEndStatus=e.AssetLoadingStatus.READY,!o||h.is_pow2(g.width)&&h.is_pow2(g.height)?d.image=g:(i=h.nearest_pow2(g.width),a=h.nearest_pow2(g.height),d.image.width=i,d.image.height=a,d.image.getContext("2d").drawImage(g,0,0,i,a)),r&&r(d);for(var s=0;s<d.onLoadCallbacks.length;s++)d.onLoadCallbacks[s](d)}),v.addEventListener("error",function(t){n.nbTexturesBeingLoaded--,a&&a(t.message),d.loadEndStatus=e.AssetLoadingStatus.ERROR}),g.crossOrigin&&(v.crossOrigin=g.crossOrigin),l?(d.loadEndStatus=e.AssetLoadingStatus.PAUSED,d.onRequest=function(){d.loadEndStatus=e.AssetLoadingStatus.LOADING,v.load(t,g),n.nbTexturesBeingLoaded++,d.onRequest=null}):(v.load(t,g),n.nbTexturesBeingLoaded++),d.sourceFile=t}return d},n.loadTexture2=function(e,t,i,r,a){return console.warn("loadTexture2 is deprecated, use loadTexture with forcePowerOfTwo parameter activated"),n.loadTexture(e,t,i,r,a,!0)},n.loadTGATexture=function(t,i,r,a,s,o){var l=new e.DataTexture(new Uint8Array(16),2,2,e.RGBAFormat,e.UnsignedByteType);l.mapping=i;var c=new XMLHttpRequest;return c.onload=function(){n.nbTexturesBeingLoaded--;var t=new Uint8Array(c.response),i=12,a=t[i]+256*t[i+1],s=t[i+=2]+256*t[i+1];i+=4,l.image.data=new Uint8Array(4*a*s);var o=l.image.data;l.image.width=a,l.image.height=s;for(var h=0;h<s;h++)for(var u=0;u<a;u++){var d=h*a+u;o[4*d]=t[i+4*d+2],o[4*d+1]=t[i+4*d+1],o[4*d+2]=t[i+4*d],o[4*d+3]=t[i+4*d+3]}l.loadEndStatus=e.AssetLoadingStatus.READY,l.generateMipmaps=!1,l.needsUpdate=!0,r&&r(l);for(var p=0;p<l.onLoadCallbacks.length;p++)l.onLoadCallbacks[p](l)},c.onerror=function(){a&&a(),n.nbTexturesBeingLoaded--,l.loadEndStatus=e.AssetLoadingStatus.ERROR},o?(l.loadEndStatus=e.AssetLoadingStatus.PAUSED,l.onRequest=function(){l.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,c.open("GET",t,!0),c.responseType="arraybuffer",c.withCredentials=!!s,c.send(null),l.onRequest=null}):(l.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,c.open("GET",t,!0),c.responseType="arraybuffer",c.withCredentials=!!s,c.send(null)),l},n.loadHDRTexture=function(t,i,r,a,s,o,l,c,h,u){var d=u||new e.DataTexture;d.loadEndStatus=e.AssetLoadingStatus.LOADING,d.hdr=!0,d.sRGB=!1,d.mapping=i,d.needsSH=!1,d.shFactorsR=null,d.shFactorsG=null,d.shFactorsB=null;var p=this,f=new XMLHttpRequest;return f.onload=function(){n.nbTexturesBeingLoaded--;var t=f.response,a=n.parseRadianceHDR(t,i,s,o,l);if(!p.is_pow2(a.width)||!p.is_pow2(a.height)){var c=p.nearest_pow2(a.width),h=p.nearest_pow2(a.height);!function(e,t,i,r){if(t){for(var n=new Float32Array(3*i*r),a=(e.width-1)/(i-1),s=(e.height-1)/(r-1),o=0;o<r;o++)for(var l=0;l<i;l++){var c=i*o+l,h=a*l,u=s*o,d=e.width*Math.floor(u)+Math.floor(h);n[3*c]=e.data[3*d],n[3*c+1]=e.data[3*d+1],n[3*c+2]=e.data[3*d+2]}e.data=n,e.width=i,e.height=r}}(a,s,c,h)}d.format=a.format,d.type=a.type,d.image.data=a.data,d.image.width=a.width,d.image.height=a.height,d.loadEndStatus=e.AssetLoadingStatus.READY,d.needsSH&&n.computeSphericalHarmonics(d),d.generateMipmaps=!0,d.needsUpdate=!0,r&&r(d);for(var u=0;u<d.onLoadCallbacks.length;u++)d.onLoadCallbacks[u](d)},f.onerror=function(){d.loadEndStatus=e.AssetLoadingStatus.ERROR,a&&a(),n.nbTexturesBeingLoaded--},h?(d.loadEndStatus=e.AssetLoadingStatus.PAUSED,d.onRequest=function(){d.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,f.open("GET",t,!0),f.responseType="arraybuffer",f.withCredentials=!!c,f.send(null),d.onRequest=null}):(d.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,f.open("GET",t,!0),f.responseType="arraybuffer",f.withCredentials=!!c,f.send(null)),d},n._loadTextureVisu=function(e,t,i,r,a,s,o){var l=require.toUrl("DS/"+e+"/assets/"+t);return n.loadTexture(l,i,r,a,s,o)};return n.streamHDRFormat=function(e,t,i){for(var r=function(e,t){var i=function(e,t,i){for(var r=0;r<t.length;r++)e[i++]=t.charCodeAt(r);return i},r="# Made with Dassault Systemes HDR mipmap roughness generator - TZW",n="-Y "+t+" +X "+e,a=new Uint8Array("#?RADIANCE".length+1+r.length+1+"FORMAT=32-bit_rle_rgbe".length+2+n.length+1+e*t*4),s=0;return s=i(a,"#?RADIANCE",s),a[s++]=10,s=i(a,r,s),a[s++]=10,s=i(a,"FORMAT=32-bit_rle_rgbe",s),a[s++]=10,a[s++]=10,s=i(a,n,s),a[s++]=10,{buffer:a,offset:s,width:e,height:t}}(t,i),n=r.buffer,a=r.offset,s=i-1,o=0;o<i;o++){for(var l=t-1,c=0;c<t;c++){for(var h=0;h<4;h++)n[a+4*(t*o+c)+h]=e[4*(t*s+l)+h];l--}s--}return function(e){for(var t=function(e){for(var t=new Uint8Array(2*e.length),i=0;i<e.length;i++)t[i]=e[i];return t},i=e.offset,r=i,n=new Uint8Array(e.buffer.length),a=0;a<i;a++)n[a]=e.buffer[a];for(var s=new Uint8Array(4+5*e.width),o=0;o<e.height;o++){var l=0;s[l++]=2,s[l++]=2,s[l++]=e.width>>8,s[l++]=255&e.width;for(var c=0;c<4;c++){var h=[];for(a=0;a<e.width;){for(var u=0,d=e.buffer[i+4*(o*e.width+a)+c],p=d;a<e.width&&p===d&&u<127;)u++,a++,d=p,p=e.buffer[i+4*(o*e.width+a)+c];if(u>3){if(h.length){s[l++]=h.length;for(var f=0;f<h.length;f++)s[l++]=h[f];h=[]}s[l++]=128+u,s[l++]=d}else{if(h.length+u>127){for(s[l++]=h.length,f=0;f<h.length;f++)s[l++]=h[f];h=[]}h.push(d),u>1&&h.push(d),u>2&&h.push(d)}}if(h.length)for(s[l++]=h.length,f=0;f<h.length;f++)s[l++]=h[f]}r+l>=n.length&&(n=t(n));for(var m=0;m<l;m++)n[r++]=s[m]}var g=new Uint8Array(r);for(a=0;a<r;a++)g[a]=n[a];e.buffer=g}(r),new Blob([r.buffer],{type:"application/octet-binary"})},n.generateBlankHDRTexture=function(t,i){var r=new e.DataTexture;r.hdr=!0,r.sRGB=!1,r.mapping=new e.LatLongReflectionMapping,r.needsSH=!1,r.shFactorsR=null,r.shFactorsG=null,r.shFactorsB=null,r.format=e.RGBAFormat,r.type=e.UnsignedByteType,r.image.width=t,r.image.height=i,r.loadEndStatus=e.AssetLoadingStatus.READY,r.generateMipmaps=!0,r.needsUpdate=!0;for(var n=new Uint8Array(4*t*i),a=0;a<t*i;a++)n[4*a]=255,n[4*a+1]=255,n[4*a+2]=255,n[4*a+3]=127;return r.image.data=n,r},n.computeSphericalHarmonics=function(t){t.mapping;var i,r,n=t.image.data,a=t.image.width,s=t.image.height;if(void 0!==n){if(null===t.shFactorsR){var o=[];for(i=0;i<3;i++)for(o[i]=[],r=0;r<9;r++)o[i][r]=0;var l=function(e){return Math.abs(e)<1e-4?1:Math.sin(e)/e},c=function(e,t,i,r,s,l){var c,h=4*(a*t+e),u=Math.pow(2,n[h+3]-128);for(c=0;c<3;c++){var d,p=1/256*n[h+c]*u;d=.282095,o[c][0]+=p*d*i,d=.488603,o[c][1]+=p*(d*s)*i,o[c][2]+=p*(d*l)*i,o[c][3]+=p*(d*r)*i,d=1.092548,o[c][4]+=p*(d*r*s)*i,o[c][5]+=p*(d*s*l)*i,o[c][7]+=p*(d*r*l)*i,d=.315392,o[c][6]+=p*(d*(3*l*l-1))*i,d=.546274,o[c][8]+=p*(d*(r*r-s*s))*i}return o};if(t.mapping instanceof e.LatLongReflectionMapping)for(r=0;r<s;r++)for(i=0;i<a;i++){h=i/a,u=r/s,f=Math.PI*(2*h-1),p=Math.PI*u,m=Math.sin(p)*Math.cos(f),g=Math.sin(p)*Math.sin(f),v=Math.cos(p),c(i,r,Math.PI/a*2*(Math.PI/s)*Math.sin(p),m,g,v)}else for(i=0;i<a;i++)for(r=0;r<a;r++){var h,u,d,p,f,m,g,v;u=(a/2-i)/(a/2),h=(r-a/2)/(a/2),(d=Math.sqrt(h*h+u*u))>1||(p=Math.PI*d,f=Math.atan2(u,h),m=Math.sin(p)*Math.cos(f),g=Math.sin(p)*Math.sin(f),v=Math.cos(p),c(i,r,2*Math.PI/a*(2*Math.PI/a)*l(p),m,g,v))}var S=function(){var t,i,r;i=.429043,r=.511664;var n=[];for(n[0]=new e.Matrix4,n[1]=new e.Matrix4,n[2]=new e.Matrix4,t=0;t<3;t++)n[t].elements[0]=i*o[t][8],n[t].elements[1]=i*o[t][4],n[t].elements[2]=i*o[t][7],n[t].elements[3]=r*o[t][3],n[t].elements[4]=i*o[t][4],n[t].elements[5]=-i*o[t][8],n[t].elements[6]=i*o[t][5],n[t].elements[7]=r*o[t][1],n[t].elements[8]=i*o[t][7],n[t].elements[9]=i*o[t][5],n[t].elements[10]=.743125*o[t][6],n[t].elements[11]=r*o[t][2],n[t].elements[12]=r*o[t][3],n[t].elements[13]=r*o[t][1],n[t].elements[14]=r*o[t][2],n[t].elements[15]=.886227*o[t][0]-.247708*o[t][6];return n}();null!==S&&(t.shFactorsR=S[0],t.shFactorsG=S[1],t.shFactorsB=S[2])}}else t.needsSH=!0},n.loadTextureCube=function(t,i,r,a){var s={images:[],loadCount:0},o=new e.Texture;o.loadEndStatus=e.AssetLoadingStatus.LOADING,void 0!==i&&(o.mapping=i),o.flipY=!1;for(var l=0;l<t.length;++l){var c=new Image;s.images[l]=c,c.onload=function(){if(s.loadCount+=1,n.nbTexturesBeingLoaded--,6===s.loadCount){o.loadEndStatus!==e.AssetLoadingStatus.ERROR&&(o.loadEndStatus=e.AssetLoadingStatus.READY),o.needsUpdate=!0,o.image=s.images[0],o.extraFaces=new Array(5);for(var t=1;t<s.images.length;t++)o.extraFaces[t-1]=new e.Texture.Face(s.images[t],null);r&&r(o);for(t=0;t<o.onLoadCallbacks.length;t++)o.onLoadCallbacks[t](o)}},c.onerror=function(){s.loadCount+=1,n.nbTexturesBeingLoaded--,o.loadEndStatus=e.AssetLoadingStatus.ERROR,a&&a()},c.crossOrigin=this.crossOrigin,n.nbTexturesBeingLoaded++,c.src=t[l]}return o},n.parseRadianceHDR=function(t,i,r,n,a){var s,o={data:null,width:0,height:0,format:r?e.RGBFormat:e.RGBAFormat,type:r?e.FloatType:e.UnsignedByteType},l={offset:0,data:new Uint8Array(t)},c="";for(s=0;s<10;s++)c+=String.fromCharCode(l.data[l.offset++]);if("#?RADIANCE"!==c)return o;for(var h,u=0;h=u,10!=(u=l.data[l.offset++])||10!=h;);for(var d="";10!=(u=l.data[l.offset++]);)d+=String.fromCharCode(u);if(null===new RegExp(/[-,+][X,Y]\s+([0-9]+)\s+[-,+][X,Y]\s+([0-9]+)/i).exec(d))return o;o.height=RegExp.$1,o.width=RegExp.$2,o.data=r?new Float32Array(o.width*o.height*3):new Uint8Array(o.width*o.height*4);for(var p=new Uint8Array(4*o.width),f=n?(o.height-1)*(r?3:4)*o.width:0,m=function(e,t){return.00390625*t*e},g=function(e,t,i,r){for(a&&(r+=3*(t-1));t-- >0;){var n=Math.pow(2,e[4*t+3]-128);i[r++]=m(n,e[4*t]),i[r++]=m(n,e[4*t+1]),i[r++]=m(n,e[4*t+2]),a&&(r-=6)}},v=function(e,t,i,r){for(;t-- >0;)i[r++]=e[4*t],i[r++]=e[4*t+1],i[r++]=e[4*t+2],i[r++]=e[4*t+3]},S=function(e,t,i){var r,n;if(t<8||t>32767)return _(e,0,t,i);if(2!==(r=i.data[i.offset]))return _(e,0,t,i);if(i.offset++,e[1]=i.data[i.offset++],e[2]=i.data[i.offset++],r=i.data[i.offset++],2!=e[1]||128&e[2])return e[0]=2,e[3]=r,_(e,1,t-1,i);for(r=0;r<4;r++)for(n=0;n<t;){var a=i.data[i.offset++];if(a>128){a&=127;for(var s=i.data[i.offset++];a--;)e[4*n+r]=s,n++}else for(;a--;)e[4*n+r]=i.data[i.offset++],n++}return!(i.data.length===i.offset)},_=function(e,t,i,r){for(var n,a=0;i>0;)if(e[4*t]=r.data[r.offset++],e[4*t+1]=r.data[r.offset++],e[4*t+2]=r.data[r.offset++],e[4*t+3]=r.data[r.offset++],1===e[4*t]&&1===e[4*t+1]&&1===e[4*t+2]){for(n=e[4*t+3]<<a;n>0;n--)e[4*t]=e[4*(t-1)],e[4*t+1]=e[4*(t-1)+1],e[4*t+2]=e[4*(t-1)+2],e[4*t+3]=e[4*(t-1)+3],t++,i--;a+=8}else t++,i--,a=0;return!0},y=o.height-1;y>=0;y--)S(p,o.width,l),r?(g(p,o.width,o.data,f),n?f-=3*o.width:f+=3*o.width):(v(p,o.width,o.data,f),f+=4*o.width);return o},n.streamDDS=function(t){function i(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}for(var r=i("DXT1"),n=i("DXT3"),a=i("DXT5"),s=0,o=0;o<t.mipmaps.length;o++)s+=t.mipmaps[o].data.length;var l=new ArrayBuffer(128+s),c=new Int32Array(l,0,32);switch(c[0]=542327876,c[1]=124,c[2]=659463,c[3]=t.image.height,c[4]=t.image.width,c[5]=65536,c[7]=t.mipmaps.length,c[19]=32,c[20]=4,t.format){case e.RGB_S3TC_DXT1_Format:c[21]=r;break;case e.RGB_S3TC_DXT3_Format:c[21]=n;break;case e.RGB_S3TC_DXT5_Format:c[21]=a;break;case e.RGBAFormat:c[20]|=1;case e.RGBFormat:c[20]|=64,c[23]=255,c[24]=65280,c[25]=16711680,c[26]=4278190080;break;default:return void console.error("ImageUtils.streamDDS(): Unsupported FourCC code: ")}c[27]=4198408;var h=new Uint8Array(l,128,s),u=0;for(o=0;o<t.mipmaps.length;o++){for(var d=t.mipmaps[o].data,p=0;p<d.length;p++)h[u+p]=d[p];u+=d.length}return l},n.crossOriginPolicy=!0,n.loadTextureFromFormat=function(e,t,i,r){var a;return"dds"===t?a=n.loadCompressedTexture(blobUrl,null,function(){i&&i(a)},function(){r&&r(a)},!0):"hdr"===t?a=n.loadHDRTexture(blobUrl,null,function(){i&&i(a)},function(){r&&r(a)},!0,!1,!0):(a=n.loadTexture(blobUrl,null,function(){i&&i(a)},function(){r&&r(a)},void 0,!0)).flipY=!0,a},n.loadCompressedTexture=function(t,i,r,a,s,o,l){var c=l||new e.CompressedTexture;c.mapping=i;var h=new XMLHttpRequest;return h.onload=function(){n.nbTexturesBeingLoaded--;var t=h.response,i=n.parseDDS(t,!0,s);if(c.sRGB=i.sRGB,c.format=i.format,i.type&&(c.type=i.type),c.width=i.width,c.height=i.height,i.isCubemap){c.image={data:null,width:i.width,height:i.height};var a=i.mipmaps.length/i.mipmapCount;c.extraFaces=new Array(a-1);for(var o=0;o<a;o++){var l=c;o>0&&(l=new e.Texture.Face(null,[]),c.extraFaces[o-1]=l);for(var u=0;u<i.mipmapCount;u++)l.mipmaps.push(i.mipmaps[o*i.mipmapCount+u])}var d=c.extraFaces[2];c.extraFaces[2]=c.extraFaces[1],c.extraFaces[1]=d}else c.mipmaps=i.mipmaps,c.image.width=i.width,c.image.height=i.height;c.generateMipmaps=!1,(!c.mipmaps||c.mipmaps&&c.mipmaps.length<2)&&(1003!=c.magFilter&&1006!=c.magFilter&&(c.magFilter=1006),1003!=c.minFilter&&1006!=c.minFilter&&(c.minFilter=1006)),c.needsUpdate=!0,c.loadEndStatus=e.AssetLoadingStatus.READY,r&&r(c);for(u=0;u<c.onLoadCallbacks.length;u++)c.onLoadCallbacks[u](c)},o?(c.loadEndStatus=e.AssetLoadingStatus.PAUSED,c.onRequest=function(){c.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,h.open("GET",t,!0),h.responseType="arraybuffer",h.send(null),c.onRequest=null}):(c.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,h.open("GET",t,!0),h.responseType="arraybuffer",h.send(null)),c},n.loadCompressedTextureFromBuffer=function(t,i){var r=new e.CompressedTexture;r.loadEndStatus=e.AssetLoadingStatus.READY,r.mapping=i;var a=n.parseDDS(t,!0);return r.format=a.format,r.mipmaps=a.mipmaps,r.image.width=a.width,r.image.height=a.height,r.generateMipmaps=!1,r.needsUpdate=!0,r},n.parseDDS=function(t,i,r){void 0===r&&(r=!0);var a={mipmaps:[],width:0,height:0,sRGB:!1,format:null,mipmapCount:1};function s(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function o(e){var t=e[4];e[4]=e[7],e[7]=t,t=e[5],e[5]=e[6],e[6]=t}function l(e){var t=e[4];e[4]=e[5],e[5]=t}function c(e){var t=e[0];e[0]=e[6],e[6]=t,t=e[1],e[1]=e[7],e[7]=t,t=e[2],e[2]=e[4],e[4]=t,t=e[3],e[3]=e[5],e[5]=t,o(e.subarray(8,16))}function h(e){var t=e[0];e[0]=e[2],e[2]=t,t=e[1],e[1]=e[3],e[3]=t,o(e.subarray(8,16))}function u(e){var t=e[2]+256*(e[3]+256*e[4]),i=e[5]+256*(e[6]+256*e[7]),r=(4095&t)<<12|(16773120&t)>>12,n=(4095&i)<<12|(16773120&i)>>12;e[2]=255&n,e[3]=(65280&n)>>8,e[4]=(16711680&n)>>8,e[5]=255&r,e[6]=(65280&r)>>8,e[7]=(16711680&r)>>8,o(e.subarray(8,16))}function u(e){var t=e[2]+256*(e[3]+256*e[4]),i=e[5]+256*(e[6]+256*e[7]),r=(4095&t)<<12|(16773120&t)>>12,n=(4095&i)<<12|(16773120&i)>>12;e[2]=255&n,e[3]=(65280&n)>>8,e[4]=(16711680&n)>>8,e[5]=255&r,e[6]=(65280&r)>>8,e[7]=(16711680&r)>>8,o(e.subarray(8,16))}function d(e){var t=(4095&e[2]+256*(e[3]+256*e[4]))<<12;e[2]=255&t,e[3]=(65280&t)>>8,e[4]=(16711680&t)>>8,o(e.subarray(8,16))}function p(e,t){var i;for(i=0;i<e.length;i++)e[i]=t[i]}var f=s("DXT1"),m=s("DXT3"),g=s("DXT5"),v=s("DX10"),S=new Int32Array(t,0,36);if(542327876!==S[0])return console.error("ImageUtils.parseDDS(): Invalid magic number in DDS header"),a;var _,y,x=S[23],M=S[24],P=S[25],C=S[26],b=S[21];if(b===v){var D=S[32];(4&S[34]||6===S[35])&&(a.isCubemap=!0),28===D?(a.format=e.RGBAFormat,_=4):6===D&&(a.format=e.RGBFormat,_=12,a.type=e.FloatType,r=!1)}else{switch(b){case f:_=8,a.format=e.RGB_S3TC_DXT1_Format;break;case m:_=16,a.format=e.RGBA_S3TC_DXT3_Format;break;case g:_=16,a.format=e.RGBA_S3TC_DXT5_Format;break;default:if(r=!1,116===b)a.format=e.RGBAFormat,a.type=e.FloatType,_=16;else if(113==b);else if(32===S[22]&&16711680&S[23]&&65280&S[24]&&255&S[25]&&4278190080&S[26])a.format=e.RGBAFormat,_=4;else{if(!(64&S[20]))return console.error("ImageUtils.parseDDS(): Unsupported FourCC code: ",(y=b,String.fromCharCode(255&y,y>>8&255,y>>16&255,y>>24&255))),a;1&S[20]?(a.format=e.RGBAFormat,_=4):(a.format=e.RGBFormat,_=3)}}var w=S[28];if(a.isCubemap=!!(512&w),a.isCubemap&&(!(1024&w)||!(2048&w)||!(4096&w)||!(8192&w)||!(16384&w)||!(32768&w)))return console.error("THREE.DDSLoader.parse: Incomplete cubemap faces"),a}a.mipmapCount=1,131072&S[2]&&!1!==i&&(a.mipmapCount=Math.max(1,S[7])),a.width=S[4],a.height=S[3];var E=S[1]+4;b===v&&(E+=20);for(var T=a.isCubemap?6:1,A=b===f||b===m||b===g,I=0;I<T;I++){var R=a.width,L=a.height,O=R*L;A&&(O=Math.ceil(R/4)*Math.ceil(L/4)),O*=_;for(var N=0;N<a.mipmapCount;N++){var F=null;A?(E+O>t.byteLength&&console.log("dxterror"),F=new Uint8Array(t,E,O)):F=16===_?new Float32Array(t,E,O/4):12===_?new Float32Array(t,E,O/4):0===b&&3!==_?n.getImageFromColorMasks(t,E,O,x,M,P,C):n.loadARGBMip(t,E,R,L,_);var V={data:F,width:R,height:L};a.mipmaps.push(V),E+=O,(R/=2)<1&&(R=1),(L/=2)<1&&(L=1),O=A?Math.ceil(R/4)*Math.ceil(L/4):R*L,O*=_}}return r&&function(t,i,r,n,a){var s,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E;switch(n){case e.RGB_S3TC_DXT1_Format:m=8,s=o,f=l;break;case e.RGBA_S3TC_DXT3_Format:m=16,s=c,f=h;break;case e.RGBA_S3TC_DXT5_Format:m=16,s=u,f=d;break;default:return console.error("flip dds error"),a}for(g=t,v=i,x=0;x<r&&(P=a[x].data,y=(S=Math.floor((g+3)/4))*(_=Math.floor((v+3)/4)),1!=v);++x){if(2==v)for(w=0;w<S;w++)f(P.subarray(M,w*m)),M=+m;else{for(M=0,w=1;w<=y;w++)s(P.subarray(M,w*m)),M+=m;E=m*S,D=new Uint8Array(E);for(var T=0;T<_/2;++T)C=P.subarray(T*E,(T+1)*E),b=P.subarray((_-T-1)*E,(_-T)*E),p(D,C),p(C,b),p(b,D)}(g/=2)<1&&(t=1),(v/=2)<1&&(i=1)}}(a.width,a.height,a.mipmapCount,a.format,a.mipmaps),a},n.loadARGBMip=function(e,t,i,r,n){for(var a=i*r*n,s=(4-n*i%4)%4,o=a+r*s,l=new Uint8Array(e,t,a),c=new Uint8Array(o),h=0,u=0,d=0;d<r;d++){for(var p=0;p<i;p++){var f,m=l[u],g=l[++u],v=l[++u];u++,4===n&&(f=l[u],u++),c[h]=m,c[++h]=g,c[++h]=v,h++,4===n&&(c[h]=f,h++)}h+=s}return c},n.getImageFromColorMasks=function(e,t,i,r,a,s,o){for(var l=new Int32Array(e,t,i/4),c=new Uint8Array(i),h=n.computeMaskShift(r),u=n.computeMaskShift(a),d=n.computeMaskShift(s),p=n.computeMaskShift(o),f=0;f<i/4;f++){var m=l[f];c[4*f]=(m&r)>>h,c[4*f+1]=(m&a)>>u,c[4*f+2]=(m&s)>>d,c[4*f+3]=(m&o)>>p}return c},n.computeMaskShift=function(e){for(var t=e,i=0;!(1&t);)t>>=1,i++;return i},n.loadVideoTexture=function(t,i){var r=new e.Texture(t,i);return r.forceUpdate=!0,r.generateMipmaps=!1,r.loadEndStatus=e.AssetLoadingStatus.READY,r},i}),define("DS/Visualization/ThreeJS_R57",["DS/Mesh/ThreeJS_Base","DS/Visualization/FixedSizeArrayPool","DS/Visualization/OutlineBuilder","DS/Visualization/SectionBuilder","DS/Visualization/BufferGPUManager","DS/Shaders/DefaultShaders","DS/Shaders/LineDSShaders","DS/Visualization/ShaderChunk","UWA/Data","WebappsUtils/WebappsUtils","DS/Visualization/HighlightData","DS/Object3D/Object3D","DS/Object3D/Light","DS/Object3D/Camera","DS/Visualization/Materials","DS/Visualization/UniformsUtils","DS/Visualization/ShaderLib","DS/MaterialLibs/UniformsLib","DS/Shaders/DeferrableShaders","DS/Object3D/Mesh","DS/Object3D/Scene","DS/Visualization/WebGLObjectManager","DS/Visualization/CullingSystem","DS/GPUFormats/GPUFormats","DS/Visualization/ImplicitGeometries","DS/Visualization/ExplicitGeometries","DS/Visualization/Curves","DS/Visualization/Shapes","DS/Visualization/ImageUtils","DS/RenderEngineUtils/RenderEngineUtils","DS/Visualization/SkinningTransformation","DS/Visualization/Info"],function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E,T,A,I){"use strict";var R="undefined"!=typeof EXPERIENCE_PLAYER,L=window.SIMULATE_EXPERIENCE_PLAYER,O={FrontSide:0,BackSide:1,DoubleSide:2};O.BoundaryPointRenderPointMask=e.GeomTypeEnum.BOUNDARY_POINT,O.SharpPointRenderPointMask=e.GeomTypeEnum.SHARP_POINT,O.SmoothPointRenderPointMask=e.GeomTypeEnum.SMOOTH_POINT,O.SurfacicPointRenderPointMask=e.GeomTypeEnum.SURFACIC_POINT,O.FreePointRenderPointMask=e.GeomTypeEnum.FREE_POINT,O.AllPointsRenderPointMask=O.BoundaryPointRenderPointMask|O.SharpPointRenderPointMask|O.SmoothPointRenderPointMask|O.SurfacicPointRenderPointMask|O.FreePointRenderPointMask,O.AllPointsButSurfacicPointsRenderPointMask=O.BoundaryPointRenderPointMask|O.SharpPointRenderPointMask|O.SmoothPointRenderPointMask|O.FreePointRenderPointMask,e.Constants=O,e.FrontSide=O.FrontSide,e.BackSide=O.BackSide,e.DoubleSide=O.DoubleSide,e.NoOccurrences="true"===localStorage.getItem("WebVisuPrivate_NoOccurrences"),e.disableJHGDev=!0,e.WebGLVersion=2,e._setForceDevicePixelRatio=function(e){this._forceDevicePixelRatio=e},e._forceDevicePixelRatio=-1,e.getDevicePixelRatio=function(){return-1!==this._forceDevicePixelRatio?this._forceDevicePixelRatio:window.devicePixelRatio},self.console=self.console||{info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}},self.Int32Array=self.Int32Array||Array,self.Float32Array=self.Float32Array||Array,String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")};var N=new e.Color,F=e.__visibleInCurrentSpace,V=e.__visibleInCurrentSpaceSimple;!function(){for(var e=0,t=["ms","moz","webkit","o"],i=0;i<t.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"CancelRequestAnimationFrame"];void 0===window.requestAnimationFrame&&(window.requestAnimationFrame=function(t){var i=Date.now(),r=Math.max(0,16-(i-e)),n=window.setTimeout(function(){t(i+r,!1)},r);return e=i+r,n}),window.cancelAnimationFrame=window.cancelAnimationFrame||function(e){window.clearTimeout(e)}}(),e.getColorHex=function(e){return N.set(e),N.getHex()},e.__renderTargetID=0,e.CullFaceNone=0,e.CullFaceBack=1,e.CullFaceFront=2,e.CullFaceFrontBack=3,e.FrontFaceDirectionCW=0,e.FrontFaceDirectionCCW=1,e.BasicShadowMap=0,e.PCFShadowMap=1,e.PCFSoftShadowMap=2,e.PCFInterpolShadowMap=3,e.PCFPoissonShadowMap=4,e.PCFOptimizedShadowMap=5,e.ESMShadowMap=6,e.ESMImprovedShadowMap=7,e.LowQuality=0,e.MediumQuality=1,e.HighQuality=2,e.NoShading=0,e.FlatShading=1,e.SmoothShading=2,e.FrontToBack=0,e.BackToFront=1,e.VertexColorType={NoColors:0,Face:1,RGBA:2,RGB:3,A:4,R:8,G:16,B:32},e.NoColors=e.VertexColorType.NoColors,e.FaceColors=e.VertexColorType.Face,e.VertexColors=e.VertexColorType.RGBA,e.VertexColorsRGBA=e.VertexColorType.RGBA,e.VertexColorsRGB=e.VertexColorType.RGB,e.VertexColorsA=e.VertexColorType.A,e.NoBlending=0,e.NormalBlending=1,e.AdditiveBlending=2,e.SubtractiveBlending=3,e.MultiplyBlending=4,e.CustomBlending=5,e.NormalDepthBlending=6,e.AlphaBlending=7,e.GroundShadowBlending=8,e.TransparentShadowBlending=9,e.OITAccumBlending=10,e.OITRevealBlending=11,e.AddEquation=100,e.SubtractEquation=101,e.ReverseSubtractEquation=102,e.MinEquation=103,e.MaxEquation=104,e.ZeroFactor=200,e.OneFactor=201,e.SrcColorFactor=202,e.OneMinusSrcColorFactor=203,e.SrcAlphaFactor=204,e.OneMinusSrcAlphaFactor=205,e.DstAlphaFactor=206,e.OneMinusDstAlphaFactor=207,e.DstColorFactor=208,e.OneMinusDstColorFactor=209,e.SrcAlphaSaturateFactor=210,e.MultiplyOperation=0,e.MixOperation=1,e.AddOperation=2,e.SmoothEdgeRenderLineModeMask=e.GeomTypeEnum.SMOOTH_EDGE,e.SharpEdgeRenderLineModeMask=e.GeomTypeEnum.SHARP_EDGE,e.WireEdgeRenderLineModeMask=e.GeomTypeEnum.WIRE_EDGE,e.BoundaryEdgeRenderLineModeMask=e.GeomTypeEnum.BOUNDARY_EDGE,e.HideAllRenderLineMode=0,e.OutlineMask=e.GeomTypeEnum._OUTLINE,e.SectionLineMask=e.GeomTypeEnum._SECTION_LINE,e.HideWireEdgesRenderLineMode=e.GeomTypeEnum.EDGE|e.SmoothEdgeRenderLineModeMask|e.SharpEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.HideSmoothEdgesRenderLineMode=e.GeomTypeEnum.EDGE|e.SharpEdgeRenderLineModeMask|e.WireEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.HideInternalEdgesRenderLineMode=e.WireEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.ShowAllRenderLineMode=e.GeomTypeEnum.EDGE|e.SmoothEdgeRenderLineModeMask|e.SharpEdgeRenderLineModeMask|e.WireEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.ShowOutlinesAndEdgesRenderLineMode=e.OutlineMask|e.ShowAllRenderLineMode,e.ShowOutlinesHideEdgesRenderLineMode=e.OutlineMask|e.HideAllRenderLineMode,e.BodyLinesMask=e.GeomTypeEnum.EDGE|e.SmoothEdgeRenderLineModeMask|e.SharpEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.NoNoZPriorityMask=e.GeomTypeEnum.EDGE|e.GeomTypeEnum.SHARP_EDGE|e.GeomTypeEnum.BOUNDARY_EDGE|e.GeomTypeEnum.SMOOTH_EDGE|e.GeomTypeEnum.HIDDEN_SEAM_EDGE,e.HideAllModelFaces=0,e.ShowAllFaces=e.GeomTypeEnum.FACE|e.GeomTypeEnum.INFINITE_FACE|e.GeomTypeEnum.AXIS_SYSTEM,e.BoundaryPointRenderPointMask=e.GeomTypeEnum.BOUNDARY_POINT,e.SharpPointRenderPointMask=e.GeomTypeEnum.SHARP_POINT,e.SmoothPointRenderPointMask=e.GeomTypeEnum.SMOOTH_POINT,e.SurfacicPointRenderPointMask=e.GeomTypeEnum.SURFACIC_POINT,e.FreePointRenderPointMask=e.GeomTypeEnum.FREE_POINT,e.AllPointsRenderPointMask=e.BoundaryPointRenderPointMask|e.SharpPointRenderPointMask|e.SmoothPointRenderPointMask|e.SurfacicPointRenderPointMask|e.FreePointRenderPointMask,e.AllPointsButSurfacicPointsRenderPointMask=e.BoundaryPointRenderPointMask|e.SharpPointRenderPointMask|e.SmoothPointRenderPointMask|e.FreePointRenderPointMask,e.BodyPointsMask=e.BoundaryPointRenderPointMask|e.SharpPointRenderPointMask|e.SmoothPointRenderPointMask|e.SurfacicPointRenderPointMask,e.__QA_AUTOMATION_MASK__=e.GeomTypeEnum.FACE|e.GeomTypeEnum.UNKNOWN_0D|e.GeomTypeEnum.UNKNOWN_1D|e.GeomTypeEnum.UNKNOWN_2D|e.GeomTypeEnum.UNKNOWN,e.loadingModels=!1;var U=[];U.push(new e.Vector2(-.770613,-.239161)),U.push(new e.Vector2(.654029,-.712337)),U.push(new e.Vector2(-.307109,.184156)),U.push(new e.Vector2(.511665,.311578)),U.push(new e.Vector2(.950228,-.256954)),U.push(new e.Vector2(-.00583136,-.537149)),U.push(new e.Vector2(-.692077,.433278)),U.push(new e.Vector2(-.357517,.88078)),U.push(new e.Vector2(.278742,.859941)),U.push(new e.Vector2(-.631555,-.471973)),U.push(new e.Vector2(-.480475,-.732053)),U.push(new e.Vector2(-.486058,.576291)),U.push(new e.Vector2(.190138,-.625394)),U.push(new e.Vector2(-.176393,-.166675)),U.push(new e.Vector2(.0663065,-.333703)),U.push(new e.Vector2(.348117,-.812683)),U.push(new e.Vector2(.0817859,.0594559)),U.push(new e.Vector2(.375191,-.0632498)),U.push(new e.Vector2(.770788,-.0723965)),U.push(new e.Vector2(.800971,.431381)),U.push(new e.Vector2(-.100114,.320657)),U.push(new e.Vector2(.285262,.61499)),U.push(new e.Vector2(-.579148,.219349)),U.push(new e.Vector2(-.684372,-.0462647)),U.push(new e.Vector2(-.313914,-.939188)),U.push(new e.Vector2(-.414696,.367707)),U.push(new e.Vector2(.698927,.219188)),U.push(new e.Vector2(.971183,.130313)),U.push(new e.Vector2(.0822042,.526062)),U.push(new e.Vector2(-.214193,.522263)),U.push(new e.Vector2(-.0751906,.901432)),U.push(new e.Vector2(.488676,-.253098)),U.push(new e.Vector2(-.580828,.778049)),U.push(new e.Vector2(.816108,-.536974)),U.push(new e.Vector2(.51456,.543311)),U.push(new e.Vector2(-.213744,-.428735)),U.push(new e.Vector2(.293803,-.405018)),U.push(new e.Vector2(.169169,.259656)),U.push(new e.Vector2(.445091,-.594255)),U.push(new e.Vector2(-.453123,-.1009)),U.push(new e.Vector2(-.420509,-.388243)),U.push(new e.Vector2(.576791,.0184982)),U.push(new e.Vector2(.610535,.759891)),U.push(new e.Vector2(.692311,-.348235)),U.push(new e.Vector2(.0912182,.752741)),U.push(new e.Vector2(-.840539,.203544)),U.push(new e.Vector2(.0673295,-.961926)),U.push(new e.Vector2(-.951943,.0129663)),U.push(new e.Vector2(-.14793,-.811125)),e._ForbidRenderableStates={NO_TRANSPARENT:1,NO_INVISIBLE_PLANE:2};var B=e._ForbidRenderableStates;function k(t){for(var i=new Uint8Array(16),r=0;r<4;r++)i[4*r]=t[0],i[4*r+1]=t[1],i[4*r+2]=t[2],i[4*r+3]=t[3];var n=new e.DataTexture(i,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter);return n.generateMipmaps=!1,n.needsUpdate=!0,n}Object.assign(e,P),e._SaveGeneratedRoughnessMaps=!1,e._DownloadGeneratedRoughnessMaps=!0,e._AmbianceGenerators={viewers:[],loading:!1,manager:null,_dummyRoughnessTexture:k([200,200,200,127]),_needsUpdate:function(){return!!this.manager&&this.manager._needsUpdate()},cb:null,errorCount:0,init:function(e){if(!this.loading&&!this.manager)if(this._dummyRoughnessTexture.hasDiffuse=!0,this.available(e)){if(null===this.manager){this.loading=!0;var t=this;require(["DS/Visualization/AmbianceGenerator"],function(e){t.loading=!1,t.manager=new e(t.cb);for(var i=0;i<t.viewers.length;i++)t.viewers[i].forceRender=!0})}}else this.loading=!0},available:function(t){var i=!!e.supportedExtensions.textureHalfFloat&&!!e.supportedExtensions.renderToHalfFloatTexture&&!!e.supportedExtensions.textureHalfFloatLinear||!!e.supportedExtensions.textureFloat&&!!e.supportedExtensions.renderToFloatTexture&&!!e.supportedExtensions.textureFloatLinear;return i||(0===t&&this.errorCount<10?console.warn("Warning: device does not support automatic mip map generation for hdrs, please set one yourself"):1===t&&this.errorCount<11&&console.warn("Warning: device does not support fabrics under ibl"),this.errorCount++),i},getAmbiance:function(e,t,i,r){return this.manager?this.manager.getAmbiance(e,t,i,r):null},update:function(e,t){return!!this._needsUpdate()&&this.manager.update(e,t)},decreaseUseCount:function(e){this.manager&&this.manager.decreaseUseCount(e)},_decreaseSceneUseCount:function(e){this.manager&&(this.manager.decreaseUseCount(e.envMipMapID),e.envMipMapID=null,this.manager.decreaseUseCount(e.envMipMapSheenID),e.envMipMapSheenID=null)},keep:function(e){return this.manager?this.manager.keep(e):null},setCallBack:function(e){this.cb=e,this.manager&&this.manager._setCB(e)},dispose:function(e){var t=this.viewers.indexOf(e);t>-1&&this.viewers.splice(t,1),0===this.viewers.length&&(this.manager&&(this.manager.dispose(),this.manager=null),this._dummyRoughnessTexture&&this._dummyRoughnessTexture.dispose())}},e._SSSGenerator={viewers:[],loading:!1,manager:null,init:function(){if(!this.loading&&!this.manager&&null===this.manager){this.loading=!0;var e=this;require(["DS/Visualization/SubsurfaceGenerator"],function(t){e.loading=!1,e.manager=new t;for(var i=0;i<e.viewers.length;i++)e.viewers[i].forceRender=!0})}},getTextures:function(e){return this.manager?this.manager.compute(e):null},decreaseUseCount:function(e){this.manager&&this.manager.decreaseUseCount(e)},dispose:function(e){var t=this.viewers.indexOf(e);t>-1&&this.viewers.splice(t,1),0===this.viewers.length&&this.manager&&(this.manager.dispose(),this.manager=null)}};var G={modelMatrix:1,modelViewMatrix:2,modelViewInvTranspMatrix:4,modelInvTranspMatrix:8,normalMatrix:32,quantizedVector:64,fixedSizeRatio:128,fixedSizeCenterRatio:256,lightMap:512,billboardType:1024,decalStencilValue:2048,displacementRadius:4096,backgroundViewModeControl:8192,objectColorBufferType:16384,skinningMap:32768,skinningInstancingMaps:65536,backgroundViewModeNearFar:1<<17},z=function(){this.modelMatrix=null,this.modelViewMatrix=null,this.modelViewInvTranspMatrix=null,this.modelInvTranspMatrix=null,this.normalMatrix=null,this.quantizedVector=null,this.offsetVector=null,this.fixedSizeRatio=null,this.fixedSizeCenterRatio=null,this.lightMap=null,this.lightMapUvSlot=null,this.lightMapUvTransform=null,this.billboardType=null,this.billboardRotationEnabled=null,this.billboardAxis=null,this.billboardRotation=null,this.modelInvRotMatrix=null,this.modelViewInvMatrix=null,this.decalStencilValue=null,this.decalExplicitUv=null,this.displacementRadius=null,this.objectColorBufferType=null,this.skinningMap=null,this.skinningInstancingMaps=null,this.backgroundViewModeControl=null,this.backgroundViewModeNearFar=null,this.funcName="loadObjectUniforms"};z.prototype.computeFuncName=function(){var e=0;for(var t in G)null!==this[t]&&(e|=G[t]);switch(e){case G.modelMatrix:this.funcName="_load_MM";break;case G.modelMatrix|G.normalMatrix:this.funcName="_load_MM_NM";break;case G.modelViewMatrix:this.funcName="_load_MVM";break;case G.modelViewMatrix|G.normalMatrix:this.funcName="_load_MVM_NM";break;case G.modelMatrix|G.modelViewMatrix:this.funcName="_load_MM_MVM";break;case G.modelMatrix|G.modelViewMatrix|G.normalMatrix:this.funcName="_load_MM_MVM_NM";break;default:this.funcName="loadObjectUniforms"}};var H=function(){this.program=null,this.id=0,this.uniformLocations=null,this.objectUniformLocations=null,this.attributes={position:-1,normal:-1,uv:-1,uv2:-1,tangent:-1,binormal:-1,color:-1,skinIndex:-1,skinWeight:-1,lineDistance:-1,previousPos:-1,followingPos:-1,sideExtrusion:-1,patternStartEnd:-1},this.uvOrBinOrTan=!1,this.instanceAttributes={},this.flattenedUniformArrays={},this._clipPlanesVersion=-1,this._lightsKey=0,this._ambianceKey=0,this._materialToUse=0};e.glStates={currentFramebuffer:void 0,currentWidth:0,currentHeight:0},e.DefaultAppearanceMode={BASIC:0,_GASLOOK_OLD:.5,GASLOOK:1,_TRANSPARENT:2,CLAY:3,WHITE_MAT_PLASTER:4,GREY_SHINY_PLASTIC:5,CAST_ALUMINUM:6,MACHINED_ALUMINUM:7,CAST_STEEL:8,BRUSHED_STEEL:9,MACHINED_STAINLESS_STEEL:10,COPPER:11,BRASS:12,GENERIC_PLASTIC:13,GENERIC_METAL:14,__QA_AUTOMATION__:15};var W=e.DefaultAppearanceMode;e._DebugMaterialMode={NO_DEBUG:0,NORMAL:1,DEPTH:2,SHADOW:3,GEOM_UV:4,MAPPING_UV:5,GEOM_UV2:6,MAPPING_UV2:7};var j=e._DebugMaterialMode;e.MaterialToUse={originalMaterial:0,normalMaterial:1,depthMaterial:2,normalDepthIoRRoughnessMaterial:3,shadowMapDepthMaterial:4,highlightMaterial:5,pickingMaterial:6,pickingMaterialInstancing:7,oitAccumMaterial:8,oitRevealMaterial:9,ZOnlyMaterial:10,depthRGBAMaterial:11,normalDepthMaterial:12,decalNormalStencilDepthMaterial:13,transparentShadowMaterial:14,texCoordMaterial:15,totalMaterial:16};var X=e.MaterialToUse;e._isSelectionMaterial=function(e){switch(e){case X.normalMaterial:case X.depthMaterial:case X.highlightMaterial:case X.pickingMaterial:case X.pickingMaterialInstancing:return!0;default:return!1}};var q,Z;e._isSelectionMaterial;e.MaterialHasPriority=[!1,!0,!0,!0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0,!0],e.HaloHighlightData=h.HaloHighlightData,e.AdvancedPoliteHighlightData=h.AdvancedPoliteHighlightData,e.DefaultHighlightData=h.DefaultHighlightData,e.DefaultPreHighlightData=h.DefaultPreHighlightData,e.Line3=C.Line3,e.Box2=C.Box2,e.Box3=C.Box3,e.mergeBoundingBoxInto=C.mergeBoundingBoxInto,e.DGBoundingBoxArray=C.DGBoundingBoxArray,e.Sphere=C.Sphere,e.mergeBoundingSphereInto=C.mergeBoundingSphereInto,e.BoundingSphere=C.BoundingSphere,e.Frustum=C.Frustum,e.Plane=C.Plane,e.Math={clamp:function(e,t,i){return e<t?t:e>i?i:e},clampBottom:function(e,t){return e<t?t:e},mapLinear:function(e,t,i,r,n){return r+(e-t)*(n-r)/(i-t)},smoothstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*(3-2*e)},smootherstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*e*(e*(6*e-15)+10)},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},sign:function(e){return e<0?-1:e>0?1:0},degToRad:(Z=Math.PI/180,function(e){return e*Z}),radToDeg:(q=180/Math.PI,function(e){return e*q})},e.Spline=C.Spline,e.Triangle=C.Triangle,e.Vertex=function(e){return console.warn("THREE.Vertex has been DEPRECATED. Use THREE.Vector3 instead."),e},e.UV=function(t,i){return console.warn("THREE.UV has been DEPRECATED. Use THREE.Vector2 instead."),new e.Vector2(t,i)},e.Clock=function(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1},e.extend(e.Clock.prototype,{start:function(){this.startTime=void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now(),this.oldTime=this.startTime,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var e=0;if(this.autoStart&&!this.running&&this.start(),this.running){var t=void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now();e=.001*(t-this.oldTime),this.oldTime=t,this.elapsedTime+=e}return e}}),e.Object3D=u,e.Projector=function(){var t=new e.Matrix4;this.projectVector=function(e,i){return i.matrixWorldInverse.getInverse(i.matrixWorld),t.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),e.applyProjection(t)},this.unprojectVector=function(e,i){return i.projectionMatrixInverse.getInverse(i.projectionMatrix),t.multiplyMatrices(i.matrixWorld,i.projectionMatrixInverse),e.applyProjection(t)},this.pickingRay=function(t,i){t.z=-1;var r=new e.Vector3(t.x,t.y,1);return this.unprojectVector(t,i),this.unprojectVector(r,i),r.sub(t).normalize(),new e.Raycaster(t,r)}},e.Face3=C.Face3,e.Face4=C.Face4,e.Geometry=b.LegacyGeometry,e.GeometryIdCount=0;var Y=M.VISIBILITY_STATUS,K=M.INCREMENTAL_ACTIONS,J=M.__CullingSystemFactory;e.CullingSystem=M.CullingSystem,e._CameraRoles=p._CameraRoles,e._FrameTypes=p._FrameTypes,e.Camera=p.BaseCamera,e.OrthographicCamera=p.OrthographicCamera,e.PerspectiveCamera=p.PerspectiveCamera,e.Light=d.BaseLight,e.AmbientLight=d.AmbientLight,e.AreaLightUnits=d.AreaLightUnits,e.SphereLight=d.SphereLight,e.DiskLight=d.DiskLight,e.TubeLight=d.TubeLight,e.AreaLight=d.AreaLight,e.DirectionalLight=d.DirectionalLight,e.DirectionalIBLLight=d.DirectionalIBLLight;var Q=d.DirectionalIBLLight.prototype._sortKey;e.DirectionalPhongLight=d.DirectionalPhongLight,e.PointLight=d.PointLight,e.SpotLight=d.SpotLight,e.IESLight=d.IESLight,e.ImageLoader=function(){e.EventDispatcher.call(this),this.crossOrigin=null},e.ImageLoader.prototype={constructor:e.ImageLoader,load:function(e,t){var i=this;void 0===t&&(t=new Image),t.addEventListener("load",function(){i.dispatchEvent({type:"load",content:t})},!1),t.addEventListener("error",function(){i.dispatchEvent({type:"error",message:"Couldn't load URL ["+e+"]"})},!1),i.crossOrigin&&(t.crossOrigin=i.crossOrigin),t.src=e}},e.LineBasicShaderLibs=s.LineShaderLib,Object.assign(e,f);var $=f.ShaderDynamicPrefixBuilder._VertexPrefixBuilder,ee=f.ShaderDynamicPrefixBuilder._FragmentPrefixBuilder;function te(e,t){return t[0]-e[0]}Object.assign(e,A),e.MeshFaceMaterial=function(e){this.materials=e instanceof Array?e:[]},e.MeshFaceMaterial.prototype.clone=function(){return new e.MeshFaceMaterial(this.materials.slice(0))},e.ParticleCanvasMaterial=function(t){e._OldInfraMaterial.call(this),this.color=new e.Color(16777215),this.program=function(e,t){},this.setValues(t)},e.ParticleCanvasMaterial.prototype=Object.create(e._OldInfraMaterial.prototype),e.ParticleCanvasMaterial.prototype.clone=function(){var t=new e.ParticleCanvasMaterial;return e._OldInfraMaterial.prototype.clone.call(this,t),t.color.copy(this.color),t.program=this.program,t},e.ParticleCanvasMaterial.prototype.getType=function(){return"ParticleCanvas"},e.Particle=function(t){e.Object3D.call(this),this.material=t},e.Particle.prototype=Object.create(e.Object3D.prototype),e.Particle.prototype.clone=function(t){return void 0===t&&(t=new e.Particle(this.material)),e.Object3D.prototype.clone.call(this,t),t},e.ParticleSystem=b.ParticleSystem,e.Line=b.Line,e.LineStrip=0,e.LinePieces=1,e.Mesh=_,e.CSS3DNode=function(t){e.Object3D.call(this),this.element=t||document.createElement("div"),this.element.renderable=this,this.element.style.position="absolute",this.geometry=new e.Geometry,this.geometry.boundingSphere=new e.Sphere},e.CSS3DNode.prototype=Object.create(e.Object3D.prototype),e.Bone=function(t){e.Object3D.call(this)},e.SkinnedMesh=b.SkinnedMesh,e.Sprite=function(t){e.Object3D.call(this)},e.Sprite.prototype=Object.create(e.Object3D.prototype),e.WebGLObjectManager=x,e.Scene=y,e.StateSortingResult=T.StateSortingResult,e.VertexStage=0,e.FragmentStage=1,e.ToGLSLTypes={f:{t:"float",isArray:!1,isTexture:!1,canBeVarying:!0,isInt:!1},v2:{t:"vec2",isArray:!1,isTexture:!1,canBeVarying:!0,isInt:!1},v3:{t:"vec3",isArray:!1,isTexture:!1,canBeVarying:!0,isInt:!1},c:{t:"vec3",isArray:!1,isTexture:!1,canBeVarying:!0,isInt:!1},v4:{t:"vec4",isArray:!1,isTexture:!1,canBeVarying:!0,isInt:!1},m3:{t:"mat3",isArray:!1,isTexture:!1,canBeVarying:!0,isInt:!1},m4:{t:"mat4",isArray:!1,isTexture:!1,canBeVarying:!0,isInt:!1},i:{t:"int",isArray:!1,isTexture:!1,canBeVarying:!1,isInt:!0},b:{t:"bool",isArray:!1,isTexture:!1,canBeVarying:!1,isInt:!1},fv1:{t:"float",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},iv1:{t:"int",isArray:!0,isTexture:!1,canBeVarying:!1,isInt:!0},v2v:{t:"vec2",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},fv2:{t:"vec2",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},v3v:{t:"vec3",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},fv3:{t:"vec3",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},v4v:{t:"vec4",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},fv4:{t:"vec4",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},m4v:{t:"mat4",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},t2:{t:"sampler2D",isArray:!1,isTexture:!0,canBeVarying:!1,isInt:!1},tc:{t:"samplerCube",isArray:!1,isTexture:!0,canBeVarying:!1,isInt:!1},t2v:{t:"sampler2D",isArray:!0,isTexture:!0,canBeVarying:!1,isInt:!1},tcv:{t:"samplerCube",isArray:!0,isTexture:!0,canBeVarying:!1,isInt:!1}},e.PDSFXPolygonOffsetParams={Backward2:[4,4],Backward1:[2,2.3],Backward0:[1,1],Neutral:[0,0],Frontward0:[-.9,-1],Frontward1:[-2,-2]},e._DefaultShaderChunk=a,e.ShaderChunk=o,e.DeferredShaderChunk=S,e.UniformsUtils=m,e.UniformsLib=v,e.ShaderLib=g;var ie=0,re=-1;e.RendererMode={static:0,dynamic:1,override:2,_count:3};for(var ne=e.RendererMode,ae=new Array(ne._count),se=0;se<ne._count;se++)ae[se]=se;var oe=function(e,t,i,r,n){if(i)e.setRenderTarget(t.currentNormalStencilDepthBuffer);else if(r){if(null==t.currentTexCoordBuffer){var a=e.getViewportSize();t.currentTexCoordBuffer=e.renderTargetPool.buildRenderTarget(a.width,a.height,"decalTex",null,null,!1),e.clearTarget(t.currentTexCoordBuffer,!0,!0,!0)}e.setRenderTarget(t.currentTexCoordBuffer)}else n&&e.setRenderTarget(t.currentRGBADepthBuffer)},le=function(e,t,i){i&&e.setRenderTarget(t)};const ce={FRAME:0,OBJECT:1},he=T.StateSortingCacheItem;return e.WebGLRenderer=function(a){this.currentFrameIndex=0,this._currentFrameType=-1,this.renderIteration=0;var s=0;this._VRCompatible=!1,this._VRFrameBuffer=null,this.resetGSSOCacheFrame=0,this.useBackfaceCullingWithNoCapping=!1,this.useCustomCappingForClipPolyline=!1,this.shaderVersions=new Array(ne._count);for(var o=0;o<ne._count;o++)this.shaderVersions[o]=0;this.currentRendererMode=ne.static,this.forcePolygonOffset=e.PolygonOffsetForceStatus.DEFAULT,this.overrideWireframeFix=!1,a=a||{},this._texturesToResize=new Set;var l,c,h,u,d,p,f,m,g,v,S,_,y,x,M,C,b,D,w,E,A=void 0!==a.canvas?a.canvas:document.createElement("canvas"),G=a.useCompositing,q=void 0!==a.divCSS?a.divCSS:document.createElement("div"),Z=void 0!==a.precision?a.precision:"highp",se=void 0!==a.precision?a.precision:"highp",ue=void 0===a.alpha||a.alpha,de=void 0===a.premultipliedAlpha||a.premultipliedAlpha,pe=!(!navigator.webdriver||localStorage.getItem("WebVisuEnableAAWithWebdriver")),fe=void 0!==a.antialias&&!pe&&a.antialias,me=void 0===a.stencil||a.stencil,ge=void 0!==a.preserveDrawingBuffer&&a.preserveDrawingBuffer,ve=void 0!==a.clearColor?new e.Color(a.clearColor):new e.Color(0),Se=void 0!==a.clearAlpha?a.clearAlpha:0;this._sortRenderListByBuffer=void 0!==a.sortRenderListByBuffer&&a.sortRenderListByBuffer,this.domElement=A,this.currentPass=null,this.id=ie++,this.useRenderPriorityOpacity=!1,this.renderPriorityDefaultOpacity=1,this.context=null,this.devicePixelRatio=void 0!==a.devicePixelRatio?a.devicePixelRatio:e.getDevicePixelRatio()||1,this.splitScreenMode=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sectionCappingEnabled=!1;var _e,ye={currentNormalStencilDepthBuffer:null,currentTexCoordBuffer:null,currentRGBADepthBuffer:null};this.visibleSpace=void 0!==a.visibleSpace?a.visibleSpace:1,this.sortObjects=!0,this.autoUpdateObjects=!0,this.autoUpdateScene=!0,this.gammaInput=!1,this.gammaOutput=!1,this.renderTargetPool=null,this.simpleGamma=!0,this.lensFlareEnabled=!0,this.baseLightDirection=new e.Vector3(0,0,1),this.shadowMapEnabled=!1,this.transparentShadowEnabled=!1,this.shadowMapAutoUpdate=!0,this.shadowMapType=e.PCFShadowMap,this.shadowMapQuality="Low",this.shadowMapCullFace=e.CullFaceFront,this.shadowMapDebug=!1,this.shadowMapCascade=!1,this._renderScale=1,this._internalPixelScale=1,this.flakesMode=0,this.gasAsPhong=!1,this.clipPlanesEnabled=!1,this.clipPlanes=[],this.disableBackFaceClipPlanes=0,this.maxMorphTargets=8,this.maxMorphNormals=4,this.disableDepthWrite=!1,this.disableDepthTest=!1,this.disableColorWrite=!1,this.enableStencilWrite=!1,this.disableBackFaceCulling=!1,this._inheritanceSolver=new T.InheritanceSolver(this),this.renderVolumesOnly=!1,this.materialMode=!0,this._defaultAppearanceType=W.BASIC,this._debugMaterialMode=j.NO_DEBUG,this._backgroundViewMode=e.BackgroundViewMode.NORMAL,this._invertBackgroundNodes=!1,this._pickBackgroundNodes=!0,this._backgroundColor=null,this._planeViewMode=null,this._customMaterialModeParams={colorFromGAS:!1,color:new e.Color,shininess:1,opacity:1},this._GlobalZModeFilter=null;const xe=this._inheritanceSolver._useCPUOutlines;this.enableRenderPluginsPre=!0,this.enableRenderPluginsPost=!0,this.renderPluginsPre=[],this.renderPluginsPost=[],this.refractionColorBuffer=null,this.reflectionColorBuffer=null,this.ambianceGenerators=null,this.sssGenerator=null,this.dBuffer=null,this.requestDBuffer=!1,this._dBufferNextFrame=!1,this.requestRealDepthBuffer=function(){this._dBufferNextFrame=!0},this._requestPoliteDepthBuffer=!1,this._politeDBufferNextFrame=!1,this.requestPoliteDepthBuffer=function(){this._politeDBufferNextFrame=!0,this._requestPoliteDepthBuffer=!0},this.politeDepthBuffer=null,this._NoMeshInRamWarningCount=0,this.maxPolyLineSize=0,this.maxNbPolyLine=0,this.maxScissorSize=0,this.maxNbScissor=0,this.useClippingCylinder=!1,this.info={memory:new I.MemoryInfo,renderMap:new Map,render:null,renderTime:new I.RenderTimeInfo};var Me=this.info.memory,Pe=null;this.inlinedPostProcess={activated:!1,brightness:0,tonemapping:2,crushblacks:0,burnhighlights:0,saturation:1,colorCorrection:{x:1,y:1,z:1}},this.resetInlinedPostProcess=function(){this.inlinedPostProcess.activated=!1,this.inlinedPostProcess.brightness=0,this.inlinedPostProcess.tonemapping=2,this.inlinedPostProcess.crushblacks=0,this.inlinedPostProcess.burnhighlights=0,this.inlinedPostProcess.saturation=1,this.inlinedPostProcess.colorCorrection={x:1,y:1,z:1}},this.frameUBOArray=null,this.frameUBOBuffer=null,this.float32Matrix4x3Temp=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.float32Matrix4x3Temp.setDoubles=function(e){var t=this;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[12]=e[12],t[13]=e[13],t[14]=e[14],this},this.float32Matrix4x4Temp=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.float32Matrix4x4Temp.setDoubles=function(e){var t=this;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this},this.float32Matrix3x3Temp=new Float32Array([1,0,0,0,1,0,0,0,1]),this.float32Matrix3x3Temp.setDoubles=function(e){var t=this;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this},this._dummyTexture=k([0,0,0,255]),this._clipPlanesState={uniforms:{nbClipPlanes:{type:"i",value:0,clipPlanesUniform:!0},clipPlaneEquations:{type:"fv4",value:[],clipPlanesUniform:!0},clipPlaneActive:{type:"iv1",value:[],clipPlanesUniform:!0},clipFrontOpacity:{type:"f",value:1,clipPlanesUniform:!0},clipBackOpacity:{type:"f",value:0,clipPlanesUniform:!0},scissorSize:{type:"iv1",value:[],clipPlanesUniform:!0},scissorPoints:{type:"t",value:null,clipPlanesUniform:!0},polygonSize:{type:"iv1",value:[0],clipPlanesUniform:!0},polygonPoints:{type:"t",value:null,clipPlanesUniform:!0},extrusionPlaneU:{type:"fv",value:[0,0,1],clipPlanesUniform:!0},extrusionPlaneV:{type:"fv",value:[1,0,0],clipPlanesUniform:!0},cylinderClipZone:{type:"i",value:0,clipPlanesUniform:!0},cylinderCenter:{type:"v3",value:null,clipPlanesUniform:!0},cylinderAxisU:{type:"v3",value:new e.Vector3(0,0,1),clipPlanesUniform:!0},cylinderAxisV:{type:"v3",value:new e.Vector3(1,0,0),clipPlanesUniform:!0}},version:-1,disabled:!1,useTolerance:!1,update:function(t,i,r,n,a,s){var o=!(!n||!n.useClippingTolerance);if(r||t!==i||this.disabled&&n.enableClipPlanes||o!==this.useTolerance){var l=t&&t.clipPlanes,c=Ze.clipPlanesEnabled?Ze.clipPlanes:[];l&&(c=l);var h,u,d,p=[];for(d=0;d<c.length&&p.length<6;d++)(u=(h=c[d])&&h.clippingContext&&h.clippingContext[Ze.id])&&u.clippingPlaneAdded&&p.push(h);var f=-1,m=t&&t.getClippingSettings();for(m&&0===m.frontOpacity&&(f=1),d=0;d<p.length;d++){var g,v=Ze.clipPlanesEnabled||l;g=a instanceof e.OrthographicCamera?-p[d].normal.dot(a.getLookAt()):p[d].distanceToPoint(a.position),p[d].enabled=v&&(0==Ze.disableBackFaceClipPlanes||f*g>0)}this.useTolerance=o,function(t,i,r,n,a){Ut.hasCapping=!0;var s,o,l,c=0,h=0,u=n&&n.clippingContext;for(s=0,o=i.length;s<o;s++){l=i[s],h=4*c;var d=(new e.Matrix4).copy(r.matrixWorld);d.transpose();var p=(new e.Plane).copy(l);p.applyMatrix4(r.matrixWorldInverse),Ut.eqs[h]=p.normal.x,Ut.eqs[h+1]=p.normal.y,Ut.eqs[h+2]=p.normal.z,Ut.eqs[h+3]=p.constant,a&&(Ut.eqs[h+3]+=.005),Ut.states[s]=l.enabled?1:0,Ut.sectionLines[s]=!u||u._hasPlaneSectionLine(l),u&&!u._hasPlaneCapping(l)&&(Ut.hasCapping=!1),c++}Ut.length=c}(0,p,a,t,o),Hi(this.uniforms,Ut,n&&n.clipPlaneIndex,t,s),function(e,t,i,r,n){if(e.polygonPoints){t&&t.updateCamera(i,r),e.polygonPoints.value=t?t.getTexture():null;var a,s,o=[],l=[],c=[];for(a=0;a<n;a++)t&&a<t.getCount()?(s=t.polyLines[a],o.push(s.closedPoints2d.length),l.push(s.viewPlaneU.x),l.push(s.viewPlaneU.y),l.push(s.viewPlaneU.z),c.push(s.viewPlaneV.x),c.push(s.viewPlaneV.y),c.push(s.viewPlaneV.z)):(o.push(0),l.push(0),l.push(0),l.push(0),c.push(0),c.push(0),c.push(0));e.polygonSize.value=o.length>0?o:[0],e.extrusionPlaneU.value=l,e.extrusionPlaneV.value=c}}(this.uniforms,t?t.clipPolyLine:null,a,Ze.currentFrameIndex,Ze.maxNbPolyLine),t&&t.scissor&&"polyline"===t.scissor.type?Wi(this.uniforms,t.scissor,a,Ze.currentFrameIndex,Ze.maxNbScissor):Wi(this.uniforms,null),function(e,t){if(!e.cylinderClipZone)return;e.cylinderClipZone.value=t?t.clipOutside?1:-1:0,t&&t.center&&(e.cylinderCenter.value=t.center);t&&t.axisU&&(e.cylinderAxisU.value=t.axisU.clone().multiplyScalar(1/t.axisU.lengthSq()));t&&t.axisV&&(e.cylinderAxisV.value=t.axisV.clone().multiplyScalar(1/t.axisV.lengthSq()))}(this.uniforms,t?t.clipCylinder:null),this.disabled=!1,this.version++}else this.disabled||n.enableClipPlanes||(this.disabled=!0,Hi(this.uniforms,{length:0,eqs:[],states:[]},0))}},this.__glResources__={renderTarget:{},geometry:[],geometryNullCount:0,texture:[],textureLODPool:new e.TextureLODPool,removeGeometryList:function(e){var t=new Set;e.forEach(function(e,i,r){t.add(e.id)});for(var i=0,r=0;r<this.geometry.length;r++){var n=this.geometry[r];if(n&&t.has(n.object.id)&&(i++,t.delete(n.object.id),this.geometry[r]=null,this.geometryNullCount++,i===e.size))break}this.tryClean()},tryClean:function(){this.geometryNullCount>=100&&(this.geometry=this.geometry.filter(function(e){return null!==e}),this.geometryNullCount=0)}},this.restoreGLContext=function(){console.log("restore context"),sr(null,null,2===e.WebGLVersion),Ye=[],Ke=0,Ce._currentProgram=null;Me.programs;Me.programs=0,Me.sharedbuffers=0,Me.geometries=0;var t=this.__glResources__.geometry;console.log("restore "+t.length+" geometries");for(var i=[],r=0;r<t.length;r++)if(t[r]){var n=t[r].object.geometry;if(n){if(n.length)for(var a=0;a<n.length;a++)n[a].vertexBufferGPU=null;else if(t[r].object.__webglInit=!1,n.__webglVertexBuffer=null,n.geometryGroups)for(var s in n.geometryGroups){n.geometryGroups[s].__webglVertexBuffer=null}Ze.initObject(t[r].object)&&i.push(t[r])}}this.initSharedBuffersDS(i,!0),Me.textures=0,Me.renderTargets=0;var o=this.__glResources__.texture;console.log("restore "+o.length+" textures");for(r=0;r<o.length;r++){var l=o[r];l.needsUpdate=!0,l.__webglInit=!1,l.__webglTexture&&(l.__webglTexture=null)}var c=this.__glResources__.renderTarget,h=0;for(var r in c){var u=c[r];u&&(u.__webglFramebuffer=null,u.__webglRenderbuffer=null,u.__webglTexture=null,h++)}console.log("restore "+h+" render targets")},this._setWorldOrientation=function(e){this.baseLightDirection=e.upVector.clone()},this.initFrameUBO=function(){this.frameUBOArray=new Float32Array(36),this.frameUBOBuffer=Ce.createBuffer(),Ce.bindBuffer(Ce.UNIFORM_BUFFER,this.frameUBOBuffer),Ce.bufferData(Ce.UNIFORM_BUFFER,this.frameUBOArray,Ce.DYNAMIC_DRAW),Ce.bufferSubData(Ce.UNIFORM_BUFFER,0,this.frameUBOArray),Ce.bindBufferBase(Ce.UNIFORM_BUFFER,ce.FRAME,this.frameUBOBuffer),Ce.bindBuffer(Ce.UNIFORM_BUFFER,null)},this.updateFrameUBO=function(e){for(var t=e.matrixWorldInverse.elements,i=0;i<16;i++)this.frameUBOArray[i]=t[i];var r=e.projectionMatrix.elements;for(i=0;i<16;i++)this.frameUBOArray[i+16]=r[i];Rt.getPositionFromMatrix(e.matrixWorld),this.frameUBOArray[32]=Rt.x,this.frameUBOArray[33]=Rt.y,this.frameUBOArray[34]=Rt.z,Ce.bindBuffer(Ce.UNIFORM_BUFFER,this.frameUBOBuffer),Ce.bufferSubData(Ce.UNIFORM_BUFFER,0,this.frameUBOArray)};var Ce,be,De,we,Ee,Te,Ae,Ie,Re,Le,Oe,Ne,Fe,Ve,Ue,Be,ke,Ge,ze,He,We,je,Xe,qe,Ze=this,Ye=[],Ke=0,Je=-1,Qe=null,$e=-1,et=null,tt=null,it=null,rt=null,nt=null,at=0,st=1,ot=-1,lt=-1,ct=-1,ht=1,ut=-1,dt=-1,pt=-1,ft=-1,mt=-1,gt=-1,vt=-1,St=-1,_t=null,yt=null,xt=null,Mt=1,Pt=0,Ct=0,bt=0,Dt=0,wt=!1,Et={x:-1/0,y:-1/0,width:0,height:0},Tt=new e.Frustum,At=new e.Matrix4,It=new e.Matrix4,Rt=new e.Vector3,Lt=(new e.Vector4,new e.Vector3,!0),Ot=0,Nt=0,Ft=null,Vt={ambient:[0,0,0],directional:{length:0,colors:[],colorsPhong:[],colorsNoIntensity:[],positions:[]},directionalIBL:{length:0,colors:[],positions:[]},directionalPhong:{length:0,colors:[],positions:[]},point:{length:0,colors:[],colorsPhong:[],colorsNoIntensity:[],positions:[],physicalAttenuations:[],distances:[]},spot:{length:0,colors:[],colorsPhong:[],colorsNoIntensity:[],positions:[],physicalAttenuations:[],distances:[],directions:[],anglesCos:[],innerAnglesCos:[]},sphere:{length:0,colors:[],positions:[],data:[]},area:{length:0,colors:[],positions:[],normals:[],ups:[],data:[]},disk:{length:0,colors:[],positions:[],normals:[],ups:[],data:[]},tube:{length:0,colors:[],positions:[],rights:[],data:[]},ies:{length:0,colors:[],positions:[],distances:[],iesLightTexture:[],matrixWorldInv:[]}},Ut={length:0,eqs:[],states:[],sectionLines:[],hasCapping:!1},Bt={gpu:"Unknown",vendor:"Unknown"},kt=null;this.fixedSizeArrayPool=new t,sr(a.context,a.debugContext,a.debugWebgl2),n.setGLContext(this.id,Ce,this.info),this._inheritanceSolver.setContext(Ce,i,r),2===e.WebGLVersion&&this.initFrameUBO();var Gt=new e.DataTexture(new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),2,2,e.RGBAFormat,e.UnsignedByteType);Gt.needsUpdate=!0,Ce.lineWidth(1),Ce.clearColor(0,0,0,1),Ce.clearDepth(1),Ce.clearStencil(0),Ce.enable(Ce.DEPTH_TEST),Ce.depthFunc(Ce.LEQUAL),mt=Ce.LEQUAL,Ce.frontFace(Ce.CCW),Ce.cullFace(Ce.BACK),Ce.enable(Ce.CULL_FACE),Ce.enable(Ce.BLEND),Ce.blendEquation(Ce.FUNC_ADD),Ce.blendFunc(Ce.SRC_ALPHA,Ce.ONE_MINUS_SRC_ALPHA),Ce._oldBlending=e.AlphaBlending,Ce.clearColor(ve.r,ve.g,ve.b,Se),this.dispose=function(){var e;for(e=0;e<this.renderPluginsPre.length;e++)this.renderPluginsPre[e].dispose&&this.renderPluginsPre[e].dispose();for(e=0;e<this.renderPluginsPost.length;e++)this.renderPluginsPost[e].dispose&&this.renderPluginsPost[e].dispose();this.ambianceGenerators&&(this.ambianceGenerators=null),this.sssGenerator&&(this.sssGenerator=null),Gt.dispose(),this.renderPluginsPre=[],this.renderPluginsPost=[],n.dispose(this.id),J.dispose(),this.fixedSizeArrayPool=null,this.getContext=null,Ze=null,q=null,A=null,this.__glResources__=null,this.context=null,rt=null,tt=null,it=null},this.clearCurrentBuffer=function(){tt=null,it=null},this.setPickingPriorityMapping=function(t,i){if(t){t.sort(function(e,t){return e.priority<t.priority?-1:e.priority>t.priority?1:0});for(var r={},n=null,a=0,s=0;s<t.length;s++){if((o=t[s]).priority>0){if(!n||n.priority!==o.priority)a++,(l=i.getDisplayListByName("PICKING_H"+a))||(l=i.addDisplayList(new e.DisplayList({name:"PICKING_H"+a,priority:-a,zSort:e.FrontToBack,side:O.FrontSide,polygonOffset:!1,pickingPriority:!0})),this.resetGSSOCache());r[o.id]=l}else 0===o.priority&&(r[o.id]=null);n=o}n=null,a=0;for(s=t.length-1;s>=0;s--){var o;if((o=t[s]).priority<0){var l;if(!n||n.priority!==o.priority)a--,(l=i.getDisplayListByName("PICKING_L"+-a))||(l=i.addDisplayList(new e.DisplayList({name:"PICKING_L"+-a,priority:2048-a,zSort:e.FrontToBack,side:O.FrontSide,polygonOffset:!1,pickingPriority:!0})),this.resetGSSOCache());r[o.id]=l}n=o}i._pickingPriorityMapping=r}else i._pickingPriorityMapping=null},this.setCurrentPass=function(e){this.currentPass=e},this.context=Ce;var zt=Ce.getParameter(Ce.MAX_TEXTURE_IMAGE_UNITS),Ht=Ce.getParameter(Ce.MAX_VERTEX_TEXTURE_IMAGE_UNITS),Wt=Ce.getParameter(Ce.MAX_TEXTURE_SIZE),jt=Ce.getParameter(Ce.MAX_CUBE_MAP_TEXTURE_SIZE),Xt=Oe?Ce.getParameter(Oe.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,qt=Ht>0,Zt=(Ne&&Ce.getParameter(Ce.COMPRESSED_TEXTURE_FORMATS),Ce.getShaderPrecisionFormat(Ce.VERTEX_SHADER,Ce.HIGH_FLOAT)),Yt=Ce.getShaderPrecisionFormat(Ce.VERTEX_SHADER,Ce.MEDIUM_FLOAT),Kt=(Ce.getShaderPrecisionFormat(Ce.VERTEX_SHADER,Ce.LOW_FLOAT),Ce.getShaderPrecisionFormat(Ce.FRAGMENT_SHADER,Ce.HIGH_FLOAT)),Jt=Ce.getShaderPrecisionFormat(Ce.FRAGMENT_SHADER,Ce.MEDIUM_FLOAT),Qt=(Ce.getShaderPrecisionFormat(Ce.FRAGMENT_SHADER,Ce.LOW_FLOAT),Ce.getShaderPrecisionFormat(Ce.VERTEX_SHADER,Ce.HIGH_INT)),$t=Ce.getShaderPrecisionFormat(Ce.VERTEX_SHADER,Ce.MEDIUM_INT),ei=(Ce.getShaderPrecisionFormat(Ce.VERTEX_SHADER,Ce.LOW_INT),Ce.getShaderPrecisionFormat(Ce.FRAGMENT_SHADER,Ce.HIGH_INT)),ti=Ce.getShaderPrecisionFormat(Ce.FRAGMENT_SHADER,Ce.MEDIUM_INT),ii=(Ce.getShaderPrecisionFormat(Ce.FRAGMENT_SHADER,Ce.LOW_INT),Zt.precision>0&&Kt.precision>0),ri=Yt.precision>0&&Jt.precision>0;"highp"!==Z||ii||(ri?(Z="mediump",e.VisualizationTraces.info("WebGLRenderer: highp not supported, using mediump")):(Z="lowp",e.VisualizationTraces.info("WebGLRenderer: highp and mediump not supported, using lowp"))),"mediump"!==Z||ri||(Z="lowp",e.VisualizationTraces.info("WebGLRenderer: mediump not supported, using lowp"));var ni=0===Qt.precision&&0===ei.precision,ai=0===$t.precision&&0===ti.precision;function si(e){var t,i;if(e.__webglVertexBuffer=Ce.createBuffer(),e.__webglNormalBuffer=Ce.createBuffer(),e.__webglTangentBuffer=Ce.createBuffer(),e.__webglColorBuffer=Ce.createBuffer(),e.__webglUVBuffer=Ce.createBuffer(),e.__webglUV2Buffer=Ce.createBuffer(),e.__webglSkinIndicesBuffer=Ce.createBuffer(),e.__webglSkinWeightsBuffer=Ce.createBuffer(),e.__webglFaceBuffer=Ce.createBuffer(),e.__webglLineBuffer=Ce.createBuffer(),e.numMorphTargets)for(e.__webglMorphTargetsBuffers=[],t=0,i=e.numMorphTargets;t<i;t++)e.__webglMorphTargetsBuffers.push(Ce.createBuffer());if(e.numMorphNormals)for(e.__webglMorphNormalsBuffers=[],t=0,i=e.numMorphNormals;t<i;t++)e.__webglMorphNormalsBuffers.push(Ce.createBuffer());Me.geometries++}"highp"!==se||ni||(ai?(se="mediump",e.VisualizationTraces.info("WebGLRenderer: highp int not supported, using mediump")):(se="lowp",e.VisualizationTraces.info("WebGLRenderer: highp and mediump int not supported, using lowp"))),"mediump"!==se||ai||(se="lowp",e.VisualizationTraces.info("WebGLRenderer: mediump int not supported, using lowp")),this.getContext=function(){return Ce},this.supportsVertexTextures=function(){return qt},this.supportsFloatTextures=function(){return be&&(we||ze)},this.supportsHalfFloatTextures=function(){return De&&(Ee||He)},this.getRendererInfo=function(){return Bt},this.supportsFloatLinearTextures=function(){return Te},this.supportsHalfFloatLinearTextures=function(){return Ae},this.supportsStandardDerivatives=function(){return Ie},this.supportsCompressedTextureS3TC=function(){return Ne},this.supportsMinMaxBlending=function(){return qe},this.supportsElementIndexUint=function(){return je||2===e.WebGLVersion},this.getMaxAnisotropy=function(){return Xt},this.getPrecision=function(){return Z},this.setGLSize=function(t,i,r,n,a,s){this.devicePixelRatio=this._renderScale*(e.getDevicePixelRatio()||1),A.width=Math.floor(t*this.devicePixelRatio),A.height=Math.floor(i*this.devicePixelRatio),this._VRCompatible?(A.style.width="100%",A.style.height="100%"):(A.style.width=a+"px",A.style.height=s+"px"),this.setViewport(0,0,Math.floor(r*this.devicePixelRatio),Math.floor(n*this.devicePixelRatio)),c=t/2,h=(l=i)/2,q.style.width=t+"px",q.style.height=i+"px";for(var o=0;o<q.childNodes.length;o++){var u=q.childNodes[o];u.style.width=t+"px",u.style.height=i+"px"}},this.setViewport=function(t,i,r,n){var a=Pt,s=Ct,o=bt,l=Dt;Pt=void 0!==t?t:0,Ct=void 0!==i?i:0,bt=void 0!==r?r:A.width,Dt=void 0!==n?n:A.height,Pt===a&&Ct===s&&bt===o&&Dt===l&&e.glStates.currentWidth===bt&&e.glStates.currentHeight===Dt||Ce.viewport(Pt,Ct,bt,Dt),e.glStates.currentWidth=bt,e.glStates.currentHeight=Dt},this.removeSplitScreenMode=function(){this.splitScreenMode&&(this.activateSplitScreenMode(!1),this.splitScreenMode=null)},this.setSplitScreenMode=function(e,t){this.splitScreenMode={x:e,y:t,active:!1},this.activateSplitScreenMode(!0)},this.activateSplitScreenMode=function(e){this.splitScreenMode&&e!==this.splitScreenMode.active&&(e?(this.setScissor(this.splitScreenMode.x,this.splitScreenMode.y,bt,Dt),this.enableScissorTest(!0),this.setViewport(this.splitScreenMode.x,this.splitScreenMode.y,bt,Dt)):(this.enableScissorTest(!1),this.setViewport(0,0,bt,Dt)),this.splitScreenMode.active=!!e)},this.getViewportSize=function(){return{width:bt,height:Dt}},this.getViewport=function(){return{width:bt,height:Dt,x:Pt,y:Ct}},this.setScissor=function(e,t,i,r){Et.x=e,Et.y=t,Et.width=i,Et.height=r,Ce.scissor(e,t,i,r)},this.enableScissorTest=function(e){wt=e,e?Ce.enable(Ce.SCISSOR_TEST):Ce.disable(Ce.SCISSOR_TEST)},this.getScissorTest=function(){return wt},this.setClearColorHex=function(e,t){ve.setHex(e),Se=t,Ce.clearColor(ve.r,ve.g,ve.b,Se)},this.setClearColor=function(e,t){ve.copy(e),Se=t,Ce.clearColor(ve.r,ve.g,ve.b,Se)},this.getClearColor=function(){return ve},this.getClearAlpha=function(){return Se},this.clear=function(e,t,i){var r=0;(void 0===e||e)&&(r|=Ce.COLOR_BUFFER_BIT),(void 0===t||t)&&(r|=Ce.DEPTH_BUFFER_BIT);var n=!1;(void 0===i||i)&&(n=!0,r|=Ce.STENCIL_BUFFER_BIT,this.setStencilWrite(!0)),r&&Ce.clear(r),n&&!this.enableStencilWrite&&this.setStencilWrite(!1)},this.clearTarget=function(e,t,i,r){this.setRenderTarget(e),this.clear(t,i,r)},this._getReflectionColorBufferResult=function(){return this.reflectionColorBuffer?this.reflectionColorBuffer.getResult():Gt},this._getRefractionColorBufferResult=function(){return this.refractionColorBuffer?this.refractionColorBuffer.getResult():Gt},this.addPostPlugin=function(e){e.init(this),this.renderPluginsPost.push(e)},this.addPrePlugin=function(e){e.init(this),this.renderPluginsPre.push(e)},this.updateShadowMap=function(e,t){Ce._currentProgram=null,Ce._oldBlending=-1,ft=-1,gt=-1,vt=-1,et=-1,tt=-1,it=-1,Je=-1,$e=-1,nt=null,Lt=!0,lt=-1,ct=-1,this.shadowMapPlugin.update(e,t)};var oi,li,ci=function(e){return Math.abs(e)<1e-6?0:e},hi=function(e){var t=e.elements;return"matrix3d("+ci(t[0])+","+ci(-t[1])+","+ci(t[2])+","+ci(t[3])+","+ci(t[4])+","+ci(-t[5])+","+ci(t[6])+","+ci(t[7])+","+ci(t[8])+","+ci(-t[9])+","+ci(t[10])+","+ci(t[11])+","+ci(t[12])+","+ci(-t[13])+","+ci(t[14])+","+ci(t[15])+")"},ui=function(e){var t=e.elements;return"translate3d(-50%,-50%,0) matrix3d("+ci(t[0])+","+ci(t[1])+","+ci(t[2])+","+ci(t[3])+","+ci(-t[4])+","+ci(-t[5])+","+ci(-t[6])+","+ci(-t[7])+","+ci(t[8])+","+ci(t[9])+","+ci(t[10])+","+ci(t[11])+","+ci(t[12])+","+ci(t[13])+","+ci(t[14])+","+ci(t[15])+")"},di=function(e){var t=e.target;t.removeEventListener("dispose",di),vi(t),Ze&&Me.geometries--},pi=function(e){var t=e.target;t.removeEventListener("dispose",pi);var i=Ze?Ze.info:null;t.deallocate(Ce,i)},fi=function(e){var t=e.target;t.removeEventListener("dispose",fi),Si(t),t.textures&&(t.usedTexture=-1),Ze&&Me.textures--},mi=function(e){var t=e.target;t.removeEventListener("dispose",mi),_i(t),Ze&&Me.renderTargets--;var i=Ze?Ze.__glResources__.renderTarget:null;i&&i[t.uniqueID]&&delete i[t.uniqueID]},gi=function(e){var t=e.target;t.removeEventListener("dispose",gi);var i=null!==t.program?t.program.program:null;yi(t,i,!0)},vi=function(e){if(e.__webglInit=void 0,void 0!==e.__webglVertexBuffer&&Ce.deleteBuffer(e.__webglVertexBuffer),void 0!==e.__webglNormalBuffer&&Ce.deleteBuffer(e.__webglNormalBuffer),void 0!==e.__webglTangentBuffer&&Ce.deleteBuffer(e.__webglTangentBuffer),void 0!==e.__webglColorBuffer&&Ce.deleteBuffer(e.__webglColorBuffer),void 0!==e.__webglUVBuffer&&Ce.deleteBuffer(e.__webglUVBuffer),void 0!==e.__webglUV2Buffer&&Ce.deleteBuffer(e.__webglUV2Buffer),void 0!==e.__webglTangentBuffer&&Ce.deleteBuffer(e.__webglTangentBuffer),void 0!==e.__webglBinormalBuffer&&Ce.deleteBuffer(e.__webglBinormalBuffer),void 0!==e.__webglSkinIndicesBuffer&&Ce.deleteBuffer(e.__webglSkinIndicesBuffer),void 0!==e.__webglSkinWeightsBuffer&&Ce.deleteBuffer(e.__webglSkinWeightsBuffer),void 0!==e.__webglFaceBuffer&&Ce.deleteBuffer(e.__webglFaceBuffer),void 0!==e.__webglLineBuffer&&Ce.deleteBuffer(e.__webglLineBuffer),void 0!==e.__webglLineDistanceBuffer&&Ce.deleteBuffer(e.__webglLineDistanceBuffer),void 0!==e.geometryGroups)for(var t in e.geometryGroups){xi(e.geometryGroups[t])}},Si=function(e){var t=Ze.__glResources__.texture.indexOf(e);t>=0&&Ze.__glResources__.texture.splice(t,1),e.__webglInit&&(e.__webglInit=!1,Ce.deleteTexture(e.__webglTexture),e.needsUpdate=!0)},_i=function(t){if(t&&t.__webglTexture)if(Ce.deleteTexture(t.__webglTexture),t instanceof e.WebGLRenderTargetCube)for(var i=0;i<6;i++)Ce.deleteFramebuffer(t.__webglFramebuffer[i]),Ce.deleteRenderbuffer(t.__webglRenderbuffer[i]);else Ce.deleteFramebuffer(t.__webglFramebuffer),Ce.deleteRenderbuffer(t.__webglRenderbuffer)},yi=function(e,t,i){if(null!==t){if(i)return e.programManager.disposeAllPrograms(yi),void e._deallocate(Ze);var r,n,a;e.program=null;var s=!1;for(r=0,n=Ye.length;r<n;r++)if(null!==(a=Ye[r]).program&&a.program.program===t){a.usedTimes--,0===a.usedTimes&&(s=!0);break}if(!0===s){var o=[];for(r=0,n=Ye.length;r<n;r++)null!==(a=Ye[r]).program&&a.program.program!==t&&o.push(a);Ye=o,Ce.deleteProgram(t),Ze&&Me.programs--}}};function xi(e){var t,i;if(Ce.deleteBuffer(e.__webglVertexBuffer),Ce.deleteBuffer(e.__webglNormalBuffer),Ce.deleteBuffer(e.__webglTangentBuffer),Ce.deleteBuffer(e.__webglColorBuffer),Ce.deleteBuffer(e.__webglUVBuffer),Ce.deleteBuffer(e.__webglUV2Buffer),Ce.deleteBuffer(e.__webglSkinIndicesBuffer),Ce.deleteBuffer(e.__webglSkinWeightsBuffer),Ce.deleteBuffer(e.__webglFaceBuffer),Ce.deleteBuffer(e.__webglLineBuffer),e.numMorphTargets)for(t=0,i=e.numMorphTargets;t<i;t++)Ce.deleteBuffer(e.__webglMorphTargetsBuffers[t]);if(e.numMorphNormals)for(t=0,i=e.numMorphNormals;t<i;t++)Ce.deleteBuffer(e.__webglMorphNormalsBuffers[t]);Me.geometries--}function Mi(e,t){var i,r,n=t.geometry,a=e.faces3,s=e.faces4,o=3*a.length+4*s.length,l=1*a.length+2*s.length,c=3*a.length+4*s.length,h=Pi(t,e),u=Di(h),d=Ci(h),p=bi(h);if(e.__vertexArray=new Float32Array(3*o),d&&(e.__normalArray=new Float32Array(3*o)),n.hasTangents&&(e.__tangentArray=new Float32Array(4*o)),p&&(e.__colorArray=new Float32Array(3*o)),u&&((n.faceUvs.length>0||n.faceVertexUvs.length>0)&&(e.__uvArray=new Float32Array(2*o)),(n.faceUvs.length>1||n.faceVertexUvs.length>1)&&(e.__uv2Array=new Float32Array(2*o))),t.geometry.skinWeights.length&&t.geometry.skinIndices.length&&(e.__skinIndexArray=new Float32Array(4*o),e.__skinWeightArray=new Float32Array(4*o)),e.__faceArray=new Uint16Array(3*l),e.__lineArray=new Uint16Array(2*c),e.numMorphTargets)for(e.__morphTargetsArrays=[],i=0,r=e.numMorphTargets;i<r;i++)e.__morphTargetsArrays.push(new Float32Array(3*o));if(e.numMorphNormals)for(e.__morphNormalsArrays=[],i=0,r=e.numMorphNormals;i<r;i++)e.__morphNormalsArrays.push(new Float32Array(3*o));e.__webglFaceCount=3*l,e.__webglLineCount=2*c,e.__inittedArrays=!0}function Pi(t,i){return t.material instanceof e.MeshFaceMaterial?t.material.materials[i.materialIndex]:t.material}function Ci(t){return function(t){return t&&void 0!==t.shading&&t.shading===e.SmoothShading}(t)?e.SmoothShading:e.FlatShading}function bi(e){return!!e.vertexColors&&e.vertexColors}function Di(t){return!!(t.map||t.bumpMap||t.normalMap||t.specularMap||t instanceof e.ShaderMaterial)}function wi(e,t,i){var r,n,a,s,o,l=e.vertices,c=l.length,h=e.colors,u=h.length,d=e.__vertexArray,p=e.__colorArray,f=e.__sortArray,m=e.verticesNeedUpdate,g=(e.elementsNeedUpdate,e.colorsNeedUpdate);e.__webglCustomAttributesList;if(i.sortParticles){for(It.copy(At),It.multiply(i.matrixWorld),r=0;r<c;r++)a=l[r],Rt.copy(a),Rt.applyProjection(It),f[r]=[Rt.z,r];for(f.sort(te),r=0;r<c;r++)a=l[f[r][1]],d[s=3*r]=a.x,d[s+1]=a.y,d[s+2]=a.z;for(n=0;n<u;n++)s=3*n,o=h[f[n][1]],p[s]=o.r,p[s+1]=o.g,p[s+2]=o.b}else{if(m)for(r=0;r<c;r++)a=l[r],d[s=3*r]=a.x,d[s+1]=a.y,d[s+2]=a.z;if(g)for(n=0;n<u;n++)o=h[n],p[s=3*n]=o.r,p[s+1]=o.g,p[s+2]=o.b}(m||i.sortParticles)&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,e.__webglVertexBuffer),Ce.bufferData(Ce.ARRAY_BUFFER,d,t)),(g||i.sortParticles)&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,e.__webglColorBuffer),Ce.bufferData(Ce.ARRAY_BUFFER,p,t))}function Ei(t,i,r,n,a){if(t.__inittedArrays){var s,o,l,c,h,u,d,p,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E,T,A=Ci(a),I=bi(a),R=Di(a),L=A===e.SmoothShading,O=0,N=0,F=0,V=0,U=0,B=0,k=0,G=0,z=t.__vertexArray,H=t.__uvArray,W=t.__normalArray,j=t.__tangentArray,X=t.__colorArray,q=t.__faceArray,Z=t.__lineArray,Y=i.geometry,K=Y.verticesNeedUpdate,J=Y.elementsNeedUpdate,Q=Y.uvsNeedUpdate,$=Y.normalsNeedUpdate,ee=Y.tangentsNeedUpdate,te=Y.colorsNeedUpdate,ie=Y.vertices,re=t.faces3,ne=t.faces4,ae=Y.faces,se=Y.faceVertexUvs[0];if(K){for(s=0,o=re.length;s<o;s++)m=ie[(l=ae[re[s]]).a],g=ie[l.b],v=ie[l.c],z[N]=m.x,z[N+1]=m.y,z[N+2]=m.z,z[N+3]=g.x,z[N+4]=g.y,z[N+5]=g.z,z[N+6]=v.x,z[N+7]=v.y,z[N+8]=v.z,N+=9;for(s=0,o=ne.length;s<o;s++)m=ie[(l=ae[ne[s]]).a],g=ie[l.b],v=ie[l.c],S=ie[l.d],z[N]=m.x,z[N+1]=m.y,z[N+2]=m.z,z[N+3]=g.x,z[N+4]=g.y,z[N+5]=g.z,z[N+6]=v.x,z[N+7]=v.y,z[N+8]=v.z,z[N+9]=S.x,z[N+10]=S.y,z[N+11]=S.z,N+=12;Ce.bindBuffer(Ce.ARRAY_BUFFER,t.__webglVertexBuffer),Ce.bufferData(Ce.ARRAY_BUFFER,z,r)}if(te&&I){for(s=0,o=re.length;s<o;s++)u=(l=ae[re[s]]).vertexColors,d=l.color,3===u.length&&I===e.VertexColorType.RGBA?(P=u[0],C=u[1],b=u[2]):(P=d,C=d,b=d),X[G]=P.r,X[G+1]=P.g,X[G+2]=P.b,X[G+3]=C.r,X[G+4]=C.g,X[G+5]=C.b,X[G+6]=b.r,X[G+7]=b.g,X[G+8]=b.b,G+=9;for(s=0,o=ne.length;s<o;s++)u=(l=ae[ne[s]]).vertexColors,d=l.color,4===u.length&&I===e.VertexColorType.RGBA?(P=u[0],C=u[1],b=u[2],D=u[3]):(P=d,C=d,b=d,D=d),X[G]=P.r,X[G+1]=P.g,X[G+2]=P.b,X[G+3]=C.r,X[G+4]=C.g,X[G+5]=C.b,X[G+6]=b.r,X[G+7]=b.g,X[G+8]=b.b,X[G+9]=D.r,X[G+10]=D.g,X[G+11]=D.b,G+=12;G>0&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,t.__webglColorBuffer),Ce.bufferData(Ce.ARRAY_BUFFER,X,r))}if(ee&&Y.hasTangents){for(s=0,o=re.length;s<o;s++)_=(p=(l=ae[re[s]]).vertexTangents)[0],y=p[1],x=p[2],j[B]=_.x,j[B+1]=_.y,j[B+2]=_.z,j[B+3]=_.w,j[B+4]=y.x,j[B+5]=y.y,j[B+6]=y.z,j[B+7]=y.w,j[B+8]=x.x,j[B+9]=x.y,j[B+10]=x.z,j[B+11]=x.w,B+=12;for(s=0,o=ne.length;s<o;s++)_=(p=(l=ae[ne[s]]).vertexTangents)[0],y=p[1],x=p[2],M=p[3],j[B]=_.x,j[B+1]=_.y,j[B+2]=_.z,j[B+3]=_.w,j[B+4]=y.x,j[B+5]=y.y,j[B+6]=y.z,j[B+7]=y.w,j[B+8]=x.x,j[B+9]=x.y,j[B+10]=x.z,j[B+11]=x.w,j[B+12]=M.x,j[B+13]=M.y,j[B+14]=M.z,j[B+15]=M.w,B+=16;Ce.bindBuffer(Ce.ARRAY_BUFFER,t.__webglTangentBuffer),Ce.bufferData(Ce.ARRAY_BUFFER,j,r)}if($&&A){for(s=0,o=re.length;s<o;s++)if(c=(l=ae[re[s]]).vertexNormals,h=l.normal,3===c.length&&L)for(w=0;w<3;w++)E=c[w],W[U]=E.x,W[U+1]=E.y,W[U+2]=E.z,U+=3;else for(w=0;w<3;w++)W[U]=h.x,W[U+1]=h.y,W[U+2]=h.z,U+=3;for(s=0,o=ne.length;s<o;s++)if(c=(l=ae[ne[s]]).vertexNormals,h=l.normal,4===c.length&&L)for(w=0;w<4;w++)E=c[w],W[U]=E.x,W[U+1]=E.y,W[U+2]=E.z,U+=3;else for(w=0;w<4;w++)W[U]=h.x,W[U+1]=h.y,W[U+2]=h.z,U+=3;Ce.bindBuffer(Ce.ARRAY_BUFFER,t.__webglNormalBuffer),Ce.bufferData(Ce.ARRAY_BUFFER,W,r)}if(Q&&se&&R){for(s=0,o=re.length;s<o;s++)if(void 0!==(f=se[re[s]]))for(w=0;w<3;w++)T=f[w],H[F]=T.x,H[F+1]=T.y,F+=2;for(s=0,o=ne.length;s<o;s++)if(void 0!==(f=se[ne[s]]))for(w=0;w<4;w++)T=f[w],H[F]=T.x,H[F+1]=T.y,F+=2;F>0&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,t.__webglUVBuffer),Ce.bufferData(Ce.ARRAY_BUFFER,H,r))}if(J){for(s=0,o=re.length;s<o;s++)q[V]=O,q[V+1]=O+1,q[V+2]=O+2,V+=3,Z[k]=O,Z[k+1]=O+1,Z[k+2]=O,Z[k+3]=O+2,Z[k+4]=O+1,Z[k+5]=O+2,k+=6,O+=3;for(s=0,o=ne.length;s<o;s++)q[V]=O,q[V+1]=O+1,q[V+2]=O+3,q[V+3]=O+1,q[V+4]=O+2,q[V+5]=O+3,V+=6,Z[k]=O,Z[k+1]=O+1,Z[k+2]=O,Z[k+3]=O+3,Z[k+4]=O+1,Z[k+5]=O+2,Z[k+6]=O+2,Z[k+7]=O+3,k+=8,O+=4;Ce.bindBuffer(Ce.ELEMENT_ARRAY_BUFFER,t.__webglFaceBuffer),Ce.bufferData(Ce.ELEMENT_ARRAY_BUFFER,q,r),Ce.bindBuffer(Ce.ELEMENT_ARRAY_BUFFER,t.__webglLineBuffer),Ce.bufferData(Ce.ELEMENT_ARRAY_BUFFER,Z,r)}n&&(delete t.__inittedArrays,delete t.__colorArray,delete t.__normalArray,delete t.__tangentArray,delete t.__uvArray,delete t.__uv2Array,delete t.__binormalArray,delete t.__faceArray,delete t.__vertexArray,delete t.__lineArray,delete t.__skinIndexArray,delete t.__skinWeightArray)}}this.newMaterialInheritance=!1,this.initSharedBuffersDS=function(e,t){},this.renderBufferDirect=function(t,i,r,n,a){if(!1!==r.visible){var s,o,l,c,h,u,d,p=!1;o=(s=zi(t,i,r,a,void 0,n,r.programManager.getProgramID(a,null,this.materialToUse),null,this.materialToUse)).attributes,l=n.attributes;var f=!1,m=r.wireframe?1:0,g=16777215*n.id+2*s.id+m;if(g!==et&&(et=g,f=!0),f&&Ri(),a instanceof e.Mesh){var v=l.index;if(v){var S=n.offsets;S.length>1&&(f=!0);for(var _=0,y=S.length;_<y;_++){var x=S[_].index;if(f){for(h in l)"index"!==h&&(u=o[h],d=(c=l[h]).itemSize,u>=0&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,c.buffer),Ii(u),Ce.vertexAttribPointer(u,d,Ce.FLOAT,!1,0,x*d*4)));Ce.bindBuffer(Ce.ELEMENT_ARRAY_BUFFER,v.buffer)}Ce.drawElements(Ce.TRIANGLES,S[_].count,Ce.UNSIGNED_SHORT,2*S[_].start),Pe.calls++,Pe.vertices+=S[_].count,Pe.faces+=S[_].count/3,p=!0}}else{if(f)for(h in l)"index"!==h&&(u=o[h],d=(c=l[h]).itemSize,u>=0&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,c.buffer),Ii(u),Ce.vertexAttribPointer(u,d,Ce.FLOAT,!1,0,0)));var M=n.attributes.position;Ce.drawArrays(Ce.TRIANGLES,0,M.numItems/3),p=!0,Pe.calls++,Pe.vertices+=M.numItems/3,Pe.faces+=M.numItems/3/3}}else if(a instanceof e.ParticleSystem){if(f){for(h in l)u=o[h],d=(c=l[h]).itemSize,u>=0&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,c.buffer),Ii(u),Ce.vertexAttribPointer(u,d,Ce.FLOAT,!1,0,0));M=l.position;Ce.drawArrays(Ce.POINTS,0,M.numItems/3),p=!0,Pe.calls++,Pe.points+=M.numItems/3}}else if(a instanceof e.Line&&f){for(h in l)u=o[h],d=(c=l[h]).itemSize,u>=0&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,c.buffer),Ii(u),Ce.vertexAttribPointer(u,d,Ce.FLOAT,!1,0,0));Yi(r.lineWidth);M=l.position;Ce.drawArrays(Ce.LINE_STRIP,0,M.numItems/3),p=!0,Pe.calls++,Pe.points+=M.numItems}return p}};var Ti=new e.DSPBR19xMaterial({color:14540253,roughness:.34,specular:16777215,ior:1.4,metalness:0,specularContrib:1,opacity:1,transparency:0}),Ai=e.GeomTypeEnum;function Ii(e){Ce._enabledAttributes[e]||(Ce.enableVertexAttribArray(e),Ce._enabledAttributes[e]=!0)}function Ri(){for(var e in Ce._enabledAttributes)Ce._enabledAttributes[e]&&(Ce.disableVertexAttribArray(e),Ce._enabledAttributes[e]=!1)}this.getRenderMode=function(t){var i=e.RenderMode;oi||(oi=new i);var r=e.PickingMode;li||(li=new r);var n=this.renderLineMode||0,a=this.renderPointMode||0,s=this.renderFaceMode,o=this.outlineWidth,l=this.halfVisibleSmoothEdges?1:0,c=this.renderHiddenEdges?1:0,h=oi;if(t){var u=null,d=t._occurrence;if(d){var p=d.renderMode;p&&(p._useRenderLineMask&&(n=p.getMasks()[1]),p._useRenderPointMask&&(a=p.getMasks()[2]),p._useRenderFaceMask&&(s=p.getMasks()[0]),o=p._outlineWidth,p._halfVisibleSmoothEdges>-1&&(l=p._halfVisibleSmoothEdges),p._hiddenEdges>-1&&(c=p._hiddenEdges)),u=d.pickingMode}(D||C)&&(u||(u=li)._fromRenderer(this),h._setFromMasks(a,n,s),[s,n,a]=u.getPickingMasks(h),v&&(n&=~e.BodyLinesMask,a&=~e.BodyPointsMask),D&&(s|=Ai.FACE))}return h._setFromMasks(a,n,s),h.setOutlineWidth(o),h.setHalfVisibleSmoothEdges(l),h.setHiddenEdges(c),h},this.getMaterialMode=function(e,t){if(e){if(e._occurrence&&null!==e._occurrence.faceMode)return e._occurrence.faceMode.material;if(e.materialMode<2)return!!e.materialMode}return!t&&this.materialMode},this.getRenderLineMode=function(e){var t=e&&e._occurrence&&e._occurrence.renderMode;return t&&t._useRenderLineMask?t.getMasks()[1]:this.renderLineMode},this.recompileAllShaders=function(e){e=e||ae;for(var t=0;t<e.length;t++)this.shaderVersions[e[t]]++},this.setupPickingMaterial=function(e,t,i){var r=i.pickingID>>16&255,n=(i.pickingID>>8&255)/255,a=(255&i.pickingID)/255;if(t==Ce.LINES||e&&e.lineWidth){r|=64}else if(t==Ce.TRIANGLES||null==t){r|=128}N.setRGB(r/255,n,a)},this.renderInterval=function(t,i,r,a,s,o,l,c,h,u,d,p,f,m,g,v,S){Pe.nbDGs++,Pe.nbReps+=l.cullingData?l.cullingData.length:1;var _=0;if((R&&!EXPERIENCE_PLAYER||!R&&!L)&&l.cullingData&&!t.isOrtho){var y=l.glType===Ce.TRIANGLES?h/3:h/2;if((y/=l.cullingData.length)>this.ratioSSB){var x=t.performPixelCullingOnDG(f,r,o,l,c,h);if(Pe.nbDGsSSBProcessed++,l.glType===Ce.TRIANGLES?Pe.culledDGTriangles+=(h-x)/3:l.glType===Ce.LINES&&(Pe.culledDGLines+=(h-x)/2),_=1-x/(h+1),this.colorizeSSB||(h=x),0===h)return!1}}var C,D,w,T=l.glType,A=l._instancingInfos?l._instancingInfos:r._instancingInfos?r._instancingInfos:null,I=A?A.instanceAttribArrays:null,O=null!==I,F=o.vertexBufferGPU,V=o.indexBufferGPU,U=!1;A&&(n.deallocate(A.staleGLBuffers),A.staleGLBuffers=[],O||(l._instancingInfos?l._instancingInfos=null:r._instancingInfos&&(r._instancingInfos=null))),o.needsUpdate&&(o.needsUpdate=!1,o.deallocate(Ce,Ze.info),U=!0);var B=Ce._currentProgram,k=a.programManager.getTokenProgramID(m,S);p||k!==st?(a.previousOccurrenceRenderingOverride=null,zi(t,i,a,r,d,o,k,g,v,S)):this[(G=a.program.objectUniformLocations).funcName](G,r,o,a,t,i,g);if(v){var G=a.program.uniformLocations;this.loadGASUniforms(Ce,a,G,d,v)}if(g&&g._mappingOperator&&g._loadMappingOperatorUniforms(a,this,Ce),M)this.setupPickingMaterial(a,T,r),(G=a.program.uniformLocations).pickingColor?Ce.uniform3f(G.pickingColor,N.r,N.g,N.b):Ce.uniform3f(G.diffuse,N.r,N.g,N.b);else if(this._planeViewMode&&r._applyPlaneViewMode&&(this._planeViewMode.mode===e.PlaneViewMode.LOWLIGHT||this._planeViewMode.mode===e.PlaneViewMode.LOWLIGHT_NO_PICK)){(G=a.program.uniformLocations).diffuse&&Ce.uniform3f(G.diffuse,.26,.4,.33)}else if(this.colorizeSSB&&_){(G=a.program.uniformLocations).diffuse&&Ce.uniform3f(G.diffuse,_,0,0)}a.map&&a.map.lods&&!b&&!E&&a.map.chooseTexture(t,r),C=a.program,D=C.attributes,w=C.instanceAttributes;var z=!1;!C.uvOrBinOrTan||o.compressedNormals||o.vertexBufferGPU&&o.vertexBufferGPU.layout.has("uv")||(o.vertexIndexArray?(o.computeUVs(),o.deallocate(Ce,Ze.info),U=!0):(g&&g._mappingOperator?g._mappingOperator.mappingType:a.mappingType)<1&&this._NoMeshInRamWarningCount<1&&(console.warn("uv computation unavailable in noMeshInRAM mode"),this._NoMeshInRamWarningCount++));var H=a.requireVertexTangentBinormal()&&(g&&g._mappingOperator?g._mappingOperator.mappingType:a.mappingType)<1;if(o.vertexBufferGPU?!(H&&o.vertexBufferGPU.layout.has("uv")&&o.vertexBufferGPU.layout.has("normal"))||o.vertexBufferGPU.layout.has("binormal")&&o.vertexBufferGPU.layout.has("tangent")||(o.vertexIndexArray?(o.computeTangents(),o.deallocate(Ce,Ze.info),U=!0):this._NoMeshInRamWarningCount<2&&(console.warn("tangent binormal computation unavailable in noMeshInRAM mode"),this._NoMeshInRamWarningCount++)):!(o.vertexUvArray&&o.vertexNormalArray&&H)||o.vertexBinormalArray&&o.vertexTangentArray||(o.computeTangents(),o.deallocate(Ce,Ze.info),U=!0),F&&V||(U=!0),O)for(var W in ot!==I.id&&(ot=I.id,z=!0),I)if("id"!==W){if(!I[W].buffer){n.allocateInstancingBuffers(r,l);break}I[W].isDynamic&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,I[W].buffer),Ce.bufferData(Ce.ARRAY_BUFFER,I[W].array,Ce.DYNAMIC_DRAW),I[W].isDynamic=!1)}if(U&&(n.allocateDirect(o),F=o.vertexBufferGPU,V=o.indexBufferGPU),!F||!V)return!1;if(o._uploadStaleIndices(Ce),o._uploadStaleVertices(Ce),F!==tt&&(tt=F,z=!0),z&&(Pe.swapBuffers++,Pe.unsharedBuffers+=o.sharedBuffers&&!F.isShared?1:0,Ce.bindBuffer(Ce.ARRAY_BUFFER,F.buffer),F.layout.forEach(function(e){const t=D[e.name];if(!Number.isInteger(t)||t<0)return;const i=P.VertexAttribute[e.type];Ce.vertexAttribPointer(t,i.components,i.native,i.normalized,e.stride,e.offset)}),O))for(var j in I)"id"!==j&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,I[j].buffer),w[j]>=0&&I[j].array&&(I[j].isMat4?(Ce.vertexAttribPointer(w[j],I[j].itemSize,Ce.FLOAT,!1,64,0),Ce.vertexAttribPointer(w[j]+1,I[j].itemSize,Ce.FLOAT,!1,64,16),Ce.vertexAttribPointer(w[j]+2,I[j].itemSize,Ce.FLOAT,!1,64,32),Ce.vertexAttribPointer(w[j]+3,I[j].itemSize,Ce.FLOAT,!1,64,48)):Ce.vertexAttribPointer(w[j],I[j].itemSize,Ce.FLOAT,!1,0,0)));if(V!==it&&(it=V,Ce.bindBuffer(Ce.ELEMENT_ARRAY_BUFFER,V.buffer)),B!=Ce._currentProgram){var X={};if(O)for(var j in I)"id"!==j&&w[j]>=0&&(I[j].isMat4?(X[w[j]]=!0,X[w[j]+1]=!0,X[w[j]+2]=!0,X[w[j]+3]=!0):X[w[j]]=!0);r.isCurvedPipe&&(w.specialMeshIds>=0&&(X[w.specialMeshIds]=!0),w.specialMeshPicking>=0&&(X[w.specialMeshPicking]=!0)),F.layout.forEach(function(e){const t=D[e.name];!Number.isInteger(t)||t<0||(X[t]=!0)}),function(e){for(var t in e)Ce._enabledAttributes[t]||(Ce.enableVertexAttribArray(t),Ce._enabledAttributes[t]=!0);for(var t in Ce._enabledAttributes)Ce._enabledAttributes[t]&&!e[t]&&(Ce.disableVertexAttribArray(t),Ce._enabledAttributes[t]=!1)}(X)}var q=!1,Z=!1;if(u&&u.scissor&&"box"===u.scissor.type){q=!0;var Y,K,J,Q,$=u.scissor.data;$.updateClipRect(t,this.currentFrameIndex,bt,Dt),Ce.enable(Ce.SCISSOR_TEST),wt?(Y=Math.max(Et.x,$.clipX0),K=Math.max(Et.y,$.clipY0),J=Math.min(Et.x+Et.width,$.clipX1)-Y,Q=Math.min(Et.y+Et.height,$.clipY1-K)):(Y=$.clipX0,K=$.clipY0,J=$.clipX1-$.clipX0,Q=$.clipY1-$.clipY0),Ce.scissor(Y,K,J,Q),(Y+J<0||K+Q<0||Y>bt||K>Dt)&&(Z=!0)}if(!Z)if(m)m.draw(Ce,m,h,kt,I,w);else{const e=o.indexBufferGPU,t=T===Ce.TRIANGLES||T===Ce.TRIANGLE_STRIP;a.wireframe&&t?Ce.drawElements(Ce.LINE_STRIP,h,e.glFormat,c*e.bytesPerIndex):T===Ce.POINTS&&o.vertexPositionArray&&o.vertexPositionArray.nonindexedPoints?Ce.drawArrays(T,o.vertexIndexArray[c],h):l.nonIndexed?Ce.drawArrays(T,c,h):Ce.drawElements(T,h,e.glFormat,(o.indexOffsetGPU+c)*e.bytesPerIndex)}return q&&(wt?Ce.enable(Ce.SCISSOR_TEST):Ce.disable(Ce.SCISSOR_TEST),Et.x!==-1/0&&Ce.scissor(Et.x,Et.y,Et.width,Et.height)),Pe.calls++,Pe.vertices+=h,T===Ce.TRIANGLES?Pe.faces+=h/3:T===Ce.LINES?Pe.lines+=h/2:T===Ce.POINTS&&(Pe.points+=h),!0},this.renderSectionLines=function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g){if(r.__isSectionLine){var v=0;for(v=0;v<Ut.length;v++)if(Ut.sectionLines[v]){var S=r.program;r.clipPlaneIndex=v+1,S&&S.program===Ce._currentProgram&&Ce.uniform1i(S.uniformLocations.currentClipPlane,v),this._clipPlanesState.update(c,null,!0,r,e,!0),this.renderInterval.apply(this,arguments)}r.clipPlaneIndex=0,this._clipPlanesState.update(c,null,!0,r,e,!1)}else this.renderInterval.apply(this,arguments)},this.renderBuffer=function(t,i,r,n,a,s){if(!1===r.visible)return!1;var o,l,c,h,u,d;l=(o=zi(t,i,r,a,s,null,r.programManager.getProgramID(a,null,this.materialToUse),null,null,this.materialToUse)).attributes,M&&(this.setupPickingMaterial(r,null,a),r.uniforms&&r.uniforms.pickingColor?Ce.uniform3f(r.program.uniformLocations.pickingColor,N.r,N.g,N.b):Ce.uniform3f(r.program.uniformLocations.diffuse,N.r,N.g,N.b));var p=!1,f=r.wireframe?1:0,m=16777215*n.id+2*o.id+f;if(m!==et&&(et=m,p=!0),p&&Ri(),!r.morphTargets&&l.position>=0?p&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,n.__webglVertexBuffer),Ii(l.position),Ce.vertexAttribPointer(l.position,3,Ce.FLOAT,!1,0,0)):a.morphTargetBase,p){if(n.__webglCustomAttributesList)for(u=0,d=n.__webglCustomAttributesList.length;u<d;u++)l[(h=n.__webglCustomAttributesList[u]).buffer.belongsToAttribute]>=0&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,h.buffer),Ii(l[h.buffer.belongsToAttribute]),Ce.vertexAttribPointer(l[h.buffer.belongsToAttribute],h.size,Ce.FLOAT,!1,0,0));l.color>=0&&n.__colorArray&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,n.__webglColorBuffer),Ii(l.color),Ce.vertexAttribPointer(l.color,3,Ce.FLOAT,!1,0,0)),l.normal>=0&&n.__normalArray&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,n.__webglNormalBuffer),Ii(l.normal),Ce.vertexAttribPointer(l.normal,3,Ce.FLOAT,!1,0,0)),l.tangent>=0&&n.__tangentArray&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,n.__webglTangentBuffer),Ii(l.tangent),Ce.vertexAttribPointer(l.tangent,4,Ce.FLOAT,!1,0,0)),l.uv>=0&&n.__uvArray&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,n.__webglUVBuffer),Ii(l.uv),Ce.vertexAttribPointer(l.uv,2,Ce.FLOAT,!1,0,0)),l.uv2>=0&&n.__uv2Array&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,n.__webglUV2Buffer),Ii(l.uv2),Ce.vertexAttribPointer(l.uv2,2,Ce.FLOAT,!1,0,0)),(a._skinning||a._skinningInstancing)&&l.skinIndex>=0&&l.skinWeight>=0&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,n.__webglSkinIndicesBuffer),Ii(l.skinIndex),Ce.vertexAttribPointer(l.skinIndex,4,Ce.FLOAT,!1,0,0),Ce.bindBuffer(Ce.ARRAY_BUFFER,n.__webglSkinWeightsBuffer),Ii(l.skinWeight),Ce.vertexAttribPointer(l.skinWeight,4,Ce.FLOAT,!1,0,0)),l.lineDistance>=0&&(Ce.bindBuffer(Ce.ARRAY_BUFFER,n.__webglLineDistanceBuffer),Ii(l.lineDistance),Ce.vertexAttribPointer(l.lineDistance,2,Ce.FLOAT,!1,0,0))}return a instanceof e.Mesh?(r.wireframe?(Yi(r.wireframeLinewidth),p&&Ce.bindBuffer(Ce.ELEMENT_ARRAY_BUFFER,n.__webglLineBuffer),Ce.drawElements(Ce.LINES,n.__webglLineCount,Ce.UNSIGNED_SHORT,0)):(p&&Ce.bindBuffer(Ce.ELEMENT_ARRAY_BUFFER,n.__webglFaceBuffer),Ce.drawElements(Ce.TRIANGLES,n.__webglFaceCount,Ce.UNSIGNED_SHORT,0)),Pe.calls++,Pe.vertices+=n.__webglFaceCount,Pe.faces+=n.__webglFaceCount/3):a instanceof e.Line?(c=a.type===e.LineStrip?Ce.LINE_STRIP:Ce.LINES,Yi(r.lineWidth),Ce.drawArrays(c,0,n.__webglLineCount),Pe.calls++):a instanceof e.ParticleSystem&&(Ce.drawArrays(Ce.POINTS,0,n.__webglParticleCount),Pe.calls++,Pe.points+=n.__webglParticleCount),!0},this.isQAAutomationMode=function(){return this._defaultAppearanceType===e.DefaultAppearanceMode.__QA_AUTOMATION__},this.addDGToDL=function({object:t,geometry:i,dg:r=null,dgInterval:n=null,material:a,originalMaterial:s,renderMode:o=null,getDLFromObjectFunc:l,geomDisposeFunc:c,enableGSSOCache:h,camera:d,matApp:f=null,gasMaterial:m=null,gasStruct:v=null,materialMode:S=!1}){if(a.visible){var x=this._defaultAppearanceType;(_||y)&&(x=W.BASIC);var M=x===e.DefaultAppearanceMode.__QA_AUTOMATION__;if(!this.renderVolumesOnly&&s._isLineWithShapes&&!b&&!E){const n=new e.Matrix4(this.domElement.width/2,0,0,0,0,this.domElement.height/2,0,0,0,0,1,0,0,0,0,1).multiply(d.projectionMatrix).multiply(d.matrixWorldInverse).multiply(t._getMMMatrix());let a=s._computeDependentDGs(r,i,n);for(let e=0;e<a.length;e++){let i=a[e].material;i._deferredMaterialsInit||i.updateDeferredMaterials(),this.addDGToDL({object:t,geometry:a[e].geometry,dg:a[e],dgInterval:a[e],material:i._deferredMaterials[this.materialToUse],originalMaterial:i,renderMode:o,getDLFromObjectFunc:l,geomDisposeFunc:c,enableGSSOCache:h,camera:d,matApp:f,gasMaterial:m,gasStruct:v,materialMode:S})}}var P=a,C=s;if(!this.gasAsPhong||!P.isPhysicalMaterial||null===P._phongFallbackMaterial||((P=P._phongFallbackMaterial)._deferredMaterialsInit||P.updateDeferredMaterials(),P=P._deferredMaterials[this.materialToUse])){var T=!this.isQAAutomationMode()&&t.occurrenceRenderingOverride&&t.occurrenceRenderingOverride.getFullMaterial(S),A=null;(P.overridable||P._forceAllowFullMaterialOverride)&&T&&(T.isMatApp?(A=T._getMaterialFromGLType(r.glType,r._geomType)||null)&&(P=A,s=A,f=T):(A=T,(u||w||E||P.deferrable)&&(r.glType===Ce.POINTS?"POINTS"===A.targetPrimitiveType:r.glType===Ce.LINES||r.glType===Ce.POINTS?"LINES"===A.targetPrimitiveType:"FACES"===A.targetPrimitiveType)&&(u||(!A._deferredMaterialsInit&&A.updateDeferredMaterials(),A=A._deferredMaterials[this.materialToUse]),P=A,s=A)));var I=!p&&t._isReceivingDecal(),R=!1;if((b||E)&&!t.castShadow){if(!I)return;R=!0}if(g&&(!t.enableNormalDepth||this._debugMaterialMode>0)){if(!I)return;R=!0}if(g||b||E){if(t._noZPriority||r._noZPriority>=0)return;if(r.glType<=Ce.LINE_STRIP)return}if(!C.deferrable||!C._transparencyOnGPU(t)){if(((this._forbidRenderableState&B.NO_TRANSPARENT)>0||b&&!C._forceOpaqueShadowMapPass())&&C)if(t.occurrenceRenderingOverride){var L=null;if((N=t.occurrenceRenderingOverride.materialOverride)&&(L=N.getOpacity()),null!==L){if(L<1){if(!I)return;R=!0}}else if(A){if(A.getOpacity()<1||A.transparent){if(!I)return;R=!0}}else if(C.getOpacity()<1||C.transparent){if(!I)return;R=!0}}else if(C.getOpacity()<1||C.transparent){if(!I)return;R=!0}if(E&&C){var O=C.transparent;if(t.occurrenceRenderingOverride){var N;L=null;(N=t.occurrenceRenderingOverride.materialOverride)&&(L=N.getOpacity()),null!==L?L<1&&(O=!0):A?(A.getOpacity()<1||A.transparent)&&(O=!0):C.getOpacity()<1&&(O=!0)}else C.getOpacity()<1&&(O=!0);if(!O||C._forceOpaqueShadowMapPass()){if(!I)return;R=!0}}}for(var F=o?o._hiddenEdges>0:this.renderHiddenEdges,V=P.polite||F&&r&&r._geomType&&(r._geomType===e.GeomTypeEnum.SHARP_EDGE||r._geomType===e.GeomTypeEnum.SMOOTH_EDGE||r._geomType===e.GeomTypeEnum.BOUNDARY_EDGE||r._geomType===e.GeomTypeEnum.EDGE)?2:1,U=0;U<V;U++){U&&(P.politeMaterial||(P.politeMaterial=P.clone(),D||(P.politeMaterial.transparent=!0,P.politeMaterial.opacity=.3,P.politeMaterial.depthTest=!1,P.politeMaterial.depthWrite=!1)),P=P.politeMaterial);var k=l(t,r,P,n,v);if(k){var G=t._gsso_cache[k.ssrId];if(t.isCurvedPipe){var z=e.InstancedCurvedPipeManager,H=z._initMatricesMap(),j=t.id+"_"+i.drawingGroups.indexOf(r),q=z._perRenderableData.get(j);if(!q)continue;for(var Z=z._instancingGroups,Y=q.length,K=0;K<Y;K++){if(ne=Z[q[K].bin]){var J=ne._initCurvesMaps(z),Q=!ne.materials[a.id];Q&&(ne.materials[a.id]=a.clone(),z.setPDSFXParamsOnMaterial(ne.materials[a.id]));P=ne.materials[a.id];if(Q&&(P.updatePDSFXUniform("curvesMaps",ne._curvesMaps),P.updatePDSFXUniform("curvesMapsProperties",ne._curvesMapsProperties),P.updatePDSFXUniform("curvesMatrices",z._matricesMaps),P.updatePDSFXUniform("curvesMatricesProperties",z._curvesMatricesProperties)),J)for(var $ in ne.materials){(ae=ne.materials[$]).updatePDSFXUniform("curvesMaps",ne._curvesMaps),ae.updatePDSFXUniform("curvesMapsProperties",ne._curvesMapsProperties)}var ee=t.currentLOD;-1===ee&&(ee=ne._LODGeometries.length-1);var te=ne._LODGeometries[ee],ie=te.drawingGroups[0],re={dgIndex:j,index:K};k.addDrawable({material:P,object:t,geometry:te,dg:ie,dgInterval:ie,renderMode:o,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:c,materialToUse:this.materialToUse,matApp:f,gasMaterial:m,cpInfos:re,qaAutomationMode:M}),G.push(new he({dlIndex:k.index,material:P,object:t,geometry:te,dg:ie,dgInterval:ie,renderMode:o&&o.clone(),renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:c,materialToUse:this.materialToUse,matApp:f,gasMaterial:m,cpInfos:re,renderLineMode:t.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame}))}}if(H)for(K=0;K<Z.length;K++){var ne;if(ne=Z[K])for(var $ in ne.materials){var ae;(ae=ne.materials[$]).updatePDSFXUniform("curvesMatrices",z._matricesMaps),ae.updatePDSFXUniform("curvesMatricesProperties",z._curvesMatricesProperties)}}return}if(C._isLineWithShapes&&C._isBidimLine)continue;if(k.hasDecal&&I){if(k.addDrawable({material:C._deferredMaterials[X.decalNormalStencilDepthMaterial],object:t,geometry:i,dg:r,dgInterval:n,renderMode:o,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:c,materialToUse:X.decalNormalStencilDepthMaterial,matApp:f,gasMaterial:m,qaAutomationMode:M}),G.push(new he({dlIndex:k.index,material:C._deferredMaterials[X.decalNormalStencilDepthMaterial],object:t,geometry:i,dg:r,dgInterval:n,renderMode:o&&o.clone(),renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:c,materialToUse:X.decalNormalStencilDepthMaterial,matApp:f,gasMaterial:m,renderLineMode:t.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame})),t._decalData.needDrawUvs&&(k.addDrawable({material:C._deferredMaterials[X.texCoordMaterial],object:t,geometry:i,dg:r,dgInterval:n,renderMode:o,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:c,materialToUse:X.texCoordMaterial,matApp:f,gasMaterial:m,qaAutomationMode:M}),G.push(new he({dlIndex:k.index,material:C._deferredMaterials[X.texCoordMaterial],object:t,geometry:i,dg:r,dgInterval:n,renderMode:o&&o.clone(),renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:c,materialToUse:X.texCoordMaterial,matApp:f,gasMaterial:m,renderLineMode:t.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame}))),e._mobileDevice&&(k.addDrawable({material:C._deferredMaterials[X.depthRGBAMaterial],object:t,geometry:i,dg:r,dgInterval:n,renderMode:o,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:c,materialToUse:X.depthRGBAMaterial,matApp:f,gasMaterial:m,qaAutomationMode:M}),G.push(new he({dlIndex:k.index,material:C._deferredMaterials[X.depthRGBAMaterial],object:t,geometry:i,dg:r,dgInterval:n,renderMode:o&&o.clone(),renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:c,materialToUse:X.depthRGBAMaterial,matApp:f,gasMaterial:m,renderLineMode:t.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame}))),!R){var se=t._gsso_cache[k._fatherDL.ssrId];k._fatherDL.addDrawable({material:P,object:t,geometry:i,dg:r,dgInterval:n,renderMode:o,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:c,materialToUse:this.materialToUse,matApp:f,gasMaterial:m,qaAutomationMode:M}),se.push(new he({dlIndex:k._fatherDL.index,material:P,object:t,geometry:i,dg:r,dgInterval:n,renderMode:o&&o.clone(),renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:c,materialToUse:this.materialToUse,matApp:f,gasMaterial:m,renderLineMode:t.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame}))}}else k.addDrawable({material:P,object:t,geometry:i,dg:r,dgInterval:n,renderMode:o,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:c,materialToUse:this.materialToUse,matApp:f,gasMaterial:m,qaAutomationMode:M}),G.push(new he({dlIndex:k.index,material:P,object:t,geometry:i,dg:r,dgInterval:n,renderMode:o&&o.clone(),renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:c,materialToUse:this.materialToUse,matApp:f,gasMaterial:m,renderLineMode:t.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame}))}}}}},this.resetGSSOCache=function(){this.resetGSSOCacheFrame++},this._setToneMapping=function(e){this.gammaInput=e>0,this.simpleGamma=e<2},this.increaseFrameCount=function(e){J.resetCullingStatuses(this.currentFrameIndex),this.currentFrameIndex++,this._currentFrameType=e,this.info.render=this.info.renderMap.get(e),this.info.render||(this.info.render=new I.RenderInfo,this.info.renderMap.set(e,this.info.render)),Pe=this.info.render,this.info.render.reset()};var Li={};!function(){var t,i,r=["EDGE","WIRE_EDGE","BOUNDARY_EDGE","SHARP_EDGE","SMOOTH_EDGE","HIDDEN_SEAM_EDGE","BOUNDARY_POINT","SHARP_POINT","SMOOTH_POINT","HIDDEN_SEAM_POINT","SURFACIC_POINT","FREE_POINT","INFINITE_FACE","FACE","UNKNOWN","AXIS_SYSTEM","_OUTLINE"],n={EDGE:1,WIRE_EDGE:1,BOUNDARY_EDGE:1,SHARP_EDGE:1,SMOOTH_EDGE:1,HIDDEN_SEAM_EDGE:1,BOUNDARY_POINT:0,SHARP_POINT:0,SMOOTH_POINT:0,HIDDEN_SEAM_POINT:0,SURFACIC_POINT:0,FREE_POINT:0,INFINITE_FACE:2,FACE:2,UNKNOWN:2,AXIS_SYSTEM:2,_OUTLINE:1};for(t=0;t<r.length;t++)i=r[t],Li[e.GeomTypeEnum[i]]=n[i]}(),this.getStateSortedObjects=function(t,r,n,a,l){s++;var c=this,h=r.getDisplayListByName("DEPTHVALUE"),d=r.getDisplayListByName("DEPTHVALUE2"),f=r.getDisplayListByName("EDGE"),m=r.getDisplayListByName("POINT"),g=r.getDisplayListByName("SOLID"),v=r.getDisplayListByName("SURFACE"),P=r.getDisplayListByName("SURFACE_CURVED_PIPE"),b=r.getDisplayListByName("SURFACE_CURVED_PIPE_TRANSPAR"),w=r.getDisplayListByName("BACK"),T=r.getDisplayListByName("NOZ"),A=r.getDisplayListByName("DECALS"),I=r.getDisplayListByName("TRANSPAR"),R=r.getDisplayListByName("TRANSPAR1D"),L=r.getDisplayListByName("NOZTRANSPAR"),O=r.getDisplayListByName("EDGEPRIMITIVESELECTION"),N=r.getDisplayListByName("EDGEADJACENCESELECTION"),F=r.getDisplayListByName("POINTPRIMITIVESELECTION"),V=this._defaultAppearanceType;(_||y)&&(V=W.BASIC);var U=V===e.DefaultAppearanceMode.__QA_AUTOMATION__,k=[m,f,v,v,T,g],G=[R,R,I,I,L,I],z=u&&!this._debugMaterialMode||E||M||S,H="true"===localStorage.getItem("__WEBVISU_NEWHL_POC__")&&!e.__unrolledHighlight()||U;const j={outlinesCreated:!1,objectWithTransientGSSO:new Set,sortCount:s,outlinesCameraDirection:null};this._inheritanceSolver.setGlobals(function(t,i,n,a,s){if(n._sceneGraphOrderMode)return 2==n._sceneGraphOrderMode?h:d;if(n.defines&&void 0!==n.defines.NB_OUTLINE_MAPS)return f;if(n.isBackMaterial)return w;var o;if(M&&r._pickingPriorityMapping&&t.pickingPriorityID){var m=t.pickingPriorityID.points;if(i.glType>=4?m=t.pickingPriorityID.faces:i.glType>=1&&(m=t.pickingPriorityID.edges),m&&(o=r._pickingPriorityMapping[m]),o)return o}var S=t._priorityMode,_=a&&a!==i?a.noZ:-1,y=_>=0?_:i&&i._noZPriority>=0?i._noZPriority:t&&t._noZPriority?4:-1;-1==y&&s&&s._type==e.GASTypeEnum.NOZ&&(y=s._priority);var x=null;if(y>=0&&!(i._geomType&e.NoNoZPriorityMask))switch(S){case e.PriorityMode.ClassicPriority2D:x=s&&s._type==e.GASTypeEnum.NOZ&&s._transparent?r.getDisplayListByPriority(y):r.getDisplayListByPriority(e.displayListPriorityEnum.priority[y]);break;case e.PriorityMode.ClassicPriority:x=r.getDisplayListByPriority(e.displayListPriorityEnum.priority[y]);break;case e.PriorityMode.Advanced:x=r.getDisplayListByPriority(e.displayListPriorityEnum.priorityP[y]);break;case e.PriorityMode.SceneGraphOrder:break;case e.PriorityMode.DepthPriority:x=s&&s._type==e.GASTypeEnum.NOZ&&s._transparent?r.getDisplayListByPriority(y):r.getDisplayListByPriority(e.displayListPriorityEnum.OTHER2D)}var C=null;if(D&&(l.highlightData._needsDepth||U))if((t._programID&e.ProgramIDs.PRIMITIVE_HIGHLIGHT)>0)H&&(0==i.glType&&(C=F),1!=i.glType||n.is2DLine||(C=O));else if((t._programID&e.ProgramIDs.ADJACENCE_HIGHLIGHT)>0&&!U){if(H){if(!(1==i.glType&&(i._geomType&e.BodyLinesMask)>0))return null;C=N}}else{if(0==i.glType&&(i._geomType&e.BodyPointsMask)>0&&!U)return null;if(1==i.glType&&(i._geomType&e.BodyLinesMask)>0&&!U)return null}if(x)return x;if(C)return C;var E,T=function(t,i,r){var n=2;return t?(t._getDimension||(t._getDimension=function(e,t){var i=2,r=this;if(r._geomType)i=e[r._geomType];else switch(r.glType){case 0:i=0;break;case 1:i=1;break;default:i=2}return 2===i&&(i=t&&t._bodyDim>0?3===t._bodyDim?5:2:r.gas&&0===r.gas.side?5:2),this._dimension=i,i}),n=-1,2===(n=u||-1===t._dimension?t._getDimension(Li,i):t._dimension)&&r&&0===r.side&&(n=5),n):(i instanceof e.Line&&(n=1),n)}(i,t,s),R=n,L=n.overridable&&t.occurrenceRenderingOverride&&t.occurrenceRenderingOverride.materialOverride,V=null;!L||n.isPhysicalMaterial&&0!==n.transparency||L.internalMaterialOverride&&n===L.internalMaterialOverride.material||null!==(E=L.getOpacity())&&(V=E<1),c.useRenderPriorityOpacity&&c.computeRenderPriorityOpacity(1,L)<1&&(V=!0);return o=z&&(V||null===V&&!n.iterative&&R.getOpacity()<1||R.transparent)?G[T]:k[T],t.isCurvedPipe&&(o!==v&&o!==g||(o=P),o===I&&(o=b)),p||!t._isInDecalPass()||!n._deferredMaterials[X.decalNormalStencilDepthMaterial]||o!==I&&o!==v&&o!==g&&o!==P&&o!==b||(A._fatherDL=o,o=A),o},di,a,V,n,r.id,_,C,D),this._inheritanceSolver.enableOutlineHanding(x,j);this.materialToUse;for(var q=this.resetGSSOCacheFrame,Z=(a&&a.isOrtho,0);Z<t.length;++Z){var Y=t[Z];if(Y){var K=Y.object,J=K._gsso_cache?K._gsso_cache[r.id]:null;if(!K.filtered){var Q=J?J.length:0;if(u&&(K._forceBackFacesOnSolid=!1),Q>0&&J[0].resetFrameIndex>=q){K.renderLineMode=J[0].renderLineMode;for(var $=0;$<J.length;$++)J[$].addDrawable(r._displayLists,U)}else!u&&K instanceof e.Line||C&&!K.noPickThrough||C&&K.applyBackgroundViewMode&&!this._pickBackgroundNodes||(this._forbidRenderableState&B.NO_INVISIBLE_PLANE)>0&&K.__invisiblePlane||this._inheritanceSolver.solve(K)}}}for(j.outlinesCreated&&i.TexturesManager.finalize(),o=0;o<r._displayLists.length;o++)r._displayLists[o].finalize();j.objectWithTransientGSSO.forEach(e=>e._flagAsGSSOInvalidated()),this._inheritanceSolver.reset()},this.renderCuttingElements=function(t,i,r,n){function a(t){return!(!t||!(t instanceof e.MeshBasicMaterial||t instanceof e.MeshPhongMaterial||t instanceof e.MeshLambertMaterial||t instanceof e.PhysicalMaterial)||t.map)}if(this.cuttingScene){var s,o=Ze.getContext();o.stencilFunc(o.NOTEQUAL,100,255),o.colorMask(!0,!0,!0,!0),o.stencilMask(0),o.enable(o.CULL_FACE),this.setDepthWrite(!0);var l=this.disableBackFaceClipPlanes;this.disableBackFaceClipPlanes=0;var c=n&&n.clipPlanes,h=this.cuttingScene.getWebGLObjects("main",this.currentFrameIndex),u=n&&n.getClippingSettings();if(u&&0===u.frontOpacity&&o.cullFace(o.FRONT),c){var d,p=[];for(d=0;d<c.length;d++)(v=c[d].clippingContext&&c[d].clippingContext[this.id])&&v.clippingMeshIndex>0&&p.push(h[v.clippingMeshIndex-1]);h=p}var f,m,g=0,v=n&&n.clippingContext,S=this.materialToUse===X.depthRGBAMaterial||this.materialToUse===X.normalDepthIoRRoughnessMaterial||this.materialToUse===X.normalDepthMaterial||this.materialToUse===X.ZOnlyMaterial;for(g=h.length-1;g>=0;g-=1)if(null!==h[g]&&(!v||v._hasPlaneCapping(h[g].object.clippingPlane))){if(m=null,s=null,n&&n.sectionCappingMaterials){for(m=n.sectionCappingMaterials.defaultMaterial,f=0;f<n.sectionCappingMaterials.length;f++)if(n.sectionCappingMaterials[f].clippingPlane===h[g].object.clippingPlane){m=n.sectionCappingMaterials[f].material;break}m&&(m.clipPlaneIndex=g+1,h[g].object.geometry.normalsNeedUpdate=!0)}var _;if(Fi(h[g].object,i),t&&t.enableReceiveShadowOnCapping&&(h[g].object.receiveShadow=!0),S||!m&&h[g].object.material.clipPlaneUseModelMaterial)S||a(t)?(m=t,s=n&&!S&&n.materialOverride):(this.backupCuttingMaterial||(this.backupCuttingMaterial=e.MaterialUtils.createShinyFaceMaterial({color:"black"})),m=this.backupCuttingMaterial),m.clipPlaneIndex=g+1;else if((m=m||h[g].object.material)&&(m.clipPlaneIndex=g+1),e.HatchingMeshMaterial&&m instanceof e.HatchingMeshMaterial)m.autoSpaceColor&&(a(t)?(_=n&&n.getOverrideColor(t),m.spaceColor=_||t.color):(_=n&&n.getOverrideColor(),m.spaceColor=_||new e.Color(16777215))),m.autoStripesColor&&(a(t)?m.stripesColor=_||t.color:m.stripesColor=_||new e.Color(0));this._clipPlanesState.update(n,null,!0,m,i,!0),Bi(h[g].object,m),m._renderedClipPlane=h[g].object.clippingPlane,this.setPolygonOffset(!0,1,1),this.renderObjects([h[g]],!1,"",i,r,!0,m,s),m._renderedClipPlane=null,(S||h[g].object.material.clipPlaneUseModelMaterial)&&(m.clipPlaneIndex=0)}return u&&0===u.frontOpacity&&o.cullFace(o.BACK),this.setDepthWrite(!1),o.disable(o.CULL_FACE),o.stencilFunc(o.ALWAYS,100,255),o.colorMask(!1,!1,!1,!1),o.stencilMask(255),this.clear(!1,!1,!0),this.disableBackFaceClipPlanes=l,this._clipPlanesState.update(null,null,!0,t,i),!0}return!1},this.renderAssets=function(){var e=!1,t=_e;null!==this.ambianceGenerators&&(e=e||this.ambianceGenerators.update(this.currentFrameIndex,this)),e&&this.setRenderTarget(t)};const Oi=e._VisuFilterType;this.updateCSSNodes=function(t,i){var r=t.getWebGLObjects("css2d",this.currentFrameIndex),n=t.getWebGLObjects("css3d",this.currentFrameIndex);if(i.matrixWorldInverse.getInverse(i.matrixWorld),n.length&&i._viewpoint){var a=i.isOrtho?i.projectionMatrix.elements[5]*h:.5/Math.tan(e.Math.degToRad(.5*i.fov))*l,s=i._viewpoint.divCameraCSSElement;if(i.isOrtho?(q.style.WebkitPerspective="",q.style.MozPerspective="",q.style.oPerspective="",q.style.perspective=""):(q.style.WebkitPerspective=a+"px",q.style.MozPerspective=a+"px",q.style.oPerspective=a+"px",q.style.perspective=a+"px"),i.isOrtho)P="scale("+a+")translate("+ci(-(i.right+i.left)/2)+"px,"+ci((i.top+i.bottom)/2)+"px)"+hi(i.matrixWorldInverse)+"translate("+c+"px,"+h+"px)";else P="translate3d(0,0,"+a+"px)"+hi(i.matrixWorldInverse)+" translate3d("+c+"px,"+h+"px, 0)";s.style.WebkitTransform=P,s.style.MozTransform=P,s.style.oTransform=P,s.style.transform=P}var o,u=null;for(o=0;o<r.length;o++){if(null!==(_=r[o]))if((!(x=(y=_.object)._getFilter(Oi._MATERIAL_TO_USE))||x.materialToUse===this.materialToUse)&&F(y.visible,y.visibilityFree,this.visibleSpace,void 0,y._occurrence)){if(this.renderIteration>0)continue;var d=new e.Vector3;d.copy(y.position);var p=!1;if(this.clipPlanesEnabled)for(var f=0;f<this.clipPlanes.length;f++){var m=this.clipPlanes[f];if(m.normal.x*y.position.x+m.normal.y*y.position.y+m.normal.z*y.position.z+m.constant<0){p=!0;break}}if((i.isOrtho||i.getLookAt().dot(i.position.clone().sub(d))<0)&&!p){(new e.Projector).projectVector(d,i),y.element.style.display="block";var g=e.getDevicePixelRatio()||1,v=y.offset.x/g,S=y.offset.y/g;y.element.style.left=v+.5*(d.x+1)*this.domElement.clientWidth+"px",y.element.style.top=S-.5*(d.y-1)*this.domElement.clientHeight+"px",u||(u=[]),u.push({domElement:y.element,z:d.z,alwaysOnTopIndex:y._occurrence?y._occurrence.node._alwaysOnTopIndex:null})}else y.element.style.display="none"}}for(o=0;o<n.length;o++){var _,y,x;if(null!==(_=n[o]))if((!(x=(y=_.object)._getFilter(Oi._MATERIAL_TO_USE))||x.materialToUse===this.materialToUse)&&F(y.visible,y.visibilityFree,this.visibleSpace,void 0,y._occurrence)){if(this.renderIteration>0)continue;if(i._viewpoint){var M=(new e.Matrix4).multiplyMatrices(y.matrixWorld,y.scaleCSS),P=ui(M),C=y.element;C.style.WebkitTransform=P,C.style.MozTransform=P,C.style.oTransform=P,C.style.transform=P,C.style.pointerEvents="auto",C.style.display="block",C.parentNode!==s&&s.appendChild(C)}}}if(u)for(u.sort(function(e,t){var i=null!==e.alwaysOnTopIndex,r=null!==t.alwaysOnTopIndex;if(i||r){if(!i)return-1;if(!r)return 1;if(e.alwaysOnTopIndex!==t.alwaysOnTopIndex)return e.alwaysOnTopIndex-t.alwaysOnTopIndex}return t.z-e.z}),o=0;o<u.length;o++)u[o].domElement.style.zIndex=20+o};var Ni=function(t,i){t._modelViewMatrix&&t._modelViewMatrix._multiplyMatricesMV(i.matrixWorldInverse,t.matrixWorld),t.isUniformlyScaled||(t._normalMatrix.getInverse((new e.Matrix4).multiplyMatrices(i.matrixWorldInverse,t.matrixWorld)),t._normalMatrix.transpose()),t.modelViewInvMatrix&&t.modelViewInvMatrix.multiplyMatricesAndInverse(i.matrixWorldInverse,t.matrixWorld),t.modelViewInvTranspMatrix&&t.modelViewInvTranspMatrix.multiplyMatricesAndInverse(i.matrixWorldInverse,t.matrixWorld).transpose()},Fi=function(e,t){Ni(e,t),e._matrixWorldForDoubleGPU._fromMatrix4WithLowPartTranslation(e.matrixWorld)};function Vi(t,i,r,n){if(t.length)for(var a=0,s=t.length;a<s;a++)Ce._currentProgram=null,rt=null,Ce._oldBlending=-1,ft=-1,gt=-1,vt=-1,lt=-1,ct=-1,et=-1,tt=-1,it=-1,Je=-1,$e=-1,nt=null,Lt=!0,t[a].render(i,r,e.glStates.currentWidth,e.glStates.currentHeight,n),Ce._currentProgram=null,rt=null,Ce._oldBlending=-1,ft=-1,gt=-1,vt=-1,lt=-1,ct=-1,et=-1,tt=-1,it=-1,Je=-1,$e=-1,nt=null,Lt=!0}function Ui(e,t,i,r){Ze.initObject(e.object);var n=r(e,t,i);n&&Ze.__glResources__.geometry.push(n)}function Bi(t,i){var r,n,a,s=t.geometry;if(s)if(1===s._type);else if(2===s._type||s.length>=0);else if(t instanceof e.Mesh){for(var o=0,l=s.geometryGroupsList.length;o<l;o++)r=s.geometryGroupsList[o],a=i||Pi(t,r),s.buffersNeedUpdate&&Mi(r,t),n=a.attributes&&ki(a),(s.verticesNeedUpdate||s.morphTargetsNeedUpdate||s.elementsNeedUpdate||s.uvsNeedUpdate||s.normalsNeedUpdate||s.colorsNeedUpdate||s.tangentsNeedUpdate||n)&&Ei(r,t,Ce.DYNAMIC_DRAW,!s.dynamic,a);s.verticesNeedUpdate=!1,s.morphTargetsNeedUpdate=!1,s.elementsNeedUpdate=!1,s.uvsNeedUpdate=!1,s.normalsNeedUpdate=!1,s.colorsNeedUpdate=!1,s.tangentsNeedUpdate=!1,s.buffersNeedUpdate=!1,a.attributes&&Gi(a)}else t instanceof e.Line?(n=(a=Pi(t,s)).attributes&&ki(a),(s.verticesNeedUpdate||s.colorsNeedUpdate||s.lineDistancesNeedUpdate||n)&&function(e,t){var i,r,n,a,s,o,l=e.vertices,c=e.colors,h=e.lineDistances,u=l.length,d=c.length,p=h.length,f=e.__vertexArray,m=e.__colorArray,g=e.__lineDistanceArray,v=e.verticesNeedUpdate,S=e.colorsNeedUpdate,_=e.lineDistancesNeedUpdate;if(e.__webglCustomAttributesList,v){for(i=0;i<u;i++)a=l[i],f[s=3*i]=a.x,f[s+1]=a.y,f[s+2]=a.z;Ce.bindBuffer(Ce.ARRAY_BUFFER,e.__webglVertexBuffer),Ce.bufferData(Ce.ARRAY_BUFFER,f,t)}if(S){for(r=0;r<d;r++)o=c[r],m[s=3*r]=o.r,m[s+1]=o.g,m[s+2]=o.b;Ce.bindBuffer(Ce.ARRAY_BUFFER,e.__webglColorBuffer),Ce.bufferData(Ce.ARRAY_BUFFER,m,t)}if(_){for(n=0;n<p;n++)g[n]=h[n];Ce.bindBuffer(Ce.ARRAY_BUFFER,e.__webglLineDistanceBuffer),Ce.bufferData(Ce.ARRAY_BUFFER,g,t)}}(s,Ce.DYNAMIC_DRAW),s.verticesNeedUpdate=!1,s.colorsNeedUpdate=!1,s.lineDistancesNeedUpdate=!1,a.attributes&&Gi(a)):t instanceof e.ParticleSystem&&(n=(a=Pi(t,s)).attributes&&ki(a),(s.verticesNeedUpdate||s.colorsNeedUpdate||t.sortParticles||n)&&wi(s,Ce.DYNAMIC_DRAW,t),s.verticesNeedUpdate=!1,s.colorsNeedUpdate=!1,a.attributes&&Gi(a))}function ki(e){for(var t in e.attributes)if(e.attributes[t].needsUpdate)return!0;return!1}function Gi(e){for(var t in e.attributes)e.attributes[t].needsUpdate=!1}function zi(t,i,r,n,a,s,o,l,c,h){at=0;var u=Ce.contextId,p=Ze.id,f=Ze.currentRendererMode,m=r.programManager;if(f===m.currentRendererMode&&p===m.currentRendererId&&u===m.currentContextId||m.setActive(u,p,f),!r.needsUpdate){var g=r.program;r.program=m.getProgram(o,Ze.shaderVersions[Ze.currentRendererMode],yi),null===r.program&&Ze.initMaterial(r,i,n,s,o,l,h),g!==r.program&&r._notifyDLtoBeSortedNextFrame()}d&&r.lights&&r.program&&(r.program._lightsKey!==Ot||r.program._ambianceKey!==Nt)&&r.program._materialToUse===h&&(m.disposeCurrentProgram(yi,o),Ze.initMaterial(r,i,n,s,o,l,h)),r.needsUpdate&&(m.disposeAllPrograms(yi),Ze.initMaterial(r,i,n,s,o,l,h),r.needsUpdate=!1);var v=r._PDSFXData&&r._PDSFXData.PDSFX,S=!1,_=!1,y=r.program,x=y.uniformLocations,M=r.uniforms,P=y.program,C=a?a.id:-1;r.id===Je&&C===$e||(Pe.swapMaterials++,Je=r.id,$e=C,S=!0),P!==Ce._currentProgram&&(Pe.swapPrograms++,Ce.useProgram(P),Ce._currentProgram=P,tt=null,it=null,_=!0,S=!0),Qe===Ft&&t===rt||(Pe.swapScenes++,_=!0),nt=null;var b=y.objectUniformLocations;if(Ze[b.funcName](b,n,s,r,t,i,l),_&&(1===e.WebGLVersion&&(Ce.uniformMatrix4fv(x.projectionMatrix,!1,Ze.float32Matrix4x4Temp.setDoubles(t.projectionMatrix.elements)),x.viewMatrix&&Ce.uniformMatrix4fv(x.viewMatrix,!1,Ze.float32Matrix4x4Temp.setDoubles(t.matrixWorldInverse.elements)),x.cameraPosition&&(Rt.getPositionFromMatrix(t.matrixWorld),Ce.uniform3f(x.cameraPosition,Rt.x,Rt.y,Rt.z),Ce.uniform3f(x.lowPartCameraPosition,e.SplitFloat32(Rt.x).low,e.SplitFloat32(Rt.y).low,e.SplitFloat32(Rt.z).low))),v&&(x.projectionInvMatrix&&Ce.uniformMatrix4fv(x.projectionInvMatrix,!1,Ze.float32Matrix4x4Temp.setDoubles(t.projectionMatrixInverse.elements)),x.viewInvMatrix&&Ce.uniformMatrix4fv(x.viewInvMatrix,!1,Ze.float32Matrix4x4Temp.setDoubles(t.matrixWorld.elements)),x.viewInvTranspMatrix&&(Ce.uniformMatrix4fv(x.viewInvTranspMatrix,!1,Ze.float32Matrix4x4Temp.setDoubles(t.matrixWorld.transpose().elements)),t.matrixWorld.transpose()),x.nearFarLogFactor&&Ce.uniform3f(x.nearFarLogFactor,t.near,t.far,1/Math.log(t.far/t.near)),x.viewportSize&&Ce.uniform2f(x.viewportSize,bt,Dt)),t!==rt&&(rt=t),Qe=Ft),S){if(r.refreshUniforms(Ze,n,a),r.physical&&(M.renderIteration.value=Ze.renderIteration,Ze.refreshUniformsPhysicalDSRoughnessMaps(M,r,.2)),r.loadUniforms?r.loadUniforms(Ze,Ce,y.uniformLocations,a,c,l):Xi(x,r.uniformsList),v&&r._PDSFXData._pdsfxUniformsList&&(r._refreshPDSFXUniforms_private(Ze,n,a),Xi(x,r._PDSFXData._pdsfxUniformsList)),D&&r.deferrable){var w=r.uniforms;x.iHighlightColor?(Ce.uniform4f(x.iHighlightColor,w.iHighlightColor.value.x,w.iHighlightColor.value.y,w.iHighlightColor.value.z,1),Ce.uniform2f(x.iHighlightIntensity,w.iHighlightIntensity.value.x,w.iHighlightIntensity.value.y)):x.iHighlightLineicColor?(Ce.uniform4f(x.iHighlightLineicColor,w.iHighlightLineicColor.value.x,w.iHighlightLineicColor.value.y,w.iHighlightLineicColor.value.z,1),Ce.uniform2f(x.iHighlightIntensity,w.iHighlightIntensity.value.x,w.iHighlightIntensity.value.y)):Ce.uniform1f(x.highlightID,w.highlightID.value),x.rgbaDepth&&Ze.loadTexture(Ce,x.rgbaDepth,Ze.politeDepthBuffer)}if(_){if(x.viewInfo&&(Ce.uniform2f(x.viewInfo,t.near,t.far),Ze.loadTexture(Ce,x.currentNormalStencilDepth,ye.currentNormalStencilDepthBuffer),Ze.loadTexture(Ce,x.currentTexCoord,ye.currentTexCoordBuffer),x.currentRGBADepth&&Ze.loadTexture(Ce,x.currentRGBADepth,ye.currentRGBADepthBuffer)),x.cameraConstant&&Ce.uniform1f(x.cameraConstant,t.fixedSizeCameraConstant),x.billCameraPos||x.billCameraLookAt){Ce.uniform3f(x.billCameraPos,t.position.x,t.position.y,t.position.z);var E=t.getLookAt();Ce.uniform3f(x.billCameraLookAt,E.x,E.y,E.z),Ce.uniform3f(x.billCameraUp,t.up.x,t.up.y,t.up.z),Ce.uniformMatrix4fv(x.invViewMatrix,!1,Ze.float32Matrix4x4Temp.setDoubles(t.matrixWorld.elements)),Ce.uniformMatrix4fv(x.invProjectionMatrix,!1,Ze.float32Matrix4x4Temp.setDoubles(t.projectionMatrixInverse.elements))}r.lights&&d&&(Lt&&(!function(e,t){var i,r,n={ambient:{r:0,g:0,b:0},directional:{dirCount:0,dirLength:0,dirColors:Vt.directional.colors,dirColorsPhong:Vt.directional.colorsPhong,dirPositions:Vt.directional.positions,dirColorsNoIntensity:Vt.directional.colorsNoIntensity},directionalIBL:{dirIBLCount:0,dirIBLLength:0,dirIBLColors:Vt.directionalIBL.colors,dirIBLPositions:Vt.directionalIBL.positions},directionalPhong:{dirPhongCount:0,dirPhongLength:0,dirPhongColors:Vt.directionalPhong.colors,dirPhongPositions:Vt.directionalPhong.positions},point:{pointCount:0,pointLength:0,pointColors:Vt.point.colors,pointColorsPhong:Vt.point.colorsPhong,pointPositions:Vt.point.positions,pointPhysicalAttenuations:Vt.point.physicalAttenuations,pointDistances:Vt.point.distances,pointColorsNoIntensity:Vt.point.colorsNoIntensity},spot:{spotCount:0,spotLength:0,spotColors:Vt.spot.colors,spotColorsPhong:Vt.spot.colorsPhong,spotPositions:Vt.spot.positions,spotPhysicalAttenuations:Vt.spot.physicalAttenuations,spotDistances:Vt.spot.distances,spotDirections:Vt.spot.directions,spotAnglesCos:Vt.spot.anglesCos,spotInnerAnglesCos:Vt.spot.innerAnglesCos,spotColorsNoIntensity:Vt.spot.colorsNoIntensity},ies:{iesCount:0,iesLength:0,iesColors:Vt.ies.colors,iesPositions:Vt.ies.positions,iesDistances:Vt.ies.distances,iesLightTexture:Vt.ies.iesLightTexture,matrixWorldInv:Vt.ies.matrixWorldInv},area:{areaCount:0,areaLength:0,areaColors:Vt.area.colors,areaPositions:Vt.area.positions,areaNormals:Vt.area.normals,areaUps:Vt.area.ups,areaData:Vt.area.data},sphere:{sphereCount:0,sphereLength:0,sphereColors:Vt.sphere.colors,spherePositions:Vt.sphere.positions,sphereData:Vt.sphere.data},disk:{diskCount:0,diskLength:0,diskColors:Vt.disk.colors,diskNormals:Vt.disk.normals,diskUps:Vt.disk.ups,diskPositions:Vt.disk.positions,diskData:Vt.disk.data},tube:{tubeCount:0,tubeLength:0,tubeColors:Vt.tube.colors,tubeRights:Vt.tube.rights,tubePositions:Vt.tube.positions,tubeData:Vt.tube.data},camera:t};for(i=0,r=e.length;i<r;i++){var a=e[i];a.onlyShadow||a.setup(n,qi,Zi,Ze)}var s=function(e,t){for(i=3*n[e][t+"Length"],r=Math.max(n[e][t+"Colors"].length,3*n[e][t+"Count"]);i<r;i++)n[e][t+"Colors"][i]=0;Vt[e].length=n[e][t+"Length"]};s("directional","dir"),s("directionalIBL","dirIBL"),s("directionalPhong","dirPhong"),s("point","point"),s("spot","spot"),s("ies","ies"),s("area","area"),s("disk","disk"),s("sphere","sphere"),s("tube","tube"),Vt.ambient[0]=n.ambient.r,Vt.ambient[1]=n.ambient.g,Vt.ambient[2]=n.ambient.b}(i,t),Lt=!1),Ze.loadUniformsLights(Ce,y.uniformLocations,Vt,y,r._usePhongLighting)),n.receiveShadow&&Ze.loadUniformsShadow(Ce,y,i,Vt,r),Ze.loadUniformsPostProcess(Ce,y)}}return(_||y._clipPlanesVersion!==Ze._clipPlanesState.version)&&(r.enableClipPlanes&&Ze.loadClippingUniforms(Ce,y.uniformLocations),y._clipPlanesVersion=Ze._clipPlanesState.version),st=o,y}function Hi(e,t,i,r,n){if(e.nbClipPlanes){e.nbClipPlanes.value=t.length,e.clipPlaneEquations.value=t.eqs,e.clipPlaneActive.value=t.states.slice(0);var a=r&&r.getClippingSettings();!a||n?(e.clipFrontOpacity.value=1,e.clipBackOpacity.value=0):(e.clipFrontOpacity.value=a.frontOpacity<.5?0:1,e.clipBackOpacity.value=a.backOpacity<.5?0:1),i&&(e.clipPlaneActive.value[i-1]=0)}}function Wi(e,t,i,r,n){if(e.scissorPoints){t&&t.updateTexture(i,r),e.scissorPoints.value=t?t.texture:null;var a,s=t?t.getNbVertices():[];for(a=s.length;a<n;a++)s.push(0);e.scissorSize.value=s.length>0?s:[0]}}function ji(){var e=at;return e>=zt&&console.warn("WebGLRenderer: trying to use "+e+" texture units while this GPU supports only "+zt),at+=1,e}function Xi(t,i){var r,n,a,s,o;i.forEach(function(i,l,c){var h=i,u=t[l];if(u){var d=h.type;i=h.value;switch(d){case"b":case"i":Ce.uniform1i(u,i);break;case"f":Ce.uniform1f(u,i);break;case"v2":Ce.uniform2f(u,i.x,i.y);break;case"v3":Ce.uniform3f(u,i.x,i.y,i.z);break;case"v4":Ce.uniform4f(u,i.x,i.y,i.z,i.w);break;case"c":Ce.uniform3f(u,i.r,i.g,i.b);break;case"iv1":i.length>0&&Ce.uniform1iv(u,i);break;case"iv":i.length>0&&Ce.uniform3iv(u,i);break;case"fv1":i.length>0&&Ce.uniform1fv(u,i);break;case"fv2":i.length>0&&Ce.uniform2fv(u,i);break;case"fv3":case"fv":i.length>0&&Ce.uniform3fv(u,i);break;case"fv4":i.length>0&&Ce.uniform4fv(u,i);break;case"v2v":for(void 0===h._array&&(h._array=new Float32Array(2*i.length)),s=0,o=i.length;s<o;s++)a=2*s,h._array[a]=i[s].x,h._array[a+1]=i[s].y;Ce.uniform2fv(u,h._array);break;case"v3v":for(void 0===h._array&&(h._array=new Float32Array(3*i.length)),s=0,o=i.length;s<o;s++)a=3*s,h._array[a]=i[s].x,h._array[a+1]=i[s].y,h._array[a+2]=i[s].z;Ce.uniform3fv(u,h._array);break;case"v4v":for(void 0===h._array&&(h._array=new Float32Array(4*i.length)),s=0,o=i.length;s<o;s++)a=4*s,h._array[a]=i[s].x,h._array[a+1]=i[s].y,h._array[a+2]=i[s].z,h._array[a+3]=i[s].w;Ce.uniform4fv(u,h._array);break;case"m3":i&&Ze.loadMatrix3(Ce,u,i);break;case"m4":i&&Ze.loadMatrix4(Ce,u,i);break;case"m4v":for(void 0===h._array&&(h._array=new Float32Array(16*i.length)),s=0,o=i.length;s<o;s++)i[s]&&i[s].flattenToArrayOffset(h._array,16*s);Ce.uniformMatrix4fv(u,!1,h._array);break;case"t":case"t2":case"tc":r=i,n=ji(),Ce.uniform1i(u,n),r||(r=Ze._dummyTexture),r instanceof e.WebGLRenderTargetCube?er(r,n):Ze.setTexture(r,n);break;case"tv":case"t2v":case"tcv":for(void 0===h._array&&(h._array=[]),s=0,o=h.value.length;s<o;s++)h._array[s]=ji();for(Ce.uniform1iv(u,h._array),s=0,o=h.value.length;s<o;s++)r=h.value[s],n=h._array[s],r||(r=Ze._dummyTexture),Ze.setTexture(r,n)}}})}function qi(e,t,i,r,n,a){var s=N.copyToLinear(i,n);e[t]=s.r*r,e[t+1]=s.g*r,e[t+2]=s.b*r,a&&(a[t]=s.r,a[t+1]=s.g,a[t+2]=s.b)}function Zi(e,t,i,r,n){e[t]=i.r*r,e[t+1]=i.g*r,e[t+2]=i.b*r,n&&(n[t]=i.r,n[t+1]=i.g,n[t+2]=i.b)}function Yi(e){null!=e&&e!==Mt&&(Ce.lineWidth(e),Mt=e)}function Ki(e,t){var i="";if(t){i+="float getExposureFromIndexCube(int index) {\n",i+="\tfloat result;\n";for(r=0;r<e.maxShadowsCube;r++)i+="\tif(index == "+r+"){\n",i+="\t\tresult = getExposure(shadowPointPosition["+r+"],shadowMapCube["+r+"],shadowBiasCube["+r+"],shadowMapSizeCube["+r+"],shadowNearCube["+r+"],shadowFarCube["+r+"]);\n",i+="\t}\n";i+="\treturn result;\n",i+="}\n"}else{i+="float getExposureFromIndex(int index) {\n",i+="\tfloat result;\n";for(var r=0;r<e.maxShadows;r++)i+="\tif(index == "+r+"){\n",i+="\t\tresult = getExposure(vShadowCoord["+r+"],shadowMap["+r+"],shadowBias["+r+"],shadowMapSize["+r+"]);\n",i+="\t}\n";i+="\treturn result;\n",i+="}\n"}if(i+="#ifdef USE_TRANSPARENTSHADOWMAP \n",t){i+="vec4 getTransparentExposureFromIndexCube(int index) {\n",i+="\tvec4 result;\n";for(r=0;r<e.maxShadowsCube;r++)i+="\tif(index == "+r+"){\n",i+="\t\tvec4 lPosition =  vec4( shadowPointPosition["+r+"], 1.0 );\n",i+="\t\tvec3 pointVector = normalize(vWorldPosition.xyz-lPosition.xyz);\n",i+="\t\tresult = textureCube(transparentShadowMapCube["+r+"], pointVector);\n",i+="\t}\n";i+="\treturn result;\n",i+="}\n"}else{i+="vec4 getTransparentExposureFromIndex(int index) {\n",i+="\tvec4 result;\n";for(var r=0;r<e.maxShadows;r++)i+="\tif(index == "+r+"){\n",i+="\t\tvec3 shadowCoord = vShadowCoord["+r+"].xyz / vShadowCoord["+r+"].w;\n",i+="\t\tfloat isNotbehindFrustum = step(0.0,vShadowCoord["+r+"].w);\n",i+="\t\tresult = isNotbehindFrustum * texture2D(transparentShadowMap["+r+"], shadowCoord.xy) + (1.0-isNotbehindFrustum) * vec4(1.0);\n",i+="\t}\n";i+="\treturn result;\n",i+="}\n"}return i+="#endif \n"}function Ji(e){for(var t=e.split("\n"),i=0,r=t.length;i<r;i++)t[i]=i+1+": "+t[i];return t.join("\n")}function Qi(e){return 0==(e&e-1)}function $i(t,i,r){r?(Ce.texParameteri(t,Ce.TEXTURE_WRAP_S,nr(i.wrapS)),Ce.texParameteri(t,Ce.TEXTURE_WRAP_T,nr(i.wrapT)),Ce.texParameteri(t,Ce.TEXTURE_MAG_FILTER,nr(i.magFilter)),Ce.texParameteri(t,Ce.TEXTURE_MIN_FILTER,nr(i.minFilter))):(i.wrapS===e.ClampToEdgeWrapping&&i.wrapT===e.ClampToEdgeWrapping||i.wrapS===e._ClampToBorderWrapping&&i.wrapT===e._ClampToBorderWrapping||console.warn("Non power of two textures must be clamp to edge, falling back on it"),Ce.texParameteri(t,Ce.TEXTURE_WRAP_S,Ce.CLAMP_TO_EDGE),Ce.texParameteri(t,Ce.TEXTURE_WRAP_T,Ce.CLAMP_TO_EDGE),Ce.texParameteri(t,Ce.TEXTURE_MAG_FILTER,rr(i.magFilter)),Ce.texParameteri(t,Ce.TEXTURE_MIN_FILTER,rr(i.minFilter))),Oe&&i.type!==e.FloatType&&(i.anisotropy>1||i.__oldAnisotropy)&&(Ce.texParameterf(t,Oe.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i.anisotropy,Xt)),i.__oldAnisotropy=i.anisotropy)}function er(e,t){e.onRequest&&e.onRequest(),Ce.activeTexture(Ce.TEXTURE0+t),Ce.bindTexture(Ce.TEXTURE_CUBE_MAP,e.__webglTexture)}function tr(e,t,i){Ce.bindFramebuffer(Ce.FRAMEBUFFER,e),t&&Ce.framebufferTexture2D(Ce.FRAMEBUFFER,Ce.COLOR_ATTACHMENT0,i,t.__webglTexture,0)}function ir(e,t){Ce.bindRenderbuffer(Ce.RENDERBUFFER,e),t.depthBuffer&&!t.stencilBuffer?(Ce.renderbufferStorage(Ce.RENDERBUFFER,Ce.DEPTH_COMPONENT16,t.width,t.height),Ce.framebufferRenderbuffer(Ce.FRAMEBUFFER,Ce.DEPTH_ATTACHMENT,Ce.RENDERBUFFER,e)):t.depthBuffer&&t.stencilBuffer?(Ce.renderbufferStorage(Ce.RENDERBUFFER,Ce.DEPTH_STENCIL,t.width,t.height),Ce.framebufferRenderbuffer(Ce.FRAMEBUFFER,Ce.DEPTH_STENCIL_ATTACHMENT,Ce.RENDERBUFFER,e)):Ce.renderbufferStorage(Ce.RENDERBUFFER,Ce.RGBA4,t.width,t.height)}function rr(t){return t===e.NearestFilter||t===e.NearestMipMapNearestFilter||t===e.NearestMipMapLinearFilter?Ce.NEAREST:Ce.LINEAR}function nr(t){if(t===e.RepeatWrapping)return Ce.REPEAT;if(t===e.ClampToEdgeWrapping)return Ce.CLAMP_TO_EDGE;if(t===e._ClampToBorderWrapping)return Ce.CLAMP_TO_EDGE;if(t===e.MirroredRepeatWrapping)return Ce.MIRRORED_REPEAT;if(t===e.NearestFilter)return Ce.NEAREST;if(t===e.NearestMipMapNearestFilter)return Ce.NEAREST_MIPMAP_NEAREST;if(t===e.NearestMipMapLinearFilter)return Ce.NEAREST_MIPMAP_LINEAR;if(t===e.LinearFilter)return Ce.LINEAR;if(t===e.LinearMipMapNearestFilter)return Ce.LINEAR_MIPMAP_NEAREST;if(t===e.LinearMipMapLinearFilter)return Ce.LINEAR_MIPMAP_LINEAR;if(t===e.UnsignedByteType)return Ce.UNSIGNED_BYTE;if(t===e.UnsignedShort4444Type)return Ce.UNSIGNED_SHORT_4_4_4_4;if(t===e.UnsignedShort5551Type)return Ce.UNSIGNED_SHORT_5_5_5_1;if(t===e.UnsignedShort565Type)return Ce.UNSIGNED_SHORT_5_6_5;if(t===e.ByteType)return Ce.BYTE;if(t===e.ShortType)return Ce.SHORT;if(t===e.UnsignedShortType)return Ce.UNSIGNED_SHORT;if(t===e.IntType)return Ce.INT;if(t===e.UnsignedIntType)return Ce.UNSIGNED_INT;if(t===e.FloatType)return Ce.FLOAT;if(t===e.HalfFloatType){if(Ce.HALF_FLOAT)return Ce.HALF_FLOAT;if(De)return De.HALF_FLOAT_OES}if(t===e.AlphaFormat)return Ce.ALPHA;if(t===e.RGBFormat)return Ce.RGB;if(t===e.RGBAFormat)return Ce.RGBA;if(t===e.LuminanceFormat)return 2===e.WebGLVersion?Ce.RED:Ce.LUMINANCE;if(t===e.LuminanceAlphaFormat)return Ce.LUMINANCE_ALPHA;if(t===e.AddEquation)return Ce.FUNC_ADD;if(t===e.SubtractEquation)return Ce.FUNC_SUBTRACT;if(t===e.ReverseSubtractEquation)return Ce.FUNC_REVERSE_SUBTRACT;if(t===e.ZeroFactor)return Ce.ZERO;if(t===e.OneFactor)return Ce.ONE;if(t===e.SrcColorFactor)return Ce.SRC_COLOR;if(t===e.OneMinusSrcColorFactor)return Ce.ONE_MINUS_SRC_COLOR;if(t===e.SrcAlphaFactor)return Ce.SRC_ALPHA;if(t===e.OneMinusSrcAlphaFactor)return Ce.ONE_MINUS_SRC_ALPHA;if(t===e.DstAlphaFactor)return Ce.DST_ALPHA;if(t===e.OneMinusDstAlphaFactor)return Ce.ONE_MINUS_DST_ALPHA;if(t===e.DstColorFactor)return Ce.DST_COLOR;if(t===e.OneMinusDstColorFactor)return Ce.ONE_MINUS_DST_COLOR;if(t===e.SrcAlphaSaturateFactor)return Ce.SRC_ALPHA_SATURATE;if(Ne){if(t===e.RGB_S3TC_DXT1_Format)return Ne.COMPRESSED_RGB_S3TC_DXT1_EXT;if(t===e.RGBA_S3TC_DXT1_Format)return Ne.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(t===e.RGBA_S3TC_DXT3_Format)return Ne.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(t===e.RGBA_S3TC_DXT5_Format)return Ne.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(void 0!==Fe){if(t===e.RED_RGTC1_Format)return Fe.COMPRESSED_RED_RGTC1_EXT;if(t===e.RED_RGTC1_S_Format)return Fe.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(t===e.REDGREEN_RGTC2_Format)return Fe.COMPRESSED_RED_GREEN_RGTC2_EXT;if(t===e.REDGREEN_RGTC2_S_Format)return Fe.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}if(void 0!==Ve){if(t===e.RGBA_BPTC_UNORM_Format)return Ve.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(t===e.SRGB_ALPHA_BPTC_UNORM_Format)return Ve.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;if(t===e.RGB_BPTC_SIGNED_FLOAT_Format)return Ve.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(t===e.RGB_BPTC_UNSIGNED_FLOAT_Format)return Ve.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(void 0!==Ue&&t===e.RGBA_ASTC_4x4_Format)return Ue.COMPRESSED_RGBA_ASTC_4x4_KHR;if(void 0!==Be&&t===e.RGB_ETC1_Format)return Be.COMPRESSED_RGB_ETC1_WEBGL;if(void 0!==ke&&t===e.RGBA8_ETC2_EAC_Format)return ke.COMPRESSED_RGBA8_ETC2_EAC;if(void 0!==Ge){if(t===e.RGB_PVRTC_2BPPV1_Format)return Ge.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(t===e.RGB_PVRTC_4BPPV1_Format)return Ge.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(t===e.RGBA_PVRTC_2BPPV1_Format)return Ge.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;if(t===e.RGBA_PVRTC_4BPPV1_Format)return Ge.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG}if(void 0!==qe){if(t===e.MinEquation)return qe.MIN_EXT;if(t===e.MaxEquation)return qe.MAX_EXT}return 0}function ar(t,i,r){if(2===e.WebGLVersion){switch(t){case Ce.RGBA:switch(i){case Ce.UNSIGNED_BYTE:return Ce.RGBA8;case Ce.BYTE:return Ce.RGBA8_SNORM;case Ce.HALF_FLOAT:return Ce.RGBA16F;case Ce.FLOAT:return Ce.RGBA32F}break;case Ce.RGB:switch(i){case Ce.UNSIGNED_BYTE:return Ce.RGB8;case Ce.BYTE:return Ce.RGB8_SNORM;case Ce.HALF_FLOAT:return Ce.RGB16F;case Ce.FLOAT:return r?Ce.R11F_G11F_B10F:Ce.RGB32F}break;case Ce.RED:switch(i){case Ce.UNSIGNED_BYTE:return Ce.R8;case Ce.BYTE:return Ce.R8_SNORM;case Ce.HALF_FLOAT:return Ce.R16F;case Ce.FLOAT:return Ce.R32F}break;case Ce.RG:switch(i){case Ce.UNSIGNED_BYTE:return Ce.RG8;case Ce.BYTE:return Ce.RG8_SNORM;case Ce.HALF_FLOAT:return Ce.RG16F;case Ce.FLOAT:return Ce.RG32F}}return t}return t}function sr(t,i,r){try{if(t)Ce=t;else{if(r&&(Ce=A.getContext("webgl2",{alpha:ue,premultipliedAlpha:de,antialias:fe,stencil:me,preserveDrawingBuffer:ge,powerPreference:e._webglPerformanceProfile()})),!Ce){var n={alpha:ue,premultipliedAlpha:de,antialias:fe,stencil:me,preserveDrawingBuffer:ge,powerPreference:e._webglPerformanceProfile()};Ce=A.getContext("webgl",n)||A.getContext("experimental-webgl",n),e.WebGLVersion=1}if(!Ce)throw"Error creating WebGL context."}}catch(e){console.error(e)}!t&&i&&(Ce=WebGLDebugUtils.makeDebugContext(Ce,function(e,t,i){throw window.WebVisuTestsWebGLError=!0,"##WEBGLERROR## "+WebGLDebugUtils.glEnumToString(e)+" was caused by call to: "+t})),Ce._enabledAttributes||(Ce._enabledAttributes={}),Ce.hasOwnProperty("contextId")||(re++,Ce.contextId=re),Ce._currentProgram||(Ce._currentProgram=null),Ce._oldBlending||(Ce.oldBlending=-1),e.enableWebGLStats&&(e.webGLStats={reset:function(){this.useProgram_nb=0,this.bindBuffer_nb=0,this.drawElements_nb=0},dump:function(){console.log({useProgram_nb:this.useProgram_nb,bindBuffer_nb:this.bindBuffer_nb,drawElements_nb:this.drawElements_nb})},useProgram_nb:0,bindBuffer_nb:0,drawElements_nb:0},Ce.useProgram_save=Ce.useProgram,Ce.useProgram=function(){e.webGLStats.useProgram_nb++,Ce.useProgram_save.apply(Ce,arguments)},Ce.bindBuffer_save=Ce.bindBuffer,Ce.bindBuffer=function(){e.webGLStats.bindBuffer_nb++,Ce.bindBuffer_save.apply(Ce,arguments)},Ce.drawElements_save=Ce.drawElements,Ce.drawElements=function(){e.webGLStats.drawElements_nb++,Ce.drawElements_save.apply(Ce,arguments)});var a=Ce.getSupportedExtensions();function s(e){return a.indexOf(e)>=0?Ce.getExtension(e):null}we=s("WEBGL_color_buffer_float")||s("EXT_color_buffer_float"),Ee=s("EXT_color_buffer_half_float")||s("EXT_color_buffer_float"),De=2===e.WebGLVersion||s("OES_texture_half_float"),be=2===e.WebGLVersion||s("OES_texture_float"),Te=s("OES_texture_float_linear"),s("EXT_float_blend"),Ae=s("OES_texture_half_float_linear"),Ie=s("OES_standard_derivatives"),Le=Re?Re.COMPLETION_STATUS_KHR:Ce.LINK_STATUS;var o=s("WEBGL_debug_renderer_info");if(null!==o&&(Bt.gpu=Ce.getParameter(o.UNMASKED_RENDERER_WEBGL),Bt.vendor=Ce.getParameter(o.UNMASKED_VENDOR_WEBGL)),Oe=s("EXT_texture_filter_anisotropic")||s("MOZ_EXT_texture_filter_anisotropic")||s("WEBKIT_EXT_texture_filter_anisotropic"),Ne=s("WEBGL_compressed_texture_s3tc")||s("MOZ_WEBGL_compressed_texture_s3tc")||s("WEBKIT_WEBGL_compressed_texture_s3tc"),Fe=s("EXT_texture_compression_rgtc")||s("WEBGL_compressed_texture_rgtc")||s("WEBKIT_WEBGL_compressed_texture_rgtc")||s("MOZ_WEBGL_compressed_texture_rgtc"),Ve=s("EXT_texture_compression_bptc")||s("WEBGL_compressed_texture_bptc")||s("WEBKIT_WEBGL_compressed_texture_bptc")||s("MOZ_WEBGL_compressed_texture_bptc"),Ue=s("WEBGL_compressed_texture_astc"),Be=s("WEBGL_compressed_texture_etc1"),ke=s("WEBGL_compressed_texture_etc"),Ge=s("WEBGL_compressed_texture_pvrtc")||s("WEBKIT_WEBGL_compressed_texture_pvrtc"),We=s("ANGLE_instanced_arrays"),je=s("OES_element_index_uint"),Xe=s("EXT_frag_depth"),qe=s("EXT_blend_minmax"),ze=!!we,be&&!ze){var l=2===e.WebGLVersion?Ce.RGBA32F:Ce.RGBA,c=Ce.createTexture(),h=Ce.createFramebuffer(),u=Ce.createRenderbuffer();Ce.bindTexture(Ce.TEXTURE_2D,c),Ce.texParameteri(Ce.TEXTURE_2D,Ce.TEXTURE_WRAP_S,Ce.CLAMP_TO_EDGE),Ce.texParameteri(Ce.TEXTURE_2D,Ce.TEXTURE_WRAP_T,Ce.CLAMP_TO_EDGE),Ce.texParameteri(Ce.TEXTURE_2D,Ce.TEXTURE_MAG_FILTER,Ce.LINEAR),Ce.texParameteri(Ce.TEXTURE_2D,Ce.TEXTURE_MIN_FILTER,Ce.LINEAR),Ce.texImage2D(Ce.TEXTURE_2D,0,l,100,100,0,Ce.RGBA,Ce.FLOAT,null),Ce.bindFramebuffer(Ce.FRAMEBUFFER,h),Ce.framebufferTexture2D(Ce.FRAMEBUFFER,Ce.COLOR_ATTACHMENT0,Ce.TEXTURE_2D,c,0),Ce.bindRenderbuffer(Ce.RENDERBUFFER,u),Ce.renderbufferStorage(Ce.RENDERBUFFER,Ce.DEPTH_COMPONENT16,100,100),Ce.framebufferRenderbuffer(Ce.FRAMEBUFFER,Ce.DEPTH_ATTACHMENT,Ce.RENDERBUFFER,u);var d=Ce.checkFramebufferStatus(Ce.FRAMEBUFFER);ze=!0,d!=Ce.FRAMEBUFFER_COMPLETE&&(ze=!1),Ce.bindFramebuffer(Ce.FRAMEBUFFER,null),Ce.bindTexture(Ce.TEXTURE_2D,null),Ce.bindRenderbuffer(Ce.RENDERBUFFER,null),Ce.deleteTexture(c),Ce.deleteFramebuffer(h),Ce.deleteRenderbuffer(u)}if(He=!!Ee,De&&!He){l=2===e.WebGLVersion?Ce.RGBA16F:Ce.RGBA,c=Ce.createTexture(),h=Ce.createFramebuffer(),u=Ce.createRenderbuffer();Ce.bindTexture(Ce.TEXTURE_2D,c),Ce.texParameteri(Ce.TEXTURE_2D,Ce.TEXTURE_WRAP_S,Ce.CLAMP_TO_EDGE),Ce.texParameteri(Ce.TEXTURE_2D,Ce.TEXTURE_WRAP_T,Ce.CLAMP_TO_EDGE),Ce.texParameteri(Ce.TEXTURE_2D,Ce.TEXTURE_MAG_FILTER,Ce.LINEAR),Ce.texParameteri(Ce.TEXTURE_2D,Ce.TEXTURE_MIN_FILTER,Ce.LINEAR),Ce.texImage2D(Ce.TEXTURE_2D,0,l,100,100,0,Ce.RGBA,2===e.WebGLVersion?Ce.HALF_FLOAT:De.HALF_FLOAT_OES,null),Ce.bindFramebuffer(Ce.FRAMEBUFFER,h),Ce.framebufferTexture2D(Ce.FRAMEBUFFER,Ce.COLOR_ATTACHMENT0,Ce.TEXTURE_2D,c,0),Ce.bindRenderbuffer(Ce.RENDERBUFFER,u),Ce.renderbufferStorage(Ce.RENDERBUFFER,Ce.DEPTH_COMPONENT16,100,100),Ce.framebufferRenderbuffer(Ce.FRAMEBUFFER,Ce.DEPTH_ATTACHMENT,Ce.RENDERBUFFER,u);d=Ce.checkFramebufferStatus(Ce.FRAMEBUFFER);He=!0,d!=Ce.FRAMEBUFFER_COMPLETE&&(He=!1),Ce.bindFramebuffer(Ce.FRAMEBUFFER,null),Ce.bindTexture(Ce.TEXTURE_2D,null),Ce.bindRenderbuffer(Ce.RENDERBUFFER,null),Ce.deleteTexture(c),Ce.deleteFramebuffer(h),Ce.deleteRenderbuffer(u)}e.supportedExtensions={colorBufferFloat:we,colorBufferHalfFloat:Ee,textureHalfFloat:De,textureFloat:be,textureFloatLinear:Te,textureHalfFloatLinear:Ae,standardDerivatives:Ie,textureFilterAnisotropic:Oe,compressedTexturesS3TC:Ne,compressedTexturesRGTC:Fe,compressedTexturesBPTC:Ve,compressedTexturesASTC:Ue,compressedTexturesETC1:Be,compressedTexturesETC:ke,compressedTexturesPVRTC:Ge,instancedArrays:We,elementIndexUint:je||2===e.WebGLVersion,renderToFloatTexture:ze,renderToHalfFloatTexture:He,fragDepth:Xe,minMaxBlending:qe,fragmentTextureUnits:Ce.getParameter(Ce.MAX_TEXTURE_IMAGE_UNITS),vertexTextureUnits:Ce.getParameter(Ce.MAX_VERTEX_TEXTURE_IMAGE_UNITS),depthBits:Math.pow(2,-Ce.getParameter(Ce.DEPTH_BITS))},be||e.VisualizationTraces.info("THREE.WebGLRenderer: Float textures not supported."),De||e.VisualizationTraces.info("THREE.WebGLRenderer: Half Float textures not supported."),Ie||2!==e.WebGLVersion&&e.VisualizationTraces.info("THREE.WebGLRenderer: Standard derivatives not supported."),Oe||e.VisualizationTraces.info("THREE.WebGLRenderer: Anisotropic texture filtering not supported."),Ne||e.VisualizationTraces.info("THREE.WebGLRenderer: S3TC compressed textures not supported."),Fe||e.VisualizationTraces.info("THREE.WebGLRenderer: RGTC compressed textures not supported."),Ve||e.VisualizationTraces.info("THREE.WebGLRenderer: BPTC compressed textures not supported."),Be||e.VisualizationTraces.info("THREE.WebGLRenderer: ETC1 compressed textures not supported."),ke||e.VisualizationTraces.info("THREE.WebGLRenderer: ETC compressed textures not supported."),Ue||e.VisualizationTraces.info("THREE.WebGLRenderer: ASTC compressed textures not supported."),Ge||e.VisualizationTraces.info("THREE.WebGLRenderer: PVRTC compressed textures not supported."),We?kt={vertexAttribDivisor:function(e,t){We.vertexAttribDivisorANGLE(e,t)},drawElementsInstanced:function(e,t,i,r,n){We.drawElementsInstancedANGLE(e,t,i,r,n)},_setVertexAttribDivisors:function(e,t,i){for(var r in t)"id"!==r&&i[r]>=0&&t[r].array&&(t[r].isMat4?(We.vertexAttribDivisorANGLE(i[r],e),We.vertexAttribDivisorANGLE(i[r]+1,e),We.vertexAttribDivisorANGLE(i[r]+2,e),We.vertexAttribDivisorANGLE(i[r]+3,e)):We.vertexAttribDivisorANGLE(i[r],e))}}:2===e.WebGLVersion?kt={vertexAttribDivisor:function(e,t){Ce.vertexAttribDivisor(e,t)},drawElementsInstanced:function(e,t,i,r,n){Ce.drawElementsInstanced(e,t,i,r,n)},_setVertexAttribDivisors:function(e,t,i){for(var r in t)"id"!==r&&i[r]>=0&&t[r].array&&(t[r].isMat4?(Ce.vertexAttribDivisor(i[r],e),Ce.vertexAttribDivisor(i[r]+1,e),Ce.vertexAttribDivisor(i[r]+2,e),Ce.vertexAttribDivisor(i[r]+3,e)):Ce.vertexAttribDivisor(i[r],e))}}:e.VisualizationTraces.info("THREE.WebGLRenderer: angle instanced arrays not supported."),je||2!==e.WebGLVersion&&e.VisualizationTraces.info("THREE.WebGLRenderer: UInt Element Index not supported."),Xe||2!==e.WebGLVersion&&e.VisualizationTraces.info("THREE.WebGLRenderer: Fragment Depth Writing not supported."),qe||e.VisualizationTraces.info("THREE.WebGLRenderer: min/max blending not supported."),void 0===Ce.getShaderPrecisionFormat&&(Ce.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}});const p={float16:2===e.WebGLVersion?Ce.HALF_FLOAT:void 0,float32:Ce.FLOAT,sint8:Ce.BYTE,sint16:Ce.SHORT,sint32:2===e.WebGLVersion?Ce.INT:void 0,uint8:Ce.UNSIGNED_BYTE,uint16:Ce.UNSIGNED_SHORT,uint32:2===e.WebGLVersion?Ce.UNSIGNED_INT:void 0};for(let e in P.VertexAttribute)P.VertexAttribute[e].native=p[P.VertexAttribute[e].base]}this.tokens=[],this.render=function(t,r,n,a,s,o,l,c){if(Pe||(Pe=new I.RenderInfo),u=this.materialToUse===X.originalMaterial,d=this.materialToUse===X.originalMaterial||this.materialToUse===X.oitAccumMaterial||this.materialToUse===X.oitRevealMaterial,f=this.materialToUse===X.depthMaterial,this.materialToUse===X.depthRGBAMaterial,m=this.materialToUse===X.normalDepthIoRRoughnessMaterial,g=m||this.materialToUse===X.normalDepthMaterial,v=this.materialToUse===X.normalMaterial,S=this.materialToUse===X.ZOnlyMaterial,b=this.materialToUse===X.shadowMapDepthMaterial,x=u||S,M=this.materialToUse===X.pickingMaterial||this.materialToUse===X.pickingMaterialInstancing,D=this.materialToUse===X.highlightMaterial,C=M||v||f,w=this.materialToUse===X.oitAccumMaterial||this.materialToUse===X.oitRevealMaterial,p=C||D,E=this.materialToUse===X.transparentShadowMaterial,_=!!this.currentPass&&("ZOnly"===this.currentPass.idString||"background"===this.currentPass.idString),y=!!this.currentPass&&"dialogPass"===this.currentPass.name,this._clipPlanesState.update(null,null,!0,null,r),_e=n,et=null,r instanceof e.Camera!=!1){var h=t.__lights;h.sort(t._lightSort),Je=-1,$e=-1,nt=null,Lt=!0;var P=t.computeLightsKey();Ot=P.key,Ft=t;var T=e._mobileDevice,A=e._mobileHighlight;this.autoUpdateScene&&t.updateMatrixWorld(),this.cuttingScene&&this.cuttingScene.updateMatrixWorld(),void 0===r.parent&&r.updateMatrixWorld(),r.matrixWorldInverse.getInverse(r.matrixWorld),r.orientation||(r.orientation=r.matrixWorld.determinant()>0?1:-1),At.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),Tt.setFromMatrix(At);var R=r.getCameraConstant(this.devicePixelRatio,e.glStates.currentHeight);r.fullWidth?(R*=r.height/r.fullHeight,r.useRealSize?r.useRealSize&&r.visualizedHeight&&(r.fixedSizeCameraConstant=r.getCameraConstant(this.devicePixelRatio,r.fullHeight)):r.fixedSizeCameraConstant=R):r.fixedSizeCameraConstant=R,r.pixelCullingCst=r.pixelCulling*R,r._cstLOD=R,this.autoUpdateObjects&&this.initWebGLObjects(t),this.cuttingScene&&this.initWebGLObjects(this.cuttingScene),this.enableRenderPluginsPre&&Vi(this.renderPluginsPre,t,r),this.setRenderTarget(n),(this.autoClear||a)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),this.setStencilWrite(this.enableStencilWrite);var L=this.currentPass?this.currentPass.idString:null;"main"===t.defaultRenderList||"main"!==L&&L||(L=t.defaultRenderList);var O=this.resetGSSOCacheFrame>o._resetGSSOCacheIndex,N=this.currentPass.composer?this.currentPass.composer.composerContext:null,F=N?N.id:"mtU_"+this.materialToUse,U=r._renderingRole===e._CameraRoles.NONE?r.id+"id":r._renderingRole,k=this._currentFrameType+"_rr"+U;this.currentPass.hideSurfacesAndUnclipedMeshes&&(k+="_h");var z=J.get(t,k);z.lastComposerContextsSeen.has(F)||(z.objectManagers[L]=null,O=!0),z.currComposerContextsSeen.add(F),z.isSet(L)||z.setFromIdString(L,this.currentFrameIndex);var H,W=(H=z.getWebGLObjects(L,this.currentFrameIndex)).length,j=this.currentFrameIndex;if(W>0&&l){o._resetGSSOCacheIndex=this.resetGSSOCacheFrame,window.webVisuPerfo.startPerfo("cull");var q=z.objectManagers[L],Z=j>q.frame;q.frame=j;for(var Q=Y._INVISIBLE,$=Y._VISIBLE,ee=(Y._FRESH,K._GSSO),te=K._REMOVE_AND_GSSO,ie=K._REMOVE,re=K._NOTHING,ne=K._SKIP,ae=t.__webglObjectsToDraw,se=0,ce=0,he=null,ue=!1,de=this.visibleSpace,pe=0,fe=0;fe<W;fe++)if(null!==(he=H[fe])){var me,ge=(me=he.webglObject).object;if(Z){var ve=he.previousCullingStatus;he.action=re,V(ge.visible,ge.visibilityFree,de,ge.layer)&&(!me.frustumCulled||++pe&&me._performCulling(r,Tt,ge,he))?(he.previousCullingStatus=$,he.invalidated||O?(he.invalidated=!1,he.action=te,ge._gsso_cache=null):ve!==$&&(he.action=ee)):(he.previousCullingStatus=Q,ce++,he.invalidated||O?(he.invalidated=!1,he.action=ie,ge._gsso_cache=null):he.action=ve!==Q?ie:ne)}switch(ge.renderPointsOnly=he.currentRenderPointsOnly,he.action){case re:break;case ne:continue;case ee:ae[se++]=me;break;case te:ue=!0,ge._removeFromStateSortingResult(o.id),ae[se++]=me;break;case ie:ue=!0,ge._removeFromStateSortingResult(o.id);continue}he.previousCullingStatus===$&&(ge.beforeRenderCB&&!C&&ge.beforeRenderCB(ge,{viewpoint:r._viewpoint,camera:r}),Ni(ge,r))}Pe.culledMeshes+=ce,Pe.cullingCalls+=pe,window.webVisuPerfo.endPerfo("cull"),window.webVisuPerfo.startPerfo("sort"),window.webVisuPerfo.endPerfo("sort");var Se=!t.isBackground;if(window.webVisuPerfo.startPerfo("gsso"),se>0&&(ae.length=se,this.getStateSortedObjects(ae,o,c,r,t)),ue)for(var Me=0;Me<o._displayLists.length;Me++)o._displayLists[Me].cleanMaterialListAndDRLs();if(Se)for(Me=0;Me<o._displayLists.length;Me++){if(!(ze=o._displayLists[Me]).neverSort)if(ze.hasDecal)ze._materialList.sort(function(e,t){return e.decalSortID-t.decalSortID});else if(ze.sortByGLType)ze._materialList.sort(function(e,t){var i=e.glType;return t.glType-i});else if(!ze.mustZSort||this.currentPass.isOITPass&&ze.canOIT)ze._sortByProgramNextFrame&&(ze._sortByProgramNextFrame=!1,ze._materialList.sort(function(e,t){var i=e.material,r=t.material;return i.program&&r.program?r.program!==i.program?i.program.id-r.program.id:e.occurrenceRenderingOverrideId!==t.occurrenceRenderingOverrideId?e.occurrenceRenderingOverrideId-t.occurrenceRenderingOverrideId:i.id-r.id:r.id-i.id}));else{for(var be=0;be<ze._materialList.length;be++){var De=ze._materialList[be];(rt=ze._displayRangeLists.get(De.id)).sortDrawablesBackToFront(r)}ze._materialList.sort(function(e,t){var i=ze._displayRangeLists.get(e.id).getFirstDrawable(),r=ze._displayRangeLists.get(t.id).getFirstDrawable(),n=i?i.object.z:0,a=r?r.object.z:0;return a!==n?n-a:i&&r&&i.object.id!==r.object.id?i.object.id-r.object.id:t.material.id-e.material.id})}}else for(Me=0;Me<o._displayLists.length;Me++){(ze=o._displayLists[Me])._materialList.sort(function(e,t){var i=ze._displayRangeLists.get(e.id).getFirstDrawable(),r=ze._displayRangeLists.get(t.id).getFirstDrawable(),n=i?i.object.renderDepth:0,a=r?r.object.renderDepth:0;return a?n?a!==n?a-n:i.object.id!==r.object.id?r.object.id-i.object.id:e.material.id-t.material.id:1:-1})}window.webVisuPerfo.endPerfo("gsso")}tt=null,it=null,this.setBlending(e.NoBlending);var we=!1;o._displayLists[5].active=!s,window.webVisuPerfo.startPerfo("draw");var Ee=null,Te=this.materialToUse===X.oitAccumMaterial,Ae=this.materialToUse===X.oitRevealMaterial,Ie=d,Re=this.useOIT&&this.currentPass.isOITPass&&d,Le=!d&&!x,Oe=D&&t.highlightData,Ne=Oe&&A,Fe=!1;if(!G&&w){var Ve=0,Ue=o._displayLists.filter(function(e){return e.hasTranspar});for(Me=0;Me<Ue.length;Me++){Ve+=Ue[Me]._materialList.length}Fe=0===Ve}2===e.WebGLVersion&&this.updateFrameUBO(r);var Be=this.forcePolygonOffset!==e.PolygonOffsetForceStatus.DEFAULT,ke=this.forcePolygonOffset===e.PolygonOffsetForceStatus.ENABLED;if(!Fe)for(var Ge=0;Ge<o._displayLists.length;Ge++){var ze,He=(ze=o._displayLists[Ge])._materialList;if(ze.active&&0!==He.length){if(!ze.canOIT&&w&&Ce.colorMask(!1,!1,!1,!1),ze.hasDecal){var We=this.getViewportSize();ye.currentNormalStencilDepthBuffer=this.renderTargetPool.buildRenderTarget(We.width,We.height,"decal",null,null,!1),this.clearTarget(ye.currentNormalStencilDepthBuffer,!0,!0,!0),T&&(ye.currentRGBADepthBuffer=this.renderTargetPool.buildRenderTarget(We.width,We.height,"uintNearest",null,null,!1),this.clearTarget(ye.currentRGBADepthBuffer,!0,!0,!0)),this.setRenderTarget(n)}var je=null;ze.depthFunc&&(je=mt,this.setDepthFunc(Ce[ze.depthFunc])),M&&(Ge>0&&(ze.pickingPriority||we)&&Ce.clear(Ce.DEPTH_BUFFER_BIT),we=!!ze.pickingPriority),ze.useStencil&&("NOZ"!==ze.name||"NOZ"===ze.name&&u)&&(Ce.enable(Ce.STENCIL_TEST),Ce.stencilFunc(Ce.ALWAYS,1,255),Ce.stencilOp(Ce.KEEP,Ce.KEEP,Ce.REPLACE),Ce.stencilMask(255));var Xe=ze.depthWrite;ze.hasTranspar&&Re&&(Xe=!0);var qe=Ae&&ze.canOIT,Ye=Te&&ze.canOIT,Ke=Re&&ze.canOIT,Qe=-1;for(be=0;be<He.length;be++){De=He[be];var rt,at=(rt=ze._displayRangeLists.get(De.id))&&rt.getFirstDrawable();if(at){var st=!1,ot=!1,lt=!1,ct=qe,ht=Ye,ut=Ke,dt=this.materialToUse,pt=Le;if(ze.hasDecal){var ft=!1;switch(De.materialToUse){case X.decalNormalStencilDepthMaterial:st=!0,ft=!0;break;case X.texCoordMaterial:ot=!0,ft=!0;break;case X.depthRGBAMaterial:lt=!0,ft=!0;break;default:d=Ie}ft&&(dt=De.materialToUse,d=!1,ut=!1,ct=!1,ht=!1,pt=!0)}et=null;var gt=rt.materialOverride;if(this.clipPlanesEnabled||!this.cuttingScene||De.occurrenceRenderingOverride&&De.occurrenceRenderingOverride.clipPlanes){var vt=De.material,St=!G&&Qe!==be&&(ct||ht)&&(De._objectsTransparentOnGPU||vt._transparencyOnGPU(null));St&&(Ce.colorMask(!1,!1,!1,!1),Qe=be,dt=X.originalMaterial,ct=!1,ht=!1),ut!==vt.isOIT&&(ut?vt._programID|=e.ProgramIDs.OIT:vt._programID&=~e.ProgramIDs.OIT,vt.isOIT=ut),vt.deferrable&&(this._forbidRenderableState&B.NO_TRANSPARENT?vt._programID|=e.ProgramIDs.SKIP_TRANSPAR:vt._programID&=~e.ProgramIDs.SKIP_TRANSPAR);var _t=vt;if(!vt.areTexturesLoaded()&&d){if(vt.transparent||vt.getOpacity()<1)continue;_t=Ti}if(Nt=vt._computeAmbianceKeyAndProcessMaterial(d,t,this.ambianceGenerators,this.sssGenerator,P,this.id),vt.physical&&(t.envMipMap.length>0&&(vt.envMipMap=t.envMipMap,vt.envMap=t.envMipMap[0],vt.ambienceMatrix=t.ambienceMatrix),t.reflectionProbes.length&&(vt.envMap=t.reflectionProbes[0].map0,vt.reflectionProbes=t.reflectionProbes),t.useFiniteEnvMap&&(vt.useFiniteEnvMap=t.useFiniteEnvMap,vt.parallaxCorrectionParameters=t.parallaxCorrectionParameters)),ct)Ze.setBlending(e.OITRevealBlending,0,0,0);else if(ht)Ze.setBlending(e.OITAccumBlending,0,0,0);else if(E)Ze.setBlending(e.TransparentShadowBlending,0,0,0);else if(pt)Ne?Ze.setBlending(e.NormalBlending,e.AddEquation,e.SrcAlphaFactor,e.OneMinusSrcAlphaFactor):Ze.setBlending(e.NoBlending);else if(vt.useBlending||!vt.iterative&&(vt.transparent||vt.getOpacity()<1))Ze.setBlending(vt.blending,vt.blendEquation,vt.blendSrc,vt.blendDst);else{var yt=!1;if(gt&&gt.hasTransparency())yt=!0;else if(this.useRenderPriorityOpacity)this.computeRenderPriorityOpacity(1,gt)<1&&(yt=!0);yt?Ze.setBlending(e.NormalBlending,e.AddEquation,e.SrcAlphaFactor,e.OneMinusSrcAlphaFactor):Ze.setBlending(e.NoBlending)}Oe?(Ze.setDepthTest(!Ze.disableDepthTest&&ze.depthTest),t.highlightData._updateMaterialUniforms(vt,this)):at.dg&&!at.dg.glType&&at.dg._geomType===e.GeomTypeEnum.SURFACIC_POINT&&ze.depthTest?Ze.setDepthTest(!0):pt?Ze.setDepthTest(!Ze.disableDepthTest&&ze.depthTest):Ze.setDepthTest(vt.depthTest&&!Ze.disableDepthTest&&ze.depthTest);var xt=Xe;!Xe&&this.currentPass&&(!this.currentPass.isRobotPass&&ze.hasTranspar&&(_t.opacityMap||_t.map||(1===_t.getOpacity()||M)&&null===gt||gt&&(1===gt.getOpacity()||M))&&(Xe=!0),this.currentPass.isRobotPass&&M&&(Xe=!0)),pt?(Ze.setDepthWrite(Xe&&!Ze.disableDepthWrite),Ze.setColorWrite(!Ze.disableColorWrite)):ht||ct?(Ze.setDepthWrite(!1),Ze.setColorWrite(vt.colorWrite&&!Ze.disableColorWrite)):(Ze.setDepthWrite(vt.depthWrite&&Xe&&!Ze.disableDepthWrite),Ze.setColorWrite(vt.colorWrite&&!Ze.disableColorWrite)),Xe=xt,vt.polygonOffset&&!Be&&this.setPolygonOffset(vt.polygonOffset,vt.polygonOffsetFactor,vt.polygonOffsetUnits),Ze._clipPlanesState.update(De.occurrenceRenderingOverride,Ee,!1,_t,r,!!Ze.cuttingScene),Ee=De.occurrenceRenderingOverride;var Mt=!1,Pt=null;if(this.useRenderPriorityOpacity)if(0===this.computeRenderPriorityOpacity(1,gt))continue;var Ct=!0,bt=this.tokens,Dt=this._hasClippingWithoutCapping(),wt=0;rt.tree.forEach(function(e,t){bt[wt++]=e.next});var Et=null;vt.depthFunc&&(Et=mt,this.setDepthFunc(Ce[vt.depthFunc]));for(var It=0;It<wt;++It)for(Pt=bt[It];null!==Pt;Pt=Pt.next){var Rt=Pt.dg,Vt=Pt.object,Ut=Pt.geometry,Bt=Pt.matApp,kt=Pt.gas;if(Vt&&Vt.outlinesGeometry&&Rt._geomType===e.GeomTypeEnum._OUTLINE){let t=null;if(xe(r)){let i=new e.Vector4(0,0,1,0).applyMatrix4(r.matrixWorld);i.applyMatrix4((new e.Matrix4).getInverse(Vt.matrixWorld)),t=new e.Vector3(i.x,i.y,i.z).normalize()}i.refreshOutlines({object:Vt,viewDirection:t,width:this.getRenderMode(ge)._outlineWidth,gl:Ce,visibleSpace:this.visibleSpace}),Pt.start=Rt.start,Pt.count=Rt.count}if(Pt.updateLineInfos&&Pt._updateWideLineAndPatternStuff(_t,this,r,e),Pt.doRenderLineModePolygonOffset.doIt&&this.setPolygonOffset(Be?ke:Pt.doRenderLineModePolygonOffset.enable,Pt.doRenderLineModePolygonOffset.factor,Pt.doRenderLineModePolygonOffset.unit),ze.hasDecal&&oe(Ze,ye,st,ot,lt),this.setMaterialFacesSimple(Pt,_t,r,Dt),2===Ut._type){if(gt&&gt.colorOverride){var Gt=!1;if((gt.colorOverride.hasASMInherit()||Vt._occurrence.gas&&Vt._occurrence.gas.hasASMInherit())&&(Gt=!0),Gt&&(gt.disableColorOverride=!1,Rt&&(Rt._geomType===e.GeomTypeEnum.BOUNDARY_EDGE||Rt._geomType===e.GeomTypeEnum.SMOOTH_EDGE||Rt._geomType===e.GeomTypeEnum.SHARP_EDGE||Rt._geomType===e.GeomTypeEnum._OUTLINE))){var zt=this.getRenderMode(Vt);this.overrideWireframeFix&&zt&&!zt.areFacesVisible()||(gt.disableColorOverride=!0)}}Vt&&null!==Vt.sectionLinesBuilder&&Vt.sectionLinesBuilder.sectionLineGeometry&&Ut===Vt.sectionLinesBuilder.sectionLineGeometry?this.renderSectionLines(r,h,Vt,_t,null,Ut,Rt,Pt.start,Pt.count,De.occurrenceRenderingOverride,gt,Ct,0,Pt,Bt,kt,dt):Mt=this.renderInterval(r,h,Vt,_t,null,Ut,Rt,Pt.start,Pt.count,De.occurrenceRenderingOverride,gt,Ct,R,Pt,Bt,kt,dt),gt&&(gt.disableColorOverride=!1),Mt&&(Ct=!1)}else Mt=1===Ut._type?this.renderBufferDirect(r,h,vt,Ut,Vt):this.renderBuffer(r,h,vt,Ut,Vt);ze.hasDecal&&le(Ze,n,st||ot||lt)}Mt&&this.renderCuttingElements(vt,r,h,De.occurrenceRenderingOverride)&&(Ee=null),St&&(Ce.colorMask(!0,!0,!0,!0),be--),Et&&this.setDepthFunc(oldDepthFunc)}}}!ze.canOIT&&w&&Ce.colorMask(!0,!0,!0,!0),je&&this.setDepthFunc(je),ze.useStencil&&("NOZ"!==ze.name||"NOZ"===ze.name&&u)&&Ce.disable(Ce.STENCIL_TEST),ze.hasDecal&&(this.renderTargetPool.pushRenderTarget(ye.currentNormalStencilDepthBuffer,null),ye.currentNormalStencilDepthBuffer=null,this.renderTargetPool.pushRenderTarget(ye.currentTexCoordBuffer,null),ye.currentTexCoordBuffer=null,T&&(this.renderTargetPool.pushRenderTarget(ye.currentRGBADepthBuffer,null),ye.currentRGBADepthBuffer=null))}}window.webVisuPerfo.endPerfo("draw"),this.enableRenderPluginsPost&&Vi(this.renderPluginsPost,t,r),n&&n.generateMipmaps&&n.minFilter!==e.NearestFilter&&n.minFilter!==e.LinearFilter&&function(t){t instanceof e.WebGLRenderTargetCube?(Ce.bindTexture(Ce.TEXTURE_CUBE_MAP,t.__webglTexture),Ce.generateMipmap(Ce.TEXTURE_CUBE_MAP),Ce.bindTexture(Ce.TEXTURE_CUBE_MAP,null)):(Ce.bindTexture(Ce.TEXTURE_2D,t.__webglTexture),Ce.generateMipmap(Ce.TEXTURE_2D),Ce.bindTexture(Ce.TEXTURE_2D,null))}(n),this.setColorWrite(!0),this.setDepthTest(!0),this.setDepthWrite(!0)}else console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.")},this.doRenderPlugins=function(e,t,i,r,n){this.initWebGLObjects(t);var a=0;for(a=0;a<e.length;a++)e[a].noRenderTarget||this.setRenderTarget(r);Vi(e,t,i,n)},this.renderObjects=function(t,i,r,n,a,s,o,l){var c,h,u,d,p,f,m;i?(p=t.length-1,f=-1,m=-1):(p=0,f=t.length,m=1),2===e.WebGLVersion&&this.updateFrameUBO(n),tt=null,it=null;for(var g=p;g!==f;g+=m)if(null!==(c=t[g])){if(u=(h=c.object).geometry.geometryGroupsList[0],o)d=o;else{if(void 0===(d=c.object.material[this.materialToUse])&&(d=c.object.material),!d)continue;s||d.useBlending?Ze.setBlending(d.blending,d.blendEquation,d.blendSrc,d.blendDst):Ze.setBlending(e.NoBlending),Ze.setDepthTest(d.depthTest&&!Ze.disableDepthTest),Ze.setDepthWrite(d.depthWrite&&!Ze.disableDepthWrite),Ze.forcePolygonOffset===e.PolygonOffsetForceStatus.DEFAULT&&setPolygonOffset(d.polygonOffset,d.polygonOffsetFactor,d.polygonOffsetUnits)}if(Ze.setMaterialFaces(d),1===u._type)Ze.renderBufferDirect(n,a,d,u,h);else if(2===u._type||u.length>=0){var v=h.geometry.length||1,S=h.geometry.length?h.geometry[0]:h.geometry;for(g=0;g<v;g++){for(var _=S.drawingGroups,y=0;y<_.length;y++)Ze.renderInterval(n,a,h,d,null,S,_[y],_[y].start,_[y].count,null,l,!0,0,token,null);if(1===v)break;S=h.geometry[g+1]}}else Ze.renderBuffer(n,a,d,u,h,l)}},this.initWebGLObjects=function(t){t.initWebGLObjectFrameIndex!==this.currentFrameIndex&&(t.initWebGLObjectFrameIndex=this.currentFrameIndex,t.__webglObjects||(t.__webglObjects={main:new e.WebGLObjectManager},t.__webglObjectsAll=new e.WebGLObjectManager,t.__webglObjectsToDraw=[],t.__webglSprites=[],t.__webglFlares||(t.__webglFlares=[])),t.__objectsAdded.size&&t.__processAddedObjects(Ui),t.__objectsUpdated.size&&t.__processUpdatedObjects(Ui),t.__objectsRemoved.size&&t.__processRemovedObjects(Ze.__glResources__),n.allocateShared(0==e.loadingModels),n.intermediaryArray=null,t.traverseObject3DWithCondition(function(e){return!e.isRoot3ds&&(Bi(e),!0)}))},this.initObject=function(t){var i;if(t.geometry&&(2===t.geometry._type||t.geometry.length>=0)){if(t._normalMatrix=new e.Matrix3,2===(n=t.geometry)._type)n.addEventListener("dispose",pi);else if(n.length)for(var r=0;r<n.length;r++)n[r].addEventListener("dispose",pi)}else if(!t.__webglInit){t.__webglInit=!0,t._normalMatrix=new e.Matrix3,void 0!==t.geometry&&void 0===t.geometry.__webglInit&&(t.geometry.__webglInit=!0,t.geometry.addEventListener("dispose",di));var n=t.geometry;if(void 0===n);else if(1===n._type)!function(e){var t,i,r;for(t in e.attributes)r="index"===t?Ce.ELEMENT_ARRAY_BUFFER:Ce.ARRAY_BUFFER,(i=e.attributes[t]).buffer=Ce.createBuffer(),Ce.bindBuffer(r,i.buffer),Ce.bufferData(r,i.array,Ce.STATIC_DRAW)}(n);else if(t instanceof e.Mesh)for(i in s=t.material,void 0===n.geometryGroups&&function(t,i){var r,n,a,s,o,l,c={},h=t.morphTargets.length,u=t.morphNormals.length,d=i instanceof e.MeshFaceMaterial;for(t.geometryGroups={},r=0,n=t.faces.length;r<n;r++)a=t.faces[r],void 0===c[s=d?a.materialIndex:0]&&(c[s]={hash:s,counter:0}),l=c[s].hash+"_"+c[s].counter,void 0===t.geometryGroups[l]&&(t.geometryGroups[l]={faces3:[],faces4:[],materialIndex:s,vertices:0,numMorphTargets:h,numMorphNormals:u}),o=a instanceof e.Face3?3:4,t.geometryGroups[l].vertices+o>65535&&(c[s].counter+=1,l=c[s].hash+"_"+c[s].counter,void 0===t.geometryGroups[l]&&(t.geometryGroups[l]={faces3:[],faces4:[],materialIndex:s,vertices:0,numMorphTargets:h,numMorphNormals:u})),a instanceof e.Face3?t.geometryGroups[l].faces3.push(r):t.geometryGroups[l].faces4.push(r),t.geometryGroups[l].vertices+=o;for(var p in t.geometryGroupsList=[],t.geometryGroups)t.geometryGroups[p].id=e.GeometryIdCount++,t.geometryGroupsList.push(t.geometryGroups[p])}(n,s),n.geometryGroups){var a=n.geometryGroups[i];a.__webglVertexBuffer||(si(a),Mi(a,t),n.verticesNeedUpdate=!0,n.morphTargetsNeedUpdate=!0,n.elementsNeedUpdate=!0,n.uvsNeedUpdate=!0,n.normalsNeedUpdate=!0,n.tangentsNeedUpdate=!0,n.colorsNeedUpdate=!0)}else if(t instanceof e.Line)n.__webglVertexBuffer||(!function(e){e.__webglVertexBuffer=Ce.createBuffer(),e.__webglColorBuffer=Ce.createBuffer(),e.__webglLineDistanceBuffer=Ce.createBuffer(),Me.geometries++}(n),function(e,t){var i=e.vertices.length;e.__vertexArray=new Float32Array(3*i),e.__colorArray=new Float32Array(3*i),e.__lineDistanceArray=new Float32Array(1*i),e.__webglLineCount=i}(n),n.verticesNeedUpdate=!0,n.colorsNeedUpdate=!0,n.lineDistancesNeedUpdate=!0);else if(t instanceof e.ParticleSystem){n.__webglVertexBuffer||(!function(e){e.__webglVertexBuffer=Ce.createBuffer(),e.__webglColorBuffer=Ce.createBuffer(),Me.geometries++}(n),function(e,t){var i=e.vertices.length;e.__vertexArray=new Float32Array(3*i),e.__colorArray=new Float32Array(3*i),e.__sortArray=[],e.__webglParticleCount=i}(n),n.verticesNeedUpdate=!0,n.colorsNeedUpdate=!0);var s=Pi(t,n),o=s.attributes&&ki(s);(n.verticesNeedUpdate||n.colorsNeedUpdate||t.sortParticles||o)&&wi(n,Ce.DYNAMIC_DRAW,t),n.verticesNeedUpdate=!1,n.colorsNeedUpdate=!1,s.attributes&&Gi(s)}}t._updateWorldCenterAndRadius()},this._commonShaderOptionsBuilder=function(t,i,r,n,a,s,o,l){var c={materialToUse:o,mobile:e.mobileVersion,mobileDevice:e._mobileDevice,noCompositing:!G,mobileHL:e._mobileHighlight,deferrable:t.deferrable,depthDebugMaterial:l&&this._debugMaterialMode===j.DEPTH,normalDebugMaterial:l&&this._debugMaterialMode===j.NORMAL,shadowMapDebugMaterial:l&&this._debugMaterialMode===j.SHADOW,geomUVDebug:l&&this._debugMaterialMode===j.GEOM_UV,mappingUVDebug:l&&this._debugMaterialMode===j.MAPPING_UV,geomUV2Debug:l&&this._debugMaterialMode===j.GEOM_UV2,mappingUV2Debug:l&&this._debugMaterialMode===j.MAPPING_UV2,useOIT:t.isOIT,maxDirLights:0,maxDirIBLLights:0,maxDirPhongLights:0,maxPointLights:0,maxSpotLights:0,maxSphereLights:0,maxTubeLights:0,maxDiskLights:0,maxAreaLights:0,maxIESLights:0,lightMapMode:0,useLighting:!1,maxDirShadows:0,maxDirIBLShadows:0,maxSpotShadows:0,maxShadows:0,maxShadowsCube:0,uintESM:this.packESM,shadowMapType:this.shadowMapType,morphTargets:t.morphTargets,morphNormals:t.morphNormals,maxMorphTargets:this.maxMorphTargets,maxMorphNormals:this.maxMorphNormals,fixedSize:r&&r._ratioData&&r._ratioData.ratio>0,fixedSizeCenter:r&&r._ratioData&&r._ratioData.ratio>0&&r._ratioData.center,alphaTest:t.alphaTest,discardOrOpaque:t.alphaTest&&t.alphaTestMode===e.AlphaTestMode.DISCARD_OR_OPAQUE,doubleSided:t.side===O.DoubleSide,flipSided:t.side===O.BackSide,vertexColors:t.vertexColors>0,objectVertexColors:r._vertexColors>0,allowObjectVertexColors:t._allowObjectColor,sizeAttenuation:t.sizeAttenuation,largeScale:(a&e.ProgramIDs.LARGE_SCALE)>0,useNormalMatrix:(a&e.ProgramIDs.NON_UNIFORM_SCALE)>0,noZObject:(a&e.ProgramIDs.NOZ_OBJECT)>0,politeHighlight:(a&e.ProgramIDs.POLITE_HIGHLIGHT)>0,primitiveHighlight:(a&e.ProgramIDs.PRIMITIVE_HIGHLIGHT)>0,adjacenceHighlight:(a&e.ProgramIDs.ADJACENCE_HIGHLIGHT)>0,clipPlanesEnabled:this.clipPlanes.length>0&&t.enableClipPlanes,billboard:r&&r._billboardData&&r._billboardData.type>=1,isMultiInstanced:r&&r._instancingInfos&&r._instancingInfos.isInstanceNode3D||t.isInstancingMaterial,instancingMeshSelectionMode:r&&r._instancingInfos&&"mesh"===r._instancingInfos.instancingSelectionMode,compressedVertices:n&&n.compressedVertices,compressedNormals:n&&n.compressedNormals,compressedUVs:n&&n.compressedUVs,compressedColors:n&&n.compressedColors,gpuTangentBinormal:n&&!n.hasTangentBinormal(),map:t._isTextureAvailable("map"),mapHDR:!!t.map&&t.map.hdr,newSslr:this.useSSLR||this.useSSLRefraction,sslrefractionEnabled:this.useSSLRefraction,sslreflectionEnabled:this.useSSLR,shadowPass:b||E,skipTranspar:(a&e.ProgramIDs.SKIP_TRANSPAR)>0,inlinedPostProActivated:this.inlinedPostProcess.activated,inlinedPostProTonemapping:this.inlinedPostProcess.tonemapping,fogViewMode:this._backgroundViewMode===e.BackgroundViewMode.FOG||this._backgroundViewMode===e.BackgroundViewMode.LOWLIGHT,lowlightViewMode:this._backgroundViewMode===e.BackgroundViewMode.LOWLIGHT};return r._skinning?Object.assign(c,{skinning:!0,useEulerAngles:r._skinning.useEulerAngles,skinningMapWidth:r._skinning.skinningMapWidth,skinningMapHeight:r._skinning.skinningMapHeight}):r._skinningInstancing&&Object.assign(c,{skinning:!0,useEulerAngles:r._skinningInstancing.useEulerAngles,skinningInstancingMapsInfo:r._skinningInstancing.skinningInstancingMapsInfo}),c},this._lightedShaderOptionsBuilder=function(t,i,r,n,a,s,o){var l=function(e){var t,i,r,n={dirLights:0,dirIBLLights:0,dirPhongLights:0,pointLights:0,spotLights:0,sphereLights:0,areaLights:0,iesLights:0,tubeLights:0,diskLights:0};for(t=0,i=e.length;t<i;t++)(r=e[t]).onlyShadow||r.allocate(n);return{directional:n.dirLights,directionalIBL:n.dirIBLLights,directionalPhong:n.dirPhongLights,point:n.pointLights,spot:n.spotLights,sphere:n.sphereLights,area:n.areaLights,ies:n.iesLights,tube:n.tubeLights,disk:n.diskLights}}(i),c=function(e){var t,i,r,n={dirLight:0,dirIBLLight:0,spotLight:0,tex2d:0,texCube:0};for(t=0,i=e.length;t<i;t++)(r=e[t]).castShadow&&r.allocateShadows(Ze,n);return n}(i),h=c.dirLight,u=c.dirIBLLight,d=c.spotLight,p=c.tex2d,f=c.texCube,m=0;if(t.envMap){var g=t.envMap.mapping;g instanceof e.SphericalReflectionMapping?m=1:g instanceof e.LatLongReflectionMapping&&(m=2)}var v=!1,S=0,_=!1;return s&&s._lightMap&&s._lightMap.texture?(v=!0,S=s._lightMap.mode,_=s._lightMap.linear):(v=r&&!!r.lightMapData,S=r&&!!r.lightMapData&&r.lightMapData.lightMapMode,_=!0),{maxDirLights:l.directional,maxDirIBLLights:l.directionalIBL,maxDirPhongLights:l.directionalPhong,maxPointLights:l.point,maxSpotLights:l.spot,maxSphereLights:l.sphere,maxTubeLights:l.tube,maxDiskLights:l.disk,maxAreaLights:l.area,maxIESLights:l.ies,lightMap:v,lightMapMode:S,lightMapLinear:_,useLighting:!0,reflectivityEnvMap:t._isTextureAvailable("reflectivityEnvMap"),maxDirShadows:h,_maxDirIBLShadows:u,maxDirIBLShadows:0,maxSpotShadows:d,maxShadows:p,maxShadowsCube:f,_shadowMapEnabled:this.shadowMapEnabled&&r.receiveShadow,shadowMapEnabled:this.shadowMapEnabled&&p>0&&r.receiveShadow,shadowMapCubeEnabled:this.shadowMapEnabled&&f>0&&r.receiveShadow,transparentShadowEnabled:this.shadowMapEnabled&&this.transparentShadowEnabled&&!(t.transparent||t.getOpacity()<1),metal:t.metal,perPixel:t.perPixel,wrapAround:t.wrapAround,reflectionProbes:t.reflectionProbes,useFiniteEnvMap:t.useFiniteEnvMap,envMap:!!t.envMap,envMapSheen:!!t.envMap&&t._sheenData&&null!==t._sheenData.envMipMap,envMapDiffuse:t.envMipMap&&t.envMipMap[1]&&t.envMipMap[1].hasDiffuse,envMapHDR:t.envMap&&t.envMap.hdr,envMapRGBHDR:t.envMap&&t.envMap.rgbHdr,envMapRGBsRGB:t.envMap&&t.envMap.sRGB,envMapping:m,flakesMode:this.flakesMode,specularMap:t._isTextureAvailable("specularMap"),specularMapLinear:!!t.specularMap&&t.specularMap.hdr}},this._textureShaderOptionsBuilder=function(e,t,i,r,n,a,s){var o=e._getTextures(!0).filter(function(e){return!!e}).length>0;return{useUV:o=a&&a._lightMap?o||!!a._lightMap.texture:o||i&&!!i.lightMapData,mappingType:a&&a._mappingOperator?a._mappingOperator.mappingType:e.mappingType,mappingUseFragment:a&&a._mappingOperator?a._mappingOperator.mappingUseFragment:e.mappingUseFragment,textureBlending:e.textureBlending,textureFormat:e.map,needTangent:e.needTangent,needTangentBinormal:e.requireTangentBinormal()}},this.initMaterial=function(t,i,r,n,a,s,o){t.addEventListener("dispose",gi);var l,c=Ce.contextId,h=this.id,u=this.currentRendererMode,f=t.programManager;u===f.currentRendererMode&&h===f.currentRendererId&&c===f.currentContextId||f.setActive(c,h,u);var S=t._shaderID,_=d;d=d&&t._canUseLights(),null!==S&&function(e,t,i){e.uniforms=t.uniforms;var r=!!e.isPhysicalMaterial&&!i;e.vertexShader=r?t.vertexShaderNoLight:t.vertexShader,e.fragmentShader=r?t.fragmentShaderNoLight:t.fragmentShader}(t,e.ShaderLib[S],d);var y=this._commonShaderOptionsBuilder(t,i,r,n,a,s,o,_);if(d&&Object.assign(y,this._lightedShaderOptionsBuilder(t,i,r,n,a,s,o)),Object.assign(y,this._textureShaderOptionsBuilder(t,i,r,n,a,s,o)),C||(y.dashedLine=t.isDashedLine,y.cpuPattern=t.isCPUPattern,y.patternSize=t.isDashedLine&&t.dashPattern?t.dashPattern.length:0),M&&(y.specialPickingInstancing=r&&r.isCurvedPipe,y._definePickingInstancing=t._definePickingInstancing),(d||b||E)&&(y.shadowMapQuality=this.shadowMapEnabled&&r.receiveShadow&&this.shadowMapQuality,y.shadowMapDebug=this.shadowMapEnabled&&r.receiveShadow&&this.shadowMapDebug,y.shadowMapCascade=this.shadowMapEnabled&&r.receiveShadow&&this.shadowMapCascade),y._isDecal=(a&e.ProgramIDs.DECALS)>0,p||(y.isDecal=y._isDecal,y.isDecal&&0==y.mappingUseFragment&&(y.mappingUseFragment=!0)),t._setMaterialShaderOptions(y,d,g||v,b||E,m,C),t._PDSFXData&&t._PDSFXData.PDSFX){var x=t._PDSFXData;y.PDSFX=!0,y.PDSFX_OverridableFunctions_VS=t._getPDSFXOverridableFunctions_VS(),y.PDSFX_OverridableFunctions_FS=t._getPDSFXOverridableFunctions_FS(),y.PDSFX_hasAlbedo=x.PDSFX_hasAlbedo,y.PDSFX_hasOpacity=x.PDSFX_hasOpacity,y.PDSFX_hasHalfWidth=x.PDSFX_hasHalfWidth,y.PDSFX_hasEmissive=x.PDSFX_hasEmissive,y.PDSFX_hasSpecular=x.PDSFX_hasSpecular,y.pdsfxVaryingsCode=x.pdsfxVaryingsCode?x.pdsfxVaryingsCode:"",y.pdsfxUniformsCode=x.pdsfxUniformsCode?x.pdsfxUniformsCode:null,x.pdsfxUniforms&&(y.pdsfxUniforms=x.pdsfxUniforms),y.pdsfxGlobalVariablesCode_VS=x.pdsfxGlobalVariablesCode_VS?x.pdsfxGlobalVariablesCode_VS:"",y.pdsfxGlobalVariablesCode_FS=x.pdsfxGlobalVariablesCode_FS?x.pdsfxGlobalVariablesCode_FS:"",y.pdsfxAttributesCode=x.pdsfxAttributesCode?x.pdsfxAttributesCode:"",y.pdsfxUseMap=x.pdsfxUseMap?x.pdsfxUseMap:"",y.pdsfxCPULargeScale=x.CPULargeScale,y.pdsfxUseMap&&(y.useUV=!0)}t.enableReceiveShadowOnCapping=y.shadowMapEnabled;var P,D=t.program;if(t.program=function(t,i,r){var n,a,s,o,l=[],c=i.fragmentShader,h=i.vertexShader,u=i.uniforms,d=i.attributes,p=i.defines;null===t&&(l.push(c),l.push(h));o=l.join();var f="SHADOWMAP_TYPE_BASIC";r.shadowMapType===e.PCFShadowMap?f="SHADOWMAP_TYPE_PCF":r.shadowMapType===e.PCFSoftShadowMap?f="SHADOWMAP_TYPE_PCF_SOFT":r.shadowMapType===e.PCFInterpolShadowMap?f="SHADOWMAP_TYPE_PCF_INTERPOL":r.shadowMapType===e.PCFPoissonShadowMap?f="SHADOWMAP_TYPE_PCF_POISSON":r.shadowMapType===e.PCFOptimizedShadowMap?f="SHADOWMAP_TYPE_PCF_OPTI":r.shadowMapType===e.ESMShadowMap?f="SHADOWMAP_TYPE_ESM":r.shadowMapType===e.ESMImprovedShadowMap&&(f="SHADOWMAP_TYPE_ESM_IMPROVED");var m="SHADOWMAP_QUALITY_LOW";r.shadowMapQuality===e.MediumQuality?m="SHADOWMAP_QUALITY_MEDIUM":r.shadowMapQuality===e.HighQuality&&(m="SHADOWMAP_QUALITY_HIGH");r.shadowMapTypeDefine=f,r.shadowMapQualityDefine=m;var g=function(e){var t,i,r=[];for(var n in e)!1!==(t=e[n])&&(i="#define "+n+" "+t,r.push(i));return r.join("\n")}(p),v=["vec4 sampleTexture(sampler2D iTexture, vec2 iCoord) {","#ifdef GLSL300ES","return texture(iTexture, iCoord);","#else","return texture2D/*NO REPLACING*/(iTexture, iCoord);","#endif","}","vec4 sampleCubeTexture(samplerCube iTexture, vec3 iCoord) {","#ifdef GLSL300ES","return texture(iTexture, iCoord);","#else","return textureCube/*NO REPLACING*/(iTexture, iCoord);","#endif","}"].join("\n"),S=[2===e.WebGLVersion?"#version 300 es":"",2===e.WebGLVersion?"#define GLSL300ES":"","precision "+Z+" float;","precision "+se+" int;",g,qt?"#define VERTEX_TEXTURES":"",ze?"#define RENDER_TO_FLOAT_TEXTURE":"",He?"#define RENDER_TO_HALF_FLOAT_TEXTURE":"","#define MAX_TEXTURE_SIZE "+Wt.toFixed(1),Ze.gammaInput?"#define GAMMA_INPUT":"",Ze.gammaOutput?"#define GAMMA_OUTPUT":"",Ze.simpleGamma?"#define SIMPLE_GAMMA":"",Ze.useClippingCylinder?"#define USE_CLIPPINGCYLINDER":"","#define MAX_POLYGON_SIZE "+Math.max(Ze.maxPolyLineSize,Ze.maxScissorSize),Ze.maxPolyLineSize>0?"#define USE_CLIPPINGPOLYGON":"",Ze.maxPolyLineSize>0?"#define NB_CLIPPINGPOLYGON "+Ze.maxNbPolyLine:"",Ze.maxScissorSize>0?"#define USE_SCISSORPOLYGON":"",$(r)].join("\n"),_=[v,"","#ifndef DEFERRABLE_MATERIAL","#if defined(PICKING_INSTANCING) || defined(SPECIAL_PICKING_INSTANCING)","varying vec3 vInstancePickingColor;","#endif","#endif","",e.ShaderChunk.Default_uniforms_declaration,e.ShaderChunk.normalMatrix_uniforms_declaration,e.ShaderChunk.double_emulation_utilities,e.ShaderChunk.double_emulation_vertex,e.ShaderChunk.sRGB_conversion,e.ShaderChunk.gpu_scenegraph_nodes,"#ifdef PDSFX",e.ShaderChunk.PDSFX_header_vertex,"#else","#ifdef COMPRESSED_VERTICES","vec3 position;","attribute vec2 _DSposition;","#else","attribute vec3 position;","#endif","#ifdef COMPRESSED_NORMALS","vec3 normal;","attribute float _DSnormal;","#else","attribute vec3 normal;","#endif","#ifdef COMPRESSED_UVS","vec2 uv;","vec2 uv2;","attribute vec2 _DSuv;","attribute vec2 _DSuv2;","#else","attribute vec2 uv;","attribute vec2 uv2;","#endif","attribute vec3 _DStangent;","attribute vec3 _DSbinormal;","vec3 tangent;","vec3 binormal;","#ifdef USE_DASHEDLINE","attribute vec2 lineDistance;","#ifdef WORLD_SIZE_PATTERN2","attribute vec2 patternStartEnd;","#endif","#endif","#ifdef USE_WIDELINE","attribute vec3 previousPos;","attribute vec3 followingPos;","#endif","#endif","#ifdef USE_WIDELINE","attribute float sideExtrusion;","#endif","#ifdef COMPRESSED_COLORS","attribute vec2 _DScolor;","vec4 color;","#else","attribute vec4 color;","#endif","#ifdef COMPRESSED_VERTICES","uniform vec3 offsetVector;","uniform vec3 quantizedVector;","#endif",e.ShaderChunk.rgba_packing_pars,e.ShaderChunk.decompress_vertices_pars,e.ShaderChunk.decompress_normals_pars,e.ShaderChunk.decompress_uvs_pars,e.ShaderChunk.decompress_colors_pars,"#ifdef IS_MULTI_INSTANCED","attribute float instanceId;","#endif","#ifdef USE_MORPHTARGETS","attribute vec3 morphTarget0;","attribute vec3 morphTarget1;","attribute vec3 morphTarget2;","attribute vec3 morphTarget3;","#ifdef USE_MORPHNORMALS","attribute vec3 morphNormal0;","attribute vec3 morphNormal1;","attribute vec3 morphNormal2;","attribute vec3 morphNormal3;","#else","attribute vec3 morphTarget4;","attribute vec3 morphTarget5;","attribute vec3 morphTarget6;","attribute vec3 morphTarget7;","#endif","#endif","#ifdef USE_SKINNING","attribute vec4 skinIndex;","attribute vec4 skinWeight;","#endif",""].join("\n"),y=[2===e.WebGLVersion?"#version 300 es":"",2===e.WebGLVersion?"#define GLSL300ES":"",Xe?"#extension GL_EXT_frag_depth : enable":"",1===e.WebGLVersion?"#extension  GL_OES_standard_derivatives : enable":"",Xe?"#extension GL_EXT_frag_depth : enable":"",Xe?"#define FRAG_DEPTH_EXT":"",ze?"#define RENDER_TO_FLOAT_TEXTURE":"",He?"#define RENDER_TO_HALF_FLOAT_TEXTURE":"","#define DEPTH_PRECISION "+e.supportedExtensions.depthBits,"precision "+Z+" float;","precision "+se+" int;",Ze.gammaInput?"#define GAMMA_INPUT":"",Ze.gammaOutput?"#define GAMMA_OUTPUT":"",Ze.simpleGamma?"#define SIMPLE_GAMMA":"",g,"#define MAX_TEXTURE_SIZE "+Wt.toFixed(1),Ze.useClippingCylinder?"#define USE_CLIPPINGCYLINDER":"","#define MAX_POLYGON_SIZE "+Math.max(Ze.maxPolyLineSize,Ze.maxScissorSize),Ze.maxPolyLineSize>0?"#define USE_CLIPPINGPOLYGON":"",Ze.maxPolyLineSize>0?"#define NB_CLIPPINGPOLYGON "+Ze.maxNbPolyLine:"",Ze.maxScissorSize>0?"#define USE_SCISSORPOLYGON":"",Ze.maxScissorSize>0?"#define NB_SCISSOR "+Ze.maxNbScissor:"",ee(r)].join("\n"),x=[v,"vec4 sampleCubeTexture(samplerCube iTexture, vec3 iCoord, float iBias) {","#ifdef GLSL300ES","return texture(iTexture, iCoord, iBias);","#else","return textureCube/*NO REPLACING*/(iTexture, iCoord, iBias);","#endif","}",e.ShaderChunk.sRGB_conversion,e.ShaderChunk.rgba_packing_pars,e.ShaderChunk.decompress_vertices_pars,e.ShaderChunk.decompress_normals_pars,e.ShaderChunk.decompress_uvs_pars,e.ShaderChunk.decompress_colors_pars,"","#ifndef DEFERRABLE_MATERIAL","#if defined(PICKING_INSTANCING) || defined(SPECIAL_PICKING_INSTANCING)","varying vec3 vInstancePickingColor;","#endif","#endif","","vec3 tangent;","vec3 binormal;","#if defined(USE_MAPPING_OPERATOR_FRAGMENT) && defined(USE_TANGENT_BINORMAL)","vec3 MVUnit;",e.ShaderChunk.normalMatrix_uniforms_declaration,"#endif",e.ShaderChunk.Default_uniforms_declaration,e.ShaderChunk.double_emulation_utilities,e.ShaderChunk.double_emulation_fragment,"#ifdef GLSL300ES","layout(location = 0) out vec4 outFragColor;","#endif",""].join("\n"),M="",P="";if(r.PDSFX){var C=r.pdsfxGlobalVariablesCode_VS;if(p&&p.NB_OUTLINE_MAPS){for(var b="",D=0;D<p.NB_OUTLINE_MAPS;D++)b+="if (idInTextureArray == "+D+") return texture2D(outlinePositionMaps["+D+"], texCoords);";C=C.replace("__OUTLINES_MAPS_SAMPLING__",b)}var w=["#ifdef PDSFX",r.pdsfxAttributesCode,r.pdsfxVaryingsCode,r.pdsfxUniformsCode.common,r.pdsfxUniformsCode.vertex,e.ShaderChunk.PDSFX_common_pars,e.ShaderChunk.PDSFX_varyings_pars,e.ShaderChunk.PDSFX_attribute_getters_vertex,C,"struct TangentSpace","{","\tvec3 Position;","\tvec3 Normal;","\tvec3 Tangent;","\tvec3 Binormal;","};",r.PDSFX_OverridableFunctions_VS,"#endif",""].join("\n"),E=["#ifdef PDSFX",r.pdsfxVaryingsCode,r.pdsfxUniformsCode.common,r.pdsfxUniformsCode.fragment,e.ShaderChunk.PDSFX_common_pars,e.ShaderChunk.PDSFX_varyings_pars,e.ShaderChunk.PDSFX_varying_getters_fragment,r.pdsfxGlobalVariablesCode_FS,r.PDSFX_OverridableFunctions_FS,"#endif",""].join("\n");if(r.pdsfxCPULargeScale)S=S.replace("MODELVIEW_GPU","MODELVIEW_CPU"),y=y.replace("MODELVIEW_GPU","MODELVIEW_CPU");else{var T=[...w.matchAll("vGetWorldViewMatrix")],A=[...E.matchAll("vGetWorldViewMatrix")];(T&&T.length>1||A&&A.length>1)&&(S=S.replace("MODELVIEW_GPU","MODELVIEW_CPU"),y=y.replace("MODELVIEW_GPU","MODELVIEW_CPU"))}M=w,P=E}for(n=0,a=Ye.length;n<a;n++){var I=Ye[n];if(I.program._materialToUse===r.materialToUse&&I.shaderID===t&&I.pdsfx===r.PDSFX&&I.code===o&&I.prefix_vertex===S&&I.prefix_fragment===y&&I.pdsfx_fragment===P&&I.pdsfx_vertex===M)return I.usedTimes++,I.program}(r.shadowMapEnabled||r.shadowMapCubeEnabled)&&(c=(c=(c=c.replace("getExposureFromIndexPlaceholder",Ki(r,!1))).replace("getExposureFromIndexCubePlaceholder",Ki(r,!0))).replace("cascadedunrolledloop",function(e){for(var t="vec3 shadowCoord;bvec4 inFrustumVec;bool inFrustum;bvec2 inFrustumAndZVec;bool inFrustumAndZ;bvec2 frustumTestVec;bool frustumTest;\n",i=0;i<e.maxDirShadows;i++)t+="shadowCoord = vShadowCoord["+i+"].xyz / vShadowCoord["+i+"].w;\n",t+="inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n",t+="inFrustum = all( inFrustumVec );\n",t+="inFrustumAndZVec = bvec2(inFrustum, shadowCoord.z <= 1.0);\n",t+="inFrustumAndZ = all(inFrustumAndZVec);\n",t+="inFrustumCount += int( inFrustumAndZ );\n",t+="frustumTestVec = bvec2( inFrustumAndZ, inFrustumCount == 1 );\n",t+="frustumTest = all( frustumTestVec );\n",t+="if ( frustumTest ) {\n",t+="\texposure = getExposure(vShadowCoord["+i+"],shadowMap["+i+"],shadowBias["+i+"],shadowMapSize["+i+"]);\n",t+="\t#ifdef USE_TRANSPARENTSHADOWMAP \n",t+="\t\tvec3 shadowCoord = vShadowCoord["+i+"].xyz / vShadowCoord["+i+"].w;\n",t+="\t\tfloat isNotbehindFrustum = step(0.0,vShadowCoord["+i+"].w);\n",t+="\t\ttransparentExposure = isNotbehindFrustum * texture2D(transparentShadowMap["+i+"], shadowCoord.xy) + (1.0-isNotbehindFrustum) * vec4(1.0);\n",t+="\t#endif\n",t+="\t#ifdef SHADOWMAP_DEBUG\n",t+="\t\tif ( frustumTest ) gl_FragColor.xyz *= frustumColors[ "+i+" ];\n",t+="\t#endif\n",t+="}\n";return t}(r)));var R=new H;s=Ce.createProgram(),R.program=s,R._lightsKey=Ot,R._ambianceKey=Nt,R._materialToUse=r.materialToUse;var L=/(void(\s+)main(\s*)\((\s*)\)(\s*){(\s*))/,O=h.replace(L,"$&"+e.ShaderChunk.large_scale_VS),N=c.replace(L,"$&"+e.ShaderChunk.large_scale_FS),F=y+"\n"+x+"\n"+P+"\n"+N,V=S+"\n"+_+"\n"+M+"\n"+O;if(2===e.WebGLVersion){F=F.replace(/varying /g,"in "),V=(V=V.replace(/varying /g,"out ")).replace(/attribute /g,"in "),F=F.replace(/gl_FragColor/g,"outFragColor");var U=/\s*texture2D\s*\(/g,B=/\s*textureCube\s*\(/g;V=V.replace(U," sampleTexture("),F=(F=F.replace(U," sampleTexture(")).replace(B," sampleCubeTexture("),V=V.replace(B," sampleCubeTexture(");F=F.replace(/#extension\s+GL_OES_standard_derivatives\s*:\s*enable/g,"")}var k=Ce.createShader(Ce.FRAGMENT_SHADER);Ce.shaderSource(k,F),Ce.compileShader(k);var G,W,j=Ce.createShader(Ce.VERTEX_SHADER);Ce.shaderSource(j,V),Ce.compileShader(j),Ce.attachShader(s,j),Ce.attachShader(s,k),Ce.linkProgram(s),Ce.getProgramParameter(s,Le)||(console.error("Could not initialise shader\nVALIDATE_STATUS: "+Ce.getProgramParameter(s,Ce.VALIDATE_STATUS)+", gl error ["+Ce.getProgramInfoLog(s)+"]"),console.error(Ce.getShaderInfoLog(k)),console.error(Ji(F)),console.error(Ce.getShaderInfoLog(j)),console.error(Ji(V)));Ce.deleteShader(k),Ce.deleteShader(j),R.objectUniformLocations=new z;var X=R.objectUniformLocations;X.modelMatrix=Ce.getUniformLocation(s,"_modelMatrixForDoubleGPU"),X.modelInvTranspMatrix=Ce.getUniformLocation(s,"modelInvTranspMatrix"),X.modelViewMatrix=Ce.getUniformLocation(s,"modelViewMatrix"),X.modelViewInvTranspMatrix=Ce.getUniformLocation(s,"modelViewInvTranspMatrix"),X.normalMatrix=Ce.getUniformLocation(s,"normalMatrix"),X.displacementRadius=Ce.getUniformLocation(s,"displacementRadius"),X.quantizedVector=Ce.getUniformLocation(s,"quantizedVector"),X.offsetVector=Ce.getUniformLocation(s,"offsetVector"),X.fixedSizeRatio=Ce.getUniformLocation(s,"fixedSizeRatio"),X.fixedSizeCenterRatio=Ce.getUniformLocation(s,"fixedSizeCenterRatio"),X.lightMap=Ce.getUniformLocation(s,"lightMap"),X.lightMapUvSlot=Ce.getUniformLocation(s,"lightMapUvSlot"),X.lightMapUvTransform=Ce.getUniformLocation(s,"lightMapUvTransform"),X.billboardRotationEnabled=Ce.getUniformLocation(s,"billboardRotationEnabled"),X.billboardType=Ce.getUniformLocation(s,"billboardType"),X.billboardAxis=Ce.getUniformLocation(s,"billboardAxis"),X.billboardRotation=Ce.getUniformLocation(s,"billboardRotation"),X.modelInvRotMatrix=Ce.getUniformLocation(s,"modelInvRotMatrix"),X.decalStencilValue=Ce.getUniformLocation(s,"decalStencilValue"),X.modelViewInvMatrix=Ce.getUniformLocation(s,"modelViewInvMatrix"),X.decalExplicitUv=Ce.getUniformLocation(s,"decalExplicitUv"),X.objectColorBufferType=Ce.getUniformLocation(s,"objectColorBufferType"),X.skinningMap=Ce.getUniformLocation(s,"skinningMap"),X.skinningInstancingMaps=Ce.getUniformLocation(s,"skinningInstancingMaps"),X.backgroundViewModeControl=Ce.getUniformLocation(s,"background_view_mode_control"),X.backgroundViewModeNearFar=Ce.getUniformLocation(s,"background_view_mode_near_far"),X.computeFuncName(),R.uniformLocations={};var q=R.uniformLocations;if(2===e.WebGLVersion){var Y=Ce.getUniformBlockIndex(s,"FrameUBO");Ce.uniformBlockBinding(s,Y,ce.FRAME)}else q.viewMatrix=Ce.getUniformLocation(s,"viewMatrix"),q.projectionMatrix=Ce.getUniformLocation(s,"projectionMatrix"),q.cameraPosition=Ce.getUniformLocation(s,"cameraPosition");for(G in q.lowPartCameraPosition=Ce.getUniformLocation(s,"lowPartCameraPosition"),q.cameraConstant=Ce.getUniformLocation(s,"cameraConstant"),q.billCameraPos=Ce.getUniformLocation(s,"billCameraPos"),q.billCameraLookAt=Ce.getUniformLocation(s,"billCameraLookAt"),q.billCameraUp=Ce.getUniformLocation(s,"billCameraUp"),q.invViewMatrix=Ce.getUniformLocation(s,"invViewMatrix"),q.invProjectionMatrix=Ce.getUniformLocation(s,"invProjectionMatrix"),q.viewInfo=Ce.getUniformLocation(s,"viewInfo"),q.currentNormalStencilDepth=Ce.getUniformLocation(s,"currentNormalStencilDepth"),q.currentTexCoord=Ce.getUniformLocation(s,"currentTexCoord"),q.currentRGBADepth=Ce.getUniformLocation(s,"currentRGBADepth"),u)u[G]._array&&(u[G]._array=void 0),q[G]=Ce.getUniformLocation(s,G);if(r.PDSFX&&(q.viewInvMatrix=Ce.getUniformLocation(s,"viewInvMatrix"),q.projectionInvMatrix=Ce.getUniformLocation(s,"projectionInvMatrix"),q.viewInvTranspMatrix=Ce.getUniformLocation(s,"viewInvTranspMatrix"),q.nearFarLogFactor=Ce.getUniformLocation(s,"nearFarLogFactor"),q.viewportSize=Ce.getUniformLocation(s,"viewportSize"),r.PDSFX_hasAlbedo&&(q.diffuse=Ce.getUniformLocation(s,"_DSalbedo")),r.PDSFX_hasHalfWidth&&(q.halfWidth=Ce.getUniformLocation(s,"_DShalfWidth")),r.PDSFX_hasEmissive&&(q.emissive=Ce.getUniformLocation(s,"_DSemissive")),r.PDSFX_hasSpecular&&(q.specular=Ce.getUniformLocation(s,"_DSspecular")),r.PDSFX_hasOpacity&&(q.opacity=Ce.getUniformLocation(s,"_DSopacity")),r.pdsfxUniforms))for(var K in r.pdsfxUniforms)q[K]=Ce.getUniformLocation(s,K);var J=R.attributes;r.PDSFX?(J.position=Ce.getAttribLocation(s,"_DSposition"),J.normal=Ce.getAttribLocation(s,"_DSnormal"),J.uv=Ce.getAttribLocation(s,"_DSuv"),J.uv2=Ce.getAttribLocation(s,"_DSuv2"),J.lineDistance=Ce.getAttribLocation(s,"_DSlineDistance"),J.previousPos=Ce.getAttribLocation(s,"_DSpreviousPos"),J.followingPos=Ce.getAttribLocation(s,"_DSfollowingPos")):(r.compressedVertices?J.position=Ce.getAttribLocation(s,"_DSposition"):J.position=Ce.getAttribLocation(s,"position"),r.compressedNormals?J.normal=Ce.getAttribLocation(s,"_DSnormal"):J.normal=Ce.getAttribLocation(s,"normal"),r.compressedUVs?J.uv=Ce.getAttribLocation(s,"_DSuv"):J.uv=Ce.getAttribLocation(s,"uv"),r.compressedUVs?J.uv2=Ce.getAttribLocation(s,"_DSuv2"):J.uv2=Ce.getAttribLocation(s,"uv2"),J.lineDistance=Ce.getAttribLocation(s,"lineDistance"),J.previousPos=Ce.getAttribLocation(s,"previousPos"),J.followingPos=Ce.getAttribLocation(s,"followingPos"));J.tangent=Ce.getAttribLocation(s,"_DStangent"),J.binormal=Ce.getAttribLocation(s,"_DSbinormal"),J.patternStartEnd=Ce.getAttribLocation(s,"patternStartEnd"),r.compressedColors?J.color=Ce.getAttribLocation(s,"_DScolor"):J.color=Ce.getAttribLocation(s,"color");J.skinIndex=Ce.getAttribLocation(s,"skinIndex"),J.skinWeight=Ce.getAttribLocation(s,"skinWeight"),J.sideExtrusion=Ce.getAttribLocation(s,"sideExtrusion"),R.uvOrBinOrTan=(J.uv>=0||J.binormal>=0||J.tangent>=0)&&r.mappingType<1;var Q=R.instanceAttributes;for(W in d)Q[W]=Ce.getAttribLocation(s,W);function te(e){if(e.name.startsWith("_DS"))return!0;return["binormal","color","followingPos","lineDistance","normal","position","previousPos","patternStartEnd","sideExtrusion","skinIndex","skinWeight","tangent","uv","uv2","specialMeshIds","specialMeshPicking"].includes(e.name)}function ie(e){return Object.keys(R.instanceAttributes).includes(e.name)}Q.specialMeshIds=Ce.getAttribLocation(s,"specialMeshIds"),Q.specialMeshPicking=Ce.getAttribLocation(s,"specialMeshPicking");const re=Ce.getProgramParameter(s,Ce.ACTIVE_ATTRIBUTES);for(let e=0;e<re;e++){const t=Ce.getActiveAttrib(s,e);te(t)||(ie(t)||(J[t.name]=Ce.getAttribLocation(s,t.name)))}return R.id=Ke++,Ye.push({program:R,code:o,usedTimes:1,prefix_vertex:S,prefix_fragment:y,pdsfx_fragment:P,pdsfx_vertex:M,shaderID:t,pdsfx:r.PDSFX}),Me.programs=Ye.length,R}(S,t,y),D!==t.program&&t._notifyDLtoBeSortedNextFrame(),f.addProgram(a,t.program,this.shaderVersions[this.currentRendererMode]),!t.loadUniforms)for(l in null===t.uniformsList&&(t.uniformsList=new Map),t.uniforms){t.program.uniformLocations[l]&&((P=t.uniforms[l]).sceneUniform||P.clipPlanesUniform||t.uniformsList.set(l,P))}d=_},this.loadObjectUniforms=function(t,i,r,n,a,s,o){if(!i.isCurvedPipe){if(t.quantizedVector&&Ce.uniform3f(t.quantizedVector,r.quantizedVector.x,r.quantizedVector.y,r.quantizedVector.z),t.offsetVector&&Ce.uniform3f(t.offsetVector,r.offsetVector.x,r.offsetVector.y,r.offsetVector.z),t.lightMap&&(o&&o._lightMap?(this.loadTexture(Ce,t.lightMap,o._lightMap.texture),Ce.uniformMatrix3fv(t.lightMapUvTransform,!1,this.float32Matrix3x3Temp.setDoubles(o._lightMap.uvTransform.elements)),Ce.uniform1i(t.lightMapUvSlot,o._lightMap.uvSlot?o._lightMap.uvSlot:1)):(this.loadTexture(Ce,t.lightMap,r.lightMap),Ce.uniformMatrix3fv(t.lightMapUvTransform,!1,this.float32Matrix3x3Temp.setDoubles((i.lightMapData.lightMapUvTransform?i.lightMapData.lightMapUvTransform:this._dummyMat3).elements)),Ce.uniform1i(t.lightMapUvSlot,i.lightMapData.lightMapUvSlot?i.lightMapData.lightMapUvSlot:1))),t.displacementRadius&&Ce.uniform1f(t.displacementRadius,i.worldRadius),t.billboardType){var l=i._billboardData;Ce.uniform1i(t.billboardType,l.type),l.type>1&&(l.axis?Ce.uniform3f(t.billboardAxis,l.axis.x,l.axis.y,l.axis.z):Ce.uniform3f(t.billboardAxis,0,0,1)),l.rotation?(Ce.uniform1i(t.billboardRotationEnabled,1),Ce.uniformMatrix4fv(t.billboardRotation,!1,this.float32Matrix4x3Temp.setDoubles(l.rotation.elements))):Ce.uniform1i(t.billboardRotationEnabled,0)}if(t.skinningMap?this.loadTexture(Ce,t.skinningMap,i._skinning.skinningMap):t.skinningInstancingMaps&&this.loadTextureArray(Ce,n.program,t.skinningInstancingMaps,"skinningInstancingMaps",i._skinningInstancing.skinningInstancingMaps),nt!==i.matrixWorld){if(t.fixedSizeCenterRatio?Ce.uniform4f(t.fixedSizeCenterRatio,i._ratioData.center.x,i._ratioData.center.y,i._ratioData.center.z,i._ratioData.ratio):t.fixedSizeRatio&&Ce.uniform1f(t.fixedSizeRatio,i._ratioData.ratio),t.decalStencilValue&&i._decalData&&(Ce.uniform1f(t.decalStencilValue,i._decalData.stencilID),Ce.uniform1f(t.decalExplicitUv,i._decalData.explicitUv)),t.objectColorBufferType&&Ce.uniform1f(t.objectColorBufferType,i._vertexColors),t.modelViewMatrix&&(i._modelViewMatrix||(i._modelViewMatrix=new e._Float32Matrix4,i._modelViewMatrix._multiplyMatricesMV(a.matrixWorldInverse,i.matrixWorld)),Ce.uniformMatrix4fv(t.modelViewMatrix,!1,i._modelViewMatrix.elements)),t.modelMatrix&&Ce.uniformMatrix4fv(t.modelMatrix,!1,i._mElements),t.modelInvRotMatrix){if(!i._modelInvRotMatrix){var c=(new e.Matrix4).getInverse(i.matrixWorld);i._modelInvRotMatrix=(new e.Matrix4).extractRotation(c)}Ce.uniformMatrix4fv(t.modelInvRotMatrix,!1,this.float32Matrix4x3Temp.setDoubles(i._modelInvRotMatrix.elements))}n._PDSFXData&&n._PDSFXData.PDSFX&&(t.modelInvTranspMatrix&&(null===i.modelInvTranspMatrix&&(i.modelInvTranspMatrix=(new e.Matrix4).getInverse(i.matrixWorld).transpose()),Ce.uniformMatrix4fv(t.modelInvTranspMatrix,!1,this.float32Matrix4x3Temp.setDoubles(i.modelInvTranspMatrix.elements))),t.modelViewInvTranspMatrix&&(null===i.modelViewInvTranspMatrix&&(i.modelViewInvTranspMatrix=(new e._Float32Matrix4).multiplyMatricesAndInverse(a.matrixWorldInverse,i.matrixWorld).transpose()),Ce.uniformMatrix4fv(t.modelViewInvTranspMatrix,!1,i.modelViewInvTranspMatrix.elements))),t.modelViewInvMatrix&&(null===i.modelViewInvMatrix&&(i.modelViewInvMatrix=(new e._Float32Matrix4).multiplyMatricesAndInverse(a.matrixWorldInverse,i.matrixWorld)),Ce.uniformMatrix4fv(t.modelViewInvMatrix,!1,i.modelViewInvMatrix.elements)),t.normalMatrix&&Ce.uniformMatrix3fv(t.normalMatrix,!1,this.float32Matrix3x3Temp.setDoubles(i._normalMatrix.elements)),nt=i.matrixWorld}if(t.backgroundViewModeControl){const e=this._backgroundColor?this._backgroundColor.r:0,r=this._backgroundColor?this._backgroundColor.g:0,n=this._backgroundColor?this._backgroundColor.b:0;Ce.uniform4f(t.backgroundViewModeControl,e,r,n,i.applyBackgroundViewMode?1:0)}t.backgroundViewModeNearFar&&Ce.uniform2f(t.backgroundViewModeNearFar,a.near,a.far),Pe.objectUniformCalls++}},this._load_MM=function(e,t,i,r,n,a,s){nt!==t.matrixWorld&&(Ce.uniformMatrix4fv(e.modelMatrix,!1,t._mElements),nt=t.matrixWorld,Pe.objectUniformCalls++)},this._load_MM_NM=function(e,t,i,r,n,a,s){nt!==t.matrixWorld&&(Ce.uniformMatrix4fv(e.modelMatrix,!1,t._mElements),Ce.uniformMatrix3fv(e.normalMatrix,!1,this.float32Matrix3x3Temp.setDoubles(t._normalMatrix.elements)),nt=t.matrixWorld,Pe.objectUniformCalls++)},this._load_MVM=function(t,i,r,n,a,s,o){nt!==i.matrixWorld&&(i._modelViewMatrix||(i._modelViewMatrix=new e._Float32Matrix4,i._modelViewMatrix._multiplyMatricesMV(a.matrixWorldInverse,i.matrixWorld)),Ce.uniformMatrix4fv(t.modelViewMatrix,!1,i._modelViewMatrix.elements),nt=i.matrixWorld,Pe.objectUniformCalls++)},this._load_MVM_NM=function(t,i,r,n,a,s,o){nt!==i.matrixWorld&&(i._modelViewMatrix||(i._modelViewMatrix=new e._Float32Matrix4,i._modelViewMatrix._multiplyMatricesMV(a.matrixWorldInverse,i.matrixWorld)),Ce.uniformMatrix4fv(t.modelViewMatrix,!1,i._modelViewMatrix.elements),Ce.uniformMatrix3fv(t.normalMatrix,!1,this.float32Matrix3x3Temp.setDoubles(i._normalMatrix.elements)),nt=i.matrixWorld,Pe.objectUniformCalls++)},this._load_MM_MVM=function(t,i,r,n,a,s,o){nt!==i.matrixWorld&&(i._modelViewMatrix||(i._modelViewMatrix=new e._Float32Matrix4,i._modelViewMatrix._multiplyMatricesMV(a.matrixWorldInverse,i.matrixWorld)),Ce.uniformMatrix4fv(t.modelViewMatrix,!1,i._modelViewMatrix.elements),Ce.uniformMatrix4fv(t.modelMatrix,!1,i._matrixWorldForDoubleGPU.elements),nt=i.matrixWorld,Pe.objectUniformCalls++)},this._load_MM_MVM_NM=function(t,i,r,n,a,s,o){nt!==i.matrixWorld&&(i._modelViewMatrix||(i._modelViewMatrix=new e._Float32Matrix4,i._modelViewMatrix._multiplyMatricesMV(a.matrixWorldInverse,i.matrixWorld)),Ce.uniformMatrix4fv(t.modelViewMatrix,!1,i._modelViewMatrix.elements),Ce.uniformMatrix4fv(t.modelMatrix,!1,i._matrixWorldForDoubleGPU.elements),Ce.uniformMatrix3fv(t.normalMatrix,!1,this.float32Matrix3x3Temp.setDoubles(i._normalMatrix.elements)),nt=i.matrixWorld,Pe.objectUniformCalls++)},this._dummyMat3=new e.Matrix3,this._dummyMat4=new e.Matrix4,this.loadMatrix3=function(e,t,i){e.uniformMatrix3fv(t,!1,this.float32Matrix3x3Temp.setDoubles(i.elements))},this.loadMatrix4=function(e,t,i){e.uniformMatrix4fv(t,!1,this.float32Matrix4x4Temp.setDoubles(i.elements))},this.loadMatrix4x3=function(e,t,i){e.uniformMatrix4fv(t,!1,this.float32Matrix4x3Temp.setDoubles(i.elements))},this.loadMatrixFloat4=function(e,t,i){e.uniformMatrix4fv(t,!1,i.elements)},this.loadMatrix4Array=function(e,t,i,r,n){var a=t.flattenedUniformArrays;void 0!==a[r]&&a[r].length===16*n.length||(a[r]=new Float32Array(16*n.length));for(var s=0,o=n.length;s<o;s++)n[s]&&n[s].flattenToArrayOffset(a[r],16*s);var l=a[r];l.length>0&&e.uniformMatrix4fv(i,!1,l)},this.loadVector2Array=function(e,t,i,r,n){var a,s=t.flattenedUniformArrays;void 0===s[r]&&(s[r]=new Float32Array(2*n.length));for(var o=0,l=n.length;o<l;o++)a=2*o,s[r][a]=n[o].x,s[r][a+1]=n[o].y;e.uniform2fv(i,s[r])},this.loadTexture=function(t,i,r){var n=r,a=ji();t.uniform1i(i,a),n&&(n instanceof e.WebGLRenderTargetCube?er(n,a):this.setTexture(n,a))},this.loadTextureArray=function(e,t,i,r,n){var a,s,o,l,c=t.flattenedUniformArrays;for(void 0===c[r]&&(c[r]=[]),a=0,s=n.length;a<s;a++)c[r][a]=ji();for(Ce.uniform1iv(i,c[r]),a=0,s=n.length;a<s;a++)o=n[a],l=c[r][a],o&&this.setTexture(o,l)},this.loadTextureCubeArray=function(e,t,i,r,n){var a,s,o,l,c=t.flattenedUniformArrays;for(void 0===c[r]&&(c[r]=[]),a=0,s=n.length;a<s;a++)c[r][a]=ji();for(Ce.uniform1iv(i,c[r]),a=0,s=n.length;a<s;a++)o=n[a],l=c[r][a],o&&er(o,l)},this.loadGASUniforms=function(e,t,i,r,n){if(i.diffuse){var a=n&&t.useGASColor?n.color:t.color,s=r&&r.getColor();s&&(a=N.set(r.getColor())),this.gammaInput&&(a=N.copyToLinear(a,this.simpleGamma)),e.uniform3f(i.diffuse,a.r,a.g,a.b),i._colorOverride&&e.uniform1i(i._colorOverride,s?1:0)}if(i.opacity){var o=n&&t.useGASOpacity?n.opacity:t.opacity;r&&null!==r.getOpacity()&&(o=r.getOpacity()),this.useRenderPriorityOpacity&&(o=this.computeRenderPriorityOpacity(o,r)),e.uniform1f(i.opacity,o)}},this.loadUniformsCommon=function(t,i,r,n,a,s){if(this.loadGASUniforms(t,i,r,n,a),r.colorBufferType&&Ce.uniform1f(r.colorBufferType,i.vertexColors),r.envMapExposureSpecular&&t.uniform1f(r.envMapExposureSpecular,i.envMapExposureSpecular||0==i.envMapExposureSpecular?i.envMapExposureSpecular:1),r.envMapExposureDiffuse&&t.uniform1f(r.envMapExposureDiffuse,i.envMapExposureDiffuse||0==i.envMapExposureDiffuse?i.envMapExposureDiffuse:1),r.ambienceMatrix){var o=i.ambienceMatrix?i.ambienceMatrix:this._dummyMat4;Ce.uniformMatrix4fv(r.ambienceMatrix,!1,this.float32Matrix4x4Temp.setDoubles(o.elements))}var l;if(r.flipEnvMap&&t.uniform1f(r.flipEnvMap,i.flipEnvMap||0==i.flipEnvMap?i.flipEnvMap:1),r.reflectivity&&t.uniform1f(r.reflectivity,i.reflectivity||0==i.reflectivity?i.reflectivity:1),r.refractionRatio&&t.uniform1f(r.refractionRatio,i.refractionRatio||0==i.refractionRatio?i.refractionRatio:.98),r.morphTargetInfluences&&t.uniform1f(r.morphTargetInfluences,i.morphTargetInfluences?i.morphTargetInfluences:0),r.combine&&t.uniform1i(r.combine,i.combine?i.combine:0),r.renderIteration&&t.uniform1i(r.renderIteration,this.renderIteration?this.renderIteration:0),i.map?l=i.map:i.specularMap?l=i.specularMap:i.normalMap?l=i.normalMap:i.bumpMap&&(l=i.bumpMap),void 0!==l){var c=l.offset||{x:0,y:0},h=l.repeat||{x:1,y:1};r.offsetBumpMap&&t.uniform2f(r.offsetBumpMap,c.x,c.y),r.repeatBumpMap&&t.uniform2f(r.repeatBumpMap,h.x,h.y)}else r.offsetBumpMap&&t.uniform2f(r.offsetBumpMap,0,0),r.repeatBumpMap&&t.uniform2f(r.repeatBumpMap,1,1);r.map&&this.loadTexture(t,r.map,i.map),r.specularMap&&this.loadTexture(t,r.specularMap,i.specularMap),r.reflectivityEnvMap&&this.loadTexture(t,r.reflectivityEnvMap,i.reflectivityEnvMap),r.envMap&&this.loadTexture(t,r.envMap,i.envMap),r.refractionRatioMap&&this.loadTexture(t,r.refractionRatioMap,i.refractionRatioMap),s&&s._mappingOperator||i._loadMappingInfo(i,this,t,r),i.map&&i.map.hdr&&i.map.image?r.mapHDRSize&&t.uniform2f(r.mapHDRSize,parseInt(i.map.image.width),parseInt(i.map.image.height)):r.mapHDRSize&&t.uniform2f(r.mapHDRSize,2048,1024),i.envMap&&i.envMap.hdr&&i.envMap.image?(r.envMapHDRSize&&t.uniform2f(r.envMapHDRSize,parseInt(i.envMap.image.width),parseInt(i.envMap.image.height)),r.useRefract&&t.uniform1i(r.useRefract,i.envMap&&i.envMap.mapping instanceof e.CubeRefractionMapping)):(r.envMapHDRSize&&t.uniform2f(r.envMapHDRSize,2048,1024),r.useRefract&&t.uniform1i(r.useRefract,0))},this.loadUniformsBump=function(e,t,i){t.bumpMap&&(i.bumpScale&&e.uniform1f(i.bumpScale,t.bumpScale?t.bumpScale:1),i.bumpMap&&this.loadTexture(e,i.bumpMap,t.bumpMap))},this.loadUniformsDepthLayer=function(e,t,i){},this.loadUniformsNormalMap=function(e,t,i){t.normalMap&&(i.normalScale&&(t.normalScale?e.uniform2f(i.normalScale,t.normalScale.x,t.normalScale.y):e.uniform2f(i.normalScale,1,1)),i.normalMap&&this.loadTexture(e,i.normalMap,t.normalMap))},this.loadUniformsLights=function(e,t,i,r,n){t.ambientLightColor&&i.ambient.length>0&&e.uniform3fv(t.ambientLightColor,i.ambient),n?t.directionalLightColor&&i.directional.colorsPhong.length>0&&e.uniform3fv(t.directionalLightColor,i.directional.colorsPhong):t.directionalLightColor&&i.directional.colors.length>0&&e.uniform3fv(t.directionalLightColor,i.directional.colors),t.directionalLightDirection&&i.directional.positions.length>0&&e.uniform3fv(t.directionalLightDirection,i.directional.positions),t.directionalIBLLightColor&&i.directionalIBL.colors.length>0&&e.uniform3fv(t.directionalIBLLightColor,i.directionalIBL.colors),t.directionalIBLLightDirection&&i.directionalIBL.positions.length>0&&e.uniform3fv(t.directionalIBLLightDirection,i.directionalIBL.positions),t.directionalPhongLightColor&&i.directionalPhong.colors.length>0&&e.uniform3fv(t.directionalPhongLightColor,i.directionalPhong.colors),t.directionalPhongLightDirection&&i.directionalPhong.positions.length>0&&e.uniform3fv(t.directionalPhongLightDirection,i.directionalPhong.positions),n?t.pointLightColor&&i.point.colorsPhong.length>0&&e.uniform3fv(t.pointLightColor,i.point.colorsPhong):t.pointLightColor&&i.point.colors.length>0&&e.uniform3fv(t.pointLightColor,i.point.colors),t.pointLightPosition&&i.point.positions.length>0&&e.uniform3fv(t.pointLightPosition,i.point.positions),t.pointLightPhysicalAttenuation&&i.point.physicalAttenuations.length>0&&e.uniform1iv(t.pointLightPhysicalAttenuation,i.point.physicalAttenuations),t.pointLightDistance&&i.point.distances.length>0&&e.uniform1fv(t.pointLightDistance,i.point.distances),n?t.spotLightColor&&i.spot.colorsPhong.length>0&&e.uniform3fv(t.spotLightColor,i.spot.colorsPhong):t.spotLightColor&&i.spot.colors.length>0&&e.uniform3fv(t.spotLightColor,i.spot.colors),t.spotLightPosition&&i.spot.positions.length>0&&e.uniform3fv(t.spotLightPosition,i.spot.positions),t.spotLightDirection&&i.spot.directions.length>0&&e.uniform3fv(t.spotLightDirection,i.spot.directions),t.spotLightPhysicalAttenuation&&i.spot.physicalAttenuations.length>0&&e.uniform1iv(t.spotLightPhysicalAttenuation,i.spot.physicalAttenuations),t.spotLightDistance&&i.spot.distances.length>0&&e.uniform1fv(t.spotLightDistance,i.spot.distances),t.spotLightAngleCos&&i.spot.anglesCos.length>0&&e.uniform1fv(t.spotLightAngleCos,i.spot.anglesCos),t.spotLightInnerAngleCos&&i.spot.innerAnglesCos.length>0&&e.uniform1fv(t.spotLightInnerAngleCos,i.spot.innerAnglesCos),t.iesLightColor&&i.ies.colors.length>0&&e.uniform3fv(t.iesLightColor,i.ies.colors),t.iesLightPosition&&i.ies.positions.length>0&&e.uniform3fv(t.iesLightPosition,i.ies.positions),t.iesLightDistance&&i.ies.distances.length>0&&e.uniform1fv(t.iesLightDistance,i.ies.distances),t.iesLightTexture&&i.ies.iesLightTexture.length>0&&this.loadTextureArray(e,r,t.iesLightTexture,"iesLightTexture",i.ies.iesLightTexture),t.matrixWorldInv&&this.loadMatrix4Array(e,r,t.matrixWorldInv,"matrixWorldInv",i.ies.matrixWorldInv),t.sphereLightColor&&i.sphere.colors.length>0&&e.uniform3fv(t.sphereLightColor,i.sphere.colors),t.sphereLightPosition&&i.sphere.positions.length>0&&e.uniform3fv(t.sphereLightPosition,i.sphere.positions),t.sphereLightData&&i.sphere.data.length>0&&e.uniform3fv(t.sphereLightData,i.sphere.data),t.diskLightColor&&i.disk.colors.length>0&&e.uniform3fv(t.diskLightColor,i.disk.colors),t.diskLightNormal&&i.disk.normals.length>0&&e.uniform3fv(t.diskLightNormal,i.disk.normals),t.diskLightUp&&i.disk.ups.length>0&&e.uniform3fv(t.diskLightUp,i.disk.ups),t.diskLightPosition&&i.disk.positions.length>0&&e.uniform3fv(t.diskLightPosition,i.disk.positions),t.diskLightData&&i.disk.data.length>0&&e.uniform3fv(t.diskLightData,i.disk.data),t.tubeLightColor&&i.tube.colors.length>0&&e.uniform3fv(t.tubeLightColor,i.tube.colors),t.tubeLightRight&&i.tube.rights.length>0&&e.uniform3fv(t.tubeLightRight,i.tube.rights),t.tubeLightPosition&&i.tube.positions.length>0&&e.uniform3fv(t.tubeLightPosition,i.tube.positions),t.tubeLightData&&i.tube.data.length>0&&e.uniform3fv(t.tubeLightData,i.tube.data),t.areaLightColor&&i.area.colors.length>0&&e.uniform3fv(t.areaLightColor,i.area.colors),t.areaLightPosition&&i.area.positions.length>0&&e.uniform3fv(t.areaLightPosition,i.area.positions),t.areaLightNormal&&i.area.normals.length>0&&e.uniform3fv(t.areaLightNormal,i.area.normals),t.areaLightUp&&i.area.ups.length>0&&e.uniform3fv(t.areaLightUp,i.area.ups),t.areaLightData&&i.area.data.length>0&&e.uniform3fv(t.areaLightData,i.area.data),(i.area.colors.length>0||i.tube.colors.length>0||i.disk.colors.length>0||i.sphere.colors.length>0)&&(t.precomputedAreaGGX1texture&&this.loadTexture(e,t.precomputedAreaGGX1texture,this.precomputedAreaGGX1texture),t.precomputedAreaGGX2texture&&this.loadTexture(e,t.precomputedAreaGGX2texture,this.precomputedAreaGGX2texture),t.precomputedAreaAshikmintexture&&this.loadTexture(e,t.precomputedAreaAshikmintexture,this.precomputedAreaAshikmintexture),t.precomputedAreaEsteveztexture&&this.loadTexture(e,t.precomputedAreaEsteveztexture,this.precomputedAreaEsteveztexture),t.precomputedAreaBeckmanntexture&&this.loadTexture(e,t.precomputedAreaBeckmanntexture,this.precomputedAreaBeckmanntexture))},this.loadUniformsShadow=function(t,i,r,n,a){if(!b&&!E){var s=i.uniformLocations;if(s.shadowMatrix){var o=0,l=[],c=[],h=[],u=[],d=[],p=[],f=[],m=[],g=[],v=[];this.shadowMapType===e.PCFPoissonShadowMap&&this.loadVector2Array(t,i,s.poissonDisk,"poissonDisk",U);for(var S=0,_=r.length;S<_;S++){if((N=r[S])instanceof e.SpotLight||N instanceof e.DirectionalLight&&!N.shadowCascade&&(!N.isVirtual||this.shadowMapCascade)){if(!N.castShadow)continue;if(N._sortKey===Q&&!a._needsIBLLightExtraction())continue;l[o]=N.shadowMap,c[o]=N.transparentShadowMap,h[o]=N.shadowMapSize,p[o]=N.shadowDarkness,d[o]=N.shadowCamera.far,u[o]=N.shadowCamera.near,f[o]=N.shadowBias,m[o]=N.shadowMatrix;var y=(new e.Vector3).getPositionFromMatrix(N.shadowCamera.matrixWorld);if(N.isVirtual){var x=e._SplitFloat32PositiveError(y.x),M=e._SplitFloat32PositiveError(y.y),P=e._SplitFloat32PositiveError(y.z);g[3*o]=x.high,g[3*o+1]=M.high,g[3*o+2]=P.high,v[3*o]=x.low,v[3*o+1]=M.low,v[3*o+2]=P.low}else g[3*o]=y.x,g[3*o+1]=y.y,g[3*o+2]=y.z,v[3*o]=e.SplitFloat32(y.x).low,v[3*o+1]=e.SplitFloat32(y.y).low,v[3*o+2]=e.SplitFloat32(y.z).low;o++}}s.shadowMap&&this.loadTextureArray(t,i,s.shadowMap,"shadowMap",l),s.transparentShadowMap&&(this.loadTextureArray(t,i,s.transparentShadowMap,"transparentShadowMap",c),s.directionalLightColorNoIntensity&&n.directional.colorsNoIntensity.length>0&&t.uniform3fv(s.directionalLightColorNoIntensity,n.directional.colorsNoIntensity),s.spotLightColorNoIntensity&&n.spot.colorsNoIntensity.length>0&&t.uniform3fv(s.spotLightColorNoIntensity,n.spot.colorsNoIntensity)),s.shadowMapSize&&this.loadVector2Array(t,i,s.shadowMapSize,"shadowMapSize",h),s.shadowDarkness&&t.uniform1fv(s.shadowDarkness,p),s.shadowBias&&t.uniform1fv(s.shadowBias,f),s.shadowMapNear&&t.uniform1fv(s.shadowMapNear,u),s.shadowMapFar&&t.uniform1fv(s.shadowMapFar,d),s.shadowCameraPosition&&t.uniform3fv(s.shadowCameraPosition,g),s.lowPartShadowCameraPosition&&t.uniform3fv(s.lowPartShadowCameraPosition,v),this.loadMatrix4Array(t,i,s.shadowMatrix,"shadowMatrix",m)}if(s.shadowMapCube){var C=0,D=[],w=[],T=[],A=[],I=[],R=[],L=[],O=[];for(S=0,_=r.length;S<_;S++){var N;if((N=r[S])instanceof e.PointLight){if(!N.castShadow)continue;D[C]=N.shadowMap,w[C]=N.transparentShadowMap,T[C]=N.shadowDarkness,A[C]=N.shadowBias,R[C]=N.shadowCameraNear,L[C]=N.shadowCameraFar,O[C]=N.shadowMapWidth,N.setupShadowPositions(I),C++}}this.loadTextureCubeArray(t,i,s.shadowMapCube,"shadowMapCube",D),s.transparentShadowMapCube&&(this.loadTextureCubeArray(t,i,s.transparentShadowMapCube,"",w),s.pointLightColorNoIntensity&&n.point.colorsNoIntensity.length>0&&t.uniform3fv(s.pointLightColorNoIntensity,n.point.colorsNoIntensity)),s.shadowDarknessCube&&t.uniform1fv(s.shadowDarknessCube,T),s.shadowFarCube&&t.uniform1fv(s.shadowFarCube,L),s.shadowNearCube&&t.uniform1fv(s.shadowNearCube,R),s.shadowBiasCube&&t.uniform1fv(s.shadowBiasCube,A),s.shadowPointPosition&&t.uniform3fv(s.shadowPointPosition,I),s.shadowMapSizeCube&&t.uniform1fv(s.shadowMapSizeCube,O)}}},this.loadUniformsPostProcess=function(e,t){var i=t.uniformLocations;this.inlinedPostProcess.activated&&(i.brightness&&e.uniform1f(i.brightness,this.inlinedPostProcess.brightness),i.crushblacks&&e.uniform1f(i.crushblacks,this.inlinedPostProcess.crushblacks),i.burnhighlights&&e.uniform1f(i.burnhighlights,this.inlinedPostProcess.burnhighlights),i.saturation&&e.uniform1f(i.saturation,this.inlinedPostProcess.saturation),i.colorCorrection&&e.uniform3f(i.colorCorrection,this.inlinedPostProcess.colorCorrection.x,this.inlinedPostProcess.colorCorrection.y,this.inlinedPostProcess.colorCorrection.z))},this.loadClippingUniforms=function(e,t){var i=this._clipPlanesState.uniforms;if(t.nbClipPlanes&&e.uniform1i(t.nbClipPlanes,i.nbClipPlanes.value),0!==i.nbClipPlanes.value&&(t.clipPlaneEquations&&i.clipPlaneEquations.value.length>0&&e.uniform4fv(t.clipPlaneEquations,i.clipPlaneEquations.value),t.clipPlaneActive&&i.clipPlaneActive.value.length>0&&e.uniform1iv(t.clipPlaneActive,i.clipPlaneActive.value),t.clipFrontOpacity&&e.uniform1f(t.clipFrontOpacity,i.clipFrontOpacity.value),t.clipBackOpacity&&e.uniform1f(t.clipBackOpacity,i.clipBackOpacity.value)),t.polygonSize&&e.uniform1iv(t.polygonSize,i.polygonSize.value),i.polygonSize.value&&0!==i.polygonSize.value[0]?(t.polygonPoints&&this.loadTexture(e,t.polygonPoints,i.polygonPoints.value),t.extrusionPlaneU&&e.uniform3fv(t.extrusionPlaneU,i.extrusionPlaneU.value),t.extrusionPlaneV&&e.uniform3fv(t.extrusionPlaneV,i.extrusionPlaneV.value)):t.polygonPoints&&this.loadTexture(e,t.polygonPoints,this._dummyTexture),t.scissorSize){var r=i.scissorSize.value;r&&0===r.length&&(r=[0]),e.uniform1iv(t.scissorSize,r)}t.scissorPoints&&(0!==i.scissorSize.value?this.loadTexture(e,t.scissorPoints,i.scissorPoints.value):this.loadTexture(e,t.scissorPoints,this._dummyTexture)),t.cylinderClipZone&&e.uniform1i(t.cylinderClipZone,i.cylinderClipZone.value),0!==i.cylinderClipZone.value&&(t.cylinderCenter&&e.uniform3f(t.cylinderCenter,i.cylinderCenter.value.x,i.cylinderCenter.value.y,i.cylinderCenter.value.z),t.cylinderAxisU&&e.uniform3f(t.cylinderAxisU,i.cylinderAxisU.value.x,i.cylinderAxisU.value.y,i.cylinderAxisU.value.z),t.cylinderAxisV&&e.uniform3f(t.cylinderAxisV,i.cylinderAxisV.value.x,i.cylinderAxisV.value.y,i.cylinderAxisV.value.z))},this.setDisableColorWrite=function(e){this.disableColorWrite=e},this.setDisableDepthWrite=function(e){this.disableDepthWrite=e},this.setDisableDepthTest=function(e){this.disableDepthTest=e},this.setEnableStencilWrite=function(e){this.enableStencilWrite=e},this.setDisableBackFaceCulling=function(e){this.disableBackFaceCulling=e},this.setFaceCulling=function(t,i){ht=0,ct=void 0,lt=void 0,t===e.CullFaceNone?(Ce.disable(Ce.CULL_FACE),lt=!0):(i===e.FrontFaceDirectionCW?Ce.frontFace(Ce.CW):Ce.frontFace(Ce.CCW),t===e.CullFaceBack?Ce.cullFace(Ce.BACK):t===e.CullFaceFront?Ce.cullFace(Ce.FRONT):Ce.cullFace(Ce.FRONT_AND_BACK),Ce.enable(Ce.CULL_FACE),lt=!1)},this._hasClippingWithoutCapping=function(){return this.maxPolyLineSize>0?!this.useBackfaceCullingWithNoCapping&&!this.useCustomCappingForClipPolyline:this.useClippingCylinder&&this._clipPlanesState.value?!this.useBackfaceCullingWithNoCapping:!this.useBackfaceCullingWithNoCapping&&!(this.sectionCappingEnabled&&Ut.hasCapping)&&Ut.length>0},this.setMaterialFacesSimple=function(e,t,i,r){var n=e.doSetMaterialFaces,a=e.object,s=n.flipSided,o=n.doubleSided||this.disableBackFaceCulling||a._forceBackFacesOnSolid&&e.dg._dimension>=2&&!n.forceSide||r,l=a.orientation*i.orientation;lt!==o&&(o?Ce.disable(Ce.CULL_FACE):Ce.enable(Ce.CULL_FACE),lt=o),ct===s&&ht===l||(s?l>=0?Ce.frontFace(Ce.CW):Ce.frontFace(Ce.CCW):l>=0?Ce.frontFace(Ce.CCW):Ce.frontFace(Ce.CW),ht=l,ct=s)},this.setMaterialFacesSimpleDebug=function(t,i,r){var n=i.side===O.DoubleSide,a=i.side===O.BackSide,s=void 0!==t.object?t.object.orientation:1;void 0!==r&&(s*=r.orientation),t.object instanceof e.Mesh&&(s=-s),lt!==n&&(n?Ce.disable(Ce.CULL_FACE):Ce.enable(Ce.CULL_FACE),lt=n),ct===a&&ht===s||(a?s>=0?Ce.frontFace(Ce.CW):Ce.frontFace(Ce.CCW):s>=0?Ce.frontFace(Ce.CCW):Ce.frontFace(Ce.CW),ht=s,ct=a)},this.setMaterialFaces=function(e,t,i,r){var n=r&&3===t._bodyDim,a=e.side===O.BackSide,s=!n&&!a&&e.side!==O.FrontSide||this.disableBackFaceCulling,o=void 0!==t?t.orientation:1;void 0!==i&&(o*=i.orientation),lt!==s&&(s?Ce.disable(Ce.CULL_FACE):Ce.enable(Ce.CULL_FACE),lt=s),ct===a&&ht===o||(a?o>=0?Ce.frontFace(Ce.CW):Ce.frontFace(Ce.CCW):o>=0?Ce.frontFace(Ce.CCW):Ce.frontFace(Ce.CW),ht=o,ct=a)},this.setMaterialFacesDebug=function(t,i,r){var n=t.side===O.DoubleSide,a=t.side===O.BackSide,s=void 0!==i?i.orientation:1;void 0!==r&&(s*=r.orientation),i instanceof e.Mesh&&(s=-s),lt!==n&&(n?Ce.disable(Ce.CULL_FACE):Ce.enable(Ce.CULL_FACE),lt=n),ct===a&&ht===s||(a?s>=0?Ce.frontFace(Ce.CW):Ce.frontFace(Ce.CCW):s>=0?Ce.frontFace(Ce.CCW):Ce.frontFace(Ce.CW),ht=s,ct=a)},this.getDepthFunc=function(){return mt},this.setDepthFunc=function(e){mt!==e&&(Ce.depthFunc(e),mt=e)},this.setDepthTest=function(e){ft!==e&&(e?Ce.enable(Ce.DEPTH_TEST):Ce.disable(Ce.DEPTH_TEST),ft=e)},this.setColorWrite=function(e){gt!==e&&(e?Ce.colorMask(!0,!0,!0,!0):Ce.colorMask(!1,!1,!1,!1),gt=e)},this.setDepthWrite=function(e){vt!==e&&(Ce.depthMask(e),vt=e)},this.setStencilWrite=function(e){e!==St&&(e?Ce.stencilMask(255):Ce.stencilMask(0),St=e)},this.setPolygonOffset=function(e,t,i){_t!==e&&(e?Ce.enable(Ce.POLYGON_OFFSET_FILL):Ce.disable(Ce.POLYGON_OFFSET_FILL),_t=e),!e||yt===t&&xt===i||(Ce.polygonOffset(t,i),yt=t,xt=i)},this.setBlending=function(t,i,r,n){if(t!==Ce._oldBlending){switch(t){case e.NoBlending:Ce.disable(Ce.BLEND);break;case e.AdditiveBlending:Ce.enable(Ce.BLEND),Ce.blendEquation(Ce.FUNC_ADD),Ce.blendFunc(Ce.SRC_ALPHA,Ce.ONE);break;case e.SubtractiveBlending:Ce.enable(Ce.BLEND),Ce.blendEquation(Ce.FUNC_ADD),Ce.blendFunc(Ce.ZERO,Ce.ONE_MINUS_SRC_COLOR);break;case e.MultiplyBlending:Ce.enable(Ce.BLEND),Ce.blendEquation(Ce.FUNC_ADD),Ce.blendFunc(Ce.ZERO,Ce.SRC_COLOR);break;case e.CustomBlending:Ce.enable(Ce.BLEND);break;case e.NormalDepthBlending:Ce.enable(Ce.BLEND),Ce.blendEquationSeparate(Ce.FUNC_ADD,Ce.FUNC_ADD),Ce.blendFuncSeparate(Ce.ZERO,Ce.ONE,Ce.ONE,Ce.ZERO);break;case e.AlphaBlending:Ce.enable(Ce.BLEND),Ce.blendEquation(Ce.FUNC_ADD),Ce.blendFunc(Ce.SRC_ALPHA,Ce.ONE_MINUS_SRC_ALPHA);break;case e.GroundShadowBlending:Ce.enable(Ce.BLEND),Ce.blendEquationSeparate(Ce.FUNC_ADD,Ce.FUNC_ADD),Ce.blendFuncSeparate(Ce.ZERO,Ce.SRC_COLOR,Ce.ONE,Ce.ONE_MINUS_SRC_ALPHA);break;case e.TransparentShadowBlending:Ce.enable(Ce.BLEND),Ce.blendEquationSeparate(Ce.FUNC_ADD,Ce.FUNC_ADD),Ce.blendFuncSeparate(Ce.SRC_ALPHA,Ce.ONE_MINUS_SRC_ALPHA,Ce.ZERO,Ce.ONE_MINUS_SRC_ALPHA);break;case e.OITAccumBlending:Ce.enable(Ce.BLEND),Ce.blendEquation(Ce.FUNC_ADD),Ce.blendFunc(Ce.ONE,Ce.ONE);break;case e.OITRevealBlending:Ce.enable(Ce.BLEND),Ce.blendEquation(Ce.FUNC_ADD),Ce.blendFunc(Ce.ZERO,Ce.ONE_MINUS_SRC_COLOR);break;default:Ce.enable(Ce.BLEND),Ce.blendEquationSeparate(Ce.FUNC_ADD,Ce.FUNC_ADD),Ce.blendFuncSeparate(Ce.SRC_ALPHA,Ce.ONE_MINUS_SRC_ALPHA,Ce.ONE,Ce.ONE_MINUS_SRC_ALPHA)}Ce._oldBlending=t}t===e.CustomBlending?(i!==ut&&(Ce.blendEquation(nr(i)),ut=i),r===dt&&n===pt||(Ce.blendFunc(nr(r),nr(n)),dt=r,pt=n)):(ut=null,dt=null,pt=null)},this.initTexture=function(e,t){if(t)if(e.onUpdate){var i=e.onUpdate;e.onUpdate=function(){i(),t()}}else e.onUpdate=t;e._setupTexture(Ce,this,Qi,nr,ar,$i,fi,null,jt)},this.setTexture=function(t,i){t.onRequest&&t.onRequest();var r=t.isCubeMap&&t.isCubeMap();if(!r&&t.lods&&t.lods.length){var n=t.usedTexture;if(-1===n)t.lastUsedTexture=-1;else{var a=t.textures[n];a&&a.loadEndStatus===e.AssetLoadingStatus.READY?(a.__webglInit||this.__glResources__.textureLODPool.add({textureLOD:t,lod:n,size:a.image?4*a.image.width*a.image.height:0}),t.lastUsedTexture=n,t=a):-1!==t.lastUsedTexture&&(t=t.textures[t.lastUsedTexture])}this.__glResources__.textureLODPool.removeUnusedTextures()}if(t.needsUpdate)t._setupTexture(Ce,this,Qi,nr,ar,$i,fi,i,jt);else{if(!t.__webglTexture)return void this.setTexture(this._dummyTexture,i);Ce.activeTexture(Ce.TEXTURE0+i),Ce.bindTexture(r?Ce.TEXTURE_CUBE_MAP:Ce.TEXTURE_2D,t.__webglTexture)}},this.setRenderTarget=function(t){var i,r,n,a,s,o=t instanceof e.WebGLRenderTargetCube;if(t&&!t.__webglFramebuffer){void 0===t.depthBuffer&&(t.depthBuffer=!0),void 0===t.stencilBuffer&&(t.stencilBuffer=!0),t.addEventListener("dispose",mi),t.__webglTexture=Ce.createTexture(),Me.renderTargets++,this.__glResources__.renderTarget[t.uniqueID]=t;var l=Qi(t.width)&&Qi(t.height),c=nr(t.format),h=nr(t.type),u=ar(c,h,!0);if(o){t.__webglFramebuffer=[],t.__webglRenderbuffer=[],Ce.bindTexture(Ce.TEXTURE_CUBE_MAP,t.__webglTexture),$i(Ce.TEXTURE_CUBE_MAP,t,l);for(var d=0;d<6;d++)t.__webglFramebuffer[d]=Ce.createFramebuffer(),t.shareDepthFrom?t.__webglRenderbuffer[d]=t.shareDepthFrom.__webglRenderbuffer[d]:t.__webglRenderbuffer[d]=Ce.createRenderbuffer(),Ce.texImage2D(Ce.TEXTURE_CUBE_MAP_POSITIVE_X+d,0,u,t.width,t.height,0,c,h,null),tr(t.__webglFramebuffer[d],t,Ce.TEXTURE_CUBE_MAP_POSITIVE_X+d),t.shareDepthFrom?t.depthBuffer&&!t.stencilBuffer?Ce.framebufferRenderbuffer(Ce.FRAMEBUFFER,Ce.DEPTH_ATTACHMENT,Ce.RENDERBUFFER,t.__webglRenderbuffer[d]):t.depthBuffer&&t.stencilBuffer&&Ce.framebufferRenderbuffer(Ce.FRAMEBUFFER,Ce.DEPTH_STENCIL_ATTACHMENT,Ce.RENDERBUFFER,t.__webglRenderbuffer[d]):ir(t.__webglRenderbuffer[d],t);l&&Ce.generateMipmap(Ce.TEXTURE_CUBE_MAP)}else t.__webglFramebuffer=Ce.createFramebuffer(),t.shareDepthFrom?t.__webglRenderbuffer=t.shareDepthFrom.__webglRenderbuffer:t.__webglRenderbuffer=Ce.createRenderbuffer(),Ce.bindTexture(Ce.TEXTURE_2D,t.__webglTexture),$i(Ce.TEXTURE_2D,t,l),Ce.texImage2D(Ce.TEXTURE_2D,0,u,t.width,t.height,0,c,h,null),tr(t.__webglFramebuffer,t,Ce.TEXTURE_2D),t.shareDepthFrom?t.depthBuffer&&!t.stencilBuffer?Ce.framebufferRenderbuffer(Ce.FRAMEBUFFER,Ce.DEPTH_ATTACHMENT,Ce.RENDERBUFFER,t.__webglRenderbuffer):t.depthBuffer&&t.stencilBuffer&&Ce.framebufferRenderbuffer(Ce.FRAMEBUFFER,Ce.DEPTH_STENCIL_ATTACHMENT,Ce.RENDERBUFFER,t.__webglRenderbuffer):ir(t.__webglRenderbuffer,t),l&&Ce.generateMipmap(Ce.TEXTURE_2D);o?Ce.bindTexture(Ce.TEXTURE_CUBE_MAP,null):Ce.bindTexture(Ce.TEXTURE_2D,null),Ce.bindRenderbuffer(Ce.RENDERBUFFER,null),Ce.bindFramebuffer(Ce.FRAMEBUFFER,null)}else if(t&&(t.minFilter!==t.originalMinFilter||t.magFilter!==t.originalMagFilter)){l=Qi(t.width)&&Qi(t.height);o?(Ce.bindTexture(Ce.TEXTURE_CUBE_MAP,t.__webglTexture),$i(Ce.TEXTURE_CUBE_MAP,t,l),Ce.bindTexture(Ce.TEXTURE_CUBE_MAP,null)):(Ce.bindTexture(Ce.TEXTURE_2D,t.__webglTexture),$i(Ce.TEXTURE_2D,t,l),Ce.bindTexture(Ce.TEXTURE_2D,null)),t.originalMinFilter=t.minFilter,t.originalMagFilter=t.magFilter}t?(i=o?t.__webglFramebuffer[t.activeCubeFace]:t.__webglFramebuffer,Ze.RTTmatchViewport?(r=bt,n=Dt,a=Pt,s=Ct):(r=t.width,n=t.height,a=0,s=0)):(i=this._VRFrameBuffer?this._VRFrameBuffer:null,r=bt,n=Dt,a=Pt,s=Ct),i!==e.glStates.currentFramebuffer&&(Ce.bindFramebuffer(Ce.FRAMEBUFFER,i),e.glStates.currentFramebuffer=i),e.glStates.currentWidth===r&&e.glStates.currentHeight===n||(Ce.viewport(a,s,r,n),e.glStates.currentWidth=r,e.glStates.currentHeight=n)},this.getSupportedExtensions=function(){return e.supportedExtensions},this.packESM=!1,this._gpuPickingTolerance=0,this._smallTargetPicking=0,this.useOIT=!1,this.useSSLR=!1,this.useSSLRefraction=!1,this.precomputedTexture=null,this.boundaryEdgeMaterialInfo={color:new e.Color(255),enabled:!1},this.precomputedAreaGGX1texture=null,this.precomputedAreaGGX2texture=null,this.precomputedAreaAshikmintexture=null,this.precomputedAreaEsteveztexture=null,this.precomputedAreaBeckmanntexture=null,this.materialToUse=e.MaterialToUse.originalMaterial,this._forbidRenderableState=0,this.shadowMapSoft=!1,this.gpuAntiAliasing=!1,this.forceMaterialDoubleSide=!0,this.cuttingScene=null,this.backupCuttingMaterial=null,this.cameraSystem_cameraIndex=-1},e.GeometryUtils={center:function(t){t.computeBoundingBox();var i=t.boundingBox,r=new e.Vector3;return r.addVectors(i.min,i.max),r.multiplyScalar(-.5),t.applyMatrix((new e.Matrix4).makeTranslation(r.x,r.y,r.z)),t.computeBoundingBox(),r}},e.BasisUsage=E.BasisUsage,e.ImageUtils=E.Utils,e.FontUtils=w.FontUtils,self._typeface_js={faces:e.FontUtils.faces,loadFace:e.FontUtils.loadFace},e.LineCurve=D.LineCurve,e.QuadraticBezierCurve=D.QuadraticBezierCurve,e.CubicBezierCurve=D.CubicBezierCurve,e.SplineCurve=D.SplineCurve,e.EllipseCurve=D.EllipseCurve,e.LineCurve3=D.LineCurve3,e.QuadraticBezierCurve3=D.QuadraticBezierCurve3,e.CubicBezierCurve3=D.CubicBezierCurve3,e.SplineCurve3=D.SplineCurve3,e.ClosedSplineCurve3=D.ClosedSplineCurve3,e.CurvePath=D.CurvePath,e.Path=D.Path,e.PathActions=D.PathActions,e.Shape=w.Shape,e.CubeGeometry=b.CubeGeometry,e.CircleGeometry=b.CircleGeometry,e.CylinderGeometry=b.CylinderGeometry,e.ExtrudeGeometry=b.ExtrudeGeometry,e.ShapeGeometry=b.ShapeGeometry,e.PlaneGeometry=b.PlaneGeometry,e.SphereGeometry=b.SphereGeometry,e.TextGeometry=b.TextGeometry,e.CameraHelper=function(t){e.Line.call(this);var i=this;this._tokens={},this.geometry=new e.Geometry,this.material=new e.LineBasicMaterial({color:16777215,vertexColors:e.VertexColorType.Face}),this.type=e.LinePieces,this.matrixWorld=t.matrixWorld,this.matrixAutoUpdate=!1,this.frustumCulled=!1,this.pointMap={};function r(e,t,i){n(e,i),n(t,i)}function n(t,r){i.geometry.vertices.push(new e.Vector3),i.geometry.colors.push(new e.Color(r)),void 0===i.pointMap[t]&&(i.pointMap[t]=[]),i.pointMap[t].push(i.geometry.vertices.length-1)}r("n1","n2",16755200),r("n2","n4",16755200),r("n4","n3",16755200),r("n3","n1",16755200),r("f1","f2",16755200),r("f2","f4",16755200),r("f4","f3",16755200),r("f3","f1",16755200),r("n1","f1",16755200),r("n2","f2",16755200),r("n3","f3",16755200),r("n4","f4",16755200),r("p","n1",16711680),r("p","n2",16711680),r("p","n3",16711680),r("p","n4",16711680),r("u1","u2",43775),r("u2","u3",43775),r("u3","u1",43775),r("c","t",16777215),r("p","c",3355443),r("cn1","cn2",3355443),r("cn3","cn4",3355443),r("cf1","cf2",3355443),r("cf3","cf4",3355443),this.camera=t,this.update(t)},e.CameraHelper.prototype=Object.create(e.Line.prototype),e.CameraHelper.prototype.update=function(){var t=this;function i(i,r,n,a){e.CameraHelper.__v.set(r,n,a),e.CameraHelper.__projector.unprojectVector(e.CameraHelper.__v,e.CameraHelper.__c);var s=t.pointMap[i];if(void 0!==s)for(var o=0,l=s.length;o<l;o++)t.geometry.vertices[s[o]].copy(e.CameraHelper.__v)}e.CameraHelper.__c.projectionMatrix.copy(this.camera.projectionMatrix),i("c",0,0,-1),i("t",0,0,1),i("n1",-1,-1,-1),i("n2",1,-1,-1),i("n3",-1,1,-1),i("n4",1,1,-1),i("f1",-1,-1,1),i("f2",1,-1,1),i("f3",-1,1,1),i("f4",1,1,1),i("u1",.7,1.1,-1),i("u2",-.7,1.1,-1),i("u3",0,2,-1),i("cf1",-1,0,1),i("cf2",1,0,1),i("cf3",0,-1,1),i("cf4",0,1,1),i("cn1",-1,0,-1),i("cn2",1,0,-1),i("cn3",0,-1,-1),i("cn4",0,1,-1),this.geometry.verticesNeedUpdate=!0},e.CameraHelper.__projector=new e.Projector,e.CameraHelper.__v=new e.Vector3,e.CameraHelper.__c=new e.Camera,e.LensFlare=function(t,i,r,n,a){e.Object3D.call(this),this.lensFlares=[],this.positionScreen=new e.Vector3,this.customUpdateCallback=void 0,void 0!==t&&this.add(t,i,r,n,a)},e.LensFlare.prototype=Object.create(e.Object3D.prototype),e.LensFlare.prototype.add=function(t,i,r,n,a,s){void 0===i&&(i=-1),void 0===r&&(r=0),void 0===s&&(s=1),void 0===a&&(a=new e.Color(16777215)),void 0===n&&(n=e.NormalBlending),r=Math.min(r,Math.max(0,r)),this.lensFlares.push({texture:t,size:i,distance:r,x:0,y:0,z:0,scale:1,rotation:1,opacity:s,color:a,blending:n})},e.LensFlare.prototype.updateLensFlares=function(){var e,t,i=this.lensFlares.length,r=2*-this.positionScreen.x,n=2*-this.positionScreen.y;for(e=0;e<i;e++)(t=this.lensFlares[e]).x=this.positionScreen.x+r*t.distance,t.y=this.positionScreen.y+n*t.distance,t.wantedRotation=t.x*Math.PI*.25,t.rotation+=.25*(t.wantedRotation-t.rotation)},e}),define("Visualization/ThreeJS_R57",["DS/Visualization/ThreeJS_R57","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/ThreeJS_R57"),e}),define("DS/Visualization/SubsurfaceGenerator",["DS/Visualization/ThreeJS_R57"],function(e){"use strict";var t=function(){this.computedTextures=new Map,this.size=64,this.radiusR=null,this.depthR=null,this.radiusG=null,this.depthG=null,this.radiusB=null,this.depthB=null;var e=this.utilities.linspace(-1,1,this.size);this.theta=this.utilities.applyToArray(e,function(e){return Math.acos(e)}),this.sinTheta=this.utilities.applyToArray(this.theta,function(e){return e>.5*Math.PI?0:Math.sin(e)}),this.aux=Math.PI*Math.PI*Math.sqrt(.31830988618)/this.size};return t.prototype={constructor:t,modelFunction:function(e){var t=e.scatteringCoeffs,i=Math.max(Math.min(e.subsurfaceAnisotropy,.99),-.99);t=this.utilities.applyToArray(t,function(e){return e*(1-i)});var r=this.utilities.sumArray(e.absorptionCoeffs,t),n=this.utilities.applyToArray(this.utilities.multiplyArray(e.absorptionCoeffs,r),function(e){return Math.sqrt(3*e)}),a=-1.44/(e.eta*e.eta)+.71/e.eta+.668+.0636*e.eta,s=(1+a)/(1-a),o=this.utilities.applyToArray(r,function(e){return 1/Math.max(e,1e-20)}),l=this.utilities.applyToArray(o,function(e){return 4*s/3*e}),c=this.utilities.applyToArray(o,function(e){return 5*e});this.depthR=this.utilities.linspace(0,15*o[0],this.size),this.radiusR=this.utilities.linspace(.5*o[0],7.5*o[0],this.size),this.depthG=this.utilities.linspace(0,15*o[1],this.size),this.radiusG=this.utilities.linspace(.5*o[1],7.5*o[1],this.size),this.depthB=this.utilities.linspace(0,15*o[2],this.size),this.radiusB=this.utilities.linspace(.5*o[2],7.5*o[2],this.size);var h=this.utilities.multiplyArray(t,o),u=function(e,t){return(t*e+1)*Math.exp(-t*e)/(e*e*e)},d=.25/Math.PI,p=function(e,t){for(var i=n[e],r=o[e],a=l[e],s=c[e],p=0,f=-2;f<=2;f++){var m=2*f*(s+a),g=m+r,v=m-r-a,S=Math.sqrt(t*t+g*g),_=Math.sqrt(t*t+v*v);p+=g*u(S,i)-v*u(_,i)}var y=h[e];return p*d*y};return{red:function(e){return p(0,e)},green:function(e){return p(1,e)},blue:function(e){return p(2,e)}}},sssLUTBuilder:function(e,t,i){return this.utilities.integrate(function(r){var n=t*Math.abs(2*Math.sin(.5*r));return Math.max(Math.cos(i+r),0)*e(n)},-Math.PI,Math.PI)/Math.max(this.utilities.integrate(function(i){var r=t*Math.abs(2*Math.sin(.5*i));return e(r)},-Math.PI,Math.PI),1e-20)},translucencyLUTBuilder:function(e,t,i){return this.utilities.integrateT(function(i){return 2*Math.PI*i*e(Math.sqrt(i*i+t*t))},i[this.size-1])},setTexture:function(t,i,r){var n=new e.DataTexture(t,i,r,e.RGBFormat,e.FloatType);return n.minFilter=e.LinearFilter,n.magFilter=e.LinearFilter,n.generateMipmaps=!1,n.flipY=!1,n.needsUpdate=!0,n},decreaseUseCount:function(e){if(this.computedTextures.has(e)){var t=this.computedTextures.get(e);t.useCount--,0===t.useCount&&(t.textures.sssLUT.dispose(),this.computedTextures.delete(e))}},dispose:function(){this.computedTextures.forEach(function(e,t,i){e.textures.sssLUT.dispose()}),this.computedTextures.clear()},_getComputedTextures:function(e){var t=-1;return this.computedTextures.forEach(function(i,r,n){var a,s,o,l,c,h,u;a=i.options,s=e,o=Math.abs(a.scatteringCoeffs[0]-s.scatteringCoeffs[0])<1e-6&&Math.abs(a.scatteringCoeffs[1]-s.scatteringCoeffs[1])<1e-6&&Math.abs(a.scatteringCoeffs[2]-s.scatteringCoeffs[2])<1e-6,l=Math.abs(a.absorptionCoeffs[0]-s.absorptionCoeffs[0])<1e-6&&Math.abs(a.absorptionCoeffs[1]-s.absorptionCoeffs[1])<1e-6&&Math.abs(a.absorptionCoeffs[2]-s.absorptionCoeffs[2])<1e-6,c=Math.abs(a.color[0]-s.color[0])<1e-6&&Math.abs(a.color[1]-s.color[1])<1e-6&&Math.abs(a.color[2]-s.color[2])<1e-6,h=Math.abs(a.eta-s.eta)<1e-6,u=Math.abs(a.subsurfaceAnisotropy-s.subsurfaceAnisotropy)<1e-6,o&&l&&h&&c&&u&&(i.useCount++,t=r)}),t>-1?this.computedTextures.get(t).textures:null},compute:function(t){var i=this._getComputedTextures(t);if(null!==i)return i;for(var r=Date.now(),n=this.modelFunction(t),a=this.size+2+3+2+3,s=new Float32Array(this.size*a*3),o=this.size+2,l=this.size+7,c=t.color,h=0;h<this.size;h++){for(var u=this.radiusR[h],d=this.radiusG[h],p=this.radiusB[h],f=0,m=0,g=0,v=0;v<this.size;v++){var S,_,y,x=this.theta[v];S=c[0]*this.sssLUTBuilder(n.red,u,x),y=c[1]*this.sssLUTBuilder(n.green,d,x),_=c[2]*this.sssLUTBuilder(n.blue,p,x),s[3*this.size*h+3*v+0]=S,s[3*this.size*h+3*v+1]=y,s[3*this.size*h+3*v+2]=_,h==this.size-1&&(s[3*this.size*this.size+3*v+0]=S,s[3*this.size*this.size+3*v+1]=y,s[3*this.size*this.size+3*v+2]=_),f+=S*this.sinTheta[v],m+=y*this.sinTheta[v],g+=_*this.sinTheta[v]}f*=this.aux,m*=this.aux,g*=this.aux;for(var M=this.depthR[h],P=this.depthG[h],C=this.depthB[h],b=this.translucencyLUTBuilder(n.red,M,this.depthR),D=this.translucencyLUTBuilder(n.green,P,this.depthG),w=this.translucencyLUTBuilder(n.blue,C,this.depthB),E=0;E<3;E++){var T=this.size*(o+E);s[3*T+3*h+0]=f,s[3*T+3*h+1]=m,s[3*T+3*h+2]=g;var A=this.size*(l+E);s[3*A+3*h+0]=b,s[3*A+3*h+1]=D,s[3*A+3*h+2]=w}}var I=this.setTexture(s,this.size,this.size+5+5),R=Date.now();e.VisualizationTraces.info((R-r)/1e3);var L={sssLUT:I,translucencyDepth:[this.depthR[this.size-1],this.depthG[this.size-1],this.depthB[this.size-1]]};return this.computedTextures.set(I.id,{textures:L,options:{eta:t.eta,absorptionCoeffs:t.absorptionCoeffs.slice(0),scatteringCoeffs:t.scatteringCoeffs.slice(0),subsurfaceAnisotropy:t.subsurfaceAnisotropy,color:t.color.slice(0)},useCount:1}),L},toImage:function(){var e=document.createElement("canvas");document.body.appendChild(e);var t=e.getContext("2d"),i=this;this.computedTextures.forEach(function(r,n,a){!function(r,n,a,s){e.height=a,e.width=n;for(var o=0;o<a;++o)for(var l=0;l<n;++l)t.fillStyle="rgb("+255*r[3*i.size*o+3*l]+", "+255*r[3*i.size*o+3*l+1]+",+"+255*r[3*i.size*o+3*l+2]+")",t.fillRect(l,o,1,1);var c=e.toDataURL("image/png"),h=document.createElement("a");h.download=s,h.innerHTML="Download File",h.href=c,h.click()}(r.textures.sssLUT.image.data,r.textures.sssLUT.image.width,r.textures.sssLUT.image.height,"sssLUT")})},utilities:{linspace:function(e,t,i){var r=Math.floor(i);if(r<=1)return[t];for(var n=(t-e)/(i-1),a=[],s=0;s<r;s++)a[s]=e+s*n;return a},sumElements:function(e){for(var t=0,i=0;i<e.length;i++)t+=e[i];return t},multiplyArray:function(e,t){for(var i=Math.min(t.length,e.length),r=[],n=0;n<i;n++)r[n]=e[n]*t[n];return r},sumArray:function(e,t){for(var i=Math.min(t.length,e.length),r=[],n=0;n<i;n++)r[n]=e[n]+t[n];return r},applyToArray:function(e,t){for(var i=[],r=0;r<e.length;r++)i[r]=t(e[r]);return i},integrate:function(e,t,i){var r=this.linspace(t,i,120),n=this.applyToArray(r,e);return.5*(i-t)/120*(2*this.sumElements(n)-n[119]-n[0])},integrateT:function(e,t){var i=this.linspace(0,t,1e3),r=this.applyToArray(i,e);return.5*t/1e3*(2*this.sumElements(r)-r[999]-r[0])}}},t}),define("DS/Shaders/AdvancedHighlightShader",["DS/Visualization/ThreeJS_R57"],function(e){"use strict";var t=["#if HIGHLIGHT_POLITE == 1","#ifdef NOZ_OBJECT","const int noZ = 1;","#else","const int noZ = 0;","#endif","const float highlightBack = 0.66;","const float highlightFront = 0.33;","float depthSampleTest(in vec2 coord, in float depth) {","float fDepth = unpackRGBA(texture2D(rgbaDepth, coord));","if ( fDepth  < depth) return highlightBack;","return highlightFront;","}","float getDepthTestResult(float depth) {","vec2 coord = 0.5 + 0.5*cP.xy/cP.w;","return depthSampleTest(coord, depth - 2.38418579e-7);","}","float getFaceDepthValue() {","if (noZ == 1) {","return highlightFront;","}","float depth = 0.5 + 0.5*cP.z/cP.w ;","float faceDepth = depth;","#if defined(GL_OES_standard_derivatives) || defined(GLSL300ES)","float dx = dFdx (depth);","float dy = dFdy (depth);","#if defined(MOBILE_HIGHLIGHT_MODE) && !defined(MOBILE_DEVICE_MODE)","faceDepth += 0.5 * (sqrt(dx*dx + dy*dy) + DEPTH_PRECISION);","#else","faceDepth += 0.9 * (sqrt(dx*dx + dy*dy) + DEPTH_PRECISION);","#endif","#else","faceDepth += 1.5*DEPTH_PRECISION;","#endif","return getDepthTestResult(faceDepth);","}","float getDepthValue() {","if (noZ == 1) {","return highlightFront;","}","float depth = 0.5 + 0.5*cP.z/cP.w ;","return getDepthTestResult(depth);","}","#endif"].join("\n"),i="true"===localStorage.getItem("__1x3HL__"),r={uniforms:e.UniformsUtils.merge([e.UniformsLib.clipPlanes,{map:{type:"t",value:null},rgbaDepth:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new e.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new e.Vector4(1,1)},highlightID:{type:"f",value:1}}]),vertexShaderPars:["varying vec3 vMVNormal;","varying vec3 vMVPosition;","uniform float highlightID;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","#if HIGHLIGHT_POLITE == 1","varying vec4 cP;","#endif"].join("\n"),vertexShaderBody:["    vMVNormal = mvNormal;","    vMVPosition = -mvPosition.xyz;","#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif","#if HIGHLIGHT_POLITE == 1","cP = gl_Position;","#endif"].join("\n"),fragmentShaderPars:["varying vec3 vMVNormal;","varying vec3 vMVPosition;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","#if HIGHLIGHT_POLITE == 1","uniform sampler2D rgbaDepth;","varying vec4 cP;","#endif",t,"uniform float highlightID;"].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vUvMap ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","vec3 I = vec3(0.0, 0.0, 1.0);","    if (!(projectionMatrix[3][3] > 0.0)) {","       I = normalize( vMVPosition.xyz );","    }","float reflectionFactor = abs(dot(normalize(vMVNormal),I));","#if HIGHLIGHT_POLITE == 1","float depthValue = getFaceDepthValue();","reflectionFactor = noZ == 1 ? 0.8 : depthValue < 0.5 ? (1.0 - 1.0 / 3.141) * reflectionFactor + 1.0/3.141 : reflectionFactor;","gl_FragColor = vec4( highlightID / 255.0, reflectionFactor, depthValue , 0.0 );","#else","reflectionFactor = 1.0 - reflectionFactor;","  gl_FragColor = vec4( highlightID / 255.0, reflectionFactor * reflectionFactor, 0.0, 0.0 );","#endif"].join("\n"),vertexShader:[e.ShaderChunk.clip_pars_vertex,e.ShaderChunk.skinning_pars_vertex,"#ifndef PDSFX","varying vec3 vMVNormal;","varying vec3 vMVPosition;","#endif","uniform float highlightID;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","#ifdef PDSFX_USE_MAP","varying vec2 vUv;","#endif","#if HIGHLIGHT_POLITE == 1 && !defined(PDSFX)","varying vec4 cP;","#endif","void main() {",e.ShaderChunk.PDSFX_start_vertex,e.ShaderChunk.skinbase_vertex,e.ShaderChunk.skinnormal_vertex,e.ShaderChunk.skinning_vertex,e.ShaderChunk.default_vertex_with_normal,e.ShaderChunk.defaultnormal_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#else","vMVNormal = transformedNormal;","vMVPosition = -mvPosition.xyz;","#endif","#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif","    gl_Position = projectionMatrix * mvPosition;",e.ShaderChunk.clip_vertex,"#if HIGHLIGHT_POLITE == 1 && !defined(PDSFX)","cP = gl_Position;","#endif",e.ShaderChunk.PDSFX_end_vertex,"#ifdef PDSFX_USE_MAP","vUv = uv;","#endif","}"].join("\n"),fragmentShader:[e.ShaderChunk.clip_pars_fragment,"#ifndef PDSFX","varying vec3 vMVNormal;","varying vec3 vMVPosition;","#endif","uniform float highlightID;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","#ifdef PDSFX_USE_MAP","varying vec2 vUv;","#endif","#if HIGHLIGHT_POLITE == 1","uniform sampler2D rgbaDepth;","#ifndef PDSFX","varying vec4 cP;","#else","vec4 cP;","#endif","#endif",t,"void main() {",e.ShaderChunk.PDSFX_map_fragment,"#ifdef PDSFX","ComputeCommonValues();",e.ShaderChunk.PDSFX_discard_fragment,e.ShaderChunk.PDSFX_viewNormal_fragment,"vec3 mvPosition = ComputeViewPosition();","vec3 I = vec3(0.0, 0.0, 1.0);","    if (!(projectionMatrix[3][3] > 0.0)) {","       I = normalize( -mvPosition.xyz );","    }","float reflectionFactor = abs( dot( I, _DSvNormal ) );","#if HIGHLIGHT_POLITE == 1","cP = _DSclipPosition;","#endif","#else","vec3 I = vec3(0.0, 0.0, 1.0);","if (!(projectionMatrix[3][3] > 0.0)) {","I = normalize( vMVPosition.xyz );","}","float reflectionFactor = abs(dot(normalize(vMVNormal), I));","#endif",e.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   float alpha = texture2D( map, vUvMap ).w;","   if ( alpha < ALPHATEST ) discard;","#endif","#if HIGHLIGHT_POLITE == 1","float depthValue = getFaceDepthValue();","reflectionFactor = noZ == 1 ? 0.8 : depthValue < 0.5 ? (1.0 - 1.0 / 3.141) * reflectionFactor + 1.0/3.141 : reflectionFactor;","gl_FragColor = vec4( highlightID / 255.0, reflectionFactor, depthValue , 0.0 );","#else","reflectionFactor = 1.0 - reflectionFactor;","  gl_FragColor = vec4( highlightID / 255.0, reflectionFactor * reflectionFactor , 0.0, 0.0 );","#endif","}"].join("\n")},n={tAdd:{type:"t",value:null},tDiffuse:{type:"t",value:null},empty:{type:"i",value:0},h:{type:"f",value:1/1024},v:{type:"f",value:1/1024},poisson:{type:"fv1",value:[]},iHaloColors:{type:"fv",value:[]},iLineicHaloColors:{type:"fv",value:[]},iHaloIntensities:{type:"fv1",value:[]},iColors:{type:"fv",value:[]},iColorIntensities:{type:"fv2",value:[]},iOutlineColors:{type:"fv",value:[]},iLineicOutlineColors:{type:"fv",value:[]},iOutlineAlphas:{type:"fv1",value:[]},iOutlineThicknesses:{type:"fv1",value:[]}},a={POSTPRO:1,NB_CONFIG:0,HALO_THICKNESS:2,HAS_POLITE:0,QA_AUTOMATION:0},s=["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),o=["#if (POSTPRO == 1)","uniform sampler2D tDiffuse;","#endif","uniform sampler2D tAdd;","uniform float h;","uniform float v;","uniform float poisson[24];","uniform float iHaloIntensities[NB_CONFIG];","uniform vec3 iHaloColors[NB_CONFIG];","uniform vec3 iLineicHaloColors[NB_CONFIG];","uniform vec3 iOutlineColors[NB_CONFIG];","uniform vec3 iLineicOutlineColors[NB_CONFIG];","uniform float iOutlineAlphas[NB_CONFIG];","uniform float iOutlineThicknesses[NB_CONFIG];","uniform vec3 iColors[NB_CONFIG];","uniform vec2 iColorIntensities[NB_CONFIG];","uniform int empty;","varying vec2 vUv;","struct highlightConfig {","bool colorEnabled;","vec3 color;","vec2 colorIntensity;","bool outlineEnabled;","vec3 outlineColor;","vec3 lineicOutlineColor;","float outlineAlpha;","float outlineThickness;","};","highlightConfig emptyConfig;","const float outlineCheck = 8.0;","int GetID(in float texR) {","return int(floor(255.0 * texR + 0.5));","}"].join("\n"),l=["highlightConfig GetHighlightConfig(in float texR) {","return GetHighlightConfig(GetID(texR));","}","float CheckIfOutlines(in vec4 center, in highlightConfig config) {","int curID = GetID(center.r);","float tx = config.outlineThickness * h;","float ty = config.outlineThickness * v;","int northWest1 = GetID(texture2D( tAdd, vec2( vUv.x - tx, vUv.y + ty)).r);","int north1     = GetID(texture2D( tAdd, vec2( vUv.x     , vUv.y + ty)).r);","int northEast1 = GetID(texture2D( tAdd, vec2( vUv.x + tx, vUv.y + ty)).r);","int west1      = GetID(texture2D( tAdd, vec2( vUv.x - tx, vUv.y)).r);","int east1      = GetID(texture2D( tAdd, vec2( vUv.x + tx, vUv.y)).r);","int southWest1 = GetID(texture2D( tAdd, vec2( vUv.x - tx, vUv.y - ty)).r);","int south1     = GetID(texture2D( tAdd, vec2( vUv.x     , vUv.y - ty)).r);","int southEast1 = GetID(texture2D( tAdd, vec2( vUv.x + tx, vUv.y - ty)).r);","float r1 = dot(vec4(curID == northWest1 ? 1.0 : 0.0,curID == north1 ? 1.0 : 0.0, curID == northEast1 ? 1.0 : 0.0, curID == west1 ? 1.0 : 0.0), vec4(1.0));","float r2 = dot(vec4(curID == east1 ? 1.0 : 0.0, curID == southWest1 ? 1.0 : 0.0, curID == south1 ? 1.0 : 0.0, curID == southEast1 ? 1.0 : 0.0), vec4(1.0));","return (r1+r2);","}"," vec4 ComputeHaloColor() {","vec4 haloColor = vec4(0.0);","float count = 0.0;","float tx = float(HALO_THICKNESS) * h;","float ty = float(HALO_THICKNESS) * v;","{","float stx = 1.5 * h;","float sty = 1.5 * v;","count+= texture2D( tAdd, vec2( vUv.x - stx, vUv.y + sty)).r;","count+= texture2D( tAdd, vec2( vUv.x    , vUv.y + sty)).r;","count+= texture2D( tAdd, vec2( vUv.x + stx, vUv.y + sty)).r;","count+= texture2D( tAdd, vec2( vUv.x - stx, vUv.y)).r;","count+= texture2D( tAdd, vec2( vUv.x + stx, vUv.y)).r;","count+= texture2D( tAdd, vec2( vUv.x - stx, vUv.y - sty)).r;","count+= texture2D( tAdd, vec2( vUv.x    , vUv.y - sty)).r;","count+= texture2D( tAdd, vec2( vUv.x + stx, vUv.y - sty)).r;","for (int p = 0; p < 24; p += 2) {","count += texture2D(tAdd, vec2(vUv.x + tx * poisson[p], vUv.y + ty * poisson[p+1])).r;","}","}","if (count > 0.0) {","vec4 aux;","float hit = 0.0;","for (int halo = 1; halo <= HALO_THICKNESS ; halo++) {","tx = float(halo) * h;","ty = float(halo) * v;","for (int p = 0; p < 24; p += 2) {","vec4 tex = texture2D(tAdd, vec2(vUv.x + tx * poisson[p], vUv.y + ty * poisson[p+1]));","aux = GetHaloData(GetID(tex.r), tex.w);","haloColor += aux;","hit += aux.a > 0.0 ? 1.0 : 0.0;","}","}","haloColor.a *= 0.08333333333 / float(HALO_THICKNESS);","haloColor.rgb /= max(hit, 1.0);","}","return haloColor;","}","float GetLineicAlpha(in bool isEdge) {",i?"return 0.8;":"return isEdge ? 0.6 : 0.8;","}","float ComputePoliteColorAlpha(in highlightConfig config, in bool isMarker, in bool isEdge, in bool back) {","return isMarker || isEdge ? GetLineicAlpha(isEdge) : (back ? config.colorIntensity.y : config.colorIntensity.x);","}","float ComputeHaloColorAlpha(in highlightConfig config, in float factor) {","return (0.6 * factor + 0.2) * config.colorIntensity.x;","}"].join("\n"),c=["vec4 GetHaloData(in int index, in float glType){","vec4 res = vec4(0.0);","#if HAS_POLITE == 1","if (GetID(glType) == 2 || GetID(glType) == 4) {","return res;","}","#endif","float factor = (GetID(glType) <= 2 ? ceil(glType) : 0.0);","if (index > 0) {","#if NB_CONFIG == 1","res.a = (1.0 + factor) * iHaloIntensities[0];","res.rgb = iHaloColors[0];","#else","MAIN_HALO_DATA_LOOP","#endif","}","return res;","}","vec4 GetLineicHaloData(in int index){","vec4 res = vec4(0.0);","if (index > 0) {","#if NB_CONFIG == 1","res.rgb = iLineicHaloColors[0];","#else","LINEIC_HALO_DATA_LOOP","#endif","}",i?"res.a = 0.45;":"res.a = 0.8;","return res;","}","highlightConfig GetHighlightConfig(in int index) {","if (index > 0) {","highlightConfig res;","#if NB_CONFIG == 1","res.color = iColors[0];","res.colorIntensity = iColorIntensities[0];","res.outlineColor = iOutlineColors[0];","res.lineicOutlineColor = iLineicOutlineColors[0];","res.outlineAlpha = iOutlineAlphas[0];","res.outlineThickness = iOutlineThicknesses[0];","#else","HIGHLIGHT_CONFIG_LOOP","#endif","return res;","} else {","return emptyConfig;","}","}"].join("\n"),h=["if (empty == 0) {","#if (POSTPRO == 1)","gl_FragColor = texture2D( tDiffuse, vUv );","#else","gl_FragColor = vec4(0.0);","#endif","return;","}","emptyConfig.color = vec3(0.0);","emptyConfig.colorIntensity = vec2(0.0, -1.0);","emptyConfig.outlineColor = vec3(0.0);","emptyConfig.lineicOutlineColor = vec3(0.0);","emptyConfig.outlineAlpha = 0.0;","emptyConfig.outlineThickness = 0.0;","vec4 center = texture2D(tAdd, vUv);","vec4 finalColor = vec4(0.0);"].join("\n"),u=["int qaAutomationID = GetID(center.r);","if (qaAutomationID > 0) {","int qaAutomationGeomID = GetID(center.w);","finalColor.a = 1.0;","if (qaAutomationGeomID == 0) {","finalColor.rgb = vec3(0.0,0.61,0.61);","} else if (qaAutomationGeomID < 3) {","finalColor.rgb = qaAutomationGeomID == 2 ? vec3(1.0,0.0,0.0) : vec3(0.0,0.78,0.78);","} else {","finalColor.rgb = vec3(0.0,0.78,0.78);","}","}"].join("\n"),d=["highlightConfig config = GetHighlightConfig(center.r);","float isOutline = 8.0;","if (config.outlineAlpha > -0.5 && !forceBasePostProOff) {","isOutline = CheckIfOutlines(center, config);","}","if (forceOutlineOn && config.outlineAlpha > -0.5) {","finalColor = vec4(config.lineicOutlineColor.rgb, GetLineicAlpha(isEdge));","} else if (isOutline < outlineCheck) {","finalColor = vec4(config.outlineColor.rgb, config.outlineAlpha);","} else {","if (center.r == 0.0 && !forceBasePostProOff) {","finalColor = ComputeHaloColor();","} else if (forceHaloOn) {","finalColor.rgba = GetLineicHaloData(GetID(center.r));","} else if (config.colorIntensity.x > 1e-6 || config.colorIntensity.y > 1e-6) {","if (config.colorIntensity.y > -0.5) {","float alpha = ComputePoliteColorAlpha(config, isMarker, isEdge, center.b > 0.5);","finalColor = vec4(center.g * config.color.rgb, alpha);","} else {","float alpha = ComputeHaloColorAlpha(config, center.g);","finalColor = vec4(config.color.rgb, alpha);","}","}","}"].join("\n"),p=["finalColor.a = min(finalColor.a, 1.0);","float coef = finalColor.a;","#if (POSTPRO == 1)","vec4 add = texture2D( tDiffuse, vUv );","gl_FragColor = vec4(coef * finalColor.rgb + (1.0 - coef) * add.rgb, add.a);","#else","gl_FragColor = vec4(finalColor.rgb, coef);","#endif"].join("\n"),f=["for (int i = 0; i < NB_CONFIG; i++) {","if (i + 1 == index) {","res.color = iColors[i];","res.colorIntensity = iColorIntensities[i];","res.outlineColor = iOutlineColors[i];","res.lineicOutlineColor = iLineicOutlineColors[i];","res.outlineAlpha = iOutlineAlphas[i];","res.outlineThickness = iOutlineThicknesses[i];","break;","}","}"].join("\n"),m=["for (int i = 0; i < NB_CONFIG; i++) {","if (i + 1 == index) {","res.rgb = iLineicHaloColors[i];","break;","}","}"].join("\n"),g=["for (int i = 0; i < NB_CONFIG; i++) {","if (i + 1 == index) {","res.a = (1.0 + factor) * iHaloIntensities[i];","res.rgb = iHaloColors[i];","break;","}","}"].join("\n"),v={defines:{},uniforms:{},vertexShader:s,fragmentShader:[o,c.replace("HIGHLIGHT_CONFIG_LOOP",f).replace("LINEIC_HALO_DATA_LOOP",m).replace("MAIN_HALO_DATA_LOOP",g),"#if HAS_POLITE == 1","bool DoPoliteMarkers(inout vec4 center, out bool forceOutlineOn,  out bool forceHaloOn, out bool isMarker) {","bool forceBasePostProOff = false;","vec4 oldCenter = center;","int curID = 0;","float curDistance = 1e6;","bool curBack = false;","bool outer = false;","bool outerOutline = false;","bool inner = false;","bool innerOuter = false;","bool innerOutline = false;","for (int i = -2; i <= 2 ; i++) {","for (int j = -2; j <= 2 ; j++) {","vec2 offsetFactor = vec2(float(i), float(j));","float dist = length(offsetFactor);","vec2 uv = vUv + offsetFactor * vec2(h,v);","vec4 auxCenter = texture2D(tAdd, uv);","if (GetID(auxCenter.w) == 4 && auxCenter.b > 0.0) {","int auxID = GetID(auxCenter.r);","if (dist < curDistance || (abs(dist - curDistance) < 1e-6)) {","if (curID > 0 && auxCenter.b > 0.5 && !curBack) {","continue;","}","center = auxCenter;","curID = auxID;","curDistance = dist;","curBack = auxCenter.b > 0.5;","outer = any(greaterThan(abs(offsetFactor), vec2(1.5,1.5)));","outerOutline = outer;","inner = all(lessThan(abs(offsetFactor), vec2(1.5,1.5)));","innerOuter = inner;","innerOutline = any(greaterThan(abs(offsetFactor), vec2(0.5,0.5)));","forceBasePostProOff = true;","}","}","}","}","if (curBack && !inner){","center = oldCenter;","} else {","forceOutlineOn = (curBack && !innerOutline) || (!curBack && !outerOutline && innerOutline);","forceHaloOn = (curBack && innerOutline) || (!curBack && outerOutline);","isMarker = GetID(center.w) == 4;","}","return forceBasePostProOff;","}","bool DoPoliteEdges(inout vec4 center, out bool forceOutlineOn,  out bool forceHaloOn, out bool isEdge) {","bool forceBasePostProOff = false;","vec4 oldCenter = center;","int curID = 0;","float curDistance = 1e6;","bool curBack = false;","bool outer = false;","bool outerOutline = false;","bool inner = false;","bool innerOuter = false;","bool innerOutline = false;","for (int i = -2; i <= 2 ; i++) {","for (int j = -2; j <= 2 ; j++) {","vec2 offsetFactor = vec2(float(i), float(j));","float dist = length(offsetFactor);","vec2 uv = vUv + offsetFactor * vec2(h,v);","vec4 auxCenter = texture2D(tAdd, uv);","if (GetID(auxCenter.w) == 2 && auxCenter.b > 0.0) {","int auxID = GetID(auxCenter.r);","if (dist < curDistance || (abs(dist - curDistance) < 1e-6)) {","if (curID > 0 && auxCenter.b > 0.5 && !curBack) {","continue;","}","center = auxCenter;","curID = auxID;","curDistance = dist;","curBack = auxCenter.b > 0.5;","outer = any(greaterThan(abs(offsetFactor), vec2(1.5,1.5)));","outerOutline = outer;","inner = all(lessThan(abs(offsetFactor), vec2(1.5,1.5)));","innerOuter = inner;","innerOutline = any(greaterThan(abs(offsetFactor), vec2(0.5,0.5)));","forceBasePostProOff = true;","}","}","}","}","if (curBack && !inner){","center = oldCenter;","} else {","forceOutlineOn = (curBack && !innerOutline) || (!curBack && !outerOutline && innerOutline);","forceHaloOn = (curBack && innerOutline) || (!curBack && outerOutline);","isEdge = GetID(center.w) == 2;","}","return forceBasePostProOff;","}","#endif",l,"void main() {",h,"#if QA_AUTOMATION == 1",u,"#else","bool forceHaloOn = false;","bool forceOutlineOn = false;","bool forceBasePostProOff = false;","bool isMarker = false;","bool isEdge = false;","#if HAS_POLITE == 1","forceBasePostProOff = GetID(center.w) == 4 || GetID(center.w) == 2;","forceOutlineOn = forceBasePostProOff && center.b > 0.5;","if (!forceBasePostProOff) {","forceBasePostProOff = DoPoliteMarkers(center, forceOutlineOn, forceHaloOn, isMarker);","}","if (!forceBasePostProOff) {","forceBasePostProOff = DoPoliteEdges(center, forceOutlineOn, forceHaloOn, isEdge);","}","#endif",d,"#endif",p,"}"].join("\n")};Object.assign(v.defines,a),Object.assign(v.uniforms,n);return{_computeDepthChunk:t,HighlightFace:r,FinalBlending:v,FinalMobileBlending:function(e){var t=function(t){for(var i=[],r=0;r<e;r++)i.push("if ("+r+" + 1 == index) {"),i.push("const int i = "+r+";"),i.push(t),i.push("}");return i.join("\n")},i=t("res.color = iColors[i];res.colorIntensity = iColorIntensities[i];res.outlineColor = iOutlineColors[i];res.lineicOutlineColor = iLineicOutlineColors[i];res.outlineAlpha = iOutlineAlphas[i];res.outlineThickness = iOutlineThicknesses[i];"),r=t("res.rgb = iLineicHaloColors[i];"),f=t("res.a = (1.0 + factor) * iHaloIntensities[i];res.rgb = iHaloColors[i];"),m={defines:{},uniforms:{},vertexShader:s,fragmentShader:["#if HAS_POLITE == 1","#undef HAS_POLITE","#define HAS_POLITE 0","#endif",o,c.replace("HIGHLIGHT_CONFIG_LOOP",i).replace("LINEIC_HALO_DATA_LOOP",r).replace("MAIN_HALO_DATA_LOOP",f),l,"void main() {",h,"#if QA_AUTOMATION == 1",u,"#else","bool forceHaloOn = false;","bool forceOutlineOn = false;","bool forceBasePostProOff = false;","bool isMarker = false;","bool isEdge = false;",d,"#endif",p,"}"].join("\n")};return Object.assign(m.defines,a),Object.assign(m.uniforms,n),m}}}),define("Shaders/AdvancedHighlightShader",["DS/Shaders/AdvancedHighlightShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/AdvancedHighlightShader"),e}),define("DS/Intersection/IntersectionUtils",["DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh"],function(e,t){"use strict";var i,r,n,a,s,o,l,c,h,u=new e.Vector3,d=new e.Vector3,p=new e.Vector3;var f=new e.Vector3,m=new e.Sphere,g=function(e){return!!(e&&e.isGAS&&e._noPick)};return{checkWLayers:function(e,t,i,r,n){if(null!==e){for(var a=!1,s=e.length-1;s>=0;s--){var o=e[s];if(o.start<=t){let e=o.gas;e||(e=i),(o.skip(n,r)||g(e))&&(a=!0);break}}if(a)return!0}return!1},checkWLayersNoGAS:function(e,t){if(null!==e){for(var i=!1,r=e.length-1;r>=0;r--){var n=e[r];if(n.start<=t){n.skip(null,null)&&(i=!0);break}}if(i)return!0}return!1},checkGAS:g,checkRayToPrimitiveBoundingSphere:function(t,i,r,n){var a=t.getBoundingSphere();if(!a){var s=t.getRep();s&&(a=s.boundingSphere)&&(a=(new e.Sphere).setSimple(a.center[0],a.center[1],a.center[2],a.radius))}var o=a?a.radius+n:0;if(0===o)return!1;if(i._distanceFromIntersection(a.center)>o)return!0;if(r>0&&f.subVectors(a.center,i.origin).dot(i.direction)-o>r)return!0;return!1},computeUVCoords:function(t,i,r){var n=new e.Vector3;return n.x=t.x+h*(i.x-t.x)+c*(r.x-t.x),n.y=t.y+h*(i.y-t.y)+c*(r.y-t.y),n.z=t.z+h*(i.z-t.z)+c*(r.z-t.z),n},pointInFace3:function(e,t,f,m){return u.subVectors(m,t),d.subVectors(f,t),p.subVectors(e,t),i=u.dot(u),r=u.dot(d),n=u.dot(p),a=d.dot(d),s=d.dot(p),!((o=i*a-r*r)<1e-10)&&(h=(i*s-r*n)*(l=1/o),(c=(a*n-r*s)*l)>=0&&h>=0&&c+h<1)},checkFrustumToPrimitiveBoundingSphere:function(t,i,r){var n=t.getBoundingSphere();if(!n){var a=t.getRep();a&&(n=a.boundingSphere)&&(n=(new e.Sphere).setSimple(n.center[0],n.center[1],n.center[2],n.radius))}return!!n&&(m.center.set(n.center.x,n.center.y,n.center.z),m.radius=n.radius*r.getMaxScaleOnAxis(),m.center.applyMatrix4(r),!i.intersectsSphere(m))},filterDrawingGroup:function(e,t,i){if(e.isFiltered)return e.isFiltered(i,t);console.error("Unexpected class in filterDrawingGroup, expected Mesh.DrawingGroup");var r=t||e._geomType;return!((r&i)>0||0===r)},_screenWidth:0,_screenHeight:0,_projScreenMatrix:new e.Matrix4}}),define("DS/Shaders/DeferredShaders",["DS/Visualization/ThreeJS_R57"],function(e){"use strict";var t={encode_float:["float shift_right(float v, float amt) {","v = floor(v) + 0.5;","return floor(v / exp2(amt));","}","float shift_left(float v, float amt) {","return floor(v * exp2(amt) + 0.5);","}","float mask_last(float v, float bits) {","return mod(v, shift_left(1.0, bits));","}","float extract_bits(float num, float from, float to) {","from = floor(from + 0.5);","to = floor(to + 0.5);","return mask_last(shift_right(num, from), to - from);","}","vec4 encode_float(float val) {","if (val == 0.0)","return vec4(0, 0, 0, 0);","float sign = val > 0.0 ? 0.0 : 1.0;","val = abs(val);","float exponent = floor(log2(val));","float biased_exponent = exponent + 127.0;","float fraction = ((val / exp2(exponent)) - 1.0) * 8388608.0;","float t = biased_exponent / 2.0;","float last_bit_of_biased_exponent = fract(t) * 2.0;","float remaining_bits_of_biased_exponent = floor(t);","float byte4 = extract_bits(fraction, 0.0, 8.0) / 255.0;","float byte3 = extract_bits(fraction, 8.0, 16.0) / 255.0;","float byte2 = (last_bit_of_biased_exponent * 128.0 + extract_bits(fraction, 16.0, 23.0)) / 255.0;","float byte1 = (sign * 128.0 + remaining_bits_of_biased_exponent) / 255.0;","return vec4(byte4, byte3, byte2, byte1);","}","vec4 packRGBAFace( const in float depth ) {","float depthToUse = depth;","#if defined(GL_OES_standard_derivatives) || defined(GLSL300ES)","float dx = dFdx (depth);","float dy = dFdy (depth);","depthToUse += sqrt(dx*dx + dy*dy) + DEPTH_PRECISION;","#else","depthToUse += 2.0 *DEPTH_PRECISION;","#endif","return packRGBA(depthToUse);","}"].join("\n"),decalNormalStencilDepth:["uniform float decalStencilValue;"].join("\n"),unpackFloat:["vec3 float_to_vec3( float data ) {","vec3 uncompressed;","uncompressed.x = fract( data );","float zInt = floor( data / 255.0 );","uncompressed.z = fract( zInt / 255.0 );","uncompressed.y = fract( floor( data - ( zInt * 255.0 ) ) / 255.0 );","return uncompressed;","}"].join("\n"),picking_instancing_vertex:["if (instanceId > 16777215.0) vInstancePickingColor = vec3(0.0);","else {","vInstancePickingColor.r = floor(instanceId / 65536.0);","vInstancePickingColor.g = floor((instanceId - vInstancePickingColor.r * 65536.0) / 256.0);","vInstancePickingColor.b = floor(instanceId - vInstancePickingColor.r * 65536.0 - vInstancePickingColor.g * 256.0);","vInstancePickingColor /= 255.0;","}"].join("\n"),picking_instancing_fragment:["gl_FragColor = vec4(vInstancePickingColor, 1.0);"].join("\n")},i={uniforms:e.UniformsUtils.merge([e.UniformsLib.clipPlanes,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new e.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new e.Vector4(1,1)}}]),vertexShaderPars:["#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","#ifdef SPECIAL_PICKING_INSTANCING","varying vec3 pickingColor;","#endif"].join("\n"),vertexShaderBody:["#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif","#ifdef SPECIAL_PICKING_INSTANCING","pickingColor = specialMeshPicking;","#endif"].join("\n"),fragmentShaderPars:["#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","#ifdef SPECIAL_PICKING_INSTANCING","varying vec3 pickingColor;","#else","uniform vec3 pickingColor;","#endif"].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","   if ( alpha < ALPHATEST ) discard;","#endif","   gl_FragColor = vec4( pickingColor, 1.0 );"].join("\n"),vertexShader:[e.ShaderChunk.clip_pars_vertex,e.ShaderChunk.skinning_pars_vertex,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","#ifdef PDSFX_USE_MAP","varying vec2 vUv;","#endif","#ifdef SPECIAL_PICKING_INSTANCING","varying vec3 pickingColor;","#endif","void main() {",e.ShaderChunk.PDSFX_start_vertex,e.ShaderChunk.skinbase_vertex,e.ShaderChunk.skinning_vertex,e.ShaderChunk.default_vertex,"#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif",e.ShaderChunk.clip_vertex,"#ifdef SPECIAL_PICKING_INSTANCING","pickingColor = specialMeshPicking;","#endif",e.ShaderChunk.PDSFX_end_vertex,"#ifdef PDSFX_USE_MAP","vUv = uv;","#endif","}"].join("\n"),fragmentShader:[e.ShaderChunk.clip_pars_fragment,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","#ifdef SPECIAL_PICKING_INSTANCING","varying vec3 pickingColor;","#else","uniform vec3 pickingColor;","#endif","#ifdef PDSFX_USE_MAP","varying vec2 vUv;","#endif","void main() {",e.ShaderChunk.PDSFX_map_fragment,"#ifdef PDSFX","ComputeCommonValues();",e.ShaderChunk.PDSFX_discard_fragment,"#endif",e.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","   if ( alpha < ALPHATEST ) discard;","#endif","   gl_FragColor = vec4( pickingColor, 1.0 );","}"].join("\n")},r={uniforms:e.UniformsUtils.merge([e.UniformsLib.clipPlanes,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new e.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new e.Vector4(1,1)}}]),vertexShader:[e.ShaderChunk.clip_pars_vertex,e.ShaderChunk.skinning_pars_vertex,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","#ifdef PDSFX_USE_MAP","varying vec2 vUv;","#endif","varying vec3 vInstancePickingColor;","void main() {",e.ShaderChunk.PDSFX_start_vertex,e.ShaderChunk.skinbase_vertex,e.ShaderChunk.skinning_vertex,e.ShaderChunk.default_vertex,"#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif",e.ShaderChunk.clip_vertex,e.ShaderChunk.PDSFX_end_vertex,t.picking_instancing_vertex,"#ifdef PDSFX_USE_MAP","vUv = uv;","#endif","}"].join("\n"),fragmentShader:[e.ShaderChunk.clip_pars_fragment,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","#ifdef PDSFX_USE_MAP","varying vec2 vUv;","#endif","varying vec3 vInstancePickingColor;","void main() {",e.ShaderChunk.PDSFX_map_fragment,"#ifdef PDSFX","ComputeCommonValues();",e.ShaderChunk.PDSFX_discard_fragment,"#endif",e.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","   if ( alpha < ALPHATEST ) discard;","#endif",t.picking_instancing_fragment,"}"].join("\n")},n=function(i){return{uniforms:e.UniformsUtils.merge([e.UniformsLib.clipPlanes,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new e.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new e.Vector4(1,1)}}]),fragmentShaderPars:[t.encode_float,"varying vec4 clipPos;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif"].join("\n"),fragmentShaderBody:["#ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","   if ( alpha < ALPHATEST ) discard;","#endif","\tfloat tmp = 0.5 + 0.5 * clipPos.z / clipPos.w;",i?"\tvec4 encode = packRGBAFace(tmp);":"\tvec4 encode = encode_float(tmp);","   gl_FragColor = encode;"].join("\n"),vertexShaderPars:["varying vec4 clipPos;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif"].join("\n"),vertexShaderBody:["#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif","   clipPos = gl_Position;"].join("\n"),fragmentShader:[e.ShaderChunk.clip_pars_fragment,t.encode_float,"varying vec4 clipPos;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","#ifdef PDSFX_USE_MAP","varying vec2 vUv;","#endif","void main() {",e.ShaderChunk.PDSFX_map_fragment,"#ifdef PDSFX","ComputeCommonValues();",e.ShaderChunk.PDSFX_discard_fragment,"#endif",e.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","   if ( alpha < ALPHATEST ) discard;","#endif","\t#ifdef PDSFX","\tfloat tmp = 0.5 + 0.5 * _DSclipPosition.z / _DSclipPosition.w;","\t#else","\tfloat tmp = 0.5 + 0.5 * clipPos.z / clipPos.w;","\t#endif",i?"\tvec4 encode = packRGBAFace(tmp);":"\tvec4 encode = encode_float(tmp);","   gl_FragColor = encode;","}"].join("\n"),vertexShader:[e.ShaderChunk.clip_pars_vertex,e.ShaderChunk.skinning_pars_vertex,"varying vec4 clipPos;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","#ifdef PDSFX_USE_MAP","varying vec2 vUv;","#endif","void main() {",e.ShaderChunk.PDSFX_start_vertex,e.ShaderChunk.skinbase_vertex,e.ShaderChunk.skinning_vertex,"#ifdef PDSFX",e.ShaderChunk.default_vertex_with_normal,e.ShaderChunk.defaultnormal_vertex,"#else",e.ShaderChunk.default_vertex,"#endif","#ifdef USE_MAP_ALPHATEST","   vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif",e.ShaderChunk.clip_vertex,"   clipPos = gl_Position;",e.ShaderChunk.PDSFX_end_vertex,"#ifdef PDSFX_USE_MAP","vUv = uv;","#endif","}"].join("\n")}},a={uniforms:e.UniformsUtils.merge([e.UniformsLib.clipPlanes,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new e.Vector2(0,0)},repeatAlphaMap:{type:"v2",value:new e.Vector2(1,1)},bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1},offsetBumpMap:{type:"v2",value:new e.Vector2(0,0)},repeatBumpMap:{type:"v2",value:new e.Vector2(1,1)}}]),fragmentShaderPars:["varying vec3 normalView;"].join("\n"),fragmentShaderBody:["   vec3 normal = normalize( normalView );","   #ifdef DOUBLE_SIDED","       normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","   #endif","   gl_FragColor.xyz = normal * 0.5 + 0.5;"].join("\n"),vertexShaderPars:["varying vec3 normalView;"].join("\n"),vertexShaderBody:["   normalView = normalize( mvNormal );"].join("\n"),fragmentShader:[e.ShaderChunk.clip_pars_fragment,"#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","#ifdef USE_BUMPMAP","   /*#extension GL_OES_standard_derivatives : enable*/\n","varying vec2 vUv;","#ifndef PDSFX","varying vec3 vViewPosition;","#else","vec3 vViewPosition;","#endif",e.ShaderChunk.bumpmap_pars_fragment,"#endif","#if defined(PDSFX_USE_MAP) && !defined(USE_BUMPMAP)","varying vec2 vUv;","#endif","varying vec3 normalView;","void main() {",e.ShaderChunk.PDSFX_map_fragment,"#ifdef PDSFX","ComputeCommonValues();",e.ShaderChunk.PDSFX_discard_fragment,e.ShaderChunk.PDSFX_viewNormal_fragment,"#ifdef USE_BUMPMAP","vViewPosition = -ComputeViewPosition();","#endif","#endif",e.ShaderChunk.clip_fragment,"   #ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","       if ( alpha < ALPHATEST ) discard;","   #endif","#ifdef PDSFX","   vec3 normal = ComputeViewNormal();","#else","   vec3 normal = normalize( normalView );","#endif","   #ifdef DOUBLE_SIDED","       normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","   #endif","   #ifdef USE_BUMPMAP","       normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","   #endif","   gl_FragColor.xyz = normal * 0.5 + 0.5;","}"].join("\n"),vertexShader:[e.ShaderChunk.clip_pars_vertex,"varying vec3 normalView;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","#ifdef USE_BUMPMAP","varying vec2 vUv;","#ifndef PDSFX","varying vec3 vViewPosition;","#endif","uniform vec2 offsetBumpMap;","uniform vec2 repeatBumpMap;","#endif","#if defined(PDSFX_USE_MAP) && !defined(USE_BUMPMAP)","varying vec2 vUv;","#endif",e.ShaderChunk.morphtarget_pars_vertex,e.ShaderChunk.skinning_pars_vertex,"void main() {",e.ShaderChunk.PDSFX_start_vertex,e.ShaderChunk.morphnormal_vertex,e.ShaderChunk.skinbase_vertex,e.ShaderChunk.skinnormal_vertex,e.ShaderChunk.morphtarget_vertex,e.ShaderChunk.skinning_vertex,e.ShaderChunk.default_vertex_with_normal,e.ShaderChunk.defaultnormal_vertex,e.ShaderChunk.clip_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif","   normalView = transformedNormal;","   #ifdef USE_MAP_ALPHATEST","vUvMap = uv * repeatAlphaMap.xy + offsetAlphaMap.xy;","   #endif","   #ifdef USE_BUMPMAP","vUv = uv * repeatBumpMap.xy + offsetBumpMap.xy;","vViewPosition = -mvPosition.xyz;","   #endif",e.ShaderChunk.PDSFX_end_vertex,"#if defined(PDSFX_USE_MAP) && !defined(USE_BUMPMAP)","vUv = uv;","#endif","}"].join("\n")},s=function(i,r){i||(r=!1);var n=i?["#if !defined(RENDER_TO_FLOAT_TEXTURE)","gl_FragColor.xy = normalToOct22(normal);","#else","gl_FragColor.xyz = normalize(normal) * 0.5 + 0.5;","#endif"].join("\n"):["   gl_FragColor.x = normalToOct24(normal);","#ifdef USE_NEWSSLR","   gl_FragColor.z = roughness;","#else","   gl_FragColor.z = reflectionCoef;","#endif"].join("\n"),a=i?["#if !defined(RENDER_TO_FLOAT_TEXTURE)","gl_FragColor.xy = normalToOct22(normal);","#else","gl_FragColor.xyz = normalize(normal) * 0.5 + 0.5;","#endif"].join("\n"):["   gl_FragColor.x = normalToOct24(normal);","float roughnessValue = roughness;","#ifdef USE_ROUGHNESSMAP","roughnessValue = texture2D(roughnessMap, uvToUse).r;","#endif","#ifdef USE_GLOSSINESSMAP","roughnessValue = 1.0 - texture2D(glossinessMap, uvToUse).r;","#endif","#ifdef USE_NEWSSLR","gl_FragColor.z = min(max(roughnessValue, 0.025),0.975);","#else","   gl_FragColor.z = reflectionCoef;","#endif"].join("\n");return{uniforms:e.UniformsUtils.merge([e.UniformsLib.clipPlanes,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new e.Vector2(0,0)},repeatAlphaMap:{type:"v2",value:new e.Vector2(1,1)},bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1},offsetBumpMap:{type:"v2",value:new e.Vector2(0,0)},repeatBumpMap:{type:"v2",value:new e.Vector2(1,1)},normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new e.Vector2(1,1)},reflectionCoef:{type:"f",value:0},roughness:{type:"f",value:0},roughnessMap:{type:"t",value:null},glossinessMap:{type:"t",value:null}}]),fragmentShaderPars:[r?t.decalNormalStencilDepth:"","vec2 normalToOct22(in vec3 normal) {","float manNorm = abs(normal.x) + abs(normal.y) + abs(normal.z);","float oNx = normal.x / manNorm;","float oNy = normal.y / manNorm;","if (normal.z < 0.0) {","float tmpx = (1.0 - abs(oNy)) * (oNx >= 0.0 ? 1.0 : -1.0);","float tmpy = (1.0 - abs(oNx)) * (oNy >= 0.0 ? 1.0 : -1.0);","oNx = tmpx;","oNy = tmpy;","}","return floor((2047.0 * (0.5 * vec2(oNx, oNy) + 0.5))+0.5);","}","float normalToOct24(in vec3 normal) {","float manNorm = abs(normal.x) + abs(normal.y) + abs(normal.z);","float oNx = normal.x / manNorm;","float oNy = normal.y / manNorm;","if (normal.z < 0.0) {","float tmpx = (1.0 - abs(oNy)) * (oNx >= 0.0 ? 1.0 : -1.0);","float tmpy = (1.0 - abs(oNx)) * (oNy >= 0.0 ? 1.0 : -1.0);","oNx = tmpx;","oNy = tmpy;","}","vec2 compNormal = floor((4095.0 * (0.5 * vec2(oNx, oNy) + 0.5))+0.5);","return compNormal.x * 4096.0 + compNormal.y;","}","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","uniform float reflectionCoef;","uniform float roughness;","varying vec3 normalView;","varying vec4 clipPos;"].join("\n"),fragmentShaderBody:["   #ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","       if ( alpha < ALPHATEST ) discard;","   #endif","   vec3 normal = normalView;","   #ifdef DOUBLE_SIDED","       normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","   #endif",n,r?"gl_FragColor.xy = normalToOct22(normal); gl_FragColor.z = decalStencilValue;":"","   gl_FragColor.w = 0.5 + 0.5 * clipPos.z / clipPos.w;",i?["#if !defined(RENDER_TO_FLOAT_TEXTURE)","float convertedDepth = 8388608.0 * gl_FragColor.w;","gl_FragColor.z = floor(convertedDepth / 4096.0);","gl_FragColor.w = mod(convertedDepth, 4096.0);","#endif"].join("\n"):""].join("\n"),vertexShaderPars:["varying vec3 normalView;","varying vec4 clipPos;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif"].join("\n"),vertexShaderBody:["   normalView = normalize( mvNormal );","   #ifdef USE_MAP_ALPHATEST","vUvMap = uv * repeatAlphaMap.xy + offsetAlphaMap.xy;","   #endif","   clipPos = gl_Position;"].join("\n"),fragmentShader:[r?t.decalNormalStencilDepth:"","vec2 normalToOct22(in vec3 normal) {","float manNorm = abs(normal.x) + abs(normal.y) + abs(normal.z);","float oNx = normal.x / manNorm;","float oNy = normal.y / manNorm;","if (normal.z < 0.0) {","float tmpx = (1.0 - abs(oNy)) * (oNx >= 0.0 ? 1.0 : -1.0);","float tmpy = (1.0 - abs(oNx)) * (oNy >= 0.0 ? 1.0 : -1.0);","oNx = tmpx;","oNy = tmpy;","}","return floor((2047.0 * (0.5 * vec2(oNx, oNy) + 0.5))+0.5);","}",e.ShaderChunk.clip_pars_fragment,"float normalToOct24(in vec3 normal) {","float manNorm = abs(normal.x) + abs(normal.y) + abs(normal.z);","float oNx = normal.x / manNorm;","float oNy = normal.y / manNorm;","if (normal.z < 0.0) {","float tmpx = (1.0 - abs(oNy)) * (oNx >= 0.0 ? 1.0 : -1.0);","float tmpy = (1.0 - abs(oNx)) * (oNy >= 0.0 ? 1.0 : -1.0);","oNx = tmpx;","oNy = tmpy;","}","vec2 compNormal = floor((4095.0 * (0.5 * vec2(oNx, oNy) + 0.5))+0.5);","return compNormal.x * 4096.0 + compNormal.y;","}","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","#ifdef USE_BUMPMAP","varying vec2 vUv;","#ifndef PDSFX","varying vec3 vViewPosition;","#else","vec3 vViewPosition;","#endif",e.ShaderChunk.bumpmap_pars_fragment,"#endif","#if defined(PDSFX_USE_MAP) && !defined(USE_BUMPMAP)","varying vec2 vUv;","#endif","#if defined(USE_NORMALMAP) || defined(USE_ROUGHNESSMAP) || defined(USE_GLOSSINESSMAP)","varying vec2 uvToUse;","#endif","#ifdef USE_NORMALMAP","   /*#extension GL_OES_standard_derivatives : enable*/\n","#ifndef PDSFX","varying vec3 vViewPosition;","#else","vec3 vViewPosition;","#endif",e.ShaderChunk.normalmap_pars_fragment,"#endif","uniform float roughness;","#ifdef USE_ROUGHNESSMAP","uniform sampler2D roughnessMap;","#endif","#ifdef USE_GLOSSINESSMAP","uniform sampler2D glossinessMap;","#endif","uniform float reflectionCoef;","#ifndef PDSFX","varying vec3 normalView;","varying vec4 clipPos;","#endif","void main() {",e.ShaderChunk.PDSFX_map_fragment,"#ifdef PDSFX","ComputeCommonValues();",e.ShaderChunk.PDSFX_discard_fragment,e.ShaderChunk.PDSFX_viewNormal_fragment,"#if defined(USE_BUMPMAP) || defined(USE_NORMALMAP)","vViewPosition = -ComputeViewPosition();","#endif","#endif",e.ShaderChunk.clip_fragment,"   #ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","       if ( alpha < ALPHATEST ) discard;","   #endif","#ifdef PDSFX","   vec3 normal = ComputeViewNormal();","#else","   vec3 normal = normalView;","#endif","   #ifdef DOUBLE_SIDED","       normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","   #endif","#ifdef USE_NORMALMAP","normal = perturbNormal2Arb( -vViewPosition, normal );","#elif defined( USE_BUMPMAP )","       normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","   #endif",a,r?"gl_FragColor.xy = normalToOct22(normal); gl_FragColor.z = decalStencilValue;":"","#ifdef PDSFX","   gl_FragColor.w = 0.5 + 0.5 * _DSclipPosition.z / _DSclipPosition.w;","#else","   gl_FragColor.w = 0.5 + 0.5 * clipPos.z / clipPos.w;","#endif",i?["#if !defined(RENDER_TO_FLOAT_TEXTURE)","float convertedDepth = 8388608.0 * gl_FragColor.w;","gl_FragColor.z = floor(convertedDepth / 4096.0);","gl_FragColor.w = mod(convertedDepth, 4096.0);","#endif"].join("\n"):"","}"].join("\n"),vertexShader:[e.ShaderChunk.clip_pars_vertex,"#ifndef PDSFX","varying vec3 normalView;","varying vec4 clipPos;","#endif","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","#ifdef USE_BUMPMAP","varying vec2 vUv;","#ifndef PDSFX","varying vec3 vViewPosition;","#endif","uniform vec2 offsetBumpMap;","uniform vec2 repeatBumpMap;","#endif","#if defined(PDSFX_USE_MAP) && !defined(USE_BUMPMAP)","varying vec2 vUv;","#endif","#if defined(USE_NORMALMAP) && !defined(PDSFX)","\tvarying vec3 vViewPosition;","#endif","#if defined(USE_NORMALMAP) || defined(USE_ROUGHNESSMAP) || defined(USE_GLOSSINESSMAP)","varying vec2 uvToUse;","#endif",e.ShaderChunk.morphtarget_pars_vertex,e.ShaderChunk.skinning_pars_vertex,"void main() {",e.ShaderChunk.PDSFX_start_vertex,e.ShaderChunk.morphnormal_vertex,e.ShaderChunk.skinbase_vertex,e.ShaderChunk.skinnormal_vertex,e.ShaderChunk.morphtarget_vertex,e.ShaderChunk.skinning_vertex,e.ShaderChunk.default_vertex_with_normal,e.ShaderChunk.defaultnormal_vertex,e.ShaderChunk.clip_vertex,"#ifdef PDSFX","transformedNormal = _viewTangentSpace.Normal;","#endif","#ifdef USE_MAP_ALPHATEST","vUvMap = uv * repeatAlphaMap.xy + offsetAlphaMap.xy;","#endif","#ifdef USE_BUMPMAP","vUv = uv * repeatBumpMap.xy + offsetBumpMap.xy;","#ifndef PDSFX","vViewPosition = -mvPosition.xyz;","#endif","#endif","#if defined(USE_NORMALMAP) && !defined(PDSFX)","vViewPosition = -mvPosition.xyz;","#endif","#if defined(USE_NORMALMAP) || defined(USE_ROUGHNESSMAP) || defined(USE_GLOSSINESSMAP)","uvToUse = uv;","#endif","#ifndef PDSFX","normalView = transformedNormal;","clipPos = gl_Position;","#endif",e.ShaderChunk.PDSFX_end_vertex,"#if defined(PDSFX_USE_MAP) && !defined(USE_BUMPMAP)","vUv = uv;","#endif","}"].join("\n")}},o={uniforms:e.UniformsUtils.merge([e.UniformsLib.clipPlanes,{map:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new e.Vector2(0,0)},repeatAlphaMap:{type:"v2",value:new e.Vector2(1,1)}}]),fragmentShader:[e.ShaderChunk.clip_pars_fragment,"varying vec2 vUv;","varying vec2 vUv2;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","void main() {",e.ShaderChunk.PDSFX_map_fragment,"#ifdef PDSFX","ComputeCommonValues();",e.ShaderChunk.PDSFX_discard_fragment,"#endif",e.ShaderChunk.clip_fragment,"   #ifdef USE_MAP_ALPHATEST","   #ifdef ALPHA_CHANNEL","       float alpha = texture2D( map, vUvMap ).r;","   #else","       float alpha = texture2D( map, vUvMap ).w;","   #endif","       if ( alpha < ALPHATEST ) discard;","   #endif","   gl_FragColor = vec4(vUv.xy, vUv2.xy);","}"].join("\n"),vertexShader:[e.ShaderChunk.clip_pars_vertex,"varying vec2 vUv;","varying vec2 vUv2;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif",e.ShaderChunk.morphtarget_pars_vertex,e.ShaderChunk.skinning_pars_vertex,"void main() {",e.ShaderChunk.PDSFX_start_vertex,e.ShaderChunk.morphnormal_vertex,e.ShaderChunk.skinbase_vertex,e.ShaderChunk.morphtarget_vertex,e.ShaderChunk.skinning_vertex,e.ShaderChunk.default_vertex_with_normal,e.ShaderChunk.defaultnormal_vertex,e.ShaderChunk.clip_vertex,"   #ifdef USE_MAP_ALPHATEST","vUvMap = uv * repeatAlphaMap.xy + offsetAlphaMap.xy;","   #endif",e.ShaderChunk.PDSFX_end_vertex,"vUv = uv;","vUv2 = uv2;","}"].join("\n")};return{NormalDepthIoRRoughness:s(!1),NormalDepth:s(!0),DecalNormalStencilDepth:s(!0,!0),Normal:a,Depth:n(!1),DepthRGBA:n(!0),PickingFragment:i,PickingFragmentInstancing:r,TextureCoordinate:o,Chunks:t}}),define("Shaders/DeferredShaders",["DS/Shaders/DeferredShaders","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/DeferredShaders"),e}),define("DS/Visualization/OccurrenceRenderingOverride",["UWA/Class","DS/Visualization/ThreeJS_R57"],function(e,t){"use strict";var i,r=function(e,t){this.id=i.getNewId(),this.materialOverride=t instanceof r?t.materialOverride:t,this.opacity=e.opacity,this.renderPriorityActivated=!1};r.prototype.getOpacity=function(){return this.materialOverride?this.materialOverride.getOpacity():null},r.prototype.getColor=function(){return this.materialOverride?this.materialOverride.getColor():null},r.prototype.getFullMaterial=function(){return this.materialOverride?this.materialOverride.getFullMaterial():null},r.prototype.clone=function(){return new r({opacity:this.opacity},this.materialOverride)},r.prototype.getRenderPriorityOpacity=function(){return null===this.opacity?null:this.opacity},r.prototype.hasTransparency=function(){var e=this.getOpacity();return null!==e&&e<1},r.prototype.isPGPOnly=function(){return!1};var n=0,a=new WeakMap;function s(e){var t;return a.has(e)?t=a.get(e):(t=n++,a.set(e,t)),t}var o=0,l=e.extend({init:function(){this.id=o++,this.clipPlanes=[],this.clippingContext=null,this.clipPolyLine=null,this.clipCylinder=null,this.scissor=null,this.materialOverride=null,this.sectionCappingMaterials=null,this.sectionLinesProperties=null},clone:function(){var e=new l;return e.clipPlanes=this.clipPlanes,e.clippingContext=this.clippingContext,e.clipPolyLine=this.clipPolyLine,e.clipCylinder=this.clipCylinder,e.scissor=this.scissor,e.sectionLinesProperties=this.sectionLinesProperties,this.materialOverride instanceof r?e.materialOverride=this.materialOverride.clone():e.materialOverride=this.materialOverride,e},getFullMaterial:function(e){return this.materialOverride&&this.materialOverride.getFullMaterial(e)},getClippingSettings:function(){return this.clippingContext&&this.clippingContext.clippingSettings},setRenderPriority:function(e){e&&null!==e.opacity&&(this.materialOverride=new r(e,this.materialOverride))},getOverrideColor:function(e){if(!this.materialOverride)return null;if(e&&!e.overridable)return e.overridable;var i=this.getFullMaterial();if(i&&!i.overridable)return i.color;var r=this.materialOverride.getColor();return 0!==r&&r?new t.Color(r):null},isPurePGP:function(){return!this.clipPolyLine&&!this.scissor&&this.materialOverride&&this.materialOverride.isPGPOnly()&&!this.sectionCappingMaterials},getGSSOId:function(e){if(e){var t,i="";if(this.clipPlanes)for(t=0;t<this.clipPlanes.length;t++)i+="p"+s(this.clipPlanes[t]);return this.clippingContext&&(i+="k"+this.clippingContext.id),i+=this.materialOverride.getPGPGSSOId()}return""+this.id}});return l.setOverrideLink2Class=function(e){i=e},l}),define("Visualization/OccurrenceRenderingOverride",["DS/Visualization/OccurrenceRenderingOverride","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/OccurrenceRenderingOverride"),e}),define("DS/Shaders/AdvancedHighlightShaderSinglePass",["DS/Visualization/ThreeJS_R57","DS/Shaders/AdvancedHighlightShader"],function(e,t){"use strict";return{HighlightFace:{uniforms:e.UniformsUtils.merge([e.UniformsLib.clipPlanes,{map:{type:"t",value:null},rgbaDepth:{type:"t",value:null},offsetAlphaMap:{type:"v2",value:new e.Vector4(0,0)},repeatAlphaMap:{type:"v2",value:new e.Vector4(1,1)},iHighlightColor:{type:"v4",value:new e.Vector4(0,.6,1,1)},iHighlightIntensity:{type:"v2",value:new e.Vector2(1,-1)}}]),vertexShaderPars:["varying vec3 vMVNormal;","varying vec3 vMVPosition;","#if HIGHLIGHT_POLITE == 1","varying vec4 cP;","#endif"].join("\n"),vertexShaderBody:["    vMVNormal = mvNormal;","    vMVPosition = -mvPosition.xyz;","#if HIGHLIGHT_POLITE == 1","cP = gl_Position;","#endif"].join("\n"),fragmentShaderPars:["varying vec3 vMVNormal;","varying vec3 vMVPosition;","varying float reflectionFactor;","uniform vec4 iHighlightColor;","uniform vec2 iHighlightIntensity;","#if HIGHLIGHT_POLITE == 1","uniform sampler2D rgbaDepth;","varying vec4 cP;","#endif",t._computeDepthChunk].join("\n"),fragmentShaderBody:["vec3 I = vec3(0.0, 0.0, 1.0);","    if (!(projectionMatrix[3][3] > 0.0)) {","       I = normalize( vMVPosition.xyz );","    }","float reflectionFactor = abs(dot(normalize(vMVNormal),I));","#if HIGHLIGHT_POLITE == 1","float depthValue = getFaceDepthValue();","reflectionFactor = noZ == 1 ? 0.8 : depthValue < 0.5 ? (1.0 - 1.0 / 3.141) * reflectionFactor + 1.0/3.141 : reflectionFactor;","gl_FragColor = vec4( iHighlightColor.xyz * reflectionFactor, depthValue > 0.5 ? iHighlightIntensity.y : iHighlightIntensity.x);","#else","reflectionFactor = 1.0 - reflectionFactor;","  gl_FragColor = vec4( iHighlightColor.xyz, (0.6 * reflectionFactor * reflectionFactor + 0.2) * iHighlightIntensity.x );","#endif","\tgl_FragColor.a = min(gl_FragColor.a, 1.0);"].join("\n"),vertexShader:[e.ShaderChunk.clip_pars_vertex,e.ShaderChunk.skinning_pars_vertex,"#ifndef PDSFX","varying vec3 vMVNormal;","varying vec3 vMVPosition;","#endif","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform vec2 offsetAlphaMap;","uniform vec2 repeatAlphaMap;","#endif","#ifdef PDSFX_USE_MAP","varying vec2 vUv;","#endif","#if HIGHLIGHT_POLITE == 1 && !defined(PDSFX)","varying vec4 cP;","#endif","void main() {",e.ShaderChunk.PDSFX_start_vertex,e.ShaderChunk.skinbase_vertex,e.ShaderChunk.skinnormal_vertex,e.ShaderChunk.skinning_vertex,e.ShaderChunk.default_vertex_with_normal,e.ShaderChunk.defaultnormal_vertex,"#ifndef PDSFX","vMVNormal = transformedNormal;","vMVPosition = -mvPosition.xyz;","#endif","#ifdef USE_MAP_ALPHATEST","    vUvMap = uv * repeatAlphaMap + offsetAlphaMap;","#endif","    gl_Position = projectionMatrix * mvPosition;",e.ShaderChunk.clip_vertex,"#if HIGHLIGHT_POLITE == 1 && !defined(PDSFX)","cP = gl_Position;","#endif",e.ShaderChunk.PDSFX_end_vertex,"#ifdef PDSFX_USE_MAP","vUv = uv;","#endif","}"].join("\n"),fragmentShader:[e.ShaderChunk.clip_pars_fragment,"#ifndef PDSFX","varying vec3 vMVNormal;","varying vec3 vMVPosition;","#endif","uniform vec4 iHighlightColor;","uniform vec2 iHighlightIntensity;","#ifdef USE_MAP_ALPHATEST","varying vec2 vUvMap;","uniform sampler2D map;","#endif","#ifdef PDSFX_USE_MAP","varying vec2 vUv;","#endif","#if HIGHLIGHT_POLITE == 1","uniform sampler2D rgbaDepth;","#ifndef PDSFX","varying vec4 cP;","#else","vec4 cP;","#endif","#endif",t._computeDepthChunk,"void main() {",e.ShaderChunk.PDSFX_map_fragment,"#ifdef PDSFX","ComputeCommonValues();",e.ShaderChunk.PDSFX_discard_fragment,e.ShaderChunk.PDSFX_viewNormal_fragment,"vec3 mvPosition = ComputeViewPosition();","vec3 I = vec3(0.0, 0.0, 1.0);","if (!(projectionMatrix[3][3] > 0.0)) {","I = normalize( -mvPosition.xyz );","}","float reflectionFactor = abs( dot( I, _DSvNormal ) );","#if HIGHLIGHT_POLITE == 1","cP = _DSclipPosition;","#endif","#else","vec3 I = vec3(0.0, 0.0, 1.0);","if (!(projectionMatrix[3][3] > 0.0)) {","I = normalize( vMVPosition.xyz );","}","float reflectionFactor = abs(dot(normalize(vMVNormal), I));","#endif",e.ShaderChunk.clip_fragment,"#ifdef USE_MAP_ALPHATEST","   float alpha2 = texture2D( map, vUvMap ).w;","   if ( alpha2 < ALPHATEST ) discard;","#endif","#if HIGHLIGHT_POLITE == 1","float depthValue = getFaceDepthValue();","reflectionFactor = noZ == 1 ? 0.8 : depthValue < 0.5 ? (1.0 - 1.0 / 3.141) * reflectionFactor + 1.0/3.141 : reflectionFactor;","gl_FragColor = vec4( iHighlightColor.xyz * reflectionFactor, depthValue > 0.5 ? iHighlightIntensity.y : iHighlightIntensity.x);","#else","reflectionFactor = 1.0 - reflectionFactor;","  gl_FragColor = vec4( iHighlightColor.xyz, (0.6 * reflectionFactor*reflectionFactor + 0.2) * iHighlightIntensity.x );","#endif","\tgl_FragColor.a = min(gl_FragColor.a, 1.0);","}"].join("\n")}}}),define("Shaders/AdvancedHighlightShaderSinglePass",["DS/Shaders/AdvancedHighlightShaderSinglePass","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/AdvancedHighlightShaderSinglePass"),e}),define("DS/Visualization/BufferGeometry",["DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh","DS/Visualization/WidelinesHelper"],function(e,t,i){"use strict";class r{constructor({gl:e}){this.buffer=e.createBuffer(),this.nbGeometries=0,this.isShared=!1}deallocate(e,t){this.nbGeometries--,0===this.nbGeometries&&(t&&this.isShared&&t.memory.sharedbuffers--,e.deleteBuffer(this.buffer),this.buffer=null)}}e.GLIndexBuffer=class extends r{constructor({gl:e,numIndices:t=0,use32bitIndexBuffer:i=!1,data:r=null}){super({gl:e}),this.use32bitIndexBuffer=i,this.numIndices=t,r&&(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,r,e.STATIC_DRAW),this.use32bitIndexBuffer=r instanceof Uint32Array,this.numIndices=r.length)}get byteLength(){return this.numIndices*this.bytesPerIndex}get bytesPerIndex(){return this.use32bitIndexBuffer?4:2}get glFormat(){return this.use32bitIndexBuffer?5125:5123}};let n=0;e.GLVertexBuffer=class extends r{constructor({gl:e}){super({gl:e}),this.numVertices=0,this.interleavedData=null,this.id=n++,this.layout=null,this.needsUpdate=!1}};class a{constructor(){this.clear()}clear(){this._attributes=new Map}clone(){const e=new a;return this._attributes.forEach((t,i)=>e._attributes.set(i,Object.assign({},t))),e}set(e){for(let t in e)this.setAttribute(Object.assign({name:t},e[t]))}setAttribute({name:t,type:i,offset:r,stride:n,bufferId:a=0}){if(!e.VertexAttribute[i])throw new Error(`Vertex attribute '${t}': unknown type (${i}), see GPUFormats.VertexAttribute for acceptable data types`);if(r<0||r>=n)throw new Error(`Invalid offset/stride, expected 0 <= offset (${r}) < stride (${n})`);this._attributes.set(t,{name:t,type:i,offset:r,bufferId:a,stride:n})}remove(e){this._attributes.delete(e)}get(e){return this._attributes.get(e)}has(e){return this._attributes.has(e)}getNames(){return[...this._attributes.keys()]}size(){return this._attributes.size}forEach(e){this._attributes.forEach(t=>e(t))}getSignature(){let e=[];return this._attributes.forEach(t=>e.push(`|${t.name}:${t.type}>`)),e.sort().join()}getBufferStrides(){const e=[];return this._attributes.forEach(t=>e[t.bufferId]=t.stride),e}getBufferAttributes(){const e=[];return this._attributes.forEach(t=>{e[t.bufferId]?e[t.bufferId].push(t.name):e[t.bufferId]=[t.name]}),e}pickAnyAttribute({bufferId:e=-1}={}){if(0===this.size())return null;const t=this._attributes.values();if(e<0)return t.next().value;for(let i=t.next();!i.done;i=t.next())if(i.value.bufferId===e)return i.value;return null}isFullInterleaved(){return!!this.getFullInterleaving()}getFullInterleaving(){if(0===this._attributes.size)return;const e=this._attributes.values();let t=e.next().value,i=t.bufferId,r=t.stride;for(let n=e.next();!n.done;n=e.next())if(i!==(t=n.value).bufferId||r!==t.stride)return;return{bufferId:i,stride:r}}interleave({order:t=null,targetBufferId:i=0,allAttributes:r=!0}={}){if(r)if(t){const e=new Set(t);for(let i of this._attributes.keys())e.has(i)||t.push(i)}else t=this.getNames();else if(!t)return;let n=0;for(let r=0;r<t.length;r++){const a=this._attributes.get(t[r]);a&&(a.offset=n,a.bufferId=i,n+=e.VertexAttribute[a.type].size)}for(let e=0;e<t.length;e++){const i=this._attributes.get(t[e]);i&&(i.stride=n)}}}e.VertexLayout=a;var s=function(e,t,i){this.parentGeometry=e,this.linkedGeometry=t,this.attrName=i;var r,n,a=this;this.parentGeometry[i]=this,this.linkedGeometry[i]=this,r=function(){a.parentGeometry.removeEventListener("dispose",r),a.linkedGeometry.dispose()},this.parentGeometry.addEventListener("dispose",r),n=function(){a.linkedGeometry.removeEventListener("dispose",n),a.parentGeometry[i]=null,a.linkedGeometry[i]=null},this.linkedGeometry.addEventListener("dispose",n)};s.prototype._isParent=function(e){return this.parentGeometry===e};var o=function(e,t){s.call(this,e,t,"wideLinesLinker"),this.lineStructureMap=new Map,this.originalDGToWideDG=new Map};function l(){throw new Error("No data for this attribute")}o.prototype=Object.create(s.prototype);class c{constructor(){e.EventDispatcher.call(this),this.id=e.GeometryIdCount++,this._type=2,this.needsUpdate=!1,this.decorations=null,this.vertexBufferGPU=null,this.indexBufferGPU=null,this.vertexOffsetGPU=0,this.vertexCountGPU=0,this.sharedBuffers=!1,this.noMeshInRAM=!1,this.vertexIndexArray=null,this.__migration_fixed_attribute_buffers=new Map,this.buffers=[],this.layout=new a,this.staleIndices=null,this.staleAttributes=null,this.getVertexPosition=l,this.getVertexNormal=l,this.getVertexColor=l,this.getUV=l,this.getUV2=l,this.dynamic=!1,this.boundingBox=null,this.boundingSphere=null,this.lightMap=null,this.drawingGroups=[],this.meshList=[],this.wideLinesLinker=null,this.cpuPatternFrame=0,this.cpuPatternMode=!1,this.editable=!1,this.indexOffsetGPU=0,this.__impl_compressedNormals=void 0,this.__impl_compressedVertices=void 0,this.__impl_compressedUVs=void 0,this.__impl_compressedColors=void 0,this.quantizedVector=null,this.offsetVector=null}static copyRawAttribute({source_bgds:t,source_attr:i,source_vertex_offset:r=0,target_array:n,target_attr:a,target_vertex_offset:s=0,num_vertices:o}){if(i.type||(i=t.layout.get(i)),i.type!==a.type)throw new Error(`Cannot copy attributes with different types (${i.type} -> ${a.type})`);if(o||(o=t.getVertexCount()),!o)return;const l=i.stride,c=a.stride,h=e.VertexAttribute[i.type].size,u=t.buffers[i.bufferId],d=new Uint8Array(u.buffer,u.byteOffset+r*l+i.offset),p=new Uint8Array(n.buffer,n.byteOffset+s*c+a.offset);for(let e=0;e<o;e++){const t=e*l,i=e*c;for(let e=0;e<h;e++)p[i+e]=d[t+e]}}exportRaw({target_array:e,target_layout:t}){t.forEach(t=>{c.copyRawAttribute({source_bgds:this,source_attr:t.name,target_array:e,target_attr:t})})}markIndexStale(e,t){this.staleIndices?(this.staleIndices[0]=Math.min(this.staleIndices[0],e),this.staleIndices[1]=Math.max(this.staleIndices[1],t)):this.staleIndices=[e,t]}isStale(){return this.staleIndices||this.staleAttributes}isAttributeStale(e){return!(!this.staleAttributes||!this.staleAttributes.get(e))}markAttributeStale(e,t,i){this.staleAttributes||(this.staleAttributes=new Map);let r=this.staleAttributes.get(e);r?(r[0]=Math.min(r[0],t),r[1]=Math.max(r[1],i)):this.staleAttributes.set(e,[t,i])}markAllAttributesStale(){const e=this.getVertexCount();this.layout.forEach(t=>this.markAttributeStale(t.name,0,e))}_markIndexClean(){this.staleIndices=null}_markAttributeClean(e){this.staleAttributes.delete(e),0===this.staleAttributes.size&&(this.staleAttributes=null)}_markAllAttributesClean(){this.staleAttributes=null}getBuffersMemorySize(){let e=this.vertexIndexArray?this.vertexIndexArray.byteLength:0;for(let t=0;t<this.buffers.length;t++)this.buffers[t]&&(e+=this.buffers[t].byteLength);return e}_uploadStaleIndices(e){if(!this.staleIndices)return;const[t,i]=this.staleIndices;this._markIndexClean();const r=this.indexBufferGPU;if(!r)return;let n=this.vertexIndexArray.subarray(t,i);if(0!==this.vertexOffsetGPU){const e=this.vertexOffsetGPU;n=n.map(t=>t+e)}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r.buffer),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,(this.indexOffsetGPU+t)*r.bytesPerIndex,n)}_uploadStaleVertices(t){if(!this.staleAttributes)return;const i=this.staleAttributes;this._markAllAttributesClean();const r=this.vertexBufferGPU;if(!r)return;let n=2**32,a=-(2**32);if(i.forEach((t,i)=>{t[0]<n&&(n=t[0]),t[1]>a&&(a=t[1]),e.BufferGeometryDS.copyRawAttribute({source_bgds:this,source_attr:i,source_vertex_offset:t[0],target_array:r.interleavedData,target_attr:r.layout.get(i),target_vertex_offset:t[0]+this.vertexOffsetGPU,num_vertices:t[1]-t[0]})}),r.needsUpdate=!1,n>=a)return;const s=r.layout.pickAnyAttribute().stride,o=this.vertexOffsetGPU+s*n,l=this.vertexOffsetGPU+s*a,c=new Uint8Array(r.interleavedData.buffer,r.interleavedData.byteOffset+o,l-o);t.bindBuffer(t.ARRAY_BUFFER,r.buffer),t.bufferSubData(t.ARRAY_BUFFER,o,c)}_compactArrays(e){if(!e.has(this)){e.add(this);var t=this.drawingGroups;this.drawingGroups=new Array(t.length);for(var i=0;i<t.length;i++)this.drawingGroups[i]=t[i],t[i]._compactArrays();var r=this.meshList;this.meshList=new Array(r.length);for(i=0;i<r.length;i++)this.meshList[i]=r[i]}}getVertexCount(){if(0===this.buffers.length)return 0;const e=this.layout.pickAnyAttribute();return e&&this.buffers[e.bufferId]?this.buffers[e.bufferId].byteLength/e.stride:0}_getVertexPositionAccessor(){const e=this.vertexPositionArray;if(!e)return l;const t=this.quantizedVector,i=this.offsetVector;return this.compressedVertices?function(r,n){const a=2*r,s=e[a],o=e[a+1];n.x=t.x*(Math.floor(s/256)+i.x),n.z=t.z*(Math.floor(o/256)+i.z),n.y=t.y*(s%256*256+o%256+i.y)}:function(t,i){const r=3*t;i.x=e[r],i.y=e[r+1],i.z=e[r+2]}}_updateVertexPositionAccessor(){this.getVertexPosition=this._getVertexPositionAccessor()}hasTangentBinormal(){return this.layout.has("tangent")&&this.layout.has("binormal")}clearMeshInRAM(e){e||(this.vertexIndexArray=null),this.buffers=[]}_getVertexNormalAccessor(){const e=this.vertexNormalArray;if(!e)return l;return this.compressedNormals?function(t,i){const r=e[t],n=(a=r,{x:Math.floor(a/4096)/4095,y:a%4096/4095});var a,s,o;if(i.x=2*n.x-1,i.y=2*n.y-1,i.z=1-Math.abs(i.x)-Math.abs(i.y),i.z<=0){const e=(s=i.x,o=i.y,{x:s>=0?1:-1,y:o>=0?1:-1}),t=i.x;i.x=-Math.abs(i.y)*e.x+e.x,i.y=-Math.abs(t)*e.y+e.y}}:function(t,i){const r=3*t;i.x=e[r],i.y=e[r+1],i.z=e[r+2]}}_updateVertexNormalAccessor(){this.getVertexNormal=this._getVertexNormalAccessor()}_getVertexColorAccessor(){const e=this.vertexColorArray;if(!e)return l;return this.compressedColors?function(t,i){const r=e[2*t],n=e[2*t+1],a=Math.floor(r/65536),s=Math.floor(r/256)%256,o=r%256,l=n;return i.x=a/255,i.y=s/255,i.z=o/255,i.w=l/255,i}:function(t,i){const r=4*t;return i.x=e[r],i.y=e[r+1],i.z=e[r+2],i.w=e[r+3],i}}_updateVertexColorAccessor(){this.getVertexColor=this._getVertexColorAccessor()}_getVertexUVAccessor(e){if(!e)return l;return this.compressedUVs?function(t,i){var r=e[2*t],n=e[2*t+1],a=Math.floor(r/256),s=Math.floor(n/256),o=r%256*256+n%256;return i.x=a/65535,i.y=o/65535,i.z=s/65535,i}:function(t,i){const r=3*t;return i.x=e[r],i.y=e[r+1],i.z=e[r+2],i}}_updateVertexUVAccessor(){this.getUV=this._getVertexUVAccessor(this.vertexUvArray)}_updateVertexUV2Accessor(){this.getUV2=this._getVertexUVAccessor(this.vertexUv2Array)}startIteration(){return!0}endIteration(){return!0}getDGRange(){const e=this.drawingGroups;let t=1/0,i=-1/0;for(let r=0;r<e.length;r++){const{start:n,count:a}=e[r];t=Math.min(t,n),i=Math.max(i,n+a)}return[t,i]}computeBoundingBox(){var t=[0,0,0],i=[0,0,0],r=this.getVertexCount();if(r>=1){t=[1/0,1/0,1/0],i=[-1/0,-1/0,-1/0];for(var n=new e.Vector3,a=0;a<r;a++)this.getVertexPosition(a,n),isNaN(n.x)||isNaN(n.y)||isNaN(n.z)||(n.x<t[0]&&(t[0]=n.x),n.y<t[1]&&(t[1]=n.y),n.z<t[2]&&(t[2]=n.z),n.x>i[0]&&(i[0]=n.x),n.y>i[1]&&(i[1]=n.y),n.z>i[2]&&(i[2]=n.z))}return t=new e.Vector3(t[0],t[1],t[2]),i=new e.Vector3(i[0],i[1],i[2]),this.boundingBox=new e.Box3(t,i),this.boundingBox}_computeOrientedBoundingBox(t,i){if(!t)return null;var r=new e.Vector3,n=new e.Vector3,a=new e.Vector3,s=this.vertexIndexArray,o=this.getVertexCount();if(o>=1){var l=new e.Vector3;if(i)for(var c=!0,h=0;h<i.length;h++){var u=i[h];if(u.layerNum&&u.count){if(c){c=!1;var d=s[u.start];this.getVertexPosition(d,l),n.set(l.x,l.y,l.z).applyMatrix4(t),a.set(l.x,l.y,l.z).applyMatrix4(t)}for(var p=u.start;p<u.start+u.count;p++){d=s[p];this.getVertexPosition(d,l),r.set(l.x,l.y,l.z).applyMatrix4(t),r.x<n.x&&(n.x=r.x),r.y<n.y&&(n.y=r.y),r.z<n.z&&(n.z=r.z),r.x>a.x&&(a.x=r.x),r.y>a.y&&(a.y=r.y),r.z>a.z&&(a.z=r.z)}}}else{this.getVertexPosition(0,l),n.set(l.x,l.y,l.z).applyMatrix4(t),a.set(l.x,l.y,l.z).applyMatrix4(t);for(var f=1;f<o;f++)this.getVertexPosition(f,l),r.set(l.x,l.y,l.z).applyMatrix4(t),r.x<n.x&&(n.x=r.x),r.y<n.y&&(n.y=r.y),r.z<n.z&&(n.z=r.z),r.x>a.x&&(a.x=r.x),r.y>a.y&&(a.y=r.y),r.z>a.z&&(a.z=r.z)}}return new e.Box3(n,a)}computeBoundingSphere(){this.boundingSphere||(this.boundingSphere=new e.Sphere);var t=this.boundingBox;t&&(this.boundingSphere.radius=t.max.clone().sub(t.min).multiplyScalar(.5).length(),this.boundingSphere.center=t.max.clone().add(t.min).multiplyScalar(.5))}computeUVs(t){if(!this.vertexUvArray){var i=new Float32Array(3*this.getVertexCount());this.vertexUvArray=i;var r=new e.Vector3;if(this.vertexNormalArray){t||(t=this.computeBoundingBox());for(var n=[t.min.x,t.min.y,t.min.z],a=[t.max.x-t.min.x,t.max.y-t.min.y,t.max.z-t.min.z],s=0;s<i.length/3;s++){var o=3*s,l=new e.Vector3;this.getVertexNormal(s,l);var c=Math.abs(l.x),h=Math.abs(l.y),u=0;h>c&&(c=h,u=1),(h=Math.abs(l.z))>c&&(c=h,u=2);var d=(u+1)%3,p=(u+2)%3;this.getVertexPosition(s,r);var f=[r.x,r.y,r.z];i[o]=(f[d]-n[d])/Math.min(a[d],a[p]),i[o+1]=(f[p]-n[p])/Math.min(a[d],a[p]),i[o+2]=0}}}}_computeUV(t,i,r){var n=new e.Vector3,a=new e.Vector3;this.getVertexNormal(t,n),this.getVertexPosition(t,a);var s=Math.abs(n.x),o=Math.abs(n.y),l=0;o>s&&(s=o,l=1),(o=Math.abs(n.z))>s&&(s=o,l=2);var c=(l+1)%3,h=(l+2)%3,u=[i.min.x,i.min.y,i.min.z],d=[i.max.x-i.min.x,i.max.y-i.min.y,i.max.z-i.min.z],p=[a.x,a.y,a.z];r.set((p[c]-u[c])/Math.min(d[c],d[h]),(p[h]-u[h])/Math.min(d[c],d[h]))}computeTangents(t){let i=this.vertexTangentArray,r=this.vertexBinormalArray;if(r&&i)return;if(i){var n=new e.Vector3,a=new e.Vector3,s=new e.Vector3;r=this.vertexBinormalArray=new Float32Array(i.length);for(var o=0;o<i.length;o+=3)this.getVertexNormal(o/3,n),n.normalize(),a.set(i[o],i[o+1],i[o+2]),a.normalize(),s.crossVectors(n,a),r[o]=s.x,r[o+1]=s.y,r[o+2]=s.z;return}o=0;var l=0,c=0,h=0,u=new e.Vector3,d=new e.Vector3,p=new e.Vector3,f=new e.Vector2,m=new e.Vector2,g=new e.Vector2,v=new e.Vector2,S=new e.Vector2,_=new e.Vector3,y=new e.Vector3,x=new e.Vector3,M=(n=new e.Vector3,a=new e.Vector3,s=new e.Vector3,new e.Vector3),P=0,C=0,b=0,D=0,w=0,E=0,T=0,A=3*this.getVertexCount();for(i||(i=this.vertexTangentArray=new Float32Array(A)),r||(r=this.vertexBinormalArray=new Float32Array(A)),o=0;o<i.length;o++)i[o]=0,r[o]=0;var I=this.computeBoundingBox(),R=this.vertexIndexArray;const L=this.vertexUvArray;for(var O=0;O<this.drawingGroups.length;O++){var N=this.drawingGroups[O];if(4===N.glType)for(o=N.start;o<N.start+N.count;o+=3){l=R[o],c=R[o+1],h=R[o+2],this.getVertexPosition(l,u),this.getVertexPosition(c,d),this.getVertexPosition(h,p),L?(this.getUV(l,f),this.getUV(c,m),this.getUV(h,g)):(this._computeUV(l,I,f),this._computeUV(c,I,m),this._computeUV(h,I,g)),_.subVectors(d,u),y.subVectors(p,u),v.subVectors(m,f),S.subVectors(g,f);var F=v.x*S.y-S.x*v.y;Math.abs(F)>1e-8?(P=(F=1/F)*(S.y*_.x-v.y*y.x),C=F*(S.y*_.y-v.y*y.y),b=F*(S.y*_.z-v.y*y.z),D=F*(v.x*y.x-S.x*_.x),w=F*(v.x*y.y-S.x*_.y),E=F*(v.x*y.z-S.x*_.z)):(P=1,C=0,b=0,D=0,w=1,E=0),i[3*l]+=P,i[3*c]+=P,i[3*h]+=P,i[3*l+1]+=C,i[3*c+1]+=C,i[3*h+1]+=C,i[3*l+2]+=b,i[3*c+2]+=b,i[3*h+2]+=b,r[3*l]+=D,r[3*c]+=D,r[3*h]+=D,r[3*l+1]+=w,r[3*c+1]+=w,r[3*h+1]+=w,r[3*l+2]+=E,r[3*c+2]+=E,r[3*h+2]+=E}}for(o=0;o<i.length;o+=3)this.getVertexNormal(o/3,n),a.set(i[o],i[o+1],i[o+2]),s.set(r[o],r[o+1],r[o+2]),a.normalize(),s.normalize(),T=n.dot(a),(M=(new e.Vector3).copy(a)).sub(x.copy(n).multiplyScalar(T)),M.normalize(),i[o]=M.x,i[o+1]=M.y,i[o+2]=M.z,r[o]=s.x,r[o+1]=s.y,r[o+2]=s.z}computeLineDistances(e){i._computeLineDistances(this,e)}computeWideLine(t,r){var n,a=!1;return!this.wideLinesLinker||this.wideLinesLinker.linkedGeometry.vertexBufferGPU&&this.wideLinesLinker.linkedGeometry.vertexBufferGPU.needsUpdate?(this.wideLinesLinker&&(a=!0,this.wideLinesLinker.linkedGeometry.dispose()),(n=new e.BufferGeometryDS).editable=this.editable,new o(this,n)):n=this.wideLinesLinker.linkedGeometry,i._computeWideLineDG(this,n,t,r,a)}__setTypedArraysForWidelines(){var t=this.vertexPositionArray;if(!(t instanceof Float32Array)){var i=this.vertexPreviousPositionArray,r=this.vertexNextPositionArray,n=this.vertexSideExtrusionArray,a=this.vertexColorArray,s=this.vertexLineDistancesArray,o=this.vertexPatternStartEndArray,l=this.vertexIndexArray;this.vertexPositionArray=new Float32Array(t),this.vertexPreviousPositionArray=new Float32Array(i),this.vertexNextPositionArray=new Float32Array(r),this.vertexSideExtrusionArray=new Float32Array(n),a&&(this.vertexColorArray=new Float32Array(a)),s&&(this.vertexLineDistancesArray=new Float32Array(s)),o&&(this.vertexPatternStartEndArray=new Float32Array(o)),t.length>196608&&e.supportedExtensions.elementIndexUint?this.vertexIndexArray=new Uint32Array(l):this.vertexIndexArray=new Uint16Array(l)}}deallocate(e,t){t&&(this.vertexBufferGPU||this.indexBufferGPU)&&t.memory.geometries--,this.vertexBufferGPU&&(this.vertexBufferGPU.deallocate(e,t),this.vertexBufferGPU=null),this.indexBufferGPU&&(this.indexBufferGPU.deallocate(e,t),this.indexBufferGPU=null)}addRefVBO(t,i){i||this.meshList.push(t);var r=function(t){if(t&&t._source===e.AssetSource.MATERIAL_MANAGER){t._useCount++;for(var i=t._getTextures(!1),n=0;n<i.length;n++){var a=i[n];a&&a._source===e.AssetSource.MATERIAL_MANAGER&&a._useCount++}r(t.line),r(t.politeMaterial),r(t.backMaterial),r(t.point)}};r(t.material),r(t.gas),t.matApp&&(r(t.matApp._material),r(t.matApp._materialGeomFace),r(t.matApp._materialLine),r(t.matApp._materialPoint),t.matApp._lightMap&&t.matApp._lightMap.texture&&t.matApp._lightMap.texture._source===e.AssetSource.MATERIAL_MANAGER&&t.matApp._lightMap.texture._useCount++);for(var n=0;n<this.drawingGroups.length;n++){var a=this.drawingGroups[n];r(a.material),r(a.gas)}this.lightMap&&this.lightMap._source===e.AssetSource.MATERIAL_MANAGER&&this.lightMap._useCount++}releaseVBO(t,i){var r=function(t){if(t&&t._source===e.AssetSource.MATERIAL_MANAGER){t._useCount--,t._useCount<=0&&t.dispose();for(var i=t._getTextures(!1),n=0;n<i.length;n++){var a=i[n];a&&a._source===e.AssetSource.MATERIAL_MANAGER&&(a._useCount--,a._useCount<=0&&a.dispose())}r(t.line),r(t.politeMaterial),r(t.backMaterial),r(t.point)}},n=this.meshList.indexOf(t);if(-1!==n){i||this.meshList.splice(n,1),r(t.material),r(t.gas),t.matApp&&(r(t.matApp._material),r(t.matApp._materialGeomFace),r(t.matApp._materialLine),r(t.matApp._materialPoint),t.matApp._lightMap&&t.matApp._lightMap.texture&&t.matApp._lightMap.texture._source===e.AssetSource.MATERIAL_MANAGER&&(t.matApp._lightMap.texture._useCount--,t.matApp._lightMap.texture._useCount<=0&&t.matApp._lightMap.texture.dispose()));for(var a=0;a<this.drawingGroups.length;a++){var s=this.drawingGroups[a];r(s.material),r(s.gas)}this.lightMap&&this.lightMap._source===e.AssetSource.MATERIAL_MANAGER&&(this.lightMap._useCount--,this.lightMap._useCount<=0&&this.lightMap.dispose())}else console.warn("BufferGeometryDS tried to break the link with a THREE.Mesh, but it failed !");0===this.meshList.length&&this.dispose()}dispose(){this.dispatchEvent({type:"dispose"})}clone(i){var r=new e.BufferGeometryDS;for(let e=0;e<this.buffers.length;e++)r.buffers.push(this.buffers[e].slice());r.layout=this.layout.clone(),r.__migration_fixed_attribute_buffers=new Map(this.__migration_fixed_attribute_buffers),r.compressedNormals=this.compressedNormals,r.compressedVertices=this.compressedVertices,r.compressedUVs=this.compressedUVs,r.compressedColors=this.compressedColors,this.vertexIndexArray&&(r.vertexIndexArray=this.vertexIndexArray.slice()),r.boundingBox=this.boundingBox?this.boundingBox.clone():null,r.boundingSphere=this.boundingSphere?this.boundingSphere.clone():null,r.offsetVector=this.offsetVector,r.quantizedVector=this.quantizedVector,r.drawingGroups=[];for(var n=0;n<this.drawingGroups.length;n++){var a=this.drawingGroups[n],s=[],o=new t.DrawingGroup(a.gas,a.material,a.glType,a.start,a.count,null,null,a._geomType,a.gasIndex);if(a instanceof t.DrawingGroup)for(l=0;l<a.getPrimitivesCount();l++){h=new t.SGPrimitive({type:a.getPrimitiveType(l),cgmId:a.getPrimitiveCgmId(l),rep:a.getPrimitiveRep(l),group:o,start:a.getPrimitiveStart(l),count:a.getPrimitiveCount(l)});s.push(h)}else for(var l=0;l<a._primitives.length;l++){var c=a._primitives[l],h=new t.SGPrimitive({type:c.type,cgmId:c.cgmId,rep:c.rep,group:o,start:c.start,count:c.count});s.push(h)}o.geometry=r,o._primitives=s,r.drawingGroups.push(o)}return r}merge(t,i,r){if(!t.layout||!this.layout)throw new Error("Need vertex layout to be able to merge buffers");if(t.layout.getSignature()!==this.layout.getSignature())throw new Error("Cannot merge buffers with different layouts");const n=this.getVertexCount(),a=t.getVertexCount(),s=this.layout.getBufferAttributes(),o=this.layout.getBufferStrides();for(let e=0;e<this.buffers.length;e++){const i=o[e],r=new Uint8Array(i*(n+a));r.set((l=this.buffers[e],new Uint8Array(l.buffer,l.byteOffset,l.byteLength)));const h=s[e];for(let e=0;e<h.length;e++)c.copyRawAttribute({source_bgds:t,source_attr:t.layout.get(h[e]),source_vertex_offset:0,target_array:r,target_attr:this.layout.get(h[e]),target_vertex_offset:n,num_vertices:a});this.buffers[e]=new Float32Array(r.buffer)}var l;this.markAllAttributesStale();const h=this.vertexIndexArray.length,u=t.vertexIndexArray.length,d=h+u>=65536?new Uint32Array(h+u):new Uint16Array(h+u);function p(e){e&&(e.isShared?(e.nbGeometries--,0===e.nbGeometries&&e.deallocate(i,r)):e.deallocate(i,r))}d.set(this.vertexIndexArray,0),d.set(t.vertexIndexArray.map(e=>e+n),h),this.vertexIndexArray=d,p(this.vertexBufferGPU),this.vertexBufferGPU=null,p(this.indexBufferGPU),this.indexBufferGPU=null;for(let e=0;e<t.drawingGroups.length;e++){let i=t.drawingGroups[e];i.geometry=this,i.start+=h;for(let e=0;e<i.getPrimitivesCount();e++)i._setPrimitiveStart(i.getPrimitiveStart(e)+h,e);this.drawingGroups.push(i)}for(let i=0;i<this.meshList.length;i++){let r=this.meshList[i];if(r.layer)for(let i=0;i<t.drawingGroups.length;i++){let n=t.drawingGroups[i],a=new e.DrawableInterval(1,n.start,n.count);a.primitiveStart=0,a.primitiveCount=n.getPrimitivesCount();let s=new e.LayerInterval(this,n,a);r.layer.layers.push(s)}}return this}}function h(t,i,r,n){t.buffers[i]?t.layout.setAttribute({name:r,type:n,offset:0,stride:e.VertexAttribute[n].size,bufferId:i}):t.layout.remove(r)}e.BufferGeometryDS=c;const u=new Map([["vertexPositionArray",(e,t)=>{h(e,t,"position",e.compressedVertices?"float32x2":"float32x3"),e._updateVertexPositionAccessor()}],["vertexNormalArray",(e,t)=>{h(e,t,"normal",e.compressedNormals?"float32":"float32x3"),e._updateVertexNormalAccessor()}],["vertexUvArray",(e,t)=>{h(e,t,"uv",e.compressedUVs?"float32x2":"float32x3"),e._updateVertexUVAccessor()}],["vertexUv2Array",(e,t)=>{h(e,t,"uv2",e.compressedUVs?"float32x2":"float32x3"),e._updateVertexUV2Accessor()}],["vertexColorArray",(e,t)=>{h(e,t,"color",e.compressedColors?"float32x2":"float32x4"),e._updateVertexColorAccessor()}],["vertexTangentArray",(e,t)=>h(e,t,"tangent","float32x3")],["vertexBinormalArray",(e,t)=>h(e,t,"binormal","float32x3")],["vertexLineDistancesArray",(e,t)=>h(e,t,"lineDistance","float32x2")],["vertexPatternStartEndArray",(e,t)=>h(e,t,"patternStartEnd","float32x2")],["vertexPreviousPositionArray",(e,t)=>h(e,t,"previousPos","float32x3")],["vertexNextPositionArray",(e,t)=>h(e,t,"followingPos","float32x3")],["vertexSideExtrusionArray",(e,t)=>h(e,t,"sideExtrusion","float32")],["vertexSkinIndexArray",(e,t)=>h(e,t,"skinIndex","float32x4")],["vertexSkinWeightArray",(e,t)=>h(e,t,"skinWeight","float32x4")]]);function d(t){Object.defineProperty(e.BufferGeometryDS.prototype,t,{get:function(){let e=this.__migration_fixed_attribute_buffers.get(t);return void 0===e?null:this.buffers[e]},set:function(e){let i=this.__migration_fixed_attribute_buffers.get(t);void 0===i&&this.__migration_fixed_attribute_buffers.set(t,i=this.buffers.length),this.buffers[i]=e,u.get(t)(this,i)}})}function p(t,i,r=!1){const n=`__impl_${t}`;Object.defineProperty(e.BufferGeometryDS.prototype,t,{get:function(){return void 0===this[n]&&(this[n]=r),this[n]},set:function(e){this[n]=e;for(let e=0;e<i.length;e++){const t=this.__migration_fixed_attribute_buffers.get(i[e]);void 0!==t&&u.get(i[e])(this,t)}}})}function f(e,t){Object.defineProperty(e.prototype,t,{get:()=>{throw new Error(`(GET) Invalid property: ${t}`)},set:()=>{throw new Error(`(SET) Invalid property: ${t}`)}})}return p("compressedNormals",["vertexNormalArray"]),p("compressedVertices",["vertexPositionArray"]),p("compressedUVs",["vertexUvArray","vertexUv2Array"]),p("compressedColors",["vertexColorArray"]),d("vertexPositionArray"),d("vertexNormalArray"),d("vertexUvArray"),d("vertexUv2Array"),d("vertexTangentArray"),d("vertexBinormalArray"),d("vertexColorArray"),d("vertexLineDistancesArray"),d("vertexPatternStartEndArray"),d("vertexPreviousPositionArray"),d("vertexNextPositionArray"),d("vertexSideExtrusionArray"),d("vertexSkinIndexArray"),d("vertexSkinWeightArray"),f(e.GLVertexBuffer,"indexBuffer"),f(e.GLVertexBuffer,"indexNumItems"),f(e.GLVertexBuffer,"indexData"),f(e.GLVertexBuffer,"numItems"),f(e.GLVertexBuffer,"geometries"),f(e.GLVertexBuffer,"start"),f(e.GLVertexBuffer,"count"),f(e.BufferGeometryDS,"glFormatTypeIndex"),f(e.BufferGeometryDS,"use32bitIndexBuffer"),f(e.BufferGeometryDS,"itemSize"),f(e.BufferGeometryDS,"numItems"),e}),define("DS/Visualization/Measurable",["UWA/Class","DS/Visualization/ThreeJS_R57"],function(e,t){"use strict";var i=[0,8,8,2,2],r=new Uint8Array(4),n=new DataView(r.buffer,0,4),a=new Uint8Array(8),s=new DataView(a.buffer,0,8),o=e.extend({init:function(e){this.sgNode=e,this.size=-1;var t,i=e.getDecoration();if(i){if(i instanceof Array)this.string=i,this.size=this.string[0];else if(e&&(t=e.getGroup())&&t.geometry)if(t.geometry.decorations&&t.geometry.decorations.length){var r=t.geometry.decorations,n=i-1;this.size=r[n]+1,this.string=new Array(this.size);for(var a=0;a<this.size;a++)this.string[a]=r[n++]}else this.string=[]}else this.string=[];this.type=null,this.version=0,this.conversion=!0},getType:function(){return 0==this.size?this.type=o.TYPEUNKNOWN:this.size>0?this.readHeader():this.type=null,this.type},readHeader:function(){var e=0;if(this.size>=i[3]){if(0==this.string[1]){if(this.size>=i[1]){var t=this.readInt(1,2);return this.version=t[0],void(this.type=t[1])}}else this.string[1]=="2".charCodeAt(0)?this.version=2:this.string[1]=="3".charCodeAt(0)?this.version=3:this.string[1]=="4".charCodeAt(0)?this.version=4:this.string[1]=="5".charCodeAt(0)&&(this.version=5),e=this.string[2];switch(e){case 49:this.type=o.TYPEUNKNOWN;break;case 50:this.type=o.TYPEPLANE;break;case 51:this.type=o.TYPECYLINDER;break;case 52:this.type=o.TYPECONE;break;case 53:this.type=o.TYPESPHERE;break;case 54:this.type=o.TYPELINE;break;case 55:this.type=o.TYPECIRCLE;break;case 56:this.type=o.TYPETORUS}}},getPlane:function(){return this.type==o.TYPEPLANE?this.readPlane():null},getCone:function(){return this.type==o.TYPECONE?this.readCone():null},getSphere:function(){return this.type==o.TYPESPHERE?this.readSphere():null},getCircle:function(){return this.type==o.TYPECIRCLE?this.readCircle():null},getCylinder:function(){return this.type==o.TYPECYLINDER?this.readCylinder():null},getLine:function(){return this.type==o.TYPELINE?this.readLine():null},getTorus:function(){return this.type==o.TYPETORUS?this.readTorus():null},readTorus:function(){var e=[0,0,0],t=[0,0,1],r=0,n=0,a=[];if(3==this.version){var s=(a=this.readFloat(i[this.version]+1,8))[0],o=a[1],l=a[2],c=a[3],h=a[4],u=a[5],d=a[6],p=1-c*c-h*h,f=p>=0?Math.sqrt(p):0;u<0&&(f=-f,u=-u),e=[s,o,l],t=[c,h,f],r=d,n=u}else 1==this.version||2==this.version||4==this.version?(e=[(a=this.readDouble(i[this.version]+1,8))[0],a[1],a[2]],t=[a[3],a[4],a[5]],r=a[7],n=a[6]):this.version;return{center:e,axis:t,maxRadius:n,minRadius:r}},readCone:function(){var e=[0,0,0],t=[0,0,1],r=0,n=[];if(3==this.version){var a=(n=this.readFloat(i[this.version]+1,7))[0],s=n[1],o=n[2],l=n[3],c=n[4],h=n[5],u=1-l*l-c*c,d=u>=0?Math.sqrt(u):0;h<0&&(d=-d,h=-h);e=[a,s,o],t=[l,c,d],r=h}else 1==this.version||2==this.version||4==this.version?(e=[(n=this.readDouble(i[this.version]+1,7))[0],n[1],n[2]],t=[n[3],n[4],n[5]],r=n[6]):this.version;return{center:e,axis:t,semiAngle:r}},readCircle:function(){var e=[0,0,0],r=[0,0,1],n=0,a=[];if(3==this.version){e=[(a=this.readFloat(i[this.version]+1,7))[0],a[1],a[2]],n=a[3];var s=this.sgNode.getStart(),o=this.sgNode.getGroup().geometry,l=o.vertexIndexArray[s],c=[o.vertexPositionArray[3*l],o.vertexPositionArray[3*l+1],o.vertexPositionArray[3*l+2]],h=(l=o.vertexIndexArray[s+1],[o.vertexPositionArray[3*l],o.vertexPositionArray[3*l+1],o.vertexPositionArray[3*l+2]]),u=new t.Vector3(c[0],c[1],c[2]),d=new t.Vector3(h[0],h[1],h[2]),p=new t.Vector3(e[0],e[1],e[2]);d.sub(u),p.sub(u),d.cross(p),d.normalize(),r=[d.x,d.y,d.z]}else 1==this.version||2==this.version||4==this.version?(e=[(a=this.readDouble(i[this.version]+1,7))[0],a[1],a[2]],r=[a[3],a[4],a[5]],n=a[6]):this.version;return{center:e,axis:r,radius:n}},readCylinder:function(){var e=[0,0,0],t=[0,0,1],r=0,n=[];if(3==this.version){var a=(n=this.readFloat(i[this.version]+1,7))[0],s=n[1],o=n[2],l=n[3],c=n[4];r=n[5];var h=1-l*l-c*c,u=h>=0?Math.sqrt(h):0;r<0&&(u=-u,r=-r),e=[a,s,o],t=[l,c,u]}else 1==this.version||2==this.version||4==this.version?(e=[(n=this.readDouble(i[this.version]+1,7))[0],n[1],n[2]],t=[n[3],n[4],n[5]],r=n[6]):this.version;return{center:e,axis:t,radius:r}},readSphere:function(){var e=[0,0,0],t=0,r=[];if(3==this.version){var n=(r=this.readFloat(i[this.version]+1,4))[0],a=r[1],s=r[2];t=r[3],e=[n,a,s]}else 1==this.version||2==this.version||4==this.version?(e=[(r=this.readDouble(i[this.version]+1,4))[0],r[1],r[2]],t=r[3]):this.version;return{center:e,radius:t}},readLine:function(){var e=[0,0,0],t=[1,0,0],r=[];if(3==this.version||5==this.version){var n=this.sgNode.getStart(),a=this.sgNode.getGroup().geometry,s=a.vertexIndexArray[n];e=[a.vertexPositionArray[3*s],a.vertexPositionArray[3*s+1],a.vertexPositionArray[3*s+2]];s=a.vertexIndexArray[n+1];t=[a.vertexPositionArray[3*s],a.vertexPositionArray[3*s+1],a.vertexPositionArray[3*s+2]]}else 1!=this.version&&2!=this.version&&4!=this.version||(e=[(r=this.readDouble(i[this.version]+1,6))[0],r[1],r[2]],t=[r[3],r[4],r[5]]);return{startPosition:e,endPosition:t}},readPlane:function(){var e=[0,0,0],t=[1,0,0],r=[];if(3==this.version||5==this.version){var n=this.sgNode.getStart(),a=this.sgNode.getGroup().geometry,s=a.vertexIndexArray[n];e=[a.vertexPositionArray[3*s],a.vertexPositionArray[3*s+1],a.vertexPositionArray[3*s+2]],t=[a.vertexNormalArray[3*s],a.vertexNormalArray[3*s+1],a.vertexNormalArray[3*s+2]]}else 1!=this.version&&2!=this.version&&4!=this.version||(e=[(r=this.readDouble(i[this.version]+1,6))[0],r[1],r[2]],t=[r[3],r[4],r[5]]);return{normal:t,position:e}},readFloat:function(e,t){for(var i=new Array(t),a=0;a<t;a++)r[3]=this.string[e+4*a],r[2]=this.string[e+4*a+1],r[1]=this.string[e+4*a+2],r[0]=this.string[e+4*a+3],i[a]=n.getFloat32(0,this.conversion);return i},readInt:function(e,t){for(var i=new Array(t),a=0;a<t;a++)r[3]=this.string[e+4*a],r[2]=this.string[e+4*a+1],r[1]=this.string[e+4*a+2],r[0]=this.string[e+4*a+3],i[a]=n.getUint32(0,this.conversion);return i},readDouble:function(e,t){for(var i=new Array(t),r=0;r<t;r++)a[7]=this.string[e+8*r],a[6]=this.string[e+8*r+1],a[5]=this.string[e+8*r+2],a[4]=this.string[e+8*r+3],a[3]=this.string[e+8*r+4],a[2]=this.string[e+8*r+5],a[1]=this.string[e+8*r+6],a[0]=this.string[e+8*r+7],i[r]=s.getFloat64(0,this.conversion);return i}});return o.TYPEUNKNOWN=1,o.TYPEPLANE=2,o.TYPECYLINDER=3,o.TYPECONE=4,o.TYPESPHERE=5,o.TYPELINE=7,o.TYPECIRCLE=8,o.TYPETORUS=9,UWA.namespace("THREEDS/Measurable",o)}),define("Visualization/Measurable",["DS/Visualization/Measurable","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Measurable"),e}),define("DS/Intersection/RayFrustumUtils",["DS/Visualization/ThreeJS_R57","DS/Intersection/IntersectionUtils","DS/Mesh/Mesh"],function(e,t,i){"use strict";var r=new e.Vector3,n=new e.Vector3,a=new e.Vector3,s=new e.Vector3,o=new e.Vector3,l=new e.Vector3;return{intersectBufferGeom3DInsideFrustumMesh:function(e,n,a,o){var l=!1,c=n._getMMMatrix(),h=[],u=n.getFilterGeomType(),d=null,p=0;n.geometry.length>=0?(d=n.geometry[0],p=n.geometry.length):2===n.geometry._type&&(d=n.geometry,p=1);for(var f=new i.SGPrimitiveHelper,m=0;m<p;m++){for(var g=d.drawingGroups,v=d.vertexIndexArray,S=g.length,_=0;_<S;_++){var y=g[_];if(!t.filterDrawingGroup(y,u,a)){var x=null;if(n.layer&&(x=n.layer.getIntervals(d,y)),x||!t.checkGAS(y.gas))for(var M=y.getPrimitivesCount(),P=0;P<M;P++){f.set(y,P);var C=f.getCount(),b=f.getStart();if(!t.checkFrustumToPrimitiveBoundingSphere(f,C,e,c)&&!t.checkWLayers(x,b,y.gas,o))for(var D=b+C,w=b;w<D;w++)if(l=!0,d.getVertexPosition(v[w],r),s.copy(r),s.applyMatrix4(c),!e.containsPoint(s))return null}}}d=n.geometry[m+1]}return l?(h.push({object:n}),h):null},intersectBufferGeomZone3D:function(c,h,u,d,p,f,m){var g,v=[],S=u._getMMMatrix();u.matrixRotationWorld.extractRotation(S);var _,y=u.getFilterGeomType(),x=null,M=0;if(u.geometry.length>=0?(x=u.geometry[0],M=u.geometry.length):2===u.geometry._type&&(x=u.geometry,M=1),M&&(x.noMeshInRAM||!x.vertexIndexArray))return v;d||(_=!p);for(var P=new i.SGPrimitiveHelper,C=new e.Sphere,b=0;b<M;b++){for(var D=x.drawingGroups,w=x.vertexIndexArray,E=D.length,T=0;T<E;T++){var A=D[T];if((4==A.glType||5==A.glType)&&!t.filterDrawingGroup(A,y,f)){var I=null;if(u.layer&&(I=u.layer.getIntervals(x,A)),I||!t.checkGAS(A.gas)){for(var R=A.getPrimitivesCount(),L=0;L<R;L++){d&&!p&&(_=!0),P.set(A,L);var O=P.getCount(),N=P.getStart();if(!t.checkFrustumToPrimitiveBoundingSphere(P,O,h,S)&&!t.checkWLayers(I,N,A.gas,m)){for(var F=N+O,V=N;V<F;V++){if(x.getVertexPosition(w[V],r),x.getVertexPosition(w[V+1],n),x.getVertexPosition(w[V+2],a),s.copy(r),o.copy(n),l.copy(a),s.applyMatrix4(S),o.applyMatrix4(S),l.applyMatrix4(S),p){if(C.setFromCenterAndPoints(new e.Vector3((s.x+o.x+l.x)/3,(s.y+o.y+l.y)/3,(s.z+o.z+l.z)/3),[s,o,l]),h.intersectsSphere(C)&&h.intersectsTriangle([s,o,l])){d?(g={primitive:P.clone(),geometry:x,object:u},v.push(g)):_=!0;break}}else if(!(h.containsPoint(s)&&h.containsPoint(o)&&h.containsPoint(l))){_=!1;break}4==A.glType&&(V+=2)}if(d&&!p&&_)g={primitive:P.clone(),geometry:x,object:u},v.push(g);else if(!d&&p&&v.length)break}}if(!d&&(p&&_||!p&&!_))break}}}if(!d&&(p&&_||!p&&!_))break;x=u.geometry[b+1]}return!d&&_&&v.push({object:u}),v},intersectBufferGeomEdge3D:function(a,l,c,h,u,d){var p,f,m=[],g=l.getFilterGeomType(),v=l._getMMMatrix(),S=null,_=0;if(l.geometry.length>=0?(S=l.geometry[0],_=l.geometry.length):2===l.geometry._type&&(S=l.geometry,_=1),_&&(S.noMeshInRAM||!S.vertexIndexArray))return m;c||(f=!h);for(var y=new i.SGPrimitiveHelper,x=new e.Sphere,M=0;M<_;M++){for(var P=S.drawingGroups,C=S.vertexIndexArray,b=P.length,D=0;D<b;D++){var w=P[D];if(1===w.glType&&!t.filterDrawingGroup(w,g,u)){var E=null;if(l.layer&&(E=l.layer.getIntervals(S,w)),E||!t.checkGAS(w.gas)){for(var T=w.getPrimitivesCount(),A=0;A<T;A++){c&&(f=!0),y.set(w,A);var I=y.getCount(),R=y.getStart();if(!t.checkFrustumToPrimitiveBoundingSphere(y,I,a,v)&&!t.checkWLayers(E,R,w.gas,d)){for(var L=R+I,O=R;O<L;O+=2)if(S.getVertexPosition(C[O],r),S.getVertexPosition(C[O+1],n),s.copy(r),o.copy(n),s.applyMatrix4(v),o.applyMatrix4(v),h){if(x.setFromCenterAndPoints(new e.Vector3((s.x+o.x)/2,(s.y+o.y)/2,(s.z+o.z)/2),[s,o]),a.intersectsSphere(x)&&a.intersectsLine([s,o])){c?(p={primitive:y.clone(),geometry:S,object:l},m.push(p)):f=!0;break}}else if(!a.containsPoint(s)||!a.containsPoint(o)){f=!1;break}if(c&&!h&&f)p={primitive:y.clone(),geometry:S,object:l},m.push(p);else if(!c&&h&&m.length)break}}if(!c&&(h&&f||!h&&!f))break}}}if(!c&&(h&&f||!h&&!f))break;S=l.geometry[M+1]}return!c&&f&&m.push({object:l}),m},intersectBufferGeomPoint3D:function(e,n,a,o){var l,c=[],h=n.getFilterGeomType(),u=n._getMMMatrix(),d=null,p=0;if(n.geometry.length>=0?(d=n.geometry[0],p=n.geometry.length):2===n.geometry._type&&(d=n.geometry,p=1),p&&(d.noMeshInRAM||!d.vertexIndexArray))return c;for(var f=new i.SGPrimitiveHelper,m=0;m<p;m++){for(var g=d.drawingGroups,v=d.vertexIndexArray,S=g.length,_=0;_<S;_++){var y=g[_];if(0===y.glType&&!t.filterDrawingGroup(y,h,a)){var x=null;if(n.layer&&(x=n.layer.getIntervals(d,y)),x||!t.checkGAS(y.gas))for(var M=y.getPrimitivesCount(),P=0;P<M;P++){f.set(y,P);var C=f.getCount(),b=f.getStart();if(!t.checkFrustumToPrimitiveBoundingSphere(f,C,e,u)&&!t.checkWLayers(x,b,y.gas,o))for(var D=b+C,w=b;w<D;w++)d.getVertexPosition(v[w],r),s.copy(r),s.applyMatrix4(u),0===e.computeOutcode(s)&&(l={primitive:f.clone(),geometry:d,object:n},c.push(l))}}}d=n.geometry[m+1]}return c}}}),define("DS/Intersection/RayCastUtils",["DS/Visualization/ThreeJS_R57","DS/Intersection/IntersectionUtils","DS/Mesh/Mesh"],function(e,t,i){"use strict";var r=new e.Vector3,n=new e.Vector3,a=new e.Vector3,s=new e.Vector3,o=new e.Vector3,l=new e.Vector3,c=new e.Vector3,h=new e.Vector3,u=new e.Vector3,d=new e.Vector3,p=new e.Vector3,f=new e.Vector3,m=new e.Vector3,g=new e.Vector3,v=new e.Vector3,S=new e.Vector3;return{_castRayIntoBufferGeom:function(c,h,S){var _,y=[],x=c._getMMMatrix(),M=(new e.Matrix4).getInverse(x),P=M.getMaxScaleOnAxis();c.matrixRotationWorld.extractRotation(x);var C=(new e.Ray).copy(this).applyMatrix4(M),b=S*P,D=S<1/0,w=null,E=0;if(c.geometry.length>=0?(w=c.geometry[0],E=c.geometry.length):2===c.geometry._type&&(w=c.geometry,E=1),w&&!w.vertexIndexArray)return _={distance:0,primitive:!0,object:c,point:null,normal:null},y.push(_),y;var T=new i.SGPrimitiveHelper,A=this;C.direction.normalize();var I=function(e,i,S){var M,P,E;f.copy(C.origin);var I=e.vertexUvArray?e.vertexUvArray:null;m.copy(C.direction),null===i?(M=S,P=S+1,E=S+2):(M=i[S],P=i[S+1],E=i[S+2]),e.getVertexPosition(M,r),e.getVertexPosition(P,n),e.getVertexPosition(E,a),g.subVectors(n,r),u.copy(g);var R=g.dot(g);if(g.subVectors(r,a),d.copy(g),R=Math.max(R,g.dot(g)),g.subVectors(r,C.origin),g.cross(C.direction),g.dot(g)>R)return!0;p.crossVectors(d,u).normalize(),g.subVectors(r,f);var L=m.dot(p),O=p.dot(g)/L;if(O>=0){if(D&&O>b)return!0;if(v.addVectors(f,m.multiplyScalar(O)),g.subVectors(r,v),g.dot(g)>R)return!0;if(t.pointInFace3(v,r,n,a)){if(h)return _={object:c,geometry:w},y.push(_),!1;var N=null;e.getVertexNormal(M,s),e.getVertexNormal(P,o),e.getVertexNormal(E,l);var F=v.barycentricCoordinates(r,n,a);s.multiplyScalar(F.alpha),o.multiplyScalar(F.beta),l.multiplyScalar(F.gamma),p.addVectors(s,o),p.add(l),p.multiplyScalar(F.normalisationFactor),p.normalize();var V=v.clone().applyMatrix4(x);I&&(e.getUV(M,r),e.getUV(P,n),e.getUV(E,a),N=t.computeUVCoords(r,n,a)),_={distance:A.origin.distanceTo(V),point:V,normal:p.clone().applyMatrix4(c.matrixRotationWorld),tangent:null,uv:N,primitive:T.clone(),geometry:e,object:c},y.push(_)}}return!0};if(c.kdTree){c.kdTree.intersect(C,function(e){f.copy(C.origin),m.copy(C.direction),T.set(e.dg,e.primitive);var t=T.getGroup();if(4==t.glType||5==t.glType){var i=t.geometry,r=i.vertexIndexArray,n=e.offset;if(-1!==n)I(i,t.nonIndexed?null:r,n);else for(var a=T.getStart(),s=a+T.getCount(),o=a;o<s&&I(i,t.nonIndexed?null:r,o);4===t.glType?o+=3:o++);}},null,D?b:null);return y}for(var R=0;R<E;R++){for(var L=w.drawingGroups,O=w.vertexIndexArray,N=L.length,F=0;F<N;F++){var V=L[F];if(4==V.glType||5==V.glType){var U=null;c.layer&&(U=c.layer.getIntervals(w,V));for(var B=V.getPrimitivesCount(),k=0;k<B;k++){T.set(V,k);var G=T.getCount(),z=T.getStart();if(!t.checkRayToPrimitiveBoundingSphere(T,G,C,D?b:0,0)&&!t.checkWLayersNoGAS(U,z))for(var H=z+G,W=z;W<H;4===V.glType?W+=3:W++)if(!I(w,V.nonIndexed?null:O,W))return y}}}w=c.geometry[R+1]}return y},_castRayIntoBufferGeomEdge:function(a,s,o,l){var u,d=[],p=a._getMMMatrix(),f=(new e.Matrix4).getInverse(p),m=f.getMaxScaleOnAxis();a.matrixRotationWorld.extractRotation(p);var v=(new e.Ray).copy(this).applyMatrix4(f),_=l*m,y=l<1/0;a.material&&a.material.lineWidth&&a.material.is2DLine&&(s+=.5*a.material.lineWidth);var x=null,M=0;if(a.geometry.length>=0?(x=a.geometry[0],M=a.geometry.length):2===a.geometry._type&&(x=a.geometry,M=1),x&&!x.vertexIndexArray)return u={distance:0,primitive:!0,object:a,point:null,normal:null},d.push(u),d;v.direction.normalize();for(var P=new i.SGPrimitiveHelper,C=this,b=function(t,i,f){null===i?(t.getVertexPosition(f,r),t.getVertexPosition(f+1,n)):(t.getVertexPosition(i[f],r),t.getVertexPosition(i[f+1],n)),g.subVectors(n,r);var m=g.dot(g);if(m+=2*Math.sqrt(m)*s+s*s,g.subVectors(r,v.origin),g.cross(v.direction),g.dot(g)>m)return!0;if(c.copy(r),h.copy(n),c.applyMatrix4(p),h.applyMatrix4(p),y){S.subVectors(c,C.origin);var _=S.dot(C.direction);if(S.subVectors(h,C.origin),(_=Math.min(_,S.dot(C.direction)))>l)return!0}var x=new e.Vector3;if(C.distanceSqToSegment(c,h,null,x)<s*s){if(o)return u={object:a,geometry:t},d.push(u),!1;var M=C.origin.distanceTo(x);u={distance:Math.max(0,.99*M),point:x.clone(),normal:null,tangent:(new e.Vector3).subVectors(x,c).normalize(),primitive:P.clone(),geometry:t,object:a},d.push(u)}return!0},D=0;D<M;D++){for(var w=x.drawingGroups,E=x.vertexIndexArray,T=w.length,A=0;A<T;A++){var I=w[A];if(1==I.glType){var R=null;a.layer&&(R=a.layer.getIntervals(x,I));for(var L=I.getPrimitivesCount(),O=0;O<L;O++){P.set(I,O);var N=P.getCount(),F=P.getStart();if(!t.checkRayToPrimitiveBoundingSphere(P,N,v,y?_:0,s)&&!t.checkWLayersNoGAS(R,F))for(var V=F+N,U=F;U<V;U+=2)if(!b(x,I.nonIndexed?null:E,U))return d}}}x=a.geometry[D+1]}return d},_castRayIntoBufferGeomPoint:function(n,a,s,o){var l,h=[],u=n._getMMMatrix(),d=(new e.Matrix4).getInverse(u),p=d.getMaxScaleOnAxis();n.matrixRotationWorld.extractRotation(u);var f=(new e.Ray).copy(this).applyMatrix4(d),m=o*p,g=o<1/0,v=null,S=0;if(n.geometry.length>=0?(v=n.geometry[0],S=n.geometry.length):2===n.geometry._type&&(v=n.geometry,S=1),v&&!v.vertexIndexArray)return l={distance:0,primitive:!0,object:n,point:null,normal:null},h.push(l),h;f.direction.normalize();for(var _=new i.SGPrimitiveHelper,y=this,x=function(e,t,i){if(null===t?e.getVertexPosition(i,r):e.getVertexPosition(t[i],r),c.copy(r),c.applyMatrix4(u),y.distanceToPoint(c)<a){if(s)return l={object:n,geometry:e},h.push(l),!1;var d=y.origin.distanceTo(c);if(g&&d>o)return!0;l={distance:Math.max(0,.98*d),point:c.clone(),normal:null,primitive:_.clone(),geometry:e,object:n},h.push(l)}return!0},M=0;M<S;M++){for(var P=v.drawingGroups,C=v.vertexIndexArray,b=P.length,D=0;D<b;D++){var w=P[D];if(0===w.glType){var E=null;n.layer&&(E=n.layer.getIntervals(v,w));for(var T=w.getPrimitivesCount(),A=0;A<T;A++){_.set(w,A);var I=_.getCount(),R=_.getStart();if(!t.checkRayToPrimitiveBoundingSphere(_,I,f,g?m:0,a)&&!t.checkWLayersNoGAS(E,R))for(var L=R+I,O=R;O<L;O++)if(!x(v,w.nonIndexed?null:C,O))return h}}}v=n.geometry[M+1]}return h}}}),define("DS/ViewPanel/ViewPanelController",["DS/VisuTools/SettingManager","DS/Visualization/ThreeJS_R57","DS/QualityManager/QMController"],function(e,t,i){"use strict";var r={materialMode:!1,visuShadingFaceMode:"Shaded",visuShadingEdgeMode:"WithEdges",visuShadingMode:"ShadingEdges",visuEnv:"Basic",visuAppearanceMode:"BASIC",axisState:!1,linesState:!0,planesState:!1,pointsState:!1,verticesState:!0,visuOutlineMode:!1,projectionMode:0};return class{constructor(t,n){t._useQM&&!window.__karma__&&(r.visuEnv="WhiteExperience",i.computeDefaultPreset(),i.unknownOrVeryLowGPU||(r.visuAppearanceMode="GASLOOK")),(n=n||{}).defaultSettings=n.defaultSettings||{},n.uiConfig=n.uiConfig||{},this.defaultSettings={},Object.assign(this.defaultSettings,r),Object.assign(this.defaultSettings,n.defaultSettings),this._settingsManagerParams={useLocalStorage:void 0!==n.useLocalStorage&&n.useLocalStorage,useWidget:void 0===n.useWidget||n.useWidget,name:"VisuViewSettings",viewer:t,importFromOldLocalStorage:void 0!==n.importFromOldLocalStorage&&n.importFromOldLocalStorage};var a=n.uiConfig;this._viewModePanelUIParams={useShadingIllustration:void 0!==a.useShadingIllustration&&a.useShadingIllustration,useOutline:void 0===a.useOutline||a.useOutline},this._viewModePanelUIParams.useOutline=this._viewModePanelUIParams.useOutline&&!this._viewModePanelUIParams.useShadingIllustration,this._keyWriter=e.Write(this._settingsManagerParams),this._eventListeners=[]}init(){var t=this._settingsManagerParams.viewer,i=this._keyWriter,r={},n=this.defaultSettings;if(Object.assign(r,n),Object.assign(r,e.Struct(this._settingsManagerParams)),this._settingsManagerParams.importFromOldLocalStorage&&e.isEmptySettings(this._settingsManagerParams)){var a=localStorage.getItem("visuEnv");a&&a.includes("OCA")&&(a=a.replace("OCA",""),r.visuEnv=a);var s=localStorage.getItem("projectionMode");s&&(r.projectionMode=parseInt(s,10));var o=localStorage.getItem("visuShadingMode");o&&(r.visuShadingMode=o);var l=localStorage.getItem("axisState");l&&(r.axisState="true"===l,r.planesState=r.axisState);var c=localStorage.getItem("linesState");c&&(r.linesState="true"===c,r.verticesState=r.linesState);var h=localStorage.getItem("pointsState");h&&(r.pointsState="true"===h)}var u,d=this._eventListeners,p=this;u=t.onPreRender(function(){t.unsubscribe(u),d.push(t.onMaterialModeChange(function(){i.materialMode=t.getMaterialMode()!==!!n.materialMode?t.getMaterialMode():void 0})),d.push(t.onVisuShadingFaceModeChange(function(){i.visuShadingFaceMode=t.getVisuShadingFaceMode()!==n.visuShadingFaceMode?t.getVisuShadingFaceMode():void 0})),d.push(t.onVisuShadingEdgeModeChange(function(){i.visuShadingEdgeMode=t.getVisuShadingEdgeMode()!==n.visuShadingEdgeMode?t.getVisuShadingEdgeMode():void 0})),d.push(t.onVisuShadingModeChange(function(){i.visuShadingMode=t.getVisuShadingMode()!==n.visuShadingMode?t.getVisuShadingMode():void 0})),d.push(t.onVisuEnvChange(function(){var e=t.getVisuEnv();e.includes("OCA")&&(e=e.replace("OCA",""),i.visuEnv=e!==n.visuEnv?e:void 0)})),d.push(t.onVisuAppearanceModeChange(function(){i.visuAppearanceMode=t.getVisuAppearanceMode()!==n.visuAppearanceMode?t.getVisuAppearanceMode():void 0})),d.push(t.onAxisFilterChange(function(){i.axisState=t.getAxisFilter()!==!!n.axisState?t.getAxisFilter():void 0})),d.push(t.onPlanesFilterChange(function(){i.planesState=t.getPlanesFilter()!==!!n.planesState?t.getPlanesFilter():void 0})),d.push(t.onLinesFilterChange(function(){t.currentViewpoint._2DMode||(i.linesState=t.getLinesFilter()!==!!n.linesState?t.getLinesFilter():void 0)})),d.push(t.onVerticesFilterChange(function(){t.currentViewpoint._2DMode||(i.verticesState=t.getVerticesFilter()!==!!n.verticesState?t.getVerticesFilter():void 0)})),d.push(t.onPointsFilterChange(function(){t.currentViewpoint._2DMode||(i.pointsState=t.getPointsFilter()!==!!n.pointsState?t.getPointsFilter():void 0)})),d.push(t._onVisuOutlineModeChange(function(){i.visuOutlineMode=t._getVisuOutlineMode()!==!!n.visuOutlineMode?t._getVisuOutlineMode():void 0})),d.push(t.onProjectionTypeChange(function(){t.currentViewpoint._2DMode||(i.projectionMode=t.currentViewpoint.getProjectionType()!==n.projectionMode?t.currentViewpoint.getProjectionType():void 0)})),p._apply(r)})}_apply(e){var i=this.defaultSettings,n=this._viewModePanelUIParams,a=this._settingsManagerParams.viewer;if(n.useShadingIllustration?e.visuOutlineMode=!1:("Illustration"===e.visuShadingFaceMode&&(e.visuShadingFaceMode="Illustration"===i.visuShadingFaceMode?r.visuShadingFaceMode:i.visuShadingFaceMode),"ShadingIllustration"===e.visuShadingMode&&(e.visuShadingMode="ShadingIllustration"===i.visuShadingMode?r.visuShadingMode:i.visuShadingMode)),void 0!==e.materialMode&&a.setMaterialMode(e.materialMode),void 0!==e.visuShadingFaceMode&&a.setVisuShadingFaceMode(e.visuShadingFaceMode),void 0!==e.visuShadingEdgeMode&&a.setVisuShadingEdgeMode(e.visuShadingEdgeMode),void 0!==e.visuShadingMode&&a.setVisuShadingMode(e.visuShadingMode),void 0!==e.visuEnv){var s=e.visuEnv;s.includes("OCA")&&(s=s.replace("OCA",""));var o=a.getVisuEnv();o.includes("OCA")&&(o=o.replace("OCA","")),o!==s&&a.setVisuEnvOCA(s)}void 0!==e.visuAppearanceMode&&a.setVisuAppearanceMode(t.DefaultAppearanceMode[e.visuAppearanceMode]),void 0!==e.pointsState&&a.setPointsFilter(e.pointsState),void 0!==e.axisState&&a.setAxisOnlyFilter(e.axisState),void 0!==e.planesState&&a.setPlanesFilter(e.planesState),void 0!==e.linesState&&a.setLinesFilter(e.linesState),void 0!==e.verticesState&&a.setVerticesFilter(e.verticesState),void 0!==e.visuOutlineMode&&a._setVisuOutlineMode(e.visuOutlineMode),void 0!==e.projectionMode&&a.currentViewpoint.setProjectionType(e.projectionMode)}apply(e){var t=this._settingsManagerParams.viewer,i={};Object.assign(i,e||{});var r,n=this;r=t.onPreRender(function(){t.unsubscribe(r),n._apply(i)}),t.render()}dumpSettings(){var e=this._settingsManagerParams.viewer;return{materialMode:e.getMaterialMode(),visuShadingFaceMode:e.getVisuShadingFaceMode(),visuShadingEdgeMode:e.getVisuShadingEdgeMode(),visuShadingMode:e.getVisuShadingMode(),visuEnv:e.getVisuEnv(),visuAppearanceMode:e.getVisuAppearanceMode(),pointsState:e.getPointsFilter(),axisState:e.getAxisFilter(),planesState:e.getPlanesFilter(),linesState:e.getLinesFilter(),verticesState:e.getVerticesFilter(),visuOutlineMode:e._getVisuOutlineMode(),projectionMode:e.currentViewpoint.getProjectionType()}}_updateViewPanelUIConfiguration(e){void 0!==e.useShadingIllustration&&(this._viewModePanelUIParams.useShadingIllustration=e.useShadingIllustration),void 0!==e.useOutline&&(this._viewModePanelUIParams.useOutline=e.useOutline),this._viewModePanelUIParams.useOutline=this._viewModePanelUIParams.useOutline&&!this._viewModePanelUIParams.useShadingIllustration;var t=this._settingsManagerParams.viewer;this._viewModePanelUIParams.useOutline||t._setVisuOutlineMode(!1);var i=this.defaultSettings;this._viewModePanelUIParams.useShadingIllustration||"ShadingIllustration"!==t.getVisuShadingMode()||("ShadingIllustration"===i.visuShadingMode?t.setVisuShadingMode(r.visuShadingMode):(t.setMaterialMode(i.materialMode),t.setVisuShadingFaceMode("Illustration"===i.visuShadingFaceMode?r.visuShadingFaceMode:i.visuShadingFaceMode),t.setVisuShadingEdgeMode(i.visuShadingEdgeMode),t.setVisuShadingMode(i.visuShadingMode)))}restore(){var t={},i=this.defaultSettings;Object.assign(t,i),Object.assign(t,e.Struct(this._settingsManagerParams)),this.apply(t)}dispose(){for(var e=0;e<this._eventListeners.length;e++)this._settingsManagerParams.viewer.unsubscribe(this._eventListeners[e]);this._eventListeners=[]}}}),(toto=function(){})(),define("DS/Intersection/RayIntersectionUtils",["DS/Visualization/ThreeJS_R57","DS/Intersection/IntersectionUtils","DS/Mesh/Mesh"],function(e,t,i){"use strict";var r=new e.Vector3,n=new e.Vector3,a=new e.Vector3,s=new e.Vector3,o=new e.Vector3,l=new e.Vector3,c=new e.Vector3,h=new e.Vector3,u=new e.Vector3,d=new e.Vector3,p=new e.Vector3,f=new e.Vector3,m=new e.Vector3,g=new e.Vector3,v=new e.Vector3,S=new e.Vector3,_=new e.Vector3,y=new e.Vector3,x=new e.Vector3,M=new e.Vector3;return{intersectBufferGeomOptim:function(c,h,u,d,p,f){var v,P=[],C=u._getMMMatrix(),b=(new e.Matrix4).getInverse(C);u.matrixRotationWorld.extractRotation(C);var D=(new e.Ray).copy(this).applyMatrix4(b),w=u.getFilterGeomType(),E=null,T=0;if(u.geometry.length>=0?(E=u.geometry[0],T=u.geometry.length):2===u.geometry._type&&(E=u.geometry,T=1),E&&!E.vertexIndexArray&&!d)return v={distance:0,primitive:!0,object:u,point:null,normal:null},P.push(v),P;var A=new i.SGPrimitiveHelper,I=this.origin,R=new Map,L=function(e,i,c){var h,d,p;_.copy(D.origin),y.copy(D.direction);var f=e.vertexUvArray?e.vertexUvArray:null;null===i?(h=c,d=c+1,p=c+2):(h=i[c],d=i[c+1],p=i[c+2]),e.getVertexPosition(h,r),e.getVertexPosition(d,n),e.getVertexPosition(p,a),x.subVectors(n,r),m.copy(x);var b=x.dot(x);if(x.subVectors(r,a),g.copy(x),b=Math.max(b,x.dot(x)),x.subVectors(r,D.origin),x.cross(D.direction),x.dot(x)>b)return!0;S.crossVectors(g,m).normalize(),x.subVectors(r,_);var w=y.dot(S),E=S.dot(x)/w;if(E>=0){if(M.addVectors(_,y.multiplyScalar(E)),x.subVectors(r,M),x.dot(x)>b)return!0;if(t.pointInFace3(M,r,n,a)){var T=null;e.getVertexNormal(h,s),e.getVertexNormal(d,o),e.getVertexNormal(p,l);var R=M.barycentricCoordinates(r,n,a);s.multiplyScalar(R.alpha),o.multiplyScalar(R.beta),l.multiplyScalar(R.gamma),S.addVectors(s,o),S.add(l),S.multiplyScalar(R.normalisationFactor),S.normalize();var L=M.clone().applyMatrix4(C);f&&(e.getUV(h,r),e.getUV(d,n),e.getUV(p,a),T=t.computeUVCoords(r,n,a)),v={distance:I.distanceTo(L),point:L,normal:S.clone().applyMatrix4(u.matrixRotationWorld),tangent:null,uv:T,primitive:A.clone(),geometry:e,object:u},P.push(v)}}return!0};if(u.kdTree)u.kdTree.intersect(D,function(e,i,r){A.set(e.dg,e.primitive);var n=A.getGroup();if((4==n.glType||5==n.glType)&&!t.filterDrawingGroup(n,w,p)){var a=n.geometry,s=a.vertexIndexArray,o=e.offset;if(d)R.has(n)?R.get(n).push(e.primitive):R.set(n,[e.primitive]);else if(-1!==o)L(a,n.nonIndexed?null:s,o);else for(var l=A.getStart(),c=l+A.getCount(),h=l;h<c;4===n.glType?h+=3:h++)L(a,n.nonIndexed?null:s,h)}});else for(var O=0;O<T;O++){for(var N=E.drawingGroups,F=E.vertexIndexArray,V=N.length,U=0;U<V;U++){var B=N[U];if((4==B.glType||5==B.glType)&&!t.filterDrawingGroup(B,w,p)){var k=null;if(u.layer&&(k=u.layer.getIntervals(E,B)),k||!t.checkGAS(B.gas))for(var G=0;G<B.getPrimitivesCount();G++){A.set(B,G);var z=A.getCount(),H=A.getStart();if(!t.checkRayToPrimitiveBoundingSphere(A,D,0,0)&&!t.checkWLayers(k,H,B.gas,f))if(d)R.has(B)?R.get(B).push(G):R.set(B,[G]);else for(var W=H+z,j=H;j<W;4===B.glType?j+=3:j++)L(E,B.nonIndexed?null:F,j)}}}E=u.geometry[O+1]}return d&&R.forEach(function(e,t,i){e.sort(function(e,t){return e<=t}),P.push({object:u,dg:t,prims:e})}),P},intersectBufferGeomEdge:function(a,s,o,l,u,g,S,_){var y={norm:0,length:0},M=l.getWorldSizeFromPixelSize(1/u,s.worldCenter,l._viewpoint.viewer._getDivClientHeight());if(s.material&&s.material.lineWidth&&(s.material.lineWidth>1||s.material.is2DLine)){var P=s.material.lineWidth;s.material.is2DLine&&(P/=M),y.length=P<2*o?o+1:Math.ceil(P/2+2)}else y.length=o+1;y.norm=Math.sqrt(2)*y.length;var C,b=y.norm/M,D=[],w=s._getMMMatrix(),E=(new e.Matrix4).getInverse(w);s.matrixRotationWorld.extractRotation(w);var T=(new e.Ray).copy(this).applyMatrix4(E),A=s.getFilterGeomType(),I=null,R=0;if(s.geometry.length>=0?(I=s.geometry[0],R=s.geometry.length):2===s.geometry._type&&(I=s.geometry,R=1),I&&!I.vertexIndexArray&&!g)return C={distance:0,primitive:!0,object:s,point:null,normal:null},D.push(C),D;T.direction.normalize();for(var L=this,O=new Map,N=new i.SGPrimitiveHelper,F=function(i,o,u){null===o?(i.getVertexPosition(u,r),i.getVertexPosition(u+1,n)):(i.getVertexPosition(o[u],r),i.getVertexPosition(o[u+1],n)),x.subVectors(n,r);var g=x.dot(x);if(g+=2*Math.sqrt(g)*b+b*b,x.subVectors(r,T.origin),x.cross(T.direction),!(x.dot(x)>g)&&function(i,r,n,a,s,o){var l=s,u=.5*t._screenWidth,g=.5*t._screenHeight;f.copy(n),f.x=(f.x+1)*u,f.y=(f.y+1)*g,c.copy(i),h.copy(r),c.applyMatrix4(a),h.applyMatrix4(a),d.copy(c),p.copy(h),d.applyProjection(t._projScreenMatrix),p.applyProjection(t._projScreenMatrix);var S=d.z>1,_=p.z>1;if(S||_){var y=o._viewpoint._frustum,x=c.dot(y.planes[5].normal)+y.planes[5].constant<0,M=h.dot(y.planes[5].normal)+y.planes[5].constant<0;if(x&&M)return!1;if(x||M){var P=new e.Line3(c,h),C=y.planes[5].intersectLine(P);x?(d.copy(C),d.applyProjection(t._projScreenMatrix)):(p.copy(C),p.applyProjection(t._projScreenMatrix))}}d.x=(d.x+1)*u,d.y=(d.y+1)*g,p.x=(p.x+1)*u,p.y=(p.y+1)*g,m.subVectors(p,d),v.subVectors(f,d);var b=v.x*m.x+v.y*m.y;if(Math.abs(b)<1e-12)return!1;var D=m.x*m.x+m.y*m.y,w=Math.sqrt(D),E=l.length/w;if(b<-(E*=D)||b>D+E)return!1;var T=b/D,A=d.x+T*m.x,I=d.y+T*m.y,R=Math.sqrt((A-f.x)*(A-f.x)+(I-f.y)*(I-f.y));return!(R>l.norm||R<-l.norm)}(r,n,a,w,y,l)){var S=L.computeShortestPointToLine(c,h),_=L.origin.distanceTo(S);C={distance:Math.max(0,.99*_),point:S.clone(),normal:null,tangent:(new e.Vector3).subVectors(S,c).normalize(),primitive:N.clone(),geometry:i,object:s},D.push(C)}},V=0;V<R;V++){for(var U=I.drawingGroups,B=I.vertexIndexArray,k=U.length,G=0;G<k;G++){var z=U[G];if(1==z.glType&&!t.filterDrawingGroup(z,A,S)){var H=null;if(s.layer&&(H=s.layer.getIntervals(I,z)),H||!t.checkGAS(z.gas))for(var W=z.getPrimitivesCount(),j=0;j<W;j++){N.set(z,j);var X=N.getCount(),q=N.getStart();if(!t.checkRayToPrimitiveBoundingSphere(N,T,0,b)&&!t.checkWLayers(H,q,z.gas,_))if(g)O.has(z)?O.get(z).push(j):O.set(z,[j]);else for(var Z=q+X,Y=q;Y<Z;Y+=2)F(I,z.nonIndexed?null:B,Y)}}}I=s.geometry[V+1]}return g&&O.forEach(function(e,t,i){e.sort(function(e,t){return e<=t}),D.push({object:s,dg:t,prims:e})}),D},intersectBufferGeomPoint:function(n,a,s,o,l,p,f,g,v,S){var _,y,x=[],M=(l+1)*Math.sqrt(2),P=a._getMMMatrix(),C=(new e.Matrix4).multiplyMatrices(s.matrixWorldInverse,P),b=(new e.Matrix4).getInverse(P);a.matrixRotationWorld.extractRotation(P);var D=(new e.Ray).copy(this).applyMatrix4(b),w=1/s.getWorldSizeFromPixelSize(1,a.worldCenter,s._viewpoint.viewer._getDivClientHeight()),E=a.getFilterGeomType(),T=null,A=0,I=1/0,R=p,L=o;if(L||(R=!1),a.geometry.length>=0?(T=a.geometry[0],A=a.geometry.length):2===a.geometry._type&&(T=a.geometry,A=1),T&&!T.vertexIndexArray&&!g)return _={distance:0,primitive:!0,object:a,point:null,normal:null},x.push(_),x;D.direction.normalize();for(var O=new i.SGPrimitiveHelper,N=this,F=new Map,V=function(i,s,o){if(null===s?i.getVertexPosition(o,r):i.getVertexPosition(s[o],r),R){var l=function(t,i,n,a){var s=1/0;c.copy(r),h.copy(i),c.applyMatrix4(a);var o=new e.Matrix4;return o.getInverse(n),h.applyMatrix4(o),h.applyMatrix4(a),c.z>h.z-.01&&c.z<h.z+.01&&(m.subVectors(c,h),s=Math.sqrt(m.x*m.x+m.y*m.y)),s}(0,L,P,C);if(l<I){I=l;var p=N.origin.distanceTo(c);_={distance:Math.max(0,.98*p),point:c.clone(),normal:null,primitive:O.clone(),geometry:i,object:a}}}else if(function(e,i,r,n,a){var s=96,o=n/s;a&&(s*=a);var l=.5*t._screenWidth/s,h=.5*t._screenHeight/s;return u.copy(i),u.x*=l,u.y*=h,c.copy(e),c.applyMatrix4(r),d.copy(c),d.applyProjection(t._projScreenMatrix),d.x*=l,d.y*=h,m.subVectors(u,d),!(Math.sqrt(m.x*m.x+m.y*m.y)>o)}(r,n,P,y,f)){p=N.origin.distanceTo(c);_={distance:Math.max(0,.98*p),point:c.clone(),normal:null,primitive:O.clone(),geometry:i,object:a},x.push(_)}},U=0;U<A;U++){for(var B=T.drawingGroups,k=T.vertexIndexArray,G=B.length,z=0;z<G;z++){var H=B[z];if(0===H.glType&&!t.filterDrawingGroup(H,E,v)){var W;if(H.gas)H.gas.isGAS?W=H.gas.getPointSize():H.gas instanceof e.ParticleBasicMaterial&&H.gas.size&&(W=H.gas.size),y=W>2*l+1?W*Math.sqrt(2)/2:M;else y=M;var j=null;if(a.layer&&(j=a.layer.getIntervals(T,H)),j||!t.checkGAS(H.gas))for(var X=H.getPrimitivesCount(),q=0;q<X;q++){O.set(H,q);var Z=O.getCount(),Y=O.getStart();if(!t.checkRayToPrimitiveBoundingSphere(O,D,0,y*w)&&!t.checkWLayers(j,Y,H.gas,S))if(g)F.has(H)?F.get(H).push(q):F.set(H,[q]);else for(var K=Y+Z,J=Y;J<K;J++)V(T,H.nonIndexed?null:k,J)}}}T=a.geometry[U+1]}return R&&_&&x.push(_),g&&F.forEach(function(e,t,i){e.sort(function(e,t){return e<=t}),x.push({object:a,dg:t,prims:e})}),x}}}),define("DS/Intersection/Ray",["DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh","DS/Intersection/IntersectionUtils","DS/Intersection/RayFrustumUtils","DS/Intersection/RayIntersectionUtils","DS/Intersection/RayCastUtils"],function(e,t,i,r,n,a){"use strict";var s,o,l=new e.Vector3,c=new e.Vector3,h=new e.Vector3;function u(t,i,r){var n=t;if(i._occurrence&&(i._occurrence.renderMode&&(i._occurrence.renderMode.getMask?n=i._occurrence.renderMode.getMask():console.error("Error: expected RenderMode in OccurrenceNode.renderMode but got "+typeof i._occurrence.renderMode)),i._occurrence.pickingMode&&(r=i._occurrence.pickingMode)),r){var[a,s,o]=r._getPickingMasks(n);n=a|s|o}return n|e.RenderMode.defaultMask}function d(t,i,r){return!0===t?t=e.RenderMode.facesMask:!1===t&&(t=0),!0===i?i=e.RenderMode.linesMask:!1===i&&(i=0),!0===r?r=e.RenderMode.pointsMask:!1===r&&(r=0),t|i|r|e.RenderMode.defaultMask}var p,f,m,g=e.__visibleInCurrentSpace,v=function(t,i){this.origin=void 0!==t?t:new e.Vector3,this.direction=void 0!==i?i:new e.Vector3};return v.prototype={constructor:v,set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},_cleanIntersectionsList:function(e,t){if(t)for(var i=0;i<e.length;i++){var r=e[i];if(r.object){var n=r.object;if(void 0!==n.pickable&&!n.pickable){e[i]={};continue}}}},at:function(t,i){return(i||new e.Vector3).copy(this.direction).multiplyScalar(t).add(this.origin)},recast:function(){var t=new e.Vector3;return function(e){return this.origin.copy(this.at(e,t)),this}}(),closestPointToPoint:function(t,i){var r=i||new e.Vector3;r.subVectors(t,this.origin);var n=r.dot(this.direction);return r.copy(this.direction).multiplyScalar(n).add(this.origin)},distanceToPoint:function(){var t=new e.Vector3;return function(e){var i=t.subVectors(e,this.origin).dot(this.direction);return t.copy(this.direction).multiplyScalar(i).add(this.origin),t.distanceTo(e)}}(),distanceSqToSegment:(p=new e.Vector3,f=new e.Vector3,m=new e.Vector3,function(e,t,i,r){p.copy(e).add(t).multiplyScalar(.5),f.copy(t).sub(e).normalize(),m.copy(this.origin).sub(p);var n,a,s,o,l=.5*e.distanceTo(t),c=-this.direction.dot(f),h=m.dot(this.direction),u=-m.dot(f),d=m.lengthSq(),g=Math.abs(1-c*c);if(g>0)if(a=c*h-u,o=l*g,(n=c*u-h)>=0)if(a>=-o)if(a<=o){var v=1/g;s=(n*=v)*(n+c*(a*=v)+2*h)+a*(c*n+a+2*u)+d}else a=l,s=-(n=Math.max(0,-(c*a+h)))*n+a*(a+2*u)+d;else a=-l,s=-(n=Math.max(0,-(c*a+h)))*n+a*(a+2*u)+d;else a<=-o?s=-(n=Math.max(0,-(-c*l+h)))*n+(a=n>0?-l:Math.min(Math.max(-l,-u),l))*(a+2*u)+d:a<=o?(n=0,s=(a=Math.min(Math.max(-l,-u),l))*(a+2*u)+d):s=-(n=Math.max(0,-(c*l+h)))*n+(a=n>0?l:Math.min(Math.max(-l,-u),l))*(a+2*u)+d;else a=c>0?-l:l,s=-(n=Math.max(0,-(c*a+h)))*n+a*(a+2*u)+d;return i&&i.copy(this.direction).multiplyScalar(n).add(this.origin),r&&r.copy(f).multiplyScalar(a).add(p),s}),isIntersectionSphere:function(e){return this.distanceToPoint(e.center)<=e.radius},isIntersectionPlane:function(e){return 0!=e.normal.dot(this.direction)||0==e.distanceToPoint(this.origin)},distanceToPlane:function(e){var t=e.normal.dot(this.direction);return 0==t?0==e.distanceToPoint(this.origin)?0:void 0:-(this.origin.dot(e.normal)+e.constant)/t},intersectPlane:function(e,t){var i=this.distanceToPlane(e);if(void 0!==i)return this.at(i,t)},intersectBox:function(e,t,i){var r,n,a,s,o,l,c=1/this.direction.x,h=1/this.direction.y,u=1/this.direction.z,d=this.origin;return c>=0?(r=(e.min.x-d.x)*c,n=(e.max.x-d.x)*c):(r=(e.max.x-d.x)*c,n=(e.min.x-d.x)*c),h>=0?(a=(e.min.y-d.y)*h,s=(e.max.y-d.y)*h):(a=(e.max.y-d.y)*h,s=(e.min.y-d.y)*h),r>s||a>n?null:((a>r||r!=r)&&(r=a),(s<n||n!=n)&&(n=s),u>=0?(o=(e.min.z-d.z)*u,l=(e.max.z-d.z)*u):(o=(e.max.z-d.z)*u,l=(e.min.z-d.z)*u),r>l||o>n?null:((o>r||r!=r)&&(r=o),(l<n||n!=n)&&(n=l),n<0?null:(i&&(i.x=r,i.y=n),this.at(r>=0?r:n,t))))},applyMatrix4:function(e){return this.direction.add(this.origin).applyMatrix4(e),this.origin.applyMatrix4(e),this.direction.sub(this.origin),this.direction.normalize(),this},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)},clone:function(){return(new e.Ray).copy(this)},intersectPlaneInDir:function(e,t){var i=this.distanceToPlane(e);if(!(void 0===i||i<0))return this.at(i,t)},computeShortestPointToLine:function(t,i){var r=this.direction,n=(new e.Vector3).subVectors(i,t),a=(new e.Vector3).subVectors(this.origin,t),s=r.lengthSq(),o=r.dot(n),l=n.lengthSq(),c=r.dot(a),h=n.dot(a),u=s*l-o*o,d=0;return d=u<1e-7?o>l?c/o:h/l:(s*h-o*c)/u,n.multiplyScalar(d).add(t)},_distanceFromIntersection:function(e){var t=this.origin,i=this.direction;return l.subVectors(e,t),s=l.dot(i),o=c.addVectors(t,h.copy(i).multiplyScalar(s)),e.distanceTo(o)},intersectMeshInstances:function(t,r,n,a,s,o,l,c,h,p){var f,m,v,S,_,y=(p=p||{}).devicePixelRatio?p.devicePixelRatio:e.getDevicePixelRatio(),x=!!p.candidatesOnly,M=!!p.debugPickHybrid,P=!!p.useViewerPickingRules,C=void 0===p.inVisibleSpace||p.inVisibleSpace,b=t.object,D=t.type,w=d(a,s,o);void 0!==D?(v=2===D,S=1===D,_=0===D):(v=!0,S=!0,_=!0);var E=null;if(P&&r._viewpoint&&r._viewpoint.viewer&&(E=new e.PickingMode)._fromRenderer(r._viewpoint.viewer.renderer.renderer),b instanceof e.Mesh)f=[{object:b}];else{var T=p.renderLists||["main","noz","noEffectNoZ","afterHighlightNoZ","dialog"];for(f=[],m=0;m<T.length;m++)f=f.concat(b.getWebGLObjects(T[m],0))}var A,I,R=[];i._screenWidth=l,i._screenHeight=c,r.matrixWorldInverse.getInverse(r.matrixWorld),i._projScreenMatrix.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse);var L=h*y,O=1.4142135623730951;for(m=0,A=f.length;m<A;m++){if(null!==f[m])if(!1!==(I=f[m].object).noPickThrough&&g(I.visible,I.visibilityFree,C,I.layer,I._occurrence)){var N=new e.Vector3;null!==I.geometry.boundingSphere&&N.copy(I.geometry.boundingSphere.center);var F=I._getMMMatrix();N.applyMatrix4(F);var V=this._distanceFromIntersection(N),U=F.getMaxScaleOnAxis(),B=0;if(I.frustumCulled&&void 0!==c){var k=0,G=0,z=null,H=0;I.geometry.length>=0?(z=I.geometry[0],H=I.geometry.length):2===I.geometry._type&&(z=I.geometry,H=1);for(var W=0;W<H;W++)for(var j=z.drawingGroups,X=0,q=j.length;X<q;X++){var Z,Y=j[X];if(Y.gas)Y.gas.isGAS&&0===Y.glType?Z=Y.gas.getPointSize():Y.gas instanceof e.ParticleBasicMaterial&&Y.gas.size&&(Z=Y.gas.size),Z>G&&(G=Z);else Y.material&&Y.material instanceof e.ParticleBasicMaterial&&Y.material.size&&Y.material.size>G&&(G=Y.material.size)}k+=G,B=r.getWorldSizeFromPixelSize(k,N,i._screenHeight)}var K=r.getWorldSizeFromPixelSize(L,N,i._screenHeight);if(!I.frustumCulled||V<=I.geometry.boundingSphere.radius*U+B*O/2+K*O){var J=u(w,I,E);if(v){var Q;if(2===I.geometry._type||I.geometry.length>=0)(Q=this.intersectBufferGeomOptim(r,n,I,x,J,C)).length&&!x&&(!Q[0].point&&t.point&&(Q[0].point=t.point),!Q[0].normal&&t.normal&&(Q[0].normal=t.normal));else(Q=new e.Raycaster(this.origin,this.direction,r.near,r.far).intersectObject(I,!1)).length&&!x&&(!Q[0].point&&t.point&&(Q[0].point=t.point),!Q[0].normal&&t.normal&&(Q[0].normal=t.normal));R=R.concat(Q)}if(S){var $=this.intersectBufferGeomEdge(n,I,h,r,y,x,J,C);$.length&&!x&&(!$[0].point&&t.point&&($[0].point=t.point),!$[0].normal&&t.normal&&($[0].normal=t.normal)),R=R.concat($)}if(_){var ee=this.intersectBufferGeomPoint(n,I,r,t.point,h,M,y,x,J,C);ee.length&&!x&&(!ee[0].point&&t.point&&(ee[0].point=t.point),!ee[0].normal&&t.normal&&(ee[0].normal=t.normal)),R=R.concat(ee)}}}}return x||R.sort(function(e,t){return e.distance-t.distance}),R},_cast:function(t,i,r,n){var a,s=r||{},o="mesh"===i,l=void 0!==s.rayLength?s.rayLength:1/0,c=null===s.intersectFaces||void 0===s.intersectFaces||s.intersectFaces,h=s.intersectEdges,u=s.intersectPoints,d=s.edgeTolerance?s.edgeTolerance:.1,p=s.pointTolerance?s.pointTolerance:.1,f=t,m=0,g=0,v=null,S=[],_=new e.Vector3;for(m=0,a=f.length;m<a;m++)if(null!==f[m]){var y=(v=f[m].object?f[m].object:f[m]).worldCenter,x=v.worldRadius,M=this.distanceToPoint(y);if(_.subVectors(y,this.origin).dot(this.direction)-x<=l&&M<=x){var P,C,b;if(c){if(2===v.geometry._type||v.geometry.length>=0)P=this._castRayIntoBufferGeom(v,o,l);else P=new e.Raycaster(this.origin,this.direction,0,l).intersectObject(v,!1);for(g=0;g<P.length;g++){var D=new n;if(P[g].primitive){var w=!0===P[g].primitive?null:THREEDS.SubElement.getFromSGNode(P[g].primitive);D.setFromOccurrence(P[g].object._occurrence,w,void 0,!0)}else D.setFromOccurrence(P[g].object._occurrence),P[g].distance=this.direction.dot((new e.Vector3).subVectors(y,this.origin));P[g].pathElement=D}S=S.concat(P)}if(h&&(!o||o&&!P)){for(C=this._castRayIntoBufferGeomEdge(v,d,o,l),g=0;g<C.length;g++){D=new n;if(C[g].primitive){w=!0===C[g].primitive?null:THREEDS.SubElement.getFromSGNode(C[g].primitive);D.setFromOccurrence(C[g].object._occurrence,w,void 0,!0)}else D.setFromOccurrence(C[g].object._occurrence),C[g].distance=this.direction.dot((new e.Vector3).subVectors(y,this.origin));C[g].pathElement=D}S=S.concat(C)}if(u&&(!o||o&&!C)){for(b=this._castRayIntoBufferGeomPoint(v,p,o,l),g=0;g<b.length;g++){D=new n;if(b[g].primitive){w=!0===b[g].primitive?null:THREEDS.SubElement.getFromSGNode(b[g].primitive);D.setFromOccurrence(b[g].object._occurrence,w,void 0,!0)}else D.setFromOccurrence(b[g].object._occurrence),b[g].distance=this.direction.dot((new e.Vector3).subVectors(y,this.origin));b[g].pathElement=D}S=S.concat(b)}}}return S.sort(function(e,t){return e.distance-t.distance}),S},intersectMeshInstancesZones3D:function(t,r,n,a,s,o,l,c,h,p,f,m,v){var S,_,y=!!(v=v||{}).inVisibleSpace,x=!!v.useViewerPickingRules,M=void 0===y||y;if(t instanceof e.Mesh)S=[{object:t}];else{var P=v.renderLists||["main","noz","noEffectNoZ","afterHighlightNoZ","dialog"];for(S=[],_=0;_<P.length;_++)S=S.concat(t.getWebGLObjects(P[_],0))}var C=null;x&&r._viewpoint&&r._viewpoint.viewer&&(C=new e.PickingMode)._fromRenderer(r._viewpoint.viewer.renderer.renderer);var b,D,w=d(l,c,h),E=[];for(i._screenWidth=p,i._screenHeight=f,r.matrixWorldInverse.getInverse(r.matrixWorld),i._projScreenMatrix.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),_=0,b=S.length;_<b;_++){if(null!==S[_])if(!1!==(D=S[_].object).noPickThrough&&g(D.visible,D.visibilityFree,M,D.layer,D._occurrence)){if(void 0!==D.pickable&&!D.pickable)continue;var T=new e.Sphere;null!==D.geometry.boundingSphere&&T.copy(D.geometry.boundingSphere);var A=D._getMMMatrix();if(T.center.applyMatrix4(A),s.intersectsSphere(T)){var I=[],R=u(w,D,C);if(m||o)for(var L=2;L>=0;L--){var O=[];if(2===L)if(2===D.geometry._type||D.geometry.length>=0)O=this.intersectBufferGeomZone3D(r,s,D,o,m,R,M);else O=new e.Raycaster(this.origin,this.direction,r.near,r.far).intersectObject(D,!1);else 1===L?O=this.intersectBufferGeomEdge3D(s,D,o,m,R,M):0===L&&(O=this.intersectBufferGeomPoint3D(s,D,R,M));if(o)I=I.concat(O);else{if(!m&&!O.length)break;if(!I.length&&O.length&&(I=I.concat(O)),m&&I.length>0)break}}else I=this.intersectBufferGeom3DInsideFrustumMesh(s,D,R,M);I&&(E=E.concat(I))}}}return E}},Object.assign(v.prototype,r),Object.assign(v.prototype,n),Object.assign(v.prototype,a),v}),define("DS/Shaders/PBRShaders",["DS/Visualization/ThreeJS_R57","DS/Materials/PhysicalMaterial"],function(e,t){"use strict";var i,r=function(e,t){return["vec2 "+t+" = applyUVCombination("+e+"UvSlot == 1 ? uvToUse : uv2ToUse,"+e+"UvTransform);"].join("\n")},n=["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform int pointLightPhysicalAttenuation[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform int spotLightPhysicalAttenuation[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#if MAX_IES_LIGHTS > 0","uniform vec3 iesLightPosition[ MAX_IES_LIGHTS ];","uniform float iesLightDistance[ MAX_IES_LIGHTS ];","varying vec4 viesLight[ MAX_IES_LIGHTS ];","uniform sampler2D iesLightTexture[ MAX_IES_LIGHTS ];","uniform mat4 matrixWorldInv[MAX_IES_LIGHTS];","#endif","#endif","#if MAX_TUBE_LIGHTS > 0 || MAX_AREA_LIGHTS > 0 || MAX_DISK_LIGHTS > 0 || MAX_SPHERE_LIGHTS > 0","#define HAS_AREA_LIGHTS","#endif","varying vec3 vWorldPosition;","#if defined(USE_SPECGLOSS_FLAKES) || defined(USE_DSPBR_FLAKES) || defined(USE_ORANGE_PEEL)","#define NEED_OBJECT_SPACE_DATA","varying vec3 vObjectSpacePosition;","varying vec3 vObjectSpaceNormal;","#endif"].join("\n"),a=["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","vPointLight[ i ] = vec4( lVector, lDistance );","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","vSpotLight[ i ] = vec4( lVector, lDistance );","}","#endif","#if MAX_IES_LIGHTS > 0","for( int i = 0; i < MAX_IES_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( iesLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( iesLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / iesLightDistance[ i ] ), 1.0 );","viesLight[ i ] = vec4( lVector, lDistance );","}","#endif","#endif","vWorldPosition = worldPosition.xyz;","#if defined(NEED_OBJECT_SPACE_DATA)","vObjectSpacePosition = position.xyz;","vObjectSpaceNormal = objectNormal.xyz;","#endif"].join("\n"),s=["const float kEpsilon = 0.00001;","vec3 getGeomT(in vec3 N) {","vec3 normN = normalize(N);","float x = normN.x;","float y = normN.y;","float z = normN.z;","vec3 T = vec3(0.0);","if ( abs(z) > 0.0) {","T.y += 0.0;","T.x += 1.0;","T.z += - x / z;","return normalize(T);","}","if ( abs(y) > 0.0) {","T.x += 0.0;","T.z += 1.0;","T.y += - z / y;","return normalize(T);","}","if ( abs(x) > 0.0) {","T.z += 0.0;","T.y += 1.0;","T.x += - y / x;","return normalize(T);","}","return vec3(0.0);","}","vec3 getGeomB(in vec3 N, in vec3 T) {","N = normalize(N);","T = normalize(T);","return normalize(cross(N,T));","}","float myAtan2(float y,float x){","float absx, absy, val;","float pi = 3.14159265359;","float ret;","if (x == 0.0 && y == 0.0) return 0.0;","absy = y < 0.0 ? -y : y;","if(y < 0.0) absy = -y;","else absy = y;","absx = x < 0.0 ? -x : x;","if (absy - absx == absy) return y < 0.0 ? -pi*0.5 : pi*0.5;","if (absx - absy == absx) val = 0.0;","else val = atan(y/x);","if (x > 0.0) return val;","if (y < 0.0) return val - pi;","return val + pi;","}","vec3 vOrthoProjectionOnLine(in vec3 P, in vec3 A, in vec3 B) {","vec3 v = normalize(B - A);","vec3 AP = P - A;","return A + dot(AP,v) * v;","}","#define INV_GOLDEN_RATIO 0.6180339887","vec2 Hammersley2D(int i, int N)","{","return vec2((float(i) + 0.5) / float(N), fract(float(i) * INV_GOLDEN_RATIO));","}","float vSmoothstep(float lower, float upper, float factor) {","if (upper <= lower) {","return 0.0;","}","return smoothstep(lower, upper, factor);","}","float vLerp(in float a, in float b, in float w) {","return a + w * (b-a);","}","vec3 vLerp(in vec3 a, in vec3 b, in vec3 w) {","return a + w * (b-a);","}","vec3 TangentToWorldGeom(vec3 Vec, vec3 TangentZ) {","vec3 TangentX = getGeomT(TangentZ);","vec3 TangentY = getGeomB(TangentZ, TangentX);","return TangentX * Vec.x + TangentY * Vec.y + TangentZ * Vec.z;","}","vec3 TangentToWorld(vec3 Vec, vec3 TangentZ) {","vec3 UpVector = abs(TangentZ.x) < 0.999 ? vec3(0,0,1) : vec3(1,0,0);","vec3 TangentX = normalize(cross(UpVector, TangentZ));","vec3 TangentY = cross(TangentZ, TangentX);","return TangentX * Vec.x + TangentY * Vec.y + TangentZ * Vec.z;","}","vec3 ImportanceSampleGGX(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * 3.14159265359 * Xi.x;","float a = roughness * roughness;","float a2 = a * a;","float CosTheta = clamp(sqrt((1.0 - Xi.y) / (1.0 + (a2 - 1.0) * Xi.y)),0.0,1.0);","float SinTheta = sqrt(1.0 - CosTheta * CosTheta);","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return H;","}","vec3 ImportanceSampleGGXAniso(vec2 Xi, float roughness, vec3 T, vec3 B, vec3 N, float iAnisotropy) {","vec3 H;","float m = roughness * roughness;","float a_x = m;","float a_y = mix(0.0, m, 1.0 - iAnisotropy);","a_x = max(a_x, kEpsilon);","a_y = max(a_y, kEpsilon);","float coef = sqrt(Xi.y / (1.0 - Xi.y));","H = coef * (a_x * cos(2.0 * PI * Xi.x) * T + a_y * sin(2.0 * PI * Xi.x) * B) + N;","return normalize(H);","}","vec2 vLogComplex(in float value) {","float real = log(abs(value));","float im = atan(0.0,value);","return vec2(real,im);","}","vec2 invComplex(in vec2 value) {","return vec2(value.x,-value.y)/(value.x * value.x + value.y * value.y);","}","vec3 ImportanceSampleAshikmin(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * PI * Xi.x;","float a = roughness * roughness;","float interiorTerm = 4.0*a*exp(1.0/a)/(4.0*a*Xi.y + Xi.y - 1.0);","vec2 exteriorTerm = a*vLogComplex(interiorTerm);","vec2 value = invComplex(exteriorTerm);","float val = min(length(value),1.0);","float SinTheta = sqrt(val);","float CosTheta = sqrt(1.0 - val);","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return H;","}","vec3 ImportanceSampleCosine(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * PI * Xi.x;","float value = Xi.y;","float SinTheta = sqrt(value);","float CosTheta = sqrt(1.0 - value);","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return H;","}","vec3 ImportanceSampleEstevezKulla(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * PI * Xi.x;","float a = roughness;","a = max(1e-3, a);","float SinTheta = pow(Xi.y, a / ( 2.0 * a + 1.0));","float CosTheta = sqrt(1.0 - SinTheta * SinTheta);","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return H;","}","vec3 ImportanceSampleBeckmann(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * PI * Xi.x;","float a = roughness * roughness;","float a2 = a * a;","float loga = 8.0*a2*log(1.0-Xi.y);","float value = loga / (loga - 1.0);","float SinTheta = sqrt(value);","float CosTheta = sqrt(1.0 - value);","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return H;","}","float modI(float a, float b) {","float m = a - floor((a+0.5)/b)*b;","return floor(m+0.5);","}","int modI(int a, int b) {","return int(modI(float(a), float(b)));","}","float vRound(float a) {","return floor(a + 0.5);","}","float vMax(in vec2 v) {","return max(v.x,v.y);","}","float vMax(in vec3 v) {","return max(vMax(v.xy),v.z);","}","float vMax(in vec4 v) {","return max(vMax(v.xy),vMax(v.zw));","}","float vMin(in vec2 v) {","return min(v.x,v.y);","}","float vMin(in vec3 v) {","return min(vMin(v.xy),v.z);","}","float vMin(in vec4 v) {","return min(vMin(v.xy),vMin(v.zw));","}","float affine(in float value, in float value0, in float value1) {","return value * (value1 - value0) + value0;","}","float toTexCoord(in float x, in float minValue, in float maxValue) {","return clamp((clamp(x, minValue, maxValue) - minValue) / (maxValue - minValue),0.0,1.0);","}","vec2 toTexCoord(in vec2 x, in vec2 minValue, in vec2 maxValue) {","return clamp((clamp(x, minValue, maxValue) - minValue) / (maxValue - minValue),0.0,1.0);","}","vec3 toTexCoord(in vec3 x, in vec3 minValue, in vec3 maxValue) {","return clamp((clamp(x, minValue, maxValue) - minValue) / (maxValue - minValue),0.0,1.0);","}","vec4 toTexCoord(in vec4 x, in vec4 minValue, in vec4 maxValue) {","return clamp((clamp(x, minValue, maxValue) - minValue) / (maxValue - minValue),0.0,1.0);","}","float zeroSphericalHarmonics() {","return sqrt(0.31830988618) / 2.0;","}","bool vIsnan( float val )","{","return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;","}","vec2 vNormalize( vec2 val )","{","float len = length(val);","if ( len < 1e-6) {","return vec2(0.0);","}","return val/len;","}","vec3 vNormalize( vec3 val )","{","float len = length(val);","if ( len < 1e-6) {","return vec3(0.0);","}","return val/len;","}","vec4 vNormalize( vec4 val )","{","float len = length(val);","if ( len < 1e-6) {","return vec4(0.0);","}","return val/len;","}","mat3 transposeMatrix(in mat3 m) {","mat3 mT;","mT[0] = vec3(m[0][0], m[1][0], m[2][0]);","mT[1] = vec3(m[0][1], m[1][1], m[2][1]);","mT[2] = vec3(m[0][2], m[1][2], m[2][2]);","return mT;","}","float gaussian(in float x, in float mean, in float variance) ","{","float value = x - mean;","value *= value;","value /= 2.0 * variance;","return exp(-value);","}","float saturate(in float iValue)","{","return clamp(iValue, 0.0, 1.0);","}","vec2 saturate(in vec2 iValue)","{","return clamp(iValue, vec2(0.0), vec2(1.0));","}","vec3 saturate(in vec3 iValue)","{","return clamp(iValue, vec3(0.0), vec3(1.0));","}","vec4 saturate(in vec4 iValue)","{","return clamp(iValue, vec4(0.0), vec4(1.0));","}","float pow2(in float iValue)","{","return iValue*iValue;","}","float pow3(in float iValue)","{","return pow2(iValue) * iValue;","}","float pow4(in float iValue)","{","float tmp = pow2(iValue);","return pow2(tmp);","}","float pow5(in float iValue)","{","float tmp = pow4(iValue);","return tmp * iValue;","}","float pow6(in float iValue)","{","float tmp = pow2(iValue);","float tmp2 = pow2(tmp);","return tmp * tmp2;","}","float fma(in float x, in float y, in float z) {","return x*y + z;","}","vec3 fma(in vec3 x, in vec3 y, in vec3 z) {","return x*y + z;","}","vec2 fma(in vec2 x, in vec2 y, in vec2 z) {","return x*y + z;","}","vec4 fma(in vec4 x, in vec4 y, in vec4 z) {","return x*y + z;","}","vec3 Rotate3D(in vec3 iVec, in float iAngle, in vec3 iAxe) {","float s = sin(iAngle);","float c = cos(iAngle);","float x = iAxe.x;","float y = iAxe.y;","float z = iAxe.z;","mat3 rot = mat3(pow2(x) * (1.0 - c) + c, x * y * (1.0 - c) - z * s, x * z * (1.0 - c) + y * s,","x * y * (1.0 - c) + z * s, pow2(y) * (1.0 - c) + c, y * z * (1.0 - c) - x * s,","x * z * (1.0 - c) - y * s, y * z * (1.0 - c) + x * s, pow2(z) * (1.0 - c) + c);","return rot * iVec;","}"].join("\n"),o=["#if defined (USE_SPECGLOSS_FLAKES) || defined (USE_ORANGE_PEEL)","vec4 mod289(vec4 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec3 mod289(vec3 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec2 mod289(vec2 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec3 permute(vec3 x) {","  return mod289(((x*34.0)+1.0)*x);","}","vec4 permute(vec4 x) {","\treturn mod289(((x*34.0)+1.0)*x);","}","vec4 taylorInvSqrt(vec4 r) {","\treturn 1.79284291400159 - 0.85373472095314 * r;","}","float snoise(vec3 v) {","const vec2  C = vec2(1.0/6.0, 1.0/3.0);","const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);","vec3 i  = floor(v + dot(v, C.yyy) );","vec3 x0 =   v - i + dot(i, C.xxx) ;","vec3 g = step(x0.yzx, x0.xyz);","vec3 l = 1.0 - g;","vec3 i1 = min( g.xyz, l.zxy );","vec3 i2 = max( g.xyz, l.zxy );","vec3 x1 = x0 - i1 + C.xxx;","vec3 x2 = x0 - i2 + C.yyy;","vec3 x3 = x0 - D.yyy;","i = mod289(i);","vec4 p = permute( permute( permute( i.z + vec4(0.0, i1.z, i2.z, 1.0 )) + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));","float n_ = 0.142857142857;","vec3  ns = n_ * D.wyz - D.xzx;","vec4 j = p - 49.0 * floor(p * ns.z * ns.z);","vec4 x_ = floor(j * ns.z);","vec4 y_ = floor(j - 7.0 * x_ );","vec4 x = x_ *ns.x + ns.yyyy;","vec4 y = y_ *ns.x + ns.yyyy;","vec4 h = 1.0 - abs(x) - abs(y);","vec4 b0 = vec4( x.xy, y.xy );","vec4 b1 = vec4( x.zw, y.zw );","vec4 s0 = floor(b0)*2.0 + 1.0;","vec4 s1 = floor(b1)*2.0 + 1.0;","vec4 sh = -step(h, vec4(0.0));","vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy;","vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww;","vec3 p0 = vec3(a0.xy,h.x);","vec3 p1 = vec3(a0.zw,h.y);","vec3 p2 = vec3(a1.xy,h.z);","vec3 p3 = vec3(a1.zw,h.w);","vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));","p0 *= norm.x;","p1 *= norm.y;","p2 *= norm.z;","p3 *= norm.w;","vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);","m = m * m;","return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) ) );","}","#endif","#if defined(USE_SPECGLOSS_FLAKES) || defined(USE_ORANGE_PEEL)","#define NBOCTAVES 10","float getMean(in float LODLevel) {","float mult = 1.8;","float LOD = 3.0;","float oldLOD = 0.0;","for (int i = NBOCTAVES - 1 ; i >=0; i--) {","float pente = 1.0 / (LOD - oldLOD);","float origine = float(i) + 1.0 + oldLOD * pente;","if (LODLevel <= LOD) {","return origine - pente * LODLevel;","}","oldLOD = LOD;","LOD *= mult;","}","return 0.0;","}","float FBM(vec3 iVector)","{","vec3 vector = iVector;","float res = 0.0;","float amplitude = 1.0;","float sum = 0.0;","for (int octave = 0; octave < 1; octave++) {","if (amplitude < 10.0 * kEpsilon) {","break;","}","vector = vector * 2.0;","sum += amplitude;","res += snoise(vector) * amplitude;","amplitude *= 0.5;","}","return clamp(res/sum,-1.0,1.0);","}","float arrayFBMMixer(in vec3 iVector, in float LODLevel, in float frequency, in float low, in float up)","{","vec3 vector = iVector;","float res = 0.0;","float sum = 0.0;","float variance = 1.5;","float mean = getMean(LODLevel);","float amplitude;","int minIndex = int(max(0.0, mean - low));","int maxIndex = int(min(float(NBOCTAVES), mean + up));","frequency *= pow(1.8, float(minIndex));","int octave = minIndex;","for (int i = 0; i < 10 ; i++) {","if (octave >= maxIndex) {break;}","vec3 vec = vector * frequency;","frequency *= 1.8;","amplitude = gaussian(float(octave), mean, variance);","sum += amplitude;","res += snoise(vec) * amplitude;","octave++;","}","return clamp(res/sum,-1.0,1.0);","}","#endif"].join("\n"),l=function(e,t,i){return["#ifdef PDSFX",e+" = "+t+";",t+" = "+i+"();","#endif"].join("\n")},c=function(e,t,i){return["#ifdef PDSFX",e+" = "+t+";",t+" = "+i+"();","#if defined(GAMMA_INPUT) && defined(DSPBR)","if (!all(equal("+t+", "+e+"))) {",t+".rgb = convertToLinear("+t+".rgb);","}","#endif","#endif"].join("\n")},h=function(e,t,i,r,n){return["#ifdef "+i,"if ("+t+".x < 0.0 || "+t+".x > 1.0) {",e+" = "+n+";","}","#endif","#ifdef "+r,"if ("+t+".y < 0.0 || "+t+".y > 1.0) {",e+" = "+n+";","}","#endif"].join("\n")},u=function(e,t,i,n,a,s,o,l,c){var h=t+"UV",u=t+"Map",d=t+"MulCoef",p=t+"AddCoef",f=e+"= texture2D("+u+", "+h+")."+s+";";if(o){var m=e+"= texture2D("+u+", "+h+")."+o+";";if(l)f=["#ifdef PBR_FROM_GLTF","#if PBR_FROM_GLTF == 2",e+"= texture2D("+u+", "+h+")."+l+";","#else",m,"#endif","#else",f,"#endif"].join("\n");else f=["#ifdef PBR_FROM_GLTF",m,"#else",f,"#endif"].join("\n")}return[(a?"float ":"")+e+" = "+t+";","#ifdef "+i,r(t,h),f,"#endif","#ifdef "+n,e+" = "+(c?"":"saturate")+"("+d+" * "+e+" + "+p+");","#endif"].join("\n")},d=function(e,t,i,n,a,s,o){var l=t+"UV",c=t+"MulCoef",h=t+"AddCoef",u=e+"= texture2D("+(t+"Map")+", "+l+").rgb;";return[(s?"vec3 ":"")+e+" = "+t+";","#ifdef "+i,r(t,l),u,"#if defined( GAMMA_INPUT ) && !defined("+a+")",e+".rgb = convertToLinear("+e+".rgb);","#endif","#endif","#ifdef "+n,e+" = "+(o?"":"saturate")+"("+c+" * "+e+" + "+h+");","#endif"].join("\n")},p=[u("transparencyValue","transparency","USE_TRANSPARENCYMAP","USE_TRANSPARENCY_COEFFICIENTS",!0,"r"),l("_DStransparency_","transparencyValue","ComputeTransparency"),"#ifdef USE_SUBSURFACE","float transToDivide = ApplyTransparency(transparencyValue, materialData.metalness, materialData.scatteringColor * albedo, NoV);","#else","float transToDivide = ApplyTransparency(transparencyValue, materialData.metalness, albedo, NoV);","#endif","materialData.transparency = transparencyValue;"].join("\n"),f=["float opacityValue = opacity;","#if defined(SELECTION_MATERIAL)","opacityValue = 1.0;","#endif","#ifdef USE_COLOR","opacityValue *= vColor.a;","#endif","#ifdef USE_OPACITYMAP",r("opacity","opacityUV"),"opacityValue = texture2D(opacityMap, opacityUV).r;",h("opacityValue","opacityUV","USE_OPACITYMAP_BORDER_COLOR_U","USE_OPACITYMAP_BORDER_COLOR_V","opacityBorderValue"),"#endif","#if defined(USE_MAP)","#if defined(TEXTURE_MODULATE) || defined(TEXTURE_BLEND) || defined(USE_ALPHA_FROM_MAP)","opacityValue *= texelAlbedo.a;","#endif","#endif","#ifdef USE_OPACITY_COEFFICIENTS","opacityValue = saturate(opacityMulCoef * opacityValue + opacityAddCoef);","#endif",l("_DSopacity_","opacityValue","ComputeOpacity"),"gl_FragColor.a = opacityValue;",e.ShaderChunk.alphatest_fragment].join("\n"),m=["#ifdef DSPBR_WITH_TRANSLUCENCY",u("materialData.translucency","translucency","USE_TRANSLUCENCYMAP","USE_TRANSLUCENCY_COEFFICIENTS",!1,"r"),"#endif","#ifdef DSPBR_WITH_TRANSLUCENCY_COLOR",d("materialData.translucencyColor","translucencyColor","USE_TRANSLUCENCY_COLOR_MAP","USE_TRANSLUCENCY_COLOR_COEFFICIENTS","TRANSLUCENCY_COLOR_LINEAR",!1),"#endif"].join("\n"),g=["#ifdef USE_IRIDESCENCE","materialData.iridescenceIoR = iridescenceIoR;",u("materialData.iridescence","iridescence","USE_IRIDESCENCE_MAP","USE_IRIDESCENCE_COEFFICIENTS",!1,"r"),u("materialData.iridescenceThickness","iridescenceThickness","USE_IRIDESCENCE_THICKNESS_MAP","USE_IRIDESCENCE_THICKNESS_COEFFICIENTS",!1,"r","g",null,!1),"if (materialData.iridescenceThickness < 1e-12) {","materialData.iridescence = 0.0;","}","#endif"].join("\n"),v=["#ifdef PDSFX","vec3 vertexNormal = _DSvNormal;","#else","vec3 vertexNormal = normalize( vNormal );","#ifdef DECAL","vertexNormal = decalNormal;","#endif","#endif","#ifdef DOUBLE_SIDED","vertexNormal = vertexNormal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","surfaceData.viewNormal = vertexNormal;","#ifdef USE_NORMALMAP",r("normal","normalUv"),"#ifdef SPECGLOSS","#if defined(USE_NORMALSCALEMAP)",r("normalScale","normalScaleUv"),"vec2 scale = vec2(texture2D(normalScaleMap, normalScaleUv).r);","#else","vec2 scale = normalScale;","#endif","#ifdef USE_NORMALSCALE_COEFFICIENTS","scale = normalScaleMulCoef * scale + normalScaleAddCoef;","#endif","#else","vec2 scale = vec2(1.0);","#endif","surfaceData.viewNormal = perturbNormal3Arb( vertexNormal, tangent, binormal, normalUv, scale );","#elif defined( USE_BUMPMAP ) && defined(SPECGLOSS)",r("bump","bumpUv"),"#if defined(USE_BUMPSCALEMAP)",r("bumpScale","bumpScaleUv"),"float scale = texture2D(bumpScaleMap, bumpScaleUv).r;","#else","float scale = bumpScale;","#endif","#ifdef USE_BUMPSCALE_COEFFICIENTS","scale = bumpScaleMulCoef * scale + bumpScaleAddCoef;","#endif","surfaceData.viewNormal = perturbNormalArb( -surfaceData.viewPosition, vertexNormal, dHdxy_fwd(bumpUv, scale) );","#endif","surfaceData.worldNormal = normalize( vec3( vec4( surfaceData.viewNormal, 0.0 ) * viewMatrix ) );","vec3 normal = surfaceData.viewNormal;"].join("\n"),S=["#ifdef CLEAR_COAT",u("materialData.clearCoat","clearCoat","CLEAR_COAT_MAP","USE_CC_COEFFICIENTS",!1,"r"),"#ifdef CLEAR_COAT_NORMALMAP",r("clearCoatNormal","ccnormalUv"),"surfaceData.clearCoatNormal = perturbNormal3ArbCoat( vertexNormal, tangent, binormal, ccnormalUv );","#else","surfaceData.clearCoatNormal = vertexNormal;","#endif","surfaceData.clearCoatWorldNormal = normalize( vec3( vec4( surfaceData.clearCoatNormal, 0.0 ) * viewMatrix ) );","#ifdef USE_ORANGE_PEEL","doOrangePeel(surfaceData.worldNormal,surfaceData.clearCoatWorldNormal, surfaceData.worldPosition, surfaceData.objectSpacePosition);","surfaceData.clearCoatNormal = normalize( (viewMatrix * vec4( surfaceData.clearCoatWorldNormal, 0.0)).xyz);","#endif","#ifdef SPECGLOSS",d("materialData.clearCoatSR0Color","clearCoatColor","CLEAR_COAT_COLORMAP","USE_CC_COLOR_COEFFICIENTS","CLEARCOAT_LINEAR",!1),"#else","materialData.clearCoatSR0Color = vec3(0.04);","#endif","materialData.clearCoatSR90Color = vec3(1.0);",u("materialData.clearCoatRoughness","clearCoatRoughness","USE_CC_ROUGHNESSMAP","USE_CC_ROUGHNESS_COEFFICIENTS",!1,"r","g"),"#ifdef USE_CC_GLOSSINESSMAP",r("clearCoatRoughness","ccglossinessUV"),"float ccGlossiness = texture2D( coatingGlossinessMap, ccglossinessUV ).r;","materialData.clearCoatRoughness = 1.0 - ccGlossiness;","#endif","#ifdef USE_CC_GLOSSINESS_COEFFICIENTS","materialData.clearCoatRoughness = 1.0 - saturate(coatingGlossinessMulCoef * (1.0 - materialData.clearCoatRoughness) + coatingGlossinessAddCoef);","#endif","materialData.clearCoatRoughness =  clamp(materialData.clearCoatRoughness, ROUGHNESS_CLAMP_MIN, ROUGHNESS_CLAMP_MAX);","#endif"].join("\n"),_=["#ifdef USE_SPECGLOSS_FLAKES","doFlakes(surfaceData.worldNormal, surfaceData.worldPosition, surfaceData.objectSpacePosition);","metalFlakes.flakesNormal = normalize((viewMatrix* (vec4(metalFlakes.flakesWorldNormal, 0.0))).xyz);","metal.flakesNormal = surfaceData.viewNormal;","#ifdef PEARL_FLAKES_ACTIVATED","pearlFlakes.flakesNormal = normalize((viewMatrix * (vec4(pearlFlakes.flakesWorldNormal, 0.0))).xyz);","#endif","#endif","#ifdef USE_DSPBR_FLAKES",u("flakesCoverageV","flakesCoverage","USE_FLAKESCOVERAGE_MAP","USE_FLAKESCOVERAGE_COEFFICIENTS",!0,"r"),d("flakesColorV","flakesColor","USE_FLAKESCOLOR_MAP","USE_FLAKESCOLOR_COEFFICIENTS","FLAKES_LINEAR",!0),u("flakesRoughnessV","flakesRoughness","USE_FLAKESROUGHNESS_MAP","USE_FLAKESROUGHNESS_COEFFICIENTS",!0,"r"),"flakesRoughnessV = clamp(flakesRoughnessV, 0.036, 0.986);",u("flakesSizeV","flakesSize","USE_FLAKESSIZE_MAP","USE_FLAKESSIZE_COEFFICIENTS",!0,"r"),"#ifdef DSPBR_WITH_FLIPFLOP_COLOR",d("flipFlopColorV","flipFlopColor","USE_FLIPFLOP_COLOR_MAP","USE_FLIPFLOP_COLOR_COEFFICIENTS","FLIPFLOP_COLOR_LINEAR",!0),u("flipFlopV","flipFlop","USE_FLIPFLOP_MAP","USE_FLIPFLOP_COEFFICIENTS",!0,"r"),"flipFlopV = max(flipFlopV, 1e-12);","initFlakesData(surfaceData.objectSpacePosition, normalize(surfaceData.objectSpaceNormal),flakesSizeV, flakesCoverageV, flakesColorV, flakesRoughnessV, flipFlopV, flipFlopColorV);","#else","initFlakesData(surfaceData.objectSpacePosition, normalize(surfaceData.objectSpaceNormal),flakesSizeV, flakesCoverageV, flakesColorV, flakesRoughnessV);","#endif","#endif"].join("\n"),y=["#ifdef USE_SHEEN","#ifndef DSPBR_WITH_NO_SHEEN_VALUE",u("materialData.sheen","sheen","USE_SHEEN_MAP","USE_SHEEN_COEFFICIENTS",!1,"r"),"#else","materialData.sheen = 1.0;","#endif","#ifdef DSPBR_WITH_SHEEN_COLOR_ROUGHNESS",u("materialData.sheenRoughness","sheenRoughness","USE_SHEEN_ROUGHNESS_MAP","USE_SHEEN_ROUGHNESS_COEFFICIENTS",!1,"r","a"),"materialData.sheenRoughness = clamp(materialData.sheenRoughness, ROUGHNESS_CLAMP_MIN, ROUGHNESS_CLAMP_MAX);","#if !defined(DSPBR_WITH_SQUARED_ESTEVEZKULLA_ROUGHNESS) && defined(USE_SOFT_VELVET)","materialData.sheenRoughness = max(materialData.sheenRoughness, 0.07);","#endif",d("materialData.sheenColor","sheenColor","USE_SHEEN_COLOR_MAP","USE_SHEEN_COLOR_COEFFICIENTS","SHEEN_COLOR_LINEAR",!1),"materialData.sheenEnergyConservationConstant = materialData.sheen * vMax(materialData.sheenColor) * DirectionalSheenAlbedo(NoV, materialData.sheenRoughness);","#endif","#endif"].join("\n"),x=["#ifdef DSPBR_WITH_NO_CLAMPED_SPECULAR_TINt",d("materialData.specularTint","specular","USE_SPECULARMAP","USE_SPECULAR_COEFFICIENTS","SPECULAR_LINEAR",!1,!0),"#else",d("materialData.specularTint","specular","USE_SPECULARMAP","USE_SPECULAR_COEFFICIENTS","SPECULAR_LINEAR",!1,!1),"#endif",c("_DSspecular_","materialData.specularTint","ComputeSpecularReflectance")].join("\n"),M=[u("materialData.roughness","roughness","USE_ROUGHNESSMAP","USE_ROUGHNESS_COEFFICIENTS",!1,"r","g","a"),"#ifdef USE_GLOSSINESSMAP",r("roughness","glossinessUV"),"float glossinessTex = texture2D( glossinessMap, glossinessUV ).r;","materialData.roughness = 1.0-glossinessTex;","#endif","#ifdef USE_GLOSSINESS_COEFFICIENTS","materialData.roughness = 1.0 - saturate(glossinessMulCoef * (1.0 - materialData.roughness) + glossinessAddCoef);","#endif",l("_DSroughness_","materialData.roughness","ComputeRoughness"),"materialData.roughness = clamp(materialData.roughness, ROUGHNESS_CLAMP_MIN, ROUGHNESS_CLAMP_MAX);"].join("\n"),P=[d("emissionColorValue","emissionColor","USE_EMISSIONCOLORMAP","USE_EMISSIONCOLOR_COEFFICIENTS","EMISSION_LINEAR",!0),c("_DSemissive_","emissionColorValue","ComputeEmissive")].join("\n"),C=[u("materialData.metalness","metalness","USE_METALNESSMAP","USE_METALNESS_COEFFICIENTS",!1,"r","b")].join("\n"),b=[u("materialData.specularContribution","specularContrib","USE_SPECULARCONTRIBMAP","USE_SPECULARCONTRIB_COEFFICIENTS",!1,"r","a")].join("\n"),D=["#if defined( USE_ANISOTROPY )",u("materialData.anisotropy","anisotropy","USE_ANISOTROPYMAP","USE_ANISOTROPY_COEFFICIENTS",!1,"r"),"materialData.anisotropy = min(materialData.anisotropy, 0.975);",u("materialData.anisotropyAngle","anisotropyAngle","USE_ANISOTROPYANGLEMAP","USE_ANISOTROPYANGLE_COEFFICIENTS",!1,"r"),"surfaceData.binormal = binormal;","surfaceData.tangent = tangent;","#endif"].join("\n"),w=["#if defined( USE_THICKNESS )",u("surfaceData.thickness","thickness","USE_THICKNESSMAP","USE_THICKNESS_COEFFICIENTS",!1,"r"),"#endif"].join("\n"),E=["vec3 albedo = diffuse;","#ifdef USE_COLOR","albedo *= vColor.rgb;","#endif","#ifdef USE_MAP",r("diffuse","diffuseUV"),"#ifdef _VISUBASIC_FORCE_PHYSICAL_DIFFUSE_UV","diffuseUV = VisuBasic_diffuseTexUvToUse;","#endif","vec4 texelAlbedo = texture2D(map, diffuseUV);",h("texelAlbedo","diffuseUV","USE_DIFFUSEMAP_BORDER_COLOR_U","USE_DIFFUSEMAP_BORDER_COLOR_V","diffuseBorderColor"),"#if defined(GAMMA_INPUT) && !defined(USE_MAP_HDR)","texelAlbedo.rgb = convertToLinear(texelAlbedo.rgb);","#endif","if(_colorOverride == 1) {","texelAlbedo.rgb = albedo;","}","#ifdef TEXTURE_MODULATE ","albedo *= texelAlbedo.rgb;","#endif","#ifdef TEXTURE_BLEND ","albedo = mix(albedo, vec3(1.0), texelAlbedo.rgb);","#endif","#ifdef TEXTURE_DECAL ","albedo = mix(albedo, texelAlbedo.rgb, texelAlbedo.w);","#endif","#ifdef TEXTURE_IGNORE ","#endif","#if defined(TEXTURE_DEFAULT) ","albedo = texelAlbedo.rgb;","#endif","#if defined(TEXTURE_REPLACE)","gl_FragColor.xyz = texelAlbedo.xyz;","#if TEXTURE_FORMAT == 1021","gl_FragColor.a = texelAlbedo.a;","#endif",e.ShaderChunk.alphatest_fragment,"#if !defined(TEXTURE_REPLACE_CONTINUE)","return;","#endif","#endif","#endif","#ifdef USE_REFLECTIVITY_ENVMAP","vec3 cameraToVertexLegacy;","if (projectionMatrix[3][3] > 0.5) {","cameraToVertexLegacy = normalize( vec3( vec4( 0.0,0.0,-1.0, 0.0 ) * viewMatrix ) );","} else {","cameraToVertexLegacy = normalize( surfaceData.worldPosition - cameraPosition );","}","vec3 reflectVecLegacy = reflect( cameraToVertexLegacy, surfaceData.worldNormal );","albedo = sampleReflectivityEnvMap(reflectVecLegacy.yzx, albedo);","#endif","#ifdef USE_DIFFUSE_COEFFICIENTS","albedo = saturate(albedo * diffuseMulCoef + diffuseAddCoef);","#endif",c("_DSalbedo_","albedo","ComputeAlbedo")].join("\n");i=["if (projectionMatrix[3][3] > 0.5) {","surfaceData.view = vec3(0.0,0.0,1.0);","} else {","#ifdef DECAL","surfaceData.view = normalize( dViewPosition);","#else","surfaceData.view = normalize( vViewPosition );","#endif","}","surfaceData.viewPosition = vViewPosition;","#ifdef DECAL","surfaceData.viewPosition = dViewPosition;","#endif","vec3 vPos = surfaceData.viewPosition;","surfaceData.worldPosition = vWorldPosition;","#ifdef DECAL","surfaceData.worldPosition = dWorldPosition;","#endif","#ifdef NEED_OBJECT_SPACE_DATA","surfaceData.objectSpacePosition = vObjectSpacePosition;","surfaceData.objectSpaceNormal = vObjectSpaceNormal;","#ifdef DECAL","surfaceData.objectSpacePosition = dObjectSpacePosition;","surfaceData.objectSpaceNormal = dObjectSpaceNormal;","#endif","#endif",v,"#ifdef USE_SPECULAR_AA","surfaceData.TForSpecularAA = getGeomT(surfaceData.viewNormal);","surfaceData.BForSpecularAA = getGeomB(surfaceData.viewNormal, surfaceData.TForSpecularAA);","surfaceData.TBNMatrixForSpecularAA = transposeMatrix(mat3(surfaceData.TForSpecularAA, surfaceData.BForSpecularAA, surfaceData.viewNormal));","#endif","#ifdef USE_SUBSURFACE","surfaceData.curvature = length(fwidth(surfaceData.worldNormal)) / length(fwidth(surfaceData.worldPosition));","materialData.scatteringColor = SssLUTSampling(surfaceData.curvature);","#endif","float NoV = saturate(dot(surfaceData.viewNormal, surfaceData.view));",E,f,b,x,D,M,g,P,C,m,y,S,_,w,"#ifdef DEBUG_SHADOW","albedo = vec3(1.0);","materialData.specularContribution = 0.0;","materialData.metalness = 0.0;","#endif","#ifdef USE_LIGHTMAP",r("lightMap","lightMapUV"),"vec3 aoValue = texture2D(lightMap, lightMapUV).rgb;","#ifndef USE_LIGHTMAP_LINEAR","aoValue *= aoValue;","#endif","#endif","materialData.ior = ior;","materialData.adjustedIoR = ior;","#ifdef USE_THICKNESS","if (materialData.ior <= 1.0 + 1e-6 || surfaceData.thickness <= 1e-6) {","materialData.adjustedIoR = 1.0;","} else {","vec3 dummyT = getGeomT(surfaceData.worldNormal);","vec3 dummyB = getGeomB(surfaceData.worldNormal, dummyT);","vec3 dummyVector = normalize(surfaceData.worldNormal + dummyB + dummyT);","vec3 refractVec = refract(-dummyVector, surfaceData.worldNormal, 1.0/materialData.ior);","float sin1 = sqrt(1.0 - pow2(dot(-dummyVector, surfaceData.worldNormal)));","refractVec = normalize(-dummyVector + (refractVec * surfaceData.thickness));","float sin2 = sqrt(1.0 - pow2(dot(refractVec, surfaceData.worldNormal)));","materialData.adjustedIoR = max(abs(sin1), 1e-12) / max(abs(sin2), 1e-12);","}","#endif","#ifdef SPECGLOSS","materialData.F0 = 1.0;","#else","materialData.F0 = pow2((materialData.ior - 1.0)/(materialData.ior + 1.0));","#endif","#ifdef SPECGLOSS","materialData.sr0Color = materialData.specularTint;","materialData.sr90Color = vec3(1.0);","#else","materialData.sr0Color = (1.0 - materialData.metalness) * materialData.F0 * materialData.specularContribution  * materialData.specularTint + materialData.metalness * albedo;","materialData.sr90Color = vec3(1.0) * ((1.0-materialData.metalness)*materialData.specularContribution + materialData.metalness);","#endif","materialData.specularBlendingSR0 = materialData.F0 * materialData.specularTint;","#ifdef USE_IRIDESCENCE","materialData.iridescenceSR0Color = materialData.sr0Color;","if (materialData.iridescence > 0.0) {","vec3 fresnelIridescence = computeIridescence(1.0, materialData.iridescenceIoR, materialData.sr0Color, materialData.iridescenceThickness * 1e3, NoV);","materialData.iridescenceSR0Color = F0FromFresnelSchlick(fresnelIridescence, materialData.sr90Color, NoV);","materialData.sr0Color = mix(materialData.sr0Color, materialData.iridescenceSR0Color, materialData.iridescence);","materialData.specularBlendingSR0 = mix(materialData.specularBlendingSR0, materialData.iridescenceSR0Color, materialData.iridescence);","}","#endif",p,"#ifdef SPECGLOSS","materialData.diffuseColor = albedo;","materialData.transparentColor = albedo;","#else","materialData.diffuseColor = albedo * (1.0 - materialData.metalness) * (1.0 - materialData.transparency);","materialData.transparentColor = albedo * (1.0 - materialData.metalness) * materialData.transparency;","#endif","#if !defined(DSPBR_WITH_TRANSLUCENCY_COLOR)","#if defined(DSPBR_WITH_TRANSLUCENCY)","materialData.translucencyColor = materialData.diffuseColor;","#endif","#else","materialData.translucencyColor *= (1.0 - materialData.metalness) * (1.0 - materialData.transparency);","#endif","#if defined(USE_DSPBR_FLAKES)","initFlakesWeights(surfaceData.view, surfaceData.viewNormal);","#endif","#ifdef TRANSMITTANCE","#ifdef DEPTHMAP_BASED_TRANSMITTANCE","initDisk();","#endif","#ifdef THICKNESS_BASED_TRANSMITTANCE","materialData.transmittanceColor = GetTransmittance(surfaceData.thickness);","#endif","#endif","#ifdef HAS_AREA_LIGHTS","vec3 viewReflect = reflect(-surfaceData.view, surfaceData.viewNormal);","#ifdef USE_ANISOTROPY","vec3 areaBitangent = normalize(sin(2.0 * PI * materialData.anisotropyAngle) * surfaceData.tangent + cos(2.0 * PI * materialData.anisotropyAngle) * surfaceData.binormal);","vec3 anisotropicAreaTangent = cross(areaBitangent, surfaceData.view);","vec3 anisotropicAreaNormal = cross(anisotropicAreaTangent, areaBitangent);","vec3 bentAreaNormal = normalize(mix(surfaceData.viewNormal, anisotropicAreaNormal, materialData.anisotropy));","vec3 reflArea = -reflect( surfaceData.view, bentAreaNormal );","setAreaGGXData(materialData.roughness, saturate(dot(surfaceData.viewNormal, reflArea)), areaData.fresnel, areaData.Minv);","#else","setAreaGGXData(materialData.roughness, NoV,areaData.fresnel, areaData.Minv);","#endif","#ifdef CLEAR_COAT","setAreaGGXData(materialData.clearCoatRoughness, saturate(dot(surfaceData.clearCoatNormal,surfaceData.view)),areaData.fresnelCC, areaData.MinvCC);","#endif","#ifdef USE_SHEEN","#ifdef DSPBR_WITH_SHEEN_COLOR_ROUGHNESS","float sheenRough_AL = materialData.sheenRoughness;","#else","float sheenRough_AL = materialData.sheen;","#endif","#if defined(USE_VELVET) || defined(USE_SOFT_VELVET)","#if defined(DSPBR_WITH_SQUARED_ESTEVEZKULLA_ROUGHNESS)","setAreaSheenData(sheenRough_AL * sheenRough_AL, NoV, areaData.MinvSheen);","#else","setAreaSheenData(sheenRough_AL, NoV, areaData.MinvSheen);","#endif","#else","setAreaSheenData(0.3, NoV, areaData.MinvSheen);","#endif","#endif","#ifdef USE_SPECGLOSS_FLAKES","setAreaGGXData(metal.flakesRoughness, saturate(dot(metal.flakesNormal,surfaceData.view)),areaData.fresnelMetal, areaData.MinvMetal);","setAreaGGXData(metalFlakes.flakesRoughness, saturate(dot(metalFlakes.flakesNormal,surfaceData.view)),areaData.fresnelMetalFlakes, areaData.MinvMetalFlakes);","#ifdef PEARL_FLAKES_ACTIVATED","setAreaGGXData(pearlFlakes.flakesRoughness, saturate(dot(pearlFlakes.flakesNormal,surfaceData.view)),areaData.fresnelPearlFlakes, areaData.MinvPearlFlakes);","#endif","#endif","#ifdef USE_DSPBR_FLAKES","if (flakesData.smoothWeight > 0.0) {","setAreaGGXData(flakesData.flakesRoughness, NoV,areaData.fresnelMetal, areaData.MinvMetal);","}","if (flakesData.stochasticWeight > 0.0) {","vec3 normalStoFlakes = flakesData.stochasticHemisphereFlakesNormal;","float NdotVSto = saturate(dot(normalStoFlakes, surfaceData.view));","setAreaGGXData(flakesData.flakesRoughness, NdotVSto, areaData.fresnelMetalSto, areaData.MinvMetalSto);","}","if (flakesData.closeupWeight > 0.0) {","vec3 normalCloseUpFlakes = flakesData.closeupFlakesNormal;","float NdotVClose = saturate(dot(normalCloseUpFlakes, surfaceData.view));","setAreaGGXData(flakesData.flakesRoughness, NdotVClose, areaData.fresnelMetalClose, areaData.MinvMetalClose);","}","#endif","#endif","#ifdef DSPBR","float averageDirectionalMultipleAlbedo = AverageDirectionalMultipleAlbedo(materialData.roughness);","vec3 averageMultipleFresnel = AverageMultipleFresnel(materialData.sr0Color, materialData.sr90Color);","float multipleScatteringGGX = pow2(1.0 - DirectionalMultipleAlbedo(NoV, materialData.roughness))/max(1.0 - averageDirectionalMultipleAlbedo, 1e-6);","vec3 multipleScatteringFresnel = (averageMultipleFresnel * averageMultipleFresnel * averageDirectionalMultipleAlbedo)/max(1.0 - averageMultipleFresnel * (1.0 - averageDirectionalMultipleAlbedo), vec3(1e-6));","materialData.specularEnergyConservationConstant =  multipleScatteringGGX * multipleScatteringFresnel;","materialData.diffuseEnergyConservationConstant = mix(1.0, pow2(1.0 - DirectionalAlbedo(materialData.F0, materialData.specularTint, NoV, materialData.roughness)) / max(1.0 - AverageDirectionalAlbedo(materialData.F0, materialData.specularTint, materialData.roughness), 1e-6), materialData.specularContribution);","#endif"].join("\n");var T=["#ifndef DEBUG_SHADOW","#ifdef USE_LIGHTING","gl_FragColor.xyz += totalTransmissive;","#endif","gl_FragColor.xyz += totalEmission;","#ifdef DSPBR","gl_FragColor.xyz /= transToDivide;","#endif","#endif"].join("\n"),A=["vec2 applyUVCombination(in vec2 uv,in mat3 uvtransform){","#ifdef NRE_COMPATIBILITY","#if defined (MAPPING_OPERATOR)","if(mappingTransformSemantic==2){","vec2 T0 = mappingUVTransformation[2].xy;","vec2 Ti = uvtransform[2].xy;","mat2 Ri = mat2(uvtransform);","mat2 R0 = mat2(mappingUVTransformation);","vec2 uv_shifted = uv.xy + T0 +Ti;","return Ri * R0 * uv_shifted;","}else if(mappingTransformSemantic==3){","vec2 T0 = mappingUVTransformation[2].xy;","vec2 Ti = uvtransform[2].xy;","mat2 Ri = mat2(uvtransform);","mat2 R0 = mat2(mappingUVTransformation);","vec2 uv_shifted = uv.xy + T0 +Ti-vec2(0.5,0.5);","return (Ri * R0 * uv_shifted)+vec2(0.5,0.5);","}","#endif","return (uvtransform * vec3(uv,1.0)).xy;","#else","return uv;","#endif","}"].join("\n"),I=["#ifdef NEEDS_UVTOUSE","varying vec2 vUv;","varying vec2 vUv2;","uniform vec2 offsetBumpMap;","uniform vec2 repeatBumpMap;","#endif",e._DefaultShaderChunk.map_pars_vertex,A].join("\n"),R=["#ifdef NEEDS_UVTOUSE","vUv = uv * repeatBumpMap + offsetBumpMap;","#if defined (MAPPING_OPERATOR) && defined(USE_MAPPING_OPERATOR_VERTEX)","#if !defined(USE_TANGENT_BINORMAL)","vUv = applyMappingOperator(uv, position, normal);","#else","vUv = applyMappingOperator(uv, position, normal,tangent,binormal);","#endif","#endif","vUv2 = uv2 * repeatBumpMap + offsetBumpMap;","#if defined (MAPPING_OPERATOR) && defined(USE_MAPPING_OPERATOR_VERTEX)","#if !defined(USE_TANGENT_BINORMAL)","vUv2 = applyMappingOperator(uv2, position, normal);","#else","vUv2 = applyMappingOperator(uv2, position, normal,tangent,binormal);","#endif","#endif","#endif","#if defined(MAPPING_OPERATOR) && !defined(USE_MAPPING_OPERATOR_VERTEX)","localPosition = position;","localNormal = normal;","#endif"].join("\n"),L=["#ifdef NEEDS_UVTOUSE","varying vec2 vUv;","vec2 uvToUse;","varying vec2 vUv2;","vec2 uv2ToUse;","#endif",e._DefaultShaderChunk.map_pars_fragment,A].join("\n"),O=["#ifdef NEEDS_UVTOUSE","uvToUse = vUv;","#ifdef DECAL","uvToUse = dUv;","#endif","#if defined (MAPPING_OPERATOR) && defined(USE_MAPPING_OPERATOR_FRAGMENT)","#ifdef DECAL","if (!decalExplicitUv) {","#if defined(USE_TANGENT_BINORMAL)","uvToUse = applyMappingOperator(uvToUse, dObjectSpacePosition, dObjectSpaceNormal,tangent,binormal);","#else","uvToUse = applyMappingOperator(uvToUse, dObjectSpacePosition, dObjectSpaceNormal);","#endif","} else {","#if defined(USE_TANGENT_BINORMAL)","uvToUse = applyMappingOperator(uvToUse, dObjectSpacePosition, dObjectSpaceNormal, 0, tangent,binormal);","#else","uvToUse = applyMappingOperator(uvToUse, dObjectSpacePosition, dObjectSpaceNormal, 0);","#endif","}","#else","#if defined(USE_TANGENT_BINORMAL)","uvToUse = applyMappingOperator(uvToUse, localPosition, localNormal,tangent,binormal);","#else","uvToUse = applyMappingOperator(uvToUse, localPosition, localNormal);","#endif","#endif","#endif","uv2ToUse = vUv2;","#ifdef DECAL","uv2ToUse = dUv2;","#endif","#if defined (MAPPING_OPERATOR) && defined(USE_MAPPING_OPERATOR_FRAGMENT)","#ifdef DECAL","if (!decalExplicitUv) {","uv2ToUse = applyMappingOperator(uv2ToUse, dObjectSpacePosition, dObjectSpaceNormal);","} else {","uv2ToUse = applyMappingOperator(uv2ToUse, dObjectSpacePosition, dObjectSpaceNormal, 0);","}","#else","uv2ToUse = applyMappingOperator(uv2ToUse, localPosition, localNormal);","#endif","#endif","#elif defined (USE_TANGENT_BINORMAL) && defined (USE_MAPPING_OPERATOR_FRAGMENT) && defined (MAPPING_OPERATOR)","if (mappingType>0){","vec2 bogusUV = applyMappingOperator(vec2(0.0),localPosition, localNormal,tangent,binormal);","}","#endif",,].join("\n"),N=["#ifdef DECAL","varying vec4 positionVS;","varying vec4 positionCS;","#endif"].join("\n"),F=["#ifdef DECAL","positionVS = mvPosition;","positionCS = gl_Position;","#endif"].join("\n"),V=["#ifdef DECAL","uniform sampler2D currentNormalStencilDepth;","uniform sampler2D currentTexCoord;","#ifdef MOBILE_DEVICE_MODE","uniform sampler2D currentRGBADepth;","#endif","uniform bool decalExplicitUv;","uniform mat4 modelViewInvMatrix;","uniform vec2 viewInfo;","uniform float decalStencilValue;","varying vec4 positionVS;","varying vec4 positionCS;","vec3 decodeOct22Normal(in vec2 iEncodedNormal) {","float x = iEncodedNormal.x/2047.0*2.0 - 1.0;","float y = iEncodedNormal.y/2047.0*2.0 - 1.0;","vec3 v = vec3(x, y, 1.0 - abs(x) - abs(y));","if (v.z <= 0.0) {","vec2 sgn = signNotZero(v.xy);","v.xy = - abs(v.yx)*sgn + sgn;","}","return normalize(v);","}","float getEyeDepthPers(in float iZClipSpace)","{","return (2.0 * viewInfo.x * viewInfo.y) / (viewInfo.y + viewInfo.x - iZClipSpace * (viewInfo.y - viewInfo.x));","}","float getEyeDepthOrtho(in float iZClipSpace)","{","return 0.5 * ((viewInfo.y - viewInfo.x) * iZClipSpace + viewInfo.y + viewInfo.x);","}","vec3 noBoxTest(in float depth, out vec2 dUv, out vec3 dObjectSpacePosition) {","vec4 nMVPosition;","if (projectionMatrix[3][3] > 0.5) {","float viewDepth = getEyeDepthOrtho(2.0*depth-1.0);","vec3 viewRay = vec3(0.0, 0.0, -1.0);","vec3 origin = vec3(positionVS.xy, 0.0);","nMVPosition = vec4(origin + viewRay * viewDepth,1.0);","} else {","float viewDepth = getEyeDepthPers(2.0*depth-1.0);","vec3 viewRay = (positionVS.xyz  / -positionVS.z);","nMVPosition = vec4(viewRay * viewDepth,1.0);","}","vec4 pos = (modelViewInvMatrix * nMVPosition);","dObjectSpacePosition = pos.xyz;","pos.xyz /= pos.w;","dUv = pos.xy + 0.5;","if (any(greaterThan(abs(pos.xyz), vec3(.5)))){","discard;","}","#ifdef USE_SHADOWMAP","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = computeShadowCoord(pos.xyz, shadowMatrix[i],shadowCameraPosition[i],lowPartShadowCameraPosition[i]);","}","#endif","float depthToUse = depth;","float dDecalx = dFdx (depthToUse);","float dDecaly = dFdy (depthToUse);","#ifdef MOBILE_DEVICE_MODE","depthToUse -= 4.0 * (sqrt(dDecalx*dDecalx + dDecaly*dDecaly) + DEPTH_PRECISION);","#else","depthToUse -= 2.0 * (sqrt(dDecalx*dDecalx + dDecaly*dDecaly) + DEPTH_PRECISION);","#endif","gl_FragDepthEXT = depthToUse;","return -nMVPosition.xyz;","}","#endif"].join("\n"),U=["#ifdef DECAL","vec2 screenPos = positionCS.xy/positionCS.w;","vec2 decalFetchUv = 0.5*vec2(screenPos.x, screenPos.y) + 0.5;","vec4 normalStencilDepthValue = texture2D(currentNormalStencilDepth, decalFetchUv);","if (floor(normalStencilDepthValue.z + 0.5) - decalStencilValue < 0.0) {","discard;","}","vec3 decalNormal = decodeOct22Normal(normalStencilDepthValue.xy);","vec3 dObjectSpaceNormal = normalize((modelViewInvMatrix * vec4(decalNormal, 0.0)).xyz);","vec2 dUv;","vec3 dObjectSpacePosition;","float decalDepth = normalStencilDepthValue.w;","#ifdef MOBILE_DEVICE_MODE","decalDepth = unpackRGBA(texture2D(currentRGBADepth, decalFetchUv));","#endif","vec3 dViewPosition = noBoxTest(decalDepth, dUv,dObjectSpacePosition);","vec2 dUv2 = dUv;","if (decalExplicitUv) {","vec4 currentTexCoordsFetch = texture2D(currentTexCoord, decalFetchUv);","dUv = currentTexCoordsFetch.xy;","dUv2 = currentTexCoordsFetch.zw;","}","vec3 dWorldPosition = (modelMatrix * vec4(dObjectSpacePosition,1.0)).xyz;","#ifdef USE_SHADOWMAP_CUBE","decalShadowCubeWorldPosition = dWorldPosition;","#endif","#ifdef DEBUG_DECAL","gl_FragColor.rgba = vec4(1.0, 0.0, 0.0, 0.5);","return;","#endif","#endif"].join("\n"),B=["#if defined(USE_DISPLACEMENTMAP)","uniform sampler2D displacementMap;","uniform vec2 displacementMapSize;","uniform float displacementRadius;","uniform mat3 displacementUvTransform;","uniform int displacementUvSlot;","#define DIS_INCLUDE_DIAGONALS","struct DisplacementData","{","vec3 normal;","vec3 tangent;","vec3 binormal;","};","DisplacementData displacementData;","vec3 vNormalize( vec3 val )","{","float len = length(val);","if ( len < 1e-6) {","return vec3(0.0);","}","return val/len;","}","#ifdef SPECGLOSS","uniform float displacementBias;","uniform float displacementScale;","vec3 ComputeDisplacedPosition(in vec2 displacementUV, in vec3 position) {","#ifdef MAPPING_OPERATOR","displacementUV = applyMappingOperator(displacementUV, position, displacementData.normal,displacementData.tangent,displacementData.binormal);","#endif","displacementUV = applyUVCombination(displacementUV,displacementUvTransform);","vec3 dv = 2.0 * texture2D( displacementMap, displacementUV ).xyz - 1.0;","float df = displacementScale * dv.x + displacementBias;","return position + normalize(displacementData.normal) * df;","}","#else","#ifdef USE_DISPLACEMENT_COEFFICIENTS","uniform vec3 displacementAddCoef;","uniform vec3 displacementMulCoef;","#endif","vec3 ComputeDisplacedPosition(in vec2 displacementUV, in vec3 position) {","#ifdef MAPPING_OPERATOR","displacementUV = applyMappingOperator(displacementUV, position, displacementData.normal,displacementData.tangent,displacementData.binormal);","#endif","displacementUV = applyUVCombination(displacementUV,displacementUvTransform);","vec3 dv = 2.0 * texture2D( displacementMap, displacementUV ).xyz - 1.0;","#ifdef USE_DISPLACEMENT_COEFFICIENTS","dv = displacementMulCoef * dv + displacementAddCoef;","#endif","vec3 df = normalize(displacementData.normal) * dv.z + normalize(displacementData.tangent) * dv.x + normalize(displacementData.binormal) * dv.y;","return position + df;","}","#endif","vec3 ComputeDisplacedNormal(in vec2 displacementUV, in vec3 displacedPosition, in vec3 position) {","float displacementDelta = length(displacedPosition - position);","if (displacementDelta <= 1e-3) {","return normal;","}","vec2 uvOffsetFactor = 1.25 / displacementMapSize;","float objectOffsetFactor = 0.00872664625 * displacementRadius / max(max(length(displacementUvTransform[0]),length(displacementUvTransform[1])), 1.0);","vec3 t = displacementData.tangent * objectOffsetFactor;","vec3 b = displacementData.binormal * objectOffsetFactor;","vec3 A = vNormalize(ComputeDisplacedPosition(displacementUV + uvOffsetFactor * vec2(1.0,0.0) , position + t    ) - displacedPosition);","vec3 C = vNormalize(ComputeDisplacedPosition(displacementUV + uvOffsetFactor * vec2(0.0,1.0) , position     + b) - displacedPosition);","vec3 E = vNormalize(ComputeDisplacedPosition(displacementUV + uvOffsetFactor * vec2(-1.0,0.0), position - t    ) - displacedPosition);","vec3 G = vNormalize(ComputeDisplacedPosition(displacementUV + uvOffsetFactor * vec2(0.0,-1.0), position     - b) - displacedPosition);","#ifdef DIS_INCLUDE_DIAGONALS","vec3 B = vNormalize(ComputeDisplacedPosition(displacementUV + uvOffsetFactor * vec2(1.0,1.0)  , position + t + b) - displacedPosition);","vec3 D = vNormalize(ComputeDisplacedPosition(displacementUV + uvOffsetFactor * vec2(-1.0,1.0) , position - t + b) - displacedPosition);","vec3 F = vNormalize(ComputeDisplacedPosition(displacementUV + uvOffsetFactor * vec2(-1.0,-1.0), position - t - b) - displacedPosition);","vec3 H = vNormalize(ComputeDisplacedPosition(displacementUV + uvOffsetFactor * vec2(1.0,-1.0) , position + t - b) - displacedPosition);","vec3 displacedNormal = cross(A, B) + cross(B, C) + cross(C, D) + cross(D,E)+ cross(E,F)+ cross(F,G)+ cross(G,H)+ cross(H,A);","#else","vec3 displacedNormal = cross(A, C) + cross(C, E) + cross(E, G) + cross(G,A);","#endif","float dotNdN = dot(displacedNormal, displacementData.normal);","return vNormalize((sign(dotNdN) + 1e-2)* displacedNormal);","}","#endif"].join("\n"),k=["#if defined(USE_DISPLACEMENTMAP)","displacementData.tangent = objectTangent.xyz;","displacementData.binormal = objectBinormal.xyz;","vec2 displacementUv = displacementUvSlot == 1 ? uv : uv2;","#ifdef USE_SKINNING","displacementData.normal = skinnedNormal.xyz;","vec3 displacedPosition = ComputeDisplacedPosition(displacementUv, skinned.xyz);","vec3 displacedNormal = ComputeDisplacedNormal(displacedPosition, skinned.xyz);","#else","displacementData.normal = normal.xyz;","vec3 displacedPosition = ComputeDisplacedPosition(displacementUv, position.xyz);","vec3 displacedNormal = ComputeDisplacedNormal(displacementUv, displacedPosition, position.xyz);","#endif","#endif"].join("\n"),G=function(t,i){t[i+"UvTransform"]={type:"m3",value:new e.Matrix3},t[i+"AddCoef"]={type:"f",value:0},t[i+"MulCoef"]={type:"f",value:1},t[i+"Map"]={type:"t",value:null},t[i+"UvSlot"]={type:"i",value:1}},z=function(e,t){e[t]={type:"f",value:1},G(e,t)},H=function(t,i){t[i+"UvTransform"]={type:"m3",value:new e.Matrix3},t[i+"AddCoef"]={type:"v3",value:new e.Vector3},t[i+"MulCoef"]={type:"v3",value:new e.Vector3},t[i+"Map"]={type:"t",value:null},t[i+"UvSlot"]={type:"i",value:1}},W=function(t,i){t[i]={type:"c",value:new e.Color(16777215)},H(t,i)},j={reflectionColorTexture:{type:"t",value:null},refractionColorTexture:{type:"t",value:null},invScreenSize:{type:"v2",value:new e.Vector2},diffuseUvTransform:{type:"m3",value:new e.Matrix3},diffuseUvSlot:{type:"i",value:1},diffuseMulCoef:{type:"v3",value:new e.Vector3},diffuseAddCoef:{type:"v3",value:new e.Vector3},diffuseBorderColor:{type:"v4",value:new e.Vector4},_colorOverride:{type:"i",value:0},emissionValue:{type:"f",value:0},bumpUvTransform:{type:"m3",value:new e.Matrix3},bumpUvSlot:{type:"i",value:1},ior:{type:"f",value:1.4},iridescenceIoR:{type:"f",value:1},glossinessMap:{type:"t",value:null},glossinessMulCoef:{type:"f",value:1},glossinessAddCoef:{type:"f",value:0},displacementMapSize:{type:"v2",value:new e.Vector2},displacementBias:{type:"f",value:0},displacementScale:{type:"f",value:0},reflectionProbe:{type:"t",value:null},reflectionProbeMips:{type:"t",value:null},reflectionProbeProxyMin:{type:"v3",value:new e.Vector3},reflectionProbeProxyMax:{type:"v3",value:new e.Vector3},reflectionProbePos:{type:"v3",value:new e.Vector3},envMapSheen:{type:"t",value:null},flakesBump:{type:"f",value:0},flakesDensity:{type:"f",value:0},flakesScale:{type:"f",value:0},pearlFlakesColor:{type:"c",value:new e.Color(0)},pearlFlakesDensity:{type:"f",value:0},pearlFlakesBump:{type:"f",value:0},pearlFlakesColorMulCoef:{type:"v3",value:new e.Vector3},pearlFlakesColorAddCoef:{type:"v3",value:new e.Vector3},sphereCenter:{type:"v3",value:new e.Vector3},projectionCenter:{type:"v3",value:new e.Vector3},sphereRadius:{type:"f",value:0},coatingGlossinessMap:{type:"t",value:null},coatingGlossinessMulCoef:{type:"f",value:1},coatingGlossinessAddCoef:{type:"f",value:0},clearCoatNormalScale:{type:"f",value:1},orangePeelScale:{type:"f",value:0},precomputedTexture:{type:"t",value:null},envMap2:{type:"t",value:null},sssLUT:{type:"t",value:null},absorptionCoefficients:{type:"v3",value:new e.Vector3},maxTranslucencyDepth:{type:"v3",value:new e.Vector3}};H(j,"normal"),H(j,"displacement"),H(j,"clearCoatNormal"),G(j,"normalScale"),z(j,"thickness"),W(j,"specular"),z(j,"bumpScale"),z(j,"metalness"),z(j,"specularContrib"),W(j,"emissionColor"),z(j,"transparency"),z(j,"opacity"),j.opacityBorderValue={type:"f",value:0},z(j,"roughness"),z(j,"anisotropy"),z(j,"anisotropyAngle"),z(j,"sheen"),z(j,"sheenRoughness"),W(j,"sheenColor"),W(j,"flakesColor"),z(j,"flakesSize"),z(j,"flakesCoverage"),z(j,"flakesRoughness"),z(j,"flipFlop"),W(j,"flipFlopColor"),z(j,"clearCoat"),z(j,"clearCoatRoughness"),W(j,"clearCoatColor"),z(j,"translucency"),W(j,"translucencyColor"),z(j,"iridescence"),z(j,"iridescenceThickness");var X=t.prototype.deferrable,q=function(t){return["#define PHYSICALDS",e._DefaultShaderChunk.normal_viewposition_pars_vertex,e.ShaderChunk.color_pars_vertex,e.ShaderChunk.clip_pars_vertex,I,B,t?e.ShaderChunk.envmap_pars_vertex:"",n,t?e.ShaderChunk.shadowmap_pars_vertex:"",e.ShaderChunk.tangent_Binormal_pars,e.ShaderChunk.skinning_pars_vertex,e.ShaderChunk.fog_pars_vertex,e.DeferredShaderChunk.oit_pars_vertex,!t&&X?e.DeferredShaderChunk.depth_pars_vertex:"",!t&&X?e.DeferredShaderChunk.picking_pars_vertex:"",!t&&X?e.DeferredShaderChunk.picking_instancing_pars_vertex:"",!t&&X?e.DeferredShaderChunk.highlight_pars_vertex:"",!t&&X?e.DeferredShaderChunk.texcoord_pars_vertex:"",N,"void main() {",e.ShaderChunk.PDSFX_start_vertex,e.ShaderChunk.color_vertex,e.ShaderChunk.skinbase_vertex,e.ShaderChunk.skinnormal_vertex,e.ShaderChunk.skinning_vertex,R,e.ShaderChunk.tangent_Binormal_vertex,k,e.ShaderChunk.default_vertex_with_normal,e.ShaderChunk.defaultnormal_vertex,F,e.ShaderChunk.clip_vertex,e.ShaderChunk.fog_vertex,e._DefaultShaderChunk.normal_viewposition_vertex,e.ShaderChunk.worldpos_vertex,t?e.ShaderChunk.envmap_vertex:"",a,t?e.ShaderChunk.shadowmap_vertex:"",e.DeferredShaderChunk.oit_vertex,!t&&X?e.DeferredShaderChunk.depth_vertex:"",!t&&X?e.DeferredShaderChunk.picking_vertex:"",!t&&X?e.DeferredShaderChunk.picking_instancing_vertex:"",!t&&X?e.DeferredShaderChunk.highlight_vertex:"",!t&&X?e.DeferredShaderChunk.texcoord_vertex:"",e.ShaderChunk.PDSFX_end_vertex,"}"].join("\n")},Z=function(t){return["#define PHYSICALDS","#define ROUGHNESS_CLAMP_MIN 0.025","#define ROUGHNESS_CLAMP_MAX 0.975","#ifdef MOBILE_DEVICE_MODE","#define GEOMETRIC_FAST","#endif","#if defined(USE_SPECGLOSS_FLAKES) || defined(USE_DSPBR_FLAKES) ||defined(USE_ORANGE_PEEL) ","#define NEED_OBJECT_SPACE_DATA","#endif","#if defined(USE_LIGHTING)","#if defined(SSLREFRACTION_ENABLED) && !defined(SKIP_TRANSPAR)","#define USE_SSLREFRACTION","#endif","#if defined(SSLREFLECTION_ENABLED)","#define USE_SSLREFLECTION","#endif","#endif","#if !defined(GL_OES_standard_derivatives) && !defined(GLSL300ES)","#if defined(USE_DSPBR_FLAKES)","#undef USE_DSPBR_FLAKES","#endif","#endif","#if !defined(DSPBR19x) && !defined(SPECGLOSS)","#define DSPBR_WITH_TRANSLUCENCY","#define DSPBR_WITH_CLEAR_COAT_ABOVE_EMISSIVE","#define DSPBR_WITH_SHEEN_COLOR_ROUGHNESS","#endif","#if !defined(DSPBR19x) && !defined(SPECGLOSS) && !defined(DSPBR21x)","#ifdef USE_FLIPFLOP","#define DSPBR_WITH_FLIPFLOP_COLOR","#endif","#ifdef USE_SOFT_VELVET","#define DSPBR_WITH_SQUARED_ESTEVEZKULLA_ROUGHNESS","#endif","#define DSPBR_WITH_NO_SHEEN_VALUE","#endif","#if !defined(DSPBR19x) && !defined(SPECGLOSS) && !defined(DSPBR21x) && !defined(DSPBR22x)","#define DSPBR_WITH_TRANSLUCENCY_COLOR","#endif","struct matData","{","float roughness;","float transparency;","float metalness;","vec3 diffuseColor;","vec3 transparentColor;","float specularContribution;","vec3 specularTint;","vec3 specularBlendingSR0;","vec3 sr0Color;","vec3 sr90Color;","float ior;","float adjustedIoR;","float F0;","#ifdef DSPBR","vec3 specularEnergyConservationConstant;","float diffuseEnergyConservationConstant;","#endif","#ifdef DSPBR_WITH_TRANSLUCENCY","float translucency;","vec3 translucencyColor;","#endif","#ifdef USE_IRIDESCENCE","float iridescence;","float iridescenceIoR;","float iridescenceThickness;","vec3 iridescenceSR0Color;","#endif","#ifdef USE_ANISOTROPY","float anisotropy;","float anisotropyAngle;","#endif","#ifdef USE_SHEEN","float sheen;","#ifdef DSPBR_WITH_SHEEN_COLOR_ROUGHNESS","float sheenRoughness;","vec3 sheenColor;","float sheenEnergyConservationConstant;","#endif","#endif","#ifdef CLEAR_COAT","float clearCoat;","float clearCoatRoughness;","vec3 clearCoatSR0Color;","vec3 clearCoatSR90Color;","#endif","#ifdef USE_SUBSURFACE","vec3 scatteringColor;","#ifdef USE_THICKNESS","vec3 transmittanceColor;","#endif","#endif","};","struct surfData","{","vec3 viewNormal;","vec3 worldNormal;","vec3 view;","vec3 worldPosition;","vec3 viewPosition;","#ifdef NEED_OBJECT_SPACE_DATA","vec3 objectSpacePosition;","vec3 objectSpaceNormal;","#endif","#ifdef USE_ANISOTROPY","vec3 tangent;","vec3 binormal;","#endif","#ifdef CLEAR_COAT","vec3 clearCoatNormal;","vec3 clearCoatWorldNormal;","#endif","#ifdef USE_SUBSURFACE","float curvature;","#endif","#ifdef USE_SPECULAR_AA","mat3 TBNMatrixForSpecularAA;","vec3 TForSpecularAA;","vec3 BForSpecularAA;","#endif","#if defined(USE_THICKNESS)","float thickness;","#endif","};","#ifdef TEXTURE_BLENDING","#if TEXTURE_BLENDING == 1","#define TEXTURE_MODULATE","#endif","#if TEXTURE_BLENDING == 2","#define TEXTURE_BLEND","#endif","#if TEXTURE_BLENDING == 0","#define TEXTURE_DECAL","#endif","#if TEXTURE_BLENDING == 3","#define TEXTURE_REPLACE",t?"":"#define TEXTURE_REPLACE_CONTINUE","#endif","#if TEXTURE_BLENDING == 4","#define TEXTURE_IGNORE","#endif","#if TEXTURE_BLENDING == 5","#define TEXTURE_DEFAULT","#endif","#else","#define TEXTURE_DEFAULT","#endif","matData materialData;","surfData surfaceData;","vec2 hdrSize;","vec2 hdrTexelSize;","vec2 mipsSize;","vec2 mipsTexelSize;","vec3 luminanceVector = vec3(0.299, 0.587, 0.114);","varying vec3 vWorldPosition;",e._DefaultShaderChunk.normal_viewposition_pars_fragment,e.ShaderChunk.color_pars_fragment,e.ShaderChunk.clip_pars_fragment,L,"#ifdef USE_MAP","uniform sampler2D map;","#endif",t?e.ShaderChunk.envmap_pars_fragment:"","#ifndef USE_ENVMAP","const float PI = 3.14159265359;","const float INV_PI = 0.31830988618;","#endif",e.ShaderChunk.tangent_Binormal_pars_fragment,t?e.ShaderChunk.shadowmap_pars_fragment:"",s,t?o:"",function(e){var t,i,r=function(e,t){return["uniform "+e+" "+t+"MulCoef;","uniform "+e+" "+t+"AddCoef;"].join("\n")},n=function(e){return r("vec3",e)},a=function(e){return r("float",e)},s=["#ifdef USE_DIFFUSE_COEFFICIENTS",n("diffuse"),"#endif","#ifdef USE_SPECULAR_COEFFICIENTS",n("specular"),"#endif","#ifdef USE_METALNESS_COEFFICIENTS",a("metalness"),"#endif","#ifdef USE_SPECULARCONTRIB_COEFFICIENTS",a("specularContrib"),"#endif","#ifdef USE_EMISSIONCOLOR_COEFFICIENTS",n("emissionColor"),"#endif","#if defined(USE_NORMAL_COEFFICIENTS) && defined(DSPBR)",n("normal"),"#endif","#ifdef USE_TRANSPARENCY_COEFFICIENTS",a("transparency"),"#endif","#ifdef USE_OPACITY_COEFFICIENTS",a("opacity"),"#endif","#if defined(USE_TRANSLUCENCY_COEFFICIENTS) && defined(DSPBR_WITH_TRANSLUCENCY)",a("translucency"),"#endif","#if defined(USE_TRANSLUCENCY_COLOR_COEFFICIENTS) && defined(DSPBR_WITH_TRANSLUCENCY_COLOR)",n("translucencyColor"),"#endif","#if defined(USE_IRIDESCENCE_COEFFICIENTS)",a("iridescence"),"#endif","#if defined(USE_IRIDESCENCE_THICKNESS_COEFFICIENTS)",a("iridescenceThickness"),"#endif","#ifdef USE_ROUGHNESS_COEFFICIENTS",a("roughness"),"#endif","#ifdef USE_GLOSSINESS_COEFFICIENTS",a("glossiness"),"#endif","#ifdef USE_ANISOTROPY_COEFFICIENTS",a("anisotropy"),"#endif","#ifdef USE_ANISOTROPYANGLE_COEFFICIENTS",a("anisotropyAngle"),"#endif","#ifdef USE_CC_COEFFICIENTS",a("clearCoat"),"#endif","#if defined(USE_CC_NORMAL_COEFFICIENTS) && defined(DSPBR)",n("clearCoatNormal"),"#endif","#if defined(USE_CC_COLOR_COEFFICIENTS) && defined(SPECGLOSS)",n("clearCoatColor"),"#endif","#ifdef USE_CC_ROUGHNESS_COEFFICIENTS",a("clearCoatRoughness"),"#endif","#ifdef USE_CC_GLOSSINESS_COEFFICIENTS",a("coatingGlossiness"),"#endif","#if defined(USE_SHEEN_COEFFICIENTS) && !defined(DSPBR_WITH_NO_SHEEN_VALUE)",a("sheen"),"#endif","#if defined(USE_SHEEN_COLOR_COEFFICIENTS) && defined(DSPBR_WITH_SHEEN_COLOR_ROUGHNESS)",n("sheenColor"),"#endif","#if defined(USE_SHEEN_ROUGHNESS_COEFFICIENTS) && defined(DSPBR_WITH_SHEEN_COLOR_ROUGHNESS)",a("sheenRoughness"),"#endif","#ifdef USE_DSPBR_FLAKES","#ifdef USE_FLAKESCOLOR_COEFFICIENTS",n("flakesColor"),"#endif","#endif","#ifdef USE_FLAKESSIZE_COEFFICIENTS",a("flakesSize"),"#endif","#ifdef USE_FLAKESCOVERAGE_COEFFICIENTS",a("flakesCoverage"),"#endif","#ifdef USE_FLAKESROUGHNESS_COEFFICIENTS",a("flakesRoughness"),"#endif","#if defined(USE_NORMALSCALE_COEFFICIENTS) && defined(SPECGLOSS)",a("normalScale"),"#endif","#if defined(USE_BUMPSCALE_COEFFICIENTS) && defined(SPECGLOSS)",a("bumpScale"),"#endif","#if defined(USE_THICKNESS_COEFFICIENTS)",a("thickness"),"#endif","#ifdef DSPBR_WITH_FLIPFLOP_COLOR","#ifdef USE_FLIPFLOP_COLOR_COEFFICIENTS",n("flipFlopColor"),"#endif","#ifdef USE_FLIPFLOP_COEFFICIENTS",a("flipFlop"),"#endif","#endif"].join("\n"),o=["#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_DIR_IBL_LIGHTS > 0 && defined(USE_ENVMAP) && defined(USE_SUBSURFACE)","uniform vec3 directionalIBLLightColor[ MAX_DIR_IBL_LIGHTS ];","uniform vec3 directionalIBLLightDirection[ MAX_DIR_IBL_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform int pointLightPhysicalAttenuation[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#else","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#endif","#if MAX_IES_LIGHTS > 0","uniform vec3 iesLightColor[ MAX_IES_LIGHTS ];","uniform sampler2D iesLightTexture[ MAX_IES_LIGHTS ];","uniform mat4 matrixWorldInv[MAX_IES_LIGHTS];","#ifdef PHONG_PER_PIXEL","uniform vec3 iesLightPosition[ MAX_IES_LIGHTS ];","uniform float iesLightDistance[ MAX_IES_LIGHTS ];","#else","varying vec4 viesLight[ MAX_IES_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightInnerAngleCos[ MAX_SPOT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform int spotLightPhysicalAttenuation[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#else","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPHERE_LIGHTS > 0","uniform vec3 sphereLightColor[ MAX_SPHERE_LIGHTS ];","uniform vec3 sphereLightPosition[ MAX_SPHERE_LIGHTS ];","uniform vec3 sphereLightData[ MAX_SPHERE_LIGHTS ];","#endif","#if MAX_DISK_LIGHTS > 0","uniform vec3 diskLightColor[ MAX_DISK_LIGHTS ];","uniform vec3 diskLightPosition[ MAX_DISK_LIGHTS ];","uniform vec3 diskLightNormal[ MAX_DISK_LIGHTS ];","uniform vec3 diskLightUp[ MAX_DISK_LIGHTS ];","uniform vec3 diskLightData[ MAX_DISK_LIGHTS ];","#endif","#if MAX_AREA_LIGHTS > 0","uniform vec3 areaLightColor[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightPosition[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightNormal[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightUp[ MAX_AREA_LIGHTS ];","uniform vec3 areaLightData[ MAX_AREA_LIGHTS ];","#endif","#if MAX_TUBE_LIGHTS > 0","uniform vec3 tubeLightColor[ MAX_TUBE_LIGHTS ];","uniform vec3 tubeLightPosition[ MAX_TUBE_LIGHTS ];","uniform vec3 tubeLightRight[ MAX_TUBE_LIGHTS ];","uniform vec3 tubeLightData[ MAX_TUBE_LIGHTS ];","#endif","#if MAX_TUBE_LIGHTS > 0 || MAX_AREA_LIGHTS > 0 || MAX_DISK_LIGHTS > 0 || MAX_SPHERE_LIGHTS > 0","#define HAS_AREA_LIGHTS","#endif","#ifdef HAS_AREA_LIGHTS","uniform sampler2D precomputedAreaGGX1texture;","uniform sampler2D precomputedAreaGGX2texture;","#ifdef USE_SHEEN","#if defined(USE_VELVET)","uniform sampler2D precomputedAreaAshikmintexture;","#endif","#if defined(USE_SOFT_VELVET)","uniform sampler2D precomputedAreaEsteveztexture;","#endif","#if defined(USE_SATIN)","uniform sampler2D precomputedAreaBeckmanntexture;","#endif","#endif","#endif","#ifdef USE_LIGHTMAP","uniform sampler2D lightMap;","uniform mat3 lightMapUvTransform;","uniform int lightMapUvSlot;","#endif","uniform vec3 ambientLightColor;"].join("\n"),l=function(e,t,i){return["uniform "+e+" "+t+";","#ifdef "+i,"uniform sampler2D "+t+"Map;","uniform mat3 "+t+"UvTransform;","uniform int "+t+"UvSlot;","#endif"].join("\n")},c=function(e,t){return l("vec3",e,t)},h=function(e,t){return l("float",e,t)};t=[e?o:"",["uniform vec3 diffuse;","#ifdef USE_MAP","uniform mat3 diffuseUvTransform;","uniform int _colorOverride;","uniform int diffuseUvSlot;","#if defined(USE_DIFFUSEMAP_BORDER_COLOR_U) || defined(USE_DIFFUSEMAP_BORDER_COLOR_V)","uniform vec4 diffuseBorderColor;","#endif","#endif",c("specular","USE_SPECULARMAP"),c("emissionColor","USE_EMISSIONCOLORMAP"),"uniform float emissionValue;",h("transparency","USE_TRANSPARENCYMAP"),h("opacity","USE_OPACITYMAP"),"#if defined(USE_OPACITYMAP_BORDER_COLOR_U) || defined(USE_OPACITYMAP_BORDER_COLOR_V)","uniform float opacityBorderValue;","#endif",h("metalness","USE_METALNESSMAP"),h("specularContrib","USE_SPECULARCONTRIBMAP"),"uniform float ior;","uniform float roughness;","#ifdef USE_ROUGHNESSMAP","uniform sampler2D roughnessMap;","#endif","#ifdef USE_GLOSSINESSMAP","uniform sampler2D glossinessMap;","#endif","#if defined(USE_ROUGHNESSMAP) || defined(USE_GLOSSINESSMAP)","uniform mat3 roughnessUvTransform;","uniform int roughnessUvSlot;","#endif","#ifdef USE_ANISOTROPY",h("anisotropy","USE_ANISOTROPYMAP"),h("anisotropyAngle","USE_ANISOTROPYANGLEMAP"),"#endif","#ifdef USE_SHEEN","#ifndef DSPBR_WITH_NO_SHEEN_VALUE",h("sheen","USE_SHEEN_MAP"),"#endif","#ifdef DSPBR_WITH_SHEEN_COLOR_ROUGHNESS",h("sheenRoughness","USE_SHEEN_ROUGHNESS_MAP"),c("sheenColor","USE_SHEEN_COLOR_MAP"),"#endif","#ifdef USE_ENVMAP_SHEEN","uniform sampler2D envMapSheen;","#endif","#endif","#ifdef CLEAR_COAT",h("clearCoat","CLEAR_COAT_MAP"),"#ifdef CLEAR_COAT_NORMALMAP","uniform sampler2D clearCoatNormalMap;","uniform mat3 clearCoatNormalUvTransform;","uniform int clearCoatNormalUvSlot;","#endif","#ifdef SPECGLOSS","uniform float clearCoatNormalScale;",c("clearCoatColor","CLEAR_COAT_COLORMAP"),"#endif","uniform float clearCoatRoughness;","#ifdef USE_CC_ROUGHNESSMAP","uniform sampler2D clearCoatRoughnessMap;","#endif","#ifdef USE_CC_GLOSSINESSMAP","uniform sampler2D coatingGlossinessMap;","#endif","#if defined(USE_CC_ROUGHNESSMAP) || defined(USE_CC_GLOSSINESSMAP)","uniform mat3 clearCoatRoughnessUvTransform;","uniform int clearCoatRoughnessUvSlot;","#endif","#ifdef USE_ORANGE_PEEL","uniform float orangePeelScale;","#endif","#endif","#ifdef USE_SPECGLOSS_FLAKES","uniform vec3 flakesColor;","uniform float flakesDensity;","uniform float flakesBump;","uniform vec3 flakesColorMulCoef;","uniform vec3 flakesColorAddCoef;","uniform vec3 pearlFlakesColor;","uniform float pearlFlakesDensity;","uniform float pearlFlakesBump;","uniform vec3 pearlFlakesColorMulCoef;","uniform vec3 pearlFlakesColorAddCoef;","uniform float flakesRoughness;","uniform float flakesScale;","#endif","#ifdef USE_DSPBR_FLAKES",c("flakesColor","USE_FLAKESCOLOR_MAP"),h("flakesCoverage","USE_FLAKESCOVERAGE_MAP"),h("flakesRoughness","USE_FLAKESROUGHNESS_MAP"),h("flakesSize","USE_FLAKESSIZE_MAP"),"#ifdef DSPBR_WITH_FLIPFLOP_COLOR",c("flipFlopColor","USE_FLIPFLOP_COLOR_MAP"),h("flipFlop","USE_FLIPFLOP_MAP"),"#endif","#endif","#ifdef SPECGLOSS","#ifdef USE_NORMALSCALEMAP","uniform sampler2D normalScaleMap;","uniform mat3 normalScaleUvTransform;","uniform int normalScaleUvSlot;","#endif","#ifdef USE_BUMPSCALEMAP","uniform sampler2D bumpScaleMap;","uniform mat3 bumpScaleUvTransform;","uniform int bumpScaleUvSlot;","#endif","#ifdef USE_BUMPMAP","uniform mat3 bumpUvTransform;","uniform int bumpUvSlot;","#endif","#endif","#ifdef DSPBR_WITH_TRANSLUCENCY",h("translucency","USE_TRANSLUCENCYMAP"),"#endif","#ifdef DSPBR_WITH_TRANSLUCENCY_COLOR",c("translucencyColor","USE_TRANSLUCENCY_COLOR_MAP"),"#endif","#ifdef USE_IRIDESCENCE","uniform float iridescenceIoR;",h("iridescence","USE_IRIDESCENCE_MAP"),h("iridescenceThickness","USE_IRIDESCENCE_THICKNESS_MAP"),"#endif","#ifdef USE_SUBSURFACE","#ifdef USE_SSSLUT","uniform vec3 maxTranslucencyDepth;","uniform sampler2D sssLUT;","#else","uniform vec3 absorptionCoefficients;","#endif","#endif","#ifdef USE_THICKNESS",h("thickness","USE_THICKNESSMAP"),"#endif","#ifdef USE_NORMALMAP","uniform mat3 normalUvTransform;","uniform int normalUvSlot;","#endif"].join("\n"),s,"#if defined(NEED_OBJECT_SPACE_DATA)","varying vec3 vObjectSpacePosition;","varying vec3 vObjectSpaceNormal;","#endif"].join("\n");var u=["vec3 FresnelSchlick(vec3 iSr0Color, float ctheta) {","float Fc = pow(1.0 - ctheta, 5.0);","return Fc + (1.0 - Fc) * iSr0Color;","}","vec3 FresnelSchlick(in vec3 iSr0Color, in vec3 iSr90Color, in float ctheta) {","float power = pow5(1.0 - ctheta);","return  mix(iSr0Color, iSr90Color, power);","}","float FresnelSchlick(in float iSr0Color, in float iSr90Color, in float ctheta) {","float power = pow5(1.0 - ctheta);","return  mix(iSr0Color, iSr90Color, power);","}","vec2 FresnelSchlick(in float ctheta) {","float power = pow5(1. - ctheta);","return vec2((1.0-power),power);","}","vec3 F0FromFresnelSchlick(in vec3 iFresnel, const vec3 iSr90Color, in float ctheta) {","float power = pow5(1.0 - ctheta);","power = clamp(power, 0.0, 1.0 - 1e-6);","return (iFresnel - iSr90Color * power) / (1.0 - power);","}","float SpecGlossEnergyConservationTerm(in float NoL, in float NoV, in vec3 iSr0Color, in vec3 iSr90Color) {","#ifdef SPECGLOSS_NRE","return 1.0 - dot(FresnelSchlick(iSr0Color, iSr90Color, NoL), luminanceVector);","#else","return 1.0 - vMax(max(FresnelSchlick(iSr0Color, iSr90Color, NoL), FresnelSchlick(iSr0Color, iSr90Color, NoV)));","#endif","}","float SpecGlossEnergyConservationTerm(in vec3 fresnel) {","return 1.0 - dot(fresnel, luminanceVector);","}","#ifndef GEOMETRIC_FAST","float GeometricLambda(float a2, float cosTheta) {","return sqrt(1.0 - a2 + a2/max(cosTheta * cosTheta, 1e-6));","}","float GeometricSchlick(float roughness, float NoV, float NoL) {","#ifdef PBR_FROM_GAS","float a2 = 0.01336336;","#else","float a = roughness * roughness;","float a2 = a * a;","#endif","return 2.0 / (GeometricLambda(a2, NoL) + GeometricLambda(a2, NoV));","}","#else","float GeometricLambda(float a, float cosTheta) {","return 1.0 - a + a/max(cosTheta, 1e-6);","}","float GeometricSchlick(float roughness, float NoV, float NoL) {","#ifdef PBR_FROM_GAS","float a = 0.1156;","#else","float a = roughness * roughness;","#endif","return 2.0 / (GeometricLambda(a, NoL) + GeometricLambda(a, NoV));","}","#endif","float GGXVisibility(float roughness, float NoV, float NoL) {","float factor = 0.25 / max(abs(NoL * NoV), 1e-3);","return factor * GeometricSchlick(roughness, NoV, NoL);","}","float DistributionGGX(float roughness, float NoH) {","#ifdef PBR_FROM_GAS","float alpha2 = 0.01336336;","#else","float alpha = roughness * roughness;","float alpha2 = alpha * alpha;","#endif","float NoH2 = NoH * NoH;","float d = max((alpha2 - 1.0) * NoH2 + 1.0, 1e-6);","return alpha2* INV_PI / (d * d);","}","#ifdef DSPBR","float DirectionalMultipleAlbedo(in float cosTheta, in float roughness) {","float a2 = pow4(roughness);","float res = 3.09507 + cosTheta * (-9.11369 + cosTheta * (15.8884 + cosTheta * (-13.70343 + 4.51786 * cosTheta)));","res *= (-0.20277 + a2 * (2.772 + a2 * (-2.6175 + 0.73343*a2)));","res *= 1.4594 * a2 * cosTheta;","return 1.0  - res;","}","float AverageDirectionalMultipleAlbedo(in float roughness) {","float a2 = pow4(roughness);","return 1.0 + a2 * (-0.133 + a2 * (-1.8695 + a2 * (2.2268 - 0.83397*a2)));","}","vec3 AverageMultipleFresnel(in vec3 iSr0Color, in vec3 iSr90Color) {","return mix(iSr90Color, iSr0Color, 0.95238095238);","}","float DirectionalAlbedo(in float F0, in vec3 specularTint, in float cosTheta, in float roughness) {","float a2 = pow4(roughness);","float E0 = F0 * vMax(specularTint);","return vLerp(E0 + (1.0 - E0) * pow5(1.0 - cosTheta), 0.04762 + 0.95238*E0, 1.0 - pow5(1.0 - a2));","}","float AverageDirectionalAlbedo(in float F0, in vec3 specularTint, in float roughness) {","float a2 = pow4(roughness);","float E0 = F0 * vMax(specularTint);","return E0 + (-0.33263 * a2 - 0.072359) * (1.0 - E0) * E0;","}","#endif","#if defined(USE_ANISOTROPY) || defined(USE_SPECULAR_AA)","float AnisotropicGeometricSchlick(float roughnessX, in float roughnessY, float NoV, float NoL, in float iAnisotropyAngle) {","float ax = roughnessX * roughnessX;","float ay = roughnessY * roughnessY;","float a2 = pow2(cos(iAnisotropyAngle)*ax) + pow2(sin(iAnisotropyAngle)*ay);","float G1 = sqrt(1.0-a2+a2/max(NoL*NoL,1e-6));","float G2 = sqrt(1.0-a2+a2/max(NoV*NoV,1e-6));","return 2.0 / (G1+G2);","}","float AnisotropicGGXVisibility(float roughnessX, in float roughnessY, float NoV, float NoL, in float iAnisotropyAngle) {","float factor = 0.25 / max(abs(NoL * NoV), 1e-3);","return factor * AnisotropicGeometricSchlick(roughnessX, roughnessY, NoV, NoL, iAnisotropyAngle);","}","float AnisotropicDistributionGGX(vec3 T, vec3 B, vec3 N, vec3 H, float NoH, in float iRoughnessX, in float iRoughnessY, float iAnisotropyAngle) {","vec3 rot_X = cos(2.0 * PI * iAnisotropyAngle) * T + sin(2.0 * PI * iAnisotropyAngle) * B;","vec3 rot_Y = cross(N, rot_X);","float dot_t_h = dot(rot_X, H);","float dot_b_h = dot(rot_Y, H);","float alpha_T = iRoughnessX;","float alpha_B = iRoughnessY;","alpha_T = max(pow2(alpha_T), 1e-3);","alpha_B = max(pow2(alpha_B), 1e-3);","float a = dot_t_h / alpha_T;","float b = dot_b_h / alpha_B;","float D = a * a + b * b + NoH * NoH;","D = PI * alpha_T * alpha_B * D * D;","D = 1.0 / max(D, kEpsilon);","return D;","}","float ComputeAnisotropicRoughness(in vec3 T, in vec3 B, in vec3 N,in vec3 H, in float iRoughness, in float anisotropy, in float anisotropyAngle) {","vec3  rot_X = cos(anisotropyAngle *2. * PI) * T + sin(anisotropyAngle * 2.* PI) * B;","vec3  rot_Y = cross(N, rot_X);","float dot_t_h = dot(rot_X, H);","float dot_b_h = dot(rot_Y, H);","float alpha_T = iRoughness;","float alpha_B = iRoughness * (1.0 - anisotropy) ;","alpha_T = max(pow2(alpha_T), kEpsilon);","alpha_B = max(pow2(alpha_B), kEpsilon);","float tmp =  sign(dot_b_h) * sign(dot_t_h);","dot_t_h = max(abs(dot_t_h),0.05) * tmp;","dot_b_h = max(abs(dot_b_h),0.05);","float phi = atan(dot_t_h,dot_b_h);","float a = pow2(cos(phi) / alpha_T);","float b = pow2(sin(phi) / alpha_B);","float a2 = 1.0/ (a+b);","float roughness = saturate(sqrt(sqrt(a2)));","return clamp(roughness, ROUGHNESS_CLAMP_MIN, ROUGHNESS_CLAMP_MAX) ;","}","#endif"].join("\n"),d=["vec3 doEmission(in float NoV, in vec3 V, in vec3 color, in float value) {","vec3 res = vec3(0.0);","#ifndef USE_NORMALIZED_EMISSION","res = color * value;","#else","vec3 aux = vec3(0.2126729,0.7151522,0.0721750);","res = color/max(dot(color,aux),1e-6) * value;","#endif","#ifdef DSPBR_WITH_CLEAR_COAT_ABOVE_EMISSIVE","#ifdef CLEAR_COAT","vec3 Nc = surfaceData.clearCoatNormal;","float NcoV = saturate(dot(Nc,V));","float fresnelEnergy = 1.0 - materialData.clearCoat * vMax(FresnelSchlick(materialData.clearCoatSR0Color, materialData.clearCoatSR90Color, NcoV));","res *= fresnelEnergy;","#endif","return res/3.14159;","#elif defined(DSPBR)","return res/3.14159;","#else","return res;","#endif","}"].join("\n"),p=["#ifdef USE_SHEEN","float SheenVisGeometricSchlick(in float NoV, in float NoL) {","float div = 4.0 * max(NoL + NoV - NoL*NoV, 1e-6);","return 1.0 / div;","}","float DirectionalSheenAlbedo(in float cosTheta, in float roughness) {","#ifdef DSPBR_WITH_SQUARED_ESTEVEZKULLA_ROUGHNESS","float a = roughness * roughness;","#else","float a = roughness;","#endif","return 0.04495972 + 0.47479907 * (sqrt(1.0 - cosTheta) + (1.0 - cosTheta) * sqrt(1.0 - sqrt(a)));","}","float SheenDistribution(in float NoH, in float sheenValue) {","float cosine2 = max(NoH * NoH,kEpsilon);","float sine2 = max(1.0-cosine2,kEpsilon);","float D = 1.0;","float normalisationTerm = 0.31830988618379;","#if defined(USE_VELVET)","float a2 = sheenValue * sheenValue;","normalisationTerm *= 1.0/(4.0*a2+1.0);","float sine4 = max(pow2(sine2),kEpsilon);","float cotan2 = cosine2/sine2;","float value = -cotan2 / a2;","D = 1.0+4.0 * exp(value)/ sine4;","#endif","#if defined(USE_SOFT_VELVET)","#if defined(DSPBR_WITH_SQUARED_ESTEVEZKULLA_ROUGHNESS)","float a = pow2(sheenValue);","#else","float a = sheenValue;","#endif","a = max(a, 1e-3);","normalisationTerm *= 0.5;","float sine = sqrt(sine2);","D = (2.0 + 1.0 /a ) * pow(sine, 1.0 / a);","#endif","#if defined(USE_SATIN)","float a2 = 0.0081;","normalisationTerm *= 1.0/(8.0*a2);","float cosine4 = max(pow2(cosine2),kEpsilon);","float tan2 = sine2/cosine2;","float value = -tan2/( a2*8.0);","D = exp(value) / cosine4 ;","#endif","return D * normalisationTerm;","}","void sheenModel(inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L) {","vec3 H = normalize(L+V);","float NoH = saturate(dot(N,H));","float NoL = saturate(dot(N,L));","float NoV = saturate(dot(N,V));","#ifdef DSPBR_WITH_SHEEN_COLOR_ROUGHNESS","vec3 sheenColor = materialData.sheen * materialData.sheenColor * SheenDistribution(NoH, materialData.sheenRoughness)* SheenVisGeometricSchlick(NoL,NoV);","float blending = 1.0 - materialData.sheenEnergyConservationConstant;","specular *= blending;","diffuse *= blending;","specular += sheenColor;","#else","float sheen = SheenDistribution(NoH,materialData.sheen) * SheenVisGeometricSchlick(NoL,NoV);","float blending = 1.0 - pow5(1.0-materialData.sheen);","diffuse *= PI * sheen * blending + (1.0 - blending);","#endif","}","#endif"].join("\n"),f=["#if defined(USE_SPECGLOSS_FLAKES)","#define FREQUENCY 0.6","struct flakes {","float flakesRoughness;","vec3 flakesSR0Color;","vec3 flakesWorldNormal;","vec3 flakesNormal;","};","flakes metal;","flakes metalFlakes;","flakes pearlFlakes;","void specGlossFlakesModel(inout vec3 diffuse, inout vec3 specular, in vec3 V, in vec3 L) {","vec3 H = normalize(L+V);","float NoH = saturate(dot(metalFlakes.flakesNormal,H));","float NoV = saturate(dot(metalFlakes.flakesNormal,V));","float NoL = saturate(dot(metalFlakes.flakesNormal,L));","float VoH = saturate(dot(V,H));","float distrib = DistributionGGX( metalFlakes.flakesRoughness, NoH);","float geomVis = GGXVisibility( metalFlakes.flakesRoughness, NoV, NoL);","vec3 fresnel = FresnelSchlick(metalFlakes.flakesSR0Color, vec3(0.0), VoH);","float fresnelEnergy = SpecGlossEnergyConservationTerm(NoL, NoV, metalFlakes.flakesSR0Color, vec3(0.0));","diffuse *= fresnelEnergy;","specular *= fresnelEnergy;","specular += distrib * fresnel * geomVis;","NoH = saturate(dot(metal.flakesNormal,H));","NoV = saturate(dot(metal.flakesNormal,V));","NoL = saturate(dot(metal.flakesNormal,L));","distrib = DistributionGGX( metal.flakesRoughness, NoH);","geomVis = GGXVisibility( metal.flakesRoughness, NoV, NoL);","fresnel = FresnelSchlick(metal.flakesSR0Color, vec3(0.0), VoH);","fresnelEnergy = SpecGlossEnergyConservationTerm(NoL, NoV, metal.flakesSR0Color, vec3(0.0));","diffuse *= fresnelEnergy;","specular *= fresnelEnergy;","specular += distrib * fresnel * geomVis;","#ifdef PEARL_FLAKES_ACTIVATED","NoH = saturate(dot(pearlFlakes.flakesNormal,H));","NoV = saturate(dot(pearlFlakes.flakesNormal,V));","NoL = saturate(dot(pearlFlakes.flakesNormal,L));","distrib = DistributionGGX( pearlFlakes.flakesRoughness, NoH);","geomVis = GGXVisibility( pearlFlakes.flakesRoughness, NoV, NoL);","fresnel = FresnelSchlick(pearlFlakes.flakesSR0Color, vec3(0.0), VoH);","fresnelEnergy = SpecGlossEnergyConservationTerm(NoL, NoV, pearlFlakes.flakesSR0Color, vec3(0.0));","diffuse *= fresnelEnergy;","specular *= fresnelEnergy;","specular += distrib * fresnel * geomVis;","#endif","}","void flakesVisibility(in vec3 currentWorldNormal, out float flakesLODLevel, out float metallicFlakesBlending, out float flakesMask, in float scaling, in vec3 worldPosition) {","mat3 mat = transposeMatrix(mat3(modelMatrix));","vec3 worldScaling = 1.0/vec3(length(mat[0]),length(mat[1]),length(mat[2]));","vec3 V = cameraPosition - worldPosition; ","float dist = length(worldScaling * V);","V = normalize(V);","float NdotV = dot(currentWorldNormal, V); ","float locality = (NdotV > 0.0) ? 1.0 : 0.0;","if (locality == 0.0) {","flakesLODLevel = 0.0;","metallicFlakesBlending = 0.0;","flakesMask = 0.0;","return;","}","float normDist = saturate(scaling * dist * 0.00125);","float shortDist = 1.0 - normDist;","flakesLODLevel = scaling * dist;","#ifdef ADVANCED_FLAKES_BLENDING","metallicFlakesBlending = normDist * (0.5 * flakesDensity + 0.25);","#else","metallicFlakesBlending = normDist * 0.5 ;","#endif","flakesMask = shortDist;","}","void computeMetallicFlakes(out float metallicFlakesPresence, out vec3 metallicFlakesBaseColor,","in float presenceNoise, in float presenceNoise2, in float noisePositive, in float noiseNegative,","in vec3 T, in vec3 B) {","if (length(flakesColorMulCoef) < kEpsilon) {","return;","}","metallicFlakesPresence = pow5(presenceNoise);","float aux = pow5(presenceNoise2);","metallicFlakesPresence += mix( - aux, aux, flakesDensity);","metallicFlakesPresence *= 5.0;","metallicFlakesPresence = saturate(metallicFlakesPresence);","metallicFlakesBaseColor = mix(2.0 * flakesColor, vec3(0.0), affine(noiseNegative, 0.5, 1.0));","float theta = metallicFlakesPresence * noisePositive* PI * 0.125;","float phi =  metallicFlakesPresence * noiseNegative * PI * 0.125;","metalFlakes.flakesWorldNormal = Rotate3D(metalFlakes.flakesWorldNormal, theta, B);","metalFlakes.flakesWorldNormal = Rotate3D(metalFlakes.flakesWorldNormal, phi, T);","}","void computePearlFlakes(out float pearlFlakesPresence, out vec3 pearlFlakesBaseColor, ","in float presenceNoise, in float presenceNoise2, in float noisePositive, in float noiseNegative,","in vec3 T, in vec3 B) {","if (length(pearlFlakesColorMulCoef) < kEpsilon) {","return;","}","pearlFlakesPresence = pow3(pow6(presenceNoise2));","float aux = pow3(pow6(presenceNoise));","pearlFlakesPresence += mix( - aux, aux, pearlFlakesDensity);","pearlFlakesPresence *= 6.0;","pearlFlakesPresence = saturate(pearlFlakesPresence);","pearlFlakesBaseColor = mix(2.0 * pearlFlakesColor, vec3(0.0), affine(noisePositive, 0.5, 1.0));","float theta = pearlFlakesPresence * noisePositive * PI * 0.25;","float phi =  pearlFlakesPresence * noiseNegative * PI * 0.25;","pearlFlakes.flakesWorldNormal = Rotate3D(pearlFlakes.flakesWorldNormal, theta, B);","pearlFlakes.flakesWorldNormal = Rotate3D(pearlFlakes.flakesWorldNormal, phi, T);","}","void blendMetalFlakes(in vec3 currentWorldNormal, in float flakesMask, in float metallicFlakesBlending, in float metallicFlakesPresence, in vec3 metallicFlakesBaseColor) {","if (length(flakesColorMulCoef) < kEpsilon) {","return;","}","float metallicFlakesStrength = flakesMask * metallicFlakesPresence;","#ifdef FLAKES_NORMAL_PERTURBATION","float metalPerturbateNormal = 0.1 * flakesBump;","#else","float metalPerturbateNormal = 0.0;","#endif","metalFlakes.flakesRoughness = 1.0 - mix(0.75,0.55,flakesRoughness);","metal.flakesRoughness = metalFlakes.flakesRoughness + metalPerturbateNormal;","metal.flakesSR0Color = flakesColorMulCoef * metallicFlakesBlending * flakesColor;","metalFlakes.flakesSR0Color = flakesColorMulCoef * metallicFlakesBaseColor * metallicFlakesStrength;","metalPerturbateNormal *= 10.0 * flakesMask;","metalFlakes.flakesWorldNormal = normalize(currentWorldNormal + metalPerturbateNormal * metalFlakes.flakesWorldNormal);","}","void blendPearlFlakes(in vec3 currentWorldNormal, in float flakesMask, in float pearlFlakesPresence, in vec3 pearlFlakesBaseColor) {","if (length(pearlFlakesColorMulCoef) < kEpsilon) {","return;","}","float pearlFlakesStrength = flakesMask * pearlFlakesPresence;","#ifdef FLAKES_NORMAL_PERTURBATION","float pearlPerturbateNormal = 0.05 * pearlFlakesBump;","#else","float pearlPerturbateNormal = 0.0;","#endif","pearlFlakes.flakesRoughness = 0.25;","pearlFlakes.flakesSR0Color = pearlFlakesColorMulCoef * pearlFlakesBaseColor * pearlFlakesStrength;","pearlPerturbateNormal *= 10.0 * sqrt(flakesMask);","pearlFlakes.flakesWorldNormal = normalize(currentWorldNormal + pearlPerturbateNormal * pearlFlakes.flakesWorldNormal);","}","void doFlakes(in vec3 currentWorldNormal, in vec3 worldPosition, in vec3 objectSpacePosition) { ","float flakesMask = 0.0;","float flakesLODLevel = 0.0;","float scaling = mix(0.0, 0.9, atan(3.14*flakesScale)*2.0/3.14);","vec3 T = getGeomT(currentWorldNormal);","vec3 B = getGeomB(currentWorldNormal, T);","float metallicFlakesBlending = 0.0;","float metallicFlakesPresence = 0.0;","vec3 metallicFlakesBaseColor = vec3(0.0);","metal.flakesRoughness = 0.0;","metal.flakesSR0Color = vec3(0.0);","metal.flakesWorldNormal = currentWorldNormal;","metalFlakes.flakesRoughness = 0.0;","metalFlakes.flakesSR0Color = vec3(0.0);","metalFlakes.flakesWorldNormal = currentWorldNormal;","float pearlFlakesPresence = 0.0;","vec3 pearlFlakesBaseColor = vec3(0.0);","#ifdef PEARL_FLAKES_ACTIVATED","pearlFlakes.flakesRoughness = 0.0;","pearlFlakes.flakesSR0Color = vec3(0.0);","pearlFlakes.flakesWorldNormal = currentWorldNormal;","#endif","flakesVisibility(currentWorldNormal, flakesLODLevel, metallicFlakesBlending, flakesMask, scaling, worldPosition);","if (length(pearlFlakesColorMulCoef) < kEpsilon && length(flakesColorMulCoef) < kEpsilon) {","return;","}","if (flakesMask < kEpsilon) {","blendMetalFlakes(currentWorldNormal, flakesMask, metallicFlakesBlending, metallicFlakesPresence, metallicFlakesBaseColor);","#ifdef PEARL_FLAKES_ACTIVATED","blendPearlFlakes(currentWorldNormal, flakesMask, pearlFlakesPresence, pearlFlakesBaseColor);","#endif","return;","}","vec3 tex = scaling * objectSpacePosition;","tex.y = -abs(tex.y);","tex.x = -abs(tex.x);","#ifdef FLAKES_NORMAL_PERTURBATION","float noisePositive = arrayFBMMixer(0.85 * tex, flakesLODLevel, FREQUENCY,1.0,2.0);","float noiseNegative = arrayFBMMixer(0.85 * tex.yxz, flakesLODLevel, FREQUENCY,1.0,2.0);","#else","float noisePositive = 0.0;","float noiseNegative = 0.0;","#endif","float presenceNoise = affine(arrayFBMMixer(tex, flakesLODLevel, FREQUENCY,1.0,3.0), 0.5, 1.0 );","#ifdef ADVANCED_PRESENCE_NOISE","float presenceNoise2 = affine(arrayFBMMixer(tex.yxz, flakesLODLevel, FREQUENCY,1.0,3.0), 0.5, 1.0);","#else","float presenceNoise2 = 0.0;","#endif","computeMetallicFlakes(metallicFlakesPresence, metallicFlakesBaseColor, presenceNoise, presenceNoise2, noisePositive, noiseNegative, T, B);","#ifdef PEARL_FLAKES_ACTIVATED","computePearlFlakes(pearlFlakesPresence,pearlFlakesBaseColor,presenceNoise, presenceNoise2, noisePositive,noiseNegative,T,B);","#endif","blendMetalFlakes(currentWorldNormal, flakesMask, metallicFlakesBlending, metallicFlakesPresence, metallicFlakesBaseColor);","#ifdef PEARL_FLAKES_ACTIVATED","blendPearlFlakes(currentWorldNormal, flakesMask, pearlFlakesPresence, pearlFlakesBaseColor);","#endif","}","#endif"].join("\n"),m=["#if defined(USE_DSPBR_FLAKES)","#ifdef DSPBR_FLAKES_FULL_GRID","#define HALF_MAXF_GRID_SIZE 2.0","#define FLAKES_PER_CELL 4","#else","#define HALF_MAXF_GRID_SIZE 1.0","#define FLAKES_PER_CELL 2","#endif","#define DSPBRFLAKES_STO_SMOOTH_TRANSITION 256.0","#define DSPBRFLAKES_CLOSE_SMOOTH_TRANSITION 4.0","#define DSPBRFLAKES_CLOSE_STO_TRANSITION 0.25","#if (defined(USE_ENVMAP) || defined(HAS_AREA_LIGHTS)) && defined(USE_LIGHTING)","#define FLAKES_HEMISPHERE_APPROX;","#endif","struct rstGridData {","float minX;","float minY;","float maxX;","float maxY;","float deltaDDx;","float deltaDDy;","float dyLeftBound;","float dxLeftBound;","float dyRightBound;","float dxRightBound;","};","rstGridData rasterizedGridData;","rstGridData rasterizedGridDataClose;","struct flData {","float flakesRoughness;","float flakesCoverage;","vec3 flakesColor;","#ifdef DSPBR_WITH_FLIPFLOP_COLOR","vec3 flipFlopColor;","float flipFlop;","#endif","float flakesCosConeAngle;","float flakesConeSolidAngle;","vec3 closeupFlakesReflect;","vec3 closeupFlakesNormal;","#ifdef FLAKES_HEMISPHERE_APPROX","vec3 stochasticHemisphereFlakesNormal;","vec3 stochasticHemisphereFlakesReflect;","vec3 stochasticHemisphereFlakesColor;","#endif","float baseWeight;","float smoothWeight;","vec3 smoothFlakesColor;","float closeupWeight;","vec3 closeupFlakesColor;","float stochasticWeight;","vec2 footprintPos;","vec2 footprintDx;","vec2 footprintDy;","float footprintArea;","float cellsInFootPrint;","float expectedFlakes;","float invDet;","float seedRes;","};","flData flakesData;","void reorientParallelogram(in vec2 pos, in vec2 dx, in vec2 dy, out vec2 nPos, out vec2 nDx, out vec2 nDy) {","nPos = vec2(pos);","if ((dy.x * dx.y - dy.y * dx.x) > 0.0) {","nDx = vec2(dy); ","nDy = vec2(dx); ","} else {","nDx = vec2(dx);","nDy = vec2(dy);","}","if (nDy.y < 0.0) {","nPos = nPos + nDy;","vec2 aux = vec2(nDy);","nDy = nDx;","nDx = - aux;","}","if (nDy.y < 0.0) {","nPos = nPos + nDy;","vec2 aux = vec2(nDy);","nDy = nDx;","nDx = - aux;","}","if (nDx.y <= 0.0) {","nPos = nPos + nDx;","vec2 aux = vec2(nDx);","nDx = nDy;","nDy = - aux;","}","if (nDx.y <= 0.0) {","nPos = nPos + nDx;","vec2 aux = vec2(nDx);","nDx = nDy;","nDy = - aux;","}","}","vec4 parallelogramBBox(in vec2 pos,in vec2 dx,in vec2 dy) {","vec2 corner1 = pos;","vec2 corner2 = pos + dx;","vec2 corner3 = pos + dy;","vec2 corner4 = pos + dx + dy;","vec2 minBBox = vec2(vMin(vec4(corner1.x,corner2.x,corner3.x,corner4.x)), vMin(vec4(corner1.y,corner2.y,corner3.y,corner4.y)));","vec2 maxBBox = vec2(vMax(vec4(corner1.x,corner2.x,corner3.x,corner4.x)), vMax(vec4(corner1.y,corner2.y,corner3.y,corner4.y)));","return vec4(minBBox, maxBBox);","}","void prepareFlakesGrid(out rstGridData gridData, in bool close) {","vec2 pos;","vec2 dx;","vec2 dy;","if (close) {","float nodeSize = 1.25 / flakesData.seedRes;","pos = flakesData.footprintPos - nodeSize;","dx = vec2(2.0 * nodeSize, 0.0);","dy = vec2(0.0, 2.0 * nodeSize);","} else {","pos = flakesData.footprintPos;","dx = flakesData.footprintDx;","dy = flakesData.footprintDy;","}","vec4 bbox = parallelogramBBox(pos, dx, dy);","vec2 gridMin = floor(flakesData.seedRes * bbox.xy);","vec2 gridMax = ceil(flakesData.seedRes * bbox.zw);","vec2 footPrintCenter = flakesData.seedRes * (pos + 0.5 * (dx + dy));","gridMin = clamp(gridMin, footPrintCenter - HALF_MAXF_GRID_SIZE, footPrintCenter + HALF_MAXF_GRID_SIZE);","gridMin = clamp(gridMin,  footPrintCenter - vec2(flakesData.seedRes), footPrintCenter + vec2(flakesData.seedRes));","gridMax = clamp(gridMax, footPrintCenter - HALF_MAXF_GRID_SIZE, footPrintCenter + HALF_MAXF_GRID_SIZE);","gridMax = clamp(gridMax,  footPrintCenter - vec2(flakesData.seedRes), footPrintCenter + vec2(flakesData.seedRes));","gridMax += vec2(1.0);","{","vec2 opos = pos * flakesData.seedRes;","vec2 odx = dx * flakesData.seedRes;","vec2 ody = dy * flakesData.seedRes;","reorientParallelogram(opos, odx, ody, pos, dx, dy);","}","float deltaDDx = dx.x / abs(dx.y);","float deltaDDy = dy.x / abs(dy.y);","vec2 sum = dx + dy;","float minX = max(min(pos.x, min(pos.x + dy.x, pos.x + sum.x)),gridMin.x);","float maxX = min(max(pos.x, max(pos.x + dx.x, pos.x + sum.x)),gridMax.x);","float minY = floor(max(gridMin.y, pos.y));","float maxY = ceil(min(gridMax.y, pos.y + sum.y));","float dyLeftBound =  pos.x +\t\t\t\t(minY - pos.y\t\t\t+ (dy.x < 0.0 ? 1.0 : 0.0)) * deltaDDy;","float dxLeftBound =  pos.x + dy.x +\t\t(minY - pos.y - dy.y\t+ (dx.x < 0.0 ? 1.0 : 0.0)) * deltaDDx;","float dyRightBound = pos.x + dx.x +\t\t(minY - pos.y - dx.y\t+ (dy.x > 0.0 ? 1.0 : 0.0)) * deltaDDy;","float dxRightBound = pos.x +\t\t\t\t(minY - pos.y\t\t\t+ (dx.x > 0.0 ? 1.0 : 0.0)) * deltaDDx;","gridData.minX = minX;","gridData.maxX = maxX;","gridData.minY = minY;","gridData.maxY = maxY;","gridData.dyLeftBound = dyLeftBound;","gridData.dxLeftBound = dxLeftBound;","gridData.dyRightBound = dyRightBound;","gridData.dxRightBound = dxRightBound;","gridData.deltaDDx = deltaDDx;","gridData.deltaDDy = deltaDDy;","}","vec2 triplanarMapping(in vec3 p, in vec3 n, in float scale) {","vec2 uv;","if (abs(n.x) >= abs(n.y) && abs(n.x) >= abs(n.z)) {","uv = vec2(-p.z,-p.y);","} else if (abs(n.y) >= abs(n.z)) {","uv = vec2( p.x, p.z);","} else {","uv = vec2( p.x,-p.y);","}","return uv * scale;","}","void computeFlakesRoughness(in float flakesRoughness) {","float targetConeAngle = 0.122173;","float targetConeSolidAngle = 2.0 * 3.14159265359 * (1.0 - cos(targetConeAngle));","float targetConeRoughness2 = targetConeSolidAngle / (4.0 * 3.14159265359 - targetConeSolidAngle);","float totalFlakeRoughness2 = pow2(flakesRoughness);","float flakeConeRoughness2 = min(targetConeRoughness2, 0.5 * totalFlakeRoughness2);","flakesData.flakesCosConeAngle = clamp(1.0 - 2.0 * flakeConeRoughness2 / (1.0 + flakeConeRoughness2), 0.0, 0.99984769502);","flakesData.flakesConeSolidAngle = 2.0 * 3.14159265359 * (1.0 - flakesData.flakesCosConeAngle);","flakesData.flakesRoughness = sqrt(totalFlakeRoughness2 - flakeConeRoughness2);","}","#ifdef DSPBR_WITH_FLIPFLOP_COLOR","void initFlakesData(in vec3 p, in vec3 N, in float flakesSize, in float flakesCoverage, in vec3 flakesColor, in float flakesRoughness, in float flipFlop, in vec3 flipFlopColor) {","#else","void initFlakesData(in vec3 p, in vec3 N, in float flakesSize, in float flakesCoverage, in vec3 flakesColor, in float flakesRoughness) {","#endif","mat3 mat = transposeMatrix(mat3(modelMatrix));","vec3 worldScaling = vec3(length(mat[0]),length(mat[1]),length(mat[2]));","vec3 scaledP = p * worldScaling;","flakesData.flakesColor = flakesColor;","flakesData.flakesCoverage = flakesCoverage;","#ifdef DSPBR_WITH_FLIPFLOP_COLOR","flakesData.flipFlopColor = flipFlopColor;","flakesData.flipFlop = pow2(1.0 / max(flipFlop, 1e-6));","#endif","computeFlakesRoughness(flakesRoughness);","vec3 x =  dFdx(scaledP);","vec3 y =  dFdy(scaledP);","flakesData.footprintPos = triplanarMapping(scaledP,N,1e-3);","flakesData.footprintDx = triplanarMapping(x ,N,1e-3);","flakesData.footprintDy = triplanarMapping(y,N,1e-3);","flakesData.footprintArea = flakesData.footprintDx.x * flakesData.footprintDy.y - flakesData.footprintDx.y * flakesData.footprintDy.x;","flakesData.invDet = 1.0 / flakesData.footprintArea;","float cellsPerArea = 1.5396e6 / pow2(flakesSize);","flakesData.cellsInFootPrint = abs(flakesData.footprintArea) * cellsPerArea;","float flakesPerArea = flakesCoverage * cellsPerArea;","flakesData.expectedFlakes = abs(flakesData.footprintArea) * flakesPerArea;","flakesData.seedRes = max(float(FLAKES_PER_CELL), vRound(sqrt(cellsPerArea/float(FLAKES_PER_CELL))));","prepareFlakesGrid(rasterizedGridData, false);","prepareFlakesGrid(rasterizedGridDataClose, true);","}","#ifdef DSPBR_WITH_FLIPFLOP_COLOR","vec3 computeFlakesTint(float NoV) {","float coeff = pow(saturate(NoV), flakesData.flipFlop);","return mix(flakesData.flakesColor, flakesData.flipFlopColor, coeff);","}","vec3 computeFlakesTint(vec3 V, vec3 N) {","return computeFlakesTint(dot(N,V));","}","#else","vec3 computeFlakesTint() {","return flakesData.flakesColor;","}","#endif","vec2 rnGenerator(inout int seed) {","int rn = modI(1140671485 * seed + 12820163,16777216);","seed = modI(1140671485 * rn + 12820163,16777216);","return vec2(float(rn) /16777216.0 ,float(seed) / 16777216.0);","}","void generateFlakes(inout int seed, in vec3 V, in vec3 N, out vec2 pos, out vec3 refl, out bool opaque) {","pos = rnGenerator(seed);","vec2 uvs = rnGenerator(seed);","refl = TangentToWorldGeom(ImportanceSampleGGX(uvs.xy,flakesData.flakesRoughness), N);","refl = 2.0 * dot(V,refl) * refl - V;","opaque = rnGenerator(seed).x < flakesData.flakesCoverage;","}","int getSeed(float i, float j) {","float iWrapped = i;","float jWrapped = j;","return int(length(vec2(iWrapped,jWrapped)* 16892.0));","}","bool midFlakeInFootPrint(in vec2 center) {","if (abs(flakesData.footprintArea) < 1e-10) {","return false;","} else {","vec2 pp = center - flakesData.footprintPos;","vec2 uv = flakesData.invDet * vec2(dot(vec2(-pp.y,pp.x),flakesData.footprintDy), dot(vec2(pp.y,-pp.x),flakesData.footprintDx));","return 0.0 <= uv.x && uv.x <= 1.0 && 0.0 <= uv.y && uv.y <= 1.0;","}","}","vec2 contributingStochasticFlakes(in vec3 V, in vec3 L, in vec3 N, in float limit) {","float contributing = 0.0;","float flakesInFootPrint = 0.0;","float deltaDDx = rasterizedGridData.deltaDDx;","float deltaDDy = rasterizedGridData.deltaDDy;","float minX = rasterizedGridData.minX;","float maxX = rasterizedGridData.maxX;","float minY = rasterizedGridData.minY;","float maxY = rasterizedGridData.maxY;","float dyLeftBound =  rasterizedGridData.dyLeftBound;","float dxLeftBound =  rasterizedGridData.dxLeftBound;","float dyRightBound = rasterizedGridData.dyRightBound;","float dxRightBound = rasterizedGridData.dxRightBound;","float i = 0.0;","float maxI = -1.0;","float j = minY;","float jEnd = maxY;","float nodeSize = 1.0 / flakesData.seedRes;","#ifdef DSPBR_WITH_FLIPFLOP_COLOR","vec3 totalRefl = vec3(0.0);","#endif","for (int loop = 0; loop < 150; loop++) {","if (i >= maxI) {","float boundaryLeft = max(minX, max(dyLeftBound, dxLeftBound));","i = floor(boundaryLeft);","float boundaryRight = min(maxX, min(dyRightBound, dxRightBound));","maxI = ceil(boundaryRight);","dyLeftBound += deltaDDy;","dxLeftBound += deltaDDx;","dyRightBound += deltaDDy;","dxRightBound += deltaDDx;","}","int seed = getSeed(i,j);","for (int cell = 0; cell < FLAKES_PER_CELL; cell++) {","vec2 fPos;","vec3 fRefl;","bool fOpaque;","generateFlakes(seed,V,N,fPos,fRefl, fOpaque);","if (fOpaque) {","vec2 flakeUV = nodeSize * (vec2(i, j) + fPos);","if (midFlakeInFootPrint(flakeUV)) {","float val = step(0.0, dot(fRefl,L) - limit);","flakesInFootPrint++;","#ifdef DSPBR_WITH_FLIPFLOP_COLOR","totalRefl += val * fRefl;","#endif","contributing += val;","}","}","}","i++;","if (i >= maxI) {","j++;","}","if (j >= jEnd) {","break;","}","}","float coeff = contributing / max(1.0,flakesInFootPrint);","#ifdef DSPBR_WITH_FLIPFLOP_COLOR","vec3 flakesN = normalize(vNormalize(totalRefl) + V);","return vec2(coeff, dot(V, flakesN));","#else","return vec2(coeff, 0.0);","#endif","}","vec3 stochasticFlakesPattern(in vec3 V, in vec3 L, in vec3 N, in float limit) {","vec2 c = contributingStochasticFlakes(V,L,N, limit);","float d = c.x;","#ifdef DSPBR_WITH_FLIPFLOP_COLOR","return computeFlakesTint(c.y) * d;","#else","return computeFlakesTint() * d;","#endif","}","vec3 stochasticFlakesBRDF(in vec3 V, in vec3 L, in vec3 N, in float VoH, in float NoL, in float NoV) {","float g = GeometricSchlick(flakesData.flakesRoughness, NoL,NoV );","return VoH * g * stochasticFlakesPattern(V, L, N, flakesData.flakesCosConeAngle)/ max(NoL*NoV * flakesData.flakesConeSolidAngle,1e-6) ;","}","#ifdef FLAKES_HEMISPHERE_APPROX","vec3 contributingStochasticHemisphereFlakes(in vec3 V, in vec3 N) {","vec3 stochasticFlakesOrientation = vec3(0.0);","float deltaDDx = rasterizedGridData.deltaDDx;","float deltaDDy = rasterizedGridData.deltaDDy;","float minX = rasterizedGridData.minX;","float maxX = rasterizedGridData.maxX;","float minY = rasterizedGridData.minY;","float maxY = rasterizedGridData.maxY;","float dyLeftBound =  rasterizedGridData.dyLeftBound;","float dxLeftBound =  rasterizedGridData.dxLeftBound;","float dyRightBound = rasterizedGridData.dyRightBound;","float dxRightBound = rasterizedGridData.dxRightBound;","float i = 0.0;","float maxI = -1.0;","float j = minY;","float jEnd = maxY;","float nodeSize = 1.0 / flakesData.seedRes;","for (int loop = 0; loop < 150; loop++) {","if (i >= maxI) {","float boundaryLeft = max(minX, max(dyLeftBound, dxLeftBound));","i = floor(boundaryLeft);","float boundaryRight = min(maxX, min(dyRightBound, dxRightBound));","maxI = ceil(boundaryRight);","dyLeftBound += deltaDDy;","dxLeftBound += deltaDDx;","dyRightBound += deltaDDy;","dxRightBound += deltaDDx;","}","int seed = getSeed(i,j);","for (int cell = 0; cell < FLAKES_PER_CELL; cell++) {","vec2 fPos;","vec3 fRefl;","bool fOpaque;","generateFlakes(seed,V,N,fPos,fRefl, fOpaque);","float val = dot(fRefl,N);","stochasticFlakesOrientation += step(0.1, val) * fRefl;","}","i++;","if (i >= maxI) {","j++;","}","if (j >= jEnd) {","break;","}","}","float len = length(stochasticFlakesOrientation);","return len > 1e-6 ? stochasticFlakesOrientation / len : reflect(V , N);","}","#endif","vec3 contributingCloseFlakes(in vec3 V, in vec3 N) {","float deltaDDx = rasterizedGridDataClose.deltaDDx;","float deltaDDy = rasterizedGridDataClose.deltaDDy;","float minX = rasterizedGridDataClose.minX;","float maxX = rasterizedGridDataClose.maxX;","float minY = rasterizedGridDataClose.minY;","float maxY = rasterizedGridDataClose.maxY;","float dyLeftBound =  rasterizedGridDataClose.dyLeftBound;","float dxLeftBound =  rasterizedGridDataClose.dxLeftBound;","float dyRightBound = rasterizedGridDataClose.dyRightBound;","float dxRightBound = rasterizedGridDataClose.dxRightBound;","float i = 0.0;","float maxI = -1.0;","float j = minY;","float jEnd = maxY;","float nodeSize = 1.0 / flakesData.seedRes;","float bestDistance = 1e10;","vec3 res = vec3(0.0);","for (int loop = 0; loop < 150; loop++) {","if (i >= maxI) {","float boundaryLeft = max(minX, max(dyLeftBound, dxLeftBound));","i = floor(boundaryLeft);","float boundaryRight = min(maxX, min(dyRightBound, dxRightBound));","maxI = ceil(boundaryRight);","dyLeftBound += deltaDDy;","dxLeftBound += deltaDDx;","dyRightBound += deltaDDy;","dxRightBound += deltaDDx;","}","int seed = getSeed(i,j);","for (int cell = 0; cell < FLAKES_PER_CELL; cell++) {","vec2 fPos;","vec3 fRefl;","bool fOpaque;","generateFlakes(seed,V,N,fPos,fRefl, fOpaque);","vec2 flakeUV = nodeSize * (vec2(i, j)  + fPos);","vec2 prel = flakesData.footprintPos + 0.5* (flakesData.footprintDx + flakesData.footprintDy) - flakeUV;","float curDistance = dot(prel, prel);","if (curDistance < bestDistance) {","bestDistance = curDistance;","res = fOpaque ? fRefl : vec3(0.0);","}","}","i++;","if (i >= maxI) {","j++;","}","if (j >= jEnd) {","break;","}","}","return vNormalize(res);","}","float closeFlakesPattern(in vec3 L, in float limit) {","return step(0.0, dot(flakesData.closeupFlakesReflect, L) - limit);","}","float closeFlakesBRDF(in vec3 L, in float NoL) {","return closeFlakesPattern(L, flakesData.flakesCosConeAngle) / max(flakesData.flakesConeSolidAngle  * NoL, 1e-6);","}","void dspbrFlakesModel(inout vec3 diffuse, inout vec3 specular, in vec3 V, in vec3 L, in vec3 N) {","vec3 H = normalize(V+L);","float VoH = dot(V,H);","float NoL = saturate(dot(N,L));","float NoV = saturate(dot(N,V));","float NoH = saturate(dot(N,H));","vec3 res = flakesData.smoothFlakesColor * SpecularBRDF(flakesData.flakesRoughness,NoV,NoL,NoH);","if (flakesData.stochasticWeight > 0.0) {","res += flakesData.stochasticWeight * stochasticFlakesBRDF(V,L,N,VoH,NoL,NoV);","}","if (flakesData.closeupWeight > 0.0) {","res += flakesData.closeupFlakesColor * closeFlakesBRDF(L,NoL);","}","diffuse *= flakesData.baseWeight;","specular *= flakesData.baseWeight;","specular += res;","}","void initFlakesWeights(in vec3 V, in vec3 N) {","flakesData.closeupFlakesReflect = vec3(0.0);","float flakesHit = 0.0;","#ifdef DSPBR_FLAKES_THREE_LAYERS","float closeupStochasticTransition = log(DSPBRFLAKES_CLOSE_STO_TRANSITION);","float closeupSmoothTransition = log(DSPBRFLAKES_CLOSE_SMOOTH_TRANSITION);","float stochasticSmoothTransition = log(DSPBRFLAKES_STO_SMOOTH_TRANSITION);","float logCellsInFootPrint = log(flakesData.cellsInFootPrint);","if (logCellsInFootPrint < closeupSmoothTransition) {","flakesData.closeupFlakesReflect = contributingCloseFlakes(V, N);","flakesHit = dot(flakesData.closeupFlakesReflect, flakesData.closeupFlakesReflect) > 0.0 ? 1.0 : 0.0;","if (logCellsInFootPrint < closeupStochasticTransition) {","flakesData.closeupWeight = flakesHit;","flakesData.stochasticWeight = 0.0;","flakesData.baseWeight = 1.0 - flakesHit;","} else {","flakesData.stochasticWeight = smoothstep(closeupStochasticTransition, closeupSmoothTransition, logCellsInFootPrint);","flakesData.closeupWeight = flakesHit * (1.0 - flakesData.stochasticWeight);","flakesData.baseWeight = (1.0 - flakesHit) * (1.0 - flakesData.stochasticWeight) + (1.0 - flakesData.flakesCoverage) * flakesData.stochasticWeight;","}","flakesData.smoothWeight = 0.0;","} else {","flakesData.closeupWeight = 0.0;","if (logCellsInFootPrint < stochasticSmoothTransition) {","flakesData.smoothWeight = smoothstep(closeupSmoothTransition, stochasticSmoothTransition, logCellsInFootPrint);","flakesData.stochasticWeight = 1.0 - flakesData.smoothWeight;","} else {","flakesData.smoothWeight = 1.0;","flakesData.stochasticWeight = 0.0;","}","flakesData.baseWeight = 1.0 - flakesData.flakesCoverage;","}","#endif","#ifdef DSPBR_FLAKES_TWO_LAYERS","flakesData.stochasticWeight = 0.0;","float fullCloseUp = log(DSPBRFLAKES_CLOSE_STO_TRANSITION);","float fullSmooth = log(DSPBRFLAKES_CLOSE_SMOOTH_TRANSITION);","float logCellsInFootPrint = log(flakesData.cellsInFootPrint);","flakesData.smoothWeight = smoothstep(fullCloseUp,fullSmooth, logCellsInFootPrint);","flakesData.closeupWeight = 0.0;","flakesData.baseWeight = 1.0 - flakesData.flakesCoverage;","if (logCellsInFootPrint < fullSmooth) {","flakesData.closeupFlakesReflect = contributingCloseFlakes(V, N);","flakesHit = dot(flakesData.closeupFlakesReflect, flakesData.closeupFlakesReflect) > 0.0 ? 1.0 : 0.0;","if (logCellsInFootPrint < fullCloseUp) {","flakesData.closeupWeight = flakesHit;","flakesData.baseWeight = 1.0 - flakesHit;","} else {","flakesData.closeupWeight = flakesHit * (1.0 - flakesData.smoothWeight);","flakesData.baseWeight = (1.0 - flakesHit) * (1.0 - flakesData.smoothWeight) + (1.0 - flakesData.flakesCoverage) * flakesData.smoothWeight;","}","}","#endif","#ifdef DSPBR_FLAKES_ONE_LAYER","flakesData.stochasticWeight = 0.0;","flakesData.closeupWeight = 0.0;","flakesData.smoothWeight = 1.0;","flakesData.baseWeight = (1.0 - flakesData.flakesCoverage);","#endif","#ifdef FLAKES_HEMISPHERE_APPROX","flakesData.stochasticHemisphereFlakesNormal = N;","flakesData.stochasticHemisphereFlakesReflect = reflect(V, N);","if (flakesData.stochasticWeight > 0.0) {","flakesData.stochasticHemisphereFlakesReflect = contributingStochasticHemisphereFlakes(V, N);","flakesData.stochasticHemisphereFlakesNormal = normalize(V + flakesData.stochasticHemisphereFlakesReflect);","}","#endif","if (dot(flakesData.closeupFlakesReflect, N) < 0.0) {","flakesData.closeupFlakesReflect = flakesData.closeupFlakesReflect - 2.0 * dot(flakesData.closeupFlakesReflect, N) * N;","}","flakesData.closeupFlakesNormal = normalize(V + flakesData.closeupFlakesReflect);","flakesData.stochasticWeight *= flakesData.flakesCoverage;","flakesData.smoothWeight *= flakesData.flakesCoverage;","#ifndef DSPBR_WITH_FLIPFLOP_COLOR","flakesData.smoothFlakesColor = flakesData.smoothWeight * computeFlakesTint();","flakesData.closeupFlakesColor = flakesData.closeupWeight * computeFlakesTint();","#ifdef FLAKES_HEMISPHERE_APPROX","flakesData.stochasticHemisphereFlakesColor = flakesData.stochasticWeight * computeFlakesTint();","#endif","#else","flakesData.smoothFlakesColor = flakesData.smoothWeight * computeFlakesTint(V, N);","flakesData.closeupFlakesColor = flakesData.closeupWeight * computeFlakesTint(V, flakesData.closeupFlakesNormal);","#ifdef FLAKES_HEMISPHERE_APPROX","flakesData.stochasticHemisphereFlakesColor = flakesData.stochasticWeight * computeFlakesTint(V, flakesData.stochasticHemisphereFlakesNormal);","#endif","#endif","}","#endif"].join("\n"),g=["#ifdef CLEAR_COAT","void clearCoatModel(inout vec3 diffuse, inout vec3 specular, in vec3 V, in vec3 L) {","vec3 N = surfaceData.clearCoatNormal;","float r = materialData.clearCoatRoughness;","vec3 H = normalize(L+V);","float NoH = saturate(dot(N,H));","float NoV = saturate(dot(N,V));","float NoL = saturate(dot(N,L));","float VoH = saturate(dot(V,H));","float distrib = DistributionGGX( r, NoH);","float geomVis = GGXVisibility( r, NoV, NoL);","vec3 fresnel = FresnelSchlick(materialData.clearCoatSR0Color, materialData.clearCoatSR90Color, VoH);","#ifdef DSPBR","float fresnelEnergy = 1.0 - materialData.clearCoat * vMax(max(FresnelSchlick(materialData.clearCoatSR0Color, materialData.clearCoatSR90Color, NoL),FresnelSchlick(materialData.clearCoatSR0Color, materialData.clearCoatSR90Color, NoV)));","#else","float fresnelEnergy = SpecGlossEnergyConservationTerm(NoL, NoV, materialData.clearCoatSR0Color, materialData.clearCoatSR90Color);","#endif","diffuse *= fresnelEnergy;","specular *= fresnelEnergy;","specular += materialData.clearCoat * distrib * fresnel * geomVis;","}","#ifdef CLEAR_COAT_NORMALMAP","vec3 perturbNormal3ArbCoat( vec3 surf_norm, vec3 surf_tgt, vec3 surf_binorm, vec2 uv ) {","vec3 N = normalize(surf_norm);","vec3 T = normalize(surf_tgt);","T = normalize(T - dot(T, N) * N);","vec3 B = normalize(surf_binorm);","vec3 mapN = texture2D( clearCoatNormalMap, uv ).xyz * 2.0 - 1.0;","#ifdef DSPBR","#ifdef USE_CC_NORMAL_COEFFICIENTS","mapN = mapN * clearCoatNormalMulCoef + clearCoatNormalAddCoef;","#endif","mapN.z = abs(mapN.z);","#else","#ifdef CLEAR_COAT_NORMALMAPFLIPY","mapN.y = - mapN.y;","#endif","mapN.xy = clearCoatNormalScale * mapN.xy;","#endif","mat3 tbn = mat3(T, B, N);","return normalize(tbn * mapN);","}","#endif","#ifdef USE_ORANGE_PEEL","void orangePeelVisibility(in vec3 currentWorldNormal, out float peelMask, in float scaling, in vec3 worldPosition) {","mat3 mat = transposeMatrix(mat3(modelMatrix));","vec3 worldScaling = 1.0/vec3(length(mat[0]),length(mat[1]),length(mat[2]));","vec3 V = cameraPosition - worldPosition;","float dist = length(worldScaling * V);","V = normalize(V);","float NdotV = dot(currentWorldNormal, V);","float locality = (NdotV > 0.0) ? 1.0 : 0.0;","if (locality == 0.0) {","peelMask = 0.0;","return;","}","float normDist = saturate(scaling * dist * 0.00125);","float shortDist = saturate(1.0 - normDist);","peelMask = shortDist;","}","void doOrangePeel(vec3 currentWorldNormal, inout vec3 orangePeelWorldNormal, in vec3 worldPosition, in vec3 objectSpacePosition) {","float peelMask = 0.0;","float peelScaling = 0.01/max(orangePeelScale,1e-3);","orangePeelVisibility(currentWorldNormal, peelMask, peelScaling, worldPosition);","#ifdef DSPBR","float ccNScale = 1.0;","#ifdef USE_CC_NORMAL_COEFFICIENTS","ccNScale = saturate(vMax(clearCoatNormalMulCoef));","#endif","#else","float ccNScale = clearCoatNormalScale;","#endif","if (ccNScale < kEpsilon || peelMask < kEpsilon) {","return;","}","vec3 tex = peelScaling * objectSpacePosition;","tex.y = -abs(tex.y);","tex.x = -abs(tex.x);","float noise = FBM(tex);","vec3 peelNormal = vec3(noise);","orangePeelWorldNormal = normalize(orangePeelWorldNormal + 0.05 *ccNScale *peelMask* peelNormal);","}","#endif","#endif"].join("\n"),v=["#ifdef USE_SUBSURFACE","#ifdef USE_SSSLUT","#define maxSSSRadiusR 0.5 * maxTranslucencyDepth.x","#define minSSSRadiusR maxSSSRadiusR / 15.0","#define maxSSSRadiusG 0.5 * maxTranslucencyDepth.y","#define minSSSRadiusG maxSSSRadiusG / 15.0","#define maxSSSRadiusB 0.5 * maxTranslucencyDepth.z","#define minSSSRadiusB maxSSSRadiusB / 15.0","#define E_64_OVER_74 0.86486486486","#define E_66_OVER_74 0.89189189189","#define E_69_OVER_74 0.93243243243","#define E_71_OVER_74 0.95945945945","#define E_74_OVER_74 1.0","#define SINGLE_LINE_SAMPLING_LINEAR 0.5","vec4 SSSLUT = vec4(1.0,E_64_OVER_74, 0.0, 0.0);","vec4 SSSIBLLUT = vec4(1.0,E_69_OVER_74 - E_66_OVER_74, 0.0, E_66_OVER_74);","vec4 SSSTranslucencyLUT = vec4(1.0,E_74_OVER_74 - E_71_OVER_74, 0.0, E_71_OVER_74);","vec3 sampleSSSLUT(vec2 coord, vec4 factor) {","return texture2D(sssLUT, factor.xy * coord + factor.zw).xyz;","}","#endif","vec3 getScattering(in float NoL, in float c) {","float cNoL = affine(NoL,0.5,1.0);","#ifdef USE_SSSLUT","float rr = toTexCoord(1.0/c,minSSSRadiusR,maxSSSRadiusR);","float rg = toTexCoord(1.0/c,minSSSRadiusG,maxSSSRadiusG);","float rb = toTexCoord(1.0/c,minSSSRadiusB,maxSSSRadiusB);","vec2 coordR = vec2(cNoL,rr);","vec2 coordG = vec2(cNoL,rg);","vec2 coordB = vec2(cNoL,rb);","return vec3(sampleSSSLUT(coordR, SSSLUT).r,sampleSSSLUT(coordG, SSSLUT).g,sampleSSSLUT(coordB, SSSLUT).b);","#else","return vec3(saturate(NoL));","#endif","}","vec3 SssLUTSampling(in float c) {","#ifdef USE_SSSLUT","float rr = toTexCoord(1.0/c,minSSSRadiusR,maxSSSRadiusR);","float rg = toTexCoord(1.0/c,minSSSRadiusG,maxSSSRadiusG);","float rb = toTexCoord(1.0/c,minSSSRadiusB,maxSSSRadiusB);","vec2 coordR = vec2(rr,SINGLE_LINE_SAMPLING_LINEAR);","vec2 coordG = vec2(rg,SINGLE_LINE_SAMPLING_LINEAR);","vec2 coordB = vec2(rb,SINGLE_LINE_SAMPLING_LINEAR);","return vec3(sampleSSSLUT(coordR, SSSIBLLUT).r,sampleSSSLUT(coordG, SSSIBLLUT).g,sampleSSSLUT(coordB, SSSIBLLUT).b);","#else","return vec3(1.0);","#endif","}","vec3 GetTransmittance(in float s) {","#ifdef USE_SSSLUT","vec2 coordR = vec2(toTexCoord(s,0.0,maxTranslucencyDepth.x),SINGLE_LINE_SAMPLING_LINEAR);","vec2 coordG = vec2(toTexCoord(s,0.0,maxTranslucencyDepth.y),SINGLE_LINE_SAMPLING_LINEAR);","vec2 coordB = vec2(toTexCoord(s,0.0,maxTranslucencyDepth.z),SINGLE_LINE_SAMPLING_LINEAR);","return vec3(sampleSSSLUT(coordR, SSSTranslucencyLUT).r,sampleSSSLUT(coordG, SSSTranslucencyLUT).g,sampleSSSLUT(coordB, SSSTranslucencyLUT).b);","#else","return exp(-absorptionCoefficients * s);","#endif","}","#endif","#if defined(USE_SUBSURFACE) && (defined(USE_SHADOWMAP) || defined(USE_SHADOWMAP_CUBE) || defined(USE_THICKNESS))","#define TRANSMITTANCE","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","#define ONEOVER80 0.0125","#endif","#ifdef USE_SHADOWMAP","#define MAP_TRANSMITTANCE","#endif","#if MAX_DIR_IBL_LIGHTS > 0 && defined(USE_ENVMAP) && defined(USE_SUBSURFACE) && defined(MAP_TRANSMITTANCE)","#define USE_IBL_LIGHT","#endif","#ifdef USE_SHADOWMAP_CUBE","#define CUBE_TRANSMITTANCE","#endif","#if defined(MAP_TRANSMITTANCE) || defined(CUBE_TRANSMITTANCE)","#define DEPTHMAP_BASED_TRANSMITTANCE","#endif","#if defined(USE_THICKNESS)","#define THICKNESS_BASED_TRANSMITTANCE","#endif","#endif","#ifdef TRANSMITTANCE","#ifdef DEPTHMAP_BASED_TRANSMITTANCE","#define TRANS_PERFMODE 2","float _clipToEyePers(in float iNearPlane, in float iFarPlane, in float iZClipSpace)","{","return (2.0 * iNearPlane * iFarPlane) / (iFarPlane + iNearPlane - iZClipSpace * (iFarPlane - iNearPlane));","}","float _clipToEyeOrtho(in float iNearPlane, in float iFarPlane, in float iZClipSpace)","{","return 0.5 * ((iFarPlane - iNearPlane) * iZClipSpace + iFarPlane + iNearPlane);","}","float clipToEye(in float z, in vec2 lightInfo, in bool ortho)","{","return ortho ? _clipToEyeOrtho(lightInfo.x, lightInfo.y, z) : _clipToEyePers(lightInfo.x, lightInfo.y, z) ;","}","#if TRANS_PERFMODE == 0","#define TRANS_SAMPLE 64","#define TRANS_POISSON_DISK(i)  poisson64[i]","vec2 poisson64[64];","void initDisk() {","poisson64[0] = vec2(-0.934812, 0.366741);","poisson64[1] = vec2(-0.918943, -0.0941496);","poisson64[2] = vec2(-0.873226, 0.62389);","poisson64[3] = vec2(-0.8352, 0.937803);","poisson64[4] = vec2(-0.822138, -0.281655);","poisson64[5] = vec2(-0.812983, 0.10416);","poisson64[6] = vec2(-0.786126, -0.767632);","poisson64[7] = vec2(-0.739494, -0.535813);","poisson64[8] = vec2(-0.681692, 0.284707);","poisson64[9] = vec2(-0.61742, -0.234535);","poisson64[10] = vec2(-0.601184, 0.562426);","poisson64[11] = vec2(-0.607105, 0.847591);","poisson64[12] = vec2(-0.581835, -0.00485244);","poisson64[13] = vec2(-0.554247, -0.771111);","poisson64[14] = vec2(-0.483383, -0.976928);","poisson64[15] = vec2(-0.476669, -0.395672);","poisson64[16] = vec2(-0.439802, 0.362407);","poisson64[17] = vec2(-0.409772, -0.175695);","poisson64[18] = vec2(-0.367534, 0.102451);","poisson64[19] = vec2(-0.35313, 0.58153);","poisson64[20] = vec2(-0.341594, -0.737541);","poisson64[21] = vec2(-0.275979, 0.981567);","poisson64[22] = vec2(-0.230811, 0.305094);","poisson64[23] = vec2(-0.221656, 0.751152);","poisson64[24] = vec2(-0.214393, -0.0592364);","poisson64[25] = vec2(-0.204932, -0.483566);","poisson64[26] = vec2(-0.183569, -0.266274);","poisson64[27] = vec2(-0.123936, -0.754448);","poisson64[28] = vec2(-0.0859096, 0.118625);","poisson64[29] = vec2(-0.0610675, 0.460555);","poisson64[30] = vec2(-0.0234687, -0.962523);","poisson64[31] = vec2(-0.00485244, -0.373394);","poisson64[32] = vec2(0.0213324, 0.760247);","poisson64[33] = vec2(0.0359813, -0.0834071);","poisson64[34] = vec2(0.0877407, -0.730766);","poisson64[35] = vec2(0.14597, 0.281045);","poisson64[36] = vec2(0.18186, -0.529649);","poisson64[37] = vec2(0.188208, -0.289529);","poisson64[38] = vec2(0.212928, 0.063509);","poisson64[39] = vec2(0.23661, 0.566027);","poisson64[40] = vec2(0.266579, 0.867061);","poisson64[41] = vec2(0.320597, -0.883358);","poisson64[42] = vec2(0.353557, 0.322733);","poisson64[43] = vec2(0.404157, -0.651479);","poisson64[44] = vec2(0.410443, -0.413068);","poisson64[45] = vec2(0.413556, 0.123325);","poisson64[46] = vec2(0.46556, -0.176183);","poisson64[47] = vec2(0.49266, 0.55388);","poisson64[48] = vec2(0.506333, 0.876888);","poisson64[49] = vec2(0.535875, -0.885556);","poisson64[50] = vec2(0.615894, 0.0703452);","poisson64[51] = vec2(0.637135, -0.637623);","poisson64[52] = vec2(0.677236, -0.174291);","poisson64[53] = vec2(0.67626, 0.7116);","poisson64[54] = vec2(0.686331, -0.389935);","poisson64[55] = vec2(0.691031, 0.330729);","poisson64[56] = vec2(0.715629, 0.999939);","poisson64[57] = vec2(0.8493, -0.0485549);","poisson64[58] = vec2(0.863582, -0.85229);","poisson64[59] = vec2(0.890622, 0.850581);","poisson64[60] = vec2(0.898068, 0.633778);","poisson64[61] = vec2(0.92053, -0.355693);","poisson64[62] = vec2(0.933348, -0.62981);","poisson64[63] = vec2(0.95294, 0.156896);","}","#elif TRANS_PERFMODE == 1","#define TRANS_SAMPLE 32","#define TRANS_POISSON_DISK(i)  poisson32[i]","vec2 poisson32[TRANS_SAMPLE];","void initDisk() {","poisson32[0] = vec2(-0.975402, -0.0711386);","poisson32[1] = vec2(-0.920347, -0.41142);","poisson32[2] = vec2(-0.883908, 0.217872);","poisson32[3] = vec2(-0.884518, 0.568041);","poisson32[4] = vec2(-0.811945, 0.90521);","poisson32[5] = vec2(-0.792474, -0.779962);","poisson32[6] = vec2(-0.614856, 0.386578);","poisson32[7] = vec2(-0.580859, -0.208777);","poisson32[8] = vec2(-0.53795, 0.716666);","poisson32[9] = vec2(-0.515427, 0.0899991);","poisson32[10] = vec2(-0.454634, -0.707938);","poisson32[11] = vec2(-0.420942, 0.991272);","poisson32[12] = vec2(-0.261147, 0.588488);","poisson32[13] = vec2(-0.211219, 0.114841);","poisson32[14] = vec2(-0.146336, -0.259194);","poisson32[15] = vec2(-0.139439, -0.888668);","poisson32[16] = vec2(0.0116886, 0.326395);","poisson32[17] = vec2(0.0380566, 0.625477);","poisson32[18] = vec2(0.0625935, -0.50853);","poisson32[19] = vec2(0.125584, 0.0469069);","poisson32[20] = vec2(0.169469, -0.997253);","poisson32[21] = vec2(0.320597, 0.291055);","poisson32[22] = vec2(0.359172, -0.633717);","poisson32[23] = vec2(0.435713, -0.250832);","poisson32[24] = vec2(0.507797, -0.916562);","poisson32[25] = vec2(0.545763, 0.730216);","poisson32[26] = vec2(0.56859, 0.11655);","poisson32[27] = vec2(0.743156, -0.505173);","poisson32[28] = vec2(0.736442, -0.189734);","poisson32[29] = vec2(0.843562, 0.357036);","poisson32[30] = vec2(0.865413, 0.763726);","poisson32[31] = vec2(0.872005, -0.927);","}","#else","#define TRANS_SAMPLE 25","#define TRANS_POISSON_DISK(i)  poisson25[i]","vec2 poisson25[TRANS_SAMPLE];","void initDisk() {","poisson25[0] = vec2(-0.978698, -0.0884121);","poisson25[1] = vec2(-0.841121, 0.521165);","poisson25[2] = vec2(-0.71746, -0.50322);","poisson25[3] = vec2(-0.702933, 0.903134);","poisson25[4] = vec2(-0.663198, 0.15482);","poisson25[5] = vec2(-0.495102, -0.232887);","poisson25[6] = vec2(-0.364238, -0.961791);","poisson25[7] = vec2(-0.345866, -0.564379);","poisson25[8] = vec2(-0.325663, 0.64037);","poisson25[9] = vec2(-0.182714, 0.321329);","poisson25[10] = vec2(-0.142613, -0.0227363);","poisson25[11] = vec2(-0.0564287, -0.36729);","poisson25[12] = vec2(-0.0185858, 0.918882);","poisson25[13] = vec2(0.0381787, -0.728996);","poisson25[14] = vec2(0.16599, 0.093112);","poisson25[15] = vec2(0.253639, 0.719535);","poisson25[16] = vec2(0.369549, -0.655019);","poisson25[17] = vec2(0.423627, 0.429975);","poisson25[18] = vec2(0.530747, -0.364971);","poisson25[19] = vec2(0.566027, -0.940489);","poisson25[20] = vec2(0.639332, 0.0284127);","poisson25[21] = vec2(0.652089, 0.669668);","poisson25[22] = vec2(0.773797, 0.345012);","poisson25[23] = vec2(0.968871, 0.840449);","poisson25[24] = vec2(0.991882, -0.657338);","}","#endif","#ifdef MAP_TRANSMITTANCE","float getDepthValue(in sampler2D shadowMap, in vec2 coord) {","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","return 2.0 * (ONEOVER80*log(unpackDepthESM(texture2D(shadowMap, coord)))) - 1.0;","#else","return 2.0*unpackDepth(texture2D(shadowMap, coord) ) - 1.0;","#endif","}","vec3 multiSampleTransmittance(in vec4 shadowMapCoord, in vec2 shadowNearFar, in vec2 shadowMapSize, in sampler2D shadowMap, in bool ortho) {","vec3 depthMapCoord = shadowMapCoord.xyz/shadowMapCoord.w;","vec2 currentCoord;","float currentDepth = clipToEye(2.0*depthMapCoord.z-1.0,shadowNearFar, ortho);","float s = max( currentDepth - clipToEye( getDepthValue(shadowMap,depthMapCoord.xy),shadowNearFar, ortho),0.0);","vec2 multiplier = saturate(vec2(2.0 / shadowMapSize));","for (int i = 0; i < TRANS_SAMPLE; i++) {","vec2 offset =  multiplier* TRANS_POISSON_DISK(i);","currentCoord.xy = saturate(depthMapCoord.xy + offset);","float depth = getDepthValue(shadowMap,currentCoord.xy);","s += max( currentDepth - clipToEye(depth,shadowNearFar, ortho),0.0);","}","return GetTransmittance(s / float(TRANS_SAMPLE + 1));","}","#endif","#ifdef CUBE_TRANSMITTANCE","float getCubeDepthValue(in samplerCube shadowCubeMap, in vec3 coord) {","#if defined(SHADOWMAP_TYPE_ESM) || defined(SHADOWMAP_TYPE_ESM_IMPROVED) ","return 2.0 * (ONEOVER80*log(unpackDepthESM(textureCube(shadowCubeMap, coord)))) - 1.0;","#else","return 2.0*unpackDepth(textureCube(shadowCubeMap, coord) ) - 1.0;","#endif","}","vec3 multiSampleCubeTransmittance(in vec3 worldPos, in vec3 lightPosition, in vec2 shadowNearFar, in float shadowCubeSize, in samplerCube shadowCube, in bool ortho) {","vec3 pointVector = worldPos.xyz - lightPosition.xyz;","vec3 absVector = abs(pointVector);","float localZComp = max(absVector.x,max(absVector.y,absVector.z));","float normZComp = (shadowNearFar.y + shadowNearFar.x) / (shadowNearFar.y - shadowNearFar.x) - (2.0 * shadowNearFar.y * shadowNearFar.x) / (shadowNearFar.y - shadowNearFar.x) / localZComp;","normZComp = (normZComp + 1.0) * 0.5;","vec3 cubeMapCoord = normalize( pointVector );","float currentDepth = length(pointVector);","float s = max( currentDepth - clipToEye( getCubeDepthValue(shadowCube,cubeMapCoord),shadowNearFar, ortho),0.0);","float pixelSize = 4.0 / shadowCubeSize;","vec3 right = getGeomT(cubeMapCoord.xyz) * pixelSize;","vec3 up = getGeomB(cubeMapCoord.xyz, right) * pixelSize;","vec3 currentCoord;","for (int i = 0; i < TRANS_SAMPLE; i++) {","vec2 offset =  TRANS_POISSON_DISK(i);","currentCoord = normalize(cubeMapCoord + offset.x * right + offset.y * up);","float depth = getCubeDepthValue(shadowCube,currentCoord);","s += max( currentDepth - clipToEye(depth,shadowNearFar, ortho),0.0);","}","return GetTransmittance(s / float(TRANS_SAMPLE + 1));","}","#endif","#endif","#endif"].join("\n"),S=function(){return["vec3 Lt = L - 2.0 * dot(L,N) * N;","float NoLt = saturate(dot(N, Lt));","vec3 brdf = DiffuseLambertBRDF(color);","#ifdef SPECGLOSS","float NoV = saturate(dot(N,V));","float fTrans = SpecGlossEnergyConservationTerm(NoLt, NoV, materialData.sr0Color,materialData.sr90Color);","#else","float fTrans = materialData.diffuseEnergyConservationConstant;","#endif"].join("\n")},_=function(){return["vec3 Lt = L - 2.0 * dot(L,N) * N;","float NoLt = saturate(dot(N,Lt));","float NoV = saturate(dot(N,V));","#ifndef THIN_WALLED","vec3 Ht = normalize(Lt * materialData.ior +V);","float NoHt = saturate(dot(N,Ht));","float VoHt = saturate(dot(V,Ht));","float LtoHt = saturate(dot(Lt,Ht));","#ifdef USE_ANISOTROPY","float rX = materialData.roughness;","float rY = rX * (1.0 - materialData.anisotropy);","vec3 brdf = color * TransmissionAnisoBRDF(rX, rY, NoV, NoLt, NoHt, VoHt, LtoHt, N, Ht, surfaceData.tangent, surfaceData.binormal, materialData.anisotropyAngle);","#else","vec3 brdf = color * TransmissionBRDF(materialData.roughness, NoV, NoLt, NoHt, VoHt, LtoHt);","#endif","#else","vec3 Ht = normalize(Lt+V);","float NoHt = saturate(dot(N,Ht));","float VoHt = saturate(dot(V,Ht));","#ifdef USE_ANISOTROPY","float rX = materialData.roughness;","float rY = rX * (1.0 - materialData.anisotropy);","vec3 brdf = color * SpecularAnisoBRDF(rX, rY, NoV, NoLt, NoHt, N, Ht, surfaceData.tangent, surfaceData.binormal, materialData.anisotropyAngle );","#else","vec3 brdf = color * SpecularBRDF(materialData.roughness, NoV, NoLt, NoHt);","#endif","#endif","#ifdef DSPBR","float fTrans = (1.0 - materialData.specularContribution * vMax(FresnelSchlick(materialData.specularBlendingSR0, vec3(1.0), VoHt)));","#else","vec3 sr0Color = materialData.sr0Color;","vec3 sr90Color = materialData.sr90Color;","float fTrans = (1.0 - vMax(FresnelSchlick(sr0Color, sr90Color, VoHt)));","#endif"].join("\n")},y=["#ifdef USE_IRIDESCENCE","const mat3 XYZ_TO_REC709 = mat3(","3.2404542, -0.9692660,  0.0556434,","-1.5371385,  1.8760108, -0.2040259,","-0.4985314,  0.0415560,  1.0572252",");","vec3 evalSensitivity(float OPD, vec3 shift) {","float phase = 2.0 * PI * OPD * 1.0e-9;","vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);","vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);","vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);","vec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow2(phase) * var);","xyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow2(phase));","xyz /= 1.0685e-7;","vec3 rgb = XYZ_TO_REC709 * xyz;","return rgb;","}","float IoRToFresnel0( float transmittedIoR, float incidentIoR ) {","return pow2( (transmittedIoR - incidentIoR) / (transmittedIoR + incidentIoR) );","}","vec3 IoRToFresnel0( vec3 transmittedIoR, float incidentIoR ) {","return vec3(IoRToFresnel0(transmittedIoR.r, incidentIoR), IoRToFresnel0(transmittedIoR.g, incidentIoR), IoRToFresnel0(transmittedIoR.b, incidentIoR));","}","vec3 Fresnel0ToIoR( vec3 fresnel0 ) {","vec3 sqrtF0 = sqrt( fresnel0 );","return ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );","}","vec3 computeIridescence(in float outsideIoR, in float iridescenceIoR, in vec3 sr0Color, in float iridescenceThickness, in float cosTheta1) {","float sinTheta2Sq = pow2( outsideIoR / iridescenceIoR ) * ( 1.0 - pow2( cosTheta1 ) );","float cosTheta2Sq = 1.0 - sinTheta2Sq;","if ( cosTheta2Sq < 0.0 ) {","return vec3( 1.0 );","}","float cosTheta2 = sqrt(cosTheta2Sq);","float R0 = IoRToFresnel0(iridescenceIoR, outsideIoR);","float R12 = FresnelSchlick(R0, 1.0, cosTheta1);","float R21 = R12;","float T121 = 1.0 - R12;","float phi12 = 0.0;","if (iridescenceIoR < outsideIoR) phi12 = PI;","float phi21 = PI - phi12;","vec3 baseIoR = Fresnel0ToIoR(sr0Color + 1e-6);","vec3 R1 = IoRToFresnel0(baseIoR, iridescenceIoR);","vec3 R23 = FresnelSchlick(R1, vec3(1.0), cosTheta2);","vec3 phi23 = vec3(0.0);","if (baseIoR.x < iridescenceIoR) phi23.x = PI;","if (baseIoR.y < iridescenceIoR) phi23.y = PI;","if (baseIoR.z < iridescenceIoR) phi23.z = PI;","float OPD = 2.0 * iridescenceIoR * iridescenceThickness * cosTheta2;","vec3 phi = vec3( phi21 ) + phi23;","vec3 R123 = clamp( R12 * R23, 1e-6, 1.0 - 1e-6 );","vec3 r123 = sqrt( R123 );","vec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );","vec3 C0 = R12 + Rs;","vec3 I = C0;","vec3 Cm = Rs - T121;","for (int m = 1; m <= 2; ++m) {","Cm *= r123;","vec3 Sm = 2.0 * evalSensitivity(float(m) * OPD, float(m) * phi);","I += Cm * Sm;","}","return max(I, vec3(0.0));","}","#endif"].join("\n"),x=["vec3 DiffuseLambertBRDF(vec3 diffuseColor) {","return (diffuseColor * INV_PI);","}","#ifdef USE_SPECULAR_AA","vec2 AxisAlignedNDFFiltering(vec3 halfvectorTS, vec2 roughness2) {","vec2 halfvector2D = halfvectorTS.xy;","vec2 bounds = fwidth(halfvector2D);","float SIGMA2 = 0.15915494;","vec2 kernelRoughness2 = 2.0 * SIGMA2 * (bounds * bounds);","float KAPPA = 0.18;","vec2 clampedKernelRoughness2 = min(kernelRoughness2, KAPPA);","vec2 filteredRoughness2 = saturate(roughness2 + clampedKernelRoughness2);","return filteredRoughness2;","}","#endif","#if defined(USE_ANISOTROPY) || defined(USE_SPECULAR_AA)","float TransmissionAnisoBRDF(in float roughnessX, in float roughnessY, in float NoV, in float NoL, in float NoH, in float VoH, in float LoH, in vec3 iNormal, in vec3 H, in vec3 iTangent, in vec3 iBinormal, in float iAnisotropyAngle) {","float ior2 = materialData.ior * materialData.ior;","float coeff = abs(LoH * VoH) / max(abs(NoL*NoV),1e-3);","coeff *= ior2;","coeff /= materialData.ior * LoH + ior2 *VoH*VoH;","float distrib = AnisotropicDistributionGGX(iTangent, iBinormal, iNormal, H, NoH, roughnessX, roughnessY, iAnisotropyAngle);","float geomVis = AnisotropicGGXVisibility( roughnessX, roughnessY, NoV, NoL, iAnisotropyAngle);","return coeff*distrib*geomVis;","}","float SpecularAnisoBRDF(in float roughnessX, in float roughnessY, in float NoV, in float NoL, in float NoH, in vec3 iNormal, in vec3 H, in vec3 iTangent, in vec3 iBinormal, in float iAnisotropyAngle) {","float distrib = AnisotropicDistributionGGX(iTangent, iBinormal, iNormal, H, NoH, roughnessX, roughnessY, iAnisotropyAngle);","float geomVis = AnisotropicGGXVisibility( roughnessX, roughnessY, NoV, NoL, iAnisotropyAngle);","return distrib*geomVis;","}","#endif","#if defined(USE_ANISOTROPY)","void coreModelAniso(inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L) {","float r = materialData.roughness;","vec3 sr0Color = materialData.sr0Color;","vec3 sr90Color = materialData.sr90Color;","float NoL = saturate(dot(N,L));","float NoV = saturate(dot(N,V));","vec3 H = normalize(L+V);","float NoH = saturate(dot(N,H));","float VoH = saturate(dot(V,H));","float rX = r;","float rY = r * (1.0 - materialData.anisotropy);","specular = FresnelSchlick(sr0Color, sr90Color, VoH);","#ifdef USE_SPECULAR_AA","mat3 TBN = surfaceData.TBNMatrixForSpecularAA;","vec3 Htbn = TBN * H;","vec2 roughnesses = AxisAlignedNDFFiltering(Htbn, vec2(rX, rY));","specular *= SpecularAnisoBRDF(roughnesses.x, roughnesses.y, NoV, NoL, NoH, N, H, surfaceData.tangent, surfaceData.binormal, materialData.anisotropyAngle);","#else","specular *= SpecularAnisoBRDF(rX, rY, NoV, NoL, NoH, N, H, surfaceData.tangent, surfaceData.binormal, materialData.anisotropyAngle);","#endif","#ifdef DSPBR","diffuse = DiffuseLambertBRDF(materialData.diffuseColor) * materialData.diffuseEnergyConservationConstant;","specular += DiffuseLambertBRDF(materialData.specularEnergyConservationConstant);","#else","diffuse = DiffuseLambertBRDF(materialData.diffuseColor) * SpecGlossEnergyConservationTerm(NoL, NoV, sr0Color, sr90Color);","#endif","}","#endif","float SpecularBRDF(in float roughness, in float NoV, in float NoL, in float NoH) {","float distrib = DistributionGGX( roughness, NoH);","float geomVis = GGXVisibility( roughness, NoV, NoL);","return distrib*geomVis;","}","float TransmissionBRDF(in float roughness, in float NoV, in float NoL, in float NoH, in float VoH, in float LoH) {","float ior2 = pow2(materialData.ior);","float coeff = abs(LoH * VoH) / (max(abs(NoL), 1e-3) * max(abs(NoV),1e-3));","coeff *= ior2;","coeff /= max(pow2(materialData.ior*LoH + VoH), 1e-3);","float distrib = DistributionGGX( roughness, NoH);","float geomVis = GeometricSchlick( roughness, NoV, NoL);","return coeff*distrib*geomVis;","}","void coreModel(inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L) {","vec3 sr0Color = materialData.sr0Color;","vec3 sr90Color = materialData.sr90Color;","float NoL = saturate(dot(N,L));","float NoV = saturate(dot(N,V));","vec3 H = normalize(L+V);","float NoH = saturate(dot(N,H));","float VoH = saturate(dot(V,H));","specular = FresnelSchlick(sr0Color, sr90Color, VoH);","#ifdef USE_SPECULAR_AA","mat3 TBN = surfaceData.TBNMatrixForSpecularAA;","vec3 Htbn = TBN * H;","vec2 roughnesses = AxisAlignedNDFFiltering(Htbn, vec2(materialData.roughness, materialData.roughness));","specular *= SpecularAnisoBRDF(roughnesses.x, roughnesses.y, NoV, NoL, NoH, N, H, surfaceData.TForSpecularAA, surfaceData.BForSpecularAA, 0.0);","#else","specular *= SpecularBRDF(materialData.roughness, NoV, NoL, NoH) ;","#endif","#ifdef DSPBR","diffuse = DiffuseLambertBRDF(materialData.diffuseColor) * materialData.diffuseEnergyConservationConstant;","specular += DiffuseLambertBRDF(materialData.specularEnergyConservationConstant);","#else","diffuse = DiffuseLambertBRDF(materialData.diffuseColor) * SpecGlossEnergyConservationTerm(NoL, NoV, sr0Color, sr90Color);","#endif","}","vec3 TranslucencyDiffuseModel(in vec3 N, in vec3 L, in vec3 V, in vec3 color) {",S(),"return NoLt * brdf * fTrans;","}","vec3 TranslucencySpecularModel(in vec3 N, in vec3 L, in vec3 V, in vec3 color) {",_(),"return brdf * NoLt * fTrans;","}","vec3 _TranslucencySpecularModel(in vec3 N, in vec3 L, in vec3 V, in vec3 color) {",_(),"return brdf * fTrans;","}","vec3 _TranslucencyDiffuseModel(in vec3 N, in vec3 L, in vec3 V, in vec3 color) {",S(),"return brdf * fTrans;","}"].join("\n"),M=["struct areaLightingData","{","mat3 Minv;","vec2 fresnel;","#ifdef CLEAR_COAT","mat3 MinvCC;","vec2 fresnelCC;","#endif","#ifdef USE_SHEEN","mat3 MinvSheen;","#endif","#ifdef USE_SPECGLOSS_FLAKES","mat3 MinvMetal;","vec2 fresnelMetal;","mat3 MinvMetalFlakes;","vec2 fresnelMetalFlakes;","#ifdef PEARL_FLAKES_ACTIVATED","mat3 MinvPearlFlakes;","vec2 fresnelPearlFlakes;","#endif","#endif","#ifdef USE_DSPBR_FLAKES","mat3 MinvMetal;","vec2 fresnelMetal;","mat3 MinvMetalSto;","vec2 fresnelMetalSto;","mat3 MinvMetalClose;","vec2 fresnelMetalClose;","#endif","};","areaLightingData areaData;","#define LUT_SIZE 64.0","#define LUT_SCALE (LUT_SIZE - 1.0)/LUT_SIZE","#define LUT_BIAS 0.5/LUT_SIZE","#ifdef USE_SHEEN","void setAreaSheenData(in float roughness, in float NoV, out mat3 Minv) {","vec2 uvAr = vec2(roughness, 1.0 - sqrt(1.0 - NoV)) * LUT_SCALE + LUT_BIAS;","#if defined(USE_VELVET)","vec4 t1 = texture2D(precomputedAreaAshikmintexture, uvAr);","#endif","#if defined(USE_SOFT_VELVET)","vec4 t1 = texture2D(precomputedAreaEsteveztexture, uvAr);","#endif","#if defined(USE_SATIN)","vec4 t1 = texture2D(precomputedAreaBeckmanntexture, uvAr);","#endif","Minv = mat3(","vec3(t1.x,  0, t1.y),","vec3(  0, 1.0,   0),","vec3(t1.z,  0, t1.w)",");","}","#endif","void setAreaGGXData(in float roughness, in float NoV, out vec2 fresnel, out mat3 Minv) {","vec2 uvAr = vec2(roughness, 1.0 - sqrt(1.0 - NoV)) * LUT_SCALE + LUT_BIAS;","vec4 t1 = texture2D(precomputedAreaGGX1texture, uvAr);","vec4 t2 = texture2D(precomputedAreaGGX2texture, uvAr);","Minv = mat3(","vec3(t1.x,  0, t1.y),","vec3(  0, 1.0,   0),","vec3(t1.z,  0, t1.w)",");","fresnel = vec2(t2.z,t2.y);","}","vec3 IntegrateEdgeVec(in vec3 v1, in vec3 v2)","{","float x = dot(v1, v2);","float y = abs(x);","float a = 0.8543985 + (0.4965155 + 0.0145206*y)*y;","float b = 3.4175940 + (4.1616724 + y)*y;","float v = a / b;","float theta_sintheta = (x > 0.0) ? v : 0.5*inversesqrt(1.0 - x*x) - v;","return cross(v1, v2)*theta_sintheta;","}","float areaRectangleLight(in vec3 N, in vec3 V, in vec3 P,in mat3 Minv, in vec3 p0, in vec3 p1, in vec3 p2, in vec3 p3) {","vec3 dir = p0 - P;","vec3 lightNormal = cross(p1 - p0, p3 - p0);","bool behind = (dot(dir, lightNormal) < 0.0);","if (behind) {","return 0.0;","}","vec3 T = normalize(V-N*dot(V,N));","vec3 B = cross(N,T);","mat3 M = Minv*transposeMatrix(mat3(T,B,N));","vec3 L[4];","L[0] = normalize(M * (p0 - P));","L[1] = normalize(M * (p1 - P));","L[2] = normalize(M * (p2 - P));","L[3] = normalize(M * (p3 - P));","vec3 F = IntegrateEdgeVec(L[0], L[1]);","F += IntegrateEdgeVec(L[1], L[2]);","F += IntegrateEdgeVec(L[2], L[3]);","F += IntegrateEdgeVec(L[3], L[0]);","float formFactor = length(F);","float z = F.z/formFactor;","vec2 uv = vec2(z*0.5 + 0.5, 1.0 - formFactor);","uv = uv*LUT_SCALE + LUT_BIAS;","float scale = texture2D(precomputedAreaGGX2texture, uv).w;","return saturate(scale * formFactor);","}","vec3 SolveCubic(vec4 Coefficient) {","Coefficient.xyz /= Coefficient.w;","Coefficient.yz /= 3.0;","float A = Coefficient.w;","float B = Coefficient.z;","float C = Coefficient.y;","float D = Coefficient.x;","vec3 Delta = vec3(","-Coefficient.z*Coefficient.z + Coefficient.y,","-Coefficient.y*Coefficient.z + Coefficient.x,","dot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)",");","float Discriminant = dot(vec2(4.0*Delta.x, -Delta.y), Delta.zy);","vec3 RootsA, RootsD;","vec2 xlc, xsc;","{","float A_a = 1.0;","float C_a = Delta.x;","float D_a = -2.0*B*Delta.x + Delta.y;","float Theta = atan(sqrt(Discriminant), -D_a)/3.0;","float x_1a = 2.0*sqrt(-C_a)*cos(Theta);","float x_3a = 2.0*sqrt(-C_a)*cos(Theta + (2.0/3.0)*3.14159265);","float xl;","if ((x_1a + x_3a) > 2.0*B)","xl = x_1a;","else","xl = x_3a;","xlc = vec2(xl - B, A);","}","{","float A_d = D;","float C_d = Delta.z;","float D_d = -D*Delta.y + 2.0*C*Delta.z;","float Theta = atan(D*sqrt(Discriminant), -D_d)/3.0;","float x_1d = 2.0*sqrt(-C_d)*cos(Theta);","float x_3d = 2.0*sqrt(-C_d)*cos(Theta + (2.0/3.0)*3.14159265);","float xs;","if (x_1d + x_3d < 2.0*C)","xs = x_1d;","else","xs = x_3d;","xsc = vec2(-D, xs + C);","}","float E =  xlc.y*xsc.y;","float F = -xlc.x*xsc.y - xlc.y*xsc.x;","float G =  xlc.x*xsc.x;","vec2 xmc = vec2(C*F - B*G, -B*F + C*E);","vec3 Root = vec3(xsc.x/xsc.y, xmc.x/xmc.y, xlc.x/xlc.y);","if (Root.x < Root.y && Root.x < Root.z)","Root.xyz = Root.yxz;","else if (Root.z < Root.x && Root.z < Root.y)","Root.xyz = Root.xzy;","return Root;","}","float areaDiskLight(vec3 N, vec3 V, vec3 P, mat3 Minv, vec3 p0, vec3 p1, vec3 p2) {","vec3 T = normalize(V-N*dot(V,N));","vec3 B = cross(N,T);","mat3 R = transposeMatrix(mat3(T, B, N));","vec3 L[3];","L[0] = R * (p0 - P);","L[1] = R * (p1 - P);","L[2] = R * (p2 - P);","vec3 c  = Minv *(0.5 * (L[0] + L[2]));","vec3 v1 = Minv *(0.5 * (L[1] - L[2]));","vec3 v2 = Minv *(0.5 * (L[1] - L[0]));","if(dot(cross(v1, v2), c) < 0.0)","return 0.0;","float a, b;","float d11 = dot(v1, v1);","float d22 = dot(v2, v2);","float d12 = dot(v1, v2);","if (abs(d12)/sqrt(d11*d22) > 0.005) {","float tr = d11 + d22;","float det = -d12*d12 + d11*d22;","det = sqrt(det);","float u = 0.5*sqrt(tr - 2.0*det);","float v = 0.5*sqrt(tr + 2.0*det);","float e_max = pow2(u + v);","float e_min = pow2(u - v);","vec3 v1_, v2_;","if (d11 > d22) {","v1_ = d12*v1 + (e_max - d11)*v2;","v2_ = d12*v1 + (e_min - d11)*v2;","}","else {","v1_ = d12*v2 + (e_max - d22)*v1;","v2_ = d12*v2 + (e_min - d22)*v1;","}","a = 1.0 / e_max;","b = 1.0 / e_min;","v1 = normalize(v1_);","v2 = normalize(v2_);","}","else {","a = 1.0 / dot(v1, v1);","b = 1.0 / dot(v2, v2);","v1 *= sqrt(a);","v2 *= sqrt(b);","}","vec3 v3 = normalize(cross(v1, v2));","if (dot(c, v3) < 0.0)","v3 *= -1.0;","float L_  = dot(v3, c);","float x0 = dot(v1, c) / L_;","float y0 = dot(v2, c) / L_;","float E1 = inversesqrt(a);","float E2 = inversesqrt(b);","a *= L_*L_;","b *= L_*L_;","float c0 = a*b;","float c1 = a*b*(1.0 + x0*x0 + y0*y0) - a - b;","float c2 = 1.0 - a*(1.0 + x0*x0) - b*(1.0 + y0*y0);","float c3 = 1.0;","vec3 roots = SolveCubic(vec4(c0, c1, c2, c3));","float e1 = roots.x;","float e2 = roots.y;","float e3 = roots.z;","vec3 avgDir = vec3(a*x0/(a - e2), b*y0/(b - e2), 1.0);","mat3 rotate = mat3(v1, v2, v3);","avgDir = rotate*avgDir;","avgDir = normalize(avgDir);","float L1 = sqrt(-e2/e3);","float L2 = sqrt(-e2/e1);","float formFactor = L1*L2*inversesqrt((1.0 + L1*L1)*(1.0 + L2*L2));","vec2 uv = vec2(avgDir.z*0.5 + 0.5, 1.0 - formFactor);","uv = uv*LUT_SCALE + LUT_BIAS;","float scale = texture2D(precomputedAreaGGX2texture, uv).w;","float res = formFactor*scale;","return saturate(res);","}","void getSphereLightPoints(inout vec3 lP, in vec3 P, in float radius, out vec3 p0, out vec3 p1, out vec3 p2) {","vec3 toUse = vNormalize(P - lP);","lP += radius * toUse;","vec3 right = getGeomT(toUse.xyz);","vec3 up = getGeomB(toUse.xyz, right);","p0 = lP.xyz + right * radius - up * radius;","p1 = lP.xyz - right * radius - up * radius;","p2 = lP.xyz - right * radius + up * radius;","}","vec3 getSpecularDominantDir(in vec3 N, in vec3 R, in float r){","return normalize(mix(N, R, 1.0-r));","}","float solidAngleRect(in vec3 viewPos, in vec3 p0, in vec3 p1, in vec3 p2, in vec3 p3) {","vec3 v0 = p0 - viewPos;","vec3 v1 = p1 - viewPos;","vec3 v2 = p2 - viewPos;","vec3 v3 = p3 - viewPos;","vec3 n0 = normalize(cross(v0,v1));","vec3 n1 = normalize(cross(v1,v2));","vec3 n2 = normalize(cross(v2,v3));","vec3 n3 = normalize(cross(v3,v0));","float g0 = acos(dot(-n0,n1));","float g1 = acos(dot(-n1,n2));","float g2 = acos(dot(-n2,n3));","float g3 = acos(dot(-n3,n0));","return g0 + g1 + g2 + g3 - 2.0 * 3.14159;","}","vec3 closestOnLine(in vec3 a, in vec3 b, in vec3 c) {","vec3 ab = b - a;","float t = dot(c - a , ab) / dot(ab,ab);","return a + t * ab;","}","vec3 closestOnSegment(in vec3 a, in vec3 b, in vec3 c) {","vec3 ab = b - a;","float t = dot(c - a, ab) / dot(ab,ab);","return a + saturate(t) * ab;","}","vec3 closestPointSphere(in vec3 L, in vec3 R, in float radius) {","vec3 centerToRay = dot(L, R) * R - L;","vec3 closestPoint = L + centerToRay * saturate(radius / length(centerToRay));","return normalize(closestPoint);","}","vec3 closestPointTube(in vec3 P0, in vec3 P1,in vec3 N, in vec3 R, in vec3 P, in vec3 Lp, in float radius) {","vec3 L0 = P0 - P;","vec3 L1 = P1 - P;","vec3 Ld = L1 - L0;","float coeff = dot(R,L0)*dot(R,Ld) - dot(L0,Ld);","coeff /= dot(Ld,Ld) - pow2(dot(R,Ld));","vec3 L = L0 + saturate(coeff) * Ld;","return closestPointSphere(L,R,radius);","}","float cropRectangleLight(in vec3 lP, in vec3 p0, in vec3 p1, in vec3 p2, in vec3 p3, in vec3 P, in vec3 N) {","float A = dot(vNormalize(lP - P), N);","float B = dot(vNormalize(p0 - P), N);","float C = dot(vNormalize(p1 - P), N);","float D = dot(vNormalize(p2 - P), N);","float E = dot(vNormalize(p3 - P), N);","return max(A, max(B, max(C, max(D,E)))) <= 1e-6 ? 0.0 : 1.0;","}","float cropDiskLight(in vec3 lP, in vec3 p0, in vec3 p1, in vec3 P, in vec3 N) {","vec3 p2 = lP - (p0 - lP);","vec3 p3 = lP - (p1 - lP);","return cropRectangleLight(lP, p0, p1, p2, p3, P, N);","}"].join("\n"),P=function(e,t){return["#ifdef USE_SUBSURFACE","#ifdef SPECGLOSS","diffuse *= materialData.scatteringColor;","#else","vec3 baseDiffuseValue = diffuse;","#ifdef DSPBR_WITH_TRANSLUCENCY","diffuse = mix(diffuse, materialData.scatteringColor * baseDiffuseValue, materialData.translucency);","#endif","diffuse = mix(diffuse, materialData.scatteringColor * baseDiffuseValue, materialData.transparency);","#endif","#ifdef THICKNESS_BASED_TRANSMITTANCE","vec3 attenuation = materialData.transmittanceColor;","#ifdef DSPBR_WITH_TRANSLUCENCY","transmissive = materialData.translucency * materialData.translucencyColor * attenuation * "+e+"(-N,V,P,mat3(1.0), "+t+") * materialData.diffuseEnergyConservationConstant;","#endif","#ifdef DSPBR","float fTrans = 1.0 - materialData.specularContribution * vMax(materialData.specularBlendingSR0 * areaData.fresnel.x + areaData.fresnel.y);","#else","float fTrans = 1.0 - vMax(fresnelCore);","#endif","transmissive += attenuation * materialData.transparentColor * fTrans * "+e+"(-N,coreView,P,areaData.Minv, "+t+");","#endif","#elif defined(DSPBR_WITH_TRANSLUCENCY)","diffuse *= (1.0 - materialData.translucency);","transmissive = materialData.translucency * materialData.translucencyColor * "+e+"(-N,V,P,mat3(1.0), "+t+") * materialData.diffuseEnergyConservationConstant;","#endif"].join("\n")},C=function(e,t){return["#ifdef USE_SPECGLOSS_FLAKES","vec3 fresnelMetal = metalFlakes.flakesSR0Color * areaData.fresnelMetalFlakes.x;","vec3 flakesVal = fresnelMetal;","flakesVal *= "+e+"(N,V,P,areaData.MinvMetalFlakes, "+t+");","float energyFlakes = SpecGlossEnergyConservationTerm(fresnelMetal);","specular *= energyFlakes;","diffuse *= energyFlakes;","transmissive *= energyFlakes;","specular += flakesVal;","fresnelMetal = metal.flakesSR0Color * areaData.fresnelMetal.x;","flakesVal = fresnelMetal;","flakesVal *= "+e+"(N,V,P,areaData.MinvMetal, "+t+");","energyFlakes = SpecGlossEnergyConservationTerm(fresnelMetal);","specular *= energyFlakes;","diffuse *= energyFlakes;","transmissive *= energyFlakes;","specular += flakesVal;","#ifdef PEARL_FLAKES_ACTIVATED","fresnelMetal = pearlFlakes.flakesSR0Color * areaData.fresnelPearlFlakes.x;","flakesVal = fresnelMetal;","flakesVal *= "+e+"(N,V,P,areaData.MinvPearlFlakes, "+t+");","energyFlakes = SpecGlossEnergyConservationTerm(fresnelMetal);","specular *= energyFlakes;","diffuse *= energyFlakes;","transmissive *= energyFlakes;","specular += flakesVal;","#endif","#endif"].join("\n")},b=function(e,t){return["#ifdef USE_DSPBR_FLAKES","vec3 flakesVal = vec3(0.0);","if (flakesData.smoothWeight > 0.0) {","flakesVal += flakesData.smoothFlakesColor * "+e+"(N,V,P,areaData.MinvMetal, "+t+");","}","if (flakesData.stochasticWeight > 0.0) {","vec3 normalStoFlakes = flakesData.stochasticHemisphereFlakesNormal;","flakesVal += flakesData.stochasticHemisphereFlakesColor * "+e+"(normalStoFlakes,V,P,areaData.MinvMetalSto, "+t+");","}","if (flakesData.closeupWeight > 0.0) {","vec3 normalCloseUpFlakes = flakesData.closeupFlakesNormal;","flakesVal += flakesData.closeupFlakesColor * "+e+"(normalCloseUpFlakes,V,P,areaData.MinvMetalClose, "+t+");","}","diffuse *= flakesData.baseWeight;","specular *= flakesData.baseWeight;","transmissive *= flakesData.baseWeight;","specular += flakesVal;","#endif"].join("\n")},D=function(e,t){return["#ifdef CLEAR_COAT","vec3 fresnelCoat = materialData.clearCoatSR0Color * areaData.fresnelCC.x + materialData.clearCoatSR90Color * areaData.fresnelCC.y;","#ifdef DSPBR","float fresnelEnergy = 1.0 - materialData.clearCoat * vMax(FresnelSchlick(materialData.clearCoatSR0Color, materialData.clearCoatSR90Color, saturate(dot(surfaceData.clearCoatNormal,V))));","#else","float fresnelEnergy = SpecGlossEnergyConservationTerm(fresnelCoat);","#endif","vec3 coat = fresnelCoat;","coat *= "+e+"(N,V,P,areaData.MinvCC, "+t+");","diffuse *= fresnelEnergy;","specular *= fresnelEnergy;","transmissive *= fresnelEnergy;","specular += materialData.clearCoat * coat;","#endif"].join("\n")},w=function(e,t){return["vec3 coreView = V;","vec3 fresnelCore = materialData.sr0Color * areaData.fresnel.x + materialData.sr90Color * areaData.fresnel.y;","specular = fresnelCore;","specular *= "+e+"(N,coreView,P,areaData.Minv, "+t+");","float diffuseValue = "+e+"(N,V,P,mat3(1.0), "+t+");","#ifdef DSPBR","specular += diffuseValue * materialData.specularEnergyConservationConstant;","diffuseValue *= materialData.diffuseEnergyConservationConstant;","#else","diffuseValue *= SpecGlossEnergyConservationTerm(fresnelCore);","#endif","diffuse = materialData.diffuseColor * diffuseValue;"].join("\n")},E=function(e,t){return["#if defined(USE_SHEEN) && defined(DSPBR_WITH_SHEEN_COLOR_ROUGHNESS)","vec3 sheen = vec3("+e+"(N,V,P,areaData.MinvSheen, "+t+"));","float sheenBlending = 1.0 - materialData.sheenEnergyConservationConstant;","diffuse *= sheenBlending;","specular *= sheenBlending;","transmissive *= sheenBlending;","specular += materialData.sheen * sheen * materialData.sheenColor;","#endif"].join("\n")},T=function(e,t){return["#if defined(USE_SHEEN) && !defined(DSPBR_WITH_SHEEN_COLOR_ROUGHNESS)","vec3 sheen = vec3("+e+"(N,V,P,areaData.MinvSheen, "+t+"));","float sheenBlending = 1.0 - pow5(1.0-materialData.sheen);","diffuse *= PI * sheen * sheenBlending + (1.0 - sheenBlending);","#endif"].join("\n")},A=["void areaRectangleLightModel(out vec3 specular, out vec3 diffuse, out vec3 transmissive, in vec3 N,in vec3 V, in vec3 P, in vec3 p0,in vec3 p1,in vec3 p2,in vec3 p3) {",w("areaRectangleLight","p0,p1,p2,p3"),T("areaRectangleLight","p0,p1,p2,p3"),P("areaRectangleLight","p0,p1,p2,p3"),E("areaRectangleLight","p0,p1,p2,p3"),C("areaRectangleLight","p0,p1,p2,p3"),b("areaRectangleLight","p0,p1,p2,p3"),D("areaRectangleLight","p0,p1,p2,p3"),"}","void areaDiskLightModel(out vec3 specular, out vec3 diffuse, out vec3 transmissive, in vec3 N,in vec3 V, in vec3 P, in vec3 p0,in vec3 p1,in vec3 p2) {",w("areaDiskLight","p0,p1,p2"),T("areaDiskLight","p0,p1,p2"),P("areaDiskLight","p0,p1,p2"),E("areaDiskLight","p0,p1,p2"),C("areaDiskLight","p0,p1,p2"),b("areaDiskLight","p0,p1,p2"),D("areaDiskLight","p0,p1,p2"),"}","float illuminanceRectangle(in vec3 p0, in vec3 p1, in vec3 p2, in vec3 p3,in vec3 lightPosition, in vec3 viewPosition, in vec3 N) {","float angle = solidAngleRect(viewPosition, p0,p1,p2,p3);","float coeff = saturate(dot(normalize(lightPosition - viewPosition),N));","coeff += saturate(dot(normalize(p0 - viewPosition),N)) + saturate(dot(normalize(p1 - viewPosition),N));","coeff += saturate(dot(normalize(p2 - viewPosition),N)) + saturate(dot(normalize(p3 - viewPosition),N));","return angle * 0.2*coeff;","}","float illuminanceTube(in vec3 P0, in vec3 P1, in vec3 lightPosition, in vec3 viewPosition, in vec3 N, in vec3 lRight, in float lHWidth, in float lRadius) {","vec3 forw = normalize(closestOnLine(P0,P1,viewPosition) - viewPosition);","vec3 right = lRight;","vec3 up = cross(right, forw);","vec3 p0 = lightPosition.xyz + right * lHWidth + up * lRadius;","vec3 p1 = lightPosition.xyz + right * lHWidth + up * -lRadius;","vec3 p2 = lightPosition.xyz + right * -lHWidth + up * -lRadius;","vec3 p3 = lightPosition.xyz + right * -lHWidth + up * lRadius;","float illu = illuminanceRectangle(p0,p1,p2,p3,lightPosition,viewPosition,N);","vec3 sphPos = closestOnSegment(P0,P1, viewPosition);","vec3 sphNorm = sphPos - viewPosition;","vec3 sphL = normalize(sphNorm);","float sqrSphDist = dot(sphNorm, sphNorm);","float illu2 = 3.14159 * saturate(dot(sphL, N)) * ((lRadius*lRadius)/sqrSphDist);","return illu+illu2;","}"].join("\n");i=[u,x,e?y:"",e?d:"",e?p:"",e?f:"",e?m:"",e?g:"",v,"#ifdef HAS_AREA_LIGHTS",e?M:"",e?A:"","#endif"].join("\n");var I=["void _doCommonLightingModel(inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L) {","#ifdef USE_ANISOTROPY","coreModelAniso(diffuse,specular, N,V,L);","#else","coreModel(diffuse,specular, N,V,L);","#endif","#ifdef DEBUG_SHADOW","return;","#endif","#ifdef USE_SHEEN","sheenModel(diffuse, specular, N, V, L);","#endif","#ifdef USE_SPECGLOSS_FLAKES","specGlossFlakesModel(diffuse,specular, V,L);","#endif","#ifdef USE_DSPBR_FLAKES","dspbrFlakesModel(diffuse,specular,V,L,N);","#endif","#ifdef CLEAR_COAT","clearCoatModel(diffuse,specular, V, L);","#endif","}","vec3 doShadowApplication(in vec3 light,in float shadowExposure) {","return  light*shadowExposure;","}","vec3 doFullShadowApplication(in vec3 light, in vec3 lightColor, in float shadowExposure,in vec4 transparentExposure) {","vec3 intensity = max(light / lightColor,vec3(0.0));","return  intensity * min(lightColor,transparentExposure.rgb)*min(shadowExposure,transparentExposure.a);","return lightColor;","}","void doLightingModel(in vec3 E, inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L) {","#ifdef DEBUG_SHADOW","N = L;","#endif","_doCommonLightingModel(diffuse,specular,N,V,L);","#ifdef INVISIBLE_PLANE_MATERIAL","vec3 ENoL = PI * E * (step(0.0, dot(N, L)));","#else","vec3 ENoL = E * saturate(dot(N, L));","#endif","#ifdef DEBUG_SHADOW","diffuse *= ENoL;","specular *= 0.0;","return;","#endif","#ifdef USE_SUBSURFACE","vec3 sssENoL = E * getScattering(dot(N, L), surfaceData.curvature);","#ifdef SPECGLOSS","diffuse *= sssENoL;","#else","vec3 baseDiffuseValue = diffuse;","#ifdef DSPBR_WITH_TRANSLUCENCY","diffuse *= mix(ENoL, sssENoL, materialData.translucency);","#else","diffuse *= ENoL;","#endif","diffuse = mix(diffuse, sssENoL * baseDiffuseValue, materialData.transparency);","#endif","#elif defined(DSPBR_WITH_TRANSLUCENCY)","diffuse *= ENoL * (1.0 - materialData.translucency);","#else","diffuse *= ENoL;","#endif","specular *= ENoL;","}","void doAreaLightingModel(in vec3 E, inout vec3 diffuse, inout vec3 specular, in vec3 N, in vec3 V, in vec3 L) {","_doCommonLightingModel(diffuse,specular,N,V,L);","#ifdef USE_SUBSURFACE","vec3 sssE = E * materialData.scatteringColor;","#ifdef SPECGLOSS","diffuse *= sssE;","#else","vec3 baseDiffuseValue = diffuse;","#ifdef DSPBR_WITH_TRANSLUCENCY","diffuse *= mix(E, sssE, materialData.translucency);","#else","diffuse *= E;","#endif","diffuse = mix(diffuse, sssE * baseDiffuseValue, materialData.transparency);","#endif","#elif defined(DSPBR_WITH_TRANSLUCENCY)","diffuse *= E * (1.0 - materialData.translucency);","#else","diffuse *= E;","#endif","specular *= E;","}"].join("\n"),R=["float computeHorizonFade(in vec3 R, in vec3 N, in float roughness) {","float coeff = mix(0.5, 1.0, 1.0 - pow2(roughness));","return clamp(1.0 + coeff * dot(R, N), 0.0, 1.0);","}","#if defined(REFLECTIVITY_ENVMAP) && defined(USE_LIGHTING)","#define USE_REFLECTIVITY_ENVMAP","#ifndef USE_ENVMAP","uniform int combine;","uniform float reflectivity;","#endif","uniform sampler2D reflectivityEnvMap;","vec3 sampleReflectivityEnvMap(in vec3 reflectVec, in vec3 color) {","vec3 endColor;","float probeR = INV_PI * acos( reflectVec.z ) / length(reflectVec.xy);","vec3 mapColor = convertToLinear(texture2D( reflectivityEnvMap, 0.5 * (probeR * reflectVec.xy + 1.0)).xyz);","if ( combine == 1 ) {","endColor = mix( color.xyz, mapColor,  reflectivity );","} else if ( combine == 2 ) {","endColor = color + mapColor * reflectivity;","} else {","endColor = mix( color.xyz, color.xyz * mapColor, reflectivity );","}","return endColor;","}","#endif","#if defined(USE_ENVMAP) || defined(USE_SSLREFLECTION) || defined(USE_SSLREFRACTION)","uniform sampler2D precomputedTexture;","#define E_130_OVER_258 0.50387596899","vec2 PRECOMPUTED_TEXTURE_1 = E_130_OVER_258 * vec2(0.0,1.0);","vec2 PRECOMPUTED_TEXTURE_2 = E_130_OVER_258 * vec2(1.0,1.0);","vec2 PRECOMPUTED_TEXTURE_3 = E_130_OVER_258 * vec2(0.0,0.0);","vec4 sampleBRDFTexture(in float NdotV, in float roughness, in vec2 offset) {","vec2 uv = 0.496124031 * vec2(max(NdotV,1e-2),roughness) + offset;","return texture2D(precomputedTexture, uv);","}","#endif","#ifdef USE_ENVMAP","uniform sampler2D envMap2;","#endif","#ifdef USE_REFLECTION_PROBE","uniform sampler2D reflectionProbe;","uniform sampler2D reflectionProbeMips;","uniform vec3 reflectionProbeProxyMin;","uniform vec3 reflectionProbeProxyMax;","uniform vec3 reflectionProbePos;","#endif","#ifdef USE_FINITE_ENVMAP","uniform vec3 sphereCenter;","uniform vec3 projectionCenter;","uniform float sphereRadius;","#endif","#if defined(USE_SSLREFLECTION) || defined(USE_SSLREFRACTION)","uniform vec2 invScreenSize;","#endif","#if defined(USE_SSLREFLECTION)","uniform sampler2D reflectionColorTexture;","#endif","#if defined(USE_SSLREFRACTION)","uniform sampler2D refractionColorTexture;","#endif","#if defined(USE_ENVMAP) || defined(USE_SSLREFLECTION) || defined(USE_SSLREFRACTION)","const float oneOverMax16int = 0.000015259021896696422;","float unpackFrom16(vec2 pack) {","return 255.0 * oneOverMax16int * (256.0 * pack.x + pack.y);","}","#endif","#if defined(USE_ENVMAP)","vec2 getMips(in float roughnessValue) {","float mipValue = max(6.0 + 1.15 * log2(roughnessValue + 0.0000001), 0.0);","float mipCoef = fract(mipValue);","if (mipValue > 6.0) {","mipValue = 6.0;","mipCoef = 1.0;","}","return vec2(mipValue,mipCoef);","}","vec2 getMipsLinearInverted(in float roughnessValue) {","float mipValue = max(5.0 * (1.0 - roughnessValue) + 1.0, 0.0);","float mipCoef = fract(mipValue);","if (mipValue > 6.0) {","mipValue = 6.0;","mipCoef = 1.0;","}","return vec2(mipValue,mipCoef);","}","vec2 getMipsLinear(in float roughnessValue) {","float mipValue = max(5.0 * (roughnessValue) + 1.0, 0.0);","float mipCoef = fract(mipValue);","if (mipValue > 6.0) {","mipValue = 6.0;","mipCoef = 1.0;","}","return vec2(mipValue,mipCoef);","}","vec2 getEnvMapUV(in vec3 vector) {","vector = normalize((ambienceMatrix*vec4(vector,0.0)).xyz);","if (abs(vector.x) < 1e-6) {","vector.x = 1e-6;","}","float phi = atan(vector.y, vector.x);","float theta = acos(vector.z);","return vec2(fract(0.5 + 0.5 * INV_PI * phi), 1.0 - INV_PI * theta);","}","vec2 getUVFromMips(float mip, vec2 uv, vec2 texelSize) {","float t10 = pow(2.0, -floor(log2(mip + 1.0)));","float t11 = 2.0 - (mip + 2.0) * t10;","float t12 = 0.5 * t10;","return vec2(t11 + 1.5 * texelSize.x + (2.0 * t12 - 3.0 * texelSize.x) * uv.x, t12 + 1.5 * texelSize.x + (t12 - 3.0 * texelSize.x) * uv.y);","}","vec4 getUVBoxFromMips(float mip, vec2 texelSize) {","float t10 = pow(2.0, -floor(log2(mip + 1.0)));","float t11 = 2.0 - (mip + 2.0) * t10;","float t12 = 0.5 * t10;","return vec4(t11, t12 + 1.5 * texelSize.x , 2.0 * t12, t12 - 3.0 * texelSize.x);","}","vec4 sampleMipMapRoughness(vec2 uv, float mip, float coef, sampler2D map0, sampler2D map1) {","vec4 color1;","vec4 color2;","vec4 uv1;","vec4 uv2;","#ifdef USE_ENVMAP_HDR","if (mip < 1.0) {","#ifdef USE_ENVMAP_RGB_HDR","color1 = texture2D(map0, uv);","#ifdef USE_ENVMAP_RGB_SRGB","color1.xyz *= color1.xyz;","#endif","#else","color1 = texture2DBilinearFromRGBE(map0, uv, hdrSize, hdrTexelSize);","#endif","} else {","float level1 = clamp(floor(mip) - 1.0, 0.0, 4.0);","#ifdef NON_REPEAT_IBL_SAMPLING","uv1.xy = getUVFromMips(level1, uv, mipsTexelSize);","#else","uv1 = getUVBoxFromMips(level1, mipsTexelSize);","#endif","color1 = texture2DBilinearFromRGBEwBox(map1, uv1, uv, mipsSize, mipsTexelSize);","}","float level2 = clamp(floor(mip), 0.0, 5.0);","#ifdef NON_REPEAT_IBL_SAMPLING","uv2.xy = getUVFromMips(level2, uv, mipsTexelSize);","#else","uv2 = getUVBoxFromMips(level2, mipsTexelSize);","#endif","color2 = texture2DBilinearFromRGBEwBox(map1, uv2, uv, mipsSize, mipsTexelSize);","return mix(color1, color2, coef);","#else","return texture2D(map1, uv);","#endif","}","#if defined(USE_SHEEN) && defined(USE_ENVMAP_SHEEN)","vec4 sampleMipMapRoughnessSheen(vec2 uv, float mip, float coef, sampler2D map1) {","vec4 color1;","vec4 color2;","vec4 uv1;","vec4 uv2;","float level1 = clamp(floor(mip) - 1.0, 0.0, 4.0);","#ifdef NON_REPEAT_IBL_SAMPLING","uv1.xy = getUVFromMips(level1, uv, mipsTexelSize);","#else","uv1 = getUVBoxFromMips(level1, mipsTexelSize);","#endif","color1 = texture2DBilinearFromRGBEwBox(map1, uv1, uv, mipsSize, mipsTexelSize);","float level2 = clamp(floor(mip), 0.0, 5.0);","#ifdef NON_REPEAT_IBL_SAMPLING","uv2.xy = getUVFromMips(level2, uv, mipsTexelSize);","#else","uv2 = getUVBoxFromMips(level2, mipsTexelSize);","#endif","color2 = texture2DBilinearFromRGBEwBox(map1, uv2, uv, mipsSize, mipsTexelSize);","return mix(color1, color2, coef);","}","#endif","#endif","#ifdef USE_REFLECTION_PROBE","vec3 correctParallax(vec3 worldPos, vec3 reflectVec) {","vec3 rbmax = (reflectionProbeProxyMax - worldPos) / reflectVec;","vec3 rbmin = (reflectionProbeProxyMin - worldPos) / reflectVec;","vec3 rbminmax = max(rbmax, rbmin);","float distance = min(min(rbminmax.x, rbminmax.y), rbminmax.z);","vec3 intersectPos = worldPos + reflectVec * distance;","return normalize(intersectPos - reflectionProbePos);","}","#endif","#ifdef USE_FINITE_ENVMAP","vec3 correctParallaxFinite(vec3 center, vec3 projection, float radius, vec3 rayDir, vec3 rayOrig) {","float t = 0.0;","vec3 dist = rayOrig - center;","float B = 2.0*dot(rayDir, dist);","float C = dot(dist, dist) - radius*radius;","float disc = B*B - 4.0*C;","if (disc < 0.0) {","    t = -1.0;","} else {","t = (-B + sqrt(disc)) / 2.0; }","vec3 hitPos = rayOrig + t*rayDir;","vec3 sn = (hitPos - projection);","return normalize(sn);","}","#endif"].join("\n");return[t,e?R:"",i,e?I:"","#ifdef DSPBR","float adjustTransparency(in float transparencyValue, in vec3 albedo, in float roughness) {","float adjust = sqrt(dot(albedo, luminanceVector));","adjust *= exp(-0.125 * roughness * roughness);","return transparencyValue * adjust;","}","#endif","float ApplyTransparency(inout float transparencyValue, in float metalnessValue, in vec3 albedo, in float NoV) {","#if defined(USE_SSLREFRACTION)","#ifndef USE_LIGHTING","transparencyValue = 0.0;","#endif","return 1.0;","#else","vec3 Ft = FresnelSchlick(materialData.sr0Color, materialData.sr90Color, NoV);","#ifndef SPECGLOSS","transparencyValue = adjustTransparency(transparencyValue, albedo, materialData.roughness);","#endif","float transToDivide = max(1.0 - (1.0 - metalnessValue) * transparencyValue * (1.0 - 0.3333*(Ft.x + Ft.y + Ft.z)), 1e-6);","gl_FragColor.a *= transToDivide;","#if defined(SKIP_TRANSPARENT)","if ( gl_FragColor.a < 1.0 - 1e-3) discard;","#endif","return transToDivide;","#endif","}"].join("\n")}(t),e.ShaderChunk.bumpmap_pars_fragment,e.ShaderChunk.normalmap_pars_fragment,"#ifdef USE_NORMALMAP","vec3 perturbNormal3Arb( vec3 surf_norm, vec3 surf_tgt, vec3 surf_binorm, vec2 normalUV, in vec2 scale ) {","vec3 N = normalize(surf_norm);","vec3 T = normalize(surf_tgt);","T = normalize(T - dot(T, N) * N);","vec3 B = normalize(surf_binorm);","vec3 mapN = texture2D( normalMap, normalUV ).xyz * 2.0 - 1.0;","#ifndef DSPBR","mapN.xy = scale * mapN.xy;","#ifdef NORMALFLIPY","mapN.y = - mapN.y;","#endif","#else","#ifdef USE_NORMAL_COEFFICIENTS","mapN = mapN * normalMulCoef + normalAddCoef;","#endif","mapN.z = abs(mapN.z);","#endif","mat3 tbn = mat3(T, B, N);","return normalize(tbn * mapN);","}","#endif","#if defined(USE_BUMPMAP) && defined(SPECGLOSS)","vec2 dHdxy_fwd(in vec2 bumpMapUv, in float scale) {","vec2 dSTdx = dFdx( bumpMapUv );","vec2 dSTdy = dFdy( bumpMapUv );","float Hll = scale * texture2D( bumpMap, bumpMapUv ).x;","float dBx = scale * texture2D( bumpMap, bumpMapUv + dSTdx ).x - Hll;","float dBy = scale * texture2D( bumpMap, bumpMapUv + dSTdy ).x - Hll;","return vec2( dBx, dBy );","}","#endif",e.DeferredShaderChunk.oit_pars_fragment,!t&&X?e.DeferredShaderChunk.picking_pars_fragment:"",!t&&X?e.DeferredShaderChunk.picking_instancing_pars_fragment:"",!t&&X?e.DeferredShaderChunk.depth_pars_fragment:"",!t&&X?e.DeferredShaderChunk.decal_normal_depth_pars_fragment:"",!t&&X?e.DeferredShaderChunk.shadowmap_pars_fragment:"",!t&&X?e.DeferredShaderChunk.highlight_pars_fragment:"",!t&&X?e.DeferredShaderChunk.texcoord_pars_fragment:"",V,e.ShaderChunk.postprocess_pars_fragment,e.ShaderChunk.fog_pars_fragment,"void main() {","#ifndef USE_ENVMAP_HDR","vec2 envMapHDRSize;","float envMapHDRToMipsRatio = 1.0;","#endif","#if defined( USE_MAP_HDR ) || defined( USE_ENVMAP_HDR )","hdrSize = vec2(envMapHDRSize);","hdrTexelSize = vec2(1.0 / envMapHDRSize);","mipsSize = envMapHDRToMipsRatio * vec2(1.0, 2.0) * hdrSize;","mipsTexelSize = vec2(1.0 / mipsSize);","#endif","#ifdef PDSFX",e.ShaderChunk.PDSFX_map_fragment,e.ShaderChunk.PDSFX_mapping_fragment,"ComputeCommonValues();",e.ShaderChunk.PDSFX_discard_fragment,e.ShaderChunk.PDSFX_viewNormal_fragment,"vViewPosition = -ComputeViewPosition();","#endif","gl_FragColor = vec4( 1.0 );",U,e.ShaderChunk.clip_fragment,O,e.ShaderChunk.tangent_Binormal_fragment,i,function(e){var t;if(e){var i=["#if MAX_AREA_LIGHTS > 0 && !defined(DEBUG_SHADOW)","for (int i = 0; i < MAX_AREA_LIGHTS; i++) {","vec3 transmissive = vec3(0.0);","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lPosition = viewMatrix *vec4( areaLightPosition[ i ], 1.0 );","vec4 lNormal = viewMatrix *vec4( areaLightNormal[ i ], 0.0 );","float hw = 0.5*areaLightData[i].x;","float hh = 0.5*areaLightData[i].y;","vec3 up = (viewMatrix * vec4( areaLightUp[i],0.0)).xyz;","vec3 right = normalize(cross(lNormal.xyz, up));","vec3 p0 = lPosition.xyz + right * hw - up * hh;","vec3 p1 = lPosition.xyz - right * hw - up * hh;","vec3 p2 = lPosition.xyz - right * hw + up * hh;","vec3 p3 = lPosition.xyz + right * hw + up * hh;","areaRectangleLightModel(specular, diffuse, transmissive, surfaceData.viewNormal,surfaceData.view, -surfaceData.viewPosition, p0,p1,p2,p3);","float attenuation = cropRectangleLight(lPosition.xyz, p0, p1, p2, p3, -surfaceData.viewPosition.xyz, surfaceData.viewNormal);","totalDiffuse += attenuation * areaLightColor[i] * diffuse;","totalSpecular += attenuation * areaLightColor[i] * specular;","totalTransmissive += transmissive * areaLightColor[i]* cropRectangleLight(lPosition.xyz, p0, p1, p2, p3, -surfaceData.viewPosition.xyz, -surfaceData.viewNormal);","}","#endif"].join("\n"),r=["#if MAX_SPHERE_LIGHTS > 0 && !defined(DEBUG_SHADOW)","for (int i = 0; i < MAX_SPHERE_LIGHTS; i++) {","vec3 transmissive = vec3(0.0);","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lPosition = viewMatrix * vec4( sphereLightPosition[ i ], 1.0 );","float radius = sphereLightData[i].x;","vec3 p0, p1, p2;","getSphereLightPoints(lPosition.xyz, -surfaceData.viewPosition.xyz, radius, p0,p1,p2);","areaDiskLightModel(specular, diffuse, transmissive, surfaceData.viewNormal,surfaceData.view, -surfaceData.viewPosition.xyz, p0, p1, p2);","float attenuation = cropDiskLight(lPosition.xyz, p0, p1, -surfaceData.viewPosition.xyz, surfaceData.viewNormal);","totalDiffuse += attenuation * sphereLightColor[i]*diffuse;","totalSpecular += attenuation * sphereLightColor[i]*specular;","totalTransmissive += transmissive * sphereLightColor[i]* cropDiskLight(lPosition.xyz, p0, p1, -surfaceData.viewPosition.xyz, -surfaceData.viewNormal);","}","#endif"].join("\n"),n=["#if MAX_DISK_LIGHTS > 0 && !defined(DEBUG_SHADOW)","for (int i = 0; i < MAX_DISK_LIGHTS; i++) {","vec3 transmissive = vec3(0.0);","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lPosition = viewMatrix * vec4( diskLightPosition[ i ], 1.0 );","vec4 lNormal = viewMatrix * vec4( diskLightNormal[ i ], 0.0 );","float radius = diskLightData[i].x;","vec3 up = (viewMatrix * vec4( diskLightUp[i],0.0)).xyz;","vec3 right = normalize(cross(lNormal.xyz, up));","vec3 p0 = lPosition.xyz + right * radius - up * radius;","vec3 p1 = lPosition.xyz - right * radius - up * radius;","vec3 p2 = lPosition.xyz - right * radius + up * radius;","areaDiskLightModel(specular, diffuse, transmissive, surfaceData.viewNormal,surfaceData.view, -surfaceData.viewPosition.xyz, p0,p1,p2);","float attenuation = cropDiskLight(lPosition.xyz, p0, p1, -surfaceData.viewPosition.xyz, surfaceData.viewNormal);","totalDiffuse += attenuation * diskLightColor[i]*diffuse;","totalSpecular += attenuation * diskLightColor[i]*specular;","totalTransmissive += transmissive * diskLightColor[i]*cropDiskLight(lPosition.xyz, p0, p1, -surfaceData.viewPosition.xyz, -surfaceData.viewNormal);","}","#endif"].join("\n"),a=["#if MAX_TUBE_LIGHTS > 0 && !defined(DEBUG_SHADOW)","for (int i = 0; i < MAX_TUBE_LIGHTS; i++) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lPosition = viewMatrix * vec4( tubeLightPosition[ i ], 1.0 );","float lRadius = tubeLightData[i].x;","float lWidth = tubeLightData[i].y;","vec3 lRight = (viewMatrix * vec4( tubeLightRight[i],0.0)).xyz;","vec3 P0 = lPosition.xyz - lRight * lWidth * 0.5;","vec3 P1 = lPosition.xyz + lRight * lWidth * 0.5;","vec3 E = tubeLightColor[i] * illuminanceTube(P0,P1,lPosition.xyz,-surfaceData.viewPosition.xyz,surfaceData.viewNormal,lRight,0.5*lWidth,lRadius);","vec3 closestPoint = closestPointTube(P0,P1,surfaceData.viewNormal,viewReflect,-surfaceData.viewPosition.xyz, lPosition.xyz,lRadius);","doAreaLightingModel(E, diffuse, specular, surfaceData.viewNormal, surfaceData.view, closestPoint);","#ifdef USE_SUBSURFACE","#ifdef THICKNESS_BASED_TRANSMITTANCE","vec3 tubeAttenuation = tubeLightColor[i] * illuminanceTube(P0,P1,lPosition.xyz,-surfaceData.viewPosition.xyz,-surfaceData.viewNormal,lRight,0.5*lWidth,lRadius)  * materialData.transmittanceColor;","totalTransmissive += tubeAttenuation * _TranslucencySpecularModel( surfaceData.viewNormal, closestPoint, surfaceData.view, materialData.transparentColor);","#ifdef DSPBR_WITH_TRANSLUCENCY","totalTransmissive += materialData.translucency * tubeAttenuation * _TranslucencyDiffuseModel( surfaceData.viewNormal, closestPoint, surfaceData.view, materialData.translucencyColor);","#endif","#endif","#elif defined(DSPBR_WITH_TRANSLUCENCY)","totalTransmissive += materialData.translucency * tubeLightColor[i] * illuminanceTube(P0,P1,lPosition.xyz,-surfaceData.viewPosition.xyz,-surfaceData.viewNormal,lRight,0.5*lWidth,lRadius) * _TranslucencyDiffuseModel( surfaceData.viewNormal, closestPoint, surfaceData.view, materialData.translucencyColor);","#endif","totalDiffuse += diffuse;","totalSpecular += specular;","}","#endif"].join("\n"),s=function(e){return["vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ "+e+" ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float shadowExposure = 1.0;","vec4 transparentExposure = vec4(1.0);","#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_CASCADE","0"===e?"shadowExposure = getExposureCascaded(vShadowCoord,shadowMap,shadowBias,shadowMapSize,transparentExposure);":"","#else","if("+e+"<SHADOWS_DIR_END){","shadowExposure = getExposureFromIndex("+e+");","#ifdef USE_TRANSPARENTSHADOWMAP","transparentExposure = getTransparentExposureFromIndex("+e+");","#endif","}","#endif","#endif","vec3 lightColor = directionalLightColor[ "+e+" ];","#ifdef INVISIBLE_PLANE_MATERIAL","lightColor = vec3(vMax(lightColor));","lightNormalizationFactor += lightColor * step(0.0, dot(surfaceData.viewNormal, lVector));","#endif","#if defined(USE_SHADOWMAP) && defined(USE_TRANSPARENTSHADOWMAP)","vec3 lightColorNoIntensity = directionalLightColorNoIntensity[ "+e+" ];","#ifdef INVISIBLE_PLANE_MATERIAL","lightColorNoIntensity = vec3(vMax(lightColorNoIntensity));","#endif","vec3 E = doFullShadowApplication(lightColor,lightColorNoIntensity,shadowExposure,transparentExposure);","#else","vec3 E = doShadowApplication(lightColor,shadowExposure);","#endif","doLightingModel(E, diffuse, specular, surfaceData.viewNormal, surfaceData.view, lVector);","#ifdef USE_SUBSURFACE","bool doThicknessBasedTransmittance = true;","#ifdef MAP_TRANSMITTANCE","if ("+e+" < SHADOWS_DIR_END) {","vec3 dirAttenuation = lightColor *  multiSampleTransmittance(vShadowCoord[ "+e+" ], vec2(shadowMapNear["+e+"], shadowMapFar["+e+"]), shadowMapSize[ "+e+" ], shadowMap[ "+e+" ], true);","totalTransmissive += dirAttenuation * TranslucencySpecularModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.transparentColor);","#ifdef DSPBR_WITH_TRANSLUCENCY","totalTransmissive += materialData.translucency * dirAttenuation * TranslucencyDiffuseModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.translucencyColor);","#endif","doThicknessBasedTransmittance = false;","}","#endif","#if defined(THICKNESS_BASED_TRANSMITTANCE)","if (doThicknessBasedTransmittance) {","vec3 dirAttenuation = lightColor *  materialData.transmittanceColor;","totalTransmissive += dirAttenuation * TranslucencySpecularModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.transparentColor);","#ifdef DSPBR_WITH_TRANSLUCENCY","totalTransmissive += materialData.translucency * dirAttenuation * TranslucencyDiffuseModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.translucencyColor);","#endif","}","#endif","#else","#if defined(DSPBR_WITH_TRANSLUCENCY)","totalTransmissive += materialData.translucency * lightColor * TranslucencyDiffuseModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.translucencyColor);","#endif","#endif","totalDiffuse += diffuse ;","totalSpecular += specular;"].join("\n")},o=["#if MAX_DIR_LIGHTS > 0","{",s("0"),"}","if(MAX_DIR_LIGHTS>1){","for( int i = 1; i < MAX_DIR_LIGHTS; i ++ ) {",s("i"),"}","}","#endif"].join("\n"),l=["#if defined(USE_IBL_LIGHT) && !defined(DEBUG_SHADOW)","for( int i = 0; i < MAX_DIR_IBL_LIGHTS; i ++ ) {","if (directionalIBLLightColor[i].r < 1e-6) {","continue;","}","vec4 lWorldDirection = vec4( directionalIBLLightDirection[ i ], 0.0 );","vec4 lDirection = viewMatrix * lWorldDirection;","vec3 lVector = normalize( lDirection.xyz );","vec2 normalUV = getEnvMapUV(normalize(lWorldDirection.xyz));","#if defined(USE_ENVMAP_DIFFUSE) && !defined(USE_REFLECTION_PROBE)","float diffMip = 6.0;","#else","float diffMip = 5.0;","#endif","#ifdef USE_REFLECTION_PROBE","vec4 diffuseColor = texture2DBilinearFromRGBE(reflectionProbeMips, getUVFromMips(diffMip, normalUV, mipsTexelSize), mipsSize, mipsTexelSize);","#else","vec4 diffuseColor = texture2DBilinearFromRGBE(envMap2, getUVFromMips(diffMip, normalUV, mipsTexelSize), mipsSize, mipsTexelSize);","#endif","vec3 E = PI * diffuseColor.rgb * directionalIBLLightColor[i] * envMapExposureDiffuse;","if (i + SHADOWS_DIR_IBL_START < SHADOWS_DIR_IBL_END) {","vec3 dirAttenuation = multiSampleTransmittance(vShadowCoord[ i + SHADOWS_DIR_IBL_START], vec2(shadowMapNear[i+ SHADOWS_DIR_IBL_START], shadowMapFar[i+ SHADOWS_DIR_IBL_START]), shadowMapSize[ i+ SHADOWS_DIR_IBL_START ], shadowMap[ i+ SHADOWS_DIR_IBL_START], true);","totalTransmissive += dirAttenuation * E *  TranslucencySpecularModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.transparentColor);","#ifdef DSPBR_WITH_TRANSLUCENCY","totalTransmissive += materialData.translucency * dirAttenuation * E * TranslucencyDiffuseModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.translucencyColor);","#endif","}","}","#endif"].join("\n"),c=["#if MAX_POINT_LIGHTS > 0","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + surfaceData.viewPosition.xyz;","float lAttenuation = 1.0;","if (pointLightPhysicalAttenuation[ i ]> 0){","lAttenuation = 1.0 / (dot(lVector,lVector) * pointLightDistance[ i ]);","}else {","if ( pointLightDistance[ i ] > 0.0 )","lAttenuation = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","}","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vPointLight[ i ].xyz );","float lAttenuation = vPointLight[ i ].w;","#endif","float shadowExposure = 1.0;","vec4 transparentExposure = vec4(1.0);","#ifdef USE_SHADOWMAP_CUBE","if (i<MAX_SHADOWS_CUBE){","shadowExposure = getExposureFromIndexCube(i);","#ifdef USE_TRANSPARENTSHADOWMAP","transparentExposure = getTransparentExposureFromIndexCube(i);","#endif","}","#endif","vec3 lightColor = pointLightColor[ i ];","#ifdef INVISIBLE_PLANE_MATERIAL","lightColor = vec3(vMax(lightColor));","lightNormalizationFactor += lAttenuation * lightColor * step(0.0, dot(surfaceData.viewNormal, lVector));","#endif","#if defined(USE_SHADOWMAP_CUBE) && defined(USE_TRANSPARENTSHADOWMAP)","vec3 lightColorNoIntensity = pointLightColorNoIntensity[ i ];","#ifdef INVISIBLE_PLANE_MATERIAL","lightColorNoIntensity = vec3(vMax(lightColorNoIntensity));","#endif","vec3 E = lAttenuation * doFullShadowApplication(lightColor,lightColorNoIntensity,shadowExposure,transparentExposure);","#else","vec3 E = lAttenuation * doShadowApplication(lightColor,shadowExposure);","#endif","doLightingModel(E, diffuse, specular, surfaceData.viewNormal, surfaceData.view, lVector);","#ifdef USE_SUBSURFACE","bool doThicknessBasedTransmittance = true;","#ifdef CUBE_TRANSMITTANCE","if (i < MAX_SHADOWS_CUBE) {","vec3 pointAttenuation = lAttenuation * lightColor * multiSampleCubeTransmittance(surfaceData.worldPosition, shadowPointPosition[i], vec2(shadowNearCube[i], shadowFarCube[i]), shadowMapSizeCube[i], shadowMapCube[i], false);","totalTransmissive += pointAttenuation * TranslucencySpecularModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.transparentColor);","#ifdef DSPBR_WITH_TRANSLUCENCY","totalTransmissive += materialData.translucency * pointAttenuation * TranslucencyDiffuseModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.translucencyColor);","#endif","doThicknessBasedTransmittance = false;","}","#endif","#if defined(THICKNESS_BASED_TRANSMITTANCE)","if(doThicknessBasedTransmittance) {","vec3 pointAttenuation = lAttenuation * lightColor * materialData.transmittanceColor;","totalTransmissive += pointAttenuation * TranslucencySpecularModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.transparentColor);","#ifdef DSPBR_WITH_TRANSLUCENCY","totalTransmissive += materialData.translucency * pointAttenuation * TranslucencyDiffuseModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.translucencyColor);","#endif","}","#endif","#else","#if defined(DSPBR_WITH_TRANSLUCENCY)","totalTransmissive +=  materialData.translucency * lAttenuation * lightColor * TranslucencyDiffuseModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.translucencyColor);","#endif","#endif","totalDiffuse += diffuse;","totalSpecular += specular;","}","#endif"].join("\n");t=["#ifdef USE_LIGHTING","vec3 totalDiffuse = vec3(0.0);","vec3 totalSpecular = vec3(0.0);","vec3 totalTransmissive = vec3(0.0);","#ifdef INVISIBLE_PLANE_MATERIAL","vec3 lightNormalizationFactor = vec3(0.0);","#endif",["#if MAX_SPOT_LIGHTS > 0","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + surfaceData.viewPosition.xyz;","float lAttenuation = 1.0;","if (spotLightPhysicalAttenuation[ i ]> 0){","lAttenuation =1.0 / (dot(lVector,lVector) * spotLightDistance[ i ]);","}else {","if ( spotLightDistance[ i ] > 0.0 )","lAttenuation = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","}","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vSpotLight[ i ].xyz );","float lAttenuation = vSpotLight[ i ].w;","#endif","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - surfaceData.worldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","float shadowExposure = 1.0;","vec4 transparentExposure = vec4(1.0);","#ifdef USE_SHADOWMAP","if((i + SHADOWS_SPOT_START)<SHADOWS_SPOT_END){","shadowExposure = getExposureFromIndex(i + SHADOWS_SPOT_START);","#ifdef USE_TRANSPARENTSHADOWMAP","transparentExposure = getTransparentExposureFromIndex(i + SHADOWS_SPOT_START);","#endif","}","#endif","spotEffect = 1.0 - smoothstep( spotLightInnerAngleCos[ i ],spotLightAngleCos[ i ],spotEffect );","vec3 lightColor = spotLightColor[ i ];","#ifdef INVISIBLE_PLANE_MATERIAL","lightColor = vec3(vMax(lightColor));","lightNormalizationFactor += spotEffect * lAttenuation * lightColor * step(0.0, dot(surfaceData.viewNormal, lVector));","#endif","#if defined(USE_SHADOWMAP) && defined(USE_TRANSPARENTSHADOWMAP)","vec3 lightColorNoIntensity = spotLightColorNoIntensity[ i ];","#ifdef INVISIBLE_PLANE_MATERIAL","lightColorNoIntensity = vec3(vMax(lightColorNoIntensity));","#endif","vec3 E = spotEffect * lAttenuation * doFullShadowApplication(lightColor,lightColorNoIntensity,shadowExposure,transparentExposure);","#else","vec3 E = spotEffect * lAttenuation * doShadowApplication(lightColor,shadowExposure);","#endif","doLightingModel(E, diffuse, specular, surfaceData.viewNormal, surfaceData.view, lVector);","#ifdef USE_SUBSURFACE","bool doThicknessBasedTransmittance = true;","#ifdef MAP_TRANSMITTANCE","if ((i + SHADOWS_SPOT_START)<SHADOWS_SPOT_END) {","vec3 spotAttenuation = lightColor * lAttenuation * spotEffect *  multiSampleTransmittance(vShadowCoord[ i + SHADOWS_SPOT_START ], vec2(shadowMapNear[i + SHADOWS_SPOT_START], shadowMapFar[i + SHADOWS_SPOT_START]), shadowMapSize[ i + SHADOWS_SPOT_START ], shadowMap[ i + SHADOWS_SPOT_START], false);","totalTransmissive += spotAttenuation * TranslucencySpecularModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.transparentColor);","#ifdef DSPBR_WITH_TRANSLUCENCY","totalTransmissive += materialData.translucency * spotAttenuation *  TranslucencyDiffuseModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.translucencyColor);","#endif","doThicknessBasedTransmittance = false;","}","#endif","#if defined(THICKNESS_BASED_TRANSMITTANCE)","if (doThicknessBasedTransmittance) {","vec3 spotAttenuation = lightColor * lAttenuation * spotEffect * materialData.transmittanceColor;","totalTransmissive += spotAttenuation * TranslucencySpecularModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.transparentColor);","#ifdef DSPBR_WITH_TRANSLUCENCY","totalTransmissive += materialData.translucency * spotAttenuation * TranslucencyDiffuseModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.translucencyColor);","#endif","}","#endif","#else","#if defined(DSPBR_WITH_TRANSLUCENCY)","totalTransmissive += materialData.translucency * lightColor * lAttenuation * spotEffect *  TranslucencyDiffuseModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.translucencyColor);","#endif","#endif","totalDiffuse += diffuse;","totalSpecular += specular;","}","}","#endif"].join("\n"),["#if MAX_IES_LIGHTS > 0 && !defined(DEBUG_SHADOW)","for ( int i = 0; i < MAX_IES_LIGHTS; i ++ ) {","vec3 diffuse  = vec3( 0.0 );","vec3 specular = vec3( 0.0 );","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( iesLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + surfaceData.viewPosition.xyz;","float lDistance = 1.0;","if ( iesLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / iesLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( viesLight[ i ].xyz );","float lDistance = viesLight[ i ].w;","#endif","vec3 E = iesLightColor[ i ] * lDistance * 3.14159;","vec4 coordInIESWorld = normalize(matrixWorldInv[i] * vec4(surfaceData.worldPosition,1.0));","float stepTexture = 1.0/128.0*72.0;","const float PI = 3.14159265359;","const float invTwoPi = 1.0/PI;","float phi = acos(-coordInIESWorld.z)/3.14159;","float theta = myAtan2(coordInIESWorld.x,-coordInIESWorld.y)*invTwoPi;","if(theta<0.0) theta *= -1.0;","E *= texture2D(iesLightTexture[i],vec2(phi,theta)).x;","doLightingModel(E, diffuse, specular, surfaceData.viewNormal, surfaceData.view, lVector);","#ifdef USE_SUBSURFACE","#ifdef THICKNESS_BASED_TRANSMITTANCE","vec3 iesAttenuation = E * materialData.transmittanceColor;","totalTransmissive += iesAttenuation * TranslucencySpecularModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.transparentColor);","#ifdef DSPBR_WITH_TRANSLUCENCY","totalTransmissive += materialData.translucency * iesAttenuation * TranslucencyDiffuseModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.translucencyColor);","#endif","#endif","#elif defined(DSPBR_WITH_TRANSLUCENCY)","totalTransmissive += materialData.translucency * E * TranslucencyDiffuseModel( surfaceData.viewNormal, lVector, surfaceData.view, materialData.translucencyColor);","#endif","totalDiffuse  += diffuse;","totalSpecular += specular;","}","#endif"].join("\n"),c,o,l,i,r,a,n,"#if defined(USE_LIGHTMAP) && defined(LIGHTMAP_IRRADIANCE_MODE)","totalDiffuse = vec3(0.0);","totalSpecular *= clamp(aoValue, 0.0, 1.0);","#endif","gl_FragColor.xyz = totalDiffuse + totalSpecular;","#endif","vec3 totalEmission = doEmission(NoV, surfaceData.view, emissionColorValue, emissionValue);"].join("\n")}else t=["vec3 totalDiffuse = vec3(0.0);","vec3 totalSpecular = vec3(0.0);","vec3 totalTransmissive = vec3(0.0);","vec3 totalEmission = vec3(0.0);"].join("\n");return t}(t),function(e){var t;if(e){var i=["vec3 specularIBLValue = vec3(0.0);","#ifdef PBR_FROM_GAS","vec2 mips = vec2(4.21, 0.21);","#else","vec2 mips = getMips(materialData.roughness);","#endif","vec4 cubeColor;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_REFLECTION_PROBE","reflectVec = correctParallax(surfaceData.worldPosition, reflectVec);","#endif","#ifdef USE_FINITE_ENVMAP","reflectVec = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, reflectVec, surfaceData.worldPosition);","#endif","vec2 reflectionUV = getEnvMapUV(reflectVec);","#ifdef USE_REFLECTION_PROBE","cubeColor = envMapExposureSpecular * sampleMipMapRoughness( reflectionUV, mips.x, mips.y, reflectionProbe, reflectionProbeMips);","#else","cubeColor = envMapExposureSpecular * sampleMipMapRoughness( reflectionUV, mips.x, mips.y, envMap, envMap2);","#endif","#endif","#ifdef USE_NORMALMAP","float hOcclusion = computeHorizonFade(reflectVec, worldVertexNormal, materialData.roughness);","hOcclusion *= hOcclusion;","#else","float hOcclusion = 1.0;","#endif","vec4 preCompGGX = sampleBRDFTexture(NdotV, materialData.roughness, PRECOMPUTED_TEXTURE_1);","vec3 GFresnelVoH = materialData.sr0Color* unpackFrom16(preCompGGX.xy) + materialData.sr90Color * unpackFrom16(preCompGGX.zw);","specularIBLValue = cubeColor.xyz * GFresnelVoH;","#ifdef USE_SSLREFLECTION","vec4 ssrColor = texture2D(reflectionColorTexture, gl_FragCoord.xy * invScreenSize);","ssrColor.xyz *= GFresnelVoH;","specularIBLValue = mix(specularIBLValue, ssrColor.xyz, ssrColor.w);","#endif","specularIBLValue *= hOcclusion;","#if defined(USE_SSLREFRACTION)","if (materialData.transparency > 0.0 && materialData.metalness < 1.0) {","#ifdef THIN_WALLED","vec3 refractVec = refract(cameraToVertex, surfaceData.worldNormal, 1.0);","#else","vec3 refractVec = refract(cameraToVertex, surfaceData.worldNormal, 1.0/materialData.adjustedIoR);","#endif","#ifdef USE_REFLECTION_PROBE","refractVec = correctParallax(surfaceData.worldPosition, refractVec);","#endif","#ifdef USE_FINITE_ENVMAP","refractVec = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, refractVec, surfaceData.worldPosition);","#endif","vec2 refractionUV = getEnvMapUV(refractVec);","#ifdef USE_REFLECTION_PROBE","vec4 cubeRefractColor = envMapExposureSpecular * sampleMipMapRoughness( refractionUV, mips.x, mips.y, reflectionProbe, reflectionProbeMips);","#else","vec4 cubeRefractColor = envMapExposureSpecular * sampleMipMapRoughness( refractionUV, mips.x, mips.y, envMap, envMap2);","#endif","float GRefract = unpackFrom16(sampleBRDFTexture(-NdotV,  materialData.roughness, PRECOMPUTED_TEXTURE_3).xy);","vec4 ssrefractionColor = texture2D(refractionColorTexture, gl_FragCoord.xy * invScreenSize);","cubeRefractColor.xyz = mix(cubeRefractColor.xyz, ssrefractionColor.xyz, ssrefractionColor.w);","#ifdef DSPBR","float fTransRefraction = 1.0 - materialData.specularContribution * vMax(FresnelSchlick(materialData.specularBlendingSR0, vec3(1.0), NdotV));","#else","float fTransRefraction = 1.0 - vMax(FresnelSchlick(materialData.sr0Color, materialData.sr90Color, NdotV));","#endif","cubeRefractColor.xyz *= GRefract * materialData.transparentColor * fTransRefraction;","#ifdef USE_SUBSURFACE","#ifdef THICKNESS_BASED_TRANSMITTANCE","cubeRefractColor.xyz *= materialData.transmittanceColor;","#elif defined(USE_SSSLUT)","cubeRefractColor.xyz *= GetTransmittance(vMax(maxTranslucencyDepth)/ 15.0);","#else","cubeRefractColor.xyz *= GetTransmittance(1.0 / vMax(absorptionCoefficients));","#endif","#endif","specularIBLValue += cubeRefractColor.xyz;","}","#endif","vec3 diffuseIBLValue = vec3(0.0);","vec4 diffuseTexelColor = vec4(0.0);","vec3 diffuseInvIBLValue = vec3(0.0);","#if defined( USE_LATLONGMAP )","vec2 normalUV = getEnvMapUV(normalize(surfaceData.worldNormal));","#if defined(USE_ENVMAP_DIFFUSE) && !defined(USE_REFLECTION_PROBE)","float diffMip = 6.0;","#else","float diffMip = 5.0;","#endif","vec4 diffUVBox;","#ifdef NON_REPEAT_IBL_SAMPLING","diffUVBox.xy = getUVFromMips(diffMip, normalUV, mipsTexelSize);","#else","diffUVBox = getUVBoxFromMips(diffMip, mipsTexelSize);","#endif","#ifdef USE_REFLECTION_PROBE","diffuseTexelColor = envMapExposureDiffuse * texture2DBilinearFromRGBEwBox(reflectionProbeMips, diffUVBox, normalUV, mipsSize, mipsTexelSize);","#else","diffuseTexelColor = envMapExposureDiffuse * texture2DBilinearFromRGBEwBox(envMap2, diffUVBox, normalUV, mipsSize, mipsTexelSize);","#endif","#ifdef DSPBR","specularIBLValue += diffuseTexelColor.rgb * materialData.specularEnergyConservationConstant;","diffuseTexelColor *= materialData.diffuseEnergyConservationConstant;","#else","diffuseTexelColor *= SpecGlossEnergyConservationTerm(GFresnelVoH);","#endif","diffuseIBLValue = materialData.diffuseColor * diffuseTexelColor.xyz  ;","#if defined(DSPBR_WITH_TRANSLUCENCY) && (!defined(USE_SUBSURFACE) || defined(THICKNESS_BASED_TRANSMITTANCE))","if (materialData.translucency > 1e-6) {","vec2 normalInvUV = getEnvMapUV(normalize(-surfaceData.worldNormal));","#ifdef USE_REFLECTION_PROBE","vec4 diffuseInvTexelColor = envMapExposureDiffuse * texture2DBilinearFromRGBEwBox(reflectionProbeMips, diffUVBox, normalInvUV, mipsSize, mipsTexelSize);","#else","vec4 diffuseInvTexelColor = envMapExposureDiffuse * texture2DBilinearFromRGBEwBox(envMap2, diffUVBox, normalInvUV, mipsSize, mipsTexelSize);","#endif","diffuseInvIBLValue = materialData.translucencyColor * diffuseInvTexelColor.rgb * materialData.diffuseEnergyConservationConstant;","}","#endif","#endif"].join("\n"),r=["#if defined(USE_SHEEN) && defined(USE_ENVMAP_SHEEN)","vec3 sheenIBLValue = vec3(0.0);","#ifdef DSPBR_WITH_SHEEN_COLOR_ROUGHNESS","float sheenRough_IBL = materialData.sheenRoughness;","#ifdef DSPBR_WITH_SQUARED_ESTEVEZKULLA_ROUGHNESS","sheenRough_IBL *= sheenRough_IBL;","#endif","#else","float sheenRough_IBL = materialData.sheen;","#endif","#if defined(USE_SATIN)","sheenRough_IBL = 0.3;","#endif","#if defined(USE_VELVET) || defined(USE_SOFT_VELVET)","vec2 mipsF = getMipsLinearInverted(sheenRough_IBL);","#if defined(USE_VELVET)","float GFab = unpackFrom16(sampleBRDFTexture(NdotV, sheenRough_IBL, PRECOMPUTED_TEXTURE_2).zw);","#else","float GFab = unpackFrom16(sampleBRDFTexture(NdotV, sheenRough_IBL, PRECOMPUTED_TEXTURE_3).zw);","#endif","#else","vec2 mipsF = getMipsLinear(sheenRough_IBL);","float GFab = unpackFrom16(sampleBRDFTexture(NdotV, sheenRough_IBL, PRECOMPUTED_TEXTURE_2).xy);","#endif","vec4 sheenColor = sampleMipMapRoughnessSheen( reflectionUV, mipsF.x, mipsF.y, envMapSheen);","sheenIBLValue = GFab * sheenColor.rgb;","#ifndef DSPBR_WITH_SHEEN_COLOR_ROUGHNESS","float sheenBlending = 1.0 - pow5(1.0-materialData.sheen);","diffuseIBLValue *= PI * sheenBlending * sheenIBLValue.rgb + (1.0 - sheenBlending);","#else","float sheenBlending = 1.0 - materialData.sheenEnergyConservationConstant;","diffuseIBLValue *= sheenBlending;","specularIBLValue *= sheenBlending;","specularIBLValue +=  materialData.sheen * materialData.sheenColor * sheenIBLValue.rgb;","#endif","#endif"].join("\n"),n=["#ifdef CLEAR_COAT","vec3 clearCoatIBLValue = vec3(0.0);","float NdotVcoating = dot(surfaceData.clearCoatNormal, surfaceData.view);","vec3 reflectVecCoating = reflect( cameraToVertex, surfaceData.clearCoatWorldNormal );","vec2 mipsC = getMips(materialData.clearCoatRoughness);","vec4 cubeColorcoating;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_REFLECTION_PROBE","reflectVecCoating = correctParallax(surfaceData.worldPosition, reflectVecCoating);","#endif","#ifdef USE_FINITE_ENVMAP","reflectVecCoating = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, reflectVecCoating, surfaceData.worldPosition);","#endif","vec2 reflectionUVcoating = getEnvMapUV(reflectVecCoating);","#ifdef USE_REFLECTION_PROBE","cubeColorcoating = envMapExposureSpecular * sampleMipMapRoughness( reflectionUVcoating, mipsC.x, mipsC.y, reflectionProbe, reflectionProbeMips);","#else","cubeColorcoating = envMapExposureSpecular * sampleMipMapRoughness( reflectionUVcoating, mipsC.x, mipsC.y, envMap, envMap2);","#endif","#endif","#ifdef CLEAR_COAT_NORMALMAP","float chOcclusion = computeHorizonFade(reflectVecCoating, worldVertexNormal, materialData.clearCoatRoughness);","chOcclusion *= chOcclusion;","#else","float chOcclusion = 1.0;","#endif","vec4 precompCoat = sampleBRDFTexture(NdotVcoating, materialData.clearCoatRoughness, PRECOMPUTED_TEXTURE_1);","vec3 GFresnelVoHCoat = unpackFrom16(precompCoat.xy) * materialData.clearCoatSR0Color + unpackFrom16(precompCoat.zw) * materialData.clearCoatSR90Color;","clearCoatIBLValue = cubeColorcoating.xyz * GFresnelVoHCoat;","#ifdef DSPBR","float energyCoating = 1.0 - materialData.clearCoat* vMax(FresnelSchlick(materialData.clearCoatSR0Color,materialData.clearCoatSR90Color,saturate(NdotVcoating)));","#else","float energyCoating = SpecGlossEnergyConservationTerm(GFresnelVoHCoat);","#endif","specularIBLValue.xyz *= energyCoating;","diffuseIBLValue.xyz *= energyCoating;","specularIBLValue.xyz += clearCoatIBLValue * materialData.clearCoat * chOcclusion;","#endif"].join("\n");t=["#ifndef DEBUG_SHADOW","#if defined(USE_ENVMAP) && defined(USE_LIGHTING)","vec3 cameraToVertex;","if (projectionMatrix[3][3] > 0.5) {","cameraToVertex = normalize( vec3( vec4( 0.0,0.0,-1.0, 0.0 ) * viewMatrix ) );","} else {","cameraToVertex = normalize( surfaceData.worldPosition - cameraPosition );","}","vec3 worldVertexNormal = normalize( vec3( vec4( vertexNormal, 0.0 ) * viewMatrix ) );","float NdotV = dot(surfaceData.viewNormal, surfaceData.view);","#ifdef USE_ANISOTROPY","vec3 bitangent = normalize(vec3(vec4(sin(2.0 * PI * materialData.anisotropyAngle) * surfaceData.tangent + cos(2.0 * PI * materialData.anisotropyAngle) * surfaceData.binormal, 0.0) * viewMatrix));","vec3 anisotropicTangent = cross(bitangent, -cameraToVertex);","vec3 anisotropicNormal = cross(anisotropicTangent, bitangent);","vec3 bentNormal = normalize(mix(surfaceData.worldNormal, anisotropicNormal, 0.22*materialData.anisotropy));","vec3 reflectVec = reflect( cameraToVertex, bentNormal );","#else","vec3 reflectVec = reflect( cameraToVertex, surfaceData.worldNormal );","#endif",i,"#ifdef USE_ANISOTROPY","reflectVec = reflect( cameraToVertex, surfaceData.worldNormal );","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_REFLECTION_PROBE","reflectVec = correctParallax(surfaceData.worldPosition, reflectVec);","#endif","#ifdef USE_FINITE_ENVMAP","reflectVec = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, reflectVec, surfaceData.worldPosition);","#endif","reflectionUV = getEnvMapUV(reflectVec);","#endif","#endif",["#ifdef USE_SUBSURFACE","#ifdef SPECGLOSS","diffuseIBLValue.rgb *= materialData.scatteringColor;","#else","vec3 baseDiffuseIBLValue = diffuseIBLValue.rgb;","#ifdef DSPBR_WITH_TRANSLUCENCY","diffuseIBLValue.rgb = mix(diffuseIBLValue.rgb, materialData.scatteringColor * baseDiffuseIBLValue, materialData.translucency);","#ifdef THICKNESS_BASED_TRANSMITTANCE","diffuseIBLValue.rgb = mix(diffuseIBLValue.rgb,  materialData.transmittanceColor * diffuseInvIBLValue.rgb, materialData.translucency);","#endif","#endif","diffuseIBLValue.rgb = mix(diffuseIBLValue.rgb, materialData.scatteringColor * baseDiffuseIBLValue, materialData.transparency);","#endif","#elif defined(DSPBR_WITH_TRANSLUCENCY)","diffuseIBLValue.rgb = mix(diffuseIBLValue.rgb, diffuseInvIBLValue.rgb, materialData.translucency);","#endif"].join("\n"),r,[["#if defined(USE_DSPBR_FLAKES)","vec2 mipsDSPBRFlakes = getMips(flakesData.flakesRoughness);","vec3 flakesIBLValue = vec3(0.0);","if (flakesData.smoothWeight > 0.0) {","vec2 reflectionUVSmoothFlakes = reflectionUV;","#ifdef USE_REFLECTION_PROBE","vec4 cubeColorSmoothFlakes = envMapExposureSpecular * sampleMipMapRoughness( reflectionUVSmoothFlakes, mipsDSPBRFlakes.x, mipsDSPBRFlakes.y, reflectionProbe, reflectionProbeMips);","#else","vec4 cubeColorSmoothFlakes = envMapExposureSpecular * sampleMipMapRoughness( reflectionUVSmoothFlakes, mipsDSPBRFlakes.x, mipsDSPBRFlakes.y, envMap, envMap2);","#endif","float GSmoothFlakes = unpackFrom16(sampleBRDFTexture(NdotV, flakesData.flakesRoughness, PRECOMPUTED_TEXTURE_3).xy);","flakesIBLValue += cubeColorSmoothFlakes.xyz * GSmoothFlakes * flakesData.smoothFlakesColor;","}","if (flakesData.stochasticWeight > 0.0) {","vec3 worldReflStoFlakes = normalize( vec3( vec4( flakesData.stochasticHemisphereFlakesReflect, 0.0 ) * viewMatrix ) );","vec3 stoNormal = flakesData.stochasticHemisphereFlakesNormal;","float NdotVSto = dot(stoNormal, surfaceData.view);","#ifdef USE_REFLECTION_PROBE","worldReflStoFlakes = correctParallax(surfaceData.worldPosition, worldReflStoFlakes);","#endif","#ifdef USE_FINITE_ENVMAP","worldReflStoFlakes = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, worldReflStoFlakes, surfaceData.worldPosition);","#endif","float GStoFlakes = unpackFrom16(sampleBRDFTexture(NdotVSto, flakesData.flakesRoughness, PRECOMPUTED_TEXTURE_3).xy);","vec2 stoFlakesEnvMapUV = getEnvMapUV(worldReflStoFlakes);","#ifdef USE_REFLECTION_PROBE","vec4 stoFlakesTexelColor = envMapExposureSpecular * sampleMipMapRoughness( stoFlakesEnvMapUV, mipsDSPBRFlakes.x, mipsDSPBRFlakes.y, reflectionProbe, reflectionProbeMips);","#else","vec4 stoFlakesTexelColor = envMapExposureSpecular * sampleMipMapRoughness( stoFlakesEnvMapUV, mipsDSPBRFlakes.x, mipsDSPBRFlakes.y, envMap, envMap2);","#endif","flakesIBLValue += flakesData.stochasticHemisphereFlakesColor * stoFlakesTexelColor.xyz * GStoFlakes;","}","if (flakesData.closeupWeight > 0.0) {","vec3 worldReflCloseFlakes = normalize( vec3( vec4( flakesData.closeupFlakesReflect, 0.0 ) * viewMatrix ) );","vec3 closeNormal = flakesData.closeupFlakesNormal;","float NdotVClose = dot(closeNormal, surfaceData.view);","#ifdef USE_REFLECTION_PROBE","worldReflCloseFlakes = correctParallax(surfaceData.worldPosition, worldReflCloseFlakes);","#endif","float GCloseFlakes = unpackFrom16(sampleBRDFTexture(NdotVClose, flakesData.flakesRoughness, PRECOMPUTED_TEXTURE_3).xy);","#ifdef USE_FINITE_ENVMAP","worldReflCloseFlakes = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, worldReflCloseFlakes, surfaceData.worldPosition);","#endif","vec2 closeFlakesEnvMapUV = getEnvMapUV(worldReflCloseFlakes);","#ifdef USE_REFLECTION_PROBE","vec4 closeFlakesTexelColor = envMapExposureSpecular * sampleMipMapRoughness( closeFlakesEnvMapUV, mipsDSPBRFlakes.x, mipsDSPBRFlakes.y, reflectionProbe, reflectionProbeMips);","#else","vec4 closeFlakesTexelColor = envMapExposureSpecular * sampleMipMapRoughness( closeFlakesEnvMapUV, mipsDSPBRFlakes.x, mipsDSPBRFlakes.y, envMap, envMap2);","#endif","flakesIBLValue += flakesData.closeupFlakesColor * closeFlakesTexelColor.xyz * GCloseFlakes;","}","diffuseIBLValue *= flakesData.baseWeight;","specularIBLValue *= flakesData.baseWeight;","specularIBLValue += flakesIBLValue;","#endif"].join("\n"),["#if defined(USE_SPECGLOSS_FLAKES)","float NdotVMetalFlakes = dot(metalFlakes.flakesNormal, surfaceData.view);","vec3 reflectVecMetalFlakes = reflect( cameraToVertex, metalFlakes.flakesWorldNormal );","float NdotRMetalFlakes = max(dot(metalFlakes.flakesWorldNormal, reflectVecMetalFlakes), 0.0);","float NdotVMetal = NdotV;","vec2 mipsMetalFlakes = getMips(metalFlakes.flakesRoughness);","vec2 mipsMetal = getMips(metal.flakesRoughness);","vec4 cubeColorMetal;","vec4 cubeColorMetalFlakes;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_REFLECTION_PROBE","reflectVecMetalFlakes = correctParallax(surfaceData.worldPosition, reflectVecMetallicFlakes);","#endif","#ifdef USE_FINITE_ENVMAP","reflectVecMetalFlakes = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, reflectVecMetalFlakes, surfaceData.worldPosition);","#endif","vec2 reflectionUVMetalFlakes = getEnvMapUV(reflectVecMetalFlakes);","vec2 reflectionUVMetal = reflectionUV;","#ifdef USE_REFLECTION_PROBE","cubeColorMetalFlakes = envMapExposureSpecular * sampleMipMapRoughness( reflectionUVMetalFlakes, mipsMetalFlakes.x, mipsMetalFlakes.y, reflectionProbe, reflectionProbeMips);","cubeColorMetal = envMapExposureSpecular * sampleMipMapRoughness( reflectionUVMetal, mipsMetal.x, mipsMetal.y, reflectionProbe, reflectionProbeMips);","#else","cubeColorMetalFlakes = envMapExposureSpecular * sampleMipMapRoughness( reflectionUVMetalFlakes, mipsMetalFlakes.x, mipsMetalFlakes.y, envMap, envMap2);","cubeColorMetal = envMapExposureSpecular * sampleMipMapRoughness( reflectionUVMetal, mipsMetal.x, mipsMetal.y, envMap, envMap2);","#endif","#endif","float mFhOcclusion = computeHorizonFade(reflectVecMetalFlakes, worldVertexNormal, metalFlakes.flakesRoughness);","mFhOcclusion *= mFhOcclusion;","vec3 metalFlakesIBLValue = vec3(0.0);","vec3 metalIBLValue = vec3(0.0);","vec4 precompMetalFlakes = sampleBRDFTexture(NdotVMetalFlakes, metalFlakes.flakesRoughness, PRECOMPUTED_TEXTURE_1);","vec4 precompMetal = sampleBRDFTexture(NdotVMetal, metal.flakesRoughness, PRECOMPUTED_TEXTURE_1);","vec3 GFresnelVoHMetalFlakes = unpackFrom16(precompMetalFlakes.xy) * metalFlakes.flakesSR0Color ;","vec3 GFresnelVoHMetal = unpackFrom16(precompMetal.xy) * metal.flakesSR0Color ;","metalFlakesIBLValue = cubeColorMetalFlakes.xyz * GFresnelVoHMetalFlakes;","metalIBLValue = cubeColorMetal.xyz * GFresnelVoHMetal;","float energyMetalFlakes = SpecGlossEnergyConservationTerm(GFresnelVoHMetalFlakes);","diffuseIBLValue *= energyMetalFlakes;","specularIBLValue *= energyMetalFlakes;","specularIBLValue += mFhOcclusion*metalFlakesIBLValue;","float energyMetal = SpecGlossEnergyConservationTerm(GFresnelVoHMetal);","diffuseIBLValue *= energyMetal;","specularIBLValue *= energyMetal;","specularIBLValue += hOcclusion*metalIBLValue;","#endif"].join("\n"),["#if defined(USE_SPECGLOSS_FLAKES) && defined(PEARL_FLAKES_ACTIVATED)","float NdotVPearlFlakes = dot(pearlFlakes.flakesNormal, surfaceData.view);","vec3 reflectVecPearlFlakes = reflect( cameraToVertex, pearlFlakes.flakesWorldNormal );","vec2 mipsPearl = getMips(pearlFlakes.flakesRoughness);","vec4 cubeColorPearlFlakes;","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_REFLECTION_PROBE","reflectVecPearlFlakes = correctParallax(surfaceData.worldPosition, reflectVecPearlFlakes);","#endif","#ifdef USE_FINITE_ENVMAP","reflectVecPearlFlakes = correctParallaxFinite(sphereCenter, projectionCenter, sphereRadius, reflectVecPearlFlakes, surfaceData.worldPosition);","#endif","vec2 reflectionUVPearlFlakes = getEnvMapUV(reflectVecPearlFlakes);","#ifdef USE_REFLECTION_PROBE","cubeColorPearlFlakes = envMapExposureSpecular * sampleMipMapRoughness( reflectionUVPearlFlakes, mipsPearl.x, mipsPearl.y, reflectionProbe, reflectionProbeMips);","#else","cubeColorPearlFlakes = envMapExposureSpecular * sampleMipMapRoughness( reflectionUVPearlFlakes, mipsPearl.x, mipsPearl.y, envMap, envMap2);","#endif","#endif","float pFhOcclusion = computeHorizonFade(reflectVecPearlFlakes, worldVertexNormal, pearlFlakes.flakesRoughness);","pFhOcclusion *= pFhOcclusion;","vec3 pearlFlakesIBLValue = vec3(0.0);","vec4 precompPearlFlakes = sampleBRDFTexture(NdotVPearlFlakes, pearlFlakes.flakesRoughness, PRECOMPUTED_TEXTURE_1);","vec3 GFresnelVoHPearlFlakes = unpackFrom16(precompPearlFlakes.xy) * pearlFlakes.flakesSR0Color ;","pearlFlakesIBLValue = cubeColorPearlFlakes.xyz * GFresnelVoHPearlFlakes;","float energyPearlFlakes = SpecGlossEnergyConservationTerm(GFresnelVoHPearlFlakes);","diffuseIBLValue *= energyPearlFlakes;","specularIBLValue *= energyPearlFlakes;","specularIBLValue += pFhOcclusion*pearlFlakesIBLValue;","#endif"].join("\n")].join("\n"),n,"#ifdef INVISIBLE_PLANE_MATERIAL","diffuseIBLValue = vec3(vMax(diffuseIBLValue));","lightNormalizationFactor += diffuseIBLValue;","#endif","vec3 totalIBLValue = specularIBLValue + diffuseIBLValue;","#ifdef USE_LIGHTMAP","#ifdef LIGHTMAP_IRRADIANCE_MODE","totalIBLValue *= clamp(aoValue, 0.0, 1.0);","#else","totalIBLValue *= aoValue;","#endif","#endif","gl_FragColor.xyz += totalIBLValue;","#ifdef INVISIBLE_PLANE_MATERIAL","if (length(lightNormalizationFactor) < 1e-6) {","gl_FragColor.xyz = vec3(1.0);","} else {","gl_FragColor.xyz /= lightNormalizationFactor;","}","#endif","#elif !defined(USE_LIGHTING)","#ifdef USE_LIGHTMAP","gl_FragColor.xyz = aoValue * albedo;","#else","gl_FragColor.xyz = albedo;","#endif","#ifdef USE_SUBSURFACE","gl_FragColor.xyz *= materialData.scatteringColor;","#endif","#ifdef INVISIBLE_PLANE_MATERIAL","gl_FragColor.xyz = vec3(1.0);","#endif","#else","vec3 ambientTerm = ambientLightColor;","#ifdef INVISIBLE_PLANE_MATERIAL","ambientTerm = vec3(vMax(ambientTerm));","lightNormalizationFactor += ambientTerm;","#endif","vec3 ambientColor = albedo;","#ifdef USE_SUBSURFACE","ambientColor *= materialData.scatteringColor;","#endif","vec3 specularColor = vec3(0.0);","#if defined(USE_SSLREFLECTION) || defined(USE_SSLREFRACTION)","float NdotV = dot(surfaceData.viewNormal, surfaceData.view);","#endif","#ifdef USE_SSLREFLECTION","vec4 preCompGGX = sampleBRDFTexture(NdotV, materialData.roughness, PRECOMPUTED_TEXTURE_1);","vec3 GFresnelVoH = materialData.sr0Color* unpackFrom16(preCompGGX.xy) + materialData.sr90Color * unpackFrom16(preCompGGX.zw);","vec4 ssrColor = texture2D(reflectionColorTexture, gl_FragCoord.xy * invScreenSize);","ssrColor.xyz *= GFresnelVoH;","specularColor += ssrColor.w * ssrColor.xyz;","#endif","#if defined(USE_SSLREFRACTION)","if (materialData.transparency > 0.0 && materialData.metalness < 1.0) {","float GRefract = unpackFrom16(sampleBRDFTexture(-NdotV,  materialData.roughness, PRECOMPUTED_TEXTURE_3).xy);","vec4 ssrefractionColor = texture2D(refractionColorTexture, gl_FragCoord.xy * invScreenSize);","ssrefractionColor.xyz *= GRefract * materialData.transparentColor * (1.0 - materialData.specularContribution * vMax(FresnelSchlick(materialData.specularBlendingSR0, vec3(1.0), NdotV)));","specularColor += ssrefractionColor.w * ssrefractionColor.xyz;","}","#endif","#ifdef USE_LIGHTMAP","#ifdef LIGHTMAP_IRRADIANCE_MODE","gl_FragColor.xyz +=  aoValue * ambientColor;","#else","gl_FragColor.xyz +=  aoValue * ambientColor  * ambientTerm;","#endif","#else","gl_FragColor.xyz += ambientColor * ambientTerm;","#endif","gl_FragColor.xyz += specularColor;","#ifdef INVISIBLE_PLANE_MATERIAL","if (length(lightNormalizationFactor) < 1e-6) {","gl_FragColor.xyz = vec3(1.0);","} else {","gl_FragColor.xyz /= lightNormalizationFactor;","}","#endif","#endif","#endif"].join("\n")}else t=["#ifdef USE_LIGHTMAP","gl_FragColor.xyz = aoValue * albedo;","#else","gl_FragColor.xyz = albedo;","#endif"].join("\n");return t}(t),T,e.ShaderChunk.postprocess_fragment,e.ShaderChunk.linear_to_gamma_fragment,e.ShaderChunk.PDSFX_end_fragment,e.ShaderChunk.fog_fragment,e.ShaderChunk.backgroundviewmode_lowlight_fragment,e.DeferredShaderChunk._debug_common_face_fragment,e.DeferredShaderChunk.oit_fragment,!t&&X?e.DeferredShaderChunk.picking_fragment:"",!t&&X?e.DeferredShaderChunk.picking_instancing_fragment:"",!t&&X?e.DeferredShaderChunk.depth_fragment_face:"",!t&&X?e.DeferredShaderChunk.normal_fragment:"",!t&&X?e.DeferredShaderChunk.normal_depth_fragment:"",!t&&X?e.DeferredShaderChunk.shadowmap_fragment:"",!t&&X?e.DeferredShaderChunk.highlight_fragment_face:"",!t&&X?e.DeferredShaderChunk.texcoord_fragment:"","}"].join("\n")};return{uniforms:e.UniformsUtils.merge([e.UniformsLib.common,e.UniformsLib.bump,e.UniformsLib.normalmap,e.UniformsLib.lights,e.UniformsLib.shadowmap,e.UniformsLib.clipPlanes,e.UniformsLib.postprocess,X?e.UniformsLib.deferred:{},j]),vertexShader:q(!0),vertexShaderNoLight:q(!1),fragmentShader:Z(!0),fragmentShaderNoLight:Z(!1)}});var toto=function(){return null};function HighlightMeshData(e,t){this.selectionId=e,this.renderable=t}define("DS/Intersection/Raycaster",["DS/Visualization/ThreeJS_R57","DS/Intersection/Ray"],function(e,t){"use strict";var i=function(e,i,r,n){this.ray=new t(e,i),this.ray.direction.lengthSq()>0&&this.ray.direction.normalize(),this.near=r||0,this.far=n||1/0},r=new e.Sphere,n=new t,a=new e.Plane,s=new e.Vector3,o=new e.Vector3,l=new e.Matrix4,c=function(e,t){return e.distance-t.distance},h=function(t,i,c){if(t instanceof e.Particle){o.getPositionFromMatrix(t.matrixWorld);var h=i.ray.distanceToPoint(o);if(h>t.scale.x)return c;c.push({distance:h,point:t.position,face:null,object:t})}else if(t instanceof e.Mesh){var u=t._getMMMatrix();if(o.getPositionFromMatrix(u),r.set(o,t.geometry.boundingSphere.radius*u.getMaxScaleOnAxis()),!i.ray.isIntersectionSphere(r))return c;var d,p,f,m,g=t.geometry,v=g.vertices,S=t.material instanceof e.MeshFaceMaterial,_=!0===S?t.material.materials:null,y=t.material.side,x=i.precision;t.matrixRotationWorld.extractRotation(u),l.getInverse(u),n.copy(i.ray).applyMatrix4(l);for(var M=0,P=g.faces.length;M<P;M++){var C=g.faces[M],b=!0===S?_[C.materialIndex]:t.material;if(void 0!==b){a.setFromNormalAndCoplanarPoint(C.normal,v[C.a]);var D=n.distanceToPlane(a);if(!(Math.abs(D)<x||D<0)){if((y=b.side)!==THREEConstants.DoubleSide){var w=n.direction.dot(a.normal);if(!(y===THREEConstants.FrontSide?w<0:w>0))continue}if(!(D<i.near||D>i.far)){if(s=n.at(D,s),C instanceof e.Face3){if(d=v[C.a],p=v[C.b],f=v[C.c],!e.Triangle.containsPoint(s,d,p,f))continue}else{if(!(C instanceof e.Face4))throw Error("face type not supported");if(d=v[C.a],p=v[C.b],f=v[C.c],m=v[C.d],!e.Triangle.containsPoint(s,d,p,m)&&!e.Triangle.containsPoint(s,p,f,m))continue}c.push({distance:D,point:i.ray.at(D),face:C,faceIndex:M,object:t})}}}}}},u=function(e,t,i){for(var r=e.getDescendants(),n=0,a=r.length;n<a;n++)h(r[n],t,i)};return i.prototype.precision=1e-4,i.prototype.set=function(e,t){this.ray.set(e,t),this.ray.direction.length()>0&&this.ray.direction.normalize()},i.prototype.intersectObject=function(e,t){var i=[];return!0===t&&u(e,this,i),h(e,this,i),i.sort(c),i},i.prototype.intersectObjects=function(e,t){for(var i=[],r=0,n=e.length;r<n;r++)h(e[r],this,i),!0===t&&u(e[r],this,i);return i.sort(c),i},i}),define("DS/Visualization/ThreeJS_DS",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh","DS/Intersection/Ray","DS/Intersection/Raycaster","DS/Shaders/PBRShaders","DS/Visualization/BufferGeometry","DS/Shaders/DeferredShaders","DS/Shaders/AdvancedHighlightShader","DS/Shaders/AdvancedHighlightShaderSinglePass","DS/Materials/DeferredCaches","DS/RenderEngineUtils/RenderEngineUtils"],function(e,t,i,r,n,a,s,o,l,c,h,u,d){"use strict";var p,f,m="undefined"!=typeof EXPERIENCE_PLAYER,g=window.SIMULATE_EXPERIENCE_PLAYER;new i.Color;i.mobileVersion=!1,i._mobileHighlight=!0,i._mobileDevice=!1,i._visuFaceMaterialsAsPBR=!1,i._CATGraphicalAsPBR=!0,i._GASFaceMaterialsAsPBR=!1,i._DeferredShaders=l,i._AdvancedHighlightShader=c,i._AdvancedHighlightShaderSinglePass=h,i.DefaultNormalDepthMaterials=u.DefaultNormalDepthMaterials,i.DefaultShadowDepthMaterials=u.DefaultShadowDepthMaterials,i.DefaultPickingMaterials=u.DefaultPickingMaterials,i.DefaultHighlightMaterials=u.DefaultHighlightMaterials,i.DefaultMaterials=u.DefaultMaterials,i.PredefinedMaterials=u.PredefinedMaterials,i.GeomTypeMaterials=u.GeomTypeMaterials,i.DeferredMaterial=u.DeferredMaterial,i.__tmpIsA2X=!1,window.webVisuPerfo||(window.webVisuPerfo={startPerfo:function(){},endPerfo:function(){},setStats:function(){}}),i.getPixelsPerMM=function(){return 96/25.4},i.Frustum.__v2=new i.Vector3,i.Frustum.prototype.intersectsObject=function(e,t,r){var n=this.planes,a=e._getMMMatrix(),s=e.geometry.boundingSphere,o=-s.radius*a.getMaxScaleOnAxis(),l=i.Frustum.__v2;null!==s?l.copy(s.center):l.set(0,0,0),l.applyMatrix4(a);for(var c=0;c<6;c++)if(n[c].distanceToPoint(l)<=o)return!1;return!0},i.Frustum.prototype.performFrustumCulling=function(e,t){for(var i=this.planes,r=-e,n=null,a=null,s=0;s<6;s++)if((a=(n=i[s]).normal).x*t.x+a.y*t.y+a.z*t.z+n.constant<=r)return!1;return!0},i.Frustum.prototype.performFrustumCullingNoNearFar=function(e,t){for(var i=this.planes,r=-e,n=null,a=null,s=0;s<4;s++)if((a=(n=i[s]).normal).x*t.x+a.y*t.y+a.z*t.z+n.constant<=r)return!1;return!0},i.Frustum.prototype.getCorners=function(){var e=[],t=new i.Matrix4,r=new i.Matrix4,n=this;function a(e,a,s){var o=n.planes[e],l=n.planes[a],c=n.planes[s];t.set(o.normal.x,o.normal.y,o.normal.z,0,l.normal.x,l.normal.y,l.normal.z,0,c.normal.x,c.normal.y,c.normal.z,0,0,0,0,1),r.getInverse(t);var h=(new i.Vector4).set(-o.constant,-l.constant,-c.constant,1);return h.applyMatrix4(r),h}return e[0]=a(1,2,5),e[1]=a(0,2,5),e[2]=a(0,3,5),e[3]=a(1,3,5),e[4]=a(1,2,4),e[5]=a(0,2,4),e[6]=a(0,3,4),e[7]=a(1,3,4),e},i.CGPolygon=function(){this.corner=[]},i.CGPolygon.prototype={constructor:i.CGPolygon,clone:function(e){var t=e||new i.CGPolygon;t.empty();for(var r=0;r<this.corner.length;r++)t.addPoint(this.corner[r]);return t},empty:function(){this.corner=[]},applyMatrix4:function(e){for(var t=0;t<this.corner.length;t++)this.corner[t].applyMatrix4(e);return this},addPoint:function(e){return this.corner.push((new i.Vector3).copy(e)),this},addPoints:function(e){return this.corner=e,this},addPointAtIndex:function(e,t){return this.corner[e]=new i.Vector3,this.corner[e].copy(t),this},clipByPlane:function(e,t){var r=new i.CGPolygon,n=this.corner.length;if(n<3)return r;for(var a=[],s=0;s<n;s++)a[s]=e.distanceToPoint(this.corner[s])>0;for(s=0;s<n;s++){var o=(s+1)%n;if(!a[s]||!a[o])if(a[s]){var l=new i.Vector3,c=new i.Line3(this.corner[s],this.corner[o]);void 0!==e.intersectLine(c,l)&&(t.addPoint(l),r.addPoint(l)),t.addPoint(this.corner[o])}else if(a[o]){l=new i.Vector3,c=new i.Line3(this.corner[s],this.corner[o]);void 0!==e.intersectLine(c,l)&&(t.addPoint(l),r.addPoint(l))}else t.addPoint(this.corner[o])}return r.corner.length&&2!==r.corner.length&&(this.clone(t),r.empty()),r}},i.CGPoly=function(){return this.polygon=[],this},i.CGPoly.prototype={constructor:i.CGPoly,addPolygon:function(e){this.polygon.push(e)},removePolygon:function(e){e>=this.polygon.length||e<0?console.log("CGPoly: trying to remove a polygon which does not exist !"):this.polygon.splice(e,1)},empty:function(){this.polygon=[]},clone:function(e){var t=e||new i.CGPoly;t.empty();for(var r=0;r<this.polygon.length;r++)t.addPolygon(this.polygon[r].clone());return t},applyMatrix4:function(e){for(var t=0;t<this.polygon.length;t++)this.polygon[t].applyMatrix4(e);return this},setFromBox:function(e){var t;(t=new i.CGPolygon).addPoint((new i.Vector3).copy(e.min)),t.addPoint(new i.Vector3(e.min.x,e.min.y,e.max.z)),t.addPoint(new i.Vector3(e.min.x,e.max.y,e.max.z)),t.addPoint(new i.Vector3(e.min.x,e.max.y,e.min.z)),this.addPolygon(t),(t=new i.CGPolygon).addPoint((new i.Vector3).copy(e.min)),t.addPoint(new i.Vector3(e.min.x,e.max.y,e.min.z)),t.addPoint(new i.Vector3(e.max.x,e.max.y,e.min.z)),t.addPoint(new i.Vector3(e.max.x,e.min.y,e.min.z)),this.addPolygon(t),(t=new i.CGPolygon).addPoint((new i.Vector3).copy(e.min)),t.addPoint(new i.Vector3(e.max.x,e.min.y,e.min.z)),t.addPoint(new i.Vector3(e.max.x,e.min.y,e.max.z)),t.addPoint(new i.Vector3(e.min.x,e.min.y,e.max.z)),this.addPolygon(t),(t=new i.CGPolygon).addPoint((new i.Vector3).copy(e.max)),t.addPoint(new i.Vector3(e.max.x,e.min.y,e.max.z)),t.addPoint(new i.Vector3(e.max.x,e.min.y,e.min.z)),t.addPoint(new i.Vector3(e.max.x,e.max.y,e.min.z)),this.addPolygon(t),(t=new i.CGPolygon).addPoint((new i.Vector3).copy(e.max)),t.addPoint(new i.Vector3(e.max.x,e.max.y,e.min.z)),t.addPoint(new i.Vector3(e.min.x,e.max.y,e.min.z)),t.addPoint(new i.Vector3(e.min.x,e.max.y,e.max.z)),this.addPolygon(t),(t=new i.CGPolygon).addPoint((new i.Vector3).copy(e.max)),t.addPoint(new i.Vector3(e.min.x,e.max.y,e.max.z)),t.addPoint(new i.Vector3(e.min.x,e.min.y,e.max.z)),t.addPoint(new i.Vector3(e.max.x,e.min.y,e.max.z)),this.addPolygon(t)},setFromFrustumPoints:function(e){for(var t=new i.CGPolygon,r=0;r<4;r++)t.addPoint((new i.Vector3).copy(e[r]));this.addPolygon(t),t=new i.CGPolygon;for(r=4;r<8;r++)t.addPointAtIndex(r-4,(new i.Vector3).copy(e[11-r]));this.addPolygon(t),(t=new i.CGPolygon).addPoint(e[0]),t.addPoint(e[3]),t.addPoint(e[7]),t.addPoint(e[4]),this.addPolygon(t),(t=new i.CGPolygon).addPoint(e[1]),t.addPoint(e[5]),t.addPoint(e[6]),t.addPoint(e[2]),this.addPolygon(t),(t=new i.CGPolygon).addPoint(e[4]),t.addPoint(e[5]),t.addPoint(e[1]),t.addPoint(e[0]),this.addPolygon(t),(t=new i.CGPolygon).addPoint(e[6]),t.addPoint(e[7]),t.addPoint(e[3]),t.addPoint(e[2]),this.addPolygon(t)},clipByPlane:function(e){var t,r,n=new i.CGPoly,a=new i.CGPoly;for(t=0;t<this.polygon.length;t++){var s=new i.CGPolygon,o=this.polygon[t].clipByPlane(e,s);s.corner.length&&(n.addPolygon(s),o.corner.length&&2===o.corner.length?a.addPolygon(o):o.corner.length>0&&console.log("plane / polygon intersection is not a segment : "+o.corner.length+" points"))}if(a.polygon.length>=3){var l=new i.CGPolygon,c=a.polygon[a.polygon.length-1];for(l.addPoint(c.corner[0]),l.addPoint(c.corner[1]),a.removePolygon(a.polygon.length-1);a.polygon.length>0;){var h=l.corner[l.corner.length-1],u=1/0,d=-1,p=-1;for(t=0;t<a.polygon.length;t++){var f=a.polygon[t];if(2===f.corner.length){for(r=0;r<f.corner.length;r++){var m=f.corner[r].distanceToSquared(h);if(m<1e-4)break;m<u&&(u=m,d=t,p=r)}if(r<f.corner.length){l.addPoint(f.corner[(r+1)%2]);break}}else console.log("convex hull clipping : intersection segment has length > 2")}if(t<a.polygon.length)a.removePolygon(t);else{if(!(d>=0)){console.log("failed to build the intersection polygon btw polyhedra and plane");break}l.addPoint(a.polygon[d].corner[(p+1)%2]),a.removePolygon(d)}}l.corner.splice(l.corner.length-1,1),n.addPolygon(l)}return n},clipByPlanes:function(e){if(!e.length)return null;for(var t=this.clipByPlane(e[0]),i=1;i<e.length;i++)t=t.clipByPlane(e[i]);return t},clipByBox:function(e){for(var t=e.getPlanes(),i=this.clipByPlane(t[0]),r=1;r<6;r++)i=i.clipByPlane(t[r]);return i},getPoints:function(){var e,t,i,r=[];for(t=0;t<this.polygon.length;t++)for(e=this.polygon[t],i=0;i<e.corner.length;i++)r.push(e.corner[i]);return r}},i.CGPolyHelper=function(e){i.Line.call(this),this._tokens={};this.frustumCulled=!1,this.geometry=new i.Geometry,this.material=new i.LineBasicMaterial({color:16777215,vertexColors:i.VertexColorType.Face}),this.type=i.LinePieces,this.matrixWorld=new i.Matrix4,this.matrixAutoUpdate=!1;for(var t=0;t<1e3;t++)this.geometry.vertices.push(new i.Vector3),this.geometry.colors.push(new i.Color(16711680));this.update(e,new i.Color(16711680))},i.CGPolyHelper.prototype=Object.create(i.Line.prototype),i.CGPolyHelper.prototype.update=function(e,t){var r,n=0;for(r=0;r<e.polygon.length;r++)for(var a=e.polygon[r],s=a.corner.length,o=0;o<s;o++){var l=a.corner[o];this.geometry.vertices[n].copy(l),this.geometry.colors[n].copy(t),n++,l=a.corner[(o+1)%s],this.geometry.vertices[n].copy(l),this.geometry.colors[n].copy(t),n++}var c=n>0?this.geometry.vertices[n-1]:new i.Vector3;for(r=n;r<1e3;r++)this.geometry.vertices[r].copy(c),this.geometry.colors[r].copy(t);this.geometry.verticesNeedUpdate=!0,this.geometry.colorsNeedUpdate=!0},i.BackgroundViewMode={NORMAL:0,FOG:1,LOWLIGHT:2,GHOST:3,NO_DISPLAY:4},i.PlaneViewMode={NORMAL:0,NO_DISPLAY:1,LOWLIGHT:2,LOWLIGHT_NO_PICK:3},i.ShaderLib.physicalDS=s,i._loadPredefinedMaterialTextures=u._loadPredefinedMaterialTextures,i.MaterialUtils={_addParameters:function(e,t,i){for(var r=0;r<i.length;r++)void 0!==t[i[r]]&&(e[i[r]]=t[i[r]]);var n=["line","point","depthWrite","depthTest","colorWrite","side","forceSide","force","transparent","polite","enableClipPlanes","polygonOffset","polygonOffsetFactor","polygonOffsetUnits","overridable","iterative","name"];for(r=0;r<n.length;r++)void 0!==t[n[r]]&&(e[n[r]]=t[n[r]])},convertShininessToIoRRoughness:function(e){return null==e?{ior:1.5,roughness:.34}:(e>1&&(e=Math.min(e/128,1)),{ior:1.5,roughness:1-e})},createShinyFaceMaterial:function(e){if(!i._visuFaceMaterialsAsPBR)return e&&e.color&&!e.ambient&&(e.ambient=e.color),new i.MeshPhongMaterial(e);var t={shininess:30};e&&this._addParameters(t,e,["color","map","shininess","opacity","alphaTest","vertexColors","useLighting"]);var r=this.convertShininessToIoRRoughness(t.shininess);return Object.assign(t,r),new i.DSPBR19xMaterial(t)},createMatteFaceMaterial:function(e){if(!i._visuFaceMaterialsAsPBR)return e&&e.color&&!e.ambient&&(e.ambient=e.color),new i.MeshLambertMaterial(e);var t={specularContrib:0};return e&&this._addParameters(t,e,["color","map","opacity","alphaTest","vertexColors","useLighting"]),new i.DSPBR19xMaterial(t)}},i.TangentToWorld=(p=new i.Vector3,f=new i.Vector3,function(e,t){var i=Math.abs(t.z)<.999?p.set(0,0,1):p.set(1,0,0);f.crossVectors(i,t);var r=f.normalize(),n=p.crossVectors(t,r);return r.multiplyScalar(e.x),n.multiplyScalar(e.y),r.add(n),n.copy(t),n.multiplyScalar(e.z),r.add(n),r}),i.RandomLib={_tmpVec2:new i.Vector2,_tmpVec3:new i.Vector3,HaltonSequence:function(e,t){for(var i=0,r=1/t,n=r;e>0;){i+=e%t*n,e=Math.floor(e/t),n*=r}return i},LowDiscrepancy2D:function(e,t,i,r){var n=this._tmpVec2;return n.x=this.HaltonSequence(e,2),n.y=this.HaltonSequence(e,5),n},computeHaltonSequence4D:function(e){for(var t=e*e,r=new Float32Array(4*t),n=0;n<t;n++)r[4*n]=this.HaltonSequence(n,2),r[4*n+1]=this.HaltonSequence(n,5),r[4*n+2]=this.HaltonSequence(n,7),r[4*n+3]=this.HaltonSequence(n,9);return new i.DataTexture(r,e,e,i.RGBAFormat,i.FloatType)}},i.LODTextureData=function(e,t,i,r,n){this.imageData=e,this.bufferData=t,this.loadCB=i,this.type=r,this.basisUsage=n},i.CSS2DNode=function(e,t,r){i.Object3D.call(this),this.element=e||document.createElement("div"),this.element.renderable=this,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.position=t||(this.position?this.position:new i.Vector3),this.pickable=!0,this.geometry=new i.Geometry,this.geometry.boundingSphere=new i.Sphere,this.offset=r||(this.offset?this.offset:new i.Vector2)},i.CSS2DNode.prototype=Object.create(i.Object3D.prototype),i.DisplayList=d.DisplayList,i.Ray=n,i.Raycaster=a,i.KDTree=null,i.CurvedPipeMesh=function(e,t,r){i.Mesh.call(this,e,t,r),this.isCurvedPipe=!0,this._capWorldRadius=0,this._nbLODsMinusOne=0,this.currentLOD=-1},i.CurvedPipeMesh.prototype=Object.create(i.Mesh.prototype),i.CurvedPipeMesh.prototype.clone=function(){var e=new i.CurvedPipeMesh(this.geometry,this.material);return i.Mesh.prototype.clone.call(this,e),e},i.CurvedPipeMesh.prototype.getMin=function(e){void 0===e&&(e="z");var t="x"===e?0:"y"===e?1:2,i=this.getNode();if(!i)return null;for(var r=null,n=0;n<i._pipes.length;n++){var a=i._pipes[n];if(!(a.curvePoints.length<2))for(var s=t;s<a.curvePoints.length;s+=3){var o=a.curvePoints[s]-a.radius;(o<r||null===r)&&(r=o)}}return r},i.CurvedPipeMesh.prototype._computeLOD=function(e,t){if(-1===this.currentLOD||e._renderingRole===i._CameraRoles.PRINCIPAL){var r=this._nbLODsMinusOne;if(0===r)return t.currentLOD=0,void(this.currentLOD=0);var n=this._capWorldRadius/e._cstLOD;if(!e.isOrtho){var a=this.worldCenter,s=e.matrixWorldInverse.elements,o=Math.abs(s[2]*a.x+s[6]*a.y+s[10]*a.z+s[14])-this.worldRadius;if(o<=0)return r;n/=o}var l=Math.min(r,Math.floor((n+11)/27));(l=Math.max(l,0))!==t.currentLOD&&(t.invalidated=!0,t.currentLOD=l,this.currentLOD=l)}},i.LensFlare.prototype.clone=function(e){void 0===e&&(e=new i.LensFlare),i.Object3D.prototype.clone.call(this,e),e.positionScreen.copy(this.positionScreen),e.customUpdateCallback=this.customUpdateCallback;for(var t=0;t<this.lensFlares.length;t++){var r=this.lensFlares[t],n={texture:r.texture,size:r.size,distance:r.distance,x:0,y:0,z:0,scale:1,rotation:1,opacity:r.opacity,color:r.color.clone(),blending:r.blending};e.lensFlares.push(n)}return e};var v={vertexShader:["uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uv;","vec2 pos = position;","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 screenPositionFlare;","uniform sampler2D tNormalDepth;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","void main() {","float visibility = 0.0;","float depth1 = texture2D( tNormalDepth, screenPositionFlare.xy ).w;","float depth2 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2( 0.005,  0.005) ).w;","float depth3 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2( 0.005, -0.005) ).w;","float depth4 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2(-0.005,  0.005) ).w;","float depth5 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2(-0.005, -0.005) ).w;","if ((depth1 == 0.0) || (screenPositionFlare.z < depth1)) visibility += 0.2;","if ((depth2 == 0.0) || (screenPositionFlare.z < depth2)) visibility += 0.2;","if ((depth3 == 0.0) || (screenPositionFlare.z < depth3)) visibility += 0.2;","if ((depth4 == 0.0) || (screenPositionFlare.z < depth4)) visibility += 0.2;","if ((depth5 == 0.0) || (screenPositionFlare.z < depth5)) visibility += 0.2;","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * visibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}"].join("\n")};function S(e,t){if(t<=e.getPrimitiveStart(0))return 0;for(var i,r=e.getPrimitivesCount()-1,n=0;r-n>1;)i=Math.floor((r+n)/2),e.getPrimitiveStart(i)<t?n=i:r=i;return r}i.LensFlarePlugin=function(){var e,t,r;this._lensFlare={},this.init=function(i){e=i.context,t=i;var n=this._lensFlare;r=i.getPrecision(),n.vertices=new Float32Array(16),n.faces=new Uint16Array(6);var a,s,o,l,c,h,u=0;n.vertices[u++]=-1,n.vertices[u++]=-1,n.vertices[u++]=0,n.vertices[u++]=0,n.vertices[u++]=1,n.vertices[u++]=-1,n.vertices[u++]=1,n.vertices[u++]=0,n.vertices[u++]=1,n.vertices[u++]=1,n.vertices[u++]=1,n.vertices[u++]=1,n.vertices[u++]=-1,n.vertices[u++]=1,n.vertices[u++]=0,n.vertices[u++]=1,u=0,n.faces[u++]=0,n.faces[u++]=1,n.faces[u++]=2,n.faces[u++]=0,n.faces[u++]=2,n.faces[u++]=3,n.vertexBuffer=e.createBuffer(),n.elementBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,n.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,n.vertices,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.elementBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,n.faces,e.STATIC_DRAW),n.program=(a=v,s=r,o=e.createProgram(),l=e.createShader(e.FRAGMENT_SHADER),c=e.createShader(e.VERTEX_SHADER),h="precision "+s+" float;\n",e.shaderSource(l,h+a.fragmentShader),e.shaderSource(c,h+a.vertexShader),e.compileShader(l),e.compileShader(c),e.attachShader(o,l),e.attachShader(o,c),e.linkProgram(o),e.deleteShader(l),e.deleteShader(c),o),n.attributes={},n.uniforms={},n.attributes.vertex=e.getAttribLocation(n.program,"position"),n.attributes.uv=e.getAttribLocation(n.program,"uv"),n.uniforms.map=e.getUniformLocation(n.program,"map"),n.uniforms.tNormalDepth={location:null,value:null},n.uniforms.tNormalDepth.location=e.getUniformLocation(n.program,"tNormalDepth"),n.uniforms.opacity=e.getUniformLocation(n.program,"opacity"),n.uniforms.color=e.getUniformLocation(n.program,"color"),n.uniforms.scale=e.getUniformLocation(n.program,"scale"),n.uniforms.rotation=e.getUniformLocation(n.program,"rotation"),n.uniforms.screenPosition=e.getUniformLocation(n.program,"screenPosition"),n.uniforms.screenPositionFlare=e.getUniformLocation(n.program,"screenPositionFlare")},this.dispose=function(){e.deleteBuffer(this._lensFlare.vertexBuffer),e.deleteBuffer(this._lensFlare.elementBuffer),e.deleteProgram(this._lensFlare.program)},this.render=function(r,n,a,s){var o=r.__webglFlares,l=o.length;if(l&&t.lensFlareEnabled){var c,h,u,d,p,f=this._lensFlare,m=new i.Vector3,g=s/a,v=.5*a,S=.5*s,_=16/s,y=new i.Vector2(_*g,_),x=new i.Vector3(1,1,0),M=new i.Vector2(1,1),P=f.uniforms,C=f.attributes;for(e.useProgram(f.program),e.enableVertexAttribArray(f.attributes.vertex),e.enableVertexAttribArray(f.attributes.uv),t.setTexture(P.tNormalDepth.value,0),e.uniform1i(P.tNormalDepth.location,0),e.uniform1i(P.map,1),e.bindBuffer(e.ARRAY_BUFFER,f.vertexBuffer),e.vertexAttribPointer(C.vertex,2,e.FLOAT,!1,16,0),e.vertexAttribPointer(C.uv,2,e.FLOAT,!1,16,8),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,f.elementBuffer),e.disable(e.CULL_FACE),e.depthMask(!1),c=0;c<l;c++)if(_=16/s,y.set(_*g,_),d=o[c],m.set(d.matrixWorld.elements[12],d.matrixWorld.elements[13],d.matrixWorld.elements[14]),m.applyMatrix4(n.matrixWorldInverse),!(m.z>0)){m.applyProjection(n.projectionMatrix);var b=.5+.5*m.z;if(x.copy(m),M.x=x.x*v+v,M.y=x.y*S+S,M.x>0&&M.x<a&&M.y>0&&M.y<s)for(e.disable(e.DEPTH_TEST),e.uniform3f(P.screenPositionFlare,.5*(x.x+1),.5*(x.y+1),b),d.positionScreen.copy(x),d.customUpdateCallback?d.customUpdateCallback(d):d.updateLensFlares(),e.uniform1i(P.renderType,2),e.enable(e.BLEND),h=0,u=d.lensFlares.length;h<u;h++)(p=d.lensFlares[h]).opacity>.001&&p.scale>.001&&(x.x=p.x,x.y=p.y,x.z=p.z,_=p.size*p.scale/s,y.x=_*g,y.y=_,e.uniform3f(P.screenPosition,x.x,x.y,x.z),e.uniform2f(P.scale,y.x,y.y),e.uniform1f(P.rotation,p.rotation),e.uniform1f(P.opacity,p.opacity),e.uniform3f(P.color,p.color.r,p.color.g,p.color.b),t.setBlending(p.blending,p.blendEquation,p.blendSrc,p.blendDst),t.setTexture(p.texture,1),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0))}e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.depthMask(!0)}}},i.WebGLRenderer_backup=i.WebGLRenderer,i.WebGLRenderer=function(e){this.renderPointMode=0,this.renderLineMode=i.ShowAllRenderLineMode,this.renderFaceMode=i.ShowAllFaces,this.renderHiddenEdges=!1,this.halfVisibleSmoothEdges=!1,this.outlineWidth=1,this.ratioSSB=100,this.colorizeSSB=!1;var t=new i.PickingMode;this.pickingModeMSB=t.pickingModeMSB,this.pickingModeLSB=t.pickingModeLSB,i.WebGLRenderer_backup.call(this,e);this.getContext()},i.WebGLRenderer.prototype.computeRenderPriorityOpacity=function(e,t){var i=t?t.getRenderPriorityOpacity():null;return(null===i||i<0)&&(i=this.renderPriorityDefaultOpacity),i*e},i.WebGLRenderer.prototype.refreshUniformsPhysicalDSRoughnessMaps=function(e,t,r){var n=this.precomputedTexture;if(e.precomputedTexture&&n&&(e.precomputedTexture.value=n),t.envMipMap&&t.envMipMap[0]){e.envMap.value=t.envMipMap[0],e.envMap2.value=t.envMipMap[1];var a=1,s=1;if(e.envMap.value&&e.envMap.value.hdr&&(e.envMap.value.image?(a=parseInt(e.envMap.value.image.width),s=parseInt(e.envMap.value.image.height)):(a=parseInt(e.envMap.value.width),s=parseInt(e.envMap.value.height)),e.envMapHDRSize.value.x=a,e.envMapHDRSize.value.y=s),e.envMap2&&e.envMapHDRToMipsRatio){var o=1;o=e.envMap2.image?parseInt(e.envMap2.image.width)/a:parseInt(e.envMap2.width)/a,e.envMapHDRToMipsRatio.value=o}var l=t.envMipMap[0].envMapExposureSpecular,c=t.envMipMap[0].envMapExposureDiffuse;e.envMapExposureSpecular.value=l||0===l?l:1,e.envMapExposureDiffuse.value=c||0===c?c:1,e.ambienceMatrix.value=t.ambienceMatrix?t.ambienceMatrix:new i.Matrix4,t.useFiniteEnvMap&&(e.sphereCenter.value=t.parallaxCorrectionParameters.sphereCenter,e.sphereRadius.value=t.parallaxCorrectionParameters.sphereRadius,e.projectionCenter.value=t.parallaxCorrectionParameters.projectionCenter)}t.reflectionProbes&&t.reflectionProbes.length&&(e.reflectionProbe.value=t.reflectionProbes[0].map0,e.reflectionProbeMips.value=t.reflectionProbes[0].map1,e.reflectionProbePos.value=t.reflectionProbes[0].position,e.reflectionProbeProxyMin.value=t.reflectionProbes[0].geomProxy.min,e.reflectionProbeProxyMax.value=t.reflectionProbes[0].geomProxy.max,e.envMapHDRToMipsRatio&&(e.envMapHDRToMipsRatio.value=1))},i.createPlaneGeometryDS=function(e,t){var n=new i.BufferGeometryDS;n.vertexIndexArray=new Uint16Array(6),n.vertexPositionArray=new Float32Array(12),n.vertexNormalArray=new Float32Array(12),n.vertexUvArray=new Float32Array(12);var a=new r.SGRep({solid:!1}),s=[],o=new r.DrawingGroup(i.MaterialUtils.createShinyFaceMaterial({side:i.DoubleSide,color:new i.Color(16777215)}),null,4,0,6,s,void 0,i.GeomTypeEnum.UNKNOWN,0);o.geometry=n,n.drawingGroups.push(o);var l=new r.SGPrimitive({start:0,count:6,cgmId:0,rep:a,group:o});s.push(l),a._primitives.push(l);var c=n.vertexIndexArray;c[0]=0,c[1]=1,c[2]=3,c[3]=1,c[4]=2,c[5]=3;var h=n.vertexPositionArray;h[0]=-.5*e,h[1]=.5*t,h[2]=0,h[3]=-.5*e,h[4]=-.5*t,h[5]=0,h[6]=.5*e,h[7]=-.5*t,h[8]=0,h[9]=.5*e,h[10]=.5*t,h[11]=0;for(var u=n.vertexNormalArray,d=0;d<4;d++)u[3*d]=0,u[3*d+1]=0,u[3*d+2]=1;var p=n.vertexUvArray;return p[0]=0,p[1]=1,p[2]=0,p[3]=0,p[4]=0,p[5]=0,p[6]=1,p[7]=0,p[8]=0,p[9]=1,p[10]=1,p[11]=0,n.computeBoundingBox(),n.computeBoundingSphere(),n},i.convertParticleSystemToBufferGeometryDS=function(e){if(e&&0===e._type&&e.vertices){var t=e.vertices.length,n=new i.BufferGeometryDS;n.vertexPositionArray=new Float32Array(3*t),n.vertexPositionArray.nonindexedPoints=!0,n.vertexIndexArray=new Uint16Array(1),n.vertexIndexArray[0]=0;var a=new r.SGRep({solid:!1}),s=[],o=new r.DrawingGroup(i.MaterialUtils.createShinyFaceMaterial({side:i.DoubleSide,color:new i.Color(16777215)}),null,0,0,t,s,void 0,i.GeomTypeEnum.UNKNOWN,0);o.geometry=n,n.drawingGroups.push(o);var l=new r.SGPrimitive({start:0,count:t,cgmId:0,rep:a,group:o});s.push(l),a._primitives.push(l);for(var c=n.vertexPositionArray,h=0;h<t;h++)c[3*h]=e.vertices[h].x,c[3*h+1]=e.vertices[h].y,c[3*h+2]=e.vertices[h].z;return n.computeBoundingBox(),n.computeBoundingSphere(),n}},i.DrawableInterval=function(e,t,i,r,n,a,s){this.layerNum=e||0,this.material=r||null,this.gas=null,n&&(this.gas=n.__getGAS(this.gas)),this.start=t||0,this.count=i||0,this.primitiveStart=0,this.primitiveCount=0,this.primitiveOverrideMaterial=a||null,this.noZ=void 0!==s?s:-1},i.DrawableInterval.prototype={constructor:i.DrawableInterval,clone:function(){var e=new i.DrawableInterval(this.layerNum,this.start,this.count,this.material,this.gas,void 0,this.noZ);return e.primitiveStart=this.primitiveStart,e.primitiveCount=this.primitiveCount,e},skip:function(e,t){return this.layerNum<=0||!!(e&&this.gas&&this.gas.isGAS)&&!this.gas.visibleInCurrentSpace(e,t)},getMaterial:function(){return this.primitiveOverrideMaterial?this.primitiveOverrideMaterial:this.material}},i.LayerInterval=function(e,t,i){this.geometry=void 0!==e?e:null,this.drawableGroup=void 0!==t?t:null,this.drawableInterval=void 0!==i?i:null},i.LayerInterval.prototype={constructor:i.LayerInterval,clone:function(){var e=new i.LayerInterval;return e.geometry=this.geometry,e.drawableGroup=this.drawableGroup,e.drawableInterval=this.drawableInterval.clone(),e},_computeOrientedBoundingBox:function(e){var t=!0,r=this.drawableInterval,n=this.geometry,a=n.vertexIndexArray,s=new i.Vector3,o=new i.Vector3,l=new i.Vector3;if(r.layerNum&&r.count){var c=r.start,h=r.start+r.count;if(t){t=!1;var u=a[c];n.getVertexPosition(u,l),s.set(l.x,l.y,l.z).applyMatrix4(e),o.set(l.x,l.y,l.z).applyMatrix4(e)}for(var d=c;d<h;d++){u=a[d];n.getVertexPosition(u,l),l.applyMatrix4(e),l.x<s.x&&(s.x=l.x),l.y<s.y&&(s.y=l.y),l.z<s.z&&(s.z=l.z),l.x>o.x&&(o.x=l.x),l.y>o.y&&(o.y=l.y),l.z>o.z&&(o.z=l.z)}}return new i.Box3(s,o)}},i.BufferLayer=function(e){this.layers=[],this.upToDate=!1,this.mesh=e},i.BufferLayer.prototype={constructor:i.BufferLayer,clone:function(e){for(var t=new i.BufferLayer(this.mesh),r=0;r<this.layers.length;r++){var n=this.layers[r].clone();e&&(n.drawableInterval.layerNum=0),t.addLayerInterval(n)}return t},getIntervals:function(e,t,i){for(var r=[],n=0;n<this.layers.length;n++){var a=this.layers[n];a.geometry!==e||t&&a.drawableGroup!==t||r.push(i?a:a.drawableInterval)}return r},getInterval:function(e){for(var t=e.group,i=t.geometry,r=this.getIntervals(i,t),n=0;n<r.length;n++){var a=r[n];if(e.start>=a.start&&e.start+e.count<=a.start+a.count)return a}return null},addLayerInterval:function(e){this.layers.push(e),this.upToDate=!1},removeIntervals:function(e,t){for(var i=void 0!==t,r=0;r<this.layers.length;r++){var n=this.layers[r];n.geometry==e&&(!i||i&&n.drawableGroup==t)&&(this.layers.splice(r,1),r--)}this.upToDate=!1},addPrimitivesToLayersOpacity:function(e,t,i){var r=[];this.addPrimitivesToLayers_internal(e,t,function(e){var t=r[e.id];return t||((t=e.clone()).opacity=i,t.transparent=!0,r[e.id]=t),t}),this.upToDate=!1},addPrimitivesToLayers:function(e,t,i,r,n,a){this.addPrimitivesToLayers_internal(e,t,function(){return i},r,n,a),this.upToDate=!1},addPrimitivesToLayers_internal:function(e,t,i,r,n,a){var s;this.mesh._flagAsGSSOInvalidated();var o=new Map;for(s=0;s<e.length;s++){var l=e[s],c=l.getGroup(),h=o.get(c);h||(h=[],o.set(c,h)),h.push(l)}var u=[];for(o.forEach((e,t)=>{u.push(e)}),s=0;s<u.length;s++)u[s].sort(function(e,t){return e.getStart()<t.getStart()?-1:e.getStart()>t.getStart()?1:0});for(s=0;s<u.length;s++){var d=u[s][0].getGroup(),p=d.geometry,f=i(d.gas);this.addPrimitivesToLayer(p,d,u[s],t,f,r,n,a)}},addPrimitivesToLayer:function(e,t,r,n,a,s,o,l){var c,h,u=this.getIntervals(e,t,!0),d=[],p=function(e){return s?s.__getGAS(e):e};if(u.length){var f=0,m=u[f].drawableInterval,g=p(m.gas),v=void 0===a?m.material:a,_=void 0===o?m.primitiveOverrideMaterial:o,y=void 0===l?m.noZ:l;c=m.start,h=m.count;var x=0,M=!0;for(D=0;D<r.length;D++){var P=(w=r[D]).getStart(),C=w.getCount();if(C&&(M||x!==P)){for(M=!1,x=P;P+C>c+h;)h&&d.push(new i.DrawableInterval(m.layerNum,c,h,m.material,m.gas,m.primitiveOverrideMaterial,m.noZ)),g=p((m=u[++f].drawableInterval).gas),v=void 0===a?m.material:a,_=void 0===o?m.primitiveOverrideMaterial:o,y=void 0===l?m.noZ:l,c=m.start,h=m.count;if(n!==m.layerNum||v!==m.material||g!==m.gas||_!==m.primitiveOverrideMaterial||y!==m.noZ){P>c&&d.push(new i.DrawableInterval(m.layerNum,c,P-c,m.material,m.gas,m.primitiveOverrideMaterial,m.noZ)),d.push(new i.DrawableInterval(n,P,C,v,g,_,y));var b=P+C;h=m.count-b+m.start,c=b}}}h>0&&d.push(new i.DrawableInterval(m.layerNum,c,h,m.material,m.gas,m.primitiveOverrideMaterial,m.noZ));for(var D=f+1;D<u.length;D++)d.push(u[D].drawableInterval);this.removeIntervals(e,t)}else for(D=0;D<r.length;D++){var w=r[D];d.push(new i.DrawableInterval(n,w.start,w.count,a||null,s||null,o||null,l))}var E=d[0].layerNum,T=d[0].material,A=d[0].gas,I=d[0].primitiveOverrideMaterial,R=d[0].noZ;for(c=d[0].start,h=0,D=0;D<d.length;D++){var L=d[D];if(L.layerNum===E&&L.material===T&&L.gas===A&&L.primitiveOverrideMaterial===I&&L.noZ===R)h+=L.count;else{var O=new i.DrawableInterval(E,c,h,T,A,I,R);this.addLayerInterval(new i.LayerInterval(e,t,O)),E=L.layerNum,T=L.material,I=L.primitiveOverrideMaterial,A=L.gas,R=L.noZ,c=L.start,h=L.count}if(D==d.length-1){O=new i.DrawableInterval(E,c,h,T,A,I,R);this.addLayerInterval(new i.LayerInterval(e,t,O))}}for(D=0;D<this.layers.length;D++){var N=this.layers[D],F=N.drawableGroup;if(F===t&&N.geometry===e){var V=N.drawableInterval,U=0,B=F.getPrimitivesCount();if(B){if(B<20)for(;V.start>F.getPrimitiveStart(U);)U++;else U=S(F,V.start);for(V.primitiveStart=U;V.start+V.count>F.getPrimitiveStart(U)+F.getPrimitiveCount(U);)U++;V.primitiveCount=U-V.primitiveStart+1}else V.primitiveStart=0,V.primitiveCount=0}}},setDGToLayer:function(e,t,i,r,n,a,s){for(var o=this.getIntervals(e,t),l=0;l<o.length;l++){var c=o[l];void 0!==i&&(c.layerNum=i),void 0!==r&&(c.material=r),void 0!==n&&(c.gas=n.__getGAS(c.gas)),void 0!==s&&(c.noZ=s),void 0!==a&&(c.primitiveOverrideMaterial=a)}}},i.EventTarget=function(){var e={};this.addEventListener=function(t,i){null==e[t]&&(e[t]=[]),-1===e[t].indexOf(i)&&e[t].push(i)},this.dispatchEvent=function(t){for(var i in e[t.type])e[t.type].hasOwnProperty(i)&&e[t.type][i](t)},this.removeEventListener=function(t,i){var r=e[t].indexOf(i);-1!==r&&e[t].splice(r,1)}};var _={uniforms:i.UniformsUtils.merge([i.UniformsLib.common,i.UniformsLib.lights,i.UniformsLib.shadowmap,i.UniformsLib.postprocess,{ambient:{type:"c",value:new i.Color(328965)},emissive:{type:"c",value:new i.Color(0)},specular:{type:"c",value:new i.Color(1118481)},border:{type:"c",value:new i.Color(516)},borderAlpha:{type:"f",value:1},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new i.Vector3(1,1,1)},attenuation:{type:"i",value:0},displayGrid:{type:"f",value:1},displayPlane:{type:"f",value:1},gridFromBelow:{type:"f",value:1},gridTexture:{type:"t",value:null},gridTexture2:{type:"t",value:null},gridTexture3:{type:"t",value:null},gridTexture4:{type:"t",value:null},nbSteps:{type:"f",value:5},gridUnit:{type:"f",value:1},gridOffset:{type:"v2",value:new i.Vector2},gridCoeff:{type:"f",value:0},gridColor:{type:"c",value:new i.Color(16777215)},planeSize:{type:"f",value:100},planeBorder:{type:"f",value:1},planeFalloff:{type:"f",value:0},onlyDiffuse:{type:"f",value:0},gridFalloff:{type:"f",value:0},uvScale:{type:"f",value:1},planeOpacity:{type:"f",value:1}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;","#ifndef USE_MAP","varying vec2 vUv;","#endif",i.ShaderChunk.map_pars_vertex,i.ShaderChunk.clip_pars_vertex,i.ShaderChunk.lights_phong_pars_vertex,i.ShaderChunk.color_pars_vertex,i.ShaderChunk.shadowmap_pars_vertex,"void main() {","vUv = uv;",i.ShaderChunk.color_vertex,i.ShaderChunk.default_vertex_with_normal,i.ShaderChunk.defaultnormal_vertex,i.ShaderChunk.clip_vertex,"vViewPosition = -mvPosition.xyz;","vNormal = normalize( transformedNormal );",i.ShaderChunk.worldpos_vertex,i.ShaderChunk.lights_phong_vertex,i.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["const vec3 vOrthoDir = vec3(0.0, 0.0, 1.0);","uniform vec3 diffuse;","uniform float planeOpacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform vec3 border;","uniform float borderAlpha;","uniform int attenuation;","#ifdef PLANE_V2","const float alphaSlope = 0.66666666667;","const float alphaSlope2 = 0.44444444444;","const float edgeSize = 0.01;","const float stepSize = 0.001;","const float small2GridWidth = 0.0005;","const float smallGridWidth = 0.0005;","const float bigGridWidth = 0.0005;","uniform float displayGrid;","uniform float displayPlane;","uniform float onlyDiffuse;","uniform float gridFromBelow;","uniform float planeFalloff;","uniform float gridFalloff;","uniform float planeSize;","uniform float planeBorder;","uniform sampler2D gridTexture;","uniform sampler2D gridTexture2;","uniform sampler2D gridTexture3;","uniform sampler2D gridTexture4;","uniform float nbSteps;","uniform float gridUnit;","uniform vec2 gridOffset;","uniform float gridCoeff;","uniform vec3 gridColor;","#ifdef USE_MAP","uniform sampler2D map;","#endif","#endif","uniform float uvScale;","varying vec2 vUv;","vec2 uvToUse;",i.ShaderChunk.color_pars_fragment,i.ShaderChunk.lights_phong_pars_fragment,i.ShaderChunk.shadowmap_pars_fragment,i.ShaderChunk.postprocess_pars_fragment,"void main() {","uvToUse = vUv * uvScale;","vec3 I = vOrthoDir;","gl_FragColor = vec4(1.0);","if (!(projectionMatrix[3][3] > 0.0)) {","  I = normalize(vViewPosition);","}","float fresnelFactor = dot(I, vNormal);","#ifndef PLANE_V2","if (fresnelFactor < 0.0) {","  discard;","}","if (attenuation == 0) {","  fresnelFactor = 1.0;","}","#endif",i.ShaderChunk.alphatest_fragment,"float shininessValue = shininess;",i.ShaderChunk.specularmap_fragment,i.ShaderChunk.lights_phong_fragment,i.ShaderChunk.color_fragment,"vec3 cCenter = gl_FragColor.xyz;","vec3 cBorder = border;","#ifdef PLANE_V2","cCenter = (cCenter.xyz * (1.0 - onlyDiffuse)) + (onlyDiffuse * diffuse);","float dUV = length(2.0 * vUv - 1.0);","float borderMask = planeBorder * smoothstep(1.0 - 2.0 * edgeSize, 1.0 - 2.0 * edgeSize + stepSize, dUV) * smoothstep(1.0 - edgeSize + stepSize, 1.0 - edgeSize, dUV);","float a2 = max(1.0 - alphaSlope2 * (1.0 + gridCoeff) * (1.0 + gridCoeff), 0.0);","float a1 = 1.0 - alphaSlope2 * gridCoeff * gridCoeff;","float a0 = 1.0 - alphaSlope2 * (1.0 - gridCoeff) * (1.0 - gridCoeff);","float a00 = max(1.0 - alphaSlope2 * (2.0 - gridCoeff) * (2.0 - gridCoeff), 0.0);","vec2 div = 0.5 * planeSize * (2.0 * vUv - 1.0) + gridOffset;","vec2 big2Div = (1.0 / (nbSteps * nbSteps)) * div / gridUnit;","vec2 bigDiv = (1.0 / nbSteps) * div / gridUnit;","vec2 smallDiv = div / gridUnit;","vec2 small2Div = nbSteps * div / gridUnit;","float gridAlpha = texture2D(gridTexture, small2Div).a;","gridAlpha *= a2;","gridAlpha += a1 * texture2D(gridTexture2, smallDiv).a;","gridAlpha += a0 * texture2D(gridTexture3, bigDiv).a;","gridAlpha += a00 * texture2D(gridTexture4, big2Div).a;","gridAlpha = min(1.0, gridAlpha);","#ifdef USE_MAP","vec4 texelColor = texture2D( map, uvToUse );","#ifdef GAMMA_INPUT","texelColor.xyz = convertToLinear(texelColor.xyz);","#endif","cCenter = mix(cCenter, texelColor.xyz, texelColor.a);","#endif","float planeAlpha = 1.0001 - smoothstep(planeFalloff, 1.0, dUV);","gridAlpha *= 1.0001 - smoothstep(gridFalloff, 1.0, dUV);","planeAlpha *= planeOpacity * step(0.0, fresnelFactor) * displayPlane;","gridAlpha *= step(-gridFromBelow, fresnelFactor) * displayGrid;","vec4 planeCol = vec4(mix(mix(cCenter, cBorder, planeBorder), cCenter, planeAlpha), mix(planeAlpha, 1.0, planeBorder));","vec4 gridCol = vec4(gridColor * gridColor, gridAlpha);","vec4 gridOverPlaneColor = vec4((gridCol.xyz * gridCol.a + planeCol.xyz * planeCol.a * (1.0 - gridCol.a)) / (0.0001 + gridCol.a + planeCol.a * (1.0 - gridCol.a)), gridCol.a + planeCol.a * (1.0 - gridCol.a));","gl_FragColor = mix(gridOverPlaneColor, vec4(cBorder, borderMask), step(1.0 - 2.0 * edgeSize, dUV));","#else","vec2 dUV = 2.0 * (vUv * 2.0 - 1.0);","float dist = dot(dUV, dUV);","float dist2 = clamp(dist * dist, 0.0, 1.0);","dist = clamp(dist, 0.0, 1.0);","gl_FragColor = vec4(mix(cCenter, mix(cCenter, cBorder, borderAlpha), dist), fresnelFactor*(1.0 - dist2));","#endif",i.ShaderChunk.postprocess_fragment,i.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};return Object.defineProperty(i,"InfinitePlaneShader",{get:function(){return console.error("Using internal shader, use THREE.PlaneMaterial instead"),_},set:function(){throw"NO"}}),(m&&!EXPERIENCE_PLAYER||!m&&!g)&&(i.HatchingMeshMaterial=function(e){var t={side:i.FrontSide,vertexColors:i.VertexColorType.RGBA,force:!0};i.MeshBasicMaterial.call(this,t),this.activatePDSFX();var r={planeU:{type:"v3",value:new i.Vector3(1,0,0)},planeV:{type:"v3",value:new i.Vector3(0,1,0)},hatchingDirection:{type:"v2",value:new i.Vector2(1,-1)},hatchingNormal:{type:"v2",value:new i.Vector2(-1,-1)},hatchingSpaceWidth:{type:"f",value:10},hatchingSpaceColor:{type:"v4",value:new i.Vector4(10,10,10,1)},hatchingLineWidth:{type:"f",value:1},hatchingLineColor:{type:"v4",value:new i.Vector4(0,0,0,1)}};this.setPDSFXUniforms(r);this.setPDSFXVaryings({_uv:{type:"v2"},myPosition:{type:"v4"}});this.setPDSFXGlobalShaderCode("vec4 _mvPosition;","");var n={ProcessViewTangentSpace:"void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) { _mvPosition = vec4(ioWorldViewTS.Position, 0.0); }",ComputeVaryingValues:["void ComputeVaryingValues() {","mat4 VM = vGetViewMatrix();","vec3 mvPlaneU = (VM * vec4(planeU, 0.0)).xyz;","vec3 mvPlaneV = (VM * vec4(planeV, 0.0)).xyz;","_uv = vec2(dot(_mvPosition.xyz, mvPlaneU), dot(_mvPosition.xyz, mvPlaneV))-vec2(dot(VM[3].xyz, mvPlaneU), dot(VM[3].xyz, mvPlaneV));","}"].join("\n")},a={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","float eval = hatchingNormal.x*_uv.x + hatchingNormal.y*_uv.y;","float k = mod(eval, hatchingSpaceWidth);","vec2 fwx = dot(hatchingNormal, dFdx(_uv))*hatchingNormal;","vec2 fwy = dot(hatchingNormal, dFdy(_uv))*hatchingNormal;","vec2 fw = abs(fwx) + abs(fwy);","float fwlen = length(fw);","float tol = min(hatchingLineWidth*fwlen, hatchingSpaceWidth - fwlen);","if (k < tol/2.0 || k > hatchingSpaceWidth - tol/2.0) {","  ioFinalColor = hatchingLineColor;","} else {","  ioFinalColor = hatchingSpaceColor;","}","}"].join("\n")};this.setPDSFXOverridableFunctions(n,a),this.stripesDirection=new i.Vector2(1,1),this.spaceWidth=1,this.spaceColor=new i.Color(16777215),this.spaceOpacity=1,this.stripesWidth=1,this.stripesColor=new i.Color(0),this.stripesOpacity=1,this.autoSpaceColor=!1,this.autoStripesColor=!1,this.enableClipPlanes=!0,this._refreshPDSFXUniforms_private=function(e,t,r){var n=this._renderedClipPlane;if(n){var a=new i.Vector3;a.crossVectors(n.normal,n.upVector),a.normalize();var s=new i.Vector3;s.crossVectors(a,n.normal),this.updatePDSFXUniform("planeU",a),this.updatePDSFXUniform("planeV",s)}this.updatePDSFXUniform("hatchingDirection",this.stripesDirection.clone().normalize()),this.updatePDSFXUniform("hatchingNormal",new i.Vector2(this.stripesDirection.y,-this.stripesDirection.x).normalize()),this.updatePDSFXUniform("hatchingSpaceWidth",this.spaceWidth),this.updatePDSFXUniform("hatchingLineWidth",this.stripesWidth),e.gammaInput?(this.updatePDSFXUniform("hatchingSpaceColor",new i.Vector4(this.spaceColor.r*this.spaceColor.r,this.spaceColor.g*this.spaceColor.g,this.spaceColor.b*this.spaceColor.b,this.stripesOpacity)),this.updatePDSFXUniform("hatchingLineColor",new i.Vector4(this.stripesColor.r*this.stripesColor.r,this.stripesColor.g*this.stripesColor.g,this.stripesColor.b*this.stripesColor.b,this.stripesOpacity))):(this.updatePDSFXUniform("hatchingSpaceColor",new i.Vector4(this.spaceColor.r,this.spaceColor.g,this.spaceColor.b,this.stripesOpacity)),this.updatePDSFXUniform("hatchingLineColor",new i.Vector4(this.stripesColor.r,this.stripesColor.g,this.stripesColor.b,this.stripesOpacity)))},this.setValues(e)},i.HatchingMeshMaterial.prototype=Object.create(i.MeshBasicMaterial.prototype),i.HatchingMeshMaterial.prototype.clone=function(){var e=new i.HatchingMeshMaterial;return i.MeshBasicMaterial.prototype.clone.call(this,e),e.stripesDirection=this.stripesDirection.clone(),e.spaceWidth=this.spaceWidth,e.spaceColor=this.spaceColor.clone(),e.spaceOpacity=this.spaceOpacity,e.stripesWidth=this.stripesWidth,e.stripesColor=this.stripesColor.clone(),e.stripesOpacity=this.stripesOpacity,e.autoStripesColor=this.autoStripesColor,e.autoSpaceColor=this.autoSpaceColor,e.updatePDSFXUniform("planeU",this.getPDSFXUniform("planeU").value.clone()),e.updatePDSFXUniform("planeV",this.getPDSFXUniform("planeV").value.clone()),e},i.HatchingMeshMaterial.prototype.getType=function(){return"Hatching"}),i.CSSSVGNode=function(e){i.Object3D.call(this),this.element=e,this.element.renderable=this,this.geometry=new i.Geometry,this.geometry.boundingSphere=new i.Sphere},i.CSSSVGNode.prototype=Object.create(i.Object3D.prototype),UWA.namespace("THREEDS/Core",i)}),define("Visualization/ThreeJS_DS",["DS/Visualization/ThreeJS_DS","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/ThreeJS_DS"),e}),define("DS/Shaders/CATCrDImageTextureShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return function(t,i){t.force=!0,t.useLighting=!1,t.activatePDSFX(),t.transparent=!0,t.side=e.DoubleSide;var r=["vec4 commonFinalColor;"].join("\n");t.setPDSFXGlobalShaderCode("",r);var n={CrD_Image_UniformColor:{type:"v4",value:i.Color},CrD_Image_UniformOpacity:{type:"f",value:i.Opacity},RefImage2DMap:{type:"t2",value:i.RefImage2DMap.map}};t.setPDSFXUniforms(n);t.setPDSFXVaryings({vTexCoord:{type:"v3"}});var a={ComputeObjectPosition:["vec3 ComputeObjectPosition() {","return vGetAttribPosition();","}"].join("\n"),ComputeVaryingValues:["void ComputeVaryingValues() {","vTexCoord = vGetAttribTexCoord0().xyz;","}"].join("\n")},s={ComputeCommonValues:["void ComputeCommonValues() {","commonFinalColor = texture2D(RefImage2DMap, vTexCoord.xy);","commonFinalColor.a = commonFinalColor.a * CrD_Image_UniformOpacity;","commonFinalColor.a = clamp(commonFinalColor.a, 0.0, 1.0);","float rangeMin = 0.03;","float rangeMax = 0.97;","float factor = 0.0;","if(CrD_Image_UniformColor.a > 0.0)","{","if (vTexCoord.x < rangeMin) {","if (vTexCoord.y < rangeMin && vTexCoord.x > vTexCoord.y) {","factor = 1.0 - (vTexCoord.y / rangeMin);","}","else if (vTexCoord.y > rangeMax && vTexCoord.y > vTexCoord.x * ((rangeMax - 1.0) / rangeMin) + 1.0) {","factor = (vTexCoord.y - rangeMax) / (1.0 - rangeMax);","}","else {","factor = 1.0 - (vTexCoord.x / rangeMin);","}","}","else if (vTexCoord.x > rangeMax) {","if (vTexCoord.y < rangeMin && vTexCoord.y < (rangeMin / (1.0 - rangeMax)) * (1.0 - vTexCoord.x)) {","factor = 1.0 - (vTexCoord.y / rangeMin);","}","else if (vTexCoord.y > rangeMax && vTexCoord.x < vTexCoord.y) {","factor = (vTexCoord.y - rangeMax) / (1.0 - rangeMax);","}","else {","factor = (vTexCoord.x - rangeMax) / (1.0 - rangeMax);","}","}","else if (vTexCoord.y < rangeMin) {","factor = 1.0 - (vTexCoord.y / rangeMin);","}","else if (vTexCoord.y > rangeMax) {","factor = (vTexCoord.y - rangeMax) / (1.0 - rangeMax);","}","if ((commonFinalColor.a < 10e-3) && factor > 0.0) {","commonFinalColor = vec4(1.0, 1.0, 1.0, 1.0);","factor = (factor * 0.6) + 0.4;","}","commonFinalColor = mix(commonFinalColor, CrD_Image_UniformColor, factor);","}","if (commonFinalColor.a < 10e-3) {","discard;","}","}"].join("\n"),ComputeAlbedo:["vec3 ComputeAlbedo() {","return commonFinalColor.xyz;","}"].join("\n"),ComputeOpacity:["float ComputeOpacity() {","return commonFinalColor.a;","}"].join("\n")};return t.setPDSFXOverridableFunctions(a,s),t.needsUpdate=!0,t}}),define("DS/Visualization/IESUtils",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t={nbTexturesBeingLoaded:0,crossOrigin:"anonymous",loadIESTexture:function(i,r,n,a,s,o){var l=new e.DataTexture(null,128,128,e.LuminanceFormat,e.FloatType);l.mapping=r,l.generateMipmaps=!1,l.loadEndStatus=e.AssetLoadingStatus.LOADING;var c=new XMLHttpRequest;return c.onload=function(){t.nbTexturesBeingLoaded--;var i,r=t.parserIES(c.response);for(l.image.data=r,l.loadEndStatus=e.AssetLoadingStatus.READY,l.generateMipmaps=!1,l.minFilter=e.LinearFilter,l.magFilter=e.LinearFilter,l.needsUpdate=!0,n&&n(l),i=0;i<l.onLoadCallbacks.length;i++)l.onLoadCallbacks[i](l)},c.onerror=function(){a(),t.nbTexturesBeingLoaded--,l.loadEndStatus=e.AssetLoadingStatus.ERROR},o?(l.loadEndStatus=e.AssetLoadingStatus.PAUSED,l.onRequest=function(){l.loadEndStatus=e.AssetLoadingStatus.LOADING,t.nbTexturesBeingLoaded++,c.open("GET",i,!0),c.responseType="text",c.withCredentials=!!s,c.send(null),l.onRequest=null}):(l.loadEndStatus=e.AssetLoadingStatus.LOADING,t.nbTexturesBeingLoaded++,c.open("GET",i,!0),c.responseType="text",c.withCredentials=!!s,c.send(null)),l},parserIES:function(e){var t=e.lastIndexOf("TILT="),i=e.slice(t);t=i.indexOf("\n"),i=(i=(i=(i=i.slice(t+1)).replace(/\n|\s|\r/g,"_")).replace("__","_")).split("_");for(var r=[],n=0;n<i.length;n++)""!=i[n]&&(r[r.length]=parseFloat(i[n]));i=null;var a,s,o,l,c,h,u=-1,d=-1,p=-1;r[0],r[1],r[2],a=r[3],s=r[4],o=r[5],r[6],r[7],r[8],r[9],r[10],r[11],r[12],h=13,l=[a],c=[s];for(var f=[],m=new Float32Array(16384),g=0;g<128;g++)for(var v=0;v<128;v++)m[128*g+v]=0;for(var S=0;S<a;S++)l[S]=r[S+h];h+=parseInt(a);for(var _=0;_<s;_++)c[_]=r[_+h];if(h+=parseInt(s),1==o){90==l[a-1]?d=1:180==l[a-1]&&(d=2),1==s&&0==c[0]?u=0:90==c[s-1]?u=1:180==c[s-1]&&(u=2);for(_=0;_<s;_++)for(S=0;S<a;S++){var y=r[S+_*a+h];p=p<y?y:p}if(0==u){s=2,c[1]=180;for(S=0;S<a;S++)r[S+a+h]=r[S+h]}if(1==u){if(1==d){for(_=0;_<s;_++){var x=90-(c[_]-90);f[c[_]]=[2*a],f[x]=[2*a];for(S=0;S<a;S++){var M=90-(l[S]-90);f[c[_]][l[S]]=f[x][l[S]]=f[c[_]][M]=f[x][M]=r[S+_*a+h]/p}}for(S=0;S<a-1;S++)l.push(90-(l[S]-90))}else if(2==d)for(_=0;_<s;_++){x=90-(c[_]-90);f[c[_]]=[2*a],f[x]=[2*a];for(S=0;S<a;S++)f[c[_]][l[S]]=f[x][l[S]]=r[S+_*a+h]/p}for(_=0;_<s-1;_++)c.push(90-(c[_]-90))}else if(0==u||2==u){if(1==d){for(_=0;_<s;_++){f[c[_]]=[2*a];for(S=0;S<a;S++){M=90-(l[S]-90);f[c[_]][l[S]]=f[c[_]][M]=r[S+_*a+h]/p}}for(S=0;S<a-1;S++)l.push(90-(l[S]-90))}else if(2==d)for(_=0;_<s;_++){f[c[_]]=[a];for(S=0;S<a;S++)f[c[_]][l[S]]=r[S+_*a+h]/p}}else console.log("Erreur symetricHType "+u);c=c.sort(function(e,t){return e-t}),l=l.sort(function(e,t){return e-t});var P=c[0],C=c[1],b=1;for(_=0;_<180;_+=1.40625){for(;_>C;)P=C,C=c[b+1],b++;var D=l[0],w=l[1],E=1,T=(_-P)/(C-P);for(S=0;S<180;S+=1.40625){for(;S>w;)D=w,w=l[E+1],E++;var A=(S-D)/(w-D),I=(1-A)*f[P][D]+A*f[P][w],R=(1-A)*f[C][D]+A*f[C][w];m[_/1.40625*128+S/1.40625]=(1-T)*I+T*R}}}else console.log("Mauvais Gonio Type");return m}};return t}),define("DS/Shaders/CATCrDFeltPenShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return function(t,i){t.force=!0,t.useLighting=!1,t.activatePDSFX(),t.transparent=!0,t.side=e.DoubleSide,t.setPDSFXPolygonOffset("Frontward1");var r=["vec4 commonFinalColor;"].join("\n");t.setPDSFXGlobalShaderCode("",r);var n={CrD_Base_UniformColor:{type:"v4",value:new e.Vector4(i.Color[0],i.Color[1],i.Color[2],i.Color[3])},CrD_Base_UniformCutByPlane:{type:"f",value:i.CutByPlane},CrD_Base_UniformScreenPlane:{type:"f",value:i.ScreenPlane},CrD_Base_UniformPlanePosition:{type:"v3",value:new e.Vector3(i.PlanePosition[0],i.PlanePosition[1],i.PlanePosition[2])},CrD_Base_UniformPlaneNormal:{type:"v3",value:new e.Vector3(i.PlaneNormal[0],i.PlaneNormal[1],i.PlaneNormal[2])},CrD_FeltPen_UniformThickness:{type:"f",value:i.Thickness},CrD_FeltPen_UniformLength:{type:"f",value:i.Length},CrD_FeltPen_UniformResizeUMode:{type:"f",value:i.ResizeUMode},CrD_FeltPen_UniformUMin:{type:"f",value:i.UMin},CrD_FeltPen_UniformUMax:{type:"f",value:i.UMax},CrD_FeltPen_UniformClosedWire:{type:"f",value:i.ClosedWire}};t.setPDSFXUniforms(n);t.setPDSFXVaryings({vTexCoord:{type:"v3"}});var a={ComputeObjectPosition:["vec3 ComputeObjectPosition() {","return vGetAttribPosition();","}"].join("\n"),ComputeVaryingValues:["void ComputeVaryingValues() {","vTexCoord = vGetAttribTexCoord0().xyz;","}"].join("\n")},s={ComputeCommonValues:["void ComputeCommonValues() {","float isOpenedWire = 1.0 - clamp(sign(CrD_FeltPen_UniformClosedWire), 0.0, 1.0);","// Pen handles pressure, we must take it into account when computing pen thickness","float pressure = clamp(1.02 * 1.0, 0.0, 1.0); // if pressure > 0.98 => pressure = 1.0","float thickness = CrD_FeltPen_UniformThickness * pressure;","float adjustedLength = max(thickness, CrD_FeltPen_UniformLength);","float thicknessUV = 0.5 * thickness / adjustedLength;","vec2 cornerUV = vTexCoord.xy;","cornerUV.y = 2.0 * (cornerUV.y - 0.5);","float xUVTest1 = clamp(sign(thicknessUV - cornerUV.x), 0.0, 1.0); // if cornerUV.x<thicknessUV","float xUVTest2 = clamp(sign(cornerUV.x - (1.0 - thicknessUV)), 0.0, 1.0); // if cornerUV.x>1.0f - thicknessUV","cornerUV.x = mix(cornerUV.x, 1.0 - cornerUV.x / thicknessUV, xUVTest1); // if cornerUV.x<thicknessUV => cornerUV.x = 1.0f - cornerUV.x/thicknessUV","cornerUV.x = mix(cornerUV.x, (cornerUV.x - (1.0 - thicknessUV)) / thicknessUV, xUVTest2); // if cornerUV.x > 1.0f - thicknessUV => (cornerUV.x - (1.0f - thicknessUV))/thicknessUV","float inTheCorner = xUVTest1 + xUVTest2; // xUVTest1 || xUVTest2","float corner = cornerUV.x * cornerUV.x + cornerUV.y * cornerUV.y;","if(isOpenedWire * inTheCorner * corner > 1.0) // true only if isOpenedWire == 1 and inTheCorner == 1 and corner > 1 as isOpenedWire and inTheCorner can only be 0 or 1","{","discard;","}","//-----------------------------------------------------------------------------------------------","// Handle cut by plane","//-----------------------------------------------------------------------------------------------","float cutByPlaneActivated = clamp(sign(CrD_Base_UniformCutByPlane), 0.0, 1.0); // 0 if CutByPlane <= 0, 1 if CutByPlane > 0        ","float screenActivated = clamp(sign(CrD_Base_UniformScreenPlane), 0.0, 1.0); // 0 if ScreenPlane <= 0, 1 if ScreenPlane > 0","// We do the work in the view space","// We compute the plane's equation: ax + by + cz + d = 0   => Normal(a, b, c), d = -dot(CrD_Base_UniformPlaneNormal, CrD_Base_UniformPlanePosition)","vec4 viewPlaneEq = vGetWorldViewInvTranspMatrix() * vec4(CrD_Base_UniformPlaneNormal, -dot(CrD_Base_UniformPlaneNormal, CrD_Base_UniformPlanePosition));","// eye and Fragment position","vec4 fragPos = vec4(vGetViewPosition(), 1.0);","vec4 eyePos = vec4(0.0, 0.0, 0.0, 1.0);","// The sign of the plane's equation applied to the previous position gives the side of each point","float eyeClip = dot(viewPlaneEq, eyePos); // => d","float fragClip = dot(viewPlaneEq, fragPos) + sign(eyeClip) * 10e-2;","// cutByPlaneActivated == 0 => hide = 0.0","// If both values have the same sign, they are on the same side => hide = 0.0","// If there signs are different, they are on opposite side      => hide = 1.0","float hide = mix(0.0, clamp(-1.0 * sign(fragClip * eyeClip), 0.0, 1.0), cutByPlaneActivated);","//-----------------------------------------------------------------------------------------------","// Handle Resize UV","//-----------------------------------------------------------------------------------------------","float resizeMode = clamp(sign(CrD_FeltPen_UniformResizeUMode), 0.0, 1.0);","float outsideLimit = clamp(sign(CrD_FeltPen_UniformUMin - vTexCoord.x), 0.0, 1.0) + clamp(sign(vTexCoord.x - CrD_FeltPen_UniformUMax), 0.0, 1.0); //if((uv.x < UMin) || (uv.x > UMax)) ","float alpha = mix(CrD_Base_UniformColor.a, 0.0625 * CrD_Base_UniformColor.a, resizeMode * outsideLimit);","commonFinalColor = vec4(CrD_Base_UniformColor.xyz, pressure * alpha * mix(1.0, 0.25, hide));","}"].join("\n"),ComputeAlbedo:["vec3 ComputeAlbedo() {","return commonFinalColor.xyz;","}"].join("\n"),ComputeOpacity:["float ComputeOpacity() {","return commonFinalColor.a;","}"].join("\n")};return t.setPDSFXOverridableFunctions(a,s),t.needsUpdate=!0,t}}),define("DS/Shaders/CATCrDBallPointShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return function(t,i){t.activatePDSFX(),t.transparent=!0,t.side=e.DoubleSide,t.setPDSFXPolygonOffset("Frontward1");var r=["vec4 commonFinalColor;","vec3 selectorColor = vec3(0., 0.45, 0.75);","float bezierBlend(float t)","{","return clamp((3.0 * t * t * (1.0 - t) + t * t * t), 0.0, 1.0);","}"].join("\n");t.setPDSFXGlobalShaderCode("",r);var n={CrD_Base_UniformColor:{type:"v4",value:new e.Vector4(i.Color[0],i.Color[1],i.Color[2],i.Color[3])},CrD_Base_UniformCutByPlane:{type:"f",value:i.CutByPlane},CrD_Base_UniformScreenPlane:{type:"f",value:i.ScreenPlane},CrD_Base_UniformPlanePosition:{type:"v3",value:new e.Vector3(i.PlanePosition[0],i.PlanePosition[1],i.PlanePosition[2])},CrD_Base_UniformPlaneNormal:{type:"v3",value:new e.Vector3(i.PlaneNormal[0],i.PlaneNormal[1],i.PlaneNormal[2])},CrD_BallPoint_UniformCircleSelection:{type:"f",value:0},CrD_BallPoint_UniformRadius:{type:"v2",value:new e.Vector2(0,0)},CrD_BallPoint_UniformCenter:{type:"v2",value:new e.Vector2(0,0)}};t.setPDSFXUniforms(n);t.setPDSFXVaryings({vTexCoord:{type:"v3"}});var a={ComputeObjectPosition:["vec3 ComputeObjectPosition() {","return vGetAttribPosition();","}"].join("\n"),ComputeVaryingValues:["void ComputeVaryingValues() {","vTexCoord = vGetAttribTexCoord0().xyz;","}"].join("\n")},s={ComputeCommonValues:["void ComputeCommonValues() {","vec2 cornerUV = vTexCoord.xy;","float alpha    = CrD_Base_UniformColor.a;","float pressure = clamp(1.02 * 1.0, 0.0, 1.0); // if pressure > 0.98 => pressure = 1.0","cornerUV.y = 2.0 * (cornerUV.y - 0.5);","float xUVTest1 = clamp(sign(0.25 - cornerUV.x), 0.0, 1.0); // if cornerUV.x<0.25f","float xUVTest2 = clamp(sign(cornerUV.x - 0.75), 0.0, 1.0); // if cornerUV.x>0.75f","cornerUV.x = mix(cornerUV.x, 1.0 - cornerUV.x * 4.0, xUVTest1); // if cornerUV.x<0.25f => cornerUV.x = 1.0 - cornerUV.x * 4.0","cornerUV.x = mix(cornerUV.x, (cornerUV.x - 0.75) * 4.0, xUVTest2); // if cornerUV.x>0.75f => cornerUV.x = (cornerUV.x - 0.75) * 4.0","float inTheCorner = xUVTest1 + xUVTest2; // 0 if 0.25 < u < 0.75, else 1        ","float corner = cornerUV.x * cornerUV.x + cornerUV.y * cornerUV.y;","if(inTheCorner * corner > 1.0) // true only if inTheCorner = 1 and corner > 1 as inTheCorner can only be 0 or 1","{","discard;","}","float falloffU = bezierBlend(cornerUV.x);","// if inTheCorner is 1. then corner is <= 1.0 else we would have already discarded the fragment, so next line is equivalent to:","// if(inTheCorner>0.0 && corner <= 1.0) => alpha = mix(0.7 * alpha, alpha, (1.0 - falloffU) * 1.0 - falloffU * bezierBlend(corner))","// else alpha = alpha","alpha = mix(alpha, mix(0.7 * alpha, alpha, (1.0 - falloffU) * 1.0 - falloffU * bezierBlend(corner)), inTheCorner);","//-----------------------------------------------------------------------------------------------","// Handle cut by plane","//-----------------------------------------------------------------------------------------------","float cutByPlaneActivated = clamp(sign(CrD_Base_UniformCutByPlane), 0.0, 1.0); // 0 if CutByPlane <= 0, 1 if CutByPlane > 0        ","float screenActivated = clamp(sign(CrD_Base_UniformScreenPlane), 0.0, 1.0); // 0 if ScreenPlane <= 0, 1 if ScreenPlane > 0","// We do the work in the view space","// We compute the plane's equation: ax + by + cz + d = 0   => Normal(a, b, c), d = -dot(CrD_Base_UniformPlaneNormal, CrD_Base_UniformPlanePosition)","vec4 viewPlaneEq = vGetWorldViewInvTranspMatrix() * vec4(CrD_Base_UniformPlaneNormal, -dot(CrD_Base_UniformPlaneNormal, CrD_Base_UniformPlanePosition));","// eye and Fragment position","vec4 fragPos = vec4(vGetViewPosition(), 1.0);","vec4 eyePos = vec4(0.0, 0.0, 0.0, 1.0);","// The sign of the plane's equation applied to the previous position gives the side of each point","float eyeClip = dot(viewPlaneEq, eyePos); // => d","float fragClip = dot(viewPlaneEq, fragPos) + sign(eyeClip) * 10e-2;","// cutByPlaneActivated == 0 => hide = 0.0","// If both values have the same sign, they are on the same side => hide = 0.0","// If there signs are different, they are on opposite side      => hide = 1.0","float hide = mix(0.0, clamp(-1.0 * sign(fragClip * eyeClip), 0.0, 1.0), cutByPlaneActivated);","commonFinalColor = vec4(CrD_Base_UniformColor.xyz, pressure * alpha * mix(1.0, 0.25, hide));","//-----------------------------------------------------------------------------------------------","// handle circle selection","//-----------------------------------------------------------------------------------------------","float circleSelectActivated = clamp(sign(CrD_BallPoint_UniformCircleSelection), 0.0, 1.0); // if CircleSelection > 0 => circleSelectActivated = 1 else circleSelectActivated = 0","// screen coordinates of current fragment - circle center coordinates","vec2 vect = vGetFragCoord().xy - CrD_BallPoint_UniformCenter.xy;","float circleValue = pow(vect.x, 2.0) / pow(CrD_BallPoint_UniformRadius.x, 2.0) + pow(vect.y, 2.0) / pow(CrD_BallPoint_UniformRadius.y, 2.0);","// at the end, coeff is 0 if circleSelectActivated is 0 or if we are outside the selection circle","//             coeff is 1 at the middle of the circle, slowly decreases afterward and reaches 0 on the circle border","float coeff = circleSelectActivated * (1.0 - clamp(circleValue, 0.0, 1.0));","float selectionAlpha = 0.3 * coeff + 0.7;","vec4 blendResult;","blendResult.a = selectionAlpha + commonFinalColor.a * (1.0 - selectionAlpha);","blendResult.rgb = (selectorColor * selectionAlpha + commonFinalColor.xyz * commonFinalColor.a * (1.0 - selectionAlpha)) / selectionAlpha;","commonFinalColor = mix(commonFinalColor, blendResult, sign(coeff));","}"].join("\n"),ComputeAlbedo:["vec3 ComputeAlbedo() {","return commonFinalColor.xyz;","}"].join("\n"),ComputeOpacity:["float ComputeOpacity() {","return commonFinalColor.a;","}"].join("\n")};return t.setPDSFXOverridableFunctions(a,s),t.needsUpdate=!0,t}}),define("DS/Visualization/BudgetedRenderManager",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i=e.extend({init:function(e){return this.viewer=e,this._frameTime=0,this._isActive=!1,this._isSimpleActive=!0,this._lastRefreshStamp=performance.now(),this._objectivePercentage=-1,this._shiftToObjective=0,this._shiftStart=0,this._renderTimeStart=0,this._lastRenderTime=16.7,this._lastRenderFrameTime=16.7,this._maxTime=0,this._simpleMaxTime=2e3,this._renderCallbackId=-1,this._startStamp=performance.now(),this._preRenderCallBackId=-1,this._postRenderCallBackId=-1,this},_setAsRenderFrame:function(){this._isRenderFrame=!0},_askForRender:function(e){if(this._isActive||this._isSimpleActive)if(this._isSimpleActive){(i=(t=performance.now())-this._lastRefreshStamp)>this._simpleMaxTime&&(e.budgeted=!1,this._lastRefreshStamp=t,this.viewer.render(e))}else{var t,i=(t=performance.now())-this._lastRefreshStamp,r=(this._startStamp,this._objectivePercentage),n=(performance.now()-this._shiftStart)/this._shiftToObjective;r=1-(n=(n=Math.min(Math.max(0,n),1))*n*(3-2*n))+r*n;var a=this._lastRenderTime*(1-r)/r-i;if(a<=0||this._maxTime>0&&i>this._maxTime)e.budgeted=!1,this._lastRefreshStamp=t,this._renderCallbackId>=0&&(clearTimeout(this._renderCallbackId),this._renderCallbackId=-1),this.viewer.render(e);else if(this._renderCallbackId<0){var s=this;this._renderCallbackId=setTimeout(function(){s.viewer.render(e)},a)}}else e.budgeted=!1,this.viewer.render(e)},_resetShift:function(){this._shiftStart=performance.now(),this._renderCallbackId>=0&&(clearTimeout(this._renderCallbackId),this._renderCallbackId=-1)},resetMeasures:function(){this._startStamp=performance.now(),this._lastRefreshStamp=performance.now(),this._lastrenderTime=16.7},setBudget:function(e){this._objectivePercentage=Math.max(0,Math.min(1,e)),this._isActive=!0,this._isSimpleActive=!1;var t=this;if(-1===this._preRenderCallBackId){this._preRenderCallBackId=this.viewer.onPreRender(function(){t._renderTimeStart=performance.now()});this._postRenderCallBackId=this.viewer.onPostRender(function(){t._lastRenderTime=performance.now()-t._renderTimeStart})}this.resetMeasures()},setSimpleBudget:function(e){this._isSimpleActive=e,e&&this._isActive&&(this._isActive=!1)},disableBudget:function(){this._isActive=!1,this._objectivePercentage=-1,this._preRenderCallBackId>=0&&(this.viewer.unsubscribe(this._preRenderCallBackId),this.viewer.unsubscribe(this._postRenderCallBackId),this._preRenderCallBackId=-1,this._postRenderCallBackId=-1)},setSimpleMaxTime:function(e){this._simpleMaxTime=e},setMaxTime:function(e){this._maxTime=e},setShiftingObjective:function(e){this._shiftToObjective=e}});return UWA.namespace("THREEDS/BudgetedRenderManager",i)}),define("DS/VisuEvents/ScreenEvent",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events"],function(e,t,i){"use strict";var r=e.extend({init:function(e){return this.type="Screen",this.view=null,this.path=null,this.event=e,this.isPrimary=!1,this.state=r.State.NONE,this.startTime=0,this.currentTime=0,this.startPosition=new t.Vector2,this.currentPosition=new t.Vector2,this.lastPosition=new t.Vector2,this.deltaPosition=new t.Vector2,this.offsetPosition=new t.Vector2,this._startPosition=new t.Vector2,this._currentPosition=new t.Vector2,this._lastPosition=new t.Vector2,this._deltaPosition=new t.Vector2,this._offsetPosition=new t.Vector2,this.updateView(e),this},setPrimary:function(e){this.isPrimary=e},update:function(e){switch(this.currentTime=e.timeStamp,this.event=e,e.type){case"mousedown":case"touchstart":case"wheel":case"mousewheel":case"DOMMouseScroll":this.state=r.State.BEGIN,this.startTime=this.currentTime;break;case"keydown":this.state===r.State.NONE&&(this.state=r.State.BEGIN,this.startTime=this.currentTime);break;case"mousemove":case"touchmove":this.state=r.State.MOVE,this.updateView(e);break;case"keyup":case"mouseup":case"touchend":this.state=r.State.END;break;case"mouseleave":case"mouseout":case"touchcancel":this.state=r.State.CANCEL}},updateView:function(e){var t;if(e.composedPath&&e.composedPath()&&e.composedPath().length){let i=e.composedPath();t=i[0].__impl4cf1e782hg__||i[0].impl||i[0],this.path=i}else e.path&&e.path.length?(t=e.path[0].__impl4cf1e782hg__||e.path[0].impl||e.path[0],this.path=e.path):e.target?t=e.target:e.srcElement&&(t=e.srcElement);this.view&&(this.startPosition.copy(this.getRelativePositionToView(this.startPosition,t)),this.currentPosition.copy(this.getRelativePositionToView(this.currentPosition,t)),this.lastPosition.copy(this.getRelativePositionToView(this.lastPosition,t))),this.view=t},nextState:function(){switch(this.state){case r.State.BEGIN:case r.State.MOVE:this.state=r.State.IDLE;break;case r.State.END:case r.State.CANCEL:default:this.state=r.State.NONE}},getType:function(){return this.type},getState:function(){return this.state},getView:function(){return this.view},getJSEvent:function(){return this.event},isInView:function(e){var t=e;if(e instanceof Array||(t=[e]),this.path)for(var i=0;i<t.length;i++)for(var r=0;r<this.path.length;r++){if((this.path[r].__impl4cf1e782hg__||this.path[r].impl||this.path[r])===(t[i].__impl4cf1e782hg__||t[i].impl||t[i]))return!0}else for(i=0;i<t.length;i++)for(var n=this.view;n;){if(n===t[i])return!0;n=n.parentNode}return!1},getStartPosition:function(e){return e?this.getRelativePositionToView2(this._startPosition,e):this.getRelativePositionToView2(this._startPosition,this.view)},getCurrentPosition:function(e){return e?this.getRelativePositionToView2(this._currentPosition,e):this.getRelativePositionToView2(this._currentPosition,this.view)},getLastPosition:function(e){return e?this.getRelativePositionToView2(this._lastPosition,e):this.getRelativePositionToView2(this._lastPosition,this.view)},getOffsetPosition:function(){return this._offsetPosition.clone()},getDeltaPosition:function(){return this._deltaPosition.clone()},getRelativePositionToView:function(e,i){var r,n;try{r=this.view.getBoundingClientRect()}catch(e){r={left:0,top:0}}try{n=i.getBoundingClientRect()}catch(e){n={left:0,top:0}}return new t.Vector2(e.x+r.left-n.left,e.y+r.top-n.top)},getRelativePositionToView2:function(e,i){var r;try{r=i.getBoundingClientRect()}catch(e){r={left:0,top:0}}return new t.Vector2(e.x-r.left,e.y-r.top)}});return r.State={NONE:0,BEGIN:1,IDLE:2,MOVE:3,END:4,CANCEL:5},r.MouseButton={NONE:-1,LEFT:0,MIDDLE:1,RIGHT:2,WHEEL:3},r.KeyboardKey={SHIFT:16,CTRL:17,S:83},r.printMouseButton=function(e){switch(e){case r.MouseButton.LEFT:return"Left";case r.MouseButton.MIDDLE:return"Middle";case r.MouseButton.RIGHT:return"Right";case r.MouseButton.NONE:default:return""}},UWA.namespace("THREEDS/Events/ScreenEvent",r)}),define("VisuEvents/ScreenEvent",["DS/VisuEvents/ScreenEvent","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuEvents/ScreenEvent"),e}),define("DS/Plugins/ShaderPass",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=1,i=function(i,r,n){this.textureID=void 0!==r?r:"tDiffuse",this.uniforms=e.UniformsUtils.clone(i.uniforms),this.name=n,this.id="S"+t++,this.defines={},i.defines&&(this.defines=Object.assign({},i.defines)),this.material=new e.ShaderMaterial({uniforms:this.uniforms,vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,defines:this.defines}),this.material.force=!0,this.material.polygonOffset=!0,this.material.polygonOffsetFactor=0,this.material.polygonOffsetUnits=0,this.renderToScreen=!1,this.disableDepthTest=!0,this.needsSwap=!0,this.composer=null,this.requiredComposers=[],this.forceRenderTarget=null,this.order=0,this.isCustomPass=!1,this.defaults={},this.linkedComposerContexts=[],this.idString="main",this.changeRenderTargetProperties=null,this.enableWarmStart=!1,this.beforeRenderCB=null,this.afterRenderCB=null,this.requiredReadBuffer=null,this.isOITPass=!1,this.composer=null,this.disabledByDefault=!1,this.order=0,this.gammaCorrectionPass=!1,this.isRobotPass=!1,this.stateSortingResults={},this.geometry=[e.createPlaneGeometryDS(2,2)],this.quad=new e.Mesh(this.geometry,null),this.quad.frustumCulled=!1,this.quad.visibilityFree=!0,this.shaderPassScene=new e.Scene,this.shaderPassScene.add(this.quad)};return i.prototype={_updateMaterialShader:function(e){this.material.dispose(),this.material.fragmentShader=e.fragmentShader,this.material.vertexShader=e.vertexShader},compileShader:function(e){e&&e.initMaterial(this.material,[],this.quad,null,this.material.programManager.getProgramID(this.quad,null,0),null,0),this.material.needsUpdate=!0},setForceRenderTarget:function(e){this.forceRenderTarget=e},addRequiredComposer:function(e){this.requiredComposers.push(e)},setCustomPass:function(){this.isCustomPass=!0},getDefaultState:function(){return{enabled:!this.disabledByDefault,renderToCanvas:!1,isLastPass:!1}},addLinkedEffectComposerContext:function(e){this.linkedComposerContexts.indexOf(e)<0&&(this.linkedComposerContexts.push(e),e.useCount++)},shareDepth:function(e,t,i){var r=e.composerContext.forceRenderTarget;r&&r.shareDepthFrom===i||(r&&r.dispose(),(r=e.renderTargetPool.buildRenderTarget(e.composerContext.width,e.composerContext.height,e.composerContext.renderTargetProperties.options,null,i,!0)).generateMipmaps=!1,e.composerContext.forceRenderTarget=r,this.requiredReadBuffer=i)},render:function(t,i,r,n,a,s,o,l,c,h){var u,d=t.info.renderTime;for(d.push(this.name),!a&&this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i),this.beforeRenderCB&&this.beforeRenderCB(i),u=0;u<this.requiredComposers.length;u++){var p=this.requiredComposers[u];p.bShareDepth&&this.shareDepth(p,t,i),p.needsCameraUpdate&&(this.requiredComposers[u].composerContext.cameraName=s.cameraName);var f=p.getAllPasses();if(f.length>0&&void 0!==f[0].uniforms){var m=f[0].uniforms;void 0!==m[this.textureID]&&(m[this.textureID].value=i)}this.requiredComposers[u].render(void 0,void 0,o,c)}this.quad.material=this.material,t.setCurrentPass(this),t.autoClearStencil=!1,t.autoClearDepth=!1,t.activateSplitScreenMode(!r),t.setDisableDepthTest(this.disableDepthTest),null!==this.forceRenderTarget&&(r=this.forceRenderTarget);var g=s?s.id:-1,v=null;this.stateSortingResults[g]?v=this.stateSortingResults[g]:((v=new e.StateSortingResult(this,-1)).init(),this.stateSortingResults[g]=v);var S=t.renderFaceMode;t.renderFaceMode=0,h?t.render(this.shaderPassScene,this.composer.camera,void 0,void 0,void 0,v,!0):t.render(this.shaderPassScene,this.composer.camera,r,!1,void 0,v,!0),t.renderFaceMode=S,t.setDisableDepthTest(!1),t.setCurrentPass(null),this.afterRenderCB&&this.afterRenderCB(),d.pop()}},i}),define("Plugins/ShaderPass",["DS/Plugins/ShaderPass","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Plugins/ShaderPass"),e}),define("DS/Gestures/BasicGesture",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events"],function(e,t,i){"use strict";var r=0,n=0,a=e.extend({init:function(e){return this.name=e||"",this.id=r++,this.view=[],this.priority=1e3,this._order=0,this._needsUpdate=!1,this.currentEvent=null,this.events=[],this.debugEvents=!1,this.state=a.State.INIT,this.firstChange=!1,this.lastChange=!1,this.gestures=[],this.requiredBy=0,this.maskedBy=[],this.callbacks=[],this.action="",this},setView:function(e){if(e)if(e instanceof Array){this.view=[];for(var t=0;t<e.length;t++)this.view.push(e[t])}else this.view=[e]},setAction:function(e){this.action=e},addView:function(e){e&&this.view.push(e)},removeView:function(e){if(e){var t=this.view.indexOf(e);-1!==t&&this.view.splice(t,1)}},resetView:function(){this.view=[]},setPriority:function(e){this.priority=e},requireGesture:function(e){this.gestures.push(e),e.requiredBy++,this._needsUpdate=!0},maskGesture:function(e){null!==e&&e.maskedBy.push(this)},addCallback:function(e){if("function"==typeof e){for(var t=0;t<this.callbacks.length;t++)if(this.callbacks[t].cb===e)return this.callbacks[t].uid;var i=this._getEventID();return this.callbacks.push({cb:e,uid:i}),i}return null},removeCallback:function(e){if("function"==typeof e)for(var t=0;t<this.callbacks.length;t++)if(this.callbacks[t].cb===e)return this.callbacks[t].cb=null,!0;return!1},removeCallbackFromToken:function(e){for(var t=0;t<this.callbacks.length;t++)if(this.callbacks[t].uid===e&&this.callbacks[t].cb)return this.callbacks[t].cb=null,!0;return!1},executeCallbacks:function(e){var t,i=!1,r=this.callbacks.slice();for(t=0;t<r.length;t++)r[t].cb?r[t].cb.call(this,e):i=!0;i&&this._updateCBArray()},_updateCBArray:function(){if(this.callbacks.length){for(var e=[],t=0;t<this.callbacks.length;t++)this.callbacks[t].cb&&e.push(this.callbacks[t]);this.callbacks=e}},_getEventID:function(){var e=this.id+"_"+n;return n++,e},isUsed:function(){return this.callbacks.length||this.requiredBy},_dispose:function(e){if(this._updateCBArray(),!this.isUsed()){for(var t=0;t<this.gestures.length;t++)this.gestures[t].requiredBy--,!this.gestures[t].requiredBy&&this.gestures[t]._dispose(e);e&&e.apply(this),this.view=[]}},detect:function(e){this.currentEvent=e},execute:function(e){if(this.state===a.State.OK||this.state===a.State.CHANGE){if(!e)for(var t=0;t<this.maskedBy.length;t++){var i=this.maskedBy[t];if(i.state===a.State.OK||i.state===a.State.CHANGE)return}this.triggerEvent(this.currentEvent)}},update:function(){switch(this.state){case a.State.KO:case a.State.OK:case a.State.CANCEL:this.changeState(a.State.INIT);break;case a.State.CHANGE:this.lastChange&&(this.lastChange=!1,this.changeState(a.State.INIT))}},setDebugEvents:function(e){this.debugEvents=e},changeState:function(e,t){this.firstChange=this.state===a.State.BEGIN&&e===a.State.CHANGE,this.lastChange=!!t,this.state=e,this.debugEvents>=5&&console.log("Gesture "+this.name+" change state to "+a.printState(this.state))},getState:function(){return this.state},getName:function(){return this.name},getEvents:function(){return this.events},triggerEvent:function(){var e={eventChannel:"/VISU/",eventType:"@on"+this.name+"Event",eventID:this.id,from:this.currentEvent,gesture:this,state:this.firstChange?"begin":this.lastChange?"end":""};switch(this.debugEvents){case 0:case 1:break;case 2:this.state===a.State.OK&&console.log(e);break;case 3:this.state===a.State.CHANGE&&console.log(e);break;case 4:case 5:case 6:console.log(e)}i.publish({event:"/VISU/on"+this.name,data:e}),a.RecordEventsManager&&(window.WebVisuCurrentGesture=this),this.executeCallbacks(e),a.RecordEventsManager&&(window.WebVisuCurrentGesture=null),a.RecordEventsManager&&a.RecordEventsManager.recordBasicGesture(this)},getElapsedTime:function(){return this.getEvents().length>0?this.getEvents()[0].currentTime-this.getEvents()[0].startTime:null}});return a.State={INIT:0,BEGIN:1,CHANGE:2,OK:3,KO:4,CANCEL:5},a.printState=function(e){switch(e){case a.State.INIT:return"INIT";case a.State.BEGIN:return"BEGIN";case a.State.CHANGE:return"CHANGE";case a.State.OK:return"OK";case a.State.KO:return"KO";case a.State.CANCEL:return"CANCEL";default:return""}},a.RecordEventsManager=null,a.setRecordEventsManager=function(e){this.RecordEventsManager=e},UWA.namespace("THREEDS/Gestures/BasicGesture",a)}),define("Gestures/BasicGesture",["DS/Gestures/BasicGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/BasicGesture"),e}),define("DS/Effects/BasicEffect",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return e.extend({init:function(e){return this.enabled=!0,this.composers=[],this.mixPass=null,this.width=2,this.height=2,this.renderer=e,this},initEffect:function(e,t){},update:function(e,t,i){},setSize:function(e,t){return(this.width!==e||this.height!==t)&&(this.width=Math.max(2,e),this.height=Math.max(2,t),!0)},updateComposersName:function(e){var t;for(t=0;t<this.composers.length;t++)this.composers[t].composerContext.name||(this.composers[t].composerContext.name=e+"#"+t)},setEnabled:function(e){var t;for(this.enabled=e,t=0;t<this.composers.length;t++)this.composers[t].enabled=e;if(null!==this.mixPass){var i=this.mixPass.composer;i&&i.contexts.length&&i.contexts[0].enablePass(this.mixPass,e)}},getMaxIteration:function(){return 0},dispose:function(){var e;for(e=0;e<this.composers.length;e++)this.composers[e].composerContext&&this.composers[e].composerContext.dispose(),this.composers[e].dispose()}})}),define("Effects/BasicEffect",["DS/Effects/BasicEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/BasicEffect"),e}),define("DS/Plugins/ClearPass",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=1,i=function(i){this.name=i,this.id="C"+t++,this.clearColor=null,this.clearAlpha=1,this.oldClearColor=new e.Color,this.oldClearAlpha=1,this.clear=!0,this.clearbColor=!1,this.clearDepth=!1,this.needsSwap=!1,this.clearStencil=!1,this.clearStencilValue=null,this.invertTarget=!1,this.scene=null,this.idString=null,this.composer=null,this.order=0,this.disabledByDefault=!1,this.isCustomPass=!1,this.isRobotPass=!1,this.defaults={clear:!0,doClearDepth:!1}};return i.prototype={getDefaultState:function(){return{enabled:!this.disabledByDefault,clear:this.defaults.clear,clearColor:this.clearColor,clearAlpha:this.clearAlpha,doClearDepth:this.defaults.doClearDepth,renderToCanvas:!1}},setClearStencil:function(e){this.clearStencil=e},setClearDepth:function(e){this.clearDepth=e},setCustomPass:function(){this.isCustomPass=!0},setScene:function(e){this.scene=e},render:function(e,t,i,r,n,a,s,o,l,c){if(!this.idString||!this.scene||0!==this.scene.getNbWebGLObjects(this.idString)){var h=e.info.renderTime;h.push(this.name);var u=e.context;this.clearColor&&(this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),null!==this.clearStencilValue?u.clearStencil(this.clearStencilValue):u.clearStencil(100),e.autoClear=!1,e.autoClearColor=this.clear||this.clearbColor,e.autoClearDepth=this.clear||this.clearDepth,e.autoClearStencil=this.clear||this.clearStencil,e.setCurrentPass(this);var d,p=null;c||(p=this.invertTarget?t:i),e.setRenderTarget(p),e.splitScreenMode?e.activateSplitScreenMode(!p):(d=e.getScissorTest(),e.enableScissorTest(!1)),e.clear(this.clear||this.clearbColor,this.clear||this.clearDepth,this.clear||this.clearStencil),e.splitScreenMode||e.enableScissorTest(d),e.setCurrentPass(null),h.pop()}}},i}),define("Plugins/ClearPass",["DS/Plugins/ClearPass","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Plugins/ClearPass"),e}),define("DS/Visualization/MaterialManager",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/CoreEvents/ModelEvents"],function(e,t,i,r,n){"use strict";function a(e,t){return i.ImageUtils.loadTextureCube(e,t)}function s(e,t){return i.ImageUtils.loadTexture(e,void 0,null,null,t)}i.ParticleBasicMaterial,i.LineBasicMaterial,i.DSPBR22xMaterial,i.MeshBasicMaterial;var o=["Generic","Metal","Glass","Plastic","Textile","Leather","Car Paint","Emissive","Basic","Wood"],l=[1,1,2,3,4,5,6,7,8],c=["NO_TRANSCODE","RGB","RGBA","RGBHQ","NORMAL_MAP","GRAYSCALE"],h=null,u=new i.Matrix3,d=null,p=null,f=e.extend({init:function(e,t,r,a){if(null!==d){if(this.viewerList=d.viewerList,a&&this.viewerList.set(a.id,a),d.multiViewer||!t)return this.multiViewer=d.multiViewer,this.canvas=d.canvas,this.context=d.context,this.materials=d.materials,this.gasMaterialsMap=d.gasMaterialsMap,this.gasSGOrederMaterialsMap=d.gasSGOrederMaterialsMap,this.threeDXSharedGas=d.threeDXSharedGas,this.CGRSharedMaterials=d.CGRSharedMaterials,this.textures=d.textures,this.texturesPoint=d.texturesPoint,this.resources=[],this.PointSymbolEnum=d.PointSymbolEnum,this._modelEvent=d._modelEvent,this.backgroundColor=d.backgroundColor,this.backgroundColorMaterial=d.backgroundColorMaterial,this.backgroundColorMaterials=d.backgroundColorMaterials,this.backgroundColorInit=d.backgroundColorInit,this.blankingRepMaterials=d.blankingRepMaterials,!this.backgroundColorInit&&a&&this.initBackgroundColor(a),this.displayBlanking=d.displayBlanking,this.lineTypes=d.lineTypes,this.precomputedTexture=d.precomputedTexture,this.noiseTexture3D=d.noiseTexture3D,this.precomputedAreaGGX1texture=d.precomputedAreaGGX1texture,this.precomputedAreaGGX2texture=d.precomputedAreaGGX2texture,this.precomputedAreaAshikmintexture=d.precomputedAreaAshikmintexture,this.precomputedAreaEsteveztexture=d.precomputedAreaEsteveztexture,this.precomputedAreaBeckmanntexture=d.precomputedAreaBeckmanntexture,this;d.precomputedTexture&&d.precomputedTexture.dispose(),d.noiseTexture3D&&d.noiseTexture3D.dispose(),d.precomputedAreaGGX1texture&&d.precomputedAreaGGX1texture.dispose(),d.precomputedAreaGGX2texture&&d.precomputedAreaGGX2texture.dispose(),d.precomputedAreaAshikmintexture&&d.precomputedAreaAshikmintexture.dispose(),d.precomputedAreaEsteveztexture&&d.precomputedAreaEsteveztexture.dispose(),d.precomputedAreaBeckmanntexture&&d.precomputedAreaBeckmanntexture.dispose()}else this.viewerList=new Map,a&&this.viewerList.set(a.id,a);return this.gasMaterialsMap=new Map,this.gasSGOrederMaterialsMap=new Map,this.materials=[],this.threeDXSharedGas=new Map,this.CGRSharedMaterials=new Map,this.textures=[],this.texturesPoint=new Array(10),this.resources=[],this._currentMatHasTexture=!1,this._modelEvent=new n,p=null,this.backgroundColorMaterial=null,this.backgroundColorMaterials=[],this.blankingRepMaterials=[],this.displayBlanking=!1,this.blankingInit=!1,this.backgroundColor=new i.Color,this.backgroundColorInit=!1,this.lineTypes={shapes:[],patterns:[],types:[]},d=this,f.singleton=d,this.debugWebgl2=a&&a.debugWebgl2,this.initResources(e,t,r),a&&this.initBackgroundColor(a),this.PointSymbolEnum={NOSPRITE:0,CROSS:1,PLUS:2,CONCENTRIC:3,COINCIDENT:4,FULLCIRCLE:5,FULLSQUARE:6,STAR:7,DOT:8,SMALLDOT:9},this},cleanAll:function(){d.materials=[],d.gasMaterialsMap=new Map,d.gasSGOrederMaterialsMap=new Map,d.threeDXSharedGas.clear(),d.CGRSharedMaterials.clear(),d.backgroundColorMaterial=null,d.backgroundColorMaterials=[],d.blankingRepMaterials=[],d.precomputedTexture&&d.precomputedTexture.dispose(),d.noiseTexture3D&&d.noiseTexture3D.dispose(),d.precomputedAreaGGX1texture&&d.precomputedAreaGGX1texture.dispose(),d.precomputedAreaGGX2texture&&d.precomputedAreaGGX2texture.dispose(),d.precomputedAreaAshikmintexture&&d.precomputedAreaAshikmintexture.dispose(),d.precomputedAreaEsteveztexture&&d.precomputedAreaEsteveztexture.dispose(),d.precomputedAreaBeckmanntexture&&d.precomputedAreaBeckmanntexture.dispose(),h&&h.dispose(),this.deallocateSharedMaterials()},clearLineTypes:function(){this.lineTypes.shapes=[],this.lineTypes.patterns=[],this.lineTypes.types=[]},hasLineTypes:function(){return this.lineTypes.types.length>0},getPDSFX:function(e){require(["DS/"+e.name+"/"+e.name],function(t){t(e.material,e.parameters)})},setLineTypes:function(e){if(null==e)return void this.clearLineTypes();if(1!==e.version)throw new Error(`Unsupported custom lines specifications (version ${e.version}, expected 1)`);function t(e,t){return!!e||(console.error(t),!1)}e.shapes||(e.shapes=[]),e.patterns||(e.patterns=[]),e.types||(e.types=[]);const n=(e,i)=>t(void 0!==e,`Missing ${i}`),a=(e,i)=>t(Number.isFinite(e),`Invalid ${i}, expected a finite number, got '${e}'`);function s(e){let t=0,i=0;for(let r=0;r<e.length;r++)t+=e[r].length,i+=2*(e[r].length/3-1);const r=new Float32Array(t),n=t>196608?new Uint32Array(i):new Uint16Array(i);let a=0,s=0;for(let t=0;t<e.length;t++){const i=e[t].length/3,o=a/3;for(let e=0;e+1<i;e++)n[s++]=o+e,n[s++]=o+e+1;r.set(e[t],a),a+=e[t].length}return{vertices:r,indices:n}}let o=[];for(let n=0;n<e.shapes.length;n++){const a=e.shapes[n];let l=null,c=null;if(a instanceof i.BufferGeometryDS)c=(l=a).drawingGroups[0];else{if(l=new i.BufferGeometryDS,a.triangles){if(!t(a.triangles.length%3==0,`Invalid shape ${n}, indices do not form a set of triangles`))return;l.vertexPositionArray=new Float32Array(a.vertices),l.vertexPositionArray.length>=196608?l.vertexIndexArray=new Uint32Array(a.triangles):l.vertexIndexArray=new Uint16Array(a.triangles),c=new r.DrawingGroup(void 0,void 0,4,0,l.vertexIndexArray.length)}else if(a.polylines){for(let e=0;e<a.polylines.length;e++)if(!t(a.polylines[e].length%3==0,`Invalid shape ${n}, polyline nÂ°${e} does not form a set of 3D vertices`))return;const{vertices:e,indices:i}=s(a.polylines);l.vertexPositionArray=e,l.vertexIndexArray=i,c=new r.DrawingGroup(null,null,1,0,l.vertexIndexArray.length)}if(!t(0!==l.vertexPositionArray.length,`Invalid shape ${n}, missing vertices`))return;if(!t(0!==l.vertexIndexArray.length,`Invalid shape ${n}, missing indices`))return;c&&(c._primitives=[{group:c,start:c.start,count:c.count}],c.geometry=l,l.drawingGroups.push(c))}o.push(c)}let l=[];for(let t=0;t<e.patterns.length;t++){let r=[];for(let s=0;s<e.patterns[t].length;s++){const l=e.patterns[t][s];if(!a(l.length,`length of segment ${s} of pattern ${t}`))return;if(void 0!==l.shape&&null!==l.shape&&!n(o[l.shape],`shape of segment ${s} of pattern ${t}`))return;const c=void 0;try{16===l.matrix.length?c=new i.Matrix4(...l.matrix):12===l.matrix.length&&(c=new i.Matrix3(...l.matrix))}catch(e){}r.push({length:l.length,shape:l.shape,matrix:c})}l.push(r)}let c=[];for(let t=0;t<e.types.length;t++){if(void 0!==e.types[t].pattern&&null!==e.types[t].pattern&&!n(l[e.types[t].pattern],`pattern of type ${t}`))return;if(void 0!==e.types[t].scale&&!a(e.types[t].scale,`scale of type ${t}`))return;if(!a(e.types[t].pixelWidth,`pixel width of type ${t}`))return;if(!a(e.types[t].printWidth,`print width of type ${t}`))return;c.push({pattern:e.types[t].pattern,scale:e.types[t].scale||1,pixelWidth:e.types[t].pixelWidth,printWidth:e.types[t].printWidth})}this.lineTypes.shapes=o,this.lineTypes.patterns=l,this.lineTypes.types=c},_createLineTypeMaterial:function(e,t){if(!this.hasLineTypes())return console.error(`Cannot create material for line type '${e}' material: no line types defined`),null;if(!this.lineTypes.types[e])return console.warn(`Cannot create material for line type '${e}' material: unknown line type`),null;const r=this.lineTypes.types[e];return t||(t={}),t.isCPUPattern=!0,t.force=!0,t.scale=r.scale||1,t.lineWidth=r.pixelWidth,t.pattern=void 0!==r.pattern&&null!==r.pattern?this.lineTypes.patterns[r.pattern]:void 0,t.patternShapes=this.lineTypes.shapes,new i.LineBasicMaterial(t)},deallocateSharedMaterials:function(){for(var e=["Invisible","Normal","Depth","NormalDepth","ShadowMapDepth","Picking","Highlight","PreHighlight","HighlightMobile"],t=["Face","Line","Point"],r=["0","1","2"],n=["true","false"],a=[1],s=0;s<e.length;s++){var o=i.DefaultMaterials[e[s]];if(o)for(var l=0;l<t.length;l++){var c=o[t[l]];if(c)for(var h=0;h<r.length;h++){var u=c[r[h]];if(u)for(var d=0;d<n.length;d++){var p=u[n[d]];if(p){var f=p[a[0]];f&&(f.needsUpdate=!0)}}}}}},initBackgroundColor:function(e){this.backgroundColorInit=!0;var t=this;this.backgroundColor=e.ambience.getBackgroundColor(),e.onBackgroundModify(function(e){t.backgroundColor=new i.Color(e),t.updateBackgroundColorMaterial()})},updateBackgroundColorMaterial:function(){for(var e=0;e<this.blankingRepMaterials.length;e++)this.blankingRepMaterials[e].color=this.backgroundColor;for(e=0;e<this.backgroundColorMaterials.length;e++)this.backgroundColorMaterials[e].color=this.backgroundColor;this.backgroundColorMaterial&&(this.backgroundColorMaterial.color=this.backgroundColor)},initResources:function(e,r,n){if(this.multiViewer=r,r){this.canvas=document.createElement("canvas");var a=null;if(this.debugWebgl2&&(a=this.canvas.getContext("webgl2",{alpha:!0,premultipliedAlpha:!1,antialias:n,stencil:!0,preserveDrawingBuffer:e||!1,powerPreference:i._webglPerformanceProfile()}),i.WebGLVersion=2),!a){var s={alpha:!0,premultipliedAlpha:!1,antialias:n,stencil:!0,preserveDrawingBuffer:e||!1,powerPreference:i._webglPerformanceProfile()};a=this.canvas.getContext("webgl",s)||this.canvas.getContext("experimental-webgl",s),i.WebGLVersion=1}this.context=a}var o=t.getWebappsAssetUrl("Effects",""),l=i.ImageUtils.loadTGATexture(o+"precomputedTexture.bin",new i.UVMapping,null,null,!0,!0);l.minFilter=i.NearestFilter,l.magFilter=i.NearestFilter,this.precomputedTexture=l,this.noiseTexture3D=new i.DataTexture(new Uint8Array(16),2,2,i.RGBAFormat,i.UnsignedByteType,new i.LatLongReflectionMapping,i.ClampToEdgeWrapping,i.ClampToEdgeWrapping,i.LinearFilter,i.LinearFilter),this.noiseTexture3D.generateMipmaps=!1,this.noiseTexture3D.needsUpdate=!0,this.noiseTexture3D.onRequest=function(){this.loadEndStatus=i.AssetLoadingStatus.READY;for(var e=new Uint8Array(1048576),t=0;t<262144;t++){var r=255*Math.random();e[4*t]=r,e[4*t+1]=r,e[4*t+2]=r,e[4*t+3]=255}this.image.data=e,this.image.width=512,this.image.height=512,this.needsUpdate=!0,this.onRequest=null};var c=i.ImageUtils.loadCompressedTexture(o+"AreaLightGGX1.dds",new i.UVMapping,null,null,!1,!0);c.minFilter=i.LinearFilter,c.magFilter=i.LinearFilter,this.precomputedAreaGGX1texture=c;var h=i.ImageUtils.loadCompressedTexture(o+"AreaLightGGX2.dds",new i.UVMapping,null,null,!1,!0);h.minFilter=i.LinearFilter,h.magFilter=i.LinearFilter,this.precomputedAreaGGX2texture=h;var u=i.ImageUtils.loadCompressedTexture(o+"AreaLightSheenAshikmin.dds",new i.UVMapping,null,null,!1,!0);u.minFilter=i.LinearFilter,u.magFilter=i.LinearFilter,this.precomputedAreaAshikmintexture=u;var d=i.ImageUtils.loadCompressedTexture(o+"AreaLightSheenEstevez.dds",new i.UVMapping,null,null,!1,!0);d.minFilter=i.LinearFilter,d.magFilter=i.LinearFilter,this.precomputedAreaEsteveztexture=d;var p=i.ImageUtils.loadCompressedTexture(o+"AreaLightSheenBeckmann.dds",new i.UVMapping,null,null,!1,!0);p.minFilter=i.LinearFilter,p.magFilter=i.LinearFilter,this.precomputedAreaBeckmanntexture=p},setCanvasSize:function(e,t,i){if(this.multiViewer){var r=t,n=i;for(var a of this.viewerList.values())if(e!==a){var s=a.getCanvasSize();r=Math.max(s.width,r),n=Math.max(s.height,n)}this.canvas.width=r,this.canvas.height=n}},getCanvas:function(){return this.canvas},getContext:function(){return this.context},onPDSFXMaterial:function(e){return this._modelEvent.subscribe({event:"PDSFXMaterial"},e)},cleanResources:function(){d.textures=[],this.textures=[],this.materials=this.materials.filter(function(e){return!e.hasTexture})},getMaterialById:function(e){var t;for(t=0;t<this.materials.length;t++)if(this.materials[t].threejs_mat.id===e)return this.materials[t].threejs_mat;return null},getMaterialByName:function(e){var t;for(t=0;t<this.materials.length;t++)if(this.materials[t].threejs_mat.name===e)return this.materials[t].threejs_mat;return null},getBackgroundColorMaterial:function(){return this.backgroundColorMaterial?this.backgroundColorMaterial:(this.backgroundColorMaterial=new i.MeshBasicMaterial({side:i.DoubleSide,color:this.backgroundColor}),this.backgroundColorMaterial)},displayBlankingPolygon:function(e,t){this.displayBlanking=e;for(var i=0;i<this.blankingRepMaterials.length;i++)this.blankingRepMaterials[i].opacity=e?1:0},getBlankingRepMaterial:function(){var e=new i.MeshBasicMaterial({color:this.backgroundColor,overridable:!1,side:i.DoubleSide,opacity:this.displayBlanking?1:0,depthTest:!1,shading:i.FlatShading});return this.blankingRepMaterials.push(e),e},_getDashPattern:function(e){var t;switch(console.error("Error: accessing private method on MaterialManager"),e){case r.LinePatternEnum.DOTTED:(t=new Float32Array(2))[0]=2,t[1]=2;break;case r.LinePatternEnum.DASHED:(t=new Float32Array(2))[0]=3,t[1]=1;break;case r.LinePatternEnum.DOTDASHED:(t=new Float32Array(4))[0]=3,t[1]=2,t[2]=1,t[3]=2;break;case r.LinePatternEnum.PHANTOM:(t=new Float32Array(6))[0]=6,t[1]=2,t[2]=2,t[3]=2,t[4]=2,t[5]=2;break;case r.LinePatternEnum.SMALLDOTTED:(t=new Float32Array(2))[0]=1,t[1]=1;break;case r.LinePatternEnum.JISAXIS:(t=new Float32Array(4))[0]=2,t[1]=1,t[2]=12,t[3]=2;break;default:(t=new Float32Array(1))[0]=-1}return t},extractMaterialApplicationMappingInfos(e,t,r){if(e)if(t.isPhysicalMaterial){var n=t.__physicalMode>=1,a=!!e.type,s=!e.UvTransfoInfos||e.type||!!e.UvTransformation,o=null;e.ObjectTransformation&&((o=new i.Matrix4).elements=e.ObjectTransformation);var l=!1,c=!1;n?(c=!0,a||(l=!0)):(l=!0,a&&(c=!0));var h=null;c&&e.UvTransformation&&((h=new i.Matrix3).elements=e.UvTransformation);var u=null;if(l&&e.UvTransfoInfos){u=new i.Matrix3;var d=Math.cos(e.UvTransfoInfos[2]),p=Math.sin(e.UvTransfoInfos[2]),f=e.UvTransfoInfos[3],m=[e.UvTransfoInfos[0],e.UvTransfoInfos[1]];u.set(f*d,-f*p,m[0],f*p,f*d,m[1],0,0,1)}h&&u?h.multiplyMatrices(h,u):u&&(h=u);var g=e.type;n||("SPHERICAL_NORMALIZED"===g&&(g="SPHERICAL"),"INFINITE_CYLINDRICAL_NORMALIZED"===g&&(g="INFINITE_CYLINDRICAL")),s||-1==t.mappingType?t.setMappingOperator(g,o,h,!0):t.mappingUVTransformation.multiplyMatrices(h,t.mappingUVTransformation),t.mappingTransformSemantic=null!=e.transformSemantic?e.transformSemantic:1}else{h=null;if(e.UvTransfoInfos){h=new i.Matrix3;d=Math.cos(e.UvTransfoInfos[2]),p=Math.sin(e.UvTransfoInfos[2]),f=e.UvTransfoInfos[3],m=[e.UvTransfoInfos[0],e.UvTransfoInfos[1]];h.set(f*d,-f*p,m[0],f*p,f*d,m[1],0,0,1),r&&h.multiplyMatrices(uvTransfo,r),t.setMappingOperator(0,null,h,!0)}else r&&t.setMappingOperator(0,null,r,!0)}},getMaterialCgr:function(e,t,r,n,a){var s,o,l;if("true"===localStorage.getItem("NoCGRMaterials"))return null;if(void 0!==e.backgoundColor)return this.getBackgroundColorMaterial();if(void 0!==e.blankingRep)return this.getBlankingRepMaterial();if(void 0!==e.external3DXid){var c=this.getCGRSharedMaterial(e.external3DXid);return c&&this.extractMaterialApplicationMappingInfos(e.mapping,c),c}var h=!!i._CATGraphicalAsPBR;for(o=0;o<this.materials.length;o++)if("material"===(l=(s=this.materials[o]).params).type&&!l.shaderMaterial&&l.ambientCoef===e.ambientCoef&&l.diffuseCoef===e.diffuseCoef&&l.specularCoef===e.specularCoef&&l.colorAmbient[0]===e.colorAmbient[0]&&l.colorAmbient[1]===e.colorAmbient[1]&&l.colorAmbient[2]===e.colorAmbient[2]&&l.colorDiffuse[0]===e.colorDiffuse[0]&&l.colorDiffuse[1]===e.colorDiffuse[1]&&l.colorDiffuse[2]===e.colorDiffuse[2]&&l.colorSpecular[0]===e.colorSpecular[0]&&l.colorSpecular[1]===e.colorSpecular[1]&&l.colorSpecular[2]===e.colorSpecular[2]&&(void 0===l.url||-1!==e.textureId)&&(void 0!==l.url||-1===e.textureId)&&-1===e.textureId&&l.transparent===e.transparent&&l.shininess===e.shininess&&l.textureImageNumberComposante===e.textureImageNumberComposante&&l.textureBlending===e.textureBlending&&l.magFilter===e.magFilter&&l.minFilter===e.minFilter&&l.mappingFunction===e.mappingFunction&&l.textureWrapS===e.textureWrapS&&l.textureWrapT===e.textureWrapT&&l.addedComposantInTexEnv===e.addedComposantInTexEnv&&(!1!==l._pbr||!h)&&(!0!==l._pbr||h)&&(!l.mapping||e.mapping&&l.mapping.type===e.mapping.type&&l.mapping.ObjectTransformation===e.mapping.ObjectTransformation&&l.mapping.UvTransformation===e.mapping.UvTransformation))return s.threejs_mat;return(s=this.createMaterial(e,t,r,n,null,a))&&(s._source=i.AssetSource.MATERIAL_MANAGER),s},getMaterial3DXML:function(e,t,r,n,a){var s,o,l,c=!!i._CATGraphicalAsPBR;for(o=0;o<this.materials.length;o++)if("material3DXML"===(l=(s=this.materials[o]).params).type&&l.shading===e.shading&&l.reflectivityCoef===e.reflectivityCoef&&l.shininess===e.shininess&&l.specularCoef===e.specularCoef&&l.WrappingModeU===e.WrappingModeU&&l.WrappingModeV===e.WrappingModeV&&l.FlipU===e.FlipU&&l.FlipV===e.FlipV&&l.transparency===e.transparency&&l.transparent===e.transparent&&l.alphaTest===e.alphaTest&&l.mappingFunction===e.mappingFunction&&l.MappingType===e.MappingType&&l.TextureDimension===e.TextureDimension&&l.TextureFunction===e.TextureFunction&&l.DiffuseMap===e.DiffuseMap&&l.DiffuseMapRepeat[0]===e.DiffuseMapRepeat[0]&&l.DiffuseMapRepeat[1]===e.DiffuseMapRepeat[1]&&l.DiffuseMapWrap[0]===e.DiffuseMapWrap[0]&&l.DiffuseMapWrap[1]===e.DiffuseMapWrap[1]&&l.colorAmbient[0]===e.colorAmbient[0]&&l.colorAmbient[1]===e.colorAmbient[1]&&l.colorAmbient[2]===e.colorAmbient[2]&&l.colorDiffuse[0]===e.colorDiffuse[0]&&l.colorDiffuse[1]===e.colorDiffuse[1]&&l.colorDiffuse[2]===e.colorDiffuse[2]&&!(!l.colorSpecular&&e.colorSpecular||l.colorSpecular&&!e.colorSpecular)&&(!l.colorSpecular||!e.colorSpecular||l.colorSpecular[0]===e.colorSpecular[0]&&l.colorSpecular[1]===e.colorSpecular[1]&&l.colorSpecular[2]===e.colorSpecular[2])&&(!1!==l._pbr||!c)&&(!0!==l._pbr||c))return a&&(0===l.__nbTexturesToLoad?a(s.threejs_mat):(l.__cbLoadedImages||(l.__cbLoadedImages=[]),l.__cbLoadedImages.push(a))),s.threejs_mat;return(s=this.createMaterial(e,t,r,null,a))._source=i.AssetSource.MATERIAL_MANAGER,s},getTexture:function(e){this._currentMatHasTexture=!0;var t,r,n,a,s=[];if(e.offset||(e.offset=[0,0]),e.repeat||(e.repeat=[1,1]),e.wrap&&!e.overrideWrap||(e.resources&&e.resources.wrap?e.wrap=e.resources.wrap:e.wrap||(e.wrap=[1,1])),e.filter||(e.resources&&e.resources.filter?e.filter=e.resources.filter:e.filter=[5,1]),void 0!==e.resourceId&&this.textures[e.resourceId]&&(s=this.textures[e.resourceId]),s.length){for(n=0;n<s.length;n++)if(a=t=s[n],r=t.params,e.texturePoint===r.texturePoint)return e.offset[0]!==r.offset[0]||e.offset[1]!==r.offset[1]||e.repeat[0]!==r.repeat[0]||e.repeat[1]!==r.repeat[1]||e.wrap[0]!==r.wrap[0]||e.wrap[1]!==r.wrap[1]||e.filter[0]!==r.filter[0]||(e.filter[1],r.filter[1]),t.threejs_texture;switch((t=a.threejs_texture.clone()).offset.set(e.offset[0],e.offset[1]),t.repeat.set(e.repeat[0],e.repeat[1]),1===e.wrap[0]||"repeat"==e.wrap[0]?t.wrapS=i.RepeatWrapping:t.wrapS=i.ClampToEdgeWrapping,1===e.wrap[1]||"repeat"==e.wrap[0]?t.wrapT=i.RepeatWrapping:t.wrapT=i.ClampToEdgeWrapping,e.filter[0]){case 0:t.min=i.NearestFilter;break;case 1:t.min=i.LinearFilter;break;case 2:t.min=i.NearestMipMapNearestFilter;break;case 3:t.min=i.NearestMipMapLinearFilter;break;case 4:t.min=i.LinearMipMapNearestFilter;break;case 5:t.min=i.LinearMipMapLinearFilter}switch(e.filter[1]){case 0:t.mag=i.NearestFilter;break;case 1:t.mag=i.LinearFilter;break;case 2:t.mag=i.NearestMipMapNearestFilter;break;case 3:t.mag=i.NearestMipMapLinearFilter;break;case 4:t.mag=i.LinearMipMapNearestFilter;break;case 5:t.mag=i.LinearMipMapLinearFilter}var o={offset:e.offset,repeat:e.repeat,wrap:e.wrap,filter:e.filter,texturePoint:e.texturePoint};return this.textures[e.resourceId]=[{params:o,threejs_texture:t}],t._source=i.AssetSource.MATERIAL_MANAGER,t}if(t=this.createTexture(e),void 0!==e.resourceId){o={offset:e.offset,repeat:e.repeat,wrap:e.wrap,filter:e.filter,texturePoint:e.texturePoint};this.textures[e.resourceId]=[{params:o,threejs_texture:t}]}return t._source=i.AssetSource.MATERIAL_MANAGER,t},createMaterial:function(e,r,n,l,c,d){function f(){return Y}function m(e){return(255*e[0]<<16)+(255*e[1]<<8)+255*e[2]}this._currentMatHasTexture=!1,e.__nbTexturesToLoad=0,e.__cbLoadedImages=[],c&&e.__cbLoadedImages.push(c);var g="MeshPhongMaterial",v={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,blending:i.NormalBlending,side:i.DoubleSide};if(e.physicalMaterial){var S={},_=e.physicalMaterial.PhysicalMaterial,y=i.PhysicalMaterial;if(_.isVisDescription){var x=this,M="Visu.DSPBR@21x"===_.type,P="Visu.EVisuPBR"===_.type,C="Visu.DSPBR@22x"===_.type,b="Visu.DSPBR@23x"===_.type,D="Visu.SpecularGlossiness@21x"===_.type||P||M||C||b,w=e.mapping&&e.mapping.type||D,E=function(e,t,r){var n=null;r&&(n=r);var a=_[t];if(a&&(n=a),n){var s=new i.Matrix3;s.set(n[0],n[2],n[4],n[1],n[3],n[5],0,0,1),S[e]=s.isIdentity()?u:s}},T=function(e,t,r,n){var a=_[t];if(void 0!==a){if(a.length)return S[e]=new i.Color,void S[e].setRGB(a[0],a[1],a[2]);if(void 0!==a.MADCoefficients){var s=a.MADCoefficients;S[e+"MulCoef"]=new i.Vector3(s[0],s[1],s[2]),S[e+"AddCoef"]=new i.Vector3(s[3],s[4],s[5])}void 0!==a.value?(S[e]=new i.Color,S[e].setRGB(a.value[0],a.value[1],a.value[2])):void 0!==a.texture&&n?(S[e+"Map"]=x.getTexture({wrap:I,overrideWrap:!0,type:"data",resources:l[a.texture],resourceId:a.texture}),w&&E(e+"UvTransform",t+"UvTransform",l[a.texture].uvTransform)):null!==r&&(S[e]=new i.Color,S[e].setRGB(r.x,r.y,r.z))}else null!==r&&(S[e]=new i.Color,S[e].setRGB(r.x,r.y,r.z))},A=function(e,t,i,r){var n=_[t];if(void 0!==n){if("object"!=typeof n)return void(S[e]=n);if(void 0!==n.MADCoefficients){var a=n.MADCoefficients;S[e+"MulCoef"]=a[0],S[e+"AddCoef"]=a[1]}void 0!==n.value?S[e]=n.value:void 0!==n.texture&&r?(S[e+"Map"]=x.getTexture({wrap:I,overrideWrap:!0,type:"data",resources:l[n.texture],resourceId:n.texture}),S.transparent=S.transparent||"opacity"===e||"transparency"===e,w&&E(e+"UvTransform",t+"UvTransform",l[n.texture].uvTransform)):null!==i&&(S[e]=i)}else null!==i&&(S[e]=i)};if("Visu.SpecularGlossiness"===_.type||"Visu.SpecularGlossiness@21x"===_.type){var I=[0,0];_.RepeatU&&(I[0]=1),_.RepeatV&&(I[1]=1)}else I=null;var R=_.diffuse||_.albedo;if(R){if(R.MADCoefficients){var L=R.MADCoefficients;S.diffuseMulCoef=new i.Vector3(L[0],L[1],L[2]),S.diffuseAddCoef=new i.Vector3(L[3],L[4],L[5])}R.value?(S.color=new i.Color,S.color.setRGB(R.value[0],R.value[1],R.value[2])):null!=R.texture&&(S.map=this.getTexture({wrap:I,overrideWrap:!0,type:"data",resources:l[R.texture],resourceId:R.texture}),w&&E("diffuseUvTransform","diffuseUvTransform",l[R.texture].uvTransform))}if(P||M||C||b){y=i.DSPBR19xMaterial;var O=function(e,t){var r=_[t];if(void 0!==r){if(void 0!==r.MADCoefficients){var n=r.MADCoefficients;S[e+"MulCoef"]=new i.Vector3(n[0],n[1],n[2]),S[e+"AddCoef"]=new i.Vector3(n[3],n[4],n[5])}void 0!==r.texture&&(S[e+"Map"]=x.getTexture({wrap:I,overrideWrap:!0,type:"data",resources:l[r.texture],resourceId:r.texture}),E(e+"UvTransform",e+"UvTransform",l[r.texture].uvTransform))}};A("metalness","metallic",0,!0),A("roughness","roughness",0,!0),A("anisotropyAngle","anisotropyRotation",0,!0),O("normal","normal"),A("opacity","cutoutOpacity",1,!0),A("thickness","thickness",0,!0),P||(A("translucency","translucency",0,!0),O("displacement","displacement"),A("subsurfaceAnisotropy","subsurfaceAnisotropy",0,!1),M?(y=i.DSPBR21xMaterial,T("sheenColor","sheenColor",new i.Vector3(1,1,1),!0),A("sheenRoughness","sheenRoughness",.3,!0)):(y=i.DSPBR22xMaterial,T("sheenColor","sheenColor",new i.Vector3(0,0,0),!0),A("sheenRoughness","sheenRoughness",.5,!0),T("flipFlopColor","flipFlopColor",new i.Vector3(1,1,1),!0),A("flipFlop","flipFlop",0,!0),void 0!==_.subtype&&(S._subtype=i.DSPBRSubTypes[o[_.subtype]]),b&&(y=i.DSPBR23xMaterial,T("translucencyColor","translucencyColor",new i.Vector3(0,0,0),!0),A("iridescence","iridescence",0,!0),A("iridescenceThickness","iridescenceThickness",1,!0),A("iridescenceIoR","iridescenceIoR",1.5,!1)))),(P||M)&&A("sheen","sheen",0,!0),A("specularContrib","specular",1,!0),T("specular","specularTint",new i.Vector3(1,1,1),!0),T("flakesColor","flakeColor",new i.Vector3(1,1,1),!0),A("flakesCoverage","flakeCoverage",0,!0),A("flakesCoverage","flakeDensity",null,!0),A("flakesSize","flakeSize",.5,!0),A("flakesRoughness","flakeRoughness",0,!0),A("clearCoat","clearcoat",0,!0),O("clearCoatNormal","clearcoatNormal"),A("clearCoatRoughness","clearcoatRoughness",0,!0),A("orangePeel","orangePeel",!1,!1),A("orangePeelScale","orangePeelScale",0,!1),T("emissionColor","emissionColor",new i.Vector3(1,1,1),!0),A("emissionValue","emissionValue",0,!1),A("emissionNormalized","emissionEnergyNormalization",!1,!1),A("thinWalled","thinWalled",!1,!1),A("ior","ior",1.5,!1),T("attenuationColor","attenuationColor",new i.Vector3(1,1,1),!1),T("subsurfaceColor","subsurfaceColor",new i.Vector3(0,0,0),!1),A("attenuationDistance","attenuationDistance",1e8,!1),_.cutoutFromAlbedoAlpha||_.UseAlphaDiffuseChannel?(S.transparent=!0,S.useAlphaFromDiffuseMap=!0):S.useAlphaFromDiffuseMap=!1}else{S.specGlossNRE=!0;O=function(e,t){var i=_[t+"Map"];void 0!==i&&(S[e+"Map"]=x.getTexture({wrap:I,overrideWrap:!0,type:"data",resources:l[i.texture],resourceId:i.texture}),w&&E(e+"UvTransform",t+"MapUvTransform",l[i.texture].uvTransform))};T("specular","fresnelCoefficient",new i.Vector3(.04,.04,.04),!0),T("emissionColor","emissive",new i.Vector3(0,0,0),!0),S.emissionValue=1,T("flakesColor","flakesColor",new i.Vector3(0,0,0),!1),S.flakesColorMulCoef=new i.Vector3(.12,.12,.12),S.flakesColorAddCoef=new i.Vector3(0,0,0),T("pearlFlakesColor","pearlFlakesColor",new i.Vector3(0,0,0),!1),S.pearlFlakesColorMulCoef=new i.Vector3(.08,.08,.08),S.pearlFlakesColorAddCoef=new i.Vector3(0,0,0),T("clearCoatColor","coatingFresnelCoefficient",new i.Vector3(.04,.04,.04),!0),A("glossiness","glossiness",1,!0),A("opacity","opacity",1,!0),A("anisotropyAngle","anisotropyAngle",0,!0),A("clearCoat","Coating",0,!1),function(e,t,r,n){var a=_[t];if(void 0!==a){if(void 0!==a.MADCoefficients){var s=a.MADCoefficients;S[e+"MulCoef"]=s[0],S[e+"AddCoef"]=s[1]}void 0!==a.value?S[e]=new i.Vector2(a.value,a.value):void 0!==a.texture&&n?(S[e+"Map"]=x.getTexture({wrap:I,overrideWrap:!0,type:"data",resources:l[a.texture],resourceId:a.texture}),w&&E(e+"UvTransform",t+"UvTransform",l[a.texture].uvTransform)):null!==r&&(S[e]=r)}else null!==r&&(S[e]=r)}("normalScale","bumpScale",new i.Vector2(1,1),!0),A("coatingGlossiness","coatingGlossiness",1,!1),A("clearCoatNormalScale","coatingBump",0,!1),A("orangePeel","ProceduralCoating",!1,!1),A("orangePeelScale","coatingScale",1,!1),A("flakes","Flakes",!1,!1),A("flakesDensity","flakesDensity",0,!0),A("flakesBump","flakesBump",1,!1),A("flakesScale","flakesScale",.5,!1),A("flakesRoughness","flakesRoughness",.25,!1),A("pearlFlakesBump","pearlFlakesBump",1,!1),A("pearlFlakesDensity","pearlFlakesDensity",1,!1),O("normal","normal"),_.NormalMapConventionPositiveY?S.normalMapFlipY=!0:S.normalMapFlipY=!1,O("clearCoatNormal","coatingNormal"),_.CoatingNormalMapConventionPositiveY?S.clearCoatNormalMapFlipY=!0:S.clearCoatNormalMapFlipY=!1,A("displacement","displacement",0,!0);var N=_.displacement;if(void 0!==N&&void 0!==N.MADCoefficients){L=N.MADCoefficients;S.displacementScale=L[0],S.displacementBias=L[1]}_.UseAlphaDiffuseChannel?(S.transparent=!0,S.useAlphaFromDiffuseMap=!0):S.useAlphaFromDiffuseMap=!1}A("anisotropy","anisotropy",0,!0),A("anisotropyAngle","anisotropyAngle",0,!0),A("transparency","transparency",0,!0),(1==S.opacity&&S.transparency>0||S.opacityMap)&&(S.transparent=!0),_.IsAlphaTestEnabled&&(S.transparent=!1,S.alphaTest=.5)}else{S.specGlossNRE=!0;var F=_.MappingOperator.Type;if("None"!=F&&(S.mappingUseFragment=!0,S.mappingObjTransformation=new i.Matrix4,S.mappingObjTransformation.elements=_.MappingOperator.ObjectTransformation,"Planar"==F?S.mappingType=1:"Spherical"==F?S.mappingType=2:"Spherical Normalized"==F?S.mappingType=2:"Cubic"==F?S.mappingType=3:"FiniteCylindrical"==F?S.mappingType=4:"InfiniteCylindrical"==F?S.mappingType=5:"InfiniteCylindrical Normalized"==F&&(S.mappingType=5)),S.mappingUVTransformation=new i.Matrix3,S.mappingUVTransformation.elements=_.MappingOperator.UvTransformation,_.Float3Parameter){var V=_.Float3Parameter;if(V.diffuse){L=V.diffuse.MADCoefficients;if(0==V.diffuse.AsTexture)S.color=new i.Color,S.color.setRGB(V.diffuse.Value[0],V.diffuse.Value[1],V.diffuse.Value[2]),S.diffuseMulCoef=new i.Vector3(L[0],L[1],L[2]),S.diffuseAddCoef=new i.Vector3(L[3],L[4],L[5]);else{I=[0,0];if("eRepeat"==V.diffuse.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==V.diffuse.Sampling.TexCoordVWrap&&(I[1]=1),V.diffuse.UvTransform&&"None"!=F){var U=V.diffuse.UvTransform;S.diffuseUvTransform=new i.Matrix3(U[0],U[4],U[8],U[1],U[5],U[9],U[2],U[6],U[10])}S.diffuseMulCoef=new i.Vector3(L[0],L[1],L[2]),S.diffuseAddCoef=new i.Vector3(L[3],L[4],L[5]),S.map=this.getTexture({wrap:I,type:"data",resources:l[V.diffuse.Texture],resourceId:V.diffuse.Texture})}}if(V.fresnelCoefficient){L=V.fresnelCoefficient.MADCoefficients;if(0==V.fresnelCoefficient.AsTexture)S.specular=new i.Color,S.specular.setRGB(V.fresnelCoefficient.Value[0],V.fresnelCoefficient.Value[1],V.fresnelCoefficient.Value[2]),S.specularMulCoef=new i.Vector3(L[0],L[1],L[2]),S.specularAddCoef=new i.Vector3(L[3],L[4],L[5]);else{I=[0,0];if("eRepeat"==V.fresnelCoefficient.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==V.fresnelCoefficient.Sampling.TexCoordVWrap&&(I[1]=1),V.fresnelCoefficient.UvTransform&&"None"!=F){var B=V.fresnelCoefficient.UvTransform;S.specularUvTransform=new i.Matrix3(B[0],B[4],B[8],B[1],B[5],B[9],B[2],B[6],B[10])}S.specularMulCoef=new i.Vector3(L[0],L[1],L[2]),S.specularAddCoef=new i.Vector3(L[3],L[4],L[5]),S.specularMap=this.getTexture({wrap:I,type:"data",resources:l[V.fresnelCoefficient.Texture],resourceId:V.fresnelCoefficient.Texture})}}if(V.emissive){L=V.emissive.MADCoefficients;if(0==V.emissive.AsTexture)S.emissive=new i.Color,S.emissive.setRGB(V.emissive.Value[0],V.emissive.Value[1],V.emissive.Value[2]),S.emissiveMulCoef=new i.Vector3(L[0],L[1],L[2]),S.emissiveAddCoef=new i.Vector3(L[3],L[4],L[5]);else{S.emissive=new i.Color,S.emissive.setRGB(1,1,1);I=[0,0];if("eRepeat"==V.emissive.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==V.emissive.Sampling.TexCoordVWrap&&(I[1]=1),V.emissive.UvTransform&&"None"!=F){var k=V.emissive.UvTransform;S.emissiveUvTransform=new i.Matrix3(k[0],k[4],k[8],k[1],k[5],k[9],k[2],k[6],k[10])}S.emissiveMulCoef=new i.Vector3(L[0],L[1],L[2]),S.emissiveAddCoef=new i.Vector3(L[3],L[4],L[5]),S.emissiveMap=this.getTexture({wrap:I,type:"data",resources:l[V.emissive.Texture],resourceId:V.emissive.Texture})}}if(V.coatingFresnelCoefficient&&!1===V.coatingFresnelCoefficient.AsTexture&&(S.coatingSpecularColor=new i.Color,S.coatingSpecularColor.setRGB(V.coatingFresnelCoefficient.Value[0],V.coatingFresnelCoefficient.Value[1],V.coatingFresnelCoefficient.Value[2])),V.flakesColor){L=V.flakesColor.MADCoefficients;!1===V.flakesColor.AsTexture&&(S.flakesColor=new i.Color,S.flakesColor.setRGB(V.flakesColor.Value[0],V.flakesColor.Value[1],V.flakesColor.Value[2]),S.flakesColorMulCoef=new i.Vector3(L[0],L[1],L[2]),S.flakesColorAddCoef=new i.Vector3(L[3],L[4],L[5]))}if(V.pearlFlakesColor){L=V.pearlFlakesColor.MADCoefficients;!1===V.pearlFlakesColor.AsTexture&&(S.pearlFlakesColor=new i.Color,S.pearlFlakesColor.setRGB(V.pearlFlakesColor.Value[0],V.pearlFlakesColor.Value[1],V.pearlFlakesColor.Value[2]),S.pearlFlakesColorMulCoef=new i.Vector3(L[0],L[1],L[2]),S.pearlFlakesColorAddCoef=new i.Vector3(L[3],L[4],L[5]))}}if(_.FloatParameter){var G=_.FloatParameter;if(G.glossiness){L=G.glossiness.MADCoefficients;if(0==G.glossiness.AsTexture)S.glossiness=G.glossiness.Value,S.glossinessMulCoef=L[0],S.glossinessAddCoef=L[1];else{I=[0,0];if("eRepeat"==G.glossiness.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==G.glossiness.Sampling.TexCoordVWrap&&(I[1]=1),G.glossiness.UvTransform&&"None"!=F){var z=G.glossiness.UvTransform;S.glossinessUvTransform=new i.Matrix3(z[0],z[4],z[8],z[1],z[5],z[9],z[2],z[6],z[10])}S.glossinessMulCoef=L[0],S.glossinessAddCoef=L[1],S.glossinessMap=this.getTexture({wrap:I,type:"data",resources:l[G.glossiness.Texture],resourceId:G.glossiness.Texture})}}if(G.bumpScale){L=G.bumpScale.MADCoefficients;if(0==G.bumpScale.AsTexture){var H=G.bumpScale.Value;S.normalScale=new i.Vector2(H,H),S.normalScaleMulCoef=L[0],S.normalScaleAddCoef=L[1]}}if(G.opacity){L=G.opacity.MADCoefficients;if(0==G.opacity.AsTexture)S.opacity=G.opacity.Value,S.opacityMulCoef=L[0],S.opacityAddCoef=L[1];else{I=[0,0];if("eRepeat"==G.opacity.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==G.opacity.Sampling.TexCoordVWrap&&(I[1]=1),G.opacity.UvTransform&&"None"!=F){var W=G.opacity.UvTransform;S.opacityUvTransform=new i.Matrix3(W[0],W[4],W[8],W[1],W[5],W[9],W[2],W[6],W[10])}S.opacityMulCoef=L[0],S.opacityAddCoef=L[1],S.opacityMap=this.getTexture({wrap:I,type:"data",resources:l[G.opacity.Texture],resourceId:_.MapParameter.normalMap.Texture})}}if(G.transparency){L=G.transparency.MADCoefficients;0==G.transparency.AsTexture&&(S.transparency=G.transparency.Value,S.transparencyMulCoef=L[0],S.transparencyAddCoef=L[1])}if(G.anisotropy){L=G.anisotropy.MADCoefficients;if(0==G.anisotropy.AsTexture)S.anisotropy=G.anisotropy.Value,S.anisotropyMulCoef=L[0],S.anisotropyAddCoef=L[1];else{I=[0,0];if("eRepeat"==G.anisotropy.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==G.anisotropy.Sampling.TexCoordVWrap&&(I[1]=1),G.anisotropy.UvTransform&&"None"!=F){var j=G.anisotropy.UvTransform;S.anisotropyUvTransform=new i.Matrix3(j[0],j[4],j[8],j[1],j[5],j[9],j[2],j[6],j[10])}S.anisotropyMulCoef=L[0],S.anisotropyAddCoef=L[1],S.anisotropyMap=this.getTexture({wrap:I,type:"data",resources:l[G.anisotropy.Texture],resourceId:G.anisotropy.Texture})}}if(G.anisotropyAngle)if(0==G.anisotropyAngle.AsTexture){L=G.anisotropyAngle.MADCoefficients;S.anisotropyAngle=G.anisotropyAngle.Value,S.anisotropyAngleMulCoef=L[0],S.anisotropyAngleAddCoef=L[1]}else{I=[0,0];if("eRepeat"==G.anisotropyAngle.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==G.anisotropyAngle.Sampling.TexCoordVWrap&&(I[1]=1),G.anisotropyAngle.UvTransform&&"None"!=F){var X=G.anisotropyAngle.UvTransform;S.anisotropyAngleUvTransform=new i.Matrix3(X[0],X[4],X[8],X[1],X[5],X[9],X[2],X[6],X[10])}S.anisotropyAngleMulCoef=L[0],S.anisotropyAngleAddCoef=L[1],S.anisotropyAngleMap=this.getTexture({wrap:I,type:"data",resources:l[G.anisotropyAngle.Texture],resourceId:G.anisotropyAngle.Texture})}if(G.coatingGlossiness){L=G.coatingGlossiness.MADCoefficients;if(!1===G.coatingGlossiness.AsTexture){H=L[1]+G.coatingGlossiness.Value*L[0];S.coatingGlossiness=H}else{I=[0,0];if("eRepeat"==G.coatingGlossiness.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==G.coatingGlossiness.Sampling.TexCoordVWrap&&(I[1]=1),G.coatingGlossiness.UvTransform&&"None"!=F){var q=G.coatingGlossiness.UvTransform;S.coatingGlossinessUvTransform=new i.Matrix3(q[0],q[4],q[8],q[1],q[5],q[9],q[2],q[6],q[10])}S.coatingGlossinessMulCoef=L[0],S.coatingGlossinessAddCoef=L[1],S.coatingGlossinessMap=this.getTexture({wrap:I,type:"data",resources:l[G.coatingGlossiness.Texture],resourceId:G.coatingGlossiness.Texture})}}if(G.coatingBump){L=G.coatingBump.MADCoefficients;if(!1===G.coatingBump.AsTexture){H=L[1]+G.coatingBump.Value*L[0];S.clearCoatNormalScale=H}}if(G.coatingScale){L=G.coatingScale.MADCoefficients;if(!1===G.coatingScale.AsTexture){H=L[1]+G.coatingScale.Value*L[0];S.orangePeelScale=H}}if(G.flakesBump){L=G.flakesBump.MADCoefficients;if(!1===G.flakesBump.AsTexture){H=L[1]+G.flakesBump.Value*L[0];S.flakesBump=H}}if(G.flakesDensity){L=G.flakesDensity.MADCoefficients;if(!1===G.flakesDensity.AsTexture){H=L[1]+G.flakesDensity.Value*L[0];S.flakesDensity=H}}if(G.flakesScale){L=G.flakesScale.MADCoefficients;if(!1===G.flakesScale.AsTexture){H=L[1]+G.flakesScale.Value*L[0];S.flakesScale=H}}if(G.flakesRoughness){L=G.flakesRoughness.MADCoefficients;if(!1===G.flakesRoughness.AsTexture){H=L[1]+G.flakesRoughness.Value*L[0];S.flakesRoughness=H}}if(G.pearlFlakesBump){L=G.pearlFlakesBump.MADCoefficients;if(!1===G.pearlFlakesBump.AsTexture){H=L[1]+G.pearlFlakesBump.Value*L[0];S.pearlFlakesBump=H}}if(G.pearlFlakesDensity){L=G.pearlFlakesDensity.MADCoefficients;if(!1===G.pearlFlakesDensity.AsTexture){H=L[1]+G.pearlFlakesDensity.Value*L[0];S.pearlFlakesDensity=H}}}if(S.useAlphaFromDiffuseMap=!1,"eDiffuseChannel"==_.AlphaMode?(S.transparent=!0,S.useAlphaFromDiffuseMap=!0):(1==S.opacity&&S.transparency>0||S.opacityMap)&&(S.transparent=!0),1==_.AlphaTest&&(S.transparent=!1,S.alphaTest=.5),!0===_.Coating&&(S.coating=1),!0===_.ProceduralCoating&&(S.orangePeel=!0),!0===_.Flakes&&(S.flakes=!0),_.NormalMap&&1==_.NormalMap.UseNormalMap&&(S.normalMap=this.getTexture({type:"data",resources:l[_.NormalMap.Texture],resourceId:_.NormalMap.Texture})),_.MapParameter&&_.MapParameter.normalMap&&1==_.MapParameter.normalMap.Enabled){if(S.normalMap=this.getTexture({type:"data",resources:l[_.MapParameter.normalMap.Texture],resourceId:_.MapParameter.normalMap.Texture}),_.MapParameter.normalMap.UvTransform&&"None"!=F){var Z=_.MapParameter.normalMap.UvTransform;S.normalUvTransform=new i.Matrix3(Z[0],Z[4],Z[8],Z[1],Z[5],Z[9],Z[2],Z[6],Z[10])}"PositiveY"!=_.NormalMapConvention?S.normalMapFlipY=!1:S.normalMapFlipY=!0}if(_.MapParameter&&_.MapParameter.coatingBumpMap&&1==_.MapParameter.coatingBumpMap.Enabled){if(S.clearCoatNormalMap=this.getTexture({type:"data",resources:l[_.MapParameter.coatingBumpMap.Texture],resourceId:_.MapParameter.coatingBumpMap.Texture}),_.MapParameter.coatingBumpMap.UvTransform&&"None"!=F){Z=_.MapParameter.coatingBumpMap.UvTransform;S.clearCoatNormalUvTransform=new i.Matrix3(Z[0],Z[4],Z[8],Z[1],Z[5],Z[9],Z[2],Z[6],Z[10])}"PositiveY"!=_.CoatingBumpMapConvention?S.clearCoatNormalMapFlipY=!1:S.clearCoatNormalMapFlipY=!0}}S.NRECompatibility=!0;var Y=new y(S);return this.extractMaterialApplicationMappingInfos(e.mapping,Y),Y}if(e.shaderMaterial)return e.shaderMaterial.PDSFX?(Y=function(e,t,r,n,a){var s=0,o=e.param;for(s in o){var l=o[s].imgId;void 0!==l&&(t[l]&&t[l].url&&(o[s].url=t[l].url),o[s].map=r.getTexture({type:"data",resources:t[l],resourceId:l}),r.resources[l]=o[s].map)}var c={name:e.name,parameters:e.param,material:null},h=localStorage.getItem("A2XPDSFXConvention"),u="DS/Shaders/"+e.name;return h&&(u="DS/"+e.name+"/"+e.name),require([u],function(t){if(a.material=i.MaterialUtils.createShinyFaceMaterial(),t(a.material,e.param),a.material&&(a.material.needsUpdate=!0),a.geometry&&a.geometry.meshList)for(var r=0;r<a.geometry.meshList.length;r++)a.geometry.meshList[r]._flagAsGSSOInvalidated()}),r._modelEvent.publish({event:"PDSFXMaterial",data:c}),c.material?c.material:null}(e.shaderMaterial,l,this,e.transparent,d))||null:Y=function(e,r,n,o){if(null!=e){var l=e.param,c=0;null!=l.transparency_multiply_blend&&(c=l.transparency_multiply_blend);var h,u=t.getWebappsAssetUrl("Visualization","");switch(null==p&&(p=a(d=[u+"studio_pure_white_Specular_Map/posx.jpg",u+"studio_pure_white_Specular_Map/negx.jpg",u+"studio_pure_white_Specular_Map/posy.jpg",u+"studio_pure_white_Specular_Map/negy.jpg",u+"studio_pure_white_Specular_Map/posz.jpg",u+"studio_pure_white_Specular_Map/negz.jpg"])),e.name){case"MPM_basic":case"MPM_material":case"MPM_colored_glass":case"MPM_diffuse":case"MPM_soft_plastic":case"MPM_polished_plastic":case"MPM_clear_glass":case"MPM_frosted_glass":case"MPM_diamond":case"MPM_satinated_metal":case"MPM_anisotropic_metal":case"MPM_polished_metal":case"MPM_emissive":var d=[(u=t.getWebappsAssetUrl("Visualization",""))+"studio_pure_white_Diffuse_Map/posx.jpg",u+"studio_pure_white_Diffuse_Map/negx.jpg",u+"studio_pure_white_Diffuse_Map/posy.jpg",u+"studio_pure_white_Diffuse_Map/negy.jpg",u+"studio_pure_white_Diffuse_Map/posz.jpg",u+"studio_pure_white_Diffuse_Map/negz.jpg"],f=l.mapping_world_to_object_position_1st_column,m=l.mapping_world_to_object_position_2nd_column,g=l.mapping_world_to_object_position_3rd_column,v=l.mapping_world_to_object_position_4th_column,S=new i.Matrix4(f[0],f[1],f[2],f[3],m[0],m[1],m[2],m[3],g[0],g[1],g[2],g[3],v[0],v[1],v[2],v[3]);(new i.Matrix4).getInverse(S),a(d);var _={};!function(e,i,r,n){var a=t.getWebappsAssetUrl("Visualization",""),o=s(a+"default_white_color.png"),l=s(a+"slot_normal_default.jpg"),c=s(a+"slot_specular_anisotropy_direction_default.jpg");e.AmbientOcclusion2D&&"slot_ambient_occlusion_default.tif"==e.AmbientOcclusion2D.url?r.AmbientOcclusion2D=o:r.AmbientOcclusion2D=n.getTexture({type:"data",resources:i[e.AmbientOcclusion2D.imgId],resourceId:e.AmbientOcclusion2D.imgId}),e.Clarity2D&&"slot_clarity_default.tif"==e.Clarity2D.url?r.Clarity2D=o:r.Clarity2D=n.getTexture({type:"data",resources:i[e.Clarity2D.imgId],resourceId:e.Clarity2D.imgId}),e.Diffuse2D&&"slot_diffuse_default.tif"==e.Diffuse2D.url?r.Diffuse2D=o:r.Diffuse2D=n.getTexture({type:"data",resources:i[e.Diffuse2D.imgId],resourceId:e.Diffuse2D.imgId,checkTransparency:!0}),e.Emissive2D&&"slot_emissive_default.tif"==e.Emissive2D.url?r.Emissive2D=o:r.Emissive2D=n.getTexture({type:"data",resources:i[e.Emissive2D.imgId],resourceId:e.Emissive2D.imgId}),e.Height2D&&"slot_displacement_default.tif"==e.Height2D.url?r.Height2D=o:r.Height2D=n.getTexture({type:"data",resources:i[e.Height2D.imgId],resourceId:e.Height2D.imgId}),e.Normal2D&&"slot_normal_default.tif"==e.Normal2D.url?r.Normal2D=l:r.Normal2D=n.getTexture({type:"data",resources:i[e.Height2D.imgId],resourceId:e.Height2D.imgId}),e.Specular2D&&"slot_specular_default.tif"==e.Specular2D.url?r.Specular2D=o:r.Specular2D=n.getTexture({type:"data",resources:i[e.Specular2D.imgId],resourceId:e.Specular2D.imgId}),e.SpecularAnisotropyDirection2D&&"slot_specular_anisotropy_direction_default.tif"==e.SpecularAnisotropyDirection2D.url?r.SpecularAnisotropyDirection2D=c:r.SpecularAnisotropyDirection2D=n.getTexture({type:"data",resources:i[e.SpecularAnisotropyDirection2D.imgId],resourceId:e.SpecularAnisotropyDirection2D.imgId}),e.SpecularGlossiness2D&&"slot_specular_glossiness_default.tif"==e.SpecularGlossiness2D.url?r.SpecularGlossiness2D=o:r.SpecularGlossiness2D=n.getTexture({type:"data",resources:i[e.SpecularGlossiness2D.imgId],resourceId:e.SpecularGlossiness2D.imgId}),e.Transparency2D&&"slot_transparency_default.tif"==e.Transparency2D.url?r.Transparency2D=o:r.Transparency2D=n.getTexture({type:"data",resources:i[e.Transparency2D.imgId],resourceId:e.Transparency2D.imgId})}(l,r,_,n),(w=new Array(3))[0]=l.default_generic_brdf_diffuse_color[0]*l.default_generic_brdf_diffuse_weight,w[1]=l.default_generic_brdf_diffuse_color[1]*l.default_generic_brdf_diffuse_weight,w[2]=l.default_generic_brdf_diffuse_color[2]*l.default_generic_brdf_diffuse_weight,w[0]+=l.default_generic_btdf_transparency_weight*l.default_vp_color[0],w[1]+=l.default_generic_btdf_transparency_weight*l.default_vp_color[1],w[2]+=l.default_generic_btdf_transparency_weight*l.default_vp_color[2],h=new i.DSPBR22xMaterial({needTangentBinormal:!0,diffuseMulCoef:(new i.Vector3).setFromArray(w),diffuseAddCoef:new i.Vector3(0,0,0),specularMulCoef:(new i.Vector3).setFromArray(l.default_generic_brdf_specular_color),specularAddCoef:new i.Vector3(0,0,0),emissionColorMulCoef:(new i.Vector3).setFromArray(l.default_generic_edf_diffuse_color),emissionColorAddCoef:new i.Vector3(0,0,0),opacity:l.default_sp_opacity,ior:l.default_generic_brdf_ior,roughness:1-l.default_generic_brdf_specular_glossiness,specularContrib:l.default_generic_brdf_specular_weight,anisotropy:l.default_generic_brdf_specular_anisotropy/Math.PI,anisotropyAngle:l.default_generic_brdf_specular_anisotropy_rotation/Math.PI,emissionValue:l.default_generic_edf_diffuse_weight,transparency:l.default_generic_btdf_transparency_weight,metalness:0,normalUvSlot:l.default_slot_normal,opacityUvSlot:l.default_slot_opacity,diffuseUvSlot:l.default_slot_diffuse_color,specularUvSlot:l.default_slot_specular_color,roughnessUvSlot:l.default_slot_specular_glossiness,anisotropyAngleUvSlot:l.default_slot_specular_anisotropy_direction,transparencyUvSlot:l.default_slot_transparency,emissionColorUvSlot:l.default_slot_emissive_color,thinWalled:!!l.thin_walled,map:_.Diffuse2D,emissionColorMap:_.Emissive2D,specularMap:_.Specular2D,roughnessMap:_.SpecularGlossiness2D,roughnessAddCoef:_.SpecularGlossiness2D?1:null,roughnessMulCoef:_.SpecularGlossiness2D?-1:null,anisotropyAngleMap:_.SpecularAnisotropyDirection2D,opacityMap:_.Opacity2D,transparent:_.Opacity2D||_.Transparency2D,mappingType:l.mapping_type,mappingUVTransformation:new i.Matrix3(l.mapping_scale_u,0,l.mapping_offset_u,0,l.mapping_scale_v,l.mapping_offset_v,0,0,1)});break;case"mia_phen_polished_metal":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:0,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(w=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,w[1]=l.diffuse?l.diffuse[1]:1,w[2]=l.diffuse?l.diffuse[2]:1,w[0]*=l.diffuse_weight,w[1]*=l.diffuse_weight,w[2]*=l.diffuse_weight,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,h=new i.DSPBR22xMaterial({color:new i.Color(w),specularContrib:l.reflectivity,specular:new i.Color(E),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,ior:null!=l.refr_ior?l.refr_ior:8,opacity:1-c});break;case"mia_phen_satinated_metal":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:0,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(w=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,w[1]=l.diffuse?l.diffuse[1]:1,w[2]=l.diffuse?l.diffuse[2]:1,w[0]*=l.diffuse_weight,w[1]*=l.diffuse_weight,w[2]*=l.diffuse_weight,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,h=new i.DSPBR22xMaterial({color:new i.Color(w),specularContrib:l.reflectivity,specular:new i.Color(E),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refl_gloss?l.refl_gloss:.25),ior:null!=l.refr_ior?l.refr_ior:8,opacity:1-c,needTangentBinormal:!0});break;case"mia_phen_anisotropic_metal":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:0,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(w=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,w[1]=l.diffuse?l.diffuse[1]:1,w[2]=l.diffuse?l.diffuse[2]:1,w[0]*=l.diffuse_weight,w[1]*=l.diffuse_weight,w[2]*=l.diffuse_weight,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,h=new i.DSPBR22xMaterial({color:new i.Color(w),specular:new i.Color(E),specularContrib:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refl_gloss?l.refl_gloss:.25),ior:null!=l.refr_ior?l.refr_ior:8,opacity:1-c,needTangentBinormal:!0,anisotropy:null!=l.anisotropy?l.anisotropy/Math.PI:.1,anisotropyAngle:null!=l.anisotropy_rotation?l.anisotropy_rotation/Math.PI:0});break;case"mia_phen_soft_plastic":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:.77,l.reflectivity=null!=l.reflectivity?l.reflectivity:.7,(w=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,w[1]=l.diffuse?l.diffuse[1]:1,w[2]=l.diffuse?l.diffuse[2]:1,w[0]*=l.diffuse_weight,w[1]*=l.diffuse_weight,w[2]*=l.diffuse_weight,(E=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,E[1]=l.refl_color?l.refl_color[1]:1,E[2]=l.refl_color?l.refl_color[2]:1,h=new i.DSPBR22xMaterial({color:new i.Color(w),specular:new i.Color(E),specularContrib:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refl_gloss?l.refl_gloss:.25),metalness:0,ior:null!=l.refr_ior?l.refr_ior:2,opacity:1-c,needTangentBinormal:!0});break;case"mia_phen_polished_plastic":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:.77,l.reflectivity=null!=l.reflectivity?l.reflectivity:.75,(w=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,w[1]=l.diffuse?l.diffuse[1]:1,w[2]=l.diffuse?l.diffuse[2]:1,w[0]*=l.diffuse_weight,w[1]*=l.diffuse_weight,w[2]*=l.diffuse_weight,(E=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,E[1]=l.refl_color?l.refl_color[1]:1,E[2]=l.refl_color?l.refl_color[2]:1,h=new i.DSPBR22xMaterial({color:new i.Color(w),specular:new i.Color(E),specularContrib:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,metalness:0,ior:null!=l.refr_ior?l.refr_ior:2,opacity:1-c,needTangentBinormal:!0});break;case"mia_phen_diffuse":(w=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,w[1]=l.diffuse?l.diffuse[1]:1,w[2]=l.diffuse?l.diffuse[2]:1,h=new i.DSPBR22xMaterial({color:new i.Color(w),specularContrib:0,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,metalness:0,opacity:1-c,needTangentBinormal:!0});break;case"mia_phen_frosted_glass":(w=new Array(3))[0]=l.refr_falloff_color?l.refr_falloff_color[0]:1,w[1]=l.refr_falloff_color?l.refr_falloff_color[1]:1,w[2]=l.refr_falloff_color?l.refr_falloff_color[2]:1,h=new i.DSPBR22xMaterial({color:new i.Color(w),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refr_gloss?l.refr_gloss:1),transparency:1,ior:null!=l.refr_ior?l.refr_ior:1.45,metalness:0,opacity:1-c,needTangentBinormal:!0});break;case"mia_phen_clear_glass":h=new i.DSPBR22xMaterial({color:new i.Color(8947848),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:0,transparency:1,ior:null!=l.refr_ior?l.refr_ior:1.45,metalness:0,opacity:1-c,needTangentBinormal:!0});break;case"mia_phen_colored_glass":l.reflectivity=null!=l.reflectivity?l.reflectivity:.66,(w=new Array(3))[0]=l.refr_falloff_color?l.refr_falloff_color[0]:1,w[1]=l.refr_falloff_color?l.refr_falloff_color[1]:1,w[2]=l.refr_falloff_color?l.refr_falloff_color[2]:1,h=new i.DSPBR22xMaterial({color:new i.Color(w),specularContrib:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refr_gloss?l.refr_gloss:1),transparency:1,ior:null!=l.refr_ior?l.refr_ior:1.45,metalness:0,opacity:1-c,needTangentBinormal:!0});break;case"diamond":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(w=new Array(3))[0]=l.refr_color?l.refr_color[0]:1,w[1]=l.refr_color?l.refr_color[1]:1,w[2]=l.refr_color?l.refr_color[2]:1,w[0]*=l.diffuse_weight,w[1]*=l.diffuse_weight,w[2]*=l.diffuse_weight,(E=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,E[1]=l.refl_color?l.refl_color[1]:1,E[2]=l.refl_color?l.refl_color[2]:1,h=new i.DSPBR22xMaterial({color:new i.Color(w),specular:new i.Color(E),specularContrib:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,metalness:0,transparency:.5,ior:null!=l.refr_ior?l.refr_ior:2.4,opacity:1-c,needTangentBinormal:!0});break;case"mia_phen_emissive":h=new i.DSPBR22xMaterial({color:new i.Color(0),specularContrib:0,emissionColor:new i.Color(null!=l.color?l.color:[1,1,1,1]),emissionValue:null!=l.intensity?l.intensity:1e3,opacity:1-c,needTangentBinormal:!0});break;case"CATIATemplateUseMapCubic":case"CATIATemplateUseMapSpheric":var y;y=n.getTexture({type:"data",resources:r[l.KdText.imgId],resourceId:l.KdText.imgId,checkTransparency:!0}),l.Kd=null!=l.Kd?l.Kd:1,l.KsShi=null!=l.KsShi?l.KsShi:.75,l.Ks=null!=l.Ks?l.Ks:.75,(w=new Array(3))[0]=l.KdColor?l.KdColor[0]:1,w[1]=l.KdColor?l.KdColor[1]:1,w[2]=l.KdColor?l.KdColor[2]:1,w[0]*=l.Kd,w[1]*=l.Kd,w[2]*=l.Kd,(E=new Array(3))[0]=l.KsColor?l.KsColor[0]:1,E[1]=l.KsColor?l.KsColor[1]:1,E[2]=l.KsColor?l.KsColor[2]:1,h=new i.DSPBR22xMaterial({diffuseMulCoef:(new i.Vector3).setFromArray(w),diffuseAddCoef:new i.Vector3,map:y,specular:new i.Color(E),specularContrib:l.Ks,roughness:l.KsShi,metalness:0,transparency:null!=l.Kt?l.Kt:0,ior:2+(null!=l.Kr?l.Kr:1),opacity:1-c,needTangentBinormal:!0});break;case"mia_phen_material":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:.77,l.reflectivity=null!=l.reflectivity?l.reflectivity:0;var x=null!=l.transparency?l.transparency:0;(w=new Array(3))[0]=(l.diffuse?l.diffuse[0]:1)*l.diffuse_weight*(1-x),w[1]=(l.diffuse?l.diffuse[1]:1)*l.diffuse_weight*(1-x),w[2]=(l.diffuse?l.diffuse[2]:1)*l.diffuse_weight*(1-x),w[0]+=(l.refr_color?l.refr_color[0]:1)*x,w[1]+=(l.refr_color?l.refr_color[1]:1)*x,w[2]+=(l.refr_color?l.refr_color[2]:1)*x,(E=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,E[1]=l.refl_color?l.refl_color[1]:1,E[2]=l.refl_color?l.refl_color[2]:1;var M=1-(null!=l.refl_gloss?l.refl_gloss:0),P=x*(1-(null!=l.refl_gloss?l.refr_gloss:1))+(1-x)*M;h=new i.DSPBR22xMaterial({color:new i.Color(w),specular:new i.Color(E),specularContrib:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:P,metalness:0,transparency:x,ior:null!=l.refr_ior?l.refr_ior:1.5,opacity:1-c,alphaTest:null!=l.cutout_opacity?l.cutout_opacity:1,anisotropy:null!=l.anisotropy?l.anisotropy/Math.PI:1,anisotropyAngle:null!=l.anisotropy_rotation?l.anisotropy_rotation/Math.PI:1,needTangentBinormal:!0});break;case"mia_phen_reflective_translucent":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.reflectivity=null!=l.reflectivity?l.reflectivity:0,x=null!=l.transparency?l.transparency:.8,(w=new Array(3))[0]=(l.diffuse?l.diffuse[0]:1)*l.diffuse_weight,w[1]=(l.diffuse?l.diffuse[1]:1)*l.diffuse_weight,w[2]=(l.diffuse?l.diffuse[2]:1)*l.diffuse_weight;var C=new Array(3);C[0]=l.refr_trans_color?l.refr_trans_color[0]:1,C[1]=l.refr_trans_color?l.refr_trans_color[1]:1,C[2]=l.refr_trans_color?l.refr_trans_color[2]:1,P=1-(null!=l.refl_gloss?l.refr_gloss:1),h=new i.DSPBR23xMaterial({color:new i.Color(w),translucency:null!=l.refr_trans_weight?l.refr_trans_weight:1,translucencyColor:new i.Color(C),specularContrib:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:P,metalness:0,transparency:x,ior:null!=l.refr_ior?l.refr_ior:1.3,opacity:1-c,needTangentBinormal:!0});break;case"mip_metallic_paint":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.spec_weight=null!=l.spec_weight?l.spec_weight:.2,P=(null!=l.spec_exp?l.spec_exp:60)/150;var b=null!=l.spec_sec_weight?l.spec_sec_weight:.25,D=(null!=l.spec_sec_exp?l.spec_sec_exp:25)/150;(w=new Array(3))[0]=(l.base_color?l.base_color[0]:0)*l.diffuse_weight,w[1]=(l.base_color?l.base_color[1]:1)*l.diffuse_weight,w[2]=(l.base_color?l.base_color[2]:0)*l.diffuse_weight,(E=new Array(3))[0]=l.spec?l.spec[0]:1,E[1]=l.spec?l.spec[1]:1,E[2]=l.spec?l.spec[2]:1,h=new i.DSPBR22xMaterial({color:new i.Color(w),specular:new i.Color(E),specularContrib:l.spec_weight,clearCoat:b,clearCoatRoughness:D,roughness:P,metalness:0,opacity:1-c,needTangentBinormal:!0});break;case"mip_car_paint":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.spec_weight=null!=l.spec_weight?l.spec_weight:.2,P=(null!=l.spec_exp?l.spec_exp:60)/150;var w,E,T=(null!=l.flake_exp?l.flake_exp:45)/150;(w=new Array(3))[0]=(l.base_color?l.base_color[0]:0)*l.diffuse_weight,w[1]=(l.base_color?l.base_color[1]:1)*l.diffuse_weight,w[2]=(l.base_color?l.base_color[2]:0)*l.diffuse_weight,(E=new Array(3))[0]=l.spec?l.spec[0]:1,E[1]=l.spec?l.spec[1]:1,E[2]=l.spec?l.spec[2]:1;var A=new Array(3);A[0]=l.flake_color?l.spec[0]:1,A[1]=l.flake_color?l.spec[1]:1,A[2]=l.flake_color?l.spec[2]:1,h=new i.DSPBR22xMaterial({color:new i.Color(w),specular:new i.Color(E),flakesColor:new i.Color(E),specularContrib:l.spec_weight,clearCoat:1,clearCoatRoughness:.05,roughness:P,flakesRoughness:T,flakesCoverage:null!=l.flake_density?l.flake_density:.5,flakesSize:null!=l.flake_scale?l.flake_scale:5,metalness:0,opacity:1-c,ior:null!=l.__incident_ior?l.__incident_ior:1,needTangentBinormal:!0});break;default:return i.MaterialUtils.createShinyFaceMaterial()}return h.force=!0,h.lights=!0,h._usePhongLighting=!0,h.uniforms&&h.uniforms.ReflectionCUBEMap&&(h.uniforms.ReflectionCUBEMap.value=p),void 0!==o&&0!==o&&(h.transparent=!0),h}return i.MaterialUtils.createShinyFaceMaterial()}(e.shaderMaterial,l,this,e.transparent);if(null===e)return i.MaterialUtils.createShinyFaceMaterial();void 0!==e.wireframe&&(v.wireframe=e.wireframe),void 0!==e.transparent&&(v.opacity=1-e.transparent,1!==v.opacity&&(v.transparent=!0));var K,J=i._CATGraphicalAsPBR;if(e.shading&&("Phong"===e.shading?g="MeshPhongMaterial":"Basic"===e.shading&&(J=!1,g="MeshBasicMaterial")),e.blending&&("Additive"===e.blending?v.blending=i.AdditiveBlending:"Subtractive"===e.blending?v.blending=i.SubtractiveBlending:"Multiply"===e.blending&&(v.blending=i.MultiplyBlending)),void 0!==e.depthTest&&(v.depthTest=e.depthTest),void 0!==e.vertexColors&&("face"===e.vertexColors?v.vertexColors=i.VertexColorType.Face:e.vertexColors&&(v.vertexColors=i.VertexColorType.RGBA)),e.colorDiffuse?void 0!==e.diffuseCoef?(K=[e.colorDiffuse[0]*e.diffuseCoef,e.colorDiffuse[1]*e.diffuseCoef,e.colorDiffuse[2]*e.diffuseCoef],v.color=m(K)):v.color=m(e.colorDiffuse):e.DbgColor&&(v.color=e.DbgColor),e.colorSpecular&&(void 0!==e.specularCoef?(K=[e.colorSpecular[0]*e.specularCoef,e.colorSpecular[1]*e.specularCoef,e.colorSpecular[2]*e.specularCoef],v.specular=m(K)):v.specular=m(e.colorSpecular)),e.colorAmbient&&(void 0!==e.ambientCoef?(K=[e.colorAmbient[0]*e.ambientCoef,e.colorAmbient[1]*e.ambientCoef,e.colorAmbient[2]*e.ambientCoef],v.ambient=m(K)):v.ambient=m(e.colorAmbient)),e.transparency&&(v.opacity=e.transparency,1!==v.opacity&&(v.transparent=!0)),e.shininess&&(v.shininess=e.shininess,J&&(v.shininess/="material3DXML"===e.type?128:255)),e.reflectivityCoef&&(v.reflectivity=e.reflectivityCoef),e.alphaTest&&(v.alphaTest=e.alphaTest),e.reflectivityCoef>.1&&void 0===e.ReflectionMap){if(null===h){var Q=s(t.getWebappsAssetUrl("Visualization","")+"defaultEnvMap.png",i.ImageUtils.crossOriginPolicy);Q.flipY=!0,Q.mapping=new i.SphericalReflectionMapping,h=Q}v.envMap=h,v.combine=i.MixOperation,v.perPixel=!0}var $=null;if(v.textureBlending=i.TextureBlendOperations.MODULATE,void 0!==e.textureId&&-1!==e.textureId)if(void 0!==e.textureBlending&&(v.textureBlending=e.textureBlending),"SPHERICAL_ENV_MAP"===e.mappingFunction)v.sphereMap=!0;else{v.map=this.getTexture({type:"data",resources:l[e.textureId],filter:[e.minFilter,e.magFilter],wrap:[e.textureWrapS,e.textureWrapT],resourceId:e.textureId,checkTransparency:!0}),v.map.transparent&&(v.transparent=!0,v.alphaTest=1e-4);var ee=l[e.textureId].uvTransform;ee&&($=new i.Matrix3).set(ee[0],ee[1],ee[4],ee[2],ee[3],ee[5],0,0,1)}if(e.DiffuseMap&&r&&(v.map=this.getTexture({type:"url",sourceFile:e.DiffuseMap,texturePath:r,material:e,cb:f,repeat:e.DiffuseMapRepeat,offset:e.DiffuseMapOffset,wrap:e.DiffuseMapWrap,checkTransparency:!0,format:n})),e.mapLight&&r&&(v.lightMap=this.getTexture({type:"url",sourceFile:e.mapLight,material:e,cb:f,texturePath:r,repeat:e.mapLightRepeat,offset:e.mapLightOffset,wrap:e.mapLightWrap})),e.mapNormal&&r&&(v.normalMap=this.getTexture({type:"url",sourceFile:e.mapNormal,material:e,cb:f,texturePath:r,repeat:e.mapNormalRepeat,offset:e.mapNormalOffset,wrap:e.mapNormalWrap})),e.mapSpecular&&r&&(v.specularMap=this.getTexture({type:"url",sourceFile:e.mapSpecular,material:e,cb:f,texturePath:r,repeat:e.mapSpecularRepeat,offset:e.mapSpecularOffset,wrap:e.mapSpecularWrap})),e.ReflectionMap&&r&&(v.envMap=this.getTexture({type:"url_envMap",sourceFile:e.mapSpecular,material:e,cb:f,texturePath:r,repeat:e.mapSpecularRepeat,offset:e.mapSpecularOffset,wrap:e.mapSpecularWrap})),e._pbr=!1,J){var te=i.MaterialUtils.convertShininessToIoRRoughness(v.shininess?v.shininess:0);v.roughness=te.roughness,v.reflectivityEnvMap=v.envMap,v.envMap=null,v.ior=te.ior,g="_CATGraphicalMaterial",e._pbr=!0,v.diffuseUvTransform=$,$=null}if(Y=new i[g](v),this.extractMaterialApplicationMappingInfos(e.mapping,Y,$),void 0!==e.DbgName&&(Y.name=e.DbgName),void 0!==e.textureId&&-1!==e.textureId&&(e.url=l[e.textureId].url),this.materials.push({params:e,threejs_mat:Y,hasTexture:this._currentMatHasTexture}),0===e.__nbTexturesToLoad)for(var ie=0;ie<e.__cbLoadedImages.length;ie++)e.__cbLoadedImages[ie](Y);return Y.map&&Y.map.needToCheckTransparency&&(Y.map.transparentCb=function(e){Y.transparent=e}),Y},_getPointMaterial:function(e){var r=this,n=function(e,t){return r.texturesPoint[e]?r.texturesPoint[e]:(r.texturesPoint[e]=s(t,i.ImageUtils.crossOriginPolicy),r.texturesPoint[e])},a=9,o=(e.symbol&&e.symbol,e.color),l=null,c=!1,h=t.getWebappsAssetUrl("Visualization","");switch(e.symbol){case this.PointSymbolEnum.NOSPRITE:l=null;break;case this.PointSymbolEnum.CROSS:l=n(1,h+"textures/point/cross.png"),c=!0;break;case this.PointSymbolEnum.PLUS:l=n(2,h+"textures/point/plus.png"),c=!0;break;case this.PointSymbolEnum.COINCIDENT:l=n(3,h+"textures/point/concentric.png"),c=!0;break;case this.PointSymbolEnum.CONCENTRIC:l=n(4,h+"textures/point/coincident.png"),c=!0;break;case this.PointSymbolEnum.FULLCIRCLE:l=n(5,h+"textures/point/fullCircle.png"),c=!0,a=5;break;case this.PointSymbolEnum.FULLSQUARE:l=n(6,h+"textures/point/fullSquare.png"),a=7;break;case this.PointSymbolEnum.STAR:l=n(7,h+"textures/point/star.png"),c=!0;break;case this.PointSymbolEnum.DOT:l=n(8,h+"textures/point/dot.png"),a=3;break;case this.PointSymbolEnum.SMALLDOT:l=n(9,h+"textures/point/smallDot.png"),a=2;break;default:l=null}return e.size&&(a=e.size),e.withoutDPR||(a=Math.round(a*(i.getDevicePixelRatio()||1))),e.scale&&(a=e.scale*a),new i.ParticleBasicMaterial({size:a,color:o,map:l,sizeAttenuation:!1,blending:i.NormalBlending,depthTest:!1,transparent:c,alphaTest:.01})},createPointMaterial:function(e){var r=this;if(!e._cgr)return this._getPointMaterial(e);var n,a=function(e,t){return r.texturesPoint[e]?r.texturesPoint[e]:(r.texturesPoint[e]=s(t,i.ImageUtils.crossOriginPolicy),r.texturesPoint[e])},o=null,l=9,c=e.color,h=e.opacity,u=!1,d=t.getWebappsAssetUrl("Visualization","");if(void 0!==e.symbol){switch(h=void 0,e.symbol){case 0:n=null,e.size&&(l=e.size);break;case 1:n=a(1,d+"textures/point/cross.png"),u=!0;break;case 2:n=a(2,d+"textures/point/plus.png"),u=!0;break;case 3:n=a(3,d+"textures/point/concentric.png"),u=!0;break;case 4:n=a(4,d+"textures/point/coincident.png"),u=!0;break;case 5:n=a(5,d+"textures/point/fullCircle.png"),u=!0,l=5;break;case 6:n=a(6,d+"textures/point/fullSquare.png"),l=7;break;case 7:n=a(7,d+"textures/point/star.png"),u=!0;break;case 8:n=a(8,d+"textures/point/dot.png"),l=3;break;case 9:n=a(9,d+"textures/point/smallDot.png"),l=2;break;default:n=a(1,d+"textures/point/cross.png"),u=!0}l=Math.round(l*(i.getDevicePixelRatio()||1))}else l=e.size;return o=new i.ParticleBasicMaterial({size:l,color:c,map:n,blending:i.NormalBlending,depthTest:!1,sizeAttenuation:!1,transparent:u,alphaTest:.01}),h&&(o.opacity=h),o},createTexture:function(e){function t(t,r){var n,a,s=new Image;i.ImageUtils.nbTexturesBeingLoaded++,e.material.__nbTexturesToLoad++,t.loadEndStatus=i.AssetLoadingStatus.LOADING,s.onload=function(){t.loadEndStatus=i.AssetLoadingStatus.READY,i.ImageUtils.is_pow2(s.width)&&i.ImageUtils.is_pow2(s.height)?t.image=s:(n=i.ImageUtils.nearest_pow2(s.width),a=i.ImageUtils.nearest_pow2(s.height),t.image.width=n,t.image.height=a,t.image.getContext("2d").drawImage(s,0,0,n,a)),t.needsUpdate=!0,i.ImageUtils.nbTexturesBeingLoaded--,e.material.__nbTexturesToLoad--;for(var r=0;r<t.onLoadCallbacks.length;r++)t.onLoadCallbacks[r](t);if(0===e.material.__nbTexturesToLoad)for(r=0;r<e.material.__cbLoadedImages.length;r++)e.material.__cbLoadedImages[r](e.cb())},s.onerror=function(){if(i.ImageUtils.nbTexturesBeingLoaded--,e.material.__nbTexturesToLoad--,t.loadEndStatus=i.AssetLoadingStatus.ERROR,0===e.material.__nbTexturesToLoad)for(var r=0;r<e.material.__cbLoadedImages.length;r++)e.material.__cbLoadedImages[r](e.cb())},s.crossOrigin="anonymous",s.src=r}function r(e,t,i,r,n,a){var s,o,l,c,h,u,d,p,f,m,g,v,S=t/r,_=new Float32Array(i*r*a);if(1!==S)for(u=S/2,d=0;d<r;d++,u+=S)for(o=(s=Math.floor(u))>=i-1?0:a,l=u-s,c=d*a,h=s*a,p=0;p<i;p++,c+=r*a,h+=t*a)for(f=0;f<a;f++)_[c+f]=e[h+f]*(1-l)+e[h+o+f]*l;else for(m=0;m<i*r*a;m++)_[m]=e[m];if(g=i/n,v=new Uint8Array(n*r*a),1!==g)for(u=g/2,p=0;p<n;p++,u+=g)for(o=(s=Math.floor(u))>=i-1?0:a*r,l=u-s,c=p*r*a,h=s*r*a,d=0;d<r;d++,c+=a,h+=a)for(f=0;f<a;f++)v[c+f]=_[h+f]*(1-l)+_[h+o+f]*l;else for(m=0;m<n*r*a;m++)v[m]=_[m];return v}function n(e){var t;for(t=3;t<e.length;t+=4)if(255!=e[t])return!0;return!1}var a,s,o,l,h;switch(a=1===e.wrap[0]||"repeat"==e.wrap[0]?i.RepeatWrapping:i.ClampToEdgeWrapping,s=1===e.wrap[1]||"repeat"==e.wrap[0]?i.RepeatWrapping:i.ClampToEdgeWrapping,e.filter[0]){case 0:l=i.NearestFilter;break;case 1:l=i.LinearFilter;break;case 2:l=i.NearestMipMapNearestFilter;break;case 3:l=i.NearestMipMapLinearFilter;break;case 4:l=i.LinearMipMapNearestFilter;break;case 5:l=i.LinearMipMapLinearFilter}switch(e.filter[1]){case 0:o=i.NearestFilter;break;case 1:o=i.LinearFilter;break;case 2:o=i.NearestMipMapNearestFilter;break;case 3:o=i.NearestMipMapLinearFilter;break;case 4:o=i.LinearMipMapNearestFilter;break;case 5:o=i.LinearMipMapLinearFilter}switch(e.type){case"url":if("dds"===(u=/(?:\.([^.]+))?$/.exec(e.sourceFile.filename)[1])?h=i.ImageUtils.loadCompressedTextureFromBuffer(e.sourceFile.buffer):(d=document.createElement("canvas"),h=new i.Texture(d),"XMLV6"===e.format?h.sourceFile=e.sourceFile:h.sourceFile=window.URL.createObjectURL(e.sourceFile.buffer)),h.wrapS=a,h.wrapT=s,h.magFilter=o,h.minFilter=l,e.offset&&h.offset.set(e.offset[0],e.offset[1]),"dds"===u){h&&h.mipmaps&&(1==(p=h.mipmaps)[p.length-1].height&&1==p[p.length-1].width||(l=o=i.LinearFilter)),h.flipY=!0;break}"XMLV6"===e.format?t(h,e.texturePath+"/"+e.sourceFile):t(h,h.sourceFile),h&&(h.flipY=!0);break;case"url_envMap":var u,d,p;if("dds"===(u=/(?:\.([^.]+))?$/.exec(sourceFile.filename)[1])?h=i.ImageUtils.loadCompressedTextureFromBuffer(sourceFile.buffer):(d=document.createElement("canvas"),h=new i.Texture(d),"XMLV6"===e.format?h.sourceFile=sourceFile:h.sourceFile=window.URL.createObjectURL(sourceFile.buffer)),h.wrapS=a,h.wrapT=s,h.magFilter=o,h.minFilter=l,e.offset&&h.offset.set(e.offset[0],e.offset[1]),"dds"===u){h&&h.mipmaps&&(1==(p=h.mipmaps)[p.length-1].height&&1==p[p.length-1].width||(h.minFilter=h.magFilter=i.LinearFilter)),h.flipY=!0;break}!function(e,t){var r;for(e.image=[],i.ImageUtils.nbTexturesBeingLoaded++,e.image.loadCount=0,r=0;r<6;++r)e.image[r]=new Image,e.image[r].onload=function(){if(e.image.loadCount+=1,6===e.image.loadCount){e.needsUpdate=!0,i.ImageUtils.nbTexturesBeingLoaded--;for(var t=0;t<e.onLoadCallbacks.length;t++)e.onLoadCallbacks[t](e)}},e.image[r].onerror=function(){e.image.loadCount+=1,6===e.image.loadCount&&i.ImageUtils.nbTexturesBeingLoaded--},e.image[r].crossOrigin="anonymous",e.image[r].src=t}(h,e.texturePath+"/"+sourceFile),h&&(h.flipY=!0);break;case"data":var f=!1,m=!1,g=e.resources.img,v=e.resources.format,S=!1;switch((e.filter[0]>1||e.filter[1]>1)&&(S=!0),a!=i.RepeatWrapping&&s!=i.RepeatWrapping||(S=!0),e.resources.imgType){case 1:var _=e.resources.width,y=e.resources.height;switch(v){case 0:v=i.LuminanceFormat;break;case 1:v=i.LuminanceAlphaFormat;break;case 2:v=i.RGBFormat;break;case 3:v=i.RGBAFormat,e.checkTransparency&&(f=n(g))}if((!i.ImageUtils.is_pow2(_)||!i.ImageUtils.is_pow2(y))&&S){var x=i.ImageUtils.nearest_pow2(_),M=i.ImageUtils.nearest_pow2(y);v===i.RGBAFormat?g=r(g,_,y,x,M,4):v===i.RGBFormat&&(g=r(g,_,y,x,M,3)),_=x,y=M}if(h=new i.DataTexture(g,_,y,v,void 0,void 0,a,s,o,l)){if(h.size=_,h.flipY=!1,f&&(h.transparent=!0),v==i.RGBFormat){var P=3*_;P%4&&(h.unpackAlignment=2,P%2&&(h.unpackAlignment=1))}v==i.LuminanceFormat&&(h.unpackAlignment=1)}h.needsUpdate=!0;break;case 2:var C=e.resources,b=0;switch(C.format){case 3:b=i.RGBAFormat;break;case 6:b=i.RGB_S3TC_DXT1_Format,m=!0;break;case 7:b=i.RGBA_S3TC_DXT1_Format,m=!0;break;case 8:b=i.RGBA_S3TC_DXT3_Format,m=!0;break;case 9:b=i.RGBA_S3TC_DXT5_Format,m=!0}m&&function(e,t,r,n,a){var s,o,l,c,h,u,d,p,f,m,g,v,S,_,y,x,M,P,C,b,D;function w(e){x=e[4],e[4]=e[7],e[7]=x,x=e[5],e[5]=e[6],e[6]=x}function E(e,t){var i;for(i=0;i<e.length;i++)e[i]=t[i]}switch(n){case i.RGB_S3TC_DXT1_Format:l=8,s=w,o=function(e){x=e[4],e[4]=e[5],e[5]=x};break;case i.RGBA_S3TC_DXT3_Format:l=16,s=function(e){x=e[0],e[0]=e[6],e[6]=x,x=e[1],e[1]=e[7],e[7]=x,x=e[2],e[2]=e[4],e[4]=x,x=e[3],e[3]=e[5],e[5]=x,w(e.subarray(8,16))},o=function(e){x=e[0],e[0]=e[2],e[2]=x,x=e[1],e[1]=e[3],e[3]=x,w(e.subarray(8,16))};break;case i.RGBA_S3TC_DXT5_Format:l=16,s=function(e){P=e[2]+256*(e[3]+256*e[4]),b=e[5]+256*(e[6]+256*e[7]),C=(4095&P)<<12|(16773120&P)>>12,D=(4095&b)<<12|(16773120&b)>>12,e[2]=255&D,e[3]=(65280&D)>>8,e[4]=(16711680&D)>>8,e[5]=255&C,e[6]=(65280&C)>>8,e[7]=(16711680&C)>>8,w(e.subarray(8,16))},o=function(e){P=e[2]+256*(e[3]+256*e[4]),C=(4095&P)<<12,e[2]=255&C,e[3]=(65280&C)>>8,e[4]=(16711680&C)>>8,w(e.subarray(8,16))};break;default:return console.error("flip dds error"),a}for(c=e,h=t,f=0;f<r&&(v=a[f].data,p=(u=Math.floor((c+3)/4))*(d=Math.floor((h+3)/4)),1!=h);++f){if(2==h)for(m=0;m<u;m++)o(v.subarray(g,m*l)),g=+l;else{for(g=0,m=1;m<=p;m++)s(v.subarray(g,m*l)),g+=l;M=l*u,y=new Uint8Array(M);for(var T=0;T<d/2;++T)S=v.subarray(T*M,(T+1)*M),_=v.subarray((d-T-1)*M,(d-T)*M),E(y,S),E(S,_),E(_,y)}(c/=2)<1&&(e=1),(h/=2)<1&&(t=1)}}(C.width,C.height,C.mipmapCount,b,C.mipmaps),(h=new i.CompressedTexture(C.mipmaps,C.width,C.height,b,void 0,new i.UVMapping,a,s,o,l)).flipY=!1,h.generateMipmaps=!1,h.needsUpdate=!0;break;case 3:var D=new Blob([g],{type:"image/png"}),w=URL.createObjectURL(D);return(h=i.ImageUtils.loadTexture(w,void 0,function(e){var t=e.image;if((h=e).wrapS=a,h.wrapT=s,h.magFilter=o,h.minFilter=l,h.needsUpdate=!0,h.transparentCb){var i=document.createElement("canvas");i.width=t.width,i.height=t.height,i.getContext("2d").drawImage(t,0,0,t.width,t.height);var r=i.getContext("2d").getImageData(0,0,t.width,t.height);h.transparent=n(r.data),h.transparent&&h.transparentCb(h.transparent)}},null,i.ImageUtils.crossOriginPolicy,S)).needToCheckTransparency=!!e.checkTransparency,h;case 4:var E=new Uint32Array(g.buffer);return(h=i.ImageUtils.loadCompressedTextureFromBuffer(E)).wrapS=a,h.wrapT=s,h.magFilter=o,h.minFilter=l,h;case 5:(h=i.ImageUtils.loadBasisTexture(e.resources.img,null,null,null,null,i.BasisUsage[c[e.resources.format]])).wrapS=a,h.wrapT=s,h.magFilter=o,h.minFilter=l;break;case 6:(h=i.ImageUtils.loadKTX2Texture(e.resources.img,null,null,null,null,i.BasisUsage[c[e.resources.format]])).wrapS=a,h.wrapT=s,h.magFilter=o,h.minFilter=l;break;default:h=null}break;default:h=null}return h},set3DXSharedGas:function(e,t){this.threeDXSharedGas.set(e,t)},get3DXSharedGas:function(e){return this.threeDXSharedGas.has(e)?this.threeDXSharedGas.get(e):null},getDashPatternArrayMaterial:function(e){var t,n,a;for(null==e.color&&(e.color=new i.Color),void 0===e.opacity&&(e.opacity=1),a=0;a<this.materials.length;a++)if("color"===(n=(t=this.materials[a]).params).type&&!(void 0!==e.pattern&&n.pattern!==e.pattern||n.color.r!==e.color.r||n.color.g!==e.color.g||n.color.b!==e.color.b||n.opacity!==e.opacity||void 0!==e.lineWidth&&n.lineWidth!==e.lineWidth))return t.threejs_mat;return void 0!==e.lineWidth?(n={type:"color",color:e.color,opacity:e.opacity,lineWidth:e.lineWidth,pattern:e.pattern},t=new i.LineBasicMaterial({color:e.color.getHex(),lineWidth:e.lineWidth,opacity:e.opacity,transparent:e.opacity<1}),e.pattern instanceof Array?(t.setDashPatternArray(e.pattern),t.setScale(1)):(t.setDashPatternType(e.pattern),t.setScale(e.pattern===r.LinePatternEnum.SMALLDOTTED?2:4)),this.materials.push({params:n,threejs_mat:t,hasTexture:!1}),t._source=i.AssetSource.MATERIAL_MANAGER,t):(console.warn("getMaterialFromGAS"),new i.LineBasicMaterial)},getMaterialFromGAS:function(e){if(this._currentMatHasTexture=!1,void 0!==e.pattern&&e.pattern instanceof Array)return this.getDashPatternArrayMaterial(e);var t,i,n=251924482,a=255,s=[255,255,255],o=function(e){n&=-4,n|=3&e},l=function(e){n&=-49,n|=(3&e)<<4};void 0!==e.solid&&e.solid?l(3):l(2),void 0!==e.color&&null!==e.color&&(s[0]=255*e.color.r,s[1]=255*e.color.g,s[2]=255*e.color.b),void 0!==e.symbol&&(o(0),l(0),i=e.symbol,n&=268435455,n|=(15&i)<<28,void 0!==e.size&&(t=e.size,n&=-258049,n|=(63&t)<<12)),void 0!==e.lineWidth&&(o(1),l(1),function(e){n&=-258049,n|=(63&e)<<12}(e.lineWidth),void 0!==e.pattern&&function(e){n&=-3932161,n|=(15&e)<<18}(e.pattern)),e.basic&&(n&=-5,n|=4),void 0!==e.opacity&&(a=255*e.opacity);var c=s[0]<<24^s[1]<<16^s[2]<<8^a<<0,h={};return void 0!==e.depthPriority&&-1!==e.depthPriority&&(h.depthPriority=e.depthPriority),this._getMaterialFromGAS(new r.GraphicAttributeSet(n,c),h)},setCGRSharedMaterial:function(e,t){this.CGRSharedMaterials.set(e,t)},getCGRSharedMaterial:function(e){return this.CGRSharedMaterials.has(e)?this.CGRSharedMaterials.get(e):null},getMaterialFromGAS2:function(e){var t,n;this._currentMatHasTexture=!1,null==e.color&&(e.color=new i.Color),void 0===e.opacity&&(e.opacity=1);var a=!!i._GASFaceMaterialsAsPBR;for(n=0;n<this.materials.length;n++)if("color"===(t=(s=this.materials[n]).params).type&&(void 0===e.symbol||"point"===t.style)&&(void 0===e.lineWidth||"line"===t.style)&&(void 0!==e.lineWidth||void 0!==e.symbol||"fill"===t.style)&&(void 0===e.pattern||t.pattern===e.pattern)&&t.color.r===e.color.r&&t.color.g===e.color.g&&t.color.b===e.color.b&&t.opacity===e.opacity&&(void 0===e.lineWidth||t.lineWidth===e.lineWidth)&&(void 0===e.symbol||t.symbol===e.symbol)&&(void 0===e.size||t.size===e.size)&&(void 0===e.solid||t.solid===e.solid)&&(!e.basic||t.basic===e.basic)&&(!1!==t._pbr||!a)&&(!0!==t._pbr||a))return s.threejs_mat;if(void 0!==e.symbol){t={type:"color",style:"point",color:e.color,opacity:e.opacity,symbol:e.symbol,size:e.size};var s=this.createPointMaterial({symbol:e.symbol,color:e.color,opacity:e.opacity,resource:e.resource,size:e.size,_cgr:!0})}else if(void 0!==e.lineWidth)t={type:"color",style:"line",color:e.color,opacity:e.opacity,lineWidth:e.lineWidth,pattern:e.pattern},s=new i.LineBasicMaterial({color:e.color.getHex(),lineWidth:e.lineWidth,opacity:e.opacity,transparent:e.opacity<1}),e.pattern instanceof Array?(s.setDashPatternArray(e.pattern),s.setScale(1)):(s.setDashPatternType(e.pattern),s.setScale(e.pattern===r.LinePatternEnum.SMALLDOTTED?2:4));else if(e.basic){t={type:"color",style:"fill",color:e.color,opacity:e.opacity,basic:e.basic,solid:e.solid};var o={color:e.color.getHex(),side:1===e.solid?i.FrontSide:i.DoubleSide,opacity:e.opacity,transparent:e.opacity<1};s=new i.MeshBasicMaterial(o)}else{t={type:"color",style:"fill",color:e.color,opacity:e.opacity,solid:e.solid,_pbr:!1};o={color:e.color.getHex(),opacity:e.opacity,transparent:e.opacity<1,side:1===e.solid?i.FrontSide:i.DoubleSide,specular:16777215,shininess:76};if(s=new i.MeshPhongMaterial(o),a){var l=s;t._pbr=!0;var c=i.MaterialUtils.convertShininessToIoRRoughness(null);o={color:e.color.getHex(),opacity:e.opacity,transparent:e.opacity<1,side:1===e.solid?i.FrontSide:i.DoubleSide,ior:c.ior,specular:16777215,roughness:c.roughness},s=new i._GASPBRMaterial(o,l)}}return this.materials.push({params:t,threejs_mat:s,hasTexture:this._currentMatHasTexture}),s._source=i.AssetSource.MATERIAL_MANAGER,s},_getLineWidth:function(e){var t=e.set>>12&63;return t=t>l.length?1:l[t]},_gasAllowNMIR:function(e){return!((e.set>>18&15)>1||this._getLineWidth(e.set)>1)},_getNbGasMaterial:function(){var e=0;return this.gasMaterialsMap.forEach(function(t,i){t.forEach(function(t,i){e++})}),this.gasSGOrederMaterialsMap.forEach(function(t,i){t.forEach(function(t,i){e++})}),e},_getMaterialFromGAS:function(e,t){var n=this,a=function(e){var t=e.getDisplayedColor();return t[0]=t[0]/255,t[1]=t[1]/255,t[2]=t[2]/255,t[3]=t[3]/255,t},s=t&&void 0!==t.depthPriority,o=t&&t.sceneGraphOrderMode||s?this.gasSGOrederMaterialsMap:this.gasMaterialsMap,l=null,c=null,h=null,u=!!i._GASFaceMaterialsAsPBR,d=3&e.set,p=function(e){return e.set>>2&1}(e),f=e.getType();if(d>1&&!p&&u&&(e.set&=-65,e.set|=64),o.has(e.set)){if((l=o.get(e.set)).has(e.rgba)){if(!s)return l.get(e.rgba);if((c=l.get(e.rgba)).has(t.depthPriority))return c.get(t.depthPriority)}}else l=new Map,o.set(e.set,l);switch(d){case 0:h=function(e,t){var r=a(e),s=(new i.Color).setRGB(r[0],r[1],r[2]),o=e.set>>28&15,l=e.set>>12&63,c=1==(e.set>>23&1),h=(3==e.getType()?i.FrontSide:i.DoubleSide,n.createPointMaterial({symbol:o,color:s,opacity:r[3],size:l,_cgr:!0,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0}));return c&&(h.vertexColors=i.VertexColorType.RGB),h}(e,t);break;case 1:h=function(e,t){var s=a(e),o=(new i.Color).setRGB(s[0],s[1],s[2]);if(n.hasLineTypes()){const r=64*(e.set>>12&63)+(e.set>>18&63);let a=n._createLineTypeMaterial(r,{color:o.getHex(),opacity:s[3],transparent:s[3]<1});return a||new i.LineBasicMaterial({color:o.getHex(),lineWidth:1,opacity:s[3],transparent:s[3]<1,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0})}{const n=e.set>>18&15,a=e.getLineThickness();let l=new i.LineBasicMaterial({color:o.getHex(),lineWidth:a,opacity:s[3],transparent:s[3]<1,linecap:"butt",_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0});return l.setDashPatternType(n),l.setScale(n===r.LinePatternEnum.SMALLDOTTED?2:4),l}}(e,t);break;case 2:case 3:h=function(e){return e.set>>22&1}(e)?this.getBlankingRepMaterial():p||f<2?function(e,t){var r=a(e),n=(new i.Color).setRGB(r[0],r[1],r[2]),s=3==e.getType()?i.FrontSide:i.DoubleSide,o={color:n.getHex(),side:s,opacity:r[3],transparent:r[3]<1,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0};return h=new i.MeshBasicMaterial(o)}(e,t):function(e,t){var r=a(e),n=(new i.Color).setRGB(r[0],r[1],r[2]),s=3==e.getType()?i.FrontSide:i.DoubleSide,o=function(e){return e.set>>6&1}(e),l={color:n.getHex(),opacity:r[3],transparent:r[3]<1,side:s,specular:16777215,shininess:76,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0},c=new i.MeshPhongMaterial(l);if(o){var h=c,u=i.MaterialUtils.convertShininessToIoRRoughness(null);l={color:n.getHex(),opacity:r[3],transparent:r[3]<1,side:s,specular:16777215,ior:u.ior,roughness:u.roughness,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0},c=new i._GASPBRMaterial(l,h)}return c}(e,t)}return s?c?c.set(t.depthPriority,h):((c=new Map).set(t.depthPriority,h),l.set(e.rgba,c)):l.set(e.rgba,h),h._source=i.AssetSource.MATERIAL_MANAGER,e.isBackgroundColor()&&(h.color=this.backgroundColor,this.backgroundColorMaterials.push(h)),t&&void 0!==t.depthPriority&&function(e,t){e.activatePDSFX();var i={depthPriority:{type:"f",value:t}};e.setPDSFXUniforms(i);var r={ComputeCommonValues:["void ComputeCommonValues() {","vSetFragDepth((16777216.0 -depthPriority)/16777216.0);","}"].join("\n")};e.setPDSFXOverridableFunctions({},r)}(h,t.depthPriority),t&&2==t.sceneGraphOrderMode&&function(e){e.activatePDSFX();e.setPDSFXVaryings({depthSGOrder:{type:"f"}});var t={ComputeVaryingValues:["void ComputeVaryingValues() {","depthSGOrder = vGetAttribPosition().z;","}"].join("\n"),ComputeObjectPosition:["vec3 ComputeObjectPosition() {","return vec3(vGetAttribPosition().xy,0.0);","}"].join("\n"),ComputeObjectFollowingPosition:["vec3 ComputeObjectFollowingPosition() {","return vec3(vGetAttribFollowingPosition().xy,0.0);","}"].join("\n"),ComputeObjectPreviousPosition:["vec3 ComputeObjectPreviousPosition() {","return vec3(vGetAttribPreviousPosition().xy,0.0);","}"].join("\n")},i={ComputeCommonValues:["void ComputeCommonValues() {","vSetFragDepth((16777216.0 -depthSGOrder)/16777216.0);","}"].join("\n")};e.setPDSFXOverridableFunctions(t,i)}(h),h},recompileShaders:function(){for(var e=0;e<this.materials.length;e++){var t=this.materials[e];t&&t.threejs_mat&&t.threejs_mat.recompileShaders(!1)}}});return UWA.namespace("THREEDS/MaterialManager",f)}),define("Visualization/MaterialManager",["DS/Visualization/MaterialManager","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/MaterialManager"),e}),define("DS/Visualization/RenderMode",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i=e.extend({init:function(e){this._mask=0,this._maskWithDefault=0,this._setFromMasks(0,0,t.GeomTypeEnum.FACE),this._useRenderLineMask=!0,this._useRenderFaceMask=!0,this._useRenderPointMask=!0,this._halfVisibleSmoothEdges=-1,this._hiddenEdges=-1,this._outlineWidth=1,e&&void 0!==e.renderLineMode&&this._setRenderLineMode(e.renderLineMode)},clone:function(){var e=new i;return e._mask=this._mask,e._maskWithDefault=this._maskWithDefault,e._useRenderLineMask=this._useRenderLineMask,e._useRenderPointMask=this._useRenderPointMask,e._useRenderFaceMask=this._useRenderFaceMask,e._outlineWidth=this._outlineWidth,e._halfVisibleSmoothEdges=this._halfVisibleSmoothEdges,e._hiddenEdges=this._hiddenEdges,e},combine:function(e){e&&(this._mask=e._mask)},setOutlineWidth:function(e){this._outlineWidth=e},setHalfVisibleSmoothEdges:function(e){this._halfVisibleSmoothEdges=e},setHiddenEdges:function(e){this._hiddenEdges=e},setRenderMode:function(e,i){if("@InternalEdge"===e)this.setRenderMode("InternalSharpEdge",i),this.setRenderMode("InternalSmoothEdge",i);else if("@Edge"===e)this.setRenderMode("InternalSharpEdge",i),this.setRenderMode("InternalSmoothEdge",i),this.setRenderMode("BoundaryEdge",i),this.setRenderMode("WireEdge",i),this.setRenderMode("Edge",i);else if("@Point"===e)this.setRenderMode("BoundaryPoint",i),this.setRenderMode("SharpPoint",i),this.setRenderMode("SmoothPoint",i),this.setRenderMode("SurfacicPoint",i),this.setRenderMode("FreePoint",i);else{var r={Edge:"EDGE",InternalSharpEdge:"SHARP_EDGE",InternalSmoothEdge:"SMOOTH_EDGE",BoundaryEdge:"BOUNDARY_EDGE",WireEdge:"WIRE_EDGE",Outline:"_OUTLINE",SectionLine:"_SECTION_LINE",Face:"FACE",BoundaryPoint:"BOUNDARY_POINT",SharpPoint:"SHARP_POINT",SurfacicPoint:"SURFACIC_POINT",SmoothPoint:"SMOOTH_POINT",FreePoint:"FREE_POINT",AxisSystem:"AXIS_SYSTEM",InfiniteFace:"INFINITE_FACE"}[e];if(r){var n,a,s=t.GeomTypeEnum[r];n=this._mask||0,a=i?n|s:n&~s,this._setMask(a)}else console.warn(e+"unknown category")}},_setRenderLineMode:function(e){e=e||0;var t,r=this._mask,n=i.linesMask;t=e&n|(r&=~n),this._setMask(t)},_setFromMasks:function(e,t,i){this._setMask(e&r|t&n|i&s)},getMask:function(){return this._mask},getMasks:function(){return[this._mask&s,this._mask&n,this._mask&r]},areFacesVisible:function(){return!!(this._mask&t.GeomTypeEnum.FACE)},_displayNothing:function(){this._setMask(0)},_setMask:function(e){this._mask=e,this._maskWithDefault=e|i.defaultMask}});i.createChild=function(e,t){var i=null;return(e||t)&&(e?(i=e.clone()).combine(t):i=t),i},i.defaultMask=t.GeomTypeEnum.UNKNOWN|t.GeomTypeEnum.UNKNOWN_1D|t.GeomTypeEnum.UNKNOWN_2D;var r=t.GeomTypeEnum.BOUNDARY_POINT|t.GeomTypeEnum.SHARP_POINT|t.GeomTypeEnum.SMOOTH_POINT|t.GeomTypeEnum.SURFACIC_POINT|t.GeomTypeEnum.FREE_POINT|t.GeomTypeEnum.HIDDEN_SEAM_POINT;i.pointsMask=r;var n=t.GeomTypeEnum.EDGE|t.GeomTypeEnum.WIRE_EDGE|t.GeomTypeEnum.BOUNDARY_EDGE|t.GeomTypeEnum.SHARP_EDGE|t.GeomTypeEnum.SMOOTH_EDGE|t.GeomTypeEnum.HIDDEN_SEAM_EDGE|t.GeomTypeEnum._OUTLINE|t.GeomTypeEnum._SECTION_LINE;i.linesMask=n;var a=t.GeomTypeEnum.EDGE|t.GeomTypeEnum.WIRE_EDGE|t.GeomTypeEnum.BOUNDARY_EDGE|t.GeomTypeEnum.SHARP_EDGE|t.GeomTypeEnum.SMOOTH_EDGE|t.GeomTypeEnum.HIDDEN_SEAM_EDGE;i.linesPickingMask=a;var s=t.GeomTypeEnum.INFINITE_FACE|t.GeomTypeEnum.FACE|t.GeomTypeEnum.AXIS_SYSTEM;return i.facesMask=s,i.unknownMask=i.defaultMask,t.RenderMode=i,i}),define("DS/Plugins/RenderPass",["DS/Visualization/ThreeJS_DS","DS/Visualization/RenderMode"],function(e,t){"use strict";var i=1,r=function(r,n,a,s,o,l,c){this.scene=r,this.lockScene=!1,this.name=c,this.id="R"+i++,this.forcePolygonOffset=e.PolygonOffsetForceStatus.DEFAULT,this.overrideMaterial=a,this.renderFaceMode=null,this.renderLineMode=null,this.renderPointMode=null,!0===s?this.renderFaceMode=t.facesMask:null!=s&&(this.renderFaceMode=s||0),!0===o?this.renderLineMode=t.linesMask:null!=o&&(this.renderLineMode=o||e.HideAllRenderLineMode),!0===l?this.renderPointMode=t.pointsMask:null!=l&&(this.renderPointMode=l||0),this.forceMaterialDoubleSide=!1,this.oldRenderFaceMode=0,this.oldRenderFaces=null,this.oldRenderLineMode=e.HideAllRenderLineMode,this.oldRenderPointMode=0,this.oldRenderPoints=null,this.oldRenderSurfacicPoints=!1,this.needsSwap=!1,this.order=0,this.renderPluginsPre=!0,this.renderPluginsPost=!0,this.oldRenderPluginsPre=!0,this.oldRenderPluginsPost=!0,this.disableColorWrite=!1,this.disableDepthWrite=!1,this.disableDepthTest=!1,this.disableBackFaceCulling=!1,this.disableClippingPlanes=!1,this.enableStencilTest=!1,this.enableStencilWrite=!1,this.stencilOpFrontFaces="KEEP",this.stencilOpBackFaces="KEEP",this.stencilOpFrontFacesZFail="KEEP",this.stencilOpBackFacesZFail="KEEP",this.stencilFunc="ALWAYS",this.depthFunc=null,this.materialToUse=null,this.hideSurfacesAndUnclipedMeshes=!1,this.cullFaceMode="back",this.disableBackFaceClipPlanes=!1,this.renderCuttingElements=!1,this.cuttingScene=null,this.isCustomPass=!1,this.disableToneMapping=!1,this.stencilRef=100,this.defaults={},this.cameraName="main",this.idString="main",this.customCamera=null,this.useRenderPriorityOpacity=!1,this.isOITPass=!1,this.dlsToDisableFunc=null,this.composer=null,this.ignoreNoZ=!1,this.disabledByDefault=!1,this.order=0,this.isRobotPass=!1,this.oldRenderPointMode=null,this.renderToScreen=!1,this.renderSurfacicPoints=!1,this.renderedComposerContext=null,this.stateSortingResultFrom=null,this.stateSortingResults={},this.updateStateSortingResult=!0,this.enableGSSOCache=!0,this.forceMaterialMode=!1,this.transformProjectionMatrixCB=null,this.multiRenderCB=null,this._postRenderCB=null,this._preRenderCB=null,this._checkScene=!0};return r.prototype={getDefaultState:function(){return{enabled:!this.disabledByDefault,renderPlugins:!1,renderToCanvas:!1}},setMultiRenderCB:function(e){this.multiRenderCB=e},setStateSortingResultFrom:function(e,t){this.stateSortingResultFrom=e,this.updateStateSortingResult=t},getUsedStateSortingResult:function(t,i,r){var n=this._getStateSortingResultId(i,r);if(this.stateSortingResults[n])return this.stateSortingResults[n];var a=new e.StateSortingResult(this,t.materialToUse);return a.init(),this.stateSortingResults[n]=a,a},setForceMaterialMode:function(e){this.forceMaterialMode=e},setRenderPluginsPre:function(e){this.renderPluginsPre=e},setGSSOCache:function(e){this.enableGSSOCache=e},setRenderPluginsPost:function(e){this.renderPluginsPost=e},setMaterialToUse:function(e){this.materialToUse=e},setDisableColorWrite:function(e){this.disableColorWrite=e},setUseRenderPriorityOpacity:function(e){this.useRenderPriorityOpacity=e},setCustomCamera:function(e){this.customCamera=e},setDisableDepthWrite:function(e){this.disableDepthWrite=e},setDisableDepthTest:function(e){this.disableDepthTest=e},setDisableBackFaceCulling:function(e){this.disableBackFaceCulling=e},setForceMaterialDoubleSide:function(e){this.forceMaterialDoubleSide=e},setDisableClippingPlanes:function(e){this.disableClippingPlanes=e},setEnableStencilWrite:function(e){this.enableStencilWrite=e},setEnableStencilTest:function(e){this.enableStencilTest=e},setCameraName:function(e){this.cameraName=e},setStencilOps:function(e,t){this.stencilOpFrontFaces=e,this.stencilOpBackFaces=t,this.stencilOpFrontFacesZFail=e,this.stencilOpBackFacesZFail=t},setStencilOpsSeparate:function(e,t,i,r){this.stencilOpFrontFaces=e,this.stencilOpBackFaces=t,this.stencilOpFrontFacesZFail=i,this.stencilOpBackFacesZFail=r},setStencilFunc:function(e){this.stencilFunc=e},setCullFaceMode:function(e){this.cullFaceMode=e},setHideSurfacesAndUnclippedMeshes:function(e){this.hideSurfacesAndUnclipedMeshes=e},setDisableBackFaceClipPlanes:function(e){this.disableBackFaceClipPlanes=e},setCuttingScene:function(e){this.cuttingScene=e},setRenderCuttingElements:function(e){this.renderCuttingElements&&!e&&this.setCuttingScene(null),this.renderCuttingElements=e},setCustomPass:function(){this.isCustomPass=!0},setDisableToneMapping:function(e){this.disableToneMapping=e},setDepthFunc:function(e){this.depthFunc=e},setScene:function(e){this.scene=e},setDLsToDisableFunc:function(e){this.dlsToDisableFunc=e},setDLsState:function(e,t){if(this.dlsToDisableFunc){var i=this.dlsToDisableFunc;e.forEach(function(e){i(e)&&(e.active=t)})}},setTransformProjectionMatrixCB:function(e){this.transformProjectionMatrixCB=e},activateAllDLs:function(e){for(var t=0;t<e.length;t++)e[t].active=!0},getCamera:function(e,t){return this.customCamera||e[t]||(this.composer?this.composer.camera:null)},render:function(){var e=arguments[0].info.renderTime;if(e.push(this.name),null===this.multiRenderCB)this.render_internal.apply(this,arguments);else for(var t=0;this.multiRenderCB(this,t++);)this.render_internal.apply(this,arguments);e.pop()},_getStateSortingResultId:function(e,t){return e?e.id+(e._checkCamera?"_"+t.id:"")+(this._checkScene?"_"+this.scene.id:""):-1},_getStateSortingResult:function(t,i,r){var n=this._getStateSortingResultId(t,r);if(this.stateSortingResults[n])return this.stateSortingResults[n];var a=new e.StateSortingResult(this,i.materialToUse);return a.init(),this.stateSortingResults[n]=a,a},render_internal:function(t,i,r,n,a,s,o,l,c,h){var u,d=o[l],p=t.context;this.scene.overrideMaterial=this.overrideMaterial,t.forcePolygonOffset=this.forcePolygonOffset,this.renderedComposerContext=s;var f=null;this.depthFunc&&(f=t.getDepthFunc(),t.setDepthFunc(p[this.depthFunc])),p.stencilFunc(p[this.stencilFunc],this.stencilRef,255),p.stencilOpSeparate(p.FRONT,p.KEEP,p[this.stencilOpFrontFacesZFail],p[this.stencilOpFrontFaces]),p.stencilOpSeparate(p.BACK,p.KEEP,p[this.stencilOpBackFacesZFail],p[this.stencilOpBackFaces]),this.enableStencilTest&&p.enable(p.STENCIL_TEST),null!==this.renderFaceMode&&(this.oldRenderFaceMode=t.renderFaceMode,t.renderFaceMode=this.renderFaceMode),null!==this.renderLineMode&&(this.oldRenderLineMode=t.renderLineMode,t.renderLineMode=this.renderLineMode),this.forceMaterialDoubleSide&&(t.forceMaterialDoubleSide=!0),null!==this.renderPointMode&&(this.oldRenderPointMode=t.renderPointMode,t.renderPointMode=this.renderPointMode),this.oldRenderPluginsPre=t.enableRenderPluginsPre,t.enableRenderPluginsPre=this.renderPluginsPre,this.oldRenderPluginsPost=t.enableRenderPluginsPost,t.enableRenderPluginsPost=this.renderPluginsPost,t.setFaceCulling("back"==this.cullFaceMode?e.CullFaceBack:"front"==this.cullFaceMode?e.CullFaceFront:e.CullFaceNone),0!=this.disableBackFaceClipPlanes&&(t.disableBackFaceClipPlanes=this.disableBackFaceClipPlanes);var m=t.clipPlanesEnabled;this.disableClippingPlanes&&(t.clipPlanesEnabled=!1),this.disableColorWrite&&t.setDisableColorWrite(!0),this.disableDepthWrite&&t.setDisableDepthWrite(!0),this.disableDepthTest&&t.setDisableDepthTest(!0),this.enableStencilWrite&&t.setEnableStencilWrite(!0),this.disableBackFaceCulling&&t.setDisableBackFaceCulling(!0);var g=[];this.hideSurfacesAndUnclipedMeshes&&this.scene.traverse(function(t){if(t instanceof e.Mesh&&t.visible){var i=t.material;i&&!1===i.enableClipPlanes&&(g.push(t),t.visible=!1)}});var v=t.materialToUse;!e.MaterialHasPriority[v]&&this.materialToUse&&(t.materialToUse=this.materialToUse),this.cuttingScene&&(t.cuttingScene=this.cuttingScene),t.setCurrentPass(this),t.autoClearStencil=!1,t.autoClearDepth=!1,t.autoClear=!1;var S=t.gammaInput,_=t.gammaOutput;this.disableToneMapping&&(t.gammaInput=!1,t.gammaOutput=!1);var y,x=t.renderVolumesOnly;t.renderVolumesOnly=this.hideSurfacesAndUnclipedMeshes,this.useRenderPriorityOpacity&&t.materialToUse===e.MaterialToUse.originalMaterial&&(t.useRenderPriorityOpacity=!0),this.forceMaterialMode&&(y=t.materialMode,t.materialMode=!0),null!==this.transformProjectionMatrixCB&&(t.transformProjectionMatrixCB=this.transformProjectionMatrixCB);var M=this.updateStateSortingResult,P=null;P=this.stateSortingResultFrom&&this.stateSortingResultFrom.renderedComposerContext?this.stateSortingResultFrom._getStateSortingResult(this.stateSortingResultFrom.renderedComposerContext,t,d):this._getStateSortingResult(s,t,d),this.setDLsState(P._displayLists,!1),t.activateSplitScreenMode(!(!h&&r));for(this._preRenderCB&&this._preRenderCB(t),h?t.render(this.scene,this.getCamera(o,l),void 0,void 0,void 0,P,M,!0):t.render(this.scene,this.getCamera(o,l),r,!1,!1,P,M,!0),this._postRenderCB&&this._postRenderCB(t),null!==this.transformProjectionMatrixCB&&(t.transformProjectionMatrixCB=null),this.forceMaterialMode&&(t.materialMode=y),this.activateAllDLs(P._displayLists),this.useRenderPriorityOpacity&&(t.useRenderPriorityOpacity=!1),t.renderVolumesOnly=x,t.gammaInput=S,t.gammaOutput=_,t.setCurrentPass(null),this.cuttingScene&&(t.cuttingScene=null),t.materialToUse=v,u=0;u<g.length;u++)g[u].visible=!0;t.setDisableColorWrite(!1),this.disableClippingPlanes&&(t.clipPlanesEnabled=m),this.disableBackFaceCulling&&t.setDisableBackFaceCulling(!1),t.setDisableDepthWrite(!1),t.setDisableDepthTest(!1),t.setEnableStencilWrite(!1),this.enableStencilTest&&p.disable(p.STENCIL_TEST),null!==this.renderFaceMode&&(t.renderFaceMode=this.oldRenderFaceMode),null!==this.renderLineMode&&(t.renderLineMode=this.oldRenderLineMode),null!==this.renderPointMode&&(t.renderPointMode=this.oldRenderPointMode),0!=this.disableBackFaceClipPlanes&&(t.disableBackFaceClipPlanes=0),t.enableRenderPluginsPre=this.oldRenderPluginsPre,t.enableRenderPluginsPost=this.oldRenderPluginsPost,t.forceMaterialDoubleSide=!1,this.scene.overrideMaterial=null,p.stencilFunc(p.ALWAYS,0,255),p.stencilOp(p.KEEP,p.KEEP,p.KEEP),f&&t.setDepthFunc(f),t.forcePolygonOffset=e.PolygonOffsetForceStatus.DEFAULT}},r}),define("Plugins/RenderPass",["DS/Plugins/RenderPass","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Plugins/RenderPass"),e}),define("DS/Visualization/RenderPriorityManager",["UWA/Class","DS/Plugins/RenderPass","DS/Plugins/ClearPass"],function(e,t,i){"use strict";return e.extend({init:function(e){this.viewer=e,this.enabled=!1,this.passes=this._createPasses(e)},setEnabled:function(e){e=!!e,this.enabled!==e&&(this.enabled=e,this._enablePasses(this.enabled),this.viewer.internalSceneGraph.root._forceUpdate())},_enablePasses:function(e){if(this.passes){var t,i=this.viewer;if(e)for(t=0;t<this.passes.length;t++)i.renderer.mainComposer.addPass(this.passes[t]);else i.renderer.mainComposer.removePasses(this.passes)}},_createPasses:function(e){var r=[],n=new i("renderPriorityClear");n.defaults.clear=!1,n.setClearStencil(!0),n.clearStencilValue=0,n.idString="renderPriority",r.push(n);var a,s,o;for(a=0;a<=4;a++)(s=new t(null,null,null,null,null,null,"renderPriorityStencilP"+a)).idString="p"+a,s.stencilRef=a,s.enableStencilTest=!0,s.setStencilFunc("GEQUAL"),s.setStencilOps("REPLACE","REPLACE"),s.setEnableStencilWrite(!0),r.push(s),4!==a&&((o=new t(null,null,null,null,null,null,"renderPriorityDrawP"+a)).idString="p"+a,o.stencilRef=a,o.enableStencilTest=!0,o.setStencilFunc("LESS"),o.setStencilOps("KEEP","KEEP"),o.useRenderPriorityOpacity=!0,o.setEnableStencilWrite(!1),r.push(o));return r}})}),define("DS/VisuEvents/TouchEvent",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent"],function(e,t){"use strict";var i=t.extend({init:function(e,t,i){return this._parent(t),this.type="Touch",this.identifier=e,this._traveledDist=0,this.event.touches&&this.event.touches[i]&&(this.view=this.event.touches[i].target),this},update:function(t){this._parent(t);for(var i,r,n,a=null,s=0;s<t.changedTouches.length;s++){var o=t.changedTouches[s];if(o.identifier===this.identifier){a=o;break}}a&&(i=a.clientX,r=a.clientY,void 0!==a.po_x&&(i=a.po_x),void 0!==a.po_y&&(r=a.po_y));try{n=this.view.getBoundingClientRect()}catch(e){n={left:0,top:0}}switch(t.type){case"touchstart":this.currentPosition.set(i-n.left,r-n.top),this.startPosition.copy(this.currentPosition),this.lastPosition.copy(this.currentPosition),this.deltaPosition.set(0,0),this.offsetPosition.set(0,0),this._currentPosition.set(i,r),this._startPosition.copy(this._currentPosition),this._lastPosition.copy(this._currentPosition),this._deltaPosition.set(0,0),this._offsetPosition.set(0,0),this._traveledDist=0;break;case"touchmove":var l=new e.Vector2(i-n.left,r-n.top);this.lastPosition.copy(this.currentPosition),this.deltaPosition.subVectors(l,this.currentPosition),this.currentPosition.copy(l),this.offsetPosition.subVectors(this.currentPosition,this.startPosition),l.set(i,r),this._lastPosition.copy(this._currentPosition),this._deltaPosition.subVectors(l,this._currentPosition),this._currentPosition.copy(l),this._offsetPosition.subVectors(this._currentPosition,this._startPosition);var c=this._currentPosition.clone();c.sub(this._lastPosition),this._traveledDist+=c.length();break;case"touchend":case"touchcancel":l=new e.Vector2(i-n.left,r-n.top);this.lastPosition.copy(this.currentPosition),this.deltaPosition.subVectors(l,this.currentPosition),this.currentPosition.copy(l),this.offsetPosition.subVectors(this.currentPosition,this.startPosition),l.set(i,r),this._lastPosition.copy(this._currentPosition),this._deltaPosition.subVectors(l,this._currentPosition),this._currentPosition.copy(l),this._offsetPosition.subVectors(this._currentPosition,this._startPosition);var h=new e.Vector2(this._currentPosition.x,this._currentPosition.y);h.sub(this._lastPosition),this._traveledDist+=h.length()}},getIdentifier:function(){return this.identifier},getTraveledDistance:function(){return this._traveledDist}});return UWA.namespace("THREEDS/Events/TouchEvent",i)}),define("VisuEvents/TouchEvent",["DS/VisuEvents/TouchEvent","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuEvents/TouchEvent"),e}),define("DS/Visualization/Filters/VisuFilter",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return class{constructor(){}}}),define("DS/Visualization/Filters/PolygonOffsetFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e,t){super(),this.factor=e,this.unit=t}enabled(){return 0!==this.factor&&0!==this.unit}}}),define("DS/Visualization/Filters/LookFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this.material=e,this.shadowReceive=-1,this.shadowCast=-1}usingShadowReceive(e){return this.shadowReceive=!0===e?1:!1===e?0:-1,this}usingShadowCast(e){return this.shadowCast=!0===e?1:!1===e?0:-1,this}}}),define("DS/Visualization/Filters/DoNotPickUnderFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this._doNotPickUnder=e}}}),define("DS/Shaders/NothingShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{uniforms:{tDiffuse:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","    gl_FragColor = texture2D( tDiffuse, vUv );","}"].join("\n")}}),define("Shaders/NothingShader",["DS/Shaders/NothingShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/NothingShader"),e}),define("DS/Visualization/WorldOrientation",["DS/Visualization/ThreeJS_DS"],function(e){var t=function(t){this._woName=t.name,this.upVector=t.upVector,this.rightVector=t.rightVector,this.frontVector=(new e.Vector3).crossVectors(this.rightVector,this.upVector),this.fromZUpMatrix=t.fromZUpMatrix,this.upAttribute=t.upAttribute,this.rightAttribute=t.rightAttribute,this.frontAttribute=t.frontAttribute,this._anglesOrderForLockedRotation=t.anglesOrderForLockedRotation,this._eulerOrderForReframe=t.eulerOrderForReframe};return t.prototype.getOrientationForLockedRotation=function(t,i,r){var n=this.upAttribute,a=this.rightAttribute,s=this.frontAttribute,o=this._anglesOrderForLockedRotation,l=(new e.Matrix4).makeRotationFromQuaternion(r),c=(new e.Vector3).setEulerFromRotationMatrix(l,o);return c[n]-=t,"y"===n?(c[a]-=i,c[s]=0):"z"===n&&(c[s]-=i,c[a]=0),(new e.Quaternion).setFromEuler(c,o)},t.prototype.getAxisForSideRotation=function(t){var i=new e.Vector3,r=this._eulerOrderForReframe;if("ZXY"!==r&&"YZX"!==r)throw"Unsupported euler order";return"right"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,Math.PI):"YZX"===r&&(i=new e.Vector3(0,.5*Math.PI,0)):"left"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,0):"YZX"===r&&(i=new e.Vector3(0,-.5*Math.PI,0)):"top"===t?"ZXY"===r?i=new e.Vector3(0,0,.5*Math.PI):"YZX"===r&&(i=new e.Vector3(-.5*Math.PI,0,0)):"bottom"===t?"ZXY"===r?i=new e.Vector3(Math.PI,0,.5*Math.PI):"YZX"===r&&(i=new e.Vector3(.5*Math.PI,0,0)):"front"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,.5*Math.PI):"YZX"===r&&(i=new e.Vector3(0,0,0)):"back"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,-.5*Math.PI):"YZX"===r&&(i=new e.Vector3(0,-Math.PI,0)):"iso"===t&&("ZXY"===r?i=new e.Vector3(.35*Math.PI,0,.75*Math.PI):"YZX"===r&&(i=new e.Vector3(-.15*Math.PI,.25*Math.PI,0))),i},t.prototype.buildSnapRobotMatrix=function(e){return"zup"===this._woName?this.buildSnapRobotMatrix_zup(e):"yup"===this._woName?this.buildSnapRobotMatrix_yup(e):void 0},t.prototype.buildSnapRobotMatrix_zup=function(t){var i,r=t.normal;r.normalize();var n=new e.Vector3(1,0,0).projectOnPlane(r),a=n.length(),s=new e.Vector3(0,1,0).projectOnPlane(r),o=s.length(),l=(new e.Vector3).crossVectors(new e.Vector3(0,0,1),r),c=new e.Vector3(0,0,1).dot(r);return Math.abs(c)>.999?Math.abs(a-o)<5e-4?(n.normalize(),s.normalize()):a<o?((s=new e.Vector3(0,1,0).projectOnPlane(r)).normalize(),n=(new e.Vector3).crossVectors(s,r).normalize()):((n=new e.Vector3(1,0,0).projectOnPlane(r)).normalize(),s=(new e.Vector3).crossVectors(r,n).normalize()):(n=l.normalize(),s=(new e.Vector3).crossVectors(r,n).normalize()),(i=new e.Matrix4(n.x,s.x,r.x,0,n.y,s.y,r.y,0,n.z,s.z,r.z,0,0,0,0,1)).setPosition(t.position),i},t.prototype.buildSnapRobotMatrix_yup=function(t){var i,r=t.normal;r.normalize();var n=new e.Vector3(0,0,1).projectOnPlane(r),a=n.length(),s=new e.Vector3(1,0,0).projectOnPlane(r),o=s.length(),l=(new e.Vector3).crossVectors(new e.Vector3(0,1,0),r),c=new e.Vector3(0,1,0).dot(r);return Math.abs(c)>.999?Math.abs(a-o)<5e-4?(n.normalize(),s.normalize()):a<o?((s=new e.Vector3(1,0,0).projectOnPlane(r)).normalize(),n=(new e.Vector3).crossVectors(s,r).normalize()):((n=new e.Vector3(0,0,1).projectOnPlane(r)).normalize(),s=(new e.Vector3).crossVectors(r,n).normalize()):(n=l.normalize(),s=(new e.Vector3).crossVectors(r,n).normalize()),(i=new e.Matrix4(s.x,r.x,n.x,0,s.y,r.y,n.y,0,s.z,r.z,n.z,0,0,0,0,1)).setPosition(t.position),i},{YUpXRight:new t({name:"yup",upVector:new e.Vector3(0,1,0),rightVector:new e.Vector3(1,0,0),fromZUpMatrix:(new e.Matrix4).setRotationFromEuler(new e.Vector3(-Math.PI/2,0,-Math.PI/2),"XYZ"),upAttribute:"y",rightAttribute:"x",frontAttribute:"z",anglesOrderForLockedRotation:"YZX",eulerOrderForReframe:"YZX"}),ZUpYRight:new t({name:"zup",upVector:new e.Vector3(0,0,1),rightVector:new e.Vector3(0,1,0),fromZUpMatrix:new e.Matrix4,upAttribute:"z",rightAttribute:"y",frontAttribute:"x",anglesOrderForLockedRotation:"ZYX",eulerOrderForReframe:"ZXY"})}}),define("DS/Plugins/ComposerContext",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=1,i=30;function r(e){!e&&i>0&&(console.warn("Rendering EffectComposer without specifying a result name"),i--)}var n=30,a=function(i,r,a,s){if(this.id=t++,void 0===i){var o=window.innerWidth||1,l=window.innerHeight||1;e.LinearFilter,e.LinearFilter,e.RGBFormat;i=new e.WebGLRenderTargetProperties(o,l,"uint")}this.renderTargetProperties=i,this.width=this.renderTargetProperties?this.renderTargetProperties.width:void 0,this.height=this.renderTargetProperties?this.renderTargetProperties.height:void 0,this.originalRenderTargetProperties=i,this.name=a,this.readBuffer=null,this.writeBuffer=null,this.renderResults={},this.usedBy=[],this.useCount=1,this.keepResult=!1,this.forceRenderTarget=s,this.passes=[],this.passStates=[],this.composer=r,r.contexts.push(this),this.needsUpdate=!0,this.cameras=[],this.updateStates(),this.onEffectComposerChange=null,Object.defineProperty(this,"renderTarget2",{get:function(){var e;for(e in n>0&&(console.warn("Accessing renderTarget2 deprecated property"),n--),this.renderResults)return this.renderResults[e];return null}}),this.beforeRenderCB=null,this.afterRenderCB=null,this.needRequiredReadBuffer=!1,this.cameraName="",this.clearReadBuffer=0,this.noIdCheck=!1,this.enableGSSOCache=!0,this._forbidRenderableState=0,this._checkCamera=!1};return a.prototype={getPassState:function(e){var t,i=this.passes.indexOf(e);return i<0&&e&&(i=this.passes.length,this.passes.push(e),(t=e.getDefaultState()).pass=e,this.passStates[i]=t),this.passStates[i]},updateStates:function(){var e,t=this.composer.getAllPasses(),i=[];for(e=0;e<t.length;e++)i.push(this.getPassState(t[e]));this.passes=t,this.passStates=i,this.onEffectComposerChange&&this.onEffectComposerChange(this)},setBeforeRenderCB:function(e){this.beforeRenderCB=e},setAfterRenderCB:function(e){this.afterRenderCB=e},enablePass:function(e,t){if(e){var i=this.getPassState(e);!!i.enabled!=!!t&&this.composer&&this.composer.renderer.resetGSSOCache(),i.enabled=t}},setAsLastPass:function(e,t){e&&(this.getPassState(e).isLastPass=t)},enableRenderCuttingElementsPasses:function(e){var t,i=0;for(i=0;i<this.passes.length;i++)(t=this.passes[i]).renderCuttingElements&&!t.disabledByDefault&&this.enablePass(t,e)},setPassClear:function(e,t,i,r){var n=this.getPassState(e);n.clear=t,void 0!==i&&(n.clearColor=i),void 0!==r&&(n.clearAlpha=r)},setPassRenderToCanvas:function(e,t){this.getPassState(e).renderToCanvas=t},setPassClearDepth:function(e,t){this.getPassState(e).doClearDepth=t},setRenderPlugins:function(e,t){this.getPassState(e).renderPlugins=t},setCamera:function(e,t){this.getPassState(e).camera=t},setCameraName:function(e){this.cameraName=e},setTransformCameraCB:function(e){this.transformCameraCB=e},clearReadBufferIfRequired:function(e,t){0!==this.clearReadBuffer&&(2!==this.clearReadBuffer&&e.pushRenderTarget(this.readBuffer),this.clearReadBuffer=0,this.readBuffer=null)},swapBuffers:function(e,t,i){var r=this.writeBuffer;this.writeBuffer=this.readBuffer,this.readBuffer=r,this.readBuffer||this.acquireReadBuffer(e,t),!this.writeBuffer&&i&&this.acquireWriteBuffer(e,t)},useWarmStart:function(e,t){var i=this.getPassState(e).warmStart[t];this.readBuffer&&(renderTargetPool.pushRenderTarget(this.readBuffer),this.readBuffer=null),this.readBuffer=i,this.clearReadBuffer=2},saveReadRenderTargetForLatterWarmStart:function(e,t,i){var r=this.getPassState(e);r.warmStart||(r.warmStart={});var n=r.warmStart[i];n&&t.pushRenderTarget(n),r.warmStart[i]=this.readBuffer,this.clearReadBuffer=2},changeRenderTargetProperties:function(e,t,i){this.clearReadBuffer=1,this.writeBuffer&&t.pushRenderTarget(this.writeBuffer,this),this.writeBuffer=null,e.width=this.width,e.height=this.height,this.renderTargetProperties=e,this.acquireWriteBuffer(t,i)},linkToShaderPassUniform:function(e,t){e.addLinkedEffectComposerContext(this),this.usedBy.indexOf(t)<0&&this.usedBy.push(t)},linkTo_internal:function(e,t,i){var n;for(this.noIdCheck||r(i),e.value=this.renderResults[i],n=0;n<this.usedBy.length;n++)if(this.usedBy[n]===e)return;this.usedBy.push(e)},removeLinks:function(){this.usedBy=[]},updateLinks:function(e){var t;for(this.noIdCheck||r(e),t=0;t<this.usedBy.length;t++)this.usedBy[t].value=this.forceRenderTarget?this.forceRenderTarget:this.renderResults[e]},restoreOriginalRenderTargetProperties:function(e,t){e.areRenderTargetOptionsEqual(this.renderTargetProperties,this.originalRenderTargetProperties)||(this.renderTargetProperties=this.originalRenderTargetProperties,this.renderResults[t]&&(e.pushRenderTarget(this.renderResults[t]),this.renderResults[t]=null))},acquireWriteBuffer:function(e,t){this.noIdCheck||r(t),this.renderTargetProperties&&(this.renderResults[t]?(this.writeBuffer=this.renderResults[t],this.renderResults[t]=null):this.writeBuffer||(this.writeBuffer=e.buildRenderTarget(this.renderTargetProperties.width,this.renderTargetProperties.height,this.renderTargetProperties.options||this.renderTargetProperties.optionsId,this)))},acquireReadBuffer:function(e,t){this.noIdCheck||r(t),this.renderTargetProperties&&(this.readBuffer||(this.readBuffer=e.buildRenderTarget(this.renderTargetProperties.width,this.renderTargetProperties.height,this.renderTargetProperties.options,this)))},getResult:function(e,t){var i=this.renderResults[e];return t&&(this.renderResults[e]=null),i},selectResult:function(e,t){this.renderResults[t]=this.writeBuffer,this.writeBuffer=null,this.renderResults[t]&&(this.renderResults[t].useCount=this.useCount),this.writeBuffer&&(e.pushRenderTarget(this.writeBuffer,this),this.writeBuffer=null),this.readBuffer&&(e.pushRenderTarget(this.readBuffer,this),this.readBuffer=null)},releaseRenderTargets:function(e,t){var i=this.renderResults[t];!this.keepResult&&i&&(i.useCount--,i.useCount<=0&&(e.pushRenderTarget(i,this),this.renderResults[t]=null))},setSize:function(e,t,i){if(this.width!==e||this.height!==t){var r,n;for(n=0;n<this.passStates.length;n++){void 0;var a=this.passes[n];a.requiredReadBuffer&&(a.requiredReadBuffer.dispose(),a.requiredReadBuffer=null)}for(r in this.renderResults)!this.renderResults[r]||i&&r!=i||this.renderResults[r].dispose();i||(this.renderResults={}),this.originalRenderTargetProperties&&(this.originalRenderTargetProperties.width=e,this.originalRenderTargetProperties.height=t),this.renderTargetProperties&&(this.renderTargetProperties.width=e,this.renderTargetProperties.height=t),this.forceRenderTarget&&this.forceRenderTarget.dispose(),this.forceRenderTarget=null,i||(this.readBuffer&&this.readBuffer.dispose(),this.readBuffer=null,this.writeBuffer&&this.writeBuffer.dispose(),this.writeBuffer=null),this.width=e,this.height=t}},dispose:function(){this.setSize(0,0)},setGSSOCache:function(e){this.enableGSSOCache=e},setOnEffectComposerChangeCallback:function(e){this.onEffectComposerChange=e,e&&e(this)}},a}),define("Plugins/ComposerContext",["DS/Plugins/ComposerContext","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Plugins/ComposerContext"),e}),define("DS/Plugins/EffectComposer",["DS/Visualization/ThreeJS_DS","DS/Plugins/ShaderPass","DS/Plugins/ComposerContext","DS/Plugins/ClearPass"],function(e,t,i,r){"use strict";var n="--\x3e";function a(e){var t=e.slice(n.length);return t.startsWith("(")&&t.endsWith(")")&&(t=t.slice(1,t.length-1),!0),{list:t,privateList:!1}}function s(e,t){var i,r,s,o,l="passes",c=!1,h=!1;if(t){if((i=t.indexOf(e.name))<0)throw new Error("unknown added pass");for(r=i;r>=0&&!c;r--)(s=t[r]).startsWith(n)&&(l=(o=a(s)).list,h=o.privateList,c=!0)}else i=e.order;return{order:i,list:l,privateList:h}}function o(e,t,i){e.splice.apply(e,[t,0].concat(i))}var l=function(e){this.name=e,this.preCustomPasses=[],this.passes=[],this.postCustomPasses=[],this.privateList=!1};l.prototype.addPass=function(e,t,i){if(this.passes.length&&void 0!==t)for(var r=0;r<this.passes.length;r++){if(t<s(this.passes[r],i).order)return void this.passes.splice(r,0,e)}this.passes.push(e)};var c=0,h=function(t,r,s,o){var h,u,d,p;if(this.renderer=t,this.renderTargetPool=s,this.orderedPassNames=o||null,this.id=c,c++,this.contexts=[],this.passLists=[],o)for(h=0;h<o.length;h++){var f;if((u=o[h]).startsWith(n))d=(p=a(u)).list,(f=new l(d)).privateList=p.privateList,this.passLists.push(f)}else this.passLists.push(new l("passes"));for(this.passListIndex={},h=0;h<this.passLists.length;h++)this.passListIndex[this.passLists[h].name]=h;this.preCustomPasses=[],this.postCustomPasses=[],this.camera=new e.OrthographicCamera(-1,1,1,-1,0,1),this.camera._renderingRole=e._CameraRoles.FULL_SCREEN,this.geometry=[e.createPlaneGeometryDS(2,2)],this.quad=new e.Mesh(this.geometry,null),this.quad.frustumCulled=!1,this.quad.visibilityFree=!0,this.shaderPassScene=new e.Scene,this.shaderPassScene.add(this.quad),this.renderScene=null,this.enabled=!0,this.composerContext=r?new i(r,this):null,this.bShareDepth=!1,this.needsCameraUpdate=!1,this.keepResult=!1};return h.prototype={dispose:function(){this.quad.dispose()},getAllPasses:function(e){var t,i,r=[];for(t=e=e||0;t<this.passLists.length;t++)(i=this.passLists[t]).preCustomPasses.length&&(r=r.concat(i.preCustomPasses)),r=r.concat(i.passes),i.postCustomPasses.length&&(r=r.concat(i.postCustomPasses));return r},setComposerContext:function(e){this.composerContext=e},updateComposerContexts:function(e){var t;for(t=0;t<this.contexts.length;t++)this.contexts[t].updateStates(e)},swapBuffers:function(e,t,i){this.composerContext.swapBuffers(e,t,i)},addPass:function(e){var t=s(e,this.orderedPassNames),i=t.order;this.passLists[this.passListIndex[t.list]].addPass(e,i,this.orderedPassNames),e.composer=this,this.updateComposerContexts()},insertPass:function(e,t,i){i.splice(t,0,e),e.composer=this,this.updateComposerContexts()},enablePass:function(e,t){this.composerContext.enablePass(e,t)},linkToShaderPassUniform:function(e,t,i){this.composerContext.linkToShaderPassUniform(e,t,i)},removeLinks:function(){this.composerContext.removeLinks()},updateScene:function(e){this.renderScene=e;var t,i,r=this.getAllPasses(),n=r.length;for(i=0;i<n;i++)(t=r[i]).setScene&&!t.lockScene&&t.setScene(e)},getRenderResult:function(e){return this.composerContext.renderResults[e]},findRequiredReabBuffer:function(e,i){if(!this.composerContext.needRequiredReadBuffer)return[{forceWriteBufferIndex:-1,requiredReadBuffer:null}];i=i||0;for(var r,n=this.getAllPasses(),a=n.length,s=-1,o=e,l=null,c=e;c<a;c++){if(r=n[c],c>=i&&r&&r.requiredReadBuffer&&this.composerContext.getPassState(r).enabled){l=r.requiredReadBuffer,-1===s&&(s=e),o=c;break}r instanceof t&&this.composerContext.getPassState(r).enabled&&(s=c)}l||(s=-1);var h=[{forceWriteBufferIndex:s,requiredReadBuffer:l}];return e!==o&&(h=h.concat(this.findRequiredReabBuffer(o,o+1))),h},render:function(e,t,i,n,a){if(this.enabled)if(this.composerContext.needsUpdate||!this.composerContext.keepResult){var s=this.renderer.info.renderTime;s.push(this.composerContext.name),this.renderer._forbidRenderableState|=this.composerContext._forbidRenderableState,this.composerContext.restoreOriginalRenderTargetProperties(this.renderTargetPool,n),this.composerContext.acquireWriteBuffer(this.renderTargetPool,n),void 0!==t&&this.composerContext.writeBuffer&&(this.composerContext.writeBuffer.activeCubeFace=t),this.composerContext.beforeRenderCB&&this.composerContext.beforeRenderCB(this.composerContext);var o,l,c,h,u=this.getAllPasses(),d=u.length,p=0;if(a){if((p=u.indexOf(a))<0)return void s.pop();this.composerContext.useWarmStart(a,n)}var f=!1,m=0===p,g=this.findRequiredReabBuffer(p),v=0,S=g[v++];for(l=p;l<d;l++){var _=null;if((o=u[l]).gammaCorrectionPass&&(f=!0),c=this.composerContext.getPassState(o),void 0!==o.clear&&(o.clear=c.clear,o.clearColor=c.clearColor,o.clearAlpha=c.clearAlpha),o.setClearDepth&&o.setClearDepth(c.doClearDepth),o.setRenderPluginsPre&&o.setRenderPluginsPre(c.renderPlugins),o.setRenderPluginsPost&&o.setRenderPluginsPost(c.renderPlugins),_=c.cameraName?c.cameraName:this.composerContext.cameraName?this.composerContext.cameraName:o.cameraName,c.isLastPass)break;if(c.enabled){var y=o.needsSwap&&p!==l&&!m;if(l===S.forceWriteBufferIndex?(this.composerContext.readBuffer&&this.renderTargetPool.pushRenderTarget(this.composerContext.readBuffer),this.composerContext.readBuffer=this.composerContext.writeBuffer,this.composerContext.writeBuffer=S.requiredReadBuffer,S=g[v++]):y&&this.swapBuffers(this.renderTargetPool,n,!o.changeRenderTargetProperties),o.changeRenderTargetProperties&&this.composerContext.changeRenderTargetProperties(o.changeRenderTargetProperties,this.renderTargetPool,n),o.enableWarmStart&&o!==a&&this.composerContext.saveReadRenderTargetForLatterWarmStart(o,this.renderTargetPool,n),o.setDisableToneMapping&&f&&o.setDisableToneMapping(!0),this.composerContext.forceRenderTarget?o.render(this.renderer,this.composerContext.readBuffer,this.composerContext.forceRenderTarget,e,m,this.composerContext,i,_,n,c.renderToCanvas):o.render(this.renderer,this.composerContext.readBuffer,this.composerContext.writeBuffer,e,m,this.composerContext,i,_,n,c.renderToCanvas),o.requiredReadBuffer&&(this.composerContext.clearReadBuffer=2),this.composerContext.clearReadBufferIfRequired(this.renderTargetPool,n),o instanceof r||(m=!1),o.linkedComposerContexts)for(h=0;h<o.linkedComposerContexts.length;h++)o.linkedComposerContexts[h].releaseRenderTargets(this.renderTargetPool,n)}}this.composerContext.selectResult(this.renderTargetPool,n),this.composerContext.releaseRenderTargets(this.renderTargetPool,n),this.composerContext.updateLinks(n),this.composerContext.afterRenderCB&&this.composerContext.afterRenderCB(this.composerContext),this.renderer._forbidRenderableState&=~this.composerContext._forbidRenderableState,s.pop()}else this.renderer.setRenderTarget(this.composerContext.renderResults[n])},setSize:function(e,t){this.composerContext&&this.composerContext.setSize(e,t)},insertCustomPassAfterPass:function(e,t){var i,r=this.passLists[this.passListIndex.main],n=r.preCustomPasses,a=r.postCustomPasses;if(e.setCustomPass(),t)if((i=n.indexOf(t))>=0)n.splice(i+1,0,e);else{if(!((i=a.indexOf(t))>=0))throw new Error("Reference custom pass not found");a.splice(i+1,0,e)}else a.splice(0,0,e);this.updateComposerContexts()},insertCustomPassBefore:function(e,t){var i,r=this.passLists[this.passListIndex.main],n=r.preCustomPasses,a=r.postCustomPasses;if(e.setCustomPass(),t)if((i=n.indexOf(t))>=0)n.splice(i,0,e);else{if(!((i=a.indexOf(t))>=0))throw new Error("Reference custom pass not found");a.splice(i,0,e)}else n.push(e);this.updateComposerContexts()},getPassList:function(e){return this.passLists[this.passListIndex[e]]},insertCustomPassBeforeNEW:function(e,t){if(!t)return!1;e instanceof Array||(e=[e]);var i,r,n,a,s,l=!1;if("string"==typeof t||t instanceof String){if((n=this.getPassList(t)).privateList)return!1;o(n.preCustomPasses,n.preCustomPasses.length-1,e)}else{for(i=0;i<this.passLists.length&&!l;i++)for(s=[(n=this.passLists[i]).preCustomPasses,n.postCustomPasses],r=0;r<s.length&&!l;r++)(a=s[r].indexOf(t))>=0&&(o(s[r],a,e),l=!0);if(!l)return console.warn("ERROR: Reference custom pass not found"),!1}for(i=0;i<e.length;i++)e[i].composer=this;return this.updateComposerContexts(),!0},insertCustomPassAfterNEW:function(e,t){if(!t)return!1;e instanceof Array||(e=[e]);var i,r,n,a,s,l=!1;if("string"==typeof t||t instanceof String){if((n=this.getPassList(t)).privateList)return!1;o(n.postCustomPasses,0,e)}else{for(i=0;i<this.passLists.length&&!l;i++)for(s=[(n=this.passLists[i]).preCustomPasses,n.postCustomPasses],r=0;r<s.length&&!l;r++)(a=s[r].indexOf(t))>=0&&(o(s[r],a+1,e),l=!0);if(!l)return console.warn("ERROR: Reference custom pass not found"),!1}for(i=0;i<e.length;i++)e[i].composer=this;return this.updateComposerContexts(),!0},removeCustomPassNEW:function(e){var t,i,r,n,a,s,o=e[0];for(t=0;t<this.passLists.length&&!n;t++)for(s=[(a=this.passLists[t]).preCustomPasses,a.postCustomPasses],i=0;i<s.length&&!n;i++)(r=s[i].indexOf(o))>=0&&(s[i].splice(r,e.length),n=!0);this.updateComposerContexts()},enableCustomPassNEW:function(e){var t,i,r;for(t=0;t<e.length;t++)for(i=e[t],r=0;r<this.contexts.length;r++)this.contexts[r].enablePass(i,!i.disabledByDefault);this.updateComposerContexts()},removePasses:function(e){var t,i,r,n,a,s;for(t=0;t<this.passLists.length&&!i;t++){for(r=this.passLists[t].passes,i=!1,a=0;a<e.length;a++)(n=r.indexOf(e[a]))>=0&&(i=!0,r[n]=null);if(i){for(s=0,a=0;a<r.length;a++)r[a]&&(r[s]=r[a],s++);r.length=s}}this.updateComposerContexts()},updateLinks:function(e){this.composerContext.updateLinks(e)},getPostEffectPasses:function(){var e=this.passListIndex.postEffects1,t=[],i=0;for(i=e;i<this.passLists.length;i++)i>e&&(t=t.concat(this.passLists[i].preCustomPasses)),t=(t=t.concat(this.passLists[i].passes)).concat(this.passLists[i].postCustomPasses);return t}},h}),define("Plugins/EffectComposer",["DS/Plugins/EffectComposer","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Plugins/EffectComposer"),e}),define("DS/Visualization/MaterialApplication",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";e.MaterialLayerUndefined=Number.MAX_SAFE_INTEGER||Math.pow(2,53)-1,e.MaterialLayerMax=e.MaterialLayerUndefined-1;var t=new e.Matrix3,i=new e.Matrix4,r=function(e){e=e||{},this.mappingType=-1,this.mappingObjTransformation=i,this.mappingUVTransformation=t,this.mappingUseFragment=!0,this.mappingNormTransformation=t,this.textureUVTransforms={normalUvTransform:t,bumpUvTransform:t,bumpScaleUvTransform:t,normalScaleUvTransform:t,displacementUvTransform:t,thicknessUvTransform:t,diffuseUvTransform:t,specularUvTransform:t,metalnessUvTransform:t,emissionColorUvTransform:t,specularContribUvTransform:t,transparencyUvTransform:t,opacityUvTransform:t,translucencyUvTransform:t,translucencyColorUvTransform:t,roughnessUvTransform:t,anisotropyUvTransform:t,anisotropyAngleUvTransform:t,sheenUvTransform:t,sheenRoughnessUvTransform:t,sheenColorUvTransform:t,clearCoatRoughnessUvTransform:t,clearCoatUvTransform:t,clearCoatNormalUvTransform:t,clearCoatColorUvTransform:t,flakesRoughnessUvTransform:t,flakesSizeUvTransform:t,flakesCoverageUvTransform:t,flakesColorUvTransform:t,flipFlopUvTransform:t,flipFlopColorUvTransform:t,iridescenceUvTransform:t,iridescenceThicknessUvTransform:t},this.textureUVSlots={normalUvSlot:1,bumpUvSlot:1,bumpScaleUvSlot:1,normalScaleUvSlot:1,displacementUvSlot:1,thicknessUvSlot:1,diffuseUvSlot:1,specularUvSlot:1,metalnessUvSlot:1,emissionColorUvSlot:1,specularContribUvSlot:1,transparencyUvSlot:1,opacityUvSlot:1,translucencyUvSlot:1,translucencyColorUvSlot:1,roughnessUvSlot:1,anisotropyUvSlot:1,anisotropyAngleUvSlot:1,sheenUvSlot:1,sheenRoughnessUvSlot:1,sheenColorUvSlot:1,clearCoatRoughnessUvSlot:1,clearCoatUvSlot:1,clearCoatNormalUvSlot:1,clearCoatColorUvSlot:1,flakesRoughnessUvSlot:1,flakesSizeUvSlot:1,flakesCoverageUvSlot:1,flakesColorUvSlot:1,flipFlopUvSlot:1,flipFlopColorUvSlot:1,iridescenceUvSlot:1,iridescenceThicknessUvSlot:1},this.mappingTransformSemantic=1,this._set(e)};r.prototype._set=function(r){if(void 0!==r.mappingType&&(this.mappingType=r.mappingType),void 0!==r.mappingObjTransformation&&(this.mappingObjTransformation=r.mappingObjTransformation,(null===this.mappingObjTransformation||this.mappingObjTransformation.isIdentity())&&(this.mappingObjTransformation=i)),void 0!==r.mappingUVTransformation&&(this.mappingUVTransformation=r.mappingUVTransformation,(null===this.mappingUVTransformation||this.mappingUVTransformation.isIdentity())&&(this.mappingUVTransformation=t)),void 0!==r.mappingUseFragment&&(this.mappingUseFragment=r.mappingUseFragment),void 0!==r.textureUVTransforms)for(var n in Object.assign(this.textureUVTransforms,r.textureUVTransforms),this.textureUVTransforms)(null===this.textureUVTransforms[n]||this.textureUVTransforms[n].isIdentity())&&(this.textureUVTransforms[n]=t);void 0!==r.textureUVSlots&&Object.assign(this.textureUVSlots,r.textureUVSlots),void 0!==r.mappingTransformSemantic&&(this.mappingTransformSemantic=r.mappingTransformSemantic),this.mappingObjTransformation&&(this.mappingObjTransformation!==i?this.mappingNormTransformation=(new e.Matrix3).getInverse(this.mappingObjTransformation).transpose():this.mappingNormTransformation=t)};var n=function(e){this.uvSlot=1,this.mode=1,this.linear=!0,this.texture=null,this.uvTransform=t,this._set(e)};n.prototype._set=function(e){void 0!==e.uvSlot&&(this.uvSlot=e.uvSlot),void 0!==e.mode&&(this.mode=e.mode),void 0!==e.linear&&(this.linear=e.linear),void 0!==e.texture&&(this.texture=e.texture),void 0!==e.uvTransform&&(this.uvTransform=e.uvTransform),(null===this.uvTransform||this.uvTransform.isIdentity())&&(this.uvTransform=t)};var a=function(t){this.isMatApp=!0,this._checkForceFlag=!1,this._material=null,this._materialGeomFace=null,this._materialLine=null,this._materialPoint=null,this._lightMap=null,this._mappingOperator=null,this._programID=0,this._inheritance=1,this._layer=e.MaterialLayerMax,this._depth=-1,this._enableDepth=!1,this.setParameters(t)};return a.prototype._dump=function(){return{layer:this.layer,inheritance:this._inheritance,material:this._material?this._material._dump():null,materialGeomFace:this._materialGeomFace?this._materialGeomFace._dump():null,materialLine:this._materialLine?this._materialLine._dump():null,materialPoint:this._materialPoint?this._materialPoint._dump():null,lightMap:!!this._lightMap&&!!this._lightMap.texture,defaultMapping:!this._mappingOperator||this._mappingOperator.mappingType<=0}},a.prototype.copy=function(e){this._checkForceFlag=e._checkForceFlag,this._material=e._material,this._materialGeomFace=e._materialGeomFace,this._materialLine=e._materialLine,this._materialPoint=e._materialPoint,this._lightMap=e._lightMap,this._mappingOperator=e._mappingOperator,this._programID=e._programID,this._inheritance=e._inheritance,this._layer=e._layer,this._depth=e._depth,this._enableDepth=e._enableDepth},a.prototype.clone=function(){var e=new a({faceMaterial:this._material,geometricalFaceMaterial:this._materialGeomFace,lineMaterial:this._materialLine,pointMaterial:this._materialPoint,inheritance:this._inheritance,lightMap:this._lightMap,layer:this._layer,mappingOperator:this._mappingOperator});return e._checkForceFlag=this._checkForceFlag,e._depth=this._depth,e._enableDepth=this._enableDepth,e},a.prototype.setParameters=function(t){t.faceMaterial&&(this._material=t.faceMaterial),t.geometricalFaceMaterial&&(this._materialGeomFace=t.geometricalFaceMaterial),t.lineMaterial&&(this._materialLine=t.lineMaterial),t.pointMaterial&&(this._materialPoint=t.pointMaterial),void 0!==t.inheritance&&(this._inheritance=t.inheritance),void 0!==t.layer&&(this._layer=t.layer),t.lightMap&&(this._lightMap=new n(t.lightMap)),t.mappingOperator&&(this._mappingOperator=new r(t.mappingOperator)),void 0!==t.enableDepth&&(this._enableDepth=t.enableDepth),this._lightMap&&this._lightMap.texture&&(this._programID|=e.ProgramIDs.LIGHT_MAP),this._mappingOperator&&(this._mappingOperator.mappingType>-1&&(this._programID|=e.ProgramIDs.MAPPING_OPERATOR),this._mappingOperator.mappingUseFragment?this._programID&=~e.ProgramIDs.MAPPING_OPERATOR_VERTEX:this._programID|=e.ProgramIDs.MAPPING_OPERATOR_VERTEX)},a.prototype.updateMappingOperator=function(t){if(null!==this._mappingOperator){t=t||{};var i={};Object.assign(i,this._mappingOperator),Object.assign(i,t),this._mappingOperator._set(i),this._mappingOperator&&(this._mappingOperator.mappingType>-1&&(this._programID|=e.ProgramIDs.MAPPING_OPERATOR),this._mappingOperator.mappingUseFragment?this._programID&=~e.ProgramIDs.MAPPING_OPERATOR_VERTEX:this._programID|=e.ProgramIDs.MAPPING_OPERATOR_VERTEX)}},a.prototype._getMaterialFromGLType=function(t,i){var r=null;if(4===t?r=i===e.GeomTypeEnum.FACE&&this._materialGeomFace?this._materialGeomFace:this._material:1===t?r=this._materialLine:0===t&&(r=this._materialPoint),this._checkForceFlag){if(this._material||this._materialGeomFace)return this._material&&this._material.force||this._materialGeomFace&&this._materialGeomFace.force?r:null;if(r&&!r.force)return null}return r},a.prototype.isPrioritary=function(t,i){if(!t)return!0;var r=this.getLayer(i),n=t.getLayer(i);return 0!==this._inheritance&&r===n&&r===e.MaterialLayerMax||0!==this._inheritance&&(r<n||r===n&&(r<e.MaterialLayerMax||2===this._inheritance||1===this._inheritance&&0===t._inheritance))},a.prototype.getLayer=function(t){var i=32768*(this._enableDepth?this._depth<0?t:this._depth:0)+this._layer;return i>e.MaterialLayerMax?e.MaterialLayerMax:i},a.prototype.solveInheritance=function(e,t){return this.isPrioritary(e,t)?this:e},a.prototype.getMaterial=function(e,t,i){throw new Error("coucou")},a.prototype.recompileShaders=function(e){for(var t=[this._material,this._materialGeomFace,this._materialLine,this._materialPoint],i=0;i<t.length;i++){var r=t[i];if(r&&(e&&e.onlyDeferred||(e&&e.callback&&e.callback(r),r.needsUpdate=!0),r._deferredMaterialsInit)){var n=r._deferredMaterials,a=e?e.deferredChannels:null;if(a&&a.length>0)for(var s=0;s<a.length;s++){(o=n[a[s]])&&(e&&e.callback&&e.callback(o),o.needsUpdate=!0)}else for(s=0;s<n.length;s++){var o;(o=n[s])&&(e&&e.callback&&e.callback(o),o.needsUpdate=!0)}}}},a.prototype._loadMappingOperatorUniforms=function(e,t,i){var r=e.program.uniformLocations;e._loadTextureInfo(this._mappingOperator.textureUVTransforms,this._mappingOperator.textureUVSlots,t,i,r,!0),e._loadMappingInfo(this._mappingOperator,t,i,r)},a}),define("DS/Visualization/GraphicAttributeSet",["DS/Visualization/ThreeJS_DS","DS/Visualization/MaterialManager","DS/Mesh/Mesh","DS/CoreEvents/Events"],function(e,t,i,r){"use strict";e.GASEnum={NO_INHERIT:0,RESET_INHERITANCE:0,HIGHLIGHT_INHERITANCE_ON:1,HIGHLIGHT_INHERITANCE_OFF:2,COLOR_INHERITANCE_ON:4,COLOR_INHERITANCE_OFF:8,LINEWIDTH_INHERITANCE_ON:16,LINEWIDTH_INHERITANCE_OFF:32,LINETYPE_INHERITANCE_ON:64,LINETYPE_INHERITANCE_OFF:128,BACKGROUND3DVIEWMODE_ON:256,BACKGROUND3DVIEWMODE_OFF:512,ASMCOLOR_INHERITANCE_ON:1024,ASMCOLOR_INHERITANCE_OFF:2048,ALPHA_INHERITANCE_ON:4096,ALPHA_INHERITANCE_OFF:8192,DEFAULTLOOK_INHERITANCE_ON:16384,DEFAULTLOOK_INHERITANCE_OFF:32768,TOP_PRIORITY_ON:65536,TOP_PRIORITY_OFF:131072,_2DMODE_INHERITANCE_ON:262144,_2DMODE_INHERITANCE_OFF:524288,SYMBOLTYPE_INHERITANCE_ON:1048576,SYMBOLTYPE_INHERITANCE_OFF:2097152,DIMENSION_INHERITANCE_ON:4194304,DIMENSION_INHERITANCE_OFF:8388608},e.GASEnum.COLOR_INHERIT=e.GASEnum.COLOR_INHERITANCE_ON,e.GASEnum.ALPHA_INHERIT=e.GASEnum.ALPHA_INHERITANCE_ON,e.GASEnum.LINEWIDTH_INHERIT=e.GASEnum.LINEWIDTH_INHERITANCE_ON,e.GASEnum.LINETYPE_INHERIT=e.GASEnum.LINETYPE_INHERITANCE_ON,e.GASEnum.ASMCOLOR_INHERIT=e.GASEnum.ASMCOLOR_INHERITANCE_ON,e.GASEnum.SYMBOLTYPE_INHERIT=e.GASEnum.SYMBOLTYPE_INHERITANCE_ON,e.GASEnum.RGBA_INHERITANCE_ON=e.GASEnum.COLOR_INHERITANCE_ON|e.GASEnum.ALPHA_INHERITANCE_ON,e.GASEnum.RGBA_INHERIT=e.GASEnum.RGBA_INHERITANCE_ON,e.GASEnum.RGBA_INHERITANCE_OFF=e.GASEnum.COLOR_INHERITANCE_OFF|e.GASEnum.ALPHA_INHERITANCE_OFF,e.GASTypeEnum={NOZ:0,EDGE:1,SKIN:2,VOLUME:3};var n=[0,0,0,.25999999046325684,.4000000059604645,.33000001311302185,1,.46000000834465027,0,1,1,1,1,0,0,0,1,0,0,.4000000059604645,1,.8600000143051147,.8600000143051147,0,.05999999865889549,.05999999865889549,.05999999865889549,.12999999523162842,.12999999523162842,.12999999523162842,.20000000298023224,.20000000298023224,.20000000298023224,.25999999046325684,.25999999046325684,.25999999046325684,.33000001311302185,.25999999046325684,.25999999046325684,.4000000059604645,.4000000059604645,.4000000059604645,.46000000834465027,.46000000834465027,.46000000834465027,.5299999713897705,.5299999713897705,.5299999713897705,.6000000238418579,.6000000238418579,.6000000238418579,.6600000262260437,.6600000262260437,.6600000262260437,.7300000190734863,.7300000190734863,.7300000190734863,.800000011920929,.800000011920929,.800000011920929,.8600000143051147,.8600000143051147,.8600000143051147,.9300000071525574,.9300000071525574,.9300000071525574,1,1,1,.05999999865889549,0,0,.12999999523162842,0,0,.20000000298023224,0,0,.25999999046325684,0,0,.25999999046325684,0,0,.4000000059604645,0,0,.46000000834465027,0,0,.5299999713897705,0,0,.6000000238418579,0,0,.6600000262260437,0,0,.7300000190734863,0,0,.800000011920929,0,0,.8600000143051147,0,0,.9300000071525574,0,0,1,0,0,0,.05999999865889549,0,0,.12999999523162842,0,0,.20000000298023224,0,0,.25999999046325684,0,0,.25999999046325684,0,0,.4000000059604645,0,0,.46000000834465027,0,0,.5299999713897705,0,0,.6000000238418579,0,0,.6600000262260437,0,0,.7300000190734863,0,0,.800000011920929,0,0,.8600000143051147,0,0,.9300000071525574,0,0,1,0,0,0,.05999999865889549,0,0,.12999999523162842,0,0,.20000000298023224,0,0,.25999999046325684,0,0,.25999999046325684,0,0,.4000000059604645,0,0,.46000000834465027,0,0,.5299999713897705,0,0,.6000000238418579,0,0,.6600000262260437,0,0,.7300000190734863,0,0,.800000011920929,0,0,.8600000143051147,0,0,.9300000071525574,0,0,1,.05999999865889549,.05999999865889549,0,.12999999523162842,.12999999523162842,0,.20000000298023224,.20000000298023224,0,.25999999046325684,.25999999046325684,0,.25999999046325684,.25999999046325684,0,.4000000059604645,.4000000059604645,0,.46000000834465027,.46000000834465027,0,.5299999713897705,.5299999713897705,0,.6000000238418579,.6000000238418579,0,.6600000262260437,.6600000262260437,0,.7300000190734863,.7300000190734863,0,.800000011920929,.800000011920929,0,.8600000143051147,.8600000143051147,0,.9300000071525574,.9300000071525574,0,1,1,0,.05999999865889549,0,.05999999865889549,.12999999523162842,0,.12999999523162842,.20000000298023224,0,.20000000298023224,.25999999046325684,0,.25999999046325684,.25999999046325684,0,.25999999046325684,.4000000059604645,0,.4000000059604645,.46000000834465027,0,.46000000834465027,.5299999713897705,0,.5299999713897705,.6000000238418579,0,.6000000238418579,.6600000262260437,0,.6600000262260437,.7300000190734863,0,.7300000190734863,.800000011920929,0,.800000011920929,.8600000143051147,0,.8600000143051147,.9300000071525574,0,.9300000071525574,1,0,1,0,.05999999865889549,.05999999865889549,0,.12999999523162842,.12999999523162842,0,.20000000298023224,.20000000298023224,0,.25999999046325684,.25999999046325684,0,.25999999046325684,.25999999046325684,0,.4000000059604645,.4000000059604645,0,.46000000834465027,.46000000834465027,0,.5299999713897705,.5299999713897705,0,.6000000238418579,.6000000238418579,0,.6600000262260437,.6600000262260437,0,.7300000190734863,.7300000190734863,0,.800000011920929,.800000011920929,0,.8600000143051147,.8600000143051147,0,.9300000071525574,.9300000071525574,0,1,1,.05999999865889549,.5,.5,.12999999523162842,.5,.5,.20000000298023224,.5,.5,.25999999046325684,.5,.5,.33000001311302185,.5,.5,.4000000059604645,.5,.5,.46000000834465027,.5,.5,.5299999713897705,.5,.5,.6000000238418579,.5,.5,.6600000262260437,.5,.5,.7300000190734863,.5,.5,.800000011920929,.5,.5,.8600000143051147,.5,.5,.9300000071525574,.5,.5,1,.5,.5,.5,.05999999865889549,.5,.5,.12999999523162842,.5,.5,.20000000298023224,.5,.5,.25999999046325684,.5,.5,.33000001311302185,.5,.5,.4000000059604645,.5,.5,.46000000834465027,.5,.5,.5299999713897705,.5,.5,.6000000238418579,.5,.5,.6600000262260437,.5,.5,.7300000190734863,.5,.5,.800000011920929,.5,.5,.8600000143051147,.5,.5,.9300000071525574,.5,.5,1,.5,.5,.5,.05999999865889549,.5,.5,.12999999523162842,.5,.5,.20000000298023224,.5,.5,.25999999046325684,.5,.5,.33000001311302185,.5,.5,.4000000059604645,.5,.5,.46000000834465027,.5,.5,.5299999713897705,.5,.5,.6000000238418579,.5,.5,.6600000262260437,.5,.5,.7300000190734863,.5,.5,.800000011920929,.5,.5,.8600000143051147,.5,.5,.9300000071525574,.5,.5,1,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,1,0,0,1,0,0,0,1,0,0,.8999999761581421,.8999999761581421,.8999999761581421,0,.8999999761581421,.8600000143051147,.8600000143051147,0,0,.4000000059604645,1,0,1,0,1,0,0,1,1,1,0,0,0,.8235294818878174,.8235294818878174,1,0,.7843137383460999,.7843137383460999,.26274511218070984,.4000000059604645,.3333333432674408,1,1,1,.2352941334247589,.40000003576278687,.501960813999176,0,0,0];e._colorMaps=new Map,e._getColorMap=function(t){if(e._colorMaps.has(t))return e._colorMaps.get(t);for(var i=new Array(256),r=0;r<i.length;r++){var a=n[3*r],s=n[3*r+1],o=n[3*r+2];i[r]=(new e.Color).setRGB(a,s,o)}return i[e.COLORMAP_INDEX.HIGHLIGHT]=(new e.Color).setRGB(0,.784313738,.784313738),i[e.COLORMAP_INDEX.LOWLIGHT]=(new e.Color).setRGB(.262745112,.400000006,.333333343),i[e.COLORMAP_INDEX.BACKGROUND]=(new e.Color).setRGB(.92549026,.92549026,.92549026),e._colorMaps.set(t,i),i},r.subscribe({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE"},function(t){var i=t.parameters,r=i.viewer.renderer.renderer,n=e._getColorMap(r);if(!(i.slot<0||i.slot>255))if(i.slot>=0)n[i.slot]=i.color;else for(var a=0;a<i.colorMap.length;a++)n[a]=i.colorMap[a]}),r.subscribe({event:"/VISU/VIEWER/VIEWER_DISPOSED"},function(t){var i=t.parameters.viewer.renderer.renderer;e._colorMaps.delete(i)}),e.COLORMAP_INDEX={EDGE_HIGHLIGHT:239,UPDATENEEDED:240,HANDLECOLOR:241,CYAN:242,MAGENTA:243,YELLOW:244,BLUE:245,GREEN:246,RED:247,WHITE:248,BLACK:249,PREHIGHLIGHT:250,HIGHLIGHT:251,LOWLIGHT:252,FOREGROUND:253,BACKGROUND:254,TRUECOLOR:255};const a=new e.Color(0);new e.Color(16448250);var s=[1,2,3,4,5,6,7,8,9],o=[9,9,9,9,5,7,9,3,2],l=new Float64Array(1),c=new Uint8Array(l.buffer),h=function(t){this._attr=0,this._rgba=0,this._color=null,this._colorSet=!1,this._colorIndex=e.COLORMAP_INDEX.TRUECOLOR,this._alpha=1,this._lineWidth=1,this._lineType=i.LinePatternEnum.SOLID,this._symbolType=i.PointSymbolEnum.DOT,this._basic=!1,this._lowlight=!1,this._highlight=!1,this._show=!0,this._showFree=!1,this._noPick=!1,this._transparent=!0,this._inheritance=e.GASEnum.RGBA_INHERITANCE_ON,this._type=e.GASTypeEnum.SKIN,this._priority=4,t&&t.NREInit&&(this._inheritance=e.GASEnum.NO_INHERIT),t&&this.setParameters(t)};Object.defineProperty(h.prototype,"_colorIndex",{get:function(){return l[0]=this._attr,c[0]},set:function(e){l[0]=this._attr,c[0]=e,this._attr=l[0]}}),Object.defineProperty(h.prototype,"_lineWidth",{get:function(){return l[0]=this._attr,c[1]},set:function(e){l[0]=this._attr,c[1]=e,this._attr=l[0]}}),Object.defineProperty(h.prototype,"_lineType",{get:function(){return l[0]=this._attr,c[2]},set:function(e){l[0]=this._attr,c[2]=e,this._attr=l[0]}}),Object.defineProperty(h.prototype,"_basic",{get:function(){return l[0]=this._attr,(1&c[3])>0},set:function(e){l[0]=this._attr,e?c[3]|=1:c[3]&=-2,this._attr=l[0]}}),Object.defineProperty(h.prototype,"_lowlight",{get:function(){return l[0]=this._attr,(2&c[3])>0},set:function(e){l[0]=this._attr,e?c[3]|=2:c[3]&=-3,this._attr=l[0]}}),Object.defineProperty(h.prototype,"_highlight",{get:function(){return l[0]=this._attr,(4&c[3])>0},set:function(e){l[0]=this._attr,e?c[3]|=4:c[3]&=-5,this._attr=l[0]}}),Object.defineProperty(h.prototype,"_noPick",{get:function(){return l[0]=this._attr,(8&c[3])>0},set:function(e){l[0]=this._attr,e?c[3]|=8:c[3]&=-9,this._attr=l[0]}}),Object.defineProperty(h.prototype,"_show",{get:function(){return l[0]=this._attr,(16&c[3])>0},set:function(e){l[0]=this._attr,e?c[3]|=16:c[3]&=-17,this._attr=l[0]}}),Object.defineProperty(h.prototype,"_showFree",{get:function(){return l[0]=this._attr,(32&c[3])>0},set:function(e){l[0]=this._attr,e?c[3]|=32:c[3]&=-33,this._attr=l[0]}}),Object.defineProperty(h.prototype,"_transparent",{get:function(){return l[0]=this._attr,(64&c[3])>0},set:function(e){l[0]=this._attr,e?c[3]|=64:c[3]&=-65,this._attr=l[0]}}),Object.defineProperty(h.prototype,"_colorSet",{get:function(){return l[0]=this._attr,(128&c[3])>0},set:function(e){l[0]=this._attr,e?c[3]|=128:c[3]&=-129,this._attr=l[0]}}),Object.defineProperty(h.prototype,"_type",{get:function(){return l[0]=this._attr,c[4]},set:function(e){l[0]=this._attr,c[4]=e,this._attr=l[0]}}),Object.defineProperty(h.prototype,"_priority",{get:function(){return l[0]=this._attr,c[5]},set:function(e){l[0]=this._attr,c[5]=e,this._attr=l[0]}}),Object.defineProperty(h.prototype,"_symbolType",{get:function(){return l[0]=this._attr,c[6]},set:function(e){l[0]=this._attr,c[6]=e,this._attr=l[0]}});var u=new e.Color;Object.defineProperty(h.prototype,"_color",{get:function(){return this._colorSet?(l[0]=this._rgba,u.setRGB(c[0]/255,c[1]/255,c[2]/255),u):null},set:function(e){this._colorSet=!!e,l[0]=this._rgba,c[0]=e?255*e.r:0,c[1]=e?255*e.g:0,c[2]=e?255*e.b:0,this._rgba=l[0]}}),Object.defineProperty(h.prototype,"_alpha",{get:function(){return l[0]=this._rgba,c[3]/255},set:function(e){l[0]=this._rgba,c[3]=255*e,this._rgba=l[0]}}),Object.defineProperty(h.prototype,"side",{get:function(){return this._type===e.GASTypeEnum.VOLUME?e.FrontSide:e.DoubleSide},set:function(t){this._type=t===e.FrontSide?e.GASTypeEnum.VOLUME:e.GASTypeEnum.SKIN}}),h._createFromGASAttributes=function(t){var i={colorRGB:t.color,colorA:t.opacity,side:1===t.solid?e.FrontSide:e.DoubleSide,inheritance:e.GASEnum.RGBA_INHERITANCE_ON};return t.lineWidth&&(i.lineWidth=t.lineWidth,i.inheritance|=e.GASEnum.LINEWIDTH_INHERITANCE_ON),t.linewidth&&(i.lineWidth=t.linewidth,i.inheritance|=e.GASEnum.LINEWIDTH_INHERITANCE_ON),t.pattern&&(i.lineType=t.pattern,i.inheritance|=e.GASEnum.LINETYPE_INHERITANCE_ON),void 0!==t.symbol&&(i.symbolType=t.symbol,i.inheritance|=e.GASEnum.SYMBOLTYPE_INHERITANCE_ON),new h(i)},h.prototype.isGAS=!0,h.prototype.setParameters=function(t){var i=this._doesInherit(e.GASEnum.SYMBOLTYPE_INHERITANCE_ON);void 0!==t.colorRGB&&(this._color=t.colorRGB),void 0!==t.colorIndex&&(this._colorIndex=t.colorIndex),void 0!==t.colorA&&(this._alpha=t.colorA),void 0!==t.lineWidth&&(this._lineWidth=t.lineWidth),void 0!==t.lineType&&(this._lineType=t.lineType),void 0!==t.symbolType&&(this._symbolType=t.symbolType),void 0!==t.side&&(this.side=t.side),void 0!==t.inheritance&&(this._inheritance=t.inheritance),void 0!==t.lowlight&&(this._lowlight=t.lowlight),void 0!==t.highlight&&(this._highlight=t.highlight),void 0!==t.noPick&&(this._noPick=t.noPick),void 0!==t.show&&(this._show=t.show),void 0!==t.showFree&&(this._showFree=t.showFree),void 0!==t.transparent&&(this._transparent=t.transparent),void 0!==t.type&&(this._type=t.type),void 0!==t.basic&&(this._basic=t.basic),void 0!==t.priority&&(this._priority=t.priority),void 0===t.inheritance&&(!1===t.defaultRGB?this._inheritance|=e.GASEnum.COLOR_INHERITANCE_ON:!0===t.defaultRGB&&(this._inheritance&=~e.GASEnum.COLOR_INHERITANCE_ON),!1===t.defaultO?this._inheritance|=e.GASEnum.ALPHA_INHERITANCE_ON:!0===t.defaultO&&(this._inheritance&=~e.GASEnum.ALPHA_INHERITANCE_ON),!1===t.defaultLineType?this._inheritance|=e.GASEnum.LINETYPE_INHERITANCE_ON:!0===t.defaultLineType&&(this._inheritance&=~e.GASEnum.LINETYPE_INHERITANCE_ON),!1===t.defaultLineWidth?this._inheritance|=e.GASEnum.LINEWIDTH_INHERITANCE_ON:!0===t.defaultLineWidth&&(this._inheritance&=~e.GASEnum.LINEWIDTH_INHERITANCE_ON)),!1===t.defaultPointType||i?this._inheritance|=e.GASEnum.SYMBOLTYPE_INHERITANCE_ON:!0===t.defaultPointType&&(this._inheritance&=~e.GASEnum.SYMBOLTYPE_INHERITANCE_ON)},h.prototype.merge=function(t,i){return!!i&&i.canBeUsed()?(i.getInheritance()&e.GASEnum.COLOR_INHERITANCE_ON)>0?(this._color=t._color,this._colorIndex=t._colorIndex,this._inheritance|=e.GASEnum.COLOR_INHERITANCE_ON,t._doesInherit(e.GASEnum.COLOR_INHERITANCE_ON)||(this._color=i._GAS._color,this._colorIndex=i._GAS._colorIndex)):(i.getInheritance()&e.GASEnum.ASMCOLOR_INHERITANCE_ON)>0&&(this._color=t._color,this._colorIndex=t._colorIndex,this._inheritance|=e.GASEnum.ASMCOLOR_INHERITANCE_ON,t._doesInherit(e.GASEnum.ASMCOLOR_INHERITANCE_ON)||(this._color=i._asmGAS._color,this._colorIndex=i._asmGAS._colorIndex)):(t._doesInherit(e.GASEnum.COLOR_INHERITANCE_ON)&&(this._color=t._color,this._colorIndex=t._colorIndex,this._inheritance|=e.GASEnum.COLOR_INHERITANCE_ON),t._doesInherit(e.GASEnum.ASMCOLOR_INHERITANCE_ON)&&(this._color=t._color,this._colorIndex=t._colorIndex,this._inheritance|=e.GASEnum.ASMCOLOR_INHERITANCE_ON)),t._doesInherit(e.GASEnum.ALPHA_INHERITANCE_ON)&&(this._alpha=t._alpha,this._transparent=t._transparent,this._inheritance|=e.GASEnum.ALPHA_INHERITANCE_ON),t._doesInherit(e.GASEnum.LINEWIDTH_INHERITANCE_ON)&&(this._lineWidth=t._lineWidth,this._inheritance|=e.GASEnum.LINEWIDTH_INHERITANCE_ON),t._doesInherit(e.GASEnum.LINETYPE_INHERITANCE_ON)&&(this._lineType=t._lineType,this._inheritance|=e.GASEnum.LINETYPE_INHERITANCE_ON),t._doesInherit(e.GASEnum.SYMBOLTYPE_INHERITANCE_ON)&&(this._symbolType=t._symbolType,this._inheritance|=e.GASEnum.SYMBOLTYPE_INHERITANCE_ON),t._doesInherit(e.GASEnum.DEFAULTLOOK_INHERITANCE_ON)&&(this._inheritance|=e.GASEnum.DEFAULTLOOK_INHERITANCE_ON),this._doesInherit(e.GASEnum.DIMENSION_INHERITANCE_ON)&&(this._type=t._type),this._lowlight=this._lowlight||t._lowlight,this._highlight=this._highlight||t._highlight,this},h.prototype.copy=function(e){this._inheritance=e._inheritance,this._rgba=e._rgba,this._attr=e._attr};var d=e.__visibleInCurrentSpaceSimple;return h.prototype.visibleInCurrentSpace=function(e,t){return d(e.visible&&this._show,e.visibilityFree||this._showFree,t,null)},h.prototype.clone=function(){var e=new h;return e.copy(this),e},h.prototype._dump=function(){var e=this.getJSON();return e.type="StructGAS",e},h.prototype.getPointSize=function(){var t=this._symbolType;return Math.round(o[t]*(e.getDevicePixelRatio()||1))},h.prototype.getMaterial=function(r,n,o,l,c){var h=new t,u={},d=r&&r.isGAS;if(u.opacity=1,this._doesInherit(e.GASEnum.ALPHA_INHERITANCE_ON)?u.opacity=this._transparent?this._alpha:1:r&&(u.opacity=d?r._transparent?r._alpha:1:r.opacity),this._doesInherit(e.GASEnum.COLOR_INHERITANCE_ON|e.GASEnum.ASMCOLOR_INHERITANCE_ON)?(u.color=this._color,this._colorIndex!==e.COLORMAP_INDEX.TRUECOLOR&&(u.color=e._getColorMap(l)[this._colorIndex])):r&&(u.color=d?r._color:r.color,d&&r._colorIndex!==e.COLORMAP_INDEX.TRUECOLOR&&(u.color=e._getColorMap(l)[r._colorIndex])),r?d||"Basic"!==r.getType()?d&&(u.basic=r._basic):(u.basic=!0,0===r.opacity&&(u.opacity=0)):u.basic=this._basic,o&&o._basic&&(u.basic=!0),n>1&&(r?d?r._doesInherit(e.GASEnum.DIMENSION_INHERITANCE_ON)?u.solid=this._type===e.GASTypeEnum.VOLUME?1:0:u.solid=r._type===e.GASTypeEnum.VOLUME?1:0:u.solid=r.side===e.FrontSide?1:0:u.solid=this._type===e.GASTypeEnum.VOLUME?1:0),1===n&&(u.lineWidth=1,this._doesInherit(e.GASEnum.ASMCOLOR_INHERITANCE_ON)&&(u.color=a,u.opacity=1),this._doesInherit(e.GASEnum.LINEWIDTH_INHERITANCE_ON)?u.lineWidth=this._lineWidth:r&&(u.lineWidth=d?r._lineWidth:r.lineWidth),u.lineWidth||(u.lineWidth=1),this._doesInherit(e.GASEnum.LINETYPE_INHERITANCE_ON)?u.pattern=this._lineType:r&&(u.pattern=d?r._lineType:r.dashPattern),u.pattern||(u.pattern=i.LinePatternEnum.SOLID)),0===n){var p=i.PointSymbolEnum.DOT;this._doesInherit(e.GASEnum.SYMBOLTYPE_INHERITANCE_ON)?p=this._symbolType:d&&(p=r._symbolType),u.symbol=s[p]}return(this._highlight||d&&r._highlight)&&(u.color=e._getColorMap(l)[e.COLORMAP_INDEX.HIGHLIGHT],u.opacity=1),(this._lowlight||d&&r._lowlight)&&(u.color=e._getColorMap(l)[e.COLORMAP_INDEX.LOWLIGHT],u.opacity=1),this._transparent||void 0===c||-1===c||(u.depthPriority=c),h.getMaterialFromGAS(u)},h.prototype.hasASMInherit=function(){return(this._inheritance&e.GASEnum.ASMCOLOR_INHERITANCE_ON)>0},h.prototype._doesInherit=function(e){return(this._inheritance&e)>0},h.prototype.__updateGAS=function(e){return e&&e.isGAS?(e.copy(this),e):this.__getGAS(e).clone()},h.prototype.__getGAS=function(e){return this},h.prototype.getJSON=function(){return{attr:this._attr,rgba:this._rgba}},(h.IncrementalGraphicAttributeSet=function(e){e=e||{},this.NREInit=!1,this.colorRGB=e.colorRGB,this.colorIndex=e.colorIndex,this.colorA=e.colorA,this.lineWidth=e.lineWidth,this.lineType=e.lineType,this.symbolType=e.symbolType,this.inheritance=e.inheritance,this.lowlight=e.lowlight,this.highlight=e.highlight,this.noPick=e.noPick,this.type=e.type,this.basic=e.basic,this.priority=e.priority,this.show=e.show,this.showFree=e.showFree,this.transparent=e.transparent,this.defaultRGB=e.defaultRGB,this.defaultO=e.defaultO,this.defaultLineType=e.defaultLineType,this.defaultLineWidth=e.defaultLineWidth,this.defaultPointType=e.defaultPointType}).prototype.usingNREInit=function(e){return this.NREInit=!!e,this},h.IncrementalGraphicAttributeSet.prototype.__getGAS=function(e){var t;return e&&e.isGAS?(t=e.clone()).setParameters(this):t=new h(this),t},h.IncrementalGraphicAttributeSet.prototype.__updateGAS=function(e){return e&&e.isGAS?(e.setParameters(this),e):this.__getGAS(e)},e.GraphicAttributeSet=h,h}),define("DS/Visualization/Filters/GASInheritFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter","DS/Visualization/GraphicAttributeSet"],function(e,t,i){"use strict";var r=new i({NREInit:!0});return class extends t{constructor(){super(),this._inheritance=e.GASEnum.NO_INHERIT,this._GAS=r,this._asmGAS=r}usingColorInherit(t,i){return null!==i&&(this._inheritance|=i?e.GASEnum.COLOR_INHERITANCE_ON:e.GASEnum.COLOR_INHERITANCE_OFF),this._GAS=t||r,this}usingASMColorInherit(t,i){return null!==i&&(this._inheritance|=i?e.GASEnum.ASMCOLOR_INHERITANCE_ON:e.GASEnum.ASMCOLOR_INHERITANCE_OFF),this._asmGAS=t||r,this}getInheritance(){return this._inheritance}canBeUsed(){return this._inheritance!==e.GASEnum.NO_INHERIT}}}),define("DS/Mesh/MeshUtils",["DS/Mesh/Mesh","DS/Visualization/ThreeJS_DS","DS/Visualization/MaterialManager","DS/Visualization/GraphicAttributeSet"],function(e,t,i,r){"use strict";return e.convertTo3jsGeometry=function(e,i){if(e.length){for(var r=[],n=null,a=null,s=new t.Sphere,o=new t.Box3,l=0;l<e.length;l++){var c=e[l],h=new t.BufferGeometryDS,u=new t.Vector3(c.AABB.min[0],c.AABB.min[1],c.AABB.min[2]),d=new t.Vector3(c.AABB.max[0],c.AABB.max[1],c.AABB.max[2]);null==n&&(n=u),null==a&&(a=d),u.x<n.x&&(n.x=u.x),u.y<n.y&&(n.y=u.y),u.z<n.z&&(n.z=u.z),d.x>a.x&&(a.x=d.x),d.y>a.y&&(a.y=d.y),d.z>a.z&&(a.z=d.z),o.set(n,a),s.radius=a.clone().sub(n).multiplyScalar(.5).length(),s.center=a.clone().add(n).multiplyScalar(.5);for(var p=0;p<c.drawingGroups.length;p++)c.drawingGroups[p].geometry=h;h.drawingGroups=c.drawingGroups,h.vertexPositionArray=c.vertexPositionArray,null!==c.vertexNormalArray&&(h.vertexNormalArray=c.vertexNormalArray),null!==c.vertexUvArray&&(h.vertexUvArray=c.vertexUvArray),c.vertexUv2Array&&(h.vertexUv2Array=c.vertexUv2Array),c.vertexTangentArray&&(h.vertexTangentArray=c.vertexTangentArray),c.vertexBinormalArray&&(h.vertexBinormalArray=c.vertexBinormalArray),h.vertexIndexArray=c.vertexIndexArray,r.push(h)}return r.boundingSphere=s,r.boundingBox=o,r}},e.convertTo3jsMesh=function(n,a,s,o,l,c){if(n.length){for(var h=window.newMaterialInheritance,u=null,d=[],p=null,f=null,m=new t.Sphere,g=new t.Box3,v=new i,S=!1,_=0;_<n.length;_++){var y=n[_],x=new t.BufferGeometryDS;x.editable=y.editable,void 0!==o&&(x.sharedBuffers=o),void 0!==l&&(x.noMeshInRAM=l);var M=new t.Vector3(y.AABB.min[0],y.AABB.min[1],y.AABB.min[2]),P=new t.Vector3(y.AABB.max[0],y.AABB.max[1],y.AABB.max[2]);null==p&&(p=M),null==f&&(f=P),M.x<p.x&&(p.x=M.x),M.y<p.y&&(p.y=M.y),M.z<p.z&&(p.z=M.z),P.x>f.x&&(f.x=P.x),P.y>f.y&&(f.y=P.y),P.z>f.z&&(f.z=P.z),g.set(p,f),m.radius=f.clone().sub(p).multiplyScalar(.5).length(),m.center=f.clone().add(p).multiplyScalar(.5);for(var C=0;C<y.drawingGroups.length;C++){var b=y.drawingGroups[C];if(S||0!==b._geomType&&(S=!0),b.geometry=x,void 0!==s&&s){var D=null,w=null,E=b.gas,T=b.material;if(T)b.gas=T;else if(null!==E)if(null!=w&&e.areEqualGraphicProperties(w,E))b.gas=D;else{var A=new t.Color;A.setRGB(E.color.r,E.color.g,E.color.b);var I={color:A,opacity:E.opacity};E.linewidth&&(console.warn("DEPRECATED : Use lineWidth (cameCase) instead of linewidth."),E.lineWidth=E.linewidth),E.lineWidth?(I.lineWidth=E.lineWidth,E.pattern&&(I.pattern=E.pattern)):E.pointsize?(I.symbol=0,I.size=E.pointsize):I.solid=E.solid,b.gas=h?r._createFromGASAttributes(I):v.getMaterialFromGAS(I),D=b.gas,w=E}}}x.drawingGroups=y.drawingGroups,c&&(x.decorations=c),x.vertexPositionArray=y.vertexPositionArray,null!==y.vertexNormalArray&&(x.vertexNormalArray=y.vertexNormalArray),null!==y.vertexColorArray&&(x.vertexColorArray=y.vertexColorArray),null!==y.vertexUvArray&&(x.vertexUvArray=y.vertexUvArray),y.vertexUv2Array&&(x.vertexUv2Array=y.vertexUv2Array),y.vertexTangentArray&&(x.vertexTangentArray=y.vertexTangentArray),y.vertexBinormalArray&&(x.vertexBinormalArray=y.vertexBinormalArray),x.vertexIndexArray=y.vertexIndexArray,a&&(a.isDashedLine||a.backMaterial&&a.backMaterial.isDashedLine)&&x.computeLineDistances(n.patternOffsets),d.push(x)}m.radius||(m.radius=.1),g.min.distanceToSquared(g.max)||g.expandByScalar(.1),d.boundingSphere=m,d.boundingBox=g,(u=new t.Mesh(d,a)).matrixAutoUpdate=!1,u.castShadow=!0,u.receiveShadow=!0;var R=new e.SGBag;return R.children.push(n[0].rep),n[0].rep.parents.push(R),u.sceneGraph=R,u.fromLoadedModel=S,u}},e.createEmptyMesh=function(){var e=new t.BufferGeometryDS;e.boundingSphere=new t.Sphere(new t.Vector3,0),e.boundingBox=new t.Box3;var i=t.MaterialUtils.createShinyFaceMaterial();return mesh=new t.Mesh(e,i),mesh.matrixAutoUpdate=!1,mesh.castShadow=!0,mesh.receiveShadow=!0,new THREEDS.Nodes.Mesh(mesh)},e.convertTo3js=function(e,i,r,n){var a,s=null,o=[],l=null,c=null,h=new t.Sphere,u=new t.Box3,d=new THREEDS.MaterialManager;d.cleanResources();for(var p=0;p<e.length;p++){var f=e[p],m=new t.BufferGeometryDS,g=new t.Vector3(f.AABB.min[0],f.AABB.min[1],f.AABB.min[2]),v=new t.Vector3(f.AABB.max[0],f.AABB.max[1],f.AABB.max[2]);null==l&&(l=g),null==c&&(c=v),g.x<l.x&&(l.x=g.x),g.y<l.y&&(l.y=g.y),g.z<l.z&&(l.z=g.z),v.x>c.x&&(c.x=v.x),v.y>c.y&&(c.y=v.y),v.z>c.z&&(c.z=v.z),u.set(l,c),h.radius=c.clone().sub(l).multiplyScalar(.5).length(),h.center=c.clone().add(l).multiplyScalar(.5);for(var S=0;S<f.drawingGroups.length;S++){f.drawingGroups[S].geometry=m;var _=f.drawingGroups[S].gas,y=f.drawingGroups[S].material;if(n&&null!==y&&!y.file&&-1!==y.id)null!=n[y.id]?a=n[y.id]:(a=d.getMaterialCgr(i[y.id],void 0,"CGR",r,f.drawingGroups[S]),n[y.id]=a),f.drawingGroups[S].gas=a;else if(null!==_&&_.color){var x=new t.Color;x.setRGB(_.color.r,_.color.g,_.color.b),f.drawingGroups[S].gas=d.getMaterialFromGAS({color:x,opacity:_.opacity,lineWidth:_.lineWidth?_.lineWidth:_.linewidth,solid:_.solid,symbol:_.symbol,basic:_.basic,resource:r})}}m.drawingGroups=f.drawingGroups,m.vertexPositionArray=f.vertexPositionArray,null!==f.vertexNormalArray&&(m.vertexNormalArray=f.vertexNormalArray),null!==f.vertexUvArray&&(m.vertexUvArray=f.vertexUvArray),f.vertexUv2Array&&(m.vertexUv2Array=f.vertexUv2Array),f.vertexTangentArray&&(m.vertexTangentArray=f.vertexTangentArray),f.vertexBinormalArray&&(m.vertexBinormalArray=f.vertexBinormalArray),m.vertexIndexArray=f.vertexIndexArray,o.push(m)}var M=new t.Color;M.setRGB(e[0].gas.fill.color.r,e[0].gas.fill.color.g,e[0].gas.fill.color.b);var P=new t.Color;return P.setRGB(e[0].gas.line.color.r,e[0].gas.line.color.g,e[0].gas.line.color.b),(y=d.getMaterialFromGAS({color:M,opacity:e[0].gas.fill.opacity,solid:e[0].gas.fill.solid,basic:e[0].gas.fill.basic})).line=d.getMaterialFromGAS({color:P,opacity:e[0].gas.line.opacity,lineWidth:e[0].gas.line.lineWidth?e[0].gas.line.lineWidth:e[0].gas.line.linewidth}),o.boundingSphere=h,o.boundingBox=u,(s=new t.Mesh(o,y)).matrixAutoUpdate=!1,s.castShadow=!0,s.receiveShadow=!0,e.length&&(s.sceneGraph=e[0].sceneGraph),new THREEDS.Nodes.Mesh(s)},e.mergeGeometries=function(t,i){if(!i)throw new"no clone link";t.invalidRatio=t.invalidRatio||0;for(var r=0,n=0,a=[],s=0,o=!1,l=!1,c=!1,h=!1,u=!1,d=!1,p=0;p<t.layers.length;p++){(g=t.layers[p].drawableInterval).layerNum<=0&&(s+=g.count)}for(p=0;p<t.geometries.length;p++){r+=(W=t.geometries[p]).vertexIndexArray.length,n+=W.vertexPositionArray.length,a[p]=W.vertexPositionArray.length,o=null!==W.vertexNormalArray,l=null!==W.vertexUvArray,c=null!==W.vertexUv2Array,h=null!==W.vertexColorArray,u=null!==W.vertexTangentArray,d=null!==W.vertexBinormalArray}if(!s&&!t.force)return null;if(!t.force&&s/r<t.invalidRatio)return null;var f=new e.SGPrimitiveHelper,m=[];for(p=0;p<t.layers.length;p++){var g,v=t.layers[p].drawableGroup;if(i.has(v)||i.set(v,new Map),(g=t.layers[p].drawableInterval).layerNum>0)for(var S=g.primitiveStart;S<g.primitiveStart+g.primitiveCount;S++)f.set(v,S),m.push(f.clone())}m.sort(function(e,t){var i=e.getGroup(),r=t.getGroup();return i.glType<r.glType?-1:i.glType>r.glType?1:i._geomType<r._geomType?-1:i._geomType>r._geomType?1:null===i.gas?-1:null===r.gas?1:i.gas.id<r.gas.id?-1:i.gas.id>r.gas.id?1:0});var _=[];for(p=0;p<a.length;p++){_[p]=new Int32Array(a[p]/3);for(S=0;S<_[p].length;S++)_[p][S]=-1}var y=[],x=[],M=[],P=[],C=[],b=[],D=[],w=[],E=[],T=[],A=Math.min(n,196608),I=Math.min(4*n/3,262144);x[0]=new Float32Array(A),M[0]=o?new Float32Array(A):null,P[0]=l?new Float32Array(A):null,C[0]=c?new Float32Array(A):null,b[0]=h?new Float32Array(I):null,D[0]=u?new Float32Array(A):null,w[0]=d?new Float32Array(A):null,E[0]=new Uint16Array(r);var R=(ee=m[0].getGroup()).glType,L=ee._geomType,O=ee.gas,N=[],F=[],V=[],U=0,B=0,k=0,G=0,z=0;for(p=0;p<m.length;p++){var H=m[p],W=(v=H.getGroup()).geometry,j=t.geometries instanceof Array?t.geometries.indexOf(W):0,X=W.vertexPositionArray,q=W.vertexNormalArray,Z=W.vertexUvArray,Y=W.vertexUv2Array,K=W.vertexColorArray,J=W.vertexTangentArray,Q=W.vertexBinormalArray,$=W.vertexIndexArray;if(B+H.getCount()>=65536){var ee=new e.DrawingGroup(O,O,R,k,z-k,void 0,void 0,L);N.push(ee);for(S=0;S<F.length;S++){var te=V[S];f.set(ee,ee._primitives.length),F[S].group=ee,ee._primitives.push(F[S]),i.get(te.container).set(te.index,f.clone())}F=[],V=[],T[U]=N,y[U]={index:z,data:B},R=v.glType,L=v._geomType,O=v.gas,N=[],B=0,k=0,G=0,z=0,A=196608,I=262144,x[++U]=new Float32Array(A),M[U]=o?new Float32Array(A):null,P[U]=l?new Float32Array(A):null,C[U]=c?new Float32Array(A):null,b[U]=h?new Float32Array(I):null,D[U]=u?new Float32Array(A):null,w[U]=d?new Float32Array(A):null,E[U]=new Uint16Array(r);for(var ie=0;ie<a.length;ie++)for(S=0;S<_[ie].length;S++)_[ie][S]=-1}else if(v.glType!==R||v.gas!==O||v._geomType!==L){ee=new e.DrawingGroup(O,O,R,k,z-k,void 0,void 0,L);R=v.glType,L=v._geomType,O=v.gas,N.push(ee),k=z;for(S=0;S<F.length;S++){te=V[S];f.set(ee,ee._primitives.length),F[S].group=ee,ee._primitives.push(F[S]),i.get(te.container).set(te.index,f.clone())}F=[],V=[]}G=z;for(S=0;S<H.getCount();S++){var re=$[H.getStart()+S],ne=_[j][re];if(-1===ne){for(var ae=0;ae<3;ae++)x[U][3*B+ae]=X[3*re+ae],o&&(M[U][3*B+ae]=q[3*re+ae]),l&&(P[U][3*B+ae]=Z[3*re+ae]),c&&(C[U][3*B+ae]=Y[3*re+ae]),u&&(D[U][3*B+ae]=J[3*re+ae]),d&&(w[U][3*B+ae]=Q[3*re+ae]);if(h)for(ae=0;ae<4;ae++)b[U][4*B+ae]=K[4*re+ae];_[j][re]=B,E[U][z++]=B,B++}else E[U][z++]=ne}var se=H._getSGPrimitive();se.start=G,F.push(se),V.push(H)}if(F.length>0){ee=new e.DrawingGroup(O,O,R,k,z-k,void 0,void 0,L);N.push(ee);for(S=0;S<F.length;S++){te=V[S];f.set(ee,ee._primitives.length),F[S].group=ee,ee._primitives.push(F[S]),i.get(te.container).set(te.index,f.clone())}F=[],V=[],T[U]=N,y[U]={index:z,data:B}}var oe=U+1,le=null;for(p=0;p<oe;p++){A=y[p];var ce=E[p],he=x[p],ue=M[p],de=(Z=P[p],Y=C[p],b[p]),pe=D[p],fe=w[p];if(A.index<ce.length){le=new Uint16Array(A.index);for(S=0;S<A.index;S++)le[S]=ce[S];E[p]=le}if(3*A.data<he.length){var me=3*A.data,ge=4*A.data;le=new Float32Array(me);for(S=0;S<me;S++)le[S]=he[S];if(x[p]=le,o){le=new Float32Array(me);for(S=0;S<me;S++)le[S]=ue[S];M[p]=le}if(l){le=new Float32Array(me);for(S=0;S<me;S++)le[S]=Z[S];P[p]=le}if(c){le=new Float32Array(me);for(S=0;S<me;S++)le[S]=Y[S];C[p]=le}if(h){le=new Float32Array(ge);for(S=0;S<ge;S++)le[S]=de[S];b[p]=le}if(u){le=new Float32Array(me);for(S=0;S<me;S++)le[S]=pe[S];D[p]=le}if(d){le=new Float32Array(me);for(S=0;S<me;S++)le[S]=fe[S];w[p]=le}}}var ve=[];for(p=0;p<oe;p++){var Se=new e.Mesh;Se.vertexPositionArray=x[p],Se.vertexNormalArray=M[p],Se.vertexUvArray=P[p],Se.vertexUv2Array=C[p],Se.vertexColorArray=b[p],Se.vertexTangentArray=D[p],Se.vertexBinormalArray=w[p],Se.vertexIndexArray=E[p],Se.drawingGroups=T[p];var _e=[0,0,0],ye=[0,0,0];if(x[p].length>=3){_e=[x[p][0],x[p][1],x[p][2]],ye=[x[p][0],x[p][1],x[p][2]];for(var xe=0;xe<x[p].length;xe+=3)x[p][xe]<_e[0]&&(_e[0]=x[p][xe]),x[p][xe+1]<_e[1]&&(_e[1]=x[p][xe+1]),x[p][xe+2]<_e[2]&&(_e[2]=x[p][xe+2]),x[p][xe]>ye[0]&&(ye[0]=x[p][xe]),x[p][xe+1]>ye[1]&&(ye[1]=x[p][xe+1]),x[p][xe+2]>ye[2]&&(ye[2]=x[p][xe+2])}Se.AABB={min:_e,max:ye},ve.push(Se)}return e.convertTo3jsGeometry(ve,null)},e.createCuboidMesh=function(t,i,r,n,a){var s=e._createCuboidMesh(t.corner,t.firstAxis,t.secondAxis,t.thirdLength,i,null);return e.convertTo3jsMesh([s],r,!1,n,a)},e.createCustomCylinderMesh=function(t,i,r,n,a){var s=new multiTabDecorations,o=e._createCustomCylindricalMesh(t.bottomCenter,t.topCenter,t.bottomRadius,t.topRadius,i,null,t.sag,!1,s);return e.convertTo3jsMesh([o],r,!1,n,a,s.getConcatenatedBlocks())},e.createCustomSphereMesh=function(t,i,r,n,a){var s=new multiTabDecorations,o=e._createCustomSphereMesh(t.parallelStart,t.parallelEnd,t.meridianStart,t.meridianEnd,t.center,t.firstAxis,t.secondAxis,i,null,t.sag,!1,s);return e.convertTo3jsMesh([o],r,!1,n,a,s.getConcatenatedBlocks())},e.createCurvedPipeMesh=function(i,r,n,a,s){for(var o=[],l=[],c=0,h=0;h<i.centers.length/3;h++)l.push(i.radius),o.push(new t.Vector3(i.centers[c++],i.centers[c++],i.centers[c++]));var u=new t.Vector3(i.startN[0],i.startN[1],i.startN[2]),d=new t.Vector3(i.endN[0],i.endN[1],i.endN[2]),p=e._createCurvedPipeMesh(o,l,u,d,!0,r,null,i.sag);return e.convertTo3jsMesh([p],n,!1,a,s)},e.createTorusMesh=function(i,r,n,a,s){var o=new multiTabDecorations,l=new t.Vector3(i.planeNormal[0],i.planeNormal[1],i.planeNormal[2]),c=l.length();l.normalize();var h=new t.Vector3(-i.planeNormal[2],i.planeNormal[0],-i.planeNormal[1]),u=new t.Vector3;u.crossVectors(l,h),u.normalize();var d=new t.Vector3;d.crossVectors(l,u),d.normalize(),u.multiplyScalar(c),d.multiplyScalar(c);for(var p=new t.Vector3(i.center[0],i.center[1],i.center[2]),f=e._buildCurvedPipeDataFromTorus(p,u,d,2*Math.PI,i.sag),m=[],g=[],v=0,S=0;S<f.centers.length/3;S++)g.push(i.minorRadius),m.push(new t.Vector3(f.centers[v++],f.centers[v++],f.centers[v++]));var _=new t.Vector3(f.startNormal[0],f.startNormal[1],f.startNormal[2]),y=e._createTorusMesh(p,m,g,_,r,null,i.sag,!1,o);return e.convertTo3jsMesh([y],n,!1,a,s,o.getConcatenatedBlocks())},e.createPartialTorusMesh=function(i,r,n,a,s){for(var o=new multiTabDecorations,l=new t.Vector3(i.center[0],i.center[1],i.center[2]),c=e._buildCurvedPipeDataFromTorus(l,new t.Vector3(i.firstAxis[0],i.firstAxis[1],i.firstAxis[2]),new t.Vector3(i.secondAxis[0],i.secondAxis[1],i.secondAxis[2]),i.majorAngle,i.sag),h=[],u=[],d=0,p=0;p<c.centers.length/3;p++)u.push(i.minorRadius),h.push(new t.Vector3(c.centers[d++],c.centers[d++],c.centers[d++]));var f=new t.Vector3(c.startNormal[0],c.startNormal[1],c.startNormal[2]),m=new t.Vector3(c.endNormal[0],c.endNormal[1],c.endNormal[2]),g=e._createCurvedPipeMesh(h,u,f,m,!0,r,null,i.sag,!1,o,i);return e.convertTo3jsMesh([g],n,!1,a,s,o.getConcatenatedBlocks())},e}),define("Mesh/MeshUtils",["DS/Mesh/MeshUtils","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Mesh/MeshUtils"),e}),define("DS/Visualization/GeometryHelper",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],function(e,t,i){"use strict";var r=document.createElement("canvas");r.width=512,r.height=64;var n=e.extend({init:function(){return this},CreateVis3DCuboid:function(e,r,n,a,s,o,l){var c,h,u,d,p,f,m,g,v,S,_,y,x,M,P,C;if(e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.fill=void 0!==o?o:1,this.cornerPoint=void 0!==e?e:new t.Vector3(0,0,0),this.firstAxis=void 0!==r?r:new t.Vector3(1,0,0),this.secondAxis=void 0!==n?n:new t.Vector3(0,1,0),this.thirdAxis=void 0!==a?a:new t.Vector3(0,0,1),this.color=void 0!==s?s:new i.Color(.5,.5,.5,1),C=l||0):(this.fill=void 0!==e.fill?e.fill:1,this.cornerPoint=void 0!==e.cornerPoint?e.cornerPoint:new t.Vector3(0,0,0),this.firstAxis=void 0!==e.firstAxis?e.firstAxis:new t.Vector3(1,0,0),this.secondAxis=void 0!==e.secondAxis?e.secondAxis:new t.Vector3(0,1,0),this.thirdAxis=void 0!==e.thirdAxis?e.thirdAxis:new t.Vector3(0,0,1),this.color=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),C=e.layerNb?e.layerNb:0),(c=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,c.lineAttr=new i.LineAttributes,c.pointAttr=new i.PointAttributes,(h=new i.Buffer).size=24,h.component=i.VertexComponentEnum.POSITION,h.format=i.DataTypeEnum.FLOAT,h.dimension=3,h.data=new Float32Array(24),(u=new i.Buffer).size=18,u.component=i.VertexComponentEnum.NORMAL,u.format=i.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(18),(d=new i.Buffer).size=12,d.component=i.VertexComponentEnum.TEX_COORD_0,d.format=i.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(12),(p=new i.Buffer).indexBuffer=!0,p.size=24,p.format=i.DataTypeEnum.UINT,p.dimension=1,p.data=new Uint16Array(24),(f=new i.Buffer).indexBuffer=!0,f.size=24,f.format=i.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(24),(m=new i.Buffer).indexBuffer=!0,m.size=24,m.format=i.DataTypeEnum.UINT,m.dimension=1,m.data=new Uint16Array(24),c.addBuffer(0,h),c.addBuffer(1,u),c.addBuffer(2,d),c.addBuffer(3,p),c.addBuffer(4,f),c.addBuffer(5,m),g=h.data,v=0,(_=new t.Vector3).addVectors(this.cornerPoint,this.thirdAxis),g[v++]=_.x,g[v++]=_.y,g[v++]=_.z,_.add(this.firstAxis),g[v++]=_.x,g[v++]=_.y,g[v++]=_.z,_.add(this.secondAxis),g[v++]=_.x,g[v++]=_.y,g[v++]=_.z,_.addVectors(this.cornerPoint,this.thirdAxis),_.add(this.secondAxis),g[v++]=_.x,g[v++]=_.y,g[v++]=_.z,_.addVectors(this.cornerPoint,this.secondAxis),g[v++]=_.x,g[v++]=_.y,g[v++]=_.z,_.add(this.firstAxis),g[v++]=_.x,g[v++]=_.y,g[v++]=_.z,_.addVectors(this.cornerPoint,this.firstAxis),g[v++]=_.x,g[v++]=_.y,g[v++]=_.z,g[v++]=this.cornerPoint.x,g[v++]=this.cornerPoint.y,g[v++]=this.cornerPoint.z,this.fill){for(v=0,S=0,(g=p.data)[v++]=0,g[v++]=1,g[v++]=3,g[v++]=2,g[v++]=4,g[v++]=5,g[v++]=7,g[v++]=6,g[v++]=0,g[v++]=3,g[v++]=7,g[v++]=4,g[v++]=6,g[v++]=5,g[v++]=1,g[v++]=2,g[v++]=5,g[v++]=4,g[v++]=2,g[v++]=3,g[v++]=7,g[v++]=6,g[v++]=0,g[v++]=1,g=f.data,v=0,S=0;S<6;S++)g[v++]=S,g[v++]=S,g[v++]=S,g[v++]=S;for(g=m.data,v=0,S=0;S<6;S++)g[v++]=2,g[v++]=3,g[v++]=0,g[v++]=1,g[v++]=1,g[v++]=0,g[v++]=3,g[v++]=2,g[v++]=3,g[v++]=1,g[v++]=2,g[v++]=0,g[v++]=3,g[v++]=1,g[v++]=2,g[v++]=0,g[v++]=1,g[v++]=0,g[v++]=3,g[v++]=2,g[v++]=2,g[v++]=3,g[v++]=0,g[v++]=1;v=0,(g=u.data)[v++]=0,g[v++]=0,g[v++]=1,g[v++]=0,g[v++]=0,g[v++]=-1,g[v++]=-1,g[v++]=0,g[v++]=0,g[v++]=1,g[v++]=0,g[v++]=0,g[v++]=0,g[v++]=1,g[v++]=0,g[v++]=0,g[v++]=-1,g[v++]=0,v=0,(g=d.data)[v++]=0,g[v++]=0,g[v++]=0,g[v++]=1,g[v++]=0,g[v++]=0,g[v++]=0,g[v++]=1,g[v++]=0,g[v++]=1,g[v++]=1,g[v++]=0}else v=0,S=0,(g=p.data)[v++]=0,g[v++]=3,g[v++]=3,g[v++]=2,g[v++]=2,g[v++]=1,g[v++]=1,g[v++]=0,g[v++]=7,g[v++]=4,g[v++]=4,g[v++]=5,g[v++]=5,g[v++]=6,g[v++]=6,g[v++]=7,g[v++]=0,g[v++]=7,g[v++]=3,g[v++]=4,g[v++]=2,g[v++]=5,g[v++]=1,g[v++]=6;for(S=0;S<6;S++)(y=new i.Primitive).nbIndices=4,y.connectivity=this.fill?i.ConnectivityTypeEnum.TRIANGLE_STRIP:i.ConnectivityTypeEnum.LINES,y.attr={fill:new i.FillAttributes(this.color,1),line:new i.LineAttributes,point:new i.PointAttributes},(x=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,x.nbVertices=4,x.nbValuesPerVertex=3,x.format=i.DataTypeEnum.FLOAT,x.cardinality=0,x.bufferId=0,x.indices=new i.IndexArray,x.indices.format=i.DataTypeEnum.UINT,x.indices.bufferId=3,x.indices.offset=4*S,y.addVertexComponent(x),this.fill&&((M=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,M.nbVertices=4,M.nbValuesPerVertex=3,M.format=i.DataTypeEnum.FLOAT,M.cardinality=0,M.bufferId=1,M.indices=new i.IndexArray,M.indices.format=i.DataTypeEnum.UINT,M.indices.bufferId=4,M.indices.offset=4*S,(P=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,P.nbVertices=4,P.nbValuesPerVertex=3,P.format=i.DataTypeEnum.FLOAT,P.cardinality=0,P.bufferId=2,P.indices=new i.IndexArray,P.indices.format=i.DataTypeEnum.UINT,P.indices.bufferId=5,P.indices.offset=4*S,y.addVertexComponent(M),y.addVertexComponent(P)),c.addPrimitive(y);return c.noz=C>0,c},CreateVis3DSphere:function(e,r,n,a,s,o,l,c,h){var u,d,p,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E,T,A,I,R,L,O,N,F,V,U,B,k=!1;for(e instanceof t.Matrix4||void 0===e?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.matrix=void 0!==e?e:null,this.radius=void 0!==r?r:1,this.meridianStart=void 0!==n?n:0,this.meridianEnd=void 0!==a?a:2*Math.PI,this.parallelStart=void 0!==s?s:0,this.parallelEnd=void 0!==o?o:2*Math.PI,this.sag=void 0!==l?l:80,O=void 0!==c?c:new i.Color(.5,.5,.5,1),B=h||0):(this.matrix=void 0!==e.matrix?e.matrix:null,this.radius=void 0!==e.radius?e.radius:1,this.meridianStart=void 0!==e.meridianStart?e.meridianStart:0,this.meridianEnd=void 0!==e.meridianEnd?e.meridianEnd:2*Math.PI,this.parallelStart=void 0!==e.parallelStart?e.parallelStart:0,this.parallelEnd=void 0!==e.parallelEnd?e.parallelEnd:2*Math.PI,this.sag=void 0!==e.sag?e.sag:80,O=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),B=e.layerNb?e.layerNb:0,k=!!e.tgtBinorm&&e.tgtBinorm),this.parallelStart<0&&(this.parallelStart=0),this.parallelStart>Math.PI&&(this.parallelStart=Math.PI),(u=this.parallelEnd-this.parallelStart)<0&&(u=0),this.parallelStart+u>Math.PI&&(u=Math.PI-this.parallelStart),this.meridianStart<0&&(this.meridianStart=0),this.meridianStart>2*Math.PI&&(this.meridianStart=2*Math.PI),(d=this.meridianEnd-this.meridianStart)<0&&(d=0),this.meridianStart+d>2*Math.PI&&(d=2*Math.PI-this.meridianStart),p=3*(this.sag+1)*this.sag,f=6*this.sag*(this.sag-1),(m=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,m.lineAttr=new i.LineAttributes,m.pointAttr=new i.PointAttributes,(g=new i.Buffer).size=3*p,g.component=i.VertexComponentEnum.POSITION,g.format=i.DataTypeEnum.FLOAT,g.dimension=3,g.data=new Float32Array(g.size),(v=new i.Buffer).size=3*p,v.component=i.VertexComponentEnum.NORMAL,v.format=i.DataTypeEnum.FLOAT,v.dimension=3,v.data=new Float32Array(v.size),(S=new i.Buffer).size=3*p,S.component=i.VertexComponentEnum.TEX_COORD_0,S.format=i.DataTypeEnum.FLOAT,S.dimension=3,S.data=new Float32Array(S.size),k&&((_=new i.Buffer).size=3*p,_.component=i.VertexComponentEnum.TEX_COORD_2,_.format=i.DataTypeEnum.FLOAT,_.dimension=3,_.data=new Float32Array(_.size),(y=new i.Buffer).size=3*p,y.component=i.VertexComponentEnum.TEX_COORD_3,y.format=i.DataTypeEnum.FLOAT,y.dimension=3,y.data=new Float32Array(y.size),m.addBuffer(5,_),m.addBuffer(6,y)),(x=new i.Buffer).indexBuffer=!0,x.size=f,x.format=i.DataTypeEnum.UINT,x.dimension=1,x.data=new Uint16Array(x.size),m.addBuffer(0,g),m.addBuffer(1,v),m.addBuffer(2,S),m.addBuffer(3,x),M=x.data,w=0,E=0;E<this.sag-1;E++)for(T=0;T<this.sag;T++)M[w++]=E*(this.sag+1)+T,M[w++]=(E+1)*(this.sag+1)+T,M[w++]=(E+1)*(this.sag+1)+T+1,M[w++]=E*(this.sag+1)+T,M[w++]=(E+1)*(this.sag+1)+T+1,M[w++]=E*(this.sag+1)+T+1;for(M=g.data,P=v.data,C=S.data,k&&(b=_.data,D=y.data),w=0,A=1/(this.sag-1),I=new t.Vector3,E=0;E<this.sag;E++)for(R=E*A,T=0;T<=this.sag;T++,w+=3)L=T/this.sag,P[w]=Math.sin(this.parallelStart+R*u)*Math.cos(this.meridianStart+L*d),I.x=this.radius*P[w],C[w]=T/this.sag,P[w+1]=Math.sin(this.parallelStart+R*u)*Math.sin(this.meridianStart+L*d),I.y=this.radius*P[w+1],C[w+1]=E/this.sag,P[w+2]=Math.cos(this.parallelStart+R*u),I.z=this.radius*P[w+2],C[w+2]=0,k&&(b[w]=P[w+1],b[w+1]=-P[w],b[w+2]=0,D[w]=P[w]*P[w+2],D[w+1]=P[w+1]*P[w+2],D[w+2]=-P[w]*P[w]-P[w+1]*P[w+1]),this.matrix&&I.applyMatrix4(this.matrix),M[w]=I.x,M[w+1]=I.y,M[w+2]=I.z;if((N=new i.Primitive).nbIndices=f,N.connectivity=i.ConnectivityTypeEnum.TRIANGLES,N.attr={fill:new i.FillAttributes(O,1),line:new i.LineAttributes,point:new i.PointAttributes},(F=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,F.nbVertices=p,F.nbValuesPerVertex=3,F.format=i.DataTypeEnum.FLOAT,F.cardinality=0,F.bufferId=0,F.indices=new i.IndexArray,F.indices.format=i.DataTypeEnum.UINT,F.indices.bufferId=3,F.indices.offset=0,(V=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,V.nbVertices=p,V.nbValuesPerVertex=3,V.format=i.DataTypeEnum.FLOAT,V.cardinality=0,V.bufferId=1,V.indices=new i.IndexArray,V.indices.format=i.DataTypeEnum.UINT,V.indices.bufferId=3,V.indices.offset=0,(U=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,U.nbVertices=p,U.nbValuesPerVertex=3,U.format=i.DataTypeEnum.FLOAT,U.cardinality=0,U.bufferId=2,U.indices=new i.IndexArray,U.indices.format=i.DataTypeEnum.UINT,U.indices.bufferId=3,U.indices.offset=0,N.addVertexComponent(F),N.addVertexComponent(V),N.addVertexComponent(U),k){var G=new i.VertexComponent;G.component=i.VertexComponentEnum.TEX_COORD_2,G.nbVertices=p,G.nbValuesPerVertex=3,G.format=i.DataTypeEnum.FLOAT,G.cardinality=0,G.bufferId=5,G.indices=new i.IndexArray,G.indices.format=i.DataTypeEnum.UINT,G.indices.bufferId=3,G.indices.offset=0;var z=new i.VertexComponent;z.component=i.VertexComponentEnum.TEX_COORD_3,z.nbVertices=p,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=6,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=0,N.addVertexComponent(G),N.addVertexComponent(z)}return m.addPrimitive(N),m.noz=B>0,m},CreateVis3DTube:function(e,r,n,a,s,o,l){var c,h,u,d,p,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E,T,A,I,R,L,O,N,F,V;if(e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),c=e,(h=new t.Vector3(0,0,0)).addVectors(e,r),u=a||1,d=n||1,A=void 0!==o?o:new i.Color(.2,.8,.2,1),F=l||0,V=s):(c=e.bottomCenterPoint,(h=new t.Vector3(0,0,0)).addVectors(e.bottomCenterPoint,e.extrusionVector),u=e.externalRadius?e.externalRadius:1,d=e.internalRadius?e.internalRadius:1,V=e.sag?e.sag:0,A=void 0!==e.color?e.color:new i.Color(.2,.8,.2,1),F=e.layerNb?e.layerNb:0),d===u)return this.CreateVis3DCylinderCustom({bottomCenterPoint:c,topCenterPoint:h,bottomRadius:u,topRadius:u,sag:V,bottomCap:!1,topCap:!1,internal:!1,layerNb:F});p=this.CreateVis3DCylinderCustom({bottomCenterPoint:c,topCenterPoint:h,bottomRadius:u,topRadius:u,sag:V,bottomCap:!1,topCap:!1,internal:!1,layerNb:F}),f=this.CreateVis3DCylinderCustom({bottomCenterPoint:c,topCenterPoint:h,bottomRadius:d,topRadius:d,sag:V,bottomCap:!1,topCap:!1,internal:!0,layerNb:F}),m=3*(V+1)*8,g=3*(V+1)*8,v=24*V,(S=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,S.lineAttr=new i.LineAttributes,S.pointAttr=new i.PointAttributes,(_=new i.Buffer).size=m,_.component=i.VertexComponentEnum.POSITION,_.format=i.DataTypeEnum.FLOAT,_.dimension=3,_.data=new Float32Array(_.size),(y=new i.Buffer).size=g,y.component=i.VertexComponentEnum.NORMAL,y.format=i.DataTypeEnum.FLOAT,y.dimension=3,y.data=new Float32Array(y.size),(x=new i.Buffer).size=m,x.component=i.VertexComponentEnum.TEX_COORD_0,x.format=i.DataTypeEnum.FLOAT,x.dimension=3,x.data=new Float32Array(x.size),(M=new i.Buffer).indexBuffer=!0,M.size=v,M.format=i.DataTypeEnum.UINT,M.dimension=1,M.data=new Uint16Array(M.size),_.data.set(p.buffers[0].data.subarray(0,6*(V+1)),0),_.data.set(f.buffers[0].data.subarray(0,6*(V+1)),6*(V+1)),_.data.set(p.buffers[0].data.subarray(0,3*(V+1)),12*(V+1)),_.data.set(f.buffers[0].data.subarray(0,3*(V+1)),15*(V+1)),_.data.set(p.buffers[0].data.subarray(3*(V+1),6*(V+1)),18*(V+1)),_.data.set(f.buffers[0].data.subarray(3*(V+1),6*(V+1)),21*(V+1)),x.data.set(p.buffers[2].data.subarray(0,6*(V+1)),0),x.data.set(f.buffers[2].data.subarray(0,6*(V+1)),6*(V+1)),x.data.set(p.buffers[2].data.subarray(0,3*(V+1)),12*(V+1)),x.data.set(f.buffers[2].data.subarray(0,3*(V+1)),15*(V+1)),x.data.set(p.buffers[2].data.subarray(3*(V+1),6*(V+1)),18*(V+1)),x.data.set(f.buffers[2].data.subarray(3*(V+1),6*(V+1)),21*(V+1)),y.data.set(p.buffers[1].data.subarray(0,3*(V+1)*2),0),y.data.set(f.buffers[1].data.subarray(0,3*(V+1)*2),3*(V+1)*2),P=3*(V+1)*4;for(var U=0;U<2*(V+1);U++)y.data[P++]=0,y.data[P++]=0,y.data[P++]=-1;for(U=0;U<2*(V+1);U++)y.data[P++]=0,y.data[P++]=0,y.data[P++]=1;for(M.data.set(p.buffers[3].data,0),b=p.buffers[3].size,D=p.buffers[0].size/3,p.buffers[1].size/3,C=0;C<b;C++)M.data[C+b]=f.buffers[3].data[C]+D;for(P=p.buffers[3].size+f.buffers[3].size,D*=2,(p.buffers[1].size+f.buffers[1].size)/3,w=0;w<V;++w)E=w+1,M.data[P++]=w+D,M.data[P++]=V+1+w+D,M.data[P++]=E+D,M.data[P++]=V+1+w+D,M.data[P++]=V+1+E+D,M.data[P++]=E+D;for(1,D+=2*(V+1),w=0;w<V;++w)E=w+1,M.data[P++]=V+1+w+D,M.data[P++]=w+D,M.data[P++]=E+D,M.data[P++]=E+D,M.data[P++]=V+1+E+D,M.data[P++]=V+1+w+D;for(S.addBuffer(0,_),S.addBuffer(1,y),S.addBuffer(2,x),S.addBuffer(3,M),S.addPrimitive(p.primitives[0]),S.addPrimitive(f.primitives[0]),T=f.primitives[0].vertexComponents,C=0;C<T.length;C++)T[C].indices.offset+=b;return(I=new i.Primitive).nbIndices=6*this.sag,I.connectivity=i.ConnectivityTypeEnum.TRIANGLES,I.attr={fill:new i.FillAttributes(A,1),line:new i.LineAttributes,point:new i.PointAttributes},(R=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,R.nbVertices=2*(this.sag+1),R.nbValuesPerVertex=3,R.format=i.DataTypeEnum.FLOAT,R.cardinality=0,R.bufferId=0,R.indices=new i.IndexArray,R.indices.format=i.DataTypeEnum.UINT,R.indices.bufferId=3,R.indices.offset=p.buffers[3].size+f.buffers[3].size,(L=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,L.nbVertices=2*(this.sag+1),L.nbValuesPerVertex=3,L.format=i.DataTypeEnum.FLOAT,L.cardinality=0,L.bufferId=1,L.indices=new i.IndexArray,L.indices.format=i.DataTypeEnum.UINT,L.indices.bufferId=3,L.indices.offset=p.buffers[3].size+f.buffers[3].size,(O=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,O.nbVertices=2*(this.sag+1),O.nbValuesPerVertex=3,O.format=i.DataTypeEnum.FLOAT,O.cardinality=0,O.bufferId=2,O.indices=new i.IndexArray,O.indices.format=i.DataTypeEnum.UINT,O.indices.bufferId=3,O.indices.offset=p.buffers[3].size+f.buffers[3].size,I.addVertexComponent(R),I.addVertexComponent(L),I.addVertexComponent(O),S.addPrimitive(I),(N=new i.Primitive).nbIndices=6*this.sag,N.connectivity=i.ConnectivityTypeEnum.TRIANGLES,N.attr={fill:new i.FillAttributes(A,1),line:new i.LineAttributes,point:new i.PointAttributes},(R=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,R.nbVertices=2*(this.sag+1),R.nbValuesPerVertex=3,R.format=i.DataTypeEnum.FLOAT,R.cardinality=0,R.bufferId=0,R.indices=new i.IndexArray,R.indices.format=i.DataTypeEnum.UINT,R.indices.bufferId=3,R.indices.offset=p.buffers[3].size+f.buffers[3].size+6*V,(L=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,L.nbVertices=2*(this.sag+1),L.nbValuesPerVertex=3,L.format=i.DataTypeEnum.FLOAT,L.cardinality=0,L.bufferId=1,L.indices=new i.IndexArray,L.indices.format=i.DataTypeEnum.UINT,L.indices.bufferId=3,L.indices.offset=p.buffers[3].size+f.buffers[3].size+6*V,(O=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,O.nbVertices=2*(this.sag+1),O.nbValuesPerVertex=3,O.format=i.DataTypeEnum.FLOAT,O.cardinality=0,O.bufferId=2,O.indices=new i.IndexArray,O.indices.format=i.DataTypeEnum.UINT,O.indices.bufferId=3,O.indices.offset=p.buffers[3].size+f.buffers[3].size+6*V,N.addVertexComponent(R),N.addVertexComponent(L),N.addVertexComponent(O),S.addPrimitive(N),S.noz=F>0,S},CreateVis3DCylinder:function(e,i,r,n,a){var s;return e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),s={bottomCenterPoint:e,topCenterPoint:i,bottomRadius:r,topRadius:r,sag:n,bottomCap:!0,topCap:!0,internal:!1,layerNb:a}):s={bottomCenterPoint:e.bottomCenterPoint,topCenterPoint:e.topCenterPoint,bottomRadius:e.radius,topRadius:e.radius,sag:e.sag,bottomCap:!0,topCap:!0,internal:!1,color:e.color,layerNb:e.layerNb},this.CreateVis3DCylinderCustom(s)},CreateVis3DCone:function(e,r,n,a,s,o,l){var c;return e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),c={bottomCenterPoint:e,topCenterPoint:r,bottomRadius:void 0!==n?n:1,topRadius:void 0!==a?a:1,sag:s,bottomCap:!0,topCap:!0,internal:!1,color:void 0!==o?o:new i.Color(.2,.8,.2,1),layerNb:l||0}):c={bottomCenterPoint:e.bottomCenterPoint,topCenterPoint:e.topCenterPoint,bottomRadius:void 0!==e.bottomRadius?e.bottomRadius:1,topRadius:void 0!==e.topRadius?e.topRadius:1,sag:e.sag,bottomCap:!0,topCap:!0,internal:!1,color:void 0!==e.color?e.color:new i.Color(.2,.8,.2,1),layerNb:e.layerNb||0},c.topRadius<=0&&(c.topCap=!1),c.bottomRadius<=0&&(c.bottomCap=!1),this.CreateVis3DCylinderCustom(c)},CreateVis3DCylinderCustom:function(e,r,n,a,s,o,l,c,h,u){var d,p,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E,T,A,I,R,L,O,N,F,V,U,B,k,G,z,H,W,j,X,q,Z;e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.bottomCenterPoint=void 0!==e?e:new t.Vector3(0,0,0),this.topCenterPoint=void 0!==r?r:new t.Vector3(0,5,0),this.bottomRadius=void 0!==n?n:1,this.topRadius=void 0!==a?a:1,this.sag=void 0!==s?s:80,d=void 0===l||l,p=void 0===o||o,f=void 0!==c&&c,Z=u||0,k=h||new i.Color(.2,.8,.2,1)):(this.bottomCenterPoint=void 0!==e.bottomCenterPoint?e.bottomCenterPoint:new t.Vector3(0,0,0),this.topCenterPoint=void 0!==e.topCenterPoint?e.topCenterPoint:new t.Vector3(0,5,0),this.bottomRadius=void 0!==e.bottomRadius?e.bottomRadius:1,this.topRadius=void 0!==e.topRadius?e.topRadius:1,this.sag=void 0!==e.sag?e.sag:80,d=void 0===e.topCap||e.topCap,p=void 0===e.bottomCap||e.bottomCap,f=void 0!==e.internal&&e.internal,Z=e.layerNb?e.layerNb:0,k=e.color?e.color:new i.Color(.2,.8,.2,1)),(m=new t.Vector4(0,0,0,0)).subVectors(this.topCenterPoint,this.bottomCenterPoint),m.w=0,m.normalize(),g=new t.Matrix4,0===m.x&&0===m.y?g.identity():g.set(m.x/Math.sqrt(m.x*m.x+m.y*m.y),m.y/Math.sqrt(m.x*m.x+m.y*m.y),0,0,-m.y/Math.sqrt(m.x*m.x+m.y*m.y),m.x/Math.sqrt(m.x*m.x+m.y*m.y),0,0,0,0,1,0,0,0,0,1),v=new t.Matrix4,0===m.x&&0===m.y&&0===m.z?v.identity():v.set(m.z/Math.sqrt(m.x*m.x+m.y*m.y+m.z*m.z),0,-Math.sqrt(m.x*m.x+m.y*m.y)/Math.sqrt(m.x*m.x+m.y*m.y+m.z*m.z),0,0,1,0,0,Math.sqrt(m.x*m.x+m.y*m.y)/Math.sqrt(m.x*m.x+m.y*m.y+m.z*m.z),0,m.z/Math.sqrt(m.x*m.x+m.y*m.y+m.z*m.z),0,0,0,0,1),(S=new t.Matrix4).multiplyMatrices(v,g),S.transpose(),S.clone(),y=new t.Vector3(this.bottomCenterPoint.x,this.bottomCenterPoint.y,this.bottomCenterPoint.z),_=S.clone(),S.elements[12]=y.x,S.elements[13]=y.y,S.elements[14]=y.z,x=Math.sqrt((this.bottomCenterPoint.x-this.topCenterPoint.x)*(this.bottomCenterPoint.x-this.topCenterPoint.x)+(this.bottomCenterPoint.y-this.topCenterPoint.y)*(this.bottomCenterPoint.y-this.topCenterPoint.y)+(this.bottomCenterPoint.z-this.topCenterPoint.z)*(this.bottomCenterPoint.z-this.topCenterPoint.z)),M=(this.bottomRadius-this.topRadius)/x,P=6*this.sag,C=2*(this.sag+1),b=2*(this.sag+1);var Y=C;if(d&&(P+=3*(this.sag-2),Y+=this.sag,b+=this.sag,C+=this.sag),p&&(P+=3*(this.sag-2),Y+=this.sag,b+=this.sag,C+=this.sag),(D=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,D.lineAttr=new i.LineAttributes,D.pointAttr=new i.PointAttributes,(w=new i.Buffer).size=3*C,w.component=i.VertexComponentEnum.POSITION,w.format=i.DataTypeEnum.FLOAT,w.dimension=3,w.data=new Float32Array(w.size),(E=new i.Buffer).size=3*b,E.component=i.VertexComponentEnum.NORMAL,E.format=i.DataTypeEnum.FLOAT,E.dimension=3,E.data=new Float32Array(E.size),(T=new i.Buffer).size=3*Y,T.component=i.VertexComponentEnum.TEX_COORD_0,T.format=i.DataTypeEnum.FLOAT,T.dimension=3,T.data=new Float32Array(T.size),(A=new i.Buffer).indexBuffer=!0,A.size=P,A.format=i.DataTypeEnum.UINT,A.dimension=1,A.data=new Uint16Array(A.size),D.addBuffer(0,w),D.addBuffer(1,E),D.addBuffer(2,T),D.addBuffer(3,A),I=A.data,R=0,f)for(O=0;O<this.sag;++O)N=O+1,I[R++]=N,I[R++]=O,I[R++]=this.sag+1+O,I[R++]=N,I[R++]=this.sag+1+O,I[R++]=this.sag+1+N;else for(O=0;O<this.sag;++O)N=O+1,I[R++]=O,I[R++]=N,I[R++]=this.sag+1+O,I[R++]=this.sag+1+O,I[R++]=N,I[R++]=this.sag+1+N;if(d)for(O=0;O<this.sag-2;O++)I[R++]=2*this.sag+2,I[R++]=2*this.sag+2+O+1,I[R++]=2*this.sag+2+O+2;if(p)if(d)for(O=0;O<this.sag-2;O++)I[R++]=3*this.sag+2,I[R++]=3*this.sag+2+O+1,I[R++]=3*this.sag+2+O+2;else for(O=0;O<this.sag-2;O++)I[R++]=2*this.sag+2,I[R++]=2*this.sag+2+O+1,I[R++]=2*this.sag+2+O+2;F=w.data,V=T.data;var K=0;for(O=0;O<this.sag+1;O++,K+=3)U=O/this.sag*2*Math.PI,F[K]=this.bottomRadius*Math.cos(U),F[K+1]=this.bottomRadius*Math.sin(U),F[K+2]=0,V[K]=O/this.sag,V[K+1]=1,V[K+2]=0;for(K=3*(this.sag+1),O=0;O<this.sag+1;O++,K+=3)U=O/this.sag*2*Math.PI,F[K]=this.topRadius*Math.cos(U),F[K+1]=this.topRadius*Math.sin(U),F[K+2]=x,V[K]=O/this.sag,V[K+1]=0,V[K+2]=0;if(d)for(U=0,L=0;L<this.sag;L++)U=L/this.sag*2*Math.PI,F[K]=F[3*(this.sag+L+1)],V[K++]=(Math.cos(U)+1)/2,F[K]=F[3*(this.sag+L+1)+1],V[K++]=1-(Math.sin(U)+1)/2,F[K]=F[3*(this.sag+L+1)+2],V[K++]=0;if(p)for(U=0,L=0;L<this.sag;L++)U=L/this.sag*2*Math.PI,F[K]=F[3*(this.sag-1-L)],V[K++]=(Math.cos(U)+1)/2,F[K]=F[3*(this.sag-1-L)+1],V[K++]=1-(Math.sin(U)+1)/2,F[K]=F[3*(this.sag-1-L)+2],V[K++]=0;F=E.data,K=0;for(var J=0;J<2;J++)for(O=0;O<this.sag+1;O++)U=O/this.sag*2*Math.PI,(B=new t.Vector3).x=w.data[3*O],B.y=w.data[3*O+1],B.z=w.data[3*O+2],B.z=Math.sqrt(B.x*B.x+B.y*B.y)*M,B.normalize(),f?(F[K++]=-B.x,F[K++]=-B.y,F[K++]=-B.z):(F[K++]=B.x,F[K++]=B.y,F[K++]=B.z);if(d)for(J=0;J<this.sag;J++)F[K++]=0,F[K++]=0,F[K++]=1;if(p)for(J=0;J<this.sag;J++)F[K++]=0,F[K++]=0,F[K++]=-1;for(L=0;L<C;L++)(B=new t.Vector3).x=w.data[3*L],B.y=w.data[3*L+1],B.z=w.data[3*L+2],B.applyMatrix4(S),w.data[3*L]=B.x,w.data[3*L+1]=B.y,w.data[3*L+2]=B.z;for(L=0;L<b;L++)(B=new t.Vector3).x=E.data[3*L],B.y=E.data[3*L+1],B.z=E.data[3*L+2],B.applyMatrix4(_),E.data[3*L]=B.x,E.data[3*L+1]=B.y,E.data[3*L+2]=B.z;return(G=new i.Primitive).nbIndices=6*this.sag,G.connectivity=i.ConnectivityTypeEnum.TRIANGLES,G.attr={fill:new i.FillAttributes(k,1),line:new i.LineAttributes,point:new i.PointAttributes},(z=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,z.nbVertices=2*this.sag,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=0,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=0,(H=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,H.nbVertices=2*this.sag,H.nbValuesPerVertex=3,H.format=i.DataTypeEnum.FLOAT,H.cardinality=0,H.bufferId=1,H.indices=new i.IndexArray,H.indices.format=i.DataTypeEnum.UINT,H.indices.bufferId=3,H.indices.offset=0,(W=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,W.nbVertices=2*this.sag,W.nbValuesPerVertex=3,W.format=i.DataTypeEnum.FLOAT,W.cardinality=0,W.bufferId=2,W.indices=new i.IndexArray,W.indices.format=i.DataTypeEnum.UINT,W.indices.bufferId=3,W.indices.offset=0,G.addVertexComponent(z),G.addVertexComponent(H),G.addVertexComponent(W),D.addPrimitive(G),d&&((j=new i.Primitive).nbIndices=3*(this.sag-2),j.connectivity=i.ConnectivityTypeEnum.TRIANGLES,j.attr={fill:new i.FillAttributes(k,1),line:new i.LineAttributes,point:new i.PointAttributes},(z=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,z.nbVertices=this.sag,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=0,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=6*this.sag,(H=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,H.nbVertices=this.sag,H.nbValuesPerVertex=3,H.format=i.DataTypeEnum.FLOAT,H.cardinality=0,H.bufferId=1,H.indices=new i.IndexArray,H.indices.format=i.DataTypeEnum.UINT,H.indices.bufferId=3,H.indices.offset=6*this.sag,(W=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,W.nbVertices=this.sag,W.nbValuesPerVertex=3,W.format=i.DataTypeEnum.FLOAT,W.cardinality=0,W.bufferId=2,W.offset=2*(this.sag+1),j.addVertexComponent(z),j.addVertexComponent(H),j.addVertexComponent(W),D.addPrimitive(j)),p&&(X=6*this.sag,d&&(X+=3*(this.sag-2)),(q=new i.Primitive).nbIndices=3*(this.sag-2),q.connectivity=i.ConnectivityTypeEnum.TRIANGLES,q.attr={fill:new i.FillAttributes(k,1),line:new i.LineAttributes,point:new i.PointAttributes},(z=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,z.nbVertices=this.sag,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=0,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=X,(H=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,H.nbVertices=this.sag,H.nbValuesPerVertex=3,H.format=i.DataTypeEnum.FLOAT,H.cardinality=0,H.bufferId=1,H.indices=new i.IndexArray,H.indices.format=i.DataTypeEnum.UINT,H.indices.bufferId=3,H.indices.offset=X,(W=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,W.nbVertices=this.sag+2,W.nbValuesPerVertex=3,W.format=i.DataTypeEnum.FLOAT,W.cardinality=0,W.bufferId=2,W.offset=d?this.sag:0,W.offset+=2*(this.sag+1),q.addVertexComponent(z),q.addVertexComponent(H),q.addVertexComponent(W),D.addPrimitive(q)),D.noz=Z>0,D},createLine:function(e,t,r,n){var a,s,o,l,c,h,u,d,p=i.ConnectivityTypeEnum.LINE_STRIP,f=!1,m=!1,g=!1;if(e instanceof Array)console.warn("DEPRECATED: Please use a litteral object to define your primitive."),a=e,c=r,s=[],o=[],u=void 0!==t?t:new i.Color(.5,.5,.5,1),d=n||0;else if(e instanceof Object){if(a=e.points,s=e.colors?e.colors:[],o=e.idx?e.idx:[],p=e.drawMode?e.drawMode:p,f=!!e.editable&&e.editable,l=e.patternOffsets?e.patternOffsets:[],p!==i.ConnectivityTypeEnum.LINES&&p!==i.ConnectivityTypeEnum.LINE_STRIP&&(console.warn("Invalid draw mode for the line, passing to strip mode"),p=i.ConnectivityTypeEnum.LINE_STRIP),p===i.ConnectivityTypeEnum.LINES&&0===o.length)for(var v=0;v<a.length-1;v++)o.push(v),o.push(v+1);if(e.hasOwnProperty("material")){c=e.material.lineWidth,m=function(){if(0===o.length)return!1;if(e.material.is2DLine)return e.material.isDashedLine;for(var t=new Set,i=0,r=0;r<o.length;r++){var n=o[r];if(t.has(n)&&n!==i)return!0;i=n,t.add(n)}return!1}(),u=void 0!==e.material.color?e.material.color:new i.Color(.5,.5,.5,1),l.length&&l.length===o.length&&(g=!0)}else c=e.width,u=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1);d=e.layerNb?e.layerNb:0}if(m){var S=[],_=[],y=[];for(v=0;v<o.length;v++){var x=o[v];S.push(a[x]),s.length&&_.push(s[x]),g&&y.push(l[x]),o[v]=v}a=S,s=_,l=y}var M=a.length,P=s.length,C=o.length;if(!M)return null;var b=function(e,t,r,n,a){var s=new i.Buffer;return s.size=e*t,s.component=r,s.format=n,s.dimension=e,s.data=new Float32Array(s.size),s},D=new i.PrimitiveGroup;D.fillAttr=new i.FillAttributes,D.lineAttr=new i.LineAttributes(u,c),D.pointAttr=new i.PointAttributes;var w=0,E=b(3,M,i.VertexComponentEnum.POSITION,i.DataTypeEnum.FLOAT),T=w++;D.addBuffer(T,E),h=E.data;for(v=0;v<M;v++){var A=a[v];h[3*v]=A.x,h[3*v+1]=A.y,h[3*v+2]=A.z}var I=!1,R=0;if(P===M){I=b(4,P,i.VertexComponentEnum.DIFFUSE_COLOR,i.DataTypeEnum.FLOAT),R=w++,D.addBuffer(R,I),h=I.data;for(v=0;v<P;v++){var L=s[v];h[4*v]=L.x,h[4*v+1]=L.y,h[4*v+2]=L.z,h[4*v+3]=L.w}}var O,N,F=!1,V=0;if(C){V=w++,O=o.length,(N=new i.Buffer).indexBuffer=!0,N.size=O,N.format=i.DataTypeEnum.UINT,N.dimension=1,N.data=O>65535?new Uint32Array(N.size):new Uint16Array(N.size),F=N,D.addBuffer(V,F),h=F.data;for(v=0;v<C;v++)h[v]=o[v]}g&&(D.patternOffsets=l);var U=new i.Primitive;U.nbIndices=C||M,U.connectivity=p,U.attr={fill:new i.FillAttributes(u),line:new i.LineAttributes(u,c),point:new i.PointAttributes};var B,k=function(e,t,r,n,a,s){var o=new i.VertexComponent;return o.component=e.component,o.nbValuesPerVertex=e.dim,o.format=e.format,o.nbVertices=r,o.cardinality=0,o.bufferId=t,n&&(o.indices=new i.IndexArray,o.indices.format=n.format,o.indices.bufferId=a,o.indices.offset=s),o},G=k(E,T,M,F,V,0);return U.addVertexComponent(G),P&&(B=k(I,R,P,F,V,0),U.addVertexComponent(B)),D.addPrimitive(U),D.noz=d>0,D.editable=f,D},createRectangle:function(e,r,n,a,s,o){var l,c,h,u,d,p,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E,T;e instanceof Object?(P=e.width?e.width:1,C=e.height?e.height:1,b=!!e.fill&&e.fill,v=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),D=!!e.noEdge&&e.noEdge,w=e.layerNb?e.layerNb:0,E=!!e.sharing&&e.sharing,T=e.cornerPoint?e.cornerPoint:new t.Vector2(0,0)):(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),P=e||1,C=r||1,b=n||!1,v=void 0!==a?a:new i.Color(.5,.5,.5,1),D=s||!1,w=o||0,T=new t.Vector2(0,0),E=!1),(l=new i.PrimitiveGroup).sharing=E,l.fillAttr=new i.FillAttributes,l.lineAttr=new i.LineAttributes,l.pointAttr=new i.PointAttributes,(c=new i.Buffer).size=15,c.component=i.VertexComponentEnum.POSITION,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(c.size),(h=new i.Buffer).size=3,h.component=i.VertexComponentEnum.NORMAL,h.format=i.DataTypeEnum.FLOAT,h.dimension=3,h.data=new Float32Array(h.size),(u=new i.Buffer).size=12,u.component=i.VertexComponentEnum.TEX_COORD_0,u.format=i.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(u.size),(d=new i.Buffer).indexBuffer=!0,d.size=b?9:5,d.format=i.DataTypeEnum.UINT,d.dimension=1,d.data=new Uint16Array(d.size),(p=new i.Buffer).indexBuffer=!0,p.size=5,p.format=i.DataTypeEnum.UINT,p.dimension=1,p.data=new Uint16Array(p.size),(f=new i.Buffer).indexBuffer=!0,f.size=b?4:0,f.format=i.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(f.size),l.addBuffer(0,c),l.addBuffer(1,h),l.addBuffer(2,d),l.addBuffer(3,p),l.addBuffer(4,u),l.addBuffer(5,f),g=0,(m=d.data)[g++]=0,m[g++]=1,m[g++]=2,m[g++]=3,m[g++]=4,b&&(m[g++]=0,m[g++]=1,m[g++]=3,m[g++]=2),g=0,(m=p.data)[g++]=0,m[g++]=0,m[g++]=0,m[g++]=0,m[g++]=0,m=f.data,g=0,b&&(m[g++]=0,m[g++]=1,m[g++]=3,m[g++]=2),m=c.data,g=0;var A=e.delta&&e.delta.x?e.delta.x:0,I=e.delta&&e.delta.y?e.delta.y:0;return m[g++]=T.x+A,m[g++]=T.y+I,m[g++]=0,m[g++]=P+T.x+A,m[g++]=T.y+I,m[g++]=0,m[g++]=P+T.x+A,m[g++]=C+T.y+I,m[g++]=0,m[g++]=T.x+A,m[g++]=C+T.y+I,m[g++]=0,m[g++]=T.x+A,m[g++]=T.y+I,m[g++]=0,g=0,(m=h.data)[g++]=0,m[g++]=0,m[g++]=1,g=0,(m=u.data)[g++]=0,m[g++]=0,m[g++]=0,m[g++]=1,m[g++]=0,m[g++]=0,m[g++]=1,m[g++]=1,m[g++]=0,m[g++]=0,m[g++]=1,m[g++]=0,D||((S=new i.Primitive).nbIndices=5,S.connectivity=i.ConnectivityTypeEnum.LINE_STRIP,S.attr={fill:new i.FillAttributes(v),line:new i.LineAttributes(v),point:new i.PointAttributes},(_=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,_.nbVertices=5,_.nbValuesPerVertex=3,_.format=i.DataTypeEnum.FLOAT,_.cardinality=0,_.bufferId=0,_.indices=new i.IndexArray,_.indices.format=i.DataTypeEnum.UINT,_.indices.bufferId=2,_.indices.offset=0,(M=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,M.nbVertices=1,M.nbValuesPerVertex=3,M.format=i.DataTypeEnum.FLOAT,M.cardinality=0,M.bufferId=1,M.indices=new i.IndexArray,M.indices.format=i.DataTypeEnum.UINT,M.indices.bufferId=3,M.indices.offset=0,S.addVertexComponent(_),S.addVertexComponent(M),l.addPrimitive(S)),b&&((x=new i.Primitive).nbIndices=4,x.connectivity=i.ConnectivityTypeEnum.TRIANGLE_STRIP,x.attr={fill:new i.FillAttributes(v),line:new i.LineAttributes,point:new i.PointAttributes},(_=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,_.nbVertices=4,_.nbValuesPerVertex=3,_.format=i.DataTypeEnum.FLOAT,_.cardinality=0,_.bufferId=0,_.indices=new i.IndexArray,_.indices.format=i.DataTypeEnum.UINT,_.indices.bufferId=2,_.indices.offset=5,(M=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,M.nbVertices=1,M.nbValuesPerVertex=3,M.format=i.DataTypeEnum.FLOAT,M.cardinality=0,M.bufferId=1,M.indices=new i.IndexArray,M.indices.format=i.DataTypeEnum.UINT,M.indices.bufferId=3,M.indices.offset=0,(y=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,y.nbVertices=4,y.nbValuesPerVertex=3,y.format=i.DataTypeEnum.FLOAT,y.cardinality=0,y.bufferId=4,y.indices=new i.IndexArray,y.indices.format=i.DataTypeEnum.UINT,y.indices.bufferId=5,y.indices.offset=0,x.addVertexComponent(_),x.addVertexComponent(M),x.addVertexComponent(y),l.addPrimitive(x)),l.noz=w>0,l},createCircle:function(e,t,r,n,a,s,o){var l,c,h,u,d,p,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E,T,A,I,R,L;for(e instanceof Object?(A=e.radius?e.radius:1,I=e.segments?e.segments:24,w=void 0!==e.startAngle?e.startAngle:0,E=void 0!==e.endAngle?e.endAngle:2*Math.PI,R=!!e.fill&&e.fill,y=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),T=!!e.noEdge&&e.noEdge,L=e.layerNb?e.layerNb:0):(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),A=e||1,I=t||24,w=void 0!==n?n:0,E=void 0!==a?a:2*Math.PI,R=r||!1,T=!1,y=void 0!==s?s:new i.Color(.5,.5,.5,1),L=o||0),D=E-w,(l=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,l.lineAttr=new i.LineAttributes,l.pointAttr=new i.PointAttributes,(c=new i.Buffer).size=3*(I+2),c.component=i.VertexComponentEnum.POSITION,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(c.size),(h=new i.Buffer).size=3,h.component=i.VertexComponentEnum.NORMAL,h.format=i.DataTypeEnum.FLOAT,h.dimension=3,h.data=new Float32Array(h.size),(u=new i.Buffer).size=6,u.component=i.VertexComponentEnum.TEX_COORD_0,u.format=i.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(u.size),(d=new i.Buffer).indexBuffer=!0,d.size=R?2*(I+1)+1:I+1,d.format=i.DataTypeEnum.UINT,d.dimension=1,d.data=new Uint16Array(d.size),(p=new i.Buffer).indexBuffer=!0,p.size=I+2,p.format=i.DataTypeEnum.UINT,p.dimension=1,p.data=new Uint16Array(p.size),(f=new i.Buffer).indexBuffer=!0,f.size=R?I+2:0,f.format=i.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(f.size),l.addBuffer(0,c),l.addBuffer(1,h),l.addBuffer(2,u),l.addBuffer(3,d),l.addBuffer(4,p),l.addBuffer(5,f),m=d.data,g=0,v=1;v<I+2;v++)m[g++]=v;if(R)for(g=I+1,m[g++]=0,v=1;v<I+2;v++)m[g++]=v;for(m=p.data,g=0,g=0;g<=I+2;g++)m[g++]=0;if(R)for((m=f.data)[0]=0,g=1;g<=I+2;g++)m[g]=1;for(g=0,(m=c.data)[g++]=0,m[g++]=0,m[g++]=0,v=0;v<I+2;v++)_=v/I*D+w,m[g++]=A*Math.cos(_),m[g++]=A*Math.sin(_),m[g++]=0;return S=0,(m=h.data)[S++]=0,m[S++]=0,m[S++]=1,S=0,(m=u.data)[S++]=0,m[S++]=0,m[S++]=0,m[S++]=1,m[S++]=0,m[S++]=0,T||((x=new i.Primitive).nbIndices=I+1,x.connectivity=i.ConnectivityTypeEnum.LINE_STRIP,x.attr={fill:new i.FillAttributes(y),line:new i.LineAttributes,point:new i.PointAttributes},(M=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,M.nbVertices=I+2,M.nbValuesPerVertex=3,M.format=i.DataTypeEnum.FLOAT,M.cardinality=0,M.bufferId=0,M.indices=new i.IndexArray,M.indices.format=i.DataTypeEnum.UINT,M.indices.bufferId=3,M.indices.offset=0,(C=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,C.nbVertices=1,C.nbValuesPerVertex=3,C.format=i.DataTypeEnum.FLOAT,C.cardinality=0,C.bufferId=1,C.indices=new i.IndexArray,C.indices.format=i.DataTypeEnum.UINT,C.indices.bufferId=4,C.indices.offset=0,x.addVertexComponent(M),x.addVertexComponent(C),l.addPrimitive(x)),R&&((P=new i.Primitive).nbIndices=I+2,P.connectivity=i.ConnectivityTypeEnum.TRIANGLE_FAN,P.attr={fill:new i.FillAttributes(y),line:new i.LineAttributes,point:new i.PointAttributes},(M=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,M.nbVertices=I+2,M.nbValuesPerVertex=3,M.format=i.DataTypeEnum.FLOAT,M.cardinality=0,M.bufferId=0,M.indices=new i.IndexArray,M.indices.format=i.DataTypeEnum.UINT,M.indices.bufferId=3,M.indices.offset=I+1,(C=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,C.nbVertices=1,C.nbValuesPerVertex=3,C.format=i.DataTypeEnum.FLOAT,C.cardinality=0,C.bufferId=1,C.indices=new i.IndexArray,C.indices.format=i.DataTypeEnum.UINT,C.indices.bufferId=4,C.indices.offset=0,(b=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,b.nbVertices=2,b.nbValuesPerVertex=3,b.format=i.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=2,b.indices=new i.IndexArray,b.indices.format=i.DataTypeEnum.UINT,b.indices.bufferId=5,b.indices.offset=0,P.addVertexComponent(M),P.addVertexComponent(C),P.addVertexComponent(b),l.addPrimitive(P)),l.noz=L>0,l},createTorus:function(e,r,n,a,s,o,l,c){var h,u,d,p,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E,T,A,I,R,L,O,N,F,V,U;for(e instanceof t.Matrix4?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.axis=e||null,this.majorRadius=r||100,this.minorRadius=n||40,this.majorStartAngle=a||0,this.majorEndAngle=s||2*Math.PI,this.sag=o||8,L=void 0!==l?l:new i.Color(.5,.5,.5,1),U=c||0):e instanceof Object&&(this.axis=e.axis||null,this.majorRadius=e.majorRadius||100,this.minorRadius=e.minorRadius||40,this.majorStartAngle=e.majorStartAngle||0,this.majorEndAngle=e.majorEndAngle||2*Math.PI,this.sag=e.sag||8,L=e.color||(void 0!==l?l:new i.Color(.5,.5,.5,1)),U=c||0),h=(this.majorEndAngle-this.majorStartAngle)/this.sag,u=(this.sag+1)*(this.sag+1),d=6*this.sag*this.sag,(p=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,p.lineAttr=new i.LineAttributes,p.pointAttr=new i.PointAttributes,(f=new i.Buffer).size=3*u,f.component=i.VertexComponentEnum.POSITION,f.format=i.DataTypeEnum.FLOAT,f.dimension=3,f.data=new Float32Array(f.size),(I=new i.Buffer).size=3*u,I.component=i.VertexComponentEnum.NORMAL,I.format=i.DataTypeEnum.FLOAT,I.dimension=3,I.data=new Float32Array(I.size),(m=new i.Buffer).size=3*u,m.component=i.VertexComponentEnum.TEX_COORD_0,m.format=i.DataTypeEnum.FLOAT,m.dimension=3,m.data=new Float32Array(m.size),(g=new i.Buffer).indexBuffer=!0,g.size=d,g.format=i.DataTypeEnum.UINT,g.dimension=1,g.data=new Uint16Array(g.size),p.addBuffer(0,f),p.addBuffer(1,I),p.addBuffer(2,m),p.addBuffer(3,g),v=g.data,y=0,P=0;P<this.sag;++P)for(T=P+1,C=0;C<this.sag;++C)A=C+1,v[y]=P*(this.sag+1)+C,v[y+1]=T*(this.sag+1)+C,v[y+2]=P*(this.sag+1)+A,v[y+3]=T*(this.sag+1)+A,v[y+4]=P*(this.sag+1)+A,v[y+5]=T*(this.sag+1)+C,y+=6;for(v=f.data,S=I.data,_=m.data,x=0,M=new t.Vector3,P=0;P<this.sag+1;P++)for(b=this.majorStartAngle+P*h,C=0;C<this.sag+1;C++,x+=3)D=C/this.sag*2*Math.PI,M.x=this.majorRadius*Math.cos(b),M.y=this.majorRadius*Math.sin(b),(w=new t.Vector3).x=(this.majorRadius+this.minorRadius*Math.cos(D))*Math.cos(b),w.y=(this.majorRadius+this.minorRadius*Math.cos(D))*Math.sin(b),w.z=this.minorRadius*Math.sin(D),E=w.clone(),this.axis&&w.applyMatrix4(this.axis),v[x]=w.x,v[x+1]=w.y,v[x+2]=w.z,(R=new t.Vector3).subVectors(E,M).normalize(),this.axis&&R.applyMatrix4(this.axis),R.normalize(),S[x]=R.x,S[x+1]=R.y,S[x+2]=R.z,_[x]=P/this.sag,_[x+1]=1-C/this.sag,_[x+2]=0;return(O=new i.Primitive).nbIndices=d,O.connectivity=i.ConnectivityTypeEnum.TRIANGLES,O.attr={fill:new i.FillAttributes(L,1),line:new i.LineAttributes,point:new i.PointAttributes},(N=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,N.nbVertices=u,N.nbValuesPerVertex=3,N.format=i.DataTypeEnum.FLOAT,N.cardinality=0,N.bufferId=0,N.indices=new i.IndexArray,N.indices.format=i.DataTypeEnum.UINT,N.indices.bufferId=3,N.indices.offset=0,(V=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,V.nbVertices=u,V.nbValuesPerVertex=3,V.format=i.DataTypeEnum.FLOAT,V.cardinality=0,V.bufferId=1,V.indices=new i.IndexArray,V.indices.format=i.DataTypeEnum.UINT,V.indices.bufferId=3,V.indices.offset=0,(F=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,F.nbVertices=u,F.nbValuesPerVertex=3,F.format=i.DataTypeEnum.FLOAT,F.cardinality=0,F.bufferId=2,F.indices=new i.IndexArray,F.indices.format=i.DataTypeEnum.UINT,F.indices.bufferId=3,F.indices.offset=0,O.addVertexComponent(N),O.addVertexComponent(V),O.addVertexComponent(F),p.addPrimitive(O),p.noz=U>0,p},createPoints:function(e,t,r,n){var a=this.createMesh(e,void 0,void 0,void 0,i.ConnectivityTypeEnum.POINTS,t,n,void 0,void 0,void 0,r);return a.pointAttr.size=r,a.noz=n>0,a},createMesh:function(e,r,n,a,s,o,l,c,h,u,d){var p,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E,T,A,I,R;if(b=new t.Vector3,D=new t.Vector3,this.bufferPosition=void 0!==e?e:[],this.bufferNormal=void 0!==r?r:[],this.bufferUV=void 0!==n?n:[],this.bufferColor=void 0!==u?u:[],this.bufferIndex=void 0!==a?a:[],this.glType=void 0!==s?s:i.ConnectivityTypeEnum.TRIANGLES,p=this.bufferPosition.length,f=this.bufferNormal.length,m=this.bufferUV.length,g=this.bufferColor.length,v=this.bufferIndex.length,(S=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,S.lineAttr=new i.LineAttributes,S.pointAttr=new i.PointAttributes,y=null,x=null,M=null,(_=new i.Buffer).size=p,_.component=i.VertexComponentEnum.POSITION,_.format=i.DataTypeEnum.FLOAT,_.dimension=3,_.data=new Float32Array(this.bufferPosition),S.addBuffer(0,_),f&&((y=new i.Buffer).size=f,y.component=i.VertexComponentEnum.NORMAL,y.format=i.DataTypeEnum.FLOAT,y.dimension=3,y.data=new Float32Array(this.bufferNormal),S.addBuffer(1,y)),m&&((x=new i.Buffer).size=m,x.component=i.VertexComponentEnum.TEX_COORD_0,x.format=i.DataTypeEnum.FLOAT,x.dimension=3,x.data=new Float32Array(this.bufferUV),S.addBuffer(2,x)),g&&((M=new i.Buffer).size=g,M.component=i.VertexComponentEnum.DIFFUSE_COLOR,M.format=i.DataTypeEnum.FLOAT,M.dimension=3,M.data=new Float32Array(this.bufferColor),S.addBuffer(4,M)),v&&((P=new i.Buffer).indexBuffer=!0,P.size=v,P.format=i.DataTypeEnum.UINT,P.dimension=1,P.data=v>65535?new Uint32Array(this.bufferIndex):new Uint16Array(this.bufferIndex),S.addBuffer(3,P)),c){for(C=0;C<p/3;C++)b.x=_.data[3*C],b.y=_.data[3*C+1],b.z=_.data[3*C+2],c.multiplyVector3(b),_.data[3*C]=b.x,_.data[3*C+1]=b.y,_.data[3*C+2]=b.z;for(C=0;C<f/3;C++)D.x=y.data[3*C],D.y=y.data[3*C+1],D.z=y.data[3*C+2],c.multiplyVector3(D),y.data[3*C]=D.x,y.data[3*C+1]=D.y,y.data[3*C+2]=D.z}w="undefined"!==o?o:new i.Color(.5,.5,.5,1);var L=d||1;return(E=new i.Primitive).nbIndices=v||p/3,E.connectivity=this.glType,E.attr={fill:new i.FillAttributes(w),line:new i.LineAttributes(w),point:new i.PointAttributes(w,L)},(T=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,T.nbVertices=p/3,T.nbValuesPerVertex=3,T.format=i.DataTypeEnum.FLOAT,T.cardinality=0,T.bufferId=0,T.indices=null,v&&(T.indices=new i.IndexArray,T.indices.format=i.DataTypeEnum.UINT,T.indices.bufferId=3,T.indices.offset=0),E.addVertexComponent(T),f&&((A=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,A.nbVertices=f/3,A.nbValuesPerVertex=3,A.format=i.DataTypeEnum.FLOAT,A.cardinality=0,A.bufferId=1,A.indices=null,v&&(A.indices=new i.IndexArray,A.indices.format=i.DataTypeEnum.UINT,A.indices.bufferId=3,A.indices.offset=0),E.addVertexComponent(A)),m&&((I=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,I.nbVertices=m/3,I.nbValuesPerVertex=3,I.format=i.DataTypeEnum.FLOAT,I.cardinality=0,I.bufferId=2,I.indices=null,v&&(I.indices=new i.IndexArray,I.indices.format=i.DataTypeEnum.UINT,I.indices.bufferId=3,I.indices.offset=0),E.addVertexComponent(I)),g&&((R=new i.VertexComponent).component=i.VertexComponentEnum.DIFFUSE_COLOR,R.nbVertices=g/3,R.nbValuesPerVertex=3,R.format=i.DataTypeEnum.FLOAT,R.cardinality=0,R.bufferId=4,R.indices=null,v&&(R.indices=new i.IndexArray,R.indices.format=i.DataTypeEnum.UINT,R.indices.bufferId=3,R.indices.offset=0),E.addVertexComponent(R)),S.addPrimitive(E),l&&(l.force=!0,S.material=l),S.noz=h>0,S},createText:function(e,i,n,a,s,o){var l,c,h,u,d,p,f,m,g;void 0===s&&(s=32),l="font-family: "+i+"; font-size: "+s+"px;",d=(h=(c=this._determineTextSize(e,l)).width)/(u=c.height),(p=r).width=h,p.height=u,(f=p.getContext("2d")).fillStyle="#"+a.getHexString(),f.lineWidth=0,f.strokeStyle="#"+a.getHexString(),f.font=s+"px "+i,f.textAlign="left",f.textBaseline="top",f.fillText(e,0,0),f.restore(),m=h/s,g=this.createRectangle(n*m,n*m/d,!0,void 0,void 0,o);var v=void 0;if(0!=p.width||0!=p.height){for(var S=f.getImageData(0,0,p.width,p.height),_=new ArrayBuffer(S.data.length),y=new Uint8Array(_),x=0;x<4*p.width*p.height;++x)y[x]=S.data[x];(v=new t.DataTexture(y,p.width,p.height,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearMipMapLinearFilter)).needsUpdate=!0}return g.material=new t.MeshBasicMaterial({map:v,transparent:!0}),g.material.force=!0,g.noz=o>0,g},convertFromTHREEMesh:function(e){if(e instanceof t.Mesh){var r,n,a,s,o,l,c,h,u,d,p,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E,T,A,I,R,L=function(e,t,i,r){return Math.abs(e.x-t[i])<1e-5&&Math.abs(e.y-t[i+1])<1e-5&&(2===r||Math.abs(e.z-t[i+2])<1e-5)},O={x:0,y:0};if(0===(R=e.geometry)._type){A=[],I=[],E=!1;var N=R.faces,F=R.faceVertexUvs[0];for(r=0;r<N.length;r++)I[r]={face:N[r],uv:F?F[r]:null};for(e.material instanceof t.MeshFaceMaterial&&(E=!0,I.sort(function(e,t){return e.face.materialIndex-t.face.materialIndex})),o=0,l=0,b=0,C=[],D=0,T=I.length&&void 0!==I[0].face.materialIndex?I[0].face.materialIndex:-1,r=0;r<I.length;r++){var V=I[r].face;E&&T!==V.materialIndex&&(C[b]={nbIndices:o,nbVertices:l,start:D,end:r,material:E?e.material.materials[T]:e.material},b+=1,D=r,o=0,l=0,T=V.materialIndex),V instanceof t.Face3?(o+=3,l+=3):(o+=6,l+=4)}0!=o&&(C[b]={nbIndices:o,nbVertices:l,start:D,end:r,material:E?e.material.materials[T]:e.material}),f=R.vertices;var U=new Int32Array(f.length),B=["a","b","c","d"];for(s=0;s<C.length;s++){var k=C[s],G=!1;l=k.nbVertices,o=k.nbIndices,c=new Float32Array(3*l),h=new Float32Array(3*l),u=new Float32Array(3*l),d=new Float32Array(3*l),p=new Uint32Array(o);var z=0;for(r=0;r<U.length;r++)U[r]=-1;for(D=k.start,w=k.end,a=0,r=D;r<w;r++){m=I[r].face,M=I[r].uv,v=m.vertexNormals&&m.vertexNormals.length?m.vertexNormals:null,S=m.vertexColors&&m.vertexColors.length?m.vertexColors:null,_=m.normal,null,v&&v.length||(v=null),S&&S.length||(S=null);var H=m instanceof t.Face4?4:3;for(n=0;n<H;n++){var W;y=v?v[n]:_,x=S?S[n]:null,P=M?M[n]:O,-1===(W=U[m[B[n]]])||!L(y,h,3*W,3)||!L(P,d,3*W,2)||x&&!L(x,u,3*W,3)?(U[m[B[n]]]=z,g=f[m[B[n]]],c[3*z]=g.x,c[3*z+1]=g.y,c[3*z+2]=g.z,h[3*z]=y.x,h[3*z+1]=y.y,h[3*z+2]=y.z,x&&(G=!0,u[3*z]=x.r,u[3*z+1]=x.g,u[3*z+2]=x.b),d[3*z]=P.x,d[3*z+1]=P.y,d[3*z+2]=0,3===n&&(p[a++]=p[a-4],p[a++]=p[a-3]),p[a++]=z++):(3===n&&(p[a++]=p[a-4],p[a++]=p[a-3]),p[a++]=W)}}var j=new Float32Array(3*z),X=new Float32Array(3*z),q=new Float32Array(3*z),Z=new Float32Array(3*z);for(r=0;r<3*z;r++)j[r]=c[r],X[r]=h[r],q[r]=u[r],Z[r]=d[r];c=j,h=X,u=G?q:null,d=Z,G&&(k.material.vertexColors=t.VertexColorType.RGBA),A[A.length]={bufPos:c,bufNorm:h,bufCol:u,bufUV:d,bufInd:p,connectivity:i.ConnectivityTypeEnum.TRIANGLES,material:k.material}}return this.createPrimGroup(A)}}},createPrimGroup:function(e){var t,r,n,a,s,o,l,c,h,u,d,p,f,m,g,v,S,_;for((o=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,o.lineAttr=new i.LineAttributes,o.pointAttr=new i.PointAttributes,p=0;p<e.length;p++){var y=(x=!!e[p].bufCol)?5:4;t=e[p].bufPos.length,r=e[p].bufNorm.length,x&&(n=e[p].bufCol.length),a=e[p].bufUV.length,s=e[p].bufInd.length,(l=new i.Buffer).size=t,l.component=i.VertexComponentEnum.POSITION,l.format=i.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(e[p].bufPos),(c=new i.Buffer).size=r,c.component=i.VertexComponentEnum.NORMAL,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(e[p].bufNorm),x&&((h=new i.Buffer).size=n,h.component=i.VertexComponentEnum.DIFFUSE_COLOR,h.format=i.DataTypeEnum.FLOAT,h.dimension=3,h.data=new Float32Array(e[p].bufCol)),(u=new i.Buffer).size=a,u.component=i.VertexComponentEnum.TEX_COORD_0,u.format=i.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(e[p].bufUV),(d=new i.Buffer).indexBuffer=!0,d.size=s,d.format=i.DataTypeEnum.UINT,d.dimension=1,d.data=new Uint32Array(e[p].bufInd),o.addBuffer(p*y,l),o.addBuffer(1+p*y,c),o.addBuffer(2+p*y,u),o.addBuffer(3+p*y,d),x&&o.addBuffer(4+p*y,h)}for(f=new i.Color(.5,.5,.5,1),p=0;p<e.length;p++){var x;y=(x=!!e[p].bufCol)?5:4;switch(t=e[p].bufPos.length,r=e[p].bufNorm.length,x&&(n=e[p].bufCol.length),a=e[p].bufUV.length,s=e[p].bufInd.length,(m=new i.Primitive).nbIndices=s,m.connectivity=e[p].connectivity,m.connectivity){case i.ConnectivityTypeEnum.TRIANGLES:case i.ConnectivityTypeEnum.TRIANGLE_FAN:case i.ConnectivityTypeEnum.TRIANGLE_STRIP:m.geomType="FACE";break;case i.ConnectivityTypeEnum.LINES:case i.ConnectivityTypeEnum.LINE_STRIP:case i.ConnectivityTypeEnum.LINE_LOOP:m.geomType="WIRE_EDGE";break;case i.ConnectivityTypeEnum.POINTS:m.geomType="FREE_POINT";break;default:m.geomType=null}m.attr={fill:new i.FillAttributes(f),line:new i.LineAttributes,point:new i.PointAttributes},(g=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,g.nbVertices=t/3,g.nbValuesPerVertex=3,g.format=i.DataTypeEnum.FLOAT,g.cardinality=0,g.bufferId=p*y,g.indices=new i.IndexArray,g.indices.format=i.DataTypeEnum.UINT,g.indices.bufferId=3+p*y,g.indices.offset=0,(v=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,v.nbVertices=r/3,v.nbValuesPerVertex=3,v.format=i.DataTypeEnum.FLOAT,v.cardinality=0,v.bufferId=1+p*y,v.indices=new i.IndexArray,v.indices.format=i.DataTypeEnum.UINT,v.indices.bufferId=3+p*y,v.indices.offset=0,x&&((S=new i.VertexComponent).component=i.VertexComponentEnum.DIFFUSE_COLOR,S.nbVertices=n/3,S.nbValuesPerVertex=3,S.format=i.DataTypeEnum.FLOAT,S.cardinality=0,S.bufferId=4+p*y,S.indices=new i.IndexArray,S.indices.format=i.DataTypeEnum.UINT,S.indices.bufferId=3+p*y,S.indices.offset=0),(_=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,_.nbVertices=a/3,_.nbValuesPerVertex=3,_.format=i.DataTypeEnum.FLOAT,_.cardinality=0,_.bufferId=2+p*y,_.indices=new i.IndexArray,_.indices.format=i.DataTypeEnum.UINT,_.indices.bufferId=3+p*y,_.indices.offset=0,m.addVertexComponent(g),m.addVertexComponent(v),x&&m.addVertexComponent(S),m.addVertexComponent(_),m.material=e[p].material,o.addPrimitive(m)}return e[0]&&e[0].material&&(o.material=e[0].material),o},CreateVis3DCuboidFromBox3:function(e,t){var r,n,a,s,o,l,c,h,u,d,p=void 0!==t.color?t.color:new i.Color(.5,.5,.5,1);for((r=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,r.lineAttr=new i.LineAttributes,r.pointAttr=new i.PointAttributes,(n=new i.Buffer).size=72,n.component=i.VertexComponentEnum.POSITION,n.format=i.DataTypeEnum.FLOAT,n.dimension=3,n.data=new Float32Array(n.size),(a=new i.Buffer).size=72,a.component=i.VertexComponentEnum.NORMAL,a.format=i.DataTypeEnum.FLOAT,a.dimension=3,a.data=new Float32Array(a.size),(s=new i.Buffer).indexBuffer=!0,s.size=36,s.format=i.DataTypeEnum.UINT,s.dimension=1,s.data=new Uint16Array(36),r.addBuffer(0,n),r.addBuffer(1,a),r.addBuffer(2,s),o=s.data,l=0,c=0;c<6;c++)o[l++]=4*c,o[l++]=4*c+1,o[l++]=4*c+2,o[l++]=4*c,o[l++]=4*c+2,o[l++]=4*c+3;var f=e.min.x,m=e.max.x,g=e.min.y,v=e.max.y,S=e.min.z,_=e.max.z;for(l=0,(o=n.data)[l++]=m,o[l++]=g,o[l++]=S,o[l++]=m,o[l++]=v,o[l++]=S,o[l++]=m,o[l++]=v,o[l++]=_,o[l++]=m,o[l++]=g,o[l++]=_,o[l++]=m,o[l++]=v,o[l++]=S,o[l++]=f,o[l++]=v,o[l++]=S,o[l++]=f,o[l++]=v,o[l++]=_,o[l++]=m,o[l++]=v,o[l++]=_,o[l++]=m,o[l++]=g,o[l++]=_,o[l++]=m,o[l++]=v,o[l++]=_,o[l++]=f,o[l++]=v,o[l++]=_,o[l++]=f,o[l++]=g,o[l++]=_,o[l++]=f,o[l++]=g,o[l++]=S,o[l++]=m,o[l++]=g,o[l++]=S,o[l++]=m,o[l++]=g,o[l++]=_,o[l++]=f,o[l++]=g,o[l++]=_,o[l++]=f,o[l++]=v,o[l++]=S,o[l++]=f,o[l++]=g,o[l++]=S,o[l++]=f,o[l++]=g,o[l++]=_,o[l++]=f,o[l++]=v,o[l++]=_,o[l++]=m,o[l++]=g,o[l++]=S,o[l++]=f,o[l++]=g,o[l++]=S,o[l++]=f,o[l++]=v,o[l++]=S,o[l++]=m,o[l++]=v,o[l++]=S,o=a.data,l=0,c=0;c<4;c++)o[l++]=1,o[l++]=0,o[l++]=0;for(c=0;c<4;c++)o[l++]=0,o[l++]=1,o[l++]=0;for(c=0;c<4;c++)o[l++]=0,o[l++]=0,o[l++]=1;for(c=0;c<4;c++)o[l++]=0,o[l++]=-1,o[l++]=0;for(c=0;c<4;c++)o[l++]=-1,o[l++]=0,o[l++]=0;for(c=0;c<4;c++)o[l++]=0,o[l++]=0,o[l++]=-1;for(c=0;c<6;c++)h=new i.Primitive({nbIndices:6,connectivity:i.ConnectivityTypeEnum.TRIANGLES,fillGAS:new i.FillAttributes(p,1),lineGAS:new i.LineAttributes,pointGAS:new i.PointAttributes}),u=new i.VertexComponent({nbVertices:4,bufferId:0,indices:new i.IndexArray({bufferId:2,offset:6*c})}),d=new i.VertexComponent({nbVertices:4,bufferId:1,indices:new i.IndexArray({bufferId:2,offset:6*c})}),h.addVertexComponent(u),h.addVertexComponent(d),r.addPrimitive(h);return r},_determineTextSize:function(e,t,i){var r,n,a,s,o;r=document.getElementsByTagName("body")[0],(n=document.createElement("div")).setAttribute("style",t);var l=i||"nowrap";return(a=document.createElement("span")).setAttribute("style","white-space: "+l),s=document.createTextNode(e),a.appendChild(s),n.appendChild(a),r.appendChild(n),(o={width:0,height:0}).width=a.offsetWidth,o.height=a.offsetHeight,r.removeChild(n),o}});return UWA.namespace("THREEDS/GeometryHelper",n)}),define("Visualization/GeometryHelper",["DS/Visualization/GeometryHelper","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/GeometryHelper"),e}),define("DS/Visualization/SubElement",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/VisuIdentification/Node","DS/VisuIdentification/Pattern"],function(e,t,i,r,n){"use strict";var a={},s=30,o=0,l=e.extend({init:function(e,t){if(t!==a&&s>0){var i=(new Error).stack;i=i&&i.substring(i.indexOf("\n")+1),console.warn("Use of deprecated constructor.\nUse SubElement.getFromSGNode() instead.\n"+i),s--}this.sgNode=e,this._internalGeometryData=null,this.id=o++},getDimension:function(){if(this.sgNode){var e=this.sgNode;switch(e.getFirstPrimitive&&(e=e.getFirstPrimitive()),e.getGroup().glType){case 0:return"point";case 1:case 2:case 3:return"line";case 4:case 5:case 6:return"surface";default:return""}}return""},getCellDimension:function(){if(this.sgNode){var e=this.sgNode;switch(e.getFirstPrimitive&&(e=e.getFirstPrimitive()),e.getGroup().glType){case 0:return 0;case 1:case 2:case 3:return 1;case 4:case 5:case 6:return 2;default:return-1}}return-1},getBodyDimension:function(){if(this.sgNode){var e=this.sgNode;e.getFirstPrimitive&&(e=e.getFirstPrimitive());var t=e.getRep?e.getRep():e.rep;return t&&t.solid?3:2}return-1},getType:function(){if(this.sgNode){var e=this.sgNode;if(e.getFirstPrimitive)return"selectionGroup";switch(e.getType?e.getType():e.type){case 0:return"node";case 1:return"bag";case 2:return"rep";case 3:return"primitive";default:return""}}return""},getGeometricType:function(){if(this.sgNode&&"primitive"===this.getType()){var e=this.sgNode.getGroup();if(e)return i.GeomTypeString[e._geomType]}return null},getParent:function(){if(this.sgNode){var e=this.sgNode;e.getFirstPrimitive&&(e=e.getFirstPrimitive());var t="primitive"===this.getType()?e.getRep():e.parents?e.parents[0]:null;if(t)return THREEDS.SubElement.getFromSGNode(t)}return null},getChildren:function(){var e,t=[];if(this.sgNode){var r=this.getType();if("rep"===r)for(e=0;e<this.sgNode.getPrimitivesCount();e++){var n=new i.SGPrimitiveHelper;n.set(this.sgNode,e),t.push(THREEDS.SubElement.getFromSGNode(n))}else if("selectionGroup"===r){var a=this.sgNode.getPrimitives();for(e=0;e<a.length;e++)t.push(THREEDS.SubElement.getFromSGNode(a[e]))}else for(e=0;e<this.sgNode.children.length;e++)t.push(THREEDS.SubElement.getFromSGNode(this.sgNode.children[e]))}return t},getPrimitives:function(e){var t=e||[],r=this.getType();if("primitive"===r)t.push(this.sgNode);else if("rep"===r)for(var n=0;n<this.sgNode.getPrimitivesCount();n++){var a=new i.SGPrimitiveHelper;a.set(this.sgNode,n),t.push(a)}else for(n=0;n<this.sgNode.children.length;n++)THREEDS.SubElement.getFromSGNode(this.sgNode.children[n]).getPrimitives(t);return t},getCGMID:function(){return this.sgNode&&!this.sgNode.getFirstPrimitive?this.sgNode.getCgmId?this.sgNode.getCgmId():this.sgNode.cgmId:""},getModelIdentification:function(){return this.getIdentificationObject()},getIdentificationObject:function(){var e,t=this.sgNode;return t&&(t.getFirstPrimitive&&(t=t.getFirstPrimitive()),t.getIdentificationObject&&(e=t.getIdentificationObject())),e},getMeshes:function(){var e=[],t=[];if(this.sgNode&&"primitive"===this.getType()){var i=this.sgNode.getGroup();if(i&&i.geometry)for(var r=i.geometry.meshList,n=0;n<r.length;n++){var a=r[n];t.push(a._occurrence.node)}}var s=-1,o=null;t.length&&(t.sort(function(e,t){return e.id-t.id}),s=t[0].id,e.push(t[0]));for(var l=1;l<t.length;l++)s!==(o=t[l]).id&&(s=o.id,e.push(o));return e},getReps:function(){var e,t=[];if("rep"===this.getType())t.push(this);else for(e=0;e<this.children.length;e++)t=t.concat(this.children[e].getReps());return t}});return l.getFromSGNode=function(e){if(e instanceof i.SGPrimitive){var t=e.group,r=t._primitives.indexOf(e);(e=new i.SGPrimitiveHelper).set(t,r)}return e._setInternalNode?(e._getInternalNode()||e._setInternalNode(new THREEDS.SubElement(e,a)),e._getInternalNode()):(e.internalNode||(e.internalNode=new THREEDS.SubElement(e,a)),e.internalNode)},UWA.namespace("THREEDS/SubElement",l)}),define("Visualization/SubElement",["DS/Visualization/SubElement","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SubElement"),e}),define("DS/Visualization/PathElement",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/Visualization/SubElement"],function(e,t,i,r,n){"use strict";var a=0,s=t.__visibleInCurrentSpace,o=e.extend({init:function(e){this._uid=a++,this.externalPath=[],this.internalPath=[],this._key=null,this.setFromArray(e)},getUID:function(){return this._uid},getLength:function(){return this.externalPath.length+this.internalPath.length},getLastElement:function(e){return!e&&this.internalPath.length?this.internalPath[this.internalPath.length-1]:this.externalPath.length?this.externalPath[this.externalPath.length-1]:null},getElement:function(e,t){return e<this.externalPath.length?this.externalPath[e]:!t&&e<this.getLength()?this.internalPath[e-this.externalPath.length]:null},isEqual:function(e){var t;if(!e)return!1;if(this.externalPath.length!==e.externalPath.length)return!1;if(this.internalPath.length!==e.internalPath.length)return!1;if(this.instanceId!==e.instanceId)return!1;for(t=0;t<this.externalPath.length;t++)if(this.externalPath[t]!==e.externalPath[t])return!1;for(t=0;t<this.internalPath.length;t++){var i=this.internalPath[t].sgNode,n=e.internalPath[t].sgNode;if(i instanceof r.SGPrimitive||i instanceof r.SGPrimitiveHelper){if(!(n instanceof r.SGPrimitive||n instanceof r.SGPrimitiveHelper))return!1;if(!i.isEqual(n))return!1}else if(i!==n)return!1}return!0},empty:function(){this.externalPath=[],this.internalPath=[]},clone:function(){for(var e=new THREEDS.PathElement(this.externalPath),t=0;t<this.internalPath.length;t++){var i=this.internalPath[t];i&&e.internalPath.push(i)}return this._key&&(e._key=this._key),this.instanceId&&(e.instanceId=this.instanceId),e},copy:function(e){this.externalPath=e.externalPath.slice(),this.internalPath=e.internalPath.slice()},addElement:function(e){return e&&(e.getNotAllowedInPathElement?e.getNotAllowedInPathElement()&&l():e.notAllowedInPathElement&&l()),this._key&&delete this._key,e instanceof THREEDS.Nodes.Node3D?(this.externalPath.push(e),!0):e instanceof THREEDS.SubElement&&(this.internalPath.push(e),!0)},setFromArray:function(e,t){var i;if(this._key=null,void 0===e||!(e instanceof Array))return!1;var r=[];for(i=0;i<e.length;i++){var n=e[i];if(n.getNotAllowedInPathElement&&n.getNotAllowedInPathElement()||n.notAllowedInPathElement)l();else{if(null===n)return!1;r.push(n)}}var a=[];if(t&&t instanceof Array)for(i=0;i<t.length;i++){var s=t[i];if(null===s)return!1;a.push(s)}return this.getLength()&&this.empty(),this.externalPath=r,this.internalPath=a,!0},setFromOccurrence:function(e,t,i,r){if(null==e)return!1;var n=e.node,a=n&&n._getDisablePrimPicking(),s=e.parent;this.externalPath=[n];for(var o=!1;null!==s&&!o&&(n=s.node,s=s.parent,!n.getNotAllowedInPathElement());)this.externalPath.unshift(n),i&&n===i&&(o=!0);var l=i&&o||!i;if(null==t||a&&r)return l;s=t.getParent();for(this.internalPath=[t];null!==s;)this.internalPath.unshift(s),s=s.getParent();return l},setFromOccurrencePath:function(e,t){if(null==e)return!1;var i=e.getSize();if(!i)return!1;for(var r=[],n=0;n<i;n++){var a=e.getNodeName(n);if(null===a)return!1;var s=t.getChildByName(a);if(null===s)return!1;s.getNotAllowedInPathElement()?l():r.push(s)}return this.getLength()&&this.empty(),this.externalPath=r,!0},addSubstituteMaterial:function(e,t,i){this._getOccurrences(e).forEach((e,r,n)=>e._addSubstituteMaterial(t,i))},removeSubstituteMaterial:function(e,t){this._getOccurrences(e).forEach((e,i,r)=>e._removeSubstituteMaterial(t))},_getOccurrences:function(e){var t,i,r,n,a,s,o,l;if(!this.externalPath.length)return[];if(null===(t=this.externalPath[0]))return[];for(n=t._occurrences,e&&(n=n.filter(function(t){return t.scene3js===e.internalSceneGraph.root3js})),a=[],l=1;l<this.externalPath.length;l++){for(t=this.externalPath[l],s=0;s<n.length;s++)for(i=n[s].children,o=0;o<i.length;o++)(r=i[o]).node===t&&a.push(r);n=a,a=[]}return n},_getOccurrenceFromRootOccurrence:function(e){if(e.node!==this.externalPath[0])return null;var t,i,r,n,a,s=e;for(t=1;t<this.externalPath.length;t++){for(r=this.externalPath[t],a=null,i=0;i<s.children.length&&null==a;i++)(n=s.children[i]).node===r&&(a=n);if(null===a)return null;s=a}return s},_getRenderableOccurrences:function(e,t){var i,r,n,a,s;if(r=[],i=this._getOccurrences(e))for(a=0;a<i.length;a++)for(n=i[a]._getRenderableOccurrences(t),s=0;s<n.length;s++)r.push(n[s]);return r},_getUniqueOccurrence:function(e){var t=this._getOccurrences(e);return t&&1===t.length?t[0]:null},getKey:function(){if(!this._key){var e=0,t="";for(e=0;e<this.externalPath.length;e++)t+=(0===e?"":"/")+this.externalPath[e].id;for(t+="//",e=0;e<this.internalPath.length;e++)t+=(0===e?"":"/")+this.internalPath[e].id;this._key=t}return this._key},hash:function(){if(!this._hash){var e,t=0,i="";if(this.internalPath.length){if(!((e=this.internalPath[this.internalPath.length-1])instanceof n))throw new Error("Unknown node");var r=e.sgNode;r&&(r.getStart?i+=r.getStart()+"/":r.start&&(i+=r.start+"/"))}for(t=this.externalPath.length-1;t>=0;t--)i+=this.externalPath[t].id+"/";this._hash=i}return this._hash},getParentPath:function(){var e=this.externalPath.concat(this.internalPath);if(e.length<=1)return null;var t,i=new THREEDS.PathElement;for(t=0;t<e.length-1;t++)i.addElement(e[t]);return i},getChildrenPathes:function(e){var t,i,r=[],n=this.getLastElement(),a=e?e.getKey():null;if(null===n)return!1;if(n.children)for(t=0;t<n.children.length;t++)(i=this.clone()).addElement(n.children[t]),i.getKey()!==a&&r.push(i);return r},getSiblingsPathes:function(){var e=this.getParentPath();return e?e.getChildrenPathes(this):[]},getAncestorsPathes:function(){for(var e=this,t=[];e;)t.unshift(e),e=e.getParentPath();return t},getSubPath:function(e){if(this.internalPath.length>0)return null;var t,i=null,r=null;for(t=this.externalPath.length-2;t>=0&&null===i;t--)e(this.externalPath[t])&&(i=t);if(null!==i)for(r=new o,t=0;t<=i;t++)r.addElement(this.externalPath[t]);return r},getPathesFromSelectionGroupPath:function(){var e=this.getLastElement(!1);if(!(e&&e.sgNode&&e.sgNode instanceof r.SelectionGroup))return null;for(var t=[],i=e.sgNode.getPrimitives(),a=0;a<i.length;a++){var s=i[a],o=this.getParentPath();o.addElement(n.getFromSGNode(s)),t.push(o)}return t},toJSON:function(e){for(var t,i={},r=[],n=this.externalPath[0];n;)r=[n].concat(r),n=n.parents.length&&n!==e?n.parents[0]:null;function a(e){return e.getPersistentId?{persistent:!0,value:e.getPersistentId()}:{persistent:!1,value:e.parents[0].children.indexOf(e)}}for(i.firstElementPath=[],t=0;t<r.length;t++)((n=r[t]).parents.length||n!==e)&&i.firstElementPath.push(a(n));for(i.externalPathRest=[],t=1;t<this.externalPath.length;t++)i.externalPathRest.push(a(this.externalPath[t]));return i},setFromJSON:function(e,t){var i,r=t;function n(e,t){var i,r;if(!t.persistent)return e.children[t.value];for(i=0;i<e.children.length;i++)if((r=e.children[i]).getPersistentId&&r.getPersistentId()===t.value)return r;return null}for(i=0;i<e.firstElementPath.length;i++)r=n(r,e.firstElementPath[i]);var a=[r];for(i=0;i<e.externalPathRest.length;i++)a.push(n(a[a.length-1],e.externalPathRest[i]));for(i=0;i<a.length;i++)a[i].getNotAllowedInPathElement()||this.addElement(a[i])},_dbgPrint:function(){for(var e="ext:[",t=this.externalPath.length,i=0;i<t;i++){(r=this.externalPath[i])&&(e+=r.name),i<t-1&&(e+=", ")}e+="] int:[",t=this.internalPath.length;for(i=0;i<t;i++){var r;(r=this.internalPath[i])&&(e+=r.getCGMID()),i<t-1&&(e+=", ")}return e+="]"},getMatrix:function(e){var t=this._getUniqueOccurrence(e);if(!t)return null;if(t.originalOverrideSet){var i=t.originalOverrideSet.getSubstituteMatrix();if(i)return i.clone()}var r=this.getLastElement(!0);return null===r?null:r.getMatrix()},getWorldMatrix:function(e,t){var i=this._getUniqueOccurrence(e);return i?(i._tryOverridesUpdateWithAncestors(e),t?(t.copy(i.matrix),t):i.matrix.clone()):null},getMatrixInAxisSystem:function(e,i){var r=this.getWorldMatrix(i);if(!r)return null;var n=new t.Matrix4,a=new t.Matrix4;return a.getInverse(e),n.multiplyMatrices(a,r),n},getBoundingSphere:function(e,t,i){"show"===t&&(console.warn("DEPRECATED: use visibleSpace instead of show"),t="visibleSpace"),"noShow"===t&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),t="invisibleSpace");var r=this.getWorldMatrix(e);if(!r)return null;var n=this._getUniqueOccurrence(e);if(!n)return null;e=e||n.scene3js.viewer,n._tryOverridesUpdateWithAncestors(e);var a=null;i&&0!==this.internalPath.length?a=this.getLastElement().sgNode.computeBoundingSphere().clone():a=n.getBoundingSphere(t).clone();return a.center.applyMatrix4(r),a},getBoundingBox:function(e,t,i){if(t){"show"===i&&(console.warn("DEPRECATED: use visibleSpace instead of show"),i="visibleSpace"),"noShow"===i&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),i="invisibleSpace");var r=this.getWorldMatrix(t);if(!r)return null;e&&e.copy(r);var n=this._getUniqueOccurrence(t);return n?(t=t||n.scene3js.viewer,n._tryOverridesUpdateWithAncestors(t),n.getBoundingBox(i).clone()):null}},getFilterGeomType:function(e){if(!e)return 0;var t=this._getUniqueOccurrence(e);if(!t)return 0;var i=t.renderable;return i?i.getFilterGeomType():0},getOrientedBoundingBox:function(e,i,r,n,a,o){if(!i)return null;var l=n||(1===i.visibleSpace?"visibleSpace":"invisibleSpace"),c=this._getUniqueOccurrence(i);if(o=!!o,!c)return null;r=r||t.FixedSizeFiltering.Include,a=a||[];for(var h=0,u=0;u<a.length;u++){h|=a[u]}if(c._tryOverridesUpdateWithAncestors(i),o&&0!==this.internalPath.length){var d=c.renderable;if(!d)return c.computeAccurateBoundingBox(l,e,r,h);if(!s(d.visible,d.visibilityFree,"visibleSpace"===l,c))return new t.Box3;var p=c._isFixedSize();if(p&&r===t.FixedSizeFiltering.Exclude)return new t.Box3;var f=new t.Matrix4;null!==e?f.multiplyMatrices((new t.Matrix4).getInverse(e),d._getMMMatrix()):f=d._getMMMatrix();var m=c._getRenderModes(),g=d.getFilterGeomType();return this.getLastElement().sgNode._computeOrientedBoundingBox(f,m&~h,r,p,g?g._geomType:0)}return c.computeAccurateBoundingBox(l,e,r,h)},checkExternalPath:function(){var e,t,i,r=!0;for(e=0;e<this.externalPath.length-1&&r;e++)t=this.externalPath[e],i=this.externalPath[e+1],t.children.indexOf(i)<0&&(r=!1);return r},isAParentOf:function(e){function t(e,t){var i=[],r=(e[0],e[0]);if(1===r.parents.length&&r!==t){for(r=r.parents[0];1===r.parents.length&&r!==t;)i.unshift(r),r=r.parents[0];i.unshift(r)}return i=i.concat(e)}var i,r,n,a=this.externalPath[0],s=e.externalPath[0];if(a===s?(i=this.externalPath,r=e.externalPath):this.externalPath.indexOf(s)>0?(i=this.externalPath,r=t(e.externalPath,a)):(i=t(this.externalPath,s),r=e.externalPath),r[0]===i[0]){if(i.length<=r.length){for(n=0;n<i.length&&i[n]===r[n];)n++;return n===i.length}return!1}return!1},concatenatePathes:function(e,t){var i=e.externalPath.concat(t.externalPath);this.setFromArray(i)},substractPath:function(e,t){var i,r=t.externalPath.concat([]),n=e.externalPath;r.indexOf(n[n.length-1]);for(i=0;i<n.length;i++)if(n[i]!==r[i])return!1;return r.splice(0,n.length-1),this.setFromArray(r),!0},setRenderPasses:function(e){for(var t=this._getRenderableOccurrences(),i=0;i<t.length;i++)t[i].setVisibleInPasses(e)},getParentOccurrencePath:function(){return this.getParentPath.apply(this,arguments)},getChildrenOccurrencePathes:function(){return this.getChildrenPathes.apply(this,arguments)},getSiblingsOccurrencePathes:function(){return this.getSiblingsPathes.apply(this,arguments)},getAncestorsOccurrencePathes:function(){return this.getAncestorsPathes.apply(this,arguments)},_getIndexFromNode:function(e){return this.externalPath.indexOf(e)},_findSGNodeByLocalId:function(e,t){var i,r=e.getIdentificationObject?e.getIdentificationObject():null;r&&(r.getLocalId()===t&&(i=e));if(!i&&e.children)for(var n=e.children,a=0;a<n.length&&void 0===(i=this._findSGNodeByLocalId(n[a],t));a++);return i},findAssociatedSGNode:function(e,t){var i;if(e.parents)for(var r=e.parents,n=0;n<r.length;n++)if(r[n]instanceof THREEDS.Nodes.CGRNode)i=this._findSGNodeByLocalId(r[n].internalSceneGraph,t);else if(void 0!==(i=this.findAssociatedSGNode(r[n],t)))break;return i}});function l(){console.warn("An attempt to add an unauthorized node to a PathElement has been countered.\nPlease remove the node from your PathElement creation.\nNode returned by viewer.getRootNode() and any of its parents may not be part of a PathElement")}return UWA.namespace("THREEDS/PathElement",o)}),define("Visualization/PathElement",["DS/Visualization/PathElement","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/PathElement"),e}),define("DS/Manipulators/Manipulator",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Visualization/PathElement","DS/CoreEvents/ModelEvents","DS/VisuEvents/ScreenEvent"],function(e,t,i,r,n,a){"use strict";var s=0,o=0,l=e.extend({init:function(e,t){return this.viewer=e,this._uid=s++,this.active=!0,this.hasPriority=!1,this._pickingPriority=!0,this._pickingInManip=!1,this._selectionAllowed=!1,this._prePickingDuringManip=!0,this._preActivationDuringManip=!0,this._pickingDuringManip=!0,this._checkManipsWhenEnabled=!1,this.links={},this.manipulatedPaths=[],this.preactivated={path:null,node:null},this._modelEvent=new n,this._isDynamic=void 0!==t&&t,this},enable:function(){this.active=!0},disable:function(){this.active=!1},setExclusive:function(e){this.hasPriority=e},setDynamic:function(e){this._isDynamic=e},getPriority:function(){return this.hasPriority},getPickingPriority:function(){return this._pickingPriority},setPickingPriority:function(e){this._pickingPriority=e},setPickingInManipulation:function(e){this._pickingInManip=e},getPickingInManipulation:function(){return this._pickingInManip},setSelectionAllowed:function(e){this._selectionAllowed=e},getSelectionAllowed:function(){return this._selectionAllowed},setPrePickingDuringManipulation:function(e){this._prePickingDuringManip=e},getPrePickingDuringManipulation:function(){return this._prePickingDuringManip},setPreActivationDuringManipulation:function(e){this._preActivationDuringManip=e},getPreActivationDuringManipulation:function(){return this._preActivationDuringManip},setPickingDuringManipulation:function(e){this._pickingDuringManip=e},getPickingDuringManipulation:function(){return this._pickingDuringManip},checkManipulatorsOnCreation:function(e){this._checkManipsWhenEnabled=e},getUID:function(){return this._uid},linkToNode:function(e){e.setIsManipulator?e.setIsManipulator(!0):e.isManipulator=!0;var t=this._buildLink({node:e});return this.activate(t),t},linkToPath:function(e){e.getLastElement().setIsManipulator(!0);var t=this._buildLink({path:e});return this.activate(t),t},_linkToViewer:function(){var e=this._buildLink({viewer:this.viewer});return this.activate(e),e},_buildLink:function(e){var t=o++;return this.links[t]={path:e.path,node:e.node,viewer:e.viewer,states:{manipulateState:l.State.NONE,preActivateState:l.State.NONE}},t},unlink:function(e){if(this.links[e]){var t=this.links[e];if(t.node?t.node.setIsManipulator?t.node.setIsManipulator(!1):t.node.isManipulator=!1:t.path&&t.path.getLastElement().setIsManipulator(!1),this.deactivate(e))return delete this.links[e],!0}return!1},activate:function(e){if(void 0===e)return!1;var t=this.links[e];if(!t)return!1;if(t.viewer)t.viewer._addManipulator(this,e);else{for(var i=t.node?t.node:t.path,n=i instanceof r?i._getOccurrences():i._occurrences,a=[],s={},o=0;o<n.length;o++){(d=n[o])._manipulators[e]=this;for(var c=d._getRenderableOccurrences(),h=0;h<c.length;h++)a.push(c[h])}for(var u=0;u<a.length;u++){var d,p=a[u];void 0===p._manipulators&&(p._manipulators={}),p._manipulators[e]=this,(d=p._occurrence)&&d.scene3js&&d.scene3js.viewer&&d.scene3js.viewer.manipulatorManager&&(s[d.scene3js.viewer.id]=d.scene3js.viewer)}if(this._checkManipsWhenEnabled&&t.states.manipulateState===l.State.NONE)for(var f in s){var m=s[f],g=THREEDS.VisuEventsManager.getMouseEvents(-1,m.canvas);g.length&&m.manipulatorManager._onMove({from:[g[0]],viewer:m},!0)}}return!0},deactivate:function(e){if(void 0===e)return!1;var t=this.links[e];if(!t)return!1;if(t.viewer)t.viewer._removeManipulator(e);else{for(var i=t.node?t.node:t.path,n=i instanceof r?i._getOccurrences():i._occurrences,a=[],s=0;s<n.length;s++){var o=n[s];o._manipulators[e]&&delete o._manipulators[e];var l=o._getRenderableOccurrences();for(c=0;c<l.length;c++)a.push(l[c])}for(var c=0;c<a.length;c++){var h=a[c];h._manipulators&&h._manipulators[e]&&delete h._manipulators[e]}}return!0},BeginManipulate:function(e,t,i){if(this.hasPriority&&t.viewer&&t.viewer.currentViewpoint&&t.viewer.currentViewpoint.control&&t.viewer.currentViewpoint.control._onStopManip(t),e)if(e instanceof r)this.manipulatedPaths.push(e);else for(var n=0;n<e._occurrences.length;n++){var a=e._occurrences[n],s=new r;s.setFromOccurrence(a);for(var o=s._getRenderableOccurrences(),l=0;l<o.length;l++){var c=new r;c.setFromOccurrence(o[l]._occurrence),this.manipulatedPaths.push(c)}}},Manipulate:function(e,t,i){},EndManipulate:function(e,t,i){this.manipulatedPaths=[]},HandleLongHold:function(e,t){return!1},PrimaryPointerClick:function(e,t,i){},PrimaryPointerDoubleClick:function(e,t,i){},BeginPreactivate:function(e,t,i){},Preactivate:function(e,t,i){},EndPreactivate:function(e,t,i){},onBeginManipulate:function(e){return this._modelEvent.subscribe({event:"BeginManipulate"},e)},onManipulate:function(e){return this._modelEvent.subscribe({event:"Manipulate"},e)},onEndManipulate:function(e){return this._modelEvent.subscribe({event:"EndManipulate"},e)},onBeginPreactivate:function(e){return this._modelEvent.subscribe({event:"BeginPreactivate"},e)},onPreactivate:function(e){return this._modelEvent.subscribe({event:"Preactivate"},e)},onEndPreactivate:function(e){return this._modelEvent.subscribe({event:"EndPreactivate"},e)},onPrimaryPointerClick:function(e){return this._modelEvent.subscribe({event:"PrimaryPointerClick"},e)},onPrimaryPointerDoubleClick:function(e){return this._modelEvent.subscribe({event:"PrimaryPointerDoubleClick"},e)},subscribe:function(e,t){return this._modelEvent.subscribe({event:e},t)},unsubscribe:function(e){this._modelEvent.unsubscribe(e)},publish:function(e,t){return this._modelEvent.publish({event:e,data:t,context:this})},DEPRECATED_CONSTRUCTOR:function(e){return!!(e&&e[0]instanceof THREEDS.WebGLV6Viewer)&&(c>0&&(c--,console.log("[Manipulators] DEPRECATED Manipulator construction: "+(new Error).stack)),!0)}}),c=50;return l.State={NONE:0,BEGIN:1,MOVE:2,END:3},UWA.namespace("THREEDS/Nodes/Manipulator",l)}),define("Manipulators/Manipulator",["DS/Manipulators/Manipulator","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Manipulators/Manipulator"),e}),define("DS/Manipulators/TrapSelectionManipulator",["DS/Manipulators/Manipulator"],function(e){"use strict";return e.extend({init:function(e,t){this._parent(e),this.extremities={xPix:0,x:0,yPix:0,y:0},this.originPoint=null,this.startTime=null,this.divTrap=this.setupDivTrap(e.divTrap),this.noCursorChange=!0,this.isActive=!0,this.advancedSelection=!!t,this.forwardSelect=!1,this.showDivTrap=!0},setAdvanced:function(e){this.advancedSelection=e,e||(this.setupDivTrap(this.divTrap),this.forwardSelect=!1)},setShowDivTrap:function(e){this.showDivTrap=e},BeginManipulate:function(e,t,i){this.viewer.setCursor("TrapSelection",100),this.originPoint=this.viewer.getMousePosition(t.from[0].getCurrentPosition(this.viewer.canvas)),this.setExtremities(this.originPoint),this.startTime=Date.now(),this.manipIndex=0},Manipulate:function(e,t,i){var r=this.viewer.getMousePosition(t.from[0].getCurrentPosition(this.viewer.canvas)),n=this.viewer.devicePixelRatio;this.setExtremities(this.originPoint,r),this.divTrap&&(this.showDivTrap&&this.divTrap.show(),this.divTrap.setStyles({width:(this.extremities.pt.xPix-this.extremities.xPix)/n,height:(this.extremities.pt.yPix-this.extremities.yPix)/n,left:this.extremities.xPix/n,top:this.extremities.yPix/n,pointerEvents:"none"}))},EndManipulate:function(e,t,i){this.viewer.setCursor("Auto"),this.extremities&&this.divTrap&&(this.divTrap.hide(),this.divTrap.setStyles({width:"0px",height:"0px",left:"0px",top:"0px",pointerEvents:"none"}),this.viewer._doPickingFromMouseEvent(t.from[0],this.viewer.currentViewpoint.control,this)),this.setExtremities(null)},HandleLongHold:function(e,t){return!0},setupDivTrap:function(e){return e.setStyles({position:"absolute",opacity:"0.8",pointerEvents:"none",border:"1px dashed black",backgroundColor:"transparent"}),e.hide(),e},setExtremities:function(e,t){if(e)if(t){var i,r={},n={},a=!0;if(e.xPix<t.xPix?(a=!0,r.xPix=e.xPix,r.x=e.x,n.xPix=t.xPix,n.x=t.x):(a=!1,r.xPix=t.xPix,r.x=t.x,n.xPix=e.xPix,n.x=e.x),e.yPix<t.yPix?(r.yPix=e.yPix,r.y=e.y,n.yPix=t.yPix,n.y=t.y):(r.yPix=t.yPix,r.y=t.y,n.yPix=e.yPix,n.y=e.y),this.extremities=r,this.extremities.pt=n,this.advancedSelection&&this.divTrap&&this.forwardSelect!==a)i=a?{border:"2px solid #f5c77e",backgroundColor:"rgba(245, 200, 125, 0.5)"}:{border:"2px dashed #75cdf0",backgroundColor:"rgba(117, 205, 240, 0.5)"},this.divTrap.setStyles(i),this.forwardSelect=a}else this.extremities=e;else this.extremities=null},getExtremities:function(){return this.extremities}})}),define("DS/Shaders/BloomShaders",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=function(t){var i="tDiffuse"+(t||""),r={defines:{LEVEL:1},uniforms:{direction:{type:"v2",value:new e.Vector2(1,0)},blurSize:{type:"f",value:1},ratio:{type:"f",value:1},kernel:{type:"fv1",value:[]}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D "+i+";","uniform vec2 direction;","uniform float blurSize;","uniform float ratio;","uniform float kernel[LEVEL * 2 + 1];","varying vec2 vUv;","void main() {","vec2 dir = direction * blurSize * 0.5/float(LEVEL);","dir *= ratio;","vec4  color = vec4(0.0);","for(int i=-LEVEL; i<=LEVEL; i++){","vec2 texCoord   =  dir * float(i) + vUv;","vec4 sampleCol  =  texture2D("+i+", texCoord);","color += sampleCol * kernel[i+LEVEL];","}","gl_FragColor = color;","}"].join("\n")};return r.uniforms[i]={type:"t",value:null},r},i=function(t){var i="tDiffuse"+(t||""),r={defines:{LEVEL:1},uniforms:{invSize:{type:"v2",value:new e.Vector2(512,512)},radius:{type:"f",value:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D "+i+";","varying vec2 vUv;","void main() {","vec2 screenPos = vUv;","vec4 result = vec4(0.0);","float blurSize = invSize.x;","#if (LEVEL == 1)","result += texture2D("+i+", vec2(vUv.x - 1.2 * blurSize, vUv.y)) * 0.3125;","result += texture2D("+i+", vec2(vUv.x, vUv.y)) * 0.375;","result += texture2D("+i+", vec2(vUv.x + 1.2 * blurSize, vUv.y)) * 0.3125;","#endif","#if (LEVEL == 2)","result += texture2D("+i+", vec2(vUv.x - 1.285714285714 * blurSize, vUv.y)) * 0.328125;","result += texture2D("+i+", vec2(vUv.x, vUv.y)) * 0.3125;","result += texture2D("+i+", vec2(vUv.x + 1.285714285714 * blurSize, vUv.y)) * 0.328125;","#endif","#if (LEVEL == 3)","result += texture2D("+i+", vec2(vUv.x - 3.111111111111 * blurSize, vUv.y)) * 0.03515625;","result += texture2D("+i+", vec2(vUv.x - 1.333333333333 * blurSize, vUv.y)) * 0.328125;","result += texture2D("+i+", vec2(vUv.x, vUv.y)) * 0.2734375;","result += texture2D("+i+", vec2(vUv.x + 1.333333333333 * blurSize, vUv.y)) * 0.328125;","result += texture2D("+i+", vec2(vUv.x + 3.111111111111 * blurSize, vUv.y)) * 0.03515625;","#endif","#if (LEVEL == 4)","result += texture2D("+i+", vec2(vUv.x - 3.181818181818 * blurSize, vUv.y)) * 0.0537109375;","result += texture2D("+i+", vec2(vUv.x - 1.363636363636 * blurSize, vUv.y)) * 0.322265625;","result += texture2D("+i+", vec2(vUv.x, vUv.y)) * 0.24609375;","result += texture2D("+i+", vec2(vUv.x + 1.363636363636 * blurSize, vUv.y)) * 0.322265625;","result += texture2D("+i+", vec2(vUv.x + 3.181818181818 * blurSize, vUv.y)) * 0.0537109375;","#endif","#if (LEVEL == 5)","result += texture2D("+i+", vec2(vUv.x - 5.076923076923 * blurSize, vUv.y)) * 0.003173828125;","result += texture2D("+i+", vec2(vUv.x - 3.230769230769 * blurSize, vUv.y)) * 0.06982421875;","result += texture2D("+i+", vec2(vUv.x - 1.384615384615 * blurSize, vUv.y)) * 0.314208984375;","result += texture2D("+i+", vec2(vUv.x, vUv.y)) * 0.2255859375;","result += texture2D("+i+", vec2(vUv.x + 1.384615384615 * blurSize, vUv.y)) * 0.314208984375;","result += texture2D("+i+", vec2(vUv.x + 3.230769230769 * blurSize, vUv.y)) * 0.06982421875;","result += texture2D("+i+", vec2(vUv.x + 5.076923076923 * blurSize, vUv.y)) * 0.003173828125;","#endif","gl_FragColor = result;","}"].join("\n")};return r.uniforms[i]={type:"t",value:null},r},r={defines:{LEVEL:1},uniforms:{tDiffuse:{type:"t",value:null},invSize:{type:"v2",value:new e.Vector2(512,512)},radius:{type:"f",value:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec2 screenPos = vUv;","vec4 result = vec4(0.0);","float blurSize = invSize.y;","#if (LEVEL == 1)","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 1.2 * blurSize)) * 0.3125;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y)) * 0.375;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 1.2 * blurSize)) * 0.3125;","#endif","#if (LEVEL == 2)","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 1.285714285714 * blurSize)) * 0.328125;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y)) * 0.3125;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 1.285714285714 * blurSize)) * 0.328125;","#endif","#if (LEVEL == 3)","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 3.111111111111 * blurSize)) * 0.03515625;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 1.333333333333 * blurSize)) * 0.328125;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y)) * 0.2734375;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 1.333333333333 * blurSize)) * 0.328125;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 3.111111111111 * blurSize)) * 0.03515625;","#endif","#if (LEVEL == 4)","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 3.181818181818 * blurSize)) * 0.0537109375;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 1.363636363636 * blurSize)) * 0.322265625;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y)) * 0.24609375;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 1.363636363636 * blurSize)) * 0.322265625;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 3.181818181818 * blurSize)) * 0.0537109375;","#endif","#if (LEVEL == 5)","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 5.076923076923 * blurSize)) * 0.003173828125;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 3.230769230769 * blurSize)) * 0.06982421875;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y - 1.384615384615 * blurSize)) * 0.314208984375;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y)) * 0.2255859375;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 1.384615384615 * blurSize)) * 0.314208984375;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 3.230769230769 * blurSize)) * 0.06982421875;","result += texture2D(tDiffuse, vec2(vUv.x, vUv.y + 5.076923076923 * blurSize)) * 0.003173828125;","#endif","gl_FragColor = result;","}"].join("\n")},n={uniforms:{tDiffuse:{type:"t",value:null},invSize:{type:"v2",value:new e.Vector2(512,512)},radius:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D tDiffuse;","uniform float radius;","varying vec2 vUv;","void main() {","vec4 result = vec4(0.0);","float radiusH = invSize.x * radius;","float radiusV = invSize.y * radius;","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * -0.326212, vUv.y + radiusV * -0.405805 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * -0.840144, vUv.y + radiusV * -0.07358 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * -0.695914, vUv.y + radiusV * 0.457137 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * -0.203345, vUv.y + radiusV * 0.620716 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * 0.96234, vUv.y + radiusV * -0.194983 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * 0.473434, vUv.y + radiusV * -0.480026 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * 0.519456, vUv.y + radiusV * 0.767022 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * 0.185461, vUv.y + radiusV * -0.893124 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * 0.507431, vUv.y + radiusV * 0.064425 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * 0.530992, vUv.y + radiusV * 0.412458 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * -0.32194, vUv.y + radiusV * -0.871945 ) );","result += texture2D( tDiffuse, vec2( vUv.x + radiusH * -0.791559, vUv.y + radiusV * 0.597705 ) );","gl_FragColor = result * 0.0833333333333333;","}"].join("\n")},a={uniforms:{tDiffuse2:{type:"t",value:null},threshold:{type:"f",value:1},invSize:{type:"v2",value:new e.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse2;","uniform float threshold;","uniform vec2 invSize;","varying vec2 vUv;","vec4 WeighedAverageColor(vec2 offset){","\tvec2 coord = vUv+ offset * invSize;","\tvec4 color = texture2D( tDiffuse2, coord );","\tcolor = vec4(color.xyz,1.0);","\tfloat luminance = dot(color.rgb, vec3(0.3,0.6,0.1));","\tcolor *= 1.0/(1.0+luminance);","\treturn color;","}","bool isNan( vec3 val ){","   return !( val.x < 0.0 || 0.0 < val.x || val.x == 0.0 ) || !( val.y < 0.0 || 0.0 < val.y || val.y == 0.0 ) || !( val.z < 0.0 || 0.0 < val.z || val.z == 0.0 );","}","void main() {","\t#if defined (OLD_BLOOM)","    \tvec4 color = texture2D( tDiffuse2, vUv );","\t\tfloat lum = dot(color.rgb, vec3(0.2126, 0.7152, 0.0722));","\t\tfloat lum2 = clamp(lum - threshold, 0.0, 1.0);","\t\tcolor.rgb *= lum2;","\t\tgl_FragColor = color;","\t#else","   \tvec4 color = vec4(0.0);","\t\tcolor += WeighedAverageColor(vec2(0.0,0.0));","\t\tcolor += WeighedAverageColor(vec2(1.0,0.0));","\t\tcolor += WeighedAverageColor(vec2(1.0,1.0));","\t\tcolor += WeighedAverageColor(vec2(0.0,1.0));","\t\tcolor.xyz /= color.w;","       if(isNan(color.xyz)){color=vec4(0.0);}","\t\tfloat luminance = dot(color.rgb, vec3(0.3,0.6,0.1));","\t\tif(luminance<threshold) color=vec4(0.0);","\t\tgl_FragColor = vec4(color.xyz,1.0);","\t#endif","}"].join("\n")},s={uniforms:{tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},invSize:{type:"v2",value:new e.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform vec2 invSize;","varying vec2 vUv;","vec4 GetSourceTexture(vec2 delta){","vec2 coord = vUv+delta * invSize;","return texture2D( tDiffuse2, coord );","}","void main() {","vec4 color = GetSourceTexture(vec2(0,0))*0.25;","color += GetSourceTexture(vec2(-1,-1))*0.0625;","color += GetSourceTexture(vec2( 1,-1))*0.0625;","color += GetSourceTexture(vec2( 1, 1))*0.0625;","color += GetSourceTexture(vec2(-1, 1))*0.0625;","color += GetSourceTexture(vec2( 0,-1))*0.125;","color += GetSourceTexture(vec2( 0, 1))*0.125;","color += GetSourceTexture(vec2( 1, 0))*0.125;","color += GetSourceTexture(vec2(-1, 0))*0.125;","color += texture2D( tDiffuse3, vUv );","gl_FragColor = color;","}"].join("\n")},o={uniforms:{tDiffuse2:{type:"t",value:null},invSize:{type:"v2",value:new e.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse2;","uniform vec2 invSize;","varying vec2 vUv;","vec4 GetSourceTexture(vec2 delta){","vec2 coord = vUv+delta * invSize;","return texture2D( tDiffuse2, coord );","}","void main() {","vec4 color = GetSourceTexture(vec2(0,0))*0.25;","color += GetSourceTexture(vec2(-1,-1))*0.0625;","color += GetSourceTexture(vec2( 1,-1))*0.0625;","color += GetSourceTexture(vec2( 1, 1))*0.0625;","color += GetSourceTexture(vec2(-1, 1))*0.0625;","color += GetSourceTexture(vec2( 0,-1))*0.125;","color += GetSourceTexture(vec2( 0, 1))*0.125;","color += GetSourceTexture(vec2( 1, 0))*0.125;","color += GetSourceTexture(vec2(-1, 0))*0.125;","gl_FragColor = color;","}"].join("\n")},l={uniforms:{tDiffuse2:{type:"t",value:null},invSize:{type:"v2",value:new e.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse2;","uniform vec2 invSize;","varying vec2 vUv;","vec4 GetSourceTexture(vec2 delta){","vec2 coord = vUv+delta * invSize;","return texture2D( tDiffuse2, coord );","}","void main() {","vec4 color = GetSourceTexture(vec2(0,0))*0.125;","color += GetSourceTexture(vec2(-1, -1))*0.125;","color += GetSourceTexture(vec2( 1, -1))*0.125;","color += GetSourceTexture(vec2( 1,  1))*0.125;","color += GetSourceTexture(vec2(-1,  1))*0.125;","color += GetSourceTexture(vec2(-2,  0))*0.0625;","color += GetSourceTexture(vec2( 2,  0))*0.0625;","color += GetSourceTexture(vec2( 0, -2))*0.0625;","color += GetSourceTexture(vec2( 0,  2))*0.0625;","color += GetSourceTexture(vec2(-2, -2))*0.03125;","color += GetSourceTexture(vec2( 2, -2))*0.03125;","color += GetSourceTexture(vec2( 2,  2))*0.03125;","color += GetSourceTexture(vec2(-2,  2))*0.03125;","gl_FragColor = color;","}"].join("\n")},c={uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDiffuse4:{type:"t",value:null},tDiffuse5:{type:"t",value:null},tDiffuse6:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform sampler2D tDiffuse4;","uniform sampler2D tDiffuse5;","uniform sampler2D tDiffuse6;","varying vec2 vUv;","void main() {","    vec4 color = texture2D( tDiffuse, vUv );","    vec4 bloom1 = texture2D( tDiffuse2, vUv );","    vec4 bloom2 = texture2D( tDiffuse3, vUv );","    vec4 bloom3 = texture2D( tDiffuse4, vUv );","    vec4 bloom4 = texture2D( tDiffuse5, vUv );","    vec4 bloom5 = texture2D( tDiffuse6, vUv );","    vec3 bloom = 0.5 * bloom1.rgb + 0.5 * bloom2.rgb + 0.5 * bloom3.rgb + 0.5 * bloom4.rgb + 0.5 * bloom5.rgb;","    float bloomFactor = 0.9;","\t vec3 result = color.rgb + bloomFactor * bloom;","\t float maxComponent = max(result.x, max(result.y, result.z));","\t if (maxComponent > 1.0) { result /= maxComponent; }","    gl_FragColor = vec4(result, color.a);","}"].join("\n")},h={uniforms:{bloomFactor:{type:"f",value:.9},tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDiffuse4:{type:"t",value:null},tDiffuse5:{type:"t",value:null},tDiffuse6:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float bloomFactor;","#if(USE_BLOOM >= 1)","\tuniform sampler2D tDiffuse2;","#endif","#if(USE_BLOOM == 2)","\tuniform sampler2D tDiffuse3;","\tuniform sampler2D tDiffuse4;","\tuniform sampler2D tDiffuse5;","\tuniform sampler2D tDiffuse6;","#endif","varying vec2 vUv;","void main() {","   vec4 inColorAlpha = texture2D( tDiffuse, vUv );","   vec3 inColor = inColorAlpha.xyz;","#if (USE_BLOOM == 1)","    vec3 bloom = texture2D( tDiffuse2, vUv ).xyz;","\t inColor += bloomFactor * bloom;","#elif (USE_BLOOM == 2)","    vec4 bloom1 = texture2D( tDiffuse2, vUv );","    vec4 bloom2 = texture2D( tDiffuse3, vUv );","    vec4 bloom3 = texture2D( tDiffuse4, vUv );","    vec4 bloom4 = texture2D( tDiffuse5, vUv );","    vec4 bloom5 = texture2D( tDiffuse6, vUv );","    vec3 bloom = 0.5 * bloom1.rgb + 0.5 * bloom2.rgb + 0.5 * bloom3.rgb + 0.5 * bloom4.rgb + 0.5 * bloom5.rgb;","\t inColor += bloomFactor * bloom;","#endif","    gl_FragColor = vec4(inColor, inColorAlpha.a);","}"].join("\n")};return{Threshold:a,Blur:t(),Blur2:t(2),BlurH:i(),BlurH2:i(2),BlurV:r,UpAdd:s,UpReplace:o,Down:l,PoissonBlur:n,FinalBlending:c,MixShader:h}}),define("Shaders/BloomShaders",["DS/Shaders/BloomShaders","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/BloomShaders"),e}),define("DS/Effects/BlurShadowEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/BloomShaders","DS/Plugins/ClearPass"],function(e,t,i,r,n,a){"use strict";var s={uniforms:{tDiffuse2:{type:"t",value:null},shadowMatrix:{type:"m4",value:new e.Matrix4},intensity:{type:"f",value:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse2;","uniform mat4 shadowMatrix;","uniform float intensity;","varying vec2 vUv;","float unpackDepth( const in vec4 rgba_depth ) {","float depth=1.0;","#if IS_ESM == 1","   #ifdef USE_UINT_ESM","\t    depth = log(unpackRGB( rgba_depth.xyz) * pow(10.0,rgba_depth.w*255.0))/80.0;","   #else","       depth = log(rgba_depth.x)/80.0;","  #endif","#else","       depth = unpackRGBA(rgba_depth);","#endif","return depth;","}","void main() {","gl_FragColor = vec4(1.0);","vec4 mpos = vec4(vUv, 0.0, 1.0);","vec4 shadowCoord = shadowMatrix * mpos;","shadowCoord.xyz /= shadowCoord.w;","float shadowDepth = unpackDepth(texture2D(tDiffuse2, shadowCoord.xy));","if (shadowDepth < 1.0) {","  gl_FragColor.x = intensity;","}","}"].join("\n")};return t.extend({init:function(e,t){return this._parent(e),this.renderer=e,this.rtPool=t,s.defines={IS_ESM:0},this.map=null,this.intensity=.5,this.passShadow=null,this.passBlurH=null,this.passBlurV=null,this},setSize:function(e,t){this.width=parseInt(e),this.height=parseInt(t)},setIntensity:function(e){this.intensity=1-e,this.passShadow.uniforms.intensity.value=this.intensity},setInput:function(t,o){if(t){if(this.map=t,this.composers[0])this.composers[0].setSize(this.width,this.height),this.passBlurH.uniforms.invSize.value.set(1/this.width,1/this.height),this.passBlurV.uniforms.invSize.value.set(1/this.width,1/this.height);else{var l=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers[0]=new i(this.renderer,l,this.rtPool),this.composers[0].composerContext.keepResult=!1,this.clearPass=new a("groundShadowClearPass"),this.passShadow=new r(s,void 0,"GroundShadowEffect"),this.passBlurH=new r(n.BlurH,void 0,"GroundShadowEffectBlurH"),this.passBlurV=new r(n.BlurV,void 0,"GroundShadowEffectBlurV"),this.passBlurH.material.defines={LEVEL:5},this.passBlurV.material.defines={LEVEL:5},this.passBlurH.uniforms.invSize.value.set(1/this.width,1/this.height),this.passBlurV.uniforms.invSize.value.set(1/this.width,1/this.height),this.passBlurH.material.needsUpdate=!0,this.passBlurV.material.needsUpdate=!0,this.passBlurH.renderToScreen=!1,this.passBlurV.renderToScreen=!1,this.composers[0].addPass(this.clearPass),this.composers[0].addPass(this.passShadow),this.composers[0].addPass(this.passBlurH),this.composers[0].addPass(this.passBlurV),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.setPassClear(this.clearPass,!0,new e.Color(16777215),1)}this.passShadow.uniforms.tDiffuse2.value=this.map,this.passShadow.uniforms.shadowMatrix.value.copy(o)}},execute:function(){var t=this.renderer.shadowMapType===e.ESMShadowMap||this.renderer.shadowMapType===e.ESMImprovedShadowMap;t&&1!=this.passShadow.material.defines.IS_ESM&&(this.passShadow.material.defines.IS_ESM=1,this.passShadow.material.needsUpdate=!0),t||1!=this.passShadow.material.defines.IS_ESM||(this.passShadow.material.defines.IS_ESM=0,this.passShadow.material.needsUpdate=!0),this.composers[0].render(0,void 0,void 0,"toto")},getResult:function(){return this.composers[0].getRenderResult("toto")}})}),define("DS/Gestures/HoldGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture","DS/WebRecordEnabler/Adapter"],function(e,t,i,r){"use strict";var n=i.extend({init:function(){return this._parent("Hold"),this.priority=10,this.identifier=null,this.maxTime=THREEDS.VisuEventsManager.getHoldTime(),this.maxDistance=10,this.timer=null,this.startTime=0,this.endTime=0,this},detect:function(e){this._parent(e);var n=this;switch(this.state){case i.State.INIT:1===(a=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE])).length&&(this.resetTimer(),1===(a=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN],this.view)).length&&(this.identifier=a[0].identifier,r.isReplaying()||(this.timer=setTimeout(function(){n.events=[a[0]],n.endTime=(new Date).getTime(),n.changeState(i.State.OK),n.execute(!0)},this.maxTime)),this.startTime=a[0].startTime,this.changeState(i.State.BEGIN)));break;case i.State.BEGIN:var a=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE]),s=THREEDS.VisuEventsManager.getTouchEventById(this.identifier);1!==a.length||null===s||s.state===t.State.END?(this.resetTimer(),this.changeState(i.State.KO)):s.state===t.State.MOVE&&s.offsetPosition.length()>this.maxDistance&&(this.resetTimer(),this.changeState(i.State.KO));break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}},resetTimer:function(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null)},getTouchPoint:function(){return this.getEvents().length>0?this.getEvents()[0].getCurrentPosition():null},getElapsedTime:function(){return this.getEvents().length>0?this.endTime-this.startTime:null}});return UWA.namespace("THREEDS/Gestures/HoldGesture",n)}),define("Gestures/HoldGesture",["DS/Gestures/HoldGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/HoldGesture"),e}),define("DS/Manipulators/PlaneTranslationManipulator",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator","DS/Visualization/PathElement"],function(e,t,i,r){"use strict";var n=i.extend({init:function(t){var i;return i=this.DEPRECATED_CONSTRUCTOR(arguments)?{axis:arguments[1]}:t||{},this._parent(),this.axis=i.axis,this.axis.normalize(),this.projector=new e.Projector,this},BeginManipulate:function(t,i,r){this._parent(t,i,r),this.initial3dIntersectionPoint=r.position,this.plane=(new e.Plane).setFromNormalAndCoplanarPoint(this.axis,r.position);var n={viewer:i.viewer,eventChannel:"BeginManipulate",event:i,paths:this.manipulatedPaths,intersection:r,manipulator:this};this.publish("BeginManipulate",n)},Manipulate:function(t,i,r){this._parent(t,i,r);var n=(new e.Vector2).copy(i.from[0].getCurrentPosition(i.viewer.canvas)),a=i.viewer.currentViewpoint.create3DRayFrom2DPoint(n).intersectPlane(this.plane),s=(new e.Vector3).subVectors(a,this.initial3dIntersectionPoint);s.projectOnPlane(this.axis);var o={viewer:i.viewer,eventChannel:"Manipulate",event:i,paths:this.manipulatedPaths,translationVector:s,intersection:r,manipulator:this};this.publish("Manipulate",o)},EndManipulate:function(t,i,r){var n=(new e.Vector2).copy(i.from[0].getCurrentPosition(i.viewer.canvas)),a=i.viewer.currentViewpoint.create3DRayFrom2DPoint(n).intersectPlane(this.plane),s=(new e.Vector3).subVectors(a,this.initial3dIntersectionPoint);s.projectOnPlane(this.axis);var o={viewer:i.viewer,eventChannel:"EndManipulate",event:i,paths:this.manipulatedPaths,translationVector:s,intersection:r,manipulator:this};this.publish("EndManipulate",o),this._parent(t,i,r)},BeginPreactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"BeginPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("BeginPreactivate",r)},Preactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"Preactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("Preactivate",r)},EndPreactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"EndPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("EndPreactivate",r)},PrimaryPointerClick:function(e,t,i){var r={viewer:t.viewer,eventChannel:"PrimaryPointerClick",event:t,intersection:i,manipulator:this};this.publish("PrimaryPointerClick",r)},PrimaryPointerDoubleClick:function(e,t,i){var r={viewer:t.viewer,eventChannel:"PrimaryPointerDoubleClick",event:t,intersection:i,manipulator:this};this.publish("PrimaryPointerDoubleClick",r)}});return UWA.namespace("THREEDS/Nodes/PlaneTranslationManipulator",n)}),define("Manipulators/PlaneTranslationManipulator",["DS/Manipulators/PlaneTranslationManipulator","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Manipulators/PlaneTranslationManipulator"),e}),define("DS/Shaders/DisplayIrradianceMapShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{uniforms:{tDiffuse1:{type:"t",value:null},offset1:{type:"v2",value:new e.Vector2(0,.5)},scale1:{type:"f",value:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse1;","uniform vec2 offset1;","uniform float scale1;","varying vec2 vUv;","void main() {","gl_FragColor = vec4(0.0);","vec2 vUv2 = (vUv - offset1) / scale1;","if (vUv2.x > 0.0 && vUv2.y > 0.0 && vUv2.x < 1.0 && vUv2.y < 1.0) {","    vec3 color = texture2D( tDiffuse1, vUv2 ).xyz;","    color = pow(color, vec3(1.0 / 2.2));","    gl_FragColor = vec4(color, 1.0); return;","}","}"].join("\n")}}),define("Shaders/DisplayIrradianceMapShader",["DS/Shaders/DisplayIrradianceMapShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/DisplayIrradianceMapShader"),e}),define("DS/Visualization/PickingMode",["DS/Visualization/ThreeJS_DS","DS/Visualization/RenderMode","DS/Mesh/Mesh"],function(e,t,i){"use strict";const r=new t;class n{constructor(){this.pickingModeMSB=e.ShowAllFaces|e.AllPointsButSurfacicPointsRenderPointMask|e.WireEdgeRenderLineModeMask,this.pickingModeLSB=e.BodyLinesMask|e.SurfacicPointRenderPointMask}clone(){var e=new n;return e.pickingModeMSB=this.pickingModeMSB,e.pickingModeLSB=this.pickingModeLSB,e}applyToAll(e){this.setPickingMode("Face",e),this.setPickingMode("InternalSharpEdge",e),this.setPickingMode("Edge",e),this.setPickingMode("InternalSmoothEdge",e),this.setPickingMode("BoundaryEdge",e),this.setPickingMode("WireEdge",e),this.setPickingMode("BoundaryPoint",e),this.setPickingMode("SharpPoint",e),this.setPickingMode("SmoothPoint",e),this.setPickingMode("FreePoint",e),this.setPickingMode("AxisSystem",e),this.setPickingMode("InfiniteFace",e)}_fromRenderer(e){this.pickingModeLSB=e.pickingModeLSB,this.pickingModeMSB=e.pickingModeMSB}_getPickingMasks(e){var i=this.pickingModeLSB,r=this.pickingModeMSB,n=~r&i|r&i&~e|e&(r^i),a=n&t.pointsMask;return[n&t.facesMask,n&t.linesPickingMask,a]}getPickingMasks(e){var t=e.getMask();return this._getPickingMasks(t)}_setPickingMode(e,t){var r=this.pickingModeLSB,n=this.pickingModeMSB;switch(t){case i.PICK_NEVER:this.pickingModeMSB=n&~e,this.pickingModeLSB=r&~e;break;case i.PICK_ALWAYS:this.pickingModeMSB=n&~e,this.pickingModeLSB=r|e;break;case i.PICK_VISIBLE:this.pickingModeMSB=n|e,this.pickingModeLSB=r&~e;break;case i.PICK_INVISIBLE:this.pickingModeMSB=n|e,this.pickingModeLSB=r|e}}setPickingMode(e,t){r._mask=0,r.setRenderMode(e,!0),this._setPickingMode(r.getMask(),t)}}return e.PickingMode=n,n}),define("DS/Manipulators/RotationManipulator",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator"],function(e,t,i){"use strict";var r=i.extend({init:function(t){var i;return i=this.DEPRECATED_CONSTRUCTOR(arguments)?{axis:arguments[1]}:t||{},this._parent(),this.axis=i.axis,this.axis.normalize(),this.centerPosition=new e.Vector3,this.fromCenterToInitial=new e.Vector3,this.plane=new e.Plane,this.projector=new e.Projector,this},BeginManipulate:function(e,t,i){this._parent(e,t,i),this.initial3dIntersectionPoint=i.position,this.plane.setFromNormalAndCoplanarPoint(this.axis,this.initial3dIntersectionPoint),this.fromCenterToInitial.subVectors(this.initial3dIntersectionPoint,this.centerPosition),this.fromCenterToInitial.projectOnPlane(this.axis),this.fromCenterToInitial.normalize();var r={viewer:t.viewer,eventChannel:"BeginManipulate",event:t,paths:this.manipulatedPaths,intersection:i,manipulator:this};this.publish("BeginManipulate",r)},Manipulate:function(t,i,r){this._parent(t,i,r);var n=(new e.Vector2).copy(i.from[0].getCurrentPosition(i.viewer.canvas)),a=i.viewer.currentViewpoint.create3DRayFrom2DPoint(n).intersectPlane(this.plane),s=(new e.Vector3).subVectors(a,this.centerPosition);s.projectOnPlane(this.axis),s.normalize();var o=new e.Vector3;o.crossVectors(this.fromCenterToInitial,s),o.normalize();var l=this.fromCenterToInitial.angleTo(s),c=(new e.Matrix4).makeRotationAxis(o,l),h={viewer:i.viewer,eventChannel:"Manipulate",event:i,paths:this.manipulatedPaths,rotationMatrix:c,angle:l,axis:o,center:this.centerPosition,intersection:r,manipulator:this};this.publish("Manipulate",h)},EndManipulate:function(t,i,r){var n=(new e.Vector2).copy(i.from[0].getCurrentPosition(i.viewer.canvas)),a=i.viewer.currentViewpoint.create3DRayFrom2DPoint(n).intersectPlane(this.plane),s=(new e.Vector3).subVectors(a,this.centerPosition);s.projectOnPlane(this.axis),s.normalize();var o=new e.Vector3;o.crossVectors(this.fromCenterToInitial,s),o.normalize();var l=this.fromCenterToInitial.angleTo(s),c=(new e.Matrix4).makeRotationAxis(o,l),h={viewer:i.viewer,eventChannel:"EndManipulate",event:i,paths:this.manipulatedPaths,rotationMatrix:c,angle:l,axis:o,center:this.centerPosition,intersection:r,manipulator:this};this.publish("EndManipulate",h),this._parent(t,i,r)},setCenter:function(e){this.centerPosition=e},setAxis:function(e){this.axis=e},BeginPreactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"BeginPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("BeginPreactivate",r)},Preactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"Preactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("Preactivate",r)},EndPreactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"EndPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("EndPreactivate",r)},PrimaryPointerClick:function(e,t,i){var r={viewer:t.viewer,eventChannel:"PrimaryPointerClick",event:t,intersection:i,manipulator:this};this.publish("PrimaryPointerClick",r)},PrimaryPointerDoubleClick:function(e,t,i){var r={viewer:t.viewer,eventChannel:"PrimaryPointerDoubleClick",event:t,intersection:i,manipulator:this};this.publish("PrimaryPointerDoubleClick",r)}});return UWA.namespace("THREEDS/Nodes/RotationManipulator",r)}),define("Manipulators/RotationManipulator",["DS/Manipulators/RotationManipulator","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Manipulators/RotationManipulator"),e}),define("DS/Shaders/EncodeHDRShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{uniforms:{map:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D map;","varying vec2 vUv;","void main() {","vec3 color = texture2D(map, vUv).rgb;","float value = max(color.r, max(color.g, color.b));","int exponent = 0;","float mantissa = 0.0;","if (value > 1.0) {","for (int i = 1; i <= 127; i++) {","value /= 2.0;","exponent++;","if (value < 1.0) { break; }","}","} else if (value < 1.0) {","int j = 1;","for (int i = 1; i <= 129; i++) {","value *= 2.0;","exponent--;","if (value > 1.0) { j = 0; break; }","}","value /= 2.0;","exponent++;","if (j > 0) {","color = vec3(0.0);","exponent = 0;","}","}","gl_FragColor = vec4(color * pow(2.0, float(-exponent)), float(exponent + 128) / 255.0);","}"].join("\n")}}),define("Shaders/EncodeHDRShader",["DS/Shaders/EncodeHDRShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/EncodeHDRShader"),e}),define("DS/Gestures/HoldStayGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture","DS/WebRecordEnabler/Adapter"],function(e,t,i,r){"use strict";var n=i.extend({init:function(){return this._parent("HoldStay"),this.priority=11,this.identifier=null,this.maxTime=THREEDS.VisuEventsManager.getHoldTime(),this.stayTimerTime=100,this.maxDistance=10,this.timer=null,this.stayTimer=null,this.startTime=0,this.endTime=0,this},detect:function(e){this._parent(e);var n=this;switch(this.state){case i.State.INIT:1===(a=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE])).length&&(this.resetAllTimers(),1===(a=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN],this.view)).length&&(this.identifier=a[0].identifier,r.isReplaying()||(this.timer=setTimeout(function(){n.events=[a[0]],n.endTime=(new Date).getTime(),n.changeState(i.State.CHANGE),n.stayTimer=setInterval(function(){n.events=[a[0]],n.endTime=(new Date).getTime(),n.changeState(i.State.CHANGE),n.execute(!0)},n.stayTimerTime),n.execute(!0)},this.maxTime)),this.startTime=a[0].startTime,this.changeState(i.State.BEGIN)));break;case i.State.BEGIN:var a=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE]),s=THREEDS.VisuEventsManager.getTouchEventById(this.identifier);1!==a.length||null===s||s.state===t.State.END?(this.resetAllTimers(),this.changeState(i.State.KO)):s.state===t.State.MOVE&&s.offsetPosition.length()>this.maxDistance&&(this.resetAllTimers(),this.changeState(i.State.KO));break;case i.State.CHANGE:a=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE]),s=THREEDS.VisuEventsManager.getTouchEventById(this.identifier);1!==a.length||null===s||s.state===t.State.END?(this.resetAllTimers(),this.changeState(i.State.KO)):s.state===t.State.MOVE&&(s.offsetPosition.length()>this.maxDistance?(this.resetAllTimers(),this.changeState(i.State.KO)):this.events=[s]);break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.startTime=0,this.endTime=0,this.changeState(i.State.INIT)}},resetTimer:function(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null)},resetStayTimer:function(){null!==this.stayTimer&&(clearInterval(this.stayTimer),this.stayTimer=null)},resetAllTimers:function(){this.resetStayTimer(),this.resetTimer()},getTouchPoint:function(){return this.getEvents().length>0?this.getEvents()[0].getCurrentPosition():null},getElapsedTime:function(){return this.getEvents().length>0?this.endTime-this.startTime:null}});return UWA.namespace("THREEDS/Gestures/HoldStayGesture",n)}),define("Gestures/HoldStayGesture",["DS/Gestures/HoldStayGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/HoldStayGesture"),e}),define("DS/VisuEvents/MouseEvent",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent"],function(e,t){"use strict";var i=t.extend({init:function(e,t){return this._parent(t),this.type="Mouse",this.button=e,this},update:function(i){var r;this._parent(i);try{r=this.view.getBoundingClientRect()}catch(e){r={left:0,top:0}}var n=i.clientX,a=i.clientY;switch(void 0!==i.po_x&&(n=i.po_x),void 0!==i.po_y&&(a=i.po_y),i.type){case"mousedown":case"wheel":case"mousewheel":case"DOMMouseScroll":this.currentPosition.set(n-r.left,a-r.top),this.startPosition.copy(this.currentPosition),this.lastPosition.copy(this.currentPosition),this.deltaPosition.set(0,0),this.offsetPosition.set(0,0),this._currentPosition.set(n,a),this._startPosition.copy(this._currentPosition),this._lastPosition.copy(this._currentPosition),this._deltaPosition.set(0,0),this._offsetPosition.set(0,0),this.button===t.MouseButton.LEFT&&this.setPrimary(!0);break;case"mousemove":var s=new e.Vector2(n-r.left,a-r.top);this.lastPosition.copy(this.currentPosition),this.deltaPosition.subVectors(s,this.currentPosition),this.currentPosition.copy(s),this.offsetPosition.subVectors(this.currentPosition,this.startPosition),s.set(n,a),this._lastPosition.copy(this._currentPosition),this._deltaPosition.subVectors(s,this._currentPosition),this._currentPosition.copy(s),this._offsetPosition.subVectors(this._currentPosition,this._startPosition);break;case"mouseup":case"mouseleave":case"mouseout":s=new e.Vector2(n-r.left,a-r.top);this.lastPosition.copy(this.currentPosition),this.deltaPosition.subVectors(s,this.currentPosition),this.currentPosition.copy(s),this.offsetPosition.subVectors(this.currentPosition,this.startPosition),s.set(n,a),this._lastPosition.copy(this._currentPosition),this._deltaPosition.subVectors(s,this._currentPosition),this._currentPosition.copy(s),this._offsetPosition.subVectors(this._currentPosition,this._startPosition)}},getButton:function(){return this.button}});return UWA.namespace("THREEDS/Events/MouseEvent",i)}),define("VisuEvents/MouseEvent",["DS/VisuEvents/MouseEvent","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuEvents/MouseEvent"),e}),define("DS/Visualization/KDTree",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],function(e,t,i){"use strict";var r=new t.Box3,n=function(e,t,i){return e.setValues(t[i],t[i+1],t[i+2],t[i+3],t[i+4],t[i+5]),e},a=function(e,i){this.renderable=null,this.nodesUint8=null,this.nodesUint32=null,this.nodesFloat32=null,this.nbAllocatedNodes=0,this.nextFreeNode=0,this.aabb=new t.Box3,this.eltsAsBinary=!0,this.elts=this.eltsAsBinary?null:[],this.eltIndices=null,this.nextFreeIndex=0,this.nbAllocatedIndices=0,this.maxElts=void 0!==e?e:100,this.maxDepth=void 0!==i?i:8,this.intersectionCost=80,this.traversalCost=1,this.emptyBonus=.5,this.debugInfos={initTime:0,totalTime:0,computeCostTime:0,sortTime:0,nbLeafNodesBiggerThanMaxElts:0}};return a.prototype={constructor:a,resetDebugInfos:function(){this.debugInfos.initTime=0,this.debugInfos.totalTime=0,this.debugInfos.computeCostTime=0,this.debugInfos.sortTime=0,this.debugInfos.nbLeafNodesBiggerThanMaxElts=0},printDebugInfos:function(){console.log("init time: "+this.debugInfos.initTime+" ms"),console.log("total time: "+this.debugInfos.totalTime+" ms"),console.log("cost time: "+this.debugInfos.computeCostTime+" ms"),console.log("sort time: "+this.debugInfos.sortTime+" ms"),console.log("number of allocated nodes: "+this.nbAllocatedNodes),console.log("number of used nodes: "+this.nextFreeNode),console.log("number of leaf nodes above maxElts: "+this.debugInfos.nbLeafNodesBiggerThanMaxElts),console.log("number of stored indices: "+this.nbAllocatedIndices);var e=this.eltsAsBinary?this.elts?4*this.elts.length:0:8*this.elts.length,t=8*this.nbAllocatedNodes+e+4*this.nbAllocatedIndices;console.log("estimated kd-tree allocation = "+t/1048576+" MB")},reallocateTreeNodes:function(e){var t=new ArrayBuffer(8*e),i=new Uint8Array(t),r=new Uint32Array(t),n=new Float32Array(t);if(this.nbAllocatedNodes>0)for(var a=0;a<8*this.nbAllocatedNodes;a++)i[a]=this.nodesUint8[a];this.nbAllocatedNodes=e,this.nodesUint8=i,this.nodesUint32=r,this.nodesFloat32=n},reallocateIndices:function(e){var t=new Uint32Array(e);if(this.nbAllocatedIndices>0)for(var i=0;i<this.nbAllocatedIndices;i++)t[i]=this.eltIndices[i];this.nbAllocatedIndices=e,this.eltIndices=t},optimizeMemory:function(){this.nbAllocatedNodes>this.nextFreeNode&&this.reallocateTreeNodes(this.nextFreeNode),this.nbAllocatedIndices>this.nextFreeIndex&&this.reallocateIndices(this.nextFreeIndex)},buildFast:function(e,t){var i=this.eltsAsBinary?e.length/4:e.length;this.elts=e,console.log("kd-tree #elts = "+i),this.resetDebugInfos();var a=performance.now();if(this.eltsAsBinary)for(var s=0;s<i;s++)n(r,t,6*s),this.aabb.union(r);else for(s=0;s<i;s++)this.aabb.union(t[s]);var o=new Uint32Array(i),l=new Uint32Array((this.maxDepth+1)*i),c=new Uint32Array(i);for(s=0;s<i;s++)c[s]=s;this.debugInfos.initTime=performance.now()-a,this._buildFast(0,this.aabb,t,{ptr:c,offset:0},i,this.maxDepth,{ptr:o,offset:0},{ptr:l,offset:0}),this.optimizeMemory(),this.debugInfos.totalTime=performance.now()-a,this.printDebugInfos()},_buildFast:function(e,t,i,a,s,o,l,c){if(this.nextFreeNode===this.nbAllocatedNodes&&this.reallocateTreeNodes(Math.max(512,2*this.nbAllocatedNodes)),this.nextFreeNode++,s<=this.maxElts||0===o)this.initLeafNode(e,a,s);else{for(var h=t.size().getMaxAxis(),u=.5*(t.min.getComponent(h)+t.max.getComponent(h)),d=0,p=0,f=0;f<s;f++){var m,g=a.ptr[a.offset+f];(m=this.eltsAsBinary?n(r,i,6*g):i[g]).min.getComponent(h)<=u&&(l.ptr[l.offset+d++]=g),m.max.getComponent(h)>=u&&(c.ptr[c.offset+p++]=g)}var v=t.clone(),S=t.clone();v.max.setComponent(h,u),S.min.setComponent(h,u),this._buildFast(e+1,v,i,l,d,o-1,l,{ptr:c.ptr,offset:c.offset+s});var _=this.nextFreeNode;this.initInteriorNode(e,h,_,u),this._buildFast(_,S,i,c,p,o-1,l,{ptr:c.ptr,offset:c.offset+s})}},initInteriorNode:function(e,t,i,r){var n=i<<2;n|=t,this.nodesUint32[2*e]=n,this.nodesFloat32[2*e+1]=r},initLeafNode:function(e,t,i){var r=i<<2;r|=3,this.nodesUint32[2*e]=r,i>this.maxElts&&this.debugInfos.nbLeafNodesBiggerThanMaxElts++;var n=0;if(0===i)n=0;else if(1===i)n=t.ptr[t.offset];else{n=this.nextFreeIndex,this.nextFreeIndex+i>=this.nbAllocatedIndices&&this.reallocateIndices(Math.max(512,2*this.nbAllocatedIndices));for(var a=0;a<i;a++)this.eltIndices[this.nextFreeIndex+a]=t.ptr[t.offset+a];this.nextFreeIndex+=i}this.nodesUint32[2*e+1]=n},isLeafNode:function(e){return 3==(3&this.nodesUint32[2*e])},getSplitAxis:function(e){return 3&this.nodesUint32[2*e]},getSplitPosition:function(e){return this.nodesFloat32[2*e+1]},getNbElts:function(e){return this.nodesUint32[2*e]>>2},getNbTotalElts:function(){return this.eltsAsBinary?this.elts?this.elts.length/4:0:this.elts.length},getNbNodes:function(){return this.nbAllocatedNodes},getEltIndices:function(e){return this.nodesUint32[2*e+1]},getAboveChild:function(e){return this.nodesUint32[2*e]>>2},setBoundEdge:function(e,t,i,r,n){var a=r<<1;a|=n,e.float32View[2*t]=i,e.uint32View[2*t+1]=a},getBoundEdgeValue:function(e,t){return e.float32View[2*t]},getBoundEdgeEltNum:function(e,t){return e.uint32View[2*t+1]>>1},getBoundEdgeType:function(e,t){return 1&e.uint32View[2*t+1]},intersect:function(e,i,r,n){var a=new t.Vector2;if(!e.intersectBox(this.aabb,void 0,a))return!1;for(var s=new t.Vector3(1/e.direction.x,1/e.direction.y,1/e.direction.z),o=[],l=0,c=0,h=this.aabb.clone();c>=0&&!(n&&n<a.x);)if(r&&r({aabb:h,nodeId:c}),this.isLeafNode(c)){var u=this.getNbElts(c);if(1===u){var d,p=this.getEltIndices(c);if(this.eltsAsBinary){var f=this.renderable.geometry[this.elts[4*p]],m=this.elts[4*p+3];d={dg:f.drawingGroups[this.elts[4*p+1]],primitive:this.elts[4*p+2],offset:4294967295===m?-1:m}}else d=this.elts[p];i&&i(d,c,p)}else for(var g=0;g<u;g++){p=this.eltIndices[this.getEltIndices(c)+g];if(this.eltsAsBinary){f=this.renderable.geometry[this.elts[4*p]],m=this.elts[4*p+3];d={dg:f.drawingGroups[this.elts[4*p+1]],primitive:this.elts[4*p+2],offset:4294967295===m?-1:m}}else d=this.elts[p];i&&i(d,c,p)}if(!(l>0))break;c=o[--l].nodeId,a.copy(o[l].tMinMax),h=o[l].aabb}else{var v,S,_,y,x=this.getSplitAxis(c),M=this.getSplitPosition(c),P=e.origin.getComponent(x),C=(M-P)*s.getComponent(x),b=h.clone(),D=h.clone();b.max.setComponent(x,M),D.min.setComponent(x,M),P<M||P===M&&e.direction.getComponent(x)<=0?(v=c+1,S=this.getAboveChild(c),_=b,y=D):(v=this.getAboveChild(c),S=c+1,_=D,y=b),C>a.y||C<=0?(c=v,h=_):C<a.x?(c=S,h=y):(o[l]={nodeId:S,tMinMax:new t.Vector2(C,a.y),aabb:y},l++,c=v,h=_,a.y=C)}return!1},buildFromMesh:function(e,r,n,a,s,o){this.renderable=e;var l=!n||n.isIdentity(),c=null,h=0,u=new i.SGPrimitiveHelper;if(e.geometry.length>=0?(c=e.geometry[0],h=e.geometry.length):2===e.geometry._type&&(c=e.geometry,h=1),!c||c.vertexIndexArray){for(var d=0,p=1024,f=a||(this.eltsAsBinary?new Uint32Array(4096):[]),m=s||(this.eltsAsBinary?new Float32Array(6144):[]),g=new t.Vector3,v=new t.Vector3,S=new t.Vector3,_=new t.Box3,y=new t.Box3,x=0;x<h;x++){for(var M=c.drawingGroups,P=M.length,C=c.vertexIndexArray,b=0;b<P;b++)for(var D=M[b],w=D.getPrimitivesCount(),E=0;E<w;E++){u.set(D,E);var T=u.getStart(),A=T+u.getCount(),I=this.eltsAsBinary?_:new t.Box3;switch(this.eltsAsBinary&&I.makeEmpty(),D.glType){case 4:case 5:for(var R=T;R<A;R+=3){var L,O,N;if(D.nonIndexed?(L=R,O=R+1,N=R+2):(L=C[R],O=C[R+1],N=C[R+2]),c.getVertexPosition(L,g),c.getVertexPosition(O,v),c.getVertexPosition(N,S),l||(g.applyMatrix4(n),v.applyMatrix4(n),S.applyMatrix4(n)),r)I.expandByPoint(g),I.expandByPoint(v),I.expandByPoint(S);else{var F=this.eltsAsBinary?y:new t.Box3;if(F.setFromPoints([g,v,S]),this.eltsAsBinary){if(d>=p){var V=new Uint32Array(2*p*4),U=new Float32Array(2*p*6);V.set(f),U.set(m),p*=2,f=V,m=U}f[4*d]=x,f[4*d+1]=b,f[4*d+2]=E,f[4*d+3]=R,m[6*d]=F.min.x,m[6*d+1]=F.min.y,m[6*d+2]=F.min.z,m[6*d+3]=F.max.x,m[6*d+4]=F.max.y,m[6*d+5]=F.max.z,d++}else f.push({dg:D,primitive:E,offset:R}),m.push(F)}}}if(r)if(this.eltsAsBinary){if(d>=p){V=new Uint32Array(2*p*4),U=new Float32Array(2*p*6);V.set(f),U.set(m),p*=2,f=V,m=U}f[4*d]=x,f[4*d+1]=b,f[4*d+2]=E,f[4*d+3]=4294967295,m[6*d]=I.min.x,m[6*d+1]=I.min.y,m[6*d+2]=I.min.z,m[6*d+3]=I.max.x,m[6*d+4]=I.max.y,m[6*d+5]=I.max.z,d++}else f.push({dg:D,primitive:E,offset:-1}),m.push(I)}c=e.geometry[x+1]}if(!o){if(this.eltsAsBinary&&d<p){V=new Uint32Array(4*d),U=new Float32Array(6*d);for(var B=0;B<6*d;B++)U[B]=m[B];for(B=0;B<4*d;B++)V[B]=f[B];f=V,m=U}this.buildFast(f,m)}return this}console.warn("kdtree build impossible, make sure noMeshInRAM is inactive")}},t.KDTree=a,a}),define("DS/Gestures/EditGesture",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture","DS/WebRecordEnabler/Adapter"],function(e,t,i,r,n){"use strict";var a=r.extend({init:function(){return this._parent("Edit"),this.priority=10,this.identifier=null,this.maxTimeTouch=THREEDS.VisuEventsManager.getHoldTime(),this.maxTimeMouse=THREEDS.VisuEventsManager.getHoldTime(),this.maxDistance=10,this.timer=null,this._type=-1,this.event=null,this},detect:function(e){this._parent(e);var t=this,a=THREEDS.VisuEventsManager.getTouchEventsByStates([i.State.BEGIN,i.State.MOVE,i.State.IDLE]),s=THREEDS.VisuEventsManager.getMouseEvents(null,this.view),o=null;switch(this.state){case r.State.INIT:if(1===a.length||this.onlyLeftMouse(s))if(this.resetTimer(),1===a.length?(o=THREEDS.VisuEventsManager.getTouchEventsByStates([i.State.BEGIN],this.view),this._type=1):s.length&&(o=THREEDS.VisuEventsManager.getMouseEventsByStates([i.State.BEGIN],0,this.view),this._type=0),o&&1===o.length){this.resetTimer();var l=1===this._type?this.maxTimeTouch:this.maxTimeMouse;this.identifier=o[0].identifier,this.event=o[0],l?(n.isReplaying()||(this.timer=setTimeout(function(){t.events=[o[0]],t.changeState(r.State.OK),t.execute(!0),t._type=-1},l)),this.whenBegin()):(this.events=[o[0]],this.changeState(r.State.OK),this.execute(!0),this._type=-1)}else this._type=-1;break;case r.State.BEGIN:var c=null;1===this._type?c=THREEDS.VisuEventsManager.getTouchEventById(this.identifier):0===this._type&&(c=this.event),1===this._type&&1!==a.length||0===this._type&&!this.onlyLeftMouse(s)||null===c||c.state===i.State.END?this.whenKO():c.state===i.State.MOVE&&c.offsetPosition.length()>this.maxDistance&&this.whenKO();break;case r.State.KO:case r.State.OK:case r.State.CANCEL:this.changeState(r.State.INIT)}},onlyLeftMouse:function(e){for(var t=0;t<e.length;t++)if(0!==e[t].button&&-1!==e[t].button)return!1;return!0},setTimerTouch:function(e){this.maxTimeTouch=e},setTimerMouse:function(e){this.maxTimeMouse=e},resetTimer:function(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null,this._type=-1)},whenBegin:function(){this.changeState(r.State.BEGIN);var t={eventChannel:"/VISU/",eventType:"@onEditEventBegin",eventID:this.id,from:this.currentEvent,gesture:this};e.publish({event:"/VISU/onEditEventBegin",data:t})},whenKO:function(){this.resetTimer(),this.changeState(r.State.KO);var t={eventChannel:"/VISU/",eventType:"@onEditEventKO",eventID:this.id,from:this.currentEvent,gesture:this};e.publish({event:"/VISU/onEditEventKO",data:t})}});return UWA.namespace("THREEDS/Gestures/EditGesture",a)}),define("Gestures/EditGesture",["DS/Gestures/EditGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/EditGesture"),e}),define("DS/Shaders/FXAAShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=["vec3 rgbNW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbNE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbSW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * resolution ).xyz;","vec3 rgbSE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * resolution ).xyz;","vec4 rgbaM  = texture2D( tDiffuse,  gl_FragCoord.xy  * resolution );","vec3 rgbM  = rgbaM.xyz;","float opacity  = rgbaM.w;","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float lumaNW = dot( rgbNW, luma );","float lumaNE = dot( rgbNE, luma );","float lumaSW = dot( rgbSW, luma );","float lumaSE = dot( rgbSE, luma );","float lumaM  = dot( rgbM,  luma );","float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","dir = min( vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),","max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),","dir * rcpDirMin)) * resolution;"].join("\n"),i={uniforms:{tDiffuse:{type:"t",value:null},resolution:{type:"v2",value:new e.Vector2(1/1024,1/512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n")};return{FXAAShader:Object.assign({fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","varying vec2 vUv;","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","void main() {",t,"vec3 rgbA = 0.5 * (","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * ( 1.0 / 3.0 - 0.5 ) ).xyz +","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * ( 2.0 / 3.0 - 0.5 ) ).xyz );","vec3 rgbB = rgbA * 0.5 + 0.25 * (","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * -0.5 ).xyz +","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * 0.5 ).xyz );","float lumaB = dot( rgbB, luma );","if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) ) {","gl_FragColor = vec4( rgbA, opacity );","} else {","gl_FragColor = vec4( rgbB, opacity );","}","}"].join("\n")},i),OITFXAAShader:Object.assign({fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","varying vec2 vUv;","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","vec4 sampleColor(vec2 uv, vec4 color) {","vec4 res = texture2D(tDiffuse, uv);","if (res.a < 1e-6) {","return vec4(color.rgb, 0.2 * color.a);","}","return res;","}","void main() {",t,"vec4 rgbA = 1.0 / 3.0 * ( rgbaM + ","sampleColor(gl_FragCoord.xy  * resolution + dir * ( 1.0 / 3.0 - 0.5 ), rgbaM) +","sampleColor(gl_FragCoord.xy  * resolution + dir * ( 2.0 / 3.0 - 0.5 ), rgbaM) );","vec4 rgbB = rgbA * 0.6 + 0.2 * (","sampleColor(gl_FragCoord.xy  * resolution + dir * -0.5, rgbaM) +","sampleColor(gl_FragCoord.xy  * resolution + dir * 0.5, rgbaM ) );","float lumaB = dot( rgbB.rgb, luma );","if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) ) {","gl_FragColor = rgbA;","} else {","gl_FragColor = rgbB;","}","}"].join("\n")},i)}}),define("Shaders/FXAAShader",["DS/Shaders/FXAAShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/FXAAShader"),e}),define("DS/Shaders/DownSamplingShaders",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t,i,r;return{DownSampling:(t=2,i="tDiffuse"+(t||""),r={uniforms:{invSize:{type:"v2",value:new e.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D "+i+";","varying vec2 vUv;","void main() {","gl_FragColor = texture2D("+i+", vUv);","}"].join("\n")},r.uniforms[i]={type:"t",value:null},r),DownSamplingBlur:function(t){var i="tDiffuse"+(t||""),r={uniforms:{invSize:{type:"v2",value:new e.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D "+i+";","varying vec2 vUv;","void main() {","vec3 result = vec3(0.0);","float total = 0.0;","for (int i = -2; i <= 2; ++i) {","for (int j = -2; j <= 2; ++j) {","vec2 offset = 1.0 * invSize * vec2(float(i), float(j));","float weight = 1.0 / (1.0 + dot(offset, offset));","result += weight * texture2D("+i+", vUv + offset).xyz;","total += weight;","}","}","result /= total;","gl_FragColor = vec4(result, 1.0);","}"].join("\n")};return r.uniforms[i]={type:"t",value:null},r}(2),DownSamplingBlurWithAlpha:function(t){var i="tDiffuse"+(t||""),r={uniforms:{invSize:{type:"v2",value:new e.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D "+i+";","varying vec2 vUv;","void main() {","vec4 result = vec4(0.0);","float totalRGB = 0.0;","float totalA = 0.0;","for (int i = -2; i <= 2; ++i) {","for (int j = -2; j <= 2; ++j) {","vec2 offset = 1.0 * invSize * vec2(float(i), float(j));","float weightA = 1.0;","float weightRGB = 1.0 / (1.0 + dot(offset, offset));","vec4 sampledValue = texture2D("+i+", vUv + offset).rgba;","result += vec4(weightRGB * sampledValue.rgb, weightA * sampledValue.a);",,"totalRGB += weightRGB;","totalA += weightA;","}","}","result.rgb /= totalRGB;","result.a /= totalA;","gl_FragColor = result;","}"].join("\n")};return r.uniforms[i]={type:"t",value:null},r}(2),MergeMips:function(t){for(var i={tDiffuse1:{type:"t",value:null}},r=["uniform sampler2D tDiffuse1;"],n=["if (vUv.y < 0.5) {","gl_FragColor = texture2D(tDiffuse1, vec2(vUv.x, 2.0 * vUv.y));","}"],a=0;a<t;a++){var s=a+2,o=Math.pow(2,-s),l=1/o;i["tDiffuse"+s]={type:"t",value:null},r.push("uniform sampler2D tDiffuse"+s+";");var c=1-o,h=2*o;n.push("else if (vUv.y < "+c+" && vUv.x < "+h+") {"),n.push("vec2 uv = vec2(float("+l/2+") * vUv.x, float("+l+") * (vUv.y - "+(1-h)+"));"),n.push("gl_FragColor = texture2D(tDiffuse"+s+", uv);"),n.push("}")}return n.push("else {"),n.push("gl_FragColor = vec4(vec3(0.0), 1.0);"),n.push("}"),r=r.join("\n"),n=n.join("\n"),{uniforms:i,vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:[r,"varying vec2 vUv;","void main() {",n,"}"].join("\n")}}}}),define("DS/Effects/AbstractHighlightEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/AdvancedHighlightShader","DS/Plugins/ClearPass","DS/Visualization/RenderMode"],function(e,t,i,r,n,a,s,o){"use strict";return t.extend({init:function(t,r,a,s,o,l){this._parent(t),this.sceneGraphSelection=null,this.idString=s||"main",this.prefix=o;var c=new e.WebGLRenderTargetProperties(this.width,this.height,"uintNearest");this.effectComp=new i(t,c,r),this.effectComp.keepResult=!0,this.effectComp.composerContext.name=a+"ComposerContext",this.composers.push(this.effectComp),this.hlClearPass=null,this.hlRenderPass=null,this.mixPass=new n(l,void 0,a);var h=[];return h[0]=-.326212,h[1]=-.405805,h[2]=-.840144,h[3]=-.07358,h[4]=-.695914,h[5]=.457137,h[6]=-.203345,h[7]=.620716,h[8]=.96234,h[9]=-.194983,h[10]=.473434,h[11]=-.480026,h[12]=.519456,h[13]=.767022,h[14]=.185461,h[15]=-.893124,h[16]=.507431,h[17]=.064425,h[18]=.530992,h[19]=.412458,h[20]=-.32194,h[21]=-.871945,h[22]=-.791559,h[23]=.597705,this.mixPass.uniforms.poisson.value=h,this},initEffect:function(e,t){e&&(this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0),t.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tAdd),this.mixPass.addRequiredComposer(this.composers[0])},updateUniforms:function(e){var t=new Array(e.length+1),i=t.length;t[0]=this.sceneGraphSelection.sceneHL;for(var r=1;r<i;r++)t[r]=e[r-1].sceneHL;var n=this.mixPass.defines,a=this.mixPass.uniforms,s=n.NB_CONFIG,o=n.HALO_THICKNESS,l=n.HAS_POLITE,c=this.composers[0].renderer,h=c.isQAAutomationMode()?1:0,u=n.QA_AUTOMATION,d=0;i!==s&&(this._updateMixPassShader(i),a.iHaloColors.value=new Array(3*i),a.iLineicHaloColors.value=new Array(3*i),a.iHaloIntensities.value=new Array(i),a.iColors.value=new Array(3*i),a.iColorIntensities.value=new Array(2*i),a.iOutlineColors.value=new Array(3*i),a.iLineicOutlineColors.value=new Array(3*i),a.iOutlineAlphas.value=new Array(i),a.iOutlineThicknesses.value=new Array(i));for(r=0;r<i;r++){var p=t[r],f=p.highlightData,m=p.getNbWebGLObjects(this.idString)+p.__objectsAdded.size;d+=m,f._needsDepth&&m>0&&c.requestPoliteDepthBuffer(),n.HALO_THICKNESS=Math.max(Math.ceil(c._renderScale*c._renderScale*f.haloThickness),1),f._updateMixPassUniforms(a,r+1)}n.NB_CONFIG=i,n.QA_AUTOMATION=h,n.HAS_POLITE=c._politeDBufferNextFrame&&"true"===localStorage.getItem("__WEBVISU_NEWHL_POC__")&&!h?1:0,a.empty.value=d>0?1:0,(n.NB_CONFIG!==s||n.HALO_THICKNESS!==o||n.HAS_POLITE!==l||n.QA_AUTOMATION!==u)&&this.mixPass.compileShader(c)},_updateMixPassShader:function(e){},setSize:function(e,t){this._parent(e,t)&&(this.composers[0].setSize(this.width,this.height),this.mixPass.uniforms.h.value=1/this.width,this.mixPass.uniforms.v.value=1/this.height)},setEnabled:function(e){this.composers[0].composerContext.enablePass(this.hlRenderPass,e),e&&this._parent(e)}})}),define("Effects/AbstractHighlightEffect",["DS/Effects/AbstractHighlightEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/AbstractHighlightEffect"),e}),define("DS/Gestures/MouseDownGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(e){return this._parent(t.printMouseButton(e)+"MouseDown"),this.priority=0,this.button=e,this},detect:function(e){switch(this._parent(e),this.state){case i.State.INIT:var r=THREEDS.VisuEventsManager.getMouseEventsByStates([t.State.BEGIN],this.button,this.view);if(r.length){var n=r[0];return this.events=[n],void this.changeState(i.State.OK)}break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/MouseDownGesture",r)}),define("Gestures/MouseDownGesture",["DS/Gestures/MouseDownGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/MouseDownGesture"),e}),define("DS/Effects/HighlightEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/AbstractHighlightEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/AdvancedHighlightShader","DS/Plugins/ClearPass","DS/Visualization/PickingMode"],function(e,t,i,r,n,a,s,o){"use strict";var l=function(e){e.clear(!1,!0,!1)};return t.extend({init:function(e,t,i,r,n){return n=n||null,this._parent(e,t,r+"HighlightEffect",i,r,n||a.FinalBlending),this.scenes=[],this.mixPass.enableWarmStart=null===i,this},update:function(t,i,n,a,o){var c=this.composers[0].renderer;this.sceneGraphSelection=i.selectionHL,null===this.hlRenderPass&&(this.hlClearPass=new s(this.prefix+"hlClearPass"),this.hlRenderPass=new r(i.selectionHL.sceneHL,null,null,void 0,void 0,void 0,this.prefix+"hlRenderPass"),this.hlRenderPass.setDisableBackFaceCulling(!0),this.hlRenderPass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.hlRenderPass.cameraName="mainNoJittering",this.hlRenderPass.idString=this.idString,this.composers[0].addPass(this.hlClearPass),this.composers[0].addPass(this.hlRenderPass),this.composers[0].composerContext.setPassClear(this.hlClearPass,!0,new e.Color(0),0));var h=c.isQAAutomationMode(),u=this.scenes,d=[];this.sceneGraphSelection.enabled&&d.push(this.sceneGraphSelection.sceneHL);for(var p=0;p<u.length;p++){var f=u[p];f.enabled&&d.push(f.sceneHL)}var m=d.length;d.sort(function(e,t){return e.highlightData.priority-t.highlightData.priority}),this.hlRenderPass.setMultiRenderCB(function(e,t){if(t<m){e.scene=d[t];var i=e.scene.highlightData;return e._postRenderCB=null,e._preRenderCB=null,i.clearDepth&&!h&&(i.priority>0&&(e._preRenderCB=l),i.priority<0&&(e._postRenderCB=l)),!0}return!1}),Object.keys(this.hlRenderPass.stateSortingResults).length>m&&(this.hlRenderPass.stateSortingResults={});var[g,v,S]=c.getRenderMode().getMasks();this.hlRenderPass.renderFaceMode=g,this.hlRenderPass.renderLineMode=v,this.hlRenderPass.renderPointMode=S,this.composers[0].composerContext.needsUpdate=0===a||o,this.updateUniforms(u)},addScene:function(e){this.scenes.push(e)},removeScene:function(e){for(var t=[],i=0;i<this.scenes.length;i++)this.scenes[i]!==e?t.push(this.scenes[i]):this.scenes[i].clearAll();this.scenes=t}})}),define("Effects/HighlightEffect",["DS/Effects/HighlightEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/HighlightEffect"),e}),define("DS/Shaders/AdaptativeBlurShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=["vec3 decodeOct22Normal(in vec2 iEncodedNormal) {","float x = iEncodedNormal.x/2047.0*2.0 - 1.0;","float y = iEncodedNormal.y/2047.0*2.0 - 1.0;","vec3 v = vec3(x, y, 1.0 - abs(x) - abs(y));","if (v.z <= 0.0) {","vec2 sgn = signNotZero(v.xy);","v.xy = - abs(v.yx)*sgn + sgn;","}","return normalize(v);","}","vec4 getNormalDepth(in vec2 uv) {","vec4 normalDepth = texture2D( tNormalDepth, uv );","#ifndef RENDER_TO_FLOAT_TEXTURE","return vec4(decodeOct22Normal(normalDepth.xy), (normalDepth.z * 4096.0 + normalDepth.w) / 8388608.0);","#else","return vec4(normalDepth.xyz * 2.0 - 1.0, normalDepth.w);","#endif","}"].join("\n"),i={defines:{NB_SAMPLES:1,STEP:"1.5"},uniforms:{tDiffuse:{type:"t",value:null},invSize:{type:"v2",value:new e.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","float result = 0.0;","float total = 0.0;","for (int i = -NB_SAMPLES; i <= NB_SAMPLES; ++i) {","for (int j = -NB_SAMPLES; j <= NB_SAMPLES; ++j) {","vec2 offset = STEP * invSize * vec2(float(i), float(j));","float weight = 1.0 / (1.0 + dot(offset, offset));","result += weight * texture2D(tDiffuse, vUv + offset).x;","total += weight;","}","}","result /= total;","gl_FragColor = vec4(vec3(result), 1.0);","}"].join("\n")};return{H:{defines:{NB_SAMPLES:4,STEP:1.5},uniforms:{tDiffuse:{type:"t",value:null},tNormalDepth:{type:"t",value:null},invSize:{type:"v2",value:new e.Vector2(512,512)},radius:{type:"f",value:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D tDiffuse;","uniform sampler2D tNormalDepth;","varying vec2 vUv;",t,"void main() {","vec2 screenPos = vUv;","vec4 normalDepth = getNormalDepth(vUv);","float depth = normalDepth.w;","vec3 normal = normalDepth.xyz;","float result = texture2D(tDiffuse, vUv).x;","float total = 1.0;","for (int i = -NB_SAMPLES; i <= NB_SAMPLES; ++i) {","if (i != 0) {","vec2 pos = vUv + STEP * vec2(invSize.x * float(i), 0.0);","vec4 normalDepth2 = getNormalDepth(pos);","float depth2 = normalDepth2.w;","vec3 normal2 = normalDepth2.xyz;","float weightDepth = 1.0 / (1.0 + 100.0*abs(depth2 - depth));","float weightNormal = clamp(dot(normal, normal2), 0.0, 1.0);","result += weightDepth * weightNormal * texture2D(tDiffuse, pos).x;","total += weightDepth * weightNormal;","}","}","result /= total;","gl_FragColor = vec4(vec3(result), 1.0);","}"].join("\n")},V:{defines:{NB_SAMPLES:4,STEP:1.5},uniforms:{tDiffuse:{type:"t",value:null},tNormalDepth:{type:"t",value:null},invSize:{type:"v2",value:new e.Vector2(512,512)},radius:{type:"f",value:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D tDiffuse;","uniform sampler2D tNormalDepth;",t,"varying vec2 vUv;","void main() {","vec2 screenPos = vUv;","vec4 normalDepth = getNormalDepth( vUv);","float depth = normalDepth.w;","vec3 normal = normalDepth.xyz;","float result = texture2D(tDiffuse, vUv).x;","float total = 1.0;","for (int i = -NB_SAMPLES; i <= NB_SAMPLES; ++i) {","if (i != 0) {","vec2 pos = vUv + STEP * vec2(0.0, invSize.y * float(i));","vec4 normalDepth2 = getNormalDepth(pos );","float depth2 = normalDepth2.w;","vec3 normal2 = normalDepth2.xyz;","float weightDepth = 1.0 / (1.0 + 100.0*abs(depth2 - depth));","float weightNormal = clamp(dot(normal, normal2), 0.0, 1.0);","result += weightDepth * weightNormal * texture2D(tDiffuse, pos).x;","total += weightDepth * weightNormal;","}","}","result /= total;","gl_FragColor = vec4(vec3(result), 1.0);","}"].join("\n")},HV:i}}),define("Shaders/AdaptativeBlurShader",["DS/Shaders/AdaptativeBlurShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/AdaptativeBlurShader"),e}),define("DS/Shaders/DisplayMipsRoughnessShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{DisplayMips:{uniforms:{tDiffuse1:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDiffuse4:{type:"t",value:null},tDiffuse5:{type:"t",value:null},tDiffuse6:{type:"t",value:null},tDiffuse7:{type:"t",value:null},offset1:{type:"v2",value:new e.Vector2(0,.5)},scale1:{type:"f",value:.5},offset2:{type:"v2",value:new e.Vector2(0,.25)},scale2:{type:"f",value:.25},offset3:{type:"v2",value:new e.Vector2(.25,.25)},scale3:{type:"f",value:.25},offset4:{type:"v2",value:new e.Vector2(0,.125)},scale4:{type:"f",value:.125},offset5:{type:"v2",value:new e.Vector2(.125,.125)},scale5:{type:"f",value:.125},offset6:{type:"v2",value:new e.Vector2(.25,.125)},scale6:{type:"f",value:.125},offset7:{type:"v2",value:new e.Vector2(.375,.125)},scale7:{type:"f",value:.125}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse1;","uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform sampler2D tDiffuse4;","uniform sampler2D tDiffuse5;","uniform sampler2D tDiffuse6;","uniform sampler2D tDiffuse7;","uniform vec2 offset1;","uniform float scale1;","uniform vec2 offset2;","uniform float scale2;","uniform vec2 offset3;","uniform float scale3;","uniform vec2 offset4;","uniform float scale4;","uniform vec2 offset5;","uniform float scale5;","uniform vec2 offset6;","uniform float scale6;","uniform vec2 offset7;","uniform float scale7;","varying vec2 vUv;","void main() {","gl_FragColor = vec4(0.0);","vec2 vUv1 = (vUv - offset1) / scale1;","vec2 vUv2 = (vUv - offset2) / scale2;","vec2 vUv3 = (vUv - offset3) / scale3;","vec2 vUv4 = (vUv - offset4) / scale4;","vec2 vUv5 = (vUv - offset5) / scale5;","vec2 vUv6 = (vUv - offset6) / scale6;","vec2 vUv7 = (vUv - offset7) / scale7;","if (vUv1.x > 0.0 && vUv1.y > 0.0 && vUv1.x < 1.0 && vUv1.y < 1.0) {","    vec3 color = texture2D( tDiffuse1, vUv1 ).xyz;","    color = pow(color, vec3(1.0 / 2.2));","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv2.x > 0.0 && vUv2.y > 0.0 && vUv2.x < 1.0 && vUv2.y < 1.0) {","    vec3 color = texture2D( tDiffuse2, vUv2 ).xyz;","    color = pow(color, vec3(1.0 / 2.2));","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv3.x > 0.0 && vUv3.y > 0.0 && vUv3.x < 1.0 && vUv3.y < 1.0) {","    vec3 color = texture2D( tDiffuse3, vUv3 ).xyz;","    color = pow(color, vec3(1.0 / 2.2));","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv4.x > 0.0 && vUv4.y > 0.0 && vUv4.x < 1.0 && vUv4.y < 1.0) {","    vec3 color = texture2D( tDiffuse4, vUv4 ).xyz;","    color = pow(color, vec3(1.0 / 2.2));","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv5.x > 0.0 && vUv5.y > 0.0 && vUv5.x < 1.0 && vUv5.y < 1.0) {","    vec3 color = texture2D( tDiffuse5, vUv5 ).xyz;","    color = pow(color, vec3(1.0 / 2.2));","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv6.x > 0.0 && vUv6.y > 0.0 && vUv6.x < 1.0 && vUv6.y < 1.0) {","    vec3 color = texture2D( tDiffuse6, vUv6 ).xyz;","    color = pow(color, vec3(1.0 / 2.2));","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv7.x > 0.0 && vUv7.y > 0.0 && vUv7.x < 1.0 && vUv7.y < 1.0) {","    vec3 color = texture2D( tDiffuse7, vUv7 ).xyz;","    gl_FragColor = vec4(color, 1.0); return;","}","}"].join("\n")},MergeMips:{uniforms:{tDiffuse1:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDiffuse4:{type:"t",value:null},tDiffuse5:{type:"t",value:null},tDiffuse6:{type:"t",value:null},tDiffuse7:{type:"t",value:null},offset1:{type:"v2",value:new e.Vector2(0,.5)},scale1:{type:"v2",value:new e.Vector2(1,.5)},offset2:{type:"v2",value:new e.Vector2(0,.25)},scale2:{type:"v2",value:new e.Vector2(.5,.25)},offset3:{type:"v2",value:new e.Vector2(.5,.25)},scale3:{type:"v2",value:new e.Vector2(.5,.25)},offset4:{type:"v2",value:new e.Vector2(0,.125)},scale4:{type:"v2",value:new e.Vector2(.25,.125)},offset5:{type:"v2",value:new e.Vector2(.25,.125)},scale5:{type:"v2",value:new e.Vector2(.25,.125)},offset6:{type:"v2",value:new e.Vector2(.5,.125)},scale6:{type:"v2",value:new e.Vector2(.25,.125)},offset7:{type:"v2",value:new e.Vector2(.75,.125)},scale7:{type:"v2",value:new e.Vector2(.25,.125)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse1;","uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform sampler2D tDiffuse4;","uniform sampler2D tDiffuse5;","uniform sampler2D tDiffuse6;","uniform sampler2D tDiffuse7;","uniform vec2 offset1;","uniform vec2 scale1;","uniform vec2 offset2;","uniform vec2 scale2;","uniform vec2 offset3;","uniform vec2 scale3;","uniform vec2 offset4;","uniform vec2 scale4;","uniform vec2 offset5;","uniform vec2 scale5;","uniform vec2 offset6;","uniform vec2 scale6;","uniform vec2 offset7;","uniform vec2 scale7;","varying vec2 vUv;","void main() {","gl_FragColor = vec4(0.0);","vec2 vUv1 = (vUv - offset1) / scale1;","vec2 vUv2 = (vUv - offset2) / scale2;","vec2 vUv3 = (vUv - offset3) / scale3;","vec2 vUv4 = (vUv - offset4) / scale4;","vec2 vUv5 = (vUv - offset5) / scale5;","vec2 vUv6 = (vUv - offset6) / scale6;","vec2 vUv7 = (vUv - offset7) / scale7;","if (vUv1.x > 0.0 && vUv1.y > 0.0 && vUv1.x < 1.0 && vUv1.y < 1.0) {","    vec3 color = texture2D( tDiffuse1, vec2(1.0 - vUv1.x, vUv1.y) ).xyz;","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv2.x > 0.0 && vUv2.y > 0.0 && vUv2.x < 1.0 && vUv2.y < 1.0) {","    vec3 color = texture2D( tDiffuse2, vec2(1.0 - vUv2.x, vUv2.y) ).xyz;","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv3.x > 0.0 && vUv3.y > 0.0 && vUv3.x < 1.0 && vUv3.y < 1.0) {","    vec3 color = texture2D( tDiffuse3, vec2(1.0 - vUv3.x, vUv3.y) ).xyz;","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv4.x > 0.0 && vUv4.y > 0.0 && vUv4.x < 1.0 && vUv4.y < 1.0) {","    vec3 color = texture2D( tDiffuse4, vec2(1.0 - vUv4.x, vUv4.y) ).xyz;","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv5.x > 0.0 && vUv5.y > 0.0 && vUv5.x < 1.0 && vUv5.y < 1.0) {","    vec3 color = texture2D( tDiffuse5, vec2(1.0 - vUv5.x, vUv5.y) ).xyz;","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv6.x > 0.0 && vUv6.y > 0.0 && vUv6.x < 1.0 && vUv6.y < 1.0) {","    vec3 color = texture2D( tDiffuse6, vec2(1.0 - vUv6.x, vUv6.y) ).xyz;","    gl_FragColor = vec4(color, 1.0); return;","} else if (vUv7.x > 0.0 && vUv7.y > 0.0 && vUv7.x < 1.0 && vUv7.y < 1.0) {","    vec3 color = texture2D( tDiffuse7, vec2(1.0 - vUv7.x, vUv7.y) ).xyz;","    gl_FragColor = vec4(color, 1.0); return;","}","}"].join("\n")},MergeMipsRGBE:{uniforms:{tDiffuse1:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDiffuse4:{type:"t",value:null},tDiffuse5:{type:"t",value:null},tDiffuse6:{type:"t",value:null},tDiffuse7:{type:"t",value:null},offset1:{type:"v2",value:new e.Vector2(0,.5)},scale1:{type:"v2",value:new e.Vector2(1,.5)},offset2:{type:"v2",value:new e.Vector2(0,.25)},scale2:{type:"v2",value:new e.Vector2(.5,.25)},offset3:{type:"v2",value:new e.Vector2(.5,.25)},scale3:{type:"v2",value:new e.Vector2(.5,.25)},offset4:{type:"v2",value:new e.Vector2(0,.125)},scale4:{type:"v2",value:new e.Vector2(.25,.125)},offset5:{type:"v2",value:new e.Vector2(.25,.125)},scale5:{type:"v2",value:new e.Vector2(.25,.125)},offset6:{type:"v2",value:new e.Vector2(.5,.125)},scale6:{type:"v2",value:new e.Vector2(.25,.125)},offset7:{type:"v2",value:new e.Vector2(.75,.125)},scale7:{type:"v2",value:new e.Vector2(.25,.125)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse1;","uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform sampler2D tDiffuse4;","uniform sampler2D tDiffuse5;","uniform sampler2D tDiffuse6;","uniform sampler2D tDiffuse7;","uniform vec2 offset1;","uniform vec2 scale1;","uniform vec2 offset2;","uniform vec2 scale2;","uniform vec2 offset3;","uniform vec2 scale3;","uniform vec2 offset4;","uniform vec2 scale4;","uniform vec2 offset5;","uniform vec2 scale5;","uniform vec2 offset6;","uniform vec2 scale6;","uniform vec2 offset7;","uniform vec2 scale7;","varying vec2 vUv;","vec4 toRGBE(vec3 color) {","float value = max(color.r, max(color.g, color.b));","int exponent = 0;","float mantissa = 0.0;","if (value > 1.0) {","for (int i = 1; i <= 127; i++) {","value /= 2.0;","exponent++;","if (value < 1.0) { break; }","}","} else if (value < 1.0) {","int j = 1;","for (int i = 1; i <= 129; i++) {","value *= 2.0;","exponent--;","if (value > 1.0) { j = 0; break; }","}","value /= 2.0;","exponent++;","if (j > 0) {","color = vec3(0.0);","exponent = 0;","}","}","return vec4(color * pow(2.0, float(-exponent)), float(exponent + 128) / 255.0);","}","void main() {","gl_FragColor = vec4(0.0);","vec2 vUv1 = (vUv - offset1) / scale1;","vec2 vUv2 = (vUv - offset2) / scale2;","vec2 vUv3 = (vUv - offset3) / scale3;","vec2 vUv4 = (vUv - offset4) / scale4;","vec2 vUv5 = (vUv - offset5) / scale5;","vec2 vUv6 = (vUv - offset6) / scale6;","vec2 vUv7 = (vUv - offset7) / scale7;","if (vUv1.x > 0.0 && vUv1.y > 0.0 && vUv1.x < 1.0 && vUv1.y < 1.0) {","    vec3 color = texture2D( tDiffuse1, vec2(1.0 - vUv1.x, vUv1.y) ).xyz;","    gl_FragColor = toRGBE(color); return;","} else if (vUv2.x > 0.0 && vUv2.y > 0.0 && vUv2.x < 1.0 && vUv2.y < 1.0) {","    vec3 color = texture2D( tDiffuse2, vec2(1.0 - vUv2.x, vUv2.y) ).xyz;","    gl_FragColor = toRGBE(color); return;","} else if (vUv3.x > 0.0 && vUv3.y > 0.0 && vUv3.x < 1.0 && vUv3.y < 1.0) {","    vec3 color = texture2D( tDiffuse3, vec2(1.0 - vUv3.x, vUv3.y) ).xyz;","    gl_FragColor = toRGBE(color); return;","} else if (vUv4.x > 0.0 && vUv4.y > 0.0 && vUv4.x < 1.0 && vUv4.y < 1.0) {","    vec3 color = texture2D( tDiffuse4, vec2(1.0 - vUv4.x, vUv4.y) ).xyz;","    gl_FragColor = toRGBE(color); return;","} else if (vUv5.x > 0.0 && vUv5.y > 0.0 && vUv5.x < 1.0 && vUv5.y < 1.0) {","    vec3 color = texture2D( tDiffuse5, vec2(1.0 - vUv5.x, vUv5.y) ).xyz;","    gl_FragColor = toRGBE(color); return;","} else if (vUv6.x > 0.0 && vUv6.y > 0.0 && vUv6.x < 1.0 && vUv6.y < 1.0) {","    vec3 color = texture2D( tDiffuse6, vec2(1.0 - vUv6.x, vUv6.y) ).xyz;","    gl_FragColor = toRGBE(color); return;","} else if (vUv7.x > 0.0 && vUv7.y > 0.0 && vUv7.x < 1.0 && vUv7.y < 1.0) {","    vec3 color = texture2D( tDiffuse7, vec2(1.0 - vUv7.x, vUv7.y) ).xyz;","    gl_FragColor = toRGBE(color); return;","}","}"].join("\n")},MergeCustomMips:{defines:{MAPPING:0,MIP_OFFSET:0,ZERO_RBGE:1},uniforms:{tDiffuse0:{type:"t",value:null},tDiffuse1:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDiffuse4:{type:"t",value:null},tDiffuse5:{type:"t",value:null},tDiffuse6:{type:"t",value:null},tDiffuse7:{type:"t",value:null},size0:{type:"v2",value:new e.Vector2},size1:{type:"v2",value:new e.Vector2},size2:{type:"v2",value:new e.Vector2},size3:{type:"v2",value:new e.Vector2},size4:{type:"v2",value:new e.Vector2},size5:{type:"v2",value:new e.Vector2},size6:{type:"v2",value:new e.Vector2},size7:{type:"v2",value:new e.Vector2},offset1:{type:"v2",value:new e.Vector2(0,.5)},scale1:{type:"v2",value:new e.Vector2(1,.5)},offset2:{type:"v2",value:new e.Vector2(0,.25)},scale2:{type:"v2",value:new e.Vector2(.5,.25)},offset3:{type:"v2",value:new e.Vector2(.5,.25)},scale3:{type:"v2",value:new e.Vector2(.5,.25)},offset4:{type:"v2",value:new e.Vector2(0,.125)},scale4:{type:"v2",value:new e.Vector2(.25,.125)},offset5:{type:"v2",value:new e.Vector2(.25,.125)},scale5:{type:"v2",value:new e.Vector2(.25,.125)},offset6:{type:"v2",value:new e.Vector2(.5,.125)},scale6:{type:"v2",value:new e.Vector2(.25,.125)},offset7:{type:"v2",value:new e.Vector2(.75,.125)},scale7:{type:"v2",value:new e.Vector2(.25,.125)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","vUv.x = 1.0 - vUv.x;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse0;","uniform sampler2D tDiffuse1;","uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform sampler2D tDiffuse4;","uniform sampler2D tDiffuse5;","uniform sampler2D tDiffuse6;","uniform sampler2D tDiffuse7;","uniform vec2 size0;","uniform vec2 size1;","uniform vec2 size2;","uniform vec2 size3;","uniform vec2 size4;","uniform vec2 size5;","uniform vec2 size6;","uniform vec2 size7;","uniform vec2 offset1;","uniform vec2 scale1;","uniform vec2 offset2;","uniform vec2 scale2;","uniform vec2 offset3;","uniform vec2 scale3;","uniform vec2 offset4;","uniform vec2 scale4;","uniform vec2 offset5;","uniform vec2 scale5;","uniform vec2 offset6;","uniform vec2 scale6;","uniform vec2 offset7;","uniform vec2 scale7;","varying vec2 vUv;","#if MAPPING == 0","#define LINEAR","#endif","#if MAPPING == 1","#define NON_LINEAR","#endif","#if MAPPING == 2","#define INVERSE_LINEAR","#endif","#if MAPPING == 3","#define INVERSE_NON_LINEAR","#endif",e._DefaultShaderChunk.rgbe_sample_methods,"float roughnessToMips(in float roughness) {","float mip;","#ifdef LINEAR","mip = roughness * (6.0 - float(MIP_OFFSET));","#endif","#ifdef NON_LINEAR","mip = roughness == 0.0 ? 0.0 : (6.0 - float(MIP_OFFSET) ) + 1.15 * log2(roughness);","#endif","#ifdef INVERSE_LINEAR","mip = (1.0 - roughness) * (6.0 - float(MIP_OFFSET));","#endif","#ifdef INVERSE_NON_LINEAR","mip = roughness == 1.0 ? 6.0 - float(MIP_OFFSET) : (6.0 - float(MIP_OFFSET)) + 1.15 * log2(1.0 - roughness);","#endif","return mip + float(MIP_OFFSET);","}","vec4 toRGBE(vec3 color) {","float value = max(color.r, max(color.g, color.b));","int exponent = 0;","float mantissa = 0.0;","if (value > 1.0) {","for (int i = 1; i <= 127; i++) {","value /= 2.0;","exponent++;","if (value < 1.0) { break; }","}","} else if (value < 1.0) {","int j = 1;","for (int i = 1; i <= 129; i++) {","value *= 2.0;","exponent--;","if (value > 1.0) { j = 0; break; }","}","value /= 2.0;","exponent++;","if (j > 0) {","color = vec3(0.0);","exponent = 0;","}","}","return vec4(color * pow(2.0, float(-exponent)), float(exponent + 128) / 255.0);","}","vec4 getColor(in float roughness, in vec2 uv) {","float mipValue = roughnessToMips(roughness);","float leftMip = floor(mipValue);","float factor = fract(mipValue);","uv.x = 1.0 - uv.x;","vec3 color;","if (leftMip == 0.0) {","#if ZERO_RBGE == 1","color = mix(texture2DBilinearFromRGBE( tDiffuse0, vec2(uv.x, uv.y), size0, 1.0/size0 ).xyz, texture2DBilinearFromRGBE( tDiffuse1, vec2(uv.x, uv.y), size1, 1.0/size1 ).xyz, factor);","#else","color = mix(texture2D( tDiffuse0, vec2(uv.x, uv.y)).xyz, texture2DBilinearFromRGBE( tDiffuse1, vec2(uv.x, uv.y), size1, 1.0/size1 ).xyz, factor);","#endif","}","if (leftMip == 1.0) {","color = mix(texture2DBilinearFromRGBE( tDiffuse1, vec2(uv.x, uv.y), size1, 1.0/size1 ).xyz, texture2DBilinearFromRGBE( tDiffuse2, vec2(uv.x, uv.y), size2, 1.0/size2 ).xyz, factor);","}","if (leftMip == 2.0) {","color = mix(texture2DBilinearFromRGBE( tDiffuse2, vec2(uv.x, uv.y), size2, 1.0/size2 ).xyz, texture2DBilinearFromRGBE( tDiffuse3, vec2(uv.x, uv.y), size3, 1.0/size3 ).xyz, factor);","}","if (leftMip == 3.0) {","color = mix(texture2DBilinearFromRGBE( tDiffuse3, vec2(uv.x, uv.y), size3, 1.0/size3 ).xyz, texture2DBilinearFromRGBE( tDiffuse4, vec2(uv.x, uv.y), size4, 1.0/size4 ).xyz, factor);","}","if (leftMip == 4.0) {","color = mix(texture2DBilinearFromRGBE( tDiffuse4, vec2(uv.x, uv.y), size4, 1.0/size4 ).xyz, texture2DBilinearFromRGBE( tDiffuse5, vec2(uv.x, uv.y), size5, 1.0/size5 ).xyz, factor);","}","if (leftMip == 5.0) {","color = mix(texture2DBilinearFromRGBE( tDiffuse5, vec2(uv.x, uv.y), size5, 1.0/size5 ).xyz, texture2DBilinearFromRGBE( tDiffuse6, vec2(uv.x, uv.y), size6, 1.0/size6 ).xyz, factor);","}","if (leftMip == 6.0) {","color = texture2DBilinearFromRGBE( tDiffuse6, vec2(uv.x, uv.y), size6, 1.0/size6 ).xyz;","}","return toRGBE(color);","}","void main() {","vec2 vUv1 = (vUv - offset1) / scale1;","vec2 vUv2 = (vUv - offset2) / scale2;","vec2 vUv3 = (vUv - offset3) / scale3;","vec2 vUv4 = (vUv - offset4) / scale4;","vec2 vUv5 = (vUv - offset5) / scale5;","vec2 vUv6 = (vUv - offset6) / scale6;","vec2 vUv7 = (vUv - offset7) / scale7;","gl_FragColor = toRGBE(vec3(0.0));","if (vUv1.x > 0.0 && vUv1.y > 0.0 && vUv1.x < 1.0 && vUv1.y < 1.0) {","    gl_FragColor = getColor(0.04911045206, vUv1); return;","} else if (vUv2.x > 0.0 && vUv2.y > 0.0 && vUv2.x < 1.0 && vUv2.y < 1.0) {","    gl_FragColor = getColor(0.08973030532, vUv2); return;","} else if (vUv3.x > 0.0 && vUv3.y > 0.0 && vUv3.x < 1.0 && vUv3.y < 1.0) {","    gl_FragColor = getColor(0.1639473341, vUv3); return;","} else if (vUv4.x > 0.0 && vUv4.y > 0.0 && vUv4.x < 1.0 && vUv4.y < 1.0) {","    gl_FragColor = getColor(0.29955017162, vUv4); return;","} else if (vUv5.x > 0.0 && vUv5.y > 0.0 && vUv5.x < 1.0 && vUv5.y < 1.0) {","    gl_FragColor = getColor(0.54731176821, vUv5); return;","} else if (vUv6.x > 0.0 && vUv6.y > 0.0 && vUv6.x < 1.0 && vUv6.y < 1.0) {","    gl_FragColor = getColor(1.0, vUv6); return;","} else if (vUv7.x > 0.0 && vUv7.y > 0.0 && vUv7.x < 1.0 && vUv7.y < 1.0) {","vUv7.x = 1.0 - vUv7.x;","    vec3 color = texture2DBilinearFromRGBE( tDiffuse7, vec2(vUv7.x, vUv7.y), size7, 1.0/size7 ).xyz;","    gl_FragColor = toRGBE(color); return;","}","}"].join("\n")}}}),define("ShadersDebug/DisplayMipsRoughnessShader",["DS/Shaders/DisplayMipsRoughnessShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("ShadersDebug/DisplayMipsRoughnessShader"),e}),define("DS/Shaders/ReplaceBlendShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","varying vec2 vUv;","void main() {","vec3 color  = texture2D(  tDiffuse, vUv ).xyz;","vec4 color2 = texture2D( tDiffuse2, vUv );","gl_FragColor = vec4((1.0 - color2.a) * color + color2.a * color2.xyz, 1.0);","}"].join("\n")}}),define("Shaders/ReplaceBlendShader",["DS/Shaders/ReplaceBlendShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/ReplaceBlendShader"),e}),define("DS/SceneGraphNodes/InstancedCurvedPipeManager",["DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],function(e,t){"use strict";var i,r,n={maxTextureSize:-1,maxTextureTotalSize:-1,isInit:!1,init:function(){if(!this.isInit){var e=debugWebGLV6Viewer.renderer.renderer.context;this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxTextureTotalSize=this.maxTextureSize*this.maxTextureSize,this.isInit=!0}}},a=function(e,t){for(var i=t||1;i<e;)i*=2;return i},s=(i=new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0]),(r=new e.DataTexture(i,3,1,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,r.magFilter=e.NearestFilter,r.generateMipmaps=!1,r.flipY=!1,r.needsUpdate=!0,r),o=function(e){var t=e.x,i=e.y,r=e.z,n=Math.abs(t)+Math.abs(i)+Math.abs(r),a=t/n,s=i/n;if(r<0){var o=(1-Math.abs(s))*(a>=0?1:-1),l=(1-Math.abs(a))*(s>=0?1:-1);a=o,s=l}return 4096*(a=Math.round(4095*(.5*a+.5)))+(s=Math.round(4095*(.5*s+.5)))},l=0,c=1,h=2,u={_VSGlobal:["#define NB_CURVES_MAPS_MAX 2","#define NB_CURVES_MAPS 1","#define NB_MATRICES_MAPS 1","#define PI2 6.28318530718","vec3 cp_objectPosition;","vec3 cp_objectNormal;","vec3 cp_infosUV;","mat4 _curveModelMatrix;","float cp_radius;","vec3 decompressVector(in float iVec) {","return decodeOct24Normal(iVec);","}","vec4 getCurveData(float iId, float iMaxMapTotalSize, float iLAST_CURVES_MAP_SIZE_X, float iLAST_CURVES_MAP_SIZE_Y) {","int texId = int(floor(iId/iMaxMapTotalSize));","float idInTexture = iId - float(texId)*iMaxMapTotalSize;","float dx, dy, x, y;","if (texId == int(NB_CURVES_MAPS) - 1) {","dx = 1.0 / iLAST_CURVES_MAP_SIZE_X;","dy = 1.0 / iLAST_CURVES_MAP_SIZE_Y;","y = floor(idInTexture/iLAST_CURVES_MAP_SIZE_X);","x = idInTexture - y*iLAST_CURVES_MAP_SIZE_X;","} else {","dx = 1.0 / MAX_TEXTURE_SIZE;","dy = 1.0 / MAX_TEXTURE_SIZE;","y = floor(idInTexture/MAX_TEXTURE_SIZE);","x = idInTexture - y*MAX_TEXTURE_SIZE;","}","vec2 xy = vec2( dx * ( x + 0.5 ), dy * ( y + 0.5 ) );","vec4 curveData;","for (int i = 0; i < NB_CURVES_MAPS; i++) {","if (texId == i) {","curveData = texture2D( curvesMaps[i], xy);","}","}","return curveData;","}","","void computeMatrixAndRadius() {","float _idInMatricesMap = specialMeshIds.x;","float LAST_MATRICES_MAP_SIZE_X = curvesMatricesProperties.x;","float LAST_MATRICES_MAP_SIZE_Y = curvesMatricesProperties.y;","float maxMapTotalSize = MAX_TEXTURE_SIZE*MAX_TEXTURE_SIZE;","int texId = int(floor(_idInMatricesMap/maxMapTotalSize));","float idInTexture = _idInMatricesMap - float(texId)*maxMapTotalSize;","float dx, dy, x, y;","if (texId == int(NB_MATRICES_MAPS) - 1) {","dx = 1.0 / LAST_MATRICES_MAP_SIZE_X;","dy = 1.0 / LAST_MATRICES_MAP_SIZE_Y;","y = floor(idInTexture/LAST_MATRICES_MAP_SIZE_X);","x = idInTexture - y*LAST_MATRICES_MAP_SIZE_X;","} else {","dx = 1.0 / MAX_TEXTURE_SIZE;","dy = 1.0 / MAX_TEXTURE_SIZE;","y = floor(idInTexture/MAX_TEXTURE_SIZE);","x = idInTexture - y*MAX_TEXTURE_SIZE;","}","vec2 xy = vec2( dx * ( x + 0.5 ), dy * ( y + 0.5 ) );","_curveModelMatrix[3].w = 1.0;","for (int i = 0; i < NB_MATRICES_MAPS; i++) {","if (texId == i) {","vec4 tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 0.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[0].xyz = tmp.xyz;","tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 1.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[1].xyz = tmp.xyz;","tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 2.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[2].xyz = tmp.xyz;","tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 3.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[3].xyz = tmp.xyz;","cp_radius = tmp.w;","}","}","}"].join("\n"),_VSOverridables:{ComputeCommonValues:["void ComputeCommonValues() {","vec3 infos = vGetAttribPosition();","cp_infosUV = infos;","float LAST_CURVES_MAP_SIZE_X = curvesMapsProperties.x;","float LAST_CURVES_MAP_SIZE_Y = curvesMapsProperties.y;","float _idInCurvesMaps = specialMeshIds.y;","float curvePointId = _idInCurvesMaps + infos.x;","float nextCurvePointId = curvePointId + 1.0;","float precCurvePointId = curvePointId - 1.0;","float maxMapTotalSize = MAX_TEXTURE_SIZE*MAX_TEXTURE_SIZE;","vec4 curveData = getCurveData(curvePointId, maxMapTotalSize, LAST_CURVES_MAP_SIZE_X, LAST_CURVES_MAP_SIZE_Y);","vec4 nextCurveData = getCurveData(nextCurvePointId, maxMapTotalSize, LAST_CURVES_MAP_SIZE_X, LAST_CURVES_MAP_SIZE_Y);","vec4 precCurveData = getCurveData(precCurvePointId, maxMapTotalSize, LAST_CURVES_MAP_SIZE_X, LAST_CURVES_MAP_SIZE_Y);","vec3 curvePoint = curveData.xyz;","vec3 u = decompressVector(curveData.w);","vec3 nextCurvePoint = nextCurveData.xyz;","vec3 precCurvePoint = precCurveData.xyz;","computeMatrixAndRadius();","float angle = infos.y;","vec3 localPosition = vec3(cos(angle), sin(angle), 0.0);","vec3 t = normalize(nextCurvePoint - precCurvePoint);","vec3 v = cross(t, u);","cp_objectPosition = curvePoint + cp_radius*normalize(localPosition.x*u + localPosition.y*v);","bool isCap = infos.z > 0.3;","float isFirstSign = infos.z > 0.7 ? 1.0 : -1.0;","cp_objectNormal = isCap ? isFirstSign*t : normalize(cp_objectPosition - curvePoint);","}"].join("\n"),ProcessViewTangentSpace:["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","mat4 curveMVMatrix = vGetViewMatrix()*_curveModelMatrix;","ioWorldViewTS.Position = vec3(curveMVMatrix*vec4(cp_objectPosition, 1.0));","ioWorldViewTS.Normal = vec3(curveMVMatrix*vec4(cp_objectNormal, 0.0));","}"].join("\n"),ComputeObjectTexCoord0:["vec4 ComputeObjectTexCoord0() {","return vec4(cp_infosUV.x / 16.0, cp_infosUV.y / PI2, 0.0, 0.0);","}"].join("\n")}},d=function(){this._ranges=[]};d.prototype.addID=function(e){if(!(e<0)){var t=this._ranges;if(0!==t.length){for(var i=t.length,r=null,n=0;n<i;){if(e>=(r=t[n]).min&&e<=r.max)return;if(e===r.min-1)return r.min=e,void(n>0&&t[n-1].max===e-1&&(t[n-1].max=r.max,t.splice(n,1)));if(e===r.max+1)return r.max=e,void(n<i-1&&t[n+1].min===e+1&&(r.max=t[n+1].max,t.splice(n+1,1)));n++}if(e<t[0].min)t.splice(0,0,{min:e,max:e});else if(e>t[i-1].max)t.splice(i,0,{min:e,max:e});else for(var a=0;a<i;a++)if(e<(r=t[a]).min)return void t.splice(a,0,{min:e,max:e})}else t.push({min:e,max:e})}},d.prototype.getAvailableID=function(){var e=this._ranges;if(0===e.length)return 0;var t=e[0];return t.min>0?t.min-1:t.max+1},d.prototype.getTotalNumberOfIDs=function(){var e=this._ranges;return 0===e.length?0:e[e.length-1].max+1},d.prototype.getTotalNumberOfIDsNextPowerOfTwo=function(){return a(this.getTotalNumberOfIDs())},d.prototype.removeID=function(e){var t=this._ranges;if(0!==t.length)for(var i=t.length,r=null,n=0;n<i;n++){if(e===(r=t[n]).min)return void(r.min===r.max?t.splice(n,1):r.min++);if(e===r.max)return void r.max--;if(e>r.min&&e<r.max){var a={min:e+1,max:r.max};return r.max=e-1,void t.splice(n+1,0,a)}}},d.prototype.getNbRanges=function(){return this._ranges.length};var p=function(t,i,r,n){this._LODSags=n,this._nbLODs=this._LODSags.length,this._nbCurvePoints=0===t?2:Math.pow(2,t-1)+1,this._nbCurvePointsPlus2=2+this._nbCurvePoints,this._sag=r,this._isCaps=i,this._LODGeometries=[];for(var a=0;a<this._nbLODs;a++)this._LODGeometries.push(this._buildLODGeometry(this._LODSags[a]));var s=Math.random(),o=Math.random(),c=Math.random();this._debugColor=(new e.Color).setRGB(s,o,c),this._nbUsed=0,this._curvesData=new Float32Array(1024),this._curvesMaps=[],this._realMaps=[],this._curvesMapsProperties=new e.Vector3(128,2,1),this._updateCurvesMapsStatus=l,this._idsRanges=new d,this.materials={}};p.prototype._buildLODGeometry=function(i){var r=new e.BufferGeometryDS;r.sharedBuffers=!0;var n=i,a=this._nbCurvePoints;r.drawingGroups=[];for(var s=this._isCaps?6*(n-2):6*n*(a-1),o=this._isCaps?1:0,l=a*n,c=new Float32Array(3*l),h=0,u=1,d=0;d<a;d++){for(var p=0;p<n;p++)c[h++]=u,c[h++]=p/n*2*Math.PI,c[h++]=o?d>0?1:.5:0;u++}r.vertexPositionArray=c;var f=new Uint16Array(s),m=0;if(this._isCaps){for(p=0;p<n-2;p++)f[m++]=0,f[m++]=p+2,f[m++]=p+1;for(p=0;p<n-2;p++)f[m++]=n,f[m++]=n+p+1,f[m++]=n+p+2}else{var g=0,v=0,S=0,_=0,y=0;for(p=0;p<n;p++)for(d=0;d<a-1;d++)g=(y=d*n)+p,v=y+(p+1)%n,S=y+p+n,_=p===n-1?y+n:(y+p+n+1)%l,f[m++]=g,f[m++]=v,f[m++]=S,f[m++]=v,f[m++]=_,f[m++]=S}r.vertexIndexArray=f;var x=new t.DrawingGroup(null,null,4,0,s);return x._geomType=e.GeomTypeEnum.FACE,x.geometry=r,r.drawingGroups.push(x),r};new e.Vector3;var f=new e.Vector3,m=new e.Vector3;new e.Vector3;p.prototype._addCurvedPipe=function(t,i,r,n,a,s,o){var l=e.InstancedCurvedPipeManager;0===n?f.set(r[n+3]+s.x,r[n+4]+s.y,r[n+5]+s.z):f.set(r[n-3],r[n-2],r[n-1]),a===r.length?m.set(r[a-6]+o.x,r[a-5]+o.y,r[a-4]+o.z):m.set(r[a],r[a+1],r[a+2]);var c=this._idsRanges.getAvailableID();this._idsRanges.addID(c);var h=4*c*(2+this._nbCurvePoints),u=this._updateMapSize();this._curvesData[h++]=f.x,this._curvesData[h++]=f.y,this._curvesData[h++]=f.z,this._curvesData[h++]=n>0?l._compressedSideVectors_tmp[(n-3)/3]:0;for(var d=n;d<a;d+=3)this._curvesData[h++]=r[d],this._curvesData[h++]=r[d+1],this._curvesData[h++]=r[d+2],this._curvesData[h++]=l._compressedSideVectors_tmp[d/3];return this._curvesData[h++]=m.x,this._curvesData[h++]=m.y,this._curvesData[h++]=m.z,this._curvesData[h++]=a<r.length?l._compressedSideVectors_tmp[(a+3)/3]:0,this._updateMapData(u),c},p.prototype._removeCurvedPipe=function(e){if(0!==this._idsRanges.getNbRanges()){this._updateCurvesMapsStatus=c;var t=this._idsRanges.getTotalNumberOfIDs();this._idsRanges.removeID(e),t!==this._idsRanges.getTotalNumberOfIDs()&&(this._updateCurvesMapsStatus=l),this._nbUsed--}},p.prototype._resetMapsInfos=function(){this._curvesData=new Float32Array(1024),this._curvesMaps=[],this._curvesMapsProperties.set(128,2,1)},p.prototype._updateMapSize=function(){var e=this._idsRanges.getTotalNumberOfIDs()*(this._nbCurvePoints+2),t=Math.sqrt(e),i=a(t,128),r=a(e/i,2),n=this._reallocateMap(i,r);return this._curvesMapsProperties.x=i,this._curvesMapsProperties.y=r,n},p.prototype._updateMapData=function(t){this._curvesMaps=[],this._curvesMapsProperties.z=1;var i=this._realMaps[0];i?(i.image.width=this._curvesMapsProperties.x,i.image.height=this._curvesMapsProperties.y,t&&(i.image.data=this._curvesData)):((i=new e.DataTexture(this._curvesData,this._curvesMapsProperties.x,this._curvesMapsProperties.y,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,i.magFilter=e.NearestFilter,i.generateMipmaps=!1,i.flipY=!1,this._realMaps.push(i)),this._curvesMaps.push(i),i.needsUpdate=!0;for(var r=2-this._curvesMaps.length,n=0;n<r;n++)this._curvesMaps.push(s)},p.prototype._reallocateMap=function(e,t){if(e>this._curvesMapsProperties.x||t>this._curvesMapsProperties.y){for(var i=4*this._curvesMapsProperties.x*this._curvesMapsProperties.y,r=new Float32Array(4*e*t),n=0;n<i;n++)r[n]=this._curvesData[n];return this._curvesData=r,!0}return!1},p.prototype._initCurvesMaps=function(e){return!0};var g=function(){this._LODSags=[6,8,10,12,14,16],this._nbLODs=this._LODSags.length,this._instancingGroups=[];for(var t=0;t<33;t++)this._instancingGroups.push(null);this._perRenderableData=new Map,this._geometryToInstancingGroup=new Map,this._matricesJSArray=[],this._matricesFloat32Array=null,this._curvesMatricesProperties=new e.Vector3,this._matrixRanges=new d,this._matricesMaps=[],this._realMaps=[],this._updateMatricesMapsStatus=l,this._compressedSideVectors_tmp=[],this._capsPoints_tmp=new Array(6),this.pipesToRemove=[],this._debugNbPipes=0,this.debugNbCreatedTextures=0};g.prototype._changeMatricesMapStatus=function(e){this._updateMatricesMapsStatus!==l&&(this._updateMatricesMapsStatus=e)},g.prototype._initMatricesMap=function(){if(this._updateMatricesMapsStatus!==h){if(this._updateMatricesMapsStatus===l){n.init(),this._matricesMaps=[];var t=4*this._matrixRanges.getTotalNumberOfIDs(),i=t-Math.floor(t/n.maxTextureTotalSize)*n.maxTextureTotalSize,r=Math.sqrt(i),o=a(r,128),u=a(i/o,2);this._curvesMatricesProperties.x=o,this._curvesMatricesProperties.y=u;var d=Math.max(1,Math.ceil(t/n.maxTextureTotalSize));this._curvesMatricesProperties.z=d;var p=n.maxTextureTotalSize,f=n.maxTextureSize,m=4*((d-1)*p+o*u);this._matricesFloat32Array=new Float32Array(m),this._matricesFloat32Array.set(this._matricesJSArray,0);for(var g,v=this._matricesFloat32Array,S=0,_=0;_<d-1;_++)(g=this._realMaps[S])?(g.image.width=f,g.image.height=f,g.image.data=v.subarray(_*p*4,(_+1)*p*4)):((g=new e.DataTexture(v.subarray(_*p*4,(_+1)*p*4),f,f,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,g.magFilter=e.NearestFilter,g.generateMipmaps=!1,g.flipY=!1,this.debugNbCreatedTextures++,this._realMaps.push(g)),this._matricesMaps.push(g),g.needsUpdate=!0,S++;(g=this._realMaps[S])?(g.image.width=o,g.image.height=u,g.image.data=v.subarray((d-1)*p*4,m)):((g=new e.DataTexture(v.subarray((d-1)*p*4,m),o,u,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,g.magFilter=e.NearestFilter,g.generateMipmaps=!1,g.flipY=!1,this.debugNbCreatedTextures++,this._realMaps.push(g)),this._matricesMaps.push(g),g.needsUpdate=!0;for(var y=2-this._matricesMaps.length,x=0;x<y;x++)this._matricesMaps.push(s);return this._updateMatricesMapsStatus=h,!0}if(this._updateMatricesMapsStatus===c){this._matricesFloat32Array.set(this._matricesJSArray,0);for(var M=this._matricesFloat32Array,P=this._matricesMaps.length,C=0,b=0;b<P;b++){var D=this._matricesMaps[b].image,w=D.width*D.height;C+w>M.length||D.data.set(M.subarray(C,w),0),C+=w,this._matricesMaps[b].needsUpdate=!0}this._updateMatricesMapsStatus=h}}return!1},g.prototype.addCurvedPipe=function(e,t,i,r,n,a,s){var o=this._LODSags[this._LODSags.length-1],h=e.id+"_"+t;this._debugNbPipes++,this.computeCompressedSideVectors(r,s,a);var u=4*this._matrixRanges.getAvailableID(),d=this._perRenderableData.get(h);d||(d=[],this._perRenderableData.set(h,d));for(var f=this._instancingGroups,m=r.length/3,g=m-1,v=1,S=0,_=this._LODSags.length;0!==g;){if(g%2==1){if(!f[v]){f[v]=new p(v,!1,o,this._LODSags);for(var y=0;y<_;y++)this._geometryToInstancingGroup.set(f[v]._LODGeometries[y].id,f[v])}f[v]._nbUsed++;var x=3*(Math.pow(2,v-1)+1),M=f[v]._addCurvedPipe(h,i,r,S,S+x,n,a);d.push({idInMaps:M,matrixId4:u,bin:v}),S+=x-3}v++,g>>=1}if(!f[v=0]){f[v]=new p(v,!0,o,this._LODSags);for(y=0;y<_;y++)this._geometryToInstancingGroup.set(f[v]._LODGeometries[y].id,f[v])}f[v]._nbUsed++;x=6;this._capsPoints_tmp[0]=r[0],this._capsPoints_tmp[1]=r[1],this._capsPoints_tmp[2]=r[2],this._capsPoints_tmp[3]=r[3*(m-1)],this._capsPoints_tmp[4]=r[3*(m-1)+1],this._capsPoints_tmp[5]=r[3*(m-1)+2],this._compressedSideVectors_tmp[1]=this._compressedSideVectors_tmp[m-1];M=f[v]._addCurvedPipe(h,i,this._capsPoints_tmp,0,x,n,a);d.push({idInMaps:M,matrixId4:u,bin:v});var P=this._matricesJSArray,C=e.matrixWorld.elements,b=4*u;P[b]=C[0],P[b+1]=C[1],P[b+2]=C[2],P[b+3]=0,P[b+4]=C[4],P[b+5]=C[5],P[b+6]=C[6],P[b+7]=0,P[b+8]=C[8],P[b+9]=C[9],P[b+10]=C[10],P[b+11]=0,P[b+12]=C[12],P[b+13]=C[13],P[b+14]=C[14],P[b+15]=i,this._matrixRanges.addID(u/4);var D=this._matrixRanges.getTotalNumberOfIDs();!this._matricesFloat32Array||16*D>this._matricesFloat32Array.length?this._changeMatricesMapStatus(l):this._changeMatricesMapStatus(c)},g.prototype.addHLCurvedPipe=function(e,t){for(var i=0;i<t.geometry.drawingGroups.length;i++){var r=this._perRenderableData.get(t.id+"_"+i);r&&this._perRenderableData.set(e.id+"_"+i,r)}},g.prototype.removeCurvedPipe=function(e,t){e&&this.pipesToRemove.push(e);for(var i=[],r=0;r<this.pipesToRemove.length;r++){var n=this.pipesToRemove[r];if(0===Object.keys(n._tokens).length){this._debugNbPipes-=t._pipes.length;for(var a=0;a<n.geometry.drawingGroups.length;a++){var s=n.id+"_"+a,o=this._perRenderableData.get(s);o&&this._removeCurvedPipe(o,s)}n._flagAsGSSOInvalidated()}else i.push(n)}this.pipesToRemove=i},g.prototype._removeCurvedPipe=function(e,t){for(var i=this._instancingGroups,r=this._matrixRanges.getTotalNumberOfIDs(),n=e.length,a=this._nbLODs,s=0;s<n;s++){var o=e[s],h=o.bin;if(i[h]&&(i[h]._removeCurvedPipe(o.idInMaps),0===i[h]._nbUsed)){for(var u=0;u<a;u++)this._geometryToInstancingGroup.delete(i[h]._LODGeometries[u].id);i[h]=null}this._matrixRanges.removeID(o.matrixId4/4)}if(this._perRenderableData.delete(t),this._changeMatricesMapStatus(c),0!==this._matrixRanges.getNbRanges()){var d=this._matrixRanges.getTotalNumberOfIDs();r!==d&&(this._changeMatricesMapStatus(l),this.resetMapsInfos()),this._matricesJSArray.length=16*d}},g.prototype.resetMapsInfos=function(){this._matricesJSArray=[],this._matricesFloat32Array=null,this._curvesMatricesProperties.set(0,0,0),this._matricesMaps=[]},g.prototype.computeCompressedSideVectors=function(t,i,r){var n=0,a=(new e.Vector3).copy(i),s=o(a);this._compressedSideVectors_tmp[n++]=s;for(var l=new e.Vector3,c=new e.Vector3,h=new e.Vector3,u=new e.Vector3,d=t.length/3,p=1;p<d;p++){p===d-1?l.copy(r).normalize():(h.set(t[3*(p-1)],t[3*(p-1)+1],t[3*(p-1)+2]),u.set(t[3*(p+1)],t[3*(p+1)+1],t[3*(p+1)+2]),l.subVectors(u,h).normalize());var f=a.dot(l);l.multiplyScalar(f),c.subVectors(a,l).normalize(),this._compressedSideVectors_tmp[n++]=o(c),a=c}};e.glStates;return g.prototype.setMatrixOnCurvedPipe=function(e){for(var t=0;t<e.geometry.drawingGroups.length;t++){var i=e.id+"_"+t,r=this._perRenderableData.get(i);r&&this._setMatrixOnCurvedPipe(r,e)}},g.prototype._setMatrixOnCurvedPipe=function(e,t){var i=e[0].matrixId4,r=this._matricesJSArray,n=t.matrixWorld.elements,a=4*i;r[a]=n[0],r[a+1]=n[1],r[a+2]=n[2],r[a+4]=n[4],r[a+5]=n[5],r[a+6]=n[6],r[a+8]=n[8],r[a+9]=n[9],r[a+10]=n[10],r[a+12]=n[12],r[a+13]=n[13],r[a+14]=n[14],this._changeMatricesMapStatus(c)},g.prototype.setPDSFXParamsOnMaterial=function(e){e.activatePDSFX(),e.setPDSFXGlobalShaderCode(u._VSGlobal,"");var t={curvesMaps:{type:"t2v",value:null,length:2},curvesMapsProperties:{type:"v3",value:null},curvesMatrices:{type:"t2v",value:null,length:2},curvesMatricesProperties:{type:"v3",value:null}};e.setPDSFXUniforms(t);e.setPDSFXVaryings({debugColor:{type:"v3"}}),e._PDSFXData.pdsfxAttributesCode="attribute vec2 specialMeshIds;\n attribute vec3 specialMeshPicking;",e.setPDSFXOverridableFunctions(u._VSOverridables,{})},e.InstancedCurvedPipeManager=new g,e.InstancedCurvedPipeManager}),define("SceneGraphNodes/InstancedCurvedPipeManager",["DS/SceneGraphNodes/InstancedCurvedPipeManager","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/InstancedCurvedPipeManager"),e}),define("DS/Shaders/SSLRBlendShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","varying vec2 vUv;","void main() {","  vec4 color  = texture2D(  tDiffuse, vUv );","  vec4 color2 = texture2D( tDiffuse2, vUv );","  gl_FragColor = vec4((1.0 - color2.a) * color.xyz + color2.a * color2.xyz, color.a);","}"].join("\n")}}),define("Shaders/SSLRBlendShader",["DS/Shaders/SSLRBlendShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/SSLRBlendShader"),e}),define("DS/Gestures/ClickGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(e){return this._parent(t.printMouseButton(e)+"Click"),this.priority=10,this.button=e,this.maxTime=300,this.maxDistance=10,this},detect:function(e){this._parent(e);var r=THREEDS.VisuEventsManager.getMouseEvents(null,this.view);switch(this.state){case i.State.INIT:for(var n=0;n<r.length;n++){if((a=r[n]).state===t.State.BEGIN&&a.button===this.button)return void this.changeState(i.State.BEGIN)}break;case i.State.BEGIN:for(n=0;n<r.length;n++){var a;if((a=r[n]).button===this.button)if(a.state===t.State.MOVE){if(a.offsetPosition.length()>this.maxDistance||a.currentTime-a.startTime>this.maxTime)return void this.changeState(i.State.KO)}else if(a.state===t.State.END)return void(a.offsetPosition.length()>this.maxDistance||a.currentTime-a.startTime>this.maxTime?this.changeState(i.State.KO):(this.events=[a],this.changeState(i.State.OK)))}break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/ClickGesture",r)}),define("Gestures/ClickGesture",["DS/Gestures/ClickGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/ClickGesture"),e}),define("DS/Shaders/StereoShaders",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{leftRight:{uniforms:{tLeftEye:{type:"t",value:null},tRightEye:{type:"t",value:null},tDiffuse:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tDiffuse;","uniform sampler2D tLeftEye;","uniform sampler2D tRightEye;","void main() {","if(vUv.x < 0.5) {","gl_FragColor = texture2D(tLeftEye, vec2(vUv.x*2.0, vUv.y));","} else {","gl_FragColor = texture2D(tRightEye, vec2((vUv.x-0.5)*2.0, vUv.y));","}","} "].join("\n")},anaglyph:{uniforms:{tLeftEye:{type:"t",value:null},tRightEye:{type:"t",value:null},tDiffuse:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tDiffuse;","uniform sampler2D tLeftEye;","uniform sampler2D tRightEye;","void main() {","vec4 cr = texture2D(tLeftEye, vUv);","vec4 cl = texture2D(tRightEye, vUv);","gl_FragColor = vec4(cl.r, cr.g, cr.b, 1.0);","} "].join("\n")},oculusDK1:{uniforms:{tLeftEye:{type:"t",value:null},tRightEye:{type:"t",value:null},tDiffuse:{type:"t",value:null},scale:{type:"v2",value:new e.Vector2(1,1)},scaleIn:{type:"v2",value:new e.Vector2(1,1)},leftLensCenter:{type:"v2",value:new e.Vector2(0,0)},hmdWarpParam:{type:"v4",value:new e.Vector4(1,0,0,0)},chromAbParam:{type:"v4",value:new e.Vector4(1,0,0,0)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tDiffuse;","uniform sampler2D tLeftEye;","uniform sampler2D tRightEye;","uniform vec2 scale;","uniform vec2 scaleIn;","uniform vec2 leftLensCenter;","uniform vec4 hmdWarpParam;","uniform vec4 chromAbParam;","void main() {","  if(vUv.x >= 0.5) {","    vec2 lensCenter = leftLensCenter;","    vec2 uv = (vec2((vUv.x-0.5)*2.0, vUv.y)*2.0)-1.0;","    vec2 theta = (uv-lensCenter)*scaleIn;","    float rSq = theta.x*theta.x + theta.y*theta.y;","    vec2 rvector = theta*(hmdWarpParam.x + hmdWarpParam.y*rSq + hmdWarpParam.z*rSq*rSq + hmdWarpParam.w*rSq*rSq*rSq);","    vec2 rBlue = rvector * (chromAbParam.z + chromAbParam.w * rSq);","    vec2 tcBlue = (lensCenter + scale * rBlue);","    tcBlue = (tcBlue+1.0)/2.0;","    if (any(bvec2(clamp(tcBlue, vec2(0.0,0.0), vec2(1.0,1.0))-tcBlue))) {","      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);","      return;}","    vec2 tcGreen = lensCenter + scale * rvector;","    tcGreen = (tcGreen+1.0)/2.0;","    vec2 rRed = rvector * (chromAbParam.x + chromAbParam.y * rSq);","    vec2 tcRed = lensCenter + scale * rRed;","    tcRed = (tcRed+1.0)/2.0;","    gl_FragColor = vec4(texture2D(tLeftEye, tcRed).r, texture2D(tLeftEye, tcGreen).g, texture2D(tLeftEye, tcBlue).b, 1.0);","  } else {","    vec2 lensCenter = -leftLensCenter;","    vec2 uv = (vec2(vUv.x*2.0, vUv.y)*2.0)-1.0;","    vec2 theta = (uv-lensCenter)*scaleIn;","    float rSq = theta.x*theta.x + theta.y*theta.y;","    vec2 rvector = theta*(hmdWarpParam.x + hmdWarpParam.y*rSq + hmdWarpParam.z*rSq*rSq + hmdWarpParam.w*rSq*rSq*rSq);","    vec2 rBlue = rvector * (chromAbParam.z + chromAbParam.w * rSq);","    vec2 tcBlue = (lensCenter + scale * rBlue);","    tcBlue = (tcBlue+1.0)/2.0;","    if (any(bvec2(clamp(tcBlue, vec2(0.0,0.0), vec2(1.0,1.0))-tcBlue))) {","      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);","      return;}","    vec2 tcGreen = lensCenter + scale * rvector;","    tcGreen = (tcGreen+1.0)/2.0;","    vec2 rRed = rvector * (chromAbParam.x + chromAbParam.y * rSq);","    vec2 tcRed = lensCenter + scale * rRed;","    tcRed = (tcRed+1.0)/2.0;","    gl_FragColor = vec4(texture2D(tRightEye, tcRed).r, texture2D(tRightEye, tcGreen).g, texture2D(tRightEye, tcBlue).b, 1.0);","  }","} "].join("\n")},oculusDK2:{uniforms:{tEye:{type:"t",value:null},tDiffuse:{type:"t",value:null},eyeToSourceUVScale:{type:"v2",value:new e.Vector2(.33333333,.3333333)},eyeToSourceUVOffset:{type:"v2",value:new e.Vector2(.5,.5)}},vertexShader:["varying vec2 uvr;","varying vec2 uvg;","varying vec2 uvb;","uniform vec2 eyeToSourceUVScale;","uniform vec2 eyeToSourceUVOffset;","void main() {","uvr = uv.xy * eyeToSourceUVScale + eyeToSourceUVOffset;","uvg = uv2.xy * eyeToSourceUVScale + eyeToSourceUVOffset;","uvb = _DStangent.xy * eyeToSourceUVScale + eyeToSourceUVOffset;","uvr.y = 1.0 - uvr.y;","uvg.y = 1.0 - uvg.y;","uvb.y = 1.0 - uvb.y;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 uvr;","varying vec2 uvg;","varying vec2 uvb;","uniform sampler2D tDiffuse;","uniform sampler2D tEye;","void main() {","gl_FragColor = vec4(texture2D(tEye, uvr).r, texture2D(tEye, uvg).g, texture2D(tEye, uvb).b, 1.0);","} "].join("\n")}}}),define("Shaders/MirrorShaders",["DS/Shaders/MirrorShaders","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/MirrorShaders"),e}),define("DS/Visualization/CameraSystem",["UWA/Class","DS/Shaders/StereoShaders","DS/Plugins/ShaderPass","DS/Plugins/RenderPass","DS/Visualization/ThreeJS_DS","DS/Plugins/ClearPass"],function(e,t,i,r,n,a){"use strict";var s=e.extend({init:function(){this._computeCameraArrayCB=null,this._predefinedCombineShader=null,this._shaderParameters=null,this._extFrameBuffer=null},setComputeCameraArrayCB:function(e,t){this._computeCameraArrayCB=e,this.useExternalProjectionMatrix=!!t},setUsePredefinedCombineShader:function(e,t){this._predefinedCombineShader=e,this._shaderParameters=t;var i=o[this._predefinedCombineShader];i.warmup&&i.warmup()},getViewportSize:function(e,t){return o[this._predefinedCombineShader].getViewportSize.apply(this,arguments)},computeCameraArray:function(e,t,i){var r,n=this._computeCameraArrayCB(e,t,i);for(r=0;n&&r<n.length;r++)n[r].updateProjectionMatrix(),n[r].projectionMatrixInverse.getInverse(n[r].projectionMatrix);return n},getUniformName:function(e){return o[this._predefinedCombineShader].uniformsName[e]},applyShaderParameters:function(e){var t;if(e&&this._shaderParameters)for(t in this._shaderParameters)e[t].value=this._shaderParameters[t]},isReady:function(){var e=o[this._predefinedCombineShader];return"ShaderPass"===e.type||e.ready},createPasses:function(e){var t=o[this._predefinedCombineShader];"ShaderPass"===t.type?(this.stereoPass=new i(t.combineShader,void 0,"stereoPass"),e.composerContext.setPassRenderToCanvas(this.stereoPass,!0)):"RenderPass"===t.type&&(this.clearPass=new a("combineClearPass"),e.addPass(this.clearPass),e.composerContext.setPassRenderToCanvas(this.clearPass,!0),this.stereoPass=new r(null,null,null,null,null,null,"combineStereoPass"),this.stereoPass.setDepthFunc("ALWAYS"),this.stereoPass.setDisableBackFaceCulling(!0),this.stereoScene=new n.Scene,this.stereoScene.renderResultIndices={},t.fillScene(this.stereoScene),this.stereoPass.scene=this.stereoScene,e.composerContext.setPassClear(this.clearPass,!0,new n.Color(0),1),e.composerContext.setPassRenderToCanvas(this.stereoPass,!0)),e.addPass(this.stereoPass)},updatePasses:function(e,t,i){var r,n=o[this._predefinedCombineShader];if("ShaderPass"===n.type){for(r=0;r<e.length;r++){var a=this.getUniformName(r);this.stereoPass.uniforms[a].value=i[e[r]]}this.applyShaderParameters(this.stereoPass.uniforms)}else if("RenderPass"===n.type){var s=this.stereoPass.scene;for(r=0;r<s.myMeshes.length;r++){var l;for(l in s.myMeshes[r].material.uniforms.tEye.value=i[e[s.renderResultIndices[s.myMeshes[r].id]]],n.parameters[r])s.myMeshes[r].material.uniforms[l].value=n.parameters[r][l];if(this._shaderParameters)for(l in this._shaderParameters[r])s.myMeshes[r].material.uniforms[l].value=this._shaderParameters[r][l]}}this.stereoPass.renderToScreen=t},isStereo:function(){return!0},setExternalFrameBuffer:function(e){this._extFrameBuffer=e},getExternalFrameBuffer:function(){return this._extFrameBuffer}}),o={leftRight:{getViewportSize:function(e,t){return{width:Math.floor(e/2),height:t}},combineShader:t.leftRight,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},oculusDK1:{getViewportSize:function(e,t){return{width:Math.floor(e/2),height:t}},combineShader:t.oculusDK1,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},anaglyph:{getViewportSize:function(e,t){return{width:e,height:t}},combineShader:t.anaglyph,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},oculusDK2:{getViewportSize:function(e,t){return{width:Math.floor(e/2),height:t}},ready:!1,warmup:function(){require(["DS/OculusDK2/OculusDK2DeformationMeshCreator"],function(e){o.oculusDK2.ready=!0,o.oculusDK2.OculusDK2DeformationMeshCreator=e})},fillScene:function(e){var i=o.oculusDK2;i.uniforms=n.UniformsUtils.clone(t.oculusDK2.uniforms);var r=new n.ShaderMaterial({uniforms:i.uniforms,vertexShader:t.oculusDK2.vertexShader,fragmentShader:t.oculusDK2.fragmentShader});i.OculusDK2DeformationMeshCreator.fillScene(e,r)},parameters:[{eyeToSourceUVScale:new n.Vector2(.464894474,.376141697),eyeToSourceUVOffset:new n.Vector2(.492164134,.5)},{eyeToSourceUVScale:new n.Vector2(.464894474,.376141697),eyeToSourceUVOffset:new n.Vector2(.507835866,.5)}],type:"RenderPass"}};return s}),define("DS/Shaders/BokehDOFShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{uniforms:{textureWidth:{type:"f",value:512},textureHeight:{type:"f",value:512},focalDepth:{type:"f",value:1},focalLength:{type:"f",value:64},fstop:{type:"f",value:.9},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},sensorSize:{type:"f",value:24},sceneScale:{type:"f",value:1},maxCoC:{type:"f",value:1},tDiffuse:{type:"t",value:null},tNormalDepth:{type:"t",value:null},maxblur:{type:"f",value:5},showFocus:{type:"i",value:0},manualdof:{type:"i",value:0},threshold:{type:"f",value:.5},gain:{type:"f",value:2},bias:{type:"f",value:.5},fringe:{type:"f",value:.7},noise:{type:"i",value:1},dithering:{type:"f",value:1e-4},shaderFocus:{type:"i",value:0},focusCoords:{type:"v2",value:new e.Vector2}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform mat4 realProjectionMatrixInverse;","uniform sampler2D tDiffuse;","uniform sampler2D tNormalDepth;","uniform float textureWidth;","uniform float textureHeight;","const float PI = 3.14159265;","uniform float focalDepth;  ","uniform float focalLength; ","uniform float fstop; ","uniform float sensorSize;","uniform float sceneScale;","uniform float maxCoC;","uniform bool showFocus; ","const int samples = SAMPLES; ","const int rings = RINGS; ","const int maxringsamples = rings * samples;","uniform bool manualdof; ","float ndofstart = 1.0; ","float ndofdist = 2.0; ","float fdofstart = 1.0; ","float fdofdist = 3.0; ","float CoC = 0.03; ","uniform bool shaderFocus;","uniform vec2 focusCoords;","uniform float maxblur;","uniform float threshold; ","uniform float gain; ","uniform float bias; ","uniform float fringe; ","uniform bool noise; ","uniform float dithering;","float getZ(vec2 coords){","vec4 normalDepth = texture2D( tNormalDepth, coords );","float z = normalDepth.w;","#if DOF_BEHAVIOUR == 3","if ( z == 0.0 ) return 0.0;","#else","if ( z == 0.0 ) z=1.0;","#endif","return z;","}","float getDepth(vec2 coords, float z ) {","vec2 xy = coords * 2.0 - 1.0;","vec4 vertexPositionProjected = vec4( xy, 2.0 * z - 1.0, 1.0 );","vec4 vertexPositionVS = realProjectionMatrixInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","vertexPositionVS.w = 1.0;","return -vertexPositionVS.z*sceneScale;","}","vec3 color(vec2 coords, float blur) {","vec3 col = texture2D(tDiffuse, coords).rgb;","return col;","}","vec2 rand(vec2 coord) {","float noiseX = ((fract(1.0-coord.s*(textureWidth/2.0))*0.25)+(fract(coord.t*(textureHeight/2.0))*0.75))*2.0-1.0;","float noiseY = ((fract(1.0-coord.s*(textureWidth/2.0))*0.75)+(fract(coord.t*(textureHeight/2.0))*0.25))*2.0-1.0;","if (noise) {","noiseX = clamp(fract(sin(dot(coord ,vec2(12.9898,78.233))) * 43758.5453),0.0,1.0)*2.0-1.0;","noiseY = clamp(fract(sin(dot(coord ,vec2(12.9898,78.233)*2.0)) * 43758.5453),0.0,1.0)*2.0-1.0;","}","return vec2(noiseX, noiseY);","}","vec3 debugFocus(vec3 col, float blur, float depth) {","float edge = 0.002*depth; ","float m = clamp(smoothstep(0.0,edge,blur),0.0,1.0);","float e = clamp(smoothstep(1.0-edge,1.0,blur),0.0,1.0);","col = mix(col,vec3(1.0,0.5,0.0),(1.0-m)*0.6);","col = mix(col,vec3(0.0,0.5,1.0),((1.0-e)-(1.0-m))*0.2);","return col;","}","float getMaximumPhysicalBlurSize(){","float effectiveAperture = focalLength/fstop;","float magnification = clamp(focalLength/(focalDepth-focalLength),0.0,1.0);","return effectiveAperture*magnification;","}","float getPhysicalBlurSize(float depth){","if(depth>=focalDepth){","float maxBlur = getMaximumPhysicalBlurSize();","float distToFocus = abs(depth-focalDepth);","float focusRatio = distToFocus/depth;","return maxBlur*focusRatio;","}else if(depth>=focalLength){","float currFocal = depth*focalLength/(depth-focalLength);","float focusFocal = focalDepth*focalLength/(focalDepth-focalLength);","float distToFocus = abs(currFocal-focusFocal);","float focusRatio = distToFocus/currFocal;","return focalLength/fstop * focusRatio;","}else {","return focalLength/fstop;","}","}","float getScreenRadius(float physicalRadius){","float sensorToScreenSizeRatio = float(textureHeight)/sensorSize;","return sensorToScreenSizeRatio*physicalRadius;","}","float getOffsetLength(float i){","return i;","}","vec2 getOffsetedUV(vec2 uv,float length,float j,float w,float h,float steps){","float pw = cos(j*steps)*length;","float ph = sin(j*steps)*length;","vec2 res_uv =uv + vec2(pw*w, ph*h);","res_uv.x = floor(0.5+(res_uv.x*textureWidth))/float(textureWidth);","res_uv.y = floor(0.5+(res_uv.y*textureHeight))/float(textureHeight);","return res_uv;","}","float gather(float i, float j, int ringsamples, inout vec3 col, float w, float h, float blur) {","float rings2 = float(rings);","float step = PI*2.0 / float(ringsamples);","float pw = cos(j*step)*i;","float ph = sin(j*step)*i;","float weight = mix(1.0, i/rings2, bias);","col += color(vUv.xy + vec2(pw*w, ph*h), blur) * weight;","return weight;","}","void main() {","float pixelZ = getZ(vUv.xy);","float depth = getDepth(vUv.xy,pixelZ);","float fDepth = focalDepth;","vec4 colAlpha = texture2D(tDiffuse, vUv.xy);","vec3 col = colAlpha.rgb;","#if DOF_BEHAVIOUR==3","float blur = 0.0;","if (manualdof) {","float a = depth - fDepth;","float b = (a - fdofstart) / fdofdist;","float c = (- a - ndofstart) / ndofdist;","blur = (a > 0.0) ? b : c;","} else {","float f = focalLength;","float d = fDepth;","float o = depth;","float a = (o * f) / (o - f);","float b = (d * f) / (d - f);","float c = (d - f) / (d * fstop * CoC);","blur = abs(a - b) * c;","}","blur = clamp(blur, 0.0, 1.0);","vec2 noise = rand(vUv.xy) * dithering * blur;","float w = (1.0 / textureWidth) * blur * maxblur + noise.x;","float h = (1.0 / textureHeight) * blur * maxblur + noise.y;","#else","float sensorBlurRadius = getPhysicalBlurSize(depth)/2.0;","float blurRadius = min(getScreenRadius(sensorBlurRadius),maxCoC*float(textureHeight));","vec2 noise = rand(vUv.xy) * dithering;","float hBlur = blurRadius/float(textureWidth)+noise.x;","float vBlur = blurRadius/float(textureHeight)+noise.y;","float maxSensorBlurRadius = getMaximumPhysicalBlurSize()/2.0;","float maxBlurRadius =  min(getScreenRadius(maxSensorBlurRadius),maxCoC*float(textureHeight));","float maxHBlur = maxBlurRadius/float(textureWidth)+noise.x;","float maxVBlur = maxBlurRadius/float(textureHeight)+noise.y;","#endif","float s = 1.0;","int ringsamples;","float rings2 = float(rings);","#if DOF_BEHAVIOUR==3","for (int i = 1; i <= rings; i++) {","ringsamples = i * samples;","for (int j = 0 ; j < maxringsamples ; j++) {","if (j >= ringsamples) break;","s += gather(float(i), float(j), ringsamples, col, w, h, blur);","}","}","#else","for (int i = 1; i <= rings; i++) {","ringsamples = i * samples;","float iRatio = float(i)/float(rings);","float dist =iRatio*maxBlurRadius;","for (int j = 0 ; j < maxringsamples ; j++) {","if (j >= ringsamples) break;","float weight = mix(1.0, iRatio, bias);","float step = PI*2.0 / float(ringsamples);","#if PHYSIC == 1","vec2 uv = getOffsetedUV(vUv.xy,getOffsetLength(iRatio),float(j),hBlur,vBlur,step);","float sampleZ=getZ(uv);","float takeSample = (sampleZ>=pixelZ)?1.0:0.0;","col += takeSample*texture2D(tDiffuse, uv).rgb * weight;","s+= takeSample*weight;","#else","vec2 uvMax = getOffsetedUV(vUv.xy,getOffsetLength(iRatio),float(j),maxHBlur,maxVBlur,step);","float sampleZMax=getZ(uvMax);","float currentDepth = getDepth(uvMax.xy,sampleZMax);","float currentsensorBlurRadius = getPhysicalBlurSize(currentDepth)/2.0;","float currentblurRadius = getScreenRadius(currentsensorBlurRadius);","if(currentblurRadius>=dist){","float takeSample = 1.0;","col += takeSample*texture2D(tDiffuse, uvMax).rgb * weight;","s+= takeSample*weight;","}","#endif","}","}","#endif","col /= s;","gl_FragColor.rgb = col;","gl_FragColor.a = colAlpha.a;","} "].join("\n")}}),define("Shaders/BokehDOFShader",["DS/Shaders/BokehDOFShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/BokehDOFShader"),e}),define("DS/Gestures/MediumHoldGesture",["DS/Gestures/HoldGesture"],function(e){"use strict";var t=e.extend({init:function(){return this._parent(),this.priority=100,this.name="MediumHold",this.maxTime=THREEDS.VisuEventsManager.getMediumHoldTime(),this},detect:function(e){this._parent(e)}});return UWA.namespace("THREEDS/Gestures/MediumHoldGesture",t)}),define("Gestures/MediumHoldGesture",["DS/Gestures/MediumHoldGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/MediumHoldGesture"),e}),define("DS/Shaders/SMAAShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{EdgeDetection:{uniforms:{tDiffuse:{type:"t",value:null},screenWidth:{type:"f",value:800},screenHeight:{type:"f",value:600}},vertexShader:["varying vec2 vUv;","varying vec4 offset[3];","uniform float screenHeight;","uniform float screenWidth;","void main() {","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth,1.0/screenHeight);","    vUv = uv;","    offset[0] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4(-1.0, 0.0, 0.0, 1.0);","    offset[1] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4( 1.0, 0.0, 0.0, -1.0);","    offset[2] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4(-2.0, 0.0, 0.0, -2.0);",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","varying vec4 offset[3];","float SMAA_THRESHOLD = 0.1;","void main() {","   vec2 threshold = vec2(SMAA_THRESHOLD, SMAA_THRESHOLD);","   vec3 weights   = vec3(0.2126,0.7152,0.0722);","   float L        = dot(texture2D(tDiffuse, vUv.xy).rgb, weights);","   float Lleft    = dot(texture2D(tDiffuse, offset[0].xy).rgb, weights);","   float Ltop     = dot(texture2D(tDiffuse, offset[0].zw).rgb, weights);","   vec4 delta;","   delta.xy   = abs(L - vec2(Lleft, Ltop));","   vec2 edges = step(threshold, delta.xy);","   float Lright   = dot(texture2D(tDiffuse, offset[1].xy).rgb, weights);","   float Lbottom  = dot(texture2D(tDiffuse, offset[1].zw).rgb, weights);","   delta.zw = abs(L - vec2(Lright, Lbottom));","   vec2 maxDelta  = max(delta.xy, delta.zw);","   maxDelta       = max(maxDelta.xx, maxDelta.yy);","   float Lleftleft = dot(texture2D(tDiffuse, offset[2].xy).rgb, weights);","   float Ltoptop   = dot(texture2D(tDiffuse, offset[2].zw).rgb, weights);","   delta.zw        = abs(vec2(Lleft, Ltop) - vec2(Lleftleft, Ltoptop));","   maxDelta = max(maxDelta.xy, delta.zw);","   edges.xy *= step(0.5 * maxDelta, delta.xy);","   gl_FragColor = vec4(edges, 0.0, 1.0);","}"].join("\n")},BlendingWeights:{uniforms:{tDiffuse:{type:"t",value:null},areaTex:{type:"t",value:null},searchTex:{type:"t",value:null},screenWidth:{type:"f",value:800},screenHeight:{type:"f",value:600}},vertexShader:["varying vec2 vUv;","varying vec4 offset[3];","uniform float screenHeight;","uniform float screenWidth;","const int SMAA_MAX_SEARCH_STEPS = 8;","void main() {","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","   vUv = uv;","   offset[0] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4(-0.25, 0.125,  1.25, 0.125);","   offset[1] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4(-0.125, 0.25, -0.125,  -1.25);","   offset[2] = vec4(offset[0].xz, offset[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * SMAA_PIXEL_SIZE.xxyy * float(SMAA_MAX_SEARCH_STEPS);",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D searchTex;","uniform sampler2D areaTex;","uniform float screenHeight;","uniform float screenWidth;","varying vec2 vUv;","varying vec4 offset[3];","vec2 SMAA_PIXEL_SIZE;","const int   SMAA_FORCE_DIAGONAL_DETECTION  = 1;","const int   SMAA_FORCE_CORNER_DETECTION    = 1;","const int   SMAA_AREATEX_MAX_DISTANCE      = 16;","const int   SMAA_AREATEX_MAX_DISTANCE_DIAG = 20;","const float SMAA_AREATEX_SUBTEX_SIZE       = 1.0 / 7.0;","const vec2  SMAA_AREATEX_PIXEL_SIZE        = vec2(1.0 / 160.0, 1.0/ 560.0);","const float  SMAA_THRESHOLD              = 0.1;","const int    SMAA_MAX_SEARCH_STEPS       = 16;","const int    SMAA_MAX_SEARCH_STEPS_DIAG  = 8;","const int    SMAA_CORNER_ROUNDING        = 25;","float SMAASearchLength(vec2 e, float bias, float scale) {","   e.r = bias + e.r * scale;","   return  255.0*texture2D(searchTex, vec2(e.x,1.0-e.y)).r;","}","float SMAASearchXLeft() {","   vec2 texCoord = vUv + SMAA_PIXEL_SIZE * vec2(-0.25, 0.125);","   float end = (vUv.x - 0.25 * SMAA_PIXEL_SIZE.x) - 2.0 * SMAA_PIXEL_SIZE.x * float(SMAA_MAX_SEARCH_STEPS);","   vec2 e = vec2(0.0, 1.0);","   for(int i = 0;i<SMAA_MAX_SEARCH_STEPS;i++){","       if((texCoord.x > end) && (e.g > 0.8281) && (e.r == 0.0)){","           e = texture2D(tDiffuse, texCoord).rg;","           texCoord.x -= 2.0 * SMAA_PIXEL_SIZE.x;","       }else","           break;","   }","   texCoord.x += 0.25 * SMAA_PIXEL_SIZE.x;","   texCoord.x += SMAA_PIXEL_SIZE.x;","   texCoord.x += 2.0 * SMAA_PIXEL_SIZE.x;","   texCoord.x -= SMAA_PIXEL_SIZE.x * SMAASearchLength(e, 0.0, 0.5);","   return texCoord.x  ;","}","float SMAASearchXRight() {","   vec2 texcoord = vUv + SMAA_PIXEL_SIZE * vec2(1.25, 0.125);","   float end = (vUv.x + 1.25 * SMAA_PIXEL_SIZE.x) + 2.0 * SMAA_PIXEL_SIZE.x * float(SMAA_MAX_SEARCH_STEPS);","   vec2 e = vec2(0.0, 1.0);","   for(int i = 0;i<SMAA_MAX_SEARCH_STEPS;i++){","       if((texcoord.x < end) && (e.g > 0.8281) && (e.r == 0.0)){","           e = texture2D(tDiffuse, texcoord).rg;","           texcoord += vec2(2.0, 0.0) * SMAA_PIXEL_SIZE;","       }else","           break;","   }","   texcoord.x -= 0.25 * SMAA_PIXEL_SIZE.x;","   texcoord.x -= SMAA_PIXEL_SIZE.x;","   texcoord.x -= 2.0 * SMAA_PIXEL_SIZE.x;","   texcoord.x += SMAA_PIXEL_SIZE.x * SMAASearchLength(e, 0.5, 0.5);","   return texcoord.x;","}","float SMAASearchYDown() {","   vec2 texcoord = vUv + SMAA_PIXEL_SIZE * vec2(-0.125, -1.25);","   float end = (vUv.y - 1.25 * SMAA_PIXEL_SIZE.y) - 2.0 * SMAA_PIXEL_SIZE.y * float(SMAA_MAX_SEARCH_STEPS);","   vec2 e = vec2(1.0, 0.0);","   for(int i = 0;i<SMAA_MAX_SEARCH_STEPS;i++){","       if((texcoord.y > end) && (e.r > 0.8281) && (e.g == 0.0)){","           e = texture2D(tDiffuse, texcoord).rg;","           texcoord -= vec2(0.0, 2.0) * SMAA_PIXEL_SIZE;","       }else","           break;","   }","   texcoord.y += 0.25 * SMAA_PIXEL_SIZE.y;","   texcoord.y += SMAA_PIXEL_SIZE.y;","   texcoord.y -= SMAA_PIXEL_SIZE.y * SMAASearchLength(e.gr ,0.5, 0.5);","   return texcoord.y ;","}","float SMAASearchYUp() {","   vec2 texcoord = vUv + SMAA_PIXEL_SIZE * vec2(-0.125, 0.25);","   float end = (vUv.y + 0.25 * SMAA_PIXEL_SIZE.y) + 2.0 * SMAA_PIXEL_SIZE.y * float(SMAA_MAX_SEARCH_STEPS);","   vec2 e = vec2(1.0, 0.0);","   for(int i = 0;i<SMAA_MAX_SEARCH_STEPS;i++){","       if((texcoord.y < end) && (e.r > 0.8281) && (e.g == 0.0)){","           e = texture2D(tDiffuse, texcoord).rg;","           texcoord += vec2(0.0, 2.0) * SMAA_PIXEL_SIZE;","       }else","           break;","   }","   texcoord.y -= 0.25 * SMAA_PIXEL_SIZE.y;","   texcoord.y -= SMAA_PIXEL_SIZE.y;","   texcoord.y -= 2.0 * SMAA_PIXEL_SIZE.y;","   texcoord.y += SMAA_PIXEL_SIZE.y * SMAASearchLength(e.gr, 0.0, 0.5);","   return texcoord.y ;","}","vec2 _round(vec2 invec) {","   return vec2(floor(abs(invec) + vec2(0.5)) * sign(invec));","}","vec2 SMAAArea(vec2 dist, float e1, float e2, float offset) {","   vec2 texcoord = float(SMAA_AREATEX_MAX_DISTANCE) * _round(4.0 * vec2(e1, e2)) + dist  ;","   texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + (0.5 * SMAA_AREATEX_PIXEL_SIZE);","   return texture2D(areaTex, vec2(texcoord.x,1.0-texcoord.y)).rg;","}","void SMAADetectHorizontalCornerPattern(vec2 weights, vec2 texcoord, vec2 d) {","   if (SMAA_CORNER_ROUNDING < 100 || SMAA_FORCE_CORNER_DETECTION == 1 ){","       vec4 coords = vec4(d.x, 0.0, d.y, 0.0)*SMAA_PIXEL_SIZE.xyxy+ texcoord.xyxy;","       vec2 e;","       e.r = texture2D(tDiffuse, (coords.xy + vec2(0.0,  -1.0))).r;","       bool left = abs(d.x) < abs(d.y);","       e.g = texture2D(tDiffuse, (coords.xy + vec2(0.0, 2.0))).r;","       if (left) weights *= clamp(float(SMAA_CORNER_ROUNDING) / 100.0 + 1.0 - e,0.0,1.0);","       e.r = texture2D(tDiffuse, (coords.zw + vec2(1.0,  -1.0))).r;","       e.g = texture2D(tDiffuse, (coords.zw + vec2(1.0, 2.0))).r;","       if (!left) weights *= clamp(float(SMAA_CORNER_ROUNDING) / 100.0 + 1.0 - e,0.0,1.0);","   }","}","void SMAADetectVerticalCornerPattern(vec2 weights, vec2 texcoord, vec2 d) {","   if (SMAA_CORNER_ROUNDING < 100 || SMAA_FORCE_CORNER_DETECTION == 1){","       vec4 coords = vec4(0.0, d.x, 0.0, d.y)*SMAA_PIXEL_SIZE.xyxy + texcoord.xyxy;","       vec2 e;","       e.r = texture2D(tDiffuse, (coords.xy + vec2( 1.0, 0.0))).g;","       bool left = abs(d.x) < abs(d.y);","       e.g = texture2D(tDiffuse, (coords.xy + vec2(-2.0, 0.0))).g;","       if (left) weights *= clamp(float(SMAA_CORNER_ROUNDING) / 100.0 + 1.0 - e,0.0,1.0);","       e.r = texture2D(tDiffuse, (coords.zw + vec2( 1.0, -1.0))).g;","       e.g = texture2D(tDiffuse, (coords.zw + vec2(-2.0, -1.0))).g;","       if (!left) weights *= clamp(float(SMAA_CORNER_ROUNDING) / 100.0 + 1.0 - e,0.0,1.0);","\t}","}","vec2 SMAAAreaDiag(vec2 dist, vec2 e) {","   vec2 texcoord = float(SMAA_AREATEX_MAX_DISTANCE_DIAG) * e + dist;","   texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + (0.5 * SMAA_AREATEX_PIXEL_SIZE);","   texcoord.x += 0.5;","   return texture2D(areaTex, vec2(texcoord.x,1.0-texcoord.y)).rg;","}","float SMAASearchDiag1(vec2 texcoord, vec2 dir, float c) {","   texcoord += dir * SMAA_PIXEL_SIZE;","   vec2 e = vec2(0.0, 0.0);","   int j;","   for (int i = 0; i < SMAA_MAX_SEARCH_STEPS_DIAG; i++) {","       j = i;","       e.rg = texture2D(tDiffuse, texcoord).rg;","       if (dot(e, vec2(1.0, 1.0)) < 1.9) break;","       texcoord += dir * SMAA_PIXEL_SIZE;","   }","   return float(j) + float(e.g > 0.9) * c;","}","float SMAASearchDiag2(vec2 texcoord, vec2 dir, float c) {","   texcoord += dir * SMAA_PIXEL_SIZE;","   vec2 e = vec2(0.0, 0.0);","   int j;","   for (int i = 0; i < SMAA_MAX_SEARCH_STEPS_DIAG; i++) {","       j = i;","       e.g = texture2D(tDiffuse, texcoord).g;","       e.r = texture2D(tDiffuse, (texcoord + (vec2(1.0, 0.0)* SMAA_PIXEL_SIZE))).r;","       if (dot(e, vec2(1.0, 1.0)) < 1.9) break;","       texcoord += dir * SMAA_PIXEL_SIZE;","   }","   return float(j) + float(e.g > 0.9) * c;","}","vec2 SMAACalculateDiagWeights(vec2 texcoord, vec2 e, ivec4 subsampleIndices) {","   vec2 weights = vec2(0.0, 0.0);","   vec2 d;","   d.x = e.r > 0.0? SMAASearchDiag1(texcoord, vec2(-1.0,  -1.0), 1.0) : 0.0;","   d.y = SMAASearchDiag1(texcoord, vec2(1.0, 1.0), 0.0);","   if (d.r + d.g > 2.0) {","       vec4 coords = vec4(-d.r, -d.r, d.g, d.g) * SMAA_PIXEL_SIZE.xyxy + texcoord.xyxy;","       vec4 c;","       c.x = texture2D(tDiffuse, (coords.xy + vec2( -1.0, 0.0 )* SMAA_PIXEL_SIZE)).g;","       c.y = texture2D(tDiffuse, (coords.xy + vec2( 0.0,  0.0 )* SMAA_PIXEL_SIZE)).r;","       c.z = texture2D(tDiffuse, (coords.zw + vec2( 1.0,  0.0 )* SMAA_PIXEL_SIZE)).g;","       c.w = texture2D(tDiffuse, (coords.zw + vec2( 1.0, 1.0 )* SMAA_PIXEL_SIZE)).r;","       vec2 e = 2.0 * c.xz + c.yw;","       float t = float(SMAA_MAX_SEARCH_STEPS_DIAG) - 1.0;","       e *= step(d.rg, vec2(t, t));","       weights += SMAAAreaDiag(d, e);","   }","   d.x = SMAASearchDiag2(texcoord, vec2(-1.0, 1.0), 0.0);","   float right = texture2D(tDiffuse, (texcoord + vec2(1.0, 0.0)* SMAA_PIXEL_SIZE)).r;","   d.y = right > 0.0? SMAASearchDiag2(texcoord, vec2(1.0, -1.0), 1.0) : 0.0;","   if (d.r + d.g > 2.0) { ","       vec4 coords = vec4(-d.r, d.r, d.g, -d.g)* SMAA_PIXEL_SIZE.xyxy+ texcoord.xyxy;","       vec4 c;","       c.x  = texture2D(tDiffuse, (coords.xy + vec2(-1.0,  0.0)* SMAA_PIXEL_SIZE)).g;","       c.y  = texture2D(tDiffuse, (coords.xy + vec2( 0.0, 1.0)* SMAA_PIXEL_SIZE)).r;","       c.zw = texture2D(tDiffuse, (coords.zw + vec2( 1.0,  0.0)* SMAA_PIXEL_SIZE)).gr;","       vec2 e = 2.0 * c.xz + c.yw;","       float t = float(SMAA_MAX_SEARCH_STEPS_DIAG) - 1.0;","       e *= step(d.rg, vec2(t, t));","       weights += SMAAAreaDiag(d, e).gr;","   }","   return weights;","}","void main() {","SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","\tvec2 pixcoord = vUv / SMAA_PIXEL_SIZE;","   vec4 weights = vec4(0.0, 0.0, 0.0, 0.0);","   vec2 e = texture2D(tDiffuse, vUv).rg;","   if (e.g > 0.0) {","       if (SMAA_MAX_SEARCH_STEPS_DIAG > 0 || SMAA_FORCE_DIAGONAL_DETECTION == 1)","       weights.rg = SMAACalculateDiagWeights(vUv, e, ivec4(0));","       if (dot(weights.rg, vec2(1.0, 1.0)) == 0.0) {","           vec2 d;","           vec2 coords;","           coords.x = SMAASearchXLeft();","           coords.y = vUv.y + 0.25 * SMAA_PIXEL_SIZE.y ;","           d.x = coords.x;","           float e1 = texture2D(tDiffuse, coords).r;","           coords.x = SMAASearchXRight();","           d.y = coords.x;","           d =  (d / SMAA_PIXEL_SIZE.x) - pixcoord.x ;","           vec2 sqrt_d = sqrt(abs(d));","           float e2 = texture2D(tDiffuse, (coords + vec2(1.0, 0.0)* SMAA_PIXEL_SIZE)).r;","           weights.rg = SMAAArea(sqrt_d, e1, e2, 0.0);","           SMAADetectHorizontalCornerPattern(weights.rg, vUv, d);","       } else","           e.r = 0.0;","   }","   if (e.r > 0.0) {","       vec2 d;","       vec2 coords;","       coords.y = SMAASearchYUp();","       coords.x = offset[0].x;","       d.x = coords.y;","       float e1 = texture2D(tDiffuse, coords).g;","       coords.y = SMAASearchYDown();","       d.y = coords.y;","       d = d / SMAA_PIXEL_SIZE.y - pixcoord.y;","       vec2 sqrt_d = sqrt(abs(d));","       float e2 = texture2D(tDiffuse, (coords + vec2(0.0, 1.0)* SMAA_PIXEL_SIZE)).g;","       weights.ba = SMAAArea(sqrt_d, e1, e2, 0.0);","       SMAADetectVerticalCornerPattern(weights.ba, vUv, d);","   }","   gl_FragColor=weights;","}"].join("\n")},FinalBlending:{uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},screenWidth:{type:"f",value:800},screenHeight:{type:"f",value:600}},vertexShader:["uniform float screenHeight;","uniform float screenWidth;","varying vec2 vUv;","void main() {","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","    vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","uniform float screenHeight;","uniform float screenWidth;","varying vec2 vUv;","void main() {","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","   vec4 topLeft = texture2D(tDiffuse2, vUv);","   float bottom = texture2D(tDiffuse2, vUv.xy + SMAA_PIXEL_SIZE.xy * vec2(0.0, -1.0)).g;","   float right = texture2D(tDiffuse2, vUv.xy + SMAA_PIXEL_SIZE.xy * vec2(1.0, 0.0)).a;","   vec4 a = vec4(topLeft.r, bottom, topLeft.b, right);","   vec4 w = a * a * a;","   float sum = dot(w, vec4(1.0));","   if (sum > 0.0) {","       vec4 color = vec4(0.0);","       vec4 CurrentColor = texture2D(tDiffuse, vUv);","       vec4 ColorLeft = texture2D(tDiffuse, vUv.xy + SMAA_PIXEL_SIZE.xy * vec2(-1.0, 0.0));","       vec4 ColorTop = texture2D(tDiffuse, vUv.xy + SMAA_PIXEL_SIZE.xy * vec2(0.0, 1.0));","       vec4 ColorRight = texture2D(tDiffuse, vUv.xy + SMAA_PIXEL_SIZE.xy * vec2(1.0, 0.0));","       vec4 ColorBottom = texture2D(tDiffuse, vUv.xy + SMAA_PIXEL_SIZE.xy * vec2(0.0, -1.0));","       color = mix(CurrentColor, ColorTop, a.r) * w.r + color;","       color = mix(CurrentColor, ColorBottom, a.g) * w.g + color;","       color = mix(CurrentColor, ColorLeft, a.b) * w.b + color;","       color = mix(CurrentColor, ColorRight, a.a) * w.a + color;","       gl_FragColor = color / sum;","   } else {","       gl_FragColor = texture2D(tDiffuse,vUv);","   }","}"].join("\n")}}}),define("Shaders/SMAAShader",["DS/Shaders/SMAAShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/SMAAShader"),e}),define("DS/Effects/PreHighlightEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/AbstractHighlightEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/AdvancedHighlightShader","DS/Plugins/ClearPass","DS/Visualization/PickingMode"],function(e,t,i,r,n,a,s,o){"use strict";return t.extend({init:function(e,t,i,r){return this._parent(e,t,r+"PreHighlightEffect",i,r,a.FinalBlending),this},update:function(t,i,n,a,o){var l=this.composers[0].renderer;this.sceneGraphSelection=i.selectionPreHL,null===this.hlRenderPass&&(this.hlClearPass=new s(this.prefix+"prehlClearPass"),this.hlRenderPass=new r(i.selectionPreHL.sceneHL,n._renderedCamera,this.prefix+"prehlRenderPass"),this.hlRenderPass.setDisableBackFaceCulling(!0),this.hlRenderPass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.hlRenderPass.cameraName="mainNoJittering",this.hlRenderPass.idString=this.idString,this.composers[0].composerContext.setPassClear(this.hlClearPass,!0,new e.Color(0),0),this.composers[0].addPass(this.hlClearPass),this.composers[0].addPass(this.hlRenderPass));var c=[];this.sceneGraphSelection.enabled&&c.push(this.sceneGraphSelection.sceneHL);var h=c.length;this.hlRenderPass.setMultiRenderCB(function(e,t){return t<h&&(e.scene=c[t],!0)});var[u,d,p]=l.getRenderMode().getMasks();this.hlRenderPass.renderFaceMode=u,this.hlRenderPass.renderLineMode=d,this.hlRenderPass.renderPointMode=p,this.composers[0].composerContext.needsUpdate=!0,this.updateUniforms([])}})}),define("Effects/PreHighlightEffect",["DS/Effects/PreHighlightEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/PreHighlightEffect"),e}),define("DS/Effects/BokehDOFEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ShaderPass","DS/Shaders/BokehDOFShader"],function(e,t,i,r){"use strict";return t.extend({init:function(t,n){var a;this._parent(t),this.behaviour=0,this.useCameraInfo=!1,this.mixPass=new i(r,void 0,"BokehDOFEffect"),this.mixPass.uniforms.focusCoords.value.set(.5,.5),this.defines={RINGS:3,SAMPLES:8,DOF_BEHAVIOUR:this.behaviour,PHYSIC:1},this.mixPass.material.defines=this.defines,this.autofocus=!0,this.distanceToTarget=100,this.lensRadius=1,this.sceneScale=1,this.maxCoC=1,this.iterative=!1,this.maxIteration=128,this.dofOffset=[];var s=0;for(a=0;a<this.maxIteration;a++){var o;do{(o=e.RandomLib.LowDiscrepancy2D(s)).x=2*o.x-1,o.y=2*o.y-1,s++}while(o.length()>1);this.dofOffset.push({x:o.x,y:o.y})}return this.dofOffset.sort(function(e,t){return e.x*e.x+e.y*e.y<t.x*t.x+t.y*t.y?-1:1}),this},initEffect:function(e,t){t.insertComposer(null,this.mixPass),t.getComposer("normalDepth").linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tNormalDepth)},update:function(t,i,r){if(r._renderedCamera.projectionMatrixInverse.getInverse(r._renderedCamera.projectionMatrix),this.mixPass.uniforms.realProjectionMatrixInverse.value=r._renderedCamera.projectionMatrixInverse,this.useCameraInfo){var n=r.camera;if(n instanceof e.PerspectiveCamera){var a=n.focalLength;this.mixPass.uniforms.focalLength.value=a,this.lensRadius=a,this.mixPass.uniforms.fstop.value=n.aperture,this.mixPass.uniforms.sensorSize.value=n.sensorSizeHeight}}this.autofocus&&(this.distanceToTarget=r.getTargetDistance(),this.mixPass.uniforms.focalDepth.value=this.distanceToTarget*this.sceneScale)},updateFocalPlane:function(e){this.distanceToTarget=e,this.mixPass.uniforms.focalDepth.value=e},updateFocalLength:function(e){this.mixPass.uniforms.focalLength.value=e,this.lensRadius=e},updateFStop:function(e){this.mixPass.uniforms.fstop.value=e},updateAperture:function(e){this.mixPass.uniforms.fstop.value=0==e?999999999:this.mixPass.uniforms.focalLength.value/e},setSceneScale:function(e){this.sceneScale=e,this.mixPass.uniforms.sceneScale.value=e},setMaximumCircleOfConfusion:function(e){this.maxCoC=Math.max(Math.min(e,1),0),this.mixPass.uniforms.maxCoC.value=e},setAutoFocus:function(e){this.autofocus=e},setSize:function(e,t){this._parent(e,t)&&(this.mixPass.uniforms.textureWidth.value=e,this.mixPass.uniforms.textureHeight.value=t)},setIterative:function(e){if(e!==this.iterative&&(this.iterative=e,this.mixPass)){var t=this.mixPass.composer;t&&t.contexts.length&&t.contexts[0].enablePass(this.mixPass,this.enabled&&!this.iterative)}},getMaxIteration:function(){return this.maxIteration},computeJitterCamera:function(t,i,r){var n=this.width/this.height,a=t.clone();a._renderingRole=t._renderingRole;var s=a.near*Math.tan(e.Math.degToRad(.5*a.fov)),o=n*s,l=Math.min(this.getMaxIteration()-1,i),c=a.near*this.lensRadius*this.dofOffset[l].x/this.mixPass.uniforms.focalDepth.value,h=a.near*this.lensRadius*this.dofOffset[l].y/this.mixPass.uniforms.focalDepth.value,u=o-c,d=-(o+c),p=s-h,f=-(s+h);r&&(r.x*=2*Math.abs(o),r.y*=2*Math.abs(s),d+=r.x,u+=r.x,f+=r.y,p+=r.y);var m=a.getLookAt().cross(a.up);return a.position.add(a.up.clone().multiplyScalar(this.lensRadius*this.dofOffset[l].y)),a.position.add(m.clone().multiplyScalar(this.lensRadius*this.dofOffset[l].x)),a.projectionMatrix.makeFrustum(d,u,f,p,a.near,a.far),a},Behaviours:{LOW:0,MEDIUM:1,HIGH:2,ARTISTIC:3},setBehaviour:function(e){null!=e&&this.behaviour!=e&&(this.behaviour=e,this.defines.DOF_BEHAVIOUR=this.behaviour,this.defines.RINGS=0==this.behaviour?3:5,this.defines.SAMPLES=0==this.behaviour?8:15,this.mixPass.material.needsUpdate=!0)}})}),define("Effects/BokehDOFEffect",["DS/Effects/BokehDOFEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/BokehDOFEffect"),e}),define("DS/Effects/SMAAEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/SMAAShader","DS/Plugins/ClearPass"],function(e,t,i,r,n,a,s){"use strict";return i.extend({init:function(i,s){this._parent(i);var o=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composer=new r(i,o,s),this.composer.composerContext.name="SMAAEffect",this.composers.push(this.composer),this.pass1=new n(a.EdgeDetection),this.pass1.compileShader(i),this.pass2=new n(a.BlendingWeights),this.pass2.compileShader(i),this.mixPass=new n(a.FinalBlending,void 0,"SMAAEffect"),this.mixPass.compileShader(i),this.composer.addPass(this.pass1),this.composer.addPass(this.pass2);var l=t.getWebappsAssetUrl("Effects",""),c=new e.ImageUtils.loadTexture(l+"AreaTexSMAA.png",void 0,null,null,e.ImageUtils.crossOriginPolicy);c.minFilter=e.LinearFilter,c.magFilter=e.LinearFilter,this.pass2.uniforms.areaTex.value=c;var h=new e.ImageUtils.loadTexture(l+"SearchTexSMAA.png",void 0,null,null,e.ImageUtils.crossOriginPolicy);return h.minFilter=e.NearestFilter,h.magFilter=e.NearestFilter,this.pass2.uniforms.searchTex.value=h,this.areaTexture=c,this.searchTexture=h,this},initEffect:function(e,t){t.insertComposer(this.composer,this.mixPass),this.composer.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composer)},update:function(e,t,i){},setSize:function(e,t){this._parent(e,t)&&(this.composer.setSize(this.width,this.height),this.pass1.uniforms.screenWidth.value=this.width,this.pass1.uniforms.screenHeight.value=this.height,this.pass2.uniforms.screenWidth.value=this.width,this.pass2.uniforms.screenHeight.value=this.height,this.mixPass.uniforms.screenWidth.value=this.width,this.mixPass.uniforms.screenHeight.value=this.height)},dispose:function(){this._parent(),this.areaTexture.dispose(),this.searchTexture.dispose()}})}),define("Effects/SMAAEffect",["DS/Effects/SMAAEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/SMAAEffect"),e}),define("DS/Shaders/ResizeShaders",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{Resize:{uniforms:{tDiffuse:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","}"].join("\n")}}}),define("ShadersDebug/ResizeShaders",["DS/Shaders/ResizeShaders","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("ShadersDebug/ResizeShaders"),e}),define("DS/Gestures/HoldTapGesture",["DS/Gestures/BasicGesture","DS/VisuEvents/ScreenEvent"],function(e,t){"use strict";var i=e.extend({init:function(){return this._parent("HoldTap"),this.priority=12,this.identifier_0=-1,this.identifier_1=-1,this._holdElapsedTime=0,this.maxDistance=10,this.maxTime=300,this},changeStateToKO:function(){this.clearStateVariable(),this.changeState(e.State.KO)},clearStateVariable:function(){this.identifier_0=-1,this.identifier_1=-1,this._holdElapsedTime=0},validateOkTapCondition:function(e){return null!==e&&(e.offsetPosition.length()<=this.maxDistance&&e.currentTime-e.startTime<=this.maxTime)},validateKoTapCondition:function(e){return null!==e&&(e.offsetPosition.length()>this.maxDistance||e.currentTime-e.startTime>this.maxTime)},detect:function(i){switch(this._parent(i),this.state){case e.State.INIT:var r=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE]);if(2===r.length){var n=-1;r[0].getState()==t.State.IDLE?n=0:r[1].getState()==t.State.IDLE&&(n=1),-1!==n&&r[n].getOffsetPosition().length()<this.maxDistance&&(r[1-n].getState()!=t.State.BEGIN&&r[1-n].getState()!=t.State.MOVE||(this.identifier_0=r[n].getIdentifier(),this.identifier_1=r[1-n].getIdentifier(),this.changeState(e.State.BEGIN)))}break;case e.State.BEGIN:if(2!==THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE,t.State.END]).length){this.changeStateToKO();break}var a=THREEDS.VisuEventsManager.getTouchEventById(this.identifier_0),s=THREEDS.VisuEventsManager.getTouchEventById(this.identifier_1);if(null===a||null===s){this.changeStateToKO();break}if(a.getState()===t.State.IDLE&&a.getOffsetPosition().length()<this.maxDistance){if(s.getState()===t.State.END&&this.validateOkTapCondition(s)){this._holdElapsedTime=s.currentTime-a.startTime,this.events=[a,s],this.changeState(e.State.OK);break}if(s.getState()==t.State.MOVE&&this.validateKoTapCondition(s)){this.changeStateToKO();break}}else if(a.getState()==t.State.END||t.State.BEGIN){this.changeStateToKO();break}break;case e.State.KO:case e.State.OK:case e.State.CANCEL:this.clearStateVariable(),this.changeState(e.State.INIT)}},getFirstTouchPosition:function(){return 2===this.getEvents().length?this.getEvents()[0].getCurrentPosition():null},getSecondTouchPosition:function(){return 2===this.getEvents().length?this.getEvents()[1].getCurrentPosition():null},getGestureStartTime:function(){return 2===this.getEvents().length?this.getEvents()[0].startTime:null},getHoldElapsedTime:function(){return this._holdElapsedTime},getTapElapsedTime:function(){return 2===this.getEvents().length?this.getEvents()[1].currentTime-this.getEvents()[1].startTime:null},getElapsedTime:function(){return 2===this.getEvents().length?this.getEvents()[1].currentTime-this.getEvents()[0].startTime:null}});return UWA.namespace("THREEDS/Gestures/HoldTapGesture",i)}),define("Gestures/HoldTapGesture",["DS/Gestures/HoldTapGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/HoldTapGesture"),e}),define("DS/Shaders/ESMBlurShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t,i,r,n={defines:{LEVEL:1},uniforms:{tDiffuse:{type:"t",value:null},invSize:{type:"v2",value:new e.Vector2(512,512)},radius:{type:"f",value:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D tDiffuse;","varying vec2 vUv;","float unpackDepth(sampler2D tex, vec2 uv){","   vec4 rgba_depth = texture2D(tex,uv);","   #ifdef USE_UINT_ESM","\t    float depth = unpackRGB( rgba_depth.xyz) * pow(10.0,rgba_depth.w*255.0);","\t    return depth;","   #else","       return rgba_depth.x;","   #endif","}","float unpackLerp(sampler2D shadowMap, vec2 coord) {","#ifdef USE_UINT_ESM","   vec2 fractCoord = fract(coord/invSize + 0.5);","   vec2 centroidUV = (coord/invSize - fractCoord) * invSize;","   float lb = unpackDepth(shadowMap, centroidUV);","   float lt = unpackDepth(shadowMap, centroidUV + vec2(0.0, invSize.y));","   float rb = unpackDepth(shadowMap, centroidUV + vec2(invSize.x, 0.0));","   float rt = unpackDepth(shadowMap, centroidUV + invSize);","   float a = mix(lb, lt, fractCoord.y);","   float b = mix(rb, rt, fractCoord.y);","   return mix(a, b, fractCoord.x);","#else","    return texture2D(shadowMap, coord).x;","#endif","}","vec4 packDepth(float depth){","   #ifdef USE_UINT_ESM","\tfloat exposant = ceil(log(depth)/log(10.0));","\tfloat normDepth = depth/pow(10.0,exposant);","\treturn vec4(packRGB(normDepth),exposant/255.0);","   #else","       return vec4(depth,0.0,0.0,1.0);","   #endif","}","void main() {","vec2 screenPos = vUv;","float result = 0.0;","float blurSize = invSize.y;","#if (LEVEL == 1)","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y - 1.2 * blurSize)) * 0.3125;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y)) * 0.375;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y + 1.2 * blurSize)) * 0.3125;","#endif","#if (LEVEL == 2)","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y - 1.285714285714 * blurSize)) * 0.328125;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y)) * 0.3125;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y + 1.285714285714 * blurSize)) * 0.328125;","#endif","#if (LEVEL == 3)","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y - 3.111111111111 * blurSize)) * 0.03515625;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y - 1.333333333333 * blurSize)) * 0.328125;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y)) * 0.2734375;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y + 1.333333333333 * blurSize)) * 0.328125;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y + 3.111111111111 * blurSize)) * 0.03515625;","#endif","#if (LEVEL == 4)","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y - 3.181818181818 * blurSize)) * 0.0537109375;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y - 1.363636363636 * blurSize)) * 0.322265625;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y)) * 0.24609375;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y + 1.363636363636 * blurSize)) * 0.322265625;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y + 3.181818181818 * blurSize)) * 0.0537109375;","#endif","#if (LEVEL == 5)","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y - 5.076923076923 * blurSize)) * 0.003173828125;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y - 3.230769230769 * blurSize)) * 0.06982421875;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y - 1.384615384615 * blurSize)) * 0.314208984375;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y)) * 0.2255859375;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y + 1.384615384615 * blurSize)) * 0.314208984375;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y + 3.230769230769 * blurSize)) * 0.06982421875;","result += unpackLerp(tDiffuse, vec2(vUv.x, vUv.y + 5.076923076923 * blurSize)) * 0.003173828125;","#endif","gl_FragColor = packDepth(result);","}"].join("\n")};return{BlurH2:(t=2,i="tDiffuse"+(t||""),r={defines:{LEVEL:1},uniforms:{invSize:{type:"v2",value:new e.Vector2(512,512)},radius:{type:"f",value:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 invSize;","uniform sampler2D "+i+";","varying vec2 vUv;","float unpackDepth(sampler2D tex, vec2 uv){","   vec4 rgba_depth = texture2D(tex,uv);","   #ifdef USE_UINT_ESM","\t    float depth = unpackRGB(rgba_depth.xyz) * pow(10.0,rgba_depth.w*255.0);","\t    return depth;","   #else","       return rgba_depth.x;","   #endif","}","float unpackLerp(sampler2D shadowMap, vec2 coord) {","#ifdef USE_UINT_ESM","   vec2 fractCoord = fract(coord/invSize + 0.5);","   vec2 centroidUV = (coord/invSize - fractCoord) * invSize;","   float lb = unpackDepth(shadowMap, centroidUV);","   float lt = unpackDepth(shadowMap, centroidUV + vec2(0.0, invSize.y));","   float rb = unpackDepth(shadowMap, centroidUV + vec2(invSize.x, 0.0));","   float rt = unpackDepth(shadowMap, centroidUV + invSize);","   float a = mix(lb, lt, fractCoord.y);","   float b = mix(rb, rt, fractCoord.y);","   return mix(a, b, fractCoord.x);","#else","    return texture2D(shadowMap, coord).x;","#endif","}","vec4 packDepth(float depth){","   #ifdef USE_UINT_ESM","\tfloat exposant = ceil(log(depth)/log(10.0));","\tfloat normDepth = depth/pow(10.0,exposant);","\treturn vec4(packRGB(normDepth),exposant/255.0);","   #else","       return vec4(depth,0.0,0.0,1.0);","   #endif","}","void main() {","vec2 screenPos = vUv;","float result = 0.0;","float blurSize = invSize.x;","#if (LEVEL == 1)","result += unpackLerp("+i+", vec2(vUv.x - 1.2 * blurSize, vUv.y)) * 0.3125;","result += unpackLerp("+i+", vec2(vUv.x, vUv.y)) * 0.375;","result += unpackLerp("+i+", vec2(vUv.x + 1.2 * blurSize, vUv.y)) * 0.3125;","#endif","#if (LEVEL == 2)","result += unpackLerp("+i+", vec2(vUv.x - 1.285714285714 * blurSize, vUv.y)) * 0.328125;","result += unpackLerp("+i+", vec2(vUv.x, vUv.y)) * 0.3125;","result += unpackLerp("+i+", vec2(vUv.x + 1.285714285714 * blurSize, vUv.y)) * 0.328125;","#endif","#if (LEVEL == 3)","result += unpackLerp("+i+", vec2(vUv.x - 3.111111111111 * blurSize, vUv.y)) * 0.03515625;","result += unpackLerp("+i+", vec2(vUv.x - 1.333333333333 * blurSize, vUv.y)) * 0.328125;","result += unpackLerp("+i+", vec2(vUv.x, vUv.y)) * 0.2734375;","result += unpackLerp("+i+", vec2(vUv.x + 1.333333333333 * blurSize, vUv.y)) * 0.328125;","result += unpackLerp("+i+", vec2(vUv.x + 3.111111111111 * blurSize, vUv.y)) * 0.03515625;","#endif","#if (LEVEL == 4)","result += unpackLerp("+i+", vec2(vUv.x - 3.181818181818 * blurSize, vUv.y)) * 0.0537109375;","result += unpackLerp("+i+", vec2(vUv.x - 1.363636363636 * blurSize, vUv.y)) * 0.322265625;","result += unpackLerp("+i+", vec2(vUv.x, vUv.y)) * 0.24609375;","result += unpackLerp("+i+", vec2(vUv.x + 1.363636363636 * blurSize, vUv.y)) * 0.322265625;","result += unpackLerp("+i+", vec2(vUv.x + 3.181818181818 * blurSize, vUv.y)) * 0.0537109375;","#endif","#if (LEVEL == 5)","result += unpackLerp("+i+", vec2(vUv.x - 5.076923076923 * blurSize, vUv.y)) * 0.003173828125;","result += unpackLerp("+i+", vec2(vUv.x - 3.230769230769 * blurSize, vUv.y)) * 0.06982421875;","result += unpackLerp("+i+", vec2(vUv.x - 1.384615384615 * blurSize, vUv.y)) * 0.314208984375;","result += unpackLerp("+i+", vec2(vUv.x, vUv.y)) * 0.2255859375;","result += unpackLerp("+i+", vec2(vUv.x + 1.384615384615 * blurSize, vUv.y)) * 0.314208984375;","result += unpackLerp("+i+", vec2(vUv.x + 3.230769230769 * blurSize, vUv.y)) * 0.06982421875;","result += unpackLerp("+i+", vec2(vUv.x + 5.076923076923 * blurSize, vUv.y)) * 0.003173828125;","#endif","gl_FragColor = packDepth(result);","}"].join("\n")},r.uniforms[i]={type:"t",value:null},r),BlurV:n}}),define("Shaders/ESMBlurShader",["DS/Shaders/ESMBlurShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/ESMBlurShader"),e}),define("DS/Gestures/SwipeGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("Swipe"),this.priority=10,this.touches=[],this.identifier=null,this.minDistance=5,this},detect:function(e){switch(this._parent(e),this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE,t.State.END]),this.state){case i.State.INIT:1===this.touches.length&&this.touches[0].isInView(this.view)&&this.changeState(i.State.BEGIN);break;case i.State.BEGIN:if(1===this.touches.length){var r=this.touches[0].getState()===t.State.END;if(this.touches[0].offsetPosition.length()>this.minDistance){var n=e[0].getJSEvent();!r&&n.preventDefault&&n.preventDefault(),this.events=this.touches,this.changeState(i.State.CHANGE)}else r&&this.changeState(i.State.INIT)}else this.changeState(i.State.KO);break;case i.State.CHANGE:if(1===this.touches.length){r=this.touches[0].getState()===t.State.END,n=e[0].getJSEvent();!r&&n.preventDefault&&n.preventDefault(),this.events=this.touches,this.changeState(i.State.CHANGE,r)}else if(2===this.touches.length){var a=this.touches[0].getState(),s=this.touches[1].getState();a===t.State.BEGIN||s===t.State.BEGIN?this.changeState(i.State.CHANGE,!0):this.changeState(i.State.KO)}else this.changeState(i.State.KO);break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT),this.touches=[]}},getSwipeOrigin:function(){var e;return this.getEvents().length>0&&(e=this.getEvents()[0].getStartPosition()),e},getSwipeVector:function(){if(this.getEvents().length>0){var e=this.getEvents()[0].getCurrentPosition();return e.sub(this.getEvents()[0].getStartPosition()),e}return null},getSwipeDuration:function(){return this.getEvents().length>0?this.getEvents()[0].currentTime-this.getEvents()[0].startTime:null}});return UWA.namespace("THREEDS/Gestures/SwipeGesture",r)}),define("Gestures/SwipeGesture",["DS/Gestures/SwipeGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/SwipeGesture"),e}),define("DS/Gestures/HoldDragGesture",["DS/Gestures/BasicGesture","DS/VisuEvents/ScreenEvent"],function(e,t){"use strict";var i=e.extend({init:function(){return this._parent(),this.priority=16,this.identifier_0=-1,this.identifier_1=-1,this._holdElapsedTime=0,this.maxDistance=10,this},changeStateToKO:function(){this.clearStateVariable(),this.changeState(e.State.KO)},clearStateVariable:function(){this.identifier_0=-1,this.identifier_1=-1,this._holdElapsedTime=0},detect:function(i){switch(this._parent(i),this.state){case e.State.INIT:var r=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE]);if(2===r.length){var n=-1;r[0].getState()==t.State.IDLE?n=0:r[1].getState()==t.State.IDLE&&(n=1),-1!==n&&r[n].getOffsetPosition().length()<this.maxDistance&&(r[1-n].getState()!=t.State.BEGIN&&r[1-n].getState()!=t.State.MOVE||(this.identifier_0=r[n].getIdentifier(),this.identifier_1=r[1-n].getIdentifier(),this.changeState(e.State.BEGIN)))}break;case e.State.BEGIN:if(2!==THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE]).length){this.changeStateToKO();break}var a=THREEDS.VisuEventsManager.getTouchEventById(this.identifier_0),s=THREEDS.VisuEventsManager.getTouchEventById(this.identifier_1);if(null===a||null===a){this.changeStateToKO();break}if(a.getState()==t.State.IDLE&&a.getOffsetPosition().length()<this.maxDistance){if(s.getState()===t.State.MOVE&&s.offsetPosition.length()>this.maxDistance){this._holdElapsedTime=s.currentTime-a.startTime,this.events=[a,s],this.changeState(e.State.CHANGE);break}}else this.changeStateToKO();break;case e.State.CHANGE:if(2!==THREEDS.VisuEventsManager.getTouchEvents().length){this.changeStateToKO();break}a=THREEDS.VisuEventsManager.getTouchEventById(this.identifier_0),s=THREEDS.VisuEventsManager.getTouchEventById(this.identifier_1);if(null===a||null===a){this.changeStateToKO();break}(a.getState()===t.State.IDLE||a.getState()===t.State.MOVE)&&a.getOffsetPosition().length()<this.maxDistance?s.getState()===t.State.MOVE?(this._holdElapsedTime=s.currentTime-a.startTime,this.events=[a,s],this.changeState(e.State.CHANGE)):s.getState()===t.State.END&&a.getState()===t.State.IDLE?(this.events=[a,s],this.changeState(e.State.BEGIN)):a.getState()===t.State.MOVE&&a.getOffsetPosition().length()<this.maxDistance?(this.events=[a,s],this.changeState(e.State.BEGIN)):this.changeStateToKO():this.changeStateToKO();break;case e.State.KO:case e.State.OK:case e.State.CANCEL:this.clearStateVariable(),this.changeState(e.State.INIT)}},getFirstTouchPosition:function(){return 2===this.getEvents().length?this.getEvents()[0].getCurrentPosition():null},getSecondTouchPosition:function(){return 2===this.getEvents().length?this.getEvents()[1].getCurrentPosition():null},getHoldTime:function(){return this._holdElapsedTime},getDragTime:function(){return 2===this.getEvents().length?this.getEvents()[1].currentTime-this.getEvents()[1].startTime:null},getDirectionFromOrigin:function(){return 2===this.getEvents().length?this.getEvents()[1].getOffsetPosition():null},getDistanceFromOrigin:function(){return 2===this.getEvents().length?this.getEvents()[1].getOffsetPosition().length():null},getTotalTraveledDistFromOrigin:function(){return 2===this.getEvents().length?this.getEvents()[1].getTraveledDistance():null},getLastTraveledVector:function(){return 2===this.getEvents().length?this.getEvents()[1].getDeltaPosition():null},getLastTraveledDistance:function(){return 2===this.getEvents().length?this.getEvents()[1].getDeltaPosition().length():null},getElapsedTime:function(){return 2===this.getEvents().length?this.getEvents()[1].currentTime-this.getEvents()[0].startTime:null}});return UWA.namespace("THREEDS/Gestures/HoldDragGesture",i)}),define("Gestures/HoldDragGesture",["DS/Gestures/HoldDragGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/HoldDragGesture"),e}),define("DS/Gestures/ReleaseGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("Release"),this.priority=0,this},detect:function(e){switch(this._parent(e),this.state){case i.State.INIT:var r=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.END],this.view);if(r.length)return this.events=r.slice(),void this.changeState(i.State.OK);break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/ReleaseGesture",r)}),define("Gestures/ReleaseGesture",["DS/Gestures/ReleaseGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/ReleaseGesture"),e}),define("DS/Plugins/PluginPass",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=function(e,t,i,r,n){this.scene=e,this.camera=t,this.name=i,this.cameraName="main",this.plugin=r,this.plugin.init(n),this.composer=null,this.stateSortingResults={}};return t.prototype={getDefaultState:function(){return{enabled:!1,renderPlugins:!1}},setCameraName:function(e){this.cameraName=e},setScene:function(e){this.scene=e},render:function(t,i,r,n,a,s,o,l,c){var h=o[l],u=null;this.stateSortingResults[s.id]?u=this.stateSortingResults[s.id]:((u=new e.StateSortingResult(this,-1)).init(),this.stateSortingResults[s.id]=u),t.doRenderPlugins([this.plugin],this.scene,h,r,u)},dispose:function(){this.plugin.dispose()}},t}),define("Plugins/PluginPass",["DS/Plugins/PluginPass","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Plugins/PluginPass"),e}),define("DS/Gestures/PinchGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=new e.Vector2,n=i.extend({init:function(){return this._parent("Pinch"),this.priority=10,this.touches=[],this.fingersVector=new e.Vector2,this.latencyTime=200,this.initTime=0,this.distance=null,this.lastDistance=0,this.initDistance=0,this.distanceMin=10,this.orientation=null,this.lastOrientation=0,this.deltaOrientation=0,this.initOrientation=0,this.orientationMax=.1,this.barycenter=null,this.lastBarycenter=new e.Vector2,this.initBarycenter=new e.Vector2,this.barycenterMax=10,this},detect:function(n){if(this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE,t.State.END],this.view),2===this.touches.length){var a=n[0].getJSEvent();a.preventDefault&&a.preventDefault(),this.fingersVector.subVectors(this.touches[1].currentPosition,this.touches[0].currentPosition),null===this.distance&&(this.distance=this.fingersVector.length()),null===this.orientation&&(this.orientation=Math.atan2(this.fingersVector.y,this.fingersVector.x)),null===this.barycenter&&(this.barycenter=new e.Vector2,this.barycenter.addVectors(this.touches[0].currentPosition,this.touches[1].currentPosition),this.barycenter.multiplyScalar(.5)),this.lastDistance=this.distance,this.distance=this.fingersVector.length(),this.lastOrientation=this.orientation,this.orientation=Math.atan2(this.fingersVector.y,this.fingersVector.x),this.deltaOrientation=this.orientation-this.lastOrientation;var s=this.deltaOrientation>=0?1:-1;s*=2*Math.PI,Math.abs(this.deltaOrientation-s)<Math.abs(this.deltaOrientation)&&(this.deltaOrientation-=s),this.lastBarycenter.copy(this.barycenter),this.barycenter.addVectors(this.touches[0].currentPosition,this.touches[1].currentPosition),this.barycenter.multiplyScalar(.5)}switch(this.state){case i.State.INIT:2===this.touches.length&&(this.initTime=(new Date).getTime(),this.initDistance=this.distance,this.initOrientation=this.orientation,this.initBarycenter.copy(this.barycenter),this.changeState(i.State.BEGIN));break;case i.State.BEGIN:if(2===THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE],this.view).length){var o=Math.abs(this.orientation-this.initOrientation);o=Math.min(o,Math.abs(o-2*Math.PI)),r.copy(this.initBarycenter),Math.abs(this.distance-this.initDistance)>this.distanceMin&&o<this.orientationMax&&(this.events=this.touches,this.changeState(i.State.CHANGE))}else this.changeState(i.State.KO);break;case i.State.CHANGE:if(2===this.touches.length){var l=this.touches[0].getState()===t.State.END||this.touches[1].getState()===t.State.END;this.events=this.touches,this.changeState(i.State.CHANGE,l)}else this.changeState(i.State.KO);break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT),this.touches=[],this.distance=null,this.orientation=null,this.barycenter=null}},getAngle:function(){return this.orientation||0},getDeltaAngle:function(){return this.deltaOrientation},getFirstTouchPosition:function(e){return 2===this.getEvents().length?this.getEvents()[0].getCurrentPosition():null},getSecondTouchPosition:function(e){return 2===this.getEvents().length?this.getEvents()[1].getCurrentPosition():null},getInitialDistance:function(e){var t=-1;if(2===this.getEvents().length){var i=this.getEvents()[1].getStartPosition();i.sub(this.getEvents()[0].getStartPosition()),t=i.length()}return t},getDistance:function(e){var t=-1;if(2===this.getEvents().length){var i=this.getEvents()[1].getCurrentPosition();i.sub(this.getEvents()[0].getCurrentPosition()),t=i.length()}return t}});return UWA.namespace("THREEDS/Gestures/PinchGesture",n)}),define("Gestures/PinchGesture",["DS/Gestures/PinchGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/PinchGesture"),e}),define("DS/Gestures/MouseWheelGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("MouseWheel"),this.priority=0,this.delta=0,this},detect:function(e){switch(this._parent(e),this.state){case i.State.INIT:var r=THREEDS.VisuEventsManager.getMouseEventsByStates([t.State.BEGIN],t.MouseButton.WHEEL,this.view);if(r.length){var n=r[0];return this.events=[n],this.delta=UWA.Event.wheelDelta(n.getJSEvent()),void this.changeState(i.State.OK)}break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/MouseWheelGesture",r)}),define("Gestures/MouseWheelGesture",["DS/Gestures/MouseWheelGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/MouseWheelGesture"),e}),define("DS/Gestures/KeyDownGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("KeyDown"),this.priority=0,this.key=0,this},detect:function(e){switch(this._parent(e),this.state){case i.State.INIT:for(var r=0;r<e.length;r++){var n=e[r];if(!n.view||!(n.view.tagName&&"input"===n.view.tagName.toLowerCase()||"true"===n.view.contentEditable)||n.isInView(this.view)){var a=n.getType(),s=n.getState();if("Keyboard"===a){var o=n.getKey();if(s===t.State.BEGIN)return this.events=[n],this.key=o,void this.changeState(i.State.OK)}}}break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/KeyDownGesture",r)}),define("Gestures/KeyDownGesture",["DS/Gestures/KeyDownGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/KeyDownGesture"),e}),define("DS/Gestures/RotateGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("Rotate"),this.priority=10,this.touches=[],this.fingersVector=new e.Vector2,this.latencyTime=200,this.initTime=0,this.distance=null,this.lastDistance=0,this.initDistance=0,this.distanceMax=10,this.orientation=null,this.lastOrientation=0,this.deltaOrientation=0,this.initOrientation=0,this.orientationMin=.1,this.barycenter=null,this.lastBarycenter=new e.Vector2,this.initBarycenter=new e.Vector2,this},detect:function(r){if(this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE,t.State.END],this.view),2===this.touches.length){var n=r[0].getJSEvent();n.preventDefault&&n.preventDefault(),this.fingersVector.subVectors(this.touches[1].currentPosition,this.touches[0].currentPosition),null===this.distance&&(this.distance=this.fingersVector.length()),null===this.orientation&&(this.orientation=Math.atan2(this.fingersVector.y,this.fingersVector.x)),null===this.barycenter&&(this.barycenter=new e.Vector2,this.barycenter.addVectors(this.touches[0].currentPosition,this.touches[1].currentPosition),this.barycenter.multiplyScalar(.5)),this.lastDistance=this.distance,this.distance=this.fingersVector.length(),this.lastOrientation=this.orientation,this.orientation=Math.atan2(this.fingersVector.y,this.fingersVector.x),this.deltaOrientation=this.orientation-this.lastOrientation;var a=this.deltaOrientation>=0?1:-1;a*=2*Math.PI,Math.abs(this.deltaOrientation-a)<Math.abs(this.deltaOrientation)&&(this.deltaOrientation-=a),this.lastBarycenter.copy(this.barycenter),this.barycenter.addVectors(this.touches[0].currentPosition,this.touches[1].currentPosition),this.barycenter.multiplyScalar(.5)}switch(this.state){case i.State.INIT:2===this.touches.length&&(this.initTime=(new Date).getTime(),this.initDistance=this.distance,this.initOrientation=this.orientation,this.initBarycenter.copy(this.barycenter),this.changeState(i.State.BEGIN));break;case i.State.BEGIN:if(2===THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE],this.view).length){var s=Math.abs(this.orientation-this.initOrientation);s=Math.min(s,Math.abs(s-2*Math.PI)),Math.abs(this.distance-this.initDistance)<this.distanceMax&&s>this.orientationMin&&(this.events=this.touches,this.changeState(i.State.CHANGE))}else this.changeState(i.State.KO);break;case i.State.CHANGE:if(2===this.touches.length){var o=this.touches[0].getState()===t.State.END||this.touches[1].getState()===t.State.END;this.events=this.touches,this.changeState(i.State.CHANGE,o)}else this.changeState(i.State.KO);break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT),this.touches=[],this.distance=null,this.orientation=null,this.barycenter=null}},getAngle:function(){return this.orientation||0},getDeltaAngle:function(){return this.deltaOrientation},getFirstTouchPosition:function(e){return 2===this.getEvents().length?this.getEvents()[0].getCurrentPosition():null},getSecondTouchPosition:function(e){return 2===this.getEvents().length?this.getEvents()[1].getCurrentPosition():null},getOriginDirection:function(e){if(2===this.getEvents().length){var t=this.getEvents()[1].getStartPosition();return t.sub(this.getEvents()[0].getStartPosition()),t}return null},getCurrentDirection:function(e){if(2===this.getEvents().length){var t=this.getEvents()[1].getCurrentPosition();return t.sub(this.getEvents()[0].getCurrentPosition()),t}return null},getLastDirection:function(e){if(2===this.getEvents().length){var t=this.getEvents()[1].getLastPosition();return t.sub(this.getEvents()[0].getLastPosition()),t}return null}});return UWA.namespace("THREEDS/Gestures/RotateGesture",r)}),define("Gestures/RotateGesture",["DS/Gestures/RotateGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/RotateGesture"),e}),define("DS/Gestures/PrimaryPointerDoubleClickGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(t){return this._parent("PrimaryPointerDoubleClick"),this.priority=100,this.currentTime=0,this.maxTime=300,this.maxDistance=15,this.lastClickTime=0,this.lastClickPosition=new e.Vector2,this},detect:function(e){this._parent(e);var t=this.gestures[0];if(t)switch(this.currentTime=(new Date).getTime(),this.state){case i.State.INIT:t.getState()===i.State.OK&&(this.lastClickTime=this.currentTime,this.lastClickPosition.copy(t.events[0].currentPosition),this.changeState(i.State.BEGIN));break;case i.State.BEGIN:t.getState()===i.State.OK&&(this.currentTime-this.lastClickTime<this.maxTime&&this.lastClickPosition.sub(t.events[0].currentPosition).length()<this.maxDistance?(this.events=t.getEvents(),this.changeState(i.State.OK)):(this.lastClickTime=this.currentTime,this.lastClickPosition.copy(t.events[0].currentPosition)));break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/PrimaryPointerDoubleClickGesture",r)}),define("Gestures/PrimaryPointerDoubleClickGesture",["DS/Gestures/PrimaryPointerDoubleClickGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/PrimaryPointerDoubleClickGesture"),e}),define("DS/Gestures/LongHoldStayGesture",["DS/Gestures/HoldStayGesture"],function(e){"use strict";var t=e.extend({init:function(){return this._parent(),this.priority=101,this.name="LongHoldStay",this.maxTime=THREEDS.VisuEventsManager.getLongHoldTime(),this},detect:function(e){this._parent(e)}});return UWA.namespace("THREEDS/Gestures/LongHoldStayGesture",t)}),define("Gestures/LongHoldStayGesture",["DS/Gestures/LongHoldStayGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/LongHoldStayGesture"),e}),define("DS/Gestures/PrimaryPointerUpUniqueGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent","DS/Gestures/BasicGesture"],function(e,t,i,r){"use strict";var n=r.extend({init:function(){return this._parent("PrimaryPointerUpUnique"),this.priority=10,this.identifier=null,this},detect:function(e){switch(this._parent(e),this.state){case r.State.INIT:var i=THREEDS.VisuEventsManager.getPrimaryPointerEventsByStates([t.State.END],this.view);if(1===i.length){var n=THREEDS.VisuEventsManager.getTouchEvents(),a=THREEDS.VisuEventsManager.getMouseEvents();n.length+a.length<=2&&(this.events=[i[0]],this.changeState(r.State.OK))}break;case r.State.KO:case r.State.OK:case r.State.CANCEL:this.identifier=null,this.changeState(r.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/PrimaryPointerUpUniqueGesture",n)}),define("Gestures/PrimaryPointerUpUniqueGesture",["DS/Gestures/PrimaryPointerUpUniqueGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/PrimaryPointerUpUniqueGesture"),e}),define("DS/Gestures/LongEditGesture",["DS/Gestures/EditGesture"],function(e){"use strict";var t=e.extend({init:function(){return this._parent(),this.priority=100,this.name="LongEdit",this.maxTimeTouch=1e3,this.maxTimeMouse=1e3,this},detect:function(e){this._parent(e)}});return UWA.namespace("THREEDS/Gestures/LongEditGesture",t)}),define("Gestures/LongEditGesture",["DS/Gestures/LongEditGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/LongEditGesture"),e}),define("DS/Gestures/TwoFingerTapGesture",["DS/Gestures/BasicGesture","DS/VisuEvents/ScreenEvent"],function(e,t){"use strict";var i=e.extend({init:function(){return this._parent("TwoFingerTap"),this.priority=14,this.identifier_0=null,this.identifier_1=null,this._remIdentifier=-1,this._isTwoFingersTapPossible=-1,this._firstTouchEvent=null,this.maxDistance=10,this.maxTime=300,this.maxTimeBetween=this.maxTime,this},changeStateToKO:function(){this.clearStateVariable(),this.changeState(e.State.KO)},clearStateVariable:function(){this._isTwoFingersTapPossible=-1,this._remIdentifier=-1,this.identifier_0=-1,this.identifier_1=-1},validateOkTapCondition:function(e){return null!==e&&(e.offsetPosition.length()<=this.maxDistance&&e.currentTime-e.startTime<=this.maxTime)},validateKoTapCondition:function(e){return null!==e&&(e.offsetPosition.length()>this.maxDistance||e.currentTime-e.startTime>this.maxTime)},detect:function(i){switch(this._parent(i),this.state){case e.State.INIT:var r=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE]);2===r.length&&(r[0].getState()!==t.State.BEGIN&&r[1].getState()!==t.State.BEGIN||(this.identifier_0=r[0].identifier,this.identifier_1=r[1].identifier,this.changeState(e.State.BEGIN)));break;case e.State.BEGIN:var n=THREEDS.VisuEventsManager.getTouchEvents();if(-1===this._isTwoFingersTapPossible){if(2!==n.length){this.changeStateToKO();break}var a=THREEDS.VisuEventsManager.getTouchEventById(this.identifier_0),s=THREEDS.VisuEventsManager.getTouchEventById(this.identifier_1);if(null===a||null===a){this.changeStateToKO();break}if(a.getState()===t.State.END&&this.validateOkTapCondition(a)){this._firstTouchEvent=a,this._remIdentifier=s.getIdentifier(),this._isTwoFingersTapPossible=1;break}if(s.getState()===t.State.END&&this.validateOkTapCondition(s)){this._firstTouchEvent=s,this._remIdentifier=a.getIdentifier(),this._isTwoFingersTapPossible=1;break}if(this.validateKoTapCondition(a)||this.validateKoTapCondition(s)){this.changeStateToKO();break}}else if(1===this._isTwoFingersTapPossible){if(n.length>1){this.changeStateToKO();break}var o=THREEDS.VisuEventsManager.getTouchEventById(this._remIdentifier);if(null===o){this.changeStateToKO();break}if(o.getState()===t.State.END&&this.validateOkTapCondition(o)&&o.currentTime-this._firstTouchEvent.currentTime<=this.maxTimeBetween){this.events=[this._firstTouchEvent,o],this.clearStateVariable(),this.changeState(e.State.OK);break}this.validateKoTapCondition(o)&&this.changeStateToKO()}break;case e.State.KO:case e.State.OK:case e.State.CANCEL:this.clearStateVariable(),this.changeState(e.State.INIT)}},getFirstTouchPosition:function(){return 2===this.getEvents().length?this.getEvents()[0].getCurrentPosition():null},getSecondTouchPosition:function(){return 2===this.getEvents().length?this.getEvents()[1].getCurrentPosition():null}});return UWA.namespace("THREEDS/Gestures/TwoFingerTapGesture",i)}),define("Gestures/TwoFingerTapGesture",["DS/Gestures/TwoFingerTapGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/TwoFingerTapGesture"),e}),define("DS/Gestures/ClickDownGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(i){return this._parent(t.printMouseButton(i)+"ClickDown"),this.priority=100,this.button=i,this.currentTime=0,this.maxTime=300,this.maxDistance=15,this.lastClickTime=0,this.lastClickPosition=new e.Vector2,this},detect:function(e){this._parent(e);var r=THREEDS.VisuEventsManager.getMouseEvents(null,this.view),n=this.gestures[0];if(this.state!==i.State.INIT||n)switch(this.currentTime=(new Date).getTime(),this.state){case i.State.INIT:n.getState()===i.State.OK&&(this.lastClickTime=this.currentTime,this.lastClickPosition.copy(n.events[0].currentPosition),this.changeState(i.State.BEGIN));break;case i.State.BEGIN:for(var a=0;a<r.length;a++){var s=r[a];if(s.button===this.button)return void(s.state===t.State.BEGIN&&this.currentTime-this.lastClickTime<this.maxTime&&this.lastClickPosition.sub(s.currentPosition).length()<this.maxDistance?this.changeState(i.State.OK):this.changeState(i.State.KO))}break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/ClickDownGesture",r)}),define("Gestures/ClickDownGesture",["DS/Gestures/ClickDownGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/ClickDownGesture"),e}),define("DS/Shaders/PreComputeSDFFontIterativeShaders",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t={defines:{},uniforms:{tDiffuse:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","float dist = texture2D(tDiffuse, vUv).r;","gl_FragColor = vec4(vec3(mod(10.0*dist, 1.0)), 1.0);","}"].join("\n")},i={defines:{},uniforms:{prevMap:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D prevMap;","varying vec2 vUv;","void main() {","vec4 texel = texture2D(prevMap, vUv);","float diff = length(texel.rg) - length(texel.ba);","diff = clamp(20.0 * diff, -1.0, 1.0);","float toto = clamp(0.5 * diff + 0.5, 0.0, 1.0);","gl_FragColor = vec4(vec3(toto), 1.0);","}"].join("\n")},r={defines:{},uniforms:{textureSize:{type:"v2",value:new e.Vector2(256,256)},invSize:{type:"v2",value:new e.Vector2(1/256,1/256)},tDiffuse:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["/*#extension GL_OES_standard_derivatives : enable*/","uniform sampler2D tDiffuse;","uniform vec2 textureSize;","uniform vec2 invSize;","varying vec2 vUv;","float aastep (float threshold , float value) {","float afwidth = 0.7 * length ( vec2(dFdx(value), dFdy(value)));","return smoothstep (threshold - afwidth, threshold + afwidth, value);","}","void main() {","vec2 uv = vUv * textureSize;","vec2 uv00 = floor(uv - vec2(0.5));","vec2 uvlerp = uv - uv00 - vec2(0.5);","vec2 st00 = (uv00 + vec2(0.5)) * invSize;","vec4 D00 = texture2D(tDiffuse, st00);","vec4 D10 = texture2D(tDiffuse, st00 + vec2(invSize.x, 0.0));","vec4 D01 = texture2D(tDiffuse, st00 + vec2(0.0, invSize.y));","vec4 D11 = texture2D(tDiffuse, st00 + vec2(invSize.x, invSize.y));","vec2 D00_10 = vec2(D00.r, D10.r)*255.0-128.0 + vec2(D00.g, D10.g)*(255.0/256.0);","vec2 D01_11 = vec2(D01.r, D11.r)*255.0-128.0 + vec2(D01.g, D11.g)*(255.0/256.0);","vec2 D0_1 = mix(D00_10, D01_11, uvlerp.y);","float D = mix(D0_1.x, D0_1.y, uvlerp.x);","float g = aastep(0.0, D);","gl_FragColor = vec4(vec3(g), 1.0);","}"].join("\n")},n={defines:{},uniforms:{prevMap:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D prevMap;","varying vec2 vUv;","void main() {","float texel = texture2D(prevMap, vUv).r;","gl_FragColor = vec4(texel > 0.99999 ? vec2(9999.0) : vec2(0.0), texel > 0.99999 ? vec2(0.0) : vec2(9999.0));","}"].join("\n")},a={defines:{},uniforms:{invSize:{type:"v2",value:new e.Vector2(1/256,1/256)},prevMap:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D prevMap;","uniform vec2 invSize;","varying vec2 vUv;","void ComputeDistance(vec2 uv, vec2 offset, inout vec4 bestseed) {","vec2 newvec = uv + offset;","vec4 newseed = texture2D(prevMap, newvec);","if (newvec.x >= 0.0 && newvec.x <= 1.0 && newvec.y >= 0.0 && newvec.y <= 1.0) {","newseed.rg += offset;","newseed.ba += offset;","if (length(newseed.rg) < length(bestseed.rg)) {","bestseed.rg = newseed.rg;","}","if (length(newseed.ba) < length(bestseed.ba)) {","bestseed.ba = newseed.ba;","}","}","}","void main() {","vec4 bestseed = texture2D(prevMap, vUv);","ComputeDistance(vUv, vec2(-invSize.x, -invSize.y), bestseed);","ComputeDistance(vUv, vec2(-invSize.x,        0.0), bestseed);","ComputeDistance(vUv, vec2(-invSize.x,  invSize.y), bestseed);","ComputeDistance(vUv, vec2(0.0, -invSize.y),        bestseed);","ComputeDistance(vUv, vec2(0.0,  invSize.y),        bestseed);","ComputeDistance(vUv, vec2(invSize.x, -invSize.y), bestseed);","ComputeDistance(vUv, vec2(invSize.x,        0.0), bestseed);","ComputeDistance(vUv, vec2(invSize.x,  invSize.y), bestseed);","gl_FragColor = bestseed;","}"].join("\n")},s={defines:{},uniforms:{tDiffuse1:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse1;","varying vec2 vUv;","void main() {","vec4 texel = texture2D(tDiffuse1, vUv);","gl_FragColor = vec4(texel);","}"].join("\n")},o={uniforms:{tDiffuse2:{type:"t",value:null},tileMin:{type:"v2",value:new e.Vector2(0,0)},tileMax:{type:"v2",value:new e.Vector2(64,64)},realTileMax:{type:"v2",value:new e.Vector2(64,64)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform vec2 tileMin;","uniform vec2 tileMax;","uniform vec2 realTileMax;","uniform sampler2D tDiffuse2;","varying vec2 vUv;","void main() {","vec2 uv = vUv;","if (uv.x < tileMin.x) { discard; }","vec2 tiledUV = (uv - tileMin) / (tileMax - tileMin);","tiledUV.y = 1.0 - tiledUV.y;","gl_FragColor = texture2D(tDiffuse2, tiledUV);","}"].join("\n")};return{ComputeSDFFont:{defines:{},uniforms:{prevMap:{type:"t",value:null},invSize:{type:"v2",value:new e.Vector2(1/256,1/256)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["const float SQRT2 = 1.41421356;","uniform sampler2D prevMap;","uniform vec2 invSize;","varying vec2 vUv;","void main() {","#if defined(OUTSIDE)","float value = texture2D(prevMap, vUv).r;","#else","float value = texture2D(prevMap, vUv).r;","#endif","float qv = invSize.x;","float qd = SQRT2 * invSize.x;","#if defined(OUTSIDE)","float lValue  = texture2D(prevMap, vec2(vUv.x - invSize.x, vUv.y)).r + qv;","float rValue  = texture2D(prevMap, vec2(vUv.x + invSize.x, vUv.y)).r + qv;","float bValue  = texture2D(prevMap, vec2(vUv.x, vUv.y - invSize.y)).r + qv;","float tValue  = texture2D(prevMap, vec2(vUv.x, vUv.y + invSize.y)).r + qv;","float tlValue = texture2D(prevMap, vec2(vUv.x - invSize.x, vUv.y + invSize.y)).r + qd;","float trValue = texture2D(prevMap, vec2(vUv.x + invSize.x, vUv.y + invSize.y)).r + qd;","float blValue = texture2D(prevMap, vec2(vUv.x - invSize.x, vUv.y - invSize.y)).r + qd;","float brValue = texture2D(prevMap, vec2(vUv.x + invSize.x, vUv.y - invSize.y)).r + qd;","if (vUv.x - invSize.x > 0.0) { value = min(lValue, value); }","if (vUv.x + invSize.x < 1.0) { value = min(rValue, value); }","if (vUv.y - invSize.y > 0.0) { value = min(bValue, value); }","if (vUv.y + invSize.y < 1.0) { value = min(tValue, value); }","if (vUv.x - invSize.x > 0.0 && vUv.y + invSize.y < 1.0) { value = min(tlValue, value); }","if (vUv.x + invSize.x < 1.0 && vUv.y + invSize.y < 1.0) { value = min(trValue, value); }","if (vUv.x - invSize.x > 0.0 && vUv.y - invSize.y > 0.0) { value = min(blValue, value); }","if (vUv.x + invSize.x < 1.0 && vUv.y - invSize.y > 0.0) { value = min(brValue, value); }","#else","float lValue  = mix(1.0, texture2D(prevMap, vec2(vUv.x - invSize.x, vUv.y)).r + qv, inScreen4.x);","float rValue  = mix(1.0, texture2D(prevMap, vec2(vUv.x + invSize.x, vUv.y)).r + qv, inScreen4.y);","float bValue  = mix(1.0, texture2D(prevMap, vec2(vUv.x, vUv.y - invSize.y)).r + qv, inScreen4.z);","float tValue  = mix(1.0, texture2D(prevMap, vec2(vUv.x, vUv.y + invSize.y)).r + qv, inScreen4.w);","float tlValue = mix(1.0, texture2D(prevMap, vec2(vUv.x - invSize.x, vUv.y + invSize.y)).r + qd, inScreen4.x * inScreen4.w);","float trValue = mix(1.0, texture2D(prevMap, vec2(vUv.x + invSize.x, vUv.y + invSize.y)).r + qd, inScreen4.y * inScreen4.w);","float blValue = mix(1.0, texture2D(prevMap, vec2(vUv.x - invSize.x, vUv.y - invSize.y)).r + qd, inScreen4.x * inScreen4.z);","float brValue = mix(1.0, texture2D(prevMap, vec2(vUv.x + invSize.x, vUv.y - invSize.y)).r + qd, inScreen4.y * inScreen4.z);","#endif","gl_FragColor = vec4(vec3(value), 1.0);","}"].join("\n")},ComputeSDFFontSeed:n,ComputeSDFFontFlood:a,ComputeSDFFontDisplay:t,ComputeSDFFontDisplayResult:r,ComputeSDFFontMerge:i,Nothing:s,MergeTiles:o}}),define("DS/Shaders/AutoExposureShaders",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{WeightedLuminance:{defines:{},uniforms:{tDiffuse2:{type:"t",value:null},tWeight:{type:"t",value:null},clampMin:{type:"f",value:-10},clampMax:{type:"f",value:20}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse2;","uniform float clampMin;","uniform float clampMax;","#if defined(USE_WEIGHT_TEXTURE)","uniform sampler2D tWeight;","#endif","varying vec2 vUv;","   float luminance(vec3 iColor) {","\t\tvec3 luminance_weight=vec3(0.176204,0.812985,0.0108109);","\t\treturn dot(iColor,luminance_weight);","\t}","void main() {","    vec4 color = texture2D( tDiffuse2, vUv );","    float weight = 1.0;","#if defined(USE_WEIGHT_TEXTURE)","\t weight = texture2D( tWeight, vUv ).r;","#endif","float value = weight * clamp(log(luminance(color.xyz)),clampMin,clampMax);","gl_FragColor = vec4(value,weight,0.0, 1.0);","}"].join("\n")},PixelSum:{uniforms:{tDiffuse:{type:"t",value:null},tDiffuseSize:{type:"v2",value:null},currentSize:{type:"v2",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 tDiffuseSize;","uniform vec2 currentSize;","varying vec2 vUv;","void main() {","vec2 currentPixel = floor(vUv*currentSize);","vec2 sums = vec2(0.0);","vec2 loopSize = vec2(float(LOOP_SIZE_X),float(LOOP_SIZE_Y));","vec2 uvDiffuse = (0.5+currentPixel*loopSize)/tDiffuseSize;","vec2 currUv;","if(currentPixel.x<(currentSize.x-1.0)){","for(int i=0;i<LOOP_SIZE_X;i++){","currUv = uvDiffuse + vec2(float(i)/tDiffuseSize.x,0.0);","if(currentPixel.y<(currentSize.y-1.0)){","for(int j=0;j<LOOP_SIZE_Y;j++){","currUv.y += 1.0/tDiffuseSize.y;","sums+=texture2D(tDiffuse,currUv).rg;","}","}else{","for(int j=0;j<LOOP_SIZE_Y_FINAL;j++){","currUv.y += 1.0/tDiffuseSize.y;","sums+=texture2D(tDiffuse,currUv).rg;","}","}","}","}else{","for(int i=0;i<LOOP_SIZE_X_FINAL;i++){","currUv = uvDiffuse + vec2(float(i)/tDiffuseSize.x,0.0);","if(currentPixel.y<(currentSize.y-1.0)){","for(int j=0;j<LOOP_SIZE_Y;j++){","currUv.y += 1.0/tDiffuseSize.y;","sums+=texture2D(tDiffuse,currUv).rg;","}","}else{","for(int j=0;j<LOOP_SIZE_Y_FINAL;j++){","currUv.y += 1.0/tDiffuseSize.y;","sums+=texture2D(tDiffuse,currUv).rg;","}","}","}","}","    gl_FragColor = vec4(sums, 0.0, 1.0);","}"].join("\n")}}}),define("Shaders/AutoExposureShaders",["DS/Shaders/AutoExposureShaders","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/AutoExposureShaders"),e}),define("DS/Gestures/TapGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("Tap"),this.priority=10,this.identifier=null,this.maxTime=300,this.maxDistance=10,this},detect:function(e){switch(this._parent(e),this.state){case i.State.INIT:1===(r=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE])).length&&1===(r=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN],this.view)).length&&(this.identifier=r[0].identifier,this.changeState(i.State.BEGIN));break;case i.State.BEGIN:var r;if((r=THREEDS.VisuEventsManager.getTouchEvents()).length>1)return;var n=THREEDS.VisuEventsManager.getTouchEventById(this.identifier);null===n?this.changeState(i.State.KO):n.state===t.State.MOVE?(n.offsetPosition.length()>this.maxDistance||n.currentTime-n.startTime>this.maxTime)&&this.changeState(i.State.KO):n.state===t.State.END&&(n.offsetPosition.length()>this.maxDistance||n.currentTime-n.startTime>this.maxTime?this.changeState(i.State.KO):(this.events=[n],this.changeState(i.State.OK)));break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}},getTouchPoint:function(){return this.getEvents().length>0?this.getEvents()[0].getCurrentPosition():null}});return UWA.namespace("THREEDS/Gestures/TapGesture",r)}),define("Gestures/TapGesture",["DS/Gestures/TapGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/TapGesture"),e}),define("DS/Shaders/FlareShaders",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{FinalBlending:{uniforms:{tDiffuse:{type:"t",value:null},tBlur:{type:"t",value:null},tLensColor:{type:"t",value:null},tLensDirt:{type:"t",value:null},invSize:{type:"v2",value:new e.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tBlur;","uniform sampler2D tLensColor;","uniform sampler2D tLensDirt;","uniform vec2 invSize;","const float ghostDispersal = 0.25;","const int ghosts = 8;","const float distortion = 5.0;","const float haloWidth = 1.0;","const float one_over_sqrt2 = 0.70710678;","varying vec2 vUv;","vec4 textureDistorted(sampler2D tex, vec2 texcoord, vec2 direction, vec3 distortion) {","   return vec4(","      texture2D(tex, texcoord + direction * distortion.r).r,","      texture2D(tex, texcoord + direction * distortion.g).g,","      texture2D(tex, texcoord + direction * distortion.b).b,","      1.0","   );","}","void main() {","   vec4 color = texture2D( tDiffuse, vUv );","   vec2 flippedUV = vec2(1.0) - vUv;","   vec2 uvToCenter = vec2(0.5) - flippedUV;","   vec3 distort = vec3(-invSize.x * distortion, 0.0, invSize.x * distortion);","   vec2 ghostVec = uvToCenter * ghostDispersal;","   vec4 flare = vec4(0.0);","   for (int i = 0; i < ghosts; ++i) {","      vec2 offset = fract(flippedUV + ghostVec * float(i));","      float ghostHeight = length(vec2(0.5) - offset) / one_over_sqrt2;","      ghostHeight = pow(1.0 - ghostHeight, 10.0);","      flare += textureDistorted(tBlur, offset, normalize(ghostVec), distort) * ghostHeight;","   }","   flare *= texture2D(tLensColor, vec2(length(uvToCenter) / one_over_sqrt2, 0.5));","   float dirt = texture2D( tLensDirt, vUv ).r;","   flare *= vec4(0.5) + dirt;","   gl_FragColor = vec4(color.rgb + flare.rgb, color.a);","}"].join("\n")}}}),define("Shaders/FlareShaders",["DS/Shaders/FlareShaders","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/FlareShaders"),e}),define("DS/Effects/FlareEffect",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/BloomShaders","DS/Shaders/FlareShaders"],function(e,t,i,r,n,a,s){"use strict";return i.extend({init:function(i,o){this._parent(i),this.threshold=1,this.passThreshold,this.passBlurH,this.passBlurV,this.passThreshold=new n(a.Threshold);var l;l=new t.WebGLRenderTargetProperties(.5*this.width,.5*this.height,"uint"),this.composers[0]=new r(i,l,o),this.passBlurH=new n(a.BlurH),this.passBlurV=new n(a.BlurV),this.composers[0].addPass(this.passThreshold),this.composers[0].addPass(this.passBlurH),this.composers[0].addPass(this.passBlurV),this.passThreshold.uniforms.threshold.value=this.threshold,this.mixPass=new n(s.FinalBlending,void 0,"FlareEffect");var c=e.getWebappsAssetUrl("Effects",""),h=new t.ImageUtils.loadTexture(c+"lenscolor.png",void 0,null,null,t.ImageUtils.crossOriginPolicy);h.minFilter=t.LinearFilter,h.magFilter=t.LinearFilter;var u=new t.ImageUtils.loadTexture(c+"lensdirt.png",void 0,null,null,t.ImageUtils.crossOriginPolicy);return u.minFilter=t.LinearFilter,u.magFilter=t.LinearFilter,this.mixPass.uniforms.tLensColor.value=h,this.mixPass.uniforms.tLensDirt.value=u,this},initEffect:function(e,t){t.getComposer("result").linkToShaderPassUniform(this.passThreshold,this.passThreshold.uniforms.tDiffuse2),t.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tBlur),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,t,i){},setSize:function(e,t){if(this._parent(e,t)){this.composers[0].setSize(.5*this.width,.5*this.height),this.passBlurH.uniforms.invSize.value.set(1/(.5*this.width),1/(.5*this.height)),this.passBlurV.uniforms.invSize.value.set(1/(.5*this.width),1/(.5*this.height)),this.mixPass.uniforms.invSize.value.set(1/(.5*this.width),1/(.5*this.height))}}})}),define("Effects/FlareEffect",["DS/Effects/FlareEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/FlareEffect"),e}),define("DS/Shaders/MultiplicativeBlendShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{defines:{POSTPRO:1},uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tNormalDepthIoRRoughness:{type:"t",value:null},strength:{type:"f",value:.5},contrast:{type:"f",value:2},power:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#if (POSTPRO == 1)","uniform sampler2D tDiffuse;","#endif","#if defined(SSAO) && defined(SSLREFRACTION_ENABLED)","#define REFRACTION_SKIP","uniform sampler2D tNormalDepthIoRRoughness;","#endif","uniform sampler2D tDiffuse2;","uniform float strength;","uniform float contrast;","uniform float power;","varying vec2 vUv;","void main() {","float occ = 1.0 - texture2D(tDiffuse2, vUv).x;","occ = clamp(1.0 - occ * contrast, 0.0, 1.0);","occ = pow(occ, power);","#ifdef REFRACTION_SKIP","if (texture2D(tNormalDepthIoRRoughness, vUv).y > 0.5) {","occ = 1.0;","}","#endif","#if (POSTPRO == 1)","vec4 color = texture2D(tDiffuse, vUv);","gl_FragColor = vec4(color.xyz * occ, color.a);","#else","gl_FragColor = vec4(vec3(0.0), 1.0 - sqrt(occ));","#endif","}"].join("\n")}}),define("Shaders/MultiplicativeBlendShader",["DS/Shaders/MultiplicativeBlendShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/MultiplicativeBlendShader"),e}),define("DS/Shaders/OITShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{SolveAndBlendShader:{defines:{POSTPRO:1},uniforms:{tOpaque:{type:"t",value:null},tAccum:{type:"t",value:null},tReveal:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","   vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#if (POSTPRO == 1)","uniform sampler2D tOpaque;","#endif","uniform sampler2D tReveal;","uniform sampler2D tAccum;","const float inf = 1e6;","bool _isinf(float n){","   return abs(n) == inf;","}","const float threshold = 1e-6;","varying vec2 vUv;","float maxComponent(vec4 iVector) {","   return max(iVector.r,max(iVector.g,max(iVector.b,iVector.a)));","}","void main() {","#if (POSTPRO == 1)","vec4 opaque = texture2D(tOpaque, vUv);","#else","vec4 opaque = vec4(0.0);","#endif","   float reveal = texture2D(tReveal, vUv).r;","   if (reveal > 1.0 - threshold) {","       gl_FragColor = opaque;","       return;","   }","   vec4 accum = texture2D(tAccum, vUv);","   if (_isinf(maxComponent(abs(accum)))){","       accum.rgb = vec3(max(accum.a,threshold));","   }","   vec3 avgCol = accum.rgb / max(accum.a,threshold);","#if (POSTPRO == 1)","   gl_FragColor = vec4(avgCol * (1.0 - reveal) + reveal * opaque.rgb, 1.0 - reveal + opaque.a * reveal);","#else","   gl_FragColor = vec4(avgCol, 1.0 - reveal);","#endif","}"].join("\n")},SolveShader:{uniforms:{tAccum:{type:"t",value:null},tReveal:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","   vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tReveal;","uniform sampler2D tAccum;","const float inf = 1e6;","bool _isinf(float n){","   return abs(n) == inf;","}","const float threshold = 1e-6;","varying vec2 vUv;","float maxComponent(vec4 iVector) {","   return max(iVector.r,max(iVector.g,max(iVector.b,iVector.a)));","}","void main() {","vec4 opaque = vec4(0.0);","   float reveal = texture2D(tReveal, vUv).r;","   if (reveal > 1.0 - threshold) {","       gl_FragColor = opaque;","       return;","   }","   vec4 accum = texture2D(tAccum, vUv);","   if (_isinf(maxComponent(abs(accum)))){","       accum.rgb = vec3(max(accum.a,threshold));","   }","   vec3 avgCol = accum.rgb / max(accum.a,threshold);","   gl_FragColor = vec4(avgCol, 1.0 - reveal);","}"].join("\n")},BlendShader:{uniforms:{tTransparents:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","   vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tTransparents;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D(tTransparents, vUv);","}"].join("\n")}}}),define("Shaders/OITShader",["DS/Shaders/OITShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/OITShader"),e}),define("DS/Gestures/PanGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=new e.Vector2,n=i.extend({init:function(){return this._parent("Pan"),this.priority=10,this.touches=[],this.fingersVector=new e.Vector2,this.latencyTime=200,this.initTime=0,this.distance=null,this.lastDistance=0,this.initDistance=0,this.distanceMax=10,this.orientation=null,this.lastOrientation=0,this.initOrientation=0,this.orientationMax=.1,this.barycenter=null,this.lastBarycenter=new e.Vector2,this.initBarycenter=new e.Vector2,this.barycenterMin=10,this},detect:function(n){if(this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE,t.State.END],this.view),2===this.touches.length){var a=n[0].getJSEvent();a.preventDefault&&a.preventDefault(),this.fingersVector.subVectors(this.touches[1].currentPosition,this.touches[0].currentPosition),null===this.distance&&(this.distance=this.fingersVector.length()),null===this.orientation&&(this.orientation=Math.acos(Math.min(Math.max((this.touches[1].currentPosition.x-this.touches[0].currentPosition.x)/this.distance,-1),1))),null===this.barycenter&&(this.barycenter=new e.Vector2,this.barycenter.addVectors(this.touches[0].currentPosition,this.touches[1].currentPosition),this.barycenter.multiplyScalar(.5)),this.lastDistance=this.distance,this.distance=this.fingersVector.length(),this.lastOrientation=this.orientation,this.orientation=Math.acos(Math.min(Math.max((this.touches[1].currentPosition.x-this.touches[0].currentPosition.x)/this.distance,-1),1)),this.lastBarycenter.copy(this.barycenter),this.barycenter.addVectors(this.touches[0].currentPosition,this.touches[1].currentPosition),this.barycenter.multiplyScalar(.5)}switch(this.state){case i.State.INIT:2===this.touches.length&&(this.initTime=(new Date).getTime(),this.initDistance=this.distance,this.initOrientation=this.orientation,this.initBarycenter.copy(this.barycenter),this.changeState(i.State.BEGIN));break;case i.State.BEGIN:2===THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE],this.view).length?(r.copy(this.initBarycenter),Math.abs(this.distance-this.initDistance)<this.distanceMax&&Math.abs(this.orientation-this.initOrientation)<this.orientationMax&&r.sub(this.barycenter).length()>this.barycenterMin&&(this.events=this.touches,this.changeState(i.State.CHANGE))):this.changeState(i.State.KO);break;case i.State.CHANGE:if(2===this.touches.length){var s=this.touches[0].getState()===t.State.END||this.touches[1].getState()===t.State.END;this.events=this.touches,this.changeState(i.State.CHANGE,s)}else this.changeState(i.State.KO);break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT),this.touches=[],this.distance=null,this.orientation=null,this.barycenter=null}},getFirstTouchPosition:function(e){return 2===this.getEvents().length?this.getEvents()[0].getCurrentPosition():null},getSecondTouchPosition:function(e){return 2===this.getEvents().length?this.getEvents()[1].getCurrentPosition():null},getDistanceFromOrigin:function(){if(this.getEvents().length>0){var e=this.getEvents()[0].getCurrentPosition();return e.sub(this.getEvents()[0].getStartPosition()),e.length()}return null},getLastTraveledDistance:function(){if(this.getEvents().length>0){var e=this.getEvents()[0].getCurrentPosition();return e.sub(this.getEvents()[0].getLastPosition()),e.length()}return null},getTotalTraveledDistFromOrigin:function(){return this.getEvents().length>0?this.getEvents()[0].getTraveledDistance():null},getLastTraveledVector:function(){if(this.getEvents().length>0){var e=this.getEvents()[0]._currentPosition.clone();return e.sub(this.getEvents()[0]._lastPosition),e}return null},getDirectionFromOrigin:function(){if(this.getEvents().length>0){var e=this.getEvents()[0]._currentPosition.clone();return e.sub(this.getEvents()[0]._startPosition),e}return null}});return UWA.namespace("THREEDS/Gestures/PanGesture",n)}),define("Gestures/PanGesture",["DS/Gestures/PanGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/PanGesture"),e}),define("DS/Effects/OITEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ComposerContext","DS/Plugins/EffectComposer","DS/Plugins/ClearPass","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/OITShader","DS/Shaders/FXAAShader"],function(e,t,i,r,n,a,s,o,l){"use strict";return t.extend({init:function(t,i,n,a){this._parent(t),this.stateSortingResultFrom=n,this.rtPool=i,this.name=a;var s=new e.WebGLRenderTargetProperties(this.width,this.height,"oitAccumLinear");s.generateMipmaps=!1;var o=new e.WebGLRenderTargetProperties(this.width,this.height,"oitRevealLinear");return o.generateMipmaps=!1,this.composerAccum=new r(t,s,i),this.composerAccum.needsCameraUpdate=!0,this.composerAccum.composerContext.name=a+"AccumComposerContext",this.composers.push(this.composerAccum),this.composerReveal=new r(t,o,i),this.composerReveal.needsCameraUpdate=!0,this.composerReveal.composerContext.name=a+"RevealComposerContext",this.composers.push(this.composerReveal),this.mixPass=null,this.clearAccumPass=null,this.accumPass=null,this.clearRevealPass=null,this.revealPass=null,this.fxaaPass=null,this.idString=null,this},initEffect:function(t,i){var r=function(e){return!e.canOIT},l=this.name;this.rtPool;t?(this.mixPass=new s(o.SolveAndBlendShader,void 0,l),this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0,this.mixPass.material.depthTest=!1,this.mixPass.compileShader(this.renderer),this.composerAccum.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tAccum),this.composerReveal.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tReveal),this.mixPass.addRequiredComposer(this.composerAccum),this.mixPass.addRequiredComposer(this.composerReveal),r=null):(this.mixPass=new s(o.SolveAndBlendShader,"tOpaque",l),this.mixPass.compileShader(this.renderer),this.composerAccum.bShareDepth=!0,this.composerReveal.bShareDepth=!0,this.composerAccum.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tAccum),this.composerReveal.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tReveal),this.mixPass.addRequiredComposer(this.composerAccum),this.mixPass.addRequiredComposer(this.composerReveal)),this.clearAccumPass=new n(l+"ClearAccum"),this.clearAccumPass.clearColor=new e.Color(0),this.clearAccumPass.clearbColor=!0,this.clearAccumPass.clear=!1,this.clearAccumPass.clearDepth=t,this.clearAccumPass.defaults.clear=!1,this.clearAccumPass.defaults.doClearDepth=t,this.clearAccumPass.clearAlpha=0,this.clearAccumPass.disabledByDefault=!0,this.clearAccumPass.idString=this.idString,this.accumPass=new a(i.scene,null,null,null,null,null,l+"Accum"),this.accumPass.setStateSortingResultFrom(this.stateSortingResultFrom,!1),this.accumPass.isOITPass=!0,this.accumPass.setMaterialToUse(e.MaterialToUse.oitAccumMaterial),this.accumPass.setDLsToDisableFunc(r),this.accumPass.disabledByDefault=!0,this.accumPass.setDisableBackFaceCulling(!1),this.accumPass.idString=this.idString,this.composerAccum.addPass(this.clearAccumPass),this.composerAccum.addPass(this.accumPass),this.composerAccum.enablePass(this.clearAccumPass,!0),this.composerAccum.enablePass(this.accumPass,!0),this.clearRevealPass=new n(l+"ClearReveal"),this.clearRevealPass.clearColor=new e.Color(16711680),this.clearRevealPass.clear=!1,this.clearRevealPass.clearbColor=!0,this.clearRevealPass.clearDepth=t,this.clearRevealPass.defaults.clear=!1,this.clearRevealPass.defaults.doClearDepth=t,this.clearRevealPass.clearAlpha=0,this.clearRevealPass.disabledByDefault=!0,this.clearRevealPass.idString=this.idString,this.revealPass=new a(i.scene,null,null,null,null,null,l+"Reveal"),this.revealPass.setStateSortingResultFrom(this.stateSortingResultFrom,!1),this.revealPass.setMaterialToUse(e.MaterialToUse.oitRevealMaterial),this.revealPass.isOITPass=!0,this.revealPass.setDLsToDisableFunc(r),this.revealPass.disabledByDefault=!0,this.revealPass.setDisableBackFaceCulling(!1),this.revealPass.idString=this.idString,this.composerReveal.addPass(this.clearRevealPass),this.composerReveal.addPass(this.revealPass),this.composerReveal.enablePass(this.clearRevealPass,!0),this.composerReveal.enablePass(this.revealPass,!0),i.insertComposer(null,this.mixPass)},update:function(e,t,i){},setSize:function(e,t){if(this._parent(e,t)){for(var i=0;i<this.composers.length;i++)this.composers[i].setSize(e,t);this.fxaaPass&&this.fxaaPass.uniforms.resolution.value.set(1/e,1/t)}}})}),define("Effects/OITEffect",["DS/Effects/OITEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/OITEffect"),e}),define("DS/Gestures/SpreadGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("Spread"),this.priority=10,this.touches=[],this.fingersVector0_1=new e.Vector2,this.fingersVector1_2=new e.Vector2,this.fingersVector2_0=new e.Vector2,this.latencyTime=30,this.initTime=0,this.distance=null,this.lastDistance=0,this.initDistance=0,this.distanceMin=0,this},detect:function(e){switch(this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE,t.State.END],this.view),3===this.touches.length&&(this.fingersVector0_1.subVectors(this.touches[1].currentPosition,this.touches[0].currentPosition),this.fingersVector1_2.subVectors(this.touches[2].currentPosition,this.touches[1].currentPosition),this.fingersVector2_0.subVectors(this.touches[0].currentPosition,this.touches[2].currentPosition),null===this.distance&&(this.distance=this.fingersVector0_1.length()+this.fingersVector1_2.length()+this.fingersVector2_0.length()),this.lastDistance=this.distance,this.distance=this.fingersVector0_1.length()+this.fingersVector1_2.length()+this.fingersVector2_0.length()),this.state){case i.State.INIT:this.distance=null,3===this.touches.length&&(this.preventDefault(this.touches),this.initTime=(new Date).getTime(),this.initDistance=this.distance,this.changeState(i.State.BEGIN));break;case i.State.BEGIN:3===this.touches.length?(this.events=this.touches,this.preventDefault(this.events),this.changeState(i.State.CHANGE)):this.changeState(i.State.KO);break;case i.State.CHANGE:if(3===this.touches.length){var r=this.touches[0].getState()===t.State.END||this.touches[1].getState()===t.State.END||this.touches[2].getState()===t.State.END;this.events=this.touches,this.preventDefault(this.events),this.changeState(i.State.CHANGE,r)}else this.changeState(i.State.KO);break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT),this.touches=[],this.distance=null}},preventDefault:function(e){for(var t=0;t<e.length;t++){var i=e[t].getJSEvent();i.preventDefault&&i.preventDefault()}}});return UWA.namespace("THREEDS/Gestures/SpreadGesture",r)}),define("Gestures/SpreadGesture",["DS/Gestures/SpreadGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/SpreadGesture"),e}),define("DS/Gestures/PrimaryPointerDownUniqueGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent","DS/Gestures/BasicGesture"],function(e,t,i,r){"use strict";var n=r.extend({init:function(){return this._parent("PrimaryPointerDownUnique"),this.priority=10,this.identifier=null,this},detect:function(e){switch(this._parent(e),this.state){case r.State.INIT:var i=THREEDS.VisuEventsManager.getPrimaryPointerEventsByStates([t.State.BEGIN],this.view);if(1===i.length){var n=THREEDS.VisuEventsManager.getTouchEvents(),a=THREEDS.VisuEventsManager.getMouseEvents();n.length+a.length<=2&&(this.events=[i[0]],this.changeState(r.State.OK))}break;case r.State.KO:case r.State.OK:case r.State.CANCEL:this.identifier=null,this.changeState(r.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/PrimaryPointerDownUniqueGesture",n)}),define("Gestures/PrimaryPointerDownUniqueGesture",["DS/Gestures/PrimaryPointerDownUniqueGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/PrimaryPointerDownUniqueGesture"),e}),define("DS/Visualization/RenderTargetPool",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return e.extend({init:function(e){var i=t.FloatType,r=t.HalfFloatType,n=t.FloatType,a=t._mobileDevice?t.HalfFloatType:t.FloatType;e.supportsFloatTextures()||(i=t.UnsignedByteType,n=t.HalfFloatType,a=t.HalfFloatType),e.supportsHalfFloatTextures()||(n=t.UnsignedByteType,a=t.UnsignedByteType,r=t.UnsignedByteType),e.supportsFloatTextures()&&!e.supportsHalfFloatTextures()&&(n=t.FloatType,a=t.FloatType,r=t.FloatType),t.IsIE11&&(r=i,n=i,a=i),this.rtOptionsMap={linear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:i},nearest:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!0,format:t.RGBAFormat,type:i},maxPrecisionLinear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:n},maxPrecisionNearest:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!0,format:t.RGBAFormat,type:n},halfLinear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:r},halfNearest:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!0,format:t.RGBAFormat,type:r},uint:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:t.UnsignedByteType},uintNearest:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!0,format:t.RGBAFormat,type:t.UnsignedByteType},uintRGBLinear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBFormat,type:t.UnsignedByteType},uintRGBLinearNoStencil:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!1,format:t.RGBFormat,type:t.UnsignedByteType},uintRGBNearest:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!0,format:t.RGBFormat,type:t.UnsignedByteType},uintRGBNearestNoStencil:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1,format:t.RGBFormat,type:t.UnsignedByteType},cubelinear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:i},decal:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1,format:t.RGBAFormat,type:a},decalTex:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1,format:t.RGBAFormat,type:a},iblLinear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!1,format:t.RGBAFormat,type:a},oitAccumLinear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:r},oitRevealLinear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBFormat,type:t.UnsignedByteType}},this.renderTargetPool=[]},areRenderTargetOptionsEqual:function(e,t){return e&&t?e.height===t.height&&e.width===t.width&&e.options===t.options:e===t},resetRenderTargetPool:function(){var e=0;for(e=0;e<this.renderTargetPool.length;e++)this.renderTargetPool[e].dispose();this.renderTargetPool=[]},rtpStats:{nbCreation:0},dumpPool:function(){var e,t="dumpPool: [";for(e=0;e<this.renderTargetPool.length;e++)e>0&&(t+=", "),t+=this.renderTargetPool[e].uniqueID;t+="]",console.log(t)},buildRenderTarget:function(e,i,r,n,a,s){var o,l,c=this.rtOptionsMap[r],h=null,u=-1;if(!s){for(l=0;l<this.renderTargetPool.length&&u<0;l++)(o=this.rtOptionsMap[this.renderTargetPool[l].optionsId])&&o.type===c.type&&r===this.renderTargetPool[l].optionsId&&this.renderTargetPool[l].width===e&&this.renderTargetPool[l].height===i&&((h=this.renderTargetPool[l]).reset(this.rtOptionsMap[r]),u=l);u>=0&&this.renderTargetPool.splice(u,1)}return h||(h="cubelinear"===r?new t.WebGLRenderTargetCube(e,i,this.rtOptionsMap[r]):new t.WebGLRenderTarget(e,i,this.rtOptionsMap[r]),e>0&&i>0&&this.rtpStats.nbCreation++),a&&(h.shareDepthFrom=a),h.optionsId=r,h},pushRenderTarget:function(e,t){if(e){for(var i=!1,r=0;r<this.renderTargetPool.length;r++)this.renderTargetPool[r].uniqueID==e.uniqueID&&(i=!0);i||this.renderTargetPool.push(e)}}})}),define("Visualization/RenderTargetPool",["DS/Visualization/RenderTargetPool","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/RenderTargetPool"),e}),define("DS/Gestures/MediumHoldStayGesture",["DS/Gestures/HoldStayGesture"],function(e){"use strict";var t=e.extend({init:function(){return this._parent(),this.priority=101,this.name="MediumHoldStay",this.maxTime=THREEDS.VisuEventsManager.getMediumHoldTime(),this},detect:function(e){this._parent(e)}});return UWA.namespace("THREEDS/Gestures/MediumHoldStayGesture",t)}),define("Gestures/MediumHoldStayGesture",["DS/Gestures/MediumHoldStayGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/MediumHoldStayGesture"),e}),define("DS/Shaders/SSAOShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t={computeVertexPositionVS:["vec4 normalDepth = texture2D( tNormalDepth, vUv );","#ifndef RENDER_TO_FLOAT_TEXTURE","float z = (normalDepth.z * 4096.0 + normalDepth.w) / 8388608.0;","#else","float z = normalDepth.w;","#endif","if ( z < 0.1 ) return;","vec2 xy = vUv * 2.0 - 1.0;","vec4 vertexPositionProjected = vec4(xy, 2.0 * z - 1.0, 1.0);","vec4 vertexPositionVS = realProjectionMatrixInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","vertexPositionVS.w = 1.0;"].join("\n"),computeNormal:["#ifndef RENDER_TO_FLOAT_TEXTURE","vec3 normal = decodeOct22Normal(normalDepth.xy);","#else","vec3 normal = normalDepth.xyz * 2.0 - 1.0;","#endif"].join("\n")},i={tNormalDepth:{type:"t",value:null},realProjectionMatrix:{type:"m4",value:new e.Matrix4},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},screenRatio:{type:"f",value:.5},nbSamples:{type:"i",value:16},tau:{type:"f",value:7},tRandomTexture:{type:"t",value:null},radius:{type:"f",value:.5},minRadius:{type:"f",value:.01},maxRadius:{type:"f",value:.2},thresholdAngle:{type:"f",value:.045},screenSize:{type:"v2",value:new e.Vector2(800,600)},invSize:{type:"v2",value:new e.Vector2(1/800,1/600)},maxRadiusInPixels:{type:"f",value:30},attenuation:{type:"f",value:1},quality:{type:"i",value:0}},r=["varying vec2 vUv;","void main() {","  vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),n=["uniform mat4 realProjectionMatrix;","uniform mat4 realProjectionMatrixInverse;","uniform float screenRatio;","uniform vec2 screenSize;","uniform vec2 invSize;","uniform float radius;","uniform float minRadius;","uniform float maxRadius;","uniform int nbSamples;","uniform float tau;","uniform float thresholdAngle;","uniform float attenuation;","#define MAX_SAMPLES 32","uniform sampler2D tNormalDepth;","varying vec2 vUv;","const int kernelSize = 32;","const float PI = 3.14159265358979323846264;","const float one_over_tan_225 = 2.414213562373095;","vec2 getScreenPos(vec3 pos) {","  vec4 offset = realProjectionMatrix * vec4(pos, 1.0);","  offset.xy /= offset.w;","  offset.xy = offset.xy * 0.5 + 0.5;","  return offset.xy;","}","vec3 decodeOct22Normal(in vec2 iEncodedNormal) {","float x = iEncodedNormal.x/2047.0*2.0 - 1.0;","float y = iEncodedNormal.y/2047.0*2.0 - 1.0;","vec3 v = vec3(x, y, 1.0 - abs(x) - abs(y));","if (v.z <= 0.0) {","vec2 sgn = signNotZero(v.xy);","v.xy = - abs(v.yx)*sgn + sgn;","}","return normalize(v);","}","bool computePointVS(vec2 iUV, out vec3 posVS) {","vec4 normalDepth = texture2D(tNormalDepth, iUV);","#ifndef RENDER_TO_FLOAT_TEXTURE","float z = (normalDepth.z * 4096.0 + normalDepth.w) / 8388608.0;","#else","float z = normalDepth.w;","#endif","bvec4 inScreen4 = bvec4(iUV.x >= 0.0, iUV.x <= 1.0, iUV.y >= 0.0, iUV.y <= 1.0);","bvec2 inScreen = bvec2(all(inScreen4), z > 0.0);","if (!all(inScreen)) return false;","vec2 xy = iUV * 2.0 - 1.0;","vec4 vertexPositionProjected = vec4(xy, 2.0 * z - 1.0, 1.0);","vec4 vertexPositionVS = realProjectionMatrixInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","posVS = vertexPositionVS.xyz;","return true;","}","float ComputeAO(const vec3 iSamplePos, vec3 iPos, vec3 iNormal, float iAtt) {","vec3 dir = iSamplePos - iPos;","float l2    = dot(dir, dir);","float angle = dot(iNormal, dir) / sqrt(l2);","float occ = 0.0;","if (l2 > 0.0  && angle > thresholdAngle) {","occ = 1.0 / (1.0 + l2 * iAtt);","angle = 1.0 - angle;","angle *= angle;","angle *= angle;","occ *= (1.0 - angle);","}","return occ;","}"].join("\n"),a=["  gl_FragColor = vec4(1.0);",t.computeVertexPositionVS,t.computeNormal,"  vec3 origin = vertexPositionVS.xyz;","float projRadius = 0.5 * realProjectionMatrix[0][0] * radius;","if (realProjectionMatrix[3][3] < 0.5) {","projRadius /= -origin.z;","}","float scaleRadius = 1.0;","#ifdef ADAPTATIVE_RADIUS","scaleRadius = min(maxRadius, max(projRadius, minRadius)) / projRadius;","#endif","  float newRadius = scaleRadius * radius;","float att = attenuation / (newRadius * newRadius);","  float occ = 0.0;"].join("\n"),s={defines:{ADAPTATIVE_RADIUS:!0},uniforms:{prevMap:{type:"t",value:null},numIteration:{type:"i",value:0},firstSample:{type:"i",value:0}},vertexShader:r,fragmentShader:["uniform sampler2D prevMap;","uniform sampler2D tRandomTexture;","uniform int numIteration;","uniform int firstSample;","float random(vec3 scale, float seed) {","  return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","float Random1D(float seed) {","return random(vec3(12.9898, 78.233, 151.7182), seed);","}","float HaltonSequenceShift(int n, int base, float shift) {","float val = 0.0;","float invBase = 1.0 / float(base);","float invBi = invBase;","for (int i = 0; i < 32; i++) {","if (n == 0) break;","float d_i = mod(float(n), float(base));","val += float(d_i) * invBi;","n /= base;","invBi *= invBase;","}","return fract(val + shift);","}","vec3 LowDiscrepancy3DShift(int index, vec2 shift) {","int yy = index / 64;","float xx = mod(float(index), 64.0);","vec2 offset = vec2(xx, float(yy));","vec3 res = texture2D(tRandomTexture, 0.015625 * (offset + 0.5)).xyz;","return fract(res + shift.xyx);","}","vec3 uniformlySampleSphere(vec2 E) {","  float z = 1.0 - 2.0 * E.x;","  float r = sqrt(1.0 - z * z);","  float angle = 6.283185307179586 * E.y;","  return vec3(r * cos(angle), r * sin(angle), z);","}","vec4 precomputeRandom1D(vec2 shift, int index) {","vec3 E = LowDiscrepancy3DShift(firstSample + index + 1, shift);","return vec4(uniformlySampleSphere(E.xy), E.z);","}",n,"float ComputeSampleSSAO(vec3 iSamplingPt, vec3 iPos, vec3 iNormal, float iRadius, float iAtt, float iRandomZ) {","float occ = 0.0;","float delta = iRadius * sign(dot(iSamplingPt, iNormal)) * iRandomZ;","vec3  newPt = delta * iSamplingPt + iPos;","vec2 coord = getScreenPos(newPt);","vec2 tmp = coord - vUv;","coord = vUv + sign(tmp.xy) * max(invSize.xy, abs(tmp.xy));","vec3 samplePos;","if (computePointVS(coord, samplePos) && (samplePos.z > newPt.z)) {","occ = ComputeAO(samplePos, iPos, iNormal, iAtt);","}","return occ;","}","void main() {",a,"vec2 shift = vec2(Random1D(gl_FragCoord.x + gl_FragCoord.y), Random1D(gl_FragCoord.x * gl_FragCoord.y));","for (int i = 0; i < MAX_SAMPLES; i++) {","if (i == nbSamples) {","break;","}","vec4 randVec = precomputeRandom1D(shift, i);","occ += ComputeSampleSSAO(randVec.xyz, origin, normal, newRadius, att, randVec.w);","}","occ /= max(float(nbSamples), 1.0);","float prevAO = texture2D( prevMap, vUv ).r * float(numIteration);","float curAO = 1.0 - occ;","float total = float(numIteration) + 1.0;","float totalAO = (prevAO + curAO) / total;","gl_FragColor = vec4(vec3(totalAO), 1.0);","}"].join("\n")},o={defines:{ADAPTATIVE_RADIUS:!0},uniforms:{samplingPoints:{type:"fv",value:[]}},vertexShader:r,fragmentShader:["uniform sampler2D tRandomTexture;","uniform vec3 samplingPoints[32];","float modI(float a, float b) {","float m = a - floor((a + 0.5) / b) * b;","return floor(m + 0.5);","}","vec3 precomputeRandom1D(vec2 coords) {","vec2 s = 0.2 * (vec2(modI(coords.x, 5.0), modI(coords.y, 5.0)) + 0.5);","return texture2D(tRandomTexture, s).xyz;","}",n,"float ComputeSampleSSAO(vec3 iSamplingPt, vec3 iPos, vec3 iNormal, float iRadius, float iAtt, vec3 iRandomVec) {","float occ = 0.0;","vec3 rayDir = reflect(iSamplingPt, iRandomVec);","float delta = iRadius * sign(dot(rayDir, iNormal));","vec3  newPt = delta * rayDir + iPos;","vec2 coord = getScreenPos(newPt);","vec2 tmp = coord - vUv;","coord = vUv + sign(tmp.xy) * max(invSize.xy, abs(tmp.xy));","vec3 samplePos;","if (computePointVS(coord, samplePos) && (samplePos.z > newPt.z)) {","occ = ComputeAO(samplePos, iPos, iNormal, iAtt);","}","return occ;","}","void main() {",a,"vec3 randVec = precomputeRandom1D(gl_FragCoord.xy);","for (int i = 0; i < MAX_SAMPLES; i++) {","if (i == nbSamples) {","break;","}","occ += ComputeSampleSSAO(samplingPoints[i], origin, normal, newRadius, att, randVec);","}","occ /= max(float(nbSamples), 1.0);","gl_FragColor = vec4(vec3(1.0 - occ), 1.0);","}"].join("\n")};return Object.assign(s.uniforms,i),Object.assign(o.uniforms,i),{Iterative:s,Direct:o}}),define("Shaders/SSAOShader",["DS/Shaders/SSAOShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/SSAOShader"),e}),define("DS/Effects/AbstractSSAOEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/SSAOShader","DS/Shaders/AdaptativeBlurShader","DS/Shaders/MultiplicativeBlendShader","DS/Plugins/ClearPass"],function(e,t,i,r,n,a,s,o,l){"use strict";return i.extend({init:function(t,i,a,s){this._parent(t);this.__renderer=t,this._randomTexture=null,this._samplingPoints=null,this.shaderName=a,this.effectName=s,this.effectSSAO=null,this.effectSSAOBlurH=null,this.effectSSAOBlurV=null;var l=new e.WebGLRenderTargetProperties(this.width,this.height,"uintRGBLinearNoStencil"),c=new r(t,l,i);return c.composerContext.keepResult=!0,c.composerContext.name=a+s+"ComposerContext",this.composers.push(c),this.isDynamicRadius=!0,this.isAdaptativeRadius=!0,this.influenceRadius=.04,this.minPixelRadius=14,this.maxPixelRadius=400,this.minRadius=.01,this.maxRadius=.12,this.slotAngle=1.35,this.contrast=1.4,this.attenuation=1,this.nbSamples=-1,this.mixPass=new n(o,void 0,s),this.mixPass.defines.SSAO=1,this.mixPass.compileShader(t),this.__compNormalDepth=null,this._initPasses(),this.setStrength(.95),this.influenceRadius=.2,this.setNbSamples(16),this.setSize(this.width,this.height,!0),this},getRandomTexture:function(){return this._randomTexture},getSamplingPoints:function(){return this._samplingPoints},initEffect:function(e,t){e&&(this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0),this.__compNormalDepth=t.getComposer("normalDepth"),this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAO,this.effectSSAO.uniforms.tNormalDepth),this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAOBlurH,this.effectSSAOBlurH.uniforms.tNormalDepth),this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAOBlurV,this.effectSSAOBlurV.uniforms.tNormalDepth),t.getComposer("normalDepthIoRRoughness").linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tNormalDepthIoRRoughness),t.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,t,i,r,n,a){var s=i._renderedCamera;s.projectionMatrixInverse.getInverse(s.projectionMatrix);var o=t.getBoundingSphere(),l=this.isDynamicRadius?this.influenceRadius*o.radius:this.influenceRadius,c=Math.max(this.minPixelRadius/this.width,this.minRadius),h=Math.min(this.maxPixelRadius/this.width,this.maxRadius);this.effectSSAO.uniforms.realProjectionMatrix.value=s.projectionMatrix,this.effectSSAO.uniforms.realProjectionMatrixInverse.value=s.projectionMatrixInverse,this.effectSSAO.uniforms.radius.value=l,this.effectSSAO.uniforms.minRadius.value=c,this.effectSSAO.uniforms.maxRadius.value=h;var u=this.contrast,d=this.attenuation;this.mixPass.uniforms.contrast.value=u,this.effectSSAO.uniforms.attenuation.value=d,this.effectSSAOBlurH.uniforms.radius.value=l,this.effectSSAOBlurV.uniforms.radius.value=l},setDynamicRadius:function(e){this.isDynamicRadius=e},setAdaptativeRadius:function(e){this.isAdaptativeRadius!==e&&(this.isAdaptativeRadius=e,this.effectSSAO.material.defines.ADAPTATIVE_RADIUS=e,this.effectSSAO.material.needsUpdate=!0)},setRadius:function(e){this.influenceRadius=Math.max(0,e)},setRadiusRange:function(e,t){this.minRadius=Math.min(Math.max(0,e),1),this.maxRadius=Math.min(Math.max(0,t),1)},setMinPixelRadius:function(e){this.minPixelRadius=Math.max(0,e)},setAttenuation:function(e){this.effectSSAO&&(this.attenuation=Math.max(0,e),this.effectSSAO.uniforms.attenuation.value=this.attenuation)},setContrast:function(e){this.contrast=Math.max(0,e),this.mixPass.uniforms.contrast.value=this.contrast},setStrength:function(e){this.setPower(e)},setPower:function(e){this.mixPass.uniforms.power.value=Math.max(0,e)},setThresholdAngle:function(e){this.slotAngle=e,this.effectSSAO.uniforms.thresholdAngle.value=Math.cos(e)},setNbSamples:function(e){e!==this.nbSamples&&(this.nbSamples=e,this.effectSSAO.uniforms.tau.value=this.tau[this.effectSSAO.uniforms.nbSamples.value],this.effectSSAO.uniforms.nbSamples.value=Math.min(e,32))},setSize:function(e,t,i){(this._parent(e,t)||i)&&(this.composers[0].setSize(this.width,this.height),this.effectSSAO.uniforms.screenRatio.value=this.height/this.width,this.effectSSAO.uniforms.screenSize.value.set(this.width,this.height),this.effectSSAO.uniforms.invSize.value.set(1/this.width,1/this.height),this.effectSSAOBlurH.uniforms.invSize.value.set(1/this.width,1/this.height),this.effectSSAOBlurV.uniforms.invSize.value.set(1/this.width,1/this.height))},_initPasses:function(){if(!this.tau){var e=[];e[0]=0,e[1]=1,e[2]=1,e[3]=2,e[4]=3,e[5]=3,e[6]=5,e[7]=5,e[8]=5,e[9]=7,e[10]=7,e[11]=7,e[12]=7,e[13]=7,e[14]=11,e[15]=11,e[16]=11,e[17]=13,e[18]=13,e[19]=13,e[20]=17,e[21]=17,e[22]=17,e[23]=17,e[24]=19,e[25]=19,e[26]=19,e[27]=23,e[28]=23,e[29]=23,e[30]=23,e[31]=27,e[32]=27,e[48]=43,e[64]=59,this.tau=e}if(!this.effectSSAO){this.effectSSAO=new n(a[this.shaderName],void 0,this.shaderName+this.effectName),this.effectSSAO.order=10,this.effectSSAO.compileShader(this.__renderer),this.effectSSAO.uniforms.tRandomTexture.value=this.getRandomTexture();var t=this.getSamplingPoints();t&&(this.effectSSAO.uniforms.samplingPoints.value=t),this.composers[0].addPass(this.effectSSAO),this.__compNormalDepth&&this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAO,this.effectSSAO.uniforms.tNormalDepth),s.H.defines.NB_SAMPLES=3,s.V.defines.NB_SAMPLES=3,s.H.defines.STEP="1.5",s.V.defines.STEP="1.5"}this.effectSSAOBlurH?(this.effectSSAOBlurH.compileShader(this.__renderer),this.effectSSAOBlurV.compileShader(this.__renderer)):(this.effectSSAOBlurH=new n(s.H,void 0,this.shaderName+this.effectName+"BlurH"),this.effectSSAOBlurV=new n(s.V,void 0,this.shaderName+this.effectName+"BlurV"),this.effectSSAOBlurH.order=100,this.effectSSAOBlurV.order=110,this.effectSSAOBlurH.compileShader(this.__renderer),this.effectSSAOBlurV.compileShader(this.__renderer),this.composers[0].addPass(this.effectSSAOBlurH),this.composers[0].addPass(this.effectSSAOBlurV),this.__compNormalDepth&&this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAOBlurH,this.effectSSAOBlurH.uniforms.tNormalDepth),this.__compNormalDepth&&this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAOBlurV,this.effectSSAOBlurV.uniforms.tNormalDepth)),this.composers[0].enablePass(this.effectSSAOBlurH,!0),this.composers[0].enablePass(this.effectSSAOBlurV,!0),this.composers[0].enablePass(this.effectSSAO,!0)},getMaxIteration:function(){return 0}})}),define("Effects/AbstractSSAOEffect",["DS/Effects/AbstractSSAOEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/AbstractSSAOEffect"),e}),define("DS/Effects/SSAOEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/AbstractSSAOEffect","DS/Plugins/ShaderPass","DS/Shaders/AdaptativeBlurShader"],function(e,t,i,r){"use strict";return t.extend({init:function(e,t){this._parent(e,t,"Direct","SSAOEffect");return this},getRandomTexture:function(){if(!this._randomTexture){for(var t=[.960296,.274776,-.0482711,0,-.0217867,.999033,-.0381943,0,-.0281167,.280583,.959418,0,-.0622982,-.0498126,-.996814,0,.762197,.178997,.622106,0,-.610721,.38519,-.691844,0,.209116,-.106236,-.972103,0,-.971866,.0766489,-.222714,0,-.321656,.280776,-.904269,0,.836284,-.48659,.252705,0,-.924106,-.109391,-.366145,0,.110424,.149603,.982561,0,.92149,-.376162,.0967352,0,-.592781,-.0588162,.803213,0,.238876,-.0463654,.969942,0,.728274,-.299609,-.61632,0,-.389309,-.215351,.895579,0,.775002,-.220267,-.59233,0,-.681002,-.359332,-.638056,0,-.13823,-.980038,.142888,0,.860016,-.165527,-.482673,0,-.599353,-.659337,.453928,0,.416823,-.908951,-.00818423,0,-.793046,-.0722135,.604866,0,-.188499,.945449,.265696,0],i=new Float32Array(100),r=0;r<100;r++)i[r]=t[r];this._randomTexture=new e.DataTexture(i,5,5,e.RGBAFormat,e.FloatType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter),this._randomTexture.generateMipmaps=!1,this._randomTexture.needsUpdate=!0}return this._randomTexture},getSamplingPoints:function(){return this._samplingPoints||(this._samplingPoints=[.334033,-.00485205,-.00401396,-.453196,-.267136,.16953,-.147833,.413971,-.106289,.0909656,-.10026,-.646145,.150717,.422825,.407178,-.141224,-.0126533,.671199,-.568417,.123185,-.109986,-.0231788,-.733836,.0740228,-.00159637,-498002e-9,.00229559,.411656,-.16241,.505242,-.373892,.115395,-.594764,.236072,.72466,.0524527,-.0849139,-.231345,-.121562,-.0492975,-.409624,.508015,.363041,-.233737,-.358279,.209588,.103554,-.290493,.401735,-.318318,.174997,-.436293,.0988326,.230372,-.00129735,-.00939224,-.102806,.0474442,.094537,-.0300616,-.180245,.307443,.33575,.0280045,.00316191,.201276,-.487838,-.48419,-.148956,-.207171,-.0813871,-.133753,.43206,.435895,-.210157,-.333923,-.35392,-.450399,.314904,-.343625,-.0974952,.0534175,-.0530132,-.0137891,-.0964412,.115755,.0301087,.659795,-.251509,-.00948616,.284603,-.679033,.192659,-.594049,-.128511,-.149513]),this._samplingPoints}})}),define("Effects/SSAOEffect",["DS/Effects/SSAOEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/SSAOEffect"),e}),define("DS/Shaders/MirrorShaders",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t={uniforms:{tDiffuse:{type:"t",value:null},texelSize:{type:"v2",value:new e.Vector2}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tDiffuse;","uniform vec2 texelSize;","vec4 blur(){","vec4 sum = vec4(0);","int nbSamples = 0;","float pixelSizeX = 1.0 / texelSize.x;","float pixelSizeY = 1.0 / texelSize.y;","for( int i = -10; i < 10; i+=2 ){","for( int j = -10; j < 10; j+=2 ){","sum += texture2D( tDiffuse, vUv + vec2(float(i)*pixelSizeX,float(j)*pixelSizeY) );","nbSamples++;","}","}","return sum / float(nbSamples);","}","void main() {","gl_FragColor = blur();","} "].join("\n")};return{blend:{defines:{POSTPRO:1},uniforms:{tReflectedScene:{type:"t",value:null},tDiffuse:{type:"t",value:null},reflectivity:{type:"f",value:.3}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 vUv;","#if (POSTPRO == 1)","uniform sampler2D tDiffuse;","#endif","uniform sampler2D tReflectedScene;","uniform float reflectivity;","void main() {","vec4 reflectedScene = texture2D(tReflectedScene, vUv);","float blend = 1.0 - reflectivity;","float srcAlpha = (1.0 - blend) * reflectedScene.w;","#if (POSTPRO == 1)","vec4 mirrorPlane = texture2D(tDiffuse, vUv);","vec3 mirrorPlaneColor = mirrorPlane.xyz;","vec3 mirrorMix = (1.0 - blend) * reflectedScene.xyz + blend * mirrorPlaneColor;","gl_FragColor = vec4(mirrorMix * reflectedScene.w + mirrorPlaneColor * (1.0 - reflectedScene.w), srcAlpha + (1.0-srcAlpha)*mirrorPlane.w);","#else","gl_FragColor = vec4(reflectedScene.rgb, srcAlpha);","#endif","} "].join("\n")},reflectedScene:t}}),define("Shaders/MirrorShaders",["DS/Shaders/MirrorShaders","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/MirrorShaders"),e}),define("DS/Shaders/MLAAShaders",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{EdgeDetection:{uniforms:{tDiffuse:{type:"t",value:null},screenWidth:{type:"f",value:800},screenHeight:{type:"f",value:600}},vertexShader:["varying vec2 vUv;","varying vec4 offset[3];","uniform float screenHeight;","uniform float screenWidth;","void main() {","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","    vUv = uv;","    offset[0] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4(-1.0, 0.0, 0.0, 1.0);","    offset[1] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4( 1.0, 0.0, 0.0,-1.0);","    offset[2] = vUv.xyxy + SMAA_PIXEL_SIZE.xyxy * vec4(-2.0, 0.0, 0.0, -2.0);",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform float screenHeight;","uniform float screenWidth;","uniform sampler2D tDiffuse;","varying vec2 vUv;","varying vec4 offset[3];","const float threshold = 0.1;","void main() {","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","    vec3 weights = vec3(0.2126,0.7152, 0.0722);","    float L = dot(texture2D(tDiffuse, vUv.xy).rgb, weights);","    float Lleft = dot(texture2D(tDiffuse, offset[0].xy).rgb, weights);","    float Ltop = dot(texture2D(tDiffuse, offset[0].zw).rgb, weights);","    float Lright = dot(texture2D(tDiffuse, offset[1].xy).rgb, weights);","    float Lbottom = dot(texture2D(tDiffuse, offset[1].zw).rgb, weights);","    vec4 delta = abs(vec4(L) - vec4(Lleft, Ltop, Lright, Lbottom));","    vec4 edges = step(vec4(threshold), delta);","    gl_FragColor = edges;","    gl_FragColor.ba = vec2(0.0,1.0);","}"].join("\n")},BlendingWeights:{uniforms:{tDiffuse:{type:"t",value:null},areaTex:{type:"t",value:null},screenWidth:{type:"f",value:800},screenHeight:{type:"f",value:600}},vertexShader:["varying vec2 vUv;","uniform float screenHeight;","uniform float screenWidth;","void main() {","    vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D areaTex;","uniform float screenHeight;","uniform float screenWidth;","varying vec2 vUv;","const int   MAX_SEARCH_STEPS = 7;","const int   MAX_DISTANCE     = 16;","vec2 SMAA_PIXEL_SIZE;","vec4 tex2DLod(sampler2D map, vec2 texcoord, float offset) {","    return texture2D(map, texcoord );","}","float SearchXLeft(vec2 texcoord) {","    int j;","    texcoord -= vec2(1.5, 0.0) * SMAA_PIXEL_SIZE;","    float g = 0.0;","    for (int i = 0; i < MAX_SEARCH_STEPS; i++) {","        j = i;","        g = texture2D(tDiffuse, texcoord).g;","        if (g < 0.9) break;","        texcoord -= vec2(2.0, 0.0) * SMAA_PIXEL_SIZE;","    }","    return max(-2.0 * float(j) - 2.0 * g, -2.0 * float(MAX_SEARCH_STEPS));","}","float SearchXRight(vec2 texcoord) {","    int j;","    texcoord += vec2(1.5, 0.0) * SMAA_PIXEL_SIZE;","    float g = 0.0;","    for(int i = 0; i < MAX_SEARCH_STEPS; i++) {","        j = i;","        g = texture2D(tDiffuse, texcoord).g;","        if (g < 0.9) break;","        texcoord += vec2(2.0, 0.0) * SMAA_PIXEL_SIZE;","    }","    return min(2.0 * float(j) + 2.0 * g, 2.0 * float(MAX_SEARCH_STEPS));","}","float SearchYUp(vec2 texcoord) {","    int j;","    texcoord += vec2(0.0, 1.5) * SMAA_PIXEL_SIZE;","    float r = 0.0;","    for(int i = 0; i < MAX_SEARCH_STEPS; i++) {","        j = i;","        r = texture2D(tDiffuse, texcoord).r;","        if (r < 0.9) break;","        texcoord += vec2(0.0, 2.0) * SMAA_PIXEL_SIZE;","    }","    return min(2.0 * float(j) + 2.0 * r, 2.0 * float(MAX_SEARCH_STEPS));","}","float SearchYDown(vec2 texcoord) {","    int j;","    texcoord -= vec2(0.0, 1.5) * SMAA_PIXEL_SIZE;","    float r = 0.0;","    for(int i = 0; i < MAX_SEARCH_STEPS; i++) {","        j = i;","        r = texture2D(tDiffuse, texcoord).r;","        if (r < 0.9) break;","        texcoord -= vec2(0.0, 2.0) * SMAA_PIXEL_SIZE;","    }","    return max(-2.0 * float(j) - 2.0 * r, -2.0 * float(MAX_SEARCH_STEPS));","}","vec2 _round(vec2 invec) {","    return vec2(floor(abs(invec) + vec2(0.5)) * sign(invec));","}","vec2 Area(vec2 distance, float e1, float e2) {","    float areaSize = float(MAX_DISTANCE) * 5.0;","    vec2 pixcoord = float(MAX_DISTANCE) * ","                    _round(4.0 * vec2(e1, e2)) ","                    + distance + vec2(0.5);","    vec2 texcoord = pixcoord / areaSize;","    return tex2DLod(areaTex, vec2(texcoord.x, 1.0 - texcoord.y), 0.0).rg;","}","void main() {","SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","    vec4 weights = vec4(0.0, 0.0, 0.0, 0.0);","    vec2 e = texture2D(tDiffuse, vUv).rg;","    vec2 d;","    if (e.g != 0.0) { ","        d = vec2(SearchXLeft(vUv), SearchXRight(vUv));","        vec4 coords = vec4(d.x, 0.25, d.y + 1.0, 0.25) * SMAA_PIXEL_SIZE.xyxy + vUv.xyxy;","        float e1 = tex2DLod(tDiffuse, coords.xy, 0.0).r;","        float e2 = tex2DLod(tDiffuse, coords.zw, 0.0).r;","        weights.rg = Area(abs(d), e1, e2);","    }","    if (e.r != 0.0) {","        d = vec2(SearchYUp(vUv), SearchYDown(vUv));","        vec4 coords = vec4(-0.25, d.x, -0.25, d.y - 1.0) * SMAA_PIXEL_SIZE.xyxy + vUv.xyxy;","        float e1 = texture2D(tDiffuse, coords.xy).g;","        float e2 = texture2D(tDiffuse, coords.zw).g;","        weights.ba = Area(abs(d), e1, e2);","    }","    gl_FragColor = clamp(weights, 0.0, 1.0);","}"].join("\n")},FinalBlending:{uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},screenWidth:{type:"f",value:800},screenHeight:{type:"f",value:600}},vertexShader:["varying vec2 vUv;","void main() {","    vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","uniform float screenHeight;","uniform float screenWidth;","varying vec2 vUv;","void main() {","vec2 SMAA_PIXEL_SIZE = vec2(1.0/screenWidth, 1.0/screenHeight);","    vec4 topLeft = texture2D(tDiffuse2, vUv);","    float bottom = texture2D(tDiffuse2, vUv + vec2(0.0, -1.0) * SMAA_PIXEL_SIZE).g;","    float right = texture2D(tDiffuse2, vUv + vec2(1.0, 0.0) * SMAA_PIXEL_SIZE).a;","    vec4 a = vec4(topLeft.r, bottom, topLeft.b, right);","    vec4 w = a * a * a;","    float sum = dot(w, vec4(1.0));","    if (sum > 0.0) {","        vec4 o = a * SMAA_PIXEL_SIZE.yyxx;","        vec4 color = vec4(0.0);","        color = texture2D(tDiffuse, vUv + vec2( 0.0,  o.r)) * w.r + color;","        color = texture2D(tDiffuse, vUv + vec2( 0.0, -o.g)) * w.g + color;","        color = texture2D(tDiffuse, vUv + vec2(-o.b,  0.0)) * w.b + color;","        color = texture2D(tDiffuse, vUv + vec2( o.a,  0.0)) * w.a + color;","        gl_FragColor = color / sum;","    } else {","        gl_FragColor = texture2D(tDiffuse, vUv);","    }","}"].join("\n")}}}),define("Shaders/MLAAShaders",["DS/Shaders/MLAAShaders","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/MLAAShaders"),e}),define("DS/Gestures/MouseMoveGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("MouseMove"),this.priority=0,this},detect:function(e){this._parent(e);var r=THREEDS.VisuEventsManager.getMouseEvents(t.MouseButton.NONE,this.view);switch(this.state){case i.State.INIT:case i.State.CHANGE:for(var n=0;n<r.length;n++){var a=r[n];return a.state===t.State.MOVE?(this.events=[a],void this.changeState(i.State.CHANGE)):void this.changeState(i.State.INIT)}this.changeState(i.State.INIT);break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/MouseMoveGesture",r)}),define("Gestures/MouseMoveGesture",["DS/Gestures/MouseMoveGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/MouseMoveGesture"),e}),define("DS/Effects/MLAAEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/MLAAShaders"],function(e,t,i,r,n,a){"use strict";return i.extend({init:function(i,s){this._parent(i);var o=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers.push(new r(i,o,s)),this.pass1=new n(a.EdgeDetection),this.pass2=new n(a.BlendingWeights),this.mixPass=new n(a.FinalBlending,void 0,"MLAAEffect"),this.composers[0].addPass(this.pass1),this.composers[0].addPass(this.pass2);var l=t.getWebappsAssetUrl("Effects",""),c=new e.ImageUtils.loadTexture(l+"AreaTexMLAA.png",void 0,null,null,e.ImageUtils.crossOriginPolicy);return c.minFilter=e.LinearFilter,c.magFilter=e.LinearFilter,this.pass2.uniforms.areaTex.value=c,this},initEffect:function(e,t){t.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,t,i){},setSize:function(e,t){this._parent(e,t)&&(this.composers[0].setSize(this.width,this.height),this.pass1.uniforms.screenWidth.value=this.width,this.pass1.uniforms.screenHeight.value=this.height,this.pass2.uniforms.screenWidth.value=this.width,this.pass2.uniforms.screenHeight.value=this.height,this.mixPass.uniforms.screenWidth.value=this.width,this.mixPass.uniforms.screenHeight.value=this.height)}})}),define("Effects/MLAAEffect",["DS/Effects/MLAAEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/MLAAEffect"),e}),define("DS/Gestures/LongHoldGesture",["DS/Gestures/HoldGesture"],function(e){"use strict";var t=e.extend({init:function(){return this._parent(),this.priority=100,this.name="LongHold",this.maxTime=THREEDS.VisuEventsManager.getLongHoldTime(),this},detect:function(e){this._parent(e)}});return UWA.namespace("THREEDS/Gestures/LongHoldGesture",t)}),define("Gestures/LongHoldGesture",["DS/Gestures/LongHoldGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/LongHoldGesture"),e}),define("DS/Manipulators/LineTranslationManipulator",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator"],function(e,t,i){"use strict";var r=i.extend({init:function(t){var i;return i=this.DEPRECATED_CONSTRUCTOR(arguments)?{axis:arguments[1]}:t||{},this._parent(),this.axis=i.axis,this.axis.normalize(),this.projector=new e.Projector,this},BeginManipulate:function(t,i,r){this._parent(t,i,r),this.initialPositionProjected=i.from[0].getCurrentPosition(i.viewer.canvas),this.initial3dIntersectionPoint=r.position,this.initial3dIntersectionPointTranslated=(new e.Vector3).copy(this.initial3dIntersectionPoint),this.initial3dIntersectionPointTranslated.add(this.axis);var n={viewer:i.viewer,eventChannel:"BeginManipulate",event:i,paths:this.manipulatedPaths,intersection:r,manipulator:this};this.publish("BeginManipulate",n)},Manipulate:function(t,i,r){this._parent(t,i,r);var n=(new e.Vector2).copy(i.from[0].getCurrentPosition(i.viewer.canvas)),a=i.viewer.currentViewpoint.create3DRayFrom2DPoint(n).computeShortestPointToLine(this.initial3dIntersectionPoint,this.initial3dIntersectionPointTranslated),s=(new e.Vector3).subVectors(a,this.initial3dIntersectionPoint),o={viewer:i.viewer,eventChannel:"Manipulate",event:i,paths:this.manipulatedPaths,translationVector:s,intersection:r,manipulator:this};this.publish("Manipulate",o)},EndManipulate:function(t,i,r){var n=(new e.Vector2).copy(i.from[0].getCurrentPosition(i.viewer.canvas)),a=i.viewer.currentViewpoint.create3DRayFrom2DPoint(n).computeShortestPointToLine(this.initial3dIntersectionPoint,this.initial3dIntersectionPointTranslated),s=(new e.Vector3).subVectors(a,this.initial3dIntersectionPoint),o={viewer:i.viewer,eventChannel:"EndManipulate",event:i,paths:this.manipulatedPaths,translationVector:s,intersection:r,manipulator:this};this.publish("EndManipulate",o),this._parent(t,i,r)},BeginPreactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"BeginPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("BeginPreactivate",r)},Preactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"Preactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("Preactivate",r)},EndPreactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"EndPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("EndPreactivate",r)},PrimaryPointerClick:function(e,t,i){var r={viewer:t.viewer,eventChannel:"PrimaryPointerClick",event:t,intersection:i,manipulator:this};this.publish("PrimaryPointerClick",r)},PrimaryPointerDoubleClick:function(e,t,i){var r={viewer:t.viewer,eventChannel:"PrimaryPointerDoubleClick",event:t,intersection:i,manipulator:this};this.publish("PrimaryPointerDoubleClick",r)}});return UWA.namespace("THREEDS/Nodes/LineTranslationManipulator",r)}),define("Manipulators/LineTranslationManipulator",["DS/Manipulators/LineTranslationManipulator","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Manipulators/LineTranslationManipulator"),e}),define("DS/Gestures/DoubleTapGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("DoubleTap"),this.priority=100,this.currentTime=0,this.maxTime=400,this.maxDistance=50,this.lastTapTime=0,this.lastTapPosition=new e.Vector2,this.lastTapTimeTemp=0,this.lastTapPositionTemp=new e.Vector2,this.firstTapStartTime=0,this},detect:function(e){this._parent(e);var r=this.gestures[0];if(r)switch(this.currentTime=(new Date).getTime(),this.state){case i.State.INIT:r.getState()===i.State.OK&&(this.lastTapTime=this.currentTime,this.lastTapPosition.copy(r.events[0].currentPosition),this.lastTapTimeTemp=this.currentTime,this.lastTapPositionTemp.copy(r.events[0].currentPosition),this.firstTapStartTime=r.events[0].startTime,this.changeState(i.State.BEGIN));break;case i.State.BEGIN:if(r.getState()===i.State.OK)this.currentTime-this.lastTapTime<this.maxTime&&this.lastTapPosition.sub(r.events[0].currentPosition).length()<this.maxDistance?(this.events=r.getEvents(),this.changeState(i.State.OK)):(this.lastTapTime=this.currentTime,this.lastTapPosition.copy(r.events[0].currentPosition),this.lastTapPositionTemp.copy(r.events[0].currentPosition),this.lastTapTimeTemp=this.currentTime,this.firstTapStartTime=r.events[0].startTime);else{var n=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN],this.view);if(this.currentTime-this.lastTapTimeTemp<this.maxTime&&this.lastTapPositionTemp.sub(r.events[0].currentPosition).length()<this.maxDistance&&n[0]){var a=n[0].getJSEvent();a&&a.preventDefault&&a.preventDefault()}}break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}},getElapsedTime:function(){return this.getEvents().length>0?this.currentTime-this.firstTapStartTime:null},getTouchPoint:function(){return this.getEvents().length>0?this.getEvents()[0].getCurrentPosition():null}});return UWA.namespace("THREEDS/Gestures/DoubleTapGesture",r)}),define("Gestures/DoubleTapGesture",["DS/Gestures/DoubleTapGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/DoubleTapGesture"),e}),define("DS/Manipulators/HandlePointManipulator",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this.DEPRECATED_CONSTRUCTOR(arguments),this._parent(),this},BeginManipulate:function(e,t,i){this._parent(e,t,i);var r={viewer:t.viewer,eventChannel:"BeginManipulate",event:t,paths:this.manipulatedPaths,intersection:i,manipulator:this};this.publish("BeginManipulate",r)},Manipulate:function(e,t,i){this._parent(e,t,i);var r={viewer:t.viewer,eventChannel:"Manipulate",event:t,paths:this.manipulatedPaths,intersection:i,manipulator:this};this.publish("Manipulate",r)},EndManipulate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"EndManipulate",event:t,paths:this.manipulatedPaths,intersection:i,manipulator:this};this.publish("EndManipulate",r),this._parent(e,t,i)},BeginPreactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"BeginPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("BeginPreactivate",r)},Preactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"Preactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("Preactivate",r)},EndPreactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"EndPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("EndPreactivate",r)},PrimaryPointerClick:function(e,t,i){var r={viewer:t.viewer,eventChannel:"PrimaryPointerClick",event:t,intersection:i,manipulator:this};this.publish("PrimaryPointerClick",r)},PrimaryPointerDoubleClick:function(e,t,i){var r={viewer:t.viewer,eventChannel:"PrimaryPointerDoubleClick",event:t,intersection:i,manipulator:this};this.publish("PrimaryPointerDoubleClick",r)}});return UWA.namespace("THREEDS/Manipulators/HandlePointManipulator",r)}),define("Manipulators/HandlePointManipulator",["DS/Manipulators/HandlePointManipulator","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Manipulators/HandlePointManipulator"),e}),define("DS/Gestures/PrimaryPointerMoveUniqueGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent","DS/Gestures/BasicGesture"],function(e,t,i,r){"use strict";var n=r.extend({init:function(){return this._parent("PrimaryPointerMoveUnique"),this.priority=10,this},detect:function(e){switch(this._parent(e),this.state){case r.State.INIT:case r.State.CHANGE:var i=!1,n=THREEDS.VisuEventsManager.getScreenEvents(),a=n.length,s=null;if(a>0)if(1===a){var o=n[0].getType(),l=n[0].getState();"Mouse"!==o&&"Touch"!==o||(i=l===t.State.MOVE,s=n[0])}else if(2===a){var c=THREEDS.VisuEventsManager.getMouseEventsByStates([t.State.MOVE],t.MouseButton.NONE,this.view),h=THREEDS.VisuEventsManager.getMouseEventsByStates([t.State.MOVE],t.MouseButton.LEFT,this.view),u=THREEDS.VisuEventsManager.getTouchEvents(this.view);i=1===c.length&&1===h.length||1===u.length&&u[0].getState()===t.State.MOVE&&!c.length&&!h.length,s=h.length?h[0]:u[0]}if(i)return this.events=[s],void this.changeState(r.State.CHANGE);this.changeState(r.State.INIT);break;case r.State.KO:case r.State.OK:case r.State.CANCEL:this.changeState(r.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/PrimaryPointerMoveUniqueGesture",n)}),define("Gestures/PrimaryPointerMoveUniqueGesture",["DS/Gestures/PrimaryPointerMoveUniqueGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/PrimaryPointerMoveUniqueGesture"),e}),define("DS/Effects/HighlightMobileEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/HighlightEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/AdvancedHighlightShader","DS/Plugins/ClearPass","DS/Visualization/RenderMode"],function(e,t,i,r,n,a,s,o){"use strict";return t.extend({init:function(e,t,i,r){return this._parent(e,t,i,r,a.FinalMobileBlending(0)),this},_updateMixPassShader:function(e){this.mixPass._updateMaterialShader(a.FinalMobileBlending(e))}})}),define("Effects/HighlightMobileEffect",["DS/Effects/HighlightMobileEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/HighlightMobileEffect"),e}),define("DS/Gestures/TouchGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("Touch"),this.priority=0,this},detect:function(e){switch(this._parent(e),this.state){case i.State.INIT:var r=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN],this.view);if(r.length)return this.events=r.slice(),void this.changeState(i.State.OK);break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/TouchGesture",r)}),define("Gestures/TouchGesture",["DS/Gestures/TouchGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/TouchGesture"),e}),define("DS/Gestures/KeyUpGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("KeyUp"),this.priority=0,this.key=0,this},detect:function(e){switch(this._parent(e),this.state){case i.State.INIT:for(var r=0;r<e.length;r++){var n=e[r];if(!n.view||!(n.view.tagName&&"input"===n.view.tagName.toLowerCase()||"true"===n.view.contentEditable)||n.isInView(this.view)){var a=n.getType(),s=n.getState();if("Keyboard"===a){var o=n.getKey();if(s===t.State.END)return this.events=[n],this.key=o,void this.changeState(i.State.OK)}}}break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/KeyUpGesture",r)}),define("Gestures/KeyUpGesture",["DS/Gestures/KeyUpGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/KeyUpGesture"),e}),define("DS/Gestures/MouseOutGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("MouseOut"),this.priority=0,this},detect:function(e){this._parent(e);var r=THREEDS.VisuEventsManager.getMouseEvents();switch(this.state){case i.State.INIT:for(var n=0;n<r.length;n++){var a=r[n];if(a.state===t.State.CANCEL&&a.button===t.MouseButton.NONE)return this.events=[a],void this.changeState(i.State.OK)}break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/MouseOutGesture",r)}),define("Gestures/MouseOutGesture",["DS/Gestures/MouseOutGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/MouseOutGesture"),e}),define("DS/Shaders/DisplayPassShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDiffuse4:{type:"t",value:null},offset:{type:"v2",value:new e.Vector2(.505,.01)},scale:{type:"f",value:.485},offset2:{type:"v2",value:new e.Vector2(.01,.01)},scale2:{type:"f",value:.485},offset3:{type:"v2",value:new e.Vector2(.505,.505)},scale3:{type:"f",value:.485},offset4:{type:"v2",value:new e.Vector2(.01,.505)},scale4:{type:"f",value:.485}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform sampler2D tDiffuse4;","uniform vec2 offset;","uniform float scale;","uniform vec2 offset2;","uniform float scale2;","uniform vec2 offset3;","uniform float scale3;","uniform vec2 offset4;","uniform float scale4;","varying vec2 vUv;","void main() {","gl_FragColor = vec4(0.0);","vec2 vUv2 = (vUv - offset) / scale;","vec2 vUv3 = (vUv - offset2) / scale2;","vec2 vUv4 = (vUv - offset3) / scale3;","vec2 vUv5 = (vUv - offset4) / scale4;","if (vUv2.x > 0.0 && vUv2.y > 0.0 && vUv2.x < 1.0 && vUv2.y < 1.0) {","    gl_FragColor = vec4(texture2D( tDiffuse2, vUv2 ).xyz, 1.0); return;","} else if (vUv3.x > 0.0 && vUv3.y > 0.0 && vUv3.x < 1.0 && vUv3.y < 1.0) {","    gl_FragColor = vec4(texture2D( tDiffuse3, vUv3 ).xyz, 1.0); return;","} else if (vUv4.x > 0.0 && vUv4.y > 0.0 && vUv4.x < 1.0 && vUv4.y < 1.0) {","    vec4 normalDepth = texture2D( tDiffuse4, vUv4 );","    gl_FragColor = vec4(vec3(normalDepth.w), 1.0); return;","} else if (vUv5.x > 0.0 && vUv5.y > 0.0 && vUv5.x < 1.0 && vUv5.y < 1.0) {","    vec4 normalDepth = texture2D( tDiffuse4, vUv5 );","    gl_FragColor = vec4(normalDepth.xyz, 1.0); return;","}","}"].join("\n")}}),define("Shaders/DisplayPassShader",["DS/Shaders/DisplayPassShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/DisplayPassShader"),e}),define("DS/VisuEvents/KeyboardEvent",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent"],function(e,t){"use strict";var i=t.extend({init:function(e,t){return this._parent(t),this.type="Keyboard",this.key=e,this},update:function(e){this._parent(e)},getKey:function(){return this.key}});return UWA.namespace("THREEDS/Events/KeyboardEvent",i)}),define("VisuEvents/KeyboardEvent",["DS/VisuEvents/KeyboardEvent","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuEvents/KeyboardEvent"),e}),define("DS/Effects/DebugPassEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/ReplaceBlendShader","DS/Shaders/DisplayPassShader"],function(e,t,i,r,n,a,s){"use strict";return t.extend({init:function(t,r){this._parent(t);var s=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");return this.composers.push(new i(t,s,r)),this.debugPass=null,this.mixPass=new n(a,void 0,"DebugPassEffect"),this},initEffect:function(e,t){null===this.debugPass&&(this.debugPass=new n(s),this.composers[0].addPass(this.debugPass),null!==t.HighlightEffect?t.HighlightEffect.composers[0].linkToShaderPassUniform(this.debugPass,this.debugPass.uniforms.tDiffuse2):t.composers[0]&&t.composers[0].linkToShaderPassUniform(this.debugPass,this.debugPass.uniforms.tDiffuse2),t.pickingGPUComposerContext||t.initComposer("PickingGPU"),t.pickingGPUComposerContext.linkToShaderPassUniform(this.debugPass,this.debugPass.uniforms.tDiffuse3),t.getComposer("normalDepth").linkToShaderPassUniform(this.debugPass,this.debugPass.uniforms.tDiffuse4));t.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,t,i){},setSize:function(e,t){this._parent(e,t)&&this.composers[0].setSize(this.width,this.height)}})}),define("Effects/DebugPassEffect",["DS/Effects/DebugPassEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/DebugPassEffect"),e}),define("DS/Manipulators/ScreenPlaneManipulator",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator","DS/Visualization/PathElement"],function(e,t,i,r){"use strict";var n=i.extend({init:function(t){var i;return i=this.DEPRECATED_CONSTRUCTOR(arguments)?{cameraName:arguments[1]}:t||{},this._parent(),this.projector=new e.Projector,this.setCameraName(i.cameraName),this},BeginManipulate:function(e,t,i){this._parent(e,t,i),this.initial3dIntersectionPoint=i.position;var r={viewer:t.viewer,eventChannel:"BeginManipulate",event:t,position:this.initial3dIntersectionPoint,paths:this.manipulatedPaths,intersection:i,manipulator:this};this.publish("BeginManipulate",r)},Manipulate:function(t,i,r){this._parent(t,i,r);var n=(new e.Vector2).copy(i.from[0].getCurrentPosition(i.viewer.canvas)),a=i.viewer.currentViewpoint.create3DRayFrom2DPoint(n,i.viewer.currentViewpoint[this.cameraName]),s=i.viewer.currentViewpoint[this.cameraName],o=(new e.Vector3).copy(s.getLookAt()),l=(new e.Plane).setFromNormalAndCoplanarPoint(o.multiplyScalar(-1),this.initial3dIntersectionPoint),c=a.intersectPlane(l),h=(new e.Vector3).subVectors(c,this.initial3dIntersectionPoint),u={viewer:i.viewer,eventChannel:"Manipulate",event:i,paths:this.manipulatedPaths,translationVector:h,intersection:r,manipulator:this};this.publish("Manipulate",u)},EndManipulate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"EndManipulate",event:t,paths:this.manipulatedPaths,intersection:i,manipulator:this};this.publish("EndManipulate",r),this._parent(e,t,i)},BeginPreactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"BeginPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("BeginPreactivate",r)},Preactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"Preactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("Preactivate",r)},EndPreactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"EndPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("EndPreactivate",r)},PrimaryPointerClick:function(e,t,i){var r={viewer:t.viewer,eventChannel:"PrimaryPointerClick",event:t,intersection:i,manipulator:this};this.publish("PrimaryPointerClick",r)},PrimaryPointerDoubleClick:function(e,t,i){var r={viewer:t.viewer,eventChannel:"PrimaryPointerDoubleClick",event:t,intersection:i,manipulator:this};this.publish("PrimaryPointerDoubleClick",r)},setCameraName:function(e){this.cameraName=e||"camera"}});return UWA.namespace("THREEDS/Nodes/ScreenPlaneManipulator",n)}),define("Manipulators/ScreenPlaneManipulator",["DS/Manipulators/ScreenPlaneManipulator","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Manipulators/ScreenPlaneManipulator"),e}),define("DS/Shaders/CompareModelsShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{defines:{POSTPRO:1,MODE:0},uniforms:{tDiffuse:{type:"t",value:null},tCommonColor:{type:"t",value:null},tDepthOld:{type:"t",value:null},tDepthNew:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},tolerance:{type:"f",value:1e-4}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#if (POSTPRO == 1)","uniform sampler2D tDiffuse;","#endif","uniform sampler2D tCommonColor;","uniform sampler2D tDepthOld;","uniform sampler2D tDepthNew;","uniform mat4 realProjectionMatrixInverse;","uniform float tolerance;","varying vec2 vUv;","float getLinearDepth(vec2 iUV, float iDepth) {","vec2 xy = iUV * 2.0 - 1.0;","vec4 posProjected = vec4(xy, 2.0 * iDepth - 1.0, 1.0);","vec4 posVS = realProjectionMatrixInverse * posProjected;","return posVS.z / posVS.w;","}","void main() {","vec4 _common = texture2D(tCommonColor, vUv);","float depthOld = unpackRGBA(texture2D(tDepthOld, vUv));","float depthNew = unpackRGBA(texture2D(tDepthNew, vUv));","#if (MODE == 1)","float isDifferent = step(depthOld*depthNew, 0.0) - step(abs(depthOld) + abs(depthNew), 0.0);","#else","float diff = abs(getLinearDepth(vUv, depthOld) - getLinearDepth(vUv, depthNew));","float isDifferent = step(tolerance, diff);","#endif","#if (POSTPRO == 1)","vec4 color = texture2D(tDiffuse, vUv);","gl_FragColor = mix(vec4(mix(color.rgb, _common.rgb, _common.a), color.a), color, isDifferent);","#else","gl_FragColor = vec4(_common.rgb, _common.a * (1.0 - isDifferent));","#endif","}"].join("\n")}}),define("Shaders/CompareModelsShader",["DS/Shaders/CompareModelsShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/CompareModelsShader"),e}),define("DS/Gestures/PinchPanRotateGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("PinchPanRotate"),this.priority=10,this.touches=[],this.fingersVector=new e.Vector2,this.distance=null,this.lastDistance=0,this.orientation=null,this.lastOrientation=0,this.deltaOrientation=0,this},detect:function(e){if(this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE,t.State.END],this.view),2===this.touches.length){this.fingersVector.subVectors(this.touches[1].getCurrentPosition(this.view),this.touches[0].getCurrentPosition(this.view)),null===this.distance&&(this.distance=this.fingersVector.length()),null===this.orientation&&(this.orientation=Math.atan2(this.fingersVector.y,this.fingersVector.x)),this.lastDistance=this.distance,this.distance=this.fingersVector.length(),this.lastOrientation=this.orientation,this.orientation=Math.atan2(this.fingersVector.y,this.fingersVector.x),this.deltaOrientation=this.orientation-this.lastOrientation;var r=this.deltaOrientation>=0?1:-1;r*=2*Math.PI,Math.abs(this.deltaOrientation-r)<Math.abs(this.deltaOrientation)&&(this.deltaOrientation-=r)}switch(this.state){case i.State.INIT:this.distance=null,this.orientation=null,this.touches.length>0&&this.changeState(i.State.BEGIN);break;case i.State.BEGIN:if(2===this.touches.length)(n=e[0].getJSEvent()).preventDefault&&n.preventDefault(),this.events=this.touches,this.changeState(i.State.CHANGE);break;case i.State.CHANGE:if(2===this.touches.length){var n;(n=e[0].getJSEvent()).preventDefault&&n.preventDefault();var a=this.touches[0].getState()===t.State.END||this.touches[1].getState()===t.State.END;this.events=this.touches,this.changeState(i.State.CHANGE,a)}else this.changeState(i.State.KO);break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT),this.touches=[],this.distance=null,this.orientation=null}},getAngle:function(){return this.orientation||0},getDeltaAngle:function(){return this.deltaOrientation}});return UWA.namespace("THREEDS/Gestures/PinchPanRotateGesture",r)}),define("Gestures/PinchPanRotateGesture",["DS/Gestures/PinchPanRotateGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/PinchPanRotateGesture"),e}),define("DS/Effects/CompareModelsEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ComposerContext","DS/Plugins/ClearPass","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/CompareModelsShader","DS/Visualization/RenderMode"],function(e,t,i,r,n,a,s,o){"use strict";return t.extend({init:function(e,t){return this._parent(e),this.mixPass=new a(s,void 0,"compareModelPass"),this.mixPass.compileShader(e),this.tolerance=.02,this.composerEffects=[],this.forwardContext=null,this.passClearOld=null,this.passColorOld=null,this.passDepthOld=null,this.passDepthNew=null,this.passAll=null,this.passSectionCappingFrontFaces1=null,this.passSectionCappingFrontFaces2=null,this.passSectionCappingFrontFaces3=null,this.v6renderer=null,this.forwardPass=null,this},initEffect:function(t,a){a.compareSettings&&(this.tolerance=a.compareSettings.tolerance);var s=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");s.generateMipmaps=!1;var l=new i(s,a.mainComposer,"colorOldComposerContext");l.keepResult=!0;var c=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");c.generateMipmaps=!1;var h=new i(c,a.mainComposer,"depthOldComposerContext");h.keepResult=!0;var u=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");u.generateMipmaps=!1;var d=new i(u,a.mainComposer,"depthNewComposerContext");d.keepResult=!0,this.composerEffects.push(l),this.composerEffects.push(h),this.composerEffects.push(d),a.customComposerContexts=[],a.customComposerContexts[0]=l,a.customComposerContexts[1]=h,a.customComposerContexts[2]=d;var p=new r("depth_clear_old");p.clearColor=new e.Color(0),p.clearAlpha=0,p.disabledByDefault=!0,this.passClearOld=p;var f=new n(null,null,null,o.facesMask,!1,!1,"color_old");f.idString="compareOld",f.disabledByDefault=!0,this.passColorOld=f;var m=new n(null,null,null,o.facesMask,!1,!1,"depth_old");m.idString="compareOld",m.disabledByDefault=!0,m.setMaterialToUse(e.MaterialToUse.depthRGBAMaterial),this.passDepthOld=m;var g=new n(null,null,null,o.facesMask,!1,!1,"depth_new");g.idString="compareNew",g.disabledByDefault=!0,g.setMaterialToUse(e.MaterialToUse.depthRGBAMaterial),this.passDepthNew=g;var v=new n(null,null,null,o.facesMask,!1,!1,"all_models");v.disabledByDefault=!0,this.passAll=v,this.passSectionCappingFrontFaces1=new n(null,null,null,o.facesMask,!1,!1,"colorOldCapping"),this.passSectionCappingFrontFaces1.setRenderCuttingElements(!0),this.passSectionCappingFrontFaces1.idString="compareOld",this.passSectionCappingFrontFaces1.setEnableStencilTest(!0),this.passSectionCappingFrontFaces1.setEnableStencilWrite(!0),this.passSectionCappingFrontFaces1.setDisableColorWrite(!0),this.passSectionCappingFrontFaces1.setDisableDepthWrite(!0),this.passSectionCappingFrontFaces1.setStencilFunc("ALWAYS"),this.passSectionCappingFrontFaces1.setStencilOps("INCR_WRAP","DECR_WRAP"),this.passSectionCappingFrontFaces1.setDisableBackFaceCulling(!0),this.passSectionCappingFrontFaces1.setHideSurfacesAndUnclippedMeshes(!0),this.passSectionCappingFrontFaces1.setDisableBackFaceClipPlanes(1),this.passSectionCappingFrontFaces1.setRenderPluginsPre(!1),this.passSectionCappingFrontFaces1.setRenderPluginsPost(!1),this.passSectionCappingFrontFaces1.ignoreNoZ=!0,this.passSectionCappingFrontFaces1.scene=a.scene,this.passSectionCappingFrontFaces1.disabledByDefault=!0,this.passSectionCappingFrontFaces2=new n(null,null,null,o.facesMask,!1,!1,"depthOldCapping"),this.passSectionCappingFrontFaces2.setRenderCuttingElements(!0),this.passSectionCappingFrontFaces2.idString="compareOld",this.passSectionCappingFrontFaces2.setEnableStencilTest(!0),this.passSectionCappingFrontFaces2.setEnableStencilWrite(!0),this.passSectionCappingFrontFaces2.setDisableColorWrite(!0),this.passSectionCappingFrontFaces2.setDisableDepthWrite(!0),this.passSectionCappingFrontFaces2.setStencilFunc("ALWAYS"),this.passSectionCappingFrontFaces2.setStencilOps("INCR_WRAP","DECR_WRAP"),this.passSectionCappingFrontFaces2.setDisableBackFaceCulling(!0),this.passSectionCappingFrontFaces2.setHideSurfacesAndUnclippedMeshes(!0),this.passSectionCappingFrontFaces2.setDisableBackFaceClipPlanes(1),this.passSectionCappingFrontFaces2.setRenderPluginsPre(!1),this.passSectionCappingFrontFaces2.setRenderPluginsPost(!1),this.passSectionCappingFrontFaces2.ignoreNoZ=!0,this.passSectionCappingFrontFaces2.scene=a.scene,this.passSectionCappingFrontFaces2.setMaterialToUse(e.MaterialToUse.depthRGBAMaterial),this.passSectionCappingFrontFaces2.disabledByDefault=!0,this.passSectionCappingFrontFaces3=new n(null,null,null,o.facesMask,!1,!1,"depthNewCapping"),this.passSectionCappingFrontFaces3.setRenderCuttingElements(!0),this.passSectionCappingFrontFaces3.idString="compareNew",this.passSectionCappingFrontFaces3.setEnableStencilTest(!0),this.passSectionCappingFrontFaces3.setEnableStencilWrite(!0),this.passSectionCappingFrontFaces3.setDisableColorWrite(!0),this.passSectionCappingFrontFaces3.setDisableDepthWrite(!0),this.passSectionCappingFrontFaces3.setStencilFunc("ALWAYS"),this.passSectionCappingFrontFaces3.setStencilOps("INCR_WRAP","DECR_WRAP"),this.passSectionCappingFrontFaces3.setDisableBackFaceCulling(!0),this.passSectionCappingFrontFaces3.setHideSurfacesAndUnclippedMeshes(!0),this.passSectionCappingFrontFaces3.setDisableBackFaceClipPlanes(1),this.passSectionCappingFrontFaces3.setRenderPluginsPre(!1),this.passSectionCappingFrontFaces3.setRenderPluginsPost(!1),this.passSectionCappingFrontFaces3.ignoreNoZ=!0,this.passSectionCappingFrontFaces3.scene=a.scene,this.passSectionCappingFrontFaces3.setMaterialToUse(e.MaterialToUse.depthRGBAMaterial),this.passSectionCappingFrontFaces3.disabledByDefault=!0,a.mainComposer.insertCustomPassAfterPass(p,null),a.mainComposer.insertCustomPassAfterPass(f,p),a.mainComposer.insertCustomPassAfterPass(this.passSectionCappingFrontFaces1,f),a.mainComposer.insertCustomPassAfterPass(m,this.passSectionCappingFrontFaces1),a.mainComposer.insertCustomPassAfterPass(this.passSectionCappingFrontFaces2,m),a.mainComposer.insertCustomPassAfterPass(g,this.passSectionCappingFrontFaces2),a.mainComposer.insertCustomPassAfterPass(this.passSectionCappingFrontFaces3,g),a.mainComposer.insertCustomPassAfterPass(v,this.passSectionCappingFrontFaces3),this.v6renderer=a,this.forwardContext=a.compForwardComposerContext,this.forwardPass=a.forwardPass,t&&(this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0),a.insertComposer(null,this.mixPass),l.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tCommonColor),h.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDepthOld),d.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDepthNew)},update:function(e,t,i){var r=!!this.v6renderer.clippingScene;this.composerEffects[0].enablePass(this.passSectionCappingFrontFaces1,r),this.composerEffects[1].enablePass(this.passSectionCappingFrontFaces2,r),this.composerEffects[2].enablePass(this.passSectionCappingFrontFaces3,r);var n=i._renderedCamera;n.projectionMatrixInverse.getInverse(n.projectionMatrix),this.mixPass.uniforms.realProjectionMatrixInverse.value=n.projectionMatrixInverse,this.mixPass.uniforms.tolerance.value=this.tolerance},setTolerance:function(e){this.tolerance=e},set2DMode:function(e){e!==this.is2DMode&&(this.is2DMode=e,this.mixPass.defines.MODE=this.is2DMode?1:0,this.mixPass.compileShader(this.renderer))},setSize:function(e,t){if(this._parent(e,t))for(var i=0;i<this.composerEffects.length;i++)this.composerEffects[i].setSize(e,t)},setEnabled:function(e){this._parent(e);var t=!!this.v6renderer.clippingScene;this.composerEffects[0].setPassClear(this.passClearOld,e),this.composerEffects[0].setPassClearDepth(this.passClearOld,e),this.composerEffects[0].enablePass(this.passClearOld,e),this.composerEffects[0].enablePass(this.passColorOld,e),this.composerEffects[0].enablePass(this.passSectionCappingFrontFaces1,t&&e),this.composerEffects[1].setPassClear(this.passClearOld,e),this.composerEffects[1].setPassClearDepth(this.passClearOld,e),this.composerEffects[1].enablePass(this.passClearOld,e),this.composerEffects[1].enablePass(this.passDepthOld,e),this.composerEffects[1].enablePass(this.passSectionCappingFrontFaces2,t&&e),this.composerEffects[2].setPassClear(this.passClearOld,e),this.composerEffects[2].setPassClearDepth(this.passClearOld,e),this.composerEffects[2].enablePass(this.passClearOld,e),this.composerEffects[2].enablePass(this.passDepthNew,e),this.composerEffects[2].enablePass(this.passSectionCappingFrontFaces3,t&&e);for(var i=0;i<3;i++)this.composerEffects[i].enablePass(this.forwardPass,!1),this.composerEffects[i].needsUpdate=e,this.composerEffects[i].enablePass(this.v6renderer.infPlanePass,!1),this.composerEffects[i].enablePass(this.v6renderer.mirrorBlendPass,!1)}})}),define("Effects/CompareModelsEffect",["DS/Effects/CompareModelsEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/CompareModelsEffect"),e}),define("DS/Gestures/DoublePinchTapGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=new e.Vector2,n=new e.Vector2,a=i.extend({init:function(){return this._parent("DoublePinchTap"),this.priority=100,this.currentTime=0,this.maxTime=600,this.maxDistance=20,this.lastTapTime=0,this.lastTapPosition1=new e.Vector2,this.lastTapPosition2=new e.Vector2,this},detect:function(e){this._parent(e);var t=this.gestures[0];if(t)switch(this.currentTime=(new Date).getTime(),this.state){case i.State.INIT:t.getState()===i.State.OK&&(this.lastTapTime=this.currentTime,this.lastTapPosition1.copy(t.events[0].currentPosition),this.lastTapPosition2.copy(t.events[1].currentPosition),this.changeState(i.State.BEGIN));break;case i.State.BEGIN:if(t.getState()===i.State.OK){r.copy(this.lastTapPosition1),n.copy(this.lastTapPosition2);var a=this.lastTapPosition1.sub(t.events[0].currentPosition).length(),s=r.sub(t.events[1].currentPosition).length(),o=this.lastTapPosition2.sub(t.events[0].currentPosition).length(),l=n.sub(t.events[1].currentPosition).length();this.currentTime-this.lastTapTime<this.maxTime&&(a<this.maxDistance||s<this.maxDistance)&&(o<this.maxDistance||l<this.maxDistance)?(this.events=t.getEvents(),this.changeState(i.State.OK)):(this.lastTapTime=this.currentTime,this.lastTapPosition1.copy(t.events[0].currentPosition),this.lastTapPosition2.copy(t.events[1].currentPosition))}break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/DoublePinchTapGesture",a)}),define("Gestures/DoublePinchTapGesture",["DS/Gestures/DoublePinchTapGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/DoublePinchTapGesture"),e}),define("DS/Gestures/MouseUpGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(e){return this._parent(t.printMouseButton(e)+"MouseUp"),this.priority=0,this.button=e,this},detect:function(e){switch(this._parent(e),this.state){case i.State.INIT:var r=THREEDS.VisuEventsManager.getMouseEventsByStates([t.State.END],this.button,this.view);if(r.length){var n=r[0];return this.events=[n],void this.changeState(i.State.OK)}break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/MouseUpGesture",r)}),define("Gestures/MouseUpGesture",["DS/Gestures/MouseUpGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/MouseUpGesture"),e}),define("DS/Gestures/DoubleClickGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(i){return this._parent(t.printMouseButton(i)+"DoubleClick"),this.priority=100,this.button=i,this.currentTime=0,this.maxTime=300,this.maxDistance=15,this.lastClickTime=0,this.lastClickPosition=new e.Vector2,this},detect:function(e){this._parent(e);var t=this.gestures[0];if(t)switch(this.currentTime=(new Date).getTime(),this.state){case i.State.INIT:t.getState()===i.State.OK&&(this.lastClickTime=this.currentTime,this.lastClickPosition.copy(t.events[0].currentPosition),this.changeState(i.State.BEGIN));break;case i.State.BEGIN:t.getState()===i.State.OK&&(this.currentTime-this.lastClickTime<this.maxTime&&this.lastClickPosition.sub(t.events[0].currentPosition).length()<this.maxDistance?(this.events=t.getEvents(),this.changeState(i.State.OK)):(this.lastClickTime=this.currentTime,this.lastClickPosition.copy(t.events[0].currentPosition)));break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/DoubleClickGesture",r)}),define("Gestures/DoubleClickGesture",["DS/Gestures/DoubleClickGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/DoubleClickGesture"),e}),define("DS/Gestures/HoldMouseDownGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture","DS/Gestures/MouseDownGesture","DS/WebRecordEnabler/Adapter"],function(e,t,i,r,n){"use strict";var a=i.extend({init:function(e,i){return this._parent("Hold"+t.printMouseButton(e)+"MouseDown"),this.priority=10,this.button=e,this.maxTime=i||THREEDS.VisuEventsManager.getHoldTime(),this.maxDistance=10,this.timer=null,this},detect:function(e){this._parent(e);var r=THREEDS.VisuEventsManager.getMouseEvents(null,this.view),a=this;switch(this.state){case i.State.INIT:for(var s=0;s<r.length;s++){var o=r[s];if(o.state===t.State.BEGIN&&o.button===this.button)return this.resetTimer(),this.evt=o,n.isReplaying()||(this.timer=setTimeout(function(){a.events=[o],a.changeState(i.State.OK),a.execute(!0)},this.maxTime)),void this.changeState(i.State.BEGIN)}break;case i.State.BEGIN:(null===this.evt||this.evt.state===t.State.END||this.evt.state===t.State.MOVE&&this.evt.offsetPosition.length()>this.maxDistance)&&(this.resetTimer(),this.changeState(i.State.KO));break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}},resetTimer:function(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null)}});return UWA.namespace("THREEDS/Gestures/HoldMouseDownGesture",a)}),define("Gestures/HoldMouseDownGesture",["DS/Gestures/HoldMouseDownGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/HoldMouseDownGesture"),e}),define("DS/Effects/FXAAEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ShaderPass","DS/Shaders/FXAAShader"],function(e,t,i,r){"use strict";return t.extend({init:function(e){return this._parent(e),this.mixPass=new i(r.FXAAShader,void 0,"FXAAEffect"),this},initEffect:function(e,t){t.insertComposer(null,this.mixPass)},update:function(e,t,i){},setSize:function(e,t){this._parent(e,t)&&this.mixPass.uniforms.resolution.value.set(1/e,1/t)}})}),define("Effects/FXAAEffect",["DS/Effects/FXAAEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/FXAAEffect"),e}),define("DS/VisuLoaders/ColladaLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Visualization/ProxyAbstraction"],function(e,t,i){var r=function(){var r,n,a,s,o,l,c=null,h=null,u=null,d={},p={},f={},m={},g={},v={},S={},_={},y=e.SmoothShading,x={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null,waitMaterial:new e.MeshPhongMaterial({color:new e.Color(16777215)})},M=1,P="Y",C=null;function b(t,i,d){if(c=t,i=i||u,void 0!==d){var y=d.split("/");y.pop(),s=(y.length<1?".":y.join("/"))+"/"}!function(){var e=c.evaluate("//dae:asset",c,fe,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext();if(e&&e.childNodes)for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"unit":var r=i.getAttribute("meter");r&&(M=parseFloat(r));break;case"up_axis":P=i.textContent.charAt(0)}}}(),function(){if(x.convertUpAxis&&P!==x.upAxis)switch(P){case"X":C="Y"===x.upAxis?"XtoY":"XtoZ";break;case"Y":C="X"===x.upAxis?"YtoX":"YtoZ";break;case"Z":C="X"===x.upAxis?"ZtoX":"ZtoY"}else C=null}(),p=D("//dae:library_images/dae:image",N,"image"),v=D("//dae:library_materials/dae:material",ee,"material"),S=D("//dae:library_effects/dae:effect",ae,"effect"),g=D("//dae:library_geometries/dae:geometry",j,"geometry"),_=D(".//dae:library_cameras/dae:camera",ue,"camera"),m=D("//dae:library_controllers/dae:controller",F,"controller"),f=D("//dae:library_animations/dae:animation",oe,"animation"),a=D(".//dae:library_visual_scenes/dae:visual_scene",B,"visual_scene"),o=[],l=[],r=function(){var e=c.evaluate(".//dae:scene/dae:instance_visual_scene",c,fe,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext();if(e){var t=e.getAttribute("url").replace(/^#/,"");return a[t.length>0?t:"visual_scene0"]}return null}(),h=new e.Object3D;for(var b=0;b<r.nodes.length;b++)h.add(I(r.nodes[b]));h.scale.multiplyScalar(M),n=[],function e(t){var i=r.getChildById(t.name,!0),a=null;if(i&&i.keys){a={fps:60,hierarchy:[{node:i,keys:i.keys,sids:i.sids}],node:t,name:"animation_"+t.name,length:0},n.push(a);for(var s=0,o=i.keys.length;s<o;s++)a.length=Math.max(a.length,i.keys[s].time)}else a={hierarchy:[{keys:[],sids:[]}]};for(var s=0,o=t.children.length;s<o;s++)for(var l=e(t.children[s]),c=0,h=l.hierarchy.length;c<h;c++)a.hierarchy.push({keys:[],sids:[]});return a}(h);var w={scene:h,morphs:o,skins:l,animations:n,dae:{images:p,materials:v,cameras:_,effects:S,geometries:g,controllers:m,animations:f,visualScenes:a,scene:r}};return i&&i(w),w}function D(e,t,i){for(var r=c.evaluate(e,c,fe,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null),n={},a=r.iterateNext(),s=0;a;){var o=(new t).parse(a);o.id&&0!=o.id.length||(o.id=i+s++),n[o.id]=o,a=r.iterateNext()}return n}function w(e,t){var i=t instanceof z?m[t.url]:t;if(i&&i.morph)for(var r=i.morph,n=0;n<r.targets.length;n++){var a=r.targets[n],s=g[a];if(s.mesh&&s.mesh.primitives&&s.mesh.primitives.length)s.mesh.primitives[0].geometry}else console.log("could not find morph controller!")}function E(t,i,r,n){if(t.world=t.world||new e.Matrix4,t.world.copy(t.matrix),t.channels&&t.channels.length){var a=t.channels[0].sampler.output[r];a instanceof e.Matrix4&&t.world.copy(a)}n&&t.world.multiplyMatrices(n,t.world),i.push(t);for(var s=0;s<t.nodes.length;s++)E(t.nodes[s],i,r,t.world)}function T(t,i){for(var r=0;r<t.length;r++){var n=t[r],a=-1;if("JOINT"==n.type){for(var s=0;s<i.joints.length;s++)if(n.sid==i.joints[s]){a=s;break}if(!(a>=0))throw"ColladaLoader: Could not find joint '"+n.sid+"'.";var o=i.invBindMatrices[a];n.invBindMatrix=o,n.skinningMatrix=new e.Matrix4,n.skinningMatrix.multiplyMatrices(n.world,o),n.weights=[];for(s=0;s<i.weights.length;s++)for(var l=0;l<i.weights[s].length;l++){var c=i.weights[s][l];c.joint==a&&n.weights.push(c)}}}}function A(t,i,n){var a=m[i.url];if(n=void 0!==n?n:40,a&&a.skin)if(i.skeleton&&i.skeleton.length){var s,o,l,c,h,u,d,p=function(){var e=1e6,t=-e,i=0;for(var r in f)for(var n=f[r],a=0;a<n.sampler.length;a++){var s=n.sampler[a];s.create(),e=Math.min(e,s.startTime),t=Math.max(t,s.endTime),i=Math.max(i,s.input.length)}return{start:e,end:t,frames:i}}(),g=r.getChildById(i.skeleton[0],!0)||r.getChildBySid(i.skeleton[0],!0),v=new e.Vector3;for(s=0;s<t.vertices.length;s++)t.vertices[s].applyMatrix4(a.skin.bindShapeMatrix);for(n=0;n<p.frames;n++){var S=[],_=[];for(s=0;s<t.vertices.length;s++)_.push(new e.Vector3);for(E(g,S,n),T(S,a.skin),s=0;s<S.length;s++)if("JOINT"==S[s].type)for(o=0;o<S[s].weights.length;o++)c=(l=S[s].weights[o]).index,h=l.weight,u=t.vertices[c],d=_[c],v.x=u.x,v.y=u.y,v.z=u.z,v.applyMatrix4(S[s].skinningMatrix),d.x+=v.x*h,d.y+=v.y*h,d.z+=v.z*h}}else console.log("ColladaLoader: Could not find the skeleton for the skin. ");else console.log("ColladaLoader: Could not find skin controller.")}function I(t,i){var r,n,a,s,c=new e.Object3D;for(a=0;a<t.controllers.length;a++){var h=m[t.controllers[a].url];switch(h.type){case"skin":if(g[h.skin.source])(d=new W).url=h.skin.source,d.instance_material=t.controllers[a].instance_material,t.geometries.push(d),!0,r=t.controllers[a];else if(m[h.skin.source]){var u=m[h.skin.source];if(n=u,u.morph&&g[u.morph.source])(d=new W).url=u.morph.source,d.instance_material=t.controllers[a].instance_material,t.geometries.push(d)}break;case"morph":var d;if(g[h.morph.source])(d=new W).url=h.morph.source,d.instance_material=t.controllers[a].instance_material,t.geometries.push(d),n=t.controllers[a];console.log("ColladaLoader: Morph-controller partially supported.")}}var p={};for(a=0;a<t.geometries.length;a++){var f,y=t.geometries[a],M=y.instance_material,P=g[y.url],C={},b=[],D=0;if(P){if(!P.mesh||!P.mesh.primitives)continue;if(0==c.name.length&&(c.name=P.id),M)for(s=0;s<M.length;s++){var E=M[s],T=v[E.target],R=T.instance_effect.url,L=S[R].shader.material;if(P.doubleSided){if(!(L in p)){var O=L.clone();O.side=e.DoubleSide,p[L]=O}L=p[L]}L.opacity=L.opacity?L.opacity:1,C[E.symbol]=D,b.push(L),(f=L).name=null==T.name||""===T.name?T.id:T.name,D++}var N,F=f||new e.MeshLambertMaterial({color:14540253,shading:e.FlatShading,side:P.doubleSided?e.DoubleSide:e.FrontSide}),V=P.mesh.geometry3js;if(D>1)for(F=new e.MeshFaceMaterial(b),s=0;s<V.faces.length;s++){var U=V.faces[s];U.materialIndex=C[U.daeMaterial]}void 0!==r?(A(V,r),F.morphTargets=!0,(N=new e.SkinnedMesh(V,F,!1)).skeleton=r.skeleton,N.skinController=m[r.url],N.skinInstanceController=r,N.name="skin_"+l.length,l.push(N)):void 0!==n?(w(0,n),F.morphTargets=!0,(N=new e.Mesh(V,F)).name="morph_"+o.length,o.push(N)):N=new e.Mesh(V,F),t.geometries.length>1?c.add(N):c=N}}for(a=0;a<t.cameras.length;a++){var B=t.cameras[a],k=_[B.url];c=new e.PerspectiveCamera(k.fov,k.aspect_ratio,k.znear,k.zfar)}c.name=t.name||t.id||"",c.matrix=t.matrix;var G=t.matrix.decompose();if(c.position=G[0],c.quaternion=G[1],c.useQuaternion=!0,c.scale=G[2],x.centerGeometry&&c.geometry){var z=e.GeometryUtils.center(c.geometry);z.multiply(c.scale),z.applyQuaternion(c.quaternion),c.position.sub(z)}for(a=0;a<t.nodes.length;a++)c.add(I(t.nodes[a],t));return c}function R(e,t){for(var i=null,r=0,n=e.length;r<n&&null==i;r++){var a=e[r];if(a.time===t)i=a;else if(a.time>t)break}return i}function L(e,t){for(var i=-1,r=0,n=e.length;r<n&&-1==i;r++){e[r].time>=t&&(i=r)}return i}function O(e,t,i,r){var n=function(e,t,i){for(i=i>=0?i:i+e.length;i>=0;i--){var r=e[i];if(r.hasTarget(t))return r}return null}(e,r,i?i-1:0),a=function(e,t,i){for(;i<e.length;i++){var r=e[i];if(r.hasTarget(t))return r}return null}(e,r,i+1);if(n&&a){var s,o=(t.time-n.time)/(a.time-n.time),l=n.getTarget(r),c=a.getTarget(r).data,h=l.data;if("matrix"===l.type)s=h;else if(h.length){s=[];for(var u=0;u<h.length;++u)s[u]=h[u]+(c[u]-h[u])*o}else s=h+(c-h)*o;t.addTarget(r,l.transform,l.member,s)}}function N(){this.id="",this.init_from=""}function F(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function V(){this.method=null,this.source=null,this.targets=null,this.weights=null}function U(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function B(){this.id="",this.name="",this.nodes=[],this.scene=new e.Object3D}function k(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new e.Matrix4}function G(){this.sid="",this.type="",this.data=[],this.obj=null}function z(){this.url="",this.skeleton=[],this.instance_material=[]}function H(){this.symbol="",this.target=""}function W(){this.url="",this.instance_material=[]}function j(){this.id="",this.mesh=null}function X(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function q(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new e.Geometry}function Z(){q.call(this),this.vcount=[]}function Y(){q.call(this),this.vcount=3}function K(){this.source="",this.count=0,this.stride=0,this.params=[]}function J(){this.input={}}function Q(){this.semantic="",this.offset=0,this.source="",this.set=0}function $(e){this.id=e,this.type=null}function ee(){this.id="",this.name="",this.instance_effect=null}function te(){this.color=new e.Color(0),this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function ie(e,t){this.type=e,this.effect=t,this.material=null}function re(e){this.effect=e,this.init_from=null,this.format=null}function ne(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function ae(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function se(){this.url=""}function oe(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function le(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function ce(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function he(e){this.targets=[],this.time=e}function ue(){this.id="",this.name="",this.technique=""}function de(){this.url=""}function pe(e){var t=e.getAttribute("id");return null!=d[t]?d[t]:(d[t]=new $(t).parse(e),d[t])}function fe(e){return"dae"==e?"http://www.collada.org/2005/11/COLLADASchema":null}function me(e){for(var t=Se(e),i=[],r=0,n=t.length;r<n;r++)i.push("true"==t[r]||"1"==t[r]);return i}function ge(e){for(var t=Se(e),i=[],r=0,n=t.length;r<n;r++)i.push(parseFloat(t[r]));return i}function ve(e){for(var t=Se(e),i=[],r=0,n=t.length;r<n;r++)i.push(parseInt(t[r],10));return i}function Se(e){return e.length>0?function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}(e).split(/\s+/):[]}function _e(e,t,i){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):i}function ye(e,t){for(var i=c.evaluate(t,e,fe,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null),r=i.iterateNext(),n=[];r;)n.push(r),r=i.iterateNext();return n}function xe(e,t){e.doubleSided=!1;var i=c.evaluate(".//dae:extra//dae:double_sided",t,fe,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);i&&(i=i.iterateNext())&&1===parseInt(i.textContent,10)&&(e.doubleSided=!0)}function Me(e,t){if(x.convertUpAxis&&P!==x.upAxis)switch(C){case"XtoY":var i=e[0];e[0]=t*e[1],e[1]=i;break;case"XtoZ":i=e[2];e[2]=e[1],e[1]=e[0],e[0]=i;break;case"YtoX":i=e[0];e[0]=e[1],e[1]=t*i;break;case"YtoZ":i=e[1];e[1]=t*e[2],e[2]=i;break;case"ZtoX":i=e[0];e[0]=e[1],e[1]=e[2],e[2]=i;break;case"ZtoY":i=e[1];e[1]=e[2],e[2]=t*i}}function Pe(t,i){var r=[t[i],t[i+1],t[i+2]];return Me(r,-1),new e.Vector3(r[0],r[1],r[2])}function Ce(t){if(x.convertUpAxis){var i=[t[0],t[4],t[8]];Me(i,-1),t[0]=i[0],t[4]=i[1],t[8]=i[2],Me(i=[t[1],t[5],t[9]],-1),t[1]=i[0],t[5]=i[1],t[9]=i[2],Me(i=[t[2],t[6],t[10]],-1),t[2]=i[0],t[6]=i[1],t[10]=i[2],Me(i=[t[0],t[1],t[2]],-1),t[0]=i[0],t[1]=i[1],t[2]=i[2],Me(i=[t[4],t[5],t[6]],-1),t[4]=i[0],t[5]=i[1],t[6]=i[2],Me(i=[t[8],t[9],t[10]],-1),t[8]=i[0],t[9]=i[1],t[10]=i[2],Me(i=[t[3],t[7],t[11]],-1),t[3]=i[0],t[7]=i[1],t[11]=i[2]}return new e.Matrix4(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])}function be(e){if(e>-1&&e<3){e={X:0,Y:1,Z:2}[e=De(["X","Y","Z"][e])]}return e}function De(e){if(x.convertUpAxis)switch(e){case"X":switch(C){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z"}break;case"Y":switch(C){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z"}break;case"Z":switch(C){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y"}}return e}return N.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];"init_from"==i.nodeName&&(this.init_from=i.textContent)}return this},F.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"skin":this.skin=(new U).parse(i),this.type=i.nodeName;break;case"morph":this.morph=(new V).parse(i),this.type=i.nodeName}}return this},V.prototype.parse=function(e){var t,i={},r=[];for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(1==n.nodeType)switch(n.nodeName){case"source":i[(s=(new $).parse(n)).id]=s;break;case"targets":r=this.parseInputs(n);break;default:console.log(n.nodeName)}}for(t=0;t<r.length;t++){var a=r[t],s=i[a.source];switch(a.semantic){case"MORPH_TARGET":this.targets=s.read();break;case"MORPH_WEIGHT":this.weights=s.read()}}return this},V.prototype.parseInputs=function(e){for(var t=[],i=0;i<e.childNodes.length;i++){var r=e.childNodes[i];if(1==r.nodeType)switch(r.nodeName){case"input":t.push((new Q).parse(r))}}return t},U.prototype.parse=function(e){var t,i,r={};this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var n=0;n<e.childNodes.length;n++){var a=e.childNodes[n];if(1==a.nodeType)switch(a.nodeName){case"bind_shape_matrix":var s=ge(a.textContent);this.bindShapeMatrix=Ce(s);break;case"source":var o=(new $).parse(a);r[o.id]=o;break;case"joints":t=a;break;case"vertex_weights":i=a;break;default:console.log(a.nodeName)}}return this.parseJoints(t,r),this.parseWeights(i,r),this},U.prototype.parseJoints=function(e,t){for(var i=0;i<e.childNodes.length;i++){var r=e.childNodes[i];if(1==r.nodeType)switch(r.nodeName){case"input":var n=(new Q).parse(r),a=t[n.source];"JOINT"==n.semantic?this.joints=a.read():"INV_BIND_MATRIX"==n.semantic&&(this.invBindMatrices=a.read())}}},U.prototype.parseWeights=function(e,t){for(var i,r,n=[],a=0;a<e.childNodes.length;a++){var s=e.childNodes[a];if(1==s.nodeType)switch(s.nodeName){case"input":n.push((new Q).parse(s));break;case"v":i=ve(s.textContent);break;case"vcount":r=ve(s.textContent)}}var o=0;for(a=0;a<r.length;a++){for(var l=r[a],c=[],h=0;h<l;h++){for(var u={},d=0;d<n.length;d++){var p=n[d],f=i[o+p.offset];switch(p.semantic){case"JOINT":u.joint=f;break;case"WEIGHT":u.weight=t[p.source].data[f]}}c.push(u),o+=n.length}for(h=0;h<c.length;h++)c[h].index=a;this.weights.push(c)}},B.prototype.getChildById=function(e,t){for(var i=0;i<this.nodes.length;i++){var r=this.nodes[i].getChildById(e,t);if(r)return r}return null},B.prototype.getChildBySid=function(e,t){for(var i=0;i<this.nodes.length;i++){var r=this.nodes[i].getChildBySid(e,t);if(r)return r}return null},B.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"node":this.nodes.push((new k).parse(i))}}return this},k.prototype.getChannelForTransform=function(e){for(var t=0;t<this.channels.length;t++){var i,r=this.channels[t],n=r.target.split("/"),a=(n.shift(),n.shift()),s=a.indexOf(".")>=0,o=a.indexOf("(")>=0;if(s)n=a.split("."),a=n.shift(),n.shift();else if(o){i=a.split("("),a=i.shift();for(var l=0;l<i.length;l++)i[l]=parseInt(i[l].replace(/\)/,""))}if(a==e)return r.info={sid:a,dotSyntax:s,arrSyntax:o,arrIndices:i},r}return null},k.prototype.getChildById=function(e,t){if(this.id==e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var r=this.nodes[i].getChildById(e,t);if(r)return r}return null},k.prototype.getChildBySid=function(e,t){if(this.sid==e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var r=this.nodes[i].getChildBySid(e,t);if(r)return r}return null},k.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++)if(this.transforms[t].sid==e)return this.transforms[t];return null},k.prototype.parse=function(t){var i,r;this.id=t.getAttribute("id"),this.sid=t.getAttribute("sid"),this.name=t.getAttribute("name"),this.type=t.getAttribute("type"),this.type="JOINT"==this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.controllers=[],this.matrix=new e.Matrix4;for(var n=0;n<t.childNodes.length;n++){var a=t.childNodes[n];if(1==a.nodeType)switch(a.nodeName){case"node":this.nodes.push((new k).parse(a));break;case"instance_camera":this.cameras.push((new de).parse(a));break;case"instance_controller":this.controllers.push((new z).parse(a));break;case"instance_geometry":this.geometries.push((new W).parse(a));break;case"instance_light":break;case"instance_node":i=a.getAttribute("url").replace(/^#/,"");var s=(r=i,c.evaluate(".//dae:library_nodes//dae:node[@id='"+r+"']",c,fe,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext());s&&this.nodes.push((new k).parse(s));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new G).parse(a));break;case"extra":break;default:console.log(a.nodeName)}}return this.channels=function(e){var t=[],i=1e6,r=-1e6;for(var n in f)for(var a=f[n],s=0;s<a.channel.length;s++){var o=a.channel[s],l=a.sampler[s];(n=o.target.split("/")[0])==e.id&&(l.create(),o.sampler=l,i=Math.min(i,l.startTime),r=Math.max(r,l.endTime),t.push(o))}return t.length&&(e.startTime=i,e.endTime=r),t}(this),function(e){if(e.channels&&e.channels.length){for(var t=[],i=[],r=0,n=e.channels.length;r<n;r++){var a,s=e.channels[r],o=s.fullSid,l=s.sampler,c=l.input,h=e.getTransformBySid(s.sid);if(s.arrIndices){a=[];for(var u=0,d=s.arrIndices.length;u<d;u++)a[u]=be(s.arrIndices[u])}else a=De(s.member);if(h)for(-1===i.indexOf(o)&&i.push(o),u=0,d=c.length;u<d;u++){var p=c[u],f=l.getData(h.type,u);if(!(v=R(t,p))){v=new he(p);var m=L(t,p);t.splice(-1==m?t.length:m,0,v)}v.addTarget(o,h,a,f)}else console.log('Could not find transform "'+s.sid+'" in node '+e.id)}for(r=0;r<i.length;r++){var g=i[r];for(u=0;u<t.length;u++){var v;(v=t[u]).hasTarget(g)||O(t,v,u,g)}}e.keys=t,e.sids=i}}(this),this.updateMatrix(),this},k.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},G.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=ge(e.textContent),this.convert(),this},G.prototype.convert=function(){switch(this.type){case"matrix":this.obj=Ce(this.data);break;case"rotate":this.angle=e.Math.degToRad(this.data[3]);case"translate":Me(this.data,-1),this.obj=new e.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":Me(this.data,1),this.obj=new e.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},G.prototype.apply=function(e){switch(this.type){case"matrix":e.multiply(this.obj);break;case"translate":e.translate(this.obj);break;case"rotate":e.rotateByAxis(this.obj,this.angle);break;case"scale":e.scale(this.obj)}},G.prototype.update=function(t,i){var r=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(i)if(1===i.length)switch(i[0]){case 0:this.obj.n11=t[0],this.obj.n21=t[1],this.obj.n31=t[2],this.obj.n41=t[3];break;case 1:this.obj.n12=t[0],this.obj.n22=t[1],this.obj.n32=t[2],this.obj.n42=t[3];break;case 2:this.obj.n13=t[0],this.obj.n23=t[1],this.obj.n33=t[2],this.obj.n43=t[3];break;case 3:this.obj.n14=t[0],this.obj.n24=t[1],this.obj.n34=t[2],this.obj.n44=t[3]}else if(2===i.length){var n="n"+(i[0]+1)+(i[1]+1);this.obj[n]=t}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(t);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(i)&&(i=r[i[0]]),i){case"X":this.obj.x=t;break;case"Y":this.obj.y=t;break;case"Z":this.obj.z=t;break;default:this.obj.x=t[0],this.obj.y=t[1],this.obj.z=t[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(i)&&(i=r[i[0]]),i){case"X":this.obj.x=t;break;case"Y":this.obj.y=t;break;case"Z":this.obj.z=t;break;case"ANGLE":this.angle=e.Math.degToRad(t);break;default:this.obj.x=t[0],this.obj.y=t[1],this.obj.z=t[2],this.angle=e.Math.degToRad(t[3])}}},z.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1===i.nodeType)switch(i.nodeName){case"skeleton":this.skeleton.push(i.textContent.replace(/^#/,""));break;case"bind_material":var r=c.evaluate(".//dae:instance_material",i,fe,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(r)for(var n=r.iterateNext();n;)this.instance_material.push((new H).parse(n)),n=r.iterateNext()}}return this},H.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},W.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType&&"bind_material"==i.nodeName){var r=c.evaluate(".//dae:instance_material",i,fe,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(r)for(var n=r.iterateNext();n;)this.instance_material.push((new H).parse(n)),n=r.iterateNext();break}}return this},j.prototype.parse=function(e){this.id=e.getAttribute("id"),xe(this,e);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"mesh":this.mesh=new X(this).parse(i)}}return this},X.prototype.parse=function(t){var i;for(this.primitives=[],i=0;i<t.childNodes.length;i++){var r=t.childNodes[i];switch(r.nodeName){case"source":pe(r);break;case"vertices":this.vertices=(new J).parse(r);break;case"triangles":this.primitives.push((new Y).parse(r));break;case"polygons":this.primitives.push((new q).parse(r));break;case"polylist":this.primitives.push((new Z).parse(r))}}this.geometry3js=new e.Geometry;var n=d[this.vertices.input.POSITION.source].data;for(i=0;i<n.length;i+=3)this.geometry3js.vertices.push(Pe(n,i).clone());for(i=0;i<this.primitives.length;i++){var a=this.primitives[i];a.setVertices(this.vertices),this.handlePrimitive(a,this.geometry3js)}return this.geometry3js.computeCentroids(),this.geometry3js.computeFaceNormals(),this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this.geometry3js.computeBoundingBox(),this},X.prototype.handlePrimitive=function(t,i){var r,n,a,s,o,l,c,h=t.p,u=t.inputs,p=0,f=3,m=0,g=[];for(r=0;r<u.length;r++){var v=(a=u[r]).offset+1;switch(m=m<v?v:m,a.semantic){case"TEXCOORD":g.push(a.set)}}for(var S=0;S<h.length;++S)for(var _=h[S],y=0;y<_.length;){var M=[],P=[],C=null,b=[];for(f=t.vcount?t.vcount.length?t.vcount[p++]:t.vcount:_.length/m,r=0;r<f;r++)for(n=0;n<u.length;n++)switch(a=u[n],l=d[a.source],o=(s=_[y+r*m+a.offset])*(c=l.accessor.params.length),a.semantic){case"VERTEX":M.push(s);break;case"NORMAL":P.push(Pe(l.data,o));break;case"TEXCOORD":void 0===(C=C||{})[a.set]&&(C[a.set]=[]),C[a.set].push(new e.Vector2(l.data[o],l.data[o+1]));break;case"COLOR":b.push((new e.Color).setRGB(l.data[o],l.data[o+1],l.data[o+2]))}if(0==P.length)if(a=this.vertices.input.NORMAL){c=(l=d[a.source]).accessor.params.length;for(var D=0,w=M.length;D<w;D++)P.push(Pe(l.data,M[D]*c))}else i.calcNormals=!0;if(!C&&(C={},a=this.vertices.input.TEXCOORD)){g.push(a.set),c=(l=d[a.source]).accessor.params.length;for(D=0,w=M.length;D<w;D++)o=M[D]*c,void 0===C[a.set]&&(C[a.set]=[]),C[a.set].push(new e.Vector2(l.data[o],1-l.data[o+1]))}if(0==b.length&&(a=this.vertices.input.COLOR)){c=(l=d[a.source]).accessor.params.length;for(D=0,w=M.length;D<w;D++)o=M[D]*c,b.push((new e.Color).setRGB(l.data[o],l.data[o+1],l.data[o+2]))}var E,T,A=null,I=[];if(3===f)I.push(new e.Face3(M[0],M[1],M[2],P,b.length?b:new e.Color));else if(4===f)I.push(new e.Face4(M[0],M[1],M[2],M[3],P,b.length?b:new e.Color));else if(f>4&&x.subdivideFaces){var R=b.length?b:new e.Color;for(n=1;n<f-1;)I.push(new e.Face3(M[0],M[n],M[n+1],[P[0],P[n++],P[n]],R))}if(I.length)for(D=0,w=I.length;D<w;D++)for((A=I[D]).daeMaterial=t.material,i.faces.push(A),n=0;n<g.length;n++)E=C[g[n]],T=f>4?[E[0],E[D+1],E[D+2]]:4===f?[E[0],E[1],E[2],E[3]]:[E[0],E[1],E[2]],i.faceVertexUvs[n]||(i.faceVertexUvs[n]=[]),i.faceVertexUvs[n].push(T);else console.log("dropped face with vcount "+f+" for geometry with id: "+i.id);y+=m*f}},q.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source==e.id&&(this.inputs[t].source=e.input.POSITION.source)},q.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=_e(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"input":this.inputs.push((new Q).parse(e.childNodes[t]));break;case"vcount":this.vcount=ve(i.textContent);break;case"p":this.p.push(ve(i.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},Z.prototype=Object.create(q.prototype),Y.prototype=Object.create(q.prototype),K.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=_e(e,"count",0),this.stride=_e(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if("param"==i.nodeName){var r={};r.name=i.getAttribute("name"),r.type=i.getAttribute("type"),this.params.push(r)}}return this},J.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++)if("input"==e.childNodes[t].nodeName){var i=(new Q).parse(e.childNodes[t]);this.input[i.semantic]=i}return this},Q.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=_e(e,"set",-1),this.offset=_e(e,"offset",0),"TEXCOORD"==this.semantic&&this.set<0&&(this.set=0),this},$.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"bool_array":this.data=me(i.textContent),this.type=i.nodeName;break;case"float_array":this.data=ge(i.textContent),this.type=i.nodeName;break;case"int_array":this.data=ve(i.textContent),this.type=i.nodeName;break;case"IDREF_array":case"Name_array":this.data=Se(i.textContent),this.type=i.nodeName;break;case"technique_common":for(var r=0;r<i.childNodes.length;r++)if("accessor"==i.childNodes[r].nodeName){this.accessor=(new K).parse(i.childNodes[r]);break}}}return this},$.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var i=0;i<this.data.length;i+=16){var r=Ce(this.data.slice(i,i+16));e.push(r)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},ee.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if("instance_effect"==e.childNodes[t].nodeName){this.instance_effect=(new se).parse(e.childNodes[t]);break}return this},te.prototype.isColor=function(){return null==this.texture},te.prototype.isTexture=function(){return null!=this.texture},te.prototype.parse=function(t){for(var i=0;i<t.childNodes.length;i++){var r=t.childNodes[i];if(1==r.nodeType)switch(r.nodeName){case"color":var n=ge(r.textContent);this.color=new e.Color(0),this.color.setRGB(n[0],n[1],n[2]),this.color.a=n[3];break;case"texture":this.texture=r.getAttribute("texture"),this.texcoord=r.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(r)}}return this},te.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1]).childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[i.nodeName]=parseFloat(i.textContent);break;case"wrapU":case"wrapV":this.texOpts[i.nodeName]=parseInt(i.textContent);break;default:this.texOpts[i.nodeName]=i.textContent}}return this},ie.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"ambient":case"emission":case"diffuse":case"specular":case"transparent":case"normal":this[i.nodeName]=(new te).parse(i);break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var r=ye(i,".//dae:float");r.length>0&&(this[i.nodeName]=parseFloat(r[0].textContent))}}return this.create(),this},ie.prototype.create=function(){var t={},i=void 0!==this.transparency&&this.transparency<1,r=null;function n(){r&&r.numberOfAwaitedTextures&&(r.numberOfAwaitedTextures--,0===r.numberOfAwaitedTextures&&delete r.numberOfAwaitedTextures)}for(var a in this)switch(a){case"ambient":case"emission":case"diffuse":case"specular":case"normal":var o=this[a];if(o instanceof te)if(o.isTexture()){var l=o.texture,c=this.effect.sampler[l].source;if(c){var h=this.effect.surface[c],u=p[h.init_from];if(u){var d=e.ImageUtils.loadTexture(s+u.init_from,void 0,n,null,!0);0,d.wrapS=o.texOpts.wrapU?e.RepeatWrapping:e.ClampToEdgeWrapping,d.wrapT=o.texOpts.wrapV?e.RepeatWrapping:e.ClampToEdgeWrapping,d.offset.x=o.texOpts.offsetU,d.offset.y=o.texOpts.offsetV,d.repeat.x=o.texOpts.repeatU,d.repeat.y=o.texOpts.repeatV,"normal"===a?t.normalMap=d:t.map=d,"emission"===a&&(t.emissive=16777215)}}}else"diffuse"!==a&&i||("emission"===a?t.emissive=o.color.getHex():t[a]=o.color.getHex());break;case"shininess":t[a]=this[a];break;case"reflectivity":t[a]=this[a],t[a]>0&&(t.envMap=x.defaultEnvMap),t.combine=e.MixOperation;break;case"index_of_refraction":t.refractionRatio=this[a],1!==this[a]&&(t.envMap=x.defaultEnvMap);break;case"transparency":i&&(t.transparent=!0,t.opacity=this[a],i=!0)}switch(t.shading=y,t.side=this.effect.doubleSided?e.DoubleSide:e.FrontSide,this.type){case"constant":null!=t.emissive&&(t.color=t.emissive),r=new e.MeshBasicMaterial(t);break;case"phong":case"blinn":null!=t.diffuse&&(t.color=t.diffuse),r=new e.MeshPhongMaterial(t);break;case"lambert":default:null!=t.diffuse&&(t.color=t.diffuse),r=new e.MeshLambertMaterial(t)}return this.material=r,this.material},re.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"init_from":this.init_from=i.textContent;break;case"format":this.format=i.textContent;break;default:console.log("unhandled Surface prop: "+i.nodeName)}}return this},ne.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"source":this.source=i.textContent;break;case"minfilter":this.minfilter=i.textContent;break;case"magfilter":this.magfilter=i.textContent;break;case"mipfilter":this.mipfilter=i.textContent;break;case"wrap_s":this.wrap_s=i.textContent;break;case"wrap_t":this.wrap_t=i.textContent;break;default:console.log("unhandled Sampler2D prop: "+i.nodeName)}}return this},ae.prototype.create=function(){if(null==this.shader)return null},ae.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),xe(this,e),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(i))}}return this},ae.prototype.parseNewparam=function(e){for(var t=e.getAttribute("sid"),i=0;i<e.childNodes.length;i++){var r=e.childNodes[i];if(1==r.nodeType)switch(r.nodeName){case"surface":this.surface[t]=new re(this).parse(r);break;case"sampler2D":this.sampler[t]=new ne(this).parse(r);break;case"extra":break;default:console.log(r.nodeName)}}},ae.prototype.parseProfileCOMMON=function(e){for(var t,i=0;i<e.childNodes.length;i++){var r=e.childNodes[i];if(1==r.nodeType)switch(r.nodeName){case"profile_COMMON":this.parseProfileCOMMON(r);break;case"technique":t=r;break;case"newparam":this.parseNewparam(r);break;case"image":var n=(new N).parse(r);p[n.id]=n;break;case"extra":break;default:console.log(r.nodeName)}}return t},ae.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new ie(i.nodeName,this).parse(i)}}},se.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},oe.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"animation":var r=(new oe).parse(i);for(var n in r.source)this.source[n]=r.source[n];for(var a=0;a<r.channel.length;a++)this.channel.push(r.channel[a]),this.sampler.push(r.sampler[a]);break;case"source":n=(new $).parse(i);this.source[n.id]=n;break;case"sampler":this.sampler.push(new ce(this).parse(i));break;case"channel":this.channel.push(new le(this).parse(i))}}return this},le.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");var t=this.target.split("/"),i=(t.shift(),t.shift()),r=i.indexOf(".")>=0,n=i.indexOf("(")>=0;if(r)t=i.split("."),this.sid=t.shift(),this.member=t.shift();else if(n){var a=i.split("(");this.sid=a.shift();for(var s=0;s<a.length;s++)a[s]=parseInt(a[s].replace(/\)/,""));this.arrIndices=a}else this.sid=i;return this.fullSid=i,this.dotSyntax=r,this.arrSyntax=n,this},ce.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"input":this.inputs.push((new Q).parse(i))}}return this},ce.prototype.create=function(){for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e],i=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=i.read();break;case"OUTPUT":this.output=i.read(),this.strideOut=i.accessor.stride;break;case"INTERPOLATION":this.interpolation=i.read();break;case"IN_TANGENT":case"OUT_TANGENT":break;default:console.log(t.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},ce.prototype.getData=function(e,t){var i;if("matrix"===e&&16===this.strideOut)i=this.output[t];else if(this.strideOut>1){i=[],t*=this.strideOut;for(var r=0;r<this.strideOut;++r)i[r]=this.output[t+r];if(3===this.strideOut)switch(e){case"rotate":case"translate":Me(i,-1);break;case"scale":Me(i,1)}else 4===this.strideOut&&"matrix"===e&&Me(i,-1)}else i=this.output[t];return i},he.prototype.addTarget=function(e,t,i,r){this.targets.push({sid:e,member:i,transform:t,data:r})},he.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var i=this.targets[t];e&&i.sid!==e||i.transform.update(i.data,i.member)}},he.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},he.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},he.prototype.interpolate=function(e,t){for(var i=0;i<this.targets.length;++i){var r,n=this.targets[i],a=e.getTarget(n.sid);if("matrix"!==n.transform.type&&a){var s=(t-this.time)/(e.time-this.time),o=a.data,l=n.data;if((s<0||s>1)&&(console.log("Key.interpolate: Warning! Scale out of bounds:"+s),s=s<0?0:1),l.length){r=[];for(var c=0;c<l.length;++c)r[c]=l[c]+(o[c]-l[c])*s}else r=l+(o-l)*s}else r=n.data;n.transform.update(r,n.member)}},ue.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"optics":this.parseOptics(i)}}return this},ue.prototype.parseOptics=function(e){for(var t=0;t<e.childNodes.length;t++)if("technique_common"==e.childNodes[t].nodeName)for(var i=e.childNodes[t],r=0;r<i.childNodes.length;r++)if(this.technique=i.childNodes[r].nodeName,"perspective"==this.technique)for(var n=i.childNodes[r],a=0;a<n.childNodes.length;a++){switch((o=n.childNodes[a]).nodeName){case"yfov":this.yfov=o.textContent;break;case"xfov":this.xfov=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}else if("orthographic"==this.technique){var s=i.childNodes[r];for(a=0;a<s.childNodes.length;a++){var o;switch((o=s.childNodes[a]).nodeName){case"xmag":this.xmag=o.textContent;break;case"ymag":this.ymag=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}}return this},de.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},{load:function(e,t,i){var r=0;if(document.implementation&&document.implementation.createDocument){var n=new XMLHttpRequest;n.onreadystatechange=function(){4==n.readyState?0!=n.status&&200!=n.status||(n.responseXML?(u=t,b(n.responseXML,void 0,e)):n.responseText?(u=t,b((new DOMParser).parseFromString(n.responseText,"application/xml"),void 0,e)):console.error("ColladaLoader: Empty or non-existing file ("+e+")")):3==n.readyState&&i&&(0==r&&(r=n.getResponseHeader("Content-Length")),i({total:r,loaded:n.responseText.length}))},n.open("GET",e,!0),n.withCredentials=!0,n.send(null)}else alert("Don't know how to parse XML!")},loadFromSpec:function(e,r,n){var a=e.serverurl?e.serverurl:"";a+=e.filename?e.filename:"";var s=new i;t.setProxyFromSpec(e,s),s.executeGetHttpRequest(a,"text",null,function(e){u=r,b((new DOMParser).parseFromString(e,"application/xml"),void 0,a)},function(){console.error("ColladaLoader: Empty or non-existing file ("+a+")")})},parse:b,setPreferredShading:function(e){y=e},applySkin:A,geometries:g,options:x}};return e.ColladaLoader=r,r}),define("DS/Visualization/ColladaLoader",["DS/VisuLoaders/ColladaLoader","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return t}),define("DS/Gestures/PinchTapGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("PinchTap"),this.priority=10,this.maxTime=300,this.maxDistance=15,this},detect:function(e){switch(this._parent(e),this.state){case i.State.INIT:2===(r=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE],this.view)).length&&this.changeState(i.State.BEGIN);break;case i.State.BEGIN:var r;if((r=THREEDS.VisuEventsManager.getTouchEvents()).length>2)return void this.changeState(i.State.KO);for(var n=r.length,a=0;a<r.length;a++){var s=r[a],o=s.getState();if(o===t.State.MOVE){if(s.offsetPosition.length()>this.maxDistance||s.currentTime-s.startTime>this.maxTime)return void this.changeState(i.State.KO)}else if(o===t.State.END){if(s.offsetPosition.length()>this.maxDistance||s.currentTime-s.startTime>this.maxTime)return void this.changeState(i.State.KO);if(1===n)return this.events.push(s),void this.changeState(i.State.OK);2===n&&(this.events=[s],n--)}}break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/PinchTapGesture",r)}),define("Gestures/PinchTapGesture",["DS/Gestures/PinchTapGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/PinchTapGesture"),e}),define("DS/Manipulators/ScalingManipulator",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator"],function(e,t,i){"use strict";var r=i.extend({init:function(t){var i;return i=this.DEPRECATED_CONSTRUCTOR(arguments)?{axis:arguments[1]}:t||{},this._parent(),this.axis=i.axis,this.axis.normalize(),this.centerPosition=new e.Vector3,this.offset=0,this.projector=new e.Projector,this.scalingFactor=1,this},BeginManipulate:function(t,i,r){this._parent(t,i,r),this.initial3dIntersectionPoint=(new e.Vector3).copy(r.position),this.lastProjectionPoint3D=this.initial3dIntersectionPoint,this.initial3dIntersectionPointTranslated=(new e.Vector3).copy(this.initial3dIntersectionPoint),this.initial3dIntersectionPointTranslated.add(this.axis),this.offset=(new e.Vector3).subVectors(this.initial3dIntersectionPoint,this.centerPosition).length();var n={viewer:i.viewer,eventChannel:"BeginManipulate",event:i,paths:this.manipulatedPaths,intersection:r,manipulator:this};this.publish("BeginManipulate",n)},Manipulate:function(t,i,r){this._parent(t,i,r);var n=(new e.Vector2).copy(i.from[0].getCurrentPosition(i.viewer.canvas)),a=i.viewer.currentViewpoint.create3DRayFrom2DPoint(n);this.lastProjectionPoint3D=a.computeShortestPointToLine(this.initial3dIntersectionPoint,this.initial3dIntersectionPointTranslated);var s=(new e.Vector3).subVectors(this.lastProjectionPoint3D,this.initial3dIntersectionPoint);s.projectOnVector(this.axis);var o=s.dot(this.axis),l=new e.Matrix4;this.offset>0&&(this.scalingFactor=Math.max((this.offset+o)/this.offset,.1),l.setPosition((new e.Vector3).copy(this.centerPosition)).scale(new e.Vector3(this.scalingFactor,this.scalingFactor,this.scalingFactor)).multiply((new e.Matrix4).setPosition((new e.Vector3).copy(this.centerPosition).multiplyScalar(-1))));var c={viewer:i.viewer,eventChannel:"Manipulate",event:i,paths:this.manipulatedPaths,scalingMatrix:l,scalingFactor:this.scalingFactor,center:this.centerPosition,intersection:r,manipulator:this};this.publish("Manipulate",c)},EndManipulate:function(e,t,i){this.scalingFactor=1;var r={viewer:t.viewer,eventChannel:"EndManipulate",event:t,paths:this.manipulatedPaths,intersection:i,manipulator:this};this.publish("EndManipulate",r),this._parent(e,t,i)},BeginPreactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"BeginPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("BeginPreactivate",r)},Preactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"Preactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("Preactivate",r)},EndPreactivate:function(e,t,i){var r={viewer:t.viewer,eventChannel:"EndPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("EndPreactivate",r)},PrimaryPointerClick:function(e,t,i){var r={viewer:t.viewer,eventChannel:"PrimaryPointerClick",event:t,intersection:i,manipulator:this};this.publish("PrimaryPointerClick",r)},PrimaryPointerDoubleClick:function(e,t,i){var r={viewer:t.viewer,eventChannel:"PrimaryPointerDoubleClick",event:t,intersection:i,manipulator:this};this.publish("PrimaryPointerDoubleClick",r)},setCenter:function(e){this.centerPosition=e},setAxis:function(e){this.axis=e&&e.clone(),this.axis&&this.axis.normalize()}});return UWA.namespace("THREEDS/Nodes/ScalingManipulator",r)}),define("Manipulators/ScalingManipulator",["DS/Manipulators/ScalingManipulator","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Manipulators/ScalingManipulator"),e}),define("DS/Gestures/PrimaryPointerClickGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent","DS/Gestures/BasicGesture"],function(e,t,i,r){"use strict";var n=r.extend({init:function(){return this._parent("PrimaryPointerClick"),this.priority=10,this.identifier=null,this.maxTime=300,this.maxDistance=10,this},detect:function(e){switch(this._parent(e),this.state){case r.State.INIT:this.identifier=null;var n=THREEDS.VisuEventsManager.getPrimaryPointerEventsByStates([t.State.BEGIN],this.view);1===n.length&&(n[0]instanceof i&&(this.identifier=n[0].identifier),this.changeState(r.State.BEGIN));break;case r.State.BEGIN:var a=null;if(null!==this.identifier){if(THREEDS.VisuEventsManager.getTouchEvents(this.view).length>1)return;a=THREEDS.VisuEventsManager.getTouchEventById(this.identifier)}else a=THREEDS.VisuEventsManager.getMouseEvents(t.MouseButton.LEFT,this.view)[0];a?a.state===t.State.MOVE?(a.offsetPosition.length()>this.maxDistance||a.currentTime-a.startTime>this.maxTime)&&this.changeState(r.State.KO):a.state===t.State.END&&(a.offsetPosition.length()>this.maxDistance||a.currentTime-a.startTime>this.maxTime?this.changeState(r.State.KO):(this.events=[a],this.changeState(r.State.OK))):this.changeState(r.State.KO);break;case r.State.KO:case r.State.OK:case r.State.CANCEL:this.identifier=null,this.changeState(r.State.INIT)}}});return UWA.namespace("THREEDS/Gestures/PrimaryPointerClickGesture",n)}),define("Gestures/PrimaryPointerClickGesture",["DS/Gestures/PrimaryPointerClickGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/PrimaryPointerClickGesture"),e}),define("DS/Shaders/SSLRShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t={computeReflectionCoef:["vec4 normalDepth = texture2D( tNormalDepthIoRRoughness, vUv );","float reflectionCoef = normalDepth.z;"].join("\n"),computeVertexPositionVS:["float z = normalDepth.w;","if ( z == 0.0 ) return;","vec2 xy = vUv * 2.0 - 1.0;","vec4 vertexPositionProjected = vec4( xy, 2.0 * z - 1.0, 1.0 );","vec4 vertexPositionVS = realProjectionMatrixInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","vertexPositionVS.w = 1.0;"].join("\n"),computeNormal:["vec3 normal = decodeOct24Normal(normalDepth.x);"].join("\n")};return{uniforms:{tDiffuse2:{type:"t",value:null},tNormalDepthIoRRoughness:{type:"t",value:null},tRandomTex:{type:"t",value:null},size:{type:"v2",value:new e.Vector2(512,512)},realProjectionMatrix:{type:"m4",value:new e.Matrix4},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},radius:{type:"f",value:.5}},vertexShader:["varying vec2 vUv;","void main() {","  vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform mat4 realProjectionMatrix;","uniform mat4 realProjectionMatrixInverse;","uniform sampler2D tDiffuse2;","uniform sampler2D tNormalDepthIoRRoughness;","uniform sampler2D tRandomTex;","uniform vec2 size;","uniform float radius;","varying vec2 vUv;","const float roughness = 0.0;","const vec3 unitY = vec3(0.0, 1.0, 0.0);","const vec3 unitZ = vec3(0.0, 0.0, 1.0);","vec2 getScreenPos(vec3 pos) {","  vec4 offset = realProjectionMatrix * vec4(pos, 1.0);","  offset.xy /= offset.w;","  offset.xy = offset.xy * 0.5 + 0.5;","  return offset.xy;","}","vec3 getScreenPos3(vec3 pos) {","  vec4 offset = realProjectionMatrix * vec4(pos, 1.0);","  offset.xyz /= offset.w;","  offset.xy = offset.xy * 0.5 + 0.5;","  return offset.xyz;","}","float random(vec3 scale, float seed) {","  return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","void main() {","  vec2 screenPos = vUv;","  gl_FragColor = vec4(0.0);",t.computeReflectionCoef,"  if (reflectionCoef > 0.0) {",t.computeVertexPositionVS,t.computeNormal,"    vec3 origin = vertexPositionVS.xyz;","    vec3 I = normalize(origin);","    vec3 vReflect = normalize(reflect(I, normal));","    vec3 ptReflect = origin + radius * vReflect;","    vec3 originScreenPos = vec3(vUv, 2.0 * z - 1.0);","    vec3 endReflectScreenPos = getScreenPos3( ptReflect );","    vec3 reflectScreenPos = endReflectScreenPos - originScreenPos;","    reflectScreenPos /= length(endReflectScreenPos.xy - originScreenPos.xy);","    vec2 stepsToBorder = vec2(size * vUv / abs(reflectScreenPos.xy));","    if (reflectScreenPos.x > 0.0) stepsToBorder.x = size.x * (1.0 - vUv.x) / abs(reflectScreenPos.x);","    if (reflectScreenPos.y > 0.0) stepsToBorder.y = size.y * (1.0 - vUv.y) / abs(reflectScreenPos.y);","    float stepsToScreenBorder = min(stepsToBorder.x, stepsToBorder.y);","    reflectScreenPos /= size.x;","    float prevDepth = originScreenPos.z;","    float ray_marching_step = 16.0;","    float j = ray_marching_step;","    for (int i = 0; i < 64; ++i) {","      if (j > stepsToScreenBorder) { break; }","      vec3 sampleScreenPos = originScreenPos + j * reflectScreenPos;","      vec4 normalDepth = texture2D( tNormalDepthIoRRoughness, sampleScreenPos.xy );","      float z = 2.0 * normalDepth.w - 1.0;","      vec3 n = decodeOct24Normal(normalDepth.x);","      float diffZ = sampleScreenPos.z - z;","      if (diffZ > 0.0) {","        if (ray_marching_step == 1.0) {","          if (abs(diffZ) < 10.0*abs(sampleScreenPos.z - prevDepth)) {","            float reflectAttenuation = clamp(-dot(n, vReflect), 0.0, 1.0) * ((stepsToScreenBorder - j) / stepsToScreenBorder);","            gl_FragColor = vec4( texture2D( tDiffuse2, sampleScreenPos.xy ).xyz, reflectAttenuation * reflectionCoef );","          }","          return;","        } else {","          ray_marching_step *= 0.5;","          j -= ray_marching_step;","        }","      } else {","        prevDepth = sampleScreenPos.z;","        j += ray_marching_step;","      }","    }","  }","}"].join("\n")}}),define("Shaders/SSLRShader",["DS/Shaders/SSLRShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/SSLRShader"),e}),define("DS/Shaders/TextureBlendingShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=new e.DataTexture(new Uint8Array(16),2,2,e.RGBAFormat,e.UnsignedByteType,null);return t.needsUpdate=!0,{AlphaBlendingShader:{defines:{POSTPRO:1},uniforms:{tScene:{type:"t",value:null},tTexture:{type:"t",value:t},offset:{type:"v2",value:new e.Vector2(0,0)},invSize:{type:"v2",value:new e.Vector2(1,1)}},vertexShader:["varying vec2 vUv;","void main() {","   vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#if (POSTPRO == 1)","uniform sampler2D tScene;","#endif","uniform sampler2D tTexture;","uniform vec2 invSize;","uniform vec2 offset;","varying vec2 vUv;","void main() {","vec2 coord = (vUv - offset) * invSize;","#if (POSTPRO == 1)","vec4 scene = texture2D(tScene, coord);","#else","vec4 scene = vec4(0.0);","#endif","vec4 texture = texture2D(tTexture, coord);","vec3 color = texture.rgb;","float alpha = texture.a;","#if (POSTPRO == 1)","   gl_FragColor = vec4(color * (alpha) + (1.0 - alpha) * scene.rgb, alpha + scene.a * (1.0 - alpha));","#else","   gl_FragColor = vec4(color, alpha);","#endif","}"].join("\n")}}}),define("Shaders/TextureBlendingShader",["DS/Shaders/TextureBlendingShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/TextureBlendingShader"),e}),define("DS/VisuDataAccess/Ox4DOSRunner",["DS/VisuDataAccess/Ox4TreeTarget","DS/VisuDataAccess/Ox4PlanRunner","DS/VisuDataAccess/Ox4TaskPlanner","DS/VisuDataAccess/Ox4SetTask","DS/VisuDataAccess/Ox4ExpandTask","DS/VisuDataAccess/Ox4xMQLSelectTaskDefinition","DS/VisuDataAccess/Ox4SelectTask","DS/VisuDataAccess/Ox4PLMDataHelper","DS/VisuDataAccess/Ox4TicketGeneratorTask","DS/VisuDataAccess/Ox4FeatureModeler","DS/VisuDataAccess/Ox4StreamUnStreamerTaskDefinition","DS/VisuDataAccess/Ox4StreamUnStreamerTask","DS/VisuDataAccess/Ox4TypeHelper","DS/Visualization/PathElement"],function(e,t,i,r,n,a,s,o,l,c,h,u,d,p){"use strict";return function(f,m){d.IsInit()||d.Init(f.serverdefinition,f.requiredAuth,f.proxyurl);var g,v,S=(g=f,v=new Object,void 0===g.serverdefinition.hostname?(console.log("checkAndEnrichSpecification:No Hostname in CreateServerDefinition"),null):(v.hostname=g.serverdefinition.hostname,void 0===g.serverdefinition.rooturi?(console.log("checkAndEnrichSpecification:No RootUri in CreateServerDefinition"),null):(v.rooturi=g.serverdefinition.rooturi,v.isSecure=!1,void 0!==g.serverdefinition.protocol&&"https"===g.serverdefinition.protocol&&(v.isSecure=!0),v.port=-1,void 0!==g.serverdefinition.port&&(v.port=g.serverdefinition.port),v.rawmode=g.rawmode,v.xmqlServiceUri=function(){var e="http://";this.isSecure&&(e="https://");var t=e+this.hostname;return-1!=this.port&&(t+=":"+this.port),t+="/"+this.rooturi+"/i3dx/services/xmql","string"==typeof g.tenant&&(t+="?tenant="+g.tenant),"boolean"==typeof v.rawmode&&v.rawmode&&(t+="?raw=true"),t},v.threedexpServiceUri=function(){var e="http://";this.isSecure&&(e="https://");var t=e+this.hostname;return-1!=this.port&&(t+=":"+this.port),t+="/"+this.rooturi},g.serverdefinition=v,g.typeHelper=d,g.referenceType="VPMReference",g.shapeType="VPMRepReference",g.instanceType="VPMInstance",g))),_=new e(S,m),y=null,x=null,M=null;this.run=function(e,i,r){console.log("---\x3e Entering Ox4DOSRunner"),y=e,x=i,M=r,console.log("---\x3e Init Feature Modeler session"),c.init(),console.log("---\x3e Building a plan for"),(new P).buildPlan(S,function(e){console.log("---\x3e Plan Constructed"),_.FindRootNodeWorkType(),new t(e,_,S.physicalid+"_set",y,x,M).executePlan()})};var P=function(){this.buildPlan=function(e,t){console.log("---\x3eOx4DOSPlanifier:Beginning BuildPlan"),console.log(e),console.log(e.physicalid),null!=e.dtype&&d.IsBusA(e.dtype,e.shapeType,function(d){var f=new i,m=new r(!1,e.serverdefinition);if(f.addSequentialTask(m),!d){var g=new n(e.physicalid,e.serverdefinition,"PLMInstance");f.addSequentialTask(g);var v={Fetch:new Array};v.Fetch.push("physicalid"),v.Fetch.push("attribute[LPAbstractInstance.V_matrix_1]"),v.Fetch.push("attribute[LPAbstractInstance.V_matrix_2]"),v.Fetch.push("attribute[LPAbstractInstance.V_matrix_3]"),v.Fetch.push("attribute[LPAbstractInstance.V_matrix_4]"),v.Fetch.push("attribute[LPAbstractInstance.V_matrix_5]"),v.Fetch.push("attribute[LPAbstractInstance.V_matrix_6]"),v.Fetch.push("attribute[LPAbstractInstance.V_matrix_7]"),v.Fetch.push("attribute[LPAbstractInstance.V_matrix_8]"),v.Fetch.push("attribute[LPAbstractInstance.V_matrix_9]"),v.Fetch.push("attribute[LPAbstractInstance.V_matrix_10]"),v.Fetch.push("attribute[LPAbstractInstance.V_matrix_11]"),v.Fetch.push("attribute[LPAbstractInstance.V_matrix_12]");var S=new a(e.instanceType,v,function(e,t,i){var r=i.findNodeByPhysicalId(t[1]),n=r.getMatrix();n.set(parseFloat(t[2]),parseFloat(t[5]),parseFloat(t[8]),1e3*parseFloat(t[11]),parseFloat(t[3]),parseFloat(t[6]),parseFloat(t[9]),1e3*parseFloat(t[12]),parseFloat(t[4]),parseFloat(t[7]),parseFloat(t[10]),1e3*parseFloat(t[13]),0,0,0,1),r.setMatrix(n)},0),_=new s(S,e.serverdefinition);f.addSequentialTask(_)}var y={Fetch:new Array};y.Fetch.push("physicalid"),y.Fetch.push("attribute[StreamDescriptors]"),y.Fetch.push("format.file.store");var x=new o(e.serverdefinition),M=new a(e.shapeType,y,function(t,i,r){var n=r.findNodeByPhysicalId(i[3]),a=x.transformSelectedSDByRoleAndFormatIntoTicketRequest(i[3],i[4],"cgr","''",["2","1"],i[5]);null!==a&&(n.ticketRequest=new l(a,e.serverdefinition))},1),P=new s(M,e.serverdefinition);if(f.addSequentialTask(P),e.kinematics=!0,e.kinematics){var C=function(e,t){var i=c.listRootFeatures(e.id);e.AnimFeatures=i;var r=t.rootNode();r.hasOwnProperty("AnimFeaturesList")||(r.AnimFeaturesList=[]),Array.prototype.push.apply(r.AnimFeaturesList,e.AnimFeatures)},b={Fetch:new Array,Path:new Array};b.Fetch.push("physicalid"),b.Fetch.push("attribute[StreamDescriptors]"),b.Fetch.push("format.file.store"),b.Path.push("owner.physicalid"),b.Path.push("element.order"),b.Path.push("element"),b.Path.push("attribute[IDRel]"),M=new a("CATANIMDISCIPLINE",b,function(t,i,r){if("fetch"===t){var n=r.findNodeByPhysicalId(i[3]);if(c.containFeatures(n.id))C(n,r);else{var a=x.transformSelectedSDByRoleAndFormatIntoTicketRequest(i[3],i[4],"CATNonCATIADocument","'WebFormat'",["1","7"],i[5]);null!==a&&(n.ticketRequest=new l(a,e.serverdefinition))}}else if("path"===t){var s=(i.length-3)/2;(n=r.findNodeByPhysicalId(i[1])).hasOwnProperty("SemanticRelations")||(n.SemanticRelations={});var o=new p;o.addElement(r.rootNode());var h,u=[];for(h=0;h<s;h++)u.push({order:i[2+h],instance:i[2+s+h].split(",")[2]});for(u.sort(function(e,t){return e.order-t.order}),h=0;h<u.length;h++){var d=r.findNodeByPhysicalId(u[h].instance);o.addElement(d),h<u.length-1&&1==d.children.length&&o.addElement(d.children[0])}n.SemanticRelations[i[2+2*s]]=o}},1),P=new s(M,e.serverdefinition),f.addSequentialTask(P);var D=new h("CATANIMDISCIPLINE",function(e,t,i){if(null!==t)c.loadRepresentation(e,e.id,t,function(){C(e,i)});else{var r=i.rootNode();r.hasOwnProperty("AnimFeaturesList")||(r.AnimFeaturesList=[]),r.AnimFeaturesList.push("feature")}},function(){});D.responseType="blob";var w=new u(D,e.serverdefinition);f.addSequentialTask(w)}var E=new r(!0,e.serverdefinition);f.addSequentialTask(E),f.addEndingTask(function(t){var i=t.rootNode(),r=t.findNodeByType(e.shapeType),n=[];for(var a in r)void 0!==r[a].ticketRequest&&n.push(r[a]);return{rootNode:i,geometryNodes:n}}),console.log("---\x3eOx4DOSPlanifier:Beginning BuildPlan Done"),t(f)})}}}}),define("VisuDataAccess/Ox4DOSRunner",["DS/VisuDataAccess/Ox4DOSRunner","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuDataAccess/Ox4DOSRunner"),e}),define("DS/Effects/XRevealStructureEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ShaderPass","DS/Shaders/TextureBlendingShader"],function(e,t,i,r){"use strict";return t.extend({init:function(e,t){return this._parent(e),this.rtPool=t,this.name="xRevealStructurePass",this.mixPass=null,this},initEffect:function(e,t){var n=this.name;e?(this.mixPass=new i(r.AlphaBlendingShader,void 0,n),this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0,this.mixPass.material.depthTest=!1):this.mixPass=new i(r.AlphaBlendingShader,"tScene",n),t.insertComposer(null,this.mixPass)},update:function(t,i,r){if(r.camera.fullWidth){var n=-r.camera.x/r.camera.width,a=-(r.camera.fullHeight-r.camera.height-r.camera.y)/r.camera.height;this.mixPass.uniforms.offset.value=new e.Vector2(n,a);var s=r.camera.width/r.camera.fullWidth,o=r.camera.height/r.camera.fullHeight;this.mixPass.uniforms.invSize.value=new e.Vector2(s,o)}else this.mixPass.uniforms.offset.value=new e.Vector2(0,0),this.mixPass.uniforms.invSize.value=new e.Vector2(1,1)},updateTexture:function(e){this.mixPass&&(this.mixPass.uniforms.tTexture.value=e)},setSize:function(e,t){this._parent(e,t)}})}),define("Effects/XRevealStructureEffect",["DS/Effects/XRevealStructureEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/XRevealStructureEffect"),e}),define("DS/Shaders/DisplayShadowMapsShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDiffuse4:{type:"t",value:null},tDiffuse5:{type:"t",value:null},offset:{type:"v2",value:new e.Vector2(.505,.01)},scale:{type:"f",value:.485},offset2:{type:"v2",value:new e.Vector2(.01,.01)},scale2:{type:"f",value:.485},offset3:{type:"v2",value:new e.Vector2(.505,.505)},scale3:{type:"f",value:.485},offset4:{type:"v2",value:new e.Vector2(.01,.505)},scale4:{type:"f",value:.485}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform sampler2D tDiffuse4;","uniform sampler2D tDiffuse5;","uniform vec2 offset;","uniform float scale;","uniform vec2 offset2;","uniform float scale2;","uniform vec2 offset3;","uniform float scale3;","uniform vec2 offset4;","uniform float scale4;","varying vec2 vUv;","void main() {","gl_FragColor = vec4(0.0);","vec2 vUv2 = (vUv - offset) / scale;","vec2 vUv3 = (vUv - offset2) / scale2;","vec2 vUv4 = (vUv - offset3) / scale3;","vec2 vUv5 = (vUv - offset4) / scale4;","if (vUv2.x > 0.0 && vUv2.y > 0.0 && vUv2.x < 1.0 && vUv2.y < 1.0) {","    vec4 normalDepth = texture2D( tDiffuse2, vUv2 );","    gl_FragColor = vec4(vec3(normalDepth.w), 0.7); return;","} else if (vUv3.x > 0.0 && vUv3.y > 0.0 && vUv3.x < 1.0 && vUv3.y < 1.0) {","    vec4 normalDepth = texture2D( tDiffuse3, vUv3 );","    gl_FragColor = vec4(vec3(normalDepth.w), 0.7); return;","} else if (vUv4.x > 0.0 && vUv4.y > 0.0 && vUv4.x < 1.0 && vUv4.y < 1.0) {","    vec4 normalDepth = texture2D( tDiffuse4, vUv4 );","    gl_FragColor = vec4(vec3(normalDepth.w), 0.7); return;","} else if (vUv5.x > 0.0 && vUv5.y > 0.0 && vUv5.x < 1.0 && vUv5.y < 1.0) {","    vec4 normalDepth = texture2D( tDiffuse5, vUv5 );","    gl_FragColor = vec4(vec3(normalDepth.w), 0.7); return;","}","}"].join("\n")}}),define("Shaders/DisplayShadowMapsShader",["DS/Shaders/DisplayShadowMapsShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/DisplayShadowMapsShader"),e}),define("DS/Effects/SSLREffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/SSLRShader","DS/Shaders/BloomShaders","DS/Shaders/SSLRBlendShader"],function(e,t,i,r,n,a,s,o){"use strict";return i.extend({init:function(i,l){var c=this._parent(i),h=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers.push(new r(i,h,l)),this.effectSSLR=new n(a),this.effectSSLRBlurH=new n(s.BlurH),this.effectSSLRBlurV=new n(s.BlurV),this.composers[0].addPass(this.effectSSLR),this.composers[0].addPass(this.effectSSLRBlurH),this.composers[0].addPass(this.effectSSLRBlurV),this.composers[0].enablePass(this.effectSSLRBlurH,!1),this.composers[0].enablePass(this.effectSSLRBlurV,!1);var u=t.getWebappsAssetUrl("Effects",""),d=new e.ImageUtils.loadTexture(u+"SSAORandom.png",void 0,null,null,e.ImageUtils.crossOriginPolicy);d.minFilter=e.LinearFilter,d.magFilter=e.LinearFilter,this.effectSSLR.uniforms.tRandomTex.value=d,this.mixPass=new n(o,void 0,"SSLREffect");c=this;return this.mixPass.beforeRenderCB=function(e){c.effectSSLR.uniforms.tDiffuse2.value=e},this},initEffect:function(e,t){t.getComposer("normalDepthIoRRoughness").linkToShaderPassUniform(this.effectSSLR,this.effectSSLR.uniforms.tNormalDepthIoRRoughness),t.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composers[0])},update:function(t,i,r){r._renderedCamera.projectionMatrixInverse.getInverse(r._renderedCamera.projectionMatrix),this.effectSSLR.uniforms.realProjectionMatrixInverse.value=r._renderedCamera.projectionMatrixInverse,this.effectSSLR.uniforms.realProjectionMatrix.value=r._renderedCamera.projectionMatrix;var n=.2*i.getBoundingSphere().radius,a=.2*(new e.Vector3).subVectors(r.target,r._renderedCamera.position).length()*Math.tan(.5*r._renderedCamera.fov*(Math.PI/180));n=n>a?a:n,this.effectSSLR.uniforms.radius.value=n},setSize:function(e,t){this._parent(e,t)&&(this.composers[0].setSize(this.width,this.height),this.effectSSLRBlurH.uniforms.invSize.value.set(1/this.width,1/this.height),this.effectSSLRBlurV.uniforms.invSize.value.set(1/this.width,1/this.height),this.effectSSLR.uniforms.size.value.set(this.width,this.height))}})}),define("Effects/SSLREffect",["DS/Effects/SSLREffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/SSLREffect"),e}),define("DS/Effects/DebugShadowMapsEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/ReplaceBlendShader","DS/Shaders/DisplayShadowMapsShader"],function(e,t,i,r,n,a,s){"use strict";return t.extend({init:function(t,r){this._parent(t);var s=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");return this.composers.push(new i(t,s,r)),this.debugPass=null,this.mixPass=new n(a,void 0,"DebugShadowMapsEffect"),this.nbLights=0,this},initEffect:function(e,t){null===this.debugPass&&(this.debugPass=new n(s),this.composers[0].addPass(this.debugPass)),t.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,t,i){var r=t.scene,n=r.__lights.length;if(n!==this.nbLights)for(var a=2,s=0;s<n;s++){var o=r.__lights[s];if(o.shadowMap){var l="tDiffuse"+a;void 0!==this.debugPass.uniforms[l]&&(this.debugPass.uniforms[l].value=o.shadowMap),a++}}},setSize:function(e,t){this._parent(e,t)&&this.composers[0].setSize(this.width,this.height)}})}),define("Effects/DebugShadowMapsEffect",["DS/Effects/DebugShadowMapsEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/DebugShadowMapsEffect"),e}),define("DS/Gestures/FlickGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("Flick"),this.priority=15,this._Identifier=-1,this.Flick_Motion=25,this.Flick_Timer=120,this.Flick_Speed=.2,this},changeStateToKO:function(){this._Identifier=-1,this.changeState(i.State.KO)},detect:function(e){this._parent(e);var r=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE,t.State.END]);switch(this.state){case i.State.INIT:1===r.length&&r[0].isInView(this.view)&&r[0].getState()===t.State.BEGIN&&(this.events=r,this._Identifier=r[0].getIdentifier(),this.changeState(i.State.BEGIN));break;case i.State.BEGIN:if(1!==r.length){this.changeStateToKO();break}var n=THREEDS.VisuEventsManager.getTouchEventById(this._Identifier);if(null===n){this.changeStateToKO();break}if(n.getState()===t.State.END){var a=n.offsetPosition.length(),s=n.currentTime-n.startTime,o=a/s;if(a>=this.Flick_Motion&&s<=this.Flick_Timer&&o>=this.Flick_Speed){this.events=[n],this.changeState(i.State.OK);break}this.changeState(i.State.KO);break}break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this._Identifier=-1,this.changeState(i.State.INIT)}},getFlickOrigin:function(){var e;return this.getEvents().length>0&&(e=this.getEvents()[0].getStartPosition()),e},getFlickVector:function(){if(this.getEvents().length>0){var e=this.getEvents()[0].getCurrentPosition();return e.sub(this.getEvents()[0].getStartPosition()),e}return null},getFlickDuration:function(){return this.getEvents().length>0?this.getEvents()[0].currentTime-this.getEvents()[0].startTime:null}});return UWA.namespace("THREEDS/Gestures/FlickGesture",r)}),define("Gestures/FlickGesture",["DS/Gestures/FlickGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/FlickGesture"),e}),define("DS/Visualization/IdPath",["DS/Visualization/PathElement"],function(e){"use strict";var t=function(e){this.ids=e,this._key=null};return t.prototype.removeLastId=function(){this.ids.length>0&&this.ids.length--,this._key=null},t.prototype.clone=function(){var e,i=[];for(e=0;e<this.ids.length;e++)i.push(this.ids[e]);var r=new t(i);return r._key=this._key,r},t.prototype.buildPathElement=function(t){var i,r,n=[];for(r=0;r<this.ids.length;r++){if(!(i=t.idToNode(this.ids[r])))return null;n.push(i)}return new e(n)},t.prototype.getElement=function(e){return this.ids[e]},t.prototype.getLength=function(){return this.ids.length},t.prototype.getFirstElement=function(e){return this.ids[0]},t.prototype.getKey=function(){return null===this._key&&(this._key=t.buildIdPathKey(this.ids)),this._key},t.prototype.getLastId=function(){return this.ids[this.ids.length-1]},t.buildIdPathKey=function(e){var t,i="";for(t=e.length-1;t>=0;t--)i+=e[t],0!==t&&(i+="/");return i},t}),define("DS/Effects/ComputeSDFFontIterative",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/NothingShader","DS/Shaders/PreComputeSDFFontIterativeShaders","DS/Shaders/EncodeHDRShader"],function(e,t,i,r,n,a,s){"use strict";return t.extend({init:function(e,t){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=t,this.__renderer=e,this.passComputeSDFFontSeed=null,this.passComputeSDFFontFlood=null,this.passComputeSDFFontMerge=null,this.OutputRatio=.25,this.texture=null,this.passDisplayMap=null,this.passNothing=null,this},setMap:function(t,s){if(this.texture=t,this.width=parseInt(t.image.width),this.height=parseInt(t.image.height),this.composers[1])this.composers[1].setSize(this.width,this.height),this.passComputeSDFFontSeed.uniforms.prevMap.value=this.texture;else{(l=new e.WebGLRenderTargetProperties(this.width,this.height,"maxPrecisionNearest")).generateMipmaps=!1,l.mapping=this.texture.mapping,this.composers[1]=new i(this.renderer,l,this.renderTargetPool),this.composers[1].composerContext.keepResult=!0,this.passComputeSDFFontSeed=new r(a.ComputeSDFFontSeed),this.passComputeSDFFontSeed.compileShader(this.__renderer),this.passComputeSDFFontSeed.uniforms.prevMap.value=this.texture,this.passComputeSDFFontFlood=new r(a.ComputeSDFFontFlood),this.passComputeSDFFontMerge=new r(a.ComputeSDFFontMerge);var o=new r(n);this.composers[1].addPass(this.passComputeSDFFontSeed),this.composers[1].addPass(this.passComputeSDFFontFlood),this.composers[1].addPass(this.passComputeSDFFontMerge),this.composers[1].addPass(o)}var l,c=this.getOutputSize();this.composers[0]?this.composers[0].setSize(c.width,c.height):((l=new e.WebGLRenderTargetProperties(c.width,c.height,"uint")).generateMipmaps=!1,l.mapping=this.texture.mapping,this.composers[0]=new i(this.renderer,l,this.renderTargetPool),this.composers[0].composerContext.keepResult=!1,this.passDisplayMap=new r(a.ComputeSDFFontDisplay),this.passDisplayMap.renderToScreen=!1,this.composers[0].addPass(this.passDisplayMap),this.composers[1].linkToShaderPassUniform(this.passDisplayMap,this.passDisplayMap.uniforms.tDiffuse));this.passComputeSDFFontFlood.uniforms.invSize.value.set(1/this.width,1/this.height)},executeStep:function(t,i){var r=null;if(i)this.composers[1].enablePass(this.passComputeSDFFontSeed,!1),this.composers[1].enablePass(this.passComputeSDFFontFlood,!1),this.composers[1].enablePass(this.passComputeSDFFontMerge,!0),r=this.composers[1].composerContext.getResult(void 0,!0),this.passComputeSDFFontMerge.uniforms.prevMap.value=r;else if(t>0){this.composers[1].enablePass(this.passComputeSDFFontSeed,!1),this.composers[1].enablePass(this.passComputeSDFFontFlood,!0),this.composers[1].enablePass(this.passComputeSDFFontMerge,!1),r=this.composers[1].composerContext.getResult(void 0,!0),this.passComputeSDFFontFlood.uniforms.prevMap.value=r;this.passComputeSDFFontFlood.uniforms.invSize.value.set(1/this.width,1/this.height)}else this.composers[1].enablePass(this.passComputeSDFFontSeed,!0),this.composers[1].enablePass(this.passComputeSDFFontFlood,!1),this.composers[1].enablePass(this.passComputeSDFFontMerge,!1),this.passComputeSDFFontFlood.uniforms.prevMap.value=this.texture;this.__renderer.materialToUse=e.MaterialToUse.originalMaterial,this.composers[1].render(),r&&(this.renderTargetPool.pushRenderTarget(r),r=null)},renderToScreen:function(){this.passDisplayMap.renderToScreen=!0,this.composers[0].render()},renderOffscreen:function(){this.passDisplayMap.renderToScreen=!1,this.composers[0].render()},getOutputSize:function(){return{width:Math.floor(this.width*this.OutputRatio),height:Math.floor(this.height*this.OutputRatio)}}})}),define("DS/Gestures/SmartEditGesture",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture","DS/WebRecordEnabler/Adapter"],function(e,t,i,r,n){"use strict";var a=r.extend({init:function(){return this._parent("SmartEdit"),this.priority=10,this.identifier=null,this.maxTimeTouch=300,this.maxTimeMouse=300,this.maxDistance=10,this.timer=null,this._type=-1,this.event=null,this},detect:function(e){this._parent(e);var t=this,a=THREEDS.VisuEventsManager.getTouchEventsByStates([i.State.BEGIN,i.State.MOVE,i.State.IDLE]),s=THREEDS.VisuEventsManager.getMouseEvents(null,this.view),o=null;switch(this.state){case r.State.INIT:if(1===a.length||this.onlyLeftMouse(s))if(this.resetTimer(),1===a.length?(o=THREEDS.VisuEventsManager.getTouchEventsByStates([i.State.BEGIN],this.view),this._type=1):s.length&&(o=THREEDS.VisuEventsManager.getMouseEventsByStates([i.State.BEGIN],0,this.view),this._type=0),o&&1===o.length){this.resetTimer();var l=1===this._type?this.maxTimeTouch:this.maxTimeMouse;this.identifier=o[0].identifier,this.event=o[0],l?(n.isReplaying()||(this.timer=setTimeout(function(){t.events=[o[0]],t.changeState(r.State.OK),t.execute(!0),t._type=-1},l)),this.changeState(r.State.BEGIN)):(this.events=[o[0]],this.changeState(r.State.OK),this._type=-1)}else this._type=-1;break;case r.State.BEGIN:var c=null;1===this._type?c=THREEDS.VisuEventsManager.getTouchEventById(this.identifier):0===this._type&&(c=this.event),1===this._type&&1!==a.length||0===this._type&&!this.onlyLeftMouse(s)||null===c||c.state===i.State.END?(this.resetTimer(),this.changeState(r.State.KO)):c.state===i.State.MOVE&&c.offsetPosition.length()>this.maxDistance&&(this.events=[c],this.changeState(r.State.OK),this._type=-1);break;case r.State.KO:case r.State.OK:case r.State.CANCEL:this.changeState(r.State.INIT)}},onlyLeftMouse:function(e){for(var t=0;t<e.length;t++)if(0!==e[t].button&&-1!==e[t].button)return!1;return!0},resetTimer:function(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null,this._type=-1)},whenKO:function(){this.resetTimer(),this.changeState(r.State.KO)}});return UWA.namespace("THREEDS/Gestures/SmartEditGesture",a)}),define("DS/Visualization/RenderStyle",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/RenderMode"],function(e,t,i){"use strict";var r=e.extend({init:function(e){if(e=e||{},this._renderMode=new i,this._renderMode._setMask(t.ShowAllRenderLineMode|t.ShowAllFaces),e.hasOwnProperty("faceMode")){this._materialMode=!1;var n=e.faceMode;"MATERIAL"!==n&&"GAS"!==n||(this._materialMode="MATERIAL"===n,n="COLOR"),this._faceMode=n?r.FaceModes[n]:r.FaceModes.unset}else this._materialMode=!0,this._faceMode=r.FaceModes.COLOR;this._materialMode=e.hasOwnProperty("materialMode")?!!e.materialMode:this._materialMode,this._combineRenderModeValue=e.combineRenderMode?r.CombineRenderMode[e.combineRenderMode]:r.CombineRenderMode.REPLACE,this._locked=!1},setOutlineWidth:function(e){this._renderMode.setOutlineWidth(e)},setHalfVisibleSmoothEdges:function(e){this._renderMode.setHalfVisibleSmoothEdges(e)},setHiddenEdges:function(e){this._renderMode.setHiddenEdges(e)},setRenderMode:function(e,t){return!this._locked&&(this._renderMode.setRenderMode(e,t),!0)},setFaceMode:function(e){if(this._locked)return!1;var t=e;return"MATERIAL"!==t&&"GAS"!==t||(this._materialMode="MATERIAL"===e,t="COLOR"),this._faceMode=r.FaceModes[t],!0},setMaterialMode:function(e){return!this._locked&&(this._materialMode=!!e,!0)},clone:function(){var e=new r;return e._renderMode=this._renderMode.clone(),e._faceMode=this._faceMode,e._materialMode=this._materialMode,e._combineRenderModeValue=this._combineRenderModeValue,e},dumpToJSON:function(){return{version:1,renderModeMask:this._renderMode.getMask(),faceMode:this._faceMode,materialMode:this._materialMode,combineMode:this._combineRenderModeValue,outlineWidth:this._renderMode._outlineWidth}},_lock:function(){this._locked=!0},_combineFaceMode:function(e){return 0!==this._faceMode?{face:this._faceMode,material:this._faceMode===r.FaceModes.COLOR&&this._materialMode}:e},_combineRenderMode:function(e,t){var i,r;switch(this._combineRenderModeValue){case 0:return t||e;case 1:return this._renderMode;case 2:return e?(r=(i=this._renderMode.clone()).getMask()|e.getMask(),i._setMask(r),i):this._renderMode;case 3:return e?(r=(i=this._renderMode.clone()).getMask()&e.getMask(),i._setMask(r),i):this._renderMode}return null},_displayNothingRenderMode:function(){this._renderMode._displayNothing()}});return r.FaceModes={unset:0,COLOR:1,ZONLY:2,BACKGROUND:3},r.CombineRenderMode={IGNORE:0,REPLACE:1,OR:2,AND:3},r.compareDumpJSON=function(e,t){return e.renderModeMask===t.renderModeMask&&e.faceMode===t.faceMode&&e.materialMode===t.materialMode&&e.combineMode===t.combineMode&&e.outlineWidth===t.outlineWidth},t.RenderStyle=r,r}),define("DS/Plugins/CSSNodesPass",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=function(e,t){this.scene=e,this.name=t,this.cameraName="main"};return t.prototype={getDefaultState:function(){return{enabled:!1,renderPlugins:!1}},setScene:function(e){this.scene=e},render:function(e,t,i,r,n,a,s,o,l){var c=s[o];e.updateCSSNodes(this.scene,c)}},t}),define("DS/Effects/ComputeSDFFontMergeTiles",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/NothingShader","DS/Shaders/PreComputeSDFFontIterativeShaders"],function(e,t,i,r,n,a){"use strict";return t.extend({init:function(t,i){return this._parent(t),this.renderer=t,this.rtPool=i,this.width=512,this.height=512,this.tileMin=new e.Vector2,this.tileMax=new e.Vector2,this.realTileMax=new e.Vector2,this.map=null,this.passMergeTile=null,this.passNothing=null,this},setSize:function(e,t){this.width=parseInt(e),this.height=parseInt(t)},setTileInfos:function(e,t,i,r,n,a){this.tileMin.set(e/this.width,t/this.height),this.tileMax.set((e+i)/this.width,(t+r)/this.height),this.realTileMax.set((e+n)/this.width,(t+a)/this.height),this.passMergeTile&&(this.passMergeTile.uniforms.tileMin.value=this.tileMin,this.passMergeTile.uniforms.tileMax.value=this.tileMax,this.passMergeTile.uniforms.realTileMax.value=this.realTileMax)},setInput:function(t){if(t){if(this.map=t,this.composers[0])this.composers[0].setSize(this.width,this.height);else{var s=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers[0]=new i(this.renderer,s,this.rtPool),this.composers[0].composerContext.keepResult=!0,this.passMergeTile=new r(a.MergeTiles),this.passMergeTile.renderToScreen=!1,this.passNothing=new r(n),this.composers[0].addPass(this.passMergeTile),this.composers[0].addPass(this.passNothing)}this.map.linkToShaderPassUniform(this.passMergeTile,this.passMergeTile.uniforms.tDiffuse2)}},execute:function(){this.composers[0].render()}})}),define("DS/Effects/DownSamplingEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/DownSamplingShaders","DS/Plugins/ClearPass"],function(e,t,i,r,n,a){"use strict";return t.extend({init:function(e,t){return this._parent(e),this.renderer=e,this.rtPool=t,this.map=null,this.nbIterations=3,this.passBlurH=[],this},setSize:function(e,t){this.width=parseInt(e),this.height=parseInt(t)},setInput:function(t){if(t){this.map=t;var a=.5;if(this.composers[0])for(var s=0;s<this.nbIterations;s++)this.composers[s].setSize(a*this.width,a*this.height),this.passBlurH[s].uniforms.invSize.value.set(1/(a*this.width),1/(a*this.height)),a*=.5;else{for(s=0;s<this.nbIterations;s++){var o=new e.WebGLRenderTargetProperties(a*this.width,a*this.height,"uint");this.composers[s]=new i(this.renderer,o,this.rtPool),this.composers[s].composerContext.keepResult=!1,this.passBlurH[s]=new r(n.DownSampling),this.passBlurH[s].uniforms.invSize.value.set(1/(a*this.width),1/(a*this.height)),this.passBlurH[s].material.needsUpdate=!0,this.passBlurH[s].renderToScreen=!1,this.composers[s].addPass(this.passBlurH[s]),a*=.5}this.composers[this.nbIterations-1].composerContext.keepResult=!1;for(s=1;s<this.nbIterations;s++)this.passBlurH[s].addRequiredComposer(this.composers[s-1]),this.composers[s-1].linkToShaderPassUniform(this.passBlurH[s],this.passBlurH[s].uniforms.tDiffuse2)}this.map.linkToShaderPassUniform(this.passBlurH[0],this.passBlurH[0].uniforms.tDiffuse2)}},execute:function(){this.composers[this.nbIterations-1].render()}})}),define("DS/Effects/GenerateMipMaps",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/DownSamplingShaders","DS/Shaders/DisplayIrradianceMapShader"],function(e,t,i,r,n,a){"use strict";return t.extend({init:function(e,t){return this._parent(e),this.renderer=e,this.rtPool=t,this.map=null,this.nbIterations=9,this.passMip=[],this.passMergeMips=null,this.passDisplayMap=null,this},setSize:function(t,i){this.width="string"==typeof t?parseInt(t):t,this.height="string"==typeof i?parseInt(i):i,this.nbIterations=Math.min(Math.round(Math.log(Math.min(this.width,this.height))/Math.log(2)),e.supportedExtensions.fragmentTextureUnits)-1},setInput:function(t){if(t){this.map=t;var s=.5;if(this.composers[0]){for(var o=0;o<this.nbIterations;o++)this.composers[o].setSize(s*this.width,s*this.height),this.passMip[o].uniforms.invSize.value.set(1/(s*this.width),1/(s*this.height)),s*=.5;this.composers[this.nbIterations].setSize(this.width,2*this.height)}else{for(o=0;o<this.nbIterations;o++){var l=new e.WebGLRenderTargetProperties(s*this.width,s*this.height,"iblLinear");this.composers[o]=new i(this.renderer,l,this.rtPool),this.composers[o].composerContext.keepResult=!1,this.composers[o].composerContext.noIdCheck=!0,this.passMip[o]=new r(n.DownSamplingBlur,void 0,"GenerateMips"+o),this.passMip[o].uniforms.invSize.value.set(1/(s*this.width),1/(s*this.height)),this.passMip[o].material.needsUpdate=!0,this.passMip[o].renderToScreen=!1,this.composers[o].addPass(this.passMip[o]),s*=.5}var c=new e.WebGLRenderTargetProperties(this.width,2*this.height,"iblLinear");this.composers[this.nbIterations]=new i(this.renderer,c,this.rtPool),this.composers[this.nbIterations].composerContext.keepResult=!1,this.composers[this.nbIterations].composerContext.noIdCheck=!0,this.passMergeMips=new r(n.MergeMips(this.nbIterations),void 0,"MergeMips"),this.passMergeMips.renderToScreen=!1,this.composers[this.nbIterations].addPass(this.passMergeMips);for(o=1;o<this.nbIterations;o++)this.passMip[o].addRequiredComposer(this.composers[o-1]),this.composers[o-1].linkToShaderPassUniform(this.passMip[o],this.passMip[o].uniforms.tDiffuse2);this.passMergeMips.addRequiredComposer(this.composers[this.nbIterations-1]),this.map.linkToShaderPassUniform(this.passMergeMips,this.passMergeMips.uniforms.tDiffuse1);for(o=0;o<this.nbIterations;o++)this.composers[o].linkToShaderPassUniform(this.passMergeMips,this.passMergeMips.uniforms["tDiffuse"+(o+2)])}this.map.linkToShaderPassUniform(this.passMip[0],this.passMip[0].uniforms.tDiffuse2);var h=this.nbIterations+1;if(this.composers[h])this.composers[h].setSize(this.width,2*this.height);else{var u=new e.WebGLRenderTargetProperties(this.width,2*this.height,"uint");u.generateMipmaps=!1,this.composers[h]=new i(this.renderer,u,this.rtPool),this.composers[h].composerContext.keepResult=!1,this.composers[h].composerContext.noIdCheck=!0,this.passDisplayMap=new r(a,void 0,"DisplayMips"),this.composers[h].composerContext.setPassRenderToCanvas(this.passDisplayMap,!0),this.composers[h].addPass(this.passDisplayMap),this.composers[this.nbIterations].linkToShaderPassUniform(this.passDisplayMap,this.passDisplayMap.uniforms.tDiffuse1)}}},execute:function(){this.composers[this.nbIterations].render()},getResult:function(){return this.composers[this.nbIterations]},renderToScreen:function(){this.composers[this.nbIterations+1].render()}})}),define("DS/Visualization/BoundingBoxGPUCompute",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i=e.extend({init:function(e){return this.renderer=e,this.minMaxExtension=t.supportedExtensions.minMaxBlending,this.useBackUpAlgorithm=!0,//!(this.renderer.renderer.supportsFloatTextures() && this.minMaxExtension);
this._pixels=this.useBackUpAlgorithm?1:32,this.renderTarget=null,this.zRenderTarget=null,this.zMaterial=null,this.material=null,this._useUnindexed=null!=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),this},setPixelCount:function(e){this._pixels=e,this.renderTarget&&_initRenderTarget()},_initBackUpMaterial:function(){var e=new t.ParticleBasicMaterial;e.sizeAttenuation=!1,e.activatePDSFX();var i={composante:{type:"v3",value:new t.Vector3},orientationMatrix:{type:"m4",value:new t.Matrix4},zMin:{type:"f",value:0},zMax:{type:"f",value:0}};e.setPDSFXUniforms(i);e.setPDSFXVaryings({vZ:{type:"f"}});var r={ComputeVaryingValues:["void ComputeVaryingValues() {","vZ=dot(composante,vec3(orientationMatrix * modelMatrix * vec4( position, 1.0 )));","gl_Position=vec4(0.0,0.0,2.0*(vZ)/(zMax-zMin)-(zMin+zMax)/(zMax-zMin),1.0);","}"].join("\n"),ComputeObjectTexCoord0:["vec4 ComputeObjectTexCoord0() {","\treturn vec4(0.0,0.0, 0.0, 0.0);","}"].join("\n"),ComputeObjectNormal:["vec3 ComputeObjectNormal() {","\treturn vec3(0.0,0.0,1.0);","}"].join("\n")},n={ProcessFinalColor:["float shift_right(float v, float amt) {","v = floor(v) + 0.5;","return floor(v / exp2(amt));","}","float shift_left(float v, float amt) {","return floor(v * exp2(amt) + 0.5);","}","float mask_last(float v, float bits) {","return mod(v, shift_left(1.0, bits));","}","float extract_bits(float num, float from, float to) {","from = floor(from + 0.5);","to = floor(to + 0.5);","return mask_last(shift_right(num, from), to - from);","}","vec4 encode_float(float val) {","if (val == 0.0)","return vec4(0, 0, 0, 0);","float sign = val > 0.0 ? 0.0 : 1.0;","val = abs(val);","float exponent = floor(log2(val));","float biased_exponent = exponent + 127.0;","float fraction = ((val / exp2(exponent)) - 1.0) * 8388608.0;","float t = biased_exponent / 2.0;","float last_bit_of_biased_exponent = fract(t) * 2.0;","float remaining_bits_of_biased_exponent = floor(t);","float byte4 = extract_bits(fraction, 0.0, 8.0) / 255.0;","float byte3 = extract_bits(fraction, 8.0, 16.0) / 255.0;","float byte2 = (last_bit_of_biased_exponent * 128.0 + extract_bits(fraction, 16.0, 23.0)) / 255.0;","float byte1 = (sign * 128.0 + remaining_bits_of_biased_exponent) / 255.0;","return vec4(byte4, byte3, byte2, byte1);","}","void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = encode_float(vZ);","}"].join("\n")};return e.setPDSFXOverridableFunctions(r,n),e},_initRenderTarget:function(){if(this.useBackUpAlgorithm){var e={minFilter:t.NearestFilter,magFilter:t.NearestFilter,type:t.UnsignedByteType,format:t.RGBAFormat};this.renderTarget=new t.WebGLRenderTarget(6,this._pixels,e)}else{e={minFilter:t.NearestFilter,magFilter:t.NearestFilter,type:t.FloatType,format:t.RGBAFormat};this.renderTarget=new t.WebGLRenderTarget(this._pixels,2,e)}},_initZRenderTarget:function(){var e={minFilter:t.NearestFilter,magFilter:t.NearestFilter,type:t.UnsignedByteType,format:t.RGBAFormat};this.zRenderTarget=new t.WebGLRenderTarget(1,1,e)},_drawBBDGsDepth:function(e,i,r,n,a){this.material||(this.material=this._initBackUpMaterial()),this.material.updatePDSFXUniform("orientationMatrix",i),this.material.updatePDSFXUniform("composante",a),this.material.updatePDSFXUniform("zMin",r),this.material.updatePDSFXUniform("zMax",n),this.material.id++;var s=!0,o=new t.OrthographicCamera;if(this._useUnindexed)for(h=0;h<e.length;h++){var l=e[h].renderable;for(d=0;d<l.geometry.length;d++){var c=l.geometry[d];p={glType:0,start:0,count:c.getVertexCount()||c.vertexCountGPU,nonIndexed:!0};this.renderer.renderer.renderInterval(o,[],l,this.material,null,c,p,p.start,p.count,null,null,s,null,null,null,null,0),s=!1}}else for(var h=0;h<e.length;h++)for(var u=e[h],d=0;d<u.obj.length;d++){var p,f=(p=u.obj[d]).glType;p.glType=0,this.renderer.renderer.renderInterval(o,[],u.renderable,this.material,null,p.geometry,p,p.start,p.count,null,null,s,null,null,null,null,0),p.glType=f,s=!1}},_drawZMinDGsDepth:function(e,i,r){this.zMaterial||(this.zMaterial=this._initBackUpMaterial()),this.zMaterial.updatePDSFXUniform("orientationMatrix",new t.Matrix4),this.zMaterial.updatePDSFXUniform("composante",new t.Vector3(0,0,1)),this.zMaterial.updatePDSFXUniform("zMin",i),this.zMaterial.updatePDSFXUniform("zMax",r),this.zMaterial.id++;for(var n=!0,a=new t.OrthographicCamera,s=0;s<e.length;s++)for(var o=e[s],l=0;l<o.geometry.length;l++){var c=o.geometry[l];var h={glType:0,start:0,count:c.getVertexCount()||c.vertexCountGPU,nonIndexed:!0};this.renderer.renderer.renderInterval(a,[],o,this.zMaterial,null,c,h,h.start,h.count,null,null,n,null,null,null,null,0),n=!1}},_setRendererState:function(){var e,t,i=this.renderer.gl.getParameter(this.renderer.gl.SCISSOR_BOX);t=this.renderer.renderer.getViewport(),e=this.renderer.renderer.getScissorTest();var r=this.renderer.renderer.enablerenderPluginsPre;this.renderer.renderer.enableRenderPluginsPre=!1;var n=this.renderer.renderer.renderPointMode;return this.renderer.renderer.renderPointMode=!0,this.renderer.renderer.materialToUse=0,{scissor:e,scissorValue:i,viewport:t,enablerenderpluginsPre:r,renderPointMode:n,depthTest:this.renderer.renderer._oldDepthTest}},_resetRendererState:function(e){this.renderer.renderer.setViewport(e.viewport.x,e.viewport.y,e.viewport.width,e.viewport.height),this.renderer.renderer.enableScissorTest(e.scissor),this.renderer.renderer.setScissor(e.scissorValue[0],e.scissorValue[1],e.scissorValue[2],e.scissorValue[3]),this.renderer.renderer.renderPointMode=e.renderPointMode,this.renderer.renderer.setDepthTest(e.depthTest),this.renderer.renderer.enableRenderPluginsPre=e.enablerenderpluginsPre;var t=this.renderer.renderer.getClearColor(),i=this.renderer.renderer.getClearAlpha();this.renderer.gl.clearColor(t.r,t.g,t.b,i)},computeZMinGPU:function(e,t){this.zRenderTarget||this._initZRenderTarget(),this.renderer.renderer.setRenderTarget(this.zRenderTarget);var i=this._setRendererState(),r=e.getSceneBoundingSphere();if(r.pixelRadius>0){var n=e.currentViewpoint.camera,a=n.getWorldSizeFromPixelSize(1,r.center,e._getDivClientHeight());if(void 0!==n.fullWidth&&n.fullWidth>0)a*=Math.max(1*n.width/n.fullWidth,1*n.height/n.fullHeight);r.radius+=a*r.pixelRadius}var s=this._computeZMin(t,r);return this._resetRendererState(i),s},computeBoundingBoxGPU:function(e,i,r){r||(r=new t.Matrix4);var n=(new t.Matrix4).getInverse(r);this.renderTarget||this._initRenderTarget(),this.renderer.renderer.setRenderTarget(this.renderTarget),this.renderer.renderer.clearCurrentBuffer();var a,s=this._setRendererState(),o=e.getSceneBoundingSphere();if(o.center.applyMatrix4(n),o.pixelRadius>0){var l=e.currentViewpoint.camera,c=l.getWorldSizeFromPixelSize(1,o.center,e._getDivClientHeight());if(void 0!==l.fullWidth&&l.fullWidth>0)c*=Math.max(1*l.width/l.fullWidth,1*l.height/l.fullHeight);o.radius+=c*o.pixelRadius}return a=this.useBackUpAlgorithm?this._computeBoundingBoxBackUp(i,n,o):this._computeBoundingBoxMain(i,n,o),this._resetRendererState(s),a},_computeZMin:function(e,t){this.renderer.gl.clearColor(0,0,0,0),this.renderer.renderer.clear(),this.renderer.gl.disable(this.renderer.gl.BLEND),this.renderer.renderer.setDepthTest(!0);var i=this.renderer.renderer.getDepthFunc();this.renderer.renderer.setDepthFunc(this.renderer.gl.LESS);var r=t.center.z;this._drawZMinDGsDepth(e,r-t.radius,r+t.radius),this.renderer.renderer.setDepthFunc(i),this.renderer.renderer.setViewport(0,0,1,1);var n=new Uint8Array(4);return this.renderer.gl.readPixels(0,0,1,1,this.renderer.gl.RGBA,this.renderer.gl.UNSIGNED_BYTE,n),new Float32Array(n.buffer)[0]},_computeBoundingBoxBackUp:function(e,i,r){this.renderer.gl.clearColor(0,0,0,0),this.renderer.renderer.clear(),this.renderer.gl.disable(this.renderer.gl.BLEND),this.renderer.renderer.setDepthTest(!0);var n=this.renderer.renderer.getDepthFunc();this.renderer.renderer.setDepthFunc(this.renderer.gl.LEQUAL);for(var a=0;a<6;a++){this.renderer.renderer.setViewport(a,0,1,this._pixels);new t.Matrix4;var s=new t.Vector3(0,0,1),o=r.center.z;1==a?(s.set(1,0,0),o=r.center.x):2==a?(s.set(0,1,0),o=r.center.y):3==a?(this.renderer.renderer.setDepthFunc(this.renderer.gl.GEQUAL),this.renderer.gl.clearDepth(-1),this.renderer.renderer.clear(!1,!0,!1)):4==a?(s.set(1,0,0),o=r.center.x):5==a&&(s.set(0,1,0),o=r.center.y),this._drawBBDGsDepth(e,i,o-r.radius,o+r.radius,s)}this.renderer.gl.clearDepth(1),this.renderer.renderer.setDepthFunc(n);var l=new Uint8Array(24*this._pixels);this.renderer.gl.readPixels(0,0,6,this._pixels,this.renderer.gl.RGBA,this.renderer.gl.UNSIGNED_BYTE,l);var c=new Float32Array(l.buffer),h=c[0],u=c[1],d=c[2],p=c[3],f=c[4],m=c[5];for(a=1;a<this._pixels;a++)h=Math.min(h,c[6*a]),u=Math.min(u,c[6*a+1]),d=Math.min(d,c[6*a+2]),p=Math.max(p,c[6*a+3]),f=Math.max(f,c[6*a+4]),m=Math.max(m,c[6*a+5]);return new t.Box3(new t.Vector3(u,d,h),new t.Vector3(f,m,p))}});return UWA.namespace("THREEDS/BoundingBoxGPUCompute",i)}),define("DS/Visualization/StaticOverrideSet",["DS/Mesh/MeshUtils"],function(e){"use strict";var t=1;function i(e,i){this.id=t++,this.path=e,this.materialApplication=i}i.prototype.deactivate=function(){this.apply(!1)},i.prototype.apply=function(e){this.path.internalPath.length>0?this.apply_internal(e):this.apply_external(e)},i.prototype.apply_external=function(e){var t,i,r,n,a,s,o;if(e)for(t=this.path.externalPath[0]._occurrences,i=0;i<t.length;i++)o=(r=t[i]).depth,(n=this.path._getOccurrenceFromRootOccurrence(r))&&(a=n.matAppOverride,(s=this.materialApplication)._depth=o,a&&!s.isPrioritary(a,o)||(n.matAppOverride=s.clone()),s._depth=-1);else for(t=this.path._getOccurrences(null),i=0;i<t.length;i++)(n=t[i]).matAppOverride=null},i.prototype.apply_internal=function(t){var i,r,n=this.path.externalPath[0]._occurrences,a=this.path.getLastElement(),s=a&&a instanceof e.SGPrimitiveHelper?[a]:a.getPrimitives();for(r=0;r<n.length;r++)i=n[r],this.applyToRootOccurrence_internal(t,i,s)},i.prototype.applyToRootOccurrence_internal=function(e,t,i){var r=this.path._getOccurrenceFromRootOccurrence(t);if(r){for(var n=r._getRenderableOccurrences(),a=n.length,s=0;s<a;s++){var o=n[s];o&&o._flagAsGSSOInvalidated()}if(i){var l=e?this.materialApplication.clone():null;l&&(l._depth=t.depth);for(s=0;s<n.length;s++)this.applyToRenderable(n[s],i,l)}}},i.prototype.applyToRenderable=function(e,t,i){null===e.layer&&e.initLayers(1),e.layer.addPrimitivesToLayers(t,1,void 0,void 0,i)};var r=function(e){this.root=e,this._overrides=[]};return r.prototype.addStaticOverride=function(e,t){if(e.externalPath[0]===this.root){var r=new i(e,t);return this._overrides.push(r),r.id}return-1},r.prototype.clear=function(){this._deactivateStaticOverrides(),this._overrides=[]},r.prototype.applyStaticOverrides=function(){var e;for(e=0;e<this._overrides.length;e++)this._overrides[e].apply(!0)},r.prototype._deactivateStaticOverrides=function(){var e;for(e=0;e<this._overrides.length;e++)this._overrides[e].apply(!1)},r}),define("DS/Shaders/VolumeRenderingShaders",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{RenderChunk:{defines:{RANDOM_STEP:!0,USE_CLIP_PLANE:!1,ISO_SURFACE:0,MAX_STEPS:"256",CHUNK_SIZE:"64.0",MAP_INVSIZE:"0.001953125"},uniforms:{tDiffuse:{type:"t",value:null},prevMap:{type:"t",value:null},tNormalDepth:{type:"t",value:null},tRandomTexture:{type:"t",value:null},nbCol:{type:"i",value:0,stage:e.FragmentStage},map0:{type:"t2",value:null},mapDim:{type:"v3",value:new e.Vector3},minDisplayValue:{type:"f",value:0},maxDisplayValue:{type:"f",value:1},rangeDisplayValue:{type:"f",value:1},minTileValue:{type:"f",value:0},maxTileValue:{type:"f",value:1},rangeTileValue:{type:"f",value:1},isoValue:{type:"f",value:.1},uTMK:{type:"f",value:128},attenuationCoeff:{type:"f",value:.01},attenuationScale:{type:"f",value:1},colorCoeff:{type:"v4",value:new e.Vector4(.737,.573,.4,1)},colorMap:{type:"t",value:null},transferFctMap:{type:"t",value:null},gridSize:{type:"v3",value:new e.Vector3},modelMatrixInv:{type:"m4",value:new e.Matrix4},realProjectionMatrix:{type:"m4",value:new e.Matrix4},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},realModelViewMatrix:{type:"m4",value:new e.Matrix4},realModelViewMatrixInverse:{type:"m4",value:new e.Matrix4},clipPlaneEquation:{type:"v4",value:new e.Vector4},debugChunkBox:{type:"v4",value:new e.Vector4(0,0,0,0)},renderIteration:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#define TM_MIN 0.05","#define EPS 0.0001","#define PI 3.14159265","#define HALFPI 1.57079633","#define ROOTTHREE 1.73205081","uniform sampler2D tDiffuse;","uniform sampler2D prevMap;","uniform sampler2D tNormalDepth;","uniform sampler2D tRandomTexture;","uniform mat4 realProjectionMatrixInverse;","uniform mat4 realModelViewMatrix;","uniform mat4 realModelViewMatrixInverse;","#if defined(USE_CLIP_PLANE)","uniform vec4 clipPlaneEquation;","#endif","uniform vec3 gridSize;","uniform float uTMK;","uniform float attenuationCoeff;","uniform float attenuationScale;","uniform vec4 colorCoeff;","uniform sampler2D colorMap;","uniform sampler2D transferFctMap;","uniform int nbCol;","uniform vec3 mapDim;","uniform sampler2D map0;","uniform float minDisplayValue;","uniform float maxDisplayValue;","uniform float rangeDisplayValue;","uniform float minTileValue;","uniform float maxTileValue;","uniform float rangeTileValue;","uniform float isoValue;","uniform vec4 debugChunkBox;","uniform float renderIteration;","varying vec2 vUv;","float stepSize;","float stepSizeModel;","float depthVS;","const vec3 weight = vec3(1.0, 0.32, 0.08);","const vec3 lightColor = vec3(1.0, 1.0, 1.0);","const vec3 lightPos = vec3(100.0, 100.0, 100.0);","const float shininess = 40.0;","float random(vec3 scale, float seed) {","  return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","float Random1D(float seed) {","return random(vec3(12.9898, 78.233, 151.7182), seed);","}","float getStepOffset() {","    return (Random1D(gl_FragCoord.x * gl_FragCoord.y) - 0.5);","}","float getStepOffset(float ii) {","    return (Random1D(gl_FragCoord.x * gl_FragCoord.y * ii) - 0.5);","}","float modI(float a, float b) {","float m = a - floor((a + 0.5) / b) * b;","return floor(m + 0.5);","}","vec3 precomputeRandom1D(vec2 coords, float ii) {","vec2 s = 0.2 * (vec2(modI(coords.x+ii*ii, 5.0), modI(coords.y+ii, 5.0)) + 0.5);","return texture2D(tRandomTexture, s).xyz;","}","float fetchDepthVS(const in vec2 uv) {","    float depth = texture2D(tNormalDepth, uv).w;","if (depth == 0.0) { depth = 1.0; };","vec4 vertexPositionProjected = vec4(uv * 2.0 - 1.0, 2.0 * depth - 1.0, 1.0);","vec4 vertexPositionVS = realProjectionMatrixInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","return vertexPositionVS.z;","}","float sampleVolTex(vec3 pos) {","float rowID = floor(pos.z / float(nbCol));","float rowID2 = rowID;","float colID = mod(floor(pos.z), float(nbCol));","float colID2 = mod(ceil(pos.z), float(nbCol));","if (colID2 == 0.0) { rowID2 = rowID2 + 1.0; }","float x1 = colID  * CHUNK_SIZE + pos.x + 0.5;","float x2 = colID2 * CHUNK_SIZE + pos.x + 0.5;","float y1 = rowID  * CHUNK_SIZE + pos.y + 0.5;","float y2 = rowID2 * CHUNK_SIZE + pos.y + 0.5;","vec2 mapUV  = vec2(x1 * MAP_INVSIZE, 1.0 - y1 * MAP_INVSIZE);","vec2 mapUV2 = vec2(x2 * MAP_INVSIZE, 1.0 - y2 * MAP_INVSIZE);","float alpha1 = texture2D(map0, mapUV).a;","float alpha2 = texture2D(map0, mapUV2).a;","return mix(alpha1, alpha2, fract(pos.z));","}","vec4 raymarch(vec3 ro, vec3 rd, vec4 prevData) {","vec3 ratio = (mapDim - vec3(1.0)) / gridSize;","#if defined(RANDOM_STEP)","float offset = 1.0 + 0.8 * getStepOffset(renderIteration);","#else","float offset = 1.0;","#endif","vec3 posModel = ro;","vec3 posGrid = (ro + 0.5 * gridSize) * ratio;","vec3 stepModel = offset * rd * stepSizeModel;","vec3 stepGrid = stepModel * ratio;","vec3 col = prevData.rgb;","float tm = prevData.a;","for (int i=0; i<MAX_STEPS; ++i) {","vec4 posVS = realModelViewMatrix * vec4(posModel, 1.0);","if (posVS.z < depthVS) { break; }","#if defined(USE_CLIP_PLANE)","float clipDist = dot(posVS.xyz, clipPlaneEquation.xyz) + clipPlaneEquation.w;","if (clipDist >= 0.0) {","#endif","float normalizedDensity = sampleVolTex(posGrid.xyz);","float density = minTileValue + normalizedDensity * rangeTileValue;","float remappedDensity = (density - minDisplayValue) / rangeDisplayValue;","remappedDensity = min(max(remappedDensity, 0.0028), 0.997);","vec3 color = texture2D(colorMap, vec2(remappedDensity, 0.5)).rgb;","float opacity = texture2D(transferFctMap, vec2(remappedDensity, 0.5)).r;","opacity *= step(minDisplayValue, density) * step(-maxDisplayValue, -density);","float dtm = exp( -uTMK * stepSizeModel * attenuationCoeff * attenuationScale * opacity );","tm *= dtm;","col += (1.0 - dtm) * color * tm;","#if defined(USE_CLIP_PLANE)","}","#endif","posGrid += stepGrid;","posModel += stepModel;","if (tm < 0.0 || posGrid.x > mapDim.x - 1.0 || posGrid.x < 0.0 || posGrid.y > mapDim.y - 1.0 || posGrid.y < 0.0 || posGrid.z > mapDim.z - 1.0 || posGrid.z < 0.0)","break;","}","return vec4(col, tm);","}","vec4 add_lighting(float value, vec3 loc, vec3 step, vec3 rd) {","vec3 V = normalize(rd);","vec3 N;","float val1, val2;","val1 = sampleVolTex(loc + vec3(-step[0], 0.0, 0.0));","val2 = sampleVolTex(loc + vec3(+step[0], 0.0, 0.0));","N[0] = val1 - val2;","value = max(max(val1, val2), value);","val1 = sampleVolTex(loc + vec3(0.0, -step[1], 0.0));","val2 = sampleVolTex(loc + vec3(0.0, +step[1], 0.0));","N[1] = val1 - val2;","value = max(max(val1, val2), value);","val1 = sampleVolTex(loc + vec3(0.0, 0.0, -step[2]));","val2 = sampleVolTex(loc + vec3(0.0, 0.0, +step[2]));","N[2] = val1 - val2;","value = max(max(val1, val2), value);","float gm = length(N);","N = normalize(N);","float Nselect = float(dot(N, rd) > 0.0);","N = (2.0 * Nselect - 1.0) * N;","vec3 ambient_color = vec3(0.0);","vec3 diffuse_color = vec3(0.0);","vec3 specular_color = vec3(0.0);","vec3 L = normalize(rd);","float lightEnabled = float(length(L) > 0.0);","L = normalize(L + (1.0 - lightEnabled));","float lambertTerm = clamp(dot(N, L), 0.0, 1.0);","vec3 H = normalize(L+rd); // Halfway vector","float specularTerm = pow(max(dot(H, N), 0.0), shininess);","float mask1 = lightEnabled;","ambient_color += mask1 * ambient_color;","diffuse_color += mask1 * lambertTerm;","specular_color += mask1 * specularTerm * specular_color;","vec3 color = texture2D(colorMap, vec2(isoValue, 0.5)).rgb;","return vec4(color * (ambient_color + diffuse_color) + specular_color, 1.0);","}","vec4 raymarchIso(vec3 ro, vec3 rd, vec4 prevData) {","vec3 ratio = (mapDim - vec3(1.0)) / gridSize;","vec3 stepModel = rd * stepSizeModel;","vec3 stepGrid = stepModel * ratio;","vec3 posModel = ro;","vec3 posGrid = (ro + 0.5 * gridSize) * ratio;","vec3 dStep = 1.5 / mapDim;","vec3 col = prevData.rgb;","float tm = prevData.a;","if (tm > 0.5) { return prevData; }","for (int i=0; i<MAX_STEPS; ++i) {","float density = sampleVolTex(posGrid.xyz);","float remappedDensity = (density - minDisplayValue) / rangeDisplayValue;","remappedDensity = min(max(remappedDensity, 0.0), 1.0);","if (remappedDensity > isoValue) {","vec3 interPosGrid = posGrid - 1.0 * stepGrid;","vec3 interPosModel = posModel - 1.0 * stepModel;","vec3 smallStepGrid = 0.25 * stepGrid;","vec3 smallStepModel = 0.25 * stepModel;","for (int i=0; i<4; i++) {","density = sampleVolTex(interPosGrid.xyz);","remappedDensity = (density - minDisplayValue) / rangeDisplayValue;","remappedDensity = min(max(remappedDensity, 0.0), 1.0);","if (remappedDensity > isoValue) {","return add_lighting(remappedDensity, interPosGrid, dStep, rd);","}","interPosGrid += smallStepGrid;","interPosModel += smallStepModel;","}","}","posGrid += stepGrid;","posModel += stepModel;","if (tm < 0.0 || posGrid.x > mapDim.x - 1.0 || posGrid.x < 0.0 || posGrid.y > mapDim.y - 1.0 || posGrid.y < 0.0 || posGrid.z > mapDim.z - 1.0 || posGrid.z < 0.0)","break;","vec4 posVS = realModelViewMatrix * vec4(posModel, 1.0);","if (posVS.z < depthVS) { break; }","}","return vec4(0.0);","}","void main() {","vec4 outColor = texture2D(prevMap, vUv);","vec4 clipVec = vec4(vUv * 2.0 - 1.0, 0.0, 1.0);","vec4 posVS = realProjectionMatrixInverse * clipVec;","posVS.xyz /= posVS.w;","posVS.w = 1.0;","vec3 rd = (realModelViewMatrixInverse * posVS).xyz;","vec3 ro = (realModelViewMatrixInverse * vec4(0.0, 0.0, 0.0, 1.0)).xyz;","rd = normalize(rd - ro);","vec3 rad = 0.5 * gridSize;","vec3 m = 1.0 / rd;","vec3 n = m * ro;","vec3 k = abs(m) * rad;","vec3 t1 = -n - k;","vec3 t2 = -n + k;","float tN = max(max(t1.x, t1.y), t1.z);","float tF = min(min(t2.x, t2.y), t2.z);","if(tN <= tF && tF >= 0.0) {","vec3 intersect = ro + tN * rd;","vec4 intersectVS = realModelViewMatrix * vec4(intersect, 1.0);","depthVS = fetchDepthVS(vUv);","if (intersectVS.z >= depthVS) {","stepSize = max(mapDim.x, max(mapDim.y, mapDim.z)) * ROOTTHREE / float(MAX_STEPS);","stepSizeModel = max(gridSize.x, max(gridSize.y, gridSize.z)) * ROOTTHREE / float(MAX_STEPS);","#if ISO_SURFACE > 0","outColor = raymarchIso(intersect, rd, outColor) + debugChunkBox;","#else","outColor = raymarch(intersect, rd, outColor) + debugChunkBox;","#endif","}","}","gl_FragColor = outColor;","}"].join("\n")},Transfer:{defines:{ISO_SURFACE:0},uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tDiffuse2;","varying vec2 vUv;","void main() {","vec4 mainMap   = texture2D(tDiffuse,  vUv);","vec4 volumeMap = texture2D(tDiffuse2, vUv);","vec3 volumeCol = volumeMap.rgb;","float alpha = 1.0 - volumeMap.a;","vec4 volume = vec4(volumeCol / (alpha + 0.0000001), alpha);","#if ISO_SURFACE > 0","float blendAlpha = mix(mainMap.a, 1.0, volumeMap.a);","gl_FragColor = vec4(mix(mainMap.rgb * mainMap.a, volumeMap.rgb, volumeMap.a) / blendAlpha, blendAlpha);","#else","float blendAlpha = mix(mainMap.a, 1.0, volume.a);","gl_FragColor = vec4(mix(mainMap.rgb * mainMap.a, volume.rgb, volume.a) / blendAlpha, blendAlpha);","#endif","}"].join("\n")}}}),define("DS/Plugins/UserSceneGraphPass",["DS/Plugins/UserPass","DS/Plugins/RenderPass","DS/Visualization/RenderMode"],function(e,t,i){function r(e){return!!e}return e.extend({init:function(e){this._parent(e),this.mainPass=new t(null,null,null,null,null,null,"_UserSceneGraphPass_"+this.id+"_"+this.name),this.sectionCappingPass=new t(null,null,null,i.facesMask,!1,!1,"passSectionCappingFrontFaces"),this.sectionCappingPass.setRenderCuttingElements(!0),this.sectionCappingPass.setEnableStencilTest(!0),this.sectionCappingPass.setEnableStencilWrite(!0),this.sectionCappingPass.setDisableColorWrite(!0),this.sectionCappingPass.setDisableDepthWrite(!0),this.sectionCappingPass.setStencilFunc("ALWAYS"),this.sectionCappingPass.setStencilOps("INCR_WRAP","DECR_WRAP"),this.sectionCappingPass.setDisableBackFaceCulling(!0),this.sectionCappingPass.setHideSurfacesAndUnclippedMeshes(!0),this.sectionCappingPass.setDisableBackFaceClipPlanes(1),this.sectionCappingPass.setRenderPluginsPre(!1),this.sectionCappingPass.setRenderPluginsPost(!1),this.sectionCappingPass.ignoreNoZ=!0,this._passes.push(this.mainPass),this._passes.push(this.sectionCappingPass)},setDisableColorWrite:function(e){this._passes[0].setDisableColorWrite(r(e))},setDisableDepthWrite:function(e){this._passes[0].setDisableDepthWrite(r(e))},setDisableBackFaceCulling:function(e){this._passes[0].setDisableBackFaceCulling(r(e))},setEnableStencilWrite:function(e){this._passes[0].setEnableStencilWrite(r(e))},setEnableStencilTest:function(e){this._passes[0].setEnableStencilTest(r(e))},setStencilOps:function(e,t){this._passes[0].setStencilOps(e,t)},setStencilOpsSeparate:function(e,t,i,r){this._passes[0].setStencilOpsSeparate(e,t,i,r)},setStencilFunc:function(e){this._passes[0].setStencilFunc(e)},setCullFaceMode:function(e){this._passes[0].setCullFaceMode(e)},setDepthFunc:function(e){this._passes[0].setDepthFunc(e)}})}),define("DS/Effects/ToneMappingEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/CompositeShader","DS/Shaders/AutoExposureShaders","DS/Plugins/ClearPass"],function(e,t,i,r,n,a,s){"use strict";return t.extend({init:function(t,i){this._parent(t),this.renderer=t,this.rtPool=i,this.tonemapping=1,this.gamma=2.2,this.brightness=0,this._AEfinalRTSize=2,this._AEsumPasses=2,this._AEinit=!1,this._autoExposure=!1,this._AEregionOfInterestTexture=null,this._AEclampMin=-10,this._AEclampMax=20,this._AEComposers=[],this._AEWeightedLuminancePass=null,this._AEPixelSumPasses=[],this.colorGrading=null,this.mixPass=new r(n,void 0,"compositePass"),this.mixPass.material.blending=e.NoBlending,this.mixPass.gammaCorrectionPass=!0;var a=new e.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint");return this.mixPass.changeRenderTargetProperties=a,this.defines={GAMMA_SIMPLE:!0,USE_AUTO_EXPOSURE:0},this.autoExposureParams=null,this},initEffect:function(e,t){t.insertComposer(null,this.mixPass)},update:function(t,i,r){var n=24,a=38.6;r.camera instanceof e.PerspectiveCamera&&(n=r.camera.sensorSizeHeight,a=r.camera.focalLength),this.mixPass.uniforms.sensorSize.value=n,this.mixPass.uniforms.screenRatio.value=1/r.camera.aspect,this.mixPass.uniforms.focalLength.value=a},updateRequiredComposers:function(){this.mixPass.requiredComposers=[],this._autoExposure&&this.mixPass.addRequiredComposer(this._AEComposers[this._AEsumPasses])},setBeforeRenderCallback:function(){var e=null,t=this;this._autoExposure&&(e=function(e){t._AEWeightedLuminancePass.uniforms.tDiffuse2.value=e}),this.mixPass.beforeRenderCB=e,this._autoExposure},setVignettingPower:function(e){this.power=e||0,this.mixPass.uniforms.power.value=this.power},setToneMapping:function(e,t){var i={};switch(this._autoExposure?i.USE_AUTO_EXPOSURE=this._AEfinalRTSize:i.USE_AUTO_EXPOSURE=0,this.tonemapping=e,this.renderer._setToneMapping(this.tonemapping),e>1&&(2.2==this.gamma?i.SRGB_CORRECTION=!0:i.GAMMA_CORRECTION=!0),e){case 1:i.GAMMA_SIMPLE=!0;break;case 2:break;case 3:i.TONEMAP_REINHARD=!0;break;case 4:i.TONEMAP_FILMIC=!0;break;case 5:i.TONEMAP_UNCHARTED=!0;break;case 6:i.TONEMAP_PHOTOGRAPHIC=!0,t&&(null!=t.crushblacks&&(this.mixPass.uniforms.crushblacks.value=t.crushblacks),null!=t.burnhighlights&&(this.mixPass.uniforms.burnhighlights.value=t.burnhighlights),null!=t.saturation&&(this.mixPass.uniforms.saturation.value=t.saturation),t.colorCorrection&&(this.mixPass.uniforms.colorCorrection.value=t.colorCorrection))}this.defines=i,this.mixPass.material.defines=i,this.mixPass.material.needsUpdate=!0},setGamma:function(e){this.gamma=e,this.mixPass.uniforms.gamma.value=e,this.setToneMapping(this.tonemapping)},setBrightness:function(e){this.brightness=e,this.mixPass.uniforms.brightness.value=e},setAutoExposure:function(e,t,i,r){this.autoExposureParams={isActive:e,weightTexture:t,clampMin:i,clampMax:r};var n=this.renderer.supportsFloatTextures();this._autoExposure!=e&&n&&(this._autoExposure=e,this._AEregionOfInterestTexture=t,this._AEclampMin=null!=i?i:-10,this._AEclampMax=null!=r?r:20,this._autoExposure?(this.defines.USE_AUTO_EXPOSURE=this._AEfinalRTSize,this._buildAutoExposureRT(),this._updateAutoExposureUniforms()):this.defines.USE_AUTO_EXPOSURE=0,this.updateRequiredComposers(),this.mixPass.material.defines=this.defines,this.mixPass.material.needsUpdate=!0)},setColorGrading:function(e){e?(this.colorGrading=e,this.mixPass.uniforms.gradingMap.value=this.colorGrading,this.mixPass.uniforms.gradingDepth.value=this.colorGrading.image.width/this.colorGrading.image.height):this.colorGrading=null,this.defines.COLOR_GRADING=!!this.colorGrading,this.mixPass.material.defines=this.defines,this.mixPass.material.needsUpdate=!0},_getQAParams:function(){return{tonemapping:this.tonemapping,gamma:this.gamma,brightness:this.brightness,autoExposure:this.autoExposureParams,colorGrading:this.colorGrading,power:this.power}},_applyQAParams:function(e){this.setToneMapping(e.tonemapping),this.setGamma(e.gamma),this.setBrightness(e.brightness),e.autoExposure?this.setAutoExposure(e.autoExposure.isActive,e.autoExposure.weightTexture,e.autoExposure.clampMin,e.autoExposure.clampMax):this.setAutoExposure(!1),this.setColorGrading(e.colorGrading),this.setVignettingPower(this.power)},setSize:function(e,t){if(this._parent(e,t)&&this._AEinit){this._AEComposers[0].setSize(this.width,this.height),this._AEPixelSumPasses[0].uniforms.tDiffuseSize.value.set(this.width,this.height);var i=this._AEPixelSumPasses[0].uniforms.currentSize.value,r=Math.ceil(this.width/i.x),n=Math.ceil(this.height/i.y);this._AEPixelSumPasses[0].material.defines={LOOP_SIZE_X:r,LOOP_SIZE_Y:n,LOOP_SIZE_X_FINAL:this.width-r*(i.x-1),LOOP_SIZE_Y_FINAL:this.height-n*(i.y-1)},this._AEPixelSumPasses[0].material.needsUpdate=!0}},_updateAutoExposureUniforms:function(){this._AEinit&&(this._AEWeightedLuminancePass.uniforms.clampMin.value=this._AEclampMin,this._AEWeightedLuminancePass.uniforms.clampMax.value=this._AEclampMax,this._AEregionOfInterestTexture?(this._AEWeightedLuminancePass.uniforms.tWeight.value=this._AEregionOfInterestTexture,this._AEWeightedLuminancePass.material.defines||(this._AEWeightedLuminancePass.material.defines={USE_WEIGHT_TEXTURE:1},this._AEWeightedLuminancePass.material.needsUpdate=!0)):(this._AEWeightedLuminancePass.uniforms.tWeight.value=null,this._AEWeightedLuminancePass.material.defines&&(this._AEWeightedLuminancePass.material.defines=null,this._AEWeightedLuminancePass.material.needsUpdate=!0)))},_buildAutoExposureRT:function(){if(!this._AEinit){this._AEinit=!0;var t=new e.WebGLRenderTargetProperties(this.width,this.height,"nearest");this._AEComposers[0]=new i(this.renderer,t,this.rtPool),this._AEWeightedLuminancePass=new r(a.WeightedLuminance),this._AEPixelSumPasses=[],this._AEComposers[0].addPass(this._AEWeightedLuminancePass);for(var n=this.width,s=this.height,o=[256,this._AEfinalRTSize],l=0;l<this._AEsumPasses;l++){var c=o[l],h=new e.WebGLRenderTargetProperties(c,c,"nearest");this._AEComposers[l+1]=new i(this.renderer,h,this.rtPool),this._AEPixelSumPasses[l]=new r(a.PixelSum),this._AEPixelSumPasses[l].uniforms.currentSize.value=new e.Vector2(c,c),this._AEPixelSumPasses[l].uniforms.tDiffuseSize.value=new e.Vector2(n,s);var u=Math.ceil(n/c),d=Math.ceil(s/c);this._AEPixelSumPasses[l].material.defines={LOOP_SIZE_X:u,LOOP_SIZE_Y:d,LOOP_SIZE_X_FINAL:n-u*(c-1),LOOP_SIZE_Y_FINAL:s-d*(c-1)};n=c,s=c;this._AEPixelSumPasses[l].material.needsUpdate=!0,this._AEComposers[l+1].addPass(this._AEPixelSumPasses[l]),this._AEPixelSumPasses[l].addRequiredComposer(this._AEComposers[l]),this._AEComposers[l].linkToShaderPassUniform(this._AEPixelSumPasses[l],this._AEPixelSumPasses[l].uniforms.tDiffuse)}this.setBeforeRenderCallback(),this._AEComposers[this._AEsumPasses].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tAutoExposure)}}})}),define("DS/Shaders/MSAAShaders",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{Blending:{uniforms:{tDiffuse:{type:"t",value:null},prevMap:{type:"t",value:null},numIteration:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D prevMap;","uniform float numIteration;","varying vec2 vUv;","void main() {","vec4 prevColor = texture2D( prevMap, vUv );","vec4 currColor = texture2D( tDiffuse, vUv );","gl_FragColor = vec4((prevColor * numIteration + currColor) / (numIteration + 1.0));","}"].join("\n")},Transfer:{uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse2;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse2, vUv );","}"].join("\n")}}}),define("DS/Effects/SSAOIterativeEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/AbstractSSAOEffect"],function(e,t){"use strict";return t.extend({init:function(t,i){this._parent(t,i,"Iterative","SSAOIterativeEffect");this.tmpResult=null,this.renderTargetPool=i;for(var r=new Uint8Array(16),n=0;n<4;n++)r[4*n]=255,r[4*n+1]=255,r[4*n+2]=255,r[4*n+3]=255;return this.initTexture=new e.DataTexture(r,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter),this.initTexture.generateMipmaps=!1,this.initTexture.needsUpdate=!0,this.renderer.setTexture(this.initTexture,0),this},getRandomTexture:function(){if(!this._randomTexture){var t=e.RandomLib.computeHaltonSequence4D(64);t.minFilter=e.NearestFilter,t.magFilter=e.NearestFilter,t.needsUpdate=!0,this._randomTexture=t}return this._randomTexture},update:function(e,t,i,r,n,a){this._parent(e,t,i,r,n,a),r--,this.mixPass.composer.contexts[0].enablePass(this.mixPass,r>=0),this.composers[0].enablePass(this.effectSSAO,r>=0),this.composers[0].enablePass(this.effectSSAOBlurH,126===r),this.composers[0].enablePass(this.effectSSAOBlurV,126===r),this.effectSSAO.uniforms.numIteration.value=r,this.effectSSAO.uniforms.firstSample.value=this.nbSamples*r,this.effectSSAO.uniforms.prevMap.value=r?this.composers[0].composerContext.renderTarget2:this.initTexture;var s=this;this.mixPass.beforeRenderCB=function(e){0===r?s.effectSSAO.uniforms.prevMap.value=s.initTexture:r>0&&(s.tmpResult=s.composers[0].composerContext.getResult("main",!0),s.effectSSAO.uniforms.prevMap.value=s.tmpResult)},this.mixPass.afterRenderCB=function(){s.tmpResult&&(s.renderTargetPool.pushRenderTarget(s.tmpResult),s.tmpResult=null)}},getMaxIteration:function(){return 128}})}),define("DS/Visualization/MaterialConnection",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=-1,i=1,r=2,n=function(e){e=e||{},this.setParams(e)};return n.prototype.setParams=function(e){this.appearanceId=e.appearanceId||null,this.pathElement=e.pathElement||null,this.type=e.type||n._UNKNOWN,this.status=null!==this.pathElement?i:t,this.vLayer=e.vLayer||0},n.prototype.isComplete=function(){return this.status===i},n.prototype.isIncomplete=function(){return this.status===t},n.prototype.isError=function(){return this.status===r},n.prototype.computeLayer=function(t){var i=this.pathElement.externalPath.length,r=this.vLayer;return this.type===n.CORE_MATERIAL?e.MaterialLayerMax:0+16*i+r},n._UNKNOWN=0,n.COVERAGE_MATERIAL=1,n.CORE_MATERIAL=2,n}),define("DS/Effects/MSAAEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/MSAAShaders","DS/Shaders/NothingShader"],function(e,t,i,r,n,a,s){"use strict";return i.extend({init:function(t,i){this._parent(t),this.mode=1;var o=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");o.generateMipmaps=!1,this.composers[0]=new r(t,o,i),this.composers[0].composerContext.keepResult=!0,this.passBlend=new n(a.Blending);var l=new n(s);this.composers[0].addPass(this.passBlend),this.composers[0].addPass(l),this.mixPass=new n(a.Transfer,void 0,"MSAAEffect"),this.tmpResult=null,this.renderTargetPool=i;for(var c=new Uint8Array(16),h=0;h<4;h++)c[4*h]=0,c[4*h+1]=0,c[4*h+2]=0,c[4*h+3]=255;this.initTexture=new e.DataTexture(c,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter),this.initTexture.generateMipmaps=!1,this.initTexture.needsUpdate=!0,this.renderer.setTexture(this.initTexture,0),this.maxIteration=128,this.msaaOffset=[];for(var u=0;u<this.maxIteration;u++){var d=e.RandomLib.LowDiscrepancy2D(u);this.msaaOffset.push({x:d.x-.5,y:d.y-.5})}return this},initEffect:function(e,t){t.insertComposer(null,this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,t,i,r){this.mode?r-=1:r=0,this.passBlend.uniforms.numIteration.value=r,this.passBlend.uniforms.prevMap.value=r?this.composers[0].composerContext.renderTarget2:this.initTexture;var n=this;this.mixPass.beforeRenderCB=function(e){0===r?n.passBlend.uniforms.prevMap.value=n.initTexture:r>0&&(n.tmpResult=n.composers[0].composerContext.getResult("main",!0),n.passBlend.uniforms.prevMap.value=n.tmpResult)},this.mixPass.afterRenderCB=function(){n.tmpResult&&(n.renderTargetPool.pushRenderTarget(n.tmpResult),n.tmpResult=null)},r>=this.getMaxIteration()?this.mixPass.requiredComposers=[]:this.mixPass.requiredComposers.length||this.mixPass.addRequiredComposer(this.composers[0])},getMaxIteration:function(){return this.mode?this.maxIteration:1},computeJitterCamera:function(e,t){var i=e.clone();i._renderingRole=e._renderingRole;var r=Math.min(this.getMaxIteration()-1,t);return i.updateProjectionMatrix(this.msaaOffset[r].x/this.width,this.msaaOffset[r].y/this.height),i},computeJitterValues:function(t,i){var r=Math.min(this.getMaxIteration()-1,i);return new e.Vector2(this.msaaOffset[r].x/this.width,this.msaaOffset[r].y/this.height)},setSize:function(e,t){this._parent(e,t)&&this.composers[0].setSize(this.width,this.height)}})}),define("DS/Visualization/Filters/ZModeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this.enableZ=e}}}),define("DS/Gestures/DragGesture",["DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture","DS/Visualization/ThreeJS_DS"],function(e,t,i){"use strict";var r=t.extend({init:function(){return this._parent("Drag"),this.priority=10,this.identifier=null,this.minDistance=10,this},detect:function(i){switch(this._parent(i),this.state){case t.State.INIT:this.identifier=null;var r=THREEDS.VisuEventsManager.getPrimaryPointerEventsByStates([e.State.BEGIN],this.view);1===r.length&&("Touch"===r[0].type&&(this.identifier=r[0].identifier),this.changeState(t.State.BEGIN));break;case t.State.BEGIN:var n=null;if(null!==this.identifier)1===THREEDS.VisuEventsManager.getTouchEvents(this.view).length&&(n=THREEDS.VisuEventsManager.getTouchEventById(this.identifier));else 1===(o=THREEDS.VisuEventsManager.getMouseEvents(null,this.view,!0)).length&&o[0].getButton()===e.MouseButton.LEFT&&(n=o[0]);if(n)if(n.offsetPosition.length()>this.minDistance){var a=n.getState()===e.State.END,s=i[0].getJSEvent();!a&&s.preventDefault&&s.preventDefault(),this.events=[n],this.changeState(t.State.CHANGE)}else n.getState()===e.State.END&&this.changeState(t.State.KO);else this.changeState(t.State.KO);break;case t.State.CHANGE:var o;n=null;if(null!==this.identifier)1===THREEDS.VisuEventsManager.getTouchEvents(document).length&&(n=THREEDS.VisuEventsManager.getTouchEventById(this.identifier));else 1===(o=THREEDS.VisuEventsManager.getMouseEvents(null,document,!0)).length&&o[0].getButton()===e.MouseButton.LEFT&&(n=o[0]);if(n){a=n.getState()===e.State.END,s=i[0].getJSEvent();!a&&s.preventDefault&&s.preventDefault(),this.events=[n],this.changeState(t.State.CHANGE,a)}else this.changeState(t.State.KO);break;case t.State.KO:case t.State.OK:case t.State.CANCEL:this.changeState(t.State.INIT),this.identifier=null}},getTouchPoint:function(){return this.getEvents().length>0?this.getEvents()[0].getCurrentPosition():null},getDistanceFromOrigin:function(){return this.getEvents().length>0?this.getEvents()[0].getOffsetPosition().length():null},getLastTraveledDistance:function(){return this.getEvents().length>0?this.getEvents()[0].getDeltaPosition().length():null},getTotalTraveledDistFromOrigin:function(){return this.getEvents().length>0?this.getEvents()[0].getTraveledDistance():null},getLastTraveledVector:function(){return this.getEvents().length>0?this.getEvents()[0].getDeltaPosition():null},getDirectionFromOrigin:function(){return this.getEvents().length>0?this.getEvents()[0].getOffsetPosition():null}});return UWA.namespace("THREEDS/Gestures/DragGesture",r)}),define("DS/VisuEvents/EventsManager",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/VisuEvents/MouseEvent","DS/VisuEvents/TouchEvent","DS/VisuEvents/KeyboardEvent","DS/Gestures/ClickGesture","DS/Gestures/HoldGesture","DS/Gestures/HoldMouseDownGesture","DS/Gestures/LongHoldGesture","DS/Gestures/EditGesture","DS/Gestures/LongEditGesture","DS/Gestures/SmartEditGesture","DS/Gestures/KeyDownGesture","DS/Gestures/KeyUpGesture","DS/Gestures/MouseDownGesture","DS/Gestures/MouseUpGesture","DS/Gestures/MouseMoveGesture","DS/Gestures/MouseOutGesture","DS/Gestures/MouseWheelGesture","DS/Gestures/TouchGesture","DS/Gestures/ReleaseGesture","DS/Gestures/TapGesture","DS/Gestures/PinchGesture","DS/Gestures/PanGesture","DS/Gestures/RotateGesture","DS/Gestures/PinchPanRotateGesture","DS/Gestures/SwipeGesture","DS/Gestures/SpreadGesture","DS/Gestures/DragGesture","DS/Gestures/PinchTapGesture","DS/Gestures/PrimaryPointerDownUniqueGesture","DS/Gestures/PrimaryPointerMoveUniqueGesture","DS/Gestures/PrimaryPointerUpUniqueGesture","DS/Gestures/PrimaryPointerClickGesture","DS/Gestures/PrimaryPointerDoubleClickGesture","DS/Gestures/DoubleClickGesture","DS/Gestures/ClickDownGesture","DS/Gestures/DoubleTapGesture","DS/Gestures/DoublePinchTapGesture","DS/WebRecordEnabler/Adapter","DS/Gestures/BasicGesture","DS/Gestures/MediumHoldGesture","DS/Gestures/FlickGesture","DS/Gestures/HoldTapGesture","DS/Gestures/TwoFingerTapGesture","DS/Gestures/HoldDragGesture","DS/Gestures/HoldStayGesture","DS/Gestures/MediumHoldStayGesture","DS/Gestures/LongHoldStayGesture"],function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E,T,A,I,R,L,O,N,F,V,U,B,k,G,z,H,W,j,X,q,Z,Y,K){"use strict";var J=0,Q=e.singleton({options:{},init:function(e){this._recordViewTable={},this._maxViewIndex=-1,this.options=this.defaultOptions,UWA.extend(this.options,e),this._parent(e),this._screenEvents=[],this._currentEvents=[],this._primaryTouches=[],this.debugEvents=0,this._currentTime=0,this._gestureRecognizers=[],this._gesturesNeedSort=!1,this._gesturesMap=[],this._customGesturesMap=[],this._gesturesToRemove=[],this._ODTMode=!1,this._ODTPiouPiouEvents=null,this._ODTPiouPiouDragsTab=[],this.nbGesturesToLoad=0,this.simulateTouch=!1,this.simulateTouchCB=!1,this.fingerDivs=[],this.fingers=[],this.fingerDst=new i.Vector2(100,100),this._leftButtonPressed=!1,this._shiftKeyPressed=!1,this._staticKeyPressed=!1;var t=this;this.isTouch="ontouchstart"in window,this._isTouchSupported=!!window.TouchEvent,this.isPointer=!!window.PointerEvent;var r=!1;try{var n=Object.defineProperty({},"passive",{get:function(){r=!0}});window.addEventListener("test",null,n)}catch(e){r=!1}this.supportsPassive=r,this.currentButtons=0,this._onKeyDown=function(e){t._keyDown.call(t,e)},this._onKeyUp=function(e){t._keyUp.call(t,e)},this._onMouseMove=function(e){t._mouseMove.call(t,e)},this._onMouseDown=function(e){t._mouseDown.call(t,e)},this._onMouseUp=function(e){t._mouseUp.call(t,e)},this._onMouseOut=function(e){t._mouseOut.call(t,e)},this._onMouseWheel=function(e){t._mouseWheel.call(t,e)},this._onTouchMove=function(e){t._touchMove.call(t,e)},this._onTouchStart=function(e){t._touchStart.call(t,e)},this._onTouchEnd=function(e){t._touchEnd.call(t,e)},this._onPointerDown=function(e){t._pointerDown.call(t,e)},this._onPointerMove=function(e){t._pointerMove.call(t,e)},this._onPointerUp=function(e){t._pointerUp.call(t,e)},this._onPointerCancel=function(e){t._pointerCancel.call(t,e)},this.touchDetached=!0,this.pointerDetached=!0,this._isIE11=null!=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),this._isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,this._attachEvents(),this._isInit=!0,this.holdTime=500,this.mediumHoldTime=750,this.longHoldTime=1e3},_attachEvents:function(){G.isReplaying()||(UWA.Element.addEvent.call(document,"mouseleave",this._onMouseOut),document.addEventListener("mousedown",this._onMouseDown,!0),document.addEventListener("mousemove",this._onMouseMove,!0),document.addEventListener("mouseup",this._onMouseUp,!0),document.addEventListener("mousewheel",this._onMouseWheel,!this.supportsPassive||{passive:!1,capture:!0}),document.addEventListener("DOMMouseScroll",this._onMouseWheel,!0),this._isTouchSupported?this._attachTouchEvents():this.isPointer&&this._attachPointerEvents(),document.addEventListener("keydown",this._onKeyDown,!0),document.addEventListener("keyup",this._onKeyUp,!0),this._screenEvents=[])},_detachEvents:function(){G.isReplaying()||(UWA.Element.removeEvent.call(document,"mouseleave",this._onMouseOut),document.removeEventListener("mousedown",this._onMouseDown,!0),document.removeEventListener("mousemove",this._onMouseMove,!0),document.removeEventListener("mouseup",this._onMouseUp,!0),document.removeEventListener("mousewheel",this._onMouseWheel,!this.supportsPassive||{passive:!1,capture:!0}),document.removeEventListener("DOMMouseScroll",this._onMouseWheel,!0),this._detachTouchEvents(),this._detachPointerEvents(),document.removeEventListener("keydown",this._onKeyDown,!0),document.removeEventListener("keyup",this._onKeyUp,!0),this._screenEvents=[])},_attachTouchEvents:function(){var e=!this.supportsPassive||{capture:!0,passive:!1};this.touchDetached&&(document.addEventListener("touchmove",this._onTouchMove,e),document.addEventListener("touchstart",this._onTouchStart,e),document.addEventListener("touchend",this._onTouchEnd,e),document.addEventListener("touchcancel",this._onTouchCancel,e),this.touchDetached=!1)},_attachPointerEvents:function(){this.pointerDetached&&(document.addEventListener("pointerdown",this._onPointerDown,!0),document.addEventListener("pointermove",this._onPointerMove,!0),document.addEventListener("pointerup",this._onPointerUp,!0),document.addEventListener("pointercancel",this._onPointerCancel,!0),this.pointerDetached=!1)},_detachTouchEvents:function(){var e=!this.supportsPassive||{capture:!0,passive:!1};this.touchDetached||(document.removeEventListener("touchmove",this._onTouchMove,e),document.removeEventListener("touchstart",this._onTouchStart,e),document.removeEventListener("touchend",this._onTouchEnd,e),document.removeEventListener("touchcancel",this._onTouchCancel,e),this.touchDetached=!0)},_detachPointerEvents:function(){this.pointerDetached||(document.removeEventListener("pointerdown",this._onPointerDown,!0),document.removeEventListener("pointermove",this._onPointerMove,!0),document.removeEventListener("pointerup",this._onPointerUp,!0),document.removeEventListener("pointercancel",this._onPointerCancel,!0),this.pointerDetached=!0)},setDebugEvents:function(e){this.debugEvents=e;for(var t=0;t<this._gestureRecognizers.length;t++){this._gestureRecognizers[t].setDebugEvents(e)}},setSimulateTouch:function(e){if(this.simulateTouch=e,e&&!this.simulateTouchCB){var i=this;t.subscribe({event:"/VISU/onBasicEvent"},function(e){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t&&"Keyboard"===t.getType()){var n=t.getKey();if(t.getState()===r.State.BEGIN)switch(n){case r.KeyboardKey.SHIFT:i._shiftKeyPressed=!0;break;case r.KeyboardKey.S:i._staticKeyPressed=!0}else if(t.getState()===r.State.END)switch(n){case r.KeyboardKey.SHIFT:i._shiftKeyPressed=!1;break;case r.KeyboardKey.S:i._staticKeyPressed=!1}}}),this.simulateTouchCB=!0}},_setHoldTime:function(e){this.holdTime=e},_setMediumHoldTime:function(e){this.mediumHoldTime=e},_setLongHoldTime:function(e){this.longHoldTime=e},getHoldTime:function(){return this.holdTime},getMediumHoldTime:function(){return this.mediumHoldTime},getLongHoldTime:function(){return this.longHoldTime},getScreenEvents:function(){return this._screenEvents},getMouseEvents:function(e,t,i){for(var a=[],s=0;s<this._screenEvents.length;s++){var o=this._screenEvents[s];if(o instanceof n&&!(i&&o.getButton()===r.MouseButton.NONE||null!=e&&o.getButton()!==e)){if(t)if(t instanceof Array){if(t.length){for(var l=0;l<t.length&&!this._isInView(o,t[l]);l++);if(l===t.length)continue}}else if(!this._isInView(o,t))continue;a.push(o)}}return a},getMouseEventsByStates:function(e,t,i){for(var r=this.getMouseEvents(t,i),n=[],a=0;a<r.length;a++)for(var s=r[a],o=0;o<e.length;o++){var l=e[o];if(s.getState()===l){n.push(s);break}}return n},getPrimaryPointerEventsByStates:function(e,t){for(var i=this.getMouseEventsByStates(e,r.MouseButton.LEFT,t),n=this.getTouchEventsByStates(e,t),a=0;a<n.length;a++)n[a].isPrimary&&i.push(n[a]);return i},getKeyboardEvents:function(e){for(var t=[],i=0;i<this._screenEvents.length;i++){var r=this._screenEvents[i];r instanceof s&&(void 0!==e&&r.getKey()!==e||t.push(r))}return t},getTouchEvents:function(e){for(var t=[],i=0;i<this._screenEvents.length;i++){var r=this._screenEvents[i];if(r instanceof a){if(e)if(e instanceof Array){if(e.length){for(var n=0;n<e.length&&!this._isInView(r,e[n]);n++);if(n===e.length)continue}}else if(!this._isInView(r,e))continue;t.push(r)}}return t},getTouchEventsByStates:function(e,t){for(var i=[],r=0;r<this._screenEvents.length;r++){var n=this._screenEvents[r];if(n instanceof a){if(t)if(t instanceof Array){if(t.length){for(var s=0;s<t.length&&!this._isInView(n,t[s]);s++);if(s===t.length)continue}}else if(!this._isInView(n,t))continue;for(s=0;s<e.length;s++){var o=e[s];if(n.getState()===o){i.push(n);break}}}}return i},getTouchEventById:function(e){for(var t=0;t<this._screenEvents.length;t++){var i=this._screenEvents[t];if(i instanceof a&&i.identifier===e)return i}return null},getGestureRecognizers:function(){return this._gestureRecognizers},addGestureRecognizer:function(e,t){return t&&e.setView(t),this._gestureRecognizers.push(e),this._gesturesNeedSort=!0,e.id},removeGestureRecognizer:function(e){var t=this._gestureRecognizers.indexOf(e);return-1!==t&&(this._gestureRecognizers.splice(t,1),!0)},addCustomGesture:function(e,t,i){return!!t&&(!(!e||""===e)&&(this._customGesturesMap[e]={gestureName:t,params:i},!0))},addEvent:function(e,t,i){if(e){var r=this._getGesture(e,t);return r?r.addCallback(i):null}},removeEvent:function(e,t,i){if(!e)return!1;var r=!1,n=this._getGesture(e,t,!0);return n&&(r=n.removeCallback(i))&&this._gesturesToRemove.push({view:e,action:t,gst:n}),r},removeEventFromToken:function(e){var t=e.split("_");if(2!==t.length)return!1;for(var i=!1,r=null,n=0;n<this._gestureRecognizers.length;n++){var a=this._gestureRecognizers[n];if(a.id===parseInt(t[0])){r=a;break}}return r&&(i=r.removeCallbackFromToken(e))&&this._gesturesToRemove.push({view:r.view[0],action:r.action,gst:r}),i},_getGesture:function(e,t,i){if(G.isActive())if("string"==typeof e){if(!(e=this._getViewFromRecordId(e)))return null}else this._registerRecordView(e);var r=null,n=this._gesturesMap[t];if(n&&(r=n.get(e)),r||i)r&&!i&&r.setView(e);else{e.id&&""!==e.id||(e.id="___view___"+J,J++);var a=Q.GESTURES_MAP[t];if(!a&&!(a=this._customGesturesMap[t]))return null;if(a.require){var s=this._getGesture(e,a.require);(r=this._loadGesture(e,t,a.gestureName,a.params)).requireGesture(s)}else r=this._loadGesture(e,t,a.gestureName,a.params)}return r},_loadGesture:function(e,t,i,r){this._gesturesMap[t]||(this._gesturesMap[t]=new Map);var n=this._gesturesMap[t].get(e);return n||((n=r.length?new i(r[0]):new i).setAction(t),n.setView(e),n.setDebugEvents(this.debugEvents),this._gesturesMap[t].set(e,n),this.addGestureRecognizer(n),n)},_isInView:function(e,t){var i=e.getView();if(e.path)for(var r=0;r<e.path.length;r++){if((e.path[r].__impl4cf1e782hg__||e.path[r].impl||e.path[r])===(t.__impl4cf1e782hg__||t.impl||t))return!0}else for(;i;){if(i===t)return!0;i=i.parentNode}return!1},_addEvent:function(e){this._screenEvents.push(e)},_removeEvent:function(e){var t=this._screenEvents.indexOf(e);if(-1===t)return!1;this._screenEvents.splice(t,1)},_removeEvents:function(e){for(var t=0;t<e.length;t++){var i=e[t];this._removeEvent(i)}},_detectGestures:function(){var e;for(this._sortGestures(),e=0;e<this._gestureRecognizers.length;e++){this._gestureRecognizers[e].detect(this._currentEvents)}for(e=0;e<this._gestureRecognizers.length;e++){this._gestureRecognizers[e].execute()}for(e=0;e<this._gestureRecognizers.length;e++){this._gestureRecognizers[e].update()}this._cleanRemovedGestures();var i={eventChannel:"/VISU/",eventType:"@onGesturesDetection",eventID:"",from:this._currentEvents};t.publish({event:"/VISU/onGesturesDetection",data:i})},_cleanRemovedGestures:function(){if(this._gesturesToRemove.length){var e,t=this;for(e=0;e<this._gesturesToRemove.length;e++){var i=this._gesturesToRemove[e];i.gst&&i.gst._dispose(function(){this.view.length&&this.view[0]&&this.view[0].id&&""!==this.view[0].id&&t._gesturesMap[this.action]&&(t.removeGestureRecognizer(this),t._gesturesMap[this.action].delete(this.view[0]))})}this._gesturesToRemove=[]}},_dispose:function(e){if(this._cleanRemovedGestures(),e){for(var t=[],i=0;i<this._screenEvents.length;i++){var r=this._screenEvents[i];r.isInView(e)||t.push(r)}this._screenEvents=t}},_sortGestures:function(){var e=this._gesturesNeedSort;if(!e)for(var t=0;t<this._gestureRecognizers.length;t++){(i=this._gestureRecognizers[t])._needsUpdate&&(i._needsUpdate=!1,e=!0)}if(e){this._gestureRecognizers.sort(function(e,t){return e.priority-t.priority});for(t=0;t<this._gestureRecognizers.length;t++)this._gestureRecognizers[t]._order=t;for(t=0;t<this._gestureRecognizers.length;t++){var i;if((i=this._gestureRecognizers[t]).gestures.length)for(var r=0;r<i.gestures.length;r++){var n=i.gestures[r];if(i._order<n._order){var a=n._order;n._order=i._order,i._order=a}}}this._gestureRecognizers.sort(function(e,t){return e._order-t._order}),this._gesturesNeedSort=!1}},_triggerEvent:function(e,i){var r={eventChannel:"/VISU/",eventType:"@onBasicEvent",eventID:"",from:e};if(t.publish({event:"/VISU/onBasicEvent",data:r}),(1===this.debugEvents||6===this.debugEvents)&&e)for(var n=0;n<e.length;n++){var a=r.eventType+" | "+e[n].getType()+" | "+e[n].getState(),s=e[n].getView();s&&s.id&&(a+=" | "+s.id),console.log(a)}},_getMouseButton:function(e){switch(e){case-1:return r.MouseButton.NONE;case 0:return r.MouseButton.LEFT;case 1:return r.MouseButton.MIDDLE;case 2:return r.MouseButton.RIGHT}return!1},_contextMenu:function(e){e.preventDefault()},_nextStateEvents:function(e){for(var t=0;t<e.length;t++)e[t].nextState()},_keyDown:function(e){if(!this._ODTMode||e._simul){if(this._ODTPiouPiouEnabled("keyboard")&&32!==e.keyCode){var t=this._ODTPiouPiouDragsTab.length&&this._ODTPiouPiouDragsTab[this._ODTPiouPiouDragsTab.length-1];t&&"keyDown"===t.type&&t.keyCode===e.keyCode||this._ODTPiouPiouDragsTab.push({type:"keyDown",keyCode:e.keyCode})}this._ODTPiouPiouDragsTab.length>0&&32===e.keyCode&&console.log("DRAG DUMP:\n"+JSON.stringify(this._ODTPiouPiouDragsTab)),this._currentTime=(new Date).getTime();var i=this.getKeyboardEvents(e.which);i.length||(this._currentEvents=[new s(e.which,e)],this._addEvent(this._currentEvents[0]),this._currentEvents[0].update(e),this._triggerEvent(this._currentEvents,e),this._detectGestures(),this._nextStateEvents(this._currentEvents),this.simulateTouch&&this._simulateTouchEvent("start",e))}},_keyUp:function(e){if(!this._ODTMode||e._simul){this._ODTPiouPiouEnabled("keyboard")&&32!==e.keyCode&&this._ODTPiouPiouDragsTab.push({type:"keyUp",keyCode:e.keyCode}),this._currentTime=(new Date).getTime();var t=this.getKeyboardEvents(e.which);t.length&&(this._currentEvents=t),this._currentEvents[0].update(e),this._triggerEvent(this._currentEvents,e),this._detectGestures(),this._removeEvents(this._currentEvents),this._nextStateEvents(this._currentEvents),this.simulateTouch&&this._simulateTouchEvent("end",e)}},_mouseDown:function(e){if(!this._ODTMode||e._simul)if(this.simulateTouch)this._simulateTouchEvent("start",e);else{if(this._isEventSimulatedFromTouch(e))return!0;var t=this._getMouseButton(e.button);this._currentTime=(new Date).getTime();var i=this.getMouseEvents(t);if(i.length?this._currentEvents=[i[0]]:(this._currentEvents=[new n(t,e)],this._addEvent(this._currentEvents[0])),this._currentEvents[0].update(e),this._triggerEvent(this._currentEvents,e),this._detectGestures(),this._nextStateEvents(this._currentEvents),this._ODTPiouPiouEnabled("mousedrag")){var r=this._currentEvents[0].getCurrentPosition(e.target);this._ODTPiouPiouMouseDrag=[{x:r.x,y:r.y,timeStamp:0,button:e.button}],this._ODTPiouPiouDragStart=(new Date).getTime()}}},_mouseMove:function(e){if(!this._ODTMode||e._simul)if(this.simulateTouch)this._simulateTouchEvent("move",e);else if(!this._isEventSimulatedFromTouch(e)){this._currentTime=(new Date).getTime();var t=this.getMouseEvents();if(t.length){var i=this.getMouseEvents(r.MouseButton.NONE);i.length||(i=new n(r.MouseButton.NONE,e),this._addEvent(i),t.push(i)),this._currentEvents=t}else this._currentEvents=[new n(r.MouseButton.NONE,e)],this._addEvent(this._currentEvents[0]);for(var a=0;a<this._currentEvents.length;a++)this._currentEvents[a].update(e);if(this._triggerEvent(this._currentEvents,e),this._detectGestures(),this._nextStateEvents(this._currentEvents),this._ODTPiouPiouMouseDrag){var s=(new Date).getTime()-this._ODTPiouPiouDragStart,o=this._currentEvents[0].getCurrentPosition(e.target);this._ODTPiouPiouMouseDrag.push({x:o.x,y:o.y,timeStamp:s,button:e.button})}}},_mouseUp:function(e){if(!this._ODTMode||e._simul)if(this.simulateTouch)this._simulateTouchEvent("end",e);else if(!this._isEventSimulatedFromTouch(e)){this._currentTime=(new Date).getTime();var t=this._getMouseButton(e.button),i=this.getMouseEvents(t);if(i.length&&(this._currentEvents=[i[0]],i[0].update(e)),this._triggerEvent(this._currentEvents,e),this._detectGestures(),this._removeEvent(i[0]),this._nextStateEvents(this._currentEvents),this._ODTPiouPiouMouseDrag){var r=(new Date).getTime()-this._ODTPiouPiouDragStart,n=this._currentEvents[0].getCurrentPosition(e.target);this._ODTPiouPiouMouseDrag.push({x:n.x,y:n.y,timeStamp:r,button:e.button}),this._ODTPiouPiouDragsTab.push(this._ODTPiouPiouMouseDrag),delete this._ODTPiouPiouMouseDrag,delete this._ODTPiouPiouDragStart}}},_mouseOut:function(e){if((!this._ODTMode||e._simul)&&!this.simulateTouch&&!this._isEventSimulatedFromTouch(e)){this._currentTime=(new Date).getTime();var t=this._getMouseButton(-1),i=this.getMouseEvents(t);i.length?this._currentEvents=[i[0]]:(this._currentEvents=[new n(t,e)],this._addEvent(this._currentEvents[0])),this._currentEvents[0].update(e),this._triggerEvent(this._currentEvents,e),this._detectGestures(),this._nextStateEvents(this._currentEvents)}},_mouseWheel:function(e){if((!this._ODTMode||e._simul)&&!this.simulateTouch){this._currentTime=(new Date).getTime();var t=this.getMouseEvents(r.MouseButton.WHEEL);t.length?this._currentEvents=t:(this._currentEvents=[new n(r.MouseButton.WHEEL,e)],this._addEvent(this._currentEvents[0])),this._currentEvents[0].update(e),this._triggerEvent(this._currentEvents,e),this._detectGestures(),this._removeEvent(this._currentEvents[0]),this._nextStateEvents(this._currentEvents)}},_touchStart:function(e,t){if(!this._ODTMode||e._simul){this._currentEvents=[],this._currentTime=(new Date).getTime(),t||this._cancelBrokenTouches(e);for(var i=e.changedTouches,r=0;r<i.length;r++){var n=this.getTouchEventById(i[r].identifier);null===n&&(n=new a(i[r].identifier,e,r),this.getTouchEvents().length||n.setPrimary(!0),this._addEvent(n)),this._currentEvents.push(n),n.update(e),this._detectFalseMouseEvents(n)}this._triggerEvent(this._currentEvents,e),this._detectGestures(),this._nextStateEvents(this._currentEvents)}},_touchMove:function(e){if(!this._ODTMode||e._simul){this._currentEvents=[],this._currentTime=(new Date).getTime();for(var t=e.changedTouches,i=0;i<t.length;i++){var r=t[i].identifier,n=this.getTouchEventById(r);this._currentEvents.push(n),n.update(e),this._detectFalseMouseEvents(n)}this._triggerEvent(this._currentEvents,e),this._detectGestures(),this._nextStateEvents(this._currentEvents)}},_touchEnd:function(e){if(!this._ODTMode||e._simul){this._currentEvents=[],this._currentTime=(new Date).getTime();for(var t=e.changedTouches,i=0;i<t.length;i++){var r=t[i].identifier,n=this.getTouchEventById(r);this._currentEvents.push(n),n.update(e),this._detectFalseMouseEvents(n)}this._triggerEvent(this._currentEvents,e),this._detectGestures(),this._removeEvents(this._currentEvents),this._nextStateEvents(this._currentEvents)}},_touchCancel:function(e){if(!this._ODTMode||e._simul){this._currentEvents=[],this._currentTime=(new Date).getTime();for(var t=e.changedTouches,i=0;i<t.length;i++){var r=t[i].identifier,n=this.getTouchEventById(r);this._currentEvents.push(n),n.update(e),this._detectFalseMouseEvents(n)}this._triggerEvent(this._currentEvents,e),this._detectGestures(),this._removeEvents(this._currentEvents),this._nextStateEvents(this._currentEvents)}},_pointerDown:function(e){var t={target:e.target,clientX:e.clientX,clientY:e.clientY};switch(e._simul&&(t._simul=!0),e.pointerType){case"mouse":case"pen":return;case"touch":t.type="touchstart",t.changedTouches=[{identifier:e.pointerId,clientX:e.clientX,clientY:e.clientY,target:e.target}],t.touches=[{identifier:e.pointerId,clientX:e.clientX,clientY:e.clientY,target:e.target}],this._touchStart(t,!0)}},_pointerMove:function(e){var t={target:e.target,clientX:e.clientX,clientY:e.clientY};switch(e._simul&&(t._simul=!0),e.pointerType){case"mouse":case"pen":return;case"touch":t.type="touchmove",t.changedTouches=[{identifier:e.pointerId,clientX:e.clientX,clientY:e.clientY,target:e.target}],t.touches=[{identifier:e.pointerId,clientX:e.clientX,clientY:e.clientY,target:e.target}],this._touchMove(t)}},_pointerUp:function(e){var t={target:e.target,clientX:e.clientX,clientY:e.clientY};switch(e._simul&&(t._simul=!0),e.pointerType){case"mouse":case"pen":return;case"touch":t.type="touchend",t.changedTouches=[{identifier:e.pointerId,clientX:e.clientX,clientY:e.clientY,target:e.target}],t.touches=[{identifier:e.pointerId,clientX:e.clientX,clientY:e.clientY,target:e.target}],this._touchEnd(t)}},_pointerCancel:function(e){var t={target:e.target,clientX:e.clientX,clientY:e.clientY};switch(e._simul&&(t._simul=!0),e.pointerType){case"mouse":case"pen":return;case"touch":t.type="touchcancel",t.changedTouches=[{identifier:e.pointerId,clientX:e.clientX,clientY:e.clientY,target:e.target}],t.touches=[{identifier:e.pointerId,clientX:e.clientX,clientY:e.clientY,target:e.target}],this._touchCancel(t)}},_detectFalseMouseEvents:function(e){var t=this._primaryTouches;if(e.isPrimary){var i={x:e._startPosition.x,y:e._startPosition.y};t.push(i);var r=function(e,t){var i=e.indexOf(t);i>-1&&e.splice(i,1)}.bind(null,t,i);setTimeout(r,2500)}},_isEventSimulatedFromTouch:function(e){for(var t=this._primaryTouches,i=e.clientX,r=e.clientY,n=0;n<t.length;n++){var a=t[n],s=Math.abs(i-a.x),o=Math.abs(r-a.y);if(s<=25&&o<=25)return!0}},_cancelBrokenTouches:function(e){var t=e.touches,i=this.getTouchEvents(),r=[];if(i.length>=t.length){for(var n=0;n<i.length;n++){var a=i[n];this._findTouchById(t,a.getIdentifier())||(r.push(a),console.log("Broken touch event id="+a.getIdentifier()))}this._removeEvents(r)}},_findTouchById:function(e,t){for(var i=0;i<e.length;i++)if(e[i].identifier===t)return!0},_ODTPiouPiouEnabled:function(e){return!!this._ODTPiouPiouEvents&&(this._ODTPiouPiouEvents==e||this._ODTPiouPiouEvents instanceof Array&&this._ODTPiouPiouEvents.indexOf(e)>=0)},_simulateTouchEvent:function(e,t){var i={type:"touch"+e,touches:[],changedTouches:[]};if(i.pageX=t.pageX,i.pageY=t.pageY,i.offsetX=t.offsetX,i.offsetY=t.offsetY,i.target=t.target,i.currentTarget=t.currentTarget,0===t.button&&("mousedown"===t.type?this._leftButtonPressed=!0:"mouseup"===t.type&&(this._leftButtonPressed=!1)),"mousedown"===t.type&&0===t.button){var r={clientX:t.clientX,clientY:t.clientY,identifier:1,target:t.target};this.fingers=[],this.fingers.push(r),i.touches.push(r),i.changedTouches.push(r)}if("mouseup"===t.type&&0===t.button){for(var n=0;n<this.fingers.length;n++)i.changedTouches.push(this.fingers[n]);this.fingers=[]}if("keydown"===t.type&&this._shiftKeyPressed&&1===this.fingers.length){i.touches.push(this.fingers[0]);r={clientX:this.fingers[0].clientX+this.fingerDst.x,clientY:this.fingers[0].clientY+this.fingerDst.y,identifier:2,target:this.fingers[0].target};this.fingers.push(r),i.touches.push(r),i.changedTouches.push(r)}else{if("keydown"===t.type)return;"keyup"!==t.type||this._shiftKeyPressed||2!==this.fingers.length||(i.changedTouches.push(this.fingers[1]),this.fingers.pop())}if("move"===e&&this._leftButtonPressed){r={clientX:t.clientX,clientY:t.clientY,identifier:1,target:this.fingers[0].target};if(this._staticKeyPressed)this.fingers[1]&&this.fingerDst.set(this.fingers[1].clientX-r.clientX,this.fingers[1].clientY-r.clientY),this.fingers[0]=r;else{this.fingers[0]=r;for(n=1;n<this.fingers.length;n++)this.fingers[n].clientX=r.clientX+this.fingerDst.x,this.fingers[n].clientY=r.clientY+this.fingerDst.y}for(n=0;n<this.fingers.length;n++)i.touches.push(this.fingers[n]),i.changedTouches.push(this.fingers[n])}var a=this.fingers.length,s=this.fingerDivs.length;for(n=0;n<Math.max(s,a);n++){var o=this.fingers[n],l=this.fingerDivs[n];if(n<a){if(l)l.style.display="block";else{(l=document.createElement("div")).setAttribute("style","position:absolute; z-index:9999; left:0; top:0; width:14px; height:14px; border:solid 2px #777;background:rgba(255,255,255,.7); border-radius:20px; pointer-events:none;margin-top:-9px; margin-left:-9px;"),document.body.appendChild(l),this.fingerDivs[n]=l}l.style.left=o.clientX+"px",l.style.top=o.clientY+"px"}else l.style.display="none"}if(i.touches.length||i.changedTouches.length){var c="_touch";c+=e.charAt(0).toUpperCase(),this[c+=e.substr(1)](i)}},disconnectFrom:function(e){for(var t=this._gestureRecognizers.length-1;t>=0;--t){var i=this._gestureRecognizers[t];i&&i.removeView(e)}},_registerRecordView:function(e){if(e){var t=e._viewRecordId;void 0===t&&(t=e.nodeName+this._maxViewIndex++,e._viewRecordId=t,this._recordViewTable[t]=e)}},_getViewFromRecordId:function(e){return this._recordViewTable[e]},_record_registerObject:function(e,t,i){var r=e._recordRegisterName;return r||(r=t+"_"+(e.uniqueName||e.id),e._recordRegisterName=r,console.log("_record_registerObject: '"+r+"'"),this._registeredObjects.push({name:r,object:e,elements:i||[]})),"WebGLV6Viewer"===t&&(console.log("this._viewerList.push(viewer#"+e.id+");"),this._viewerList.push(e)),r}});if(Q.EVENTS_MAP={touchstart:"pointerdown",mousedown:"pointerdown",touchend:"pointerup",mouseup:"pointerup",touchmove:"pointermove",mousemove:"pointermove"},Q.GESTURES_MAP={onLeftClick:{gestureName:o,params:[r.MouseButton.LEFT]},onMiddleClick:{gestureName:o,params:[r.MouseButton.MIDDLE]},onRightClick:{gestureName:o,params:[r.MouseButton.RIGHT]},onHold:{gestureName:l,params:[]},onHoldLeftMouseDown:{gestureName:c,params:[r.MouseButton.LEFT]},onHoldMiddleMouseDown:{gestureName:c,params:[r.MouseButton.MIDDLE]},onHoldRightMouseDown:{gestureName:c,params:[r.MouseButton.RIGHT]},onEdit:{gestureName:u,params:[]},onLongEdit:{gestureName:d,params:[]},onSmartEdit:{gestureName:p,params:[]},onKeyDown:{gestureName:f,params:[]},onKeyUp:{gestureName:m,params:[]},onLongHold:{gestureName:h,params:[]},onLeftMouseClickDown:{gestureName:U,params:[r.MouseButton.LEFT],require:"onLeftClick"},onLeftMouseDown:{gestureName:g,params:[r.MouseButton.LEFT]},onMiddleMouseDown:{gestureName:g,params:[r.MouseButton.MIDDLE]},onRightMouseDown:{gestureName:g,params:[r.MouseButton.RIGHT]},onMouseMove:{gestureName:S,params:[]},onMouseOut:{gestureName:_,params:[]},onLeftMouseUp:{gestureName:v,params:[r.MouseButton.LEFT]},onMiddleMouseUp:{gestureName:v,params:[r.MouseButton.MIDDLE]},onRightMouseUp:{gestureName:v,params:[r.MouseButton.RIGHT]},onMouseWheel:{gestureName:y,params:[]},onPan:{gestureName:b,params:[]},onPinch:{gestureName:C,params:[]},onPinchPanRotate:{gestureName:w,params:[]},onSpread:{gestureName:T,params:[]},onPinchTap:{gestureName:I,params:[]},onRelease:{gestureName:M,params:[]},onRotate:{gestureName:D,params:[]},onSwipe:{gestureName:E,params:[]},onDrag:{gestureName:A,params:[]},onTap:{gestureName:P,params:[]},onTouch:{gestureName:x,params:[]},onPrimaryPointerDownUnique:{gestureName:R,params:[]},onPrimaryPointerMoveUnique:{gestureName:L,params:[]},onPrimaryPointerUpUnique:{gestureName:O,params:[]},onPrimaryPointerClick:{gestureName:N,params:[]},onPrimaryPointerDoubleClick:{gestureName:F,params:[],require:"onPrimaryPointerClick"},onLeftDoubleClick:{gestureName:V,params:[r.MouseButton.LEFT],require:"onLeftClick"},onMiddleDoubleClick:{gestureName:V,params:[r.MouseButton.MIDDLE],require:"onMiddleClick"},onRightDoubleClick:{gestureName:V,params:[r.MouseButton.RIGHT],require:"onRightClick"},onDoublePinchTap:{gestureName:k,params:[],require:"onPinchTap"},onDoubleTap:{gestureName:B,params:[],require:"onTap"},onMediumHold:{gestureName:H,params:[]},onFlick:{gestureName:W,params:[]},onHoldTap:{gestureName:j,params:[]},onHoldDrag:{gestureName:q,params:[]},onTwoFingerTap:{gestureName:X,params:[]},onHoldStay:{gestureName:Z,params:[]},onMediumHoldStay:{gestureName:Y,params:[]},onLongHoldStay:{gestureName:K,params:[]}},window.DSWebRecord){if(Q._registeredObjects=[],Q._viewerList=[],G.TraceManager.setLevel(5),window.DSWebRecord.env.ADL_ODT_ViewerWait){var $=G.WaitManager.addWaitCondition(1e6,"Waiting for start");window.goRoger=function(){G.WaitManager.removeWaitCondition($)}}var ee=document.createElement("div");ee.myName="customDiv",ee.style.position="absolute",ee.style.left="-100px",ee.style.top="-100px",ee.style.width="1px",ee.style.height="1px",ee.setAttribute("data-rec-id","WebGLV6ViewerEventsManager"),document.body.appendChild(ee),G.registerComparator("DS/WebVisuRecord/SceneGraphDumpWebVisuComparator"),G.private_WebVisuRecordTarget=ee,G.registerElement(ee,"DS/WebVisuRecord/WebGLV6ViewerRec",!0,function(){Q._recordReplayReady=!0,console.log("Adapter.registerElement CB!!")}),setTimeout(function(){Q._recordReplayReady=!0},2e3)}return UWA.namespace("THREEDS/VisuEventsManager",Q)}),define("VisuEvents/EventsManager",["DS/VisuEvents/EventsManager","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuEvents/EventsManager"),e}),define("DS/Visualization/TrapSelection",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent"],function(e,t,i,r,n,a,s){"use strict";var o=function(e){this.extremities={xPix:0,x:0,yPix:0,y:0},this.originPoint=null,this.isActive=!1,this.isInterrupted=!1,this.advancedSelection=!1,this.userTransformationCB=null,this.createCallbacks(),e&&(this.viewer=e),this.viewer&&this.viewer.divTrap&&this.setDiv(this.viewer.divTrap);var t=this.viewer.currentViewpoint?this.viewer.currentViewpoint.getControl():null;this.mode=t?t._mode:1,this.downEvent=0===this.mode?"onLeftMouseDown":"onHoldLeftMouseDown"};return o.prototype.set=function(e){switch(e){case!0:this.activate(!1);break;case"advanced":this.activate(!0);break;case!1:this.disable()}},o.prototype.setUserTransformation=function(e){this.userTransformationCB=e},o.prototype.updateMode=function(e,t){var i=this.viewer.picking.trapSelection;e.setSpinnerOnHold(!(0===this.mode||!i)),t!==this.mode&&(this.mode=t,n.removeEvent(this.viewer.canvas,this.downEvent,this.downCB),this.downEvent=0===this.mode?"onLeftMouseDown":"onHoldLeftMouseDown",i&&n.addEvent(this.viewer.canvas,this.downEvent,this.downCB))},o.prototype.setDiv=function(e){this.divTrap=e,this.divTrap.setStyles({position:"absolute",opacity:"0.8",pointerEvents:"none",border:"1px dashed black"}),this.divTrap.hide()},o.prototype.activate=function(e){this.downEvent=0===this.mode?"onLeftMouseDown":"onHoldLeftMouseDown",this.forwardSelect=null,this.advancedSelection=e,!this.divTrap&&this.viewer&&this.viewer.divTrap&&this.setDiv(this.viewer.divTrap),n.addEvent(this.viewer.canvas,this.downEvent,this.downCB),n.addEvent(this.viewer.canvas,"onHold",this.downCB),n.addEvent(this.viewer.canvas,"onLongHold",this.interrupt)},o.prototype.disable=function(){this.userTransformationCB=null,n.removeEvent(this.viewer.canvas,this.downEvent,this.downCB),n.removeEvent(this.viewer.canvas,"onHold",this.downCB),n.removeEvent(this.viewer.canvas,"onLongHold",this.interrupt)},o.prototype.getExtremities=function(){return this.extremities},o.prototype.setExtremities=function(e,t){if(t){var i,r={},n={},a=!0;if(e.xPix<t.xPix?(a=!0,r.xPix=e.xPix,r.x=e.x,n.xPix=t.xPix,n.x=t.x):(a=!1,r.xPix=t.xPix,r.x=t.x,n.xPix=e.xPix,n.x=e.x),e.yPix<t.yPix?(r.yPix=e.yPix,r.y=e.y,n.yPix=t.yPix,n.y=t.y):(r.yPix=t.yPix,r.y=t.y,n.yPix=e.yPix,n.y=e.y),this.extremities=r,this.extremities.pt=n,this.advancedSelection&&this.divTrap&&this.forwardSelect!==a)i=a?{border:"2px solid #f5c77e",backgroundColor:"rgba(245, 200, 125, 0.5)"}:{border:"2px dashed #75cdf0",backgroundColor:"rgba(117, 205, 240, 0.5)"},this.divTrap.setStyles(i),this.forwardSelect=a}else this.extremities=e},o.prototype.createCallbacks=function(){var e=this;this.interrupt=function(){e.softInterrupt(),e.viewer.setCursor("Auto")},this.softInterrupt=function(){e.isActive=!1,e.isInterrupted=!0,n.removeEvent(document,"onMouseMove",e.moveCB),n.removeEvent(document,"onLeftMouseUp",e.upCB),n.removeEvent(document,"onSwipe",e.moveCB),n.removeEvent(document,"onRelease",e.upCB),e.setExtremities({x:-1,y:-1})},this.downCB=function(t){var i=t.from[0].getCurrentPosition(e.viewer.canvas);e.userTransformationCB&&(i=e.userTransformationCB(i)),e.originPoint=e.viewer.getMousePosition(i),e.setExtremities(e.originPoint),e.startTime=Date.now(),e.isActive=!0,e.isInterrupted||(e.viewer.setCursor("TrapSelection",100),n.addEvent(document,"onMouseMove",e.moveCB),n.addEvent(document,"onLeftMouseUp",e.upCB),n.addEvent(document,"onSwipe",e.moveCB),n.addEvent(document,"onRelease",e.upCB)),e.isInterrupted=!1},this.moveCB=function(t){var i=t.from[0].getCurrentPosition(e.viewer.canvas);e.userTransformationCB&&(i=e.userTransformationCB(i));var r=e.viewer.getMousePosition(i);e.setExtremities(e.originPoint,r);var n=e.viewer.devicePixelRatio;e.divTrap&&(e.divTrap.show(),e.divTrap.setStyles({width:(e.extremities.pt.xPix-e.extremities.xPix)/n,height:(e.extremities.pt.yPix-e.extremities.yPix)/n,left:e.extremities.xPix/n,top:e.extremities.yPix/n,pointerEvents:"none"}))},this.upCB=function(t){e.divTrap&&(e.divTrap.hide(),e.divTrap.setStyles({width:"0px",height:"0px",left:"0px",top:"0px",pointerEvents:"none"})),e.interrupt(),e.isInterrupted=!1}},o}),define("DS/Visualization/TrackballControls",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Animation/ANIM","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent","DS/VisuEvents/MouseEvent","DS/WebRecordEnabler/Adapter"],function(e,t,i,r,n,a,s,o,l,c,h,u){"use strict";var d=0,p=function(e,i){void 0===o._isInit&&o.init(),this.manipulatedViewList=[i],t.EventTarget.call(this),this.viewpoint=e,this.viewer=e.viewer,this.domElement=void 0!==i?i:document,this.isMac=navigator.platform.toUpperCase().indexOf("MAC")>=0,this.camera=e.camera,this.id=d++,window.DSWebRecord&&o._record_registerObject(this,"TrackballControls"),this.viewer.forceRenderTargetSize?(this.radius=.5*Math.max(this.viewer._getDivClientWidth(),this.viewer._getDivClientHeight()),this.radiusZoom=.25*(this.viewer._getDivClientWidth()+this.viewer._getDivClientHeight())):(this.radius=.5*Math.max(this.domElement.clientWidth,this.domElement.clientHeight),this.radiusZoom=.25*(this.domElement.clientWidth+this.domElement.clientHeight)),this.panSpeed=1,this.rotateSpeed=1,this.zoomSpeed=5,this.lockZ=!1,this.rollingForTouchAvailable=!1,this.lockRotation=!1,this.lockMouseRotation=!1,this.lockTouchRotation=!1,this.lockMouseRotationForSimpleMode=!1,this.lockMouseZoomForCtrlKeyWheelMode=!1,this.lockZoom=!1,this.lockPan=!1,this.lockMouse=!1,this.lockReframe=!1,this.lockReframeOnDblTap=!1,this.lockPreventDefaultForCtrlKeyWheel=!0,this.mouseInertia=!1,this.touchInertia=!0,this.rotateDirection=1,this.lastLockZState=null,this.lockZRotationSpeed=.002,this.target=e.target,this.position=e.position,this.orientation=new t.Quaternion,this.distanceToTarget=700,this._state=p.State.NONE,this._clickTimer=null,this._leftClicking=!1,this._middleClicking=!1,this._rightClicking=!1,this._leftButtonPressed=!1,this._middleButtonPressed=!1,this._rightButtonPressed=!1,this._ctrlKeyPressed=!1,this._shiftKeyPressed=!1,this._clickTolerancy=10,this._blockVptOnHold=!0,this._showSpinnerOnHold=!1,this._pickingCB=!0,this._avatarDistance=0,this._forcePan=!1,this._forceRotate=!1,this._forceZoom=!1,this._forcePanCmd=null,this._forceRotateCmd=null,this._forceZoomCmd=null,this._2DMode=!1,this._lockUpDirection=null,this._lockUpMode=null,this.oldManipActive=!1,this._mode=p.Mode.COMBINED,this._zoomType=p.ZoomType.ZOOM_POS_CHANGE;var r=this;this._onWindowResize=function(e){r._resize(e)},this._onContextMenu=function(e){e.preventDefault()},this._onBlurCB=function(){r._ctrlKeyPressed=!1,r._shiftKeyPressed=!1},this._onDragEndCB=function(e){var t=o._getMouseButton(e.button);let i=new h(t,e);r._onLeftMouseUp({from:[i]})},this.basicEventID=0,this.editEventBeginID=0,this.editEventKOID=0,this.infiniteRender=!1,this._mouseDownPos=null,this._oldCursor="",this._modelEvent=new s,this.attachEvents(),this.setMode(p.Mode.COMBINED),this._createShortHoldSpinner(1,"#3da4e0"),this._customZoomTokens=[],this._customPanTokens=[],this._customRotateTokens=[],this.needsRotationFinalized=!1,this.deltaPosition=null,this.previousTime=0,this.deltaTime=0,this._isIE11=t.IsIE11,this._isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,this._wheelMoving=!1,this._wheelTimer=null,this._flyWalkStateInfo={bActive:!1,forceStopRequests:0,oldControlState:p.State.NONE}};return Object.defineProperty(p.prototype,"_finalizeRotateLockZ",{set:function(e){this._finalizeRotateLockWorldUpVector=e}}),p.Mode={CATIA:0,SIMPLE:1,COMBINED:2,LOOKAROUND:3},p.State={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,FORCE_ROTATE:3,FORCE_ZOOM:4,FORCE_PAN:5,HOLD:6,ZOOM_PAN_ROTATE:7,STOP:8},p.changeEvent={type:"change"},p.prototype.setActive=function(e){e instanceof Object?(void 0!==e.viewpoint&&this._changeState(e.viewpoint?p.State.NONE:p.State.STOP),void 0!==e.picking&&(this._pickingCB=e.picking)):this._changeState(e?p.State.NONE:p.State.STOP)},p.prototype.setMouseActive=function(e){this.lockMouse=!e},p.prototype.setRotationActive=function(e){this.lockRotation=!e},p.prototype.setMouseRotationActive=function(e){this.lockMouseRotation=!e},p.prototype.setTouchRotationActive=function(e){this.lockTouchRotation=!e},p.prototype.setMouseRotationForSimpleModeActive=function(e){this.lockMouseRotationForSimpleMode=!e},p.prototype.setMouseZoomForCtrlKeyWheelActive=function(e){this.lockMouseZoomForCtrlKeyWheelMode=!e},p.prototype.getMouseRotationActive=function(){return this.lockMouseRotation},p.prototype.getTouchRotationActive=function(){return this.lockTouchRotation},p.prototype.setZoomActive=function(e){this.lockZoom=!e},p.prototype.setPanActive=function(e){this.lockPan=!e},p.prototype.setReframeActive=function(e){this.lockReframe=!e},p.prototype.setReframeOnDoubleTap=function(e){this.lockReframeOnDblTap=!e},p.prototype.setRotationRolling=function(e){this.lockZ=!e},p.prototype.setLockUpDirection=function(e,t){this._lockUpDirection=e,this._lockUpMode=t},p.prototype.setNativeGravity=function(e,t,i){0!=e?(this.setRotationRolling(!1),this.setLockUpDirection(t,e)):(this.setRotationRolling(!0),this.setLockUpDirection(null,null))},p.prototype.setRollingForTouchAvailable=function(e){this.rollingForTouchAvailable=e},p.prototype.setPreventDefaultForCtrlKeyWheelActive=function(e){this.lockPreventDefaultForCtrlKeyWheel=!e},p.prototype.setRotationInertia=function(e){void 0!==e.mouse&&(this.mouseInertia=e.mouse),void 0!==e.touch&&(this.touchInertia=e.touch)},p.prototype.setRotationSpeed=function(e){this.rotateSpeed=e,this.lockZRotationSpeed=.0015*e},p.ZoomType={ZOOM_POS_CHANGE:0,ZOOM_FOV_CHANGE:1},p.prototype.setZoomType=function(e){this._zoomType=e},p.prototype.onPan=function(e){if(e){var t=this._modelEvent.subscribe({event:"Pan"},e);return this._customPanTokens.push(t),t}for(var i=0;i<this._customPanTokens.length;i++)this._modelEvent.unsubscribe(this._customPanTokens[i]);this._customPanTokens=[]},p.prototype.onRotate=function(e){if(e){var t=this._modelEvent.subscribe({event:"Rotate"},e);return this._customRotateTokens.push(t),t}for(var i=0;i<this._customRotateTokens.length;i++)this._modelEvent.unsubscribe(this._customRotateTokens[i]);this._customRotateTokens=[]},p.prototype.onZoom=function(e){if(e){var t=this._modelEvent.subscribe({event:"Zoom"},e);return this._customZoomTokens.push(t),t}for(var i=0;i<this._customZoomTokens.length;i++)this._modelEvent.unsubscribe(this._customZoomTokens[i]);this._customZoomTokens=[]},p.prototype.blockViewpointOnHold=function(e){this._blockVptOnHold=e},p.prototype.setSpinnerOnHold=function(e){this._showSpinnerOnHold=e},p.prototype.isCurrentViewpoint=function(){return this.viewpoint.viewer._viewpointManager.getManipulatedViewpoint()==this.viewpoint},p.prototype.isLeftButtonPressed=function(){return this._leftButtonPressed},p.prototype.isMiddleButtonPressed=function(){return this._middleButtonPressed},p.prototype.isRightButtonPressed=function(){return this._rightButtonPressed},p.prototype.isCtrlKeyPressed=function(){return this._ctrlKeyPressed},p.prototype.isShiftKeyPressed=function(){return this._shiftKeyPressed},p.prototype.isLeftClick=function(){return this._leftClicking},p.prototype.isMiddleClick=function(){return this._middleClicking},p.prototype.isRightClick=function(){return this._rightClicking},p.prototype.startLeftClick=function(){var e=this;this._leftClicking=!0,this._clickTimer&&clearTimeout(this._clickTimer),u.isReplaying()||(this._clickTimer=setTimeout(function(){o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(e.viewer,"TrackballControls","TrackballControlCancelLeftClick"),e.cancelLeftClick()},300))},p.prototype.cancelLeftClick=function(){this._leftClicking=!1},p.prototype.cancelMiddleClick=function(){this._middleClicking=!1},p.prototype.cancelRightClick=function(){this._rightClicking=!1},p.prototype.resetLeftClick=function(){this._leftClicking=!1,this._clickTimer&&clearTimeout(this._clickTimer),this._clickTimer=null},p.prototype.getManipulationState=function(){return this._state},p.prototype.isMoving=function(){return this._state!==p.State.NONE&&this._state!==p.State.STOP&&this._state!==p.State.HOLD&&!(this._targetAnim&&!this._targetAnim.isRunning())},p.prototype.updateEditGesture=function(){var e=o._getGesture(document,"onEdit");e&&e.setTimerMouse(this._mode>0?o.getHoldTime():0)},p.prototype.setMode=function(e){void 0!==e&&e!==this._mode&&(this._mode=e,this.updateEditGesture(),this.viewer.trapSelection&&this.viewer.trapSelection.updateMode(this,this._mode))},p.prototype.setDebugEvents=function(e){o.setDebugEvents(e)},p.prototype.attachEvents=function(){this.initGestureCB(),this.domElement.addEventListener("contextmenu",this._onContextMenu,!1),window.addEventListener("blur",this._onBlurCB),window.addEventListener("dragend",this._onDragEndCB)},p.prototype.detachEvents=function(){this.resetGestureCB(),this.domElement.removeEventListener("contextmenu",this._onContextMenu,!1),window.removeEventListener("blur",this._onBlurCB),window.removeEventListener("dragend",this._onDragEndCB)},p.prototype._setCapture=function(){var e=this.viewer?this.viewer.div:null;e&&(!e.setCapture||!(this._isIE11||this._isFirefox&&!e.draggable)||e.tagName&&"input"===e.tagName.toLowerCase()||e.setCapture(!1))},p.prototype._releaseCapture=function(){(this._isIE11||this._isFirefox)&&document.releaseCapture&&document.releaseCapture()},p.prototype.initGestureCB=function(){if(!this.gestureCBReady){var e=this;this._onLeftMouseDownCB=function(t){e._onLeftMouseDown.call(e,t)},this._onMiddleMouseDownCB=function(t){e._onMiddleMouseDown.call(e,t)},this._onRightMouseDownCB=function(t){e._onRightMouseDown.call(e,t)},this._onLeftMouseUpCB=function(t){e._onLeftMouseUp.call(e,t)},this._onMiddleMouseUpCB=function(t){e._onMiddleMouseUp.call(e,t)},this._onRightMouseUpCB=function(t){e._onRightMouseUp.call(e,t)},this._onMouseMoveCB=function(t){e._onMouseMove.call(e,t)},this._onMouseOutCB=function(t){e._onMouseOut.call(e,t)},this._onSwipeCB=function(t){e._onSwipe.call(e,t)},this._onTapCB=function(t){e._onTap.call(e,t)},this._onPinchPanRotateCB=function(t){e._onPinchPanRotate.call(e,t)},this._onDoubleTapCB=function(t){e._onDoubleTap.call(e,t)},this._onDoublePinchTapCB=function(t){e._onDoublePinchTap.call(e,t)},this._onHoldCB=function(t){e._onHold.call(e,t)},this._onTouchCB=function(t){e._onTouch.call(e,t)},this._onReleaseCB=function(t){e._onRelease.call(e,t)},this._onEditCB=function(t){e._onStopManip.call(e,t)},o.addEvent(document,"onLeftMouseDown",this._onLeftMouseDownCB),o.addEvent(document,"onRightMouseDown",this._onRightMouseDownCB),o.addEvent(document,"onLeftMouseUp",this._onLeftMouseUpCB),o.addEvent(document,"onMiddleMouseUp",this._onMiddleMouseUpCB),o.addEvent(document,"onRightMouseUp",this._onRightMouseUpCB),o.addEvent(document,"onMouseMove",this._onMouseMoveCB),o.addEvent(document,"onMouseOut",this._onMouseOutCB),o.addEvent(this.domElement,"onDoubleTap",this._onDoubleTapCB),o.addEvent(this.domElement,"onDoublePinchTap",this._onDoublePinchTapCB),o.addEvent(this.domElement,"onHold",this._onHoldCB),o.addEvent(document,"onRelease",this._onReleaseCB),o.addEvent(document,"onEdit",this._onEditCB),this.updateEditGesture(),this.addViewToGestures(this.domElement),this.viewer&&this.viewer.divCssElement&&this.addViewToManipulation(this.viewer.divCssElement),this.basicEventID=a.subscribe({event:"/VISU/onBasicEvent"},function(t){e._onBasicEvent.call(e,t)}),this.editEventBeginID=a.subscribe({event:"/VISU/onEditEventBegin"},function(t){e._showSpinnerOnHold&&e._onEditEventBegin.call(e,t)}),this.editEventKOID=a.subscribe({event:"/VISU/onEditEventKO"},function(t){e._onEditEventKO.call(e,t)}),this.gestureCBReady=!0}},p.prototype.resetGestureCB=function(){if(this.gestureCBReady){o.removeEvent(document,"onLeftMouseDown",this._onLeftMouseDownCB),o.removeEvent(document,"onRightMouseDown",this._onRightMouseDownCB),o.removeEvent(document,"onLeftMouseUp",this._onLeftMouseUpCB),o.removeEvent(document,"onMiddleMouseUp",this._onMiddleMouseUpCB),o.removeEvent(document,"onRightMouseUp",this._onRightMouseUpCB),o.removeEvent(document,"onMouseMove",this._onMouseMoveCB),o.removeEvent(document,"onMouseOut",this._onMouseOutCB),o.removeEvent(this.domElement,"onDoubleTap",this._onDoubleTapCB),o.removeEvent(this.domElement,"onDoublePinchTap",this._onDoublePinchTapCB),o.removeEvent(this.domElement,"onHold",this._onHoldCB),o.removeEvent(document,"onRelease",this._onReleaseCB),o.removeEvent(document,"onEdit",this._onEditCB);for(var e=0;e<this.manipulatedViewList.length;e++){var t=this.manipulatedViewList[e];this.removeViewFromGestures(t)}a.unsubscribe(this.basicEventID),a.unsubscribe(this.editEventBeginID),a.unsubscribe(this.editEventKOID),this.gestureCBReady=!1}},p.prototype.addViewToGestures=function(e){o.addEvent(e,"onMiddleMouseDown",this._onMiddleMouseDownCB),o.addEvent(e,"onTouch",this._onTouchCB),o.addEvent(e,"onSwipe",this._onSwipeCB),o.addEvent(e,"onPinchPanRotate",this._onPinchPanRotateCB),o.addEvent(e,"onTap",this._onTapCB)},p.prototype.removeViewFromGestures=function(e){o.removeEvent(e,"onMiddleMouseDown",this._onMiddleMouseDownCB),o.removeEvent(e,"onTouch",this._onTouchCB),o.removeEvent(e,"onSwipe",this._onSwipeCB),o.removeEvent(e,"onPinchPanRotate",this._onPinchPanRotateCB),o.removeEvent(e,"onTap",this._onTapCB)},p.prototype.addViewToManipulation=function(e){return-1===this.manipulatedViewList.indexOf(e)&&(this.manipulatedViewList.push(e),this.addViewToGestures(e),!0)},p.prototype.removeViewFromManipulation=function(e){var t=this.manipulatedViewList.indexOf(e);return-1!==t&&(this.manipulatedViewList.splice(t,1),this.removeViewFromGestures(e),!0)},p.prototype.setTarget=function(e){this.target.copy(e)},p.prototype.onMove=function(e){return this._modelEvent.subscribe({event:"ViewpointMove"},e)},p.prototype.unsubscribe=function(e){var t=this._customZoomTokens.indexOf(e);-1!==t?this._customZoomTokens.splice(t,1):-1!==(t=this._customPanTokens.indexOf(e))?this._customPanTokens.splice(t,1):-1!==(t=this._customRotateTokens.indexOf(e))&&this._customRotateTokens.splice(t,1),this._modelEvent.unsubscribe(e)},p.prototype.updateNativeZoom=function(e){if(this.camera.isOrtho&&null!=this.viewpoint._nativeZoomType){this.camera.setVisualizedHeight(e);let t=1/this.viewpoint.getMMInSupportUnit();switch(this.viewpoint._nativeZoomType){case this.viewpoint.NativeZoomTypes.MillimeterScreenBased:this.viewpoint._nativeZoom=this.viewer.SCREEN_HEIGHT*t/(this.camera.top-this.camera.bottom);break;case this.viewpoint.NativeZoomTypes.HalfWindowHeightBased:case this.viewpoint.NativeZoomTypes.HalfWindowWidthAndHeigthBased:this.viewpoint._nativeZoom=2/(this.camera.top-this.camera.bottom)}}},p.prototype.update=function(){var e=this.camera.position.clone(),i=this.camera.quaternion.clone(),r=new t.Vector3(0,0,1),n=!1;if(this.camera.useQuaternion=!0,r.applyQuaternion(this.orientation),r.setLength(this.distanceToTarget),this.camera.position.addVectors(this.target,r),this.camera.isOrtho&&null==this.viewpoint._nativeZoomType&&(this.camera.setVisualizedHeight(this.distanceToTarget),this.camera.updateProjectionMatrix()),null!=this.viewpoint._nativeZoomType){let e=this.viewpoint.updateNative2D(),t=.5*(this.camera.top-this.camera.bottom)/Math.tan(this.camera.fov*Math.PI/360);this.distanceToTarget=t,r.setLength(t);var s=e.clone().sub(r);this.setTarget(s),this.camera.position.addVectors(this.target,r)}this.camera.quaternion.copy(this.orientation),this.camera.up=new t.Vector3(0,1,0),this.camera.up.applyQuaternion(this.orientation),e.sub(this.camera.position),i.sub(this.camera.quaternion),this.position.copy(this.camera.position),this.camera.updateMatrix(),this.camera.matrixWorld.copy(this.camera.matrix),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),this.camera.updateProjectionMatrix(),(this.infiniteRender||e.lengthSq()>1e-7||i.lengthSq()>1e-7||this.camera._hasChanged)&&(n=!0,this.dispatchEvent(p.changeEvent),this.viewpoint._updateFrustum(),this._modelEvent.publish({event:"ViewpointMove",context:this}),this._2DMode&&this.viewer.svgRoot&&this.viewer._updateSVGVisu(),this.viewer&&(this.viewer.renderIteration=0)),this.camera._hasChanged=!1;var o={eventChannel:n?"/VISU/":"/VISU/SpriteNodeInit",eventType:"@onViewpointChange",viewpoint:this.viewpoint,cameraEye:this.position,cameraTarget:this.target,cameraUp:this.camera.up};return a.publish({event:n?"/VISU/":"/VISU/SpriteNodeInit",data:o}),n},p.prototype.moveTo=function(e){console.log("TrackballControls.prototype.moveTo is DEPRECATED: use Viewpoint.moveTo instead.");var s,o,l,c={position:e.position,target:e.target||this.target.clone(),orientation:e.orientation||this.orientation.clone(),distanceToTarget:e.distanceToTarget||this.distanceToTarget,duration:e.duration||0};if(e instanceof t.Vector3&&(console.warn("TrackballControls.prototype.moveTo now uses options litteral object as argument."),c.target=arguments[0],arguments[1]&&(c.orientation=arguments[1]),void 0!==arguments[2]&&(c.distanceToTarget=arguments[2]),void 0!==arguments[3]&&(c.duration=arguments[3])),this._targetAnim&&this._targetAnim.stop(),this._orientationAnim&&this._orientationAnim.stop(),this._distanceToTargetAnim&&this._distanceToTargetAnim.stop(),c.position&&e.target){var h=(new t.Vector3).subVectors(e.target,c.position);if(c.distanceToTarget=h.length(),!e.orientation){var u=(new t.Matrix4).lookAt(c.position,e.target,new t.Vector3(0,0,1));c.orientation.setFromRotationMatrix(u)}}else if(c.position){var d=new t.Vector3(0,0,1);d.applyQuaternion(c.orientation),d.setLength(c.distanceToTarget);var p=(new t.Vector3).subVectors(c.position,d);c.target=p}if(0===c.duration)this.setTarget(c.target),this.orientation=c.orientation,this.distanceToTarget=c.distanceToTarget,this.update();else{(s=new r(this.target.clone(),c.target,c.duration)).setInterpolator(function(e,t,i){var r=t.clone();return r.lerp(i,e),r});var f=this;this._targetAnim=new n(this,"setTarget",s,function(e){if(e===i.State.STOPPED){var t={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:f.viewpoint,cameraEye:f.camera.position,cameraUp:f.camera.up};a.publish({event:"/VISU/",data:t})}}),(o=new r(this.orientation,c.orientation,c.duration)).setInterpolator(function(e,i,r){var n=new t.Quaternion;return t.Quaternion.slerp(i,r,n,e),n}),this._orientationAnim=new n(this,"orientation",o),l=new r(this.distanceToTarget,c.distanceToTarget,c.duration),this._distanceToTargetAnim=new n(this,"distanceToTarget",l),this._targetAnim.start(),this._orientationAnim.start(),this._distanceToTargetAnim.start()}},p.prototype.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)},p.prototype.startPan=function(e){this.endRotate(),this.endZoom(),this._forcePan=!0,e&&(this._forcePanCmd=e),this.viewer&&(this.oldManipActive=this.viewer.getManipulators(),this.viewer.setManipulators({activated:!1}),this.viewer.setCursor("Pan",0))},p.prototype.startRotate=function(e){this.endPan(),this.endZoom(),this._forceRotate=!0,e&&(this._forceRotateCmd=e),this.viewer&&(this.oldManipActive=this.viewer.getManipulators(),this.viewer.setManipulators({activated:!1}),this.viewer.setCursor("Rotate",0))},p.prototype.startZoom=function(e){this.endPan(),this.endRotate(),this._forceZoom=!0,e&&(this._forceZoomCmd=e),this.viewer&&(this.oldManipActive=this.viewer.getManipulators(),this.viewer.setManipulators({activated:!1}),this.viewer.setCursor("Zoom",0))},p.prototype.endPan=function(e){this._forcePan&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive}),this._forcePan=!1,this._forcePanCmd&&(this._forcePanCmd.end(!0),this.viewer.setCursor("Auto",0),this._changeState(p.State.NONE),this.viewer.trapSelection&&(this.viewer.trapSelection.isInterrupted=!1))},p.prototype.endRotate=function(e){this._forceRotate&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive}),this._forceRotate=!1,this._forceRotateCmd&&(this._forceRotateCmd.end(!0),this.viewer.setCursor("Auto",0),this._changeState(p.State.NONE),this.viewer.trapSelection&&(this.viewer.trapSelection.isInterrupted=!1))},p.prototype.endZoom=function(e){this._forceZoom&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive}),this._forceZoom=!1,this._forceZoomCmd&&(this._forceZoomCmd.end(!0),this.viewer.setCursor("Auto",0),this._changeState(p.State.NONE),this.viewer.trapSelection&&(this.viewer.trapSelection.isInterrupted=!1))},p.prototype._getMouseProjectionOnBall=function(e){var i,r,n,a;return(r=(i=new t.Vector3((e.x-.5*this.domElement.clientWidth)/this.radius,(.5*this.domElement.clientHeight-e.y)/this.radius,0)).length())>1?i.normalize():i.z=Math.sqrt(1-r*r),n=(new t.Vector3).subVectors(this.camera.position,this.target),(a=new t.Vector3).add(this.camera.up.clone().cross(n).setLength(i.x)),a.add(this.camera.up.clone().setLength(i.y)),a.add(n.clone().setLength(i.z)),a},p.prototype._pan=function(e,t){this.update(),this._doPan(e.x-t.x,e.y-t.y)},p.prototype._doPan=function(e,i){var r,n,a;0===e&&0===i||(r=(new t.Vector3).copy(this.camera.position).sub(this.target),this.camera.isOrtho?n=(this.camera.top-this.camera.bottom)/this.viewer._getDivClientHeight():(n=2*this.distanceToTarget*Math.tan(.5*this.camera.fov*Math.PI/180)/this.viewer._getDivClientHeight(),this._mode===p.Mode.LOOKAROUND&&(n=-n)),(a=new t.Vector3).add(r.clone().cross(this.camera.up).setLength(n*e)),a.add(this.camera.up.clone().setLength(n*i)),this.target.add(a))},p.prototype._rotate=function(e,i){var r,n,a,s,o;this.update(),r=this._getMouseProjectionOnBall(i),n=this._getMouseProjectionOnBall(e),(a=Math.acos(r.dot(n)/(r.length()*n.length())))&&(s=(new t.Vector3).crossVectors(r,n).normalize(),a*=this.rotateSpeed,o=(new t.Quaternion).setFromAxisAngle(s,-a),this.orientation.multiplyQuaternions(o,this.orientation.clone()))},p.prototype._rotateLockZ=function(e,t){this._rotateLockWorldUpVector(e,t)},p.prototype._getAvatarPositionFromCamera=function(e,t){var i=e.clone();return this._avatarDistance>0&&e&&(i=i.add(t.clone().multiplyScalar(this._avatarDistance))),i},p.prototype._getCameraFromAvatarPosition=function(e,t){var i=e.clone();return this._avatarDistance>0&&e&&(i=i.sub(t.clone().multiplyScalar(this._avatarDistance))),i},p.prototype._turnHeadLockWorldUpVector=function(e,i,r){this.update(),this._stopRotation();var n=this.distanceToTarget,a=this.camera.getLookAt(),s=this.camera.up,o=this.camera.position,l=new t.Vector3(0,0,1);"y"===this.viewpoint.getWorldOrientation().upAttribute&&(l=new t.Vector3(0,1,0));var c=this.viewpoint.getAngle()*Math.PI/180,h=o.clone();this._getAvatarPositionFromCamera&&(h=this._getAvatarPositionFromCamera(o,a));var u=-e*c/this.viewer.SCREEN_HEIGHT,d=-i*c/this.viewer.SCREEN_HEIGHT,p=new t.Vector3(0,0,0);p.crossVectors(a,s);var f=l.angleTo(s),m=new t.Vector3(0,0,0);m.crossVectors(l,s),m.dot(p)<0&&(f=-f),f+d>Math.PI/2&&(d=Math.PI/2-f),f+d<-Math.PI/2&&(d=-Math.PI/2-f),p.applyAxisAngle(l,u),a.applyAxisAngle(l,u),0!==d&&a.applyAxisAngle(p,d),s.crossVectors(p,a);var g=new t.Vector3(0,0,0);if(g.crossVectors(a,l),g&&g.length()>.1){var v=s.dot(g);g.setLength(v),g.multiplyScalar(-1),s.add(g),s.normalize()}this._getCameraFromAvatarPosition&&(o=this._getCameraFromAvatarPosition(h,a));var S=o.clone().add(a.clone().multiplyScalar(n)),_=new t.Quaternion,y=new t.Matrix4;y.lookAt(o,S,s),_.setFromRotationMatrix(y),this.setTarget(S),this.orientation=_,this.needsRotationFinalized=!0,this.deltaPosition=r.deltaPosition.clone(),this.previousTime>0&&(this.deltaTime=r.currentTime-this.previousTime),this.previousTime=r.currentTime},p.prototype._finalizeTurnHeadLockWorldUpVector=function(e,a){if(this.update(),this._stopRotation(),this.needsRotationFinalized&&(this.needsRotationFinalized=!1,(!this.viewpoint._viewpointAnimation||this.viewpoint._viewpointAnimation.state()!==i.State.RUNNING)&&!this.lockRotation&&(!a||!this.lockTouchRotation)&&(a||!this.lockMouseRotation))){var s=new t.Vector2;s.copy(this.deltaPosition),s.multiplyScalar(1/this.deltaTime);if(!(s.length()<.3)){s.length()>6&&s.setLength(6);var o=this.distanceToTarget,l=this.camera.position,c=new t.Vector3(0,0,1);"y"===this.viewpoint.getWorldOrientation().upAttribute&&(c=new t.Vector3(0,1,0));var h=this.viewpoint.getAngle()*Math.PI/180,u=this.viewer.SCREEN_HEIGHT,d=new r(0,0,800),p=this.camera.getLookAt(),f=this.camera.up,m=(new t.Quaternion).copy(this.orientation),g=l.clone(),v=l.clone().add(p.clone().multiplyScalar(o)),S=0,_=this;d.setInterpolator(function(e,i,r){var n=g.clone();_._getAvatarPositionFromCamera&&(n=_._getAvatarPositionFromCamera(g,p));var a=s.clone().multiplyScalar(1-e);e*=800;var l=a.x*(e-S),d=a.y*(e-S);S=e;var y=-l*h/u,x=-d*h/u,M=new t.Vector3(0,0,0);M.crossVectors(p,f);var P=c.angleTo(f),C=new t.Vector3(0,0,0);C.crossVectors(c,f),C.dot(M)<0&&(P=-P),P+x>Math.PI/2&&(x=Math.PI/2-P),P+x<-Math.PI/2&&(x=-Math.PI/2-P),M.applyAxisAngle(c,y),p.applyAxisAngle(c,y),0!==x&&p.applyAxisAngle(M,x),f.crossVectors(M,p);var b=new t.Vector3(0,0,0);if(b.crossVectors(p,c),b&&b.length()>.1){var D=f.dot(b);b.setLength(D),b.multiplyScalar(-1),f.add(b),f.normalize()}_._getCameraFromAvatarPosition&&(g=_._getCameraFromAvatarPosition(n,p)),v=g.clone().add(p.clone().multiplyScalar(o));var w=new t.Matrix4;w.lookAt(g,v,f),m.setFromRotationMatrix(w)});var y={me:this,setOrientation:function(e){this.me.setTarget(v),this.me.orientation=m}};this._orientationAnim=new n(y,"setOrientation",d),this._orientationAnim.start()}}},p.prototype._rotateLockWorldUpVector=function(e,t){this.update(),this._stopRotation();var i=this.viewpoint._worldOrientation.upAttribute;if(this._state===p.State.ZOOM_PAN_ROTATE){if(!this.rotateDirection||this._state!==this.lastLockZState)0===(r=+(r=this.camera.getLookAt()[i]))||isNaN(r)?this.rotateDirection=r:this.rotateDirection=r>0?1:-1;this.orientation=this.viewpoint._worldOrientation.getOrientationForLockedRotation(-this.rotateDirection*e*this.lockZRotationSpeed,t*this.lockZRotationSpeed,this.orientation)}else{var r;if(!this.rotateDirection||this._state!==this.lastLockZState)0===(r=+(r=this.camera.up[i]))||isNaN(r)?this.rotateDirection=r:this.rotateDirection=r>0?1:-1;this.orientation=this.viewpoint._worldOrientation.getOrientationForLockedRotation(this.rotateDirection*e*this.lockZRotationSpeed,t*this.lockZRotationSpeed,this.orientation)}this.lastLockZState=this._state,this.needsRotationFinalized=!0},p.prototype._finalizeRotateLockZ=function(e,t){this._finalizeRotateLockWorldUpVector(e,t)},p.prototype._finalizeRotateLockWorldUpVector=function(e,i){this._stopRotation();var a=this.viewpoint._worldOrientation,s=a.upAttribute;a.frontAttribute,a.rightAttribute;if(this.needsRotationFinalized&&!this.lockRotation&&(!i||!this.lockTouchRotation)&&(i||!this.lockMouseRotation)){var o=e.currentTime-e.startTime,l=new t.Vector2;if(l.copy(e.offsetPosition),l.multiplyScalar(.003/o),!(l.length()<1e-7)){l.length()>.01&&l.setLength(.01);var c=(new t.Quaternion).copy(this.orientation),h=l.clone().normalize().multiplyScalar(6e-6),u=l.length()/h.length(),d=new r(0,0,u),p=0,f=this.camera.up[s];p=0===(f=+f)||isNaN(f)?f:f>0?1:-1,d.setInterpolator(function(e,t,i){e*=u;var r=l.x*e-.5*h.x*e*e,n=l.y*e-.5*h.y*e*e;return a.getOrientationForLockedRotation(p*r,n,c)});var m={me:this,setOrientation:function(e){this.me.orientation=e}};this._orientationAnim=new n(m,"setOrientation",d),this._orientationAnim.start(),this.needsRotationFinalized=!1}}},p.prototype._zoom=function(e,i){var r,n;this.update(),r=e.y-i.y,1!==(n=1+(r*=.5/this.radiusZoom)*this.zoomSpeed)&&n>0&&(this._zoomType===p.ZoomType.ZOOM_FOV_CHANGE?this._zoomFOVChange(new t.Vector2(Math.floor(.5*this.viewer.SCREEN_WIDTH),Math.floor(.5*this.viewer.SCREEN_HEIGHT)),n<1,n):this.distanceToTarget*=n),this.updateNativeZoom(this.distanceToTarget)},p.prototype._zoomPanRotate=function(e,i){this.update(),this._stopRotation();var r=e.getEvents(),n=r[0],a=r[1];if(!(this.lockZoom||i&&1!==i)){var s;s=e.distance-e.lastDistance;var o={gesture:e,factor:c=1-(s*=.5/this.radiusZoom)*this.zoomSpeed,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:o,context:this}),o.defaultBehavior&&1!==c&&c>0){var l=(new t.Vector2).addVectors(n.lastPosition,a.lastPosition).multiplyScalar(.5);if(this._zoomType===p.ZoomType.ZOOM_FOV_CHANGE)this._zoomFOVChange(l,c<1,c);else if(this._mode===p.Mode.LOOKAROUND){var c=this._getZoomFOVOnCursorFactorForTwoPointers(n.currentPosition,a.currentPosition,n.lastPosition,a.lastPosition);this._zoomFOVOnCursor(l,c<0,180*c/Math.PI)}else this._zoomSimple(l,c<1,c)}}if(!(this.lockPan||i&&2!==i)){var h,u=n.getCurrentPosition(this.domElement),d=a.getCurrentPosition(this.domElement),f=n.getLastPosition(this.domElement),m=a.getLastPosition(this.domElement);h=.5*(u.x+d.x)-.5*(f.x+m.x),s=.5*(u.y+d.y)-.5*(f.y+m.y);var g={gesture:e,defaultBehavior:!0};this._modelEvent.publish({event:"Pan",data:g,context:this}),g.defaultBehavior&&this._doPan(h,s)}if(!(this.lockRotation||this.lockTouchRotation||i&&3!==i||this._mode===p.Mode.LOOKAROUND)){var v={gesture:e,defaultBehavior:!0};if(this._modelEvent.publish({event:"Rotate",data:v,context:this}),v.defaultBehavior)if(this.rollingForTouchAvailable&&this.lockZ||!this.rollingForTouchAvailable)this._rotateLockWorldUpVector(-200*e.getDeltaAngle(),0);else{u=n.getCurrentPosition(this.domElement),d=a.getCurrentPosition(this.domElement),n.getLastPosition(this.domElement),a.getLastPosition(this.domElement);for(var S=new t.Vector2,_=0;_<2;_++)S.add(r[_].getCurrentPosition(this.domElement)),S.add(r[_].getLastPosition(this.domElement));S.divideScalar(4);var y=e.getDeltaAngle();this._rotateTwoTouch(y,S)}}},p.prototype._intersectLines=function(e,i,r,n){var a=new t.Vector2;a.subVectors(i,e);var s=new t.Vector2;s.subVectors(r,n);var o=a.y,l=-a.x,c=a.x*e.y-a.y*e.x,h=s.y,u=-s.x,d=s.x*r.y-s.y*r.x,p=o*u-l*h;if(0===p)return null;var f=(l*d-c*u)/p,m=-(o*d-c*h)/p;return new t.Vector2(f,m)},p.prototype._rotateTwoTouch=function(e,i){this.update();var r=this.viewpoint.create3DRayFrom2DPoint(i).origin;if(Number.isFinite(e)){var n=this.camera.getLookAt();n.negate();var a=(new t.Quaternion).setFromAxisAngle(n,e),s=this.camera.position,o=(new t.Vector3).subVectors(s,r),l=(new t.Vector3).addVectors(r,o.applyQuaternion(a));this.viewpoint.moveTo({eyePosition:l,orientation:a.multiply(this.orientation.clone())})}},p.prototype._zoomSimpleOnCenter=function(e,t,i){var r;r=void 0!==i?i:t?.9:1.1;var n=this.distanceToTarget*r;this.distanceToTarget=n,this.updateNativeZoom(this.distanceToTarget)},p.prototype._zoomSimple=function(e,i,r){var n,a=new t.Projector,s=this.viewer.getMousePosition(e);n=void 0!==r?r:i?.9:1.1;s=this.viewer.getMousePosition(e);var o=this.camera.getLookAt(),l=this.camera.position,c=this.target.clone().sub(o.clone().multiplyScalar(this.distanceToTarget*n)),h=new t.Vector3(s.x,s.y,.5),u=new t.Vector3(s.x,s.y,.5);a.unprojectVector(h,this.camera);var d=null;if(this.camera instanceof t.OrthographicCamera)this.camera.setVisualizedHeight(this.distanceToTarget*n),a.unprojectVector(u,this.camera),d=h.sub(u);else{var f,m;this.camera.matrixWorld.setPosition(c),a.unprojectVector(u,this.camera),this.camera.matrixWorld.setPosition(l),f=new t.Ray(l,h.clone().sub(l).normalize()),m=new t.Ray(c,u.clone().sub(c).normalize());var g=this.viewpoint.getBoundingSphere(),v=f.at(this.camera.near/f.direction.clone().dot(o)),S=f.direction.clone().dot(g.center.clone().sub(v)),_=Math.max(0,S-g.radius),y=Math.max(0,S+g.radius),x=v.add(f.direction.clone().multiplyScalar(.5*(_+y))),M=o.negate(),P=-M.clone().dot(x),C=new t.Plane(M,P),b=m.intersectPlane(C);d=x.clone().sub(b)}c.add(d);var D=this.distanceToTarget*n;if(this._state===p.State.ZOOM_PAN_ROTATE){var w=this.camera.getLookAt();this.setTarget((new t.Vector3).addVectors(c,w.clone().multiplyScalar(D))),this.distanceToTarget=D,this.update()}else this.viewpoint.moveTo({eyePosition:c,distanceToTarget:D});this.updateNativeZoom(D)},p.prototype._zoomSimpleOnCursor=function(e,i,r){var n;n=void 0!==r?r:i?.9:1.1;var a=this.distanceToTarget*n,s=this.viewer.getMousePosition(e),o=this.camera.getLookAt(),l=this.camera.position,c=new t.Vector3(s.x,s.y,.5),h=new t.Vector3(s.x,s.y,.5),u=new t.Projector;u.unprojectVector(c,this.camera);var d=null;if(this.camera instanceof t.OrthographicCamera){d=this.target.clone().sub(o.clone().multiplyScalar(a)),this.camera.setVisualizedHeight(a),u.unprojectVector(h,this.camera);var p=c.sub(h);d.add(p)}else{p=(new t.Vector3).subVectors(c,l).normalize().multiplyScalar(this.distanceToTarget-a);d=this.camera.position.clone().add(p)}this.viewpoint.moveTo({eyePosition:d,distanceToTarget:a}),this.updateNativeZoom(a)},p.prototype._getZoomFOVAngle=function(e,i){var r=this.viewer.getMousePosition(i),n=this.viewer.getMousePosition(e),a=new t.Vector3(r.x,r.y,.5),s=new t.Vector3(n.x,n.y,.5),o=new t.Projector;o.unprojectVector(a,this.camera),o.unprojectVector(s,this.camera);var l=this.camera.position,c=a.clone().sub(l),h=s.clone().sub(l);return c.angleTo(h)},p.prototype._getZoomFOVOnCursorFactorForOnePointer=function(e,t){var i=e,r=t;i.x=r.x;var n=this._getZoomFOVAngle(i,r);return r.y<i.y&&(n=-n),2*n},p.prototype._getZoomFOVOnCursorFactorForTwoPointers=function(e,t,i,r){var n=this._getZoomFOVAngle(r,i);return this._getZoomFOVAngle(t,e)-n},p.prototype._zoomFOVOnCursor=function(e,i,r){var n=4;n=void 0!==r?-r:i?-n:n;var a=null;e&&(a=this.viewer.getMousePosition(e));var s=this.distanceToTarget,o=this.camera.getLookAt(),l=this.camera.position,c=this.camera.up,h=new t.Vector3(0,0,1);"y"===this.viewpoint.getWorldOrientation().upAttribute&&(h=new t.Vector3(0,1,0));var u=this.viewer.SCREEN_WIDTH,d=this.viewer.SCREEN_HEIGHT,p=this.viewpoint.getAngle(),f=null;if(!(p>=100&&n>=0||p<=20&&n<=0)){if((f=p+n)>100?f=100:f<20&&(f=20),a){var m=.03*n,g=.03*n*d/u,v=a.x/2*m,S=-a.y/2*g,_=new t.Vector3(0,0,0);_.crossVectors(o,c);var y=h.angleTo(c),x=new t.Vector3(0,0,0);x.crossVectors(h,c),x.dot(_)<0&&(y=-y),y+S>Math.PI/2&&(S=Math.PI/2-y),y+S<-Math.PI/2&&(S=-Math.PI/2-y),_.applyAxisAngle(h,v),o.applyAxisAngle(h,v),0!==S&&o.applyAxisAngle(_,S),c.crossVectors(_,o)}var M=new t.Vector3(0,0,0);if(M.crossVectors(o,h),M&&M.length()>.1){var P=c.dot(M);M.setLength(P),M.multiplyScalar(-1),c.add(M),c.normalize()}var C=l.clone().add(o.clone().multiplyScalar(s)),b=new t.Quaternion,D=new t.Matrix4;D.lookAt(l,C,c),b.setFromRotationMatrix(D),a&&(this.setTarget(C),this.orientation=b),this.viewpoint.setAngle(f),this.camera.updateProjectionMatrix(),this.camera._hasChanged=!0}},p.prototype._zoomFOVChange=function(e,i,r){var n,a=new t.Projector,s=this.viewer.getMousePosition(e);n=void 0!==r?r:i?.9:1/.9;s=this.viewer.getMousePosition(e);var o=this.camera.getLookAt(),l=this.camera.position,c=l.clone(),h=new t.Vector3(s.x,s.y,.5),u=new t.Vector3(s.x,s.y,.5);a.unprojectVector(h,this.camera);var d,p,f,m,g=this.viewpoint.getBoundingSphere(),v=this.viewpoint.getAngle()/2,S=o.clone().dot(g.center.clone().sub(l)),_=2*g.radius;if(S<_){var y=S-_,x=o.clone().multiplyScalar(y),M=Math.tan(t.Math.degToRad(.5*this.viewpoint.getAngle())),P=t.Math.radToDeg(Math.atan(M*(S+y)/S));P>22.5||P<0?P=22.5:(l.add(x),c=l.clone()),v=P,this.viewpoint.setAngle(2*P),this.camera.updateProjectionMatrix(),S=_}if(i){w=v*n;var C=n;if(S>_){var b=S-_,D=_/S;if(D<n)b=S-S*n,C=1;else C=w/(v*D);b>0&&c.add(o.clone().multiplyScalar(b))}1!=C&&(this.viewpoint.setAngle(C*v*2),this.camera.updateProjectionMatrix())}else{var w,E=1;if(v<22.5)(w=v*n)>22.5?(this.viewpoint.setAngle(45),E=w/22.5):this.viewpoint.setAngle(2*w),this.camera.updateProjectionMatrix();else E=n;if(1!=E){var T=E*S;x=o.clone().multiplyScalar(S-T);c.add(x)}}m=this.target.clone().sub(c).length(),this.camera.matrixWorld.setPosition(c),a.unprojectVector(u,this.camera),this.camera.matrixWorld.setPosition(l),p=new t.Ray(l,h.clone().sub(l).normalize()),f=new t.Ray(c,u.clone().sub(c).normalize());var A=p.at(this.camera.near/p.direction.clone().dot(o)),I=p.direction.clone().dot(g.center.clone().sub(A)),R=Math.max(0,I-g.radius),L=Math.max(0,I+g.radius),O=A.add(p.direction.clone().multiplyScalar(.5*(R+L))),N=o.negate(),F=-N.clone().dot(O),V=new t.Plane(N,F),U=f.intersectPlane(V);d=O.clone().sub(U),c.add(d),this.viewpoint.setAngle(Math.min(this.viewpoint.getAngle(),45)),this.camera instanceof t.OrthographicCamera&&this.camera.setVisualizedHeight(m),this.camera._hasChanged=!0,this.viewpoint.moveTo({eyePosition:c,distanceToTarget:m})},p.prototype._mouseWheel=function(e){e.event.preventDefault();var t=UWA.Event.wheelDelta(e.getJSEvent());this.isMac&&(t*=-1);var i={evt:e,factor:t,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:i,context:this}),this.isCurrentViewpoint()){var r=this;if(this._wheelMoving=!0,this._wheelTimer&&clearTimeout(this._wheelTimer),this._wheelTimer=setTimeout(function(){r._wheelMoving=!1,clearTimeout(r._wheelTimer),r._wheelTimer=null},300),i.defaultBehavior){var n=!1;if(this.lockMouseZoomForCtrlKeyWheelMode){var a=e.getJSEvent();a&&!0===a.ctrlKey&&(n=!0)}this._zoomType===p.ZoomType.ZOOM_FOV_CHANGE?!this.lockZoom&&!n&&this._zoomFOVChange(e.getCurrentPosition(this.domElement),t>0):this._mode===p.Mode.LOOKAROUND?this.lockZoom:!this.lockZoom&&!n&&this._zoomSimple(e.getCurrentPosition(this.domElement),t>0)}}},p.prototype._resize=function(e,t){this.radius=.5*Math.max(e,t),this.radiusZoom=.25*(e+t)},p.prototype._stopRotation=function(e){this._orientationAnim&&this._orientationAnim.stop()},p.prototype._changeState=function(e){var t=this._state;switch(this._state===p.State.NONE&&(this._oldCursor=this.viewer.getCursor()),this.rotateDirection=0,this._state=e,e){case p.State.ZOOM:case p.State.FORCE_ZOOM:!this.lockZoom&&this.viewer.setCursor("Zoom",100);break;case p.State.PAN:case p.State.FORCE_PAN:!this.lockPan&&this.viewer.setCursor("Pan",100);break;case p.State.ROTATE:case p.State.FORCE_ROTATE:!this.lockRotation&&this.viewer.setCursor("Rotate",100);break;case p.State.HOLD:break;default:this.viewer.setCursor(this._oldCursor,0,!0)}if(this.viewpoint){var i=e!==p.State.NONE&&e!==p.State.HOLD&&e!==p.State.STOP;if(this.viewpoint._isMoving===i)return;this.viewpoint._isMoving=i;var r={eventChannel:"/VISU/",eventType:i?"@onViewpointBeginMove":"@onViewpointEndMove",viewpoint:this.viewpoint,cameraEye:this.viewpoint.camera.position,cameraUp:this.viewpoint.camera.up,from:"controller"};a.publish({event:"/VISU/",data:r})}!u.isRecording()||this._state!==p.State.NONE||this._state===t||this.isLeftClick()||this.isRightClick()||(window.WebVisuCurrentGesture.highLevelRecordJSON||(window.WebVisuCurrentGesture.highLevelRecordJSON={}),window.WebVisuCurrentGesture.highLevelRecordJSON.TrackBallControls={name:this._recordRegisterName,setViewPoint:this.positionToJSON()})},p.prototype._onBasicEvent=function(e){if(e.from)for(var t=0;t<e.from.length;t++){var i=e.from[t],r=i.getType(),n=i.getState();if("Keyboard"===r){var a=i.getKey();if(n===l.State.BEGIN){if(a===l.KeyboardKey.CTRL&&(this._ctrlKeyPressed=!0),a===l.KeyboardKey.SHIFT)if(this._shiftKeyPressed=!0,this._mode>0)(s=o._getGesture(document,"onEdit"))&&s.setTimerMouse(0);this._mode>0&&this._ctrlKeyPressed&&this._state===p.State.ROTATE&&this._changeState(p.State.FORCE_PAN)}else if(n===l.State.END){var s;if(a===l.KeyboardKey.CTRL&&(this._ctrlKeyPressed=!1),a===l.KeyboardKey.SHIFT)if(this._shiftKeyPressed=!1,this._mode>0)(s=o._getGesture(document,"onEdit"))&&s.setTimerMouse(o.getHoldTime());this._mode>0&&(this._ctrlKeyPressed||this._state!==p.State.PAN||this.isCurrentViewpoint()&&this._changeState(p.State.ROTATE))}o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this,"TrackballControls","UpdateControlKeys",{ctrl:this._ctrlKeyPressed,shift:this._shiftKeyPressed})}else if("Mouse"===r){if(this.lockMouse)continue;var c=i.button;if(n===l.State.BEGIN){var h=!1;if(c!==l.MouseButton.MIDDLE&&c!==l.MouseButton.WHEEL||!i.isInView(this.manipulatedViewList)||(h=!0,i.getJSEvent().stopPropagation&&i.getJSEvent().stopPropagation()),c===l.MouseButton.WHEEL&&this._mode>0&&i.isInView(this.manipulatedViewList)&&this._state!==p.State.STOP&&this._mouseWheel(i),!h||c===l.MouseButton.WHEEL&&this._mode===p.Mode.CATIA){if(h&&!this.lockPreventDefaultForCtrlKeyWheel&&c===l.MouseButton.WHEEL){var u=i.getJSEvent();u&&!0===u.ctrlKey&&UWA.Event.preventDefault(i.getJSEvent())}}else UWA.Event.preventDefault(i.getJSEvent())}else n===l.State.MOVE&&i.offsetPosition.length()>this._clickTolerancy&&(c===l.MouseButton.LEFT&&this._leftButtonPressed&&(this._leftClicking&&o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelLeftClick"),this.resetLeftClick()),c===l.MouseButton.MIDDLE&&this._middleButtonPressed&&(this._middleClicking&&o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelMiddleClick"),this._middleClicking=!1),c===l.MouseButton.RIGHT&&this._rightButtonPressed&&(this._rightClicking&&o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelRightClick"),this._rightClicking=!1))}}},p.prototype._onEditEventBegin=function(e){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){var i=t instanceof c;if(this._mode>0||i){var r=t.getCurrentPosition(this.domElement),n=i?80:40;this._setPositionSpinner(this.ShortHoldSpinner,r,n),this._shortHoldCircleAnim=this._showSpinner(this.ShortHoldSpinner,this.SVGCircle,n,6)}}},p.prototype._onEditEventKO=function(e){this._hideSpinner(this.ShortHoldSpinner,this._shortHoldCircleAnim)},p.prototype._onLeftMouseDown=function(e){if(!this.handleRecordData(e)&&!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}var r=t.isInView(this.manipulatedViewList);if(this._publishWUXEvent("PrimaryPointerDown",e,!1),this._leftButtonPressed=!0,this.startLeftClick(),this.isCurrentViewpoint()){this._mouseDownPos=this.viewer.getMousePosition(t.getCurrentPosition(this.viewer.canvas));var n=this._forcePan||this._forceRotate||this._forceZoom;this._state===p.State.STOP||this._state===p.State.HOLD&&!n?this._pickingCB&&this.viewer&&this.viewer.leftMouseDownCB&&this.viewer.leftMouseDownCB(t,this):(r&&n&&(this._state===p.State.NONE||this._state===p.State.HOLD)?(this._setCapture(),this._forcePan?this._changeState(p.State.FORCE_PAN):this._forceRotate?this._changeState(p.State.FORCE_ROTATE):this._forceZoom&&this._changeState(p.State.FORCE_ZOOM)):this._2DMode&&this._mode>0?r&&(this._setCapture(),this._changeState(p.State.PAN)):this._mode===p.Mode.SIMPLE?r&&!this.lockMouseRotationForSimpleMode&&(this._setCapture(),this._changeState(p.State.ROTATE)):this._mode===p.Mode.LOOKAROUND?r&&(this._setCapture(),this._changeState(p.State.ROTATE)):(this._state!==p.State.PAN&&this._state!==p.State.ZOOM||(r&&this._setCapture(),this._changeState(p.State.ROTATE)),this._mode===p.Mode.CATIA&&this.viewer.trapSelection&&this.viewer.trapSelection.interrupt(),this._mode!==p.Mode.COMBINED||!r||this.lockRotation||this.lockMouseRotationForSimpleMode||(this._setCapture(),this._changeState(p.State.ROTATE))),this._pickingCB&&this.viewer&&this.viewer.leftMouseDownCB&&(this.viewer.leftMouseDownCB(t,this),this.viewer.trapSelection&&n&&this.viewer.trapSelection.softInterrupt()),this.tagEventIfModeNotNONE(e))}}}},p.prototype._onMiddleMouseDown=function(e){if(!this.handleRecordData(e)&&!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}t.isInView(this.manipulatedViewList)&&this._setCapture(),this._middleButtonPressed=!0,this._middleClicking=!0,this.isCurrentViewpoint()&&(this._state!==p.State.STOP&&this._state!==p.State.HOLD?(this._mode>0?this._changeState(p.State.PAN):this._state===p.State.NONE&&(this._leftButtonPressed||this._rightButtonPressed||this._changeState(p.State.PAN)),this._pickingCB&&this.viewer&&this.viewer.centerMouseDownCB&&this.viewer.centerMouseDownCB(t,this),this.tagEventIfModeNotNONE(e)):this._pickingCB&&this.viewer&&this.viewer.centerMouseDownCB&&this.viewer.centerMouseDownCB(t,this))}}},p.prototype._onRightMouseDown=function(e){if(!this.handleRecordData(e)&&!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}t.isInView(this.manipulatedViewList)&&this._setCapture(),this._rightClicking=!0,this._rightButtonPressed=!0,this.isCurrentViewpoint()&&this._state!==p.State.STOP&&this._state!==p.State.HOLD&&(this._mode===p.Mode.LOOKAROUND?this._changeState(p.State.ZOOM):this._mode>0&&this._state===p.State.NONE?t.isInView(this.manipulatedViewList)&&this._changeState(p.State.ZOOM):this._state!==p.State.PAN&&this._state!==p.State.ZOOM||this._changeState(p.State.ROTATE),this.tagEventIfModeNotNONE(e))}}},p.prototype._onLeftMouseUp=function(e){if(this.handleRecordData(e))return this._leftButtonPressed=!1,void(this._mouseDownPos=null);if(!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}if(this._releaseCapture(),this._publishWUXEvent("PrimaryPointerUp",e,!1),this._leftButtonPressed=!1,this.isCurrentViewpoint()){if(this._state===p.State.STOP)return this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),void this.resetLeftClick();this._state===p.State.FORCE_PAN||this._state===p.State.FORCE_ROTATE||this._state===p.State.FORCE_ZOOM?this._changeState(p.State.NONE):this._mode===p.Mode.SIMPLE?this._changeState(p.State.NONE):this._2DMode&&this._mode===p.Mode.COMBINED?this._changeState(p.State.NONE):this._state===p.State.HOLD?this._changeState(p.State.NONE):this._state===p.State.ROTATE&&(this._mode===p.Mode.CATIA||this._mode===p.Mode.COMBINED&&this._middleButtonPressed?this._rightButtonPressed||this._changeState(p.State.ZOOM):(this._mode===p.Mode.LOOKAROUND?this.mouseInertia&&!this.lockMouseRotationForSimpleMode&&this._finalizeTurnHeadLockWorldUpVector&&this._finalizeTurnHeadLockWorldUpVector(t,!1):this.mouseInertia&&!this.lockMouseRotationForSimpleMode&&this.lockZ&&this._finalizeRotateLockWorldUpVector&&this._finalizeRotateLockWorldUpVector(t,!1),this._changeState(p.State.NONE))),this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),this.resetLeftClick(),this._mouseDownPos=null,this.tagEventIfModeNotNONE(e)}else this.resetLeftClick()}}},p.prototype._onMiddleMouseUp=function(e){if(this.handleRecordData(e))return this._middleButtonPressed=!1,void(this._middleClicking=!1);if(!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}this._releaseCapture();var r=t.isInView(this.manipulatedViewList);if(this._middleButtonPressed=!1,this.isCurrentViewpoint()){if(t.currentTime-t.startTime>300&&(this._middleClicking=!1),this._state===p.State.STOP)return r&&this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB&&this.viewer.centerMouseUpCB(t,this),void(this._middleClicking=!1);this._changeState(p.State.NONE),r&&this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB&&this.viewer.centerMouseUpCB(t,this),this._middleClicking=!1,this.tagEventIfModeNotNONE(e)}else this._middleClicking=!1}}},p.prototype._onRightMouseUp=function(e){if(this.handleRecordData(e))return this._rightButtonPressed=!1,void(this._rightClicking=!1);if(!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}if(this._releaseCapture(),this._rightButtonPressed=!1,this.isCurrentViewpoint()){if(this._state===p.State.STOP)return this._pickingCB&&this.viewer&&this.viewer.rightMouseUpCB&&this.viewer.rightMouseUpCB(t,this),void(this._rightClicking=!1);this._mode>0&&this._state===p.State.ZOOM?this._changeState(p.State.NONE):this._state===p.State.HOLD?this._changeState(p.State.NONE):this._state===p.State.ROTATE&&(this._mode===p.Mode.CATIA||this._mode===p.Mode.COMBINED&&this._middleButtonPressed?this._leftButtonPressed||this._changeState(p.State.ZOOM):(this.mouseInertia&&!this.lockMouseRotationForSimpleMode&&this.lockZ&&this._finalizeRotateLockWorldUpVector&&this._finalizeRotateLockWorldUpVector(t,!1),this._changeState(p.State.NONE),this.endRotate())),this._pickingCB&&this.viewer&&this.viewer.rightMouseUpCB&&this.viewer.rightMouseUpCB(t,this),this._rightClicking=!1,this.tagEventIfModeNotNONE(e)}else this._rightClicking=!1}}},p.prototype._onMouseMove=function(e){if(!this.handleRecordData(e)&&!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t&&(this._state===p.State.STOP||this._state===p.State.NONE||t.event._simul||0!==t.event.buttons||this._changeState(p.State.NONE),this._publishWUXEvent("PrimaryPointerMove",e,!0),this.isCurrentViewpoint())){if(this._state!==p.State.STOP&&this._state!==p.State.HOLD){for(var i=t.getCurrentPosition(this.domElement),r=t.getLastPosition(this.domElement),n=0;n<e.from.length;n++){var a=e.from[n];if(a.getButton&&a.getButton()!==l.MouseButton.NONE){i=a.getCurrentPosition(this.domElement),r=a.getLastPosition(this.domElement);break}}if(!u.isReplaying())if(this.lockPan||this._state!==p.State.PAN&&this._state!==p.State.FORCE_PAN)if(this.lockRotation||this.lockMouseRotation||this._state!==p.State.ROTATE&&this._state!==p.State.FORCE_ROTATE){if(!this.lockZoom&&(this._state===p.State.ZOOM||this._state===p.State.FORCE_ZOOM)){var s={gesture:e.gesture,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:s,context:this}),s.defaultBehavior)if(this._mode===p.Mode.LOOKAROUND){var o=this._getZoomFOVOnCursorFactorForOnePointer(i,r);this._zoomFOVOnCursor(null,o<0,180*o/Math.PI)}else this._zoom(i,r)}}else{var c={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Rotate",data:c,context:this}),c.defaultBehavior&&(this._mode===p.Mode.LOOKAROUND?this._turnHeadLockWorldUpVector(i.x-r.x,i.y-r.y,t):this.lockZ?this._rotateLockWorldUpVector(i.x-r.x,i.y-r.y):this._rotate(i,r))}else{var h={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Pan",data:h,context:this}),h.defaultBehavior&&this._pan(i,r)}this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB&&this.viewer.mouseMoveCB(t,this),this.tagEventIfModeNotNONE(e)}else this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB&&this.viewer.mouseMoveCB(t,this)}}},p.prototype._onMouseOut=function(e){if(!this.handleRecordData(e)&&!this.lockMouse&&(this._leftButtonPressed=!1,this._rightButtonPressed=!1,this._middleButtonPressed=!1,this.isCurrentViewpoint())){var t=e.from&&e.from.length?e.from[0]:null;if(t){var i=t.getJSEvent(),r=i.target;if(r||(r=i.srcElement),r!==this.viewer.canvas)return;for(var n=i.toElement;n;){if(n===this.viewer.divCssElement)return;n=n.parentNode}}this._state!==p.State.STOP&&this._changeState(p.State.NONE),this.tagEventIfModeNotNONE(e)}},p.prototype._onSwipe=function(e){if(!this.handleRecordData(e)){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t&&(this._publishWUXEvent("PrimaryPointerMove",e,!0),this.isCurrentViewpoint()&&(this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB&&this.viewer.mouseMoveCB(t,this),this._state!==p.State.STOP&&this._state!==p.State.HOLD))){var i=t.currentPosition,r=t.lastPosition;if(this.lockPan||this._state!==p.State.FORCE_PAN)if(this.lockRotation||this.lockTouchRotation||this._state!==p.State.ROTATE&&this._state!==p.State.FORCE_ROTATE){if(!this.lockZoom&&this._state===p.State.FORCE_ZOOM){var n={gesture:e.gesture,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:n,context:this}),n.defaultBehavior)if(this._mode===p.Mode.LOOKAROUND){var a=this._getZoomFOVOnCursorFactorForOnePointer(i,r);this._zoomFOVOnCursor(null,a<0,180*a/Math.PI)}else this._zoom(i,r)}}else{var s={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Rotate",data:s,context:this}),s.defaultBehavior&&(this._mode===p.Mode.LOOKAROUND?this._turnHeadLockWorldUpVector(i.x-r.x,i.y-r.y,t):this.rollingForTouchAvailable&&this.lockZ||!this.rollingForTouchAvailable?this._rotateLockWorldUpVector(i.x-r.x,i.y-r.y):this._rotate(i,r))}else{var o={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Pan",data:o,context:this}),o.defaultBehavior&&this._pan(i,r)}this.tagEventIfModeNotNONE(e)}}},p.prototype._onTap=function(e){if(!this.handleRecordData(e)){var t=e.from&&e.from.length?e.from[0]:null;null!==t&&this.isCurrentViewpoint()&&(this.startLeftClick(),this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),this.resetLeftClick(),this.tagEventIfModeNotNONE(e))}},p.prototype._onDoubleTap=function(e){if(!this.handleRecordData(e)){var t=e.from&&e.from.length?e.from[0]:null;null!==t&&this.isCurrentViewpoint()&&(this._middleClicking=!0,this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB&&this.viewer.centerMouseUpCB(t,this),this._middleClicking=!1,this.tagEventIfModeNotNONE(e))}},p.prototype._onDoublePinchTap=function(e){if(!this.handleRecordData(e)&&!this.lockReframe){var t=e.gesture.getEvents();if(t.length&&this.isCurrentViewpoint()&&this._state!==p.State.STOP){this._stopRotation();var i=this.viewer.getMousePosition(t[0].currentPosition),r=this.viewer.pick(i,"mesh",!1),n=null;if(r.length){var a=r.path[0]._getRenderableOccurrences();a.length&&(n=a[0])}this.viewpoint.reframe(null,void 0,n),this.tagEventIfModeNotNONE(e)}}},p.prototype._onHold=function(e){this.handleRecordData(e)||this.isCurrentViewpoint()&&((2===o.debugEvents||o.debugEvents>=4)&&console.log(data),this.tagEventIfModeNotNONE(e))},p.prototype._onStopManip=function(e){this.handleRecordData(e)||this._blockVptOnHold&&this.isCurrentViewpoint()&&(this._state!==p.State.STOP&&this._state!==p.State.FORCE_PAN&&this._state!==p.State.FORCE_ZOOM&&this._state!==p.State.FORCE_ROTATE&&this._changeState(p.State.HOLD),this.tagEventIfModeNotNONE(e))},p.prototype._onPinchPanRotate=function(e,t){if(!this.handleRecordData(e)){var i=e.gesture;this.isCurrentViewpoint()&&this._state!==p.State.HOLD&&this._state!==p.State.STOP&&"end"!==e.state&&(this._changeState(p.State.ZOOM_PAN_ROTATE),this._zoomPanRotate(i,t),this.tagEventIfModeNotNONE(e))}},p.prototype._onTouch=function(e){this.handleRecordData(e)||(this._publishWUXEvent("PrimaryPointerDown",e,!1),this.isCurrentViewpoint()&&this._state!==p.State.HOLD&&this._state!==p.State.STOP&&(this._forcePan?this._changeState(p.State.FORCE_PAN):this._forceRotate?this._changeState(p.State.FORCE_ROTATE):this._forceZoom?this._changeState(p.State.FORCE_ZOOM):this.lockTouchRotation||this._changeState(p.State.ROTATE),this.tagEventIfModeNotNONE(e)))},p.prototype._onRelease=function(e){if(!this.handleRecordData(e)){var t=e.from&&e.from.length?e.from[0]:null;null!==t&&(this._publishWUXEvent("PrimaryPointerUp",e,!1),this.isCurrentViewpoint()&&(this._state!==p.State.STOP?(this._state!==p.State.ROTATE&&this._state!==p.State.ZOOM_PAN_ROTATE||(this._mode===p.Mode.LOOKAROUND?this._finalizeTurnHeadLockWorldUpVector(t,!0):this.touchInertia&&this._finalizeRotateLockWorldUpVector&&this._finalizeRotateLockWorldUpVector(t,!0)),this._state===p.State.HOLD&&this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),this._changeState(p.State.NONE),this.tagEventIfModeNotNONE(e)):this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this)))}},p.prototype._publishWUXEvent=function(e,t,i){var r={eventChannel:"/VISU/",eventType:"@on"+e,eventID:"",from:t.from};a.publish({event:"/VISU/on"+e,data:r}),(!i&&(2===o.debugEvents||o.debugEvents>=4)||i&&o.debugEvents>=3)&&console.log(r)},p.prototype._createShortHoldSpinner=function(e,t){var i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("id","svgNode"),i.style.position="absolute",i.style.top=0,i.style.left=0,i.style.right=0,i.style.bottom=0,i.style.setProperty("pointer-events","none"),i.style.setProperty("z-index",1e4);var r=document.createElementNS("http://www.w3.org/2000/svg","circle");r.setAttribute("id","svgCircle"),r.setAttribute("fill","none"),r.style.fill="none",r.style.stroke=t,r.style.setProperty("stroke-linecap","square"),e?(this.SVGCircle=r,this.ShortHoldSpinner=i):(this.SVGCircleLarge=r,this.ShortHoldSpinnerLarge=i),i.appendChild(r),this.viewer.div.appendChild(i)},p.prototype._showSpinner=function(e,t,i,r){var a=i-.5*r;e.style.display="block",e.setAttribute("width",2*i+"px"),e.setAttribute("height",2*i+"px"),t.setAttribute("cx",i),t.setAttribute("cy",i),t.setAttribute("r",a),t.setAttribute("transform","rotate(-90, "+i+","+i+")"),t.style.setProperty("stroke-width",r),t.style.setProperty("stroke-dasharray",2*Math.PI*a+1),t.style.setProperty("stroke-dashoffset",2*Math.PI*a+1);var s=!0,l=2*Math.PI*a+1,c=new n({circle:t,setOffset:function(t){t===l?s&&(e.style.display="none",s=!1):(s||(e.style.display="block",s=!0),this.circle.style.setProperty("stroke-dashoffset",t))}},"setOffset",new function(e,t,i,r,n){this._nbLoops=1,this._duration=i,this.duration=function(){return this._duration},this.valueAt=function(i){var a=this._duration,s=i%a/a;if(s>=0&&s<r)return e;if(s<1-n){var o=(s-r)/(1-r-n);return e*(1-o)+t*o}return t}}(l,0,1.2*o.getHoldTime(),.6,0));return c.start(),c},p.prototype._hideSpinner=function(e,t){t&&t.stop(),e.style.display="none"},p.prototype._setPositionSpinner=function(e,t,i){e.style.left=t.x-i+"px",e.style.top=t.y-i+"px"},p.prototype._setCursor=function(t){var i="auto";if("Auto"!==t){var r=e.getWebappsAssetUrl("Visualization","")+"icons/";i="url('"+r+"WebViewer"+t+".png'), url('"+r+"WebViewer"+t+".cur'), auto"}this.viewer.canvas.style.cursor=i},p.prototype.tagEventIfModeNotNONE=function(e){u.isRecording()&&this._state!==p.State.NONE&&e.gesture&&(e.gesture.highLevelRecordJSON||(e.gesture.highLevelRecordJSON={}),e.gesture.highLevelRecordJSON.TrackBallControls={ignore:!0})},p.prototype.handleRecordData=function(e){if(u.isReplaying()&&this.testRecordMoveViewpoint(e))return!0},p.prototype.getRecordData=function(e,t){var i=e.gesture&&e.gesture.highLevelRecordJSON&&e.gesture.highLevelRecordJSON.TrackBallControls;return i&&(!i.name||i.name===this._recordRegisterName)&&i[t]},p.prototype.testRecordMoveViewpoint=function(e){if(this.getRecordData(e,"setViewPoint")){var t=this.getRecordData(e,"setViewPoint");return this.setPositionFromJSON(t),this.viewer.render(),!0}return!1},p.prototype.positionToJSON=function(){return{target:this.target.createJSON(),orientation:this.orientation.createJSON(),distanceToTarget:this.distanceToTarget}},p.prototype.setPositionFromJSON=function(e){this.target.setFromJSON(e.target),this.orientation.setFromJSON(e.orientation),this.distanceToTarget=e.distanceToTarget},p.prototype.setFlyWalkState=function(e){e?(this._flyWalkStateInfo.oldControlState=this._state,this._flyWalkStateInfo.forceStopRequests||this._changeState(p.State.STOP)):this._flyWalkStateInfo.bActive&&this._changeState(this._flyWalkStateInfo.oldControlState),this._flyWalkStateInfo.bActive=!!e},p.prototype.setForceFlyWalkState=function(e){e?(this._flyWalkStateInfo.forceStopRequests++,this._flyWalkStateInfo.bActive&&1===this._flyWalkStateInfo.forceStopRequests&&this._changeState(this._flyWalkStateInfo.oldControlState)):(this._flyWalkStateInfo.forceStopRequests--,this._flyWalkStateInfo.bActive&&!this._flyWalkStateInfo.forceStopRequests&&(this._flyWalkStateInfo.oldControlState=this._state,this._changeState(p.State.STOP)))},p.prototype.isFlyWalkForcedStop=function(){return this._flyWalkStateInfo.forceStopRequests>0},p.prototype.getFlyWalkStateInfo=function(){return this._flyWalkStateInfo},p}),define("Visualization/TrackballControls",["DS/Visualization/TrackballControls","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/TrackballControls"),e}),define("DS/Effects/HighlightMobileNonEffect",["DS/Visualization/ThreeJS_DS","DS/Plugins/RenderPass","DS/Plugins/ClearPass","DS/Visualization/PickingMode"],function(e,t,i,r){"use strict";return class{constructor(e){this.highlightSinglePass=null,this.Canvas2DhighlightSinglePass=null,this.scenes=[],this._scenesToRender=[],this.renderer=e,this.enabled=!0,this._initPasses()}_initPasses(){var r=this.renderer.mainComposer;this.highlightClearPass=new i("highlightClearPass"),r.addPass(this.highlightClearPass),this.highlightSinglePass=new t(null,null,null,void 0,void 0,void 0,"highlightSinglePass"),this.highlightSinglePass.setRenderPluginsPre(!1),this.highlightSinglePass.setRenderPluginsPost(!1),this.highlightSinglePass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.highlightSinglePass.setDisableBackFaceCulling(!0),this.highlightSinglePass.setDisableDepthTest(!0),this.highlightSinglePass.setDisableDepthWrite(!0),this.highlightSinglePass.lockScene=!0,r.addPass(this.highlightSinglePass),this.Canvas2DhighlightClearPass=new i("Canvas2DhighlightClearPass"),r.addPass(this.Canvas2DhighlightClearPass),this.Canvas2DhighlightSinglePass=new t(null,null,null,void 0,void 0,void 0,"Canvas2DhighlightSinglePass"),this.Canvas2DhighlightSinglePass.setRenderPluginsPre(!1),this.Canvas2DhighlightSinglePass.setRenderPluginsPost(!1),this.Canvas2DhighlightSinglePass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.Canvas2DhighlightSinglePass.setDisableBackFaceCulling(!0),this.Canvas2DhighlightSinglePass.setDisableDepthTest(!0),this.Canvas2DhighlightSinglePass.setDisableDepthWrite(!0),this.Canvas2DhighlightSinglePass.idString="canvas2D",this.Canvas2DhighlightSinglePass.lockScene=!0,r.addPass(this.Canvas2DhighlightSinglePass)}setEnabled(e){this.enableb&&e||(this.enabled||e)&&(this.renderer.__enablePassOnAllComposerContexts(this.preHighlightSinglePass,!1),this.renderer.__enablePassOnAllComposerContexts(this.Canvas2DpreHighlightSinglePass,!1),this.renderer.__enablePassOnAllComposerContexts(this.Canvas2DhighlightClearPass,!1),this.renderer.__enablePassOnAllComposerContexts(this.highlightClearPass,!1),this.renderer.compForwardComposerContext&&(this.renderer.compForwardComposerContext.enablePass(this.preHighlightSinglePass,e),this.renderer.compForwardComposerContext.enablePass(this.Canvas2DpreHighlightSinglePass,e),this.renderer.compForwardComposerContext.enablePass(this.Canvas2DhighlightClearPass,e),this.renderer.compForwardComposerContext.enablePass(this.highlightClearPass,e)))}hide(e){if(this.enabled){var t=this.renderer;t.compForwardComposerContext.enablePass(this.highlightSinglePass,!e),t.compForwardComposerContext.enablePass(this.Canvas2DhighlightSinglePass,!e)}}disableOnComposer(e){e.enablePass(this.highlightClearPass,!1),e.enablePass(this.highlightSinglePass,!1),e.enablePass(this.Canvas2DhighlightClearPass,!1),e.enablePass(this.Canvas2DhighlightSinglePass,!1)}_sortScenes(e){this._scenesToRender=[],e.selectionHL.enabled&&this._scenesToRender.push(e.selectionHL.sceneHL);for(var t=0;t<this.scenes.length;t++){var i=this.scenes[t];i.enabled&&this._scenesToRender.push(i.sceneHL)}var r=this._scenesToRender.length;this._scenesToRender.sort(function(e,t){return e.highlightData.priority-t.highlightData.priority});var n=this;this.highlightSinglePass.setMultiRenderCB(function(e,t){return t<n._scenesToRender.length&&(e.scene=n._scenesToRender[t],!0)}),this.Canvas2DhighlightSinglePass.setMultiRenderCB(function(e,t){return t<n._scenesToRender.length&&(e.scene=n._scenesToRender[t],!0)}),Object.keys(this.highlightSinglePass.stateSortingResults).length>r&&(this.highlightSinglePass.stateSortingResults={}),Object.keys(this.Canvas2DhighlightSinglePass.stateSortingResults).length>r&&(this.Canvas2DhighlightSinglePass.stateSortingResults={})}_setRenderModes(){var e=this.renderer.renderer,[t,i,r]=e.getRenderMode().getMasks();this.highlightSinglePass.renderFaceMode=t,this.highlightSinglePass.renderLineMode=i,this.highlightSinglePass.renderPointMode=r,this.Canvas2DhighlightSinglePass.renderFaceMode=t,this.Canvas2DhighlightSinglePass.renderLineMode=i,this.Canvas2DhighlightSinglePass.renderPointMode=r}_updateScene(t){var i=this.renderer;i.renderer,i.compForwardComposerContext.setPassClear(this.highlightClearPass,!1,new e.Color(0),0),i.compForwardComposerContext.setPassClearDepth(this.highlightClearPass,!0),this.highlightSinglePass.scene=t.selectionHL.sceneHL,i.compForwardComposerContext.setPassClear(this.Canvas2DhighlightClearPass,!1,new e.Color(0),0),i.compForwardComposerContext.setPassClearDepth(this.Canvas2DhighlightClearPass,!0),this.Canvas2DhighlightSinglePass.scene=t.selectionHL.sceneHL}_checkPolite(e){var t=this.renderer.renderer,i=e.selectionHL.sceneHL,r=i.highlightData;if(r._needsDepth&&i.getNbAllWebGLObjects()+i.__objectsAdded.size>0&&t.requestPoliteDepthBuffer(),this.scenes&&!t._politeDBufferNextFrame)for(var n=0;n<this.scenes.length;n++)(r=(i=this.scenes[n].sceneHL).highlightData)._needsDepth&&i.getNbAllWebGLObjects()+i.__objectsAdded.size>0&&t.requestPoliteDepthBuffer()}update(e){this._sortScenes(e),this._setRenderModes(),this._updateScene(e),this._checkPolite(e)}addScene(e){return this.scenes.push(e),!0}removeScene(e){for(var t=e.highlightData,i=0;i<this.scenes.length;i++)if(this.scenes[i].highlightData.isEqual(t))return this.scenes.splice(i,1),!0;return!1}}}),define("DS/Manipulators/ManipulatorManager",["UWA/Class","DS/CoreEvents/Events","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/Visualization/TrackballControls","DS/Manipulators/Manipulator"],function(e,t,i,r,n,a){"use strict";var s=5,o=function(e,t){this._path=null,this._position=null,this._normal=null,this._tangent=null,this._uv=null,this._ray=null,this.__viewer=e,this.__event=t},l=function(e){var t;if(t=new Error,0!==s&&(console.log("[Manipulator] Manipulate method does not define the intersection argument anymore.\nIf you really need the picking result, you have to explicitly call setPickingDuringManipulation(true) on your manipulator.\n"+t.stack),s--),!e._path&&e.__viewer&&e.__event){var i;if(e.__event.gesture)i=e.__event.gesture.getEvents()[0];else i=e.__event.from[0];var r=e.__viewer.getMousePosition(i.getCurrentPosition(e.__viewer.canvas));r.event=i;var n=e.__viewer.pick(r,"mesh",!0);e._path=n.path,e._position=n.position,e._normal=n.normal,e._tangent=n.tangent,e._uv=n.uv,e._ray=n.ray}};Object.defineProperty(o.prototype,"path",{get:function(){return l(this),this._path}}),Object.defineProperty(o.prototype,"position",{get:function(){return l(this),this._position}}),Object.defineProperty(o.prototype,"normal",{get:function(){return l(this),this._normal}}),Object.defineProperty(o.prototype,"tangent",{get:function(){return l(this),this._tangent}}),Object.defineProperty(o.prototype,"uv",{get:function(){return l(this),this._uv}}),Object.defineProperty(o.prototype,"ray",{get:function(){return l(this),this._ray}});var c=e.extend({init:function(e){this.viewer=e,this.enabled=!0,this.preActivation=!0,this.manipulatedManipulators={},this.hoveredManipulator=null,this._attachEvents()},getActivate:function(){return this.enabled},setActivate:function(e){this.enabled=e},setPreActivate:function(e){this.preActivation=e},isInManipulation:function(e,t){for(var i in this.manipulatedManipulators){var r=this.manipulatedManipulators[i],n=r.links[i];if(!e||n&&n.states.manipulateState!==a.State.END)if(!t&&!r.getPickingInManipulation()||t&&!r.getPrePickingDuringManipulation())return!0}return!1},isPreActivationDisabledOnManipulatedManipulators:function(){for(var e in this.manipulatedManipulators){var t=this.manipulatedManipulators[e],i=t.links[e];if(i&&i.states.manipulateState!==a.State.END&&!t.getPreActivationDuringManipulation())return!0}return!1},_attachEvents:function(){var e=this;this.onPrimaryPointerEventCB=function(t){e._resetManipulatedManipulators(),t.viewer=e.viewer,e._onEdit.call(e,t,1)},i.addEvent(document,"onPrimaryPointerDownUnique",this.onPrimaryPointerEventCB),this.onLeftClickCB=function(t){t.viewer=e.viewer,e._resetManipulatedManipulators(),e._onLeftClick.call(e,t)},i.addEvent(document,"onPrimaryPointerClick",this.onLeftClickCB),this.onLeftDoubleClickCB=function(t){t.viewer=e.viewer,e._resetManipulatedManipulators(),e._onLeftDoubleClick.call(e,t)},i.addEvent(document,"onPrimaryPointerDoubleClick",this.onLeftDoubleClickCB),this.onEditCB=function(t){t.viewer=e.viewer,e._resetManipulatedManipulators(),e._onEdit.call(e,t,0)},i.addEvent(document,"onEdit",this.onEditCB),this.onSmartEditCB=function(t){t.viewer=e.viewer,e._resetManipulatedManipulators(),e._onEdit.call(e,t,2)},i.addEvent(document,"onSmartEdit",this.onSmartEditCB),this.onMouseMoveCB=function(t){t.viewer=e.viewer,e._onMove.call(e,t,!0)},i.addEvent(document,"onMouseMove",this.onMouseMoveCB),this.onSwipeCB=function(t){t.viewer=e.viewer,e._onMove.call(e,t,!1)},i.addEvent(this.viewer.div,"onSwipe",this.onSwipeCB),this.onLeftMouseUpCB=function(t){t.viewer=e.viewer,e._onRelease.call(e,t)},i.addEvent(document,"onLeftMouseUp",this.onLeftMouseUpCB),this.onReleaseCB=function(t){t.viewer=e.viewer,e._onRelease.call(e,t)},i.addEvent(document,"onRelease",this.onReleaseCB),this.onEditEvent=t.subscribe({event:"/VISU/onEdit"},function(t){t.viewer=e.viewer}),this.onMouseMoveEvent=t.subscribe({event:"/VISU/onMouseMove"},function(t){t.viewer=e.viewer}),this.onSwipeEvent=t.subscribe({event:"/VISU/onSwipe"},function(t){t.viewer=e.viewer}),this.onLeftMouseUpEvent=t.subscribe({event:"/VISU/onLeftMouseUp"},function(t){t.viewer=e.viewer}),this.onReleaseEvent=t.subscribe({event:"/VISU/onRelease"},function(t){t.viewer=e.viewer}),this.onLongHoldCB=function(t){t.viewer=e.viewer,e._onLongHold.call(e,t)},i.addEvent(document,"onLongHold",this.onLongHoldCB)},_detachEvents:function(){i.removeEvent(document,"onPrimaryPointerDownUnique",this.onPrimaryPointerEventCB),i.removeEvent(document,"onPrimaryPointerClick",this.onLeftClickCB),i.removeEvent(document,"onPrimaryPointerDoubleClick",this.onLeftDoubleClickCB),i.removeEvent(document,"onLongHold",this.onLongHoldCB),i.removeEvent(document,"onEdit",this.onEditCB),i.removeEvent(document,"onMouseMove",this.onMouseMoveCB),i.removeEvent(this.viewer.div,"onSwipe",this.onSwipeCB),i.removeEvent(document,"onLeftMouseUp",this.onLeftMouseUpCB),i.removeEvent(document,"onRelease",this.onReleaseCB)},_addToManipulators:function(e,t){this.manipulatedManipulators[t]||(this.manipulatedManipulators[t]=e)},_resetManipulatedManipulators:function(){for(var e in this.manipulatedManipulators){var t=this.manipulatedManipulators[e].links[e];t&&t.states.manipulateState!==a.State.END||delete this.manipulatedManipulators[e]}},_getManipulators:function(e){var t={};if(!e)return t;if(e._manipulators)for(var i in e._manipulators)t[i]=e._manipulators[i];for(var r=e._occurrence;r.parent;)if((r=r.parent)._manipulators)for(var i in r._manipulators){var n=r._manipulators[i];n._isDynamic&&(t[i]=n)}return t},_applyToManipulatorsOverPointer:function(e,t,i,r){if(this.viewer&&this.viewer.canvas){var n,a,s;if(e.gesture)s=e.gesture.getEvents()[0];else s=e.from[0];if((n=this.viewer.getMousePosition(r?s.getStartPosition(this.viewer.canvas):s.getCurrentPosition(this.viewer.canvas))).event=s,null!==this.viewer.currentViewpoint){var o,l=s.isInView([this.viewer.canvas,this.viewer.divCssElement]);if(l&&(a=this.viewer.pick(n,"mesh",!0)),l&&a.path.length){var c=a.path[0]._getRenderableOccurrences(this.viewer);if(1!==c.length)return;var h=c[0],u=!1,d=this._getManipulators(h);for(o in d){var p;(p=d[o]).active&&(u=!0,t.call(this,p,o,a))}if(u)return}if(l)for(o in this.viewer._manipulators)if((p=this.viewer._manipulators[o]).active)return void t.call(this,p,o,a);i&&i.call(this,a)}}},_applyToManipulatedManipulators:function(e,t,i){var r,n,s,o=null;e.gesture?n=e.gesture.getEvents()[0]:n=e.from[0];if((r=this.viewer.getMousePosition(n.getCurrentPosition(this.viewer.canvas))).event=n,null!==this.viewer.currentViewpoint)for(s in this.manipulatedManipulators){var l=this.manipulatedManipulators[s],c=l.links[s];c&&c.states.manipulateState!==a.State.END&&(l.active&&((i||l.getPickingDuringManipulation())&&(o=this.viewer.pick(r,"mesh",!0)),t.call(this,l,s,o)))}},_onLeftClick:function(e){this.enabled&&this._applyToManipulatorsOverPointer(e,function(t,i,r){var n=t.links[i];if(n){var s=n.states.manipulateState;s!==a.State.NONE&&s!==a.State.END||t.PrimaryPointerClick(n.path?n.path:n.node,e,r)}})},_onLeftDoubleClick:function(e){this.enabled&&this._applyToManipulatorsOverPointer(e,function(t,i,r){var n=t.links[i];if(n){var s=n.states.manipulateState;s!==a.State.NONE&&s!==a.State.END||t.PrimaryPointerDoubleClick(n.path?n.path:n.node,e,r)}})},_onEdit:function(e,t){if(this.enabled){var i=!0,r=!1,n=!1,s=!1;this._applyToManipulatorsOverPointer(e,function(o,l,c){var h=null;this.viewer.currentViewpoint&&(h=this.viewer.currentViewpoint.control);var u=!o._selectionAllowed&&1===t&&o.hasPriority,d=!o._selectionAllowed&&!t&&!o.hasPriority,p=o._selectionAllowed&&2===t;if(u||d||p){var f=o.links[l];if(!f)return;var m=f.states.manipulateState;if(m===a.State.NONE||m===a.State.END){if(i)for(var g in i=!1,this.manipulatedManipulators)r=!0;if(r)return;o.BeginManipulate(f.path?f.path:f.node,e,c),f.states.manipulateState=a.State.BEGIN,this._addToManipulators(o,l),s||o.noCursorChange||(this.viewer.setCursor("Grab"),s=!0)}}o._selectionAllowed&&1===t&&h&&h._onStopManip(e),o._selectionAllowed||1!==t||o.hasPriority||!h||n||h._showSpinnerOnHold||(h._onEditEventBegin(e),n=!0)},null,2===t)}},_onMove:function(e,t){this.enabled&&(t&&this.viewer&&this.preActivation&&!this.isPreActivationDisabledOnManipulatedManipulators()&&(!this.viewer.pPicking.disableWhileMoving||this.viewer.pPicking.disableWhileMoving&&this.viewer.currentViewpoint&&!this.viewer.currentViewpoint.isMoving())&&this._applyToManipulatorsOverPointer(e,function(t,i,r){if(t.active){var n=t.links[i];if(!n)return;this.hoveredManipulator?i!==this.hoveredManipulator.token?(this.lastLink=this.hoveredManipulator.manip.links[this.hoveredManipulator.token],this.lastLink&&(this.hoveredManipulator.manip.EndPreactivate(this.lastLink.path?this.lastLink.path:this.lastLink.node,e,r),this.lastLink.states.preActivateState=a.State.END),t.preactivated.path=r.path[0],t.BeginPreactivate(n.path?n.path:n.node,e,r),n.states.preActivateState=a.State.BEGIN,this.hoveredManipulator={token:i,manip:t}):(n.states.preActivateState=a.State.MOVE,t.Preactivate(n.path?n.path:n.node,e,r)):(t.preactivated.path=r.path[0],t.BeginPreactivate(n.path?n.path:n.node,e,r),n.states.preActivateState=a.State.BEGIN,this.hoveredManipulator={token:i,manip:t})}},function(t){this.hoveredManipulator&&(this.lastLink=this.hoveredManipulator.manip.links[this.hoveredManipulator.token],this.lastLink&&(this.hoveredManipulator.manip.EndPreactivate(this.lastLink.path?this.lastLink.path:this.lastLink.node,e,t),this.lastLink.states.preActivateState=a.State.END),this.hoveredManipulator=null)}),this._applyToManipulatedManipulators(e,function(t,i,r){var n=t.links[i];n&&(n.states.manipulateState!==a.State.BEGIN&&n.states.manipulateState!==a.State.MOVE||(r||(r=new o(this.viewer,e)),t.Manipulate(n.path?n.path:n.node,e,r),n.states.manipulateState=a.State.MOVE))},!1))},_onRelease:function(e){this.enabled&&this._applyToManipulatedManipulators(e,function(t,i,r){var n=t.links[i];n&&(n.states.manipulateState!==a.State.BEGIN&&n.states.manipulateState!==a.State.MOVE||(t.EndManipulate(n.path?n.path:n.node,e,r),n.states.manipulateState=a.State.END))},!0)},_onLongHold:function(e){this.enabled&&this._applyToManipulatedManipulators(e,function(t,i){var r=t.links[i];r&&(r.states.manipulateState!==a.State.BEGIN&&r.states.manipulateState!==a.State.MOVE||t.HandleLongHold(r.path?r.path:r.node,e)&&(r.states.manipulateState=a.State.END))},!1)}});return UWA.namespace("THREEDS/ManipulatorManager",c)}),define("Manipulators/ManipulatorManager",["DS/Manipulators/ManipulatorManager","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Manipulators/ManipulatorManager"),e}),define("DS/Shaders/DecodeDepthShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{uniforms:{tDepth:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDepth;","varying vec2 vUv;","void main() {","    gl_FragColor = vec4(0.0,0.0,0.0,0.0);","    gl_FragDepthEXT = unpackRGBA(texture2D(tDepth,vUv));","}"].join("\n")}}),define("DS/Effects/NoPowerOfTwoEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/ResizeShaders"],function(e,t,i,r,n){"use strict";return t.extend({init:function(e,t){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=t,this.passMerge=null,this},setTextures:function(t){var a=t.image.width,s=t.image.height;if(this.width=a,this.height=s,e.ImageUtils.is_pow2(a)||(this.width=e.ImageUtils.nearest_pow2(a)),e.ImageUtils.is_pow2(s)||(this.height=e.ImageUtils.nearest_pow2(s)),this.composers.length)this.composers[0].setSize(this.width,2*this.height);else{var o=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");o.generateMipmaps=!1,this.composers[0]=new i(this.renderer,o,this.renderTargetPool),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.noIdCheck=!0;var l=n.Resize;this.passMerge=new r({defines:l.defines,uniforms:l.uniforms,vertexShader:l.vertexShader,fragmentShader:l.fragmentShader},void 0,"Resize texture"),this.composers[0].addPass(this.passMerge)}this.passMerge.uniforms.tDiffuse.value=t,this.passMerge.material.needsUpdate=!0},copyToDataTexture:function(e,t){this.composers[0].render();var i=this.composers[0].composerContext.getResult(void 0,!0),r=new Uint8Array(4*this.width*this.height);return e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,r),t.mipmaps.length&&(t.mipmaps=[],t.generateMipmaps=!0),t.image.data=r,t.image.height=this.height,t.image.width=this.width,i}})}),define("DS/VisuLoaders/MTLLoader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=function(t,i){e.EventDispatcher.call(this),this.baseUrl=t,this.options=i};return t.prototype={load:function(e){var t=this,i=new XMLHttpRequest;i.addEventListener("load",function(i){if(200===i.target.status||0===i.target.status){var r=t.parse(i.target.responseText);t.dispatchEvent({type:"load",content:r})}else t.dispatchEvent({type:"error",message:"Couldn't load URL ["+e+"]",response:i.target.responseText})},!1),i.addEventListener("progress",function(e){t.dispatchEvent({type:"progress",loaded:e.loaded,total:e.total})},!1),i.addEventListener("error",function(){t.dispatchEvent({type:"error",message:"Couldn't load URL ["+e+"]"})},!1),i.open("GET",e,!0),i.send(null)},parse:function(e){for(var i=e.split("\n"),r={},n=/\s+/,a={},s=0;s<i.length;s++){var o=i[s];if(0!==(o=o.trim()).length&&"#"!==o.charAt(0)){var l=o.indexOf(" "),c=l>=0?o.substring(0,l):o;c=c.toLowerCase();var h=l>=0?o.substring(l+1):"";if(h=h.trim(),"newmtl"===c)r={name:h},a[h]=r;else if(r)if("ka"===c||"kd"===c||"ks"===c){var u=h.split(n,3);r[c]=[parseFloat(u[0]),parseFloat(u[1]),parseFloat(u[2])]}else r[c]=h}}var d=new t.MaterialCreator(this.baseUrl,this.options);return d.setMaterials(a),d}},(t.MaterialCreator=function(t,i){e.EventDispatcher.call(this),this.baseUrl=t,this.options=i,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:e.FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:e.RepeatWrapping}).prototype={setMaterials:function(e){this.materialsInfo=this.convert(e),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(e){if(!this.options)return e;var t={};for(var i in e){var r=e[i],n={};for(var a in t[i]=n,r){var s=!0,o=r[a],l=a.toLowerCase();switch(l){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(o=[o[0]/255,o[1]/255,o[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===o[0]&&0===o[1]&&0===o[1]&&(s=!1);break;case"d":this.options&&this.options.invertTransparency&&(o=1-o)}s&&(n[l]=o)}}return t},preload:function(){for(var e in this.materialsInfo)this.create(e)},getIndex:function(e){return this.nameLookup[e]},getAsArray:function(){var e=0;for(var t in this.materialsInfo)this.materialsArray[e]=this.create(t),this.nameLookup[t]=e,e++;return this.materialsArray},create:function(e){return void 0===this.materials[e]&&this.createMaterial_(e),this.materials[e]},createMaterial_:function(i){var r=this.materialsInfo[i],n={name:i,side:this.side};for(var a in r){var s=r[a];switch(a.toLowerCase()){case"kd":n.diffuse=(new e.Color).setRGB(s[0],s[1],s[2]);break;case"ka":n.ambient=(new e.Color).setRGB(s[0],s[1],s[2]);break;case"ks":n.specular=(new e.Color).setRGB(s[0],s[1],s[2]);break;case"map_kd":n.map=t.loadTexture(this.baseUrl+s),n.map.wrapS=this.wrap,n.map.wrapT=this.wrap;break;case"ns":n.shininess=s;break;case"d":s<1&&(n.transparent=!0,n.opacity=s)}}return n.diffuse&&(n.ambient||(n.ambient=n.diffuse),n.color=n.diffuse),this.materials[i]=new e.MeshPhongMaterial(n),this.materials[i]}},t.loadTexture=function(i,r,n,a){if(/\.dds$/i.test(i))var s=e.ImageUtils.loadCompressedTexture(i,r,n,a);else{var o=new Image,l=(s=new e.Texture(o,r),new e.ImageLoader);l.addEventListener("load",function(e){s.image=t.ensurePowerOfTwo_(e.content),s.needsUpdate=!0,n&&n(s)}),l.addEventListener("error",function(e){a&&a(e.message)}),l.crossOrigin=this.crossOrigin,l.load(i,o)}return s},t.ensurePowerOfTwo_=function(e){if(!t.isPowerOfTwo_(e.width)||!t.isPowerOfTwo_(e.height)){var i=document.createElement("canvas");return i.width=t.nextHighestPowerOfTwo_(e.width),i.height=t.nextHighestPowerOfTwo_(e.height),i.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,i.width,i.height),i}return e},t.isPowerOfTwo_=function(e){return 0==(e&e-1)},t.nextHighestPowerOfTwo_=function(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1},t}),define("DS/Shaders/FlipXShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{uniforms:{tDiffuse:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","    gl_FragColor = texture2D(tDiffuse, vec2(1.0 - vUv.x, vUv.y));","}"].join("\n")}}),define("DS/VisuLoaders/OBJMTLLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/VisuLoaders/MTLLoader","DS/Visualization/ProxyAbstraction"],function(e,t,i,r){"use strict";var n=function(t){e.EventDispatcher.call(this),this.preserveOrder=!(!t||!t.preserveOrder)&&t.preserveOrder};return n.prototype={constructor:e.OBJMTLLoader,load:function(n,a,s){var o=this,l=new r;t.setProxyFromSpec(n,l);var c,h,u,d=n.serverurl?n.serverurl:"";d+=n.filename?n.filename:"";var p=new i(d.substr(0,d.lastIndexOf("/")+1),s);function f(t){if("load"===t.type)t.content instanceof i.MaterialCreator&&(c=!0,(u=t.content).preload());else if("error"===t.type)c=!0;else{var r=t;h=a?o.parse(r):o.parse(r,function(e){c=!1,p.load(p.baseUrl+e)})}c&&h&&(u&&h.traverse(function(t){if(t instanceof e.Mesh&&t.material.name){var i=u.create(t.material.name);i&&(t.material=i)}}),o.dispatchEvent({type:"load",content:h}))}p.addEventListener("load",f),p.addEventListener("error",f),a?(p.load(a),c=!1):c=!0,l.executeGetHttpRequest(d,"text",null,f,function(){o.dispatchEvent({type:"error",message:"Couldn't load URL ["+d+"]"})})},parse:function(t,i){t=t.replace(/\ \\\r\n/g,"");var r=this;function n(t,i,r){return new e.Vector3(t,i,r)}function a(t,i,r,n){return new e.Face3(t,i,r,n)}function s(t,i,r,n,a){return new e.Face4(t,i,r,n,a)}function o(t,i){m.vertices.length>0&&(r.preserveOrder||m.mergeVertices(),m.computeCentroids(),m.computeFaceNormals(),r.preserveOrder&&0===m.faces[0].vertexNormals.length&&m.computeVertexNormals(),m.computeBoundingSphere(),f.add(v),m=new e.Geometry,v=new e.Mesh(m,g),_=0),void 0!==t&&(v.name=t),void 0!==i&&((g=new e.MeshLambertMaterial).name=i,v.material=g)}function l(e){return parseInt(e)-1}function c(e,t,i,n){var s=l(e),o=l(t),c=l(i);r.preserveOrder?m.faces.push(a(s,o,c,n)):(m.vertices.push(S[s],S[o],S[c]),m.faces.push(a(_++,_++,_++,n)))}function h(e,t,i,n,a){var o=l(e),c=l(t),h=l(i),u=l(n);r.preserveOrder?m.faces.push(s(o,c,h,u,a)):(m.vertices.push(S[o],S[c],S[h],S[u]),m.faces.push(s(_++,_++,_++,_++,a)))}for(var u,d,p=new e.Object3D,f=p,m=new e.Geometry,g=new e.MeshLambertMaterial,v=new e.Mesh(m,g),S=r.preserveOrder?m.vertices:[],_=0,y=[],x=[],M=/v( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,P=/vn( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,C=/vt( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,b=/f( +\d+)( +\d+)( +\d+)( +\d+)?/,D=/f( +(\d+)\/(\d+))( +(\d+)\/(\d+))( +(\d+)\/(\d+))( +(\d+)\/(\d+))?/,w=/f( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))?/,E=/f( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))?/,T=t.split("\n"),A=0;A<T.length;A++){var I,R=T[A];if(0!==(R=R.trim()).length&&"#"!==R.charAt(0))if(null!==(I=M.exec(R)))S.push(n(parseFloat(I[1]),parseFloat(I[2]),parseFloat(I[3])));else if(null!==(I=P.exec(R)))y.push(n(parseFloat(I[1]),parseFloat(I[2]),parseFloat(I[3])));else if(null!==(I=C.exec(R)))x.push((u=parseFloat(I[1]),d=parseFloat(I[2]),new e.Vector2(u,d)));else if(null!==(I=b.exec(R)))void 0===I[4]?c(I[1],I[2],I[3]):h(I[1],I[2],I[3],I[4]);else if(null!==(I=D.exec(R)))void 0===I[10]?(c(I[2],I[5],I[8]),m.faceVertexUvs[0].push([x[l(I[3])],x[l(I[6])],x[l(I[9])]])):(h(I[2],I[5],I[8],I[11]),m.faceVertexUvs[0].push([x[l(I[3])],x[l(I[6])],x[l(I[9])],x[l(I[12])]]));else if(null!==(I=w.exec(R)))void 0===I[13]?(c(I[2],I[6],I[10],[y[l(I[4])],y[l(I[8])],y[l(I[12])]]),m.faceVertexUvs[0].push([x[l(I[3])],x[l(I[7])],x[l(I[11])]])):(h(I[2],I[6],I[10],I[14],[y[l(I[4])],y[l(I[8])],y[l(I[12])],y[l(I[16])]]),m.faceVertexUvs[0].push([x[l(I[3])],x[l(I[7])],x[l(I[11])],x[l(I[15])]]));else if(null!==(I=E.exec(R)))void 0===I[10]?c(I[2],I[5],I[8],[y[l(I[3])],y[l(I[6])],y[l(I[9])]]):h(I[2],I[5],I[8],I[11],[y[l(I[3])],y[l(I[6])],y[l(I[9])],y[l(I[12])]]);else if(/^o /.test(R))(f=new e.Object3D).name=R.substring(2).trim(),p.add(f);else if(/^g /.test(R))o(R.substring(2).trim(),void 0);else if(/^usemtl /.test(R))o(void 0,R.substring(7).trim());else if(/^mtllib /.test(R)){if(i){var L=R.substring(7);i(L=L.trim())}}else/^s /.test(R)||console.log("THREE.OBJMTLLoader: Unhandled line "+R)}return o(void 0,void 0),p}},n}),define("DS/Shaders/SkyScatteringShaders",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t,i,r=new e.Vector3(.0058,.0135,.0331),n=new e.Vector3(1.474,1.8504,1.91198),a=new e.Vector2(1/256,1/64),s=new e.Vector4(1/8,1/32,1/128,1/32),o=new e.Vector4(8,32,128,32),l=["float SafeSqrt(float a) {","return sqrt(max(a, 0.0));","}","float ClampDistance(float d) {","return max(d, 0.0);","}","float ClampCosine(float mu) {","return clamp(mu, -1.0, 1.0);","}","float ClampRadius(float r) {","return clamp(r, atmBottom, atmTop);","}","float GetTextureCoordFromUnitRange(float x, float inv_size) {","return 0.5 * inv_size + x * (1.0 - inv_size);","}","float GetUnitRangeFromTextureCoord(float u, float inv_size) {","return (u - 0.5 * inv_size) / (1.0 - inv_size);","}","float DistanceToTopAtmosphereBoundary(float r, float mu) {","float discriminant = r * r * (mu * mu - 1.0) + atmTop * atmTop;","return ClampDistance(-r * mu + SafeSqrt(discriminant));","}","float DistanceToBottomAtmosphereBoundary(float r, float mu) {","float discriminant = r * r * (mu * mu - 1.0) +atmBottom * atmBottom;","return ClampDistance(-r * mu - SafeSqrt(discriminant));","}","float GetLayerDensity(densityProfileLayer layer, float altitude) {","float density = layer.exp_term * exp(layer.exp_scale * altitude) + layer.linear_term * altitude + layer.constant_term;","return clamp(density, 0.0, 1.0);","}","float GetProfileDensity(densityProfile profile, float altitude) {","return altitude < profile.layer0.width ?","GetLayerDensity(profile.layer0, altitude) :","GetLayerDensity(profile.layer1, altitude);","}","bool RayIntersectsGround(float r, float mu) {","return mu < 0.0 && r * r * (mu * mu - 1.0) + atmBottom * atmBottom >= 0.0;","}","vec2 GetTransmittanceTextureUvFromRMu(float r, float mu,vec2 invSize) {","float H = sqrt(atmTop * atmTop - atmBottom * atmBottom);","float rho = SafeSqrt(r * r - atmBottom * atmBottom);","float d = DistanceToTopAtmosphereBoundary( r, mu);","float d_min = atmTop - r;","float d_max = rho + H;","float x_mu = (d - d_min) / (d_max - d_min);","float x_r = rho / H;","return vec2(GetTextureCoordFromUnitRange(x_mu, invSize.x),GetTextureCoordFromUnitRange(x_r, invSize.y));","}","vec3 GetTransmittanceToTopAtmosphereBoundary(sampler2D transmittance_texture,float r, float mu,vec2 invSize) {","vec2 uv = GetTransmittanceTextureUvFromRMu(r, mu,invSize);","return vec3(texture2D(transmittance_texture, uv));","}"].join("\n"),c=["const float PI = 3.14159265358979323846264;","vec4 GetScatteringTextureUvwzFromRMuMuSNu(float r, float mu, float mu_s, float nu,bool ray_r_mu_intersects_ground) {","float H = sqrt(atmTop * atmTop - atmBottom * atmBottom);","float rho = SafeSqrt(r * r - atmBottom * atmBottom);","float u_r = GetTextureCoordFromUnitRange(rho / H, 1.0/scatterSize.w);","float r_mu = r * mu;","float discriminant = r_mu * r_mu - r * r + atmBottom * atmBottom;","float u_mu;","if (ray_r_mu_intersects_ground) {","float d = -r_mu - SafeSqrt(discriminant);","float d_min = r - atmBottom;","float d_max = rho;","u_mu = 0.5 - 0.5 * GetTextureCoordFromUnitRange(d_max == d_min ? 0.0 :(d - d_min) / (d_max - d_min), 2.0/scatterSize.z);","} else {","float d = -r_mu + SafeSqrt(discriminant + H * H);","float d_min = atmTop - r;","float d_max = rho + H;","u_mu = 0.5 + 0.5 * GetTextureCoordFromUnitRange((d - d_min) / (d_max - d_min), 2.0/scatterSize.z);","}","float d = DistanceToTopAtmosphereBoundary(atmBottom, mu_s);","float d_min = atmTop - atmBottom;","float d_max = H;","float a = (d - d_min) / (d_max - d_min);","float mu_s_min=-0.207912;","float A =-2.0 * mu_s_min * atmBottom / (d_max - d_min);","float u_mu_s = GetTextureCoordFromUnitRange(max(1.0 - a / A, 0.0) / (1.0 + a), 1.0/scatterSize.y);","float u_nu = (nu + 1.0) / 2.0;","return vec4(u_nu, u_mu_s,1.0- u_mu, u_r);","}","vec3 GetExtrapolatedSingleMieScattering(vec4 scattering) {","return scattering.rgb * scattering.a / max(scattering.r,0.0001) *","(rayleighScattering.r / rayleighScattering);","}","vec4 texture4D(sampler2D scattering_texture,float r, float mu, float mu_s, float nu){","float h       = sqrt(max(0.0, atmTop * atmTop - atmBottom * atmBottom));","float rho     = sqrt(max(0.0, r * r - atmBottom * atmBottom));","float rmu     = r * mu;","float delta   = rmu * rmu - r * r + atmBottom * atmBottom;","vec4  cst     = rmu < 0.0 && delta > 0.0 ? vec4(1.0, 0.0, 0.0, 0.5 - 0.5 / scatterSize.z) : vec4(-1.0, h*h, h, 0.5 + 0.5 / scatterSize.z);","float uR      = 0.5 / scatterSize.w + rho / h * (1.0 - 1.0 / scatterSize.w);","float uMu     = cst.w + (rmu * cst.x + sqrt(max(0.0, delta + cst.y)) ) / (rho + cst.z) * (0.5 - 1.0 / scatterSize.z);","float uMuS    = 0.5 / scatterSize.y + (atan(max(mu_s, -0.1975) * 5.34962349919) / 1.1 + 0.74) * 0.5 * (1.0 - 1.0 / scatterSize.y);","float uNu     = 0.5 * (nu + 1.0);","vec4 uvwz = vec4(uNu,uMuS,1.0-uMu,uR);","float tex_coord_x = uvwz.x * (scatterSize.x-1.0);","float tex_x = floor(tex_coord_x);","float lerpx = tex_coord_x - tex_x;","float tex_coord_y = uvwz.w * (scatterSize.w-1.0);","float tex_y = floor(tex_coord_y);","float lerpy = tex_coord_y - tex_y;","vec2 uv0 = vec2((tex_x + uvwz.z) / scatterSize.x,((tex_y + uvwz.y) / scatterSize.w));","vec2 uv1 = vec2((tex_x + 1.0 + uvwz.z) / scatterSize.x,((tex_y + uvwz.y) / scatterSize.w));","vec2 uv2 = vec2((tex_x + uvwz.z) / scatterSize.x,((tex_y +1.0 + uvwz.y) / scatterSize.w));","vec2 uv3 = vec2((tex_x + 1.0 + uvwz.z) / scatterSize.x,((tex_y +1.0+ uvwz.y) / scatterSize.w));","vec4 combined_scattering = (texture2D(scattering_texture, uv0) * (1.0 - lerpx) + texture2D(scattering_texture, uv1) * lerpx)*(1.0 -lerpy)","+(texture2D(scattering_texture, uv2) * (1.0 - lerpx) + texture2D(scattering_texture, uv3) * lerpx)*(lerpy);","return combined_scattering;","}","vec4 GetCombinedScattering(sampler2D scattering_texture, float r, float mu, float mu_s, float nu,inout vec3 nightHaze) {","float muHorizon = -sqrt(max(0.0, 1.0 - (atmBottom / r) * (atmBottom /r)));","vec3 surfacePos = vec3(0.0,0.0,atmBottom);","nightHaze = vec3(1.0-abs(mu - muHorizon));","nightHaze = nightHazeColor*pow(abs(nightHaze), vec3(nightHazeSkyPower)) * nightHazeSkyIntensity;","nightHaze *= smoothstep(atmTop-atmBottom, 0.0, viewAltitude);","nightHaze = clamp(nightHaze,0.0,1.0);","return texture4D(scattering_texture,r,mu,mu_s,nu);","}","float RayleighPhaseFunction(float nu) {","float k = 3.0 / (16.0 * PI);"," return k * (1.0 + nu * nu);","}","float MiePhaseFunction(float g, float nu) {","float k = 3.0 / (8.0 * PI);","float a = (1.0 - g * g);","float b = (2.0 + g * g);","float c = 1.0 + g * g;","float d = 2.0 * g * nu;","float e = (1.0 + nu * nu);","return k * e * a * pow(abs(c - d), -1.5) / b;","}","float OpticalDepth(float iH, float iR, float iMu, float iD) {","float a     = sqrt(max(0.0, (0.5/iH)*iR));","vec2  a01   = a*vec2(iMu, iMu+iD/iR);","vec2  a01s  = sign(a01);","vec2  a01sq = a01*a01;","float x     = a01s.y > a01s.x ? exp(a01sq.x) : 0.0; ","vec2  y     = a01s / (2.3193*abs(a01) + sqrt(max(vec2(0.0), 1.52*a01sq + 4.0))) * vec2(1.0, exp(-iD/iH*(iD/(2.0*iR)+iMu)));","return sqrt(max(0.0, (6.2831*iH)*iR)) * exp((atmBottom-iR)/iH) * (x + dot(y, vec2(1.0, -1.0)));","}","vec3 AnalyticTransmittance(float iR, float iMu, float iD) {","return exp(-rayleighScattering * OpticalDepth(g_HR, iR, iMu, iD) - mieScattering * OpticalDepth(g_HM, iR, iMu, iD));","}","bool IntersectAtmosphere(vec3 pos,vec3 dir,inout float distToAtmosphere,inout float distInAtmosphere){","vec3 l = -pos;","float l2 = dot(l,l);","float s = dot(l,dir);","float r2 = atmTop*atmTop;","if (l2<=r2){","float m2 = l2 - (s * s);","float q  = sqrt(max(0.0, r2 - m2));","distInAtmosphere = s + q;","distToAtmosphere = 0.0;","return true;","}else if(s>=0.0){","float m2 = l2 - (s * s);","if(m2 <= r2){","float q = sqrt(max(0.0, r2 - m2));","distToAtmosphere = s - q;","distInAtmosphere = (s + q) - distToAtmosphere;","return true;","}else{","return false;","}","}else{","return false;","}","}","vec4 getScatteringFromWorldParams(sampler2D scattering_texture,vec3 point,vec3 view_ray,vec3 sun_direction,float distance, inout vec3 transmittance,inout vec3 nightHaze){","float r = length(point);","float rmu = dot(point, view_ray);","float mu = rmu / r;","float mu_s = dot(point, sun_direction) / r;","float nu = dot(view_ray, sun_direction);","transmittance = AnalyticTransmittance(r, mu, distance);","vec4 scattering;","scattering = GetCombinedScattering(scattering_texture,r, mu, mu_s, nu,nightHaze);","return scattering;","}","vec3 ApplyMieRayleigh(inout vec4 scattering,float mu_s,float nu){","float SunSize     = 10000.0;","float sunFactor   = 0.001*SunSize;","float g_MieBoost  = 0.0;","float lerpFactor  = (max((1.0-sunFactor), nu)-(1.0-sunFactor))*(1.0/sunFactor);","float theta       = smoothstep(0.0, 2.0, pow(lerpFactor, 8.0));","float sunBoost    = 2.0+g_MieBoost*theta;","float sunScatteringIntensity = 60.0;","scattering.w *= smoothstep(0.0,0.02,mu_s);","vec3 single_mie_scattering = GetExtrapolatedSingleMieScattering(scattering);","vec3 InScattering =max((scattering.xyz * RayleighPhaseFunction(nu) + single_mie_scattering * MiePhaseFunction(miePhaseG, nu) * sunBoost),0.0);","InScattering *= sunScatteringIntensity;","return InScattering*0.6;","}","vec3 GetSkyScattering(sampler2D transmittance_texture,sampler2D scattering_texture,inout vec3 cameraPos, vec3 view_ray,vec3 sun_direction,inout vec3 nightHaze) {","float distance_to_atmosphere = 0.0;","float distance_in_atmosphere = 0.0;","bool goThroughAtmosphere = IntersectAtmosphere(cameraPos,view_ray,distance_to_atmosphere,distance_in_atmosphere);","if(!goThroughAtmosphere){","return vec3(0.0);","}","cameraPos = cameraPos + view_ray * distance_to_atmosphere;","vec3 transmittance;","vec4 scattering = getScatteringFromWorldParams(scattering_texture,cameraPos,view_ray,sun_direction,distance_in_atmosphere,transmittance,nightHaze);","float nu = dot(view_ray, sun_direction);","float mu_s = dot(cameraPos, sun_direction) / length(cameraPos);","return ApplyMieRayleigh(scattering,mu_s,nu);","}","vec3 GetSkyScatteringWithDepth(sampler2D scattering_texture,inout vec3 cameraPos, vec3 view_ray,vec3 sun_direction,vec3 pointPos, inout vec3 attenuation) {","float distance_to_atmosphere = 0.0;","float distance_in_atmosphere = 0.0;","bool goThroughAtmosphere = IntersectAtmosphere(cameraPos,view_ray,distance_to_atmosphere,distance_in_atmosphere);","float distanceToObject = distance(cameraPos, pointPos);","if(!goThroughAtmosphere || distanceToObject<distance_to_atmosphere){","return vec3(0.0);","}","cameraPos = cameraPos + view_ray * distance_to_atmosphere;","distanceToObject -= distance_to_atmosphere;","vec3 nightHaze;","vec4 scattering = getScatteringFromWorldParams(scattering_texture,cameraPos,view_ray,sun_direction,distance_in_atmosphere,attenuation,nightHaze);","float mu_s = dot(cameraPos, sun_direction) / length(cameraPos);","float nu = dot(view_ray, sun_direction);","if(distanceToObject < distance_in_atmosphere){","float heightEndPos = length(pointPos);","float musEndPos    = dot(pointPos, sun_direction) / heightEndPos;","float muEndPos = dot(pointPos, view_ray) / heightEndPos;","vec4 scatteringPoint = getScatteringFromWorldParams(scattering_texture,pointPos,view_ray,sun_direction,distanceToObject,attenuation,nightHaze);","scattering = max(scattering - attenuation.rgbr * scatteringPoint,0.0);","}","return ApplyMieRayleigh(scattering,mu_s,nu);","}","vec4 GetHDREncoded(vec3 color) {","float value = max(color.r, max(color.g, color.b));","int exponent = 0;","float mantissa = 0.0;","if (value > 1.0) {","for (int i = 1; i <= 127; i++) {","value /= 2.0;","exponent++;","if (value < 1.0) { break; }","}","} else if (value < 1.0) {","int j = 1;","for (int i = 1; i <= 129; i++) {","value *= 2.0;","exponent--;","if (value > 1.0) { j = 0; break; }","}","value /= 2.0;","exponent++;","if (j > 0) {","color = vec3(0.0);","exponent = 0;","}","}","return vec4(color * pow(2.0, float(-exponent)), float(exponent + 128) / 255.0);","}","vec3 Irradiance(sampler2D tIrr, float iAlt, float iCosSunZenithAngle) {","float uR    = (iAlt - atmBottom) / (atmTop - atmBottom);","float uMuS  = (iCosSunZenithAngle + 0.2) / (1.0 + 0.2);","return texture2D(tIrr, vec2(uMuS, 1.0-uR)).rgb;","}","vec3 Transmittance(sampler2D tTrans, float iAlt, float iCosRayZenithAngle) {","float uR, uMu;","uR  = sqrt(max(0.0, (iAlt - atmBottom) / (atmTop - atmBottom)));","uMu = atan((iCosRayZenithAngle + 0.15) / (1.0 + 0.15) * tan(1.5)) / 1.5;","return texture2D(tTrans, vec2(uMu, 1.0-uR)).rgb;","}","vec3 GetReflectedLight(sampler2D tIrradiance, sampler2D tTransmittance, vec3 iSurfaceColor, vec3 iSurfacePos, vec3 iCameraPos, vec3 sunDirection, vec3 iAttenuation){","float surfacePosHeight\t= length(iSurfacePos);","float dotSunSphere      = dot(iSurfacePos, sunDirection) / surfacePosHeight;","float musSurfacePos     = clamp(dotSunSphere,0.0,1.0);","vec3 irradianceSurface  = Irradiance(tIrradiance, surfacePosHeight, musSurfacePos);","vec3 attenuationSunLight = Transmittance(tTransmittance, surfacePosHeight, musSurfacePos);","float sunScatteringIntensity = 60.0;","vec3 reflectedLight = iSurfaceColor * (attenuationSunLight + irradianceSurface) * sunScatteringIntensity * (0.1 / PI);","float inSpaceFactor = smoothstep(atmBottom+(atmTop-atmBottom)*0.2, atmTop, surfacePosHeight);","reflectedLight = mix(reflectedLight, iSurfaceColor, inSpaceFactor);","float cameraAlt               = length(iCameraPos) - atmBottom;","float planetSunlightFactor    = smoothstep(-0.05,  0.05, dotSunSphere);","float planetSunlightFactorBis = smoothstep(-0.05,  0.2,  dotSunSphere);","float bisFactor               = smoothstep(300.0, 1000.0, cameraAlt);","planetSunlightFactor = (1.0-bisFactor)*planetSunlightFactor + planetSunlightFactorBis*bisFactor;","vec3  fogColor    = nightHazeColor * nightHazeFogIntensity;","float fogDensity  = 0.009;","float fogFactor   = 1.0 - 1.0 / pow(exp(length(iSurfacePos-iCameraPos) * fogDensity), 2.0);","fogFactor *= smoothstep(100.0, 0.0, cameraAlt);","iSurfaceColor = (1.0-fogFactor) * iSurfaceColor + fogFactor * fogColor;","return planetSunlightFactor * reflectedLight + (1.0-planetSunlightFactor) * iSurfaceColor;","}"].join("\n"),h=["struct densityProfileLayer {","float width;","float exp_term;","float exp_scale;","float linear_term;","float constant_term;","};","struct densityProfile {","densityProfileLayer layer0;","densityProfileLayer layer1;","};","densityProfile rayleighDensity;","densityProfile mieDensity;"].join("\n"),u=["densityProfileLayer flR;","flR.width=0.0;","flR.exp_term=0.0;","flR.exp_scale=0.0;","flR.linear_term=0.0;","flR.constant_term=0.0;","densityProfileLayer slR;","slR.width=0.0;","slR.exp_term=1.0;","slR.exp_scale=-0.000125;","slR.linear_term=0.0;","slR.constant_term=0.0;","rayleighDensity.layer0 = flR;","rayleighDensity.layer1 = slR;","densityProfileLayer flM;","flM.width=0.0;","flM.exp_term=0.0;","flM.exp_scale=0.0;","flM.linear_term=0.0;","flM.constant_term=0.0;","densityProfileLayer slM;","slM.width=0.0;","slM.exp_term=1.0;","slM.exp_scale=-0.000833333;","slM.linear_term=0.0;","slM.constant_term=0.0;","mieDensity.layer0 = flM;","mieDensity.layer1 = slM;"].join("\n");return{ComputeScattering:(t=["uniform sampler2D tTrans;","uniform vec4 invSize;","uniform vec2 transInvSize;","uniform float atmTop;","uniform float atmBottom;","uniform vec3 rayleighScattering;","uniform float mieScattering;","uniform vec3 solarIrradiance;","uniform float angularRadius;"].join("\n"),i=["void GetRMuMuSNuFromScatteringTextureUvwz(vec4 uvwz, inout float r, inout float mu, inout float mu_s,inout float nu, inout bool ray_r_mu_intersects_ground) {","float H = sqrt(atmTop * atmTop - atmBottom * atmBottom);","float rho =H * GetUnitRangeFromTextureCoord(uvwz.w, invSize.w);","r = sqrt(rho * rho + atmBottom * atmBottom);","if (uvwz.z < 0.5) {","float d_min = r - atmBottom;","float d_max = rho;","float d = d_min + (d_max - d_min) * GetUnitRangeFromTextureCoord(1.0 - 2.0 * uvwz.z, invSize.z * 2.0);","mu = d == 0.0 ? -1.0 : ClampCosine(-(rho * rho + d * d) / (2.0 * r * d));","ray_r_mu_intersects_ground = true;","} else {","float d_min = atmTop - r;","float d_max = rho + H;","float d = d_min + (d_max - d_min) * GetUnitRangeFromTextureCoord(2.0 * uvwz.z - 1.0, invSize.z * 2.0);","mu = d == 0.0 ? 1.0 :ClampCosine((H * H - rho * rho - d * d) / (2.0 * r * d));","ray_r_mu_intersects_ground = false;","}","float x_mu_s =GetUnitRangeFromTextureCoord(uvwz.y, invSize.y);","float d_min = atmTop - atmBottom;","float d_max = H;","float mu_s_min=-0.207912;","float A =-2.0 * mu_s_min * atmBottom / (d_max - d_min);","float a = (A - x_mu_s * A) / (1.0 + x_mu_s * A);","float d = d_min + min(a, A) * (d_max - d_min);","mu_s = d == 0.0 ? 1.0 : ClampCosine((H * H - d * d) / (2.0 * atmBottom * d));","nu = ClampCosine(uvwz.x * 2.0 - 1.0);","}","void GetRMuMuSNuFromScatteringTextureFragCoord(vec2 frag_coord,inout float r,inout float mu,inout float mu_s,inout float nu,inout bool ray_r_mu_intersects_ground) {","frag_coord.x /=(invSize.x*invSize.z);","frag_coord.y /=(invSize.y*invSize.w);","float frag_coord_nu =floor(frag_coord.x *invSize.z);","float frag_coord_mu =mod(frag_coord.x, 1.0/invSize.z);","float frag_coord_r =floor(frag_coord.y *invSize.y);","float frag_coord_mu_s =mod(frag_coord.y, 1.0/invSize.y);","vec4 uvwz =vec4(frag_coord_nu, frag_coord_mu_s, frag_coord_mu, frag_coord_r)*invSize; ","GetRMuMuSNuFromScatteringTextureUvwz( uvwz, r, mu, mu_s, nu, ray_r_mu_intersects_ground);","nu = clamp(nu, mu * mu_s - sqrt((1.0 - mu * mu) * (1.0 - mu_s * mu_s)),"," mu * mu_s + sqrt((1.0 - mu * mu) * (1.0 - mu_s * mu_s)));","}","vec3 GetTransmittance(sampler2D transmittance_texture,float r, float mu, float d, bool ray_r_mu_intersects_ground) {","float r_d = ClampRadius(sqrt(d * d + 2.0 * r * mu * d + r * r));","float mu_d = ClampCosine((r * mu + d) / r_d);","if (ray_r_mu_intersects_ground) {","return min(","GetTransmittanceToTopAtmosphereBoundary(transmittance_texture, r_d, -mu_d,transInvSize) /","GetTransmittanceToTopAtmosphereBoundary(transmittance_texture, r, -mu,transInvSize),","vec3(1.0));","} else {","return min(","GetTransmittanceToTopAtmosphereBoundary(transmittance_texture, r, mu,transInvSize) /","GetTransmittanceToTopAtmosphereBoundary(transmittance_texture, r_d, mu_d,transInvSize),","vec3(1.0));","}","}","vec3 GetTransmittanceToSun(sampler2D transmittance_texture,float r, float mu_s) {","float sin_theta_h = atmBottom / r;","float cos_theta_h = -sqrt(max(1.0 - sin_theta_h * sin_theta_h, 0.0));","return GetTransmittanceToTopAtmosphereBoundary(transmittance_texture, r, mu_s,transInvSize) *","smoothstep(-sin_theta_h * angularRadius,","sin_theta_h * angularRadius,","mu_s - cos_theta_h);","}","void ComputeSingleScatteringIntegrand(sampler2D transmittance_texture,float r, float mu, float mu_s, float nu, float d,bool ray_r_mu_intersects_ground,inout vec3 rayleigh, inout float mie) {","float r_d = ClampRadius(sqrt(d * d + 2.0 * r * mu * d + r * r));","float mu_s_d = ClampCosine((r * mu_s + d * nu) / r_d);","vec3 transmittance =GetTransmittance(transmittance_texture, r, mu, d,ray_r_mu_intersects_ground) *","GetTransmittanceToSun(transmittance_texture, r_d, mu_s_d);","rayleigh = transmittance * GetProfileDensity(rayleighDensity, r_d - atmBottom);","mie = (transmittance * GetProfileDensity(mieDensity, r_d - atmBottom)).x;","}","float DistanceToNearestAtmosphereBoundary(float r, float mu, bool ray_r_mu_intersects_ground) {","if (ray_r_mu_intersects_ground) {","return DistanceToBottomAtmosphereBoundary(r, mu);","} else {","return DistanceToTopAtmosphereBoundary(r, mu);","}","}","void ComputeSingleScattering(sampler2D transmittance_texture,float r, float mu, float mu_s, float nu,bool ray_r_mu_intersects_ground,inout vec3 rayleigh, inout float mie) {","const float SAMPLE_COUNT = 50.0;","float dx =DistanceToNearestAtmosphereBoundary(r, mu,ray_r_mu_intersects_ground) / SAMPLE_COUNT;","vec3 rayleigh_sum = vec3(0.0);","float mie_sum = 0.0;","for (float i = 0.0; i <= SAMPLE_COUNT; ++i) {","float d_i = i * dx;","vec3 rayleigh_i;","float mie_i;","ComputeSingleScatteringIntegrand(transmittance_texture,r, mu, mu_s, nu, d_i, ray_r_mu_intersects_ground, rayleigh_i, mie_i);","float weight_i = (i == 0.0 || i == SAMPLE_COUNT) ? 0.5 : 1.0;","rayleigh_sum += rayleigh_i * weight_i;","mie_sum += mie_i * weight_i;","}","rayleigh = rayleigh_sum * dx * solarIrradiance * rayleighScattering;","mie = (mie_sum * dx * solarIrradiance * mieScattering).x;","}","void ComputeSingleScatteringTexture(sampler2D transmittance_texture,vec2 frag_coord,inout vec3 rayleigh,inout float mie) {","float r;","float mu;","float mu_s;","float nu;","bool ray_r_mu_intersects_ground;","GetRMuMuSNuFromScatteringTextureFragCoord( frag_coord,r, mu, mu_s, nu, ray_r_mu_intersects_ground);","ComputeSingleScattering( transmittance_texture,r, mu, mu_s, nu, ray_r_mu_intersects_ground, rayleigh, mie);","}"].join("\n"),{uniforms:{tTrans:{type:"t",value:null},invSize:{type:"v4",value:s},transInvSize:{type:"v2",value:a},atmTop:{type:"f",value:6470},atmBottom:{type:"f",value:6370},rayleighScattering:{type:"v3",value:r},mieScattering:{type:"f",value:.003996},angularRadius:{type:"f",value:.004675},solarIrradiance:{type:"v3",value:n}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:[t,"varying vec2 vUv;",h,l,i,"void main() {",u,"vec3 rayleigh;","float mie;","ComputeSingleScatteringTexture(tTrans,vUv,rayleigh,mie);","gl_FragColor = vec4(rayleigh,mie);","}"].join("\n")}),ComputeTransmittance:function(){var t=["uniform vec2 invSize;","uniform float atmTop;","uniform float atmBottom;","uniform vec3 rayleighScattering;","uniform float mieScattering;","uniform float mieExtinction;","uniform float absorptionExtinction;"].join("\n"),i=["float ComputeOpticalLengthToTopAtmosphereBoundary( densityProfile profile,float r, float mu) {","const float SAMPLE_COUNT = 500.0;","float dx =DistanceToTopAtmosphereBoundary(r, mu) / SAMPLE_COUNT;","float result = 0.0;","for (float i = 0.0; i <= SAMPLE_COUNT; ++i) {","float d_i = i * dx;","float r_i = sqrt(d_i * d_i + 2.0 * r * mu * d_i + r * r);","float y_i = GetProfileDensity(profile, r_i - atmBottom);","float weight_i = i == 0.0 || i == SAMPLE_COUNT ? 0.5 : 1.0;","result += y_i * weight_i * dx;","}","return result;","}","vec3 ComputeTransmittanceToTopAtmosphereBoundary( float r, float mu) {","return exp(-(","rayleighScattering *","ComputeOpticalLengthToTopAtmosphereBoundary( rayleighDensity, r, mu) +","vec3(mieScattering) *","ComputeOpticalLengthToTopAtmosphereBoundary( mieDensity, r, mu)  ));","}","void GetRMuFromTransmittanceTextureUv(vec2 uv, inout float r,inout float mu) {","float x_mu = GetUnitRangeFromTextureCoord(uv.x, invSize.x);","float x_r = GetUnitRangeFromTextureCoord(uv.y, invSize.y);","float H = sqrt(atmTop * atmTop - atmBottom * atmBottom);","float rho = H * x_r;","r = sqrt(rho * rho + atmBottom * atmBottom);","float d_min = atmTop - r;","float d_max = rho + H;","float d = d_min + x_mu * (d_max - d_min);","mu = d == 0.0 ? 1.0 : (H * H - rho * rho - d * d) / (2.0 * r * d);","mu = ClampCosine(mu);","}","vec3 ComputeTransmittanceToTopAtmosphereBoundaryTexture(in vec2 frag_coord) {","float r;","float mu;","GetRMuFromTransmittanceTextureUv( frag_coord, r, mu);","return ComputeTransmittanceToTopAtmosphereBoundary(r, mu);","}"].join("\n");return{uniforms:{invSize:{type:"v2",value:a},atmTop:{type:"f",value:6470},atmBottom:{type:"f",value:6370},rayleighScattering:{type:"v3",value:r},mieScattering:{type:"f",value:.003996},mieExtinction:{type:"f",value:444e-8},absorptionExtinction:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:[t,"varying vec2 vUv;",h,l,i,"void main() {",u,"vec3 res = ComputeTransmittanceToTopAtmosphereBoundaryTexture(vUv);","gl_FragColor = vec4(res,1.0);","}"].join("\n")}}(),RenderSky:function(){var t=["uniform sampler2D tTrans;","uniform sampler2D tIrr;","uniform sampler2D tScatter;","uniform vec3 sunDirection;","uniform float viewAltitude;","uniform vec4 scatterSize;","uniform vec2 transInvSize;","uniform float atmTop;","uniform float atmBottom;","uniform vec3 rayleighScattering;","uniform float mieScattering;","uniform float miePhaseG;","uniform vec3 nightHazeColor;","uniform float nightHazeSkyPower;","uniform float nightHazeSkyIntensity;","uniform float nightHazeFogIntensity;"].join("\n"),i=[].join("\n");return{uniforms:{tTrans:{type:"t",value:null},tIrr:{type:"t",value:null},tScatter:{type:"t",value:null},scatterSize:{type:"v4",value:o},transInvSize:{type:"v2",value:a},sunDirection:{type:"v3",value:new e.Vector3(-1,-1,1)},viewAltitude:{type:"f",value:1},atmTop:{type:"f",value:6470},atmBottom:{type:"f",value:6370},rayleighScattering:{type:"v3",value:r},mieScattering:{type:"f",value:.003996},miePhaseG:{type:"f",value:.8},nightHazeColor:{type:"v3",value:new e.Vector3(.25,.34,.49)},nightHazeSkyPower:{type:"f",value:.6},nightHazeSkyIntensity:{type:"f",value:.15},nightHazeFogIntensity:{type:"f",value:.15}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:[t,"varying vec2 vUv;",h,"const float g_HR = 0.8*pow(10.0,7.0);","const float g_HM = 0.12*pow(10.0,7.0);","const float g_EpsilonInScatter = 0.004;",l,c,i,"void main() {",u,"vec3 camPos = vec3(0.0,0.0,atmBottom+viewAltitude);","vec3 sunDir = sunDirection;","sunDir = normalize(sunDir);","vec3 view_ray;","float phi = PI * (2.0 * vUv.x - 1.0);","float theta = PI * vUv.y;","view_ray.x = -sin(theta) * sin(phi);","view_ray.y = sin(theta) * cos(phi);","view_ray.z = -cos(theta);","view_ray = normalize(view_ray);","vec3 nightHaze;","vec3 scattering = GetSkyScattering(tTrans,tScatter,camPos,view_ray,sunDir,nightHaze);","vec3  sunColor  = vec3(0.9911, 0.8308, 0.6172);","float sunFactor = smoothstep(0.999956, 0.999957, dot(view_ray, sunDir));","vec3  sun       = sunFactor * sunColor * 60.0;","sun  *= min(sun.x,1.0);","float r = length(camPos);","float rmu = dot(camPos, view_ray);","float mu = rmu / r;","bool intersectGround = RayIntersectsGround(r, mu);","if(intersectGround){","sun  = vec3(0.0,0.0,0.0);","}","vec3 color = scattering+nightHaze+sun;","gl_FragColor = GetHDREncoded(color);","}"].join("\n")}}(),PostProcessScattering:function(){var t=["uniform float near;","uniform vec4 screenToView;","uniform mat4 invView;"].join("\n"),i=["uniform float near;","uniform float far;","uniform sampler2D tDiffuse;","uniform sampler2D tDepth;","uniform sampler2D tTrans;","uniform sampler2D tIrr;","uniform sampler2D tScatter;","uniform vec3 sunDirection;","uniform float viewAltitude;","uniform vec4 scatterSize;","uniform vec2 transInvSize;","uniform float atmTop;","uniform float atmBottom;","uniform vec3 rayleighScattering;","uniform float mieScattering;","uniform float miePhaseG;","uniform vec3 nightHazeColor;","uniform float nightHazeSkyPower;","uniform float nightHazeSkyIntensity;","uniform float nightHazeFogIntensity;","uniform float texturesLoaded;"].join("\n"),n=[].join("\n");return{uniforms:{near:{type:"f",value:null},far:{type:"f",value:null},screenToView:{type:"v4",value:null},invView:{type:"m4",value:null},tDiffuse:{type:"t",value:null},tDepth:{type:"t",value:null},tTrans:{type:"t",value:null},tIrr:{type:"t",value:null},tScatter:{type:"t",value:null},scatterSize:{type:"v4",value:o},transInvSize:{type:"v2",value:a},sunDirection:{type:"v3",value:new e.Vector3(-1,-1,1)},viewAltitude:{type:"f",value:1},atmTop:{type:"f",value:6470},atmBottom:{type:"f",value:6370},rayleighScattering:{type:"v3",value:r},mieScattering:{type:"f",value:.003996},miePhaseG:{type:"f",value:.8},nightHazeColor:{type:"v3",value:new e.Vector3(.25,.34,.49)},nightHazeSkyPower:{type:"f",value:.6},nightHazeSkyIntensity:{type:"f",value:.15},nightHazeFogIntensity:{type:"f",value:.15},texturesLoaded:{type:"f",value:0}},vertexShader:[t,"varying vec2 vUv;","varying vec4 vRay;","void main() {","   vec4 pos = vec4( sign( position.xy ), 0.0, 1.0 );","   vUv = pos.xy * vec2( 0.5 ) + 0.5;","   vRay = invView * vec4(screenToView.xy + vUv*screenToView.zw,-near,0.0);","   gl_Position = pos;","}"].join("\n"),fragmentShader:[i,"varying vec2 vUv;","varying vec4 vRay;",h,"const float g_HR = 0.8*pow(10.0,7.0);","const float g_HM = 0.12*pow(10.0,7.0);","const float g_EpsilonInScatter = 0.004;",l,c,n,"void main() {","vec3 camPos = vec3(0.0,0.0,atmBottom+viewAltitude);","vec3 sunDir = sunDirection;","sunDir = normalize(sunDir);","vec3 viewRay = vRay.xyz;","viewRay = normalize(viewRay);","vec4 color = texture2D(tDiffuse,vUv);","if(texturesLoaded==1.0){","vec4 normalDepth = texture2D( tDepth, vUv );","float zNDC = 2.0*normalDepth.w - 1.0;","float viewZ = zNDC *(2.0*near*far + far - near )/(near+far);","float rayScale = viewZ/near;","vec3 rayToPoint = vRay.xyz * rayScale;","rayToPoint /= 1000000.0;","vec3 position = camPos + rayToPoint;","vec3 attenuation = vec3(1.0);","vec3 nightHaze = vec3(0.0);","vec3 scattering = vec3(0.0);","float r = length(camPos);","float rmu = dot(camPos, viewRay);","float mu = rmu / r;","bool intersectGround = RayIntersectsGround(r, mu);","if(zNDC>-1.0){","scattering = GetSkyScatteringWithDepth(tScatter,camPos,viewRay,sunDir,position,attenuation);","color.xyz = GetReflectedLight(tIrr,tTrans,color.xyz,position,camPos,sunDir,attenuation);","}","color.xyz += scattering;","}","gl_FragColor = color;","}"].join("\n")}}()}}),define("DS/SceneGraphNodes/PolyLineSectionUtils",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t={makeClosedPolyLine:function(t,i,r){var n=new e.Vector3;n.subVectors(i.center,t.planeOrigin);var s,o,l=new e.Vector2(n.dot(t.planeU),n.dot(t.planeV)),c={xmin:l.x-i.radius,ymin:l.y-i.radius,xmax:l.x+i.radius,ymax:l.y+i.radius};for(s=0;s<t.polyLinePoints.length;s++)(o=t.polyLinePoints[s]).x<c.xmin&&(c.xmin=o.x),o.x>c.xmax&&(c.xmax=o.x),o.y<c.ymin&&(c.ymin=o.y),o.y>c.ymax&&(c.ymax=o.y);return new a(c,t,r).buildPolyLine()}};function i(t,i,r,n){var a=new e.Vector2;a.subVectors(i,t);var s=new e.Vector2;return s.subVectors(r,n),function(t,i,r,n){var a=i.y,s=-i.x,o=i.x*t.y-i.y*t.x,l=n.y,c=-n.x,h=n.x*r.y-n.y*r.x,u=a*c-s*l;if(0===u)return null;var d=(s*h-o*c)/u,p=-(a*h-o*l)/u;return new e.Vector2(d,p)}(t,a,r,s)}function r(t,i,r){var n=new e.Vector2;n.subVectors(i,t);var a=new e.Vector2;return a.subVectors(r,t),n.dot(a)>=0}function n(t,i,r){var n=new e.Vector2;n.subVectors(i,t);var a=new e.Vector2;a.subVectors(r,t);var s=n.dot(a),o=n.lengthSq();return s>=0||s<=o}var a=function(t,i,r){this.bounds=t,this.points=[],this.normalExtrapolation=r,this.center=new e.Vector2((this.bounds.xmin+this.bounds.xmax)/2,(this.bounds.ymin+this.bounds.ymax)/2),this.polyLine=i;var n,a=[new e.Vector2(this.bounds.xmin,this.bounds.ymin),new e.Vector2(this.bounds.xmin,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymin)];for(n=0;n<a.length;n++)this.addPoint(a[n],"corner")};return a.prototype.addPointFromLine=function(t,a,s,o,l){var c=t,h=a;o&&(c=a,h=new e.Vector2(a.x+l*(t.y-a.y),a.y-l*(t.x-a.x)));var u,d=!1,p=null,f=[new e.Vector2(this.bounds.xmin,this.bounds.ymin),new e.Vector2(this.bounds.xmin,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymin),new e.Vector2(this.bounds.xmin,this.bounds.ymin)];for(u=0;u<f.length-1&&!d;u++)(p=i(c,h,f[u],f[u+1]))&&r(c,h,p)&&n(f[u],f[u+1],p)&&(this.addPoint(p,s),d=!0)},a.prototype.addPoint=function(t,i){var r,n,a,s=new e.Vector2;s.subVectors(t,this.center),s.normalize();var o={point:t,angle:r=(s.y>=0?-1:1)*Math.acos(s.x),tag:i};for(n=0;n<this.points.length&&!a;n++)this.points[n].angle<r&&(this.points.splice(n,0,o),a=!0);a||this.points.push(o)},a.prototype.buildPolyLine=function(){var t=this.polyLine;this.addPointFromLine(new e.Vector2(t.polyLinePoints[1].x,t.polyLinePoints[1].y),new e.Vector2(t.polyLinePoints[0].x,t.polyLinePoints[0].y),"start",this.normalExtrapolation,-1);var i=t.polyLinePoints.length;this.addPointFromLine(new e.Vector2(t.polyLinePoints[i-2].x,t.polyLinePoints[i-2].y),new e.Vector2(t.polyLinePoints[i-1].x,t.polyLinePoints[i-1].y),"end",this.normalExtrapolation,1);var r,n=-1,a=-1;for(r=0;r<this.points.length&&(n<0||a<0);r++)"start"===this.points[r].tag&&(n=r),"end"===this.points[r].tag&&(a=r);if(n<0||a<0)return null;var s={polyLinePoints:[],planeOrigin:t.planeOrigin,planeU:t.planeU,planeV:t.planeV};s.polyLinePoints.push(this.points[n].point);var o=this.normalExtrapolation?0:1;for(r=o;r<t.polyLinePoints.length-o;r++)s.polyLinePoints.push(new e.Vector2(t.polyLinePoints[r].x,t.polyLinePoints[r].y));s.polyLinePoints.push(this.points[a].point);var l=n<a?n+this.points.length:n;for(r=a+1;r<l;r++)s.polyLinePoints.push(this.points[r%this.points.length].point);return s},UWA.namespace("THREEDS/Nodes/PolyLineSectionUtils",t)}),define("DS/Visualization/ClippingPolyLineData",["DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/PolyLineSectionUtils"],function(e,t){"use strict";function i(e){this.polyLines=null,this.clippingPolygonTexture=null,this.boundingSphere=null,this.hasOpenPolyLine=!1,this.hasTransform=!1,this.lastFrameIndex=-1,this.lastCamera=null,e&&this.setParams(e)}function r(){this.transform=!1,this.planeU=null,this.planeV=null,this.points2d=null,this.closedPoints2d=null,this.isOpen=!1,this.viewPlaneU=null,this.viewPlaneV=null,this.viewPoints2d=null,this.matrix=null}return i.prototype.setParams=function(e){this.polyLines=[],this.clippingPolygonTexture=null,this.boundingSphere=null,this.hasOpenPolyLine=!1,this.lastFrameIndex=-1,this.lastCamera=null,this.hasTransform=e.csiParams&&e.csiParams.transform||!1,e.csiParams?this.setCSI(e.csiParams):this.setSingle(e)},i.prototype.getForOccurrenceOverride=function(e){if(this.hasTransform){var t,r=new i(null,e);for(r.hasOpenPolyLine=this.hasOpenPolyLine,r.polyLines=[],t=0;t<this.polyLines.length;t++)r.polyLines.push(this.polyLines[t].getForOccurrenceOverride(e));return r.hasTransform=this.hasTransform,r}return this},i.prototype.setCSI=function(e){this.polyLinePoints=[];var t,i=[];for(t=0;t<e.vertexCounts.length;t++)i.push(e.vertexCounts[t]);var r,n=0;e.vertices.length;for(t=0;t<e.curveCount;t++)r=this.createPolyLineFromCSI(e,t,n,i[t]),this.polyLines.push(r),n+=i[t]},i.prototype.createPolyLineFromCSI=function(t,i,n,a){var s,o,l=new e.Vector3(t.normals[3*i],t.normals[3*i+1],t.normals[3*i+2]);l.normalize(),s=new e.Vector3(1,0,0),(o=new e.Vector3(0,0,0)).crossVectors(l,s),o.norm<.001&&(s=new e.Vector3(0,1,0),o.crossVectors(l,s)),o.normalize();var c,h,u=[],d=new e.Vector3;for(c=0;c<a;c++)h=3*(n+c),d.x=t.vertices[h],d.y=t.vertices[h+1],d.z=t.vertices[h+2],u.push(new e.Vector2(d.dot(s),d.dot(o)));var p=!1;u[0].distanceTo(u[u.length-1])<1e-9?u.splice(u.length-1,1):(this.hasOpenPolyLine=!0,p=!0);var f=new r;return f.set(s,o,new e.Vector3,u,p,t.transform),f},i.prototype.createTexture=function(){this.clippingPolygonTexture&&(this.clippingPolygonTexture.dispose(),this.clippingPolygonTexture=null);var t,i,r=0;for(t=0;t<this.polyLines.length;t++)r+=(i=this.polyLines[t]).viewPoints2d.length;var n,a,s=new Float32Array(4*r),o=0;for(t=0;t<this.polyLines.length;t++)for(a=(i=this.polyLines[t]).viewPoints2d.length,n=0;n<a;n++)s[o]=i.viewPoints2d[n].x,s[o+1]=i.viewPoints2d[n].y,s[o+2]=0,s[o+3]=1,o+=4;this.clippingPolygonTexture=new e.DataTexture(s,r,1,e.RGBAFormat,e.FloatType,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter),this.clippingPolygonTexture.needsUpdate=!0},i.prototype.setSingle=function(t){var i=t.planeOrigin?t.planeOrigin.clone():new e.Vector3,n=t.planeU.clone();n.normalize();var a=t.planeV.clone();a.normalize();var s=new r;s.set(n,a,i,t.polyLinePoints,!1,!1),this.polyLines.push(s)},i.prototype.getMaxSize=function(){var e,t=0;for(e=0;e<this.polyLines.length;e++){var i=this.polyLines[e].getClosedSize();i>t&&(t=i)}return t},i.prototype.updateCamera=function(t,i){if(t!==this.lastCamera||this.lastFrameIndex!==i||!this.clippingPolygonTexture){var r,n=t.matrixWorldInverse,a=null,s=null,o=null;for(r=0;r<this.polyLines.length;r++)(o=this.polyLines[r]).transform?(o.matrix!==s&&((a=new e.Matrix4).multiplyMatrices(t.matrixWorldInverse,o.matrix),s=o.matrix),o.applyViewMatrix(a)):o.applyViewMatrix(n);this.lastCamera=t,this.lastFrameIndex=i,this.clippingPolygonTexture=null}},i.prototype.getTexture=function(e,t){return this.clippingPolygonTexture||this.createTexture(),this.clippingPolygonTexture},i.prototype.updateBoundingSphere=function(e){var t,i;if(e&&this.hasOpenPolyLine&&(!this.boundingSphere||!e.equals(this.boundingSphere)))for(this.boundingSphere=e.clone(),i=0;i<this.polyLines.length;i++)(t=this.polyLines[i]).isOpen&&(t.applyBoundingSphere(e),this.clippingPolygonTexture=null)},i.prototype.dbgDump=function(){var e,t={count:this.polyLines.length,planeU:[],planeV:[],polyLineSize:[]};for(e=0;e<this.polyLines.length;e++){var i=this.polyLines[e];t.planeU.push(i.planeU),t.planeV.push(i.planeV),t.polyLineSize.push(i.points2d.length)}return t},i.prototype.getCount=function(){return this.polyLines.length},i.merge=function(e,t){var r=null;return e&&t?((r=new i(null,null)).polyLines=e.polyLines.concat(t.polyLines),r.hasOpenPolyLine=e.hasOpenPolyLine||t.hasOpenPolyLine,r.hasTransform=e.hasTransform||t.hasTransform):r=e||t,r},r.prototype.set=function(t,i,r,n,a,s){var o;for(this.transform=!!s,this.planeU=t,this.planeV=i,this.points2d=[],o=0;o<n.length;o++)this.points2d.push(new e.Vector2(n[o].x+t.dot(r),n[o].y+i.dot(r)));this.closedPoints2d=a?null:this.points2d,this.isOpen=a,this.viewPlaneU=new e.Vector3,this.viewPlaneV=new e.Vector3,this.viewPoints2d=[]},r.prototype.getClosedSize=function(){return this.closedPoints2d.length},r.prototype.applyViewMatrix=function(t){this.viewPlaneU.copy(this.planeU),this.viewPlaneV.copy(this.planeV),this.viewPlaneU.applyRotation(t),this.viewPlaneV.applyRotation(t);var i=new e.Vector3;i.applyMatrix4(t),this.viewPoints2d=[];var r,n=new e.Vector2,a=new e.Vector2(i.dot(this.viewPlaneU),i.dot(this.viewPlaneV));for(r=0;r<this.closedPoints2d.length;r++)n=this.closedPoints2d[r],this.viewPoints2d.push(new e.Vector2(a.x+n.x,a.y+n.y))},r.prototype.applyBoundingSphere=function(i){if(this.isOpen){var r=t.makeClosedPolyLine({planeOrigin:new e.Vector3,planeU:this.planeU,planeV:this.planeV,polyLinePoints:this.points2d},i,!1);this.closedPoints2d=r.polyLinePoints}},r.prototype.getForOccurrenceOverride=function(e){if(e){var t=new r;return t.transform=this.transform,t.planeU=this.planeU,t.planeV=this.planeV,t.points2d=this.points2d,t.closedPoints2d=this.closedPoints2d,t.isOpen=this.isOpen,t.viewPlaneU=this.viewPlaneU,t.viewPlaneV=this.viewPlaneV,t.viewPoints2d=this.viewPoints2d,t.matrix=this.matrix||e,t}return this},i}),define("DS/Effects/ComputeSkyScattering",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/SkyScatteringShaders","DS/Plugins/ClearPass"],function(e,t,i,r,n,a,s){"use strict";return i.extend({init:function(t,i){this._parent(t),this.renderer=t,this.rtPool=i,this.transmittanceWidth=256,this.transmittanceHeight=64,this.IrradianceWidth=1024,this.IrradianceHeight=1024,this.envmapWidth=2048,this.envmapHeight=1024,this.atmParams=null,this.loadTextureCallBacks=[],this.skyTransmittanceMap=null,this.skyScatteringMap=null,this.skyIrradianceMap=null,this.allTexturesReady=0,this.passTransmittance=null,this.passScattering=null,this.skyPass=null,this.mixPass=null;var s=new e.WebGLRenderTargetProperties(this.transmittanceWidth,this.transmittanceHeight,"linear");this.composers[0]=new r(this.renderer,s,this.rtPool),this.composers[0].composerContext.keepResult=!0;var o=new e.WebGLRenderTargetProperties(this.IrradianceWidth,this.IrradianceHeight,"linear");this.composers[1]=new r(this.renderer,o,this.rtPool),this.composers[1].composerContext.keepResult=!0;var l=new e.WebGLRenderTargetProperties(this.envmapWidth,this.envmapHeight,"linear");return this.composers[2]=new r(this.renderer,l,this.rtPool),this.composers[2].composerContext.keepResult=!0,this.composers[2].composerContext.beforeRenderCB=function(e){e.writeBuffer.minFilter=1003,e.writeBuffer.magFilter=1003,e.writeBuffer.wrapS=1001,e.writeBuffer.wrapT=1001},this.passTransmittance=new n(a.ComputeTransmittance),this.passTransmittance.material.needsUpdate=!0,this.passTransmittance.renderToScreen=!1,this.passScattering=new n(a.ComputeScattering),this.passScattering.material.needsUpdate=!0,this.passScattering.renderToScreen=!1,this.skyPass=new n(a.RenderSky),this.skyPass.material.needsUpdate=!0,this.skyPass.renderToScreen=!1,this.mixPass=new n(a.PostProcessScattering,void 0,"skyScatteringPass"),this.mixPass.material.needsUpdate=!0,this.mixPass.renderToScreen=!1,this.mixPass.changeRenderTargetProperties=new e.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear"),this.composers[0].addPass(this.passTransmittance),this.composers[1].addPass(this.passScattering),this.composers[2].addPass(this.skyPass),this.composers[0].linkToShaderPassUniform(this.passScattering,this.passScattering.uniforms.tTrans),this.composers[0].linkToShaderPassUniform(this.skyPass,this.skyPass.uniforms.tTrans),this.composers[1].linkToShaderPassUniform(this.skyPass,this.skyPass.uniforms.tScatter),this},initEffect:function(e,t){this.loadTextureCallBacks.push(function(e){e.skyPass.uniforms.tTrans.value=e.skyTransmittanceMap,e.mixPass.uniforms.tTrans.value=e.skyTransmittanceMap,e.skyPass.uniforms.tScatter.value=e.skyScatteringMap,e.mixPass.uniforms.tScatter.value=e.skyScatteringMap,e.skyPass.uniforms.tIrr.value=e.skyIrradianceMap,e.mixPass.uniforms.tIrr.value=e.skyIrradianceMap,e.executeWaiting&&e.execute(!0,e.executeWaiting)}),this.loadTextures(),t.insertComposer(null,this.mixPass)},update:function(t,i,r){var n=r.camera;this.mixPass.uniforms.near.value=n.near,this.mixPass.uniforms.far.value=n.far,this.mixPass.uniforms.invView.value=n.matrixWorld,this.mixPass.uniforms.texturesLoaded.value=this.allTexturesReady;var a=new e.Vector4,s=new e.Frustum;s.setFromMatrix(n.projectionMatrix);var o=n.near*Math.abs(s.planes[0].normal.z)/s.planes[0].normal.x,l=n.near*Math.abs(s.planes[1].normal.z)/s.planes[1].normal.x,c=-n.near*Math.abs(s.planes[2].normal.z)/s.planes[2].normal.y,h=-n.near*Math.abs(s.planes[3].normal.z)/s.planes[3].normal.y;a.x=o,a.y=c,a.z=l-o,a.w=h-c,this.mixPass.uniforms.screenToView.value=a,this.mixPass.uniforms.tDepth.value=this.renderer.dBuffer},setSize:function(e,t){this._parent(e,t)},setGenerationInput:function(e){if(e){if(this.atmParams=e,null!=e.viewAltitude){var t=Math.max(e.viewAltitude,.001);this.skyPass.uniforms.viewAltitude.value=t,this.mixPass.uniforms.viewAltitude.value=t}null!=e.sunDirection&&(this.skyPass.uniforms.sunDirection.value=e.sunDirection,this.mixPass.uniforms.sunDirection.value=e.sunDirection)}},_downloadTexture:function(e,t,i){var r=new Float32Array(t*i*4);this.renderer.context.readPixels(0,0,t,i,this.renderer.context.RGBA,this.renderer.context.FLOAT,r);var n=r,a=document.createElement("canvas");a.width=t,a.height=i;for(var s=a.getContext("2d"),o=s.createImageData(t,i),l=0;l<o.height;l++)for(var c=0;c<o.width;c++)o.data[4*(l*o.width+c)]=Math.round(255*n[4*(l*o.width+c)]),o.data[4*(l*o.width+c)+1]=Math.round(255*n[4*(l*o.width+c)+1]),o.data[4*(l*o.width+c)+2]=Math.round(255*n[4*(l*o.width+c)+2]),o.data[4*(l*o.width+c)+3]=Math.round(255*n[4*(l*o.width+c)+3]);s.putImageData(o,0,0);var h=document.createElement("a");h.download=e+".png",s.canvas.toBlob(function(e){h.href=URL.createObjectURL(e),h.click()})},loadTextures:function(){var i=0,r=this,n=function(){if(3==++i){for(var e=0;e<r.loadTextureCallBacks.length;e++)r.loadTextureCallBacks[e](r);r.allTexturesReady=1,r.loadTextureCallBacks=[]}},a=t.getWebappsAssetUrl("Ambiances","");if(this.skyTransmittanceMap||(this.skyTransmittanceMap=e.ImageUtils.loadCompressedTexture(a+"Sky/SkyTransmittance.dds",null,n,null,!1),this.skyTransmittanceMap.minFilter=e.LinearFilter,this.skyTransmittanceMap.magFilter=e.LinearFilter),this.skyIrradianceMap||(this.skyIrradianceMap=e.ImageUtils.loadCompressedTexture(a+"Sky/SkyIrradiance.dds",null,n,null,!1),this.skyIrradianceMap.minFilter=e.LinearFilter,this.skyIrradianceMap.magFilter=e.LinearFilter),this.skyScatteringMap||(this.skyScatteringMap=e.ImageUtils.loadCompressedTexture(a+"Sky/SkyInscatter.dds",null,n,null,!1),this.skyScatteringMap.minFilter=e.LinearFilter,this.skyScatteringMap.magFilter=e.LinearFilter),this.skyTransmittanceMap.loadEndStatus==e.AssetLoadingStatus.READY&&this.skyIrradianceMap.loadEndStatus==e.AssetLoadingStatus.READY&&this.skyScatteringMap.loadEndStatus==e.AssetLoadingStatus.READY){for(var s=0;s<this.loadTextureCallBacks.length;s++)this.loadTextureCallBacks[s](this);r.allTexturesReady=1,this.loadTextureCallBacks=[]}},execute:function(t,i,r,n,a){var s=function(t){t.renderer.materialToUse=e.MaterialToUse.originalMaterial,t.skyTransmittanceMap?(t.passScattering.uniforms.tTrans.value=t.skyTransmittanceMap,t.skyPass.uniforms.tTrans.value=t.skyTransmittanceMap):(t.composers[0].render(),r&&t._downloadTexture("transmittance",t.transmittanceWidth,t.transmittanceHeight)),t.skyScatteringMap?t.skyPass.uniforms.tScatter.value=t.skyScatteringMap:(t.composers[1].render(),n&&t._downloadTexture("scattering",t.IrradianceWidth,t.IrradianceHeight)),t.skyPass.uniforms.tIrr.value=t.skyIrradianceMap,t.composers[2].render(),a&&t._downloadTexture("envmap",t.envmapWidth,t.envmapHeight);var s=t.composers[2].composerContext.getResult(void 0,!1);i&&i(s)};t?(this.loadTextureCallBacks.push(s),this.loadTextures()):s(this)}})}),define("DS/Shaders/ExtractIBLLightShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),i={map:{type:"t",value:null},size:{type:"v2",value:null}},r=function(r){return{defines:{},uniforms:i,vertexShader:t,fragmentShader:["uniform sampler2D map;","uniform vec2 size;","varying vec2 vUv;",e._DefaultShaderChunk.rgbe_sample_methods,"void main() {",r?"gl_FragColor.xyz = texture2DBilinearFromRGBE(map, vUv, size, vec2(1.0)/size).xyz;":"gl_FragColor.xyz = texture2D(map, vUv).xyz;","gl_FragColor.a = dot(gl_FragColor.xyz, vec3(0.299, 0.587, 0.114));","}"].join("\n")}};return{ExtractIBLIntensityShaderRGBE:r(!0),ExtractIBLIntensityShader:r(!1)}}),define("DS/Visualization/ScissorPolyLineData",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";function t(e){this.type="polyline",this.polyLines=[],this.lastFrameIndex=-1,this.lastCamera=null,this.texture=null,e&&this.polyLines.push(new r(e))}function r(t,r){for(this.nbPolygon=t.nbPolygon,this.nbVertices=t.nbVertices,this.vertices=t.vertices,this.point=t.point,this.dirX=t.dirX,this.dirY=t.dirY,this.matrix=r,this.points3D=[],i=0;i<this.vertices.length;i+=2){var n=this.vertices[i],a=this.vertices[i+1],s=this.dirX,o=this.dirY,l=this.point,c=new e.Vector3(l.x+n*s.x+a*o.x,l.y+n*s.y+a*o.y,l.z+n*s.z+a*o.z);r&&c.applyMatrix4(r),this.points3D.push(c)}}return t.prototype.getNbVertices=function(){var e,t,i,r=[];for(e=0;e<this.polyLines.length;e++)for(i=this.polyLines[e],t=0;t<i.nbVertices.length;t++)r.push(i.nbVertices[t]);return r},t.prototype.getVerticesCount=function(){var e,t,i,r=0;for(e=0;e<this.polyLines.length;e++)for(i=this.polyLines[e],t=0;t<i.nbVertices.length;t++)r+=i.nbVertices[t];return r},t.prototype.getForOccurrenceOverride=function(e){if(e){var i,r,n=new t;for(i=0;i<this.polyLines.length;i++)r=this.polyLines[i].matrix||e,n.polyLines.push(this.polyLines[i].getForOccurrenceOverride(r));return n}return this},t.prototype.updateTexture=function(t,i){if(t!==this.lastCamera||this.lastFrameIndex!==i||!this.texture){this.lastCamera=t,this.frameIndex=i;var r,n=0;for(r=0;r<this.polyLines.length;r++)n+=this.polyLines[r].points3D.length;var a=new Float32Array(4*n),s=new e.Matrix4;new e.Vector3;s.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);var o,l=0;for(r=0;r<this.polyLines.length;r++)(o=this.polyLines[r]).fillBuffer(s,l,a),l+=4*o.points3D.length;var c=new e.DataTexture(a,n,1,e.RGBAFormat,e.FloatType,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter);c.needsUpdate=!0,this.texture&&this.texture.dispose(),this.texture=c}},t.prototype.getNbPolygon=function(){var e,t=0;for(e=0;e<this.polyLines.length;e++)t+=this.polyLines[e].nbPolygon;return t},t.merge=function(e,i){var r=null;return e&&i&&"polyline"===e.type&&"polyline"===i.type?(r=new t(null)).polyLines=e.polyLines.concat(i.polyLines):r=e||i,r},r.prototype.getForOccurrenceOverride=function(e){return e?new r({nbPolygon:this.nbPolygon,nbVertices:this.nbVertices,vertices:this.vertices,point:this.point,dirX:this.dirX,dirY:this.dirY},e):this},r.prototype.fillBuffer=function(t,i,r){var n,a,s=new e.Vector4;for(n=0;n<this.points3D.length;n++)a=this.points3D[n],s.set(a.x,a.y,a.z,1),s.applyMatrix4(t),r[i+4*n]=s.x/s.w,r[i+4*n+1]=s.y/s.w,r[i+4*n+2]=0,r[i+4*n+3]=1},t}),define("DS/Effects/ExtractLightFromIBL",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/ExtractIBLLightShader"],function(e,t,i,r,n){"use strict";var a=function(e,t,i){for(var r=new Float32Array(e*t),n=function(e,i){return e<0||i<0?0:r[e*t+i]},a=0;a<e;a++)for(var s=0;s<t;s++){var o=t*a+s,l=i[4*o+3];r[o]=l+n(a-1,s)+n(a,s-1)-n(a-1,s-1)}this.sum=function(e,t,i,r,a,s,o,l){return n(a,s)+n(e,t)-n(i,r)-n(o,l)}},s=function(e,t,i){if(e.width<2||e.height<2||0==t){if(0==e.width||0==e.height)return;i.push(e)}else{var r=new o,n=new o;e.width>e.height?e.split2V(r,n):e.split2H(r,n),s(r,t-1,i),s(n,t-1,i)}},o=function(){};return o.prototype.set=function(e,t,i,r,n,a){this.yStart=t,this.xStart=e,this.width=i,this.height=r,this.summedATable=n,this.sum=a>-1?a:n.sum(e,t,e+(i-1),t,e+(i-1),t+(r-1),e,t+(r-1))},o.prototype.splitV=function(e){for(var t=1;t<=this.width&&(e.set(this.xStart,this.yStart,t,this.height,this.summedATable,-1),!(2*e.sum>=this.sum));++t);},o.prototype.split2V=function(e,t){this.splitV(e),t.set(this.xStart+(e.width-1),this.yStart,this.width-e.width,this.height,this.summedATable,this.sum-e.sum)},o.prototype.splitH=function(e){for(var t=1;t<=this.height&&(e.set(this.xStart,this.yStart,this.width,t,this.summedATable,-1),!(2*e.sum>=this.sum));++t);},o.prototype.split2H=function(e,t){this.splitH(e),t.set(this.xStart,this.yStart+(e.height-1),this.width,this.height-e.height,this.summedATable,this.sum-e.sum)},o.prototype.getCentroid=function(t,i){var r=new o;this.splitV(r);var n=r.xStart+(r.width-1);this.splitH(r);var a=r.yStart+(r.height-1),s=2*(n/t-.5)*Math.PI,l=-(a/i-1)*Math.PI;return new e.Vector3(Math.cos(l)*Math.sin(s),Math.sin(l)*Math.sin(s),Math.cos(s))},t.extend({init:function(e,t){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=t,this.texture=null,this.passIntensity=null,this},setEnvMap:function(t){this.texture=t;var a=t.composerContext&&t.composerContext.width,s=t.composerContext&&t.composerContext.height;if(t instanceof e.Texture?(a=t.image.width,s=t.image.height):t instanceof e.WebGLRenderTarget&&(a=t.width,s=t.height),this.width=parseInt(a),this.height=parseInt(s),this.composers.length)this.composers[0].setSize(this.width,this.height);else{var o=new e.WebGLRenderTargetProperties(this.width,this.height,"halfLinear");o.generateMipmaps=!1,this.composers[0]=new i(this.renderer,o,this.renderTargetPool),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.noIdCheck=!0;var l=n.ExtractIBLIntensityShader;this.texture instanceof i||this.texture.rgbHdr||(l=n.ExtractIBLIntensityShaderRGBE),this.passIntensity=new r({uniforms:l.uniforms,vertexShader:l.vertexShader,fragmentShader:l.fragmentShader},void 0,"IBL Intensity"),this.composers[0].addPass(this.passIntensity)}this.texture instanceof e.Texture||this.texture instanceof e.WebGLRenderTarget?this.passIntensity.uniforms.map.value=this.texture:this.texture.linkToShaderPassUniform(this.passIntensity,this.passIntensity.uniforms.map),this.passIntensity.uniforms.size.value=new e.Vector2(this.width,this.height)},execute:function(t){if(t||!this.renderer.supportsFloatTextures()&&!this.renderer.supportsHalfFloatTextures())return(f=new e.DirectionalIBLLight(new e.Color,0)).castShadow=!1,{light:f,dirLight:new e.Vector3(1,1,1)};this.composers[0].render();var i=new Float32Array(4*this.width*this.height);this.gl.readPixels(0,0,this.width,this.height,this.gl.RGBA,this.gl.FLOAT,i);for(var r=0,n=1e20,l=0;l<this.width;l++)for(var c=0;c<this.height;c++){var h=i[4*(this.height*l+c)+3];h>r&&(r=h,l,c),h<n&&(n=h)}if(0===r||1e20===n||(r-n)/r<.025)return(f=new e.DirectionalIBLLight(new e.Color,0)).castShadow=!1,{light:f,dirLight:new e.Vector3(1,1,1)};var u=new a(this.width,this.height,i),d=new o;d.set(0,0,this.width,this.height,u,-1);var p=[];s(d,9,p),p.sort(function(e,t){return e.sum<t.sum?1:-1});var f,m=p[0].getCentroid(this.width,this.height);return(f=new e.DirectionalIBLLight(new e.Color(16777215),1)).shadowMapWidth=2048,f.shadowMapHeight=2048,{light:f,dirLight:m}}})}),define("DS/Visualization/ClippingContext",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/SessionNodesWithSectionProfile","DS/Visualization/ScissorPolyLineData","DS/Visualization/ClippingPolyLineData"],function(e,t,i,r,n){"use strict";var a=0,s=e.extend({init:function(e){this.id=a++,this.planes=e||[],this.planesParams=null,this.cylinder=null,this.excludeFromClippingPlanes=[],this.clippingSettings=null,this.sectionCappingMaterials=null,this.sectionLinesProperties=null,this._scissor=null,this._enableClippingProfile=0,this._clipPolyLine=null,this._uncut=!1,window.sealWebVisuObjects&&Object.seal(this)},setPlanes:function(e,t){var i;if(this.planes=e||[],this._planesParams=null,t)if(1===t.length&&"all"===t[0])this.planes=[];else for(i=this.planes.length-1;i>=0;i--)t.indexOf(this.planes[i])>=0&&this.planes.splice(i,1)},setExcludeFromClippingPlanes:function(e){this.excludeFromClippingPlanes=e||[]},setUncut:function(e){this._uncut=!!e},setFrontAndBackOpacity:function(e,t){this.clippingSettings=null===e||null===t?null:{frontOpacity:e,backOpacity:t}},getFrontOpacity:function(){return this.frontOpacity},getBackOpacity:function(){return this.backOpacity},setSectionCappingMaterial:function(e,t){this.sectionCappingMaterials||(this.sectionCappingMaterials=[],this.sectionCappingMaterials.defaultMaterial=null);var i=t||null;if(i){var r=0,n=-1;for(r=0;-1===n&&r<this.sectionCappingMaterials.length;r++)this.sectionCappingMaterials[r].clippingPlane===i&&(n=r);n>=0?this.sectionCappingMaterials[n].material=e:this.sectionCappingMaterials.push({clippingPlane:i,material:e})}else this.sectionCappingMaterials.defaultMaterial=e},setSectionLinesProperties:function(e){this.sectionLinesProperties=e?{color:void 0===e.color?null:e.color,width:e.width}:null},getSectionCappingMaterial:function(e){if(this.sectionCappingMaterials){if(!e)return this.sectionCappingMaterials.defaultMaterial;var t;for(t=0;t<this.sectionCappingMaterials.length;t++)if(this.sectionCappingMaterials[t].clippingPlane===e)return this.sectionCappingMaterials[t].material}return null},removeSectionCappingMaterial:function(e){if(this.sectionCappingMaterials){var t=e||null,i=0;for(i=0;i<this.sectionCappingMaterials.length;i++)this.sectionCappingMaterials[i].clippingPlane===t&&this.sectionCappingMaterials.splice(i,1);this.sectionCappingMaterials.length||(this.sectionCappingMaterials=null)}},clone:function(){var e,t,i=new s(this.planes);if(i._planesParams=this._planesParams,i.cylinder=this.cylinder,i._scissor=this._scissor,i._clipPolyLine=this._clipPolyLine,i._enableClippingProfile=this._enableClippingProfile,i._uncut=this._uncut,i.excludeFromClippingPlanes=[].concat(this.excludeFromClippingPlanes),this.clippingSettings&&(i.clippingSettings={frontOpacity:this.clippingSettings.frontOpacity,backOpacity:this.clippingSettings.backOpacity}),this.sectionCappingMaterials)for(i.sectionCappingMaterials=[],i.sectionCappingMaterials.defaultMaterial=this.sectionCappingMaterials.defaultMaterial,e=0;e<this.sectionCappingMaterials.length;e++)t=this.sectionCappingMaterials[e],i.sectionCappingMaterials.push({clippingPlane:t.clippingPlane,material:t.material});return i.sectionLinesProperties=this.sectionLinesProperties,i},addPlane:function(e){return this.planes.indexOf(e)<0&&(this.planes.push(e),!0)},removePlane:function(e){var t=this.planes.indexOf(e);return t>=0&&(this.planes.splice(t,1),this._planesParams&&t<=this._planesParams.length-1&&this._planesParams.splice(t,1),!0)},isPointVisible:function(e){var t,i,r=this.clippingSettings&&this.clippingSettings.frontOpacity<.5;for(t=0;t<this.planes.length;t++)if(i=this.planes[t],this.excludeFromClippingPlanes.indexOf(i)<0&&i.distanceToPoint(e)<0)return!!r;return!r},setClippingProfile:function(e){this._clipPolyLine=e?new n(e):null},setEnableClippingProfile:function(e){this._enableClippingProfile="on"===e?1:"off"===e?-1:0},isClippingProfileEnabled:function(){return this._enableClippingProfile>=0},setScissorBox:function(e,t){this._scissor=e?{type:"box",data:new o(t)}:null},setScissorPolyLine:function(e,t){this._scissor=e?new r(t):null},_getScissorPolyLineSize:function(){return this._scissor&&"polyline"===this._scissor.type?this._scissor.getVerticesCount():0},_getScissorNbPolygons:function(){return this._scissor&&"polyline"===this._scissor.type?this._scissor.getNbPolygon():0},setScissorCircle:function(e,t){this._scissor=e?{type:"circle",x:t.x,y:t.y,radius:t.radius}:null},setPlaneParams:function(e,t){var i=this.planes.indexOf(e);i>=0&&(!this._planesParams&&t&&(this._planesParams=[]),this._planesParams&&(this._planesParams[i]=t?new l(t):null))},_mergeWithParent:function(e){if(!e)return this;var t=new s;t._enableClippingProfile=0!==this._enableClippingProfile?this._enableClippingProfile:e._enableClippingProfile,this._uncut||(t._clipPolyLine=n.merge(e._clipPolyLine,this._clipPolyLine)),t.cylinder=this._uncut?null:this.cylinder||e.cylinder,this._uncut||(t._scissor=r.merge(e._scissor,this._scissor));var i,a,o,l,c=[].concat(this.planes);if(!this._uncut)for(i=0;i<e.planes.length;i++)c.indexOf(e.planes[i])<0&&c.push(e.planes[i]);if(t.setPlanes(c,this.excludeFromClippingPlanes),this._planesParams||e._planesParams)for(i=0;i<c.length;i++)a=null,o=c[i],(l=this.planes.indexOf(o))>=0?a=this._getPlaneParams(l):(l=e.planes.indexOf(o))>=0&&(a=this._getPlaneParams(l)),this.setPlaneParams(o,a);t.clippingSettings=this.clippingSettings||e.clippingSettings;var h=null;if(this.sectionCappingMaterials&&e.sectionCappingMaterials){(h=[].concat(this.sectionCappingMaterials||[])).defaultMaterials=this.sectionCappingMaterials.defaultMaterial||e.sectionCappingMaterials.defaultMaterial;var u,d,p=e.sectionCappingMaterials||[];for(i=0;i<p.length;i++){for(d=!1,u=0;u<h.length&&!d;u++)h[u].clippingPlane===p[i].clippingPlane&&(d=!0);d||h.push(p[i])}}else h=this.sectionCappingMaterials||e.sectionCappingMaterials;return t.sectionCappingMaterials=h,t},_getPlaneParams:function(e){return this._planesParams&&this._planesParams[e]||null},_getPlaneParamsFromPlane:function(e){if(this._planesParams){var t=this.planes.indexOf(e);if(t>=0)return this._planesParams[t]||null;console.warn("unknown plane!")}return null},_hasPlaneCapping:function(e){var t=this._getPlaneParamsFromPlane(e);return!t||t.capping},_hasPlaneSectionLine:function(e){var t=this._getPlaneParamsFromPlane(e);return!t||t.sectionLines},_getSectionLinesArray:function(){if(this._planesParams){var e,t=[];for(e=0;e<this.planes.length;e++)!this._planesParams[e]||this._planesParams[e].sectionLines?t.push(!0):t.push(!1);return t}return null},dbgDumpClippingContext:function(){return{planes:this.planes,excludeFromClippingPlanes:this.excludeFromClippingPlanes,clipPolyLine:this._clipPolyLine?this._clipPolyLine.dbgDump():null,enableClippingProfile:this._enableClippingProfile}},setAntiPlanes:function(){this.setExcludeFromClippingPlanes.apply(this,arguments)}});function o(e){this.box=new t.Box3(new t.Vector3(e.box.min.x,e.box.min.y,0),new t.Vector3(e.box.max.x,e.box.max.y,0)),this.clipX=0,this.clipY=0,this.clipWidth=0,this.clipHeight=0,this.frame=-1}function l(e){this.capping=void 0===e.capping||!!e.capping,this.sectionLines=void 0===e.sectionLines||!!e.sectionLines}return o.prototype.projectPoint=function(e,t,i,r,n){var a=i.clone();return e.projectVector(a,t),a.x=.5*r*(a.x+1),a.y=.5*n*(a.y+1),a},o.prototype.updateClipRect=function(e,i,r,n){if(i!==this.frame){this.frame=i;var a=new t.Projector,s=this.projectPoint(a,e,this.box.min,r,n),o=this.projectPoint(a,e,this.box.max,r,n);this.clipX0=Math.round(s.x),this.clipY0=Math.round(o.y),this.clipX1=Math.round(o.x),this.clipY1=Math.round(s.y)}},s}),define("DS/Effects/NativeOnTopEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Plugins/ClearPass","DS/Visualization/RenderMode","DS/Shaders/DecodeDepthShader"],function(e,t,i,r,n,a,s,o){"use strict";return t.extend({init:function(t,i,a){if(this._parent(t),this.v6Renderer=null,this.idString="onTop",e.supportedExtensions.fragDepth){let e=o;this.mixPass=new n(e,void 0,"onTopDepthSetPass"),this.mixPass.disableDepthTest=!1,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0,this.onTopPass=new r(null,null,null,void 0,void 0,void 0,"onTopPass"),this.onTopPass.idString=this.idString}else this.fallBackPass=new r(null,null,null,void 0,void 0,void 0,"fallBackOnTopPass"),this.fallBackPass.idString=this.idString;return this},initEffect:function(e,t){this.v6Renderer=t,this.fallBackPass?(t.mainComposer.addPass(this.fallBackPass),t.compForwardComposerContext.enablePass(this.fallBackPass,!0)):(this.mixPass.needsSwap=!1,t.mainComposer.addPass(this.mixPass),t.__enablePassOnAllComposerContexts(this.mixPass,!1),t.compForwardComposerContext.enablePass(this.mixPass,!0),t.mainComposer.addPass(this.onTopPass),t.__enablePassOnAllComposerContexts(this.onTopPass,!1),t.compForwardComposerContext.enablePass(this.onTopPass,!0))},update:function(e,t,i,r){var n=this.v6Renderer;this.fallBackPass||(t.scene.getNbWebGLObjects(this.idString)?(this.renderer.requestPoliteDepthBuffer(),n.compForwardComposerContext.enablePass(this.mixPass,!0),this.mixPass.material.uniforms.tDepth.value=this.renderer.politeDepthBuffer):n.compForwardComposerContext.enablePass(this.mixPass,!1))},disablePasses:function(e){this.fallBackPass?e.enablePass(this.fallBackPass,!1):(e.enablePass(this.mixPass,!1),e.enablePass(this.onTopPass,!1))},setSize:function(e,t){this._parent(e,t)},setEnabled:function(e){var t=this.v6Renderer;this.fallBackPass?t.compForwardComposerContext.enablePass(this.fallBackPass,e):(t.compForwardComposerContext.enablePass(this.mixPass,e),t.compForwardComposerContext.enablePass(this.onTopPass,e)),e&&this._parent(e)}})}),define("DS/Effects/SpatialOccupationEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ClearPass"],function(e,t,i,r,n){"use strict";return t.extend({init:function(t,a){var s;switch(this._parent(t.renderer.renderer),a.filtering){case"linear":s="uint";break;case"nearest":default:s="uintNearest"}var o=a.name?a.name:"offScreenPass";this.viewer=t,this.renderer=t.renderer.renderer;var l=t.renderer.renderTargetPool;return this.sceneGraph=t.internalSceneGraph,this.viewpoint=t.viewpoints[0],this.width=a.targetWidth?a.targetWidth:t.SCREEN_WIDTH,this.height=a.targetHeight?a.targetHeight:t.SCREEN_HEIGHT,this.renderTarget=new e.WebGLRenderTargetProperties(this.width,this.height,s),this.composers.push(new i(this.renderer,this.renderTarget,l)),this.composers[0].composerContext.keepResult=!1,this.renderPass=new r(null,null,null,void 0,void 0,void 0,o),this.renderPass.idString=o,this.renderPass.setMaterialToUse(e.MaterialToUse.pickingMaterial),this.clearPass=new n("customClearPass"),this.composers[0].addPass(this.clearPass),this.composers[0].addPass(this.renderPass),this.composers[0].composerContext.enablePass(this.renderPass,!0),this.renderPass.setScene(this.sceneGraph.scene),this.composers[0].composerContext.setPassClear(this.clearPass,!0,new e.Color(0),1),this.renderPass.renderFaceMode=this.renderer.renderFaceMode,this.renderPass.renderLineMode=this.renderer.renderLineMode,this.renderPass.renderPointMode=this.renderer.renderPointMode,this.renderPass.renderSurfacicPoints=this.renderer.renderSurfacicPoints,this},renderResult:function(e){this._setSize(this.width,this.height),this.composers[0].updateScene(this.sceneGraph.scene);var t=this.renderer.context,i={main:this.viewpoint._renderedCamera,connectedRobotCamera:this.viewpoint.connectedRobotCamera,robotCameraOrtho:this.viewpoint.robotCameraOrtho},r=this.viewpoint._renderedCamera.pixelCulling;this.viewpoint.setPixelCulling(r*Math.min(this.width/this.viewer.SCREEN_WIDTH,this.height/this.viewer.SCREEN_HEIGHT)),this.composers[0].render(void 0,void 0,i,"main"),this.viewpoint.setPixelCulling(r);var n=new Uint8Array(4*this.width*this.height);if(t.readPixels(0,0,this.width,this.height,t.RGBA,t.UNSIGNED_BYTE,n),e.flipImage){for(var a=this.width,s=this.height,o=new Array,l=0;l<s;l++)for(var c=0;c<a;c++)for(var h=0;h<4;h++)o.push(n[4*a*(s-1-l)+4*c+h]);return{data:o,width:a,height:s}}return{data:n,width:this.width,height:this.height}},_setSize:function(e,t){this._parent(e,t),this.composers[0].setSize(e,t),this.width=e,this.height=t}})}),define("Effects/SpatialOccupationEffect",["DS/Effects/SpatialOccupationEffect","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Effects/SpatialOccupationEffect"),e}),define("DS/Effects/ESMEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/ESMBlurShader","DS/Plugins/ClearPass"],function(e,t,i,r,n,a){"use strict";return t.extend({init:function(e,t){return this._parent(e),this.renderer=e,this.rtPool=t,this.map=null,this.passBlurH=null,this.passBlurV=null,this},setSize:function(e,t){this.width=parseInt(e),this.height=parseInt(t)},setInput:function(t){if(t){if(this.map=t,this.composers[0])this.composers[0].setSize(this.width,this.height),this.passBlurH.uniforms.invSize.value.set(1/this.width,1/this.height),this.passBlurV.uniforms.invSize.value.set(1/this.width,1/this.height);else{var a=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");this.composers[0]=new i(this.renderer,a,this.rtPool),this.composers[0].composerContext.keepResult=!0,this.passBlurH=new r(n.BlurH2),this.passBlurV=new r(n.BlurV);var s={LEVEL:3};this.passBlurH.material.defines=s,this.passBlurV.material.defines=s,this.passBlurH.uniforms.invSize.value.set(1/this.width,1/this.height),this.passBlurV.uniforms.invSize.value.set(1/this.width,1/this.height),this.passBlurH.material.needsUpdate=!0,this.passBlurV.material.needsUpdate=!0,this.passBlurH.renderToScreen=!1,this.passBlurV.renderToScreen=!1,this.composers[0].addPass(this.passBlurH),this.composers[0].addPass(this.passBlurV)}this.passBlurH.uniforms.tDiffuse2.value=this.map}},execute:function(){this.composers[0].render(0,void 0,void 0,"toto")},getResult:function(){return this.composers[0].getRenderResult("toto")}})}),define("DS/Visualization/WebGLViewerEffectSettings",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Effects/ESMEffect"],function(e,t,i){"use strict";var r={AntiAliasing:{static:"NoAA",dynamic:"NoAA",override:"NoAA",contentChecker:!1},Outline:{static:!0,dynamic:!1,override:!0},PixelCulling:{static:4.5,dynamic:4.5,override:4.5},Transparency:{static:"AlphaBlending",dynamic:"AlphaBlending",override:"AlphaBlending"},GroundShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowGroundShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},InterObjectShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowInterObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},TransparentObjectShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowTransparentObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},ShadowQuality:{static:"PCF",dynamic:"PCF",override:"PCF"},ShadowFilter:{static:"Low",dynamic:"Low",override:"Low"},FlakesQuality:{static:"Low",dynamic:"Low",override:"Low"},DefaultMaterialQuality:{static:"Low",dynamic:"Low",override:"Low"},DownsamplingFactor:{static:1,dynamic:1,override:1},GroundReflection:{static:!1,dynamic:!1,override:!1},AllowGroundReflection:{static:!0,dynamic:!0,override:!0},SSAO:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowSSAO:{static:!0,dynamic:!0,override:!0,contentChecker:!1},SSAONbSamples:{static:16,dynamic:16,override:16},Bloom:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowBloom:{static:!0,dynamic:!0,override:!0,contentChecker:!1},DepthOfField:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowDepthOfField:{static:!0,dynamic:!0,override:!0,contentChecker:!1},ZPrePass:{static:!1,dynamic:!1,override:!1,contentChecker:!1},SSR:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowSSR:{static:!0,dynamic:!0,override:!0,contentChecker:!1},SSRefraction:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowSSRefraction:{static:!0,dynamic:!0,override:!0,contentChecker:!1}};class n{constructor(e,t){this.viewer=e,this.settings={AntiAliasing:{static:e.antiAliasing,dynamic:"MSAA"!==e.antiAliasing?e.antiAliasing:"SMAA",override:e.antiAliasing,contentChecker:!1},Outline:{static:!0,dynamic:!1,override:!0},PixelCulling:{static:4.5,dynamic:4.5,override:4.5},Transparency:{static:t.enableOIT?"WeightedAverage":"AlphaBlending",dynamic:t.enableOIT?"WeightedAverage":"AlphaBlending",override:t.enableOIT?"WeightedAverage":"AlphaBlending"},GroundShadows:{static:e.useGroundShadow,dynamic:e.useGroundShadow,override:e.useGroundShadow,contentChecker:!1},AllowGroundShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},InterObjectShadows:{static:e.useShadowMap,dynamic:e.useShadowMap,override:e.useShadowMap,contentChecker:!1},AllowInterObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},TransparentObjectShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowTransparentObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},ShadowQuality:{static:e.shadowQuality,dynamic:e.shadowQuality,override:e.shadowQuality},ShadowFilter:{static:e.shadowFilter,dynamic:e.shadowFilter,override:e.shadowFilter},FlakesQuality:{static:"Ultra",dynamic:"Ultra",override:"Ultra"},DefaultMaterialQuality:{static:"High",dynamic:"High",override:"High"},DownsamplingFactor:{static:1,dynamic:1,override:1},GroundReflection:{static:e.useMirror,dynamic:e.useMirror,override:e.useMirror},AllowGroundReflection:{static:!0,dynamic:!0,override:!0},SSAO:{static:e.useSSAO,dynamic:e.useSSAO,override:e.useSSAO,contentChecker:!1},AllowSSAO:{static:!0,dynamic:!0,override:!0,contentChecker:!1},SSAONbSamples:{static:16,dynamic:16,override:16},Bloom:{static:e.useBloom,dynamic:e.useBloom,override:e.useBloom,contentChecker:!1},AllowBloom:{static:!0,dynamic:!0,override:!0,contentChecker:!1},DepthOfField:{static:e.useDOF,dynamic:e.useDOF,override:e.useDOF,contentChecker:!1},AllowDepthOfField:{static:!0,dynamic:!0,override:!0,contentChecker:!1},ZPrePass:{static:!1,dynamic:!1,override:!1,contentChecker:!1},SSR:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowSSR:{static:!0,dynamic:!0,override:!0,contentChecker:!1},SSRefraction:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowSSRefraction:{static:!0,dynamic:!0,override:!0,contentChecker:!1}},this._lqFallback=!1,this._blackListedEffects=new Set,e.useSSLR&&(this._blackListedEffects.add("SSRefraction"),this._blackListedEffects.add("SSR"))}_checkCompatibility(){this.viewer.renderer.isDeviceCompatibleWithSSR()||(this._blackListedEffects.add("SSRefraction"),this._blackListedEffects.add("SSR")),this.viewer.renderer.isDeviceCompatibleWithOIT()||this._blackListedEffects.add("Transparency"),this.viewer.renderer.isDeviceCompatibleWithSSAO()||this._blackListedEffects.add("SSAO")}updateViewerSettings(e,i){var r=this.viewer;this._setPixelCulling(e),this._setAntiAliasing(i),this._setShadow(e),this._setTransparentShadow(e),this._setShadowFilter(e),this._setShadowQuality(e),this._setGroundShadow(e),this._setOIT(e),this._setFlakesQuality(e),r.renderer.renderer._defaultAppearanceType!==t.DefaultAppearanceMode.__QA_AUTOMATION__&&this._setDefaultMaterialQuality(e),this._enableZPrePass(e),this._setMirror(e),this._setSSAO(e),this._setBloom(e),this._setDOF(e),this._setSSLR(e),this._setSSLRefraction(e),r.renderer.renderer.currentRendererMode=t.RendererMode[e];var n=r.renderer.SSAOEffect,a=r.renderer.SSAOIterativeEffect,s=this,o=function(t){t.setDynamicRadius(r.ssaoParams.dynamicRadius),t.setAdaptativeRadius(r.ssaoParams.adaptativeRadius),t.setRadius(r.ssaoParams.radius),t.setRadiusRange(r.ssaoParams.radiusMin,r.ssaoParams.radiusMax),t.setMinPixelRadius(r.ssaoParams.minPixelRadius),t.setAttenuation(r.ssaoParams.attenuation),t.setContrast(r.ssaoParams.contrast),t.setPower(r.ssaoParams.power),t.setThresholdAngle(r.ssaoParams.thresholdAngle),t.setNbSamples(s.getSSAONbSamples(e))};n&&o(n),a&&o(a)}_isBlackListed(e){return this._blackListedEffects.has(e)}getSetting(e,t){return this._blackListedEffects.has(e)?r[e][t]:this.settings[e][t]}setSetting(e,t,i){this._blackListedEffects.has(e)||(this.settings[e][t]=i)}updateAmbienceBackScale(e){var t=this.viewer;"FSAA"===this.getAntiAliasing(e)?t.ambience.getBackground().setBackplateScale(2):t.ambience.getBackground().setBackplateScale(1),t.ambience.update()}copySettings(e,t){var i=this;Object.entries(this.settings).forEach(r=>{i.settings[r[0]][e]=r[1][t]})}_setFromJson(e,t){var i=this;Object.entries(t).forEach(t=>{i.settings[t[0]]&&(i.settings[t[0]][e]=t[1])})}_updateState(e,i,r){var n=this.viewer,a=this.getSetting(e,i);this.setSetting(e,i,r),a!==this.getSetting(e,i)&&(n.renderer&&n.renderer.recompileAllShaders([t.RendererMode[i]]),n.render())}_updateQM(e,t,i){var r=this.viewer;r[e]&&r[e](i,t)}setShadow(t,i,r){var n=this.viewer.directionalLight;if(null!==n&&(n.LiSPSM=i,n.shadowCascade))for(var a=0;a<n.shadowCascadeArray.length;a++)n.shadowCascadeArray[a].LiSPSM=i;var s=this.getShadow("static"),o=r?[r]:["static","dynamic"];for(a=0;a<o.length;a++){var l=o[a];this._updateState("InterObjectShadows",l,t)}var c=this.getShadow("static");c!==s&&e.publish({event:"/WUX/AFR/CMD/VisuToggleShadow/"+(c?"BEGIN":"END")})}getShadow(e){return e=e||"static",this.getSetting("InterObjectShadows",e)}setAllowShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowShadow",n,e),this._updateState("AllowInterObjectShadows",n,e)}}getAllowShadow(e){return e=e||"static",this.getSetting("AllowInterObjectShadows",e)}_setShadow(e){this.viewer.useShadowMap=this.getShadow(e)&&this.getAllowShadow(e)}setShadowFilter(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetShadowFilter",n,e),this._updateState("ShadowFilter",n,e)}}_setShadowFilter(e){var r=this.viewer;if(this.getShadowFilter(e)!==r.shadowFilter){switch(r.shadowFilter=this.getShadowFilter(e),r.shadowFilter){case"PCF":r.renderer.renderer.shadowMapType=t.PCFShadowMap;break;case"PCFInterpol":r.renderer.renderer.shadowMapType=t.PCFInterpolShadowMap;break;case"PCFPoisson":case"poisson":r.renderer.renderer.shadowMapType=t.PCFPoissonShadowMap;break;case"PCFOptimized":r.renderer.renderer.shadowMapType=t.PCFOptimizedShadowMap;break;case"ESM":r.renderer.renderer.shadowMapType=t.ESMShadowMap,r.renderer.renderer.esmEffect||(r.renderer.renderer.esmEffect=new i(r.renderer.renderer,r.renderer.renderTargetPool));break;default:r.renderer.renderer.shadowMapType=t.BasicShadowMap}r._updateShadowMaps()}}getShadowFilter(e){return e=e||"static",this.getSetting("ShadowFilter",e)}setShadowQuality(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetShadowQuality",n,e),this._updateState("ShadowQuality",n,e)}}_setShadowQuality(e){var i=this.viewer;this.getShadowQuality(e)!==i.shadowQuality&&(i.shadowQuality=this.getShadowQuality(e),"Medium"===i.shadowQuality?i.renderer.renderer.shadowMapQuality=t.MediumQuality:"High"===i.shadowQuality?i.renderer.renderer.shadowMapQuality=t.HighQuality:i.renderer.renderer.shadowMapQuality=t.LowQuality,i._updateShadowMaps())}getShadowQuality(e){return e=e||"static",this.getSetting("ShadowQuality",e)}setGroundShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateState("GroundShadows",n,e)}}getGroundShadow(e){return e=e||"static",this.getSetting("GroundShadows",e)}_setGroundShadow(e){var t=this.getGroundShadow(e)&&this.getAllowGroundShadow(e),i=this.viewer;i.useGroundShadow!==t&&(i.useGroundShadow=t,i.renderer.resetGSSOCache(),i.dirLightGroundShadow.groundMaterial&&(i.useGroundShadow?i.dirLightGroundShadow.groundMaterial.defines.GROUND_SHADOW=1:i.dirLightGroundShadow.groundMaterial.defines.GROUND_SHADOW=0,i.dirLightGroundShadow.groundMaterial.needsUpdate=!0))}setAllowGroundShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowGroundShadow",n,e),this._updateState("AllowGroundShadows",n,e)}}getAllowGroundShadow(e){return e=e||"static",this.getSetting("AllowGroundShadows",e)}setTransparentShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateState("TransparentObjectShadows",n,e)}}getTransparentShadow(e){return e=e||"static",this.getSetting("TransparentObjectShadows",e)}setAllowTransparentShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowTransparentShadow",n,e),this._updateState("AllowTransparentObjectShadows",n,e)}}getAllowTransparentShadow(e){return e=e||"static",this.getSetting("AllowTransparentObjectShadows",e)}_setTransparentShadow(e){var t=this.viewer,i=this.getTransparentShadow(e)&&this.getAllowTransparentShadow(e);t.renderer.renderer.transparentShadowEnabled!==i&&(t._updateShadowMaps(),t.renderer.renderer.transparentShadowEnabled=i)}setOIT(e,t){var i=this.viewer;i.renderer&&!i.renderer.isDeviceCompatibleWithOIT()&&(console.warn("Warning: OIT is not compatible with this device"),e=!1,t=null);for(var r=t?[t]:["static","dynamic"],n=0;n<r.length;n++){var a=r[n],s=e?"WeightedAverage":"AlphaBlending";this._updateQM("_qmSetTransparency",a,s),this._updateState("Transparency",a,s)}}_setOIT(e){var t=this.getOIT(e),i=this.viewer;t&&i.getRenderPriority()?console.warn("Warning: OIT is not compatible with render priority"):i.renderer.renderer.useOIT!==t&&(i.renderer.setEffect("OIT",t),i.renderer.setEffect("OITnoZ",t))}getOIT(e){return e=e||"static","WeightedAverage"===this.getSetting("Transparency",e)}setFlakesQuality(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetFlakesQuality",n,e),this._updateState("FlakesQuality",n,e)}}_setFlakesQuality(e){this.viewer.renderer.renderer.flakesMode={Low:3,Medium:2,High:1,Ultra:0}[this.getFlakesQuality(e)]}getFlakesQuality(e){return e=e||"static",this.getSetting("FlakesQuality",e)}setDownsamplingFactor(e){for(var t=["static","dynamic"],i=0;i<t.length;i++){var r=t[i];this._updateQM("_qmSetDownsamplingFactor",r,e),this.setSetting("DownsamplingFactor",r,e)}}_setDownsamplingFactor(e){this.viewer.renderer.renderer._renderScale=this.getDownsamplingFactor()}getDownsamplingFactor(){return this.getSetting("DownsamplingFactor","static")}setDefaultMaterialQuality(e){for(var t=["static","dynamic"],i=0;i<t.length;i++){var r=t[i];this._updateQM("_qmSetDefaultMaterialQuality",r,e),this._updateState("DefaultMaterialQuality",r,e)}}_setDefaultMaterialQuality(e){var t=this.viewer,i={Low:!0,Medium:!0,High:!1,Ultra:!1}[this.getDefaultMaterialQuality()];t.renderer.renderer.gasAsPhong!=i&&(t.renderer.renderer.gasAsPhong=i,t.renderer.resetGSSOCache())}getDefaultMaterialQuality(){return this.getSetting("DefaultMaterialQuality","static")}enableZPrePass(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmEnableZPrePass",n,e),this.setSetting("ZPrePass",n,e)}}_enableZPrePass(e){this.viewer.renderer._enableZPrePass(this.zPrePassEnabled(e))}zPrePassEnabled(e){return e=e||"static",this.getSetting("ZPrePass",e)}setMirror(t,i,r,n,a){var s=this.viewer;n=void 0!==n?n:.3,a=void 0!==a?a:.85,i=void 0!==i?i:s.blurryMirror,s.renderer&&s.renderer.mirrorBlendPass&&(s.renderer.mirrorBlendPass.uniforms.reflectivity.value=n),s.blurryMirror=i,s.blurryMirror&&s.ambience.setGroundGlossiness(a);for(var o=this.getMirror("static"),l=r?[r]:["static","dynamic"],c=0;c<l.length;c++){var h=l[c];this.setSetting("GroundReflection",h,t)}var u=this.getMirror("static");u!==o&&e.publish({event:"/WUX/AFR/CMD/VisuToggleMirror/"+(u?"BEGIN":"END")})}getMirror(e){return e=e||"static",this.getSetting("GroundReflection",e)}setAllowMirror(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowMirror",n,e),this.setSetting("AllowGroundReflection",n,e)}}getAllowMirror(e){return e=e||"static",this.getSetting("AllowGroundReflection",e)}_setMirror(e){var t=this.getMirror(e)&&this.getAllowMirror(e),i=this.viewer;!i.useHDR&&i.cameraSystem&&(t=!1),i.useMirror!==t&&(i.renderer.resetGSSOCache(),i.useMirror=t)}setPixelCulling(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetPixelCulling",n,e),this.setSetting("PixelCulling",n,e)}}getPixelCulling(e){return e=e||"static",this.getSetting("PixelCulling",e)}_setPixelCulling(e){var t=this.viewer;t.currentViewpoint&&t.currentViewpoint._setPixelCulling(this.getPixelCulling(e))}setBloom(e,t){for(var i=this.viewer,r=t?[t]:["static","dynamic"],n=0;n<r.length;n++){var a=r[n];this.setSetting("Bloom",a,e)}e&&!i.getEffect("Bloom")&&(i.renderer.setEffect("Bloom",!0),i.renderer.setEffect("Bloom",!1))}getBloom(e){return e=e||"static",this.getSetting("Bloom",e)}_setBloom(e){var t=this.viewer,i=this.getBloom(e)&&this.getAllowBloom(e);t.useBloom!==i&&(t.useBloom=i,t.renderer.setEffect("Bloom",t.useBloom))}setAllowBloom(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("qmSetAllowBloom",n,e),this.setSetting("AllowBloom",n,e)}}getAllowBloom(e){return e=e||"static",this.getSetting("AllowBloom",e)}setSSLRefraction(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateState("SSRefraction",n,e)}}getSSLRefraction(e){return e=e||"static",this.getSetting("SSRefraction",e)}setAllowSSLRefraction(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowSSRefraction",n,e),this._updateState("AllowSSRefraction",n,e)}}getAllowSSLRefraction(e){return e=e||"static",this.getSetting("AllowSSRefraction",e)}_setSSLRefraction(e){var t=this.viewer,i=this.getSSLRefraction(e)&&this.getAllowSSLRefraction(e);t.useSSLRefraction!==i&&(t.useSSLRefraction=i,this.getTransparentShadow(e)&&this.getAllowTransparentShadow(e)&&(t._updateShadowMaps(),t.renderer.resetGSSOCache()),t.renderer.setEffect("SSLRefraction",t.useSSLRefraction))}setSSLR(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateState("SSR",n,e)}}getSSLR(e){return e=e||"static",this.getSetting("SSR",e)}setAllowSSLR(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowSSR",n,e),this._updateState("AllowSSR",n,e)}}getAllowSSLR(e){return e=e||"static",this.getSetting("AllowSSR",e)}_setSSLR(e){var t=this.viewer,i=this.getSSLR(e)&&this.getAllowSSLR(e);t.useSSLRDirect!==i&&(t.useSSLRDirect=i,t.renderer.setEffect("SSLRDirect",i),t.renderer.renderer.useSSLR=i)}setDOF(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSetting("DepthOfField",n,e)}var a=this.viewer;e&&!a.getEffect("DOF")&&(a.renderer.setEffect("DOF",!0),a.renderer.setEffect("DOF",!1))}getDOF(e){return e=e||"static",this.getSetting("DepthOfField",e)}setAllowDOF(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowDOF",n,e),this.setSetting("AllowDepthOfField",n,e)}}getAllowDOF(e){return e=e||"static",this.getSetting("AllowDepthOfField",e)}_setDOF(e){var t=this.viewer,i=this.getDOF(e)&&this.getAllowDOF(e);if(t.useDOF!==i&&(t.useDOF=i,t.renderer.setEffect("DOF",t.useDOF)),"static"===e){var r="MSAA"===this.getAntiAliasing(e),n=t.getEffect("DOF");n&&n.setIterative(t.useDOFIterative&&r)}}setSSAONbSamples(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetSSAONbSamples",n,e),this.setSetting("SSAONbSamples",n,e)}}getSSAONbSamples(e){return e=e||"static",this.getSetting("SSAONbSamples",e)}setSSAO(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSetting("SSAO",n,e)}}getSSAO(e){return e=e||"static",this.getSetting("SSAO",e)}setAllowSSAO(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowSSAO",n,e),this.setSetting("AllowSSAO",n,e)}}getAllowSSAO(e){return e=e||"static",this.getSetting("AllowSSAO",e)}_setSSAO(e){var t=this.viewer,i=this.getSSAO(e)&&this.getAllowSSAO(e),r="MSAA"===this.getAntiAliasing(e);t.useSSAO=i;var n=t.useSSAOIterative&&r&&t.renderIteration>0;t.renderer.setEffect("SSAO",t.useSSAO&&!n),t.renderer.setEffect("SSAOIterative",t.useSSAO&&n)}setAntiAliasing(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r],a=null;"SMAA"===e||"MLAA"===e||"FXAA"===e||"FSAA"===e||"MSAA"===e||"SSAA"===e||"TAA"===e?a="dynamic"===n&&"MSAA"===e?"SMAA":e:"NoAA"===e||!1===e?a="NoAA":!0===e?a="SMAA":"MSMAA"===e&&(console.warn("MSMAA is deprecated"),a="dynamic"===n?"SMAA":"MSAA"),a&&(this._updateQM("_qmSetAntiAliasing",n,a),this.setSetting("AntiAliasing",n,a))}}getAntiAliasing(e){return this.getSetting("AntiAliasing",e)}_setAntiAliasing(e){var t=this.viewer,i=this.getAntiAliasing(e);"TAA"===i&&"static"===e&&"TAA"!==this.getAntiAliasing("dynamic")&&(i="MSAA"),t.antiAliasing!==i&&(t.renderer.setEffect(t.antiAliasing,!1),t.antiAliasing=i,t.renderer.setEffect(t.antiAliasing,!0))}}class a extends n{constructor(e,t){super(e,t),this._blackListedEffects.add("Bloom"),this._blackListedEffects.add("DepthOfField"),this._blackListedEffects.add("AntiAliasing")}}return{Desktop:n,NoHDR:a,Mobile:class extends a{constructor(e,t){super(e,t),this._blackListedEffects.add("GroundShadows"),this._blackListedEffects.add("InterObjectShadows"),this._blackListedEffects.add("TransparentObjectShadows"),this._blackListedEffects.add("GroundReflection"),this._blackListedEffects.add("SSAO"),this._blackListedEffects.add("SSR"),this._blackListedEffects.add("SSRefraction"),"true"===localStorage.getItem("__WEBVISU_MOBILE_QM_POC__")&&(this._blackListedEffects.delete("GroundShadows"),this._blackListedEffects.delete("InterObjectShadows"),this._blackListedEffects.delete("TransparentObjectShadows"),this._blackListedEffects.delete("GroundReflection"),this._blackListedEffects.delete("SSAO"))}},None:class extends n{constructor(e,t){super(e,t),this._blackListedEffects.add("Bloom"),this._blackListedEffects.add("Transparency"),this._blackListedEffects.add("DepthOfField"),this._blackListedEffects.add("AntiAliasing"),this._blackListedEffects.add("GroundShadows"),this._blackListedEffects.add("InterObjectShadows"),this._blackListedEffects.add("TransparentObjectShadows"),this._blackListedEffects.add("GroundReflection"),this._blackListedEffects.add("SSAO"),this._blackListedEffects.add("SSR"),this._blackListedEffects.add("SSRefraction"),this._lqFallback=!0}}}}),define("DS/Visualization/Filters/GeomTypeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this._geomType=e}}}),define("DS/Visualization/Filters/StaticGeomTypeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/GeomTypeFilter"],function(e,t){"use strict";return class extends t{constructor(e){throw super(e),"Unsupported class"}}}),define("DS/Gestures/PunctualSwipeGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var r=i.extend({init:function(){return this._parent("PunctualSwipe"),this},detect:function(e){switch(this._parent(e),this.state){case i.State.INIT:case i.State.BEGIN:case i.State.CHANGE:case i.State.KO:case i.State.OK:case i.State.CANCEL:}}});return UWA.namespace("THREEDS/Gestures/PunctualSwipeGesture",r)}),define("Gestures/PunctualSwipeGesture",["DS/Gestures/PunctualSwipeGesture","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Gestures/PunctualSwipeGesture"),e}),define("DS/Shaders/CopyShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{uniforms:{tDiffuse:{type:"t",value:null},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")}}),define("Shaders/CopyShader",["DS/Shaders/CopyShader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Shaders/CopyShader"),e}),define("DS/Effects/BloomsEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/BloomShaders","DS/Plugins/ClearPass"],function(e,t,i,r,n,a,s){"use strict";return t.extend({init:function(t,i,a){this._parent(t),this.renderer=t,this.rtPool=i,this._initBloom=0,this.useOldBloom=!!a,this.nbIterations=a?5:4,this.nbBlurs=2,this.nbBlurSamples=6,this.bloomFactor=a?.9:.4,this.threshold=a?.626:.9,this.kernels=[],this.kernels[0]=[.02275,.9545,.02275],this.kernels[1]=[.00135,.157305,.68269,.157305,.00135],this.kernels[2]=[428e-6,.022321,.229743,.495016,.229743,.022321,428e-6],this.kernels[3]=[229e-6,.005977,.060598,.241732,.382928,.241732,.060598,.005977,229e-6],this.kernels[4]=[154e-6,.002396,.020195,.092321,.229511,.310847,.229511,.092321,.020195,.002396,154e-6],this.kernels[5]=[116e-6,.001227,.008466,.037976,.110867,.210789,.261121,.210789,.110867,.037976,.008466,.001227,116e-6],this.kernels[6]=[93e-6,735e-6,.004228,.017686,.053815,.119121,.191869,.224907,.191869,.119121,.053815,.017686,.004228,735e-6,93e-6],this.kernels[7]=[78e-6,489e-6,.002403,.009245,.027835,.065592,.12098,.17467,.197417,.17467,.12098,.065592,.027835,.009245,.002403,489e-6,78e-6],this.kernels[8]=[67e-6,35e-5,.001504,.005321,.015497,.037158,.073355,.119235,.159582,.175863,.159582,.119235,.073355,.037158,.015497,.005321,.001504,35e-5,67e-6],this.mixPass=new r(n.MixShader,void 0,"bloomPass"),this.mixPass.material.blending=e.NoBlending,this.mixPass.gammaCorrectionPass=!0,this.passBlurH=null,this.passBlurV=null,this.passDownScale=null,this.passUpScale=null,this.finalBloomPass=null,this.passThreshold=null,this.sharedRTParams=[],this.sharedRT=[];var s=new e.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear");return this.mixPass.changeRenderTargetProperties=s,this.defines={USE_BLOOM:1},this.mixPass.material.defines=this.defines,this._buildBloomRT(),this.updateRequiredComposers(),this.setBloomFactor(this.bloomFactor),this.setBloomThreshold(this.threshold),this},initEffect:function(e,t){t.insertComposer(null,this.mixPass)},update:function(e,t,i){},updateRequiredComposers:function(){this.mixPass.requiredComposers=[],this.useOldBloom?this.mixPass.addRequiredComposer(this.composers[5]):this.mixPass.addRequiredComposer(this.composers[2*this.nbIterations])},setBeforeRenderCallback:function(){var e,t=this;e=function(e){t.passThreshold.uniforms.tDiffuse2.value=e},this.mixPass.beforeRenderCB=e},setOldBloomUse:function(e){this.useOldBloom!=e&&(this.useOldBloom=e,this.nbIterations=this.useOldBloom?5:4,this.bloomFactor=this.useOldBloom?.9:.4,this.threshold=this.useOldBloom?.626:.9,this.defines.USE_BLOOM=this.useOldBloom?2:1,this.mixPass.material.defines=this.defines,this.mixPass.material.needsUpdate=!0,this.setBloomFactor(this.bloomFactor),this.setBloomThreshold(this.threshold),this._buildBloomRT(),this.updateRequiredComposers())},_setBloom:function(e){var t=e.nbIterations?e.nbIterations:4;this.nbIterations!=t&&(this.nbIterations=t,this._initBloom&&(this._initBloom=0,this._buildBloomRT(),this.updateRequiredComposers())),this.bloomFactor=e.bloomFactor?e.bloomFactor:.4,this.threshold=e.threshold?e.threshold:.9,this.setBloomFactor(this.bloomFactor),this.setBloomThreshold(this.threshold)},setBloomFactor:function(e){this.bloomFactor=e,this.useOldBloom?this.mixPass.uniforms.bloomFactor.value=e:this.mixPass.uniforms.bloomFactor.value=this.bloomFactor/(this.nbIterations+1)},setBloomThreshold:function(e){this.useOldBloom&&(e=Math.min(e,1)),this.passThreshold&&(this.passThreshold.uniforms.threshold.value=e),this.threshold=e},setSize:function(e,t){if(this._parent(e,t)){var i,r=.5,n=Math.max(1,r*this.width),a=Math.max(1,r*this.height);if(this.useOldBloom)for(this.composers[0].setSize(n,a),i=1;i<=this.nbIterations;i++)this.composers[i].setSize(n,a),this.passBlurH[i].uniforms.invSize.value.set(1/n,1/a),this.passBlurV[i].uniforms.invSize.value.set(1/n,1/a),r*=.5,n=Math.max(1,r*this.width),a=Math.max(1,r*this.height);else for(this.composers[0].setSize(this.width,this.height),this.composers[2*this.nbIterations].setSize(this.width,this.height),this.passThreshold.uniforms.invSize.value.set(1/this.width,1/this.height),this.finalBloomPass.uniforms.invSize.value.set(1/n,1/a),i=1;i<=this.nbIterations;i++){if(i!=this.nbIterations){var s=this.sharedRTParams[i-1];s.width=n,s.height=a}else this.composers[i].setSize(n,a);if(this.passDownScale[i-1].uniforms.invSize.value.set(1/(2*n),1/(2*a)),r*=.5,n=Math.max(1,r*this.width),a=Math.max(1,r*this.height),i!=this.nbIterations&&this.passUpScale[this.nbIterations-i-1].uniforms.invSize.value.set(1/n,1/a),i==this.nbIterations)for(var o=0;o<this.nbBlurs;o++)this.passBlurH[o].uniforms.ratio.value=this.width>this.height?this.height/this.width:1,this.passBlurV[o].uniforms.ratio.value=this.width>this.height?1:this.width/this.height}}},_buildBloomRT:function(t){if(!(this._initBloom>0&&(2==this._initBloom&&this.useOldBloom||1==this._initBloom&&!this.useOldBloom))){if(this._initBloom=this.useOldBloom?2:1,this.useOldBloom){var a=.5;this.passBlurH=[],this.passBlurV=[];var s=Math.max(1,a*this.width),o=Math.max(1,a*this.height),l=new e.WebGLRenderTargetProperties(s,o,"uint");this.composers[0]=new i(this.renderer,l,this.rtPool),this.composers[0].composerContext.name="ThresholdComposerContext",this.passThreshold=new r(n.Threshold,void 0,"Threshold"),this.passThreshold.uniforms.threshold.value=this.threshold,this.passThreshold.material.defines={OLD_BLOOM:1},this.composers[0].addPass(this.passThreshold);for(var c=1;c<=this.nbIterations;c++){l=new e.WebGLRenderTargetProperties(s,a*this.height,"uint");this.composers[c]=new i(this.renderer,l,this.rtPool),this.composers[c].composerContext.name="Blur"+c+"ComposerContext",this.passBlurH[c]=new r(n.BlurH2,void 0,"BlurH2"+c),this.passBlurV[c]=new r(n.BlurV,void 0,"BlurV"+c),this.passBlurH[c].material.defines={LEVEL:c},this.passBlurV[c].material.defines={LEVEL:c},this.passBlurH[c].uniforms.invSize.value.set(1/s,1/o),this.passBlurV[c].uniforms.invSize.value.set(1/s,1/o),this.passBlurH[c].material.needsUpdate=!0,this.passBlurV[c].material.needsUpdate=!0,this.composers[c].addPass(this.passBlurH[c]),this.composers[c].addPass(this.passBlurV[c]),a*=.5,s=Math.max(1,a*this.width),o=Math.max(1,a*this.height)}this.passBlurH[1].addRequiredComposer(this.composers[0]),this.passBlurH[2].addRequiredComposer(this.composers[1]),this.passBlurH[3].addRequiredComposer(this.composers[2]),this.passBlurH[4].addRequiredComposer(this.composers[3]),this.passBlurH[5].addRequiredComposer(this.composers[4]),this.composers[0].linkToShaderPassUniform(this.passBlurH[1],this.passBlurH[1].uniforms.tDiffuse2),this.composers[1].linkToShaderPassUniform(this.passBlurH[2],this.passBlurH[2].uniforms.tDiffuse2),this.composers[2].linkToShaderPassUniform(this.passBlurH[3],this.passBlurH[3].uniforms.tDiffuse2),this.composers[3].linkToShaderPassUniform(this.passBlurH[4],this.passBlurH[4].uniforms.tDiffuse2),this.composers[4].linkToShaderPassUniform(this.passBlurH[5],this.passBlurH[5].uniforms.tDiffuse2),this.composers[1].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.composers[2].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse3),this.composers[3].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse4),this.composers[4].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse5),this.composers[5].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse6)}else{a=.5,s=Math.max(1,a*this.width),o=Math.max(1,a*this.height);var h=2*this.nbIterations;this.passDownScale=[],this.passBlurH=[],this.passBlurV=[],this.passUpScale=[];l=new e.WebGLRenderTargetProperties(this.width,this.height,"halfLinear");this.composers[0]=new i(this.renderer,l,this.rtPool),this.composers[0].composerContext.name="ThresholdComposerContext",this.passThreshold=new r(n.Threshold,void 0,"Threshold"),this.passThreshold.uniforms.threshold.value=this.threshold,this.passThreshold.uniforms.invSize.value.set(1/this.width,1/this.height),this.composers[0].addPass(this.passThreshold),this.composers[h]=new i(this.renderer,l,this.rtPool),this.composers[h].composerContext.name="UpReplaceComposerContext",this.finalBloomPass=new r(n.UpReplace,void 0,"UpReplace"),this.finalBloomPass.uniforms.invSize.value.set(1/s,1/o),this.composers[h].addPass(this.finalBloomPass);var u=function(e,t,i){e.composers[t].composerContext.setBeforeRenderCB(function(e){e.writeBuffer=v.sharedRT[i]})},d=function(e,t,i){e.composers[t].composerContext.setBeforeRenderCB(function(t){var r=e.sharedRTParams[i];e.sharedRT[i]=e.rtPool.buildRenderTarget(r.width,r.height,r.options),t.writeBuffer=v.sharedRT[i]})};for(c=1;c<=this.nbIterations;c++){var p=c,f=c-1,m=h-c,g=this.nbIterations-c-1;this.passDownScale[f]=new r(n.Down,void 0,"Downscale"+f),this.passDownScale[f].uniforms.invSize.value.set(1/(2*s),1/(2*o));l=new e.WebGLRenderTargetProperties(s,o,"halfLinear");this.sharedRTParams[f]=l,this.composers[p]=new i(this.renderer,l,this.rtPool),this.composers[p].composerContext.name="Downscale"+f+"ComposerContext";var v=this;if(p!=this.nbIterations&&(this.composers[p].composerContext.renderTargetProperties=null,this.composers[p].composerContext.originalRenderTargetProperties=null,u(this,p,f)),this.composers[p].addPass(this.passDownScale[f]),p==this.nbIterations)for(var S=0;S<this.nbBlurs;S++)this.passBlurH[S]=new r(n.Blur,void 0,"BlurH"+S),this.passBlurV[S]=new r(n.Blur,void 0,"BlurV"+S),this.passBlurH[S].material.defines={LEVEL:this.nbBlurSamples-1},this.passBlurV[S].material.defines={LEVEL:this.nbBlurSamples-1},this.passBlurH[S].uniforms.ratio.value=this.width>this.height?this.height/this.width:1,this.passBlurV[S].uniforms.ratio.value=this.width>this.height?1:this.width/this.height,this.passBlurH[S].uniforms.blurSize.value=.1,this.passBlurV[S].uniforms.blurSize.value=.1,this.passBlurH[S].uniforms.direction.value.set(1,0),this.passBlurV[S].uniforms.direction.value.set(0,1),this.passBlurH[S].uniforms.kernel.value=this.kernels[this.nbBlurSamples-2],this.passBlurV[S].uniforms.kernel.value=this.kernels[this.nbBlurSamples-2],this.passBlurH[S].material.needsUpdate=!0,this.passBlurV[S].material.needsUpdate=!0,this.composers[p].addPass(this.passBlurH[S]),this.composers[p].addPass(this.passBlurV[S]);else a*=.5,s=Math.max(1,a*this.width),o=Math.max(1,a*this.height),this.passUpScale[g]=new r(n.UpReplace,void 0,"UpReplace"+g),this.passUpScale[g].material.blending=e.CustomBlending,this.passUpScale[g].material.blendEquation=e.AddEquation,this.passUpScale[g].material.blendSrc=e.OneFactor,this.passUpScale[g].material.blendDst=e.OneFactor,this.passUpScale[g].material.useBlending=!0,this.passUpScale[g].uniforms.invSize.value.set(1/s,1/o),this.composers[m]=new i(this.renderer,l,this.rtPool),this.composers[m].composerContext.renderTargetProperties=null,this.composers[m].composerContext.originalRenderTargetProperties=null,this.composers[m].composerContext.name="UpReplace"+g+"ComposerContext",d(this,m,f),this.composers[m].addPass(this.passUpScale[g]);this.passDownScale[f].addRequiredComposer(this.composers[p-1]),this.composers[p-1].linkToShaderPassUniform(this.passDownScale[f],this.passDownScale[f].uniforms.tDiffuse2)}for(c=1;c<this.nbIterations;c++){m=h-c,g=this.nbIterations-c-1;this.passUpScale[g].addRequiredComposer(this.composers[m-1]),this.composers[m-1].linkToShaderPassUniform(this.passUpScale[g],this.passUpScale[g].uniforms.tDiffuse2)}this.finalBloomPass.addRequiredComposer(this.composers[h-1]),this.composers[h-1].linkToShaderPassUniform(this.finalBloomPass,this.finalBloomPass.uniforms.tDiffuse2),this.composers[h].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2)}this.setBeforeRenderCallback()}}})}),define("DS/Shaders/ConvertCubemapToLatlongShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{ConvertCubemapToLatlong:{defines:{ORIENTATION:0},uniforms:{cubemap:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform samplerCube cubemap;","const float PI = 3.14159265358979323846264;","varying vec2 vUv;","void main() {","gl_FragColor = vec4(0.0);","vec3 N;","float phi = PI * (2.0 * vUv.x - 1.0);","#if ORIENTATION == 1","float theta = PI * vUv.y;","N.x = sin(theta) * sin(phi);","N.y = cos(theta);","N.z = sin(theta) * cos(phi);","#elif ORIENTATION == 2","float theta = PI * (1.0 - vUv.y);","N.x = sin(theta) * cos(phi);","N.z = sin(theta) * sin(phi);","N.y = -cos(theta);","#else","float theta = PI * (1.0 - vUv.y);","N.x = sin(theta) * cos(phi);","N.y = sin(theta) * sin(phi);","N.z = cos(theta);","#endif","gl_FragColor = textureCube(cubemap, N);","}"].join("\n")}}}),define("DS/VisuLoaders/XMLV6SmartLoaderPassPlugin",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return function(t){this.enabled=!1,this.renderTarget=null;var i,r=t,n=new e.Frustum,a=new e.Matrix4;this.init=function(e){e.context,i=e},this.render=function(e,t){this.enabled&&(r.isWebWorkerBusy()||this.update(e,t))},this.update=function(t,s){var o,l,c,h,u;i.autoUpdateScene&&t.updateMatrixWorld(),s.matrixWorldInverse.getInverse(s.matrixWorld),a.multiplyMatrices(s.projectionMatrix,s.matrixWorldInverse),n.setFromMatrix(a);var d=[];for(o=0,l=(u=t.getWebGLObjects("main",0)).length;o<l;o++)if(null!==(c=u[o])&&(!((h=c.object)instanceof e.Mesh)||!h.frustumCulled||n.intersectsObject(h))&&"BBox"==h.name){var p=-1;if(null!==h.boundingSphere){var f=new e.Vector3;f.copy(h.boundingSphere.center),f.applyMatrix4(h.matrixWorld);var m=new e.Vector3;m.subVectors(f,s.position);var g=m.length();p=h.boundingSphere.radius/g}d.push({name:h._occurrence.parent.node.name,priority:p})}d.sort(function(e,t){return e.priority<t.priority?1:e.priority>t.priority?-1:0}),r.loadGeometryFiles(d)}}}),define("DS/VisuUnstreamers/XMLMaterialUnstreamTask",["UWA/Class","WebappsUtils/WebappsUtils","DS/VisuUnstreamers/FileInZipStreamObject","DS/Mesh/MeshUtils","DS/Visualization/MaterialManager"],function(e,t,i,r,n){"use strict";var a=0,s=e.extend({init:function(e,t){this.id=a++,this.streamObject=e,this.materialLibrary=t,this.materialRefId=-1;var i=this.streamObject?this.streamObject.getUserData():null;return i&&!i.materialLibraryFiles&&(i.materialLibraryFiles={},i.graphicMaterialFiles={},i.imageLibraryFiles={},i.imageFiles={}),this},run:function(e,t,i){if(-1!==this.materialRefId){0;var r=this,n=this.streamObject.getUserData(),a=n.materialLibraryFiles[this.streamObject.filename];a?"pending"===a.state?a.tasks.push({task:this,cb:this.loadGraphicMaterial,args:[e,t]}):this.loadGraphicMaterial(e,t):(n.materialLibraryFiles[this.streamObject.filename]={state:"pending",tasks:[]},this.streamObject.open(),this.streamObject.readAsXML(function(i){r.streamObject.close();var a=n.materialLibraryFiles[r.streamObject.filename];n.materialLibraryFiles[r.streamObject.filename]=r.parseMaterialReference(i);for(var s=0;s<a.tasks.length;s++){var o=a.tasks[s];0,o.cb.apply(o.task,o.args)}r.loadGraphicMaterial(e,t)}))}},parseMaterialReference:function(e){var t={},i=e.firstChild;if("Model_3dxml"===i.nodeName){for(var r=0;r<i.childNodes.length;r++){var n=i.childNodes[r];if("CATMaterialRef"==n.nodeName)for(var a=0;a<n.childNodes.length;a++){var s=n.childNodes[a];if("CATMatReference"===s.nodeName||"MaterialDomainInstance"===s.nodeName||"MaterialDomain"===s.nodeName){var o=s.getAttribute("id"),l=s.getAttribute("name");switch(s.nodeName){case"CATMatReference":void 0!==t[o]?t[o].name=l:t[o]={name:l};break;case"MaterialDomainInstance":for(var c=0,h=0,u=0;u<s.childNodes.length;u++){var d=s.childNodes[u];"IsAggregatedBy"==d.nodeName?c=d.textContent:"IsInstanceOf"==d.nodeName&&(h=d.textContent)}t[o]={parent:c,instance:h},void 0!==t[c]?t[c].instance=o:t[c]={instance:o};break;case"MaterialDomain":var p,f=s.getAttribute("associatedFile");p=f.split("urn:3DXML:"),f=p[1],void 0!==t[o]?t[o].filename=f:t[o]={filename:f}}}}}return t}},loadGraphicMaterial:function(e,t){var r=this,n=this.streamObject.getUserData(),a=n.materialLibraryFiles[this.streamObject.filename],s=a[this.materialRefId];if(void 0===s)return null;var o=a[s.instance];if(void 0===o)return null;var l=a[o.instance];if(void 0===l)return null;if(l.filename){var c=n.graphicMaterialFiles[l.filename];if(c)"pending"===c.state?c.tasks.push({task:this,cb:this.loadRepresentationImage,args:[l.filename,e,t]}):this.loadRepresentationImage(l.filename,e,t);else{n.graphicMaterialFiles[l.filename]={state:"pending",tasks:[]};var h=new i(this.streamObject.blob,l.filename);h.open(),h.readAsXML(function(i){h.close();var a=n.graphicMaterialFiles[l.filename];n.graphicMaterialFiles[l.filename]=r.parseGraphicMaterial(i);for(var s=0;s<a.tasks.length;s++){var o=a.tasks[s];0,o.cb.apply(o.task,o.args)}r.loadRepresentationImage(l.filename,e,t)})}}},parseGraphicMaterial:function(e){var t={type:"material3DXML",shading:"Phong",DiffuseMapWrap:[],DiffuseMapRepeat:[0,0]},i=e.firstChild;if("Osm"===i.nodeName){for(var r=0;r<i.childNodes.length;r++){var n=i.childNodes[r];if("Feature"==n.nodeName&&"RenderingFeature"==n.getAttribute("Alias"))for(var a=0;a<n.childNodes.length;a++){var s=n.childNodes[a];if("Attr"==s.nodeName){var o=s.getAttribute("Type"),l=s.getAttribute("Value"),c=s.getAttribute("Name");switch(o){case"int":switch(l=parseInt(l,10),t[c]=l,c){case"WrappingModeU":l&&(t.DiffuseMapWrap[0]="repeat",t.DiffuseMapRepeat[0]=1);break;case"WrappingModeV":l&&(t.DiffuseMapWrap[1]="repeat",t.DiffuseMapRepeat[1]=1);break;case"PreviewType":switch(parseInt(l)){case 0:t.mappingFunction="SPHERICAL_ENV_MAP";break;case 2:t.mappingFunction="USER_MAPPING"}}break;case"double":switch(c){case"DiffuseColor":t.colorDiffuse=this.getColor(l);break;case"SpecularColor":t.colorSpecular=this.getColor(l);break;case"AmbientColor":t.colorAmbient=this.getColor(l);break;case"SpecularExponent":t.shininess=128*parseFloat(l);break;case"SpecularCoef":t.specularCoef=parseFloat(l);break;case"Reflectivity":t.reflectivityCoef=parseFloat(l);break;case"Transparency":t.transparency=parseFloat(l),t.transparent=t.transparency>0}break;case"boolean":switch(l="true"===l,c){case"AlphaTest":t.alphaTest=l?.5:0;break;default:t[c]=l}break;case"external":var h=[];h=l.split("urn:3DXML:"),h=(l=h[1]).split("#"),l=h[0];var u=h[1];"TextureImage"==c&&(t.DiffuseMap={imageLib:l,id:u})}}}}return t}},loadRepresentationImage:function(e,t,r){var a=this,s=this.streamObject.getUserData(),o=new n,l=s.graphicMaterialFiles[e],c=l.DiffuseMap;if(c&&c.imageLib){var h=s.imageLibraryFiles[c.imageLib];if(h)"pending"===h.state?h.tasks.push({task:this,cb:this.loadImage,args:[e,t,r]}):this.loadImage(e,t,r);else{s.imageLibraryFiles[c.imageLib]={state:"pending",tasks:[]};var u=new i(this.streamObject.blob,c.imageLib);u.open(),u.readAsXML(function(i){u.close();var n=s.imageLibraryFiles[u.filename];s.imageLibraryFiles[u.filename]=a.parseRepresentationImage(i);for(var o=0;o<n.tasks.length;o++){var l=n.tasks[o];0,l.cb.apply(l.task,l.args)}a.loadImage(e,t,r)})}}else{var d=o.getMaterial3DXML(l,"/","XMLV43");r&&r(d)}},parseRepresentationImage:function(e){var t={},i=e.firstChild;if("Model_3dxml"===i.nodeName){for(var r=0;r<i.childNodes.length;r++){var n=i.childNodes[r];if("CATRepImage"==n.nodeName)for(var a=0;a<n.childNodes.length;a++){var s=n.childNodes[a];if("CATRepresentationImage"==s.nodeName){var o=s.getAttribute("id"),l=(s.getAttribute("name"),s.getAttribute("format"),s.getAttribute("associatedFile").split("urn:3DXML:"));t[o]=l[1]}}}return t}},loadImage:function(e,t,r){var n=this,a=this.streamObject.getUserData(),s=a.graphicMaterialFiles[e],o=s.DiffuseMap,l=a.imageLibraryFiles[o.imageLib][o.id],c=a.imageFiles[l];if(c)"pending"===c.state?c.tasks.push({task:this,cb:this.createMaterial,args:[e,l,t,r]}):this.createMaterial(e,l,t,r);else{a.imageFiles[l]={state:"pending",tasks:[]};var h=new i(this.streamObject.blob,l);h.open();"dds"==/(?:\.([^.]+))?$/.exec(l)[1]?h.readAsArrayBuffer(function(i){h.close();var o=a.imageFiles[l];a.imageFiles[l]=i;for(var c=0;c<o.tasks.length;c++){var u=o.tasks[c];0,u.cb.apply(u.task,u.args)}s.DiffuseMap={filename:l,buffer:a.imageFiles[l]},n.createMaterial(e,t,r)}):h.readAsBlob(function(i){h.close();var s=a.imageFiles[l];a.imageFiles[l]=i;for(var o=0;o<s.tasks.length;o++){var c=s.tasks[o];0,c.cb.apply(c.task,c.args)}n.createMaterial(e,l,t,r)})}},createMaterial:function(e,t,i,r){var a=new n,s=this.streamObject.getUserData(),o=s.graphicMaterialFiles[e];o.DiffuseMap={filename:t,buffer:s.imageFiles[t]};var l=a.getMaterial3DXML(o,"/","XMLV43",null,r);i&&l.map&&i(l)},getColor:function(e){var t=[],i=new RegExp(/\[([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*))\]/),r=i.exec(e);return null!=r?(t[0]=parseFloat(RegExp.$1),t[1]=parseFloat(RegExp.$2),t[2]=parseFloat(RegExp.$3)):null!=(r=(i=new RegExp(/\[([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*))\]/)).exec(e))&&(t[0]=parseFloat(RegExp.$1),t[1]=parseFloat(RegExp.$2),t[2]=parseFloat(RegExp.$3),t[3]=parseFloat(RegExp.$4)),t}});return UWA.namespace("THREEDS/XMLMaterialUnstreamTask",s)}),define("VisuUnstreamers/XMLMaterialUnstreamTask",["DS/VisuUnstreamers/XMLMaterialUnstreamTask","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuUnstreamers/XMLMaterialUnstreamTask"),e}),define("DS/Plugins/XMLV6SmartLoaderPassPlugin",["DS/VisuLoaders/XMLV6SmartLoaderPassPlugin"],function(e){"use strict";return e}),define("Plugins/XMLV6SmartLoaderPassPlugin",["DS/Plugins/XMLV6SmartLoaderPassPlugin","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Plugins/XMLV6SmartLoaderPassPlugin"),e}),define("DS/Effects/ConvertCubemapToLatlong",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/NothingShader","DS/Shaders/ConvertCubemapToLatlongShader","DS/Shaders/DisplayIrradianceMapShader","DS/Shaders/EncodeHDRShader"],function(e,t,i,r,n,a,s,o){"use strict";return t.extend({init:function(e,t){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=t,this.passConvert=null,this.texture=null,this.passDisplayLatlongMap=null,this.saveComposer=null,this.passEncodeHDR=null,this},setEnvMap:function(t,n){this.texture=t;var o;(this.width=2048,this.height=1024,this.composers[1])?this.composers[1].setSize(2048,1024):((o=new e.WebGLRenderTargetProperties(2048,1024,"linear")).generateMipmaps=!1,o.mapping=this.texture.mapping,this.composers[1]=new i(this.renderer,o,this.renderTargetPool),this.composers[1].composerContext.keepResult=!0,a.ConvertCubemapToLatlong.defines.ORIENTATION=n||0,this.passConvert=new r(a.ConvertCubemapToLatlong),this.composers[1].addPass(this.passConvert));(this.passConvert.uniforms.cubemap.value=this.texture,this.composers[0])?this.composers[0].setSize(this.width,this.height):((o=new e.WebGLRenderTargetProperties(this.width,this.height,"uint")).generateMipmaps=!1,o.mapping=this.texture.mapping,this.composers[0]=new i(this.renderer,o,this.renderTargetPool),this.composers[0].composerContext.keepResult=!1,this.passDisplayLatlongMap=new r(s),this.composers[0].composerContext.setPassRenderToCanvas(this.passDisplayLatlongMap,!0),this.composers[0].addPass(this.passDisplayLatlongMap),this.composers[1].linkToShaderPassUniform(this.passDisplayLatlongMap,this.passDisplayLatlongMap.uniforms.tDiffuse1))},execute:function(){this.composers[1].render()},getResult:function(t){var i=this.composers[1].composerContext.getResult(void 0,t);return i.hdr=!0,i.mapping=new e.LatLongReflectionMapping,i},getResultRGBE:function(t){this.encodeRGBE();var i=this.saveComposer.composerContext.getResult(void 0,t);return i.hdr=!0,i.mapping=new e.LatLongReflectionMapping,i},encodeRGBE:function(){var t=this.composers[1],n=t.composerContext.renderTargetProperties.width,a=t.composerContext.renderTargetProperties.height;if(this.saveComposer)this.saveComposer.setSize(n,a);else{var s=new e.WebGLRenderTargetProperties(n,a,"uintNearest");s.generateMipmaps=!1,s.mapping=this.texture.mapping,this.saveComposer=new i(this.renderer,s,this.renderTargetPool),this.saveComposer.composerContext.keepResult=!0,this.passEncodeHDR=new r(o),this.saveComposer.composerContext.setPassRenderToCanvas(this.passEncodeHDR,!1),this.saveComposer.addPass(this.passEncodeHDR)}this.passEncodeHDR.uniforms.map.value=t.composerContext.renderTarget2,this.saveComposer.render()}})}),define("DS/Visualization/OccurrenceInterface",["UWA/Class","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS"],function(e,t,i){"use strict";function r(e){if(!e._occurrenceExplorer._occurrenceInterfaceList){var t=new Error("Use of expired OccurrenceInterface (= outside of callback function given to OccurrenceExplorer.explore())");throw t.expiredOccurrenceInterfaceError=!0,t}return e._occurrenceExplorer._occurrenceList[e._node][e._index].occurrence}return e.extend({init:function(e,t,i){this._node=e,this._index=t,this._occurrenceExplorer=i},getNbChildren:function(){return r(this).children.length},getParent:function(){var e=r(this);return this._occurrenceExplorer.getOccurrenceInterface(e.parent)},getChild:function(e){var t=r(this);return this._occurrenceExplorer.getOccurrenceInterface(t.children[e])},getChildren:function(){var e,t=r(this),i=[];for(e=0;e<t.children.length;e++)i.push(this._occurrenceExplorer.getOccurrenceInterface(t.children[e]));return i},traverse:function(e,t){var i=r(this);if(!e(this,t)){var n=0;for(n=0;n<i.children.length;n++)this._occurrenceExplorer.getOccurrenceInterface(i.children[n]).traverse(e,t)}},getNode:function(){return r(this).node},getMesh3D:function(){var e=r(this);return"Mesh3D"===e.node.getNodeType()?e.node:null},getColor:function(e){var t=r(this);if(this._tryOverridesUpdate(t),t.renderable){var n=t.occurrenceRenderingOverride&&t.occurrenceRenderingOverride.materialOverride,a=n&&n.getColor()||null,s=n&&n.getFullMaterial(),o=t.renderable.matApp&&t.renderable.matApp._getMaterialFromGLType(4,i.GeomTypeEnum.FACE),l=!1;!o&&t.renderable.material?(l=!0,!(o=t.renderable.material)||!e&&o.force||(o=null)):o&&e&&(o=null);var c=null;null===a&&!s||o&&o.color&&!o.overridable?c=o&&o.color&&(!l||o.force)&&o.color.clone():(c=s&&s.color&&s.color.clone(),null===a||c&&!s.overridable||(c=new i.Color(a)))}return c},getWorldMatrix:function(e){var t=r(this);return this._tryOverridesUpdate(t),e?(e.copy(t.matrix),e):t.matrix.clone()},getMatrix:function(e){var t=r(this);this._tryOverridesUpdate(t);var i=t.getLocalMatrix();return e?(e.copy(i),e):i.clone()},getMatrixInAxisSystem:function(e,t){var r=this.getWorldMatrix();if(!r)return null;var n=t||new i.Matrix4,a=new i.Matrix4;return a.getInverse(e),n.multiplyMatrices(a,r),n},getRenderableDescendants:function(){var e=r(this),t=[],i=this;return e.traverse(function(e){e.renderable&&t.push(i._occurrenceExplorer.getOccurrenceInterface(e))}),t},buildPathElement:function(e){var i=new t,n=r(this);return i.setFromOccurrence(n,null,e)?i:null},getVisibility:function(){var e=r(this);return this._tryOverridesUpdate(e),e._getVisible()},getBoundingSphere:function(e){return r(this).getBoundingSphere(e,!1)},getBoundingBox:function(e){return r(this).getBoundingBox(e)},isAParentOf:function(e){for(var t=e;t&&this!==t;)t=t.getParent();return t===this},findAncestor:function(e){for(var t=this.getParent(),i=null;t&&!i;)e(t)&&(i=t),t=t.getParent();return i},_tryOverridesUpdate:function(e){var t,i=this._occurrenceExplorer.viewer;if(e._getNeedOverridesUpdate()){for(t=e;t.parent;)t=t.parent;i=i||e.scene3js&&e.scene3js.viewer,t.node._tryOverridesUpdate(i)}}})}),define("DS/Visualization/PLMMaterialConnectionFactory",["DS/Visualization/MaterialConnection","DS/Visualization/PathElement","DS/Visualization/IdPathWatcher","DS/Visualization/IdPath"],function(e,t,i,r){"use strict";var n=function(){this.loadAppearanceCB=null,this.getNodeFromIdCB=null,this.computePathElementCB=null,this.idPathWatcher=null,this.appearanceIdMap=new Map,this.internalPathIds=new Map,this.legacyUVIds=new Map,this.oocManager=null};return n.prototype.setParams=function(e){e.loadAppearanceCB&&(this.loadAppearanceCB=e.loadAppearanceCB),e.getNodeFromIdCB&&(this.getNodeFromIdCB=e.getNodeFromIdCB),e.useIdPathMatcher&&e.viewer&&(this.idPathWatcher=new i({viewer:e.viewer,onIdPathActiveCB:this._onIdPathActive.bind(this),onIdPathInactiveCB:this._onIdPathInactive.bind(this)})),e.oocManager&&(this.oocManager=e.oocManager)},n.prototype.addMaterialConnection=function(e,t){if(this.idPathWatcher){if(t.legacyUV){var i=(n=t.idPath)[n.length-1];this._addLegacyUVId(i)}if(t.internalPath){var n,a="##REP##"+(i=(n=t.idPath)[n.length-1]);t.idPath=n.concat([a]),this._addInternalIdPathId(i)}var s=t.appearanceId,o=this.appearanceIdMap.get(s);o?o[1]=t:(o=[e,t],this.appearanceIdMap.set(s,o),this.idPathWatcher.addIdPath(new r(t.idPath),o))}else this._addMaterialConnectionOnMaterializedIdPath.apply(this,arguments)},n.prototype.removeMaterialConnection=function(e){var t=this.appearanceIdMap.get(e);if(t){var i=t[1];if(i&&i.internalPath){var r=i.idPath[i.idPath.length-2];r&&this._removeInternalIdPath(r),r&&this._removeLegacyUVId(r)}this.idPathWatcher.removeIdObject(t),this.appearanceIdMap.delete(e)}},n.prototype._addMaterialConnectionOnMaterializedIdPath=function(t,i){var r=this.idPathWatcher&&this.idPathWatcher.getIdPathMatcher(),n=r?r.idToNode(t):this.getNodeFromIdCB(t);if(n){var a=n.getPLMMaterialData(),s=i.pathElement,o=s?[s]:[];if(!s){var l=i.idPath;if((s=this.getPathElementFromIdPath(l))&&o.push(s),s&&(i.internalUUIDPath||i.internalPath)){var c=s.externalPath.length,h=c>0?s.externalPath[c-1]:s.externalPath[0];if(i.internalUUIDPath)o=h.getPathElementsFromUUIDs(s,i.internalUUIDPath,i.cgmIdRep,i.cgmIdPrimitive?[i.cgmIdPrimitive]:null);else{var u=[];null!==i.internalPath&&void 0!==i.internalPath&&u.push(i.internalPath),null!==i.cgmIdRep&&void 0!==i.cgmIdRep&&u.push(i.cgmIdRep),null!==i.cgmIdPrimitive&&void 0!==i.cgmIdPrimitive&&u.push(i.cgmIdPrimitive);var d=i.cgmIdPrimitives?i.cgmIdPrimitives:i.cgmIdPrimitive?[i.cgmIdPrimitive]:null;o=h.getPathElementsFromDiezeEle(s,i.internalPath?[i.internalPath]:null,i.cgmIdRep,d)}}}if(o)for(var p=0;p<o.length;p++){var f=new e({pathElement:o[p],appearanceId:i.appearanceId,type:i.type,depth:i.depth,vLayer:i.vLayer});a.addMaterialConnection(f)}}},n.prototype.getPathElementFromIdPath=function(e){var i,r,n=[],a=this.idPathWatcher&&this.idPathWatcher.getIdPathMatcher();for(i=0;i<e.length;i++){var s=e[i];if(!(r=a?a.idToNode(s):this.getNodeFromIdCB(s)))return null;n.push(r)}return new t(n)},n.prototype.hasInternalPath=function(e){return(this.internalPathIds.get(e)||0)>0},n.prototype.hasLegacyUV=function(e){return(this.legacyUVIds.get(e)||0)>0},n.prototype._onIdPathActive=function(e){this._addMaterialConnectionOnMaterializedIdPath.apply(this,e)},n.prototype._onIdPathInactive=function(e){},n.prototype._addInternalIdPathId=function(e){var t=this.internalPathIds.get(e)||0;t++,this.internalPathIds.set(e,t)},n.prototype._removeInternalIdPath=function(e){var t=this.internalPathIds.get(e)||0;t>0&&(0===--t?this.internalPathIds.delete(e):this.internalPathIds.set(e,t))},n.prototype._addLegacyUVId=function(e){var t=this.legacyUVIds.get(e)||0;if(t++,this.legacyUVIds.set(e,t),1===t&&this.oocManager){var i=this.oocManager._getLDHReference(e,!0);i&&i.setLegacyUV()}},n.prototype._removeLegacyUVId=function(e){var t=this.legacyUVIds.get(e)||0;t>0&&(0===--t?this.legacyUVIds.delete(e):this.legacyUVIds.set(e,t))},n.prototype.COVERAGE_MATERIAL=e.COVERAGE_MATERIAL,n.prototype.CORE_MATERIAL=e.CORE_MATERIAL,new n}),define("DS/Plugins/MaskPass",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return null}),define("Plugins/MaskPass",["DS/Plugins/MaskPass","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Plugins/MaskPass"),e}),define("DS/Visualization/PLMMaterialLoader",["DS/Visualization/PLMMaterialConnectionFactory"],function(e){"use strict";var t=function(){this.toLoadMaterialConnectionArray=[],this.token_toLoadMaterialConnectionArray=null,this.materialConnectionToPLMMaterialDataMap=new Map};return t.prototype.loadMaterials=function(e,t){var i,r,n=this.toLoadMaterialConnectionArray;for(i=0;i<e.length;i++)r=e[i],this.materialConnectionToPLMMaterialDataMap.set(r,t),r.isComplete()&&n.push(r);n.length>0&&null===this.token_toLoadMaterialConnectionArray&&(this.token_toLoadMaterialConnectionArray=setTimeout(this.loadMaterials_internal.bind(this),0))},t.prototype.getPathElementFromIdPath=function(t){var i,r,n=[];for(i=0;i<t.length;i++)r=e.loadAppearanceCB(t[i]),n.push(r);return new PathElement(n)},t.prototype.loadMaterials_internal=function(){var t;if(null!==this.token_toLoadMaterialConnectionArray){for(t=0;t<this.toLoadMaterialConnectionArray.length;t++)e.loadAppearanceCB(this.toLoadMaterialConnectionArray[t],this.onMaterialLoadedCB.bind(this),this.onMaterialErrorCB.bind(this));this.toLoadMaterialConnectionArray=[],this.token_toLoadMaterialConnectionArray=null}},t.prototype.onMaterialLoadedCB=function(e,t){this.materialConnectionToPLMMaterialDataMap.get(e)._applyMaterialApplication(e,t)},t.prototype.onMaterialErrorCB=function(e,t){},t}),define("DS/Shaders/ConvertLatLongToDualParaboloidShader",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=function(t,i){var r={defines:{SCALE:1.2},uniforms:{map:{type:"t",value:null},size:{type:"v2",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D map;","uniform vec2 size;","varying vec2 vUv;","const float PI = 3.14159265358979323846264;","float atan2(float y, float x) {","if (x > 0.0) return sign(y) * atan(abs(y/x));","else if (x < 0.0) return sign(y) * (PI - atan(abs(y/x)));","return 0.5 * PI * sign(y);","}",e._DefaultShaderChunk.rgbe_sample_methods,"void main() {","gl_FragColor = vec4(0.0);","vec2 uv = vec2(fract(2.0 * vUv.x), vUv.y);","float phi = atan2(2.0 * uv.y - 1.0, 2.0 * uv.x - 1.0);","float theta;","float u;","if (vUv.x < 0.5) {","theta = 2.0 * atan(cos(phi) / (SCALE * (2.0 * uv.x - 1.0)));","u = fract(0.5*phi / PI);","} else {","theta = 2.0 * atan(SCALE * (1.0 - 2.0 * uv.x) / cos(phi));","phi += 1.0*PI;","u = fract(0.5*phi / PI);","}","float v = abs(theta / PI);"].join("\n")};return r.fragmentShader=t?[r.fragmentShader,"gl_FragColor = texture2DBilinearFromRGBE(map, vec2(u, v), size, vec2(1.0)/size);",i?"gl_FragColor.xyz *= gl_FragColor.xyz;":"","}"].join("\n"):[r.fragmentShader,"gl_FragColor = texture2D(map, vec2(u, v));",i?"gl_FragColor.xyz *= gl_FragColor.xyz;":"","}"].join("\n"),r};return{ConvertLatLongRGBEToDualParaboloid:t(!0,!1),ConvertLatLongRGBEToDualParaboloidsRGB:t(!0,!0),ConvertLatLongToDualParaboloid:t(!1,!1),ConvertLatLongToDualParaboloidsRGB:t(!1,!0)}}),define("DS/Visualization/Filters/MaterialToUseFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this.materialToUse=e}}}),define("DS/Plugins/UserRenderPass",["DS/Plugins/UserPass","DS/Plugins/RenderPass"],function(e,t){function i(e){return!!e}return e.extend({init:function(e){this._parent(e);var i=new t(null,null,null,null,null,null,"_UserRenderPass_"+this.id+"_"+this.name);this._passes.push(i)},setDisableColorWrite:function(e){this._passes[0].setDisableColorWrite(i(e))},setDisableDepthWrite:function(e){this._passes[0].setDisableDepthWrite(i(e))},setDisableBackFaceCulling:function(e){this._passes[0].setDisableBackFaceCulling(i(e))},setEnableStencilWrite:function(e){this._passes[0].setEnableStencilWrite(i(e))},setEnableStencilTest:function(e){this._passes[0].setEnableStencilTest(i(e))},setStencilOps:function(e,t){this._passes[0].setStencilOps(e,t)},setStencilOpsSeparate:function(e,t,i,r){this._passes[0].setStencilOpsSeparate(e,t,i,r)},setStencilFunc:function(e){this._passes[0].setStencilFunc(e)},setCullFaceMode:function(e){this._passes[0].setCullFaceMode(e)},setDepthFunc:function(e){this._passes[0].setDepthFunc(e)},_setCameraName:function(e){this._parent(e),this._passes[0].setCameraName(e)}})}),define("DS/Effects/ConvertLatLongToDualParaboloid",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/ConvertLatLongToDualParaboloidShader","DS/Shaders/DisplayIrradianceMapShader"],function(e,t,i,r,n,a){"use strict";return t.extend({init:function(e,t){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=t,this.passConvert=null,this.texture=null,this.passDualParaboloidMap=null,this},setSize:function(e,t){this.width="string"==typeof e?parseInt(e):e,this.height="string"==typeof t?parseInt(t):t},setEnvMap:function(t){if(this.texture=t,this.texture instanceof e.Texture){var a=parseInt(this.texture.image.width),s=parseInt(this.texture.image.height);this.width=a,this.height=s}if(this.composers[0])this.composers[0].setSize(this.width,this.height);else{var o=new e.WebGLRenderTargetProperties(this.width,this.height,"iblLinear");o.generateMipmaps=!1,o.mapping=e.LatLongReflectionMapping,this.composers[0]=new i(this.renderer,o,this.renderTargetPool),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.noIdCheck=!0;var l=this.texture.sRGB?n.ConvertLatLongToDualParaboloidsRGB:n.ConvertLatLongToDualParaboloid;this.texture instanceof i||this.texture.rgbHdr||(l=this.texture.sRGB?n.ConvertLatLongRGBEToDualParaboloidsRGB:n.ConvertLatLongRGBEToDualParaboloid),this.passConvert=new r({defines:{SCALE:1.2},uniforms:l.uniforms,vertexShader:l.vertexShader,fragmentShader:l.fragmentShader},void 0,"Convert"),this.composers[0].addPass(this.passConvert)}this.texture instanceof e.Texture||this.texture instanceof e.WebGLRenderTarget?this.passConvert.uniforms.map.value=this.texture:this.texture.linkToShaderPassUniform(this.passConvert,this.passConvert.uniforms.map),this.passConvert.uniforms.size.value=new e.Vector2(this.width,this.height)},execute:function(){this.composers[0].render()}})}),define("DS/Shaders/TAAShaders",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return{TAA:{defines:{FEEDBACK_MIN:.88,FEEDBACK_MAX:.97},uniforms:{screenSize:{type:"v2",value:new e.Vector2(512,512)},tNormalDepth:{type:"t",value:null},tDiffuse:{type:"t",value:null},prevMap:{type:"t",value:null},numIteration:{type:"f",value:0},previousViewProjectionMatrix:{type:"m4",value:new e.Matrix4},currentViewProjectionMatrix:{type:"m4",value:new e.Matrix4},currentProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},currentViewMatrixInverse:{type:"m4",value:new e.Matrix4}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["#define NEIGHBOUR_SET_IF_DMIN_Z_GREATER(d, x, y) if(d < dmin.z) dmin = vec3(x, y, d);","#define NEIGHBOUR_CREATE_FROM_OFFSET(d, x, y) d = texture2D(tNormalDepth, uv + vec2(x,y)).w; if (d < 0.1) d = 1.0;","#define FIND_NEIGHBOUR_MIN(d, x, y) NEIGHBOUR_CREATE_FROM_OFFSET(d, x, y); NEIGHBOUR_SET_IF_DMIN_Z_GREATER(d, x, y)","#define CLOSEST_9TAP","uniform vec2 screenSize;","uniform sampler2D tNormalDepth;","uniform sampler2D tDiffuse;","uniform sampler2D prevMap;","uniform float numIteration;","uniform mat4 previousViewProjectionMatrix;","uniform mat4 currentViewProjectionMatrix;","uniform mat4 currentProjectionMatrixInverse;","uniform mat4 currentViewMatrixInverse;","varying vec2 vUv;","float luminance_RGB(vec3 iColor) {","   vec3 luminance_weight = vec3(0.176204, 0.812985, 0.0108109);","   return dot(iColor, luminance_weight);","}","vec3 getPositionWS(vec3 ndc) {","   vec4 vertexPositionProjected = vec4(ndc, 1.0);","   vec4 vertexPositionVS = currentProjectionMatrixInverse * vertexPositionProjected;","   vertexPositionVS.xyz /= vertexPositionVS.w;","   vertexPositionVS.w = 1.0;","   return (currentViewMatrixInverse * vertexPositionVS).xyz;","}","vec3 closestFragment(vec2 uv, vec2 texelSize) {","    float d;","    vec2 size = 2.0 * texelSize;","    vec3 dmin = vec3(0.0, 0.0, 0.0);","    NEIGHBOUR_CREATE_FROM_OFFSET(dmin.z, 0.0, 0.0);","    FIND_NEIGHBOUR_MIN(d, -size.x, size.y);","    FIND_NEIGHBOUR_MIN(d, size.x, size.y);","    FIND_NEIGHBOUR_MIN(d, -size.x, -size.y);","    FIND_NEIGHBOUR_MIN(d, size.x, -size.y);","    #ifdef CLOSEST_9TAP","        FIND_NEIGHBOUR_MIN(d, 0.0, size.y);","        FIND_NEIGHBOUR_MIN(d, -size.x, 0.0);","        FIND_NEIGHBOUR_MIN(d, size.x, 0.0);","        FIND_NEIGHBOUR_MIN(d, 0.0, -size.y);","    #endif","    return vec3(uv + dmin.xy, dmin.z);","}","vec4 clip_aabb_opti(const in vec4 minimum, const in vec4 maximum, const in vec4 color) {","    const float eps = 0.00000001;","    vec4 center = 0.5 * (maximum + minimum);","    vec4 extents = 0.5 * (maximum - minimum) + eps;","    vec4 offset = color - center;","    vec4 ts = abs(offset / extents);","    float t = max(max(ts.r, ts.g), max(ts.b, ts.a));","    return center + offset / max(1.0, t);","}","vec4 taa(const in vec2 ssVel, const in vec2 texelSize) {","    vec4 tl = texture2D(tDiffuse, vUv + vec2(-texelSize.x, texelSize.y));","    vec4 t  = texture2D(tDiffuse, vUv + vec2(0.0, texelSize.y));","    vec4 tr = texture2D(tDiffuse, vUv + vec2(texelSize.x, texelSize.y));","    vec4 ml = texture2D(tDiffuse, vUv + vec2(-texelSize.x, 0.0));","    vec4 m  = texture2D(tDiffuse, vUv);","    vec4 mr = texture2D(tDiffuse, vUv + vec2(texelSize.x, 0.0));","    vec4 bl = texture2D(tDiffuse, vUv + vec2(-texelSize.x, -texelSize.y));","    vec4 b  = texture2D(tDiffuse, vUv + vec2(0.0, -texelSize.y));","    vec4 br = texture2D(tDiffuse, vUv + vec2(texelSize.x, -texelSize.y));","    vec4 corners = 2.0 * (tr + bl + br + tl) - 2.0 * m;","    m += (m - (corners * 0.166667)) * 2.718282 * 0.3;","    m = max(vec4(0.0), m);","    vec4 cmin5 = min(mr, min(m, min(ml, min(t, b))));","    vec4 cmin = min(cmin5, min(tl, min(tr, min(bl, br))));","    vec4 cmax5 = max(mr, max(m, max(ml, max(t, b))));","    vec4 cmax = max(cmax5, max(tl, max(tr, max(bl, br))));","    cmin = 0.5 * (cmin + cmin5);","    cmax = 0.5 * (cmax + cmax5);","    vec4 previousColor = texture2D(prevMap, vUv - ssVel);","    previousColor = clip_aabb_opti(cmin, cmax, previousColor);","    float lum0 = luminance_RGB(m.rgb);","    float lum1 = luminance_RGB(previousColor.rgb);","    float diff = abs(lum0 - lum1) / max(lum0, max(lum1, 0.2));","    float unbiased_weight = 1.0 - diff;","    float feedback = mix(FEEDBACK_MIN, FEEDBACK_MAX, unbiased_weight * unbiased_weight);","    return mix(m, previousColor, feedback);","}","vec2 computeSSVelocity(const in vec3 wsPos) {","    vec4 ssCurrentPos = currentViewProjectionMatrix * vec4(wsPos, 1.0);","    vec4 ssPrevPos =   previousViewProjectionMatrix * vec4(wsPos, 1.0);","    vec2 ndcCurrent = ssCurrentPos.xy / ssCurrentPos.w;","    vec2 ndcPrev = ssPrevPos.xy / ssPrevPos.w;","    if(ndcPrev.x >= 1.0 || ndcPrev.x <= -1.0 || ndcPrev.x >= 1.0 || ndcPrev.y <= -1.0) {","        return vec2(0.0);","    }","    return 0.5 * (ndcCurrent - ndcPrev);","}","void main() {","if (numIteration > 0.0) {","   vec4 prevColor = texture2D( prevMap, vUv );","   vec4 currColor = texture2D( tDiffuse, vUv );","   gl_FragColor = vec4((prevColor * numIteration + currColor) / (numIteration + 1.0));","   return;","}","vec2 texelSize = vec2(1.0) / screenSize;","vec3 closest = closestFragment(vUv, texelSize);","if (closest.z == 0.0) {","   gl_FragColor = texture2D( tDiffuse, vUv );","   return;","}","vec3 ws = getPositionWS(2.0 * closest - 1.0);","vec2 ssVel = computeSSVelocity(ws);","gl_FragColor = taa(ssVel, texelSize);","}"].join("\n")},Transfer:{uniforms:{tDiffuse:{type:"t",value:null},tDiffuse2:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse2;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse2, vUv );","}"].join("\n")}}}),define("DS/Shaders/PreComputeShaders",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=["#define CLAMP_VALUE 1000.0","uniform sampler2D tEnvMap;","uniform float roughness;","const float PI = 3.14159265358979323846264;","varying vec2 vUv;","#define INV_GOLDEN_RATIO 0.6180339887","float ComputeIndex(float id, float N) {","float val = id * N * 24.0;","float n = val / N;","float m = mod(val, N);","return n + m;","}","vec2 LowDiscrepancy2D(float i, float N)","{","float id = ComputeIndex(i, N);","return vec2(fract((id + 0.5) / N* INV_GOLDEN_RATIO), fract(id * INV_GOLDEN_RATIO));","}","vec2 vLogComplex(in float value) {","float real = log(abs(value));","float im = atan(0.0,value);","return vec2(real,im);","}","vec2 invComplex(in vec2 value) {","return vec2(value.x,-value.y)/(value.x * value.x + value.y * value.y);","}","float AshikminDistribution(in float NoH, in float sheenValue) {","float cosine2 = max(NoH * NoH,1e-6);","float sine2 = max(1.0-cosine2,1e-6);","float D = 1.0;","float normalisationTerm = 1.0;","float a2 = sheenValue * sheenValue;","normalisationTerm *= 1.0/(4.0*a2+1.0);","float sine4 = max(sine2 * sine2,1e-6);","float cotan2 = cosine2/sine2;","float value = -cotan2 / a2;","D = 1.0+4.0 * exp(value)/ sine4;","return D * normalisationTerm;","}","vec3 GetLightVector(in vec3 N, in vec3 H) {","#if MODE == 3","return H;","#else","return 2.0 * dot(N, H) * H - N;","#endif","}","float GetWeight(in float NoL) {","#if MODE != 0 && MODE != 3","return NoL > 0.0 ? 1.0 : 0.0;","#else","return NoL > 0.0 ? NoL : 0.0;","#endif","}","vec3 ImportanceSample(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * PI * Xi.x;","#if MODE == 0","float a = roughness * roughness;","float a2 = a*a;","float CosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a2 - 1.0) * Xi.y));","float SinTheta = sqrt(1.0 - CosTheta * CosTheta);","#endif","#if MODE == 2","float a = roughness * roughness;","float a2 = a*a;","float loga = 8.0*a2*log(1.0-Xi.y);","float value = loga / (loga - 1.0);","float SinTheta = sqrt(value);","float CosTheta = sqrt(1.0 - value);","#endif","#if MODE == 3 || MODE == 1","float value = Xi.y;","float SinTheta = sqrt(value);","float CosTheta = sqrt(1.0 - value);","#endif","#if MODE == 4","float a = roughness;","a = max(a, 1e-3);","float SinTheta = pow(Xi.y, a / (2.0 * a + 1.0));","float CosTheta = sqrt(1.0 - SinTheta*SinTheta);","#endif","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return H;","}","vec3 TangentToWorld(vec3 Vec, vec3 TangentZ) {","vec3 UpVector = abs(TangentZ.z) < 0.999 ? vec3(0,0,1) : vec3(1,0,0);","vec3 TangentX = normalize(cross(UpVector, TangentZ));","vec3 TangentY = cross(TangentZ, TangentX);","return TangentX * Vec.x + TangentY * Vec.y + TangentZ * Vec.z;","}","float computeLODFromDirection(vec3 dir, float pdf) {","float d = 2.0 * DP_SCALE;","d *= (1.0 + abs(dir.z));","d *= d;","float lod = 0.5 * log2(pdf * d);","return max(LOD_CST - lod, 0.0);","}","vec3 sampleLatLongFromLocation(vec3 dir) {","float theta = acos(dir.z);","float phi = atan(dir.y, dir.x);","float u = 0.5 + 0.5 * phi / PI;","float v = theta / PI;","vec4 texelRGBE = texture2D(tEnvMap, vec2(u, v));","return texelRGBE.rgb * pow(2.0, 255.0 * texelRGBE.w - 128.0);","}","vec4 ImportanceSamplePDF(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * PI * Xi.x;","float D = 0.0;","float normalisationTerm = 1.0/PI;","#if MODE == 0","float a = roughness * roughness;","float a2 = a*a;","float CosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a2 - 1.0) * Xi.y));","float SinTheta = sqrt(1.0 - CosTheta * CosTheta);","float d = (a2 - 1.0) * CosTheta*CosTheta + 1.0;","D = a2 / (PI * d * d);","#endif","#if MODE == 2","float a = roughness * roughness;","float a2 = a*a;","float loga = 8.0*a2*log(1.0-Xi.y);","float value = loga / (loga - 1.0);","float SinTheta = sqrt(value);","float CosTheta = sqrt(1.0 - value);","float cosine2 = max(CosTheta*CosTheta,1e-6);","float sine2 = max(SinTheta*SinTheta,1e-6);","normalisationTerm *= 1.0/(8.0*a2);","float cosine4 = max(cosine2 * cosine2,1e-6);","float tan2 = sine2/cosine2;","float value2 = -tan2/(a2*8.0);","D = exp(value2) / cosine4 ;","D *= normalisationTerm ;","#endif","#if MODE == 3 || MODE == 1","float value = Xi.y;","float SinTheta = sqrt(value);","float CosTheta = sqrt(1.0 - value);","D = normalisationTerm;","#endif","#if MODE == 4","float a = roughness;","a = max(a, 1e-3);","float SinTheta = max(pow(Xi.y, a / (2.0 * a + 1.0)),1e-3);","float CosTheta = sqrt(1.0 - SinTheta*SinTheta);","normalisationTerm *= 0.5;","D = (2.0 + 1.0 / a) * pow(SinTheta, 1.0 / a) ;","D *= normalisationTerm ;","#endif","float PDF = D * CosTheta;","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return vec4(H, PDF);","}","vec3 sampleDualParaboloidFromLocation(vec3 dir, float lod) {","vec2 st = vec2(0.5);","if (dir.z < 0.0) {","st *= 0.5 * (1.0 - dir.xy / (DP_SCALE * (1.0 - dir.z)));","} else {","st *= 0.5 * (1.0 + dir.xy / (DP_SCALE * (1.0 + dir.z)));","st.x += 0.5;","}","float mipValue = floor(lod);","float mipNextValue = mipValue + 1.0;","float mipCoef = fract(lod);","if (lod >= float(MAX_LOD)) {","mipValue = float(MAX_LOD);","mipNextValue = float(MAX_LOD);","mipCoef = 1.0;","}","vec3 color1;","vec3 color2;","vec2 uv1 = st;","vec2 uv2 = st;","float scale1 = pow(2.0, -mipValue);","float scale2 = pow(2.0, -mipNextValue);","uv1 *= scale1;","uv2 *= scale2;","uv1.y += 1.0 - scale1;","uv2.y += 1.0 - scale2;","color1 = texture2D(tEnvMap, uv1).xyz;","color2 = texture2D(tEnvMap, uv2).xyz;","return mix(color1, color2, mipCoef);","}","vec3 GetFilteredColor(in vec3 L, in vec4 perturbedZ_PDF, in vec3 H, in vec3 N, in float roughness, in float NoL) {","#if MODE == 3","float lod = computeLODFromDirection(L, perturbedZ_PDF.w);","#else","float lod = computeLODFromDirection(L, perturbedZ_PDF.w/ (4.0 * clamp(dot(L,H),1e-6,1.0)));","#endif","vec3 filteredColor = min(sampleDualParaboloidFromLocation(L, lod),vec3(CLAMP_VALUE));","#if MODE == 1","filteredColor *= AshikminDistribution(clamp(dot(N,H),1e-6,1.0), roughness);","#endif","return filteredColor;","}"].join("\n");return{ComputeMipMapRoughness:{defines:{NB_SAMPLES:256,DP_SCALE:1.2,MODE:0,MAX_LOD:9},uniforms:{tEnvMap:{type:"t",value:null},roughness:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:[t,"vec3 prefilterEnvMap(float roughness, vec3 N, vec2 UV) {","vec3 filteredColor;","float weight = 0.0;","for (int i = 0; i < NB_SAMPLES; i++) {","vec2 E = LowDiscrepancy2D(i,NB_SAMPLES);","vec3 perturbedZ = ImportanceSample(E, roughness);","vec3 H = TangentToWorld(perturbedZ, N);","vec3 L = GetLightVector(N,H);","float NoL = clamp(dot(N, L), 0.0, 1.0);","float w = GetWeight(NoL);","filteredColor += w * min(sampleLatLongFromLocation(L), vec3(CLAMP_VALUE));","weight += w;","}","return filteredColor / max(weight, 0.001);","}","void main() {","gl_FragColor = vec4(0.0);","float phi = PI * (2.0 * vUv.x - 1.0);","float theta = PI * vUv.y;","vec3 N;","N.x = sin(theta) * cos(phi);","N.y = sin(theta) * sin(phi);","N.z = cos(theta);","gl_FragColor = vec4(prefilterEnvMap(roughness, N, vUv), 1.0);","}"].join("\n")},ComputeMipMapRoughnessFIS:{defines:{NB_SAMPLES:256,DP_SCALE:1.2,LOD_CST:7.707519,MODE:0,MAX_LOD:9},uniforms:{tEnvMap:{type:"t",value:null},roughness:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:[t,"vec3 prefilterEnvMap(float roughness, vec3 N, vec2 UV) {","vec3 filteredColor;","float weight = 0.0;","for (int i = 0; i < NB_SAMPLES; i++) {","vec2 E = LowDiscrepancy2D(float(i),float(NB_SAMPLES));","vec4 perturbedZ_PDF = ImportanceSamplePDF(E, roughness);","vec3 H = TangentToWorld(perturbedZ_PDF.xyz, N);","vec3 L = GetLightVector(N,H);","float NoL = clamp(dot(N, L), 0.0, 1.0);","float w = GetWeight(NoL);","filteredColor += w * GetFilteredColor(L, perturbedZ_PDF, H, N, roughness, NoL);","weight += w;","}","return filteredColor / max(weight, 0.001);","}","void main() {","gl_FragColor = vec4(0.0);","float phi = PI * (2.0 * vUv.x - 1.0);","float theta = PI * vUv.y;","vec3 N;","N.x = sin(theta) * cos(phi);","N.y = sin(theta) * sin(phi);","N.z = cos(theta);","gl_FragColor = vec4(prefilterEnvMap(roughness, N, vUv), 1.0);","}"].join("\n")},ComputeMipMapRoughnessIterative:{defines:{NB_SAMPLES:256,NB_SAMPLES_IT:256,DP_SCALE:1.2,LOD_CST:7.707519,MODE:0,MAX_LOD:9},uniforms:{prevMap:{type:"t",value:null},tEnvMap:{type:"t",value:null},roughness:{type:"f",value:0},firstSample:{type:"i",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D prevMap;","uniform int firstSample;",t,"vec4 prefilterEnvMap(float roughness, vec3 N, vec2 UV) {","vec3 filteredColor;","float weight = 0.0;","for (int i = 0; i < NB_SAMPLES_IT; i++) {","float newI = float(firstSample + i);","vec2 E = LowDiscrepancy2D(newI,float(NB_SAMPLES));","vec4 perturbedZ_PDF = ImportanceSamplePDF(E, roughness);","vec3 H = TangentToWorld(perturbedZ_PDF.xyz, N);","vec3 L = GetLightVector(N,H);","float NoL = clamp(dot(N, L), 0.0, 1.0);","float w = GetWeight(NoL);","filteredColor +=  w * GetFilteredColor(L, perturbedZ_PDF, H, N, roughness, NoL);","weight += w;","}","return vec4(filteredColor / max(weight, 0.001),max(weight, 0.001));","}","void main() {","gl_FragColor = vec4(0.0);","float phi = PI * (2.0 * vUv.x - 1.0);","float theta = PI * vUv.y;","vec3 N;","N.x = sin(theta) * cos(phi);","N.y = sin(theta) * sin(phi);","N.z = cos(theta);","vec4 prevTex = texture2D(prevMap, vUv);","vec4 res = prefilterEnvMap(roughness, N, vUv);","gl_FragColor = vec4((prevTex.rgb * prevTex.a + res.rgb * res.a) / (prevTex.a + res.a), prevTex.a + res.a);","}"].join("\n")}}}),define("DS/Plugins/UserClearPass",["DS/Plugins/UserPass","DS/Plugins/ClearPass"],function(e,t){return e.extend({init:function(e){this._parent(e);var i=new t("_UserClearPass_"+this.id+"_"+this.name);i.defaults.clear=!1,i.clear=!1,this._passes.push(i)},setClearDepth:function(e){this._passes[0].defaults.doClearDepth=!!e},setClearStencil:function(e,t){void 0!==t&&(this._passes[0].clearStencilValue=t),this._passes[0].clearStencil=e}})}),define("DS/Plugins/UserPassManager",["UWA/Class","DS/Plugins/UserRenderPass","DS/Plugins/UserClearPass","DS/Plugins/UserRenderList","DS/Plugins/UserPass","DS/Plugins/UserSceneGraphPass"],function(e,t,i,r,n,a){"use strict";var s=e.extend({init:function(e){this.viewer=e,this._activeUserPasses=[],this._activeRenderLists=null,this._updateRenderLists()},createUserRenderPass:function(e,i){var r=new t({manager:this,name:e,renderList:i});return i&&this._setUserPassRenderList(r,i),r},createUserClearPass:function(e,t){var r=new i({manager:this,name:e,renderList:t});return t&&this._setUserPassRenderList(r,t),r},createUserSceneGraphPass:function(e,t){var i=new a({manager:this,name:e,renderList:t});return t&&this._setUserPassRenderList(i,t),i},getSystemPass:function(e){return o[e]||null},insertUserPassAfterPass:function(e,t){var i;e._systemPass?console.warn("ERROR: Invalid arguments"):e._inserted?console.warn("ERROR: Already inserted pass"):(t instanceof n?(i=t._passes[t._passes.length-1],e._setCameraName(t._cameraName)):(i=t._list,e._setCameraName(t._cameraName)),this._getMainComposer().insertCustomPassAfterNEW(e._passes,i)&&(e._inserted=!0,this._activeUserPasses.push(e),this._updateRenderLists()))},insertUserPassBeforePass:function(e,t){var i;e._systemPass?console.warn("ERROR: Invalid arguments"):e._inserted?console.warn("ERROR: Already inserted pass"):(t instanceof n?(i=t._passes[0],e._setCameraName(t._cameraName)):(i=t._list,e._setCameraName(t._cameraName)),this._getMainComposer().insertCustomPassBeforeNEW(e._passes,i)&&(e._inserted=!0,this._activeUserPasses.push(e),this._updateRenderLists()))},removeUserPass:function(e){var t=this._activeUserPasses.indexOf(e);t>=0&&(this._getMainComposer().removeCustomPassNEW(e._passes),this._activeUserPasses.splice(t,1),e._inserted=!1,this._updateRenderLists())},_setUserPassRenderList:function(e,t){var i;for(i=0;i<e._passes.length;i++)e._passes[i].idString=t._getIdString()},_updateRenderLists:function(){var e,t;for(this._activeRenderLists=["main","noz","noEffectNoz","afterHighlightNoZ","dialog","furtive","onTop"],e=0;e<this._activeUserPasses.length;e++)if((t=this._activeUserPasses[e]).renderList&&t.enabled){var i=t.renderList._getIdString();this._activeRenderLists.indexOf(i)<0&&this._activeRenderLists.push(i)}},_getActiveRenderLists:function(){return this._activeRenderLists},_getMainComposer:function(){return this.viewer.renderer.mainComposer},_dispose:function(){this.viewer=null,this._activeUserPasses=null,this._activeRenderLists=null}}),o={infinitePlane:{_list:"infPlane",_systemPass:!0,_cameraName:"main"},main:{_list:"main",_systemPass:!0,_cameraName:"main"},noz:{_list:"noz",_systemPass:!0,_cameraName:"main"},noEffectNoz:{_list:"noEffectNoz",_systemPass:!0,_cameraName:"mainNoJittering"},afterHighlightNoz:{_list:"afterHighlightNoz",_systemPass:!0,_cameraName:"mainNoJittering"},robot:{_list:"robot",_systemPass:!0,_cameraName:"mainNoJittering"},canvas2D:{_list:"canvas2D",_systemPass:!0,_cameraName:"mainNoJittering"},dialog:{_list:"dialog",_systemPass:!0,_cameraName:"mainNoJittering"},onTop:{_list:"onTop",_systemPass:!0,_cameraName:"mainNoJittering"},furtive:{_list:"furtive",_systemPass:!0,_cameraName:"mainNoJittering"}};return s}),define("DS/Effects/ComputeMipMapRoughness",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/PreComputeShaders","DS/Shaders/DisplayMipsRoughnessShader","DS/Shaders/EncodeHDRShader","DS/Shaders/FlipXShader"],function(e,t,i,r,n,a,s,o){"use strict";var l=t.extend({init:function(t,i){return this._parent(t),this.gl=this.renderer.context,this.renderTargetPool=i,this.nbSamples=64,this.nbIterations=32,this._nbSamplerPerIteration=e._mobileDevice?4:e.IsIE11?2:32,this._sizeRatio=e._mobileDevice?.5:1,this.passFilterEnvMap=[],this.passMergeMips=null,this.passFlipX=null,this.modeValue=0,this.shader=null,this.texture=null,this.nbMipMaps=7,this.inputLods=10,this},setSize:function(t,i){this.width="string"==typeof t?parseInt(t):t,this.height="string"==typeof i?parseInt(i):i,this.inputLods=Math.min(Math.round(Math.log(Math.min(this.width,this.height))/Math.log(2)),e.supportedExtensions.fragmentTextureUnits)},_updatePassFilter:function(e){var t=this.getCoeff(e+1);this.passFilterEnvMap[e].material.defines.NB_SAMPLES=t*this.nbSamples,this.passFilterEnvMap[e].material.defines.NB_SAMPLES_IT=t*this._nbSamplerPerIteration,this.passFilterEnvMap[e].uniforms.tEnvMap.value=this.texture,this.passFilterEnvMap[e].material.defines.MAX_LOD=this.inputLods,this.passFilterEnvMap[e].material.defines.MODE=6===e?3:this.modeValue,this.passFilterEnvMap[e].material.defines.LOD_CST=(.5*Math.log(this.width*this.height/(t*this.nbSamples))/Math.log(2)).toFixed(8),this.passFilterEnvMap[e].material.needsUpdate=!0,this.passFilterEnvMap[e].uniforms.roughness.value=this.getRoughness(e+1)},setNbSamples:function(e){this.nbSamples=e,this.nbIterations=this.nbSamples/this._nbSamplerPerIteration;for(var t=1;t<=this.nbMipMaps;t++)this._updatePassFilter(t-1)},getCoeff:function(e){return 1===this.modeValue||4===this.modeValue?e<3?3:2:e>3?4:1},getRoughness:function(e){var t=0;switch(this.modeValue){case 0:case 3:t=Math.pow(2,(e-6)/1.15);break;case 1:case 4:t=1-(e-1)/5;break;case 2:t=(e-1)/5;break;default:throw"invalid mode in compute mip map roughness effect"}return t},setMode:function(t){switch(this.modeValue=0,t){case e._BRDFS.ASHIKMIN:this.modeValue=1;break;case e._BRDFS.BECKMANN:this.modeValue=2;break;case e._BRDFS.ESTEVEZKULLA:this.modeValue=4}for(var i=1;i<=this.nbMipMaps;i++)this._updatePassFilter(i-1)},setInput:function(t){if(!this.texture){this.texture=t,this.hasOwnProperty("iter")&&(this.iter=0);for(var n=[1,1,.5,.5,.25,.25,.25,.25],a=1;a<=this.nbMipMaps;a++){var s=a-1,o=this._sizeRatio*n[a]*this.width,l=this._sizeRatio*n[a]*this.height;if(this.composers[s])this.composers[s].setSize(o,l);else{var c=new e.WebGLRenderTargetProperties(o,l,"iblLinear");c.generateMipmaps=!1,c.mapping=this.texture.mapping,this.composers[s]=new i(this.renderer,c,this.renderTargetPool),this.composers[s].composerContext.keepResult=!0,this.composers[s].composerContext.noIdCheck=!0;var h={};Object.assign(h,this.shader),this.passFilterEnvMap[s]=new r(h),this.composers[s].addPass(this.passFilterEnvMap[s])}this._updatePassFilter(s)}this.setComposers()}},setComposers:function(){var t=this.nbMipMaps;if(this.composers[t])this.composers[t].setSize(this._sizeRatio*this.width,2*this._sizeRatio*this.height);else{var n=new e.WebGLRenderTargetProperties(this._sizeRatio*this.width,2*this._sizeRatio*this.height,"uintNearest");n.generateMipmaps=!1,this.composers[t]=new i(this.renderer,n,this.renderTargetPool),this.composers[t].composerContext.keepResult=!0,this.composers[t].composerContext.noIdCheck=!0,this.passMergeMips=new r(a.MergeMipsRGBE),this.passMergeMips.renderToScreen=!1,this.passFlipX=new r(o),this.composers[t].addPass(this.passMergeMips),this.composers[t].addPass(this.passFlipX);for(var s=1;s<=this.nbMipMaps;s++){var l=s-1;this.composers[l].linkToShaderPassUniform(this.passMergeMips,this.passMergeMips.uniforms["tDiffuse"+s])}}},dispose:function(){t.prototype.dispose.call(this),this.texture&&this.texture.dispose()},_saveResult:function(){var t=this._sizeRatio*this.width,i=2*this._sizeRatio*this.height,r=new Uint8Array(t*i*4);this.gl.readPixels(0,0,t,i,this.gl.RGBA,this.gl.UNSIGNED_BYTE,r);var n=e.ImageUtils.streamHDRFormat(r,t,i),a=URL.createObjectURL(n),s=document.createElement("a");s.download="generated_rmips.hdr",s.href=a,e._DownloadGeneratedRoughnessMaps&&s.click()}});return{ComputeMipMapRoughnessFIS:l.extend({init:function(e,t){return this._parent(e,t),this.shader=n.ComputeMipMapRoughnessFIS,this},execute:function(e){if(void 0!==e)this.composers[e].render();else{for(var t=0;t<this.nbMipMaps;t++)this.modeValue>0&&6===t||this.execute(t);this.composers[this.nbMipMaps].render()}}}),ComputeMipMapRoughnessIterative:l.extend({init:function(t,i){this._parent(t,i),this.iter=0,this.shader=n.ComputeMipMapRoughnessIterative;for(var r=new Uint8Array(16),a=0;a<16;a++)r[a]=0;return this.initTexture=new e.DataTexture(r,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter),this.initTexture.generateMipmaps=!1,this.initTexture.needsUpdate=!0,this.renderer.setTexture(this.initTexture,0),this},execute:function(e){if(!(this.iter>=this.nbIterations)){var t=this.iter;if(void 0!==e){var i=this.composers[e].composerContext.getResult(void 0,!0);this.passFilterEnvMap[e].uniforms.prevMap.value=t?i:this.initTexture,this.passFilterEnvMap[e].uniforms.firstSample.value=t*this.passFilterEnvMap[e].defines.NB_SAMPLES_IT,this.composers[e].render(),i&&(t===this.nbIterations-1?i.dispose():this.renderTargetPool.pushRenderTarget(i))}else{for(var r=0;r<this.nbMipMaps;r++)this.modeValue>0&&6===r||this.execute(r);this.iter++,this.composers[this.nbMipMaps].render()}}}})}}),define("DS/Visualization/AmbianceGenerator",["DS/CoreEvents/Events","UWA/Class","DS/Effects/ConvertLatLongToDualParaboloid","DS/Effects/GenerateMipMaps","DS/Effects/ComputeMipMapRoughness","DS/Visualization/ThreeJS_R57"],function(e,t,i,r,n,a){"use strict";var s=a._AmbianceGenerators,o=t.extend({init:function(t,n){this.nbSamples=n,this.onDoneCallBack=null,this.texture=null,this.mode=null,a.EventDispatcher.call(this),this.finished=!1;var o=this;this.addEventListener("done",function(t){t.isDone&&s.viewers.forEach(function(e){e.render()}),t.isDone&&(a.VisualizationTraces.info("INFO: Finished computing ambiance"),e.publish({event:"/VISU/IBLComputed",data:{eventChannel:"/VISU/IBLComputed",eventType:"@onIBLComputed"}})),o.onDoneCallBack&&t.isDone&&o.onDoneCallBack()}),this.renderer=t.renderer.renderer,this.convertEffect=new i(this.renderer,t.renderer.renderTargetPool),this.mipMapEffect=new r(this.renderer,t.renderer.renderTargetPool),this.computeEffect=null,this.frameIndex=0,this.init=!1},dispose:function(){this.convertEffect.dispose(),this.convertEffect=null,this.mipMapEffect.dispose(),this.mipMapEffect=null,this.computeEffect.dispose(),this.computeEffect=null,this.init=!1},_setNbSamples:function(){console.warn("A virtual function has been called")},setValues:function(e,t){if(e){this.texture=e;var i=e.composerContext&&e.composerContext.width,r=e.composerContext&&e.composerContext.height;if(e instanceof a.Texture){if(e.loadEndStatus!==a.AssetLoadingStatus.READY)return;i=e.image.width,r=e.image.height}else e instanceof a.WebGLRenderTarget&&(i=e.width,r=e.height);this.convertEffect.setSize(i,r),this.mipMapEffect.setSize(i,r),this.computeEffect.setSize(i,r),this.convertEffect.setEnvMap(e),this.mipMapEffect.setInput(this.convertEffect.composers[0]),this.mode=t,this.init=!0}},_execute:function(e){this.init&&(e&&(this.convertEffect.execute(),this.mipMapEffect.execute(),this.computeEffect.setInput(this.mipMapEffect.getResult().composerContext.getResult(void 0,!0)),this._setNbSamples(),this.computeEffect.setMode(this.mode)),this.computeEffect.execute())},_getResult:function(){if(!this.init)return{};var e=this.isDone();e&&a._SaveGeneratedRoughnessMaps&&this.computeEffect._saveResult();var t=this.computeEffect.composers[this.computeEffect.nbMipMaps].composerContext.getResult(void 0,e);return t&&(t.hdr=!0,t.hasDiffuse=0===this.computeEffect.modeValue,t.mapping=new a.LatLongReflectionMapping),t},setCallBack:function(e){this.onDoneCallBack=e},isDone:function(){return this.finished}}),l=o.extend({init:function(e,t){this._parent(e,t),this.computeEffect=new n.ComputeMipMapRoughnessFIS(this.renderer,e.renderer.renderTargetPool)},_isExecuteReady:function(){var e=!this.texture.loadEndStatus||this.texture.loadEndStatus===a.AssetLoadingStatus.READY;return s.viewers.forEach(function(t){e=e&&!t._renderingToTarget}),e},execute:function(){var e=Date.now(),t=this._isExecuteReady();return t&&(this._execute(!0),this.finished=!0,this.dispatchEvent({type:"done",time:e,isDone:this.isDone()})),t?this._getResult():null},_setNbSamples:function(){this.computeEffect.setNbSamples(this.nbSamples)}}),c=o.extend({init:function(e,t){this._parent(e,t),this.timeFactor=a._mobileDevice?1.5:1,this.computeEffect=new n.ComputeMipMapRoughnessIterative(this.renderer,e.renderer.renderTargetPool)},_isExecuteReady:function(e){var t=0===this.computeEffect.iter||!this.texture.loadEndStatus||this.texture.loadEndStatus===a.AssetLoadingStatus.READY,i=this;return s.viewers.forEach(function(r){t=t&&!r._QMMode&&r.renderIteration>0&&e-r.timeIter0>i.timeFactor*r.delayBeforeIteration&&!r._renderingToTarget}),t},execute:function(){var e=Date.now(),t=this._isExecuteReady(e);return t&&(this._execute(0===this.computeEffect.iter),this.finished=this.computeEffect.iter>=this.computeEffect.nbIterations,this.dispatchEvent({type:"done",time:e,iteration:this.computeEffect.iter,isDone:this.isDone()})),t?this._getResult():null},_setNbSamples:function(){this.computeEffect.setNbSamples(this.nbSamples)}});return t.extend({init:function(e){this.generators=new Map,this.generated=new Map,this.toCompute=[],this.cb=e},_getViewer:function(){return s.viewers[0]},_getGenerator:function(e,t){if(t&&(e+="-iterative"),!this.generators.has(e)){var i=this._getViewer(),r=t?new c(i,512):new l(i,512);this.cb&&r.setCallBack(this.cb),this.generators.set(e,r)}return this.generators.get(e)},_getAmbiance:function(e,t){return t&&(e+="-iterative"),this.generated.get(e)},_updateAmbiance:function(e,t,i,r,n){i&&(t+="-iterative"),this.generated.set(t,{ambiance:e,complete:r,usedBy:n})},_disposeGenerator:function(e,t){if(t&&(e+="-iterative"),this.generators.has(e)){var i=this.generators.get(e);this.generators.delete(e),i.dispose()}},_setCB:function(e){this.cb=e,this.generators.forEach(function(t,i,r){t.setCallBack(e)})},getAmbiance:function(e,t,i,r){var n=e;t&&(e+="-iterative"),this.generated.has(e)||(this.generated.set(e,{ambiance:s._dummyRoughnessTexture,complete:!1,usedBy:new Set}),this.toCompute.push({name:n,iterative:t,hdr:i.hdr,brdf:i.brdf}));var a=this.generated.get(e);return a.usedBy.add(r),a},keep:function(e){var t=null;return this.generated.forEach(function(i,r,n){i.usedBy.has(e)&&(1!==i.usedBy.size?console.error("Internal roughness map, access refused"):i.ambiance!==dummyTexture&&i.ambiance.complete?(i.usedBy.delete(e),t=i.ambiance,n.delete(r)):console.error("Roughness map not finished, access refused"))}),t},decreaseUseCount:function(e){if(e){var t=this;this.generated.forEach(function(i,r,n){if(i.usedBy.delete(e),i.usedBy.size<1&&(i.ambiance&&i.ambiance.dispose(),n.delete(r),t.generators.has(r))){var a=t.generators.get(r);t.generators.delete(r),a.dispose()}})}},dispose:function(){this.generated.forEach(function(e,t,i){e.ambiance.dispose()}),this.generated.clear(),this.generators.forEach(function(e,t,i){e.dispose()}),this.generators.clear(),this.toCompute=[]},_needsUpdate:function(){for(var e=this.toCompute,t=0;t<e.length;t++){var i=e[t],r=this._getAmbiance(i.name,i.iterative);if(r&&!r.complete)return!0}return!1},update:function(e,t){for(var i=this.toCompute,r=0,n=!1,a=0;a<i.length;a++){var o=i[a],l=this._getAmbiance(o.name,o.iterative);if(l&&!l.complete){var c=this._getGenerator(o.name,o.iterative);if(c.init||c.setValues(o.hdr,o.brdf),c.init&&c.renderer===t&&c.frameIndex<e&&!c.isDone()){var h=c.execute();h&&(n=!0,this._updateAmbiance(h,o.name,o.iterative,c.isDone(),l.usedBy)),c.frameIndex=e,c.isDone()&&(this._disposeGenerator(o.name,o.iterative),r++)}}else this._disposeGenerator(o.name,o.iterative),r++}return r===i.length&&(this.toCompute=[],this.generators.clear()),s.viewers.forEach(function(e){e.forceRender=!0}),n}})}),define("DS/Plugins/ClearMaskPass",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return null}),define("Plugins/ClearMaskPass",["DS/Plugins/ClearMaskPass","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Plugins/ClearMaskPass"),e}),define("DS/Effects/TAAEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/TAAShaders","DS/Shaders/NothingShader"],function(e,t,i,r,n,a,s){"use strict";return i.extend({init:function(t,i){this._parent(t);var o=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");o.generateMipmaps=!1,this.composers[0]=new r(t,o,i),this.composers[0].composerContext.keepResult=!0,this.passTAA=new n(a.TAA);var l=new n(s);this.composers[0].addPass(this.passTAA),this.composers[0].addPass(l),this.mixPass=new n(a.Transfer,void 0,"MSAAEffect"),this.tmpResult=null,this.renderTargetPool=i;for(var c=new Uint8Array(16),h=0;h<4;h++)c[4*h]=0,c[4*h+1]=0,c[4*h+2]=0,c[4*h+3]=255;this.initTexture=new e.DataTexture(c,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter),this.initTexture.generateMipmaps=!1,this.initTexture.needsUpdate=!0,this.renderer.setTexture(this.initTexture,0),this.maxIteration=128,this.msaaOffset=[];for(var u=0;u<this.maxIteration;u++){var d=e.RandomLib.LowDiscrepancy2D(u);this.msaaOffset.push({x:d.x-.5,y:d.y-.5})}return this.previousViewProjectionMatrix=null,this.currentViewProjectionMatrix=null,this},initEffect:function(e,t){t.getComposer("normalDepth").linkToShaderPassUniform(this.passTAA,this.passTAA.uniforms.tNormalDepth),t.insertComposer(null,this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composers[0])},update:function(t,i,r,n){var a=r._renderedCamera;a.projectionMatrixInverse.getInverse(a.projectionMatrix),a.matrixWorldInverse.getInverse(a.matrixWorld),this.previousViewProjectionMatrix||(this.previousViewProjectionMatrix=new e.Matrix4,this.previousViewProjectionMatrix.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse)),this.passTAA.uniforms.screenSize.value.set(this.width,this.height),this.passTAA.uniforms.numIteration.value=n,this.passTAA.uniforms.prevMap.value=this.composers[0].composerContext.renderTarget2,this.passTAA.uniforms.previousViewProjectionMatrix.value.copy(this.previousViewProjectionMatrix),this.passTAA.uniforms.currentViewProjectionMatrix.value.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse),this.passTAA.uniforms.currentProjectionMatrixInverse.value.copy(a.projectionMatrixInverse),this.passTAA.uniforms.currentViewMatrixInverse.value.copy(a.matrixWorld),this.currentViewProjectionMatrix=this.passTAA.uniforms.currentViewProjectionMatrix.value;var s=this;this.mixPass.beforeRenderCB=function(e){s.tmpResult=s.composers[0].composerContext.getResult("main",!0),s.passTAA.uniforms.prevMap.value=s.tmpResult},this.mixPass.afterRenderCB=function(){s.tmpResult&&(s.renderTargetPool.pushRenderTarget(s.tmpResult),s.tmpResult=null,s.previousViewProjectionMatrix.copy(s.currentViewProjectionMatrix))},n>=this.getMaxIteration()?this.mixPass.requiredComposers=[]:this.mixPass.requiredComposers.length||this.mixPass.addRequiredComposer(this.composers[0])},getMaxIteration:function(){return this.maxIteration},computeJitterCamera:function(e,t){var i=e.clone();i._renderingRole=e._renderingRole;var r=Math.min(this.getMaxIteration()-1,t);return i.updateProjectionMatrix(this.msaaOffset[r].x/this.width,this.msaaOffset[r].y/this.height),i},computeJitterValues:function(t,i){var r=Math.min(this.getMaxIteration()-1,i);return new e.Vector2(this.msaaOffset[r].x/this.width,this.msaaOffset[r].y/this.height)},setSize:function(e,t){this._parent(e,t)&&this.composers[0].setSize(this.width,this.height)}})}),define("DS/Effects/PreHighlightMobileNonEffect",["DS/Visualization/ThreeJS_DS","DS/Plugins/RenderPass","DS/Plugins/ClearPass","DS/Visualization/PickingMode"],function(e,t,i,r){"use strict";return class{constructor(e){this.preHighlightSinglePass=null,this.Canvas2DpreHighlightSinglePass=null,this.renderer=e,this.enabled=!0,this._initPasses()}_initPasses(){var i=this.renderer.mainComposer;this.preHighlightSinglePass=new t(null,null,null,void 0,void 0,void 0,"preHighlightSinglePass"),this.preHighlightSinglePass.setRenderPluginsPre(!1),this.preHighlightSinglePass.setRenderPluginsPost(!1),this.preHighlightSinglePass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.preHighlightSinglePass.setDisableBackFaceCulling(!0),this.preHighlightSinglePass.setDisableDepthTest(!0),this.preHighlightSinglePass.setDisableDepthWrite(!0),this.preHighlightSinglePass.lockScene=!0,i.addPass(this.preHighlightSinglePass),this.Canvas2DpreHighlightSinglePass=new t(null,null,null,void 0,void 0,void 0,"Canvas2DpreHighlightSinglePass"),this.Canvas2DpreHighlightSinglePass.setRenderPluginsPre(!1),this.Canvas2DpreHighlightSinglePass.setRenderPluginsPost(!1),this.Canvas2DpreHighlightSinglePass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.Canvas2DpreHighlightSinglePass.setDisableBackFaceCulling(!0),this.Canvas2DpreHighlightSinglePass.setDisableDepthTest(!0),this.Canvas2DpreHighlightSinglePass.setDisableDepthWrite(!0),this.Canvas2DpreHighlightSinglePass.lockScene=!0,this.Canvas2DpreHighlightSinglePass.idString="canvas2D",i.addPass(this.Canvas2DpreHighlightSinglePass)}setEnabled(e){this.enableb&&e||(this.enabled||e)&&(this.renderer.__enablePassOnAllComposerContexts(this.preHighlightSinglePass,!1),this.renderer.__enablePassOnAllComposerContexts(this.Canvas2DpreHighlightSinglePass,!1),this.renderer.compForwardComposerContext&&(this.renderer.compForwardComposerContext.enablePass(this.preHighlightSinglePass,e),this.renderer.compForwardComposerContext.enablePass(this.Canvas2DpreHighlightSinglePass,e)))}disableOnComposer(e){e.enablePass(this.preHighlightSinglePass,!1),e.enablePass(this.Canvas2DpreHighlightSinglePass,!1)}_sortScenes(e){this._scenesToRender=[],e.selectionPreHL.enabled&&this._scenesToRender.push(e.selectionPreHL.sceneHL);var t=this;this.preHighlightSinglePass.setMultiRenderCB(function(e,i){return i<t._scenesToRender.length&&(e.scene=t._scenesToRender[i],!0)}),this.Canvas2DpreHighlightSinglePass.setMultiRenderCB(function(e,i){return i<t._scenesToRender.length&&(e.scene=t._scenesToRender[i],!0)})}_setRenderModes(){var e=this.renderer.renderer,[t,i,r]=e.getRenderMode().getMasks();this.preHighlightSinglePass.renderFaceMode=t,this.preHighlightSinglePass.renderLineMode=i,this.preHighlightSinglePass.renderPointMode=r,this.Canvas2DpreHighlightSinglePass.renderFaceMode=t,this.Canvas2DpreHighlightSinglePass.renderLineMode=i,this.Canvas2DpreHighlightSinglePass.renderPointMode=r}_updateScene(e){this.preHighlightSinglePass.scene=e.selectionPreHL.sceneHL,this.Canvas2DpreHighlightSinglePass.scene=e.selectionPreHL.sceneHL}_checkPolite(e){var t=this.renderer.renderer,i=e.selectionPreHL.sceneHL;i.highlightData._needsDepth&&i.getNbAllWebGLObjects()+i.__objectsAdded.size>0&&t.requestPoliteDepthBuffer()}update(e){this._sortScenes(e),this._setRenderModes(),this._updateScene(e),this._checkPolite(e)}}}),define("DS/Effects/MergeMainMipsEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/DisplayMipsRoughnessShader"],function(e,t,i,r,n){"use strict";return t.extend({init:function(e,t){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=t,this.passMerge=null,this},setTextures:function(t,a,s,o){var l=a.composerContext&&a.composerContext.width,c=a.composerContext&&a.composerContext.height;if(a instanceof e.Texture?(l=a.image.width,c=a.image.height):a instanceof e.WebGLRenderTarget&&(l=a.width,c=a.height),this.width=parseInt(l),this.height=parseInt(c),this.composers.length)this.composers[0].setSize(this.width,2*this.height);else{var h=new e.WebGLRenderTargetProperties(this.width,2*this.height,"uint");h.generateMipmaps=!1,this.composers[0]=new i(this.renderer,h,this.renderTargetPool),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.noIdCheck=!0;var u=n.MergeCustomMips;this.passMerge=new r({defines:u.defines,uniforms:u.uniforms,vertexShader:u.vertexShader,fragmentShader:u.fragmentShader},void 0,"Merge Main Roughness Map"),this.composers[0].addPass(this.passMerge)}this.passMerge.uniforms.size0.value.set(this.width,this.height),this.passMerge.uniforms.tDiffuse0.value=a;for(var d=0;d<t.length;d++)this.passMerge.uniforms["tDiffuse"+(d+1)].value=t[d],this.passMerge.uniforms["size"+(d+1)].value.set(parseInt(t[d].image.width),parseInt(t[d].image.height));this.passMerge.defines.MIP_OFFSET=s?0:1,this.passMerge.defines.ZERO_RBGE=a instanceof i||a.rgbHdr?0:1,"LINEAR"===o&&(this.passMerge.defines.MAPPING=0),"NON_LINEAR"===o&&(this.passMerge.defines.MAPPING=1),"INVERSE_LINEAR"===o&&(this.passMerge.defines.MAPPING=2),"INVERSE_NON_LINEAR"===o&&(this.passMerge.defines.MAPPING=3),this.passMerge.material.needsUpdate=!0},execute:function(){this.composers[0].render();var t=this.composers[0].composerContext.getResult(void 0,!0);return t.hdr=!0,t.hasDiffuse=!0,t.mapping=new e.LatLongReflectionMapping,t}})}),define("DS/Shaders/SSLRShaders",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=["uniform sampler2D tColor;","uniform sampler2D tNormalDepthIoRRoughness;","uniform sampler2D tColorNormalDepth;","uniform mat4 realProjectionMatrix;","uniform mat4 realProjectionMatrixInverse;","uniform vec4 frustumPlanes[6];","uniform float sceneSize;","uniform vec2 screenSize;","uniform int renderIteration;","#define MAX_RAY 4","#define MAX_RAY_F 4.0","#define I_MAX_RAY_F 0.25","const float PI = 3.14159265359;","#define INV_GOLDEN_RATIO 0.6180339887","#define CLAMP_VALUE vec3(3.0)","vec3 toViewPos(vec2 uv, float depth) {","vec4 vertexPositionProjected = vec4(uv * 2.0 - 1.0, depth, 1.0);","vec4 vertexPositionVS = realProjectionMatrixInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","vertexPositionVS.w = 1.0;","return vertexPositionVS.xyz;","}","vec3 toViewPos(vec2 uv) {","float z = texture2D(tColorNormalDepth, uv).w;","if (z == 0.0) z = 1.0;","return toViewPos(uv, 2.0 * z - 1.0);","}","vec3 getScreenPos3(vec3 pos) {","vec4 offset = realProjectionMatrix * vec4(pos, 1.0);","offset.xyz /= offset.w;","offset.xy = offset.xy * 0.5 + 0.5;","return offset.xyz;","}","vec4 sampleColorScene(vec2 uv) {","vec4 color = texture2D(tColor, uv);","#if defined(NO_COMPOSITING)","return vec4(convertToLinear(color.rgb), color.a);","#else","return color;","#endif","}","float random(vec3 scale, float seed) {","return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);","}","float Random1D(float seed) {","return random(vec3(12.9898, 78.233, 151.7182), seed);","}","vec3 GetLightVector(in vec3 N, in vec3 H) {","return 2.0 * dot(N, H) * H - N;","}","float ComputeIndex(float id, float N) {","float val = id * N * 24.0;","float n = val / N;","float m = mod(val, N);","return n + m;","}","vec2 LowDiscrepancy2D(float i, float N)","{","float id = ComputeIndex(i, N);","return vec2(fract((id + 0.5) / N* INV_GOLDEN_RATIO), fract(id * INV_GOLDEN_RATIO));","}","vec3 TangentToWorld(vec3 Vec, vec3 TangentZ) {","vec3 UpVector = abs(TangentZ.z) < 0.999 ? vec3(0,0,1) : vec3(1,0,0);","vec3 TangentX = normalize(cross(UpVector, TangentZ));","vec3 TangentY = cross(TangentZ, TangentX);","return TangentX * Vec.x + TangentY * Vec.y + TangentZ * Vec.z;","}","vec3 ImportanceSampleGGX(vec2 Xi, float roughness) {","vec3 H;","float Phi = 2.0 * PI * Xi.x;","float a = roughness * roughness;","float a2 = a * a;","float CosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a2 - 1.0) * Xi.y));","float SinTheta = sqrt(1.0 - CosTheta * CosTheta);","H.x = SinTheta * cos(Phi);","H.y = SinTheta * sin(Phi);","H.z = CosTheta;","return H;","}","void ClipByPlane(vec3 origin, vec3 direction, vec4 plane, inout float t) {","float clipVal = dot(plane, vec4(origin, 1.0));","float k = -clipVal / dot(plane.xyz, direction);","if (k < 0.0) return;","t = min(t, k);","}","float ClipByFrustum(vec3 origin, vec3 direction) {","float t = 1000000000000.0;","for (int k = 0; k < 6; ++k) {","ClipByPlane(origin, direction, frustumPlanes[k], t);","}","return t;","}"].join("\n"),i=function(e){return["float roughness = normalDepth.z;","float z = normalDepth.w;","if ( z == 0.0 ) return;","vec3 normal = decodeOct24Normal(normalDepth.x);","vec3 origin = toViewPos(vUv, 2.0 * z - 1.0);","vec3 V = realProjectionMatrix[3][3] > 0.5 ? vec3(0.0,0.0,1.0) : normalize(-origin);","vec3 L;","float hitDistance = 0.0;","if (renderIteration > 2 ) {","for (int i = 0; i < MAX_RAY; i++) {","vec2 E = LowDiscrepancy2D(float(i + 1) * float(renderIteration - 2), MAX_RAY_F * 125.0);","vec3 perturbedZ = ImportanceSampleGGX(E, roughness);","vec3 H = TangentToWorld(perturbedZ, normal);",e?"vec3 Vflip = reflect(GetLightVector(V, H), normal);":"",e?"L = refract(Vflip, normal, 1.0/ior);":"L = GetLightVector(V, H);","gl_FragColor += RayMarchNew(origin, L, hitDistance);","}","gl_FragColor *= I_MAX_RAY_F;","} else {","vec3 H = normal;",e?"vec3 Vflip = reflect(GetLightVector(V, H), normal);":"",e?"L = refract(Vflip, normal, 1.0/ior);":"L = GetLightVector(V, H);","gl_FragColor = RayMarchNew(origin, L, hitDistance);","}","gl_FragColor.rgb = min(gl_FragColor.rgb,CLAMP_VALUE);"].join("\n")},r={tColor:{type:"t",value:null},tNormalDepthIoRRoughness:{type:"t",value:null},tColorNormalDepth:{type:"t",value:null},screenSize:{type:"v2",value:new e.Vector2(512,512)},realProjectionMatrix:{type:"m4",value:new e.Matrix4},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4},renderIteration:{type:"i",value:0},frustumPlanes:{type:"fv4",value:[]},sceneSize:{type:"f",value:100}},n={uniforms:r,defines:{RAYMARCHING_STEPS:16},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 vUv;",t,"vec4 RayMarchNew(vec3 origin, vec3 direction, out float hitDistance) {","vec4 outColor = vec4(0.0);","hitDistance = sceneSize;","float maxRayLength = sceneSize;","float t = ClipByFrustum(origin, direction);","if (t <= 0.0) {","return outColor;","}","vec3 endPos = origin + min(t, maxRayLength) * direction;","vec3 uviz0 = getScreenPos3(origin);","vec3 uviz1 = getScreenPos3(endPos);","vec2 uvDir = uviz1.xy - uviz0.xy;","float nbSteps = max(1.0, length(screenSize * uvDir));","float ray_marching_step = 16.0;","float j = ray_marching_step;","for (int i = 0; i < 1024; ++i) {","if (j > nbSteps) { break; }","vec3 sampleScreenPos = mix(uviz0, uviz1, j / nbSteps);","vec4 normalDepth = texture2D(tColorNormalDepth, sampleScreenPos.xy);","float z = 2.0 * normalDepth.w - 1.0;","float diffZ = sampleScreenPos.z - z;","if (normalDepth.w > 0.0 && diffZ > 0.0) {","if (ray_marching_step == 1.0) {","vec3 hit = toViewPos(sampleScreenPos.xy, sampleScreenPos.z);","float zOrigin = toViewPos(sampleScreenPos.xy).z;","if (abs(1.0 - hit.z / zOrigin) < 1e-2) {","hitDistance = length(hit - origin);","outColor = sampleColorScene(sampleScreenPos.xy);","}","break;","} else {","ray_marching_step *= 0.5;","j -= ray_marching_step;","}","} else {","j += (0.5 + 0.5 * Random1D(float(renderIteration) + j)) * ray_marching_step;","}","}","return outColor;","}","void main() {","vec2 screenPos = vUv;","gl_FragColor = vec4(0.0);","vec4 normalDepth = texture2D(tNormalDepthIoRRoughness, vUv);",i(!1),"}"].join("\n")},a={uniforms:r,defines:{RAYMARCHING_STEPS:16},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["varying vec2 vUv;",t,"vec4 RayMarchNew(vec3 origin, vec3 direction, out float hitDistance) {","direction = normalize(direction);","vec4 outColor = vec4(0.0);","hitDistance = sceneSize;","float t = ClipByFrustum(origin, direction);","float maxRayLength = min(t, sceneSize);","vec3 director = maxRayLength * direction;","vec3 endPos = origin + director;","vec3 uviz0 = getScreenPos3(origin);","vec3 uviz1 = getScreenPos3(endPos);","vec2 uvDir = uviz1.xy - uviz0.xy;","float nbSteps = length(screenSize * uvDir);","if (nbSteps < 1.0) {","vec3 curPt = toViewPos(uviz1.xy);","vec3 curOnSegment = toViewPos(uviz1.xy, uviz1.z);","if (curPt.z > curOnSegment.z) {","hitDistance = length(curPt - origin);","outColor = sampleColorScene(uviz1.xy);","}","return outColor;","}","nbSteps = ceil(nbSteps);","float j = 0.0;","float prevDepth = 1.0;","float prevSegmentDepth = 1.0;","for (int i = 0; i < 1024; i++) {","vec3 sampleScreenPos = mix(uviz0, uviz1, j / nbSteps);","vec3 curOnSegment = toViewPos(sampleScreenPos.xy, sampleScreenPos.z);","vec3 curPt = toViewPos(sampleScreenPos.xy);","if (abs(1.0 - curPt.z/curOnSegment.z) < 5e-3) {","hitDistance = length(curPt - origin);","outColor = sampleColorScene(sampleScreenPos.xy);","break;","}","else if (prevSegmentDepth >= prevDepth && curOnSegment.z <= curPt.z) {","hitDistance = length(curPt - origin);","vec3 sampleScreenPosToUse = mix(uviz0, uviz1, (j - 1.0) / nbSteps);","outColor = sampleColorScene(sampleScreenPosToUse.xy);","break;","}","prevDepth = curPt.z;","prevSegmentDepth = curOnSegment.z;","if (j >= nbSteps) { break; }","j += 1.0;","}","return outColor;","}","void main() {","vec2 screenPos = vUv;","gl_FragColor = vec4(0.0);","vec4 normalDepth = texture2D(tNormalDepthIoRRoughness, vUv);","float ior = normalDepth.y;","if (ior < 1.0) {","return;","}",i(!0),"}"].join("\n")},s={uniforms:{tMip0:{type:"t",value:null},tMip1:{type:"t",value:null},tMip2:{type:"t",value:null},tMip3:{type:"t",value:null},tMip4:{type:"t",value:null},tMip5:{type:"t",value:null},tMip6:{type:"t",value:null},tMip7:{type:"t",value:null},sceneSize:{type:"f",value:100},renderIteration:{type:"i",value:0},tNormalDepthIoRRoughness:{type:"t",value:null},realProjectionMatrixInverse:{type:"m4",value:new e.Matrix4}},defines:{RAYMARCHING_STEPS:16},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n")},o=["uniform sampler2D tMip0;","uniform sampler2D tMip1;","uniform sampler2D tMip2;","uniform sampler2D tMip3;","uniform sampler2D tMip4;","uniform sampler2D tMip5;","uniform sampler2D tMip6;","uniform sampler2D tMip7;","uniform float sceneSize;","uniform int renderIteration;","uniform sampler2D tNormalDepthIoRRoughness;","uniform mat4 realProjectionMatrixInverse;","varying vec2 vUv;","vec3 toViewPos(vec2 uv, float depth) {","vec4 vertexPositionProjected = vec4(uv * 2.0 - 1.0, depth, 1.0);","vec4 vertexPositionVS = realProjectionMatrixInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","vertexPositionVS.w = 1.0;","return vertexPositionVS.xyz;","}","vec2 mipValues = vec2(0.0,0.0);","vec4 sampleScene(vec2 uv) {","if (mipValues.x == 0.0) {return mix(texture2D(tMip0, uv), texture2D(tMip1, uv), mipValues.y);}","if (mipValues.x == 1.0) {return mix(texture2D(tMip1, uv),texture2D(tMip2, uv), mipValues.y);}","if (mipValues.x == 2.0) {return mix(texture2D(tMip2, uv),texture2D(tMip3, uv), mipValues.y);}","if (mipValues.x == 3.0) {return mix(texture2D(tMip3, uv),texture2D(tMip4, uv), mipValues.y);}","if (mipValues.x == 4.0) {return mix(texture2D(tMip4, uv),texture2D(tMip5, uv), mipValues.y);}","if (mipValues.x == 5.0) {return mix(texture2D(tMip5, uv),texture2D(tMip6, uv), mipValues.y);}","if (mipValues.x == 6.0) {return mix(texture2D(tMip6, uv),texture2D(tMip7, uv), mipValues.y);}","if (mipValues.x == 7.0) {return texture2D(tMip7, uv);}","return texture2D(tMip7, uv);","}"].join("\n"),l=["float roughness = normalDepth.z;","mipValues.x = 7.0 * pow(roughness, renderIteration > 2 ? 1.8 : 0.8);","mipValues.y = fract(mipValues.x);","mipValues.x = floor(mipValues.x);","gl_FragColor = sampleScene(vUv);"].join("\n");return{SSLRefraction:a,SSLRefractionMipSolver:Object.assign({fragmentShader:[o,"void main() {","vec2 screenPos = vUv;","gl_FragColor = vec4(0.0);","vec4 normalDepth = texture2D(tNormalDepthIoRRoughness, vUv);","float ior = normalDepth.y;","if (ior < 1.0) {","return;","}",l,"}"].join("\n")},s),SSLReflectionMipSolver:Object.assign({fragmentShader:[o,"void main() {","vec2 screenPos = vUv;","gl_FragColor = vec4(0.0);","vec4 normalDepth = texture2D(tNormalDepthIoRRoughness, vUv);",l,"}"].join("\n")},s),SSLReflection:n}}),define("DS/Effects/AbstractSSRayMarchingEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/SSLRShaders","DS/Shaders/DownSamplingShaders"],function(e,t,i,r,n,a,s){"use strict";return i.extend({init:function(t,i,o,l){this._parent(t);this.nbMips=7;var c=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");this.composers.push(new r(t,c,i)),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.name=o+"RayMarchingComposerContext",this.passRayMarching=new n(a[o],void 0,o+"RayMarching"),this.composers[0].addPass(this.passRayMarching);var h=.5;this.passMip=new Array(this.nbMips);for(var u=0;u<this.nbMips;u++){var d=new e.WebGLRenderTargetProperties(h*this.width,h*this.height,"linear");this.composers[u+1]=new r(t,d,i),this.composers[u+1].composerContext.keepResult=!1,this.composers[u+1].composerContext.name=o+"GenerateMips"+u+"ComposerContext",this.composers[u+1].composerContext.noIdCheck=!0,this.passMip[u]=new n(s.DownSamplingBlurWithAlpha,void 0,o+"GenerateMips"+u),this.passMip[u].uniforms.invSize.value.set(1/(h*this.width),1/(h*this.height)),this.passMip[u].material.needsUpdate=!0,this.passMip[u].renderToScreen=!1,this.composers[u+1].addPass(this.passMip[u]),h*=.5}this.composers[this.nbMips+1]=new r(this.renderer,c,i),this.composers[this.nbMips+1].composerContext.keepResult=!0,this.composers[this.nbMips+1].composerContext.name=o+"SolverComposerContext",this.passSolver=new n(a[l],void 0,o+"Solver"),this.composers[this.nbMips+1].addPass(this.passSolver),this.passMip[0].addRequiredComposer(this.composers[0]),this.composers[0].linkToShaderPassUniform(this.passMip[0],this.passMip[0].uniforms.tDiffuse2);for(u=1;u<this.nbMips;u++)this.passMip[u].addRequiredComposer(this.composers[u]),this.composers[u].linkToShaderPassUniform(this.passMip[u],this.passMip[u].uniforms.tDiffuse2);this.passSolver.addRequiredComposer(this.composers[this.nbMips]),this.composers[0].linkToShaderPassUniform(this.passSolver,this.passSolver.uniforms.tMip0);for(u=0;u<this.nbMips;u++)this.composers[u+1].linkToShaderPassUniform(this.passSolver,this.passSolver.uniforms["tMip"+(u+1)]);return this},update:function(t,i,r,n){r._renderedCamera.projectionMatrixInverse.getInverse(r._renderedCamera.projectionMatrix),this.passRayMarching.uniforms.realProjectionMatrixInverse.value=r._renderedCamera.projectionMatrixInverse,this.passSolver.uniforms.realProjectionMatrixInverse.value=r._renderedCamera.projectionMatrixInverse,this.passRayMarching.uniforms.realProjectionMatrix.value=r._renderedCamera.projectionMatrix,this.passRayMarching.uniforms.renderIteration.value=n,this.passSolver.uniforms.renderIteration.value=n;var a=i.getBoundingSphere();this.passRayMarching.uniforms.sceneSize.value=a.radius,this.passSolver.uniforms.sceneSize.value=a.radius;var s=new e.Frustum;s.setFromMatrix(r._renderedCamera.projectionMatrix);var o=this.passRayMarching.uniforms.frustumPlanes.value;o||(o=[],this.passRayMarching.uniforms.frustumPlanes.value=o);for(var l=0;l<6;l++){var c=s.planes[l],h=c.normal;o[4*l]=h.x,o[4*l+1]=h.y,o[4*l+2]=h.z,o[4*l+3]=c.constant}},execute:function(){return this.composers[this.nbMips+1].render(),this.composers[this.nbMips+1].composerContext},setSize:function(e,t){if(this._parent(e,t)){this.composers[0].setSize(this.width,this.height),this.passRayMarching.uniforms.screenSize.value.set(this.width,this.height);for(var i=.5,r=0;r<this.nbMips;r++)this.composers[r+1].setSize(this.width,this.height),this.passMip[r].uniforms.invSize.value.set(1/(i*this.width),1/(i*this.height)),i*=.5;this.composers[this.nbMips+1].setSize(this.width,this.height)}}})}),define("DS/Visualization/PLMMaterialData",["DS/Visualization/StaticOverrideSet","DS/Visualization/PLMMaterialLoader"],function(e,t){"use strict";var i=new t,r=function(e){this._node=e,this._materialConnections=[],this._staticOverrideSet=null};return r.prototype._getStaticOverrideSet=function(){var t=this._staticOverrideSet;return null===t&&(t=new e(this._node),this._staticOverrideSet=t),t},r.prototype.addMaterialConnection=function(e){this._materialConnections.push(e),i.loadMaterials([e],this)},r.prototype._applyMaterialApplication=function(e,t){t=t.clone();var i=this._getStaticOverrideSet(),r=e.computeLayer(this);t._layer=r,i.addStaticOverride(e.pathElement,t),this._node._requestStaticOverridesUpdate()},r.prototype.getNbConnections=function(){return this._materialConnections.length},r}),define("DS/Visualization/Node3D",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/OccurrencePath","DS/Visualization/PathElement","DS/Mesh/MeshUtils","DS/CoreEvents/ModelEvents","DS/Visualization/OccurrenceRenderingOverride","DS/Visualization/SessionNodesWithSectionProfile","DS/Visualization/ClippingContext","DS/Visualization/RenderMode","DS/Visualization/RenderStyle","DS/Visualization/MaterialApplication","DS/Visualization/PLMMaterialData","DS/Visualization/KDTree","DS/Visualization/ClippingPolyLineData"],function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m){"use strict";var g=i.NoOccurrences,v=5,S=0,_=new i.Matrix4,y=i.__visibleInCurrentSpace;const x=i._VisuFilterType,M=new Set;M.add(x.GAS_INHERIT);var P=function(e,t){return this.node=void 0!==e?e:null,this.parent=null,this.depth=0,this.children=[],this.occBooleanAttr=0,this.matrix=null,this.material=null,this.matApp=null,this.matAppOverride=null,this.gas=null,this._setVisible(!0),this._setVisibilityFree(!1),this._setDepthMode(!0),this._setAdvancedPriority(!1),this._setPickable(!0),this.setIsInBackground(!0),this._setIsAlwaysInForeground(!1),this.setNoPickThrough(!0),this.scene3js=void 0!==t?t:null,this.renderable=null,this.renderMode=null,this.layerFilter=null,this.faceMode=null,this._setNeedBEUpdate(!0),this.passes=null,this.forcePasses=null,this.forceGAS=null,this.pickingPriorityID=null,this.clippingContext=null,this.__rdo_visited=0,this._filters=null,this.__overrideData=null,this._manipulators={},this._setNeedOverridesUpdate(!1),this._setDescendantNeedsOverridesUpdate(!1),this._substituteMaterials=null,this.__solvedSubstituteMaterials=null,this},C=function(){this.renderPriority=null,this.localMatrixOverride=null,this._relativeMatrix=null,this._relativeVisibility=null,this._bsShow=void 0,this._bsNoShow=void 0,this._bbShow=void 0,this._bbNoShow=void 0,this.occurrenceRenderingOverride=null,this.originalOverrideSet=null,this.overrideLink=null};Object.defineProperty(P.prototype,"renderPriority",{get:function(){return this.__overrideData?this.__overrideData.renderPriority:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData.renderPriority=e)}}),Object.defineProperty(P.prototype,"occurrenceRenderingOverride",{get:function(){return this.__overrideData?this.__overrideData.occurrenceRenderingOverride:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData.occurrenceRenderingOverride=e)}}),Object.defineProperty(P.prototype,"originalOverrideSet",{get:function(){return this.__overrideData?this.__overrideData.originalOverrideSet:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData.originalOverrideSet=e)}}),Object.defineProperty(P.prototype,"overrideLink",{get:function(){return this.__overrideData?this.__overrideData.overrideLink:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData.overrideLink=e)}}),Object.defineProperty(P.prototype,"localMatrixOverride",{get:function(){return this.__overrideData?this.__overrideData.localMatrixOverride:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData.localMatrixOverride=e)}}),Object.defineProperty(P.prototype,"_relativeMatrix",{get:function(){return this.__overrideData?this.__overrideData._relativeMatrix:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._relativeMatrix=e)}}),Object.defineProperty(P.prototype,"_relativeVisibility",{get:function(){return this.__overrideData?this.__overrideData._relativeVisibility:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._relativeVisibility=e)}}),Object.defineProperty(P.prototype,"_bsShow",{get:function(){return this.__overrideData?this.__overrideData._bsShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._bsShow=e)}}),Object.defineProperty(P.prototype,"_bsNoShow",{get:function(){return this.__overrideData?this.__overrideData._bsNoShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._bsNoShow=e)}}),Object.defineProperty(P.prototype,"_bbShow",{get:function(){return this.__overrideData?this.__overrideData._bbShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._bbShow=e)}}),Object.defineProperty(P.prototype,"_bbNoShow",{get:function(){return this.__overrideData?this.__overrideData._bbNoShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._bbNoShow=e)}}),P.prototype._createOverrideData=function(){this.__overrideData||(this.__overrideData=new C)},P.prototype._getMaterialApplication=function(){return this.matAppOverride?this.matAppOverride:this.node._getMaterialApplication()},P.prototype._getFilter=function(e){return this._filters?this._filters.get(e):null},P.prototype._isFurtiveFiltered=function(){return!(!this._getFilter(x.FURTIVE)||!this.isFurtive())},P.prototype._getShadow=function(){var e=null,t=null;if(this.renderable&&this._filters&&this._filters.has(x.LOOK)){var i=this._filters.get(x.LOOK);1===i.shadowReceive?e=!0:0===i.shadowReceive&&(e=!1),1===i.shadowCast?t=!0:0===i.shadowCast&&(t=!1)}return[t,e]},P.prototype._addSubstituteMaterial=function(e,t){this._substituteMaterials||(this._substituteMaterials=new Map),this._substituteMaterials.set(e,t),this.parent&&this.parent.node._updateOccurrences(this.parent,this,!1,!0,!1)},P.prototype._removeSubstituteMaterial=function(e){this._substituteMaterials&&(this._substituteMaterials.delete(e),0===this._substituteMaterials.size&&(this._substituteMaterials=null),this.parent&&this.parent.node._updateOccurrences(this.parent,this,!1,!0,!1))},P.prototype._propagateSubstituteMaterials=function(e){if(this.__solvedSubstituteMaterials=null,e||this._substituteMaterials){var t=new Map;this._substituteMaterials&&this._substituteMaterials.forEach((e,i,r)=>t.set(i,e)),e&&e.forEach((e,i,r)=>t.set(i,e)),t.size>0&&(this.__solvedSubstituteMaterials=t)}},P.prototype.updateMatrix=function(e,t){t?e?this.localMatrixOverride?this.localMatrixOverride.copy(e):this.localMatrixOverride=e.clone():this.localMatrixOverride.identity():this.localMatrixOverride=null;var r=this.parent;if(this.node._isDecal&&this.node._decalAttachedTo.size>0&&r){for(var n=r;n&&!this.node._decalAttachedTo.has(n.node);)n=n.parent;n?r=n:console.warn("Inconsistent decal attachement, the attachement is not a parent of the application, the decal is attached to its application")}r?e&&!e.isIdentity()?r.matrix?r.matrix.isIdentity()?this.matrix=e.clone():(this.matrix=new i.Matrix4,this.matrix.multiplyMatrices(r.matrix,e)):this.matrix=e.clone():r.matrix&&!r.matrix.isIdentity()?this.matrix=r.matrix:this.matrix=_:e&&!e.isIdentity()?this.matrix=e.clone():this.matrix=_},P.prototype.getViewer=function(){return this.scene3js&&this.scene3js.viewer},P.prototype.getLocalMatrix=function(){return this.localMatrixOverride||this.node._matrix||_},P.prototype.requestOverridesUpdate=function(){for(var e=this.parent;e&&!e._getDescendantNeedsOverridesUpdate();)e._setDescendantNeedsOverridesUpdate(!0),e=e.parent;this.traverseWithCondition(function(e){return e._getNeedOverridesUpdate()?null:(e.parent&&e.parent._setDescendantNeedsOverridesUpdate(!0),e._setNeedOverridesUpdate(!0),!0)})},P.prototype.doesADescendantNeedOverrideUpdate=function(){return this._getDescendantNeedsOverridesUpdate()},P.prototype.isOverridesUpdateRequested=function(){return this._getNeedOverridesUpdate()},P.prototype.clearOverridesUpdateRequest=function(){this.traverseWithCondition(function(e){var t=!!e._getDescendantNeedsOverridesUpdate()||null;return e._setNeedOverridesUpdate(!1),e._setDescendantNeedsOverridesUpdate(!1),t})},P.prototype.updateOverrideStatus=function(e){if(e?this.traverse(function(e){!function(e){var t=e.originalOverrideSet;t&&t.lib&&(t.lib.length=0);var i=null,r=null;e.parent&&(i=e.parent.overrideLink,r=e.parent.originalOverrideSet),i&&i.lib&&(i.lib.length=0);var n,a=e.overrideLink,s=t||i;a||s&&(n=t&&t.visibilityFix||i&&i.visibilityFix,a=s.createOverrideLink(n),e.overrideLink=a),a&&a.combine(t,i,r)}(e)}):this.traverse(function(e){e.overrideLink&&e.overrideLink.reset()}),this.parent)this.parent.node._updateOccurrences(this.parent,this,!1);else{var t=this.children,i=0;for(i=0;i<t.length;i++)this.node._updateOccurrences(this,t[i],!e)}},P.prototype._tryOverridesUpdateWithAncestors=function(e){if(this._needOverridesUpdate||this._descendantNeedsOverridesUpdate){for(var t=this;t.parent;)t=t.parent;t.node._tryOverridesUpdate(e||this.scene3js&&this.scene3js.viewer)}},P.prototype._compactChildrenArray=function(e){var t=this.children;this.children=new Array(t.length);for(var i=0;i<t.length;i++)this.children[i]=t[i];this.renderable&&this.renderable._compactArrays&&this.renderable._compactArrays(e)},P.prototype.lightCopy=function(){var e,t=this.node,i=new P(t,this.scene3js);if(null!==this.renderable&&((e=t.createRenderable()).name=t.name,e._occurrence=i,i.renderable=e,t._occurrences[0]&&t._occurrences[0]._manipulators)){var r,n=t._occurrences[0]._manipulators;for(r in n){var a=n[r];i._manipulators||(i._manipulators={}),i._manipulators[r]=a}}return i},P.prototype.traverse=function(e,t){var i,r,n=this.children.length;for(r=e(this,t),i=0;i<n;i++)this.children[i].traverse(e,r)},P.prototype.traverseWithCondition=function(e,t){var i,r,n=this.children.length;if(r=e(this,t))for(i=0;i<n;i++)this.children[i].traverseWithCondition(e,r)},P.prototype._getRenderableOccurrences=function(e){var t,i,r,n,a,s;for(t=[],i=this.children,null!==this.renderable&&t.push(this.renderable),n=0;n<i.length;n++)if(s=i[n],!e||!s.node.getExcludeFromBounding())for(r=s._getRenderableOccurrences(),a=0;a<r.length;a++)t.push(r[a]);return t},P.prototype.getBoundingSphere=function(e,t){var i=this._getBoundingSphere(e,t);return i?i.clone():null},P.prototype.getBoundingBox=function(e){return this._getBoundingBox(e)},P.prototype._getRenderModes=function(){var e=this.scene3js&&this.scene3js.viewer;return e&&null!==this.renderable?e.renderer.renderer.getRenderMode(this.renderable)._maskWithDefault:0},P.prototype._getAccurateRenderableOccurrences=function(e,t,r,n){var a=n||this.node.getRatio()>0;if(r.fixedSizeNodesStatus===i.FixedSizeFiltering.Exclude&&a)return e;var s,o=this.children,l=r.mask||0;if(null!==this.renderable){var c=this.renderable;if(!c.filtered&&y(c.visible,c.visibilityFree,r.space,c.layer,this)){var h=[],u=this._getRenderModes(),d=this._getFilter(x._STATIC_GEOM_TYPE)||this._getFilter(x.GEOM_TYPE);if(c.layer){var p=c.layer.layers;for(v=0;v<p.length;v++){var f=p[v];f.drawableInterval.skip(c,r.space)||(f.drawableGroup.isFiltered(u&~l,d?d._geomType:0)||h.push(f))}}else for(var m=0;m<c.geometry.length;m++)for(var g=c.geometry[m],v=0;v<g.drawingGroups.length;v++){var S=g.drawingGroups[v];S.isFiltered(u&~l,d?d._geomType:0)||h.push(S)}if(h.length>0){var _=new i.Matrix4;null!==r.handleMatrix?_.multiplyMatrices((new i.Matrix4).getInverse(r.handleMatrix),c._getMMMatrix()):_=c._getMMMatrix();var M=r.fixedSizeNodesStatus===i.FixedSizeFiltering.CenterOnly&&a?new i.Box3(new i.Vector3(0,0,0),new i.Vector3(0,0,0)):c.boundingBox.clone(),P=new i.DGBoundingBoxArray({fastBBox:M.applyMatrix4(_),matrix:_,renderable:c});P.setDGs(h),e.push(P)}}}for(m=0;m<o.length;m++)s=o[m],t&&s.node.getExcludeFromBounding()||s._getAccurateRenderableOccurrences(e,t,r,a);return e},P.prototype._isFixedSize=function(){for(var e=!1,t=this;null!=t&&(e=e||t.node.getRatio()>0,t=t.parent,!e););return e},P.prototype.computeAccurateBoundingBox=function(e,t,r,n){var a="visibleSpace"===e,s=[],o=this._isFixedSize();this._getAccurateRenderableOccurrences(s,!0,{space:a,handleMatrix:t,fixedSizeNodesStatus:r||i.FixedSizeFiltering.Include,mask:n||0},o);for(var l=[],c=s.length-1;c>=0;c--)s[c].renderable.geometry[0].vertexPositionArray||(l.push(s[c]),s.splice(c,1));var h=new i.Box3;if(h.fromDGBoundingBoxArray(s),l.length){var u=this.getViewer();h.union(u.renderer.boundingBoxGPUCompute.computeBoundingBoxGPU(u,l,t))}return h},P.prototype.needsBoundingElement=function(){var e,t=this.children.length;for(e=0;e<t;e++){var i=this.children[e];if(i.localMatrixOverride||void 0!==i._bsShow||void 0!==i._bsNoShow||void 0!==i._bbShow||void 0!==i._bbNoShow||i.overrideLink&&i.overrideLink.hasVisibilityOverride())return!0}return!1},P.prototype._isFiltered=function(){return!(!(this.layerFilter&&this.node._layer<this.layerFilter.length)||this.layerFilter[this.node._layer])},P.prototype._getBoundingSphere=function(e,t){e=e||"visibleSpace",this._updateBoundingElements();var r=null,n=void 0!==this._bsShow?this._bsShow:this.node._bsShow,a=void 0!==this._bsNoShow?this._bsNoShow:this.node._bsNoShow;return(r=this._getVisibilityFree()?this._getVisible()?n:null:this._getVisible()?"visibleSpace"===e?n:a:"visibleSpace"===e?null:i.mergeBoundingSphereInto(n&&n.clone(),a,this.node.getRatio()))||t||(r=new i.Sphere),r},P.prototype._getBoundingBox=function(e){e=e||"visibleSpace",this._updateBoundingElements();var t=null,r=void 0!==this._bbShow?this._bbShow:this.node._bbShow,n=void 0!==this._bbNoShow?this._bbNoShow:this.node._bbNoShow;return(t=this._getVisibilityFree()?this._getVisible()?r:null:this._getVisible()?"visibleSpace"===e?r:n:"visibleSpace"===e?null:i.mergeBoundingBoxInto(r&&r.clone(),n))||(t=new i.Box3),t},P.prototype.updateVisibilityFlag=function(){this._invalidateBoundingElements(!1)},P.prototype.updateVisibilityFreeFlag=function(){this._invalidateBoundingElements(!1)},P.prototype._invalidateBoundingElements=function(e){this._getNeedBEUpdate()||(this._setNeedBEUpdate(!0),!this.parent||this.node.getExcludeFromBounding()&&!e||this.parent._invalidateBoundingElements(!1))},P.prototype._updateBoundingElements=function(e,t){if(e||this.node._updateBoundingElements(),this._getNeedBEUpdate()){if(!this.node._getForceBoundingElements()){t=this.node._updateShadowMapsIfNeeded(t);var r=0;for(r=0;r<this.children.length;r++)this.children[r]._updateBoundingElements(!0,t);this._updateBoundingElements_internal("_bsShow","_bsNoShow",i.mergeBoundingSphereInto,"bSphere"),this._updateBoundingElements_internal("_bbShow","_bbNoShow",i.mergeBoundingBoxInto,"bBox")}this._setNeedBEUpdate(!1),this.parent||this.scene3js&&(this.scene3js.boundingSphere=this._getBoundingSphere("visibleSpace").clone(),this.scene3js.boundingSphere.radius=100,this.scene3js.boundingBox=this._getBoundingBox("visibleSpace").clone())}},P.prototype._updateBoundingElements_internal=function(e,t,i,r){if(!this.node._getForceBoundingElements())if(this.needsBoundingElement()){if(this.children.length){var n,a,s,o,l=0,c=null,h=null;for(l=0;l<this.children.length;l++)(n=this.children[l]).node.getExcludeFromBounding()||(a=void 0!==n[e]?n[e]:n.node[e],s=void 0!==n[t]?n[t]:n.node[t],o=n.localMatrixOverride||n.node._matrix,n._getVisibilityFree()?(n._getVisible()||n.needsBoundingElement()&&!n.isMesh())&&(c=i(c,a,o,n.node.getRatio()),h=i(h,a,o,n.node.getRatio())):n._getVisible()||n.needsBoundingElement()&&!n.isMesh()?(c=i(c,a,o,n.node.getRatio()),h=i(h,s,o,n.node.getRatio())):(h=i(h,a,o,n.node.getRatio()),h=i(h,s,o,n.node.getRatio())))}else this._getHasExplicitBE()&&(c=void 0!==this[e]?this[e]:this.node[r],h=null);this[e]=c,this[t]=h}else this[e]=void 0,this[t]=void 0},P.prototype.isInCanvas2DPass=function(){var e=this.passes;return!!(e&&e.indexOf("canvas2D")>=0)},P.prototype.isInNozPass=function(){var e=this.passes;return!!(e&&e.indexOf("noz")>=0)||(!!(e&&e.indexOf("NoZ")>=0)||(!!(e&&e.indexOf("Noz")>=0)||(!!(e&&e.indexOf("robot")>=0)||(!!(e&&e.indexOf("canvas2D")>=0)||!!(e&&e.indexOf("-noPoliteHL")>=0)))))},P.prototype.isFurtive=function(){var e=this.passes;return!!(e&&e.indexOf("furtive")>=0)},P.prototype.isMesh=function(){return this.node._isMesh3D};var b=e.extend({init:function(e,t){if(this.id=S,S++,this.node3DBooleanAttr=0,this.modelIdentification=null,this.name=void 0!==e?e:"",this.parents=[],this.children=[],this.setLinkedToSceneGraph(!1),this._bsShow=null,this._bsNoShow=null,this._bbShow=null,this._bbNoShow=null,this._setForceBoundingElements(!1),this.setIsInBackground(!0),this._setIsAlwaysInForeground(!1),this._matrix=null,this.setExcludeFromBounding(!1),this.userData=null,this._setNeedBEUpdate(!0),this._material=null,this._matApp=null,this._gas=window.newMaterialInheritance?new i.GraphicAttributeSet({NREInit:!0,type:i.GASTypeEnum.SKIN}):null,this._filters=null,this._setVisible(!0),this._setVisibilityFree(!1),this._setPickable(!0),this.setNoPickThrough(!0),this._occurrences=[],!g||t){var r=new P(this,this.scene3js);this._occurrences.push(r)}return this._setPickParent(!1),this.__setTreeModified(!1),this.passes=null,this.clippingContext=null,this._renderMode=null,this._pickingMode=null,this._layer=0,this._layerFilter=null,this._depthMode=!1,this._depthPriority=0,this._priority=4,this.setNotAllowedInPathElement(!1),this.modelEvents=void 0,this.productType="",this.persistentId=0,this._setVisibilityInTree(!0),this._iconInTree="",this.pickingPriorityID=null,this.clipPolyLine=null,this.setIsManipulator(!1),this._PLMMaterialData=null,this._setExcludeFromCSO(!1),this._setExcludeFromHSO(!1),this._setExcludeFromPSO(!1),this._setExcludeFromHL(!1),this._setExcludeFromPreHL(!1),this._setPropagateXSOExclusion(!1),this._setForbidHierarchyUpdate(!1),this.decalCount=0,this._overrideSetManager=null,this},_linkingClone:function(e,t){return(t=t||new b(this.name)).node3DBooleanAttr=this.node3DBooleanAttr,t._matrix=this._matrix,t._setNeedBEUpdate(!0),t._material=this._material,t._matApp=this._matApp,t._gas=this._gas,this._filters&&(t._filters=new Map,this._filters.forEach((e,i,r)=>t._filters.set(i,e))),t.passes=this.passes,t.clippingContext=this.clippingContext,t._renderMode=this._renderMode,t._pickingMode=this._pickingMode,t._layer=this._layer,t._layerFilter=this._layerFilter,t._depthPriority=this._depthPriority,t._priority=this._priority,t.modelEvents=this.modelEvents,t.productType=this.productType,t.persistentId=this.persistentId,t._iconInTree=this._iconInTree,t.pickingPriorityID=this.pickingPriorityID,t.clipPolyLine=this.clipPolyLine,t._PLMMaterialData=this._PLMMaterialData,t._overrideSetManager=this._overrideSetManager,t},_compactHierarchy:function(e,t){if(!e.has(this)){e.add(this);var i=this.parents;this.parents=new Array(i.length);for(var r=0;r<i.length;r++)this.parents[r]=i[r];var n=this._occurrences;this._occurrences=new Array(n.length);for(r=0;r<n.length;r++){var a=n[r];this._occurrences[r]=a,a._compactChildrenArray(t)}var s=this.children;this.children=new Array(s.length);for(r=0;r<s.length;r++){var o=s[r];this.children[r]=o,o._compactHierarchy(e,t)}}},_getPickingCameraName:function(){var e=this._occurrences[0].passes;if(e&&1===e.length){if("robot"===e[0])return"connectedRobotCamera";if("robotOrtho"===e[0])return"robotCameraOrtho"}return""},_setTreeModified:function(){if(!this._getTreeModified()){this.__setTreeModified(!0);var e=0;for(e=0;e<this.parents.length;e++)this.parents[e]._setTreeModified()}},getModelIdentification:function(){return this.modelIdentification},setModelIdentification:function(e){this.modelIdentification=e},getIdentificationObject:function(){return this.modelIdentification},setIdentificationObject:function(e){this.modelIdentification=e},setNodeUsage:function(e){this.persistentId=e},getNodeUsage:function(){return this.persistentId},isOOCPLMNode:function(){var e=this.getNodeUsage();return null!==this.modelIdentification&&void 0!==this.modelIdentification&&e!==b.TILESET_NODE},isOOCRepReference:function(){return this.getNodeUsage()===b.REPRESENTATION_NODE},isOOCReference:function(){return this.getNodeUsage()===b.REFERENCE_NODE},isOOCInstance:function(){return this.getNodeUsage()===b.INSTANCE_NODE&&!this.isOOCRepInstance()},isOOCRepInstance:function(){var e;if(this.getNodeUsage()===b.INSTANCE_NODE)for(e=0;e<this.children.length;e++)if(this.children[e].isOOCRepReference())return!0;return!1},isOOCTileSetNode:function(){return this.getNodeUsage()===b.TILESET_NODE},addChild:function(e){if(e){if(D>0)throw new Error("Attempt to modify locked node hierarchy.");if(this._getForbidHierarchyUpdate()||e._getForbidHierarchyUpdate())return!1;var r,n,a,s;if(this._setTreeModified(),e instanceof i.Object3D&&console.warn("THREE.Object3D can not be a child of Node3D. This is probably due to a migration problem."),-1!==(e.parents.length<this.children.length?e.parents.indexOf(this):this.children.indexOf(e)))return!1;e._invalidateBoundingElements(!1,!1),this.children.push(e),e.parents.push(this),e._isDecal&&this.decalCount++;var o=null,l=this;if(e.traverse(function(e){var t,i,r=e.clippingContext&&e.clippingContext.planes;if(r)for(o||(o=l._getAllOwningViewers()),t=0;t<o.length;t++){for(i=0;i<r.length;i++)o[t]._addClippingPlane(r[i]);o[t]._requestClippingUpdate()}}),r=this._occurrences.length,n=e._occurrences.length,d=0,!r||!n)return!1;var c=!1;for((e._getOverrideExists()||this._getOverrideExists())&&(this._setOverrideExistsTraverse(),c=!0),e._getOverrideSetManagerUnder()&&this._setOverrideSetManagerUnder(),d=0;d<r;d++){if(a=this._occurrences[d],s=e._occurrences[0],a&&a.originalOverrideSet&&a.originalOverrideSet.onAddChild){var h=a.scene3js&&a.scene3js.viewer;a.originalOverrideSet.onAddChild(h)}(n>1||null!==s.parent)&&(s=this._copyTree(s)),a.children.push(s),s.parent=a,this._updateOccurrences(a,s,!0),c&&s.requestOverridesUpdate()}this._getNeedBEUpdate()||e._areBoundingElementsIncludedInParent(this)||this._invalidateBoundingElements(!1,!1),e.traverseUnique(function(e){e._getStaticOverrideSet()&&e._requestStaticOverridesUpdate()}),this.onLinkToSceneGraph(e);for(var u={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"ADD",fromNode:this,toNode:e},d=(o=this._getAllOwningViewers(),0);d<o.length;d++)i.DecalManager.updateDecalsData(o[d],!1);return t.publish({event:"/VISU/onSceneGraphUpdate",data:u}),!0}},removeChild:function(e){if(e){if(D>0)throw new Error("Attempt to modify locked node hierarchy.");if(this._getForbidHierarchyUpdate()||e._getForbidHierarchyUpdate&&e._getForbidHierarchyUpdate())return!1;var r,n,a,s,o,l,c;if(this._setTreeModified(),-1===(r=this.children.indexOf(e)))return!1;if(this.children.splice(r,1),-1===(n=e.parents.indexOf(this)))return!1;e.parents.splice(n,1),e._isDecal&&this.decalCount--,this.onLinkToSceneGraph(e);var h=this._getAllOwningViewers();if(e.traverse(function(e){var t,i,r=e.clippingContext&&e.clippingContext.planes;if(r)for(t=0;t<h.length;t++){for(i=0;i<r.length;i++)h[t]._removeClippingPlane(r[i]);h[t]._requestClippingUpdate()}}),a=this._occurrences.length,s=e._occurrences.length,!a||!s)return!1;for(p=0;p<a;p++)if(o=this._occurrences[p],s=e._occurrences.length,l=e._occurrences[0],1===s){-1!==(r=o.children.indexOf(l))&&o.children.splice(r,1),l.parent=null,l.material=e._material,e._matrix?l.matrix=e._matrix.clone():l.matrix=null,null!==l.renderable&&(l.renderable.setMatrix(l.matrix,!1),"Mesh3D"===l.node.getNodeType()||"ParticlesNode3D"===l.node.getNodeType()?(null!==l.material&&(l.renderable.material=l.material),null!==l.matApp&&(l.renderable.matApp=l.matApp),null!==l.gas&&(l.renderable.gas=l.gas),null!==l.scene3js&&l.scene3js.containsObject(l.renderable)&&(this._removeFromVisuSelection(l.renderable),l.scene3js.remove(l.renderable),"Mesh3D"===l.node.getNodeType()&&l.renderable.releaseVBO(!1))):"LightNode3D"===l.node.getNodeType()?null!==l.scene3js&&l.scene3js.containsLight(l.renderable)&&l.scene3js.remove(l.renderable):"LensFlareNode3D"===l.node.getNodeType()?null!==l.scene3js&&l.scene3js.containsLensFlare(l.renderable)&&l.scene3js.remove(l.renderable):"CSS2DNode"!==l.node.getNodeType()&&"CSS3DNode"!==l.node.getNodeType()||(l.renderable.element.parentNode&&l.renderable.element.parentNode.removeChild(l.renderable.element),null!==l.scene3js&&l.scene3js.remove(l.renderable)));var u=l.scene3js&&l.scene3js.viewer;for(u&&2===u._sceneGraphStateVersion&&l.traverse(function(e){e.originalOverrideSet&&(e.originalOverrideSet.onDetach(u,e),e.originalOverrideSet=null),e.overrideLink=null}),l.scene3js=null,c=0;c<l.children.length;c++)this._updateOccurrences(l,l.children[c],!0)}else{for(c=0;c<o.children.length&&(l=o.children[c]).node!==e;c++);o.children.splice(c,1),this._deleteTree(l)}this._removeInvalidElementsInXSO(e),e.getExcludeFromBounding()||this._invalidateBoundingElements(!1,!1),e.traverseUnique(function(e){e._getStaticOverrideSet()&&e._requestStaticOverridesUpdate()});for(var d={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"REMOVE",fromNode:this,toNode:e},p=0;p<h.length;p++)i.DecalManager.updateDecalsData(h[p],!0);return t.publish({event:"/VISU/onSceneGraphUpdate",data:d}),!0}},removeChildren:function(){if(this._getForbidHierarchyUpdate())return!1;for(;this.children.length;)this.removeChild(this.children[0],!1);return this._invalidateBoundingElements(!1,!1),!0},traverse:function(e,t,i){var r,n,a=!1;a=e(this,t);var s=i?this.parents:this.children;if(n=s.length,!a)for(r=0;r<n&&!(a=s[r].traverse(e,t,i));r++);return a},traverseUnique:function(e,t,i,r){if(!g){var n=new Set;this._traverse_internal(e,t,i,r,n);var a=[];return n.forEach(e=>{a.push(e)}),a}},_traverse_internal:function(e,t,i,r,n){if(!g&&!n.has(this)){n.add(this);var a,s,o;o=e(this,t);var l=i?this.parents:this.children;if(s=l.length,!o)for(a=0;a<s;a++)l[a]._traverse_internal(e,t,i,r,n)}},getChildrenByName:function(e,t){var i={root:this,nodes:[]};return this.traverse(function(t,i){return t.name===e&&i.nodes.push(t),!1},i,t),i.nodes},_forceGeomType:function(e){for(var t=0;t<this.children.length;t++)this.children[t]._forceGeomType(e)},_setRatio:function(e){for(var t=0;t<this.children.length;t++)this.children[t]._setRatio(e)},_setFixedSizeCameraName:function(e){for(var t=0;t<this.children.length;t++)this.children[t]._setFixedSizeCameraName(e)},_setBillboardData:function(e,t,i){for(var r=0;r<this.children.length;r++)this.children[r]._setBillboardData(e,t,i)},_setFixedSizeCenter:function(e,t){for(var i=0;i<this.children.length;i++)this.children[i]._setFixedSizeCenter(e,t)},getChildByName:function(e,t){var i={root:this,node:null};return this.traverse(function(t,i){return t.name===e&&(i.node=t,!0)},i,t),i.node},getChildById:function(e,t){var i={root:this,node:null};return this.traverse(function(t,i){return t.persistentId===e&&(i.node=t,!0)},i,t),i.node},_reduceMaterial:function(){if(this.getLinkedToSceneGraph())for(var e=0;e<this._occurrences.length;e++)for(var t=this._occurrences[e]._getRenderableOccurrences(),i=0;i<t.length;i++)t[i].releaseVBO(!0)},_incrementMaterial:function(){if(this.getLinkedToSceneGraph())for(var e=0;e<this._occurrences.length;e++)for(var t=this._occurrences[e]._getRenderableOccurrences(),i=0;i<t.length;i++)t[i].addRefVBO(!0)},oldSetMaterial:function(e){var t,r,n,a,s,o;for(this._reduceMaterial(),this._material=e,t=this._occurrences.length,s=0;s<t;s++)(n=this._occurrences[s]).material=e,null!==n.renderable&&(n.renderable._flagAsGSSOInvalidated(),i.disableJHGDev&&null===n.material||(n.renderable.material=n.material));for(s=0;s<t;s++)for(r=(n=this._occurrences[s]).children.length,o=0;o<r;o++)a=n.children[o],this._updateOccurrences(n,a,!1);this._incrementMaterial()},setMaterial:function(e){if(window.newMaterialInheritance){var t=null;if(this._matApp&&this._matApp._material===e&&(t=this._matApp),this._reduceMaterial(),t)this._matApp=t,this._updateMaterial();else{this._matApp=null;var r={layer:0};e&&(e.line||e.point?(e.line&&(r.lineMaterial=e.line),e.point&&(r.pointMaterial=e.point),"forceGeomTypeFACE"===e.force?r.geometricalFaceMaterial=e:r.faceMaterial=e):"forceGeomTypeFACE"===e.force?r.geometricalFaceMaterial=e:e instanceof i.LineBasicMaterial?r.lineMaterial=e:e instanceof i.ParticleBasicMaterial?r.pointMaterial=e:e instanceof i.ShaderMaterialDS?(r.faceMaterial=e,r.lineMaterial=e,r.pointMaterial=e):r.faceMaterial=e),(t=new d(r))._checkForceFlag=!0,this.__setMaterialApplication(t)}this._incrementMaterial()}else this.oldSetMaterial(e)},getMaterialApplication:function(){return this._matApp},setMaterialApplication:function(e){this._reduceMaterial(),this.__setMaterialApplication(e),this._incrementMaterial()},removeMaterialApplication:function(){this._reduceMaterial(),this.__removeMaterialApplication(),this._incrementMaterial()},_getMaterialApplication:function(){return this._matApp},_setMaterialApplication:function(e){console.error("Do not use private internal APIs: please use setMaterialApplication(iMatApp) instead"),this.setMaterialApplication(e)},__setMaterialApplication:function(e){var t=this._getMaterialApplication();t?(e._layer<t._layer||e._layer===t._layer&&e._inheritance>=t._inheritance)&&(this._matApp=e):this._matApp=e,this._updateMaterial()},_removeMaterialApplication:function(){console.error("Do not use private internal APIs: please use removeMaterialApplication() instead"),this.removeMaterialApplication()},__removeMaterialApplication:function(){this._matApp=null,this._updateMaterial()},_updateMaterial:function(){var e,t,i,r;e=this._occurrences.length;var n=this._getMaterialApplication();for(r=0;r<e;r++)!(i=(t=this._occurrences[r]).parent)&&n?t.matApp=n:this._updateOccurrences(i,t,!1),null!==t.renderable&&(t.renderable.matApp=t.matApp)},setGAS:function(e){this._reduceMaterial(),this._setGAS(e),this._incrementMaterial()},getGAS:function(){return this._gas},_setGAS:function(e){var t,i,r,n;if(e)for(this._gas=e.__getGAS(this._gas),t=this._occurrences.length,n=0;n<t;n++)(r=(i=this._occurrences[n]).parent)?this._updateOccurrences(r,i,!1):i.gas=this._gas?this._gas.clone():null,null!==i.renderable&&(i.renderable.gas=i.gas)},_getGAS:function(){return this._gas},setVisibility:function(e,r){if(this._getVisible()!==e){var n,a,s,o,l,c,h;if(this._setVisible(e),r)(d=this._getViewer())&&(h=d.getRobot()),h&&h.isTargetGone(d.visibleSpace)&&h.setConnectionState(!1);for(n=this._occurrences.length,l=0;l<n;l++){if((s=this._occurrences[l]).parent?s._setVisible(s.parent._getVisible()&&this._getVisible()):s._setVisible(this._getVisible()),null!==s.renderable){s.renderable.visible=s._getVisible();var u,d=null;if(void 0!==s.renderable.highlightMeshes&&null!==s.renderable.highlightMeshes)if(!(d=s.scene3js&&s.scene3js.viewer)||!d.picking.forceVisibility)for(u=0;u<s.renderable.highlightMeshes.length;u++)s.renderable.highlightMeshes[u].renderable.visible=s._getVisible();if(void 0!==s.renderable.preHighlight&&null!==s.renderable.preHighlight&&(d||(d=s.scene3js&&s.scene3js.viewer),d&&d.pPicking.forceVisibility||(s.renderable.preHighlight.visible=s._getVisible())),s.renderable instanceof i.CSS2DNode||s.renderable instanceof i.CSS3DNode){var p=!0;this._getViewer()&&(p=this._getViewer().visibleSpace);(s._getVisibilityFree()?s._getVisible():p?s._getVisible():!s._getVisible())||(s.renderable.element.style.display="none")}}s.updateVisibilityFlag()}for(l=0;l<n;l++)for(a=(s=this._occurrences[l]).children.length,c=0;c<a;c++)o=s.children[c],this._updateOccurrences(s,o,!0);this._updateVisibilityFlag();var f={eventChannel:"/VISU/onSceneGraphUpdate",eventType:e?"SHOWTREE":"HIDETREE",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:f})}},setVisibilityFree:function(e){if(this._getVisibilityFree()!==e){var r,n,a,s,o,l,c;for(this._setVisibilityFree(e),(u=this._getViewer())&&(c=u.getRobot()),c&&c.isTargetGone(u.visibleSpace)&&c.setConnectionState(!1),r=this._occurrences.length,o=0;o<r;o++){if((a=this._occurrences[o]).parent?a._setVisibilityFree(a.parent._getVisibilityFree()||this._getVisibilityFree()):a._setVisibilityFree(this._getVisibilityFree()),null!==a.renderable){a.renderable.visibilityFree=a._getVisibilityFree();var h,u=null;if(void 0!==a.renderable.highlightMeshes&&null!==a.renderable.highlightMeshes)if(!(u=a.scene3js&&a.scene3js.viewer)||!u.picking.forceVisibility)for(h=0;h<a.renderable.highlightMeshes.length;h++)a.renderable.highlightMeshes[h].renderable.visibilityFree=a._getVisibilityFree();if(void 0!==a.renderable.preHighlight&&null!==a.renderable.preHighlight&&(u||(u=a.scene3js&&a.scene3js.viewer),u&&u.pPicking.forceVisibility||(a.renderable.preHighlight.visibilityFree=a._getVisibilityFree())),a.renderable instanceof i.CSS2DNode||a.renderable instanceof i.CSS3DNode){var d=!0;this._getViewer()&&(d=this._getViewer().visibleSpace);(a._getVisibilityFree()?a._getVisible():d?a._getVisible():!a._getVisible())||(a.renderable.element.style.display="none")}}a.updateVisibilityFreeFlag()}for(o=0;o<r;o++)for(n=(a=this._occurrences[o]).children.length,l=0;l<n;l++)s=a.children[l],this._updateOccurrences(a,s,!1);this._updateVisibilityFreeFlag();var p={eventChannel:"/VISU/onSceneGraphUpdate",eventType:e?"VISIBILITYFREE":"VISIBILITYDEPENDENT",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:p})}},setMatrix:function(e,t){if(e&&!e.isIdentity){e=(new i.Matrix4).copy(e);var r=new Error;console.error(r.stack),console.error("ERROR: setMatrix requires a THREE.Matrix4!")}!e||e.isIdentity()?this._matrix=null:this._matrix?this._matrix.copy(e):this._matrix=(new i.Matrix4).copy(e),this._updateMatrix(t)},applyMatrix:function(e){if(e&&!e.isIdentity){e=(new i.Matrix4).copy(e);var t=new Error;console.error(t.stack),console.error("ERROR: setMatrix requires a THREE.Matrix4!")}e&&!e.isIdentity()&&(this._matrix?(this._matrix.multiplyMatrices(e,this._matrix),this._matrix.isIdentity()&&(this._matrix=null)):(this._matrix=new i.Matrix4,this._matrix.copy(e))),this._updateMatrix()},setVisibilityInTree:function(e){if(this._getVisibilityInTree()!==e){this._setVisibilityInTree(e);for(var i=0;i<this.parents.length;i++){var r={eventChannel:"/VISU/onSceneGraphUpdate",eventType:e?"ADDTREE":"REMOVETREE",fromNode:this.parents[i],toNode:this};t.publish({event:"/VISU/onSceneGraphUpdate",data:r})}}},getVisibilityInTree:function(){return void 0===this._getVisibilityInTree()||this._getVisibilityInTree()},setIcon:function(e){this._iconInTree=""===e?"":e;var i={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"CHANGEICON",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:i})},getIcon:function(){return void 0!==this._iconInTree?this._iconInTree:""},setName:function(e){this.name=e;var i={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"CHANGENAME",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:i})},getName:function(){return this.name},getPickable:function(){return this.getNoPickThrough()?this._getPickable()?a.PICKABLE:a.NOPICKABLE:a.PICKTHROUGH},setPickable:function(e){var t,i,r,n,s,o;for("boolean"==typeof e&&console.log("boolean is DEPRECATED in setPickable() method.\n Use ENUM Mesh"),this._setPickable(e===a.PICKABLE),this.setNoPickThrough(e!==a.PICKTHROUGH),t=this._occurrences.length,s=0;s<t;s++)(r=this._occurrences[s]).parent?(r._setPickable(r.parent._getPickable()&&this._getPickable()),r.setNoPickThrough(r.parent.getNoPickThrough()&&this.getNoPickThrough())):(r._setPickable(this._getPickable()),r.setNoPickThrough(this.getNoPickThrough())),null!==r.renderable&&(r.renderable.pickable=r._getPickable(),r.renderable.noPickThrough=r.getNoPickThrough(),r.renderable._flagAsGSSOInvalidated());for(s=0;s<t;s++)for(i=(r=this._occurrences[s]).children.length,o=0;o<i;o++)n=r.children[o],this._updateOccurrences(r,n,!1)},isPickable:function(){return this._getPickable()},getNoZPriority:function(){return this._getNoZPriority()},setNoZPriority:function(e){var t,i,r,n,a,s;for(this._setNoZPriority(e),t=this._occurrences.length,a=0;a<t;a++){var o=(r=this._occurrences[a]).parent;if(o)this._updateOccurrences(o,r,!1);else for(i=r.children.length,s=0;s<i;s++)n=r.children[s],this._updateOccurrences(r,n,!1)}},setPickParent:function(e){this._setPickParent(e)},getPickParent:function(){return!!this._getPickParent()},setPickingPriorityId:function(e){var t,i,r,n,a,s;for(this.pickingPriorityID||(this.pickingPriorityID={faces:null,edges:null,points:null}),"string"==typeof e&&(this.pickingPriorityID.faces=e,this.pickingPriorityID.edges=e,this.pickingPriorityID.points=e),(e.faces||null===e.faces)&&(this.pickingPriorityID.faces=e.faces),(e.edges||null===e.edges)&&(this.pickingPriorityID.edges=e.edges),(e.points||null===e.points)&&(this.pickingPriorityID.points=e.points),t=this._occurrences.length,a=0;a<t;a++)(r=this._occurrences[a]).pickingPriorityID=this.pickingPriorityID,null!==r.renderable&&(r.renderable.pickingPriorityID=r.pickingPriorityID);for(a=0;a<t;a++)for(i=(r=this._occurrences[a]).children.length,s=0;s<i;s++)n=r.children[s],this._updateOccurrences(r,n,!1)},getPickingPriorityId:function(){return this.pickingPriorityID},exludeFromBounding:function(e){this.setExcludeFromBounding(e),this._invalidateBoundingElements(!1,!0)},translate:function(e,t){var r=new i.Vector3;this._matrix&&(t.transformDirection(this._matrix),r.getPositionFromMatrix(this._matrix)),r.add(t.multiplyScalar(e)),this._matrix||(this._matrix=new i.Matrix4),this._matrix.setPosition(r),this._updateMatrix()},translateX:function(e){var t=new i.Vector3(1,0,0);this.translate(e,t)},translateY:function(e){var t=new i.Vector3(0,1,0);this.translate(e,t)},translateZ:function(e){var t=new i.Vector3(0,0,1);this.translate(e,t)},getMaterial:function(e){var t=this._filters?this._filters.get(x.LOOK):null,i=this._getMaterialApplication();if(!i||t){var r=t?t.material:this._material;if(r)switch(e){case"Face":case"GeomFace":return r;case"Line":return r.line;case"Point":return r.point}return r}switch(e){case"Face":return i._material;case"GeomFace":return i._materialGeomFace;case"Line":return i._materialLine;case"Point":return i._materialPoint}return i._material?i._material:i._materialGeomFace?i._materialGeomFace:i._materialLine?i._materialLine:i._materialPoint?i._materialPoint:null},isVisible:function(){return this._getVisible()},getMatrix:function(){return this._matrix?this._matrix.clone():new i.Matrix4},getChildren:function(){return[].concat(this.children)},getParents:function(){return[].concat(this.parents)},getNodeType:function(){return"Node3D"},whiteVectorInBlack:function(){this.modifyColor(new i.Color(0),new i.Color(16777215))},modifyColor:function(e,t,r){if(!g){if("Mesh3D"===this.getNodeType()){var n=this._occurrences[0].renderable.geometry;if(!(n instanceof Array))return;for(var a=0;a<n.length;a++)for(var s=n[a].drawingGroups,o=0;o<s.length;o++){var l=s[o];if(l.gas&&l.gas.color){if(l.gas instanceof i.ParticleBasicMaterial)continue;var c=l.gas.color;if(r&&r!==l.glType)continue;if(c.equals(t)){var h=l.gas.clone();h.color=e,l.gas=h}}if(l.material&&l.material.color){if(l.material instanceof i.ParticleBasicMaterial)continue;c=l.material.color;if(r&&r!==l.glType)continue;if(c.equals(t)){var u=l.material.clone();u.color=e,l.material=u}}}}for(o=0;o<this.children.length;o++)this.children[o].modifyColor(e,t,r)}},getBoundingSphere:function(e,t){"show"===e&&(console.warn("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace");var i=this._getBoundingSphere(e,t);return i?i.clone():null},createOverrideSetManager:function(){return!this._overrideSetManager&&b.SceneGraphOverrideSetManager&&this._setOverrideSetManager(new b.SceneGraphOverrideSetManager({node:this})),this._overrideSetManager},getOverrideSetManager:function(){return this._overrideSetManager},removeOverrideSetManager:function(){this._overrideSetManager&&(this._overrideSetManager.clear(),this._overrideSetManager=null)},_setOverrideSetManager:function(e){this._overrideSetManager=e,this._setOverrideSetManagerUnder(!0)},_getViewer:function(){return this._occurrences.length>0&&this._occurrences[0].scene3js?this._occurrences[0].scene3js.viewer:null},_getAllOwningViewers:function(){var e,t,i=[];for(e=0;e<this._occurrences.length;e++)this._occurrences[e].scene3js&&(t=this._occurrences[e].scene3js.viewer)&&i.indexOf(t)<0&&i.push(t);return i},_hasOccurrenceInViewer:function(e){var t;for(t=0;t<this._occurrences.length;t++)if(this._occurrences[t].scene3js&&e===this._occurrences[t].scene3js.viewer)return!0;return!1},_tryOverridesUpdate:function(e){var t=e.getSceneGraphOverrideSetManager();t&&t._fullOccurrencesUpdate();var i,r,n=e?e.hasSceneGraphOverrideSet():null,a=this._occurrences,s=!1;if(this._getOverrideSetManagerUnder())for(i=0;i<a.length;i++)((r=a[i]).isOverridesUpdateRequested()||r.doesADescendantNeedOverrideUpdate())&&(s=!0);for(s&&this.traverseUnique(function(e){e._overrideSetManager&&(e._overrideSetManager._refresh(),n=!0)}),i=0;i<a.length;i++)a[i].traverseWithCondition(function(e){return e.isOverridesUpdateRequested()?(e.updateOverrideStatus(n),null):!!e.doesADescendantNeedOverrideUpdate()||null}),a[i].clearOverridesUpdateRequest()},forceBoundingElements:function(e,t,r){function n(e){var t=null;return void 0===e.sphere&&void 0===e.box||(t={sphere:e.sphere||function(e){if(!e)return null;var t=new i.Vector3(.5*(e.min.x+e.max.x),.5*(e.min.y+e.max.y),.5*(e.min.z+e.max.z)),r=t.distanceTo(e.max),n=new i.Sphere;return n.center=t,n.radius=r,n}(e.box),box:e.box||function(e){if(!e)return null;var t=new i.Vector3(2*e.radius,2*e.radius,2*e.radius),r=new i.Box3;return r.setFromCenterAndSize(e.center,t),r}(e.sphere)}),t}if(e){r=r||{};var a=n(t=t||{}),s=n(r);this.__forceBoundingElements(a,s)}else this._getForceBoundingElements()&&(this._setForceBoundingElements(!1),this._invalidateBoundingElements(!1,!1))},__forceBoundingElements:function(e,t){this._setForceBoundingElements(!0),this._bsShow=e&&e.sphere,this._bsNoShow=t&&t.sphere,this._bbShow=e&&e.box,this._bbNoShow=t&&t.box,this._invalidateBoundingElements(!1,!1)},getBoundingBox:function(e){return"show"===e&&(console.warn("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace"),this._getBoundingBox(e).clone()},_getBoundingSphere:function(e,t){e=e||"visibleSpace";var r,n,a=null;return this.getHasExplicitBE()?(r=this.explicitBSphere,n=null):(this._updateBoundingElements(),r=this._bsShow,n=this._bsNoShow),(a=this._getVisibilityFree()?this._getVisible()?r:null:this._getVisible()?"visibleSpace"===e?r:n:"visibleSpace"===e?null:i.mergeBoundingSphereInto(r&&r.clone(),n,this.getRatio()))||t||(a=new i.Sphere),a},_getBoundingBox:function(e){e=e||"visibleSpace";var t,r,n=null;return this.getHasExplicitBE()?(t=this.explicitBBox,r=null):(this._updateBoundingElements(),t=this._bbShow,r=this._bbNoShow),(n=this._getVisibilityFree()?this._getVisible()?t:null:this._getVisible()?"visibleSpace"===e?t:r:"visibleSpace"===e?null:i.mergeBoundingBoxInto(t&&t.clone(),r))||(n=new i.Box3),n},_invalidateBoundingElements:function(e,t){if(!e){var i=0;for(i=0;i<this._occurrences.length;i++)this._occurrences[i]._invalidateBoundingElements(t)}if(!this._getNeedBEUpdate()&&(this._setNeedBEUpdate(!0),!this.getExcludeFromBounding()||t)){var r=0;for(r=0;r<this.parents.length;r++)this.parents[r]._invalidateBoundingElements(!0,!1)}},_updateVisibilityFlag:function(){this._invalidateBoundingElements(!1,!1)},_updateVisibilityFreeFlag:function(){this._invalidateBoundingElements(!1,!1)},_updateShadowMapsIfNeeded:function(e){var t=this._getViewer(),i=e;return t&&t.useShadowMap&&(void 0===i&&(i=!0,this.traverse(function(e){return!!e.getExcludeFromBounding()&&(i=!1,!0)},void 0,!0)),(i=i&&!this.getExcludeFromBounding())&&t._updateShadowMaps()),i},_updateBoundingElements:function(e,t){var r;if(this._getNeedBEUpdate()){if(t=this._updateShadowMapsIfNeeded(t),!this._getForceBoundingElements()){for(r=0;r<this.children.length;r++)this.children[r]._updateBoundingElements(!0,t);this.updateBoundingElements_internal("_bsShow","_bsNoShow",i.mergeBoundingSphereInto,"bSphere"),this.updateBoundingElements_internal("_bbShow","_bbNoShow",i.mergeBoundingBoxInto,"bBox")}if(!e)for(r=0;r<this._occurrences.length;r++)this._occurrences[r]._updateBoundingElements(!0);this._setNeedBEUpdate(!1)}},_areBoundingElementsIncludedInParent:function(e){var t=new i.Sphere,r=new i.Box3,n=this._matrix;function a(e,i){return!(e&&!i)&&(!e||(t.copy(e),n&&t.applyMatrix4(n),!!i.containsSphere(t)))}function s(e,t){return!(e&&!t)&&(!e||(r.copy(e),n&&r.applyMatrix4(n),!!t.containsBox(r)))}return this._updateBoundingElements(),a(this._bsShow,e._bsShow)&&s(this._bbShow,e._bbShow)&&a(this._bsNoShow,e._bsNoShow)&&s(this._bbNoShow,e._bbNoShow)},updateBoundingElements_internal:function(e,t,i,r){if(!this._getForceBoundingElements()){var n=null,a=null;if(this.children.length){var s,o,l,c=0;for(c=0;c<this.children.length;c++)(s=this.children[c]).getExcludeFromBounding()||(o=s[e],l=s[t],s._getVisibilityFree()?s._getVisible()&&(n=i(n,o,s._matrix,s.getRatio()),a=i(a,o,s._matrix,s.getRatio())):s._getVisible()?(n=i(n,o,s._matrix,s.getRatio()),a=i(a,l,s._matrix,s.getRatio())):(a=i(a,o,s._matrix,s.getRatio()),a=i(a,l,s._matrix,s.getRatio())))}else this.getHasExplicitBE()&&(n=this[r],a=null);this[e]=n,this[t]=a}},getRatio:function(){return 0},updateBoundingSphere:function(){this._invalidateBoundingElements(!1,!1)},updateBoundingSphereFromParentToChildren:function(){b.DEPRECATED_Method(new Error)},updateBoundingBox:function(){this._invalidateBoundingElements(!1,!1)},isIncludedIn:function(e){if(!this.bSphere.radius)return!0;var t=this.bSphere.clone();return this._matrix&&t.applyMatrix4(this._matrix),t.center.distanceTo(e.bSphere.center)+t.radius<=e.bSphere.radius},getMatrixWorld:function(e){if(g)return null;var t,a;if(1===this._occurrences.length)return this._occurrences[0].matrix?this._occurrences[0].matrix.clone():new i.Matrix4;if(void 0===e)return console.warn("This node is an instance. An occurrence path has to be specified."),null;if(e instanceof r){var s=new n;s.setFromOccurrencePath(e),e=s}if((a=e._getOccurrences()).length>1)return console.warn("More than one occurrence satisfies this occurrence path. Unable to return a unique matrixWorld."),null;if(!a.length)return console.warn("No occurrence satisfies this occurrence path. Unable to return a matrixWorld."),null;for(t=0;t<this._occurrences.length;t++)if(a[0]===this._occurrences[t])return a[0].matrix?a[0].matrix.clone():new i.Matrix4;return console.warn("The occurrence path has to terminate with the current node name. Unable to return a matrixWorld."),null},isInstance:function(){return this._occurrences.length>1},buildAccelerationStructure:function(e){for(var t=this._occurrences.length,i=0;i<t;i++)for(var r=this._occurrences[i]._getRenderableOccurrences(),n=0;n<r.length;n++){r[n].computeKDTree(e)}},setScene:function(e){var t,i,r,n,a,s;for(t=this._occurrences.length,a=0;a<t;a++)(r=this._occurrences[a]).scene3js=e;for(a=0;a<t;a++)for(i=(r=this._occurrences[a]).children.length,s=0;s<i;s++)n=r.children[s],this._updateOccurrences(r,n,!0)},subscribe:function(e,t){void 0===this.modelEvents&&(this.modelEvents=new s),this.modelEvents.subscribe(e,t)},isReady:function(){return!0},_updateMatrix:function(e){var t,i,r,n,a,s,o;for(t=this._occurrences.length,a=0;a<t;a++)if((r=this._occurrences[a]).updateMatrix(this._matrix),null!==r.renderable){var l;if(r.renderable.setMatrix(r.matrix,!1),r.renderable.orientation=!r.matrix||r.matrix.determinant()>0?1:-1,void 0!==r.renderable.highlightMeshes&&null!==r.renderable.highlightMeshes)for(l=0;l<r.renderable.highlightMeshes.length;l++)r.renderable.highlightMeshes[l].renderable.setMatrix(r.matrix,!1);if(void 0!==r.renderable.preHighlight&&null!==r.renderable.preHighlight&&r.renderable.preHighlight.setMatrix(r.matrix,!1),r.scene3js&&r.scene3js.viewer&&r.renderable.castShadow)for(var c=0;c<r.scene3js.parent.__lights.length;c++){var h=r.scene3js.parent.__lights[c];h.blockUpdate||(h.updateShadowMap=!0)}}for(a=0;a<t;a++)for(i=(r=this._occurrences[a]).children.length,r.overrideLink&&(r.overrideLink.setMatrixUpdate(),r.requestOverridesUpdate()),s=0;s<i;s++)n=r.children[s],this._updateOccurrences(r,n,!0,e,!0);if(!e)for(a=0,o=this.parents.length;a<o;a++)this.getExcludeFromBounding()||this.parents[a]._invalidateBoundingElements(!1,!1)},_copyTree:function(e){var t,i,r,n,a;for(t=e.lightCopy(),e.node._occurrences.push(t),e._invalidateBoundingElements(!1),r=e.children.length,a=0;a<r;a++)n=e.children[a],(i=this._copyTree(n)).parent=t,t.children.push(i),t._invalidateBoundingElements(!1);return t},_deleteTree:function(e){var t,i,r,n,a;-1!==(i=(t=e.node)._occurrences.indexOf(e))&&t._occurrences.splice(i,1),null!==e.renderable&&null!==e.scene3js&&("Mesh3D"===e.node.getNodeType()||"ParticlesNode3D"===e.node.getNodeType()?e.scene3js.containsObject(e.renderable)&&(this._removeFromVisuSelection(e.renderable),e.scene3js.remove(e.renderable),"Mesh3D"===e.node.getNodeType()&&e.renderable.releaseVBO(!1)):"LightNode3D"===e.node.getNodeType()?e.scene3js.containsLight(e.renderable)&&e.scene3js.remove(e.renderable):"LensFlareNode3D"===e.node.getNodeType()?e.scene3js.containsLensFlare(e.renderable)&&e.scene3js.remove(e.renderable):"CSS2DNode"!==e.node.getNodeType()&&"CSS3DNode"!==e.node.getNodeType()||e.scene3js.containsObject(e.renderable)&&(e.scene3js.remove(e.renderable),e.renderable.element.parentNode&&e.renderable.element.parentNode.removeChild(e.renderable.element)));var s=e.scene3js&&e.scene3js.viewer;for(s&&2===s._sceneGraphStateVersion&&(e.originalOverrideSet&&(e.originalOverrideSet.onDetach(s,e),e.originalOverrideSet=null),e.overrideLink=null),e.scene3js=null,n=e.children.length,r=0;r<n;r++)a=e.children[r],this._deleteTree(a)},forceUpdate:function(){this._forceUpdate()},_forceUpdate:function(){var e,t,i=this._getAllOwningViewers();for(e=0;e<i.length;e++)i[e]&&this._tryOverridesUpdate(i[e]);if(this.parents.length>0)for(e=0;e<this._occurrences.length;e++)t=this._occurrences[e],this._updateOccurrences(t.parent,t,!0);else for(e=0;e<this.children.length;e++)this.children[e]._forceUpdate()},onLinkToSceneGraph:function(e){if(!g){var t,i,r=e.traverseUnique(function(e){}),n=[],a=[];for(t=0;t<r.length;t++)(i=r[t])._occurrences[0].__rdo_visited=0;for(t=0;t<r.length;t++){for(i=r[t],s=0;s<i.children.length;s++)i.children[s]._occurrences[0].__rdo_visited++}for(e._onLinkToSceneGraph_internal(!0,n,a),t=0;t<r.length;t++){var s;(i=r[t])._occurrences[0].__rdo_visited=0}for(t=n.length-1;t>=0;t--)(i=n[t])._onLinkedToSceneGraph(),i._requestClippingUpdate();for(t=a.length-1;t>=0;t--)(i=a[t])._onUnlinkedToSceneGraph(),i._requestClippingUpdate();null!==b._onLinkToSceneGraph_DEBUG&&b._onLinkToSceneGraph_DEBUG(r,n,a)}},_onLinkToSceneGraph_internal:function(e,t,i){var r,n=!1;if(!g){var a,s=e;for(r=0;!s&&r<this.parents.length;r++)(a=this.parents[r])._occurrences.length>0&&-1===a._occurrences[0].__rdo_visited&&(s=!0);if(s){for(r=0;r<this.parents.length;r++)if(this.parents[r].getLinkedToSceneGraph()){n=!0;break}var o;for(this.getLinkedToSceneGraph()!==n&&(this.setLinkedToSceneGraph(n),this._occurrences[0].__rdo_visited=-1,n?t.push(this):i.push(this)),r=0;r<this.children.length;r++)(o=this.children[r])._occurrences[0].__rdo_visited--,0===o._occurrences[0].__rdo_visited&&o._onLinkToSceneGraph_internal(!1,t,i)}}},_propagateGAS:function(e,t){t?e.gas?e.gas.copy(t):e.gas=t.clone():e.gas=null},_propagateMatApp:function(e,t){t?(e.matApp?e.matApp.copy(t):e.matApp=t.clone(),-1===e.matApp._depth&&(e.matApp._depth=e.depth)):e.matApp=null},_updateOccurrences:function(e,t,r,a,s){if(!g){var l,c,h,d;l=e.node,c=t.node,e.parent||(e.depth=0),t.depth=e.depth+1,t._copyForceShowStatusFromOcc(e),h=t.scene3js;var p=null,f=null,m=null,v=null,S=null,_=null,y=null,M=null,P=!1,C=!1,D=!1;if(t.overrideLink){if(t.renderable&&(t.overrideLink.internalMaterialOverrideReset&&(t.overrideLink.internalMaterialOverrideReset=!1,t.renderable.layer=null),t.overrideLink.internalMaterialOverride&&t.originalOverrideSet)){var w=t.overrideLink.internalMaterialOverride;w.material&&((d=new n).setFromArray(t.originalOverrideSet.pathElement.externalPath,w.internalPath),b._applyMaterialToPath(d,w.material)),t.overrideLink.internalMaterialOverrideReset=!0}p=t.overrideLink.getSubstituteMatrix(),f=t.overrideLink.getVisibility(),_=t.overrideLink.getVisibilityFree(),m=t.overrideLink.getPickability(),v=t.overrideLink.getPickingPriorityID(),S=t.overrideLink.getClipping(),y=t.overrideLink.getRenderStyle(),C=t.overrideLink.visibilityFix,t.originalOverrideSet&&t.originalOverrideSet.invalidateBE&&(t.originalOverrideSet.unsetInvalidateBE(),P=!0),t.overrideLink.getMatrixUpdate()&&(t.overrideLink.clearMatrixUpdate(),D=!0),f&&t.overrideLink.getForceShowVisibility()&&!f.visibility&&t._setForceShowHide(!0),m&&t.overrideLink.getForceShowPickability()&&("NOT_PICKABLE"===m?t._setForceShowNoPickability(!0):"IGNORED"===m&&(t._setForceShowNoPickability(!0),t._setForceShowNoDrawHL(!0)))}t.setIsInBackground(e.isInBackground()&&c.isInBackground()),t._setIsAlwaysInForeground(e._isAlwaysInForeground()||c._isAlwaysInForeground());var T=null;if(t&&t.originalOverrideSet&&(t.originalOverrideSet.hasMaterialOverride()||t.originalOverrideSet.internalMaterialOverride)&&(T=t.overrideLink),2===e._relativeVisibility&&(t._relativeVisibility=e._relativeVisibility),null!==t._relativeVisibility&&(C=2!==t._relativeVisibility,f={visibility:t._relativeVisibility}),null!==t){if(t.scene3js=e.scene3js,r||c._isDynamic||D)if(p)t.updateMatrix(p,!0);else{if(p=c._matrix,c._isDynamic&&t.scene3js){var A=t.scene3js.viewer.currentViewpoint;if(A){var I=c._getDynamicMatrix(e.matrix,null,A);I&&(p=I,c._matrix||(c._matrix=new i.Matrix4),c._matrix.copy(p),a||c._invalidateBoundingElements(!1,!1))}}t.localMatrixOverride&&(P=!0),t._relativeMatrix&&(p=t._relativeMatrix),t.updateMatrix(p)}M=e.getViewer(),t.renderMode=y?y._combineRenderMode(e.renderMode,c._renderMode):c._renderMode||e.renderMode,t.pickingMode=c._pickingMode||e.pickingMode,t.layerFilter=c._layerFilter?c._layerFilter:e.layerFilter,t.renderable&&(t.renderable.filtered=t._isFiltered()),t._setAdvancedPriority(c._getAdvancedPriority()?c._getAdvancedPriority():e._getAdvancedPriority()),t._setDepthMode(c._getDepthMode()?c._getDepthMode():e._getDepthMode()),M&&M.currentViewpoint&&M.currentViewpoint.isNative2D()&&M.currentViewpoint._depthMode&&(c._gas?c._depthPriority=c._gas._priority-4+l._depthPriority:c._depthPriority=l._depthPriority);var R=y;t.faceMode=R&&R._combineFaceMode(e.faceMode)||e.faceMode;var L=c.passes?c.passes:e.passes;t.forcePasses&&(L=t.forcePasses);var O=t.scene3js&&t.scene3js.parent instanceof i.Scene?t.scene3js.parent:null;if(t.renderable&&t.renderable.fromLoadedModel){var N=M&&M._renderStyle,F=t.faceMode&&t.faceMode.face||N&&N._faceMode;F===u.FaceModes.ZONLY?L=["ZOnly"]:F===u.FaceModes.BACKGROUND&&(L=["background"])}var V=L,U=null;(t.renderPriority||e.renderPriority)&&(U=function(e,t){if(!t)return e&&(e.userPriority||e.userOpacity)?{userPriority:!1,priority:e.priority,userOpacity:!1,opacity:e.opacity,lastRenderPriority:e.lastRenderPriority}:{userPriority:e.userPriority,priority:e.priority,userOpacity:e.userOpacity,opacity:e.opacity,lastRenderPriority:e.lastRenderPriority};if(!e)return{userPriority:t.userPriority,priority:t.priority,userOpacity:t.userOpacity,opacity:t.opacity,lastRenderPriority:t.lastRenderPriority};return{userPriority:t.userPriority,priority:t.userPriority?t.priority:e.priority,userOpacity:t.userOpacity,opacity:t.userOpacity?t.opacity:e.opacity,lastRenderPriority:t.lastRenderPriority}}(e.renderPriority,t.renderPriority));var B=M&&M._renderPriorityManager&&M._renderPriorityManager.enabled;t.renderPriority=U;var k=-1;B&&(U||(U={userPriority:!1,priority:0,userOpacity:!1,opacity:-1,lastRenderPriority:-1},t.renderPriority=U),V=function(e,t){if(!e||1===e.length&&"main"===e[0])return E[t];var i,r,n=[];for(i=0;i<e.length;i++)"main"===(r=e[i])?n=n.concat(E[t]):n.push(r);return n}(L,k=U&&U.priority||0));var G,z=V!==t.passes||t.renderPriority&&k!==t.renderPriority.lastRenderPriority;if(t.renderPriority&&(t.renderPriority.lastRenderPriority=k),t.renderable&&O&&z&&O.updateObjectPasses(t.renderable,V),t.passes=L,c._isDecal)t.material=c._material,(G=t._getMaterialApplication())&&this._propagateMatApp(t,G);else e.material&&"forceGeomTypeFACE"===e.material.force?t.material=c._material||e.material:t.material=null!==e.material?e.material:c._material,t.forceGAS?t.gas=t.forceGAS:(e.gas&&!c._gas?this._propagateGAS(t,e.gas):this._propagateGAS(t,c._gas),e.gas&&c._gas&&t.gas.merge(e.gas,l._filters&&l._filters.get(x.GAS_INHERIT))),(G=t._getMaterialApplication())&&e.matApp?G.isPrioritary(e.matApp,t.depth)?this._propagateMatApp(t,G):this._propagateMatApp(t,e.matApp):G?this._propagateMatApp(t,G):this._propagateMatApp(t,e.matApp);t._setInvertMode(!f&&(e._getInvertMode()||c._getInvertMode())),t._setInvertPickMode(!m&&(e._getInvertPickMode()||c._getInvertPickMode()));var H=t._getVisible(),W=t._getVisibilityFree();C?(t._setVisible(we(e._getVisible(),f,f&&f.visibility,c._getVisible(),t.overrideLink&&t.overrideLink.getForceShowVisibility(),t._getForceShowHide())),t._setPickable(we(e._getPickable(),m,"PICKABLE"===m,c._getPickable(),t.overrideLink&&t.overrideLink.getForceShowPickability(),t._getForceShowNoPickability())),t.setNoPickThrough(we(e.getNoPickThrough(),m,"IGNORED"!==m,c.getNoPickThrough(),t.overrideLink&&t.overrideLink.getForceShowPickability(),t._getForceShowNoDrawHL())),t._setVisibilityFree(e._getVisibilityFree()||(_?_.visibilityFree:c._getVisibilityFree()))):(t._setVisible(f?f.visibility:e._getVisible()&&c._getVisible()),t._setVisibilityFree(e._getVisibilityFree()||c._getVisibilityFree()),t._setPickable(m?"PICKABLE"===m:e._getPickable()&&c._getPickable()),t.setNoPickThrough(m?"IGNORED"!==m:e.getNoPickThrough()&&c.getNoPickThrough())),t._setNoZPriority(e._getNoZPriority()||c._getNoZPriority()),c._propagateVisuFilters(t,e._filters),t._propagateSubstituteMaterials(e.__solvedSubstituteMaterials),e._filters&&e._filters.has(x.DO_NOT_PICK_UNDER)&&c.setPickParent(e._filters.get(x.DO_NOT_PICK_UNDER)._doNotPickUnder),t._getVisible()!==H&&t.updateVisibilityFlag(),t._getVisibilityFree()!==W&&t.updateVisibilityFreeFlag(),e.pickingPriorityID&&e.pickingPriorityID._override?t.pickingPriorityID=e.pickingPriorityID:t.pickingPriorityID=v||(c.pickingPriorityID?c.pickingPriorityID:e.pickingPriorityID),l._getPropagateXSOExclusion()&&(c._setPropagateXSOExclusion(!0),c._setExcludeFromCSO(l._getExcludeFromCSO()),c._setExcludeFromHSO(l._getExcludeFromHSO()),c._setExcludeFromPSO(l._getExcludeFromPSO()),c._setExcludeFromHL(l._getExcludeFromHL()),c._setExcludeFromPreHL(l._getExcludeFromPreHL()))}if(null!==t.renderable){if(!s&&t.renderable._flagAsGSSOInvalidated(),t.renderable.setMatrix(t.matrix,!1),t.renderable._ratioData=c._ratioData,t.renderable._billboardData=c._billboardData,t.renderable.orientation=!t.matrix||t.matrix.determinant()>0?1:-1,t.renderable._noZPriority=t._getNoZPriority(),M&&M.currentViewpoint&&M.currentViewpoint.isNative2D()?M.currentViewpoint._depthMode?(t.renderable._priorityMode=i.PriorityMode.DepthPriority,t.renderable._depthPriority=c._depthPriority):t.renderable._priorityMode=i.PriorityMode.ClassicPriority2D:t._getDepthMode()?t._getAdvancedPriority()?t.renderable._priorityMode=i.PriorityMode.Advanced:t.renderable._priorityMode=i.PriorityMode.ClassicPriority:t.renderable._priorityMode=i.PriorityMode.SceneGraphOrder,t.renderable._advancedPriority=t.advancedPriority,t.renderable._noZPriority||t.passes){var j=!!t._filters&&t._filters.has(x.LOOK)&&!!t._filters.get(x.LOOK).material,X="_refplaneitem_"===c.name;if(j||X){if(t.passes){var q=t.passes.indexOf("noz");-1!==q&&(t.passes=t.passes.slice(),t.passes[q]="main",O&&O.updateObjectPasses(t.renderable,t.passes))}t.renderable._noZPriority=!1}}c._isDecal?t.renderable._programID|=i.ProgramIDs.DECALS:t.renderable._programID&=~i.ProgramIDs.DECALS;M=null;var Z=t.renderable.highlightMeshes;if(null!=Z){M=t.scene3js&&t.scene3js.viewer;var Y,K=t._getVisible()&&!t._getInvertMode(),J=t._getVisibilityFree();for(ie=0;ie<Z.length;ie++)(Y=Z[ie].renderable).setMatrix(t.matrix,!1),M&&M.picking.forceVisibility||(Y.visible=K,Y.visibilityFree=J),Y._ratioData=c._ratioData,Y._billboardData=c._billboardData}if(void 0!==t.renderable.preHighlight&&null!==t.renderable.preHighlight&&(M||(M=t.scene3js&&t.scene3js.viewer),t.renderable.preHighlight.setMatrix(t.matrix,!1),M&&M.pPicking.forceVisibility||(t.renderable.preHighlight.visible=t._getVisible()&&!t._getInvertMode(),t.renderable.preHighlight.visibilityFree=t._getVisibilityFree()),t.renderable.preHighlight._ratioData=c._ratioData,t.renderable.preHighlight._billboardData=c._billboardData),t.renderable instanceof i.CSS2DNode||t.renderable instanceof i.CSS3DNode){var Q=!0;this._getViewer()&&(Q=this._getViewer().visibleSpace);(t._getVisibilityFree()?t._getVisible()&&!t._getInvertMode():Q?t._getVisible()&&!t._getInvertMode():!(t._getVisible()&&!t._getInvertMode()))||(t.renderable.element.style.display="none")}if(i.disableJHGDev)null!==t.material&&(t.renderable.material=t.material);else if(!t.material&&t.renderable._3dxmlMaterial)t.renderable.material=t.renderable._3dxmlMaterial;else{var $=t.renderable.material;$&&$.canvasNodeTextureSize||(t.renderable.material=t.material)}if(t.renderable.matApp=t.matApp,t.renderable.gas=t.gas,t.renderable.visible=t._getVisible()&&!t._getInvertMode(),t.renderable.visibilityFree=t._getVisibilityFree(),t.renderable.pickable=t._getPickable()&&!t._getInvertPickMode(),t.renderable.noPickThrough=t.getNoPickThrough()&&!t._getInvertPickMode(),t.renderable.pickingPriorityID=t.pickingPriorityID,null!==t.scene3js){if("Mesh3D"===t.node.getNodeType()||"ParticlesNode3D"===t.node.getNodeType()||"CSS3DNode"===t.node.getNodeType()||"CSS2DNode"===t.node.getNodeType()?t.scene3js.containsObject(t.renderable)||(t.scene3js.add(t.renderable,t.passes),"Mesh3D"===t.node.getNodeType()&&t.renderable.addRefVBO(!1)):"LightNode3D"===t.node.getNodeType()?t.scene3js.containsLight(t.renderable)||t.scene3js.add(t.renderable):"LensFlareNode3D"===t.node.getNodeType()&&(t.scene3js.containsLensFlare(t.renderable)||t.scene3js.add(t.renderable)),t.scene3js.viewer&&(t.scene3js.viewer._lockRenderIteration||(t.scene3js.viewer.renderIteration=0),t.renderable.castShadow))for(var ee=0;ee<t.scene3js.parent.__lights.length;ee++){var te=t.scene3js.parent.__lights[ee];te.blockUpdate||(te.updateShadowMap=!0)}}else null!==h&&("Mesh3D"===t.node.getNodeType()||"ParticlesNode3D"===t.node.getNodeType()?h.containsObject(t.renderable)&&(this._removeFromVisuSelection(t.renderable),h.remove(t.renderable),"Mesh3D"===t.node.getNodeType()&&t.renderable.releaseVBO(!1)):"LightNode3D"===t.node.getNodeType()?h.containsLight(t.renderable)&&h.remove(t.renderable):"LensFlareNode3D"===t.node.getNodeType()?h.containsLensFlare(t.renderable)&&h.remove(t.renderable):"CSS2DNode"!==t.node.getNodeType()&&"CSS3DNode"!==t.node.getNodeType()||h.containsObject(t.renderable)&&(h.remove(t.renderable),t.renderable.element.parentNode&&t.renderable.element.parentNode.removeChild(t.renderable.element)))}var ie,re=!!t.clippingContext,ne=!1,ae=S||c.clippingContext;if(t.clippingContext=ae?ae._mergeWithParent(e.clippingContext):e.clippingContext,t.clippingContext!==e.clippingContext&&(ne=!0),t.renderPriority!==e.renderPriority&&(ne=!0),t.clippingContext&&(re=!0),re&&(M||(M=e.getViewer()),M&&M._requestClippingUpdate()),T&&(e.occurrenceRenderingOverride&&e.occurrenceRenderingOverride.materialOverride&&e.occurrenceRenderingOverride.materialOverride===T||(ne=!0)),ne){t.occurrenceRenderingOverride=new o,t.occurrenceRenderingOverride.clipPlanes=t.clippingContext&&t.clippingContext.planes,t.occurrenceRenderingOverride.sectionLinesProperties=t.clippingContext&&t.clippingContext.sectionLinesProperties,t.occurrenceRenderingOverride.sectionCappingMaterials=t.clippingContext&&t.clippingContext.sectionCappingMaterials,t.occurrenceRenderingOverride.clippingContext=t.clippingContext,t.occurrenceRenderingOverride.clipCylinder=t.clippingContext&&t.clippingContext.cylinder;var se=t.clippingContext&&t.clippingContext._scissor;t.occurrenceRenderingOverride.scissor=se&&(se.getForOccurrenceOverride?se.getForOccurrenceOverride(t.matrix):se),t.occurrenceRenderingOverride.materialOverride=T||e.occurrenceRenderingOverride&&e.occurrenceRenderingOverride.materialOverride,t.occurrenceRenderingOverride.setRenderPriority(t.renderPriority),t.clippingContext&&t.clippingContext._clipPolyLine&&t.clippingContext.isClippingProfileEnabled()&&(t.occurrenceRenderingOverride.clipPolyLine=t.clippingContext._clipPolyLine.getForOccurrenceOverride(t.matrix))}else t.occurrenceRenderingOverride=e.occurrenceRenderingOverride;if(t.renderable)if(t.renderable.occurrenceRenderingOverride=t.occurrenceRenderingOverride,Z=t.renderable.highlightMeshes)for(ie=0;ie<Z.length;ie++)Z[ie].renderable.occurrenceRenderingOverride=t.occurrenceRenderingOverride;for(ie=0;ie<t.children.length;ie++)this._updateOccurrences(t,t.children[ie],r||c._isDynamic||D,a,s);return P&&e._invalidateBoundingElements(!1),!0}},_getOccurrencesFromOccurrencePath:function(e){var t,i,r,n,a,s,o,l,c;if(!e.path.length)return[];if(null===(t=this.getChildByName(e.path[0]))&&(t=this.getChildByName(e.path[0],1)),null===t)return[];for(a=t._occurrences,s=[],c=1;c<e.path.length;c++){for(i=e.path[c],o=0;o<a.length;o++)for(r=a[o].children,l=0;l<r.length;l++)(n=r[l]).node.name===i&&s.push(n);a=s,s=[]}return a},_getRenderableOccurrencesFromOccurrencePath:function(e){var t,i,r,n,a,s;for(t=this._getOccurrencesFromOccurrencePath(e),i=[],a=0;a<t.length;a++)for(n=t[a],r=this._getRenderableOccurrencesFromOccurrence(n),s=0;s<r.length;s++)i.push(r[s]);return i},_getRenderableOccurrencesFromOccurrence:function(e){var t,i,r,n,a;for(t=[],i=e.children,null!==e.renderable&&t.push(e.renderable),n=0;n<i.length;n++)for(r=this._getRenderableOccurrencesFromOccurrence(i[n]),a=0;a<r.length;a++)t.push(r[a]);return t},_removeFromVisuSelection:function(e){t.publish({event:"/VISU/SELECTION/REMOVE",data:e})},_removeInvalidElementsInXSO:function(e){var t,i,r=[WUX.Selection.CSOManager,WUX.Selection.HSOManager,WUX.Selection.PSOManager];for(t=0;t<r.length;t++){var n=r[t],a=[],s=n.get();for(i=0;i<s.length;i++){var o=s[i],l=o.pathElement;if(!l&&o.options&&(l=o.options.pathElement),l){var c=l._getIndexFromNode(this);if(-1===c)l.getElement(0,!0);else l.getElement(c+1,!0)===e&&a.push(o)}}for(i=0;i<a.length;i++)n.remove(a[i])}},addAsyncDependancies:function(e){console.warn("The addAsyncDependancies function doesn't do anything anymore: it shouldn't be called anymore.")},onAsyncDependancyCompleted:function(){this._onAllAsyncDependanciesCompleted()},_onAllAsyncDependanciesCompleted:function(){void 0!==this.modelEvents&&this.modelEvents.publish("onReady")},_onLinkedToSceneGraph:function(){},_onUnlinkedToSceneGraph:function(){},setNoZ:function(e){this.setRenderPasses(e?["noz"]:["main"])},setNoEffectNoZ:function(e){this.setRenderPasses(e?["noEffectNoz"]:["main"])},setNoHighlightNoZ:function(e){this.setRenderPasses(e?["afterHighlightNoZ"]:["main"])},setAsNativeIsoBag:function(e){switch(e){case 0:this.setRenderPasses(["iso_0"]);break;case 2:this.setRenderPasses(["iso_2"]);break;case 3:this.setRenderPasses(["iso_3"]);break;case 1:default:this.setRenderPasses(["main"])}},getNativeIsoLevel:function(){if(!this.passes||!this.passes.length)return 1;switch(this.passes[0]){case"iso_0":return 0;case"main":return 1;case"iso_2":return 2;case"iso_3":return 3}},setAsNativeDialog:function(e){if(this.setRenderPasses(e?["dialog"]:["main"]),e){this.propagateXSOExclusion(!0),this.exludeFromBounding(!0),this.excludeFromHSO(!0),this.excludeFromHighlight(!0),this.excludeFromPSO(!0);var t=this.createOverrideSetManager(),i=t.createSceneGraphOverrideSet();t.pushSceneGraphOverrideSet(i);var r=i.createOverride(new n([this])),a=new c([]);a.setUncut(!0),r.setClippingContext(a);var s=new u;s.setRenderMode("Face",!0),s.setRenderMode("@Edge",!1),s.setRenderMode("@Point",!1),s.setRenderMode("Outline",!1),s.setFaceMode("MATERIAL"),r.setRenderStyle(s)}else this.exludeFromBounding(!1),this.excludeFromHSO(!1),this.excludeFromHighlight(!1),this.excludeFromPSO(!1),this.enableLocalRenderEdgeMode(!1),this.removeOverrideSetManager();this._forceUpdate()},setAsNativeOnTop:function(e){this.setRenderPasses(e?["onTop"]:["main"]);let t=this._getViewer();t&&t.renderer.renderer.requestPoliteDepthBuffer()},setAsNativeFurtive:function(e){if(this.setRenderPasses(e?["furtive"]:["main"]),e){var t=this.createOverrideSetManager(),r=t.createSceneGraphOverrideSet();t.pushSceneGraphOverrideSet(r);var a=r.createOverride(new n([this])),s=new d({lineMaterial:new i.LineBasicMaterial({color:16760604,lineWidth:1}),faceMaterial:new i.MeshBasicMaterial({color:16760604}),pointMaterial:new i.ParticleBasicMaterial({color:16760604,size:1,opacity:1})});a.setMaterial(s,!0)}else this.removeOverrideSetManager()},setRenderPasses:function(e){var t,i=e.concat([]);for(t=0;t<e.length;t++)e[t]&&e[t]._getIdString&&(i[t]=e[t]._getIdString());var r=e=i;4===e.length&&e.indexOf("colorOld")>=0&&e.indexOf("depthOld")>=0&&e.indexOf("colorOldCapping")>=0&&e.indexOf("depthOldCapping")>=0&&(r=["compareOld"]),2===e.length&&e.indexOf("depthNew")>=0&&e.indexOf("depthNewCapping")>=0&&(r=["compareNew"]),this.passes=r,this._forceUpdate()},setRenderLineMode:function(e){var t=this._renderMode;t||((t=new h)._useRenderPointMask=!1,t._useRenderFaceMask=!1,this._renderMode=t),t._setRenderLineMode(e),this._requestOverridesUpdate()},enableLocalRenderEdgeMode:function(e){var t=null;e&&((t=new h({renderLineMode:i.HideAllRenderLineMode}))._useRenderFaceMask=!1,t._useRenderPointMask=!1),this._renderMode=t,this._requestOverridesUpdate()},setRenderMode:function(e,t){!e||e.indexOf("Edge")<0||this._renderMode&&(this._renderMode.setRenderMode(e,t),this._requestOverridesUpdate())},setAdvancedPriority:function(e){this._setAdvancedPriority(e)},setZDepthMode:function(e){this._setDepthMode(e)},setLayerFilter:function(e,t){if(this._layerFilter){switch(t){case i.FilterMode.Cumulative:for(r=0;r<e.length;r++)this._layerFilter[r]=this._layerFilter[r]&&(e[r]?1:0);break;case i.FilterMode.None:case i.FilterMode.Replace:case i.FilterMode.V4Master:default:if(1024!==e.length){this._layerFilter=new Array(1024);for(r=0;r<e.length;r++)this._layerFilter[r]=e[r]}else this._layerFilter=e}this._forceUpdate()}else{if(1024!==e.length){this._layerFilter=new Array(1024);for(var r=0;r<e.length;r++)this._layerFilter[r]=e[r]}else this._layerFilter=e;this._forceUpdate()}},setLayerNumber:function(e){this._layer=e,this._forceUpdate()},_propagateVisuFilters:function(e,t){t?(e._filters=new Map,t.forEach(function(t,i,r){t&&!M.has(i)&&e._filters.set(i,t)})):e._filters=null,this._filters&&(e._filters=e._filters||new Map,this._filters.forEach(function(t,i,r){t&&!M.has(i)&&e._filters.set(i,t)}))},setVisuFilters:function(e){this._filters||(this._filters=new Map);var t=!1;if(void 0!==e.gasInheritFilter&&(this._filters.set(x.GAS_INHERIT,e.gasInheritFilter),e.gasInheritFilter||this._filters.delete(x.GAS_INHERIT),t=!0),void 0!==e.polygonOffsetFilter&&(this._filters.set(x.POLYGON_OFFSET,e.polygonOffsetFilter),e.polygonOffsetFilter||this._filters.delete(x.POLYGON_OFFSET),t=!0),void 0!==e.zModeFilter&&(this._filters.set(x.ZMODE,e.zModeFilter),e.zModeFilter||this._filters.delete(x.ZMODE),t=!0),void 0!==e.lookFilter&&(this._filters.set(x.LOOK,e.lookFilter),e.lookFilter||this._filters.delete(x.LOOK),t=!0),void 0!==e.geomTypeFilter&&(this._filters.set(x.GEOM_TYPE,e.geomTypeFilter),(!e.geomTypeFilter||e.geomTypeFilter._geomType<0)&&this._filters.delete(x.GEOM_TYPE),t=!0),void 0!==e._staticGeomTypeFilter&&(this._filters.set(x._STATIC_GEOM_TYPE,e._staticGeomTypeFilter),(!e._staticGeomTypeFilter||e._staticGeomTypeFilter._geomType<0)&&this._filters.delete(x._STATIC_GEOM_TYPE),t=!0),void 0!==e.furtiveFilter&&(e.furtiveFilter?this._filters.set(x.FURTIVE,!0):this._filters.delete(x.FURTIVE),t=!0),void 0!==e._materialToUseFilter&&(this._filters.set(x._MATERIAL_TO_USE,e._materialToUseFilter),(!e._materialToUseFilter||e._materialToUseFilter.materialToUse<0)&&this._filters.delete(x._MATERIAL_TO_USE),t=!0),e.doNotPickUnderFilter&&(this._filters.set(x.DO_NOT_PICK_UNDER,e.doNotPickUnderFilter),t=!0),t){var i=this._filters.has(x.DO_NOT_PICK_UNDER)&&!this._filters.get(x.DO_NOT_PICK_UNDER)._doNotPickUnder;i&&this._forceUpdate(),i&&this._filters.delete(x.DO_NOT_PICK_UNDER),0===this._filters.size&&(this._filters=null),this._forceUpdate()}},setPickingMode:function(e){this._pickingMode=e,this._requestOverridesUpdate()},getLocalBoundingBox:function(){if(g)return new i.Box3(new i.Vector3(0,0,0),new i.Vector3(0,0,0));var e=new i.Matrix4,t=new i.Matrix4,r=new i.Vector3,n=null,a=null,s=this._occurrences[0],o=s.matrix;e.getInverse(o);for(var l=s._getRenderableOccurrences(),c=0;c<l.length;c++){var h=l[c];t.multiplyMatrices(e,h.matrix);for(var u=0;u<h.geometry.length;u++){var d=h.geometry[u].vertexPositionArray;if(d){var p=d.length;if(p>=3){n||(r.set(d[0],d[1],d[2]),r.applyMatrix4(t),n=(new i.Vector3).copy(r),a=(new i.Vector3).copy(r));for(var f=0;f<p;f+=3)r.set(d[f],d[f+1],d[f+2]),r.applyMatrix4(t),r.x<n.x&&(n.x=r.x),r.y<n.y&&(n.y=r.y),r.z<n.z&&(n.z=r.z),r.x>a.x&&(a.x=r.x),r.y>a.y&&(a.y=r.y),r.z>a.z&&(a.z=r.z)}}}}return new i.Box3(n,a)},enableClippingPlane:function(e,t){var i,r;if(t){if(this.clippingContext||(this.clippingContext=new c),this.clippingContext.addPlane(e))for(this._forceUpdate(),r=this._getAllOwningViewers(),i=0;i<r.length;i++)r[i]._addClippingPlane(e)}else if(this.clippingContext&&this.clippingContext.removePlane(e))for(this._forceUpdate(),r=this._getAllOwningViewers(),i=0;i<r.length;i++)r[i]._removeClippingPlane(e)},disableClipping:function(e){this.clippingContext||(this.clippingContext=new c),this.clippingContext.setExcludeFromClippingPlanes(e?["all"]:[]),this._forceUpdate()},setSectionCappingMaterial:function(e,t){this.clippingContext||(this.clippingContext=new c),this.clippingContext.setSectionCappingMaterial(e,t),this.requestOverridesUpdate()},deleteSectionCappingMaterial:function(e){if(this.sectionCappingMaterials){var t=e||null,i=0;for(i=0;i<this.sectionCappingMaterials.length;i++)this.sectionCappingMaterials[i].clippingPlane===t&&this.sectionCappingMaterials.splice(i,1);this.sectionCappingMaterials.length||(this.sectionCappingMaterials=null)}},getSectionCappingMaterial:function(e){return this.clippingContext&&this.clippingContext.getSectionCappingMaterial(e)},removeSectionCappingMaterial:function(e){this.clippingContext&&this.clippingContext.removeSectionCappingMaterial(e)},requestOverridesUpdate:function(){var e=0;for(e=0;e<this._occurrences.length;e++)this._occurrences[e].requestOverridesUpdate()},excludeFromCSO:function(e){this._setExcludeFromCSO(e)},excludeFromHSO:function(e){this._setExcludeFromHSO(e)},excludeFromPSO:function(e){this._setExcludeFromPSO(e)},excludeFromHighlight:function(e,t){this._setExcludeFromHL(e),this._setExcludeFromPreHL(t)},propagateXSOExclusion:function(e){this._setPropagateXSOExclusion(e)},createRenderable:function(){return null},add:function(){this.addChild.apply(this,arguments)},remove:function(){this.removeChild.apply(this,arguments)},_requestOverridesUpdate:function(){var e;for(e=0;e<this._occurrences.length;e++)this._occurrences[e].requestOverridesUpdate()},_requestClippingUpdate:function(){var e,t=this._getAllOwningViewers();for(e=0;e<t.length;e++)t[e]._requestClippingUpdate()},setClippingCylinder:function(e){if(!this.clippingContext){if(!e)return;this.clippingContext=new c}this.clippingContext.cylinder=e?{center:e.center,axisU:e.axisU.clone(),axisV:e.axisV.clone(),clipOutside:null===e.clipOutside||void 0===e.clipOutside||e.clipOutside}:null,this._requestClippingUpdate(),this._requestOverridesUpdate()},setScissoringPolyLine:function(e){if(!this.clippingContext){if(!e)return;this.clippingContext=new c}e?this.clippingContext.setScissorPolyLine(!0,e):this.clippingContext.setScissorPolyLine(!1),this._requestClippingUpdate(),this._requestOverridesUpdate()},setClippingProfile:function(e){if(!this.clippingContext){if(!e)return;this.clippingContext=new c}e?this.clippingContext.setClippingProfile(e):this.clippingContext.setClippingProfile(null),this._requestClippingUpdate(),this._requestOverridesUpdate()},isPointOfViewDependant:function(){return!1},_setOverrideExistsTraverse:function(){!function e(t){var i;if(!t._getOverrideExists())for(t._setOverrideExists(!0),i=0;i<t.parents.length;i++)e(t.parents[i])}(this)},getPLMMaterialData:function(e){var t=this._PLMMaterialData;return e||null!==t||(this._PLMMaterialData=new p(this),t=this._PLMMaterialData),t},_getStaticOverrideSet:function(e){var t=this.getPLMMaterialData(!e);return t&&t._getStaticOverrideSet(e)},addStaticMaterialApplicationOverride:function(e,t){this._getStaticOverrideSet(!0).addStaticOverride(e,t),this._requestStaticOverridesUpdate()},clearStaticMaterialApplicationOverrides:function(){var e=this._getStaticOverrideSet();e&&(e.clear(),this._requestStaticOverridesUpdate())},_requestStaticOverridesUpdate:function(){var e,t;for(e=0;e<this._occurrences.length;e++)(t=this._occurrences[e].getViewer())&&(t._updateStaticOverrides=!0)},setLocalRenderEdgeMode:function(){this.setRenderMode.apply(this,arguments)},setUserData:function(e){this.userData=e},getUserData:function(e){return this.userData}});b.prototype._isMesh3D=!1,b.prototype._isDecal=!1;var D=0;b._LockNodeHierarchy=function(){D++},b._UnlockNodeHierarchy=function(){D--},b._applyMaterialToPath=function(e,t){if(null===e)return!1;var i=e._getRenderableOccurrences(),r=i.length;for(a=0;a<r;a++)(s=i[a])&&s._flagAsGSSOInvalidated();var n=e.getLastElement();if(null===n)return!1;if(n instanceof b)for(var a=0;a<r;a++){var s=i[a];null!==t?(s.userData.oldMaterial||(s.userData.oldMaterial=s.material),s.material=t):s.userData.oldMaterial&&(s.material=s.userData.oldMaterial)}else{if(1!==r)return!1;var o=[];if("rep"===n.getType()){var l=n.getChildren();for(a=0;a<l.length;a++)o.push(l[a].sgNode)}else"primitive"===n.getType()&&o.push(n.sgNode);null===i[0].layer&&i[0].initLayers(1),i[0].layer.addPrimitivesToLayers(o,1,t)}return!0},b.DEPRECATED_SceneGraph=function(e,t){if(0!==v&&(console.log("[SceneGraph] DEPRECATED API USE\n"+e.stack),v--),!window.I_solemnly_swear_I_am_up_to_no_good&&!t)throw e},b.DEPRECATED_Method=function(e,t){0!==v&&(console.log("[Node3D] DEPRECATED API USE\n"+e.stack),v--)},b.DEPRECATED_matrix=function(e){0!==v&&(console.warn("Node3D API : use getMatrix() accessor instead of .matrix  "+e.stack),--v||console.warn("Node3D API : too many errors, no more errors will be reported."))},Object.defineProperty(b.prototype,"root",{get:function(){return b.DEPRECATED_SceneGraph(new Error),this}}),Object.defineProperty(b.prototype,"bSphere",{get:function(){return this.getHasExplicitBE()?this.explicitBSphere:this.getBoundingSphere()},set:function(e){if(!this.getHasExplicitBE())throw new Error("bSphere is read-only");this.explicitBSphere=e}}),Object.defineProperty(b.prototype,"bBox",{get:function(){return this.getHasExplicitBE()||this.hasExplicitBE?this.explicitBBox:this.getBoundingBox()},set:function(e){if(!this.getHasExplicitBE()&&!this.hasExplicitBE)throw new Error("bBox is read-only");this.explicitBBox=e}}),Object.defineProperty(b.prototype,"matrix",{get:function(){return b.DEPRECATED_matrix(new Error),this._matrix},set:function(e){b.DEPRECATED_matrix(new Error),this._matrix=e}});var w=30;b.FORBIDDEN_ACCESS_occurrences=function(e){0!==w&&(console.log("[Node3D] INTERNAL PROPERTY ACCESS\nAccess to 'occurrences' member is strictly forbidden.\nYou must use authorized APIs.\nIf you are trying to create a pathElement using setFromOccurrence, please consider using ?new PathElement([node3d])? instead.\n"+e.stack),w--)},Object.defineProperty(b.prototype,"occurrences",{get:function(){return b.FORBIDDEN_ACCESS_occurrences(new Error),this._occurrences},set:function(e){b.FORBIDDEN_ACCESS_occurrences(new Error),this._occurrences=e}}),Object.defineProperty(b.prototype,"clippingPlanes",{get:function(){return this.clippingContext&&this.clippingContext.planes},set:function(){}});var E=[["renderPriority","p0"],["renderPriority","p1"],["renderPriority","p2"],["renderPriority","p3"],["renderPriority","p4"]];b.REFERENCE_NODE=-1,b.INSTANCE_NODE=-2,b.REPRESENTATION_NODE=-3,b.TILESET_NODE=-4,b._onLinkToSceneGraph_DEBUG=null;var T=1,A=2,I=4,R=8,L=16,O=32,N=64,F=128,V=256,U=512,B=1024,k=2048,G=4096,z=8192,H=16384,W=32768,j=65536;function X(e){return function(){return(this.occBooleanAttr&e)>0}}function q(e){return function(t){this.occBooleanAttr=t?this.occBooleanAttr|e:this.occBooleanAttr&~e}}P.prototype._getVisible=X(T),P.prototype._setVisible=q(T),P.prototype._getVisibilityFree=X(A),P.prototype._setVisibilityFree=q(A),P.prototype._getPickable=X(I),P.prototype._setPickable=q(I),P.prototype._getNoZPriority=X(F),P.prototype._setNoZPriority=q(F),P.prototype.getNoPickThrough=X(R),P.prototype.setNoPickThrough=q(R),P.prototype._getNeedBEUpdate=X(L),P.prototype._setNeedBEUpdate=q(L),P.prototype._getNeedOverridesUpdate=X(O),P.prototype._setNeedOverridesUpdate=q(O),P.prototype._getDescendantNeedsOverridesUpdate=X(N),P.prototype._setDescendantNeedsOverridesUpdate=q(N),P.prototype._getForceShowHide=X(V),P.prototype._setForceShowHide=q(V),P.prototype._getForceShowNoPickability=X(U),P.prototype._setForceShowNoPickability=q(U),P.prototype._getForceShowNoDrawHL=X(B),P.prototype._setForceShowNoDrawHL=q(B),P.prototype.isInBackground=X(k),P.prototype.setIsInBackground=q(k),P.prototype._isAlwaysInForeground=X(G),P.prototype._setIsAlwaysInForeground=q(G),P.prototype._getAdvancedPriority=X(H),P.prototype._setAdvancedPriority=q(H),P.prototype._getDepthMode=X(z),P.prototype._setDepthMode=q(z),P.prototype._getInvertMode=X(W),P.prototype._setInvertMode=q(W),P.prototype._getInvertPickMode=X(j),P.prototype._setInvertPickMode=q(j),P.prototype._copyForceShowStatusFromOcc=function(e){var t=V|U|B;this.occBooleanAttr=this.occBooleanAttr&~t|e.occBooleanAttr&t},Object.defineProperty(P.prototype,"visible",{get:function(){return this._getVisible()},set:function(e){this._setVisible(e)}}),Object.defineProperty(P.prototype,"visibilityFree",{get:function(){return this._getVisibilityFree()},set:function(e){this._setVisibilityFree(e)}}),Object.defineProperty(P.prototype,"pickable",{get:function(){return this._getPickable()},set:function(e){this._setPickable(e)}}),Object.defineProperty(P.prototype,"drawInHLRender",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(P.prototype,"noPickThrough",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(P.prototype,"_needBEUpdate",{get:function(){return this._getNeedBEUpdate()},set:function(e){this._setNeedBEUpdate(e)}}),Object.defineProperty(P.prototype,"_needOverridesUpdate",{get:function(){return this._getNeedOverridesUpdate()},set:function(e){this._setNeedOverridesUpdate(e)}}),Object.defineProperty(P.prototype,"_descendantNeedsOverridesUpdate",{get:function(){return this._getDescendantNeedsOverridesUpdate()},set:function(e){this._setDescendantNeedsOverridesUpdate(e)}}),b.SceneGraphOverrideSetManager=null;var Z=1,Y=2,K=4,J=8,Q=16,$=32,ee=64,te=128,ie=256,re=512,ne=1024,ae=2048,se=4096,oe=8192,le=16384,ce=32768,he=65536,ue=1<<17,de=1<<18,pe=1<<19,fe=1<<20,me=1<<21,ge=1<<22,ve=1<<23,Se=1<<24,_e=1<<25,ye=1<<26,xe=1<<27,Me=1<<28,Pe=1<<29,Ce=1<<30;function be(e){return function(){return(this.node3DBooleanAttr&e)>0}}function De(e){return function(t){this.node3DBooleanAttr=t?this.node3DBooleanAttr|e:this.node3DBooleanAttr&~e}}function we(e,t,i,r,n,a,s){return!a&&!s&&(!(!n||!t)||e&&(t?i:r))}return b.prototype.getLinkedToSceneGraph=be(Z),b.prototype.setLinkedToSceneGraph=De(Z),b.prototype._getForceBoundingElements=be(Y),b.prototype._setForceBoundingElements=De(Y),b.prototype.getExcludeFromBounding=be(K),b.prototype.setExcludeFromBounding=De(K),b.prototype._getNeedBEUpdate=be(J),b.prototype._setNeedBEUpdate=De(J),b.prototype._getVisible=be(Q),b.prototype._setVisible=De(Q),b.prototype._getVisibilityFree=be($),b.prototype._setVisibilityFree=De($),b.prototype._getPickable=be(ee),b.prototype._setPickable=De(ee),b.prototype._getNoZPriority=be(de),b.prototype._setNoZPriority=De(de),b.prototype.getNoPickThrough=be(te),b.prototype.setNoPickThrough=De(te),b.prototype._getPickParent=be(ie),b.prototype._setPickParent=De(ie),b.prototype._getTreeModified=be(re),b.prototype.__setTreeModified=De(re),b.prototype.getNotAllowedInPathElement=be(ne),b.prototype.setNotAllowedInPathElement=De(ne),b.prototype._getVisibilityInTree=be(ae),b.prototype._setVisibilityInTree=De(ae),b.prototype.getIsManipulator=be(se),b.prototype.setIsManipulator=De(se),b.prototype._getExcludeFromCSO=be(ue),b.prototype._setExcludeFromCSO=De(ue),b.prototype._getExcludeFromHSO=be(oe),b.prototype._setExcludeFromHSO=De(oe),b.prototype._getExcludeFromPSO=be(le),b.prototype._setExcludeFromPSO=De(le),b.prototype._getExcludeFromHL=be(he),b.prototype._setExcludeFromHL=De(he),b.prototype._getExcludeFromPreHL=be(ce),b.prototype._setExcludeFromPreHL=De(ce),b.prototype._getPropagateXSOExclusion=be(ve),b.prototype._setPropagateXSOExclusion=De(ve),b.prototype._getOverrideExists=be(fe),b.prototype._setOverrideExists=De(fe),b.prototype._getDisablePrimPicking=be(pe),b.prototype._setDisablePrimPicking=De(pe),b.prototype._getDepthMode=be(ye),b.prototype._setDepthMode=De(ye),b.prototype._getAdvancedPriority=be(xe),b.prototype._setAdvancedPriority=De(xe),b.prototype._getInvertMode=be(Me),b.prototype._setInvertMode=De(Me),b.prototype._getInvertPickMode=be(Pe),b.prototype._setInvertPickMode=De(Pe),b.prototype._getForbidHierarchyUpdate=be(Ce),b.prototype._setForbidHierarchyUpdate=De(Ce),b.prototype.isInBackground=be(Se),b.prototype.setIsInBackground=function(e){if(this.node3DBooleanAttr=e?this.node3DBooleanAttr|Se:this.node3DBooleanAttr&~Se,this._occurrences)for(let t=0;t<this._occurrences.length;t++){const i=this._occurrences[t];if(i.parent)this._updateOccurrences(i.parent,i);else{i.setIsInBackground(e);for(let e=0;e<i.children.length;e++)this._updateOccurrences(i,i.children[e])}}},b.prototype._isAlwaysInForeground=be(_e),b.prototype._setIsAlwaysInForeground=function(e){if(this.node3DBooleanAttr=e?this.node3DBooleanAttr|_e:this.node3DBooleanAttr&~_e,this._occurrences)for(let t=0;t<this._occurrences.length;t++){const i=this._occurrences[t];i.parent?this._updateOccurrences(i.parent,i):i._setIsAlwaysInForeground(e)}},b.prototype._getOverrideSetManagerUnder=function(){return(this.node3DBooleanAttr&me)>0},b.prototype._setOverrideSetManagerUnder=function(){var e;for(this.node3DBooleanAttr=this.node3DBooleanAttr|me,e=0;e<this.parents.length;e++)this.parents[e]._setOverrideSetManagerUnder()},b.prototype.getHasExplicitBE=function(){return!1},b.prototype._getForceShowMode=function(){return(this.node3DBooleanAttr&ge)>0},b.prototype._setForceShowMode=function(e){var t=e;e?t||this.traverse(e=>{e.node3DBooleanAttr=e.node3DBooleanAttr|ge}):t&&this.traverse(e=>{e.node3DBooleanAttr=e.node3DBooleanAttr&~ge})},Object.defineProperty(b.prototype,"material",{get:function(){return this.getMaterial()},set:function(e){console.warn("do not use node.material=myMaterial but node.setMaterial(myMaterial)"),this.setMaterial(e)}}),Object.defineProperty(b.prototype,"linkedToSceneGraph",{get:function(){return this.getLinkedToSceneGraph()},set:function(e){this.setLinkedToSceneGraph(e)}}),Object.defineProperty(b.prototype,"_forceBoundingElements",{get:function(){return this._getForceBoundingElements()},set:function(e){this._setForceBoundingElements(e)}}),Object.defineProperty(b.prototype,"excludeFromBounding",{get:function(){return this.getExcludeFromBounding()},set:function(e){this.setExcludeFromBounding(e)}}),Object.defineProperty(b.prototype,"_needBEUpdate",{get:function(){return this._getNeedBEUpdate()},set:function(e){this._setNeedBEUpdate(e)}}),Object.defineProperty(b.prototype,"visible",{get:function(){return this._getVisible()},set:function(e){this._setVisible(e)}}),Object.defineProperty(b.prototype,"visibilityFree",{get:function(){return this._getVisibilityFree()},set:function(e){this._setVisibilityFree(e)}}),Object.defineProperty(b.prototype,"pickable",{get:function(){return this._getPickable()},set:function(e){this._setPickable(e)}}),Object.defineProperty(b.prototype,"drawInHLRender",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(b.prototype,"noPickThrough",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(b.prototype,"pickParent",{get:function(){return this._getPickParent()},set:function(e){this._setPickParent(e)}}),Object.defineProperty(b.prototype,"_treeModified",{get:function(){return this._getTreeModified()},set:function(e){this.__setTreeModified(e)}}),Object.defineProperty(b.prototype,"notAllowedInPathElement",{get:function(){return this.getNotAllowedInPathElement()},set:function(e){this.setNotAllowedInPathElement(e)}}),Object.defineProperty(b.prototype,"_visibilityInTree",{get:function(){return this._getVisibilityInTree()},set:function(e){this._setVisibilityInTree(e)}}),Object.defineProperty(b.prototype,"isManipulator",{get:function(){return this.getIsManipulator()},set:function(e){this.setIsManipulator(e)}}),Object.defineProperty(b.prototype,"_excludeFromCSO",{get:function(){return this._getExcludeFromCSO()},set:function(e){this._setExcludeFromCSO(e)}}),Object.defineProperty(b.prototype,"_excludeFromHSO",{get:function(){return this._getExcludeFromHSO()},set:function(e){this._setExcludeFromHSO(e)}}),Object.defineProperty(b.prototype,"_excludeFromPSO",{get:function(){return this._getExcludeFromPSO()},set:function(e){this._setExcludeFromPSO(e)}}),Object.defineProperty(b.prototype,"_excludeFromHL",{get:function(){return this._getExcludeFromHL()},set:function(e){this._setExcludeFromHL(e)}}),Object.defineProperty(b.prototype,"_excludeFromPreHL",{get:function(){return this._getExcludeFromPreHL()},set:function(e){this._setExcludeFromPreHL(e)}}),UWA.namespace("THREEDS/Nodes/Node3D",b)}),define("Visualization/Node3D",["DS/Visualization/Node3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Node3D"),e}),define("DS/Visualization/OccurrenceExplorer",["UWA/Class","DS/Visualization/OccurrenceInterface","DS/Visualization/Node3D","DS/Visualization/OccurrenceInterfaceFactory"],function(e,t,i,r){"use strict";var n=e.extend({init:function(e){this.viewer=e},explore:function(e){e&&this._exploreInternal(null,e)},exploreQuick:function(e,t){e&&t&&this._exploreInternal(e,t)},_exploreInternal:function(e,t){var n=new a,s=new r(n,this.viewer);i._LockNodeHierarchy();try{if(e)t(s.getOccurrenceItf(e),s);else t(s);i._UnlockNodeHierarchy(),n.cleanUp()}catch(e){throw i._UnlockNodeHierarchy(),n.cleanUp(),e}}}),a=function(){this._occurrenceList=[],this._occurrenceInterfaceList=[]};return a.prototype.cleanUp=function(){this._occurrenceList=null,this._occurrenceInterfaceList=null},a.prototype.getOccurrenceInterface=function(e){if(!e||!this._occurrenceList)return null;this._occurrenceList[e.node.id]||(this._occurrenceList[e.node.id]=[]);var i,r,n=this._occurrenceList[e.node.id],a=-1;for(r=0;a<0&&r<n.length;r++)n[r].occurrence===e&&(a=n[r].index);return a<0?(i=new t(e.node.id,n.length,this),n.push({occurrence:e,index:this._occurrenceInterfaceList.length}),this._occurrenceInterfaceList.push(i)):i=this._occurrenceInterfaceList[a],i},n}),define("DS/Visualization/VolumeRenderingManagerSimple",["UWA/Class","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Node3D"],function(e,t,i,r){"use strict";for(var n=null,a=function(e,t){for(var i=t||1;i<e;)i*=2;return i},s=[],o={},l={},c=0;c<7;c++){var h=Math.pow(2,c+2);s[c]=h*a(Math.ceil(Math.sqrt(h))),o[s[c]]=c,l[h]=c}var u=[16384,4096,1024,512,512,128,128],d=[0,0,0,0,0,0,0];window.nbTextures=[0,0,0,0,0,0,0];var p=[];window.nbCallsToFreeTexture=0;var f=function(e){nbCallsToFreeTexture++;var t=l[e];return p[t].length?p[t].pop():nbTextures[t]<u[t]?g(!0,s[t],s[t]):null},m=function(e,t){var i=Math.log2(t)-2;p[i].push(e)},g=function(e,i,r,a){var s,l=!a;if(l){s=new Uint8Array(i*r*(e?1:4));for(var c=0;c<i*r;c++)e?s[c]=0:(s[4*c]=0,s[4*c+1]=0,s[4*c+2]=0,s[4*c+3]=255)}else{s=new Float32Array(i*r);for(c=0;c<i*r;c++)s[c]=0}var h=new t.DataTexture(s,i,r,l?e?t.AlphaFormat:t.RGBAFormat:t.LuminanceFormat,l?t.UnsignedByteType:t.FloatType,new t.LatLongReflectionMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearFilter);return h.generateMipmaps=!1,h.needsUpdate=!0,e&&void 0!==o[i]&&nbTextures[o[i]]++,n.setTexture(h,0),h};return e.extend({init:function(e){n=e.renderer.renderer,this.viewer=e,this.camera=null,function(){for(var e=0;e<7;e++){p[e]=[];for(var t=Math.pow(2,e+2),i=t*a(Math.ceil(Math.sqrt(t))),r=0;r<d[e];r++){var n=g(!0,i,i);p[e].push(n)}}}(),this.maxAllowedSize=4294967296,this.loadedSize=0,this.debugMemoryMap=null,this.pathToModel="",this.modelLoader=null,this.rootNode=new r,this.volumeChunks=[],this.overrideRange=!1,this.minValue=0,this.maxValue=1,this.tileSetRange=[0,1],this.invisibleRanges=[],this.clipPlane=null,this.colorMap=g(!1,2,1),this.colorData=null,this.transferFunctionMap=g(!1,1024,1,!0);for(var t=0;t<1024;t++)this.transferFunctionMap.image.data[t]=.5;return this.transferFunctionMap.needsUpdate=!0,this.binnedMap=g(!1,1024,512,!1),this.binnedValues=new Uint32Array(256),this.binnedMaxValue=0,this.needsRender=!0,this},sortChunks:function(e){var i=new t.Vector3,r=e.position;this.volumeChunks.sort(function(e,t){return i.subVectors(e.data.position,r).length()-i.subVectors(t.data.position,r).length()})},update:function(e){var t=e._renderedCamera;t&&(this.camera=t,t.matrixWorldInverse.getInverse(t.matrixWorld),this.sortChunks(t))},updateTransferFunction:function(e){for(var t=this.transferFunctionMap.image.data,i=1;i<e.length;i++)for(var r=e[i-1],n=Math.floor(1024*r.position),a=r.value,s=e[i],o=1024*s.position,l=s.value,c=(l-a)/(o-n),h=l-c*o,u=n;u<o;u++)t[u]=c*u+h;this.updateInvisibleRanges(),this.transferFunctionMap.needsUpdate=!0},updateTransferFunctionRaw:function(e){var t=this.transferFunctionMap.image.data,i=1023/(e.length-1);if(i>=1)for(var r=1;r<e.length;r++)for(var n=e[r],a=e[r-1],s=Math.floor(i*r),o=Math.floor(i*(r-1)),l=(n-a)/(s-o),c=n-l*s,h=o;h<=s;h++)t[h]=l*h+c;else for(r=0;r<1024;r++)t[r]=e[Math.floor(r/i)];this.updateInvisibleRanges(),this.transferFunctionMap.needsUpdate=!0},updateInvisibleRanges:function(){this.invisibleRanges=[];for(var e=this.transferFunctionMap.image.data,t=null,i=0;i<e.length;i++)0===e[i]?t||(t=[i,i],this.invisibleRanges.push(t)):t&&(t[1]=i,t=null);t&&(t[1]=1023);for(i=0;i<this.invisibleRanges.length;i++){var r=this.invisibleRanges[i];r[0]=this.minValue+r[0]/1023*(this.maxValue-this.minValue),r[1]=this.minValue+r[1]/1023*(this.maxValue-this.minValue)}},updateBinnedValues:function(e){if(e&&e.data){var t=e.data.voxelRepartition;if(t)for(var i=255*this.minValue/(this.tileSetRange[1]-this.tileSetRange[0]),r=255*this.maxValue/(this.tileSetRange[1]-this.tileSetRange[0]),n=0;n<256;n++)this.binnedValues[n]+=t[Math.floor(i+(r-i)*n/255)],this.binnedValues[n]>this.binnedMaxValue&&(this.binnedMaxValue=this.binnedValues[n])}},updateBinnedMap:function(){for(var e,t,i,r=this.binnedMap.image.data,n=this.colorMap.image.width,a=0;a<1024;a++){var s=Math.round((n-1)*a/1023);this.colorData?(e=this.colorData[4*s],t=this.colorData[4*s+1],i=this.colorData[4*s+2]):(e=255,t=255,i=255);for(var o=this.transferFunctionMap.image.data[a],l=this.binnedValues[Math.round(.25*a)]/this.binnedMaxValue,c=0;c<512;c++){var h=1024*c+a,u=512*o>512-c,d=512*l>512-c,p=d?e:255;p*=u?.8:1;var f=d?t:255;f*=u?.8:1;var m=d?i:255;m*=u?.8:1,r[4*h]=p,r[4*h+1]=f,r[4*h+2]=m,r[4*h+3]=255}}this.binnedMap.needsUpdate=!0},setTileSetRange:function(e){this.tileSetRange=[e[0],e[1]]},setMinValue:function(e){this.overrideRange=!0,this.minValue=e},setMaxValue:function(e){this.overrideRange=!0,this.maxValue=e},setColorMap:function(e){var i=this;this.colorMap=t.ImageUtils.loadTexture(e,new t.UVMapping),this.colorMap.onLoadCallbacks.push(function(e){var t=e.image,r=document.createElement("canvas");r.width=t.width,r.height=t.height;var n=r.getContext("2d");n.drawImage(t,0,0),i.colorData=n.getImageData(0,0,t.width,1).data})},setColorMapRaw:function(e){for(var i=new Uint8Array(4*e.length),r=new t.Color,a=0;a<e.length;a++)r.set(e[a]),i[4*a]=255*r.r,i[4*a+1]=255*r.g,i[4*a+2]=255*r.b,i[4*a+3]=255;this.colorMap=new t.DataTexture(i,e.length,1,t.RGBAFormat,t.UnsignedByteType,new t.LatLongReflectionMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearFilter),this.colorMap.generateMipmaps=!1,this.colorMap.needsUpdate=!0,n.setTexture(this.colorMap,0),this.colorData=this.colorMap.image.data},computeChunkVoxelDensity:function(e,t){var i=t.data.position,r=e.pixelCullingCst/e.pixelCulling;if(!e.isOrtho){var n=e.matrixWorldInverse.elements;r*=Math.abs(n[2]*i.x+n[6]*i.y+n[10]*i.z+n[14])}var a=t.data.radius/r,s=t.data.mapDim,o=Math.pow(s.x*s.y*s.z,1/3);return t.data._voxelDensity=a/o,a},freeChunk:function(e){var t=e.data;if(null!==t&&0!==e.lastTimeLoaded){var i=t.mapData.data?t.mapData.data.byteLength:t.buffer.byteLength;this.loadedSize-=i,t.map&&m(t.map,t.chunkSize),e.data=null,e.isLoaded=!1,e.isLoading=!1,e.lastTimeLoaded=0}},getTexturePool:function(){return p},getFreeTexture:function(e){var t=f(e.data.chunkSize);if(t)return t;for(var i=0;i<this.volumeChunks.length;i++){var r=this.volumeChunks[i];if(r!==e&&(r.data&&r.data.map&&r.data.chunkSize===e.data.chunkSize)){var n=r.data.map;return r.data.map=null,n}}return null},isRangeVisible:function(e){var t=this.maxValue-this.minValue;if((e.max-e.min)/t<.005)return!1;if(e.min>this.maxValue||e.max<this.minValue)return!1;for(var i=0;i<this.invisibleRanges.length;i++){var r=this.invisibleRanges[i];if(e.min>r[0]&&e.max<r[1])return!1}return!0},getVolumeData:function(e,i){var r=e.targetSGNode;if(i){for(var n=0;n<r.children.length;n++)if("VoxelVolumeNode"===r.children[n].getNodeType()){r=r.children[n];break}}else for(;r.children[0];)r=r.children[0];var a=r.volumeData;if(a){var s=a.mapData.data?a.mapData.data.byteLength:a.buffer.byteLength;this.loadedSize+=s;var o=e.node._boundingBox,l=new t.Vector3(o.max.x-o.min.x,o.max.y-o.min.y,o.max.z-o.min.z),c=new t.Vector3(.5*(o.max.x+o.min.x),.5*(o.max.y+o.min.y),.5*(o.max.z+o.min.z));a.position=c;var h=new t.Vector3;a.radius=.5*o.size(h).length(),a.gridSize=new t.Vector3(l.x,l.y,l.z),a.modelMatrix=(new t.Matrix4).makeTranslation(c.x,c.y,c.z),a.tileSetRange.min=this.tileSetRange[0],a.tileSetRange.max=this.tileSetRange[1];var u=this.tileSetRange[1]-this.tileSetRange[0];a.valueRange.min=this.tileSetRange[0]+u*a.valueRange.min,a.valueRange.max=this.tileSetRange[0]+u*a.valueRange.max,e.data=a,r.volumeData=null}},addChunk:function(e){return!(!e||!e.data)&&(this.volumeChunks.push(e),!0)},removeChunk:function(e){if(!e||!e.data)return!1;var t=this.volumeChunks.indexOf(e);return-1!==t&&(this.volumeChunks.splice(t,1),e.data.map&&m(e.data.map,e.data.chunkSize),e.data.map=null,!0)},loadChunk:function(e,i,a){if(this.modelLoader&&!i.isLoaded){i.isLoading=!0;var s=this,o=new r(e);this.rootNode.addChild(o),this.modelLoader.setOnErrorCallback(function(){0,0,i.isLoading=!1,i.isLoaded=!0,s.needsRender=!0}),this.modelLoader.setOnLoadedCallback(function(e){0,0,i.isLoading=!1,i.isLoaded=!0,s.needsRender=!0;for(var r=o;r.children[0];)r=r.children[0];var l=r.volumeData;if(l){var c=l.mapData.data?l.mapData.data.byteLength:l.buffer.byteLength;s.loadedSize+=c;var h=i.extent,u=new t.Vector3(h[1][0]-h[0][0],h[1][1]-h[0][1],h[1][2]-h[0][2]),d=new t.Vector3(h[1][0]+h[0][0],h[1][1]+h[0][1],h[1][2]+h[0][2]);l.gridSize=new t.Vector3(u.x,u.y,u.z),l.modelMatrix=(new t.Matrix4).makeTranslation(.5*d.x,.5*d.y,.5*d.z),i.data=l,i.data.map=f(l.chunkSize),i.data.map&&(i.data.map.image=i.data.mapData,i.data.map.needsUpdate=!0,n.setTexture(i.data.map,0)),r.volumeData=null,a&&a(i)}}),0,this.modelLoader.loadModel({provider:"FILE",serverurl:"",filename:this.pathToModel+e,requiredAuth:null,proxyurl:"none",loaderSettings:{volumeChunkType:"uint8"}},o)}}})}),define("DS/SceneGraphNodes/CSSSVGNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/SVGLoader/SVGToNode3D","DS/Visualization/GetSVGMode"],function(e,t,i,r,n){"use strict";return t.extend({init:function(e,t,a){if(this._parent(t),this._webGLMode=n.getWebGLMode(),this._webGLMode){var s=new r(e).buildNode3D();this.addChild(s),this._cssSVGNode=!0,this.setPickable(i.PICKTHROUGH)}else{this._gNode=document.createElementNS(a.getSvgNS(),"g"),this._gNode.svgV6Node=this,this._gNode.appendChild(e),this.exludeFromBounding(!0),this.forbidChildren=!0;var o=this._occurrences[0],l=this.createRenderable();o.renderable=l,o.renderable.name=this.name,o.renderable._occurrence=o,this._cssSVGNode=!0,this.viewer=a,this._updateSVGVisibility()}},setVisibility:function(e){if(this._webGLMode)return this._parent.apply(this,arguments);this._setVisible(!!e),this._updateSVGVisibility()},setVisibilityFree:function(e){if(this._webGLMode)return this._parent.apply(this,arguments);this._setVisibilityFree(!!e),this._updateSVGVisibility()},getNodeType:function(){return this._webGLMode?this._parent.apply(this,arguments):"CSSSVGNode"},createRenderable:function(){if(this._webGLMode)return this._parent.apply(this,arguments);var t=new e.CSSSVGNode(this._gNode);return t.matrixAutoUpdate=!1,t.matrixWorldNeedsUpdate=!1,t.pickable=!1,t},addChild:function(){if(this._webGLMode)return this._parent.apply(this,arguments)},_updateSVGVisibility:function(){var e;this._webGLMode||(e=this._getVisibilityFree()?this._getVisible():this.viewer.visibleSpace?this._getVisible():!this._getVisible(),this._gNode.setAttributeNS(null,"visibility",e?"visible":"hidden"))},_onLinkedToSceneGraph:function(){if(this._webGLMode)return this._parent.apply(this,arguments);this.viewer.svgRoot.appendChild(this._gNode)},_onUnlinkedToSceneGraph:function(){if(this._webGLMode)return this._parent.apply(this,arguments);this.viewer.svgRoot.removeChild(this._gNode)}})}),define("DS/Visualization/Mesh3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/GraphicAttributeSet"],function(e,t,i,r,n){"use strict";var a=0,s=e.NoOccurrences,o=t.extend({init:function(t,i){this._parent(i),this.mesh3DBooleanAttr=0,this.setHasExplicitBE(!0),this.explicitBSphere=new e.Sphere,this.explicitBBox=new e.Box3,this.mesh3js=void 0!==t?t:new e.Mesh,this.setIsInstanceNode3D(!1),this.nbInstances=0,this._bodyDim=0,this._ratioData={ratio:0,center:null,cameraName:null},this._billboardData={type:0,axis:null,rotation:null},this.mesh3js.matrixAutoUpdate=!1,this.mesh3js.matrixWorldNeedsUpdate=!1;var r=this._occurrences[0];if(s||(r.renderable=this.mesh3js,r.renderable.name=this.name,r.renderable._occurrence=r),this.mesh3js.geometry.boundingSphere&&this.explicitBSphere.copy(this.mesh3js.geometry.boundingSphere),this.mesh3js.geometry.boundingBox)this.explicitBBox.copy(this.mesh3js.geometry.boundingBox);else{var n=new e.Vector3(2*this.explicitBSphere.radius,2*this.explicitBSphere.radius,2*this.explicitBSphere.radius);this.explicitBBox.setFromCenterAndSize(this.explicitBSphere.center,n)}if(!e.disableJHGDev){var a=t.geometry;(1===a._type||a.length>0&&1===a[0]._type)&&t.material&&this.setMaterial(t.material)}return this._updateBEInternal(),this},_linkingClone:function(e,i){return i=i||new o(this.mesh3js,this.name),t.prototype._linkingClone.call(this,e,i),i.mesh3DBooleanAttr=this.mesh3DBooleanAttr,i._bodyDim=this._bodyDim,i._ratioData=this._ratioData,i._billboardData=this._billboardData,i._updateBEInternal(),i},getRatio:function(){return this._ratioData.ratio},getFixedSizeCenter:function(){return this._ratioData.center?this._ratioData.center.clone():null},setRatio:function(e){if(e!==this._ratioData.ratio){var t=this._occurrences[0];if(t){var i=t.renderable;i&&(this._ratioData.ratio=e,this.explicitBBox.copy(i.geometry.boundingBox),this.explicitBSphere.copy(i.geometry.boundingSphere),this._updateBEInternal())}}},_compactHierarchy:function(e,t){if(!e.has(this)){e.add(this);var i=this.parents;this.parents=new Array(i.length);for(var r=0;r<i.length;r++)this.parents[r]=i[r];var n=this._occurrences;this._occurrences=new Array(n.length);for(r=0;r<n.length;r++){var a=n[r];this._occurrences[r]=a,a._compactChildrenArray(t)}this.mesh3js&&this.mesh3js._compactArrays(t)}},setBillboardData:function(e,t,i){var r=this._occurrences[0];if(r){var n=r.renderable;n&&(this._billboardData.type=e,this._billboardData.axis=t,this._billboardData.rotation=i,this.explicitBBox.copy(n.geometry.boundingBox),this.explicitBSphere.copy(n.geometry.boundingSphere),this._updateBEInternal())}},setFixedSizeCenter:function(e,t){var i=this._occurrences[0];if(i){var r=i.renderable;r&&(this._ratioData.center=e?e.clone():null,t&&this._ratioData.center.multiplyScalar(t),this.explicitBBox.copy(r.geometry.boundingBox),this.explicitBSphere.copy(r.geometry.boundingSphere),this._updateBEInternal())}},setFixedSizeCameraName:function(e){this._ratioData.cameraName=e||"camera"},_setRatio:function(e){this.setRatio(e)},_setFixedSizeCameraName:function(e){this.setFixedSizeCameraName(e)},_setBillboardData:function(e,t,i){this.setBillboardData(e,t,i)},_setFixedSizeCenter:function(e,t){this.setFixedSizeCenter(e,t)},_updateBEInternal:function(){if(0!==this._billboardData.type&&(this.explicitBSphere&&(this.explicitBSphere.radius+=this.explicitBSphere.center.length(),this.explicitBSphere.center.set(0,0,0),this.explicitBBox&&this.explicitBBox.setFromCenterAndSize(this.explicitBSphere.center,this.explicitBSphere.radius)),!this.explicitBSphere&&this.explicitBBox&&(this.explicitBBox.max=new e.Vector3(0,0,0),this.explicitBBox.min=new e.Vector3(0,0,0))),this._ratioData.ratio>0&&(this.explicitBBox&&(this.explicitBBox.max=new e.Vector3(0,0,0),this.explicitBBox.min=new e.Vector3(0,0,0)),this.explicitBSphere)){if(this._ratioData.center){var t=this._ratioData.center.clone();t.multiplyScalar(1/this._ratioData.ratio),this.explicitBSphere.center.add(t)}this.explicitBSphere._updateRatio(this._ratioData.ratio)}this._invalidateBoundingElements(!1,!1)},computeBoundingElements:function(){var t=this._occurrences[0];if(t&&(a=t.renderable)){for(var i=a.geometry.boundingBox,r=a.geometry.boundingSphere,n=0;n<a.geometry.length;n++){(s=a.geometry[n]).computeBoundingBox(),s.computeBoundingSphere(),n?(i.expandByPoint(s.boundingBox.min),i.expandByPoint(s.boundingBox.max),r.clone().mergeWithSphere(s.boundingSphere,r)):(i.copy(s.boundingBox),r.copy(s.boundingSphere))}for(n=0;n<this._occurrences.length;n++){var a,s;this._occurrences[n];(s=(a=this._occurrences[n].renderable).geometry).boundingBox.copy(i),s.boundingSphere.copy(r),a.boundingBox||(a.boundingBox=new e.Box3),a.boundingSphere||(a.boundingSphere=new e.Sphere),a.boundingBox.copy(i),a.boundingSphere.copy(r),a._updateWorldCenterAndRadius()}this.explicitBBox.copy(i),this.explicitBSphere.copy(r),this._updateBEInternal()}},forceBoundingSphere:function(e){this.forceBoundingElements(!0,{sphere:e}),this._updateBEInternal()},_forceBoundingSphere:function(t){this.mesh3js&&this.mesh3js.geometry?(this.setHasExplicitBE(!0),this.mesh3js.geometry.boundingSphere||(this.mesh3js.geometry.boundingSphere=new e.Sphere),this.mesh3js.geometry.boundingSphere.copy(t),this.explicitBSphere.copy(t)):console.log("Couldn't force bounding sphere.")},forceBoundingBox:function(e){this.forceBoundingElements(!0,{box:e}),this._updateBEInternal()},_forceBoundingBox:function(t){this.mesh3js&&this.mesh3js.geometry?(this.mesh3js.geometry.boundingBox||(this.mesh3js.geometry.boundingBox=new e.Box3),this.setHasExplicitBE(!0),this.mesh3js.geometry.boundingBox.copy(t),this.explicitBBox.copy(t)):console.log("Couldn't force bounding box.")},__forceBoundingElements:function(e,t){if(e){var i;e.sphere&&this._forceBoundingSphere(e.sphere),e.box&&this._forceBoundingBox(e.box);for(var r=0;r<this._occurrences.length;r++)null!==(i=this._occurrences[r]).renderable&&i.renderable._updateWorldCenterAndRadius()}},_forceGeomType:function(e){this.mesh3js&&this.mesh3js._forceGeomType(e)},createRenderable:function(){var t=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);t.matrixAutoUpdate=!1,t.matrixWorldNeedsUpdate=!1,t.visible=this.mesh3js.visible,t.pickable=this.mesh3js.pickable,t.noPickThrough=this.mesh3js.noPickThrough,t.renderDepth=this.mesh3js.renderDepth,t.frustumCulled=this.mesh3js.frustumCulled,t.enableNormalDepth=this.mesh3js.enableNormalDepth,t.castShadow=this.mesh3js.castShadow,t.receiveShadow=this.mesh3js.receiveShadow,t.beforeRenderCB=this.mesh3js.beforeRenderCB,t.fromLoadedModel=this.mesh3js.fromLoadedModel,t.lightMapData=this.mesh3js.lightMapData,t._ratioData=this.mesh3js._ratioData,t._programID=this.mesh3js._programID?this.mesh3js._programID:t._programID,t._vertexColors=this.mesh3js._vertexColors,t._skinning=this.mesh3js._skinning,t._skinningInstancing=this.mesh3js._skinningInstancing,t._billboardData=this.mesh3js._billboardData,t.materialMode=this.mesh3js.materialMode,t._bodyDim=this._bodyDim,t.kdTree=this.mesh3js.kdTree,t.hasPoint=this.mesh3js.hasPoint,this.mesh3js.disableMirror&&(t.disableMirror=this.mesh3js.disableMirror);var i=s?null:this._occurrences[0].renderable;if(i){i.layer&&(t.layer=i.layer.clone());var r=i.selectionGroups;if(r)for(var n=0;n<r.length;n++)t.addSelectionGroup(r[n].clone())}return this.mesh3js.copyInstancingInfos(t),t},add:function(){return!1},setRenderDepth:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.renderDepth=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.renderDepth=e)},setFrustumCulled:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.frustumCulled=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.frustumCulled=e)},setVertexColors:function(e){null!==this.mesh3js&&this.mesh3js.setVertexColors(e);for(var t=0;t<this._occurrences.length;t++){var i=this._occurrences[t];null!==i.renderable&&i.renderable.setVertexColors(e)}},setSkinningTransformations:function(e){null!==this.mesh3js&&this.mesh3js.setSkinningTransformations(e);for(var t=0;t<this._occurrences.length;t++){var i=this._occurrences[t];null!==i.renderable&&i.renderable.setSkinningTransformations(e)}},setSkinningTransformationsInstancing:function(e){null!==this.mesh3js&&this.mesh3js.setSkinningTransformationsInstancing(e);for(var t=0;t<this._occurrences.length;t++){var i=this._occurrences[t];null!==i.renderable&&i.renderable.setSkinningTransformationsInstancing(e)}},setSSAO:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.enableNormalDepth=e,this.mesh3js._flagAsGSSOInvalidated()),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.enableNormalDepth=e,i.renderable._flagAsGSSOInvalidated())},setShadow:function(e,t){var i,r;for(null!==this.mesh3js&&(this.mesh3js.castShadow=e,this.mesh3js.receiveShadow=t),i=0;i<this._occurrences.length;i++)null!==(r=this._occurrences[i]).renderable&&(r.renderable.castShadow=e,r.renderable.receiveShadow=t)},setMirror:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.disableMirror=e?0:1),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.disableMirror=e?0:1)},clone:function(t){var i=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);!!t&&(this.mesh3js.geometry.boundingSphere&&(i.geometry.boundingSphere=this.mesh3js.geometry.boundingSphere.clone()),this.mesh3js.geometry.boundingBox&&(i.geometry.boundingBox=this.mesh3js.geometry.boundingBox.clone())),this.mesh3js.copyInstancingInfos(i),i.castShadow=this.mesh3js.castShadow,i.receiveShadow=this.mesh3js.receiveShadow;var r=new THREEDS.Nodes.Mesh(i,this.name);return this.getIsInstanceNode3D()&&r.setIsInstanceNode3D(!0),r},getPrimitive:function(e,t){var i=this._getPrimitives(e,t);return i.length?i[0]:null},getPrimitives:function(e,t){return this._getPrimitives(void 0,e,t)},show:function(e){e?this._setLayer(e,1):this._initLayer(1)},hide:function(e){e?this._setLayer(e,0):this._initLayer(0)},setMaterial:function(t,i){!t||t instanceof e.Material?this._parent(t):t&&(this._initLayer(1),this._setLayer(t,1,i))},setNoZPriority:function(e,t){e&&e instanceof Object?e&&(this._initLayer(1),this._setLayer(e,1,void 0,void 0,t?4:-1)):this._parent(e)},_setGAS:function(e,t){e instanceof Array?e&&(this._initLayer(1),this._setLayer(e,1,void 0,t)):this._parent(e)},_setNoZOnGeomTypes:function(e,t){this._initLayer(1),this._setLayerOnGeomTypes(e,void 0,void 0,void 0,t?4:-1)},_setMaterialOnGeomTypes:function(e,t){this._initLayer(1),this._setLayerOnGeomTypes(e,void 0,t)},_setGASOnGeomTypes:function(e,t){this._initLayer(1),this._setLayerOnGeomTypes(e,void 0,void 0,t)},_getGas:function(e){return this._getMaterials(e,!0)},_getMaterials:function(e,t){var r=this._getPrimitivesFromElts(e);if(!r.length)return!1;var n=r[0].container instanceof i.DrawingGroup,a=[],s=this._occurrences[0].renderable;if(!s)return!1;var o=new i.SGPrimitiveHelper;if(s.layer)for(var l=0;l<r.length;l++)for(var c=r[l],h=0;h<s.layer.layers.length;h++){var u=s.layer.layers[h].drawableGroup,d=s.layer.layers[h].drawableInterval;if(-1!==d.layerNum&&((t||d.material)&&(!t||d.gas))){if(n){if(c.container!==u)continue;if(c.index<d.primitiveStart||c.index>=d.primitiveStart+d.primitiveCount)continue;return t?a.push(d.gas):a.push(d.material),a}for(var p=d.primitiveStart;p<d.primitiveStart+d.primitiveCount;p++)if(o.set(u,p),o.isEqual(c))return t?a.push(d.gas):a.push(d.material),a}}return a},setMaterialMode:function(e){var t=e?1:null===e?2:0;null!==this.mesh3js&&(this.mesh3js.materialMode=t);for(var i=0;i<this._occurrences.length;i++){var r=this._occurrences[i];null!==r.renderable&&(r.renderable.materialMode=t)}},getNodeType:function(){return"Mesh3D"},getBodyDimension:function(){return this._bodyDim?this._bodyDim:-1},isEditable:function(){return!1},setInstancingParameters:function(t,i,r){var n,s;if(void 0!==this.mesh3js)if(n=this.mesh3js,this._matApp&&((s=this._matApp._getMaterialFromGLType(4,e.GeomTypeEnum.FACE))||(s=this._matApp._getMaterialFromGLType(1)),s||(s=this._matApp._getMaterialFromGLType(0))),s||(s=this.material),s){s.isInstancingMaterial=!0,this.setIsInstanceNode3D(!0),this.nbInstances=t,n._instancingInfos={isInstanceNode3D:!0,nbInstances:t,instancingSelectionMode:r||"instance",instanceAttribArrays:null,pickedInstanceId:-1};for(var o=new Float32Array(t),l=0;l<t;l++)o[l]=5+5*l;var c={};c.id=a,a++,s.attributes={},c.instanceId={},c.instanceId.array=o,c.instanceId.buffer=null,c.instanceId.itemSize=1,s.attributes.instanceId={type:"f"};for(var h=0;h<i.length;h++){switch(c[i[h].attribName]={},i[h].type){case"f":c[i[h].attribName].array=new Float32Array(i[h].data),s.attributes[i[h].attribName]={type:"f"},c[i[h].attribName].itemSize=1;break;case"v2":if(i[h].isFlattened)c[i[h].attribName].array=new Float32Array(i[h].data);else{c[i[h].attribName].array=new Float32Array(2*t);for(var u=0;u<t;u++)c[i[h].attribName].array[2*u]=i[h].data[u].x,c[i[h].attribName].array[2*u+1]=i[h].data[u].y}s.attributes[i[h].attribName]={type:"v2"},c[i[h].attribName].itemSize=2;break;case"v3":if(i[h].isFlattened)c[i[h].attribName].array=new Float32Array(i[h].data);else{c[i[h].attribName].array=new Float32Array(3*t);for(u=0;u<t;u++)c[i[h].attribName].array[3*u]=i[h].data[u].x,c[i[h].attribName].array[3*u+1]=i[h].data[u].y,c[i[h].attribName].array[3*u+2]=i[h].data[u].z}s.attributes[i[h].attribName]={type:"v3"},c[i[h].attribName].itemSize=3;break;case"v4":if(i[h].isFlattened)c[i[h].attribName].array=new Float32Array(i[h].data);else{c[i[h].attribName].array=new Float32Array(4*t);for(u=0;u<t;u++)c[i[h].attribName].array[4*u]=i[h].data[u].x,c[i[h].attribName].array[4*u+1]=i[h].data[u].y,c[i[h].attribName].array[4*u+2]=i[h].data[u].z,c[i[h].attribName].array[4*u+3]=i[h].data[u].w}s.attributes[i[h].attribName]={type:"v4"},c[i[h].attribName].itemSize=4;break;case"m4":if(i[h].isFlattened)c[i[h].attribName].array=new Float32Array(i[h].data);else{c[i[h].attribName].array=new Float32Array(16*i[h].data.length);for(var d=0;d<i[h].data.length;d++){var p=new Float32Array(16);p=i[h].data[d].elements;for(l=0;l<16;l++)c[i[h].attribName].array[16*d+l]=p[l]}}s.attributes[i[h].attribName]={type:"m4"},c[i[h].attribName].itemSize=4,c[i[h].attribName].isMat4=!0}c[i[h].attribName].buffer=null}if(n._instancingInfos.instanceAttribArrays=c,s._PDSFXData&&s._PDSFXData.PDSFX){var f="";for(h=0;h<i.length;h++)f+="attribute "+e.ToGLSLTypes[i[h].type].t+" "+i[h].attribName+";\n";s._PDSFXData.pdsfxAttributesCode=f}for(var m=0;m<this._occurrences.length;m++)n.copyInstancingInfos(this._occurrences[m].renderable)}else console.error("Error: An instancing material wasn't set to the Mesh3D.")},updateInstanceAttribValue:function(t){if(t.instanceId&&t.attribName&&void 0!==t.value){var i;this._matApp&&((i=this._matApp._getMaterialFromGLType(4,e.GeomTypeEnum.FACE))||(i=this._matApp._getMaterialFromGLType(1)),i||(i=this._matApp._getMaterialFromGLType(0))),i||(i=this.material);var r=this.mesh3js;if(r._instancingInfos)if(t.instanceId%5!=0||t.instanceId<5||t.instanceId>5*r._instancingInfos.nbInstances)console.error("Error: the instance id is incorrect or out of range.");else if(r._instancingInfos.instanceAttribArrays[t.attribName]&&i.attributes[t.attribName]){var n=t.instanceId/5-1,a=i.attributes[t.attribName].type,s=!0,o=r._instancingInfos.instanceAttribArrays;switch(a){case"f":"number"!=typeof t.value||isNaN(t.value)?s=!1:o[t.attribName].array[n]=t.value;break;case"v2":t.value instanceof e.Vector2?(o[t.attribName].array[2*n]=t.value.x,o[t.attribName].array[2*n+1]=t.value.y):s=!1;break;case"v3":t.value instanceof e.Vector3?(o[t.attribName].array[3*n]=t.value.x,o[t.attribName].array[3*n+1]=t.value.y,o[t.attribName].array[3*n+2]=t.value.z):s=!1;break;case"v4":t.value instanceof e.Vector4?(o[t.attribName].array[4*n]=t.value.x,o[t.attribName].array[4*n+1]=t.value.y,o[t.attribName].array[4*n+2]=t.value.z,o[t.attribName].array[4*n+3]=t.value.w):s=!1;break;case"m4":if(t.value instanceof e.Matrix4){var l=new Float32Array(16);l=t.value.elements;for(var c=0;c<16;c++)o[t.attribName].array[16*n+c]=l[c]}else s=!1;break;default:s=!0}if(s){var h;o[t.attribName].isDynamic=!0;for(var u=0;u<this._occurrences.length;u++){var d;if((h=this._occurrences[u].renderable)._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0,h.highlightMeshes)for(d=0;d<h.highlightMeshes.length;d++)h.highlightMeshes[d].renderable._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0}}else console.error("Error: the type of the new value doesn't match the type of the attribute data.")}else console.error("Error: the attribute "+t.attribName+" doesn't exist for this mesh node.");else console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).")}else console.error("Error: all parameters params.instanceId, params.attribName and params.value are needed.")},updateInstanceAttribArray:function(t){if(t.attribName&&t.array){var i;this._matApp&&((i=this._matApp._getMaterialFromGLType(4,e.GeomTypeEnum.FACE))||(i=this._matApp._getMaterialFromGLType(1)),i||(i=this._matApp._getMaterialFromGLType(0))),i||(i=this.material);var r=this.mesh3js;if(r._instancingInfos)if(r._instancingInfos.instanceAttribArrays[t.attribName]&&i.attributes[t.attribName]){var n=!0,a=r._instancingInfos.instanceAttribArrays;if(t.isFlattened)t.array instanceof Array&&(t.array=new Float32Array(t.array)),a[t.attribName].array=t.array;else{var s=i.attributes[t.attribName].type,o=t.array[0];switch(s){case"f":"number"!=typeof o||isNaN(o)?n=!1:a[t.attribName].array.set(new Float32Array(t.array));break;case"v2":if(o instanceof e.Vector2)for(var l=0;l<r._instancingInfos.nbInstances;l++)a[t.attribName].array[2*l]=t.array[l].x,a[t.attribName].array[2*l+1]=t.array[l].y;else n=!1;break;case"v3":if(o instanceof e.Vector3)for(l=0;l<r._instancingInfos.nbInstances;l++)a[t.attribName].array[3*l]=t.array[l].x,a[t.attribName].array[3*l+1]=t.array[l].y,a[t.attribName].array[3*l+2]=t.array[l].z;else n=!1;break;case"v4":if(o instanceof e.Vector4)for(l=0;l<r._instancingInfos.nbInstances;l++)a[t.attribName].array[4*l]=t.array[l].x,a[t.attribName].array[4*l+1]=t.array[l].y,a[t.attribName].array[4*l+2]=t.array[l].z,a[t.attribName].array[4*l+3]=t.array[l].w;else n=!1;break;case"m4":if(o instanceof e.Matrix4){var c;for(l=0;l<r._instancingInfos.nbInstances;l++){c=t.array[l].elements;for(var h=0;h<16;h++)a[t.attribName].array[16*l+h]=c[h]}}else n=!1;break;default:n=!0}}if(n){var u;a[t.attribName].isDynamic=!0;for(var d=0;d<this._occurrences.length;d++){var p;if((u=this._occurrences[d].renderable)._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0,u.highlightMeshes)for(p=0;p<u.highlightMeshes.length;p++)u.highlightMeshes[p].renderable._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0}}else console.error("Error: the type of the new values don't match the type of the attribute data.")}else console.error("Error: the attribute "+t.attribName+" doesn't exist for this mesh node.");else console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).")}},setInstancingSelectionMode:function(e){if(this.mesh3js._instancingInfos&&this.mesh3js._instancingInfos.isInstanceNode3D){this.mesh3js._instancingInfos.instancingSelectionMode=e;for(var t=this._occurrences,i=t.length,r=0;r<i;r++)t[r].renderable._instancingInfos.instancingSelectionMode=e}},_getPrimitivesFromElts:function(e){var t=[];if(e.length)if(e[0]instanceof r)for(var n=0;n<e.length;n++)if("rep"===e[n].getType())for(var a=0;a<e[n].sgNode.getPrimitivesCount();a++){var s=new i.SGPrimitiveHelper;s.set(e[n].sgNode,a),t.push(s)}else t.push(e[n].sgNode);else t=e.slice();return t},_setLayer:function(e,t,i,r,n){var a,s,o=[];if(s=this._getPrimitivesFromElts(e),-1===t){var l;if(!(l=this._occurrences[0].renderable))return;o=l.getRenderablesFromGeometries()}else for(a=0;a<this._occurrences.length;a++)o.push(this._occurrences[a].renderable);for(a=0;a<o.length;a++)if(l=o[a]){var c;if(l._flagAsGSSOInvalidated(),null===l.layer)if(l.initLayers(1),l.highlightMeshes)for(c=0;c<l.highlightMeshes.length;c++)l.highlightMeshes[c].renderable.layer=l.layer.clone();l.layer.addPrimitivesToLayers(s,t,i,r,null,n)}},_setLayerOnGeomTypes:function(e,t,i,r,n){var a=[];if(-1===t){if(!(o=this._occurrences[0].renderable))return;a=o.getRenderablesFromGeometries()}else for(s=0;s<this._occurrences.length;s++)a.push(this._occurrences[s].renderable);for(var s=0;s<a.length;s++){var o;if(o=a[s]){var l;if(o._flagAsGSSOInvalidated(),null===o.layer)if(o.initLayers(1),o.highlightMeshes)for(l=0;l<o.highlightMeshes.length;l++)o.highlightMeshes[l].renderable.layer=o.layer.clone();for(var c=0;c<o.geometry.length;c++)for(var h=o.geometry[c],u=0;u<h.drawingGroups.length;u++){var d=h.drawingGroups[u],p=void 0!==d._initialGeomType?d._initialGeomType:d._geomType;-1!==e.indexOf(p)&&o.layer.setDGToLayer(h,d,t,i,r,void 0,n)}}}},_initLayer:function(e){var t,i;for(t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable._flagAsGSSOInvalidated(),null===i.renderable.layer&&i.renderable.initLayers(e))},_removePrimitives:function(e){e&&this._setLayer(e,-1)},_addDynamicGeometry:function(e,t,i){var r=null,n=this._occurrences[0].renderable;if(!n)return!1;for(var a=0;a<n.geometry.length;a++)if(n.geometry[a].dynamic){r=n.geometry[a];break}if(r)r.merge(e,t,i);else{e.dynamic=!0;for(a=0;a<this._occurrences.length;a++)(n=this._occurrences[a].renderable)&&n.addGeometry(e)}},_optimizeBuffers:function(e){var t={invalidRatio:e&&void 0!==e.invalidRatio?e.invalidRatio:.5};if(l=this._occurrences[0].renderable){var r=l.geometry;if(r instanceof Array){var n=l.layer?l.layer.layers:null;if(n){var a=new Map,s=i.mergeGeometries({geometries:r,layers:n,invalidRatio:t.invalidRatio,force:!1},a);if(s)for(var o=0;o<this._occurrences.length;o++){var l;if(l=this._occurrences[o].renderable){l.releaseVBO(!1),l.geometry.length=0;for(var c=0;c<s.length;c++)l.geometry.push(s[c]);for(c=0;c<s.length;c++)s[c].addRefVBO(l,!1);s.boundingBox&&(l.geometry.boundingBox=s.boundingBox.clone()),s.boundingSphere&&(l.geometry.boundingSphere=s.boundingSphere.clone());var h=l.layer.layers,u=!1,d=[];for(c=0;c<h.length;c++){var p=[],f=h[c].drawableGroup,m=h[c].drawableInterval;if(m.layerNum>0&&m.material){u=!0;for(var g=m.primitiveStart;g<m.primitiveStart+m.primitiveCount;g++)if(a.has(f)){var v=a.get(f);v.has(g)&&p.push(v.get(g))}d.push({layerInterval:m,primitives:p})}}if(l.layer=null,u){l.initLayers(1);for(c=0;c<d.length;c++)l.layer.addPrimitivesToLayers(d[c].primitives,d[c].layerInterval.layerNum,d[c].layerInterval.material)}}}}}}},_getPrimitives:function(e,t,n){""===e&&(e=null);var a=[],s=this._occurrences[0].renderable;if(!s)return!1;var o=new i.SGPrimitiveHelper;if(s.layer)for(var l=0;l<s.layer.layers.length;l++){var c=s.layer.layers[l].drawableGroup,h=s.layer.layers[l].drawableInterval;if(void 0!==n)if((void 0!==c._initialGeomType?c._initialGeomType:c._geomType)!==n)continue;if(-1!==h.layerNum&&(!t||h.layerNum))for(var u=h.primitiveStart;u<h.primitiveStart+h.primitiveCount;u++)if(o.set(c,u),void 0!==e){if(o.getCgmId()===e)return a.push(r.getFromSGNode(o.clone())),a}else a.push(r.getFromSGNode(o.clone()))}else{var d=s.geometry;if(!(d instanceof Array))return a;for(u=0;u<d.length;u++){var p=d[u].drawingGroups;for(l=0;l<p.length;l++){c=p[l];if(void 0!==n)if((void 0!==c._initialGeomType?c._initialGeomType:c._geomType)!==n)continue;for(var f=0;f<c.getPrimitivesCount();f++)if(o.set(c,f),void 0!==e){if(o.getCgmId()===e)return a.push(r.getFromSGNode(o.clone())),a}else a.push(r.getFromSGNode(o.clone()))}}}return a},_setBeforeRenderCB:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.beforeRenderCB=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.beforeRenderCB=e)}});o.prototype._isMesh3D=!0;var l=1,c=2;return o.prototype.getHasExplicitBE=function(){return(this.mesh3DBooleanAttr&l)>0},o.prototype.setHasExplicitBE=function(e){this.mesh3DBooleanAttr=e?this.mesh3DBooleanAttr|l:this.mesh3DBooleanAttr&~l},o.prototype.getIsInstanceNode3D=function(){return(this.mesh3DBooleanAttr&c)>0},o.prototype.setIsInstanceNode3D=function(e){this.mesh3DBooleanAttr=e?this.mesh3DBooleanAttr|c:this.mesh3DBooleanAttr&~c},o.prototype.forceNoMeshInRAM=function(){var e,t,i=this.mesh3js.geometry;for(e=0;e<i.length;e++){if((t=i[e]).sharedBuffers)throw new Error("Cannot force no mesh in RAM on geometry with sharedBuffers");t.noMeshInRAM||(t.noMeshInRAM=!0,t.vertexBufferGPU&&t.clearMeshInRAM(!1))}},Object.defineProperty(o.prototype,"hasExplicitBE",{get:function(){return this.getHasExplicitBE()},set:function(e){this.setHasExplicitBE(e)}}),Object.defineProperty(o.prototype,"isInstanceNode3D",{get:function(){return this.getIsInstanceNode3D()},set:function(e){this.setIsInstanceNode3D(e)}}),UWA.namespace("THREEDS/Nodes/Mesh",o)}),define("Visualization/Mesh3D",["DS/Visualization/Mesh3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Mesh3D"),e}),define("DS/VisuLoaders/ThreeDXStreamer",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/ZipJS/zip"],function(e,t,i,r,n,a,s){"use strict";var o=null,l=new e.Box3,c=new e.Vector3;return{stream:function(r){var n=["vertexIndexArray","vertexPositionArray","vertexNormalArray","vertexUvArray","vertexUv2Array","vertexColorArray","vertexTangentArray","vertexBinormalArray"],a={vertexPositionArray:1,vertexNormalArray:2,vertexUvArray:4,vertexUv2Array:8,vertexColorArray:16,vertexTangentArray:32,vertexBinormalArray:64},h=["none","PLANAR","SPHERICAL","CUBIC","FINITE_CYLINDRICAL","INFINITE_CYLINDRICAL"],u={1003:"NEAREST",1004:"NEAREST_MIPMAP_NEAREST",1005:"NEAREST_MIPMAP_LINEAR",1006:"LINEAR",1007:"LINEAR_MIPMAP_NEAREST",1008:"LINEAR_MIPMAP_LINEAR"},d={1000:"REPEAT",1001:"CLAMP_TO_EDGE",1002:"MIRRORED_REPEAT"},p={0:"POINTS",1:"LINES",4:"TRIANGLES"},f=!!r.zipped||!1,m=!!r.concat||!1,g=r.compressNormals||!1,v=r.compressVertices||!1,S=null,_=null,y=r.layers||!1,x=r.streamEdges||!1,M=r.streamPoints||!1,P=void 0!==r.primitives&&r.primitives,C=r.reps||!1,b=r.node?r.node:r,D=(r.metalnessToSpecularConverter&&r.metalnessToSpecularConverter,r.nodeCallback),w=r.imageCallback,E=r.endCallback,T=null,A=(r.embeddedTextures,0),I=0,R=new WeakMap,L=0,O={binaries:{},vertexLayouts:{},buffers:{},images:{},textures:{},materials:{},geometries:{},nodes:{}},N={header:{generator:"Dassault Systemes 3DX generator",version:"3.0",upAxis:"Z",unit:"mm"},binaries:[],buffers:[],vertexLayouts:[],images:[],textures:[],materials:[],geometries:[],nodes:[],extensionsUsed:[],extensionsRequired:[],root:null},F=new Set,V=new Set,U=104857600,B={geometry:0,image:1},k=[],G={json:N,chunks:k,zipData:null};function z(e,t,i,r){for(var n=i,a=0;a<r;a++)t[n++]=e[a];return n}function H(e,t,i){var r=function(e){for(var t=new ArrayBuffer(2*e.length),i=new Uint16Array(t),r=0,n=e.length;r<n;r++)i[r]=e.charCodeAt(r);return t}(JSON.stringify(e.json,void 0,2)),n=4+r.byteLength;n%4&&(n+=4-n%4);for(var a=0;a<e.chunks.length;a++)(n+=e.chunks[a].data.byteLength)%4&&(n+=4-n%4);var s=new ArrayBuffer(n),o=4,l=new Uint32Array(s,0,1),c=new Uint8Array(s);l[0]=r.byteLength,(o=z(new Uint8Array(r),c,o,r.byteLength))%4&&(o+=4-o%4);for(a=0;a<e.chunks.length;a++){var h=e.chunks[a].data;(o=z(h,c,o,h.byteLength))%4&&(o+=4-o%4)}e.concatData=s,t&&t()}function W(e,t,i){_||(_=new s.BlobWriter);for(var r=JSON.stringify(e.json,void 0,2),n=new Blob([r],{type:"text/plain"}),a=0,o=[{data:n}],l=0;l<e.chunks.length;l++)o.push({index:l,data:new Blob([e.chunks[l].data],{type:"arraybuffer"})});function c(){var i=o[a],r=a?e.json.binaries[i.index].uri:"manifest.json";S.add(r,new s.BlobReader(i.data),function(){++a<o.length?c():S.close(function(i){e.zipData=i,t&&t()})},null)}S?c():s.createWriter(_,function(e){S=e,c()},i)}function j(e){for(var t=0;t<k.length;t++){var i=k[t];e.binaries[t].byteLength=i.size,i.data=new Uint8Array(i.size);for(var r=0;r<i.buffers.length;r++)for(var n=i.buffers[r],a=n.buffer,s=n.offset,o=0;o<a.byteLength;o++)i.data[s+o]=a[o]}return k}function X(e,t){var i=k[B[t]];(!i||i.size+e.byteLength>U)&&(B[t]=k.length,i={size:0,buffers:[],data:null,type:t},k.push(i));var r=i.size;return i.buffers.push({buffer:new Uint8Array(e.buffer,e.byteOffset,e.byteLength),offset:r}),i.size+=e.byteLength,i.size%4&&(i.buffers.push({buffer:new Uint8Array(4-i.size%4),offset:i.size}),i.size+=4-i.size%4),r}function q(){A--,console.log("nb textures loading: "+A),T&&!A&&(G.chunks=j(N),f?W(G,function(){T(G)}):m?H(G,function(){T(G)}):T(G))}function Z(e,t,i,r){var n={name:i,format:t},a=new FileReader;return a.onload=function(){var e=new DataView(this.result),t=X(e,"image");n.binary=ee(B,"image",r),n.byteOffset=t,n.byteLength=e.byteLength,q()},a.readAsArrayBuffer(e),n}function Y(i,r,n){if(i.image)if(i.image.getContext||i.image.tagName&&"img"===i.image.tagName.toLowerCase())if(i.sourceFile&&"blob:"===i.sourceFile.substring(0,5)){if(!(m=O.images[i.sourceFile])){A++,console.log("nb textures loading: "+A);var a=function(e,t){var i={name:"image_"+e.sourceFile},r=new XMLHttpRequest;return r.open("GET",e.sourceFile,!0),r.responseType="blob",r.onload=function(e){if(200===this.status){var r=this.response.type;i.format="image/jpeg"===r?"jpeg":"png";var n=new FileReader;n.onload=function(){var e=new DataView(this.result),r=X(e,"image");i.binary=ee(B,"image",t),i.byteOffset=r,i.byteLength=e.byteLength,q()},n.readAsArrayBuffer(this.response),console.log("canvas blob")}},r.send(),i}(i,r);m={index:r.images.length,item:a},r.images.push(a),O.images[i.sourceFile]=m}n.image=m.index}else{var s="jpeg";if(!(S=i.image).getContext){if(S.src){var l=t.getExtension(S.src);l&&"png"===l.toLowerCase()&&(s="png")}(S=o||document.createElement("canvas")).width=i.image.width,S.height=i.image.height,(_=S.getContext("2d")).drawImage(i.image,0,0,i.image.width,i.image.height)}for(var c=atob(S.toDataURL("image/"+s).split(",")[1]),h=new Array(c.length),u=0;u<c.length;u++)h[u]=c.charCodeAt(u);var d=new Uint8Array(h),p=new Blob([d],{type:"image/"+s}),f="img_"+I;I++,A++,console.log("nb textures loading: "+A);a=Z(p,s,f,r);var m={index:r.images.length,item:a};r.images.push(a),O.images[f]=m,n.image=m.index,console.log("png")}else if(i.mipmaps&&i.mipmaps.length){var g=i.image.width,v=i.image.height;p=new Blob([e.ImageUtils.streamDDS(i)],{type:"arraybuffer"}),f="img_"+I;I++,A++,console.log("nb textures loading: "+A);a=Z(p,"dds",f,r),m={index:r.images.length,item:a};r.images.push(a),O.images[f]=m,n.image=m.index,console.log("dds")}else{var S;g=i.image.width,v=i.image.height;(S=o||document.createElement("canvas")).width=g,S.height=v;var _,y=(p=(_=S.getContext("2d")).getImageData(0,0,g,v)).data;if(1021==i.format)for(u=0;u<v;u++)for(var x=0;x<4*g;x++)y[4*(v-u-1)*g+x]=i.image.data[4*u*g+x];else if(1020==i.format)for(u=0;u<v;u++)for(x=0;x<g;x++){for(var M=0;M<3;M++)y[4*(v-u-1)*g+4*x+M]=i.image.data[3*u*g+3*x+M];y[4*(v-u-1)*g+4*x+3]=255}else console.log("texture format export to code :"+i.format);_.putImageData(p,0,0,0,0,g,v);for(c=atob(S.toDataURL("image/png").split(",")[1]),h=new Array(c.length),u=0;u<c.length;u++)h[u]=c.charCodeAt(u);d=new Uint8Array(h),p=new Blob([d],{type:"image/png"}),f="img_"+I;I++,A++,console.log("nb textures loading: "+A);a=Z(p,"png",f,r),m={index:r.images.length,item:a};r.images.push(a),O.images[f]=m,n.image=m.index,console.log("uncompressed")}}function K(t,i,r){var n;if(!n){var a={anisotropy:t.anisotropy,magFilter:u[t.magFilter],minFilter:u[t.minFilter],uWrap:d[t.wrapS],vWrap:d[t.wrapT],mapping:i};if(w)w(t,a);else if(t.loadEndStatus&&t.loadEndStatus!==e.AssetLoadingStatus.READY){if(t.loadEndStatus===e.AssetLoadingStatus.ERROR)return void console.log("Texture corrupted: impossible to embed it in 3dx archive.");t.onLoadCallbacks.push(function(e){Y(e,r,a)})}else Y(t,r,a);n={index:r.textures.length,item:a},r.textures.push(a)}return n.index}function J(t,i){var r=O.textures[t.id];if(!r){var n={anisotropy:t.anisotropy,magFilter:u[t.magFilter],minFilter:u[t.minFilter],uWrap:d[t.wrapS],vWrap:d[t.wrapT]};if(w)w(t,n);else if(t.loadEndStatus&&t.loadEndStatus!==e.AssetLoadingStatus.READY){if(t.loadEndStatus===e.AssetLoadingStatus.ERROR)return void console.log("Texture corrupted: impossible to embed it in 3dx archive.");t.onLoadCallbacks.push(function(e){Y(e,i,n)})}else Y(t,i,n);r={index:i.textures.length,item:n},i.textures.push(n),O.textures[t.id]=r}return r.index}function Q(e){return[e.r,e.g,e.b]}function $(t,i){var r="Phong";if(t instanceof e.ParticleBasicMaterial)r="PointBasic";else if(t instanceof e.LineBasicMaterial)r="LineBasic";else if(t instanceof e.MeshBasicMaterial)r="MeshBasic";else if(t instanceof e.PhysicalMaterial){r="Physical";var n="EXT_Material_PBR";F.has(n)||(F.add(n),N.extensionsUsed.push(n)),V.has(n)||(V.add(n),N.extensionsRequired.push(n))}else t instanceof e.MeshLambertMaterial&&(r="Lambert");var a={type:r,visible:t.visible,side:t.side,transparent:t.transparent,alphaTest:t.alphaTest,depthTest:t.depthTest,depthWrite:t.depthWrite};if(t instanceof e.PhysicalMaterial){var s=function(e,r,n){a[e]={};var s=a[e];if(void 0!==t[r]){if(void 0===t[r+"Map"])return void(a[e]="number"==typeof t[r]?t[r]:t[r].x);s.value="number"==typeof t[r]?t[r]:t[r].x}if(t[r+"Map"])if(n){var o=t[r+"UvTransform"].elements;if(t.mappingType>0)n={operator:{type:h[t.mappingType],transform:t.mappingObjTransformation.elements},uvTransform:[o[0],o[1],o[2],0,o[3],o[4],o[5],0,o[6],o[7],o[8],0,0,0,0,1]};else{t[r+"UvSlot"]&&2===t[r+"UvSlot"]&&"TEXCOORD_1",n={slot:"slot",uvTransform:[o[0],o[1],o[2],0,o[3],o[4],o[5],0,o[6],o[7],o[8],0,0,0,0,1]}}s.texture=K(t[r+"Map"],n,i)}else s.texture=J(t[r+"Map"],i);t[r+"MulCoef"]>0&&(s.MADCoefficients=[t[r+"MulCoef"],t[r+"AddCoef"]])},o=function(e,r,n){a[e]={};var s=a[e];if(void 0!==t[r+"Map"]){if(s.value=Q(t[r]),t[r+"Map"])if(n){var o=t[r+"UvTransform"].elements;if(t.mappingType>0)n={operator:{type:h[t.mappingType],transform:t.mappingObjTransformation.elements},uvTransform:[o[0],o[1],o[2],0,o[3],o[4],o[5],0,o[6],o[7],o[8],0,0,0,0,1]};else{var l="TEXCOORD_0";t[r+"UvSlot"]&&2===t[r+"UvSlot"]&&(l="TEXCOORD_1"),n={slot:l,uvTransform:[o[0],o[1],o[2],0,o[3],o[4],o[5],0,o[6],o[7],o[8],0,0,0,0,1]}}s.texture=K(t[r+"Map"],n,i)}else s.texture=J(t[r+"Map"],i);t[r+"MulCoef"]&&(s.MADCoefficients=[t[r+"MulCoef"].x,t[r+"MulCoef"].y,t[r+"MulCoef"].z,t[r+"AddCoef"].x,t[r+"AddCoef"].y,t[r+"AddCoef"].z])}else a[e]=Q(t[r])};if(a.albedo={},a.albedo.value=Q(t.color),t.map){var l,c=t.diffuseUvTransform.elements;if(t.mappingType>0)l={operator:{type:h[t.mappingType],transform:t.mappingObjTransformation.elements},uvTransform:[c[0],c[1],c[2],0,c[3],c[4],c[5],0,c[6],c[7],c[8],0,0,0,0,1]};else{var u="TEXCOORD_0";t.diffuseUvSlot&&2===t.diffuseUvSlot&&(u="TEXCOORD_1"),l={slot:u,uvTransform:[c[0],c[1],c[2],0,c[3],c[4],c[5],0,c[6],c[7],c[8],0,0,0,0,1]}}a.albedo.texture=K(t.map,l,i)}t.diffuseMulCoef&&(a.albedo.MADCoefficients=[t.diffuseMulCoef.x,t.diffuseMulCoef.y,t.diffuseMulCoef.z,t.diffuseAddCoef.x,t.diffuseAddCoef.y,t.diffuseAddCoef.z]),s("metallic","metalness",!0),s("roughness","roughness",!0),function(e,r,n){a[e]={};var s=a[e];if(t[r+"Map"])if(t[r+"MapFlipY"]&&(a[r+"MapFlipY"]=t[r+"MapFlipY"]),n){var o=t[r+"UvTransform"].elements;if(t.mappingType>0)n={operator:{type:h[t.mappingType],transform:t.mappingObjTransformation.elements},uvTransform:[o[0],o[1],o[2],0,o[3],o[4],o[5],0,o[6],o[7],o[8],0,0,0,0,1]};else{var l="TEXCOORD_0";t[r+"UvSlot"]&&2===t[r+"UvSlot"]&&(l="TEXCOORD_1"),n={slot:l,uvTransform:[o[0],o[1],o[2],0,o[3],o[4],o[5],0,o[6],o[7],o[8],0,0,0,0,1]}}s.texture=K(t[r+"Map"],n,i)}else s.texture=J(t[r+"Map"],i)}("normal","normal",!0),s("normalScale","normalScale",!1),s("transparency","transparency",!0),s("cutoutOpacity","opacity",!0),s("specular","specularContrib",!0),o("specularTint","specular",!0),o("emissionColor","emissionColor",!0),s("emissionValue","emissionValue",!1),a.emissionEnergyNormalization=t.emissionNormalized,a.emissionMode="LUMINOUS_EMITTANCE",a.thinWalled=t.thinWalled,s("ior","ior",!1),a.vertexColors=t.vertexColors,a.alphaTest=t.alphaTest,t.occlusionMap&&(a.occlusionMap=J(t.occlusionMap,i)),a.uv0Transform=[],t.mappingUVTransformation.flattenToArray(a.uv0Transform),a={extensions:{EXT_Material_PBR:a}}}else a.opacity=t.opacity,t.color&&(a.color=Q(t.color)),t instanceof e.ParticleBasicMaterial&&(a.size=t.size,a.sizeAttenuation=t.sizeAttenuation),t instanceof e.LineBasicMaterial&&(a.lineWidth=t.lineWidth),(t instanceof e.MeshPhongMaterial||t instanceof e.MeshLambertMaterial)&&(a.ambient=Q(t.ambient),a.shininess=t.shininess),(t instanceof e.MeshPhongMaterial||t instanceof e.MeshLambertMaterial)&&(a.emissive=Q(t.emissive),t.specular&&(a.specular=Q(t.specular)),a.vertexColors=t.vertexColors,t.map&&(a.diffuseMap=J(t.map,i)),t.bumpMap&&(a.bumpMap=J(t.bumpMap,i)),t.normalMap&&(a.normalMap=J(t.normalMap,i)),t.specularMap&&(a.specularMap=J(t.specularMap,i)),t.bumpMap&&void 0!==t.bumpScale&&(a.bumpMapScale=t.bumpScale),t.normalMap&&void 0!==t.normalScale&&(a.normalMapScale=t.normalScale));return a}function ee(e,t,i){var r=e[t];return i.binaries[r]||(i.binaries[r]={uri:t+"_"+r+".bin",byteLength:0}),r}function te(e,t){var i=X(e,"geometry");return{binary:ee(B,"geometry",t),byteOffset:i,byteLength:e.byteLength}}function ie(e,t){var i=te(e,t);return e instanceof Uint32Array?i.format="UNSIGNED_INT":i.format="UNSIGNED_SHORT",t.buffers.push(i),t.buffers.length-1}function re(e,t){var i=te(e,t);return t.buffers.push(i),t.buffers.length-1}function ne(e){for(var t=e.length/3,i=new Uint8Array(3*t),r=0;r<t;r++){var n=e[3*r],a=e[3*r+1],s=e[3*r+2],o=Math.abs(n)+Math.abs(a)+Math.abs(s),l=n/o,c=a/o;if(s<0){var h=(1-Math.abs(c))*(l>=0?1:-1),u=(1-Math.abs(l))*(c>=0?1:-1);l=h,c=u}l=Math.round(4095*(.5*l+.5)),c=Math.round(4095*(.5*c+.5)),i[3*r]=Math.floor(l/16),i[3*r+1]=l%16*16+Math.floor(c/256),i[3*r+2]=c%256}return i}function ae(t,i){var r=t.length/3,n=new Uint16Array(3*r),a=new e.Vector3(Math.max(i.max.x-i.min.x,1e-6),Math.max(i.max.y-i.min.y,1e-6),Math.max(i.max.z-i.min.z,1e-6));a.multiplyScalar(1/65535);var s=(new e.Vector3).copy(i.min);s.x/=a.x,s.y/=a.y,s.z/=a.z,s.x=Math.floor(s.x),s.y=Math.floor(s.y),s.z=Math.floor(s.z);for(var o=function(e,t,i){return Math.max(Math.min(e,i),t)},l=0;l<r;l++){var c=Math.round(t[3*l]/a.x)-s.x,h=Math.round(t[3*l+1]/a.y)-s.y,u=Math.round(t[3*l+2]/a.z)-s.z;n[3*l]=o(c,0,65535),n[3*l+1]=o(h,0,65535),n[3*l+2]=o(u,0,65535)}return n}function se(e){for(var t=0,i=0;i<e.getPrimitivesCount();i++){e.getPrimitiveGroup(i).glType>=4&&(t+=e.getPrimitiveCount(i)/3)}return t}function oe(e,t){l.makeEmpty();for(var i=0;i<e.getPrimitivesCount();i++)for(var r=e.getPrimitiveCount(i),n=e.getPrimitiveStart(i),a=0;a<r;a++)t.getVertexPosition(t.vertexIndexArray[n+a],c),l.expandByPoint(c);return l.getBoundingSphere()}function le(t,r){var s,o,l={indexBuffer:null,vertexBuffers:[],drawingGroups:[],normalCompression:g?"OCT_24":"NONE",positionCompression:v?"BBOX_QUANTIZATION_16_16_16":"NONE"};C&&(s={},o=[]);var c=t.boundingSphere;c&&(l.boundingSphere={center:[c.center.x,c.center.y,c.center.z],radius:c.radius});var h=null;v&&(t.boundingBox||t.computeBoundingBox(),(h=t.boundingBox.clone())&&(l.boundingBox={min:[h.min.x,h.min.y,h.min.z],max:[h.max.x,h.max.y,h.max.z]}));for(var u=0,d=0;d<n.length;d++){var f=n[d],m=t[f],S="vertexIndexArray"===f,_="vertexNormalArray"===f;m&&("vertexPositionArray"===f&&v&&(m=ae(m,h)),_&&g&&(m=ne(m)),S?l.indexBuffer=ie(m,r):(l.vertexBuffers.push(re(m,r)),u+=a[f]))}l.vertexLayout=function(e,t){var i=O.vertexLayouts[e];if(null==i){i=O.vertexLayouts[e]=t.vertexLayouts.length;var r=[],n=1;if(0!=(e&n)){var a=v?"UNSIGNED_SHORT":"FLOAT";r[r.length]=[{attribute:"POSITION",format:a,dimension:3}]}0!=(e&(n<<=1))&&(a=g?"UNSIGNED_BYTE":"FLOAT",r[r.length]=[{attribute:"NORMAL",format:a,dimension:3}]),0!=(e&(n<<=1))&&(r[r.length]=[{attribute:"TEX_COORD_0",format:"FLOAT",dimension:3}]),0!=(e&(n<<=1))&&(r[r.length]=[{attribute:"TEX_COORD_1",format:"FLOAT",dimension:3}]),0!=(e&(n<<=1))&&(r[r.length]=[{attribute:"COLOR",format:"FLOAT",dimension:4}]),0!=(e&(n<<=1))&&(r[r.length]=[{attribute:"TANGENT",format:"FLOAT",dimension:3}]),0!=(e&(n<<=1))&&(r[r.length]=[{attribute:"BINORMAL",format:"FLOAT",dimension:3}]),t.vertexLayouts[i]=r}return i}(u,r);for(d=0;d<t.drawingGroups.length;d++){var b=t.drawingGroups[d];if((1!==b.glType||x)&&(0!==b.glType||M)){y&&hasLayers&&(b.__id__=d);var D=i.GeomTypeString[b._geomType],w={start:b.start,count:b.count,mode:p[b.glType],geometricType:D||"UNKNOWN"},E=[],T=-1,A=0;if(P||C){var I;P&&(I=new Uint32Array(4*b.getPrimitivesCount()));for(var N=0;N<b.getPrimitivesCount();N++){var F=b.getPrimitiveRep(N),V=b.getPrimitiveStart(N),U=b.getPrimitiveCount(N),B=b.getPrimitiveCgmId(N);if(C&&F){var k=R.get(F);if(!k){var G=oe(F,t),z=se(F);k={uid:L,cgmId:F.cgmId,solid:F.solid,sag:F.sag,bsphere:G,nbTriangles:z},R.set(F,k),L++}s[k.uid]||(s[k.uid]=o.length,o.push(k)),T<0&&(T=s[k.uid])}P?(I[4*N]=B,I[4*N+1]=k?s[k.uid]:F?F.cgmId:0,I[4*N+2]=V,I[4*N+3]=U):s[k.uid]!==T?(E.push({index:T,count:A}),T=s[k.uid],A=U):A+=U}if(P)w.primitives=re(I,r);else{E.push({index:T,count:A});for(var H=new Uint32Array(2*E.length),W=0;W<E.length;W++)H[2*W]=E[W].index,H[2*W+1]=E[W].count;w.repRanges=re(H,r)}}if(l.drawingGroups.push(w),b.material instanceof e.Material){var j=O.materials[b.material.id];if(!j){var X=$(b.material,r);j={index:r.materials.length,item:X},r.materials.push(X),O.materials[b.material.id]=j}w.material=j.index}if(b.gas){var q=O.materials[b.gas.id];if(!q){X=$(b.gas,r);q={index:r.materials.length,item:X},r.materials.push(X),O.materials[b.gas.id]=q}w.graphicAttributes=q.index}}}if(C&&o){var Z=4*o.length,Y=9*o.length,K=new Uint8Array(4*Y),J=new Uint32Array(K.buffer,0),Q=new Float32Array(K.buffer,4*Z);for(W=0;W<o.length;W++){var ee=o[W];J[4*W]=ee.uid,J[4*W+1]=ee.cgmId,J[4*W+2]=ee.solid,J[4*W+3]=ee.nbTriangles,Q[5*W]=ee.bsphere.center.x,Q[5*W+1]=ee.bsphere.center.y,Q[5*W+2]=ee.bsphere.center.z,Q[5*W+3]=ee.bsphere.radius,Q[5*W+4]=ee.sag}l.reps=re(K,r)}return l}b.traverse(function(e,t){var i=O.nodes[e.id];if(!i){var r=e.getNodeType();if(i={type:r},e._matrix&&!e._matrix.isIdentity()){var n=[];e._matrix.flattenToArray(n),i.matrix=n}if(e.material&&e.material.force){if(!(f=O.materials[e.material.id])){var a=$(e.material,t);f={index:t.materials.length,item:a},t.materials.push(a),O.materials[e.material.id]=f}i.material=f.index}if(O.nodes[e.id]={index:t.nodes.length,item:i},null===t.root&&(t.root=t.nodes.length),t.nodes.push(i),"Node3D"===r){for(var s=[],o=0;o<e.children.length;o++)s.push(e.children[o].id);i.children=s}else if("LODNode3D"===r){var l,c=[];for(o=0;o<e._representations.length;o++){for(l=[],M=0;M<e._representations[o].length;M++)l.push(e._representations[o][M].id);c.push(l)}i.representations=c,(d=e._boundingSphere)&&(i.boundingSphere={center:[d.center.x,d.center.y,d.center.z],radius:d.radius}),(h=e._boundingBox)&&(i.boundingBox={min:[h.min.x,h.min.y,h.min.z],max:[h.max.x,h.max.y,h.max.z]}),i.lodSelector=e._lodSelector&&e._lodSelector.createJSON()}else if("URLNode3D"===r)i.url=e.url,(d=e._boundingSphere)&&(i.boundingSphere={center:[d.center.x,d.center.y,d.center.z],radius:d.radius});else if("LDHNode3D"===r)i.url=e.url,(d=e._boundingSphere)&&(i.boundingSphere={center:[d.center.x,d.center.y,d.center.z],radius:d.radius}),i.lodSelector=e._lodSelector&&e._lodSelector.createJSON();else if(e._occurrences[0]&&e._occurrences[0].renderable){var h,u=e._occurrences[0].renderable,d=u.boundingSphere;(h=u.boundingBox)||(h=d.getBoundingBox());var p=!1;if(y)for(o=0;o<e._occurrences.length;o++)if(e._occurrences[o].renderable.layer){p=!0;break}var f,m=[];for(o=0;o<u.geometry.length;o++){var g=u.geometry[o].id,v=O.geometries[g];if(!v){var S=le(u.geometry[o],t);v={index:t.geometries.length,item:S},t.geometries.push(S),O.geometries[g]=v}m.push(v.index)}if(i.boundingSphere={center:[d.center.x,d.center.y,d.center.z],radius:d.radius},i.boundingBox={min:[h.min.x,h.min.y,h.min.z],max:[h.max.x,h.max.y,h.max.z]},i.geometries=m,y&&p)for(i.occurrences={},o=0;o<e._occurrences.length;o++){var _=e._occurrences[o].renderable;if(_.layer){var x=[];i.occurrences[o]={index:o,layers:x};for(var M=0;M<_.layer.layers.length;M++){var P=_.layer.layers[M],C={start:P.drawableInterval.start,count:P.drawableInterval.count,primitiveStart:P.drawableInterval.primitiveStart,primitiveCount:P.drawableInterval.primitiveCount,layerNum:P.drawableInterval.layerNum};P.drawableInterval.material&&(C.material=P.drawableInterval.material.id,(f=t.materials[C.material])||(f=P.drawableInterval.material,t.materials[C.material]=$(f,t))),x.push({geometry:P.geometry.id,drawableGroup:P.drawableGroup.__id__,drawableInterval:C})}}}if(!e.material&&u.material&&u.material.force)(f=O.materials[u.material.id])||(a=$(u.material,t),f={index:t.materials.length,item:a},t.materials.push(a),O.materials[u.material.id]=f),i.material=f.index}else i.type="Node3D";D&&D(e,i)}},N,!1,!0);for(var ce=0;ce<N.nodes.length;ce++){var he,ue=[];if("LODNode3D"===(b=N.nodes[ce]).type)for(var de=0;de<b.representations.length;de++)ue.push(b.representations[de]);else b.children&&"URLNode3D"!==b.type&&ue.push(b.children);for(he=0;he<ue.length;he++){var pe=ue[he];for(de=0;de<pe.length;de++)pe[de]=O.nodes[pe[de]].index}}E&&(T=E),!A&&T&&(G.chunks=j(N),f?W(G,function(){T(G)}):m?H(G,function(){T(G)}):T(G))}}}),define("DS/Visualization/PrimitiveIterator",["UWA/Class","DS/Mesh/MeshUtils","DS/Visualization/Mesh3D","DS/Visualization/PathElement"],function(e,t,i,r){"use strict";var n={},a=e.extend({init:function(e,t){if(t===n){var a=e;if(this._primitives=null,this._sgRep=null,this._sgPrimitive=null,e instanceof r&&(a=e.getLastElement()),a instanceof i)this._primitives=a.getPrimitives();else if(a.sgNode)switch(a.sgNode.getType?a.sgNode.getType():a.sgNode.type){case 2:this._sgRep=a.sgNode;break;case 3:this._sgPrimitive=a.sgNode;break;default:console.log("PrimitiveIterator: unsupported SubElement type")}}},getNbPrimitives:function(){if(this._primitives)return this._primitives.length;if(this._sgPrimitive)return 1;if(this._sgRep)return this._sgRep.getPrimitivesCount();throw new Error("Internal error")},getConnectivityType:function(e){return this._getSGNode(e).getGroup().glType},getLength:function(e){return this._getSGNode(e).getCount()},getOffset:function(e){return this._getSGNode(e).getStart()},getIndexArray:function(e){return this._getSGNode(e).getGroup().geometry.vertexIndexArray},getPositionArray:function(e){return this._getSGNode(e).getGroup().geometry.vertexPositionArray},getNormalArray:function(e){return this._getSGNode(e).getGroup().geometry.vertexNormalArray},getMaterial:function(e){return this._getSGNode(e).getGroup().material},getGas:function(e){return this._getSGNode(e).getGroup().gas},getGeomType:function(e){var i=this._getSGNode(e);return t.GeomTypeString[i.getGroup()._geomType]},_getSGNode:function(e){if(this._primitives)return this._primitives[e].sgNode;if(this._sgPrimitive&&0===e)return this._sgPrimitive;if(this._sgRep){var i=new t.SGPrimitiveHelper;return i.set(this._sgRep,e),i}}});return a.POINTS=0,a.LINES=1,a.LINE_LOOP=2,a.LINE_STRIP=3,a.TRIANGLES=4,a.TRIANGLE_STRIP=5,a.TRIANGLE_FAN=6,a._authorizedTeamsOnly_getKey=function(){return n},a}),define("DS/VisuIdentification/Converter",["UWA/Class","DS/Visualization/PathElement","DS/VisuIdentification/Node","DS/Visualization/Mesh3D","DS/Visualization/SubElement"],function(e,t,i,r,n){"use strict";var a=null,s=e.extend({init:function(){return a||(a=this,this)},buildGlobalId:function(e){for(var t="",r="",n=null,a=null,s=null,o=!1,l=!0,c=!0,h=e.getLength()-1;h>=0;h--){var u=e.getElement(h).getModelIdentification();u&&(n=u.getSpace(),o=u.getSharability(),r=u.computeId(),(s=u.getContext())&&n&&s===a&&(c=!0),c&&(l||(r+=i.atomicDelimiter),l=!1,t=r+=t),(c=o)||(a=n))}return t},decodeGlobalId:function(e,r,a){var s=r.split(i.atomicDelimiter),o=new t,l=null,c=e;o.addElement(c);for(var h=0;h<s.length;h++){var u=s[h],d=this.findNodeByIdentifier(c,u,a);if(d)if(d instanceof n)o.addElement(d);else{for(var p=d,f=[];d!==c;)if(l=d.getParents(),f.push(d),d=l[0],l.length>1){if(-1===l.indexOf(c))return console.warn("Impossible to create a PathElement from the identifier."),null;d=c}for(var m=f.length-1;m>=0;m--)o.addElement(f[m]);c=p}}return o},findNodeByIdentifier:function(e,t,n){var a=t.split(i.delimiter),s=a[0],o=a[1];if(e instanceof r)return e.getPrimitive(parseInt(o),n);var l={node:null};return e.traverse(function(e,t){var i=e.getModelIdentification(),r=i?i.getLocalId():null,n=i?i.getContext():null;return r==o&&n===s&&(t.node=e,!0)},l),l.node}});return UWA.namespace("THREEDS/Identification/Converter",s)}),define("DS/Visualization/CompareModelsServices",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Effects/CompareModelsEffect","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/GraphicAttributeSet"],function(e,t,i,r,n,a,s){"use strict";var o=e.extend({init:function(e){return this.viewer=e,this._oldMatInherit=!1,this.compareEffect=null,this.effectID=-1,this._tmpNodes=[],this._occurrences=[],this},startCompare:function(e){this._oldMatInherit=this.viewer.renderer.renderer.newMaterialInheritance,this.viewer.renderer.renderer.newMaterialInheritance=!0;for(var r=new t.Color(e.first.color),n=new t.Color(e.second.color),a=new t.Color(e.common.color),o=new s({colorRGB:r,colorA:e.first.opacity}),l=new s({colorRGB:n,colorA:e.second.opacity}),c=new s({colorRGB:a,colorA:e.common.opacity}),h=e.first.pathElements,u=e.second.pathElements,d=[],p=[],f=0;f<h.length;f++){var m=this._createTemporaryNode(h[f]);d.push(m)}for(f=0;f<u.length;f++){m=this._createTemporaryNode(u[f]);p.push(m)}for(f=0;f<d.length;f++)d[f].setVisibility(!1);for(f=0;f<p.length;f++)p[f].setVisibility(!1);for(f=0;f<h.length;f++)this._applyColorsAndPasses(0,h[f],d[f],o,c);for(f=0;f<u.length;f++)this._applyColorsAndPasses(1,u[f],p[f],l);if(!this.compareEffect){var g=new i(this.viewer.renderer.renderer,this.viewer.renderer.renderTargetPool);this.effectID=this.viewer.renderer.addCustomEffect(g),this.compareEffect=this.viewer.renderer.getCustomEffect(this.effectID)}this.compareEffect.set2DMode(e.compareMode&&"2D"===e.compareMode),this.viewer.renderer.setCustomEffect(this.effectID,!0)},stopCompare:function(){this.viewer.renderer.setCustomEffect(this.effectID,!1),this._cleanTemporaryNodes(),this.viewer.renderer.renderer.newMaterialInheritance=this._oldMatInherit},_createTemporaryNode:function(e){var t=e.externalPath[e.externalPath.length-2],i=new r;return this._tmpNodes.push(i),t.addChild(i),i.addChild(e.getLastElement()),i},_hideOccurrences:function(e){for(var t=0;t<e._occurrences.length;t++){e._occurrences[t].setVisibility(!1)}},_applyColorsAndPasses:function(e,t,i,r,n){var s=t.externalPath.slice();s.splice(t.externalPath.length-1,0,i);for(var o=new a(s),l=t._getOccurrences(this.viewer),c=o._getOccurrences(this.viewer),h=0;h<l.length;h++){var u=l[h];this._updateGASOccurrence(u,r)}for(h=0;h<c.length;h++){(u=c[h])._relativeVisibility=2,1===e?this._updateRenderPassesOccurrence(u,["compareNew"]):(this._updateRenderPassesOccurrence(u,["compareOld"]),this._updateGASOccurrence(u,n))}},_cleanTemporaryNodes:function(){for(var e=0;e<this._occurrences.length;e++){var t=this._occurrences[e];this._resetOccurrence(t)}this._occurrences=[];for(e=0;e<this._tmpNodes.length;e++){var i=this._tmpNodes[e];i.removeChildren();for(var r=0;r<i.parents.length;r++)i.parents[r].removeChild(i)}this._tmpNodes=[]},_updateGASOccurrence:function(e,t){this._occurrences.push(e),e.forceGAS=t,e.gas=t,e.node._updateOccurrences(e.parent,e,!1)},_updateRenderPassesOccurrence:function(e,t){this._occurrences.push(e),e.forcePasses=t,e.node._updateOccurrences(e.parent,e,!1)},_resetOccurrence:function(e){e.forceGAS=null,e.gas=null,e.forcePasses=null,e._relativeVisibility=null,e.traverse(function(e){e._relativeVisibility=null});for(var t=0;t<e.children.length;t++){var i=e.children[t];i.node._updateOccurrences(e,i,!1)}}});return UWA.namespace("THREEDS/CompareModelsServices",o)}),define("DS/SceneGraphNodes/BillBoardNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],function(e,t,i){"use strict";var r,n,a,s,o,l,c,h=new e.Projector,u=new e.Vector3,d=new e.Matrix4,p=new e.Matrix4,f=new e.Matrix4,m=e.__visibleInCurrentSpace,g=t.extend({init:function(t){this._parent(t.name),this._isDynamic=!0,this.BillBoardType=t.type,this.constraintAxis=null,t.constraintAxis&&(this.constraintAxis=t.constraintAxis.clone()),t.attachedPoint&&(this.attachedPoint=t.attachedPoint.clone());var i=this,r=e.NoOccurrences;return this.cbChange=function(e){var t;if(!r)if(i.isInstance())for(var n=0;n<i._occurrences.length;n++){var a=(h=i._occurrences[n]).parent;if(h.scene3js){var s=h.scene3js.viewer;if(m(h._getVisible(),h._getVisibilityFree(),s.getVisibleSpace(),null,h)){if(e&&e.viewpoint&&e.viewpoint.viewer&&s!==e.viewpoint.viewer)continue;var o=s.currentViewpoint;t=i._getDynamicMatrix(a.matrix,e,o),h.matrix.multiplyMatrices(a.matrix,t);for(var l=0;l<h.children.length;l++)i._updateOccurrences(h,h.children[l],!0)}}}else{var c=i.parents[0];if(c){var h;if(!(h=c._occurrences[0]).scene3js)return;s=h.scene3js.viewer;if(m(h._getVisible(),h._getVisibilityFree(),s.getVisibleSpace(),null,h)){if(e&&e.viewpoint&&e.viewpoint.viewer&&s!==e.viewpoint.viewer)return;o=s.currentViewpoint;t=i._getDynamicMatrix(c.getMatrixWorld(),e,o),i.setMatrix(t)}}}},this.tokenChange=null,this},isPointOfViewDependant:function(){return!0},_onLinkedToSceneGraph:function(){var e=this;this.tokenChange=i.subscribe({event:"/VISU/"},function(t){"@onViewpointChange"===t.eventType&&e.cbChange(t)})},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenChange)},setBillboardType:function(e){this.BillBoardType=e,this.cbChange()},getNodeType:function(){return"BillBoardNode3D"},_getDynamicMatrix:function(e,t,i){e||(d.identity(),e=d);var r=(i||t.viewpoint).camera,n=r.getLookAt();return n.add(r.position),f.identity(),f.extractRotation(e),"Spherical"===this.BillBoardType?(p.identity(),p.lookAt(r.position,n,r.up)):this._ComputeCylindricalTransform(r,r.position,n,e,"PseudoSpherical"===this.BillBoardType),d.getInverse(f),f.multiplyMatrices(d,p),this._matrix&&f.setPosition(u.getPositionFromMatrix(this._matrix)),f},_ComputeCylindricalTransform:(r=new e.Vector3,n=new e.Vector3,a=new e.Vector3,s=new e.Vector3,o=new e.Vector3,l=new e.Vector3,c=new e.Vector3,function(e,t,i,u,d){if(this.constraintAxis?n.copy(this.constraintAxis).transformDirection(u).normalize():n.set(u.elements[8],u.elements[9],u.elements[10]).normalize(),d){c.getPositionFromMatrix(u),r.subVectors(c,t),l.addVectors(c,n);var f=c.clone();h.projectVector(f,e),h.projectVector(l,e),l.z=f.z,h.unprojectVector(l,e),l.sub(c),l.normalize(),n.copy(l)}else r.subVectors(i,t);if(r.normalize(),a.crossVectors(r,n),a.lengthSq()<1e-10){var m=Math.abs(r.z)<.999?o.set(0,0,1):o.set(1,0,0);a.crossVectors(m,r)}return a.normalize(),s.crossVectors(n,a),s.normalize(),p.set(a.x,s.x,n.x,0,a.y,s.y,n.y,0,a.z,s.z,n.z,0,0,0,0,1),p}),setConstraintAxis:function(e){this.constraintAxis=e}});return UWA.namespace("THREEDS/Nodes/BillBoard",g)}),define("SceneGraphNodes/BillBoardNode3D",["DS/SceneGraphNodes/BillBoardNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/BillBoardNode3D"),e}),define("DS/Visualization/LightNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i,r){this._parent(i),this.light3js=void 0!==t?t:new e.AmbientLight,t=this.createRenderable(),this._matrix=(new e.Matrix4).setPosition(new e.Vector3(0,0,1)),this._intensity=t.intensity,this._color=t.color,this._attachedToVpt=!!r;var n=this._occurrences[0];return n.renderable=t,n.renderable.name=this.name,n.renderable._occurrence=n,this},createRenderable:function(){var e=this.light3js.clone();return e.matrixAutoUpdate=!1,e.visible=this.light3js.visible,e.matrixWorldNeedsUpdate=!1,e.castShadow=this.light3js.castShadow,e.shadowCameraLeft=this.light3js.shadowCameraLeft,e.shadowCameraRight=this.light3js.shadowCameraRight,e.shadowCameraTop=this.light3js.shadowCameraTop,e.shadowCameraBottom=this.light3js.shadowCameraBottom,e.shadowCameraNear=this.light3js.shadowCameraNear,e.shadowCameraFar=this.light3js.shadowCameraFar,e.shadowBias=this.light3js.shadowBias,e.shadowDarkness=this.light3js.shadowDarkness,e.shadowMapWidth=this.light3js.shadowMapWidth,e.shadowMapHeight=this.light3js.shadowMapHeight,e.shadowCameraVisible=this.light3js.shadowCameraVisible,e},add:function(){return!1},updateShadowMap:function(e){var t,i;for(void 0===e&&(e=!0),null!==this.light3js&&(this.light3js.updateShadowMap=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.updateShadowMap=e)},attachToViewpoint:function(e){this._attachedToVpt=e},setIntensity:function(e){this._intensity=void 0===e?1:e,this._updateIntensity()},_updateIntensity:function(){var e,t;for(this.light3js.intensity=this._intensity,e=this._occurrences.length,t=0;t<e;t++)this._occurrences[t].renderable.intensity=this._intensity},setColor:function(t){t instanceof e.Color?this._color=t:this._color=new e.Color(hex),this._updateColor()},_updateColor:function(){var e,t;for(this.light3js.color=this._color,e=this._occurrences.length,t=0;t<e;t++)this._occurrences[t].renderable.color=this._color},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"LightNode3D"}});return UWA.namespace("THREEDS/Nodes/Light",i)}),define("Visualization/LightNode3D",["DS/Visualization/LightNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/LightNode3D"),e}),define("DS/SceneGraphNodes/FixedSizeNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],function(e,t,i){"use strict";var r=new e.Vector3,n=new e.Matrix4,a=new e.Matrix4,s=e.__visibleInCurrentSpace,o=t.extend({init:function(t){var i;arguments.length>1?(console.error("[WARNING] DEPRECATED FixedSizeNode3D construction: "+(new Error).stack),i={name:arguments[0],ratio:arguments[1],cameraName:arguments[3]}):i=t||{},this._parent(i.name),this.cameraName=i.cameraName||"camera",this._isDynamic=!0,this._autoUpdate=!0,this.invariantPoint=i.invariantPoint||null,this.ratio=i.ratio,this.scaleFactor=1,this.scaleFactorPerOcc=[];var r=this,n=e.NoOccurrences;return this.cbChange=function(e){if(!n)if(r.isInstance())for(var t=0;t<r._occurrences.length;t++){var i=(h=r._occurrences[t]).parent;if(h.scene3js&&i){var a=h.scene3js.viewer;if(s(h._getVisible(),h._getVisibilityFree(),a.getVisibleSpace(),null,h)){if(e&&e.viewpoint&&e.viewpoint.viewer&&a!==e.viewpoint.viewer)continue;var o=a.currentViewpoint,l=r._getDynamicMatrix(i.matrix,e,o,t);h.matrix.multiplyMatrices(i.matrix,l);for(var c=0;c<h.children.length;c++)r._updateOccurrences(h,h.children[c],!0,!0)}}}else{var h,u=r.parents[0];if(!u)return;if(!(h=this._occurrences[0]).scene3js)return;a=h.scene3js.viewer;if(s(h._getVisible(),h._getVisibilityFree(),a.getVisibleSpace(),null,h)){if(e&&e.viewpoint&&e.viewpoint.viewer&&a!==e.viewpoint.viewer)return;o=a.currentViewpoint,l=r._getDynamicMatrix(u.getMatrixWorld(),e,o,0);r.setMatrix(l,!0)}}},this.tokenChange=null,this},setRatio:function(e){e!==this.ratio&&this._invalidateBoundingElements(),this.ratio=e,this.cbChange()},getRatio:function(){return this.ratio},setInvariantPoint:function(e){this.invariantPoint=e,this.cbChange()},getInvariantPoint:function(){return this.invariantPoint},getScaleFactor:function(e){return e>=0?this.scaleFactorPerOcc[e]:this.scaleFactor},isPointOfViewDependant:function(){return!0},_onLinkedToSceneGraph:function(){this.tokenChange=i.subscribe({event:"/VISU/"},e=>{this._autoUpdate&&"@onViewpointChange"===e.eventType&&this.cbChange(e)})},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenChange)},_getDynamicMatrix:function(e,t,i,s){e||(n.identity(),e=n);var o=i||t.viewpoint,l=o[this.cameraName];this._matrix?a.multiplyMatrices(e,this._matrix):a.copy(e);var c=a.getMaxScaleOnAxis();this.invariantPoint?r.copy(this.invariantPoint):r.getPositionFromMatrix(a);var h=c/l.getWorldSizeFromPixelSize(1,r,o.viewer._getDivClientHeight())/this.ratio,u=0!==h?1/h:1;return u||(u=1),l.fullWidth&&(u*=l.height/l.fullHeight),n.makeScale(u,u,u),this.scaleFactor=(this._matrix?this._matrix.getMaxScaleOnAxis():1)*u,this.scaleFactorPerOcc[s||0]=this.scaleFactor,this._matrix?(a.multiplyMatrices(this._matrix,n),a):n},setCameraName:function(e){this.cameraName=e||"camera"}});return UWA.namespace("THREEDS/Nodes/FixedSizeNode3D",o)}),define("SceneGraphNodes/FixedSizeNode3D",["DS/SceneGraphNodes/FixedSizeNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/FixedSizeNode3D"),e}),define("DS/Visualization/EditableMesh3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement"],function(e,t,i,r){"use strict";var n=t.extend({init:function(e,t){return this._parent(e,t),this},clone:function(){var t=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);return this.mesh3js.copyInstancingInfos(t),new THREEDS.Nodes.EditableMesh(t,this.name)},getNodeType:function(){return"Mesh3D"},isEditable:function(){return!0},getBuffer:function(e,t){var i=t||this.mesh3js.geometry[0],r=this._getDataArray(e);return r?i[r]:null},getIndexBuffer:function(e){var t=e||this.mesh3js.geometry[0];return this._getIndexArray(t)},updateIndexBuffer:function(e,t,i){this._clearGSSOCache(),(i||this.mesh3js.geometry[0]).markIndexStale(e,e+t)},updateBuffer:function(e,t,i,r){this._clearGSSOCache();var n=r||this.mesh3js.geometry[0],a=this._getDataArray(e);n.markAttributeStale({vertexPositionArray:"position",vertexNormalArray:"normal",vertexUvArray:"uv",vertexUv2Array:"uv2",vertexTangentArray:"tangent",vertexBinormalArray:"binormal",vertexColorArray:"color",vertexLineDistancesArray:"lineDistance",vertexPatternStartEndArray:"patternStartEnd",vertexPreviousPositionArray:"previousPos",vertexNextPositionArray:"followingPos",vertexSideExtrusionArray:"sideExtrusion",vertexSkinIndexArray:"skinIndex",vertexSkinWeightArray:"skinWeight"}[a],t,t+i),n.vertexBufferGPU&&(n.vertexBufferGPU.needsUpdate=!0),n.wideLinesLinker&&n.wideLinesLinker.linkedGeometry.vertexBufferGPU&&(n.wideLinesLinker.linkedGeometry.vertexBufferGPU.needsUpdate=!0)},addBuffer:function(e,t,r){this._clearGSSOCache();var n=r||this.mesh3js.geometry[0],a=this._getDataArray(e);if(!(a?n[a]:null))switch(n.needsUpdate=!0,e){case i.VertexComponentEnum.POSITION:n.vertexPositionArray=t;break;case i.VertexComponentEnum.NORMAL:n.vertexNormalArray=t;break;case i.VertexComponentEnum.DIFFUSE_COLOR:n.vertexColorArray=t;break;case i.VertexComponentEnum.TEX_COORD_0:n.vertexUvArray=t;break;case i.VertexComponentEnum.TEX_COORD_1:n.vertexUv2Array=t;break;case i.VertexComponentEnum.TEX_COORD_2:n.vertexTangentArray=t;break;case i.VertexComponentEnum.TEX_COORD_3:n.vertexBinormalArray=t}},removeBuffer:function(e,t){this._clearGSSOCache();var r=t||this.mesh3js.geometry[0],n=this._getDataArray(e);if(n?r[n]:null)switch(r.needsUpdate=!0,e){case i.VertexComponentEnum.POSITION:r.vertexPositionArray=null;break;case i.VertexComponentEnum.NORMAL:r.vertexNormalArray=null;break;case i.VertexComponentEnum.DIFFUSE_COLOR:r.vertexColorArray=null;break;case i.VertexComponentEnum.TEX_COORD_0:r.vertexUvArray=null;break;case i.VertexComponentEnum.TEX_COORD_1:r.vertexUv2Array=null;break;case i.VertexComponentEnum.TEX_COORD_2:r.vertexTangentArray=null;break;case i.VertexComponentEnum.TEX_COORD_3:r.vertexBinormalArray=null}},_getIndexArray:function(e){return e.vertexIndexArray},_getDataArray:function(e){switch(e){case i.VertexComponentEnum.POSITION:return"vertexPositionArray";case i.VertexComponentEnum.NORMAL:return"vertexNormalArray";case i.VertexComponentEnum.DIFFUSE_COLOR:return"vertexColorArray";case i.VertexComponentEnum.TEX_COORD_0:return"vertexUvArray";case i.VertexComponentEnum.TEX_COORD_1:return"vertexUv2Array";case i.VertexComponentEnum.TEX_COORD_2:return"vertexTangentArray";case i.VertexComponentEnum.TEX_COORD_3:return"vertexBinormalArray"}return null},_clearGSSOCache:function(){var e,t=null;for(e=0;e<this._occurrences.length;e++)(t=this._occurrences[e].renderable)&&(t._flagAsGSSOInvalidated(),t.outlinesGeometry&&(t.outlinesGeometry.upToDate=!1))}});return UWA.namespace("THREEDS/Nodes/EditableMesh",n)}),define("Visualization/EditableMesh3D",["DS/Visualization/EditableMesh3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/EditableMesh3D"),e}),define("DS/SceneGraphNodes/CanvasNodeTexture",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils"],function(e,t,i,r){"use strict";var n=["map","transparent","alphaTest","force","canvasNodeTextureSize","canvasNodeTextureSaveParams"],a=!0,s=t.extend({init:function(e){this.width=e.width,this.height=e.height,this.longestEdge=this.width>=this.height?"width":"height",this.maxZoom=e.maxZoom||null,this.maxPow=this.maxZoom?Math.floor(Math.log(this.maxZoom)/Math.log(2)):null,this.drawCB=e.drawCB,this.rectangleTexture=e.rectangleTexture||!1,this.viewer=e.webGLV6Viewer,this.alphaTest=e.alphaTest,this.depthWrite=e.depthWrite,this.tick=0,this.materials={},this.lastTexture=null,this._canvas2DTexture=null,this._canvas2DCanvas=null,this.setMaterialParams(e.materialParams)},setMaterialParams:function(e){var t;for(t in this.materialParams=e||{},this.materials)this._updateMaterialWithParams(this.materials[t].material,this.materialParams)},requestRedraw:function(){this._requestRedraw()},_updateMaterialWithParams:function(e,t){var i;if(e.canvasNodeTextureSaveParams)for(i in e.canvasNodeTextureSaveParams)e[i]=e.canvasNodeTextureSaveParams[i];for(i in t)-1===n.indexOf(i)&&(e.canvasNodeTextureSaveParams||(e.canvasNodeTextureSaveParams={}),e.canvasNodeTextureSaveParams[i]=e[i],e[i]=t[i])},startAnimation:function(e,t){this.animationDeltaTime=e,this.tick=-1,this._animationStep(t)},_animationStep:function(e){this.tick++,this.requestRedraw(),e&&e.render(),setTimeout(this._animationStep.bind(this,e),this.animationDeltaTime)},_requestRedraw:function(){var e;for(e in this.materials)this.materials[e].redrawRequested=!0;this._canvas2DTexture&&(this._canvas2DTexture.redrawRequested=!0)},_getCanvas2DTexture:function(){if(!this._canvas2DTexture){var t=document.createElement("canvas");t.width=this.width,t.height=this.height,this._canvas2DTexture=new e.Texture(t,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter),this._canvas2DCanvas=t,this._redrawCanvas2DTexture()}return this._canvas2DTexture},_redrawCanvas2DTexture:function(){this._drawToCanvas(this._canvas2DCanvas,this.width,this.height),this._canvas2DTexture.needsUpdate=!0,this._canvas2DTexture.redrawRequested=!1},_buildMaterial:function(t,i,r,n){var a={};return a.canvas=document.createElement("canvas"),a.canvas.width=i,a.canvas.height=r,s.totalAllocatedTextures+=a.canvas.width*a.canvas.height,a.useCount=0,this._drawToCanvas(a.canvas,i,r),a.texture=new e.Texture(a.canvas,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearMipMapLinearFilter),a.texture.anisotropy=16,a.texture.needsUpdate=!0,n?(n.map=a.texture,e.cleanDeferredCache(n.id),n.updateDeferredMaterials(),a.material=n):a.material=new e.MeshBasicMaterial({transparent:!0,force:!0,map:a.texture}),void 0!==this.alphaTest&&(a.material.alphaTest=this.alphaTest),void 0!==this.depthWrite&&(a.material.depthWrite=this.depthWrite),a.material.canvasNodeTextureSize=t,this._updateMaterialWithParams(a.material,this.materialParams),a.redrawRequested=!1,a},_drawToCanvas:function(e,t,i){var r=e.getContext("2d");r.setTransform(1,0,0,1,0,0),r.clearRect(0,0,t,i),r.globalAlpha=1;var n=Math.max(t,i)/Math.max(this.width,this.height);r.scale(n,n);var a=null;this.viewer&&this.viewer.renderer&&this.viewer.renderer.renderer&&(a=this.viewer.renderer.renderer),this.drawCB(this,r,this.tick,n,a)},_getNewMaterial:function(e,t){var i=t&&t.canvasNodeTextureSize?t:null,r=e,n=11;null!==this.maxPow&&(n=this.maxPow);if(this.rectangleTexture&&(r=e/this[this.longestEdge],null===this.maxPow)){var o=Math.ceil(Math.log(this[this.longestEdge])/Math.log(2)+.01024);n=Math.max(0,n-o)}var l=Math.ceil(Math.log(r)/Math.log(2)+.01024);l=Math.min(l,n);var c=Math.pow(2,l),h=this.rectangleTexture?Math.floor(c*this.width):c,u=this.rectangleTexture?Math.floor(c*this.height):c;0!==h&&0!==u||(h=16,u=16);var d=i?this.materials[i.canvasNodeTextureSize]:null,p=d?d.canvas.width:0,f=d?d.canvas.height:0;!this.materials[c]&&s.totalAllocatedTextures+h*u-p*f>s.maxAllocatedTextures&&(a&&console.warn("CanvasNodeTexture: max amount of allowed texture allocation has been exceeded"),d?(c=i.canvasNodeTextureSize,h=d.canvas.width,u=d.canvas.height):(c=this.rectangleTexture?1:512,h=this.rectangleTexture?this.width:c,u=this.rectangleTexture?this.height:c));var m,g=this.materials[c];return i&&i.canvasNodeTextureSize===c||(i&&(m=this._releaseMaterial(i)),g||(this.materials[c]=this._buildMaterial(c,h,u,m),g=this.materials[c]),g.useCount++,m&&g.material!==m&&m.dispose()),g&&g.redrawRequested&&(this._drawToCanvas(g.canvas,h,u),g.texture.needsUpdate=!0,g.redrawRequested=!1),g?g.material:null},_releaseMaterial:function(e){if(e.canvasNodeTextureSize){var t=e?this.materials[e.canvasNodeTextureSize]:null;if(t)if(t.useCount--,t.useCount<=0)return s.totalAllocatedTextures-=t.canvas.width*t.canvas.height,(e=this.materials[e.canvasNodeTextureSize].material).map&&(e.map.dispose(),e.map=null),delete this.materials[e.canvasNodeTextureSize],e}return null}});return s.totalAllocatedTextures=0,s.maxAllocatedTextures=16777216,s.enableMemoryWarning=function(e){a=e},s}),define("DS/SceneGraphNodes/PointLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){t||(t={});var r=t.intensity;void 0===r&&(r=t.power?t.power/(4*Math.PI):1);var n=new e.PointLight(t.color,r,t.distance);return t.physicalAttenuation&&(n.isPhysicallyAttenuated=!0,n.attenuationScale=t.attenuationScale?t.attenuationScale:1e-6),this._parent(n,i,null),this},setPower:function(e){var t=e/(4*Math.PI);this.setIntensity(t)},setPhysicalAttenuation:function(e){this.light3js.isPhysicallyAttenuated=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.isPhysicallyAttenuated=e},setPhysicalAttenuationScale:function(e){this.light3js.attenuationScale=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.attenuationScale=e},castShadows:function(e,t){var i=this._occurrences.length;if(e){if(this.light3js.castShadow=!0,t){var r=!1;t.bias&&(this.light3js.shadowBias=t.bias),t.near&&(this.light3js.shadowCameraNear=t.near),t.far&&(this.light3js.shadowCameraFar=t.far),t.darkness&&(this.light3js.shadowDarkness=t.darkness),t.mapWidth&&(this.light3js.shadowMapWidth=t.mapWidth,r=!0),t.mapHeight&&(this.light3js.shadowMapHeight=t.mapHeight,r=!0),this.light3js.shadowMap&&r&&(this.light3js.shadowMap.dispose(),this.light3js.shadowMap=null,this.light3js.updateShadowMap=!0)}for(var n=0;n<i;n++){var a=this._occurrences[n].renderable;if(a.castShadow=!0,t){r=!1;t.bias&&(a.shadowBias=t.bias),t.near&&(a.shadowCameraNear=t.near),t.far&&(a.shadowCameraFar=t.far),t.darkness&&(a.shadowDarkness=t.darkness),t.mapWidth&&(a.shadowMapWidth=t.mapWidth,r=!0),t.mapHeight&&(a.shadowMapHeight=t.mapHeight,r=!0),a.shadowMap&&r&&(a.shadowMap.dispose(),a.shadowMap=null,a.updateShadowMap=!0)}}}else{this.light3js.castShadow=!1;for(n=0;n<i;n++)this._occurrences[n].renderable.castShadow=!1}},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"PointLightNode3D"}});return UWA.namespace("THREEDS/Nodes/PointLight",i)}),define("SceneGraphNodes/PointLightNode",["DS/SceneGraphNodes/PointLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/PointLightNode"),e}),define("DS/SceneGraphNodes/SpotLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var r,n;t||(t={}),r=void 0!==t.outerAngle&&null!==t.outerAngle?Math.max(Math.min(t.outerAngle,Math.PI),0):Math.PI/2,n=void 0!==t.innerAngle&&null!==t.innerAngle?Math.max(Math.min(t.innerAngle,r-.001),0):r-.001,this._outerAngle=r,this._innerAngle=n;var a=t.intensity;void 0===a&&(a=t.power?t.power/(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle)))):1);var s=new e.SpotLight(t.color,a,t.distance,r,n);return t.target?(s.target=new e.Object3D,s.target.position=t.target):s.target=null,this._previousTarget=s.target,t.physicalAttenuation&&(s.isPhysicallyAttenuated=!0,s.attenuationScale=t.attenuationScale?t.attenuationScale:1e-6),this._parent(s,i,null),this},attachToViewpoint:function(t){if(this._attachedToVpt!=t){var i=this._occurrences.length;if(t){this.light3js.target=new e.Object3D,this.light3js.target.position=new e.Vector3(0,0,0);for(r=0;r<i;r++)this._occurrences[r].renderable.target=new e.Object3D,this._occurrences[r].renderable.target.position=new e.Vector3(0,0,0)}else{this.light3js.target=this._previousTarget;for(var r=0;r<i;r++)this._occurrences[r].renderable.target=this._previousTarget}}this._attachedToVpt=t},setTarget:function(t){var i=null;t&&((i=new e.Object3D).position=t);if(this.light3js.target=i,this._previousTarget=i,!this._attachedToVpt)for(var r=this._occurrences.length,n=0;n<r;n++)this._occurrences[n].renderable.target=i},castShadows:function(e,t){var i=this._occurrences.length;if(e){if(this.light3js.castShadow=!0,this.light3js.shadowCameraFov=180*this.light3js.angle/Math.PI*2,t){var r=!1;t.bias&&(this.light3js.shadowBias=t.bias),t.near&&(this.light3js.shadowCameraNear=t.near),t.far&&(this.light3js.shadowCameraFar=t.far),t.darkness&&(this.light3js.shadowDarkness=t.darkness),t.mapWidth&&(this.light3js.shadowMapWidth=t.mapWidth,r=!0),t.mapHeight&&(this.light3js.shadowMapHeight=t.mapHeight,r=!0),this.light3js.shadowMap&&r&&(this.light3js.shadowMap.dispose(),this.light3js.shadowMap=null,this.light3js.updateShadowMap=!0)}for(var n=0;n<i;n++){var a=this._occurrences[n].renderable;if(a.castShadow=!0,a.shadowCameraFov=180*a.angle/Math.PI*2,t){r=!1;t.bias&&(a.shadowBias=t.bias),t.near&&(a.shadowCameraNear=t.near),t.far&&(a.shadowCameraFar=t.far),t.darkness&&(a.shadowDarkness=t.darkness),t.mapWidth&&(a.shadowMapWidth=t.mapWidth,r=!0),t.mapHeight&&(a.shadowMapHeight=t.mapHeight,r=!0),a.shadowMap&&r&&(a.shadowMap.dispose(),a.shadowMap=null,a.updateShadowMap=!0)}}}else{this.light3js.castShadow=!1;for(n=0;n<i;n++)this._occurrences[n].renderable.castShadow=!1}},setAngles:function(e,t,i){if(i)var r=this._intensity*(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle))));e=null!=e?Math.max(Math.min(e,Math.PI/2),0):Math.PI/2,t=null!=t?Math.max(Math.min(t,e-.001),0):e-.001,this._outerAngle=e,this._innerAngle=t,i&&this.setIntensity(r/(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle))))),this._updateAngles(),this.updateShadowMap()},_updateAngles:function(){var e,t;this.light3js.angle=this._outerAngle,this.light3js.innerAngle=this._innerAngle,e=this._occurrences.length;for(var i=0;i<e;i++)(t=this._occurrences[i]).renderable.angle=this._outerAngle,t.renderable.innerAngle=this._innerAngle},setPower:function(e){var t=e/(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle))));this.setIntensity(t)},setPhysicalAttenuation:function(e){this.light3js.isPhysicallyAttenuated=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.isPhysicallyAttenuated=e},setPhysicalAttenuationScale:function(e){this.light3js.attenuationScale=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.attenuationScale=e},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"SpotLightNode3D"}});return UWA.namespace("THREEDS/Nodes/SpotLight",i)}),define("SceneGraphNodes/SpotLightNode",["DS/SceneGraphNodes/PointLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/SpotLightNode"),e}),define("DS/SceneGraphNodes/CSS2DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";var i=t.extend({defaultOptions:{},init:function(t,i,r,n){var a=null,s=null,o=null,l=null;t.hasOwnProperty("html")?(a=t.html,s=t.position,o=t.name,l=t.offset):(console.warn("DEPRECATED : create your CSS2DNode with a litteral object"),a=t,s=i,o=r,l=n),s||(s=new e.Vector3),this._parent(o),this._element=a;var c=document.createElement("div");c.appendChild(a),c.style.display="none",c.ondragstart=function(){return!1},this.css2DNode=new e.CSS2DNode(c,s,l),this.hasExplicitBE=!0,this.explicitBSphere=new e.Sphere(new e.Vector3(0,0,0),1),this.explicitBBox=null,this.css2DNode.matrixAutoUpdate=!1,this.css2DNode.applyMatrix((new e.Matrix4).setPosition(s)),this._alwaysOnTopIndex=null;var h=this._occurrences[0];return h.renderable=this.css2DNode,h.renderable.name=this.name,h.renderable._occurrence=h,document.getElementById("divCss2DElement")&&document.getElementById("divCss2DElement").appendChild(this.css2DNode.element),this.setMatrix(this.css2DNode.matrix),this.rank=0,this.vanish=!1,this},setPickability:function(e){this.css2DNode.element.style.pointerEvents=e?"auto":"none"},getElement:function(){return this._element},add:function(){return!1},getNodeType:function(){return"CSS2DNode"},setOffset:function(t){t instanceof e.Vector2&&(this.css2DNode.offset=t.clone(),this._occurrences[0].node.css2DNode.offset=this.css2DNode.offset)},getOffset:function(){return this.css2DNode.offset},setAlwaysOnTopIndex:function(e){this._alwaysOnTopIndex=e},getAlwaysOnTopIndex:function(){return this._alwaysOnTopIndex},updatePosition:function(){var t=this._getViewer();if(t){var i=this.css2DNode,r=t.canvas,n=t.currentViewpoint.camera,a=new e.Vector3;if(a.copy(this.css2DNode.position),n.getLookAt().dot(n.position.clone().sub(a))<0){(new e.Projector).projectVector(a,n),i.element.style.display="block";var s=e.getDevicePixelRatio()||1,o=i.offset.x/s,l=i.offset.y/s;i.element.style.left=o+.5*(a.x+1)*r.clientWidth+"px",i.element.style.top=l-.5*(a.y-1)*r.clientHeight+"px"}else i.element.style.display="none"}},clone:function(){return new THREEDS.Nodes.CSS2DNode(this.css2DNode.element,this.css2DNode.position,this.name)}});return UWA.namespace("THREEDS/Nodes/CSS2DNode",i)}),define("SceneGraphNodes/CSS2DNode",["DS/SceneGraphNodes/CSS2DNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/CSS2DNode"),e}),define("DS/SceneGraphNodes/CanvasNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/SceneGraphNodes/CanvasNodeTexture"],function(e,t,i,r,n){"use strict";var a=t.extend({init:function(t,i){this._parent(t.name),this._isDynamic=!0,this.bottomLeftCorner=t.bottomLeftcorner,this.vectors={},this.vectors.width=t.widthVector,this.vectors.height=t.heightVector,this.canvasNodeTexture=t.canvasNodeTexture,this.requestTextureUpdate=!0;var n=t.side?t.side:e.FrontSide,a=t._noZPriority?t._noZPriority:-1;this.rectangle=function(t,i,n,a,s,o,l,c){var h,u,d,p,f,m,g,v,S,_,y,x,M,P,C;for(10,(h=new r.PrimitiveGroup).fillAttr=new r.FillAttributes,h.lineAttr=new r.LineAttributes,h.pointAttr=new r.PointAttributes,(u=new r.Buffer).size=12,u.component=r.VertexComponentEnum.POSITION,u.format=r.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(u.size),(d=new r.Buffer).size=3,d.component=r.VertexComponentEnum.NORMAL,d.format=r.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(d.size),(p=new r.Buffer).size=12,p.component=r.VertexComponentEnum.TEX_COORD_0,p.format=r.DataTypeEnum.FLOAT,p.dimension=3,p.data=new Float32Array(p.size),(f=new r.Buffer).indexBuffer=!0,f.size=4,f.format=r.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(f.size),(m=new r.Buffer).indexBuffer=!0,m.size=4,m.format=r.DataTypeEnum.UINT,m.dimension=1,m.data=new Uint16Array(m.size),(g=new r.Buffer).indexBuffer=!0,g.size=4,g.format=r.DataTypeEnum.UINT,g.dimension=1,g.data=new Uint16Array(g.size),h.addBuffer(0,u),h.addBuffer(1,d),h.addBuffer(2,f),h.addBuffer(3,m),h.addBuffer(4,p),h.addBuffer(5,g),C=f.data,M=0,C[M++]=0,C[M++]=1,C[M++]=3,C[M++]=2,C=m.data,M=0,P=0;P<1;P++)C[M++]=P,C[M++]=P,C[M++]=P,C[M++]=P;C=g.data,M=0,C[M++]=0,C[M++]=1,C[M++]=3,C[M++]=2,C=u.data,M=0,C[M++]=i.x,C[M++]=i.y,C[M++]=i.z,C[M++]=i.x+n.x,C[M++]=i.y+n.y,C[M++]=i.z+n.z,C[M++]=i.x+n.x+a.x,C[M++]=i.y+n.y+a.y,C[M++]=i.z+n.z+a.z,C[M++]=i.x+a.x,C[M++]=i.y+a.y,C[M++]=i.z+a.z,C=d.data,M=0;var b=(new e.Vector3).crossVectors(n,a).normalize();C[M++]=b.x,C[M++]=b.y,C[M++]=b.z;var D=s?1:a.length()/n.length();C=p.data,M=0,C[M++]=0,C[M++]=1-D,C[M++]=0,C[M++]=1,C[M++]=1-D,C[M++]=0,C[M++]=1,C[M++]=1,C[M++]=0,C[M++]=0,C[M++]=1,C[M++]=0;var w=o==e.DoubleSide?0:1;for(P=0;P<1;P++)(v=new r.Primitive).nbIndices=4,v.connectivity=r.ConnectivityTypeEnum.TRIANGLE_STRIP,v.attr={fill:new r.FillAttributes(new r.Color(1-P/6,0,P/6,1),w),line:new r.LineAttributes,point:new r.PointAttributes},(S=new r.VertexComponent).component=r.VertexComponentEnum.POSITION,S.nbVertices=4,S.nbValuesPerVertex=3,S.format=r.DataTypeEnum.FLOAT,S.cardinality=0,S.bufferId=0,S.indices=new r.IndexArray,S.indices.format=r.DataTypeEnum.UINT,S.indices.bufferId=2,S.indices.offset=4*P,(_=new r.VertexComponent).component=r.VertexComponentEnum.NORMAL,_.nbVertices=4,_.nbValuesPerVertex=3,_.format=r.DataTypeEnum.FLOAT,_.cardinality=0,_.bufferId=1,_.indices=new r.IndexArray,_.indices.format=r.DataTypeEnum.UINT,_.indices.bufferId=3,_.indices.offset=4*P,(y=new r.VertexComponent).component=r.VertexComponentEnum.TEX_COORD_0,y.nbVertices=4,y.nbValuesPerVertex=3,y.format=r.DataTypeEnum.FLOAT,y.cardinality=0,y.bufferId=4,y.indices=new r.IndexArray,y.indices.format=r.DataTypeEnum.UINT,y.indices.bufferId=5,y.indices.offset=0,v.addVertexComponent(S),v.addVertexComponent(_),v.addVertexComponent(y),h.addPrimitive(v);return(x=l.createMeshNode(h,t,void 0,void 0,c)).setShadow(!1),x}(null,this.bottomLeftCorner,this.vectors.width,this.vectors.height,t.canvasNodeTexture.rectangleTexture,n,i,a),this.rectangle.name=void 0!==t.name?t.name:"";var s=this;return this.rectangle._setBeforeRenderCB(function(e,t){s.requestTextureUpdate&&t.viewpoint&&s._textureUpdate(e,t.viewpoint,t.camera)}),this.rectangle.setSSAO(!1),this.rectangle.setMirror(!1),this.addChild(this.rectangle),this.cbChange=function(e){"@onViewpointChange"===e.eventType&&s._onViewpointChange()},this.tokenChange=null,this},setFrustumCulled:function(){this.rectangle.setFrustumCulled.apply(this.rectangle,arguments)},_onLinkedToSceneGraph:function(){this.tokenChange=i.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){var e;for(i.unsubscribe(this.tokenInit),i.unsubscribe(this.tokenChange),e=0;e<this.rectangle._occurrences.length;e++){var t=this.rectangle._occurrences[e].renderable;if(t.material){var r;if(this.canvasNodeTexture._releaseMaterial(t.material),t.material=null,t.highlightMeshes)for(r=0;r<t.highlightMeshes.length;r++)t.highlightMeshes[r].renderable.material=null;t.preHighlight&&(t.preHighlight.material=null)}}},_getDynamicMatrix:function(e,t,i){return this._onViewpointChange(),this.getMatrix()},_onViewpointChange:function(){this.requestTextureUpdate=!0},_textureUpdate:function(t,i,r){r.position;var n=this.bottomLeftCorner.clone(),a=this.vectors[this.canvasNodeTexture.longestEdge],s=new e.Vector3(n.x+a.x,n.y+a.y,n.z+a.z),o=t._getMMMatrix();n.applyMatrix4(o),s.applyMatrix4(o);var l=i.project(n,r),c=i.project(s,r),h=l.distanceTo(c),u=t.material,d=this.canvasNodeTexture._getNewMaterial(h,u);if(d){var p;if(t.material=d,t.highlightMeshes)for(p=0;p<t.highlightMeshes.length;p++)t.highlightMeshes[p].renderable.material=d;t.preHighlight&&(t.preHighlight.material=d),t._flagAsGSSOInvalidated()}}});return UWA.namespace("THREEDS/Nodes/CanvasNode",a)}),define("DS/Visualization/Selection",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Visualization/PathElement","DS/Selection/HSOManager","DS/Selection/PSOManager"],function(e,t,i,r,n,a,s,o,l,c){"use strict";function h(e,t,i){if(t(e,i),"bag"===e.getType())for(var r=e.getChildren(),n=0;n<r.length;n++)h(r[n],t,i)}function u(e){for(var t=0;t<e.externalPath.length;t++){var i=e.externalPath[t];if(i instanceof THREEDS.Nodes.CGRNode&&"3DSyncBatch"===i.productType)return i}return null}function d(e,t,i,s){var l,c=[],u=[];if(e.sgNode instanceof r.SGPrimitiveHelper){(m=s.children[1]instanceof a?s.children[1]:s.children[0]).mesh3js&&u.push({mesh:m.mesh3js,element:e})}else{var d=function(e){var t=new Map;return h(e,function(e,t){if("rep"===e.getType()){var i=e.getIdentificationObject?e.getIdentificationObject():null,r=i?i.getLocalId():0;r&&t.set(r,e)}},t),t}(e),p=t.getLastElement(!0),f=s.children[1]instanceof n?s.children[1]:s.children[0],m=s.children[1]instanceof a?s.children[1]:s.children[0],g=f.children,v=(l=f,p.traverse(function(e,t){return e===t.parent},{parent:l},!0));v&&(g=[p]);for(var S=0;S<g.length;S++){var _=g[S],y=_.persistentId;if(y)if(d.get(y)){var x=new o;x.externalPath=t.externalPath.slice(),v||(x.addElement(f),x.addElement(_));for(var M=x._getRenderableOccurrences(),P=0;P<M.length;P++){var C=M[P];i.scene.containsMesh(C)&&c.push(C)}d.delete(y)}}if(d.size>0){var b=new o;b.externalPath=t.externalPath.slice(),b.addElement(m);var D=b._getRenderableOccurrences();if(1===D.length){if(!i.scene.containsMesh(D[0]))return!1;var w=d[Symbol.iterator]();for(var E of w)u.push({mesh:D[0],element:E[1]})}}}return{meshes:c,sgNodes:u}}var p=0;return e.extend({init:function(e,t){this.id=p++,this.sceneGraph=e,this.eventType=t,this.sceneHL=new i.Scene,this.selectedMeshes=new Map,this.selectedMeshesFromPrim=new Map,this.selectedMeshesFromAdjacence=new Map,this.doubleSideHighlight=!0,this.matHL=null,this.node3DMap=new Map;var r={HSO:l,PSO:c};return this._xsoManager=r[this.eventType],this.toUnsubscribe=[],this._attachEvents(),this},_attachEvents:function(){this._detachEvents(!1,!1);var e=this,i=this._xsoManager;this.onSceneGraphUpdate=t.subscribe({event:"/VISU/onSceneGraphUpdate"},function(t){if(e.node3DMap.has(t.fromNode)){if("ADD"==t.eventType){var i=e.node3DMap.get(t.fromNode);e.addNodeToMap(t.toNode,e.node3DMap,i);for(var r=0;r<i.length;r++){var n=i[r].getLastElement(),a=t.toNode,s=[];e._getPaths(n,a,[],s);for(var l=0;l<s.length;l++){var c=new o(i[r].externalPath.slice());c.externalPath=c.externalPath.concat(s[l]),e._add(t.toNode,c)}}}"REMOVE"==t.eventType&&e.removeNodeToMap(t.toNode,e.node3DMap)}}),this.toUnsubscribe.push(i.onPostAdd(function(t){if(null!==t){var i=t.pathElement,r=!!t.forceVisibility;!i&&t.options&&(i=t.options.pathElement,r=!!t.options.forceVisibility),i&&(e.add(i,t.parameters,r),e.sceneGraph.viewer&&e.sceneGraph.viewer.render({onlyPostProcess:!0})),t instanceof Array&&(t.forEach(function(t){e.add(t.pathElement,t.parameters,!!t.forceVisibility)}),e.sceneGraph.viewer&&e.sceneGraph.viewer.render({onlyPostProcess:!0}))}})),this.toUnsubscribe.push(i.onPostRemove(function(t){if(null!==t){var i=t.pathElement;!i&&t.options&&(i=t.options.pathElement),i&&(e.remove(i,t.parameters),e.sceneGraph.viewer&&e.sceneGraph.viewer.render({onlyPostProcess:!0})),t instanceof Array&&(t.forEach(function(t){e.remove(t.pathElement,t.parameters)}),e.sceneGraph.viewer&&e.sceneGraph.viewer.render({onlyPostProcess:!0}))}})),this.toUnsubscribe.push(i.onEmpty(function(){e.sceneGraph.viewer&&e.sceneGraph.viewer.render({onlyPostProcess:!0})}))},_detachEvents:function(e,i){var r;for(r=0;r<this.toUnsubscribe.length;r++)this._xsoManager.unsubscribe(this.toUnsubscribe[r]);this.toUnsubscribe=[],e||(t.unsubscribe(this.onSceneGraphUpdate),this.onSceneGraphUpdate=null)},setDoubleSideHighlight:function(e){this.doubleSideHighlight=e},_getPaths:function(e,t,i,r){var n,a;if(t!=e){i.unshift(t);var s=t.parents;for(a=s.length,n=0;n<a;n++)this._getPaths(e,s[n],i,r);i.shift(t)}else r.push(i.slice(0))},addNodeToMap:function(e,t,i){e.traverse(function(e){var r;if(e instanceof n)if((r=t.get(e))&&r.length){var a,s,o,l,c=r.concat([]);for(a=0;a<i.length;a++){for(o=i[a],l=!0,c.indexOf(o)>=0&&(l=!1),s=0;s<c.length&&l;s++)c[s].hash()===o.hash()&&(l=!1);l&&c.push(o)}t.set(e,c)}else t.set(e,i)})},removeNodeToMap:function(e,t){e.traverse(function(e){e instanceof n&&t.delete(e)})},add:function(e,t,i){var r;if(null!=e){if(null===(r=e.getLastElement()))return!1;r instanceof n&&this.addNodeToMap(r,this.node3DMap,[e]),this._add(r,e,i)}return!0},_add:function(e,t,i){var a=null;if(THREEDS.Nodes.CGRNode&&(a=u(t))&&e instanceof THREEDS.Nodes.CGRNode){var o=s.getFromSGNode(e.internalSceneGraph);t.internalPath.push(o),e=o}var l=t._getRenderableOccurrences(this.sceneGraph.viewer),c=l.length;if(e instanceof n){if(c)for(var h=0;h<c;h++){var p=l[h];void 0!==t.instanceId&&p._instancingInfos&&(p._instancingInfos.pickedInstanceId=[t.instanceId]),this.sceneGraph.scene.containsMesh(p)&&this.addMesh(p,i)}}else if(a&&(e.sgNode instanceof r.SGRep||e.sgNode instanceof r.SGBag||c>1&&e.sgNode instanceof r.SGPrimitiveHelper)){var f=d(e,t,this.sceneGraph,a);for(h=0;h<f.meshes.length;h++)this.addMesh(f.meshes[h],i);for(h=0;h<f.sgNodes.length;h++)this.addPrimitive(f.sgNodes[h].mesh,f.sgNodes[h].element,i,!1)}else{if(1!==c)return!1;if(!this.sceneGraph.scene.containsMesh(l[0]))return!1;this.addPrimitive(l[0],e,i,!1)}},remove:function(e){var t;if(e){var i=e._getRenderableOccurrences(this.sceneGraph.viewer),a=i.length;if(null===(t=e.getLastElement()))return;var o=null;if(THREEDS.Nodes.CGRNode&&(o=u(e))&&t instanceof THREEDS.Nodes.CGRNode){var l=s.getFromSGNode(t.internalSceneGraph);e.internalPath.push(l),t=l}if(t instanceof n){if(this.node3DMap.has(t)&&this.removeNodeToMap(t,this.node3DMap),a)for(var c=0;c<a;c++){var h=i[c];void 0!==e.instanceId&&h._instancingInfos&&(h._instancingInfos.pickedInstanceId=[e.instanceId]),this.sceneGraph.scene.containsMesh(h)&&this.removeMesh(h)}}else if(o&&(t.sgNode instanceof r.SGRep||t.sgNode instanceof r.SGBag||a>1&&t.sgNode instanceof r.SGPrimitiveHelper)){var p=d(t,e,this.sceneGraph,o);for(c=0;c<p.meshes.length;c++)this.removeMesh(p.meshes[c]);for(c=0;c<p.sgNodes.length;c++)this.removePrimitive(p.sgNodes[c].mesh,p.sgNodes[c].element,!1)}else{if(1!==a)return!1;if(!this.sceneGraph.scene.containsMesh(i[0]))return!1;this.removePrimitive(i[0],t,!1)}}},addPrimitive:function(e,t,i,r){var n=null,a=r?this.selectedMeshesFromAdjacence:"rep"===t.getType()?this.selectedMeshes:this.selectedMeshesFromPrim;if(a.has(e)){var s=a.get(e);s.nbSelections++,s.hlMeshPrimScene||(s.hlMeshPrimScene=this.duplicateMeshForHighlight(e,!0,i,a===this.selectedMeshesFromPrim,a===this.selectedMeshesFromAdjacence),this.sceneHL.add(s.hlMeshPrimScene)),n=s.hlMeshPrimScene}else n=this.duplicateMeshForHighlight(e,!0,i,a===this.selectedMeshesFromPrim,a===this.selectedMeshesFromAdjacence),a.set(e,{hlMeshScene:null,hlMeshPrimScene:n,nbSelections:1}),this.sceneHL.add(n),e.addRefVBO(!1);if("rep"===t.getType()||"selectionGroup"===t.getType()){for(var o=!1,l=[],c=t.getChildren(),u=0;u<c.length;u++){var d=c[u];-1===n._findHLIndex(d.sgNode)?l.push(d):o=!0}if(o||"selectionGroup"===t.getType())for(u=0;u<l.length;u++)n.addHighLightPrimitive(l[u].sgNode);else n.addHighLightRep(t.sgNode)}else if("bag"===t.getType()){h(t,function(e,t){if("rep"===e.getType())for(var i=e.getChildren(),r=0;r<i.length;r++){var a=i[r];-1===n._findHLIndex(a.sgNode)&&t.push(a)}},c=[]);for(u=0;u<c.length;u++)n.addHighLightPrimitive(c[u].sgNode)}else if("primitive"===t.getType()){-1===n._findHLIndex(t.sgNode)&&n.addHighLightPrimitive(t.sgNode)}return n},addMesh:function(e,t){var i=null,r=e._occurrence,n=r&&r.isInCanvas2DPass()?["canvas2D"]:null;if(this.selectedMeshes.has(e)){var a=this.selectedMeshes.get(e);a.nbSelections++,a.hlMeshScene||(a.hlMeshScene=this.duplicateMeshForHighlight(e,!1,t,!1,!1),this.sceneHL.add(a.hlMeshScene,n)),i=a.hlMeshScene}else i=this.duplicateMeshForHighlight(e,!1,t,!1,!1),this.selectedMeshes.set(e,{hlMeshScene:i,hlMeshPrimScene:null,nbSelections:1}),this.sceneHL.add(i,n),e.addRefVBO(!1);if(i._instancingInfos&&"instance"===i._instancingInfos.instancingSelectionMode&&e._instancingInfos.pickedInstanceId.length){for(var s=!1,o=e._instancingInfos.pickedInstanceId[0],l=i._instancingInfos.pickedInstanceId,c=0;c<l.length;c++)if(l[c]==o){s=!0;break}s||(i._instancingInfos.pickedInstanceId.push(o),i._instancingInfos.nbInstances++,this.updateInstancedHighLightMesh(i,e))}return i},removeMesh:function(e){var t=null;if(e&&this.selectedMeshes.has(e)){var i=this.selectedMeshes.get(e);if(!(t=i.hlMeshScene))return null;if(i.nbSelections--,i.nbSelections){if(t._instancingInfos&&e._instancingInfos.pickedInstanceId.length){for(var r=-1,n=e._instancingInfos.pickedInstanceId[0],a=t._instancingInfos.pickedInstanceId,s=0;s<a.length;s++)if(a[s]==n){r=s;break}-1!=r&&(t._instancingInfos.pickedInstanceId.splice(r,1),t._instancingInfos.nbInstances--,this.updateInstancedHighLightMesh(t,e))}}else i.hlMeshScene=null,this.sceneHL.remove(t),i.hlMeshPrimScene||(this.selectedMeshes.delete(e),e.releaseVBO(!1),t=null)}return t},getHighlightMeshIndex:function(e){var t;if(e.highlightMeshes)for(t=0;t<e.highlightMeshes.length;t++)if(e.highlightMeshes[t].selectionId===this.id)return t;return-1},setHighlightMesh:function(e,t){if("highlight"===this.attr){!e.highlightMeshes&&t&&(e.highlightMeshes=[]);var i=this.getHighlightMeshIndex(e),r=i>=0?e.highlightMeshes[i]:null;r?t?r.renderable=t:e.highlightMeshes.length>1?e.highlightMeshes.splice(i,1):e.highlightMeshes=null:t&&e.highlightMeshes.push(new HighlightMeshData(this.id,t))}else e[this.attr]=t},removeMeshAndPrimitives:function(e){if(e){var t=this,i=function(i){if(i.has(e)){var r=i.get(e),n=r.hlMeshScene,a=r.hlMeshPrimScene;n&&t.sceneHL.remove(n),a&&t.sceneHL.remove(a),i.delete(e),e.releaseVBO(!1)}};i(this.selectedMeshesFromPrim),i(this.selectedMeshesFromAdjacence),i(this.selectedMeshes)}},removePrimitive:function(e,t,i){var r=null;if(e){var n=i?this.selectedMeshesFromAdjacence:"rep"===t.getType()?this.selectedMeshes:this.selectedMeshesFromPrim;if(n.has(e)){var a=n.get(e);if(!(r=a.hlMeshPrimScene))return null;if(a.nbSelections--,"rep"===t.getType())r.removeHighLightRep(t.sgNode);else if("selectionGroup"===t.getType())for(var s=t.getChildren(),o=0;o<s.length;o++)r.removeHighLightPrimitive(s[o].sgNode);else"primitive"===t.getType()&&r.removeHighLightPrimitive(t.sgNode);r.isMeshHiddenByLayer()&&(a.hlMeshPrimScene=null,this.sceneHL.remove(r)),a.nbSelections||a.hlMeshPrimScene||(n.delete(e),e.releaseVBO(!1),r=null)}}return r},updateHighlight:function(e){},_needsDepth:function(){return!1},duplicateMeshForHighlight:function(e,t,r,n,a){var s,o=e.material;if(e.isCurvedPipe?((s=new i.CurvedPipeMesh(e.geometry,o))._capWorldRadius=e._capWorldRadius,s._nbLODsMinusOne=e._nbLODsMinusOne,s.currentLOD=e.currentLOD,i.InstancedCurvedPipeManager.addHLCurvedPipe(s,e)):s=new i.Mesh(e.geometry,o),s.highLight={map:new Map,primitives:[],nbSelected:[]},s.matApp=e.matApp,s.gas=e.gas,s.materialMode=e.materialMode,s.occurrenceRenderingOverride=e.occurrenceRenderingOverride,s._occurrence=e._occurrence,s.matrixAutoUpdate=!1,s.visible=r||e.visible,s.visibilityFree=r||e.visibilityFree,s.fromLoadedModel=e.fromLoadedModel,s.receiveShadow=!1,s._programID=e._programID,s._vertexColors=e._vertexColors,s._skinning=e._skinning,s._skinningInstancing=e._skinningInstancing,a?s._programID|=i.ProgramIDs.ADJACENCE_HIGHLIGHT:n&&(s._programID|=i.ProgramIDs.PRIMITIVE_HIGHLIGHT),this._needsDepth()&&(s._programID|=i.ProgramIDs.POLITE_HIGHLIGHT),s._ratioData=e._ratioData,s._billboardData=e._billboardData,e.layer&&(s.layer=e.layer.clone(t)),s.frustumCulled=e.frustumCulled,s.setMatrix(e.matrix),e._instancingInfos&&e._instancingInfos.isInstanceNode3D){if(s._instancingInfos={isInstanceNode3D:!0,nbInstances:-1,instancingSelectionMode:e._instancingInfos.instancingSelectionMode,instanceAttribArrays:null,pickedInstanceId:[]},"instance"===e._instancingInfos.instancingSelectionMode){var l,c,h,u,d,p=e._instancingInfos.instanceAttribArrays;for(l in s._instancingInfos.nbInstances=1,s._instancingInfos.instanceAttribArrays={id:p.id},p)"id"!==l&&(u=p[l].itemSize,s._instancingInfos.instanceAttribArrays[l]={itemSize:u},16===(d=p[l].isMat4?16:u)&&(s._instancingInfos.instanceAttribArrays[l].isMat4=!0),h=(c=(e._instancingInfos.pickedInstanceId[0]/5-1)*d)+d,s._instancingInfos.instanceAttribArrays[l].array=p[l].array.subarray(c,h),s._instancingInfos.instanceAttribArrays[l].buffer=null);s._instancingInfos.pickedInstanceId.push(e._instancingInfos.pickedInstanceId[0])}else s._instancingInfos.nbInstances=e._instancingInfos.nbInstances,s._instancingInfos.instanceAttribArrays=e._instancingInfos.instanceAttribArrays;e._instancingInfos.pickedInstanceId=[]}return s},addNewInstanceToMesh:function(e,t,i){},updateInstancedHighLightMesh:function(e,t){var i,r,n,a,s,o,l,c=t._instancingInfos.instanceAttribArrays;for(i in e._instancingInfos.instanceAttribArrays={id:c.id},c)if("id"!==i){a=c[i].itemSize,e._instancingInfos.instanceAttribArrays[i]={itemSize:a},16===(s=c[i].isMat4?16:a)&&(e._instancingInfos.instanceAttribArrays[i].isMat4=!0),o=new Float32Array(e._instancingInfos.nbInstances*s),l=0;for(var h=0;h<e._instancingInfos.nbInstances;h++){n=(r=(e._instancingInfos.pickedInstanceId[h]/5-1)*s)+s;for(var u=r;u<n;u++)o[l++]=c[i].array[u]}e._instancingInfos.instanceAttribArrays[i].array=o,e._instancingInfos.instanceAttribArrays[i].buffer=null}},clearAll:function(){var e=this,t=function(t){t.forEach(function(t,i,r){var n=t.hlMeshScene,a=t.hlMeshPrimScene;n&&e.sceneHL.remove(n),a&&e.sceneHL.remove(a),i.releaseVBO(!1)}),t.clear()};t(this.selectedMeshes),t(this.selectedMeshesFromPrim),t(this.selectedMeshesFromAdjacence),this.node3DMap.clear()}})}),define("Visualization/Selection",["DS/Visualization/Selection","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Selection"),e}),define("DS/Visualization/AbstractHighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Selection"],function(e,t,i,r){"use strict";return r.extend({init:function(e,i){return this._parent(e,i),this.attr="",this.nodeMethod="",this.defaultSetting=null,this.highlightData=new t.HaloHighlightData,this.advanced=this.highlightData instanceof t.AdvancedPoliteHighlightData,this.sceneHL.highlightData=this.highlightData,this.onSelectionRemove=null,this.enabled=!0,this},getHighlightData:function(){this.advanced;var e=null;Object.assign(e,this.highlightData)},_detachEvents:function(t,i){i||(e.unsubscribe(this.onSelectionRemove),this.onSelectionRemove=null),this._parent(t,i)},enable:function(e){this.enabled=e},addMesh:function(e,i){if(e instanceof t.CSS2DNode)return e.element.classList.add("wux-css2dnode-highlighted"),null;if(!e||!e._occurrence)return null;var r=e._occurrence.node;if(r&&r[this.nodeMethod]())return null;var n=this._parent(e,i);return n&&this.setHighlightMesh(e,n),n},removeMesh:function(e){if(e instanceof t.CSS2DNode)return e.element.classList.remove("wux-css2dnode-highlighted"),null;var i=this._parent(e);this.setHighlightMesh(e,i)},addPrimitive:function(e,t,i){var r=this._parent(e,t,i);return r&&this.setHighlightMesh(e,r),r},removePrimitive:function(e,t){var i=this._parent(e,t);this.setHighlightMesh(e,i)},getColorHighlight:function(){return console.warn("Warning: deprecated, use getHighlightData instead"),this.highlightData},getHighlightData:function(){return this.highlightData},isEqualColor:function(e){return!!e&&this.highlightData.isEqual(e)},setColorHighlight:function(e){console.warn("Warning: deprecated, use setHighlightData instead"),this.setHighlightData(this.advanced,e)},setHighlightData:function(e,i){var r=0===this.highlightData.priority;if(e!==this.advanced&&(this.advanced=e,this.highlightData=e?new t.AdvancedPoliteHighlightData(this.defaultSetting.advancedpolite):new t.HaloHighlightData(this.defaultSetting.halo),this.sceneHL.highlightData=this.highlightData,this.sceneHL.__webglObjectsAll))for(var n=this.sceneHL.getAllWebGLObjects(0),a=0;a<n.length;a++){var s=n[a].object;e?s._programID|=t.ProgramIDs.POLITE_HIGHLIGHT:s._programID&=~t.ProgramIDs.POLITE_HIGHLIGHT,this.sceneHL.flagAsGSSOInvalidated(s)}i?this.highlightData._setData(i):this.highlightData._setData(this.advanced?this.defaultSetting.advancedpolite:this.defaultSetting.halo),r&&(this.highlightData.priority=0)},_needsDepth:function(){return this.advanced}})}),define("Visualization/AbstractHighlightSelection",["DS/Visualization/AbstractHighlightSelection","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/AbstractHighlightSelection"),e}),define("DS/Visualization/PreHighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/AbstractHighlightSelection"],function(e,t,i,r){"use strict";return r.extend({init:function(e){return this._parent(e,"PSO"),this.attr="preHighlight",this.linkToPSO=!0,this.nodeMethod="_getExcludeFromPreHL",this.defaultSetting=t.DefaultPreHighlightData,this.highlightData._setData(this.highlightData._needsDepth?this.defaultSetting.advancedpolite:this.defaultSetting.halo),this},_attachEvents:function(){this._parent();var t=this;this.onSelectionRemove=e.subscribe({event:"/VISU/SELECTION/REMOVE"},function(e){t.removeMeshAndPrimitives(e),e.preHighlight=null}),this.onCSIAddPreHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_PREHIGHLIGHT_ADD"},function(e){t.add(e.path,e.parameters)}),this.onCSIRemovePreHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_PREHIGHLIGHT_REMOVE"},function(e){t.remove(e.path,e.parameters)}),this.onCSIPreHighlightUpdate=e.subscribe({event:"/VISU/SELECTION/CSI_PREHIGHLIGHT_UPDATE"},function(e){t.__matches(e.parameters)&&t.setHighlightData(e.parameters.advanced,e.parameters.newColor)})},__matches:function(e){var t=this.sceneGraph.viewer;return!e||!e.viewer||e.viewer===t},remove:function(e,t){return!!this.__matches(t)&&this._parent(e)},add:function(e,t,i){return!!this.__matches(t)&&this._parent(e,t,i)},_detachEvents:function(t,i){i||(e.unsubscribe(this.onCSIAddPreHighlight),this.onCSIAddPreHighlight=null,e.unsubscribe(this.onCSIRemovePreHighlight),this.onCSIRemovePreHighlight=null,e.unsubscribe(this.onCSIPreHighlightUpdate),this.onCSIPreHighlightUpdate=null),this._parent(t,i)},detachToPSO:function(){this.linkToPSO&&(this.linkToPSO=!1,this._detachEvents(!0,!0))},attachToPSO:function(){this.linkToPSO||(this.linkToPSO=!0,this._attachEvents())}})}),define("Visualization/PreHighlightSelection",["DS/Visualization/PreHighlightSelection","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/PreHighlightSelection"),e}),define("DS/Visualization/HighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/AbstractHighlightSelection"],function(e,t,i,r){"use strict";return r.extend({init:function(e){return this._parent(e,"HSO"),this.attr="highlight",this.nodeMethod="_getExcludeFromHL",this.defaultSetting=t.DefaultHighlightData,this.isMultiColorSet=!1,this.linkToHSO=!0,this.passes=[],this.highlightData._setData(this.highlightData._needsDepth?this.defaultSetting.advancedpolite:this.defaultSetting.halo),this},_attachEvents:function(){this._parent();var t=this;this.onSelectionRemove=e.subscribe({event:"/VISU/SELECTION/REMOVE"},function(e){t.removeMeshAndPrimitives(e),t.setHighlightMesh(e,null)}),this.onCSIAddHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_HIGHLIGHT_ADD"},function(e){t.add(e.path,e.parameters)}),this.onCSIRemoveHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_HIGHLIGHT_REMOVE"},function(e){t.remove(e.path,e.parameters)}),this.onCSIHighlightUpdate=e.subscribe({event:"/VISU/SELECTION/CSI_HIGHLIGHT_UPDATE"},function(e){t.__matches(e.parameters)&&t.setHighlightData(e.parameters.advanced,e.parameters.newColor)})},_detachEvents:function(t,i){i||(e.unsubscribe(this.onCSIAddHighlight),this.onCSIAddHighlight=null,e.unsubscribe(this.onCSIRemoveHighlight),this.onCSIRemoveHighlight=null,e.unsubscribe(this.onCSIHighlightUpdate),this.onCSIHighlightUpdate=null),this._parent(t,i)},__matches:function(e){var t=this.sceneGraph.viewer;if(this.isMultiColorSet){if(e&&e.highlightColor&&this.highlightData.isEqual(e.highlightColor))return!e.viewer||e.viewer===t}else if(e&&!e.highlightColor||!e)return!e||!e.viewer||e.viewer===t;return!1},remove:function(e,t){return!!this.__matches(t)&&this._parent(e)},add:function(e,t,i){return!!this.__matches(t)&&this._parent(e,t,i)},clearAll:function(){this._parent()},detachToHSO:function(){this.linkToHSO&&(this.linkToHSO=!1,this._detachEvents(!0,!0))},attachToHSO:function(){this.linkToHSO||(this.linkToHSO=!0,this._attachEvents())},setMultiColorMode:function(e){this.isMultiColorSet=e}})}),define("Visualization/HighlightSelection",["DS/Visualization/HighlightSelection","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/HighlightSelection"),e}),define("DS/Visualization/InternalSceneGraph",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents"],function(e,t,i,r,n,a,s,o,l,c,h){"use strict";var u,d,p,f=t.__visibleInCurrentSpace,m=e.extend({init:function(e,r,n){this.parentSceneGraph=null,this.bShowReferenceAxisSystem=!0,this.lockShowReferenceAxisSystem=n,this.scene=new t.Scene,this.scene.matrixWorldNeedsUpdate=!1,this.viewer=e,this.drivesTheRobot=!1,this.viewpointAdded=!1,this.root=new i("",!0),this.root.setLinkedToSceneGraph(!0),this.root.setNotAllowedInPathElement(!0),this.userRoot=new i,this.userRoot.setLinkedToSceneGraph(!0),(r||window.userRootOutOfPathElements)&&this.userRoot.setNotAllowedInPathElement(!0),this.root.addChild(this.userRoot),this.viewer._svgMode&&(this.svgRoot=new i,this.svgRoot._isSVGRoot=!0,this.root.addChild(this.svgRoot),this.svgRoot._setIsAlwaysInForeground(!0)),this.robotRoot=new i,this.robotRoot.exludeFromBounding(!0),this.robotRoot._setVisibilityFree(!0),this.root.addChild(this.robotRoot),this.robotRoot._setIsAlwaysInForeground(!0),this._robot=null,this._customReferenceAxisSystem=null;var a=this;return this.root.subscribe("onready",function(){a.modelEvents.publish("onready")}),this.root3js=new t.Object3D,this.root3js.isRoot3ds=!0,this.root3js.viewer=e,this.root3js.matrixAutoUpdate=!1,this.root3js.matrixWorldNeedsUpdate=!1,this.root.setScene(this.root3js),this.root3js.node=this.root,this.scene.add(this.root3js),this.modelEvents=new h,this._needClippingUpdate=!1,this.selectionHL=new s(this),this.selectionHL.highlightData.priority=0,this.selectionPreHL=new o(this),this.selectionPreHL.highlightData.priority=0,this._subscribedEvents=[],this._onViewpointChangedEvent=null,this},onSelectViewpoint:function(){this.subscribeToOnViewpointChanged()},subscribeToOnViewpointChanged:function(){var e=this.viewer.currentViewpoint,t=this._onViewpointChangedEvent,i=!1;if(t){if(e===t.object)return;t.object.unsubscribe(t.token),this._onViewpointChangedEvent=null,i=!0}var r=this.viewer.currentViewpoint.onMove(this.onViewpointChange.bind(this));this._onViewpointChangedEvent={object:this.viewer.currentViewpoint,token:r},i&&this.onViewpointChange()},onAddViewpoint:function(){if(this.subscribeToOnViewpointChanged(),!this.viewpointAdded){var e=this.viewer.onViewerResize(this.onViewpointChange.bind(this));this._subscribedEvents.push({object:this.viewer,token:e})}this.viewpointAdded=!0,this.lockShowReferenceAxisSystem||this.showReferenceAxisSystem(this.bShowReferenceAxisSystem,!0)},onViewpointChange:function(){var e=this.viewer.currentViewpoint;e&&(e._updateRobotCamera(this),this._robot&&this._robot.onViewpointChange(),this.referenceAxisSystemNode&&this.referenceAxisSystemNode.onViewpointChange())},_detachXSOHLEvents:function(){this.selectionPreHL.detachToPSO(),this.selectionHL.detachToHSO()},_attachXSOHLEvents:function(){this.selectionPreHL.attachToPSO(),this.selectionHL.attachToHSO()},_detachEvents:function(){var e,t;for(this.selectionPreHL._detachEvents(!1,!1),this.selectionHL._detachEvents(!1,!1),e=0;e<this._subscribedEvents.length;e++)(t=this._subscribedEvents[e]).object.unsubscribe(t.token);this._subscribedEvents=[]},getChildByName:function(e){return this.root.getChildByName(e)},getMeshMin:function(e,i){var r,n,a,s,o,l=void 0!==i?i:"z",c=null,h=new t.Vector3;for(n=null,a=0,e.geometry.length>=0?(n=e.geometry[0],a=e.geometry.length):2===e.geometry._type&&(n=e.geometry,a=1),s=0;s<a;s++){if(null===n.vertexPositionArray){n=e.geometry[s+1];continue}r=e._getMMMatrix();const t=n.getVertexCount();for(o=0;o<t;o++)n.getVertexPosition(o,h),h.applyMatrix4(r),(h[l]<c||null===c)&&(c=h[l]);n=e.geometry[s+1]}return c},getSceneMin:function(e,i){if(!this.root3js)return 0;var r="z";if(i&&i.upVector.y>0&&(r="y"),e){if(this.root){var n=this.root.getBoundingBox("show");if(n)return n.min[r]}return 0}var a,s,o,l,c,h=this.root3js.children,u=null,d=null,p=new t.Vector3;for(a=0,s=h.length;a<s;a++)if(o=h[a],f(o.visible,o.visibilityFree,this.viewer.visibleSpace,o.layer,o._occurrence)&&o.frustumCulled&&o.geometry&&null!==o.geometry.boundingSphere&&o.geometry.boundingSphere.radius&&(o.geometry.length&&o.geometry[0].drawingGroups.length||o.isCurvedPipe)){var m=o._getMMMatrix();p.copy(o.geometry.boundingSphere.center),p.applyMatrix4(m),o._centerZ=p[r],l=m?m.getMaxScaleOnAxis():1,c=o._centerZ+o.geometry.boundingSphere.radius*l,(null===u||c<u)&&(u=c)}var g=[];for(a=0,s=h.length;a<s;a++){if(o=h[a],f(o.visible,o.visibilityFree,this.viewer.visibleSpace,o.layer,o._occurrence)&&o.frustumCulled&&o.geometry&&null!==o.geometry.boundingSphere&&o.geometry.boundingSphere.radius&&(o.geometry.length&&o.geometry[0].drawingGroups.length||o.isCurvedPipe))if(l=(m=o._getMMMatrix())?m.getMaxScaleOnAxis():1,o._centerZ-o.geometry.boundingSphere.radius*l<u)if(o.isCurvedPipe||o.geometry[0].vertexPositionArray){var v=o.getMin(r);(null===d||v<d)&&(d=v)}else g.push(o)}if(g.length){var S=this.viewer.renderer.boundingBoxGPUCompute.computeZMinGPU(this.viewer,g);d=null===d?S:Math.min(S,d)}return d},updateShaders:function(){this.viewer.renderer.recompileAllShaders(null)},getBoundingSphere:function(e,i){var r=this.root._occurrences[0]?this.root._occurrences[0].getBoundingSphere(e,!0):null;return i||r&&!(r.radius<=0&&r.pixelRadius<=0)||(r=new t.Sphere(new t.Vector3,100)),r},clearSelection:function(){this.selectionHL.clearAll(),this.selectionPreHL.clearAll()},addRobotNode:function(e){this.robotRoot.addChild(e)},addUserNode:function(e,t){t?this.userRoot.children[0].addChild(e):this.userRoot.addChild(e)},removeUserNode:function(e,t){t?this.userRoot.children[0].removeChild(e,!0):e instanceof i||!e?this.userRoot.removeChild(e,!0):this.userRoot.removeChild(e._private_root,!0)},setRobot:function(e,t,i,r){return e&&!r&&(this.lockShowReferenceAxisSystem=!1),t=t||{},this.drivesTheRobot=!0,this.createAxisSystem(),this._robot&&e&&(this.robotRoot.remove(this._robot,!0),this._robot._dispose(),this._robot=null,this.robot=null),this._robot||this.createRobot(i,t,u),e?this._robot.setHiddenMode(!1):this._robot.setHiddenMode(!0),r||(this.robot=e?this._robot:void 0),!0},getRobot:function(){return this.drivesTheRobot?this.robot:this.getChildByName("robot")},setCustomReferenceAxisSystem:function(e){this._customReferenceAxisSystem&&(this.robotRoot.removeChild(this._customReferenceAxisSystem),this._customReferenceAxisSystem._dispose(),this._customReferenceAxisSystem=null),e&&(this._customReferenceAxisSystem=new p(this.viewer,e),this._customReferenceAxisSystem.setRenderPasses(["robotOrtho"]),this.robotRoot.addChild(this._customReferenceAxisSystem),this._customReferenceAxisSystem.onViewpointChange())},clearScene:function(e,t,i){this.clearSelection();var r,n=this.userRoot.children.length;if("deprecated"===i)for(var a=this.userRoot.children[0];a.children.length;)a.remove(a.children[0]);else for(r=0;r<n;r++)this.userRoot.remove(this.userRoot.children[0])},getUserNodes:function(e){var t,i=[],r=this.getUserRoot(e);for(t=0;t<r.children.length;t++)i.push(r.children[t]);return i},getUserRoot:function(e){return e?this.userRoot.children[0]:this.userRoot},addDebugNode:function(e){this.debugRoot||(this.debugRoot=new i,this.debugRoot.excludeFromBounding=!0,this.root.addChild(this.debugRoot)),this.debugRoot.addChild(e)},removeDebugNode:function(e){this.debugRoot.removeChild(e)},showReferenceAxisSystem:function(e,t){t||(this.lockShowReferenceAxisSystem=!1),this.bShowReferenceAxisSystem=e,this.viewpointAdded&&(this.createAxisSystem(),this.updateReferenceAxisSystemVisibility())},createAxisSystem:function(){this.referenceAxisSystemNode||(this.referenceAxisSystemNode=new d("referenceAxisSystem",this.viewer),this.robotRoot.addChild(this.referenceAxisSystemNode),this.referenceAxisSystemNode.setCameraName("robotCameraOrtho"),this.referenceAxisSystemNode.setRenderPasses(["robotOrtho"]))},createRobot:function(e,t,i){this._robot=new i(this,"robot",e,t.snapOnFace,t.showOnlyManipulated,"I solemnly swear that I am up to no good.",t.touchMode);var r=e.getWorldOrientation();"zup"!==r._woName&&this._robot._setWorldOrientation(r),this.onViewpointChange(),this.updateReferenceAxisSystemVisibility()},updateReferenceAxisSystemVisibility:function(){this.referenceAxisSystemNode&&this.referenceAxisSystemNode._setEnabled(this.bShowReferenceAxisSystem)},setRobotAndRefAxisSystemEnabled:function(e){this._robot&&this._robot._setEnabled(e),this.referenceAxisSystemNode&&this.referenceAxisSystemNode._setEnabled(e)},dispose:function(){for(this._robot&&this._robot._dispose(),this.referenceAxisSystemNode&&this.referenceAxisSystemNode._dispose(),this._customReferenceAxisSystem&&this._customReferenceAxisSystem._dispose(),this._robot=null,this.robot=null,this.referenceAxisSystemNode=null,this._detachEvents(),this.clearScene();this.root.children.length;)this.root.removeChild(this.root.children[0]);var e;for(e in this.scene.dispose(),this.selectionHL=null,this.selectionPreHL=null,this)this[e]=null},setWorldOrientation:function(e){this._robot&&this._robot._setWorldOrientation(e)},forceHighlightVisibility:function(e){if(this.selectionHL&&this.selectionHL.sceneHL){var t=this.selectionHL.sceneHL.children;this.forceHLVisibility(t,e)}},forcePreHighlightVisibility:function(e){if(this.selectionPreHL&&this.selectionPreHL.sceneHL){var t=this.selectionPreHL.sceneHL.children;this.forceHLVisibility(t,e)}},forceHLVisibility:function(e,t){if(t)for(var i=0;i<e.length;i++){(r=e[i]).visible=!0,r.visibilityFree=!0}else for(i=0;i<e.length;i++){var r,n=(r=e[i])._occurrence;n&&n.renderable&&(r.visible=n.renderable.visible,r.visibilityFree=n.renderable.visibilityFree)}},updateStaticOverrides:function(){m._enableStaticOverrides&&(this.root.traverseUnique(function(e){var t=e._getStaticOverrideSet();null!==t&&t._deactivateStaticOverrides()}),this.root.traverseUnique(function(e){var t=e._getStaticOverrideSet();null!==t&&t.applyStaticOverrides()}),this.root.forceUpdate())}});return m.setRobotClasses=function(e,t,i){u=e,d=t,p=i},m._enableStaticOverrides=!0,UWA.namespace("THREEDS/InternalSceneGraph",m)}),define("Visualization/InternalSceneGraph",["DS/Visualization/InternalSceneGraph","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/InternalSceneGraph"),e}),define("DS/Visualization/ViewpointManager",["DS/Visualization/InternalSceneGraph"],function(e){"use strict";var t=function(e){this.viewer=e,this.vpList=[],this.attachedScenegraphs=new Map,this.viewports=new Map,this.manipulated=null,this.warnCount=0};return t.prototype.addViewpoint=function(t,i){if(t.control&&(t.isMain()&&null==this.manipulated?this.setManipulatedViewpoint(t):t.control.setActive(!1)),null!=this.manipulated&&this.manipulated.control&&this.manipulated.control.updateEditGesture(),this.vpList.push(t),!i){let i=new e(this.viewer,!0,!1);t._setInternalSceneGraph(i),this.attachedScenegraphs.set(t,i)}},t.prototype.clearNonCSIViewpoints=function(){for(let e=this.vpList.length-1;e>=0;e--){let t=this.vpList[e];null===t.getCsiUID()&&this.removeViewpoint(t)}},t.prototype.removeViewpoint=function(e){let t=this.vpList.indexOf(e);this.manipulated&&this.manipulated.camera.id==e.camera.id&&this.setManipulatedViewpoint(null),t>=0&&this.vpList.splice(t,1)},t.prototype.addMainViewpoint=function(e,t){e._isMain=!0,this.addViewpoint(e,t)},t.prototype.setManipulatedViewpoint=function(e){this.manipulated&&this.manipulated.control.setActive(!1),e?(e.control.setActive(!0),this.manipulated=e):this.manipulated=null},t.prototype.getManipulatedViewpoint=function(e){return this.manipulated},t.prototype.setViewpointViewport=function(e,t,i,r,n,a){this.viewports.set(e,{fixed:t,x:i,y:r,width:n,height:a}),this.resizeViewpoint(e)},t.prototype.getViewpointViewport=function(e){let t=this.viewports.get(e);if(t){if(t.fixed)return t;{let e=Math.round(t.x*this.viewer.SCREEN_WIDTH),i=Math.round(t.width*this.viewer.SCREEN_WIDTH);return{x:e,y:Math.round(t.y*this.viewer.SCREEN_HEIGHT),width:i,height:Math.round(t.height*this.viewer.SCREEN_HEIGHT)}}}return null},t.prototype.resizeViewpoint=function(e,t,i){let r=this.getViewpointViewport(e),n=t||this.viewer.SCREEN_WIDTH,a=i||this.viewer.SCREEN_HEIGHT;r&&(n=r.width,a=r.height),e.camera.aspect=n/a,e.camera.updateProjectionMatrix(),e.connectedRobotCamera.aspect=n/a,e.connectedRobotCamera.updateProjectionMatrix(),e.robotCameraOrtho.aspect=n/a,e.robotCameraOrtho.setVisualizedHeight(null,e.robotCameraOrtho.aspect),e.robotCameraOrtho.updateProjectionMatrix(),e.resize(n,a)},t.prototype.resize=function(e,t){if(this.isViewpointManagerOverridenBadly())this.resizeViewpoint(this.viewer.currentViewpoint,e,t);else for(let i=0;i<this.vpList.length;i++){let r=this.vpList[i];this.resizeViewpoint(r,e,t)}},t.prototype.getViewpointScenegraph=function(e){return this.attachedScenegraphs.get(e)},t.prototype.isViewpointManagerOverridenBadly=function(){let e=this.viewer.currentViewpoint;if(e){for(let t=0;t<this.vpList.length;t++)if(this.vpList[t]==e)return!1;return this.warnCount<10&&(console.warn("viewer.currentViewpoint wasn't properly processed, you have to go through AddViewpoint/SelectViewpoint api to replace currentViewpoint"),this.warnCount++),!0}return!1},t.prototype.getVpList=function(){return this.isViewpointManagerOverridenBadly()?[this.viewer.currentViewpoint]:this.vpList},t.prototype.addNodeToViewpoint=function(e,t){},t.prototype.getAuxiliaryScenegraphs=function(){let e=[];for(let t=0;t<this.vpList.length;t++)this.attachedScenegraphs.has(this.vpList[t])&&e.push(this.attachedScenegraphs.get(this.vpList[t]));return e},t.prototype.dispose=function(){for(let e=0;e<this.vpList.length;e++){let t=this.vpList[e],i=this.getViewpointScenegraph(t);t.dispose(),i&&i.dispose()}this.viewports=null,this.attachedScenegraphs=null,this.vpList=null},UWA.namespace("THREEDS/ViewpointManager",t)}),define("DS/Visualization/DecalNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){if(!e.DecalManager._creatingDecal)throw"Use Decal Manager to create decals";return this._parent(t,i),this.decalNode3DBooleanAttr=0,this._setHasExplicitUv(!1),this._decalAttachedTo=new Set,this.setVisibilityFree(!0),this.setMaterialMode(1),e.DecalManager.activated=!0,this},setExplicitUv:function(t){this._setHasExplicitUv(t);for(var i=this._getAllOwningViewers(),r=0;r<i.length;r++)e.DecalManager.updateDecalsData(i[r],!0)},isExplicitUv:function(){return this._getHasExplicitUv()},__shareAttachementFrom:function(e){this._decalAttachedTo=e},attachTo:function(e){return!e._isDecal&&(this._decalAttachedTo.add(e),this._updateMatrix(),!0)},getAttachedTo:function(){return Array.from(decalNode._decalAttachedTo)},applyOn:function(e){return e.addChild(this)},getAppliedOn:function(){return this.parents.slice()},applyAndAttach:function(e){return this.attachTo(e)&&this.applyOn(e)},unapply:function(e){if(!this.parents.length)return!1;if(e)return e.removeChild(this);for(var t=0;t<this.parents.length;t++)this.parents[t].removeChild(this);return!0},detach:function(e){return e?this._decalAttachedTo.delete(e):this._decalAttachedTo.clear(),this._updateMatrix(),!0},unapplyAndDetach:function(){return this.unapply(null)&&this.detach(null)},addChild:function(e){return!1},removeChild:function(e){return!1},setMaterialMode:function(i){e.DecalManager._creatingDecal&&t.prototype.setMaterialMode.call(this,i)},_propagateVisuFilters:function(e,t){},setVisuFilters:function(e){}});i.prototype._isDecal=!0;var r=1;return i.prototype._getHasExplicitUv=function(){return(this.decalNode3DBooleanAttr&r)>0},i.prototype._setHasExplicitUv=function(e){this.decalNode3DBooleanAttr=e?this.decalNode3DBooleanAttr|r:this.decalNode3DBooleanAttr&~r},UWA.namespace("THREEDS/Nodes/DecalNode3D",i)}),define("Visualization/DecalNode3D",["DS/Visualization/DecalNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/DecalNode3D"),e}),define("DS/SceneGraphNodes/DirectionalLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){t||(t={});var r=new e.DirectionalLight(t.color,t.intensity);return r._sceneShadow=null==t.sceneShadow||t.sceneShadow,t.target?(r.target=new e.Object3D,r.target.position=t.target,r._sceneShadow=!1):r.target=null,this._previousTarget=r.target,this._parent(r,i,null),this},castShadows:function(e,t){var i=this._occurrences.length;if(e){if(this.light3js.castShadow=!0,t){var r=!1,n=null!=t.sceneShadow?t.sceneShadow:this.light3js._sceneShadow;t.bias&&(this.light3js.shadowBias=t.bias),t.left&&(this.light3js.shadowCameraLeft=t.left,n=!1),t.right&&(this.light3js.shadowCameraRight=t.right,n=!1),t.bottom&&(this.light3js.shadowCameraBottom=t.bottom,n=!1),t.top&&(this.light3js.shadowCameraTop=t.top,n=!1),t.near&&(this.light3js.shadowCameraNear=t.near,n=!1),t.far&&(this.light3js.shadowCameraFar=t.far,n=!1),t.darkness&&(this.light3js.shadowDarkness=t.darkness),t.mapWidth&&(this.light3js.shadowMapWidth=t.mapWidth,r=!0),t.mapHeight&&(this.light3js.shadowMapHeight=t.mapHeight,r=!0),this.light3js._sceneShadow=n,this.light3js.shadowMap&&r&&(this.light3js.shadowMap.dispose(),this.light3js.shadowMap=null,this.light3js.updateShadowMap=!0)}for(var a=0;a<i;a++){var s=this._occurrences[a].renderable;if(s.castShadow=!0,t){r=!1;t.bias&&(s.shadowBias=t.bias),t.left&&(s.shadowCameraLeft=t.left),t.right&&(s.shadowCameraRight=t.right),t.bottom&&(s.shadowCameraBottom=t.bottom),t.top&&(s.shadowCameraTop=t.top),t.near&&(s.shadowCameraNear=t.near),t.far&&(s.shadowCameraFar=t.far),t.darkness&&(s.shadowDarkness=t.darkness),t.mapWidth&&(s.shadowMapWidth=t.mapWidth,r=!0),t.mapHeight&&(s.shadowMapHeight=t.mapHeight,r=!0),s._sceneShadow=this.light3js._sceneShadow,s.shadowMap&&r&&(s.shadowMap.dispose(),s.shadowMap=null,s.updateShadowMap=!0)}}}else{this.light3js.castShadow=!1;for(a=0;a<i;a++)this._occurrences[a].renderable.castShadow=!1}},attachToViewpoint:function(e){if(this._attachedToVpt!=e){var t=this._occurrences.length;if(e){this.light3js.target=null;for(i=0;i<t;i++)this._occurrences[i].renderable.target=null}else{this.light3js.target=this._previousTarget;for(var i=0;i<t;i++)this._occurrences[i].renderable.target=this._previousTarget}}this._attachedToVpt=e},setTarget:function(t){var i=null;t&&((i=new e.Object3D).position=t);if(this.light3js.target=i,this._previousTarget=i,!this._attachedToVpt)for(var r=this._occurrences.length,n=0;n<r;n++)this._occurrences[n].renderable.target=i},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"DirectionalLightNode3D"}});return UWA.namespace("THREEDS/Nodes/DirectionalLight",i)}),define("SceneGraphNodes/DirectionalLightNode",["DS/SceneGraphNodes/DirectionalLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/DirectionalLightNode"),e}),define("DS/SceneGraphNodes/Canvas2DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils"],function(e,t,i,r){"use strict";var n=t.extend({init:function(t,i){this._parent(t.name),this.hotspot=t.hotspot||new e.Vector2(0,0),this.canvasNodeTexture=t.canvasNodeTexture;var r=this.canvasNodeTexture._getCanvas2DTexture(),a=new e.MeshBasicMaterial({transparent:!0,side:e.DoubleSide,force:!0});this.canvas2DMaterial=a,a.activatePDSFX();var s={hotspot:{type:"v2",value:this.hotspot},pixelSize:{type:"v2",value:new e.Vector2(.005,.005)},size:{type:"v2",value:new e.Vector2(this.canvasNodeTexture.width,this.canvasNodeTexture.height)},canvas2DTexture:{type:"t2",value:r},highlight:{type:"b",value:!1,stage:e.FragmentStage},angle:{type:"f",value:t.angle||0},alphaTest:{type:"f",value:this.canvasNodeTexture.alphaTest||-1}};a.setPDSFXUniforms(s);a.setPDSFXVaryings({_uv:{type:"v2"},screenPosition:{type:"v2"}});var o={ProcessClipSpacePosition:["void ProcessClipSpacePosition(inout vec4 ioPosition) { ","  _uv = vGetAttribTexCoord0().xy;","  float dx, dy;","  dx = ioPosition.w * (pixelSize.x*(-hotspot.x + _uv.x*size.x));","  dy = ioPosition.w * (pixelSize.y*(-hotspot.y + _uv.y*size.y));;","  float ratio = pixelSize.x / pixelSize.y;","  ioPosition.x += cos(angle)*dx - sin(angle)*dy*ratio;","  ioPosition.y += sin(angle)*dx/ratio + cos(angle)*dy;","}"].join("\n")},l={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = texture2D(canvas2DTexture, _uv);","if (highlight) {","  float norm = length(ioFinalColor.xyz);","  ioFinalColor.xyz = (norm/1.73205)*vec3(0.0, 0.6, 1.0);","}","}"].join("\n"),ComputeDiscard:["bool ComputeDiscard() {","  vec4 color = texture2D(canvas2DTexture, _uv);","  return color.a <= alphaTest;","}"].join("\n"),ComputeViewNormal:"vec3 ComputeViewNormal() { return vec3(0.0,0.0,1.0); }"};a.setPDSFXOverridableFunctions(o,l),this.rectangle=n._createRectangle(a,i);this.rectangle._occurrences[0].renderable;a._refreshPDSFXUniforms_private=function(t,i){var r;if(!t._smallTargetPicking||t.materialToUse!==e.MaterialToUse.pickingMaterial&&t.materialToUse!==e.MaterialToUse.pickingMaterialInstancing&&t.materialToUse!==e.MaterialToUse.normalMaterial&&t.materialToUse!==e.MaterialToUse.depthMaterial)r=new e.Vector2(2/t.domElement.width,2/t.domElement.height);else{var n=2*t._gpuPickingTolerance+1;r=new e.Vector2(2/n,2/n)}this.updatePDSFXUniform("pixelSize",r)},this.rectangle.setFrustumCulled(!1),this.rectangle.setMirror(!1),this.rectangle.setShadow(!1,!1),this.addChild(this.rectangle),this.rectangle.setRenderPasses(["canvas2D"]),this.exludeFromBounding(!0);var c=this;return this.rectangle._setBeforeRenderCB(function(e,t){r.redrawRequested&&c.canvasNodeTexture._redrawCanvas2DTexture()}),this},excludeFromHighlight:function(e,t){this.rectangle.excludeFromHighlight(e,t)},setHotspot:function(e){e&&this.canvas2DMaterial.updatePDSFXUniform("hotspot",e.clone())},getHotspot:function(){return this.canvas2DMaterial.getPDSFXUniform("hotspot").value.clone()},setAngle:function(e){this.canvas2DMaterial.updatePDSFXUniform("angle",e)},getAngle:function(){return this.canvas2DMaterial.getPDSFXUniform("angle").value}});return n._createRectangle=function(e,t){var i,n,a,s,o,l,c,h,u,d,p,f,m,g,v;for(10,(i=new r.PrimitiveGroup).fillAttr=new r.FillAttributes,i.lineAttr=new r.LineAttributes,i.pointAttr=new r.PointAttributes,(n=new r.Buffer).size=12,n.component=r.VertexComponentEnum.POSITION,n.format=r.DataTypeEnum.FLOAT,n.dimension=3,n.data=new Float32Array(n.size),(a=new r.Buffer).size=3,a.component=r.VertexComponentEnum.NORMAL,a.format=r.DataTypeEnum.FLOAT,a.dimension=3,a.data=new Float32Array(a.size),(s=new r.Buffer).size=12,s.component=r.VertexComponentEnum.TEX_COORD_0,s.format=r.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(s.size),(o=new r.Buffer).indexBuffer=!0,o.size=4,o.format=r.DataTypeEnum.UINT,o.dimension=1,o.data=new Uint16Array(o.size),(l=new r.Buffer).indexBuffer=!0,l.size=4,l.format=r.DataTypeEnum.UINT,l.dimension=1,l.data=new Uint16Array(l.size),(c=new r.Buffer).indexBuffer=!0,c.size=4,c.format=r.DataTypeEnum.UINT,c.dimension=1,c.data=new Uint16Array(c.size),i.addBuffer(0,n),i.addBuffer(1,a),i.addBuffer(2,o),i.addBuffer(3,l),i.addBuffer(4,s),i.addBuffer(5,c),m=0,(v=o.data)[m++]=0,v[m++]=1,v[m++]=3,v[m++]=2,v=l.data,m=0,g=0;g<1;g++)v[m++]=g,v[m++]=g,v[m++]=g,v[m++]=g;for(m=0,(v=c.data)[m++]=0,v[m++]=1,v[m++]=3,v[m++]=2,v=n.data,m=0,m=0;m<12;m++)v[m]=0;for(m=0,(v=a.data)[m++]=0,v[m++]=0,v[m++]=1,m=0,(v=s.data)[m++]=0,v[m++]=0,v[m++]=0,v[m++]=1,v[m++]=0,v[m++]=0,v[m++]=1,v[m++]=1,v[m++]=0,v[m++]=0,v[m++]=1,v[m++]=0,g=0;g<1;g++)(h=new r.Primitive).nbIndices=4,h.connectivity=r.ConnectivityTypeEnum.TRIANGLE_STRIP,h.attr={fill:new r.FillAttributes(new r.Color(1-g/6,0,g/6,1),1),line:new r.LineAttributes,point:new r.PointAttributes},(u=new r.VertexComponent).component=r.VertexComponentEnum.POSITION,u.nbVertices=4,u.nbValuesPerVertex=3,u.format=r.DataTypeEnum.FLOAT,u.cardinality=0,u.bufferId=0,u.indices=new r.IndexArray,u.indices.format=r.DataTypeEnum.UINT,u.indices.bufferId=2,u.indices.offset=4*g,(d=new r.VertexComponent).component=r.VertexComponentEnum.NORMAL,d.nbVertices=4,d.nbValuesPerVertex=3,d.format=r.DataTypeEnum.FLOAT,d.cardinality=0,d.bufferId=1,d.indices=new r.IndexArray,d.indices.format=r.DataTypeEnum.UINT,d.indices.bufferId=3,d.indices.offset=4*g,(p=new r.VertexComponent).component=r.VertexComponentEnum.TEX_COORD_0,p.nbVertices=4,p.nbValuesPerVertex=3,p.format=r.DataTypeEnum.FLOAT,p.cardinality=0,p.bufferId=4,p.indices=new r.IndexArray,p.indices.format=r.DataTypeEnum.UINT,p.indices.bufferId=5,p.indices.offset=0,h.addVertexComponent(u),h.addVertexComponent(d),h.addVertexComponent(p),i.addPrimitive(h);return(f=t.createMeshNode(i,e)).setShadow(!1),f},UWA.namespace("THREEDS/Nodes/Canvas2DNode",n)}),define("DS/Visualization/TextNode",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/EditableMesh3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/GraphicAttributeSet","DS/Visualization/MaterialApplication"],function(e,t,i,r,n,a,s){"use strict";var o={},l={count:97,width:256,height:256,chars:{0:{yoffset:1.5,width:4,xadvance:0,y:238,x:223,height:4,xoffset:-1.5},13:{yoffset:1.5,width:4,xadvance:9.25,y:252,x:250,height:4,xoffset:-1.5},32:{yoffset:1.5,width:4,xadvance:9.25,y:252,x:246,height:4,xoffset:-1.5},33:{yoffset:27.063,width:12,xadvance:9.5,y:0,x:186,height:30,xoffset:-.688},34:{yoffset:27.063,width:15,xadvance:18,y:15,x:210,height:14,xoffset:3},35:{yoffset:26.438,width:24,xadvance:19.5,y:125,x:48,height:28,xoffset:-1.875},36:{yoffset:32.125,width:24,xadvance:19.938,y:65,x:24,height:40,xoffset:-1.625},37:{yoffset:27.938,width:30,xadvance:31.813,y:94,x:48,height:31,xoffset:1.5},38:{yoffset:24.75,width:36,xadvance:33.25,y:38,x:0,height:27,xoffset:-.25},39:{yoffset:27.063,width:8,xadvance:10.875,y:238,x:246,height:14,xoffset:3},40:{yoffset:33,width:16,xadvance:12,y:105,x:24,height:41,xoffset:-.5},41:{yoffset:33,width:16,xadvance:12,y:211,x:48,height:41,xoffset:-2.188},42:{yoffset:28.938,width:19,xadvance:16.375,y:238,x:227,height:18,xoffset:.438},43:{yoffset:20.688,width:19,xadvance:18.875,y:237,x:135,height:19,xoffset:.25},44:{yoffset:6.938,width:11,xadvance:9.5,y:15,x:225,height:15,xoffset:-2.25},45:{yoffset:14.938,width:15,xadvance:15.063,y:247,x:181,height:7,xoffset:.25},46:{yoffset:6.938,width:10,xadvance:9.5,y:243,x:92,height:10,xoffset:-.875},47:{yoffset:31.875,width:22,xadvance:19.25,y:94,x:135,height:38,xoffset:-1},48:{yoffset:26.875,width:22,xadvance:21.25,y:65,x:81,height:29,xoffset:.188},49:{yoffset:26.375,width:16,xadvance:15.75,y:0,x:74,height:28,xoffset:0},50:{yoffset:26.875,width:21,xadvance:19,y:65,x:190,height:29,xoffset:-1.438},51:{yoffset:26.813,width:22,xadvance:18.938,y:65,x:147,height:29,xoffset:-2.188},52:{yoffset:27.063,width:22,xadvance:20.188,y:65,x:125,height:29,xoffset:-.938},53:{yoffset:26.375,width:23,xadvance:19.688,y:182,x:48,height:29,xoffset:-1.688},54:{yoffset:26.813,width:21,xadvance:20.375,y:65,x:211,height:29,xoffset:.125},55:{yoffset:26.438,width:20,xadvance:16.875,y:65,x:232,height:29,xoffset:.188},56:{yoffset:26.813,width:22,xadvance:21.125,y:65,x:103,height:29,xoffset:-.688},57:{yoffset:26.813,width:21,xadvance:20.375,y:222,x:24,height:30,xoffset:.438},58:{yoffset:20.188,width:11,xadvance:9.5,y:185,x:243,height:23,xoffset:-.875},59:{yoffset:20.25,width:13,xadvance:9.5,y:0,x:173,height:29,xoffset:-2.25},60:{yoffset:22.563,width:20,xadvance:18.875,y:0,x:121,height:21,xoffset:.25},61:{yoffset:18.75,width:20,xadvance:18.875,y:0,x:210,height:15,xoffset:.688},62:{yoffset:22.563,width:20,xadvance:18.875,y:0,x:141,height:21,xoffset:-.563},63:{yoffset:27.625,width:19,xadvance:18.625,y:185,x:0,height:30,xoffset:.938},64:{yoffset:27.625,width:38,xadvance:37.75,y:0,x:0,height:38,xoffset:.188},65:{yoffset:27.125,width:26,xadvance:21.563,y:209,x:201,height:29,xoffset:-3.125},66:{yoffset:27.063,width:23,xadvance:22.875,y:123,x:233,height:29,xoffset:.188},67:{yoffset:27.625,width:24,xadvance:21.063,y:187,x:109,height:30,xoffset:.25},68:{yoffset:27.063,width:25,xadvance:24.188,y:123,x:183,height:29,xoffset:.188},69:{yoffset:27.063,width:22,xadvance:19.5,y:94,x:234,height:29,xoffset:.188},70:{yoffset:27.063,width:21,xadvance:18.188,y:65,x:169,height:29,xoffset:.188},71:{yoffset:27.625,width:25,xadvance:23.625,y:153,x:230,height:30,xoffset:.25},72:{yoffset:27.063,width:25,xadvance:24.625,y:94,x:184,height:29,xoffset:.188},73:{yoffset:27.063,width:12,xadvance:10.813,y:0,x:198,height:29,xoffset:.188},74:{yoffset:27.063,width:16,xadvance:11,y:215,x:0,height:35,xoffset:-3.75},75:{yoffset:27.063,width:26,xadvance:22.438,y:209,x:227,height:29,xoffset:.188},76:{yoffset:27.063,width:19,xadvance:18.563,y:0,x:38,height:29,xoffset:.188},77:{yoffset:27.063,width:31,xadvance:29.188,y:94,x:78,height:29,xoffset:-1.25},78:{yoffset:27.063,width:25,xadvance:24.75,y:123,x:208,height:29,xoffset:.188},79:{yoffset:27.625,width:26,xadvance:25.5,y:123,x:157,height:30,xoffset:.25},80:{yoffset:27.125,width:24,xadvance:21.875,y:123,x:78,height:29,xoffset:.188},81:{yoffset:27.625,width:26,xadvance:25.5,y:94,x:109,height:34,xoffset:.25},82:{yoffset:27.125,width:24,xadvance:22.375,y:217,x:109,height:29,xoffset:.188},83:{yoffset:27.625,width:24,xadvance:20.313,y:157,x:109,height:30,xoffset:-1.75},84:{yoffset:27.063,width:23,xadvance:19.375,y:153,x:48,height:29,xoffset:.125},85:{yoffset:27.063,width:25,xadvance:24.25,y:153,x:205,height:30,xoffset:.75},86:{yoffset:27.063,width:25,xadvance:21.625,y:94,x:209,height:29,xoffset:.438},87:{yoffset:27.125,width:33,xadvance:30.875,y:65,x:48,height:29,xoffset:.813},88:{yoffset:27.063,width:27,xadvance:21.063,y:94,x:157,height:29,xoffset:-3},89:{yoffset:27.063,width:25,xadvance:21,y:128,x:109,height:29,xoffset:.125},90:{yoffset:27.063,width:24,xadvance:19.438,y:152,x:78,height:29,xoffset:-2.125},91:{yoffset:31.813,width:17,xadvance:12,y:146,x:24,height:38,xoffset:-1.625},92:{yoffset:31.875,width:20,xadvance:19.375,y:209,x:181,height:38,xoffset:-.438},93:{yoffset:31.875,width:17,xadvance:12,y:184,x:24,height:38,xoffset:-1.938},94:{yoffset:32.688,width:22,xadvance:19.875,y:238,x:201,height:15,xoffset:.5},95:{yoffset:-.563,width:22,xadvance:19.25,y:248,x:157,height:7,xoffset:-3.313},96:{yoffset:31.875,width:14,xadvance:12.125,y:243,x:78,height:11,xoffset:-.438},97:{yoffset:21.625,width:22,xadvance:21.375,y:38,x:60,height:24,xoffset:-.375},98:{yoffset:29.438,width:22,xadvance:21.75,y:132,x:135,height:32,xoffset:-.125},99:{yoffset:21.625,width:20,xadvance:17.25,y:38,x:211,height:24,xoffset:-.375},100:{yoffset:29.438,width:24,xadvance:21.688,y:153,x:181,height:32,xoffset:-.375},101:{yoffset:21.625,width:21,xadvance:19.25,y:38,x:169,height:24,xoffset:-.375},102:{yoffset:29.5,width:24,xadvance:12.375,y:65,x:0,height:40,xoffset:-4.188},103:{yoffset:21.688,width:23,xadvance:21.625,y:216,x:157,height:32,xoffset:-1.125},104:{yoffset:29.438,width:22,xadvance:21.25,y:212,x:78,height:31,xoffset:-.25},105:{yoffset:30.938,width:13,xadvance:10,y:0,x:108,height:33,xoffset:-.375},106:{yoffset:30.938,width:17,xadvance:10,y:196,x:135,height:41,xoffset:-4.938},107:{yoffset:29.438,width:22,xadvance:20.813,y:181,x:78,height:31,xoffset:-.25},108:{yoffset:29.438,width:12,xadvance:10.438,y:0,x:161,height:32,xoffset:0},109:{yoffset:21.625,width:32,xadvance:31.375,y:185,x:181,height:24,xoffset:-.25},110:{yoffset:21.625,width:22,xadvance:21.25,y:38,x:104,height:24,xoffset:-.25},111:{yoffset:21.625,width:22,xadvance:21.313,y:38,x:82,height:24,xoffset:-.375},112:{yoffset:21.625,width:24,xadvance:21.75,y:153,x:157,height:32,xoffset:-1.375},113:{yoffset:21.625,width:22,xadvance:21.563,y:164,x:135,height:32,xoffset:-.375},114:{yoffset:21.625,width:18,xadvance:14.313,y:0,x:90,height:24,xoffset:-.25},115:{yoffset:21.563,width:20,xadvance:17.563,y:38,x:231,height:24,xoffset:-1.938},116:{yoffset:26,width:17,xadvance:13.75,y:0,x:57,height:29,xoffset:-.563},117:{yoffset:21.063,width:21,xadvance:21.063,y:38,x:148,height:24,xoffset:.313},118:{yoffset:21.125,width:22,xadvance:18.375,y:38,x:126,height:23,xoffset:-.375},119:{yoffset:21.125,width:30,xadvance:27.125,y:185,x:213,height:23,xoffset:0},120:{yoffset:21.063,width:24,xadvance:18,y:38,x:36,height:23,xoffset:-3.438},121:{yoffset:21.125,width:24,xadvance:18.313,y:185,x:157,height:31,xoffset:-2.25},122:{yoffset:21.063,width:21,xadvance:16.375,y:38,x:190,height:23,xoffset:-2.5},123:{yoffset:32.438,width:16,xadvance:12,y:145,x:0,height:40,xoffset:-.813},124:{yoffset:31.375,width:12,xadvance:14.375,y:211,x:64,height:37,xoffset:1.688},125:{yoffset:32.438,width:16,xadvance:12,y:105,x:0,height:40,xoffset:-2.313},126:{yoffset:16.125,width:21,xadvance:18.875,y:246,x:109,height:9,xoffset:-.438}},base:41},c=t.getWebappsAssetUrl("Visualization",""),h=new e.ImageUtils.loadTexture(c+"fonts/default.png",void 0,null,null,!0);h.flipY=!0,h.anisotropy=16;var u=new e.Vector3,d=i.extend({init:function(t,i,r){this.lineHeight=1,this.nbChars=0,this.textArray={},this.primitivePicking=!0,this._paramsLocked=!!r,this.billboard=!(!r||void 0===r.billboard)&&!!r.billboard,this.billboardAxis=!(!r||void 0===r.billboardAxis)&&!!r.billboardAxis,this.fixedSize=!(!r||void 0===r.fixedSize)&&!!r.fixedSize,this.viewSpace=!(!r||void 0===r.viewSpace)&&!!r.viewSpace,this.projectionSpace=!(!r||void 0===r.projectionSpace)&&!!r.projectionSpace,this.textMaterial=null,this.textGas=new a({colorRGB:new e.Color(0),side:e.FrontSide}),this._initMaterialPDSFX(this._paramsLocked),this._setFont();var n=new e.Mesh(void 0,null);return this._token=0,this.mesh3js=null,this._parent(n,t),this.mesh3js=this._occurrences[0].renderable,this._reallocate(r&&r.allocSize?r.allocSize:512),this.setFrustumCulled(!0),this.matInherit=window.newMaterialInheritance,this.matInherit?(this.matApp=new s({faceMaterial:this.textMaterial,layer:0}),this.textMaterial.useGASColor=!0,this.textMaterial.useGASOpacity=!0,this.setMaterialApplication(this.matApp)):this.setMaterial(this.textMaterial),this.setMaterialMode(!0),this},clone:function(){var t=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);return new d(t,this.name)},getNodeType:function(){return"Mesh3D"},setPrimitivePicking:function(e){this.primitivePicking=e},setBillboard:function(e,t){this._paramsLocked||this.billboard===e&&this.billboardAxis===t||(this.billboard=e,this.billboardAxis=t,this._updateDefines())},setFixedSize:function(e){this._paramsLocked||this.fixedSize!==e&&(this.fixedSize=e,e&&(this.billboard=!0),this._updateDefines())},_setViewSpace:function(e){this._paramsLocked||this.viewSpace!==e&&(this.viewSpace=e,this.projectionSpace=!e,this._updateDefines())},_setProjectionSpace:function(e){this._paramsLocked||this.projectionSpace!==e&&(this.projectionSpace=e,this.viewSpace=!e,this._updateDefines())},_updateDefines:function(){var e={USE_BILLBOARD:this.billboard,USE_AXIS:this.billboardAxis,USE_FIXEDSIZE:this.fixedSize,USE_VIEWSPACE:this.viewSpace,USE_PROJSPACE:this.projectionSpace};this.textMaterial.defines=e,this.textMaterial.updateDeferredMaterials(),this.textMaterial.needsUpdate=!0},getBillboard:function(){return this.billboard},addText:function(e){var t=e.string.length;if(0==t)return-1;var i=this._addText(e);if(i){e.primitive=i;var r=i.getCgmId();return this.textArray[r]=e,this.nbChars+=t,r}var n=this._reallocate(t),a=this._occurrences[0].renderable;if(i=this._addText(e,null!==n?a.layer.layers[n]:null,n)){e.primitive=i;r=i.getCgmId();return this.textArray[r]=e,this.nbChars+=t,r}return-1},removeText:function(e){var t=this.textArray[e];t&&(this.hide([n.getFromSGNode(t.primitive)]),this.nbChars-=t.string.length,delete this.textArray[e])},_setFont:function(){this.textMaterial&&this.textMaterial.updatePDSFXUniform("fontMap",h)},_reallocate:function(t){var i=this._occurrences[0].renderable,n=4*t,a=i.geometry.length,s=a?i.geometry[a-1]:null,o=s?s.vertexPositionArray.length/3:0,l=!a||65536===o,c=l?e.ImageUtils.nearest_greater_pow2(n):e.ImageUtils.nearest_greater_pow2(o+n),h=new e.BufferGeometryDS;h.editable=!0,h.vertexIndexArray=new Uint16Array(6*c/4),h.vertexPositionArray=new Float32Array(3*c),h.vertexColorArray=new Float32Array(4*c),h.vertexNormalArray=new Float32Array(3*c),h.vertexUvArray=new Float32Array(3*c),h.vertexUv2Array=new Float32Array(3*c),h.vertexTangentArray=new Float32Array(3*c),h.vertexBinormalArray=new Float32Array(3*c);for(var u=0;u<3*c;u+=3)h.vertexPositionArray[u]=NaN;var d=null;if(l){var p=new r.SGPrimitive({cgmId:this._token,rep:null,start:0,count:6*c/4});this._token++,(m=new r.DrawingGroup(this.textGas,null,4,0,6*c/4,[p])).geometry=h,h.drawingGroups.push(m),p.group=m;for(var f=0;f<this._occurrences.length;f++){(x=this._occurrences[f].renderable).geometry.push(h),h.addRefVBO(x,!1),x._initLayersForGeometry(0,h),d=(M=x.layer.getIntervals(h,null,!0)).length?x.layer.layers.indexOf(M[0]):-1}}else{for(u=0;u<4*o;u++)h.vertexColorArray[u]=s.vertexColorArray[u],u<3*o&&(h.vertexPositionArray[u]=s.vertexPositionArray[u],h.vertexNormalArray[u]=s.vertexNormalArray[u],h.vertexUvArray[u]=s.vertexUvArray[u],h.vertexUv2Array[u]=s.vertexUv2Array[u],h.vertexTangentArray[u]=s.vertexTangentArray[u],h.vertexBinormalArray[u]=s.vertexBinormalArray[u]);for(u=0;u<6*o/4;u++)h.vertexIndexArray[u]=s.vertexIndexArray[u];var m,g=s.drawingGroups[0]._primitives.slice(),v=g[g.length-1],S=v.start+v.count,_=6*c/4-S,y=new r.SGPrimitive({cgmId:this._token,rep:null,start:S,count:_});g.push(y),this._token++,(m=new r.DrawingGroup(this.textGas,null,4,0,6*c/4,g)).geometry=h,h.drawingGroups.push(m);for(f=0;f<g.length;f++)g[f].group=m;for(f=0;f<this._occurrences.length;f++){for(var x,M=(x=this._occurrences[f].renderable).layer.getIntervals(x.geometry[a-1],null,!0),P=0;P<M.length;P++)M[P].geometry=h,M[P].drawableGroup=h.drawingGroups[0];var C=M[M.length-1],b=x.layer.layers.indexOf(C);if(C.drawableInterval.layerNum){var D=new e.DrawableInterval(0,S,_);D.primitiveStart=g.length-1,D.primitiveCount=1;var w=new e.LayerInterval(h,h.drawingGroups[0],D);x.layer.layers.splice(b+1,0,w),d=b+1}else C.drawableInterval.count+=_,C.drawableInterval.primitiveCount++,d=b;h.addRefVBO(x,!1),x.geometry[a-1].releaseVBO(x,!1),x.geometry.splice(a-1,1),x.geometry.push(h)}}return d},_initMaterialPDSFX:function(t){var i="_";if(t&&(this.billboard&&(i+="bi_"),this.billboardAxis&&(i+="ax_"),this.fixedSize&&(i+="fi_"),this.viewSpace&&(i+="vi_"),this.projectionSpace&&(i+="pr_"),o[i]))this.textMaterial=o[i];else{if(this.textMaterial=new e.MeshBasicMaterial({force:!this.matInherit,side:e.FrontSide,needTangentBinormal:!0,vertexColors:e.VertexColorType.RGB,transparent:!0}),t){var r={USE_BILLBOARD:this.billboard,USE_AXIS:this.billboardAxis,USE_FIXEDSIZE:this.fixedSize,USE_VIEWSPACE:this.viewSpace,USE_PROJSPACE:this.projectionSpace};this.textMaterial.defines=r}this.textMaterial.activatePDSFX();var n={fontMap:{type:"t2",value:null},quad:{type:"fv1",value:[-.5,-.5,.5,-.5,.5,.5,-.5,.5],length:8},invSize:{type:"v2",value:new e.Vector2(512,512)},screenRatio:{type:"f",value:1}};this.textMaterial.setPDSFXUniforms(n);this.textMaterial.setPDSFXVaryings({_color:{type:"v4"},_uv:{type:"v2"}}),this.textMaterial.setPDSFXGlobalShaderCode("","float alpha;");var a={ComputeVaryingValues:["void ComputeVaryingValues() {","_color = vec4(vGetAttribColor().rgb, 1.0);","_uv = vGetAttribTexCoord0().xy;","}"].join("\n"),ProcessClipSpacePosition:["void ProcessClipSpacePosition(inout vec4 ioPosition) {","vec3 mPos = vGetAttribPosition();","vec3 mNormal = vGetAttribNormal();","vec4 mUV2 = vGetAttribTexCoord1();","vec3 mTangent = vGetAttribTangent();","vec3 mBinormal = vGetAttribBinormal();","vec3 uncompressedUp = mTangent;","vec3 uncompressedRight = mBinormal;","vec3 corner = vec3(quad[2*int(_vGetAttribColorAlpha())], quad[2*int(_vGetAttribColorAlpha()) + 1], 0.0);","#ifdef USE_BILLBOARD","#ifdef USE_FIXEDSIZE","#ifdef USE_VIEWSPACE","vec4 mvPosition = (modelMatrix * vec4(mPos, 1.0));","#elif defined(USE_PROJSPACE)","vec4 projPosition = vec4(mPos.xy, 0.0, 1.0);","#else",e._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPosition","vec4(mPos, 1.0)"),"#endif","#ifdef USE_AXIS","#ifdef USE_VIEWSPACE","vec4 mvPosition2 = (modelMatrix * vec4(mPos + uncompressedRight, 1.0));","#elif defined(USE_PROJSPACE)","vec4 projPosition2 = vec4(uncompressedRight.xy, 0.0, 1.0);","#else",e._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPosition2","vec4(mPos + uncompressedRight, 1.0)"),"#endif","#endif","#else",e._DefaultShaderChunk.getModelViewTransformationChunk("vec4 _mvPos","vec4(mPos, 1.0)"),"vec4 mvPosition = _mvPos + vec4(mNormal, 0.0) + vec4(corner * vec3(mUV2.xy, 1.0), 0.0);","#endif","#else","vec3 newPosition = mPos + mat3(uncompressedRight, uncompressedUp, vec3(0.0, 0.0, 1.0)) * (mNormal + corner * vec3(mUV2.xy, 1.0));",e._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPosition","vec4(newPosition, 1.0)"),"#endif","vec3 mvNormal;","#ifdef USE_PROJSPACE","ioPosition = projPosition;","#else","ioPosition = vGetProjectionMatrix() * mvPosition;","#endif","#ifdef USE_FIXEDSIZE","#ifdef USE_AXIS","#ifdef USE_PROJSPACE","vec2 toPixels = 0.5 / invSize;","vec2 projPt1 = toPixels * projPosition.xy;","vec2 projPt2 = toPixels * projPosition2.xy;","#else","vec4 glPosition2 = vGetProjectionMatrix() * mvPosition2;","vec2 toPixels1 = 0.5 / (invSize * ioPosition.w);","vec2 toPixels2 = 0.5 / (invSize * glPosition2.w);","vec2 projPt1 = toPixels1 * ioPosition.xy;","vec2 projPt2 = toPixels2 * glPosition2.xy;","#endif","vec2 rightVecPx = normalize(projPt2.xy - projPt1.xy);","vec2 upVecPx = vec2(-rightVecPx.y, rightVecPx.x);","vec2 offsetVec = (mNormal.xy + corner.xy * mUV2.xy);","offsetVec = offsetVec.x * rightVecPx + offsetVec.y * upVecPx;","#ifdef USE_PROJSPACE","ioPosition.xy += 2.0 * invSize * offsetVec;","#else","ioPosition.xy += 2.0 * invSize * offsetVec * ioPosition.w;","#endif","#else","ioPosition.xy += 2.0 * invSize * (mNormal.xy + corner.xy * mUV2.xy) * ioPosition.w;","#endif","#endif","}"].join("\n")},s={ComputeCommonValues:["void ComputeCommonValues() {","float epsilon = 0.1;","vec4 texture = texture2D(fontMap, _uv);","#if defined(GL_OES_standard_derivatives) || defined(GLSL300ES)","    float w = clamp(200.0 * epsilon * (abs(dFdx(_uv.x)) + abs(dFdy(_uv.y))), 0.0, 0.5);","#else","    float w = epsilon;","#endif","alpha = smoothstep(0.5 - w, 0.5 + w, texture.r);","alpha = pow(alpha, 1.0/2.2);","}"].join("\n"),ComputeDiscard:["bool ComputeDiscard() {","float alphaTest = 0.01;","return (alpha < alphaTest);","}"].join("\n"),ProcessFinalColor:"void ProcessFinalColor(inout vec4 ioFinalColor) { ioFinalColor = vec4(ComputeAlbedo() * _color.xyz, alpha * ComputeOpacity()); }"};this.textMaterial.setPDSFXOverridableFunctions(a,s),this.textMaterial.enableClipPlanes=!0,t&&(o[i]=this.textMaterial)}},_addText:function(e,t,i){var r=e.string.length,n=this._occurrences[0].renderable;if(!t)for(var a=0;a<n.layer.layers.length;a++){var s=n.layer.layers[a],o=s.drawableInterval;if(!o.layerNum&&o.count>=6*r){t=s,i=a;break}}if(t){var l=this._updatePrimitives(t,i,r);return this._updateBuffers(l,e),l}return null},_encodeUnitVector:function(e){var t=Math.abs(e.x)+Math.abs(e.y)+Math.abs(e.z),i=e.x/t,r=e.y/t;if(e.z<0){var n=(1-Math.abs(r))*(i>=0?1:-1),a=(1-Math.abs(i))*(r>=0?1:-1);i=n,r=a}return 4096*(i=Math.round(4095*(.5*i+.5)))+(r=Math.round(4095*(.5*r+.5)))},_updateBuffers:function(t,i){for(var n=new e.Box2,a=t.getGroup().geometry,s=t.getStart(),o=4*(s/6),c=i,h=c.string.length,d=c.offset?c.offset:u,p=this.getBuffer(r.VertexComponentEnum.POSITION,a),f=this.getBuffer(r.VertexComponentEnum.NORMAL,a),m=this.getBuffer(r.VertexComponentEnum.DIFFUSE_COLOR,a),g=this.getBuffer(r.VertexComponentEnum.TEX_COORD_0,a),v=this.getBuffer(r.VertexComponentEnum.TEX_COORD_1,a),S=this.getBuffer(r.VertexComponentEnum.TEX_COORD_2,a),_=this.getBuffer(r.VertexComponentEnum.TEX_COORD_3,a),y=this.getIndexBuffer(a),x=c.size/l.base,M=c.lineLength?c.lineLength:0,P=0,C=new e.Vector3,b=s,D=o,w=3*o,E=4*o,T=3*o,A=3*o,I=3*o,R=3*o,L=3*o,O=0,N=0;N<h;N++){var F=c.string[N];if("\n"===F)C.x=0,C.y-=x*this.lineHeight*l.base,P=0;else{if(M&&" "===F&&P>M){C.x=0,C.y-=x*this.lineHeight*l.base,P=0;continue}if(!(F=l.chars[F.charCodeAt(0)]))continue;O++,y[b++]=D,y[b++]=D+1,y[b++]=D+2,y[b++]=D,y[b++]=D+2,y[b++]=D+3,D+=4,g[I++]=F.x/l.width,g[I++]=(l.height-(F.y+F.height))/l.height,g[I++]=0,g[I++]=(F.x+F.width)/l.width,g[I++]=(l.height-(F.y+F.height))/l.height,g[I++]=0,g[I++]=(F.x+F.width)/l.width,g[I++]=(l.height-F.y)/l.height,g[I++]=0,g[I++]=F.x/l.width,g[I++]=(l.height-F.y)/l.height,g[I++]=0;var V=C.x+x*(.5*F.width+F.xoffset),U=C.y+x*(F.yoffset-.5*F.height);C.z;C.x+=x*F.xadvance,P+=x*F.xadvance,n&&(V-.5*x*F.width<n.min.x&&(n.min.x=V-.5*x*F.width),V+.5*x*F.width>n.max.x&&(n.max.x=V+.5*x*F.width),U-.5*x*F.height<n.min.y&&(n.min.y=U-.5*x*F.height),U+.5*x*F.height>n.max.y&&(n.max.y=U+.5*x*F.height));for(var B=0;B<4;B++)f[w++]=d.x+V,f[w++]=d.y+U,f[w++]=d.z,p[T++]=c.anchor.x,p[T++]=c.anchor.y,p[T++]=c.anchor.z,v[A++]=x*F.width,v[A++]=x*F.height,v[A++]=0,m[E++]=c.color.r,m[E++]=c.color.g,m[E++]=c.color.b,m[E++]=B,S[R++]=c.up.x,S[R++]=c.up.y,S[R++]=c.up.z,_[L++]=c.right.x,_[L++]=c.right.y,_[L++]=c.right.z}}for(N=0;N<6*(h-O);N++)y[b++]=0;this.updateBuffer(r.VertexComponentEnum.POSITION,o,4*h,a),this.updateBuffer(r.VertexComponentEnum.NORMAL,o,4*h,a),this.updateBuffer(r.VertexComponentEnum.DIFFUSE_COLOR,o,4*h,a),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_0,o,4*h,a),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_1,o,4*h,a),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_2,o,4*h,a),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_3,o,4*h,a),this.updateIndexBuffer(s,6*h,a);var k=new e.Vector3(n.min.x,n.min.y,-.5),G=new e.Vector3(n.max.x,n.max.y,.5),z=this.getBoundingBox(),H=new e.Box3(k,G);this.forceBoundingBox(z.union(H)),i.labelExtent||(i.labelExtent=n)},getTextExtent:function(t){var i=new e.Box2;t.labelExtent=i;for(var r=t,n=r.string.length,a=r.size/l.base,s=r.lineLength?r.lineLength:0,o=0,c=new e.Vector2,h=0;h<n;h++){var u=r.string[h];if("\n"===u)c.x=0,c.y-=a*this.lineHeight*l.base,o=0;else{if(s&&" "===u&&o>s){c.x=0,c.y-=a*this.lineHeight*l.base,o=0;continue}if(!(u=l.chars[u.charCodeAt(0)]))continue;var d=c.x+a*(.5*u.width+u.xoffset),p=c.y+a*(u.yoffset-.5*u.height);c.x+=a*u.xadvance,o+=a*u.xadvance,d-.5*a*u.width<i.min.x&&(i.min.x=d-.5*a*u.width),d+.5*a*u.width>i.max.x&&(i.max.x=d+.5*a*u.width),p-.5*a*u.height<i.min.y&&(i.min.y=p-.5*a*u.height),p+.5*a*u.height>i.max.y&&(i.max.y=p+.5*a*u.height)}}return i},_updatePrimitives:function(e,t,i){this._mergePrimitives(e,t);var n=e.geometry,a=n.drawingGroups[0],s=e.drawableInterval,o=a.getPrimitiveCount(s.primitiveStart);a._setPrimitiveCount(6*i,s.primitiveStart);var l=new r.SGPrimitiveHelper;l.set(a,s.primitiveStart);var c=o-l.getCount();if(c>0){var h=new r.SGPrimitive({cgmId:this._token,rep:null,group:l.getGroup(),start:l.getStart()+l.getCount(),count:c});this._token++,a._primitives.splice(s.primitiveStart+1,0,h)}for(var u=0;u<this._occurrences.length;u++){var d=this._occurrences[u].renderable,p=d.layer.layers[t],f=t?d.layer.layers[t-1]:null,m=f&&f.geometry===p.geometry;if(f&&m&&1===f.drawableInterval.layerNum)f.drawableInterval.count+=l.getCount(),f.drawableInterval.primitiveCount++,c>0?(p.drawableInterval.start=l.getStart()+l.getCount(),p.drawableInterval.count=c,p.drawableInterval.primitiveStart++):d.layer.layers.splice(t,1);else if(p.drawableInterval.count=6*i,p.drawableInterval.layerNum=1,c>0){var g=p.clone();g.drawableInterval.layerNum=0,g.drawableInterval.start=l.getStart()+l.getCount(),g.drawableInterval.count=c,d.layer.layers.splice(t+1,0,g)}if(c>0)for(var v=t+1;v<d.layer.layers.length&&d.layer.layers[v].geometry===n;v++)d.layer.layers[v].drawableInterval.primitiveStart++}return l},_mergePrimitives:function(e,t){var i=e.geometry,r=i.drawingGroups[0]._primitives,n=e.drawableInterval;if(!(n.primitiveCount<=1)){var a=r[n.primitiveStart],s=r[n.primitiveStart+n.primitiveCount-1];a.count=s.start+s.count-a.start,r.splice(n.primitiveStart+1,n.primitiveCount-1);for(var o=0;o<this._occurrences.length;o++)for(var l=this._occurrences[o].renderable,c=t+1;c<l.layer.layers.length&&l.layer.layers[c].geometry===i;c++)l.layer.layers[c].drawableInterval.primitiveStart-=n.primitiveCount-1;n.primitiveCount=1}}});return UWA.namespace("THREEDS/Nodes/TextNode",d)}),define("DS/SceneGraphNodes/AreaLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var r=new e.AreaLight(t.color,t.intensity,t.width,t.height,t.mode);return this._areaWidth=r.width,this._areaHeight=r.height,this._parent(r,i),this},attachToViewpoint:function(e){return null},setAreaSize:function(e,t){e&&(this._areaWidth=e),t&&(this._areaHeight=t),this._updateAreaSize()},_updateAreaSize:function(){var e,t;this.light3js.width=this._areaWidth,this.light3js.height=this._areaHeight,e=this._occurrences.length;for(var i=0;i<e;i++)(t=this._occurrences[i]).renderable.width=this._areaWidth,t.renderable.height=this._areaHeight},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"AreaLightNode3D"}});return UWA.namespace("THREEDS/Nodes/AreaLight",i)}),define("SceneGraphNodes/AreaLightNode",["DS/SceneGraphNodes/AreaLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/AreaLightNode"),e}),define("DS/SceneGraphNodes/CSS3DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i,r){this._parent(r),this.scale=i||1,this.css3DNode=new e.CSS3DNode(t);var n=this.createRenderable(),a=t.style.width;a=a.substring(0,a.length-2);var s=t.style.height;s=s.substring(0,s.length-2);var o=.5*i*Math.sqrt(a*a+s*s);this.hasExplicitBE=!0,this.explicitBSphere=new e.Sphere(new e.Vector3(0,0,0),o),this.explicitBBox=null,n.matrixAutoUpdate=!1,n.visible=this.css3DNode.visible;var l=this._occurrences[0];return l.renderable=n,l.renderable.name=this.name,l.renderable._occurrence=l,l.renderable.scaleCSS=(new e.Matrix4).scale(new e.Vector3(this.scale,this.scale,this.scale)),document.getElementById("camera")&&document.getElementById("camera").appendChild(this.css3DNode.element),this},createRenderable:function(){var t=new e.CSS3DNode(this.css3DNode.element);return t.matrixAutoUpdate=!1,t.matrixWorldNeedsUpdate=!1,t.pickable=!0,t.visible=this.css3DNode.visible,t},setPickability:function(e){this.css3DNode.element.style.pointerEvents=e?"auto":"none"},add:function(){return!1},getNodeType:function(){return"CSS3DNode"},clone:function(){var t=new e.CSS3DNode(this.css3DNode.element);return new THREEDS.Nodes.CSS3DNode(t.element,this.name)}});return UWA.namespace("THREEDS/Nodes/CSS3DNode",i)}),define("SceneGraphNodes/CSS3DNode",["DS/SceneGraphNodes/CSS3DNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/CSS3DNode"),e}),define("DS/Effects/SSLReflectionEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/AbstractSSRayMarchingEffect"],function(e,t,i){"use strict";return i.extend({init:function(e,t){return this._parent(e,t,"SSLReflection","SSLReflectionMipSolver"),this},initEffect:function(e,t){var i=t.getComposer("normalDepthIoRRoughness");i.linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.uniforms.tNormalDepthIoRRoughness),i.linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.uniforms.tColorNormalDepth),i.linkToShaderPassUniform(this.passSolver,this.passSolver.uniforms.tNormalDepthIoRRoughness),t.getComposer("color").linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.uniforms.tColor)}})}),define("DS/SceneGraphNodes/Canvas2DInstancingNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/SceneGraphNodes/Canvas2DNode"],function(e,t,i,r,n){"use strict";var a=t.extend({init:function(t,i){this._parent(t.name),this.hotspot=t.hotspot||new e.Vector2(0,0),this.canvasNodeTexture=t.canvasNodeTexture,this.texture=this.canvasNodeTexture._getCanvas2DTexture(),this.rectangle=n._createRectangle(null,i),this.rectangle.setFrustumCulled(!1),this.rectangle.setMirror(!1),this.rectangle.setShadow(!1,!1),this.setInstancingParams(t,this.texture),this.addChild(this.rectangle),this.rectangle.setRenderPasses(["canvas2D"]),void 0!==t.excludeFromBounding?this.excludeFromBounding=!!t.excludeFromBounding:this.excludeFromBounding=!0,this.excludeFromBounding?this.exludeFromBounding(!0):this._setupBoundingSphere(t.matrices);var r=this;return this.rectangle._setBeforeRenderCB(function(e,t){r.texture.redrawRequested&&r.canvasNodeTexture._redrawCanvas2DTexture()}),this},excludeFromHighlight:function(e,t){this.rectangle.excludeFromHighlight(e,t)},setInstancingParams:function(e){this.material=this._buildInstancingMaterial(this.texture),this.material.force=!0,this.rectangle.setMaterial(this.material),this._setUpMeshInstancingParameters(this.rectangle,e.nbInstances,e.matrices,e.colors),this.excludeFromBounding||this._setupBoundingSphere(e.matrices)},_buildInstancingMaterial:function(t){var i=new e.MeshBasicMaterial({force:!0,transparent:!0,side:e.DoubleSide});i.activatePDSFX();var r={ComputeObjectPosition:["vec3 ComputeObjectPosition() {","vec4 localPosition = vec4(vGetAttribPosition(), 1.0);","vec4 newPosition = instanceMatrix*localPosition;","return newPosition.xyz;","}"].join("\n"),ProcessClipSpacePosition:["void ProcessClipSpacePosition(inout vec4 ioPosition) {","vec2 myUv = vGetAttribTexCoord0().xy;","ioPosition.x += ioPosition.w * (pixelSize.x*(-hotspot.x + myUv.x*size.x));","ioPosition.y += ioPosition.w * (pixelSize.y*(-hotspot.y + myUv.y*size.y));","}"].join("\n"),ComputeVaryingValues:["void ComputeVaryingValues() {","vColor = instanceColor;","vTex = vGetAttribTexCoord0().xy;","}"].join("\n")},n={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","vec4 color = texture2D(map, vTex);","ioFinalColor = vec4(color.r*vColor.r, color.g*vColor.g, color.b*vColor.b, color.a);","}"].join("\n"),ComputeViewNormal:"vec3 ComputeViewNormal() { return vec3(0.0,0.0,1.0); }",ComputeDiscard:["bool ComputeDiscard() {","  vec4 color = texture2D(map, vTex);","  return color.a <= alphaTest;","}"].join("\n")},a={hotspot:{type:"v2",value:this.hotspot},pixelSize:{type:"v2",value:new e.Vector2(.005,.005)},size:{type:"v2",value:new e.Vector2(this.canvasNodeTexture.width,this.canvasNodeTexture.height)},map:{type:"t2",value:t},alphaTest:{type:"f",value:this.canvasNodeTexture.alphaTest||-1}};return i.setPDSFXVaryings({vColor:{type:"v3"},vTex:{type:"v2"}}),i.setPDSFXUniforms(a),i.setPDSFXOverridableFunctions(r,n),i.refreshUniforms=function(t,i){var r;if(!t._smallTargetPicking||t.materialToUse!==e.MaterialToUse.pickingMaterial&&t.materialToUse!==e.MaterialToUse.pickingMaterialInstancing&&t.materialToUse!==e.MaterialToUse.normalMaterial&&t.materialToUse!==e.MaterialToUse.depthMaterial)r=new e.Vector2(2/t.domElement.width,2/t.domElement.height);else{var n=2*t._gpuPickingTolerance+1;r=new e.Vector2(2/n,2/n)}this.updatePDSFXUniform("pixelSize",r)},i},_setUpMeshInstancingParameters:function(t,i,r,n){var a,s,o,l,c,h,u=new Float32Array(16*i),d=new Float32Array(3*i),p=new e.Matrix4;for(a=0;a<i;a++){for(s=r[a],p.copy(s),o=16*a,l=s.elements,h=0;h<16;h++)u[o+h]=l[h];o=3*a,c=n[a],d[o]=c.r,d[o+1]=c.g,d[o+2]=c.b}var f={data:u,type:"m4",attribName:"instanceMatrix",isFlattened:!0},m={data:d,type:"v3",attribName:"instanceColor",isFlattened:!0};t.setInstancingParameters(i,[f,m])},_setupBoundingSphere:function(t){var i,r,n,a,s,o=new e.Vector3(-1/0,-1/0,-1/0),l=new e.Vector3(1/0,1/0,1/0),c=new e.Vector3(0,0,0);for(i=0;i<t.length;i++)n=(r=t[i]).elements[12],a=r.elements[13],s=r.elements[14],n<l.x&&(l.x=n),a<l.y&&(l.y=a),s<l.z&&(l.z=s),n>o.x&&(o.x=n),a>o.y&&(o.y=a),s>o.z&&(o.z=s);c.x=(l.x+o.x)/2,c.y=(l.y+o.y)/2,c.z=(l.z+o.z)/2;var h,u=new e.Vector3,d=0;for(i=0;i<t.length;i++)n=(r=t[i]).elements[12],a=r.elements[13],s=r.elements[14],u.set(n,a,s),(h=c.distanceTo(u))>d&&(d=h);var p=new e.Sphere(c,d);this.rectangle.forceBoundingSphere(p)}});return UWA.namespace("THREEDS/Nodes/Canvas2DInstancingNode",a)}),define("DS/Visualization/SceneGraphFactory",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/DecalNode3D","DS/Visualization/EditableMesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/CanvasNodeTexture","DS/SceneGraphNodes/CanvasNode","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/Canvas2DNode","DS/SceneGraphNodes/Canvas2DInstancingNode","DS/Effects/ComputeSDFFontIterative","DS/Effects/DownSamplingEffect","DS/Effects/ComputeSDFFontMergeTiles","DS/Visualization/MaterialApplication"],function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g,v,S){"use strict";var _,y,x,M,P,C,b,D,w,E,T,A,I,R=new c,L={textCanvas:null,iterativeCompute:null,downSampling:null,mergeTiles:null},O=["left","center","right"],N=[0,.5,1],F=["top","bottom","middle","alphabetic","hanging"],V=[0,1,.5,1,0],U={createMeshNode:function(t,a,o,l,c,h){var u,d,p,f,m,g,v,S,_=void 0!==o?o:0,y=void 0!==a?a:t.material;e.disableJHGDev&&null==y&&(u=new e.Color,d=new e.Color(6710886),p=new e.Color,(y=e.MaterialUtils.createShinyFaceMaterial({color:u.getHex(),opacity:1})).line=new e.LineBasicMaterial({color:d.getHex(),lineWidth:1,opacity:1}),y.point=new e.ParticleBasicMaterial({color:p.getHex(),size:1,opacity:1})),f=new s.SGBag,m=new s.SGRep({cgmId:_,parent:f}),s.validatePrimitiveGroup(t);var x,M=s.checkMeshOptimizable(t),P=M&&t.editable,C=M&&(t.editable||t.optimized),b=!P&&t.sharing;if(C)v=[s.createGeometryOptimized(t,m)],P&&(v[0].editable=!0);else{t.editable?console.warn("Could not make the mesh editable since it does not satisfy the editability rules : no strips and fans, no multi-indexation, 1 buffer per vertex component, 1 index buffer."):t.optimized&&console.warn("Could not optimize the mesh build since it does not satisfy the editability rules : no strips and fans, no multi-indexation, 1 buffer per vertex component, 1 index buffer.");for(var D=0;D<t.buffers.length;D++){var w=t.buffers[D];if(w&&w.component===s.VertexComponentEnum.DIFFUSE_COLOR){if(3===w.dimension){w.dimension=4,w.size*=4/3;for(var E=w.data,T=E.length/3,A=new Float32Array(4*T),I=0,R=0;R<T;R++)A[I]=E[3*R],A[I+1]=E[3*R+1],A[I+2]=E[3*R+2],A[I+3]=1,I+=4;w.data=A}else 4!==w.dimension&&console.error("ERROR : Your Color Buffer should have 4 values per vertex (RGBA)");break}}(g=s.convertToGeometry3js(t,void 0,void 0,void 0,l,!1,c)).rep=m,(v=s.divideRep(g)).sceneGraph=f,t.patternOffsets&&(v.patternOffsets=t.patternOffsets)}return S=s.convertTo3jsMesh(v,y,!0,b),x=h?new r(S):P?new n(S):new i(S),!e.disableJHGDev&&y&&x.setMaterial(y),t.noz&&x.setRenderPasses(["noz"]),x},isReady:function(){return this.root.isReady()},applyMaterialOpacityOverrideToPath:function(){return!1},applyMaterialOverrideToPath:function(){return!1},removeAnyMaterialOverride:function(){return!1},createCuboidNode:function(e){var t=R.CreateVis3DCuboid(e);return this.createMeshNode(t,e.material,void 0,void 0,void 0,!!e._decal)},createCuboidNodeFromBox3:function(e,t){var i=R.CreateVis3DCuboidFromBox3(e,{});return this.createMeshNode(i,t,void 0,"mono")},createSphereNode:function(e){var t=R.CreateVis3DSphere(e);return this.createMeshNode(t,e.material,void 0,"mono")},createTubeNode:function(e){var t=R.CreateVis3DTube(e);return this.createMeshNode(t,e.material,void 0,"mono")},createCylinderNode:function(e){var t=R.CreateVis3DCylinder(e);return this.createMeshNode(t,e.material,void 0,"mono")},createConeNode:function(e){var t=R.CreateVis3DCone(e);return this.createMeshNode(t,e.material,void 0,"mono")},createCylinderCustomNode:function(e){var t=R.CreateVis3DCylinderCustom(e);return this.createMeshNode(t,e.material,void 0,"mono")},createLineNode:function(e){var t=R.createLine(e);return this.createMeshNode(t,e.material)},createRectangleNode:function(e){var t=R.createRectangle(e);return this.createMeshNode(t,e.material)},createCircleNode:function(e){var t=R.createCircle(e);return this.createMeshNode(t,e.material)},createTorusNode:function(e){var t=R.createTorus(e);return this.createMeshNode(t,e.material)},createPointsNode:function(e){var t=R.createPoints(e.positions,e.color,e.size,e.layerNb);return this.createMeshNode(t,e.material)},createSimpleMeshNode:function(e){var t=R.createMesh(e.bufferPosition,e.bufferNormal,e.bufferUV,e.bufferIndex,e.glType,e.color,void 0,e.axis,e.layerNb);return this.createMeshNode(t,e.material)},createTessellatedCurvedPipe:(_=new e.Vector3,y=new e.Vector3,x=new e.Vector3,M=new e.Vector3,P=new e.Vector3,C=new e.Vector3,b=new e.Vector3,D=new e.Vector3,w=new e.Vector3,E=new e.Vector3,T=new e.Vector3,A=new e.Vector3,I=new e.Vector3,function(t,r,n,a,o,l,c,h,u){var d=new e.BufferGeometryDS;d.sharedBuffers=!0;var p=n.length/3;_.set(n[0]+a.x,n[1]+a.y,n[2]+a.z),y.set(n[3*(p-1)]+o.x,n[3*(p-1)+1]+o.y,n[3*(p-1)+2]+o.z),d.drawingGroups=[];var f=6*t*(p-1)+6*(t-2),m=new s.DrawingGroup(h,u,4,0,f);m.geometry=d,d.drawingGroups.push(m);for(var g=(p+2)*t,v=new Float32Array(3*g),S=new Float32Array(3*g),R=0,L=new Array(t),O=new Array(t),N=0;N<t;N++){var F=2*Math.PI*(N/t);L[N]=Math.cos(F),O[N]=Math.sin(F)}D.copy(l);for(var V=[],U=[],B=0;B<p;B++){M.set(n[3*B],n[3*B+1],n[3*B+2]),0===B?x.copy(_):x.set(n[3*(B-1)],n[3*(B-1)+1],n[3*(B-1)+2]),B===p-1?P.copy(y):P.set(n[3*(B+1)],n[3*(B+1)+1],n[3*(B+1)+2]),C.subVectors(M,x).normalize(),b.subVectors(P,M).normalize(),T.addVectors(C,b).normalize();var k=D.dot(T);for(A.copy(T).multiplyScalar(k),I.subVectors(D,A),w.crossVectors(T,I),N=0;N<t;N++){E.set(L[N]*I.x+O[N]*w.x,L[N]*I.y+O[N]*w.y,L[N]*I.z+O[N]*w.z).normalize();var G=r*E.x,z=r*E.y,H=r*E.z;0===B&&(V.push(-T.x),V.push(M.x+G),V.push(-T.y),V.push(M.y+z),V.push(-T.z),V.push(M.z+H)),B===p-1&&(U.push(T.x),U.push(M.x+G),U.push(T.y),U.push(M.y+z),U.push(T.z),U.push(M.z+H)),S[R]=G,v[R++]=M.x+G,S[R]=z,v[R++]=M.y+z,S[R]=H,v[R++]=M.z+H}D=I}for(N=0;N<V.length/2;N++)S[R]=V[2*N],v[R++]=V[2*N+1];for(N=0;N<U.length/2;N++)S[R]=U[2*N],v[R++]=U[2*N+1];d.vertexPositionArray=v,d.vertexNormalArray=S;var W=new Uint16Array(f),j=0,X=0,q=0,Z=0,Y=0,K=0;for(B=0;B<p-1;B++)for(N=0;N<t;N++)X=(K=B*t)+N,q=K+(N+1)%t,Z=K+N+t,Y=N===t-1?K+t:(K+N+t+1)%g,W[j++]=X,W[j++]=q,W[j++]=Z,W[j++]=q,W[j++]=Y,W[j++]=Z;for(K=p*t,N=0;N<t-2;N++)W[j++]=K,W[j++]=K+N+2,W[j++]=K+N+1,W[j++]=K+t,W[j++]=K+t+N+1,W[j++]=K+t+N+2;d.vertexIndexArray=W;var J=[];J.push(d);var Q=new e.Mesh(J,u);Q.matrixAutoUpdate=!1;var $=function(t,i){for(var r=new e.Vector3(1/0,1/0,1/0),n=new e.Vector3(-1/0,-1/0,-1/0),a=new e.Vector3,s=new e.Vector3,o=new e.Vector3,l=new e.Vector3,c=new e.Vector3,h=new e.Vector3,u=new e.Vector3,d=new e.Vector3,p=null,f=i.length/3-1,m=0;m<f;m++){s.set(i[3*m],i[3*m+1],i[3*m+2]),o.set(i[3*m+3],i[3*m+4],i[3*m+5]),a.subVectors(o,s);var g=a.dot(a);l.set(t*Math.sqrt(1-a.x*a.x/g),t*Math.sqrt(1-a.y*a.y/g),t*Math.sqrt(1-a.z*a.z/g)),c.subVectors(s,l),u.subVectors(o,l),c.min(u),h.addVectors(s,l),d.addVectors(o,l),h.max(d),p=new e.Box3(c,h),r.min(p.min),n.max(p.max)}var v=(new e.Vector3).addVectors(r,n).multiplyScalar(.5),S=(new e.Vector3).addVectors(v,(new e.Vector3).subVectors(r,v).multiplyScalar(1.05)),_=(new e.Vector3).addVectors(v,(new e.Vector3).subVectors(n,v).multiplyScalar(1.05));return new e.Box3(S,_)}(r,n),ee=new i(Q,"");return ee.forceBoundingBox($),ee}),createTextNode:function(e){return e.sdf?this.createSDFTextNode.apply(this,arguments):this.createTextNodeZoomable.apply(this,arguments)},createSDFTextNode:function(t){var i,r,n,a,s,o,l,c,h;t.resolutionCoef=256,t.color||(t.color=new e.Color("white")),i="font-family: "+t.font+"; font-size: "+t.resolutionCoef+"px;",s=(n=(r=t.precomputedTextSize||R._determineTextSize(t.text,i,"pre")).width)/(a=r.height),L.textCanvas||(L.textCanvas=document.createElement("canvas")),(o=L.textCanvas).width=n,o.height=a,(l=o.getContext("2d")).fillStyle="#ffffff",l.fillRect(0,0,n,a),l.fillStyle="#000000",l.lineWidth=0,l.strokeStyle="#000000",l.font=t.resolutionCoef+"px "+t.font,l.textAlign="left",l.textBaseline="top",l.fillText(t.text,0,0),l.restore(),c=n/t.resolutionCoef,(h=R.createRectangle(t.fontSize*c,t.fontSize*c/s,!0,void 0,void 0,t.layerNb)).noz=t.layerNb>0;var u=null;if(0!==o.width||0!==o.height){L.iterativeCompute||(L.iterativeCompute=new m(debugWebGLV6Viewer.renderer.renderer,debugWebGLV6Viewer.renderer.renderTargetPool)),L.downSampling||(L.downSampling=new g(debugWebGLV6Viewer.renderer.renderer,debugWebGLV6Viewer.renderer.renderTargetPool)),L.mergeTiles||(L.mergeTiles=new v(debugWebGLV6Viewer.renderer.renderer,debugWebGLV6Viewer.renderer.renderTargetPool));for(var d=L.iterativeCompute.gl,p=performance.now(),f=p,S=l.getImageData(0,0,o.width,o.height),_=(new ArrayBuffer(S.data.length),Math.floor(o.width/8)),y=Math.floor(o.height/8),x=1+Math.ceil((o.width-512)/448),M=1+Math.ceil((o.height-512)/448),P=new Uint8Array(1048576),C=(new Uint8Array(16384),new Uint8Array(4*_*y)),b=null,D=(performance.now(),0);D<M;D++)for(var w=448*D,E=w/8,T=0;T<x;T++){var A=448*T,I=A/8,O=T===x-1?o.width-448*T:512,N=D===M-1?o.height-448*D:512,F=Math.floor(O/8),V=Math.floor(N/8),U=w*o.width+A,B=0;p=performance.now();for(var k=0;k<512;k++)for(var G=0;G<512;G++)if(G<O&&k<N){var z=U+k*o.width+G;P[B++]=S.data[4*z],P[B++]=S.data[4*z+1],P[B++]=S.data[4*z+2],P[B++]=S.data[4*z+3]}else P[B++]=255,P[B++]=255,P[B++]=255,P[B++]=255;b||(b=new e.DataTexture(P,512,512,e.RGBAFormat,e.UnsignedByteType,new e.UVMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter),L.iterativeCompute.setMap(b,50),L.downSampling.setSize(512,512),L.downSampling.setInput(L.iterativeCompute.composers[1]),L.mergeTiles.setSize(_,y),L.mergeTiles.setInput(L.downSampling.composers[2])),b.needsUpdate=!0,p=performance.now();for(var H=0;H<50;H++)L.iterativeCompute.executeStep(H,49===H);L.downSampling.execute(),L.mergeTiles.setTileInfos(I,E,64,64,F,V),L.mergeTiles.execute()}p=performance.now(),d.readPixels(0,0,_,y,d.RGBA,d.UNSIGNED_BYTE,C),(u=new e.DataTexture(C,_,y,e.RGBAFormat,e.UnsignedByteType,new e.UVMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearMipMapLinearFilter)).needsUpdate=!0,u.flipY=!0,console.log(">>>>> generated SDF from bitmap in "+(performance.now()-f)+"ms")}h.material=new e.MeshBasicMaterial({force:!0,side:t.side?t.side:e.FrontSide,transparent:!0}),h.material.activatePDSFX();var W={fontMap:{type:"t2",value:u},_color:{type:"v3",value:new e.Vector3(t.color.r,t.color.g,t.color.b)},ratio:{type:"f",value:y/_}};h.material.setPDSFXUniforms(W);h.material.setPDSFXVaryings({_uv:{type:"v2"}}),h.material.setPDSFXGlobalShaderCode("","float alpha;");var j={ComputeCommonValues:["void ComputeCommonValues() {","float epsilon = 0.003;","float texel = texture2D(fontMap, _uv).r;","#if defined(GL_OES_standard_derivatives) || defined(GLSL300ES)","    float w = clamp(200.0 * epsilon * (abs(dFdx(texel)) + abs(dFdy(texel))), 0.0, 0.5);","#else","    float w = epsilon;","#endif","alpha = smoothstep(0.5 - w, 0.5 + w, 1.0 - texel);","alpha = pow(alpha, 1.0/2.2);","}"].join("\n"),ComputeDiscard:["bool ComputeDiscard() {","float alphaTest = 0.01;","return (alpha < alphaTest);","}"].join("\n"),ComputeAlbedo:"vec3 ComputeAlbedo() { return _color; }",ComputeOpacity:"float ComputeOpacity() { return alpha; }"};return h.material.setPDSFXOverridableFunctions({ComputeVaryingValues:"void ComputeVaryingValues() { _uv = vGetAttribTexCoord0().xy; }"},j),this.createMeshNode(h)},createTextNodeZoomable:function(t){var i=t.resolutionCoef||32,r="";t.bold&&(r+="font-weight : bold; "),t.italic&&(r+="font-style: italic;");var n=r+"font-family: '"+t.font+"'; font-size: "+i+"px;",a=t.precomputedTextSize||R._determineTextSize(t.text,n),s=a.width,o=a.height,l=s/o,c=t.side?t.side:e.FrontSide,d=t.textAlign?O[t.textAlign]:"left",p=t.textBaseline?F[t.textBaseline]:"top",f=t.textAlign?N[t.textAlign]:0,m=t.textBaseline?V[t.textBaseline]:0,g=t.zoom||1,v=s/i,S=t.fontSize*v*g,_=t.fontSize*v/l*g,y=!!t.stroke&&t.stroke,x=s,M=o;if(t._fix&&(!x||!M||!isFinite(M)||!isFinite(x)))return null;var P=new h({width:x,height:M,drawCB:function(e,r,n){var a=f*x,s=m*M;try{r.fillStyle="#"+t.color.getHexString(),r.lineWidth=0,r.strokeStyle="#"+t.color.getHexString();var o=(t.bold?"bold ":"")+(t.italic?"italic ":"");if(r.font=o+i+"px '"+t.font+"',Arra",r.textAlign=d,r.textBaseline=p,y?r.strokeText(t.text,a,s):r.fillText(t.text,a,s),t._debug&&(r.strokeStyle="red",r.moveTo(0,s),r.lineTo(x,s),r.stroke(),r.moveTo(0,0),r.moveTo(a,0),r.lineTo(a,M),r.stroke(),r.moveTo(0,0)),window.WUXDisableTextNodes)return void r.clearRect(0,0,x,M)}catch(e){console.log(failed)}},rectangleTexture:!0,maxZoom:8,depthWrite:t.depthWrite}),C=t.hotspot||{x:0,y:0};return t.bbox?new u({name:t.name,bottomLeftcorner:new e.Vector3(t.bbox[0],t.bbox[2],0),widthVector:new e.Vector3(t.bbox[1]-t.bbox[0],0,0),heightVector:new e.Vector3(0,t.bbox[3]-t.bbox[2],0),canvasNodeTexture:P,side:c},U):new u({name:t.name,bottomLeftcorner:new e.Vector3(-C.x*S,-C.y*_,0),widthVector:new e.Vector3(S,0,0),heightVector:new e.Vector3(0,_,0),canvasNodeTexture:P,side:c},U)},createCanvasNode:function(e){return new u(e,U)},createCanvas2DNode:function(e){return new p(e,U)},createCanvas2DInstancingNode:function(e){return new f(e,U)},createNodeFromTHREEMesh:function(e){var t=R.convertFromTHREEMesh(e);return this.createMeshNode(t)},createFixedSizeNode:function(e){return new d({name:(e=e||{}).name,ratio:e.ratio||1})}};return U}),define("Visualization/SceneGraphFactory",["DS/Visualization/SceneGraphFactory","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SceneGraphFactory"),e}),define("DS/Visualization/PolygonTessellator",["UWA/Class","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Mesh/MeshUtils","libtess/libtess.min"],function(e,t,i,r,n){"use strict";var a=0,s=e.extend({init:function(){this.polygons=[],this.polygonGroupEnd=[],this.currentPolygon=this._createEmptyPolygon()},addPointToCurrentPolygonLoop:function(e,t,i){var r;0===this.currentPolygon.points.length&&(this.currentPolygon.userData=i),this.currentPolygon.points.length>0&&(r=this.currentPolygon.points.length-2,this.currentPolygon.points[r]===e&&this.currentPolygon.points[r+1]===t)||(this.currentPolygon.points.push(e),this.currentPolygon.points.push(t))},closeCurrentPolygonLoop:function(){this.currentPolygon.points.length>2&&(this.currentPolygon.closed=!0,this.polygons.push(this.currentPolygon)),this.currentPolygon=this._createEmptyPolygon()},endCurrentPolygon:function(){this._startNewPolygon(),this.polygonGroupEnd.push(this.polygons.length)},createNode3D:function(e,n){var a,s,o,c,h,u,d,p,f=new i,m=[],g=this.polygonGroupEnd.length;for(d=0;d<g;d++){for(p=!0,c=[],a=0===d?0:this.polygonGroupEnd[d-1];a<this.polygonGroupEnd[d]&&p;a++)if(this.polygons[a].closed){for(h=[],s=this.polygons[a].points,o=0;o<s.length;o+=2)h.push(s[o],-s[o+1]);h.push(s[0],-s[1]),c.push(h)}else p=!1;if(c.length&&p)u=l(c,n),m=m.concat(u);else if(c.length)throw new Error("fill open polygon")}if(0===m.length)return null;for(var v=new Uint32Array(m.length/3),S=0;S<v.length;++S)v[S]=S;var _=[];for(S=0;S<m.length;S+=3)_.push(0,0,1);var y=t.createSimpleMeshNode({bufferPosition:m,bufferIndex:v,glType:r.ConnectivityTypeEnum.TRIANGLES,material:e,bufferNormal:_});return f.addChild(y),f},_startNewPolygon:function(){this.currentPolygon.points.length>2&&this.polygons.push(this.currentPolygon),this.currentPolygon=this._createEmptyPolygon()},_createEmptyPolygon:function(){return{points:[],closed:!1,userData:null,id:a++}}}),o=function(){var e=new n.GluTesselator;return e.gluTessCallback(n.gluEnum.GLU_TESS_VERTEX_DATA,function(e,t){t[t.length]=e[0],t[t.length]=e[1],t[t.length]=e[2]}),e.gluTessCallback(n.gluEnum.GLU_TESS_BEGIN,function(e){e!==n.primitiveType.GL_TRIANGLES&&console.log("expected TRIANGLES but got type: "+e)}),e.gluTessCallback(n.gluEnum.GLU_TESS_ERROR,function(e){console.log("error callback"),console.log("error number: "+e)}),e.gluTessCallback(n.gluEnum.GLU_TESS_COMBINE,function(e,t,i){return[e[0],e[1],e[2]]}),e.gluTessCallback(n.gluEnum.GLU_TESS_EDGE_FLAG,function(e){}),e}();function l(e,t){o.gluTessNormal(0,0,1);var i=[];o.gluTessBeginPolygon(i);for(var r=0;r<e.length;r++){o.gluTessBeginContour();for(var n=e[r],a=0;a<n.length;a+=2){var s=[n[a],n[a+1],t];o.gluTessVertex(s,s)}o.gluTessEndContour()}return o.gluTessEndPolygon(),i}return s}),define("DS/Visualization/DecalManager",["DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS"],function(e,t,i){"use strict";var r=1,n=1,a=0,s=new Map,o=!1,l=function(e){e.setPickable(o?t.PICKABLE:t.PICKTHROUGH),o?e.excludeFromHighlight(!1,!1):e.excludeFromHighlight(!0,!0)},c=function(){this.activated=!1,this._creatingDecal=!1};c.prototype={_attachViewer:function(e){s.has(e)||s.set(e,new Set)},detachViewer:function(e){s.delete(e)},createDecal:function(t){if(!(!!i.supportedExtensions.textureHalfFloat&&!!i.supportedExtensions.renderToHalfFloatTexture&&!!i.supportedExtensions.textureHalfFloatLinear||!!i.supportedExtensions.textureFloat&&!!i.supportedExtensions.renderToFloatTexture&&!!i.supportedExtensions.textureFloatLinear))return console.error("Error: float/half float textures not supported, decals disabled"),null;if(!i.supportedExtensions.fragDepth)return console.error("Error: frag depth not supported, decals disabled"),null;if(!t.material&&!t.materialApplication)return console.error("Error: you need to give a material to a decal node"),null;if(t.material&&!t.material.isPhysicalMaterial)return console.error("Error: unsupported decal material, expected PhysicalMaterial"),null;if(t.materialApplication&&!t.materialApplication._material&&!t.materialApplication._material.isPhysicalMaterial)return console.error("Error: unsupported decal material, expected PhysicalMaterial"),null;this._creatingDecal=!0;var r=new i.Matrix4,n=t.material,a=t.materialApplication;t.matrix&&(r=t.matrix);var s=e.createCuboidNode({cornerPoint:new i.Vector3(-.5,-.5,-.5),firstAxis:new i.Vector3(1,0,0),secondAxis:new i.Vector3(0,1,0),thirdAxis:new i.Vector3(0,0,1),_decal:!0});return s._setHasExplicitUv(!!t.explicitUv),a?s.setMaterialApplication(a):s.setMaterial(n),s.setMatrix(r),l(s),s.setVisibilityInTree(!1),this._creatingDecal=!1,s},updateDecalsPickable:function(e){o=e,s.forEach(function(e,t,i){e.forEach(function(e,t,i){l(e)})})},updateDecalsData:function(e,t){this._attachViewer(e),r=1,n=0,a=0;var i=this.activated;i&&t&&(i=s.get(e).size>0);if(i){var o=new Set;s.set(e,o),this._updateDecalsData(e.getRootNode()._occurrences[0],o,!1)}},_updateDecalsData:function(e,t,i){if(!e.node._isDecal){var s=e.node.decalCount>0;if(s){a++,n++;for(var o=0;o<e.children.length;o++){(l=e.children[o]).node._isDecal&&(l.renderable._decalData={key:0,stencilID:n,explicitUv:l.node._getHasExplicitUv(),needDrawUvs:!1},i=i||l.renderable._decalData.explicitUv,t.add(l.node),l.renderable._flagAsGSSOInvalidated())}}for(o=0;o<e.children.length;o++)this._updateDecalsData(e.children[o],t,i);if(e.renderable&&(e.renderable._decalData=a>0?{key:4*r,stencilID:n,explicitUv:!1,needDrawUvs:i}:null,e.renderable._flagAsGSSOInvalidated()),s){a--;for(o=0;o<e.children.length;o++){var l;(l=e.children[o]).node._isDecal&&(l.renderable._decalData.key=4*r+1,l.renderable._flagAsGSSOInvalidated())}r++}}},displayDecalInfo:function(e){console.clear(),this._displayInfo(e.getRootNode()._occurrences[0],0)},_displayInfo:function(e,t){for(var i="",r=0;r<t;r++)i+=" ";if(e.renderable){var n=e.renderable;console.log(""),console.log(i+(e.node._isDecal?"decal:":"geometry:")),n._decalData&&(console.log(i+" key: "+n._decalData.key),console.log(i+" stencil: "+n._decalData.stencilID))}var a=2*t+2;for(r=0;r<e.children.length;r++)this._displayInfo(e.children[r],a)}};var h=new c;return i.DecalManager=h,h}),define("DS/Visualization/PlaneGrid",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/TextNode"],function(e,t,i,r,n){"use strict";var a=(new i.Color).setRGB(1,1,1),s=(new i.Vector3(0,0,1),new i.Vector3(0,0,-1),new i.Vector3(1,0,0)),o=new i.Vector3(0,1,0),l=new i.Vector3(0,0,1),c=new i.Vector3(-1,0,0),h=new i.Vector3(0,-1,0),u=new i.Vector3(0,0,-1),d=new i.Vector3,p=new i.Vector2,f=new i.Vector2;return Math.round10||(Math.round10=function(e,t){return function(e,t,i){return void 0===i||0==+i?Math[e](t):(t=+t,i=+i,isNaN(t)||"number"!=typeof i||i%1!=0?NaN:(t=t.toString().split("e"),+((t=(t=Math[e](+(t[0]+"e"+(t[1]?+t[1]-i:-i)))).toString().split("e"))[0]+"e"+(t[1]?+t[1]+i:i))))}("round",e,t)}),e.extend({init:function(e){this.viewer=e,this.worldOrientation=null,this.position=new i.Vector3,this.size=100,this.displayLabels=!1,this.gridLabels=null,this.labelColor=a,this.labelCB=null,this.displayLabelCB=null,this.labels={rightNS:[],rightWE:[],bottomNS:[],bottomWE:[],all:[]},this.displayGrid=e.displayGrid,this.displayGridFromBelow=e.displayGridFromBelow,this.gridScreenSize=50,this.gridNbSteps=e.gridNbSteps,this.gridUnit=1,this.gridOffset=new i.Vector2,this.gridCoeff=0,this.gridFalloff=0,this.gridColor=e.gridColor,this.displayPlane=1,this.planeFalloff=0,this.planeColor=e.planeColor,this.planeOpacity=1,this.planeTexture=null,this.planeTextureScale=1,this._onlyDiffuse=!1,this.planeBorder=!1,this.edgeColor=new i.Color,this.mesh=null,this.matrix=new i.Matrix4,this.material=null,this.gridTextures={},this.viewProjMatrix=new i.Matrix4,this.tmpFrustum=new i.Frustum,this.tmpPoly1=new i.CGPolygon,this.tmpPoly2=new i.CGPolygon,this.tmpLine=new i.Line3(new i.Vector3,new i.Vector3)},setGridNbSteps:function(e){this.gridNbSteps=e,this.setGridTextures()},setLabels:function(e){if(e!==this.displayLabels){if(this.displayLabels=e,e&&!this.gridLabels){this.gridLabels=new n("gridLabels"),this.gridLabels.setBillboard(!0,!0),this.gridLabels.setFixedSize(!0),this.gridLabels._setProjectionSpace(!0);var t=this.gridLabels._occurrences[0].renderable;t.renderDepth=0,t.receiveShadow=!1,this.viewer.sceneBackground.add(t)}this.gridLabels&&(this.gridLabels.setVisibility(e),this.gridLabels.setVisibilityFree(e))}},setLabelColor:function(e){this.labelColor=new i.Color,this.labelColor.set(e)},setLabelCallback:function(e){this.labelCB=e},setDisplayLabelCallback:function(e){this.displayLabelCB=e},getUnitGridTexture:function(e){if(this.gridTextures[e])return this.gridTextures[e];for(var t=new Uint8Array(e*e),r=0;r<e;++r)t[r]=255,t[e*(e-1)+r]=255,t[e*r]=255,t[e*r+e-1]=255;var n=new i.DataTexture(t,e,e,i.AlphaFormat,i.UnsignedByteType,new i.UVMapping,i.RepeatWrapping,i.RepeatWrapping,i.LinearFilter,i.LinearMipMapLinearFilter,16);return n.needsUpdate=!0,this.gridTextures[e]=n,n},setGridTextures:function(){if(this.material){var e=this.gridNbSteps/2,t=i.ImageUtils.nearest_pow2(64*e),r=i.ImageUtils.nearest_pow2(64*e*e),n=Math.min(i.ImageUtils.nearest_pow2(64*e*e*e),4096);this.material.updatePDSFXUniform("gridTexture",this.getUnitGridTexture(64)),this.material.updatePDSFXUniform("gridTexture2",this.getUnitGridTexture(t)),this.material.updatePDSFXUniform("gridTexture3",this.getUnitGridTexture(r)),this.material.updatePDSFXUniform("gridTexture4",this.getUnitGridTexture(n))}},createPlaneGrid:function(e,t,n,a,s,o){this.size=e,this.position=t,this.worldOrientation=n.getWorldOrientation();var l=this.worldOrientation.upVector,c="zup"===this.worldOrientation._woName;this.computeGridUnit(n.camera,Math.abs(n.camera.position.dot(l)-this.position.dot(l)));var h=this.gridNbSteps*this.gridUnit;if(this.gridOffset.x=a?t.x-h*Math.floor(t.x/h):0,c?this.gridOffset.y=a?t.y-h*Math.floor(t.y/h):0:this.gridOffset.z=a?t.z-h*Math.floor(t.z/h):0,!this.mesh){this.material=new i.PlaneMaterial,this.material.setPlaneV2(!0),this.material.ambient.copy(new i.Color(328965)),this.setGridTextures();var u=r.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:this.material});u.setVisibilityFree(!0),this.mesh=u._occurrences[0].renderable,this.mesh.frustumCulled=!1,this.mesh.receiveShadow=!1,this.mesh.renderDepth=1,this.viewer.sceneBackground.add(this.mesh),this.mesh.pickable=!1}this.mesh.visible=!0;var d=new i.Vector3,p=new i.Vector3,f=(new i.Matrix4).copy(s);d.copy(this.worldOrientation.frontVector),d.multiplyScalar(t.x-.5*e),p.copy(this.worldOrientation.rightVector),p.multiplyScalar(t.y-.5*e),d.add(p),p.copy(this.worldOrientation.upVector),p.multiplyScalar(t.z),d.add(p),f.setPosition(d),f.scale(new i.Vector3(e,e,e)),this.mesh.setMatrix(f),this.material.updatePDSFXUniform("displayPlane",this.displayPlane),this.material.updatePDSFXUniform("displayGrid",this.displayGrid),this.material.updatePDSFXUniform("gridFromBelow",this.displayGridFromBelow),this.material.color.copy(this.planeColor),this.material.updatePDSFXUniform("planeOpacity",this.planeOpacity),this.material.setPlaneTexture(this.planeTexture),this.material.updatePDSFXUniform("uvScale",this.planeTextureScale);var m=new i.Color;m.copyToLinear(this.edgeColor,o),this.material.updatePDSFXUniform("border",m),this.material.updatePDSFXUniform("attenuation",this.viewer.planeAttenuation?1:0),this.material.updatePDSFXUniform("planeBorder",this.planeBorder?1:0),this.material.updatePDSFXUniform("planeFalloff",this.planeFalloff),this.material.updatePDSFXUniform("gridFalloff",this.gridFalloff),this.material.updatePDSFXUniform("gridUnit",this.gridUnit),this.material.updatePDSFXUniform("gridOffset",this.gridOffset),this.material.updatePDSFXUniform("gridCoeff",this.gridCoeff);var g=new i.Color;g.copyToLinear(this.gridColor,o),this.material.updatePDSFXUniform("gridColor",g),this.material.updatePDSFXUniform("planeSize",e),this.material.updatePDSFXUniform("nbSteps",this.gridNbSteps),this.material.updatePDSFXUniform("onlyDiffuse",this._onlyDiffuse)},computeGridUnit:function(e,t){var r=1;e instanceof i.PerspectiveCamera?r=2*this.gridScreenSize*Math.tan(Math.PI*e.fov/360)*t/this.viewer._getDivClientHeight():e instanceof i.OrthographicCamera&&(r=this.gridScreenSize*(e.top-e.bottom)/this.viewer._getDivClientHeight());for(var n=1/(this.gridNbSteps*this.gridNbSteps);n<r;)1===this.gridNbSteps?n++:n*=this.gridNbSteps,0;this.gridUnit=n,1===this.gridNbSteps?this.gridCoeff=r-n-1:this.gridCoeff=(r-n/this.gridNbSteps)/(n-n/this.gridNbSteps)},updateLabels:function(e){if(this.displayLabels&&(this.cleanLabels(),this.computeLabelPositions(e.camera),this.displayLabelsFunc(),this.gridLabels)){var t=this.gridLabels.textMaterial;t.updatePDSFXUniform("invSize",new i.Vector2(1/this.viewer.renderer.deviceWidth,1/this.viewer.renderer.deviceHeight)),t.updatePDSFXUniform("screenRatio",this.viewer.renderer.deviceWidth/this.viewer.renderer.deviceHeight)}},addLabel:function(e,t,r,n,a,f,m){var g="x"===f?s:"y"===f?o:l,v={string:e,anchor:t,color:this.labelColor,size:20*i.getDevicePixelRatio(),lineLength:500,up:this.worldOrientation.upVector,right:g,isRight:!1},S=this.gridLabels.getTextExtent(v),_=Math.abs(S.max.x-S.min.x),y=Math.abs(S.max.y-S.min.y);S.min.x=-y,S.min.y=-y,S.max.x=y,S.max.y=y,S.translate(r),d.addVectors(t,g);var x=this.viewer.currentViewpoint.project(d,m);p.set(x.x-r.x,x.y-r.y),p.normalize(),p.x<0&&(v.right="x"===f?c:"y"===f?h:u);var M=!1;if(a?(M=!0,p.x>0&&p.negate()):((p.x<0&&p.y<0||p.x>0&&p.y>0)&&(M=!0),p.x>0&&p.y>0&&p.negate()),M&&(p.multiplyScalar(_),r.x+=p.x,r.y+=p.y),v.anchor=this.viewer.currentViewpoint.unProject(r,m),v.right=(new i.Vector3).addVectors(v.anchor,v.right),v.anchor.applyProjection(this.viewProjMatrix),v.right.applyProjection(this.viewProjMatrix),p.set(v.right.x-v.anchor.x,v.right.y-v.anchor.y),p.normalize(),v.right.copy(v.anchor),v.right.x+=p.x,v.right.y+=p.y,!this.displayLabelCB)for(var P=0;P<n.length;P++)if(S.isIntersectionBox(n[P]._text.labelExtent))return;var C={token:null,_text:v,isRight:a,display:!0};n.push(C),this.labels.all.push(C)},isBottomRightEdge:function(e){return!(e.x<2)&&!(e.y<2)},isRightEdgeFunc:function(e){return e.x>this.viewer.SCREEN_WIDTH-2},isInsideFrustum:function(e){return!(e.x<-1||e.x>this.viewer.SCREEN_WIDTH+1)&&(!(e.y<-1||e.y>this.viewer.SCREEN_HEIGHT+1)&&!(e.z<-1.001||e.z>1.001))},cleanLabels:function(){for(var e=0;e<this.labels.all.length;e++)null!==this.labels.all[e].token&&this.gridLabels.removeText(this.labels.all[e].token);this.labels={rightNS:[],rightWE:[],bottomNS:[],bottomWE:[],all:[]}},displayLabelsFunc:function(){this.displayLabelCB&&this.displayLabelCB(this.labels.all);for(var e=0;e<this.labels.all.length;e++){var t=this.labels.all[e];if(t.display){if(t.offset||t.offsetFromScreenEdge||t.offsetFromAxis){var r=t.offset?t.offset.x:0,n=t.offset?t.offset.y:0;p.set(.5*this.viewer.SCREEN_WIDTH*(t._text.right.x-t._text.anchor.x),.5*this.viewer.SCREEN_HEIGHT*(t._text.right.y-t._text.anchor.y)),p.normalize(),f.set(-p.y,p.x),(t.isRight||p.y<0)&&p.negate(),!t.isRight&&p.y<0&&f.negate(),f.multiplyScalar(t.offsetFromAxis||0),p.multiplyScalar(t.offsetFromScreenEdge||0),t._text.anchor.x+=2*(r+f.x+p.x)/this.viewer.SCREEN_WIDTH,t._text.anchor.y+=2*(n+f.y+p.y)/this.viewer.SCREEN_HEIGHT,t._text.right.x+=2*(r+f.x+p.x)/this.viewer.SCREEN_WIDTH,t._text.right.y+=2*(n+f.y+p.y)/this.viewer.SCREEN_HEIGHT}t.size&&(t._text.size=t.size*i.getDevicePixelRatio()),t.color&&(t._text.color=t.color);var a=this.gridLabels.addText(t._text);t.token=a}}},computeIntersectionsForLabels:function(e,t,i,r,n,a,s){var o="zup"===this.worldOrientation._woName,l=o?"y":"x",c=o?"z":"y",h=this.labels.rightWE,u=this.labels.bottomWE,d="E",p="W";o?"y"===e&&(l="x",d="N",p="S"):"x"===e&&(l="z",d="N",p="S");var f=Math.round((t.min[e]-this.position[e])/this.gridUnit),m=Math.round((t.max[e]-this.position[e])/this.gridUnit);i<0?m=Math.min(f+1e3,m):f=Math.max(m-1e3,f);for(var g=this.tmpLine,v=f;v<=m;v++){g.start[e]=v*this.gridUnit+this.position[e],g.start[l]=-.5*this.size+this.position[l],g.start[c]=this.position[c],g.end[e]=g.start[e],g.end[l]=.5*this.size+this.position[l],g.end[c]=this.position[c];var S=r.planes[n].intersectLine(g),_=S&&a.project(S,s),y=!!S&&this.isInsideFrustum(_)&&this.isBottomRightEdge(_),x=y&&this.isRightEdgeFunc(_);if(y){var M,P=v*this.gridUnit+this.position[e],C=Math.round10(P,-2),b=C>=0;M=this.labelCB?this.labelCB(P,b?d:p):Math.abs(C)+" "+(b?d:p),this.addLabel(M,S,_,x?h:u,x,l,s)}}},removeMesh:function(){this.mesh&&this.viewer.sceneBackground.remove(this.mesh)},updateVisibility:function(){this.material&&(this.material.updatePDSFXUniform("displayPlane",this.displayPlane),this.material.updatePDSFXUniform("displayGrid",this.displayGrid),this.material.updatePDSFXUniform("gridFromBelow",this.displayGridFromBelow))},computeLabelPositions:function(){var e=this.viewer.currentViewpoint,t="zup"===this.worldOrientation._woName,r=this.viewer.cameraBackground;this.viewProjMatrix.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse);var n=this.tmpFrustum;n.setFromMatrix(this.viewProjMatrix);var a=n.getCorners(),s=this.tmpPoly1;s.addPoints([(new i.Vector3).copy(a[0]),(new i.Vector3).copy(a[1]),(new i.Vector3).copy(a[5]),(new i.Vector3).copy(a[4])]);var o=this.tmpPoly2;o.addPoints([(new i.Vector3).copy(a[1]),(new i.Vector3).copy(a[2]),(new i.Vector3).copy(a[6]),(new i.Vector3).copy(a[5])]);var l=new i.Plane,c=(new i.Vector3).copy(this.worldOrientation.upVector);c.multiplyScalar(-1),l.setFromNormalAndCoplanarPoint(c,this.position);var h,u,d,p,f=s.clipByPlane(l,new i.CGPolygon),m=o.clipByPlane(l,new i.CGPolygon),g=new i.Vector3,v=new i.Vector3,S=null,_=null;2===f.corner.length&&(g.subVectors(f.corner[1],f.corner[0]),g.normalize(),h=g.dot(this.worldOrientation.frontVector),u=g.dot(this.worldOrientation.rightVector),S=(new i.Box3).setFromPoints([f.corner[0],f.corner[1]])),2===m.corner.length&&(v.subVectors(m.corner[1],m.corner[0]),v.normalize(),d=v.dot(this.worldOrientation.frontVector),p=v.dot(this.worldOrientation.rightVector),_=(new i.Box3).setFromPoints([m.corner[0],m.corner[1]])),Math.abs(h)>.707?(S&&this.computeIntersectionsForLabels(t?"x":"z",S,h,n,2,e,r),_&&this.computeIntersectionsForLabels(t?"y":"x",_,p,n,0,e,r)):(S&&this.computeIntersectionsForLabels(t?"y":"x",S,u,n,2,e,r),_&&this.computeIntersectionsForLabels(t?"x":"z",_,d,n,0,e,r)),this.gridLabels.setFrustumCulled(!1)}})}),define("DS/Robot/RobotUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/GeometryHelper","WebappsUtils/WebappsUtils","DS/Visualization/SceneGraphFactory"],function(e,t,i,r){"use strict";return{createRobotRectangle:function(i,n,a,s,o){var l,c={width:a,height:s,fill:!0,fillColor:null,noEdge:!0},h=(new t).createRectangle(c),u=e.ImageUtils._loadTextureVisu("Robot","models/textures/"+o,void 0,n,n,e.ImageUtils.crossOriginPolicy);u.flipY=!1,u.minFilter=e.LinearMipMapLinearFilter,(l=new e.MeshBasicMaterial({map:u,side:e.DoubleSide,transparent:!0,alphaTest:.05,enableClipPlanes:!1,opacity:i?0:1})).force=!0;var d=r.createMeshNode(h,l);return d.setShadow(!1),d.setFrustumCulled(!1),d.excludeFromCSO(!0),d.excludeFromHighlight(!0,!0),{node:d,material:l}},createSmallTranslationRectangle:function(e,t){var i=e?"PlaneTranslationNode_picking.png":"PlaneTranslationNode.png";return this.createRobotRectangle(e,t,6,6,i)},createSmallRotationRectangle:function(e,t){var i=e?"Arc_picking.png":"Arc.png";return this.createRobotRectangle(e,t,8.5,8.5,i)},createBigTranslationRectangle:function(e,t){var i=e?"Translation_FullPlane_picking.png":"Translation_FullPlane.png";return this.createRobotRectangle(e,t,15,15,i)},createBigRotationRectangle:function(e,t){var i=e?"Rotation_FullArc_picking.png":"Rotation_FullArc_B.png";return this.createRobotRectangle(e,t,17,17,i)},createTranslationRectangle:function(e,t,i){return i?this.createBigTranslationRectangle(e,t):this.createSmallTranslationRectangle(e,t)},createRotationRectangle:function(e,t,i){return i?this.createBigRotationRectangle(e,t):this.createSmallRotationRectangle(e,t)},disposeMaterial:function(e,t){var i=t[e];i&&(i.map.dispose(),i.map=null,i.dispose(),t[e]=null)}}}),define("DS/SceneGraphNodes/FixedSizeArrowNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory","DS/Visualization/MaterialApplication"],function(e,t,i,r,n,a,s,o){"use strict";var l=[],c={},h={},u=t.extend({init:function(i){this._parent(i.name),this.matInherit=window.newMaterialInheritance,this._arrowWidth=i.arrowWidth,this._arrowLength=i.arrowLength,this._headLength=i.headLength?i.headLength:this._arrowLength/8,this._headWidth=i.headWidthToHeightRatio?i.headWidthToHeightRatio*this._headLength:this._headLength,this.globalSelection=i.globalSelection,this._color=i.color,this._threeColor=(new e.Color).setRGB(this._color.r,this._color.g,this._color.b),this._head=i.head,this._noZ=!i.removeNoZ,this._pickable=!!i.pickable;new a;var c=new e.Vector3(0,0,1),h=this._noZ?1:0,u=this._arrowLength-this._headLength,d=new t("myFixedSizeNodeG");if(this.globalSelection&&d.setPickParent(!0),this._head){var p=l[this._head],f=r.getWebappsAssetUrl("SceneGraphNodes",""),m=1===this._head?2:1,g=null,v=null,S=function(){};1===this._head?(g=c,v=(new e.Matrix4).rotateX(.5*Math.PI),p||(p=new e.ImageUtils.loadTexture(f+"models/textures/head.png",void 0,S,S,e.ImageUtils.crossOriginPolicy))):3===this._head?p||(p=new e.ImageUtils.loadTexture(f+"models/textures/headSquare.png",void 0,S,S,e.ImageUtils.crossOriginPolicy)):4===this._head?p||(p=new e.ImageUtils.loadTexture(f+"models/textures/headCross.png",void 0,S,S,e.ImageUtils.crossOriginPolicy)):2===this._head&&(p||(p=new e.ImageUtils.loadTexture(f+"models/textures/headDisk.png",void 0,S,S,e.ImageUtils.crossOriginPolicy))),l[this._head]=p,this._updateHeadMaterial();var _={width:this._headWidth,height:this._headLength,fill:!0,color:this._color,noEdge:!0,layerNb:h,material:this._headMaterial,cornerPoint:this._head>=2?new e.Vector2(-this._headWidth/2,-this._headLength/2):new e.Vector2(-this._headWidth/2,0)},y=s.createRectangleNode(_);y.setShadow(!1),y.setFrustumCulled(!1),this.matInherit&&(this._renderableHead=y._occurrences[0].renderable,this._gasHead=this._renderableHead.geometry[0].drawingGroups[0].gas,y.setMaterialApplication(new o({faceMaterial:this._headMaterial,layer:0})),this._headMaterial.useGASColor=!0,this._headMaterial.useGASOpacity=!0,y.setMaterialMode(!0)),this._pickable||y.setPickable(n.NOPICKABLE),this.globalSelection&&y.setPickParent(!0),y.name="Arrow's head";var x=new t("billBoardNode");this.globalSelection&&x.setPickParent(!0),x.addChild(y),x._setBillboardData(m,g,v);var M=new t("myFixedSizeNode");this.globalSelection&&M.setPickParent(!0),M.addChild(x),M._setFixedSizeCenter((new e.Vector3).copy(c).multiplyScalar(u/c.length()),1),d.addChild(M)}else u=this._arrowLength;this._updateBodyMaterial();var P={points:[new e.Vector3(0,0,0),new e.Vector3(0,0,u)],color:this._color,material:this._bodyMaterial,layerNb:h,width:this._arrowWidth},C=s.createLineNode(P);return C.setShadow(!1),C.setFrustumCulled(!1),this.globalSelection&&C.setPickParent(!0),this.matInherit&&(this._renderableBody=C._occurrences[0].renderable,this._gasBody=this._renderableBody.geometry[0].drawingGroups[0].gas,C.setMaterialMode(!1)),this._pickable||C.setPickable(n.NOPICKABLE),C.name="Arrow's body",d.addChild(C),d._setRatio(1),this.addChild(d),this},_updateHeadMaterial:function(){var t=this._threeColor.getHexString()+"_"+this._head;this._headMaterial=c[t],this._headMaterial||(this._headMaterial=new e.MeshBasicMaterial({map:l[this._head],side:e.DoubleSide,transparent:!0,alphaTest:.05,color:this._threeColor,force:!this.matInherit}),c[t]=this._headMaterial)},_updateBodyMaterial:function(){var t=this._threeColor.getHexString()+"_"+this._head+"_"+this._arrowWidth;this._bodyMaterial=h[t],this._bodyMaterial||(this._bodyMaterial=new e.LineBasicMaterial({side:e.DoubleSide,color:this._threeColor,force:!this.matInherit,linecap:"butt",lineWidth:this._arrowWidth}),h[t]=this._bodyMaterial)},setColor:function(e){this._color.copy(e),this._threeColor.setRGB(e.r,e.g,e.b),this._updateHeadMaterial(),this._updateBodyMaterial(),this.matInherit&&(this._gasHead.setParameters({colorRGB:this._threeColor}),this._gasBody.setParameters({colorRGB:this._threeColor}),this._renderableHead._flagAsGSSOInvalidated(),this._renderableBody._flagAsGSSOInvalidated())},setName:function(e){this._name=e},getNodeType:function(){return"FixedSizeArrowNode"}});return u.types={NONE:null,ARROW:1,DISK:2,SQUARE:3,CROSS:4},UWA.namespace("THREEDS/Nodes/FixedSizeArrowNode",u)}),define("SceneGraphNodes/FixedSizeArrowNode",["DS/SceneGraphNodes/FixedSizeArrowNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/FixedSizeArrowNode"),e}),define("DS/SceneGraphNodes/FixedSizePlaneNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory"],function(e,t,i,r,n,a,s,o,l){"use strict";var c=t.extend({init:function(i){this._parent(i.name),this.setColor(i.color),this.setName(i.name);var r=i.length1?i.length1:10,n=i.length2?i.length2:10,a=i.origin?i.origin:new e.Vector3,s=i.direction1?i.direction1.normalize():new e.Vector3(0,1,0),o=i.direction2?i.direction2.normalize():new e.Vector3(1,0,0),c=(new e.Vector3).crossVectors(s,o),h=l.createRectangleNode({color:this._color,width:r,height:n,fill:i.fill,sharing:i.sharing,cornerPoint:new e.Vector2(-r/2,-n/2)});h.setShadow(!1),h.setFrustumCulled(!1);var u=new e.Matrix4;u.makeBasis(s,o,c),u.setPosition(a);var d=new t("NodeForPlane");return d.setMatrix(u),d.addChild(h),this.addChild(d),d._setRatio(1),this},setColor:function(e){this._color=e},setName:function(e){this._name=e}});return UWA.namespace("THREEDS/Nodes/FixedSizePlaneNode",c)}),define("DS/Robot/XYRotationNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/WorldOrientation","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/RotationManipulator","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Robot/RobotUtils"],function(e,t,i,r,n,a,s,o,l){"use strict";var c=t.extend({init:function(t){var r=this;this._parent(t.name),this.axis=t.constraintAxis,this._modelEvent=new o,this.isPreactivated=!1,this.isManipulated=!1,this.enablePreactivate=!0,this.touchMode=t.touchMode,this._worldOrientation=null,this.manipulator=null,this._manipulatorToken=null,this._updateRepresentation(i.ZUpYRight),this.manipulator=new n({axis:this.axis}),this.manipulator.setExclusive(!0),this._manipulatorToken=this.manipulator.linkToNode(this),this.manipulator.onBeginManipulate(function(t){r._modelEvent.publish({event:"RotationBegin",data:t,context:this}),r.privilegedPlaneMat.opacity=1,r.privilegedPlaneMat.color=new e.Color("#1B6E9C"),r.isManipulated=!0}),this.manipulator.onManipulate(function(e){r._modelEvent.publish({event:"RotationManipulation",data:e,context:this})}),this.manipulator.onEndManipulate(function(t){r._modelEvent.publish({event:"RotationEnd",data:t,context:this}),r.isPreactivated?r.privilegedPlaneMat.color=new e.Color("#A1D9ED"):r.privilegedPlaneMat.color=new e.Color("#FFFFFF"),r.isManipulated=!1}),this.manipulator.onBeginPreactivate(function(t){r._modelEvent.publish({event:"BeginPreactivate",data:t,context:this}),!r.isManipulated&&r.enablePreactivate&&t.viewer.setTemporaryCursor("pointer"),r.isPreactivated=!0,!r.isManipulated&&r.enablePreactivate&&(r.privilegedPlaneMat.color=new e.Color("#A1D9ED")),t.viewer.render()}),this.manipulator.onEndPreactivate(function(t){r._modelEvent.publish({event:"EndPreactivate",data:t,context:this}),!r.isManipulated&&r.enablePreactivate&&t.viewer.unsetTemporaryCursor(),r.isPreactivated=!1,r.isManipulated||(r.privilegedPlaneMat.color=new e.Color("#FFFFFF")),t.viewer.render()}),this.manipulator.onPrimaryPointerClick(function(e){r._modelEvent.publish({event:"PrimaryPointerClick",data:e,context:this})})},_updateRepresentation:function(t){if(t!==this._worldOrientation){var r=this.manipulator;r&&(r.unlink(this._manipulatorToken),this._manipulatorToken=null),this.removeChildren(),l.disposeMaterial("privilegedPlaneMat",this),l.disposeMaterial("planeMatPicking",this);var n=t===i.ZUpYRight,s=l.createRotationRectangle(!1,null,n);this.privilegedPlaneMat=s.material;var o,c=s.node;if(o=n?(new e.Matrix4).setPosition(new e.Vector3(-8.5,-8.5,0)):new e.Matrix4,c.setMatrix(o),this.addChild(c),this.touchMode){c.setPickable(a.PICKTHROUGH);var h=l.createRotationRectangle(!0,null,n),u=h.node;this.planeMatPicking=h.material,u.setMatrix(o),this.addChild(u)}r&&(this._manipulatorToken=r.linkToNode(this)),this._worldOrientation=t}},setCenter:function(e){this.manipulator.setCenter(e)},setAxis:function(e){this.axis=e,this.manipulator.setAxis(e)},setParentManipulated:function(e){this.enablePreactivate=!e},setToGhostState:function(){this.privilegedPlaneMat.opacity=0},setToNonGhostState:function(){this.privilegedPlaneMat.opacity=1},_setWorldOrientation:function(e){this._updateRepresentation(e)}});return UWA.namespace("THREEDS/Robot/XYRotationNode",c)}),define("Robot/XYRotationNode",["DS/Robot/XYRotationNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Robot/XYRotationNode"),e}),define("DS/Robot/XZPlaneTranslationNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/WorldOrientation","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/PlaneTranslationManipulator","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/Robot/RobotUtils"],function(e,t,i,r,n,a,s,o,l){"use strict";var c=t.extend({init:function(t){var r=this;this._parent(t.name),this.axis=t.constraintAxis,this._modelEvent=new a,this.isPreactivated=!1,this.isManipulated=!1,this.enablePreactivate=!0,this.touchMode=t.touchMode,this._worldOrientation=null,this.manipulator=null,this._manipulatorToken=null,this._updateRepresentation(i.ZUpYRight),this.manipulator=new n({axis:this.axis}),this.manipulator.setExclusive(!0),this._manipulatorToken=this.manipulator.linkToNode(this),this.manipulator.onPrimaryPointerClick(function(e){r._modelEvent.publish({event:"PrimaryPointerClick",data:{node:this},context:this})}),this.manipulator.onBeginManipulate(function(t){r._modelEvent.publish({event:"PlaneTranslationBegin",data:t,context:this}),r.planeMat.opacity=1,r.planeMat.color=new e.Color("#1B6E9C"),r.isManipulated=!0}),this.manipulator.onManipulate(function(e){r._modelEvent.publish({event:"PlaneTranslationManipulation",data:e,context:this})}),this.manipulator.onEndManipulate(function(t){r._modelEvent.publish({event:"PlaneTranslationEnd",data:t,context:this}),r.isPreactivated?r.planeMat.color=new e.Color("#A1D9ED"):r.planeMat.color=new e.Color("#FFFFFF"),r.isManipulated=!1}),this.manipulator.onBeginPreactivate(function(t){r._modelEvent.publish({event:"BeginPreactivate",data:t,context:this}),!r.isManipulated&&r.enablePreactivate&&t.viewer.setTemporaryCursor("pointer"),r.isPreactivated=!0,!r.isManipulated&&r.enablePreactivate&&(r.planeMat.color=new e.Color("#A1D9ED")),t.viewer.render()}),this.manipulator.onEndPreactivate(function(t){r._modelEvent.publish({event:"EndPreactivate",data:t,context:this}),!r.isManipulated&&r.enablePreactivate&&t.viewer.unsetTemporaryCursor(),r.isPreactivated=!1,r.isManipulated||(r.planeMat.color=new e.Color("#FFFFFF")),t.viewer.render()})},_updateRepresentation:function(t){if(t!==this._worldOrientation){var r=this.manipulator;r&&(r.unlink(this._manipulatorToken),this._manipulatorToken=null),this.removeChildren(),l.disposeMaterial("planeMat",this),l.disposeMaterial("planeMat_picking",this);var n=t===i.ZUpYRight,a=l.createTranslationRectangle(!1,null,!n);this.planeMat=a.material;var s,c=a.node;if(s=n?(new e.Matrix4).rotateX(.5*Math.PI).translate(new e.Vector3(.5,.5,0)):(new e.Matrix4).rotateX(.5*Math.PI).translate(new e.Vector3(-7.5,-7.5,0)),c.setMatrix(s),this.addChild(c),this.touchMode){c.setPickable(o.PICKTHROUGH);var h=l.createTranslationRectangle(!0,null,!n),u=h.node;this.planeMat_picking=h.material,u.setMatrix(s),this.addChild(u)}r&&(this._manipulatorToken=r.linkToNode(this)),this._worldOrientation=t}},setAxis:function(e){this.axis=e,this.manipulator.axis=e},setParentManipulated:function(e){this.enablePreactivate=!e},setToGhostState:function(){this.planeMat.opacity=0},setToNonGhostState:function(){this.planeMat.opacity=1},_setWorldOrientation:function(e){this._updateRepresentation(e)}});return UWA.namespace("THREEDS/Robot/XZPlaneTranslationNode",c)}),define("Robot/XZPlaneTranslationNode",["DS/Robot/XZPlaneTranslationNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Robot/XZPlaneTranslationNode"),e}),define("DS/Robot/YZRotationNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/RotationManipulator","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Robot/RobotUtils"],function(e,t,i,r,n,a,s,o){"use strict";var l=t.extend({init:function(t){var i=this;this._parent(t.name),this.axis=t.constraintAxis,this._modelEvent=new s,this.isPreactivated=!1,this.isManipulated=!1,this.enablePreactivate=!0,this.touchMode=t.touchMode;var a=o.createSmallRotationRectangle(!1,null);this.planeMat=a.material;var l=a.node;if(l.setMatrix((new e.Matrix4).rotateY(-.5*Math.PI)),this.addChild(l),this.touchMode){l.setPickable(n.PICKTHROUGH);var c=o.createSmallRotationRectangle(!0,null);this.planeMat_picking=c.material;var h=c.node;h.setMatrix((new e.Matrix4).rotateY(-.5*Math.PI)),this.addChild(h)}this.manipulator=new r({axis:this.axis}),this.manipulator.setExclusive(!0),this.manipulator.linkToNode(this),this.manipulator.onBeginManipulate(function(t){i._modelEvent.publish({event:"RotationBegin",data:t,context:this}),i.planeMat.opacity=1,i.planeMat.color=new e.Color("#1B6E9C"),i.isManipulated=!0}),this.manipulator.onManipulate(function(e){i._modelEvent.publish({event:"RotationManipulation",data:e,context:this})}),this.manipulator.onEndManipulate(function(t){i._modelEvent.publish({event:"RotationEnd",data:t,context:this}),i.isPreactivated?i.planeMat.color=new e.Color("#A1D9ED"):i.planeMat.color=new e.Color("#FFFFFF"),i.isManipulated=!1}),this.manipulator.onBeginPreactivate(function(t){i._modelEvent.publish({event:"BeginPreactivate",data:t,context:this}),!i.isManipulated&&i.enablePreactivate&&t.viewer.setTemporaryCursor("pointer"),i.isPreactivated=!0,!i.isManipulated&&i.enablePreactivate&&(i.planeMat.color=new e.Color("#A1D9ED")),t.viewer.render()}),this.manipulator.onEndPreactivate(function(t){i._modelEvent.publish({event:"EndPreactivate",data:t,context:this}),!i.isManipulated&&i.enablePreactivate&&t.viewer.unsetTemporaryCursor(),i.isPreactivated=!1,i.isManipulated||(i.planeMat.color=new e.Color("#FFFFFF")),t.viewer.render()}),this.manipulator.onPrimaryPointerClick(function(e){i._modelEvent.publish({event:"PrimaryPointerClick",data:e,context:this})})},setCenter:function(e){this.manipulator.setCenter(e)},setAxis:function(e){this.axis=e,this.manipulator.axis=e},setParentManipulated:function(e){this.enablePreactivate=!e},setToGhostState:function(){this.planeMat.opacity=0},setToNonGhostState:function(){this.planeMat.opacity=1},_setWorldOrientation:function(e){}});return UWA.namespace("THREEDS/Robot/YZRotationNode",l)}),define("Robot/YZRotationNode",["DS/Robot/YZRotationNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Robot/YZRotationNode"),e}),define("DS/SceneGraphNodes/ArrowNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory"],function(e,t,i,r,n,a,s,o,l){"use strict";var c=new e.Vector3,h=new e.Matrix4,u=new e.Matrix4,d=new e.Matrix4,p=t.extend({init:function(i){this._parent(i.name),this._isDynamic=!0,this._headLength=i.headLength?i.headLength:20,this.viewpoint=i.viewpoint,this._initialPoint=i.initialPoint,this._finalPoint=i.finalPoint,this._head=i.head?i.head:0,this._noZ=!i.removeNoZ,this.direction=(new e.Vector3).subVectors(this._finalPoint,this._initialPoint),this.constraintAxis=(new e.Vector3).copy(this.direction).normalize(),this.arrowLength=this.direction.length();var r=a.getWebappsAssetUrl("SceneGraphNodes","");this.mapHead=new e.ImageUtils.loadTexture(r+"models/textures/head.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHeadDisk=new e.ImageUtils.loadTexture(r+"models/textures/headDisk.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHeadSquare=new e.ImageUtils.loadTexture(r+"models/textures/headSquare.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHeadCross=new e.ImageUtils.loadTexture(r+"models/textures/headCross.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHead.anisotropy=8,this.materialArrow=new e.LineBasicMaterial({side:e.DoubleSide,color:i.color,scale:i.arrowScale?i.arrowScale:6.666,lineWidth:i.arrowWidth?i.arrowWidth:1,dashType:i.arrowDashType?i.arrowDashType:"None",linecap:"butt",transparent:!0,isCPUPattern:!0,alphaTest:.05}),this.materialArrow.force=!0,this.materialHead=new e.MeshBasicMaterial({map:null,side:e.DoubleSide,color:i.color,transparent:!0,alphaTest:.05}),this.materialHead.force=!0;var s=new o;this.nodeArrowBody=l.createLineNode({points:[new e.Vector3(0,0,0),new e.Vector3(0,0,1)],material:this.materialArrow,layerNb:this._noZ?1:0}),this.nodeArrowBody.setShadow(!1),this.nodeArrowBody.setFrustumCulled(!1),this.nodeArrowBody.setPickParent(!0),this.nodeArrowBody.name="tronc de la flÃ¨che";var c={constraintAxis:this.constraintAxis,name:"billBoardNode_body",type:"Cylindrical",viewpoint:this.viewpoint};this.billBoardArrowBody=new n(c),this.billBoardArrowBody.addChild(this.nodeArrowBody),this.billBoardArrowBody.setPickParent(!0),this.addChild(this.billBoardArrowBody);var h=s.createRectangle({width:1,height:1,fill:!0,fillColor:null,noEdge:!0,layerNb:this._noZ?1:0});this.nodeArrowHead=l.createMeshNode(h,this.materialHead),this.nodeArrowHead.setShadow(!1),this.nodeArrowHead.setFrustumCulled(!1),this.nodeArrowHead.setPickParent(!0),this.nodeArrowHead.name="tÃªte de la flÃ¨che",this.billBoardArrowHead=new n({name:"billBoardNode_head",viewpoint:this.viewpoint}),this.billBoardArrowHead.addChild(this.nodeArrowHead),this.billBoardArrowHead.setPickParent(!0),this.nodeArrowHeadParent=new t,this.nodeArrowHeadParent.setPickParent(!0),this.addChild(this.nodeArrowHeadParent),this.nodeArrowHeadParent.addChild(this.billBoardArrowHead),this._updateData(),this.setMatrix((new e.Matrix4).setPosition(this._initialPoint)),this.name="CustomizableArrow";var u=this;return this.cbChange=function(e){u.viewpoint&&u.viewpoint!==e.viewpoint||"@onViewpointChange"===e.eventType&&u._CallBackEventHandler(e)},this.tokenChange=null,this},_onLinkedToSceneGraph:function(){this.tokenChange=i.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenChange)},_getDynamicMatrix:function(e,t,i){return this._CallBackEventHandler(t,i),this.getMatrix()},_CallBackEventHandler:function(e,t){var i=this.getMatrixWorld().getMaxScaleOnAxis();c.getPositionFromMatrix(this.nodeArrowHead.getMatrixWorld());var r=t||e.viewpoint,n=1/(i/r.camera.getWorldSizeFromPixelSize(1,c,r.viewer._getDivClientHeight()))*(this._head?this._headLength:0),a=this._head>=2?this.arrowLength:this.arrowLength-n;h.makeScale(n,n,n),u.makeScale(1,1,a),1===this._head?(this.nodeArrowHeadParent.setMatrix(d),c.set(-n/2,0,0),this.nodeArrowHead.setMatrix(h.rotateX(.5*Math.PI).setPosition(c)),c.copy(this.constraintAxis).multiplyScalar(a),h.identity(),this.nodeArrowHeadParent.setMatrix(h.setPosition(c))):2!==this._head&&3!==this._head&&4!==this._head||(c.set(-n/2,-n/2,0),this.nodeArrowHead.setMatrix(h.setPosition(c)),c.copy(this.constraintAxis).multiplyScalar(a),h.identity(),this.nodeArrowHeadParent.setMatrix(h.setPosition(c))),this.nodeArrowBody.setMatrix(u),this.billBoardArrowBody.cbChange(e),this.billBoardArrowHead.cbChange(e)},updateInitialPosition:function(t){this._initialPoint=t,this.setMatrix((new e.Matrix4).setPosition(this._initialPoint)),this._updateData(),this._CallBackEventHandler({viewpoint:this.viewpoint})},updateFinalPosition:function(e){this._finalPoint=e,this._updateData(),this._CallBackEventHandler({viewpoint:this.viewpoint})},updateColor:function(e){this.materialArrow.color=e,this.materialHead.color=e},setArrowWidth:function(e){this.materialArrow.setLineWidth(e),this._CallBackEventHandler({viewpoint:this.viewpoint})},setArrowPattern:function(e){this.materialArrow.setDashPatternType(e),this._CallBackEventHandler({viewpoint:this.viewpoint})},setArrowPatternScale:function(e){this.materialArrow.setScale(e),this._CallBackEventHandler({viewpoint:this.viewpoint})},setHeadSize:function(e){this._headLength=e,this._CallBackEventHandler({viewpoint:this.viewpoint})},setHeadType:function(e){this._head=e,this._updateData(),this._CallBackEventHandler({viewpoint:this.viewpoint})},getNodeType:function(){return"ArrowNode"},_updateData:function(){switch(this.direction.subVectors(this._finalPoint,this._initialPoint),this.constraintAxis.copy(this.direction).normalize(),this.arrowLength=this.direction.length(),this.billBoardArrowBody.setConstraintAxis(this.constraintAxis),this._head){case 0:this.billBoardArrowHead.setVisibility(!1),this.billBoardArrowHead.setVisibilityFree(!0);break;case 1:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setConstraintAxis(this.constraintAxis),this.billBoardArrowHead.setBillboardType("PseudoSpherical"),this.materialHead.map=this.mapHead;break;case 2:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setBillboardType("Spherical"),this.materialHead.map=this.mapHeadDisk;break;case 3:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setBillboardType("Spherical"),this.materialHead.map=this.mapHeadSquare;break;case 4:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setBillboardType("Spherical"),this.materialHead.map=this.mapHeadCross}this.materialHead._invalidateDisplayRangeLists(),this.materialHead.updateDeferredMaterials()}});return p.types={NONE:0,ARROW:1,DISK:2,SQUARE:3,CROSS:4},UWA.namespace("THREEDS/Nodes/ArrowNode",p)}),define("SceneGraphNodes/ArrowNode",["DS/SceneGraphNodes/ArrowNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/ArrowNode"),e}),define("DS/SceneGraphNodes/AxisSystemNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/FixedSizeArrowNode","DS/SceneGraphNodes/ArrowNode"],function(e,t,i,r,n,a,s,o,l,c){"use strict";var h=t.extend({init:function(t){this._parent(t.name),this._sgRep=t.sgRep?t.sgRep:null,this.headLength=t.headLength,this.arrowLength=t.arrowLength,this.arrowWidth=t.arrowWidth,this.sceneGraph=t.sceneGraph,this.viewpoint=t.viewpoint,this.zoomable=t.zoomable||!1,this._colorX=new s.Color(1,0,0),this._colorY=new s.Color(0,1,0),this._colorZ=new s.Color(0,0,1),t.colors&&(this._colorX=t.colors.colorX?t.colors.colorX:this._colorX,this._colorY=t.colors.colorY?t.colors.colorY:this._colorY,this._colorZ=t.colors.colorZ?t.colors.colorZ:this._colorZ),this._nameX="X",this._nameY="Y",this._nameZ="Z",t.names&&(this._nameX=t.names.nameX?t.names.nameX:this._nameX,this._nameY=t.names.nameY?t.names.nameY:this._nameY,this._nameZ=t.names.nameZ?t.names.nameZ:this._nameZ),this.head=t.head;var i={sceneGraph:this.sceneGraph,headLength:this.headLength,color:this._colorZ,arrowLength:this.arrowLength,arrowWidth:this.arrowWidth,head:this.head,name:this._nameZ,pickable:!0,viewpoint:this.viewpoint,removeNoZ:!0},r=null;this.zoomable?(i.initialPoint=new e.Vector3,i.finalPoint=new e.Vector3(0,0,this.arrowLength),r=new c(i)):r=new l(i);var n={sceneGraph:this.sceneGraph,headLength:this.headLength,direction:new e.Vector3(1,0,0),color:this._colorX,arrowLength:this.arrowLength,arrowWidth:this.arrowWidth,head:this.head,name:this._nameX,pickable:!0,viewpoint:this.viewpoint,removeNoZ:!0},a=null;this.zoomable?(n.initialPoint=new e.Vector3,n.finalPoint=new e.Vector3(this.arrowLength,0,0),a=new c(n)):(a=new l(n)).setMatrix((new e.Matrix4).rotateY(Math.PI/2));var o={sceneGraph:this.sceneGraph,headLength:this.headLength,color:this._colorY,arrowLength:this.arrowLength,arrowWidth:this.arrowWidth,head:this.head,name:this._nameY,pickable:!0,viewpoint:this.viewpoint,removeNoZ:!0},h=null;return this.zoomable?(o.initialPoint=new e.Vector3,o.finalPoint=new e.Vector3(0,this.arrowLength,0),h=new c(o)):(h=new l(o)).setMatrix((new e.Matrix4).rotateX(-Math.PI/2)),this.addChild(h),this.addChild(a),this.addChild(r),this.setNoZ(!0),this},getNodeType:function(){return"AxisSystemNode"},getSGRep:function(){return this._sgRep}});return h.types={NONE:null,ARROW:1,DISK:2},UWA.namespace("THREEDS/Nodes/AxisSystemNode",h)}),define("SceneGraphNodes/AxisSystemNode",["DS/SceneGraphNodes/AxisSystemNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/AxisSystemNode"),e}),define("DS/Visualization/SceneGraphUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Visualization/PathElement","DS/SceneGraphNodes/AxisSystemNode"],function(e,t,i,r,n,a,s,o,l,c,h,u,d,p){"use strict";var f=null,m={_getUniqueOccurrence(e){if(!e)return null;var t=e._getOccurrences();return 1!==t.length?null:t[0]},getCurrentVisibility:function(e){if(!e)return!1;for(var t=0;t<e.externalPath.length;t++){if(!e.externalPath[t].isVisible())return!1}return!0},_getDGorLayers:function(e,t){var i=[],r=e.layer;if(r)for(var n=r.layers.length,a=0;a<n;a++){var s=r.layers[a];s.drawableInterval.layerNum<=0||(t&&4!==s.drawableGroup.glType||i.push(s))}else{var o=e.geometry.length;for(a=0;a<o;a++)for(var l=e.geometry[a].drawingGroups,c=l.length,h=0;h<c;h++)t&&4!==l[h].glType||i.push(l[h])}return i},_getCurrentGraphicProperties:function(t,i,r,n,a){for(var s=[],o=t.getLastElement(!0),l=t._getRenderableOccurrences(i),c=0;c<l.length;c++){var h=l[c],u=h.visible,p=h.layer,f=h.matApp,m=h.meshMaterial,g=h.gas,v=new d(t.externalPath),S={path:v,materials:[],gas:[],visible:u};s.push(S);for(var _=[],y=h._occurrence;y.node!==o;)_.unshift(y.node),y=y.parent;for(var x=0;x<_.length;x++)v.addElement(_[x]);var M=this._getDGorLayers(h,!0);for(x=0;x<M.length;x++){var P=M[x],C=null;p&&(C=P.drawableInterval,P=P.drawableGroup);var b=P.glType,D=null,w=null,E=f&&f._getMaterialFromGLType(b,P._geomType),T=C&&C.material?C.material:P.material,A=C&&C.gas?C.gas:P.gas;T&&(T.isMatApp&&(D=T.solveInheritance(f,h._occurrence.depth)===f?E:T._getMaterialFromGLType(b,P._geomType)),D||T.isMatApp||(E?f:null,(D=E)||(D=T instanceof e.Material?T:null))),D||(f,D=E),!D&&m&&m.force&&(D=m),w=g?g.getMaterial(A,b,null,null):A.isGAS?A.getMaterial(null,b,null,null):A,r||(D=null),n||(w=null);for(var I=!1,R=0;R<S.materials.length;R++){var L=S.materials[R],O=S.gas[R];if(L===D&&O===w){I=!0;break}}I||(S.materials.push(D),S.gas.push(w))}}return s},getCurrentGraphicProperties:function(e){for(var t=[],i=this._getCurrentGraphicProperties(e.pathElement,e.viewer,e.getMaterial,e.getColor||e.getOpacity,e.getVisibility),r=0;r<i.length;r++)for(var n=i[r],a=0;a<n.materials.length;a++){var s={pathElement:n.path};e.getMaterial&&(s.material=n.materials[a]);var o=n.gas[a];e.getOpacity&&(s.opacity=o?o.isGAS?o._alpha:o.opacity:1),e.getColor&&(s.color=o?o.isGAS?o._color:o.color:null),e.getVisibility&&(s.visibility=n.visible),t.push(s)}return t},_getCurrentMaterialOrGAS:function(e,t){var i="matApp"===t?"material":t,r=m._getUniqueOccurrence(e);if(!r)return null;for(var n=null;!n&&r;){if(r[t])return r[t];if(n=r.renderable){if(n[t])return n[t];var a=null;if(n.layer)for(var s=0;s<n.layer.layers.length;s++){var o=n.layer.layers[s];if(!(o.drawableInterval.layerNum<=0)&&(a=o.drawableInterval[i],4===o.drawableGroup.glType&&o.drawableInterval[i]))return a}else for(s=0;s<n.geometry.length;s++)for(var l=n.geometry[s],c=0;c<l.drawingGroups.length;c++){var h=l.drawingGroups[c];if(a=h[i],4===h.glType&&h[i])return a}return a}if(1!==r.children.length)break;r=r.children[0]}return null},getCurrentOpacity:function(e){var t=this._getCurrentMaterialOrGAS(e,"gas");return t?t.isGAS?t._alpha:t.opacity:1},getCurrentColor:function(e){var t=this._getCurrentMaterialOrGAS(e,"gas");return t?t.isGAS?t._color:t.color:null},getCurrentMaterial:function(e,t){var i=this._getCurrentMaterialOrGAS(e,"matApp");return i?"Face"===t?i._material:"GeomFace"===t?i._materialGeomFace:"Line"===t?i._materialLine:"Point"===t?i._materialPoint:i._material?i._material:i._materialGeomFace?i._materialGeomFace:i._materialLine?i._materialLine:i._materialPoint?i._materialPoint:null:null},applyMaterialToOccurrencePath:function(e,t,i){var r,n=e._getRenderableOccurrencesFromOccurrencePath(t);for(r=0;r<n.length;r++)n[r].material=i},applyMaterialToPath:function(e,t){return i._applyMaterialToPath(e,t)},applyVisibilityToPaths:function(e,t){for(var r=new Map,n=0;n<e.length;n++){for(var a=e[n],s=a._getRenderableOccurrences(),o=s.length,l=0;l<o;l++)(d=s[l])&&d._flagAsGSSOInvalidated();var c=a.getLastElement();if(null===c)return!1;if(c instanceof i)2===t?c.setVisibility(!c.visible,!0):c.setVisibility(t,!0);else if(1===o)if((p=r.get(s[0]))||(p=[],r.set(s[0],p)),"rep"===c.getType()){var h=c.getChildren();for(l=0;l<h.length;l++)p.push(h[l].sgNode)}else"primitive"===c.getType()&&p.push(c.sgNode)}const u=r[Symbol.iterator]();for(const e of u){var d=e[0],p=e[1];null===d.layer&&d.initLayers(1),d.layer.addPrimitivesToLayers(p,t)}},applyVisibilityToPath:function(e,t,r){if(null===e)return!1;var n=e._getRenderableOccurrences(),a=n.length;for(c=0;c<a;c++)(o=n[c])&&o._flagAsGSSOInvalidated();var s=e.getLastElement();if(null===s)return!1;if(r){if(1!==a)return!1;var o;null===(o=n[0]).layer&&o.initLayers(1),o.layer.addPrimitivesToLayers(r,t)}else if(s instanceof i)2===t?s.setVisibility(!s.visible,!0):s.setVisibility(t,!0);else{if(1!==a)return!1;r=[];if("rep"===s.getType())for(var l=s.getChildren(),c=0;c<l.length;c++)r.push(l[c].sgNode);else"primitive"===s.getType()&&r.push(s.sgNode);null===n[0].layer&&n[0].initLayers(1),n[0].layer.addPrimitivesToLayers(r,t)}return!0},getVisibilityFromPath:function(e){if(!e)return!1;var t=e._getRenderableOccurrences(),r=t.length,n=e.getLastElement();if(!n)return!1;if(n instanceof i)return n.isVisible();if(1!==r)return!1;var a,s=t[0];if(null===s.layer)return!0;if("rep"===n.getType()){var o=n.getChildren();o[0]&&(a=o[0].sgNode)}else"primitive"===n.getType()&&(a=n.sgNode);for(var l=a.getGroup(),c=a.getStart(),h=s.layer.layers,u=0;u<h.length;u++){var d=h[u];if(l===d.drawableGroup){var p=d.drawableInterval;if(!(c<p.start||c>=p.start+p.count))return 1===p.layerNum}}return!1},getOrientedBoundingBoxFromPathElements:function(t,i,r,n){for(var a=new e.Box3,s=(new e.Matrix4).extractRotation(i),o=0;o<t.length;++o){var l=t[o].getOrientedBoundingBox(i,r,null,null,null,!!n);l&&(a=a.union(l))}return{cornerPoint:(new e.Vector3).copy(a.min).applyMatrix4(i),firstAxis:new e.Vector3(a.max.x-a.min.x,0,0).applyMatrix4(s),secondAxis:new e.Vector3(0,a.max.y-a.min.y,0).applyMatrix4(s),thirdAxis:new e.Vector3(0,0,a.max.z-a.min.z).applyMatrix4(s),localBBox:a}},getMaterialsFromPath:function(e,t,i){e.getRootNode()._tryOverridesUpdate(e);var r=t._getUniqueOccurrence(),n=null,a=null,s=null;return r&&r.renderable&&(a=[],this._traversePathMaterials(r,function(e){a.indexOf(e)<0&&a.push(e)},function(){},null,!1),r.overrideLink&&(s={color:r.overrideLink.getColor(),opacity:r.overrideLink.getOpacity(),material:r.overrideLink.getFullMaterial()}),n={materials:a,overrides:s}),n},buildModelIdPath:function(e){var t,i,r,n={elements:[],subElements:[]},a=e.getLastElement();if(a instanceof p&&a._sgRep)t={id:a._sgRep.cgmId,namingContext:a._sgRep.namingContext},n.elements.push(t);else for(i=0;i<e.internalPath.length;i++)(r=e.internalPath[i].sgNode).getType&&3===r.getType()?n.subElements.push(r.getCgmId()):1!==r.type&&2!==r.type||(t={id:r.cgmId,namingContext:r.namingContext},n.elements.push(t));return n},buildPathElementFromModelIdPath:function(e,t){var i=e.getLastElement(!0);if(!(i instanceof r))return null;var s,o,l,c,h,u,p,f,m=null,g=t.elements,v=null,S=new a.SGPrimitiveHelper,_=!1;if(t.subElements.length>0&&(m=t.subElements[0])>0)for(s=0;s<i.mesh3js.geometry.length&&!_;s++)for(u=i.mesh3js.geometry[s],o=0;o<u.drawingGroups.length&&!_;o++)for(p=u.drawingGroups[o],l=0;l<p.getPrimitivesCount()&&!_;l++)if(S.set(p,l),S.getCgmId()===m){for(c=g.length-1,h=S.getRep();h&&c>=0&&h.cgmId===g[c].id;)h=h.parents[0],c--;!h&&c<0&&(_=!0)}if(_)(f=e._getUniqueOccurrence())&&(v=new d).setFromOccurrence(f,n.getFromSGNode(S));else if(1===g.length){var y=i.parents[0],x=y&&y.getChildByName("AxisSystems");if(x){for(s=0;s<x.children.length&&!_;s++){var M=x.children[s]._sgRep;M&&M.cgmId===g[0].id&&(_=x.children[s])}if(_){for(v=new d,s=0;s<e.externalPath.length&&e.externalPath[s]!==i;s++)v.addElement(e.externalPath[s]);v.addElement(x),v.addElement(_)}}}return v},buildPathesLeadingToNode:function(e,t){var i,r,n,a=[];for(i=0;i<e._occurrences.length;i++)r=e._occurrences[i],(n=new d).setFromOccurrence(r,null,t)&&a.push(n);return a},setRenderPriority:function(e,t,i){if(g.indexOf(t)<0)return console.warn("SceneGraphUtils.setRenderPriority invalid input priority value"),!1;var r=e._getUniqueOccurrence(i);if(r){var n=r.renderPriority,a={userPriority:null!==t,priority:t,userOpacity:!(!n||!n.userOpacity),opacity:n?n.opacity:null,lastRenderPriority:n?n.lastRenderPriority:-1};return r.renderPriority=a,r.node._forceUpdate(),!0}return console.warn("SceneGraphUtils.setRenderPriority error: invalid pathElement"),!1},setRenderPriorityOpacity:function(e,t,i){t||0===t||(t=null);var r=e._getUniqueOccurrence(i);if(r){var n=r.renderPriority,a={userPriority:!(!n||!n.userPriority),priority:n?n.priority:null,userOpacity:null!==t,opacity:t,lastRenderPriority:n?n.lastRenderPriority:-1};return r.renderPriority=a,r.node._forceUpdate(),!0}return console.warn("SceneGraphUtils.setRenderPriority error: invalid pathElement"),!1},_traversePathMaterials:function(t,i,r,n,a,s){if(null===t)return null;var o={};function l(e){var t=[],i=0;for(i=0;i<e.geometry.length;i++){var r=0,n=e.geometry[i];for(r=0;r<n.drawingGroups.length;r++){var a=n.drawingGroups[r];if(t[o[a.glType]]){if(t[o[a.glType]]!==a.gas)return null}else t[o[a.glType]]=a.gas}}return t}o[0]=0,o[3]=1,o[2]=1,o[1]=1,o[5]=2,o[6]=2,o[4]=2;var c=[];t.renderable&&c.push(t.renderable);for(var h=c.length,u=0;u<h;u++){var d=c[u],p=!s&&l(d);if(d.material&&d.material.force){var f=d.userData&&d.userData.oldMaterial?d.userData.oldMaterial:d.material;i(f,f,function(e){d.material=e},d)}else if(p){var m=p[2];m||(m=new e.MeshBasicMaterial),p[0]&&(m.point=p[0]),p[1]&&(m.line=p[1]),i(p[2],m,function(e){e.force=!0,d.material=e},d)}else if(a||d.layer){var g=0;for(g=0;g<d.layer.layers.length;g++){var v=d.layer.layers[g];s&&v.drawableGroup._geomType!==s||(v.drawableInterval.material?i(v.drawableInterval.material,v.drawableInterval.material,function(e){v.drawableInterval.material=e}):i(v.drawableGroup.gas,v.drawableGroup.gas,function(e){v.drawableInterval.material=e}))}}else{n&&n(d);var S=0;for(S=0;S<d.geometry.length;S++){var _=0,y=d.geometry[S];for(_=0;_<y.drawingGroups.length;_++){var x=y.drawingGroups[_];!x||s&&x._geomType!==s||i(x.gas,x.gas,function(e){d.layer.addPrimitivesToLayers(x.primitives,1,e)})}}}r()}},streamVisu:function(i){var r=["vertexIndexArray","vertexPositionArray","vertexNormalArray","vertexUvArray","vertexUv2Array","vertexTangentArray","vertexBinormalArray","vertexColorArray"],n=i.layers||!1,s=i.node?i.node:i,o=(i.nodejsContext,i.nodeCallback),l=i.imageCallback,c=i.loadedTexturesCallback,h=null,u=i.embeddedTextures||!1,d=0,p={textures:{},materials:{},geometries:{},nodes:{}},m=1e8,g=0,v=[{size:0,buffers:[],data:null}],S={json:p,chunks:v};function _(e){v[g].size+e.byteLength>m&&(v[++g]={size:0,buffers:[],data:null});var t=v[g],i=t.size;return t.buffers.push({buffer:new Uint8Array(e.buffer,e.byteOffset,e.byteLength),offset:i}),t.size+=e.byteLength,t.size%4&&(t.buffers.push({buffer:new Uint8Array(4-t.size%4),offset:t.size}),t.size+=4-t.size%4),i}function y(){d--,console.log("nb textures loading: "+d),h&&!d&&h(S)}function x(t,i){if(t.image)if(t.image.getContext||t.image.tagName&&"img"===t.image.tagName.toLowerCase()){if(t.sourceFile&&"blob:"===t.sourceFile.substring(0,5)){var r=new XMLHttpRequest;r.open("GET",t.sourceFile,!0),r.responseType="blob",r.onload=function(e){if(200===this.status){var t=this.response.type;i.format="image/jpeg"===t?"jpeg":"png",i.data=this.response,i.path="texture_"+i.id+"."+i.format,console.log("canvas blob"),y()}},r.send()}else if(t.image.getContext){var n=(l=t.image.getContext("2d")).getImageData(0,0,t.image.width,t.image.height);i.format="png",i.data=n,i.path="texture_"+i.id+"."+i.format,console.log("png"),y()}}else if(t.mipmaps&&t.mipmaps.length){var a=t.image.width,s=t.image.height;i.format="dds",i.data=new Blob([e.ImageUtils.streamDDS(t)],{type:"arraybuffer"}),i.path="texture_"+i.id+"."+i.format,console.log("dds"),y()}else{a=t.image.width,s=t.image.height;var o=f||document.createElement("canvas");o.width=a,o.height=s;for(var l,c=(n=(l=o.getContext("2d")).getImageData(0,0,a,s)).data,h=0;h<s;h++)for(var u=0;u<4*a;u++)c[4*(s-h-1)*a+u]=t.image.data[4*h*a+u];l.putImageData(n,0,0,0,0,a,s);var d=atob(o.toDataURL("image/png").split(",")[1]),p=new Array(d.length);for(h=0;h<d.length;h++)p[h]=d.charCodeAt(h);var m=new Uint8Array(p);i.format="png",i.data=new Blob([m],{type:"image/png"}),i.path="texture_"+i.id+"."+i.format,console.log("uncompressed"),y()}}function M(i,r){if(!r.textures[i.id]){var n={id:i.id,anisotropy:i.anisotropy,magFilter:i.magFilter,minFilter:i.minFilter,wrapS:i.wrapS,wrapT:i.wrapT,repeat:i.repeat};if(l)l(i,n);else if(u)if(i.loadEndStatus&&i.loadEndStatus!==e.AssetLoadingStatus.READY){if(i.loadEndStatus===e.AssetLoadingStatus.ERROR)return void console.log("texture was not loaded: impossible to embed it in streamvisu.");d++,console.log("nb textures loading: "+d),i.onLoadCallbacks.push(function(e){x(e,n)})}else d++,console.log("nb textures loading: "+d),x(i,n);else if(i.sourceFile){n.format=t.getExtension(i.sourceFile);var a=function(e){var t="";if("blob:"===e.substring(0,5))return null;if("http://"===e.substring(0,7))t=e;else if("https://"===e.substring(0,8))t=e;else if("/"===e.substring(0,1))t=e;else{if("file://"===e.substring(0,7))return null;var i=location.href,r=i.indexOf("?");-1!==r&&(i=i.substring(0,r));var n=i.lastIndexOf("/");-1!==n&&(i=i.substring(0,n+1)),t=i+e}return t}(i.sourceFile);a&&(n.path=a)}r.textures[i.id]=n}return i.id}function P(t,i){var r="MeshPhong";t instanceof e.LineBasicMaterial?r="LineBasic":t instanceof e.PhysicalMaterial?r="Physical":t instanceof e.MeshLambertMaterial&&(r="MeshLambert");var n={id:t.id,type:r,visible:t.visible,force:t.force,side:t.side,enableClipPlanes:t.enableClipPlanes,transparent:t.transparent,opacity:t.opacity,alphaTest:t.alphaTest,depthTest:t.depthTest,depthWrite:t.depthWrite};return t.color&&(n.color=t.color),(t instanceof e.MeshPhongMaterial||t instanceof e.MeshLambertMaterial||t instanceof e.PhysicalMaterial)&&(n.ambient=t.ambient,n.emissive=t.emissive,n.specular=t.specular,n.shininess=t.shininess,n.vertexColors=t.vertexColors,void 0!==t.glossiness&&(n.glossiness=t.glossiness),void 0!==t.metalness&&(n.metalness=t.metalness),t.map&&(n.diffuseMap=M(t.map,i)),t.bumpMap&&(n.bumpMap=M(t.bumpMap,i)),t.normalMap&&(n.normalMap=M(t.normalMap,i)),t.specularMap&&(n.specularMap=M(t.specularMap,i)),t.emissiveMap&&(n.emissiveMap=M(t.emissiveMap,i)),t.metalnessMap&&(n.metalnessMap=M(t.metalnessMap,i)),t.glossinessMap&&(n.glossinessMap=M(t.glossinessMap,i)),t.bumpMap&&void 0!==t.bumpScale&&(n.bumpScale=t.bumpScale),t.coating&&(n.coating=t.coating),t.coating&&void 0!==t.coatingGlossiness&&(n.coatingGlossiness=t.coatingGlossiness)),n}return s.traverse(function(t,i){var s=i.nodes[t.id];if(!s){var l=t.getNodeType();if(s={id:t.id,type:l},t._matrix&&!t._matrix.isIdentity()){var c=[];t._matrix.flattenToArray(c),s.matrix=c}if(t.material&&((j=i.materials[t.material.id])||(j=t.material,i.materials[t.material.id]=P(j,i)),s.material=t.material.id),i.nodes[t.id]=s,"Node3D"===l){for(var h=[],u=0;u<t.children.length;u++)h.push(t.children[u].id);s.children=h}else{var d=t._occurrences[0].renderable,p=d.boundingSphere,f=d.boundingBox;f||(f=p.getBoundingBox());var m=!1;if(n)for(u=0;u<t._occurrences.length;u++)if(t._occurrences[u].renderable.layer){m=!0;break}var v=[];for(u=0;u<d.geometry.length;u++){var S=d.geometry[u].id;v.push(S);var y=i.geometries[S];if(!y){y=d.geometry[u];var x={};x.id=y.id;for(var M=0;M<r.length;M++){var C=y[r[M]];if(C){var b=_(C),D={chunk:g,offset:b,byteLength:C.byteLength,bpe:C.BYTES_PER_ELEMENT,itemSize:C.itemSize};x[r[M]]=D}}for(x.dgs=[],M=0;M<y.drawingGroups.length;M++){var w=y.drawingGroups[M];n&&m&&(w.__id__=M);for(var E=w.getPrimitivesCount(),T=0,A=0;A<E;A++)(O=w.getPrimitiveDecoration(A))&&O.length&&(T+=O.length);var I=new Uint32Array(4*E),R=new Uint8Array(T),L=0;for(A=0;A<E;A++){var O,N=w.getPrimitiveCgmId(A),F=w.getPrimitiveRep(A),V=w.getPrimitiveStart(A),U=w.getPrimitiveCount(A);if(I[4*A]=N,I[4*A+1]=F?F.cgmId:0,I[4*A+2]=V,I[4*A+3]=U,(O=w.getPrimitiveDecoration(A))&&O.length){console.log(O.length),O.length>255&&console.log("panic"),R[L++]=O.length;for(var B=0;B<O.length;++B)R[L++]=O[B]}else R[L++]=0}b=_(I);var k={chunk:g,offset:b,byteLength:I.byteLength,bpe:I.BYTES_PER_ELEMENT,itemSize:I.itemSize},G=void 0;if(T){var z=_(R);G={chunk:g,offset:z,byteLength:R.byteLength,bpe:R.BYTES_PER_ELEMENT,itemSize:R.itemSize}}x.dgs[M]={start:w.start,count:w.count,geomType:a.GeomTypeString[w._geomType],glType:w.glType,primitives:k,canonicals:G},w.material instanceof e.Material?(i.materials[w.material.id]||(i.materials[w.material.id]=P(w.material,i)),x.dgs[M].material=w.material.id):w.gas&&(i.materials[w.gas.id]||(i.materials[w.gas.id]=P(w.gas,i)),x.dgs[M].gas=w.gas.id)}i.geometries[S]=x}}if(s.mesh3js={bs:{c:[p.center.x,p.center.y,p.center.z],r:p.radius},bbox:{min:[f.min.x,f.min.y,f.min.z],max:[f.max.x,f.max.y,f.max.z]},geometries:v},n&&m)for(s.occurrences={},u=0;u<t._occurrences.length;u++){var H=t._occurrences[u].renderable;if(H.layer){var W=[];for(s.occurrences[u]={index:u,layers:W},M=0;M<H.layer.layers.length;M++){var j,X=H.layer.layers[M],q={start:X.drawableInterval.start,count:X.drawableInterval.count,primitiveStart:X.drawableInterval.primitiveStart,primitiveCount:X.drawableInterval.primitiveCount,layerNum:X.drawableInterval.layerNum};X.drawableInterval.material&&(q.material=X.drawableInterval.material.id,(j=i.materials[q.material])||(j=X.drawableInterval.material,i.materials[q.material]=P(j,i))),W.push({geometry:X.geometry.id,drawableGroup:X.drawableGroup.__id__,drawableInterval:q})}}}d.material&&((j=i.materials[d.material.id])||(j=d.material,i.materials[d.material.id]=P(j,i)),s.mesh3js.material=d.material.id)}o&&o(t,s)}},p),p.nbChunks=v.length,c&&(h=c),S.chunks=function(){for(var e=0;e<v.length;e++){var t=v[e];t.data=new Uint8Array(t.size);for(var i=0;i<t.buffers.length;i++)for(var r=t.buffers[i],n=r.buffer,a=r.offset,s=0;s<n.byteLength;s++)t.data[a+s]=n[s]}return v}(),!d&&h&&h(S),S}},g=[0,1,2,3,4];return m}),define("DS/Visualization/SceneGraph",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Visualization/SceneGraphUtils"],function(e,t,i,r,n,a,s,o,l,c,h,u,d){"use strict";if(!window.undoSceneGraphMigrationStep2)return function(){}}),define("Visualization/SceneGraph",["DS/Visualization/SceneGraph","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SceneGraph"),e}),define("DS/Visualization/Viewpoint",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Animation/ANIM","DS/Animation/PropertyAnimation","DS/Animation/AnimationPath","DS/Visualization/TrackballControls","DS/Visualization/SceneGraph","DS/Visualization/SceneGraphUtils","DS/Visualization/Node3D","DS/Visualization/WorldOrientation","DS/WAFData/WAFData"],function(e,t,i,r,n,a,s,o,l,c,h,u){"use strict";var d=new i.Projector,p=new i.Matrix4,f=e.extend({init:function(e,t,r,n,a){var s,o,l;e.hasOwnProperty("viewer")?(this.viewer=e.viewer,this.projectionType=void 0!==e.projectionType?e.projectionType:f.PERSPECTIVE,s=void 0!==e.angle?e.angle:void 0!==e.fov?e.fov:45,e.fov&&console.warn("Deprecated. Use options.angle instead."),o=void 0!==e.near?e.near:10,l=void 0!==e.far?e.far:2500,c=void 0===e.defaultController||e.defaultController):(console.warn("Deprecated. You must use a litteral object to define your viewpoint."),this.viewer=e,s=void 0!==t?t:45,o=void 0!==r?r:10,l=void 0!==n?n:2500,this.projectionType=f.PERSPECTIVE,c=void 0===a||a),this._isMain=!1,this._worldOrientation=h.ZUpYRight,e.inactive||this.createDivCSS();var c,u=(this.viewer.canvas.offsetWidth?this.viewer._getCanvasOffsetWidth():1)/(this.viewer.canvas.offsetHeight?this.viewer._getCanvasOffsetHeight():1);return this.projectionType===f.PERSPECTIVE?this.camera=new i.PerspectiveCamera(s,u,o,l):(this.camera=new i.OrthographicCamera(0,0,0,0,o,l),this.camera.setVisualizedHeight(null,u,s)),this.camera._renderingRole=i._CameraRoles.PRINCIPAL,this._renderedCamera=this.camera,this.camera._viewpoint=this,this.robotCameraOrtho=new i.OrthographicCamera(0,0,0,0,o,l),this.camera.clone(this.robotCameraOrtho),this.robotCameraOrtho.setVisualizedHeight(null,u,s),this.robotCameraOrtho._viewpoint=this,this.robotCameraOrtho._renderingRole=i._CameraRoles.ROBOT_ORTHO,this.connectedRobotCamera=this.camera.clone(),this.connectedRobotCamera._viewpoint=this,this.connectedRobotCamera._renderingRole=i._CameraRoles.ROBOT_CONNECTED,this.target=new i.Vector3,this.position=new i.Vector3,this.sceneGraphRoot=null,this._internalSceneGraph=null,this.control=null,this._mePreferenceSetting=null,this._forcedController=null,this._2DModePreviousController=null,this._currentDefaultController="COMBINED",this._isMoving=!1,this.updateAnimation=function(e){},this._viewpointAnimation=null,this._frustum=new i.Frustum,this.setDefaultController(c),c||this.resetCameraOrientation(),this.viewer.internalSceneGraph&&this._updateRobotCamera(this.viewer.internalSceneGraph),this._customReframeCB=null,this._customCenterCameraCB=null,this._2DMode=!1,this._nativeTranslationOffset=null,this._nativeZoomType=null,this._nativeZoomRatio=null,this._nativeZoom=1,this._clip=0,this._bottomleftClip=null,this._toprightClip=null,this._anchor=0,this._XMaxTranslationBound=1e10,this._XMinTranslationBound=-1e10,this._YMaxTranslationBound=1e10,this._YMinTranslationBound=-1e10,this._depthMode=0,this._focusMode=f._FOCUS_MODE.TRANSLATION,this._SWXCoreViewManipulation=null,this._csiUID=null,this},createDivCSS:function(){this.divCameraCSSElement=UWA.createElement("div"),this.divCameraCSSElement.style.WebkitTransformStyle="preserve-3d",this.divCameraCSSElement.style.MozTransformStyle="preserve-3d",this.divCameraCSSElement.style.oTransformStyle="preserve-3d",this.divCameraCSSElement.style.transformStyle="preserve-3d",this.divCameraCSSElement.id="camera",this.viewer.divCss3DElement.appendChild(this.divCameraCSSElement),this.viewer.divCss3DElement.style.overflow="hidden",this.divCameraCSSElement.style.width=this.viewer.divCss3DElement.style.width,this.divCameraCSSElement.style.height=this.viewer.divCss3DElement.style.height},isMain:function(){return this._isMain},setCsiUID:function(e){this._csiUID=e},getCsiUID:function(){return this._csiUID},getWorldOrientation:function(){return this._worldOrientation},getCamera:function(){return this.camera},getCameraTarget:function(){return console.warn("DEPRECATED"),this.target},getCameraPosition:function(){return console.warn("DEPRECATED"),this.position},getControl:function(){return this.control},setEyePosition:function(e){var t=e.clone().add(this.getSightDirection().multiplyScalar(this.getTargetDistance()));this.control.setTarget(t),this.control.update()},getEyePosition:function(){return this.camera.position.clone()},setSightDirection:function(e){e.normalize();var t=this.camera.getLookAt();t.normalize();var r=Math.acos(e.clone().dot(t));if(r){var n=e.clone().cross(t);n.normalize();var a=(new i.Quaternion).setFromAxisAngle(n,-r);this.control.orientation.multiplyQuaternions(a,this.control.orientation.clone());var s=this.getEyePosition().add(e.clone().multiplyScalar(this.getTargetDistance()));this.control.setTarget(s)}this.control.update()},getSightDirection:function(){return this.camera.getLookAt()},setUpDirection:function(e){e.normalize();var t=this.camera.up.clone(),r=Math.acos(e.dot(t));if(r){var n=e.clone().cross(t);n.normalize();var a=(new i.Quaternion).setFromAxisAngle(n,-r);this.control.orientation.multiplyQuaternions(a,this.control.orientation.clone())}this.control.update()},getUpDirection:function(){return this.camera.up.clone()},setAngle:function(e){this.camera.fov=(360+e)%360,this.control.update()},getAngle:function(){return this.camera.fov},setTarget:function(e){var t=this.getEyePosition(),r=e.clone().sub(t).normalize(),n=Math.acos(r.dot(this.getSightDirection()));if(n){var a=r.clone().cross(this.getSightDirection()).normalize(),s=(new i.Quaternion).setFromAxisAngle(a,-n);this.getControl().orientation.multiplyQuaternions(s,this.control.orientation.clone())}this.getControl().setTarget(e),this.getControl().distanceToTarget=e.distanceTo(t),this.control.update()},getTarget:function(){return this.target.clone()},setTargetDistance:function(e){var t=this.getEyePosition().add(this.getSightDirection().multiplyScalar(e));this.control.setTarget(t),this.control.distanceToTarget=e,this.projectionType===f.ORTHOGRAPHIC&&this.camera.setVisualizedHeight(e),this.control.update()},getTargetDistance:function(){return this.getControl().distanceToTarget},setProjectionType:function(e){if((!this._2DMode||1===e)&&e!==this.projectionType){if(this.projectionType=e,!this.cameraOther){var t=this.camera.near,r=this.camera.far;e===f.PERSPECTIVE?this.cameraOther=new i.PerspectiveCamera(this.camera.fov,this.camera.aspect,t,r):this.cameraOther=new i.OrthographicCamera(0,0,0,0,t,r),this.cameraOther._renderingRole=i._CameraRoles.PRINCIPAL,this.cameraOther._viewpoint=this}this.cameraOther.position=this.camera.position,this.cameraOther.fov=this.camera.fov,this.cameraOther.aspect=this.camera.aspect,this.cameraOther.pixelCulling=this.camera.pixelCulling,this.camera.fullWidth&&this.cameraOther.setViewOffsetInternal(this.camera.fullWidth,this.camera.fullHeight,this.camera.x,this.camera.y,this.camera.width,this.camera.height);var n=this.camera;this.camera=this.cameraOther,this.connectedRobotCamera=this.camera.clone(),this.connectedRobotCamera._renderingRole=i._CameraRoles.ROBOT_CONNECTED,this.connectedRobotCamera._viewpoint=this,this.cameraOther=n,this.camera.updateMatrix(),this.camera.matrixWorld.copy(this.camera.matrix),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),this.camera._hasChanged=!0,this.control.camera=this.camera,this.control.update(),this.viewer.render()}},getProjectionType:function(){return this.projectionType},_setIntraOccularDistance:function(e){},setPixelCulling:function(e,t){this.viewer&&this.viewer.setPixelCulling(e,t)},_setPixelCulling:function(e){this.camera.pixelCulling=e},_setApplicationDefaultController:function(e){if(null===this.control)return;var t=this,i=function(){};let r="3dexperience",n="catia",a="solidworks",s="COMBINED",o="CATIA",l="SWX";if(this._mePreferenceSetting=null,window.widget&&window.widget.getValue("x3dPlatformId")){var c=function(e){e&&e.toLowerCase&&((e=e.toLowerCase())==r?(t._mePreferenceSetting=s,t._2DMode||t.setDefaultController(!0,s)):e==n?(t._mePreferenceSetting=o,t._2DMode||t.setDefaultController(!0,o)):e==a&&(t._mePreferenceSetting=l,t._2DMode||t.setDefaultController(!0,l)))};if(require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(e){var t=window.widget,r=function(e){if(e&&e.repositories){var t=e.repositories[0].preferences[0].value;c(t)}};e.getServiceUrl({serviceName:"mepreferences",platformId:t.getValue("x3dPlatformId"),onComplete:function(e){if(void 0!==e){var t=e+"/api/v1/preferences";u.authenticatedRequest(t,{method:"POST",type:"json",data:JSON.stringify({repositories:[{name:"VisualizationRepository",preferenceNames:["SWNavigationMode"]}]}),headers:{"Content-Type":"application/json"},onComplete:r,onFailure:i})}},onFailure:i})}),!e){require(["DS/PlatformAPI/PlatformAPI"],function(e){e.subscribe("com.ds.mep:onPrefUpdate",function(e,t){if(e){let t=e[2].tenantId,i=JSON.parse(e[1].preferences).repositories;if(t&&t!=window.widget.getValue("x3dPlatformId"))return;let r=null,n=null;if(i){for(let e=0;e<i.length;e++)if("VisualizationRepository"==i[e].name){i[e].preferences.length&&(r=i[e].preferences);break}if(r)for(let e=0;e<r.length;e++)if("SWNavigationMode"==r[e].name){n=r[e].value;break}c(n)}}})})}}},getDefaultController:function(){return this.control?this._currentDefaultController:null},setDefaultController:function(e,t,i){if(!this._forcedController||t==this._forcedController){var r={SIMPLE:s.Mode.SIMPLE,CATIA:s.Mode.CATIA,COMBINED:s.Mode.COMBINED,LOOKAROUND:s.Mode.LOOKAROUND};if(e||null!==this.control)if("FLY_WALK"===t&&this.control)this.control.setForceFlyWalkState(!e);else{if(e){let e=null;var n=!1;if(null==this.control&&(this.control=new s(this,this.viewer.canvas),e="COMBINED",n=!0),!this._2DMode&&("SWX"==t||localStorage.getItem("forceSWXControls")&&"true"===localStorage.getItem("forceSWXControls"))){if(null==this._SWXCoreViewManipulation){var a=this;require(["DS/SWXCoreManipulation/SWXCoreViewManipulation"],function(e){let t={viewer:a.viewer};a._SWXCoreViewManipulation=new e,a._SWXCoreViewManipulation.setup(t),a._SWXCoreViewManipulation.enable(),a._SWXCoreViewManipulation.enableViewerCallbacks=!0,i&&i()})}else this._SWXCoreViewManipulation.enable(),i&&i();e="SWX"}else void 0!==t&&(null!=r[t]&&(e=t),this._SWXCoreViewManipulation&&this._SWXCoreViewManipulation.disable(),this.control.setMode(r[t]));if(null!=e&&(this._currentDefaultController=e),!n)return;this.control.rotateSpeed=1,this.control.lockZRotationSpeed=.002,this.control.zoomSpeed=5,this.control.panSpeed=1.1}else null!==this.control&&this.control.detachEvents(),this.control=null;this.resetCameraOrientation()}}},setControlActive:function(e){null!==this.control&&this.control.setActive(e)},addDivToManipulation:function(e){return!!this.control&&this.control.addViewToManipulation(e)},removeDivToManipulation:function(e){return!!this.control&&this.control.removeViewFromManipulation(e)},onReframe:function(e){this._customReframeCB=e},onCenterCamera:function(e){this._customCenterCameraCB=e},_setFocusMode:function(e){this._focusMode=e},__rotatedFocusMoveTo:function(e){e.sight=e.sightDirection,e.position=e.eyePosition;var s,o,l,c;if(l=e.distanceToTarget,e.orientation)c=e.orientation,(g=new i.Vector3(0,0,-1)).applyQuaternion(c),g.normalize(),s=g;else if(e.sight){s=e.sight.clone().normalize();var h=this.camera.getLookAt().clone().normalize(),u=Math.acos(s.dot(h));if(u){var d=s.clone().cross(h).normalize(),p=(new i.Quaternion).setFromAxisAngle(d,-u);c=(new i.Quaternion).multiplyQuaternions(p,this.control.orientation.clone())}else c=this.control.orientation.clone(),s=h}var f={position:o=e.position,target:v=(new i.Vector3).addVectors(o,s.clone().multiplyScalar(l)),distanceToTarget:l,orientation:c,duration:e.duration||0};this._viewpointAnimation&&this._viewpointAnimation.stop();var m={eventChannel:"/VISU/",eventType:"@onViewpointBeginMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};if(0===f.duration){var g;t.publish({event:"/VISU/",data:m}),(g=new i.Vector3(0,0,-1)).applyQuaternion(f.orientation),g.normalize();var v=(new i.Vector3).addVectors(this.control.position,g.multiplyScalar(f.distanceToTarget));this.control.setTarget(v),this.control.orientation=f.orientation.clone(),this.control.distanceToTarget=f.distanceToTarget,this.control.update();var S={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};t.publish({event:"/VISU/",data:S})}else{var _=new a({orientation:this.control.orientation.clone(),distanceToTarget:this.control.distanceToTarget},{orientation:f.orientation,distanceToTarget:f.distanceToTarget},f.duration);_.setInterpolator(function(e,t,r){var n={},a=new i.Quaternion;return i.Quaternion.slerp(t.orientation,r.orientation,a,e),n.orientation=a,n.distanceToTarget=t.distanceToTarget+(r.distanceToTarget-t.distanceToTarget)*e,n}),this.updateAnimation=function(e){if(this.control){var t=new i.Vector3(0,0,-1);t.applyQuaternion(e.orientation),t.normalize();var r=(new i.Vector3).addVectors(this.control.position,t.multiplyScalar(e.distanceToTarget));this.control.setTarget(r),this.control.orientation=e.orientation.clone(),this.control.distanceToTarget=e.distanceToTarget,this.control.update()}};var y=this;this._viewpointAnimation=new n(this,"updateAnimation",_,function(e){if(e===r.State.STOPPED){var i={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:y,cameraEye:y.camera.position,cameraUp:y.camera.up};t.publish({event:"/VISU/",data:i})}}),this._viewpointAnimation.start(),t.publish({event:"/VISU/",data:m})}},NativeZoomTypes:{MillimeterScreenBased:"MillimeterScreenBased",HalfWindowHeightBased:"HalfWindowHeightBased",HalfWindowWidthAndHeightBased:"HalfWindowWidthAndHeightBased"},setNative2DZoomType:function(e,t){this._nativeZoomType=e,this._nativeZoomRatio=t},setNative2DClip:function(e,t,r){this._clip=e,this._bottomleftClip=new i.Vector2(t[0],t[1]),this._toprightClip=new i.Vector2(r[0],r[1])},setNative2DTranslationBounds:function(e,t){this._XMaxTranslationBound=e[1],this._XMinTranslationBound=e[0],this._YMaxTranslationBound=t[1],this._YMinTranslationBound=t[0]},setNative2DAnchor:function(e){this._anchor=e},setNative2DDepthMode:function(e){this._depthMode=e},isNative2D:function(){return null!=this._nativeZoomType},getScaleFactor:function(){if(this.isNative2D()){let e=1/this.getMMInSupportUnit(),t=1;switch(this._nativeZoomType){case this.NativeZoomTypes.MillimeterScreenBased:t=e/this._nativeZoom;break;case this.NativeZoomTypes.HalfWindowHeightBased:case this.NativeZoomTypes.HalfWindowWidthAndHeightBased:t=2/(this._nativeZoom*this.viewer.SCREEN_HEIGHT)}return t}return 1},getPixelFromModelRatio:function(){return this.isNative2D()?this.getScaleFactor():1},_native2DModelFromPixel:function(e,t,i,r,n,a){let s,o,l=1*a,c=1/n,h=this._nativeZoom*this._nativeZoomRatio/l,u=this._nativeZoom;if(this._clip<=1){switch(3&this._anchor){case 0:s=i/2;break;case 1:s=0;break;case 2:s=i}switch(12&this._anchor){case 0:o=r/2;break;case 4:o=0;break;case 8:o=r}}else{switch(3&this._anchor){case 0:s=.5*(this._bottomleftClip.x+this._toprightClip.x);break;case 1:s=this._bottomleftClip.x;break;case 2:s=this._toprightClip.x}switch(12&this._anchor){case 0:o=.5*(this._bottomleftClip.y+this._toprightClip.y);break;case 4:o=this._toprightClip.y;break;case 8:o=this._bottomleftClip.y}}let d=0,p=0;switch(this._nativeZoomType){case this.NativeZoomTypes.MillimeterScreenBased:d=this.camera.position.x+c/h*(e-s),p=this.camera.position.y+c/u*(o-t);break;case this.NativeZoomTypes.HalfWindowHeightBased:d=this.camera.position.x+1/h*(e-s)/(r/2),p=this.camera.position.y+1/u*(o-t)/(r/2);break;case this.NativeZoomTypes.HalfWindowWidthAndHeightBased:d=this.camera.position.x+1/h*(e-s)/(i/2),p=this.camera.position.y+1/u*(o-t)/(r/2)}return[d,p]},_native2DViewportBounds:function(e,t,i,r){let[n,a]=this._native2DModelFromPixel(0,0,e,t,i,r),[s,o]=this._native2DModelFromPixel(e,t,e,t,i,r),l=this.getEyePosition();if(s-n>this._XMaxTranslationBound-this._XMinTranslationBound){let e=l.x;switch(3&_Anchor){case 0:l.x=(this._XMinTranslationBound+this._XMaxTranslationBound)/2;break;case 1:l.x=this._XMinTranslationBound;break;case 2:l.x=this._XMaxTranslationBound}n+=l.x-e,s+=l.x-e}else this._XMinTranslationBound>n?(l.x+=this._XMinTranslationBound-n,s+=this._XMinTranslationBound-n,n+=this._XMinTranslationBound-n):this._XMaxTranslationBound<s&&(l.x+=this._XMaxTranslationBound-s,n+=this._XMaxTranslationBound-s,s+=this._XMaxTranslationBound-s);if(a-o>this._YMaxTranslationBound-this._YMinTranslationBound){let e=l.y;switch(12&_Anchor){case 0:l.y=(this._YMinTranslationBound+this._YMaxTranslationBound)/2;break;case 4:l.y=this._YMaxTranslationBound;break;case 8:l.y=this._YMinTranslationBound}o+=l.y-e,a+=l.y-e}else this._YMinTranslationBound>o?(l.y+=this._YMinTranslationBound-o,a+=this._YMinTranslationBound-o,o+=this._YMinTranslationBound-o):this._YMaxTranslationBound<a&&(l.y+=this._YMaxTranslationBound-a,o+=this._YMaxTranslationBound-a,a+=this._YMaxTranslationBound-a);return n-=l.x,s-=l.x,o-=l.y,[n,s,a-=l.y,o,l]},getMMInSupportUnit:function(){return i.getPixelsPerMM()},updateNative2D(){let e=this.getMMInSupportUnit(),[t,i,r,n,a]=this._native2DViewportBounds(this.viewer.SCREEN_WIDTH,this.viewer.SCREEN_HEIGHT,e,1);return this.camera.setViewportInfos(r,n,t,i),a},moveTo:function(e){var s,o,l,c,h,u;if(e.up||e.sight||e.position?console.log("DEPRECATED Naming: options.up => options.upDirection, options.sight => options.sightDirection, options.position => options.eyePosition."):(e.up=e.upDirection,e.sight=e.sightDirection,e.position=e.eyePosition),c=e.distanceToTarget||this.control.distanceToTarget,e.orientation)u=e.orientation,(v=new i.Vector3(0,1,0)).applyQuaternion(u),v.normalize(),s=v,(S=new i.Vector3(0,0,-1)).applyQuaternion(u),S.normalize(),o=S;else if(e.up&&e.sight)s=e.up.clone().normalize(),o=e.sight.clone().normalize();else if(e.up){s=e.up.clone().normalize();var d=this.camera.up.clone().normalize();if(m=Math.acos(s.dot(d))){var p=s.clone().cross(d).normalize(),f=(new i.Quaternion).setFromAxisAngle(p,-m);o=this.camera.getLookAt().clone().applyQuaternion(f).normalize(),u=(new i.Quaternion).multiplyQuaternions(f,this.control.orientation.clone())}else u=this.control.orientation.clone(),s=d,o=this.camera.getLookAt().clone().normalize()}else if(e.sight){o=e.sight.clone().normalize();var m,g=this.camera.getLookAt().clone().normalize();if(m=Math.acos(o.dot(g))){p=o.clone().cross(g).normalize(),f=(new i.Quaternion).setFromAxisAngle(p,-m);s=this.camera.up.clone().applyQuaternion(f).normalize(),u=(new i.Quaternion).multiplyQuaternions(f,this.control.orientation.clone())}else u=this.control.orientation.clone(),o=g,s=this.camera.up.clone().normalize()}else{var v,S;u=this.control.orientation.clone(),(v=new i.Vector3(0,1,0)).applyQuaternion(this.control.orientation),v.normalize(),s=v,(S=new i.Vector3(0,0,-1)).applyQuaternion(this.control.orientation),S.normalize(),o=S}if(e.position?(l=e.position,h=(new i.Vector3).addVectors(l,o.clone().multiplyScalar(c))):(l=(new i.Vector3).subVectors(this.control.target,o.clone().multiplyScalar(c)),h=this.control.target.clone()),!u){u=new i.Quaternion;var _=new i.Matrix4;_.lookAt(l,h,s),u.setFromRotationMatrix(_)}if(e.ratioOffset||e.ratioSize){c/=Math.max(.01,Math.min(e.ratioSize.x,e.ratioSize.y));var y=Math.tan(i.Math.degToRad(.5*this.camera.fov))*c,x=y*this.camera.aspect,M=new i.Vector2(x,y);M.x*=-(1-Math.max(.01,e.ratioSize.x)),M.y*=-(1-Math.max(.01,e.ratioSize.y));var P=new i.Vector2(2*x,2*y);P.x*=e.ratioOffset.x,P.y*=e.ratioOffset.y,P.add(M);var C=(new i.Vector3).crossVectors(s,o);h.add(s.multiplyScalar(P.y)),h.add(C.multiplyScalar(P.x)),e.interpolationType&&(l=(new i.Vector3).subVectors(h,o.clone().multiplyScalar(c)))}var b={position:l,target:h,distanceToTarget:c,orientation:u,duration:e.duration||0};this._viewpointAnimation&&this._viewpointAnimation.stop();var D={eventChannel:"/VISU/",eventType:"@onViewpointBeginMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};if(0===b.duration){t.publish({event:"/VISU/",data:D}),this.control.setTarget(b.target),this.control.orientation=b.orientation,this.control.distanceToTarget=b.distanceToTarget,this.control.update();var w={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};t.publish({event:"/VISU/",data:w}),e.onEndCB&&e.onEndCB(this)}else{var E=new a({position:this.control.position.clone(),target:this.control.target.clone(),orientation:this.control.orientation.clone(),distanceToTarget:this.control.distanceToTarget},{position:b.position,target:b.target,orientation:b.orientation,distanceToTarget:b.distanceToTarget},b.duration);E.setInterpolator(function(e,t,r){var n={},a=t.position.clone();a.lerp(r.position,e),n.position=a;var s=t.target.clone();s.lerp(r.target,e),n.target=s;var o=new i.Quaternion;return i.Quaternion.slerp(t.orientation,r.orientation,o,e),n.orientation=o,n.distanceToTarget=t.distanceToTarget+(r.distanceToTarget-t.distanceToTarget)*e,n}),e.interpolationType?this.updateAnimation=function(t){if(this.control){this.control.position=t.position.clone();var r=new i.Vector3(0,0,-1);r.applyQuaternion(t.orientation),r.normalize();var n=(new i.Vector3).addVectors(t.position,r.multiplyScalar(t.distanceToTarget));this.control.setTarget(n),this.control.orientation=t.orientation.clone(),this.control.distanceToTarget=t.distanceToTarget,this.control.update(),e.onUpdateCB&&e.onUpdateCB(T)}}:this.updateAnimation=function(t){this.control&&(this.control.setTarget(t.target),this.control.orientation=t.orientation.clone(),this.control.distanceToTarget=t.distanceToTarget,this.control.update(),e.onUpdateCB&&e.onUpdateCB(T))};var T=this;this._viewpointAnimation=new n(this,"updateAnimation",E,function(i){if(i===r.State.STOPPED){var n={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:T,cameraEye:T.camera.position,cameraUp:T.camera.up};t.publish({event:"/VISU/",data:n}),e.onEndCB&&e.onEndCB(T)}}),this._viewpointAnimation.start(),t.publish({event:"/VISU/",data:D})}},onMove:function(e){if(this.control)return this.control.onMove(e)},unsubscribe:function(e){this.control&&this.control.unsubscribe(e)},isMoving:function(){return this._isMoving},_isAnimated:function(){var e=!!this._viewpointAnimation&&this._viewpointAnimation.state()===r.State.RUNNING;return e=e||this.control&&this.control._wheelMoving},resize:function(e,t){this.robotCameraOrtho&&this.camera&&this.robotCameraOrtho.setVisualizedHeight(null,void 0,this.camera.fov),null!==this.control&&this.control._resize(e,t)},setSceneGraph:function(e){c.DEPRECATED_SceneGraph(new Error),e instanceof o&&(this.sceneGraph=e)},_setInternalSceneGraph(e){this._setNode(e.root),e.scene.add(this.getCamera()),this._internalSceneGraph=e},_setNode:function(e){this.sceneGraphRoot=e},_lockController:function(e){this._forcedController=e?this._currentDefaultController:null},_set2DMode:function(e,t){var r=this._2DMode!=e;if(this._2DMode=e,e){if(this.setSightDirection(new i.Vector3(0,0,-1)),this.setUpDirection(new i.Vector3(0,1,0)),this.setProjectionType(1),this.control){var n=null,a=!1;"CATIA"!=t&&"COMBINED"!=t||(n=t,this._forcedController?this._lockController(!1):this._2DModePreviousController=this._currentDefaultController,a=!0),"SWX"!=this._currentDefaultController||n||(n="COMBINED"),n&&this.setDefaultController(!0,n),this._lockController(a),this.control._2DMode=!0,this.control.setMouseRotationActive(!1),this.control.setTouchRotationActive(!1)}}else this._lockController(!1),r&&(this._mePreferenceSetting||this._2DModePreviousController)&&this.setDefaultController(!0,this._mePreferenceSetting||this._2DModePreviousController),this._2DModePreviousController=null,this.control._2DMode=!1,this.control.setMouseRotationActive(!0),this.control.setTouchRotationActive(!0)},resetCameraOrientation:function(){var e,t,r;if(!this._2DMode)if(t=new i.Quaternion,this._worldOrientation===h.ZUpYRight?(e=new i.Vector3(.35*Math.PI,0,.75*Math.PI),t.setFromEuler(e,this._worldOrientation._eulerOrderForReframe)):t.set(-.21567539362612123,.37210985866635193,.08933567311009524,.8983526674850427),r=1.1*100/Math.tan(22.5*Math.PI/180),null!==this.sceneGraphRoot&&(r=1.1*this.getBoundingSphere().radius/Math.tan(22.5*Math.PI/180)),this.camera.position=new i.Vector3(r,r,r).multiplyScalar(1/Math.sqrt(3)),null===this.control)this.camera.quaternion=t,this.camera.useQuaternion=!0,this.camera.updateMatrix();else{this.control.orientation=t;var n=new i.Vector3(0,0,-1);n.applyQuaternion(t),n.normalize(),this.moveTo({orientation:t,eyePosition:n.clone().multiplyScalar(-r),distanceToTarget:r,duration:0})}},reframe:function(e,t,r,n,a){if(this.sceneGraphRoot&&null!==this.control){var s=null,o=null;if(n&&("string"==typeof n?s=n:(s=n.reframeSpace,a=n.radiusIfEmpty,o=n.targetBoundingBox)),!s&&this.viewer&&(s=this.viewer.visibleSpace?"visibleSpace":"invisibleSpace"),this._customReframeCB)this._customReframeCB(e,t,r,s);else{var l,c,h;if(c=void 0!==t?t:400,this._2DMode&&o){var u=new i.Box2(new i.Vector2(o.min.x,o.min.y),new i.Vector2(o.max.x,o.max.y));h=this._buildReframeTarget2DFromBBox(u)}else r||!this._2DMode?(void 0!==r&&r instanceof i.Mesh?(l=r.boundingSphere.clone()).applyMatrix4(r.matrixWorld):l=void 0!==r&&r instanceof i.Sphere&&!r.isNaN()?r.clone():this.getBoundingSphere(s,a),h=this._buildReframeTarget(l,e)):h=this._buildReframeTarget2D(s);if(h){var d=new i.Vector3(0,0,-1);d.applyQuaternion(h.orientation),d.normalize(),this.moveTo({orientation:h.orientation,eyePosition:(new i.Vector3).addVectors(h.target,d.clone().multiplyScalar(-h.distanceToTarget)),distanceToTarget:h.distanceToTarget,duration:c})}}}},reframeOn:function(e,t,r){r=r||{};var n=new i.Matrix4,a=l.getOrientedBoundingBoxFromPathElements(t,n,this.viewer,!!r.withInternalSceneGraph),s=a.localBBox,o=Math.sqrt(Math.pow(s.min.x-s.max.x,2)+Math.pow(s.min.z-s.max.z,2)+Math.pow(s.min.y-s.max.y,2))/2,c=a.cornerPoint,h=(new i.Vector3).add(c).add(a.firstAxis).add(a.secondAxis).add(a.thirdAxis),u=(new i.Vector3).add(c).add(h);u.divideScalar(2),isNaN(o)||isNaN(u.x)||isNaN(u.y)||isNaN(u.z)?this._reframeOnWarningCount<10&&(console.warn("reframeOn: no usable path for reframe"),this._reframeOnWarningCount++):this.reframe(void 0,e,new i.Sphere(u,o),r)},_reframeOnWarningCount:0,_buildReframeTarget2DFromBBox:function(e){var t,r,n,a;e.empty()&&e.set(new i.Vector2(-100,-100),new i.Vector2(100,100)),t=new i.Vector3((e.min.x+e.max.x)/2,(e.min.y+e.max.y)/2,0);var s=this.camera.aspect,o=.5/Math.tan(this.camera.fov*Math.PI/360);return n=o*(e.max.x-e.min.x)/s,a=o*(e.max.y-e.min.y),r=Math.max(n,a),{target:t,orientation:new i.Quaternion,distanceToTarget:r}},_buildReframeTarget2D:function(e){var t=this.getBoundingBox2D(e);return this._buildReframeTarget2DFromBBox(t)},_buildReframeTarget:function(e,t){var r,n,a,s,o=null;if(e||boundingBox2D){if(n=this.target.clone(),r=this.control.orientation.clone(),a=this.control.distanceToTarget,null==t||this._2DMode){var l=Math.max(this.viewer._getDivClientHeight()/this.viewer._getDivClientWidth(),1);a=1.1*e.radius*l/Math.tan(this.camera.fov*Math.PI/360),n=e.center.clone()}else s=this._worldOrientation.getAxisForSideRotation(t);if(s){var c=this._worldOrientation._eulerOrderForReframe;(r=new i.Quaternion).setFromEuler(s,c)}o={target:n,orientation:r,distanceToTarget:a}}return o},centerCamera:function(e){if(null!==this.control)if(this._customCenterCameraCB)this._customCenterCameraCB(e);else if(null!==e){var t=e.clone(),r=this.control.orientation.clone(),n=t.distanceTo(this.camera.position);if(this._focusMode===f._FOCUS_MODE.TRANSLATION){var a=new i.Vector3(0,0,-1);a.applyQuaternion(r),a.normalize();var s=this.viewer.ODTMode,o=(new i.Vector3).addVectors(t.clone(),a.clone().multiplyScalar(-n));this.moveTo({eyePosition:o,distanceToTarget:n,duration:s?0:200})}else if(this._focusMode===f._FOCUS_MODE.ROTATION){var l=(new i.Vector3).subVectors(t,this.control.position).normalize();s=this.viewer.ODTMode;if(this.control.lockZ||i.mobileVersion){var c=this.camera.getLookAt().clone().normalize(),h=null,u=Math.acos(l.dot(c));if(u){var d=l.clone().cross(c).normalize(),p=(new i.Quaternion).setFromAxisAngle(d,-u);h=(new i.Quaternion).multiplyQuaternions(p,this.control.orientation.clone())}else h=this.control.orientation.clone(),l=c;var m=h.toEuler();m.y=0,h=(new i.Quaternion).setFromEuler(m,"ZYX"),this.__rotatedFocusMoveTo({eyePosition:this.control.position,orientation:h,distanceToTarget:n,duration:s?0:200})}else this.__rotatedFocusMoveTo({eyePosition:this.control.position,sightDirection:l,distanceToTarget:n,duration:s?0:200})}}},centerCameraSVG:function(e,t){this.control.update();var r,n,a,s=e.x-t.x,o=e.y-t.y;if(0!==s||0!==o){r=(new i.Vector3).copy(this.camera.position).sub(this.target),n=(this.camera.top-this.camera.bottom)/this.viewer._getDivClientHeight(),(a=new i.Vector3).add(r.clone().cross(this.camera.up).setLength(n*s)),a.add(this.camera.up.clone().setLength(n*o));var l=this.viewer.ODTMode,c=this.camera.position.clone().add(a);this.moveTo({eyePosition:c,duration:l?0:200})}},pan:function(e){if(null!==this.control){var t,r,n=new i.Vector3;switch(e){case"left":n.x=-1;break;case"right":n.x=1;break;case"top":n.y=1;break;case"bottom":n.y=-1;break;default:n.x=1}n.applyQuaternion(this.control.orientation),n.setLength(.05*this.control.distanceToTarget),t=this.target.clone().add(n),this.control.orientation.clone(),r=this.control.distanceToTarget;var a=this.viewer.ODTMode;this.moveTo({eyePosition:(new i.Vector3).addVectors(t,this.getCamera().getLookAt().clone().normalize().multiplyScalar(-r)),duration:a?0:100})}},zoom:function(e){if(null!==this.control){var t,r,n=.9;"out"===e&&(n=1.1),t=this.target.clone(),this.control.orientation.clone(),r=this.control.distanceToTarget*n;var a=this.viewer.ODTMode;this.moveTo({eyePosition:(new i.Vector3).addVectors(t,this.getCamera().getLookAt().clone().normalize().multiplyScalar(-r)),distanceToTarget:r,duration:a?0:100})}},rotateCameraForPerfos:function(e,t,r){if(null!==this.control){var a=new function(){var r=new i.Vector3(.35*Math.PI,0,.75*Math.PI);this._orientation=(new i.Quaternion).setFromEuler(r,"ZXY"),this._key1=new i.Quaternion,this._key2=(new i.Quaternion).setFromAxisAngle(new i.Vector3(0,0,1),Math.PI/2),this._key3=(new i.Quaternion).setFromAxisAngle(new i.Vector3(0,0,1),Math.PI),this._key4=(new i.Quaternion).setFromAxisAngle(new i.Vector3(0,0,1),3*Math.PI/2),this._nbLoops=void 0!==e?e:5,this._duration=void 0!==t?t:1e4,this.duration=function(){return this._duration},this.valueAt=function(e){var t,r,n,a,s=this._duration/this._nbLoops,o=e%s/s;return o>=0&&o<.25?(t=this._key1,r=this._key2,a=o/.25):o>=.25&&o<.5?(t=this._key2,r=this._key3,a=(o-.25)/.25):o>=.5&&o<.75?(t=this._key3,r=this._key4,a=(o-.5)/.25):(t=this._key4,r=this._key1,a=(o-.75)/.25),n=new i.Quaternion,i.Quaternion.slerp(t,r,n,a),n.multiply(this._orientation)}},s=new n(this.control,"orientation",a);r&&s.setLoop(1),s.start()}},zoomCameraInAndOutForPerfos:function(e,t){if(null!==this.control){this.resetCameraOrientation(),this.reframe(void 0,0);var i=1.2*this.getTargetDistance(),r=new function(){this._duration=void 0!==e?e:3e3,this.duration=function(){return this._duration},this.valueAt=function(t){var r=t%e/e;return(r>=0&&r<.5?r/.5:1-(r-.5)/.5)*i}},a=new n(this.control,"distanceToTarget",r);t&&a.setLoop(1),a.start()}},getBoundingBox2D:function(e){if(!this._2DMode)return null;var t,r=this.viewer||this.sceneGraphRoot._getViewer();if(r.svgRoot){var n=this.viewer.svgRoot.getBBox();t=new i.Box2(new i.Vector2(n.x,-n.y-n.height),new i.Vector2(n.x+n.width,-n.y))}let a=this.internalSceneGraph?this.internalSceneGraph:r?r._safeInternalSceneGraph:null;var s=r?r.getSceneBoundingBox(e,a):this.sceneGraphRoot.getBoundingBox(e),o=new i.Box2(new i.Vector2(s.min.x,s.min.y),new i.Vector2(s.max.x,s.max.y));return t&&o.union(t),o},getBoundingSphere:function(e,t){var r=this.viewer||this.sceneGraphRoot._getViewer();let n=this.internalSceneGraph?this.internalSceneGraph:r?r._safeInternalSceneGraph:null;var a=r?r.getSceneBoundingSphere(e,!0,n):this.sceneGraphRoot.getBoundingSphere(e,!0);return a?0===a.radius&&a.pixelRadius>0?a.radius=void 0!==t?t:a.pixelRadius:0===a.radius&&(a.radius=void 0!==t?t:100):a=new i.Sphere(new i.Vector3,100),a},setViewOffset:function(e,t){var r=this.camera;!function(i,r){if(e){e.camera&&(i=e.camera);var n=e.fullWidth?e.fullWidth:r.SCREEN_WIDTH,a=e.fullHeight?e.fullHeight:r.SCREEN_HEIGHT,s=e.x?e.x:0,o=e.y?e.y:0,l=e.width?e.width:r.SCREEN_WIDTH,c=e.height?e.height:r.SCREEN_HEIGHT;i.setViewOffsetInternal(n,a,s,o,l,c,null,t)}else i.setViewOffsetInternal(0,0,0,0,r.SCREEN_WIDTH,r.SCREEN_HEIGHT,null,t)}(r,this.viewer),r.clone(this.robotCameraOrtho),this.robotCameraOrtho.setVisualizedHeight(null,void 0,r.fov),this.robotCameraOrtho._renderingRole=i._CameraRoles.ROBOT_ORHTO},project:function(e,t){var i=t||this.camera,r=e.clone();return d.projectVector(r,i),r.x=.5*this.viewer._getCanvasOffsetWidth()*(r.x+1),r.y=.5*this.viewer._getCanvasOffsetHeight()*(1-r.y),r},unProject:function(e,t){var r=t||this.camera,n=e.x/this.viewer._getCanvasOffsetWidth()*2-1,a=-e.y/this.viewer._getCanvasOffsetHeight()*2+1,s=new i.Vector3(n,a,e.z);return d.unprojectVector(s,r),s},create3DRayFrom2DPoint:function(e,t){var r=e.x/this.viewer.canvas.offsetWidth*2-1,n=-e.y/this.viewer.canvas.offsetHeight*2+1,a=new i.Vector3(r,n,-1);d.unprojectVector(a,t||this.camera);var s=new i.Vector3(r,n,1);d.unprojectVector(s,t||this.camera);var o=(new i.Vector3).copy(s).sub(a);return o.normalize(),new i.Ray(a,o)},dump:function(){var e="viewpoint.control.target = new THREE.Vector3("+this.control.target.x+", "+this.control.target.y+", "+this.control.target.z+");\nviewpoint.control.orientation = new THREE.Quaternion("+this.control.orientation.x+", "+this.control.orientation.y+", "+this.control.orientation.z+", "+this.control.orientation.w+");\nviewpoint.control.distanceToTarget = "+this.control.distanceToTarget+";";console.log(e)},setFromJSON:function(e){},_setPickingViewOffset:function(e){function t(t,i){if(e.reset)t.setViewOffsetInternal(0,0,0,0,i.SCREEN_WIDTH,i.SCREEN_HEIGHT,{},!0);else{var r=e.fullWidth?e.fullWidth:i.SCREEN_WIDTH,n=e.fullHeight?e.fullHeight:i.SCREEN_HEIGHT,a=e.x?e.x:0,s=e.y?e.y:0,o=e.width?e.width:i.SCREEN_WIDTH,l=e.height?e.height:i.SCREEN_HEIGHT;t.setViewOffsetInternal(r,n,a,s,o,l,{ratioW:e.pickingRatioW,ratioH:e.pickingRatioH},!0)}}e&&e.cameraSet&&(t(e.cameraSet.main,this.viewer),t(e.cameraSet.robotCameraOrtho,this.viewer),t(e.cameraSet.connectedRobotCamera,this.viewer))},_updateRobotCamera:function(e){function t(e,t){var r=(new i.Vector3).subVectors(e.center,t.position),n=t.getLookAt(),a=r.dot(n),s=a+e.radius,o=a-e.radius;return t.isOrtho||(o=Math.max(o,.001*s)),{near:o,far:s}}var r=this.camera;r.clone(this.robotCameraOrtho),this.robotCameraOrtho.setVisualizedHeight(null,void 0,this.camera.fov),this.robotCameraOrtho.position.set(0,0,0),this.robotCameraOrtho.updateMatrix(),this.robotCameraOrtho.updateMatrixWorld(),this.robotCameraOrtho.updateProjectionMatrix(),this.robotCameraOrtho.projectionMatrixInverse.getInverse(this.robotCameraOrtho.projectionMatrix),this.robotCameraOrtho._renderingRole=i._CameraRoles.ROBOT_ORTHO,r.clone(this.connectedRobotCamera),this.connectedRobotCamera._renderingRole=i._CameraRoles.ROBOT_CONNECTED;var n,a,s,o,l,c=e.robotRoot;if(c.getMatrixWorld(),(a=c.getBoundingSphere()).pixelRadius>0){var h=this.robotCameraOrtho.getWorldSizeFromPixelSize(1,a.center,this.viewer._getDivClientHeight());if(void 0!==this.robotCameraOrtho.fullWidth&&this.robotCameraOrtho.fullWidth>0)h*=Math.max(1*this.robotCameraOrtho.width/this.robotCameraOrtho.fullWidth,1*this.robotCameraOrtho.height/this.robotCameraOrtho.fullHeight);a.radius+=h*a.pixelRadius}if(0===a.radius&&(a.radius=10),a){o=t(a,this.robotCameraOrtho),this.robotCameraOrtho.near=o.near,this.robotCameraOrtho.far=o.far,this.robotCameraOrtho.updateProjectionMatrix(),this.robotCameraOrtho.projectionMatrixInverse.getInverse(this.robotCameraOrtho.projectionMatrix);var u=e._robot;if(u)if(!(!u.isConnected||u.isManipulatedInPlane)){if(n=u.getMatrixWorld(),(s=u.getBoundingSphere()).applyMatrix4(n),s.pixelRadius>0){h=this.connectedRobotCamera.getWorldSizeFromPixelSize(1,s.center,this.viewer._getDivClientHeight());if(void 0!==this.connectedRobotCamera.fullWidth&&this.connectedRobotCamera.fullWidth>0)h*=Math.max(1*this.connectedRobotCamera.width/this.connectedRobotCamera.fullWidth,1*this.connectedRobotCamera.height/this.connectedRobotCamera.fullHeight);s.radius+=h*s.pixelRadius}l=t(s,this.camera),this.connectedRobotCamera.near=Math.min(l.near,r.near),this.connectedRobotCamera.far=Math.max(l.far,r.far),this.connectedRobotCamera.updateProjectionMatrix(),this.connectedRobotCamera.projectionMatrixInverse.getInverse(this.connectedRobotCamera.projectionMatrix)}}},_updateFrustum:function(){var e=this.camera;p.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this._frustum.setFromMatrix(p)},_setWorldOrientation:function(e){if(e!==this._worldOrientation){var t=this._worldOrientation.upAttribute,r=this._worldOrientation.rightAttribute,n=this._worldOrientation.frontAttribute;this._worldOrientation=e;var a=this._worldOrientation.upAttribute,s=this._worldOrientation.rightAttribute,o=this._worldOrientation.frontAttribute,l=new i.Vector3,c=this.getEyePosition();l[a]=c[t],l[s]=c[r],l[o]=c[n];var h=new i.Vector3,u=this.getUpDirection();h[a]=u[t],h[s]=u[r],h[o]=u[n];var d=new i.Vector3,p=this.getSightDirection();d[a]=p[t],d[s]=p[r],d[o]=p[n],this.moveTo({eyePosition:l,upDirection:h,sightDirection:d})}},dispose:function(){this._lockController(!1),this.setDefaultController(!1),this._setNode(null)}});return f._FOCUS_MODE={TRANSLATION:0,ROTATION:1},f.PERSPECTIVE=0,f.ORTHOGRAPHIC=1,UWA.namespace("THREEDS/Viewpoint",f)}),define("Visualization/Viewpoint",["DS/Visualization/Viewpoint","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Viewpoint"),e}),define("DS/Visualization/CollisionServices",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Plugins/ComposerContext","DS/Visualization/Viewpoint","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/GraphicAttributeSet"],function(e,t,i,r,n,a,s){"use strict";var o=e.singleton({init:function(){return this.collisionDepthComposers=new Map,this.collisionNormalComposers=new Map,this._clearCurrentData(),this.useDebug=!1,this.renderNormals=!1,this.disableBackFaceCulling=!0,this.skipTransparentItems=!1,this.readPixelPerfs=0,this.readPixelCount=0,this.currentCollision=null,window.__collisionService=this,this._bufferPool=new Map,this},_getBuffer(e,t){let i=e;"float32"==t&&(i*=4),this._bufferPool.has(i)||this._bufferPool.set(i,[]);let r,n=this._bufferPool.get(i);return r=n.length?n.splice(0,1)[0]:new Uint8Array(i),"float32"==t?r=new Float32Array(r.buffer):"uint8"==t&&(r=new Uint8Array(r.buffer)),r},_releaseBuffer(e){let t=e.BYTES_PER_ELEMENT*e.length;this._bufferPool.get(t).push(e)},setViewer:function(e){this.viewer=e,this.gl=this.viewer.getWebGLContext();let t={viewer:this.viewer,defaultController:!1};return this.vp=new r(t),this.vp.camera.pixelCulling=0,t.projectionType=r.ORTHOGRAPHIC,this.vpOrtho=new r(t),this.vpOrtho.camera.pixelCulling=0,this},_clearCurrentData:function(e){if(e){let t=this.data.get(e);t?(t.camera=null,t.frustumInfos=null,t.width=null,t.height=null,t.normalData&&this._releaseBuffer(t.normalData),t.normalData=null,t.depthData&&this._releaseBuffer(t.depthData),t.depthData=null,t.positionData&&this._releaseBuffer(t.positionData),t.positionData=null,t.cameraPositionData=null,t.farthest=null,t.nearest=null,t.depthComposer=null,t.normalComposer=null,t.colliderInfos=null):(t={camera:null,frustumInfos:null,width:null,height:null,normalData:null,depthData:null,positionData:null,farthest:null,nearest:null,depthComposer:null,normalComposer:null,colliderInfos:null},this.data.set(e,t))}else this.data=new Map},setCurrentData:function(e){this.currentData=this.data.get(e)},_setDebugInfos:function(e){this.debugInfos=e},_debug:function(){let e=this.currentData.width,t=this.currentData.height,i=this,r=document.getElementById("normal"),n=null,a=null;if(r){r.width=e,r.height=t,a=(n=r.getContext("2d")).createImageData(e,t);let s=i.getNormalData();for(let r=0;r<e*t;r++){let n=s[3*r],o=s[3*r+1],l=s[3*r+2],c=i.convertIndexToXY(r),h=c[0]+(t-1-c[1])*e;a.data[4*h+0]=255*n,a.data[4*h+1]=255*o,a.data[4*h+2]=255*l,a.data[4*h+3]=255}n.putImageData(a,0,0)}if(r=document.getElementById("depth")){r.width=e,r.height=t,a=(n=r.getContext("2d")).createImageData(e,t);let s=i.getDepthData();for(let r=0;r<e*t;r++){let n=255*(s[r]+1)/2,o=n,l=n,c=n;if(r==Math.floor(e/2)*t+Math.floor(e/2)&&(l=0,c=0),this.debugInfos)for(let e=0;e<this.debugInfos.length;e++){let t=this.debugInfos[e];if(this.isDirectAsymetricCollider(r,t.up,t.down,t.left,t.right,t.near,t.far)){o*=t.color[0],l*=t.color[1],c*=t.color[2];break}if(this.isDirectAsymetricCollider(r,t.up,t.down,t.left,t.right)){o*=.5*t.color[0],l*=.5*t.color[1],c*=.5*t.color[2];break}}let h=i.convertIndexToXY(r),u=h[0]+(t-1-h[1])*e;a.data[4*u+0]=o,a.data[4*u+1]=l,a.data[4*u+2]=c,a.data[4*u+3]=255}n.putImageData(a,0,0)}if(r=document.getElementById("position")){r.width=e,r.height=t,a=(n=r.getContext("2d")).createImageData(e,t);let s=i.getPositionData();for(let r=0;r<e*t;r++){let n=s[3*r],o=s[3*r+1],l=s[3*r+2],c=i.convertIndexToXY(r),h=c[0]+(t-1-c[1])*e;a.data[4*h+0]=255*n,a.data[4*h+1]=255*o,a.data[4*h+2]=255*l,a.data[4*h+3]=255}n.putImageData(a,0,0)}},_dlDepthTexture:function(e){let t=this.currentData.width,i=this.currentData.height,r=this;var n=document.createElement("canvas");n.width=t,n.height=i;let a=n.getContext("2d"),s=a.createImageData(t,i),o=r.getDepthData();for(let n=0;n<t*i;n++){let a=255*o[n],l=a,c=a,h=a;if(this.debugInfos&&e)for(let e=0;e<this.debugInfos.length;e++){let t=this.debugInfos[e];if(this.isDirectAsymetricCollider(n,t.up,t.down,t.left,t.right)){l*=t.color[0],c*=t.color[1],h*=t.color[2];break}}let u=r.convertIndexToXY(n),d=u[0]+(i-1-u[1])*t;s.data[4*d+0]=l,s.data[4*d+1]=c,s.data[4*d+2]=h,s.data[4*d+3]=255}a.putImageData(s,0,0);var l=document.createElement("a");l.download="depth.png",a.canvas.toBlob(function(e){l.href=URL.createObjectURL(e),l.click()})},_getViewpointFromCameraInfos:function(e){if(!e)return this.viewer.currentViewpoint;let i,r=e.near?e.near:this.viewer.currentViewpoint.camera.near,n=e.far?e.far:this.viewer.currentViewpoint.camera.far;if(e.camera)(i=this.vp).camera=e.camera,this.currentData.frustumInfos={near:r,far:n};else{let a,s,o,l,c,h;if(e.useOrtho){i=this.vpOrtho,h=e.top?e.top:1,c=e.bottom?e.bottom:1,l=e.right?e.right:1,o=e.left?e.left:1,i.camera.projectionMatrix.makeOrthographic(o,l,h,c,r,n),a=l-o,s=h-c}else{i=this.vp;let u=e.hfov?e.hfov:this.viewer.currentViewpoint.camera.fov,d=e.vfov?e.vfov:this.viewer.currentViewpoint.camera.fov;c=-(h=Math.tan(t.Math.degToRad(.5*d))*r),o=-(l=Math.tan(t.Math.degToRad(.5*u))*r),i.camera.projectionMatrix.makeFrustum(o,l,c,h,r,n),a=(l-o)*n/r,s=(h-c)*n/r}this.currentData.frustumInfos={left:o,right:l,bottom:c,top:h,near:r,far:n},this.currentData.colliderInfos={farH:a,farV:s},i.camera._renderingRole=t._CameraRoles.NONE;let u=e.position?e.position:this.viewer.currentViewpoint.getEyePosition(),d=e.sight?e.sight:this.viewer.currentViewpoint.getSightDirection(),p=e.up?e.up:this.viewer.currentViewpoint.getUpDirection(),f=i.camera.quaternion,m=i.camera.position,g=new t.Vector3;i.camera.matrix.lookAt(u,(new t.Vector3).addVectors(u,d),p),i.camera.matrix.setPosition(u),i.camera.matrix.decompose(m,f,g)}return i.camera.matrixWorld.copy(i.camera.matrix),i.camera.matrixWorldInverse.getInverse(i.camera.matrixWorld),i.camera.projectionMatrixInverse.getInverse(i.camera.projectionMatrix),i},_buildNormalArray:function(){let e=this.currentData.normalComposer.getResult(this.currentData.name);this.viewer.renderer.renderer.setRenderTarget(e);let t=this._getBuffer(4*this.currentData.width*this.currentData.height,"uint8");this.currentData.normalData=this._getBuffer(3*this.currentData.width*this.currentData.height,"float32");let i=this.currentData.normalData;this.gl.readPixels(0,0,this.currentData.width,this.currentData.height,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t);for(let e=0;e<this.currentData.width*this.currentData.height;e++){var r=t[4*e+0]/255*2-1,n=t[4*e+1]/255*2-1,a=t[4*e+2]/255*2-1,s=this.currentData.camera.matrixWorld.elements,o=1/(s[3]*r+s[7]*n+s[11]*a+s[15]);i[3*e]=(s[0]*r+s[4]*n+s[8]*a)*o,i[3*e+1]=(s[1]*r+s[5]*n+s[9]*a)*o,i[3*e+2]=(s[2]*r+s[6]*n+s[10]*a)*o}this._releaseBuffer(t)},_buildDepthArray:function(){let e=this.currentData.depthComposer.getResult(this.currentData.name);this.viewer.renderer.renderer.setRenderTarget(e);let t=this._getBuffer(4*this.currentData.width*this.currentData.height,"uint8"),i=performance.now();this.gl.readPixels(0,0,this.currentData.width,this.currentData.height,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t);let r=performance.now()-i;this.readPixelPerfs+=r,this.readPixelCount++,this.currentData.depthData=new Float32Array(t.buffer);let n=this.currentData.depthData,a=1,s=null,o=0,l=null;for(let e=0;e<this.currentData.width*this.currentData.height;e++)n[e]||(n[e]=1),n[e]<a&&(a=n[e],s=e),n[e]>o&&(o=n[e],l=e);this.currentData.farthest={index:l,depth:o},this.currentData.nearest={index:s,depth:a}},_buildPositionArray:function(){let e=this.getDepthData();this.currentData.positionData=this._getBuffer(3*this.currentData.width*this.currentData.height,"float32");let i=this.currentData.positionData;for(let r=0;r<this.currentData.width*this.currentData.height;r++){let n=this.convertIndexToXY(r);n[0]=n[0]/this.currentData.width*2-1,n[1]=n[1]/this.currentData.height*2-1;let a=2*e[r]-1,s=new t.Vector4(n[0],n[1],a,1);s.applyMatrix4(this.currentData.camera.projectionMatrixInverse),s.multiplyScalar(1/s.w),s.applyMatrix4(this.currentData.camera.matrixWorld),i[3*r]=s.x,i[3*r+1]=s.y,i[3*r+2]=s.z}},convertIndexToXY:function(e){let t=Math.floor(e/this.currentData.width);return[e-t*this.currentData.width,t]},convertXYToIndex:function(e,t){return t*this.currentData.width+e},computeCollision:function(e){let r=e||{};if(null!=e.near&&null!=e.far&&e.near>=e.far)return void console.warn("CollisionService: incoherent input infos, collision not computed");r.name||(r.name="default"),this._clearCurrentData(r.name),this.setCurrentData(r.name),this.currentData.name=r.name;let n=r.width?r.width:100,a=r.height?r.height:100;this.currentData.cameraPositionData=[];for(let e=0;e<n*a;e++)this.currentData.cameraPositionData[e]=null;let s=this.viewer.renderer;s.renderer.increaseFrameCount(t._FrameTypes.COLLISION);let o=this.collisionDepthComposers.get(r.name);if(!o){var l=new t.WebGLRenderTargetProperties(n,a,"uintNearest");l.generateMipmaps=!1,(o=new i(l,s.mainComposer,"depthCollisionComposerContext")).setPassClear(s.initClearPass,!0,new t.Color(0),0),s.setupOneMaterialComposerContext(o,0,0,!1),o.enablePass(s.initClearPass,!0),this.collisionDepthComposers.set(r.name,o)}this.currentData.depthComposer=o;let c=this.collisionNormalComposers.get(r.name);if(!c){var h=new t.WebGLRenderTargetProperties(n,a,"uintNearest");h.generateMipmaps=!1,(c=new i(h,s.mainComposer,"normalCollisionComposerContext")).setPassClear(s.initClearPass,!0,new t.Color(0),1),s.setupOneMaterialComposerContext(c,0,1,!1),c.enablePass(s.initClearPass,!0),this.collisionNormalComposers.set(r.name,c)}this.currentData.normalComposer=c;var u=!!s.compForwardComposerContext.getPassState(s.zPostPass).enabled;o.enablePass(s.zPostPass,u),c.enablePass(s.zPostPass,u),o.setSize(n,a,r.name),c.setSize(n,a,r.name),o.writeBuffer=null,c.writeBuffer=null,o.readBuffer=null,c.readBuffer=null,o.needsUpdate=!0,c.needsUpdate=!0,this.currentData.width=n,this.currentData.height=a;var d=this._getViewpointFromCameraInfos(e);this.currentData.camera=d.camera;var p=this.viewer.internalSceneGraph.scene,f=d.camera,m={main:f,mainNoJittering:f,connectedRobotCamera:d.connectedRobotCamera,robotCameraOrtho:d.robotCameraOrtho};if(this.disableBackFaceCulling){var g=this.viewer.renderer.renderer.disableBackFaceCulling;this.viewer.renderer.renderer.setDisableBackFaceCulling(!0)}this.skipTransparentItems?(o._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,c._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE):(o._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,c._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE),this.renderNormals&&(s.renderer.autoUpdateScene=!0,p.updateMatrixWorld(),s.mainComposer.updateScene(p),s._updateOITScene(p),s.renderer.materialToUse=t.MaterialToUse.normalMaterial,s.renderer.autoClearDepth=!0,s.renderer.autoClearStencil=!0,s.mainComposer.setComposerContext(c),s.mainComposer.render(void 0,void 0,m,r.name),c.needsUpdate=!1),s.renderer.autoUpdateScene=!0,p.updateMatrixWorld(),s.mainComposer.updateScene(p),s._updateOITScene(p),s.renderer.materialToUse=t.MaterialToUse.depthMaterial,s.renderer.autoClearDepth=!0,s.renderer.autoClearStencil=!0,s.mainComposer.setComposerContext(o),s.mainComposer.render(void 0,void 0,m,r.name),o.needsUpdate=!1,this.disableBackFaceCulling&&this.viewer.renderer.renderer.setDisableBackFaceCulling(g),this.useDebug&&this._debug()},getDepthData:function(){return this.currentData.depthData||this._buildDepthArray(),this.currentData.depthData},getNormalData:function(){return this.currentData.normalData||this._buildNormalArray(),this.currentData.normalData},getPositionData:function(){return this.currentData.positionData||this._buildPositionArray(),this.currentData.positionData},get3DpositionAtIndex:function(e){let i=2*this.getDepthData()[e]-1,r=this.convertIndexToXY(e);r[0]=r[0]/this.currentData.width*2-1,r[1]=r[1]/this.currentData.height*2-1;let n=new t.Vector4(r[0],r[1],i,1);return n.applyMatrix4(this.currentData.camera.projectionMatrixInverse),n.multiplyScalar(1/n.w),n.applyMatrix4(this.currentData.camera.matrixWorld),new t.Vector3(n.x,n.y,n.z)},get3DCameraPositionAtIndex:function(e){let i=2*this.getDepthData()[e]-1,r=this.convertIndexToXY(e);r[0]=r[0]/this.currentData.width*2-1,r[1]=r[1]/this.currentData.height*2-1;let n=new t.Vector4(r[0],r[1],i,1);return n.applyMatrix4(this.currentData.camera.projectionMatrixInverse),n.multiplyScalar(1/n.w),new t.Vector3(n.x,n.y,n.z)},getOptimized3DCameraPositionAtIndex:function(e){if(null==this.currentData.cameraPositionData[e]){let i=this.getDepthData()[e],r=this.convertIndexToXY(e),n=this.currentData.colliderInfos.farH,a=this.currentData.colliderInfos.farV,s=r[0]/this.currentData.width-.5;s*=n;let o=r[1]/this.currentData.height-.5;o*=a;let l=Math.min(this.getCameraDepth(i),this.currentData.frustumInfos.far),c=l/this.currentData.frustumInfos.far,h=s*c,u=o*c;this.currentData.cameraPositionData[e]=new t.Vector3(h,u,l)}return this.currentData.cameraPositionData[e]},getFarthest:function(){return this.currentData.farthest||this._buildDepthArray(),this.currentData.farthest},getNearest:function(){return this.currentData.nearest||this._buildDepthArray(),this.currentData.nearest},getCameraDepth:function(e){let t=this.currentData.frustumInfos.near,i=this.currentData.frustumInfos.far;return t*i/(e*(t-i)+i)},getNoLinearCameraDepth:function(e){let t=this.currentData.frustumInfos.near,i=this.currentData.frustumInfos.far;return(t*i/e-i)/(t-i)},isDirectCollider:function(e,t,i,r,n){let a=void 0!==r?r:this.currentData.frustumInfos.near,s=void 0!==n?n:this.currentData.frustumInfos.far;return this.isDirectAsymetricCollider(e,t,-t,-i,i,a,s)},isDirectAsymetricCollider:function(e,t,i,r,n,a,s){let o=void 0!==a?a:this.currentData.frustumInfos.near,l=void 0!==s?s:this.currentData.frustumInfos.far;return this.isGenericCollider(e,function(e){let a=e.x,s=e.y,c=e.z;return a<=n&&a>=r&&s<=t&&s>=i&&c>=o&&c<=l})},isEdgingCollider:function(e,t,i,r,n,a,s,o){let l=void 0!==a?a:this.currentData.frustumInfos.near;return this.isGenericCollider(e,function(e){let a=e.x,c=e.y,h=e.z,u=(a-r)/(n-r);return a<=n&&a>=r&&c<=t&&c>=i&&h>=l&&h<=s*(1-u)+o*u})},isArcingDepthFromTopCollider:function(e,t,i,r,n,a,s){let o=void 0!==a?a:this.currentData.frustumInfos.near,l=void 0!==s?s:this.currentData.frustumInfos.far;return this.isGenericCollider(e,function(e){let a=e.x,s=e.y,c=e.z;if(a<=n&&a>=r&&s<=t&&s>=i){let e=1-s/(t-i),r=o+(l-o)*Math.sqrt(1-e*e);return c>=o&&c<=r}return!1})},isArcingDepthFromBottomCollider:function(e,t,i,r,n,a,s){let o=void 0!==a?a:this.currentData.frustumInfos.near,l=void 0!==s?s:this.currentData.frustumInfos.far;return this.isGenericCollider(e,function(e){let a=e.x,s=e.y,c=e.z;if(a<=n&&a>=r&&s<=t&&s>=i){let e=s/(t-i),r=o+(l-o)*Math.sqrt(1-e*e);return c>=o&&c<=r}return!1})},isInsideCylinder:function(e,t){let i=this.currentData.frustumInfos.near;return this.isGenericCollider(e,function(e){let r=e.x,n=(e.y,e.z);return(n-t-i)*(n-t-i)+r*r<t*t})},isGenericCollider:function(e,t){return t(this.getOptimized3DCameraPositionAtIndex(e))},getPrecisePositionAtPick_firstImpl(e){var t=this.viewer.currentViewpoint.camera.clone(this.vp.camera),i=null;t.fullWidth&&(i={fullWidth:t.fullWidth,fullHeight:t.fullHeight,x:t.x,y:t.y,width:t.width,height:t.height}),t.useRealSize=!0;var r=Math.round(e.xPix),n=Math.round(e.yPix),a=this.viewer.renderer.renderer.getViewportSize(),s=a.width,o=a.height;if(i){var l,c;l=i.width/i.fullWidth,c=i.height/i.fullHeight;var h=i.fullWidth/s,u=i.fullHeight/o;s=i.fullWidth,o=i.fullHeight,n*=u,r=(r*=h)*l+i.x,n=n*c+i.y,currentPickingToleranceX*=l,currentPickingToleranceY*=c,trapXdist*=l,trapYdist*=c}t.setViewOffsetInternal(s,o,r,n,1,1,{ratioW:1/a.width,ratioH:1/a.height},!0);let d=this.currentData?this.currentData.name:null,p=t.far,f=t.near,m={name:"PreciseDepth",camera:t,near:f,far:p,width:1,height:1};this._setDebugInfos([]),this.computeCollision(m);let g=this.getDepthData()[0],v=this.getCameraDepth(g),S=(this.get3DpositionAtIndex(0),v-f);if(f=v-.001*S,p=v+.001*(S=p-v),t.near=f,t.far=p,t.updateProjectionMatrix(),m.near=f,m.far=p,this.computeCollision(m),this.getDepthData()[0]==g){this.computeCollision(m);this.getDepthData()[0]}let _=this.get3DpositionAtIndex(0);return d&&this.setCurrentData(d),_},getPrecisePositionAtPick(e,i){var r=Math.round(e.xPix),n=Math.round(e.yPix);let a=this.viewer.renderer.renderer.getViewportSize();var s=this.viewer.currentViewpoint,o=s.camera,l=s.getEyePosition(),c=s.getSightDirection().normalize(),h=s.getUpDirection().normalize(),u=(new t.Vector3).crossVectors(c,h).normalize(),d=s.getAngle()/2;c.multiplyScalar(1/Math.tan(d*Math.PI/180));let p=2*(r/a.width-.5),f=2*(n/a.height-.5);h.multiplyScalar(-f),u.multiplyScalar(p*a.width/a.height),c.addVectors(c,h),c.addVectors(c,u),c.normalize(),h.set(-c.z,c.x,-c.y),u.crossVectors(c,h),h.crossVectors(u,c);let m,g=o.far,v=o.near,S={name:"PreciseDepth2",near:v,far:g,useOrtho:!0,top:.5,bottom:-.5,left:-.5,right:.5,position:l,sight:c,up:h,width:1,height:1},_=this.currentData?this.currentData.name:null;this._setDebugInfos([]),i&&(m=this.renderNormals,this.renderNormals=!0),this.computeCollision(S),i&&(this.renderNormals=m);let y=1*Math.floor(.5)+Math.floor(.5),x=this.getDepthData()[y],M=null;if(1!=x){i&&(i.x=this.getNormalData()[3*y],i.y=this.getNormalData()[3*y+1],i.z=this.getNormalData()[3*y+2]);M=this.get3DpositionAtIndex(y)}return _&&this.setCurrentData(_),M}});return UWA.namespace("THREEDS/Collision",o)}),define("DS/SWXCoreManipulation/SWXCoreViewManipulation",["UWA/Core","UWA/Class","UWA/Utils/Client","DS/VisuEvents/EventsManager","DS/Visualization/TrackballControls","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Visualization/Viewpoint","DS/Mesh/MeshUtils","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/PathElement","DS/Visualization/SceneGraphFactory","DS/Visualization/SubElement","DS/Visualization/GeometryHelper","DS/Visualization/Node3D","DS/SceneGraphNodes/BillBoardNode3D","DS/Utilities/TouchUtils"],function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g,v){"use strict";const S=t.extend({addVisuEvent:function(e,t,i){for(var n=0;n<this._eventCallbacks.length;n++){var a=this._eventCallbacks[n];if(a.view===e&&a.action===t&&a.callback===i)return void++this._eventCallbacks[n].count}var s={view:e,action:t,callback:i,count:1};r.addEvent(e,t,i),this._eventCallbacks.push(s)},removeVisuEvent:function(e,t,i){let n=-1;for(var a=0;a<this._eventCallbacks.length&&-1===n;a++){const r=this._eventCallbacks[a];r.view===e&&r.action===t&&r.callback===i&&(n=a)}if(-1!==n&&(--this._eventCallbacks[n].count,0===this._eventCallbacks[n].count)){var s=this._eventCallbacks[n];r.removeEvent(s.view,s.action,s.callback),this._eventCallbacks.splice(n,1)}},init:function(){this.scrollZoomCb=this.scrollZoom.bind(this),this.leftMouseDownCb=this.leftMouseDown.bind(this),this.leftMouseMoveCb=this.leftMouseMove.bind(this),this.leftMouseUpCb=this.leftMouseUp.bind(this),this.middleMouseDownCb=this.middleMouseDown.bind(this),this.middleMouseMoveCb=this.middleMouseMove.bind(this),this.middleMouseUpCb=this.middleMouseUp.bind(this),this.rightMouseDownCb=this.rightMouseDown.bind(this),this.rightMouseMoveCb=this.rightMouseMove.bind(this),this.alwaysonMouseOutCb=this.alwaysonMouseOut.bind(this),this.rightMouseUpCb=this.rightMouseUp.bind(this),this.keyDownCb=this.keyDown.bind(this),this.keyUpCb=this.keyUp.bind(this),this.alwaysOnMouseMoveCb=this.alwaysOnMouseMove.bind(this),this.alwaysOnLeftUpCb=this.alwaysOnLeftUp.bind(this),this.windowWheelEventCB=this.windowWheelEvent.bind(this),this.enableViewerCallbacks=!1,this._eventCallbacks=[]},setup:function(e){this.options=e||{},this.isMacOS=Boolean(this.options.IsMacOS||i.Platform.macintel),this.isSafari=Boolean(this.options.IsSafari||i.Engine.safari),this.isTouch=Boolean(this.options.IsTouch||i.Features.touch),this.setupTouchEvents(),this.viewer=e.viewer,this.viewPoint=this.viewer.currentViewpoint,this.control=this.viewPoint.control,this.rotateCenterOfModel=new a.Vector3(0,0,0),this.lastCursor=null,this.originalCursor=null,this.isEscapable=!1,this.isRotating=!1,this.isPanning=!1,this.isZooming=!1,this.isAnimating=!1,this.isShiftPinchTriggered=!1,this.zoomToCenterDeltaY=0,this.customMouseMoveHandler=null,e.customMouseMoveHandler&&(this.customMouseMoveHandler=e.customMouseMoveHandler),this.customPrepareForRotationHandler=null,e.customPrepareForRotationHandler&&(this.customPrepareForRotationHandler=e.customPrepareForRotationHandler),this._origCenterMouseUpCB=this.viewer.centerMouseUpCB},enable:function(){if(!this._enabled){if(this._enabled=!0,this._controlsConfigEventToken=s.subscribe({event:"/SWXVisu/ControlsConfig"},e=>{this.enableViewerCallbacks=e.viewerCallbacks}),void 0===r._isInit&&r.init(),this.addVisuEvent(this.viewer.canvas,"onLeftMouseDown",this.leftMouseDownCb),this.addVisuEvent(this.viewer.canvas,"onMiddleMouseDown",this.middleMouseDownCb),this.isMacOS&&this.isSafari||this.addVisuEvent(this.viewer.canvas,"onRightMouseDown",this.rightMouseDownCb),this.addVisuEvent(this.viewer.canvas,"onKeyDown",this.keyDownCb),this.addVisuEvent(this.viewer.canvas,"onKeyUp",this.keyUpCb),this.addVisuEvent(this.viewer.canvas,"onMouseMove",this.alwaysOnMouseMoveCb),this.addVisuEvent(this.viewer.canvas,"onLeftMouseUp",this.alwaysOnLeftUpCb),this.isMacOS){this.addBrowserEvent(window,"wheel",this.windowWheelEventCB,{passive:!1});for(var e=0;e<window.length;e++)1===e&&(this.addBrowserEvent(window[e],"gesturestart",this.windowGestureStartEvent.bind(this,e)),this.addBrowserEvent(window[e],"gesturechange",this.windowGestureChangeEvent.bind(this,e)),this.addBrowserEvent(window[e],"gestureend",this.windowGestureEndEvent.bind(this,e)))}else this.addVisuEvent(this.viewer.canvas,"onMouseWheel",this.scrollZoomCb);this._origControlLockMouse=this.control.lockMouse,this.control.setMouseActive(!1),this.setupRotationHelpers()}},addBrowserEvent:function(e,t,i,r){this._browserEvents||(this._browserEvents=[]),e.addEventListener(t,i,r),this._browserEvents.push({target:e,name:t,cb:i})},disable:function(){this._enabled&&(this._enabled=!1,this.control.setMouseActive(!this._origControlLockMouse),this._controlsConfigEventToken&&(s.unsubscribe(this._controlsConfigEventToken),this._controlsConfigEventToken=null),this._eventCallbacks.forEach(e=>{r.removeEvent(e.view,e.action,e.callback)}),this._eventCallbacks=[],this._browserEvents&&(this._browserEvents.forEach(e=>{e.target.removeEventListener(e.name,e.cb)}),this._browserEvents=[]),this.viewer&&(this.viewer.centerMouseUpCB=this._origCenterMouseUpCB))},setupTouchEvents:function(){if(this.isTouch){void 0===r._isInit&&r.init();var e=function(e){this.endRotation(null),window.visualViewport&&window.visualViewport.scale>1?(this._touchEventsUnsubscribedOnBrowserZoomLevel||(r._detachTouchEvents(),this._touchEventsUnsubscribedOnBrowserZoomLevel=!0),e.stopPropagation()):this._touchEventsUnsubscribedOnBrowserZoomLevel&&!e.touches.length&&(this._touchEventsUnsubscribedOnBrowserZoomLevel=!1,r._attachTouchEvents())};document.addEventListener("touchend",e.bind(this),{capture:!0,passive:!1}),document.addEventListener("touchcancel",e.bind(this),{capture:!0,passive:!1});var t=function(e){this._touchEventsUnsubscribedOnBrowserZoomLevel&&e.stopPropagation()};document.addEventListener("touchstart",t.bind(this),{capture:!0,passive:!1}),document.addEventListener("touchmove",t.bind(this),{capture:!0,passive:!1})}},windowWheelEvent:function(e){if(e){if(this.viewer.canvas!==e.target){let t=e.target,i=Math.abs(e.deltaY)>Math.abs(e.deltaX);for(;!i&&t&&t!==document.body;){let r=window.getComputedStyle(t);(i=("auto"===r.getPropertyValue("overflow-x")||"scroll"===r.getPropertyValue("overflow-x"))&&t.scrollWidth>t.offsetWidth)&&(0===t.scrollLeft&&e.deltaX<0||t.scrollLeft>=t.scrollWidth-t.offsetWidth&&e.deltaX>0)&&(i=!1),t=t.parentElement}return void(i||e.preventDefault())}e.preventDefault()}if(e&&e.target&&!this._rightMouseDown){var t;if(0===e.deltaX&&Math.trunc(e.deltaY)-e.deltaY!=0)return this.scrollZoom(e);try{t=this.viewer.canvas.getBoundingClientRect()}catch(e){t={left:0,top:0}}var i=new a.Vector2(e.clientX-t.left,e.clientY-t.top);if(this.wheelLastPosition&&this.wheelLastPosition.x===i.x&&this.wheelLastPosition.x===i.y||(this.wheelLastPosition=i.clone(),void 0===this._zoomFactor&&(this._zoomFactor=0)),this.isCtrlPressed(e)){var r=e.deltaY<0,s=this.control._zoomType,o=this._zoomFactor;if(o+=r?-1:1,Math.abs(e.deltaY)>1&&o<100){var l=this.wheelLastPosition;this.setCursor("Zoom"),s===n.ZoomType.ZOOM_FOV_CHANGE?this.control._zoomFOVChange(l,r,r?.95:1.05):this.control._zoomSimple(l,r,r?.95:1.05),this.control.update(),this._zoomFactor=o,this.resetCursorWithTimeout()}}else{var c=i.clone();if(c.x-=2*e.deltaX,c.y-=2*e.deltaY,e.altKey)this.setCursor("Pan"),this.doPan(c,this.wheelLastPosition),this.resetCursorWithTimeout();else{e.shiftKey&&this.isZooming&&(this.isRotating=!1,this.isPanning=!1,this.isZooming=!1,this.restoreOriginalCursor(),this.isShiftPinchTriggered=!1),e.currentPosition=c,null===this.rotationOriginVisuHelper.originVisu&&(!1===this.rotationOriginVisuHelper.rotationCursor&&(this.saveOriginalCursor(),this.rotationOriginVisuHelper.rotationCursor=!0,this.prepareForRotation(e)),this.setCursor("Rotate")),this.doRotate(c,this.wheelLastPosition),this.rotationOriginVisuHelper.wheeling&&(clearTimeout(this.rotationOriginVisuHelper.wheeling),this.rotationOriginVisuHelper.wheeling=null);let t=Number(this.options.RotationTrackpadTimeout||250);this.rotationOriginVisuHelper.wheeling=setTimeout(()=>{clearTimeout(this.rotationOriginVisuHelper.wheeling),this.rotationOriginVisuHelper.wheeling=null,this.restoreOriginalCursor(),this.rotationOriginVisuHelper.rotationCursor=!1,this.endRotation(e)},t)}}}},resetCursorWithTimeout:function(){this.wheelGestureTimeout&&(clearTimeout(this.wheelGestureTimeout),this.wheelGestureTimeout=null);let e=this.options.RotationTrackpadTimeout||250;this.wheelGestureTimeout=setTimeout(()=>{clearTimeout(this.wheelGestureTimeout),this.wheelGestureTimeout=null,this.setCursor("auto")},e)},windowGestureStartEvent:function(e,t){var i;t.preventDefault();try{i=this.viewer.canvas.getBoundingClientRect()}catch(e){i={left:0,top:0}}this.rotation=0,this.scale=0,this.position=new a.Vector2(t.clientX-i.left,t.clientY-i.top)},windowGestureChangeEvent:function(e,t){if(t&&t.preventDefault(),!this._rightMouseDown){var i;try{i=this.viewer.canvas.getBoundingClientRect()}catch(e){i={left:0,top:0}}var r=new a.Vector2(t.clientX-i.left,t.clientY-i.top),s=-2.5*t.rotation,o=t.scale;if(Math.abs(o-this.scale)>.01&&o>.01&&o<4){var l=o-this.scale>0,c=r;this.control._zoomType===n.ZoomType.ZOOM_FOV_CHANGE?this.control._zoomFOVChange(c,l,l?.95:1.05):this.control._zoomSimple(c,l,l?.95:1.05),this.control.update(),this.scale=o}var h=s-this.rotation;if(this.rotation=s,Math.abs(h)>1){var u=new a.Vector2(h,0),d=new a.Vector2(0,0);this.doRotate(u,d,!0)}}},windowGestureEndEvent:function(e,t){t.preventDefault()},alwaysOnMouseMove:function(e){var t=e.from&&e.from.length?e.from[0]:null;null!==t&&(e.from.length<=1&&(this.rotationOriginVisuHelper.rmbRotationOn&&this.rightMouseUp(e),this.rotationOriginVisuHelper.mmbRotationOn&&this.middleMouseUp(e)),this.enableViewerCallbacks&&(this.control._publishWUXEvent("PrimaryPointerMove",e,!0),this.control._pickingCB&&this.viewer&&this.viewer.mouseMoveCB&&this.viewer.mouseMoveCB(t,this.control)))},alwaysOnLeftUp:function(e){var t=e.from&&e.from.length?e.from[0]:null;null!==t&&this.enableViewerCallbacks&&(this.control._publishWUXEvent("PrimaryPointerUp",e,!1),this.control._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this.control))},leftMouseDown:function(e){this.rotationOriginVisuHelper.rmbRotationOn&&this.rightMouseUp(e),this.rotationOriginVisuHelper.mmbRotationOn&&this.middleMouseUp(e);var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){var i=this.control._forcePan||this.control._forceRotate||this.control._forceZoom;if(this.enableViewerCallbacks&&(this.control._publishWUXEvent("PrimaryPointerDown",e,!1),this.control.startLeftClick(),this.control._pickingCB&&this.viewer&&this.viewer.leftMouseDownCB&&(this.viewer.leftMouseDownCB(t,this.control),this.viewer.trapSelection&&i&&this.viewer.trapSelection.interrupt())),i){this.saveOriginalCursor();var r=this.getModelBoundingBox();r&&!r.isNaN()?this.rotateCenterOfModel.copy(r.center()):this.rotateCenterOfModel.set(0,0,0),this.addVisuEvent(document,"onLeftMouseUp",this.leftMouseUpCb),this.addVisuEvent(document,"onMouseMove",this.leftMouseMoveCb),this.control._changeState(n.State.NONE),this.control.setMouseActive(!0),!1===this.isPanning&&!1===this.isZooming&&this.control._onLeftMouseDown(e),this.control.setMouseActive(!1)}}},leftMouseMove:function(e){var t=e.gesture.currentEvent[0],i=this.control.getManipulationState();i===n.State.ZOOM||i===n.State.FORCE_ZOOM?(this.isRotating=!1,this.isPanning=!1,this.isZooming=!0,this.setCursor("Zoom"),this.doZoom(t.currentPosition,t.lastPosition)):i===n.State.PAN||i===n.State.FORCE_PAN?(this.isRotating=!1,this.isPanning=!0,this.isZooming=!1,this.setCursor("Pan"),this.doPan(t.currentPosition,t.lastPosition)):i!==n.State.ROTATE&&i!==n.State.FORCE_ROTATE||(this.isRotating=!0,this.isPanning=!1,this.isZooming=!1,this.setCursor("Rotate"),this.doRotate(t.currentPosition,t.lastPosition,!1))},leftMouseUp:function(e){this.control.setMouseActive(!0),!1===this.isPanning&&!1===this.isZooming&&this.control._onLeftMouseUp(e),this.control.setMouseActive(!1),this.removeVisuEvent(document,"onLeftMouseUp",this.leftMouseUpCb),this.removeVisuEvent(document,"onMouseMove",this.leftMouseMoveCb),this.restoreOriginalCursor(),this.isRotating=!1,this.isPanning=!1,this.isZooming=!1},setControllerMouseWheelState:function(){let e=this.viewer.currentViewpoint.getControl();e&&(e._wheelMoving=!0,e._wheelTimer&&clearTimeout(this._wheelTimer),e._wheelTimer=setTimeout(function(){e._wheelMoving=!1,clearTimeout(e._wheelTimer),e._wheelTimer=null},300))},scrollZoom:function(t){var i=0,r=new a.Vector2(0,0);if(t.gesture&&t.gesture.currentEvent){var s=t.gesture.currentEvent[0];i=e.Event.wheelDelta(s.getJSEvent()),r=s.currentPosition,s.event.preventDefault()}else{var o;i=t.deltaY;try{o=this.viewer.canvas.getBoundingClientRect()}catch(e){o={left:0,top:0}}r.x=t.clientX-o.left,r.y=t.clientY-o.top,t.preventDefault()}var l=new a.Vector2(this.control.domElement.clientWidth/2,this.control.domElement.clientHeight/2),c=!1;widget&&widget.getPreference("ReverseZoom")&&(c="Reverse"===widget.getPreference("ReverseZoom").value),this.setControllerMouseWheelState();var h=c?i>0:i<0,u=this.control._zoomType,d=l.clone();if(t.shiftKey||t&&t.from&&t.from[0]&&t.from[0].getJSEvent()&&t.from[0].getJSEvent().shiftKey){if(!this.isShiftPinchTriggered){this.saveOriginalCursor();var p=.25*(this.control.domElement.clientWidth+this.control.domElement.clientHeight);this.zoomToCenterDeltaY=.028/(.5/p),this.isShiftPinchTriggered=!0,this.lastCursor=null}this.isRotating=!1,this.isPanning=!1,this.isZooming=!0,this.setCursor("Zoom")}let f=new URLSearchParams(window.location.search).has("zoomMode")?r:l;h?this.isShiftPinchTriggered?(d.y+=this.zoomToCenterDeltaY,this.doZoom(l,d)):u===n.ZoomType.ZOOM_FOV_CHANGE?this.control._zoomFOVChange(r,h):this.isMacOS&&t.ctrlKey?this.control._zoomSimple(r,h,.95):this.control._zoomSimple(r,h):this.isShiftPinchTriggered?(d.y-=this.zoomToCenterDeltaY,this.doZoom(l,d)):u===n.ZoomType.ZOOM_FOV_CHANGE?this.control._zoomFOVChange(f,h):this.isMacOS&&t.ctrlKey?this.control._zoomSimple(f,h,1.05):this.control._zoomSimple(f,h),this.control.update()},middleMouseDown:function(e){if(!(this.control._forcePan||this.control._forceRotate||this.control._forceZoom)&&!0!==this.control._2DMode){this.isRotating&&(this.rotationOriginVisuHelper.rmbRotationOn||this.rotationOriginVisuHelper.mmbRotationOn)&&(this.endRotation(null),this.rotationOriginVisuHelper.rmbRotationOn=!1,this.rotationOriginVisuHelper.mmbRotationOn=!1,this.restoreOriginalCursor()),this.saveOriginalCursor();var t=e.from[0].getJSEvent(),i=e.from[0].getCurrentPosition(this.viewer.canvas),r=this.viewer.getMousePosition(i),s=this.viewer.pick(r,"mesh",!0);if(this.rotaxData=t&&t.shiftKey&&(this.isCtrlPressed(t)||t.metaKey)?this.viewer.pick(r,"prim",!0):null,this.rotaxData){var o=this.getModelBoundingBox();if(o&&!o.isNaN()){var l=s&&s.path&&s.path.length>0,c=new a.Vector3,h=this.viewPoint.getUpDirection().clone();l?this.rotaxData&&!this.getRollAxisFromSelection(this.rotaxData)&&this.rotaxData.position?this.rotateCenterOfModel.copy(this.rotaxData.position):(c.crossVectors(this.viewPoint.getSightDirection(),this.viewPoint.getUpDirection()),c.normalize(),c.multiplyScalar(o.getBoundingSphere().radius),c.add(this.control.target),h.normalize(),h.multiplyScalar(o.getBoundingSphere().radius),h.add(this.control.target),this.rotaxData&&this.rotaxData.position?this.rotateCenterOfModel.copy(this.rotaxData.position):this.viewPoint.project(c).x>this.viewer.SCREEN_WIDTH&&this.viewPoint.project(h).y<0?this.rotateCenterOfModel.copy(s.position):this.rotateCenterOfModel.copy(o.center())):this.rotateCenterOfModel.copy(o.center())}else this.rotateCenterOfModel.set(0,0,0)}else this.rotationOriginVisuHelper.mmbRotationOn=!0,this.prepareForRotation(e);this.viewer.centerMouseUpCB=null,this.control._changeState(n.State.STOP),this.viewer.currentViewpoint._isMoving=!0,t.shiftKey?this.setCursor("Zoom"):this.isCtrlPressed(t)||t.metaKey?this.setCursor("Pan"):this.setCursor("Rotate"),this.addVisuEvent(document,"onMiddleMouseUp",this.middleMouseUpCb),this.addVisuEvent(document,"onMouseMove",this.middleMouseMoveCb),this.addVisuEvent(this.viewer.canvas,"onMouseOut",this.alwaysonMouseOutCb)}},stopMiddleMouseRotation:function(){this.removeVisuEvent(document,"onMiddleMouseUp",this.middleMouseUpCb),this.removeVisuEvent(document,"onMouseMove",this.middleMouseMoveCb),this.removeVisuEvent(this.viewer.canvas,"onMouseOut",this.alwaysonMouseOutCb),this.isRotating=!1,this.isPanning=!1,this.isZooming=!1,this.control._changeState(n.State.NONE),this.viewer.currentViewpoint._isMoving=!1,this.restoreOriginalCursor()},middleMouseMove:function(e){if(!0===this.control._2DMode)return;var t=e.from[0].getJSEvent(),i=e.gesture.currentEvent[0];if(!t.buttons)return void this.stopMiddleMouseRotation();let r=!1;if(e.from.forEach(e=>{e&&e.view&&"IFRAME"!==e.view.tagName&&e.button&&-1!==e.button&&(r=!0)}),this.rotaxData=t.shiftKey&&this.isCtrlPressed(t)?this.rotaxData:null)this.isRotating=!0,this.isPanning=!1,this.isZooming=!1,this.setCursor("Rotate"),r?this.doRotate(i.currentPosition,i.lastPosition):this.middleMouseUp(e);else if(t.shiftKey)this.isRotating=!1,this.isPanning=!1,this.isZooming=!0,this.setCursor("Zoom"),this.doZoom(i.currentPosition,i.lastPosition);else if(this.isCtrlPressed(t)||t.metaKey)if(this.isRotating=!1,this.isPanning=!0,this.isZooming=!1,this.setCursor("Pan"),this.control.lockPan)this.doPan(i.currentPosition,i.lastPosition);else{var n={gesture:e.gesture,defaultBehavior:!0};this.control._modelEvent.publish({event:"Pan",data:n,context:this.control}),n.defaultBehavior&&this.doPan(i.currentPosition,i.lastPosition)}else this.isRotating=!0,this.isPanning=!1,this.isZooming=!1,this.setCursor("Rotate"),r?this.doRotate(i.currentPosition,i.lastPosition,t.altKey):this.middleMouseUp(e);t&&t.preventDefault()},middleMouseUp:function(e){!0!==this.control._2DMode&&(this.rotationOriginVisuHelper.mmbRotationOn&&this.endRotation(e),this.stopMiddleMouseRotation())},rightMouseDown:function(e){if(!0!==this.control._2DMode&&(this._rightMouseDown=!0,!(this.control._forcePan||this.control._forceRotate||this.control._forceZoom))){(this.rotationOriginVisuHelper.wheeling||this.isRotating&&(this.rotationOriginVisuHelper.mmbRotationOn||this.rotationOriginVisuHelper.rmbRotationOn))&&(this.rotationOriginVisuHelper.mmbRotationOn=!1,this.rotationOriginVisuHelper.rmbRotationOn=!1,this.restoreOriginalCursor(),this.endRotation(null)),this.saveOriginalCursor();var t=e.from[0].getJSEvent();if(!t.shiftKey&&!this.isCtrlPressed(t)&&!t.metaKey){let i=!0;this.customPrepareForRotationHandler&&(i=this.customPrepareForRotationHandler(t)),i&&(this.rotationOriginVisuHelper.rmbRotationOn=!0,this.prepareForRotation(e))}this.viewer.centerMouseUpCB=null,this.control._changeState(n.State.STOP),this.isEscapable=!0,this.addVisuEvent(document,"onRightMouseUp",this.rightMouseUpCb),this.addVisuEvent(document,"onMouseMove",this.rightMouseMoveCb),this.addVisuEvent(this.viewer.canvas,"onMouseOut",this.alwaysonMouseOutCb)}},rightMouseMove:function(e){if(!0!==this.control._2DMode){var t=e.from[0].getJSEvent(),i=e.gesture.currentEvent[0];if(this.viewer.currentViewpoint._isMoving=!0,t.shiftKey)this.isRotating=!1,this.isPanning=!1,this.isZooming=!0,this.setCursor("Zoom"),this.doZoom(i.currentPosition,i.lastPosition);else if(this.isCtrlPressed(t)||t.metaKey)this.isRotating=!1,this.isPanning=!0,this.isZooming=!1,this.setCursor("Pan"),this.doPan(i.currentPosition,i.lastPosition);else{let r=!1;e.from.forEach(e=>{e&&e.view&&"IFRAME"!==e.view.tagName&&e.button&&-1!==e.button&&(r=!0)}),r?(this.isRotating=!0,this.isPanning=!1,this.isZooming=!1,this.customMouseMoveHandler?this.customMouseMoveHandler(this,i,t):(this.setCursor("Rotate"),this.doRotate(i.currentPosition,i.lastPosition,t.altKey))):this.rightMouseUp(e)}}},alwaysonMouseOut:function(e){e&&e.from&&e.from[0]&&(this.rotationOriginVisuHelper.rmbRotationOn||this.rotationOriginVisuHelper.mmbRotationOn)&&(this.endRotation(e),delete this._rightMouseDown,this.endMouseManipulation(),this.stopMiddleMouseRotation())},rightMouseUp:function(e){if(!0!==this.control._2DMode){if(e&&e.from&&e.from[0]){var t=e.from[0].getJSEvent();t.shiftKey||this.isCtrlPressed(t)||t.metaKey||!this.rotationOriginVisuHelper.rmbRotationOn||this.endRotation(e)}delete this._rightMouseDown,this.endMouseManipulation()}},endMouseManipulation:function(){this.removeVisuEvent(document,"onRightMouseUp",this.rightMouseUpCb),this.removeVisuEvent(document,"onMouseMove",this.rightMouseMoveCb),this.removeVisuEvent(this.viewer.canvas,"onMouseOut",this.alwaysonMouseOutCb),this.isEscapable=!1,this.isRotating=!1,this.isPanning=!1,this.isZooming=!1,this.control._changeState(n.State.NONE),this.viewer.currentViewpoint._isMoving=!1,this.restoreOriginalCursor()},setCursor:function(e){e!==this.lastCursor&&("Rotate"===e&&this.options.rotateAroundTargetUrl&&this.rotationOriginVisuHelper&&this.rotationOriginVisuHelper.origin?this.viewer.setCursor(this.options.rotateAroundTargetUrl,0,!0):this.viewer.setCursor(e),this.lastCursor=e)},saveOriginalCursor:function(){this.originalCursor=this.viewer.canvas.style.cursor},restoreOriginalCursor:function(){null!==this.originalCursor?this.viewer.canvas.style.cursor=this.originalCursor:this.viewer.setCursor("auto"),this.originalCursor=null,this.lastCursor=null},doPan:function(e,t){this.control._pan(e,t),this.control.update()},doZoom:function(e,t){this.control._zoom(e,t),this.control.update()},doRotate:function(e,t,i,r){if(!0===this.control._2DMode)return;var n,o,l,c,h,u=e.x-t.x,d=e.y-t.y,p=new a.Vector3,f=this.control.orientation.clone(),m=this.control.target.clone(),g=(new a.Vector3).subVectors(m,this.rotateCenterOfModel);if(m.sub(this.rotateCenterOfModel),0===u&&0===d)return;u/=3,d/=3;var v=this.rotaxData&&(this.rotaxData.tangent||this.rotaxData.normal);if("CATXGDWebLocalApp"==window.widget.getValue("appId"))this.control.lockZ=!0;else{let e=window.widget.getValue("Rotation");this.control.lockZ="Gravity"==e}if(this.control.lockZ){var S=this.control.viewpoint._worldOrientation.upAttribute,_=this.control.camera.getLookAt()[S];0===(_=+_)||isNaN(_)?this.control.rotateDirection=_:this.control.rotateDirection=-1,u*=3,d*=3,f=this.control.viewpoint._worldOrientation.getOrientationForLockedRotation(-this.control.rotateDirection*u*this.control.lockZRotationSpeed,d*this.control.lockZRotationSpeed,this.control.orientation)}else v?(n=Math.abs(u)>Math.abs(d)?a.Math.degToRad(u):a.Math.degToRad(d),o=(new a.Quaternion).setFromAxisAngle(v,n),m.applyQuaternion(o),f.multiplyQuaternions(o,f)):i?0!==u&&(n=a.Math.degToRad(u),o=(new a.Quaternion).setFromAxisAngle(this.viewPoint.getSightDirection(),n),m.applyQuaternion(o),f.multiplyQuaternions(o,f)):(0!==u&&(n=a.Math.degToRad(-u),o=(new a.Quaternion).setFromAxisAngle(this.viewPoint.getUpDirection(),n),m.applyQuaternion(o),f.multiplyQuaternions(o,f)),0!==d&&(l=a.Math.degToRad(-d),p.crossVectors(this.viewPoint.getSightDirection(),this.viewPoint.getUpDirection()),c=(new a.Quaternion).setFromAxisAngle(p,l),m.applyQuaternion(c),f.multiplyQuaternions(c,f)));if(f.normalize(),r){this.isAnimating=!0;var y=this,x=s.subscribe({event:"/VISU/"},function(e){"@onViewpointEndMove"===e.eventType&&(y.isAnimating=!1,s.unsubscribe(x))});this.viewPoint.moveTo({orientation:f,duration:500})}else this.control.target.sub(g),this.control.target.add(m),this.control.orientation.copy(f),h=this.control.update(),i&&!h&&(this.viewer.render({updateInfinitePlane:!0}),widget.fpsStats&&widget.stats.update())},_getKeyboardEvent:function(e){if(e.gesture&&e.gesture.currentEvent&&e.gesture.currentEvent.length>0){var t=e.gesture.currentEvent[0];if(t.event)return t.event}return null},_validElement:function(e){if(e&&["arrowup","up","arrowdown","down","arrowright","right","arrowleft","left"].find(t=>t===e.toLowerCase())&&document.activeElement&&(document.activeElement.closest("[swx-feature-id]")||document.activeElement.closest(".swx-modebar")||document.activeElement!==document.querySelector(".wux-applicationframe-execution-context")&&!document.activeElement.querySelector(".wux-applicationframe-execution-context")))return!1;var t=document.activeElement.tagName?document.activeElement.tagName.toLowerCase():document.activeElement.tagName;return-1===["input","textarea"].indexOf(t)},keyDown:function(e,t){if(t||(this._keyPressed=!0),!this._keyPressed)return;var i=null,r=45,n={x:0,y:0},s=this._getKeyboardEvent(e);if(s&&s.key&&this._validElement(s.key)){var l=new a.Vector2(this.control.domElement.clientWidth/2,this.control.domElement.clientHeight/2);switch(s.key.toLowerCase()){case"t":case"â ":s.altKey&&(s.preventDefault(),this.isAnimating||(this.viewPoint.getProjectionType()===o.ORTHOGRAPHIC?this.viewPoint.setProjectionType(o.PERSPECTIVE):this.viewPoint.setProjectionType(o.ORTHOGRAPHIC),this.options.logClientEvent&&this.options.logClientEvent("menuEvent",1===this.viewPoint.getProjectionType()?"SWXWebParallel":"SWXWebPerspective","sKey")));break;case"z":this.isCtrlPressed(s)||s.metaKey||(s.preventDefault(),this.isAnimating||(this.setControllerMouseWheelState(),this.control._zoomSimple(l,s.shiftKey)));break;case"alt":delete this._zoomFactor;break;case"escape":case"esc":if(this.endRotation(null),this.isEscapable)return void this.endMouseManipulation(e);break;case"arrowup":case"up":i={y:-1,x:0};break;case"arrowdown":case"down":i={y:1,x:0};break;case"arrowleft":case"left":i={y:0,x:-1};break;case"arrowright":case"right":i={y:0,x:1};break;default:this.rotationOriginVisuHelper.rmbRotationOn&&this.rightMouseUp(e),this.rotationOriginVisuHelper.mmbRotationOn&&this.middleMouseUp(e)}if(i){if(s.preventDefault(),this.isAnimating)return;s.altKey?(s.shiftKey&&(r*=6),0!==i.x?i.x*=-r:i.x=r,i.y=0,this.doRotate(i,n,!0,s.shiftKey)):s.shiftKey?(i.x*=6*r,i.y*=6*r,this.doRotate(i,n,!1,!0)):this.isCtrlPressed(s)||s.metaKey?this.control._doPan(140*i.x,140*i.y):this.isRotating?this.control._doPan(140*i.x,140*i.y):(i.x*=r,i.y*=r,this.doRotate(i,n,!1))}}let c=t?100:600;setTimeout(function(){return this.keyDown(e,!0)}.bind(this),c)},keyUp:function(e){this._keyPressed=!1;var t=this._getKeyboardEvent(e);if(t&&t.key&&this._validElement())switch(t.key.toLowerCase()){case"shift":this.isZooming&&(this.isRotating=!1,this.isPanning=!1,this.isZooming=!1,this.restoreOriginalCursor(),this.isShiftPinchTriggered=!1)}},getRollAxisFromSelection:function(e){if(this.options.getRollAxisFromSelection)return this.options.getRollAxisFromSelection(e)},setupRotationHelpers:function(){this.rotationOriginVisuHelper={origin:null,originVisu:null,boundaryPreview:null,highlightInfo:null,color:null,lastPSOItem:null,centerPt:null,pinchpanrotateTimer:null,wheeling:null,rotationCursor:!1,mmbRotationOn:!1,rmbRotationOn:!1},e.Utils.Client.Platform.ios||e.Utils.Client.Platform.android||e.Utils.Client.Platform.ipad?(this.control.onRotate(e=>{e&&e.gesture&&"Swipe"===e.gesture.name&&(e.defaultBehavior=!1)}),this.addVisuEvent(this.viewer.canvas,"onPinchPanRotate",e=>{e&&"end"==e.state&&(this.rotationOriginVisuHelper.pinchpanrotateTimer&&(clearTimeout(this.rotationOriginVisuHelper.pinchpanrotateTimer),this.rotationOriginVisuHelper.pinchpanrotateTimer=null),this.rotationOriginVisuHelper.pinchpanrotateTimer=setTimeout(()=>{clearTimeout(this.rotationOriginVisuHelper.pinchpanrotateTimer),this.rotationOriginVisuHelper.pinchpanrotateTimer=null},750))}),this.addVisuEvent(this.viewer.canvas,"onSwipe",e=>{if(this.control.getManipulationState()!==n.State.STOP&&this.control.getManipulationState()!==n.State.HOLD){if(this.control.lockRotation||this.control.lockTouchRotation||this.rotationOriginVisuHelper.pinchpanrotateTimer)return this.endRotation(e),this.rotationOriginVisuHelper.origin=null,void(this.rotationOriginVisuHelper.highlightInfo=null);if(e&&e.from&&e.from.length&&e.from[0]&&e.from[0].view===this.viewer.canvas){let t=e.from[0];t&&("begin"===e.state?this.prepareForRotation(e):"end"==e.state?(this.endRotation(e),this.viewer.currentViewpoint&&(this.rotationOriginVisuHelper.viewpointInfo={target:this.viewer.currentViewpoint.getTarget().clone(),targetDistance:this.viewer.currentViewpoint.getTargetDistance(),upDir:this.viewer.currentViewpoint.getUpDirection().clone(),sightDir:this.viewer.currentViewpoint.getSightDirection().clone()})):(this.isRotating=!0,this.isPanning=!1,this.isZooming=!1,this.setCursor("Rotate"),this.doRotate(t.currentPosition,t.lastPosition,e.altKey)))}}else this.endRotation(e)})):h.onAdd(e=>{e&&e.pathElement&&("Tree"===e.pathElement.src?this.rotationOriginVisuHelper.lastPSOItem=null:this.rotationOriginVisuHelper.lastPSOItem=e)})},prepareForRotation:function(t){if(t&&(t.from&&t.from.length&&t.from[0]||t.currentPosition)){let s=this.getTempGraphicsNode(),o=!0;if(this.rotationOriginVisuHelper&&this.rotationOriginVisuHelper.origin&&this.rotationOriginVisuHelper.viewpointInfo&&this.viewer&&this.viewer.currentViewpoint){let e=1e-5,t=!0,i=this.viewer.currentViewpoint.getTargetDistance();Math.abs(i-this.rotationOriginVisuHelper.viewpointInfo.targetDistance)<e&&(t=!1);let r=!1,n=this.viewer.currentViewpoint.getTarget(),a=this.viewer.currentViewpoint.getUpDirection(),s=this.viewer.currentViewpoint.getSightDirection();n&&a&&s&&this.rotationOriginVisuHelper.viewpointInfo.target&&this.rotationOriginVisuHelper.viewpointInfo.upDir&&this.rotationOriginVisuHelper.viewpointInfo.sightDir&&n.distanceTo(this.rotationOriginVisuHelper.viewpointInfo.target)>e&&a.distanceTo(this.rotationOriginVisuHelper.viewpointInfo.upDir)<e&&s.distanceTo(this.rotationOriginVisuHelper.viewpointInfo.sightDir)<e&&(r=!0),t||r||(o=!1)}let l=this.viewer.getSceneGraphOverrideSetManager(),h=!!(l&&this.rotationOriginVisuHelper.highlightInfo&&this.rotationOriginVisuHelper.highlightInfo.pathElement)&&l.getCurrentVisibility(this.rotationOriginVisuHelper.highlightInfo.pathElement),u=this.options.isSmallViewport&&this.options.isSmallViewport()&&v.getTouchMode();if(!1===h||o||!u){this.rotationOriginVisuHelper.highlightInfo&&(c.remove(this.rotationOriginVisuHelper.highlightInfo),this.unregisterColor(this.rotationOriginVisuHelper.color),this.viewer.render()),this.rotationOriginVisuHelper.origin=null,this.rotationOriginVisuHelper.highlightInfo=null;var i=t.currentPosition?t.currentPosition:t.from[0].getCurrentPosition(this.viewer.canvas),r=this.viewer.getMousePosition(i),n=this.getModelBoundingBox();if(n&&!n.isNaN())if(s){let e=Number(this.options.RelGeomDetectionTol||.035),t=Number(this.options.MaxGeomDetectionTol||50),i=Math.max(window.screen.width,window.screen.height)*e>t?t:Math.max(window.screen.width,window.screen.height)*e,s=this.getSelectedEntityInfo(r,i);if(s&&s.point&&s.object){let e=s.point.clone();this.rotationOriginVisuHelper.origin=e.clone();let t=this.getEntityPathElt(s);if(this.rotationOriginVisuHelper.highlightInfo=null,t){let e=Number(this.options.RotationEntityColor||13501183);this.rotationOriginVisuHelper.color=this.generateSelectionColor(new a.Color(e)),this.registerColor(this.viewer,this.rotationOriginVisuHelper.color,{attachToHSO:!0,persistable:!0}),this.rotationOriginVisuHelper.highlightInfo={pathElement:t,event:null,parameters:{highlightColor:this.rotationOriginVisuHelper.color}}}}else this.rotateCenterOfModel.copy(n.center())}else this.rotateCenterOfModel.copy(n.center());else this.rotateCenterOfModel.set(0,0,0)}if(this.rotationOriginVisuHelper.origin&&s){this.rotationOriginVisuHelper.centerPt=this.rotateCenterOfModel.clone(),this.rotateCenterOfModel.copy(this.rotationOriginVisuHelper.origin.clone());let i=(new a.Matrix4).getInverse(this.getActiveOccurrencePosition(t).clone()),r=!!(e.Utils.Client.Platform.ios||e.Utils.Client.Platform.android||e.Utils.Client.Platform.ipad),n=!1;s&&this.rotationOriginVisuHelper.boundaryPreview&&(s.remove(this.rotationOriginVisuHelper.boundaryPreview),this.rotationOriginVisuHelper.boundaryPreview=null,n=!0),s&&this.rotationOriginVisuHelper.originVisu&&(s.remove(this.rotationOriginVisuHelper.originVisu),this.rotationOriginVisuHelper.originVisu=null,n=!0),n&&this.viewer.render(),this.rotationOriginVisuHelper.originVisu=this.createRotationOriginBlob(this.rotationOriginVisuHelper.origin.clone().applyMatrix4(i),3.2,r,t),this.rotationOriginVisuHelper.originVisu&&s.add(this.rotationOriginVisuHelper.originVisu),this.rotationOriginVisuHelper.highlightInfo&&this.createBoundaryPreview(i,t),this.options.highlightFace&&c.add(this.rotationOriginVisuHelper.highlightInfo),this.viewer.render()}}},createBoundaryPreview:function(e,t){if(!this.options.getMaterial||!this.options.getBoudaryCurves||!this.options.highlightFace)return;let i=this.getTempGraphicsNode(),r=this.options.getBoudaryCurves(this.rotationOriginVisuHelper.highlightInfo.pathElement);if(i&&Array.isArray(r)&&r.length>0){var n=this.options.getMaterial(c,this.rotationOriginVisuHelper.highlightInfo);let s=new m("boundaryPreview"),o=new a.Matrix4,h=this.rotationOriginVisuHelper.highlightInfo.pathElement;h&&h.getWorldMatrix&&h.getWorldMatrix(this.viewer)&&(o=o.multiplyMatrices(e,h.getWorldMatrix(this.viewer).clone())),r.forEach(e=>{let t=e.map(e=>e.applyMatrix4(o));!0===e.closed&&e.length>0&&t.push(t[0]);let i=null;if(2==t.length&&t[0].distanceTo(t[1])<1.25){var r=.5*a.getDevicePixelRatio(),c=d.createRectangleNode({width:r,height:r,cornerPoint:new a.Vector2(-.5*r,-.5*r),fill:!1,fillColor:n.color,material:n});c&&(c.setNoZ(!0),(i=d.createFixedSizeNode())&&(i.addChild(c),i.applyMatrix((new a.Matrix4).makeTranslation(t[0].x,t[0].y,t[0].z))))}else(i=d.createLineNode({points:t,color:n.color,material:n})).setNoZ(!0);i&&(i.setPickable(l.PICKTHROUGH),s.addChild(i))}),s.applyMatrix(this.getActiveOccurrencePosition(t)),i.addChild(s),this.rotationOriginVisuHelper.boundaryPreview=s,this.rotationOriginVisuHelper.highlightInfo.pathElement=new u([this.rotationOriginVisuHelper.boundaryPreview])}},endRotation:function(t){let i=this.getTempGraphicsNode();if(this.viewer&&this.rotationOriginVisuHelper){i&&this.rotationOriginVisuHelper.originVisu&&i.remove(this.rotationOriginVisuHelper.originVisu),i&&this.rotationOriginVisuHelper.boundaryPreview&&i.remove(this.rotationOriginVisuHelper.boundaryPreview),this.rotationOriginVisuHelper.highlightInfo&&(this.options.highlightFace&&c.remove(this.rotationOriginVisuHelper.highlightInfo),this.unregisterColor(this.rotationOriginVisuHelper.color)),this.viewer.render(),this.rotationOriginVisuHelper.centerPt&&this.rotateCenterOfModel.copy(this.rotationOriginVisuHelper.centerPt),!!!(e.Utils.Client.Platform.ios||e.Utils.Client.Platform.android||e.Utils.Client.Platform.ipad)&&this.viewer.currentViewpoint&&(this.rotationOriginVisuHelper.viewpointInfo={target:this.viewer.currentViewpoint.getTarget().clone(),targetDistance:this.viewer.currentViewpoint.getTargetDistance(),upDir:this.viewer.currentViewpoint.getUpDirection().clone(),sightDir:this.viewer.currentViewpoint.getSightDirection().clone()}),this.rotationOriginVisuHelper.originVisu=null,this.rotationOriginVisuHelper.boundaryPreview=null,this.rotationOriginVisuHelper.centerPt=null,this.rotationOriginVisuHelper.pinchpanrotateTimer=null,this.rotationOriginVisuHelper.wheeling=null,this.rotationOriginVisuHelper.rotationCursor=!1,this.rotationOriginVisuHelper.mmbRotationOn=!1,this.rotationOriginVisuHelper.rmbRotationOn=!1}},doMouseToRay:function(e){var t=a.getDevicePixelRatio()||1,i=new a.Vector2(e.xPix/t,e.yPix/t),r=i.x/this.viewer.canvas.offsetWidth*2-1,n=-i.y/this.viewer.canvas.offsetHeight*2+1,s=new a.Projector,o=new a.Vector3(r,n,-1);s.unprojectVector(o,this.viewer.currentViewpoint.camera);var l=new a.Vector3(r,n,1);s.unprojectVector(l,this.viewer.currentViewpoint.camera);var c=(new a.Vector3).copy(l).sub(o);return c.normalize(),{origin:o,direction:c,dc:{xPix:e.xPix,yPix:e.yPix}}},getSelectedEntityInfo:function(e,t){let i=null;if(this.viewer&&e){let r=this.doMouseToRay(e);if(r){let e=this.viewer?this.viewer.getSceneGraphOverrideSetManager():null,n=new a.Ray(r.origin,r.direction),s=new a.Projector,o=new a.Vector3(n.origin.x,n.origin.y,n.origin.z);s.projectVector(o,this.viewer.currentViewpoint.camera);let c=!0,h=!0,u=!0,d=[];if(this.rotationOriginVisuHelper.lastPSOItem&&this.rotationOriginVisuHelper.lastPSOItem.pathElement&&Array.isArray(this.rotationOriginVisuHelper.lastPSOItem.pathElement.externalPath)&&(null==e||e&&e.getCurrentVisibility(this.rotationOriginVisuHelper.lastPSOItem.pathElement))){let e=this.rotationOriginVisuHelper.lastPSOItem.pathElement.externalPath.find(e=>!!e.mesh3js);if(e&&e.mesh3js){let t=this.GetSceneGraphType(this.rotationOriginVisuHelper.lastPSOItem.pathElement);if("Edge"===t){let e=this.rotationOriginVisuHelper.lastPSOItem.pathElement.getLastElement();if(e){let i=e.sgNode;i&&i instanceof l.SGPrimitiveHelper&&i.container&&1===i.container.getPrimitiveCount(i.index)&&(t="Point")}}d=n.intersectMeshInstances({object:e.mesh3js},this.viewer.currentViewpoint.camera,o,"Face"===t,"Edge"===t,"Point"===t,this.viewer.renderer.deviceWidth,this.viewer.renderer.deviceHeight,5)}}if((0===d.length||d.length>0&&!d[0].point)&&(d=[],this.viewer.internalSceneGraph&&this.viewer.internalSceneGraph.scene)){let e=[this.viewer.internalSceneGraph.scene],i=function(e,t){let i=!0;return e&&t&&(i=t===e.infPlane||t===e.infPlaneSmall||t===e.grid),i},r={objects:[],notPickable:[],init:function(e,t,r){if(e){let t=e.getWebGLObjects("main",0);Array.isArray(t)&&t.length>0&&(this.objects=t.filter(e=>e&&e.object&&!1===e.object.pickable&&e.object.visible&&!i(this.viewer,e.object)))}if(t){let e=[],i=[t],r=i.length;for(let t=0;t<r;++t)i[t]&&i[t].mesh3js&&i[t].mesh3js.visible&&e.push(i[t].mesh3js),Array.isArray(i[t].children)&&i[t].children.length>0&&(r=(i=i.concat(i[t].children)).length);e.length>0&&(this.objects=this.objects.concat(e.map(e=>({object:e}))))}this.objects.forEach(e=>{e&&e.object&&!1===e.object.pickable&&(e.object.pickable=!0,this.notPickable.push(e.object))})},getWebGLObjects:function(e,t){return"main"===e?this.objects:[]},restorePickability:function(){this.notPickable.forEach(e=>{e.pickable=!1})}};r.init(this.viewer.internalSceneGraph.scene,this.getTempGraphicsNode(),this.viewer),e.push(r),e.forEach(e=>{let r=n.intersectMeshInstances({object:e},this.viewer.currentViewpoint.camera,o,c,h,u,this.viewer.renderer.deviceWidth,this.viewer.renderer.deviceHeight,t);Array.isArray(r)&&r.length>0&&r[0].point&&(d=d.concat(r.filter(e=>e&&e.object&&!i(this.viewer,e.object))))}),r.restorePickability()}if(Array.isArray(d)&&d.length>0&&d[0].point){let t=-1,r=(Number.MAX_VALUE,Number.MAX_VALUE,1e-6),a=[];for(let e=0;e<d.length;++e)d[e].object&&d[e].primitive&&d[e].point&&a.push({distToRay:n.distanceToPoint(d[e].point),distToCamera:n.origin.distanceTo(d[e].point),entIdx:e});a.sort((e,t)=>Math.abs(e.distToRay-t.distToRay)<r?Math.abs(e.distToCamera-t.distToCamera)<r?0:e.distToCamera<t.distToCamera?-1:1:e.distToRay<t.distToRay?-1:1);let s=a.find(t=>{let i=d[t.entIdx],r=!1,n=this.getEntityPathElt(i);if(null===n)r=!0;else if(n&&n.externalPath&&n.externalPath.length>0&&!(r=void 0!==n.externalPath.find(e=>{let t="rulerMainNode"===e.name||"Active Sketch"===e.name&&!1===i.object.pickable;if(!1===t&&!0===e.fixedSize){var r=n.getLastElement();r.getGeometricType&&"INFINITE_FACE"===r.getGeometricType()&&i&&i.primitive&&i.primitive.container&&i.primitive.container.glType<2&&(t=!0)}return t}))&&e){let t=e.computeInheritedOpacity(n),i=e.computeInheritedVisibility(n);(null!=t&&t<.01||null!=i&&!1===i)&&(r=!0)}return!r});void 0!==s&&(t=s.entIdx),-1!=t&&(this.adjustSelectedEntityInfo(n,d[t]),i=d[t])}}}return i},adjustSelectedEntityInfo(e,t){if(t&&t.object&&t.point&&t.primitive&&t.primitive instanceof l.SGPrimitiveHelper&&(0===t.primitive.container.glType||1===t.primitive.container.glType)){let r=t.point,n=t.primitive,s=n.container.getPrimitiveStart(n.index),o=n.container.getPrimitiveCount(n.index),l=[],c=t.object.matrixWorld.clone();if(n.container&&n.container.geometry&&n.container.geometry.vertexIndexArray)for(let e=s;e<s+o;++e){var i=new a.Vector3;n.container.geometry.getVertexPosition(n.container.geometry.vertexIndexArray[e],i),l.push(i.applyMatrix4(c))}if(l.length>0)if(1==l.length)r.distanceTo(l[0])>.001&&(t.point=l[0]);else{let i=!0;if(r.distanceTo(l[0])>.001)for(let e=0;e<l.length-1;++e){let t=l[e],n=l[e+1];if(!(r.distanceTo(n)>.001)){i=!1;break}{let e=n.clone().sub(t).normalize(),a=r.clone().sub(t).dot(e),s=t.clone().add(e.clone().multiplyScalar(a));if(s.distanceTo(r)<.001){if(s.clone().sub(t).normalize().dot(e)>0&&t.distanceTo(s)<t.distanceTo(n)){i=!1;break}}}}else i=!1;if(i){let i=l[0],r=e.distanceToPoint(i);for(let t=1;t<l.length;++t){let n=e.distanceToPoint(l[t]);if(n<r&&(i=l[t],(r=n)<.001))break}t.point=i}}}},createRotationOriginBlob:function(e,t,i,r){let n=null;if(this.viewer&&this.viewer.currentViewpoint&&this.viewer.currentViewpoint.camera&&e&&this.options.highlightFace){let i=new m("rotationBlob"),h=new m("rotationBlobBroder");var s=new a.ImageUtils._loadTextureVisu("Robot","models/textures/Point.png",void 0,null,null,a.ImageUtils.crossOriginPolicy),o=new a.ImageUtils._loadTextureVisu("SWXCoreManipulation","icons/Point.png",void 0,null,null,a.ImageUtils.crossOriginPolicy);s.flipY=!1,s.minFilter=a.LinearMipMapLinearFilter,i.pointMat=new a.MeshBasicMaterial({map:s,side:a.DoubleSide,transparent:!0,alphaTest:.05,enableClipPlanes:!1,opacity:.7}),i.pointMat.force=!0,o.flipY=!1,o.minFilter=a.LinearMipMapLinearFilter,h.pointMat=new a.MeshBasicMaterial({map:o,side:a.DoubleSide,transparent:!0,alphaTest:.05,enableClipPlanes:!1}),h.pointMat.force=!0;var l=(new f).createRectangle({width:4,height:4,fill:!0,fillColor:null,noEdge:!0});let u=d.createMeshNode(l,i.pointMat);u.setShadow(!1),u.setFrustumCulled(!1),u.name="diskNode",u.excludeFromCSO(!0),u.excludeFromHighlight(!0,!0),u.setMatrix((new a.Matrix4).setPosition(new a.Vector3(-2,-2,0)));let p=d.createMeshNode(l,h.pointMat);p.setShadow(!1),p.setFrustumCulled(!1),p.name="diskNodeBorder",p.excludeFromCSO(!0),p.excludeFromHighlight(!0,!0),p.setMatrix((new a.Matrix4).setPosition(new a.Vector3(-2,-2,0)));var c={position:e,name:"billBoard1",type:"Spherical"};i.billBoardNode=new g(c),h.billBoardNode=new g(c),i.billBoardNode.addChild(u),h.billBoardNode.addChild(p),i.addChild(i.billBoardNode),h.addChild(h.billBoardNode);let v=d.createFixedSizeNode();i&&h&&v&&(i.pickable=!1,i.excludeFromCSO(!0),i.excludeFromHighlight(!0,!1),i.applyMatrix((new a.Matrix4).makeScale(t,t,t)),h.pickable=!1,h.excludeFromCSO(!0),h.excludeFromHighlight(!0,!1),h.applyMatrix((new a.Matrix4).makeScale(t,t,t)),v.addChild(i),v.addChild(h),v.applyMatrix((new a.Matrix4).makeTranslation(e.x,e.y,e.z)),v.pickable=!1,v.excludeFromCSO(!0),v.excludeFromHighlight(!0,!1),v.setVisibilityInTree(!1),v.setRenderPasses(["robot"]),v.applyMatrix(this.getActiveOccurrencePosition(r)),n=v)}return n},getEntityPathElt:function(e){let t=null;if(e&&e.object&&e.primitive){var i=new u;i.setFromOccurrence(e.object._occurrence,p.getFromSGNode(e.primitive)),Array.isArray(i.externalPath)&&i.externalPath.length>0&&(t=i)}return t},getTempGraphicsNode:function(){return this.options.getTempGraphicsNode?this.options.getTempGraphicsNode():(this._tempGraphicsNode||(this._tempGraphicsNode=new m,this._tempGraphicsNode.name="TempGraphicsFallback",this._tempGraphicsNode.setVisibilityInTree(!1),this.options.viewer.getRootNode().addChild(this._tempGraphicsNode)),this._tempGraphicsNode)},getActiveOccurrencePosition:function(e){if(this.options.getActiveOccurrencePosition)return this.options.getActiveOccurrencePosition().clone();if(e&&e.from&&e.from.length>0){const r=e.from[0].getCurrentPosition(this.viewer.canvas);if(r){const e=this.viewer.getMousePosition(r);if(e){var t=this.viewer.pick(e,"mesh",!0);if(t&&t.path&&t.path.length>0){var i=t.path[0].getWorldMatrix();return i?i.clone():new a.Matrix4}}}}return new a.Matrix4},isCtrlPressed:function(e){return navigator.platform.toLowerCase().indexOf("mac")>-1&&e.metaKey||e.ctrlKey},GetSceneGraphType:function(e){if(this.options.GetSceneGraphType)return this.options.GetSceneGraphType(e)},generateSelectionColor:function(e,t){if(this.options.generateSelectionColor)return this.options.generateSelectionColor(e,t)},registerColor:function(e,t,i){this.options.registerColor&&this.options.registerColor(e,t,i)},unregisterColor:function(e,t){this.options.unregisterColor&&this.options.unregisterColor(e,t)},getModelBoundingBox:function(){return this.options.getModelBoundingBox?this.options.getModelBoundingBox():this.viewer.getSceneBoundingBox("visibleSpace")}});return e.namespace("DS/SWXCoreManipulation/SWXCoreViewManipulation",S)}),define("DS/VisuLoaders/SceneGraphConverter",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraph","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory"],function(e,t,i,r,n,a,s){"use strict";return e.extend({init:function(e,t){this.glContext=e,this.v6SceneGraph=new r,this.v6SceneGraph.name="convertedSceneGraph",this.nodes=[this.v6SceneGraph],this.convert(t)},getRootNode:function(){return this.v6SceneGraph},traverse:function(e,i){var r,n;for(i.call(this,e,this.nodes),r=0,n=e.children.length;r<n;r++)this.traverse(e.children[r],i);e instanceof t.Object3D&&!(e instanceof t.Mesh)&&this.nodes.pop()},convert:function(e){this.traverse(e,function(e,i){var n,o;e instanceof t.Mesh?(n=(new a).convertFromTHREEMesh(e),(o=s.createMeshNode(n,void 0,void 0,"mono")).setMatrix(e.matrix),i[i.length-1].addChild(o)):e instanceof t.Object3D?((o=new r(e.name)).setMatrix(e.matrix),e.children.length&&i[i.length-1].addChild(o),i.push(o)):console.log("SceneGraph converter : unsupported node "+e)})}})}),define("DS/Visualization/ModelLoader",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Visualization/SceneGraph","DS/VisuEvents/EventsManager","DS/Visualization/WorldOrientation","DS/Visualization/MaterialManager"],function(e,t,i,r,n,a,s){"use strict";var o=e.extend({init:function(e,i){return this._viewer=null,this.fileType="xmlv43",this.geometryMode="3dxmlgeometry",this.smartLoading=!1,this.filterNavReps=!1,this.modelName="",this._internalTarget=null,this.Ox4MQLV6Loader=null,this.cgrLoader=null,this.uvrLoader=null,this.xmlv43Loader=null,this.xmlv6Loader=null,this.xmlv6SmartLoader=null,this.colladaLoader=null,this.jsonLoader=null,this.objLoader=null,this.xcadLoader=null,this.particlesLoader=null,this.streamVisuLoader=null,this.threeDXLoader=null,this.multipartMode=!1,this.CGRNewInfra=!0,this.keepLoaderMode=!1,this.expandMode=!1,this.readDecoration=!1,this.primitiveWithBS=!1,this.forceGPUCurvedPipes=localStorage.getItem("curvedPipesInstancing")?"true"===localStorage.getItem("curvedPipesInstancing"):null,this.repWithBS=!1,this.withSAG=!1,this.useDefaultTCSet=!1,this.accuracyInfo={sag2D:0,sag3D:0},this.withBagUUID=!1,this.useUvrWorker=!0,this.withSceneGraph=!1,this.withBlanking=!1,this.sceneGraphOrderMode=0,this.smartStaticBatching=!0,this.edgeTransparency=!0,this.sharedBuffers=!0,this.noMeshInRAM=!1,this.processText=!1,this.accelStruct=!1,this.materialManager=null,this.targetNode=null,this.glContext=e,this.renderer=null,this.renderCB=null,this.onLoadedCB=function(){n.RecordEventsManager&&n.RecordEventsManager.sendSynchroPoint("ModelLoaded"),window.webVisuPerfo.endPerfo("load"),t.loadingModels=!1},this.onLoadedPrdCB=null,this.onProgressCB=null,this.onErrorCB=null,this.refreshTime=2e3,this.debugBBox=void 0!==i&&i,this.poolOfModels={xmlv43:{loading:!1,models:[]},xmlv6:{loading:!1,models:[]},Ox4MQLV6:{loading:!1,models:[]},OxMQLV5:{loading:!1,models:[]},cgr:{loading:!1,models:[]},streamvisu:{loading:!1,models:[]},"3dx":{loading:!1,models:[]}},this._Ox4ProxyAbstraction=null,this},setSceneGraph:function(e){this.targetNode=e},setSceneGraphOrderMode:function(e){this.sceneGraphOrderMode=e},getSceneGraphOrderMode:function(){return this.sceneGraphOrderMode},setViewer:function(e){this._viewer=e},setTargetNode:function(e){this.targetNode=e},setWebGLContext:function(e){this.glContext=e},getCGROptions:function(){return{readDeco:this.readDecoration,optimizeCurvedPipes:this.forceGPUCurvedPipes,primWithBS:this.getPrimitivesWithBoundingSphere(),repWithBS:this.getRepsWithBoundingSphere(),edgeTransparency:this.getEdgeTransparency(),cgrWithSG:this.getCGRWithSG(),sharedBuffers:this.getSharedBuffers(),noMeshInRAM:this.getNoMeshInRAM(),smartStaticBatching:this.smartStaticBatching,sceneGraphOrderMode:this.getSceneGraphOrderMode(),withSAG:this.withSAG,withBagUUID:this.withBagUUID,sagInfo:this.accuracyInfo,withSceneGraph:this.getCGRWithSG(),withBlanking:this.getCGRWithBlanking(),uvrWorker:this.useUvrWorker,cgrMultipartMode:this.getMultipartMode(),cgrExpandMode:this.getExpandMode(),processText:this.processText}},setRenderCallback:function(e,t){this.renderCB=e,this.refreshTime=t||2e3},setOnLoadedCallback:function(e){var i=this;this.onLoadedCB=function(r){if(window.webVisuPerfo.endPerfo("load"),n.RecordEventsManager&&n.RecordEventsManager.sendSynchroPoint("ModelLoaded"),t.loadingModels=!1,i._internalTarget){var a=new Set,s=new Set;i._internalTarget._compactHierarchy(a,s)}i._internalTarget=null,e&&e.call(this,r)}},setOnLoadedProductStructureCallback:function(e){this.onLoadedPrdCB=e},setOnProgressCallback:function(e){this.onProgressCB=e},setOnErrorCallback:function(e){this.onErrorCB=e},activateSmartLoading:function(e){null!==e&&(this.renderer=e,this.smartLoading=!0)},deactivateSmartLoading:function(){this.smartLoading=!1},setFilterNavReps:function(e){this.filterNavReps=e},getFileType:function(){return this.fileType},setFileType:function(e){this.fileType=e},getGeometryMode:function(){return this.geometryMode},setGeometryMode:function(e){this.geometryMode=e,null!==this.xmlv6Loader&&this.xmlv6Loader.setGeometryMode(e)},getMultipartMode:function(){return this.multipartMode},setMultipartMode:function(e){this.multipartMode=e},getCGRNewInfra:function(){return this.CGRNewInfra},setKeepLoaderMode:function(e){this.cgrLoader&&this.cgrLoader.setKeepLoaderMode(e),this.keepLoaderMode=e},getKeepLoaderMode:function(){return this.keepLoaderMode},setCGRNewInfra:function(e){this.CGRNewInfra=e},setPrimitivesWithBoundingSphere:function(e){t._BinaryPrimitives||!e?this.primitiveWithBS=!!e:console.warn("Primitives must be in binary form for primitive bounding spheres")},getPrimitivesWithBoundingSphere:function(){return this.primitiveWithBS&&t._BinaryPrimitives},setRepsWithBoundingSphere:function(e){this.repWithBS=!!e},getRepsWithBoundingSphere:function(){return this.repWithBS},getCGRWithSG:function(){return this.withSceneGraph},getCGRWithBlanking:function(){return this.withBlanking},setCGRWithBlanking:function(e){this.withBlanking=e},setCGRWithSG:function(e){this.withSceneGraph=e},getCGRWithUUID:function(){return this.withBagUUID},set3DAccuracy:function(e){this.accuracyInfo.sag3D=e},setCGRWithUUID:function(e){this.withBagUUID=e},getOptimizeCurvedPipes:function(){return this.forceGPUCurvedPipes},setOptimizeCurvedPipes:function(e){this.forceGPUCurvedPipes=e},set2DAccuracy:function(e){this.accuracyInfo.sag2D=e},getEdgeTransparency:function(){return this.edgeTransparency},setEdgeTransparency:function(e){this.edgeTransparency=e},getSharedBuffers:function(){return this.sharedBuffers},setSharedBuffers:function(e){this.sharedBuffers=e},getNoMeshInRAM:function(){return this.noMeshInRAM},setNoMeshInRAM:function(e){this.noMeshInRAM=e},getExpandMode:function(){return this.expandMode},setExpandMode:function(e){this.expandMode=e},setAccelerationStructure:function(e){this.accelStruct=e},enableLDH:function(e,t,i,r,n,a){var s=this;require(["DS/SelectiveLoading/SelectiveLoadingAsync"],function(o){s.LDH=o,s.LDH.Helpers._enableLDH(s,e,t,i,n,a),void 0!==s.LDHAsyncDestruction?s.destructLDH():r&&r()},function(e){var t=e.requireModules&&e.requireModules[0];console.error("Module "+t+" is missing."),s.onErrorCB&&s.onErrorCB()})},getLDHInterface:function(){return this._ldhInterface},destructLDH:function(){void 0===this.LDH?this.LDHAsyncDestruction=!0:(this.LDH.Helpers._ldhCleanup(this),delete this.LDHAsyncDestruction,delete this.LDH)},_onModuleError:function(e,t){return function(i){var r=i.requireModules&&i.requireModules[0];console.log("Module "+r+" is missing."),e&&e({url:t,type:"FORMAT"})}},_xmlv43LoaderCB:function(e){var t=this;this.xmlv43Loader.load(e.jsonSettings,function(i,r){t._viewer&&(1===r?t._viewer.setWorldOrientation(a.YUpXRight):t._viewer.setWorldOrientation(a.ZUpYRight)),e.destination.addChild(i),null!==e.loadedProductCB&&e.loadedProductCB(i),null!==e.renderCB&&e.renderCB({needReframe:!1}),e.destination=null},e.loadedProductCB,e.progressCB,e.loadedCB,e.errorCB,e.filterNavReps,e.refreshTime,e.readDecoration,e.cgrNewInfra,e.primitiveWithBS,e.edgeTransparency,e.cgrWithSG,e.cgrWithBlanking,e.sharedBuffers,e.noMeshInRAM,e.smartStaticBatching,e.cgrWithSAG,e.accuracyInfo,e.uvrWorker,e.applicativeContainers,e.processText,e.cgrWithBagUUID,e.repWithBS,e.optimizeCurvedPipes)},_xmlv6LoaderCB:function(e){this.xmlv6Loader.load(e.modelName,function(t){e.destination.addChild(t),null!==e.loadedProductCB&&e.loadedProductCB(t),null!==e.renderCB&&e.renderCB({needReframe:!0}),e.destination=null},e.progressCB,e.loadedCB)},_Ox4MQLV6LoaderCB:function(e){this.Ox4MQLV6Loader.load(e.jsonSettings,function(t){e.destination.addChild(t),null!==e.loadedProductCB&&e.loadedProductCB(t),null!==e.renderCB&&e.renderCB({needReframe:!1}),e.destination=null},e.progressCB,e.loadedCB,e.errorCB,{edgeTransparency:e.edgeTransparency})},_OxMQLV5LoaderCB:function(e){this.OxMQLV5Loader.load(e.jsonSettings,function(t){e.destination.addChild(t),null!==e.loadedProductCB&&e.loadedProductCB(t),null!==e.renderCB&&e.renderCB({needReframe:!1})},e.progressCB,e.loadedCB,e.errorCB,{edgeTransparency:e.edgeTransparency})},_cgrLoaderCB:function(e){var t={isBuffer:e.isBuffer,destination:e.destination,isMultipartMode:e.cgrMultipartMode,isExpandMode:e.cgrExpandMode,isCGRNewInfra:e.cgrNewInfra,readDeco:e.readDecoration,optimizeCurvedPipes:e.optimizeCurvedPipes,primWithBS:e.primitiveWithBS,repWithBS:e.repWithBS,smartStaticBatching:e.smartStaticBatching,sceneGraphOrderMode:e.sceneGraphOrderMode,withSAG:e.cgrWithSAG,withSAG:e.cgrWithSAG,useDefaultTCSet:e.useDefaultTCSet,withBagUUID:e.cgrWithBagUUID,sagInfo:e.accuracyInfo,edgeTransparency:e.edgeTransparency,sharedBuffers:e.sharedBuffers,noMeshInRAM:e.noMeshInRAM,withSceneGraph:e.cgrWithSG,cgrWithBlanking:e.cgrWithBlanking,applicativeContainers:e.applicativeContainers,processText:e.processText,accelStruct:e.accelStruct},i={readyCallback:function(t){null!==e.loadedProductCB&&e.loadedProductCB(t)},doneCallback:e.loadedCB,errorCallback:e.errorCB,progressCallback:e.progressCB};this.cgrLoader.load(e.jsonSettings,i,t),e.destination=null},_streamVisuLoaderCB:function(e){this.streamVisuLoader.load(e.modelName,function(t){null!==e.loadedProductCB&&e.loadedProductCB(t)},null,e.loadedCB,e.destination)},_threeDXLoaderCB:function(e){this.threeDXLoader.setMode("3dxc"===e.fileType?"concat":"zipped"),this.threeDXLoader.setSharedBuffers(e.sharedBuffers),this.threeDXLoader.setNoMeshInRAM(e.noMeshInRAM);var t=!0,i=!1,r=!1,n=this.accelStruct,a=e.jsonSettings&&e.jsonSettings.loaderSettings;a&&(t=a.primitives,i=a.reps,r=a.ssb,n=a.accelerationStructure),this.threeDXLoader.load({url:e.modelName,primitives:t,reps:i,ssb:r,accelStruct:n,lightMapAsIrradiance:a&&a.lightMapAsIrradiance,destinationNode:e.destination,readyCallback:function(t){null!==e.loadedProductCB&&e.loadedProductCB(t)},doneCallback:e.loadedCB,errorCallback:e.errorCB,gasSharing:!(!a||!a.gasSharing)})},_buildFileInfos:function(e){var t=this.buildPath(e);return this.modelName=t.serverurl?t.serverurl:"",this.modelName+=t.filename?t.filename:"",this.setFileTypeFromSpec(t),t},loadModelFromBuffer:function(e,t,i){return this.loadModel(e,t,!0,i)},loadModel:function(e,r,n,a){if(window.webVisuPerfo.startPerfo("load",-1),t.loadingModels=!0,void 0!==this.LDH&&void 0!==e.localAABox)return this.LDH.Helpers._onLoadModel(this,e,r,n);var s=this,o=null,l=void 0!==r?r:s.targetNode;if(null===l)return!1;(n=void 0!==n&&n)||(o=this._buildFileInfos(e)),this._internalTarget=l;var c={modelName:this.modelName,fileType:this.fileType,jsonSettings:o,destination:l,isBuffer:n,geometryMode:this.geometryMode,renderCB:this.renderCB,loadedProductCB:this.onLoadedPrdCB,progressCB:this.onProgressCB,loadedCB:this.onLoadedCB,errorCB:this.onErrorCB,filterNavReps:this.filterNavReps,refreshTime:this.refreshTime,readDecoration:this.readDecoration,cgrNewInfra:this.getCGRNewInfra(),optimizeCurvedPipes:this.forceGPUCurvedPipes,primitiveWithBS:this.getPrimitivesWithBoundingSphere(),repWithBS:this.getRepsWithBoundingSphere(),edgeTransparency:this.getEdgeTransparency(),cgrWithSG:this.getCGRWithSG(),withBlanking:this.getCGRWithBlanking(),useDefaultTCSet:this.useDefaultTCSet,sharedBuffers:this.getSharedBuffers(),noMeshInRAM:this.getNoMeshInRAM(),smartStaticBatching:this.smartStaticBatching,sceneGraphOrderMode:this.getSceneGraphOrderMode(),cgrWithSAG:this.withSAG,cgrWithBagUUID:this.withBagUUID,accuracyInfo:this.accuracyInfo,uvrWorker:this.useUvrWorker,cgrMultipartMode:this.getMultipartMode(),cgrExpandMode:this.getExpandMode(),waitMaterial:this.waitMaterial,processText:this.processText,accelStruct:this.accelStruct};if("xmlv43"===this.fileType){if(n)return!1;if(a&&a.applicativeContainers&&(c.applicativeContainers=a.applicativeContainers),this.xmlv43Loader)this._xmlv43LoaderCB(c);else if(this.poolOfModels.xmlv43.models.push(c),!this.poolOfModels.xmlv43.loading){this.poolOfModels.xmlv43.loading=!0;var h=["DS/VisuLoaders/XMLV43Loader"];require(h,function(e){s.poolOfModels.xmlv43.loading=!1,s.xmlv43Loader=new e(s.glContext,s.renderCB);for(var t=s.poolOfModels.xmlv43.models,i=0;i<t.length;i++)s._xmlv43LoaderCB(t[i]);s.poolOfModels.xmlv43.models=[]},this._onModuleError(c.errorCB,c.modelName))}}else if("xmlv6"===this.fileType){if(n)return!1;this.xmlv6Loader?this._xmlv6LoaderCB(c):(this.poolOfModels.xmlv6.models.push(c),this.poolOfModels.xmlv6.loading||(this.poolOfModels.xmlv6.loading=!0,require(["DS/VisuLoaders/XMLV6Loader","DS/VisuLoaders/XMLV6SmartLoaderPassPlugin"],function(e,t){s.poolOfModels.xmlv6.loading=!1,s.xmlv6Loader=new e(s.glContext,s.renderCB,s.debugBBox,s.geometryMode),s.smartLoading&&null===s.xmlv6SmartLoader?(s.xmlv6SmartLoader=new t(s.xmlv6Loader),s.xmlv6SmartLoader.enabled=!0,s.xmlv6SmartLoader.renderTarget=null,s.renderer.addPrePlugin(s.xmlv6SmartLoader)):s.smartLoading||null===s.xmlv6SmartLoader?null!==s.xmlv6SmartLoader&&(s.xmlv6SmartLoader.enabled=!0):s.xmlv6SmartLoader.enabled=!1;for(var i=s.poolOfModels.xmlv6.models,r=0;r<i.length;r++)s._xmlv6LoaderCB(i[r]);s.poolOfModels.xmlv6.models=[]},this._onModuleError(c.errorCB,c.modelName))))}else if("Ox4MQLV6"==this.fileType)this.Ox4MQLV6Loader?(i.setProxyFromSpec(c.jsonSettings,this._Ox4ProxyAbstraction),this._Ox4MQLV6LoaderCB(c)):(this.poolOfModels.Ox4MQLV6.models.push(c),this.poolOfModels.Ox4MQLV6.loading||(this.poolOfModels.Ox4MQLV6.loading=!0,require(["DS/VisuDataAccess/Ox4MQLV6Loader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(e,t){s.poolOfModels.Ox4MQLV6.loading=!1,s._Ox4ProxyAbstraction=t,s.Ox4MQLV6Loader=new e(s.glContext,s.renderCB,s.debugBBox,s.geometryMode);for(var r=s.poolOfModels.Ox4MQLV6.models,n=0;n<r.length;n++)i.setProxyFromSpec(r[n].jsonSettings,t),s._Ox4MQLV6LoaderCB(r[n]);s.poolOfModels.Ox4MQLV6.models=[]},this._onModuleError(c.errorCB,c.modelName))));else if("svg"==this.fileType)require(["DS/SVGLoader/SVGLoader"],function(e){new e({renderCB:s.renderCB,onProgressCB:s.onProgressCB,onLoadedCB:s.onLoadedCB,onErrorCB:s.onErrorCB}).load(o,l)});else if("OxMQLV5"==this.fileType){if(this.OxMQLV5Loader)i.setProxyFromSpec(c.jsonSettings,s._Ox4ProxyAbstraction),this._OxMQLV5LoaderCB(c);else if(this.poolOfModels.OxMQLV5.models.push(c),!this.poolOfModels.OxMQLV5.loading){this.poolOfModels.OxMQLV5.loading=!0;h=["DS/EV53DPlay/OxMQLV5Loader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"];require(h,function(e,t){s.poolOfModels.OxMQLV5.loading=!1,s._Ox4ProxyAbstraction=t,s.OxMQLV5Loader=new e(s.glContext,s.renderCB);for(var r=s.poolOfModels.OxMQLV5.models,n=0;n<r.length;n++)i.setProxyFromSpec(r[n].jsonSettings,t),s._OxMQLV5LoaderCB(r[n]);s.poolOfModels.OxMQLV5.models=[]},this._onModuleError(c.errorCB,c.modelName))}}else if("cgr"===this.fileType||"uvr"===this.fileType)a&&a.applicativeContainers&&(c.applicativeContainers=a.applicativeContainers),this.cgrLoader?(n&&(c.jsonSettings=e),this._cgrLoaderCB(c)):(n&&(c.jsonSettings=e),this.poolOfModels.cgr.models.push(c),this.poolOfModels.cgr.loading||(this.poolOfModels.cgr.loading=!0,require(["DS/VisuLoaders/CGRReader"],function(e){s.poolOfModels.cgr.loading=!1,s.cgrLoader=new e(s.glContext,s.renderCB,{keepLoader:s.getKeepLoaderMode()});for(var t=s.poolOfModels.cgr.models,i=0;i<t.length;i++)s._cgrLoaderCB(t[i]);s.poolOfModels.cgr.models=[]},this._onModuleError(c.errorCB,c.modelName))));else if("dae"===this.fileType){if(n)return!1;require(["DS/VisuLoaders/DAEReader"],function(e){null===s.colladaLoader&&(s.colladaLoader=new e(s.glContext,s.renderCB)),s.waitMaterial&&s.colladaLoader.setWaitMaterial(s.waitMaterial),s.colladaLoader.loadFromSpec(o,function(e){l.addChild(e),null!==s.onLoadedPrdCB&&s.onLoadedPrdCB(e),null!==s.renderCB&&s.renderCB({needReframe:!1}),l=null},null,s.onLoadedCB)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),s.onErrorCB&&s.onErrorCB({url:s.modelName,type:"FORMAT"})})}else if("json"===this.fileType){if(n)return!1;require(["DS/VisuLoaders/JSONReader"],function(e){null===s.jsonLoader&&(s.jsonLoader=new e(s.glContext,s.renderCB)),s.jsonLoader.load(s.modelName,function(e){l.addChild(e),null!==s.onLoadedPrdCB&&s.onLoadedPrdCB(e),null!==s.renderCB&&s.renderCB({needReframe:!1}),l=null},null,s.onLoadedCB)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),s.onErrorCB&&s.onErrorCB({url:s.modelName,type:"FORMAT"})})}else if("obj"===this.fileType){if(n)return!1;require(["DS/VisuLoaders/OBJReader"],function(e){null===s.objLoader&&(s.objLoader=new e(s.glContext,s.renderCB,a)),s.objLoader.load(o,function(e){l.addChild(e),null!==s.onLoadedPrdCB&&s.onLoadedPrdCB(e),null!==s.renderCB&&s.renderCB({needReframe:!1}),l=null},null,s.onLoadedCB)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),s.onErrorCB&&s.onErrorCB({url:s.modelName,type:"FORMAT"})})}else if("streamvisu"===this.fileType){if(n)return!1;this.streamVisuLoader?this._streamVisuLoaderCB(c):(this.poolOfModels.streamvisu.models.push(c),this.poolOfModels.streamvisu.loading||(this.poolOfModels.streamvisu.loading=!0,require(["DS/VisuLoaders/StreamVisuLoader"],function(e){s.poolOfModels.streamvisu.loading=!1,s.streamVisuLoader=new e(s.renderCB);for(var t=s.poolOfModels.streamvisu.models,i=0;i<t.length;i++)s._streamVisuLoaderCB(t[i]);s.poolOfModels.streamvisu.models=[]},this._onModuleError(c.errorCB,c.modelName))))}else if("3dx"===this.fileType||"3dxc"===this.fileType||"3dxm"===this.fileType){if(n)return!1;this.threeDXLoader?this._threeDXLoaderCB(c):(this.poolOfModels["3dx"].models.push(c),this.poolOfModels["3dx"].loading||(this.poolOfModels["3dx"].loading=!0,require(["DS/VisuLoaders/ThreeDXLoader"],function(e){s.poolOfModels["3dx"].loading=!1,s.threeDXLoader=new e;for(var t=s.poolOfModels["3dx"].models,i=0;i<t.length;i++)s._threeDXLoaderCB(t[i]);s.poolOfModels["3dx"].models=[]},this._onModuleError(c.errorCB,c.modelName))))}else if("stp"===this.fileType||"step"===this.fileType||"stl"===this.fileType){h=["DS/XCADLoader/XCADModelLoaderPlug"];require(h,function(t){for(var i=[new t],r=function(e){l.addChild(e),null!==s.onLoadedPrdCB&&s.onLoadedPrdCB(e),null!==s.renderCB&&s.renderCB({needReframe:!1})},a=0;a<i.length;a++)if(i[a].isManagedType(s.fileType)){var c=null;n&&(c=e),i[a].loadModel(s.fileType,s.glContext,s.renderCB,s.modelName,r,s.onProgressCB,s.onLoadedCB,s.onErrorCB,s.filterNavReps,s.refreshTime,l,o,c)}},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),s.onErrorCB&&s.onErrorCB({url:s.modelName,type:"FORMAT"})})}else"particles"===this.fileType?require(["DS/VisuLoaders/ParticlesLoader"],function(t){null===s.particlesLoader&&(s.particlesLoader=new t(s.sceneGraph,s.renderCB));var i=o;n&&(i=e),s.particlesLoader.load(i,function(e){l.add(e),null!==s.onLoadedPrdCB&&s.onLoadedPrdCB(e),null!==s.renderCB&&s.renderCB({needReframe:!1}),l=null},null,s.onLoadedCB)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),s.onErrorCB&&s.onErrorCB({url:s.modelName,type:"FORMAT"})}):require(["DS/ModelLoader_"+this.fileType.toLowerCase()+"/loader"],function(t){var i=new t,r=o;n&&(r=e),i.load(r,function(e){l.addChild(e),null!==s.onLoadedPrdCB&&s.onLoadedPrdCB(e),l=null},s.onProgressCB,s.onLoadedCB,s.onErrorCB,s.renderCB)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),s.onErrorCB&&s.onErrorCB({url:s.modelName,type:"FORMAT"})});return!0},addRessourceLibrary(e,t,i){this.materialManager||(this.materialManager=new s),i||this.clearRessourceLibrary();var r=this,n=this._buildFileInfos(e),a={modelName:this.modelName,fileType:this.fileType,jsonSettings:n,destination:null,isBuffer:!1,geometryMode:!1,renderCB:null,loadedProductCB:null,progressCB:null,loadedCB:function(e){for(var i=e.materials,n=0;n<i.length;n++)r.materialManager.setCGRSharedMaterial(n,i[n]);t&&t()},errorCB:this.onErrorCB};this.threeDXLoader?this._threeDXLoaderCB(a):(this.poolOfModels["3dx"].models.push(a),this.poolOfModels["3dx"].loading||(this.poolOfModels["3dx"].loading=!0,require(["DS/VisuLoaders/ThreeDXLoader"],function(e){r.poolOfModels["3dx"].loading=!1,r.threeDXLoader=new e;for(var t=r.poolOfModels["3dx"].models,i=0;i<t.length;i++)r._threeDXLoaderCB(t[i]);r.poolOfModels["3dx"].models=[]},this._onModuleError(a.errorCB,a.modelName))))},clearRessourceLibrary(){this.materialManager||(this.materialManager=new s),this.materialManager.CGRSharedMaterials.clear()},getLoader:function(e,t){var i=this;switch(e){case"3dx":require(["DS/VisuLoaders/ThreeDXLoader"],function(e){null===i.threeDXLoader&&(i.threeDXLoader=new e),t&&t(i.threeDXLoader)})}return this.threeDXLoader},setLineTypes:function(e){this.materialManager||(this.materialManager=new s),this.materialManager.setLineTypes(e)},clearLineTypes:function(){this.materialManager&&this.materialManager.clearLineTypes()},buildPath:function(e){if("string"==typeof e){var t="",r="";if("blob:"===e.substring(0,5))return{provider:"FILE",serverurl:"",filename:e,requiredAuth:null,proxyurl:"none"};if("http://"===e.substring(0,7))t=e;else if("https://"===e.substring(0,8))t=e;else if("/"===e.substring(0,1))t=e;else if("ms-appx://"===e.substring(0,10))t=e;else if("file://"===e.substring(0,7))t=e;else{var n=location.href,a=n.indexOf("?");-1!==a&&(n=n.substring(0,a));var s=n.lastIndexOf("/");-1!==s&&(n=n.substring(0,s+1)),t=n+e}r=(t=i.parseUrl(t)).protocol,""!==t.protocol&&(r+="://"),r+=t.authority+t.path.substring(0,t.path.lastIndexOf("/"))+"/";var o=t.path.substring(t.path.lastIndexOf("/")+1,t.path.length);return""!==t.query&&(o=o+"?"+t.query),e={provider:"FILE",serverurl:r,filename:o,requiredAuth:null,proxyurl:"none"}}return"EV6"===e.provider&&(t=i.parseUrl(e.serverurl),e.serverdefinition={},e.serverdefinition.protocol=t.protocol,e.serverdefinition.hostname=""!==t.user?t.user+"@"+t.domain:t.domain,e.serverdefinition.port=t.port,e.serverdefinition.rooturi=t.path,"/"===e.serverdefinition.rooturi.slice(0,1)&&(e.serverdefinition.rooturi=e.serverdefinition.rooturi.slice(1,e.serverdefinition.rooturi.length))),e},setFileTypeFromSpec:function(e){var t="";if("string"==typeof e)t=i.getExtension(e);else if(e.provider&&"FILE"!==e.provider)"EV6"===e.provider?this.fileType="Ox4MQLV6":"EV5"===e.provider?this.fileType="OxMQLV5":this.fileType=e.provider;else if(e.format&&""!==e.format)t=e.format;else{var r=e.serverurl?e.serverurl:"";r+=e.filename?e.filename:"",t=i.getExtension(r)}""!==t&&(t.toLowerCase&&(t=t.toLowerCase()),this.fileType="3dxml"===t?"xmlv43":t)},reloadUVR:function(e,t,r,n){var a=this;require(["DS/VisuUnstreamers/UnstreamTaskDriver","DS/VisuUnstreamers/FileInZipStreamObject","DS/Visualization/ProxyAbstraction"],function(s,o,l){var c=a.buildPath(e),h=new l;i.setProxyFromSpec(c,h);var u=c.serverurl?c.serverurl:"";u+=c.filename?c.filename:"";for(var d=[],p=0;p<t.length;p++)d.push(t[p].name);h.executeGetHttpRequest(u,"blob",null,function(e){for(var i=0;i<d.length;i++){var l=new o(e,d[i]);!function(e){s.getTask("CGR",l,t[e],function(i){var s=a.getCGROptions();n&&n.applicativeContainers&&(s.applicativeContainers=n.applicativeContainers),s.unlinkToSG=!0,s.destination=[];for(var o=0;o<t[e].parents.length;o++)s.destination.push(t[e].parents[o]);i.run(function(i){var r=i.nodes;if(t&&t[e]&&t[e].parents)for(var n=t[e].parents.length,a=0;a<n;a++){var s=t[e].parents[a];s.removeChildren();for(var o=0;o<r.length;o++)s.addChild(r[o])}},r?r.onLoadedCB:null,r?r.onErrorCB:null,s)})}(i)}},a.onErrorCB)})},setWaitMaterial:function(e){this.waitMaterial=e.clone()},abort:function(){null!==this.cgrLoader&&this.cgrLoader.abort(),null!==this.xmlv43Loader&&this.xmlv43Loader.abort()}});return UWA.namespace("THREEDS/ModelLoader",o)}),define("Visualization/ModelLoader",["DS/Visualization/ModelLoader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/ModelLoader"),e}),define("DS/Visualization/CGRNode",["UWA/Class","DS/Visualization/SceneGraphUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/PathElement"],function(e,t,i,r,n,a,s){"use strict";var o=function(e,t,i){var r,a=e.children?e.children.length:0,s=e._primitives?e.getPrimitivesCount():0;for(t(e,i),r=0;r<a;r++)o(e.children[r],t,i);if(s)for(r=0;r<s;r++){var l=new n.SGPrimitiveHelper;l.set(e,r),t(l,i)}},l=function(e,t,i){var r,a,s=e.children?e.children.length:0,o=e._primitives?e.getPrimitivesCount():0;if((a=t(e,i)).stop)a.stop=!1;else{for(r=0;r<s;r++)l(e.children[r],t,a);if(o){for(r=0;r<o;r++){var c=new n.SGPrimitiveHelper;c.set(e,r),a=t(c,a),i.index&&i.index--}return}}i.index&&i.index--},c=function(e,t,i){var r=t(e,i);if(!r&&e.type<=i.nodeType)for(var n=e.children,a=n?n.length:0,s=0;s<a;s++)r=c(n[s],t,i);return r},h=function(e,t){(e.getCgmId?e.getCgmId():e.cgmId)==t.cgmId&&t.results.nodes.push(e)},u=function(e,t){var i=!1,r=!0,a=e.getCgmId?e.getCgmId():e.cgmId;if(a==t.path[t.index]?(t.index==t.path.length-1&&t.results.nodes.push(e),r=!1):0==a&&(i=!0,r=!1),!r){var s=e.children;e._primitives&&(s=function(e){for(var t=[],i=0;i<e.getPrimitivesCount();i++){var r=new n.SGPrimitiveHelper;r.set(e,i),t.push(r)}return t}(e)),i||t.index++;for(var o=s?s.length:0,l=0;l<o;l++)u(s[l],t);i||t.index--}},d=r.extend({init:function(e,t){return this._parent(t),this.internalSceneGraph=e,this},setInternalSceneGraph:function(e){this.internalSceneGraph=e},setHighlight:function(e){var t=0,i=0,r=!1,n=this._getPrimitives(e);for(t in n){r=!0;var a=WUX.Selection.HSOManager,o=n[t].mesh._occurrence,l=new s,c=n[t].primitives;for(i=0;i<c.length;i++){(l=new s).setFromOccurrence(o,c[i]);var h={pathElement:l};h.pathElement.getLastElement(!0)._getExcludeFromHL()||a.add(h)}}return r},removeHighlight:function(e){var t=0,i=0,r=!1,n=this._getPrimitives(e);for(t in n){r=!0;var a=WUX.Selection.HSOManager,o=n[t].mesh._occurrence,l=n[t].primitives;for(i=0;i<l.length;i++){(u=new s).setFromOccurrence(o,l[i]);var c={pathElement:u},h=a.get();for(t=0;t<h.length;t++){var u,d=h[t];if(!(u=d.pathElement)&&d.options&&(u=d.options.pathElement),u&&u.isEqual(c.pathElement)){a.remove(d),!0;break}}}}return r},show:function(e){var t=0,i=!1,r=this._getPrimitives(e);for(t in r){i=!0;var n=r[t].mesh._occurrence.node,a=r[t].primitives;n.show(a)}return i},hide:function(e){var t=0,i=!1,r=this._getPrimitives(e);for(t in r){i=!0;var n=r[t].mesh._occurrence.node,a=r[t].primitives;n.hide(a)}return i},getHideShowPathElement:function(e,t,i){var r=this._getPathElements(e,t,i);return{visiblePath:r.pathElementsToShow,hiddenPath:r.pathElementsToHide}},getPathElement:function(e,t){var i=this._getPrimitivesNew4(e);return this.buildPathElementsFromNodes(i,t)},getPathElementsFromIDs:function(e,t,i,r,a){for(var s=new n.UUID,o=function(e,t){return s.setFromUint32(e.uuid_1,e.uuid_2,e.uuid_3,e.uuid_4),!!t.id.isEqual(s)&&(t.res.nodes.push(e),!0)},l=function(e,t){return t.id===e.cgmId&&(t.res.nodes.push(e),!0)},h=function(e,t){t.id===e.cgmId&&t.res.nodes.push(e)},u=function(e,t){for(var i=[],r=e.getPrimitivesCount(),a=0;a<r;a++)for(var s=0;s<t.length;s++)if(e.getPrimitiveCgmId(a)===t[s]){var o=new n.SGPrimitiveHelper;o.set(e,a),i.push(o);break}return i},d=[this.internalSceneGraph],p=[],f=0;f<t.length;f++){for(var m=[],g=0;g<d.length;g++){var v={nodes:[]};c(d[g],0===a?o:l,{id:t[f],nodeType:1,res:v}),v.nodes.length&&(m=m.concat(v.nodes))}if(!m.length)return null;d=m}if(0!==i&&null!=i){for(m=[],g=0;g<d.length;g++){v={nodes:[]};c(d[g],h,{id:i,nodeType:2,res:v}),v.nodes.length&&(m=m.concat(v.nodes))}if(!m.length)return null;if(d=m,null!=r)for(g=0;g<d.length;g++){v={nodes:[]};for(var S=u(d[g],r),_=0;_<S.length;_++)p.push(S[_])}}return this.buildPathElementsFromNodes(p.length>0?p:d,e)},getPathElementsFromUUIDs:function(e,t,i,r){return this.getPathElementsFromIDs(e,t,i,r,0)},getPathElementsFromDiezeEle:function(e,t,i,r){return this.getPathElementsFromIDs(e,t,i,r,1)},_getPrimitives:function(e){var t={};if(!(e instanceof Array))return t;var i=function(e,t){if(e.getType&&3===e.getType()){var i=new a(e),r=e.getGroup();if(r&&r.geometry){var n=r.geometry.meshList[0],s=n.id;t.res[s]?function(e,t){var i,r=e.length;for(i=0;i<r;i++)if(e[i].id==t)return!0;return!1}(t.res[s].primitives,i.id)||t.res[s].primitives.push(i):t.res[s]={mesh:n,primitives:[i]}}}return t},r=function(e,t){l(e,function(e,t){return e.cgmId==t.path[t.index]?(t.index++,t.path.length==t.index?(t.res.push(e),t.stop=!0,t):t):(t.stop=!0,t)},t)};return l(this.internalSceneGraph,function(e,t){e.children&&e.children.length;var n,a=t.idArray.length;for(n=0;n<a;n++)if(e.getCgmId&&e.getCgmId()==t.idArray[n][0]||!e.getCgmId&&e.cgmId==t.idArray[n][0]){var s=[];r(e,{path:t.idArray[n],index:0,res:s,stop:!1}),s.length&&l(s[0],i,t)}return t},{idArray:e,res:t,stop:!1}),t},_getPrimitiveWithMesh:function(e,t){var i=function(e,t){var i,r=e.length;for(i=0;i<r;i++)if(e[i].id==t)return!0;return!1};if(e)if(e.getType){var r=THREEDS.SubElement.getFromSGNode(e),n=e.getGroup();if(n&&n.geometry&&n.geometry.meshList.length>0){var a=n.geometry.meshList[0],s=a.id;t.res[s]?i(t.res[s].reps,r.id)||t.res[s].reps.push(r):t.res[s]={mesh:a,reps:[r]}}}else l(e,function(e,t){if(2==e.type&&(t.stop=!0,e.getPrimitivesCount())){var r=e.getPrimitiveGroup(0),n=THREEDS.SubElement.getFromSGNode(e);if(r&&r.geometry){var a=r.geometry.meshList[0],s=a.id;t.res[s]?i(t.res[s].reps,n.id)||t.res[s].reps.push(n):t.res[s]={mesh:a,reps:[n]}}}return t},t);return t.res},_buildPaths:function(e,t){var i=e,r=[];for(var n in i){for(var a=i[n].mesh._occurrence.node,o=[];a.id!==this.id&&a.parents&&a.parents[0];)o.unshift(a),a=a.parents[0];t&&t.externalPath&&(o=t.externalPath.concat(o));for(var l=i[n].reps,c=0;c<l.length;c++){var h=[l[c]];a=l[c];for("primitive"==l[c].getType()&&(a=THREEDS.SubElement.getFromSGNode(l[c].sgNode.getRep()),h.unshift(a));a&&a.sgNode&&a.sgNode.parents[0];){var u=THREEDS.SubElement.getFromSGNode(a.sgNode.parents[0]);h.unshift(u),a=u}var d=new s;d.setFromArray(o,h),r.push(d)}}return r},buildPathElementsFromNodes:function(e,t){for(var i=[],r=0;r<e.length;r++)this._getPrimitiveWithMesh(e[r],{stop:!1,res:i});return this._buildPaths(i,t)},_getPathElements:function(e,t,i){var r={pathElementsToHide:[],pathElementsToShow:[]};if(!(e instanceof Array))return r;if(!(t instanceof Array))return r;for(var n=[],a=[],s=this._getPrimitivesNew4(e),o=0;o<s.length;o++){(c=s[o]).getCgmId||1!=c.type||c.noShow||(c.noShow=!0,n.push(c))}r.pathElementsToHide=this.buildPathElementsFromNodes(s,i);var l=this._getPrimitivesNew4(t);for(o=0;o<l.length;o++){var c;(c=l[o]).getCgmId||1!=c.type||c.noShow&&(c.noShow=!1,a.push(c))}var h,u=[],d=[];for(o=0;o<l.length;o++)this._getPrimitiveWithMesh(l[o],{stop:!1,res:u});for(h in u)for(var p=u[h].reps,f=0;f<p.length;f++){var m=!0,g=p[f];for("primitive"==g.getType()&&(g=THREEDS.SubElement.getFromSGNode(g.sgNode.getRep()));g&&g.sgNode&&g.sgNode.parents[0];){if("rep"!=g.getType()&&g.sgNode.noShow){m=!1;break}g=THREEDS.SubElement.getFromSGNode(g.sgNode.parents[0])}m&&(d[h]?d[h].reps.push(p[f]):d[h]={mesh:u[h].mesh,reps:[p[f]]})}r.pathElementsToShow=this._buildPaths(d,i);for(o=0;o<n.length;o++)n[o].noShow=!1;for(o=0;o<a.length;o++)a[o].noShow=!0;return r},_getPrimitivesNew2:function(e){for(var t={nodes:[]},i=0;i<e.length;i++)o(this.internalSceneGraph,u,{index:0,results:t,path:e[i]});return t.nodes},getNodeFromIdPath:function(e,t,i,r){var a=i._primitives?i.getPrimitivesCount():0,s=i.getCgmId?i.getCgmId():i.cgmId;if(s>0){if(s!=e[t])return!1;if(++t===e.length)return r.push(i),!0}else if(0==s&&0==e[t]&&++t===e.length)return r.push(i),!0;var o=i.children;if(o)for(var l=0;l<o.length;++l)this.getNodeFromIdPath(e,t,o[l],r);else if(a)for(l=0;l<a;l++){var c=new n.SGPrimitiveHelper;if(c.set(i,l),c.getCgmId()===e[t])return r.push(c),!0}},_getPrimitivesNew4:function(e){for(var t=[],i=0;i<e.length;++i)this.getNodeFromIdPath(e[i],0,this.internalSceneGraph,t);return t},_getPrimitivesNew3:function(e){for(var t=[],i={nodes:[]},r=0;r<e.length;r++){var n=e[r],a=n.length;o(this.internalSceneGraph,h,{results:i,cgmId:n[a-1]});for(var s=0;s<i.nodes.length;s++)for(var l=i.nodes[s],c=0,u=l.getCgmId?l.getCgmId():l.cgmId;u==n[a-1-c]||0==u;){if(u==n[a-1-c]&&c++,c==a){t.push(i.nodes[s]);break}if(l.getType&&3==l.getType())l=l.getRep();else{if(!l.parents||!l.parents[0])break;l=l.parents[0]}u=l.getCgmId?l.getCgmId():l.cgmId}}return t},_buildSGBagNodes:function(){var e=this.internalSceneGraph;e&&1===e.type&&(this.internalSceneGraph=this._buildSGBag(e))},_buildSGBag:function(e){var t,i,r,a=new n.SGBag;for(a.copyNoChildren(e),t=0;t<e.children.length;t++)(r=1===(i=e.children[t]).type?this._buildSGBag(i):i).parents[0]=a,a.children.push(r);return a}});return UWA.namespace("THREEDS/Nodes/CGRNode",d)}),define("Visualization/CGRNode",["DS/Visualization/CGRNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/CGRNode"),e}),define("DS/Robot/ReferenceAxisSystemNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils"],function(e,t,i,r){"use strict";return t.extend({init:function(e,i){this._parent(e),this.viewer=i,this.setVisibilityFree(!0),this.fixedSizeNode=new t("AxisSystemDisplayFixedSizeNode"),this._createAxis(),this.addChild(this.fixedSizeNode),this.setPickable(r.PICKTHROUGH),this.wantedVisibility=!0,this._enabled=!0,this.eventToken=this.viewer._modelEvent.subscribe({event:"UpdateReferenceAxisSystemVisibility"},this.onUpdateVisibility.bind(this)),this._getPositionCB=null},setGetPositionCB:function(e){this._getPositionCB=e,this.onViewpointChange()},onViewpointChange:function(){var t=this.viewer.currentViewpoint;if(t){var i,r,n=this.viewer.devicePixelRatio,a=(i=this._getPositionCB?this._getPositionCB(this.viewer.canvas.width,this.viewer.canvas.height,n):this._getPosition_default(this.viewer.canvas.width,this.viewer.canvas.height,n)).y;r=function(i,r){var n,a=t.robotCameraOrtho,s=new e.Vector3(i,r,0);if((new e.Projector).unprojectVector(s,a),a instanceof e.PerspectiveCamera){var o=new e.Ray(data.cameraEye,s.sub(data.cameraEye).normalize()),l=new e.Plane(t.camera.getLookAt(),0);n=o.intersectPlane(l)}else n=s;return(new e.Matrix4).setPosition(n)}(i.x,a),this._changeMatrix(r,t.robotCameraOrtho)}},onUpdateVisibility:function(e){this.wantedVisibility=e.visible,this.applyVisibility()},setCameraName:function(e){this.fixedSizeNode._setFixedSizeCameraName(e)},applyVisibility:function(){this.setVisibility(this.wantedVisibility&&this._enabled)},_dispose:function(){this.viewer._modelEvent.unsubscribe(this.eventToken),this.eventToken=null},_setEnabled:function(e){this._enabled=e,this.applyVisibility()},_changeMatrix:function(t,i){this.setMatrix(t);var r=new e.Vector3,n=new e.Vector3,a=new e.Vector3,s=i.getLookAt();t.extractBasis(r,n,a);var o=new e.Vector3,l=.01;function c(e,t){o.crossVectors(e,s),o.lengthSq()<l*l?t.setVisibility(!1):t.setVisibility(!0)}var h=this._hasAxis();this._hasAxis()||(h=this._createAxis()),h&&(c(r,this.xAxis),c(n,this.yAxis),c(a,this.zAxis))},_hasAxis:function(){return!!(this.xAxis&&this.yAxis&&this.zAxis)},_createAxis:function(){var r=new e.MeshBasicMaterial({color:"black"}),n=5.5;function a(a,s){var o=i.createTextNode({text:s,hotspot:{x:.5,y:.5},font:"Trebuchet MS",color:new e.Color("black"),fontSize:4,bold:!1,_fix:!0});if(!o)return null;o.setFrustumCulled(!1);var l=new t,c=i.createLineNode({points:[new e.Vector3(0,0,0),new e.Vector3(n*a.x,n*a.y,n*a.z)],material:r});c.setFrustumCulled(!1),c.setShadow(!1),l.addChild(c);var h=new t;return h.addChild(o),h._setBillboardData(1,null,null),h._setFixedSizeCenter(new e.Vector3(1.2*n*a.x,1.2*n*a.y,1.2*n*a.z),4),l.addChild(h),l}return this.xAxis=a(new e.Vector3(1,0,0),"x"),this.yAxis=a(new e.Vector3(0,1,0),"y"),this.zAxis=a(new e.Vector3(0,0,1),"z"),this.xAxis&&this.yAxis&&this.zAxis?(this.fixedSizeNode.addChild(this.xAxis),this.fixedSizeNode.addChild(this.yAxis),this.fixedSizeNode.addChild(this.zAxis),this.fixedSizeNode._setRatio(4),!0):(this.xAxis=null,this.yAxis=null,this.zAxis=null,!1)},_getPosition_default:function(e,t,i){return{x:2*(this.viewer.canvas.width-34*i)/this.viewer.canvas.width-1,y:Math.max(2*i*70/this.viewer.canvas.height-1,-.85)}},CallBackEventHandlerViewPoint:function(){this.onViewpointChange.apply(this,arguments)}})}),define("DS/Robot/XYPlaneTranslationNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/WorldOrientation","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/PlaneTranslationManipulator","DS/CoreEvents/ModelEvents","DS/Mesh/MeshUtils","DS/Robot/RobotUtils"],function(e,t,i,r,n,a,s,o){"use strict";var l=t.extend({init:function(t){var r=this;this._parent(t.name),this.axis=t.constraintAxis,this._modelEvent=new a,this.isPreactivated=!1,this.isManipulated=!1,this.enablePreactivate=!0,this.touchMode=t.touchMode,this._worldOrientation=null,this.manipulator=null,this._manipulatorToken=null,this._updateRepresentation(i.ZUpYRight),this.manipulator=new n({axis:this.axis}),this.manipulator.setExclusive(!0),this._manipulatorToken=this.manipulator.linkToNode(this),this.manipulator.onPrimaryPointerClick(function(e){r._modelEvent.publish({event:"PrimaryPointerClick",data:{node:this},context:this})}),this.manipulator.onBeginManipulate(function(t){r._modelEvent.publish({event:"PlaneTranslationBegin",data:t,context:this}),r.planeMat.opacity=1,r.planeMat.color=new e.Color("#1B6E9C"),r.isManipulated=!0}),this.manipulator.onManipulate(function(e){r._modelEvent.publish({event:"PlaneTranslationManipulation",data:e,context:this})}),this.manipulator.onEndManipulate(function(t){r._modelEvent.publish({event:"PlaneTranslationEnd",data:t,context:this}),r.isPreactivated?r.planeMat.color=new e.Color("#A1D9ED"):r.planeMat.color=new e.Color("#FFFFFF"),r.isManipulated=!1,t.viewer.render()}),this.manipulator.onBeginPreactivate(function(t){r._modelEvent.publish({event:"BeginPreactivate",data:t,context:this}),!r.isManipulated&&r.enablePreactivate&&t.viewer.setTemporaryCursor("pointer"),r.isPreactivated=!0,!r.isManipulated&&r.enablePreactivate&&(r.planeMat.color=new e.Color("#A1D9ED")),t.viewer.render()}),this.manipulator.onEndPreactivate(function(t){r._modelEvent.publish({event:"EndPreactivate",data:t,context:this}),!r.isManipulated&&r.enablePreactivate&&t.viewer.unsetTemporaryCursor(),r.isPreactivated=!1,r.isManipulated||(r.planeMat.color=new e.Color("#FFFFFF")),t.viewer.render()})},_updateRepresentation:function(t){if(t!==this._worldOrientation){var r=this.manipulator;r&&(r.unlink(this._manipulatorToken),this._manipulatorToken=null),this.removeChildren(),o.disposeMaterial("planeMat",this),o.disposeMaterial("planeMatPicking",this);var n=t===i.ZUpYRight,a=o.createTranslationRectangle(!1,null,n);this.planeMat=a.material;var l,c=a.node;if(l=n?(new e.Matrix4).setPosition(new e.Vector3(-7.5,-7.5,0)):(new e.Matrix4).setPosition(new e.Vector3(.5,.5,0)),c.setMatrix(l),this.addChild(c),this.touchMode){c.setPickable(s.PICKTHROUGH);var h=o.createTranslationRectangle(!0,null,n),u=h.node;this.planeMatPicking=h.material,u.setMatrix(l),this.addChild(u)}r&&(this._manipulatorToken=r.linkToNode(this)),this._worldOrientation=t}},setAxis:function(e){this.axis=e,this.manipulator.axis=e},setParentManipulated:function(e){this.enablePreactivate=!e},setToGhostState:function(){this.planeMat.opacity=0},setToNonGhostState:function(){this.planeMat.opacity=1},setToDragState:function(){this.planeMat.opacity=.3},_setWorldOrientation:function(e){this._updateRepresentation(e)}});return UWA.namespace("THREEDS/Robot/XYPlaneTranslationNode",l)}),define("Robot/XYPlaneTranslationNode",["DS/Robot/XYPlaneTranslationNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Robot/XYPlaneTranslationNode"),e}),define("DS/Robot/XZRotationNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/WorldOrientation","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/RotationManipulator","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Robot/RobotUtils"],function(e,t,i,r,n,a,s,o,l){"use strict";var c=t.extend({init:function(t){var r=this;this._parent(t.name),this.axis=t.constraintAxis,this._modelEvent=new o,this.isPreactivated=!1,this.isManipulated=!1,this.enablePreactivate=!0,this.touchMode=t.touchMode,this._worldOrientation=null,this.manipulator=null,this._manipulatorToken=null,this._updateRepresentation(i.ZUpYRight),this.manipulator=new n({axis:this.axis}),this.manipulator.setExclusive(!0),this._manipulatorToken=this.manipulator.linkToNode(this),this.manipulator.onBeginManipulate(function(t){r._modelEvent.publish({event:"RotationBegin",data:t,context:this}),r.planeMat.opacity=1,r.planeMat.color=new e.Color("#1B6E9C"),r.isManipulated=!0}),this.manipulator.onManipulate(function(e){r._modelEvent.publish({event:"RotationManipulation",data:e,context:this})}),this.manipulator.onEndManipulate(function(t){r._modelEvent.publish({event:"RotationEnd",data:t,context:this}),r.isPreactivated?r.planeMat.color=new e.Color("#A1D9ED"):r.planeMat.color=new e.Color("#FFFFFF"),r.isManipulated=!1}),this.manipulator.onBeginPreactivate(function(t){r._modelEvent.publish({event:"BeginPreactivate",data:t,context:this}),!r.isManipulated&&r.enablePreactivate&&t.viewer.setTemporaryCursor("pointer"),r.isPreactivated=!0,!r.isManipulated&&r.enablePreactivate&&(r.planeMat.color=new e.Color("#A1D9ED")),t.viewer.render()}),this.manipulator.onEndPreactivate(function(t){r._modelEvent.publish({event:"EndPreactivate",data:t,context:this}),!r.isManipulated&&r.enablePreactivate&&t.viewer.unsetTemporaryCursor(),r.isPreactivated=!1,r.isManipulated||(r.planeMat.color=new e.Color("#FFFFFF")),t.viewer.render()}),this.manipulator.onPrimaryPointerClick(function(e){r._modelEvent.publish({event:"PrimaryPointerClick",data:e,context:this})})},_updateRepresentation:function(t){if(t!==this._worldOrientation){var r=this.manipulator;r&&(r.unlink(this._manipulatorToken),this._manipulatorToken=null),this.removeChildren(),l.disposeMaterial("planeMat",this),l.disposeMaterial("planeMat_picking",this);var n=t===i.ZUpYRight,s=l.createRotationRectangle(!1,null,!n);this.planeMat=s.material;var o,c=s.node;if(o=n?(new e.Matrix4).rotateX(.5*Math.PI):(new e.Matrix4).rotateX(.5*Math.PI).translate(new e.Vector3(-8.5,-8.5,0)),c.setMatrix(o),this.addChild(c),this.touchMode){c.setPickable(a.PICKTHROUGH);var h=l.createRotationRectangle(!0,null,!n);this.planeMat_picking=h.material;var u=h.node;u.setMatrix(o),this.addChild(u)}r&&(this._manipulatorToken=r.linkToNode(this)),this._worldOrientation=t}},setCenter:function(e){this.manipulator.setCenter(e)},setAxis:function(e){this.axis=e,this.manipulator.axis=e},setParentManipulated:function(e){this.enablePreactivate=!e},setToGhostState:function(){this.planeMat.opacity=0},setToNonGhostState:function(){this.planeMat.opacity=1},_setWorldOrientation:function(e){this._updateRepresentation(e)}});return UWA.namespace("THREEDS/Robot/XZRotationNode",c)}),define("Robot/XZRotationNode",["DS/Robot/XZRotationNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Robot/XZRotationNode"),e}),define("DS/Robot/YZPlaneTranslationNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/PlaneTranslationManipulator","DS/CoreEvents/ModelEvents","DS/Mesh/MeshUtils","DS/Robot/RobotUtils"],function(e,t,i,r,n,a,s){"use strict";var o=t.extend({init:function(t){var i=this;this._parent(t.name),this._modelEvent=new n,this.axis=t.constraintAxis,this.isPreactivated=!1,this.isManipulated=!1,this.enablePreactivate=!0,this.touchMode=t.touchMode,this._worldOrientation=t.worldOrientation;var o=s.createSmallTranslationRectangle(!1,null);this.planeMat=o.material;var l=o.node;if(this.yzPlaneNode=l,this.updatePlaneNodeMatrix(),this.addChild(l),this.touchMode){l.setPickable(a.PICKTHROUGH);var c=s.createSmallTranslationRectangle(!0,null),h=c.node;this.planeMat_picking=c.material,h.setMatrix((new e.Matrix4).rotateY(-.5*Math.PI).translate(new e.Vector3(.5,.5,0))),this.addChild(h)}this.manipulator=new r({axis:this.axis}),this.manipulator.setExclusive(!0),this.manipulator.linkToNode(this),this.manipulator.onPrimaryPointerClick(function(e){i._modelEvent.publish({event:"PrimaryPointerClick",data:{node:this},context:this})}),this.manipulator.onBeginManipulate(function(t){i._modelEvent.publish({event:"PlaneTranslationBegin",data:t,context:this}),i.planeMat.opacity=1,i.planeMat.color=new e.Color("#1B6E9C"),i.isManipulated=!0}),this.manipulator.onManipulate(function(e){i._modelEvent.publish({event:"PlaneTranslationManipulation",data:e,context:this})}),this.manipulator.onEndManipulate(function(t){i._modelEvent.publish({event:"PlaneTranslationEnd",data:t,context:this}),i.isPreactivated?i.planeMat.color=new e.Color("#A1D9ED"):i.planeMat.color=new e.Color("#FFFFFF"),i.isManipulated=!1}),this.manipulator.onBeginPreactivate(function(t){i._modelEvent.publish({event:"BeginPreactivate",data:t,context:this}),!i.isManipulated&&i.enablePreactivate&&t.viewer.setTemporaryCursor("pointer"),i.isPreactivated=!0,!i.isManipulated&&i.enablePreactivate&&(i.planeMat.color=new e.Color("#A1D9ED")),t.viewer.render()}),this.manipulator.onEndPreactivate(function(t){i._modelEvent.publish({event:"EndPreactivate",data:t,context:this}),!i.isManipulated&&i.enablePreactivate&&t.viewer.unsetTemporaryCursor(),i.isPreactivated=!1,i.isManipulated||(i.planeMat.color=new e.Color("#FFFFFF")),t.viewer.render()})},setCenter:function(e){this.manipulator.setCenter(e)},setAxis:function(e){this.axis=e,this.manipulator.axis=e},setParentManipulated:function(e){this.enablePreactivate=!e},setToGhostState:function(){this.planeMat.opacity=0},setToNonGhostState:function(){this.planeMat.opacity=1},updatePlaneNodeMatrix:function(){this.yzPlaneNode.setMatrix((new e.Matrix4).rotateY(-.5*Math.PI).translate(new e.Vector3(.5,.5,0)))},_setWorldOrientation:function(e){}});return UWA.namespace("THREEDS/Robot/YZPlaneTranslationNode",o)}),define("Robot/YZPlaneTranslationNode",["DS/Robot/YZPlaneTranslationNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Robot/YZPlaneTranslationNode"),e}),define("DS/Robot/ScalingNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/ScalingManipulator","DS/Mesh/MeshUtils","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory"],function(e,t,i,r,n,a,s,o,l){"use strict";var c=t.extend({init:function(t){var i=this;this._parent(t.name),this.axis=t.constraintAxis,this._modelEvent=new o,this.isPreactivated=!1,this.isManipulated=!1,this.enablePreactivate=!0;var s=(new r).createRectangle({width:2,height:2,fill:!0,fillColor:null,noEdge:!0}),c=new e.ImageUtils._loadTextureVisu("Robot","models/textures/Point.png",void 0,null,null,e.ImageUtils.crossOriginPolicy);c.flipY=!1,c.minFilter=e.LinearMipMapLinearFilter,this.pointMat=new e.MeshBasicMaterial({map:c,side:e.DoubleSide,transparent:!0,alphaTest:.05,enableClipPlanes:!1}),this.pointMat.force=!0;var h=l.createMeshNode(s,this.pointMat);h.setShadow(!1),h.setFrustumCulled(!1),h.name="diskNode",h.excludeFromCSO(!0),h.excludeFromHighlight(!0,!0),h.setMatrix((new e.Matrix4).setPosition(new e.Vector3(-1,-1,0)));var u={position:this.position,name:"billBoard1",type:"Spherical"};this.billBoardNode=new n(u),this.billBoardNode.addChild(h),this.addChild(this.billBoardNode),this.name="handleNode",this.manipulator=new a({axis:this.axis}),this.manipulator.setExclusive(!0),this.manipulator.linkToNode(this),this.manipulator.onBeginManipulate(function(t){i._modelEvent.publish({event:"ScalingBegin",data:t,context:this}),i.pointMat.opacity=1,i.pointMat.color=new e.Color("#1B6E9C"),i.isManipulated=!0}),this.manipulator.onManipulate(function(e){i._modelEvent.publish({event:"ScalingManipulation",data:e,context:this})}),this.manipulator.onEndManipulate(function(t){i._modelEvent.publish({event:"ScalingEnd",data:t,context:this}),i.isPreactivated?i.pointMat.color=new e.Color("#A1D9ED"):i.pointMat.color=new e.Color("#FFFFFF"),i.isManipulated=!1}),this.manipulator.onBeginPreactivate(function(t){i._modelEvent.publish({event:"BeginPreactivate",data:t,context:this}),!i.isManipulated&&i.enablePreactivate&&t.viewer.setTemporaryCursor("pointer"),i.isPreactivated=!0,!i.isManipulated&&i.enablePreactivate&&(i.pointMat.color=new e.Color("#A1D9ED")),t.viewer.render()}),this.manipulator.onEndPreactivate(function(t){i._modelEvent.publish({event:"EndPreactivate",data:t,context:this}),!i.isManipulated&&i.enablePreactivate&&t.viewer.unsetTemporaryCursor(),i.isPreactivated=!1,i.isManipulated||(i.pointMat.color=new e.Color("#FFFFFF")),t.viewer.render()}),this.manipulator.onPrimaryPointerClick(function(e){i._modelEvent.publish({event:"PrimaryPointerClick",data:e,context:this})})},setCenter:function(e){this.manipulator.setCenter(e)},setAxis:function(e){var t=e&&e.clone();t&&t.normalize(),this.axis=t,this.manipulator.axis=t},setParentManipulated:function(e){this.enablePreactivate=!e},setToGhostState:function(){this.pointMat.opacity=0},setToNonGhostState:function(){this.pointMat.opacity=1}});return UWA.namespace("THREEDS/Robot/ScalingNode",c)}),define("Robot/ScalingNode",["DS/Robot/ScalingNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Robot/ScalingNode"),e}),define("DS/Robot/RobotHandle",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/ScreenPlaneManipulator","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory"],function(e,t,i,r,n,a,s,o,l,c){"use strict";var h=t.extend({init:function(t){this._parent(t.name),this.position=t.position,this._modelEvent=new l,this.isPreactivated=!1,this.isManipulated=!1,this.enablePreactivate=!0,this.touchMode=t.touchMode;var i=this,o=(new r).createRectangle({width:4,height:4,fill:!0,fillColor:null,noEdge:!0}),h=new e.ImageUtils._loadTextureVisu("Robot","models/textures/Point.png",void 0,null,null,e.ImageUtils.crossOriginPolicy);h.flipY=!1,h.minFilter=e.LinearMipMapLinearFilter,this.pointMat=new e.MeshBasicMaterial({map:h,side:e.DoubleSide,transparent:!0,alphaTest:.05,enableClipPlanes:!1}),this.pointMat.force=!0;var u=c.createMeshNode(o,this.pointMat);if(u.setShadow(!1),u.setFrustumCulled(!1),u.name="diskNode",u.excludeFromCSO(!0),u.excludeFromHighlight(!0,!0),u.setMatrix((new e.Matrix4).setPosition(new e.Vector3(-2,-2,0))),this.touchMode){u.setPickable(s.PICKTHROUGH);var d=new e.MeshBasicMaterial({transparent:!0,opacity:0,enableClipPlanes:!1,color:new e.Color("red"),force:!0}),p=c.createSphereNode({radius:3,material:d});p.setShadow(!1),p.setFrustumCulled(!1),p.name="sphereNode",p.excludeFromCSO(!0),p.excludeFromHighlight(!0,!0),this.addChild(p)}var f={position:this.position,name:"billBoard1",type:"Spherical"};this.billBoardNode=new n(f),this.billBoardNode.addChild(u),this.addChild(this.billBoardNode),this.screenPlaneManipulator=new a({cameraName:t.cameraName}),this.screenPlaneManipulator.setExclusive(!0),this.screenPlaneManipulator.linkToNode(this),this.screenPlaneManipulator.onBeginManipulate(function(t){i._modelEvent.publish({event:"ScreenPlaneTranslationBegin",data:t,context:this}),i.pointMat.color=new e.Color("#1B6E9C"),i.pointMat.opacity=1,i.isManipulated=!0}),this.screenPlaneManipulator.onManipulate(function(e){i._modelEvent.publish({event:"ScreenPlaneTranslationManipulation",data:e,context:this})}),this.screenPlaneManipulator.onEndManipulate(function(t){i._modelEvent.publish({event:"ScreenPlaneTranslationEnd",data:t,context:this}),i.isPreactivated?i.pointMat.color=new e.Color("#A1D9ED"):i.pointMat.color=new e.Color("#FFFFFF"),i.isManipulated=!1}),this.screenPlaneManipulator.onBeginPreactivate(function(t){i._modelEvent.publish({event:"BeginPreactivate",data:t,context:this}),!i.isManipulated&&i.enablePreactivate&&t.viewer.setTemporaryCursor("pointer"),i.isPreactivated=!0,!i.isManipulated&&i.enablePreactivate&&(i.pointMat.color=new e.Color("#A1D9ED")),t.viewer.render()}),this.screenPlaneManipulator.onEndPreactivate(function(t){i._modelEvent.publish({event:"EndPreactivate",data:t,context:this}),!i.isManipulated&&i.enablePreactivate&&t.viewer.unsetTemporaryCursor(),i.isPreactivated=!1,i.isManipulated||(i.pointMat.color=new e.Color("#FFFFFF")),t.viewer.render()})},setParentManipulated:function(e){this.enablePreactivate=!e},setToGhostState:function(){this.pointMat.opacity=0},setToNonGhostState:function(){this.pointMat.opacity=1},setCameraName:function(e){this.screenPlaneManipulator.setCameraName(e)}});return UWA.namespace("THREEDS/Robot/RobotHandle",h)}),define("Robot/RobotHandle",["DS/Robot/RobotHandle","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Robot/RobotHandle"),e}),define("DS/Robot/LineTranslationNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/LineTranslationManipulator","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory"],function(e,t,i,r,n,a,s,o,l,c){"use strict";var h=t.extend({init:function(t){var i=this;this._parent(t.name),this.axis=new e.Vector3(0,0,1),this.position=t.position,this._modelEvent=new l,this.isPreactivated=!1,this.isManipulated=!1,this.enablePreactivate=!0,this.touchMode=t.touchMode,this.labelText=null,this.labelBillBoardNode=null,this.labelDistance=11.5,this.labelColor=null,this.colors=t.colors||{rest:new e.Color("#FFFFFF"),manipulate:new e.Color("#1B6E9C"),preactivate:new e.Color("#A1D9ED")};var o=new r,h=o.createRectangle({width:2,height:9,fill:!0,fillColor:null,noEdge:!0}),u=(o.createRectangle({width:2,height:9.5,fill:!0,fillColor:null,noEdge:!0}),new e.ImageUtils._loadTextureVisu("Robot","models/textures/AS_Arrow.png",void 0,null,null,e.ImageUtils.crossOriginPolicy));u.flipY=!1,this.mat=new e.MeshBasicMaterial({map:u,side:e.DoubleSide,transparent:!0,alphaTest:.05,enableClipPlanes:!1,color:this.colors.rest}),this.mat.force=!0;var d=c.createMeshNode(h,this.mat);if(d.setShadow(!1),d.setFrustumCulled(!1),d.excludeFromCSO(!0),d.excludeFromHighlight(!0,!0),this.touchMode){d.setPickable(s.PICKTHROUGH);var p=new e.MeshBasicMaterial({map:u,transparent:!0,opacity:0,enableClipPlanes:!1,force:!0}),f={bottomCenterPoint:new e.Vector3(0,0,0),topCenterPoint:new e.Vector3(0,0,7),radius:1,sag:60,material:p},m=c.createCylinderNode(f);m.excludeFromCSO(!0),m.excludeFromHighlight(!0,!0),m.setShadow(!1),m.setFrustumCulled(!1),this.addChild(m)}d.setMatrix((new e.Matrix4).rotateX(.5*Math.PI).translate(new e.Vector3(-1,-1,0)));var g={position:this.position,name:"billBoardNode",type:"Cylindrical"};this.billBoardNode=new n(g),this.billBoardNode.addChild(d);var v=new e.Matrix4;v.setPosition((new e.Vector3).getPositionFromMatrix(this.getMatrix())),this.setMatrix(v),this.addChild(this.billBoardNode),this.manipulator=new a({axis:this.axis}),this.manipulator.setExclusive(!0),this.manipulator.linkToNode(this),this.manipulator.onPrimaryPointerClick(function(e){i._modelEvent.publish({event:"PrimaryPointerClick",data:e,context:this})}),this.manipulator.onBeginManipulate(function(e){i._modelEvent.publish({event:"LineTranslationBegin",data:e,context:this}),i.mat.opacity=1,i.mat.color=i.colors.manipulate,i.isManipulated=!0}),this.manipulator.onManipulate(function(e){i._modelEvent.publish({event:"LineTranslationManipulation",data:e,context:this})}),this.manipulator.onEndManipulate(function(e){i._modelEvent.publish({event:"LineTranslationEnd",data:e,context:this}),i.isPreactivated?e.viewer.setTemporaryCursor("pointer"):i.mat.color=i.colors.rest,i.isManipulated=!1}),this.manipulator.onBeginPreactivate(function(e){i._modelEvent.publish({event:"BeginPreactivate",data:{preactivated:e.preactivated,node:d},context:this}),i.isPreactivated=!0,!i.isManipulated&&i.enablePreactivate&&(i.mat.color=i.colors.preactivate),!i.isManipulated&&i.enablePreactivate&&e.viewer.setTemporaryCursor("pointer"),e.viewer.render()}),this.manipulator.onEndPreactivate(function(e){i._modelEvent.publish({event:"EndPreactivate",data:{preactivated:e.preactivated,node:d},context:this}),i.isPreactivated=!1,i.isManipulated||(i.mat.color=i.colors.rest),!i.isManipulated&&i.enablePreactivate&&e.viewer.unsetTemporaryCursor(),e.viewer.render()})},setLabel:function(t,i){if(i=i||"grey",(t!==this.labelText||this.labelColor!=i)&&(this.labelColor=i,this.labelText=t,this.labelBillBoardNode&&(this.removeChild(this.labelBillBoardNode),this.labelBillBoardNode=null),t)){var r=c.createTextNode({text:t,font:"Trebuchet MS",fontSize:2,color:new e.Color(i),hotspot:{x:.5,y:.5},zoom:1.3,_fix:!0});r?(this.labelBillBoardNode=new n({name:"labelBillBoardNode",type:"Spherical"}),this._updateLabelPosition(),r.setFrustumCulled(!1),this.labelBillBoardNode.addChild(r),this.labelBillBoardNode.setPickable(s.PICKTHROUGH),this.addChild(this.labelBillBoardNode)):(this.labelColor=null,this.labelText=null)}},setAxis:function(e){this.manipulator.axis=e},_updateLabelPosition:function(t){if(t&&(this.labelDistance=t),this.labelBillBoardNode){var i=new e.Vector3(0,0,this.labelDistance),r=new e.Matrix4;r.setPosition(i),this.labelBillBoardNode.setMatrix(r)}},setParentManipulated:function(e){this.enablePreactivate=!e},setToGhostState:function(){this.mat.opacity=0},setToNonGhostState:function(){this.mat.opacity=1},setToDragState:function(){this.mat.opacity=.2}});return UWA.namespace("THREEDS/Robot/LineTranslationNode",h)}),define("Robot/LineTranslationNode",["DS/Robot/LineTranslationNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Robot/LineTranslationNode"),e}),define("DS/Robot/FreeRobot",["DS/SceneGraphNodes/FixedSizeNode3D","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Robot/LineTranslationNode","DS/Robot/XYRotationNode","DS/Robot/XZRotationNode","DS/Robot/YZRotationNode","DS/Robot/YZPlaneTranslationNode","DS/Robot/XYPlaneTranslationNode","DS/Robot/XZPlaneTranslationNode","DS/Robot/RobotHandle","DS/Robot/ScalingNode","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Selection/HSOManager","DS/Visualization/Mesh3D"],function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g){"use strict";var v=!1,S=r.extend({init:function(t,r,p,m,v){this._parent(t),this.setParameters(p,m);var S=this;this.isManipulated=!1,this.sceneGraphState=null,this.mode="NODE",this._labels={},this._modelEvent=new f,this._subscribedEvents=[];var _={position:new i.Vector3(0,0,0),touchMode:v||!1};this.arrowZ=new n(_),this.arrowZ.setMatrix((new i.Matrix4).setPosition(new i.Vector3(0,0,2))),this.arrowZ.name="arrowZ",this.arrowY=new n(_),this.arrowY.setMatrix((new i.Matrix4).rotateX(-Math.PI/2).setPosition(new i.Vector3(0,2,0))),this.arrowY.name="arrowY",this.arrowX=new n(_),this.arrowX.setMatrix((new i.Matrix4).rotateY(Math.PI/2).setPosition(new i.Vector3(2,0,0))),this.arrowX.name="arrowX";var y={constraintAxis:new i.Vector3(0,0,1),touchMode:v||!1};this.rotationArcXY=new a(y);var x={constraintAxis:new i.Vector3(0,1,0),touchMode:v||!1};this.rotationArcXZ=new s(x),this.rotationArcXZ.name="rotationArcXZ";var M={constraintAxis:new i.Vector3(1,0,0),touchMode:v||!1};this.rotationArcYZ=new o(M),this.rotationArcYZ.name="rotationArcYZ";var P={position:new i.Vector3(0,0,0),touchMode:v||!1};this.robotHandle=new u(P);var C={constraintAxis:new i.Vector3(1,0,0),touchMode:v||!1};this.scalingNodeX=new d(C),this.scalingNodeX.setMatrix((new i.Matrix4).setPosition(new i.Vector3(11,0,0)));var b={constraintAxis:new i.Vector3(0,1,0),touchMode:v||!1};this.scalingNodeY=new d(b),this.scalingNodeY.setMatrix((new i.Matrix4).setPosition(new i.Vector3(0,11,0)));var D={constraintAxis:new i.Vector3(0,0,1),touchMode:v||!1};this.scalingNodeZ=new d(D),this.scalingNodeZ.setMatrix((new i.Matrix4).setPosition(new i.Vector3(0,0,11)));var w={constraintAxis:new i.Vector3(0,0,1),touchMode:v||!1},E={constraintAxis:new i.Vector3(0,1,0),touchMode:v||!1},T={constraintAxis:new i.Vector3(1,0,0),touchMode:v||!1};this.translationPlaneXY=new c(w),this.translationPlaneXZ=new h(E),this.translationPlaneYZ=new l(T),this.name="robot",this.fixedSizeNode3D=new e({name:"fixedSizeNode3D",ratio:7}),this.fixedSizeNode3D.addChild(this.rotationArcXY),this.fixedSizeNode3D.addChild(this.rotationArcYZ),this.fixedSizeNode3D.addChild(this.rotationArcXZ),this.fixedSizeNode3D.addChild(this.arrowZ),this.fixedSizeNode3D.addChild(this.arrowX),this.fixedSizeNode3D.addChild(this.arrowY),this.fixedSizeNode3D.addChild(this.robotHandle),this.fixedSizeNode3D.addChild(this.scalingNodeZ),this.fixedSizeNode3D.addChild(this.scalingNodeY),this.fixedSizeNode3D.addChild(this.scalingNodeX),this.fixedSizeNode3D.addChild(this.translationPlaneYZ),this.fixedSizeNode3D.addChild(this.translationPlaneXY),this.fixedSizeNode3D.addChild(this.translationPlaneXZ),this.addChild(this.fixedSizeNode3D),this.traverse(function(e){e instanceof g&&e.setMirror(!1)}),this.setVisibilityInTree(!1),this.setRenderPasses(["robot"]),this._subscribeModelEvent(this.arrowX,"LineTranslationBegin",S.LineTranslationBeginCB.bind(S)),this._subscribeModelEvent(this.arrowX,"LineTranslationManipulation",S.LineTranslationManipulationCB.bind(S)),this._subscribeModelEvent(this.arrowX,"LineTranslationEnd",S.LineTranslationEndCB.bind(S)),this._subscribeModelEvent(this.arrowY,"LineTranslationBegin",S.LineTranslationBeginCB.bind(S)),this._subscribeModelEvent(this.arrowY,"LineTranslationManipulation",S.LineTranslationManipulationCB.bind(S)),this._subscribeModelEvent(this.arrowY,"LineTranslationEnd",S.LineTranslationEndCB.bind(S)),this._subscribeModelEvent(this.arrowZ,"LineTranslationBegin",S.LineTranslationBeginCB.bind(S)),this._subscribeModelEvent(this.arrowZ,"LineTranslationManipulation",S.LineTranslationManipulationCB.bind(S)),this._subscribeModelEvent(this.arrowZ,"LineTranslationEnd",S.LineTranslationEndCB.bind(S)),this._subscribeModelEvent(this.translationPlaneYZ,"PlaneTranslationBegin",S.PlaneTranslationBeginCB.bind(S)),this._subscribeModelEvent(this.translationPlaneYZ,"PlaneTranslationManipulation",S.PlaneTranslationManipulationCB.bind(S)),this._subscribeModelEvent(this.translationPlaneYZ,"PlaneTranslationEnd",S.PlaneTranslationEndCB.bind(S)),this._subscribeModelEvent(this.translationPlaneXZ,"PlaneTranslationBegin",S.PlaneTranslationBeginCB.bind(S)),this._subscribeModelEvent(this.translationPlaneXZ,"PlaneTranslationManipulation",S.PlaneTranslationManipulationCB.bind(S)),this.translationPlaneXZ._modelEvent.subscribe({event:"PlaneTranslationEnd"},S.PlaneTranslationEndCB.bind(S)),this._subscribeModelEvent(this.translationPlaneXY,"PlaneTranslationBegin",S.PlaneTranslationBeginCB.bind(S)),this._subscribeModelEvent(this.translationPlaneXY,"PlaneTranslationManipulation",S.PlaneTranslationManipulationCB.bind(S)),this._subscribeModelEvent(this.translationPlaneXY,"PlaneTranslationEnd",S.PlaneTranslationEndCB.bind(S)),this._subscribeModelEvent(this.rotationArcXY,"RotationBegin",S.RotationBeginCB.bind(S)),this._subscribeModelEvent(this.rotationArcXY,"RotationManipulation",S.RotationManipulationCB.bind(S)),this._subscribeModelEvent(this.rotationArcXY,"RotationEnd",S.RotationEndCB.bind(S)),this._subscribeModelEvent(this.rotationArcXZ,"RotationBegin",S.RotationBeginCB.bind(S)),this._subscribeModelEvent(this.rotationArcXZ,"RotationManipulation",S.RotationManipulationCB.bind(S)),this._subscribeModelEvent(this.rotationArcXZ,"RotationEnd",S.RotationEndCB.bind(S)),this._subscribeModelEvent(this.rotationArcYZ,"RotationBegin",S.RotationBeginCB.bind(S)),this._subscribeModelEvent(this.rotationArcYZ,"RotationManipulation",S.RotationManipulationCB.bind(S)),this._subscribeModelEvent(this.rotationArcYZ,"RotationEnd",S.RotationEndCB.bind(S)),this._subscribeModelEvent(this.scalingNodeX,"ScalingBegin",S.ScalingBeginCB.bind(S)),this._subscribeModelEvent(this.scalingNodeX,"ScalingManipulation",S.ScalingManipulationCB.bind(S)),this._subscribeModelEvent(this.scalingNodeX,"ScalingEnd",S.ScalingEndCB.bind(S)),this._subscribeModelEvent(this.scalingNodeY,"ScalingBegin",S.ScalingBeginCB.bind(S)),this._subscribeModelEvent(this.scalingNodeY,"ScalingManipulation",S.ScalingManipulationCB.bind(S)),this._subscribeModelEvent(this.scalingNodeY,"ScalingEnd",S.ScalingEndCB.bind(S)),this._subscribeModelEvent(this.scalingNodeZ,"ScalingBegin",S.ScalingBeginCB.bind(S)),this._subscribeModelEvent(this.scalingNodeZ,"ScalingManipulation",S.ScalingManipulationCB.bind(S)),this._subscribeModelEvent(this.scalingNodeZ,"ScalingEnd",S.ScalingEndCB.bind(S)),this._subscribeModelEvent(this.robotHandle,"ScreenPlaneTranslationBegin",S.ScreenPlaneTranslationBeginCB.bind(S)),this._subscribeModelEvent(this.robotHandle,"ScreenPlaneTranslationManipulation",S.ScreenPlaneTranslationManipulationCB.bind(S)),this._subscribeModelEvent(this.robotHandle,"ScreenPlaneTranslationEnd",S.ScreenPlaneTranslationEndCB.bind(S)),this._labelColor=null,this._updateLabelColor(r);var A=r.onBackgroundModify(function(){S._updateLabelColor(r),S.setLabels(S._labels)});this._subscribedEvents.push({object:r,token:A}),this.snapFilterCallback=null,this.snapTranslationCallback=null,this.snapRotationCallback=null,this.target=null,this.initialMatrix=null,this.initialTargetWorldMatrix=null,this.robotRotationMatrix=null,this._setWorldOrientation(r.getWorldOrientation())},setRatio:function(e){e=e||{ratio:7},this.fixedSizeNode3D.setRatio(e.ratio)},setParameters:function(e,t){this.snapOnFace=e,this.showOnlyManipulated=t},setLabels:function(e){e=e||{},this._labels=e,this.arrowX.setLabel(e.labelX,this._labelColor),this.arrowY.setLabel(e.labelY,this._labelColor),this.arrowZ.setLabel(e.labelZ,this._labelColor)},setMoveMode:function(e,t){"OCCURRENCE"!==e?(this.mode=e,this.sceneGraphState=t?t.sceneGraphState:null):v||(console.warn("OCCURRENCE move mode is no more supported"),v=!0)},setDisplayScalingNodes:function(e){this.scalingNodeX.setVisibility(!!e),this.scalingNodeY.setVisibility(!!e),this.scalingNodeZ.setVisibility(!!e);var t=e?11.5:9;this.arrowX._updateLabelPosition(t),this.arrowY._updateLabelPosition(t),this.arrowZ._updateLabelPosition(t)},getNodeType:function(){return"FreeRobot"},LineTranslationBeginCB:function(e){this.target&&(this.setManipulated(!0),this.initialMatrix=(new i.Matrix4).copy(this.getMatrix()),this.initialTargetWorldMatrix=(new i.Matrix4).copy(this.target.getWorldMatrix(e.viewer)),this.showOnlyManipulated&&this.setToGhostState(),e.viewer.render()),this._modelEvent.publish({event:"LineTranslationBegin",data:{eventChannel:"LineTranslationBegin",target:this.target,intersection:e.intersection,manipulator:e.manipulator,event:e.event}})},LineTranslationManipulationCB:function(e){var t=e.translationVector;if(this.target){var r=e.paths[0].externalPath;if(this.contains(this,r)){if(this.snapTranslationCallback&&!(t=this.snapTranslationCallback({translationVector:t,target:this.target,intersection:e.intersection})))return;var n=new i.Vector3;n.getPositionFromMatrix(this.initialMatrix),n.add(t);var a=(new i.Matrix4).copy(this.getMatrix());this.setMatrix(a.setPosition(n)),this.updateCenterPosition(n);var s=new i.Vector3;s.getPositionFromMatrix(this.initialTargetWorldMatrix),s.add(t);var o=(new i.Matrix4).copy(this.initialTargetWorldMatrix).setPosition(s);if(this.sceneGraphState&&"OCCURRENCE_secret"===this.mode)this.sceneGraphState.applyAbsolutePositionToPath(this.target,o);else if("NODE"===this.mode){var l,c=this.target.externalPath,h=this.target.getParentPath();l=h?h.getWorldMatrix(e.viewer):new i.Matrix4;var u=new i.Matrix4;u.getInverse(l);var d=u.multiply(o);c[c.length-1].setMatrix(d)}e.viewer.render()}}this._modelEvent.publish({event:"LineTranslationManipulation",data:{eventChannel:"LineTranslationManipulation",target:this.target,translationVector:t,intersection:e.intersection,manipulator:e.manipulator,event:e.event}})},LineTranslationEndCB:function(e){this.target&&(this.setManipulated(!1),this.showOnlyManipulated&&this.setToNonGhostState(),e.viewer.render()),this._modelEvent.publish({event:"LineTranslationEnd",data:{eventChannel:"LineTranslationEnd",target:this.target,intersection:e.intersection,manipulator:e.manipulator,event:e.event}})},PlaneTranslationBeginCB:function(e){this.target&&(this.setManipulated(!0),this.initialMatrix=(new i.Matrix4).copy(this.getMatrix()),this.initialTargetWorldMatrix=(new i.Matrix4).copy(this.target.getWorldMatrix(e.viewer)),this.showOnlyManipulated&&this.setToGhostState(),e.viewer.render()),this._modelEvent.publish({event:"PlaneTranslationBegin",data:{eventChannel:"PlaneTranslationBegin",target:this.target,intersection:e.intersection,manipulator:e.manipulator,event:e.event}})},PlaneTranslationManipulationCB:function(e){if(this.target){var t=e.paths[0].externalPath;if(this.contains(this,t)){var r=new i.Vector3;r.getPositionFromMatrix(this.initialMatrix),r.add(e.translationVector);var n=(new i.Matrix4).copy(this.getMatrix());this.setMatrix(n.setPosition(r)),this.updateCenterPosition(r)}var a=new i.Vector3;a.getPositionFromMatrix(this.initialTargetWorldMatrix),a.add(e.translationVector);var s=(new i.Matrix4).copy(this.initialTargetWorldMatrix).setPosition(a);if(this.sceneGraphState&&"OCCURRENCE_secret"===this.mode)this.sceneGraphState.applyAbsolutePositionToPath(this.target,s);else if("NODE"===this.mode){var o,l=this.target.externalPath,c=this.target.getParentPath();o=c?c.getWorldMatrix(e.viewer):new i.Matrix4;var h=new i.Matrix4;h.getInverse(o);var u=h.multiply(s);l[l.length-1].setMatrix(u)}e.viewer.render()}this._modelEvent.publish({event:"PlaneTranslationManipulation",data:{eventChannel:"PlaneTranslationManipulation",target:this.target,translationVector:e.translationVector,intersection:e.intersection,manipulator:e.manipulator,event:e.event}})},PlaneTranslationEndCB:function(e){this.target&&(this.setManipulated(!1),this.showOnlyManipulated&&this.setToNonGhostState(),e.viewer.render()),this._modelEvent.publish({event:"PlaneTranslationEnd",data:{eventChannel:"PlaneTranslationEnd",target:this.target,intersection:e.intersection,manipulator:e.manipulator,event:e.event}})},RotationBeginCB:function(e){this.target&&(this.setManipulated(!0),this.initialMatrix=(new i.Matrix4).copy(this.getMatrix()),this.initialTargetWorldMatrix=new i.Matrix4,this.target.getWorldMatrix(e.viewer,this.initialTargetWorldMatrix),this.showOnlyManipulated&&this.setToGhostState(),e.viewer.render()),this._modelEvent.publish({event:"RotationBegin",data:{eventChannel:"RotationBegin",target:this.target,intersection:e.intersection,manipulator:e.manipulator,event:e.event}})},RotationManipulationCB:function(e){var t=e.angle,r=e.axis;if(this.target){var n=e.paths[0].externalPath,a=e.rotationMatrix;if(this.snapRotationCallback){var s=this.snapRotationCallback({axis:e.axis,angle:e.angle,target:this.target,intersection:e.intersection});if(t=s.value,r=s.axis,void 0===t||!r)return;t=Math.PI*t/180,a=(new i.Matrix4).makeRotationAxis(r,t)}if(this.contains(this,n)){var o=(new i.Matrix4).copy(a);o.multiply((new i.Matrix4).extractRotation(this.initialMatrix));var l=o.setPosition((new i.Vector3).getPositionFromMatrix(this.initialMatrix));this.setMatrix(l)}var c=(new i.Matrix4).copy(this.initialTargetWorldMatrix),h=(a=(new i.Matrix4).makeRotationAxis(r,t),(new i.Matrix4).setPosition((new i.Vector3).getPositionFromMatrix(this.initialMatrix))),u=(new i.Matrix4).getInverse(h).multiply(c),d=(new i.Matrix4).copy(a).multiply(u),p=(new i.Matrix4).copy(h).multiply(d);if(this.sceneGraphState&&"OCCURRENCE_secret"===this.mode)this.sceneGraphState.applyAbsolutePositionToPath(this.target,p);else if("NODE"===this.mode){var f=this.target.externalPath,m=new i.Matrix4,g=this.target.getParentPath();g&&g.getWorldMatrix(e.viewer,m);var v=new i.Matrix4;v.getInverse(m);var S=v.multiply(p);f[f.length-1].setMatrix(S)}e.viewer.render()}this._modelEvent.publish({event:"RotationManipulation",data:{eventChannel:"RotationManipulation",target:this.target,rotationMatrix:e.rotationMatrix,rotationCenter:e.center,angle:t,axis:r,intersection:e.intersection,manipulator:e.manipulator,event:e.event}})},RotationEndCB:function(e){if(this.target){this.setManipulated(!1),this.robotRotationMatrix=(new i.Matrix4).extractRotation(this.getMatrix());var t=new i.Vector3(this.robotRotationMatrix.elements[0],this.robotRotationMatrix.elements[1],this.robotRotationMatrix.elements[2]).normalize(),r=new i.Vector3(this.robotRotationMatrix.elements[4],this.robotRotationMatrix.elements[5],this.robotRotationMatrix.elements[6]).normalize(),n=new i.Vector3(this.robotRotationMatrix.elements[8],this.robotRotationMatrix.elements[9],this.robotRotationMatrix.elements[10]).normalize();this.updateAxis(t,r,n),this.showOnlyManipulated&&this.setToNonGhostState(),e.viewer.render()}this._modelEvent.publish({event:"RotationEnd",data:{eventChannel:"RotationEnd",target:this.target,intersection:e.intersection,manipulator:e.manipulator,event:e.event}})},ScalingBeginCB:function(e){this.target&&(this.setManipulated(!0),this.initialMatrix=(new i.Matrix4).copy(this.target.getWorldMatrix(e.viewer)),this.showOnlyManipulated&&this.setToGhostState(),e.viewer.render()),this._modelEvent.publish({event:"ScalingBegin",data:{eventChannel:"ScalingBegin",target:this.target,intersection:e.intersection,manipulator:e.manipulator,event:e.event}})},ScalingManipulationCB:function(e){if(this.target){var t=e.paths[0].externalPath;if(this.contains(this,t)){var r=new i.Matrix4;if(r.copy(e.scalingMatrix),r.multiply((new i.Matrix4).copy(this.initialMatrix)),this.sceneGraphState&&"OCCURRENCE_secret"===this.mode)this.sceneGraphState.applyAbsolutePositionToPath(this.target,r);else if("NODE"===this.mode){var n,a=this.target.externalPath,s=this.target.getParentPath();n=s?s.getWorldMatrix(e.viewer):new i.Matrix4;var o=new i.Matrix4;o.getInverse(n);var l=o.multiply(r);a[a.length-1].setMatrix(l)}e.viewer.render()}}this._modelEvent.publish({event:"ScalingManipulation",data:{eventChannel:"ScalingManipulation",target:this.target,scalingFactor:e.scalingFactor,scalingCenter:e.center,intersection:e.intersection,manipulator:e.manipulator,event:e.event}})},ScalingEndCB:function(e){this.target&&(this.setManipulated(!1),this.showOnlyManipulated&&this.setToNonGhostState(),e.viewer.render()),this._modelEvent.publish({event:"ScalingEnd",data:{eventChannel:"ScalingEnd",target:this.target,scalingFactor:e.scalingFactor,scalingCenter:e.center,intersection:e.intersection,manipulator:e.manipulator,event:e.event}})},ScreenPlaneTranslationBeginCB:function(e){this._modelEvent.publish({event:"ScreenPlaneTranslationBegin",data:{eventChannel:"ScreenPlaneTranslationBegin",position:e.position,intersection:e.intersection,manipulator:e.manipulator,event:e.event}})},ScreenPlaneTranslationManipulationCB:function(e){this._modelEvent.publish({event:"ScreenPlaneTranslationManipulation",data:{eventChannel:"ScreenPlaneTranslationManipulation",intersection:e.intersection,manipulator:e.manipulator,event:e.event}})},ScreenPlaneTranslationEndCB:function(e){this._modelEvent.publish({event:"ScreenPlaneTranslationEnd",data:{eventChannel:"ScreenPlaneTranslationEnd",target:this.target,intersection:e.intersection,manipulator:e.manipulator,event:e.event}})},setRobotMatrix:function(e){this.setMatrix(e),this.updateCenterPosition((new i.Vector3).getPositionFromMatrix(e));var t=new i.Vector3,r=new i.Vector3,n=new i.Vector3;e.extractBasis(t,r,n),this.updateAxis(t,r,n)},updateCenterPosition:function(e){this.rotationArcXY.setCenter(e),this.rotationArcXZ.setCenter(e),this.rotationArcYZ.setCenter(e),this.scalingNodeZ.setCenter(e),this.scalingNodeX.setCenter(e),this.scalingNodeY.setCenter(e)},updateAxis:function(e,t,i){this.arrowX.setAxis(e),this.arrowY.setAxis(t),this.arrowZ.setAxis(i),this.translationPlaneYZ.setAxis(e),this.translationPlaneXY.setAxis(i),this.translationPlaneXZ.setAxis(t),this.scalingNodeY.setAxis(t),this.scalingNodeX.setAxis(e),this.scalingNodeZ.setAxis(i),this.rotationArcYZ.setAxis(e),this.rotationArcXZ.setAxis(t),this.rotationArcXY.setAxis(i)},setManipulated:function(e){this.isManipulated=e,this.arrowX.setParentManipulated(e),this.arrowY.setParentManipulated(e),this.arrowZ.setParentManipulated(e),this.translationPlaneYZ.setParentManipulated(e),this.translationPlaneXY.setParentManipulated(e),this.translationPlaneXZ.setParentManipulated(e),this.scalingNodeY.setParentManipulated(e),this.scalingNodeX.setParentManipulated(e),this.scalingNodeZ.setParentManipulated(e),this.rotationArcYZ.setParentManipulated(e),this.rotationArcXZ.setParentManipulated(e),this.rotationArcXY.setParentManipulated(e),this.robotHandle.setParentManipulated(e)},setToGhostState:function(){this.arrowX.setToGhostState(),this.arrowY.setToGhostState(),this.arrowZ.setToGhostState(),this.translationPlaneYZ.setToGhostState(),this.translationPlaneXY.setToGhostState(),this.translationPlaneXZ.setToGhostState(),this.scalingNodeY.setToGhostState(),this.scalingNodeX.setToGhostState(),this.scalingNodeZ.setToGhostState(),this.robotHandle.setToGhostState(),this.rotationArcYZ.setToGhostState(),this.rotationArcXZ.setToGhostState(),this.rotationArcXY.setToGhostState()},setToNonGhostState:function(){this.arrowX.setToNonGhostState(),this.arrowY.setToNonGhostState(),this.arrowZ.setToNonGhostState(),this.translationPlaneYZ.setToNonGhostState(),this.translationPlaneXY.setToNonGhostState(),this.translationPlaneXZ.setToNonGhostState(),this.scalingNodeY.setToNonGhostState(),this.scalingNodeX.setToNonGhostState(),this.scalingNodeZ.setToNonGhostState(),this.robotHandle.setToNonGhostState(),this.rotationArcYZ.setToNonGhostState(),this.rotationArcXZ.setToNonGhostState(),this.rotationArcXY.setToNonGhostState()},subscribe:function(e,t){return this._modelEvent.subscribe({event:e},t)},unsubscribe:function(e){this._modelEvent.unsubscribe(e)},setTarget:function(e,t,r){this.target=e;var n=t?t.clone():null;if(!n){n=this.target.getWorldMatrix(r);var a=this.target.getBoundingSphere();n.setPosition(a.center)}this.setMatrix(n);var s=new i.Vector3;s.getPositionFromMatrix(n),this.updateCenterPosition(s);var o=new i.Vector3,l=new i.Vector3,c=new i.Vector3;this.getMatrix().extractBasis(o,l,c),this.updateAxis(o,l,c)},contains:function(e,t){for(var i=0;i<t.length;i++)if(t[i]===e)return!0;return!1},_setWorldOrientation:function(e){this.translationPlaneXY._setWorldOrientation(e),this.translationPlaneXZ._setWorldOrientation(e),this.translationPlaneYZ._setWorldOrientation(e),this.rotationArcXY._setWorldOrientation(e),this.rotationArcXZ._setWorldOrientation(e),this.rotationArcYZ._setWorldOrientation(e)},_dispose:function(){var e,t;for(this.traverse(e=>{var t=e.mesh3js&&e.mesh3js.material;t&&t.map&&(t.map.dispose(),t.map=null)}),e=0;e<this._subscribedEvents.length;e++)(t=this._subscribedEvents[e]).object.unsubscribe(t.token);this._subscribedEvents=[],this._modelEvent.destroy()},_subscribeModelEvent:function(e,t,i){this._subscribe(e._modelEvent,t,i)},_subscribe:function(e,t,i){var r=e.subscribe({event:t},i);this._subscribedEvents.push({object:e,token:r})},_updateLabelColor:function(e){var t=new i.Color(e.backgroundColor),r=Math.round((255*t.r*299+255*t.g*587+255*t.b*114)/1e3);this._labelColor=r>125?"grey":"white"}});return UWA.namespace("THREEDS/Nodes/FreeRobot",S)}),define("Robot/FreeRobot",["DS/Robot/FreeRobot","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Robot/FreeRobot"),e}),define("DS/Robot/Robot",["DS/Robot/FreeRobot","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/Robot/ReferenceAxisSystemNode"],function(e,t,i,r,n,a,s,o){"use strict";var l={x:new i.Vector3,y:new i.Vector3,z:new i.Vector3},c=e.extend({init:function(e,t,i,r,n,a,s){"I solemnly swear that I am up to no good."!==a&&console.warn("DEPRECATED API USE: create Robot using 'webGLV6Viewer.setRobot(true, {snapOnFace: true});\nStack: "+(new Error).stack),this._parent(t,i,r,n,s),this.viewer=i,this.sceneGraph=e,this._addToCSO=!0,this._addToHSO=!0,this.hiddenMode=!1,this.moveViewpointOnClickDuration=1e3,this._enabled=!0,this._showLabels=!0,this._viewPlane=null,this._viewPlaneOrientation=0,this.ratio=null,this.isConnected=!1,this.isManipulatedInPlane=!1,this._getPositionCB=null,this.checkTarget=!1;var o=this;this.setVisibilityFree(!0),i._addRobot(this,this.sceneGraph),this._subscribe(this.translationPlaneXY._modelEvent,"PrimaryPointerClick",function(e){o.moveViewToPlane("XY")}),this._subscribe(this.translationPlaneXZ._modelEvent,"PrimaryPointerClick",function(e){o.moveViewToPlane("XZ")}),this._subscribe(this.translationPlaneYZ._modelEvent,"PrimaryPointerClick",function(e){o.moveViewToPlane("YZ")}),this._subscribe(this.rotationArcXY._modelEvent,"PrimaryPointerClick",function(e){o.moveViewToPlane("XY")}),this._subscribe(this.rotationArcXZ._modelEvent,"PrimaryPointerClick",function(e){o.moveViewToPlane("XZ")}),this._subscribe(this.rotationArcYZ._modelEvent,"PrimaryPointerClick",function(e){o.moveViewToPlane("YZ")}),this._subscribe(this.arrowZ._modelEvent,"PrimaryPointerClick",function(e){o.moveViewToPlane("XY")}),this._subscribe(this.arrowY._modelEvent,"PrimaryPointerClick",function(e){o.moveViewToPlane("XZ")}),this._subscribe(this.arrowX._modelEvent,"PrimaryPointerClick",function(e){o.moveViewToPlane("YZ")}),this._subscribe(this.scalingNodeZ._modelEvent,"PrimaryPointerClick",function(e){o.moveViewToPlane("XY")}),this._subscribe(this.scalingNodeY._modelEvent,"PrimaryPointerClick",function(e){o.moveViewToPlane("XZ")}),this._subscribe(this.scalingNodeX._modelEvent,"PrimaryPointerClick",function(e){o.moveViewToPlane("YZ")}),this.robotHandle.setCameraName("robotCameraOrtho"),this.snapFilterCallback=null,this.snapTranslationCallback=null,this.snapRotationCallback=null,this.manipulationX=0,this.manipulationY=0,this._setOrthoState(!0),this.setRatio(null)},setRatio:function(e){this.ratio=e||{docked:7,moving:10,connected:10},this._updateRatio()},setAddToCSO:function(e){this._addToCSO=e},setAddToHSO:function(e){this._addToHSO=e},getNodeType:function(){return"Robot"},ScreenPlaneTranslationBeginCB:function(e){this.isManipulatedInPlane=!0,this.setManipulated(!0),this.initialMatrix=(new i.Matrix4).copy(this.getMatrix()),this._updateRatio(),this.setPickable(t.PICKTHROUGH),this.viewer.renderer.pickingGPUComposerContext.needsUpdate=!0,this.viewer.renderer.depthComposerContext.needsUpdate=!0,this.viewer.renderer.normalComposerContext.needsUpdate=!0;var r=new i.Vector3(1,0,0),n=new i.Vector3(0,1,0),a=new i.Vector3(0,0,1);this.updateAxis(r,n,a),this.showOnlyManipulated&&this.setToDragState(),this._parent(e);var s=this.getMousePosition(e.event);this.manipulationX=s.x,this.manipulationY=s.y,this._setOrthoState(!0),this.onViewpointChange(),this._updateLabelsAndReferenceAxisSystem()},ScreenPlaneTranslationManipulationCB:function(e){this._setOrthoState(!0);var t=e.paths[0].externalPath;if(this.contains(this,t)){var i=this.getMousePosition(e.event);this.manipulationX=i.x,this.manipulationY=i.y,this.onViewpointChange(),this.viewer.render(),this._parent(e)}this._updateLabelsAndReferenceAxisSystem()},getMousePosition:function(e){return(e.from[1]||e.from[0]).getCurrentPosition(this.viewer.canvas)},ScreenPlaneTranslationEndCB:function(e){this.isManipulatedInPlane=!1,this.setManipulated(!1);var r=e.intersection,n=r.position&&r.path.length,o=n?r.path[0]:null;if(n&&this.snapFilterCallback&&null==(o=this.snapFilterCallback(o))&&(n=!1),n){this._setOrthoState(!1),this.isConnected=!0,this.target=o,this._addToHSO&&(a.empty(),a.add({pathElement:this.target})),this._addToCSO&&(s.empty(),s.add({pathElement:this.target}));var l=new i.Matrix4;if(this.snapOnFace)l=this.viewer.getWorldOrientation().buildSnapRobotMatrix(r),this.setRobotMatrix(l);else this.updateCenterPosition(r.position),l.setPosition(r.position),this.setMatrix(l)}else this._setOrthoState(!0),this.target=null,this.isConnected=!1,this.viewer.render();this.setPickable(t.PICKABLE),this.showOnlyManipulated&&this.setToNonGhostState(),this.viewer.render(),this._parent(e),this._updateRatio(),this.onViewpointChange(),this._updateLabelsAndReferenceAxisSystem()},onViewpointChange:function(){var e=this.viewer.currentViewpoint;if(e){var t,r;t=this.viewer.devicePixelRatio;var n,a=(r=this._getPositionCB?this._getPositionCB(this.viewer.canvas.width,this.viewer.canvas.height,t):this._getPosition_default(this.viewer.canvas.width,this.viewer.canvas.height,t)).y,s=r.x;this.isManipulatedInPlane?(n=o(2*t*this.manipulationX/this.viewer.canvas.width-1,2*(1-t*this.manipulationY/this.viewer.canvas.height)-1),this.setMatrix(n)):this.isConnected||this.isManipulated||(n=o(s,a),this.setMatrix(n)),this._updateLabelsAndReferenceAxisSystem()}function o(t,r){var n,a=e.robotCameraOrtho,s=new i.Vector3(t,r,0);if((new i.Projector).unprojectVector(s,a),a instanceof i.PerspectiveCamera){var o=new i.Ray(data.cameraEye,s.sub(data.cameraEye).normalize()),l=new i.Plane(e.camera.getLookAt(),0);n=o.intersectPlane(l)}else n=s;return(new i.Matrix4).setPosition(n)}},setConnectionState:function(e){return this.isManipulated?(this._updateLabelsAndReferenceAxisSystem(),this._updateRatio(),!1):(e?this.connect():this.disconnect(),this._updateLabelsAndReferenceAxisSystem(),!0)},setCheckTarget:function(e){this.checkTarget=e},isTargetGone:function(e){if(!this.checkTarget)return!1;if(null===this.target||void 0===this.target)return!0;for(var t=!1,i=!0,r=this.target.externalPath,n=0;n<r.length;n++){var a=r[n];t=a._getVisibilityFree(),i=a._getVisible()}return t?!i:!!e!==i},setSnapFilterCallback:function(e){this.snapFilterCallback=e},setSnapTranslationCallback:function(e){this.snapTranslationCallback=e},setSnapRotationCallback:function(e){this.snapRotationCallback=e},moveViewToPlane:function(e){if(!this.isConnected&&this.moveViewpointOnClickDuration>=0){this.viewer.currentViewpoint.control;var t=new i.Matrix4;this._viewPlane===e?this._viewPlaneOrientation*=-1:this._viewPlaneOrientation=1,this._viewPlane=e;var r=this._viewPlaneOrientation>0?0:Math.PI;"XY"===e?(t.rotateX(0+r),t.rotateZ(Math.PI/2)):"XZ"===e?(t.rotateX(Math.PI/2),t.rotateY(Math.PI+r)):"YZ"===e&&(t.rotateY(Math.PI/2+r),t.rotateZ(Math.PI/2+r));var n=t.decompose(),a=new i.Vector3(0,1,0);a.applyQuaternion(n[1]),a.normalize();var s=new i.Vector3(0,0,-1);s.applyQuaternion(n[1]),s.normalize(),this.viewer.currentViewpoint.moveTo({upDirection:a,sightDirection:s,duration:this.moveViewpointOnClickDuration})}},connect:function(){this._setOrthoState(!1),this.isConnected=!0,this._updateRatio(),this._updateLabelsAndReferenceAxisSystem()},disconnect:function(){this._setOrthoState(!0),this.isConnected=!1,this._updateRatio(),this.onViewpointChange(),this.viewer.render(),this.target=null,this._updateLabelsAndReferenceAxisSystem()},setToDragState:function(){this.arrowX.setToDragState(),this.arrowY.setToDragState(),this.translationPlaneYZ.setToGhostState(),this.translationPlaneXZ.setToGhostState(),this.translationPlaneXY.setToDragState(),this.scalingNodeY.setToGhostState(),this.scalingNodeX.setToGhostState(),this.scalingNodeZ.setToGhostState(),this.rotationArcYZ.setToGhostState(),this.rotationArcXZ.setToGhostState(),this.rotationArcXY.setToGhostState()},setVisibility:function(e){this.setHiddenMode(!e),this._parent(e)},setHiddenMode:function(e){this.hiddenMode=e,this._updateLabelsAndReferenceAxisSystem()},_setOrthoState:function(e){e?(this.setRenderPasses(["robotOrtho"]),this._setCameraName("robotCameraOrtho")):(this.setRenderPasses(["robot"]),this._setCameraName("connectedRobotCamera"))},setDrivenConnectionMode:function(){this.setDrivenMode.apply(this,arguments)},setDrivenMode:function(){this.setConnectionState.apply(this,arguments)},_setCameraName:function(e){this.fixedSizeNode3D.setCameraName(e)},_updateLabelsAndReferenceAxisSystem:function(){var e=this;function t(t){var i=t&&e._enabled;e.fixedSizeNode3D._getVisible()!==i&&e.fixedSizeNode3D.setVisibility(i)}function i(t){t&&e._enabled;e.viewer._modelEvent.publish({event:"UpdateReferenceAxisSystemVisibility",data:{visible:t}})}this.hiddenMode?(t(!1),i(!0)):this.isManipulated?(t(!0),i(!0),this.setLabels(null)):this.isConnected?(this._showLabels?this._setLocalLabels():this.setLabels(null),t(!0),i(!0)):(this._showLabels?this.setLabels({labelX:"x",labelY:"y",labelZ:"z"}):this.setLabels(null),t(!0),i(!1))},_setLocalLabels:function(){function e(e,t){e.normalize();var i=null;return e.x>.9995?i="x":e.y>.9995?i="y":e.z>.9995&&(i="z"),i?t+"|"+i:t}this.getMatrix().extractBasis(l.x,l.y,l.z),this.setLabels({labelX:e(l.x,"u"),labelY:e(l.y,"v"),labelZ:e(l.z,"w")})},setMatrix:function(){this._parent.apply(this,arguments),this._updateLabelsAndReferenceAxisSystem()},setManipulated:function(e){var t=e!==this.isManipulated;this._parent.apply(this,arguments),t&&this._updateLabelsAndReferenceAxisSystem()},showLabels:function(e){this._showLabels=e,this._updateLabelsAndReferenceAxisSystem()},setMoveViewpointOnClickDuration:function(e){this.moveViewpointOnClickDuration=e},setGetPositionCB:function(e){this._getPositionCB=e,this.onViewpointChange()},_setEnabled:function(e){var t=!!e;this._enabled!==t&&(this._enabled=t,this.onViewpointChange())},_isEnabled:function(){return this._enabled},_updateRatio:function(){this.isManipulatedInPlane?this.fixedSizeNode3D.setRatio(this.ratio.moving||this.ratio.ratio):this.isConnected?this.fixedSizeNode3D.setRatio(this.ratio.connected||this.ratio.ratio):this.fixedSizeNode3D.setRatio(this.ratio.docked||this.ratio.ratio)},_dispose:function(){this._getPositionCB=null,this._parent()},_getPosition_default:function(e,t,i){var r;return{x:2*(e-100*i*(r=this.fixedSizeNode3D.ratio/7))/e-1,y:Math.max(200*i*r/t-1,-.85)}},CallBackEventHandlerViewPoint:function(){this.onViewpointChange.apply(this,arguments)}});return UWA.namespace("THREEDS/Nodes/Robot",c)}),define("Robot/Robot",["DS/Robot/Robot","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Robot/Robot"),e}),define("DS/Visualization/AnnotationServices",["UWA/Class","DS/Visualization/Utils","DS/Formats/CGRFile","DS/Visualization/ModelLoader","DS/Visualization/ProxyAbstraction","DS/ZipJS/LoaderInflate"],function(e,t,i,r,n,a){"use strict";var s=null,o=e.extend({init:function(){return null!==s?(this.loader=s.loader,this.modelLoader=s.modelLoader,this):(this.loader=new i,this.modelLoader=new r,s=this,this)},cleanAll:function(){this.loader=null,this.modelLoader=null},getApplicativeContainerNew:function(e,i,r,a){var s=this.modelLoader.buildPath(e),o=new n;t.setProxyFromSpec(s,o);var l=s.serverurl?s.serverurl:"";l+=s.filename?s.filename:"";var c,h=this,u=(c=i,function(e){h.loader.setFileBuffer(new Uint8Array(e));var t=h.loader.getApplicativeContainer(c);r(t)});o.executeGetHttpRequest(l,"arraybuffer",null,u,a)},processFTABuffer:function(e){if(!e)return null;var t=e.buffer.subarray(e.options.offset,e.options.compressed+e.options.offset);if(t.length<=2)return null;if(120!==t[0])return null;if(218!==t[1])return null;var i=t.subarray(2,e.options.compressed);return function(e){var t,i,r,n,a,s;for(t="",r=e.length,i=0;i<r;)switch((n=e[i++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(n);break;case 12:case 13:a=e[i++],t+=String.fromCharCode((31&n)<<6|63&a);break;case 14:a=e[i++],s=e[i++],t+=String.fromCharCode((15&n)<<12|(63&a)<<6|(63&s)<<0)}return t}((new a).Inflate(i))},getFTAContainer:function(e,t,i,r){var n=this;this.getApplicativeContainerNew(e,t,function(e){var t=n.processFTABuffer(e);t?i({xml:t}):i()},r)},openSceneGraph:function(e){return this.loader.openSceneGraph(e)}});return UWA.namespace("THREEDS/AnnotationServices",o)}),define("Visualization/AnnotationServices",["DS/Visualization/AnnotationServices","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/AnnotationServices"),e}),define("DS/VisuLoaders/JSONReader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/VisuLoaders/SceneGraphConverter"],function(e,t,i,r,n){"use strict";return function(i,r){var a,s,o,l,c,h,u;a=i,s=void 0!==r?r:null,o=null,l=null,c=null,u=null,this.load=function(i,r,d,p){o=null,l=null,c=null,h=null,void 0!==r&&(o=r),void 0!==p&&(l=p),h=new t,null===c&&((c=new e.JSONLoader).load(i,function(t,i){u=new n(a,new e.Mesh(t,i&&i.length?i[0]:null)),h.add(u.getRootNode()),null!==s&&s({hack:!0,updateInfinitePlane:!0}),null!==l&&l()}),o&&o(h))}}}),define("DS/Magnifier/Magnifier",["UWA/Class","UWA/Controls/Abstract","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/VisuEvents/ScreenEvent","DS/VisuEvents/EventsManager"],function(e,t,i,r,n,a,s){"use strict";return t.extend({defaultOptions:{activated:!0,viewer:null,dim:83,shiftVector:{x:-40,y:110}},init:function(e){this._parent(e),this._buildView(),this.displayed=!1,this.enableSelection=!1,this.devicePixelRatio=r.getDevicePixelRatio()||1,this.container=this.elements.container,this.content=this.elements.container.firstChild,this.setUpCBs(),this.setOption(this.options),this.viewer.divCssElement.appendChild(this.container),this.onRenderCB=null},setOption:function(e){e.viewer&&(this.viewer=e.viewer),e.dim&&this._setDimension(e.dim),e.shiftVector?this.shiftVector=e.shiftVector:this.shiftVector=new r.Vector2,e.activated?this._activate():this._desactivate()},_buildView:function(){this.elements.container=UWA.Element("div",{id:"magnify-div",html:[{tag:"canvas",id:"magnify-canvas"}],styles:{position:"absolute",display:"none","box-shadow":"-1px 2px 5px 1px rgba(0, 0, 0, 0.7)",border:"1px solid #ccc"}})},_setDimension:function(e){this.dim=e%2==0?e+1:e,this.container.setStyle("width",this.dim),this.container.setStyle("height",this.dim),this.container.setStyle("overflow","hidden"),this.container.setStyle("border-radius","50%"),this.content.setStyle("width","100%"),this.content.setStyle("height","100%"),this.content.width=this.dim*this.devicePixelRatio,this.content.height=this.dim*this.devicePixelRatio},_updateMagnifier:function(e){var t=this.viewer.devicePixelRatio;t!==this.devicePixelRatio&&(this.devicePixelRatio=t,this._setDimension(this.dim));var i={x:this.viewer.renderer.deviceWidth,y:this.viewer.renderer.deviceHeight},r={x:Math.round(this.dim*t),y:Math.round(this.dim*t)},n=Math.min(Math.max(0,e.xPix+this.shiftVector.x*t),i.x-r.x),a=Math.min(Math.max(0,e.yPix-this.shiftVector.y*t),i.y-r.y);this.container.show(),this.displayed=!0,this._renderOffscreen(this.viewer,this.viewer.currentViewpoint,this.content,i,r,e),this.container.setStyles({left:Math.round(n/t),top:Math.round(a/t)})},_renderOffscreen:function(e,t,i,r,n,a){var s={x:a.xPix-n.x/2,y:a.yPix+n.y/2},o={data:null,width:n.x,height:n.y,x:Math.round(s.x),y:Math.round(r.y-s.y)};e.renderToTarget(o,t,!0);for(var l=i.getContext("2d"),c=l.getImageData(0,0,n.x,n.y),h=c.data,u=0;u<c.height;u++)for(var d=0;d<c.width;d++){var p=this._getBufferIndex(d,u,c.width,c.height,!1),f=this._getBufferIndex(d,u,o.width,o.height,!0);h[4*p]=o.data[4*f],h[4*p+1]=o.data[4*f+1],h[4*p+2]=o.data[4*f+2],h[4*p+3]=o.data[4*f+3]}l.putImageData(c,0,0),l.drawImage(l.canvas,0,0,n.x,n.y);var m=Math.floor(n.x/2)+.5,g=Math.floor(n.y/2)+.5;l.fillStyle="rgba(0, 255, 255, 0.5)",l.fillRect(m-2,g-8,4,16),l.fillRect(m-8,g-2,16,4),l.fillStyle="rgba(0, 0, 0, 0.5)",l.fillRect(m-1.5,g-7.5,3,15),l.fillRect(m-7.5,g-1.5,15,3),l.fillStyle="rgba(255, 255, 255, 1)",l.fillRect(m-.5,g-6.5,1,13),l.fillRect(m-6.5,g-.5,13,1),this.onRenderCB&&this.onRenderCB()},_getBufferIndex:function(e,t,i,r,n){return n?(t=r-t,i*Math.floor(t-1)+Math.floor(e)):i*Math.floor(t)+Math.floor(e)},_activate:function(){this.active=!0,s.addEvent(this.viewer.canvas,"onLongHold",this.startCB)},_desactivate:function(){this.active=!1,s.removeEvent(this.viewer.canvas,"onLongHold",this.startCB)},setUpCBs:function(){var e=this;e.displayed=!1,this.startCB=function(t){e.viewer.currentViewpoint.control.isMiddleButtonPressed()||e.viewer.currentViewpoint.control.isRightButtonPressed()||(e._updateMagnifier(e.viewer.getMousePosition(t.from[0].getCurrentPosition(e.viewer.canvas))),s.addEvent(e.viewer.canvas,"onSwipe",e.moveCB),s.addEvent(e.viewer.canvas,"onRelease",e.endCB))},this.moveCB=function(t){t.from[0].deltaPosition.length()<300?e._updateMagnifier(e.viewer.getMousePosition(t.from[0].getCurrentPosition(e.viewer.canvas))):e.container.hide(),t.from[0].offsetPosition.length()>10&&(e.enableSelection=!0)},this.endCB=function(){e.container.hide(),s.removeEvent(e.viewer.canvas,"onSwipe",e.moveCB),s.removeEvent(e.viewer.canvas,"onRelease",e.endCB)}}})}),define("Magnifier/Magnifier",["DS/Magnifier/Magnifier","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Magnifier/Magnifier"),e}),define("DS/Visualization/JSONReader",["DS/VisuLoaders/JSONReader"],function(e){"use strict";return e}),define("Visualization/JSONReader",["DS/Visualization/JSONReader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/JSONReader"),e}),define("DS/VisuLoaders/ParticlesLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/Visualization/GeometryHelper","DS/Visualization/Utils","DS/Visualization/ProxyAbstraction","DS/Animation/PropertyAnimation","DS/Visualization/SceneGraphFactory"],function(e,t,i,r,n,a,s,o){"use strict";return function(t,i){var l=void 0!==i?i:null,c=[],h=null;this.load=function(t,i,u,d){var p=new a;n.setProxyFromSpec(t,p);var f=t.serverurl?t.serverurl:"";f+=t.filename?t.filename:"",p.executeGetHttpRequest(f,"text",null,function(t){var n=JSON.parse(t),a=new e.MeshBasicMaterial({side:e.FrontSide,transparent:!0,blending:e.NormalBlending,defines:{MAX_STEPS:256,TM_MIN:.05,EPS:1e-4,PI:3.14159265,HALFPI:1.57079633,ROOTTHREE:1.73205081}});a.activatePDSFX();var u={nbCol:{type:"i",value:0,stage:e.FragmentStage},map0:{type:"t2",value:null},mapDim:{type:"v3",value:new e.Vector3},uTMK:{type:"f",value:16},modelMatrixInv:{type:"m4",value:new e.Matrix4}};a.setPDSFXUniforms(u),a.setPDSFXVaryings({worldPos:{type:"v3"},objPos:{type:"v3"},camPosLocal:{type:"v3"}});var p=["#define MAX_STEPS 256","#define TM_MIN 0.05","#define EPS 0.0001","#define PI 3.14159265","#define HALFPI 1.57079633","#define ROOTTHREE 1.73205081"].join("\n"),f={ComputeVaryingValues:["void ComputeVaryingValues() {","objPos = vGetAttribPosition();","worldPos = ( modelMatrix * vec4(objPos, 1.0) ).xyz;","vec3 camPos = vGetWorldEyePos();","camPosLocal = (modelMatrixInv * vec4(camPos, 1.0)).xyz;","}"].join("\n")},m=p,g=[p,"float stepSize;","float nbTexelsX;","float nbTexelsY;","const vec3 weight = vec3(1.0, 0.04, 0.01);","vec4 sampleVolTex(vec3 pos) {","float rowID = floor(pos.z / float(nbCol));","float rowID2 = rowID;","float colID = mod(floor(pos.z), float(nbCol));","float colID2 = mod(ceil(pos.z), float(nbCol));","if (colID2 == 0.0) { rowID2 = rowID2 + 1.0; }","float x1 = colID  * mapDim.x + pos.x;","float x2 = colID2 * mapDim.x + pos.x;","float y1 = rowID  * mapDim.y + pos.y;","float y2 = rowID2 * mapDim.y + pos.y;","vec2 mapUV  = vec2(x1 / nbTexelsX, 1.0 - y1 / nbTexelsY);","vec2 mapUV2 = vec2(x2 / nbTexelsX, 1.0 - y2 / nbTexelsY);","vec4 alpha1 = texture2D(map0, mapUV);","vec4 alpha2 = texture2D(map0, mapUV2);","return mix(alpha1, alpha2, fract(pos.z));","}","vec4 raymarchNoLight(vec3 ro, vec3 rd) {","vec3 step = rd * stepSize;","vec3 pos = ro;","vec3 col = vec3(0.0);","float tm = 1.0;","for (int i=0; i<MAX_STEPS; ++i) {","vec4 rgba = sampleVolTex(pos);","float dtm = exp( -uTMK * stepSize * dot(rgba.rgb, weight) * 0.01 );","tm *= dtm;","col += (1.0 - 0.995*dtm) * rgba.rgb * rgba.rgb * tm;","pos += step;","if (tm < 0.0 || pos.x > mapDim.x - 1.0 || pos.x < 0.0 || pos.y > mapDim.y - 1.0 || pos.y < 0.0 || pos.z > mapDim.z - 1.0 || pos.z < 0.0)","break;","}","float alpha = 1.0 - tm;","return vec4(col / alpha, alpha);","}"].join("\n"),v={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","vec3 ro = objPos;","vec3 rd = normalize(ro - camPosLocal);","stepSize = max(mapDim.x, max(mapDim.y, mapDim.z)) * ROOTTHREE / float(MAX_STEPS);","nbTexelsX = float(nbCol) * mapDim.x;","nbTexelsY = float(nbCol) * mapDim.y;","ioFinalColor = raymarchNoLight(ro, rd);","}"].join("\n")};a.setPDSFXGlobalShaderCode(m,g),a.setPDSFXOverridableFunctions(f,v),a.force=!0;for(var S=n.results.length,_=new e.Vector3(1e4,1e4,1e4),y=new e.Vector3(-1e4,-1e4,-1e4),x=0;x<S;x++)for(var M=n.results[x].positions,P=0;P<M.length;P++)M[P].X<_.x&&(_.x=M[P].X),M[P].Y<_.y&&(_.y=M[P].Y),M[P].Z<_.z&&(_.z=M[P].Z),M[P].X>y.x&&(y.x=M[P].X),M[P].Y>y.y&&(y.y=M[P].Y),M[P].Z>y.z&&(y.z=M[P].Z);var C=new e.Vector3(y.x-_.x+1,y.y-_.y+1,y.z-_.z+1),b=Math.ceil(Math.sqrt(C.z));for(c=[],x=0;x<S;x++){for(c[x]=new Uint8Array(4*b*b*C.x*C.y),P=0;P<b*b*C.x*C.y;P++)c[x][4*P]=0,c[x][4*P+1]=0,c[x][4*P+2]=0,c[x][4*P+3]=0;for(M=n.results[x].positions,P=0;P<M.length;P++){var D=M[P].X-_.x,w=M[P].Y-_.y,E=M[P].Z-_.z,T=E%b,A=(Math.floor(E/b)*C.y+w)*(b*C.x)+T*C.x+D;c[x][4*A]=255*M[P].R,c[x][4*A+1]=255*M[P].G,c[x][4*A+2]=255*M[P].B,c[x][4*A+3]=Math.min(128,255*Math.pow(2*M[P].V,.8))}}(h=new e.DataTexture(c[0],b*C.x,b*C.y,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter)).generateMipmaps=!1,h.needsUpdate=!0;var I=null,R=new function(){this._nbLoops=5,this._duration=5e4,this.duration=function(){return this._duration},this.valueAt=function(e){var t=this._duration/this._nbLoops;return e%t/t}},L=new s({map:h,buffer:c,animate:function(t){var i=Math.floor(t*this.buffer.length);if(this.map.image.data=this.buffer[i],this.map.needsUpdate=!0,I){var r=new e.Matrix4;r.getInverse(I._occurrences[0].renderable.matrixWorld),a.updatePDSFXUniform("modelMatrixInv",r)}null!==l&&l()}},"animate",R);L.setLoop(1),L.start(),a.updatePDSFXUniform("nbCol",b),a.updatePDSFXUniform("map0",h),a.updatePDSFXUniform("mapDim",(new e.Vector3).copy(C));var O=(new r).CreateVis3DCuboid({cornerPoint:new e.Vector3,firstAxis:new e.Vector3(C.x-1,0,0),secondAxis:new e.Vector3(0,C.y-1,0),thirdAxis:new e.Vector3(0,0,C.z-1)});I=o.createMeshNode(O);var N=(new e.Matrix4).makeTranslation(_.x,_.y,_.z);return I.setSSAO(!1),I.setMatrix(N),I.setMaterial(a),i&&i(I),void(d&&d())})}}}),define("DS/SceneGraphNodes/CSS2DNodeManager",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/SceneGraphNodes/CSS2DNode"],function(e,t,i,r,n){"use strict";return e.extend({options:{},init:function(e){this.billboards=[],this._divLayers=[],this.mainLayer=document.createElement("div"),this.mainLayer.id="HTMLBillboards",e.divCss2DElement.appendChild(this.mainLayer),this.viewer=e,this.rank=4,this._subscribe(),this.update()},add:function(e,t){if(!(e instanceof n))return error.log("This is not a CSS2DNode");e.rank=t&&t.rank||0,e.vanish=t&&t.vanish||!1,this.billboards.push(e),this._divLayers[e.rank]||(this._divLayers[e.rank]=document.createElement("div"),this._divLayers[e.rank].id="layer-"+e.rank,this.mainLayer.appendChild(this._divLayers[e.rank])),this._divLayers[e.rank].appendChild(e.css2DNode.element),this.update()},remove:function(e){-1!==this.billboards.indexOf(e)&&this.billboards.splice(this.billboards.indexOf(e),1)},update:function(){this.cameraPosition=this.viewer.viewpoints[0].camera.position;var e=this.viewer.getSceneBoundingSphere();this.centerScene=e.center,this.fadingDistance=e.radius;var t=0,i=this.billboards.length;for(t=0;t<i;++t)this._follow3D(this.billboards[t]);this._zIndexManager()},_subscribe:function(){var e=this;t.subscribe({event:"/VISU/"},function(t){"@onViewpointChange"===t.eventType&&e.update.call(e)}),t.subscribe({event:"/VISU/onWindowResized"},function(t){e.update.call(e)})},_follow3D:function(e){if(e.css2DNode.visible){if(e.css2DNode.element.style.display="initial",e.rank>this.rank)return void(e.css2DNode.element.style.display="none");if(e.vanish){var t=1-(e.css2DNode.position.clone().distanceTo(this.cameraPosition)-5*this.fadingDistance)/(15*this.fadingDistance-5*this.fadingDistance);t<0?e.css2DNode.element.style.display="none":t<1&&(e.css2DNode.element.style.opacity=t)}}},_zIndexManager:function(){var e=this.cameraPosition;this.billboards.sort(function(t,i){return e.distanceTo(i.css2DNode.position)-e.distanceTo(t.css2DNode.position)});var t=0,i=this.billboards.length;for(t=0;t<i;++t)this.billboards[t].css2DNode.element.style["z-index"]=t}})}),define("SceneGraphNodes/CSS2DNodeManager",["DS/SceneGraphNodes/CSS2DNodeManager","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/CSS2DNodeManager"),e}),define("DS/Visualization/ParticlesLoader",["DS/VisuLoaders/ParticlesLoader"],function(e){"use strict";return e}),define("Visualization/ParticlesLoader",["DS/Visualization/ParticlesLoader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/ParticlesLoader"),e}),define("DS/VisuLoaders/XMLV6Loader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager"],function(e,t,i,r,n){"use strict";return function(a,s,o,l){var c,h,u,d=void 0!==s?s:null,p=null,f=null,m=null,g=null,v=0,S=0,_=0,y=[],x=[],M=[],P=[],C=[],b=[],D=[],w=[],E=null,T=[],A=l;function I(e){e<C.length?function(e){var t=c+"/"+C[e];if(document.implementation&&document.implementation.createDocument){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState&&(0===i.status||200===i.status))if(i.responseXML){var r=i.responseXML.firstChild;if(r&&r.childNodes){for(var n=0;n<r.childNodes.length;){if("Links"===r.childNodes[n].nodeName){r=r.childNodes[n];break}n++}if(r&&r.childNodes)for(var n=0;n<r.childNodes.length;n++){var a=r.childNodes[n];if("Link"===a.nodeName){var s=a.getAttribute("Source"),o=a.getAttribute("Target"),l=a.getAttribute("id");b[l]={source:s,target:o}}}}I(e+1)}else console.error("XMLV6Loader: Empty or non-existing file ("+t+")")},i.open("GET",t,!0),i.overrideMimeType&&i.overrideMimeType("text/xml"),i.send(null)}else alert("Don't know how to parse XML!")}(e):R(0)}function R(a){a<D.length?function(e){var t=c+"/"+D[e];if(document.implementation&&document.implementation.createDocument){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState&&(0===i.status||200===i.status))if(i.responseXML){var r=i.responseXML.firstChild;if(r&&r.childNodes){for(var a=0;a<r.childNodes.length;){if("AppliedAppearanceGroup"===r.childNodes[a].nodeName){r=r.childNodes[a];break}a++}if(r&&r.childNodes)for(var s=new n,a=0;a<r.childNodes.length;a++){var o=r.childNodes[a];if("AppliedAppearance"===o.nodeName){var l=o.getAttribute("id"),h=L(o);w[l]=s.createMaterial(h,c+"/resources","XMLV6")}}}R(e+1)}else console.error("XMLV6Loader: Empty or non-existing file ("+t+")")},i.open("GET",t,!0),i.overrideMimeType&&i.overrideMimeType("text/xml"),i.send(null)}else alert("Don't know how to parse XML!")}(a):function(){if(h=c+"/"+h,document.implementation&&document.implementation.createDocument){var a=new XMLHttpRequest;a.onreadystatechange=function(){if(4===a.readyState&&(0===a.status||200===a.status)){if(a.responseXML){var s=a.responseXML.firstChild;if(s&&s.childNodes){for(var o=0;o<s.childNodes.length;o++){var l=s.childNodes[o];if("Product"===l.nodeName||"ProductInst"===l.nodeName||"RepUsage"===l.nodeName){var y=l.getAttribute("id"),C=new i;switch(C.name=y,C.getPersistentId=function(){return this.name},l.nodeName){case"Product":T[y]=C,null===E&&(E=C);break;case"ProductInst":T[y]=C;for(var D="",I="",R=null,L=0;L<l.childNodes.length;L++){var O=l.childNodes[L];if("Owned"===O.nodeName)D=O.getAttribute("idref");else if("Instancing"===O.nodeName)I=O.getAttribute("idref");else if("RelativeTransformation3D"===O.nodeName)for(var V=0;V<O.childNodes.length;V++){var U=O.childNodes[V];if("Translation3D"===U.nodeName){var B=N(U.textContent);3===B.length&&(null===R&&(R=new e.Matrix4),R.setPosition(new e.Vector3(1e3*B[0],1e3*B[1],1e3*B[2])))}else if("Rotation3D"===U.nodeName){var B=N(U.textContent);if(9===B.length){null===R&&(R=new e.Matrix4);var k=[B[0],B[3],B[6],B[1],B[4],B[7],B[2],B[5],B[8]];R.setRotation(k)}}}}null!==R&&C.setMatrix(R),""!==D&&""!==I&&(T[D].addChild(C),C.addChild(T[I]));break;case"RepUsage":T[y]=C;for(var D="",I="",G={},L=0;L<l.childNodes.length;L++){var O=l.childNodes[L];if("Owned"===O.nodeName)D=O.getAttribute("idref");else if("Instancing"===O.nodeName)I=O.getAttribute("linkidref");else if("BoundingBox"===O.nodeName)for(var V=0;V<O.childNodes.length;V++){var z=O.childNodes[V];"MinPoint"===z.nodeName?G.min=N(z.textContent):"MaxPoint"===z.nodeName&&(G.max=N(z.textContent))}}if(""!==D&&""!==I){T[D].addChild(C);var H=b[I].target;x[H]=C,void 0!==G.min?M[C.name]=H:P.push(H),S++,_++}if(void 0!==G.min&&void 0!==G.max){var W=F(G);C.addChild(W)}}}}null!==E&&u.addChild(E)}}else console.error("XMLV6Loader: Empty or non-existing file ("+h+")");!function(){null!==g&&(g.terminate(),g=null),null===g&&((g="3dxmlgeometry"===A?new Worker(t.getWebappsBaseUrl()+"Workers/XMLV6Worker.js"):new Worker(t.getWebappsBaseUrl()+"Workers/CGRWorker.js")).onmessage=function(t){var i=t.data,a=x[i.node];if(v--,S--,a){var s=null;s=i.rep.length>0?function(t){for(var i=null,a=[],s=null,o=null,l=new e.Sphere,c=new e.Box3,h=new n,u=0;u<t.length;u++){var d=t[u],p=new e.BufferGeometryDS,f=new e.Vector3(d.AABB.min[0],d.AABB.min[1],d.AABB.min[2]),m=new e.Vector3(d.AABB.max[0],d.AABB.max[1],d.AABB.max[2]);null===s&&(s=f),null===o&&(o=m),f.x<s.x&&(s.x=f.x),f.y<s.y&&(s.y=f.y),f.z<s.z&&(s.z=f.z),m.x>o.x&&(o.x=m.x),m.y>o.y&&(o.y=m.y),m.z>o.z&&(o.z=m.z),c.set(s,o),l.radius=o.clone().sub(s).multiplyScalar(.5).length(),l.center=o.clone().add(s).multiplyScalar(.5);for(var g=0;g<d.drawingGroups.length;g++){d.drawingGroups[g].geometry=p;var v=d.drawingGroups[g].gas,S=d.drawingGroups[g].material;if(null!==S&&(S=S.id),null!==S&&b[S]){var _=b[S].target,y=[];y=_.split("#"),d.drawingGroups[g].gas=w[y[1]]}else if(null!==v){var x=new e.Color;x.setRGB(v.color.r,v.color.g,v.color.b),d.drawingGroups[g].gas=h.getMaterialFromGAS({color:x,opacity:v.opacity,lineWidth:v.lineWidth?v.lineWidth:v.linewidth,solid:v.solid})}}p.drawingGroups=d.drawingGroups,p.vertexPositionArray=d.vertexPositionArray,null!==d.vertexNormalArray&&(p.vertexNormalArray=d.vertexNormalArray),null!==d.vertexUvArray&&(p.vertexUvArray=d.vertexUvArray),p.vertexIndexArray=d.vertexIndexArray,a.push(p)}var M=new e.Color;M.setRGB(t[0].gas.fill.color.r,t[0].gas.fill.color.g,t[0].gas.fill.color.b);var P=new e.Color;return P.setRGB(t[0].gas.line.color.r,t[0].gas.line.color.g,t[0].gas.line.color.b),(S=h.getMaterialFromGAS({color:M,opacity:t[0].gas.fill.opacity,solid:t[0].gas.fill.solid})).line=h.getMaterialFromGAS({color:P,opacity:t[0].gas.line.opacity,lineWidth:t[0].gas.line.lineWidth?t[0].gas.line.lineWidth:t[0].gas.line.linewidth}),a.boundingSphere=l,a.boundingBox=c,(i=new e.Mesh(a,S)).matrixAutoUpdate=!1,i.castShadow=!0,i.receiveShadow=!0,new r(i)}(i.rep):function(){var t=new e.BufferGeometryDS;t.boundingSphere=new e.Sphere,t.boundingBox=new e.Box3;var i=e.MaterialUtils.createShinyFaceMaterial(),n=new e.Mesh(t,i);return n.matrixAutoUpdate=!1,n.castShadow=!0,n.receiveShadow=!0,new r(n)}(),a.removeChild(a.getChildByName("BBox")),a.addChild(s),a.setVisibility(!0)}null!==m&&m({loaded:_-S,total:_}),null!==d&&d({hack:!0,updateInfinitePlane:!0}),S||null===f||f()}),v+=P.length;for(var i=0;i<P.length;i++){var a=P[i];if(void 0!==a){var s=c+"/3dxmlcontent/"+a;""!==a&&g&&g.postMessage({path:s,node:a})}}p&&p(u)}()}},a.open("GET",h,!0),a.overrideMimeType&&a.overrideMimeType("text/xml"),a.send(null)}else alert("Don't know how to parse XML!")}()}function L(e){for(var t={},i=null,r=0;r<e.childNodes.length;r++)if("ShadingModel"===e.childNodes[r].nodeName){i=e.childNodes[r];break}if(i)for(r=0;r<i.childNodes.length;r++){var n=i.childNodes[r];switch(n.nodeName){case"IlluminationModel":"PHONG"===n.textContent&&(t.shading="Phong");break;case"DiffuseColor":t.colorDiffuse=O(n.textContent);break;case"SpecularColor":t.colorSpecular=O(n.textContent);break;case"AmbientColor":t.colorAmbient=O(n.textContent);break;case"SpecularCoefficient":t.specularCoef=parseFloat(n.textContent);break;case"SpecularExponent":t.shininess=128*parseFloat(n.textContent);break;case"ReflectivityCoefficient":t.reflectivityCoef=parseFloat(n.textContent);break;case"TransparencyCoefficient":t.transparency=parseFloat(n.textContent),t.transparent=t.transparency>0;break;case"DiffuseMap":case"ReflectionMap":var a=-1,s=-1,o=-1,l=-1,c=1,h=1;t[n.nodeName+"Wrap"]=[];for(var u=0;u<n.childNodes.length;u++){var d=n.childNodes[u];switch(d.nodeName){case"WrappingU":a="REPEAT"===d.textContent?1:0;break;case"WrappingV":s="REPEAT"===d.textContent?1:0;break;case"FlipU":o="true"===d.textContent?1:-1;break;case"FlipV":l="true"===d.textContent?1:-1;break;case"ScaleU":c=parseFloat(d.textContent);break;case"ScaleV":h=parseFloat(d.textContent);break;case"MapFile":t[n.nodeName]=b[d.textContent].target}}(a>=0||s>=0)&&(1===a&&(t[n.nodeName+"Wrap"][0]="repeat"),1===s&&(t[n.nodeName+"Wrap"][1]="repeat"),t[n.nodeName+"Repeat"]=[a,s],1!==c&&(t[n.nodeName+"Repeat"][0]=c),1!==h&&(t[n.nodeName+"Repeat"][1]=h)),1===o&&(t[n.nodeName+"Wrap"][0]="mirror"),1===l&&(t[n.nodeName+"Wrap"][1]="mirror")}}return t}function O(e){var t=[],i=new RegExp(/RGB\(\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*\)/i),r=i.exec(e);return null!==r?(t[0]=parseFloat(RegExp.$1),t[1]=parseFloat(RegExp.$2),t[2]=parseFloat(RegExp.$3)):null!==(r=(i=new RegExp(/RGBA\(\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*,\s*([0,1]|(?:[0,1]?\.[0-9]+))\s*\)/i)).exec(e))&&(t[0]=parseFloat(RegExp.$1),t[1]=parseFloat(RegExp.$2),t[2]=parseFloat(RegExp.$3),t[3]=parseFloat(RegExp.$4)),t}function N(e){for(var t=function(e){return e.length>0?function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}(e).split(/\s+/):[]}(e),i=[],r=0,n=t.length;r<n;r++)i.push(parseFloat(t[r]));return i}function F(t){for(var i=new e.BufferGeometryDS,a=new Float32Array(72),s=new Float32Array(72),o=new Uint16Array(36),l=0,c=0,h=0,u=0;u<6;u++)o[c++]=h,o[c++]=h+1,o[c++]=h+2,o[c++]=h,o[c++]=h+2,o[c++]=h+3,h+=4;for(var d=0;d<12;d+=3)s[l+d]=0,s[l+d+1]=-1,s[l+d+2]=0;for(a[l++]=t.min[0],a[l++]=t.min[1],a[l++]=t.min[2],a[l++]=t.max[0],a[l++]=t.min[1],a[l++]=t.min[2],a[l++]=t.max[0],a[l++]=t.min[1],a[l++]=t.max[2],a[l++]=t.min[0],a[l++]=t.min[1],a[l++]=t.max[2],d=0;d<12;d+=3)s[l+d]=0,s[l+d+1]=1,s[l+d+2]=0;for(a[l++]=t.min[0],a[l++]=t.max[1],a[l++]=t.min[2],a[l++]=t.min[0],a[l++]=t.max[1],a[l++]=t.max[2],a[l++]=t.max[0],a[l++]=t.max[1],a[l++]=t.max[2],a[l++]=t.max[0],a[l++]=t.max[1],a[l++]=t.min[2],d=0;d<12;d+=3)s[l+d]=0,s[l+d+1]=0,s[l+d+2]=1;for(a[l++]=t.max[0],a[l++]=t.max[1],a[l++]=t.max[2],a[l++]=t.min[0],a[l++]=t.max[1],a[l++]=t.max[2],a[l++]=t.min[0],a[l++]=t.min[1],a[l++]=t.max[2],a[l++]=t.max[0],a[l++]=t.min[1],a[l++]=t.max[2],d=0;d<12;d+=3)s[l+d]=0,s[l+d+1]=0,s[l+d+2]=-1;for(a[l++]=t.min[0],a[l++]=t.min[1],a[l++]=t.min[2],a[l++]=t.min[0],a[l++]=t.max[1],a[l++]=t.min[2],a[l++]=t.max[0],a[l++]=t.max[1],a[l++]=t.min[2],a[l++]=t.max[0],a[l++]=t.min[1],a[l++]=t.min[2],d=0;d<12;d+=3)s[l+d]=1,s[l+d+1]=0,s[l+d+2]=0;for(a[l++]=t.max[0],a[l++]=t.min[1],a[l++]=t.min[2],a[l++]=t.max[0],a[l++]=t.max[1],a[l++]=t.min[2],a[l++]=t.max[0],a[l++]=t.max[1],a[l++]=t.max[2],a[l++]=t.max[0],a[l++]=t.min[1],a[l++]=t.max[2],d=0;d<12;d+=3)s[l+d]=-1,s[l+d+1]=0,s[l+d+2]=0;a[l++]=t.min[0],a[l++]=t.min[1],a[l++]=t.max[2],a[l++]=t.min[0],a[l++]=t.max[1],a[l++]=t.max[2],a[l++]=t.min[0],a[l++]=t.max[1],a[l++]=t.min[2],a[l++]=t.min[0],a[l++]=t.min[1],a[l++]=t.min[2];var p=(new n).getMaterialFromGAS({color:new e.Color(16729156),opacity:0});i.drawingGroups=[],i.drawingGroups.push({start:0,count:36,glType:4,gas:p});var f=new e.Vector3(t.min[0],t.min[1],t.min[2]),m=new e.Vector3(t.max[0],t.max[1],t.max[2]),g=m.clone().sub(f).multiplyScalar(.5).length(),v=m.clone().add(f).multiplyScalar(.5);i.boundingSphere=new e.Sphere(v,g),i.boundingBox=new e.Box3(f,m),i.vertexPositionArray=a,i.vertexNormalArray=s,i.vertexIndexArray=o;var S=new e.Mesh(i,p);return S.matrixAutoUpdate=!1,new r(S,"BBox")}this.setGeometryMode=function(e){A=e},this.load=function(e,t,r,n){p=null,f=null,m=null,c="",v=0,S=0,_=0,y=[],x=[],M=[],P=[],C=[],b=[],D=[],w=[],h="",E=null,T=[],u=null,c=e;var a=e+"/Manifest.3dxml";if(document.implementation&&document.implementation.createDocument){var s=new XMLHttpRequest;s.onreadystatechange=function(){4===s.readyState&&(0!==s.status&&200!==s.status||(s.responseXML?(p=t,f=n,m=r,function(e){var t=e.firstChild;if(t&&t.childNodes)for(var r=0;r<t.childNodes.length;r++){var n=t.childNodes[r];switch(n.nodeName){case"XMLContent":var a=n.getAttribute("Domain"),s=n.getAttribute("Location"),o=n.getAttribute("Name");"Geometry"===a?y.push({path:s,filename:o}):"Material"===a?D.push(s+"/"+o):"Link"===a?C.push(s+"/"+o):"Product3D"===a&&"Product.3dxmlproduct3d"===o&&(h=s+"/"+o)}}u=new i,C.length&&I(0)}(s.responseXML)):console.error("XMLV6Loader: Empty or non-existing file ("+a+")")))},s.open("GET",a,!0),s.overrideMimeType&&s.overrideMimeType("text/xml"),s.send(null)}else alert("Don't know how to parse XML!")},this.loadGeometryFiles=function(e){var t=Math.min(e.length,1);v+=t;for(var i=0;i<t;i++){var r=M[e[i].name];if(void 0!==r){var n=c+"/3dxmlcontent/"+r;""!==r&&g&&g.postMessage({path:n,node:r}),delete M[e[i].name]}}},this.isWebWorkerBusy=function(){return v>0}}}),define("DS/SceneGraphNodes/IESLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var r=new e.IESLight(t.color,t.intensity,t.distance,t.texture);return this._texture=t.texture,this._parent(r,i),this},setIESTexture:function(e){this._texture=e,this._updateTexture()},_updateTexture:function(){var e;this.light3js.iesTexture=this._texture,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.iesTexture=this._texture},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"IESLightNode3D"}});return UWA.namespace("THREEDS/Nodes/IESLight",i)}),define("SceneGraphNodes/IESLightNode",["DS/SceneGraphNodes/IESLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/IESLightNode"),e}),define("DS/SceneGraphNodes/TubeLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var r=new e.TubeLight(t.color,t.intensity,t.radius,t.width,t.mode);return this._radius=r.radius,this._width=r.width,this._parent(r,i),this},setRadius:function(e){e&&(this._radius=e),this._updateRadius()},_updateRadius:function(){var e;this.light3js.radius=this._radius,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.radius=this._radius},setWidth:function(e){e&&(this._width=e),this._updateWidth()},_updateWidth:function(){var e;this.light3js.width=this._width,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.width=this._width},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"TubeLightNode3D"}});return UWA.namespace("THREEDS/Nodes/TubeLight",i)}),define("SceneGraphNodes/TubeLightNode",["DS/SceneGraphNodes/TubeLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/TubeLightNode"),e}),define("DS/SceneGraphNodes/CurvedPipeBatchDummyNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/SceneGraphNodes/InstancedCurvedPipeManager"],function(e,t,i,r){"use strict";var n=t.extend({init:function(t){this._name=t.name||"curvedPipeBatchDummy",this._pipes=[],this._maxRadius=0,this.dummyGeom=new e.BufferGeometryDS;for(var n=0,a=new Map,s=0;s<t.curvedPipes.length;s++){var o=t.curvedPipes[s],l=!!o.material,c=o.gas.id;l&&(c+="_"+o.material.id);var h=a.get(c);if(void 0===h){h=n,a.set(c,n++);var u=new i.DrawingGroup(o.gas,l?o.material:null,4);this.dummyGeom.drawingGroups.push(u)}this._pipes.push({curvePoints:o.curvePoints,radius:o.radius,baseNormal:o.baseNormal.normalize(),endNormal:o.endNormal.normalize(),baseSideVector:o.baseSideVector.normalize(),material:l?o.material:null,gas:o.gas,dgId:h}),o.radius>this._maxRadius&&(this._maxRadius=o.radius)}var d=new e.CurvedPipeMesh(this.dummyGeom);d.castShadow=!0,d._capWorldRadius=this._maxRadius,d._nbLODsMinusOne=r._nbLODs-1,this._parent(d);var p=this._curvedPipeBBox();return this.forceBoundingBox(p),this},createRenderable:function(){var e=this._parent();return e.isCurvedPipe=!0,e},setMaterial:function(e,t){this._parent(t);for(var i=this._occurrences.length,r=0;r<i;r++)this._occurrences[r].renderable.material=t},setMatrix:function(e){this._parent(e);for(var t=this._occurrences.length,i=null,n=0;n<t;n++)i=this._occurrences[n].renderable,r.setMatrixOnCurvedPipe(i),i._capWorldRadius=this._maxRadius*i.matrixWorld.getMaxScaleOnAxis()},_curvedPipeBBox:function(){for(var t=new e.Vector3(1/0,1/0,1/0),i=new e.Vector3(-1/0,-1/0,-1/0),r=new e.Vector3,n=new e.Vector3,a=new e.Vector3,s=new e.Vector3,o=new e.Vector3,l=new e.Vector3,c=new e.Vector3,h=new e.Vector3,u=null,d=0;d<this._pipes.length;d++)for(var p=this._pipes[d].curvePoints,f=this._pipes[d].radius,m=p.length/3-1,g=0;g<m;g++){n.set(p[3*g],p[3*g+1],p[3*g+2]),a.set(p[3*g+3],p[3*g+4],p[3*g+5]),r.subVectors(a,n);var v=r.dot(r);s.set(f*Math.sqrt(1-r.x*r.x/v),f*Math.sqrt(1-r.y*r.y/v),f*Math.sqrt(1-r.z*r.z/v)),o.subVectors(n,s),c.subVectors(a,s),o.min(c),l.addVectors(n,s),h.addVectors(a,s),l.max(h),u=new e.Box3(o,l),t.min(u.min),i.max(u.max)}var S=(new e.Vector3).addVectors(t,i).multiplyScalar(.5),_=(new e.Vector3).addVectors(S,(new e.Vector3).subVectors(t,S).multiplyScalar(1.05)),y=(new e.Vector3).addVectors(S,(new e.Vector3).subVectors(i,S).multiplyScalar(1.05));return new e.Box3(_,y)},_onLinkedToSceneGraph:function(){this._parent();for(var e=this._occurrences,t=e.length,i=null,n=0;n<t;n++){i=e[n].renderable;for(var a=0;a<this._pipes.length;a++){var s=this._pipes[a];r.addCurvedPipe(i,s.dgId,s.radius,s.curvePoints,s.baseNormal,s.endNormal,s.baseSideVector)}}},_onUnlinkedToSceneGraph:function(){this._parent();for(var e=this._occurrences,t=e.length,i=null,n=0;n<t;n++)i=e[n].renderable,r.removeCurvedPipe(i,this)},setName:function(e){this._name=e},getNodeType:function(){return"Mesh3D"}});return UWA.namespace("THREEDS/Nodes/CurvedPipeBatchDummyNode",n)}),define("DS/VisuUnstreamers/XMLMeshUnstreamTask",["UWA/Class","WebappsUtils/WebappsUtils","UWA/Utils","DS/Visualization/Utils","DS/VisuUnstreamers/UnstreamTaskDriver","DS/VisuUnstreamers/FileInZipStreamObject","DS/Mesh/MeshUtils","DS/Visualization/MaterialManager","DS/Visualization/Mesh3D"],function(e,t,i,r,n,a,s){"use strict";var o=null,l=!1,c=0,h=[],u=[],d=!1,p=e.extend({init:function(e,t){return this.streamObject=e,this.targetNode=t,this.contextID=c++,h[this.contextID]={so:this.streamObject,target:this.targetNode},this},run:function(e,c,p){h[this.contextID].cbSuccess=c,h[this.contextID].cbError=p,h[this.contextID].cbProgress=e,h[this.contextID].nbMaterials=0,h[this.contextID].remainingMaterials=0,h[this.contextID].modelLoaded=!1,console.log("running XMLMeshUnstreamTask");var f=this;if(this.targetNode){if(u[this.contextID]={launched:!1},null!==o||d)l&&this.internalLoad();else{d=!0;var m=i.matchUrl(t.getWebappsBaseUrl(),window.location)?null:"Passport",g=[{provider:"FILE",filename:"AmdLoader.js",serverurl:t.getWebappsBaseUrl()+"AmdLoader/",requiredAuth:m},{provider:"FILE",filename:"EasySax.js",serverurl:t.getWebappsBaseUrl()+"EasySax/",requiredAuth:m},{provider:"FILE",filename:"ThreeJS_Base.js",serverurl:t.getWebappsBaseUrl()+"Mesh/",requiredAuth:m},{provider:"FILE",filename:"Mesh.js",serverurl:t.getWebappsBaseUrl()+"Mesh/",requiredAuth:m},{provider:"FILE",filename:"XMLV43Worker.js",serverurl:t.getWebappsBaseUrl()+"Workers/",requiredAuth:m}];r.getWorkerFromSpecs(g,function(e){(o=e).onmessage=function(e){var t=e.data;if(t.loaded)l||(l=!0,f.internalLoad());else{var i=t.contextID,r=null;if(t.rep.length>0){for(var o=[],c=0;c<t.rep.length;c++)for(var d=t.rep[c],p=0;p<d.drawingGroups.length;p++){var m=d.drawingGroups[p].material;null!==m&&""!==m.file&&o.push({dg:d.drawingGroups[p],name:m.file})}h[i].nbMaterials=o.length,h[i].remainingMaterials=o.length;for(c=0;c<o.length;c++){var g=o[c],v=new a(h[i].so.blob,g.name);n.getTask("XMLMaterial",v,null,function(e){return function(t){t.materialRefId=e.material.id,t.run(null,function(t){e.material=t;var n=h[i];n.remainingMaterials--,n.cbProgress&&n.cbProgress({material:t,loaded:n.nbMaterials-n.remainingMaterials,total:n.nbMaterials}),!n.remainingMaterials&&n.modelLoaded&&n.cbSuccess&&n.cbSuccess(r,!0)})}}(g.dg))}r=s.convertTo3js(t.rep)}else r=s.createEmptyMesh();h[i].target.add(r),h[i].so.close(),h[i].cbSuccess&&(h[i].modelLoaded=!0),delete u[i],f.internalLoad()}}})}}else console.error("XMLMeshUnstreamTask execution failed : target node undefined !")},internalLoad:function(){for(var e in u)!1===u[e].launched&&(u[e].launched=!0,this.workerLoaded(e))},workerLoaded:function(e){var t=h[e].so;t.open(),t.readAsText(function(t){o.postMessage({path:t,contextID:e})})}});return UWA.namespace("THREEDS/XMLMeshUnstreamTask",p)}),define("VisuUnstreamers/XMLMeshUnstreamTask",["DS/VisuUnstreamers/XMLMeshUnstreamTask","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuUnstreamers/XMLMeshUnstreamTask"),e}),define("DS/Visualization/LensFlareNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){this._parent(i),this.lensflare3js=void 0!==t?t:new e.ParticleSystem,t=this.createRenderable();var r=this._occurrences[0];return r.renderable=t,r.renderable.name=this.name,r.renderable._occurrence=r,this},createRenderable:function(){var e=this.lensflare3js.clone();return e.matrixAutoUpdate=!1,e.matrixWorldNeedsUpdate=!1,e.visible=this.lensflare3js.visible,e.pickable=!1,e.noPickThrough=!1,e.enableNormalDepth=!1,e},add:function(){return!1},getNodeType:function(){return"LensFlareNode3D"}});return UWA.namespace("THREEDS/Nodes/LensFlare",i)}),define("Visualization/LensFlareNode3D",["DS/Visualization/LensFlareNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/LensFlareNode3D"),e}),define("DS/AdvancedSceneGraphNodes/InstancedSphereImpostorsNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils"],function(e,t,i,r){"use strict";var n=t.extend({init:function(t){this._isIE11=null!=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),this._name=t.name||"sphereImpostors",this._parent(this._name);var r=t.material?t.material:e.MaterialUtils.createShinyFaceMaterial({force:!0});r.transparent=!0;var n=this._createMaterial(r),a=t.nbInstances||1,s=null;s=this._isIE11?this._createCoarseImpostor(8,n):this._createFlatImpostor(6,n);for(var o=new i(s,""),l=t.positions,c=t.radii,h=t.colors,u=new e.Vector3(1/0,1/0,1/0),d=new e.Vector3(-1/0,-1/0,-1/0),p=new Float32Array(4*a),f=new Float32Array(2*a),m=0;m<a;m++)p[4*m]=l[3*m],p[4*m+1]=l[3*m+1],p[4*m+2]=l[3*m+2],p[4*m+3]=c[m],f[2*m]=Math.floor(255*h[4*m])+256*Math.floor(255*h[4*m+1])+65536*Math.floor(255*h[4*m+2]),f[2*m+1]=h[4*m+3],u.x=Math.min(u.x,l[3*m]-c[m]),u.y=Math.min(u.y,l[3*m+1]-c[m]),u.z=Math.min(u.z,l[3*m+2]-c[m]),d.x=Math.max(d.x,l[3*m]+c[m]),d.y=Math.max(d.y,l[3*m+1]+c[m]),d.z=Math.max(d.z,l[3*m+2]+c[m]);var g=(new e.Vector3).addVectors(u,d).multiplyScalar(.5),v=(new e.Vector3).addVectors(g,(new e.Vector3).subVectors(u,g).multiplyScalar(1.05)),S=(new e.Vector3).addVectors(g,(new e.Vector3).subVectors(d,g).multiplyScalar(1.05)),_=new e.Box3(v,S),y={data:p,type:"v4",isFlattened:!0,attribName:"instancePositionAndRadius"},x={data:f,type:"v2",isFlattened:!0,attribName:"instanceColor"};return o.setMaterial(n),o.setInstancingParameters(a,[y,x],"instance"),o.forceBoundingBox(_),this.addChild(o),this},_createFlatImpostor:function(t,i){var n=[],a=new e.BufferGeometryDS;a.drawingGroups=[];var s=3*t,o=new r.DrawingGroup(i,i,4,0,s);o.geometry=a,a.drawingGroups.push(o);var l,c=new Float32Array(3*(t+1)),h=0;c[h++]=0,c[h++]=0,c[h++]=0;for(var u=0;u<t;u++)l=u/t,c[h++]=Math.cos(2*l*Math.PI),c[h++]=Math.sin(2*l*Math.PI),c[h++]=0;a.vertexPositionArray=c;var d=new Uint16Array(s),p=0;for(u=0;u<t;u++)d[p++]=0,d[p++]=u+1,d[p++]=u+2>6?(u+2)%t:u+2;a.vertexIndexArray=d,n.push(a);var f=new e.Mesh(n,i);return f.matrixAutoUpdate=!1,f},_createCoarseImpostor:function(t,i){var n=[],a=new e.BufferGeometryDS;a.drawingGroups=[];var s=6*t*(t-1),o=new r.DrawingGroup(i,i,4,0,s);o.geometry=a,a.drawingGroups.push(o);var l=2+(t-1)*t,c=new Float32Array(3*l),h=0,u=0;c[h++]=0,c[h++]=0,c[h++]=-1;for(var d=0,p=0,f=0;f<t;f++)for(var m=-t/2+1;m<=t/2-1;m++)u=m/t,d=2*(f/t)*Math.PI,p=u*Math.PI,c[h++]=Math.cos(d)*Math.cos(p),c[h++]=Math.sin(d)*Math.cos(p),c[h++]=Math.sin(p);c[h++]=0,c[h++]=0,c[h++]=1,a.vertexPositionArray=c;var g=new Uint16Array(s);h=0;var v=0;for(f=0;f<t;f++){v=f===t-1?l-2:l-1,g[h++]=0,g[h++]=((f+1)*(t-1)+1)%v,g[h++]=f*(t-1)+1;for(m=1;m<t-1;m++)g[h++]=((f+1)*(t-1)+m)%v,g[h++]=f*(t-1)+m+1,g[h++]=f*(t-1)+m,g[h++]=((f+1)*(t-1)+m)%v,g[h++]=((f+1)*(t-1)+m+1)%v,g[h++]=f*(t-1)+m+1;g[h++]=((f+1)*(t-1)+t-1)%v,g[h++]=l-1,g[h++]=f*(t-1)+t-1}a.vertexIndexArray=g,n.push(a);var S=new e.Mesh(n,i);return S.matrixAutoUpdate=!1,S},_createMaterial:function(e){var t=e;t.activatePDSFX(),t.setPDSFXVaryings({viewCenterPos:{type:"v3"},radius:{type:"f"},radius2:{type:"f"},vaColor:{type:"v4"},rightAndLeft:{type:"v2"}}),t.setPDSFXGlobalShaderCode(["float _radius;","float _radius2;","vec4 instancePosition;"].join("\n"),["vec3 newViewPosition;","bool toDiscard;","bool isPerspective;","vec2 viewport;","vec3 intersectionWithSpherePERSP(in vec3 ray) {","vec3 cameraToCenter = viewCenterPos;","float adjacentInTriangle = dot(cameraToCenter, ray);","float distRayToCenter2 = dot(cameraToCenter, cameraToCenter) - adjacentInTriangle * adjacentInTriangle;","if (distRayToCenter2 > (radius*radius)) {","toDiscard = true;","return vec3(0.0,0.0,0.0);","}","float projToIntersection = sqrt(radius*radius - distRayToCenter2);","float cameraToIntersection = adjacentInTriangle - projToIntersection;","return cameraToIntersection * ray;","}","vec3 intersectionWithSphereORTHO(in vec3 ray) {","vec3 viewRayBase = vec3((2.0*(gl_FragCoord.xy/viewport.xy) - 1.0)*rightAndLeft.xy, 0.0);","vec2 projToCenter = viewCenterPos.xy - viewRayBase.xy;","float distRayToCenter2 = dot(projToCenter,projToCenter);","if (distRayToCenter2 > radius2) {","toDiscard = true;","return vec3(0.0,0.0,0.0);","}","float projToIntersection = sqrt(radius2 - distRayToCenter2);","vec3 projRayOnImpostor = vec3(viewRayBase.xy, viewCenterPos.z);","return projRayOnImpostor - projToIntersection*ray;","}"].join("\n"));var i={ComputeCommonValues:["void ComputeCommonValues() {","_radius = instancePositionAndRadius.w;","_radius2 = _radius * _radius;","instancePosition = vec4(instancePositionAndRadius.xyz, 0.0);","}"].join("\n"),ComputeVaryingValues:["void ComputeVaryingValues() {","radius = _radius;","radius2 = _radius2;","vec4 color;","color.a = instanceColor.y;","color.b = floor(instanceColor.x / 65536.0);","float tmp = instanceColor.x - color.b * 65536.0;","color.g = floor(tmp / 256.0);","color.r = floor(tmp - color.g * 256.0);","color.xyz /= 255.0;","#ifdef GAMMA_INPUT","vaColor = color * color;","#else","vaColor = color;","#endif","mat4 pMatrix = vGetProjectionMatrix();","rightAndLeft = vec2(1.0/pMatrix[0][0], 1.0/pMatrix[1][1]);","}"].join("\n")};this._isIE11?i.ProcessViewTangentSpace=["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","viewCenterPos = vec3(vGetViewMatrix()*vec4(instancePosition.xyz,1.0));","vec3 localPos = 1.1*_radius*vGetAttribPosition();","ioWorldViewTS.Position = vec3(computeModelViewPosition(vec4( instancePosition.xyz + localPos, 1.0)));","}"].join("\n"):i.ProcessViewTangentSpace=["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","vec3 localPos = vGetAttribPosition();","mat4 pMatrix = vGetProjectionMatrix();","bool isPersp = pMatrix[2][3] == -1.0;","float minScale;","viewCenterPos = vec3(vGetViewMatrix()*vec4(instancePosition.xyz,1.0));","if (isPersp) {","vec3 CR = - viewCenterPos;","float CR_L = length(CR);","float CR_L_2 = CR_L*CR_L;","float d = sqrt(CR_L_2 - _radius2);","vec3 CP = localPos;","float dotCRCP = dot(CR,CP);","vec3 CR_y = CR - dotCRCP*CP;","vec2 _R = vec2(dotCRCP, length(CR_y));","float _Y1 = _radius*(_radius*_R.y + d*_R.x)/CR_L_2;","float _X1 = (_radius2 - _Y1*_R.y)/_R.x;","float _Y2 = _radius*(_radius*_R.y - d*_R.x)/CR_L_2;","float _X2 = (_radius2 - _Y2*_R.y)/_R.x;","float minScale1 = abs(_radius2/_X1);","float minScale2 = abs(_radius2/_X2);","minScale = max(minScale1, minScale2);","float bonusCoeff = (minScale - _radius)*0.1547005/(0.4*_radius) + 1.0;","minScale = minScale*1.1547005*bonusCoeff;","minScale = min(_radius*1.8, minScale);","if (abs(dotCRCP) < 0.0001) minScale = _radius*1.1547;","} else {","minScale = _radius*1.1547;","}","ioWorldViewTS.Position = vec3( viewCenterPos + minScale * localPos);","}"].join("\n");var r={ComputeCommonValues:["void ComputeCommonValues() {","toDiscard = false;","mat4 pMatrix = vGetProjectionMatrix();","viewport = vec2(vGetViewportSize());","isPerspective = pMatrix[2][3] == -1.0;","if(isPerspective) {","vec3 ray = normalize(vGetViewPosition());","newViewPosition = intersectionWithSpherePERSP(ray);","} else {","vec3 ray = vec3(0.0, 0.0, -1.0);","newViewPosition = intersectionWithSphereORTHO(ray);","}","}"].join("\n"),ComputeDiscard:["bool ComputeDiscard() {","return toDiscard;","}"].join("\n"),ComputeAlbedo:["vec3 ComputeAlbedo() {","\treturn vaColor.xyz;","}"].join("\n"),ComputeViewNormal:["vec3 ComputeViewNormal() {","return normalize(newViewPosition - viewCenterPos);","}"].join("\n")};return this._isIE11?r.ComputeViewPosition=["vec3 ComputeViewPosition() {","return newViewPosition;","}"].join("\n"):r.ComputeViewPosition=["vec3 ComputeViewPosition() {","float linearDepth = -newViewPosition.z;","vec3 near_far= vGetNearFarLogFactor();","float near = near_far.x;","float far = near_far.y;","float fragDepth;","if (isPerspective) {","fragDepth = (1.0/linearDepth - 1.0/near)/(1.0/far - 1.0/near);","} else {","fragDepth = (linearDepth - near)/(far - near);","}","vSetFragDepth(fragDepth);","return newViewPosition;","}"].join("\n"),t.setPDSFXOverridableFunctions(i,r),t},setName:function(e){this._name=e}});return UWA.namespace("THREEDS/Nodes/InstancedSphereImpostorsNode",n)}),define("DS/SceneGraphNodes/InstancedSphereImpostorsNode",["DS/AdvancedSceneGraphNodes/InstancedSphereImpostorsNode","DS/DSMigration/DSMigration"],function(e,t){return e}),define("DS/Effects/VolumeRenderingEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Node3D","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/VolumeRenderingShaders","DS/Shaders/NothingShader"],function(e,t,i,r,n,a,s,o){"use strict";var l=function(e,t){for(var i=t||1;i<e;)i*=2;return i},c=function(t,i){for(var r=new Uint8Array(16),n=0;n<4;n++)r[4*n]=0,r[4*n+1]=0,r[4*n+2]=0,r[4*n+3]=i?0:255;var a=new e.DataTexture(r,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter);return a.generateMipmaps=!1,a.needsUpdate=!0,t.setTexture(a,0),a};return r.extend({init:function(t,i,r){this._parent(t);this.debugInfos=!1,this.renderIsoSurface=!1,this.viewMatrix=new e.Matrix4,this.viewpoint=null;var o=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");return this.composers.push(new n(t,o,i)),this.composers[0].composerContext.keepResult=!0,this.initShaderPasses(r),this.mixPass=new a(s.Transfer,void 0,"VolumeRenderingEffect"),this.initTexture=c(this.renderer,!1),this.initTextureIso=c(this.renderer,!0),this.volumeManager=null,this.tmpResult=null,this.renderTargetPool=i,this.debugChunkBox=!1,this.debugChunkRepartition=[0,0,0,0,0,0,0],this.minDensity=0,this.maxDensity=0,this.avgDensity=0,this.costScore=0,this},initShaderPasses:function(i){var r=t.getWebappsAssetUrl("Effects",""),n=new e.ImageUtils.loadTexture(r+"SSAORandom.png",void 0,null,null,e.ImageUtils.crossOriginPolicy);n.minFilter=e.LinearFilter,n.magFilter=e.LinearFilter;var o=4;this.effectVolumePasses=[];for(var c=0;c<7;c++){var h=o*l(Math.ceil(Math.sqrt(o))),u=new a(s.RenderChunk),d=u.material.defines;d.MAX_STEPS=Math.min(4*o,256),d.CHUNK_SIZE=o+".0",d.MAP_INVSIZE=1/h,d.USE_CLIP_PLANE=!1,d.RANDOM_STEP=!i,u.uniforms.tRandomTexture.value=n,u.compileShader(this.renderer),this.effectVolumePasses.push(u),this.composers[0].addPass(u),o*=2}},initEffect:function(e,t){for(var i=t.getComposer("normalDepth"),r=0;r<this.effectVolumePasses.length;r++){var n=this.effectVolumePasses[r];i.linkToShaderPassUniform(n,n.uniforms.tNormalDepth)}t.insertComposer(null,this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2)},setRenderType:function(e){if(e!==this.renderIsoSurface){this.renderIsoSurface=e;for(var t=0;t<7;t++){var i=this.effectVolumePasses[t];i.material.defines.ISO_SURFACE=e?1:0,i.compileShader(this.renderer)}this.mixPass.material.defines.ISO_SURFACE=e?1:0,this.mixPass.compileShader(this.renderer)}},update:function(t,i,r,n){this.volumeManager.update(r),this.viewpoint=r,r._renderedCamera.matrixWorldInverse.getInverse(r._renderedCamera.matrixWorld),r._renderedCamera.projectionMatrixInverse.getInverse(r._renderedCamera.projectionMatrix);for(var a=0;a<this.effectVolumePasses.length;a++){var s=this.effectVolumePasses[a];if(s.uniforms.realProjectionMatrix.value.copy(r._renderedCamera.projectionMatrix),s.uniforms.realProjectionMatrixInverse.value.copy(r._renderedCamera.projectionMatrixInverse),this.viewMatrix.copy(r._renderedCamera.matrixWorldInverse),s.uniforms.colorMap.value=this.volumeManager.colorMap,s.uniforms.transferFctMap.value=this.volumeManager.transferFunctionMap,s.uniforms.renderIteration.value=n,null!==this.volumeManager.clipPlane){var o=(new e.Plane).copy(this.volumeManager.clipPlane);o.applyMatrix4(r._renderedCamera.matrixWorldInverse),s.uniforms.clipPlaneEquation.value.set(o.normal.x,o.normal.y,o.normal.z,o.constant)}}},setAttenuation:function(e){for(var t=0;t<this.effectVolumePasses.length;t++){this.effectVolumePasses[t].uniforms.attenuationCoeff.value=e}},setAttenuationScale:function(e){for(var t=0;t<this.effectVolumePasses.length;t++){this.effectVolumePasses[t].uniforms.attenuationScale.value=e}},setIsoValue:function(e){for(var t=0;t<this.effectVolumePasses.length;t++){this.effectVolumePasses[t].uniforms.isoValue.value=e}},setDebugInfos:function(e){this.debugInfos=e},addChunkToRepartition:function(e){this.volumeManager.updateBinnedValues(e);for(var t=0,i=4;e.data.mapDim.x>i||e.data.mapDim.y>i||e.data.mapDim.z>i;)t++,i*=2;this.debugChunkRepartition[t]++;var r=0;if(this.volumeManager.camera){var n=this.volumeManager.computeChunkVoxelDensity(this.volumeManager.camera,e);r=Math.PI*n*n}1/e.data._voxelDensity>this.maxDensity&&(this.maxDensity=1/e.data._voxelDensity),1/e.data._voxelDensity<this.minDensity&&(this.minDensity=1/e.data._voxelDensity),this.avgDensity+=1/e.data._voxelDensity;var a=e.data.chunkSize;Math.log2(a);this.costScore+=r*Math.min(256,4*e.data.chunkSize)},execute:function(){var t=new e.Matrix4;if(this.debugChunkRepartition=[0,0,0,0,0,0,0],this.minDensity=1/0,this.maxDensity=-1/0,this.avgDensity=0,this.costScore=0,this.debugInfos&&this.volumeManager){for(var i=0;i<256;i++)this.volumeManager.binnedValues[i]=0;this.volumeManager.binnedMaxValue=0}var r=this.viewpoint?this.viewpoint._renderedCamera:null;if(r){var n=new e.Frustum,a=new e.Matrix4;a.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),n.setFromMatrix(a);for(i=0;i<this.volumeManager.volumeChunks.length;i++){var s=this.volumeManager.volumeChunks[i],o=s.data;if(o)if(n.performFrustumCullingNoNearFar(o.radius,o.position)){this.debugInfos&&this.addChunkToRepartition(s);var l=s.data.chunkSize,c=(s.lod,o.modelMatrix),h=Math.log2(l)-2,u=this.effectVolumePasses[h];if(u.uniforms.gridSize.value.copy(o.gridSize),t.multiplyMatrices(this.viewMatrix,c),u.uniforms.realModelViewMatrix.value.copy(t),u.uniforms.realModelViewMatrixInverse.value.getInverse(t),o.map||(o.map=this.volumeManager.getFreeTexture(s),o.map.image=o.mapData,o.map.needsUpdate=!0),u.uniforms.map0.value=o.map,u.uniforms.minDisplayValue.value=this.volumeManager.minValue,u.uniforms.maxDisplayValue.value=this.volumeManager.maxValue,u.uniforms.rangeDisplayValue.value=this.volumeManager.maxValue-this.volumeManager.minValue,u.uniforms.minTileValue.value=s.data.tileSetRange.min,u.uniforms.maxTileValue.value=s.data.tileSetRange.max,u.uniforms.rangeTileValue.value=s.data.tileSetRange.max-s.data.tileSetRange.min,u.uniforms.mapDim.value.copy(o.mapDim),u.uniforms.nbCol.value=o.nbCol,this.debugChunkBox){u.uniforms.debugChunkBox.value.set(.01,.01,.01,.05)}else u.uniforms.debugChunkBox.value.set(0,0,0,0);i?(this.tmpResult=this.composers[0].composerContext.getResult("main",!0),u.uniforms.prevMap.value=this.tmpResult):u.uniforms.prevMap.value=this.renderIsoSurface?this.initTextureIso:this.initTexture,this.activatePass(u),this.composers[0].render(void 0,void 0,void 0,"main"),this.tmpResult&&(this.renderTargetPool.pushRenderTarget(this.tmpResult),this.tmpResult=null)}}this.avgDensity/=this.volumeManager.volumeChunks.length,this.debugInfos&&this.volumeManager&&this.volumeManager.updateBinnedMap()}},activatePass:function(e){for(var t=0;t<this.effectVolumePasses.length;t++){var i=this.effectVolumePasses[t];this.composers[0].enablePass(i,i===e)}},setSize:function(e,t){this._parent(e,t)&&this.composers[0].setSize(this.width,this.height)}})}),define("DS/VisuLoaders/OBJReader",["DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/VisuLoaders/OBJMTLLoader","DS/VisuLoaders/SceneGraphConverter"],function(e,t,i,r,n){"use strict";return function(t,i,a){var s,o,l;s=t,o=void 0!==i?i:null,l=null,this.load=function(t,i,c,h){var u=new e;u.productType="Reference3D";var d=new r(a);d.addEventListener("load",function(e){var t=e.content;l=new n(s,t),u.add(l.getRootNode()),null!==o&&o({hack:!0,updateInfinitePlane:!0}),h&&h()}),d.load(t),i&&i(u)}}}),define("Visualization/OBJReader",["DS/Visualization/OBJReader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/OBJReader"),e}),define("DS/AdvancedSceneGraphNodes/InstancedCylinderImpostorsNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils"],function(e,t,i,r){"use strict";var n=t.extend({init:function(t){this._isIE11=null!=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),this._name=t.name||"cylinderImpostors",this._parent(this._name);var r=t.material?t.material:e.MaterialUtils.createShinyFaceMaterial({force:!0});r.transparent=!0;var n=this._createMaterial(r),a=t.nbInstances||1,s=null;s=this._isIE11?this._createCoarseImpostor(6,n):this._createFlatImpostor(0,n);for(var o=new i(s,""),l=t.positions,c=t.radii,h=t.axes,u=t.colors,d=function(t,i,r,n){var a=r.dot(r),s=new e.Vector3(n*Math.sqrt(1-r.x*r.x/a),n*Math.sqrt(1-r.y*r.y/a),n*Math.sqrt(1-r.z*r.z/a)),o=(new e.Vector3).subVectors(t,s);o.min((new e.Vector3).subVectors(i,s));var l=(new e.Vector3).addVectors(t,s);return l.max((new e.Vector3).addVectors(i,s)),new e.Box3(o,l)},p=new e.Vector3(1/0,1/0,1/0),f=new e.Vector3(-1/0,-1/0,-1/0),m=new Float32Array(4*a),g=new Float32Array(2*a),v=new Float32Array(3*a),S=new e.Vector3,_=new e.Vector3,y=new e.Vector3,x=0;x<a;x++)m[4*x]=l[3*x],m[4*x+1]=l[3*x+1],m[4*x+2]=l[3*x+2],m[4*x+3]=c[x],v[3*x]=h[3*x],v[3*x+1]=h[3*x+1],v[3*x+2]=h[3*x+2],S.set(v[3*x],v[3*x+1],v[3*x+2]),y.addVectors(new e.Vector3(l[3*x],l[3*x+1],l[3*x+2]),new e.Vector3(.5*h[3*x],.5*h[3*x+1],.5*h[3*x+2])),_.subVectors(new e.Vector3(l[3*x],l[3*x+1],l[3*x+2]),new e.Vector3(.5*h[3*x],.5*h[3*x+1],.5*h[3*x+2])),b=d(_,y,S,c[x]),p.min(b.min),f.max(b.max),g[2*x]=Math.floor(255*u[4*x])+256*Math.floor(255*u[4*x+1])+65536*Math.floor(255*u[4*x+2]),g[2*x+1]=u[4*x+3];var M=(new e.Vector3).addVectors(p,f).multiplyScalar(.5),P=(new e.Vector3).addVectors(M,(new e.Vector3).subVectors(p,M).multiplyScalar(1.05)),C=(new e.Vector3).addVectors(M,(new e.Vector3).subVectors(f,M).multiplyScalar(1.05)),b=new e.Box3(P,C),D={data:m,type:"v4",isFlattened:!0,attribName:"instancePositionAndRadius"},w={data:v,type:"v3",isFlattened:!0,attribName:"cylinderAxis"},E={data:g,type:"v2",isFlattened:!0,attribName:"instanceColor"};return o.setMaterial(n),o.setInstancingParameters(a,[D,w,E],"instance"),o.forceBoundingBox(b),this.addChild(o),this},_createFlatImpostor:function(t){var i=[],n=new e.BufferGeometryDS;n.drawingGroups=[];var a=new r.DrawingGroup(t,t,4,0,6);a.geometry=n,n.drawingGroups.push(a);var s=new Float32Array([0,0,0,1,0,0,1,1,0,0,1,0]);n.vertexPositionArray=s;var o=new Uint16Array([0,1,2,0,2,3]);n.vertexIndexArray=o,i.push(n);var l=new e.Mesh(i,t);return l.matrixAutoUpdate=!1,l},_createCoarseImpostor:function(t,i){var n=[],a=new e.BufferGeometryDS;a.drawingGroups=[];var s=12*t,o=new r.DrawingGroup(i,i,4,0,s);o.geometry=a,a.drawingGroups.push(o);var l=2*t+2,c=new Float32Array(3*l),h=0,u=0;c[h++]=0,c[h++]=0,c[h++]=-1;for(var d=0;d<t;d++)u=d/t,c[h++]=Math.cos(2*u*Math.PI),c[h++]=Math.sin(2*u*Math.PI),c[h++]=-1,c[h++]=Math.cos(2*u*Math.PI),c[h++]=Math.sin(2*u*Math.PI),c[h++]=1;c[h++]=0,c[h++]=0,c[h++]=1,a.vertexPositionArray=c;var p=new Uint16Array(s),f=0;for(d=0;d<2*t;d+=2){var m=l-1;10===d&&(m=l-2),p[f++]=0,p[f++]=(d+3)%m,p[f++]=d+1,p[f++]=d+1,p[f++]=(d+3)%m,p[f++]=d+2,p[f++]=(d+3)%m,p[f++]=(d+4)%m,p[f++]=d+2,p[f++]=l-1,p[f++]=d+2,p[f++]=(d+4)%m}a.vertexIndexArray=p,n.push(a);var g=new e.Mesh(n,i);return g.matrixAutoUpdate=!1,g},_createMaterial:function(e){var t=e;t.activatePDSFX(),t.setPDSFXVaryings({viewCenterPos:{type:"v3"},radius:{type:"f"},radius2:{type:"f"},vaColor:{type:"v4"},viewAxis:{type:"v3"},half_height:{type:"f"},rightAndLeft:{type:"v2"}}),t.setPDSFXGlobalShaderCode(["vec3 _viewCenterPos;"].join("\n"),["vec3 viewPositionOnCylinder;","vec3 viewNormalOnCylinder;","bool toDiscard;","bool isPerspective;","vec2 viewport;","void intersectionWithCylinderPERSP() {","float minDistance;","float minDistance2;","vec3 viewPos = vGetViewPosition();","vec3 ray = normalize(viewPos);","vec3 cameraToCenter = viewCenterPos;","vec3 D = cross(ray, viewAxis);","float lengthD = length(D);","if (lengthD == 0.0) {","float adjacentInTriangle = dot(ray, cameraToCenter);","minDistance2 = dot(cameraToCenter, cameraToCenter) - adjacentInTriangle*adjacentInTriangle;","if (minDistance2 > radius2) {","\ttoDiscard = true;","\treturn;","}","viewNormalOnCylinder = -ray;","viewPositionOnCylinder = adjacentInTriangle*ray;","return;","}","D = normalize(D);","minDistance = abs(dot(-cameraToCenter, D));","if (minDistance > radius) {","\ttoDiscard = true;","\treturn;","}","float t = -dot(cross(-cameraToCenter, viewAxis), D)/lengthD;","vec3 O = normalize(cross(D, viewAxis));","float s = abs(sqrt(radius2 - minDistance*minDistance)/dot(ray, O));","vec3 intersection_in = (t-s)*ray;","vec3 intersection_out = (t+s)*ray;","vec3 intersectionToCenter_in = viewCenterPos - intersection_in;","vec3 intersectionToCenter_out = viewCenterPos - intersection_out;","float dot_in_axis = abs(dot(intersectionToCenter_in, viewAxis));","if (dot_in_axis > half_height) {","if (abs(dot(intersectionToCenter_out, viewAxis)) > half_height && ","dot(intersectionToCenter_in, viewAxis)*dot(intersectionToCenter_out, viewAxis) > 0.0) {","toDiscard = true;","return;","}","float diff = dot_in_axis - half_height;","float _dot = dot(ray, viewAxis);","viewNormalOnCylinder = - sign(_dot) * viewAxis;","float x;","x = diff/abs(_dot);","viewPositionOnCylinder = intersection_in + x*ray;","return;","} ","vec3 intersectionProj;","intersectionProj = viewCenterPos + dot(-intersectionToCenter_in, viewAxis)*viewAxis;","viewNormalOnCylinder = normalize(intersection_in - intersectionProj);","viewPositionOnCylinder = intersection_in;","}","void intersectionWithCylinderORTHO() {","float minDistance;","vec3 ray = vec3(0.0,0.0, -1.0);","vec3 viewRayBase = vec3((2.0*(gl_FragCoord.xy/viewport.xy) - 1.0)*rightAndLeft.xy, 0.0);","vec3 cameraToCenter = vec3(0.0,0.0,viewCenterPos.z);","vec3 D = cross(ray, viewAxis);","float lengthD = length(D);","if (lengthD == 0.0) {","minDistance = length(viewRayBase.xy - viewCenterPos.xy);","if (minDistance > radius) {","\ttoDiscard = true;","\treturn;","}","viewNormalOnCylinder = -ray;","viewPositionOnCylinder = viewRayBase + cameraToCenter + vec3(0.0,0.0,half_height);","return;","}","D = normalize(D);","minDistance = abs(dot(viewCenterPos - viewRayBase, D));","if (minDistance > radius) {","\ttoDiscard = true;","\treturn;","}","float t = -dot(cross(viewRayBase - viewCenterPos, viewAxis), D)/lengthD;","vec3 O = normalize(cross(D, viewAxis));","float s = abs(sqrt(radius2 - minDistance*minDistance)/dot(ray, O));","vec3 intersection_in = viewRayBase + (t-s)*ray;","vec3 intersection_out = viewRayBase + (t+s)*ray;","vec3 intersectionToCenter_in = viewCenterPos - intersection_in;","vec3 intersectionToCenter_out = viewCenterPos - intersection_out;","float dot_in_axis = abs(dot(intersectionToCenter_in, viewAxis));","if (dot_in_axis > half_height) {","if (abs(dot(intersectionToCenter_out, viewAxis)) > half_height && ","dot(intersectionToCenter_in, viewAxis)*dot(intersectionToCenter_out, viewAxis) > 0.0) {","toDiscard = true;","return;","}","float diff = dot_in_axis - half_height;","float _dot = dot(ray, viewAxis);","viewNormalOnCylinder = - sign(_dot) * viewAxis;","float x;","x = diff/abs(_dot);","viewPositionOnCylinder = intersection_in + x*ray;","return;","} ","vec3 intersectionProj;","intersectionProj = viewCenterPos + dot(-intersectionToCenter_in, viewAxis)*viewAxis;","viewNormalOnCylinder = normalize(intersection_in - intersectionProj);","viewPositionOnCylinder = intersection_in;","}"].join("\n"));var i={ComputeCommonValues:["void ComputeCommonValues() {","radius = instancePositionAndRadius.w;","radius2 = radius * radius;","viewAxis = normalize(vec3(vGetViewMatrix()*vec4(cylinderAxis, 0.0)));","half_height = length(cylinderAxis)/2.0;","viewCenterPos = vec3(vGetViewMatrix() * vec4(instancePositionAndRadius.xyz, 1.0));","}"].join("\n"),ComputeVaryingValues:["void ComputeVaryingValues() {","vec4 color;","color.a = instanceColor.y;","color.b = floor(instanceColor.x / 65536.0);","float tmp = instanceColor.x - color.b * 65536.0;","color.g = floor(tmp / 256.0);","color.r = floor(tmp - color.g * 256.0);","color.xyz /= 255.0;","#ifdef GAMMA_INPUT","vaColor = color * color;","#else","vaColor = color;","#endif","mat4 pMatrix = vGetProjectionMatrix();","rightAndLeft = vec2(1.0/pMatrix[0][0], 1.0/pMatrix[1][1]);","}"].join("\n")};this._isIE11?i.ProcessViewTangentSpace=["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","vec3 zVec = vec3(0.0,0.0,1.0);","vec3 n_cylinderAxis = normalize(cylinderAxis);","vec3 rotAxis = cross(n_cylinderAxis, zVec);","float s = length(rotAxis);","float c = dot(n_cylinderAxis, zVec);","float t = 1.0 - c;","rotAxis = normalize(rotAxis);","float x = rotAxis.x;","float y = rotAxis.y;","float z = rotAxis.z;","float tx = t*x;","float ty = t*y;","mat4 rotMat = mat4(","vec4(tx * x + c, tx * y - s * z, tx * z + s * y, 0),","vec4(tx * y + s * z, ty * y + c, ty * z - s * x, 0),","vec4(tx * z - s * y, ty * z + s * x, t * z * z + c, 0),","vec4(0.0,0.0,0.0,1.0)",");","vec3 localPosition = vGetAttribPosition();","localPosition.xy *= radius*1.1547;","localPosition.z *= half_height;","localPosition = vec3(rotMat*vec4(localPosition,1.0));","ioWorldViewTS.Position = vec3(computeModelViewPosition(vec4(instancePositionAndRadius.xyz + localPosition, 1.0)));","}"].join("\n"):i.ProcessViewTangentSpace=["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","vec3 localPosition = vGetAttribPosition() - vec3(0.5, 0.5, 0.0);","mat4 pMatrix = vGetProjectionMatrix();","bool isPersp = pMatrix[2][3] == -1.0;","vec3 _z;","_z = -sign(dot( -viewCenterPos, viewAxis))*viewAxis;","vec3 C0 = viewCenterPos - half_height*_z;","vec3 C1 = viewCenterPos + half_height*_z;","if (isPersp) {","vec3 v =  - C0;","vec3 _x = normalize(cross(v, _z));","vec3 _y = normalize(cross(_z, _x));","vec3 y_1;","vec3 x_2;","float cos_alpha;","float sin_alpha;","float tan_alpha;","vec3 O_1 = C0 + dot(-C0, _y)*_y;","float OC_L = length(C0 - O_1);","sin_alpha = radius/OC_L;","bool rectBillboard = true;","if (sin_alpha <= 0.5) {","cos_alpha = sqrt(1.0 - sin_alpha*sin_alpha);","tan_alpha = sin_alpha/cos_alpha;","y_1 = radius*_y;","x_2 = (OC_L -radius)*tan_alpha*_x;","rectBillboard = false;","}","float flatCylCoeff = -1.0;","vec3 C0Plus_y = C0+radius*_y;","float z_plane = viewCenterPos.z;","vec3 C0_n = normalize(C0);","vec3 C0_plane = (z_plane/C0_n.z) * C0_n;","vec3 C1_n = normalize(C1);","vec3 C1_plane = (z_plane/C1_n.z) * C1_n;","vec3 Y_y_n = normalize(C0Plus_y);","vec3 Y_plane = (z_plane/Y_y_n.z) * Y_y_n;","float dot_C0_C1_y = dot(C1_plane - C0_plane, Y_plane - C0_plane);","if (dot_C0_C1_y*_y.z < 0.0)","if (dot_C0_C1_y < 0.0) flatCylCoeff = 1.0;","vec3 newMvPosition;","float sgn = sign(localPosition.y);","float inc_coeff = 1.03;","_x*=inc_coeff;","_y*=inc_coeff;","y_1*=inc_coeff;","x_2*=inc_coeff;","if (localPosition.x < 0.0) {","if (rectBillboard) {","newMvPosition = C0 - radius*_y + sgn* radius*_x;","}","else newMvPosition = C0 + flatCylCoeff * radius*_y + sgn* tan_alpha*(radius+OC_L)*_x;","} else {","vec3 point;","if (rectBillboard) {","vec3 ray = normalize(C1 + radius*_y);","float len = dot(viewAxis, C0)/dot(viewAxis, ray);","vec3 intsc = len*ray;","if (dot(intsc, _y) > dot(C0Plus_y, _y)) {","point = intsc;","} else {","point = C0Plus_y;","}","newMvPosition = point + sgn* radius*_x;","}","else newMvPosition = C1 + y_1 + sgn* x_2;","}","ioWorldViewTS.Position = newMvPosition;","} else {","vec3 _y = normalize(vec3(C1.xy-C0.xy,0.0));","vec3 _x = vec3(-_y.y, _y.x, 0.0);","float medZ = 0.5*(C0.z+C1.z);","C0.z = medZ;","C1.z = medZ;","float coeff = 1.03;","float y_radius = 0.0;","if (viewAxis.z != 0.0) {","vec3 orthAxis = normalize(vec3(viewAxis.xy, -dot(viewAxis.xy,viewAxis.xy)/viewAxis.z));","y_radius = radius*abs(dot(orthAxis, _y));","}","if (localPosition.x < 0.0) {","ioWorldViewTS.Position = C0 +coeff*(sign(localPosition.y) *_x*radius - _y*y_radius);","} else {","ioWorldViewTS.Position = C1 + coeff*(sign(localPosition.y) *_x*radius + _y*y_radius);","}","}","}"].join("\n");var r={ComputeCommonValues:["void ComputeCommonValues() {","mat4 pMatrix = vGetProjectionMatrix();","isPerspective = pMatrix[2][3] == -1.0;","toDiscard = false;","viewport = vec2(vGetViewportSize());","if (isPerspective) intersectionWithCylinderPERSP();","else intersectionWithCylinderORTHO();","}"].join("\n"),ComputeDiscard:["bool ComputeDiscard() {","return toDiscard;","}"].join("\n"),ComputeAlbedo:["vec3 ComputeAlbedo() {","\treturn vaColor.xyz;","}"].join("\n"),ComputeViewNormal:["vec3 ComputeViewNormal() {","return viewNormalOnCylinder;","}"].join("\n")};return this._isIE11?r.ComputeViewPosition=["vec3 ComputeViewPosition() {","return viewPositionOnCylinder;","}"].join("\n"):r.ComputeViewPosition=["vec3 ComputeViewPosition() {","float linearDepth = -viewPositionOnCylinder.z;","vec3 near_far = vGetNearFarLogFactor();","float near = near_far.x;","float far = near_far.y;","float fragDepth;","if (isPerspective) {","fragDepth = (1.0/linearDepth - 1.0/near)/(1.0/far - 1.0/near);","} else {","fragDepth = (linearDepth - near)/(far - near);","}","vSetFragDepth(fragDepth);","return viewPositionOnCylinder;","}"].join("\n"),t.setPDSFXOverridableFunctions(i,r),t},setName:function(e){this._name=e}});return UWA.namespace("THREEDS/Nodes/InstancedCylinderImpostorsNode",n)}),define("DS/SceneGraphNodes/InstancedCylinderImpostorsNode",["DS/AdvancedSceneGraphNodes/InstancedCylinderImpostorsNode","DS/DSMigration/DSMigration"],function(e,t){return e}),define("DS/SceneGraphNodes/SphereLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var r=new e.SphereLight(t.color,t.intensity,t.radius,t.mode);return this._radius=r.radius,this._parent(r,i),this},setRadius:function(e){e&&(this._radius=e),this._updateRadius()},_updateRadius:function(){var e;this.light3js.radius=this._radius,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.radius=this._radius},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"SphereLightNode3D"}});return UWA.namespace("THREEDS/Nodes/SphereLight",i)}),define("SceneGraphNodes/SphereLightNode",["DS/SceneGraphNodes/SphereLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/SphereLightNode"),e}),define("DS/Visualization/OBJReader",["DS/VisuLoaders/OBJReader"],function(e){"use strict";return e}),define("Visualization/OBJReader",["DS/Visualization/OBJReader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/OBJReader"),e}),define("DS/Visualization/XMLV6Loader",["DS/VisuLoaders/XMLV6Loader"],function(e){"use strict";return e}),define("Visualization/XMLV6Loader",["DS/Visualization/XMLV6Loader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/XMLV6Loader"),e}),define("DS/Visualization/FontUtils",["DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/CanvasNodeTexture","DS/SceneGraphNodes/CanvasNode","DS/Visualization/SceneGraphFactory","DS/Visualization/ProxyAbstraction","WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/Visualization/ModelLoader"],function(e,t,i,r,n,a,s,o,l){"use strict";var c=null,h=null,u=null,d=new Set,p=new Set,f=[],m=!1,g=function(e,t){var i=function(e,t){return e.font="64px "+t,e.measureText("cwmli64dr").width},r=function(e,t,i){return e.font="64px '"+t+"','"+i,e.measureText("cwmli64dr").width};return i(t,"monospace")!=r(t,e,"monospace")||(i(t,"serif")!=r(t,e,"serif")||i(t,"sans-serif")!=r(t,e,"sans-serif"))},v=function(e){u=h.getContext("2d"),d.has(e.fn)||(g(e.fn,u)?d.add(e.fn):p.add(e.fn))},S=function(e,t){h||((h=document.createElement("canvas")).height=128),u||(u=h.getContext("2d")),u.font=e;var i=u.measureText(t);h.height=128,h.width=i.width,u.font=e,u.textAlign="left",u.textBaseline="middle",u.clearRect(0,0,h.width,h.height),u.fillStyle="#FFFFFF",u.fillText(t,0,63);for(var r=u.getImageData(0,0,h.width,h.height).data,n=0,a=h.height-1,s=0;s<h.height-1;s++)for(var o=0;o<h.width-1;o++)if(r[s*h.width*4+4*o]){n=s,s=h.height;break}for(s=h.height-1;s>=0;s--)for(o=0;o<h.width-1;o++)if(r[s*h.width*4+4*o]){a=s,s=-1;break}return{width:h.width,height:a-n,topLine:n}},_=function(t){var a,s,o,l,c,h,u,d=new i({width:t.width,height:t.height,drawCB:function(i,r,n,a,s){var o=t.topOffset;try{var l=t.color;if(s&&t.colorIndex&&(l=e._getColorMap(s)[t.colorIndex]),r.fillStyle="#"+l.getHexString(),r.font=t.fontOption,r.textAlign="left",r.textBaseline="middle",r.fillText(t.text,0,o),window.WUXDisableTextNodes)return void r.clearRect(0,0,t.width,t.height)}catch(e){console.log(failed)}},rectangleTexture:!0,maxZoom:8,alphaTest:.01,webGLV6Viewer:t.viewer}),p=(t.hotspot,t.bbox[0]),f=t.bbox[1],m=t.bbox[2],g=t.bbox[3],v=t.orientationAngle,S=f-p,_=g-m,y=v%90;switch(u=v/90,isNaN(u)?NaN:u>0?Math.floor(u):Math.ceil(u)){case 1:a=new e.Vector3(f,m,0),s=new e.Vector3(f,g,0),c=new e.Vector3(0,1,0),h=new e.Vector3(-1,0,0),o=_,l=S;break;case 2:a=new e.Vector3(f,g,0),s=new e.Vector3(p,g,0),c=new e.Vector3(-1,0,0),h=new e.Vector3(0,-1,0),o=S,l=_;break;case 3:a=new e.Vector3(p,g,0),s=new e.Vector3(p,m,0),c=new e.Vector3(0,-1,0),h=new e.Vector3(1,0,0),o=_,l=S;break;default:a=new e.Vector3(p,m,0),s=new e.Vector3(f,m,0),c=new e.Vector3(1,0,0),h=new e.Vector3(0,1,0),o=S,l=_}var x=l,M=0;(y=y*(Math.PI/180))>0&&(M=o-Math.cos(y)*t.widthRigth,x=Math.tan(Math.PI/2-y)*M);var P=l-x;c.multiplyScalar(M);var C=(new e.Vector3).copy(h).multiplyScalar(P);h.multiplyScalar(x);var b=(new e.Vector3).addVectors(a,c),D=(new e.Vector3).addVectors(a,h).sub(b),w=C.add(s).sub(b);return new r({name:"test",bottomLeftcorner:b,widthVector:w,heightVector:D,canvasNodeTexture:d,side:e.DoubleSide,_noZPriority:t._noZPriority},n)},y=function(i,r,n){var a=[];h||((h=document.createElement("canvas")).height=128);for(var s=i.length,o=0;o<s;o++){(l=c[i[o].fontName])&&v(l)}p.forEach(function(e,t,i){var r;r=e,u=h.getContext("2d"),d.has(r)||g(r,u)&&d.add(r)}),p.clear();for(o=0;o<s;o++){var l;(l=c[i[o].fontName])||(l={fn:"nofont"});var f=(l.B?"bold ":"")+(l.I?"italic ":"")+"64px '"+l.fn,m=S(f,i[o].text),y=63-m.topLine,x=(i[o].colorIndex&&i[o].colorIndex,i[o].viewer&&i[o].viewer,new e.Color({r:i[o].color.r,g:i[o].color.g,b:i[o].color.b}));r.textureInBlack&&1==i[o].color.r&&1==i[o].color.g&&1==i[o].color.b&&(x.r=x.g=x.b=0);var M=_({text:i[o].text,width:m.width,height:m.height+1,color:x,fontOption:f,topOffset:y,bbox:i[o].bbox,widthRigth:i[o].width,orientationAngle:i[o].orientationAngle,_noZPriority:i[o]._noZPriority});if(i[o].matrix&&M.setMatrix((new e.Matrix4).setFromArray(i[o].matrix.elements)),i[o].attachedPoint){var P=new t({type:"Spherical"});P.setMatrix((new e.Matrix4).setFromArray(i[o].attachedPoint.elements)),P.addChild(M),a.push(P)}else a.push(M)}n(a)},x={table:c,createTexts:function(e,t,i){c?y(e,t,i):(f.push({cgrTexts:e,options:t,doneCallback:i}),m||(m=!0,require(["text!Visualization/assets/fonts/fontTable.json"],function(e){c=JSON.parse(e),function(){for(var e=0;e<f.length;e++)y(f[e].cgrTexts,f[e].options,f[e].doneCallback);f=[]}()})))},measureText:S};return UWA.namespace("THREEDS/FontUtils",x)}),define("DS/Visualization/Ambience",["DS/Visualization/ThreeJS_DS","DS/Effects/ConvertCubemapToLatlong","DS/Visualization/SceneGraphFactory","DS/Visualization/Utils","DS/Visualization/WorldOrientation","DS/CoreEvents/Events","DS/Effects/ExtractLightFromIBL","DS/Effects/MergeMainMipsEffect","WebappsUtils/WebappsUtils"],function(e,t,i,r,n,a,s,o,l){"use strict";var c=e._AmbianceGenerators._dummyRoughnessTexture,h=function(t,i){var r=void 0!==(t=t||{}).image?t.image:null,n=void 0!==t.format?t.format:null,a=void 0!==t.sRGB?t.sRGB:"hdr"!=n,s=void 0!==t.type?t.type:"url",o=void 0!==t.texture?t.texture:null,l=void 0!==i?i:null,c=function(){console.log("loading image error")};this.stream=function(){return o?{texture:o,format:n}:null},this.getTexture=function(){return o},this.getImage=function(){return r},this.getFormat=function(){return n},this.isSRGB=function(){return a},this.isTextureHDRFloat=function(){return!(!o||o.type!=e.FloatType||o.format!=e.RGBFormat)},this.getType=function(){return s},this.setTexture=function(e){a=(o=e).sRGB},this.setFormat=function(e){n=e,"hdr"==e&&(a=!1)},this.setSRGB=function(e){a=e},this.setType=function(e){s=e},this.loadImage=function(t){var i=this.getImage(),r=this;if("url"==this.getType())if("hdr"==this.getFormat())(o=e.ImageUtils.loadHDRTexture(i,t,l,c,!1,!1)).minFilter=e.NearestFilter,o.magFilter=e.NearestFilter;else if("dds"==this.getFormat()){o=e.ImageUtils.loadCompressedTexture(i,t,function(e){r.isTextureHDRFloat()&&(r.setFormat("hdr"),e.hdr=!0,e.rgbHdr=!0),r.setSRGB(e.sRGB),l(e)})}else o=new e.ImageUtils.loadTexture(i,t,l,null,e.ImageUtils.crossOriginPolicy);"urlCube"==this.getType()?o=e.ImageUtils.loadTextureCube(i,t,l):i&&i instanceof e.Texture&&((o=i).loadEndStatus===e.AssetLoadingStatus.READY?l():o.onLoadCallbacks.push(l))}},u=function(){var t=!1;this.needUpdate=!1,this.needUpdateParameters=!1;var i="latlong",r=[],n=0,a=new h,s="bestFit",o=1,l=1,c=null,u=0,d=1,p={transition:0,image:new h,ambienceMatrix:new e.Matrix4,inverseMatrix:new e.Matrix4,radius:0},f=this,m=function(e){f.needUpdate=!0};this.setFromJson=function(c){if(t=!0,this.needUpdate=!0,c.type&&(i=c.type),c.sizeScaling&&(s=c.sizeScaling),c.intensity&&(o=c.intensity),c.blur&&(u=c.blur),c.ratio&&(l=c.ratio),c.horizonHeight&&(n=c.horizonHeight),c.image&&c.image.texture&&(a.setTexture(c.image.texture),a.setFormat(c.image.format)),c.colors)for(var h=0;h<c.colors.length;h++)r.push((new e.Color).setRGB(c.colors[h][0],c.colors[h][1],c.colors[h][2]))},this.stream=function(){if(t){var e={};if(e.type=i,r.length){for(var c=[],h=0;h<r.length;h++)c.push([r[h].r,r[h].g,r[h].b]);e.colors=c}return e.horizonHeight=n,e.sizeScaling=s,e.intensity=o,e.blur=u,e.ratio=l,e.image=a.stream(),e}return null},this.isActivated=function(){return t},this.getType=function(){return i},this.initDefaultColors=function(t){r=[];for(var i=0;i<t;i++)r.push(new e.Color)},this.getColors=function(){switch(this.getType()){case"gradient":2!=r.length&&this.initDefaultColors(2);break;case"gradient3":3!=r.length&&this.initDefaultColors(3);break;case"gradientWithHorizon":4!=r.length&&this.initDefaultColors(4)}return r},this.getHorizonHeight=function(){return n},this.getBackplateScale=function(){return d},this.setBackplateScale=function(e){e!==d&&(d=e,"backplate"==i&&(this.needUpdateParameters=!0))},this.getImage=function(){return a},this.getSizeScaling=function(){return s},this.getIntensity=function(){return o},this.getBlur=function(){return u},this.getRatio=function(){return l},this.getBackplateCB=function(){return c},this.setActivated=function(e){e!=t&&(this.needUpdate=!0),t=e},this.setType=function(e){i!=e&&(i=e,this.needUpdate=!0),t||this.setActivated(!0)},this.setColors=function(e){var t;switch((r=e).length){case 2:t="gradient";break;case 3:t="gradient3";break;case 4:t="gradientWithHorizon";break;default:return!1}this.setType(t),this.needUpdateParameters=!0},this.setHorizonHeight=function(e){n=e,this.needUpdateParameters=!0},this.setSizeScaling=function(e){s=e,this.needUpdateParameters=!0},this.setIntensity=function(e){o=e,this.needUpdateParameters=!0},this.setBlur=function(e){u=e,this.needUpdateParameters=!0},this.setRatio=function(e){l=e,this.needUpdateParameters=!0},this.setBackplateCB=function(e){c=e,this.needUpdateParameters=!0},this.hasGradient=function(){return t&&("gradient"==i||"gradientWithHorizon"==i)},this.loadImage=function(t){t.doneCallback&&(m=function(){t.doneCallback(),f.needUpdate=!0}),t.type="url",t&&t.image&&t.image instanceof e.Texture&&(t.type="THREETexture"),t&&t.image&&t.image instanceof Array&&(t.type="urlCube"),(a=new h(t,m)).loadImage(function(t,i){switch(t){case"cubemap":return new e.CubeEnvMapping;case"environment":return new e.LatLongReflectionMapping;case"latlong":return new e.LatLongEnvMapping;case"backplate":return new e.SimpleEnvMapping}}(this.getType(),this.getSizeScaling()))},this.withImage=function(){if(!a.getTexture())return!1;var e=this.getType();return"cubemap"==e||"latlong"==e||"backplate"==e||"transition"==e},this.getTransitionInfos=function(){return p},this.setTransitionInfos=function(e){p=e}},d=function(){var t=!1;this.needUpdate=!1,this.needUpdateParameters=!1;var i=!1,r="sphere",n=5e3,a=new e.Vector3(0,0,.5),s=!1;this.setFromJson=function(e){t=!0,this.needUpdate=!0,e.type&&(r=e.type),e.size&&(n=e.size),e.shootPosition&&a.set(e.shootPosition[0]/n,e.shootPosition[1]/n,e.shootPosition[2]/n)},this.setYUp=function(e){i=e},this.stream=function(){if(t){var e={};return e.type=r,e.size=n,e.shootPosition=a.toArray(),e}return null},this.isActivated=function(){return t},this.getType=function(){return r},this.getSize=function(){return n},this.isAutoUpdateSize=function(){return s},this.getShootPosition=function(){return i?new e.Vector3(a.x,a.z,a.y):a},this.getWorldShootPosition=function(t){var i=(new e.Matrix4).extractRotation(t);return this.getShootPosition().clone().applyMatrix4(i)},this.setActivated=function(e){e!=t&&(this.needUpdate=!0),t=e},this.setType=function(e){r=e,this.needUpdate=!0},this.setSize=function(e){n>0&&(n=e),this.needUpdateParameters=!0},this.setAutoUpdateSize=function(e){s=e},this.setShootPosition=function(e){a=e,this.needUpdateParameters=!0}},p=function(){var t=!1;this.needUpdate=!1,this.needUpdateParameters=!1,this.needsUpdateShadowIntensity=!1;var i="transparent",r=0,n=0,a=1,s=0,o=new e.Color;this.disableDefaultGroundShadow=!1;var c=null,h=!0;this.setFromJson=function(e){t=!0,this.needUpdate=!0,e.type&&(i=e.type),e.planeColor&&this.setPlaneColor(e.planeColor),void 0!==e.height&&(r=e.height),void 0!==e.reflectivity&&(n=e.reflectivity),void 0!==e.glossiness&&(a=e.glossiness),void 0!==e.shadowIntensity&&(s=e.shadowIntensity),e.material},this.stream=function(){if(t){var e={};return e.type=i,e.height=r,e.autoHeight=h,e.reflectivity=n,e.glossiness=a,e.shadowIntensity=s,e.material=c,e}return null},this.isActivated=function(){return t},this.getPlaneColor=function(){return o},this.isPhysical=function(){return!!c&&"physical"==this.getType()},this.getType=function(){return i},this.getHeight=function(){return r},this.getAutoHeight=function(){return h},this.getReflectivity=function(){return n},this.getGlossiness=function(){return a},this.getShadowIntensity=function(){return s},this.getMaterial=function(){return c},this.setActivated=function(e){e!=t&&(this.needUpdate=!0,this.needUpdateParameters=!0),t=e},this.setGroundOutDoor=function(){this.needUpdate=!0,i="physical",function(){c=new e.DSPBR19xMaterial({side:0,opacity:.99,roughness:.9});var t=l.getWebappsAssetUrl("Visualization","")+"OCA/",i=e.ImageUtils.loadTexture(t+"Outdoor_Ground_Diffuse.jpg");i.generateMipmap=!0,i.minFilter=e.LinearMipMapLinearFilter,i.magFilter=e.LinearFilter,i.repeat=new e.Vector2(10,10),i.wrapS=1e3,i.wrapT=1e3;var r=e.ImageUtils.loadTexture(t+"Outdoor_Ground_MainMap.jpg");r.generateMipmap=!0,r.minFilter=e.LinearMipMapLinearFilter,r.magFilter=e.LinearFilter,r.repeat=new e.Vector2(1,1),r.wrapS=1e3,r.wrapT=1e3,c.side=0,c.forceSide=!0,c.force=!0,c.needsUpdate=!0,c.depthWrite=!1,c.activatePDSFX();var n={fadingStrenght:{type:"f",value:5},fadingRatio:{type:"f",value:1},s_MaterialMap:{type:"t2",value:r},s_BaseColorMap:{type:"t2",value:i}};c.setPDSFXUniforms(n);c.setPDSFXVaryings({_vUv:{type:"v2"}});var a=["float ratio = 1.0;","vec2 uv[2];","float dUV = 1.0;","vec4 groundColor = vec4(290.0/255.0, 214.0/255.0, 164.0/255.0, 1.0) ;","mat3 MainMatrix_UVTransfo = mat3(10, 0.0, 0.0,","                                 0.0, 10, 0.0,","                                 0.0, 0.0, 1.0);","mat3 Matrix1_UVTransfo = mat3(1.0024, 0.9758, 0.0,","                              -0.9758, 1.0024, 0.0,","                              0.0, 0.0, 1.0);","mat3 Matrix2_UVTransfo = mat3(1.7, 0.0, 0.0,","                              0.0, 1.6, 0.0,","                              0.01, 0.78, 1.0);","vec2 TransformUV(vec2 iUV, mat3 iMatrix) {","    vec3 uv = iMatrix*vec3(iUV, 1.0);","    return uv.xy;","}"].join("\n");c.setPDSFXGlobalShaderCode("",a);var s={ComputeVaryingValues:["void ComputeVaryingValues() {","_vUv = vGetAttribTexCoord0().xy;","}"].join("\n")},o={ComputeAlbedo:["vec3 ComputeAlbedo() {","return mix(texture2D(s_BaseColorMap, uv[0]).xyz, texture2D(s_BaseColorMap, uv[1]).xyz, ratio);","}"].join("\n"),ComputeCommonValues:["void ComputeCommonValues() {","dUV = smoothstep(0.0,0.8,(length(2.0 * _vUv - 1.0)));","vec2  p_vUv = TransformUV(_vUv, MainMatrix_UVTransfo);","uv[0] =  TransformUV(p_vUv, Matrix1_UVTransfo);","uv[1] =  TransformUV(p_vUv, Matrix2_UVTransfo);","float ratio  = texture2D(s_MaterialMap, TransformUV(p_vUv, MainMatrix_UVTransfo)).r;","}"].join("\n"),ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","  ioFinalColor.a = 1.0 - dUV;","}"].join("\n")};c.setPDSFXOverridableFunctions(s,o)}()},this.setPlaneColor=function(e){o=e,this.needUpdateParameters=!0},this.setType=function(e){t&&i!=e&&(this.needUpdate=!0),i=e},this.setHeight=function(e){r=e,this.needUpdateParameters=!0},this.setAutoHeight=function(e){h=e,this.needUpdateParameters=!0},this.setReflectivity=function(e){0!==n&&0!==e||!(n>0||e>0)||(this.needUpdate=!0),n=e,this.needUpdateParameters=!0},this.setGlossiness=function(e){a=e,this.needUpdateParameters=!0},this.setShadowIntensity=function(e){s!==e&&(this.needsUpdateShadowIntensity=!0),0!==s&&0!==e||!(s>0||e>0)||(this.needUpdate=!0,this.needUpdateParameters=!0),s=e},this.setMaterial=function(e){c=e,this.needUpdateParameters=!0}},f=function(t){var i=!1;this.needUpdate=!1,this.needUpdateParameters=!1;var r=t,n=new h,a="latlong",s=new e.Color(16777215),o=1,l=1,c=new e.Matrix4,u=new e.Matrix4,d=!1,p=this,f=function(){p.needUpdate=!0};this.setFromJson=function(t,h,u){if(h&&(r=!0,u&&c.multiplyMatrices(c,(new e.Matrix4).extractRotation(u))),i=!0,t.projection&&(a=t.projection),t.emissionColor&&(s=s.setRGB(t.emissionColor[0],t.emissionColor[1],t.emissionColor[2])),t.emissionValue&&(o=t.emissionValue,l=t.emissionValue),r){if(t.matrix){var d=(new e.Matrix4).setFromArray(t.matrix);c.multiplyMatrices(c,d)}this.updateMatrix()}else if(c.rotateZ(-Math.PI/2),t.matrix){d=(new e.Matrix4).setFromArray(t.matrix);var p=(new e.Matrix4).getInverse(d);c.multiplyMatrices(c,p)}t.image&&t.image.texture&&(n.setTexture(t.image.texture),n.setFormat(t.image.format),this.needUpdate=!0)},this.updateMatrix=function(){u.identity(),u.rotateZ(-Math.PI/2),d&&u.rotateX(Math.PI/2);var t=(new e.Matrix4).getInverse(c);u.multiplyMatrices(u,t)},this.stream=function(){if(i){var e={};return e.projection=a,e.emissionColor=[s.r,s.g,s.b],e.emissionValue=o,e.matrix=c.elements.slice(0),e.image=n.stream(),e}return null},this.isActivated=function(){return i},this.setYUp=function(e){d=e,this.updateMatrix()},this.getImage=function(){return n},this.getProjection=function(){return scale},this.getValue=function(){return value},this.getMatrix=function(){return c},this.getInverseMatrix=function(){return u},this.getIntensity=function(){return o},this.getDiffuseIntensity=function(){return l},this.setActivated=function(e){e!=i&&(this.needUpdate=!0,i=e)},this.setValue=function(e){value=e,this.needUpdateParameters=!0},this.setIntensity=function(e){o=e,l=e,this.needUpdateParameters=!0},this.setSpecularIntensity=function(e){o=e,this.needUpdateParameters=!0},this.setDiffuseIntensity=function(e){l=e,this.needUpdateParameters=!0},this.setMatrix=function(e){c=e,r&&this.updateMatrix(),this.needUpdateParameters=!0},this.loadImage=function(t){var i;t.type="url",t&&t.image&&t.image instanceof e.Texture&&(t.type="THREETexture"),t&&t.image&&t.image instanceof Array&&(t.type="urlCube"),i=t.cb?function(e){t.cb(e),f()}:f,(n=new h(t,i)).loadImage(new e.LatLongReflectionMapping)},this.updateMatrix()},m=function(){var t=new e.Vector3(0,0,0),i=new e.Vector3(0,0,1),r=(new e.Vector3(0,0,1),new e.Vector3(0,0,0)),n=1,a=!0,s=!1;this.needUpdateParameters=!1,this.setFromJson=function(e){e.groundPosition&&(t=e.groundPosition),e.groundNormal&&(i=e.groundNormal),e.sceneHeight&&(r=e.sceneHeight),e.groundScale&&(n=e.groundScale),e.withGround&&(a=e.withGround)},this.updateMatrix=function(){i.set(0,0,1),s&&i.set(0,1,0)},this.updateFromMatrix=function(i){t.getPositionFromMatrix(i),i=(new e.Matrix4).extractRotation(i),this.updateMatrix()},this.setYUp=function(e){s=e,this.setSceneHeight(r),this.updateMatrix()},this.stream=function(){var e={};return e.groundPosition=t,e.groundNormal=i,e.sceneHeight=r,e.groundScale=n,e.withGround=a,e},this.isWithGround=function(){return a},this.getGroundPosition=function(){return t},this.getGroundNormal=function(){return i},this.getSceneHeight=function(){return r},this.getGroundScale=function(){return n},this.setGroundPosition=function(e){t.copy(e),this.needUpdateParameters=!0},this.setWithGround=function(e){a=e},this.setGroundNormal=function(e){console.warn("DEPRECATED: use setTransfrom instead of setGroundNormal")},this.setSceneHeight=function(t){r=s?new e.Vector3(0,t.z,0):t.clone(),this.needUpdateParameters=!0},this.setGroundScale=function(e){n=e,this.needUpdateParameters=!0}},g=function(l){var h=this;l||(l={}),this.requestIBLLightExtraction=a.subscribe({event:"/VISU/requestIBLLightExtraction"},function(e){h._extractIBLLight(e.extraData.rendererID)});var v=void 0!==l.viewer?l.viewer:null,S=void 0!==l.roughnessMap?l.roughnessMap:c,_="",y=!0,x=new u,M=new d,P=new p,C=new f(y),b=new m,D=new e.Matrix4,w=new e.Matrix4,E={},T=!1,A=!1,I=[],R=[],L=!1,O=null,N=[],F=[],V=null,U=null,B=!1,k=!1,G=!1,z=!1,H=null,W=0,j=0,X=0,q=0,Z=0,Y=0,K=0,J=0,Q=0,$=new e.Vector2(1,1),ee=new e.Vector2(0,0);l.finiteEnv&&M.setActivated(!0),this.usePlaneV2=!1,l.usePlaneV2&&(this.usePlaneV2=!0);var te=null,ie=!1;!1===l.autoGroundOffset&&P.setAutoHeight(!1);var re=new e.Color(0),ne=1,ae=!1;v&&v.currentViewpoint&&v.currentViewpoint.camera&&v.currentViewpoint.camera.isOrtho&&(ae=!0);var se=!1,oe=null,le=1920,ce=1080,he=1,ue=!1;this.needUpdateIBL=new Set;this.isOCA=!1,this.keepIBLTexture=!0,this.keepBackgroundTexture=!0,this.setCameraOrtho=function(e){ae!=e&&(ae=e,ue=!0,this.update())},this.useRenderToTarget=function(e){e},this.setWorldOrientation=function(e){var t=e==n.YUpXRight;C.setYUp(t),b.setYUp(t),M.setYUp(t),z=t,this.updateMatrix(),this.update()},this.updateAmbience=function(){be(),pe(),this.needUpdateIBL=new Set},this.setGroundOptions=function(e){v&&(v.setGroundOptions(e),E=v._getGroundOptions())},this.setOnComputeRoughnessMapCb=function(e){O=e};this.isComputingRoughnessMap=function(){return L};var de=function(){if(v){var e=v.getRenderer().ambianceGenerators;e.setCallBack(function(){L=!1,e.setCallBack(null),O&&O()})}};this.isTextureLoading=function(){return T||A},this.updateMatrix=function(){w.identity(),w.rotateZ(-Math.PI/2),z&&w.rotateX(Math.PI/2);var t=(new e.Matrix4).getInverse(D);t.elements[12]=D.elements[12],t.elements[13]=D.elements[13],t.elements[14]=D.elements[14],w.multiplyMatrices(w,t);var i=x.getTransitionInfos();i.inverseMatrix.identity(),i.inverseMatrix.rotateZ(-Math.PI/2),z&&i.inverseMatrix.rotateX(Math.PI/2),(t=(new e.Matrix4).getInverse(i.ambienceMatrix)).elements[12]=i.ambienceMatrix.elements[12],t.elements[13]=i.ambienceMatrix.elements[13],t.elements[14]=i.ambienceMatrix.elements[14],i.inverseMatrix.multiplyMatrices(i.inverseMatrix,t)},this.loadFrom3dx=function(t,i,r,n,a){var s=t;r&&(y=!0);var o=null;if(s.name&&(_=s.name),y)s.transform&&(o=(new e.Matrix4).setFromArray(s.transform),D.multiplyMatrices(D,o),b.updateFromMatrix(D)),this.updateMatrix();else if(D.rotateZ(-Math.PI/2),s.transform){o=(new e.Matrix4).setFromArray(s.transform);var l=(new e.Matrix4).getInverse(o);l.elements[12]=o.elements[12],l.elements[13]=o.elements[13],l.elements[14]=o.elements[14],D.multiplyMatrices(D,l)}s.backgroundGeometry&&M.setFromJson(s.backgroundGeometry),s.ground?P.setFromJson(s.ground):r&&this.setGroundGeometry(!1);var h={useSky:!1,background:!0,dir:null,intensity:1,height:null,groundHeight:P.getHeight()};if(s.environmentLight)if(s.environmentLight.sun_direction&&!1!==s.environmentLight.enabled){h.useSky=!0;var u=s.environmentLight.sun_direction;if(h.dir=new e.Vector3(-u[0],-u[1],-u[2]),o){var d=(new e.Matrix4).extractRotation(o);h.dir.applyMatrix4(d)}null!=s.environmentLight.altitude&&(h.height=s.environmentLight.altitude),null!=s.environmentLight.intensity&&(h.intensity=s.environmentLight.intensity)}else r?C.setFromJson(s.environmentLight,r,o):C.setFromJson(s.environmentLight,r);if(P.setAutoHeight(!1),s.background)if("color"==s.background.type&&"color"==s.background.type){var p=s.background.colors[0];re.setRGB(p[0],p[1],p[2]),ne=p[3],v&&v.setBackgroundColor(re.getHex(),ne)}else x.setFromJson(s.background);if(i?this.loadImageFrom3dx(i,n,a):S||(S=!r&&C.getImage().getTexture()?null:c,this.needUpdateIBL=new Set),h.useSky&&v){var f=null==h.height?v.currentViewpoint.camera.position.z-h.groundHeight:h.height;f*=s.unitScale/1e6,this.setSkyLighting(h.dir,Math.max(f,.001),h.intensity,h.background)}},this._extractIBLLight=function(e){if(!U){var t=this.getIblMap();if(t&&v&&v.renderer&&v.renderer.renderer&&v.renderer.renderer.id===e){k=!1;var i=new s(v.renderer.renderer,v.renderer.renderTargetPool);i.setEnvMap(t),U=i.execute(N.filter(function(e){return e.light.castShadow&&e.light.intensity>0}).length>0),i.dispose(),a.publish({event:"/VISU/IBLLightExtracted",data:{eventChannel:"/VISU/IBLLightExtracted",eventType:"@IBLLightExtracted"}})}U&&(G=!0)}},this._solveSceneRoughnessMap=function(e,t){if(v){var i=this.getIblMap();if(i){var r=new o(v.renderer.renderer,v.renderer.renderTargetPool);r.setTextures(e.textures,i,e.ggx0,e.ggxMapping),this.setRoughnessMap({texture:r.execute()}),r.dispose(),a.publish({event:"/VISU/3DXMipsMerged",data:{eventChannel:"/VISU/3DXMipsMerged",eventType:"@3DXMipsMerged"}}),t&&t({ambiance:this})}}},this.setLights=function(e,t,i,r){B=!0,k=!0,e._phongReduction=!0,t?F.push({light:e,dirLight:i,linkToSceneGraph:!1}):N.push({light:e,dirLight:i,linkToSceneGraph:!1}),r&&(V={light:r,dirLight:i,linkToSceneGraph:!1})},this.updateLights=function(t,i,r,n,a){if(B&&i){for(var s=0;s<N.length;s++)N[s].light.linkToSceneGraph||i.add(N[s].light);for(s=0;s<F.length;s++)F[s].light.linkToSceneGraph||i.add(F[s].light)}B&&a&&V&&!V.light.linkToSceneGraph&&a.add(V.light),G&&i&&(i.add(U.light),G=!1),k&&U&&(i.remove(U.light),U=null,k=!1),(i||a)&&(B=!1);var o=t.getUpDirection(),l=t.getSightDirection(),c=(new e.Vector3).crossVectors(l,o);for(s=0;s<F.length;s++){var h=F[s].light,u=F[s].dirLight,d=(new e.Vector3(c.x*u.x+o.x*u.y+l.x*u.z,c.y*u.x+o.y*u.y+l.y*u.z,c.z*u.x+o.z*u+l.z*u.z),new e.Vector4(u.x,u.y,u.z,0));d.applyMatrix4(t.camera.matrix),h.position=new e.Vector3(d.x,d.y,d.z).multiplyScalar(r.radius)}var p=function(t,i){var n=t.light,a=t.dirLight;n.target.position.copy(r.center),n.target.updateMatrixWorld(),n.position=(new e.Vector3).copy(a).multiplyScalar(2*r.radius).add(r.center),null!==i&&n.position.applyMatrix4(i)};for(s=0;s<N.length;s++){p(N[s],null)}U&&p(U,this.getEnvironmentLightMatrix(!0)),V&&(V.light.castShadow=!1,p(V,null))},this.removeLights=function(e,t){if(e){for(var i=0;i<N.length;i++)N[i].light.dispose(),e.remove(N[i].light);for(i=0;i<F.length;i++)F[i].light.dispose(),e.remove(F[i].light);U&&(U.light.dispose(),e.remove(U.light)),V&&(V.light.dispose(),t.remove(V.light))}},this.loadImageFrom3dx=function(i,r,n){if(k=!0,l.images){var a=0,s=0;l.images.background&&a++,l.images.environmentLight&&a++;var o=this,h=function(){++s==a&&(T=!1,A=!1,ue=!0,r&&r({ambiance:o}))};if(l.images.background&&(T=!0,x.loadImage({image:l.images.background.data,format:l.images.background.format,doneCallback:h})),l.images.environmentLight){if("hdr"==l.images.environmentLight.format)u=n?function(){o.needUpdateIBL=new Set,h()}:function(){o.needUpdateIBL=new Set;var t=o.getEnvironmentLight().getImage().getTexture();if(t&&t.image){var i=t.image,r=parseInt(i.width,10),n=parseInt(i.height,10);if(isNaN(r)||isNaN(n)||2*n!=r&&console.warn("##3DX LOADING## ibl width should be 2x ibl height"),r<8||n<4){for(var a=new Uint8Array(128),s=0;s<32;s++)a[4*s]=i.data[0],a[4*s+1]=i.data[1],a[4*s+2]=i.data[2],a[4*s+3]=i.data[3];i.height="4",i.width="8",i.data=a;var l=new Uint8Array(256);for(s=0;s<64;s++)l[4*s]=i.data[0],l[4*s+1]=i.data[1],l[4*s+2]=i.data[2],l[4*s+3]=i.data[3];return(S=new e.DataTexture(l,8,8,e.RGBAFormat,void 0,void 0)).hdr=t.hdr,S.sRGB=t.sRGB,S.minFilter=e.NearestFilter,S.magFilter=e.NearestFilter,S.wrapS=e.RepeatWrapping,S.wrapT=e.RepeatWrapping,S.mapping=t.mapping,void h()}}L=!0,de(),o.needUpdateIBL=new Set,S=null,h()},A=!0,C.loadImage({cb:u,image:l.images.environmentLight.data,format:l.images.environmentLight.format});else if("dds"==l.images.environmentLight.format){u=n?function(e){var i=null;if(e.isCubeMap&&e.isCubeMap()){if(v){oe||(oe=new t(v.renderer.renderer,v.renderer.renderTargetPool));var r=C.getImage().getTexture();oe.setEnvMap(r,2),oe.execute(),i=oe.getResultRGBE(!0)}}else i=e;C.getImage().setTexture(i),o.needUpdateIBL=new Set,h()}:function(i){var r=null;if(i.isCubeMap&&i.isCubeMap()){if(v){oe||(oe=new t(v.renderer.renderer,v.renderer.renderTargetPool));var n=C.getImage().getTexture();oe.setEnvMap(n,2),oe.execute(),r=oe.getResultRGBE(!0)}}else if((r=i)&&r.mipmaps){var a=r.mipmaps[0],s=parseInt(a.width,10),l=parseInt(a.height,10);if(isNaN(s)||isNaN(l)||2*l!=s&&console.warn("##3DX LOADING## ibl width should be 2x ibl height"),s<8||l<4){var c,u;i.type==e.FloatType?(r.hdr=!0,r.rgbHdr=!0,r.sRGB=!1,c=new Float32Array(128)):c=new Uint8Array(128);for(var d=0;d<32;d++)c[4*d]=a.data[0],c[4*d+1]=a.data[1],c[4*d+2]=a.data[2],c[4*d+3]=a.data[3];a.height="4",a.width="8",a.data=c,u=i.type==e.FloatType?new Float32Array(256):new Uint8Array(256);for(d=0;d<64;d++)u[4*d]=a.data[0],u[4*d+1]=a.data[1],u[4*d+2]=a.data[2],u[4*d+3]=a.data[3];return(S=new e.DataTexture(u,8,8,e.RGBAFormat,void 0,void 0)).hdr=r.hdr,S.sRGB=r.sRGB,S.minFilter=e.NearestFilter,S.magFilter=e.NearestFilter,S.wrapS=e.RepeatWrapping,S.wrapT=e.RepeatWrapping,S.mapping=r.mapping,C.getImage().setTexture(r),o.needUpdateIBL=new Set,void h()}}C.getImage().setTexture(r),L=!0,de(),o.needUpdateIBL=new Set,S=null,h()},A=!0,C.loadImage({cb:u,image:l.images.environmentLight.data,format:l.images.environmentLight.format})}else if("png"==l.images.environmentLight.format){var u=function(){S=C.getImage().getTexture(),o.needUpdateIBL=new Set};h();u=function(){var e=C.getImage().getTexture();e.rgbHdr=!0,e.hdr=!0,e.sRGB=!0,L=!0,h(),de(),o.needUpdateIBL=new Set,S=null};A=!0,C.loadImage({cb:u,image:l.images.environmentLight.data,format:l.images.environmentLight.format})}}else this.needUpdateIBL=new Set,S=c}},this.setRenderTargetSize=function(e,t,i,r){W=0,j=0,X=i,q=r,e&&(W=e),t&&(j=t)},this.isFiniteMode=function(){return M.isActivated()},this.getTransform=function(){return D},this.setTransform=function(e){D=e,y&&(this.updateMatrix(),b.updateFromMatrix(D)),ue=!0},this.getEnvironmentLightMatrix=function(e){return e&&y?C.getInverseMatrix():C.getMatrix()},this._getEnvironmentLightMatrix=function(){var t=new e.Matrix4;return t.getInverse(C.getInverseMatrix()),t},this.getGroundOptions=function(){return E},this.setEnvironmentLightMatrix=function(e){C.setMatrix(e),ue=!0},this.getBackgroundGeometryEditor=function(){return b},this.getBackgroundGeometry=function(){return M},this.getBackground=function(){return x},this.getGround=function(){return P},this.getEnvironmentLight=function(){return C},this.getBackgroundColor=function(){return re},this.getBackgroundAlpha=function(){return ne},this.setBackgroundAlpha=function(e){ne=e,ue=!0},this.setBackgroundColor=function(t){re=new e.Color(t),ue=!0},this.updateParameters=function(){ue=!0,this.update()},this.update=function(){x.needUpdate&&(pe(),x.needUpdate=!1,x.needUpdateParameters=!1,C.needUpdateParameters=!1),M.needUpdate&&(pe(),M.needUpdate=!1,x.needUpdateParameters=!1,C.needUpdateParameters=!1,M.needUpdateParameters=!1),C.needUpdate&&(C.needUpdate=!1),P.needUpdate&&(P.needUpdate=!1,be()),(ue||P.needUpdateParameters||x.needUpdateParameters||C.needUpdateParameters||M.needUpdateParameters||b.needUpdateParameters)&&(fe(),x.needUpdateParameters=!1,C.needUpdateParameters=!1,P.needUpdateParameters=!1,M.needUpdateParameters=!1,b.needUpdateParameters=!1,ue=!1)};var pe=function(){if(x.isActivated())switch(x.getType()){case"gradient":case"gradient3":case"gradientWithHorizon":Me();break;case"cubemap":M.isActivated()?"sphere"==M.getType()&&Pe():we();break;case"latlong":M.isActivated()?"sphere"==M.getType()&&Pe():De();break;case"transition":Ce();break;case"backplate":Ee();break;default:return!1}te&&(te.side=e.DoubleSide,te.depthTest=!1,te.force=!0,te.forceSide=!0,ie=!0),fe()},fe=function(){if(te&&x.isActivated()){if(x.withImage()){var e=x.getImage();e.getTexture()&&(te.tEnvMap=e.getTexture(),te.tEnvMap.envMapExposure&&(te.tEnvMap.envMapExposure=x.getIntensity()),te.envMapExposure=x.getIntensity(),te.defines.HDR!=("hdr"==e.getFormat())&&(te.defines.HDR="hdr"==e.getFormat(),te.needsUpdate=!0),te.defines.sRGB!=e.isSRGB()&&(te.defines.sRGB=e.isSRGB(),te.needsUpdate=!0),te.defines.HDR_FLOAT!=e.isTextureHDRFloat()&&(te.defines.HDR_FLOAT=e.isTextureHDRFloat(),te.needsUpdate=!0))}M.isActivated()?"gradient"==x.getType()||"gradientWithHorizon"==x.getType()||"gradient3"==x.getType()?ge("gradientWithHorizon"==x.getType()):"backplate"==x.getType()?ve():"transition"==x.getType()?xe():ye():("latlong"==x.getType()&&_e(),"cubemap"==x.getType()&&Se(),"backplate"==x.getType()&&ve(),"gradient"!=x.getType()&&"gradientWithHorizon"!=x.getType()&&"gradient3"!=x.getType()||ge("gradientWithHorizon"==x.getType()))}if(C.isActivated()){var t=C.getImage().getTexture();t&&(t.envMapExposureSpecular=C.getIntensity(),t.envMapExposureDiffuse=C.getDiffuseIntensity())}P.isActivated()&&me()},me=function(){if(P.getReflectivity()>0){var e=function(){if(v&&v.renderer&&v.renderer.mirrorBlendPass)return v.renderer.mirrorBlendPass}();e&&(e.uniforms.reflectivity.value=P.getReflectivity())}},ge=function(e){te.colors=[];var t=te.colors,i=x.getColors();te.YUp=z?1:0,te.ratio=x.getRatio();for(var r=0;r<i.length;r++){var n=i[r];t.push(n.r),t.push(n.g),t.push(n.b)}e&&(te.horizonHeight=x.getHorizonHeight())},ve=function(){x.getImage().getTexture();te.backgroundColor.set(re),te.backgroundAlpha=ne,Ie()},Se=function(){x.getImage().getTexture()&&(te.ambienceMatrix=y?w:D)},_e=function(){var t=x.getImage().getTexture();t&&(t.minFilter=e.LinearFilter,te.ambienceMatrix=y?w:D,x.getBlur()&&S&&S!==c&&(te.tEnvMap2=S,te.blurCoef=x.getBlur(),te.defines.ENVMAP2||(te.defines.ENVMAP2=!0,te.needsUpdate=!0)),P.isPhysical()?(te.planeColor=P.getPlaneColor(),te.withPlane=1):te.withPlane=0)},ye=function(){var t=x.getImage().getTexture();te.side=ae?e.BackSide:e.DoubleSide,t&&(t.minFilter=e.LinearFilter,te.tEnvMap=t,y?(te.ambienceMatrix=w,te.groundHeight=M.getWorldShootPosition(D)):(te.ambienceMatrix=D,te.groundHeight=M.getShootPosition()),te.groundPosition=b.getGroundPosition(),te.groundNormal=b.getGroundNormal(),te.groundOffset=P.getHeight(),te.sceneHeight=b.getSceneHeight(),te.groundRadius=M.getSize(),te.groundScale=b.getGroundScale(),te.withGround=b.isWithGround(),te.projectionConic=!ae,te.defines.LATLONG_MAP!=!("cubemap"==x.getType())&&(te.defines.LATLONG_MAP=!("cubemap"==x.getType()),te.needsUpdate=!0))},xe=function(){var t=x.getImage().getTexture();te.side=e.DoubleSide,t&&(t.minFilter=e.LinearFilter,te.tEnvMap=t,te.ambienceMatrix=w,te.groundPosition=b.getGroundPosition(),te.groundRadius=M.getSize(),te.groundScale=b.getGroundScale(),te.defines.LATLONG_MAP!=!("cubemap"==x.getType())&&(te.defines.LATLONG_MAP=!("cubemap"==x.getType()),te.needsUpdate=!0));var i=x.getTransitionInfos();te.transitionCoef=i.transition;var r=i.image.getTexture();r&&(r.minFilter=e.LinearFilter,te.tEnvMap2=r,te.groundPosition2.set(i.ambienceMatrix.elements[12],i.ambienceMatrix.elements[13],i.ambienceMatrix.elements[14]),te.ambienceMatrix2=i.inverseMatrix,te.groundRadius2=i.radius,te.groundScale2=b.getGroundScale())},Me=function(){var t;switch(x.getType()){case"gradient":t=e.GradientBackgroundMaterial2;break;case"gradient3":t=e.GradientBackgroundMaterial3;break;case"gradientWithHorizon":t=e.GradientBackgroundMaterial4;break;default:return!1}te=new t(null)},Pe=function(){var t=x.getImage(),i={defines:{HDR:"hdr"==t.getFormat(),sRGB:t.isSRGB(),LATLONG_MAP:"latlong"==x.getType(),AMBIENCE_V2:!!y}};te=new e.FiniteEnvMapMaterial(i)},Ce=function(){te=new e.FiniteTransitionEnvMapMaterial(null)},be=function(){v&&(P.isActivated()&&P.getReflectivity()>0?v.setMirror(!0,void 0,null,P.getReflectivity(),P.getGlossiness()):v.setMirror(!1),P.isActivated()&&P.getShadowIntensity()>0?(v.setShadowPlane(!0),P.disableDefaultGroundShadow?v.setGroundShadow(!1):v.setGroundShadow(!0)):v.setGroundShadow(!1))},De=function(){var t=x.getImage(),i={defines:{HDR:"hdr"==t.getFormat(),sRGB:t.isSRGB(),HDR_FLOAT:t.isTextureHDRFloat(),ENVMAP2:S&&S!==c&&x.getBlur()>=0}};te=new e.LatLongMapMaterial(i)},we=function(){te=new e.CubeMapMaterial},Ee=function(){var t=x.getImage(),i={defines:{HDR:"hdr"==t.getFormat(),HDR_FLOAT:t.isTextureHDRFloat(),sRGB:t.isSRGB()}};te=new e.SimpleMapMaterial(i),Ie()},Te=function(i){var r;if(i.url){var n=i.onMapsLoaded,a=null;if(i.onlyOnRequest&&i.fallbackColor&&(n=null,a=function(t){r=function(t){var i=4;t[0]&&(i=8);for(var r=new Uint8Array(8*i*4),n=0;n<8*i;n++)r[4*n]=t[1],r[4*n+1]=t[2],r[4*n+2]=t[3],r[4*n+3]=t[4];var a=new e.DataTexture(r,8,i,e.RGBAFormat);return a.needsUpdate=!0,a.hdr=!0,a.sRGB=!1,a.minFilter=e.NearestFilter,a.magFilter=e.NearestFilter,a.wrapS=e.RepeatWrapping,a.wrapT=e.RepeatWrapping,a.loadEndStatus=e.AssetLoadingStatus.READY,a}(i.fallbackColor),i.fallbackColor[0]?h.setIblMap({texture:r}):h.setRoughnessMap({texture:r})}),i.url instanceof Array)r=e.ImageUtils.loadTextureCube(i.url,i.mapping,i.onMapsLoaded);else if(i.hdr)r=e.ImageUtils.loadHDRTexture(i.url,i.mapping,n,null,null,!1,!1,e.ImageUtils.crossOriginPolicy,i.onlyOnRequest),i.onlyOnRequest&&i.onMapsLoaded(r);else{var s=i.url.split("."),o=(s[s.length-2],s[s.length-1]);"hdr"==(o=o.toLowerCase())||i.hdr?(r=e.ImageUtils.loadHDRTexture(i.url,i.mapping),i.hdr=!0,r.onLoadCallbacks.push(i.onMapsLoaded)):"dds"==o||i.dds?r=e.ImageUtils.loadCompressedTexture(i.url,new e.LatLongReflectionMapping,function(){v&&(oe||(oe=new t(v.renderer.renderer,v.renderer.renderTargetPool)),oe.setEnvMap(r,2),oe.execute(),r=oe.getResultRGBE(!0),i.onMapsLoaded(r))}):(r=new e.ImageUtils.loadTexture(i.url,i.mapping,n,a,e.ImageUtils.crossOriginPolicy,!1,i.onlyOnRequest),i.onlyOnRequest&&i.onMapsLoaded(r))}}return r},Ae=function(t,i,r){var n=x.getImage();n.setTexture(t);var a=r?"hdr":"png";n.setFormat(a);var s,o,l=t,c=!!r;i instanceof e.SimpleEnvMapping?(s="backplate",o="simple"):i instanceof e.SimpleEnvMappingCustom?(s="backplate",o="custom"):i instanceof e.SimpleEnvMappingFit?(s="backplate",o="fit"):i instanceof e.SimpleEnvMappingPreserveRatio?(s="backplate",o="bestFit"):i instanceof e.SimpleEnvMappingFitWidth?(s="backplate",o="fitWidth"):i instanceof e.SimpleEnvMappingFitHeight?(s="backplate",o="fitHeight"):i instanceof e.LatLongEnvMapping?s="latlong":i instanceof e.CubeEnvMapping&&(s="cubemap"),c&&(l.minFilter=e.NearestFilter,l.magFilter=e.NearestFilter,l.wrapS=e.RepeatWrapping,l.wrapT=e.RepeatWrapping),s!=x.getType()||!te||"backplate"==x.getType()&&x.getSizeScaling()!=o?(x.setType(s),o&&x.setSizeScaling(o),pe()):ue=!0},Ie=function(e){var t=x.getImage().getTexture();if("backplate"==x.getType()&&t){var i=2048,r=1024;t.image?(i=t.image.width,r=t.image.height):t.width&&t.height&&(i=t.width,r=t.height);var n=i/r,a=le,s=ce;W&&j&&(a=W,s=j),e&&(i*=2,r*=2,a*=2,s*=2);var o,l=(a*=x.getBackplateScale())/(s*=x.getBackplateScale()),c=X,h=q;if(Q)if(a=Q,s=J,c=-Z,h=-(J-K-Y),W&&j&&(a=W,s=j,c=X,h=q),l=a/s,"custom"==x.getSizeScaling())(o=x.getBackplateCB())&&o({textureWidth:i,textureHeight:r,viewportWidth:a,viewportHeight:s,devicePixelRatio:he});else if("simple"==x.getSizeScaling())i=a,r=s,te.offset.set(he*(c+ee.x*i),he*(h-ee.y*r-($.y-1)*r)),te.invSize.set(1/(he*i*$.x),1/(he*r*$.y));else if("fitHeight"==x.getSizeScaling()){i=s*n,r=s,c+=.5*(a-(u=(d=s*$.y)/n)),te.offset.set(he*c,he*(h-ee.y*r-($.y-1)*r)),te.invSize.set(1/(he*d),1/(he*d))}else if("fitWidth"==x.getSizeScaling()){i=a,r=a/n,h+=.5*(s-(d=(u=a*$.x)/n)),te.offset.set(he*(c+ee.x*i),he*h),te.invSize.set(1/(he*u),1/(he*d))}else if("bestFit"==x.getSizeScaling()){if(n>l){i=(r=s)*n;var u=(d=r*$.y)/n}else{r=(i=a)/n;var d=(u=i*$.x)/n}te.offset.set(he*(c+ee.x*i),he*(h-ee.y*r-($.y-1)*r)),te.invSize.set(1/(he*i*$.x),1/(he*d))}else"fit"==x.getSizeScaling()&&(n>l?(i=a,h+=.5*(s-(r=a/n))):(r=s,c+=.5*(a-(i=s*n))),te.offset.set(he*(c+ee.x*i),he*(h-ee.y*r-($.y-1)*r)),te.invSize.set(1/(he*i*$.x),1/(he*r*$.y)));else if("custom"==x.getSizeScaling())(o=x.getBackplateCB())&&o({textureWidth:i,textureHeight:r,viewportWidth:a,viewportHeight:s,devicePixelRatio:he});else"simple"==x.getSizeScaling()?(i=a,r=s,te.offset.set(he*c,he*h),te.invSize.set(1/(he*i),1/(he*r))):"fitHeight"==x.getSizeScaling()?(i=s*n,r=s,c=.5*(le*x.getBackplateScale()-i),te.offset.set(he*c,he*h),te.invSize.set(1/(he*i),1/(he*r))):"fitWidth"==x.getSizeScaling()?(i=a,r=a/n,h=.5*(ce*x.getBackplateScale()-r),te.offset.set(he*c,he*h),te.invSize.set(1/(he*i),1/(he*r))):"bestFit"==x.getSizeScaling()?(n>l?i=(r=s)*n:r=(i=a)/n,te.offset.set(he*c,he*h),te.invSize.set(1/(he*i),1/(he*r))):"fit"==x.getSizeScaling()&&(n>l?(i=a,h+=.5*(s-(r=a/n))):(r=s,c+=.5*(a-(i=s*n))),te.offset.set(he*c,he*h),te.invSize.set(1/(he*i),1/(he*r)))}};this.getIblMap=function(){if(C.isActivated()){var t=C.getImage().getTexture();if(t&&(t.loadEndStatus==e.AssetLoadingStatus.READY||t.loadEndStatus==e.AssetLoadingStatus.PAUSED||null==t.loadEndStatus))return t}return null},this.getRoughnessMap=function(){return C.isActivated()?S:null},this.getRadiusEnvMap=function(){return M.getSize()*b.getGroundScale()*2},this.getCenter=function(){var e,t;return y?((e=b.getSceneHeight().clone()).multiplyScalar(M.getSize()),e.add(b.getGroundPosition())):((e=b.getGroundNormal().clone().multiply(b.getSceneHeight())).multiplyScalar(M.getSize()),t=b.getGroundPosition().clone().applyMatrix4(D),e.add(t)),e},this.getRadius=function(){return M.getSize()*b.getGroundScale()},this.getProjectionCenter=function(){var e,t;return y?((e=M.getShootPosition().clone()).multiplyScalar(M.getSize()),e.add(b.getGroundPosition())):((e=b.getGroundNormal().clone().multiply(M.getShootPosition())).multiplyScalar(M.getSize()),t=b.getGroundPosition().clone().applyMatrix4(D),e.add(t),e.z+=P.getHeight()),e},this.updateCamera=function(t,i,r){if(t.camera&&this.setCameraOrtho(t.camera.isOrtho),te&&"latlong"==x.getType()){if(r.fullWidth)te.invScreenSize.x=1/r.width,te.invScreenSize.y=1/r.height,te.startOffset.x=r.x/r.fullWidth,te.endOffset.y=1-r.y/r.fullHeight,te.endOffset.x=(r.x+r.width)/r.fullWidth,te.startOffset.y=1-(r.y+r.height)/r.fullHeight;else{var n=i.renderer.getViewportSize();te.invScreenSize.x=1/n.width,te.invScreenSize.y=1/n.height,te.startOffset.x=0,te.startOffset.y=0,te.endOffset.x=1,te.endOffset.y=1}if(t.camera.isOrtho&&this.isFiniteMode()){var a=Math.tan(.5*e.Math.degToRad(t.camera.fov)),s=t.getSightDirection().normalize(),o=t.camera.up.normalize();te.cameraRight.crossVectors(t.getSightDirection(),t.camera.up).normalize(),te.cameraSight.copy(s),te.cameraUp.copy(o),te.invScreenSize.x=1/i.deviceWidth,te.invScreenSize.y=1/i.deviceHeight,te.near=t.camera.near,te.right=t.camera.right,te.up=t.camera.top}else{a=Math.tan(.5*e.Math.degToRad(t.camera.fov));te.cameraSight.copy(t.getSightDirection()),te.cameraUp.copy(t.camera.up).multiplyScalar(a),te.cameraRight.crossVectors(t.getSightDirection(),t.camera.up),te.cameraRight.multiplyScalar(t.camera.aspect*a),te.invScreenSize.x=1/i.deviceWidth,te.invScreenSize.y=1/i.deviceHeight}}if(te&&"backplate"==x.getType()){var l="SSAA"==i.antiAliasing;r.fullWidth?(Z=r.x,Y=r.y,r.width,K=r.height,J=r.fullHeight,Q=r.fullWidth,Ie(l)):(Z=0,Y=0,0,K=0,J=0,Q=0,Ie(l))}},this.resize=function(e,t,i,r){if(le=e,ce=t,he=i,"backplate"==x.getType()){var n="SSAA"==r.antiAliasing;Ie(n)}},this.getSphere=function(){return(e=i.createSphereNode({radius:1,sag:64,material:te})._occurrences[0].renderable).frustumCulled=!1,e.renderDepth=2,e.visible=!0,e.visibilityFree=!0,e;var e};this.getGroundGeometry=function(){return(t=i.createRectangleNode({width:1,noEdge:!0,height:1,cornerPoint:new e.Vector2(-.5,-.5),fill:!0,material:P.getMaterial()?P.getMaterial():new e.PhysicalMaterial})._occurrences[0].renderable).frustumCulled=!1,t.renderDepth=2,t.visible=!0,t.visibilityFree=!0,t;var t},this.updateSphere=function(e,t,i){var r,n;se||(r=t,n=e,i.position.set(r.x,r.y,r.z),i.scale.set(n,n,n),i.updateMatrix(),te&&(i.material=te),i.visible=!0,ie&&(i._flagAsGSSOInvalidated(),ie=!1))},this.setNearValue=function(e){te&&(te.near=e)},this.updateGround=function(e){if(!se){var t=5*this.getBackgroundGeometry().getSize(),i=this.getCenter();e.position.set(i.x,i.y,i.z),e.scale.set(t,t,t),e.rotation.x=z?-Math.PI/2:0,e.updateMatrix(),P.getMaterial()&&(e.material=P.getMaterial()),e.visible=!0}},this._removePhysicalGround=function(){P.setMaterial(null),P.setType("transparent")},this.setIblMap=function(t){var i=this,r=null;if(k=!0,t.mapping||(t.mapping=new e.LatLongReflectionMapping),t.onMapsLoaded=function(r){t.pngHdr&&(r.sRGB=!1,r.hdr=!0);var n=r;if(C.getImage().setTexture(n),C.setActivated(!0),n.minFilter=e.NearestFilter,n.magFilter=e.NearestFilter,n.wrapS=e.RepeatWrapping,n.wrapT=e.RepeatWrapping,t.mapping&&(n.mapping=t.mapping),t.hdr&&(n.hdr=t.hdr),(t.generateRougnessMap||t.generateRoughnessMap)&&v){v.getRenderer().ambianceGenerators;A=!1;for(var a=0;a<R.length;a++)R[a].setIblMap({texture:n,mapping:t.mapping,hdr:t.hdr});R=[],L=!0,t.doneCallback&&t.doneCallback(),de(),i.needUpdateIBL=new Set,S=null}if(t.doneCallback&&(!t.generateRougnessMap||!t.generateRoughnessMap)){A=!1;for(a=0;a<R.length;a++)R[a].setIblMap({texture:n,mapping:t.mapping,hdr:t.hdr});R=[],t.doneCallback()}ue=!0,i.needUpdateIBL=new Set},t.url)A=!0,r=Te(t);else if(t.texture&&t.texture instanceof e.Texture)A=!0,(r=t.texture).loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded(r):r.onLoadCallbacks.push(t.onMapsLoaded);else if(t.texture&&t.texture instanceof e.WebGLRenderTarget){var n=t.texture;if(C.getImage().setTexture(n),C.setActivated(!0),n.minFilter=e.NearestFilter,n.magFilter=e.NearestFilter,n.wrapS=e.RepeatWrapping,n.wrapT=e.RepeatWrapping,t.mapping&&(n.mapping=t.mapping),t.hdr&&(n.hdr=t.hdr),t.generateRougnessMap&&v){v.getRenderer().ambianceGenerators;L=!0,t.doneCallback&&t.doneCallback(n),i.needUpdateIBL=new Set,S=null,de()}}},this.setReflectionMap=function(i){var n=this,a=null,s=i.url,o=c;if(i.onMapsLoaded=function(){var t=a;C.getImage().setTexture(t),C.setActivated(!0),S=o,t.minFilter=S.minFilter=e.NearestFilter,t.magFilter=S.magFilter=e.NearestFilter,t.wrapS=S.wrapS=e.RepeatWrapping,t.wrapT=S.wrapT=e.RepeatWrapping,i.doneCallback&&i.doneCallback(),n.needUpdateIBL=new Set},"dds"===r.getExtension(s))var l=e.ImageUtils.loadCompressedTexture(s,new e.LatLongReflectionMapping,function(){v&&(oe||(oe=new t(v.renderer.renderer,v.renderer.renderTargetPool)),oe.setEnvMap(l,2),oe.execute(),o=null,a=oe.getResultRGBE(!0),i.onMapsLoaded())})},this.setRoughnessMap=function(t){var i=this,r=c;t.onMapsLoaded=function(n){S=n||r,t.pngHdr&&(S.sRGB=!1,S.hdr=!0),t.hasDiffuse&&(S.hasDiffuse=!0),S.minFilter=e.NearestFilter,S.magFilter=e.NearestFilter,S.wrapS=e.RepeatWrapping,S.wrapT=e.RepeatWrapping,t.mapping&&(S.mapping=t.mapping),t.hdr&&(S.hdr=t.hdr),t.doneCallback&&t.doneCallback(),i.needUpdateIBL=new Set},t.url?r=Te(t):t.texture&&t.texture instanceof e.Texture?(r=t.texture).loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded(r):r.onLoadCallbacks.push(t.onMapsLoaded):t.texture&&t.texture instanceof e.WebGLRenderTarget&&(r=t.texture,t.onMapsLoaded(r))},this.setBackplateMap=function(t){var i=null,r=this;t.onMapsLoaded=function(){r.setFiniteMode(!1),Ae(i,t.mapping,t.hdr),t.doneCallback&&t.doneCallback()},t.url?i=Te(t):t.texture&&t.texture instanceof e.Texture&&(i=t.texture,t.mapping||(t.mapping=i.mapping),t.hdr||(t.hdr=i.hdr),i.loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded():i.onLoadCallbacks.push(t.onMapsLoaded))},this.generateIBLFromColor=function(t){for(var i=new Uint8Array(128),r=0;r<32;r++)i[4*r]=t[0],i[4*r+1]=t[1],i[4*r+2]=t[2],i[4*r+3]=t[3];var n=new e.DataTexture(i,8,4,e.RGBAFormat,void 0,void 0);n.hdr=!0,n.sRGB=!1,n.mapping=new e.LatLongReflectionMapping,n.needsUpdate=!0;var a=new Uint8Array(256);for(r=0;r<64;r++)a[4*r]=t[0],a[4*r+1]=t[1],a[4*r+2]=t[2],a[4*r+3]=t[3];(S=new e.DataTexture(a,8,8,e.RGBAFormat,void 0,void 0)).hdr=!0,S.sRGB=!1,S.needsUpdate=!0,S.minFilter=e.NearestFilter,S.magFilter=e.NearestFilter,S.wrapS=e.RepeatWrapping,S.wrapT=e.RepeatWrapping,S.mapping=new e.LatLongReflectionMapping,C.getImage().setTexture(n),C.setActivated(!0),this.needUpdateIBL=new Set},this.setBackGroundMap=function(t){var i=null;t.onMapsLoaded=function(){t.pngHdr&&(i.sRGB=!1,i.hdr=!0,t.hdr=!0),Ae(i,t.mapping,t.hdr),T=!1;for(var e=0;e<I.length;e++)I[e].setBackGroundMap({texture:i,mapping:t.mapping,hdr:t.hdr});I=[],t.doneCallback&&t.doneCallback()},t.url?(T=!0,i=Te(t)):t.texture&&t.texture instanceof e.Texture?(T=!0,i=t.texture,t.mapping||(t.mapping=i.mapping),t.hdr||(t.hdr=i.hdr),i.loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded():i.onLoadCallbacks.push(t.onMapsLoaded)):t.texture&&t.texture instanceof e.WebGLRenderTarget&&Ae(t.texture,t.mapping,t.hdr)},this.setExposure=function(e){x.setIntensity(e),C.setIntensity(e)},this.getEnvMapExposure=function(){return x.getIntensity()},this.lockAmbiance=function(e){se=e},this.setFiniteMode=function(e){M.isActivated()!=e&&M.setActivated(e)},this.setGroundGeometry=function(e){b.setWithGround(e)},this.getGroundPosition=function(){return b.getGroundPosition()},this.setGroundPosition=function(e){b.setGroundPosition(e)},this.setGroundNormal=function(e){console.warn("DEPRECATED: use setTransfrom instead of setGroundNormal"),b.setGroundNormal(e)},this.setSceneHeight=function(e){b.setSceneHeight(e)},this.setGroundHeight=function(e){M.setShootPosition(e)},this.setGroundRadius=function(e){M.setSize(e),v&&v.planeV2&&v.planeGrid&&(v.planeGrid.size=2*e)},this.displayGround=function(e){P.setActivated(e),v&&v.displayInfinitePlane(e)},this.setGroundScale=function(e){b.setGroundScale(e)},this.updateScene=function(e){b.setGroundPosition(e)},this.isAutoGroundOffset=function(){return P.getAutoHeight()},this.setAutoGroundOffset=function(e){P.setAutoHeight(e)},this.setGroundOffset=function(e){P.setHeight(e)},this.setEnvMapBlur=function(e){x.setBlur(e)},this.getOffset=function(){return P.getHeight()},this.setEnvMapOffset=function(e){D.makeRotationZ(e),C.getMatrix().makeRotationZ(e),y&&(C.updateMatrix(),this.updateMatrix()),ue=!0},this.setGroundReflectivitiy=function(e){P.setReflectivity(e),P.setActivated(!0)},this.setGroundReflectivity=function(e){P.setReflectivity(e),P.setActivated(!0)},this.setGroundShadowIntensity=function(e){P.setShadowIntensity(e),P.setActivated(!0)},this.isUsedMirror=function(){return P.isActivated()&&"transparent"==P.getType()&&P.getReflectivity()>0},this._setMirror=function(e){(e||"transparent"==P.getType())&&(P.setActivated(e),P.setType("transparent"),P.setReflectivity(.3))},this.getGroundGlossiness=function(){return P.getGlossiness()},this.setCustomBackplateCallback=function(e){x.setType("backplate"),x.setSizeScaling("custom"),x.setBackplateCB(e)},this.setBackplateOffset=function(e,t){te.offset.set(e,t)},this.setBackplateSize=function(e,t){te.invSize.set(e,t)},this.setGroundGlossiness=function(e){P.setGlossiness(e)},this.setTranslation=function(e){D.translate(e),y&&this.updateMatrix()},this.setSkyLighting=function(t,i,r,n){if(v){v.renderer.SkyScatteringEffect?v.renderer.SkyScatteringEffect.setEnabled(!0):v.renderer.initEffect("SkyScattering");var a=this;if(v.setShadow(!0),this.getGround().disableDefaultGroundShadow=!0,this.setExposure(r),H)H.dirLight=t;else{var s=new e.DirectionalLight(16777215,5.5*Math.PI*r);s.castShadow=!0,s.shadowBias=-.005,s.shadowMapWidth=v.shadowMapWidth,s.shadowMapHeight=v.shadowMapHeight,s._sceneShadow=!0,this.setLights(s,!1,t),H=N[N.length-1]}v.renderer.SkyScatteringEffect.setGenerationInput({sunDirection:t,viewAltitude:i}),v.renderer.SkyScatteringEffect.execute(!0,function(t){a.setIblMap({texture:t,hdr:!0,mapping:new e.LatLongReflectionMapping,generateRougnessMap:!0}),a.keepIBLTexture=!0,n&&(a.setBackGroundMap({texture:t,hdr:!0,mapping:new e.LatLongEnvMapping}),a.keepBackgroundTexture=!0)})}},this.setTransitionBackground=function(t,i,r){this.setFiniteMode(!0),t.radius&&M.setSize(t.radius),this.setTransform(t.matrix),(o=x.getImage()).setTexture(t.map);var n=t.hdr?"hdr":"png";o.setFormat(n);var a=t.map;!!t.hdr&&(a.minFilter=e.NearestFilter,a.magFilter=e.NearestFilter,a.wrapS=e.RepeatWrapping,a.wrapT=e.RepeatWrapping);var s=x.getTransitionInfos();if(i&&i.map&&i.map.loadEndStatus===e.AssetLoadingStatus.READY){var o;(o=s.image).setTexture(i.map);n=i.hdr?"hdr":"png";o.setFormat(n);a=i.map;!!i.hdr&&(a.minFilter=e.NearestFilter,a.magFilter=e.NearestFilter,a.wrapS=e.RepeatWrapping,a.wrapT=e.RepeatWrapping),s.ambienceMatrix=i.matrix,s.radius=i.radius,s.transition=r}else s.transition=0;x.setTransitionInfos(s),"transition"==x.getType()&&te?ue=!0:(x.setType("transition"),pe())},this.dispose=function(){S&&S!==c&&S.dispose(),this.getIblMap()&&!this.keepIBLTexture&&this.getIblMap().dispose();var e=x.getImage().getTexture();e&&!this.keepBackgroundTexture&&e.dispose(),x.setActivated(!1),C.setActivated(!1),M.setActivated(!1),te&&te.dispose(),this.needUpdateIBL=new Set,a.unsubscribe(this.requestIBLLightExtraction)},this.clone=function(e){e||(e={});var t=void 0!==e.viewer?e.viewer:null,i={viewer:t},r={};r.name=_,r.usePlaneV2=this.usePlaneV2,r.backgroundGeometryEditor=b.stream(),r.transform=D.elements.slice(0),r.background=x.stream(),r.backgroundGeometry=M.stream(),r.environmentLight=C.stream(),r.ground=P.stream(),i.v2=y,i.ambiance=r;var n=new g(i);return n.getGround().setAutoHeight(!0),n.setBackgroundColor(re.getHex()),n.setBackgroundAlpha(ne),t&&t.setBackgroundColor(re.getHex(),ne),T&&I.push(n),A&&R.push(n),S&&n.setRoughnessMap({texture:S}),n},v&&this.setWorldOrientation(v._worldOrientation),this.updateMatrix(),l.ambiance&&this.loadFrom3dx(l.ambiance,l.images,l.from3DX,l.doneCallback,!!l.roughnessMap),pe()};return g}),define("DS/VisuLoaders/ThreeDXLoader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Visualization/MaterialApplication","DS/Visualization/LightNode3D","DS/SceneGraphNodes/DirectionalLightNode","DS/SceneGraphNodes/SpotLightNode","DS/SceneGraphNodes/PointLightNode","DS/Visualization/Viewpoint","DS/Visualization/Ambience","DS/ZipJS2/ZipJS2","DS/Visualization/KDTree"],function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m){"use strict";var g=e.NoOccurrences,v=window.newMaterialInheritance,S=!1,_=!1;window.displayDebugThreeDXLoader=function(e,t){S=e,_=t};var y=function(e){S&&console.log("3DX Loader >> "+e)},x=function(e,t){_&&console.log("3DX Loader texture not supported >> component: "+e+" format: "+t)},M={indexMap:null,indices:null,positions:null,normals:null},P={1:"vertexPositionArray",2:"vertexNormalArray",4:"vertexUvArray",8:"vertexUv2Array",16:"vertexColorArray",32:"vertexTangentArray",64:"vertexBinormalArray"},C={1:3,2:3,4:2,8:2,16:4,32:3,64:3},b={1:0,2:3,4:6,8:8,16:10,32:14,64:17},D={NEAREST:e.NearestFilter,NEAREST_MIPMAP_NEAREST:e.NearestMipMapNearestFilter,NEAREST_MIPMAP_LINEAR:e.NearestMipMapLinearFilter,LINEAR:e.LinearFilter,LINEAR_MIPMAP_NEAREST:e.LinearMipMapNearestFilter,LINEAR_MIPMAP_LINEAR:e.LinearMipMapLinearFilter},w={REPEAT:e.RepeatWrapping,CLAMP_TO_EDGE:e.ClampToEdgeWrapping,CLAMP_TO_BORDER:e._ClampToBorderWrapping,MIRRORED_REPEAT:e.MirroredRepeatWrapping},E={POINTS:0,LINES:1,TRIANGLES:4},T={Physical:"PhysicalMaterial",Phong:"MeshPhongMaterial",PointBasic:"ParticleBasicMaterial",LineBasic:"LineBasicMaterial",MeshBasic:"MeshBasicMaterial",Visu_Basic:"_CATGraphicalMaterial",DSPBR:"DSPBR19xMaterial",EVisuPBR:"DSPBR19xMaterial",DSPBR2021x:"DSPBR21xMaterial","DSPBR 2021x":"DSPBR21xMaterial","DSPBR 2022x":"DSPBR22xMaterial","DSPBR 2023x":"DSPBR23xMaterial",PDSFX:"DSPBR19xMaterial"},A={NO_INHERIT:0,INHERIT:1,FORCE_INHERIT:2},I=e.MappingType,R=new e.Matrix3,L=function(t){var i=null;return 16==t.length?i=new e.Matrix3(t[0],t[4],t[12],t[1],t[5],t[13],t[3],t[7],t[15]):9==t.length&&(i=new e.Matrix3(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8])),i.isIdentity()?R:i},O={diffuse:"diffuse",emissive:"emissionColor",specular:"specular",opacity:"opacity",glossiness:"roughness",anisotropy:"anisotropy",anisotropyAngle:"anisotropyAngle",metalness:"metalness",fresnelTransparency:"transparency",coatingSpecular:"clearCoatColor",coatingNormalMap:"clearCoatNormal",normalMap:"normal",normalScale:"normalScale",bumpMap:"bump",bumpScale:"bumpScale",displacement:"displacement"},N={normal:"normal",opacity:"opacity",anisotropy:"anisotropy",anisotropyRotation:"anisotropyAngle",displacement:"displacement",thickness:"thickness",albedo:"diffuse",metallic:"metalness",roughness:"roughness",transparency:"transparency",cutoutOpacity:"opacity",translucency:"translucency",translucencyColor:"translucencyColor",sheen:"sheen",sheenColor:"sheenColor",sheenRoughness:"sheenRoughness",specularTint:"specular",specular:"specularContrib",clearcoat:"clearCoat",clearcoatRoughness:"clearCoatRoughness",clearcoatNormal:"clearCoatNormal",emissionColor:"emissionColor",flakeColor:"flakesColor",flakeSize:"flakesSize",flakeCoverage:"flakesCoverage",flakeRoughness:"flakesRoughness",flipFlopColor:"flipFlopColor",flipFlop:"flipFlop",iridescence:"iridescence",iridescenceThickness:"iridescenceThickness"},F=function(e){this.options={},this.isGAS=!0,this.id="",this.data=e};F.prototype.read=function(e,t,i){this.options={visible:e.visible,force:!0,side:e.side,transparent:e.transparent,depthTest:e.depthTest,depthWrite:e.depthWrite},this.id="VIS"+this.options.visible+"S"+this.options.side+"T"+this.options.transparent,this.id+="DT"+this.options.depthTest+"DW"+this.options.depthWrite,void 0!==e.NRECompatibility&&(this.options.NRECompatibility=e.NRECompatibility),e.needTangentBinormal&&(this.options.needTangentBinormal=e.needTangentBinormal),e.alphatTest&&(e.alphaTest=e.alphatTest),e.alphaTest&&(!0===e.alphaTest?this.options.alphaTest=.5:this.options.alphaTest=e.alphaTest),e.vertexColors&&(this.options.vertexColors=e.vertexColors),void 0!==e.iterative&&(this.options.iterative=e.iterative),void 0!==e.sslr&&(this.options.sslr=e.sslr),void 0!==e.useGASColor&&(this.options.useGASColor=!!e.useGASColor)};var V=function(e){this.options={force:!0},this.isGAS=!1,this.data=e,this.id=""};V.prototype.read=function(e,t,i){if(void 0!==e.useGASColor&&(this.options.useGASColor=!!e.useGASColor),void 0!==e.shaderName&&(this.options.shaderName=e.shaderName),void 0!==e.baseMaterial&&(this.options.baseMaterial=e.baseMaterial,this.options.useBaseMaterial=!0),void 0!==e.activeTechnique&&(this.options.activeTechnique=!!e.activeTechnique),void 0!==e.shaderParameters){var r=e.shaderParameters;this.options.shaderParameters={};for(var n=0;n<r.length;n++)if(r[n]&&r[n].parameterName&&r[n].parameterValue)if(r[n].parameterType&&"ParamTypeTexture"===r[n].parameterType){this.data.textures[r[n].parameterValue].texture;this.options.shaderParameters[r[n].parameterName]=valuee}else this.options.shaderParameters[r[n].parameterName]=r[n].parameterValue}};var U=function(e){F.call(this,e)};(U.prototype=Object.create(F.prototype)).buildGenericColor=function(t,i,r,n){if(void 0!==t[i]){var a=t[i];this.options[r]=(new e.Color).setRGB(a[0],a[1],a[2]),null!==n&&(this.id+=n+this.options[r].getStyle())}},U.prototype.buildGenericFloat=function(e,t,i,r){if(void 0!==e[t]){var n=e[t];"shininess"===t&&n<1&&0===(n*=255)&&(n=30),this.options[i]=n,null!==r&&(this.id+=r+this.options[i])}},U.prototype.buildGenericMap=function(e,t,i,r){if(void 0!==e[t]){this.isGAS=!1;var n=this.data.textures[e[t]].texture;this.options[i]=n,this.options.transparent=this.options.transparent||"opacityMap"===i,r&&(this.options[i+"Linear"]=!this.options[i].sRGB)}},U.prototype.read=function(t,i,r){if(F.prototype.read.apply(this,arguments),this.buildGenericFloat(t,"opacity","opacity","O"),this.buildGenericColor(t,"color","color","C"),this.buildGenericColor(t,"ambient","ambient","A"),this.buildGenericColor(t,"emissive","emissive","E"),this.buildGenericColor(t,"specular","specular","SP"),this.buildGenericFloat(t,"shininess","shininess","SH"),this.buildGenericMap(t,"specularMap","specularMap",!0),this.buildGenericMap(t,"opacityMap","opacityMap",!1),void 0!==t.diffuseMap){this.isGAS=!1;var n=this.data.textures[t.diffuseMap];if(this.options.map=n.texture,void 0!==t.diffuseMapBlendFunc?this.options.textureBlending=e.TextureBlendOperations[t.diffuseMapBlendFunc]:this.options.color&&"material"===i.content&&this.options.color.setRGB(1,1,1),n.lods){this.options.map.setAsLOD(i.switchLODTextureCB?i.switchLODTextureCB:r);for(var a=0;a<n.lods.length;a++)this.options.map.lods.push(new e.LODTextureData(n.lods[a].textureData,null,n.lods[a].loadCB,n.lods[a].format,n.lods[a].basisUsage))}}if(void 0!==t.normalMap&&(this.options.normalMap=this.data.textures[t.normalMap].texture,this.options.needTangentBinormal=!0,void 0!==t.needTangentBinormal&&(this.options.needTangentBinormal=t.needTangentBinormal),this.isGAS=!1),void 0!==t.normalMapFlipY&&(this.options.normalMapFlipY=t.normalMapFlipY),void 0!==t.bumpMap&&(this.options.bumpMap=this.data.textures[t.bumpMap].texture,this.isGAS=!1),void 0!==t.normalMapScale&&(this.options.normalScale=t.normalMapScale),void 0!==t.bumpMapScale&&(this.options.bumpScale=t.bumpMapScale),void 0!==t.size&&(this.options.size=t.size),void 0!==t.sizeAttenuation&&(this.options.sizeAttenuation=t.sizeAttenuation),void 0!==t.lineWidth&&(this.options.lineWidth=t.lineWidth),void 0!==t.envMap&&(this.options.envMap=this.data.textures[t.envMap].texture,this.isGAS=!1),void 0!==t.refractionRatio&&(this.options.refractionRatio=t.refractionRatio,this.isGAS=!1),void 0!==t.refractionRatioMap&&(this.options.refractionRatioMap=this.data.textures[t.refractionRatioMap].texture,this.isGAS=!1),this.options.useGASColor=!1,void 0!==t.uv0Transform){this.options.mappingType||(this.options.mappingType=0);var s=t.uv0Transform;this.options.mappingUVTransformation=new e.Matrix3(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8])}};var B=function(e){U.call(this,e),this.isGAS=!1};(B.prototype=Object.create(U.prototype))._startread=function(e,t,i){F.prototype.read.call(this,e,void 0,void 0),this.options.NRECompatibility=!0,this.options.useAlphaFromDiffuseMap=!1},B.prototype.read=function(t,i,r){this._startread(t,i,r);var n=i.version>=4;this.buildGenericColor(t,"DiffuseColor","color",null),this.buildGenericColor(t,"SpecularColor","specular",null),void 0!==t.DiffuseCoeff&&this.options.color.multiplyScalar(t.DiffuseCoeff),void 0!==t.SpecularCoeff&&this.options.specular.multiplyScalar(t.SpecularCoeff),this.buildGenericFloat(t,"TransparencyCoeff","opacity",null),void 0!==this.options.opacity&&(this.options.opacity=1-this.options.opacity,this.options.transparent=this.options.transparent||this.options.opacity<.999),this.buildGenericFloat(t,"ReflectionCoeff","reflectivity",null);var a=e.MaterialUtils.convertShininessToIoRRoughness(t.ShininessCoeff?t.ShininessCoeff:0);if(Object.assign(this.options,a),void 0!==t.UseAlphaChannel&&(this.options.useAlphaFromDiffuseMap=!!t.UseAlphaChannel,this.options.transparent=this.options.transparent||this.options.useAlphaFromDiffuseMap),this.buildGenericMap(t,"Texture","map",null),this.options.textureBlending=e.TextureBlendOperations.REPLACE,this.options.map){var s=this.data.textures[t.Texture];if(s.mapping&&!n){var o=s.mapping;if(o.uvTransform&&(this.options.diffuseUvTransform=L(o.uvTransform)),o.operator){var l=o.operator;this.options.mappingUseFragment=!0,this.options.mappingType=I[l.type],this.options.mappingObjTransformation=new e.Matrix4,l.transform&&(this.options.mappingObjTransformation.elements=l.transform)}o.slot&&(this.options.diffuseUvSlot="TEX_COORD_1"===o.slot?2:1)}void 0!==t.TextureMapping&&(this.options.textureMapping=t.TextureMapping,void 0!==typeof t.ProjectionPlaneS&&(this.options.projectionPlaneS=t.ProjectionPlaneS),void 0!==typeof t.ProjectionPlaneT&&(this.options.projectionPlaneT=t.ProjectionPlaneT)),void 0!==t.TextureFunction&&(this.options.textureBlending=e.TextureBlendOperations[t.TextureFunction])}};var k=function(e){F.call(this,e),this.isGAS=!1};(k.prototype=Object.create(F.prototype)).buildGenericPhysicalColorOptions=function(t,i,r,n,a){if(void 0!==t[i]){var s=t[i];if(s.length)return void(this.options[r]=(new e.Color).setRGB(s[0],s[1],s[2]));if(void 0!==s.value){var o=s.value;this.options[r]=(new e.Color).setRGB(o[0],o[1],o[2])}else null!==a&&(this.options[r]=a);if(void 0!==s.texture){var l=s.texture;void 0===s.value&&(this.options[r]=(new e.Color).setRGB(1,1,1));var c=this.data.textures[l];if(this.options[r+"Map"]=c.texture,!c.isSupported&&x(i,c.format),n&&c.mapping){var h=c.mapping;if(h.uvTransform&&(this.options[r+"UvTransform"]=L(h.uvTransform)),h.operator){var u=h.operator;this.options.mappingUseFragment=!0,this.options.mappingType=I[u.type],this.options.mappingObjTransformation=new e.Matrix4,u.transform&&(this.options.mappingObjTransformation.elements=u.transform)}h.slot&&(this.options[r+"UvSlot"]="TEX_COORD_1"===h.slot?2:1)}}if(void 0!==s.MADCoefficients){var d=s.MADCoefficients;this.options[r+"MulCoef"]=new e.Vector3(d[0],d[1],d[2]),this.options[r+"AddCoef"]=new e.Vector3(d[3],d[4],d[5])}}else null!==a&&(this.options[r]=a)},k.prototype.buildGenericPhysicalFloatOptions=function(t,i,r,n,a){if(void 0!==t[i]){var s=t[i];if("object"!=typeof s)return void(this.options[r]=s);if(void 0!==s.value){var o=s.value;this.options[r]=o}else null!==a&&(this.options[r]=a);if(void 0!==s.texture){var l=s.texture;void 0===s.value&&(this.options[r]=1),this.options.transparent=this.options.transparent||"opacity"===r||"transparency"===r;var c=this.data.textures[l];if(this.options[r+"Map"]=c.texture,!c.isSupported&&x(i,c.format),n&&c.mapping){var h=c.mapping;if(h.uvTransform&&(this.options[r+"UvTransform"]=L(h.uvTransform)),h.operator){var u=h.operator;this.options.mappingUseFragment=!0,this.options.mappingType=I[u.type],this.options.mappingObjTransformation=new e.Matrix4,u.transform&&(this.options.mappingObjTransformation.elements=u.transform)}h.slot&&(this.options[r+"UvSlot"]="TEX_COORD_1"===h.slot?2:1)}}if(void 0!==s.MADCoefficients){var d=s.MADCoefficients;this.options[r+"MulCoef"]=d[0],this.options[r+"AddCoef"]=d[1]}}else null!==a&&(this.options[r]=a)},k.prototype.buildGenericPhysicalFloat2Options=function(t,i,r,n,a){if(void 0!==t[i]){var s=t[i];if(void 0!==s.value){var o=s.value;this.options[r]="number"==typeof o?new e.Vector2(o,o):new e.Vector2(o[0],o[1])}else null!==a&&(this.options[r]=a);if(void 0!==s.texture){var l=s.texture;void 0===s.value&&(this.options[r]=new e.Vector2(1,1));var c=this.data.textures[l];if(this.options[r+"Map"]=c.texture,!c.isSupported&&x(i,c.format),n&&c.mapping){var h=c.mapping;if(h.uvTransform&&(this.options[r+"UvTransform"]=L(h.uvTransform)),h.operator){var u=h.operator;this.options.mappingUseFragment=!0,this.options.mappingType=I[u.type],this.options.mappingObjTransformation=new e.Matrix4,u.transform&&(this.options.mappingObjTransformation.elements=u.transform)}h.slot&&(this.options[r+"UvSlot"]="TEX_COORD_1"===h.slot?2:1)}}if(void 0!==s.MADCoefficients){var d=s.MADCoefficients;this.options[r+"MulCoef"]=d[0],this.options[r+"AddCoef"]=d[1]}}else null!==a&&(this.options[r]=a)},k.prototype.buildGenericPhysicalMapOptions=function(t,i,r,n){var a=i+"Map";if(void 0!==t[a]){var s=t[a],o=this.data.textures[s];if(this.options[r+"Map"]=o.texture,!o.isSupported&&x(i,o.format),n&&o.mapping){var l=o.mapping;if(l.uvTransform&&(this.options[r+"UvTransform"]=L(l.uvTransform)),l.operator){var c=l.operator;this.options.mappingUseFragment=!0,this.options.mappingType=I[c.type],this.options.mappingObjTransformation=new e.Matrix4,c.transform&&(this.options.mappingObjTransformation.elements=c.transform)}l.slot&&(this.options[r+"UvSlot"]="TEX_COORD_1"===l.slot?2:1)}}void 0!==t[i+"MapFlipY"]&&(this.options[i+"MapFlipY"]=t[i+"MapFlipY"])},k.prototype._startread=function(e,t,i){var r=t.version>=4;F.prototype.read.call(this,e,void 0,void 0),this.options.NRECompatibility=!0,this.options.useAlphaFromDiffuseMap=!1,this.buildGenericPhysicalMapOptions(e,"normal","normal",!r)},k.prototype._endread=function(t,i,r){if(void 0!==t.uv0Transform){var n=t.uv0Transform;this.options.mappingUVTransformation=new e.Matrix3(n[0],n[3],n[6],n[1],n[4],n[7],n[2],n[5],n[8])}},k.prototype.read=function(t,i,r){var n=i.version>=4;if(this._startread(t,i,r),void 0!==t.useAlphaDiffuseChannel&&(this.options.useAlphaFromDiffuseMap=t.useAlphaDiffuseChannel,this.options.transparent=this.options.transparent||this.options.useAlphaFromDiffuseMap),this.options.color=(new e.Color).setRGB(0,0,0),void 0!==t.diffuse){void 0!==t.diffuse.value&&(this.options.color=(new e.Color).setRGB(t.diffuse.value[0],t.diffuse.value[1],t.diffuse.value[2]));var a=t.diffuse.texture;if(void 0!==a){var s=this.data.textures[a];if(!s.isSupported&&x("diffuse",s.format),this.options.map=s.texture,s.lods){this.options.map.setAsLOD(i.switchLODTextureCB?i.switchLODTextureCB:r);for(var o=0;o<s.lods.length;o++)this.options.map.lods.push(new e.LODTextureData(s.lods[o].textureData,null,s.lods[o].loadCB,s.lods[o].format,s.lods[o].basisUsage))}var l=this.data.textures[a].mapping;l&&!n&&(l.uvTransform&&(this.options.diffuseUvTransform=L(l.uvTransform)),l.operator&&(this.options.mappingUseFragment=!0,this.options.mappingType=I[l.operator.type],this.options.mappingObjTransformation=new e.Matrix4,l.operator.transform&&(this.options.mappingObjTransformation.elements=l.operator.transform)),l.slot&&(this.options.diffuseUvSlot="TEX_COORD_1"===l.slot?2:1))}void 0!==t.diffuse.MADCoefficients&&(this.options.diffuseMulCoef=new e.Vector3(t.diffuse.MADCoefficients[0],t.diffuse.MADCoefficients[1],t.diffuse.MADCoefficients[2]),this.options.diffuseAddCoef=new e.Vector3(t.diffuse.MADCoefficients[3],t.diffuse.MADCoefficients[4],t.diffuse.MADCoefficients[5]))}this.buildGenericPhysicalColorOptions(t,"emissive","emissionColor",!n,(new e.Color).setRGB(0,0,0)),this.options.emissionValue=1,this.buildGenericPhysicalColorOptions(t,"specular","specular",!n,(new e.Color).setRGB(.04,.04,.04)),this.buildGenericPhysicalColorOptions(t,"coatingSpecular","clearCoatColor",!n,(new e.Color).setRGB(.04,.04,.04)),this.buildGenericPhysicalColorOptions(t,"flakesColor","flakesColor",!1,(new e.Color).setRGB(0,0,0)),this.options.flakesColorMulCoef=new e.Vector3(.12,.12,.12),this.options.flakesColorAddCoef=new e.Vector3(0,0,0),this.buildGenericPhysicalColorOptions(t,"pearlFlakesColor","pearlFlakesColor",!1,(new e.Color).setRGB(0,0,0)),this.options.pearlFlakesColorMulCoef=new e.Vector3(.08,.08,.08),this.options.pearlFlakesColorAddCoef=new e.Vector3(0,0,0),this.buildGenericPhysicalFloatOptions(t,"opacity","opacity",!n,1),this.buildGenericPhysicalFloatOptions(t,"glossiness","glossiness",!n,1),this.buildGenericPhysicalFloatOptions(t,"anisotropy","anisotropy",!n,0),this.buildGenericPhysicalFloatOptions(t,"anisotropyAngle","anisotropyAngle",!n,0),this.buildGenericPhysicalMapOptions(t,"bump","bump",!n),this.buildGenericPhysicalFloatOptions(t,"bumpScale","bumpScale",!n,1),this.buildGenericPhysicalFloatOptions(t,"metalness","metalness",!n,0),this.options.specGlossNRE=this.options.metalness<1e-6,this.buildGenericPhysicalFloatOptions(t,"fresnelTransparency","transparency",!n,0),this.buildGenericPhysicalFloatOptions(t,"coating","clearCoat",!1,!1),this.buildGenericPhysicalMapOptions(t,"coatingNormal","clearCoatNormal",!n),this.buildGenericPhysicalFloatOptions(t,"coatingGlossiness","coatingGlossiness",!1,1),this.buildGenericPhysicalFloatOptions(t,"proceduralCoating","orangePeel",!1,!1),this.buildGenericPhysicalFloatOptions(t,"coatingNormalBump","clearCoatNormalScale",!1,0),this.buildGenericPhysicalFloatOptions(t,"coatingNormalScale","orangePeelScale",!1,0),this.buildGenericPhysicalFloatOptions(t,"flakes","flakes",!1,!1),this.buildGenericPhysicalFloatOptions(t,"flakesScale","flakesScale",!1,.5),this.buildGenericPhysicalFloatOptions(t,"flakesBump","flakesBump",!1,1),this.buildGenericPhysicalFloatOptions(t,"flakesRoughness","flakesRoughness",!1,.25),this.buildGenericPhysicalFloatOptions(t,"flakesDensity","flakesDensity",!1,1),this.buildGenericPhysicalFloatOptions(t,"pearlFlakesBump","pearlFlakesBump",!1,1),this.buildGenericPhysicalFloatOptions(t,"pearlFlakesDensity","pearlFlakesDensity",!1,1),this.buildGenericPhysicalFloat2Options(t,"normalScale","normalScale",!n,null),this.buildGenericPhysicalFloatOptions(t,"diffuseAlpha","alphaToCoverage",!1,null),this.buildGenericPhysicalFloatOptions(t,"displacement","displacement",!n,null);var c=t.displacement;if(c&&void 0!==c.MADCoefficients){var h=c.MADCoefficients;this.options.displacementScale=h[0],this.options.displacementBias=h[1]}this._endread(t,i,r)};var G=function(e,t){k.call(this,e),this.is19x=t.is19x,this.is21x=t.is21x,this.is22x=t.is22x,this.is23x=t.is23x};(G.prototype=Object.create(k.prototype)).buildGenericPhysicalMapOptions=function(t,i,r,n){if(void 0!==t[i]){var a=t[i];if(void 0!==a.texture){var s=a.texture,o=this.data.textures[s];if(this.options[r+"Map"]=o.texture,!o.isSupported&&x(i,o.format),n&&o.mapping){var l=o.mapping;if(l.uvTransform&&(this.options[r+"UvTransform"]=L(l.uvTransform)),l.operator){var c=l.operator;this.options.mappingUseFragment=!0,this.options.mappingType=I[c.type],this.options.mappingObjTransformation=new e.Matrix4,c.transform&&(this.options.mappingObjTransformation.elements=c.transform)}l.slot&&(this.options[r+"UvSlot"]="TEX_COORD_1"===l.slot?2:1)}}if(void 0!==a.MADCoefficients){var h=a.MADCoefficients;this.options[r+"MulCoef"]=new e.Vector3(h[0],h[1],h[2]),this.options[r+"AddCoef"]=new e.Vector3(h[3],h[4],h[5])}void 0!==t[i+"MapFlipY"]&&(this.options[i+"MapFlipY"]=t[i+"MapFlipY"])}},G.prototype.read=function(t,i,r){var n=i.version>=4;if(this._startread(t,i,r),void 0!==t.cutoutFromAlbedoAlpha?(this.options.useAlphaFromDiffuseMap=t.cutoutFromAlbedoAlpha,this.options.transparent=this.options.transparent||this.options.useAlphaFromDiffuseMap):this.options.useAlphaFromDiffuseMap=!1,void 0!==t.albedo){void 0!==t.albedo.value&&(this.options.color=(new e.Color).setRGB(t.albedo.value[0],t.albedo.value[1],t.albedo.value[2]));var a=t.albedo.texture;if(void 0!==a){var s=this.data.textures[a];!s.isSupported&&x("albedo",s.format),this.options.map=s.texture;var o=s.mapping;o&&!n&&(o.uvTransform&&(this.options.diffuseUvTransform=L(o.uvTransform)),o.operator&&(this.options.mappingUseFragment=!0,this.options.mappingType=I[o.operator.type],this.options.mappingObjTransformation=new e.Matrix4,o.operator.transform&&(this.options.mappingObjTransformation.elements=o.operator.transform)),o.slot&&(this.options.diffuseUvSlot="TEX_COORD_1"===o.slot?2:1))}void 0!==t.albedo.MADCoefficients&&(this.options.diffuseMulCoef=new e.Vector3(t.albedo.MADCoefficients[0],t.albedo.MADCoefficients[1],t.albedo.MADCoefficients[2]),this.options.diffuseAddCoef=new e.Vector3(t.albedo.MADCoefficients[3],t.albedo.MADCoefficients[4],t.albedo.MADCoefficients[5]))}this.buildGenericPhysicalFloatOptions(t,"metallic","metalness",!n,null),this.buildGenericPhysicalFloatOptions(t,"roughness","roughness",!n,0),this.buildGenericPhysicalFloatOptions(t,"anisotropy","anisotropy",!n,0),this.buildGenericPhysicalFloatOptions(t,"anisotropyRotation","anisotropyAngle",!n,0),this.buildGenericPhysicalFloatOptions(t,"transparency","transparency",!n,0),this.buildGenericPhysicalFloatOptions(t,"cutoutOpacity","opacity",!n,1),this.buildGenericPhysicalFloatOptions(t,"thickness","thickness",!n,0),(this.is19x||this.is21x)&&this.buildGenericPhysicalFloatOptions(t,"sheen","sheen",!n,0),this.is19x?void 0!==t.sheenMode&&(this.options.sheenMode=t.sheenMode):(this.buildGenericPhysicalFloatOptions(t,"translucency","translucency",!n,0),this.buildGenericPhysicalMapOptions(t,"displacement","displacement",!n),this.buildGenericPhysicalFloatOptions(t,"subsurfaceAnisotropy","subsurfaceAnisotropy",!1,0),this.is21x?(this.buildGenericPhysicalColorOptions(t,"sheenColor","sheenColor",!0,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalFloatOptions(t,"sheenRoughness","sheenRoughness",!0,.3)):(this.buildGenericPhysicalColorOptions(t,"sheenColor","sheenColor",!n,(new e.Color).setRGB(0,0,0)),this.buildGenericPhysicalFloatOptions(t,"sheenRoughness","sheenRoughness",!n,.5),this.buildGenericPhysicalColorOptions(t,"flipFlopColor","flipFlopColor",!n,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalFloatOptions(t,"flipFlop","flipFlop",!n,0),void 0!==t.subtype&&(this.options._subtype=e.DSPBRSubTypes[t.subtype]),this.is22x||(this.buildGenericPhysicalColorOptions(t,"translucencyColor","translucencyColor",!n,(new e.Color).setRGB(0,0,0)),this.buildGenericPhysicalFloatOptions(t,"iridescence","iridescence",!n,0),this.buildGenericPhysicalFloatOptions(t,"iridescenceThickness","iridescenceThickness",!n,1),this.buildGenericPhysicalFloatOptions(t,"iridescenceIoR","iridescenceIoR",!1,1.5)))),this.buildGenericPhysicalFloatOptions(t,"specular","specularContrib",!n,1),this.buildGenericPhysicalColorOptions(t,"specularTint","specular",!n,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalFloatOptions(t,"clearcoat","clearCoat",!n,0),this.buildGenericPhysicalFloatOptions(t,"clearcoatRoughness","clearCoatRoughness",!n,0),this.buildGenericPhysicalMapOptions(t,"clearcoatNormal","clearCoatNormal",!n),void 0!==t.orangePeel&&(this.options.orangePeel=t.orangePeel),this.buildGenericPhysicalFloatOptions(t,"orangePeelScale","orangePeelScale",!1,0),this.buildGenericPhysicalColorOptions(t,"emissionColor","emissionColor",!n,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalFloatOptions(t,"emissionValue","emissionValue",!1,0),this.options.emissionNormalized=!1,void 0!==t.emissionEnergyNormalization&&(this.options.emissionNormalized=t.emissionEnergyNormalization),this.options.thinWalled=!0,void 0!==t.thinWalled&&(this.options.thinWalled=t.thinWalled),this.buildGenericPhysicalFloatOptions(t,"ior","ior",!1,1.5),this.buildGenericPhysicalColorOptions(t,"attenuationColor","attenuationColor",!1,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalColorOptions(t,"subsurfaceColor","subsurfaceColor",!1,(new e.Color).setRGB(0,0,0)),this.buildGenericPhysicalFloatOptions(t,"attenuationDistance","attenuationDistance",!1,1e6),this.buildGenericPhysicalColorOptions(t,"flakeColor","flakesColor",!n,(new e.Color).setRGB(1,1,1)),this.buildGenericPhysicalFloatOptions(t,"flakeSize","flakesSize",!n,.5),this.buildGenericPhysicalFloatOptions(t,"flakeCoverage","flakesCoverage",!n,0),this.buildGenericPhysicalFloatOptions(t,"flakeRoughness","flakesRoughness",!n,0),this._endread(t,i,r)},G.prototype._endread=function(t,i,r){if(void 0!==t.uv0Transform){this.options.mappingType||(this.options.mappingType=0);var n=t.uv0Transform;this.options.mappingUVTransformation=new e.Matrix3(n[0],n[3],n[6],n[1],n[4],n[7],n[2],n[5],n[8])}};return function(t){var m=performance.now();this.mode=void 0,this.sharedBuffers=!1,this.noMeshInRAM=!1,this.baseUrl="",this.modelsToLoad={},this.loadIndex=0,this.nbModelsToLoad=0,this.extensionsRequired=new Set,this.extensionsUsed=new Set,this.globalOldFlipTexture=!1,this.SSBMinNbReps=1,this.SSBMinNbTriangles=1e3,this.capture=!1,this.warnCount=0;var S=this,_=e.MaterialUtils.createShinyFaceMaterial({side:e.DoubleSide,color:new e.Color(16777215)}),x=new e.MeshBasicMaterial({color:new e.Color(16777215)});this._zipReaders=[],this.getURI=function(e,t){var i="";if("http://"===e.substring(0,7))i=e;else if("https://"===e.substring(0,8))i=e;else if("/"===e.substring(0,1))i=e;else{var r=t;if("blob:"===t.substring(0,5)||"/"===t){var n=(r=location.href).indexOf("?");-1!==n&&(r=r.substring(0,n));var a=r.lastIndexOf("/");-1!==a&&(r=r.substring(0,a+1))}i=r+e}return i},this.getEntryFile=function(e,t,i){"blob"===t?e.getData(new f.BlobWriter).then(i):"arraybuffer"===t?e.getData(new f.Uint8ArrayWriter).then(i):e.getData(new f.TextWriter).then(i)},this.createAmbience=function(t,i,r){var n=["WhiteDesign","BlueDesign","DarkDesign","Studio","PureWhite","WhiteMirror","WhiteReview","DarkMirror","DarkReview","Outdoor","Indoor","City","Road","NeoPureWhite"],a=t.ambiance,s=null;if(!a)return!0;if(i.destinationNode)for(var o=i.destinationNode,l=0;l<o._occurrences.length;l++){var c=o._occurrences[l];c.parent,c.scene3js&&(s=c.scene3js.viewer)}if(a.name&&-1===n.indexOf(a.name)&&a.directionalLights)for(l=0;l<a.directionalLights.length;l++)t.lightInstances&&t.lightInstances.length||(t.lightInstances=[]),a.directionalLights[l].castShadows=a.directionalLights[l].castShadows&&!g,a.directionalLights[l].ambianceTransform=a.transform,t.lightInstances.push(a.directionalLights[l]);if(s&&(s.setAmbientLight(0),s.setIntensityCorrection(!0),s.useDefaultLights&&(s.setTriLights(!1),s.directionalLight.intensity=0,s.directionalLight2.intensity=0),s.renderer.ToneMappingEffect&&s.renderer.ToneMappingEffect.setToneMapping(2),a.name&&-1!==n.indexOf(a.name))){var h=s.setVisuEnvOCA(a.name,r,{from3dx:!0});return a.backgroundGeometry&&a.backgroundGeometry.size&&s.ambience.getBackgroundGeometry().setSize(a.backgroundGeometry.size),h}var u,d=null,f=null;if(a.background&&"gradient"==a.background.type){var m=a.background.colors[0];a.background.colors[0]=a.background.colors[1],a.background.colors[1]=m}a.background&&void 0!==a.background.image&&(_=i.data.images[a.background.image]).data&&(d={data:window.URL.createObjectURL(_.data),format:_.format});var g=!1,v=r;if(a.unitScale=i.rootMatrix?i.rootMatrix.getMaxScaleOnAxis():1,a.environmentLight&&void 0!==a.environmentLight.light){var S;a.environmentLight.matrix&&(S=a.environmentLight.matrix);var _,y=i.json.lights[a.environmentLight.light],x=y.image;(_=i.data.images[x])&&_.data&&(f={data:window.URL.createObjectURL(_.data),format:_.format}),a.environmentLight=y,S&&(a.environmentLight.matrix=S),g=!0;var M=this.extensionsRequired.has("EXT_IBL_Preconvolved")&&this.extensionsUsed.has("EXT_IBL_Preconvolved")&&t.extensions.EXT_IBL_Preconvolved;if(M&&s){u=new e.Texture;var P=M.GGX,C=M.Lambert;if(!P||!C)throw"Invalid EXT_IBL_Preconvolved extension usage: missing brdf";if(C.image=i.data.images[C.image],"hdr"!==C.image.format)throw"Invalid EXT_IBL_Preconvolved extension usage: not hdr";var b={textures:[],ggxMapping:P.roughnessMapping,ggx0:P.useOriginalAsZero};if(6!==P.mips.length)throw"Invalid EXT_IBL_Preconvolved extension usage: missing mips";for(l=0;l<P.mips.length;l++){if(P.mips[l].image=i.data.images[P.mips[l].image],"hdr"!==P.mips[l].image.format)throw"Invalid EXT_IBL_Preconvolved extension usage: not hdr";b.textures.push(P.mips[l].image)}b.textures.push(C.image),v=function(){for(var t=0,i=function(){7==++t&&s.ambience._solveSceneRoughnessMap(b,r)},n=0;n<b.textures.length;n++){var a=window.URL.createObjectURL(b.textures[n].data),o=e.ImageUtils.loadHDRTexture(a,new e.LatLongEnvMapping,i,null,!1,!1);o.minFilter=e.NearestFilter,o.magFilter=e.NearestFilter,b.textures[n]=o}}}}a.ground&&"physical"==a.ground.type&&void 0!==a.ground.material&&void 0!==i.data.materials[l]&&(a.ground.material=i.data.materials[l]);var D=a.renderSettings;s&&D&&(void 0===D.type||"rasterizer"===D.type)&&(D.ambientOcclusion&&D.ambientOcclusion.activation&&(s.setSSAOParameters({dynamicRadius:!1,adaptativeRadius:!0,radius:D.ambientOcclusion.radius?D.ambientOcclusion.radius:100,radiusMin:.005,radiusMax:.12,minPixelRadius:14,attenuation:.984,contrast:D.ambientOcclusion.intensity?D.ambientOcclusion.intensity:1,power:1,thresholdAngle:1.32645023152}),s.setSSAO(!0)),D.reflection&&D.reflection.activation&&s.setSSLR(!0));var w=new p({viewer:s,ambiance:a,images:{background:d,environmentLight:f},from3DX:!0,doneCallback:v,roughnessMap:u});return s&&s.setAmbience(w),!w.isTextureLoading()},this.createImages=function(e,t,i,r){var n=this;if(!e||t>=e.length)r&&r(i);else{var a=e[t],s=a.format?a.format.toLowerCase():"",o=a.usage?a.usage:"NOT_BASIS";if("png"===s||"jpeg"===s||"jpg"===s||"dds"===s||"hdr"===s||"basis"===s||"ktx2"===s||""===s&&a.uid){var l="image/"+s;"dds"!==s&&"hdr"!==s&&"basis"!==s&&"ktx2"!==s||(l="arraybuffer");var c=i.json.binaries?i.json.binaries[a.binary]:null,h=i.data.chunks[a.binary];if(h){var u=h.buffer?h.buffer:h,d=h.byteOffset?h.byteOffset:0,p=new Uint8Array(u,d+a.byteOffset,a.byteLength),f=new Blob([p],{type:l});i.data.images.push({uri:c.extUri?c.extUri:c.uri,uid:a.uid,data:f,format:s,usage:o}),this.createImages(e,t+1,i,r.bind(this))}else if(c){var m={uri:c.extUri?c.extUri:c.uri,width:a.width,height:a.height,format:s,usage:o};i.data.images.push(m),i.binaryCallback?i.binaryCallback(m.uri,function(a,s){s&&(l="image/"+s,"dds"!==s&&"hdr"!==s&&"basis"!==s&&"ktx2"!==s||(l="arraybuffer"),m.format=s);var o=new Blob([a],{type:l});m.data=o,n.createImages(e,t+1,i,r.bind(this))}):this.createImages(e,t+1,i,r.bind(this))}else m={uri:null,format:s,usage:o},a.uid&&i.resourcesLibrary?m.uid=a.uid:(this.warnCount<5&&(console.warn("bad 3dx file"),this.warnCount++),p=new Uint8Array,f=new Blob([p],{type:"image/png"}),m.data=f),i.data.images.push(m),this.createImages(e,t+1,i,r.bind(this))}}},this.createBuffers=function(e,t){if(e)for(var i=0;i<e.length;i++){var r=e[i],n=t.data.chunks[r.binary],a=n.buffer?n.buffer:n,s=n.buffer?n.byteOffset+r.byteOffset:r.byteOffset;if(r.format){if("UNSIGNED_SHORT"===r.format)h=new Uint16Array(a,s,r.byteLength/2);else if("UNSIGNED_INT"===r.format)h=new Uint32Array(a,s,r.byteLength/4);else if("UNSIGNED_BYTE"===r.format){var o=new Uint8Array(a,s,r.byteLength);h=new Uint16Array(r.byteLength);for(var l=0;l<r.byteLength;l++)h[l]=o[l]}t.data.buffers.push(h)}else if(r.attributes){var c=P[r.attributes];if(c){var h=new Float32Array(a,s,r.byteLength/4);t.data.buffers.push({attribute:c,buffer:h})}else{o=new Float32Array(a,s,r.byteLength/4);var u=[];t.data.buffers.push(u);var d=0;for(var l in P)r.attributes&l&&(d+=C[l]);var p=o.length/d;for(var l in P)if(r.attributes&l){for(var f=C[l],m=(h=new Float32Array(p*f),{attribute:P[l],buffer:h}),g=b[l],v=0;v<p;v++){for(var S=0;S<f;S++)h[v++]=o[g+S];g+=d}u.push(m)}}}else r.geometricType?(h=new Uint32Array(a,s,r.byteLength/4),t.data.buffers.push({geometricType:r.geometricType,buffer:h})):(h=new Uint8Array(a,s,r.byteLength),t.data.buffers.push({buffer:h}))}},this.getBuffers=function(e,t,i,r,n){if(e){var a=e[i],s=t.data.chunks[a.binary],o=s.buffer?s.buffer:s,l=s.buffer?s.byteOffset+a.byteOffset:a.byteOffset;if(a.format){if("UNSIGNED_SHORT"===a.format)u=new Uint16Array(o,l,a.byteLength/2);else if("UNSIGNED_INT"===a.format)u=new Uint32Array(o,l,a.byteLength/4);else if("UNSIGNED_BYTE"===a.format){var c=new Uint8Array(o,l,a.byteLength);u=new Uint16Array(a.byteLength);for(var h=0;h<a.byteLength;h++)u[h]=c[h]}return u}if(r){if(1==r.length){if("UNSIGNED_SHORT"===(m=r[0]).format)u=new Uint16Array(o,l,a.byteLength/2);else if("UNSIGNED_INT"===m.format)u=new Uint32Array(o,l,a.byteLength/4);else if("UNSIGNED_BYTE"===m.format)for(c=new Uint8Array(o,l,a.byteLength),u=new Uint16Array(a.byteLength),h=0;h<a.byteLength;h++)u[h]=c[h];else u=new Float32Array(o,l,a.byteLength/4);return u}var u=new Float32Array(o,l,a.byteLength/4),d=[],p=0;for(var h in r)p+=r[h].dimension;var f=u.length/p;for(var h in r){var m=r[h];d[h]=new Float32Array(f*m.dimension)}var g=0;for(var h in r){i=0,m=r[h];for(var v=0;v<f;v++)for(var S=0;S<m.dimension;S++)d[h][i++]=u[v*p+g+S];g+=m.dimension}return d}return n?{geometricType:n,buffer:u=new Uint32Array(o,l,a.byteLength/4)}:u=new Uint8Array(o,l,a.byteLength)}},this.getGenericBuffer=function(e,t,i,r){if(e){var n,a=e[i],s=t.data.chunks[a.binary],o=s.buffer?s.buffer:s,l=s.buffer?s.byteOffset+a.byteOffset:a.byteOffset;switch(r){case"Float32":n=new Float32Array(o,l,a.byteLength/4);break;case"Uint32":n=new Uint32Array(o,l,a.byteLength/4);break;default:n=new Uint8Array(o,l,a.byteLength)}return n}},this.onImageLoaded=function(e){e.data.nbImagesToLoad--,!e.data.nbImagesToLoad&&e.onTexturesLoadedCB&&e.onTexturesLoadedCB()},this._createTemporaryMap=function(t){var i;switch(t){case"dds":case"basis":case"ktx2":i=new e.CompressedTexture;break;case"hdr":i=new e.DataTexture;break;default:i=new e.Texture}return i.loadEndStatus=e.AssetLoadingStatus.LOADING,i},this._loadGenericTexture=function(t,i,r,n,a,s,o){var l=o;return"dds"===t?l=e.ImageUtils.loadCompressedTexture(r,null,a(s,n?r:null),a(s,n?r:null),!0,!1,o):"hdr"===t?l=e.ImageUtils.loadHDRTexture(r,null,a(s,n?r:null),a(s,n?r:null),!0,!1,!0,!1,!1,o):"basis"===t?l=e.ImageUtils.loadBasisTexture(r,null,a(s,n?r:null),a(s,n?r:null),!0,e.BasisUsage[i],!1,o):"ktx2"===t?l=e.ImageUtils.loadKTX2Texture(r,null,a(s,n?r:null),a(s,n?r:null),!0,e.BasisUsage[i],!1,o):(l=e.ImageUtils.loadTexture(r,null,a(s,n?r:null),a(s,n?r:null),void 0,!s||s&&s.forcePowerOfTwo,!1,o)).flipY=!0,l},this._loadImage=function(t,i,r,n){var a,s,o,l=t.data.images[r],c=l.format,h=!1,u=null;return i?(u=l.uri,s=l.width,o=l.height):((l.uri||l.uid)&&t.resourcesLibrary&&(u=t.resourcesLibrary.getImage(l.uid?l.uid:l.uri)),u||(l.data?(a=window.URL.createObjectURL(l.data),h=!0):l.uri?a=l.uri:(this.warnCount<5&&(console.warn("3DSync: uid not in cache and no binary buffer attached"),this.warnCount++),t.resourcesLibrary&&l.uid&&(u=this._createTemporaryMap(c),t.resourcesLibrary.addImageToRequest(l.uid,u,c))),u||(u=this._loadGenericTexture(c,l.usage,a,h,n,t)),u._source=e.AssetSource.MATERIAL_MANAGER,(l.uri||l.uid)&&t.resourcesLibrary&&t.resourcesLibrary.addImage(l.uid?l.uid:l.uri,u))),{uri:l.uri,uid:l.uid,isSupported:"png"===c||"jpeg"===c||"jpg"===c||"dds"===c||"hdr"===c||"basis"===c||"ktx2"===c,map:u,width:s,height:o,format:c,basisUsage:l.usage?e.BasisUsage[l.usage]:-1}},this.createTextures=function(t,i){if(t){for(var r=this,n={},a=0;a<t.length;a++)if(n[(y=t[a]).image]||(n[y.image]=[],!i.imagesCallback&&i.data.images[y.image]&&i.data.nbImagesToLoad++),n[y.image].push({texture:a,lod:-1}),y.lods)for(var s=0;s<y.lods.length;s++){var o=y.lods[s];n[o]||(n[o]=[]),n[o].push({texture:a,lod:s})}for(var l in n){var c,h,u=!0,d="",p=null,f=null,m=null,g=-1;if(i.imagesCallback)p=i.imagesCallback(y,i);else{var v=n[l][0].lod>=0,S=this._loadImage(i,v,l,function(e,t){return function(){r.onImageLoaded(e),t&&window.URL.revokeObjectURL(t)}});u=S.isSupported,d=S.format,p=S.map,f=S.uri,m=S.uid,c=S.width,h=S.height,g=S.basisUsage}var _=n[l];for(s=0;s<_.length;s++){var y=t[_[s].texture],x=p;if(-1===_[s].lod){var M=w[y.uWrap]||1e3,P=w[y.vWrap]||1e3,C="CLAMP_TO_BORDER"===y.uWrap||"CLAMP_TO_BORDER"===y.vWrap,b=y.anisotropy||8,E=D[y.minFilter]||1008,T=D[y.magFilter]||1006,A=y.borderColor,I=null;C&&(I=A?new e.Vector4(A[0],A[1],A[2],A[3]):new e.Vector4(0,0,0,1)),1003!==T&&1006!==T&&(T=1006);var R=y.repeat||{x:1,y:1},L=(d=i.json.images[y.image].format,"jpg"===y.format||"jpeg"===y.format);L||"jpg"!==d&&"jpeg"!==d||(L=!0);var O=e.AssetSource.MATERIAL_MANAGER,N=null;(f||m)&&i.resourcesLibrary&&(N=i.resourcesLibrary.getTexture(m||f,{wrapS:M,wrapT:P,anisotropy:b,minFilter:E,magFilter:T,borderColor:I,repeat:R,sRGB:L,source:O})),N?x=N:((f||m)&&i.resourcesLibrary&&void 0===(x=p.clone()).data&&(x.needsUpdate=!1),x.wrapS=M,x.wrapT=P,x.anisotropy=b,x.minFilter=E,x.magFilter=T,x.borderColor=I,x.repeat=R,x.sRGB=L,x._source=O,(f||m)&&i.resourcesLibrary&&i.resourcesLibrary.addTexture(m||f,x,{wrapS:M,wrapT:P,anisotropy:b,minFilter:E,magFilter:T,borderColor:I,repeat:R,sRGB:L,source:O}));var F={isSupported:u,format:d,texture:x,mapping:y.mapping};i.data.textures[_[s].texture]=F}else(F=i.data.textures[_[s].texture]).lods||(F.lods=[]),F.lods.push({textureData:{texture:x,width:c,height:h,format:d,basisUsage:g},loadCB:this.loadLODTextureCB})}}}},this.loadLODTextureCB=function(t){var r,n=i.parseUrl(this.imageData.texture);switch(n=""===n.protocol?S.baseUrl+n.source:n.source,this.imageData.format){case"basis":r=e.ImageUtils.loadBasisTexture(n,null,null,null,!0,this.imageData.basisUsage);break;case"ktx2":r=e.ImageUtils.loadKTX2Texture(n,null,null,null,!0,this.imageData.basisUsage);default:(r=e.ImageUtils.loadTexture(n,null,void 0,void 0,!0,!0)).flipY=!0}return r._source=e.AssetSource.MATERIAL_MANAGER,t&&(r.wrapS=t.wrapS,r.wrapT=t.wrapT,r.anisotropy=t.anisotropy,r.minFilter=t.minFilter,r.magFilter=t.magFilter,r.borderColor=t.borderColor?t.borderColor.clone():null,r.repeat=t.repeat,r.sRGB=t.sRGB),r},this.switchLODTextureCB=function(t){var i=t.matrix,r=t.bSphere,n=r.radius*i.getMaxScaleOnAxis(),a=new e.Vector3;r?a.copy(r.center):a.set(0,0,0),a.applyMatrix4(i);var s,o,l=t.camera.matrixWorldInverse.elements,c=Math.abs(l[2]*a.x+l[6]*a.y+l[10]*a.z+l[14])-n,h=e.glStates.currentHeight/Math.tan(.5*t.camera.fov*Math.PI/180)*n/Math.abs(c);if(h<Math.min(t.texture.image.width,t.texture.image.height))return-1;for(s=0;s<t.lods.length&&(o=t.lods[s],!(h<Math.min(o.imageData.width,o.imageData.height)));s++);return s===t.lods.length?s-1:s},this.createMappingDescriptions=function(t,i,r){if(t)for(var n=0;n<t.length;n++){var a=t[n],s={hasOperator:!1};if(a.uvTransform&&(s.uvTransform=L(a.uvTransform)),a.operator){var o=a.operator;s.hasOperator=!0,s.mappingUseFragment=!0,s.mappingType=I[o.type],s.mappingObjTransformation=new e.Matrix4,o.transform&&(s.mappingObjTransformation.elements=o.transform)}a.slot&&(s.slot="TEX_COORD_1"===a.slot?2:1),i.mappingDescriptions[n]=s}},this.createMaterialApplications=function(t,i,r,n){if(t)for(var a=0;a<t.length;a++){var s=t[a],l=!1;void 0!==s.decalProjector&&(l=!0);var c=r.materials[s.material];if(c){var h={faceMaterial:c,geometricalFaceMaterial:c,inheritance:A[s.inheritance],layer:s.layer},u=null;switch(c.getType()){case"SpecGloss":u=O;break;case"DSPBR19x":case"DSPBR21x":case"DSPBR22x":case"DSPBR23x":u=N;break;case"CATGraphicalMaterial":u=null;break;default:e.VisualizationTraces.info(c.getType()+" unknown material application matching")}var d=s.textureMappings;if(d&&u){for(var p={textureUVSlots:{},textureUVTransforms:{}},f=0;f<d.length;f++){var m=r.mappingDescriptions[d[f].mapping];m.hasOperator&&(p.mappingUseFragment=m.mappingUseFragment,p.mappingType=m.mappingType,p.mappingObjTransformation=m.mappingObjTransformation);var g=d[f].parameter,v=u[g];v?(m.slot&&(p.textureUVSlots[v+"UvSlot"]=m.slot),m.uvTransform&&(p.textureUVTransforms[v+"UvTransform"]=m.uvTransform)):e.VisualizationTraces.info(g+" unknown attribute for material application matching")}h.mappingOperator=p}var S=null,_=!1;l&&(_=!!(S=i[s.decalProjector]).mode&&"EXPLICIT"===S.mode,h.mappingOperator?(h.mappingOperator.mappingObjTransformation=null,h.mappingOperator.mappingType=I[S.operator.type]):h.mappingOperator={mappingUseFragment:!0,mappingType:I[S.operator.type]},S.implicitScale||(S.implicitScale=[1,1]),S.implicitScale&&S.implicitScale&&(h.mappingOperator.mappingUVTransformation=new e.Matrix3(S.implicitScale[0],0,_?0:.5,0,S.implicitScale[1],_?0:.5,0,0,1)));var y=new o(h);if(l){var x=new e.Matrix4;S.operator.transform&&(x.elements=S.operator.transform),h={materialApplication:y,matrix:x,explicitUv:_},r.materialApplications[a]={isDecal:!0,decal:e.DecalManager.createDecal(h),apply:s.isDecalApplied,attach:s.isDecalAttached,uid:S.uid}}else r.materialApplications[a]=y}}},this.createMaterialsV2=function(t,i,r){if(t)for(var n=new s,a=0;a<t.length;a++){var o=t[a],l=null;if(r.materialsCallback)l=r.materialsCallback(o,r);else{if("External"===o.type){var c={uri:o.uri,destinationNodes:[],destinationDGforGAS:[],destinationDGforMaterial:[]};r.data.modelsToLoad.push(c),i.materials[a]=c;continue}var h={visible:o.visible,force:o.force,side:o.side,transparent:o.transparent,opacity:o.opacity,depthTest:o.depthTest,depthWrite:o.depthWrite},u=!0,d="VIS"+h.visible+"S"+h.side+"T"+h.transparent;d+="O"+h.opacity,d+="DT"+h.depthTest+"DW"+h.depthWrite,o.forceSide&&(h.forceSide=o.forceSide,l+="FS"+h.forceSide),void 0!==o.NRECompatibility&&(h.NRECompatibility=o.NRECompatibility),o.needTangentBinormal&&(h.needTangentBinormal=o.needTangentBinormal),o.alphaTest&&(!0===o.alphaTest?h.alphaTest=.5:h.alphaTest=o.alphaTest),o.color&&(h.color=(new e.Color).setRGB(o.color[0],o.color[1],o.color[2]),d+="C"+h.color.getStyle()),o.ambient&&(h.ambient=(new e.Color).setRGB(o.ambient[0],o.ambient[1],o.ambient[2]),d+="A"+h.ambient.getStyle()),o.emissive&&(h.emissive=(new e.Color).setRGB(o.emissive[0],o.emissive[1],o.emissive[2]),d+="E"+h.emissive.getStyle()),o.specular&&(h.specular=(new e.Color).setRGB(o.specular[0],o.specular[1],o.specular[2]),d+="SP"+h.specular.getStyle()),o.shininess&&(h.shininess=o.shininess,d+="SH"+h.shininess),o.vertexColors&&(h.vertexColors=o.vertexColors),void 0!==o.diffuseMap&&(u=!1,h.map=i.textures[o.diffuseMap].texture),void 0!==o.opacityMap&&(u=!1,h.opacityMap=i.textures[o.opacityMap].texture,h.transparent=!0),void 0!==o.normalMap&&(u=!1,h.normalMap=i.textures[o.normalMap].texture,h.needTangentBinormal=!0,void 0!==o.needTangentBinormal&&(h.needTangentBinormal=o.needTangentBinormal)),void 0!==o.normalMapScale&&(h.normalScale=new e.Vector2(o.normalMapScale.x,o.normalMapScale.y)),void 0!==o.normalMapFlipY&&(h.normalMapFlipY=o.normalMapFlipY),void 0!==o.bumpMap&&(u=!1,h.bumpMap=i.textures[o.bumpMap].texture),void 0!==o.bumpMapScale&&(h.bumpScale=o.bumpMapScale),void 0!==o.glossiness&&(h.glossiness=o.glossiness,d+="G"+h.glossiness),void 0!==o.glossinessMap&&(u=!1,h.glossinessMap=i.textures[o.glossinessMap].texture),void 0!==o.specularMap&&(u=!1,h.specularMap=i.textures[o.specularMap].texture),"Physical"===o.type&&(u=!1,void 0!==o.emissiveMap&&(h.emissiveMap=i.textures[o.emissiveMap].texture),void 0!==o.metalnessMap&&(void 0===o.metalness&&(o.metalness=1),h.metalnessMap=i.textures[o.metalnessMap].texture),void 0!==o.metalness&&(h.metalness=o.metalness),void 0!==o.coating&&(h.coating=o.coating),void 0!==o.coatingGlossiness&&(h.coatingGlossiness=o.coatingGlossiness)),void 0!==o.iterative&&(h.iterative=o.iterative),void 0!==o.sslr&&(h.sslr=o.sslr);var p=T[o.type];d="id"+d.hashCode(),u&&r.gasSharing&&(l=n.get3DXSharedGas(d)),!l&&p&&((l=new e[p](h))._source=e.AssetSource.MATERIAL_MANAGER,u&&r.gasSharing&&n.set3DXSharedGas(d,l))}i.materials[a]=l}},this.createMaterials=function(t,i,r){if(t){for(var n=new s,a=this.extensionsRequired.has("EXT_Material_PBR")||this.extensionsUsed.has("EXT_Material_PBR"),o=[],l=0;l<t.length;l++){var c=t[l],h=null,u="DSPBR"===c.type||"EVisuPBR"===c.type,d="DSPBR 2021x"===c.type||"DSPBR2021x"===c.type,p="DSPBR 2022x"===c.type,f="DSPBR 2023x"===c.type,m=u||d||p||f,g=!1;if(!m&&c.extensions&&c.extensions.EXT_Material_PBR&&((c=c.extensions.EXT_Material_PBR).type="EVisuPBR",m=a,u=!0),r.materialsCallback)h=r.materialsCallback(c,r);else{if("External"===c.type){var v={uri:c.uri,destinationNodes:[],destinationDGforGAS:[],destinationDGforMaterial:[]};r.data.modelsToLoad.push(v),i.materials[l]=v;continue}var S=null,_=T[c.type];m?S=new G(i,{is19x:u,is21x:d,is22x:p,is23x:f}):"Visu_Basic"===c.type?S=new B(i):"Physical"===c.type?S=new k(i):"PDSFX"===c.type?(S=new V(i),g=!0):S=new U(i),S.read(c,r,this.switchLODTextureCB);var y="id"+S.id.hashCode();if(S.isGAS&&r.gasSharing&&(h=n.get3DXSharedGas(y)),g&&(S.options.id=l,o.push(S.options),S.options.useBaseMaterial)){i.materials[l]=null;continue}!h&&_&&((h=new e[_](S.options))._source=e.AssetSource.MATERIAL_MANAGER,S.isGAS&&r.gasSharing&&n.set3DXSharedGas(y,h))}i.materials[l]=h}if(o.length)for(l=0;l<o.length;l++){var x=o[l];if(x.useBaseMaterial){var M=i.materials[x.baseMaterial].clone();i.materials[x.id]=M,n.getPDSFX({material:M,parameters:x.shaderParameters,name:x.shaderName})}else n.getPDSFX({material:i.materials[x.id],parameters:x.shaderParameters,name:x.shaderName})}}},this.createGeometriesV2=function(t,i){if(t)for(var n=i.data,a=0;a<t.length;a++){var s=t[a],o=new e.BufferGeometryDS;n.geometries[a]=o,o.sharedBuffers=this.sharedBuffers,o.noMeshInRAM=this.noMeshInRAM,o.vertexIndexArray=n.buffers[s.indexBuffer];for(var l=0;l<s.vertexBuffers.length;l++){var c=n.buffers[s.vertexBuffers[l]];if(c.attribute)o[c.attribute]=c.buffer;else if(c.length)for(var h=0;h<c.length;h++)o[c[h].attribute]=c[h].buffer}for(l=0;l<s.drawingGroups.length;l++){var u,d=s.drawingGroups[l],p=void 0!==d.primitives,f=void 0!==d.canonicals,m=o.vertexNormalArray?_:x,g=[],v=new r.DrawingGroup(m,null,E[d.mode],d.start,d.count,g,void 0,e.GeomTypeEnum.UNKNOWN,0);if(v.geometry=o,o.drawingGroups.push(v),void 0!==d.graphicAttributes&&n.materials[d.graphicAttributes]&&((u=n.materials[d.graphicAttributes]).uri?u.destinationDGforGAS.push(v):v.gas=u),void 0!==d.material&&n.materials[d.material]&&((u=n.materials[d.material]).uri?u.destinationDGforMaterial.push(v):v.material=u),p){var S=n.buffers[d.primitives],y=S.buffer,M=0,P=f?n.buffers[d.canonicals].buffer:null;for(v._geomType=e.GeomTypeEnum[S.geometricType],h=0;h<y.length;h+=4){var C=new r.SGPrimitive({cgmId:y[h],group:v,start:y[h+2],count:y[h+3]});if(i.unstreamReps){var b=y[h+1],D=n.reps[b];D||(D=new r.SGRep({cgmId:b}),n.reps[b]=D),C.rep=D,D._primitives.push(C)}if(f){var w=P[M++];if(w){C.decoration=new Array;for(var T=0;T<w;T++)C.decoration.push(P[M++])}}g.push(C)}}else C=new r.SGPrimitive({cgmId:0,group:v,start:d.start,count:d.count}),g.push(C)}}},this.getInternalDimensionBuffer=function(e,t,i){var r=t;if("POSITION"==i?r=t:"NORMAL"==i?r=t:"TEX_COORD_0"==i?r=3:"TEX_COORD_1"==i?r=3:"COLOR"==i?r=4:"TANGENT"==i?r=3:"BINORMAL"==i&&(r=3),r==t)return e;if(t>0){var n=e.length/t,a=new Float32Array(n*r);if(t<r)for(var s=0;s<n;s++){for(var o=0;o<t;o++)a[s*r+o]=e[s*t+o];for(o=t;o<r;o++)a[s*r+o]=0}else for(s=0;s<n;s++)for(o=0;o<r;o++)a[s*r+o]=e[s*t+o];return a}return console.log("wrong definition of buffer dimension"),e},this.createGeometries=function(t,i,n,a){if(t)for(var s=a.data,o=0;o<t.length;o++){var l,c,h=t[o],u={},d=0,p=h.reps&&!(h.reps instanceof Object);if(p){var f=this.getGenericBuffer(i,a,h.reps,"Uint8");l=new Uint32Array(f.buffer,f.byteOffset);var m=4*f.byteLength/9;c=new Float32Array(f.buffer,f.byteOffset+m)}var g=n[h.vertexLayout],v=new e.BufferGeometryDS;if(v.compressedNormals=h.compressedNormals||void 0!==h.normalCompression&&"OCT_24"===h.normalCompression,v.compressedVertices=h.compressedVertices||void 0!==h.positionCompression&&"BBOX_QUANTIZATION_16_16_16"===h.positionCompression,v.compressedUVs=h.compressedUVs||void 0!==h.uvCompression&&"UV_SHORT"===h.uvCompression,v.compressedColors=h.compressedColors||void 0!==h.colorCompression&&"COLOR_BYTE"===h.colorCompression,s.geometries[o]=v,v.sharedBuffers=this.sharedBuffers,v.noMeshInRAM=this.noMeshInRAM,void 0===h.indexBuffer){if(h.drawingGroups&&h.drawingGroups[0].count){v.vertexIndexArray=new Uint32Array(h.drawingGroups[0].count);for(var S=0;S<h.drawingGroups[0].count;S++)v.vertexIndexArray[S]=S}}else v.vertexIndexArray=this.getBuffers(i,a,h.indexBuffer);if(h.boundingSphere){var y=h.boundingSphere.center,P=h.boundingSphere.radius;v.boundingSphere=new e.Sphere(new e.Vector3(y[0],y[1],y[2]),P)}if(h.boundingBox){var C=h.boundingBox.min,b=h.boundingBox.max;v.compressedVertices&&(v.quantizedVector=new e.Vector3(Math.max(b[0]-C[0],1e-6),Math.max(b[1]-C[1],1e-6),Math.max(b[2]-C[2],1e-6)),v.quantizedVector.multiplyScalar(1/65535),v.offsetVector=new e.Vector3(C[0],C[1],C[2]),v.offsetVector.x/=v.quantizedVector.x,v.offsetVector.y/=v.quantizedVector.y,v.offsetVector.z/=v.quantizedVector.z,v.offsetVector.x=Math.floor(v.offsetVector.x),v.offsetVector.y=Math.floor(v.offsetVector.y),v.offsetVector.z=Math.floor(v.offsetVector.z))}if(1===g[0].length)for(var D=0;D<h.vertexBuffers.length;D++){var w=g[D],T=this.getBuffers(i,a,h.vertexBuffers[D],w);if("POSITION"==(Y=w[0]).attribute){if(v.vertexPositionArray=this.getInternalDimensionBuffer(T,Y.dimension,Y.attribute),v.compressedVertices){var A=v.vertexPositionArray,I=A.length/3;for(v.vertexPositionArray=new Float32Array(2*I),S=0;S<I;S++){var R=A[3*S],L=A[3*S+1],O=Math.floor(L/256),N=L%256,F=A[3*S+2];v.vertexPositionArray[2*S]=256*R+O,v.vertexPositionArray[2*S+1]=256*F+N}}}else if("NORMAL"==Y.attribute){if(v.vertexNormalArray=this.getInternalDimensionBuffer(T,Y.dimension,Y.attribute),v.compressedNormals){var V=(z=v.vertexNormalArray).length/3;for(v.vertexNormalArray=new Float32Array(V),S=0;S<V;S++){R=z[3*S],L=z[3*S+1],F=z[3*S+2];var U=16*R+Math.floor(L/16),B=L%16*256+F;v.vertexNormalArray[S]=4096*U+B}}}else if("TEX_COORD_0"==Y.attribute){if(v.vertexUvArray=this.getInternalDimensionBuffer(T,Y.dimension,Y.attribute),v.compressedUVs){var k=(G=v.vertexUvArray).length/3;for(v.vertexUvArray=new Float32Array(2*k),S=0;S<k;S++)R=G[3*S],L=G[3*S+1],O=Math.floor(L/256),N=L%256,F=A[3*S+2],v.vertexUvArray[2*S]=256*R+O,v.vertexUvArray[2*S+1]=256*F+N}}else if("TEX_COORD_1"==Y.attribute){if(v.vertexUv2Array=this.getInternalDimensionBuffer(T,Y.dimension,Y.attribute),v.compressedUVs){var G;for(k=(G=v.vertexUv2Array).length/3,v.vertexUv2Array=new Float32Array(2*k),S=0;S<k;S++)R=G[3*S],L=G[3*S+1],O=Math.floor(L/256),N=L%256,F=A[3*S+2],v.vertexUv2Array[2*S]=256*R+O,v.vertexUv2Array[2*S+1]=256*F+N}}else if("COLOR"==Y.attribute){if(v.vertexColorArray=this.getInternalDimensionBuffer(T,Y.dimension,Y.attribute),v.compressedColors){var z,H=(z=v.vertexColorArray).length/4;for(v.vertexColorArray=new Float32Array(2*H),S=0;S<H;S++){var W=z[4*S],j=z[4*S+1],X=z[4*S+2],q=z[4*S+3];v.vertexColorArray[2*S]=65536*W+256*j+X,v.vertexColorArray[2*S+1]=q}}}else"TANGENT"==Y.attribute?v.vertexTangentArray=this.getInternalDimensionBuffer(T,Y.dimension,Y.attribute):"BINORMAL"==Y.attribute?v.vertexBinormalArray=this.getInternalDimensionBuffer(T,Y.dimension,Y.attribute):v[Y.attribute]=T}else{w=g[0];var Z=this.getBuffers(i,a,h.vertexBuffers[0],w);for(D=0;D<w.length;D++){var Y;"POSITION"==(Y=w[D]).attribute?v.vertexPositionArray=this.getInternalDimensionBuffer(Z[D],Y.dimension,Y.attribute):"NORMAL"==Y.attribute?v.vertexNormalArray=this.getInternalDimensionBuffer(Z[D],Y.dimension,Y.attribute):"TEX_COORD_0"==Y.attribute?v.vertexUvArray=this.getInternalDimensionBuffer(Z[D],Y.dimension,Y.attribute):"TEX_COORD_1"==Y.attribute?v.vertexUv2Array=this.getInternalDimensionBuffer(Z[D],Y.dimension,Y.attribute):"COLOR"==Y.attribute?v.vertexColorArray=this.getInternalDimensionBuffer(Z[D],Y.dimension,Y.attribute):"TANGENT"==Y.attribute?v.vertexTangentArray=this.getInternalDimensionBuffer(Z[D],Y.dimension,Y.attribute):"BINORMAL"==Y.attribute?v.vertexBinormalArray=this.getInternalDimensionBuffer(Z[D],Y.dimension,Y.attribute):v[Y.attribute]=Z[D]}}for(D=0;D<h.drawingGroups.length;D++){var K,J=h.drawingGroups[D],Q=void 0!==J.repRanges,$=void 0!==J.primitives,ee=void 0!==J.canonicals,te=void 0!==J.cullingData,ie=v.vertexNormalArray?_:x,re=[],ne=new r.DrawingGroup(ie,null,E[J.mode],J.start,J.count,re,void 0,e.GeomTypeEnum.UNKNOWN,0);if(ne.geometry=v,ne._geomType=e.GeomTypeEnum[J.geometricType],v.drawingGroups.push(ne),void 0!==J.graphicAttributes&&s.materials[J.graphicAttributes]&&((K=s.materials[J.graphicAttributes]).uri?K.destinationDGforGAS.push(ne):ne.gas=K),void 0!==J.material&&s.materials[J.material]&&((K=s.materials[J.material]).uri?K.destinationDGforMaterial.push(ne):ne.material=K),te){ne.cullingData=[];var ae=this.getGenericBuffer(i,a,J.cullingData.start,"Uint32"),se=this.getGenericBuffer(i,a,J.cullingData.radius,"Float32");for(S=0;S<ae.length;S++)ne.cullingData.push({start:ae[S],radius:se[S]})}if(Q&&!$){var oe=this.getGenericBuffer(i,a,J.repRanges,"Uint32"),le=J.start;for(S=0;S<oe.length;S+=2){var ce=new r.SGPrimitive({cgmId:0,group:ne,start:le,count:oe[S+1]});if(le+=ce.count,a.unstreamReps&&h.reps){var he=l[4*(ge=oe[S])];(me=s.reps[he])||(me={rep:new r.SGRep({cgmId:l[4*ge+1],solid:l[4*ge+2],sag:c[5*ge+4]}),bsphere:[c[5*ge],c[5*ge+1],c[5*ge+2],c[5*ge+3]],nbTriangles:l[4*ge+3]},u[ge]=me,s.reps[he]=me,d++),ce.rep=me.rep,me.rep._primitives.push(ce)}re.push(ce)}}else if($&&a.unstreamPrimitives){var ue=this.getBuffers(i,a,J.primitives,void 0,J.geometricType).buffer,de=0,pe=ee?this.getBuffers(i,a,J.canonicals).buffer:null;for(S=0;S<ue.length;S+=4){var fe=new r.SGPrimitive({cgmId:ue[S],group:ne,start:ue[S+2],count:ue[S+3]});if(a.unstreamReps&&h.reps){var me,ge=ue[S+1];if(he=p?l[4*ge]:0,!(me=p?s.reps[he]:u[ge])){if(p)me={rep:new r.SGRep({cgmId:l[4*ge+1],solid:l[4*ge+2],sag:c[5*ge+4]}),bsphere:[c[5*ge],c[5*ge+1],c[5*ge+2],c[5*ge+3]],nbTriangles:l[4*ge+3]},s.reps[he]=me;else{var ve=h.reps[ge];me={rep:new r.SGRep({cgmId:ve.cgmId,solid:ve.solid,sag:ve.sag}),bbox:ve.bbox,nbTriangles:ve.nbTriangles}}u[ge]=me,d++}fe.rep=me.rep,me.rep._primitives.push(fe)}if(ee){var Se=pe[de++];if(Se){fe.decoration=new Array;for(var _e=0;_e<Se;_e++)fe.decoration.push(pe[de++])}}re.push(fe)}}else fe=new r.SGPrimitive({cgmId:0,group:ne,start:J.start,count:J.count}),re.push(fe)}if(a.unstreamSSB&&d>this.SSBMinNbReps){var ye=performance.now(),xe=[],Me=0,Pe=null,Ce=new e.Sphere,be=new e.Sphere;for(var De in u){var we=u[De].bsphere;be.center.set(we[0],we[1],we[2]),be.radius=we[3],Pe?(Ce.copy(Pe),Ce.mergeWithSphere(be,Pe)):Pe=be.clone(),u[De].rep.boundingSphere={center:[be.center.x,be.center.y,be.center.z],radius:be.radius},Me+=u[De].nbTriangles,xe.push(u[De])}Me>this.SSBMinNbTriangles&&(v.bvhCells=[],ye=performance.now(),M.indexMap=new Uint32Array(v.vertexIndexArray.length),(!M.positions||M.positions.length<v.vertexPositionArray.length)&&(M.positions=new Float32Array(v.vertexPositionArray.length)),(!M.normals||M.normals.length<v.vertexNormalArray.length)&&(M.normals=new Float32Array(v.vertexNormalArray.length)),console.log("allocate indexMap/positions/normals in "+(performance.now()-ye)+" ms."),v.bvhCells.push(this.batchBVHCell({objects:xe},v,M,Pe)))}}},this.batchBVHCell=function(t,i,n,a){var s=performance.now(),o=new e.BufferGeometryDS;o.sharedBuffers=this.sharedBuffers,o.noMeshInRAM=this.noMeshInRAM,a?(o.boundingSphere=a,o.boundingBox=o.boundingSphere.getBoundingBox()):(o.boundingBox=new e.Box3(t.bbox.min,t.bbox.max),o.boundingSphere=o.boundingBox.getBoundingSphere()),o.compressedVertices=i.compressedVertices,o.compressedNormals=i.compressedNormals,o.compressedUVs=i.compressedUVs,o.compressedColors=i.compressedColors,o.quantizedVector=i.quantizedVector,o.offsetVector=i.offsetVector;var l=n.indexMap,c=n.positions,h=n.normals;performance.now()-s,s=performance.now();for(var u=0,d=0,p=[],f=0,m=0;m<t.objects.length;m++)for(var g=t.objects[m],v=0;v<g.rep.primitives.length;v++)f+=(y=g.rep.primitives[v]).count,p.push(y);performance.now()-s,s=performance.now();var S,_,y,x=new Uint32Array(f);for(p.sort(function(e,t){if(e.group.glType<t.group.glType)return-1;if(e.group.glType>t.group.glType)return 1;if(e.group._geomType<t.group._geomType)return-1;if(e.group._geomType>t.group._geomType)return 1;if(e.group.gas.id<t.group.gas.id)return-1;if(e.group.gas.id>t.group.gas.id)return 1;if(e.group.material&&!t.group.material)return-1;if(!e.group.material&&t.group.material)return 1;if(e.group.material&&t.group.material){if(e.group.material.id<t.group.material.id)return-1;if(e.group.material.id>t.group.material.id)return 1}return e.rep.boundingSphere.radius>t.rep.boundingSphere.radius?-1:e.rep.boundingSphere.radius<t.rep.boundingSphere.radius?1:0}),performance.now()-s,s=performance.now(),v=0;v<p.length;v++){(y=p[v]).group!==S&&(S=y.group,(_=new r.DrawingGroup(y.group.gas,y.group.material,y.group.glType,d,0,[],void 0,y.group._geomType,0)).geometry=o,o.drawingGroups.push(_),g=null,_.cullingData=[]),y.rep!==g&&(g=y.rep,_.cullingData.push({start:d,radius:g.boundingSphere.radius}));for(var M=d,P=0;P<y.count;P++){var C=i.vertexIndexArray[y.start+P];0===l[C]&&(l[C]=u+1,i.compressedVertices?(c[2*u]=i.vertexPositionArray[2*C],c[2*u+1]=i.vertexPositionArray[2*C+1]):(c[3*u]=i.vertexPositionArray[3*C],c[3*u+1]=i.vertexPositionArray[3*C+1],c[3*u+2]=i.vertexPositionArray[3*C+2]),i.compressedNormals?h[u]=i.vertexNormalArray[C]:(h[3*u]=i.vertexNormalArray[3*C],h[3*u+1]=i.vertexNormalArray[3*C+1],h[3*u+2]=i.vertexNormalArray[3*C+2]),u++),x[d]=l[C]-1,d++}y.start=M,y.group=_,_.count+=y.count,_.primitives.push(y)}return performance.now()-s,s=performance.now(),o.vertexIndexArray=x,o.vertexPositionArray=new Float32Array(c.buffer.slice(0,4*(i.compressedVertices?2:3)*u)),o.vertexNormalArray=new Float32Array(h.buffer.slice(0,4*(i.compressedNormals?1:3)*u)),performance.now()-s,o},this.createNodes=function(t,i){if(t){i.data.children||(i.data.children=[]);for(var r=i.data,s=0;s<t.length;s++){var o=t[s],l=null;if("External"===o.type)l=new n,i.data.modelsToLoad.push({destinationNode:l,uri:o.uri});else if("Node3D"===o.type)l=new n,i.data.children[s]=o.children;else{var c=null,h=null;if(o.boundingSphere){var u=o.boundingSphere.center,d=o.boundingSphere.radius;c=new e.Sphere(new e.Vector3(u[0],u[1],u[2]),d)}if(o.boundingBox){var p=o.boundingBox.min,f=o.boundingBox.max;h=new e.Box3(new e.Vector3(p[0],p[1],p[2]),new e.Vector3(f[0],f[1],f[2]))}var m=[];if(o.geometries)for(var v=0;v<o.geometries.length;v++){var S=r.geometries[o.geometries[v]];if(S.bvhCells)for(var y=0;y<S.bvhCells.length;y++)m.push(S.bvhCells[y]);else m.push(S)}h||(m[0].computeBoundingBox(),h=m[0].boundingBox),m.boundingBox=h,c||(m[0].computeBoundingSphere(),c=m[0].boundingSphere),m.boundingSphere=c;var M=m.length&&m[0].vertexNormalArray?_:x,P=new e.Mesh(m,M);if(P.fromLoadedModel=!0,P.castShadow=void 0===o.castShadow||o.castShadow,P.receiveShadow=void 0===o.receiveShadow||o.receiveShadow,P.enableNormalDepth=void 0===o.enableNormalDepth||o.enableNormalDepth,o.lightmaps&&o.lightmaps.length){var C=r.textures[o.lightmaps[0]];P.lightMapData={lightMapLinear:!0,lightMapMode:i.lightMapAsIrradiance?1:0,lightMapUvTransform:null,lightMapUvSlot:1};var b=C.mapping;for(b&&(b.uvTransform&&(P.lightMapData.lightMapUvTransform=L(b.uvTransform)),b.slot&&(P.lightMapData.lightMapUvSlot="TEX_COORD_1"===b.slot?2:1)),P._programID|=e.ProgramIDs.LIGHT_MAP,v=0;v<o.lightmaps.length;v++)C=r.textures[o.lightmaps[v]],m[v].lightMap=C.texture}l=new a(P),i.accelStruct&&!g&&l._occurrences[0].renderable.computeKDTree(!1)}if(i.version>=4){if(void 0!==o.materialApplication){var D=r.materialApplications[o.materialApplication];l.setMaterialApplication(D)}if(void 0!==o.decalApplications)for(s=o.decalApplications.length;s>0;s--){var w=r.materialApplications[o.decalApplications[s-1]],E=w.decal;w.apply&&E.applyOn(l),w.attach&&E.attachTo(l)}}else if(void 0!==o.material){var T=r.materials[o.material];T.uri?T.destinationNodes.push(l):l.setMaterial(T)}if(r.nodes[s]=l,o.matrix){var A=(new e.Matrix4).setFromArray(o.matrix);l.setMatrix(A)}o.name&&l.setName(o.name),i.nodeCallback&&i.nodeCallback(o,i,l)}}},this.createLayers=function(t,i){var r=i.data;for(var n in r.nodes){var a=r.nodes[n],s=t[n];for(var l in s.occurrences){var c=s.occurrences[l].index,h=s.occurrences[l];if(h.layers.length){a._occurrences[c].renderable.layer=new e.BufferLayer(a._occurrences[c].renderable);for(var u=0;u<h.layers.length;u++){var d=h.layers[u],p=r.geometries[d.geometry],f=r.materials[d.drawableInterval.material];v&&(f=new o({faceMaterial:f,inheritance:2,layer:0}));var m=new e.DrawableInterval(d.drawableInterval.layerNum,d.drawableInterval.start,d.drawableInterval.count,f);m.primitiveStart=d.drawableInterval.primitiveStart,m.primitiveCount=d.drawableInterval.primitiveCount;var g=new e.LayerInterval(p,p.drawingGroups[d.drawableGroup],m);a._occurrences[c].renderable.layer.addLayerInterval(g)}}}}};var R=function(t,i){var r=null,n=t.emissionColor?t.emissionColor:t.color;if(t.energyNormalization){var a=.2126*n[0]+.7152*n[1]+.0722*n[2];n[0]=n[0]/a,n[1]=n[1]/a,n[2]=n[2]/a}var s=(new e.Color).setRGB(n[0],n[1],n[2]),o="rgb("+255*n[0]+","+255*n[1]+","+255*n[2]+")",d=void 0!==t.emissionValue?t.emissionValue:t.value;if("directional"==t.type)r=new c({color:s,intensity:d=d/=i*i,sceneShadow:!0});else if("point"==t.type)t.emissionMode&&"LUMINOUS_POWER"!=t.emissionMode||(d/=4*Math.PI),r=new u({color:s,intensity:d,physicalAttenuation:!0,attenuationScale:1e-6,sceneShadow:!0});else if("spot"==t.type){var p=t.cutoffAngle*Math.PI/180,f=t.falloffAngle*Math.PI/180;t.emissionMode&&"LUMINOUS_POWER"!=t.emissionMode||(d/=Math.PI*(1-Math.cos(p)+(1-Math.cos(f)))),r=new h({color:s,intensity:d,physicalAttenuation:!0,attenuationScale:1e-6,outerAngle:p,innerAngle:f,sceneShadow:!0})}else"rectangle"==t.type?(t.emissionMode||(t.emissionMode="LUMINOUS_POWER"),(r=new e.AreaLight(o,d,t.width,t.height,e.AreaLightUnits[t.emissionMode])).color=s,r._internalScale=i,r=new l(r)):"disk"==t.type?(t.emissionMode||(t.emissionMode="LUMINOUS_POWER"),(r=new e.DiskLight(o,d,t.radius,e.AreaLightUnits[t.emissionMode])).color=s,r._internalScale=i,r=new l(r)):"sphere"==t.type?(t.emissionMode||(t.emissionMode="LUMINOUS_POWER"),(r=new e.SphereLight(o,d,t.radius,e.AreaLightUnits[t.emissionMode])).color=s,r._internalScale=i,r=new l(r)):"tube"==t.type?(t.emissionMode||(t.emissionMode="LUMINOUS_POWER"),(r=new e.TubeLight(o,d,t.radius,t.width,e.AreaLightUnits[t.emissionMode])).color=s,r._internalScale=i,r=new l(r)):r={};return r};this.applyLights=function(t){var i=t.json.lightInstances;if(i&&i.length){var r=null,n=t.destinationNodes?t.destinationNodes[0]:t.destinationNode;!g&&n._occurrences[0].scene3js&&((r=n._occurrences[0].scene3js.viewer).setAmbientLight(0),r.setIntensityCorrection(!0),r.useDefaultLights&&(r.setTriLights(!1),r.directionalLight.intensity=0,r.directionalLight2.intensity=0),r.renderer.ToneMappingEffect&&r.renderer.ToneMappingEffect.setToneMapping(2));var a=1;t.rootMatrix&&(a=t.rootMatrix.getMaxScaleOnAxis()),n._updateBoundingElements();for(var s=t.json.lights,o=0;o<i.length;o++){var l=i[o];if("environment"!=s[l.light].type){var h=R(s[l.light],a);if(l.castShadows&&h.castShadows){var u=h instanceof c?null:1e4;h.castShadows(!0,{bias:-.005,darkness:1/i.length,far:u,mapWidth:1024,mapHeight:1024})}l.cameraAligned&&h.attachToViewpoint&&h.attachToViewpoint(l.cameraAligned);var d=new e.Matrix4;l.matrix&&d.setFromArray(l.matrix);var p=new e.Matrix4;l.ambianceTransform&&p.setFromArray(l.ambianceTransform),d=(new e.Matrix4).multiplyMatrices(p,d),t.rootMatrix&&(d=(new e.Matrix4).multiplyMatrices(t.rootMatrix,d)),h.setMatrix(d),t.data.lights||(t.data.lights=[]),t.data.lights.push(h),n.add(h)}}}},this.retrieveViewpoints=function(t,i,r,n){let a=[],s=null;if(r){if(!t.json.cameras)return a;s=[];for(let e=0;e<t.json.cameras.length;e++)s[e]={camera:e}}else if(!(s=t.json.renderFrames)||!s.length)return a;for(var o=0;o<s.length;o++){var l=s[o],c=t.json.cameras[l.camera];if(l.resolution,c.type&&"2DCamera"==c.type){let t=new e.Vector3(c.origin[0],c.origin[1],1);var h=c.zoom,u=c.zoomType,p=c.zoomRatio;(w=new d({viewer:i,projectionType:d.ORTHOGRAPHIC,defaultController:!0,inactive:n}))._set2DMode(!0,"COMBINED"),w.setNative2DZoomType(u,p),w._nativeZoom=h,w.onMove(i.render),w.moveTo({eyePosition:t})}else{var f=(new e.Matrix4).setFromArray(c.matrix),m=new e.Vector3,g=new e.Quaternion,v=new e.Vector3;f.decompose(m,g,v);var S=10,_=2500,y=1;t.rootMatrix&&(y=t.rootMatrix.getMaxScaleOnAxis()),m.multiplyScalar(y);var x=c.focusDistance?c.focusDistance*y:null;!c.autoNearFar&&c.nearFar&&(S=c.nearFar[0],_=c.nearFar[1],S*=y,_*=y);var M,P=c.sensorSize?c.sensorSize:[36,24];if(P[0]*=y,P[1]*=y,c.type&&"orthographic"==c.type)M=d.ORTHOGRAPHIC;else{M=d.PERSPECTIVE;var C=50;c.focalLength&&(C=c.focalLength,C*=y);var b=c.aperture?c.aperture:1,D=c.blades?c.blades:0}var w=new d({viewer:i,projectionType:M,near:S,far:_,defaultController:!0,inactive:n});if(M==d.PERSPECTIVE?(w.camera.setLens(C,P,!0),w.camera.setAperture(b,D)):(c.scale&&(P[0]*=c.scale[0],P[1]*=c.scale[1]),x=P[1]/(2*Math.tan(Math.PI*w.camera.fov/360))),w.onMove(i.render),w.moveTo({eyePosition:m,orientation:g,distanceToTarget:x}),c.projectionDir){let t=w.getSightDirection(),i=new e.Vector3(c.projectionDir[0],c.projectionDir[1],c.projectionDir[2]),r=t.dot(i),n=i.setLength(1/r);n.sub(t),n.applyMatrix4(w.camera.matrixWorldInverse),w._nativeTranslationOffset=new e.Vector2(n.x,n.y),w.camera.updateProjectionMatrix()}}a.push(w)}return a},this.applyCamera=function(t){var i=t.destinationNodes?t.destinationNodes[0]:t.destinationNode;if(g||!i._occurrences[0].scene3js)return;var r=i._occurrences[0].scene3js.viewer,n=t.json.currentRenderFrame?t.json.currentRenderFrame:0;let a=this.retrieveViewpoints(t,r);if(0!=a.length){for(let e=0;e<a.length;e++)r.addViewpoint(a[e]);var s=t.json.renderFrames,o=t.json.cameras[s[n].camera];if(o.bloom){r.setBloom(!0);var l=r.getEffect("Bloom");l&&(l.setBloomThreshold(o.bloom.lightThreshold),l.setBloomFactor(o.bloom.intensity))}var c=r.getEffect("ToneMapping");r.renderer.renderer.resetInlinedPostProcess();var h=r.renderer.renderer.inlinedPostProcess;if(o.exposure&&(c?c.setBrightness(o.exposure):(h.activated=!0,h.brightness=o.exposure)),o.autoexposure&&c){var u=o.autoexposure,d=null;null!=u.regionOfInterest&&(d=data.textures[u.regionOfInterest].texture),c.setAutoExposure(!!u.autoexposure,d,u.clampMin,u.clampMax)}if(o.toneMapper)if("Filmic"===o.toneMapper.type)c?c.setToneMapping(4):(h.activated=!0,h.tonemapping=4);else if("Photographic"===o.toneMapper.type){var p=o.toneMapper.colorCorrection;c?c.setToneMapping(6,{crushblacks:o.toneMapper.crushBlack,burnhighlights:o.toneMapper.burnHighlight,saturation:o.toneMapper.saturation,colorCorrection:new e.Vector3(p[0],p[1],p[2])}):(h.activated=!0,h.tonemapping=6,h.crushblacks=o.toneMapper.crushBlack,h.burnhighlights=o.toneMapper.burnHighlight)}if(o.gammaCorrection&&c&&c.setGamma(o.gammaCorrection),o.vignetting){r.setVignetting(!0);let e=r.getEffect("Vignetting");null!=o.vignetting.power&&e&&e.setVignettingPower(o.vignetting.power)}if(null!=o.colorGrading&&c){var f=null,m=this._loadImage(t,!1,o.colorGrading,function(e){return function(){c.setColorGrading(f)}});(f=m.map).flipY=!1,f.wrapS=1001,f.wrapT=1001,f.anisotropy=1,f.minFilter=1006,f.magFilter=1006,f.generateMipmaps=!1}var v=r.getViewpoints().length-s.length;r.selectViewpoint(v+n),this.capture&&(r.ambience,function(){var e=window._shootW?window._shootW:r.SCREEN_WIDTH,i=window._shootH?window._shootH:r.SCREEN_HEIGHT,n=function(e,t,i,r,n){return n?(t=r-t,i*Math.floor(t-1)+Math.floor(e)):i*Math.floor(t)+Math.floor(e)},a={data:null,width:e,height:i};r.renderToTarget(a,r.currentViewpoint,!1,{AntiAliasing:"FSAA"});var s=document.createElement("canvas");s.width=e,s.height=i;for(var o=s.getContext("2d"),l=o.createImageData(a.bufferWidth,a.bufferHeight),c=0;c<l.height;c++)for(var h=0;h<l.width;h++){var u=n(h,c,l.width,l.height,!1),d=n(h,c,a.bufferWidth,a.bufferHeight,!0);l.data[4*u]=a.data[4*d],l.data[4*u+1]=a.data[4*d+1],l.data[4*u+2]=a.data[4*d+2],l.data[4*u+3]=a.data[4*d+3]}createImageBitmap(l).then(r=>{o.drawImage(r,0,0,e,i);var n=document.createElement("a"),a=t.url.lastIndexOf("/"),s=t.url.lastIndexOf("."),l=window._shoot?window._shoot:t.url.substr(a+1,s-a-1);void 0!==window._currentShootIndex&&(l+="_"+window._currentShootIndex),n.download=l+".png",o.canvas.toBlob(function(e){n.href=URL.createObjectURL(e),n.click()})})}())}},this.parseHeader=function(t){var i=t.json.header;if(!i||!i.version)return!1;if(2!==parseFloat(i.version)&&3!==parseFloat(i.version)&&3.1!==parseFloat(i.version)&&3.2!==parseFloat(i.version)&&4!==parseFloat(i.version))return!1;t.version=parseFloat(i.version),"material"!==i.content&&"ambiance"!==i.content&&"light"!==i.content||(t.content=i.content),"materialApplication"===i.content&&(t.content="material");var r=new e.Matrix4;return"m"===i.unit||"meter"===i.unit||"meters"===i.unit?r.makeScale(1e3,1e3,1e3):"inch"!==i.unit&&"inches"!==i.unit||r.makeScale(25.4,25.4,25.4),"Y"===i.upAxis?r.rotateX(.5*Math.PI):"X"===i.upAxis&&r.rotateY(.5*Math.PI),r.isIdentity()||(t.rootMatrix=r),!0},this.processJSON=function(e){this.parseHeader(e)&&(e.data.chunks.length||!e.json.binaries||e.json.binaries.flag?this.processChunks(e):this.getChunks(e.json.binaries.length,e,this.processChunks))},this.processChunks=function(e){m=performance.now();var t=e.json;if(void 0!==t.extensionsUsed)for(var i=0;i<t.extensionsUsed.length;i++)this.extensionsUsed.add(t.extensionsUsed[i]);if(void 0!==t.extensionsRequired)for(i=0;i<t.extensionsRequired.length;i++)this.extensionsRequired.add(t.extensionsRequired[i]);this.createImages(t.images,0,e,this.onImagesReady.bind(this))},this.onImagesReady=function(t){var i=t.json,r=this;t.ambianceLoaded=!0;var n=function(e){var i={nbTextures:0};e&&e.ambiance&&(t.results.ambiance=e.ambiance,t.ambianceLoaded=!0),t.ambianceLoaded&&t.geometryLoaded&&(i.isLast=!r.nbModelsToLoad,"ambiance"==t.content&&(i.ambiance=t.results.ambiance,t.json.ambiance&&t.json.ambiance.renderSettings&&(i.renderSettings=t.json.ambiance.renderSettings)),"light"==t.content&&(i.lights=t.results.lights),"material"===t.content&&(t.data.materials.length>0&&(i.material=t.results.materials[0],i.materials=t.results.materials.slice()),t.data.materialApplications.length>0&&(i.materialApplications=t.results.materialApplications.slice()),i.json=t.json,0==t.data.textures.length&&t.onTexturesLoadedCB&&t.onTexturesLoadedCB(null)),i.nbTextures=t.data.nbImagesToLoad||0,t.doneCallback&&t.doneCallback(i),delete r.modelsToLoad[t.loadIndex])};if(this.createTextures(i.textures,t),2===t.version?this.createMaterialsV2(i.materials,t.data,t):this.createMaterials(i.materials,t.data,t),t.version>=4&&(this.createMappingDescriptions(i.mappingDescriptions,t.data),this.createMaterialApplications(i.materialApplications,i.decalProjectors,t.data,t)),"material"!==t.content&&(t.ambianceLoaded=this.createAmbience(i,t,n),2===t.version&&this.createBuffers(i.buffers,t)),"material"!==t.content){if(void 0!==i.root){2===t.version?this.createGeometriesV2(i.geometries,t):this.createGeometries(i.geometries,i.buffers,i.vertexLayouts,t),this.createNodes(i.nodes,t),y("processed data in "+(performance.now()-m)+" ms."),m=performance.now();for(var a=0;a<t.data.nodes.length;a++){var s=t.data.nodes[a],o=t.data.children;if(o[a])for(var l=0;l<o[a].length;l++)s.add(t.data.nodes[o[a][l]],!0);if(s.__representations)for(l=0;l<s.__representations.length;l++){var c,h=[];for(c=0;c<s.__representations[l].length;c++)h.push(t.data.nodes[s.__representations[l][c]]);s._pushRepresentation(h)}}t.unstreamLayers&&this.createLayers(i.nodes,t),y("Created links between nodes in "+(performance.now()-m)+" ms."),m=performance.now();var u=t.data.nodes[i.root];if(t.rootMatrix){var d=(new e.Matrix4).multiplyMatrices(t.rootMatrix,u.getMatrix());u.setMatrix(d)}if(t.destinationNodes)for(a=0;a<t.destinationNodes.length;a++)t.destinationNodes[a].add(u);else t.destinationNode.add(u);y("Attached to scenegraph in "+(performance.now()-m)+" ms.")}else if(1===t.data.materials.length){for(a=0;a<t.destinationNodes.length;a++)t.destinationNodes[a].setMaterial(t.data.materials[0]);for(a=0;a<t.destinationDGforGAS.length;a++)t.destinationDGforGAS[a].gas=t.data.materials[0];for(a=0;a<t.destinationDGforMaterial.length;a++)t.destinationDGforMaterial[a].material=t.data.materials[0]}this.applyLights(t),this.applyCamera(t)}var p=t.data.modelsToLoad.length;if(p){var f=0;for(a=0;a<p;a++){var g=t.data.modelsToLoad[a];this.load({url:this.getURI(g.uri,t.path),destinationNode:g.destinationNode,destinationNodes:g.destinationNodes,destinationDGforGAS:g.destinationDGforGAS,destinationDGforMaterial:g.destinationDGforMaterial,zipped:!0,layers:t.unstreamLayers,reps:t.unstreamReps,doneCallback:function(){++f===p&&t.doneCallback&&t.doneCallback()}})}t.readyCallback&&t.readyCallback(),delete this.modelsToLoad[t.loadIndex]}else{if(this.nbModelsToLoad--,"material"===t.content&&t.data.materials.length>0&&(t.results.material=t.data.materials[0],t.results.materials=t.data.materials.slice()),"material"===t.content&&t.data.materialApplications.length>0&&(t.results.materialApplications=t.data.materialApplications.slice()),"light"===t.content&&(t.results.lights=t.data.lights),t.readyCallback&&t.readyCallback(),t.geometryLoaded=!0,0===this.nbModelsToLoad)for(a=0;a<this._zipReaders.length;a++)this._zipReaders[a].close();this._zipReaders=[],n()}},this.internalLoad=function(e){var t=this,i=this.modelsToLoad[e];if(m=performance.now(),i.json)"string"==typeof i.json&&(i.json=JSON.parse(i.json)),this.processJSON(i);else{var r=i.url,n="text";i.zipped&&(n="blob"),i.concat&&(n="arraybuffer");var a=function(e){if(y("file downloaded in "+(performance.now()-m)+" ms."),m=performance.now(),i.zipped){const r=new f.ZipReader(new f.BlobReader(e));t._zipReaders.push(r),r.getEntries().then(function(e){y("zip file reader created in "+(performance.now()-m)+" ms."),i.zipEntries=e;for(var r=null,n=0;n<e.length;n++)"manifest.json"===e[n].filename&&(r=e[n]);m=performance.now(),t.getEntryFile(r,"text",function(e){y("unzipped JSON file in "+(performance.now()-m)+" ms."),m=performance.now(),i.json=JSON.parse(e),y("parsed JSON file in "+(performance.now()-m)+" ms."),t.processJSON(i)})}).catch(i.errorCallback)}else if(i.concat){for(var r=new Uint8Array(e),n=new Uint32Array(e,0,1)[0],a=new Uint16Array(r.buffer,4,n/2),s=[],o=0;65535*o<a.length;o++)s.push(String.fromCharCode.apply(null,a.subarray(65535*o,65535*(o+1))));var l=s.join("");y("unbinarized JSON file in "+(performance.now()-m)+" ms."),m=performance.now(),i.json=JSON.parse(l),y("parsed JSON file in "+(performance.now()-m)+" ms."),i.concatBinaries={data:r,offset:r.byteLength},t.processJSON(i)}else y("JSON file downloaded in "+(performance.now()-m)+" ms."),m=performance.now(),i.json=JSON.parse(e),y("parsed JSON file in "+(performance.now()-m)+" ms."),t.processJSON(i)};if("file:"==r.slice(0,5)){var s=new XMLHttpRequest;s.open("GET",r,!0),s.responseType=n,s.withCredentials=!0,s.onreadystatechange=function(e){4===s.readyState&&(0===s.status||200===s.status?a(s.response):i.errorCallback())},s.send(null)}else UWA.Ajax.request(r,{async:!0,cors:!0,withCredentials:!0,responseType:n,onComplete:a,onFailure:i.errorCallback})}},this.getChunks=function(e,t,i){var r=this;if(!e)return t.concatBinaries&&(t.concatBinaries.data=null),void i.call(this,t);if(e--,m=performance.now(),t.zipped){for(var n=null,a=0;a<t.zipEntries.length;a++)t.zipEntries[a].filename===t.json.binaries[e].uri&&(n=t.zipEntries[a]);n?this.getEntryFile(n,"arraybuffer",function(n){y("unzipped binary file "+e+" in "+(performance.now()-m)+" ms."),t.data.chunks[e]=n,r.getChunks(e,t,i)}):r.getChunks(e,t,i)}else if(t.concat){m=performance.now();var s=t.json.binaries[e];if(!1===s.concatenated)return void r.getChunks(e,t,i);var o=s.byteLength;if(o%4&&(o+=4-o%4),t.concatBinaries.offset-=o,t.concatBinaries.data.buffer.slice){var l=t.concatBinaries.data.buffer.slice(t.concatBinaries.offset,t.concatBinaries.offset+s.byteLength);t.data.chunks[e]=new Uint8Array(l)}else{l=new Uint8Array(t.concatBinaries.data.buffer,t.concatBinaries.offset,s.byteLength);for(var c=new Uint8Array(s.byteLength),h=0;h<s.byteLength;h++)c[h]=l[h];t.data.chunks[e]=c}y("splitted binary file "+e+" in "+(performance.now()-m)+" ms."),r.getChunks(e,t,i)}else{var u=new XMLHttpRequest;u.open("GET",t.path+t.json.binaries[e].uri,!0),u.responseType="arraybuffer",u.withCredentials=!0,u.onreadystatechange=function(n){4===u.readyState&&(0!==u.status&&200!==u.status||(y("xhr binary file "+e+" in "+(performance.now()-m)+" ms."),t.data.chunks[e]=this.response,r.getChunks(e,t,i)))},u.send(null)}},this.setMode=function(e){this.mode=e},this.setSharedBuffers=function(e){this.sharedBuffers=e},this.setNoMeshInRAM=function(e){this.noMeshInRAM=e},this.setBaseUrl=function(e){this.baseUrl=e},this.load=function(e){var t={version:3,content:"sceneGraph",url:e.url,path:e.url?i.parseUrl(e.url+".json").directoryPath:null,zipped:void 0!==e.zipped?e.zipped:void 0===this.mode||"zipped"===this.mode,concat:void 0!==e.concat?e.concat:"concat"===this.mode,json:e.json,resourcesLibrary:e.resourcesLibrary,ambianceLoaded:!1,geometryLoaded:!1,forcePowerOfTwo:void 0===e.forcePowerOfTwo||e.forcePowerOfTwo,results:{ambiance:null,material:null,materials:null,materialApplications:null,lights:null},readyCallback:e.readyCallback,progressCallback:e.progressCallback,doneCallback:e.doneCallback,errorCallback:e.errorCallback,imagesCallback:e.imageCallback,binaryCallback:e.binaryCallback,materialsCallback:e.materialCallback,nodeCallback:e.nodeCallback,switchLODTextureCB:e.switchLODTextureCallback,onTexturesLoadedCB:e.onTexturesLoadedCallback,destinationNode:e.destinationNode,destinationNodes:e.destinationNodes,destinationDGforGAS:e.destinationDGforGAS,destinationDGforMaterial:e.destinationDGforMaterial,unstreamLayers:void 0!==e.layers&&e.layers,unstreamReps:void 0!==e.reps&&e.reps,unstreamPrimitives:void 0!==e.primitives&&e.primitives,unstreamSSB:void 0!==e.ssb&&e.ssb,accelStruct:void 0!==e.accelStruct&&e.accelStruct,gasSharing:void 0!==e.gasSharing&&e.gasSharing,lightMapAsIrradiance:void 0!==e.lightMapAsIrradiance&&e.lightMapAsIrradiance,loadIndex:this.loadIndex,data:{chunks:e.chunks?e.chunks:[],header:{},nodes:[],children:[],buffers:[],geometries:[],images:[],textures:[],materials:[],mappingDescriptions:[],materialApplications:[],reps:{},modelsToLoad:[],nbImagesToLoad:0}};this.modelsToLoad[this.loadIndex]=t,this.nbModelsToLoad++,this.internalLoad(this.loadIndex),this.loadIndex++},this.loadMaterial=function(e){if(!e.json)return!1;e.zipped=!1,e.chunks=[];var t=0;if(e.json.binaries&&e.binaries)for(var i=0;i<e.json.binaries.length;i++)e.json.binaries[i].extUri||(e.chunks.push(e.binaries[t]),t++);this.load(e)}}}),define("DS/Visualization/ThreeDXLoader",["DS/VisuLoaders/ThreeDXLoader"],function(e){"use strict";return e}),define("DS/Visualization/SceneGraphConverter",["DS/VisuLoaders/SceneGraphConverter"],function(e){"use strict";return e}),define("Visualization/SceneGraphConverter",["DS/Visualization/SceneGraphConverter","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SceneGraphConverter"),e}),define("DS/VisuLoaders/DAEReader",["DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Visualization/ThreeJS_DS","DS/VisuLoaders/ColladaLoader","DS/VisuLoaders/SceneGraphConverter"],function(e,t,i,r,n,a){"use strict";return function(t,i){var r,s,o,l,c,h,u;r=t,s=void 0!==i?i:null,o=null,l=null,c=null,u=null,this.loadFromSpec=function(e,t,i,r){this.load(e,t,i,r,!0)},this.load=function(t,i,d,p,f){o=null,l=null,c=null,h=null,void 0!==i&&(o=i),void 0!==p&&(l=p),h=new e,null===c&&((c=new n).options.convertUpAxis=!0,this.waitMaterial&&(c.options.waitMaterial=this.waitMaterial),(f?c.loadFromSpec:c.load)(t,function(e){u=new a(r,e.scene),h.addChild(u.getRootNode()),e.skins[0],null!==s&&s({hack:!0,updateInfinitePlane:!0}),null!==l&&l()}),o&&o(h))},this.setWaitMaterial=function(e){this.waitMaterial=e}}}),define("DS/Effects/SSLRefractionEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/AbstractSSRayMarchingEffect"],function(e,t,i){"use strict";return i.extend({init:function(e,t){return this._parent(e,t,"SSLRefraction","SSLRefractionMipSolver"),this},initEffect:function(e,t){var i=t.getComposer("normalDepthIoRRoughness");i.linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.uniforms.tNormalDepthIoRRoughness),i.linkToShaderPassUniform(this.passSolver,this.passSolver.uniforms.tNormalDepthIoRRoughness),t.getComposer("normalDepth").linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.uniforms.tColorNormalDepth),t.getComposer("opaque").linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.uniforms.tColor)}})}),define("DS/Visualization/ViewManager",["UWA/Class","DS/CoreEvents/ModelEvents","DS/CoreEvents/Events","DS/CSICommandBinder/CSICommandBinder","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/Visualization/Filters/MaterialToUseFilter"],function(e,t,i,r,n,a,s,o){"use strict";var l={},c={},h={},u={},d=new Map,p={},f=null;function m(e,t){e.viewer=t.viewer,e.views=t.views,e._updatePlane=t._updatePlane,e._sceneEnvRootForLights=t._sceneEnvRootForLights,e._sceneEnvRootForAmbiance=t._sceneEnvRootForAmbiance,e._sceneEnvRootForTransientHighlight=t._sceneEnvRootForTransientHighlight,e._viewpointMap=t._viewpointMap}i.subscribe({event:"/VISU/VIEWER/VIEWER_DISPOSED"},function(e){var t=e.parameters.viewer;d.delete(t),f&&f.viewer===t&&(d.delete(p),f=null,d.forEach(function(e,t,i){null===f&&(f=e)}),f&&d.set(p,f))});var g=e.extend({init:function(e){if(e=e||p,f||(f=this),f.viewer!==p&&e===p)d.set(e,this),m(this,f);else if(f.viewer===p&&e!==p)f.viewer=e,d.set(e,this),m(this,f);else if(d.has(e)){m(this,d.get(e))}else d.set(e,this),this.viewer=e,this.views={},this._updatePlane=!0,this._sceneEnvRootForLights=new a("3DSyncSceneEnvRootForLights"),this._sceneEnvRootForAmbiance=new a("3DSyncSceneEnvRootForAmbiance"),this._sceneEnvRootForAmbiance._setIsAlwaysInForeground(!0),this._sceneEnvRootForTransientHighlight=new a("3DSyncSceneEnvRootForTransientHighlight"),this._sceneEnvRootForTransientHighlight.setPickable(s.PICKTHROUGH),this._sceneEnvRootForTransientHighlight.exludeFromBounding(!0),this._sceneEnvRootForTransientHighlight.setVisuFilters({_materialToUseFilter:new o(n.MaterialToUse.highlightMaterial)}),this._viewpointMap=new Map;return this},_executeParameter:function(e){e.setStaticMaterials(l),e.setDefaultMaterials(h),e.setTemporaryBodies(u),e.execute(this),this.viewer._modelEvent.publish({event:"VisuAnswer",context:this}),this.viewer.render({updateInfinitePlane:this._updatePlane})},clear:function(){for(var e in this.views)delete this.views[e]},addView:function(e,t){var i=this.views[e];return i||(i=t,this.views[e]=i),i},removeView:function(e){var t=this.views[e];return t&&(t=null,this.views[e]=t),t},getView:function(e){var t=this.views[e];return t||(t=new a,this.viewer.addNode(t),this.views[e]=t),t},getKey:function(e){for(var t in this.views)if(e===this.views[t])return t;return null},onVisuAnswer:function(e){return this.viewer._modelEvent.subscribe({event:"VisuAnswer"},e)},unsubscribe:function(e){this.viewer._modelEvent.unsubscribe(e)},_publishVisuAnswer:function(e){e&&this.viewer._modelEvent.publish({event:"VisuAnswer",context:this}),this.viewer.render({updateInfinitePlane:this._updatePlane,ekTrace:!0})},setStaticMaterial:function(e,t){return!(""===e||!t)&&(l[e]=t,!0)},getStaticMaterial:function(e){return l[e]},setStaticLook:function(e,t){return!(""===e||!t)&&(c[e]=t,!0)},getStaticLook:function(e){return c[e]},setDefaultMaterials:function(e){h=e},getDefaultMaterials:function(){return h},setTemporaryBodies:function(e){u=e||{}},updatePlaneOnViewMessage:function(e){this._updatePlane=e,d.get(this.viewer).updatePlaneOnViewMessage(e)}});return UWA.namespace("THREEDS/ViewManager",g)}),define("DS/Visualization/WebGLV6Renderer",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/CompositeShader","DS/Shaders/MirrorShaders","DS/Shaders/BloomShaders","DS/Effects/FXAAEffect","DS/Effects/MLAAEffect","DS/Effects/MSAAEffect","DS/Effects/TAAEffect","DS/Effects/SMAAEffect","DS/Effects/HighlightEffect","DS/Effects/HighlightMobileEffect","DS/Effects/SSAOEffect","DS/Effects/SSAOIterativeEffect","DS/Effects/SSLREffect","DS/Effects/NoPowerOfTwoEffect","DS/Effects/SSLReflectionEffect","DS/Effects/SSLRefractionEffect","DS/Effects/BokehDOFEffect","DS/Effects/ComputeSkyScattering","DS/Effects/BloomsEffect","DS/Effects/ToneMappingEffect","DS/Effects/FlareEffect","DS/Effects/VolumeRenderingEffect","DS/Effects/DebugPassEffect","DS/Effects/DebugShadowMapsEffect","DS/Shaders/DeferredShaders","DS/Effects/PreHighlightEffect","DS/Plugins/ComposerContext","DS/Plugins/ClearPass","DS/Visualization/RenderTargetPool","DS/Plugins/PluginPass","DS/Shaders/StereoShaders","DS/CoreEvents/Events","DS/Effects/OITEffect","DS/Plugins/CSSNodesPass","DS/Visualization/BoundingBoxGPUCompute","DS/Visualization/RenderMode","DS/Usage/TrackerAPI","DS/Effects/XRevealStructureEffect","DS/Effects/HighlightMobileNonEffect","DS/Effects/PreHighlightMobileNonEffect","DS/Effects/NativeOnTopEffect"],function(e,t,r,n,a,s,o,l,c,h,u,d,p,f,m,g,v,S,_,y,x,M,P,C,b,D,w,E,T,A,I,R,L,O,N,F,V,U,B,k,G,z,H,W,j,X){"use strict";var q=0,Z=new Set;Z.add("compareModelPass"),Z.add("oitPass"),Z.add("oitnozPass"),Z.add("xRevealStructurePass");var Y=new Set;Y.add("OIT"),Y.add("OITnoZ"),Y.add("xRevealStructure"),Y.add("NativeOnTop"),"true"===localStorage.getItem("__WEBVISU_MOBILE_QM_POC__")&&(Y.add("SSAO"),Z.add("SSAOEffect"),Z.add("SSAOEffectBlurH"),Z.add("SSAOEffectBlurV"),Z.add("GroundShadowEffect"),Z.add("GroundShadowEffectBlurH"),Z.add("GroundShadowEffectBlurV"),Z.add("mirrorBlendPass"));var K=new Set;K.add("OIT"),K.add("OITnoZ"),K.add("xRevealStructure"),K.add("Highlight"),K.add("Canvas2DHighlight"),K.add("PreHighlight"),K.add("Canvas2DPreHighlight"),K.add("SSAO"),K.add("SSLRDirect"),K.add("SSLReflection"),K.add("SSLRefraction"),K.add("NativeOnTop");var J=e.extend({init:function(e){if(this.ODTMode=e.viewer.ODTMode,this.useCompositing=void 0===e.useCompositing||e.useCompositing,this.NoOperator=0,this.SimpleOperator=1,this.LinearOperator=2,this.ReinhardOperator=3,this.FilmicOperator=4,this.UnchartedOperator=5,this.needClippingUpdate=!1,void 0!==e.canvas){if(this.canvas=e.canvas,this.divCSS=e.divCSS,this.useOffscreenCanvas=e.useOffscreenCanvas,this.antiAliasing=void 0!==e.antiAliasing?e.antiAliasing:"NoAA",this.useOffscreenCanvas?(this.cssWidth=Math.max(2,e.canvas.width),this.cssHeight=Math.max(2,e.canvas.height)):(this.cssWidth=Math.max(2,e.canvas.offsetWidth),this.cssHeight=Math.max(2,e.canvas.offsetHeight)),this.devicePixelRatio=t.getDevicePixelRatio()||1,this.deviceWidth=Math.floor(this.devicePixelRatio*this.cssWidth),this.deviceHeight=Math.floor(this.devicePixelRatio*this.cssHeight),this.viewportWidth=this.deviceWidth,this.viewportHeight=this.deviceHeight,this.brightness=void 0!==e.brightness?e.brightness:0,this.tonemapping=void 0!==e.tonemapping?e.tonemapping:1,this.disableBackFaceCulling=!1,this.visibleSpace=void 0!==e.visibleSpace?e.visibleSpace:1,this.compareSettings=e.compareSettings,this.mobile=t.mobileVersion,this._postProHighlight=!e.viewer._viewerEffectSettings._lqFallback&&(!this.mobile||!!e.forcePostProHighlight),this._postProHighlight&&(Y.add("Highlight"),Z.add("HighlightEffect"),Y.add("Canvas2DHighlight"),Z.add("Canvas2DHighlightEffect"),Y.add("PreHighlight"),Z.add("PreHighlightEffect"),Y.add("Canvas2DPreHighlight"),Z.add("Canvas2DPreHighlightEffect"),t._mobileHighlight=!1),t.isMacOS()&&(K.delete("Highlight"),K.delete("Canvas2DHighlight"),K.delete("PreHighlight"),K.delete("Canvas2DPreHighlight")),this.useAuxiliaryAsForward=!1,this.renderer=new t.WebGLRenderer({context:e.context,debugWebgl2:e.debugWebgl2||!1,alpha:!0,premultipliedAlpha:!1,antialias:!0===this.antiAliasing,canvas:this.canvas,divCSS:this.divCSS,visibleSpace:this.visibleSpace,preserveDrawingBuffer:e.preserveDrawingBuffer,debugContext:e.debugContext,sortRenderListByBuffer:!0,useCompositing:this.useCompositing}),!e.viewer.ODTMode){var i=this.renderer.getRendererInfo().gpu;"true"!==localStorage.getItem("WebVisu_Renderer_Info")&&z&&(z.trackPageEvent({eventCategory:"WebVisualization",eventAction:"WebGL-GPU",eventLabel:i,appID:"WEBVISUALIZATION_FW",persDim:{pd1:e.viewer.getWidgetID()}}),localStorage.setItem("WebVisu_Renderer_Info",!0))}this.bgColor=void 0!==e.bgColor?e.bgColor:0,this.bgAlpha=void 0!==e.bgAlpha?e.bgAlpha:1,this.setBackgroundColor(this.bgColor,this.bgAlpha),this.renderTargetPool=new O(this.renderer),this.renderer.renderTargetPool=this.renderTargetPool,this.useOffscreenCanvas?this.renderer.setGLSize(Math.max(2,this.canvas.width),Math.max(2,this.canvas.height),this.viewportWidth,this.viewportHeight,Math.max(2,this.canvas.width),Math.max(2,this.canvas.height)):this.renderer.setGLSize(this.cssWidth,this.cssHeight,this.cssWidth,this.cssHeight,this.cssWidth,this.cssHeight),this.renderer.setClearColorHex(0,0),this.renderer.gammaInput=!0,this.renderer.gammaOutput=!this.useCompositing,this.renderer.autoClear=!1,this.renderer.shadowMapCascade=!1,this._adaptativeShadows=!1,this.renderer.packESM=!0,this.renderer._gpuPickingTolerance=2,this.renderer._smallTargetPicking=this.mobile,this.gl=this.renderer.context,this.compPickingGPU=null,this.compDepth=null,this.compNormal=null,this.compNormalDepth=null,this.compMirror=null,this.compForward=null,this.composers=[],this.passPickingGPU=null,this.passDepth=null,this.passNormal=null,this.passColor=null,this.passNormalDepth=null,this.passMirror=null,this.passMirrorBlur=null,this.passMirrorBlur1=null,this.passMirrorBlur2=null,this.passMirrorBlur3=null,this.infPlanePass=null,this.mirrorBlendPass=null,this.zPostPass=null,this.forwardPass=null,this.ZOnlyPass=null,this.backgroundPass=null,this.passLightFullscreen=null,this.passLightProxy=null,this.XRevealStructureEffect=null,this.OITEffect=null,this.OITnoZEffect=null,this.PreHighlightEffect=null,this._PreHighlightMobileNonEffect=null,this.Canvas2DPreHighlightEffect=null,this.BokehDOFEffect=null,this.SkyScatteringEffect=null,this.BloomEffect=null,this.ToneMappingEffect=null,this.FlareEffect=null,this.HighlightEffect=null,this._HighlightMobileNonEffect=null,this.Canvas2DHighlightEffect=null,this.SSAOEffect=null,this.SSAOIterativeEffect=null,this.SSLREffect=null,this.SSLReflectionEffect=null,this.SSLRefractionEffect=null,this.FXAAEffect=null,this.MLAAEffect=null,this.SMAAEffect=null,this.MSAAEffect=null,this.TAAEffect=null,this.VolumeRenderingEffect=null,this.NoPowerOfTwoEffect=null,this.NativeOnTopEffect=null,this.DebugPassEffect=null,this.DebugShadowMapsEffect=null,this.customEffects=[],this.allEffects=[],this.effectStatusMap=new Map,this.renderer.sectionCappingEnabled=!1,this.meshesGPU={},this.positionsGPU={},this.normalsGPU={},this.currentGPUPickPosition={x:-1,y:-1};var n=t.FloatType,a=t.LinearFilter;this.renderer.supportsFloatTextures()||(n=t.UnsignedByteType),this.renderer.supportsFloatLinearTextures()||(a=t.NearestFilter),this.rtParamsFloatLinear={minFilter:a,magFilter:a,stencilBuffer:!0,format:t.RGBAFormat,type:n},this.rtParamsFloatNearest={minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1,format:t.RGBAFormat,type:n},this.rtParamsFloatNearestStencilBuffer={minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!0,format:t.RGBAFormat,type:n},this.rtParamsUByteNearest={minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1,format:t.RGBAFormat,type:t.UnsignedByteType},this.rtParamsUByteWithStencilBuffer={minFilter:t.NearestFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:t.UnsignedByteType},this.rtParamsUByte2={minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!1,format:t.RGBAFormat,type:t.UnsignedByteType},this.boundingBoxGPUCompute=new k(this);this.mainComposer=new r(this.renderer,void 0,this.renderTargetPool,["--\x3e(initClear)","initClearPass","--\x3einfPlane","infPlanePass","mirrorClearDepth","mirrorBlendPass","afterMirrorClearDepth","--\x3emain","backgroundPassCapping","backgroundPass","renderPriorityClear","renderPriorityStencilP4","renderPriorityStencilP3","renderPriorityStencilP2","renderPriorityStencilP1","renderPriorityStencilP0","renderPriorityDrawP3","renderPriorityDrawP2","renderPriorityDrawP1","renderPriorityDrawP0","passSectionCappingFrontFaces","cssPass","iso_0","forwardPass","iso_2","iso_3","zPostPass","ZOnlyPassCapping","ZOnlyPass","oitPass","lensFlarePass","--\x3edialog","dialogPass","fallBackOnTopPass","--\x3e(postEffects1)","passMirrorBlur","passMirrorBlur1","passMirrorBlur2","passMirrorBlur3","SSAOEffect","SSAOIterativeEffect","compareModelPass","skyScatteringPass","BokehDOFEffect","--\x3enoz","nozClearPass","nozPass","oitnoZPass","--\x3e(postEffects2)","bloomPass","compositePass","SSLREffect","VolumeRenderingEffect","FlareEffect","MSAAEffect","TAAEffect","--\x3enoEffectNoz","noEffectNozClearPass","noEffectNozPass","--\x3e(highlight)","HighlightEffect","PreHighlightEffect","highlightClearPass","highlightSinglePass","preHighlightSinglePass","DebugPassEffect","DebugShadowMapsEffect","--\x3eafterHighlightNoz","noEffectAfterHighlightNozClearPass","noEffectAfterHighlightNozPass","xRevealStructurePass","--\x3eonTop","onTopDepthSetPass","onTopPass","--\x3efurtive","furtiveClearPass","furtivePass","--\x3erobot","noEffectRobotClearPass","noEffectRobotPass","noEffectRobotOrthoPass","--\x3e(postEffects3)","FXAAEffect","MLAAEffect","SMAAEffect","--\x3ecanvas2D","noEffectCanvas2DClearPass","noEffectCanvas2DPass","Canvas2DHighlightEffect","Canvas2DPreHighlightEffect","Canvas2DhighlightClearPass","Canvas2DhighlightSinglePass","Canvas2DpreHighlightSinglePass"]),this.initForwardRender(),this.highlightPass=null,this.shadowComposerContext=null,this.pickingGPUComposerContext=null,this.pickingGPUInstancingComposerContext=null,this.normalComposerContext=null,this.depthComposerContext=null,this.normalDepthIoRRoughnessComposerContext=null,this.normalDepthComposerContext=null,this.outlineDepthComposerContext=null,this.mirrorOutlineDepthComposerContext=null,this.highlightDepthComposerContext=null,this.opaqueOnlyComposerContext=null,this.colorComposerContext=null,this.occlusionDepthComposerContext=null,this.clippingScene=null,this.superFinalComposer=null,this.customComposerContexts=null}},_updateOITScene:function(e){this.OITEffect&&(this.OITEffect.revealPass.scene=e,this.OITEffect.accumPass.scene=e),this.OITnoZEffect&&(this.OITnoZEffect.revealPass.scene=e,this.OITnoZEffect.accumPass.scene=e)},initEffect:function(e){if(this.mobile&&!Y.has(e))return null;if(!this.useCompositing&&!K.has(e))return null;var i=null;switch(e){case"xRevealStructure":this.XRevealStructureEffect=new H(this.renderer,this.renderTargetPool),i=this.XRevealStructureEffect;break;case"noPowerOfTwoEffect":this.NoPowerOfTwoEffect=new _(this.renderer,this.renderTargetPool),i=this.NoPowerOfTwoEffect;break;case"OIT":this.OITEffect=new U(this.renderer,this.renderTargetPool,this.forwardPass,"oitPass"),i=this.OITEffect;break;case"OITnoZ":this.OITnoZEffect=new U(this.renderer,this.renderTargetPool,this.nozPass,"oitnoZPass"),(i=this.OITnoZEffect).idString="noz";break;case"FXAA":this.FXAAEffect=new c(this.renderer,this.renderTargetPool),i=this.FXAAEffect;break;case"MLAA":this.MLAAEffect=new h(this.renderer,this.renderTargetPool),i=this.MLAAEffect;break;case"MSAA":this.MSAAEffect=new u(this.renderer,this.renderTargetPool),i=this.MSAAEffect;break;case"TAA":this.TAAEffect=new d(this.renderer,this.renderTargetPool),i=this.TAAEffect;break;case"SMAA":this.SMAAEffect=new p(this.renderer,this.renderTargetPool),i=this.SMAAEffect;break;case"Highlight":this.HighlightEffect=t.__unrolledHighlight()?new m(this.renderer,this.renderTargetPool,null,""):new f(this.renderer,this.renderTargetPool,null,""),i=this.HighlightEffect;break;case"PreHighlight":this.PreHighlightEffect=new I(this.renderer,this.renderTargetPool,null,""),i=this.PreHighlightEffect;break;case"Canvas2DHighlight":this.Canvas2DHighlightEffect=t.__unrolledHighlight()?new m(this.renderer,this.renderTargetPool,"canvas2D","Canvas2D"):new f(this.renderer,this.renderTargetPool,"canvas2D","Canvas2D"),i=this.Canvas2DHighlightEffect;break;case"Canvas2DPreHighlight":this.Canvas2DPreHighlightEffect=new I(this.renderer,this.renderTargetPool,"canvas2D","Canvas2D"),i=this.Canvas2DPreHighlightEffect;break;case"SSAO":this.SSAOEffect=new g(this.renderer,this.renderTargetPool),i=this.SSAOEffect;break;case"SSAOIterative":this.SSAOIterativeEffect=new v(this.renderer,this.renderTargetPool),i=this.SSAOIterativeEffect;break;case"SSLR":this.SSLREffect=new S(this.renderer,this.renderTargetPool),i=this.SSLREffect;break;case"SSLRDirect":case"SSLReflection":this.SSLReflectionEffect=new y(this.renderer,this.renderTargetPool),i=this.SSLReflectionEffect;break;case"SSLRefraction":this.SSLRefractionEffect=new x(this.renderer,this.renderTargetPool),i=this.SSLRefractionEffect;break;case"VolumeRendering":this.VolumeRenderingEffect=new w(this.renderer,this.renderTargetPool,this.ODTMode),i=this.VolumeRenderingEffect;break;case"DOF":this.BokehDOFEffect=new M(this.renderer,this.renderTargetPool),i=this.BokehDOFEffect;break;case"Bloom":this.BloomEffect=new C(this.renderer,this.renderTargetPool,!1),i=this.BloomEffect;break;case"SkyScattering":this.SkyScatteringEffect=new P(this.renderer,this.renderTargetPool),i=this.SkyScatteringEffect;break;case"ToneMapping":this.ToneMappingEffect=new b(this.renderer,this.renderTargetPool),i=this.ToneMappingEffect;break;case"Flare":this.FlareEffect=new D(this.renderer,this.renderTargetPool),i=this.FlareEffect;break;case"DebugPass":this.DebugPassEffect=new E(this.renderer,this.renderTargetPool),i=this.DebugPassEffect;break;case"DebugShadowMaps":this.DebugShadowMapsEffect=new T(this.renderer,this.renderTargetPool),i=this.DebugShadowMapsEffect;break;case"NativeOnTop":this.NativeOnTopEffect=new X(this.renderer,this.renderTargetPool),i=this.NativeOnTopEffect}return null!==i&&(i.updateComposersName(e),i.setSize(this.viewportWidth,this.viewportHeight),i.initEffect(!this.useCompositing,this),this.allEffects.push(i)),i},setEffect:function(e,t){var i=null,r=!1;if((!this.mobile||Y.has(e))&&(this.useCompositing||K.has(e))){switch(this.effectStatusMap.set(e,t),e){case"xRevealStructure":i=this.XRevealStructureEffect;break;case"OIT":i=this.OITEffect,r=!this.isDeviceCompatibleWithOIT();var n=t&&!r;this.compForwardComposerContext.needRequiredReadBuffer=n,this.zPostPass.isOITPass=n,this.forwardPass.isOITPass=n,this.renderer.useOIT=n;break;case"OITnoZ":i=this.OITnoZEffect,r=!this.isDeviceCompatibleWithOIT();n=t&&!r;this.compForwardComposerContext.needRequiredReadBuffer=n,this.nozPass.isOITPass=n,this.renderer.useOIT=n;break;case"FXAA":i=this.FXAAEffect,this.antiAliasing=t?e:"NoAA";break;case"MLAA":i=this.MLAAEffect,this.antiAliasing=t?e:"NoAA";break;case"MSAA":i=this.MSAAEffect,this.antiAliasing=t?e:"NoAA";break;case"TAA":i=this.TAAEffect,this.antiAliasing=t?e:"NoAA";break;case"SMAA":i=this.SMAAEffect,this.antiAliasing=t?e:"NoAA";break;case"FSAA":case"SSAA":this.antiAliasing=t?e:"NoAA";break;case"Vignetting":i=this.ToneMappingEffect;break;case"Highlight":i=this.HighlightEffect;break;case"PreHighlight":i=this.PreHighlightEffect;break;case"Canvas2DHighlight":i=this.Canvas2DHighlightEffect;break;case"Canvas2DPreHighlight":i=this.Canvas2DPreHighlightEffect;break;case"SSAO":i=this.SSAOEffect,r=!this.isDeviceCompatibleWithSSAO();break;case"SSAOIterative":i=this.SSAOIterativeEffect,r=!this.isDeviceCompatibleWithSSAO();break;case"SSLR":i=this.SSLREffect;break;case"SSLRDirect":case"SSLReflection":i=this.SSLReflectionEffect,r=!this.isDeviceCompatibleWithSSR(),this.renderer.useSSLR=t&&!r;break;case"SSLRefraction":i=this.SSLRefractionEffect,r=!this.isDeviceCompatibleWithSSR(),this.renderer.useSSLRefraction=t&&!r;break;case"VolumeRendering":i=this.VolumeRenderingEffect;break;case"DOF":i=this.BokehDOFEffect;break;case"Bloom":i=this.BloomEffect;break;case"ToneMapping":i=this.ToneMappingEffect;break;case"SkyScattering":i=this.SkyScatteringEffect;break;case"Flare":i=this.FlareEffect;break;case"DebugPass":i=this.DebugPassEffect;break;case"DebugShadowMaps":i=this.DebugShadowMapsEffect;break;case"NativeOnTop":i=this.NativeOnTopEffect}if(t&&!r&&(i||(i=this.initEffect(e))),null!==i){var a=t&&!r;"Vignetting"===e?i.setVignettingPower(a?10:0):i.setEnabled(a),!this.compMirrorComposerContext||"OIT"!==e&&"OITnoZ"!=e||(this.compMirrorComposerContext.enablePass(i.mixPass,this.renderer.useOIT),this.compMirrorComposerContext.needRequiredReadBuffer=this.renderer.useOIT)}this.setScale(!1),this.updateFinalComposer(!0)}},getCustomEffect:function(e){return this.customEffects[e]},addCustomEffect:function(e){if(!e)return-1;var t=this.customEffects.length;return this.customEffects.push(e),e.updateComposersName("customEffect_"+this.customEffects.length),e.setSize(this.viewportWidth,this.viewportHeight),e.initEffect(!this.useCompositing,this),t},setCustomEffect:function(e,t){var i=this.customEffects[e];null!==i&&(i.setEnabled(t),t&&i.setSize(this.viewportWidth,this.viewportHeight)),this.updateFinalComposer(!0)},updateEffects:function(e,t,i,r){this.XRevealStructureEffect&&this.XRevealStructureEffect.enabled&&this.XRevealStructureEffect.update("deferred",e,t),this.SSAOEffect&&this.SSAOEffect.enabled&&this.SSAOEffect.update("deferred",e,t,i),this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&this.SSAOIterativeEffect.update("deferred",e,t,i),this.SSLREffect&&this.SSLREffect.enabled&&this.SSLREffect.update("deferred",e,t),this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&this.SSLReflectionEffect.update("deferred",e,t,i),this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&this.SSLRefractionEffect.update("deferred",e,t,i),this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled&&this.VolumeRenderingEffect.update("deferred",e,t,i),this.HighlightEffect&&this.HighlightEffect.enabled&&this.HighlightEffect.update("forward",e,t,i,r),this._HighlightMobileNonEffect&&this._HighlightMobileNonEffect.enabled&&this._HighlightMobileNonEffect.update(e),this.PreHighlightEffect&&this.PreHighlightEffect.enabled&&this.PreHighlightEffect.update("forward",e,t,i,r),this._PreHighlightMobileNonEffect&&this._PreHighlightMobileNonEffect.enabled&&this._PreHighlightMobileNonEffect.update(e),this.Canvas2DHighlightEffect&&this.Canvas2DHighlightEffect.enabled&&this.Canvas2DHighlightEffect.update("forward",e,t,i,r),this.Canvas2DPreHighlightEffect&&this.Canvas2DPreHighlightEffect.enabled&&this.Canvas2DPreHighlightEffect.update("forward",e,t,i,r),this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&this.BokehDOFEffect.update("deferred",e,t),this.DebugShadowMapsEffect&&this.DebugShadowMapsEffect.enabled&&this.DebugShadowMapsEffect.update("forward",e,t),this.MSAAEffect&&this.MSAAEffect.enabled&&this.MSAAEffect.update("forward",e,t,i),this.TAAEffect&&this.TAAEffect.enabled&&this.TAAEffect.update("forward",e,t,i),this.SkyScatteringEffect&&this.SkyScatteringEffect.enabled&&this.SkyScatteringEffect.update("deferred",e,t),this.BloomEffect&&this.BloomEffect.enabled&&this.BloomEffect.update("deferred",e,t),this.ToneMappingEffect&&this.ToneMappingEffect.enabled&&this.ToneMappingEffect.update("deferred",e,t),this.NativeOnTopEffect&&this.NativeOnTopEffect.enabled&&this.NativeOnTopEffect.update("forward",e,t);for(var n=0;n<this.customEffects.length;n++){var a=this.customEffects[n];a&&a.enabled&&a.update("forward",e,t)}},getMaxIterationEffects:function(){var e=0;return this.SSAOEffect&&this.SSAOEffect.enabled&&(e=Math.max(e,this.SSAOEffect.getMaxIteration())),this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&(e=Math.max(e,this.SSAOIterativeEffect.getMaxIteration())),this.MSAAEffect&&this.MSAAEffect.enabled&&(e=Math.max(e,this.MSAAEffect.getMaxIteration())),this.TAAEffect&&this.TAAEffect.enabled&&(e=Math.max(e,this.TAAEffect.getMaxIteration())),e},setRendererSize:function(e,t,i,r,n,a,s,o){if(this.cssWidth!==e||this.cssHeight!==t||this.devicePixelRatio!==a||i){this.devicePixelRatio=a,this.cssWidth=Math.max(2,e),this.cssHeight=Math.max(2,t),this.deviceWidth=Math.floor(a*this.cssWidth),this.deviceHeight=Math.floor(a*this.cssHeight),this.viewportWidth=Math.floor(a*Math.max(2,r)),this.viewportHeight=Math.floor(a*Math.max(2,n));var l=this.cssWidth,c=this.cssHeight;void 0!==s&&(l=Math.max(2,s)),void 0!==o&&(c=Math.max(2,o)),this.renderer.setGLSize(this.cssWidth,this.cssHeight,r,n,l,c),this.setScale(!0)}},setBackgroundColor:function(e,i){this.bgColor=e,this.bgAlpha=i;var r=new t.Color(this.bgColor);this.renderer._backgroundColor=r,this.useCompositing&&r.copyToLinear(r,this.renderer.simpleGamma),this.bgColor=r.getHex()},resetGSSOCache:function(){this.renderer.resetGSSOCache()},_createVirtualLight:function(e,i){var r=new t.DirectionalLight;return r.originalLight=e,r.target=e.target,r.isVirtual=!0,r.LiSPSM=e.LiSPSM,r.onlyShadow=!0,r.castShadow=!0,r.shadowCameraNear=e.shadowCameraNear,r.shadowCameraFar=e.shadowCameraFar,r.shadowCameraLeft=e.shadowCameraLeft,r.shadowCameraRight=e.shadowCameraRight,r.shadowCameraBottom=e.shadowCameraBottom,r.shadowCameraTop=e.shadowCameraTop,r.shadowCameraVisible=e.shadowCameraVisible,r.shadowDarkness=e.shadowDarkness,r.shadowBias=e.shadowCascadeBias[i],r.shadowMapWidth=e.shadowCascadeWidth[i],r.shadowMapHeight=e.shadowCascadeHeight[i],r},_updateVirtualLight:function(e,t){var i=e.shadowCascadeArray[t];i.virtualLightIndex=t,i.position.copy(e.position),e.target&&(i.target.position=e.target.position,i.lookAt(i.target.position)),i.shadowCameraVisible=e.shadowCameraVisible,i.shadowDarkness=e.shadowDarkness,i.shadowBias=e.shadowCascadeBias[t]},_computeNearFarFromConvexHull:function(e,i){for(var r=i.getPoints(),n=(r.length,1/0),a=-1/0,s=new t.Vector4,o=0;o<r.length;o++)s.copy(r[o]),s.applyMatrix4(e.matrixWorldInverse),-s.z<n&&(n=-s.z),-s.z>a&&(a=-s.z);return{near:n=Math.max(e.near,n),far:a}},_clipConvexHullFromNearFar:function(e,i,r,n,a){var s=i.matrixWorld.elements,o=e.matrixWorld.elements,l=new t.Vector3(o[8],o[9],o[10]),c=new t.Vector3(-o[8],-o[9],-o[10]),h=(new t.Vector3(s[8],s[9],s[10]),(new t.Vector3).copy(l).multiplyScalar(n).add(e.position)),u=(new t.Vector3).copy(l).multiplyScalar(a).add(e.position),d=new t.Plane(l,-l.dot(h)),p=new t.Plane(c,-c.dot(u));return r.clipByPlanes([d,p])},_extrudeConvexHullAlongLightDir:function(e,i,r,n){var a=r.getPoints(),s=a.length,o=new t.CGPoly;o.setFromBox(i),o.applyMatrix4(n.matrixWorldInverse);for(var l=[],c=0;c<s;c++){var h=a[c].clone();h.applyMatrix4(n.matrixWorldInverse),l.push(h)}var u=(new t.Box3).setFromPoints(l).getPlanes();return o.clipByPlanes([u[0],u[1],u[2],u[3],u[4]])},_updateShadowCamera:function(e,i,r,n,a,s,o){var l=i.matrixWorld.elements,c=e.matrixWorld.elements,h=new t.Vector3(c[8],c[9],c[10]),u=new t.Vector3(l[8],l[9],l[10]),d=r.getPoints(),p=d.length,f=(new t.Box3).setFromPoints(d);if(i.LiSPSM){for(var m=h.dot(u),g=Math.sqrt(1-m*m),v=(n+Math.sqrt(n*a))/g,S=v+(T=Math.abs(f.max.y-f.min.y)),_=new t.Vector3(0,f.min.y-v,.5*(f.min.z+f.max.z)),y=0;y<p;y++){(P=d[y]).sub(_)}var x=0,M=0;for(y=0;y<p;y++){var P=d[y],C=Math.abs(v*P.x/P.y);(!x||C>x)&&(x=C);var b=Math.abs(v*P.z/P.y);(!M||b>M)&&(M=b)}_.applyMatrix4(o.matrixWorld),o.position.copy(_),o.matrix.elements[12]=o.position.x,o.matrix.elements[13]=o.position.y,o.matrix.elements[14]=o.position.z,o.matrixWorld.elements[12]=o.position.x,o.matrixWorld.elements[13]=o.position.y,o.matrixWorld.elements[14]=o.position.z,o.matrixWorldInverse.getInverse(o.matrixWorld);var D=(S+v)/(S-v),w=-2*S*v/(S-v),E=v/x,T=-v/M;o.projectionMatrix.set(E,0,0,0,0,D,0,w,0,0,T,0,0,1,0,0)}else o.left=f.min.x,o.right=f.max.x,o.top=f.max.y,o.bottom=f.min.y,o.near=-f.max.z,o.far=-f.min.z,o.updateProjectionMatrix()},computeShadows:function(e,i,r,n,a,s){var o,l,c,h,u,d,p,f,m=r,g=this.renderer,v=[],S=0;for(i.__lights.sort(i._lightSort),C=0,o=i.__lights.length;C<o;C++)if(((f=i.__lights[C]).castShadow||f.castGroundShadow)&&(!f.castShadow||s)&&!f.isVirtual)if(f instanceof t.DirectionalLight&&f.shadowCascade){for(l=f.shadowCascadeCount;l<f.shadowCascadeArray.length;l++){(_=f.shadowCascadeArray[l])&&(_.cameraHelper&&(_.cameraHelper.visible=!1),_.convexHullHelper&&(_.convexHullHelper.visible=!1))}for(l=0;l<f.shadowCascadeCount;l++){var _;f.shadowCascadeArray[l]?_=f.shadowCascadeArray[l]:((_=this._createVirtualLight(f,l)).originalCamera=y,f.shadowCascadeArray[l]=_,i.add(_)),this._updateVirtualLight(f,l),v[S]=_,S++}}else v[S]=f,S++;if(v.length){this.shadowComposerContext||this.initComposer("Shadow");var y=n[e];this.mainComposer.updateScene(i),this._updateOITScene(i),this.mainComposer.setComposerContext(this.shadowComposerContext);for(var x=new t.Frustum,M=(new t.Matrix4,new t.Vector3,new t.Vector3,new t.Vector3),P=[],C=0;C<129;C++){var b=t.RandomLib.LowDiscrepancy2D(C);P.push({x:b.x-.5,y:b.y-.5})}var D=g.materialToUse,w=this.disableBackFaceCulling,E=(m.isEnabled(m.BLEND),g.getScissorTest()),T=function(){g.materialToUse=t.MaterialToUse.shadowMapDepthMaterial,g.setDisableBackFaceCulling(!0),g.setDepthTest(!0),g.enableScissorTest(!1)},A=function(e){var i=g.getClearColor(),r=g.getClearAlpha();m.clearColor(i.r,i.g,i.b,r),g.setDisableBackFaceCulling(w),e?(g.enableScissorTest(E),g.materialToUse=D):g.materialToUse=t.MaterialToUse.originalMaterial};T();var I=null,R=null;if(i.boundingBox)I=i.boundingBox;else{for(var L=0;L<i.children.length;L++){var O=i.children[L];if(O.boundingSphere&&(R=O.boundingSphere),O.boundingBox){I=O.boundingBox;break}}!I&&R&&(I=R.getBoundingBox())}if(I){var N=new t.Matrix4;N.multiplyMatrices(y.projectionMatrix,y.matrixWorldInverse),x.setFromMatrix(N);var F=x.getCorners(),V=new t.CGPoly;V.setFromFrustumPoints(F);var U=I.getPlanes(),B=V.clipByPlanes(U),k=this,G=function(e){var i=y.matrixWorld.elements,r=f.matrixWorld.elements,n=new t.Vector3(-i[8],-i[9],-i[10]),a=new t.Vector3(r[8],r[9],r[10]);if(f.LiSPSM){var s=new t.Vector3;s.crossVectors(a,n),(u=new t.Vector3).crossVectors(s,a),u.normalize();var o=new t.Vector3,l=new t.Vector3,c=new t.Vector3;c.crossVectors(a,u),c.normalize(),l.crossVectors(c,a),l.normalize(),o.copy(a),o.normalize(),e.position.getPositionFromMatrix(y.matrixWorld),e.up.copy(l),M.copy(e.position),M.add(o),e.lookAt(M)}else if(e.position.copy(f.position),f.target)e.lookAt(f.target.position);else if(f instanceof t.PointLight){var h,u;switch(J){case 0:d=(new t.Vector3).set(1,0,0),h=(new t.Vector3).set(0,0,-1);break;case 1:d=(new t.Vector3).set(-1,0,0),h=(new t.Vector3).set(0,0,1);break;case 2:d=(new t.Vector3).set(0,1,0),h=(new t.Vector3).set(1,0,0);break;case 3:d=(new t.Vector3).set(0,-1,0),h=(new t.Vector3).set(1,0,0);break;case 4:d=(new t.Vector3).set(0,0,1),h=(new t.Vector3).set(1,0,0);break;case 5:d=(new t.Vector3).set(0,0,-1),h=(new t.Vector3).set(-1,0,0)}(u=new t.Vector3).crossVectors(h,d),u.normalize(),e.up.copy(u),e.lookAt((new t.Vector3).copy(f.position).add(d))}else{var d;(d=(new t.Vector3).copy(k.renderer.baseLightDirection).multiplyScalar(-1)).applyMatrix4((new t.Matrix4).extractRotation(f.matrixWorld)),e.lookAt((new t.Vector3).copy(f.position).add(d))}e.updateMatrix(),e.matrixWorld.copy(e.matrix),e.matrixWorldInverse.getInverse(e.matrixWorld),e.matrixWorldNeedsUpdate=!1,e.matrixAutoUpdate=!1},z=function(e,i){var r=e.adaptativeShadowCamera,n=e.shadowCamera;r||(r=new t.OrthographicCamera,n.clone(r),e.adaptativeShadowCamera=r);for(var a=[],s=0;s<F.length;s++){var o=F[s].clone();o.applyMatrix4(n.matrixWorldInverse),a.push(o)}var l=new t.Box3;l.setFromPoints(a);var c=new t.Box3;c.setValues(n.left,n.bottom,-n.far,n.right,n.top,-n.near),c.intersect(l);var h=c.bottom,u=c.top,d=c.right,p=c.left,f=c.near;d=c.min.x,p=c.max.x,h=c.max.y,u=c.min.y,f=-c.min.z,r.top==h&&r.bottom==u&&r.left==d&&r.right==p||(r.top=h,r.bottom=u,r.left=d,r.right=p,r.far=f,r.updateProjectionMatrix(),e.updateShadowMap=!0)};for(C=0,o=v.length;C<o;C++){var H=!(f=v[C]).shadowMap,W=g.shadowMapType===t.ESMShadowMap||g.shadowMapType===t.ESMImprovedShadowMap,j=W&&!this.renderer.packESM;if(f.shadowMap&&(H=j&&f.shadowMap.type===t.UnsignedByteType||!j&&f.shadowMap.type===t.FloatType),H){f.shadowMap&&f.shadowMap.dispose();var X=t.LinearFilter;(g.shadowMapType===t.PCFSoftShadowMap||g.shadowMapType===t.ESMShadowMap&&!j)&&(X=t.NearestFilter);var q={minFilter:X,magFilter:X,type:j?t.FloatType:t.UnsignedByteType,format:t.RGBAFormat};f instanceof t.PointLight?(W&&(f.tempRT=new t.WebGLRenderTarget(f.shadowMapWidth,f.shadowMapHeight,q)),f.shadowMap=new t.WebGLRenderTargetCube(f.shadowMapWidth,f.shadowMapHeight,q)):f.shadowMap=new t.WebGLRenderTarget(f.shadowMapWidth,f.shadowMapHeight,q),f.shadowMapSize=new t.Vector2(f.shadowMapWidth,f.shadowMapHeight),f.shadowMatrix=new t.Matrix4}if(g.transparentShadowEnabled&&!f.transparentShadowMap){q={minFilter:X=t.LinearFilter,magFilter:X,type:t.UnsignedByteType,format:t.RGBAFormat};f instanceof t.PointLight?f.transparentShadowMap=new t.WebGLRenderTargetCube(f.shadowMapWidth,f.shadowMapHeight,q):f.transparentShadowMap=new t.WebGLRenderTarget(f.shadowMapWidth,f.shadowMapHeight,q),f.transparentShadowMap.shareDepthFrom=f.shadowMap}var Z=[],Y=[];if(f instanceof t.SpotLight)f.shadowCamera||(f.shadowCamera=new t.PerspectiveCamera(f.shadowCameraFov,f.shadowMapWidth/f.shadowMapHeight,f.shadowCameraNear,f.shadowCameraFar),f.transparentShadowCamera=new t.PerspectiveCamera,g.autoUpdateScene&&i.updateMatrixWorld()),Z=[f.shadowCamera],Y=[f.transparentShadowCamera];else if(f instanceof t.DirectionalLight)f.shadowCamera||(f.shadowCamera=new t.OrthographicCamera(f.shadowCameraLeft,f.shadowCameraRight,f.shadowCameraTop,f.shadowCameraBottom,f.shadowCameraNear,f.shadowCameraFar),f.transparentShadowCamera=new t.OrthographicCamera,g.autoUpdateScene&&i.updateMatrixWorld()),this._adaptativeShadows?(G(f.shadowCamera),z(f),Z=[f.adaptativeShadowCamera]):Z=[f.shadowCamera],Y=[f.transparentShadowCamera];else{if(!(f instanceof t.PointLight)){console.error("Unsupported light type for shadow");continue}if(!f.shadowCameras){f.shadowCameras=[],f.transparentShadowCameras=[];for(C=0;C<6;C++)f.shadowCameras.push(new t.PerspectiveCamera(f.shadowCameraFov,f.shadowMapWidth/f.shadowMapHeight,f.shadowCameraNear,f.shadowCameraFar)),f.transparentShadowCameras.push(new t.PerspectiveCamera);g.autoUpdateScene&&i.updateMatrixWorld()}Z=f.shadowCameras,Y=f.transparentShadowCameras}for(var K=f.updateShadowMap,J=0;J<Z.length;J++){if(T(),d=Z[J],p=Y[J],f instanceof t.PointLight&&(f.shadowMap.activeCubeFace=J,f.transparentShadowMap&&(f.transparentShadowMap.activeCubeFace=J),f.updateShadowMap=K),g.renderIteration){var Q=f.offsetShadowCamera;Q?d=Z[J].clone(Q):(d=Z[J].clone(),f.offsetShadowCamera=d);var $=Math.abs(Z[J].right-Z[J].left),ee=Math.abs(Z[J].top-Z[J].bottom);d.left=Z[J].left+P[g.renderIteration].x*$/f.shadowMapWidth,d.right=Z[J].right+P[g.renderIteration].x*$/f.shadowMapWidth,d.bottom=Z[J].bottom+P[g.renderIteration].y*ee/f.shadowMapHeight,d.top=Z[J].top+P[g.renderIteration].y*ee/f.shadowMapHeight,d.updateProjectionMatrix()}if(f.shadowCameraVisible&&!f.cameraHelper&&(i.add(Z[J]),f.cameraHelper=new t.CameraHelper(Z[J]),Z[J].add(f.cameraHelper)),g.renderIteration<=1)if(f.isVirtual){if(!f.originalLight.updateShadowMap)continue}else if(!f.updateShadowMap)continue;if(!f.castGroundShadow||f.updateShadowMap){f.isVirtual||(f.updateShadowMap=!1),c=f.shadowMap,h=f.transparentShadowMap,u=f.shadowMatrix,G(d);var te=B.clone(),ie={near:y.near,far:y.far};if(f.isVirtual){ie=this._computeNearFarFromConvexHull(y,te);var re=f.originalLight.shadowCascadeCount,ne=f.originalLight.shadowCascadeSubNear&&f.originalLight.shadowCascadeSubNear[C],ae=f.originalLight.shadowCascadeSubFar&&f.originalLight.shadowCascadeSubFar[C];void 0===ne&&(ne=-Math.exp((1-f.virtualLightIndex/re)*Math.log(ie.near)+f.virtualLightIndex/re*Math.log(ie.far))),void 0===ae&&(ae=-Math.exp((1-(1+f.virtualLightIndex)/re)*Math.log(ie.near)+(1+f.virtualLightIndex)/re*Math.log(ie.far))),ie.near=ne,ie.far=ae,te=this._clipConvexHullFromNearFar(y,f,te,ie.near,ie.far),te=this._extrudeConvexHullAlongLightDir(f,I,te,d)}else te=this._extrudeConvexHullAlongLightDir(f,I,te,d);if((f.isVirtual||f.LiSPSM)&&this._updateShadowCamera(y,f,te,ie.near,ie.far,i,d),f.shadowCameraVisible)if(te.applyMatrix4(d.matrixWorld),f.convexHullHelper){if(f.shadowCameraHelperToUpdate){var se=new t.Color(255),oe=[new t.Color(16711680),new t.Color(65280),new t.Color(255)];f.isVirtual&&(se=f.virtualLightIndex<3?oe[f.virtualLightIndex]:(new t.Color).setRGB(0,0,.1*f.virtualLightIndex)),f.convexHullHelper.update(te,se)}}else f.convexHullHelper=new t.CGPolyHelper(te),i.add(f.convexHullHelper);if(f.convexHullHelper&&(f.convexHullHelper.visible=f.shadowCameraVisible),f.cameraHelper&&(f.cameraHelper.visible=f.shadowCameraVisible),f.shadowCameraVisible&&(f.shadowCameraHelperToUpdate?(f.cameraHelper.update(),f.cameraHelper.matrixWorld=Z[J].matrixWorld,f.cameraHelper.toUpdate=!0):f.cameraHelper.toUpdate&&(f.cameraHelper.matrixWorld=(new t.Matrix4).copy(Z[J].matrixWorld),f.cameraHelper.matrixWorldNeedsUpdate=!1,f.cameraHelper.toUpdate=!1)),u.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),u.multiply(d.projectionMatrix),f.castGroundShadow)u.multiply(d.matrixWorldInverse),f._matrixWorldReceiver&&u.multiply(f._matrixWorldReceiver);else{var le=(new t.Matrix4).copy(d.matrixWorldInverse);le.setPosition(new t.Vector3(0,0,0)),u.multiply(le)}if(W&&f instanceof t.PointLight?g.setRenderTarget(f.tempRT):g.setRenderTarget(c),W&&f instanceof t.PointLight?this.shadowComposerContext.writeBuffer=f.tempRT:this.shadowComposerContext.writeBuffer=c,W?j?m.clearColor(Math.exp(80),1,1,1):m.clearColor(.1836426750336792,.28627450980392155,.5529411764705882,.13725490196078433):m.clearColor(1,1,1,1),g.clear(),this.mainComposer.render(void 0,void 0,{main:d,mainNoJittering:d},a),g.transparentShadowEnabled){d.clone(p);var ce=function(e){return!e.hasTranspar};this.zPostPass.setDLsToDisableFunc(ce),this.forwardPass.setDLsToDisableFunc(ce),this.ZOnlyPass.setDLsToDisableFunc(ce),this.backgroundPass.setDLsToDisableFunc(ce),g.materialToUse=t.MaterialToUse.transparentShadowMaterial,g.setDisableBackFaceCulling(!1),g.setDepthTest(!0),g.setDepthWrite(!1),g.enableScissorTest(!1),g.setRenderTarget(h),this.shadowComposerContext.writeBuffer=h,m.clearColor(1,1,1,1),g.clear(!0,!1,!1),this.mainComposer.render(void 0,void 0,{main:p,mainNoJittering:p},a),this.zPostPass.setDLsToDisableFunc(null),this.forwardPass.setDLsToDisableFunc(null),this.ZOnlyPass.setDLsToDisableFunc(null),this.backgroundPass.setDLsToDisableFunc(null)}(f.castGroundShadow||W)&&(A(),!f.castGroundShadow&&W?(g.esmEffect.setSize(f.shadowMap.width,f.shadowMap.height),f instanceof t.PointLight?g.esmEffect.setInput(f.tempRT):g.esmEffect.setInput(f.shadowMap),g.esmEffect.passBlurV.setForceRenderTarget(f.shadowMap),g.esmEffect.execute()):f.castGroundShadow&&f.blurShadowEffect&&(f.blurShadowEffect.setSize(512,512),f.blurShadowEffect.setInput(f.shadowMap,u),f.blurShadowEffect.execute(),f.groundMaterial&&f.groundMaterial.updatePDSFXUniform("groundShadow",f.blurShadowEffect.getResult())))}}}A(!0)}}},_applyPickingPriorityMappingToAllPasses:function(e,t,i,r){if(e)for(var n=0;n<i.length;n++){var a=i[n];if(a&&a.id&&a.id.startsWith("R")){var s=a.getUsedStateSortingResult(this.renderer,r);s&&this.renderer.setPickingPriorityMapping(t,s)}}},computeIntersectionGPU:function(e,i,r,n,a,s,o,l,c,h,u){this.gl;var d,p=e.scene,f={},m=new Array,g=i.camera,v={main:g,mainNoJittering:g,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho};this.renderer.increaseFrameCount(t._FrameTypes.GPU_INTERSECTION),this.renderer.info.renderTime.pushRoot(t._FrameTypes.GPU_INTERSECTION),this.pickingGPUComposerContext||this.initComposer("PickingGPU"),this.renderer.gammaInput=!1;var S=this.renderer.gammaOutput;this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.mainComposer.updateScene(p),this._updateOITScene(p),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.renderer.materialToUse=t.MaterialToUse.pickingMaterial;var _=this.renderer.renderHiddenEdges;this.renderer.renderHiddenEdges=!1,this.mainComposer.setComposerContext(this.pickingGPUComposerContext);var y=this.pickingGPUComposerContext.composer.getAllPasses();this._applyPickingPriorityMappingToAllPasses(c,c,y,this.pickingGPUComposerContext),this.mainComposer.render(void 0,void 0,v,"main"),this.pickingGPUComposerContext.needsUpdate=!1,this._applyPickingPriorityMappingToAllPasses(c,null,y,this.pickingGPUComposerContext);var x,M,P=this.computeMeshPick(e,r,a,c,u),C=P.tab;for(d=0;d<C.length;++d){if((D=C[d])&&D._instancingInfos&&D._instancingInfos.isInstanceNode3D&&"instance"===D._instancingInfos.instancingSelectionMode){x=x||new t.Scene;var b=D.clone();D.copyInstancingInfos(b),x.add(b)}}for(n=n||h&&x,x&&(null===this.pickingGPUInstancingComposerContext&&this.initComposer("PickingGPUInstancing"),this.renderer.autoUpdateScene=!0,x.updateMatrixWorld(),this.mainComposer.updateScene(x),this._updateOITScene(x),this.renderer.materialToUse=t.MaterialToUse.pickingMaterialInstancing,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.pickingGPUInstancingComposerContext),this.pickingGPUInstancingComposerContext.needsUpdate=!0,this.mainComposer.render(void 0,void 0,v,"main"),this.pickingGPUInstancingComposerContext.needsUpdate=!1,M=this.computeInstancePick(e,r,a),this.pickingGPUInstancingComposerContext.needsUpdate=!0,x.dispose(),x=null),d=0;d<C.length;++d){var D;if(D=C[d])if(M&&M.has(D))M.get(D).forEach(function(e){var t={};t.object=D,t.type=P.type,t.instanceId=e,m.push(t)});else(f={}).object=D,f.type=P.type,m.push(f)}if(m.length||m.push({object:null}),n){var w=p;this.normalComposerContext||this.initComposer("Normal"),this.depthComposerContext||this.initComposer("Depth"),this.renderer.autoUpdateScene=!0,w.updateMatrixWorld(),this.mainComposer.updateScene(w),this._updateOITScene(w),this.renderer.materialToUse=t.MaterialToUse.normalMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.normalComposerContext),this.mainComposer.render(void 0,void 0,v,"main"),this.normalComposerContext.needsUpdate=!1,this.computeNormalPick(m,g,P.outMouse),this.renderer.autoUpdateScene=!0,w.updateMatrixWorld(),this.mainComposer.updateScene(w),this._updateOITScene(w),this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.depthComposerContext),this.mainComposer.render(void 0,void 0,v,"main"),this.depthComposerContext.needsUpdate=!1;var E=m[0].object&&m[0].object._occurrence?m[0].object._occurrence.node:null,T="";E&&""!==(T=E._getPickingCameraName())&&(g=i[T]),this.computePositionPick(m,g,P.outMouse)}return this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=S,this.renderer.renderHiddenEdges=_,this.renderer.info.renderTime.popRoot(t._FrameTypes.GPU_INTERSECTION),m},computeIntersectionGPUSmallTarget:function(e,i,r,n,a,s,o){this.gl;var l,c=e.scene,h={},u=new Array,d=this.renderer.getViewport(),p=d.width,f=d.height,m=Math.round(r.xPix),g=Math.round(r.yPix);this.renderer.setViewport(0,0,2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1);var v=i.camera,S={main:v,mainNoJittering:v,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho},_=null;v.fullWidth&&(_={fullWidth:v.fullWidth,fullHeight:v.fullHeight,x:v.x,y:v.y,width:v.width,height:v.height}),S.main.useRealSize=!0,S.connectedRobotCamera.useRealSize=!0,S.robotCameraOrtho.useRealSize=!0;var y=2*this.gpuPickingTolerance+1,x=this.gpuPickingTolerance,M=this.gpuPickingTolerance,P=0,C=0;if(a&&r.pt&&(P=Math.round(Math.abs(r.xPix-r.pt.xPix)),C=Math.round(Math.abs(r.yPix-r.pt.yPix))),_){var b,D;b=_.width/_.fullWidth,D=_.height/_.fullHeight;var w=_.fullWidth/p,E=_.fullHeight/f;p=_.fullWidth,f=_.fullHeight,g*=E,m=(m*=w)*b+_.x,g=g*D+_.y,x*=b,M*=D,P*=b,C*=D}var T=a&&0!==P?P:2*x+1,A=a&&0!==C?C:2*M+1,I=a?m:m-x,R=a?g:g-M;i._setPickingViewOffset({cameraSet:S,fullHeight:f,fullWidth:p,x:I,y:R-1,width:T,height:A,pickingRatioW:y/d.width,pickingRatioH:y/d.height}),this.renderer.increaseFrameCount(t._FrameTypes.GPU_INTERSECTION_SMALL),this.renderer.info.renderTime.pushRoot(t._FrameTypes.GPU_INTERSECTION_SMALL),this.pickingGPUComposerContext||this.initComposer("PickingGPU",!0),a&&this.pickingGPUComposerContext.setSize(P,C);var L=!!a;this.currentGPUPickPosition.x==m&&this.currentGPUPickPosition.y==g||(this.currentGPUPickPosition.x=m,this.currentGPUPickPosition.y=g,L=!0),this.renderer.gammaInput=!1;var O=this.renderer.gammaOutput;this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.mainComposer.updateScene(c),this._updateOITScene(c),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.renderer.materialToUse=t.MaterialToUse.pickingMaterial;var N=this.renderer.renderHiddenEdges;this.renderer.renderHiddenEdges=!1,this.mainComposer.setComposerContext(this.pickingGPUComposerContext);var F=this.pickingGPUComposerContext.composer.getAllPasses();this._applyPickingPriorityMappingToAllPasses(s,s,F,this.pickingGPUComposerContext),this.pickingGPUComposerContext.needsUpdate=L||this.pickingGPUComposerContext.needsUpdate,this.mainComposer.render(void 0,void 0,S,"main"),this.pickingGPUComposerContext.needsUpdate=!1,this._applyPickingPriorityMappingToAllPasses(s,null,F,this.pickingGPUComposerContext);var V,U,B=this.computeMeshPickSmallTarget(e,r,a,s),k=B.tab;for(l=0;l<k.length;++l){if((z=k[l])&&z._instancingInfos&&z._instancingInfos.isInstanceNode3D&&"instance"===z._instancingInfos.instancingSelectionMode){V=V||new t.Scene;var G=z.clone();z.copyInstancingInfos(G),V.add(G)}}for(n=n||o&&V,V&&(this.pickingGPUInstancingComposerContext||this.initComposer("PickingGPUInstancing",!0),a&&this.pickingGPUInstancingComposerContext.setSize(P,C),this.renderer.autoUpdateScene=!0,V.updateMatrixWorld(),this.mainComposer.updateScene(V),this._updateOITScene(V),this.renderer.materialToUse=t.MaterialToUse.pickingMaterialInstancing,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.pickingGPUInstancingComposerContext),this.pickingGPUInstancingComposerContext.needsUpdate=!0,this.mainComposer.render(void 0,void 0,S,"main"),this.pickingGPUInstancingComposerContext.needsUpdate=!1,U=this.computeInstancePickSmallTarget(e,r,a),this.pickingGPUInstancingComposerContext.needsUpdate=!0,V.dispose(),V=null),l=0;l<k.length;++l){var z;if(z=k[l])if(U&&U.has(z))U.get(z).forEach(function(e){var t={};t.object=z,t.type=B.type,t.instanceId=e,u.push(t)});else(h={}).object=z,h.type=B.type,u.push(h)}if(u.length||u.push({object:null}),n){this.normalComposerContext||this.initComposer("Normal",!0),this.depthComposerContext||this.initComposer("Depth",!0),a&&i._setPickingViewOffset({cameraSet:S,fullHeight:d.height,fullWidth:d.width,x:m-x,y:g-M-1,width:2*x+1,height:2*M+1}),this.renderer.autoUpdateScene=!0,c.updateMatrixWorld(),this.mainComposer.updateScene(c),this._updateOITScene(c),this.renderer.materialToUse=t.MaterialToUse.normalMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.normalComposerContext),this.normalComposerContext.needsUpdate=L||this.normalComposerContext.needsUpdate,this.mainComposer.render(void 0,void 0,S,"main"),this.normalComposerContext.needsUpdate=!1,this.computeNormalPickSmallTarget(u,v,B.outMouse),this.renderer.autoUpdateScene=!0,c.updateMatrixWorld(),this.mainComposer.updateScene(c),this._updateOITScene(c),this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.depthComposerContext),this.depthComposerContext.needsUpdate=L||this.depthComposerContext.needsUpdate,this.mainComposer.render(void 0,void 0,S,"main"),this.depthComposerContext.needsUpdate=!1;var H=u[0].object&&u[0].object._occurrence?u[0].object._occurrence.node:null,W="";H&&""!==(W=H._getPickingCameraName())&&(v=i[W]),this.computePositionPickSmallTarget(u,v,B.outMouse)}return this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=O,this.renderer.renderHiddenEdges=N,i._setPickingViewOffset({cameraSet:S,reset:!0}),_&&i.setViewOffset(_,!0),this.renderer.setViewport(d.x,d.y,d.width,d.height),S.main.useRealSize=!1,S.connectedRobotCamera.useRealSize=!1,S.robotCameraOrtho.useRealSize=!1,a&&(this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.pickingGPUInstancingComposerContext&&this.pickingGPUInstancingComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)),this.renderer.info.renderTime.popRoot(t._FrameTypes.GPU_INTERSECTION_SMALL),u},computeDepthBuffer:function(e,i,r){var n={main:i.camera,mainNoJittering:i.camera,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho},a=e.scene;this.depthComposerContext||this.initComposer("Depth"),r&&(this.depthComposerContext.needsUpdate=!0),this.renderer.gammaInput=!1;var s=this.renderer.gammaOutput;this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoUpdateScene=!0,a.updateMatrixWorld(),this.mainComposer.updateScene(a),this._updateOITScene(a),this.mainComposer.setComposerContext(this.depthComposerContext),this.mainComposer.render(void 0,void 0,n,"main"),this.depthComposerContext.needsUpdate=!1,this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=s},computePositionGPU:function(e,i,r){this.gl;var n=e.scene,a=[],s={main:i.camera,mainNoJittering:i.camera,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho};this.renderer.gammaInput=!1;var o=this.renderer.gammaOutput;return this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.depthComposerContext||this.initComposer("Depth"),this.renderer.autoUpdateScene=!0,n.updateMatrixWorld(),this.mainComposer.updateScene(n),this._updateOITScene(n),this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.depthComposerContext),this.mainComposer.render(void 0,void 0,s,"main"),this.depthComposerContext.needsUpdate=!1,a[0]={point:null},this.computePositionPick(a,camera,r),this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=o,a[0].point},overrideUpdate:function(e){var t=e.root._getViewer();if(e.root._getTreeModified()&&t.getCurrentSceneGraphState()&&function(){var t,i=e.root._occurrences;for(t=0;t<i.length;t++)i[t].requestOverridesUpdate()}(),e.root._getTreeModified()&&t._sceneGraphOverrideSetManager&&t._sceneGraphOverrideSetManager._updateOverridesWithMissingTarget(t),e.root._tryOverridesUpdate(t),e.root._getTreeModified()){var i=new Set;e.root.traverseUnique(function(e){if(!e._getTreeModified())return!0;i.add(e)}),i.forEach(function(e){e.__setTreeModified(!1)})}},renderRealDepth:function(e,t,i,r,n,a,s,o){this.outlineDepthComposerContext||(this.initComposer("OutlineDepth"),this.initComposer("MirrorOutlineDepth")),this.renderer.dBuffer=this.renderRealDepth_internal(e,t,i,r,n,a,s,o?this.mirrorOutlineDepthComposerContext:this.outlineDepthComposerContext,!1)},renderOcclusionRealDepth:function(e,t,i,r,n,a,s){return this.occlusionDepthComposerContext||this.initComposer("OcclusionDepth"),this.renderRealDepth_internal(e,t,i,r,n,a,s,this.occlusionDepthComposerContext,!0)},renderRealDepth_internal:function(e,i,r,n,a,s,o,l,c){l.setCameraName(e),this.mainComposer.updateScene(i),this._updateOITScene(i);var h=this.renderer.supportsFloatTextures();this.renderer.materialToUse=h&&!c?t.MaterialToUse.normalDepthMaterial:t.MaterialToUse.depthRGBAMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),r.stencilFunc(r.ALWAYS,1,4294967295),r.clearStencil(0),this.renderer.lensFlareEnabled=!1;var u,d,p=function(e){return!e.hasOcclusionDepth};return this.zPostPass.setDLsToDisableFunc(p),this.forwardPass.setDLsToDisableFunc(p),this.ZOnlyPass.setDLsToDisableFunc(p),this.backgroundPass.setDLsToDisableFunc(p),l.setPassClear(this.initClearPass,!0,new t.Color(0),0),l.enableRenderCuttingElementsPasses(s),this.mainComposer.setComposerContext(l),this.renderer.splitScreenMode&&(u=this.renderer.getScissorTest(),this.renderer.enableScissorTest(!1),d=this.renderer.getViewport(),this.renderer.setViewport(0,0,d.width,d.height)),this.renderer.initWebGLObjects(i),this.mainComposer.render(void 0,void 0,n,a),this.renderer.splitScreenMode&&(this.renderer.setViewport(d.x,d.y,d.width,d.height),this.renderer.enableScissorTest(u)),this.renderer.lensFlareEnabled=!0,this.zPostPass.setDLsToDisableFunc(null),this.forwardPass.setDLsToDisableFunc(null),this.ZOnlyPass.setDLsToDisableFunc(null),this.backgroundPass.setDLsToDisableFunc(null),this.mainComposer.getRenderResult("main")},renderOpaqueScene:function(e,i,r,n,a,s){this.opaqueOnlyComposerContext||this.initComposer("Opaque");var o,l,c=this.renderer;this.opaqueOnlyComposerContext.setCameraName(e),this.mainComposer.updateScene(i),this._updateOITScene(i),c.materialToUse=t.MaterialToUse.originalMaterial,c.autoClearDepth=!0,c.autoClearStencil=!0,r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),r.stencilFunc(r.ALWAYS,1,4294967295),r.clearStencil(0),c.lensFlareEnabled=!1,this.opaqueOnlyComposerContext.setPassClear(this.initClearPass,!0,new t.Color(0),0),this.opaqueOnlyComposerContext.enableRenderCuttingElementsPasses(s),this.mainComposer.setComposerContext(this.opaqueOnlyComposerContext),c.splitScreenMode&&(o=c.getScissorTest(),c.enableScissorTest(!1),l=c.getViewport(),c.setViewport(0,0,l.width,l.height)),this.mainComposer.render(void 0,void 0,n,a),c.splitScreenMode&&(c.setViewport(l.x,l.y,l.width,l.height),c.enableScissorTest(o)),c.lensFlareEnabled=!0},renderColorScene:function(e,i,r,n,a,s){this.colorComposerContext||this.initComposer("Color");var o,l,c=this.renderer;this.colorComposerContext.setCameraName(e),this.mainComposer.updateScene(i),this._updateOITScene(i),c.materialToUse=t.MaterialToUse.originalMaterial,c.autoClearDepth=!0,c.autoClearStencil=!0,r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),r.stencilFunc(r.ALWAYS,1,4294967295),r.clearStencil(0),c.lensFlareEnabled=!1,this.colorComposerContext.setPassClear(this.initClearPass,!0,new t.Color(0),0),this.colorComposerContext.enableRenderCuttingElementsPasses(s),this.mainComposer.setComposerContext(this.colorComposerContext),c.splitScreenMode&&(o=c.getScissorTest(),c.enableScissorTest(!1),l=c.getViewport(),c.setViewport(0,0,l.width,l.height)),this.mainComposer.render(void 0,void 0,n,a),c.splitScreenMode&&(c.setViewport(l.x,l.y,l.width,l.height),c.enableScissorTest(o)),c.lensFlareEnabled=!0},renderPoliteDepth:function(e,i,r,n,a,s,o){this.highlightDepthComposerContext||this.initComposer("HighlightDepth");var l=this.renderer;this.highlightDepthComposerContext.setCameraName(e),this.mainComposer.updateScene(i),this._updateOITScene(i),l.materialToUse=t.MaterialToUse.depthRGBAMaterial,l.autoClearDepth=!0,l.autoClearStencil=!0,r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),r.stencilFunc(r.ALWAYS,1,4294967295),r.clearStencil(0),l.lensFlareEnabled=!1;var c,h,u=function(e){return!e.hasPoliteDepth};this.zPostPass.setDLsToDisableFunc(u),this.forwardPass.setDLsToDisableFunc(u),this.ZOnlyPass.setDLsToDisableFunc(u),this.backgroundPass.setDLsToDisableFunc(u),this.highlightDepthComposerContext.setPassClear(this.initClearPass,!0,new t.Color(16777215),1),this.highlightDepthComposerContext.enableRenderCuttingElementsPasses(s),this.mainComposer.setComposerContext(this.highlightDepthComposerContext),l.splitScreenMode&&(c=l.getScissorTest(),l.enableScissorTest(!1),h=l.getViewport(),l.setViewport(0,0,h.width,h.height)),this.mainComposer.render(void 0,void 0,n,a),l.splitScreenMode&&(l.setViewport(h.x,h.y,h.width,h.height),l.enableScissorTest(c)),l.politeDepthBuffer=this.mainComposer.getRenderResult("main"),l.lensFlareEnabled=!0,this.zPostPass.setDLsToDisableFunc(null),this.forwardPass.setDLsToDisableFunc(null),this.ZOnlyPass.setDLsToDisableFunc(null),this.backgroundPass.setDLsToDisableFunc(null)},renderPostEffectNormalDepth:function(e,i,r,n,a,s,o){var l,c;this.mainComposer.updateScene(r),this._updateOITScene(r),this.renderer.materialToUse=i,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,n.stencilOp(n.REPLACE,n.REPLACE,n.REPLACE),n.stencilFunc(n.ALWAYS,1,4294967295),n.clearStencil(0),this.renderer.lensFlareEnabled=!1,e.setPassClear(this.initClearPass,!0,new t.Color(0),0),e.enableRenderCuttingElementsPasses(o),this.mainComposer.setComposerContext(e),this.renderer.splitScreenMode&&(l=this.renderer.getScissorTest(),this.renderer.enableScissorTest(!1),c=this.renderer.getViewport(),this.renderer.setViewport(0,0,c.width,c.height)),this.mainComposer.render(void 0,void 0,a,s),this.renderer.splitScreenMode&&(this.renderer.setViewport(c.x,c.y,c.width,c.height),this.renderer.enableScissorTest(l)),this.renderer.lensFlareEnabled=!0},render:function(e,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g,v,S,_,y,x){this.renderer.renderIteration=g,this.renderer.increaseFrameCount(t._FrameTypes.MAIN),this.renderer.info.renderTime.pushRoot(t._FrameTypes.MAIN),a.mainNoJittering=a.main;var M=this.MSAAEffect&&this.MSAAEffect.enabled,P=this.TAAEffect&&this.TAAEffect.enabled,C=M||P,b=C?P?this.TAAEffect:this.MSAAEffect:null;if(this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&this.BokehDOFEffect.iterative){var D=null;C&&(D=b.computeJitterValues(a.main,g)),a.main=this.BokehDOFEffect.computeJitterCamera(a.main,g,D),a.cameraBackground=this.BokehDOFEffect.computeJitterCamera(a.cameraBackground,g,D)}else C&&(q++,q%=128,a.main=b.computeJitterCamera(a.main,g||q),a.cameraBackground=b.computeJitterCamera(a.cameraBackground,g||q),a.mirrorCamera&&(a.mirrorCamera=b.computeJitterCamera(a.mirrorCamera,g)));this.overrideUpdate(s,u);var w,E,T,A,I,R=this.gl;this.renderer.gammaInput=!0,this.renderer.materialToUse=t.MaterialToUse.originalMaterial,T=s.scene;!d&&(c||this.renderer.getViewportSize().width===this.viewportWidth&&(this.renderer.getViewportSize().height,this.viewportHeight)),WUX.Selection.HSOManager,WUX.Selection.PSOManager;A=(this.HighlightEffect||this.Canvas2DHighlightEffect)&&!_,I=this.PreHighlightEffect||this.Canvas2DPreHighlightEffect,this.HighlightEffect&&this.HighlightEffect.setEnabled(A),A&&this.HighlightEffect.setSize(this.viewportWidth,this.viewportHeight),this.Canvas2DHighlightEffect&&this.Canvas2DHighlightEffect.setEnabled(A),A&&this.Canvas2DHighlightEffect.setSize(this.viewportWidth,this.viewportHeight),I&&this.PreHighlightEffect.setEnabled(I),I&&this.PreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight),I&&this.Canvas2DPreHighlightEffect.setEnabled(I),I&&this.Canvas2DPreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight),this.updateFinalComposer(c);var L=!1;if(!h||!this.useCompositing||!this.highlightPass||this.renderer._requestPoliteDepthBuffer&&null===this.renderer.politeDepthBuffer){this.pickingGPUComposerContext&&(this.pickingGPUComposerContext.needsUpdate=!0,this.meshesGPU={}),this.normalComposerContext&&(this.normalComposerContext.needsUpdate=!0,this.normalsGPU={}),this.depthComposerContext&&(this.depthComposerContext.needsUpdate=!0,this.positionsGPU={}),this.currentGPUPickPosition={x:-1,y:-1},this.renderer.reflectionColorBuffer=null,this.renderer.refractionColorBuffer=null,this.renderer.autoUpdateScene=!0,T.updateMatrixWorld(),this.renderer.initWebGLObjects(T),this.useAuxiliaryAsForward||(this.updateClippingGlobals(s,T,this,y,x),this.renderer.sectionCappingEnabled&&this.renderer.clipPlanes.length>0&&(L=!0),L&&this.updateSectionCappingScene(s,T)),this.afterMirrorClearDepth&&this.afterMirrorClearDepth.setClearStencil(L),this.renderer.shadowMapEnabled=r,this.renderer.shadowMapSoft=r,this.computeShadows("main",T,R,a,S,r),this.renderer.materialToUse=t.MaterialToUse.originalMaterial,(!g||v)&&(this.SSLREffect&&this.SSLREffect.enabled||this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled||this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled)&&(this.normalDepthIoRRoughnessComposerContext||this.initComposer("NormalDepthIoRRoughness"),this.renderPostEffectNormalDepth(this.normalDepthIoRRoughnessComposerContext,t.MaterialToUse.normalDepthIoRRoughnessMaterial,T,R,a,S,L));var O=(!g||v)&&(this.SSAOEffect&&this.SSAOEffect.enabled||this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled||this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&!this.BokehDOFEffect.iterative||T.__webglFlares&&T.__webglFlares.length||this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled);(O=O||this.TAAEffect&&this.TAAEffect.enabled||this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&(1===g||g>1&&this.MSAAEffect&&this.MSAAEffect.enabled))&&(this.normalDepthComposerContext||this.initComposer("NormalDepth"),this.renderPostEffectNormalDepth(this.normalDepthComposerContext,t.MaterialToUse.normalDepthMaterial,T,R,a,S,L)),(!g||v)&&this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&this.renderOpaqueScene("main",T,R,a,S,L),this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&(this.renderer.refractionColorBuffer=this.SSLRefractionEffect.execute()),(!g||v)&&this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&this.renderColorScene("main",T,R,a,S,L),this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&(this.renderer.reflectionColorBuffer=this.SSLReflectionEffect.execute()),this.renderer._requestPoliteDepthBuffer&&this.renderPoliteDepth(this.mobile?"main":"mainNoJittering",T,R,a,S,L,s),this.renderer.materialToUse=t.MaterialToUse.originalMaterial;var N=this.renderer.requestDBuffer||this.SkyScatteringEffect&&this.SkyScatteringEffect.enabled||this.renderer.getRenderMode(null).getMask()&t.OutlineMask;if(i){N&&this.renderRealDepth("mirrorCamera",T,R,a,S,L,s,!0),this.renderer.materialToUse=t.MaterialToUse.originalMaterial,this.compMirrorComposerContext.setPassClear(this.initClearPass,!0,new t.Color(0),0),this.compMirrorComposerContext.enableRenderCuttingElementsPasses(L),this.mainComposer.updateScene(T),this._updateOITScene(T);var F=!1;null!==o&&(F=o.visible,o.visible=!1);var V=!1,U=20*(1-l);this.passMirrorBlur.uniforms.radius.value=this.renderer._renderScale*U,U>0&&(V=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur,V),V=!1,U>12&&(V=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur1,V),V=!1,U>16&&(V=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur2,V),V=!1,U>18&&(V=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur3,V),this.compMirrorComposerContext.setRenderPlugins(this.forwardPass,!0);var B=this.renderer.renderFaceMode;this.renderer.renderFaceMode=this.renderer.renderFaceMode&~t.GeomTypeEnum.INFINITE_FACE&~t.GeomTypeEnum.AXIS_SYSTEM;var k=this.renderer.renderLineMode;this.renderer.renderLineMode=this.renderer.renderLineMode&~t.GeomTypeEnum.WIRE_EDGE;var G=this.renderer.renderPointMode;this.renderer.renderPointMode=0,this.mainComposer.setComposerContext(this.compMirrorComposerContext),this.mainComposer.render(.1,void 0,a,S),this.renderer.renderFaceMode=B,this.renderer.renderLineMode=k,this.renderer.renderPointMode=G,null!==o&&(o.visible=F)}if(N&&this.renderRealDepth("main",T,R,a,S,L,s,!1),this.renderer.materialToUse=t.MaterialToUse.originalMaterial,this.renderer.autoClear=!1,this.compForwardComposerContext.enablePass(this.infPlanePass,e),this.compForwardComposerContext.setPassClear(this.initClearPass,!0,new t.Color(this.bgColor).multiplyScalar(this.bgAlpha),this.bgAlpha),this.infPlanePass.scene=n,this.compForwardComposerContext.enableRenderCuttingElementsPasses(L),this.compForwardComposerContext.enablePass(this.mirrorBlendPass,e&&i),this.compForwardComposerContext.enablePass(this.mirrorClearDepth,e&&i),this.compForwardComposerContext.enablePass(this.afterMirrorClearDepth,i),this.compForwardComposerContext.setPassClear(this.mirrorClearDepth,!0,new t.Color(0),1),this.compForwardComposerContext.setPassClear(this.afterMirrorClearDepth,!1,new t.Color(0),1),this.compForwardComposerContext.setPassClearDepth(this.afterMirrorClearDepth,!0),this.compForwardComposerContext.setPassClear(this.initClearPass,!0,new t.Color(this.bgColor).multiplyScalar(this.bgAlpha),this.bgAlpha),this.forwardPass.scene=T,this.zPostPass.scene=T,this.backgroundPass.scene=T,this.ZOnlyPass.scene=T,this.mainComposer.updateScene(T),this._updateOITScene(T),this._postProHighlight||this._HighlightMobileNonEffect.hide(_),this.customComposerContexts){var z=this.mainComposer.getPostEffectPasses();for(E=0;E<z.length;E++)for(w=0;w<this.customComposerContexts.length;w++)this.customComposerContexts[w].enablePass(z[E],!1);for(w=0;w<this.customComposerContexts.length;w++)this.customComposerContexts[w].enablePass(this.afterMirrorClearDepth,!1),this.customComposerContexts[w].enableRenderCuttingElementsPasses(L),this.mainComposer.setComposerContext(this.customComposerContexts[w]),this.mainComposer.render(void 0,void 0,a,S)}if(p){var H=new t.WebGLRenderTargetProperties(f,f,"cubelinear"),W=this.compForwardComposerContext.originalRenderTargetProperties,j=this.compForwardComposerContext.keepResult,X=this.compForwardComposerContext.renderResults.main,Z=X.useCount;this.compForwardComposerContext.keepResult=!0,X.useCount=1,this.compForwardComposerContext.releaseRenderTargets(this.mainComposer.renderTargetPool),this.compForwardComposerContext.originalRenderTargetProperties=H,this.mainComposer.setComposerContext(this.compForwardComposerContext),this.ToneMappingEffect&&this.compForwardComposerContext.setAsLastPass(this.ToneMappingEffect.mixPass,!0),this.mainComposer.render(.1,m,a,S),this.ToneMappingEffect&&this.compForwardComposerContext.setAsLastPass(this.ToneMappingEffect.mixPass,!1),this.compForwardComposerContext.originalRenderTargetProperties=W,this.compForwardComposerContext.keepResult=j,X.useCount=Z}else this.useAuxiliaryAsForward?this.mainComposer.setComposerContext(this.auxiliaryViewpointComposerContext):this.mainComposer.setComposerContext(this.compForwardComposerContext),this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled&&this.VolumeRenderingEffect.execute(),this.mainComposer.render(.1,void 0,a,S);this.renderer.shadowMapEnabled=!1,this.renderer.shadowMapSoft=!1}else if(this.useAuxiliaryAsForward)this.mainComposer.updateScene(T),this._updateOITScene(T),this.mainComposer.setComposerContext(this.auxiliaryViewpointComposerContext),this.mainComposer.render(.1,void 0,a,S);else{if(this.customComposerContexts){this.renderer.initWebGLObjects(T),this.updateClippingGlobals(s,T,this,y,x),this.renderer.sectionCappingEnabled&&this.renderer.clipPlanes.length>0&&(L=!0),L&&this.updateSectionCappingScene(s,T);z=this.mainComposer.getPostEffectPasses();for(E=0;E<z.length;E++)for(w=0;w<this.customComposerContexts.length;w++)this.customComposerContexts[w].enablePass(z[E],!1);for(w=0;w<this.customComposerContexts.length;w++)this.customComposerContexts[w].enablePass(this.afterMirrorClearDepth,!1),this.customComposerContexts[w].enableRenderCuttingElementsPasses(L),this.mainComposer.setComposerContext(this.customComposerContexts[w]),this.mainComposer.render(void 0,void 0,a,S)}this.mainComposer.setComposerContext(this.compForwardComposerContext),this.mainComposer.updateLinks(S),this.mainComposer.setComposerContext(this.compForwardComposerContext),this.mainComposer.render(.1,void 0,a,S,this.highlightPass)}this.renderer.renderAssets(),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.renderer.setDepthFunc(R.LEQUAL),this.renderer.info.renderTime.popRoot(t._FrameTypes.MAIN)},combineResults:function(e,i,n){if(!n.isReady())return!1;if(!this.superFinalComposer){var a=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint");a.generateMipmaps=!1,this.superFinalComposer=new r(this.renderer,a,this.renderTargetPool),this.superFinalComposer.composerContext.name="superFinalComposer",n.createPasses(this.superFinalComposer)}n.updatePasses(e,i,this.compForwardComposerContext.renderResults);var s=this.renderer.getViewportSize();return this.renderer.setViewport(0,0,this.deviceWidth,this.deviceHeight),this.superFinalComposer.render(.1,void 0,{},"superFinal"),this.renderer.setViewport(0,0,s.width,s.height),!0},computeMeshPick:function(e,t,i,r,n){var a,s;n&&void 0!==t.x&&void 0!==t.y?(a=Math.round(Math.round((t.x+1)*this.viewportWidth/2)),s=Math.round(this.viewportHeight-Math.round((t.y+1)*this.viewportHeight/2))):(a=Math.round(t.xPix),s=Math.round(t.yPix));var o,l,c,h,u=i&&t.pt&&0!==Math.round(t.xPix-t.pt.xPix)?Math.round(Math.abs(t.xPix-t.pt.xPix)):1,d=i&&t.pt&&0!==Math.round(t.yPix-t.pt.yPix)?Math.round(Math.abs(t.yPix-t.pt.yPix)):1,p=this.viewportHeight,f={},m=new Set,g=a,v=s,S=!0;if(0==i){for(S=this.pickingGPUComposerContext.needsUpdate,l=a-this.gpuPickingTolerance;l<=a+this.gpuPickingTolerance;++l)for(c=s-this.gpuPickingTolerance;c<=s+this.gpuPickingTolerance;++c)this.meshesGPU[c*this.viewportWidth+l]||(S=!0);g=a-this.gpuPickingTolerance,v=s-this.gpuPickingTolerance,u=2*this.gpuPickingTolerance+1,d=2*this.gpuPickingTolerance+1}if(S){var _=new Uint8Array(4*u*d);for(this.gl.readPixels(g,p-v-d+1,u,d,this.gl.RGBA,this.gl.UNSIGNED_BYTE,_),l=0;l<u;++l)for(c=0;c<d;++c){o=(63&_[h=4*(c*u+l)])<<16|_[h+1]<<8|_[h+2];var y=_[h]>>6&3,x=f[o];void 0===x&&(x=this.getObjectById(e.scene,o),f[o]=x,x&&x.pickable&&m.add(x)),this.meshesGPU[(v+d-c-1)*this.viewportWidth+g+l]={object:x,glType:y}}}return i?{tab:Array.from(m),outMouse:t}:this._computePixelMeshPick(g,a,u,v,s,d,t,r)},computeInstancePick:function(e,t,i){var r,n,a,s,o=Math.round(t.xPix),l=Math.round(t.yPix),c=i&&t.pt&&0!==Math.round(t.xPix-t.pt.xPix)?Math.round(Math.abs(t.xPix-t.pt.xPix)):1,h=i&&t.pt&&0!==Math.round(t.yPix-t.pt.yPix)?Math.round(Math.abs(t.yPix-t.pt.yPix)):1,u=this.viewportHeight,d=o,p=l;i||(d=o-this.gpuPickingTolerance,p=l-this.gpuPickingTolerance,c+=2*this.gpuPickingTolerance,h+=2*this.gpuPickingTolerance);var f=new Uint8Array(4*c*h);this.gl.readPixels(d,u-p-h+1,c,h,this.gl.RGBA,this.gl.UNSIGNED_BYTE,f);var m=new Map,g=i?0:this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;for(n=0;n<c;++n)for(a=0;a<h;++a)if(!(0===(r=f[s=4*(a*c+n)]<<16|f[s+1]<<8|f[s+2])||r>16777215)){var v=r%5;if(0!==v&&(v>3?r=r+5-v:v<3?r-=v:r=void 0),0!==r&&void 0!==r)if(i){if(S=this.meshesGPU[(p+h-a-1)*this.viewportWidth+d+n])if(m.has(S.object))m.get(S.object).add(r);else(_=new Set).add(r),m.set(S.object,_)}else{var S,_,y=n+d-o,x=a+p-l;if(y*y+x*x<g)if(S=this.meshesGPU[(p+h-a-1)*this.viewportWidth+d+n])if(m.has(S.object))m.get(S.object).add(r);else(_=new Set).add(r),m.set(S.object,_)}}return m},computePositionPick:function(e,i,r){var n,a,s,o=r.xPix,l=r.yPix,c=this.viewportHeight,h=new Uint8Array(4);!this.depthComposerContext.needsUpdate&&this.positionsGPU[l*this.viewportWidth+o]?n=this.positionsGPU[l*this.viewportWidth+o]:(this.gl.readPixels(o,c-l,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,h),s=(a=new Float32Array(h.buffer))[0]?2*a[0]-1:1,(n=new t.Vector4(r.x,r.y,s,1)).applyMatrix4(i.projectionMatrixInverse),n.multiplyScalar(1/n.w),n.applyMatrix4(i.matrixWorld),this.positionsGPU[l*this.viewportWidth+o]=n.clone());for(var u=0;u<e.length;++u)e[u].point=new t.Vector3(n.x,n.y,n.z)},computeNormalPick:function(e,i,r){var n,a=r.xPix,s=r.yPix,o=this.viewportHeight,l=new Uint8Array(4);if(!this.normalComposerContext.needsUpdate&&this.normalsGPU[s*this.viewportWidth+a])n=this.normalsGPU[s*this.viewportWidth+a];else{this.gl.readPixels(a,o-s,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,l);var c=(n=new t.Vector4(l[0]/255*2-1,l[1]/255*2-1,l[2]/255*2-1,0)).x,h=n.y,u=n.z,d=i.matrixWorld.elements,p=1/(d[3]*c+d[7]*h+d[11]*u+d[15]);n.x=(d[0]*c+d[4]*h+d[8]*u)*p,n.y=(d[1]*c+d[5]*h+d[9]*u)*p,n.z=(d[2]*c+d[6]*h+d[10]*u)*p,this.normalsGPU[s*this.viewportWidth+a]=n.clone()}for(var f=0;f<e.length;++f)e[f].normal=new t.Vector3(n.x,n.y,n.z),e[f].tangent=null},_computePixelMeshPick:function(e,t,i,r,n,a,s,o){for(var l=0,c=0,h=0,u=0,d=null,p=!1,f=2,m=this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance,g=null,v=-1/0,S=0,_=["points","edges","faces"],y=[m,m,0],x=[m,m,0],M=function(e){return e.id===this},P=e;P<e+i;++P)for(var C=P-t,b=r;b<r+a;++b){var D=b-n,w=C*C+D*D,E=this.meshesGPU[b*this.viewportWidth+P];if(E){var T=E.object,A=E.glType,I=T&&T.hasPriorityManipulators&&T.hasPriorityManipulators();if(p&&!I)continue;S=0,T&&T.pickable&&(o&&T.pickingPriorityID&&(g=!!T.pickingPriorityID[_[A]]&&o.find(M,T.pickingPriorityID[_[A]]))&&(S=g.priority),(!p&&I||S>v&&w<=x[A]||S===v&&A<=f&&w<=y[A])&&(p=I,y[A]=w,d=T,f=A,v=S,l=P,c=b,h=P-e,u=b-r))}}return d?{tab:[d],outMouse:{xPix:l,yPix:c,xDev:h,yDev:u,x:(l-this.viewportWidth/2)/(this.viewportWidth/2),y:(this.viewportHeight/2-c)/(this.viewportHeight/2)},type:f}:{tab:[],outMouse:s}},computeMeshPickSmallTarget:function(e,t,i,r){var n,a,s=Math.round(t.xPix),o=Math.round(t.yPix),l=i&&t.pt&&0!==Math.round(t.xPix-t.pt.xPix)?Math.round(Math.abs(t.xPix-t.pt.xPix)):1,c=i&&t.pt&&0!==Math.round(t.yPix-t.pt.yPix)?Math.round(Math.abs(t.yPix-t.pt.yPix)):1,h=(this.viewportHeight,{}),u=new Set,d=s,p=o,f=!0;if(0==i){f=this.pickingGPUComposerContext.needsUpdate;for(var m=s-this.gpuPickingTolerance;m<=s+this.gpuPickingTolerance;++m)for(var g=o-this.gpuPickingTolerance;g<=o+this.gpuPickingTolerance;++g)this.meshesGPU[g*this.viewportWidth+m]||(f=!0);d=s-this.gpuPickingTolerance,p=o-this.gpuPickingTolerance,l=2*this.gpuPickingTolerance+1,c=2*this.gpuPickingTolerance+1}if(f){var v=new Uint8Array(4*l*c);for(this.gl.readPixels(0,0,l,c,this.gl.RGBA,this.gl.UNSIGNED_BYTE,v),m=0;m<l;++m)for(g=0;g<c;++g){n=(63&v[a=4*(g*l+m)])<<16|v[a+1]<<8|v[a+2];var S=v[a]>>6&3,_=h[n];void 0===_&&(_=this.getObjectById(e.scene,n),h[n]=_,_&&_.pickable&&u.add(_)),this.meshesGPU[(p+c-g-1)*this.viewportWidth+d+m]={object:_,glType:S}}}return i?{tab:Array.from(u),outMouse:t}:this._computePixelMeshPick(d,s,l,p,o,c,t,r)},computeInstancePickSmallTarget:function(e,t,i){var r,n,a,s,o=Math.round(t.xPix),l=Math.round(t.yPix),c=i&&t.pt&&0!==Math.round(t.xPix-t.pt.xPix)?Math.round(Math.abs(t.xPix-t.pt.xPix)):1,h=i&&t.pt&&0!==Math.round(t.yPix-t.pt.yPix)?Math.round(Math.abs(t.yPix-t.pt.yPix)):1,u=(this.viewportHeight,o),d=l;i||(u=o-this.gpuPickingTolerance,d=l-this.gpuPickingTolerance,c=2*this.gpuPickingTolerance+1,h=2*this.gpuPickingTolerance+1);var p=new Uint8Array(4*c*h);this.gl.readPixels(0,0,c,h,this.gl.RGBA,this.gl.UNSIGNED_BYTE,p);var f=new Map,m=i?0:this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;for(n=0;n<c;++n)for(a=0;a<h;++a)if(!(0===(r=p[s=4*(a*c+n)]<<16|p[s+1]<<8|p[s+2])||r>16777215)){var g=r%5;if(0!==g&&(g>3?r=r+5-g:g<3?r-=g:r=void 0),0!==r&&void 0!==r)if(i){if(v=this.meshesGPU[(d+h-a-1)*this.viewportWidth+u+n])if(f.has(v.object))f.get(v.object).add(r);else(S=new Set).add(r),f.set(v.object,S)}else{var v,S,_=n+u-o,y=a+d-l;if(_*_+y*y<m)if(v=this.meshesGPU[(d+h-a-1)*this.viewportWidth+u+n])if(f.has(v.object))f.get(v.object).add(r);else(S=new Set).add(r),f.set(v.object,S)}}return f},computePositionPickSmallTarget:function(e,i,r){var n,a,s,o=r.xPix,l=r.yPix,c=(this.viewportHeight,new Uint8Array(4));if(!this.depthComposerContext.needsUpdate&&this.positionsGPU[l*this.viewportWidth+o])n=this.positionsGPU[l*this.viewportWidth+o];else{var h=2*this.gpuPickingTolerance+1;this.gl.readPixels(r.xDev,h-r.yDev-1,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,c),s=(a=new Float32Array(c.buffer))[0]?2*a[0]-1:1,(n=new t.Vector4(r.x,r.y,s,1)).applyMatrix4(i.realProjectionMatrixInverse),n.multiplyScalar(1/n.w),n.applyMatrix4(i.matrixWorld),this.positionsGPU[l*this.viewportWidth+o]=n.clone()}for(var u=0;u<e.length;++u)e[u].point=new t.Vector3(n.x,n.y,n.z)},computeNormalPickSmallTarget:function(e,i,r){var n,a=r.xPix,s=r.yPix,o=(this.viewportHeight,new Uint8Array(4));if(!this.normalComposerContext.needsUpdate&&this.normalsGPU[s*this.viewportWidth+a])n=this.normalsGPU[s*this.viewportWidth+a];else{var l=2*this.gpuPickingTolerance+1;this.gl.readPixels(r.xDev,l-r.yDev-1,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,o);var c=(n=new t.Vector4(o[0]/255*2-1,o[1]/255*2-1,o[2]/255*2-1,0)).x,h=n.y,u=n.z,d=i.matrixWorld.elements,p=1/(d[3]*c+d[7]*h+d[11]*u+d[15]);n.x=(d[0]*c+d[4]*h+d[8]*u)*p,n.y=(d[1]*c+d[5]*h+d[9]*u)*p,n.z=(d[2]*c+d[6]*h+d[10]*u)*p,this.normalsGPU[s*this.viewportWidth+a]=n.clone()}for(var f=0;f<e.length;++f)e[f].normal=new t.Vector3(n.x,n.y,n.z),e[f].tangent=null},getObjectById:function(e,t){var i,r,n;if(e.pickingID===t)return e;for(i=0,r=e.children.length;i<r;i++)if(null!==(n=this.getObjectById(e.children[i],t)))return n;return null},insertComposer:function(e,t){this.mobile&&!Z.has(t.name)||(null!==e&&this.composers.push(e),t.disabledByDefault=!0,this.mainComposer.addPass(t),this.compForwardComposerContext.enablePass(t,!0),"HighlightEffect"===t.name&&(this.highlightPass=t),this.updateFinalComposer(!0))},updateFinalComposer:function(e){if(!this.mobile){var t=this.mainComposer,i=this.compForwardComposerContext;if(t){var r,s,o,l=t.getAllPasses(),c=l.length;for(r=0;r<c;r++)i.setPassRenderToCanvas(l[r],!1);if(e){for(r=c-1;r>=0;r--)if(o=l[r],i.passStates[r].enabled&&o instanceof a){i.setPassRenderToCanvas(o,!0);break}for(s=c-1;s>=0&&(o=l[s],!(i.passStates[s].enabled&&o instanceof a));s--)i.passStates[s].enabled&&(o instanceof n||o instanceof L)&&i.setPassRenderToCanvas(o,!0)}}}},getComposer:function(e){if("normalDepthIoRRoughness"===e)return this.normalDepthIoRRoughnessComposerContext||this.initComposer("NormalDepthIoRRoughness"),this.normalDepthIoRRoughnessComposerContext;if("normalDepth"===e)return this.normalDepthComposerContext||this.initComposer("NormalDepth"),this.normalDepthComposerContext;if("HighlightDepth"===e)return this.highlightDepthComposerContext||this.initComposer("HighlightDepth"),this.highlightDepthComposerContext;if("Depth"===e)return this.depthComposerContext||this.initComposer("Depth"),this.depthComposerContext;if("result"===e)return this.compForwardComposerContext;if("previousColor"===e){if(this.TAAEffect&&this.TAAEffect.enabled)return this.TAAEffect.composers[0].composerContext;if(this.MSAAEffect&&this.MSAAEffect.enabled)return this.MSAAEffect.composers[0].composerContext}else{if("opaque"===e)return this.opaqueOnlyComposerContext||this.initComposer("Opaque"),this.opaqueOnlyComposerContext;if("color"===e)return this.colorComposerContext||this.initComposer("Color"),this.colorComposerContext}return null},getInfos:function(){var e={},i=this.renderer.info.renderMap.get(t._FrameTypes.MAIN);if(i){var r={};Object.assign(r,i.getCulling()),Object.assign(r,i.getRendering()),Object.assign(r,i.getGeometries()),Object.assign(e,{memory:this.renderer.info.memory,render:r})}return e},setScale:function(e){e&&this.renderTargetPool.resetRenderTargetPool();var t="FSAA"===this.antiAliasing||"SSAA"===this.antiAliasing?2:1,i="true"===localStorage.getItem("__HALF_RES_SSAO__")||this.mobile?.707:1,r="true"===localStorage.getItem("__HALF_RES_RAYMARCHING__")||this.mobile?.707:1;i="true"===localStorage.getItem("__QUARTER_RES_SSAO__")?.5:i,r="true"===localStorage.getItem("__QUARTER_RES_RAYMARCHING__")?.5:r,this.compForwardComposerContext&&this.compForwardComposerContext.setSize(t*this.viewportWidth,t*this.viewportHeight),this.compMirrorComposerContext&&this.compMirrorComposerContext.setSize(t*this.viewportWidth,t*this.viewportHeight),this.normalDepthIoRRoughnessComposerContext&&this.normalDepthIoRRoughnessComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.normalDepthComposerContext&&this.normalDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.outlineDepthComposerContext&&this.outlineDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.mirrorOutlineDepthComposerContext&&this.mirrorOutlineDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.occlusionDepthComposerContext&&this.occlusionDepthComposerContext.setSize(this.getQuarterWidth(),this.getQuarterHeight()),this.highlightDepthComposerContext&&this.highlightDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.opaqueOnlyComposerContext&&this.opaqueOnlyComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.colorComposerContext&&this.colorComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.smallTargetPicking||(this.pickingGPUComposerContext&&this.pickingGPUComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.pickingGPUInstancingComposerContext&&this.pickingGPUInstancingComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.normalComposerContext&&this.normalComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.depthComposerContext&&this.depthComposerContext.setSize(this.viewportWidth,this.viewportHeight)),this.auxiliaryViewpointComposerContext&&this.auxiliaryViewpointComposerContext.setSize(this.viewportWidth*t,this.viewportHeight*t),this.FXAAEffect&&this.FXAAEffect.enabled&&this.FXAAEffect.setSize(this.viewportWidth,this.viewportHeight),this.MLAAEffect&&this.MLAAEffect.enabled&&this.MLAAEffect.setSize(this.viewportWidth,this.viewportHeight),this.MSAAEffect&&this.MSAAEffect.enabled&&this.MSAAEffect.setSize(this.viewportWidth,this.viewportHeight),this.TAAEffect&&this.TAAEffect.enabled&&this.TAAEffect.setSize(this.viewportWidth,this.viewportHeight),this.SMAAEffect&&this.SMAAEffect.enabled&&this.SMAAEffect.setSize(this.viewportWidth,this.viewportHeight),this.SSAOEffect&&this.SSAOEffect.enabled&&this.SSAOEffect.setSize(i*this.viewportWidth,i*this.viewportHeight),this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&this.SSAOIterativeEffect.setSize(i*this.viewportWidth,i*this.viewportHeight),this.SSLREffect&&this.SSLREffect.enabled&&this.SSLREffect.setSize(this.viewportWidth,this.viewportHeight),this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&this.SSLReflectionEffect.setSize(r*this.viewportWidth,r*this.viewportHeight),this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&this.SSLRefractionEffect.setSize(r*this.viewportWidth,r*this.viewportHeight),this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled&&this.VolumeRenderingEffect.setSize(this.viewportWidth,this.viewportHeight),this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&this.BokehDOFEffect.setSize(this.viewportWidth,this.viewportHeight),this.SkyScatteringEffect&&this.SkyScatteringEffect.enabled&&this.SkyScatteringEffect.setSize(this.viewportWidth,this.viewportHeight),this.BloomEffect&&this.BloomEffect.enabled&&this.BloomEffect.setSize(this.viewportWidth,this.viewportHeight),this.ToneMappingEffect&&this.ToneMappingEffect.enabled&&this.ToneMappingEffect.setSize(this.viewportWidth,this.viewportHeight),this.FlareEffect&&this.FlareEffect.enabled&&this.FlareEffect.setSize(this.viewportWidth,this.viewportHeight),this.HighlightEffect&&this.HighlightEffect.enabled&&this.HighlightEffect.setSize(this.viewportWidth,this.viewportHeight),this.PreHighlightEffect&&this.PreHighlightEffect.enabled&&this.PreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight),this.Canvas2DHighlightEffect&&this.Canvas2DHighlightEffect.enabled&&this.Canvas2DHighlightEffect.setSize(this.viewportWidth,this.viewportHeight),this.Canvas2DPreHighlightEffect&&this.Canvas2DPreHighlightEffect.enabled&&this.Canvas2DPreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight),this.NativeOnTopEffect&&this.NativeOnTopEffect.enabled&&this.NativeOnTopEffect.setSize(this.viewportWidth,this.viewportHeight),this.DebugPassEffect&&this.DebugPassEffect.enabled&&this.DebugPassEffect.setSize(this.viewportWidth,this.viewportHeight),this.DebugShadowMapsEffect&&this.DebugShadowMapsEffect.enabled&&this.DebugShadowMapsEffect.setSize(this.viewportWidth,this.viewportHeight),this.OITEffect&&this.OITEffect.enabled&&this.OITEffect.setSize(t*this.viewportWidth,t*this.viewportHeight),this.OITnoZEffect&&this.OITnoZEffect.enabled&&this.OITnoZEffect.setSize(t*this.viewportWidth,t*this.viewportHeight);for(var n=0;n<this.customEffects.length;n++){var a=this.customEffects[n];a&&a.enabled&&a.setSize(this.viewportWidth,this.viewportHeight)}null!==this.passMirrorBlur&&(this.passMirrorBlur.uniforms.invSize.value.x=1/this.viewportWidth,this.passMirrorBlur.uniforms.invSize.value.y=1/this.viewportHeight)},initComposer:function(e,i){var r;switch(e){case"Shadow":this.shadowComposerContext=new R(null,this.mainComposer,"shadowComposerContext"),this.shadowComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.setupOneMaterialComposerContext(this.shadowComposerContext,null,null,!1),this.shadowComposerContext._checkCamera=!0,r=this.shadowComposerContext;break;case"Depth":var n;(n=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest")).generateMipmaps=!1,this.depthComposerContext=new R(n,this.mainComposer,"depthComposerContext"),this.setupOneMaterialComposerContext(this.depthComposerContext,0,0,!0),r=this.depthComposerContext;break;case"Normal":var a;a=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest"),this.normalComposerContext=new R(a,this.mainComposer,"normalComposerContext"),this.setupOneMaterialComposerContext(this.normalComposerContext,0,1,!0),r=this.normalComposerContext;break;case"NormalDepth":(s=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"maxPrecisionNearest")).generateMipmaps=!1,this.normalDepthComposerContext=new R(s,this.mainComposer,"normalDepthComposerContext"),this.normalDepthComposerContext.keepResult=!0,this.normalDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT,this.normalDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.normalDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.normalDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.normalDepthComposerContext.enablePass(this.infPlanePass,!1),this.normalDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.normalDepthComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),this.normalDepthComposerContext.linkTo_internal(this.lensFlarePass.plugin._lensFlare.uniforms.tNormalDepth,void 0,"main"),r=this.normalDepthComposerContext;break;case"NormalDepthIoRRoughness":var s;(s=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"nearest")).generateMipmaps=!1,this.normalDepthIoRRoughnessComposerContext=new R(s,this.mainComposer,"normalDepthIoRRoughnessComposerContext"),this.normalDepthIoRRoughnessComposerContext.keepResult=!0,this.normalDepthIoRRoughnessComposerContext.enablePass(this.mirrorBlendPass,!1),this.normalDepthIoRRoughnessComposerContext.enablePass(this.mirrorClearDepth,!1),this.normalDepthIoRRoughnessComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.normalDepthIoRRoughnessComposerContext.enablePass(this.infPlanePass,!1),this.normalDepthIoRRoughnessComposerContext.setRenderPlugins(this.forwardPass,!1),this.normalDepthIoRRoughnessComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.normalDepthIoRRoughnessComposerContext;break;case"OutlineDepth":var o=this.renderer.supportsFloatTextures();(l=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,o?"nearest":"uintNearest")).generateMipmaps=!1,this.outlineDepthComposerContext=new R(l,this.mainComposer,"outlineDepthComposerContext"),this.outlineDepthComposerContext.keepResult=!0,this.outlineDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.outlineDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.outlineDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.outlineDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.outlineDepthComposerContext.enablePass(this.infPlanePass,!1),this.outlineDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.outlineDepthComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.outlineDepthComposerContext;break;case"MirrorOutlineDepth":var l;o=this.renderer.supportsFloatTextures();(l=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,o?"nearest":"uintNearest")).generateMipmaps=!1,this.mirrorOutlineDepthComposerContext=new R(l,this.mainComposer,"mirrorOutlineDepthComposerContext"),this.mirrorOutlineDepthComposerContext.keepResult=!0,this.mirrorOutlineDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.mirrorOutlineDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.mirrorOutlineDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.mirrorOutlineDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.mirrorOutlineDepthComposerContext.enablePass(this.infPlanePass,!1),this.mirrorOutlineDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.mirrorOutlineDepthComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.mirrorOutlineDepthComposerContext;break;case"OcclusionDepth":var c=new t.WebGLRenderTargetProperties(this.getQuarterWidth(),this.getQuarterHeight(),"uintNearest");c.generateMipmaps=!1,this.occlusionDepthComposerContext=new R(c,this.mainComposer,"occlusionDepthComposerContext"),this.occlusionDepthComposerContext.keepResult=!0,this.occlusionDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.occlusionDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.occlusionDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.occlusionDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.occlusionDepthComposerContext.enablePass(this.infPlanePass,!1),this.occlusionDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.occlusionDepthComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.occlusionDepthComposerContext;break;case"HighlightDepth":var h=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest");h.generateMipmaps=!1,this.highlightDepthComposerContext=new R(h,this.mainComposer,"highlightDepthComposerContext"),this.highlightDepthComposerContext.keepResult=!0,this.highlightDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.highlightDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.highlightDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.highlightDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.highlightDepthComposerContext.enablePass(this.infPlanePass,!1),this.highlightDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.highlightDepthComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.highlightDepthComposerContext;break;case"Opaque":var u=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"nearest");u.generateMipmaps=!1,this.opaqueOnlyComposerContext=new R(u,this.mainComposer,"opaqueOnlyComposerContext"),this.opaqueOnlyComposerContext.keepResult=!0,this.opaqueOnlyComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.opaqueOnlyComposerContext.enablePass(this.mirrorBlendPass,!1),this.opaqueOnlyComposerContext.enablePass(this.mirrorClearDepth,!1),this.opaqueOnlyComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.opaqueOnlyComposerContext.enablePass(this.infPlanePass,!1),this.opaqueOnlyComposerContext.setRenderPlugins(this.forwardPass,!1),this.opaqueOnlyComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.opaqueOnlyComposerContext;break;case"Color":var d=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"nearest");d.generateMipmaps=!1,this.colorComposerContext=new R(d,this.mainComposer,"colorComposerContext"),this.colorComposerContext.keepResult=!0,this.colorComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.colorComposerContext.enablePass(this.mirrorBlendPass,!1),this.colorComposerContext.enablePass(this.mirrorClearDepth,!1),this.colorComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.colorComposerContext.enablePass(this.infPlanePass,!1),this.colorComposerContext.setRenderPlugins(this.forwardPass,!1),this.colorComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.colorComposerContext;break;case"PickingGPUInstancing":(p=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest")).generateMipmaps=!1,this.pickingGPUInstancingComposerContext=new R(p,this.mainComposer,"pickingGPUInstancingComposerContext"),this.setupOneMaterialComposerContext(this.pickingGPUInstancingComposerContext,0,1,!0),this.pickingGPUInstancingComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,r=this.pickingGPUInstancingComposerContext;break;case"PickingGPU":var p;(p=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest")).generateMipmaps=!1,this.pickingGPUComposerContext=new R(p,this.mainComposer,"pickingGPUComposerContext"),this.pickingGPUComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.setupOneMaterialComposerContext(this.pickingGPUComposerContext,0,1,!0),r=this.pickingGPUComposerContext;break;case"auxiliaryViewpoint":let v=null;this.auxiliaryViewpointComposerContext=new R(v,this.mainComposer,"auxiliaryViewpointComposerContext");for(var f,m=this.mainComposer.getAllPasses(),g=0;g<m.length;g++)f=m[g],this.auxiliaryViewpointComposerContext.enablePass(f,!1);this.auxiliaryViewpointComposerContext.setPassClear(this.nozClearPass,!1),this.auxiliaryViewpointComposerContext.setPassClearDepth(this.nozClearPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.forwardPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.nozClearPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.nozPass,!0),r=this.auxiliaryViewpointComposerContext}var v=this.compForwardComposerContext.getPassState(this.zPostPass);this.__enablePassOnAllComposerContexts(this.zPostPass,v.enabled),r&&!this._postProHighlight&&(this._HighlightMobileNonEffect.disableOnComposer(r),this._PreHighlightMobileNonEffect.disableOnComposer(r))},setupOneMaterialComposerContext:function(e,i,r,n){if(e.keepResult=!0,n){e.setPassClear(this.initClearPass,!0,new t.Color(i),r);for(var a=this.mainComposer.getAllPasses(),s=0;s<a.length;s++)(o=a[s]).renderCuttingElements&&e.enablePass(o,!1)}else{var o;for(a=this.mainComposer.getAllPasses(),s=0;s<a.length;s++)o=a[s],e.enablePass(o,!1);e.enablePass(this.forwardPass,!0)}e.enablePass(this.iso_0pass,!0),e.enablePass(this.iso_2pass,!0),e.enablePass(this.iso_3pass,!0),e.enablePass(this.infPlanePass,!1),e.enablePass(this.mirrorBlendPass,!1),e.enablePass(this.mirrorClearDepth,!1),e.enablePass(this.afterMirrorClearDepth,!1),n&&(e.enablePass(this.noEffectRobotClearPass,!0),e.setPassClear(this.noEffectRobotClearPass,!1),e.setPassClearDepth(this.noEffectRobotClearPass,!0),e.enablePass(this.noEffectRobotPass,!0),e.enablePass(this.noEffectRobotOrthoPass,!0),e.enablePass(this.noEffectCanvas2DPass,!0)),n&&(e.enablePass(this.nozClearPass,!0),e.setPassClear(this.nozClearPass,!1),e.setPassClearDepth(this.nozClearPass,!0)),e.enablePass(this.nozPass,!0),n&&(e.enablePass(this.noEffectNozClearPass,!0),e.setPassClear(this.noEffectNozClearPass,!1),e.setPassClearDepth(this.noEffectNozClearPass,!0)),e.enablePass(this.noEffectNozPass,!0),n&&(e.enablePass(this.noEffectAfterHighlightNozClearPass,!0),e.setPassClear(this.noEffectAfterHighlightNozClearPass,!1),e.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,!0)),e.enablePass(this.noEffectAfterHighlightNozPass,!0),e.enablePass(this.dialogPass,!0),n&&(e.enablePass(this.furtiveClearPass,!0),e.setPassClear(this.furtiveClearPass,!1),e.setPassClearDepth(this.furtiveClearPass,!0)),e.enablePass(this.furtivePass,!1),this.NativeOnTopEffect.disablePasses(e),n&&(e.enablePass(this.noEffectCanvas2DClearPass,!0),e.setPassClear(this.noEffectCanvas2DClearPass,!1),e.setPassClearDepth(this.noEffectCanvas2DClearPass,!0)),e.setRenderPlugins(this.forwardPass,!1)},initForwardRender:function(){var e,i=null;(this.initClearPass=new L("initClearPass"),this.infPlanePass=new n(null,null,null,G.facesMask,null,null,"infPlanePass"),this.infPlanePass.lockScene=!0,this.infPlanePass.setCameraName("cameraBackground"),this.zPostPass=new n(null,null,null,null,null,null,"zPostPass"),this.zPostPass.setDisableDepthWrite(!0),this.zPostPass.forcePolygonOffset=t.PolygonOffsetForceStatus.DISABLED,this.zPostPass.disabledByDefault=!0,this.forwardPass=new n(null,null,null,null,null,null,"forwardPass"),this.cssPass=new B(null,"cssPass"),this.backgroundPass=new n(null,null,null,G.facesMask,null,null,"backgroundPass"),this.backgroundPass.idString="background",this.backgroundPass.setMaterialToUse(t.MaterialToUse.ZOnlyMaterial),this.ZOnlyPass=new n(null,null,null,null,null,null,"ZOnlyPass"),this.ZOnlyPass.idString="ZOnly",this.ZOnlyPass.setMaterialToUse(t.MaterialToUse.ZOnlyMaterial),this.lensFlarePass=new N(null,null,"lensFlarePass",new t.LensFlarePlugin,this.renderer),this.forwardPass.setDisableBackFaceCulling(this.disableBackFaceCulling),this.zPostPass.setDisableBackFaceCulling(this.disableBackFaceCulling),this.zPostPass.setStateSortingResultFrom(this.forwardPass,!1),this.iso_0Pass=new n(null,null,null,void 0,void 0,void 0,"iso_0"),this.iso_0Pass.idString="iso_0",this.iso_2Pass=new n(null,null,null,void 0,void 0,void 0,"iso_2"),this.iso_2Pass.idString="iso_2",this.iso_3Pass=new n(null,null,null,void 0,void 0,void 0,"iso_3"),this.iso_3Pass.idString="iso_3",this.mirrorBlendPass=new a(o.blend,void 0,"mirrorBlendPass"),e=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear"),this.useCompositing&&(i=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear")),this.useCompositing||(this.mirrorBlendPass.disabledByDefault=!0,this.mirrorBlendPass.needsSwap=!1,this.mirrorBlendPass.material.defines.POSTPRO=0,this.mirrorBlendPass.material.transparent=!0,this.mirrorBlendPass.material.needsUpdate=!0),this.compForwardComposerContext=new R(i,this.mainComposer,"compForwardComposerContext"),this.compForwardComposerContext.keepResult=!0,this.mainComposer.addPass(this.initClearPass),this.mainComposer.addPass(this.infPlanePass),null!==this.mirrorBlendPass&&(this.mirrorClearDepth=new L("mirrorClearDepth"),this.mirrorClearDepth.clear=!1,this.mirrorClearDepth.setClearDepth(!1),this.afterMirrorClearDepth=new L("afterMirrorClearDepth"),this.mainComposer.addPass(this.mirrorBlendPass),this.mainComposer.addPass(this.afterMirrorClearDepth)),this.passSectionCappingFrontFaces=new n(null,null,null,void 0,!1,!1,"passSectionCappingFrontFaces"),this.passSectionCappingFrontFaces.setRenderCuttingElements(!0),this.passSectionCappingFrontFaces.setEnableStencilTest(!0),this.passSectionCappingFrontFaces.setEnableStencilWrite(!0),this.passSectionCappingFrontFaces.setDisableColorWrite(!0),this.passSectionCappingFrontFaces.setDisableDepthWrite(!0),this.passSectionCappingFrontFaces.setStencilFunc("ALWAYS"),this.passSectionCappingFrontFaces.setStencilOps("INCR_WRAP","DECR_WRAP"),this.passSectionCappingFrontFaces.setDisableBackFaceCulling(!0),this.passSectionCappingFrontFaces.setHideSurfacesAndUnclippedMeshes(!0),this.passSectionCappingFrontFaces.setDisableBackFaceClipPlanes(1),this.passSectionCappingFrontFaces.setRenderPluginsPre(!1),this.passSectionCappingFrontFaces.setRenderPluginsPost(!1),this.passSectionCappingFrontFaces.ignoreNoZ=!0,this.mainComposer.addPass(this.cssPass),this.mainComposer.addPass(this.iso_0Pass),this.mainComposer.addPass(this.forwardPass),this.mainComposer.addPass(this.iso_2Pass),this.mainComposer.addPass(this.iso_3Pass),this.mainComposer.addPass(this.zPostPass),this.mainComposer.addPass(this.backgroundPass),this.mainComposer.addPass(this.ZOnlyPass),this.mainComposer.addPass(this.lensFlarePass),this.mainComposer.addPass(this.passSectionCappingFrontFaces),this.ZOnlyPassCapping=new n(null,null,null,void 0,!1,!1,"ZOnlyPassCapping"),this.ZOnlyPassCapping.setRenderCuttingElements(!0),this.ZOnlyPassCapping.setEnableStencilTest(!0),this.ZOnlyPassCapping.setEnableStencilWrite(!0),this.ZOnlyPassCapping.setDisableColorWrite(!0),this.ZOnlyPassCapping.setDisableDepthWrite(!0),this.ZOnlyPassCapping.setStencilFunc("ALWAYS"),this.ZOnlyPassCapping.setStencilOps("INCR_WRAP","DECR_WRAP"),this.ZOnlyPassCapping.setDisableBackFaceCulling(!0),this.ZOnlyPassCapping.setHideSurfacesAndUnclippedMeshes(!0),this.ZOnlyPassCapping.setDisableBackFaceClipPlanes(1),this.ZOnlyPassCapping.setRenderPluginsPre(!1),this.ZOnlyPassCapping.setRenderPluginsPost(!1),this.ZOnlyPassCapping.ignoreNoZ=!0,this.ZOnlyPassCapping.setMaterialToUse(t.MaterialToUse.ZOnlyMaterial),this.ZOnlyPassCapping.idString="ZOnly",this.mainComposer.addPass(this.ZOnlyPassCapping),this.backgroundPassCapping=new n(null,null,null,void 0,!1,!1,"backgroundPassCapping"),this.backgroundPassCapping.setRenderCuttingElements(!0),this.backgroundPassCapping.setEnableStencilTest(!0),this.backgroundPassCapping.setEnableStencilWrite(!0),this.backgroundPassCapping.setDisableColorWrite(!0),this.backgroundPassCapping.setDisableDepthWrite(!0),this.backgroundPassCapping.setStencilFunc("ALWAYS"),this.backgroundPassCapping.setStencilOps("INCR_WRAP","DECR_WRAP"),this.backgroundPassCapping.setDisableBackFaceCulling(!0),this.backgroundPassCapping.setHideSurfacesAndUnclippedMeshes(!0),this.backgroundPassCapping.setDisableBackFaceClipPlanes(1),this.backgroundPassCapping.setRenderPluginsPre(!1),this.backgroundPassCapping.setRenderPluginsPost(!1),this.backgroundPassCapping.ignoreNoZ=!0,this.backgroundPassCapping.setMaterialToUse(t.MaterialToUse.ZOnlyMaterial),this.backgroundPassCapping.idString="background",this.mainComposer.addPass(this.backgroundPassCapping),this.compForwardComposerContext.enablePass(this.zPostPass,!1),this.compForwardComposerContext.setRenderPlugins(this.forwardPass,!0),this.compForwardComposerContext.enablePass(this.lensFlarePass,!0),this.compForwardComposerContext.enablePass(this.backgroundPass,!0),this.compForwardComposerContext.enablePass(this.ZOnlyPass,!0),this.compForwardComposerContext.enablePass(this.cssPass,!0),this.passMirrorBlur=new a(l.PoissonBlur,void 0,"passMirrorBlur"),this.passMirrorBlur.material.needsUpdate=!0,this.passMirrorBlur.disabledByDefault=!0,this.passMirrorBlur1=new a(l.PoissonBlur,void 0,"passMirrorBlur1"),this.passMirrorBlur1.disabledByDefault=!0,this.passMirrorBlur2=new a(l.PoissonBlur,void 0,"passMirrorBlur2"),this.passMirrorBlur2.disabledByDefault=!0,this.passMirrorBlur3=new a(l.PoissonBlur,void 0,"passMirrorBlur3"),this.passMirrorBlur3.disabledByDefault=!0,this.passMirrorBlur.uniforms.invSize.value.x=1/this.viewportWidth,this.passMirrorBlur.uniforms.invSize.value.y=1/this.viewportHeight,this.passMirrorBlur3.uniforms.invSize=this.passMirrorBlur2.uniforms.invSize=this.passMirrorBlur1.uniforms.invSize=this.passMirrorBlur.uniforms.invSize,this.mainComposer.addPass(this.passMirrorBlur),this.mainComposer.addPass(this.passMirrorBlur1),this.mainComposer.addPass(this.passMirrorBlur2),this.mainComposer.addPass(this.passMirrorBlur3),this.nozClearPass=new L("nozClearPass"),this.nozClearPass.idString="noz",this.nozPass=new n(null,null,null,void 0,void 0,void 0,"nozPass"),this.nozPass.idString="noz",this.mainComposer.addPass(this.nozClearPass),this.mainComposer.addPass(this.nozPass),this.noEffectNozClearPass=new L("noEffectNozClearPass"),this.noEffectNozClearPass.idString="noEffectNoz",this.noEffectNozPass=new n(null,null,null,void 0,void 0,void 0,"noEffectNozPass"),this.noEffectNozPass.idString="noEffectNoz",this.mainComposer.addPass(this.noEffectNozClearPass),this.mainComposer.addPass(this.noEffectNozPass),this._postProHighlight||(this._HighlightMobileNonEffect=new W(this),this._PreHighlightMobileNonEffect=new j(this)),this.noEffectAfterHighlightNozClearPass=new L("noEffectAfterHighlightNozClearPass"),this.noEffectAfterHighlightNozClearPass.idString="afterHighlightNoZ",this.noEffectAfterHighlightNozClearPass.order=60,this.noEffectAfterHighlightNozPass=new n(null,null,null,void 0,void 0,void 0,"noEffectAfterHighlightNozPass"),this.noEffectAfterHighlightNozPass.idString="afterHighlightNoZ",this.noEffectAfterHighlightNozPass.order=61,this.noEffectAfterHighlightNozPass.setCameraName("mainNoJittering"),this.mainComposer.addPass(this.noEffectAfterHighlightNozClearPass),this.mainComposer.addPass(this.noEffectAfterHighlightNozPass),this.dialogPass=new n(null,null,null,void 0,void 0,void 0,"dialogPass"),this.dialogPass.setGSSOCache(!1),this.dialogPass.idString="dialog",this.mainComposer.addPass(this.dialogPass),this.furtiveClearPass=new L("furtiveClearPass"),this.furtiveClearPass.idString="furtive",this.furtivePass=new n(null,null,null,void 0,void 0,void 0,"furtivePass"),this.furtivePass.idString="furtive",this.mainComposer.addPass(this.furtiveClearPass),this.mainComposer.addPass(this.furtivePass),this.noEffectRobotClearPass=new L("noEffectRobotClearPass"),this.noEffectRobotClearPass.order=70,this.noEffectRobotPass=new n(null,null,null,G.facesMask,void 0,void 0,"noEffectRobotPass"),this.noEffectRobotPass.idString="robot",this.noEffectRobotPass.setDisableClippingPlanes(!0),this.noEffectRobotPass.setDisableToneMapping(!0),this.noEffectRobotPass.isRobotPass=!0,this.noEffectRobotPass.setCameraName("connectedRobotCamera"),this.noEffectRobotPass.order=71,this.noEffectRobotPass.setForceMaterialMode(!0),this.noEffectRobotOrthoPass=new n(null,null,null,G.facesMask,void 0,void 0,"noEffectRobotOrthoPass"),this.noEffectRobotOrthoPass.idString="robotOrtho",this.noEffectRobotOrthoPass.setDisableClippingPlanes(!0),this.noEffectRobotOrthoPass.setCameraName("robotCameraOrtho"),this.noEffectRobotOrthoPass.order=72,this.noEffectRobotOrthoPass.isRobotPass=!0,this.noEffectRobotOrthoPass.setDisableToneMapping(!0),this.noEffectRobotOrthoPass.setForceMaterialMode(!0),this.noEffectCanvas2DClearPass=new L("noEffectCanvas2DClearPass"),this.noEffectCanvas2DClearPass.disabledByDefault=!0,this.noEffectCanvas2DClearPass.idString="canvas2D",this.noEffectCanvas2DPass=new n(null,null,null,void 0,void 0,void 0,"noEffectCanvas2DPass"),this.noEffectCanvas2DPass.idString="canvas2D",this.noEffectCanvas2DPass.disabledByDefault=!0,this.noEffectCanvas2DPass.setDisableClippingPlanes(!0),this.noEffectCanvas2DPass.order=1e5,this.noEffectCanvas2DPass.setDisableToneMapping(!0),this.noEffectCanvas2DPass.setCameraName("mainNoJittering"),this.mainComposer.addPass(this.noEffectRobotClearPass),this.mainComposer.addPass(this.noEffectRobotPass),this.mainComposer.addPass(this.noEffectRobotOrthoPass),this.mainComposer.addPass(this.noEffectCanvas2DClearPass),this.mainComposer.addPass(this.noEffectCanvas2DPass),this.compForwardComposerContext.enablePass(this.noEffectCanvas2DPass,!0),this.compForwardComposerContext.enablePass(this.noEffectCanvas2DClearPass,!0),this.compMirrorComposerContext=new R(e,this.mainComposer,"compMirrorComposerContext"),this.compMirrorComposerContext.linkToShaderPassUniform(this.mirrorBlendPass,this.mirrorBlendPass.uniforms.tReflectedScene),this.compMirrorComposerContext.enablePass(this.mirrorBlendPass,!1),this.compMirrorComposerContext.enablePass(this.mirrorClearDepth,!1),this.compMirrorComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.compMirrorComposerContext.enableRenderCuttingElementsPasses(!0),this.compMirrorComposerContext.enablePass(this.infPlanePass,!1),this.compMirrorComposerContext.enablePass(this.noEffectRobotClearPass,!1),this.compMirrorComposerContext.enablePass(this.noEffectRobotOrthoPass,!1),this.compMirrorComposerContext.setPassClear(this.noEffectRobotClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.noEffectRobotClearPass,!0),this.compMirrorComposerContext.enablePass(this.nozPass,!1),this.compMirrorComposerContext.setPassClear(this.nozClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.nozClearPass,!0),this.compMirrorComposerContext.enablePass(this.noEffectNozPass,!1),this.compMirrorComposerContext.setPassClear(this.noEffectNozClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.noEffectNozClearPass,!0),this.compMirrorComposerContext.enablePass(this.noEffectAfterHighlightNozPass,!1),this.compMirrorComposerContext.setPassClear(this.noEffectAfterHighlightNozClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,!0),this.compMirrorComposerContext.enablePass(this.dialogPass,!1),this.compMirrorComposerContext.enablePass(this.furtivePass,!1),this.compMirrorComposerContext.setPassClear(this.furtiveClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.furtiveClearPass,!0),this.compMirrorComposerContext.setCameraName("mirrorCamera"),this.compMirrorComposerContext.setBeforeRenderCB(function(e){e.composer.renderer.initWebGLObjects(e.composer.renderScene);var t,i,r=e.composer.renderScene.getAllWebGLObjects(e.composer.renderer.currentFrameIndex);for(i=0;i<r.length;i++)null!==r[i]&&(t=r[i].object).disableMirror&&t.visible&&(t.visible=!1,t.disableMirror=2)}),this.compMirrorComposerContext.setAfterRenderCB(function(e){var t,i,r=e.composer.renderScene.getAllWebGLObjects(e.composer.renderer.currentFrameIndex);for(i=0;i<r.length;i++)null!==r[i]&&2===(t=r[i].object).disableMirror&&(t.visible=!0,t.disableMirror=1)}),this.useCompositing)&&(new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint").generateMipmaps=!1,this.compositeClearPass=new L("compositeClearPass"),this.compositeClearPass.invertTarget=!0,this.canvas2DPass=new n(null,null,null,void 0,void 0,void 0,"canvas2DPass"),this.canvas2DPass.order=1100,this.canvas2DPass.idString="canvas2D",this.canvas2DPass.setDisableToneMapping(!0),this.canvas2DPass.setDisableClippingPlanes(!0),this.compositeClearPass.order=5,this.setEffect("ToneMapping",!0),this.ToneMappingEffect.setBrightness(this.brightness),this.ToneMappingEffect.setToneMapping(this.tonemapping));this.setEffect("NativeOnTop",!0),this.compForwardComposerContext.setPassClear(this.noEffectRobotClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectRobotClearPass,!0),this.compForwardComposerContext.setPassClear(this.nozClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.nozClearPass,!0),this.compForwardComposerContext.setPassClear(this.noEffectNozClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectNozClearPass,!0),this.compForwardComposerContext.setPassClear(this.noEffectAfterHighlightNozClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,!0),this.compForwardComposerContext.setPassClear(this.furtiveClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.furtiveClearPass,!0),this.compForwardComposerContext.setPassClear(this.noEffectCanvas2DClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectCanvas2DClearPass,!0)},resetClippingScene:function(){this.clippingScene=null},__enablePassOnAllComposerContexts:function(e,t){this.compForwardComposerContext&&this.compForwardComposerContext.enablePass(e,t),this.compMirrorComposerContext&&this.compMirrorComposerContext.enablePass(e,t),this.shadowComposerContext&&this.shadowComposerContext.enablePass(e,t),this.depthComposerContext&&this.depthComposerContext.enablePass(e,t),this.normalComposerContext&&this.normalComposerContext.enablePass(e,t),this.normalDepthIoRRoughnessComposerContext&&this.normalDepthIoRRoughnessComposerContext.enablePass(e,t),this.normalDepthComposerContext&&this.normalDepthComposerContext.enablePass(e,t),this.outlineDepthComposerContext&&this.outlineDepthComposerContext.enablePass(e,t),this.mirrorOutlineDepthComposerContext&&this.mirrorOutlineDepthComposerContext.enablePass(e,t),this.occlusionDepthComposerContext&&this.occlusionDepthComposerContext.enablePass(e,t),this.highlightDepthComposerContext&&this.highlightDepthComposerContext.enablePass(e,t),this.opaqueOnlyComposerContext&&this.opaqueOnlyComposerContext.enablePass(e,t),this.colorComposerContext&&this.colorComposerContext.enablePass(e,t),this.pickingGPUComposerContext&&this.pickingGPUComposerContext.enablePass(e,t),this.pickingGPUInstancingComposerContext&&this.pickingGPUInstancingComposerContext.enablePass(e,t)},_enableZPrePass:function(e){this.forwardPass&&(this.compForwardComposerContext.getPassState(this.zPostPass).enabled!==e&&(e?(this.forwardPass.setDisableColorWrite(!0),this.forwardPass.forcePolygonOffset=t.PolygonOffsetForceStatus.ENABLED,this.__enablePassOnAllComposerContexts(this.zPostPass,!0)):(this.forwardPass.forcePolygonOffset=t.PolygonOffsetForceStatus.DEFAULT,this.forwardPass.setDisableColorWrite(!1),this.__enablePassOnAllComposerContexts(this.zPostPass,!1))))},dispose:function(){this.compForwardComposerContext&&(this.compForwardComposerContext.dispose(),this.compForwardComposerContext=null),this.compMirrorComposerContext&&(this.compMirrorComposerContext.dispose(),this.compMirrorComposerContext=null),this.shadowComposerContext&&(this.shadowComposerContext.dispose(),this.shadowComposerContext=null),this.depthComposerContext&&(this.depthComposerContext.dispose(),this.depthComposerContext=null),this.normalComposerContext&&(this.normalComposerContext.dispose(),this.normalComposerContext=null),this.normalDepthIoRRoughnessComposerContext&&(this.normalDepthIoRRoughnessComposerContext.dispose(),this.normalDepthIoRRoughnessComposerContext=null),this.normalDepthComposerContext&&(this.normalDepthComposerContext.dispose(),this.normalDepthComposerContext=null),this.outlineDepthComposerContext&&(this.outlineDepthComposerContext.dispose(),this.outlineDepthComposerContext=null),this.mirrorOutlineDepthComposerContext&&(this.mirrorOutlineDepthComposerContext.dispose(),this.mirrorOutlineDepthComposerContext=null),this.occlusionDepthComposerContext&&(this.occlusionDepthComposerContext.dispose(),this.occlusionDepthComposerContext=null),this.highlightDepthComposerContext&&(this.highlightDepthComposerContext.dispose(),this.highlightDepthComposerContext=null),this.opaqueOnlyComposerContext&&(this.opaqueOnlyComposerContext.dispose(),this.opaqueOnlyComposerContext=null),this.colorComposerContext&&(this.colorComposerContext.dispose(),this.colorComposerContext=null),this.pickingGPUComposerContext&&(this.pickingGPUComposerContext.dispose(),this.pickingGPUComposerContext=null),this.pickingGPUInstancingComposerContext&&(this.pickingGPUInstancingComposerContext.dispose(),this.pickingGPUInstancingComposerContext=null),this.lensFlarePass&&(this.lensFlarePass.dispose(),this.lensFlarePass=null);for(var e=0;e<this.allEffects.length;e++)this.allEffects[e]&&this.allEffects[e].dispose&&this.allEffects[e].dispose();for(e=0;e<this.customEffects.length;e++)this.customEffects[e]&&this.customEffects[e].dispose&&this.customEffects[e].dispose();for(var t in this.renderer.fixedSizeArrayPool.dispose(),this.allEffects=null,this.customEffects=null,this.mainComposer.dispose(),this.renderer.dispose(),this)this.hasOwnProperty(t)&&(this[t]=null)},isDeviceCompatibleWithSSR:function(){return this.renderer.supportsFloatTextures()},isDeviceCompatibleWithSSAO:function(){return this.renderer.supportsFloatTextures()||this.renderer.supportsHalfFloatTextures()},isDeviceCompatibleWithOIT:function(){return this.renderer.supportsFloatTextures()||this.renderer.supportsHalfFloatTextures()},setDisableBackFaceCulling:function(e){this.disableBackFaceCulling=e,this.forwardPass&&(this.forwardPass.setDisableBackFaceCulling(this.disableBackFaceCulling),this.zPostPass.setDisableBackFaceCulling(this.disableBackFaceCulling))},clearCameraSystemData:function(){this.superFinalComposer=null},resizeNPOTTexture:function(){this.NoPowerOfTwoEffect||this.initEffect("noPowerOfTwoEffect");for(let i of this.renderer._texturesToResize){var e=new t.NonPowerOfTwoTexture(i,i.mipmaps);this.NoPowerOfTwoEffect.setTextures(e),this.NoPowerOfTwoEffect.copyToDataTexture(this.gl,i),i.format=1021,i.needsUpdate=!0}this.renderer._texturesToResize.clear(),this.NoPowerOfTwoEffect.dispose()},recompileAllShaders:function(e){this.renderer.recompileAllShaders(e)},updateClippingScene:function(e){var i,r=e.getBoundingSphere(),n=new t.Vector3;for(i=0;i<this.renderer.clipPlanes.length;i++){var a=this.renderer.clipPlanes[i];a.projectPoint(r.center,n);var s=this.clippingScene.children[i];s.matrixAutoUpdate=!1,s.matrixWorldNeedsUpdate=!1;var o=a.normal.clone().multiplyScalar(-1),l=(a.constant,new t.Vector3),c=new t.Vector3(1,0,0);Math.abs(o.y)<=.01&&Math.abs(o.z)<=.01&&(c=new t.Vector3(0,1,0)),l.crossVectors(o,c),l.normalize(),c.crossVectors(o,l),s.matrixWorld.set(1*l.x,1*c.x,1*o.x,n.x,1*l.y,1*c.y,1*o.y,n.y,1*l.z,1*c.z,1*o.z,n.z,0,0,0,1)}},setSectionCappingMaterial:function(e,i){this.resetGSSOCache();var r,n=this.renderer;e.clippingContext||(e.clippingContext={}),e.clippingContext[n.id]||(e.clippingContext[n.id]={useCount:0}),r=e.clippingContext[n.id],i||0===i?i instanceof t.Material?r.sectionCappingMaterial=i.clone():r.sectionCappingMaterial=new t.MeshBasicMaterial({color:new t.Color(i)}):(r.sectionCappingMaterial=t.MaterialUtils.createShinyFaceMaterial({color:new t.Color(0)}),r.sectionCappingMaterial.clipPlaneUseModelMaterial=!0),this.resetClippingScene()},requestClippingUpdate:function(){this.needClippingUpdate=!0},updateClippingGlobals:function(e,i,r,n,a){if(e._needClippingUpdate){var s=r.renderer,o=i.getAllWebGLObjects(s.currentFrameIndex);if(o){e._needClippingUpdate=!1;var l,c,h,u,d,p,f=null,m=0,g=!1,v=0,S=0,_=0;if(n.length>0)for(f=new Set,l=0;l<n.length;l++)f.add(n[l]);for(l=0;l<o.length;l++)if(o[l]&&(c=o[l].object._occurrence)){if(h=c.clippingContext){for(u=0;u<h.planes.length;u++)null===f&&(f=new Set),f.add(h.planes[u]);h._clipPolyLine&&(h._clipPolyLine.updateBoundingSphere(e.getBoundingSphere()),(p=h._clipPolyLine.getMaxSize())>m&&(m=p),h._clipPolyLine.getCount()>_&&(_=h._clipPolyLine.getCount())),h._getScissorPolyLineSize()>v&&(v=h._getScissorPolyLineSize()),h._getScissorNbPolygons()>S&&(S=h._getScissorNbPolygons()),h.cylinder&&(g=!0)}c.occurrenceRenderingOverride&&((d=c.occurrenceRenderingOverride.clipPolyLine)&&(d.updateBoundingSphere(e.getBoundingSphere()),(p=d.getMaxSize())>m&&(m=p),d.getCount()>_&&(_=d.getCount())),c.occurrenceRenderingOverride.clipCylinder&&(g=!0))}var y=!1;s.maxPolyLineSize===m&&s.useClippingCylinder===g&&s.maxScissorSize===v&&s.maxNbScissor===S&&s.maxNbPolyLine===_||(s.maxPolyLineSize=m,s.maxScissorSize=v,s.maxNbScissor=S,s.maxNbPolyLine=_,s.useClippingCylinder=g,y=!0);var x=s.clipPlanes,M=f?f.size:0,P=!1;if(M!==x.length)P=!0;else if(M>0)for(l=0;l<M&&!P;l++)f.has(x[l])||(P=!0);if(P){var C=s.clipPlanes,b=[];s.clipPlanes=b,f&&f.forEach(function(e){e.upVector||(e.upVector=new t.Vector3(0,0,1)),e.clippingContext||(e.clippingContext={}),e.clippingContext[s.id]||(e.clippingContext[s.id]={}),e.clippingContext[s.id].sectionCappingMaterial||r.setSectionCappingMaterial(e,null),e.clippingContext[s.id].clippingPlaneAdded=!0,b.push(e)}),0!==C.length&&0!==b.length||(y=!0),a&&(a.updateShadowMap=!0),r.resetClippingScene()}y&&s.recompileAllShaders(null)}}},updateSectionCappingScene:function(e,r){if(!this.clippingScene){this.clippingScene=new t.Scene,this.clippingScene.autoUpdateScene=!1,this.clippingScene.matrixWorldNeedsUpdate=!1,this.clippingScene.matrixAutoUpdate=!1;var n,a=e.getBoundingSphere(),s=new t.PlaneGeometry(50*a.radius,50*a.radius);for(i=0;i<this.renderer.clipPlanes.length;i++){var o=(n=this.renderer.clipPlanes[i].clippingContext[this.renderer.id]).sectionCappingMaterial;o&&((o=o.clone()).clipPlaneIndex=i+1);var l=new t.Mesh(s,o||t.MaterialUtils.createShinyFaceMaterial({color:"purple"}));l.clippingPlane=this.renderer.clipPlanes[i],n.clippingMeshIndex=i+1,this.clippingScene.add(l)}for(i=0;i<r.children.length;i++){var c=r.children[i];c instanceof t.Light&&this.clippingScene.add(c.clone())}}var h,u=this.mainComposer.getAllPasses();for(i=0;i<u.length;i++)(h=u[i]).renderCuttingElements&&h.setCuttingScene(this.clippingScene);this.updateClippingScene(e)},getQuarterWidth:function(){return Math.ceil(.25*this.viewportWidth)},getQuarterHeight:function(){return Math.ceil(.25*this.viewportHeight)}});return Object.defineProperty(J.prototype,"gpuPickingTolerance",{get:function(){return this.renderer._gpuPickingTolerance},set:function(e){this.renderer._gpuPickingTolerance=e,this.smallTargetPicking&&(this.pickingGPUComposerContext&&(this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.pickingGPUComposerContext.needsUpdate=!0),this.normalComposerContext&&(this.normalComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.normalComposerContext.needsUpdate=!0),this.depthComposerContext&&(this.depthComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.depthComposerContext.needsUpdate=!0))}}),Object.defineProperty(J.prototype,"smallTargetPicking",{get:function(){return this.renderer._smallTargetPicking},set:function(e){this.renderer._smallTargetPicking=e,e?(this.pickingGPUComposerContext&&this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.normalComposerContext&&this.normalComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.depthComposerContext&&this.depthComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)):(this.pickingGPUComposerContext&&this.pickingGPUComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.normalComposerContext&&this.normalComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.depthComposerContext&&this.depthComposerContext.setSize(this.viewportWidth,this.viewportHeight))}}),J.testMode=!1,J}),define("Visualization/WebGLV6Renderer",["DS/Visualization/WebGLV6Renderer","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/WebGLV6Renderer"),e}),define("DS/Manipulators/PointHandle",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/BillBoardNode3D","DS/Manipulators/HandlePointManipulator","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/SceneGraphNodes/FixedSizeNode3D","DS/Visualization/SceneGraphFactory"],function(e,t,i,r,n,a,s,o,l,c,h){"use strict";var u=t.extend({init:function(t){this._parent(t.name),this.sceneGraph=t.sceneGraph,this.size=t.size?t.size:20,this.fillColor=t.fillColor?t.fillColor:new e.Color("#FFFFFF"),this.opacity=t.opacity?t.opacity:1,this._modelEvent=new l,this.isPreactivated=!1,this.isManipulated=!1,this.handleCursor=!0;var s=void 0===t.noz||t.noz,o=this,u={width:1,height:1,fill:!0,fillColor:null,noEdge:!0,layerNb:s?1:0},d=(new r).createRectangle(u),p=i.getWebappsAssetUrl("Robot",""),f=new e.ImageUtils._loadTextureWithProxy(p+"models/textures/Point.png",void 0,null,null,e.ImageUtils.crossOriginPolicy);f.flipY=!1,f.minFilter=e.LinearMipMapLinearFilter,this.pointMat=new e.MeshBasicMaterial({map:f,side:e.DoubleSide,transparent:!0,alphaTest:.05,enableClipPlanes:!1,opacity:this.opacity}),this.pointMat.force=!0;var m=h.createMeshNode(d,this.pointMat);m.setShadow(!1),m.setFrustumCulled(!1),m.name="diskNode",m.excludeFromCSO(!0),m.excludeFromHighlight(!0,!0),m.setMatrix((new e.Matrix4).setPosition(new e.Vector3(-.5,-.5,0))),this.diskNode=m;var g={position:this.position,name:"billBoard1",type:"Spherical"};this.billBoardNode=new n(g),this.billBoardNode.add(m),this.fixedSizeNode=new c({name:"fixedSizeNode3D",ratio:this.size}),this.fixedSizeNode.add(this.billBoardNode),this.add(this.fixedSizeNode),this.sceneGraph.add(this),this.manipulator=new a,this.manipulator.setExclusive(!0),this.manipToken=this.manipulator.linkToNode(this),this.manipulator.onBeginManipulate(function(t){o._modelEvent.publish({event:"BeginManipulate",data:t,context:this}),o.pointMat.color=new e.Color("#1B6E9C"),o.handleCursor&&t.viewer.setCursor("-webkit-grabbing"),o.isManipulated=!0,o.fixedSizeNode.setRatio(1.2*o.size),t.viewer.render()}),this.manipulator.onManipulate(function(e){o._modelEvent.publish({event:"Manipulate",data:e,context:this}),o.handleCursor&&e.viewer.setCursor("-webkit-grabbing")}),this.manipulator.onEndManipulate(function(t){o._modelEvent.publish({event:"EndManipulate",data:t,context:this}),o.isPreactivated?(o.handleCursor&&t.viewer.setCursor("pointer"),o.pointMat.color=new e.Color("#A1D9ED")):(o.handleCursor&&t.viewer.setCursor("auto"),o.pointMat.color=o.fillColor,o.fixedSizeNode.setRatio(o.size)),o.isManipulated=!1,t.viewer.render()}),this.manipulator.onBeginPreactivate(function(t){o._modelEvent.publish({event:"BeginPreactivate",data:t,context:this}),o.handleCursor&&t.viewer.setCursor("pointer"),o.isPreactivated=!0,o.isManipulated||(o.pointMat.color=new e.Color("#A1D9ED")),o.fixedSizeNode.setRatio(1.2*o.size),t.viewer.render()}),this.manipulator.onPreactivate(function(e){o._modelEvent.publish({event:"Preactivate",data:e,context:this})}),this.manipulator.onEndPreactivate(function(e){o._modelEvent.publish({event:"EndPreactivate",data:e,context:this}),o.handleCursor&&e.viewer.setCursor("auto"),o.isPreactivated=!1,o.isManipulated||(o.pointMat.color=o.fillColor,o.fixedSizeNode.setRatio(o.size)),e.viewer.render()})},setCursor:function(e){this.handleCursor=e,this.manipulator.noCursorChange=!e},setSize:function(e){this.size=e,this.fixedSizeNode.setRatio(this.size)},setFillColor:function(e){this.fillColor=e,this.pointMat.color=this.fillColor},setOpacity:function(e){this.opacity=e,this.pointMat.opacity=this.opacity},subscribe:function(e,t){return this._modelEvent.subscribe({event:e},t)},unsubscribe:function(e){this._modelEvent.unsubscribe(e)},dispose:function(){this.manipulator&&(this.manipulator.unlink(this.manipToken),this.manipulator=null),this.sceneGraph.remove(this)}});return UWA.namespace("THREEDS/Nodes/PointHandle",u)}),define("Manipulators/PointHandle",["DS/Manipulators/PointHandle","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Manipulators/PointHandle"),e}),define("DS/SceneGraphNodes/RefPlaneNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory","DS/Visualization/TextNode","DS/Visualization/MaterialApplication"],function(e,t,i,r,n,a,s,o,l,c){"use strict";var h=new e.MeshBasicMaterial({force:!1}),u=new e.Matrix4,d=new e.Vector3(0,0,1),p=new e.Vector3,f=new e.Vector3,m=new e.Vector3,g=new e.Vector3,v=new e.Vector3,S=new e.Vector3,_=new e.Vector3,y=new e.Vector3,x=new e.Vector3,M=new e.Vector3,P=new e.Vector3,C=new Map,b=new Map,D=new Map,w=e.__visibleInCurrentSpace,E=function(){this._backBorderMaterial=null,this._frontPlaneMaterial=null,this._backPlaneMaterial=null,this._xIndicatorMaterial=null,this._margin=null,this._frontText=null,this._backText=null,this._frontPlane=null,this._frontPlaneGAS=null,this._frontPlaneMatApp=null,this._backPlane=null,this._backPlaneGAS=null,this._backPlaneMatApp=null,this._backBorder=null,this._backBorderGAS=null,this._backBorderMatApp=null,this._frontTextNode=null,this._backTextNode=null,this._fixedSizeFrontText=null,this._fixedSizeBackText=null,this._xArrowIndicator=null,this._xArrowIndicatorGAS=null,this._xIndicatorMatApp=null},T=t.extend({init:function(i){this._parent(i.name),this._isDynamic=!0,this.matInherit=window.newMaterialInheritance,this.fixedSize=i.fixedSize;var r=this;return this.cbChange=function(e){if(this._newLook){for(var t={},i=0;i<r._occurrences.length;i++){var n=r._occurrences[i],a=n.parent;if(n.scene3js&&a){var s=n.scene3js.viewer;if(w(n._getVisible(),n._getVisibilityFree(),s.getVisibleSpace(),null,n)){if(e&&e.viewpoint&&e.viewpoint.viewer&&s!==e.viewpoint.viewer)continue;if(t[s.id]||(t[s.id]={viewer:s,count:0}),t[s.id].count++,s._refPlaneCounter>100){r.setNewLook(!1);continue}var o=s.currentViewpoint;r._updateNode(n,i,e,o)}}}r._updateViewersCount(t)}},this.tokenChange=null,this._length=new e.Vector2(10,10),this._frontBorderMaterial=this._getBorderMaterial({color:new e.Color("green"),opacity:.7,lineWidth:2,force:!this.matInherit}),this._frontBorder=this._buildEditableRectangle(!0,this._frontBorderMaterial.color,this._frontBorderMaterial.opacity),this._frontBorderGAS=this._frontBorder._occurrences[0].renderable.geometry[0].drawingGroups[0].gas,this.matInherit?(this._frontBorderMatApp=new c({lineMaterial:this._frontBorderMaterial,layer:0}),this._frontBorder.setMaterialApplication(this._frontBorderMatApp),this._frontBorder.setMaterialMode(!0)):this._frontBorder.setMaterial(this._frontBorderMaterial),this._frontBorder.setShadow(!1),this._frontBorder.setSSAO(!1),this._frontBorder.setFrustumCulled(!1),this._frontBorder.setPickParent(!0),this._frontBorder.setPickingPriorityId({edges:"RefPlaneEdges"}),this._mainNode=new t("RefPlaneNode"),this._mainNode.setPickParent(!0),this._advanced=null,this._newLook=void 0===i.newLook||i.newLook,this._setNewLook(this._newLook),this._currentParams=null,this.setParameters(i),this._mainNode.addChild(this._frontBorder),this.fixedSize&&(this._frontBorder._setRatio(1),this._newLook&&(this._advanced._frontPlane._setRatio(1),this._advanced._backPlane._setRatio(1),this._advanced._backBorder._setRatio(1))),this.addChild(this._mainNode),this},_createTextNodes:function(e){e._frontTextNode=new t,e._backTextNode=new t,e._fixedSizeFrontText=new r({name:"fixedSizeNodeFrontText",ratio:1}),e._fixedSizeFrontText._autoUpdate=!1,e._fixedSizeBackText=new r({name:"fixedSizeNodeBackText",ratio:1}),e._fixedSizeBackText._autoUpdate=!1,e._fixedSizeFrontText.setPickable(a.NOPICKABLE),e._fixedSizeBackText.setPickable(a.NOPICKABLE),this.fixedSize?(e._subNode=new r({name:"FixedSizeForText",ratio:1}),e._subNode.addChild(e._frontTextNode),e._frontTextNode.addChild(e._fixedSizeFrontText),e._subNode.addChild(e._backTextNode),e._backTextNode.addChild(e._fixedSizeBackText),this._mainNode.addChild(e._subNode)):(this._mainNode.addChild(e._frontTextNode),this._mainNode.addChild(e._backTextNode),e._frontTextNode.addChild(e._fixedSizeFrontText),e._backTextNode.addChild(e._fixedSizeBackText))},_removeTextNodes:function(e){this.fixedSize?(e._subNode.removeChild(e._frontTextNode),e._frontTextNode.removeChild(e._fixedSizeFrontText),e._subNode.removeChild(e._backTextNode),e._backTextNode.removeChild(e._fixedSizeBackText),this._mainNode.removeChild(e._subNode)):(this._mainNode.removeChild(e._frontTextNode),this._mainNode.removeChild(e._backTextNode),e._frontTextNode.removeChild(e._fixedSizeFrontText),e._backTextNode.removeChild(e._fixedSizeBackText)),e._subNode=null,e._frontTextNode=null,e._backTextNode=null,e._fixedSizeFrontText=null,e._fixedSizeBackText=null},_initAdvancedNodes:function(t){this._mainNode.addChild(t._frontPlane),this._mainNode.addChild(t._backPlane),this._mainNode.addChild(t._backBorder),this._mainNode.addChild(t._xArrowIndicator),t._xArrowIndicator.setRatio(20),this.fixedSize?t._xArrowIndicator.setFixedSizeCenter(new e.Vector3(.5*this._length.x,0,0)):t._xArrowIndicator.setMatrix((new e.Matrix4).makeTranslation(.5*this._length.x,0,0))},_initAdvancedParameters:function(t){t._frontPlaneMaterial=this._getPlaneMaterial({color:new e.Color("green"),opacity:.2,side:0,force:!this.matInherit});var i=t._frontPlaneMaterial.color.getHSL();n=i.h+20/255,a=Math.min(1,1.3*i.l),t._backPlaneMaterial=this._getPlaneMaterial({color:(new e.Color).setHSL(n,i.s,a),opacity:.2,side:1,force:!this.matInherit});var r=this._frontBorderMaterial.color.getHSL(),n=r.h+20/255,a=Math.min(1,1.3*r.l);t._backBorderMaterial=this._getBorderMaterial({color:(new e.Color).setHSL(n,r.s,a),opacity:.7,lineWidth:2,force:!this.matInherit}),t._xIndicatorMaterial=this._getXIndicatorMaterial({color:new e.Color("green"),force:!this.matInherit}),t._margin=.02,t._frontText={data:"",color:new e.Color("green"),opacity:.7,size:.5,token:null},t._backText={data:"",color:new e.Color("green"),opacity:.7,size:.5,token:null},t._frontPlane=this._buildEditableRectangle(!1,t._frontPlaneMaterial.color,t._frontPlaneMaterial.opacity),t._frontPlaneGAS=t._frontPlane._occurrences[0].renderable.geometry[0].drawingGroups[0].gas,this.matInherit?(t._frontPlaneMatApp=new c({faceMaterial:t._frontPlaneMaterial,layer:0}),t._frontPlane.setMaterialApplication(t._frontPlaneMatApp),t._frontPlane.setMaterialMode(!0)):t._frontPlane.setMaterial(t._frontPlaneMaterial),t._frontPlane.setShadow(!1),t._frontPlane.setSSAO(!1),t._frontPlane.setFrustumCulled(!1),t._frontPlane.setPickParent(!0),t._frontPlane.excludeFromHighlight(!0,!0),t._backPlane=this._buildEditableRectangle(!1,t._backPlaneMaterial.color,t._backPlaneMaterial.opacity),t._backPlaneGAS=t._backPlane._occurrences[0].renderable.geometry[0].drawingGroups[0].gas,this.matInherit?(t._backPlaneMatApp=new c({faceMaterial:t._backPlaneMaterial,layer:0}),t._backPlane.setMaterialApplication(t._backPlaneMatApp),t._backPlane.setMaterialMode(!0)):t._backPlane.setMaterial(t._backPlaneMaterial),t._backPlane.setShadow(!1),t._backPlane.setSSAO(!1),t._backPlane.setFrustumCulled(!1),t._backPlane.setPickParent(!0),t._backPlane.excludeFromHighlight(!0,!0),t._backBorder=this._buildEditableRectangle(!0,t._backBorderMaterial.color,t._backBorderMaterial.opacity),t._backBorderGAS=t._backBorder._occurrences[0].renderable.geometry[0].drawingGroups[0].gas,this.matInherit?(t._backBorderMatApp=new c({lineMaterial:t._backBorderMaterial,layer:0}),t._backBorder.setMaterialApplication(t._backBorderMatApp),t._backBorder.setMaterialMode(!0)):t._backBorder.setMaterial(t._backBorderMaterial),t._backBorder.setShadow(!1),t._backBorder.setSSAO(!1),t._backBorder.setFrustumCulled(!1),t._backBorder.setPickParent(!0),t._backBorder.setPickingPriorityId({edges:"RefPlaneEdges"}),t._xArrowIndicator=this._buildXIndicator(t._xIndicatorMaterial.color,t._xIndicatorMaterial.opacity),t._xArrowIndicator.setShadow(!1),t._xArrowIndicator.setSSAO(!1),t._xArrowIndicatorGAS=t._xArrowIndicator._occurrences[0].renderable.geometry[0].drawingGroups[0].gas,t._displayArrowOrientation=!0,this.matInherit?(t._xIndicatorMatApp=new c({faceMaterial:t._xIndicatorMaterial,layer:0}),t._xArrowIndicator.setMaterialApplication(t._xIndicatorMatApp),t._xArrowIndicator.setMaterialMode(!0)):t._xArrowIndicator.setMaterial(t._xIndicatorMaterial),t._xArrowIndicator.excludeFromHighlight(!0,!0)},_setNewLook:function(e){var t=this._advanced;e&&!t&&(t=new E,this._advanced=t,this._initAdvancedParameters(t),this._initAdvancedNodes(t)),this._resetOccurrenceVisibility(this._frontBorder),this._frontBorder.setVisibility(!0),t&&(this._resetOccurrenceVisibility(t._backBorder),t._frontTextNode&&this._resetOccurrenceVisibility(t._frontTextNode),t._backTextNode&&this._resetOccurrenceVisibility(t._backTextNode),this._resetOccurrenceVisibility(t._xArrowIndicator),t._frontPlane.setVisibility(e),t._backPlane.setVisibility(e),t._backBorder.setVisibility(e)),this.fixedSize?this._subNode&&this._subNode.setVisibility(e):t&&(t._frontTextNode&&t._frontTextNode.setVisibility(e),t._backTextNode&&t._backTextNode.setVisibility(e),t._xArrowIndicator.setVisibility(e)),e&&this._currentParams&&(this.setParameters(this._currentParams),this._currentParams=null)},setNewLook:function(e){this._newLook!==e&&(this._newLook=e,this._setNewLook(e))},getNewLook:function(){return this._newLook},_getBorderMaterial:function(t){var i=t.color.getHexString()+"-"+t.opacity+"-"+t.lineWidth+"-"+t.force;if(C.has(i))return C.get(i);var r=new e.LineBasicMaterial({color:t.color,opacity:t.opacity,lineWidth:t.lineWidth,side:2,polite:!0,force:t.force,forceSide:!0,enableClipPlanes:!1});return r.line=r,C.set(i,r),r},_getPlaneMaterial:function(t){var i=t.color.getHexString()+"-"+t.opacity+"-"+t.side+"-"+t.force;if(b.has(i))return b.get(i);var r=new e.MeshBasicMaterial({color:t.color,opacity:t.opacity,side:t.side,polygonOffset:!0,polygonOffsetFactor:.5,force:t.force,forceSide:!0,enableClipPlanes:!1});return b.set(i,r),r},_getXIndicatorMaterial:function(t){var i=t.color.getHexString()+"-"+t.force;if(D.has(i))return D.get(i);var r=new e.MeshBasicMaterial({color:t.color,opacity:.5,side:2,force:t.force,forceSide:!0,depthTest:!1,enableClipPlanes:!1});return D.set(i,r),r},_updateTextPosition:function(e,t,i,r){var n=void 0===t,a=!n&&t,s=0;if(e){var o=e.camera,l=this._subNode?this._subNode._occurrences[r].matrix:this._occurrences[r].matrix;l.extractBasis(p,f,m),p.multiplyScalar(.5*this._length.x),f.multiplyScalar(.5*this._length.y),g.getPositionFromMatrix(l),v.addVectors(p,f),v.negate(),v.addVectors(v,g),S.subVectors(p,f),S.addVectors(S,g),_.addVectors(p,f),_.addVectors(_,g),y.subVectors(f,p),y.addVectors(y,g);var c=e.project(v,o),h=e.project(S,o),x=e.project(_,o),M=e.project(y,o),P=0,C=h.x-c.x;C>0&&(s=0,P=C),(C=x.x-h.x)>0&&C>P&&(P=C,s=1),(C=M.x-x.x)>0&&C>P&&(P=C,s=2),(C=c.x-M.x)>0&&C>P&&(P=C,s=3)}var b=s%2?this._length.y:this._length.x,D=s%2?this._length.x:this._length.y;if(n||a){u.makeRotationAxis(d,.5*Math.PI*s),u.translate(g.set(-(.5-this._advanced._margin)*b,-(.5-this._advanced._margin)*D,0));var w=this._advanced._frontTextNode._occurrences[r];w._relativeMatrix?w._relativeMatrix.copy(u):w._relativeMatrix=u.clone()}if(n||!a){u.makeRotationAxis(d,Math.PI+.5*Math.PI*s),u.rotateY(Math.PI),u.translate(g.set(-(.5-this._advanced._margin)*b,-(.5-this._advanced._margin)*D,0));var E=this._advanced._backTextNode._occurrences[r];E._relativeMatrix?E._relativeMatrix.copy(u):E._relativeMatrix=u.clone()}},_setParametersOld:function(e){e.size&&(this._length.copy(e.size),this._updateRectangleSize(this._frontBorder));var t=e.borderAttributes;if(t&&t.front){var i=void 0!==t.front.color?t.front.color:this._frontBorderMaterial.color,r=void 0!==t.front.opacity?t.front.opacity:this._frontBorderMaterial.opacity,n=void 0!==t.front.width?t.front.width:this._frontBorderMaterial.lineWidth;this._frontBorderMaterial=this._getBorderMaterial({color:i,opacity:r,lineWidth:n,force:!this.matInherit}),this.matInherit?(this._frontBorderMatApp.setParameters({lineMaterial:this._frontBorderMaterial}),this._frontBorderGAS._color.copy(i),this._frontBorderGAS._alpha=r):this._frontBorder.setMaterial(this._frontBorderMaterial)}},setParameters:function(t){if(this._currentParams=t,this._newLook){var i=this._advanced;t.size&&(this._length.copy(t.size),this._updateRectangleSize(i._frontPlane),this._updateRectangleSize(i._backPlane),this._updateRectangleSize(this._frontBorder),this._updateRectangleSize(i._backBorder),this.fixedSize?i._xArrowIndicator.setFixedSizeCenter(new e.Vector3(.5*this._length.x,0,0)):i._xArrowIndicator.setMatrix((new e.Matrix4).makeTranslation(.5*this._length.x,0,0)));var r=t.planeAttributes;if(r){if(r.front){var n=void 0!==r.front.color?r.front.color:i._frontPlaneMaterial.color,a=void 0!==r.front.opacity?r.front.opacity:i._frontPlaneMaterial.opacity;if(i._frontPlaneMaterial=this._getPlaneMaterial({color:n,opacity:a,side:0,force:!this.matInherit}),i._xIndicatorMaterial=this._getXIndicatorMaterial({color:n,force:!this.matInherit}),this.matInherit?(i._frontPlaneMatApp.setParameters({faceMaterial:i._frontPlaneMaterial}),i._xIndicatorMatApp.setParameters({faceMaterial:i._xIndicatorMaterial}),i._frontPlaneGAS._color.copy(n),i._xArrowIndicatorGAS._color.copy(n),i._frontPlaneGAS._alpha=a):(i._frontPlane.setMaterial(i._frontPlaneMaterial),i._xArrowIndicator.setMaterial(i._xIndicatorMaterial)),!r.back||!r.back.color){var s=n.getHSL(),l=s.h+20/255,c=Math.min(1,1.3*s.l),h=(new e.Color).setHSL(l,s.s,c);i._backPlaneMaterial=this._getPlaneMaterial({color:h,opacity:i._backPlaneMaterial.opacity,side:1,force:!this.matInherit}),this.matInherit?(i._backPlaneMatApp.setParameters({faceMaterial:i._backPlaneMaterial}),i._backPlaneGAS._color.copy(h)):i._backPlane.setMaterial(i._backPlaneMaterial)}}if(r.back){n=void 0!==r.back.color?r.back.color:i._backPlaneMaterial.color,a=void 0!==r.back.opacity?r.back.opacity:i._backPlaneMaterial.opacity;i._backPlaneMaterial=this._getPlaneMaterial({color:n,opacity:a,side:1,force:!this.matInherit}),this.matInherit?(i._backPlaneMatApp.setParameters({faceMaterial:i._backPlaneMaterial}),i._backPlaneGAS._color.copy(n),i._backPlaneGAS._alpha=a):i._backPlane.setMaterial(i._backPlaneMaterial)}}var u=t.borderAttributes;if(u){if(u.front){n=void 0!==u.front.color?u.front.color:this._frontBorderMaterial.color,a=void 0!==u.front.opacity?u.front.opacity:this._frontBorderMaterial.opacity;var d=void 0!==u.front.width?u.front.width:this._frontBorderMaterial.lineWidth;if(this._frontBorderMaterial=this._getBorderMaterial({color:n,opacity:a,lineWidth:d,force:!this.matInherit}),this.matInherit?(this._frontBorderMatApp.setParameters({lineMaterial:this._frontBorderMaterial}),this._frontBorderGAS._color.copy(n),this._frontBorderGAS._alpha=a):this._frontBorder.setMaterial(this._frontBorderMaterial),!u.back||!u.back.color){var p=n.getHSL();l=p.h+20/255,c=Math.min(1,1.3*p.l),h=(new e.Color).setHSL(l,p.s,c);i._backBorderMaterial=this._getBorderMaterial({color:h,opacity:i._backBorderMaterial.opacity,lineWidth:i._backBorderMaterial.lineWidth,force:!this.matInherit}),this.matInherit?(i._backBorderMatApp.setParameters({lineMaterial:i._backBorderMaterial}),i._backBorderGAS._color.copy(h)):i._backBorder.setMaterial(i._backBorderMaterial)}}if(u.back){n=void 0!==u.back.color?u.back.color:i._backBorderMaterial.color,a=void 0!==u.back.opacity?u.back.opacity:i._backBorderMaterial.opacity,d=void 0!==u.back.width?u.back.width:i._backBorderMaterial.lineWidth;i._backBorderMaterial=this._getBorderMaterial({color:n,opacity:a,lineWidth:d,force:!this.matInherit}),this.matInherit?(i._backBorderMatApp.setParameters({lineMaterial:i._backBorderMaterial}),i._backBorderGAS._color.copy(n),i._backBorderGAS._alpha=a):i._backBorder.setMaterial(i._backBorderMaterial)}}var f=""!==i._frontText.data||""!==i._backText.data,m=t.textAttributes;if(m){m.front&&(m.front.data&&(i._frontText.data=m.front.data),m.front.size&&(i._frontText.size=m.front.size),m.front.opacity&&(i._frontText.opacity=m.front.opacity),m.front.color&&i._frontText.color.copy(m.front.color)),m.back&&(m.back.data&&(i._backText.data=m.back.data),m.back.size&&(i._backText.size=m.back.size),m.back.opacity&&(i._backText.opacity=m.back.opacity),m.back.color&&i._backText.color.copy(m.back.color)),f&&(i._frontText&&i._frontText.token&&i._fixedSizeFrontText.removeChild(i._frontText.token),i._backText&&i._backText.token&&i._fixedSizeBackText.removeChild(i._backText.token));var g=""!==i._frontText.data||""!==i._backText.data;!f&&g&&this._createTextNodes(i),f&&!g&&this._removeTextNodes(i),""!==i._frontText.data&&(i._frontText.token=o.createTextNode({name:"_refplaneitem_",text:i._frontText.data,font:"Trebuchet MS",fontSize:i._frontText.size,color:i._frontText.color,depthWrite:!1}),i._frontText.token.children[0].excludeFromHighlight(!0,!0),i._fixedSizeFrontText.addChild(i._frontText.token)),""!==i._backText.data&&(i._backText.token=o.createTextNode({name:"_refplaneitem_",text:i._backText.data,font:"Trebuchet MS",fontSize:i._backText.size,color:i._backText.color,depthWrite:!1}),i._backText.token.children[0].excludeFromHighlight(!0,!0),i._fixedSizeBackText.addChild(i._backText.token))}void 0!==t.orientationArrow&&i._displayArrowOrientation!==t.orientationArrow&&(t.orientationArrow?this._mainNode.addChild(i._xArrowIndicator):this._mainNode.removeChild(i._xArrowIndicator),i._displayArrowOrientation=t.orientationArrow)}else this._setParametersOld(t)},_updateViewersCount:function(e){for(var t in e){var i=e[t],r=i.viewer._refPlaneMap.get(this.id);void 0===r&&(r=0),i.viewer._refPlaneMap.set(this.id,i.count),i.viewer._refPlaneCounter+=i.count-r}},_updateCount:function(e){for(var t={},i=0;i<this._occurrences.length;i++){var r=this._occurrences[i],n=r.parent;if(r.scene3js&&n){var a=r.scene3js.viewer;a&&(t[a.id]||(t[a.id]={viewer:a,count:0}),e?t[a.id].count=0:t[a.id].count++)}}this._updateViewersCount(t)},_onLinkedToSceneGraph:function(){var e=this;this.tokenChange=i.subscribe({event:"/VISU/"},function(t){"@onViewpointChange"===t.eventType&&e.cbChange(t)}),this.cbChange()},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenChange),this._updateCount(!0)},_getDynamicMatrix:function(){return null},_resetOccurrenceVisibility:function(e){for(var t=0;t<e._occurrences.length;t++){var i=e._occurrences[t];i._relativeVisibility=null,i.parent&&this._updateOccurrences(i.parent,i,!0,!0,!0)}},_setOccurrenceVisibility:function(e,t,i,r){var n=t?1:0;if(i||e._relativeVisibility!==n){e._relativeVisibility=n;var a=r||e;this._updateOccurrences(a.parent,a,!0,!0,!0)}},_updateNode:function(e,t,i,r){var n=this._advanced,a=r||i.viewpoint,s=a.getEyePosition(),o=e.matrix.elements;x.set(o[12],o[13],o[14]),M.subVectors(s,x),M.normalize(),P.set(o[8],o[9],o[10]);var l=M.dot(P)>0,c=""!==n._frontText.data||""!==n._backText.data;c&&this._updateTextPosition(a,l,e,t),this._setOccurrenceVisibility(this._frontBorder._occurrences[t],l),this._setOccurrenceVisibility(n._backBorder._occurrences[t],!l);var h=!1;if(c){var u=l?n._fixedSizeFrontText:n._fixedSizeBackText,d=l?n._backText.token:n._frontText.token,p=l?n._frontText.token:n._backText.token,f=l?n._backTextNode:n._frontTextNode,m=l?n._frontTextNode:n._backTextNode,g=(d._occurrences[t],p._occurrences[t]),v=f._occurrences[t],S=m._occurrences[t];this._setOccurrenceVisibility(v,!1,!1,v),u.cbChange();var _=!1;if(u._bsShow||u.getBoundingSphere(),this.fixedSize)_=1.414*(u._bsShow?u._bsShow.radius*u.getRatio():0)<=(n._frontPlane.explicitBSphere?n._frontPlane.explicitBSphere.pixelRadius:0);else _=!u._bsShow||2*u._bsShow.radius*u.getScaleFactor(t)<.9*Math.min(this._length.x,this._length.y);S._relativeVisibility=1,this._setOccurrenceVisibility(g,_,!0,S),h=h||_}if(n._displayArrowOrientation){var y=1;this.fixedSize||(y=a.camera.getWorldSizeFromPixelSize(1,x,a.viewer._getDivClientHeight()));var C=20*y<.3*Math.min(this._length.x,this._length.y);this._setOccurrenceVisibility(n._xArrowIndicator._occurrences[t],C)}this._subNode&&this._subNode.setVisibility(h)},_buildXIndicator:function(){var e=new a.PrimitiveGroup;e.fillAttr=new a.FillAttributes;var t=new a.Buffer({component:a.VertexComponentEnum.POSITION,data:new Float32Array(9)}),i=new a.Buffer({component:a.VertexComponentEnum.NORMAL,data:new Float32Array(9)});e.addBuffer(0,t),e.addBuffer(1,i);var r=t.data,n=0;r[n++]=-1,r[n++]=-.3,r[n++]=0,r[n++]=-.25,r[n++]=0,r[n++]=0,r[n++]=-1,r[n++]=.3,r[n++]=0,r=i.data,n=0;for(var s=0;s<3;s++)r[n++]=0,r[n++]=0,r[n++]=1;var l=new a.Primitive({nbIndices:3,connectivity:a.ConnectivityTypeEnum.TRIANGLES,fillGAS:new a.FillAttributes}),c=new a.VertexComponent({nbVertices:3,bufferId:0}),u=new a.VertexComponent({nbVertices:3,bufferId:1});l.addVertexComponent(c),l.addVertexComponent(u),e.addPrimitive(l);var d=o.createMeshNode(e,h);return d.name="_refplaneitem_",d},_buildEditableRectangle:function(e,t,i){var r=new a.PrimitiveGroup;r.editable=!0,r.fillAttr=new a.FillAttributes,r.lineAttr=new a.LineAttributes,r.pointAttr=new a.PointAttributes;var n=new a.Buffer({component:a.VertexComponentEnum.POSITION,data:new Float32Array(12)}),s=new a.Buffer({component:a.VertexComponentEnum.NORMAL,data:new Float32Array(12)}),l=new a.Buffer({indexBuffer:!0,data:new Uint16Array(e?8:6)});r.addBuffer(0,n),r.addBuffer(1,s),r.addBuffer(2,l);var c=l.data,u=0;e?(c[0]=0,c[1]=1,c[2]=1,c[3]=2,c[4]=2,c[5]=3,c[6]=3,c[7]=0):(c[u++]=0,c[u++]=1,c[u++]=2,c[u++]=0,c[u++]=2,c[u++]=3),u=0,(c=n.data)[u++]=.5*this._length.x,c[u++]=-.5*this._length.y,c[u++]=0,c[u++]=.5*this._length.x,c[u++]=.5*this._length.y,c[u++]=0,c[u++]=-.5*this._length.x,c[u++]=.5*this._length.y,c[u++]=0,c[u++]=-.5*this._length.x,c[u++]=-.5*this._length.y,c[u++]=0,c=s.data,u=0;for(var d=0;d<4;d++)c[u++]=0,c[u++]=0,c[u++]=1;var p=new a.Primitive({nbIndices:e?8:6,connectivity:e?a.ConnectivityTypeEnum.LINES:a.ConnectivityTypeEnum.TRIANGLES,fillGAS:new a.FillAttributes(new a.Color(t.r,t.g,t.b,i)),lineGAS:new a.LineAttributes(new a.Color(t.r,t.g,t.b,i))}),f=new a.VertexComponent({nbVertices:4,bufferId:0,indices:new a.IndexArray({bufferId:2,offset:0})}),m=new a.VertexComponent({nbVertices:4,bufferId:1,indices:new a.IndexArray({bufferId:2,offset:0})});p.addVertexComponent(f),p.addVertexComponent(m),r.addPrimitive(p);var g=o.createMeshNode(r,h);return g.name="_refplaneitem_",g},_updateRectangleSize:function(t){var i=t.getBuffer(a.VertexComponentEnum.POSITION);i[0]=.5*this._length.x,i[1]=-.5*this._length.y,i[3]=.5*this._length.x,i[4]=.5*this._length.y,i[6]=-.5*this._length.x,i[7]=.5*this._length.y,i[9]=-.5*this._length.x,i[10]=-.5*this._length.y,t.updateBuffer(a.VertexComponentEnum.POSITION,0,4);var r=Math.sqrt(.25*this._length.x*this._length.x+.25*this._length.x*this._length.x),n=new e.Sphere(new e.Vector3(0,0,0),r),s=new e.Box3(new e.Vector3(-.5*this._length.x,-.5*this._length.y,0),new e.Vector3(.5*this._length.x,.5*this._length.y,0));t.forceBoundingElements(!0,{sphere:n,box:s})}});return UWA.namespace("THREEDS/Nodes/RefPlaneNode",T)}),define("DS/Visualization/SpriteNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],function(e,t,i){"use strict";var r=t.extend({init:function(t,i){this._parent(i),this.anchor=t;var r=this;return this.cbInit=function(t){var i=(new e.Matrix4).lookAt(t.cameraEye,t.cameraTarget,t.cameraUp);i.setPosition(r.anchor),r.setMatrix(i)},this.cbChange=function(t){if("@onViewpointChange"===t.eventType){var i=(new e.Matrix4).lookAt(t.cameraEye,t.cameraTarget,t.cameraUp);i.setPosition(r.anchor),r.setMatrix(i)}},this},_onLinkedToSceneGraph:function(){this.tokenInit=i.subscribe({event:"/VISU/SpriteNodeInit"},this.cbInit),this.tokenChange=i.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenInit),i.unsubscribe(this.tokenChange)},getNodeType:function(){return"SpriteNode3D"}});return UWA.namespace("THREEDS/Nodes/Sprite",r)}),define("Visualization/SpriteNode3D",["DS/Visualization/SpriteNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SpriteNode3D"),e}),define("DS/SceneGraphNodes/VoxelVolumeNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";return t.extend({init:function(e,t){return this._parent(t),this.debugMode=!0,e&&this.build(e),this},add:function(){return!1},_nextPowerOf2:function(e,t){for(var i=t||1;i<e;)i*=2;return i},build:function(t){var i,r,n=t.voxelRep,a=(performance.now(),[n.width,n.height,n.depth]),s=new e.Vector3(a[0],a[1],a[2]),o=Math.max(s.x,Math.max(s.y,s.z)),l=this._nextPowerOf2(o,4),c=this._nextPowerOf2(Math.ceil(Math.sqrt(l))),h=l*c,u=null,d=n.bufferData,p=a[0]*a[1]*a[2],f=p%8?Math.floor(p/8)+1:p/8,m=f+(4-f%4)%4;i=(r=new Uint8Array(d.buffer,d.byteOffset+m))[0];var g=0,v=null;if(this.debugMode){v=new Uint32Array(256);for(var S=0;S<256;S++)v[S]=0}u=new Uint8Array(h*h);for(var S=0;S<h*h;S++)u[S]=i;var _=0,y=0,x=0,M=0,P=0,C=[1,2,4,8,16,32,64,128],b=i>0?i:Number.MAX_SAFE_INTEGER,D=i>0?i:0;for(S=0;S<f/4;S++)for(var w=3;w>=0;w--)for(var E=d[4*S+w],T=7;T>=0;T--){if(E&C[T]){var A=r[1+P++],I=(Math.floor(x/c)*l+y)*l*c+x%c*l+_;u[I]=A,A>0&&(A<b&&(b=A),A>D&&(D=A)),this.debugMode&&(v[A]++,g++)}if(++M>=p)break;++_>=a[0]&&(_=0,++y>=a[1]&&(y=0,x++))}this.debugMode&&(v[i]+=a[0]*a[1]*a[2]-g),this.volumeData={tileSetRange:{min:0,max:1},valueRange:{min:b/255,max:D/255},voxelRepartition:v,mapData:{type:"uint8",data:u,width:h,height:h},chunkSize:l,nbCol:c,mapDim:s,_voxelDensity:0}},getNodeType:function(){return"VoxelVolumeNode"}})}),define("DS/Visualization/LoaderUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/CGRNode","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Mesh/Mesh","DS/SceneGraphNodes/AxisSystemNode","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/FixedSizePlaneNode","DS/Visualization/SceneGraphFactory","DS/Visualization/KDTree","DS/Visualization/FontUtils","DS/SceneGraphNodes/CurvedPipeBatchDummyNode","DS/SceneGraphNodes/RefPlaneNode","DS/SceneGraphNodes/VoxelVolumeNode","DS/SceneGraphNodes/FixedSizeArrowNode"],function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g){"use strict";var v=null,S=function(t,i){var r=i.materialLibrary,a=i.baseUrl,s=new n,o=r[t];if(void 0===o)return null;var l=r[o.instance];if(void 0===l)return null;var c=r[l.instance];return void 0===c?null:(void 0===c.material&&void 0!==c.params?(c.material=s.getMaterial3DXML(c.params,a,"XMLV43"),c.material.force=!0):void 0===c.params&&(c.material=e.MaterialUtils.createMatteFaceMaterial(),c.material.force=!0),c.material)},_=function(e,t,i,r,n){for(var s=e.buffer?e:e.prims,o=e.buffer?null:e.bs,l=s.length/5,c=new a.BinarySGPrimitiveArray(s,i,t,o,5),h=[],u=null,d=null,p=new Set,f=0;f<l;f++){(u=t[s[5*f+1]])._binary=!0,p.has(u)&&u!==d&&console.error("Non contiguious primitive reps"),p.add(u);var m=u._primitives[u._primitives.length-1];m&&u===d?m.count++:u._primitives.push({binary:c,start:f,count:1}),d=u}if(r&&r.noShowPrim&&r.noShowPrim.length){var g=new a.SGPrimitiveHelper;for(f=0;f<r.noShowPrim.length;f++)g.set(i,r.noShowPrim[f]),h.push(g.clone())}return{primitives:c,noShowPrim:h}},y=function(e,t,i,r,n){for(var s=e.buffer?e:e.prims,o=(e.buffer||e.bs,s.length/5),l=new Array(o),c=[],h=-1,u=null,d=0,p=0,f=0,m=null,g=0,v=0;v<o;v++)h=s[g++]-1,u=t[s[g++]],d=s[g++],p=s[g++],f=s[g++],m=new a.SGPrimitive({cgmId:h,rep:u,start:d,count:p,decoration:f,group:i}),l[v]=m,u._primitives.push(m);if(r&&r.noShowPrim&&r.noShowPrim.length){var S=new a.SGPrimitiveHelper;for(v=0;v<r.noShowPrim.length;v++)S.set(i,r.noShowPrim[v]),c.push(S.clone())}return{primitives:l,noShowPrim:c}},x=function(t,i,s,o,l,c,h){for(var u,d,p=null,f=null,m=[],g=null,v=null,x=new e.Sphere,M=new e.Box3,P=[],C=h.sgRep,b=h.decorations,D=new n,w=0;w<t.length;w++){var E=t[w],T=h.noMeshInRAM,A=new e.BufferGeometryDS,I=new e.Vector3(E.AABB.min[0],E.AABB.min[1],E.AABB.min[2]),R=new e.Vector3(E.AABB.max[0],E.AABB.max[1],E.AABB.max[2]);A.boundingBox=new e.Box3(I,R),A.boundingSphere=A.boundingBox.getBoundingSphere(),null===g&&(g=I),null===v&&(v=R),I.x<g.x&&(g.x=I.x),I.y<g.y&&(g.y=I.y),I.z<g.z&&(g.z=I.z),R.x>v.x&&(v.x=R.x),R.y>v.y&&(v.y=R.y),R.z>v.z&&(v.z=R.z),M.set(g,v),x.radius=v.clone().sub(g).multiplyScalar(.5).length(),x.center=v.clone().add(g).multiplyScalar(.5);for(var L=0;L<E.drawingGroups.length;L++){if(p=E.drawingGroups[L],E.drawingGroups[L]=new a.DrawingGroup(p.gas,p.material,p.glType,p.start,p.count,p._primitives,null,p._geomType,p.gasIndex),E.drawingGroups[L].cullingData=p.cullingData,h.fromCGR){var O;e._BinaryPrimitives?(O=_(p._primitives,C,E.drawingGroups[L],p),E.drawingGroups[L]._nonBinary=!1):O=y(p._primitives,C,E.drawingGroups[L],p),E.drawingGroups[L]._primitives=O.primitives,P=P.concat(O.noShowPrim)}else{d=(p=E.drawingGroups[L])._primitives;for(var N=0;N<d.length;N++)d[N]=new a.SGPrimitive(d[N]),d[N].group=p}(p=E.drawingGroups[L]).geometry=A;var F=p.gas,V=!1;F.set&&(V=(F.set>>4&3)>1);var U=p.material;if(p.gas=null,p.material=null,null!==U&&""!==U.file?p.material=S(U.id,c):null===U||-1===U.id||4!==p.glType&&!V||(l[U.id]?u=l[U.id]:(U.shading&&(s[U.id].shading=U.shading),(u=D.getMaterialCgr(s[U.id],void 0,"CGR",o,p))&&(u._sceneGraphOrderMode=h.sceneGraphOrderMode,l[U.id]=u,s[U.id]&&s[U.id].useAsGas&&(F=null,p.gas=u),void 0!==u.needTangentBinormal&&(u.needTangentBinormal&&E.vertexTangentArray&&E.vertexBinormalArray||(u.needTangentBinormal=!1)))),p.material=u),null!==F)if(F.set){h&&!h.edgeTransparency&&D._getLineWidth(F)>1&&(F.opacity=1),D._gasAllowNMIR(F)||(T=!1);var B=-1;0==(F.set>>4&3)&&((B=F.set>>8&15)||(B=4),p._geomType!=e.GeomTypeEnum.EDGE&&p._geomType!=e.GeomTypeEnum.BOUNDARY_EDGE&&p._geomType!=e.GeomTypeEnum.SMOOTH_EDGE&&p._geomType!=e.GeomTypeEnum.SHARP_EDGE||(B=-1),F.set|=3840),p.gas=D._getMaterialFromGAS(new a.GraphicAttributeSet(F.set,F.rgba),{sceneGraphOrderMode:h.sceneGraphOrderMode}),p._noZPriority=B}else{var k=new e.Color;k.setRGB(F.color.r,F.color.g,F.color.b),F.lineWidth&&h&&!h.edgeTransparency&&(F.opacity=1),(F.pattern>1||F.lineWidth>1)&&(T=!1),p.gas=D.getMaterialFromGAS({color:k,opacity:F.opacity,pattern:F.pattern,lineWidth:F.lineWidth,forceLineWidth:F.forceLineWidth,solid:F.solid,symbol:F.symbol,basic:F.basic,resource:o})}}A.drawingGroups=E.drawingGroups,A.decorations=b,A.vertexPositionArray=E.vertexPositionArray,null!==E.vertexNormalArray&&(A.vertexNormalArray=E.vertexNormalArray),null!==E.vertexUvArray&&(A.vertexUvArray=E.vertexUvArray),null!==E.vertexTangentArray&&(A.vertexTangentArray=E.vertexTangentArray),null!==E.vertexBinormalArray&&(A.vertexBinormalArray=E.vertexBinormalArray),null!==E.vertexColorArray&&(A.vertexColorArray=E.vertexColorArray),A.vertexIndexArray=E.vertexIndexArray,h&&h.sharedBuffers&&(A.sharedBuffers=!0),A.noMeshInRAM=T,m.push(A)}(U=D._getMaterialFromGAS(new a.GraphicAttributeSet(251658274,-1))).line=D._getMaterialFromGAS(new a.GraphicAttributeSet(251924497,-1)),m.boundingSphere=x,m.boundingBox=M,(f=new e.Mesh(m,U)).fromLoadedModel=!0;for(w=0;w<m.length;w++){a.unindexPoints(m[w])&&(m[w].sharedBuffers=!1)}f.matrixAutoUpdate=!1,f.castShadow=!0,f.receiveShadow=!0;var G=new r(f);(P.length&&G.hide(P),h.accelStruct)&&G._occurrences[0].renderable.computeKDTree(!1);return G},M={__storeCGRNames:1,getEmptyMesh:function(){return v||(v=this.createEmptyMesh()),v},createEmptyMesh:function(){var t=new e.BufferGeometryDS;t.boundingSphere=new e.Sphere(new e.Vector3,0),t.boundingBox=new e.Box3;var i=e.MaterialUtils.createShinyFaceMaterial(),n=new e.Mesh(t,i);return n.matrixAutoUpdate=!1,n.castShadow=!0,n.receiveShadow=!0,new r(n)},processData:function(r,l,u,v,S,_){var y=function(e,t){if(e&&t&&e.children)for(var i=e.children,r=null,n=i.length,a=0;a<n;a++)i[a].children?y(i[a],t):i[a].parents&&i[a].parents[0]||(t[i[a]].parents[0]=e,r=t[i[a]],i[a]=r)},P=function(){this.children=[]};P.prototype.addChild=function(e){this.children.push(e)};var C,b=null,D=null,w=null,E=[],T=[],A=!1,I=!1,R=function(){if(!A&&I){if(r&&!S.unlinkToSG)if(v)for(var e=0;e<r.length;e++)r[e]&&(O?((b=M.createEmptyMesh()).name=l.node,r[e].addChild(b)):(r[e].addChild(C),T=[C]),l.sceneGraph&&l.sceneGraph.noShow&&C.setVisibility(!1));else for(e=0;e<r.length;e++)if(r[e])if(r[0].length&&(r=r[0]),O)(b=M.createEmptyMesh()).name=l.node,r[e].addChild(b);else for(var t=0;t<C.children.length;t++)r[e].addChild(C.children[t]);_&&_(T)}};S||(S={}),S&&S.textureInBlack&&l&&function(e){e.length;for(var t=0;t<e.length;t++){var i=e[t].img,r=e[t].format;if(2==r)for(var n=0;n<i.length;n+=3)255==i[n]&&255==i[n+1]&&255==i[n+2]&&(i[n]=0,i[n+1]=0,i[n+2]=0);if(3==r)for(n=0;n<i.length;n+=4)255==i[n]&&255==i[n+1]&&255==i[n+2]&&(i[n]=0,i[n+1]=0,i[n+2]=0)}}(l.resource),C=v?new t(l.sceneGraph):new P;var L=new n;L.cleanResources();var O=!0;if(l.rep)l.rep.length>0&&(b=x(l.rep,0,l.material,l.resource,E,u,S)),b&&(C.addChild(b),O=!1);else{S.fromCGR=!0;var N=function(e,t){if(!e)return[];var i=3;t.withSAG&&(i+=1),t.repWithBS&&(i+=4);var r=e.length/i,n=new Array(r),s=0;if(t.withSAG)if(t.repWithBS)for(var o=0;o<r;o++)n[o]=new a.SGRep({cgmId:e[s++]-1,solid:e[s++],namingContext:e[s++],sag:e[s++],boundingSphere:{radius:e[s++],center:[e[s++],e[s++],e[s++]]}});else for(o=0;o<r;o++)n[o]=new a.SGRep({cgmId:e[s++]-1,solid:e[s++],namingContext:e[s++],sag:e[s++]});else if(t.repWithBS)for(o=0;o<r;o++)n[o]=new a.SGRep({cgmId:e[s++]-1,solid:e[s++],namingContext:e[s++],boundingSphere:{radius:e[s++],center:[e[s++],e[s++],e[s++]]}});else for(o=0;o<r;o++)n[o]=new a.SGRep({cgmId:e[s++]-1,solid:e[s++],namingContext:e[s++]});return n}(l.sgRep,S);v&&y(l.sceneGraph,N),S.sgRep=N,S.decorations=l.decorations;for(var F=0;F<l.reps.length;F++)if(l.reps[F].length){if(1&F||8&F){if((b=new i).name=l.node+"_parallelToScreen",!(1&F)){for(V=0;V<l.reps[F].length;++V){(B=x(l.reps[F][V].tab,0,l.material,l.resource,E,u,S)).setRatio(1);k=l.reps[F][V].globalMatrix;(U=new o(le={type:"Spherical"})).addChild(B),k&&U.setMatrix((new e.Matrix4).setFromArray(k.elements)),b.addChild(U)}0==b.children.length&&(b=null),b&&(T.push(b),C.addChild(b),O=!1);continue}for(var V=0;V<l.reps[F].length;++V){var U,B=x(l.reps[F][V].tab,0,l.material,l.resource,E,u,S),k=l.reps[F][V].globalMatrix;(U=new o(le={type:"Spherical"})).addChild(B),k&&U.setMatrix((new e.Matrix4).setFromArray(k.elements)),b.addChild(U)}0==b.children.length&&(b=null)}else b=x(l.reps[F],0,l.material,l.resource,E,u,S),1===this.__storeCGRNames&&(b.name=l.node);2&F&&b.setExcludeFromBounding(!0),4&F&&b.setNoZ(!0),b&&(T.push(b),C.addChild(b),O=!1)}}if(S.processText&&l.texts&&l.texts.length>0){A=!0,O=!1;d.createTexts(l.texts,S,function(e){for(var t=0;t<e.length;++t){var i=e[t];T.push(i),C.addChild(i)}A=!1,R()})}if(l.voxelReps&&l.voxelReps.length>0){var G=l.voxelReps;for(F=0;F<G.length;F++){var z=G[F],H=new m(z);T.push(H),C.addChild(H),O=!1}}if(l.refPlanes&&l.refPlanes.length>0){var W=new i;(w=new i("RefPlanes")).setNoZ(!0),w.setVisibility(!1),w.setVisibilityInTree(!1);var j=1/e.getPixelsPerMM(),X=e.getDevicePixelRatio()/j;for(F=0;F<l.refPlanes.length;++F)for(V=0;V<l.refPlanes[F].length;V++){var q=l.refPlanes[F][V],Z=null,Y=q.lengthX*X,K=q.lengthY*X,J=new e.Vector3(q.xAxis[0],q.xAxis[1],q.xAxis[2]),Q=new e.Vector3(q.yAxis[0],q.yAxis[1],q.yAxis[2]),$=((new e.Vector3).crossVectors(J,Q),new e.Vector3(q.origin[0],q.origin[1],q.origin[2])),ee=new a.Color(q.color[0]/255,q.color[1]/255,q.color[2]/255,q.color[3]/255);new e.Color(ee);if("CAT3DReferencePlaneRep"===q.type){var te=q.mode;te?(q.lengthX*=1/j,q.lengthY*=1/j):q.autoSize&&(q.lengthX*=1.05,q.lengthY*=1.05);var ie=q.refPlaneData,re=!ie||!ie._wireframeMode,ne=(!!ie&&ie._orientationVisibility,!ie||ie._labelVisibility),ae=ie?ie._opacity/255:.075,se=ie?new e.Color(ie._frontColor):new e.Color("#005686"),oe=ie?new e.Color(ie._backColor):new e.Color("#a3c8dc"),le={name:"ref Plane "+F,fill:!0,newLook:re,fixedSize:te,size:new e.Vector2(q.lengthX,q.lengthY),planeAttributes:{front:{color:se,opacity:ae},back:{color:oe,opacity:ae}},borderAttributes:{front:{color:se,opacity:.8,width:1},back:{color:oe,opacity:.8,width:1}}};ne&&(le.textAttributes={fixedSize:!0,front:{data:q.label,color:se,opacity:1,size:30},back:{data:q.label,color:oe,opacity:1,size:30}}),Z=new f(le)}else if(q.zoomable){(Z=h.createRectangleNode({color:ee,width:Y,height:K,fill:!1})).setShadow(!1),Z.setFrustumCulled(!1);var ce=new e.Vector3(.7071068*-Y/2,.7071068*-K/2,0),he=(new e.Matrix4).setPosition(ce);Z.setMatrix(he)}else{le={sgRep:N[q.rep],origin:$,direction2:new e.Vector3(q.xAxis[0]+q.yAxis[0],q.xAxis[1]+q.yAxis[1],q.xAxis[2]+q.yAxis[2]),direction1:new e.Vector3(q.xAxis[0]-q.yAxis[0],q.xAxis[1]-q.yAxis[1],q.xAxis[2]-q.yAxis[2]),sceneGraph:W,color:ee,length1:.7071068*Y,length2:.7071068*K,name:"ref Plane "+F};Z=new c(le)}w.addChild(Z)}}if(w&&(w._forceGeomType("INFINITE_FACE"),T.push(w),C.addChild(w),O=!1),l.arrows&&l.arrows.length>0){W=new i;var ue=new i("Arrows");ue.setNoZ(!0);for(j=.264583333,X=e.getDevicePixelRatio()/j,F=0;F<l.arrows.length;++F)for(V=0;V<l.arrows[F].length;V++){var de=l.arrows[F][V],pe=null,fe=de.length*X,me=new e.Vector3(de.direction[0],de.direction[1],de.direction[2]);me.normalize();var ge=new e.Vector3(0,1,0),ve=new e.Vector3(1,0,0);$=new e.Vector3(de.origin[0],de.origin[1],de.origin[2]);if(1!==me.z)(ge=(new e.Vector3).cross(new e.Vector3(0,0,1),me)).normalize(),(ve=(new e.Vector3).cross(ge,me)).normalize();(Fe=(new e.Matrix4).makeBasis(ve,ge,me)).setPosition($);le={name:"arrow"+F,pickable:!0,color:ee=new a.Color(de.color[0]/255,de.color[1]/255,de.color[2]/255,de.color[3]/255),head:g.types.ARROW,arrowLength:fe,arrowWidth:1};pe=new g(le),de.noShow&&pe.setVisibility(!1),pe.setMatrix(Fe),de.infiniteFace&&pe._forceGeomType("AXIS_SYSTEM"),ue.addChild(pe)}ue&&(T.push(ue),C.addChild(ue),O=!1)}if(l.curvedPipes&&l.curvedPipes.length>0){var Se=null,_e={curvedPipes:[]};for(F=0;F<l.curvedPipes.length;++F){var ye=l.curvedPipes[F],xe=(ye.matId,ye.gas),Me={radius:ye.radius,curvePoints:ye.curveVertices,baseNormal:new e.Vector3(ye.startNormal[0],ye.startNormal[1],ye.startNormal[2]),endNormal:new e.Vector3(ye.endNormal[0],ye.endNormal[1],ye.endNormal[2]),baseSideVector:new e.Vector3(ye.startSideVector[0],ye.startSideVector[1],ye.startSideVector[2])};if(_e.curvedPipes.push(Me),null!==xe)(ee=new e.Color).setRGB(xe.color.r,xe.color.g,xe.color.b),Se=L.getMaterialFromGAS({color:ee,opacity:xe.opacity}),Me.gas=Se,Se._source=e.AssetSource.MANUAL}var Pe=new p(_e);T.push(Pe),C.addChild(Pe),O=!1}if(l.canonicals&&l.canonicals.length>0){var Ce={Cone:0,Cylinder:1,Pipe:2,Cuboid:3,Sphere:4,PartialSphere:5,Tore:6,PartialTore:7};switch(l.canonicals[0].canonicalType){case Ce.Cone:console.log("Cone");break;case Ce.Cylinder:console.log("Cylinder");break;case Ce.Pipe:console.log("Pipe");break;case Ce.Cuboid:console.log("Cuboid");break;case Ce.PartialSphere:console.log("PartialSphere");break;case Ce.Sphere:console.log("Sphere");break;case Ce.PartialTore:console.log("PartialTore");break;case Ce.Tore:console.log("Tore")}}if(l.axisSystems&&l.axisSystems.length>0){W=new i;(D=new i("AxisSystems")).setVisibility(!1),D.setVisibilityFree(!0),D.setVisibilityInTree(!1);for(j=1/e.getPixelsPerMM(),F=0;F<l.axisSystems.length;++F){var be=l.axisSystems[F],De=null,we=be.zoomable||!1;le={sgRep:N[be.rep],headLength:10,arrowLength:we?be.length:50,arrowWidth:2,sceneGraph:W,colors:{colorX:new a.Color(be.color[0]/255,be.color[1]/255,be.color[2]/255,be.color[3]/255),colorY:new a.Color(be.color[0]/255,be.color[1]/255,be.color[2]/255,be.color[3]/255),colorZ:new a.Color(be.color[0]/255,be.color[1]/255,be.color[2]/255,be.color[3]/255)},name:"axis System 1",head:s.types.ARROW,zoomable:we};De=new s(le);var Ee=new e.Matrix4,Te=[];if(Te[0]=be.xAxis[0],Te[1]=be.xAxis[1],Te[2]=be.xAxis[2],Te[3]=0,Te[4]=be.yAxis[0],Te[5]=be.yAxis[1],Te[6]=be.yAxis[2],Te[7]=0,Te[8]=be.zAxis[0],Te[9]=be.zAxis[1],Te[10]=be.zAxis[2],Te[11]=0,Te[12]=be.origin[0],Te[13]=be.origin[1],Te[14]=be.origin[2],Te[15]=1,Ee.setFromArray(Te),De.setMatrix(Ee),D.addChild(De),void 0!==be.refPlanes){var Ae=null;if(we){Ae=new i;for(var Ie=null,Re=0;Re<be.refPlanes.length;Re++){ee=new a.Color(be.color[0]/255,be.color[1]/255,be.color[2]/255,be.color[3]/255);Ie=be.refPlanes[Re];var Le=[new e.Vector3(Ie[0],Ie[1],Ie[2]),Ne=new e.Vector3(Ie[3],Ie[4],Ie[5]),new e.Vector3(Ie[6],Ie[7],Ie[8])];(Z=h.createLineNode({points:Le,color:ee})).setShadow(!1),Z.setFrustumCulled(!1),Ae.addChild(Z)}}else{Ae=new i("fixedSizeHalfPlanes");var Oe=(new e.Matrix4).getInverse(Ee);for(be.xAxis,be.yAxis,be.zAxis,Re=0;Re<be.refPlanes.length&&1===be.refPlanes[Re].mode;Re++){fe=be.refPlanes[Re].length*e.getDevicePixelRatio()/j,ee=new a.Color(be.color[0]/255,be.color[1]/255,be.color[2]/255,be.color[3]/255),J=be.refPlanes[Re].direction1,Q=be.refPlanes[Re].direction2;var Ne=new e.Vector3(.5*fe*J[0],.5*fe*J[1],.5*fe*J[2]);Le=[new e.Vector3(Ne.x+.25*fe*(J[0]+Q[0]),Ne.y+.25*fe*(J[1]+Q[1]),Ne.z+.25*fe*(J[2]+Q[2])),Ne,new e.Vector3(Ne.x+.25*fe*(J[0]-Q[0]),Ne.y+.25*fe*(J[1]-Q[1]),Ne.z+.25*fe*(J[2]-Q[2]))];(Z=h.createLineNode({points:Le,color:ee})).setShadow(!1),Z.setFrustumCulled(!1),Ae.addChild(Z)}var Fe=(new e.Matrix4).multiplyMatrices(Oe,(new e.Matrix4).setPosition(new e.Vector3(be.origin[0],be.origin[1],be.origin[2])));Ae.setMatrix(Fe),Ae._setRatio(1)}Ae.setNoZ(!0),De.addChild(Ae)}}}D&&(D._forceGeomType("AXIS_SYSTEM"),T.push(D),C.addChild(D),O=!1),r&&!S.unlinkToSG&&v&&C._buildSGBagNodes(),I=!0,R()},isProcessDataAsynchronous:!0};return M}),define("DS/VisuDataAccess/Ox4MQLV6Loader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","UWA/Utils","DS/Visualization/Utils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/VisuDataAccess/Ox4DOSRunner","DS/VisuDataAccess/Ox4DECRunner","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/VisuDataAccess/Ox4TypeHelper","DS/WAFData/WAFData","DS/Visualization/LoaderUtils","DS/VisuDataAccess/Ox4TreeTarget"],function(e,t,i,r,n,a,s,o,l,c,h,u,d,p){"use strict";return function(a,s,f,m){var g,v=void 0!==s?s:null,S=null,_=null,y=null,x=null,M=!1,P=0,C=0,b=[],D=[],w={},E=null;function T(){null!=x&&(x.terminate(),x=null,M=!1),S=null,_=null,y=null,P=0,C=0,b=[],D=[],g=null,E=null,w={}}function A(e){D.length;var t=new c,i=0,r=function(){var n=D[i++];void 0!==n&&t.asyncTransformFCSUrlIntoRealUrl(n,!1,function(t,i){var n;e.value||""!==t&&(n=t,function(e,t,i,r){if("posthttp"==e.slice(0,8)){var n=e.indexOf(":postparams:"),a=e.slice(9,n),s={cors:!0,timeout:1e5,method:"POST",data:e.slice(n+12,e.length),type:"arraybuffer",async:!0,headers:{Accept:"text/plain"},onComplete:t,onFailure:i};u.authenticatedRequest(a,s)}}(i,function(t){e.value||(x.postMessage({inputFile:t,node:n,withSceneGraph:!!w.withSceneGraph&&w.withSceneGraph},[t]),r())}))})};window.hasOwnProperty("ODTNoFCSCalls")||null===y||y({loaded:0,total:D.length});for(var n=D.length>8?8:D.length,a=0;a<n;a++)r();S&&S(g),0===D.length&&_()}this.setGeometryMode=function(e){},this.load=function(a,s,c,u,f,m){w=m||{},E={value:!1},S=s,y=c,_=function(){T(),u&&u()},console.log("Ox4 Version V"),console.log("Ox4 ObjectDisplaySpecification"),console.log(a.physicalid),console.log(a.dtype);var I=function(t){if("Node"===t){var i=new n;return i.isPLMInstance=p.isPLMInstance,i.isPLMReference=p.isPLMReference,i.isPLMRepReference=p.isPLMRepReference,i}if("Matrix"===t)return new e.Matrix4};null==a.dtype&&(a.dtype="VPMReference");var R,L,O=a.dtype,N=null;h.InitWithUrl(a.serverurl,a.tenant,a.requiredAuth,a.proxyurl),R=O,L=function(e){if(e?N=new o(a,I):"SW Assembly Family"===(c=O)||"SW Component Family"===c||"SW Assembly Instance"===c||"SW Component Instance"===c||"CATPart"===c||"CATProduct"===c||h.IsBusA(c,"MCAD Model")&&(console.log("Ox4MQLV6Loader: Either customized or other than considered DEC Type provided : "+c),1)?N=new l(a,I):f({type:"LOAD",url:"type "+O}),null!=N){var n=f,s=E;N.run(null,function(e){if(!s.value){console.log("success........"),g=e.rootNode;var n=e.geometryNodes;C=n.length,P=C;for(var a=0;a<n.length;a++){var o=n[a].ticketRequest.generateRequest();b[o.data]=n[a],D.push(o)}window.hasOwnProperty("ODTNoFCSCalls")&&window.ODTNoFCSCalls?(S&&S(g),_&&_()):function(e){if(null===x){var n=i.matchUrl(t.getWebappsBaseUrl(),window.location)?null:"Passport",a={provider:"FILE",filename:"AmdLoader.js",serverurl:t.getWebappsBaseUrl()+"AmdLoader/",requiredAuth:n},s={provider:"FILE",filename:"ThreeJS_Base.js",serverurl:t.getWebappsBaseUrl()+"Mesh/",requiredAuth:n},o={provider:"FILE",filename:"Mesh.js",serverurl:t.getWebappsBaseUrl()+"Mesh/",requiredAuth:n},l={provider:"FILE",filename:"CGRFile.js",serverurl:t.getWebappsBaseUrl()+"Formats/",requiredAuth:n},c={provider:"FILE",filename:"CGRWorkerNewInfra.js",serverurl:t.getWebappsBaseUrl()+"Workers/",requiredAuth:n},h=[a,s,o,l,c];r.getWorkerFromSpecs(h,function(t){e.value?t.terminate():(x=t).onmessage=function(t){var i=t.data;if(i.loaded)M||(M=!0,A(e));else{var r=b[i.node.data];P--;var n=function(e){null!==y&&y({loaded:C-P,total:C}),null!==v&&v({hack:!0,updateInfinitePlane:!0}),P||null===_||_()};r?d.processData([r],i,void 0,w.withSceneGraph,w,n):n([])}}})}else M&&A(e)}(s),console.log("Ox4 Plan runned")}},n)}var c},h.IsBusA(R,"VPMReference",function(e){e?L(!0):h.IsBusA(R,"VPMRepReference",L)})},this.abort=function(){null!==E&&(E.value=!0,T())}}}),define("DS/VisuLoaders/CGRReader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","UWA/Utils","DS/Visualization/Utils","DS/Visualization/ProxyAbstraction","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/SceneGraphNodes/AxisSystemNode","DS/Mesh/Mesh","DS/SceneGraphNodes/BillBoardNode3D","DS/Visualization/LoaderUtils","DS/ZipJS/LoaderInflate"],function(e,t,i,r,n,a,s,o,l,c,h,u,d){"use strict";var p=i.matchUrl(t.getWebappsBaseUrl(),window.location)?null:"Passport",f={provider:"FILE",filename:"AmdLoader.js",serverurl:t.getWebappsBaseUrl()+"AmdLoader/",module:"AmdLoader",requiredAuth:p},m={provider:"FILE",filename:"ThreeJS_Base.js",serverurl:t.getWebappsBaseUrl()+"Mesh/",module:"Mesh",requiredAuth:p},g={provider:"FILE",filename:"Mesh.js",serverurl:t.getWebappsBaseUrl()+"Mesh/",module:"Mesh",requiredAuth:p},v={provider:"FILE",filename:"CGRFile.js",serverurl:t.getWebappsBaseUrl()+"Formats/",module:"Formats",requiredAuth:p},S={provider:"FILE",filename:"CGRWorkerNewInfra.js",serverurl:t.getWebappsBaseUrl()+"Workers/",module:"Workers",requiredAuth:p},_=function(t,i,a){a||(a={}),this.gl=t;var s=void 0;e.supportedExtensions&&(s=!!e.supportedExtensions.elementIndexUint||void 0),this.renderCallbackFunc=void 0!==i?i:null,this.isWorkerLoading=!1,this.workers=null,this.workerJobs=null,this.workerJobsId=[],this.urlToRevoke="",this.keepLoader=!!a.keepLoader&&a.keepLoader,this.type="",this.dataArray=[],this.materials=[];this.modelsToLoad=new Map,this.modelsToLoadCount=0,this.loadIndex=0,this.actualLoadIndex=0,this.nbWorkers=4,this.workersLoaded=[],this.workerActivate=!1,this.currentDownload=0,this.maxParrallelDownload=40,this.currentWorkerTask=0,this.maxTaskPerWorker=10,this.maxWorkerTask=this.maxTaskPerWorker*this.nbWorkers;_.prototype.cleanLoader=function(){this.materials=[],[]};var o=function(e){var t,i,r,n,a,s;for(t="",r=e.length,i=0;i<r;)switch((n=e[i++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(n);break;case 12:case 13:a=e[i++],t+=String.fromCharCode((31&n)<<6|63&a);break;case 14:a=e[i++],s=e[i++],t+=String.fromCharCode((15&n)<<12|(63&a)<<6|(63&s)<<0)}return t},l=function(e,t,i){var r=i;if(t&&t.applicativeContainersNode&&(r=t.applicativeContainersNode),t&&e)for(var n in t){var a=t[n].doneCallback,s=t[n].errorCallback;if(e[n]){var l=e[n];if(!l){s({node:r});continue}var c=l.buffer.subarray(l.options.offset,l.options.compressed+l.options.offset);if(c.length<=2){s({node:r});continue}if(120!==c[0]){s({node:r});continue}if(218!==c[1]){s({node:r});continue}var h=c.subarray(2,l.options.compressed),u=(new d).Inflate(h),p=o(u);a&&a({xml:p,node:r})}else a&&a({node:r})}};this.jobsScheduler=function(e){for(var t=[this.nbWorkers],i=0;i<this.nbWorkers;++i)t[i]=-1;for(i=0;i<this.workersLoaded.length;++i){for(var r=0,n=0;n<this.workerJobs[this.workersLoaded[i]].length;++n)r+=this.workerJobs[this.workersLoaded[i]][n];t[this.workersLoaded[i]]=r}var a=0,s=-1;for(i=0;i<this.nbWorkers;++i)-1!=t[i]&&(-1==s||t[i]<s)&&(s=t[i],a=i);this.workerJobs[a].push(e.inputFile.byteLength),this.workerJobsId[a].push(e.loadIndex),this.currentWorkerTask++,this.workers[a].postMessage(e,[e.inputFile])},this.internalLoad=function(){var e,t=this,i=this.actualLoadIndex,a=null,o=this.modelsToLoad.get(this.actualLoadIndex++),l=o.url;o.launched=!0;var c=function(e){var t=[];if(!e)return t;for(var i in e)t.push(i);return t}(o.applicativeContainers);o.isBuffer?((a=o.url)&&a.buffer&&(a=a.buffer),e="CGR"):l&&l.filename&&(e=l.filename);var h={loadIndex:i,inputFile:a,readDecoration:o.readDecoration,primitiveWithBS:o.primitiveWithBS,repWithBS:o.repWithBS,withSAG:o.withSAG,withBagUUID:o.withBagUUID,sagInfo:o.sagInfo,optimizeCurvedPipes:o.optimizeCurvedPipes,withSceneGraph:o.withSceneGraph,withBlanking:o.withBlanking,useDefaultTCSet:o.useDefaultTCSet,smartStaticBatching:o.smartStaticBatching,sceneGraphOrderMode:o.sceneGraphOrderMode,edgeTransparency:o.edgeTransparency,node:e,uint32Index:s,applicativesContainers:c,processText:o.processText};if(o.isBuffer)this.jobsScheduler(h);else{this.currentDownload++;var u=new n;r.setProxyFromSpec(l,u);var d=l.serverurl?l.serverurl:"";d+=l.filename?l.filename:"";u.executeGetHttpRequest(d,"arraybuffer",null,function(e){t.currentDownload--;h.inputFile=e,t.jobsScheduler(h)},function(e){t.currentDownload--,o.errorCallback(e)})}},this.setKeepLoaderMode=function(e){this.keepLoader=e,this.keepLoader||0!=this.modelsToLoadCount||this.abort()},this.load=function(e,t,i){var n=this;this.cleanLoader();void 0!==i.isBuffer&&i.isBuffer;var a,s,o=(a=this.loadIndex,s=t.errorCallback,function(e){console.log("index :  "+a),s&&s(e);var t=n.modelsToLoad.get(a);if(t.applicativeContainers)for(var i in t.applicativeContainers)t.applicativeContainers[i].errorCallback&&t.applicativeContainers[i].errorCallback(e);for(n.modelsToLoad.delete(a),n.modelsToLoadCount--,0==n.modelsToLoadCount&&(null!==n.renderCallbackFunc&&n.renderCallbackFunc({hack:!0,updateInfinitePlane:!0,reframe:!0}),t.doneCallback&&t.doneCallback()),[];n.currentDownload<n.maxParrallelDownload&&n.currentWorkerTask<n.maxWorkerTask;){var r=n.modelsToLoad.get(n.actualLoadIndex);if(!r||!1!==r.launched)break;n.internalLoad()}}),c={url:e,readyCallback:t.readyCallback,progressCallback:t.progressCallback,doneCallback:t.doneCallback,errorCallback:o,isBuffer:i.isBuffer,destinationNode:i.destination,readDecoration:i.readDeco,optimizeCurvedPipes:i.optimizeCurvedPipes,primitiveWithBS:i.primWithBS,repWithBS:i.repWithBS,smartStaticBatching:i.smartStaticBatching,sceneGraphOrderMode:i.sceneGraphOrderMode,withSAG:i.withSAG,withBagUUID:i.withBagUUID,sagInfo:i.sagInfo,withSceneGraph:i.withSceneGraph,withBlanking:i.withBlanking,useDefaultTCSet:i.useDefaultTCSet,edgeTransparency:i.edgeTransparency,sharedBuffers:i.sharedBuffers,noMeshInRAM:i.noMeshInRAM,unlinkToSG:i.unlinkToSG,applicativeContainers:i.applicativeContainers?i.applicativeContainers:null,launched:!1,processText:i.processText,accelStruct:i.accelStruct};if(this.modelsToLoad.set(this.loadIndex++,c),this.modelsToLoadCount++,this.workers)this.currentDownload<this.maxParrallelDownload&&this.currentWorkerTask<this.maxWorkerTask&&this.workerActivate&&this.internalLoad();else if(!this.isWorkerLoading){var h;this.type="cgr",this.isWorkerLoading=!0,h=[f,m,g,v,S],r.getWorkerBlobFromSpecs(h,function(e){n.workers=[];var t=n.workers;n.workerJobs=[],n.workerJobsId=[],n.urlToRevoke=e;for(var i=0;i<n.nbWorkers;++i){n.workers[i]=new Worker(e),n.workerJobs[i]=[],n.workerJobsId[i]=[];!function(e){n.workers[e].onerror=function(i){if(t[e]){var r=n.workerJobsId[e].shift();n.workerJobs[e].shift(),n.modelsToLoad.get(r).errorCallback(i),console.log("error worker: numWorker : "+e+" id : "+r)}},n.workers[e].onmessage=function(i){if(t[e]){var r=i.data;if(r.error&&r.loadIndex)return n.currentWorkerTask--,void((s=n.modelsToLoad.get(r.loadIndex)).errorCallback&&s.errorCallback(r));if(r.loaded){if(n.workersLoaded.push(e),!n.workerActivate)for(n.workerActivate=!0;n.currentDownload<n.maxParrallelDownload&&n.currentWorkerTask<n.maxWorkerTask;){var a=n.modelsToLoad.get(n.actualLoadIndex);if(!a||!1!==a.launched)break;n.internalLoad()}}else{n.currentWorkerTask--,n.workerJobs[e].shift(),n.workerJobsId[e].shift();var s,o={accelStruct:(s=n.modelsToLoad.get(i.data.loadIndex)).accelStruct,processText:s.processText,edgeTransparency:s.edgeTransparency,sharedBuffers:s.sharedBuffers,noMeshInRAM:s.noMeshInRAM,fromCGR:!0,sceneGraphOrderMode:s.sceneGraphOrderMode,primitiveWithBS:s.primitiveWithBS,repWithBS:s.repWithBS,unlinkToSG:s.unlinkToSG,withSAG:s.withSAG,withBagUUID:s.withBagUUID,sagInfo:s.sagInfo,withSG:s.withSceneGraph,withBlanking:s.withBlanking};u.processData([s.destinationNode],r,void 0,s.withSceneGraph,o,function(e){if(s.readyCallback&&s.readyCallback({nodes:e}),r.applicativesContainers&&l(r.applicativesContainers,s.applicativeContainers,s.destinationNode),n.modelsToLoad.delete(i.data.loadIndex),n.modelsToLoadCount--,[],0==n.modelsToLoadCount?(null!==n.renderCallbackFunc&&n.renderCallbackFunc({hack:!0,updateInfinitePlane:!0,reframe:!0}),s.doneCallback&&s.doneCallback({isLast:!0})):null!==n.renderCallbackFunc&&n.renderCallbackFunc({hack:!0,updateInfinitePlane:!0,budgeted:!0}),[],n.keepLoader||0!=n.modelsToLoadCount)for(;n.currentDownload<n.maxParrallelDownload&&n.currentWorkerTask<n.maxWorkerTask;){var t=n.modelsToLoad.get(n.actualLoadIndex);if(!t||!1!==t.launched)break;n.internalLoad()}else n.abort();s=null})}}}}(i)}})}},this.loadUVR=function(e,t,i,r,n){this.load(e,t,i,r,n)},_.prototype.abort=function(){if(this.workers){for(var e=0;e<this.workers.length;++e)this.workers[e].terminate(),this.workers[e]=null;window.URL.revokeObjectURL(this.urlToRevoke)}this.workers=null,this.urlToRevoke="",this.isWorkerLoading=!1,this.modelsToLoad=new Map,this.modelsToLoadCount=0,this.loadIndex=0,this.actualLoadIndex=0,this.workersLoaded=[],this.workerActivate=!1,this.cleanLoader()}};return _}),define("DS/Robot/CustomReferenceAxisSystem",["DS/Visualization/Node3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/Visualization/ThreeJS_DS"],function(e,t,i){return e.extend({init:function(e,i){i=i||{},this._parent("customReferenceAxisSystem"),this._subscribedEvents=[],this.viewer=e,this.ratio=i.ratio||7,this.fixedSizeNode3D=new t({name:"fixedSizeNode3D",ratio:this.ratio}),this.addChild(this.fixedSizeNode3D),this.fixedSizeNode3D.addChild(i.node),this.fixedSizeNode3D.setCameraName("robotCameraOrtho"),this.node=i.node,this.removeGeomTypes=i.removeGeomTypes,this.getPosition=i.getPosition||function(e,t){return{x:2*(e-100)/e-1,y:Math.max(200/t-1,-.85)}},this.notifyNodesHierarchyUpdate();var r=this,n=this.viewer.currentViewpoint.onMove(function(){r.onViewpointChange()});this._subscribedEvents.push({object:this.viewer.currentViewpoint,token:n}),n=this.viewer.onViewerResize(function(){r.onViewpointChange()}),this._subscribedEvents.push({object:this.viewer,token:n})},setRatio:function(e){this.fixedSizeNode3D.setRatio(e)},notifyNodesHierarchyUpdate:function(){var e=this;this.fixedSizeNode3D.traverse(function(t){var i;if("Mesh3D"===t.getNodeType()&&(t.excludeFromHighlight(!0,!0),t.setShadow(!1),t.setFrustumCulled(!1),t.excludeFromCSO(!0),e.removeGeomTypes&&t.mesh3js&&t.mesh3js.geometry))for(i=0;i<t.mesh3js.geometry.length;i++){var r,n=t.mesh3js.geometry[i];for(r=0;r<n.drawingGroups.length;r++)n.drawingGroups[r]._geomType=0}})},onViewpointChange:function(){var e,t,r=this.viewer.currentViewpoint;r&&(r._updateRobotCamera(this.viewer.internalSceneGraph),t=function(e,t){var n,a=r.robotCameraOrtho,s=new i.Vector3(e,t,0);if((new i.Projector).unprojectVector(s,a),a instanceof i.PerspectiveCamera){var o=new i.Ray(data.cameraEye,s.sub(data.cameraEye).normalize()),l=new i.Plane(this.viewer.currentViewpoint.camera.getLookAt(),0);n=o.intersectPlane(l)}else n=s;return(new i.Matrix4).setPosition(n)}((e=this.getPosition(this.viewer.canvas.width,this.viewer.canvas.height)).x,e.y),this.setMatrix(t))},_dispose:function(){var e,t;for(e=0;e<this._subscribedEvents.length;e++)(t=this._subscribedEvents[e]).object.unsubscribe(t.token);this._subscribedEvents=[]},CallBackEventHandlerViewPoint:function(){this.onViewpointChange.apply(this,arguments)}})}),define("DS/Visualization/WebGLV6Viewer",["DS/Visualization/WebGLViewer","DS/Robot/Robot","DS/Robot/ReferenceAxisSystemNode","DS/Robot/CustomReferenceAxisSystem","DS/Visualization/InternalSceneGraph","DS/SceneGraphOverrides/SceneGraphState","DS/SceneGraphOverrides/SceneGraphOverrideSetManager","DS/Visualization/OccurrenceRenderingOverride","DS/SceneGraphOverrides/OverrideLink2","DS/QualityManager/QMController","DS/Visualization/ThreeJS_DS","DS/ViewPanel/ViewPanelController","DS/WAFData/WAFData","DS/Visualization/Node3D","DS/SceneGraphOverrides/IdPathOverrideWatcherTree"],function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f){p.SceneGraphOverrideSetManager=s;var m=e.extend({init:function(e){this._useQM=!1,this._QMModif=!1,this._useViewPanel=!1,this._QMSettings={AntiAliasing:{modified:!1,value:{static:"SMAA",dynamic:"SMAA"}},AllowOutline:{modified:!1,value:{static:!0,dynamic:!0}},PixelCulling:{modified:!1,value:{static:4.5,dynamic:4.5}},Transparency:{modified:!1,value:{static:"AlphaBlending",dynamic:"AlphaBlending"}},AllowGroundShadows:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},AllowInterObjectShadows:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},AllowTransparentObjectShadows:{modified:!1,value:{static:!1,dynamic:!1,override:!0}},ShadowQuality:{modified:!1,value:{static:"Medium",dynamic:"Medium"}},ShadowFilter:{modified:!1,value:{static:"PCFOptimized",dynamic:"PCFOptimized"}},FlakesQuality:{modified:!1,value:{static:"Ultra",dynamic:"Ultra"}},DefaultMaterialQuality:{modified:!1,value:{static:!1,dynamic:!1}},Downsampling:{modified:!1,value:{static:1,dynamic:1}},AllowGroundReflection:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},AllowInterObjectReflections:{modified:!1,value:{static:!1,dynamic:!1,override:!0}},AllowInterObjectRefractions:{modified:!1,value:{static:!1,dynamic:!1,override:!0}},AllowSSAO:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},NoOfSamples:{modified:!1,value:{static:16,dynamic:16}},AllowBloom:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},AllowDepthOfField:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},DepthFlickeringReduction:{modified:!1,value:{static:!1,dynamic:!1}}},c.isInitialized||(c.init(),c.initPresetDB("QualityPresets")),c.linkToViewer(this),this._parent(e),!(!navigator.webdriver||localStorage.getItem("WebVisuEnableAAWithWebdriver"))&&!window.__karma__&&localStorage.setItem("WebVisu_GPU_Profile","WebVisu Profile Medium"),c.computeDefaultPreset(),void 0!==e.useQualityManager&&e.useQualityManager&&this._initQMSettings(),this._viewPanelController=null,void 0!==e.useViewPanel&&e.useViewPanel&&(this._viewPanelController=new u(this,e.viewPanelConfig),this._initViewPanelSettings()),this._sceneGraphOverrideSetManager=new s({viewer:this}),this._configAmbiences&&this._configAmbiences.effects&&void 0!==this._configAmbiences.effects.OIT&&this.setOIT(this._configAmbiences.effects.OIT),this._idPathOverrideWatcher=null},_initViewPanelSettings:function(){this._useViewPanel||null===this._viewPanelController||(this._useViewPanel=!0,this._viewPanelController.init())},restoreViewPanelSettings:function(){if(null===this._viewPanelController)return null;this._viewPanelController.restore()},dumpViewPanelSettings:function(){return null===this._viewPanelController?null:this._viewPanelController.dumpSettings()},applyViewPanelSettings:function(e){null!==this._viewPanelController&&this._viewPanelController.apply(e)},restoreVisualizationMode:function(t){return this._useViewPanel?[]:e.prototype.restoreVisualizationMode.call(this,t)},restoreProjectionMode:function(){return this._useViewPanel?[]:e.prototype.restoreProjectionMode.call(this)},restoreAmbiance:function(){if(this._useViewPanel)return[];var t=localStorage.getItem("visuEnv");if(!t&&this._useQM&&!window.__karma__){var i=[];return t="WhiteExperienceOCA",i.push("Visu"+t+"Cmd"),t=t.replace("OCA",""),this.setVisuEnvOCA(t),i}return e.prototype.restoreAmbiance.call(this)},setV6Ambience:function(){if(!this._useViewPanel)return e.prototype.setV6Ambience.call(this)},updateViewPanelUIConfiguration:function(e){this._useViewPanel&&(this._viewPanelController._updateViewPanelUIConfiguration(e),this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}}))},_onRequestViewPanelReconstruction:function(e){return this._modelEvent.subscribe({event:"RequestViewPanelReconstruction"},e)},setPlanesFilter:function(e){var t=this.planesFilterStatus!==e,i=this.getBagNode?this.getBagNode():this.getRootNode?this.getRootNode():null;if(i){var r=i.getChildrenByName("RefPlanes");r&&r.length>0&&r.forEach(function(t){t.setVisibility(e),t.setVisibilityFree(!e)})}t&&(this.planesFilterStatus=e,this.addRenderModeLock("InfiniteFace",e),this._modelEvent.publish({event:"RefPlaneFilterMode",data:{viewer:this,state:this.planesFilterStatus}})),this.render()},setAxisOnlyFilter:function(e){var t=this.axisFilterStatus!==e,i=this.getBagNode?this.getBagNode():this.getRootNode?this.getRootNode():null;if(i){var r=i.getChildrenByName("AxisSystems");r&&r.length>0&&r.forEach(function(t){t.setVisibility(e),t.setVisibilityFree(!e)})}t&&(this.axisFilterStatus=e,this.addRenderModeLock("AxisSystem",e),this._modelEvent.publish({event:"AxisFilterMode",data:{viewer:this,state:this.axisFilterStatus}})),this.render()},setAxisAndPlanesFilter:function(e){this.setPlanesFilter(e),this.setAxisOnlyFilter(e)},_initQMSettings:function(){if(!this._useQM){this._useQM=!0;var e=this,t=function(t,i){var r=c.getCurrentGlobalPreset(t),n=c.getPresetValue(t,r);if(n){var a={AntiAliasing:n.AntiAliasing.IterativeAntiAliasing?"MSAA":n.AntiAliasing.AntiAliasing,PixelCulling:n.PixelCulling.PixelCulling,Transparency:n.Transparency.Transparency,AllowGroundShadows:n.Shadows.AllowGroundShadows,AllowInterObjectShadows:n.Shadows.AllowInterObjectShadows,AllowTransparentObjectShadows:n.Shadows.AllowTransparentObjectShadows,ShadowQuality:n.Shadows.ShadowQuality,ShadowFilter:n.Shadows.ShadowFilter,AllowGroundReflection:n.Reflections.AllowGroundReflection,AllowSSAO:n.AmbientOcclusion.AllowSSAO};void 0!==n.AmbientOcclusion.NoOfSamples&&(a.NoOfSamples=n.AmbientOcclusion.NoOfSamples),void 0!==n.DepthBufferOptions&&(a.DepthFlickeringReduction=n.DepthBufferOptions.DepthFlickeringReduction),void 0!==n.Reflections.AllowInterObjectReflections&&(a.AllowInterObjectReflections=n.Reflections.AllowInterObjectReflections),n.Refractions&&void 0!==n.Refractions.AllowInterObjectRefractions&&(a.AllowInterObjectRefractions=n.Refractions.AllowInterObjectRefractions),void 0!==n.Material&&(a.DefaultMaterialQuality=n.Material.DefaultMaterialQuality,a.FlakesQuality=n.Material.FlakesQuality),void 0!==n.Downsampling&&(a.Downsampling=n.Downsampling.Downsampling),!e.ODTMode&&e._setQMSettings(a,i)}};t("Static","static"),t("Dynamic","dynamic")}},setRobot:function(e,t){this.internalSceneGraph&&this.internalSceneGraph.setRobot(e,t,this)&&this.render()},getRobot:function(){return this.internalSceneGraph?this.internalSceneGraph.getRobot():null},setCustomReferenceAxisSystem:function(e){this.internalSceneGraph&&(this.internalSceneGraph.setCustomReferenceAxisSystem(e),this.render())},getCustomReferenceAxisSystem:function(){return this.internalSceneGraph&&this.internalSceneGraph._customReferenceAxisSystem},setReferenceAxisSystem:function(e){this.internalSceneGraph.showReferenceAxisSystem(e,void 0)},getReferenceAxisSystemNode:function(){return this.internalSceneGraph&&this.internalSceneGraph.referenceAxisSystemNode},createSceneGraphState:function(){if(this._sceneGraphStateVersion&&1!==this._sceneGraphStateVersion)throw console.warn("Cannot use both v1 and v2 sceneGraphStates"),Error();if(this._sceneGraphStateVersion||(this._sceneGraphStateVersion=1),this.getRootNode())return new a(this,this.getRootNode())},setCurrentSceneGraphState:function(e){if(this._sceneGraphStateMode&&1!==this._sceneGraphStateVersio)throw console.warn("Cannot use both v1 and v2 sceneGraphStates"),Error();if(this._sceneGraphStateVersion||(this._sceneGraphStateVersion=1),e instanceof a||this.sceneGraphState instanceof a&&!e){var t=this.getRootNode();(!e||e.viewer===this&&e.sceneGraph===t)&&e!==this.sceneGraphState&&(this.sceneGraphState&&this.sceneGraphState.onDeactivation(t),e&&e.onActivation(t),this.sceneGraphState=e,this.internalSceneGraph.root._occurrences[0].requestOverridesUpdate())}},_setDefaultMaterialQuality:function(t){(e.prototype._setDefaultMaterialQuality.call(this,t),this._useQM&&!this._useViewPanel)&&("Ultra"===this.getDefaultMaterialQuality(t)?this.setVisuAppearanceMode(h.DefaultAppearanceMode.GASLOOK):this.setVisuAppearanceMode(h.DefaultAppearanceMode.BASIC))},_qmSetAllowShadow:function(e,t){return this._QMSettings.AllowInterObjectShadows.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowInterObjectShadows",value:e,staticValue:this._QMSettings.AllowInterObjectShadows.value.static,dynamicValue:this._QMSettings.AllowInterObjectShadows.value.dynamic,viewer:this}}),!0},_qmSetAllowTransparentShadow:function(e,t){return this._QMSettings.AllowTransparentObjectShadows.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowTransparentObjectShadows",value:e,staticValue:this._QMSettings.AllowTransparentObjectShadows.value.static,dynamicValue:this._QMSettings.AllowTransparentObjectShadows.value.dynamic,viewer:this}}),!0},_qmSetTransparency:function(e,t){var i=e;return this._QMSettings.Transparency.value[t]=i,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"Transparency",value:i,staticValue:this._QMSettings.Transparency.value.static,dynamicValue:this._QMSettings.Transparency.value.dynamic,viewer:this}}),!0},_qmEnableZPrePass:function(e,t){return this._QMSettings.DepthFlickeringReduction.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"DepthFlickeringReduction",value:e,staticValue:this._QMSettings.DepthFlickeringReduction.value.static,dynamicValue:this._QMSettings.DepthFlickeringReduction.value.dynamic,viewer:this}}),!0},_qmSetFlakesQuality:function(e,t){return this._QMSettings.FlakesQuality.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"FlakesQuality",value:e,staticValue:this._QMSettings.FlakesQuality.value.static,dynamicValue:this._QMSettings.FlakesQuality.value.dynamic,viewer:this}}),!0},_qmSetDownsamplingFactor:function(e,t){return this._QMSettings.Downsampling.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"Downsampling",value:e,staticValue:this._QMSettings.Downsampling.value.static,dynamicValue:this._QMSettings.Downsampling.value.dynamic,viewer:this}}),!0},_qmSetDefaultMaterialQuality:function(e,t){return this._QMSettings.DefaultMaterialQuality.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"DefaultMaterialQuality",value:e,staticValue:this._QMSettings.DefaultMaterialQuality.value.static,dynamicValue:this._QMSettings.DefaultMaterialQuality.value.dynamic,viewer:this}}),!0},_qmSetShadowFilter:function(e,t){return this._QMSettings.ShadowFilter.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"ShadowFilter",value:e,staticValue:this._QMSettings.ShadowFilter.value.static,dynamicValue:this._QMSettings.ShadowFilter.value.dynamic,viewer:this}}),!0},_qmSetShadowQuality:function(e,t){return this._QMSettings.ShadowQuality.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"ShadowQuality",value:e,staticValue:this._QMSettings.ShadowQuality.value.static,dynamicValue:this._QMSettings.ShadowQuality.value.dynamic,viewer:this}}),!0},_qmSetAllowGroundShadow:function(e,t){return this._QMSettings.AllowGroundShadows.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowGroundShadows",value:e,staticValue:this._QMSettings.AllowGroundShadows.value.static,dynamicValue:this._QMSettings.AllowGroundShadows.value.dynamic,viewer:this}}),!0},_qmSetAllowMirror:function(e,t){return this._QMSettings.AllowGroundReflection.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowGroundReflection",value:e,staticValue:this._QMSettings.AllowGroundReflection.value.static,dynamicValue:this._QMSettings.AllowGroundReflection.value.dynamic,viewer:this}}),!0},_qmSetAntiAliasing:function(e,t){return"MSAA"===e&&(e="Iterative"),this._QMSettings.AntiAliasing.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AntiAliasing",value:e,staticValue:this._QMSettings.AntiAliasing.value.static,dynamicValue:this._QMSettings.AntiAliasing.value.dynamic,viewer:this}}),!0},_qmSetPixelCulling:function(e,t){return this._QMSettings.PixelCulling.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"PixelCulling",value:e,staticValue:this._QMSettings.PixelCulling.value.static,dynamicValue:this._QMSettings.PixelCulling.value.dynamic,viewer:this}}),!0},_qmSetAllowSSAO:function(e,t){return this._QMSettings.AllowSSAO.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowSSAO",value:e,staticValue:this._QMSettings.AllowSSAO.value.static,dynamicValue:this._QMSettings.AllowSSAO.value.dynamic,viewer:this}}),!0},_qmSetSSAONbSamples:function(e,t){return this._QMSettings.NoOfSamples.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"NoOfSamples",value:e,staticValue:this._QMSettings.NoOfSamples.value.static,dynamicValue:this._QMSettings.NoOfSamples.value.dynamic,viewer:this}}),!0},_qmSetAllowSSR:function(e,t){return this._QMSettings.AllowInterObjectReflections.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowInterObjectReflections",value:e,staticValue:this._QMSettings.AllowInterObjectReflections.value.static,dynamicValue:this._QMSettings.AllowInterObjectReflections.value.dynamic,viewer:this}}),!0},_qmSetAllowSSRefraction:function(e,t){return this._QMSettings.AllowInterObjectRefractions.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowInterObjectRefractions",value:e,staticValue:this._QMSettings.AllowInterObjectRefractions.value.static,dynamicValue:this._QMSettings.AllowInterObjectRefractions.value.dynamic,viewer:this}}),!0},setVisuEnv:function(e){this._useViewPanel&&"None"!==e&&"No"!==e?console.warn("Warning: deprecated API usage, please use setVisuEnvOCA instead. API disabled."):this._parent(e)},setVisuEnvOCA:function(e,t){return this._parent(e,t)},_setQMSettings:function(e,t){if(this._useQM){this._QMModif=!0,"static"!==(t=t.toLowerCase())&&"dynamic"!==t&&(t="static"),this.renderer&&this.renderer.recompileAllShaders([h.RendererMode[t]]);var i=e.AntiAliasing;if(void 0!==i&&("Iterative"===i&&(i="MSAA"),this.setAntiAliasing(i,t)),void 0!==e.PixelCulling&&this.setPixelCulling(e.PixelCulling,t),void 0!==e.Transparency&&(this._QMSettings.Transparency.modified||this.setOIT("WeightedAverage"===e.Transparency,t)),void 0!==e.FlakesQuality&&(this._QMSettings.FlakesQuality.modified||this.setFlakesQuality(e.FlakesQuality,t)),void 0!==e.DefaultMaterialQuality&&(this._QMSettings.DefaultMaterialQuality.modified||"dynamic"!==t&&this.setDefaultMaterialQuality(e.DefaultMaterialQuality)),void 0!==e.Downsampling&&(this._QMSettings.Downsampling.modified||"dynamic"!==t&&this.setDownsamplingFactor(e.Downsampling)),void 0!==e.AllowGroundShadows&&(this._QMSettings.AllowGroundShadows.modified||this.setAllowGroundShadow(e.AllowGroundShadows,t)),void 0!==e.AllowInterObjectShadows&&(this._QMSettings.AllowInterObjectShadows.modified||this.setAllowShadow(e.AllowInterObjectShadows,t)),void 0!==e.AllowTransparentObjectShadows&&(this._QMSettings.AllowTransparentObjectShadows.modified||this.setAllowTransparentShadow(e.AllowTransparentObjectShadows,t)),void 0!==e.ShadowQuality&&(this._QMSettings.ShadowQuality.modified||this.setShadowQuality(e.ShadowQuality,t)),void 0!==e.ShadowFilter&&!this._QMSettings.ShadowFilter.modified){var r="PCF"===e.ShadowFilter?"PCFOptimized":e.ShadowFilter;this.setShadowFilter(r,t)}if(void 0!==e.AllowGroundReflection&&(this._QMSettings.AllowGroundReflection.modified||this.setAllowMirror(e.AllowGroundReflection,t)),void 0!==e.AllowInterObjectReflections&&(this._QMSettings.AllowInterObjectReflections.modified||this.setAllowSSLR(e.AllowInterObjectReflections,t)),void 0!==e.AllowInterObjectRefractions&&(this._QMSettings.AllowInterObjectRefractions.modified||this.setAllowSSLRefraction(e.AllowInterObjectRefractions,t)),void 0!==e.NoOfSamples&&!this._QMSettings.NoOfSamples.modified){var n=parseInt(e.NoOfSamples);0===n?(this.setAllowSSAO(!1,t),this._QMSettings.NoOfSamples.value[t]=0):(this.setAllowSSAO(!0,t),this.setSSAOParameters({nbOfSamples:n},t))}void 0!==e.DepthFlickeringReduction&&(this._QMSettings.DepthFlickeringReduction.modified||this.enableZPrePass(e.DepthFlickeringReduction,t)),this._QMModif=!1,this.render()}},_getQMSetting:function(e){var t=this._QMSettings[e];return"IterativeAntiAliasing"===e?{modified:(t=this._QMSettings.AntiAliasing).modified,staticValue:"MSAA"===t.value.static,dynamicValue:!1}:t?{modified:t.modified,staticValue:t.value.static,dynamicValue:t.value.dynamic}:null},getQMSetting:function(e){return this._getQMSetting(e)},onQMSettingModified:function(e){return this._modelEvent.subscribe({event:"QMSettingModified"},e)},_isControlPanelActivated:!0,displayIntroductoryControlPreferencePanel:function(){var e=null;if(this._isControlPanelActivated&&window.widget&&window.widget.getValue("x3dPlatformId")){var t=function(){console.warn("Failure to interact with mePreference service")},i=function(){console.warn("Failure to access mePreference service")};require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(r){var n=window.widget,a=function(i){i&&i.repositories&&(i.repositories[0].preferences[0].userOverloadFlag||require(["DS/SWXCoreManipulation/xAppControlPreferencesPanel"],function(i){(new i).show().then(function(i){if(-1!=i&&e){var r=0==i?"3DEXPERIENCE":1==i?"CATIA":"SOLIDWORKS",n=e+"/api/v1/preferences";let a={onFailure:t,onComplete:function(){},method:"PUT",type:"json",data:JSON.stringify({repositories:[{name:"VisualizationRepository",preferences:[{name:"SWNavigationMode",value:r,locked:!1,datatype:"enum"}]}]})};d.authenticatedRequest(n,a)}})}))};r.getServiceUrl({serviceName:"mepreferences",platformId:n.getValue("x3dPlatformId"),onComplete:function(r){if(void 0!==r){e=r;var n=r+"/api/v1/preferences?showUserOverloadFlag=true";d.authenticatedRequest(n,{method:"POST",type:"json",data:JSON.stringify({repositories:[{name:"VisualizationRepository",preferenceNames:["SWNavigationMode"]}]}),headers:{"Content-Type":"application/json"},onComplete:a,onFailure:t})}else i()},onFailure:i})})}},_getIdPathOverrideWatcher:function(){return!this._idPathOverrideWatcher&&this.idPathMatcher&&(this._idPathOverrideWatcher=new f({viewer:this})),this._idPathOverrideWatcher},dispose:function(){this._viewPanelController&&this._viewPanelController.dispose(),c.dispose(),this._parent()}});return n.setRobotClasses(t,i,r),o.setOverrideLink2Class(l),UWA.namespace("THREEDS/WebGLV6Viewer",m)}),define("Visualization/WebGLV6Viewer",["DS/Visualization/WebGLV6Viewer","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/WebGLV6Viewer"),e}),define("DS/Visualization/CSIViewer",["DS/Visualization/WebGLV6Viewer","DS/Visualization/ViewManager","DS/SceneGraphOverrides/CSIOverrideManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/ZModeFilter"],function(e,t,i,r,n){"use strict";var a=e.extend({init:function(e){return window.newMaterialInheritance=!0,this._parent(e),this.viewManager=new t(this),this._csiViewModelManager=e&&e.CSIViewModelManager?e.CSIViewModelManager:null,this._csiOverrideManager=new i(this),this._scissorOutlineNodes=null,this},setCSIViewModelManager:function(e){this._csiViewModelManager=e},swapVisibleSpace:function(){if(e.prototype.swapVisibleSpace.call(this),!this.visibleSpace&&this._csiViewModelManager){var t=this;this._csiViewModelManager.forceSend3DNoShowData({onAnswer:function(){t.render()}})}},forceZDisplay:function(e){e&&!this.renderer.renderer._GlobalZModeFilter?(this.renderer.renderer._GlobalZModeFilter=new n(!0),this.renderer.resetGSSOCache()):!e&&this.renderer.renderer._GlobalZModeFilter&&(this.renderer.renderer._GlobalZModeFilter=null,this.renderer.resetGSSOCache())},onVisuAnswer:function(e){return this.viewManager.onVisuAnswer(e)},setStaticMaterial:function(e,t){console.warn("setStaticMaterial method is deprecated. Use setStaticLook instead."),this.viewManager.setStaticMaterial(e,t)},setStaticLook:function(e,t){this.viewManager.setStaticLook(e,t)},setDefaultMaterials:function(e){this.viewManager.setDefaultMaterials(e)},setAlternativeEditDisplay:function(e){this.viewManager.setTemporaryBodies(e)},empty:function(e,t){this._parent(e,t),this.viewManager.clear()},updatePlaneOnViewMessage:function(e){this.viewManager.updatePlaneOnViewMessage(e)},_getCSIOverrideManager:function(){return this._csiOverrideManager},getVisuContextViewMode:function(){var e=this.getVisuShadingMode();if(!e||!r.__ViewModeType__||!r.__ViewAppearanceMap__)return null;for(var t=this.getCustomMaterialModeParameters(),i={mask:r.__ViewModeType__.VIEW_APPEARANCE,appearanceName:null,shininess:t.shininess,opacity:t.opacity,color:t.color.toArray(),useObjectColor:t.colorFromGAS},n=this.renderer.renderer._defaultAppearanceType,a=Object.keys(r.__ViewAppearanceMap__),s=0;s<a.length;s++)if(r.__ViewAppearanceMap__[a[s]]===n){i.appearanceName=a[s];break}return i.appearanceName?(e.includes("Wireframe")?i.mask|=r.__ViewModeType__.VIEW_EDGE:e.includes("Illustration")?i.mask|=r.__ViewModeType__.VIEW_HRD:(i.mask|=r.__ViewModeType__.VIEW_MESH,this.getMaterialMode()&&(i.mask|=r.__ViewModeType__.VIEW_MATERIAL),e.includes("Edges")&&(i.mask|=r.__ViewModeType__.VIEW_EDGE,e.includes("NoSmoothEdges")?i.mask|=r.__ViewModeType__.VIEW_WITHOUT_SMOOTH_EDGE:e.includes("HalfSmoothEdges")&&(i.mask|=r.__ViewModeType__.VIEW_WITH_HALF_SMOOTH_EDGE),e.includes("HiddenEdges")&&(i.mask|=r.__ViewModeType__.VIEW_HIDDEN_EDGE))),this.getAxisFilter()||(i.mask|=r.__ViewModeType__.VIEW_WITHOUT_AXIS),this.getPointsFilter()||(i.mask|=r.__ViewModeType__.VIEW_WITHOUT_POINTS),this.getLinesFilter()||(i.mask|=r.__ViewModeType__.VIEW_WITHOUT_WIRES),this.getVerticesFilter()||(i.mask|=r.__ViewModeType__.VIEW_WITHOUT_VERTEX),this._getVisuOutlineMode()&&(i.mask|=r.__ViewModeType__.VIEW_OUTLINE),i):null},onVisuContextViewModeModified:function(e){if(e){var t=[];return t.push(this.onAxisFilterChange(e)),t.push(this.onPlanesFilterChange(e)),t.push(this.onLinesFilterChange(e)),t.push(this.onPointsFilterChange(e)),t.push(this.onVerticesFilterChange(e)),t.push(this.onVisuAppearanceModeChange(e)),t.push(this.onCustomMaterialModeParametersChange(e)),t.push(this._onVisuOutlineModeChange(e)),t.push(this.onVisuShadingModeChange(e)),t}},_refreshPLMViewMode:function(e){return this._csiOverrideManager.refreshPLMViewMode(e)},_updatePLMViewMode:function(e,t){return this._csiOverrideManager.updatePLMViewMode(e,t)},_setViewpointPLMViewMode:function(e,t){this._csiOverrideManager.setViewpointPLMViewMode(e,t)},_setNodePLMViewMode:function(e,t,i){this._csiOverrideManager.setNodePLMViewMode(e,t,i)},_setOutlineNode:function(e,t,i){if(t||this._scissorOutlineNodes){this._scissorOutlineNodes||(this._scissorOutlineNodes=new WeakMap);var r=this._scissorOutlineNodes.get(e);r&&e.removeChild(r),t?(i&&e.addChild(i),this._scissorOutlineNodes.set(e,i)):this._scissorOutlineNodes.delete(e)}}});return UWA.namespace("THREEDS/CSIViewer",a)}),define("DS/VisuLoaders/XMLV43Loader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","UWA/Utils","DS/Visualization/Utils","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Visualization/PathElement","DS/Visualization/SceneGraph","DS/SceneGraphNodes/AxisSystemNode","DS/Mesh/Mesh","DS/Visualization/LoaderUtils","DS/VisuLoaders/ThreeDXLoader","DS/VisuLoaders/CGRReader","DS/ZipJS2/ZipJS2","DS/ZipJS/LoaderInflate"],function(e,t,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g){"use strict";var v={TECHREP:{module:"DS/SIMAnimationWebMdl",file:"SIMAnimationRepRefUnstreamer"},CDS:{module:"DS/CATAssemblySolverWeb",file:"CATAsmWebJsonUnstreamer"}};return function(n,s){var c=!1,h=!1,u=n,S=void 0;e.supportedExtensions&&(S=!!e.supportedExtensions.elementIndexUint||void 0);var _,y,x=[],M=!1,P=null,C=void 0!==s?s:null,b=null,D=null,w=null,E=null,T=null,A=!0,I=null,R=4,L=null,O=[],N=!1,F=0,V=0,U=4,B=0,k=[],G=null,z=null,H="TESSELLATED",W=[],j=[],X=((new Date).getTime(),!1),q=!1,Z=!1,Y=!1,K=!1,J=!1,Q=!1,$=null,ee=null,te={},ie=[],re=!0,ne=!1,ae=!1,se=!1,oe=!1,le=!1,ce=[],he=!1,ue={},de={},pe=null,fe=2,me=[],ge={};function ve(e,t,i,r,n,a){if(c)if(document.implementation&&document.implementation.createDocument){var s=new XMLHttpRequest;s.overrideMimeType&&s.overrideMimeType(i),"blob"===t&&(s.responseType="blob"),"arraybuffer"===t&&(s.responseType="arraybuffer"),s.onreadystatechange=function(){if(4===s.readyState)if(0===s.status||200===s.status){if(s.response&&"blob"===s.responseType){var t=new Blob([s.response],{type:i});r(t,e,a)}s.response&&"arraybuffer"===s.responseType?r(s.response,e,a):s.responseXML?r(s.responseXML,e,a):s.responseText?r(s.responseText,e,a):(console.error("XMLV43Loader: Empty or non-existing file ("+e+")"),void 0!==n&&n(e))}else void 0!==n&&n(e)},s.open("GET",e,!0),s.send(null)}else alert("Don't know how to parse XML!"),void 0!==n&&n(e);else{var o=e.replace(/^.*[\\\/]/,""),l=P.find(o);if(l&&B<U)B++,"blob"===t?l.getBlob(i).then(function(t){if(B--,k.length>0){var i=k[0];ve(i.url,i.type,i.mime,i.cbLoad,i.cbError,i.args),k.splice(0,1)}r(t,e,a)}):"arraybuffer"===t?l.getUint8Array(i).then(function(t){if(B--,k.length>0){var i=k[0];ve(i.url,i.type,i.mime,i.cbLoad,i.cbError,i.args),k.splice(0,1)}r(t.slice().buffer,e,a)}):"xml"===t?l.getText().then(function(t){if(B--,k.length>0){var i=k[0];ve(i.url,i.type,i.mime,i.cbLoad,i.cbError,i.args),k.splice(0,1)}try{var s=(new DOMParser).parseFromString(t,"text/xml");r(s,e,a)}catch(t){void 0!==n&&n(e)}}):"string"===t&&l.getRope().then(function(t){if(B--,k.length>0){var i=k[0];ve(i.url,i.type,i.mime,i.cbLoad,i.cbError,i.args),k.splice(0,1)}r(t,e,a)});else if(B>=U)k.push({url:e,type:t,mime:i,cbLoad:r,cbError:n,args:a});else if(void 0!==n&&n(e),k.length>0){var h=k[0];k.splice(0,1),ve(h.url,h.type,h.mime,h.cbLoad,h.cbError,h.args)}}}function Se(e){if(e instanceof Object){var t="Error loading 3DXML : "+e.url+"\n";switch(e.type){case"LOAD":case"LOAD_ARCHIVE":t+="Could not load the 3DXML file.";break;case"LOAD_ENTRY":t+="Could not read Zip entries for this 3DXML.";break;case"PARSE":t+="Could not parse XML data.";break;case"REPFORMAT":t+="Rep format is not supported.";break;case"VERSION":t+="This version is not supported.";break;case"REVIEW_MISSING":t+="3DXML file does not contain any review data, only briefcase."}}t+="The model is not found, corrupted or not entirely supported.",console.warn(t)}this.abort=function(){if(x=[],V=0,null!==L){for(var e=0;e<L.length;++e)null!==L[e]&&(L[e].terminate(),L[e].onmessage=null);O=[],N=!1,L=null}I&&(I=null),ye()},this.load=function(e,t,i,r,n,a,s,o,l,u,d,f,g,v,S,y,I,R,U,B,k,z,W,j,Y){M?x.push({url:e,readyCallback:t,progressCallback:r,doneCallback:n,errorCallback:a,filterNavReps:s,refreshTime:o,readDeco:l,newInfra:u,optimizeCurvedPipes:Y,primWithBS:d,repWithBS:j,edgeTrans:f,withSG:g,withBlanking:v,sharedBuff:S,nmir:y,ssb:I,sag:R,bagUUID:W,sagInfo:U,uvrWorker:B,iapplicativeContainers:k,processText:z,repWithBS:j,optimizeCurvedPipes:Y}):(M=!0,_=e,e instanceof Object&&(_=e.serverurl?e.serverurl:"",_+=e.filename?e.filename:"",e.loaderSettings&&e.loaderSettings.uncompressed&&(c=!!e.loaderSettings.uncompressed,"3DX"!==(H=e.loaderSettings.repType?e.loaderSettings.repType:"CGR")||G||(G=new p))),re=f,ne=z,ae=S,se=y,G&&(G.setSharedBuffers(ae),G.setNoMeshInRAM(se)),b=function(e){V--,null!==E&&E({loaded:F-V,total:F});(new Date).getTime();C&&C({hack:!0,updateInfinitePlane:!0,budgeted:!!V});for(var t=0;t<ce.length;t++){var i=ce[t];if(void 0!==i){var r=i.occPath._getRenderableOccurrences();if(r.length){for(var n=0;n<r.length;n++)i.material&&(i.material.force=!0,r[n]._3dxmlMaterial=i.material,r[n].material=i.material),null!==i.visible&&(r[n].visible=i.visible,r[n]._occurrence.visible=i.visible);ce[t]=void 0}}}if(V<=0){for(t=0;t<L.length;++t)null!==L[t]&&(L[t].terminate(),L[t].onmessage=null);if(O=[],N=!1,L=null,null!==w){var a=w;ye(),a()}}},D=t,w=n,E=r,T=a,h=s,X=l,Z=d,q=Y,j=j,K=I,J=R,Q=W,U=U,A=B,function(e){if(ie=[],e)for(var t in e)ie.push(t)}(ee=k),oe=g,le=v,c?ve(e+"/CATMaterialRef.3dxml","xml","text/xml",xe,function(e){xe(null,0,!0)}):(P=new m.fs.FS).importHttpContent(e,{useXHR:!1,useRangeHeader:!1,preventHeadRequest:!0}).then(function(){ve(_+"/CATMaterialRef.3dxml","xml","text/xml",xe,function(e){ve(_+"/CATMaterialDisciplines.3dxml","xml","text/xml",xe,function(e){xe(null,0,!0)})})},a||Se))};var _e=this.load;function ye(){if(P=null,D=null,w=null,E=null,T=null,_="",F=0,V=0,B=0,k=[],H="TESSELLATED",W=[],j=[],(new Date).getTime(),z&&(z.abort(),z=null),ce=[],he=!1,ue={},de={},y="",pe=null,fe=2,me=[],ge={},M=!1,x.length){var e=x.shift();_e(e.url,e.readyCallback,e.progressCallback,e.doneCallback,e.errorCallback,e.filterNavReps,e.refreshTime,e.readDeco,e.newInfra,e.primWithBS,e.edgeTrans,e.withSG,e.withBlanking,e.sharedBuff,e.nmir,e.ssb,e.sag,e.uvrWorker,e.iapplicativeContainers,e.processText,e.bagUUID,e.repWithBS,e.optimizeCurvedPipes)}}function xe(e,t,i){if(void 0===i||!i){var r=e.firstChild;if("Model_3dxml"!==r.nodeName)return;for(var n=0;n<r.childNodes.length;n++){var a=r.childNodes[n];if("CATMaterialRef"===a.nodeName)for(var s=0;s<a.childNodes.length;s++){var o=a.childNodes[s];if("CATMatReference"===o.nodeName||"MaterialDomainInstance"===o.nodeName||"MaterialDomain"===o.nodeName){var l=o.getAttribute("id"),c=o.getAttribute("name");switch(o.nodeName){case"CATMatReference":void 0!==ue[l]?ue[l].name=c:ue[l]={name:c};break;case"MaterialDomainInstance":for(var h=0,u=0,d=0;d<o.childNodes.length;d++)"IsAggregatedBy"===(v=o.childNodes[d]).nodeName?h=v.textContent:"IsInstanceOf"===v.nodeName&&(u=v.textContent);ue[l]={parent:h,instance:u},void 0!==ue[h]?ue[h].instance=l:ue[h]={instance:l};break;case"MaterialDomain":var p,f=o.getAttribute("associatedFile"),m=o.getAttribute("format");p=f.split("urn:3DXML:"),f=p[1];var g=!0;for(d=0;d<o.childNodes.length;d++){var v,S=(v=o.childNodes[d]).textContent;if("V_MatDomain"===v.nodeName&&"RENDERING"!==S.toUpperCase()){g=!1;break}}if(!g)break;void 0!==ue[l]?(ue[l].filename=f,ue[l].format=m):ue[l]={filename:f,format:m}}}}}}ve(_+"/CATRepImage.3dxml","xml","text/xml",Me,function(e){ve(_+"/PLMDmtDocument.3dxml","xml","text/xml",Me,function(e){Me(null,0,!0)})})}function Me(e,t,i){if(void 0===i||!i){var r=e.firstChild;if("Model_3dxml"!==r.nodeName)return;for(var n=0;n<r.childNodes.length;n++){var a=r.childNodes[n];if("CATRepImage"===a.nodeName)for(var s=0;s<a.childNodes.length;s++){var o=a.childNodes[s];if("CATRepresentationImage"===o.nodeName){var l=o.getAttribute("id"),c=(o.getAttribute("name"),o.getAttribute("format"),o.getAttribute("associatedFile").split("urn:3DXML:"));de[l]={filename:c[1],buffer:null}}}}}var h=0;for(var u in de)de.hasOwnProperty(u)&&h++;Ce(h?h-1:0)}function Pe(e,t){var i=0,r=null;for(var n in e)if(e.hasOwnProperty(n)){if(i===t){r=n;break}i++}return r}function Ce(e){if(-1!==e){var t,i=Pe(de,e);if(void 0===de[i]||void 0===de[i].filename||""===de[i].filename)Ce(e-1);else{var r=/(?:\.([^.]+))?$/.exec(de[i].filename)[1],n="image/";"jpg"===r&&(r="jpeg"),n+=r;var a="blob";"dds"===r&&(n="application/octet-stream",a="arraybuffer"),ve(_+"/"+de[i].filename,a,n,be,(t=e,function(){Ce(t-1)}),e)}}else{var s=0;for(var o in ue)ue.hasOwnProperty(o)&&s++;De(s?s-1:0)}}function be(e,t,i){var r=Pe(de,i);de[r].buffer=e,Ce(i-1)}function De(e){if(-1!==e){var t=Pe(ue,e);void 0===ue[t]||void 0===ue[t].filename?De(e-1):"UVR"!==ue[t].format?ve(_+"/"+ue[t].filename,"xml","text/xml",we,function(){},e):De(e-1)}else ve(_+"/Manifest.xml","xml","text/xml",Ee)}function we(e,t,i){var r={shading:"Phong",DiffuseMapWrap:[],DiffuseMapRepeat:[0,0]},n=e.firstChild;if("Osm"===n.nodeName){for(var a=0;a<n.childNodes.length;a++){var s=n.childNodes[a],o="Feature"===s.nodeName&&s.getAttribute("Alias");if(o&&-1!==o.indexOf("RenderingFeature"))for(var l=0;l<s.childNodes.length;l++){var c=s.childNodes[l];if("Attr"===c.nodeName){var h=c.getAttribute("Type"),u=c.getAttribute("Value"),d=c.getAttribute("Name");switch(h){case"int":switch(u=parseInt(u,10),r[d]=u,d){case"WrappingModeU":u&&(r.DiffuseMapWrap[0]="repeat",r.DiffuseMapRepeat[0]=1);break;case"WrappingModeV":u&&(r.DiffuseMapWrap[1]="repeat",r.DiffuseMapRepeat[1]=1);break;case"PreviewType":switch(parseInt(u)){case 0:r.mappingFunction="SPHERICAL_ENV_MAP";break;case 2:r.mappingFunction="USER_MAPPING"}}break;case"double":switch(d){case"DiffuseColor":r.colorDiffuse=Fe(u);break;case"SpecularColor":r.colorSpecular=Fe(u);break;case"AmbientColor":r.colorAmbient=Fe(u);break;case"SpecularExponent":r.shininess=128*parseFloat(u);break;case"SpecularCoef":r.specularCoef=parseFloat(u);break;case"Reflectivity":r.reflectivityCoef=parseFloat(u);break;case"Transparency":r.transparency=parseFloat(u),r.transparent=r.transparency>0}break;case"boolean":switch(u="true"===u,d){case"AlphaTest":r.alphaTest=u?.5:0;break;default:r[d]=u}break;case"external":var p=[];p=u.split("urn:3DXML:"),p=(u=p[1]).split("#"),u=p[0];var f=p[1];"TextureImage"===d&&de[f]&&de[f].buffer&&(r.DiffuseMap=de[f])}}}}if(void 0!==i){var m=Pe(ue,i);void 0===ue[m]&&(ue[m]={}),r.type="material3DXML",ue[m].params=r}De(i-1)}else De(i-1)}function Ee(e,t){var i=e.firstChild;if(i&&i.childNodes)for(var r=0;r<i.childNodes.length;r++){var n=i.childNodes[r];switch(n.nodeName){case"Root":y=n.textContent}}ve(_+"/"+y,"xml","text/xml",Te,function(e){var t=T||Se;t&&t({url:e,type:"REVIEW_MISSING"})})}function Te(n,s){var o=n.firstChild;if(o&&"Model_3dxml"===o.nodeName){for(var l=0;l<o.childNodes.length;l++)if("Header"!==(ie=o.childNodes[l]).nodeName){if("ProductStructure"===ie.nodeName){var c=ie.getAttribute("root");for(q=0;q<ie.childNodes.length;q++)if("Reference3D"===(de=ie.childNodes[q]).nodeName||"Instance3D"===de.nodeName||"ReferenceRep"===de.nodeName||"InstanceRep"===de.nodeName){var u=de.getAttribute("id"),p=de.getAttribute("name"),f=new a;switch(de.nodeName){case"Reference3D":void 0===me[u]?me[u]=f:f=me[u];var m=c===u&&null===pe;m&&(pe=f);for(var g=0;g<de.childNodes.length;g++){var S=de.childNodes[g];if(m&&"Extension"===S.nodeName)for(var y=0;y<S.childNodes.length;y++){var x=S.childNodes[y];"V_WorldOrientation"===x.nodeName&&(fe=parseInt(x.textContent,10))}else"V_Name"===S.nodeName&&(p=S.textContent)}break;case"Instance3D":case"InstanceRep":me[u]=f;var M="",P="",b=null;for(g=0;g<de.childNodes.length;g++)if("IsAggregatedBy"===(S=de.childNodes[g]).nodeName)M=S.textContent;else if("IsInstanceOf"===S.nodeName)P=S.textContent;else if("RelativeMatrix"===S.nodeName){var U=Ue(S.textContent);null===b&&(b=new e.Matrix4),b.set(U[0],U[3],U[6],U[9],U[1],U[4],U[7],U[10],U[2],U[5],U[8],U[11],0,0,0,1)}else"V_Name"===S.nodeName&&(p=S.textContent);null!==b&&(f._matrix=b),""!==M&&""!==P&&(void 0===me[M]&&(me[M]=new a),me[M].addChild(f),void 0===me[P]&&(me[P]=new a),f.addChild(me[P]));break;case"ReferenceRep":for(void 0===me[u]?me[u]=f:f=me[u],g=0;g<de.childNodes.length;g++)"V_Name"===(S=de.childNodes[g]).nodeName&&(p=S.textContent);P="";var B,k=de.getAttribute("format");k&&"string"==typeof k&&(B=k.toUpperCase());var G,z=de.getAttribute("associatedFile");"UVR"!==B&&"TESSELLATED"!==B||("3DX"===H?k="3DX":"CGR"===H?k="CGR":(k=B,H=B)),G=z.split("urn:3DXML:");var X={file:z=G[1],format:k,node:f};void 0!==W[z]?W[z].push(f):(W[z]=[f],"ifc"!==r.getExtension(z)&&j.push(X)),ge[f.id]=X}f.name=p,f.productType=de.nodeName,f.persistentId=u,f.getPersistentId=function(){return this.persistentId}}}}else for(var q=0;q<ie.childNodes.length;q++)if("SchemaVersion"===(de=ie.childNodes[q]).nodeName&&de.textContent.substring(0,1)<4){var K=T||Se;return void(K&&K({url:s,type:"VERSION"}))}for(l=0;l<o.childNodes.length;l++)if("DefaultView"===(ie=o.childNodes[l]).nodeName)for(q=0;q<ie.childNodes.length;q++)"DefaultViewProperty"===(de=ie.childNodes[q]).nodeName&&Ae(de);for(l=0;l<o.childNodes.length;l++){var ie;if("CATMaterial"===(ie=o.childNodes[l]).nodeName)for(q=0;q<ie.childNodes.length;q++){var de;"CATMatConnection"===(de=ie.childNodes[q]).nodeName&&Ie(de)}}}if(h&&pe&&pe.traverse(function(e,t){var i=t.indexOf(e);if(-1!==i){t.splice(i,1),"ReferenceRep"===e.productType&&ge[e.id]&&(console.log(ge[e.id]),-1!==(i=j.indexOf(ge[e.id]))&&j.splice(i,1));for(var r=0;r<e.children.length;r++)t.push(e.children[r]);return!1}if("Reference3D"===e.productType){var n=[],a=!1;for(r=0;r<e.children.length;r++){var s=e.children[r];a=a||"Instance3D"===s.productType,"InstanceRep"===s.productType&&n.push(s)}if(a)for(r=0;r<n.length;r++)t.push(n[r])}return!1},new Array),ve(_+"/ProductCDS.json","string","text/string",function(e,t){var i=v.CDS.module+"/"+v.CDS.file;require([i],function(t){var i=new t;i.unstream(e)},function(e){var i=e.requireModules&&e.requireModules[0];console.log("Module "+i+" is missing.");var r=T||Se;r&&r({url:t,type:"LOAD_ENTRY"})})},function(){}),j.length)!function(){if(he){for(var e=0;e<ce.length;e++){var n=ce[e];if(void 0!==n&&n.matrix){var a=n.occPath._getOccurrences();if(a.length)for(var s=0;s<a.length;s++)a[s]._relativeMatrix=n.matrix}}pe&&pe._updateMatrix()}if("3DX"!==H){if(null!==L){for(var e=0;e<R;++e)L[e].terminate();L[e].onmessage=null}L=null,O=[],N=!1;var o="";if(A||"TESSELLATED"===H)if(null===L){var l=i.matchUrl(t.getWebappsBaseUrl(),window.location)?null:"Passport",c=[],h={provider:"FILE",filename:"AmdLoader.js",serverurl:t.getWebappsBaseUrl()+"AmdLoader/",module:"AmdLoader",requiredAuth:l},u={provider:"FILE",filename:"EasySax.js",serverurl:t.getWebappsBaseUrl()+"EasySax/",module:"EasySax",requiredAuth:l},p={provider:"FILE",filename:"ThreeJS_Base.js",serverurl:t.getWebappsBaseUrl()+"Mesh/",module:"Mesh",requiredAuth:l},f={provider:"FILE",filename:"Mesh.js",serverurl:t.getWebappsBaseUrl()+"Mesh/",module:"Mesh",requiredAuth:l},m={provider:"FILE",filename:"CGRFile.js",serverurl:t.getWebappsBaseUrl()+"Formats/",module:"Formats",requiredAuth:l};"UVR"===H||"CGR"===H?(o={provider:"FILE",filename:"CGRWorkerNewInfra.js",serverurl:t.getWebappsBaseUrl()+"Workers/",module:"Workers",requiredAuth:l},(c=[h,p,f,m,o]).realWorkerUrl=t.getWebappsBaseUrl()+"Workers/CGRWorkerNewInfra.js"):"TESSELLATED"===H&&(o={provider:"FILE",filename:"XMLV43Worker.js",serverurl:t.getWebappsBaseUrl()+"Workers/",module:"Workers",requiredAuth:l},(c=[h,u,p,f,o]).realWorkerUrl=t.getWebappsBaseUrl()+"Workers/XMLV43Worker.js"),r.getWorkerBlobFromSpecs(c,function(e){L=[];for(var t={processText:ne,edgeTransparency:re,sharedBuffers:ae,noMeshInRAM:se,primitiveWithBS:Z,withBlanking:le,repWithBS:Y,withSAG:J,sagInfo:$,withBagUUID:Q},i=0;i<R;++i)L[i]=new Worker(e);for(var i=0;i<R;++i)!function(e){L[e].onmessage=function(i){var r=i.data;if(r.loaded)O.push(e),N||(N=!0,Ne(D));else{var n=W[r.node];V--,r.CGR&&(t.fromCGR=!0),d.processData(n,r,{materialLibrary:ue,baseUrl:_},oe,t,function(e){r.applicativesContainers&&Le(r.applicativesContainers,ee,n),null!==E&&E({loaded:F-V,total:F});(new Date).getTime();C&&C({hack:!0,updateInfinitePlane:!0,budgeted:!!V});for(var t=0;t<ce.length;t++){var i=ce[t];if(void 0!==i){var a=i.occPath._getRenderableOccurrences();if(a.length){for(var s=0;s<a.length;s++)i.material&&(i.material.force||(i.material.force=!0),a[s]._3dxmlMaterial=i.material,a[s].material=i.material),null!==i.visible&&(a[s].visible=i.visible,a[s]._occurrence.visible=i.visible);ce[t]=void 0}}}if(V<=0){if(null!==L)for(var t=0;t<L.length;++t)null!==L[t]&&(L[t].terminate(),L[t].onmessage=null);if(I&&(I=null),O=[],N=!1,L=null,null!==w){var o=w;if(ye(),o(),ee)for(var l in ee)ee[l].doneCallback&&(te&&te[l]&&ee[l].doneCallback?ee[l].doneCallback(te[l]):ee[l].doneCallback([]))}}})}}}(i)})}else N&&Ne(D);else I?Ne(D):require(["DS/Formats/CGRFile"],function(e){I=e,Ne(D)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),T&&T()})}else Ne(D)}();else{var _e=w;ye(),_e()}}function Ae(t){for(var i=[],r=!0,n=!1,a=null,s=null,c=new e.Color,h=1,u=0;u<t.childNodes.length;u++){var d=t.childNodes[u];if("OccurenceId"===d.nodeName){for(var p=0;p<d.childNodes.length;p++)if("id"===(g=d.childNodes[p]).nodeName){var f="",m=[];(m=(f=(m=g.textContent.split("urn:3DXML:"))[1]).split("#"))[0],f=m[1],void 0===me[f]||0!==i.length&&me[f]===i[i.length-1]||i.push(me[f])}}else if("GraphicProperties"===d.nodeName)for(p=0;p<d.childNodes.length;p++){var g;if("SurfaceAttributes"===(g=d.childNodes[p]).nodeName)for(var v=0;v<g.childNodes.length;v++){var S=g.childNodes[v];if("Color"===S.nodeName&&(n=!0,c.r=parseFloat(S.getAttribute("red")),c.g=parseFloat(S.getAttribute("green")),c.b=parseFloat(S.getAttribute("blue")),S.getAttribute("alpha")&&(h=parseFloat(S.getAttribute("alpha"))),-1===c.r))return}else"GeneralAttributes"===g.nodeName&&g.getAttribute("visible")&&(r="true"===g.getAttribute("visible"))}else if("RelativePosition"===d.nodeName){var _=Ue(d.textContent);(s=new e.Matrix4).set(_[0],_[3],_[6],_[9],_[1],_[4],_[7],_[10],_[2],_[5],_[8],_[11],0,0,0,1)}}n&&((a=(new o).getMaterialFromGAS({color:c,opacity:h})).force="forceGeomTypeFACE");for(var y=i.length>0,x=[],M=i.length-1;y&&0!==M;){for(var P=i[M],C=i[M-1];P!==C;){x.unshift(P);var b=P.getParents();if(b.length>1||0===b.length){y=!1;break}P=b[0]}M--}y&&(x.unshift(i[0]),ce.push({occPath:new l(x),material:a,matrix:s,visible:r})),s&&(he=!0)}function Ie(e){e.getAttribute("id"),e.getAttribute("name");for(var t="",i=[],r=null,n=0;n<e.childNodes.length;n++){var a=e.childNodes[n];if("IsAggregatedBy"===a.nodeName)a.textContent;else if("PLMRelation"===a.nodeName)for(var s=0;s<a.childNodes.length;s++){var o=a.childNodes[s];if("C_Role"===o.nodeName)t=o.textContent;else if("Ids"===o.nodeName)for(var c=0;c<o.childNodes.length;c++){var h=o.childNodes[c];if("id"===h.nodeName)if("CATMaterialMadeOfLink"===t||"CATMaterialDressByLink"===t)void 0===me[h.textContent]||0!==i.length&&me[h.textContent]===i[i.length-1]||(i.push(me[h.textContent]),void 0!==me[h.textContent].children[0]&&i.push(me[h.textContent].children[0]));else if("CATMaterialToReferenceLink"===t){var u=[],d=(u=h.textContent.split("urn:3DXML:"))[1];r={file:(u=d.split("#"))[0],id:d=u[1]}}}}}null!==r&&ce.push({occPath:new l(i),material:Ve(r.id),visible:null})}var Re=function(e){var t,i,r,n,a,s;for(t="",r=e.length,i=0;i<r;)switch((n=e[i++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(n);break;case 12:case 13:a=e[i++],t+=String.fromCharCode((31&n)<<6|63&a);break;case 14:a=e[i++],s=e[i++],t+=String.fromCharCode((15&n)<<12|(63&a)<<6|(63&s)<<0)}return t},Le=function(e,t,i){if(t&&e)for(var r in t){var n=t[r].errorCallback,a=t[r].binaryOutput;if(e[r]){var s=e[r];if(a){te[r]||(te[r]=[]);for(var o=0;o<i.length;o++)te[r].push({node:i[o],data:s})}else{if(!s){n(),delete t[r];continue}var l=s.buffer.subarray(s.options.offset,s.options.compressed+s.options.offset);if(l.length<=2){n(),delete t[r];continue}if(120!==l[0]){n(),delete t[r];continue}if(218!==l[1]){n(),delete t[r];continue}var c=l.subarray(2,s.options.compressed),h=(new g).Inflate(c),u=Re(h);for(te[r]||(te[r]=[]),o=0;o<i.length;o++)te[r].push({node:i[o],xml:u})}}}};function Oe(){if(V--,E&&E({loaded:F-V,total:F}),0===V){if(null!==L){for(var e=0;e<L.length;++e)null!==L[e]&&(L[e].terminate(),L[e].onmessage=null);O=[],N=!1,L=null}if(I&&(I=null),w){var t=w;if(ye(),t(),ee)for(var i in ee)ee[i].doneCallback&&(te&&te[i]&&ee[i].doneCallback?ee[i].doneCallback(te[i]):ee[i].doneCallback([]))}}}function Ne(e){V=j.length,F=V;for(var t=0;t<j.length;t++){var i=j[t],r=i.file,n=i.format,s=i.node;if(void 0!==r){var o=_+"/"+r,l=o,h=W[r];if(""!==r)if("3DX"===n)l+=".3dxc",G.load({url:l,concat:!0,zipped:!1,primitives:!0,reps:!0,ssb:!1,destinationNodes:h,readyCallback:function(e){V--,null!==E&&E({loaded:F-V,total:F});(new Date).getTime();if(C&&C({hack:!0,updateInfinitePlane:!0,budgeted:!!V}),V<=0&&null!==w){var t=w;ye(),t()}},gasSharing:!0});else if(!A&&I&&"UVR"===n)!function(e,t){ve(o,"arraybuffer","text/plain",function(t){var i={processText:ne,fromCGR:!0,edgeTransparency:re,sharedBuffers:ae,noMeshInRAM:se,primitiveWithBS:Z,withBlanking:le,repWithBS:Y,withSAG:J,sagInfo:$,withBagUUID:Q},r=new Uint8Array(t),n=new I([],!1,Z,oe,S,K,J,ne,$,Q,Y,q,le);n.setFileBuffer(r);var a=n.open(),s=W[e];V--,d.processData(s,a,{materialLibrary:ue,baseUrl:_},void 0,i)})}(r);else if(L)switch(n){case"UVR":case"CGR":"CGR"===n&&(l=l.replace(".3DRep",".cgr"));var p={renderCallback:null,readyCallback:b,doneCallback:null,errorCallback:function(){Oe(),T()},progressCallback:E};if(c){z||(z=new f(u,null,{keepLoader:!0}));var m={isBuffer:!1,destination:h[0],readDeco:X,optimizeCurvedPipes:q,primWithBS:Z,withBlanking:le,repWithBS:Y,smartStaticBatching:K,withSAG:J,withBagUUID:Q,sagInfo:$,edgeTransparency:re,sharedBuffers:ae,noMeshInRAM:se,withSceneGraph:oe};z.load({serverurl:l},p,m)}else!function(e,t){ve(o,"arraybuffer","text/plain",function(i,r){var n=O[t%O.length];L&&L[n].postMessage({inputFile:i,node:e,readDecoration:X,primitiveWithBS:Z,withBlanking:le,repWithBS:Y,smartStaticBatching:K,withSAG:J,withBagUUID:Q,sagInfo:$,applicativesContainers:ie,withSceneGraph:oe,uint32Index:S,processText:ne,uvr:!0,optimizeCurvedPipes:q},[i])})}(r,t);break;case"TESSELLATED":!function(e,t){ve(o,"string","text/plain",function(i,r){var n=O[t%O.length];L&&L[n].postMessage({path:i,node:e,uint32Index:S})},function(e){var t=T||Se;Oe(),t&&t({url:e,type:"LOAD_ENTRY"})})}(r,t);break;default:v[n]?function(e,t,i){ve(o,"xml","text/xml",function(r,n){var a=v[t].module+"/"+v[t].file;require([a],function(t){(new t).unstream(r,e,i),Oe()},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing.");var i=T||Se;Oe(),i&&i({url:n,type:"REPFORMAT"})})},function(e){var t=T||Se;Oe(),t&&t({url:e,type:"REPFORMAT"})})}(r,n,s):Oe()}else Oe()}}e&&(null===pe&&(pe=new a),e(pe,fe))}function Fe(e){var t=[],i=new RegExp(/\[([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?)),([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?)),([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?))\]/),r=i.exec(e);return null!==r?(t[0]=parseFloat(RegExp.$1),t[1]=parseFloat(RegExp.$2),t[2]=parseFloat(RegExp.$3)):null!==(r=(i=new RegExp(/\[([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?)),([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?)),([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?)),([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?))\]/)).exec(e))&&(t[0]=parseFloat(RegExp.$1),t[1]=parseFloat(RegExp.$2),t[2]=parseFloat(RegExp.$3),t[3]=parseFloat(RegExp.$4)),t}function Ve(t){var i=new o,r=ue[t];if(void 0===r)return null;var n=ue[r.instance];if(void 0===n)return null;var a=ue[n.instance];return void 0===a?null:(void 0===a.material&&void 0!==a.params?(a.material=i.getMaterial3DXML(a.params,_,"XMLV43"),a.material.force=!0):void 0===a.params&&(a.material=e.MaterialUtils.createMatteFaceMaterial(),a.material.force=!0),a.material)}function Ue(e){for(var t=function(e){return e.length>0?function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}(e).split(/\s+/):[]}(e),i=[],r=0,n=t.length;r<n;r++)i.push(parseFloat(t[r]));return i}}}),define("DS/Visualization/CGRReader",["DS/VisuLoaders/CGRReader"],function(e){"use strict";return e}),define("Visualization/CGRReader",["DS/Visualization/CGRReader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/CGRReader"),e}),define("DS/SceneGraphNodes/DiskLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var r=new e.DiskLight(t.color,t.intensity,t.radius,t.mode);return this._radius=r.radius,this._parent(r,i),this},setRadius:function(e){e&&(this._radius=e),this._updateRadius()},_updateRadius:function(){var e;this.light3js.radius=this._radius,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.radius=this._radius},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"DiskLightNode3D"}});return UWA.namespace("THREEDS/Nodes/DiskLightNode",i)}),define("SceneGraphNodes/DiskLightNode",["DS/SceneGraphNodes/DiskLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/DiskLightNode"),e}),define("DS/Visualization/ParticlesNode3D",["DS/Mesh/Mesh","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t,i){"use strict";var r=i.extend({init:function(e,i){this._parent(i);var r=e.material?e.material:null;t.disableJHGDev||(this.material=r),this.particles3js=void 0!==e?e:new t.ParticleSystem;var n=t.convertParticleSystemToBufferGeometryDS(this.particles3js.geometry);this.particles3js=new t.Mesh(n,r),this.particles3js.frustumCulled=!1,e=this.createRenderable();var a=this._occurrences[0];return a.renderable=e,a.renderable.name=this.name,a.renderable._occurrence=a,this.hasExplicitBE=!0,this.explicitBSphere=null,this.explicitBBox=null,void 0!==this.particles3js.geometry.boundingSphere&&(this.explicitBSphere=this.particles3js.geometry.boundingSphere.clone()),this},createRenderable:function(){var e=this.particles3js.clone();return e.matrixAutoUpdate=!1,e.matrixWorldNeedsUpdate=!1,e.visible=this.particles3js.visible,e.pickable=this.particles3js.pickable,e.noPickThrough=this.particles3js.noPickThrough,e.renderDepth=this.particles3js.renderDepth,e.frustumCulled=this.particles3js.frustumCulled,e.enableNormalDepth=!1,e},add:function(){return!1},setPickable:function(t){var i,r;for("boolean"==typeof t&&console.log("boolean is DEPRECATED in setPickable() method.\n Use ENUM Mesh"),null!==this.particles3js&&(this.particles3js.pickable=t===e.PICKABLE,this.particles3js.noPickThrough=t!==e.PICKTHROUGH),i=0;i<this._occurrences.length;i++)null!==(r=this._occurrences[i]).renderable&&(r.renderable.pickable=this.particles3js.pickable,r.renderable.noPickThrough=this.particles3js.noPickThrough,r.renderable._flagAsGSSOInvalidated())},getNodeType:function(){return"ParticlesNode3D"}});return UWA.namespace("THREEDS/Nodes/Particles",r)}),define("Visualization/ParticlesNode3D",["DS/Visualization/ParticlesNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/ParticlesNode3D"),e}),define("DS/Visualization/XMLV43Loader",["DS/VisuLoaders/XMLV43Loader"],function(e){"use strict";return e}),define("Visualization/XMLV43Loader",["DS/Visualization/XMLV43Loader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/XMLV43Loader"),e}),define("DS/VisuUnstreamers/CGRUnstreamTask",["UWA/Class","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/VisuLoaders/CGRReader"],function(e,t,i,r){"use strict";var n=null,a=0,s=[],o=[],l=e.extend({init:function(e,t){return this.streamObject=e,this.targetNode=t,this.contextID=a++,s[this.contextID]={so:this.streamObject,target:this.targetNode},this},run:function(e,t,i,a){s[this.contextID].cbProgress=e,s[this.contextID].cbError=i,s[this.contextID].cbDone=t,s[this.contextID].options=a,s[this.contextID].modelLoaded=!1;if(this.targetNode){o[this.contextID]={launched:!1},null===n&&(n=new r),n&&this.internalLoad()}else console.error("CGRUnstreamTask execution failed : target node undefined !")},internalLoad:function(){for(var e in o)!1===o[e].launched&&(o[e].launched=!0,this.loadCGR(e))},loadCGR:function(e){var t=s[e].so,i=s[e].options;i.isBuffer=!0;var r={readyCallback:s[this.contextID].cbProgress,errorCallback:s[this.contextID].cbError,doneCallback:s[this.contextID].cbDone};t.open(),t.readAsArrayBuffer(function(e){n.load(e,r,i)})}});return UWA.namespace("THREEDS/CGRUnstreamTask",l)}),define("VisuUnstreamers/CGRUnstreamTask",["DS/VisuUnstreamers/CGRUnstreamTask","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("VisuUnstreamers/CGRUnstreamTask"),e}),define("DS/VisuLoaders/StreamVisuLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager"],function(e,t,i,r,n,a){"use strict";return function(a){performance.now();this.modelsToLoad={},this.loadIndex=0;var s=e.MaterialUtils.createShinyFaceMaterial({side:e.DoubleSide,color:new e.Color(16777215)}),o=new e.MeshBasicMaterial({color:new e.Color(16777215)}),l={};this.createTextures=function(i,r){var n;for(n in i){var a=i[n],s=null;if(r.imagesCallback)s=r.imagesCallback(a,r);else{var o=a.format;o||(o=t.getExtension(a.path)),(s="hdr"===o?e.ImageUtils.loadHDRTexture(r.path+a.path+r.urlOptions):"dds"===o?e.ImageUtils.loadCompressedTexture(r.path+a.path+r.urlOptions,void 0,null,null,!1):e.ImageUtils.loadTexture2(r.path+a.path+r.urlOptions)).wrapS=a.wrapS||1e3,s.wrapT=a.wrapT||1e3,s.anisotropy=a.anisotropy||8,s.minFilter=a.minFilter||1008,s.magFilter=a.magFilter||1006,s.repeat=a.repeat||{x:1,y:1},s.sRGB="jpg"===o||"jpeg"===o}r.data.textures[a.id]=s}},this.createMaterials=function(t,i,r){var n;for(n in t){var a=t[n],s=null;if(r.materialsCallback)s=r.materialsCallback(a,r);else{var o={visible:a.visible,force:a.force,side:a.side,enableClipPlanes:a.enableClipPlanes,transparent:a.transparent,opacity:a.opacity,depthTest:a.depthTest,depthWrite:a.depthWrite};a.forceSide&&(o.forceSide=a.forceSide),void 0!==a.NRECompatibility&&(o.NRECompatibility=a.NRECompatibility),a.needTangentBinormal&&(o.needTangentBinormal=a.needTangentBinormal),a.alphaTest&&(o.alphaTest=a.alphaTest),a.color&&(o.color=(new e.Color).setRGB(a.color.r,a.color.g,a.color.b)),a.ambient&&(o.ambient=(new e.Color).setRGB(a.ambient.r,a.ambient.g,a.ambient.b)),a.emissive&&(o.emissive=(new e.Color).setRGB(a.emissive.r,a.emissive.g,a.emissive.b)),a.specular&&(o.specular=(new e.Color).setRGB(a.specular.r,a.specular.g,a.specular.b)),a.shininess&&(o.shininess=a.shininess),a.vertexColors&&(o.vertexColors=a.vertexColors),void 0!==a.diffuseMap&&(o.map=i.textures[a.diffuseMap]),void 0!==a.opacityMap&&(o.opacityMap=i.textures[a.opacityMap],o.transparent=!0),void 0!==a.normalMap&&(o.normalMap=i.textures[a.normalMap],o.needTangentBinormal=!0,void 0!==a.needTangentBinormal&&(o.needTangentBinormal=a.needTangentBinormal)),void 0!==a.normalMapScale&&(o.normalScale=new e.Vector2(a.normalMapScale.x,a.normalMapScale.y)),void 0!==a.normalMapFlipY&&(o.normalMapFlipY=a.normalMapFlipY),void 0!==a.bumpMap&&(o.bumpMap=i.textures[a.bumpMap]),void 0!==a.bumpScale&&(o.bumpScale=a.bumpScale),void 0!==a.glossiness&&(o.glossiness=a.glossiness),void 0!==a.glossinessMap&&(o.glossinessMap=i.textures[a.glossinessMap]),void 0!==a.roughnessMap&&(o.roughnessMap=i.textures[a.roughnessMap]),void 0!==a.specularMap&&(o.specularMap=i.textures[a.specularMap]),void 0!==a.specularMap&&(o.specularMap=i.textures[a.specularMap],o.specularMapLinear=!o.specularMap.sRGB),"Physical"==a.type&&(void 0!==a.emissiveMap&&(o.emissiveMap=i.textures[a.emissiveMap]),void 0!==a.metalnessMap&&(void 0===a.metalness&&(a.metalness=1),o.metalnessMap=i.textures[a.metalnessMap]),void 0!==a.metalness&&(o.metalness=a.metalness),void 0!==a.coating&&(o.coating=a.coating),void 0!==a.coatingGlossiness&&(o.coatingGlossiness=a.coatingGlossiness)),void 0!==a.iterative&&(o.iterative=a.iterative),void 0!==a.sslr&&(o.sslr=a.sslr),s=new e[a.type+"Material"](o)}i.materials[a.id]=s}},this.createGeometries=function(t,r){var n,a=r.data;for(n in t){var l=t[n],c=new e.BufferGeometryDS;for(var h in a.geometries[l.id]=c,l){var u=l[h];"vertexPositionArray"!==h&&"vertexIndexArray"!==h&&"vertexColorArray"!==h&&"vertexNormalArray"!==h&&"vertexBinormalArray"!==h&&"vertexTangentArray"!==h&&"vertexUvArray"!==h&&"vertexUv2Array"!==h||null===u||("vertexIndexArray"===h?4===u.bpe?c[h]=new Uint32Array(a.chunks[u.chunk],u.offset,u.byteLength/u.bpe):c[h]=new Uint16Array(a.chunks[u.chunk],u.offset,u.byteLength/u.bpe):c[h]=new Float32Array(a.chunks[u.chunk],u.offset,u.byteLength/u.bpe))}for(var d=0;d<l.dgs.length;d++){var p=l.dgs[d],f=p.primitives;f=new Uint32Array(a.chunks[f.chunk],f.offset,f.byteLength/f.bpe);var m=p.canonicals,g=null!=m,v=null;g&&(v=new Uint8Array(a.chunks[m.chunk],m.offset,m.byteLength/m.bpe));var S=0,_=c.vertexNormalArray?s:o,y=[];void 0!==p.gas&&a.materials[p.gas]&&(_=a.materials[p.gas]);var x=new i.DrawingGroup(_,null,p.glType,p.start,p.count,y,void 0,e.GeomTypeEnum[p.geomType],0);x.geometry=c,c.drawingGroups.push(x);for(var M=0;M<f.length;M+=4){var P=new i.SGPrimitive({cgmId:f[M],group:x,start:f[M+2],count:f[M+3]});if(r.unstreamReps){var C=f[M+1],b=a.reps[C];b||(b=new i.SGRep({cgmId:C}),a.reps[C]=b),P.rep=b,b.primitives.push(P)}if(g){var D=v[S++];if(D){P.decoration=new Array;for(var w=0;w<D;++w)P.decoration.push(v[S++])}}y.push(P)}}}},this.createNodes=function(t,i){var a,c=i.data;for(a in t){var h,u=null;if("Node3D"===(h=t[a]).type)u=new r,l[u.id]=h.children;else{var d=h.mesh3js.bs.c,p=h.mesh3js.bs.r,f=h.mesh3js.bbox.min,m=h.mesh3js.bbox.max,g=new e.Box3(new e.Vector3(f[0],f[1],f[2]),new e.Vector3(m[0],m[1],m[2])),v=new e.Sphere(new e.Vector3(d[0],d[1],d[2]),p),S=[];S.boundingSphere=v,S.boundingBox=g;for(var _=0;_<h.mesh3js.geometries.length;_++)S.push(c.geometries[h.mesh3js.geometries[_]]);var y=S.length&&S[0].vertexNormalArray?s:o;void 0!==h.mesh3js.material&&(y=c.materials[h.mesh3js.material]);var x=new e.Mesh(S,y);x.castShadow=void 0===h.mesh3js.castShadow||h.mesh3js.castShadow,x.receiveShadow=void 0===h.mesh3js.receiveShadow||h.mesh3js.receiveShadow,x.enableNormalDepth=void 0===h.mesh3js.enableNormalDepth||h.mesh3js.enableNormalDepth,u=new n(x)}if(u.name=h.id,void 0!==h.material&&u.setMaterial(c.materials[h.material]),c.nodes[h.id]=u,c.root||(c.root=u),h.matrix){var M=(new e.Matrix4).setFromArray(h.matrix);u.setMatrix(M)}i.nodeCallback&&i.nodeCallback(h,i,u)}},this.createLayers=function(t,i){var r=i.data;for(var n in r.nodes){var a=r.nodes[n],s=t[n];for(var o in s.occurrences){var l=s.occurrences[o].index,c=s.occurrences[o];if(c.layers.length){a._occurrences[l].renderable.layer=new e.BufferLayer(a._occurrences[l].renderable);for(var h=0;h<c.layers.length;h++){var u=c.layers[h],d=r.geometries[u.geometry],p=new e.DrawableInterval(u.drawableInterval.layerNum,u.drawableInterval.start,u.drawableInterval.count,r.materials[u.drawableInterval.material]);p.primitiveStart=u.drawableInterval.primitiveStart,p.primitiveCount=u.drawableInterval.primitiveCount;var f=new e.LayerInterval(d,d.drawingGroups[u.drawableGroup],p);a._occurrences[l].renderable.layer.addLayerInterval(f)}}}}},this.processJSON=function(e){e.data.nbChunks=e.json.nbChunks;var t=e.json.zbin?"zbin":"bin";e.data.chunks.length?this.processChunks(e):this.getChunks(e.data.nbChunks,e,this.processChunks,t)},this.processChunks=function(e){performance.now();var t=e.json;for(var i in this.createTextures(t.textures,e),this.createMaterials(t.materials,e.data,e),this.createGeometries(t.geometries,e),this.createNodes(t.nodes,e),performance.now(),e.data.nodes){var r=e.data.nodes[i],n=l[r.id];if(n)for(var a=0;a<n.length;a++)r.add(e.data.nodes[n[a]]);l[r.id]=null}e.unstreamLayers&&this.createLayers(t.nodes,e),performance.now(),e.destinationNode.add(e.data.root),e.doneCallback&&e.doneCallback(),e.readyCallback&&e.readyCallback(),delete this.modelsToLoad[e.loadIndex]},this.internalLoad=function(e){var t=this,i=this.modelsToLoad[e];performance.now(),i.json?this.processJSON(i):UWA.Ajax.request(i.url+".json"+i.urlOptions,{async:!0,cors:!0,withCredentials:!0,onComplete:function(e){performance.now(),i.json=JSON.parse(e),t.processJSON(i)}})},this.getChunks=function(e,t,i,r){var n=this;if(e){e--;var a=new XMLHttpRequest;a.open("GET",t.url+"__"+e+"__."+r+t.urlOptions,!0),a.responseType="arraybuffer",a.withCredentials=!0,a.onreadystatechange=function(s){4===a.readyState&&(0!==a.status&&200!==a.status||(t.data.chunks[e]=this.response,n.getChunks(e,t,i,r)))},a.send(null)}else i.call(this,t)},this.load=function(e,i,r,n,a){var s=e,o="",l=null,c=[],h=i,u=r,d=n,p=null,f=null,m=null,g=a,v=!1,S=!1;e.destinationNode&&(s=e.url,o=e.urlOptions?e.urlOptions:"",l=e.json,c=e.chunks?e.chunks:[],h=e.readyCallback,u=e.progressCallback,d=e.doneCallback,p=e.nodeCallback,f=e.imageCallback,m=e.materialCallback,g=e.destinationNode,v=!!e.layers,S=!!e.reps);var _={url:s,urlOptions:o,path:s?t.parseUrl(s+".json").directoryPath:null,json:l,readyCallback:h,progressCallback:u,doneCallback:d,imagesCallback:f,materialsCallback:m,nodeCallback:p,destinationNode:g,unstreamLayers:v,unstreamReps:S,loadIndex:this.loadIndex,data:{nbChunks:c?c.length:0,chunks:c,root:null,nodes:{},geometries:{},textures:{},materials:{},reps:{}}};this.modelsToLoad[this.loadIndex]=_,this.internalLoad(this.loadIndex),this.loadIndex++}}}),define("Visualization/StreamVisuLoader",["DS/Visualization/StreamVisuLoader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/StreamVisuLoader"),e}),define("DS/Visualization/DAEReader",["DS/VisuLoaders/DAEReader"],function(e){"use strict";return e}),define("Visualization/DAEReader",["DS/Visualization/DAEReader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/DAEReader"),e}),define("DS/Visualization/StreamVisuLoader",["DS/VisuLoaders/StreamVisuLoader"],function(e){"use strict";return e}),define("Visualization/StreamVisuLoader",["DS/Visualization/StreamVisuLoader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/StreamVisuLoader"),e});