define("DS/3DPlayRequirementExperience/3DPlayRequirementExperience",["require","exports","DS/3DPlayExperienceModule/PlayExperience3D","DS/ApplicationFrame/CommandsManager","DS/Visualization/ThreeJS_DS","DS/CATWebUXComponents/CATWebUXUtils","DS/CATWebUXSlideShow/CATWebUXSlideShowController","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/WAFData/WAFData","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/3DPlay/3DPlay","DS/WebDocumentVisualization/WebDocumentVisualizationController","DS/WebDocumentVisualization/WebDocumentBookmarksController"],function(e,t,n,i,o,a,r,l,s,u,d,c,m,p,y,D){"use strict";let g;return class extends n{constructor(t){t.commandApplication=!1,t.workbenchs=t.workbenchs||[],t.options.pad3DViewer||t.workbenchs.push({name:"3DPlayRequirementExperience",module:"3DPlayRequirementExperience"}),super(t);let n,C,h,f,b,w,S,x,v=this,P=!0,V=!1,R={};function A(){if(V)return;V=!0;let e=function(){var e,t;let o=i.getCommandCheckHeader("WebDocumentBookmarksPanelCmdHdr",v.pad3DViewer.getCommandContext());o&&(n&&(null===(e=n.getDocumentBookmarks())||void 0===e?void 0:e.length)?o.enable():o.disable(),"false"!==localStorage.getItem("DMUBookmarksPanelDisplayed")&&(null===(t=null==n?void 0:n.getDocumentBookmarks())||void 0===t?void 0:t.length)&&o.setState(!0));let a=null==n?void 0:n.getDocumentLength();(o=i.getCommand("WebDocumentNextPageCmdHdr",v.pad3DViewer.getCommandContext()))&&(a&&a>1?o.enable():o.disable()),(o=i.getCommand("WebDocumentPreviousPageCmdHdr",v.pad3DViewer.getCommandContext()))&&(a&&a>1?o.enable():o.disable()),V=!1},t={lastCommand:[],currentCommand:null,defaultCommand:null},o=v.pad3DViewer.getCommandContext();o?i._commandsState[o]=t:i._commandsState=t,i.resetDefaultCommand(o),i._isCommandEnding=!1,i._ignoreCommandBeginWhileEndingCommand=!1,["_commands","_cmdCheckHeader"].forEach(function(e){let t=o&&i[e]?i[e][o]:i[e];t&&Object.keys(t).forEach(function(e){let n=t[e];n&&n._destroy&&n._destroy(),delete t[e]})});let a=v.pad3DViewer.getFrameWindow().getActionBar(),r=a.onActionBarReady(function(){a.removeCallback(r),setTimeout(e,500)});v.pad3DViewer.loadActionBar({file:"3DPlayRequirementExperience.xml",module:"3DPlayRequirementExperience"})}function E(){p.displayFatalError({ctx:v.ctx,msg:"It does not contain any element"},{name:"ReqSpecEmpty"}),v.clearView()}function T(e){if(e){let t=e.visibleElements[0].title;b.displaySlideInformation({fontIcon:"wux-ui-3ds-docs",message:t,secondary:""})}}function I(e){n&&n.isADocumentDisplayed()&&(n.centerViewpointAtNextOrPreviousElement("next"===e),T(n.getElementsVisualizationData()))}function k(){if(!b){let e;(b=r.getSlideShowController({context:v.pad3DViewer.getFrameWindow(),id:"3DPlayRequirementExpSlideShow"})).setListOfCommandsAllowed(["WebDocumentFitAllInCmdHdr","WebDocumentFitWidthCmdHdr","WebDocumentPreviousPageCmdHdr","WebDocumentNextPageCmdHdr"]),S={onPreviousSlideCB:b.subscribe("onPreviousSlideCB",function(){I("previous")}),onNextSlideCB:b.subscribe("onNextSlideCB",function(){I("next")}),onActiveStateModified:b.subscribe("onActiveStateModified",function(t){if(n)if(P=!t.state,C&&C.setPanelVisibilityFlag(!t.state),n.enableTextSelection(!t.state),t.state){t.onBeginSlideShow(!0),l.empty(),s.empty(),u.empty();let i=v.pad3DViewer.getViewer();e={activated:i.getManipulators(),preActivate:i.manipulatorManager.preActivation},i.setManipulators({activated:!1,preActivate:!0}),T(n.getElementsVisualizationData()),w=n.subscribe("onCurrentElementChange",function(){n&&T(n.getElementsVisualizationData())})}else w&&n.unsubscribe(w),w=null,v.pad3DViewer.getViewer().setManipulators(e)})}}}function W(e,t){return new Promise(n=>{f&&f[e]?n(f[e]):d.authenticatedRequest(t,{proxy:"none",type:"blob",timeout:18e4,onComplete:function(t){let i=new FileReader;i.onload=function(){f||(f={}),f[e]=i.result,n(f[e])},i.readAsDataURL(t)},onFailure:function(){n(t)},onTimeout:function(){n(t)}})})}function O(e){return new Promise((t,n)=>{d.authenticatedRequest(c.get3DSpaceUrl()+"/resources/trm/streaming/structure/"+e.phyId,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:e.securityContext},timeout:6e4,onComplete:function(e){let n=JSON.parse(e);t(n)},onFailure:n,onTimeout:n})})}g=null;const q=function(e){let t=document.createElement("textarea");return t.innerText=e,t.innerHTML};async function _(e){let t=e.parentElement?[e.parentElement]:[],i=[],o=[],a=function(e){let t="";for(let n=1;n<=e&&i[n];n++)1!==n&&(t+="."),t+=i[n];return t};for(let n=1;n<e.dataObj.length;n++){const r=e.dataObj[n];R[r.type]||(R[r.type]=r["type.kindof"]);let l={phyId:r.physicalid,typeIconUrl:await W(r["type.kindof"],r.type_icon_url),level:parseInt(r.level),type:r["type.kindof"],title:"",chapterLevelTag:"",subLevelTag:""};if(o.length-1>l.level&&(o=o.slice(0,l.level+1)),o[r.level]?o[r.level]++:o[r.level]=1,"Chapter"===r["type.kindof"])i[r.level]?i[r.level]++:i[r.level]=1,i.length-1>l.level&&(i=i.slice(0,l.level+1)),l.content=r["attribute[Title]"],l.title=r["attribute[Title]"],l.type=r["type.kindof"],l.chapterLevelTag=a(l.level),l.fontSize=34-2*l.level;else if("Comment"===r["type.kindof"]||"Requirement"===r["type.kindof"]){l.content=r["attribute[Content Data]"],l.title=r["attribute[Title]"],l.type=r["type.kindof"],"1"===r.level?l.chapterLevelTag="0":l.chapterLevelTag=a(l.level-1)||"0";let e="",t=Math.max(0,i.length-1>=l.level?l.level-1:i.length-1);for(let n=t+1;n<=l.level;n++)n!==t+1&&(e+="."),o[n]||(o[n]=1),e+=o[n];l.subLevelTag=e}t.push(l)}t.length?n&&n.loadDocumentStream({type:"Requirement",phyId:e.phyId,fatherNode:v.pad3DViewer.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),elementsToLoad:t,onComplete:()=>{A(),k(),C||(C=D.getWebDocumentBookmarksController({context:v.pad3DViewer}))},onFailure:E}):E()}function M(e){var t,n;(t=e,n=m.getSetting("pad_security_ctx"),new Promise(function(e,i){let o=encodeURI(`${c.get3DSpaceUrl()}/resources/trm/dictionary/info?pid=${t}&select=type,attribute[Content Data],attribute[Title]`);d.authenticatedRequest(o,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:n},timeout:6e4,onComplete:function(n){let o=JSON.parse(n);o&&"success"===o.status&&o.results[0]?e({phyId:t,content:q(o.results[0]["attribute[Content Data]"]||""),title:o.results[0]["attribute[Title]"],type:o.results[0].type.value}):i(new Error("Requirement has no content"))},onFailure:function(){i(new Error("Requirement content Request Failed"))},onTimeout:function(){i(new Error("Requirement content Request Timeout"))}})})).then(function(t){"Requirement"===t.type||R&&"Requirement"===R[t.type]?v.pad3DViewer.getController().getAttributes({ids:[e],attributes:["type_icon_url"],callbacks:{onComplete:function(n){W("Requirement",n[e].type_icon_url).then(e=>{let n={phyId:t.phyId,content:t.content,title:t.title,type:"Requirement",typeIconUrl:e,level:0,chapterLevelTag:"0",subLevelTag:"0"};n.typeIconUrl=e,O({phyId:n.phyId,securityContext:m.getSetting("pad_security_ctx")}).then(e=>{_({phyId:t.phyId,parentElement:n,dataObj:e,securityContext:m.getSetting("pad_security_ctx")})},E)})},onFailure:E}}):O({phyId:t.phyId,securityContext:m.getSetting("pad_security_ctx")}).then(e=>{_({phyId:t.phyId,dataObj:e,securityContext:m.getSetting("pad_security_ctx")})},E)},E)}function F(t){if(t.path){let n=e("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices");if(n){let e=t.path.getLastElement(!0),i=n.getNodeID(e)||e&&"string"==typeof e.persistentId&&e.persistentId||e&&e.getID&&e.getID(),o=n.getNodeType(e)||e&&e.getType&&e.getType();"Requirement"!==o&&"Requirement Specification"!==o||M(i)}}}this.internalLoad=function(e){var t;e&&(t=e.asset.dtype,new Promise((e,n)=>{let i={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":m.getSetting("lang"),SecurityContext:m.getSetting("pad_security_ctx")},data:JSON.stringify({sType:t}),onComplete:t=>{let n=JSON.parse(t);e(n.parentTypes)},onFailure:n},o=encodeURI(`securityContext=${m.getSetting("pad_security_ctx")}&tenant=${c.getPlatformId()}`);d.authenticatedRequest(`${c.get3DSpaceUrl()}/resources/markup/service/getParentTypes?${o}`,i)})).then(t=>{const i=["Requirement","Requirement Specification"];let o=e.asset.dtype;if(i.some(e=>{let n=t.indexOf(e);if(-1!==n)return o=t[n],!0}),i.includes(o)){if(R[e.asset.dtype]||(R[e.asset.dtype]=o),(x={id:e.asset.physicalid,type:o}).id){h=v.pad3DViewer.subscribe({event:"onRootAdded"},F),n||(n=y.getWebDocumentVisualizationController({context:v.pad3DViewer}));let e=x.type,t=x.id;v.pad3DViewer.setAutomaticReframePolicy(!1);let i=v.pad3DViewer.options.visuProgressiveTileModel?[{rootID:t,structure:{rootStats:{infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:t,"ds6w:type":e,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part",boundingbox:{max:[-1,-1,-1],min:[1,1,1]}},{synthesis:{name:"ProgressiveExpand_FlatSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_OccSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_LeafSynthesis",value:1}}]},infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:t,"ds6w:type":e,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part",nbchildren:"0"}]}}]:[{rootID:t,structure:{rootId:e,results:[{attributes:[{name:"did",value:t},{name:"physicalid",value:t},{name:"ds6w:type",value:e}]},{path:[t]}]}}];v.pad3DViewer.loadJSON({data:i})}}else E()},E)},this.internalClear=function(e){v.pad3DViewer&&h&&v.pad3DViewer.unsubscribe(h),S&&Object.keys(S).forEach(e=>{b&&S&&b.unsubscribe(S[e])}),b&&r.unreferenceSlideShowController({context:v.pad3DViewer.getFrameWindow(),id:"3DPlayRequirementExpSlideShow"}),e&&(n&&y.unreferenceWebDocumentVisualizationController({context:v.pad3DViewer}),C&&D.unreferenceWebDocumentBookmarksController({context:v.pad3DViewer})),b=n=C=h=null},this.internalDispose=function(e){v.frmWindow.getContextualUIManager().unregister("3DPlayRequirementExperience"),v.internalClear&&v.internalClear("ENOR3D_AP"!==e),x=null},this.internalRefresh=function(){x&&(v.internalClear(!0),v.internalLoad({asset:{physicalid:x.id,dtype:x.type}}))},this.internalPostCreate=function(){v.frmWindow.getContextualUIManager().register({subscriberId:"3DPlayRequirementExperience",workbenchName:"3DPlayRequirementExperience",context:v.pad3DViewer.getCommandContext(),cmdPrefix:"",fileName:"3DPlayRequirementExperience.xml",module:"3DPlayRequirementExperience",onContextualMenuReady:function(e,t){let n=[];if(P&&t&&t.XmousePosition){let e=new o.Vector2(t.XmousePosition,t.YmousePosition),i=v.frmWindow.getViewer().getMousePosition(e);0===v.frmWindow.getViewer().pick(i,"mesh",!0).path.length&&(a.isMobile()||(n=[{line:1,name:"3DPlayReqExpDisplaySubMenu",resourceFile:"WebDocumentVisualizationCommands/WebDocumentVisualizationCommands",hdr_list:["VisuQMCommand"]}]),n=n.concat([{line:1,name:"3DPlayReqExpAmbiencesSubMenu",resourceFile:"WebDocumentVisualizationCommands/WebDocumentVisualizationCommands",hdr_list:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]}]))}return{cmdList:n}}})},this.subscribe("ASSET/LOADINGFINISHED",function(){k(),n||(n=y.giveWebDocumentVisualizationController({context:v.pad3DViewer})||null),C||(C=D.giveWebDocumentBookmarksController({context:v.pad3DViewer})||null),h||(h=v.pad3DViewer.subscribe({event:"onRootAdded"},F)),A()},!0)}clearView(){this.internalClear&&this.internalClear(!0),super.clearView()}onPostCreate(){window.widget.setMetas({helpPath:"3DPlayRequirementExperience/assets/help"}),window.widget.dispatchEvent("onPlayExperienceReady",[{pad3DViewer:this.pad3DViewer}]),this.internalPostCreate&&this.internalPostCreate()}dispose(e){window.widget.setMetas({helpPath:void 0}),this.internalDispose&&this.internalDispose(g||""),g=null,super.dispose(e)}refresh(){return this.internalRefresh&&this.internalRefresh(),!0}loadAsset(e){e&&e.asset&&e.asset.physicalid&&this.internalLoad&&(this.clearView(),this.internalLoad(e))}acceptSwitch(e){let t=!1;return e&&e.options&&e.options.id&&"ENOR3D_AP"===(g=e.options.id)&&(t=!0),t}}});