define("DS/FeedReaderWdg/Views/AddUrl",["UWA/Core","UWA/Class/View","DS/Bookmarklet/Notification","DS/UIKIT/Input/Text","DS/UIKIT/Input/Button","i18n!FeedReaderWdg/assets/nls/feed","css!DS/FeedReaderWdg/Views/AddUrl"],function(e,t,i,n,s,l){"use strict";return t.extend({render:function(){var t,r,a,d,o,g,f,u=e.createElement,c=this;function w(){var t=this.getValue().trim();e.is(t)&&""!==t&&(t=e.Utils.isAbsoluteUrl(t)?t:"http://"+t,self.widget.setValue("url",t),c.dispatchEvent("newUrlEntry",t))}self.widget.body.empty(),!1===self.widget.bookmarkletDisplayed&&(self.widget.bookmarkletDisplayed=!0,a=u("div",{class:"bookmarkletContainer"}).inject(self.widget.body),(r=new i).render().inject(a)),t=u("div",{class:"containerFeed",events:{click:function(){e.is(r)&&r.destroy()}}}).inject(self.widget.body),d=u("div",{class:"addfeed"}).inject(t),o=u("form",{class:"feedform"}).inject(d),g=u("fieldset").inject(o),f=new n({events:{onKeyDown:function(t){"return"===e.Event.whichKey(t)&&(e.Event.stop(t),w.apply(this))}},attributes:{autofocus:!0,placeholder:l.placeHolderEnterFeed,value:self.widget.getValue("url")}}),new s({className:"input-submit primary",value:l.submitFeedBtn,events:{onClick:function(t){e.Event.stop(t),w.apply(f)}}}).inject(g),u("span",{html:[f]}).inject(g)}})}),define("DS/FeedReaderWdg/Models/Feed",["UWA/Utils","UWA/Class/Model"],function(e,t){"use strict";return t.extend({defaults:function(){return{id:"",link:"",title:"",author:"",authors:[],enclosures:[],categories:[],date:void 0,createdDate:void 0,modifiedDate:void 0,geo:{},content:"",image:""}},setup:function(){this.set("encodedLink",e.encodeUrl(this.get("id")).replace(/%/gi,"_"))}})}),define("DS/FeedReaderWdg/Views/List",["DS/W3DXComponents/Views/Layout/ListView"],function(e){"use strict";return e.extend({onInjected:function(){self.FeedReader.filterDelayedEvents()}})}),define("DS/FeedReaderWdg/FeedReader",["UWA/Core","UWA/Utils","UWA/Class/Collection","UWA/Class/View","UWA/Utils/Client","UWA/Utils/InterCom","DS/WebappsUtils/WebappsUtils","DS/FeedReaderWdg/Views/AddUrl","DS/FeedReaderWdg/Views/List","DS/FeedReaderWdg/Models/Feed","DS/W3DXComponents/Views/EmptyView","TagNavigatorProxy/TagNavigatorProxy","DS/W3DXComponents/Skeleton","DS/UIKIT/Alert","i18n!DS/FeedReaderWdg/assets/nls/feed"],function(e,t,i,n,s,l,r,a,d,o,g,f,u,c,w){"use strict";var h,m,p,y,v,R=!1,b=[];return h=function(t){var i,n,s,l,r,a,d;if(self.FeedReader.bones&&self.tagger){if("Channel"===self.widget.getValue("view")){var o=self.FeedReader.bones.getViewAt(0).contentsViews;i="maximized"===self.widget.getView().type?o.tile:o.channel}else i=self.FeedReader.bones.getViewAt(0);s=i.scrollView,l=(n=i.nestedView).collection,r=self.tagger.getCurrentFilter().allfilters,a=[],d=[],s.useInfiniteScroll(!1),s.usePullToRefresh(!1),e.is(t,"object")&&e.Object.keys(r).length>0?self.widget.taggerQuery=t.filteredSubjectList:e.is(t,"object")&&0===e.Object.keys(r).length?self.widget.taggerQuery=null:self.widget.stringQuery=t,d=self.widget.stringQuery&&self.widget.stringQuery.length>0?d.concat(l.filter(function(e){return e.get("content").test(self.widget.stringQuery,"gi")||e.get("author").test(self.widget.stringQuery,"gi")||e.get("title").test(self.widget.stringQuery,"gi")})):null,a=self.widget.taggerQuery?a.concat(self.widget.taggerQuery):null,d||a?n.filter(function(e){var t,i;if(t=!a||-1!==a.indexOf(e.id),i=!d||-1!==d.indexOf(e),t&&i)return self.FeedReader.filteredTagData[e.id]=self.tags[e.id],!0}):(n.filter(null),s.useInfiniteScroll(!0),s.usePullToRefresh(!0)),n.visibleItems.length>0?i.scrollToItemView(n.visibleItems[0].cid,"start"):i.scrollToPosition({x:0,y:0})}},m=function(i,n){var s,l,r,a,d=/\.(jpeg|gif|jpg|bmp|png)$/i;for(s=0;s<i.length;s++)if(l=i[s].url,r=i[s].type,l&&(r&&/^image\/(jpeg|gif|jpg|bmp|png)$/.test(r)||d.test(l)))return l;return e.is(n)&&(a=function(e){var t,i,n,s,l=e.getElementsByTagName("img");for(t=0,i=l.length;t<i;t++)if(s=l[t],(n=l[t].getAttribute("src"))&&(!s.height||s.height>1)&&(!s.width||s.width>1))return n;return null}(t.loadHtml(n)),e.is(a))?a:null},p=i.extend({model:o,parse:function(t){var i,n,s,l,r=[],a=0;if(self.tags=t.tagData,self.items=t.items,self.title=t.title,0===self.items.length)self.FeedReader.handleInfoMessage(w.emptyFeedWarning);else{for(i=0;i<self.items.length;i++)s=(n=self.items[i]).content,e.is(s)&&(l=s.stripTags()),n.image=m(n.enclosures,s),r.push({id:n.id,title:n.title,author:n.author,authors:n.authors,enclosures:n.enclosures,categories:n.categories,date:n.date,modifiedDate:n.modifiedDate,createdDate:n.createdDate,geo:n.geo,link:n.link,content:l,htmlContent:s,image:n.image}),a+=n.image?1:0;e.is(self.tagger)&&self.tagger.setSubjectsTags(self.tags)}return self.FeedReader.toggleThumbnails(0===a),self.FeedReader.updateTitle(),this.dispatchEvent("collectionSet",this),r},onError:function(){var e=arguments[1];e&&e.error&&e.error.code&&502===e.error.code?self.FeedReader.handleInfoMessage(w.emptyFeedWarning):self.FeedReader.handleWarningMessage(w.errorURL)}}),y=n.extend({tagName:"div",className:"generic-detail",render:function(){return this.content=e.createElement("div",{class:"generic-content",html:this.model.get("htmlContent")}),this.content.addEvent("scroll",function(e,t){var i,n,s,l,r=0;function a(){r=new Date,s=null,l=e.apply(i,n)}return function(){var d=new Date,o=t-(d-r);return i=this,n=arguments,o<=0?(clearTimeout(s),s=null,r=d,l=e.apply(i,n)):s||(s=setTimeout(a,o)),l}}(this.onScroll.bind(this),300)),this.container.setContent(this.content),self.FeedReader.selectedId=this.model.id,self.FeedReader.sendTags(),this},onScroll:function(e){var t=self.FeedReader.bones.getActiveIdCard(),i=this.content.getScrolls().top;i>=100?t.minimize():0===i&&t.maximize()},destroy:function(){self.FeedReader.selectedId=null,self.FeedReader.sendTags(),this.stopListening(),this.content.destroy(),self.FeedReader.bones.dispatchEvent("unselectedItem"),this._parent.apply(this,arguments)}}),v={bones:null,elements:{},filteredTagData:[],warningDisplayed:!1,initView:null,updateTitle:function(){var e=!1,t=self.widget.getValue("title");t?e=!0:t=self.title?self.title.unescapeHTML():"",self.widget.setTitle(t),e&&self.widget.setValue("title",t)},toggleThumbnails:function(e){widget.body.toggleClassName("no-thumbnail",e)},onResetSearch:function(){if(e.is(self.FeedReader.selectedId))return R=!0,void b.push({type:"onResetSearch"});h(null),v.sendTags()},onSearch:function(t){if(e.is(self.FeedReader.selectedId))return R=!0,void b.push({type:"onSearch",query:t});self.FeedReader.filteredTagData={},h(t),v.sendTags(self.FeedReader.filteredTagData)},tagging6w:function(t){if(e.is(self.FeedReader.selectedId)||!e.is(self.FeedReader.bones.getViewAt(0)))return R=!0,void b.push({type:"6wFiltering",query:t});h(t)},filterDelayedEvents:function(){if(R){for(var e=0,t=b.length;e<t;++e)switch(b[e].type){case"onSearch":v.onSearch(b[e].query);break;case"onResetSearch":v.onResetSearch();break;case"6wFiltering":v.tagging6w(b[e].query)}b=[],R=!1}},initTagger:function(){self.tagger=f.createProxy({widgetId:self.widget.id,filteringMode:"WithFilteringServices",events:{addFilterSubjectsListener:self.FeedReader.tagging6w}})},sendTags:function(t){e.is(self.tagger)&&(e.is(self.FeedReader.selectedId)?self.tagger.focusOnSubjects([self.FeedReader.selectedId]):(self.tagger.unfocus(),e.is(self.tags)&&self.tagger.setSubjectsTags(t||self.tags)))},onViewChange:function(){var t=self.FeedReader.bones;e.is(t)&&self.FeedReader.sendTags()},handleWarningMessage:function(t){e.is(self.FeedReader.bones)&&(self.FeedReader.bones.destroy(),self.FeedReader.bones=null),self.widget.body.empty(),v.updateTitle(),new c({className:"my-alert",closable:!0,visible:!0,events:{onClick:function(){self.FeedReader.renderInitView()},onRemoveMessage:function(){self.FeedReader.renderInitView()}}}).inject(self.widget.body).add({className:"error",message:t})},handleInfoMessage:function(e){self.FeedReader.warningDisplayed=!0,self.widget.body.empty(),v.updateTitle(),new c({className:"my-alert",closable:!1,visible:!0}).inject(self.widget.body).add({className:"info",message:e})},pullToRefresh:function(e){var t=this.nestedView.collection;this.listenToOnce(t,"collectionSet",function(){e.endLoading()}),t.fetch({reset:!0})},renderSkeletonView:function(t){var i,n=null,s=!1;e.is(t)&&""!==t?(e.Utils.isAbsoluteUrl(t)||(t="http://"+t,self.widget.setValue("url",t)),i=e.Utils.parseUrl(t).domain,top.require(["DS/Dashboard/PublicAPI"],function(l){var r=l._getSwymPlatform();!r||r.url?(n=e.Data.proxifyUrl(t,{proxy:"feed"}),v.initBones(n)):(!0===r.url.toLowerCase().contains(i.toLowerCase())&&"http"!==i.toLowerCase()&&(s=!0),n=!0===s?e.Data.proxifyUrl(t,{proxy:"feed",authentication:{auth:"passport"}}):e.Data.proxifyUrl(t,{proxy:"feed"}),v.initBones(n))})):v.initBones(n)},initBones:function(t){v.bones=new u({feed:{collection:p,collectionOptions:{url:t},idKey:"encodedLink",swipe:s.Features.touchEvents,view:"Channel"===self.widget.getValue("view")?null:d,viewOptions:{itemViewOptions:{mapping:{subtitle:function(){return new Date(this.model.get("date")).toLocaleDateString(self.widget.lang,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"})}},icon:"rss"},emptyView:g,contents:{useInfiniteScroll:!1,usePullToRefresh:!0},useInfiniteScroll:!1,usePullToRefresh:!0,events:{onPullToRefresh:self.FeedReader.pullToRefresh}},idCardOptions:{attributesMapping:{title:"title",date:function(){return new Date(this.get("date")).toLocaleDateString(self.widget.lang,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"})},ownerName:function(){var t=this.get("author"),i=this.get("authors");return e.is(t,"string")?t:e.is(i,"array")&&i.length>0?e.is(i[0],"string")?i[0]:"":void 0}},actions:function(){var e,t=[];return(e=widget.id,parent.UWA.Widgets.instances.detect(function(t){return t.id===e})||widget).environment.wp.isEditable&&t.push({text:w.shareArticle,icon:"forward",handler:function(){var e=new l.Socket("socket-shareArticle"),t=this;parent.require(["DS/Dashboard/Intercom"],function(i){e.subscribeServer(i.serverId),e.dispatchEvent(i.events.article.share,{type:"article",id:self.widget.id,title:t.model.get("title"),link:t.model.get("link")})})}}),t.push({text:w.goToWebsite,icon:"logout",handler:function(){window.open(this.model.get("link"),"_blank")}}),t},facets:[{text:w.details,icon:"doc-text",handler:u.getRendererHandler(y)}]}}},{root:"feed",useRootChannelView:"Channel"===self.widget.getValue("view"),responsiveTrigger:function(){var e=self.widget.getView().type;return"maximized"===e||"fullscreen"===e},startRoute:widget.getValue("route"),events:{onRouteChange:function(e){self.widget.setValue("route",e)}}}),e.is(v.initView)&&v.initView.destroy(),self.FeedReader.bones.listenTo(self.FeedReader.bones,"unselectedItem",self.FeedReader.filterDelayedEvents),self.FeedReader.bones.render().inject(self.widget.body.empty())},renderInitView:function(){var e;v.initView=e=new a,e.render(),self.FeedReader.updateTitle(),e.listenTo(e,"newUrlEntry",self.FeedReader.onLoad)},onLoad:function(){var t=self.widget.getValue("url");e.is(self.widget.getValue("links"))&&(t=e.Json.decode(widget.getValue("links"))[0],self.widget.setValue("links",null),self.widget.setValue("url",t)),e.is(self.tagger)||self.FeedReader.initTagger(),t&&""!==t?(self.widget.bookmarkletDisplayed=!0,self.FeedReader.renderSkeletonView(t)):self.FeedReader.renderInitView()},onStart:function(e){self.widget=e,self.widget.bookmarkletDisplayed=!1,self.FeedReader.onLoad()}},self.FeedReader=v,v});