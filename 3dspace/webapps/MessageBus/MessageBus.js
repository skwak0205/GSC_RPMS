define("DS/MessageBus/MessageBus",[],function(){"use strict";var t,n=!1,i=[],e=[];window.Promise?t=Promise.resolve([window.location.origin]):require([["DS","WebappsUtils","Promise"].join("/")],function(n){t=n.resolve([window.location.origin])});var r=function(){var n={},i=0;function e(e){[].slice.call(window.frames).concat(window.parent===window?[]:[window.parent]).map(function(e){try{return Promise.resolve({value:e,origin:e.location.origin})}catch(t){}return e.postMessage({type:"MessageBus:queryOrigin"},"*"),new Promise(function(t,r){var o=i++;n[o]={window:e,callback:t},setTimeout(function(){delete n[o],r(new Error("Window did not answer origin query"))},200)}).then(function(n){return t.then(function(t){if(-1===t.indexOf(n))throw new Error("Untrusted window returned an origin");return{value:e,origin:n}})})}).forEach(function(t){t.then(function(t){t.origin&&"null"!==t.origin&&e(t.value,t.origin)}).catch(function(){})})}return window.addEventListener("message",function(i){var e=i.data,r=e.options,o=i.source,s=i.origin;if(e&&e.type)switch(e.type){case"MessageBus:queryOrigin":return o.postMessage({type:"MessageBus:queryOrigin:answer"},s);case"MessageBus:queryOrigin:answer":return Object.keys(n).forEach(function(t){n[t].window===o&&(n[t].callback(s),delete n[t])});case"MessageBus:publish":return t.then(function(t){"*"!==t[0]&&-1===t.indexOf(s)||(r._sourceWindow=o,l.publish(r))})}}),function(t){var n={},i=t._sourceWindow;delete t._sourceWindow,Object.keys(t).forEach(function(i){n[i]=t[i]}),n.data=void 0===n.data?n.data:JSON.parse(JSON.stringify(n.data)),e(function(t,e){t!==i&&t.postMessage({type:"MessageBus:publish",options:n},e)})}}(),o={cache:{},regex:{},compare:function(t,n){var i,e,r,o=this.cache[n]&&this.cache[n][t];return void 0!==o?o:((e=this.regex[t])||(i="^"+t.split(".").map(function(t){var n="";return r&&(n="#"!==r?"\\.\\b":"\\b"),r=t,n+="#"===t?"[\\s\\S]*":"*"===t?"[^.]+":t}).join("")+"$",e=this.regex[t]=new RegExp(i)),this.cache[n]=this.cache[n]||{},this.cache[n][t]=o=e.test(n),o)},reset:function(){this.cache={},this.regex={}}};function s(t,n){return function(){try{t(JSON.parse(n.data),n)}catch(t){setTimeout(function(){throw t})}}}function c(){for(;i.length;){var t=i.shift();t&&t()}n=!1,function(){for(;e.length;)l.unsubscribe(e.shift())}()}function a(t){for(var n in t)if(t.hasOwnProperty(n))return!1;return!0}function u(t){return t?function(n){var i=0,e=0;for(var r in t)t.hasOwnProperty(r)&&(i+=1,("topic"===r&&o.compare(n.topic,t.topic)||n[r]===t[r])&&(e+=1));return i===e}:function(){return!0}}var h=function(t,n,i,e){if(arguments.length<3)throw new Error("You must provide a channel, topic and callback when creating a Subscription instance.");if(0===n.length)throw new Error("Topics cannot be empty");this.channel=t,this.topic=n,this.callback=i,this.crossFrame=e};h.prototype.unsubscribe=function(){this.inactive||(this.inactive=!0,l.unsubscribe(this))},h.prototype.subscribe=function(t){return this.callback=t,this};var p=function(t){this.name=t||l.options.defaultChannel};p.prototype.publish=function(t){l.publish({channel:this.name,topic:t.topic,data:t.data})},p.prototype.subscribe=function(t){return l.subscribe({channel:this.name,topic:t.topic,callback:t.callback})};var l={options:{defaultChannel:"Internal"},subscriptions:{},Subscription:h,Channel:p,getSubscriptions:function(t){var n,i,e=[];for(var r in this.subscriptions)if(this.subscriptions.hasOwnProperty(r))for(var o in n=this.subscriptions[r])n.hasOwnProperty(o)&&(i=n[o],e=e.concat(i.filter(u(t))));return e},channel:function(t){return new p(t)},publish:function(t){var e,a,u,h,p,l,f=t.channel||this.options.defaultChannel,d=t.topic,b=t.originalTopic,w=this.subscriptions[f],g={channel:f,topic:d,timestamp:new Date};if(b&&(g.originalTopic=b),void 0!==t.data)try{e=JSON.stringify(t.data)}catch(t){throw new Error("Please provide a valid Object data. Cause: "+t)}if(g.data=e||"{}",w&&d)for(var v in w)if(w.hasOwnProperty(v)&&w[v]){for(p=0,l=(a=w[v]).length;p<l;p++)(u=a[p]).inactive||!u.crossFrame&&t._sourceWindow||!o.compare(u.topic,g.topic)||(h=s(u.callback,g),i.push(h));n||(n=!0,setTimeout(c,0))}t.crossFrame&&r(t)},subscribe:function(t){var n,i;return n=new h(t.channel||this.options.defaultChannel,t.topic,t.callback,t.crossFrame),this.subscriptions[n.channel]||(this.subscriptions[n.channel]={}),(i=this.subscriptions[n.channel][n.topic])||(i=this.subscriptions[n.channel][n.topic]=[]),i.push(n),n},unsubscribe:function(t){var i,r,o,s,c;for(s=(i=t instanceof h?[t]:"[object Array]"===Object.prototype.toString.call(t)?t:this.getSubscriptions(t)).length;s--;)r=i[s],n?e.push(r):(i=(o=this.subscriptions[r.channel])&&o[r.topic])&&((c=i.indexOf(r))>-1&&i.splice(c,1),i.length||(delete o[r.topic],a(o)&&delete this.subscriptions[r.channel]))},reset:function(){this.unsubscribe(),o.reset(),this.subscriptions={}},setTrustedOrigins:function(n){var i=t||[window.location.origin];t=Promise.resolve(n).then(function(t){var n={};if(!("object"==typeof t&&"length"in t))throw new Error("Origins trusted by MessageBus must be an array-like object");if((t=Array.prototype.slice.call(t)).indexOf("*")>-1)throw new Error('MessageBus does not allow "*" as a trusted origin');return[window.location.origin].concat(t.map(function(t){return n=t,(i=document.createElement("a")).href=n,["http:","https:"].indexOf(i.protocol)>-1&&i.host?i.protocol+"//"+i.hostname+(!i.port||"http:"===i.protocol&&"80"===i.port||"https:"===i.protocol&&"443"===i.port?"":":"+i.port):"";var n,i}).filter(function(t){return!!t})).forEach(function(t){n[t]=!0}),Object.keys(n)}).catch(function(t){return setTimeout(function(){throw t}),i})},getTrustedOrigins:function(){return t.then(function(t){return t.slice()})}};return l});