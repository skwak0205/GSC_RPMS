/*! -- Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/RichView/mixins/_dndUtilities",["UWA/Class","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/jQueryUI","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/Services/RequirementWebServices","i18n!DS/RichView/assets/nls/RichView"],function(e,t,i,n,o,r){"use strict";var a=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,s=(window.chrome,!!document.documentMode);Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor");return e.extend({init:function(){},isVisible:function(){var e=this.context.contentPanel.height(),t=this.container.height(),i=this.container.offset().top;return i+t>0&&i<e},isDroppable:function(e){if(this._dragging)return!1;if(-1!==t.inArray("cke/id",e.originalEvent.dataTransfer.types))return!1;if(s)return this.options.droppable.Text;var i=!1;if(UWA.is(e.originalEvent.dataTransfer.types[0],"string")){var n=this.extractFromDataTransfer(e.originalEvent.dataTransfer.types[0]);this.model.getNodesByElementID(n).length>0&&(i=!0)}if(-1!==t.inArray("Files",e.originalEvent.dataTransfer.types)&&!1===i)return this.options.droppable.Files;if(-1!==t.inArray("text/searchitems",e.originalEvent.dataTransfer.types)&&!1===i)return this.options.droppable["text/searchitems"];if(-1!==t.inArray("text/plain",e.originalEvent.dataTransfer.types)&&!1===i)return this.options.droppable["text/plain"];if(-1!==t.inArray("Text",e.originalEvent.dataTransfer.types)&&!1===i)return this.options.droppable.Text;var o=e.originalEvent.dataTransfer,r=this._lowerMatchUpper[this.extractFromDataTransfer(o.types[2])],a=this._lowerMatchUpper[this.extractFromDataTransfer(o.types[3])],l=!1;return void 0!==this.options.droppable[r]?l=this.options.droppable[r]:this.options.droppable[a]&&(l=this.options.droppable[a]),l},extractFromDataTransfer:function(e){var t=-1!==e.indexOf("_")?e.indexOf("_")+1:0;return e.substring(t)},isInUpperHalf:function(e,t){return e<=t.offset().top+t.outerHeight()/4},isInLowerHalf:function(e,t){return e+t.outerHeight()/4>=t.offset().top+t.outerHeight()},updateHighlight:function(e,t,i){return this.isInUpperHalf(e,t)&&-1!==i.indexOf("before")?t.prev().hasClass("droppable-above")?"before":(t.removeClass("droppable-child"),t.next().hasClass("droppable-below")&&t.next().remove(),t.before('<div class="droppable-target droppable-above wux-datagrid-row-insertion-mark"></div>'),"before"):this.isInLowerHalf(e,t)&&-1!==i.indexOf("after")?t.next().hasClass("droppable-below")?"after":(t.removeClass("droppable-child"),t.prev().hasClass("droppable-above")&&t.prev().remove(),t.after('<div class="droppable-target droppable-below wux-datagrid-row-insertion-mark"></div>'),"after"):-1!==i.indexOf("over")?t.hasClass("droppable-child")?"over":(t.next().hasClass("droppable-below")&&t.next().remove(),t.prev().hasClass("droppable-above")&&t.prev().remove(),t.addClass("droppable-child"),"over"):void 0},cleanupHighlight:function(e){e.removeClass("droppable-child"),e.next().hasClass("droppable-below")?e.next().remove():e.prev().hasClass("droppable-above")&&e.prev().remove()},handleDataTransferInIE:function(e){var t=e.dataTransfer.getData("text"),i=void 0;try{i=JSON.parse(t)}catch(e){i=void 0}return i},process3DXContentData:function(e,t){var i=this;if(e.source===widget.getValue("appId")&&!0===i.traceabilityAuthoring)if("Requirement"===e.data.items[0].kindof){var a={id:e.data.items[0].objectId,physicalId:e.data.items[0].objectId,type:e.data.items[0].objectType,kindof:e.data.items[0].kindof,path:e.data.items[0].path,title:e.data.items[0].displayName};i.StartLinkCmd.execute(a);var s=i.model.getNodesByElementID(i.id)[0].getOccurencePath(),l={id:i.objectId,physicalId:i.physicalId,type:i.type,kindof:i.kindof,path:s,title:i.title};i.EndLinkCmd.execute(l)}else i.context.displayNotification({msg:r.RichView_Notif_NotAuthorized,eventID:"error"});else{var c=e.data.items[0].objectType,d=e.data.items[0].objectId;o.getKindOf({securityContext:n.getSecurityContext(),pid:d,onComplete:function(n){var o=(UWA.is(n,"string")?JSON.parse(n):n).results,a=i.options.droppable[o];if(!UWA.is(a)||-1===a.indexOf(i._dropPosition))return i.mediator.publish("onNotification",{className:"error",message:r.RichView_Notif_NotAuthorized}),!1;var s=e.data.items[0].objectId;i.mediator.publish("onInsert",{operation:"insertExisting",position:i._dropPosition,type:c,objectId:s,content:"",contentType:"",kindof:o,target:{element:t,id:t.attr("id")},fetchContent:!0})}})}}})}),define("DS/RichView/RichContentEditor",["UWA/Core","UWA/Class","UWA/Class/Events","UWA/Class/Listener","UWA/Class/Options","DS/CKEditor/CKEditor","DS/Logger/Logger","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/jQueryUI","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/TraceableRequirementsUtils/views/TRMFloatingPanel","DS/TraceableRequirementsUtils/utils/RequirementAlertManager","DS/RichEditor/RichEditor","DS/PADUtils/PADContext","DS/DocumentManagement/DocumentManagement","i18n!DS/RichView/assets/nls/RichView","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","UWA/Class/Promise","css!DS/RichView/RichView.css"],function(e,t,i,n,o,r,a,s,l,c,d,p,h,u,g,f,m,v,b,_){"use strict";document.documentMode;var y=null,C="../../VENREQPlugins/External/ckeditor",x=new u;String.prototype.isEmpty=function(){return 0===this.length||!this.trim()};var w=t.extend(i,n,o,{defaultOptions:{mediator:null,selector:".rich-object",target:".content-data",container:".content-panel",inlineEditing:!0,saveOnBlur:!0,commandProxy:null,richView:null,events:null},_logger:null,init:function(e){var t=this;return this._logger=a.getLogger(w),this._logger.log("init"),UWA.merge(e||{},this.defaultOptions),this.options=e,this.mediator=e.mediator,this._init(),this.keepEditing=!1,!1===widget.hasEvent("onDragOverFiles")&&".rich-object"===this.options.selector&&widget.addEvent("onDragOverFiles",function(e){t.handleFiles(e)}),this},_init:function(){this._logger.log("_init");for(var e in this._customConfig=C+"/config.js",this._toolbar="Rich",this._plugins={sharedspace:C+"/plugins/sharedspace/",colorbutton:C+"/plugins/colorbutton/",panelbutton:C+"/plugins/panelbutton/",quicktable:C+"/plugins/quicktable/",base64image:C+"/plugins/base64image/",selectall:C+"/plugins/selectall/",tableresize:C+"/plugins/tableresize/",mathjax:C+"/plugins/mathjax/",lineutils:C+"/plugins/lineutils/",widget:C+"/plugins/widget/"},this._extraPlugins="",this._plugins)this._extraPlugins+=e+",";this._extraPlugins=this._extraPlugins.slice(0,-1),".rich-container"!==this.options.selector&&".rich-object-title-editable"!==this.options.target||(this._toolbar="Container",this._extraPlugins="selectall",this._customConfig=C+"/config_rich_container.js"),this.editor=null,this.selector=this.options.selector,CKEDITOR.disableAutoInline=!this.options.inlineEditing,CKEDITOR.plugins.addExternal("rcowidget","../../VENREQPlugins/External/ckeditor/plugins/rcowidget/","plugin.js"),this.updateCKEditorSpellCheckSetting(),this._extraPlugins+=",rcowidget",CKEDITOR.dtd.$editable.span=1,this.isEditing=!1,this._padCommandProxy=this.options.commandProxy,this._reqCommandProxy=this.options.reqCommandProxy},_onKeepEditing:function(e){this._floatingComponent._closePanel(),this.keepEditing=!0,e.focus()},_onQuitEdition:function(e){this._floatingComponent._closePanel(),e.setData(this.originalData)},_buildKeepEditionDialog:function(e,t,i){var n=this;this._floatingComponent=new p({Title:i,innerText:t,button1:{title:m.RichView_Edition_Dialog_keepEditingButton,className:"primary",active:!0},button2:{title:m.RichView_Edition_Dialog_quitEditionButton},renderTo:this.defaultOptions.renderTo}),this._floatingComponent.button1.addEvents({onClick:function(t){n._onKeepEditing(e)}}),this._floatingComponent.button2.addEvents({onClick:function(t){n._onQuitEdition(e)}})},displayNotif:function(e){null===y&&(y=v,b.setNotificationManager(y),b.setStackingPolicy(5));e=UWA.extend({level:"info",message:"default message",sticky:!1},e),y.addNotif(e)},startEditionForAll:function(){this._logger.log("startEditionForAll");var e=this,t=c.getLanguage();"zh"===t&&(t+="-cn");this.defaultEditorOptions={skin:"office2013,"+C+"/skins/office2013/",customConfig:e._customConfig,extraPlugins:e._extraPlugins,toolbar:e._toolbar,language:t,startupFocus:!0,on:{instanceReady:function(e){e.editor&&e.editor.removeMenuItem("paste")},blur:function(t){e.options.saveOnBlur&&t.editor.checkDirty()&&e.checkEditability(t,!0).then(function(i){i&&(UWA.is(e.defaultEditorOptions.data)&&".PropertyTab"===e.defaultEditorOptions.data.Property&&(t.editor.spanTitle=t.sender.element.$.parentElement.parentElement.parentElement.childNodes[0].getElement("div").title),e.clearSemanticFormat(t.editor.getData().trim()),e.save(t.editor),t.editor.resetDirty())}),e.isEditing=!1,s("#"+t.editor.name).parents(e.options.selector).attr("draggable",!0),s("#"+t.editor.name).parents(e.options.selector).find(".rich-object-menu").toggleClass("rich-object-menu-hidden",!1)},change:function(t){e.clearSemanticFormat(t.editor.getData().trim()),UWA.is(e.defaultEditorOptions.data)&&".PropertyTab"!==e.defaultEditorOptions.data.Property&&e._reqCommandProxy.contentChanged()},doubleclick:function(e){var t=e.data.element.$;if(null!==t&&t.className.contains("svg-math")){var i=t.getAttribute("latex");i="\\("+i+"\\)",e.editor.widgets.registered.mathjax.defaults.math=i;var n=e.editor.toolbar,o=!1;for(var r in n)if(n.hasOwnProperty(r)&&"insert"===n[r].name){var a=n[r].items;for(var s in a)if("mathjax"===a[s].name){a[s].click(e.editor),o=!0;break}if(o)break}e.stop()}},paste:function(e){if(e.data.dataValue.contains("_svgSpan")){var t=Math.floor(1e8*Math.random()+1),i=CKEDITOR.dom.element.createFromHtml(e.data.dataValue).$.children[0].getAttribute("latex");e.data.dataValue="",MathJax.tex2svgPromise(i).then(function(n){setTimeout(function(){(n=n.getElementsByTagName("svg")[0]).setAttribute("xmlns","http://www.w3.org/2000/svg");var o=new Image;o.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(n.outerHTML)));var r=document.createElement("img");r.classList.add("svg-math",t,t+"_svgImage"),r.setAttribute("latex",i),r.src=o.src;var a=document.createElement("span");a.innerHTML=r.outerHTML,a.setAttribute("data-latex","Latex equation"),a.classList.add(t+"_svgSpan");var s=new CKEDITOR.dom.element(a),l=e.editor.getSelection().getStartElement();null!==l&&l.$.className.contains("svgSpan")?s.insertAfter(l):e.editor.insertElement(s)},1e3)})}},dialogShow:function(e){var t,i,n,o=e.data._.name,r=e.data,a=!1;"mathjax"===o&&(r.on("cancel",function(){"mathjax"===o&&(e.editor.widgets.registered.mathjax.defaults.math="\\(x = {-b \\pm \\sqrt{b^2-4ac} \\over 2a}\\)")}),r.on("ok",function(r){"mathjax"===o&&(i=e.data.getSelectedElement(),e.editor.widgets.registered.mathjax.defaults.math="\\(x = {-b \\pm \\sqrt{b^2-4ac} \\over 2a}\\)",n=CKEDITOR.dialog.getCurrent().getContentElement("info","equation").getValue(),null!==i&&i.hasClass("svg-math")?(a=!0,t=i.$.className.match(/(\d+)/)[0],i=null):(a=!1,t=Math.floor(1e8*Math.random()+1)),MathJax.tex2svgPromise(n).then(function(i){setTimeout(function(){(i=i.getElementsByTagName("svg")[0]).setAttribute("xmlns","http://www.w3.org/2000/svg");var o=new Image;o.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(i.outerHTML)));var r=document.createElement("img");if(r.classList.add("svg-math",t,t+"_svgImage"),r.setAttribute("latex",n),r.src=o.src,a){CKEDITOR.currentInstance.element.$.getElementsByClassName(t+"_svgImage")[0].remove();var s=new CKEDITOR.dom.element(r);e.editor.insertElement(s)}else{var l=document.createElement("span");l.innerHTML=r.outerHTML,l.setAttribute("data-latex","Latex equation"),l.classList.add(t+"_svgSpan");s=new CKEDITOR.dom.element(l);var c=e.editor.getSelection().getStartElement();null!==c&&c.$.className.contains("svgSpan")?s.insertAfter(c):e.editor.insertElement(s)}},1e3)})),r.stop()}))},focus:function(t){"false"!==t.sender.container.getAttribute("contentEditable")&&(s("#"+t.editor.name).parents(e.options.selector).attr("draggable",!1),s("#"+t.editor.name).parents(e.options.selector).find(".rich-object-menu").toggleClass("rich-object-menu-hidden",!0))},key:function(t){13!=t.data.keyCode||".rich-container-title-editable"!==e.options.target&&".rich-object-title-editable"!==e.options.target||(t.cancel(),t.editor.fire("blur",t),s("#"+t.editor.name).parents(e.options.selector).focusout())}}},this.options.inlineEditing||(this.defaultEditorOptions.sharedSpaces={top:"toolbar"}),s(this.options.container).on("focus",this.options.target,function(t){e._onFocus(t)})},_onFocus:function(e){var t=this;if(this.keepEditing)this.keepEditing=!1;else{e.stopPropagation();var i=e.target,n=this,o=g.get();this.defaultOptions.renderTo=o.richViewEditorContainer[0].parentElement.parentElement.parentElement.parentElement.parentElement,CKEDITOR.instances[i.id]||CKEDITOR.inline(i.id,t.defaultEditorOptions),this.originalData=CKEDITOR.instances[i.id].getData(),t.checkEditability(e,!1).then(function(i){if(i){var o=s(e.target).parents(t.options.selector),r=o.attr("id")+"_content";if(-1!==s(e.target).attr("id").indexOf("title")&&(r=o.attr("id")+"_title_content"),t.defaultEditorOptions.data={objectId:o.data("objectid")},!0!==t.isEditing||t.id!==r){var a=g.get().getRichObject(o.attr("id"));if(!0,UWA.is(a)&&a.convertBeforeEdit)richView.utilities.loading(),d.htmlConvert({securityContext:c.getSecurityContext(),id:o.data("objectid"),onComplete:function(e){richView.utilities.loading(!0);var i=(e=JSON.parse(e)).html;if(i||(i=""),e.isHTMLEditable||"Word"!=x.getPreferredEditor()){if(s(n).html(i),t.isEditing=!0,t.id=r,CKEDITOR.instances[r]||CKEDITOR.inline(r,t.defaultEditorOptions),s(".rich-object.active, .rich-container.active").toggleClass("active",!1),o.toggleClass("active",!0),g.get().onInnerSelection){var a=g.get().getPADTreeDocument().getNodesByElementID(o.attr("id"))[0];g.get().onInnerSelection(a)}}else n.setAttribute("contenteditable",!1),t.mediator.publish("onNotification",{className:"info",message:x.nls.Msg_NoHTMLEditing})},onFailure:function(e){t.mediator.publish("onNotification",{className:"error",message:e.message})}});else{if("false"===e.target.contentEditable)return;if(t.isEditing=!0,t.id=r,CKEDITOR.instances[r]||CKEDITOR.inline(r,t.defaultEditorOptions),s(".rich-object.active, .rich-container.active").toggleClass("active",!1),o.toggleClass("active",!0),g.get().onInnerSelection){var l=g.get().getPADTreeDocument().getNodesByElementID(o.attr("id"))[0];g.get().onInnerSelection(l)}}}}})}},handleFiles:function(e){var t=this;this._logger.log("Files are dragged over ckeditor editor");e.originalEvent.dataTransfer;if(UWA.is(e.originalEvent.target)){var i=s(e.originalEvent.target).parents(this.options.selector+":first"),n=i.attr("id");if(UWA.is(n)){var o=g.get().getRichObject(i.attr("id")),r=!1;i.hasClass("rich-container")&&(r=!0);var a=i.attr("id")+"_content";CKEDITOR.instances[a]||(r||o.isHTMLReady&&("Word"!=x.getPreferredEditor()||x.isMobile&&x.isMobile()))&&(o.convertBeforeEdit?d.htmlConvert({securityContext:c.getSecurityContext(),id:parentObject.data("objectid"),onComplete:function(e){var n=(e=JSON.parse(e)).html;n||(n=""),(e.isHTMLEditable||"Word"!=x.getPreferredEditor())&&(t.updateHtmlContent({element:i,content:n}),t.id=a,CKEDITOR.inline(a,t.defaultEditorOptions))}}):(t.defaultEditorOptions.data={objectId:i.data("objectid")},t.id=a,CKEDITOR.inline(a,t.defaultEditorOptions)))}}},updateCKEditorSpellCheckSetting:function(){try{!0===widget.getPreference("trm_richview_usespellchecker").value||"true"===widget.getPreference("trm_richview_usespellchecker").value?CKEDITOR.config.disableNativeSpellChecker=!1:CKEDITOR.config.disableNativeSpellChecker=!0}catch(e){CKEDITOR.config.disableNativeSpellChecker=!0}},updateHtmlContent:function(e){this._logger.log("updateHtmlContent");var t,i,n=e.content,o=e.element;if(UWA.is(n)&&UWA.is(o)){var r=o.attr("id");if(UWA.is(CKEDITOR.instances[r]))CKEDITOR.instances[r].setData(n);else{if(!0===widget.getPreference("trm_richview_optimizedloading").value||"true"===widget.getPreference("trm_richview_optimizedloading").value){var a=(new DOMParser).parseFromString(n,"application/xml");!UWA.is(a)||!UWA.is(a.querySelector("body"))||(t=a,"http://www.w3.org/1999/xhtml"===(i=(new DOMParser).parseFromString("<","text/xml").getElementsByTagName("parsererror")[0].namespaceURI)?t.getElementsByTagName("parsererror").length>0:t.getElementsByTagNameNS(i,"parsererror").length>0)||(n=a.querySelector("body").innerHTML)}o[0].innerHTML=n,e.hasOwnProperty("editable")&&o[0].setAttribute("contenteditable",e.editable)}}},save:function(e){this._logger.log("save");var t=this,i=(g.get(),!1);var n,o,r=t.clearSemanticFormatFromCKE(e),a=r.trim().replace(/\n/g,""),l=(n=r.trim(),(o=document.createElement("div")).innerHTML=n,o.textContent||o.innerText),p=UWA.Utils.base64Encode(a),h=UWA.Utils.base64Encode(l),u=null,f=null;UWA.is(t.defaultEditorOptions.data)&&".PropertyTab"===t.defaultEditorOptions.data.Property?(u=t.defaultEditorOptions.data.objectId,f=t.defaultEditorOptions.data.csrf):u=s(e.element.$).parents(t.options.selector).data("physicalid");var v=[];if(".rich-container"===t.options.selector?(l.isEmpty()&&(i=!0),v.push({name:"Title",value:l})):".rich-object-title-editable"===t.options.target?(l.isEmpty()&&(i=!0),v.push({name:"Title",value:l})):UWA.is(t.defaultEditorOptions.data)&&".PropertyTab"===t.defaultEditorOptions.data.Property?v.push({name:e.spanTitle,value:p}):v.push({name:"Content Data",value:p},{name:"Content Text",value:h},{name:"Content Type",value:"html"}),!0===i){t.mediator.publish("onNotification",{className:"info",message:m.RichView_Notif_EmptyTitle});var b={element:s(e.element.$).parents(t.options.selector),refresh:["title"]};t.mediator.publish("onRefreshElement",b)}else UWA.is(t.defaultEditorOptions.data)&&".PropertyTab"===t.defaultEditorOptions.data.Property?d.editRichText({csrf:f,securityContext:c.getSecurityContext(),pid:u,json:{attributes:v},onComplete:function(e){e=UWA.is(e,"string")?JSON.parse(e):e,console.log(e);var i=e.results,n=(UWA.is(i.type,"object")?i.type.displayName:i.type)+" "+i.name+" "+i.revision,o=m.RichView_Notif_ObjectSaved;o=o.replace("{TNR}",n),t.displayNotif({level:"success",message:o})},onFailure:function(i,n){if(UWA.is(i,"string"))try{i=JSON.parse(i)}catch(e){}if(UWA.is(n,"string"))try{n=JSON.parse(n)}catch(e){}UWA.is(n)&&UWA.is(n.message,"string")?t.displayNotif({level:"error",message:n.message}):UWA.is(i)&&UWA.is(i.message,"string")?t.displayNotif({level:"error",message:i.message}):UWA.is(i,"string")?t.displayNotif({level:"error",message:i}):console.error('"RequirementWebServices.edit(...)" failed without returning an error message!');var o={element:s(e.element.$).parents(t.options.selector)};".rich-container"===t.options.selector?o.refresh=["title"]:o.refresh=["content"]}}):d.edit({securityContext:c.getSecurityContext(),pid:u,json:{attributes:v},onComplete:function(i){for(var n=(i=UWA.is(i,"string")?JSON.parse(i):i).results,o=t.richObject.model.getNodesById(u),r=0;r<o.length;r++)o[r].getRichViewElement().cestamp=i.results.cestamp;var c=(UWA.is(n.type,"object")?n.type.displayName:n.type)+" "+n.name+" "+n.revision,d=m.RichView_Notif_ObjectSaved;d=d.replace("{TNR}",c),t.mediator.publish("onNotification",{className:"success",message:d});var p={element:s(e.element.$).parents(t.options.selector),physicalId:u};".rich-container"===t.options.selector?p.updates={title:l}:".rich-object-title-editable"===t.options.target?p.updates={title:l}:p.updates={content:a},t.mediator.publish("onUpdateElement",p),t._padCommandProxy.refresh({authored:{modified:[n.physicalid]}})},onFailure:function(i,n){if(UWA.is(i,"string"))try{i=JSON.parse(i)}catch(e){}if(UWA.is(n,"string"))try{n=JSON.parse(n)}catch(e){}UWA.is(n)&&UWA.is(n.message,"string")?t.mediator.publish("onNotification",{className:"error",message:n.message}):UWA.is(i)&&UWA.is(i.message,"string")?t.mediator.publish("onNotification",{className:"error",message:i.message}):UWA.is(i,"string")?t.mediator.publish("onNotification",{className:"error",message:i}):console.error('"RequirementWebServices.edit(...)" failed without returning an error message!');var o={element:s(e.element.$).parents(t.options.selector)};".rich-container"===t.options.selector?o.refresh=["title"]:o.refresh=["content"],t.mediator.publish("onRefreshElement",o)}})},checkEditability:function(e,t){var i,n=this,o=g.get(),r=null,a=n.options.selector;if(e.target){var l=e.target;r=s(l).parents(a)[0].id}else if(e.editor.element.$){var p=e.editor.element.$;r=s(p).parents(a)[0].id}i=o.getRichObject(r),this.richObject=i;var u=i.cestamp,f=i.physicalId;return new _(function(i,o){d.getInfo({securityContext:c.getSecurityContext(),pid:f,selectables:"cestamp,current.access[modify],name,attribute[Title]",onComplete:function(o){var r=JSON.parse(o).results[0],a=m.RichView_Edition_ModifyAccess_DialogText,s=m.RichView_Edition_NotUpToDate_DialogText,l=m.RichView_Edition_ModifyAccess_DialogTitle,c=m.RichView_Edition_NotUpToDate_DialogTitle,d=!0;if(null==u){for(var p=g.get().options.model.getNodesById(f),v=0;v<p.length;v++){var b=p[v];b.options.title=""!==r["attribute[Title]"]?r["attribute[Title]"]:r.name,null!=b.options.elementRV&&(b.options.elementRV.cestamp=r.cestamp);var _=b.getRichViewElement();UWA.is(_)&&_.update({title:""!==r["attribute[Title]"]?r["attribute[Title]"]:r.name,cestamp:r.cestamp})}u=r.cestamp}"FALSE"===r["current.access[modify]"]?(d=!1,t?(n._buildKeepEditionDialog(e.editor,a,l),h.errorAlert(m.RichView_Edition_ModifyAccess_Warning)):(e.target.blur(),h.warningAlert(m.RichView_Edition_ModifyAccess_Warning))):"true"==richView.isConcurrentEngineeringEnabled&&r.cestamp!=u&&(d=!1,t?(n._buildKeepEditionDialog(e.editor,s,c),h.errorAlert(m.RichView_Edition_NotUpToDate_Warning)):(e.target.blur(),h.warningAlert(m.RichView_Edition_NotUpToDate_Warning))),i(d)},onFailure:function(e,t){console.log(t)}})})},cancel:function(e){this._logger.log("cancel"),this.editor.destroy(!0),this.mediator.publish("onCancel",e)},clearSemanticFormat:function(e){for(var t=["find-in-resultgreen","find-in-resultyellow","find-in-resultred"],i=0;i<t.length;++i)s("<p>"+e+"</P>").find("span."+t[i]).contents().unwrap();return console.log("RCE: Data cleared before save!"),e},clearSemanticFormatFromCKE:function(e){for(var t=["find-in-resultgreen","find-in-resultyellow","find-in-resultred"],i=0;i<t.length;++i)s(e.document.$).find("span."+t[i]).contents().unwrap();return e.getData()}});return w}),define("DS/RichView/Service/KeyboardShortcuts",["UWA/Class","UWA/Class/Events","DS/Logger/Logger","DS/PADUtils/PADContext","DS/TraceableRequirementsUtils/jQuery","text!DS/TraceableRequirementsUtils/assets/RequirementRelationshipsPatterns.json","i18n!DS/TraceableRequirementsUtils/assets/nls/TraceableRequirementsUtils"],function(e,t,i,n,o,r,a){"use strict";var s=null,l=e.singleton(t,{name:"KeyboardShortcuts",options:{},mediator:null,_logger:null,_defaultTypes:{},init:function(e){return s=this,this._logger=i.getLogger(l),this._relPattern=JSON.parse(r),this},addKeyboardEventListener:function(){this._logger.log("_addKeyboardEventListener"),document.addEventListener("keyup",this._objectCreation,!1)},removeKeyboardEventsListener:function(){this._logger.log("_removeKeyboardEventsListener"),document.removeEventListener("keyup",this._objectCreation,!1)},_objectCreation:function(e){var t=null,i=null,r=null,a=null,l=!1,c=n.get();if(e.altKey&&73===e.keyCode)l=!0,a="over",i=c.getDefaultType("Requirement"),r="Requirement",1===(d=c.getSelectedElement()).path.length?t=void 0:(s._relPattern[d.kindof]||s._relPattern[d.type]).Requirement?t=d.element:l=!1;else if(e.altKey&&74===e.keyCode){if(l=!0,a="over",i=c.getDefaultType("Chapter"),r="Chapter",1===(d=c.getSelectedElement()).path.length)t=void 0;else(s._relPattern[d.kindof]||s._relPattern[d.type]).Chapter?t=d.element:l=!1}else if(e.altKey&&71===e.keyCode){if(l=!0,a="after",i=c.getDefaultType("Requirement"),r="Requirement",1===(d=c.getSelectedElement()).path.length)(p=o(".rich-object:not(.placeholder),.rich-container")).size()>0?t=p.eq(p.size()-1):l=!1;else t=d.element}else if(e.altKey&&75===e.keyCode){var d,p;if(l=!0,a="after",i=c.getDefaultType("Chapter"),r="Chapter",1===(d=c.getSelectedElement()).path.length)(p=o(".rich-object:not(.placeholder),.rich-container")).size()>0?t=p.eq(p.size()-1):l=!1;else t=d.element}if(!0===l){var h={};UWA.is(t)&&(h={element:t,id:t.attr("id")});var u={target:h,position:a,operation:"insertNew",type:i,kindof:r,content:"",contentType:"html"};UWA.is(c)&&UWA.is(c.authoring)&&UWA.is(c.authoring.insertWithPromise)&&c.authoring.insertWithPromise(u)}else UWA.is(c)&&UWA.is(c.displayNotification)}});return l}),define("DS/RichView/mixins/_RichBIFilter",["UWA/Class","DS/PADUtils/PADUtilsServices"],function(e,t){"use strict";return e.extend({_biFilter:null,eventInit:!1,_id2removeFromFilterProxy:[],_filterAlreadyTreatedRoot:[],_isRootAddedFromFilter:!1,initializeBI:function(e){console.log("initializeBI");this._createProxy()},cleanProxy:function(){this._biFilter&&this._biFilter.cleanProxy&&this._biFilter.cleanProxy(),this._biFilter&&this._biFilter.resetNGFilterUI&&this._biFilter.resetNGFilterUI({widgetId:t.getWidgetId()}),this._filterAlreadyTreatedRoot=[]},onApplyNGFilter:function(e){var t=e||null;t=UWA.is(t,"string")?JSON.parse(t):t,UWA.is(this.applyFilter,"function")&&this.applyFilter(t),UWA.is(this.getModels,"function")&&UWA.is(this.getModels().applyFilter,"function")&&this.getModels().applyFilter(t)},onSetPathTags:function(){if(this._biFilter){this._biFilter.setPathTags({nodes:[],paths:[]});var e={nodes:[],paths:[]},t={};function i(n){if(!n.isHidden()){var o=n.getPath().map(function(i){return function(i){return t.hasOwnProperty(i)||(e.nodes.push(i),t[i]=e.nodes.length-1),t[i]}(i.getID())});e.paths.push(o);var r=n.getChildren();r&&r.forEach(function(e){i(e)})}}this.options.model.getRoots().forEach(function(e){i(e)}),this._biFilter.setPathTags(e)}},onSetTagsWithExpandSynthesis:function(){if(this._biFilter){var e=this;setTimeout(function(){var t=e.options.model.getRoots(),i=[];t.forEach(function(t){var n=t.getID();-1===e._filterAlreadyTreatedRoot.indexOf(n)&&(i.push(n),e._filterAlreadyTreatedRoot.push(n))});e._biFilter.setTagsWithExpandSynthesis&&i.length>0&&e._biFilter.setTagsWithExpandSynthesis(i,{type_filter_rel:["Sub Requirement Group","Requirement Group Content","Specification Structure","Sub Requirement","ParameterAggregation"]})})}},onFilterBIColorize:function(e){console.log("_RichBIFilter onFilterBIColorize"),this.options.model&&this.options.model.applyColor(e)},onFilterBIUnColorize:function(){console.log("_RichBIFilter onFilterBIUnColorize"),this.options.model&&this.options.model.applyColor()},onFilterBIFilteringEvent:function(e){var t=this.options.model;e&&Object.keys(e.allfilters).length,this.options.model.onUpdate(function(e){console.log("_RichBIFilter onNodeModelUpdate",e)});var i=t.getRoots(!0).slice(0);i.forEach(function(e){e.filterIn(!0)});var n=e.filteredSubjectList;if(n){for(var o=e.nodes,r=[],a={},s=function(e){return o[e]},l=0;l<n.length;l++){var c=n[l];a.hasOwnProperty(c)||r.push(c.map(s))}r.forEach(function(e){t.getNodesByIDPath(e).forEach(function(e){e._filterStatus="IN",e.getParents().forEach(function(e){e._filterStatus="IN"})})});i.forEach(function(e){!function e(t,i){if("IN"===t._filterStatus){var n=t.getChildren();n&&n.length>0&&n.slice(0).forEach(function(t){e(t)})}else{var o=t.getAllDescendants();o&&o.length>0&&o.slice(0).forEach(function(e){e.filterOut(),i&&i.push(e),delete e._filterStatus}),t.filterOut(),i&&i.push(t)}delete t._filterStatus}(e);var t=!1;if(e.options._childrenFilterInfo){var i=e.options._childrenFilterInfo.filteredOutChildren;i&&i.length>0&&(t=!0)}t&&(e.setState({state:"partiallyExpanded"}),e.options.padstate="partiallyExpanded"),t=!1});for(var d=[],p=0;p<r.length;p++){var h=r[p];d.push(h[h.length-1])}this.onSetPathTags()}else console.error("Invalid Argument : %o",e)},onFilterClose:function(e){if("dataFilterPanelCtn"===e.tag){var t=e||{};if(void 0===t.rootIds){t.rootIds=[];for(var i=this.options.model.getRoots(),n=0;n<i.length;n++)t.rootIds.push(i[n].getID())}this.disableFilterWaiting(t)}},_createProxy:function(){var e=this;require(["DS/ENOFilterBIUX/FilterBIComponentProxy"],function(i){var n={tenant:t.getPlatformId(),processingMode:"appProcessing",colorize:!0,widgetId:t.getWidgetId(),appId:t.getSharedId(),volumeFilterAvailable:0,ExpandSynthesisON:!0,synthesis_priority:1};UWA.is(e.onFilterFilteringEvent,"function")&&(n.events={addFilterChangeListener:e.onFilterFilteringEvent.bind(e)}),e._biFilter=new i(n),e._biFilter.addEvent("NGFilter_Close",e.onFilterClose,e),e._biFilter.addEvent("FilterBIUnColorize",e.onFilterBIUnColorize,e),e._biFilter.addEvent("FilterBIColorize",e.onFilterBIColorize,e),e._biFilter.addEvent("FilterBIFilteringEvent",e.onFilterBIFilteringEvent,e),e.options.model.getModelEvents().subscribe({event:"onRootAdded"},e.onSetTagsWithExpandSynthesis.bind(e));var o={expandServices:"expand",appID:t.getSharedId()};e._biFilter.setNGFilterOptions(o),e._biFilter.addEvent("ApplyNGFilter",e.onApplyNGFilter,e),e.options.model._isVolumeFilter=!0,e._biFilter.setSynthesisMode("occurrence"),e.filterInitialized=!0,e.dispatchEvent("filterInitialized",e.filterInitialized),e.eventInit=!0})},_colorChildren:function(){}})}),define("DS/RichView/Service/WidgetPreferences",["UWA/Class","UWA/Class/Events","DS/Logger/Logger","DS/TraceableRequirementsUtils/Services/RequirementSecurityCtxMgt","DS/TraceableRequirementsUtils/Services/RequirementTypeMgt","DS/TraceableRequirementsUtils/Services/RequirementTenantMgt","i18n!DS/RichView/assets/nls/RichView"],function(e,t,i,n,o,r,a){"use strict";return e.extend(t,{name:"richview_widgetpreferences",_logger:null,init:function(){this,this._logger=i.getLogger("DS/RichView/Service/WidgetPreferences")},addPreferencesToWidget:function(e){this._addSubcriptionToPreference(),this._addTenantMgtToPreference(e),this._addSecurityContextPreference(e),this._addTypeMgtToPreference(e)},_addSecurityContextPreference:function(e){this._logger.log("add security context management to the widget preferences"),n.addSecurityCtx2Preferences(e)},_addTypeMgtToPreference:function(e){this._logger.log("add requirement type management to the widget preferences"),o.addTypes2Preferences(e)},_addTenantMgtToPreference:function(e){this._logger.log("add tenant management to the widget preferences"),r.addTenant2Preferences(e)},_addSubcriptionToPreference:function(){this._logger.log("add TRA subscription management to the widget preferences"),widget.mergePreferences([{name:"subscribeToTRASelect",type:"boolean",label:a.RichView_SubscribeToTRA,defaultValue:"false"}])}})}),define("DS/RichView/Navigation",["UWA/Core","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/jQueryUI","DS/UIKIT/Scroller","DS/TraceableRequirementsUtils/Fancytree","i18n!DS/RichView/assets/nls/RichView","css!DS/RichView/RichView.css","css!../VENREQPlugins/External/fancytree/latest/media/skin-bootstrap/ui.fancytree.css"],function(e,t,i,n,o,r){"use strict";return function(e){var i=UWA.merge(e||{},{mediator:null,selector:"h1,h2,h3,h4",context:null}),o=function(e){var i=r.RichView_Headers_Navigation;return t('<div class="navigation-categories hidden-xs"><ul class="navigation-categories-list">\t<li class="active nav-headers" data-content="headers">'+i+"</li></div></ul>")},a=function(e){return t('<div class="navigation-content">\t<div class="navigation-headers active"></div></div>')},s=function(e){return t('<div class="navigation-list"></div><div class="top-border"><span class="fonticon fonticon-doc-text "></span>'+e.objects+' <span class="fonticon fonticon-book"></span>'+e.containers+"</div>")},l=function(e){return t('<div class="helpers">\t<p></p></div>')},c=null;return{inject:function(e){return c=this,this.options=i,this.mediator=i.mediator,this.context=i.context,this.container=e,this._navigationCategories(),this._init(),this},_subscribers:{subscribeToScroll:function(){c.mediator.subscribe("onScroll",function(e){e.position,c.update(e.position)})},subscribeToHelpersClick:function(){c.mediator.subscribe("onClick:helpers",function(){t(c.container+" .navigation-categories-list .nav-helpers").click()})},subscribeToHeadersClick:function(){c.mediator.subscribe("onClick:headers",function(){t(c.container+" .navigation-categories-list .nav-headers").click()})},subscribeToRefresh:function(){c.mediator.subscribe("onRefresh",function(e){c.refresh()})}},_init:function(){this._subscribers.subscribeToHelpersClick(),this._subscribers.subscribeToHeadersClick(),this._subscribers.subscribeToScroll(),this._subscribers.subscribeToRefresh(),this.isExpanded="expanded",this.navigation=t(this.container+" .navigation-headers").append(s({objects:t(".rich-object").length,containers:t(".rich-container").length})),this.helpers=t(this.container+" .navigation-helpers").append(l({}));try{t(".navigation-list").fancytree(this.getExplorerSettings())}catch(e){console.warn(error)}if(!this.isExpanded){var e=new Array;t(this.container).on("mouseover",".navigation-entry",function(i){var n=t(i.target);e.push(n),n.hasClass("expanded-temp-object")||n.parent().hasClass("expanded-temp-object")||(n.hasClass("navigation-entry")||(n=n.parent()),n.nextUntil(":not(.collapsed-object)").removeClass("collapsed-object").addClass("expanded-temp-object"))}),t(this.container).on("mouseleave",".navigation-list",function(t){for(var i=0;i<e.length;i++)e[i].nextUntil(":not(.expanded-temp-object)").removeClass("expanded-temp-object").addClass("collapsed-object")})}},_navigationCategories:function(){var e=t(this.container).append(o());t(this.container).append(a()),t(this.container+" .navigation-categories-list").on("click","li",function(i){var n=t(this);if(n.hasClass("active"))return!1;t(c.container+" .navigation-"+t("li.active",e).removeClass("active").addClass("not-active").data("content")).removeClass("active").addClass("not-active"),t(c.container+" .navigation-"+n.removeClass("not-active").addClass("active").data("content")).removeClass("not-active").addClass("active")})},_scrollView:function(e,i){var o=t(".navigation-content").height();t(e).height(o),c.scroller=new n({element:UWA.Element.getElement.call(document,this.container+" "+e)}).inject(UWA.Element.getElement.call(document,this.container+" "+i),"top")},update:function(e){var i,n,o=this.navigation;i=o.find(".fancytree-node").map(function(){var e=t(this),i=t("#"+e.data("id"));return null!==i&&i.is(":visible")?{top:i.position().top,node:e}:null}),n=null,t.each(i,function(e,t){t.node.removeClass("navigation-current"),(null===n||t.top<=0&&t.top>n.top)&&(n=t)}),n&&n.node.addClass("navigation-current")},refresh:function(){t(".navigation-list").fancytree("destroy"),c.scroller&&(c.scroller.destroy(),c.scroller=null),t(".navigation-list").empty(),t(".navigation-list").fancytree(this.getExplorerSettings())},resizeList:function(){var e=t(".navigation-content").height()-t(".top-border").height();t(".navigation-list").height(e)},getExplorerSettings:function(){var e=t(this.options.selector);if(0!==e.length){for(var i=[],n=0;n<e.length;n++){var o=e.eq(n);widget.getValue("trm_richview_DisableAutoNumbering")?i[n]={title:o.find(".rich-container-title-editable").text(),key:o.attr("id")}:i[n]={title:o.find(".rich-container-title").text(),key:o.attr("id")}}return{extensions:["dnd","glyph","wide"],checkbox:!1,dnd:{focusOnClick:!0,dragStart:function(e,t){return!0},dragEnter:function(e,t){return!0},dragOver:function(e,i){switch(i.hitMode){case"after":e.span.classList.remove("droppable-child"),(e.li.nextSibling&&!e.li.nextSibling.classList.contains("droppable-below")||!e.li.nextSibling&&e.isLastSibling())&&t(e.li).after('<div class="droppable-target droppable-below wux-datagrid-row-insertion-mark"></div>');break;case"before":e.span.classList.remove("droppable-child"),(e.li.previousSibling&&!e.li.previousSibling.classList.contains("droppable-below")||!e.li.previousSibling&&e.isFirstSibling())&&t(e.li).before('<div class="droppable-target droppable-below wux-datagrid-row-insertion-mark"></div>');break;case"over":e.li.previousSibling&&e.li.previousSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.previousSibling),e.li.nextSibling&&e.li.nextSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.nextSibling),e.span.classList.add("droppable-child")}},dragStop:function(e,t){e.li.previousSibling&&e.li.previousSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.previousSibling),e.li.nextSibling&&e.li.nextSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.nextSibling),e.span.classList.remove("droppable-child")},dragLeave:function(e,t){e.li.previousSibling&&e.li.previousSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.previousSibling),e.li.nextSibling&&e.li.nextSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.nextSibling),e.span.classList.remove("droppable-child")},dragDrop:function(e,i){e.li.previousSibling&&e.li.previousSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.previousSibling),e.li.nextSibling&&e.li.nextSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.nextSibling),e.span.classList.remove("droppable-child"),c.mediator.publish("onReorder",{source:{element:t("#"+i.otherNode.key),id:i.otherNode.key},target:{element:t("#"+e.key),id:e.key},position:i.hitMode,type:"rich-container"}),"over"===i.hitMode&&(i.hitMode="after"),i.otherNode.moveTo(e,i.hitMode)}},glyph:{map:{doc:"fonticon fonticon-book",docOpen:"glyphicon glyphicon-file",checkbox:"glyphicon glyphicon-unchecked",checkboxSelected:"glyphicon glyphicon-check",checkboxUnknown:"glyphicon glyphicon-share",dragHelper:"ffonticon fonticon-play",dropMarker:"fonticon fonticon-right",error:"glyphicon glyphicon-warning-sign",expanderClosed:"glyphicon glyphicon-plus-sign",expanderLazy:"glyphicon glyphicon-plus-sign",expanderOpen:"glyphicon glyphicon-minus-sign",folder:"glyphicon glyphicon-folder-close",folderOpen:"glyphicon glyphicon-folder-open",loading:"glyphicon glyphicon-refresh"}},selectMode:2,source:i,table:{nodeColumnIdx:1},wide:{iconWidth:"1em",iconSpacing:"0.5em",levelOfs:"1.5em"},activate:function(e,t){},lazyLoad:function(e,t){t.result={url:"ajax-sub2.json",debugDelay:1e3}},click:function(e,t){c.mediator.publish("onNavigationClick",t.node.key)},renderNode:function(e,t){var i=t.node;i.span.setAttribute("data-id",i.key)},init:function(){try{c._scrollView(".navigation-list",".navigation-headers")}catch(e){}}}}}}}}),define("DS/RichView/Command/CreateLinkAction",["UWA/Core","UWA/Class","DS/UIKIT/SuperModal","DS/UIKIT/Input/Toggle","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/TraceableRequirementsUtils/Utils","DS/PlatformAPI/PlatformAPI","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/REQCommandProxy","UWA/Drivers/Alone","DS/Logger/Logger","DS/PADUtils/PADContext","i18n!DS/RichView/assets/nls/RichView","i18n!DS/RichView/assets/nls/CreateLinkAction","css!DS/RichView/RichView.css"],function(e,t,i,n,o,r,a,s,l,c,d,p,h,u){"use strict";var g=function(e){return'<div class="toggle create-link-options"><input type="radio" name="radios" id="radio'+e.index+'" value="'+e.rel+'"><label class="control-label" for "radio1">'+e.label+"</label></div>"},f="ENORERE_AP.StartLink",m=null,v=t.singleton({name:"CreateLinkCommand",context:null,defaultOptions:{renderTo:".content-panel",relationship:void 0},_superDlg:null,_commandProxy:null,_initialized:!1,_scopeId:null,_notifSMV:null,_widgetIdSMV:null,init:function(e){return m=this,this._logger=d.getLogger(v),this._logger.log("init"),UWA.merge(e||{},m.defaultOptions),this._parent(e),this.context=p.get(),this._commandProxy=new l,this.getScopeFromStorage(),this.subscribeToSMVContextModification(),this._initialized=!0,this},setStartLink:function(e){sessionStorage.removeItem(f),sessionStorage.setItem(f,JSON.stringify(e))},getStartLink:function(){var e=sessionStorage.getItem(f);return UWA.is(e,"string")?JSON.parse(e):e},getScopeFromStorage:function(){try{var e=JSON.parse(localStorage.getItem("TRA-current-scope")),t=m._formatMessage(e);m._onSMVContextChanged(t)}catch(e){m._logger.log("Failed to retrieve TRA-current-scope")}},subscribeToSMVContextModification:function(){UWA.is(m._notifSMV)||(m._logger.log("Subscribing to topic: DS/CATSmmUI/3DExperience/Proxy/contextChanged"),m._notifSMV=a.subscribe("DS/CATSmmUI/3DExperience/Proxy/contextChanged",function(e){m._onSMVContextChanged(e)})),!1===widget.hasEvent("onCheckScopeRV")&&widget.addEvent("onCheckScopeRV",function(e){m.getScopeFromStorage()})},_formatMessage:function(e){var t={resources:[],widgetId:e.widgetId};if(UWA.is(e.scope)&&UWA.is(e.scope.id)){var i=e.scope.id,n=e.scope.types,o=e.scope.title;t.resources.push({id:i,types:n,title:o})}return t},_onSMVContextChanged:function(e){var t=JSON.parse(localStorage.getItem("TRA-current-scope")),i=m._formatMessage(t);if(UWA.is(i.resources)&&i.resources.length>0){t=i.resources[0];UWA.is(t.types[0])&&"http://www.3ds.com/vocabularies/syc/type/Scope"===t.types[0]?m._setScope(t.id,i.widgetId,t.title):m._cleanScope()}else m._cleanScope()},_setScope:function(e,t,i){m._scopeId=e,m._widgetIdSMV=t,m.context.updateScopeInformation(i),m.context.setTraceabiltyScope(e,i)},_cleanScope:function(){m._scopeId=null,m._widgetIdSMV=null,m.context.updateScopeInformation(h.RichView_DefaultValue_None),m.context.setTraceabiltyScope(null,null)},execute:function(e){m._initUI(m.defaultOptions.renderTo),m.defaultOptions.to=e.to,m.defaultOptions.from=e.from,UWA.is(m._scopeId)?m._getScopeInformation():m._displayDialogCoverRefine()},_initUI:function(e){m._superDlg=new i({closable:!0,renderTo:UWA.Element.getElement.call(document,e)})},_getScopeInformation:function(){o.getScopeInformation({scopeId:m._scopeId,onComplete:function(e){m._logger.log("RequirementWebServices.getScopeInformation onComplete");var t=UWA.is(e,"string")?JSON.parse(e):e;m._checkScopeContent(t)},onFailure:function(e){m._logger.log("RequirementWebServices.getScopeInformation onFailure"),m._displayDialog()},onTimeout:function(e){m._logger.log("RequirementWebServices.getScopeInformation onTimeout"),m._displayDialog()}})},_checkScopeContent:function(e){for(var t=e.roots,i=e.links,n=!1,o=Object.keys(t),r=0;r<o.length;r++){var a=t[o[r]];if("http://www.3ds.com/vocabularies/syc/type/Enovia.Requirement%20Specification"===a.type){var s=a.id;if(s.substr(s.lastIndexOf("/")+1)===m.defaultOptions.from.path[0]){var l=a.outLinks;if(!0===(n=m._checkLinks(t,i,l,"to",m.defaultOptions.to.path[0],"Upstream Derived Requirement")))break;var c=a.inLinks;if(!0===(n=m._checkLinks(t,i,c,"from",m.defaultOptions.to.path[0],"Derived Requirement")))break}}}!0===n?m._createLink():m._displayDialog()},_checkLinks:function(e,t,i,n,o,r){for(var a=!1,s=0;s<i.length;s++){for(var l=t[i[s]][n],c=0;c<l.length;c++){var d=e[l[c]],p=d.id;if(p=p.substr(p.lastIndexOf("/")+1),"http://www.3ds.com/vocabularies/syc/type/Enovia.Requirement%20Specification"===d.type&&p===o){m.defaultOptions.relationship=r,a=!0;break}}if(!0===a)break}return a},_displayDialog:function(){var e=["Downstream Derived Requirement","Upstream Derived Requirement"],t=m.defaultOptions.from.typeNls?m.defaultOptions.from.typeNls:m.defaultOptions.from.type,i=m.defaultOptions.to.typeNls?m.defaultOptions.to.typeNls:m.defaultOptions.to.type,n="<div>",o=t+' "'+m.defaultOptions.from.title+'"';o=o.length>40?o.substr(0,39)+'..."':o;var r=i+' "'+m.defaultOptions.to.title+'"';r=r.length>40?r.substr(0,39)+'..."':r;for(var a=0;a<e.length;a++){var l=e[a];l=l.split(" ").join("_");var c=u[l="CreateLinkAction_"+l];c=(c=c.replace("{first_object}",o)).replace("{second_object}",r),n+=g({index:a,rel:e[a],label:c})}n+="</div>",m._superDlg.dialog({title:u.CreateLinkAction_SelectRelationship,body:s(n),buttons:[{value:u.CreateLinkAction_Cancel,action:function(e){m._cancel(e)}},{value:u.CreateLinkAction_Confirm,action:function(e){m._confirm(e)}}]}),s("input[name=radios]")[0].checked=!0},_displayDialogCoverRefine:function(){var e=["Downstream Derived Requirement","Upstream Derived Requirement"],t=m.defaultOptions.to.typeNls?m.defaultOptions.to.typeNls:m.defaultOptions.to;if(null!=t&&null!=t&&0!=t.length){var i="<div>",n=(m.defaultOptions.from.typeNls?m.defaultOptions.from.typeNls:m.defaultOptions.from.type)+' "'+m.defaultOptions.from.title+'"';n=n.length>40?n.substr(0,39)+'..."':n;for(var o="",r=0;r<t.length;r++){t[r].type;o=o+" "+(t[r].typeNls?t[r].typeNls:"Requirements ")+' "'+m.defaultOptions.to[r].title+'" '}for(r=0;r<e.length;r++){var a=e[r];a=a.split(" ").join("_");var l=u[a="CreateLinkAction_"+a];l=(l=l.replace("{first_object}",n)).replace("{second_object}",o),i+=g({index:r,rel:e[r],label:l})}i+="</div>",m._superDlg.dialog({title:u.CreateLinkAction_SelectRelationship,body:s(i),buttons:[{value:u.CreateLinkAction_Cancel,action:function(e){m._cancel(e)}},{value:u.CreateLinkAction_Confirm,action:function(e){m._confirm(e)}}]}),s("input[name=radios]")[0].checked=!0}},_cancel:function(e){e.hide()},_confirm:function(e){m.defaultOptions.relationship=s("input[name=radios]:checked",e.elements.content).val(),e.hide(),m._createEndLink()},_createLink:function(){var e,t,i=null;"Downstream Derived Requirement"===m.defaultOptions.relationship?(e="Derived Requirement",t=m.defaultOptions.from.id,i=m.defaultOptions.to.id):"Upstream Derived Requirement"===m.defaultOptions.relationship?(e="Derived Requirement",t=m.defaultOptions.to.id,i=m.defaultOptions.from.id):(e=m.defaultOptions.relationship,t=m.defaultOptions.from.id,i=m.defaultOptions.to.id);var n={dataArray:[]};n.dataArray.push({pid:t,id:i,relationship:e}),o.connect({securityContext:r.getSecurityContext(),json:n,onComplete:function(e){e=JSON.parse(e);m._displayNotification({className:"success",message:u.CreateLinkAction_Success});var t=widget.getUrl(),i=((t=t.substr(0,t.indexOf("/webapps"))).substr(t.lastIndexOf("/")+1),"Upstream Derived Requirement"===m.defaultOptions.relationship?"covered":"refined");e={from:m.defaultOptions.from,to:m.defaultOptions.to,link_type:i,connection:e.results.Success["type[connection]"],connectionId:e.results.Success["id[connection]"],widgetid:widget.id,contextId:r.getSecurityContext()};m._commandProxy.traceabilityAuthoring({data:e,appId:widget.getValue("appId"),event:"create"}),UWA.is(m._scopeId)&&setTimeout(function(){m._logger.log("Publish topic DS/CATSmmUI/3DExperience/Proxy/refresh"),a.publish("DS/CATSmmUI/3DExperience/Proxy/refresh",{resources:[m._scopeId+"/traceability_model"],widgetId:m._widgetIdSMV,clearCache:!0})},500)},onFailure:function(e,t){var i=e.message;t=UWA.is(t,"string")?JSON.parse(t):t,UWA.is(t.message)&&(i=t.message),m._displayNotification({className:"error",message:i})}})},_createEndLink:function(){var e,t=null,i={dataArray:[]};"Downstream Derived Requirement"===m.defaultOptions.relationship?("Downstream Derived Requirement",e=m.defaultOptions.from.id,m.defaultOptions.to.forEach(t=>{i.dataArray.push({pid:e,id:t.id,relationship:"Derived Requirement",previousSibling:{},nextSibling:{}})})):"Upstream Derived Requirement"===m.defaultOptions.relationship?("Upstream Derived Requirement",t=m.defaultOptions.from.id,m.defaultOptions.to.forEach(e=>{i.dataArray.push({pid:e.id,id:t,relationship:"Derived Requirement",previousSibling:{},nextSibling:{}})})):(m.defaultOptions.relationship,e=m.defaultOptions.from.id,m.defaultOptions.to.forEach(t=>{i.dataArray.push({pid:e,id:t.id,relationship:"Derived Requirement",previousSibling:{},nextSibling:{}})})),o.endLinkConnect({securityContext:r.getSecurityContext(),json:i,onComplete:function(e){e=JSON.parse(e);m._displayNotification({className:"success",message:u.CreateLinkAction_Success});for(var t=widget.getUrl(),i=((t=t.substr(0,t.indexOf("/webapps"))).substr(t.lastIndexOf("/")+1),"Upstream Derived Requirement"===m.defaultOptions.relationship?"covered":"refined"),n=e.results,o=0;o<n.length;o++){var s=n[o],l={from:m.defaultOptions.from,to:m.defaultOptions.to[o],link_type:i,connection:s["type[connection]"],connectionId:s["id[connection]"],widgetid:widget.id,contextId:r.getSecurityContext()};m._commandProxy.traceabilityAuthoring({data:l,appId:widget.getValue("appId"),event:"create"})}sessionStorage.removeItem(f),UWA.is(m._scopeId)&&setTimeout(function(){m._logger.log("Publish topic DS/CATSmmUI/3DExperience/Proxy/refresh"),a.publish("DS/CATSmmUI/3DExperience/Proxy/refresh",{resources:[m._scopeId+"/traceability_model"],widgetId:m._widgetIdSMV,clearCache:!0})},500)},onFailure:function(e,t){var i=e.message;t=UWA.is(t,"string")?JSON.parse(t):t,UWA.is(t.message)&&(i=t.message),m._displayNotification({className:"error",message:i})}})},_displayNotification:function(e){UWA.is(m.context)&&UWA.is(m.context.displayNotification)?m.context.displayNotification({eventID:e.className,msg:e.message}):alert(e.message)}});return v}),define("DS/RichView/ActionBar",["DS/Core/Core","DS/ApplicationFrame/FrameWindow","DS/RuntimeView/NLSManager","DS/Core/ModelEvents","css!DS/RichView/RichView.css"],function(e,t,i,n){"use strict";return function(o){var r=UWA.merge(o||{},{mediator:null}),a="trm-richview";return{inject:function(){e.setFullscreen(),this.options=r,this.mediator=r.mediator,this._modelEvents=new n,i.DEFAULT_LANGUAGE=widget.lang?widget.lang:widget.getValue("lang"),i.loadResource({resourceFile:"RichView/RichView"}),i.onResourceLoaded({resourceFile:"RichView/RichView",language:widget.lang?widget.lang:widget.getValue("lang")},function(){}),widget.frmWindow=new t({workbenchModule:"RichView",workbench:"RichView.xml",viewer:"none",height:"100%"}).inject(widget.body);var o=widget.frmWindow.getViewerFrame();return new UWA.Element("div",{id:a}).inject(o),widget.frmWindow.onActionBarReady(function(){o.style.height=o.parentNode.offsetHeight-70+"px",this._modelEvents.subscribe({event:"ACTIONBAR_OPEN"},function(e){o.style.height=o.parentNode.offsetHeight-70+"px"}),this._modelEvents.subscribe({event:"ACTIONBAR_CLOSE"},function(e){o.style.height=o.parentNode.offsetHeight-20+"px"})}),a}}}}),define("DS/RichView/Command/CtxMenu_StartLinkCmd",["DS/ApplicationFrame/Command"],function(e){"use strict";return e.extend({init:function(e){this._parent(e,{isAsynchronous:!0}),this.TOPIC_NAME="ENORERE_AP.StartLink"},execute:function(e){sessionStorage.removeItem(this.TOPIC_NAME),sessionStorage.setItem(this.TOPIC_NAME,JSON.stringify(e))}})}),define("DS/RichView/Models/RichViewDocument",["DS/Logger/Logger","DS/Tree/TreeDocument"],function(e,t){"use strict";var i=null;return t.extend({init:function(e){i=this,this._parent(e)},sortInTreeOrder:function(e){e&&e.forEach(function(e){e.sortChildren({isRecursive:!0,sortFunction:function(e,t){if(e.options&&t.options){if(e.options.relationOrder<t.options.relationOrder)return-1;if(e.options.relationOrder>t.options.relationOrder)return 1}return 0}})})},reparentNode:function(e,t,n,o,r,a){t.removeChild(e),e.setRelationID(r),e.setRelationOrder(o),e.setParentID(n.getID()),n.addChild(e),e.setRelationType(a);var s=e.getLevel(),l=-1,c=e.getBrothers();UWA.is(c)&&c.length>0?(l=c[0].getLevel(),UWA.is(a)&&""!==a||(a=c[0].getRelationType())):l=n.getLevel()+1,e.setLevel(l),e.setRelationType(a);for(var d=l-s,p=e.getAllDescendants(),h=0;h<p.length;h++){var u=p[h].getLevel()+d;p[h].setLevel(u)}i.sortInTreeOrder([n])},getNodesById:function(e){var t=[];return this.getRoots().forEach(function(i){var n=i.getNodesById(e);t=t.concat(n)}),t},getNodesByMatrixID:function(e){var t=[];return this.getRoots().forEach(function(i){var n=i.getNodesByMatrixID(e);t=t.concat(n)}),t},getNodeByOccurencePath:function(e){for(var t=this.getRoots(),i=0;i<t.length;i++){var n=t[i].getNodeByPath(e,void 0,void 0,!0);if(n)return n}},getNodesByRelId:function(e){var t=[];return this.getRoots().forEach(function(i){var n=i.getNodesByRelId(e);t=t.concat(n)}),t},getNodesByElementID:function(e){var t=[];return this.getRoots().forEach(function(i){var n=i.getNodesByElementID(e);t=t.concat(n)}),t},getNodesByIDPath:function(e){var t=[];return this.getRoots().forEach(function(i){!function e(t,i,n,o){if(t.getID()===i[n])if(n===i.length-1)o.push(t);else{var r=t.getChildren();r&&r.length>0&&(n+=1,r.forEach(function(t){e(t,i,n,o)}))}}(i,e,0,t)}),t}})}),define("DS/RichView/Views/RichViewInfos",["i18n!DS/RichView/assets/nls/RichView","css!DS/RichView/RichView.css","UWA/Core","UWA/Controls/Abstract","UWA/Class/Options","UWA/Drivers/Alone","DS/Logger/Logger","DS/UIKIT/Tooltip","DS/UIKIT/Popover"],function(e,t,i,n,o,r,a,s,l){"use strict";var c=n.extend(o,{name:"richview_infos",_logger:null,_tooltip:null,init:function(e){this._logger=a.getLogger(c),this._logger.log("init"),this._parent(e),this.elements.container=UWA.createElement("span",{class:this.getClassNames()+" fonticon fonticon-info"}),this._tooltip=new s({className:this.getClassNames("_tooltip"),target:this.elements.container,position:"left",body:this.buildInfos()}),this.getOption("renderTo")&&this.inject(this.getOption("renderTo"))},setBody:function(){this._tooltip.setBody(this.buildInfos())},buildInfos:function(){var t=UWA.createElement("div",{class:"richview_infos_msg"}),i=e.RichView_Tooltip_InsertReqAsChild+", "+e.RichView_Tooltip_InsertReqAsSibling+", "+e.RichView_Tooltip_InsertChapAsChild+", "+e.RichView_Tooltip_InsertChapAsSibling;return UWA.createElement("div",{text:i}).inject(t),t}});return c}),define("DS/RichView/Views/DropInvit",["DS/TraceableRequirementsUtils/jQuery","i18n!DS/RichView/assets/nls/RichView","UWA/Core","UWA/Controls/Abstract","UWA/Class/Options","DS/PADUtils/PADContext","DS/HomePage/HomePage","text!DS/RichView/assets/RichViewSetting.json","css!DS/RichView/RichView.css"],function(e,t,i,n,o,r,a,s){"use strict";var l=null,c=JSON.parse(s);return n.extend(o,{name:"richview_main",mediator:null,_selector:null,_context:null,init:function(e){this._context=r.get(),this._parent(e),l=this,this.elements.container=i.createElement("div",{class:this.getClassNames("_container")}),this.elements.container.invite=i.createElement("div",{class:this.getClassNames("_invite")}),this.elements.container.homepage=new a({widget:widget,settings:c,isRichView:!0}).inject(this.elements.container),this.elements.container.invite.drop=i.createElement("div",{class:this.getClassNames("_display drop"),draggable:!1}).inject(this.elements.container.invite),i.createElement("span",{class:this.getClassNames("_img wux-ui-3ds wux-ui-3ds-5x wux-ui-3ds-drag-drop")}).inject(this.elements.container.invite.drop),i.createElement("h5",{class:this.getClassNames("_txt font-3dsregular drop"),text:t.RichViewDropInvit_Drop}).inject(this.elements.container.invite.drop),this.elements.container.invite.inject(this.elements.container),this.getOption("renderTo")&&this.elements.container.inject(i.Element.getElement.call(document,this.getOption("renderTo"))),this._droppable(this.getOption("selector")),this._selector=this.getOption("selector"),this.mediator=this.getOption("mediator")},show:function(){this.elements.container.show()},hide:function(){this.elements.container.hide()},remove:function(){this._notDroppable(this._selector),this.elements.container.remove()},_onDragEnter:function(t){e(t).addClass("bordered")},_onDragLeave:function(t){e(t).removeClass("bordered")},_onDragEnd:function(t){e(t).removeClass("bordered")},_onDragOver:function(t,i){i.preventDefault&&i.preventDefault(),i.originalEvent.dataTransfer.dropEffect="copy",e(t).addClass("bordered")},_onDrop:function(t,n){if(n.originalEvent.dataTransfer){n.stopPropagation&&n.stopPropagation(),n.preventDefault&&n.preventDefault(),e(t).removeClass("bordered");var o=!!document.documentMode?"text":"text/searchitems";window.navigator.userAgent.indexOf("Edge/")>0&&(o="text/plain");var r=n.originalEvent.dataTransfer.getData(o);if(i.is(r)&&""!==r){var a=JSON.parse(r).data.items;if(a.length>0){var s=a[0].objectId,c=l.getOption("mediator");l._notDroppable(t),l.elements.container.remove(),i.is(l._context)&&i.is(l._context._onInitialDrop)?l._context._onInitialDrop(s):c.publish("onInitialDrop",s)}}}},_droppable:function(t){e(t).on("dragenter",function(){l._onDragEnter(t)}),e(t).on("dragleave",function(){l._onDragLeave(t)}),e(t).on("dragend",function(){l._onDragEnd(t)}),e(t).on("dragover",function(e){return l._onDragOver(t,e),!1}),e(t).on("drop",function(e){l._onDrop(t,e),e.stopImmediatePropagation()})},_notDroppable:function(t){e(t).off("dragenter"),e(t).off("dragover"),e(t).off("dragend"),e(t).off("dragleaver"),e(t).off("drop")}})}),define("DS/RichView/mixins/_delimiterUtilities",["UWA/Class"],function(e){return e.extend({_DELIMITER:""})}),define("DS/RichView/Views/RichViewIdCard",["UWA/Core","UWA/Class","DS/Logger/Logger","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/jQuery","DS/PADUtils/PADContext","i18n!DS/RichView/assets/nls/RichView","css!DS/RichView/RichView.css"],function(e,t,i,n,o,r,a,s){var l=function(e){return r('<div id="'+e.id+'" data-physicalid="'+e.physicalid+'" class="richview-idcard"></div>')},c=function(e){return r('<div class="richview-idcard-thumbnail"><div class="richview-idcard-title"><span class="trm-icon-large trm-icon-'+e.icon+'"></span> '+e.title+"</div></div>")},d=function(e){return r('<div class="richview-idcard-selection"><div><span class="richview-idcard-property richview-idcard-padding">'+s.RichView_Headers_Containers+'</span><span class="richview-idcard-value">'+e.containers+'</span></div><div><span class="richview-idcard-property richview-idcard-padding">'+s.RichView_Headers_Objects+'</span><span class="richview-idcard-value">'+e.objects+'</span></div><div><span class="fonticon fonticon-close richview-idcard-delete" title="'+s.RichView_Tooltip_CleanSelection+'"></span><span class="richview-idcard-property richview-idcard-selected">'+s.RichView_Headers_Selected+'</span><span class="richview-idcard-value richview-idcard-link" data-id="'+e.id+'">'+e.selected+"</span></div></div>")},p=function(e){return r('<div class="richview-idcard-lifecycle"><span class="richview-idcard-property">'+s.RichView_Headers_Status+'</span><span class="richview-idcard-value">'+e.state+"</span></div>")},h=function(e){return r('<div class="richview-idcard-traceability"><span class="richview-idcard-property">'+s.RichView_Headers_TraceabilityScope+'</span><span class="richview-idcard-value">'+e.scope+"</span></div>")},u=null,g=t.extend({name:"richview_identitycard",physicalid:null,container:null,init:function(e){u=this,this._parent(e),this._logger=i.getLogger(g),this._logger.log("init Id card"),this.physicalid=e.physicalid,this.container=e.container,this.buildIdCard(this.physicalid)},_inject:function(e){this.container=e,this.container.prepend(this._idCardContainer),this.hideCleanSelection(),this.container.on("click",".richview-idcard-link",function(e){UWA.is(this.dataset.id)&&""!==this.dataset.id&&a.get().scrollToElement(this.dataset.id)}),this.container.on("click",".richview-idcard-delete",function(e){r(".content-panel").find(".rich-object.active,.rich-container.active").toggleClass("active",!1),a.get().onCleanSelection(!0)})},updateSelection:function(){var e=r(".rich-container:not(.fake-rich-container)").length,t=r(".rich-object").length,i=s.RichView_DefaultValue_None,n="",o=a.get().getSelectedNodes()[0];a.get().getSelectedElement();!1===o.isRoot()?(n=o.getRichViewElementID(),i=o.options.title):(i=s.RichView_DefaultValue_None,n="");var l=d({containers:e,objects:t,selected:i,id:n});UWA.is(this._idCardSelection)&&(this._idCardSelection.replaceWith(l),this._idCardSelection=l),i!==s.RichView_DefaultValue_None?(r(".richview-idcard-link").addClass("richview-underline"),this.showCleanSelection()):this.hideCleanSelection()},showCleanSelection:function(){UWA.is(this._idCardSelection)&&(this._idCardSelection.find(".richview-idcard-delete").toggleClass("hidden",!1),this._idCardSelection.find(".richview-idcard-selected").toggleClass("richview-idcard-padding",!1))},hideCleanSelection:function(e){UWA.is(this._idCardSelection)&&(this._idCardSelection.find(".richview-idcard-delete").toggleClass("hidden",!0),this._idCardSelection.find(".richview-idcard-selected").toggleClass("richview-idcard-padding",!0))},updateThumbnail:function(e,t){var i=c({icon:e.toLowerCase().replace(" ","-"),title:t});this._idCardThumbnail&&this._idCardThumbnail.replaceWith(i),this._idCardThumbnail=i},updateLifecyle:function(e){var t=p({state:e});this._idCardLifecycle&&this._idCardLifecycle.replaceWith(t),this._idCardLifecycle=t,this._idCardLifecycle.append(this._idCardScope)},updateScope:function(e){var t=h({scope:e});this._idCardScope&&this._idCardScope.replaceWith(t),this._idCardScope=t},buildIdCard:function(e){n.getInfo({securityContext:o.getSecurityContext(),pid:e,selectables:"type,name,revision,attribute[Title],type.kindof,physicalid,current",onComplete:function(e){var t=(e=UWA.is(e,"string")?JSON.parse(e):e).results[0];u._buildView(t),u._inject(u.container)},onFailure:function(e){},onTimeout:function(){}})},_buildView:function(e){var t=l({id:e.physicalid+"_idcard",physicalid:e.physicalid}),i=c({icon:e["type.kindof"].toLowerCase().replace(" ","-"),title:e["attribute[Title]"]}),n=d({containers:"0",objects:"0",selected:s.RichView_DefaultValue_None}),o=p({state:e.current.displayName}),r=s.RichView_DefaultValue_None,u=a.get().getTraceabilityScope();UWA.is(u)&&UWA.is(u.title)&&(r=u.title);var g=h({scope:r});return o.append(g),t.append(i).append(n).append(o),this._idCardContainer=t,this._idCardThumbnail=i,this._idCardLifecycle=o,this._idCardSelection=n,this._idCardScope=g,t}});return g}),define("DS/RichView/Models/RichViewModel",["DS/ENXNav/models/xNavNodeModel","DS/PADUtils/PADSettingsMgt","DS/PADServices/utils/AttributesMgt"],function(e,t,i){"use strict";function n(e){e._getFilterInfo||(e._getFilterInfo=o.prototype._getFilterInfo.bind(e),e._getChildrenFilterInfo=o.prototype._getChildrenFilterInfo.bind(e),e._removeChildrenFilterInfo=o.prototype._removeChildrenFilterInfo.bind(e),e.filterInChild=o.prototype.filterInChild.bind(e),e.filterOutChild=o.prototype.filterOutChild.bind(e))}function o(t){this.options={matrixID:null,physicalID:null,elementID:null,elementRV:null,type:"",kindof:"",title:"",name:"",revision:"",content:"",relationtype:"",relationid:null,parentID:"",level:0,editable:!0,isDocx:!1,format:"html"},UWA.is(t.relcount)&&0===t.relcount&&(t.children=null),this.tenant=t.tenant,this.options=UWA.extend(this.options,t),e.call(this,this.options)}return o.prototype=Object.create(e.prototype),o.prototype.setParentID=function(e){this.options.parentID=e},o.prototype.getParentID=function(){return this.options.parentID},o.prototype.setLevel=function(e){this.options.level=e},o.prototype.getLevel=function(){return this.options.level},o.prototype.setRelationOrder=function(e){this.options.relationOrder=e},o.prototype.getRelationOrder=function(){return this.options.relationOrder},o.prototype.getRelationType=function(){return this.options.relationtype},o.prototype.setRelationType=function(e){this.options.relationtype=e},o.prototype.setRichViewElementID=function(e){this.options.elementID=e},o.prototype.getRichViewElementID=function(){return this.options.elementID},o.prototype.setRichViewElement=function(e){this.options.elementRV=e},o.prototype.getRichViewElement=function(){return this.options.elementRV},o.prototype.getNodesByMatrixID=function(e){var t={listOfFoundNodes:[],foundId:void 0};return this._getNodesByMatrixID(e,t),t.listOfFoundNodes},o.prototype._getNodesByMatrixID=function(e,t){var i=this.options.matrixID,n=this.getID();if(i===e)t.listOfFoundNodes.push(this),t.foundId=n;else if(n!==t.foundId){var o=this.getChildren();if(o)for(var r=0;r<o.length;r++)o[r]._getNodesByMatrixID(e,t)}},o.prototype.getNodesByElementID=function(e){var t={listOfFoundNodes:[],foundId:void 0};return this._getNodesByElementID(e,t),t.listOfFoundNodes},o.prototype._getNodesByElementID=function(e,t){var i=this.options.elementID,n=this.getID();if(i===e)t.listOfFoundNodes.push(this),t.foundId=n;else if(n!==t.foundId){var o=this.getChildren();if(o)for(var r=0;r<o.length;r++)o[r]._getNodesByElementID(e,t)}},o.prototype._removeFilterInfo=function(){delete this.options._filterInfo},o.prototype._removeChildrenFilterInfo=function(){delete this.options._childrenFilterInfo},o.prototype._getFilterInfo=function(e){return!this.options._filterInfo&&Boolean(e)&&(this.options._filterInfo={}),this.options._filterInfo},o.prototype._getChildrenFilterInfo=function(e){return!this.options._childrenFilterInfo&&Boolean(e)&&(this.options._childrenFilterInfo={}),this.options._childrenFilterInfo},o.prototype.filterOut=function(){var e=this.isRoot()?this.getTreeDocument():this.getParent();null!==e&&(n(e),e.filterOutChild(this))},o.prototype.filterIn=function(e){var t=this._getFilterInfo();if(t&&t.parentBeforeFiltering){var i=t.parentBeforeFiltering;n(i),i.filterInChild(this)}if(Boolean(e)){var o,r=this._getChildrenFilterInfo();(o=r&&r.childrenBeforeFiltering?r.childrenBeforeFiltering:this.getChildren())&&o.forEach(function(t){t.filterIn(e)})}},o.prototype.filterOutChild=function(e){var t=this.getChildren();if(t.indexOf(e)<0)throw"Not a child";var i=this._getChildrenFilterInfo(!0);if(!i.childrenBeforeFiltering){i.childrenBeforeFiltering=t&&t.length>0?t.slice(0):[];UWA.is(this._expandState)&&(i.expandStateBeforeFiltering={noExpandState:"noChildren",expandingState:"expanding",partiallyExpandedState:"partiallyExpanded",collapseState:"expanded",expandState:"collapsed",noChildren:"noChildren",expanding:"expanding",partiallyExpanded:"partiallyExpanded",expanded:"expanded",collapsed:"collapsed"}[this._expandState])}e._getFilterInfo(!0).parentBeforeFiltering=this,UWA.is(this.removeChild,"function")&&(this.removeChild(e),e.options.elementRV.hide()),UWA.is(this.setState,"function")&&this.setState({state:i.expandStateBeforeFiltering}),i.filteredOutChildren||(i.filteredOutChildren=[]),i.filteredOutChildren.push(e)},o.prototype.filterInChild=function(e){var t=this._getChildrenFilterInfo();if(t){var i=t.childrenBeforeFiltering;if(i){var n=i.indexOf(e);if(n>=0){var o=e._getFilterInfo();if(o&&o.parentBeforeFiltering===this){var r,a=this.getChildren();if(a)for(var s=0;s<a.length;s++){var l=a[s];if(i.indexOf(l)>n){r=l;break}}delete o.parentBeforeFiltering,e.isRoot()||(void 0!==e.options.isRootAttached?!0===e.options.isRootAttached&&(this.insertBefore(e,r),e.options.elementRV.show()):(this.insertBefore(e,r),UWA.is(e.options.elementRV)&&e.options.elementRV.show())),UWA.is(this.setState,"function")&&this.setState({state:t.expandStateBeforeFiltering}),e._removeFilterInfo();var c=t.filteredOutChildren.indexOf(e);t.filteredOutChildren.splice(c,1),0===t.filteredOutChildren.length&&this._removeChildrenFilterInfo()}}}}},o.prototype.matchString=function(e){if(!e||""==e)return!1;var t=e.toLowerCase();if((this.options.title||"").toLowerCase().includes(t)||(this.options.name||"").toLowerCase().includes(t)||(this.options.kindof||"").toLowerCase().includes(t)||(this.options.type.value||this.options.type||"").toLowerCase().includes(t))return!0;var i=e,n=e;i=i.replace(new RegExp("\\$","g"),"[$]");var o=new RegExp(i,"gi"),r="",a="";this.options.elementRV.content&&this.options.elementRV.content.length>0&&this.options.elementRV.content[0].innerText&&(r=this.options.elementRV.content[0].innerHTML,a=this.options.elementRV.content[0].innerText);var s=a.search(o);if(-1!=s){for(var l,c=[],d=[];l=o.exec(a);)-1==c.indexOf(l[0])&&(c.push(l[0]),d.push(l));for(var p=0;p<c.length;p++){s=d[p].index;var h=a.substring(s,s+n.length).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),u=new RegExp(h.replace(new RegExp("\\$","g"),"[$]"),"g"),g=r.replace(u,"<span class = 'highlight_Find'>"+h+"</span>"),f=this.options.elementRV.container[0].getElementsByClassName("rich-object-body")[0];(f=f.getElementsByClassName("rich-object-content")[0].children[0]).innerHTML=g,r=g}}return!!(this.options.elementRV.content&&this.options.elementRV.content.length>0&&this.options.elementRV.content[0].innerText&&(this.options.elementRV.content[0].innerText||"").toLowerCase().includes(t))},o.prototype.highlightHeader=function(){var e=this.options.elementID;if(e){var t=document.getElementById(e+"_header")?document.getElementById(e+"_header"):document.getElementById(e);t&&t.classList.add("Highlight_search-in-current-dashboard")}},o.prototype.cleanupHighlightHeader=function(){var e=this.options.elementID;if(e){var t=document.getElementById(e+"_header")?document.getElementById(e+"_header"):document.getElementById(e);t&&t.classList.remove("Highlight_search-in-current-dashboard")}for(var i=document.getElementsByClassName("highlight_Find");i.length>0;)i[0].outerHTML=i[0].innerText},o}),define("DS/RichView/Command/CtxMenu_EndLinkCmd",["DS/ApplicationFrame/Command","DS/RichView/Command/CreateLinkAction","i18n!DS/RichView/assets/nls/CreateLinkAction"],function(e,t,i){"use strict";return e.extend({init:function(e){this._parent(e,{isAsynchronous:!0}),this._container=e.container,this.mediator=e.mediator,this.TOPIC_NAME="ENORERE_AP.StartLink",t._initialized||t.init({renderTo:this._container})},execute:function(e){var n=sessionStorage.getItem(this.TOPIC_NAME),o=UWA.is(n,"string")?JSON.parse(n):n;if(null!=o&&null!=o&&""!==o){for(var r=Array(),a=Array(),s=!1,l=0;l<e.length;l++){var c=e[l];if(c.physicalId==o.physicalId)s=!0;else if("Requirement"===c.kindof){var d={id:c.physicalId,type:c.type,typeNls:c.typeNls,kindof:c.kindof,path:c.path,title:c.title};r.push(d)}else a.push(c.title)}if(0!=a.length){var p="<h6>Excluded objects: Not the attributes of Requirement</h6> "+a.join(", ");t._displayNotification({className:"success",message:p})}if(s){p="Bad circular reference";t._displayNotification({className:"success",message:p})}var h={from:{id:o.physicalId,type:o.type,typeNls:o.typeNls,kindof:o.kindof,path:o.path,title:o.title},to:r};t.execute(h)}else t._displayNotification({className:"error",message:i.CreateLinkAction_StartLink_Not_Found})}})}),define("DS/RichView/Models/RichViewModelParser",["DS/Logger/Logger","DS/RichView/Models/RichViewModel","DS/TraceableRequirementsUtils/Utils","text!DS/RichView/assets/RichViewSetting.json"],function(e,t,i,n){"use strict";e.getLogger("DS/RichView/Models/RichViewModelParser");var o,r={},a={},s=function(e,t){var i={resourceid:null,rootID:null,elementID:null,matrixID:null,physicalID:null,type:"",kindof:"",title:"",name:"",revision:"",content:"",externalObject:!1,reqInterface:null,relationtype:"",relationid:null,relationOrder:null,parentID:"",level:0,editable:!0,isDocx:!1,format:"html"};for(var n in e)if(e.hasOwnProperty(n))switch(n){case"physicalid":i.physicalID=e[n],i.resourceid=e[n];break;case"id":i.matrixID=e[n];break;case"type":"Object"!=typeof e[n]?i.type=e[n]:i.type=e[n].value;break;case"type.kindof":i.kindof=e[n];break;case"interface":if(UWA.is(e[n].name)&&null!==e[n].name){var o=[];e[n].name.indexOf(",")>=0?o=e[n].name.split(","):o.push(e[n].name);for(var r=0;r<o.length;r++)UWA.is(t)&&t.indexOf(o[r])>=0&&(i.externalObject=!0);i.reqInterface=o}break;case"attribute[Title]":i.title=e[n];break;case"name":i.name=e[n];break;case"revision":i.revision=e[n];break;case"physicalid[connection]":i.relationid=e[n];break;case"type[connection]":i.relationtype=e[n];break;case"attribute[TreeOrder]":i.relationOrder=parseFloat(e[n]);break;case"level":i.level=parseInt(e[n]);break;case"attribute[Content Type]":i.format=e[n];break;case"attribute[Content Data]":i.content=e[n];break;case"editable":i.editable=e[n];break;case"current.access[read]":i.editable=e[n].toLowerCase();break;case"isDocx":i.isDocx=e[n];break;case"from.physicalid[connection]":i.parentID=e[n]}return i},l=function(e,t){!function(){if(!o){var e=JSON.parse(n);o=e.Icons,e.mql_colmuns,e.thumbnail}}();var r,a,s={};if(e.forEach(function(e){if("type"===e.name)e.name="ds6w:type";else if("ds6w:businessType"===e.name)console.log("noooooooooooooooooo");else if("owner"===e.name)e.name="ds6w:responsible";else{var n=e.name.split("/");e.name=n[n.length-1]}if(UWA.is(e.value)&&UWA.is(e.value.replace,"function")&&(e.value=e.value.replace(/\\n/g," ")),"ds6w:type"===e.name&&(s.type=e.value,a=t._defaultTypes[s.type]||s.type,s.reqKindOf=a),"resourceid"===e.name||"physicalid"===e.name)s.resourceid=e.value;else if("did"===e.name)s.did=e.value;else if("spec.TreeOrder"===e.name)s.relationOrder=parseFloat(e.value);else if("preview_url"===e.name||"thumbnail_2d"===e.name)s.thumbnail=e.value,s.grid||(s.grid={}),s.grid.thumbnail="url("+e.value+")";else if("type_icon_url"===e.name)s.icons||(s.icons=[]),s.icons.push(e.value);else if("ECChangement"===e.name||"COChangement"===e.name){s.grid||(s.grid={});var o=i.get3DSpaceUrl()+"/common/images/iconSmallECRO.gif";s.grid.changeManagement=o}else if("ds6w:refinedInto"===e.name)s.refined||(s.refined=[]),s.refined.push(e.value);else if("Req_Test_Cases"===e.name)s.test_cases||(s.test_cases=[]),s.test_cases.push(e.value);else if("ds6w:covers"===e.name)s.covers||(s.covers=[]),s.covers.push(e.value);else if("name"===e.name)r=e.value,s.req_name=e.value;else if("ds6w:status"===e.name)if(s.grid||(s.grid={}),e.dispValue){if((c=e.dispValue).contains(".")){var l=c.split(".");c=l[l.length-1]}s.grid[e.name]=c}else{var c;if((c=e.value).contains(".")){l=c.split(".");c=l[l.length-1]}s.grid[e.name]=c}else"ds6wg:revision"===e.name?(s.grid||(s.grid={}),s.grid[e.name]=e.dispValue?e.dispValue:e.value):(s.padgrid||(s.padgrid={}),s.padgrid[e.name]=e.dispValue?e.dispValue:e.value)}),s.refined&&(s.grid["ds6w:refinedInto"]=s.refined.length.toString()),s.test_cases&&(s.grid.Req_Test_Cases=s.test_cases.length.toString()),s.covers&&(s.grid["ds6w:covers"]=s.covers.length.toString()),s.relationOrder||(s.relationOrder=-1),e.length>4){if(widget&&!UWA.is(widget.displayNameSettings)){var l=sessionStorage.getItem("RMTPreferredDisplayName");widget.displayNameSettings=UWA.is(l,"string")?JSON.parse(l):l}s.grid["ds6w:label"]=s.req_label,UWA.is(r)&&UWA.is(widget.displayNameSettings[a])&&(s.label=i.computeDisplayName({name:r,title:r,revision:s.grid["ds6wg:revision"]},widget.displayNameSettings[a])),s.grid.displayName=s.label,s.display=s.label}return s};return r.parse_expand=function(e,t){var i={nodes:{},did_to_resourceid:{},structure:{}},n=t;return e.forEach(function(e){if(e.hasOwnProperty("attributes")){var t=l(e.attributes,n);i.nodes[t.resourceid]=t,UWA.is(t.did)&&(i.did_to_resourceid[t.did]=t.resourceid)}else if(e.hasOwnProperty("path")){var o=i.structure;e.path.forEach(function(e,t){o.hasOwnProperty(e)||(o[e]={}),o=o[e]})}else console.log("parse_expand: Unknown object "+JSON.stringify(e))}),i},a.process={root:function(e,i){var n=s(e.data,i);n.tenant=e.tenant;var o=new t(n);e.treedocument.addRoot(o)},createNode:function(e,i){return new t(s(e.data,i))},streaming:function(e,i){for(var n=e.data,o=[e.root_node],r=0;r<n.length;r++){var a=s(n[r],i);a.tenant=e.tenant;var l=new t(a),c=parseInt(n[r].level);c>=1&&(o[c]=l,o[c].options.children=null,o[c-1].childComputed=!0,o[c-1].addChild(o[c]))}},expand:function(e,t){var i=null;if(!e.filterMode)return this.expandMql(e);if(!UWA.is(e.treedocument,"object")||!UWA.is(e.root_nodes,"array")||!UWA.is(e.response,"object"))throw new Error("Invalid input parameters");if(!UWA.is(e.response.results,"array"))throw new Error("Invalid response format - results should be an array");return e.starting_from_root=void 0===e.starting_from_root||e.starting_from_root,i=r.parse_expand(e.response.results,e.treedocument),console.log(i),i}},a}),define("DS/RichView/Command/DeleteLinkAction",["UWA/Class","UWA/Controls/Abstract","DS/UIKIT/Input/Button","DS/UIKIT/Badge","DS/UIKIT/SuperModal","DS/UIKIT/Scroller","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Select","DS/UIKIT/Tooltip","DS/ENOFloatingPanel/ENOFloatingPanel","UWA/Drivers/Alone","DS/Logger/Logger","DS/PlatformAPI/PlatformAPI","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/REQCommandProxy","DS/RichView/RichContentEditor","DS/RichView/RichView","DS/PADUtils/PADContext","i18n!DS/RichView/assets/nls/RichView","i18n!DS/RichView/assets/nls/CreateLinkAction","css!DS/RichView/RichView.css"],function(e,t,i,n,o,r,a,s,l,c,d,p,h,u,g,f,m,v,b,_,y,C){"use strict";var x=null,w={},I=e.singleton({name:"DeletLinkAction",defaultOptions:{renderTo:".main-panel",mediator:null},_superModal:null,mediator:null,context:null,container:null,_logger:null,_commandProxy:null,_initialized:!1,_scopeId:null,_notifSMV:null,_widgetIdSMV:null,_onLoadingUI:!1,init:function(e){return x=this,this._logger=p.getLogger(I),this._logger.log("init"),this._parent(e),this.mediator=e.mediator,this.context=_.get(),this.defaultOptions.renderTo=e.renderTo,this.subscribeToSMVContextModification(),this._commandProxy=new m,this._initialized=!0,this._getLinkStatusNLS(),this},_initUI:function(e){x._floatingComponent=new c({title:y.DeleteLinkAction_DeleteLinks,overlay:!0,closable:!1,animate:!0,autocenter:!0,resizable:!0,events:{onResizeFloating:function(){x._logger.log("onResizeFloating")},onClose:function(){x._logger.log("onClose")}}}).inject(UWA.Element.getElement.call(document,e))},_getLinkStatusNLS:function(){0===Object.keys(w).length&&g.getAttributeRange({securityContext:u.getSecurityContext(),attributeName:"Link Status",onComplete:function(e){var t=UWA.is(e,"string")?JSON.parse(e):e,i=UWA.is(t.results[0],"string")?JSON.parse(t.results[0]):t.results[0];w=Object.keys(i).reduce((e,t)=>Object.assign({},e,{[i[t]]:t}),{})},onFailure:function(e){console.log(e)}})},subscribeToSMVContextModification:function(){UWA.is(x._notifSMV)||(x._logger.log("Subscribing to topic: DS/CATSmmUI/3DExperience/Proxy/contextChanged"),x._notifSMV=h.subscribe("DS/CATSmmUI/3DExperience/Proxy/contextChanged",function(e){x._onSMVContextChanged(e)}))},_onSMVContextChanged:function(e){var t=JSON.parse(localStorage.getItem("TRA-current-scope")),i=x._formatMessage(t);if(UWA.is(i.resources)&&i.resources.length>0){t=i.resources[0];UWA.is(i.types[0])&&"http://www.3ds.com/vocabularies/syc/type/Scope"===i.types[0]?(x._scopeId=t.id,x._widgetIdSMV=i.widgetId):(x._scopeId=null,x._widgetIdSMV=null)}else x._scopeId=null,x._widgetIdSMV=null},execute:function(e){if(!this._onLoadingUI){this._onLoadingUI=!0;var t=e.physicalid;x.defaultOptions.physicalid=e.physicalid,x.defaultOptions.name=e.name,x.defaultOptions.type=e.type;var i=[],n=[];g.expand({json:{root_physical_id:t,type_filter:["Requirement"],rel_filter:["Derived Requirement"],select_level:"1",object_selects:["type","name","revision","physicalid","type.kindof","attribute[Title]","attribute[Content Data]","attribute[Content Type]"],relationship_selects:["physicalid[connection]","attribute[TreeOrder]","type[connection]","attribute[Link Status]"],navigate_from_rel:"true",navigate_to_rel:"false",level:"1"},onComplete:function(e){var o=UWA.is(e,"string")?JSON.parse(e):e;i=o.results,g.expand({json:{root_physical_id:t,type_filter:["Requirement"],rel_filter:["Derived Requirement"],select_level:"1",object_selects:["type","name","revision","physicalid","type.kindof","attribute[Title]","attribute[Content Data]","attribute[Content Type]"],relationship_selects:["physicalid[connection]","attribute[TreeOrder]","type[connection]","attribute[Link Status]"],navigate_from_rel:"false",navigate_to_rel:"true",level:"1"},onComplete:function(e){var t=UWA.is(e,"string")?JSON.parse(e):e;n=t.results,x._buildDialog(n,i)},onFailure:function(e){},onTimeout:function(){}})},onFailure:function(e){},onTimeout:function(){}})}},_buildDialog:function(e,t){var n=x.defaultOptions.type+" "+x.defaultOptions.name,o=y.DeleteLinkAction_ToHeader;o=o.replace("{TNR}",n);var a=y.DeleteLinkAction_FromHeader;a=a.replace("{TNR}",n),x._footer=UWA.createElement("div"),x._cancelButton=new i({value:y.DeleteLinkAction_Cancel,name:"cancel_button"}),x._cancelButton.addEvents({onClick:function(e){x._onCancel(e)}}),x._deleteButton=new i({value:y.DeleteLinkAction_Delete,name:"delete_button",className:"primary",disabled:!0}),x._deleteButton.addEvents({onClick:function(e){x._onDelete(e)}}),x._deleteButton.inject(x._footer),x._cancelButton.inject(x._footer),x._dialogBody=UWA.createElement("div",{class:"delete-link-dialog",id:"dlg_"+x.defaultOptions.physicalid}),x._refinedSection=UWA.createElement("div",{id:"section_refined"}),x._refinedSectionHeader=UWA.createElement("h4",{text:o}),x._refinedSectionHeader.inject(x._refinedSection),x._coveredSection=UWA.createElement("div",{id:"section_covered"}),x._coveredSectionHeader=UWA.createElement("h4",{text:a}),x._coveredSectionHeader.inject(x._coveredSection),x._noRefinedLinks=UWA.createElement("h5",{class:"no-link",text:y.DeleteLinkAction_NoLinkFound}),x._noCoveredLinks=UWA.createElement("h5",{class:"no-link",text:y.DeleteLinkAction_NoLinkFound}),t.length>0?x._buildSection(t,x._refinedSection):x._noRefinedLinks.inject(x._refinedSection),e.length>0?x._buildSection(e,x._coveredSection):x._noCoveredLinks.inject(x._coveredSection),new v({mediator:x.mediator,selector:".delete-link-content",target:".content-data"}).startEditionForAll(),0===e.length&&0===t.length&&x._deleteButton.disable(),x._refinedSection.inject(x._dialogBody),x._coveredSection.inject(x._dialogBody),x._floatingComponent=new c({className:"DeleteLinkModal",title:y.DeleteLinkAction_DeleteLinks,body:x._dialogBody,footer:x._footer,overlay:!0,closable:!0,animate:!0,autocenter:!0,resizable:!0,events:{onResizeFloating:function(){x._logger.log("onResizeFloating")},onClose:function(){x._logger.log("onClose"),x._onCancel(x._floatingComponent)}}}).inject(UWA.Element.getElement.call(document,x.defaultOptions.renderTo)),x._floatingComponent.show(),new r({element:UWA.Element.getElement.call(x._floatingComponent.getBody(),".delete-link-dialog")})},_buildSection:function(e,t){for(var i=0;i<e.length;i++){var o=e[i],r=null,s=!1;if(UWA.is(this.context)&&0!=this.context.options.model.getNodesById(o.physicalid).length&&(s=!!UWA.is(this.context)&&this.context.options.model.getNodesById(o.physicalid)[0].options.externalObject),widget&&widget.displayNameSettings){var c=widget.displayNameSettings[o.type]||widget.displayNameSettings[o["type.kindof"]];UWA.is(c)&&(r=f.computeDisplayName({name:o.name,title:o["attribute[Title]"],revision:o.revision},c),r=x._decodeHtml(r))}UWA.is(r)||(r=o["attribute[Title]"],r=x._decodeHtml(r));var d=o["attribute[Link Status]"];0===Object.keys(w).length&&this._getLinkStatusNLS();var p=w[d];if(o.physicalid!==x.defaultOptions.physicalid){var h=UWA.createElement("div",{class:"delete-link-object",id:o["physicalid[connection]"]+"_rel","data-physicalid":o.physicalid}),u=UWA.createElement("div",{id:o["physicalid[connection]"]+"_toggle"}),g=UWA.createElement("div",{class:"delete-link-content"}),m=UWA.createElement("div",{class:"delete-link-data"}),v="";v="Requirement Proxy"===o.type.value?y.ExternalObject_DisplayContent:x._decodeHtml(o["attribute[Content Data]"]);var b=UWA.createElement("div",{class:"content-data",id:o["physicalid[connection]"]+"_data","data-physicalid":o.physicalid,contenteditable:!1,html:v});"Requirement Proxy"===o.type.value&&b.addEventListener("click",function(e){x._getProxyContentData(this,e)});var _,C=new a({type:"checkbox",value:o["physicalid[connection]"],label:r,checked:!1});switch(C.addEvents({onClick:function(e){0==jQuery("input:checkbox:checked",x._floatingComponent.elements.content).closest(".delete-link-object").length?x._deleteButton.setDisabled(!0):x._deleteButton.setDisabled(!1)}}),b.inject(m),m.inject(g),C.inject(u),u.inject(h),g.inject(h),d){case"Invalid":_="error";break;case"Suspect":_="warning";break;case"Valid":_="success"}var I=new n({id:o["physicalid[connection]"]+"_statusLabel",content:p,className:"linkStatus "+_,selectable:!0});new l({target:I.getContent(),body:"Click here to update the status",position:"top"}),I.addEvents({onClick:function(e){var t,i;t=e.target.id,i=e.target.parentElement.parentElement.id,""!=t&&"undefined"!=t&&"null"!=t||(t=e.target.parentElement.id.split("_")[0],i=e.target.parentElement.parentElement.parentElement.id.split("_")[0]);var n=jQuery("#"+t+"_statusLabel").find(".badge-content").text().trim();x._updateUIElem(t,i,C,n)}}),h.inject(t),s?jQuery(C.getContent()).find(".control-label").prepend('<span class="trm-icon trm-icon-requirement-proxy"></span>'):jQuery(C.getContent()).find(".control-label").prepend('<span class="trm-icon trm-icon-requirement"></span>'),jQuery(C.getContent()).append(I.getContent())}}},_updateUIElem:function(e,t,i,n){jQuery("#"+e+"_statusLabel").hide();var o=t+"_statusComboBox",r=new s({placeholder:!1,className:"linkStatus small",id:o});x._getRelationshipStatus(o,r,n),jQuery("#"+t+"_toggle").find(".toggle.toggle-root").append(r.getContent()),jQuery("#"+t+"_statusComboBox").focus(),jQuery("#"+t+"_statusComboBox").focusout(function(){jQuery("#"+e+"_statusLabel").show(),jQuery("#"+e+"_toggle").find(".toggle.toggle-root").find(".select").remove()})},_getRelationshipStatus:function(e,t,i){e.split("_")[0];var n=w;jQuery.each(n,function(e,n){var o={};o[0]=e.trim(),o[1]=n.trim(),i==o[0]||i==o[1]?t.add({value:o[0],label:o[1],selected:!0}):t.add({value:o[0],label:o[1]})}),t.addEvents({onChange:function(e){var t=e.target.value,i=e.target.options[e.target.selectedIndex].text,n=e.target.id;x._updateLinkStatus(n,t,i)}})},_updateLinkStatus:function(e,t,i){var n=e.split("_")[0];g.editRelationAttributes({pid:n,securityContext:f.getSecurityContext(),json:{attributes:[{name:"Link Status",value:t}]},onComplete:function(e){jQuery("#"+n+"_toggle").find(".toggle.toggle-root").find(".select").remove(),jQuery("#"+n+"_statusLabel").find(".badge-content").text(i),jQuery("#"+n+"_statusLabel").show(),x._updateBackGroundColor(n,t)},onFailure:function(e,t){}})},_updateBackGroundColor:function(e,t){var i=jQuery("#"+e+"_statusLabel");i.find(".badge-content").text().trim();switch(t){case"Invalid":i.removeClass("badge-warning badge-error badge-success"),i.addClass("badge-error");break;case"Suspect":i.removeClass("badge-warning badge-error badge-success"),i.addClass("badge-warning");break;case"Valid":i.removeClass("badge-warning badge-error badge-success"),i.addClass("badge-success")}},_onCancel:function(){x._onLoadingUI=!1,x._logger.log("onCancel"),x._floatingComponent.hide(),x._floatingComponent.destroy()},_onDelete:function(){x._onLoadingUI=!1,x._logger.log("onDelete");for(var e=jQuery("input:checkbox:checked",x._floatingComponent.elements.content),t=e.closest(".delete-link-object"),i=[],n=0;n<t.length;n++)i.push(t[n].parentElement);x._floatingComponent.hide(),x._floatingComponent.destroy(),x._deleteLink(e,t,i)},_deleteLink:function(e,t,i){x._logger.log("_deleteLink");for(var n=[],o=[],r=[],a=0;a<e.length;a++)n.push(e[a].value),-1!=i[a].id.indexOf("refined")?o.push(t[a].dataset.physicalid):-1!=i[a].id.indexOf("covered")&&r.push(t[a].dataset.physicalid);g.detach({securityContext:f.getSecurityContext(),json:{relationship_physical_ids:n},onComplete:function(e){x._displayNotification({className:"success",message:y.DeleteLinkAction_Success});e={selected_id:x.defaultOptions.physicalid,refined_ids:o,covered_ids:r,connectionId:n,widgetid:widget.id,contextId:f.getSecurityContext()};x._commandProxy.traceabilityAuthoring({data:e,appId:widget.getValue("appId"),event:"delete"}),UWA.is(x._scopeId)&&setTimeout(function(){x._logger.log("Publish topic DS/CATSmmUI/3DExperience/Proxy/refresh"),h.publish("DS/CATSmmUI/3DExperience/Proxy/refresh",{resources:[x._scopeId+"/traceability_model"],widgetId:x._widgetIdSMV,clearCache:!0})},500)},onFailure:function(e,t){var i=e.message;t=UWA.is(t,"string")?JSON.parse(t):t,UWA.is(t.message)&&(i=t.message),x._displayNotification({className:"error",message:i})},onTimeout:function(){}})},_decodeHtml:function(e){var t=document.createElement("textarea");return t.innerHTML=e,t.value},_displayNotification:function(e){UWA.is(x.context)&&UWA.is(x.context.displayNotification)?x.context.displayNotification({eventID:e.className,msg:e.message}):alert(e.message)},_getProxyContentData:function(e,t){var i=this,n=this.context.OSLCProviders;g.getInfo({securityContext:f.getSecurityContext(),pid:e.attributes["data-physicalid"].value,onComplete:function(e){var o=(e=UWA.is(e,"string")?JSON.parse(e):e).results[0],r=o["ProxyItem.Proxy_Service"],a=o["ProxyItem.Proxy_URL"],s="",l="";if(UWA.is(n)){for(var c=0;c<n.repositories.length;c++){r===n.repositories[c].id&&(s=n.repositories[c].rootUrl,l=n.repositories[c].oauth);break}g.getOSLCContent({service:r,doors_url:s+a,tenant:f.getTenant(),Oauth:l,method:"GET",onComplete:function(e){var i=t.target,n=(e=jQuery(jQuery.parseXML(e)))[0].getElementsByTagNameNS(e[0].lookupNamespaceURI("jazz_rm"),"primaryText");if(n[0].childNodes[0].childNodes.length>0){for(var o=n[0].childNodes[0].childNodes,r="",a=0;a<o.length;a++)UWA.is(o[a].innerText)&&(r+=" "+o[a].innerText);i.innerText=r}else n=e[0].getElementsByTagName("dcterms:description"),i.innerText=n[0].innerHTML;console.log(e)},onFailure:function(e){i._logger.log(e)}})}},onFailure:function(e){i._logger.log(e)},onTimeout:function(){i._logger.log("RequirementWebServices.getInfo timed out")}})}});return I}),define("DS/RichView/Service/ContextualMenu",["UWA/Core","UWA/Class","DS/Logger/Logger","DS/UIKIT/Input/Button","DS/ApplicationFrame/CommandsManager","DS/WebappsUtils/WebappsUtils","DS/TraceableRequirementsUtils/Utils","DS/PADUtils/PADContext","DS/RichView/Command/CtxMenu_StartLinkCmd","DS/RichView/Command/CtxMenu_EndLinkCmd","DS/RichView/Command/DeleteLinkAction","i18n!DS/RichView/assets/nls/RichView"],function(e,t,i,n,o,r,a,s,l,c,d,p){"use strict";var h=null,u=t.extend({model:null,_logger:void 0,mediator:null,init:function(e){h=this,this.model=e.model,this._logger=i.getLogger(u),this.menu_container=e.container,this.menu_id=e.id+"_menu",this.kindof=e.kindof,this.mediator=e.mediator,this.type=e.type,this.externalProviders=e.externalProviders,UWA.is(e.externalObject)?this.externalObject=e.externalObject:this.externalObject=!1,this._initTraceabilityCmd()},_initTraceabilityCmd:function(){this.StartLinkCmd=new l({ID:"StartLink_ctx"}),this.EndLinkCmd=new c({ID:"EndLink_ctx",container:".content-panel"}),d._initialized||d.init({renderTo:".main-panel",mediator:h.mediator})},inject:function(){var e=this.menu_container,t=this.menu_id,i=this._getContextualMenu(this.kindof),o=this._callbacks(i),r=new n({value:"",dropdownCaret:!1,removeOnHide:!0,id:t,className:"link",icon:"fonticon fonticon-menu-dot",dropdown:{className:"richview-menu",items:i,events:{onClick:function(e,t){var i=s.get().getSelectedNodes()[0].getRichViewElement(),n=o[t.name];n&&n.call(null,i)}}},events:{onClick:function(e){var t;if(UWA.is(this.elements.container.closest))t=this.elements.container.closest(".rich-object,.rich-container").id;else{t=function(e,t,i,n,o){for(var r=e.parentNode;r.className!=t&&r.className!=i&&r.className!=n&&r.className!=o;)r=r.parentNode;return r.id}(this.elements.container,"rich-object  right-border","rich-container  right-border","rich-container ","rich-container")}var i=h.model.getNodesByElementID(t)[0].getRichViewElement();i.container.hasClass("active")||(i.info.click(),!1===r.dropdown.isVisible&&r.dropdown.show())}}}).inject(e)},_getContextualMenu:function(e){var t=[];switch(e){case"Requirement":t=this.externalObject?this._getExternalRequirementMenu():this._getRequirementMenu();break;case"Comment":t=this._getCommentMenu();break;case"Chapter":t=this._getChapterMenu();break;default:t=this._getDefaultMenu()}return t},_getRequirementMenu:function(){var e=[];return e.push({name:"addChapter",text:p.AddChapter,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewChapter.png"),data:"",callback:this._addChapterCommand.bind(this)}),e.push({name:"addRequirement",text:p.AddRequirement,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewRequirement.png"),data:"",callback:this._addRequirementCommand.bind(this)}),e.push({name:"addComment",text:p.AddComment,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewComment.png"),data:"",callback:this._addCommentCommand.bind(this)}),e.push({className:"divider"}),e.push({name:"insertRequirement",text:p.InsertRequirement,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),data:"",callback:this._insertRequirementCommand.bind(this)}),this.externalProviders&&e.push({text:p.InsertNewExtReq,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),items:[{name:"CreateExternalSubRequirement",text:p.ExternalSubReq,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),callback:this._createExternalSubRequirementCommand.bind(this)},{name:"CreateExternalDerRequirement",text:p.ExternalDerivedReq,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),callback:this._createExternalDerRequirementCommand.bind(this)}]}),e.push({name:"insertExistingRequirement",text:p.InsertExistingRequirement,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertExisting.png"),data:"",callback:this._insertInsertExistingRequirementCommand.bind(this)}),this.externalProviders&&e.push({text:p.InsertExistExtReq,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),items:[{name:"insertExternalSubRequirement",text:p.ExternalSubReq,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),callback:this._insertExternalSubRequirementCommand.bind(this)},{name:"InsertExternalDerRequirement",text:p.ExternalDerivedReq,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),callback:this._insertExternalDerRequirementCommand.bind(this)}]}),e.push({className:"divider"}),e.push({name:"startLink",text:p.RichView_Cmd_StartLink,icon:r.getWebappsAssetUrl("RichView","icons/32/DerivedRequirementStartLink.png"),data:"",callback:this._startLink.bind(this)}),e.push({name:"endLink",text:p.RichView_Cmd_EndLink,icon:r.getWebappsAssetUrl("RichView","icons/32/DerivedRequirementEndLink.png"),data:"",callback:this._endLink.bind(this)}),e.push({name:"linkManagement",text:p.RichView_Cmd_DeleteLink,icon:"",data:"",callback:this._linkManagement.bind(this)}),e.push({className:"divider"}),e=e.concat(this._getDefaultMenu())},_getExternalRequirementMenu:function(){var e=this._getDefaultMenu();return e.push({name:"addRequirement",text:p.AddRequirement,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewRequirement.png"),data:"",callback:this._addRequirementCommand.bind(this)}),e},_getCommentMenu:function(){var e=[];return e.push({name:"addChapter",text:p.AddChapter,data:"",icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewChapter.png"),callback:this._addChapterCommand.bind(this)}),e.push({name:"addRequirement",text:p.AddRequirement,data:"",icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewRequirement.png"),callback:this._addRequirementCommand.bind(this)}),e.push({name:"addComment",text:p.AddComment,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewComment.png"),data:"",callback:this._addCommentCommand.bind(this)}),e.push({className:"divider"}),e=e.concat(this._getDefaultMenu())},_getChapterMenu:function(){var e=[];return e.push({name:"addChapter",text:p.AddChapter,data:"",icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewChapter.png"),callback:this._addChapterCommand.bind(this)}),e.push({name:"addRequirement",text:p.AddRequirement,data:"",icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewRequirement.png"),callback:this._addRequirementCommand.bind(this)}),e.push({name:"addComment",text:p.AddComment,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewComment.png"),data:"",callback:this._addCommentCommand.bind(this)}),e.push({className:"divider"}),e.push({name:"insertChapter",text:p.InsertChapter,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubChapter.png"),data:"",callback:this._insertChapterCommand.bind(this)}),e.push({name:"insertRequirement",text:p.InsertRequirement,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq.png"),data:"",callback:this._insertRequirementCommand.bind(this)}),e.push({name:"insertComment",text:p.InsertComment,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubComment.png"),data:"",callback:this._insertCommentCommand.bind(this)}),e.push({name:"insertExisting",text:p.InsertExisting,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertExistingObject.png"),data:"",callback:this._insertInsertExistingCommand.bind(this)}),e.push({className:"divider"}),e=e.concat(this._getDefaultMenu())},_getDefaultMenu:function(){var e=[];return e.push({name:"detach",text:p.RichView_Cmd_Detach,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdDetach.png"),data:"",callback:this._detach.bind(this)}),e.push({name:"properties",text:p.RichView_Cmd_Properties,icon:r.getWebappsAssetUrl("RichView","icons/32/I_CATSSEditorDisplayProperties.png"),data:"",callback:this._editProperties.bind(this)}),e},_addRequirementCommand:function(){this._launchAction({command:"AddNewRequirement"})},_addChapterCommand:function(){this._launchAction({command:"AddNewChapter"})},_addCommentCommand:function(){this._launchAction({command:"AddNewComment"})},_insertRequirementCommand:function(){this._logger.log("_insertRequirement"),this._launchAction({command:"InsertRequirement"})},_insertChapterCommand:function(){this._logger.log("_insertRequirement"),this._launchAction({command:"InsertChapter"})},_insertCommentCommand:function(){this._logger.log("_insertComment"),this._launchAction({command:"InsertComment"})},_insertInsertExistingCommand:function(){this._logger.log("_insertInsertExistingCommand"),this._launchAction({command:"InsertExisting"})},_insertInsertExistingRequirementCommand:function(){this._logger.log("_insertInsertExistingRequirementCommand"),this._launchAction({command:"InsertExistingRequirement"})},_insertExternalSubRequirementCommand:function(){this._logger.log("_insertExternalRequirement"),this._launchAction({command:"InsertExternalSubRequirement"})},_insertExternalDerRequirementCommand:function(){this._logger.log("_insertExternalRequirement"),this._launchAction({command:"InsertExternalDerRequirement"})},_createExternalSubRequirementCommand:function(){this._logger.log("_insertExternalRequirement"),this._launchAction({command:"CreateExternalSubRequirement"})},_createExternalDerRequirementCommand:function(){this._logger.log("_insertExternalRequirement"),this._launchAction({command:"CreateExternalDerRequirement"})},_startLink:function(e){this._logger.log("_startLink");var t=h.model.getNodesByElementID(e.id)[0].getOccurencePath(),i={id:e.objectId,physicalId:e.physicalId,type:e.type,kindof:e.kindof,path:t,title:e.title};this.StartLinkCmd.execute(i)},_endLink:function(e){var t=s.get().getSelectedNodes();if(this._endLinkCmd=new c({container:".pad_view_container"}),null!=t&&null!=t&&0!=t.length){for(var i=Array(),n=0;n<t.length;n++){var o=t[n],r="";o.options.hasOwnProperty("kindof")?r=o.options.kindof:o.options.hasOwnProperty("reqKindOf")&&(r=o.options.reqKindOf);o.getID();var a=o.getID(),l=o.options.grid["ds6w:type"],d={id:a,physicalId:a,type:o.options.type,typeNls:l,kindof:r,path:o.getOccurencePath(),title:o.options.label};i.push(d)}this.EndLinkCmd.execute(i)}},_linkManagement:function(e){this._logger.log("_linkManagement"),e.title=a._decodeHTML(e.title),d.execute({physicalid:e.physicalId,name:e.title,type:e.type})},_editProperties:function(){this._logger.log("_editProperties"),this._launchAction({command:"ActionBar_Attributes"})},_detach:function(){this._logger.log("_detach"),this._launchAction({command:"Detach"})},_launchAction:function(e){this._logger.log("_launchAction");var t=o.getCommand(e.command);t&&t.begin()},_callbacks:function(e){for(var t={},i=0;i<e.length;i++){var n=e[i];if(t[n.name]=n.callback,UWA.is(n.items))for(var o=0;o<n.items.length;o++){var r=n.items[o];t[r.name]=r.callback}}return t}});return u}),define("DS/RichView/Views/RichContainer",["UWA/Core","UWA/Class","UWA/Class/Events","UWA/Class/Listener","UWA/Class/Options","DS/Logger/Logger","DS/UIKIT/Input/Button","DS/UIKIT/Popover","DS/UIKIT/Tooltip","DS/UIKIT/Mask","DS/RichView/Service/ContextualMenu","DS/RichView/mixins/_dndUtilities","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/jQueryUI","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/Services/RequirementWebServices","i18n!DS/RichView/assets/nls/RichView","css!DS/RichView/RichView.css"],function(e,t,i,n,o,r,a,s,l,c,d,p,h,u,g,f,m){"use strict";var v=!!document.documentMode||/Edge\/\d./i.test(navigator.userAgent),b=!v&&!!window.StyleMedia,_=(Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor"),function(e){return h('<div id="'+e.id+'" class="rich-container '+e.className+'" draggable="true" data-objectid="'+e.objectId+'" data-level="'+e.level+'" data-physicalid="'+e.physicalId+'" data-relid="'+e.connectionId+'"></div>')}),y=function(){return h('<span class="rich-container-info"></span>')},C=function(e){return widget.getValue("trm_richview_DisableAutoNumbering")?h('<span class="rich-container-title header-size-'+e.size+'"><span class="rich-container-title-index" style="display: none;"> '+e.index+' - </span><span><div id="'+e.id+'_content" class="rich-container-title-editable" contenteditable="'+e.editable+'">'+e.title+"</div></span></span>"):h('<span class="rich-container-title header-size-'+e.size+'"><span class="rich-container-title-index"> '+e.index+' - </span><span><div id="'+e.id+'_content" class="rich-container-title-editable" contenteditable="'+e.editable+'">'+e.title+"</div></span></span>")},x=function(){return h('<span class="collapsable-container"><span class="fonticon fonticon-minus-squared site-icon"></span></span>')},w=function(){return h('<span class="rich-container-menu"></span>')},I=t.extend(i,n,o,p,{defaultOptions:{model:null,node:null,rootId:null,mediator:null,id:null,objectId:null,physicalId:null,type:"",kindof:"",title:"",index:"",connection:"",connectionId:null,level:0,editable:"true",defaultType:"Requirement",placeholder:!1,droppable:null,context:null,bi_color:null},model:null,node:null,id:null,objectId:null,parentId:null,physicalId:null,connection:null,connectionId:null,level:null,index:null,title:null,container:null,info:null,header:null,menu:null,menu_context:null,type:null,kindof:null,context:null,mediator:null,cestamp:null,init:function(e){this._logger=r.getLogger(I),this._logger.log("init"),UWA.merge(e||{},this.defaultOptions),this.options=e,this.model=this.options.model,this.node=this.options.node,this.id=this.options.id,this.objectId=this.options.objectId,this.parentId=this.options.parentId,this.physicalId=this.options.physicalId,this.connection=this.options.connection,this.connectionId=this.options.connectionId,this.level=this.options.level,this.index=this.options.index,this.title=this.options.title,this.type=this.options.type,this.kindof=this.options.kindof,this.context=this.options.context,this.mediator=this.options.mediator,this.cestamp=this.options.cestamp,this.container=_({id:this.options.id,objectId:this.options.objectId,physicalId:this.options.physicalId,connectionId:this.options.connectionId,level:this.options.level,className:!0===this.options.placeholder?"placeholder":""}),this.info=y(),this.header=C({size:this.options.level>6?6:this.options.level,index:this.options.index,title:this.options.title,editable:this.options.editable,id:this.options.id}),this.menu=x(),this.menu_context=w(),this.container.append(this.info).append(this.menu).append(this.menu_context).append(this.header),this._lowerMatchUpper={};var t=Object.keys(this.options.droppable);t.forEach(function(e){UWA.is(widget.getPreference("trm_types_"+e))&&widget.getPreference("trm_types_"+e).options.forEach(function(e){-1===h.inArray(e.value,t)&&t.push(e.value)})});for(var i=0;i<t.length;i++)this._lowerMatchUpper[t[i].toLowerCase()]=t[i];this._menu_context_attached=!1},_subscribeToStopDnD:function(){var e=this;this.mediator.subscribe("onStopDnd",function(t){e._isDnD=!1,e._notDroppable(),e._notDraggable()})},_subscribeToStartDnD:function(){var e=this;this.mediator.subscribe("onStartDnd",function(t){e._isDnD=!0,e._droppable(),e._draggable()})},_subscribeToOnScroll:function(){var e=this;this.mediator.subscribe("onScroll",function(t){e._scroll(t)})},create:function(){return!0===this.options.placeholder?this:(!0===this.options.fake?this.menu_context.remove():(this.node.setRichViewElementID(this.id),this.node.setRichViewElement(this)),this._dragging=!1,this._isDnD=!1,this._dropPosition="",this._draggingY=null,this._subscribeToStopDnD(),this._subscribeToStartDnD(),this._subscribeToOnScroll(),this)},update:function(e,t){for(var i=Object.keys(e),n=0;n<i.length;n++)switch(i[n]){case"bi_color":UWA.is(e.bi_color)&&""!==e.bi_color?(this.options.bi_color=e.bi_color,this.info.css("border-left-color",e.bi_color)):(this.options.bi_color=null,this.info.attr("style")&&this.info.removeAttr("style"));break;case"level":var o=this.options.level>6?6:this.options.level;this.options.level=e.level,this.level=this.options.level,this.container.data("level",this.options.level),this.container[0].dataset.level=this.options.level;var r=this.options.level>6?6:this.options.level;this.header.removeClass("header-size-"+o),this.header.addClass("header-size-"+r);break;case"index":this.options.index=e.index,this.index=this.options.index,this.header.find(".rich-container-title-index").text(this.options.index+" - ");break;case"title":this.options.title!==e.title&&(this.options.title=e.title,this.title=this.options.title,this.context.updateRichContent({content:this.title,element:this.header.find(".rich-container-title-editable"),editable:this.options.editable}),this.mediator.publish("onRefresh"));break;case"connectionId":this.options.connectionId=e.connectionId,this.connectionId=this.options.connectionId,this.container.data("relid",this.options.connectionId),this.container[0].dataset.relid=this.options.connectionId;break;case"parentId":this.options.parentId=e.parentId,this.parentId=this.options.parentId;break;case"connection":this.options.connection=e.connection,this.connection=this.options.connection}},refresh:function(e){e=e||[];for(var t=0;t<e.length;t++)switch(e[t]){case"title":this.context.updateRichContent({content:this.title,element:this.header.find(".rich-container-title-editable"),editable:this.options.editable})}},_scroll:function(e){var t=this.isVisible(e.position);if(t&&!1===this._menu_context_attached&&(this._menu_context_attached=!0,this._menu_context()),t){if(this._isDnD)return!0;this._isDnD=!0,this._droppable(),this._draggable()}else this._isDnD=!1,this._notDroppable(),this._notDraggable()},_menu_context:function(){new d({model:this.model,container:this.menu_context[0],id:this.id,kindof:this.kindof}).inject()},hide:function(){this.container.hide()},show:function(){this.container.show()},_draggable:function(){var e=this,t=!1;this.container.on("mousedown ",function(e){t=h(e.target)}),this.container.on("dragstart",function(i){if(e._dragging=!0,e._draggingY=i.originalEvent.clientY,t.hasClass("rich-container-info")){h(this).addClass("being-dragged"),i.originalEvent.dataTransfer.dropEffect="move";var n=v?"text":"text/searchitems",o=widget.getUrl(),r=(o=o.substr(0,o.indexOf("/webapps"))).substr(o.lastIndexOf("/")+1),a=e.model.getNodesByElementID(e.id)[0],s=a.getOccurencePath();!1===a.isSelected()&&this.hasOwnProperty("hasClassName")&&!1===this.hasClassName("active")&&e.context._selectionMgt(e.info,".rich-container");var l={protocol:"3DXContent",version:"1.1",source:widget.getValue("appId"),data:{items:[{envId:g.getTenant(),serviceId:r,contextId:g.getSecurityContext(),objectId:e.physicalId,objectType:e.type,displayName:e.title,kindof:e.kindof,path:s}]}};if(v){var c={0:this.id,1:e.options.title,2:e.options.type,3:e.options.kindof,4:widget.id,protocol:"3DXContent",version:"1.1",source:widget.getValue("appId"),data:{items:[{envId:g.getTenant(),serviceId:r,contextId:g.getSecurityContext(),objectId:e.physicalId,objectType:e.type,displayName:e.title,kindof:e.kindof,path:s}]}};i.originalEvent.dataTransfer.setData("text",JSON.stringify(c))}else{var d=h(".fancytree-icon.fonticon-book")[0];i.originalEvent.dataTransfer.setDragImage(d,-10,-10),i.originalEvent.dataTransfer.setData("0_"+this.id,""),i.originalEvent.dataTransfer.setData("1_"+e.options.title,""),i.originalEvent.dataTransfer.setData("2_"+e.options.type,""),i.originalEvent.dataTransfer.setData("3_"+e.options.kindof,""),i.originalEvent.dataTransfer.setData("4_"+widget.id,""),i.originalEvent.dataTransfer.setData(n,JSON.stringify(l))}}else i.preventDefault()}),this.container.on("dragend",function(t){e._dragging=!1,e._draggingY=null,h(this).removeClass("being-dragged"),e.cleanupHighlight(h(this))})},_notDraggable:function(){this.container.off("mousedown"),this.container.off("dragstart"),this.container.off("dragend")},_droppable:function(){var e=this,t=0;this.container.on("dragenter",function(i){if(i.stopPropagation&&i.stopPropagation(),i.preventDefault&&i.preventDefault(),!1===e.isDroppable(i))return!1;t++}),this.container.on("dragover",function(t){var i=e.isDroppable(t);if(-1!==h.inArray("text/html",t.originalEvent.dataTransfer.types)&&(t.originalEvent.dataTransfer.dropEffect="copy"),!1===i)return!1;var n=h(this);null==e._draggingY&&(e._draggingY=t.originalEvent.clientY);var o=document.getElementsByClassName("richview-editor-container")[0].getDimensions().width,r=t.originalEvent.clientX,a=t.originalEvent.clientY-e._draggingY;if(a>0){var s=n.next()[0];if(UWA.is(s)){var l=s.getAttribute("id"),c=e.context.getRichObject(l);if(c&&null!=c)if(!c.isVisible()&&o-r<.2*o)e.context.scroller.scrollToElement("#"+l,"center");else{var d=e.context.contentPanel.height()-e.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight;36+c.container.offset().top-e.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight>d&&o-r<.2*o&&e.context.scroller.scrollToElement("#"+l,"center")}}}else if(a<0){var p=n.prev()[0];if(UWA.is(p)){var u=p.getAttribute("id"),g=e.context.getRichObject(u);if(g&&null!=g)if(!g.isVisible()&&o-r<.2*o)e.context.scroller.scrollToElement("#"+u,"center");else g.container.offset().top-e.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight-20<0&&o-r<.2*o&&e.context.scroller.scrollToElement("#"+u,"center")}}return e._draggingY=t.originalEvent.clientY,n.hasClass("rich-container")||(n=n.parents(".rich-container:first")),n.hasClass("rich-container")?(e._dropPosition=e.updateHighlight(t.originalEvent.clientY,n,i),!1):void 0}),this.container.on("dragleave",function(i){if(!1===e.isDroppable(i))return!1;if(0===--t){var n=h(this);if(n.hasClass("rich-container")||(n=n.parents(".rich-container:first")),!n.hasClass("rich-container"))return;e.cleanupHighlight(n)}}),this.container.on("drop",function(t){t.preventDefault();var i=h(this);if(e.cleanupHighlight(i),e._dropPosition){if(v){var n=e.handleDataTransferInIE(t.originalEvent);if(UWA.is(n)){if(UWA.is(n.protocol)&&"3DXContent"===n.protocol&&n[4]!==widget.id)return void e.process3DXContentData(n,i)}else if(UWA.is(t.originalEvent.dataTransfer.getData("text"),"string")){var o=e.options.defaultType;UWA.is(widget.getValue("trm_types_"+e.options.defaultType.replace(" ","_")))&&""!==widget.getValue("trm_types_"+e.options.defaultType.replace(" ","_"))&&(o=widget.getValue("trm_types_"+e.options.defaultType)),e.mediator.publish("onInsert",{target:{element:i,id:i.attr("id")},position:e._dropPosition,operation:"insertNew",type:o,kindof:e.options.defaultType,parentId:e.objectId,content:t.originalEvent.dataTransfer.getData("text"),contentType:"html"})}}else{var r=!1;if(UWA.is(t.originalEvent.dataTransfer.types[0],"string")){var a=e.extractFromDataTransfer(t.originalEvent.dataTransfer.types[0]);e.model.getNodesByElementID(a).length>0&&(r=!0)}if(-1!==h.inArray("text/searchitems",t.originalEvent.dataTransfer.types)&&!1===r){var s=t.originalEvent.dataTransfer.getData("text/searchitems"),l=JSON.parse(s);return void e.process3DXContentData(l,i)}if(b&&-1!==h.inArray("text/html",t.originalEvent.dataTransfer.types)&&!1===r){o=e.options.defaultType;UWA.is(widget.getValue("trm_types_"+e.options.defaultType.replace(" ","_")))&&""!==widget.getValue("trm_types_"+e.options.defaultType.replace(" ","_"))&&(o=widget.getValue("trm_types_"+e.options.defaultType));var c=t.originalEvent.dataTransfer.getData("text/html");if(c.indexOf("\x3c!--StartFragment--\x3e")>-1&&c.indexOf("\x3c!--EndFragment--\x3e")>-1){var d=c.indexOf("\x3c!--StartFragment--\x3e")+20,p=c.indexOf("\x3c!--EndFragment--\x3e"),u=c.slice(d,p);e.mediator.publish("onInsert",{target:{element:i,id:i.attr("id")},position:e._dropPosition,operation:"insertNew",type:o,kindof:e.options.defaultType,parentId:e.objectId,content:u,contentType:"html"})}else e.mediator.publish("onInsert",{target:{element:i,id:i.attr("id")},position:e._dropPosition,operation:"insertNew",type:o,kindof:e.options.defaultType,parentId:e.objectId,content:t.originalEvent.dataTransfer.getData("text/html"),contentType:"html"});return}if(-1!==h.inArray("text/html",t.originalEvent.dataTransfer.types)&&!1===r){o=e.options.defaultType;return UWA.is(widget.getValue("trm_types_"+e.options.defaultType.replace(" ","_")))&&""!==widget.getValue("trm_types_"+e.options.defaultType.replace(" ","_"))&&(o=widget.getValue("trm_types_"+e.options.defaultType)),void e.mediator.publish("onInsert",{target:{element:i,id:i.attr("id")},position:e._dropPosition,operation:"insertNew",type:o,kindof:e.options.defaultType,parentId:e.objectId,content:t.originalEvent.dataTransfer.getData("text/html"),contentType:"html"})}}var g=void 0,f=void 0;if(v){var m=e.handleDataTransferInIE(t.originalEvent);if(!UWA.is(m))return;g=m[0],f=h("#"+g),m[1],m[2],m[3]}else g=e.extractFromDataTransfer(t.originalEvent.dataTransfer.types[0]),f=h("#"+g),e.extractFromDataTransfer(t.originalEvent.dataTransfer.types[1]),e._lowerMatchUpper[e.extractFromDataTransfer(t.originalEvent.dataTransfer.types[2])],e._lowerMatchUpper[e.extractFromDataTransfer(t.originalEvent.dataTransfer.types[3])];e.mediator.publish("onReorder",{source:{element:f,id:g},target:{element:i,id:e.options.id},position:e._dropPosition,type:"rich-container"})}})},_notDroppable:function(){this.container.off("drop"),this.container.off("dragenter"),this.container.off("dragover"),this.container.off("dragleave")}});return I}),define("DS/RichView/Views/RichObject",["UWA/Core","UWA/Class","UWA/Class/Events","UWA/Class/Listener","UWA/Class/Options","DS/Logger/Logger","DS/PlatformAPI/PlatformAPI","DS/UIKIT/Input/Button","DS/UIKIT/Popover","DS/UIKIT/Tooltip","DS/UIKIT/Mask","DS/UIKIT/Scroller","DS/RichView/Service/ContextualMenu","DS/RichView/Command/CtxMenu_StartLinkCmd","DS/RichView/Command/CtxMenu_EndLinkCmd","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/jQueryUI","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/Services/RequirementWebServices","i18n!DS/RichView/assets/nls/RichView","i18n!DS/RichEditor/assets/nls/RichEditor","css!DS/RichView/RichView.css"],function(e,t,i,n,o,r,a,s,l,c,d,p,h,u,g,f,m,v,b,_,y){"use strict";var C=!!document.documentMode||/Edge\/\d./i.test(navigator.userAgent),x=!C&&!!window.StyleMedia,w=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,I=function(e){var t;t=e.type_icon_url?'<span class="object-link"><span class="trm-icon" ><img width="16" height="16" src="'+e.type_icon_url+'" onerror="this.onerror=null;"></span> ':'<span class="object-link"><span class="trm-icon trm-icon-'+e.icon+'"></span> ';var i='<span class="rich-object-header-content">';UWA.is(e.externalObject)&&e.externalObject&&(e.icon="requirement-proxy");var n="";return n=widget.getValue("trm_richview_DisableAutoNumbering")?'<span class="rich-object-container-index" style="display: none;"> '+e.containerIdx+' - </span><span class="rich-object-index" style="display: none;"> '+e.index+"  </span>":'<span class="rich-object-container-index"> '+e.containerIdx+' - </span><span class="rich-object-index"> '+e.index+"  </span>","Sub Requirement"===e.connection?i+=n+'<span class="fonticon fonticon-level-down"></span>'+t+'<span><div id="'+e.id+'_title_content" class="rich-object-title-editable" contenteditable="'+e.editable+'">'+e.title+"</div></span></span></span></span>":i+=n+t+'<span><div id="'+e.id+'_title_content" class="rich-object-title-editable" contenteditable="'+e.editable+'">'+e.title+"</div></span></span></span></span>",f(i)},S=function(e){var t,i,n=" right-border";return w&&(n=""),UWA.is(e.externalObject)&&e.externalObject&&(e.icon="requirement-proxy"),t=e.type_icon_url?'<span class="object-link"><span class="trm-icon" ><img width="16" height="16" src="'+e.type_icon_url+'" onerror="this.onerror=null;"></span> ':'<span class="object-link"><span class="trm-icon trm-icon-'+e.icon+'"></span> ','<div id="'+e.id+'" draggable="true" data-objectid="'+e.objectId+'" data-level="'+e.level+'" data-physicalid="'+e.physicalId+'" data-relid="'+e.connectionId+'" class="rich-object '+e.className+n+'"><div id="'+e.id+'_header" class="rich-object-header"><span class="rich-object-menu"></span><span class="rich-object-header-content">'+(i="",i=widget.getValue("trm_richview_DisableAutoNumbering")?'<span class="rich-object-container-index" style="display: none;"> '+e.containerIdx+' - </span><span class="rich-object-index" style="display: none;"> '+e.index+"  </span>":'<span class="rich-object-container-index"> '+e.containerIdx+' - </span><span class="rich-object-index"> '+e.index+"  </span>","Sub Requirement"===e.connection?i+'<span class="fonticon fonticon-level-down"></span><span class="object-link">'+t+'<span><div id="'+e.id+'_title_content" class="rich-object-title-editable" contenteditable="'+e.editable+'">'+e.title+"</div></span></span>":i+t+'<span><div id="'+e.id+'_title_content" class="rich-object-title-editable" contenteditable="'+e.editable+'">'+e.title+"</div></span></span>")+'</span></span></div><div class="rich-object-body"><div class="rich-object-info"></div><div class="rich-object-content"><div id="'+e.id+'_content" contenteditable="'+e.editable+'" class="content-data">'+e.content+"</div></div></div></div></div>"},R=t.extend(i,n,o,{defaultOptions:{model:null,node:null,rootId:null,mediator:null,id:null,objectId:null,physicalId:null,type:"",kindof:"",title:"",containerIdx:"",index:"",content:"",connection:"",connectionId:null,parentId:null,level:0,editable:"true",droppable:null,placeholder:!1,defaultType:"Requirement",fetchContent:!1,context:null,isDocx:!1,underCA:!1,changeid:"",format:"html",isHTMLReady:!0,convertBeforeEdit:!1,bi_color:null},model:null,node:null,id:null,objectId:null,parentId:null,physicalId:null,connection:null,connectionId:null,level:null,index:null,containerIdx:null,title:null,container:null,info:null,content:null,header:null,menu:null,type:null,kindof:null,context:null,mediator:null,traceabilityAuthoring:!0,isHTMLReady:!0,isDocx:!1,underCA:!1,changeid:"",format:"html",convertBeforeEdit:!1,init:function(e){this._logger=r.getLogger(R),this._logger.log("init"),UWA.merge(e||{},this.defaultOptions),this.options=e,this.model=this.options.model,this.node=this.options.node,this.id=this.options.id,this.objectId=this.options.objectId,this.parentId=this.options.parentId,this.physicalId=this.options.physicalId,this.connection=this.options.connection,this.connectionId=this.options.connectionId,this.level=this.options.level,this.index=this.options.index,this.containerIdx=this.options.containerIdx,this.title=this.options.title,this.type=this.options.type,this.kindof=this.options.kindof,this.context=this.options.context,this.mediator=this.options.mediator,this.cestamp=this.options.cestamp;var t=!1;UWA.is(this.node)&&UWA.is(this.node._options)&&(t=this.node._options.externalObject),this.container=f(S({icon:this.options.kindof.toLowerCase(),title:this.options.title,type_icon_url:this.options.type_icon_url,containerIdx:this.options.containerIdx,index:this.options.index,connection:this.options.connection,level:this.options.level,externalObject:t,id:this.options.id,editable:this.options.editable,content:this.options.content,objectId:this.options.objectId,physicalId:this.options.physicalId,connectionId:this.options.connectionId,type:this.options.type,className:!0===this.options.placeholder?"placeholder":""})),this.menu=this.container.find(".rich-object-menu"),this.info=this.container.find(".rich-object-info"),this.content=this.container.find(".rich-object-content"),this.body=this.container.find(".rich-object-body"),this.header_content=this.container.find(".rich-object-header-content"),this.header=this.container.find(".rich-object-header"),this._lowerMatchUpper={};var i=Object.keys(this.options.droppable);i.forEach(function(e){UWA.is(widget.getPreference("trm_types_"+e))&&widget.getPreference("trm_types_"+e).options.forEach(function(e){-1===f.inArray(e.value,i)&&i.push(e.value)})});for(var n=0;n<i.length;n++)this._lowerMatchUpper[i[n].toLowerCase()]=i[n];this._menuAttached=!1},_subscribeToStopDnD:function(){var e=this;this.mediator.subscribe("onStopDnd",function(t){e._isDnD=!1,e._notDroppable(),e._notDraggable()})},_subscribeToStartDnD:function(){var e=this;this.mediator.subscribe("onStartDnd",function(t){e._isDnD=!0,e._droppable(),e._draggable()})},_subscribeToOnScroll:function(){var e=this;this.mediator.subscribe("onScroll",function(t){e._scroll(t)})},create:function(){return!0===this.options.placeholder?this:(this.node.setRichViewElementID(this.id),this.node.setRichViewElement(this),this._dragging=!1,this._isDnD=!1,this._dropPosition="",this._draggingY=null,!0===this.options.fetchContent&&this.refreshContent(),this._subscribeToStopDnD(),this._subscribeToStartDnD(),this._subscribeToOnScroll(),this.StartLinkCmd=new u({ID:"StartLink_DnD"}),this.EndLinkCmd=new g({ID:"EndLink_DnD",container:".content-panel"}),this)},update:function(e){var t=Object.assign({},e);e=UWA.merge(e||{},this.options),this.options=e;for(var i=Object.keys(t),n=0;n<i.length;n++)switch(i[n]){case"bi_color":UWA.is(e.bi_color)&&""!==e.bi_color?(this.options.bi_color=e.bi_color,this.info.css("border-left-color",e.bi_color)):(this.options.bi_color=null,this.info.attr("style")&&this.info.removeAttr("style"));break;case"level":this.level=this.options.level,this.container.data("level",this.options.level),this.container[0].dataset.level=this.options.level;break;case"underCA":this.options.underCA=e.underCA,this.underCA=this.options.underCA;break;case"changeid":this.options.changeid=e.changeid,this.changeid=this.options.changeid;break;case"content":e.hasOwnProperty("isDocx")&&(this.isHTMLReady=!(e.isDocx&&!e.content),this.convertBeforeEdit=("rtf.gz.b64"==e.format||e.isDocx)&&e.content.toLowerCase().indexOf("<img")>=0,this.isHTMLReady||(this.options.content=y.Msg_NoPreview)),this.context.updateRichContent({content:this.options.content,element:this.container.find(".content-data"),editable:e.editable});break;case"title":if(this.title!==e.title){this.options.title=e.title,this.title=this.options.title;var o=this.header_content[0];o="Sub Requirement"===this.connection?o.children[3].children[0].children[1].children[0]:o.children[2].children[1].children[0],this.context.updateRichContent({content:this.title,element:f(o),editable:this.options.editable}),this.mediator.publish("onRefresh")}break;case"index":this.options.index=e.index,this.options.index=this.options.index,this.container.find(".rich-object-index").text(this.options.index+" ");break;case"containerIdx":this.options.containerIdx=e.containerIdx,this.options.containerIdx=this.options.containerIdx,this.container.find(".rich-object-container-index").text(this.options.containerIdx+" - ");break;case"connection":this.options.connection=e.connection,this.connection=this.options.connection;var r=I({icon:this.options.kindof.toLowerCase(),type_icon_url:this.options.type_icon_url,title:this.options.title,containerIdx:this.options.containerIdx,index:this.options.index,connection:this.options.connection,level:this.options.level,externalObject:this.node._options.externalObject,id:this.options.id,editable:this.options.editable});this.header_content.replaceWith(r),this.header_content=r;break;case"connectionId":this.options.connectionId=e.connectionId,this.connectionId=this.options.connectionId,this.container.data("relid",this.options.connectionId),this.container[0].dataset.relid=this.options.connectionId;break;case"parentId":this.options.parentId=e.parentId,this.parentId=this.options.parentId;break;case"editable":e.editable=!0,(e.underCA&&""===e.changeid&&""!==this.context.getAuthoringContextPID()&&"null"!==this.context.getAuthoringContextPID()&&null!=this.context.getAuthoringContextPID()||""!==e.changeid&&e.changeid===this.context.getAuthoringContextPID())&&(e.editable=!0),e.underCA&&""===this.context.getAuthoringContextPID()&&(e.editable=!1),this.options.editable=e.editable,this.editable=this.options.editable,this.container.find(".content-data").attr("contenteditable",e.editable);case"isDocx":this.options.isDocx=e.isDocx,this.isDocx=this.options.isDocx}},refresh:function(e){e=e||[];for(var t=0;t<e.length;t++)switch(e[t]){case"content":var i=this.container.find(".content-data").html();this.mediator.publish("onUpdateCKEditorContent",{content:i,element:this.container.find(".content-data")});break;case"title":this.context.updateRichContent({content:this.title,element:f(this.header_content[0].children[2].children[1].children[0]),editable:this.options.editable})}},hide:function(){this.container.hide()},show:function(){this.container.show()},_scroll:function(e){var t=this.isVisible(e.position);if(t&&!1===this._menuAttached&&(this._menuAttached=!0,this._menu()),t){if(this._isDnD)return!0;this._isDnD=!0,this._droppable(),this._draggable()}else this._isDnD=!1,this._notDroppable(),this._notDraggable()},_draggable:function(){var e=this,t=!1;this.container.on("mousedown ",function(e){t=f(e.target)}),this.container.on("dragstart",function(i){if(e._dragging=!0,e._draggingY=i.originalEvent.clientY,t.hasClass("rich-object-info")){f(this).addClass("being-dragged"),i.originalEvent.dataTransfer.dropEffect="move";var n=C?"text":"text/searchitems",o=widget.getUrl(),r=(o=o.substr(0,o.indexOf("/webapps"))).substr(o.lastIndexOf("/")+1),a=e.model.getNodesByElementID(e.id)[0],s=a.getOccurencePath();!1===a.isSelected()&&this.hasOwnProperty("hasClassName")&&!1===this.hasClassName("active")&&e.context._selectionMgt(e.info,".rich-object");var l={protocol:"3DXContent",version:"1.1",source:widget.getValue("appId"),data:{items:[{envId:v.getTenant(),serviceId:r,contextId:v.getSecurityContext(),objectId:e.physicalId,objectType:e.type,displayName:e.title,kindof:e.kindof,path:s}]}};if(C){var c={0:e.id,1:e.options.title,2:e.options.type,3:e.options.kindof,4:widget.id,protocol:"3DXContent",version:"1.1",source:widget.getValue("appId"),data:{items:[{envId:v.getTenant(),serviceId:r,contextId:v.getSecurityContext(),objectId:e.physicalId,objectType:e.type,displayName:e.title,kindof:e.kindof,path:s}]}};i.originalEvent.dataTransfer.setData("text",JSON.stringify(c))}else{var d=f(this).find(".rich-object-header .trm-icon")[0];i.originalEvent.dataTransfer.setDragImage(d,-10,-10),i.originalEvent.dataTransfer.setData("0_"+this.id,""),i.originalEvent.dataTransfer.setData("1_"+e.options.title,""),i.originalEvent.dataTransfer.setData("2_"+e.options.type,""),i.originalEvent.dataTransfer.setData("3_"+e.options.kindof,""),i.originalEvent.dataTransfer.setData("4_"+widget.id,""),i.originalEvent.dataTransfer.setData(n,JSON.stringify(l))}}else i.preventDefault()}),this.container.on("dragend",function(t){e._dragging=!1,e._draggingY=null,f(this).removeClass("being-dragged"),e.cleanupHighlight(f(this))})},_notDraggable:function(){this.container.off("mousedown"),this.container.off("dragstart"),this.container.off("dragend")},_droppable:function(){var e=this;this.container.on("dragenter",function(t){if(t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),!1===e.isDroppable(t))return!1}),this.container.on("dragover",function(t){var i=e.isDroppable(t),n=!1,o=!1;if(-1!==f.inArray("text/html",t.originalEvent.dataTransfer.types)&&(t.originalEvent.dataTransfer.dropEffect="copy"),!1===i)return!1;-1!==f.inArray("Files",t.originalEvent.dataTransfer.types)&&(widget.dispatchEvent("onDragOverFiles",t),n=!0);var r=f(this);null==e._draggingY&&(e._draggingY=t.originalEvent.clientY);var a=document.getElementsByClassName("richview-editor-container")[0].getDimensions().width,s=t.originalEvent.clientX,l=t.originalEvent.clientY-e._draggingY;if(l>0){var c=r.next()[0];if(UWA.is(c)){var d=c.getAttribute("id"),p=e.context.getRichObject(d);if(p&&null!=p)if(!p.isVisible()&&a-s<.2*a)e.context.scroller.scrollToElement("#"+d,"center");else{var h=e.context.contentPanel.height()-e.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight;36+p.container.offset().top-e.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight>h&&a-s<.2*a&&e.context.scroller.scrollToElement("#"+d,"center")}}}else if(l<0){var u=r.prev()[0];if(UWA.is(u)){var g=u.getAttribute("id"),m=e.context.getRichObject(g);if(m&&null!=m)if(!m.isVisible()&&a-s<.2*a)e.context.scroller.scrollToElement("#"+g,"center");else m.container.offset().top-e.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight-20<0&&a-s<.2*a&&e.context.scroller.scrollToElement("#"+g,"center")}}if(e._draggingY=t.originalEvent.clientY,r.hasClass("rich-object")||(r=r.parents(".rich-object:first")),r.hasClass("rich-object")){var v=0;do{t.originalEvent.path&&t.originalEvent.path[v].title&&t.originalEvent.path[v].title.contains("Rich Text Editor")&&(o=!0),v++}while(!o&&t.originalEvent.path&&v<t.originalEvent.path.length);return n&&!o||(e._dropPosition=e.updateHighlight(t.originalEvent.clientY,r,i)),!1}}),this.container.on("dragleave",function(t){if(!1===e.isDroppable(t))return!1;var i=f(this);i.hasClass("rich-object")||(i=i.parents(".rich-object:first")),i.hasClass("rich-object")&&e.cleanupHighlight(i)}),this.container.on("drop",function(t){t.preventDefault();var i=f(this);if(e.cleanupHighlight(i),e._dropPosition){if(C){var n=e.handleDataTransferInIE(t.originalEvent);if(UWA.is(n)){if(UWA.is(n.protocol)&&"3DXContent"===n.protocol&&n[4]!==widget.id)return void e.process3DXContentData(n,i)}else if(UWA.is(t.originalEvent.dataTransfer.getData("text"),"string")){var o=e.options.defaultType;UWA.is(widget.getValue("trm_types_"+e.options.defaultType.replace(" ","_")))&&""!==widget.getValue("trm_types_"+e.options.defaultType.replace(" ","_"))&&(o=widget.getValue("trm_types_"+e.options.defaultType)),e.mediator.publish("onInsert",{target:{element:i,id:i.attr("id")},position:e._dropPosition,operation:"insertNew",type:o,kindof:e.options.defaultType,parentId:e.objectId,content:t.originalEvent.dataTransfer.getData("text"),contentType:"html"})}}else{var r=!1;if(UWA.is(t.originalEvent.dataTransfer.types[0],"string")){var a=e.extractFromDataTransfer(t.originalEvent.dataTransfer.types[0]);e.model.getNodesByElementID(a).length>0&&(r=!0)}if(-1!==f.inArray("text/searchitems",t.originalEvent.dataTransfer.types)&&!1===r){var s=t.originalEvent.dataTransfer.getData("text/searchitems"),l=JSON.parse(s);return void e.process3DXContentData(l,i)}if(-1!==f.inArray("Files",t.originalEvent.dataTransfer.types)&&!1===r)return;if(x&&-1!==f.inArray("text/html",t.originalEvent.dataTransfer.types)&&!1===r){o=e.options.defaultType;UWA.is(widget.getValue("trm_types_"+e.options.defaultType.replace(" ","_")))&&""!==widget.getValue("trm_types_"+e.options.defaultType.replace(" ","_"))&&(o=widget.getValue("trm_types_"+e.options.defaultType));var c=t.originalEvent.dataTransfer.getData("text/html");if(c.indexOf("\x3c!--StartFragment--\x3e")>-1&&c.indexOf("\x3c!--EndFragment--\x3e")>-1){var d=c.indexOf("\x3c!--StartFragment--\x3e")+20,p=c.indexOf("\x3c!--EndFragment--\x3e"),h=c.slice(d,p);e.mediator.publish("onInsert",{target:{element:i,id:i.attr("id")},position:e._dropPosition,operation:"insertNew",type:o,kindof:e.options.defaultType,parentId:e.objectId,content:h,contentType:"html"})}else e.mediator.publish("onInsert",{target:{element:i,id:i.attr("id")},position:e._dropPosition,operation:"insertNew",type:o,kindof:e.options.defaultType,parentId:e.objectId,content:t.originalEvent.dataTransfer.getData("text/html"),contentType:"html"});return}if(-1!==f.inArray("text/html",t.originalEvent.dataTransfer.types)&&!1===r){o=e.options.defaultType;return UWA.is(widget.getValue("trm_types_"+e.options.defaultType.replace(" ","_")))&&""!==widget.getValue("trm_types_"+e.options.defaultType.replace(" ","_"))&&(o=widget.getValue("trm_types_"+e.options.defaultType)),void e.mediator.publish("onInsert",{target:{element:i,id:i.attr("id")},position:e._dropPosition,operation:"insertNew",type:o,kindof:e.options.defaultType,parentId:e.objectId,content:t.originalEvent.dataTransfer.getData("text/html"),contentType:"html"})}if(-1!==f.inArray("text/plain",t.originalEvent.dataTransfer.types))return}var u=void 0,g=void 0;if(C){var m=e.handleDataTransferInIE(t.originalEvent);if(!UWA.is(m))return;u=m[0],g=f("#"+u),m[1],m[2],m[3]}else u=e.extractFromDataTransfer(t.originalEvent.dataTransfer.types[0]),g=f("#"+u),e.extractFromDataTransfer(t.originalEvent.dataTransfer.types[1]),e._lowerMatchUpper[e.extractFromDataTransfer(t.originalEvent.dataTransfer.types[2])],e._lowerMatchUpper[e.extractFromDataTransfer(t.originalEvent.dataTransfer.types[3])];e.mediator.publish("onReorder",{source:{element:g,id:u},target:{element:i,id:e.options.id},position:e._dropPosition,type:"rich-object"})}})},_notDroppable:function(){this.container.off("drop"),this.container.off("dragenter"),this.container.off("dragover"),this.container.off("dragleave"),this.container.off("click"),this.container.off("mouseenter"),this.container.off("mouseover"),this.container.off("mouseleave")},_menu:function(){new h({model:this.model,container:this.menu[0],id:this.id,kindof:this.kindof,externalObject:this.node.options.externalObject,type:this.type,externalProviders:this.context.externalProviders}).inject()},refreshContent:function(){var e=this;b.getContent({securityContext:v.getSecurityContext(),pid:e.physicalId,onComplete:function(t){var i=(t=UWA.is(t,"string")?JSON.parse(t):t).results;UWA.is(i["Content Data"])||(i["Content Data"]=""),e.update({content:i["Content Data"],format:i["Content Type"],isDocx:i.isDocx,editable:i.editable})},onFailure:function(t){e.mediator.publish("onNotification",{className:"error",message:t.message})}})},isVisible:function(){var e=this.context.contentPanel.height()-this.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight,t=this.container.height(),i=this.container.offset().top-this.context.topDockingElement.elements.dockingWithCollapserContainer.clientHeight;return i+t>0&&i<e},isDroppable:function(e){if(this._dragging)return!1;if(-1!==f.inArray("cke/id",e.originalEvent.dataTransfer.types))return!1;if(C)return this.options.droppable.Text;var t=!1;if(UWA.is(e.originalEvent.dataTransfer.types[0],"string")){var i=this.extractFromDataTransfer(e.originalEvent.dataTransfer.types[0]);this.model.getNodesByElementID(i).length>0&&(t=!0)}if(-1!==f.inArray("Files",e.originalEvent.dataTransfer.types)&&!1===t)return this.options.droppable.Files;if(-1!==f.inArray("text/searchitems",e.originalEvent.dataTransfer.types)&&!1===t)return this.options.droppable["text/searchitems"];if(-1!==f.inArray("text/plain",e.originalEvent.dataTransfer.types)&&!1===t)return this.options.droppable["text/plain"];if(-1!==f.inArray("Text",e.originalEvent.dataTransfer.types)&&!1===t)return this.options.droppable.Text;var n=e.originalEvent.dataTransfer,o=this._lowerMatchUpper[this.extractFromDataTransfer(n.types[2])],r=this._lowerMatchUpper[this.extractFromDataTransfer(n.types[3])],a=!1;return void 0!==this.options.droppable[o]?a=this.options.droppable[o]:this.options.droppable[r]&&(a=this.options.droppable[r]),this.node._options.externalObject&&(a="before,after"),a},extractFromDataTransfer:function(e){var t=-1!==e.indexOf("_")?e.indexOf("_")+1:0;return e.substring(t)},isInUpperHalf:function(e,t){return e<=t.offset().top+t.outerHeight()/4},isInLowerHalf:function(e,t){return e+t.outerHeight()/4>=t.offset().top+t.outerHeight()},updateHighlight:function(e,t,i){return this.isInUpperHalf(e,t)&&-1!==i.indexOf("before")?t.prev().hasClass("droppable-above")?"before":(t.removeClass("droppable-child"),t.next().hasClass("droppable-below")&&t.next().remove(),t.before('<div class="droppable-target droppable-above wux-datagrid-row-insertion-mark"></div>'),"before"):this.isInLowerHalf(e,t)&&-1!==i.indexOf("after")?t.next().hasClass("droppable-below")?"after":(t.removeClass("droppable-child"),t.prev().hasClass("droppable-above")&&t.prev().remove(),t.after('<div class="droppable-target droppable-below wux-datagrid-row-insertion-mark"></div>'),"after"):-1!==i.indexOf("over")?t.hasClass("droppable-child")?"over":(t.next().hasClass("droppable-below")&&t.next().remove(),t.prev().hasClass("droppable-above")&&t.prev().remove(),t.addClass("droppable-child"),"over"):void 0},cleanupHighlight:function(e){e.removeClass("droppable-child"),e.next().hasClass("droppable-below")?e.next().remove():e.prev().hasClass("droppable-above")&&e.prev().remove()},handleDataTransferInIE:function(e){var t=e.dataTransfer.getData("text"),i=void 0;try{i=JSON.parse(t)}catch(e){i=void 0}return i},process3DXContentData:function(e,t){var i=this;if(e.source===widget.getValue("appId"))if("Requirement"===e.data.items[0].kindof){var n={id:e.data.items[0].objectId,physicalId:e.data.items[0].objectId,type:e.data.items[0].objectType,kindof:e.data.items[0].kindof,path:e.data.items[0].path,title:e.data.items[0].displayName};i.StartLinkCmd.execute(n);var o=i.model.getNodesByElementID(i.id)[0].getOccurencePath(),r=[{id:i.objectId,physicalId:i.physicalId,type:i.type,kindof:i.kindof,path:o,title:i.title}];i.EndLinkCmd.execute(r)}else i.context.displayNotification({msg:_.RichView_Notif_NotAuthorized,eventID:"error"});else{var a=e.data.items[0].objectType,s=e.data.items[0].objectId;b.getKindOf({securityContext:v.getSecurityContext(),pid:s,onComplete:function(n){var o=(UWA.is(n,"string")?JSON.parse(n):n).results,r=i.options.droppable[o];if(!UWA.is(r)||-1===r.indexOf(i._dropPosition))return i.mediator.publish("onNotification",{className:"error",message:_.RichView_Notif_NotAuthorized}),!1;var s=e.data.items[0].objectId;i.mediator.publish("onInsert",{operation:"insertExisting",position:i._dropPosition,type:a,objectId:s,content:"",contentType:"",kindof:o,target:{element:t,id:t.attr("id")},fetchContent:!0})}})}}});return R}),define("DS/RichView/RichView",["UWA/Core","UWA/Controls/Abstract","UWA/Class/Options","UWA/Class/Events","UWA/Class/Promise","DS/Logger/Logger","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/jQueryUI","DS/UIKIT/Scroller","DS/CATSystemSlidePanel/SlidePanel","DS/RichView/Navigation","DS/RichView/RichContentEditor","DS/RichView/Views/RichObject","DS/RichView/Views/RichContainer","DS/RichView/Views/RichViewIdCard","DS/UIKIT/Alert","DS/UIKIT/Mask","DS/UIKIT/Spinner","DS/Controls/ProgressBar","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/TraceableRequirementsUtils/utils/RequirementAlertManager","DS/TraceableRequirementsUtils/Utils","DS/RichView/Service/WidgetPreferences","DS/RichView/Views/DropInvit","DS/RichView/Views/RichViewInfos","DS/PlatformAPI/PlatformAPI","DS/RichView/Service/KeyboardShortcuts","DS/PADUtils/PADContext","DS/PADUtils/PADCommandProxy","DS/TraceableRequirementsUtils/utils/TRMSearchNav","DS/RichEditor/RichEditor","DS/i3DXCompassServices/i3DXCompassPubSub","DS/RichView/Models/RichViewDocument","DS/RichView/Models/RichViewModelParser","DS/RichView/mixins/_delimiterUtilities","DS/TraceableRequirementsUtils/REQCommandProxy","DS/RichView/mixins/_RichBIFilter","DS/Windows/DockingElement","i18n!DS/RichView/assets/nls/RichView","text!DS/RichView/assets/RichViewSetting.json","css!DS/RichView/RichView.css"],function(e,t,i,n,o,r,a,s,l,c,d,p,h,u,g,f,m,v,b,_,y,C,x,w,I,S,R,E,D,A,T,U,O,k,N,W,V,P,j,L){"use strict";var q=function(e){return a('<div class="main-panel">   <div class="navigation-panel"></div>   <div class="content-panel">       <div class="id-card-panel"></div>       <div class="richview-editor-container"> <div class="richview-editor-content"></div>       </div>   </div>   <div class="properties-panel off"></div></div>')},F={serverStart:0,serverEnd:0,buildStart:0,buildEnd:0,contentStart:0,contentEnd:0};function M(){var e="";do{e="object_"+Math.floor(1e6*Math.random())}while(z[e]);return z[e]=e,e}var B="",H=45,z={},K={},J=null,Q=null,X=!1,G=!1,Y=!1,$=!1,Z=!1,ee=!1,te=!1,ie=!1,ne=!1,oe=!1,re=!1,ae=!0,se="",le=JSON.parse(L),ce=t.extend(i,n,V,N,{name:"richview_container",defaultOptions:{isSemanticQualityPanelOpen:!1,x3dAppId:"REQ_appId",mediator:null,data:null,root:"Requirement Specification",rich:"Requirement,Comment",container:"Chapter",authorizeChangeControl:!0,CfgAuthoringContext:null,droppable:{Requirement:{Requirement:"before,after,over",Comment:"before,after",Chapter:"before,after",Files:"over","text/plain":"before,after,over","text/html":"before,after,over","text/searchitems":"before,after,over",Text:"before,after,over"},Comment:{Requirement:"before,after",Comment:"before,after",Chapter:"before,after",Files:"over","text/plain":"before,after","text/html":"before,after","text/searchitems":"before,after,over",Text:"before,after,over"},Chapter:{Chapter:"before,after,over",Requirement:"before,after,over",Comment:"before,after,over","text/plain":"over","text/html":"over","text/searchitems":"before,after,over",Text:"before,after,over"},"Requirement Specification":{Chapter:"over",Requirement:"over",Comment:"over"}},relationship:{Requirement:"Sub Requirement",Chapter:"Specification Structure","Requirement Specification":"Specification Structure"}},_logger:null,_commandProxy:null,_padCommandProxy:null,_reqCommandProxy:null,_curentlyLoadingReqSpec:!1,_smvSelectionEvent:null,externalTypes:["ProxyItem"],externalProviders:!1,OSLCProviders:void 0,_csrf:null,_isReady:{actionbar:!1,richview:!1,dropinvite:!1},_isSelectionEmpty:!0,_traceabilityScope:{id:null,title:null},context:null,init:function(e){if(Q=this,"dummy"!=widget.id)try{require(["text!DS/OSLCConsumer/assets/OSLCConfig.json"],function(e){Q.OSLCProviders=JSON.parse(e),UWA.is(Q.OSLCProviders)&&UWA.is(Q.OSLCProviders.repositories)&&Q.OSLCProviders.repositories.length>0&&(Q.externalProviders=!0)})}catch(e){console.log("/OSLCConsumer/assets/OSLCConfig.json file not found")}UWA.merge(e||{},Q.defaultOptions),this._parent(e),this._logger=r.getLogger(ce),this._logger.log("init"),E.set(this),Q.context=E.get(),UWA.is(widget.getValue("x3dAppId"))||widget.addPreference({name:"x3dAppId",type:"hidden",defaultValue:Q.defaultOptions.x3dAppId}),0==widget.getValue("trm_richview_optimizedloading")&&widget.setValue("trm_richview_optimizedloading",!0),widget.addPreference({name:"trm_richview_optimizedloading",defaultValue:!0,type:"hidden",value:!0,label:j.TRM_OptimizationLoading}),widget.addPreference({name:"trm_richview_usespellchecker",type:"boolean",defaultValue:!1,label:j.TRM_SpellCheckActivation}),widget.addPreference({name:"trm_richview_DisableAutoNumbering",type:"boolean",defaultValue:!1,label:j.TRM_DisableAutoNumbering}),Q.options.model=new O,self.widget.addEvent("endEdit",function(){Q.utilities.onEndEdit(),Q._onWidgetResize()}),Q.initializeBI(Q)},inject:function(e){return this.mediator=this.options.mediator,this.container=e,a(e).parent().css("height","100%"),a(e).css("height","100%"),this.richView=a(this.container).append(q()),this.contentPanel=a(".content-panel",this.richView),this.idCardPanel=a(".id-card-panel",this.richView),this.richViewEditorContainer=a(".richview-editor-container",this.richView),this.richViewEditorContent=a(".richview-editor-content",this.richView),this.navigationPanel=a(".navigation-panel",this.richView),this.propertiesPanel=a(".properties-panel",this.richView),this.richviewinfos=new I({renderTo:UWA.Element.getElement.call(document,".AfrActionBar"),events:{}}),this.contentPanel.on("dblclick",".content-data",function(e){var t=new T;if(!("Word"!=t.getPreferredEditor()||t.isMobile&&t.isMobile())){var i=a(this).closest(".rich-object"),n=Q.options.model.getNodesByElementID(i.attr("id"))[0],o=n.options.matrixID;if(UWA.is(n)&&UWA.is(n.options.externalObject)&&n.options.externalObject)return void Q.displayNotification({eventID:"error",msg:j.RichView_Notif_NotAuthorized});var r=n.getRichViewElement();if(!r.isHTMLReady)return;t.openRichTextInWord({uid:o,onClose:function(e,i,n){a("DIV.rich-object[data-objectid='"+e+"'] .content-data").html(n),t.saveRichText(e,i),(r=Q.options.model.getNodesByElementID(a("DIV.rich-object[data-objectid='"+e+"']").attr("id"))[0]).update({content:n})}})}}),C.app_initialization(function(){Q._initWidgetPreferences(),Q._loadData(),UWA.is(Q.CfgAuthoringContext)||Q._checkIfChangeControlEnabled(function(e){e&&require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext"],function(e){Q.CfgAuthoringContext=e;var t=document.querySelector(".Content");e.initialize2(t,W.appId(),"show","bottom-right",function(e){Q.dispatchEvent("onAuthoringCtxAvailable",e),S.subscribe(Q.CfgAuthoringContext.myAuthkey,function(e){setTimeout(function(){Q.mediator.publish("onRefresh")},1e3)}),S.subscribe("toggleDeActiveCA"+Q.CfgAuthoringContext.myAuthkey,function(e){setTimeout(function(){Q.mediator.publish("onRefresh")},200)}),S.subscribe("toggleActiveCA"+Q.CfgAuthoringContext.myAuthkey,function(e){setTimeout(function(){Q.mediator.publish("onRefresh")},200)}),S.subscribe("removeAuthCtxEvent"+Q.CfgAuthoringContext.myAuthkey,function(e){setTimeout(function(){Q.mediator.publish("onRefresh")},200)})},{isEvolution:!1})})})}),Q.isConcurrentEngineeringEnabled="false",_.getReQConfigAuthManagement({familyid:"ConcurrentEngineering",onComplete:function(e){var t=JSON.parse(e);t.family[0]&&t.family[0].parameter.forEach(function(e){"ReqCEEnabled"==e.id&&e.argument.forEach(function(e){"Enabled"===e.argValue&&(Q.isConcurrentEngineeringEnabled="true")})})},onFailure:function(e){console.log(e)}}),this},_initWidgetEvents:function(){!1===widget.hasEvent("onRefresh")&&widget.addEvent("onRefresh",function(){Q._onWidgetRefresh()}),!1===widget.hasEvent("onResize")&&widget.addEvent("onResize",function(){Q._onWidgetResize()}),!1===widget.hasEvent("onDestroy")&&widget.addEvent("onDestroy",function(){Q._onWidgetDestroy()}),!1===widget.hasEvent("onSearch")&&widget.addEvent("onSearch",function(e){console.log("Search in Current Dashboard called with query : "+e),re=!0,se=e,ae=!1,Q._onWidgetSearch(e)}),!1===widget.hasEvent("onResetSearch")&&widget.addEvent("onResetSearch",function(){ae=!0,console.log("Reset Search in Current Dashboard "),re=!1,se="",Q._onWidgetSearch()})},_loadData:function(){var e=null,t=this.utilities.useCompassContent(),i=this.utilities.reloadSaveObject(),n=!1;UWA.is(this.options.data)&&""!==this.options.data?(n=!0,Q._buildView(),this.json=this.options.data,this.root=this.json[0],_.getInfo({securityContext:C.getSecurityContext(),pid:e,selectables:"type,name,revision,type.kindof,attribute[Title],physicalid,id",onComplete:function(e){e=UWA.is(e,"string")?JSON.parse(e):e,k.process.root({treedocument:Q.options.model,data:e.results[0],tenant:C.getTenant()},Q.externalTypes),Q._richView(Q.json),Q.mediator.publish("onRefresh"),Q._startEdition()}})):UWA.is(t)&&""!==t?e=t:UWA.is(i)&&""!==i&&(e=i),UWA.is(e)?_.getInfo({securityContext:C.getSecurityContext(),pid:e,selectables:"type,name,revision,type.kindof,attribute[Title],physicalid,id",onComplete:function(t){var i=(t=UWA.is(t,"string")?JSON.parse(t):t).results[0]["type.kindof"];-1!=Q.options.root.indexOf(i)?(Q.options.data=e,k.process.root({treedocument:Q.options.model,data:t.results[0],tenant:C.getTenant()},Q.externalTypes),Q._init()):Q._initDropZone()},onFailure:function(e){Q._initDropZone()},onTimeout:function(){Q._initDropZone()}}):!0!==n&&Q._initDropZone()},_initDropZone:function(){Q.mediator.subscribe("onInitialDrop",function(e){Q._onInitialDrop(e)}),Q.mediator.subscribe("onRemoveDropInvit",function(e){Q.dropinvit.remove(),Q.options.data=e,Q._init()}),Q.dropinvit=new w({renderTo:Q.container,mediator:Q.mediator,selector:".moduleContent"}),Q._initWidgetEvents(),Q._initProxyEvents()},_onRootSelction:function(e){console.log(e+" :rootObject");var t=this,i=e.id.split("_")[2];_.getKindOf({securityContext:C.getSecurityContext(),pid:i,onComplete:function(e){var n=(UWA.is(e,"string")?JSON.parse(e):e).results;n!==t.options.root&&"DOCUMENTS"!==n||(Q.utilities.saveObject(i),Q._onWidgetRefresh())},onFailure:function(e){Q._logger.log(e)}})},applyFilter:function(e){console.log("filter RichView Data",e);var t=this,i="";i=e.filterRootIds?e.filterRootIds[0]:e.resourceid;var n=[],r=!1,s=new o(function(t,n){0==e.empty?_.getKindOf({securityContext:C.getSecurityContext(),pid:i,onComplete:function(e){var i=(UWA.is(e,"string")?JSON.parse(e):e).results;console.log("Kind Of: "+i),"Requirement Group"==i&&(r=!0),t()},onFailure:function(e){Q._logger.log(e),n()}}):t()});s&&n.push(s),o.allSettled(n).then(function(n){if(!r){var o=e.CVQuery;if(e.empty)t._onWidgetRefresh();else t.req_navigate_options=le,UWA.is(o.expand_iter,"string")||(o.expand_iter="-1"),o.intent="explore_2D",(o=UWA.extend(o,t.req_navigate_options.expand.cv_expand_data.no_folder_expand,!0)).authored=!1,o.union?o.union.expand.forEach(function(e,t){delete e["q.iterative_filter_query_bo"],delete e.no_type_filter_rel}):o.intersection&&o.intersection.expand.forEach(function(e,t){delete e["q.iterative_filter_query_bo"],delete e.no_type_filter_rel}),t.options.model.getRoots()[0].options.children=null,(a(".scroller-content",t.contentPanel).length>0?a(".scroller-content",t.contentPanel):t.richViewEditorContent).empty(),_.navigate({data:o,onComplete:function(e){e=UWA.is(e,"string")?JSON.parse(e):e;var n=t.options.model.getRoots()[0],o={treedocument:t,root_nodes:[n],response:e,mode:"default",authored:!1,filterMode:!0,expand_level:-1},r=k.process.expand(o,t.externalTypes);_.getStructureWithStreaming({id:i,onComplete:function(e){e=UWA.is(e,"string")?JSON.parse(e):e,console.log(e);var i=[];e.forEach(function(e){var t=r.nodes[e.physicalid];t&&t.req_name&&i.push(e)}),t._richView(i)}})},onFailure:function(e){console.log("rich view filetr after navigate",e),Q.displayNotification({eventID:"error",msg:j.RichView_Notif_LoadError}),Q._initDropZone()}})}})},_init:function(){this._initWidgetEvents(),this._initProxyEvents(),this._initMediatorEvents(),this.current_selection={element:null,objectId:Q.options.model.getRoots()[0].getID(),physicalid:Q.options.model.getRoots()[0].options.matrixID,kindof:Q.options.model.getRoots()[0].options.kindof,type:Q.options.model.getRoots()[0].options.type,path:Q.options.model.getRoots()[0].getOccurencePath(),ParentLabel:Q.options.model.getRoots()[0].getParent().options.title,label:Q.options.model.getRoots()[0].options.title},Q.options.model.getRoots()[0].select(),UWA.is(this.options.data,"string")&&this._fetchData(this.options.data),this._initKeyboardShortcuts(),this._initWidgetPreferences(),this.utilities.setWidgetTitle(),this.utilities.saveObject(this.options.data),this.rootId=this.options.data,this._promises=[],this._promisesData=[],widget.dispatchEvent("onCheckScopeRV")},_onInitialDrop:function(e){Q.options.data=e,_.getInfo({securityContext:C.getSecurityContext(),pid:e,selectables:"type,name,revision,type.kindof,attribute[Title],physicalid,id",onComplete:function(e){e=UWA.is(e,"string")?JSON.parse(e):e;var t=UWA.is(e.results[0].type,"object")?e.results[0].type.value:e.results[0].type,i=e.results[0]["type.kindof"];-1!=Q.options.root.indexOf(t)||-1!=Q.options.root.indexOf(i)?(k.process.root({treedocument:Q.options.model,data:e.results[0],tenant:C.getTenant()},Q.externalTypes),Q._init()):(Q.displayNotification({eventID:"warning",msg:j.RichView_Notif_NotAuthorized}),Q._initDropZone())},onFailure:function(e,t){Q.displayNotification({eventID:"error",msg:j.RichView_Notif_LoadError}),Q._initDropZone()},onTimeout:function(e){Q.displayNotification({eventID:"error",msg:j.RichView_Notif_LoadError}),Q._initDropZone()}}),Q._reqCommandProxy.drop({id:e,appId:widget.getValue("appId"),widgetId:widget.id,action:"load"})},_subscribers:{subscribeToRefreshElement:function(){return Q.mediator.subscribe("onRefreshElement",function(e){var t=e.element.attr("id"),i=e.refresh;Q.options.model.getNodesByElementID(t)[0].getRichViewElement().refresh(i)}),!0},subscribeToUpdateElement:function(){return Q.mediator.subscribe("onUpdateElement",function(e){for(var t=e.updates,i=Q.options.model.getNodesById(e.physicalId),n=0;n<i.length;n++)i[n].getRichViewElement().update(Object.assign({},t))}),!0},subscribeToNavigationClick:function(){return Q.mediator.subscribe("onNavigationClick",function(e){Q.scroller.scrollToElement("#"+e,"top"),a("#"+e).hasClass("active")||a("#"+e).find(".rich-container-title-index,.rich-object-info").click()}),!0},subscribeToDragActionInsertRequirement:function(){return Q.mediator.subscribe("onDrag:ActionInsertRequirement",function(e){var t=a(e.target).data("current-droppable");t&&updateHighlight(e.ui,t)}),!0},subscribeToRefresh:function(){return Q.mediator.subscribe("onRefresh",function(e){Q.refreshView(e)}),!0},subscribeToNotification:function(){return Q.mediator.subscribe("onNotification",function(e){J.add({className:e.className,message:e.message})}),!0},subscribeToInsert:function(){return Q.mediator.subscribe("onInsert",function(e){Q.authoring.insertWithPromise(e)}),!0},subscribeToReorder:function(){return Q.mediator.subscribe("onReorder",function(e){Q.authoring.reorder(e)}),!0},subscribeToOnNewRichView:function(){return Q.mediator.subscribe("onNewRichView",function(e){Q.utilities.saveObject(e),Q._onWidgetRefresh()}),!0}},onInnerSelection:function(e,t){var i=Q.options.model.getSelectedNodes()[0],n=!1;i&&i.getID()!==e.getID()&&(i.unselect(),i.cleanupHighlightHeader(),e.select(),n=!0);var o=e.getOccurencePath();!Q.externalSelection&&Q._reqCommandProxy&&!1!==ae?(Q._reqCommandProxy.reqSelect({paths:[o],appId:widget.getValue("appId"),widgetId:widget.id}),Q.externalSelection=!1):!1===ae&&(ae=!0);var r={paths:[o],attributes:{}};r.attributes[e.getID()]={tenant:C.getTenant()},i&&1!=n||Q._padCommandProxy.select(r);var a=UWA.is(e.getRichViewElement())?e.getRichViewElement().container:null;Q.current_selection={element:a,objectId:e.options.matrixID,physicalid:e.getID(),kindof:e.options.kindof,type:e.options.type,path:o,ParentLabel:e.getParent().options.title,label:e.options.title},U.publish("setObject",{objectId:e.getID(),envId:C.getTenant(),contextId:C.getSecurityContext()}),Q.idcard.updateSelection(),Q._logger.log("An object has been selected in RichView",e)},onCleanSelection:function(e){if(0===Q.contentPanel.find(".rich-object.active, .rich-container.active").length){Q.options.model.unselectAll(),Q.options.model.getRoots()[0].select(),Q.current_selection={element:null,objectId:Q.rootId,physicalid:Q.rootId,kindof:Q.options.root,type:Q.options.parentType,path:[Q.rootId],ParentLabel:Q.options.model.getRoots()[0].getParent().options.title,label:Q.options.model.getRoots()[0].options.title},!1!==e&&Q._reqCommandProxy.reqSelect({paths:[[Q.rootId]],appId:widget.getValue("appId"),widgetId:widget.id});var t={paths:[[Q.rootId]],attributes:{}};t.attributes[Q.rootId]={tenant:C.getTenant()},Q._padCommandProxy.select(t),Q.idcard.updateSelection()}},cleanAll:function(){Q.richView.empty(),Q._resetMembers(),Q.utilities.cleanObject(),Q.utilities.cleanWidgetTitle(),Q.inject(Q.container),Q.options.model.getModelEvents().publish({event:"setPathTags",context:Q.options.model})},_onWidgetDestroy:function(){Q._padCommandProxy.destroy(),Q._reqCommandProxy.destroy(),Q.cleanAll(),Q._logger.log("onWidgetDestroy")},_onWidgetResize:function(){if(Q._logger.log("onWidgetResize"),"true"===UWA.Element.getElement.call(document,".AfrActionBar").getAttribute("data-open"))var e=Q.richView.parent().parent().height()-70;else e=Q.richView.parent().parent().height()-20;Q.richView.parent().height(e),Q.options.height=e;var t=UWA.Element.getElement.call(document,".wux-windows-docking-and-collapser.wux-docking-element-top.hidden-xs"),i=t.offsetHeight;UWA.is(t)&&("none"===t.getStyle("display")?UWA.Element.getElement.call(document,".wux-windows-docking-element-free-zone.wux-docking-element-top").style.height="100%":UWA.Element.getElement.call(document,".wux-windows-docking-element-free-zone.wux-docking-element-top").style.height="calc(100% - "+i+"px)"),Q.navigationPanel&&Q.navigationPanel.updateSize&&Q.navigationPanel.updateSize(Q.richView.parent().width(),Q.options.height),Q.navigation&&Q.navigation.resizeList&&Q.navigation.resizeList(),Q._resizeContentPanel(),Q.richviewinfos.setBody(),UWA.is(Q._reqCommandProxy)&&Q._reqCommandProxy.resizeRV()},_onWidgetRefresh:function(){Q._logger.log("onWidgetRefresh"),Q.richView.empty(),Q._resetMembers(),Q.inject(Q.container)},_onWidgetSearch:function(e){var t=e,i=[];se&&se.length>0?t=se:re&&!1===re&&Q.utilities._pagerview.hide();var n=Q.options.model.getRoots()[0];n&&Q._isRich(n.options.kindof)&&(n.matchString(t)?i.push(n.getRelationID()):n.cleanupHighlightHeader());for(var o=n?n.getAllDescendants():[],r=0;r<o.length;r++)o[r].matchString(t)?i.push(o[r].getRelationID()):o[r].cleanupHighlightHeader();i.length>0?(Q.utilities.displayTRMSearchNav(i),Q.utilities.reframeOn()):Q.utilities&&Q.utilities._pagerview&&Q.utilities._pagerview.hide(),i.length<=0&&""!=t&&null!=t&&y.notifyAlert(j.SearchWithInDashboard_OccurenceNotFound)},_resetMembers:function(){F={serverStart:0,serverEnd:0,buildStart:0,buildEnd:0,contentStart:0,contentEnd:0},{},0,9999,B="",{},void 0,9999,15,H=45,z={},K={},Q.scroller=null,this.shortcuts&&this.shortcuts.removeKeyboardEventsListener(),this._defineDefaultTypes(),this.current_selection={},this.options.data=null,this.rootId=null,Q.options.model.unselectAll(),Q.options.model.removeRoots()},_initProxyEvents:function(){UWA.is(this._padCommandProxy)||(this._padCommandProxy=D.create({events:{onRefresh:function(e){Q.utilities.refreshAuthoredObject(e)},onSelect:function(e,t){Q.externalSelection=!0,Q.utilities.syncViewOnExternalSelection(e),Q.externalSelection=!1}}})),UWA.is(this._reqCommandProxy)||(this._reqCommandProxy=W.create({events:{onReqSelect:function(e,t){Q.utilities.syncViewOnInternalSelection(e),console.log("rich view req select event",e),console.log("rich view req select data",t),console.log("rich view req select data widget id",widget.id),console.log("rich view req select data widget x3dSharedId",widget.getValue("x3dSharedId")),setTimeout(function(){if(e.data&&e.data.filtered){var t=e.data;Q.applyFilter(t)}},1e3)},onDrop:function(e){Q._curentlyLoadingReqSpec||(Q._curentlyLoadingReqSpec=!0,Q.utilities.loadSpec(e))},onAttach:function(e){Q.externalSelection=!0,Q.utilities.attachObject(e)},onDetach:function(e){Q.utilities.detachObject(e)},onReorder:function(e){Q.utilities.reorderObject(e)},onPreferenceModification:function(e){Q.utilities.updatePreferences(e)},onRevise:function(e){Q.utilities.reviseObject(e)}}})),UWA.is(this._smvSelectionEvent)||(this._logger.log("Listening to topic DS/CATSmmUI/3DExperience/Proxy/localSelectionChanged"),this._smvSelectionEvent=S.subscribe("DS/CATSmmUI/3DExperience/Proxy/localSelectionChanged",function(e){Q.utilities.syncViewOnExternalSelection(e)}))},_initMediatorEvents:function(){!0!==ne&&(ne=this._subscribers.subscribeToRefreshElement()),!0!==ie&&(ie=this._subscribers.subscribeToUpdateElement()),!0!==X&&(X=this._subscribers.subscribeToNavigationClick()),!0!==G&&(G=this._subscribers.subscribeToDragActionInsertRequirement()),!0!==Y&&(Y=this._subscribers.subscribeToNotification()),!0!==$&&($=this._subscribers.subscribeToInsert()),!0!==Z&&(Z=this._subscribers.subscribeToReorder()),!0!==ee&&(ee=this._subscribers.subscribeToRefresh()),!0!==te&&(te=this._subscribers.subscribeToOnNewRichView())},_initKeyboardShortcuts:function(){null===this.shortcuts&&(this.shortcuts=R.init()),this.shortcuts.addKeyboardEventListener()},_initWidgetPreferences:function(){var e=this._defineOptionsForPref();(new x).addPreferencesToWidget(e)},_defineOptionsForPref:function(){var e={types:[]},t=Q.options.rich.split(","),i=Q.options.container.split(","),n=t.concat(i);return n.push(Q.options.root),n.forEach(function(t){e.types.push(t)}),e.events={onUpdateTypePreferences:function(e){Q._defineDefaultTypes()}},e},_defineDefaultTypes:function(){this._defaultTypes={"Requirement Proxy":"Requirement"};var e=Q.options.rich.split(","),t=Q.options.container.split(","),i=e.concat(t);i.push(Q.options.root),i.forEach(function(e){var t=e.replace(" ","_"),i=(widget.getValue("trm_types_"+t),widget.getPreference("trm_types_"+t));UWA.is(i)?i.options.forEach(function(t){Q._defaultTypes[t.value]=e}):Q._defaultTypes[e]=e})},scrollToElement:function(e){Q.scroller.scrollToElement("#"+e,"top")},updateScopeInformation:function(e){this.idcard.updateScope(e)},getRelationshipType:function(e){return Q.options.relationship[e]},getDefaultType:function(e){var t=e.replace(" ","_"),i=widget.getPreference("trm_types_"+t);return UWA.is(i)?widget.getValue("trm_types_"+t):e},saveCSRF:function(e){this._csrf=e},getCSRF:function(){return this._csrf},getTenant:function(){return C.getTenant()},getAuthoringContextPID:function(){var e=null;if(UWA.is(Q.CfgAuthoringContext)&&UWA.is(Q.CfgAuthoringContext.get)){var t=Q.CfgAuthoringContext.get();e=UWA.is(t)&&UWA.is(t.change.id)?t.change.id:null}return e},_buildView:function(){m.mask(UWA.Element.getElement.call(document,".main-panel")),this.options.height=this.richView.parent().height(),this.navigation=null,this._currentPosition=0,this._navigationPanel(),J=new f({closable:!0,visible:!0,autoHide:!0,fullWidth:!0,hideDelay:3e3}).inject(UWA.Element.getElement.call(document,this.contentPanel.selector)),this.idcard=new g({physicalid:Q.options.data,container:this.idCardPanel}),this._scrollView(),this.topDockingElement=new P({identifier:Q.options.data+"_idcard_docking",side:WUXDockAreaEnum.TopDockArea,dockingZoneSize:60,resizableFlag:!1,interactiveDockAreaVisibleFlag:!1,dockingZoneContent:UWA.Element.getElement.call(document,this.idCardPanel.selector),freeZoneContent:UWA.Element.getElement.call(document,this.richViewEditorContainer.selector)}).inject(UWA.Element.getElement.call(document,this.contentPanel.selector)),this.topDockingElement.elements.dockingWithCollapserContainer.addClassName("hidden-xs"),this._onWidgetResize(),this._attachControls()},displayNotification:function(e){J?J.add({className:e.eventID,message:e.msg}):alert(e.msg)},getProxyContentData:function(e,t){var i,n,o=this,r=this.context.OSLCProviders,s="[ "+j.get("ExternalObject_LoadingError")+" ]",l=j.get("ExternalObject_LoadingError");if(UWA.is(e.getClosest,"function"))i=e.getClosest(".rich-object[data-physicalid][data-relid]");else{i=UWA.is(e.closest,"function")?e.closest(".rich-object[data-physicalid][data-relid]"):function(e,t){for(;(e=e.parentElement)&&!(e.matches||e.matchesSelector||e.msMatchesSelector).call(e,t););return e}(e,".rich-object[data-physicalid][data-relid]"),console.error('"nodeToSelect" is not a UWA element!')}if(!UWA.is(i)&&!UWA.is(r))return console.error('Proxy content data cannot be retreived! Check rich-object for (1)                  "data-relid", (2) "data-physicalid" and (3) check if context.OSLCProviders is defined.'),void(UWA.is(o.mediator)&&o.mediator.publish("onNotification",{className:"error",message:l}));n=e.hasClassName("content-data")?e:e.getElement(".content-data");var c=i.attributes["data-physicalid"].value,d=i.attributes["data-relid"].value,p=UWA.createElement("span",{class:"richview-loading-external-indication",html:j.get("ExternalObject_LoadingContent")+" "});new v({class:"richview-spinner"}).inject(p).show();n.innerHTML="",p.inject(n),_.getInfo({securityContext:C.getSecurityContext(),pid:c,onComplete:function(e){for(var t=(e=UWA.is(e,"string")?JSON.parse(e):e).results[0],i=t["ProxyItem.Proxy_Service"],n=t["ProxyItem.Proxy_URL"],c="",p="",h=0;h<r.repositories.length;h++){i===r.repositories[h].id&&(c=r.repositories[h].rootUrl,p=r.repositories[h].oauth);break}var u=o.context.options.model.getNodesByRelId(d)[0].getRichViewElement();_.getOSLCContent({service:i,doors_url:c+n,tenant:C.getTenant(),Oauth:p,method:"GET",dataType:"xml",onComplete:function(e){var t;e=a(a.parseXML(e));UWA.is(e[0].lookupNamespaceURI("jazz_rm"))?(t=e[0].getElementsByTagNameNS(e[0].lookupNamespaceURI("jazz_rm"),"primaryText"),UWA.is(t[0])?u.update({content:t[0].firstChild.innerHTML}):(console.error("Tag with proxy req content was not found in response."),u.update({content:s}))):(t=e[0].getElementsByTagNameNS(e[0].lookupNamespaceURI("dcterms"),"description"),UWA.is(t[0])?u.update({content:t[0].innerHTML}):(console.error("Tag with proxy req content was not found in response."),u.update({content:s})))},onFailure:function(e){o._logger.log(e),o.mediator.publish("onNotification",{className:"error",message:l}),u.update({content:s})}})},onFailure:function(e){o._logger.log(e),o.mediator.publish("onNotification",{className:"error",message:l}),proxy_object.update({content:s})},onTimeout:function(){o.mediator.publish("onNotification",{className:"error",message:l}),proxy_object.update({content:s}),o._logger.log("RequirementWebServices.getInfo timed out")}})},showProgressBar:function(){Q.utilities.loading()},hideProgressBar:function(){Q.utilities.loading(!0)},refreshView:function(e){for(var t=a(".rich-container",Q.contentPanel),i=0;i<t.length;i++)if(Q.options.model.getNodesByElementID(t.eq(i).attr("id")).length>0){var n=Q.options.model.getNodesByElementID(t.eq(i).attr("id"))[0],o=n.getRichViewElement(),r=Q.GetContainerLevel(n),s=Q.GetParentContainer(n);UWA.is(s)&&(r=s.getRichViewElement().index+"."+r),B=r,o.update({index:B})}Q._refreshRichObjectIdx(e)},_refreshRichObjectIdx:function(e){for(var t=a(".rich-object:not(.placeholder)",Q.contentPanel),i=0;i<t.length;i++){var n=Q.options.model.getNodesByElementID(t.eq(i).attr("id"))[0];if(null!=n){var o=n.getRichViewElement(),r=parseInt(o.level),s=Q._generateObjectIdx(n);if(UWA.is(e)&&UWA.is(e.level)&&r<e.level)continue;o.update({containerIdx:s.containerIdx,index:s.index})}}},_generateObjectIdx:function(e){e.getLevel();var t=e.getParent();if(-1==t._nodeDepth)return{index:0,containerIdx:0};var i="",n="";return Q._isContainer(t.options.type)||Q._isContainer(t.options.kindof)||!0===t.isRoot()?(i=!0===t.isRoot()?"0":t.getRichViewElement().index,n=Q.GetRichObjectLevel(e)):(i=t.getRichViewElement().containerIdx,n=Q.GetRichObjectLevel(e),n=t.getRichViewElement().index+"."+n),{index:n,containerIdx:i}},_fetchData:function(e){F.globalStart=F.serverStart=(new Date).getTime(),Q._buildView(),Q._startEdition(),_.getStructureWithStreaming({id:e,securityContext:C.getSecurityContext(),onComplete:function(t){function i(){t=UWA.is(t,"string")?JSON.parse(t):t,F.serverEnd=F.buildStart=(new Date).getTime(),Q._logger.log("Server response: "+(F.serverEnd-F.serverStart)/1e3),Q._richView(t),F.buildEnd=F.contentStart=(new Date).getTime(),Q._logger.log("Build view: "+(F.buildEnd-F.buildStart)/1e3),UWA.is(Q.navigation)||(Q.navigation=new d({mediator:Q.mediator,selector:Q.container+" .rich-container",preview:Q.container,context:Q.context}).inject(Q.container+" .navigation-panel .syc-panel-tab-contents")),Q.idcard.updateSelection()}!0===widget.getPreference("trm_richview_optimizedloading").value||"true"===widget.getPreference("trm_richview_optimizedloading").value?(i(),Q.mediator.publish("onScroll",{position:0})):(i(),function(){Q.utilities.loading(),t=0,_.getContentWithStreaming({id:e,onComplete:function(e){!0===widget.getPreference("trm_richview_optimizedloading").value||"true"===widget.getPreference("trm_richview_optimizedloading").value?window.requestAnimationFrame(function(){Q.processLoadedContentChunk(e)}):Q.processLoadedContentChunk(e),F.globalEnd=F.contentEnd=(new Date).getTime(),Q._logger.log("Content: "+(F.contentEnd-F.contentStart)/1e3),Q._logger.log("Time global: "+(F.globalEnd-F.globalStart)/1e3),Q.utilities.loading(!0),Q.mediator.publish("onNotification",{className:"success",message:j.RichView_Notif_StructureLoaded}),Q.mediator.publish("onScroll",{position:0});var t={paths:[[Q.options.data]],attributes:{}};t.attributes[Q.options.data]={tenant:C.getTenant()},Q._padCommandProxy.select(t),Q._reqCommandProxy.refreshRV()},onFailure:function(e,t){Q.mediator.publish("onNotification",{className:"error",message:j.RichView_Notif_FatalError})},onProgress:function(e){if(1==!widget.getPreference("trm_richview_optimizedloading").value||"true"===widget.getPreference("trm_richview_optimizedloading").value){var i=e.currentTarget;if(2!==i.readyState&&3!==i.readyState&&4!==i.readyState)return;if(3===i.readyState&&200!==i.status)return;if(void 0===n)var n=i.response.slice(t);else n+=i.response.slice(t);t=i.response.length,n=Q.processLoadedContentChunk(n)}}});var t}()),1==re&&(ae=!1,Q._onWidgetSearch())},onFailure:function(e,t){Q.mediator.publish("onNotification",{className:"error",message:j.RichView_Notif_FatalError})}})},processLoadedContentChunk:function(e){if(-1!==e.indexOf(Q._DELIMITER)){for(var t=e.split(Q._DELIMITER),i=0,n=0;n<t.length-1;n++){i+=t[n].length+1,F.before=(new Date).getTime();for(var o=JSON.parse(t[n]),r=0;r<o.length;r++){Q.options.model.getNodesByMatrixID(o[r].id).forEach(function(e){var t="",i=e.getRichViewElement();e.options.externalObject?(t="[ "+j.ExternalObject_DisplayContent+" ]",o[r].editable=!1,i.content[0].addEventListener("click",function(e){Q.getProxyContentData(this,e)})):t=Q.utilities.decodeHtml(o[r].content);var n=a(i.container).find("#"+i.id+"_content");n.length>0&&n.html()!==t&&i.update({content:t,editable:o[r].editable,isDocx:o[r].isDocx,underCA:o[r].underCA,changeid:o[r].changeid})})}F.after=(new Date).getTime(),Q._logger.log("One array content: "+(F.after-F.before)/1e3)}return e=e.slice(i)}},_scrollView:function(){if(Q.scroller)return!0;var e=!1,t={scroll:function(t,i,n,o){e||(e=!0,setTimeout(function(){Q._currentPosition=Math.abs(parseInt(a(Q.scroller.elements.yScrollbar).css("top"),10)),Q.mediator.publish("onScroll",{position:Q._currentPosition}),e=!1},100))}.bind(this)};Q.scroller=new l({element:UWA.Element.getElement.call(document,Q.container+" .richview-editor-content")}).inject(UWA.Element.getElement.call(document,Q.container+" .richview-editor-container"),"top"),Q.scroller.elements.content.addEvents(t)},_richView:function(e){({}),0,9999,B="",{},void 0,9999;var t=a(".scroller-content",this.contentPanel).length>0?a(".scroller-content",this.contentPanel):this.richViewEditorContent,i=[];(0===e.length||1===e.length&&!this._isRich(e[0]["type.kindof"]))&&(t.empty(),this._generateFakeContainer()),k.process.streaming({root_node:Q.options.model.getRoots()[0],data:e,tenant:C.getTenant()},this.externalTypes),Q.options.model.sortInTreeOrder(Q.options.model.getRoots());for(var n=Q.options.model.getRoots()[0].getAllDescendants(),o=Q.options.model.getRoots()[0],r=0;r<e.length;r++){var s,l=e[r];s=0==r?o:n[r-1],l.objectId=l.id,l.physicalId=l.physicalid,l.id=M(),l.content=Q.utilities.decodeHtml(void 0!==l.content?l.content:"Loading..."),l.title=Q.utilities.decodeHtml(l.title||l["attribute[Title]"]);var c=UWA.is(l.type,"object")?l.type.value:l.type,d=l["type.kindof"];this._isContainer(c)||this._isContainer(d)?i.push(this._richContainer(l,s)):(this._isRich(c)||this._isRich(d))&&i.push(this._richObject(l,s))}t.append(i),UWA.is(Q.eventInit)&&Q.eventInit?Q.options.model.getModelEvents().publish({event:"setPathTags",context:Q.options.model}):setTimeout(function(){Q.options.model.getModelEvents().publish({event:"setPathTags",context:Q.options.model})},1e3),m.unmask(UWA.Element.getElement.call(document,".main-panel"))},_generateFakeContainer:function(){var e=a(".scroller-content",this.contentPanel).length>0?a(".scroller-content",this.contentPanel):this.contentPanel;oe=!0,this.fakeContainer=new u({mediator:Q.mediator,id:M(),objectId:Q.options.data,physicalId:Q.options.data,type:Q.options.parentType,kindof:Q.options.parentType,title:j.RichView_Tooltip_NoObjects,index:"",connection:"",connectionId:"",level:1,editable:"false",droppable:{Chapter:"over",Comment:"over",Requirement:"over","text/plain":"before,after,over","text/html":"before,after,over","text/searchitems":"before,after,over",Text:"before,after,over"},context:Q.context,fake:!0}).create(),this.fakeContainer.container.addClass("fake-rich-container"),e.append(this.fakeContainer.container),this.fakeContainer.container.find(".rich-container-title-index").click()},_richContainer:function(e,t){Q=this;for(var i,n=1,o=t;UWA.is(o);){o=o.getPreviousBrother(),UWA.is(o)&&(n=Q.GetContainerLevel(o),(Q._isContainer(o.options.type)||Q._isContainer(o.options.kindof))&&(n+=1));break}for(var r=n,a=t;UWA.is(a)&&(a=a.getParent(),UWA.is(a));)if(Q._isContainer(a.options.type)||Q._isContainer(a.options.kindof)){r=""==r?a._options.level:a.getRichViewElement().index+"."+r;break}i=r,e.title=""!==e.title?e.title:e.name;var s=UWA.is(e.type,"object")?e.type.value:e.type,l=e["type.kindof"];return new u({model:Q.options.model,node:t,rootId:Q.rootId,mediator:Q.mediator,id:e.id,objectId:e.objectId,physicalId:e.physicalId,type:s,kindof:l,title:e.title,cestamp:e.cestamp,index:i,connection:e["type[connection]"],connectionId:e["physicalid[connection]"],parentId:e["from.physicalid[connection]"],level:e.level,droppable:void 0!==Q.options.droppable[s]?Q.options.droppable[s]:Q.options.droppable[l],context:Q.context}).create().container},_richObject:function(e,t){e.parentId=e["from.physicalid[connection]"];var i=Q._generateObjectIdx(t);e.title=""!==e.title?e.title:e.name;var n=UWA.is(e.type,"object")?e.type.value:e.type,o=e["type.kindof"];return new h({model:Q.options.model,node:t,rootId:Q.rootId,mediator:Q.mediator,id:e.id,objectId:e.objectId,physicalId:e.physicalId,type:n,kindof:o,title:e.title,index:i.index,containerIdx:i.containerIdx,content:e.content,connection:e["type[connection]"],connectionId:e["physicalid[connection]"],parentId:e.parentId,cestamp:e.cestamp,level:e.level,type_icon_url:e.type_icon_url,droppable:void 0!==Q.options.droppable[n]?Q.options.droppable[n]:Q.options.droppable[o],fetchContent:void 0!==e.fetchContent&&e.fetchContent,context:Q.context}).create().container},_selectionMgt:function(e,t){var i=Q.options.model.getSelectedNodes(),n=a(e).parents(t+":first");if(i&&i.length>0){var o=n.data("relid"),r=i[0].getRelationID(),s=Q.options.model.getNodesByRelId(o);o===r&&null!=o?1!=re?(s[0].select(),n.toggleClass("active",!0),Q.onInnerSelection(s[0])):(s[0].unselect(),n.toggleClass("active",!1),Q.mediator.publish("onUnselect:object",n),Q.onCleanSelection(!1)):(i[0].cleanupHighlightHeader(),n.hasClass("fake-rich-container")||(Q.contentPanel.find('[data-relid="'+r+'"]').toggleClass("active",!1),Q.options.model.unselectAll(),s[0].select(),Q.onInnerSelection(s[0])),n.toggleClass("active",!0))}else{o=n.data("relid");(s=Q.options.model.getNodesByRelId(o))[0].select(),n.toggleClass("active",!0),Q.onInnerSelection(s[0])}},_attachControls:function(){this.contentPanel.on("click",".rich-container-title-index,.rich-container-info",function(e){Q._selectionMgt(this,".rich-container")}),this.contentPanel.on("click",".rich-object-info,.rich-object-container-index,.rich-object-index",function(e){Q._selectionMgt(this,".rich-object")}),this.contentPanel.on("click",".collapsable-container",function(e){Q._logger.log("Click",e);var t=a(this).parents(".rich-container:first"),i=t.attr("id"),n=parseInt(t.data("level"));void 0===K[i]||!1===K[i]?(a(".fonticon",this).removeClass("fonticon-minus-squared").addClass("fonticon-plus-squared"),K[i]=!0):(a(".fonticon",this).removeClass("fonticon-plus-squared").addClass("fonticon-minus-squared"),K[i]=!1);for(var o=t.nextAll(),r=0;r<o.length;r++){var s=o.eq(r);if(s.hasClass("rich-object")&&parseInt(s.data("level"))>n)K[i]?s.addClass("collapsed-object"):s.removeClass("collapsed-object");else{if(!(s.hasClass("rich-container")&&parseInt(s.data("level"))>n))break;K[i]?s.addClass("collapsed-object"):s.removeClass("collapsed-object")}}})},_startEdition:function(){Q._objectRichEditor=new p({mediator:Q.mediator,selector:".rich-object",target:".content-data",commandProxy:Q._padCommandProxy,reqCommandProxy:Q._reqCommandProxy,richView:Q}),Q._containerRichEditor=new p({mediator:Q.mediator,selector:".rich-container",target:".rich-container-title-editable",commandProxy:Q._padCommandProxy,reqCommandProxy:Q._reqCommandProxy,richView:Q}),Q._objectTitleRichEditor=new p({mediator:Q.mediator,selector:".rich-object",target:".rich-object-title-editable",commandProxy:Q._padCommandProxy,reqCommandProxy:Q._reqCommandProxy,richView:Q}),Q._objectRichEditor.startEditionForAll(),Q._containerRichEditor.startEditionForAll(),Q._objectTitleRichEditor.startEditionForAll()},updateRichContent:function(e){Q._objectRichEditor.updateHtmlContent(e)},_navigationPanel:function(){var e=new c(.2,a(this.richView).width(),this.options.height,"left");e.contents.style.overflowY="hidden",e.createTab("navigationMaintab").setIconClassName("fonticon fonticon-list"),this.navigationPanel.append&&this.navigationPanel.append(e.container),e.container.addEventListener("syc-panel-resize",function(){Q._resizeContentPanel(),widget.setValue("trm_navigation_open",Q.navigationPanel.isVisible())}),this.navigationPanel=e,this._resizeContentPanel(),widget.getValue("trm_navigation_open")||widget.addPreference({name:"trm_navigation_open",type:"hidden",defaultValue:!1}),!0===widget.getValue("trm_navigation_open")&&!1===this.navigationPanel.isVisible()?(this.navigationPanel.open(),this._resizeContentPanel()):!1===widget.getValue("trm_navigation_open")&&!0===this.navigationPanel.isVisible()&&(this.navigationPanel.close(),this._resizeContentPanel())},_resizeContentPanel:function(){var e=this.contentPanel,t=this.navigationPanel;if(t&&t.isVisible){var i=!1===t.isVisible()?0:t.size;e.css("margin-left",i+H)}},_isContainer:function(e){return this.options.container.indexOf(e)>=0},_isRich:function(e){return this.options.rich.indexOf(e)>=0},_plainTextFromHtml:function(e){var t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText},setTraceabiltyScope:function(e,t){this._traceabilityScope.id=e,this._traceabilityScope.title=t},getTraceabilityScope:function(){return this._traceabilityScope},getRootId:function(){return Q.rootId},getSelectedElement:function(){return this.current_selection},getSelectedNodes:function(){return Q.options.model.getSelectedNodes()},getSecurityContext:function(){return{SecurityContext:C.getSecurityContext()}},getPADTreeDocument:function(){return Q.options.model},beginBlockingTransaction:function(e){UWA.is(Q.current_selection.element)&&m.mask(UWA.Element.getElement.call(Q.current_selection.element.parent()[0],"#"+Q.current_selection.element.attr("id")))},endBlockingTransaction:function(e){UWA.is(Q.current_selection.element)&&m.unmask(UWA.Element.getElement.call(Q.current_selection.element.parent()[0],"#"+Q.current_selection.element.attr("id")))},refreshOnCreate:function(e,t){var i=!1;if(UWA.is(e.type)&&UWA.is(e["type.kindof"])){var n=UWA.is(e.type,"object")?e.type.value:e.type,o=e["type.kindof"];-1==Q.options.root.indexOf(n)&&-1==Q.options.root.indexOf(o)||(i=!0)}if(!0===i){var r=e.physicalid;this.options.data=r,k.process.root({treedocument:Q.options.model,data:e,tenant:C.getTenant()},this.externalTypes),this._curentlyLoadingReqSpec=!1,UWA.is(this.dropinvit)&&a(".richview_main_container").size()>0?(this.dropinvit.remove(),this._init()):(Q.utilities.saveObject(r),Q._onWidgetRefresh()),!0===t&&Q._reqCommandProxy.drop({id:r,appId:widget.getValue("appId"),widgetId:widget.id,action:"new"})}else Q.displayNotification({eventID:"warning",msg:j.RichView_Notif_NotAuthorized})},refreshOnInsert:function(e,t,i){var n,o,r=this,a=r.getSelectedElement();o=a.element,a.position="over",a.content="",a.fetchContent=!0,a.target={element:o,id:UWA.is(o)?o.attr("id"):""},e.forEach(function(e){n=UWA.is(t)?t:r.authoring.placeholder(a),r.authoring._refreshOnInsert(e,n,null,!0,i)})},refreshOnRemove:function(e,t){var i=e.element,n=Q.options.model.getNodesByElementID(i.attr("id"))[0],o=n.getAllDescendants();if(UWA.is(o)&&o.length>0)for(var r=0;r<o.length;r++){var s=o[r];s.getRichViewElement().container.remove(),s.remove()}i.remove(),n.unselect(),n.remove();var l=e.path;Q.onCleanSelection(!1),Q.mediator.publish("onRefresh"),!0===t&&Q._reqCommandProxy.detach({appId:widget.getValue("appId"),path:l}),Q.options.model.getModelEvents().publish({event:"setPathTags",context:Q.options.model}),0===a(".rich-container,.rich-object:not(.placeholder)").length&&widget.dispatchEvent("onRefresh")},authoring:{insertWithPromise:function(e){var t,i=Q.authoring.placeholder(e);function n(){var e=Q._promisesData.shift();return Q.authoring.insert(e)}Q._promisesData.push(i),Q._promises.push(n),t=o.resolve(),Q._promises.forEach(function(e){t=t.then(n)})},placeholder:function(e){var t=M(),i=new h({id:t+"_placeholder",title:'<span class="fonticon fonticon-dot-3"></span>',content:e.content,droppable:void 0!==Q.options.droppable[e.type]?Q.options.droppable[e.type]:Q.options.droppable[e.kindof],placeholder:!0}).create();!0===oe&&(e.position="over");var n=void 0,o=void 0;if(UWA.is(e.target.element)){var r=Q.options.model.getNodesByElementID(e.target.element.attr("id"))[0];e.target.element;n=(n="over"!==e.position?r.getParent():r).getRichViewElement()}else n={type:Q.options.model.getRoots()[0].options.type,objectId:Q.options.model.getRoots()[0].getID(),kindof:Q.options.model.getRoots()[0].options.kindof};switch(UWA.is(n)||(n={type:Q.options.model.getRoots()[0].options.type,objectId:Q.options.model.getRoots()[0].getID(),kindof:Q.options.model.getRoots()[0].options.kindof}),e.relationship=Q.options.relationship[n.type]||Q.options.relationship[n.kindof],e.position){case"before":e.target.element.before(i.container);var s=Q.options.model.getNodesByElementID(e.target.element.attr("id"))[0];e.nextSibling={id:s.getID(),relId:s.getRelationID()};var l=s.getPreviousBrother();UWA.is(l)?e.previousSibling={id:l.getID(),relId:l.getRelationID()}:e.previousSibling={},o=s.getLevel();break;case"after":var c=(l=Q.options.model.getNodesByElementID(e.target.element.attr("id"))[0]).getAllDescendants(),d=l.getRichViewElement().container;if(UWA.is(c)&&c.length>0)d=c[c.length-1].getRichViewElement().container;d.after(i.container),e.previousSibling={id:l.getID(),relId:l.getRelationID()};s=l.getNextBrother();e.nextSibling={},UWA.is(s)&&(e.nextSibling={id:s.getID(),relId:s.getRelationID()}),o=l.getLevel();break;case"over":if(UWA.is(e.target.element)){var p=Q.options.model.getNodesByElementID(e.target.element.attr("id"))[0],u=p.getChildren(),g=e.target.element;if(UWA.is(u)&&u.length){g=(f=u[u.length-1]).getRichViewElement().container;var f;c=f.getAllDescendants();if(UWA.is(c)&&c.length>0)g=(f=c[c.length-1]).getRichViewElement().container}g.after(i.container),o=p.getLevel()+1,e.previousSibling={},e.nextSibling={},!0===oe&&(n={type:Q.options.model.getRoots()[0].options.type,objectId:Q.options.model.getRoots()[0].getID(),kindof:Q.options.model.getRoots()[0].options.kindof},o=1)}else{var v=a(".rich-container,.rich-object:not(.placeholder)");v.size()>0&&(e.target.element=v.eq(v.size()-1)),e.target.element.after(i.container),o=1}}return m.mask(UWA.Element.getElement.call(e.target.element.parent()[0],"#"+t+"_placeholder")),e.parent=n,e.newLevel=o,e.placeholder=i,e},insert:function(e){switch(e.operation){case"insertNew":var t=[];return e.hasOwnProperty("content")&&t.push({name:"Content Data",value:UWA.Utils.base64Encode(Q.utilities.jsonEscape(e.content))},{name:"Content Type",value:e.contentType},{name:"Content Text",value:UWA.Utils.base64Encode(Q._plainTextFromHtml(e.content))}),new o(function(i,n){Q.beginBlockingTransaction(j.composite),_.insertNew({securityContext:C.getSecurityContext(),type:e.type,json:{pid:e.parent.objectId,relationship:e.relationship,previousSibling:e.previousSibling,nextSibling:e.nextSibling,attributes:t},onComplete:function(t){var n=(UWA.is(t,"string")?JSON.parse(t):t).results;if(n.Success.length>0){var o=n.Success[0];o.objectId=o.id,o.physicalId=o.physicalid,o.id=M(),o.level=e.newLevel,o.content=e.content,o.fetchContent=!1,UWA.is(o["attribute[Title]"])?o.title=o["attribute[Title]"]:o.title="",Q.authoring._refreshOnInsert(o,e,e.placeholder,!0);var r=(UWA.is(o.type,"object")?o.type.displayName:o.type)+" "+o.name+" "+o.revision;a=(a=j.RichView_Notif_ObjectCreated).replace("{TNR}",r),Q.mediator.publish("onNotification",{className:"success",message:a})}if(n.Failure.length>0){e.placeholder.container.remove();var a=j.Requirement_Notif_ObjectCreationFailed+" "+j.FailureReasons;Q.mediator.publish("onNotification",{className:"error",message:a})}Q.endBlockingTransaction(),i("OK")},onFailure:function(t){Q.mediator.publish("onNotification",{className:"error",message:t.message}),e.placeholder.container.remove(),Q.endBlockingTransaction(),n()}})})}},_refreshOnRevise:function(e,t,i,n,o,r,s){UWA.is(e.level)||(e.level=t.newLevel);var l=null;null!=r&&null!=r&&(l=r.container[0]);var c=Q.options.model.getRoots(),d=k.process.createNode({data:e,tenant:C.getTenant()},Q.externalTypes);if(UWA.is(t.parent.id)&&""!==t.parent.id&&(c=Q.options.model.getNodesByElementID(t.parent.id)),UWA.is(s.getParent()))for(var p=s.getParent()._options.children.length-1;p>=0;p--)if(s.getParent()._options.children[p]._options.physicalID==s._options.physicalID){s.getParent()._options.children.splice(p,1);break}Q.mediator.publish("onRefresh"),c[0].addChild(d),Q.options.model.sortInTreeOrder(c),UWA.is(i)||(i=t.placeholder,t.position,e.objectId=e.id,e.physicalId=e.physicalid,e.id=M(),e.level=t.newLevel,e.content=t.content,UWA.is(o)&&"insertExisting"===o&&(t.fetchContent=!0),e.fetchContent=!!UWA.is(t.fetchContent)&&t.fetchContent,UWA.is(e["attribute[Title]"])?e.title=e["attribute[Title]"]:e.title="");var h=null,u=UWA.is(e.type,"object")?e.type.value:e.type,g=e["type.kindof"];if(Q._isContainer(u)||Q._isContainer(g)?(h=Q._richContainer(e,d),!0,!1):(Q._isRich(u)||Q._isRich(g))&&(d.options.externalObject&&(e.fetchContent=!1),h=Q._richObject(e,d),!1,!0),d.options.externalObject){var f=d.getRichViewElement();f.update({content:"[ "+j.ExternalObject_DisplayContent+" ]",editable:!1,isDocx:!0}),f.content[0].addEventListener("click",function(e){Q.getProxyContentData(this,e)})}i.container.after(h),i.container.remove(),!0===oe&&(Q.fakeContainer.container.remove(),!0,oe=!1),h.find(".rich-object-info").removeClass("highlight-operation").addClass("highlight-creation",1e3,"swing",function(){a(this).removeClass("highlight-creation",1e3,"swing")}),setTimeout(function(){d.options.externalObject&&d.getRichViewElement().info.click();Q.onInnerSelection(d,!0)},100),Q.mediator.publish("onRefresh"),Q.scroller.scrollToElement("#"+h.attr("id"),"center"),Q.mediator.publish("onScroll",{position:Q._currentPosition}),Q.options.model.getModelEvents().publish({event:"setPathTags",context:Q.options.model}),UWA.is(o)&&"insertExisting"===o&&!d.options.externalObject&&_.getStructureWithStreaming({id:e.physicalid,onComplete:function(t){var i=UWA.is(t,"string")?JSON.parse(t):t;k.process.streaming({root_node:d,data:i,tenant:C.getTenant()},Q.externalTypes);var n=d.getAllDescendants(),o=(UWA.is(e.type,"object")?e.type.value:e.type,d.getRichViewElement().container[0].parentNode);null===o&&(o=a(".scroller-content",Q.contentPanel).length>0?a(".scroller-content",Q.contentPanel):Q.contentPanel);d.getRichViewElementID(),d.getRichViewElement().container;for(var r=0;r<n.length;r++){for(var s=n[r],c=i[r],p=!1,h=s._options.name,u=0;u<i.length;u++)if(i[u].name==h){c=i[u],p=!0;break}if(!0===p){c.objectId=c.id,c.physicalId=c.physicalid,c.id=M(),c.content="Loading...",c.fetchContent=!0,c.title=Q.utilities.decodeHtml(c.title||c["attribute[Title]"]),c.level=parseInt(c.level)+parseInt(e.level);var g=UWA.is(c.type,"object")?c.type.value:c.type,f=null;Q._isContainer(g)||Q._isContainer(c["type.kindof"])?f=Q._richContainer(c,s):(Q._isRich(g)||Q._isRich(c["type.kindof"]))&&(f=Q._richObject(c,s)),null!=l?o.insertBefore(f[0],l):o.append(f[0])}}Q.mediator.publish("onRefresh"),Q.options.model.getModelEvents().publish({event:"setPathTags",context:Q.options.model})},onFailure:function(e,t){},onTimeout:function(){}}),Q.options.model.sortInTreeOrder(c)},_refreshOnInsert:function(e,t,i,n,o){UWA.is(e.level)||(e.level=t.newLevel);var r,s=Q.options.model.getRoots(),l=k.process.createNode({data:e,tenant:C.getTenant()},Q.externalTypes);UWA.is(t.parent.id)&&""!==t.parent.id&&(s=Q.options.model.getNodesByElementID(t.parent.id)),s[0].addChild(l),Q.options.model.sortInTreeOrder(s),r=t.position,UWA.is(i)||(i=t.placeholder,e.objectId=e.id,e.physicalId=e.physicalid,e.id=M(),e.level=t.newLevel,e.content=t.content,UWA.is(o)&&"insertExisting"===o&&(t.fetchContent=!0),e.fetchContent=!!UWA.is(t.fetchContent)&&t.fetchContent,UWA.is(e["attribute[Title]"])?e.title=e["attribute[Title]"]:e.title=""),UWA.is(t.path)||(t.target.element.hasClass("fake-rich-container")?t.path=[Q.rootId,e["physicalid[connection]"],e.physicalId]:t.path=s[0].getOccurencePath()),!1!==n&&Q._reqCommandProxy.attach({path:t.path,object:e,selection:Q.getSelectedNodes()[0].getOccurencePath(),mode:"after"===r?"append":"insert"});var c=null,d=!1,p=UWA.is(e.type,"object")?e.type.value:e.type,h=e["type.kindof"];if(Q._isContainer(p)||Q._isContainer(h)?(c=Q._richContainer(e,l),!0,d=!1):(Q._isRich(p)||Q._isRich(h))&&(l.options.externalObject&&(e.fetchContent=!1),c=Q._richObject(e,l),!1,d=!0),l.options.externalObject){var u=l.getRichViewElement();u.update({content:"[ "+j.ExternalObject_DisplayContent+" ]",editable:!1,isDocx:!0}),u.content[0].addEventListener("click",function(e){Q.getProxyContentData(this,e)})}i.container.after(c),i.container.remove(),!0===oe&&(Q.fakeContainer.container.remove(),!0,oe=!1),c.find(".rich-object-info").removeClass("highlight-operation").addClass("highlight-creation",1e3,"swing",function(){a(this).removeClass("highlight-creation",1e3,"swing")}),setTimeout(function(){l.options.externalObject?l.getRichViewElement().info.click():!0===d?c.find(".content-data").focus():c.find(".rich-container-title-editable").focus();Q.onInnerSelection(l,!0)},100),Q.mediator.publish("onRefresh",{level:parseInt(l.getRichViewElement().level)}),Q.scroller.scrollToElement("#"+c.attr("id"),"center"),Q.mediator.publish("onScroll",{position:Q._currentPosition}),Q.options.model.getModelEvents().publish({event:"setPathTags",context:Q.options.model}),UWA.is(o)&&"insertExisting"===o&&!l.options.externalObject&&_.getStructureWithStreaming({id:e.physicalid,onComplete:function(t){var i=UWA.is(t,"string")?JSON.parse(t):t;k.process.streaming({root_node:l,data:i,tenant:C.getTenant()},Q.externalTypes),Q.options.model.sortInTreeOrder(Q.options.model.getRoots());for(var n=l.getAllDescendants(),o=(a(".scroller-content",Q.contentPanel).length>0?a(".scroller-content",Q.contentPanel):Q.contentPanel,0);o<i.length;o++){var r=n[o],s=i[o],d=!1,p="";if(void 0!==r){p=r._options.name;for(var h=0;h<i.length;h++)if(i[h].name==p){s=i[h],d=!0;break}}if(!0===d){s.objectId=s.id,s.physicalId=s.physicalid,s.id=M(),s.content="Loading...",s.fetchContent=!0,s.title=Q.utilities.decodeHtml(s.title||s["attribute[Title]"]),s.level=parseInt(s.level)+parseInt(e.level);var u=UWA.is(s.type,"object")?s.type.value:s.type;Q._isContainer(u)||Q._isContainer(s["type.kindof"])?c.append(Q._richContainer(s,r)):(Q._isRich(u)||Q._isRich(s["type.kindof"]))&&c.append(Q._richObject(s,r))}}Q.mediator.publish("onRefresh"),Q.scroller.scrollToElement("#"+c.attr("id"),"center"),Q.mediator.publish("onScroll",{position:Q._currentPosition}),Q.options.model.getModelEvents().publish({event:"setPathTags",context:Q.options.model})},onFailure:function(e,t){},onTimeout:function(){}})},reorder:function(e){Q.utilities.loading();e.source.element,e.target.element;var t=e.source.id,i=(e.target.id,e.source.element.prev()),n=Q.options.model.getNodesByElementID(e.source.id)[0],o=n.getAllDescendants(),r=new Array;r.push(n.getRichViewElement().container);for(var s=0;s<o.length;s++){var l=o[s];r.push(l.getRichViewElement().container),l.getRichViewElement().container}var c=Q.options.model.getNodesByElementID(e.target.id)[0];if(c.getOccurencePath().indexOf(n.getOccurencePath()[n.getOccurencePath().length-1])>-1)return Q.displayNotification({eventID:"error",msg:j.RichView_Notif_FailureAndRollback}),void Q.utilities.loading(!0);var d=void 0;d="over"===e.position?c:c.getParent();var p={},h=void 0,u={},g=void 0;switch("after"===e.position?(p={id:(h=c).getID(),relid:h.getRelationID()},g=c.getNextBrother(),UWA.is(g)&&(u={id:g.getID(),relid:g.getRelationID()})):"before"===e.position&&(u={id:(g=c).getID(),relid:g.getRelationID()},h=c.getPreviousBrother(),UWA.is(h)&&(p={id:h.getID(),relid:h.getRelationID()})),e.position){case"before":e.target.element.before(r);break;case"after":var f=c.getChildren();if(UWA.is(f)&&f.length>0){var v=f[f.length-1],b=v.getAllDescendants();if(b.length>0)v=b[b.length-1];v.getRichViewElement().container.after(r)}else c.getRichViewElement().container.after(r);break;case"over":var y=d.getChildren();if(UWA.is(d.getChildren())&&y.length>0){var x=y[y.length-1],w=x.getAllDescendants();if(w.length>0)x=w[w.length-1];x.getRichViewElement().container.after(r)}else d.getRichViewElement().container.after(r)}Q.scroller.scrollToElement("#"+t,"center"),_.reorder({securityContext:C.getSecurityContext(),json:{dataArray:[{objectId:n.getID(),position:{previousSiblingRelId:p.relid,nextSiblingRelId:u.relid},oldParentId:n.getParent().getID(),oldRelId:n.getRelationID(),newParentId:d.getID(),mode:"MOVE"}]},onComplete:function(e){var t=(UWA.is(e,"string")?JSON.parse(e):e).results.Success[0],i=n.getParent().getOccurencePath(),s=d.getOccurencePath();Q._reqCommandProxy.reorder({appId:widget.getValue("appId"),id:n.getID(),old_position:{id:n.getParent().getID(),relid:n.getRelationID(),path:i},new_position:{id:t["from.physicalid[connection]"],relid:t["physicalid[connection]"],reltype:t["type[connection]"],path:s,treeOrder:t["attribute[TreeOrder]"]}}),n.getParent().getID()===d.getID()?(n.setRelationOrder(parseFloat(t["attribute[TreeOrder]"])),Q.options.model.sortInTreeOrder([d])):Q.options.model.reparentNode(n,n.getParent(),d,parseFloat(t["attribute[TreeOrder]"]),t["physicalid[connection]"],t["type[connection]"]);var l=n.getRichViewElement();l.update({connectionId:n.getRelationID(),connection:n.getRelationType(),parentId:n.getParentID(),level:n.getLevel()});for(var c=0;c<o.length;c++){o[c].getRichViewElement().update({level:o[c].getLevel()})}for(var p=0;p<r.length;p++){var h=r[p];h.find(".rich-object-info").removeClass("highlight-operation").addClass("highlight-creation",1e3,"swing",function(){a(this).removeClass("highlight-creation",1e3,"swing")}),m.unmask(UWA.Element.getElement.call(h.parent()[0],"#"+h.attr("id")))}Q.mediator.publish("onRefresh"),Q.utilities.loading(!0);var u=".rich-object";l.container.hasClass("rich-container")&&(u=".rich-container"),Q._selectionMgt(l.header,u),Q.displayNotification({eventID:"success",msg:j.RichView_Notif_OperationSucceeded})},onFailure:function(e){Q.scroller.scrollToElement("#"+i.attr("id"),"center");for(var t=0;t<r.length;t++)r[t].detach();i.after(r);for(t=0;t<r.length;t++){var n=r[t];n.find(".rich-object-info").removeClass("highlight-operation").addClass("highlight-fail",1e3,"swing",function(){a(this).removeClass("highlight-fail",1e3,"swing")}),m.unmask(UWA.Element.getElement.call(n.parent()[0],"#"+n.attr("id")))}Q.mediator.publish("onRefresh"),Q.utilities.loading(!0),Q.displayNotification({eventID:"error",msg:j.RichView_Notif_FailureAndRollback})},onTimeout:function(){Q.scroller.scrollToElement("#"+i.attr("id"),"center");for(var e=0;e<r.length;e++)r[e].detach();i.after(r);for(e=0;e<r.length;e++){var t=r[e];t.find(".rich-object-info").removeClass("highlight-operation").addClass("highlight-fail",1e3,"swing",function(){a(this).removeClass("highlight-fail",1e3,"swing")}),m.unmask(UWA.Element.getElement.call(t.parent()[0],"#"+t.attr("id")))}Q.mediator.publish("onRefresh"),Q.utilities.loading(!0),Q.mediator.publish("onNotification",{className:"error",message:j.RichView_Notif_FailureAndRollback})}})}},shortcuts:null,utilities:{useCompassContent:function(){var e=void 0!==widget.getValue("X3DContentId")?JSON.parse(widget.getValue("X3DContentId")):null;if(null!==e){var t=e.data;if(null!==t){if(t.items.length>0){var i=t.items[0].objectId;if(UWA.is(i))return Q._logger.log("3DCompass content has been detected: ",i),i}}}},reloadSaveObject:function(){if(widget.getValue("custo_root_pid")){var e=widget.getValue("custo_root_pid");if(UWA.is(e))return Q._logger.log("Saved Object has been detected: ",e),e}else widget.addPreference({name:"custo_root_pid",type:"hidden",defaultValue:""})},saveObject:function(e){Q._logger.log("Save Object to widget preferences: ",e),widget.getValue("custo_root_pid")||widget.addPreference({name:"custo_root_pid",type:"hidden",defaultValue:""}),widget.setValue("custo_root_pid",e)},cleanObject:function(){Q._logger.log("Clean Object Preferences"),widget.setValue("custo_root_pid",""),Q.options.data=null},cleanWidgetTitle:function(){widget.setTitle("")},jsonEscape:function(e){return e.replace(/\n/g,"")},encodeHtml:function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return String(e).replace(/[&<>"'\/]/g,function(e){return t[e]})},decodeHtml:function(e){if(!UWA.is(e))return"";e=a("<textarea />").html(e).text();var t,i,n=new DOMParser,o=void 0;try{o=n.parseFromString(text,"application/xml")}catch(e){}return!UWA.is(o)||!UWA.is(o.querySelector("body"))||(t=o,"http://www.w3.org/1999/xhtml"===(i=(new DOMParser).parseFromString("<","text/xml").getElementsByTagName("parsererror")[0].namespaceURI)?t.getElementsByTagName("parsererror").length>0:t.getElementsByTagNameNS(i,"parsererror").length>0)||(e=o.querySelector("body").innerHTML),e},loading:function(e){for(var t=J.getMessages(),i=null,n=0;n<t.length;n++){if(t[n].getElement(".wux-controls-progressbar-linear-lite")){i=t[n];break}}if(e&&i)return J.options.autoHide=!0,void J.remove(i);e?J.options.autoHide=!0:i?J.remove(i):(J.options.autoHide=!1,Q.mediator.publish("onNotification",{className:"primary",message:""}),new b({shape:"linear",displayStyle:"lite",infiniteFlag:!0,statusFlag:!1,emphasize:"info"}).inject(J.elements.container.getElement(".alert-message.alert-primary")))},onEndEdit:function(){var e=self.widget.getPreferences();e.forEach(function(e){switch(e.name){case"req_tenant":Q.utilities.updateTenantIndex(e.value),Q._reqCommandProxy.tenantChange({appId:widget.getValue("appId")});break;case"trm_security_ctx":C.setXPrefCredentials(widget,e.value)}}),Q._reqCommandProxy.preferenceModification({preferences:e,appId:widget.getValue("appId"),widgetId:widget.id}),Q._objectRichEditor.updateCKEditorSpellCheckSetting()},updatePreferences:function(e){if(UWA.is(e)&&UWA.is(e.appId)&&e.appId!==widget.getValue("appId")){var t=e.preferences;UWA.is(t)&&t.length>0&&t.forEach(function(e){widget.hasPreference(e.name)?(widget.setValue(e.name,e.value),Q._logger.log("update "+e.name+" preference")):"x3dPlatformId"===e.name?(widget.setValue("req_tenant",e.value),Q._logger.log("update req_tenant preference")):"pad_security_ctx"===e.name&&(widget.setValue("trm_security_ctx",e.value),Q._logger.log("update trm_security_ctx preference")),"trm_security_ctx"===e.name&&C.setXPrefCredentials(widget,e.value)})}},updateTenantIndex:function(e){C.setTenantIndex(e)},setWidgetTitle:function(){_.getInfo({securityContext:C.getSecurityContext(),pid:Q.options.data,selectables:"type,name,revision,attribute[Title],type.kindof,current,cestamp,physicalid",onComplete:function(e){var t=(e=UWA.is(e,"string")?JSON.parse(e):e).results[0],i="";UWA.is(t["attribute[Title]"])&&""!==t["attribute[Title]"]?i+=" "+t["attribute[Title]"]:i+=" "+t.name,self.widget.setTitle(i),Q.options.parentType=UWA.is(t.type,"object")?t.type.value:t.type,Q.options.parentName=t.name,Q.options.parentTitle=t["attribute[Title]"],Q.options.parentKindof=t["type.kindof"],Q.idcard.updateThumbnail(t["type.kindof"],t["attribute[Title]"]),Q.idcard.updateLifecyle(t.current.displayName),Q.options.model.getRoots()[0].options.title=t["attribute[Title]"];for(var n=Q.options.model.getNodesById(t.physicalid),o=0;o<n.length;o++){var r=n[o];r.options.title=""!==t["attribute[Title]"]?t["attribute[Title]"]:t.name,null!=r.options.elementRV&&(r.options.elementRV.cestamp=t.cestamp);var a=r.getRichViewElement();UWA.is(a)&&a.update({title:""!==t["attribute[Title]"]?t["attribute[Title]"]:t.name,cestamp:t.cestamp})}},onFailure:function(e){}})},refreshAuthoredObject:function(e){if(UWA.is(e.authored)&&UWA.is(e.authored.modified)&&0!==e.authored.modified.length){var t=e.authored.modified;"object"==typeof t&&UWA.is(t.physicalid)&&(t=t.physicalid),t&&t[0]===Q.options.model.getRoots()[0].getID()?Q.utilities.setWidgetTitle():_.getInfo({securityContext:C.getSecurityContext(),pid:t,selectables:"id,physicalid,type,name,revision,attribute[Title],type.kindof,cestamp",onComplete:function(e){(e=UWA.is(e,"string")?JSON.parse(e):e).results.forEach(function(e){for(var t=Q.options.model.getNodesById(e.physicalid),i=0;i<t.length;i++){var n=t[i];n.options.title=""!==e["attribute[Title]"]?e["attribute[Title]"]:e.name,null!=n.options.elementRV&&(n.options.elementRV.cestamp=e.cestamp);var o=n.getRichViewElement();UWA.is(o)&&o.update({title:""!==e["attribute[Title]"]?e["attribute[Title]"]:e.name,cestamp:e.cestamp})}}),Q.idcard.updateSelection()}})}else if(UWA.is(e.authored)&&UWA.is(e.authored.deleted))for(var i=e.authored.deleted[0],n=Q.options.model.getNodesById(i),o=0;o<n.length;o++){var r=n[0];if("Requirement Specification"===r.options.kindof)Q.cleanAll();else{e={path:r.getOccurencePath(),appId:"notRichview"};Q.utilities.detachObject(e)}}},findAndScrollToObject:function(e){var t=Q.utilities.findObjectElement(e);UWA.is(t)&&UWA.is(t.id)&&UWA.is(t.element)&&(Q.scroller.scrollToElement("#"+t.id,"top"),!0!==a(t.element).hasClass("active")&&a(t.element).find(".rich-container-title-index,.rich-object-info").click())},isSamePath:function(e,t){if(e.length!==t.length)return!1;for(var i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0},findObjectElement:function(e){var t=e.id,i=e.relid,n=e.path,o=null,r=null,a=Q.options.model.getNodesById(t);if(a.length>0){o=a[0].getRichViewElementID(),r=a[0].getRichViewElement().container;for(var s=0;s<a.length;s++){var l=a[s];if(UWA.is(n)){var c=l.getOccurencePath(),d=n;if(d.length>c.length){var p=d.length-c.length;d=d.slice(p,d.length-1)}Q.utilities.isSamePath(d,c)&&(o=l.getRichViewElementID(),r=l.getRichViewElement().container)}else{i===l.getRelationID()&&(o=l.getRichViewElementID(),r=l.getRichViewElement().container)}}}return{id:o,element:r}},syncViewOnExternalSelection:function(e){if(UWA.is(e.protocol)&&"3DXContent"===e.protocol){var t=JSON.parse(widget.getValue("subscribeToTRASelect")),i=le.authorised_apps;if(JSON.stringify(i).includes(e.source)&&t){var n=e.data.items;if(UWA.is(n)&&n.length>0){var o=n[0].objectId;Q.utilities.findAndScrollToObject({id:o})}}}else if(UWA.is(e.paths)&&e.paths.length>0){var r=e.paths[0];o=r[r.length-1];Q.utilities.findAndScrollToObject({id:o})}},syncViewOnInternalSelection:function(e){if(UWA.is(e.appId)&&e.appId!==widget.getValue("appId")&&UWA.is(e.paths)){var t=e.paths[0],i=t[t.length-1],n=Q.options.model.getRoots().length>0?Q.options.model.getRoots()[0].getID():"";if(i!==n){var o=t[t.length-2];_.getKindOf({securityContext:C.getSecurityContext(),pid:i,onComplete:function(e){var n=(UWA.is(e,"string")?JSON.parse(e):e).results;n===Q.options.root||"DOCUMENTS"===n?(a(".richview_main_container").size()>0&&Q.dropinvit.remove(),Q.utilities.saveObject(i),Q._onWidgetRefresh()):null==o&&Q.options.root.indexOf(n)>-1&&Q.getRootId()!=i?(Q.utilities.saveObject(i),Q._onWidgetRefresh()):"Requirement"==Q.options.parentKindof&&Q.utilities.findAndScrollToObject({id:i,relid:o,path:t})},onFailure:function(e){Q._logger.log(e)}})}else{if(Q.options.model.getSelectedNodes()[0].getID()!==i)a(".content-panel").find(".rich-object.active,.rich-container.active").toggleClass("active",!1),Q.options.model.unselectAll(),Q.onCleanSelection(!1);else if("Requirement"==Q.options.parentKindof){o=t[t.length-2];Q.utilities.findAndScrollToObject({id:i,relid:o,path:t})}}}},loadSpec:function(e){if(UWA.is(e)&&UWA.is(e.appId)&&e.appId!==widget.getValue("appId")){if(UWA.is(e.paths))var t=e.paths[0];else t=e.data.object.physicalid;t!==Q.rootId?_.getInfo({securityContext:C.getSecurityContext(),pid:t,selectables:"type,name,revision,type.kindof,attribute[Title],physicalid,id",onComplete:function(e){var t=(UWA.is(e,"string")?JSON.parse(e):e).results[0],i=UWA.is(t.type,"object")?t.type.value:t.type,n=t["type.kindof"];Q._curentlyLoadingReqSpec=!1,-1!=Q.options.root.indexOf(i)||-1!=Q.options.root.indexOf(n)?Q.refreshOnCreate(t,!1):Q._logger.log("The dropped object is not a "+Q.options.root)},onFailure:function(e){Q._logger.log(e)},onTimeout:function(){Q._logger.log("RequirementWebServices.getInfo timed out")}}):Q._curentlyLoadingReqSpec=!1}},attachObject:function(e){Q._logger.log("attachObject");var t=function(e,t,i,n){if(Q.options.model.getRoots().length>0)if(e===Q.options.model.getRoots()[0].getID()){var o=Q.authoring.placeholder({physicalid:s,type:Q.options.model.getRoots()[0].options.type,kindof:Q.options.model.getRoots()[0].options.kindof,target:{element:null,id:""},position:t,content:""});Q.authoring._refreshOnInsert(r,o,null,!1,n)}else{var a=Q.options.model.getNodesById(e);if(a.length>0){var l;i.slice(0,i.length-3);l="over"===t?i[i.length-4]:i[i.length-2];for(var c=null,d=null,p=null,h=0;h<a.length;h++){a[h].getOccurencePath();if(a[h].getRelationID()===l){c=a[h].getRichViewElement(),d=a[h].getRichViewElementID(),p=c.container;break}}if(UWA.is(d)){o=Q.authoring.placeholder({physicalid:s,target:{element:p,id:d},position:t,content:"",type:c.type,objectId:c.physicalId,kindof:c.kindof});Q.authoring._refreshOnInsert(r,o,null,!1,n)}}}};if(UWA.is(e)&&UWA.is(e.appId)&&e.appId!==widget.getValue("appId")){var i=e.eventData;Array.isArray(e.eventData)||(i=[e]);var n,o="",r=void 0,a=void 0,s="";i.forEach(function(i){switch(o=i.mode,r=i.object,a=i.path,s=a[a.length-1],o){case"insert":n=a[a.length-3],t(n,"over",a);break;case"insertExisting":n=a[a.length-3],t(n,"over",a,o);break;case"append":n=e.selection[e.selection.length-1],t(n,"after",e.selection);break;case"prepend":n=e.selection[e.selection.length-1],t(n,"before",e.selection);break;case"appendExisting":n=e.selection[e.selection.length-1],t(n,"after",e.selection,"insertExisting");break;case"prependExisting":n=e.selection[e.selection.length-1],t(n,"before",e.selection,"insertExisting")}})}},detachObject:function(e){if(Q._logger.log("detachObject"),UWA.is(e)&&UWA.is(e.appId)&&e.appId!==widget.getValue("appId")){var t=e.path,i=t[t.length-1],n=t[t.length-2],o=Q.utilities.findObjectElement({id:i,relid:n,path:t});if(UWA.is(o.element)){var r={element:o.element,path:t};Q.refreshOnRemove(r,!1)}}},reorderObject:function(e){if(Q._logger.log("reorderObject"),UWA.is(e)&&UWA.is(e.appId)&&e.appId!==widget.getValue("appId")){var t=e.old_position,i=e.new_position,n=(e.id,t.id,t.relid,t.path),o=(i.id,i.relid),r=i.relType,s=i.path,l=i.treeOrder,c=Q.options.model.getNodesByRelId(o);if(0===c.length)return;c=c[0];var d,p=Q.options.model.getNodeByOccurencePath(n),h=Q.options.model.getNodeByOccurencePath(s);if(!UWA.is(p))if(-1!=(d=n.indexOf(Q.rootId))){var u=n.slice(d);p=Q.options.model.getNodeByOccurencePath(u)}if(!UWA.is(h))if(-1!=(d=s.indexOf(Q.rootId))){u=s.slice(d);h=Q.options.model.getNodeByOccurencePath(u)}if(!UWA.is(p)||!UWA.is(h))return;var g=c.getRichViewElement(),f=c.getAllDescendants();p.getID()===h.getID()?(c.setRelationOrder(parseFloat(l)),Q.options.model.sortInTreeOrder([h])):Q.options.model.reparentNode(c,p,h,parseFloat(l),o,r);var m=new Array;if(m.push(c.getRichViewElement().container),UWA.is(f)&&f.length>0)for(var v=0;v<f.length;v++){var b=f[v];m.push(b.getRichViewElement().container)}var _=c.getNextBrother(),y=c.getPreviousBrother();if(UWA.is(_))_.getRichViewElement().container.before(m);else if(UWA.is(y)){var C=y.getAllDescendants(),x=y.getRichViewElement().container;if(UWA.is(C)&&C.length>0)x=C[C.length-1].getRichViewElement().container;x.after(m)}else{if(!0===c.getParent().isRoot())(a(".scroller-content",Q.contentPanel).length>0?a(".scroller-content",Q.contentPanel):Q.contentPanel).find(".rich-object, .rich-container").last().after(m);else c.getParent().getRichViewElement().container.after(m)}g.update({connectionId:c.getRelationID(),connection:c.getRelationType(),parentId:c.getParentID(),level:c.getLevel()});for(var w=0;w<f.length;w++){f[w].getRichViewElement().update({level:f[w].getLevel()})}Q.mediator.publish("onRefresh"),Q.scroller.scrollToElement("#"+c.getRichViewElementID(),"center");var I=".rich-object";g.container.hasClass("rich-container")&&(I=".rich-container"),Q._selectionMgt(g.header,I)}},reviseObject:function(e){if("DOCUMENTS"===e.data.object["type.kindof"])Q.utilities.loadSpec(e),console.log("Reqspec has been selected");else{var t=Q.options.model.getNodesByRelId(e.data.old_rel_id)[0],i=function(e,i,o,a){var l;if(l=Q.GetNextBrotherRichViewElem(n,t),Q.options.model.getRoots().length>0)if(e===Q.options.model.getRoots()[0].getID()){var c=Q.authoring.placeholder({physicalid:s,type:Q.options.model.getRoots()[0].options.type,kindof:Q.options.model.getRoots()[0].options.kindof,target:{element:null,id:""},position:i,content:""});Q.authoring._refreshOnRevise(r,c,null,!1,a,l,t)}else{var d=Q.options.model.getNodesById(e);if(d.length>0){var p;o.slice(0,o.length-3);p="over"===i?o[o.length-4]:o[o.length-2];for(var h=null,u=null,g=null,f=0;f<d.length;f++){d[f].getOccurencePath();if(d[f].getRelationID()===p){h=d[f].getRichViewElement(),u=d[f].getRichViewElementID(),g=h.container;break}}if(UWA.is(u)){c=Q.authoring.placeholder({physicalid:s,target:{element:g,id:u},position:i,content:"",type:h.type,objectId:h.physicalId,kindof:h.kindof});Q.authoring._refreshOnRevise(r,c,null,!1,a,l,t)}}}},n=t.getNextBrother(),o=t.getPreviousBrother(),r=e.data.object,a=e.newPath,s=e.newPath[e.newPath.length-1];UWA.is(n)?("before",i(n.getOccurencePath()[n.getOccurencePath().length-1],"before",n.getOccurencePath(),"insertExisting")):UWA.is(o)?("after",i(o.getOccurencePath()[o.getOccurencePath().length-1],"after",o.getOccurencePath(),"insertExisting")):i(a[a.length-3],"over",a,"insertExisting");var l=t.getAllDescendants();if(UWA.is(l)&&l.length>0)for(var c=0;c<l.length;c++){var d=l[c];d.getRichViewElement().container.remove(),d.remove()}t.getRichViewElement().container.remove(),t.remove(),Q.utilities.detachObject(e),Q.mediator.publish("onRefresh")}},focusChange:function(e){null!==this._pagerview&&("previous"==e.event&&(this._selectedIdx--,this.reframeOn()),"next"==e.event&&(this._selectedIdx++,this.reframeOn()))},closeTRMSearchNav:function(){this._selectedIdx=0,this._matchedNodes=[],this._pagerview&&this._pagerview.hide()},reframeOn:function(){-1===this._selectedIdx&&(this._selectedIdx=this._matchedNodes.length-1);var e=this._selectedIdx%this._matchedNodes.length,t=(this._matchedNodes.length+this._selectedIdx-1)%this._matchedNodes.length;if(this._pagerview){var i=e+1+"/"+this._matchedNodes.length;this._pagerview.setLabel(i)}var n=Q.options.model.getNodesByRelId(this._matchedNodes[e]),o=Q.options.model.getNodesByRelId(this._matchedNodes[t]);if(n.length){o&&o.length>0&&e!=t&&o[0].cleanupHighlightHeader(),n[0].highlightHeader();var r=".rich-object";n[0].getRichViewElement().container.hasClass("rich-container")&&(r=".rich-container"),Q._selectionMgt(n[0].getRichViewElement().header,r),Q.utilities.findAndScrollToObject({id:this._matchedNodes[e]})}},displayTRMSearchNav:function(e){var t=this;t._selectedIdx=0,t._matchedNodes=e,t._pagerview||(t._pagerview=new A({renderTo:document.body}),t._pagerview.subscribe({event:"previous"},function(){t.focusChange({event:"previous"})}),t._pagerview.subscribe({event:"next"},function(){t.focusChange({event:"next"})}),t._pagerview.subscribe({event:"close"},function(){t._selectedIdx=0,t._matchedNodes=[],t._pagerview.hide()})),t._pagerview.show()}},getRichObject:function(e){var t=Q.options.model.getNodesByElementID(e);return t.length>0&&UWA.is(t[0].getRichViewElement)?t[0].getRichViewElement():void 0},GetParentContainer:function(e){for(var t=e,i=null;UWA.is(t)&&(t=t.getParent(),UWA.is(t));)if(Q._isContainer(t.options.type)||Q._isContainer(t.options.kindof)){i=t;break}return i},GetContainerLevel:function(e){for(var t=1,i=e;UWA.is(i)&&(i=i.getPreviousBrother(),UWA.is(i));)(Q._isContainer(i.options.type)||Q._isContainer(i.options.kindof))&&(t+=1);return t},GetRichObjectLevel:function(e){for(var t=1,i=e;UWA.is(i)&&(i=i.getPreviousBrother(),UWA.is(i));)(Q._isRich(e._options.kindof)||Q._isRich(e._options.type))&&(t+=1);return t},GetNextBrotherRichViewElem:function(e,t){for(var i=null,n=e,o=t;null==i||null==i;){if(UWA.is(n))i=n.getRichViewElement();else{if(o=o.getParent(),!UWA.is(o))break;n=o.getNextBrother()}if(!UWA.is(o))break}return i},getEditMode:function(){return!0},_checkIfChangeControlEnabled:function(e){var t=!1;_.getTRMExpressionValue({expression:"TRM_AuthoringContext_Enabled",securityContext:C.getSecurityContext(),onComplete:function(i){var n=JSON.parse(i).results.value;UWA.is(n,"boolean")?t=n:UWA.is(n,"string")&&"true"===n&&(t=!0),e(t)},onFailure:function(i){console.error("Could not get change control enabled state: "+i),console.warn("--\x3e Change Control deactivated"),e(t)},onTimeout:function(){console.error("Could not get change control enabled state: "+error),console.warn("--\x3e Change Control deactivated"),e(t)}})}});return ce});