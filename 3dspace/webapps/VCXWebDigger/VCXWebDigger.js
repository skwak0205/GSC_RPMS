define("DS/VCXWebDigger/VCXDiggerModifiableView",["DS/VCXWebDressup/VCXDressupModifiableView","i18n!DS/VCXWebDigger/assets/nls/VCXWebDigger"],function(e,t){"use strict";var i=e.extend({init:function(){this._parent()},getPropertyGroupsi18n:function(){return t},getGroupPropertiesOrders:function(){var e=this._parent()||{};return UWA.extend(e,{"Group.Position":["Digger.Position","Digger.Radius"],"Group.Settings":["Digger.Mode","Digger.ZoomFactor","Digger.DepthFactor","Digger.DepthZoom","Digger.TorchFilter","Digger.Attach"]}),e}});return i.prototype._getGroupsPriorities=function(){var t=e.prototype._getGroupsPriorities();return UWA.extend(t,{"Group.Essentials":0,"Group.Position":10,"Group.Settings":20}),t},i}),define("DS/VCXWebDigger/VCXVisibilityDigger",["DS/VCXWebDressup/VCXVisibilityDressup"],function(e){"use strict";return e.extend({init:function(){},GetType:function(){return"VCXVisibilityDigger"},SetVisibility:function(e){this._parent(e);var t=this.QueryInterface("W3AISGNodeHolder");if(t){var i=t.getSGNode();if(i){var r=this.GetVisibility();i.setVisibility(r)}}}})}),define("DS/VCXWebDigger/VCXDiggerUI",["DS/Core/Core","UWA/Class"],function(e,t){"use strict";return t.extend({init:function(e){this.diggerComponent=null},dispose:function(){},drawImage:function(e,t,i,r,n){e.save(),e.beginPath();var o=r.getPixelWidth()/2;e.arc(t,i,o,0,2*Math.PI,!1),e.clip();var a=r.toCanvas();e.globalAlpha=n,e.drawImage(a,t-o,i-o,2*o,2*o),e.globalAlpha=1,e.restore()},drawBorder:function(e,t,i,r,n){e.beginPath(),e.arc(t,i,r,0,2*Math.PI,!1),e.fillStyle=this.diggerComponent.borderColor.GetStyle(),e.globalAlpha=n*this.diggerComponent.borderColor.a,e.fill(),e.lineWidth=this.diggerComponent.borderLineOuter,e.strokeStyle="black",e.globalAlpha=n*this.diggerComponent.borderLineOuterColor.a,e.stroke(),e.globalAlpha=1},drawInnerBorder:function(e,t,i,r,n){e.beginPath(),e.arc(t,i,r+1,0,2*Math.PI,!1),e.lineWidth=this.diggerComponent.borderLineInner,e.strokeStyle="black",e.globalAlpha=n*this.diggerComponent.borderLineInnerColor.a,e.stroke(),e.globalAlpha=1},drawAttach:function(e,t,i,r){e.lineWidth=1,e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(i.p1.x,i.p1.y),e.lineTo(i.p2.x,i.p2.y),e.lineTo(t.x,t.y),e.fillStyle="white",e.globalAlpha=r,e.fill(),e.strokeStyle="black",e.globalAlpha=r*this.diggerComponent.borderLineOuterColor.a,e.stroke(),e.globalAlpha=1}})}),define("DS/VCXWebDigger/VCXDigger_Spec",["DS/VCXWebDressup/VCXDressup_Spec","DS/VCXWebProperties/VCXColor"],function(e,t){"use strict";var i=e.extend({init:function(){this._parent(),this.IsAnchorDependent=!0,this.IsDressupPropertiesChangeIndependent=!0,this.IsViewPointDependent=!0,this._tooltip="",this._dirtyPickability=!1,this._DiggerDirtyMask=0,this.borderThickness=8,this.borderLineOuter=1,this.borderLineInner=1,this.borderColor=(new t).FromRGBA(1,1,1,.5),this.borderLineOuterColor=(new t).FromRGBA(0,0,0,.6),this.borderLineInnerColor=(new t).FromRGBA(0,0,0,.3)},isDirty:function(){return this._dirty||this._dirtyPickability}});return i.EMode={Zoom:0,Onion:1,XRay:2,Detail:3},i.FDirty={Position:1,Radius:2,AnchorPosition:4,ViewpointMoved:8,Buttons:16},i.prototype.getDefaultName=function(){return"Digger"},Object.defineProperty(i.prototype,"componentType",{enumerable:!0,get:function(){return"VCXDigger_Spec"}}),i.prototype.dressupGroupName="Diggers",i}),define("DS/VCXWebDigger/VCXWebDiggerDictionary",[],function(){"use strict";var e={VCXDigger_Spec:{VCXIModifiable:"DS/VCXWebDigger/VCXDiggerModifiable",VCXIModifiableView:"DS/VCXWebDigger/VCXDiggerModifiableView",VCXIVisibility:"DS/VCXWebDigger/VCXVisibilityDigger",W3AISGNodeHolder:"DS/VCXWebDigger/VCXDiggerSGNodeHolder",VCXISensible:"DS/VCXWebComposer/VCXASensible",VCXITreeNode:"DS/VCXWebTreeExtensions/VCXTreeNodeDigger",VCXIModelNavigable:"DS/VCXWebDressup/VCXDressupModelNavigable",VCXIManipulable:"DS/VCXWebDigger/VCXDiggerManipulable",VCXIReadiness:"DS/WebApplicationBase/VCXAReadiness"}},t={VCXIManipulable:"DS/VCXWebVisualization/VCXIManipulable",VCXIModifiable:"DS/VCXWebModifiables/VCXIModifiable",VCXIModifiableView:"DS/VCXWebModifiables/VCXIModifiableView",VCXIVisibility:"DS/VCXWebVisibility/VCXIVisibility",W3AISGNodeHolder:"DS/WebApplicationBase/W3AISGNodeHolder",VCXIModelNavigable:"DS/WebApplicationBase/VCXIModelNavigable",VCXITreeNode:"DS/VCXWebTreeGUI/VCXITreeNode",VCXISensible:"DS/VCXWebComposer/VCXISensible",VCXIReadiness:"DS/WebApplicationBase/VCXIReadiness"},i={VCXDigger_Spec:"DS/VCXWebDigger/VCXDigger_Spec",VCXComponentDigger:"DS/VCXWebDigger/VCXDigger_Spec"},r=["VCXWebDigger/VCXWebDigger"];return{GetDictionary:function(){return{interfaces:t,components:i,extensions:e}},getNLSModules:function(){return r}}}),define("DS/VCXWebDigger/VCXDiggerModifiable",["DS/VCXWebDressup/VCXDressupModifiable","DS/VCXWebDigger/VCXDigger_Spec","DS/Visualization/ThreeJS_DS","DS/VCXWebProperties/VCXProperty","DS/VCXWebProperties/VCXPropertyInfoEnum","DS/VCXWebProperties/VCXPropertyValueAnchor","DS/VCXWebProperties/VCXPropertyValueFrame","DS/VCXWebProperties/VCXPropertyValueBoolean","DS/VCXWebProperties/VCXPropertyValuePoint2D","DS/VCXWebProperties/VCXPropertyValueFloat","DS/VCXWebProperties/VCXPropertyValueEnum","DS/VCXWebProperties/VCXPropertyValueVector","DS/VCXWebProperties/VCXPropertyValueString","DS/VCXWebVisualization/VCXAnchorHandle","i18n!DS/VCXWebDigger/assets/nls/VCXWebDigger"],function(e,t,i,r,n,o,a,s,g,l,h,d,c,p,u){"use strict";return e.extend({init:function(){this._parent()},Build:function(){this._parent();var r=[{Name:"Digger.Position",Type:g,DefaultValue:new i.Vector2(274.5,22.5),i18nGroup:u,GroupId:"Group.Position"},{Name:"Digger.Radius",Type:l,DefaultValue:45,i18nGroup:u,GroupId:"Group.Position",Bounds:{Min:10,Step:1}},{Name:"Digger.Mode",Type:h,DefaultValue:t.EMode.Zoom,i18nGroup:u,GroupId:"Group.Settings"},{Name:"Digger.ZoomFactor",Type:l,DefaultValue:.5,i18nGroup:u,GroupId:"Group.Settings",Bounds:{Min:0,Max:1,Step:.01}},{Name:"Digger.DepthFactor",Type:l,DefaultValue:0,i18nGroup:u,GroupId:"Group.Settings",Bounds:{Min:0,Max:1,Step:.01}},{Name:"Digger.DepthZoom",Type:l,DefaultValue:0,i18nGroup:u,GroupId:"Group.Settings",Bounds:{Min:0,Max:1,Step:.01}},{Name:"Digger.TorchFilter",Type:s,DefaultValue:!0,i18nGroup:u,GroupId:"Group.Settings"},{Name:"Digger.Attach",Type:s,DefaultValue:!0,i18nGroup:u,GroupId:"Group.Settings"},{Name:"Actor.Anchor.0",Type:o,DefaultValue:(new o).SetValueFrame((new a).SetValueFromVector(new i.Vector3(0,0,0))).GetValue(),visibleInPropertyGroups:!1},{Name:"Collab.ListAnchorsIDs",Type:d,DefaultValue:[0],visibleInPropertyGroups:!1},{Name:"Digger.AssociatedPanelID",Type:c,DefaultValue:"",visibleInPropertyGroups:!1},{Name:"Actor.IsAlwaysOnTop",visibleInPropertyGroups:!1}];this._BuildPropertyValues(r),this.SetPropertyInvisible("Collab.ListAnchorsIDs",!0),this.SetPropertyInvisible("Digger.AssociatedPanelID",!0),this.ChangeGroupAvailability("Group.Image",e.EAvailability.NoControl)},SetPropertiesInfo:function(){this._parent(),this.SetPropertyInvisible("Digger.ZoomFactor",this.GetPropertyValue("Digger.Mode")!==t.EMode.Zoom),this.SetPropertyInvisible("Digger.DepthFactor",this.GetPropertyValue("Digger.Mode")===t.EMode.Zoom),this.SetPropertyInvisible("Digger.DepthZoom",this.GetPropertyValue("Digger.Mode")===t.EMode.Zoom),this.SetPropertyInvisible("Digger.TorchFilter",this.GetPropertyValue("Digger.Mode")===t.EMode.Zoom),this.ChangeGroupAvailability("Group.Actions",e.EAvailability.AppForceNotAvailable)},GetProperty:function(e){var i=null;if("Digger.Mode"===e){var o=0;if(d=this._parent(e))o=d.Clone().GetPropertyValue().GetValue();var a=new h;a.SetValue(o);var s=this.QueryInterface("VCXIModifiableView");let c="";s&&(c=s.getPropertyGroupsi18n());var g=new n(e,1,!0,c),l=this._generateMapChoiceFromEnumAndId(t.EMode,"Digger",["Detail"]);g.SetMapChoiceEnum(l),g.SetGroupId("Group.Settings"),i=new r(g,a)}else i=this._parent(e);"Actor.IsAlwaysOnTop"!==e&&"Actor.ToolTip"!==e&&"Actor.Freeze"!==e&&"Actor.Anchor.0"!==e&&"Actor.Hyperlink"!==e||(d=this._parent(e))&&(c=d.GetPropertyInfo())&&c.SetVisible(!1);if("Digger.ZoomFactor"===e||"Digger.DepthFactor"===e||"Digger.DepthZoom"===e||"Digger.TorchFilter"===e){var d,c,p=this._parent("Digger.Mode"),u=null;if(p)u=p.Clone().GetPropertyValue().GetValue();if(d=this._parent(e))if(c=d.GetPropertyInfo()){var D="Digger.ZoomFactor"===e;c.SetVisible(0===u?D:!D)}}return i}})}),define("DS/VCXWebDigger/VCXDiggerManipulable",["DS/VCXWebDressup/VCXManipulableDressup","DS/VCXWebDigger/VCXDigger_Spec","DS/Visualization/ThreeJS_DS","DS/VCXWebVisualization/VCXInteractor"],function(e,t,i,r){"use strict";return e.extend({init:function(e){this._anchorVect3=new i.Vector3(0,0,0),this._parent(e)},updateInteractors:function(e){this._parent(e);var n=this.getInteractor("Interactor Anchor.0");if(n){if(!n.handleInfos)return;var o=this.QueryInterface("VCXIModifiable"),a=o.GetPropertyValue("Digger.Attach"),s=(this.QueryInterface("VCXIVisibility"),o.GetOpacity());if(n.handleInfos.opacity=s,a?(n.handleInfos.stayVisible=!0,n.visibility=0===s?r.EVisibility.NoChange:r.EVisibility.Always):(n.handleInfos.stayVisible=!1,n.visibility=r.EVisibility.NoChange),n.visibility===r.EVisibility.Always){var g=(new i.Vector3).getPositionFromMatrix(n.matrix);g.equals(this._anchorVect3)||(this.GetObject()._DiggerDirtyMask|=t.FDirty.AnchorPosition,this._anchorVect3.copy(g))}}},_createAnchorHandleInteractor:function(){if(!this.getNode())return null;var e=this.getInteractor("Interactor Anchor.0");return e||((e=this._parent("Interactor Anchor.0","0")).application|=r.EApplication["3DPlayCATIAComposer"],this.addInteractor("Interactor Anchor.0",e)),e.application&r.EApplication["3DPlayCATIAComposer"]||(e.application|=r.EApplication["3DPlayCATIAComposer"]),e.handleInfos||(e.handleInfos={size:10}),e}})}),define("DS/VCXWebDigger/VCXDiggerNode",["UWA/Element","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/VCXWebVisualization/VCXVisuManager","DS/VCXWebKernelTools/VCXFileServices","DS/VCXWebKernelTools/VCXPixelImage","DS/VCXWebVisualization/VCXPickerTools","DS/VCXWebDressup/VCXDressupNode","DS/VCXWebDressup/VCXCmdChangeDressup","DS/VCXWebDressup/VCXMarkup_Spec","DS/VCXWebDigger/VCXDigger_Spec","DS/VCXWebDiggerKernel/VCXDiggerKernel","DS/VCXWebDigger/VCXDiggerUI","DS/VCXWebVisualization/VCXPublishRasterImage","DS/WebappsUtils/WebappsUtils","DS/Visualization/WebGLV6Viewer","DS/Visualization/Viewpoint","DS/Core/PointerEvents","DS/VCXWebProperties/VCXPropertyValuePoint2D","DS/VCXWebProperties/VCXPropertyValueBoolean","DS/VCXWebProperties/VCXPropertyValueFloat","DS/VCXWebProperties/VCXPropertyValueEnum","DS/VCXWebProperties/VCXPropertyValueAnchor","DS/VCXWebProperties/VCXPropertyValueFrame","DS/VCXWebProperties/VCXPropertyValueVector","DS/VCXWebProperties/VCXPropertyValueString","DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey","DS/VCXWebKernel/VCXCmdChangeSelection","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/VCXWebVisibility/VCXIVisibility","DS/VCXWebGUIInfra/VCXArcBar","DS/VCXWebKernelCommands/VCXCmdChangeVisibility","i18n!DS/VCXWebDigger/assets/nls/VCXWebDigger"],function(e,t,i,r,n,o,a,s,g,l,h,d,c,p,u,D,_,V,C,b,v,y,P,M,f,S,m,X,w,I,E,x,T){"use strict";var A=s.extend({init:function(e){this._parent(e),this._viewerDigger=null,this.DiggerKernel=null,this.DiggerUI=null,this._previousVPTarget=new t.Vector3(0,0,0),this._previousVPOrientation=new t.Quaternion(0,0,0,0),this._attachDiv1=null,this._attachDiv2=null,this._angleZoom=-135,this._angleDepth=-135,this._viewer=null,this._displayUI=!0,this._buttonResize=null,this._buttonResizeGhost=null,this._buttonSlider=null,this._buttonSliderShadow=null,this._modeBackgroundColor="linear-gradient(rgb(216,233,248) 0, rgb(216,233,248) 35%, rgb(160,202,241) 100%)",this._modeBackgroundColorDefault="rgba(239,239,239,1)",this._isDragged=null,this._updatePickabilityTimer=null,this._anchorVect3=new t.Vector3(0,0,0);var r=this;this.onPropertiesChanged=function(e){r.isVisible()&&r.projectionTypeChanged()&&r._viewerDigger.render()},this._tokenPropertiesChanged=i.subscribe({event:"VCX_PROPERTIES_CHANGED"},this.onPropertiesChanged),this.onStartPauseStopPlayBeginEndTransition=function(e){if(r.isVisible()){var t=r.Modifiable.GetObject();t._DiggerDirtyMask|=h.FDirty.Buttons,t.setDirty()}},this._tokenStartPlay=i.subscribe({event:"VCX_START_PLAY"},this.onStartPauseStopPlayBeginEndTransition),this._tokenPausePlay=i.subscribe({event:"VCX_PAUSE_PLAY"},this.onStartPauseStopPlayBeginEndTransition),this._tokenStopPlay=i.subscribe({event:"VCX_STOP_PLAY"},this.onStartPauseStopPlayBeginEndTransition),this._tokenScenarioEndReached=i.subscribe({event:"VCX_SCENARIO_END_REACHED"},this.onStartPauseStopPlayBeginEndTransition),this._tokenBeginTransition=i.subscribe({event:"VCX_BEGIN_TRANSITION"},this.onStartPauseStopPlayBeginEndTransition),this._tokenEndTransition=i.subscribe({event:"VCX_END_TRANSITION"},this.onStartPauseStopPlayBeginEndTransition),this._tokenVCX_AMBIENCE_CHANGED=i.subscribe({event:"VCX_AMBIENCE_CHANGED"},function(){if(r._viewerDigger){console.log("updating digger ambience");var e=r.ExperienceBase.getManager("VCXContextManager").getMainViewer().ambience;e&&r._viewerDigger.setAmbience(e)}})},disposeViewer:function(){var e=this.DiggerKernel._viewer.currentViewpoint;if(e&&e.control&&(e.control._mouseWheel=null,e.control._zoom=null),this.DiggerKernel.removeOverrides(),this.removeViewer(),this._viewerDigger){for(;this._viewerDigger.getRootNode().getChildren().length;)this._viewerDigger.getRootNode().removeChild(this._viewerDigger.getRootNode().getChildren()[0]);this._viewerDigger.removeViewpoint(0),this._viewerDigger.dispose(),this._viewerDigger=null}},dispose:function(){this.deleteDiggerPanelToolbar(),this.disposeViewer(),this._tokenPropertiesChanged&&(i.unsubscribe(this._tokenPropertiesChanged),this._tokenPropertiesChanged=null),this._tokenStartPlay&&(i.unsubscribe(this._tokenStartPlay),this._tokenStartPlay=null),this._tokenPausePlay&&(i.unsubscribe(this._tokenPausePlay),this._tokenPausePlay=null),this._tokenStopPlay&&(i.unsubscribe(this._tokenStopPlay),this._tokenStopPlay=null),this._tokenScenarioEndReached&&(i.unsubscribe(this._tokenScenarioEndReached),this._tokenScenarioEndReached=null),this._tokenBeginTransition&&(i.unsubscribe(this._tokenBeginTransition),this._tokenBeginTransition=null),this._tokenEndTransition&&(i.unsubscribe(this._tokenEndTransition),this._tokenEndTransition=null),this._tokenVCX_AMBIENCE_CHANGED&&(i.unsubscribe(this._tokenVCX_AMBIENCE_CHANGED),this._tokenVCX_AMBIENCE_CHANGED=null),this.DiggerKernel&&(this.DiggerKernel.dispose(),this.DiggerKernel=null),this.DiggerUI&&(this.DiggerUI.dispose(),this.DiggerUI=null),this.removeDiv(),this._buttonResize&&(this._buttonResize_POINTERDOWN&&(this._buttonResize.removeEventListener(V.POINTERDOWN,this._buttonResize_POINTERDOWN),this._buttonResize_POINTERDOWN=null),this._buttonResize=null),this._buttonSlider&&(this._buttonSlider_POINTERDOWN&&(this._buttonSlider.removeEventListener(V.POINTERDOWN,this._buttonSlider_POINTERDOWN),this._buttonSlider_POINTERDOWN=null),this._buttonSlider=null),this._buttonSliderShadow&&(this._buttonSliderShadow=null),this._buttonResizeGhost&&(this._buttonResizeGhost=null),this._viewer.div.removeEventListener(V.POINTERMOVE,this._fctWhile),this._viewer.div.removeEventListener(V.POINTERUP,this._fctEnd),this._fctWhile=null,this._fctEnd=null,this._viewer=null,this._parent()},getProp:function(e){var t=-1,i=this.Modifiable.GetProperty(e);i&&(t=i.Clone().GetPropertyValue().GetValue());return t},setProp:function(e,t,i){var r=this.Modifiable;null!==i&&(i.SetValue(e),r.OnChangeProperty(t,i),r.OnChangePropertiesEnd())},getRadius:function(){return this.getProp("Digger.Radius")},setRadius:function(e){this.setProp(e,"Digger.Radius",new v)},getRadiusInPixel:function(){return this.getRadius()*this.ExperienceBase.getManager("VCXPaperManager").GetMmToPxRatio()},setRadiusInPixel:function(e){var t=this.ExperienceBase.getManager("VCXPaperManager").GetMmToPxRatio();this.setRadius(e/t)},getPosition:function(){return this.getProp("Digger.Position")},setPosition:function(e){this.setProp(e,"Digger.Position",new C)},getPositionInPixel:function(){var e=this.getPosition();return this.ExperienceBase.getManager("VCXPaperManager").MMToPixel2(null,e)},setPositionInPixel:function(e){var t=this.ExperienceBase.getManager("VCXPaperManager").PixelToMM2(null,e);this.setPosition(t)},getMode:function(){return this.getProp("Digger.Mode")},setMode:function(e){this.setProp(e,"Digger.Mode",new y)},getZoomFactor:function(){return this.getProp("Digger.ZoomFactor")},setZoomFactor:function(e){this.setProp(e,"Digger.ZoomFactor",new v)},getDepthFactor:function(){return this.getProp("Digger.DepthFactor")},setDepthFactor:function(e){this.setProp(e,"Digger.DepthFactor",new v)},getDepthZoom:function(){return this.getProp("Digger.DepthZoom")},setDepthZoom:function(e){this.setProp(e,"Digger.DepthZoom",new v)},getAttachDisplay:function(){return this.getProp("Digger.Attach")},setAttachDisplay:function(e){this.setProp(e,"Digger.Attach",new b)},isVisible:function(){if(this.Modifiable&&this.Modifiable.GetObject()){var e=this.Modifiable.GetObject().QueryInterface("VCXIVisibility");if(e&&e.GetVisibility()===I.EVisState.Hidden)return!1;if(0===this.GetOpacity()&&0===this._diggerPreviousOpacity)return!1}return!0},getTorchFilter:function(){return this.getProp("Digger.TorchFilter")},setTorchFilter:function(e){this.setProp(e,"Digger.TorchFilter",new b)},convert3DPointToPxl:function(e,t){var i=null;return t&&(i=t.currentViewpoint.project(e)),i},convert3DPointToCanvasPxl:function(e,i,r){var n=null;if(i){var o=i.currentViewpoint.camera;n=e.clone();(new t.Projector).projectVector(n,o),n.x=.5*r.width*(n.x+1),n.y=.5*r.height*(1-n.y)}return n},getAnchorVector:function(){var e=Object.keys(this.Anchors)[0];return(new t.Vector3).getPositionFromMatrix(this.Modifiable.GetAnchorWorldMatrix(e,null))},getPaperCenter3D:function(){var e=this.ExperienceBase.getManager("VCXPaperManager"),i=e.Size.x,r=e.Size.y,n=new t.Vector2(0,0);n.x=0+.5*i,n.y=0+.5*r;var o=e.MMToPixel2(null,n),s=this.ExperienceBase.getManager("VCXContextManager").getMainViewer();if(s){var g=s.canvas.getBoundingClientRect();o.x+=g.left,o.y+=g.top}return new a(this.ExperienceBase).pick2DonGround(this.ExperienceBase.getManager("VCXContextManager").getMainViewer(),o.x,o.y)},calcDiggerPositionToAnchorAngle:function(e,t,i){var r,n=i.x-t.x,o=i.y-t.y;return Math.sqrt(n*n+o*o)-e<0?-1:(r=0===n?270:-Math.atan(o/n)*(180/Math.PI),n<0?r+=180:n>0&&o>0&&(r+=360),r)},calcDiggerAnchorPoints:function(e,i,r){var n=this.calcDiggerPositionToAnchorAngle(e,i,r);if(-1===n)return null;var o=new t.Vector2;o.x=i.x+e*this.myCos(n*Math.PI/180),o.y=i.y-e*this.mySin(n*Math.PI/180);var a=new t.Vector2,s=new t.Vector2,g=this.ExperienceBase.getManager("VCXPaperManager").GetMmToPxRatio()*window.devicePixelRatio,l=this.Modifiable.GetObject().borderThickness*g*.4;return a.x=o.x+l*this.myCos((n+90)*Math.PI/180),a.y=o.y-l*this.mySin((n+90)*Math.PI/180),s.x=o.x+l*this.myCos((n-90)*Math.PI/180),s.y=o.y-l*this.mySin((n-90)*Math.PI/180),{p1:a,p2:s}},drawTriangle:function(e,t,i,r,n,o){var a=this.getRadiusInPixel(),s=i.x-t.x,g=i.y-t.y,l=Math.sqrt(s*s+g*g)-a-this.Modifiable.GetObject().borderThickness+o;if(l<0)e.style.display="none";else{e.style.display="",e.style.width="0px",e.style.height="0px",e.style.position="absolute",e.style.display="block",e.style.borderRight=r+"px solid transparent",e.style.borderBottom=l+"px solid "+n,e.style.borderLeft=e.style.borderRight;var h=Math.atan(g/s)*(180/Math.PI);s>0&&g<0?h-=90:s>0&&g>0?h-=90:h+=90;var d=-r+a,c=-.5*l+a,p=-(.5*l+a)-this.Modifiable.GetObject().borderThickness+o;e.style.transform="translate("+d+"px, "+c+"px) rotate("+h+"deg) translateY("+p+"px)"}},updateDiggerAttach:function(e){if(this.getAttachDisplay()&&this._attachDiv1&&this._attachDiv2){void 0===e&&(e=this.getAnchorVector());var t=this.convert3DPointToPxl(e,this._viewer),i=this.getPositionInPixel();this.drawTriangle(this._attachDiv1,t,i,12,"rgb(250,250,250)",0),this.drawTriangle(this._attachDiv2,t,i,13,"rgb(60,60,60)",1),this.DiggerKernel._attachP=t}},updateDiggerUI:function(){if(this._divDigger){var e=this.getRadiusInPixel(),t=this.getPositionInPixel();this._divDigger.style.left=t.x-e+"px",this._divDigger.style.top=t.y-e+"px",this._divDigger.style.height=2*e+"px",this._divDigger.style.width=this._divDigger.style.height,this._divDiggerContent.style.height=2*(e-this.Modifiable.GetObject().borderThickness)+"px",this._divDiggerContent.style.width=this._divDiggerContent.style.height,this.updateButtons()}},myCos:function(e){var t=0;return e<-3.14159265?e+=6.28318531:e>3.14159265&&(e-=6.28318531),(e+=1.57079632)>3.14159265&&(e-=6.28318531),t=e<0?(t=1.27323954*e+.405284735*e*e)<0?.225*(t*-t-t)+t:.225*(t*t-t)+t:(t=1.27323954*e-.405284735*e*e)<0?.225*(t*-t-t)+t:.225*(t*t-t)+t},mySin:function(e){var t=0;return e<-3.14159265?e+=6.28318531:e>3.14159265&&(e-=6.28318531),t=e<0?(t=1.27323954*e+.405284735*e*e)<0?.225*(t*-t-t)+t:.225*(t*t-t)+t:(t=1.27323954*e-.405284735*e*e)<0?.225*(t*-t-t)+t:.225*(t*t-t)+t},updateButtons:function(){var e;if(e=this._displayUI?"":"none",this._toolbar&&this._toolbar.updateCommandState(),this._buttonResize.style.display=e,this._buttonResizeGhost.style.display=e,this._buttonSlider.style.display=e,this._buttonSliderShadow.style.display=e,this._displayUI){var t,i=this.getRadiusInPixel(),r="translate("+(-3+i)+"px,"+(i-30)+"px)";r+=" rotate("+-30+"deg)",r+="translateX("+-(4.5+i)+"px",this._buttonResize.style.transform=r;r="translate("+(-7+i-.2)+"px,"+(i-10)+"px)";r+=" rotate("+(t=this.getMode()===h.EMode.Zoom?this.factor2angle(this.getZoomFactor()):this.factor2angle(this.getDepthFactor()))+"deg)",r+="translateY("+(15-this.Modifiable.GetObject().borderThickness+i+1.2)+"px",this._buttonSlider.style.transform=r;r="translate("+(-9.5+i)+"px,"+(i-10.5)+"px)";r+=" rotate("+t+"deg)",r+="translateY("+(15-this.Modifiable.GetObject().borderThickness+i+2)+"px",this._buttonSliderShadow.style.transform=r}},_Build:function(){this.DiggerKernel=new d,this.DiggerUI=new c;var e=this.Modifiable.GetObject();this.DiggerUI.diggerComponent=e,this._viewer=this.ExperienceBase.getManager("VCXContextManager").getMainViewer();var t=this.getRadiusInPixel(),i=this.getPositionInPixel();this.DiggerKernel._radiusPx=t,this.DiggerKernel._positionPx=i,this.cssStylesBorderDigger={position:"absolute",textAlign:"left",top:i.x-t+"px",left:i.y-t+"px",height:2*t+"px",width:2*t+"px",border:"1px solid "+e.borderLineOuterColor.GetStyle(),backgroundColor:e.borderColor.GetStyle(),borderRadius:"50%",boxShadow:"0px 0px 0px 1px "+e.borderLineInnerColor.GetStyle()},this.cssStylesContentDigger={position:"absolute",height:2*(t-this.Modifiable.GetObject().borderThickness)+"px",width:2*(t-this.Modifiable.GetObject().borderThickness)+"px",borderRadius:"50%",boxShadow:"0px 0px 0px 1px "+e.borderLineInnerColor.GetStyle(),margin:"auto",top:"0",left:"0",bottom:"0",right:"0"},this._divDigger=new UWA.Element("div",{id:"divDigger",styles:this.cssStylesBorderDigger}),this._divDigger.setAttribute("data-rec-id",this.Modifiable.GetObject().GetID()+"_divDigger"),this._divDiggerContent=new UWA.Element("div",{id:"divDiggerContent",styles:this.cssStylesContentDigger}),this._divDiggerContent.setAttribute("data-rec-id",this.Modifiable.GetObject().GetID()+"_divDiggerContent"),this._divDiggerContent.inject(this._divDigger),this._divDigger.inject(this._viewer.div),this._attachDiv2=document.createElement("div"),this._divDigger.appendChild(this._attachDiv2),this._attachDiv1=document.createElement("div"),this._divDigger.appendChild(this._attachDiv1),this._attachDiv1.style.pointerEvents="none",this._attachDiv2.style.pointerEvents="none",this._attachDiv1.style.opacity="0.9",this._attachDiv2.style.opacity="0.5",this.updateAnchorAttach(!1),this._buttonResizeGhost=document.createElement("canvas"),this._buttonResizeGhost.style.margin="-4px",this._buttonResizeGhost.style.width="408px",this._buttonResizeGhost.style.height="408px",this._buttonResizeGhost.style.borderRadius="inherit",this._buttonResizeGhost.style.transform="rotate(0deg)";var n=this._buttonResizeGhost.getContext("2d");n.canvas.width=408,n.canvas.height=408,n.save(),n.shadowBlur=1,n.shadowColor="gray",n.fillStyle="rgba(200, 200, 200, 0.95)",n.clearRect(0,0,n.canvas.width,n.canvas.height),n.beginPath();var o=Math.PI/27;n.arc(207,204,188,Math.PI-o,Math.PI+o);var a=207+200*this.myCos(Math.PI+o),s=204+200*this.mySin(Math.PI+o);n.lineTo(a,s);for(var g=2*o/30,l=Math.PI+o,h=0;h<30;h++)l-=g,a=207+200*this.myCos(l),s=204+200*this.mySin(l),n.lineTo(a,s);n.closePath(),n.fill(),n.restore(),n.beginPath(),n.strokeStyle="#FFFFFF",n.arc(207,204,194,Math.PI-Math.PI/35,Math.PI+Math.PI/35),n.stroke(),this._buttonResize=document.createElement("canvas"),this._buttonResize.setAttribute("class","VCXsizeButton"),this._buttonResize.style.margin="-4px",this._buttonResize.style.transform="translate(-5px,"+(t-30)+"px) rotate(0deg)",this._buttonResize.style.cursor="sw-resize",this._buttonResize.setAttribute("data-rec-id",this.Modifiable.GetObject().GetID()+"_VCXsizeButton"),this._divDigger.appendChild(this._buttonResize);var p=this._buttonResize.getContext("2d");p.canvas.width=22,p.canvas.height=60,p.drawImage(this._buttonResizeGhost,0,-175),this._buttonSliderShadow=UWA.createElement("div",{html:"",class:"VCXDiggerButtonZoomShadow",styles:{height:0,width:"2px",borderBottom:"21px solid rgba(0,0,0,0.6)",borderLeft:"3px solid transparent",borderRight:"4px solid transparent",padding:"0 8px 0 0",position:"absolute",transform:"rotate(135deg) translate(-43px,-22px)",top:"0px"}}),this._divDigger.appendChild(this._buttonSliderShadow),this._buttonSlider=UWA.createElement("div",{html:"",class:"VCXDiggerButtonZoom",styles:{height:0,width:"0px",borderBottom:"20px solid rgba(255,255,255,0.9)",borderLeft:"1px solid transparent",borderRight:"3px solid transparent",padding:"0 8px 0 0",position:"absolute",transform:"rotate(135deg) translate(-43px,-22px)",top:"0px",cursor:"s-resize"}}),this._buttonSlider.setAttribute("data-rec-id",this.Modifiable.GetObject().GetID()+"_VCXDiggerButtonZoom"),this._divDigger.appendChild(this._buttonSlider),this.createDiggerPanelToolbar();var u=r.getViewerOptions();u.div=this._divDiggerContent,u.planeV2=this._viewer.planeV2,this._viewerDigger=new D(u),this._viewerDigger.setHighlight(!1),this._viewerDigger.displayPoints(!0),this._viewerDigger._isDigger=!0,this._viewerDigger.getRootNode().name="diggerRootNode",this._viewerDigger.setReferenceAxisSystem(!1);var V=this._viewerDigger.getRobot();V&&V.setVisibility(!1);var C=this.ExperienceBase.getManager("VCXContextManager").getMainViewer().ambience;C&&this._viewerDigger.setAmbience(C),this._viewerDigger.setOIT(!0);this.Modifiable;var b=this.ExperienceBase.getManager("VCXContextManager").getRootNode();this._viewerDigger.addNode(b);var v=this.ExperienceBase.getManager("VCXDressupManager");if(v){var y=v.QueryInterface("W3AISGNodeHolder");y&&this._viewerDigger.addNode(y.getSGNode())}var P={viewer:this._viewerDigger,angle:45};if(this.DiggerKernel._diggerViewpoint=new _(P),this.DiggerKernel._diggerViewpoint.getControl().setRotationRolling(!1),this._viewerDigger.addViewpoint(this.DiggerKernel._diggerViewpoint),b){var M=this._viewerDigger.getSceneGraphOverrideSetManager();M.pushSceneGraphOverrideSet(this.ExperienceBase.getManager("VCXContextManager").getSharedSceneGraphOverrideSet()),this.DiggerKernel._SceneGraphOverrideSet=new w(b),M.pushSceneGraphOverrideSet(this.DiggerKernel._SceneGraphOverrideSet)}this._viewerDigger.canvas.style.borderRadius="inherit",this._viewerDigger.canvas.style.textAlign="left",this.addViewer(),this.initDiggerDressup(),this.addPointerEvents(),this.updateButtons(),this.ExperienceBase.getManager("VCXVisuManager").getActiveViewport().update({viewer:this._viewerDigger,force:!0})},removeDiv:function(){this._divDigger&&(this._divDigger_POINTERDOWN&&(this._divDigger.removeEventListener(V.POINTERDOWN,this._divDigger_POINTERDOWN),this._divDigger_POINTERDOWN=null),this._viewer.div.removeChild(this._divDigger)),this._divDigger=null},dragWhileFactory:function(e){return function(i){if(e.DiggerKernel._lockPickability=!0,e.Modifiable){var r=e,n=i.clientX,o=i.clientY;i.preventDefault(),i.stopPropagation();var a=r.getRadiusInPixel(),s=new t.Vector2;s.x=n-r._ondragDeltaX+a,s.y=o-r._ondragDeltaY+a,r._divDigger.style.left=n-r._ondragDeltaX+"px",r._divDigger.style.top=o-r._ondragDeltaY+"px",r.setPositionInPixel(s),r._toolbar.setInManipulation(!0),r._toolbar.updateVisibilityStyle()}}},dragEndFactory:function(e){return function(t){e.DiggerKernel._lockPickability=!1;var i=e;i._viewer.div.removeEventListener(V.POINTERMOVE,i._fctWhile,!0),i._viewer.div.removeEventListener(V.POINTERUP,i._fctEnd,!0);var r=i.Modifiable.GetProperty("Digger.Position").Clone(),n=new C,o=i.getPosition();n.SetValue(o),r.SetPropertyValue(n);var a=new m(i.ExperienceBase.getManager("VCXScenarioManager"),i.ExperienceBase.getManager("VCXCommandManager"));a.ChangeProperty(e.Modifiable,r),i.ExperienceBase.getManager("VCXCommandManager").Push(a),i.ExperienceBase.getManager("VCXContextManager").setAllViewerSensitive(!0),t.stopPropagation(),i._isDragged=null,i._toolbar.setInManipulation(!1),i._toolbar.updateVisibilityStyle()}},moveButtonWhileFactory:function(e){return function(t){if(e.Modifiable){t.preventDefault(),t.stopPropagation();var i=e,r=t.clientX,n=t.clientY,o=i.getPositionInPixel(),a=i._viewer.canvas.getBoundingClientRect();if(o.x+=a.left,o.y+=a.top,i.ExperienceBase.getManager("VCXContextManager").setAllViewerSensitive(!1),i.DiggerKernel._lockPickability=!0,i._isDragged&&"VCXDiggerButtonZoom"===i._isDragged.className){var s,g=r-o.x,l=n-o.y;if((s=Math.atan2(l,g)-Math.atan2(1,0))>0&&s<.5*Math.PI&&(s=-1e-17),s<0&&(s+=2*Math.PI),s=Math.min(320,Math.max(180*s/Math.PI,204)),i.getMode()===h.EMode.Zoom){var d=i.angle2factor(s);i.DiggerKernel.setZoom(d),i.setZoomFactor(d)}else{var c=i.angle2factor(s);i.DiggerKernel.setDepth(c),i.setDepthFactor(c)}i.updateButtons()}else{var p=r-o.x;p=Math.abs(p*p);var u=n-o.y;u=Math.abs(u*u);var D=Math.sqrt(p+u);i.setRadiusInPixel(D),i.updateDiggerUI(),i._toolbar.setInManipulation(!0),i._toolbar.updateVisibilityStyle()}}}},angle2factor:function(e){return e*(1/116)+(0-1/116*204)},factor2angle:function(e){return(e-(0-1/116*204))/(1/116)},moveButtonEndFactory:function(e){return function(t){t.preventDefault(),t.stopPropagation();var i=e;if(i._viewer.div.removeEventListener(V.POINTERMOVE,i._fctWhile,!0),i._viewer.div.removeEventListener(V.POINTERUP,i._fctEnd,!0),i._isDragged){var r=null,n=null;"VCXDiggerButtonZoom"===i._isDragged.className?(i.getMode()===h.EMode.Zoom?(r=e.Modifiable.GetProperty("Digger.ZoomFactor").Clone(),(n=new v).SetValue(i.getZoomFactor())):(r=e.Modifiable.GetProperty("Digger.DepthFactor").Clone(),(n=new v).SetValue(i.getDepthFactor())),i.DiggerKernel._lockPickability=!1,i.DiggerKernel.updateDiggerContent()):(r=e.Modifiable.GetProperty("Digger.Radius").Clone(),(n=new v).SetValue(i.getRadius()),i._toolbar.setInManipulation(!1),i._toolbar.updateVisibilityStyle()),r.SetPropertyValue(n);var o=new m(e.ExperienceBase.getManager("VCXScenarioManager"),e.ExperienceBase.getManager("VCXCommandManager"));o.ChangeProperty(e.Modifiable,r),e.ExperienceBase.getManager("VCXCommandManager").Push(o),i.ExperienceBase.getManager("VCXContextManager").setAllViewerSensitive(!0),i._isDragged=null}}},distanceTo:function(e,t,i,r){return Math.sqrt(Math.pow(i-e,2)+Math.pow(r-t,2))},mouseOnBorder:function(e,t,i,r,n,o){var a=this.distanceTo(e,t,i,r);return a<=n&&a>=o},runUpdateCommand:function(e,t){switch(t){case"I_VCX_Digger_Mode_DetailView":e.check=this.getMode()===h.EMode.Detail;break;case"I_VCX_Digger_Mode_Zoom":e.check=this.getMode()===h.EMode.Zoom;break;case"I_VCX_Digger_Mode_XRay":e.check=this.getMode()===h.EMode.XRay;break;case"I_VCX_Digger_Mode_OnionSkin":e.check=this.getMode()===h.EMode.Onion;break;case"I_VCX_Digger_Tool_LockPlanes":e.check=this.DiggerKernel.getLockPlanes(),e.enable=this.getMode()===h.EMode.XRay||this.getMode()===h.EMode.Onion;break;case"I_VCX_Digger_Tool_LockVP":e.check=this.DiggerKernel.getLockViewpoint();break;case"I_VCX_Digger_Tool_Focus":e.check=this.getAttachDisplay()}},runCommand:function(e){switch(e){case"I_VCX_Digger_Mode_Zoom":this.setModeZoom();break;case"I_VCX_Digger_Mode_XRay":this.setModeXRay();break;case"I_VCX_Digger_Mode_OnionSkin":this.setModeOnionSkin();break;case"I_VCX_Digger_Hide":this.setDelete();break;case"I_VCX_Digger_Tool_2DSnapshot":this.setSnapshot2D();break;case"I_VCX_Digger_Tool_LockPlanes":this.setLockPlanes();break;case"I_VCX_Digger_Tool_LockVP":this.setLockViewpoint();break;case"I_VCX_Digger_Tool_Focus":this.setFocus()}},setDelete:function(){var e=this.Modifiable.GetObject();this.ExperienceBase.getManager("VCXSelectionManager").removeComponentsFromSelection([e],!1);var t=new g(this.ExperienceBase.getManager("VCXCommandManager"),this.ExperienceBase.getManager("VCXDressupManager"),this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.ComponentsMap),i=[];i.push(e),t.RemoveDressups(i),this.ExperienceBase.getManager("VCXCommandManager").Push(t)},setModeZoom:function(){this.setMode(h.EMode.Zoom);var e=this.Modifiable.GetProperty("Digger.Mode").Clone(),t=new y;t.SetValue(this.getMode()),e.SetPropertyValue(t);var i=new m(this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.getManager("VCXCommandManager"));i.ChangeProperty(this.Modifiable,e),this.ExperienceBase.getManager("VCXCommandManager").Push(i)},setModeOnionSkin:function(){this.setMode(h.EMode.Onion);var e=this.Modifiable.GetProperty("Digger.Mode").Clone(),t=new y;t.SetValue(this.getMode()),e.SetPropertyValue(t);var i=new m(this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.getManager("VCXCommandManager"));i.ChangeProperty(this.Modifiable,e),this.ExperienceBase.getManager("VCXCommandManager").Push(i)},setModeXRay:function(){this.setMode(h.EMode.XRay);var e=this.Modifiable.GetProperty("Digger.Mode").Clone(),t=new y;t.SetValue(this.getMode()),e.SetPropertyValue(t);var i=new m(this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.getManager("VCXCommandManager"));i.ChangeProperty(this.Modifiable,e),this.ExperienceBase.getManager("VCXCommandManager").Push(i)},setModeDetail:function(){this.setMode(h.EMode.Detail);var e=this.Modifiable.GetProperty("Digger.Mode").Clone(),t=new y;t.SetValue(this.getMode()),e.SetPropertyValue(t);var i=new m(this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.getManager("VCXCommandManager"));i.ChangeProperty(this.Modifiable,e),this.ExperienceBase.getManager("VCXCommandManager").Push(i)},setSnapshot2D:function(){this.createSnapshot2D(!0)},setLockPlanes:function(){this.DiggerKernel.lockPlanes(!this.DiggerKernel.getLockPlanes()),this.DiggerKernel.sortFrontToBack(),this.DiggerKernel.updateDiggerContent(),this.updateButtons()},setLockViewpoint:function(){this.DiggerKernel.lockViewpoint(!this.DiggerKernel.getLockViewpoint()),this.synchronizeDiggerViewpoint(),this.setDiggerViewOffset(),this.updateButtons()},setFocus:function(){if((this.setAttachDisplay(!this.getAttachDisplay()),this.getAttachDisplay())&&this.getAnchorVector().equals(new t.Vector3)){var e=this.getPaperCenter3D(),i=new P;i.SetValueFrame((new M).SetValueFromVector(e)),this.setProp(i.GetValue(),"Actor.Anchor.0",new P)}var r=this.Modifiable.GetProperty("Digger.Attach").Clone(),n=new b;n.SetValue(this.getAttachDisplay()),r.SetPropertyValue(n);var o=new m(this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.getManager("VCXCommandManager"));o.ChangeProperty(this.Modifiable,r),this.ExperienceBase.getManager("VCXCommandManager").Push(o)},addPointerEvents:function(){var e=this;this._divDigger_POINTERDOWN=(t=>{t.stopPropagation(),e._isDragged=e._divDigger;var i=t.clientX,r=t.clientY,n=e.getRadiusInPixel(),o=e.getPositionInPixel(),a=o.x-n,s=o.y-n,g=e._viewer.canvas.getBoundingClientRect();if(o.x+=g.left,o.y+=g.top,e.mouseOnBorder(o.x,o.y,i,r,n,n-e.Modifiable.GetObject().borderThickness)){var l=new X(e.ExperienceBase.getManager("VCXSelectionManager"));l.SetSelection(e.Modifiable.GetObject()),e.ExperienceBase.getManager("VCXCommandManager").Do(l),e._ondragDeltaX=i-a,e._ondragDeltaY=r-s,e._isDragged=!0,e.ExperienceBase.getManager("VCXContextManager").setAllViewerSensitive(!1),e._fctWhile=e.dragWhileFactory(e),e._fctEnd=e.dragEndFactory(e),e._viewer.div.addEventListener(V.POINTERMOVE,e._fctWhile,!0),e._viewer.div.addEventListener(V.POINTERUP,e._fctEnd,!0)}}),this._divDigger.addEvent(V.POINTERDOWN,this._divDigger_POINTERDOWN),this._buttonResize_POINTERDOWN=(t=>{t.stopPropagation(),e._isDragged=e._buttonResize,e._fctWhile=e.moveButtonWhileFactory(e),e._fctEnd=e.moveButtonEndFactory(e),e._viewer.div.addEventListener(V.POINTERMOVE,e._fctWhile,!0),e._viewer.div.addEventListener(V.POINTERUP,e._fctEnd,!0)}),this._buttonResize.addEventListener(V.POINTERDOWN,this._buttonResize_POINTERDOWN),this._buttonSlider_POINTERDOWN=(t=>{t.stopPropagation(),e._isDragged=e._buttonSlider,e._fctWhile=e.moveButtonWhileFactory(e),e._fctEnd=e.moveButtonEndFactory(e),e._viewer.div.addEventListener(V.POINTERMOVE,e._fctWhile,!0),e._viewer.div.addEventListener(V.POINTERUP,e._fctEnd,!0)}),this._buttonSlider.addEventListener(V.POINTERDOWN,this._buttonSlider_POINTERDOWN)},updateAnchorAttach:function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!0),this.getAttachDisplay()&&t?(this._attachDiv1.style.display="",this._attachDiv2.style.display="",e&&this.updateDiggerAttach()):(this._attachDiv1.style.display="none",this._attachDiv2.style.display="none")},synchronizeDiggerViewport:function(){var e=this.ExperienceBase.getManager("VCXVisuManager").getActiveViewport();if(e){var t=e.QueryInterface("VCXIModifiable");if(t){var i=t.GetProperties();t._forceRefresh=!0,i.onEachProperty(function(e,i){t.OnChangeProperty(e,i.GetPropertyValue())}),t.OnChangePropertiesEnd();var r=t.QueryInterface("W3AISGNodeHolder");r&&r.setSGNodeDirty(!0),t._forceRefresh=!1,t.GetObject().setLightingMode(t.GetPropertyValue("Render.Lighting.Override"),t.GetPropertyValue("Render.Lighting.Mode"),t.GetPropertyValue("Render.Lighting.Intensity"),t.GetPropertyValue("Render.Lighting.Static"))}}},synchronizeDiggerGround:function(){var e=this.ExperienceBase.ComponentsMap.GetComponentFromType("VCXComponentGround");if(e&&e.length){var t=e[0].QueryInterface("VCXIModifiable");if(t){var i=t.GetProperties();t._forceRefresh=!0,i.onEachProperty(function(e,i){t.OnChangeProperty(e,i.GetPropertyValue())}),t.OnChangePropertiesEnd();var r=t.QueryInterface("W3AISGNodeHolder");r&&r.setSGNodeDirty(!0),t._forceRefresh=!1}}},addViewer:function(){var e=this.Modifiable;if(e){for(var t=this.ExperienceBase.getManager("VCXContextManager").getViewers(),i="viewer_"+e.GetObject().GetID(),r=0;r<t.length;r++)if(t[r].viewerID===i)return void console.log("VCXContextManager::addViewer "+i+" already added");this.ExperienceBase.getManager("VCXContextManager").addViewer("viewer_"+e.GetObject().GetID(),this._viewerDigger),this.synchronizeDiggerViewport(),this.synchronizeDiggerGround()}},removeViewer:function(){var e=this.Modifiable;e&&this.ExperienceBase.getManager("VCXContextManager").removeViewer("viewer_"+e.GetObject().GetID())},setVisibility:function(e){this._parent(e),e?(this._viewerDigger||this._Build(),this.GetOpacity(),this._divDigger.style.display=""):this._divDigger.style.display="none",this._toolbar&&(this._toolbar.setVisible(e),this._toolbar.updateVisibilityStyle()),this.updateAnchorAttach(!0,e)},preRender:function(e){if(this.isVisible&&(this._parent(e),this._viewerDigger||this._Build(),this._toolbar&&this._toolbar.isVisible())){var t=this.calcToolbarInfo();this._toolbar.updateLayout(t.centerPx,t.radiusPx)}return!1},update:function(e){if(this.isVisible()){this._viewerDigger||this._Build(),this._parent(e);var t=this.Modifiable;this._displayUI=!this.ExperienceBase.getManager("VCXScenarioManager").GetIsPlayingCurrentScenario()&&!this.ExperienceBase.getManager("VCXVisuManager").isInTransitionMode();var i=t.GetObject(),r=!1,n=!1,o=!1;if(this._toolbar&&this._toolbar.setVisible(this._displayUI),this.ExperienceBase.getManager("VCXVisuManager").HasViewpointMoved&&(i._DiggerDirtyMask|=h.FDirty.ViewpointMoved,this.getAttachDisplay()&&this.DiggerKernel.getLockViewpoint()||(this.synchronizeDiggerViewpoint(),n=!0)),this._divDigger){var a=this.GetOpacity();if(this._diggerPreviousOpacity!==a||0===a&&0!==this._diggerPreviousOpacity){0===a&&0!==this._diggerPreviousOpacity||0!==a&&this._diggerPreviousOpacity,this._diggerPreviousOpacity=a,this._divDigger.style.opacity=a;var s=!0,g="inherit";0===a?(s=!1,g="hidden",this.DiggerKernel._lockUpdateDigger=!0):this.DiggerKernel._lockUpdateDigger=!1,this._toolbar&&(this._toolbar.setRelatedOpacity(a),this._toolbar.setVisible(s&&this._displayUI)),this._divDigger.style&&(this._divDigger.style.visibility=g),this._viewerDigger&&this._viewerDigger.div&&this._viewerDigger.div.style&&(this._viewerDigger.div.style.visibility=g)}}this._toolbar&&this._toolbar.updateVisibilityStyle();var l=this.getRadiusInPixel();if(this._previousRadius!==l&&(i._DiggerDirtyMask|=h.FDirty.Radius,o=!0,this._previousRadius=l,this.DiggerKernel._radiusPx=l),this._divDigger){var c=this.getPositionInPixel();if(void 0===this._previousPosition||this._previousPosition.distanceTo(c)>1e-5){l=this.getRadiusInPixel();this._divDigger.style.left=c.x-l+"px",this._divDigger.style.top=c.y-l+"px",this.getAttachDisplay()||(o=!0),this._previousPosition=c,this.DiggerKernel._positionPx=c,i._DiggerDirtyMask|=h.FDirty.Position}}var p=this.getAttachDisplay();this._previousAttachDisplay!==p&&(this.DiggerKernel.setAttach(p),this.updateAnchorAttach(),this.DiggerKernel.resetTorchInfo(),r=!0,this.DiggerKernel.getLockViewpoint()||(o=!0),i._DiggerDirtyMask|=h.FDirty.Buttons,this._previousAttachDisplay=p);var u=this.getTorchFilter();this._previousTorchFilter!==u&&(this.DiggerKernel.setTorchFilter(this.getTorchFilter()),this.getMode()!==h.EMode.Zoom&&(this.DiggerKernel.resetTorchInfo(),r=!0),this._previousTorchFilter=u),this.getAttachDisplay()&&i._DiggerDirtyMask&(h.FDirty.Position|h.FDirty.Radius|h.FDirty.AnchorPosition|h.FDirty.ViewpointMoved)&&this.updateDiggerAttach();var D=this.getMode();this._previousMode!==D&&(this.DiggerKernel.resetDepth(),this._previousDepthFactor=null,this.DiggerKernel.resetZoom(),this._previousZoomFactor=null,D===d.EDigMode.Linear?this.DiggerKernel.removeOverrides():(D===d.EMode.XRay&&this._previousMode!==d.EMode.Onion||D===d.EMode.Onion&&this._previousMode!==d.EMode.XRay)&&(n=!0),this.DiggerKernel.setMode(D),this._previousMode=D);var _=this.getZoomFactor();this._previousZoomFactor!==_&&(this.DiggerKernel.setZoom(_),r=!0,o=!0,i._DiggerDirtyMask|=h.FDirty.Buttons,this._previousZoomFactor=_);var V=this.getDepthFactor();this._previousDepthFactor!==V&&(this.DiggerKernel.setDepth(V),r=!0,i._DiggerDirtyMask|=h.FDirty.Buttons,this._previousDepthFactor=V);var C=this.getDepthZoom();if(this._previousDepthZoom!==C&&(this.DiggerKernel.setDepthZoom(C),r=!0,o=!0,this._previousDepthZoom=C),i._DiggerDirtyMask&h.FDirty.Radius?this.updateDiggerUI():i._DiggerDirtyMask&h.FDirty.Buttons&&this.updateButtons(),this.getMode()!==h.EMode.XRay&&this.getMode()!==h.EMode.Onion||(n&&(this.DiggerKernel.resetArray(!1),r=!0),this.getAttachDisplay()?i._DiggerDirtyMask&h.FDirty.AnchorPosition&&this.getTorchFilter()&&(this.DiggerKernel.resetTorchInfo(),r=!0):i._DiggerDirtyMask&(h.FDirty.Position|h.FDirty.Radius)&&this.getTorchFilter()&&(this.DiggerKernel.resetTorchInfo(),r=!0)),r&&e.time&&(this.DiggerKernel._lockPickability=!0,this.DiggerKernel.updateDiggerContent(),i._dirtyPickability||(i._dirtyPickability=!0),this._dirtyPickabilityStartTime=e.time),i._dirtyPickability&&e.time-this._dirtyPickabilityStartTime>500&&(this.DiggerKernel._lockPickability=!1,this.DiggerKernel._lockOpacity=!0,this.DiggerKernel.updateDiggerContent(),this.DiggerKernel._lockOpacity=!1,i._dirtyPickability=!1,this._dirtyPickabilityStartTime=null),this.getAttachDisplay()&&!this.DiggerKernel.getLockViewpoint()&&i._DiggerDirtyMask&(h.FDirty.AnchorPosition|h.FDirty.ViewpointMoved)&&(o=!0),o&&this.setDiggerViewOffset(),i._DiggerDirtyMask&&i._DiggerDirtyMask!==h.FDirty.Position||!this.getAttachDisplay()||r||n||o){var b=i.QueryInterface("VCXIReadiness");b&&(this._renderPromise&&this._renderPromise.resolve(),b.clearPromises(),this._renderPromise=UWA.Promise.deferred(),b.registerPromise(this._renderPromise.promise)),this._viewerDigger.render()}i.setDirty(!1),i._DiggerDirtyMask=0}},postUpdate:function(){if(this._renderPromise){this._renderPromise.resolve();var e=this.Modifiable.QueryInterface("VCXIReadiness");e&&e.clearPromises(),delete this._renderPromise}},initDiggerDressup:function(){this.DiggerKernel._experienceBase=this.ExperienceBase,this.DiggerKernel._viewer=this._viewerDigger,this.DiggerKernel._viewer.setSmallRenderTargetPicking(!0),this.DiggerKernel.setMode(this.getMode()),this.DiggerKernel.setZoom(this.getZoomFactor()),this.DiggerKernel.setAttach(this.getAttachDisplay()),this.synchronizeDiggerViewpoint(),this.setDiggerViewOffset(),this.DiggerKernel.updateDiggerContent(!0);var e=this.DiggerKernel._viewer.currentViewpoint;if(e.control){var t=this,i=e.control;e.control._zoom=function(e,r){var n,o;if(i.update(),n=e.y-r.y,1!==(o=1+(n*=.5/this.radiusZoom)*this.zoomSpeed)&&o>0){var a=(1-o)/5;t.zoom(a)}},e.control._mouseWheel=function(e){e.event.preventDefault();var i=UWA.Event.wheelDelta(e.getJSEvent());if(!t.DiggerKernel.getLockViewpoint()){var r=i/15;t.zoom(r)}}}},zoom:function(e){var t;t=this.DiggerKernel.getMode()===h.EMode.Zoom?"Digger.ZoomFactor":"Digger.DepthZoom";var i=this.getProp(t);i+=e,i=Math.min(i,1),i=Math.max(i,0),this.DiggerKernel.getMode()===h.EMode.Zoom?this.DiggerKernel.setZoom(i):this.DiggerKernel.setDepthZoom(i);var r=this.Modifiable,n=new v;n.SetValue(i);var o=r.GetProperty(t).Clone();o.SetPropertyValue(n);var a=new m(this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.getManager("VCXCommandManager"));a.ChangeProperty(r,o),this.ExperienceBase.getManager("VCXCommandManager").Push(a)},setDiggerViewOffset:function(){var e=this.ExperienceBase.getManager("VCXPaperManager"),i=1,r=0;r=this.DiggerKernel.getMode()===h.EMode.Zoom?this.getZoomFactor():this.getDepthZoom(),i=1-(r=Math.min(1,r)),i=Math.max(i,1e-10);var n=this._viewerDigger.div.clientWidth*i,o=this._viewerDigger.div.clientHeight*i,a=0,s=0;if(this.getAttachDisplay()){var g=this.getAnchorVector(),l=null;if((l=this.DiggerKernel.getLockViewpoint()?this._viewerDigger:this._viewer)===this._viewerDigger)this.getPositionInPixel();this.convert3DPointToPxl(g,l);var d=this.convert3DPointToPxl(g,this._viewer);a=e._ViewBoxPx.x-d.x+n/2,s=e._ViewBoxPx.y-d.y+o/2}else{var c=new t.Vector2(this._divDigger.offsetLeft,this._divDigger.offsetTop);a=e._ViewBoxPx.x-c.x-this._viewerDigger.div.offsetLeft-1-n*(1/i-1)/2,s=e._ViewBoxPx.y-c.y-this._viewerDigger.div.offsetTop-1-o*(1/i-1)/2}var p=e._ViewBoxPxSize.x,u=e._ViewBoxPxSize.y;this._viewerDigger.currentViewpoint.setViewOffset({fullWidth:p,fullHeight:u,x:-a,y:-s,width:n,height:o})},projectionTypeChanged:function(){if(!this._viewer||!this._viewerDigger)return!1;var e=this._viewer.currentViewpoint;return this._viewerDigger.currentViewpoint.getProjectionType()!==e.getProjectionType()},synchronizeDiggerViewpoint:function(){this.DiggerKernel._lockSynchronizeDiggerViewpoint=!0;var e=this._viewer.currentViewpoint,t=this._viewerDigger.currentViewpoint;this.projectionTypeChanged()&&(t.setProjectionType(e.getProjectionType()),t.setPixelCulling(e.camera.pixelCulling)),t.setAngle(e.getAngle()),t.setEyePosition(e.getEyePosition().clone()),t.setTarget(e.getTarget().clone()),t.setUpDirection(e.getUpDirection().clone()),this.DiggerKernel._lockSynchronizeDiggerViewpoint=!1},isNodeBuilt:function(){return Boolean(this._divDigger)},doHiRes:function(e,t,i){e=this.ExperienceBase;var r=new p;return r._viewer=this.DiggerKernel._viewer,r._usePaperRatio=!1,r._doHiResImage(e,t,i).then(function(e){return{diggerNode:this,image:e}}.bind(this))},createSnapshot2D:function(e){var t=this.ExperienceBase,i=1.5*this.DiggerKernel._viewer.SCREEN_WIDTH,r=1.5*this.DiggerKernel._viewer.SCREEN_HEIGHT;this.doHiRes(t,i,r).then(function(i){if(i.diggerNode.createUpdatePanel(i.image,1.5),e&&i.diggerNode.Modifiable&&i.diggerNode.Modifiable.GetObject()){var r=new x(t.getManager("VCXScenarioManager"),t.ComponentsMap,t.getManager("VCXCommandManager"));r.ChangeVisibility([i.diggerNode.Modifiable.GetObject()],I.EVisState.Hidden),t.getManager("VCXCommandManager").Do(r)}})},createUpdatePanel:function(e,t){if(!e)return!1;var i=this.ExperienceBase,r=i.getManager("VCXPaperManager").GetMmToPxRatio()*t,o=e.getPixelWidth()/r,a=(e.getPixelHeight(),o/2),s=e.toCanvas().toDataURL("image/jpeg"),h=null,d=this.getProp("Digger.AssociatedPanelID");d&&(h=this._ExperienceBase.ComponentsMap.GetComponentFromID(d));var c=this,p=function(e,t){var r=e.QueryInterface("VCXIModifiable");if(r){var h=c.Modifiable.GetObject(),d=new S(h.GetID());r.OnChangeProperty("Collab.AssociatedObjectID",d);var p=n.dataURLToBlob(s);if(p){var u=window.URL.createObjectURL(p),D=i.getManager("VCXDocManager").BuildPathFromString(u),_=i.getManager("VCXDocManager").AddOrModifyDoc(D);r.OnChangeProperty("Collab.Image.Doc.ID",_);var V=new v;if(V.SetValue(c.GetPropertyValue("Actor.Opacity")),r.OnChangeProperty("Actor.Opacity",V),!t){var C=new y;C.SetValue(l.EBillboardType.Spherical),r.OnChangeProperty("Collab.3D.Paper.Billboard.Type",C);var P=new y;P.SetValue(l.EBodyShape.Circle),r.OnChangeProperty("Collab.Body.Shape",P);var M=new b;M.SetValue(!0),r.OnChangeProperty("Collab.Border.Show",M);var m=new b(!0);r.OnChangeProperty("Collab.Background.Show",m);var w=new b;w.SetValue(!0),r.OnChangeProperty("Collab.Body.Shadow.Show",w)}var E=new b;E.SetValue(c.getAttachDisplay()),r.OnChangeProperty("Collab.Attach.Show",E);var T=c.Modifiable.GetProperty("Actor.Anchor.0").Clone().GetPropertyValue();r.OnChangeProperty("Actor.Anchor.0",T);var A=new f;if(A.SetValue([0]),r.OnChangeProperty("Collab.ListAnchorsIDs",A),!t){var G=new y;G.SetValue(l.ELeadType.Mustache),r.OnChangeProperty("Collab.Attach.LeadType",G);var O=new y;O.SetValue(1e3),r.OnChangeProperty("Collab.3D.Paper.Positioning.Type",O);var R=new v;R.SetValue(i.getManager("VCXDressupManager").GetDressupCount()),r.OnChangeProperty("Collab.3D.Paper.Depth",R);var B=new y;B.SetValue(1),r.OnChangeProperty("Collab.3D.Paper.Size.Control.Type",B)}var k=c.getPosition(),W=new v;W.SetValue(k.x-a),r.OnChangeProperty("Collab.3D.Paper.Paper.Position.X",W);var N=new v;N.SetValue(k.y+a),r.OnChangeProperty("Collab.3D.Paper.Paper.Position.Y",N);var F=new v;F.SetValue(o),r.OnChangeProperty("Collab.Body.Width",F);var K=new v;K.SetValue(o),r.OnChangeProperty("Collab.Body.Height",K);var L=new g(i.getManager("VCXCommandManager"),i.getManager("VCXDressupManager"),i.getManager("VCXScenarioManager"),i.ComponentsMap);L.AddDressups(e),i.getManager("VCXCommandManager").Push(L);d=new S(e.GetID());c.Modifiable.OnChangeProperty("Digger.AssociatedPanelID",d);var z=r.GetProperties();i.getManager("VCXScenarioManager").AddNeutrals(r,z);var Z=new x(i.getManager("VCXScenarioManager"),i.ComponentsMap,i.getManager("VCXCommandManager"));Z.ChangeVisibility([e],I.EVisState.Visible),i.getManager("VCXCommandManager").Do(Z);var U=new X(i.getManager("VCXSelectionManager"));U.SetSelection(e),i.getManager("VCXCommandManager").Do(U),c.ExperienceBase.getManager("VCXContextManager").renderAll({updateInfinitePlane:!0})}}},u=!0;if(h)p(h,u);else if(i.getManager("VCXCAT3DXModelManager")){var D=i.getManager("VCXContextManager").getRootComponent();D&&i.getManager("VCXCAT3DXModelManager").CreateActor("VCXDiggerPanel_Spec","Digger Panel",D).done(function(e){p(e,u=!1)})}else h=i.Factory.BuildComponent("VCXDiggerPanel_Spec"),p(h,u=!1);return!0},SetPropertiesFromPanel:function(e,i,r){var n=this.ExperienceBase.getManager("VCXPaperManager").GetMmToPxRatio();this.setRadius(e.internalSize.x/2+this.Modifiable.GetObject().borderThickness/n),this.setPosition(e.centerInPaper),this.setAttachDisplay(i);var o=(new t.Vector3).getPositionFromMatrix(r),a=new P;a.SetValueFrame((new M).SetValueFromVector(o)),this.setProp(a.GetValue(),"Actor.Anchor.0",new P)},addDiggerPanelEvents:function(){this._WUXEventTokens={};var e=this,t=function(t,i){if(e._toolbar&&e.isVisible())for(var r=0;r<i.length;++r){if(i[r]===e.Modifiable.GetObject()){e._toolbar.setSelected(t),e._toolbar.updateVisibilityStyle();break}}};this._WUXEventTokens.VCX_SELECTION_ADD=i.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_ADD"},function(e){t(!0,e)}),this._WUXEventTokens.VCX_SELECTION_REMOVE=i.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_REMOVE"},function(e){t(!1,e)})},removeDiggerPanelEvents:function(){for(var e in this._WUXEventTokens)this._WUXEventTokens.hasOwnProperty(e)&&this._WUXEventTokens[e]&&(i.unsubscribe(this._WUXEventTokens[e]),this._WUXEventTokens[e]=null)},calcToolbarInfo:function(){var e={},t=this.getPositionInPixel(),i=this.getRadiusInPixel();return e.radiusPx=i+20,e.centerPx={x:t.x,y:t.y},e},createDiggerPanelToolbar:function(){if(!this._toolbar){var e=this._ExperienceBase.getManager("VCXContextManager"),t=this.calcToolbarInfo(),i=[],r=this,n=function(e){i.push({nls:T[e],url:u.getWebappsAssetUrl("VCXWebDigger","icons/"+e+".png"),id:e,type:"element",callback:function(e){r.runCommand(e)},callbackUpdate:function(e,t){r.runUpdateCommand(e,t)}})};this.ExperienceBase.getManager("VCXContextManager").getPlayerMode()||(n("I_VCX_Digger_Hide"),i.push(E.Separator)),n("I_VCX_Digger_Mode_XRay"),n("I_VCX_Digger_Mode_OnionSkin"),n("I_VCX_Digger_Mode_Zoom"),i.push({type:"spacer",spacerStartAngle:300,spacerClockwise:!1}),this.ExperienceBase.getManager("VCXContextManager").getPlayerMode()||(n("I_VCX_Digger_Tool_2DSnapshot"),i.push(E.Separator)),n("I_VCX_Digger_Tool_LockPlanes"),n("I_VCX_Digger_Tool_LockVP"),n("I_VCX_Digger_Tool_Focus");r=this;this._toolbar=new E({experienceBase:this._ExperienceBase,body:e.getUIFrame(),frmWindow:e.getFrameWindow(),title:"Digger",actionBar:e.getActionBar(),heightElem:22,widthElem:22,padding:1,updateOpacity:!1,startAngle:110,clockwise:!0,center:t.centerPx,radius:t.radiusPx,lJsonElement:i}),this.addDiggerPanelEvents()}},deleteDiggerPanelToolbar:function(){this.removeDiggerPanelEvents(),this._toolbar&&(this._toolbar.clear(),this._toolbar=null)}});return Object.defineProperty(A.prototype,"DiggerKernel",{enumerable:!0,get:function(){return this._diggerKernel},set:function(e){this._diggerKernel=e}}),Object.defineProperty(A.prototype,"DiggerUI",{enumerable:!0,get:function(){return this._diggerUI},set:function(e){this._diggerUI=e}}),A}),define("DS/VCXWebDigger/VCXDiggerSGNodeHolder",["DS/VCXWebDressup/VCXDressupSGNodeHolder","DS/VCXWebDigger/VCXDiggerNode"],function(e,t){"use strict";return e.extend({init:function(){},buildSGNode:function(){if(!this._sgNode){var e={name:"Digger",modifiable:this.GetObject().QueryInterface("VCXIModifiable")};this._sgNode=new t(e),this._sgNode.setIcon("../VCXWebDigger/assets/icons/32/I_VCX_Panel_Tree_DiggerLeaf.png")}return this._parent()},unreferenceSGNode:function(){this._sgNode&&(this._sgNode.dispose(),delete this._sgNode)}})});