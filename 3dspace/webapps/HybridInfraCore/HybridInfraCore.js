define("DS/HybridInfraCore/HybridApp",["UWA/Class","DS/WebappsUtils/WebappsUtils","DS/ExperienceKernel/ExperienceKernel","DS/NativeDelegate/NativeDelegateController","DS/NativeDelegate/NativeDelegate"],function(e,t,n,i,a){"use strict";var r=new Array,o=e.singleton({PLATFORM:Object.freeze({IOS:"iOS",ANDROID:"Android"}),init:function(){this._parent(),this._mainAppArgs=null,this._delegateCtrl=new i,this._internalDelegate=new a("internal",this._delegateCtrl,!1),this._delegateCtrl.linkDelegate(this._internalDelegate),this._httpNativeDelegate=null,document.addEventListener("DELEGATE_CONTROLLER",function(e){"ON_NATIVE_DELEGATION_CONNECTION"===e.detail?(console.info("Native connection has been succefully initialized"),HybridApp.executeOnServerReady(window.HybridAppArgs||HybridApp._mainAppArgs)):"ON_NATIVE_DELEGATION_DISCONNECTION"===e.detail&&console.info("Native connection has been lost")}),this._platformName="unknown";var e=navigator.userAgent||navigator.vendor||window.opera;e.match(/iPad/i)||e.match(/iPhone/i)||e.match(/iPod/i)?this._platformName=this.PLATFORM.IOS:e.match(/Android/i)&&(this._platformName=this.PLATFORM.ANDROID),window.localStorage["3DPlay.Enable.NativeScript"]&&(this._mainAppArgs={NativeScript:!0},this.__onPlateformReady()),this.__enableXMLHttpRequestForCrossDomainIssueOnIOS()},addDelegate:function(e){if(!HybridApp._internalDelegate)throw new Error("Internal delegate is missing");return new Promise(function(t,n){HybridApp._internalDelegate._isCpp=!1,HybridApp._internalDelegate.execute("addDelegate",{delegate:e}).then(function(n){console.log(e+" has been correctly added"),HybridApp._delegateCtrl.linkDelegate(new a(e,!1)),t(HybridApp._delegateCtrl._delegateDico[e])},function(i){HybridApp._internalDelegate._isCpp=!0,HybridApp._internalDelegate.execute("addDelegate",{delegate:e}).then(function(n){console.log(e+" has been correctly added"),HybridApp._delegateCtrl.linkDelegate(new a(e,!0)),t(HybridApp._delegateCtrl._delegateDico[e])},function(e){n(e)})})})},removeDelegate:function(e){if(!HybridApp._internalDelegate)throw new Error("Internal delegate is missing");return new Promise(function(t,n){HybridApp._internalDelegate._isCpp=!1,HybridApp._internalDelegate.execute("removeDelegate",{delegate:e}).then(function(n){delete HybridApp._delegateCtrl._delegateDico[e],t(n)},function(i){HybridApp._internalDelegate._isCpp=!0,HybridApp._internalDelegate.execute("removeDelegate",{delegate:e}).then(function(n){delete HybridApp._delegateCtrl._delegateDico[e],t(n)},function(e){n(e)})})})},onDeviceReady:function(e){this._delegateCtrl.isAvailable()&&this._mainAppArgs?e(this._mainAppArgs):r.push(e)},executeOnServerReady:function(e){this._mainAppArgs=e;for(var t=r.length,n=0;n<t;n++){var i=r[n];i&&i(e)}},getPlatformName:function(){return this._platformName},isIOS:function(){return this.PLATFORM.IOS===this._platformName},isAndroid:function(){return this.PLATFORM.ANDROID===this._platformName},getWebappsPath:function(){return window.HybridAppArgs&&window.HybridAppArgs.config&&!0!==window.HybridAppArgs.config.isExternal?this.isIOS()?"/webapps/":this.isAndroid()?"file:///android_asset/":void console.error("UNSUPPORTED PLATFORM "):t.getWebappsBaseUrl()},authentifyAppWith:function(e,t){return new Promise(function(n,i){HybridApp.__getHttpNativeDelegate().then(function(a){var r={passportURL:e,CASTGC:t};a.execute("authentifyWith",r).then(function(e){n(e)},function(e){i(e)})})})},interactiveLogin:function(e){return new Promise(function(t,n){HybridApp.__getHttpNativeDelegate().then(function(i){var a=null!=e?{myAppsURL:e}:{};i.execute("authentify",a).then(function(e){t(e)},function(e){n(e)})})})},selectPlatform:function(){return new Promise(function(e,t){HybridApp.__getHttpNativeDelegate().then(function(n){n.execute("selectPlatform",null).then(function(t){e(t)},function(e){t(e)})})})},logout:function(){return new Promise(function(e,t){HybridApp.__getHttpNativeDelegate().then(function(n){n.execute("logout",null).then(function(t){e(t)},function(e){t(e)})})})},__getHttpNativeDelegate:function(){return new Promise(function(e,t){null===HybridApp._httpNativeDelegate?HybridApp.addDelegate("HttpRequestDelegate").then(function(t){HybridApp._httpNativeDelegate=t,e(HybridApp._httpNativeDelegate)},function(e){console.log("ERROR : Cannot add HttpRequestDelegate",e),t(null)}):e(HybridApp._httpNativeDelegate)})},__enableXMLHttpRequestForCrossDomainIssueOnIOS:function(){this.PLATFORM.IOS===this._platformName&&HybridApp.onDeviceReady(function(e){HybridApp.__getHttpNativeDelegate().then(function(e){XMLHttpRequest.prototype.wrappedOpen=XMLHttpRequest.prototype.open,XMLHttpRequest.prototype.open=function(e,t,n,i){if(!t.contains("https"))return this.wrappedOpen(e,t,n,i);this.method=e,this.url=t.replace("&xrequestedwith=xmlhttprequest","").replace("?xrequestedwith=xmlhttprequest",""),Object.defineProperty(this,"readyState",{value:XMLHttpRequest.OPENED,writable:!0}),Object.defineProperty(this,"status",{value:0,writable:!0}),Object.defineProperty(this,"response",{value:null,writable:!0}),Object.defineProperty(this,"responseText",{value:null,writable:!0}),this.onreadystatechange&&this.onreadystatechange()},XMLHttpRequest.prototype.wrappedSetRequestHeader=XMLHttpRequest.prototype.setRequestHeader,XMLHttpRequest.prototype.setRequestHeader=function(e,t){if(!(this.url&&this.method&&e&&t))return this.wrappedSetRequestHeader(e,t);this.headers||(this.headers={}),this.headers[e]=t},XMLHttpRequest.prototype.wrappedSend=XMLHttpRequest.prototype.send,XMLHttpRequest.prototype.send=function(t){if(!this.url||!this.method)return this.wrappedSend(t);var n={url:encodeURI(this.url),method:this.method||"GET"};t&&(n.data="object"==typeof t?JSON.stringify(t):t),this.headers&&(n.headers=JSON.stringify(this.headers)),this.readyState=XMLHttpRequest.HEADERS_RECEIVED,this.onreadystatechange&&this.onreadystatechange();var i=this;e.execute("httpRequest",n).then(function(e){if(i.status=e.statusCode,i.readyState=XMLHttpRequest.DONE,i.responseType=e.responseType,e.responseType&&"arraybuffer"===i.responseType){var t=new Uint8Array(atob(e.data).split("").map(function(e){return e.charCodeAt(0)}));i.response=t.buffer}else e.responseType&&"json"===i.responseType?(i.response=JSON.stringify(e.data),i.responseText=i.response):(i.response=e.data,i.responseText=i.response);e.responseHeaders&&(i.nativeResponseHeaders=e.responseHeaders),i.onreadystatechange?i.onreadystatechange():i.onload?i.onload():i.onloadend?i.onloadend():console.error("[Native HTTP Response ERROR : neither onreadystatechange or onload function are implemented")},function(e){i.status=e.statusCode,i.readyState=XMLHttpRequest.DONE,i.response=e.data,i.responseText=e.data,i.onreadystatechange?i.onreadystatechange():i.onerror?i.onerror():i.onloadend?i.onloadend():i.onabort?i.onloadend():console.error("[Native HTTP Response ERROR : neither onreadystatechange or onload function are implemented")})},XMLHttpRequest.prototype.wrappedGetResponseHeader=XMLHttpRequest.prototype.getResponseHeader,XMLHttpRequest.prototype.getResponseHeader=function(e){return this.nativeResponseHeaders&&e?this.nativeResponseHeaders[e]:this.wrappedGetResponseHeader(e)}})})},__onPlateformReady:function(){this._delegateCtrl.onConnection()},__postTextMsgToJS:function(e){this._delegateCtrl.onText(e)},__postBinaryMsgToJS:function(e){this._delegateCtrl.onBinary(e)},__postTextMsgToNative:function(e){this.PLATFORM.IOS===this._platformName?window.webkit.messageHandlers.notification.postMessage(e):this.PLATFORM.ANDROID===this._platformName&&JS2Native.postMessage(e)},__postBinaryMsgToNative:function(e){this.PLATFORM.IOS===this._platformName?window.webkit.messageHandlers.notification.postMessage(e):this.PLATFORM.ANDROID===this._platformName&&JS2Native.postMessage(e)}});return UWA.namespace("HybridApp",o,window,!0),UWA.namespace("HybridApp",o,window.top,!0)});