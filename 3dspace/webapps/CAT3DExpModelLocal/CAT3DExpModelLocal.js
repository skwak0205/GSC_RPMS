define("DS/CAT3DExpModelLocal/CAT3DXModelFactoryLocal",["UWA/Core","UWA/Promise","DS/CAT3DExpModel/CAT3DXModelFactory","DS/CAT3DExpModel/CAT3DXJSONReader","DS/CAT3DExpModel/XCTExpPathOfIds","DS/CAT3DExpModel/XCTExpAsset"],function(e,t,r,n,a,i){"use strict";return r.extend({init:function(e){this._parent(e)},CreateExperience:function(e){return this._createObject("CXPExperience_Spec",e).then(function(e){return t.resolve(e)})},LoadExperience:function(t,r,a){var i=this;return t.resolveLinkAsStream(r).then(function(t){var r=e.Promise.deferred(),n=new FileReader;return n.onloadend=function(t){var n=JSON.parse(t.target.result);e.is(n)||r.reject(new Error("invalid string")),r.resolve(n)},n.readAsText(t),r.promise}).then(function(e){return n.read(e,i._objectBuilder,i._expDataObjectMap,i._expCoreLinkManager,{linkContext:t})}).then(function(t){return e.is(t)&&"CXPExperience_Spec"===t.GetType()?e.Promise.resolve(t):e.Promise.reject(new Error("Invalid JSON"+a))})},IsExperienceStarted:function(){return e.Promise.resolve({isExperienceStarted:!1})},RetrieveExperienceFromServer:function(){return e.Promise.reject(new Error("Cant retrieve experience from server in local mode"))},CloseExperience:function(){var e=this.GetExperience();return this._removeObject(e)},SetVariableValues:function(e,t,r){return e._SetValueByNameSession(t,r)},CreateActor:function(e,t,r){return this._createObject(e,t,r,"actors")},CreatePath:function(t,r,n,a,i){var c;r!==this.GetExperience()&&i!==r&&console.error("Not implemented, Use father as referential");var o=this;return this._createObject("CXPVirtualPathActor_Spec",t,r,"actors").then(function(t){c=t;var r=[];r.push(t._SetValueByNameSession("interpolationType",a||0));for(var i=0;i<n.length;i++)r.push(o._createPointOfPath(t,n[i]));return e.Promise.all(r)}).then(function(){return c})},_createPointOfPath:function(e,t){return this._createObject("CXPPointOfPath_Spec",null,e,"pointslist").then(function(e){return e._SetValueByNameSession("position",[t.x,t.y,t.z])})},CreateCityActorExternal:function(e,t,r,n){return this._createObject("CIDAsset_Spec",e,t,"actors").then(function(e){return e._setAssetSession(n,null,i.AssetStatus.StatusOK),e})},CreateCityActorInternal:function(e,t,r,n){return this._createObject(e,t,r,"actors").then(function(e){return e._setAssetSession(n,null,i.AssetStatus.StatusOK),e})},DeleteActor:function(e){return this._removeObject(e)},CreateBehavior:function(e,t,r){return this._createObject(e,t,r,"behaviors")},DeleteBehavior:function(e){return this._removeObject(e)},CreateScenario:function(e){var t=this.GetExperience();return this._createObject("CXPWizardedScenario_Spec",e,t,"scenarios")},CreateAct:function(e,t){return this._createObject("CXPAct_Spec",e,t,"acts")},CreateParagraph:function(e,t){return this._createObject("CXPParagraph_Spec",e,t,"paragraphs")},CreateSentence:function(e,t){return this._createObject("CXPSentence_Spec",e,t,"sentences")},CreateBlock:function(e,t,r){var n=r?"sensorBlocks":"driverBlocks";return this._createObject("CXPBlock_Spec",e,t,n)},CreateURLResource:function(e,r){var n=this.GetExperience();return this._createObject("CXPURLResource_Spec",e,n,"resources").then(function(e){return e._setAssetSession(r,null,i.AssetStatus.StatusOK),t.resolve(e)})},DeleteResource:function(e){return this._removeObject(e)},_extensionsTypesMap:{png:"CXPPictureResource_Spec",jpg:"CXPPictureResource_Spec"},CreateUIButton:function(e){return this._createUIActor("UIButton",e)},CreateUIText:function(e){return this._createUIActor("UIText",e)},CreateUIImage:function(e){return this._createUIActor("UIImage",e)},CreateUITextField:function(e){return this._createUIActor("UITextField",e)},CreateUIColorPicker:function(e){return this._createUIActor("UIColorPicker",e)},CreateUISlider:function(e){return this._createUIActor("UISlider",e)},CreateUICameraViewer:function(e){return this._createUIActor("UICameraViewer",e)},CreateUIWebViewer:function(e){return this._createUIActor("UIWebViewer",e)},CreateUIGalleryMenu:function(e){return this._createUIActor("UIGalleryMenu",e)},CreateUIGalleryImage:function(e){return this._createUIActor("UIGalleryImage",e)},CreateUIGalleryProduct:function(e){return this._createUIActor("UIGalleryProduct",e)},CreateUIGalleryViewpoint:function(e){return this._createUIActor("UIGalleryViewpoint",e)},_createUIActor:function(e,t){var r=this.GetExperience();return this._createObject(e,t,r,"actors",!0)},CreateGalleryItem:function(e,t){return this._createObject("CXPDataItem_Spec",e,t,"items")},CreateVariable:function(e,t,r,n,a,i){return e._AddVariableSession(t,r,a?0:1,n,null,t).then(function(){return e._SetValueByNameSession(t,i)})},CreateObject:function(e,t,r,n){return this._createObject(e,t,r,n)},_createObject:function(t,r,a,i,c){var o,s=this._getUUPathOfIds(a,i),u=this;return this._retrieveJSON(t,c).then(function(e){return u._replaceJSONIds(e,s),n.read(e,u._objectBuilder,u._expDataObjectMap,u._expCoreLinkManager)}).then(function(t){var r;return o=t,a?(1===a.GetVariableMaxNumberOfValues(i)?r=t:(r=a.GetValueByName(i),a.IsLocalVariable(i)||(r=r.slice()),r.push(t)),a._SetValueByNameSession(i,r)):e.Promise.resolve()}).then(function(){return o._SetValueByNameSession("_varName",r||t)}).then(function(){return o})},_getUUPathOfIds:function(t,r){var n;return(n=t?t._GetVariablePathOfIds(r):new a).pushId(e.Utils.getUUID()),n},_retrieveJSON:function(t,r){var n;n=r?"text!CAT3DExpModelLocal/assets/uiactors/"+t+".json":"text!CAT3DExpModelLocal/assets/prototypes/"+t+".json";var a=e.Promise.deferred();return require([n],function(e){a.resolve(JSON.parse(e))},function(){a.reject(new Error("FactoryLocal : Cant retrieve "+t+".json"))}),a.promise},_replaceJSONIds:function(t,r){if(t&&t.IDs&&(t.IDs.PathOfIds=r.toArray(),t.Variables))for(var n=0;n<t.Variables.length;n++){var a=t.Variables[n].IDs.PathOfIds.pop(),i=r.clone();if(i.pushId(a),t.Variables[n].IDs.PathOfIds=i.toArray(),t.Variables[n].Value)for(var c=0;c<t.Variables[n].Value.length;c++)if("object"==typeof t.Variables[n].Value[c]){var o=i.clone();o.pushId(e.Utils.getUUID()),this._replaceJSONIds(t.Variables[n].Value[c],o)}}},_removeObject:function(e){return this._objectBuilder._removeObject(e)}})});