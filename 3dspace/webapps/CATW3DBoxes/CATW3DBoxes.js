/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CATW3DBoxes/CATW3DBoxController",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CoreEvents/Events","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATWebUXPreferences/CATWebUXPreferencesManager"],function(e,t,n,i,r,o,a,s){"use strict";var l=e.extend({init:function(e){var l=e||{};this._parent(l);var c,u,d,f,h=this,p=[],m=[],v=l.ctxViewer,g=!1,b=!0,x=null,w=null,y=null,V=function(e){return a.isPLMNode(e)},C=function(e){if(1===p.length){x=e.pathElement;var t=v.getFrameWindow().getContextualUIManager();if(t.hideContextualMenus(),x){var i=[];V(x.getLastElement(!0))&&V(x.getParentPath().getLastElement(!0))&&i.push({name:"CATW3DBoxesLevelSelectorStr",line:1,hdr_list:["LevelSelectorHdr"]});for(var r=!1,o=n.get(),a=0;a<o.length;a++){var s=o[a].pathElement;if(s=y.getMoveReferent(s)){var l=s.getMatrix();if(1!==l.elements[0]||1!==l.elements[5]||1!==l.elements[10]||1!==l.elements[15]||0!==l.elements[1]||0!==l.elements[2]||0!==l.elements[3]||0!==l.elements[4]||0!==l.elements[6]||0!==l.elements[7]||0!==l.elements[8]||0!==l.elements[9]||0!==l.elements[11]||0!==l.elements[12]||0!==l.elements[13]||0!==l.elements[14]){r=!0;break}}}r&&i.push({name:"CATW3DBoxesIdentityPositionStr",line:1,hdr_list:["CATW3DSetIdentityPositionHdr"]}),i.length>0&&t.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:i}},context:v.getCommandContext?v.getCommandContext():null,workbenchName:"CATW3DCommands",module:"CATW3DCommands",cmdPrefix:""}]})}}},S=function(){for(var e=0;e<p.length;e++)p[e].setVisibleFlag(!1);v.getViewer().render()},A=function(){for(var e=0;e<p.length;e++)p[e].setVisibleFlag(!0);v.getViewer().render()},B=function(e){if(u){var i=v.getViewer(),r=i.getVisibleSpace(),o=e.getBoundingBox(null,i,r?"visibleSpace":"invisibleSpace");if(o&&!o.isNaN()){var a=e.getWorldMatrix(i),s=new t.Vector3(o.min.x,o.min.y,o.min.z),l=new t.Vector3(o.max.x,o.min.y,o.min.z),h=new t.Vector3(o.min.x,o.max.y,o.min.z),m=new t.Vector3(o.min.x,o.min.y,o.max.z),x=new t.Vector3(l.x-s.x,l.y-s.y,l.z-s.z),w=new t.Vector3(h.x-s.x,h.y-s.y,h.z-s.z),y=new t.Vector3(m.x-s.x,m.y-s.y,m.z-s.z),V=new u({pathElement:e,edgeMaterial:f,cornerPoint:s,fstAxis:x,sndAxis:w,thdAxis:y,matrix:a,rootBagPath:v.getRootBagPath().clone(),viewer:i});V.show(),p.push(V);var B={};B.onClick=V.subscribe("onBoxClick",C),B.onBeginManipulate=V.subscribe("onBoxBeginManipulate",S),B.onEndManipulate=V.subscribe("onBoxEndManipulate",A),c.boxTokens.push(B)}}else require(["DS/CATW3DBoxes/CATW3DBoxManipulator"],function(e){if(u=e,b&&g)for(var t=n.get(),i=0;i<t.length;i++)d(t[i].pathElement)})};d=function(e){if(p.length<50){var t=e?y.getMoveReferent(e):null;!t||p.some(function(e){return t.isEqual(e.getAssociatedPath())})||B(t)}};var M=function(e){g&&d(e.pathElement)},T=function(e,t){if(t&&g)h.refreshBoxes();else if(!t&&(m=[],p.length&&e&&Array.isArray(e)))for(var n=[],i=0;i<e.length;i++){var r=e[i];if(r=y.getMoveReferent(r))for(var o=0;o<p.length;o++){var a=p[o].getAssociatedPath();r.isAParentOf(a)&&-1===n.indexOf(o)&&(p[o].setVisibleFlag(!1),n.push(o),m.push(a))}}},D=function(e){c&&c.boxTokens&&c.boxTokens[e]&&(p[e].unsubscribe(c.boxTokens[e].onClick),p[e].unsubscribe(c.boxTokens[e].onBeginManipulate),p[e].unsubscribe(c.boxTokens[e].onEndManipulate),c.boxTokens.splice(e,1)),p[e].hide(),p.splice(e,1)},E=function(e){if(g&&p&&0!==p.length){var t,i,r=[];if(e){for(t=0;t<p.length;t++)if((i=y.getMoveReferent(e.pathElement))&&i.isEqual(p[t].getAssociatedPath())){r.push(t);break}}else{var o=n.get();for(t=0;t<p.length;t++){for(var a=!0,s=0;s<o.length;s++)if(i=o[s].pathElement,(i=y.getMoveReferent(i))&&i.isEqual(p[t].getAssociatedPath())){a=!1;break}a&&r.push(t)}}r.sort(function(e,t){return e-t});for(var l=r.length-1;l>=0;l--)D(r[l])}},P=function(){if(!c){c={boxTokens:[]},w=i.giveMoveManager({context:v}),y=r.getMoveReferentManager({context:v}),c.onAdd=n.onAdd(M),c.onRemove=n.onRemove(E),c.onEmpty=n.onEmpty(E),c.Move=w?w.subscribe("Move",function(e){if(g){var t=[];e.objectsMoved.forEach(function(e){e.path&&t.push(e.path)}),t.length&&T(t,!1)}}):null,c.MoveEnd=w?w.subscribe("MoveEnd",function(){if(g){for(var e=0;e<m.length;e++){for(var t=!0,n=0;n<p.length;n++)if(m[e].isEqual(p[n].getAssociatedPath())&&(t=!1,!p[n].getVisibleFlag())){var i=p[n].getAssociatedPath().getWorldMatrix(v.getViewer());p[n].setMatrix(i),p[n].setVisibleFlag(!0),v.getViewer().render()}t&&B(m[e])}m=[]}}):null,c.onRootRemoved=v.subscribe({event:"onRootRemoved"},function(e){g&&T([e.path],!0)}),c.onRootDetached=v.subscribe({event:"onRootDetached"},function(e){g&&T([e.path],!0)}),c.onHide=v.subscribe({event:"onHide"},function(e){g&&T(e.paths,!0)}),c.onShow=v.subscribe({event:"onShow"},h.refreshBoxes),c.onEndMatriceUpdate=v.subscribe({event:"onEndMatriceUpdate"},h.refreshBoxes),c.swapVisibleSpace=v.getViewer()&&v.getViewer().onSwapVisibleSpace?v.getViewer().onSwapVisibleSpace(h.refreshBoxes):null,c.onPreferencesChanged=s.getPreferenceManager({context:v.getFrameWindow()}).subscribe("onPreferencesChanged",function(e){if(e&&e.some(function(e){return"defaultMoveReferent"===e.id})){for(var t=p.length-1;t>=0;t--)D(t);for(var i=n.get(),r=0;r<i.length;r++)d(i[r].pathElement)}});var e=!1;c.VISU=o.subscribe({event:"/VISU/"},function(t){var n;if(g&&p.length)if("@onViewpointBeginMove"===t.eventType)e=!0;else if("@onViewpointChange"===t.eventType){if(e){for(n=0;n<p.length;n++)p[n].setVisibleFlag(!1);v.getViewer().render(),e=!1}}else if("@onViewpointEndMove"===t.eventType){for(n=0;n<p.length;n++)p[n].setVisibleFlag(!0);v.getViewer().render(),e=!1}})}},I=function(){if(c){c.VISU&&o.unsubscribe(c.VISU),c.onShow&&v.unsubscribe(c.onShow),c.onHide&&v.unsubscribe(c.onHide),c.onRootDetached&&v.unsubscribe(c.onRootDetached),c.onRootRemoved&&v.unsubscribe(c.onRootRemoved),c.onEndMatriceUpdate&&v.unsubscribe(c.onEndMatriceUpdate),c.MoveEnd&&w&&w.unsubscribe(c.MoveEnd),c.Move&&w&&w.unsubscribe(c.Move),c.onAdd&&n.unsubscribe(c.onAdd),c.onRemove&&n.unsubscribe(c.onRemove),c.onEmpty&&n.unsubscribe(c.onEmpty),c.swapVisibleSpace&&v.getViewer()&&v.getViewer().unsubscribe(c.swapVisibleSpace),c.onPreferencesChanged&&s.getPreferenceManager({context:v.getFrameWindow()}).unsubscribe(c.onPreferencesChanged);for(var e=p.length-1;e>=0;e--)D(e);m=[],c=null}};this.setActiveState=function(e){if(g!==e&&(g=e,b))if(g){P(),f||(f=new t.LineBasicMaterial({color:16744990,opacity:1}));for(var i=n.get(),r=0;r<i.length;r++)d(i[r].pathElement)}else I(),f=null},this.displayBoxes=function(e){if(b!==e)if((b=e)&&g){P();for(var t=n.get(),i=0;i<t.length;i++)d(t[i].pathElement)}else I()},this.getDisplayState=function(){return b},this.clearController=function(){this.setActiveState(!1),this.displayBoxes(!1),p=c=m=v=w=y=x=h=null},this.refreshBoxes=function(){var e;if(b&&g){for(e=p.length-1;e>=0;e--)D(e);var t=n.get();for(e=0;e<t.length;e++)d(t[e].pathElement)}}}}),c=[];return e.singleton({init:function(){},getBoxController:function(e){var t;if(e&&e.context){for(var n=0;n<c.length;n++)if(c[n].context===e.context){t=c[n].boxController;break}if(!t){var i=new l({ctxViewer:e.context});c.push({context:e.context,boxController:i}),t=i}}return t},unregisterBoxController:function(e){if(e&&e.context)for(var t=0;t<c.length;t++)if(c[t].context===e.context){c[t].boxController.clearController(),c.splice(t,1);break}}})}),define("DS/CATW3DBoxes/CATW3DBoxManipulator",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/ModelEvents","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/Manipulators/Manipulator","DS/CATW3DAnims/CATW3DAnimation","DS/SceneGraphOverrides/SceneGraphOverrideSet"],function(e,t,n,i,r,o,a,s,l){"use strict";var c=a.extend({init:function(e){var t=e||{};this._parent(t),this._manipulation=0,this.setExclusive(!0)},PrimaryPointerClick:function(e,t,n){this._parent(e,t,n);var i={element:e,event:t,intersection:n};this.publish("BoxClick",i)},BeginManipulate:function(e,t,n){this._parent(e,t,n),this._manipulation=0},Manipulate:function(e,t,n){if(this._parent(e,t,n),this._manipulation++,3===this._manipulation){var i={element:e,event:t,intersection:n};this.publish("BoxBeginManipulate",i)}},EndManipulate:function(e,t,n){if(this._parent(e,t,n),this._manipulation>3){var i={element:e,event:t,intersection:n};this.publish("BoxEndManipulate",i)}},BeginPreactivate:function(e,t,n){this._parent(e,t,n);var i={element:e,event:t,intersection:n};this.publish("BoxBeginPreactivate",i)},EndPreactivate:function(e,t,n){this._parent(e,t,n);var i={element:e,event:t,intersection:n};this.publish("BoxEndPreactivate",i)}});return e.extend({init:function(e){var a=e||{};this._parent(a);var u=a.fstAxis,d=u.length(),f=a.sndAxis,h=f.length(),p=a.thdAxis,m=p.length(),v=a.cornerPoint,g=a.pathElement,b=a.matrix||new t.Matrix4,x=a.rootBagPath,w=a.viewer,y=new n;y.name="boxManipulatorNode",y.setNoZ(!0),y.setVisibilityInTree(!1),y.setVisibility(Boolean(w.getVisibleSpace())),y.side=t.DoubleSide,y.exludeFromBounding(!0),y._getExcludeFromCSO=function(){return!0};var V=new n;V.name="lineicPreviewRepsBag",V.setPickable(r.PICKTHROUGH);var C=new n;C.name="boxPreviewNodeBag",C.setPickable(r.PICKTHROUGH);var S=null,A=new i,B=!1,M=new t.MeshBasicMaterial({side:t.DoubleSide,color:16744448,transparent:!0}),T=a.edgeMaterial,D=!1,E=null,P=null,I=null,F=new r.VertexComponent;F.component=r.VertexComponentEnum.POSITION,F.nbVertices=2,F.nbValuesPerVertex=3,F.format=r.DataTypeEnum.FLOAT,F.cardinality=0,F.bufferId=0,F.indices=new r.IndexArray,F.indices.format=r.DataTypeEnum.UINT,F.indices.bufferId=1,F.indices.offset=0;var O=new r.Buffer;O.indexBuffer=!0,O.size=2,O.format=r.DataTypeEnum.UINT,O.dimension=1,O.data=new Uint16Array(2),O.data[0]=0,O.data[1]=1;var k=new r.FillAttributes,R=new r.LineAttributes,W=new r.PointAttributes,U=null,z=null,N=null,_=null,L=null,H=function(e,t){if(e){e.material&&(e.material.map&&t&&e.material.map.dispose(),e.material.dispose());for(var n=e.children.length-1;n>=0;n--)H(e.children[n]);e.removeChildren()}},G=function(e){if(!E&&x){E=new l(x.externalPath[0]),w.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(E);var t=E.createOverride(g);t.setColor(16744448,!0),e&&(t.setOpacity(1,!0),(t=E.createOverride(x)).setColor("white",!1),t.setOpacity(.1,!1))}},q=function(){E&&(w.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(E),E=null)},J=function(e,n){var i=new r.PrimitiveGroup;i.fillAttr=k,i.lineAttr=R,i.pointAttr=W,i.noz=!1;var a=new r.Buffer;a.size=6,a.component=r.VertexComponentEnum.POSITION,a.format=r.DataTypeEnum.FLOAT,a.dimension=3,a.data=new Float32Array(6),i.addBuffer(0,a),i.addBuffer(1,O);var s=a.data,l=0;s[l++]=e.x,s[l++]=e.y,s[l++]=e.z;var c=(new t.Vector3).copy(e).add(n);s[l++]=c.x,s[l++]=c.y,s[l++]=c.z;var u=new r.Primitive;u.nbIndices=2,u.connectivity=r.ConnectivityTypeEnum.LINE_STRIP,u.attr={fill:k,line:R,point:W},u.material=T,u.addVertexComponent(F),i.addPrimitive(u);var d=o.createMeshNode(i);return d.setSSAO(!1),d.setShadow(!1,!1),d.excludeFromCSO(!0),d.excludeFromHighlight(!0,!0),d},K=function(e,n,i,a){var s=new r.PrimitiveGroup;s.noz=!1,s.fillAttr=k,s.lineAttr=R,s.pointAttr=W;var l=new r.Buffer;l.size=12,l.component=r.VertexComponentEnum.POSITION,l.format=r.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(12),N||((N=new r.Buffer).indexBuffer=!0,N.size=4,N.format=r.DataTypeEnum.UINT,N.dimension=1,N.data=new Uint16Array(4),N.data[0]=0,N.data[1]=1,N.data[2]=3,N.data[3]=2),_||((_=new r.Buffer).size=3,_.component=r.VertexComponentEnum.NORMAL,_.format=r.DataTypeEnum.FLOAT,_.dimension=3,_.data=new Float32Array(3),_.data[0]=0,_.data[1]=0,_.data[2]=1),L||((L=new r.Buffer).indexBuffer=!0,L.size=4,L.format=r.DataTypeEnum.UINT,L.dimension=1,L.data=new Uint16Array(4),L.data[0]=0,L.data[1]=0,L.data[2]=0,L.data[3]=0),s.addBuffer(0,l),s.addBuffer(1,N),s.addBuffer(2,_),s.addBuffer(3,L);var c=l.data,u=0;c[u++]=e.x,c[u++]=e.y,c[u++]=e.z;var d=(new t.Vector3).copy(e).add(n);c[u++]=d.x,c[u++]=d.y,c[u++]=d.z,d=(new t.Vector3).copy(e).add(n).add(i),c[u++]=d.x,c[u++]=d.y,c[u++]=d.z,d=(new t.Vector3).copy(e).add(i),c[u++]=d.x,c[u++]=d.y,c[u++]=d.z;var f=new r.Primitive;f.nbIndices=4,f.connectivity=r.ConnectivityTypeEnum.TRIANGLE_STRIP,M.opacity=a/10,M.needsUpdate=!0,f.material=M,U||((U=new r.VertexComponent).component=r.VertexComponentEnum.POSITION,U.nbVertices=4,U.nbValuesPerVertex=3,U.format=r.DataTypeEnum.FLOAT,U.cardinality=0,U.bufferId=0,U.indices=new r.IndexArray,U.indices.format=r.DataTypeEnum.UINT,U.indices.bufferId=1,U.indices.offset=0),z||((z=new r.VertexComponent).component=r.VertexComponentEnum.NORMAL,z.nbVertices=4,z.nbValuesPerVertex=3,z.format=r.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=2,z.indices=new r.IndexArray,z.indices.format=r.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=0),f.addVertexComponent(U),f.addVertexComponent(z),s.addPrimitive(f);var h=o.createMeshNode(s);return h.setSSAO(!1),h.setShadow(!1,!1),h.excludeFromCSO(!0),h.excludeFromHighlight(!0,!0),h},X=function(e,n){for(var i=0;i<6;i++){var r,o,a,s,l,c,g;switch(i){case 0:r=v,o=f,a=u,s=h,l=d;break;case 1:r=v,o=p,a=f,s=m,l=h;break;case 2:r=v,o=u,a=p,s=d,l=m;break;case 3:r=(new t.Vector3).copy(v).add(u),o=f,a=p,s=h,l=m;break;case 4:r=(new t.Vector3).copy(v).add(f),o=p,a=u,s=m,l=d;break;default:r=(new t.Vector3).copy(v).add(p),o=u,a=f,s=d,l=h}if(s>=.001&&l>=.001)if(1!==n){var b=.5*n;g=(new t.Vector3).copy(r);var x=(new t.Vector3).copy(o).setLength(s*b);c=J(g,x),e.addChild(c),g=(new t.Vector3).copy(r).add(o),x=(new t.Vector3).copy(a).setLength(l*b),c=J(g,x),e.addChild(c),g=(new t.Vector3).copy(r).add(o).add(a),x=(new t.Vector3).copy(o).setLength(s*b).multiplyScalar(-1),c=J(g,x),e.addChild(c),g=(new t.Vector3).copy(r).add(a),x=(new t.Vector3).copy(a).setLength(l*b).multiplyScalar(-1),c=J(g,x),e.addChild(c)}else c=J(r,o),e.addChild(c),g=(new t.Vector3).copy(r).add(o),c=J(g,a),e.addChild(c)}},j=function(e){M.opacity=Math.round(e/12)/100,M.needsUpdate=!0;for(var t=e/(100/(V.children.length-1)),n=0;n<V.children.length;n++)n===t?(V.children[n].setVisibility(Boolean(w.getVisibleSpace())),V.children[n].setVisibilityFree(!1)):(V.children[n].setVisibility(!1),V.children[n].setVisibilityFree(!0));w.render()},Z=function(){for(var e=.5,i=null,r=0;r<6;r++)(i=new n).setVisibility(!1),i.setVisibilityFree(!0),X(i,e),V.addChild(i),e=Math.round(10*e+1)/10;y.addChild(V),function(e,n){if(e)for(var i=0;i<6;i++){var r=null,o=null,a=null;switch(i){case 0:r=v,o=f,a=u;break;case 1:r=v,o=p,a=f;break;case 2:r=v,o=u,a=p;break;case 3:r=(new t.Vector3).copy(v).add(u),o=f,a=p;break;case 4:r=(new t.Vector3).copy(v).add(f),o=p,a=u;break;default:r=(new t.Vector3).copy(v).add(p),o=u,a=f}e.addChild(K(r,o,a,n))}}(C,16744448),y.addChild(C)},Q=function(e){var t={pathElement:g,position:e.event.from[0].currentPosition};A.publish({event:"onBoxClick",data:t})},Y=function(){D=!0,B=!1,G(!0),P.animate(1),w.currentViewpoint.getControl()._changeState(3),(I={}).eyePosition=w.currentViewpoint.getEyePosition(),I.upDirection=w.currentViewpoint.getUpDirection(),I.sightDirection=w.currentViewpoint.getSightDirection(),I.distanceToTarget=w.currentViewpoint.getTargetDistance(),A.publish({event:"onBoxBeginManipulate",data:{pathElement:g}})},$=function(){q(),w.setCursor("auto"),D=!1,P.animate(0),w.currentViewpoint.moveTo({eyePosition:I.eyePosition,upDirection:I.upDirection,sightDirection:I.sightDirection,distanceToTarget:I.distanceToTarget,duration:100}),I=null,A.publish({event:"onBoxEndManipulate",data:{pathElement:g}})},ee=function(){D||(w.setCursor("pointer"),B=!0,G(!1),P.animate(1))},te=function(){D||(w.setCursor("auto"),B=!1,q(),P.animate(0))};this.show=function(){X(y,.5),w.addNode(y,!1),P=new s({animationTime:5,nbSteps:5,onBeforeFirstAnimation:Z,onAnimation:j,onAnimationEnd:function(){j(D||B?100:0)}}),S||((S=new c).subscribe("BoxClick",Q),S.subscribe("BoxBeginManipulate",Y),S.subscribe("BoxEndManipulate",$),S.subscribe("BoxBeginPreactivate",ee),S.subscribe("BoxEndPreactivate",te),S.linkToNode(y)),y.setMatrix(b),w.render()},this.hide=function(){q(),y.setVisibility(!1),y.setVisibilityFree(!0),S=null,H(y,!0),w.removeNode(y)},this.setMatrix=function(e){b.copy(e),y.setMatrix(b)},this.setVisibleFlag=function(e){!e&&D||(e?(y.setVisibility(Boolean(w.getVisibleSpace())),y.setVisibilityFree(!1)):(y.setVisibility(!1),y.setVisibilityFree(!0)))},this.getVisibleFlag=function(){return!!y&&!y.visibilityFree},this.getAssociatedPath=function(){return g},this.subscribe=function(e,t){return"onBoxClick"===e||"onBoxBeginManipulate"===e||"onBoxEndManipulate"===e?A.subscribe({event:e},t):void 0},this.unsubscribe=function(e){A.unsubscribe(e)}}})}),define("DS/CATW3DBoxes/CATW3DBoxesCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/CATW3DBoxes/CATW3DBoxController","DS/PADUtils/PADContext"],function(e,t,n){"use strict";return e.extend({init:function(e){this._parent(e,{});var i=this,r=null,o=this.onStateChange(function(){r||(r=n.get()),t.getBoxController({context:r}).displayBoxes(i.getState()),localStorage.setItem("CATW3DBoxesCmd",i.getState()?"true":"false")}),a=this._destroy;this._destroy=function(){r&&t.unregisterBoxController({context:r}),i._modelEvents.unsubscribe(o),a.call(i)};var s=localStorage.getItem("CATW3DBoxesCmd");s="false"!==s,this.setState(s,!0)},_destroy:function(){this._parent()}})});