define("DS/DMUMeasurable/DMUToolsMaths",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t={isZero:function(e){return Math.abs(e)<.001},areEqual:function(e,t,i,n){var o=void 0!==n?n:.001,r=!0,a=void 0!==i?i:"float";switch(a){case"float":r=Math.abs(e-t)<o;break;case"Vector3":r=Math.abs(e.x-t.x)<o&&Math.abs(e.y-t.y)<o&&Math.abs(e.z-t.z)<o;break;case"Matrix4":for(var s=0;s<16&&r;s++)r=Math.abs(e.elements[s]-t.elements[s])<o;break;default:window.console.log("areEqual used with unknown type: "+a)}return r},isLessOrEqual:function(e,t,i){return e<=t+(void 0!==i?i:.001)},isLessThan:function(e,t,i){return e<t+(void 0!==i?i:.001)},computeMatrixFromLines:function(i,n,o,r){var a,s,l=n.clone().normalize();return void 0!==o?(s=(new e.Vector3).crossVectors(l,o),a=(new e.Vector3).crossVectors(s,l)):void 0!==r?(a=(new e.Vector3).crossVectors(l,r),s=(new e.Vector3).crossVectors(l,a)):(a=(new e.Vector3).crossVectors(l,new e.Vector3(0,0,1)),t.isZero(a.length())&&(a=(new e.Vector3).crossVectors(l,new e.Vector3(0,1,0))),s=(new e.Vector3).crossVectors(l,a)),new e.Matrix4(l.x,a.x,s.x,i.x,l.y,a.y,s.y,i.y,l.z,a.z,s.z,i.z,0,0,0,1)},computeTransformationBetweenTwoLines:function(i,n,o,r){var a={returnCode:1};if(i&&n&&o&&r){var s=n.clone().normalize(),l=r.clone().normalize(),c=(new e.Matrix4).makeTranslation(-i.x,-i.y,-i.z),u=(new e.Vector3).crossVectors(s,l);t.isZero(u.length())&&(u=(new e.Vector3).crossVectors(s,new e.Vector3(1,0,0)),t.isZero(u.length())&&(u=(new e.Vector3).crossVectors(s,new e.Vector3(0,1,0))));var p=Math.acos(l.dot(s)),d=(new e.Matrix4).makeRotationAxis(u.normalize(),p),h=(new e.Matrix4).makeTranslation(o.x,o.y,o.z).clone().multiply(d).multiply(c);a.returnCode=0,a.transformation=h}return a},quaternionToAxisSystem:function(t){var i={},n=(new e.Matrix4).setRotationFromQuaternion(t.clone()).elements;return i.X=new e.Vector3(n[0],n[1],n[2]),i.Y=new e.Vector3(n[4],n[5],n[6]),i.Z=new e.Vector3(n[8],n[9],n[10]),i.Origin=new e.Vector3(n[12],n[13],n[14]),i}};return t}),define("DS/DMUMeasurable/DMUToolsMaterial",["DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/Visualization/MaterialManager"],function(e,t,i){"use strict";var n,o={createBasicMaterial:function(t){return new e.MeshBasicMaterial({color:!t.color||isNaN(t.color.r)||isNaN(t.color.g)||isNaN(t.color.b)?t.color?new e.Color(t.color):new e.Color:t.color,side:e.DoubleSide,transparent:!0,opacity:t.opacity||0===t.opacity?t.opacity:1,force:!0})},getDashType:function(e){var i=e;return isNaN(i)&&i.toUpperCase?(i=i.toUpperCase(),i={SOLID:t.LinePatternEnum.SOLID,DOTTED:t.LinePatternEnum.DOTTED,DASHED:t.LinePatternEnum.DASHED,DOT_DASHED:t.LinePatternEnum.DOTDASHED,PHANTOM:t.LinePatternEnum.PHANTOM,SMALL_DOT:t.LinePatternEnum.SMALLDOTTED,JIS_AXIS:t.LinePatternEnum.JISAXIS}[i]):i=parseFloat(i),i},createLineMaterial:function(t){return new e.LineBasicMaterial({color:!t.color||isNaN(t.color.r)||isNaN(t.color.g)||isNaN(t.color.b)?t.color?new e.Color(t.color):new e.Color:t.color,lineWidth:isNaN(t.lineWidth)?1:t.lineWidth,opacity:"number"==typeof t.opacity?t.opacity:1,transparent:!0,force:!0,dashType:o.getDashType(t.pattern),isCPUPattern:!0,polygonBorderMode:!0})},retrieveMaterialFromGAS:function(e){if(n||(n=new i),e.lineWidth||e.pattern)return o.createLineMaterial(e);if(e.symbol)return n.createPointMaterial(e);var t=n.getMaterialFromGAS({color:e.color,opacity:"number"==typeof e.opacity?e.opacity:1,transparent:!0,pattern:e.pattern,isCPUPattern:!0,polygonBorderMode:!0,size:e.size});return t&&(t.force=!0),t}};return o}),define("DS/DMUMeasurable/DMUMeshCreation",["DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],function(e,t){"use strict";var i={createPolylines:function(e,i,n,o){var r,a,s,l,c=new t.PrimitiveGroup,u=new t.Color(i[0].r,i[0].g,i[0].b,1);c.fillAttr=new t.FillAttributes,c.lineAttr=new t.LineAttributes(u,n,o),c.pointAttr=new t.PointAttributes;var p=0,d=e.length;for(a=0;a<d;a++)for(s=(r=e[a]).length,l=0;l<s;l++)p+=r[l].length;var h,m=new t.Buffer;m.size=3*p,m.component=t.VertexComponentEnum.POSITION,m.format=t.DataTypeEnum.FLOAT,m.dimension=3,m.data=new Float32Array(m.size);var y=m.data,g=0;for(a=0;a<d;a++)for(s=(r=e[a]).length,l=0;l<s;l++){p=(h=r[l]).length;for(var P=0;P<p;P++){var f=h[P];y[g]=f[0],y[g+1]=f[1],y[g+2]=f[2],g+=3}}c.addBuffer(0,m);var v=0;for(a=0;a<d;a++)for(r=e[a],u=new t.Color(i[a].r,i[a].g,i[a].b,1),s=r.length,l=0;l<s;l++){p=(h=r[l]).length;var T=new t.Primitive;T.nbIndices=p,T.connectivity=t.ConnectivityTypeEnum.LINE_STRIP,T.attr={fill:new t.FillAttributes(u),line:new t.LineAttributes(u,n,o),point:new t.PointAttributes};var C=new t.VertexComponent;C.component=t.VertexComponentEnum.POSITION,C.nbVertices=p,C.nbValuesPerVertex=3,C.format=t.DataTypeEnum.FLOAT,C.cardinality=0,C.bufferId=0,C.offset=v,v+=p,T.addVertexComponent(C),c.addPrimitive(T)}return c},createRectangle:function(e,t,n,o,r,a){var s=[],l=0;s[l++]=0,s[l++]=0,s[l++]=0,s[l++]=e,s[l++]=0,s[l++]=0,s[l++]=e,s[l++]=t,s[l++]=0,s[l++]=0,s[l++]=t,s[l++]=0;var c=[];c[0]=0,c[1]=0,c[2]=1;var u=[];return u[l++]=0,u[l++]=1,u[l++]=1,u[l++]=0,i.createPlanarPolygon(s,c,u,!1,n,o,r,a)},createPlanarPolygon:function(e,i,n,o,r,a,s,l){var c=e.length/3,u=r?c+1:0,p=s?c:0,d=o?t.ConnectivityTypeEnum.TRIANGLE_STRIP:t.ConnectivityTypeEnum.TRIANGLE_FAN,h=void 0!==l?l:new t.Color(.5,.5,.5,1),m=void 0!==a?a:new t.Color(.5,.5,.5,1),y=new t.PrimitiveGroup;y.fillAttr=new t.FillAttributes,y.lineAttr=new t.LineAttributes,y.pointAttr=new t.PointAttributes;var g=new t.Buffer;g.size=3*c,g.component=t.VertexComponentEnum.POSITION,g.format=t.DataTypeEnum.FLOAT,g.dimension=3,g.data=new Float32Array(g.size);var P=new t.Buffer;P.size=3,P.component=t.VertexComponentEnum.NORMAL,P.format=t.DataTypeEnum.FLOAT,P.dimension=3,P.data=new Float32Array(P.size);var f=new t.Buffer;f.size=6,f.component=t.VertexComponentEnum.TEX_COORD_0,f.format=t.DataTypeEnum.FLOAT,f.dimension=3,f.data=new Float32Array(f.size);var v=new t.Buffer;v.indexBuffer=!0,v.size=u+p,v.format=t.DataTypeEnum.UINT,v.dimension=1,v.data=new Uint16Array(v.size);var T=new t.Buffer;T.indexBuffer=!0,T.size=p,T.format=t.DataTypeEnum.UINT,T.dimension=1,T.data=new Uint16Array(T.size);var C=new t.Buffer;C.indexBuffer=!0,C.size=u+p,C.format=t.DataTypeEnum.UINT,C.dimension=1,C.data=new Uint16Array(C.size);y.addBuffer(0,g),y.addBuffer(1,P),y.addBuffer(2,v),y.addBuffer(3,T),y.addBuffer(4,f),y.addBuffer(5,C);var _=v.data,M=0,S=0;if(r){for(S=0;S<c;S++)_[M++]=S;_[M++]=0}if(s)for(S=0;S<c;S++)_[M++]=S;if(_=T.data,M=0,s)for(S=0;S<c;S++)_[M++]=0;if(_=C.data,M=0,s)for(S=0;S<c;S++)_[M++]=n[S];for(_=g.data,M=0;M<3*c;M++)_[M]=e[M];if(M=0,(_=P.data)[M++]=i[0],_[M++]=i[1],_[M++]=i[2],M=0,(_=f.data)[M++]=0,_[M++]=0,_[M++]=0,_[M++]=1,_[M++]=0,_[M++]=0,r){var E=new t.Primitive;E.nbIndices=c+1,E.connectivity=t.ConnectivityTypeEnum.LINE_STRIP,E.attr={fill:new t.FillAttributes(m),line:new t.LineAttributes(m),point:new t.PointAttributes};var N=new t.VertexComponent;N.component=t.VertexComponentEnum.POSITION,N.nbVertices=c,N.nbValuesPerVertex=3,N.format=t.DataTypeEnum.FLOAT,N.cardinality=0,N.bufferId=0,N.indices=new t.IndexArray,N.indices.format=t.DataTypeEnum.UINT,N.indices.bufferId=2,N.indices.offset=0,E.addVertexComponent(N),y.addPrimitive(E)}if(s){var D=new t.Primitive;D.nbIndices=c,D.connectivity=d,D.attr={fill:new t.FillAttributes(h),line:new t.LineAttributes,point:new t.PointAttributes};var b=new t.VertexComponent;b.component=t.VertexComponentEnum.POSITION,b.nbVertices=c,b.nbValuesPerVertex=3,b.format=t.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=0,b.indices=new t.IndexArray,b.indices.format=t.DataTypeEnum.UINT,b.indices.bufferId=2,b.indices.offset=u;var A=new t.VertexComponent;A.component=t.VertexComponentEnum.NORMAL,A.nbVertices=1,A.nbValuesPerVertex=3,A.format=t.DataTypeEnum.FLOAT,A.cardinality=0,A.bufferId=1,A.indices=new t.IndexArray,A.indices.format=t.DataTypeEnum.UINT,A.indices.bufferId=3,A.indices.offset=0;var R=new t.VertexComponent;R.component=t.VertexComponentEnum.TEX_COORD_0,R.nbVertices=2,R.nbValuesPerVertex=3,R.format=t.DataTypeEnum.FLOAT,R.cardinality=0,R.bufferId=4,R.indices=new t.IndexArray,R.indices.format=t.DataTypeEnum.UINT,R.indices.bufferId=5,R.indices.offset=0,D.addVertexComponent(b),D.addVertexComponent(A),D.addVertexComponent(R),y.addPrimitive(D)}return y},_computeTotalLength:function(e){var t=[];if(e.length>0){t.push(0);for(var i=0,n=1;n<e.length;n++)i+=e[n-1].distanceTo(e[n]),t.push(i)}return t},_intersection:function(t,i,n){var o=((t.x-n.x)*i.x-(n.y-t.y)*i.y)/(-i.x*i.x-i.y*i.y);return new e.Vector2(t.x+o*i.x,t.y+o*i.y)},boundingBoxCompute:function(t){var i,n=Number.MAX_VALUE,o=[],r=[],a=0,s=0,l=0,c=0;for(i=0;i<t.length;i++)r.push(t[(i+1)%t.length].clone().sub(t[i]).normalize()),t[i].x<t[a].x&&(a=i),t[i].x>t[s].x&&(s=i),t[i].y<t[c].y&&(c=i),t[i].y>t[l].y&&(l=i);var u=new e.Vector2(-1,0),p=new e.Vector2(0,-1);for(i=0;i<t.length;i++){var d=[p.dot(r[a]),-p.dot(r[s]),u.dot(r[l]),-u.dot(r[c])];switch(d.indexOf(Math.max.apply(Math,d))){case 0:(u=r[a].clone()).set(u.y,-u.x),a=(a+1)%t.length;break;case 1:(u=r[s].clone().negate()).set(u.y,-u.x),s=(s+1)%t.length;break;case 2:u=r[l].clone(),l=(l+1)%t.length;break;case 3:u=r[c].clone().negate(),c=(c+1)%t.length}(p=u.clone().negate()).set(p.y,-p.x);var h=this._intersection(t[a],p,t[l]),m=this._intersection(t[s],p,t[l]),y=this._intersection(t[c],u,t[a]),g=this._intersection(t[c],u,t[s]),P=h.distanceTo(y),f=h.distanceTo(m),v=f*P;v<n&&(o=[h,y,g,m,f,P],n=v)}return o}};return i}),define("DS/DMUMeasurable/DMUMeasureEnums",[],function(){"use strict";var e={REVISION:"1",ResultType:{POINT:0,PICKINGPT:1,CENTER:2,CURVE:3,LINE:4,AXIS:5,CIRCLE:6,SURFACE:7,PLANE:8,CYLINDER:9,CONE:10,SPHERE:11,PRODUCT:12},ViewedType:{POINT:0,CENTER:1,AXIS:2,CURVE:3,INFPLANE:4,SURFACE:5,PRODUCT:6,CIRCLE:7,CYCOSP:8},RadiusResultDisplayType:{CENTER:0,TANGENT:1}};return e}),define("DS/DMUMeasurable/DMUGeometryEnums",[],function(){"use strict";var e={REVISION:"1",GeometryType:{POINT:0,PICKINGPT:1,CURVE:2,LINE:3,CIRCLE:4,SURFACE:5,PLANE:6,CYLINDER:7,CONE:8,SPHERE:9,PRODUCT:10},Relationship:{NONE:0,COINCIDENT:1,PARRALLEL:2,INTERSECTING:3},Mode:{EXACT:0,FACETTED:1}};return e}),define("DS/DMUMeasurable/DMUMathsVector3D",[],function(){"use strict";var e=.001,t=1e-6;return{modifyEpsilon:function(i){var n=e;return i>0&&(e=i,t=i*i),n},isNull:function(t){return Math.abs(t[0])<e&&Math.abs(t[1])<e&&Math.abs(t[2])<e},clone:function(e){var t=[];return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},length:function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])},squaredLength:function(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]},normalize:function(e,i){var n,o=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(Math.abs(o-1)<t)(n=i||[0,0,0])[0]=e[0],n[1]=e[1],n[2]=e[2];else if(o>t){var r=Math.sqrt(o);(n=i||[0,0,0])[0]=e[0]/r,n[1]=e[1]/r,n[2]=e[2]/r}return n},multiply:function(e,t,i){var n=i||[0,0,0];return n[0]=t*e[0],n[1]=t*e[1],n[2]=t*e[2],n},areEqual:function(t,i){return Math.abs(i[0]-t[0])<e&&Math.abs(i[1]-t[1])<e&&Math.abs(i[2]-t[2])<e},add:function(e,t,i){var n=i||[0,0,0];return n[0]=t[0]+e[0],n[1]=t[1]+e[1],n[2]=t[2]+e[2],n},sub:function(e,t,i){var n=i||[0,0,0];return n[0]=t[0]-e[0],n[1]=t[1]-e[1],n[2]=t[2]-e[2],n},angle:function(t,i){var n,o=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),r=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);if(o>e&&r>e){var a=(t[0]*i[0]+t[1]*i[1]+t[2]*i[2])/(o*r);n=Math.acos(Math.min(Math.max(a,-1),1))}return n},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},cross:function(e,t,i){var n=i||[0,0,0],o=e[0],r=e[1],a=e[2],s=t[0],l=t[1],c=t[2];return n[0]=r*c-a*l,n[1]=a*s-o*c,n[2]=o*l-r*s,n},subAndLength:function(e,t,i){var n=i||[0,0,0];return n[0]=t[0]-e[0],n[1]=t[1]-e[1],n[2]=t[2]-e[2],Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2])},subAndSquaredLength:function(e,t,i){var n=i||[0,0,0];return n[0]=t[0]-e[0],n[1]=t[1]-e[1],n[2]=t[2]-e[2],n[0]*n[0]+n[1]*n[1]+n[2]*n[2]},multiplyAndAdd:function(e,t,i,n){var o=n||[0,0,0];return o[0]=e[0]*t+i[0],o[1]=e[1]*t+i[1],o[2]=e[2]*t+i[2],o},isIdentity:function(t){return Math.abs(t[0]-1)<e&&Math.abs(t[1])<e&&Math.abs(t[2])<e&&Math.abs(t[3])<e&&Math.abs(t[4])<e&&Math.abs(t[5]-1)<e&&Math.abs(t[6])<e&&Math.abs(t[7])<e&&Math.abs(t[8])<e&&Math.abs(t[9])<e&&Math.abs(t[10]-1)<e&&Math.abs(t[11])<e&&Math.abs(t[12])<e&&Math.abs(t[13])<e&&Math.abs(t[14])<e&&Math.abs(t[15]-1)<e},areMatrixEqual:function(t,i){return Math.abs(t[0]-i[0])<e&&Math.abs(t[1]-i[1])<e&&Math.abs(t[2]-i[2])<e&&Math.abs(t[3]-i[3])<e&&Math.abs(t[4]-i[4])<e&&Math.abs(t[5]-i[5])<e&&Math.abs(t[6]-i[6])<e&&Math.abs(t[7]-i[7])<e&&Math.abs(t[8]-i[8])<e&&Math.abs(t[9]-i[9])<e&&Math.abs(t[10]-i[10])<e&&Math.abs(t[11]-i[11])<e&&Math.abs(t[12]-i[12])<e&&Math.abs(t[13]-i[13])<e&&Math.abs(t[14]-i[14])<e&&Math.abs(t[15]-i[15])<e},transformVector:function(e,t,i){var n=i||[0,0,0],o=e[0],r=e[1],a=e[2];return n[0]=t[0]*o+t[4]*r+t[8]*a,n[1]=t[1]*o+t[5]*r+t[9]*a,n[2]=t[2]*o+t[6]*r+t[10]*a,n},transformPoint:function(e,t,i){var n=i||[0,0,0],o=e[0],r=e[1],a=e[2];return n[0]=t[0]*o+t[4]*r+t[8]*a+t[12],n[1]=t[1]*o+t[5]*r+t[9]*a+t[13],n[2]=t[2]*o+t[6]*r+t[10]*a+t[14],n}}}),define("DS/DMUMeasurable/DMUManipulablePlane",["DS/Visualization/Node3D","DS/DMUMeasurable/DMUMeshCreation","DS/DMUMeasurable/DMUToolsMaths","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/Manipulators/LineTranslationManipulator","DS/Manipulators/RotationManipulator","DS/Manipulators/PlaneTranslationManipulator","DS/Manipulators/PointHandle","DS/ApplicationFrame/CommandsManager"],function(e,t,i,n,o,r,a,s,l,c,u){"use strict";var p=e.extend({init:function(t){return this._parent(),this._viewer=t.viewer,this._frameWindow=t.frameWindow,this._bTranslationManipulator=!!t.bTranslationManipulator&&t.bTranslationManipulator,this._bRotationManipulator=!!t.bRotationManipulator&&t.bRotationManipulator,this._bResizeManipulator=!!t.bResizeManipulator&&t.bResizeManipulator,this._bCenterManipulator=!!t.bCenterManipulator&&t.bCenterManipulator,this._sType=t.sType,this._robotWihtRulerClass=t.RulerClass,this._CBGetState=t.getState?t.getState:this.getState,this._CBGetShowState=t.getState?t.getShowState:this.getShowState,this._CBGetGeometry=t.getGeometry?t.getGeometry:this.getGeometry,this._CBSetGeometry=t.setGeometry?t.setGeometry:this.setGeometry,this._CBGetDisplayInformation=t.getDisplayInformation?t.getDisplayInformation:this.getDisplayInformation,this._CBManipulationInformation=t.getManipulationInformation?t.getManipulationInformation:this.getManipulationInformation,this._appType=t.appType,this._context=t.context,this._mMaterial=new n.MeshPhongMaterial({transparent:!0,side:n.DoubleSide,enableClipPlanes:!1,depthWrite:!1}),this._mMaterial.force=!0,this._nCenterPlaneNode=new e,this._nCenterPlaneNode._getExcludeFromCSO=function(){return!0},this.addChild(this._nCenterPlaneNode),this._bRotationManipulator&&(this._nUSideNode=new e,this.addChild(this._nUSideNode),this._nVSideNode=new e,this.addChild(this._nVSideNode)),this._bResizeManipulator&&(this._nCornerNode=new e,this.addChild(this._nCornerNode)),this._bVisuNotBuild=!0,this._addManipulators(),this._fPreviousPlaneUSize=0,this._fPreviousPlaneVSize=0,this._cPreviousColor=0,this._fPreviousOpacitUSide=0,this._sPreviousDisplayPlaneMode=0,this.update(),this},setName:function(e){this._nCenterPlaneNode.name=e,this._nCenterPlaneSubNode.name=e,this._nUSideNode&&(this._nUSideNode.name=e,this._nUpSideSubNode.name=e,this._nUmSideSubNode.name=e),this._nVSideNode&&(this._nVSideNode.name=e,this._nVpSideSubNode.name=e,this._nVmSideSubNode.name=e),this._nCornerNode&&(this._nCornerNode.name=e,this._nUpVpCornerSubNode.name=e,this._nUpVmCornerSubNode.name=e,this._nUmVpCornerSubNode.name=e,this._nUmVmCornerSubNode.name=e)},clean:function(){this._bCenterManipulator&&this._nPointHandle&&this._nPointHandle.dispose()},setRobot:function(e){this._robotWihtRuler=e,this.updateRobotPos(!0)},getsectionEditCmdRunningStatus:function(){var e=!1,t=u.getCommand("DMUSectionInEditModeHdr",this._context);return t&&(e=t.isRunning()),e},initRobot:function(){var e=u.getCommand("DMUSectionInEditModeHdr",this._context);if(e){(e.isRunning()||e.isPaused())&&e.end();this&&(e.makeRobot(this),e.begin(),this._robotWihtRuler=e.getRobot())}},setPickingInManipulationModeForLineTraslation:function(e){this._nCenterPlaneNode&&this._nCenterPlaneNode.manipulator&&this._nCenterPlaneNode.manipulator.setPickingInManipulation(e)},update:function(){var e=this._CBGetDisplayInformation();return this._mMaterial.color=e.fillColor,this._mMaterial.opacity=e.opacity,this._rebuildPlaneSubNodes(),this._updateManipulators(),this._bVisuNotBuild=!1,this},getState:function(){return p.State.STANDARD},getShowState:function(){return!0},getGeometry:function(){return{referential:new n.Matrix4,uSize:1e3,vSize:1e3}},setGeometry:function(){},getDisplayInformation:function(){return{mode:p.DisplayMode.PLANE,fillColor:new n.Color(7979230),opacity:.2}},getManipulationInformation:function(){return!0},_getCenter:function(){var e=this._CBGetGeometry(this._sType);return(new n.Vector3).getPositionFromMatrix(e.referential)},_getNormal:function(){var e=this._CBGetGeometry(this._sType).referential.decompose();return new n.Vector3(0,0,1).applyQuaternion(e[1])},_getUDirection:function(){var e=this._CBGetGeometry(this._sType).referential.decompose();return new n.Vector3(1,0,0).applyQuaternion(e[1])},_getVDirection:function(){var e=this._CBGetGeometry(this._sType).referential.decompose();return new n.Vector3(0,1,0).applyQuaternion(e[1])},_isPlaneSubNodesNeedRebuild:function(){var e=!this._bVisuNotBuild;if(e){var t=this._CBGetGeometry(this._sType);e=(e=e&&this._fPreviousPlaneUSize===t.uSize)&&this._fPreviousPlaneVSize===t.vSize;var i=this._CBGetDisplayInformation();e=(e=(e=e&&this._cPreviousColor===i.fillColor)&&this._fPreviousOpacity===i.opacity)&&this._sPreviousDisplayPlaneMode===i.mode}return!e},_recordPlaneData:function(){var e=this._CBGetGeometry(this._sType);this._fPreviousPlaneUSize=e.uSize,this._fPreviousPlaneVSize=e.vSize;var t=this._CBGetDisplayInformation();this._cPreviousColor=t.fillColor,this._fPreviousOpacity=t.opacity,this._sPreviousDisplayPlaneMode=t.mode},_setPlaneVisibility:function(e){0===this._viewer.getVisibleSpace()&&(e=!e),this._nCenterPlaneNode.setVisibility(e),this._nUSideNode&&this._nUSideNode.setVisibility(e),this._nVSideNode&&this._nVSideNode.setVisibility(e),this._nCornerNode&&this._nCornerNode.setVisibility(e)},_rebuildPlaneSubNodes:function(){var e=!1;return this._isPlaneSubNodesNeedRebuild()&&(this._recordPlaneData(),this._rebuildSidesSubNodes(),this._rebuildCornersSubNodes(),this._rebuildCenterSubNode(),e=!0),e},_rebuildSidesSubNodes:function(){if(this._nUSideNode&&this._nVSideNode){var e,i=this._CBGetDisplayInformation(),r=this._CBGetGeometry(this._sType),a=r.uSize,s=r.vSize,l=a/2,c=s/2,u=Math.max(a,s)/20;this._nUSideNode.manipulator.deactivate(this._nUSideNode.token),this._nVSideNode.manipulator.deactivate(this._nVSideNode.token),null!==this._nUpSideSubNode&&this._nUSideNode.remove(this._nUpSideSubNode),null!==this._nUmSideSubNode&&this._nUSideNode.remove(this._nUmSideSubNode),null!==this._nVpSideSubNode&&this._nVSideNode.remove(this._nVpSideSubNode),null!==this._nVmSideSubNode&&this._nVSideNode.remove(this._nVmSideSubNode),e=t.createRectangle(a,u,!1,void 0,!0,i.fillColor),this._nUpSideSubNode=o.createMeshNode(e,this._mMaterial),this._nUpSideSubNode.excludeFromHighlight(!0,!1),this._nUpSideSubNode.setShadow(!1),this._nUpSideSubNode.setMatrix((new n.Matrix4).translate(new n.Vector3(-l,c,0))),this._nUSideNode.addChild(this._nUpSideSubNode),e=t.createRectangle(a,u,!1,void 0,!0,i.fillColor),this._nUmSideSubNode=o.createMeshNode(e,this._mMaterial),this._nUmSideSubNode.excludeFromHighlight(!0,!1),this._nUmSideSubNode.setShadow(!1),this._nUmSideSubNode.setMatrix((new n.Matrix4).translate(new n.Vector3(-l,-c-u,0))),this._nUSideNode.addChild(this._nUmSideSubNode),e=t.createRectangle(u,s,!1,void 0,!0,i.fillColor),this._nVpSideSubNode=o.createMeshNode(e,this._mMaterial),this._nVpSideSubNode.excludeFromHighlight(!0,!1),this._nVpSideSubNode.setShadow(!1),this._nVpSideSubNode.setMatrix((new n.Matrix4).translate(new n.Vector3(l,-c,0))),this._nVSideNode.addChild(this._nVpSideSubNode),e=t.createRectangle(u,s,!1,void 0,!0,i.fillColor),this._nVmSideSubNode=o.createMeshNode(e,this._mMaterial),this._nVmSideSubNode.excludeFromHighlight(!0,!1),this._nVmSideSubNode.setShadow(!1),this._nVmSideSubNode.setMatrix((new n.Matrix4).translate(new n.Vector3(-l-u,-c,0))),this._nVSideNode.addChild(this._nVmSideSubNode),this._nUSideNode.manipulator.activate(this._nUSideNode.token),this._nVSideNode.manipulator.activate(this._nVSideNode.token)}},_rebuildCornersSubNodes:function(){if(this._nCornerNode){var e,i=this._CBGetDisplayInformation(),r=this._CBGetGeometry(this._sType),a=r.uSize,s=r.vSize,l=a/2,c=s/2,u=Math.max(a,s)/20;this._nCornerNode.manipulator.deactivate(this._nCornerNode.token),null!==this._nUpVpCornerSubNode&&this._nCornerNode.remove(this._nUpVpCornerSubNode),null!==this._nUpVmCornerSubNode&&this._nCornerNode.remove(this._nUpVmCornerSubNode),null!==this._nUmVpCornerSubNode&&this._nCornerNode.remove(this._nUmVpCornerSubNode),null!==this._nUmVmCornerSubNode&&this._nCornerNode.remove(this._nUmVmCornerSubNode),e=t.createRectangle(u,u,!1,void 0,!0,i.fillColor),this._nUpVpCornerSubNode=o.createMeshNode(e,this._mMaterial),this._nUpVpCornerSubNode.excludeFromHighlight(!0,!1),this._nUpVpCornerSubNode.setShadow(!1),this._nUpVpCornerSubNode.setMatrix((new n.Matrix4).translate(new n.Vector3(l,c,0))),this._nUpVpCornerSubNode.name="UV",this._nCornerNode.addChild(this._nUpVpCornerSubNode),e=t.createRectangle(u,u,!1,void 0,!0,i.fillColor),this._nUpVmCornerSubNode=o.createMeshNode(e,this._mMaterial),this._nUpVmCornerSubNode.excludeFromHighlight(!0,!1),this._nUpVmCornerSubNode.setShadow(!1),this._nUpVmCornerSubNode.setMatrix((new n.Matrix4).translate(new n.Vector3(l,-c-u,0))),this._nUpVmCornerSubNode.name="U-V",this._nCornerNode.addChild(this._nUpVmCornerSubNode),e=t.createRectangle(u,u,!1,void 0,!0,i.fillColor),this._nUmVpCornerSubNode=o.createMeshNode(e,this._mMaterial),this._nUmVpCornerSubNode.excludeFromHighlight(!0,!1),this._nUmVpCornerSubNode.setShadow(!1),this._nUmVpCornerSubNode.setMatrix((new n.Matrix4).translate(new n.Vector3(-l-u,c,0))),this._nUmVpCornerSubNode.name="-UV",this._nCornerNode.addChild(this._nUmVpCornerSubNode),e=t.createRectangle(u,u,!1,void 0,!0,i.fillColor),this._nUmVmCornerSubNode=o.createMeshNode(e,this._mMaterial),this._nUmVmCornerSubNode.excludeFromHighlight(!0,!1),this._nUmVmCornerSubNode.setShadow(!1),this._nUmVmCornerSubNode.setMatrix((new n.Matrix4).translate(new n.Vector3(-l-u,-c-u,0))),this._nUmVmCornerSubNode.name="-U-V",this._nCornerNode.addChild(this._nUmVmCornerSubNode),this._nCornerNode.manipulator.activate(this._nCornerNode.token)}},_rebuildCenterSubNode:function(){var i,a,s=this._CBGetDisplayInformation(),l=this._CBGetGeometry(this._sType),c=l.uSize,u=l.vSize,d=c/2,h=u/2;if(this._nCenterPlaneNode.manipulator&&this._nCenterPlaneNode.manipulator.deactivate(this._nCenterPlaneNode.token),null!==this._nCenterPlaneSubNode&&this._nCenterPlaneNode.remove(this._nCenterPlaneSubNode),s.mode===p.DisplayMode.PLANE)i=t.createRectangle(c,u,!1,void 0,!0,s.fillColor),this._nCenterPlaneSubNode=o.createMeshNode(i,this._mMaterial),this._nCenterPlaneSubNode.excludeFromCSO(!0),this._nCenterPlaneSubNode.excludeFromHighlight(!0,!1),this._nCenterPlaneSubNode.setShadow(!1),this._nCenterPlaneSubNode.setMatrix((new n.Matrix4).translate(new n.Vector3(-d,-h,0)));else if(s.mode===p.DisplayMode.GRID){this._nCenterPlaneSubNode=new e;var m=l.uStep,y=l.vStep;m||(m=c/10),y||(y=u/10);for(var g,P=Math.floor(d/m),f=Math.floor(h/y),v=new r.Color(s.fillColor.r,s.fillColor.g,s.fillColor.b,1),T=-P;T<=P;T++){g=m*T;var C=[new n.Vector3(g,h),new n.Vector3(g,-h)];(a=o.createLineNode({points:C,color:v})).excludeFromHighlight(!0,!1),a.setShadow(!1),this._nCenterPlaneSubNode.addChild(a)}for(var _=-f;_<=f;_++){g=y*_;var M=[new n.Vector3(d,g),new n.Vector3(-d,g)];(a=o.createLineNode({points:M,color:v})).excludeFromHighlight(!0,!1),a.setShadow(!1),this._nCenterPlaneSubNode.addChild(a)}}this._nCenterPlaneNode.addChild(this._nCenterPlaneSubNode),this._nCenterPlaneNode.manipulator&&this._nCenterPlaneNode.manipulator.activate(this._nCenterPlaneNode.token)},_addManipulators:function(){this._bTranslationManipulator&&this._addTranslator(),this._bRotationManipulator&&(this._addRotatorU(),this._addRotatorV()),this._bResizeManipulator&&this._addResizor(),this._bCenterManipulator&&!this._robotWihtRulerClass&&this._addPointManipulator()},_setNodeVisibility:function(e){if(e){var t=this._viewer.getVisibleSpace(),i=0===t?!this._CBGetShowState():this._CBGetShowState(),n=this._CBGetState()===p.State.INEDITION,o=i&&n;e.setVisibility(o);var r=o?0!==t:0===t;!0===r&&!1===n&&0===t&&(r=!1),e.setVisibilityFree(!r)}},_setPointHandleVisibility:function(){this._bCenterManipulator&&this._setNodeVisibility(this._nPointHandle)},_updateManipulators:function(){if(this._bTranslationManipulator&&(this._nCenterPlaneNode.manipulator.axis=this._getNormal()),this._bRotationManipulator&&(this._nUSideNode.manipulator.setAxis(this._getUDirection()),this._nUSideNode.manipulator.setCenter(this._getCenter()),this._nVSideNode.manipulator.setAxis(this._getVDirection()),this._nVSideNode.manipulator.setCenter(this._getCenter())),this._bResizeManipulator&&(this._nCornerNode.manipulator.axis=this._getNormal()),this._nPointHandle){this._setPointHandleVisibility();var e=this._CBGetDisplayInformation();this._nPointHandle.setFillColor(e.fillColor)}if(this._robotWihtRuler){var t=0===this._viewer.getVisibleSpace()?!this._CBGetShowState():this._CBGetShowState(),i=this._CBGetState()===p.State.INEDITION;i||(i=this.getsectionEditCmdRunningStatus());var n=!(t&&i);this._robotWihtRuler.update(n)}},_onTranslatorManipulationBeginCB:function(e){this._CBManipulationInformation({action:p.ManipulationAction.ENABLE,type:p.ManipulationType.TRANSLATION,evt:e.event})&&(this._vInitialCenter=this._getCenter(),this._robotWihtRuler?this._robotWihtRuler.updateOnTranslationBegin(e):(this.initRobot(),this._robotWihtRuler&&this._robotWihtRuler.updateOnTranslationBegin(e)),this._CBManipulationInformation({action:p.ManipulationAction.BEGIN,type:p.ManipulationType.TRANSLATION,evt:e.event}))},_onTranslatorManipulationCB:function(e){if(this._CBManipulationInformation({action:p.ManipulationAction.ENABLE,type:p.ManipulationType.TRANSLATION,evt:e.event})){var t=e.translationVector;if(this._robotWihtRuler.snapTranslationCallback){var i=this._robotWihtRuler.snapTranslationCallback({translationVector:e.translationVector});i&&(t=i)}var n=this._CBGetGeometry(this._sType).referential;n.setPosition(this._vInitialCenter.clone().add(t)),this._CBSetGeometry({referential:n}),this._updateManipulators(),this._robotWihtRuler&&this._robotWihtRuler.updateOnTranslation({translationVector:t,manipulator:e.manipulator,intersection:e.intersection}),this._CBManipulationInformation({action:p.ManipulationAction.DO,type:p.ManipulationType.TRANSLATION,evt:e.event})}},_onTranslatorManipulationEndCB:function(e){this._CBManipulationInformation({action:p.ManipulationAction.ENABLE,type:p.ManipulationType.TRANSLATION,evt:e.event})&&(this._vInitialCenter=void 0,this._robotWihtRuler&&this._robotWihtRuler.updateOnTranslationEnd(e)),this._CBManipulationInformation({action:p.ManipulationAction.END,type:p.ManipulationType.TRANSLATION,evt:e.event})},_onTranslatorManipulationLongHoldCB:function(e){this._CBManipulationInformation({action:p.ManipulationAction.LONG_HOLD,type:p.ManipulationType.TRANSLATION,evt:e.event})},_addTranslator:function(){this._nCenterPlaneNode.manipulator=new a({axis:this._getNormal()}),this._nCenterPlaneNode.manipulator.setExclusive(!0),this._nCenterPlaneNode.manipulator.setPickingPriority(!1),this._nCenterPlaneNode.manipulator.setPickingDuringManipulation(!0),this._nCenterPlaneNode.manipulator.setPrePickingDuringManipulation(!1),this._nCenterPlaneNode.manipulator.setPreActivationDuringManipulation(!1),this._nCenterPlaneNode.manipulator.setPickingInManipulation(!0),this._nCenterPlaneNode.token=this._nCenterPlaneNode.manipulator.linkToNode(this._nCenterPlaneNode);var e=this;this._nCenterPlaneNode.manipulator.subscribe("BeginManipulate",function(t){e._onTranslatorManipulationBeginCB(t)}),this._nCenterPlaneNode.manipulator.subscribe("Manipulate",function(t){e._onTranslatorManipulationCB(t)}),this._nCenterPlaneNode.manipulator.subscribe("EndManipulate",function(t){e._onTranslatorManipulationEndCB(t)}),this._nCenterPlaneNode.manipulator.HandleLongHold=function(t){e._onTranslatorManipulationLongHoldCB(t)}},_rotatorManipulationBeginCB:function(e,t){if(this._CBManipulationInformation({action:p.ManipulationAction.ENABLE,type:p.ManipulationType.ROTATION,evt:e.event})){var i=this._CBGetGeometry(this._sType);this._mInitialMatrix=(new n.Matrix4).copy(i.referential),this._robotWihtRuler?this._robotWihtRuler.updateOnRotationBegin(e,t):this.initRobot(),this._CBManipulationInformation({action:p.ManipulationAction.BEGIN,type:p.ManipulationType.ROTATION,evt:e.event})}},_rotatorManipulationCB:function(e,t){var n=e.angle,o=e.axis;if(this._CBManipulationInformation({action:p.ManipulationAction.ENABLE,type:p.ManipulationType.ROTATION,evt:e.event})){if(this._robotWihtRuler.snapRotationCallback){var r=this._robotWihtRuler.snapRotationCallback({axis:e.axis,angle:e.angle});if(void 0===n||!o)return;n=r.value,o=r.axis,n=Math.PI*n/180}var a=t?this._nUSideNode.manipulator.axis:this._nVSideNode.manipulator.axis,s=o.clone().dot(a),l=i.isLessOrEqual(s,0)?-n:n,c=t?this._mInitialMatrix.clone().rotateX(l):this._mInitialMatrix.clone().rotateY(l);this._CBSetGeometry({referential:c}),this._robotWihtRuler&&this._robotWihtRuler.updateOnRotation({angle:n,axis:o},t),this._CBManipulationInformation({action:p.ManipulationAction.DO,type:p.ManipulationType.ROTATION,evt:e.event})}},_rotatorManipulationEndCB:function(e){this._CBManipulationInformation({action:p.ManipulationAction.ENABLE,type:p.ManipulationType.ROTATION,evt:e.event})&&(this._mInitialMatrix=void 0,this._robotWihtRuler&&this._robotWihtRuler.updateOnRotationEnd()),this._CBManipulationInformation({action:p.ManipulationAction.END,type:p.ManipulationType.ROTATION,evt:e.event})},_addRotatorU:function(){if(this._nUSideNode){this._nUSideNode.manipulator=new s({axis:this._getUDirection()}),this._nUSideNode.manipulator.setCenter(this._getCenter()),this._nUSideNode.manipulator.setExclusive(!0),this._nUSideNode.manipulator.setPickingPriority(!1),this._nUSideNode.manipulator.setPickingDuringManipulation(!1),this._nUSideNode.manipulator.setPrePickingDuringManipulation(!1),this._nUSideNode.manipulator.setPreActivationDuringManipulation(!1),this._nUSideNode.token=this._nUSideNode.manipulator.linkToNode(this._nUSideNode);var e=this;this._nUSideNode.manipulator.subscribe("BeginManipulate",function(t){e._rotatorManipulationBeginCB(t,!0)}),this._nUSideNode.manipulator.subscribe("Manipulate",function(t){e._rotatorManipulationCB(t,!0)}),this._nUSideNode.manipulator.subscribe("EndManipulate",function(t){e._rotatorManipulationEndCB(t)})}},_addRotatorV:function(){if(this._nVSideNode){this._nVSideNode.manipulator=new s({axis:this._getVDirection()}),this._nVSideNode.manipulator.setCenter(this._getCenter()),this._nVSideNode.manipulator.setExclusive(!0),this._nVSideNode.manipulator.setPickingPriority(!1),this._nVSideNode.manipulator.setPickingDuringManipulation(!1),this._nVSideNode.manipulator.setPrePickingDuringManipulation(!1),this._nVSideNode.manipulator.setPreActivationDuringManipulation(!1),this._nVSideNode.token=this._nVSideNode.manipulator.linkToNode(this._nVSideNode);var e=this;this._nVSideNode.manipulator.subscribe("BeginManipulate",function(t){e._rotatorManipulationBeginCB(t,!1)}),this._nVSideNode.manipulator.subscribe("Manipulate",function(t){e._rotatorManipulationCB(t,!1)}),this._nVSideNode.manipulator.subscribe("EndManipulate",function(t){e._rotatorManipulationEndCB(t)})}},_refreshAngularRuler:function(e){if(this._angularRuler&&e){var t=(new n.Vector3).copy(e.axis),o=this._angularRuler.direction.dot(t),r=i.isLessThan(o,0)?2*Math.PI-e.angle:e.angle;this._angularRuler.setValue(this._angularRuler.initValue+180*r/Math.PI),this._angularRuler.refresh()}},updateRobotPos:function(e){this._robotWihtRuler&&this._robotWihtRuler.updateRobotPos(e)},_doResizerManipulateBeginCB:function(e){this._CBManipulationInformation({action:p.ManipulationAction.ENABLE,type:p.ManipulationType.RESIZE,evt:e.event})&&(this._sCorner=e.intersection.path[0].getLastElement().name,this._vInitialPosition=this._getCornerPosition(this._sCorner),this._CBManipulationInformation({action:p.ManipulationAction.BEGIN,type:p.ManipulationType.RESIZE,evt:e.event}))},_doResizerManipulateCB:function(e){this._CBManipulationInformation({action:p.ManipulationAction.ENABLE,type:p.ManipulationType.RESIZE,evt:e.event})&&(this._modifyCornerPosition(this._sCorner,this._vInitialPosition.clone().add(e.translationVector)),this._CBManipulationInformation({action:p.ManipulationAction.DO,type:p.ManipulationType.RESIZE,evt:e.event}))},_doResizerManipulateEndCB:function(e){this._CBManipulationInformation({action:p.ManipulationAction.ENABLE,type:p.ManipulationType.RESIZE,evt:e.event})&&(this._sCorner=void 0,this._vInitialPosition=void 0),this._CBManipulationInformation({action:p.ManipulationAction.END,type:p.ManipulationType.RESIZE,evt:e.event})},_addResizor:function(){this._nCornerNode.manipulator=new l({axis:this._getNormal()}),this._nCornerNode.manipulator.setExclusive(!0),this._nCornerNode.manipulator.setPickingPriority(!1),this._nCornerNode.manipulator.setPickingDuringManipulation(!1),this._nCornerNode.manipulator.setPrePickingDuringManipulation(!1),this._nCornerNode.manipulator.setPreActivationDuringManipulation(!1),this._nCornerNode.token=this._nCornerNode.manipulator.linkToNode(this._nCornerNode);var e=this;this._nCornerNode.manipulator.subscribe("BeginManipulate",function(t){e._doResizerManipulateBeginCB(t)}),this._nCornerNode.manipulator.subscribe("Manipulate",function(t){e._doResizerManipulateCB(t)}),this._nCornerNode.manipulator.subscribe("EndManipulate",function(t){e._doResizerManipulateEndCB(t)})},_addPointManipulator:function(){var e=this._CBGetDisplayInformation();this._nPointHandle=new c({viewer:this._viewer,sceneGraph:this}),this._nPointHandle.name="PointHandle",this._nPointHandle.setFillColor(e.fillColor),this._nPointHandle.setVisibilityInTree(!1);var t,a,s=this;this._nPointHandle.subscribe("BeginManipulate",function(t){if(s._CBManipulationInformation({action:p.ManipulationAction.ENABLE,type:p.ManipulationType.CENTER,evt:t.event})){a=(new n.Matrix4).getInverse(s._CBGetGeometry(this._sType).referential),s._nPointHandle.setPickable(r.PICKTHROUGH),s._setPlaneVisibility(!1);var i=new n.MeshBasicMaterial({color:e.fillColor,side:n.DoubleSide,transparent:!0,alphaTest:.5,enableClipPlanes:!1});i.force=!0,s._nPointHandleSmallPlane=o.createRectangleNode({width:10,height:10,material:i}),s._nPointHandleSmallPlane.setShadow(!1),s._nPointHandleSmallPlane.setPickable(r.NOPICKABLE),s._nPointHandleSmallPlane.setVisibility(!1),s._nPointHandleSmallPlane.setVisibilityInTree(!1),s.addChild(s._nPointHandleSmallPlane),s._CBManipulationInformation({action:p.ManipulationAction.BEGIN,type:p.ManipulationType.CENTER,evt:t.event})}}),this._nPointHandle.subscribe("Manipulate",function(e){if(s._CBManipulationInformation({action:p.ManipulationAction.ENABLE,type:p.ManipulationType.CENTER,evt:e.event})){var o=e.intersection;if(o.position&&o.path.length){var r=o.normal.negate();r.normalize();var l=new n.Vector3(1,0,0).projectOnPlane(r),c=l.length(),u=new n.Vector3(0,1,0).projectOnPlane(r),d=u.length(),h=(new n.Vector3).crossVectors(new n.Vector3(0,0,1),r),m=new n.Vector3(0,0,1).dot(r);i.areEqual(Math.abs(m),1,"float")?i.areEqual(c,d,"float")?(l.normalize(),u=(new n.Vector3).crossVectors(r,l).normalize()):i.isLessThan(c,d)?(u.normalize(),l=(new n.Vector3).crossVectors(u,r).normalize()):(l.normalize(),u=(new n.Vector3).crossVectors(r,l).normalize()):(l=h.normalize(),u=(new n.Vector3).crossVectors(r,l).normalize()),(t=new n.Matrix4(l.x,u.x,r.x,0,l.y,u.y,r.y,0,l.z,u.z,r.z,0,0,0,0,1)).setPosition(o.position),s._nPointHandle.setMatrix(a.clone().multiply(t));var y=t.clone(),g=o.position.clone().add(l.clone().multiplyScalar(-5)).add(u.clone().multiplyScalar(-5));y.setPosition(g),s._nPointHandleSmallPlane.setVisibility(!0),s._nPointHandleSmallPlane.setMatrix(a.clone().multiply(y)),s._CBManipulationInformation({action:p.ManipulationAction.DO,type:p.ManipulationType.CENTER,evt:e.event})}}}),this._nPointHandle.subscribe("EndManipulate",function(e){s._CBManipulationInformation({action:p.ManipulationAction.ENABLE,type:p.ManipulationType.CENTER,evt:e.event})&&(s._CBSetGeometry({referential:t}),s._updateManipulators(),s._setPlaneVisibility(!0),s._nPointHandle.setMatrix(new n.Matrix4),s._nPointHandle.setPickable(r.PICKABLE),s._nPointHandleSmallPlane&&s.remove(s._nPointHandleSmallPlane)),s._CBManipulationInformation({action:p.ManipulationAction.END,type:p.ManipulationType.CENTER,evt:e.event})})},_getCornerPosition:function(e){var t=this._CBGetGeometry(this._sType),i=t.uSize,o=t.vSize,r="UV"===e||"U-V"===e?1:-1,a="UV"===e||"-UV"===e?1:-1,s=t.referential.decompose(),l=s[0],c=s[1],u=new n.Vector3(1,0,0).applyQuaternion(c),p=new n.Vector3(0,1,0).applyQuaternion(c);return l.clone().add(u.multiplyScalar(r*i/2)).add(p.multiplyScalar(a*o/2))},_modifyCornerPosition:function(e,t){var i=this._CBGetGeometry(this._sType),o=i.uSize,r=i.vSize,a="UV"===e||"U-V"===e?1:-1,s="UV"===e||"-UV"===e?1:-1,l=i.referential.decompose(),c=l[0],u=l[1],p=new n.Vector3(1,0,0).applyQuaternion(u).multiplyScalar(a),d=new n.Vector3(0,1,0).applyQuaternion(u).multiplyScalar(s),h=c.clone().add(p.clone().multiplyScalar(-o/2)).add(d.clone().multiplyScalar(-r/2)),m=t.clone().sub(h),y=i.referential.clone(),g=h.clone().add(t).multiplyScalar(.5);y.setPosition(g),this._CBSetGeometry({referential:y,uSize:m.dot(p),vSize:m.dot(d)}),this.updateRobotPos(!0),this._updateManipulators()}});return p.State={STANDARD:0,INEDITION:1},p.DisplayMode={PLANE:0,GRID:1},p.ManipulationAction={ENABLE:0,BEGIN:1,DO:2,END:3,LONG_HOLD:4},p.ManipulationType={TRANSLATION:0,ROTATION:1,RESIZE:2,CENTER:3},p}),define("DS/DMUMeasurable/DMUToolsSceneGraph",["DS/Visualization/PathElement","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/IdPath","DS/Visualization/IdPathMatcher","DS/Visualization/ThreeJS_DS","DS/DMUMeasurable/DMUToolsMaths"],function(e,t,i,n,o,r){"use strict";var a=void 0,s={callPad3DViewerModelServices:function(e,t){return a||(a=require("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices")),a&&e&&a[e]?a[e](t):void 0},isReference:function(e){var t=!1;return e&&((t=s.callPad3DViewerModelServices("isReference",e))||(t=void 0!==e.productType?"Reference3D"===e.productType||"ReferenceRep"===e.productType:t),t||(t=void 0!==e.isPLMReference?e.isPLMReference():t)),t},isRepReference:function(e){var t=!1;return e&&((t=s.callPad3DViewerModelServices("isRepReference",e))||(t=void 0!==e.productType?"RepReference3D"===e.productType||"ReferenceRep"===e.productType:t),t||(t=void 0!==e.isPLMRepReference?e.isPLMRepReference():t)),t},isRepInstance:function(e){var t=!1;return e&&((t=s.callPad3DViewerModelServices("isRepInstance",e))||(t=void 0!==e.productType?"RepInstance3D"===e.productType||"InstanceRep"===e.productType:t),t||(t=void 0!==e.isPLMRepInstance?e.isPLMRepInstance():t)),t},isInstance:function(e){var t=!1;return e&&((t=s.callPad3DViewerModelServices("isInstance",e))||(t=void 0!==e.productType?"Instance3D"===e.productType||"InstanceRep"===e.productType:t),t||(t=void 0!==e.isPLMInstance?e.isPLMInstance():t)),t},isReferenceOrInstance:function(e,t){var i=s.isReference(e);return i||(i=s.isInstance(e)),i||(i=s.isRepInstance(e)),!i&&t&&(i=s.isRepReference(e)),i},isLeaf:function(e,t){var i=!0;if(t&&s.isPLMNode(e))(i=s.is3DLeaf(e))||(i=s.isRepReference(e));else if(e){for(var n=!1,o=0;o<e.children.length;o++)if(s.isReferenceOrInstance(e.children[o],t)){n=!0;break}i=!n}return i},is3DLeaf:function(e){var t=s.callPad3DViewerModelServices("is3DLeaf",e);return!t&&e&&e.is3DLeaf&&(t=e.is3DLeaf()),t},isPLMNode:function(e,t){var i=s.callPad3DViewerModelServices("isPLMNode",e);return i||t||(i=s.isReferenceOrInstance(e,!0)),i},isAModelPath:function(e){return s.callPad3DViewerModelServices("isAModelPath",e)},isAPOIPath:function(e){return s.callPad3DViewerModelServices("isAPOIPath",e)},getPOILayerId:function(e){return s.callPad3DViewerModelServices("getPOILayerId",e)},getNodeType:function(e){var t=s.callPad3DViewerModelServices("getNodeType",e);return!t&&e&&e.getType&&(t=e.getType()),t},getNodeID:function(e){var t=s.callPad3DViewerModelServices("getNodeID",e);return t||(t=e&&"string"==typeof e.persistentId?e.persistentId:t),t||(t=e&&e.getID?e.getID():t),"string"==typeof t?t:""},isVisible:function(e,t){var i=!1;if(t&&e){var n=e.getSceneGraphOverrideSetManager().getCurrentVisibility(t);i=null==n||n}return i},parseForLeafNodes:function(e,t,i,n){if(e&&t){var o=e.clone(),r=o.getChildrenPathes(),a=o.getLastElement(!0);if(s.isLeaf(a,!0)||s.isOOCTileSetNode(a,!0)||0===r.length)s.isVisible(t,o)?i&&i.push(o):n&&n.push(o);else for(var l=0;l<r.length;l++)s.isReferenceOrInstance(r[l].getLastElement(!0),!0)&&(s.isVisible(t,r[l])?s.parseForLeafNodes(r[l],t,i,n):n&&n.push(r[l].clone()))}},parseForLeafNodesOfScene:function(e,t,i){for(var n=e?e.getRootBagPath().getChildrenPathes():[],o=0;o<n.length;o++)s.parseForLeafNodes(n[o],e.getViewer(),t,i)},getName:function(e,t,i,n){var o=n||"";if(e&&t){var r,a=[],l=[],c=!0,u=e.length;for(r=0;r<u;r++){var p=e[r],d=s.callPad3DViewerModelServices("getNodeID",p);d?(c=!1,(s.isInstance(p)||s.isRepInstance(p))&&(p=p.children[0]),l.push(d),a.push(o)):a.push(p.name)}if(t(a),!c){var h=[];for(r=0;r<l.length;r++){for(var m=!1,y=0;!m&&y<r;y++)m=l[r]===l[y];m||h.push(l[r])}var g=i.getController();g.getAttributes({ids:h,attributes:["ds6w:label"],callbacks:{onComplete:function(e){for(a=[],r=0;r<l.length;r++){var i=e[l[r]];a.push(i["ds6w:label"])}t(a)},onFailure:function(){return null}}})}}},getNameWithInstances:function(e,t,i,n){var o=n;if(e&&t){var r,a=[],l=e;if(l){var c=s.getLastReference(l),u=c.getLastElement(!0);if(s.isPLMNode(u)&&(s.isReference(u)||s.is3DLeaf(u))){r={pathElement:l,idRef:s.getNodeID(u)},a.push(r.idRef);var p=s.getLastInstance(c).getLastElement(!0);s.isPLMNode(p)&&s.isInstance(p)&&a.push(r.idInst=s.getNodeID(p))}}if(!a.length)return;i.getController().getAttributes({ids:a,attributes:["ds6w:label"],callbacks:{onComplete:function(e){var i=e[r.idRef]?e[r.idRef]["ds6w:label"]:"";r.idInst&&e[r.idInst]&&e[r.idInst]["ds6w:label"]&&(i+=" ("+e[r.idInst]["ds6w:label"]+")"),t({name:i,forPathNum:o})},onFailure:function(){return null}}})}},getRoots:function(e){var t=s.callPad3DViewerModelServices("getRoots",e);return void 0===t&&e.getRoots&&(t=e.getRoots()),t},getRootReferences:function(e,t){var i=[];return function e(t,i,n){if(s.isReference(t)||s.isRepReference(t))i.push(t);else if(!n&&s.isOOCTileSetNode(t))i.includes(t)||i.push(t);else for(var o=t.children,r=o.length,a=0;a<r;a++)e(o[a],i,n)}(e.getRootNode(),i,t),i},getSceneRoot:function(e){return e.getRootNode()},getRootBag:function(e){var t=require("DS/PADUtils/PADContext").get();return t&&t.getViewer()===e?t.getRootBagPath().getElement(0):e.getRootNode().getChildByName("RootBag")},getFirstReference:function(t){for(var i=new e,n=t.getLength(),o=0;o<n;o++){var r=t.getElement(o);if(s.isReference(r)||s.isRepReference(r)){i.addElement(r);break}}return i},getLastReference:function(t){return t.getLength()>1?s.isReference(t.getLastElement(!0))?t.clone():s.getLastReference(t.getParentPath()):new e},getLastRepReference:function(t){return t.getLength()>1?s.isRepReference(t.getLastElement(!0))?t.clone():s.getLastRepReference(t.getParentPath()):new e},getLastInstance:function(t){return t.getLength()>1?s.isInstance(t.getLastElement(!0))||s.isRepInstance(t.getLastElement(!0))?t.clone():s.getLastInstance(t.getParentPath()):new e},truncatePathElement:function(t,i){for(var n=new e,o=Math.min(t.getLength(),i),r=0;r<o;r++)n.addElement(t.getElement(r));return n},buildPathElement:function(t){for(var i=[],n=t;n&&!n.notAllowedInPathElement;)i.unshift(n),n=n.parents[0];return new e(i)},isDescendant:function(e,t){var i=!1,n=e.getLength();if(t.getLength()>=n){i=!0;for(var o=0;i&&o<n;o++)i=t.getElement(o)===e.getElement(o)}return i},getRenderables:function(e){return e._getRenderableOccurrences()},getRootBagId:function(){var e=require("DS/PADUtils/PADContext").get();return e&&e.getController()&&e.getController().getRootBagId?e.getController().getRootBagId():"rootBag"},getContextViewer:function(e){var t=require("DS/PADUtils/PADContext").get();return t&&t.getViewer()===e.viewer?t:null},initIdPathMatcher:function(e){var t=function(e,i){if(s.getNodeID(i)===e)return i;var n,o=i.children;if(o&&o.length)for(var r=0;r<o.length;r++)if(n=t(e,o[r]))return n};e.setIdPathMatcher(new n({idToNodeCB:function(i){var n=require("DS/PADUtils/PADContext").get();if(n)return i===s.getRootBagId()?s.getRootBag(e):n&&n.getController().getNode({id:i})?n.getController().getNode({id:i}):t(i,s.getRootBag(e))},nodeToIdCB:function(t){return t===s.getRootBag(e)?s.getRootBagId():s.getNodeID(t)},isNodeRepRefCB:function(t){return t!==s.getRootBag(e)&&s.isRepReference(t)}}))},createSceneGraphOverrideSet:function(e){e.getIdPathMatcher()||s.initIdPathMatcher(e);var i,n=e.getSceneGraphOverrideSetManager(),o=s.getRootBag(e);return o&&n&&(i=new t(o,s.getRootBagId()),n.pushSceneGraphOverrideSet(i)),i},ensurePriorityOfSceneGraphOverrideSet:function(e,t){if(e&&t){var i=e.getSceneGraphOverrideSetManager();i&&i.getSceneGraphOverrideSetIndex(t)!==i.getNumberOfSceneGraphOverrideSets()-1&&(i.removeSceneGraphOverrideSet(t),i.pushSceneGraphOverrideSet(t))}},removeSceneGraphOverrideSet:function(e,t){if(e&&t){var i=e.getSceneGraphOverrideSetManager();i&&i.removeSceneGraphOverrideSet(t)}},getIdPath:function(e){var t=[];return e&&e.externalPath.forEach(function(e){if("RootBag"!==e.name){var i=s.getNodeID(e);i&&s.isPLMNode(e)&&t.push(i)}}),t},getOverrides:function(e,t,n){var o,r,a,l=[];if(e&&t)if(t.pathElements&&t.pathElements.length)t.pathElements.forEach(function(t){if(r=t.clone(),e._viewers[0]){var i=s.getRootBag(e._viewers[0].viewer);r.getElement(0).id!==i.id&&r.externalPath.unshift(i)}(o=e.getUniqueOverrideFromPathElement(r))||n||(o=e.createOverride({pathes:[r]})),o&&l.push(o)});else if(t.idPaths&&t.idPaths.length){var c=s.getRootBagId();t.idPaths.forEach(function(s){a=null,Array.isArray(s)?((r=s.slice())[0]!==c&&r.unshift(c),a=new i(r)):s&&s.ids&&(s.ids[0]!==c&&s.ids.unshift(c),a=s),a&&((o=e.getUniqueOverrideFromIdPath(a))||n||(o=e.createIdPathOverride({idPathes:[a],propagateUntilRepRefs:t.propagateUntilRepRefs,propagateToParents:t.propagateToParents})),o&&l.push(o))})}return l},removeOverride:function(e,t){if(e&&t){var n;if(t.pathElement){var o=t.pathElement.clone();if(e._viewers[0]){var r=s.getRootBag(e._viewers[0].viewer);o.getElement(0).id!==r.id&&o.externalPath.unshift(r)}n=e.getUniqueOverrideFromPathElement(o)}else if(t.idPath){var a=t.idPath.slice(),l=s.getRootBagId();a[0]!==l&&a.unshift(l),n=e.getUniqueOverrideFromIdPath(new i(a))}n&&e.deleteOverride(n)}},computeBoundingBox:function(e,t){var i,n,o,r=0;if(t&&(r=t.length)>0){var a,l,c;for(o=0;o<r;o++)(c=t[o])&&((a=s.getLastReference(c).getLastElement())||(a=s.getLastOOCTileNode(c).getLastElement()))&&(n=a.getBoundingBox(),(l=c.getWorldMatrix())&&n.applyMatrix4(l),0===o?i=n:i.mergeWithBox(n))}else{var u=s.getRootReferences(e);for(r=u.length,o=0;o<r;o++)n=u[o].getBoundingBox(),0===o?i=n:i.mergeWithBox(n)}return i},computeBoundingSphere:function(e){var t,i,n,o,r=s.getRootReferences(e);for(n=r.length,o=0;o<n;o++)i=r[o].getBoundingSphere(),t?i&&i.radius&&t.mergeWithSphere(i,t):t=i;return t},getXYAxisDirFromZ:function(e){if(e){var t,i;e.normalize();var n=(t=new o.Vector3(1,0,0).projectOnPlane(e)).length(),a=(i=new o.Vector3(0,1,0).projectOnPlane(e)).length(),s=(new o.Vector3).crossVectors(new o.Vector3(0,0,1),e),l=new o.Vector3(0,0,1).dot(e);return r.areEqual(Math.abs(l),1,"float")?r.areEqual(n,a,"float")?(t.normalize(),i=(new o.Vector3).crossVectors(e,t).normalize()):n<a?(i.normalize(),t=(new o.Vector3).crossVectors(i,e).normalize()):(t.normalize(),i=(new o.Vector3).crossVectors(e,t).normalize()):(t=s.normalize(),i=(new o.Vector3).crossVectors(e,t).normalize()),{xDir:t,yDir:i}}},getMatFromNormWithPos:function(e,t,i){if(e&&t){var n=e.clone().negate().normalize(),r=s.getXYAxisDirFromZ(n),a=r.xDir,l=r.yDir,c=(new o.Matrix4).makeBasis(a,l,i?n:n.negate()),u=(new o.Vector3).copy(t);return c.setPosition(u),c}},isPathToAxisSystem:function(e){if(!e||!e.externalPath)return!1;for(var t=e.externalPath.length-1;t>=0;--t){var i=e.externalPath[t];if(s.isPLMNode(i))break;if("AxisSystems"===i.name)return t}return 0},findClosestLocalAxis:function(e,t,i,n){if(e||t&&i&&n){var o,r=t,a=void 0,s=e.clone();return s=s.negate(),t&&(a=o=s.angleTo(t),r=t),i&&(o=s.angleTo(i))<a&&(a=o,r=i),n&&(o=s.angleTo(n))<a&&(a=o,r=n),r}},computeBoundingSphereofObjects:function(e,t){var i,n,o,r=0;if(t&&(r=t.length)>0){var a,l,c;for(o=0;o<r;o++)(c=t[o])&&(a=s.getLastReference(c).getLastElement())&&(n=a.getBoundingSphere(),(l=c.getWorldMatrix())&&n.applyMatrix4(l),0===o?i=n:i.mergeWithSphere(n,i))}else{var u=s.getRootReferences(e);for(r=u.length,o=0;o<r;o++)n=u[o].getBoundingSphere(),i?n&&n.radius&&i.mergeWithSphere(n,i):i=n}return i},isOOCTileSetNode:function(e,t){if(!e)return!1;var i=!1;if(!t){var n=e.children;if(n.length)for(var o=0;o<n.length&&((i=s.callPad3DViewerModelServices("isTileSetNode",n[o]))||(i=void 0!==n[o].isOOCTileSetNode?n[o].isOOCTileSetNode():i),!i);o++);}return i||(i=s.callPad3DViewerModelServices("isTileSetNode",e))||(i=void 0!==e.isOOCTileSetNode?e.isOOCTileSetNode():i),i},isOOCTileSetNodeInPath:function(e){if(e)return e.getLength()>1&&(!!s.isOOCTileSetNode(e.getLastElement(!0),!0)||s.isOOCTileSetNodeInPath(e.getParentPath()))},getLastOOCTileNode:function(t){return t.getLength()>1?s.isOOCTileSetNode(t.getLastElement(!0))?t.clone():s.getLastOOCTileNode(t.getParentPath()):new e}};return s}),define("DS/DMUMeasurable/DMUMathsBoundingGeometry",["DS/DMUMeasurable/DMUMathsVector3D"],function(e){"use strict";var t={areEqualAABB:function(e,t){return Math.abs(t[0]-e[0])<.001&&Math.abs(t[1]-e[1])<.001&&Math.abs(t[2]-e[2])<.001&&Math.abs(t[3]-e[3])<.001&&Math.abs(t[4]-e[4])<.001&&Math.abs(t[5]-e[5])<.001},computeAABBDistance:function(e,i){return Math.sqrt(t.computeAABBSquaredDistance(e,i))},computeAABBSquaredDistance:function(e,t){var i=0,n=0,o=0,r=0;return e[3]<t[0]?n=t[0]-e[3]:e[0]>t[3]&&(n=e[0]-t[3]),e[4]<t[1]?o=t[1]-e[4]:e[1]>t[4]&&(o=e[1]-t[4]),e[5]<t[2]?r=t[2]-e[5]:e[2]>t[5]&&(r=e[2]-t[5]),0===n&&0===o&&0===r||(i=n*n+o*o+r*r),i},computeAABBSquaredMaxDistance:function(e,t){var i=Math.max(Math.abs(t[0]-e[3]),Math.abs(t[3]-e[0])),n=Math.max(Math.abs(t[1]-e[4]),Math.abs(t[4]-e[1])),o=Math.max(Math.abs(t[2]-e[5]),Math.abs(t[5]-e[2]));return i*i+n*n+o*o},computeAABBForPoint:function(e){var t=[];return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[0],t[4]=e[1],t[5]=e[2],t},computeAABBForPoints:function(e){var t,i,n,o=[],r=e.length;o[0]=e[0][0],o[1]=e[0][1],o[2]=e[0][2],o[3]=o[0],o[4]=o[1],o[5]=o[2];for(var a=1;a<r;a++)t=e[a][0],i=e[a][1],n=e[a][2],t<o[0]?o[0]=t:t>o[3]&&(o[3]=t),i<o[1]?o[1]=i:i>o[4]&&(o[4]=i),n<o[2]?o[2]=n:n>o[5]&&(o[5]=n);return o},computeAABBForUnsortedPoints:function(t,i,n,o,r){var a,s,l,c,u,p=[];if(n)if(r&&!e.isIdentity(r))for(a=3*n[i],(p=e.transformPoint([o[a],o[a+1],o[a+2]],r))[3]=p[0],p[4]=p[1],p[5]=p[2],u=1;u<t;u++){a=3*n[i+u];var d=e.transformPoint([o[a],o[a+1],o[a+2]],r);s=d[0],l=d[1],c=d[2],s<p[0]?p[0]=s:s>p[3]&&(p[3]=s),l<p[1]?p[1]=l:l>p[4]&&(p[4]=l),c<p[2]?p[2]=c:c>p[5]&&(p[5]=c)}else for(a=3*n[i],p[0]=o[a],p[1]=o[a+1],p[2]=o[a+2],p[3]=p[0],p[4]=p[1],p[5]=p[2],u=1;u<t;u++)s=o[a=3*n[i+u]],l=o[a+1],c=o[a+2],s<p[0]?p[0]=s:s>p[3]&&(p[3]=s),l<p[1]?p[1]=l:l>p[4]&&(p[4]=l),c<p[2]?p[2]=c:c>p[5]&&(p[5]=c);return p},computeAABBForSegment:function(e,t){var i=[];return i[0]=Math.min(e[0],t[0]),i[1]=Math.min(e[1],t[1]),i[2]=Math.min(e[2],t[2]),i[3]=Math.max(e[0],t[0]),i[4]=Math.max(e[1],t[1]),i[5]=Math.max(e[2],t[2]),i},computeAABBForTriangle:function(e,t,i){var n=[];return n[0]=Math.min(e[0],t[0],i[0]),n[1]=Math.min(e[1],t[1],i[1]),n[2]=Math.min(e[2],t[2],i[2]),n[3]=Math.max(e[0],t[0],i[0]),n[4]=Math.max(e[1],t[1],i[1]),n[5]=Math.max(e[2],t[2],i[2]),n},intersectAABBWithRay:function(e,t,i){var n,o,r,a,s,l=!1;(Math.abs(i[0])>.001||t[0]>e[0]&&t[0]<e[3])&&(Math.abs(i[1])>.001||t[1]>e[1]&&t[1]<e[4])&&(Math.abs(i[2])>.001||t[2]>e[2]&&t[2]<e[5])&&(Math.abs(i[0])<.001?(n=-Number.MAX_VALUE,o=Number.MAX_VALUE):(s=1/i[0])>=0?(n=(e[0]-t[0])*s,o=(e[3]-t[0])*s):(n=(e[3]-t[0])*s,o=(e[0]-t[0])*s),Math.abs(i[1])<.001?(r=-Number.MAX_VALUE,a=Number.MAX_VALUE):(s=1/i[1])>=0?(r=(e[1]-t[1])*s,a=(e[4]-t[1])*s):(r=(e[4]-t[1])*s,a=(e[1]-t[1])*s),n<a&&r<o&&(r>n&&(n=r),a<o&&(o=a),Math.abs(i[2])<.001?(r=-Number.MAX_VALUE,a=Number.MAX_VALUE):(s=1/i[2])>=0?(r=(e[2]-t[2])*s,a=(e[5]-t[2])*s):(r=(e[5]-t[2])*s,a=(e[2]-t[2])*s),n<a&&r<o&&(r>n&&(n=r),a<o&&(o=a),o>0&&(l=!0))));return l},areEqualBoundingSpheres:function(e,t){return Math.abs(t[0]-e[0])<.001&&Math.abs(t[1]-e[1])<.001&&Math.abs(t[2]-e[2])<.001&&Math.abs(t[3]-e[3])<.001},computeBoundingSpheresDistance:function(t,i){return Math.max(0,e.subAndLength(t,i)-t[3]-i[3])},computeBoundingSpheresSquaredDistance:function(e,i){var n=t.computeBoundingSpheresDistance(e,i);return n*n},computeBoundingSphereForPoint:function(e){var t=[];return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t},computeBoundingSphereForPoints:function(e){var i=t.computeAABBForPoints(e),n=[i[3],i[4],i[5]];return t.computeBoundingSphereForSegment(i,n)},computeBoundingSphereForSegment:function(t,i){var n=[];return n[0]=(t[0]+i[0])/2,n[1]=(t[1]+i[1])/2,n[2]=(t[2]+i[2])/2,n[3]=e.subAndLength(t,i)/2,n},computeBoundingSphereForTriangle:function(i,n,o){var r,a=[],s=e.sub(i,n),l=e.sub(i,o),c=e.squaredLength(s),u=e.squaredLength(l),p=e.dot(s,l),d=2*(c*u-p*p);if(Math.abs(d)<=1e-6){var h=t.computeAABBForTriangle(i,n,o);r=[h[3],h[4],h[5]],a=t.computeBoundingSphereForSegment(h,r)}else{var m=(c*u-u*p)/d,y=(u*c-c*p)/d;m<=0?(r=e.add(i,o),a=e.multiply(r,.5)):y<=0?(r=e.add(i,n),a=e.multiply(r,.5)):m+y>=1?(r=e.add(n,o),a=e.multiply(r,.5)):(r=e.multiplyAndAdd(s,m,i),a=e.multiplyAndAdd(l,y,r)),a[3]=e.subAndLength(a,i)}return a}};return t}),define("DS/DMUMeasurable/DMUMathsInfiniteGeometry",["DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUMeasureEnums"],function(e,t,i){"use strict";var n=.001,o={computeTwoPointsDistance:function(i,o){var r={returnCode:1};return i&&o&&(r.returnCode=0,r.distance=e.subAndLength(i,o),r.relationship=r.distance<n?t.Relationship.COINCIDENT:t.Relationship.NONE),r},computePointLineDistance:function(i,o,r){var a={returnCode:1};if(i&&o&&r){var s=e.squaredLength(r);if(s>1e-6){a.returnCode=0;var l=e.dot(e.sub(o,i),r)/s;a.aPosition=e.multiplyAndAdd(r,l,o),a.distance=e.subAndLength(i,a.aPosition),a.relationship=a.distance<n?t.Relationship.COINCIDENT:t.Relationship.NONE}}return a},computePointPlaneDistance:function(i,o,r){var a={returnCode:1};if(i&&o&&r){var s=e.squaredLength(r);if(s>1e-6){a.returnCode=0;var l=e.dot(e.sub(i,o),r)/s;a.aPosition=e.multiplyAndAdd(r,l,i),a.distance=e.subAndLength(i,a.aPosition),a.relationship=a.distance<n?t.Relationship.COINCIDENT:t.Relationship.NONE}}return a},computeTwoLinesDistance:function(i,o,r,a){var s={returnCode:1};if(i&&o&&r&&a){s.returnCode=0;var l=e.sub(r,i),c=e.squaredLength(o),u=e.dot(o,a),p=e.squaredLength(a),d=e.dot(o,l),h=e.dot(a,l),m=c*p-u*u,y=0,g=0;m<n?(y=0,g=u>p?d/u:h/p,s.aPosition1=e.clone(i),s.aPosition2=e.multiplyAndAdd(a,g,r),s.distance=e.subAndLength(s.aPosition1,s.aPosition2),s.relationship=s.distance<n?t.Relationship.COINCIDENT:t.Relationship.PARRALLEL,s.angle=0):(y=(u*h-p*d)/m,g=(c*h-u*d)/m,s.aPosition1=e.multiplyAndAdd(o,y,i),s.aPosition2=e.multiplyAndAdd(a,g,r),s.distance=e.subAndLength(s.aPosition1,s.aPosition2),s.relationship=s.distance<n?t.Relationship.INTERSECTING:t.Relationship.NONE,s.angle=e.angle(o,a))}return s},computeLinePlaneDistance:function(i,r,a,s){var l={returnCode:1};if(i&&r&&a&&s){l.returnCode=0;var c=e.normalize(r),u=e.normalize(s),p=e.dot(c,u);if(Math.abs(p)<n){l.angle=0;var d=o.computePointPlaneDistance(i,a,u);0===d.returnCode&&d.distance<n?(l.distance=0,l.aPosition=e.clone(i),l.relationship=t.Relationship.COINCIDENT):(l.distance=d.distance,l.aPosition=d.aPosition,l.relationship=t.Relationship.PARRALLEL)}else{l.distance=0,l.angle=Math.asin(p);var h=e.dot(e.sub(i,a),u)/p;l.aPosition=e.multiplyAndAdd(c,h,i),l.relationship=t.Relationship.INTERSECTING}}return l},computeTwoPlanesDistance:function(i,r,a,s){var l={returnCode:1};if(i&&r&&a&&s){l.returnCode=0;var c=e.normalize(r),u=e.normalize(s);if(e.areEqual(c,u)||e.isNull(e.add(c,u))){l.angle=0;var p=e.areEqual(c,u)?1:-1,d=e.dot(i,c),h=e.dot(a,u);l.distance=Math.abs(d-p*h),l.aPosition1=i;var m=o.computePointPlaneDistance(i,a,u);l.aPosition2=m.aPosition,l.relationship=l.distance<n?t.Relationship.COINCIDENT:t.Relationship.PARRALLEL}else{l.distance=0,l.angle=Math.acos(e.dot(c,u));var y=e.cross(c,u),g=e.cross(c,y),P=e.cross(u,y),f=o.computeLinePlaneDistance(a,P,i,c);l.aPosition1=f.aPosition;var v=o.computeLinePlaneDistance(i,g,a,u);l.aPosition2=v.aPosition,l.relationship=t.Relationship.INTERSECTING}}return l},measureBetweenInfinite:function(r,a,s,l){var c,u={},p=[],d=[],h=[r,s],m=[{_selectedType:a},{_selectedType:l}],y=m[0],g=m[1],P=!1;switch(function(){for(var e=0;e<2;e++){var n,o=h[e].getType();if(m[e].realType=o,m[e]._selectedType===i.ViewedType.POINT)m[e].type=t.GeometryType.POINT,m[e].position=h[e].getSelPoint(),o===t.GeometryType.CIRCLE||o===t.GeometryType.PLANE?m[e].normal=h[e]._normal:o!==t.GeometryType.CYLINDER&&o!==t.GeometryType.SPHERE&&o!==t.GeometryType.CONE&&o!==t.GeometryType.SURFACE||h[e].getSelNormal&&h[e]._selNormal&&(m[e].normal=h[e].getSelNormal());else if(o===t.GeometryType.POINT||o===t.GeometryType.PICKINGPT)m[e].type=t.GeometryType.POINT,m[e].position=h[e].getPoint();else if(o===t.GeometryType.LINE)m[e].type=t.GeometryType.LINE,n=h[e].getPoints(),m[e].position=h[e].getSelPoint(),m[e].direction=n.endPoint.sub(n.beginPoint);else if(o===t.GeometryType.CIRCLE)m[e]._selectedType===i.ViewedType.CENTER?(m[e].type=t.GeometryType.POINT,m[e].position=h[e].getCenter()):(m[e].type=t.GeometryType.LINE,m[e].position=h[e].getCenter(),m[e].direction=h[e].getAxis()),h[e]._normal&&(m[e].normal=h[e]._normal);else if(o===t.GeometryType.CYLINDER)m[e].type=t.GeometryType.LINE,n=h[e].getPoints(),m[e].position=n.beginPoint,m[e].direction=n.endPoint.sub(n.beginPoint);else if(o===t.GeometryType.CONE)m[e].type=t.GeometryType.LINE,n=h[e].getPoints(),m[e].position=n.beginPoint,m[e].direction=n.endPoint.sub(n.beginPoint);else if(o===t.GeometryType.SPHERE)m[e].type=t.GeometryType.POINT,m[e].position=h[e].getCenter();else if(o===t.GeometryType.PLANE){m[e].type=t.GeometryType.PLANE;var r=h[e].getPlane();m[e].origin=h[e].getSelPoint(),m[e].normal=r.normal}}(m[0].type===t.GeometryType.LINE&&m[1].type===t.GeometryType.PLANE||m[0].type===t.GeometryType.POINT||m[0].type===t.GeometryType.PICKINGPT)&&(y=m[1],g=m[0],P=!0)}(),y.type){case t.GeometryType.PLANE:d[0]=i.ViewedType.INFPLANE,g.type===t.GeometryType.PLANE?(d[1]=i.ViewedType.INFPLANE,(c=o.computeTwoPlanesDistance(y.origin.toArray(),y.normal.toArray(),g.origin.toArray(),g.normal.toArray()))&&0===c.returnCode&&(u.distance=c.distance,u.angle=c.angle>Math.PI/2?Math.PI-c.angle:c.angle,u.relationship=c.relationship,c.relationship===t.Relationship.INTERSECTING?(p[0]=e.clone(c.aPosition1),p[1]=e.clone(c.aPosition2)):(p[0]=y.origin.toArray(),p[1]=c.aPosition2))):g.type===t.GeometryType.LINE?(d[1]=i.ViewedType.AXIS,(c=o.computeLinePlaneDistance(g.position.toArray(),g.direction.toArray(),y.origin.toArray(),y.normal.toArray()))&&0===c.returnCode&&(u.distance=c.distance,u.angle=c.angle>Math.PI/2?Math.PI-c.angle:c.angle,u.relationship=c.relationship,c.relationship===t.Relationship.INTERSECTING?(p[0]=c.aPosition,p[1]=c.aPosition):(p[0]=c.aPosition,p[1]=g.position.toArray()),u.aExtension=g.direction.toArray())):(d[1]=i.ViewedType.POINT,(c=o.computePointPlaneDistance(g.position.toArray(),y.origin.toArray(),y.normal.toArray()))&&0===c.returnCode&&(u.distance=c.distance,u.relationship=c.relationship,p[0]=c.aPosition,p[1]=g.position.toArray()));break;case t.GeometryType.LINE:d[0]=i.ViewedType.AXIS,g.type===t.GeometryType.LINE?(d[1]=i.ViewedType.AXIS,(c=o.computeTwoLinesDistance(y.position.toArray(),y.direction.toArray(),g.position.toArray(),g.direction.toArray()))&&0===c.returnCode&&(u.distance=c.distance,u.angle=c.angle>Math.PI/2?Math.PI-c.angle:c.angle,u.relationship=c.relationship,c.relationship===t.Relationship.INTERSECTING||c.relationship===t.Relationship.NONE?(p[0]=c.aPosition1,p[1]=c.aPosition2,u.aExtension=e.sub(y.position.toArray(),c.aPosition1)):(p[0]=y.position.toArray(),p[1]=c.aPosition2,y.realType===t.GeometryType.CIRCLE||y.realType===t.GeometryType.CYLINDER||y.realType===t.GeometryType.CONE||(y.realType,t.GeometryType.SPHERE)))):(d[1]=i.ViewedType.POINT,(c=o.computePointLineDistance(g.position.toArray(),y.position.toArray(),y.direction.toArray()))&&0===c.returnCode&&(u.distance=c.distance,u.relationship=c.relationship,p[0]=c.aPosition,p[1]=g.position.toArray())),u.aExtension=y.direction.toArray();break;default:!function(){if(d[0]=i.ViewedType.POINT,d[1]=i.ViewedType.POINT,p[0]=y.position.toArray(),p[1]=g.position.toArray(),(c=o.computeTwoPointsDistance(p[0],p[1]))&&0===c.returnCode&&(u.distance=c.distance,u.relationship=c.relationship,g.normal&&y.normal)){var e=g.position.clone().sub(y.position),t=y.normal.angleTo(e),r=g.normal.angleTo(e);Math.abs(t-r)<n&&Math.abs(t-Math.PI/2)<n&&(u.aExtension=y.normal.toArray())}}()}return P?(u.aPosition1=p[1],u.aPosition2=p[0],u.type1=d[1],u.type2=d[0]):(u.aPosition1=p[0],u.aPosition2=p[1],u.type1=d[0],u.type2=d[1]),u}};return o}),define("DS/DMUMeasurable/DMUMeshServices",["DS/DMUMeasurable/DMUToolsMaths","DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUMathsBoundingGeometry"],function(e,t,i){"use strict";var n={verifyMesh:function(e){var t=void 0!==e&&void 0!==e.getGroup()&&void 0!==e.getGroup().glType&&void 0!==e.getGroup().geometry;return t=t&&void 0!==e.getCount()&&e.getCount()>0&&void 0!==e.getGroup().geometry.vertexIndexArray},extractMeshVertices:function(e,i,n,o){var r=[],a=e.getCount();n&&n<a&&(a=n);var s=o||!1,l=e.getStart(),c=e.getGroup().geometry;if(c&&c.vertexIndexArray&&c.vertexPositionArray){var u,p=c.vertexIndexArray,d=c.vertexPositionArray,h=0,m=0;if(i&&!t.isIdentity(i))if(s){var y=[];for(h=0;h<a;h++){u=3*p[l+h];var g=!1;for(m=0;!g&&m<y.length;m++)g=u===y[m];g||(r.push(t.transformPoint([d[u],d[u+1],d[u+2]],i)),y.push(u))}}else for(h=0;h<a;h++)u=3*p[l+h],r[h]=t.transformPoint([d[u],d[u+1],d[u+2]],i);else if(s){var P=[];for(h=0;h<a;h++){u=3*p[l+h];var f=!1;for(m=0;!f&&m<P.length;m++)f=u===P[m];f||(r.push([d[u],d[u+1],d[u+2]]),P.push(u))}}else for(m=0;m<a;m++)u=3*p[l+m],r[m]=[d[u],d[u+1],d[u+2]]}return r},extractMeshNormals:function(e,i,o,r){var a=[];if(n.verifyMesh(e)){var s=e.getCount();o&&o<s&&(s=o);var l,c=r||!1,u=e.getStart(),p=e.getGroup().geometry,d=p.vertexIndexArray,h=p.vertexNormalArray,m=0,y=0;if(d)if(i&&!t.isIdentity(i))if(c){var g=[];for(m=0;m<s;m++){l=3*d[u+m];var P=!1;for(y=0;!P&&y<g.length;y++)P=l===g[y];P||(a.push(t.transformVector([h[l],h[l+1],h[l+2]],i)),g.push(l))}}else for(m=0;m<s;m++)l=3*d[u+m],a[m]=t.transformVector([h[l],h[l+1],h[l+2]],i);else if(c){var f=[];for(m=0;m<s;m++){l=3*d[u+m];var v=!1;for(y=0;!v&&y<f.length;y++)v=l===f[y];v||(a.push([h[l],h[l+1],h[l+2]]),f.push(l))}}else for(y=0;y<s;y++)l=3*d[u+y],a[y]=[h[l],h[l+1],h[l+2]]}return a},computeAABB:function(e,t){var n=e.getCount(),o=e.getStart(),r=e.getGroup().geometry,a=r.vertexIndexArray,s=r.vertexPositionArray;return i.computeAABBForUnsortedPoints(n,o,a,s,t)},computeBoundingSphere:function(e,t){var o=n.extractMeshVertices(e,t);return i.computeBoundingSphereForPoints(o)},_computeVolume:function(i,o){var r={returnCode:1};if(4===i.getGroup().glType){for(var a=n.extractMeshVertices(i),s=a.length/3,l=0,c=[0,0,0],u=[0,0,0],p=[0,0,0],d=[0,0,0],h=[0,0,0],m=[0,0,0],y=0;y<s;y++){u=t.sub(o,a[3*y],u),p=t.sub(o,a[3*y+1],p);var g=-(d=t.sub(o,a[3*y+2],d))[0]*p[1]*u[2]+p[0]*d[1]*u[2]+d[0]*u[1]*p[2]-u[0]*d[1]*p[2]-p[0]*u[1]*d[2]+u[0]*p[1]*d[2];h=t.add(u,t.add(p,d,h),h),l+=g,c=t.multiplyAndAdd(h,g,c,m)}r.returnCode=0,r.volume=l/6,r.aCog=e.isZero(l)?[0,0,0]:t.multiplyAndAdd(c,1/(4*l),o)}return r}};return n}),define("DS/DMUMeasurable/DMUMeshRecognition",["DS/DMUMeasurable/DMUToolsMaths","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUMeshServices","DS/Visualization/ThreeJS_DS","DS/WebPolyMaths/WebMeshRecognition","DS/Visualization/Measurable"],function(e,t,i,n,o,r,a,s){"use strict";var l=.1,c=.02,u={recognizeCanonicGeometry:function(e,i,n){var r,l,c={};if(c.returnCode=1,e.getDecoration()&&(!function(){var a=new s(e);switch(a.getType()){case s.TYPEUNKNOWN:1===(r=o.extractMeshVertices(e)).length&&(c.returnCode=0,c.type=t.GeometryType.POINT,c.position=u._buildVector3(r[0]).applyMatrix4(i));break;case s.TYPEPLANE:var p=a.getPlane();p&&(c.returnCode=0,c.type=t.GeometryType.PLANE,c.origin=u._buildVector3(p.position).applyMatrix4(i),c.normal=u._buildVector3(p.normal).transformDirection(i));break;case s.TYPECYLINDER:var d=a.getCylinder();if(d)if(c.returnCode=0,c.type=t.GeometryType.CYLINDER,c.radius=d.radius,n){r=o.extractMeshVertices(e);var h=u._computeMinMaxProjection(r,d.axis,d.center);0===h.returnCode&&(c.point1=u._buildVector3(h.aPoint1).applyMatrix4(i),c.point2=u._buildVector3(h.aPoint2).applyMatrix4(i))}else c.point1=u._buildVector3(d.center).applyMatrix4(i),c.point2=c.point1.clone().sub(u._buildVector3(d.axis)).applyMatrix4(i);break;case s.TYPECONE:var m=a.getCone();if(m){if(c.returnCode=0,c.type=t.GeometryType.CONE,c.semiAngle=m.semiAngle>Math.PI/2?m.semiAngle*Math.PI/180:m.semiAngle,c.apex=u._buildVector3(m.center).applyMatrix4(i),c.axis=u._buildVector3(m.axis).transformDirection(i),n){r=o.extractMeshVertices(e);var y=!0;c.semiAngle>Math.PI/2&&(y=!1),0===(l=u._computeMinMaxProjection(r,m.axis,m.center,y)).returnCode&&(c.point1=u._buildVector3(l.aPoint1).applyMatrix4(i),c.point2=u._buildVector3(l.aPoint2).applyMatrix4(i))}else c.point1=u._buildVector3(m.center).applyMatrix4(i),c.point2=c.point1.clone().sub(u._buildVector3(m.axis)).applyMatrix4(i);if(l&&l.baseRadius){var g=l.baseRadius/Math.tan(c.semiAngle),P=c.axis.clone().normalize().negate().multiplyScalar(g);c.apex=c.point2.clone().add(P),c.baseRadius=l.baseRadius,l.topRadius&&(c.topRadius=l.topRadius)}}break;case s.TYPESPHERE:var f=a.getSphere();f&&(c.returnCode=0,c.type=t.GeometryType.SPHERE,c.radius=f.radius,c.center=u._buildVector3(f.center).applyMatrix4(i));break;case s.TYPELINE:var v=a.getLine();v&&(c.returnCode=0,c.type=t.GeometryType.LINE,c.point1=u._buildVector3(v.startPosition).applyMatrix4(i),c.point2=u._buildVector3(v.endPosition).applyMatrix4(i));break;case s.TYPECIRCLE:var T=a.getCircle();T&&(c.returnCode=0,c.type=t.GeometryType.CIRCLE,c.radius=T.radius,c.center=u._buildVector3(T.center).applyMatrix4(i),c.normal=u._buildVector3(T.axis).transformDirection(i))}}(),c.exact=0===c.returnCode),1===c.returnCode){if(void 0===e._bNotRecognized){if(o.verifyMesh(e)){r=o.extractMeshVertices(e);var p=e.getGroup().glType,d=r.length;if(1===d)c.returnCode=0,c.type=t.GeometryType.POINT,c.position=u._buildVector3(r[0]).applyMatrix4(i);else if(2===d)0===(c=a._recognizeLine(r)).returnCode&&(c.point1=u._buildVector3(c.aPoint1).applyMatrix4(i),c.point2=u._buildVector3(c.aPoint2).applyMatrix4(i));else if(1===p)0===(l=a._recognizeCircle(r)).returnCode?((c=l).center=u._buildVector3(c.aCenter).applyMatrix4(i),c.normal=u._buildVector3(c.aNormal).transformDirection(i)):0===(c=a._recognizeLine(r)).returnCode&&(c.point1=u._buildVector3(c.aPoint1).applyMatrix4(i),c.point2=u._buildVector3(c.aPoint2).applyMatrix4(i));else if(4===p)if(0===(l=u._recognizePlane(r)).returnCode)(c=l).origin=u._buildVector3(c.aOrigin).applyMatrix4(i),c.normal=u._buildVector3(c.aNormal).transformDirection(i);else{var h=o.extractMeshNormals(e);0===(c=u._recognizeCylinder(r,h)).returnCode?(c.point1=u._buildVector3(c.aPoint1).applyMatrix4(i),c.point2=u._buildVector3(c.aPoint2).applyMatrix4(i)):0===(c=u._recognizeSphere(r,h)).returnCode?c.center=u._buildVector3(c.aCenter).applyMatrix4(i):0===(c=u._recognizeCone(r,h)).returnCode&&(c.apex=u._buildVector3(c.aApex).applyMatrix4(i),c.axis=u._buildVector3(c.aAxis).applyMatrix4(i),c.point1=u._buildVector3(c.aPoint1).applyMatrix4(i),c.point2=u._buildVector3(c.aPoint2).applyMatrix4(i))}}1===c.returnCode&&(e._bNotRecognized=!0)}c.exact=!1}return c},recognizeNonCanonicGeometry:function(e,t,i){var n={returnCode:1};if(o.verifyMesh(e)){var r=o.extractMeshVertices(e,t.elements),a=e.getGroup().glType;if(1===a){var s=u._recognizeCircle(r,i);0===s.returnCode&&i?((n=s).center=u._buildVector3(n.aCenter).applyMatrix4(t),n.normal=u._buildVector3(n.aNormal).transformDirection(t)):0===(n=u._recognizeCurve(r,i)).returnCode&&i&&(n.point1=u._buildVector3(n.aPoint1),n.point2=u._buildVector3(n.aPoint2))}else 4===a&&0===(n=u._recognizeSurface(r,i)).returnCode&&i&&(n.cog=u._buildVector3(n.aCog))}return n},_recognizeLine:function(n){var o={returnCode:1},r=n.length;if(2===r)o.returnCode=0,o.type=t.GeometryType.LINE,o.aPoint1=n[0],o.aPoint2=n[1];else if(r>2){for(var a,s=i.sub(n[1],n[0]),l=!0,c=1;l&&c<r;c++)a=i.sub(n[c],n[0]),l=e.isZero(i.length(i.cross(s,a)));if(l){for(var u=0,p=1,d=0,h=i.dot(s,s),m=2;m<r;m++){a=i.sub(n[m],n[0]);var y=i.dot(s,a);y<d?(u=m,d=y):y>h&&(p=m,h=y)}o.returnCode=0,o.type=t.GeometryType.LINE,o.aPoint1=n[u],o.aPoint2=n[p]}}return o},_recognizePlane:function(n){for(var o,r,a={returnCode:1},s=n.length,u=0,p=0,d=1;d<s&&0===p;d++)if(0===u)o=i.sub(n[0],n[d]),i.length(o)>l&&(u=d);else if(0===p&&(r=i.sub(n[0],n[d]),i.length(r)>l)){var h=i.angle(o,r);h>c&&h<Math.PI-c&&(p=d)}if(0!==u&&0!==p){for(var m=i.cross(o,r),y=!0,g=0;y&&g<s;g++)if(0!==g&&g!==u&&g!==p){var P=i.sub(n[0],n[g]),f=i.cross(o,P);if(!e.isZero(i.length(f))){var v=i.angle(m,f);y=!(v>c&&v<Math.PI-c)}}y&&(a.returnCode=0,a.type=t.GeometryType.PLANE,a.aOrigin=n[0],a.aNormal=i.normalize(m))}return a},_recognizeCircle:function(n){var o={returnCode:1},r=n.length;if(r>6){var a=u._recognizePlane(n);if(a&&a.type===t.GeometryType.PLANE){var s=a.aNormal,l=Math.floor(2*r/3),c=Math.floor(r/3),p=u._computeCircleThru3Points(n[0],n[c],n[l]);if(0===p.returnCode){for(var d=p.radius,h=p.aCenter,m=!0,y=0;m&&y<r;y++){var g=i.length(i.sub(n[y],h));m=e.areEqual(d,g,"float",.0017)}if(m){o.returnCode=0,o.type=t.GeometryType.CIRCLE,o.radius=p.radius,o.aCenter=p.aCenter,o.aNormal=s,o.length=2*Math.PI*p.radius;var P=i.sub(n[0],p.aCenter),f=Math.ceil(r/2),v=i.sub(n[f-1],p.aCenter),T=i.sub(n[r-1],p.aCenter),C=i.angle(P,v)+i.angle(v,T);o.arcLength=o.length*(C/(2*Math.PI))}}}}return o},_recognizeCylinder:function(e,n,o){var r,a,s,p={},d=!1,h=!0;p.returnCode=1;var m=o&&o<=e.length?o:e.length,y=!0;if(m>50){var g=u._recognizeCylinder(e,n,50);y=void 0!==g&&void 0!==g.type&&g.type===t.GeometryType.CYLINDER}if(y){if(m>7)for(var P=0;P<m;P++)for(var f=P+1;f<m;f++)if(a=i.cross(n[P],n[f]),d){var v=i.dot(s,a);r=i.add(r,i.multiply(a,v))}else i.length(a)>l&&(d=!0,s=a,r=a);if(r){s=i.normalize(r),r=[0,0,0];for(var T=0,C=[],_=0;_<m;_++)a=i.cross(n[_],s),i.length(a)/i.length(n[_])>.7?(T++,C[_]=1):C[_]=0;if(T>1?function(e,t){for(var o=0;o<e&&1===t[o];o++)for(var u=o+1;u<e&&1===t[u];u++)if(a=i.cross(n[o],n[u]),d){var p=i.dot(s,a);r=i.add(r,i.multiply(a,p))}else i.length(a)>l&&(d=!0,s=a,r=a);r=i.normalize(r);for(var m=0;m<e&&1===t[m]&&h;m++)a=i.cross(n[m],r),1-i.length(a)/i.length(n[m])>c&&(h=!1)}(m,C):h=!1,l>=i.length(r)&&(h=!1),h){for(var M,S=0,E=[],N=0,D=0,b=0,A=0,R=0;R<m;R++){M=i.dot(i.sub(e[0],e[R]),r);for(var w=i.sub(i.multiply(r,M),e[R]),V=!1,I=0;I<S&&!V;I++){V=i.subAndLength(E[I],w)<l}V||(E[S]=w,S++),M>b&&(b=M,A=R),M<N&&(N=M,D=R)}var x=u._recognizeCircle(E);if(x&&x.type===t.GeometryType.CIRCLE){M=i.dot(i.sub(x.aCenter,e[D]),r);var G=i.add(i.multiply(r,M),x.aCenter);M=i.dot(i.sub(x.aCenter,e[A]),r);var L=i.add(i.multiply(r,M),x.aCenter);p.returnCode=0,p.type=t.GeometryType.CYLINDER,p.radius=x.radius,p.aPoint1=G,p.aPoint2=L}}}}return p},_recognizeCone:function(o,r,a,s){var l,p,d,h={};h.returnCode=1;var m=a&&a<=o.length?a:o.length,y=s&&s<=r.length?s:r.length,g=!0;if(m>50){var P=u._recognizeCone(o,r,50,50);g=void 0!==P&&void 0!==P.type&&P.type===t.GeometryType.CONE}if(g){if(3<m){for(var f=[],v=1;v<m;v++)i.areEqual(o[0],o[v])||f.push(o[v]);var T=u._recognizeCircle(f);T&&T.type===t.GeometryType.CIRCLE&&(l=i.sub(T.aCenter,o[0]),i.areEqual(i.normalize(l),T.aNormal)&&(h.returnCode=0,h.type=t.GeometryType.CONE,h.aApex=o[0],h.aPoint1=o[0],h.aPoint2=T.aCenter,h.aAxis=T.aNormal,h.semiAngle=i.angle(i.sub(o[1],o[0]),l)))}0!==h.returnCode&&m===y&&function(){for(var a=!1,s=-1,g=-1,P=-1,f=-1,v=0;v<y&&!a;v++)for(var T=v+1;T<y&&!a;T++)i.areEqual(r[v],r[T])&&!i.areEqual(o[v],o[T])&&(0>s?(s=v,P=T):i.areEqual(r[s],r[v])||(g=v,f=T,a=!0));if(0<=s&&0<=P&&0<=g&&0<=f){var C=i.sub(o[s],o[P]),_=i.cross(C,r[s]),M=i.sub(o[g],o[f]),S=i.cross(M,r[g]),E=!1,N=i.angle(_,S);if(N>c&&N<Math.PI-c?0===(p=n.computeLinePlaneDistance(o[s],C,o[g],S)).returnCode&&p.relationship===t.Relationship.INTERSECTING&&0===(d=n.computeLinePlaneDistance(o[s],r[s],o[g],S)).returnCode&&d.relationship===t.Relationship.INTERSECTING&&(E=!0,h.aApex=p.aPosition,h.aAxis=i.normalize(i.sub(p.aPosition,d.aPosition))):0===(p=n.computeTwoLinesDistance(o[s],C,o[g],M)).returnCode&&p.relationship===t.Relationship.INTERSECTING&&0===(d=n.computeTwoLinesDistance(o[s],r[s],o[g],r[g])).returnCode&&d.relationship===t.Relationship.INTERSECTING&&(E=!0,h.aApex=p.aPosition1,h.aAxis=i.normalize(i.sub(p.aPosition1,d.aPosition1))),E&&h.aAxis){h.semiAngle=i.angle(C,h.aAxis);for(var D=0;D<m&&E;D++)l=i.sub(h.aApex,o[D]),N=i.angle(l,h.aAxis),E=e.areEqual(h.semiAngle,N);if(E){h.returnCode=0,h.type=t.GeometryType.CONE;var b=u._computeMinMaxProjection(o,h.aAxis,h.aApex);h.aPoint1=b.aPoint1,h.aPoint2=b.aPoint2}}}}()}return h},_recognizeSphere:function(n,o){var r={returnCode:1},a=n.length;if(a===o.length){for(var s,p,d,h,m,y=0,g=0,P=0,f=1;f<a&&0===P;f++)0===y?(s=i.sub(n[0],n[f]),i.length(s)>l&&(y=f)):0===g?(p=i.sub(n[0],n[f]),i.length(p)>l&&(m=i.angle(s,p))>c&&m<Math.PI-c&&(g=f,h=i.cross(s,p))):0===P&&(d=i.sub(n[0],n[f]),i.length(d)>l&&(m=i.angle(h,i.cross(s,d)))>c&&m<Math.PI-c&&(P=f));if(0!==y&&0!==g&&0!==P){var v=u._computeSphereThru4Points(n[0],n[y],n[g],n[P]);if(0===v.returnCode){for(var T,C,_=!0,M=0;M<a&&_;M++)C=i.sub(n[M],v.aCenter),T=i.length(C),_=e.areEqual(v.radius,T)&&i.areEqual(i.normalize(C),i.normalize(o[M]));_&&(r.returnCode=0,r.type=t.GeometryType.SPHERE,r.aCenter=v.aCenter,r.radius=v.radius)}}}return r},_recognizeCurve:function(e,n){var o={returnCode:0};if(o.type=t.GeometryType.CURVE,o.length=0,n){for(var r=e.length,a=0,s=0;s<r;s+=2)a+=i.length(i.sub(e[s],e[s+1]));o.length=a,o.aPoint1=e[0],o.aPoint2=e[r-1]}return o},_recognizeSurface:function(n,o){var r={returnCode:1};if(r.type=t.GeometryType.SURFACE,r.area=0,o){for(var a=n.length/3,s=0,l=[0,0,0],c=0;c<a;c++){var u=i.sub(n[3*c],n[3*c+1]),p=i.sub(n[3*c],n[3*c+2]),d=i.length(i.cross(u,p)),h=i.add(n[3*c],i.add(n[3*c+1],n[3*c+2]));s+=d,l=i.multiplyAndAdd(h,d,l)}r.returnCode=0,r.area=s/2,r.aCog=e.isZero(s)?[0,0,0]:i.multiply(l,1/(3*s))}return r},_computeMinMaxProjection:function(e,t,o,r){for(var a,s={returnCode:0},l=e.length,c=i.normalize(t),u=Number.MAX_VALUE,p=-Number.MAX_VALUE,d=[0,0,0],h=0,m=-1,y=0;y<l;y++)if((a=i.dot(i.sub(o,e[y],d),c))>p&&(p=a),a<u&&(u=a),r){var g=n.computePointLineDistance(e[y],o,t);g.distance>h&&(h=g.distance),(-1===m||g.distance<m)&&(m=g.distance)}return s.aPoint1=i.multiplyAndAdd(c,u,o),s.aPoint2=i.multiplyAndAdd(c,p,o),r&&(s.baseRadius=h,s.topRadius=m),s},_computeCircleThru3Points:function(e,n,o){var r={returnCode:1},a=i.sub(e,n),s=i.sub(n,o),l=i.cross(a,s);if(i.areEqual(e,n))r.aCenter=i.multiply(i.add(e,o),.5),l=i.cross([0,0,1],s);else if(i.areEqual(e,o))r.aCenter=i.multiply(i.add(e,n),.5),l=i.cross([0,0,1],a);else if(i.areEqual(n,o))r.aCenter=i.multiply(i.add(e,n),.5),l=i.cross([0,0,1],a);else{var c=i.squaredLength(l);if(c>1e-6){var u=(.5*i.squaredLength(s)+.5*i.dot(a,s))/c,p=i.multiplyAndAdd(a,.5,e);r.aCenter=i.multiplyAndAdd(i.cross(a,l),-u,p)}}return void 0!==r.aCenter&&(r.returnCode=0,r.type=t.GeometryType.CIRCLE,r.radius=i.subAndLength(r.aCenter,e),r.aNormal=i.normalize(l)),r},_computeSphereThru4Points:function(e,o,r,a){var s={returnCode:1},l=u._computeCircleThru3Points(e,o,r);if(0===l.returnCode){var c=u._computeCircleThru3Points(o,r,a);if(0===c.returnCode){var p=n.computeTwoLinesDistance(l.aCenter,l.aNormal,c.aCenter,c.aNormal);0===p.returnCode&&p.relationship===t.Relationship.INTERSECTING&&(s.returnCode=0,s.type=t.GeometryType.SPHERE,s.aCenter=p.aPosition1,s.radius=i.subAndLength(s.aCenter,e))}}return s},_buildVector3:function(e){return new r.Vector3(e[0],e[1],e[2])},verifyMesh:function(e){return window.console.log("DEPRECATED: use DMUMeshServices.verifyMesh"),o.verifyMesh(e)},extractMeshVertices:function(e,t){return window.console.log("DEPRECATED: use DMUMeshServices.extractMeshVertices"),o.extractMeshVertices(e,t)},extractMeshNormals:function(e,t){return window.console.log("DEPRECATED: use DMUMeshServices.extractMeshNormals"),o.extractMeshNormals(e,t)}};return u}),define("DS/DMUMeasurable/DMUToolsAvatars",["DS/DMUMeasurable/DMUToolsMaths","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/FixedSizeNode3D","DS/Visualization/Node3D","DS/Robot/LineTranslationNode"],function(e,t,i,n,o,r){"use strict";return{createCrossNode:function(o,r,a,s){var l=new t.Vector3(o,0,0),c=new t.Vector3(0,o,0),u=new t.Vector3,p=u.clone().add(l).add(c),d=u.clone().sub(l).add(c),h=u.clone().add(l).sub(c),m=[p,u.clone().sub(l).sub(c),u,d,h],y=i.createLineNode({points:m,material:s});y.setShadow(!1);var g=new n({name:"myFixedSizeNode",ratio:1});g.add(y);var P=e.computeTransformationBetweenTwoLines(new t.Vector3,new t.Vector3(0,0,1),r,a);return g.setMatrix(P.transformation),g},createLineNode:function(e,t,n){var o=[e.clone(),t.clone()],r=i.createLineNode({points:o,material:n});return r.setShadow(!1),r},createRectangleNode:function(n,o,r,a,s,l){var c=!1;l&&(c=l);var u=i.createRectangleNode({width:n,height:o,material:s,fill:c});u.setShadow(!1);var p=e.computeTransformationBetweenTwoLines(new t.Vector3(n/2,o/2,0),new t.Vector3(0,0,1),r,a);return u.setMatrix(p.transformation),u.setNoHighlightNoZ(!0),u},createCircleNode:function(n,o,r,a){var s=Math.round(2*Math.PI/Math.acos(1-.2/n)),l=i.createCircleNode({radius:n,segments:s,material:a});l.setShadow(!1);var c=e.computeTransformationBetweenTwoLines(new t.Vector3,new t.Vector3(0,0,1),o,r);return l.setMatrix(c.transformation),l},createArcNode:function(e,n,o,r,a,s){var l=Math.round(2*Math.PI/Math.acos(1-.2/e)),c=o.angleTo(r),u=0;void 0!==s&&!0===s&&(u=c,c=2*Math.PI);var p=i.createCircleNode({radius:e,segments:l,startAngle:u,endAngle:c,material:a});p.setShadow(!1);var d=o.clone().normalize(),h=o.clone().cross(r).normalize(),m=h.clone().cross(o).normalize(),y=new t.Matrix4(d.x,m.x,h.x,0,d.y,m.y,h.y,0,d.z,m.z,h.z,0,0,0,0,1);return p.setMatrix(y.setPosition(n)),p},createSurfaceNode:function(e,t,n){var r,a=!1;n&&(a=n);var s=new o,l=e/2,c=Math.round(2*Math.PI/Math.acos(1-.2/l));return(r=i.createCircleNode({radius:l,segments:c,material:t,fill:a})).setShadow(!1),s.addChild(r),s},createArrowNormalNode:function(){var e,i={position:new t.Vector3(0,0,0),touchMode:!1},a=new o,s=new n({name:"fixedSizeNode3D",ratio:7});return(e=new r(i)).name="normalArrowTranslationNode",e.mat.color=new t.Color(15096832),e.mat.opacity=1,e.setNoHighlightNoZ(!0),s.addChild(e),a.addChild(s),a}}}),define("DS/DMUMeasurable/DMUPreVisuNode3D",["DS/DMUMeasurable/DMUMeasureEnums","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUToolsAvatars","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUToolsMaterial","DS/DMUMeasurable/DMUToolsMaths","DS/SceneGraphNodes/AxisSystemNode","DS/Mesh/MeshUtils","DS/DMUMeasurable/DMUToolsSceneGraph"],function(e,t,i,n,o,r,a,s,l,c,u,p,d){"use strict";return r.extend({init:function(h){this._parent();var m,y,g=h;function P(e,t){t.setPickParent(!0),t.setVisibilityInTree(!1),e.addChild(t)}function f(e){if(e){var t=(new n.Matrix4).lookAt(new n.Vector3,e.getSightDirection(),e.getUpDirection()),i=(new n.Quaternion).setFromRotationMatrix(t),o=c.quaternionToAxisSystem(i);return{position:e.getEyePosition(),sight:e.getSightDirection(),right:o.X,up:e.getUpDirection(),distance:e.getTargetDistance(),angle:e.getAngle(),projectionType:e.getProjectionType()}}}function v(e,t,i){var o=function(e,t){var i=(new n.Projector).projectVector(t.clone(),e.viewpoints[0].getCamera()),o=Math.round((0-i.y)*(e.canvas.offsetHeight/2)+e.canvas.offsetHeight/2),r=Math.round(i.x*(e.canvas.offsetWidth/2)+e.canvas.offsetWidth/2);return{top:o,left:r,bottom:e.canvas.offsetHeight-o,right:e.canvas.offsetWidth-r,inWindow:o>0&&o<e.canvas.offsetHeight&&r>0&&r<e.canvas.offsetWidth}}(e,t),r=function(e,t,i){var o=new n.Vector3((t-window.pageXOffset)/e.canvas.offsetWidth*2-1,-(i-window.pageYOffset)/e.canvas.offsetHeight*2+1,.5),r=(new n.Projector).pickingRay(o,e.currentViewpoint.camera);return{position:r.ray.origin,direction:r.ray.direction}}(e,o.left+i,o.top);return s.computePointLineDistance(t.toArray(),r.position.toArray(),r.direction.toArray()).distance}var T={};T.preSolidLine=l.retrieveMaterialFromGAS({color:new n.Color(16753920),lineWidth:window.devicePixelRatio,pattern:a.LinePatternEnum.SOLID}),T.dotDashedLine=l.retrieveMaterialFromGAS({color:new n.Color(16753920),lineWidth:window.devicePixelRatio+1,pattern:a.LinePatternEnum.DOTDASHED}),T.concentricPoint=l.retrieveMaterialFromGAS({symbol:3,size:10,color:new n.Color(15096832)}),T.crossPointPreHighlight=l.retrieveMaterialFromGAS({symbol:1,size:10,color:new n.Color(15096832)}),T.fullCirclePoint=l.retrieveMaterialFromGAS({symbol:5,size:10,color:new n.Color(15096832)}),T.preFaceMaterial=l.retrieveMaterialFromGAS({color:new n.Color(16753920),opacity:.5}),T.preFaceMaterial.force=!0,T.preSolidLine.force=!0,T.preFaceMaterial.line=T.preSolidLine;var C=new r;P(this,C),this.buildPreVisuNode=function(r){if(r&&r.data&&(r.data.getType||r.data.resultType)){r.data.onlyUpdatePos||C.removeChildren();var a,s,l,h,_,M,S,E,N,D,b,A,R,w,V,I,x=r.point||(r.data.getSelPoint?r.data.getSelPoint():null);if(void 0===r.data.resultType){var G=r.data.getType();if(void 0===G)return;switch(G){case t.GeometryType.POINT:case t.GeometryType.PICKINGPT:a=e.ResultType.POINT;break;case t.GeometryType.CURVE:a=e.ResultType.CURVE;break;case t.GeometryType.LINE:a=e.ResultType.LINE;break;case t.GeometryType.CIRCLE:a=e.ResultType.CIRCLE;break;case t.GeometryType.SURFACE:a=e.ResultType.SURFACE;break;case t.GeometryType.PLANE:a=e.ResultType.PLANE;break;case t.GeometryType.CYLINDER:a=e.ResultType.CYLINDER;break;case t.GeometryType.CONE:a=e.ResultType.CONE;break;case t.GeometryType.SPHERE:a=e.ResultType.SPHERE;break;case t.GeometryType.PRODUCT:a=e.ResultType.PRODUCT;break;default:return}}else a=r.data.resultType;var L="Default";switch(r.data.drawMode&&(L=r.data.drawMode),a){case e.ResultType.POINT:case e.ResultType.CENTER:if(!(s=a===e.ResultType.POINT?x?x.toArray():r.data.getPoint?r.data.getPoint().toArray():void 0:r.data.getCenter().toArray()))return;r.data.getType()!==t.GeometryType.POINT&&(T.concentricPoint.force=!0,T.crossPointPreHighlight.force=!0,M=o.createPointsNode({positions:s,material:a!==e.ResultType.POINT?T.crossPointPreHighlight:T.concentricPoint}),P(C,M));break;case e.ResultType.LINE:case e.ResultType.CURVE:s=(l=r.data.getPoints()).beginPoint.toArray(),T.fullCirclePoint.force=!0,M=o.createPointsNode({positions:s,material:T.fullCirclePoint}),P(C,M),s=l.endPoint.toArray(),M=o.createPointsNode({positions:s,material:T.fullCirclePoint}),P(C,M);break;case e.ResultType.AXIS:E=(l=r.data.getPoints()).beginPoint.clone().sub(l.endPoint),N=30,D=v(g,l.beginPoint,N),E.normalize().multiplyScalar(D),b=l.beginPoint.clone().add(E),A=l.endPoint.clone().sub(E);var B=i.createLineNode(b,A,T.dotDashedLine);P(C,B);break;case e.ResultType.CIRCLE:var U=r.data.getRadius();r.data.scale2D&&(U*=r.data.get2DScale()),S=i.createCircleNode(U,r.data.getCenter(),r.data.getAxis(),T.preSolidLine),P(C,S);break;case e.ResultType.PLANE:if("Measure"!==L){if(!(s=x||(r.data.getCOG?r.data.getCOG():void 0)))return;I=v(g,s,50);var O=i.createRectangleNode(I,I,s,r.data.getPlane().normal,T.preFaceMaterial,!0);P(C,O)}break;case e.ResultType.CYLINDER:if(l=r.data.getPoints(),"Measure"===L){h=l.beginPoint,x&&(_=x.clone().sub(l.beginPoint),x.clone().sub(l.endPoint).length()<_.length()&&(h=l.endPoint));var z=l.endPoint.clone().sub(l.beginPoint);S=i.createCircleNode(r.data.getRadius(),h,z,T.preSolidLine),P(C,S)}E=l.beginPoint.clone().sub(l.endPoint),N=30,D=v(g,l.beginPoint,N),E.normalize().multiplyScalar(D),b=l.beginPoint.clone().add(E),A=l.endPoint.clone().sub(E);var q=i.createLineNode(b,A,T.dotDashedLine);P(C,q);break;case e.ResultType.CONE:l=r.data.getPoints();var k=r.data.getAxis();if("Measure"===L){var F=r.data.getApex(),H=r.data.getSemiAngle();h=l.endPoint;var W=l.beginPoint,Y=F.clone(),X=F.clone().sub(l.beginPoint).length()*Math.tan(H),j=F.clone().sub(h).length()*Math.tan(H),Z=i.createCircleNode(j,h,k,T.preSolidLine);P(C,Z),R=f(g.currentViewpoint);var J=(new n.Vector3).crossVectors(k.clone().negate(),R.sight.clone().negate());J.length()>.001?J.normalize().multiplyScalar(j):J=R.right.clone().normalize().multiplyScalar(j);var K=h.clone().add(J),Q=h.clone().sub(J),$=(new n.Vector3).crossVectors(k,J),ee=(new n.Plane).setFromNormalAndCoplanarPoint($,h);if(w=Math.PI/4,x){var te=ee.projectPoint(x);_=K.clone().sub(te),Q.clone().sub(te).length()<_.length()&&(w*=3)}V=(new n.Matrix4).makeRotationAxis(k,w);var ie=J.clone().normalize().applyMatrix4(V);if(ie=ie.clone().normalize().multiplyScalar(j),K=h.clone().add(ie),X>.001){var ne=ie.clone().normalize().multiplyScalar(X);Y=W.clone().add(ne)}P(C,i.createLineNode(K,Y.clone(),T.preSolidLine))}N=30,D=v(g,l.beginPoint,N),k.normalize().multiplyScalar(D),b=l.beginPoint.clone().sub(k),A=l.endPoint.clone().add(k);var oe=i.createLineNode(b,A,T.dotDashedLine);P(C,oe);break;case e.ResultType.SPHERE:var re=r.data.getRadius();h=r.data.getCenter();var ae=(R=f(g.currentViewpoint)).up.clone();ae=ae.negate();var se=R.right.clone().normalize().multiplyScalar(re);w=Math.PI/4,V=(new n.Matrix4).makeRotationAxis(ae.clone().normalize(),w);var le=se.clone().applyMatrix4(V),ce=(new n.Vector3).crossVectors(ae,le.clone().normalize());P(C,i.createCircleNode(re,h,ce,T.preSolidLine));break;case e.ResultType.SURFACE:s=x||(r.data.getCOG?r.data.getCOG():void 0);var ue=r.normal?r.normal:r.data.getNormal?r.data.getNormal():r.data.normal;if(!s||!ue)return;I=v(g,s,50);var pe=g.currentViewpoint;if(r.data.onlyUpdatePos&&m||(C.removeChildren(),y=void 0,m=i.createSurfaceNode(I,T.preFaceMaterial,!0),P(C,m)),r.data.onlyUpdatePos&&y||(y=i.createArrowNormalNode(pe),P(C,y)),y&&y.setMatrix(d.getMatFromNormWithPos(ue,s)),m){var de=c.computeTransformationBetweenTwoLines(new n.Vector3,new n.Vector3(0,0,1),s,ue);m.setMatrix(de.transformation)}break;case e.ResultType.PRODUCT:var he=r.data.worldMatrix?r.data.worldMatrix:void 0;if(he){var me=new u({headLength:10,arrowLength:50,arrowWidth:2,head:u.types.ARROW,colors:{colorX:new p.Color(1,0,0,0),colorY:new p.Color(0,1,0,0),colorZ:new p.Color(0,0,1,0)}});me.setMatrix(he),P(C,me)}}}},this.remove=function(){C&&(C.removeChildren(),C.remove(),C=void 0),m&&(m.removeChildren(),m.remove(),m=void 0),y&&(y.removeChildren(),y.remove(),y=void 0)}}})}),define("DS/DMUMeasurable/DMUSwitchRepService",["UWA/Core","DS/DMUMeasurable/DMUToolsSceneGraph"],function(e,t){"use strict";return e.Class.extend({init:function(e){var i;if(e.viewerController)i=e.viewerController;else if(e.viewer){var n=t.getContextViewer({viewer:e.viewer});n.getController&&(i=n.getController())}this.retriveNodesFromPath=function(e,i){if(i||(i=[]),e){var n=t.getLastRepReference(e);if(n&&0===n.externalPath.length||!n){var o=(n=t.getLastReference(e)).getLastElement();if(o){var r=function(e){if(e)if(t.isRepReference(e))i.push(e);else{var n=[];(n=e.getChildren()).length>0&&n.forEach(function(e){r(e)})}};r(o)}}var a=n.getLastElement(!0);a&&i.push(a)}},this.switchToAV1=function(e){var n=this;if(i){var o=e.timeoutDuration?e.timeoutDuration:500,r=e.path,a=[];if(e.nodes&&(a=e.nodes),r&&this.retriveNodesFromPath(r,a),a&&a.length){var s,l=!1,c=[],u=[],p=[],d=[];return a.forEach(function(n){e.doNotCheckforLoadStream||"cgr"!==i.getLoadedStream(n)?t.isReference(n)||(d.push({node:n,stream:"cgr"}),l=!0,c.push(t.getNodeID(n)),u.push(t.getNodeID(n))):p.push(t.getNodeID(n))}),l&&(s=setTimeout(function(){i.switchNodeVisuStreamOnDemand({data:d,autoLock:!1,callbacks:{onComplete:function(){(e.lockNodesAfterSwitch||e.lockMeshInRAMAfterSwitch)&&n.lockNodes({nodeIDsTolock:e.lockNodesAfterSwitch?c:void 0,nodeIDsTolockMeshInRAM:e.lockMeshInRAMAfterSwitch?u:void 0}),e.onCompleteCB&&e.onCompleteCB({nodeIDsOfLockedNodes:c,nodeIDsOflockedMeshInRAM:u})},onFailure:function(){e.onFailureCB&&e.onFailureCB({nodeIDsOfLockedNodes:c,nodeIDsOflockedMeshInRAM:u})}}})},o)),{clearTimeout:function(){s&&clearTimeout(s)},nodeIDsOfAlreadyLoadedNode:p}}}},this.unlockNodes=function(e){var t=e.nodeIDsToUnlockMeshInRAM,n=e.nodeIDsToUnlock;i&&(t&&t.length&&t.forEach(function(e){i.unlockRepresentationMeshInRAM(e)}),n&&n.length&&i.unlockNodes({ids:n}))},this.lockNodes=function(e){var t=e.nodeIDsTolockMeshInRAM,n=e.nodeIDsTolock;i&&(t&&t.length&&t.forEach(function(e){i.lockRepresentationMeshInRAM(e)}),n&&n.length&&i.lockNodes({ids:n}))}}})}),define("DS/DMUMeasurable/DMUMeasurableElementAgent",["UWA/Core","DS/StateCommandEngine/PathElementAgent","DS/DMUMeasurable/DMUMeshRecognition","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUMeasureEnums","DS/DMUMeasurable/DMUToolsAvatars","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUMeasurable/DMUSwitchRepService","DS/Visualization/ThreeJS_DS"],function(e,t,i,n,o,r,a,s,l){"use strict";return t.extend({init:function(t){var i={pickingFilter:this._pickingFilter,prePickingFilter:this._prePickingFilter,activatePrePicking:!1,thisAgent:this};t.timeoutDurationForRepLoading&&(this.timeoutDurationForRepLoading=t.timeoutDurationForRepLoading),t.appli&&(this._appli=t.appli),t.checkAppli&&(this._checkAppli=t.checkAppli),t.displayAppli&&(this._displayAppli=t.displayAppli),t.displayAvatar&&(this._displayAvatar=t.displayAvatar);var n=e.extend(i,t);this._avatarNode=null,t.switchRepOnPreSelection&&(this._switchRepOnPreSelection=t.switchRepOnPreSelection,this._switchRepOnPreSelection&&(this._switchRep={clearTimeout:null,lockedNodeIds:[]})),t.viewerController&&(this._viewerController=t.viewerController,this._switchService=new s({viewerController:this._viewerController})),this._parent(n)},_pickingFilter:function(e){var t=this.thisAgent._filter(e);return this.thisAgent._checkAppli&&(t=t&&this.thisAgent._checkAppli(e,this.thisAgent._appli)),this.thisAgent._condition=t,t&&this.thisAgent._clearTimeout(),t},_prePickingFilter:function(e){var t=!0,i=this;if(i.thisAgent.options.activatePrePicking&&(t=i.thisAgent._filter(e),i.thisAgent._checkAppli&&(t=t&&i.thisAgent._checkAppli(e,i.thisAgent._appli),i.thisAgent._switchRepOnPreSelection&&i.thisAgent._switchService))){i.thisAgent._clearTimeout();var n=[],o=!1;i.thisAgent._switchService.retriveNodesFromPath(e,n);for(var r=0;r<n.length;r++){var s=a.getNodeID(n[r]);if(-1===i.thisAgent._switchRep.lockedNodeIds.indexOf(s)){o=!0;break}}if(o){var l=i.thisAgent._switchService.switchToAV1({nodes:n,lockNodesAfterSwitch:!0,lockMeshInRAMAfterSwitch:!0,doNotCheckforLoadStream:!0,timeoutDuration:i.timeoutDurationForRepLoading,onCompleteCB:function(e){var t=e.nodeIDsOfLockedNodes;i.thisAgent._switchRep.clearTimeout=void 0,t&&t.length>0&&(i.thisAgent._switchRep.lockedNodeIds||(i.thisAgent._switchRep.lockedNodeIds=[]),t.forEach(function(e){-1===i.thisAgent._switchRep.lockedNodeIds.indexOf(e)&&i.thisAgent._switchRep.lockedNodeIds.push(e)}))},onFailureCB:function(){i.thisAgent._switchRep.clearTimeout=void 0}});if(l&&l.clearTimeout&&(i.thisAgent._switchRep.clearTimeout=l.clearTimeout),l&&l.nodeIDsOfAlreadyLoadedNode&&l.nodeIDsOfAlreadyLoadedNode.length){var c=[];l.nodeIDsOfAlreadyLoadedNode.forEach(function(e){-1===i.thisAgent._switchRep.lockedNodeIds.indexOf(e)&&(c.push(e),i.thisAgent._switchRep.lockedNodeIds.push(e)),c&&c.length&&(i.thisAgent._switchService.lockNodes({nodeIDsTolock:c,nodeIDsTolockMeshInRAM:c}),c=[])})}}}return i.thisAgent._condition=t,t},agentActionOnTheScene:function(e){var t;if(this._parent(e),this._switchRepOnPreSelection&&0===this.currentPSO.length&&this._clearTimeout(),this._condition&&e.pickingResult&&e.pickingResult.position){var i=this._viewer.getMousePosition(e.event.getCurrentPosition(this._viewer.canvas));t=this._viewer.pick(i,this.options.prePickingMode,!0)}this._displayAvatar&&(this._avatarNode&&a.getSceneRoot(this._viewer).remove(this._avatarNode),this._condition&&e.pickingResult&&e.pickingResult.position&&t.position&&this._drawAvatar(this,t.position,t.normal)),this._displayAppli&&(this._condition&&e.pickingResult&&e.pickingResult.position&&t.position?(t.pathElement=t.path[0],this._displayAppli(t,this._appli)):this._appli&&this._appli._removePreVisuNode&&this._appli._removePreVisuNode())},deactivate:function(){this._activated&&(this._unlockNodes(),this._avatarNode&&(a.getSceneRoot(this._viewer).remove(this._avatarNode),this._viewer.render()),this._parent())},_filter:function(e){var t=this,r=e.getLastElement().sgNode,s=void 0!==r||void 0!==e.instanceId;if(t._appli&&t._appli._checkForSelection&&"2D"===t._appli._measureOnGeometryType){var l=[];if(l.push({pathElement:e}),!(s=t._appli._checkForSelection(l)))return s}if(s){if(void 0!==r){if(t.geometry=i.recognizeCanonicGeometry(r,e.getWorldMatrix(),!0),0!==t.geometry.returnCode)switch(t.geometry={},r.getGroup().glType){case 1:t.geometry.type=n.GeometryType.CURVE;break;case 4:t.geometry.type=n.GeometryType.SURFACE;break;default:t.geometry.type=n.GeometryType.PICKINGPT}}else t.geometry={type:n.GeometryType.PICKINGPT};var c=t.options.acceptedGeometries.length;if(s&&c>0){s=!1;for(var u=0;!s&&u<c;u++)s=t.geometry.type===t.options.acceptedGeometries[u]}if(s&&0===c&&t.options.viewedGeometries&&t.options.viewedGeometries.length>0&&t.options.viewedGeometries.indexOf(o.ViewedType.PRODUCT)>=0){var p=a.getLastReference(e);e.externalPath=p.externalPath,e.internalPath=p.internalPath,s=!0}if(!s&&t._switchRepOnPreSelection&&t._viewerController){var d=a.getLastRepReference(e),h=d.getLastElement(!0);h&&"cgr"!==t._viewerController.getLoadedStream(h)&&(e.externalPath=d.externalPath,e.internalPath=d.internalPath,s=!0)}}else!function(){var i=t.cso.get();if(i){if(i.length>0){for(var o=!1,r=0;!o&&r<i.length;)i[r].pathElement.isEqual(e)&&(o=!0),r++;o||(s=!0)}else s=!0;s?t.geometry={type:n.GeometryType.PICKINGPT}:t._appli&&t._appli._objAction&&(t.geometry={type:n.GeometryType.PRODUCT},s=!0)}}();return s},_drawAvatar:function(e,t,i){var o=new l.MeshBasicMaterial({force:!0});o.line=new l.LineBasicMaterial({color:new l.Color(16679169),force:!0});var s=new l.LineBasicMaterial({color:new l.Color(16679169),force:!0,dashSize:1,gapSize:1});switch(e.geometry.type){case n.GeometryType.POINT:e._avatarNode=r.createCrossNode(10,t,i,o),a.getSceneRoot(e._viewer).add(e._avatarNode);break;case n.GeometryType.CIRCLE:e._avatarNode=r.createCircleNode(e.geometry.radius,e.geometry.center,e.geometry.normal,o),a.getSceneRoot(e._viewer).add(e._avatarNode);break;case n.GeometryType.SPHERE:e._avatarNode=r.createCrossNode(10,e.geometry.center,i,o),a.getSceneRoot(e._viewer).add(e._avatarNode);break;case n.GeometryType.CYLINDER:case n.GeometryType.CONE:var c=e.geometry.point1.clone().sub(e.geometry.point2),u=c.length()/8;c.normalize().multiplyScalar(u);var p=e.geometry.point1.clone().add(c),d=e.geometry.point2.clone().sub(c);e._avatarNode=r.createLineNode(p,d,s),a.getSceneRoot(e._viewer).add(e._avatarNode);break;case n.GeometryType.PLANE:var h=t||e.geometry.origin;e._avatarNode=r.createRectangleNode(10,10,h,e.geometry.normal,o),a.getSceneRoot(e._viewer).add(e._avatarNode)}e._avatarNode&&(e._avatarNode.setNoZ(!0),e._avatarNode.setPickable(!1))},_unlockNodes:function(){this._switchService&&this._switchRep&&(this._switchService.unlockNodes({nodeIDsToUnlock:this._switchRep.lockedNodeIds,nodeIDsToUnlockMeshInRAM:this._switchRep.lockedNodeIds}),this._switchRep.lockedNodeIds=[])},_clearTimeout:function(){this._switchRep&&this._switchRep.clearTimeout&&(this._switchRep.clearTimeout(),this._switchRep.clearTimeout=null)}})}),define("DS/DMUMeasurable/DMUMathsFiniteGeometry",["DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUGeometryEnums"],function(e,t,i){"use strict";var n=1e-6,o={computePointSegmentDistance:function(t,o,r,a){var s={returnCode:1};if(t&&o&&r){s.returnCode=2;var l=void 0!==a?a:Number.MAX_VALUE;if(l>n){var c=e.sub(t,o),u=e.sub(o,r),p=-e.dot(c,u);if(p<=0)s.aPosition=e.clone(o),l=e.squaredLength(c);else{var d=e.squaredLength(u);d<n?(s.aPosition=e.clone(o),l=e.squaredLength(c)):(p/=d)>=1?(s.aPosition=e.clone(r),l=e.subAndSquaredLength(r,t)):(s.aPosition=e.multiplyAndAdd(u,p,o),l=e.subAndSquaredLength(s.aPosition,t))}(void 0===a||a>l)&&(s.returnCode=0,s.squaredDistance=l,s.distance=Math.sqrt(l),s.relationship=l<n?i.Relationship.COINCIDENT:i.Relationship.NONE)}}return s},computePointTriangleDistance:function(t,r,a,s,l){var c={};if(c.returnCode=1,t&&r&&a&&s){c.returnCode=2;var u=e.sub(r,a),p=e.squaredLength(u),d=e.sub(r,s),h=e.squaredLength(d),m=e.sub(a,s),y=e.squaredLength(m);p<n?c=o.computePointSegmentDistance(t,r,s):h<n||y<n?c=o.computePointSegmentDistance(t,r,a):function(o,a,s,u){var p=e.sub(t,r),d=e.dot(o,a),h=e.dot(o,p),m=e.dot(a,p),y=s*u-d*d,g=d*m-u*h,P=d*h-s*m;if(g+P<=y)g<0?P<0?h<0?(P=0,g=-h>=s?1:-h/s):(g=0,P=m>=0?0:-m>=u?1:P=-m/u):(g=0,P=m>=0?0:-m>=u?1:-m/u):P<0?(P=0,g=h>=0?0:-h>=s?1:-h/s):(g*=y=1/y,P*=y);else{var f=0,v=0,T=0,C=0;g<0?(v=u+m)>(f=d+h)?P=1-(g=(T=v-f)>=(C=s-2*d+u)?1:T/C):(g=0,P=v<=0?1:m>=0?0:-m/u):P<0?(v=u+m)>(f=d+h)?P=1-(g=(T=v-f)>=(C=s-2*d+u)?1:T/C):(g=0,P=v<=0?1:m>=0?0:-m/u):P=1-(g=(T=u+m-d-h)<=0?0:T>=(C=s-2*d+u)?1:T/C)}c.aPosition=e.multiplyAndAdd(a,P,e.multiplyAndAdd(o,g,r)),c.squaredDistance=e.subAndSquaredLength(c.aPosition,t),(void 0===l||c.squaredDistance<l)&&(c.relationship=c.squaredDistance<n?i.Relationship.COINCIDENT:i.Relationship.NONE,c.returnCode=0)}(u,d,p,h)}return c},computeTwoSegmentsDistance:function(t,r,a,s,l){var c={returnCode:1};if(t&&r&&a&&s){if(c.returnCode=2,e.areEqual(t,r))return(c=o.computePointSegmentDistance(t,a,s,l)).angle=0,c.aPosition1=e.clone(t),c.aPosition2=c.aPosition,c;if(e.areEqual(a,s))return(c=o.computePointSegmentDistance(a,t,r,l)).angle=0,c.aPosition1=c.aPosition,c.aPosition2=e.clone(a),c;var u=!1,p=e.sub(t,r),d=e.sub(a,s),h=e.cross(p,d),m=e.squaredLength(h),y=0,g=0,P=0,f=0,v=0,T=0,C=0,_=0,M=0,S=0;if(m>n*e.squaredLength(p)*e.squaredLength(d)){if(P=e.sub(t,a),S=e.dot(P,h),S*=S,void 0!==l&&S>l*m)return c;var E=e.cross(h,P);T=e.dot(E,p),C=e.dot(E,d);var N=!1;T<=0?v=e.clone(a):T>=m?v=e.clone(s):N=1;var D=!1;if(C<=0?f=e.clone(t):C>=m?f=e.clone(r):D=1,N||D)if(_=0,N&&D){var b=1/m;T*=b,C*=b,v=e.multiplyAndAdd(d,T,a),f=e.multiplyAndAdd(p,C,t),S*=b}else if(N){if(y=e.sub(a,f),_=e.squaredLength(d),h=e.cross(d,y),S=e.squaredLength(h),void 0!==l&&S>l*_)return c;if((M=e.dot(d,y))<=0){if(v=e.clone(a),S=e.squaredLength(e.sub(v,f)),void 0!==l&&S>l*_)return c}else if(M>=_){if(v=e.clone(s),S=e.squaredLength(e.sub(v,f)),void 0!==l&&S>l*_)return c}else S*=_=1/_,M*=_,v=e.multiplyAndAdd(d,M,a)}else{if(g=e.sub(v,t),_=e.squaredLength(p),h=e.cross(p,g),S=e.squaredLength(h),void 0!==l&&S>l*_)return c;if((M=-(M=e.dot(p,g)))<=0){if(f=e.clone(t),S=e.squaredLength(e.sub(v,f)),void 0!==l&&S>l*_)return c}else if(M>=_){if(f=e.clone(r),S=e.squaredLength(e.sub(v,f)),void 0!==l&&S>l*_)return c}else S*=_=1/_,M*=_,f=e.multiplyAndAdd(p,M,t)}else{var A;g=e.sub(v,t),C=-e.dot(g,p),_=e.squaredLength(p),C<=0?A=e.clone(t):C>=_?A=e.clone(r):(C/=_,A=e.multiplyAndAdd(p,C,t));var R,w=e.subAndSquaredLength(v,A);y=e.sub(a,f),T=e.dot(y,d),M=e.squaredLength(d),T<=0?R=e.clone(a):T>=M?R=e.clone(s):(T/=M,R=e.multiplyAndAdd(d,T,a));var V=e.subAndSquaredLength(f,R);if(w<=V){if(void 0!==l&&w>l)return c;S=w,f=A}else{if(void 0!==l&&V>l)return c;S=V,v=R}}}else{u=!0,_=e.squaredLength(d),P=e.sub(a,t),T=e.dot(P,d);var I=e.sub(a,r);if(C=e.dot(I,d),_<n||Math.abs(T-C)<n)return c;if(T>_?C>_?(v=e.clone(s),f=C>=T?e.clone(t):e.clone(r)):C>=0?(f=e.clone(r),C/=_,v=e.multiplyAndAdd(d,C,a)):(v=e.clone(a),C=T/(T-C),f=e.multiplyAndAdd(p,C,t)):T<0?C<0?(v=e.clone(a),f=C<T?e.clone(t):e.clone(r)):C<=_?(f=e.clone(r),C/=_,v=e.multiplyAndAdd(d,C,a)):(v=e.clone(a),C=T/(T-C),f=e.multiplyAndAdd(p,C,t)):(f=e.clone(t),T/=_,v=e.multiplyAndAdd(d,T,a)),S=e.squaredLength(e.sub(v,f)),void 0!==l&&S>l)return c}(void 0===l||S<l)&&(c.squaredDistance=S,c.distance=Math.sqrt(S),u?(c.relationship=c.distance<.001?i.Relationship.COINCIDENT:i.Relationship.PARRALLEL,c.angle=0):(c.relationship=c.distance<.001?i.Relationship.INTERSECTING:i.Relationship.NONE,c.angle=e.angle(p,d)),c.aPosition1=f,c.aPosition2=v,c.returnCode=0)}return c},computeSegmentTriangleSquaredDistance:function(r,a,s,l,c,u){var p,d={};if(d.returnCode=1,r&&a&&s&&l&&c){d.returnCode=2;var h=void 0!==u?u:Number.MAX_VALUE;if(h>n){var m,y,g=!1,P=e.sub(s,l),f=e.sub(s,c),v=e.cross(P,f);e.normalize(v)||(v=e.multiply(v,1e3));var T=e.sub(s,r),C=e.sub(s,a),_=e.dot(v,T),M=e.dot(v,C);if(_>0&&M<0||_<0&&M>0){var S=e.sub(r,a);0===(p=t.computeLinePlaneDistance(r,S,s,v)).returnCode&&p.aPosition&&2!==(p=o.computePointTriangleDistance(p.aPosition,s,l,c,h)).returnCode&&p.relationship===i.Relationship.COINCIDENT&&(h=p.squaredDistance,m=e.clone(p.aPosition),y=e.clone(p.aPosition),g=!0)}if(!g){for(var E=[r,a],N=[s,l,c,s],D=0;D<3&&h>n;D++)2!==(p=o.computeTwoSegmentsDistance(r,a,N[D],N[D+1],h)).returnCode&&(h=p.squaredDistance,m=e.clone(p.aPosition1),y=e.clone(p.aPosition2),g=!0);for(var b=0;b<2&&h>n;b++)2!==(p=o.computePointTriangleDistance(E[b],s,l,c,h)).returnCode&&(h=p.squaredDistance,m=e.clone(E[b]),y=e.clone(p.aPosition),g=!0)}g&&(d.returnCode=0,d.squaredDistance=h,d.aPosition1=m,d.aPosition2=y,d.angle=0,d.relationship=d.squaredDistance<n?i.Relationship.INTERSECTING:i.Relationship.NONE)}}return d},computeTwoTrianglesSquaredDistance:function(t,r,a,s,l,c,u){var p={returnCode:1};if(t&&r&&s&&l&&c){p.returnCode=2;var d=void 0!==u?u:Number.MAX_VALUE;if(d>n){for(var h,m,y,g=[t,r,a,t],P=[s,l,c,s],f=!1,v=0;v<3&&d>n;v++)2!==(y=o.computeSegmentTriangleSquaredDistance(g[v],g[v+1],s,l,c,d)).returnCode&&(d=y.squaredDistance,h=e.clone(y.aPosition1),m=e.clone(y.aPosition2),f=!0);for(var T=0;T<3&&d>n;T++)2!==(y=o.computeSegmentTriangleSquaredDistance(P[T],P[T+1],t,r,a,d)).returnCode&&(d=y.squaredDistance,h=e.clone(y.aPosition2),m=e.clone(y.aPosition1),f=!0);f&&(p.returnCode=0,p.squaredDistance=d,p.aPosition1=h,p.aPosition2=m,p.angle=0,p.relationship=i.Relationship.NONE)}}return p}};return o}),define("DS/DMUMeasurable/DMUMeshMeasure",["DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUMathsFiniteGeometry","DS/DMUMeasurable/DMUMathsBoundingGeometry","DS/DMUMeasurable/DMUMeshServices"],function(e,t,i,n){"use strict";var o={computePointMeshSquaredDistance:function(e,t,i,r){var a={returnCode:1};if(t&&t.getGroup()&&t.getGroup().geometry&&void 0!==t.getStart()&&void 0!==t.getCount()&&t.getCount()>0){var s=t.getCount(),l=t.getGroup().glType,c=n.extractMeshVertices(t,i.elements),u=1===l?s/2:s/3;1===l?a=o._computePointCurveSquaredDistance(e,u,c,r):4===l&&(a=o._computePointSurfaceSquaredDistance(e,u,c,r))}return a},_computePointMeshSquaredMaxDistance:function(t,o,r,a){var s={returnCode:1};if(o&&o.getGroup()&&o.getGroup().geometry&&void 0!==o.getStart()&&void 0!==o.getCount()&&o.getCount()>0){s.returnCode=2;var l,c=n.extractMeshVertices(o,r.elements,void 0,!0),u=c.length,p=a||0,d=[0,0,0],h=i.computeAABBForPoint(t),m=i.computeAABBForPoints(c),y=i.computeAABBSquaredMaxDistance(h,m);if(y>p){for(var g=0;g<u;g++)(y=e.subAndSquaredLength(t,c[g],d))>p&&(p=y,l=e.clone(c[g]),s.returnCode=0);0===s.returnCode&&(s.squaredMaxDistance=p,s.aPosition1=t,s.aPosition2=l)}}return s},computeTwoMeshesSquaredDistance:function(e,t,i,r,a){var s={returnCode:1},l=e&&e.getGroup()&&e.getGroup().geometry&&void 0!==e.getStart()&&void 0!==e.getCount()&&e.getCount()>0,c=i&&i.getGroup()&&i.getGroup().geometry&&void 0!==i.getStart()&&void 0!==i.getCount()&&i.getCount()>0;if(l&&c){var u=e.getCount(),p=e.getGroup().glType,d=n.extractMeshVertices(e,t.elements),h=1===p?u/2:u/3,m=i.getCount(),y=i.getGroup().glType,g=n.extractMeshVertices(i,r.elements),P=1===y?m/2:m/3;if(1===p)1===y?s=o._computeTwoCurvesSquaredDistance(h,d,P,g,a):4===y&&(s=o._computeCurveSurfaceSquaredDistance(h,d,P,g,a));else if(4===p)if(1===y){var f=(s=o._computeCurveSurfaceSquaredDistance(P,g,h,d,a)).aPosition1;s.aPosition1=s.aPosition2,s.aPosition2=f}else 4===y&&(s=o._computeSurfaceSurfaceSquaredDistance(h,d,P,g,a))}return s},_computeTwoMeshesSquaredMaxDistance:function(t,o,r,a,s){var l={returnCode:1},c=t&&t.getGroup()&&t.getGroup().geometry&&void 0!==t.getStart()&&void 0!==t.getCount()&&t.getCount()>0,u=r&&r.getGroup()&&r.getGroup().geometry&&void 0!==r.getStart()&&void 0!==r.getCount()&&r.getCount()>0;if(c&&u){l.returnCode=2;var p,d,h=n.extractMeshVertices(t,o.elements),m=h.length,y=n.extractMeshVertices(r,a.elements),g=y.length,P=s||0,f=[0,0,0],v=i.computeAABBForPoints(h),T=i.computeAABBForPoints(y),C=i.computeAABBSquaredMaxDistance(v,T);if(C>P){for(var _=0;_<m;_++)for(var M=0;M<g;M++)(C=e.subAndSquaredLength(h[_],y[M],f))>P&&(P=C,p=e.clone(h[_]),d=e.clone(y[M]),l.returnCode=0);0===l.returnCode&&(l.squaredMaxDistance=P,l.aPosition1=p,l.aPosition2=d)}}return l},_computePointCurveSquaredDistance:function(n,o,r,a){var s={returnCode:1};if(void 0!==o&&r){s.returnCode=2;for(var l,c=a||Number.MAX_VALUE,u=i.computeAABBForPoint(n),p=0;p<o&&c>1e-6;p++){var d=i.computeAABBForSegment(r[2*p],r[2*p+1]);if(i.computeAABBSquaredDistance(u,d)<c){var h=t.computePointSegmentDistance(n,r[2*p],r[2*p+1],c);2!==h.returnCode&&(s.returnCode=0,c=h.squaredDistance,l=e.clone(h.aPosition))}}0===s.returnCode&&(s.squaredDistance=c,s.aPosition1=n,s.aPosition2=l)}return s},_computePointSurfaceSquaredDistance:function(n,o,r,a){var s={returnCode:1};if(void 0!==o&&r){s.returnCode=2;for(var l,c=a||Number.MAX_VALUE,u=i.computeAABBForPoint(n),p=0;p<o&&c>1e-6;p++){var d=i.computeAABBForTriangle(r[3*p],r[3*p+1],r[3*p+2]);if(i.computeAABBSquaredDistance(u,d)<c){var h=t.computePointTriangleDistance(n,r[3*p],r[3*p+1],r[3*p+2],c);2!==h.returnCode&&(s.returnCode=0,c=h.squaredDistance,l=e.clone(h.aPosition))}}0===s.returnCode&&(s.squaredDistance=c,s.aPosition1=n,s.aPosition2=l)}return s},_computeTwoCurvesSquaredDistance:function(n,o,r,a,s){var l={returnCode:1};if(void 0!==n&&o&&void 0!==r&&a){l.returnCode=2;for(var c,u,p=s||Number.MAX_VALUE,d=0;d<n&&p>1e-6;d++)for(var h=i.computeAABBForSegment(o[2*d],o[2*d+1]),m=0;m<r&&p>1e-6;m++){var y=i.computeAABBForSegment(a[2*m],a[2*m+1]);if(i.computeAABBSquaredDistance(h,y)<p){var g=t.computeTwoSegmentsDistance(o[2*d],o[2*d+1],a[2*m],a[2*m+1],p);2!==g.returnCode&&(l.returnCode=0,p=g.squaredDistance,c=e.clone(g.aPosition1),u=e.clone(g.aPosition2))}}0===l.returnCode&&(l.squaredDistance=p,l.aPosition1=c,l.aPosition2=u)}return l},_computeCurveSurfaceSquaredDistance:function(n,o,r,a,s){var l={returnCode:1};if(void 0!==n&&o&&void 0!==r&&a){l.returnCode=2;for(var c,u,p=s||Number.MAX_VALUE,d=0;d<n&&p>1e-6;d++)for(var h=i.computeAABBForSegment(o[2*d],o[2*d+1]),m=0;m<r&&p>1e-6;m++){var y=i.computeAABBForTriangle(a[3*m],a[3*m+1],a[3*m+2]);if(i.computeAABBSquaredDistance(h,y)<p){var g=t.computeSegmentTriangleSquaredDistance(o[2*d],o[2*d+1],a[3*m],a[3*m+1],a[3*m+2],p);2!==g.returnCode&&(l.returnCode=0,p=g.squaredDistance,c=e.clone(g.aPosition1),u=e.clone(g.aPosition2))}}0===l.returnCode&&(l.squaredDistance=p,l.aPosition1=c,l.aPosition2=u)}return l},_computeSurfaceSurfaceSquaredDistance:function(n,o,r,a,s){var l={returnCode:1};if(void 0!==n&&o&&void 0!==r&&a){l.returnCode=2;var c,u,p,d,h,m,y=s||Number.MAX_VALUE,g=[];n>r?(c=n,u=r,p=o,d=a):(c=r,u=n,p=a,d=o);for(var P=0;P<c&&y>1e-6;P++)for(var f=i.computeAABBForTriangle(p[3*P],p[3*P+1],p[3*P+2]),v=0;v<u&&y>1e-6;v++){if(void 0===g[v]&&(g[v]=i.computeAABBForTriangle(d[3*v],d[3*v+1],d[3*v+2])),i.computeAABBSquaredDistance(f,g[v])<y){var T=t.computeTwoTrianglesSquaredDistance(p[3*P],p[3*P+1],p[3*P+2],d[3*v],d[3*v+1],d[3*v+2],y);2!==T.returnCode&&(l.returnCode=0,y=T.squaredDistance,h=e.clone(T.aPosition1),m=e.clone(T.aPosition2))}}0===l.returnCode&&(l.squaredDistance=y,n>r?(l.aPosition1=h,l.aPosition2=m):(l.aPosition1=m,l.aPosition2=h))}return l},_computePointCurveSquaredMaxDistance:function(n,o,r,a){var s={returnCode:1};if(void 0!==o&&r){s.returnCode=2;for(var l,c=a||Number.MAX_VALUE,u=i.computeAABBForPoint(n),p=0;p<o&&c>1e-6;p++){var d=i.computeAABBForSegment(r[2*p],r[2*p+1]);if(i.computeAABBSquaredMaxDistance(u,d)<c){var h=t.computePointSegmentDistance(n,r[2*p],r[2*p+1],c);2!==h.returnCode&&(s.returnCode=0,c=h.squaredDistance,l=e.clone(h.aPosition))}}0===s.returnCode&&(s.squaredMaxDistance=c,s.aPosition1=n,s.aPosition2=l)}return s}};return o}),define("DS/DMUMeasurable/DMUToolsMeasure",["DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUMathsBoundingGeometry","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUMeasurable/DMUMeshServices","DS/DMUMeasurable/DMUMeshMeasure","DS/DMUMeasurable/DMUToolsMaths","DS/DMUMeasurable/DMUMeasureEnums","DS/Visualization/ThreeJS_DS","DS/Visualization/SubElement","DS/DMUMeasurable/DMUMeshRecognition","DS/Mesh/MeshUtils"],function(e,t,i,n,o,r,a,s,l,c,u,p,d){"use strict";var h=.001,m=function(e){var t=o.getLastReference(e);return t&&t.getLastElement(!0)?t:(t=o.getLastRepReference(e))&&t.getLastElement(!0)?t:e.clone()},y=function(t,n,o,r,a){var s={};if("Distance"!==a||t._type!==i.GeometryType.POINT&&n!==l.ViewedType.POINT)return s;n=l.ViewedType.POINT;var u,p=t.getSelPoint().toArray(),d=!1,h=o._type;if(h===i.GeometryType.POINT||r===l.ViewedType.POINT)u=o.getSelPoint().toArray(),r=l.ViewedType.POINT,d=!0;else if(h===i.GeometryType.CIRCLE)u=o.getCenter().toArray(),r=l.ViewedType.CIRCLE,d=!0;else if(h===i.GeometryType.SPHERE)u=o.getCenter().toArray(),r=l.ViewedType.CYCOSP,d=!0;else if(h===i.GeometryType.PLANE)r=l.ViewedType.INFPLANE,s=e.measureBetweenInfinite(t,n,o,r);else if(h===i.GeometryType.CYLINDER||h===i.GeometryType.CONE){r=l.ViewedType.CYCOSP;var m=o.getPoints(),y=m.beginPoint.clone().sub(m.endPoint);(s=e.computePointLineDistance(p,m.beginPoint.clone().toArray(),y.toArray())).type2=r,s.type1=n,s.aPosition1=p,s.aPosition2=s.aPosition}return d&&((s=e.computeTwoPointsDistance(p,u)).type2=r,s.type1=n,s.aPosition1=p,s.aPosition2=u),s.aPosition1&&(s.position1=new c.Vector3(s.aPosition1[0],s.aPosition1[1],s.aPosition1[2])),s.aPosition2&&(s.position2=new c.Vector3(s.aPosition2[0],s.aPosition2[1],s.aPosition2[2])),s.aExtension&&(s.extensionDirection=new c.Vector3(s.aExtension[0],s.aExtension[1],s.aExtension[2])),s},g=function(t,n,o,r,a){var s={};if("Distance"!==a||t._type!==i.GeometryType.LINE)return s;n=l.ViewedType.CURVE;var u,p=t.getPoints(),d=p.beginPoint.clone(),h=p.beginPoint.clone().toArray(),m=d.clone().sub(p.endPoint.clone()),y=o._type;if(y===i.GeometryType.LINE){r=l.ViewedType.CURVE;var g=o.getPoints(),P=g.beginPoint.clone().sub(g.endPoint);u=g.beginPoint.clone().toArray(),(s=e.computeTwoLinesDistance(h,m.clone().toArray(),u,P.clone().toArray())).type2=r,s.type1=n,s.extensionDirection=m.clone().normalize()}else if(y===i.GeometryType.SPHERE||y===i.GeometryType.CIRCLE)r=l.ViewedType.CYCOSP,y===i.GeometryType.CIRCLE&&(r=l.ViewedType.CIRCLE),u=o.getCenter().toArray(),(s=e.computePointLineDistance(u,p.beginPoint.clone().toArray(),m.clone().toArray())).type2=r,s.type1=n,s.aPosition1=s.aPosition,s.aPosition2=u;else if(y===i.GeometryType.PLANE){r=l.ViewedType.INFPLANE;var f=o.getPlane();(s=e.computeLinePlaneDistance(h,m.clone().toArray(),f.origin.clone().toArray(),f.normal.clone().toArray())).type2=r,s.type1=n,s.aPosition1=h,s.aPosition2=s.aPosition}else if(y===i.GeometryType.CYLINDER||y===i.GeometryType.CONE){r=l.ViewedType.CYCOSP;var v=o.getPoints(),T=v.beginPoint.clone().sub(v.endPoint);(s=e.computePointLineDistance(h,v.beginPoint.clone().toArray(),T.toArray())).type2=r,s.type1=n,s.aPosition1=h,s.aPosition2=s.aPosition}return s.aPosition1&&(s.position1=new c.Vector3(s.aPosition1[0],s.aPosition1[1],s.aPosition1[2])),s.aPosition2&&(s.position2=new c.Vector3(s.aPosition2[0],s.aPosition2[1],s.aPosition2[2])),s.aExtension?s.extensionDirection=new c.Vector3(s.aExtension[0],s.aExtension[1],s.aExtension[2]):m&&(s.extensionDirection=m.clone().normalize()),s},P=function(t,n,o,s,u){var p,d={};if("Distance"!==u||t._type!==i.GeometryType.CURVE)return d;n=l.ViewedType.CURVE;var h=o._type;if(h===i.GeometryType.CIRCLE||h===i.GeometryType.SPHERE)s=l.ViewedType.CIRCLE,h===i.GeometryType.SPHERE&&(s=l.ViewedType.CYCOSP),p=o.getCenter().toArray(),d=a.computePointMeshSquaredDistance(p,t.getPrimitive(),t.getReferentialPosition()),s=l.ViewedType.CIRCLE,d.type1=n,d.type2=s,h===i.GeometryType.SPHERE&&(d.type2=l.ViewedType.CYCOSP),d.distance=Math.sqrt(d.squaredDistance),d.aPosition2&&(d.aPosition1=d.aPosition2,d.aPosition2=p);else if(h===i.GeometryType.CYLINDER||h===i.GeometryType.CONE){var m,y,g,P=-1,f=t.getPrimitive(),v=t.getReferentialPosition(),T=r.extractMeshVertices(f,v.elements),C=T.length,_=o.getPoints();p=_.beginPoint.clone().clone().toArray();for(var M=_.beginPoint.clone().sub(_.endPoint),S=0;S<C;S++){var E=e.computePointLineDistance(T[S],p,M.toArray());(P<0||P>E.distance)&&(P=E.distance,m=E.aPosition,g=E.relationship,y=T[S])}s=l.ViewedType.CYCOSP,d.type2=s,d.type1=n,d.distance=P,d.aPosition1=m,d.aPosition2=y,d.relationship=g}return d.aPosition1&&(d.position1=new c.Vector3(d.aPosition1[0],d.aPosition1[1],d.aPosition1[2])),d.aPosition2&&(d.position2=new c.Vector3(d.aPosition2[0],d.aPosition2[1],d.aPosition2[2])),d.aExtension&&(d.extensionDirection=new c.Vector3(d.aExtension[0],d.aExtension[1],d.aExtension[2])),d},f=function(t,n,o,r,s){var u={};if("Distance"!==s||t._type!==i.GeometryType.CIRCLE)return u;var p,d,h=!1;p=t.getCenter().clone().toArray();var m=o._type;if(n=l.ViewedType.CIRCLE,m===i.GeometryType.POINT)d=o.getSelPoint().toArray(),r=l.ViewedType.POINT,h=!0;else if(m===i.GeometryType.PLANE){var y=o.getPlane();(u=e.computeLinePlaneDistance(p,t._normal.toArray(),y.origin.clone().toArray(),y.normal.clone().toArray())).type1=n,u.type2=l.ViewedType.INFPLANE,u.aPosition1=p,u.aPosition2=u.aPosition}else if(m===i.GeometryType.CYLINDER||m===i.GeometryType.CONE||m===i.GeometryType.LINE||m===i.GeometryType.CIRCLE||m===i.GeometryType.SPHERE){var g,P,f=o.getPoints();m===i.GeometryType.LINE?(P=f.beginPoint.clone().sub(f.endPoint),g=f.beginPoint.clone(),r=l.ViewedType.AXIS):m===i.GeometryType.CIRCLE?(r=l.ViewedType.CIRCLE,g=o.getCenter(),d=o.getCenter().toArray(),h=!0,P=o._normal):m===i.GeometryType.SPHERE?(r=l.ViewedType.CYCOSP,g=o.getCenter(),d=o.getCenter().toArray(),P=t._normal,h=!0):(P=f.beginPoint.clone().sub(f.endPoint),g=f.beginPoint.clone(),r=l.ViewedType.CYCOSP),h||((u=e.computePointLineDistance(p,g.clone().toArray(),P.clone().toArray())).type2=r,u.type1=n,u.aPosition1=p,u.aPosition2=u.aPosition,u.aExtension=P.clone().toArray())}else m===i.GeometryType.SURFACE&&((u=a.computePointMeshSquaredDistance(p,o.getPrimitive(),o.getReferentialPosition())).type1=n,u.type2=l.ViewedType.SURFACE,u.distance=Math.sqrt(u.squaredDistance));return h&&((u=e.computeTwoPointsDistance(p,d)).type2=r,u.type1=n,u.aPosition1=p,u.aPosition2=d),u.aPosition1&&(u.position1=new c.Vector3(u.aPosition1[0],u.aPosition1[1],u.aPosition1[2])),u.aPosition2&&(u.position2=new c.Vector3(u.aPosition2[0],u.aPosition2[1],u.aPosition2[2])),u.aExtension&&(u.extensionDirection=new c.Vector3(u.aExtension[0],u.aExtension[1],u.aExtension[2])),u},v=function(t,n,o,r){var a={};if("Distance"!==r||t._type!==i.GeometryType.PLANE)return a;var s=o._type,u=t.getPlane(),p=u.origin.clone().clone().toArray();if(n=l.ViewedType.INFPLANE,s===i.GeometryType.PLANE){var d=o.getPlane();(a=e.computeTwoPlanesDistance(u.origin.clone().toArray(),u.normal.clone().toArray(),d.origin.clone().toArray(),d.normal.clone().toArray())).type1=n,a.type2=l.ViewedType.INFPLANE}else if(s===i.GeometryType.CYLINDER||s===i.GeometryType.CONE){var h=o.getPoints(),m=h.beginPoint.clone().sub(h.endPoint);(a=e.computeLinePlaneDistance(h.beginPoint.clone().toArray(),m.toArray(),p,u.normal.toArray())).type1=n,a.type2=l.ViewedType.CYCOSP,a.aPosition1=a.aPosition,a.aPosition2=h.beginPoint.clone().toArray(),a.aExtension=m.clone().toArray()}else s===i.GeometryType.SPHERE&&((a=e.computePointPlaneDistance(o.getCenter().clone().toArray(),p,u.normal.clone().toArray())).type1=n,a.type2=l.ViewedType.CYCOSP,a.aPosition1=o.getCenter().clone().toArray(),a.aPosition2=a.aPosition);return a.aPosition1&&(a.position1=new c.Vector3(a.aPosition1[0],a.aPosition1[1],a.aPosition1[2])),a.aPosition2&&(a.position2=new c.Vector3(a.aPosition2[0],a.aPosition2[1],a.aPosition2[2])),a.aExtension&&(a.extensionDirection=new c.Vector3(a.aExtension[0],a.aExtension[1],a.aExtension[2])),a},T=function(t,n,o,a,s){var u={};if("Distance"!==s||t._type!==i.GeometryType.CYLINDER&&t._type!==i.GeometryType.CONE)return u;var p=o._type,d=t.getPoints(),h=d.beginPoint.clone().sub(d.endPoint);if(n=l.ViewedType.CYCOSP,p===i.GeometryType.CYLINDER||p===i.GeometryType.CONE||p===i.GeometryType.SPHERE||p===i.GeometryType.LINE||p===i.GeometryType.PLANE||p===i.GeometryType.POINT||p===i.GeometryType.CIRCLE){var m,y=o.getPoints(),g=o.getAxis();a=l.ViewedType.CYCOSP,p===i.GeometryType.LINE?(g=y.beginPoint.clone().sub(y.endPoint),m=y.beginPoint.clone(),a=l.ViewedType.Axis):p===i.GeometryType.SPHERE?(m=o.getCenter(),g=h):p===i.GeometryType.PLANE?(m=o.getCoG(),g=h,a=l.ViewedType.INFPLANE):p===i.GeometryType.CIRCLE?(m=o.getCenter(),a=l.ViewedType.Axis):p===i.GeometryType.POINT?(m=o.getPoint(),g=h):y&&(m=y.beginPoint.clone()),(u=e.computeTwoLinesDistance(d.beginPoint.clone().toArray(),h.clone().toArray(),m.clone().toArray(),g.clone().toArray())).type2=a,u.type1=n}else if(p===i.GeometryType.SURFACE){for(var P,f,v,T=o.getPrimitive(),C=o.getReferentialPosition(),_=r.extractMeshVertices(T,C.elements),M=_.length,S=-1,E=0;E<M;E++){var N=e.computePointLineDistance(_[E],d.beginPoint.clone().toArray(),h.toArray());(S<0||S>N.distance)&&(S=N.distance,P=N.aPosition,v=N.relationship,f=_[E])}a=l.ViewedType.SURFACE,u.type2=a,u.type1=n,u.distance=S,u.aPosition1=P,u.aPosition2=f,u.relationship=v}else i.GeometryType.PRODUCT;return u.aPosition1&&(u.position1=new c.Vector3(u.aPosition1[0],u.aPosition1[1],u.aPosition1[2])),u.aPosition2&&(u.position2=new c.Vector3(u.aPosition2[0],u.aPosition2[1],u.aPosition2[2])),u.aExtension?u.extensionDirection=new c.Vector3(u.aExtension[0],u.aExtension[1],u.aExtension[2]):u.extensionDirection=d.beginPoint.clone().sub(d.endPoint).clone(),u},C=function(t,n,o,r,s){var u={};if("Distance"!==s||t._type!==i.GeometryType.SPHERE)return u;var p,d=!1,h=o._type,m=t.getCenter().clone().toArray();return n=l.ViewedType.CYCOSP,h===i.GeometryType.SPHERE?(p=o.getCenter().clone().clone().toArray(),r=l.ViewedType.CYCOSP,d=!0):h===i.GeometryType.SURFACE&&((u=a.computePointMeshSquaredDistance(m,o.getPrimitive(),o.getReferentialPosition())).type1=n,u.type2=l.ViewedType.SURFACE,u.distance=Math.sqrt(u.squaredDistance)),d&&((u=e.computeTwoPointsDistance(m,p)).type2=r,u.type1=n,u.aPosition1=m,u.aPosition2=p),u.aPosition1&&(u.position1=new c.Vector3(u.aPosition1[0],u.aPosition1[1],u.aPosition1[2])),u.aPosition2&&(u.position2=new c.Vector3(u.aPosition2[0],u.aPosition2[1],u.aPosition2[2])),u.aExtension&&(u.extensionDirection=new c.Vector3(u.aExtension[0],u.aExtension[1],u.aExtension[2])),u},_={measureItem:function(e,t,n){var r,a={};n&&!0===n&&(r=(new Date).getTime());var s,c=e.getPathElement(),u=e.getLevel();u?(a.product=c.getElement(u-1),s=o.truncatePathElement(c,u)):(s=m(c))&&s.getLastElement(!0)&&(a.product=s.getLastElement(!0));var p=e.getType();if(void 0!==t&&t===l.ViewedType.PRODUCT){e.updateProductMeasurable(),a.type=i.GeometryType.PRODUCT,a.position=e.getSelPoint(),a.aabb=_.retrieveProductAABB(a.product,s.getWorldMatrix()),a.volume=e.getVolume(),a.area=e.getArea(),a.cog=e.getCoG(),a.length=e.getLength();var d=e.getPoints();d&&d.beginPoint&&d.endPoint&&(a.startpoint=d.beginPoint,a.endpoint=d.endPoint),a.originPoint=e.getOriginPoint()}else if(void 0!==t&&t===l.ViewedType.POINT||p===i.GeometryType.POINT||p===i.GeometryType.PICKINGPT)a.type=i.GeometryType.POINT,a.position=e.getPoint(),a.position||(a.position=e.getSelPoint());else if(p===i.GeometryType.LINE){a.type=p,a.length=e.getLength();var h=e.getPoints();a.point1=h.beginPoint,a.point2=h.endPoint,a.position=a.point1.clone().add(a.point2).multiplyScalar(.5)}else if(p===i.GeometryType.CIRCLE)a.type=p,a.length=e.getLength(),a.position=e.getSelPoint(),a.radius=e.getRadius(),a.center=e.getCenter(),a.normal=e.getAxis(),a.arcLength=e.getArcLength(),a.arcMidPoint=e.getArcMidPoint();else if(p===i.GeometryType.CYLINDER){a.type=p,a.area=e.getArea(),a.cog=e.getCoG(),a.position=e.getSelPoint(),a.radius=e.getRadius();var y=e.getPoints();a.point1=y.beginPoint,a.point2=y.endPoint,a.height=e.getHeight()}else if(p===i.GeometryType.CONE){a.type=p,a.area=e.getArea(),a.cog=e.getCoG(),a.position=e.getSelPoint(),a.apex=e.getApex(),a.semiAngle=e.getSemiAngle(),a.axis=e.getAxis();var g=e.getPoints();a.point1=g.beginPoint,a.point2=g.endPoint,a.height=e.getHeight(),a.minRadius=e.getMinRadius(),a.maxRadius=e.getMaxRadius()}else if(p===i.GeometryType.SPHERE)a.type=p,a.area=e.getArea(),a.cog=e.getCoG(),a.position=e.getSelPoint(),a.radius=e.getRadius(),a.center=e.getCenter();else if(p===i.GeometryType.PLANE){a.type=p,a.area=e.getArea(),a.cog=e.getCoG(),a.position=e.getSelPoint();var P=e.getPlane();a.origin=P.origin,a.normal=P.normal}else p===i.GeometryType.CURVE?(a.type=p,a.length=e.getLength(),a.position=e.getSelPoint()):p===i.GeometryType.SURFACE&&(a.type=p,a.area=e.getArea(),a.cog=e.getCoG(),a.position=e.getSelPoint());return n&&!0===n&&window.console.log("PCS measureItem="+((new Date).getTime()-r)),a},measureProduct:function(e){var t,i={},a=e.getPathElement(),l=e.getLevel();t=l?o.truncatePathElement(a,l):m(a);var h,y=o.getRenderables(t),g=0,P=0,f=0,v=[0,0,0],T=[0,0,0],C=0,_=[0,0,0],M=[0,0,0],S=[0,0,0],E=0,N=0,D=!1,b=!1,A=y.length;return a&&(i.originPoint=a.getMatrix().getPosition()),function(){for(var e=0;e<A;e++)for(var t=y[e].matrix.elements,i=y[e].geometry,o=i.length,a=0;a<o;a++){i[a].startIteration();for(var s=i[a].drawingGroups,l=s.length,m=0;m<l;m++)if(s[m]._geomType&&("FACE"===d.GeomTypeString[s[m]._geomType]||"EDGE"===d.GeomTypeString[s[m]._geomType]||"WIRE_EDGE"===d.GeomTypeString[s[m]._geomType]||"FREE_POINT"===d.GeomTypeString[s[m]._geomType]))for(var R=s[m].getPrimitivesCount(),w=0;w<R;w++){var V=new d.SGPrimitiveHelper;V.set(s[m],w);var I=u.getFromSGNode(V),x=p.recognizeNonCanonicGeometry(V,new c.Matrix4,!0);if("FACE"===d.GeomTypeString[s[m]._geomType]){D=!0;var G=I.getBodyDimension();if(3===G){P+=x.area;var L=r._computeVolume(V,S);g+=L.volume;var B=n.transformPoint(L.aCog,t);v=n.multiplyAndAdd(B,L.volume,v)}else if(2===G){f+=x.area;var U=n.transformPoint(x.aCog,t);T=n.multiplyAndAdd(U,x.area,T)}}else if(D||"EDGE"!==d.GeomTypeString[s[m]._geomType]&&"WIRE_EDGE"!==d.GeomTypeString[s[m]._geomType]){if(!D&&!b&&"FREE_POINT"===d.GeomTypeString[s[m]._geomType]&&1==++N&&r.verifyMesh(V)){var O=new c.Matrix4;h=r.extractMeshVertices(V,O.elements)}}else if(b=!0,E++,x.length&&x.length>0&&(C+=x.length,1===E)){if(void 0===x.point1&&void 0===x.point2&&r.verifyMesh(V)){var z=new c.Matrix4,q=r.extractMeshVertices(V,z.elements),k=p._recognizeCurve(q,!0);0===k.returnCode&&(x.point1=p._buildVector3(k.aPoint1),x.point2=p._buildVector3(k.aPoint2))}if(x.point1&&x.point2){var F=[x.point1.x,x.point1.y,x.point1.z],H=[x.point2.x,x.point2.y,x.point2.z];_=n.transformPoint(F,t),M=n.transformPoint(H,t)}}}i[a].endIteration()}}(),D?(g>0&&(i.volume=g),(P>0||f>0)&&(i.area=g>0?P>0?P:0:f>0?f:0),(g>0||P>0||f>0)&&(v=s.isZero(g)?s.isZero(f)?[0,0,0]:n.multiply(T,1/f):n.multiply(v,1/g),i.cog=new c.Vector3(v[0],v[1],v[2]))):!D&&b&&C>0?(i.length=C,1===E&&(i.startpoint=new c.Vector3(_[0],_[1],_[2]),i.endpoint=new c.Vector3(M[0],M[1],M[2]))):D||b||1!==N||(i.cog=new c.Vector3(h[0][0],h[0][1],h[0][2])),i},measureBetween2DGeometries:function(t,n,o,r,s){var u,p,d={},y=n.getType(),g=r.getType();if("Angle"===t?d=_.measureBetween(n,l.ViewedType.AXIS,r,l.ViewedType.AXIS):"Distance"===t?function(){if(o===l.ViewedType.POINT&&s===l.ViewedType.POINT&&y!==i.GeometryType.POINT&&y!==i.GeometryType.POINT&&(y=i.GeometryType.POINT,g=i.GeometryType.POINT),u=n.getSelPoint().toArray(),p=r.getSelPoint().toArray(),y===i.GeometryType.CIRCLE&&(u=n.getCenter().toArray(),o=l.ViewedType.CENTER),g===i.GeometryType.CIRCLE&&(p=r.getCenter().toArray(),s=l.ViewedType.CENTER),y!==i.GeometryType.CIRCLE&&y!==i.GeometryType.POINT||g!==i.GeometryType.CIRCLE&&g!==i.GeometryType.POINT){if(y===i.GeometryType.CIRCLE)(d=a.computePointMeshSquaredDistance(u,r.getPrimitive(),r.getReferentialPosition())).type1=l.ViewedType.POINT,d.type2=_.MeasuredType.CURVE,d.distance=Math.sqrt(d.squaredDistance);else if(g===i.GeometryType.CIRCLE){(d=a.computePointMeshSquaredDistance(p,n.getPrimitive(),n.getReferentialPosition())).type1=_.MeasuredType.CURVE,d.type2=l.ViewedType.POINT;var t=d.aPosition1;d.aPosition1=d.aPosition2,d.aPosition2=t,d.distance=Math.sqrt(d.squaredDistance)}else if(y===i.GeometryType.LINE&&g===i.GeometryType.LINE){var h={};if((h=_.measureBetween(n,o,r,s)).position1&&h.position2){var m=r.getPoints().endPoint,P=m.clone().sub(r.getPoints().beginPoint),f=h.position1.clone(),v=e.computePointLineDistance(f.toArray(),m.toArray(),P.toArray());0===v.returnCode&&(h.position2=new c.Vector3(v.aPosition[0],v.aPosition[1],v.aPosition[2]),h.distance=v.distance)}d=h}}else(d=e.computeTwoPointsDistance(u,p)).type2=s,d.type1=o,d.aPosition1=u,d.aPosition2=p}():"MinimumDistance"!==t&&"MaximumDistance"!==t||function(){if(y===i.GeometryType.CIRCLE&&(o=l.ViewedType.CURVE),g===i.GeometryType.CIRCLE&&(s=l.ViewedType.CURVE),y===i.GeometryType.POINT)u=n.getSelPoint().toArray(),(d="MaximumDistance"===t?a._computePointMeshSquaredMaxDistance(u,r.getPrimitive(),r.getReferentialPosition()):a.computePointMeshSquaredDistance(u,r.getPrimitive(),r.getReferentialPosition())).type1=l.ViewedType.POINT,d.type2=_.MeasuredType.CURVE;else if(g===i.GeometryType.POINT){p=r.getSelPoint().toArray(),(d="MaximumDistance"===t?a._computePointMeshSquaredMaxDistance(p,n.getPrimitive(),n.getReferentialPosition()):a.computePointMeshSquaredDistance(p,n.getPrimitive(),n.getReferentialPosition())).type1=_.MeasuredType.CURVE,d.type2=l.ViewedType.POINT;var e=d.aPosition1;d.aPosition1=d.aPosition2,d.aPosition2=e}else{if(d="MaximumDistance"===t?a._computeTwoMeshesSquaredMaxDistance(n.getPrimitive(),n.getReferentialPosition(),r.getPrimitive(),r.getReferentialPosition()):a.computeTwoMeshesSquaredDistance(n.getPrimitive(),n.getReferentialPosition(),r.getPrimitive(),r.getReferentialPosition()),n._normal&&r._normal){var m=new c.Vector3(d.aPosition1[0],d.aPosition1[1],d.aPosition1[2]),P=new c.Vector3(d.aPosition2[0],d.aPosition2[1],d.aPosition2[2]);Math.abs(n._normal.angleTo(P.clone().sub(m))-Math.PI/2)<h&&(d.aExtension=n._normal.clone().toArray())}if(d.type1=l.ViewedType.CURVE,d.type2=l.ViewedType.CURVE,y===i.GeometryType.LINE&&g===i.GeometryType.LINE){var f=n.getPoints().endPoint.clone().sub(n.getPoints().beginPoint),v=r.getPoints().endPoint.clone().sub(r.getPoints().beginPoint),T=f.normalize().dot(v.normalize());1!==Math.abs(T)&&(d.angle=1)}}d.distance="MaximumDistance"===t?Math.sqrt(d.squaredMaxDistance):Math.sqrt(d.squaredDistance)}(),!d.product1){var P=n.getPathElement();P&&(d.product1=m(P).getLastElement())}if(!d.product2){var f=r.getPathElement();f&&(d.product2=m(f).getLastElement())}return d.aPosition1&&!d.position1&&(d.position1=new c.Vector3(d.aPosition1[0],d.aPosition1[1],d.aPosition1[2])),d.aPosition2&&!d.position2&&(d.position2=new c.Vector3(d.aPosition2[0],d.aPosition2[1],d.aPosition2[2])),d.aExtension&&!d.extensionDirection&&(d.extensionDirection=new c.Vector3(d.aExtension[0],d.aExtension[1],d.aExtension[2])),n.get2DScale&&d.distance&&(d.distance=d.distance/n.get2DScale()),d},measureBetween:function(t,n,o,r,s,u,p){var d,M={},S=t._type,E=o._type,N=Number.MAX_VALUE,D=!1,b=.001;function A(e){return e===i.GeometryType.CIRCLE||e===i.GeometryType.CYLINDER||e===i.GeometryType.CONE||e===i.GeometryType.SPHERE||e===i.GeometryType.LINE||e===i.GeometryType.PLANE||e===i.GeometryType.POINT}function R(e,t){var n=!1,o=t._type,r=e.getAxis(),a=t.getAxis();if(o===i.GeometryType.SPHERE||o===i.GeometryType.POINT)a=r;else if(o===i.GeometryType.PLANE)a=t._normal;else if(o===i.GeometryType.CIRCLE)a=t.getAxis();else if(o===i.GeometryType.LINE){var s=t.getPoints();a=s.beginPoint.clone().sub(s.endPoint.clone())}var l=r.normalize().dot(a.normalize());return o===i.GeometryType.PLANE?b>Math.abs(l)&&(n=!0):1-Math.abs(l)<b&&(n=!0),n}function w(t,n){var o,r=!1,a=n._type,s=t.getAxis(),l=n.getAxis(),c=t.getCenter();if(a===i.GeometryType.LINE){var u=n.getPoints();l=u.beginPoint.clone().sub(u.endPoint.clone()),o=e.computeLinePlaneDistance(u.beginPoint.clone().toArray(),l.toArray(),c.toArray(),s.toArray())}else if(a===i.GeometryType.PLANE||a===i.GeometryType.CIRCLE){var p=n.getCenter();a===i.GeometryType.PLANE&&(l=n.getPlane().normal,p=n.getPlane().origin),o=e.computeTwoPlanesDistance(c.toArray(),s.toArray(),p.toArray(),l.toArray())}else a===i.GeometryType.POINT&&(o=e.computePointPlaneDistance(n.getPoint().toArray(),c.toArray(),s.toArray()));return o&&o.relationship===i.Relationship.COINCIDENT&&(r=!0),r}function V(){if(t.extraPolateGeom){if(function(){if(p||!t.extraPolateGeom)return 0;var a,s;if(S===i.GeometryType.SPHERE&&E===i.GeometryType.SPHERE)M.position1=t.getCenter(),M.position2=o.getCenter(),M.distance=M.position1.clone().distanceTo(M.position2.clone()),a=M.position1.clone(),s=M.position2.clone();else if(S===i.GeometryType.CYLINDER||S===i.GeometryType.CONE)a=(M=T(t,n,o,r,"Distance")).position1.clone(),s=M.position2.clone();else{if(E!==i.GeometryType.CYLINDER&&E!==i.GeometryType.CONE)return 0;a=(M=T(o,r,t,n,"Distance")).position2.clone(),s=M.position1.clone()}if(M){var l,d,h,m=S===i.GeometryType.CONE?t.getMaxRadius():t.getRadius(),y=E===i.GeometryType.CONE?o.getMaxRadius():o.getRadius();if("MinimumDistance"===u?(l=s.clone().sub(a).normalize(),d=a.clone().sub(s).normalize()):(l=a.clone().sub(s).normalize(),d=s.clone().sub(a).normalize()),m&&(h=l.multiplyScalar(m),a.add(h)),y&&(h=d.multiplyScalar(y),s.add(h)),M.distance=a.distanceTo(s),S===i.GeometryType.CYLINDER&&E===i.GeometryType.CYLINDER){var g=t.getAxis(),P=o.getAxis(),f=o.getPoints(),v=e.computePointLineDistance(o.getSelPoint().toArray(),f.beginPoint.toArray(),P.clone().toArray());if(v.aPosition){var C=v.aPosition;(v=e.computePointLineDistance(C,s.clone().toArray(),P.clone().normalize().toArray())).aPosition&&3===v.aPosition.length&&(s=new c.Vector3(v.aPosition[0],v.aPosition[1],v.aPosition[2]),(v=e.computePointLineDistance(v.aPosition,a.clone().toArray(),g.clone().normalize().toArray())).aPosition&&3===v.aPosition.length&&(a=new c.Vector3(v.aPosition[0],v.aPosition[1],v.aPosition[2])))}}return M.position1=a,M.position2=s,M.aPosition1=a.toArray(),M.aPosition2=s.toArray(),M.squaredMaxDistance&&(M.distance=Math.sqrt(M.squaredMaxDistance)),1}return 0}())return 1;var a,s,l,d,h,m=t.getRadius(),y=o.getRadius();if(S===i.GeometryType.CIRCLE)a=(M=f(t,n,o,r,"Distance")).position1.clone(),s=M.position2.clone();else{if(E!==i.GeometryType.CIRCLE)return 0;a=(M=f(o,r,t,n,"Distance")).position2.clone(),s=M.position1.clone()}if(M)return"MinimumDistance"===u?(l=s.clone().sub(a).normalize(),d=a.clone().sub(s).normalize()):(l=a.clone().sub(s).normalize(),d=s.clone().sub(a).normalize()),m&&(h=l.multiplyScalar(m),a.add(h)),y&&(h=d.multiplyScalar(y),s.add(h)),M.distance=a.distanceTo(s),M.position1=a,M.position2=s,M.aPosition1=a.toArray(),M.aPosition2=s.toArray(),M.squaredMaxDistance&&(M.distance=Math.sqrt(M.squaredMaxDistance)),1}return 0}function I(){S===i.GeometryType.POINT||n===l.ViewedType.POINT?M=y(t,n,o,r,u):E===i.GeometryType.POINT||r===l.ViewedType.POINT?(M=y(o,r,t,n,u),D=!0):S===i.GeometryType.LINE?M=g(t,n,o,r,u):E===i.GeometryType.LINE?(M=g(o,r,t,n,u),D=!0):S===i.GeometryType.CURVE?M=P(t,n,o,r,u):E===i.GeometryType.CURVE?(M=P(o,r,t,n,u),D=!0):S===i.GeometryType.CIRCLE?E===i.GeometryType.PRODUCT?((M=_.measureBetweenWithProducts(_.MeasuredType.CENTER,t,o,N)).squaredDistance&&(M.distance=Math.sqrt(M.squaredDistance)),M.type1=l.ViewedType.CIRCLE,M.type2=l.ViewedType.PRODUCT,M.aPosition1&&(M.position1=new c.Vector3(M.aPosition1[0],M.aPosition1[1],M.aPosition1[2])),M.aPosition2&&(M.position2=new c.Vector3(M.aPosition2[0],M.aPosition2[1],M.aPosition2[2])),M.aExtension&&(M.extensionDirection=new c.Vector3(M.aExtension[0],M.aExtension[1],M.aExtension[2]))):M=f(t,n,o,r,u):E===i.GeometryType.CIRCLE?(S===i.GeometryType.PRODUCT?((M=_.measureBetweenWithProducts(_.MeasuredType.CENTER,o,t,N)).squaredDistance&&(M.distance=Math.sqrt(M.squaredDistance)),M.type2=l.ViewedType.CIRCLE,M.type1=l.ViewedType.PRODUCT,M.aPosition1&&(M.position1=new c.Vector3(M.aPosition1[0],M.aPosition1[1],M.aPosition1[2])),M.aPosition2&&(M.position2=new c.Vector3(M.aPosition2[0],M.aPosition2[1],M.aPosition2[2])),M.aExtension&&(M.extensionDirection=new c.Vector3(M.aExtension[0],M.aExtension[1],M.aExtension[2]))):M=f(o,r,t,n,u),D=!0):S===i.GeometryType.PLANE?M=v(t,n,o,u):E===i.GeometryType.PLANE?(M=v(o,r,t,u),D=!0):S===i.GeometryType.CYLINDER||S===i.GeometryType.CONE?M=T(t,n,o,r,u):E===i.GeometryType.CYLINDER||E===i.GeometryType.CONE?(M=T(o,r,t,n,u),D=!0):S===i.GeometryType.SPHERE?E===i.GeometryType.PRODUCT?((M=_.measureBetweenWithProducts(_.MeasuredType.CENTER,t,o,N)).squaredDistance&&(M.distance=Math.sqrt(M.squaredDistance)),M.type1=l.ViewedType.SPHERE,M.type2=l.ViewedType.PRODUCT,M.aPosition1&&(M.position1=new c.Vector3(M.aPosition1[0],M.aPosition1[1],M.aPosition1[2])),M.aPosition2&&(M.position2=new c.Vector3(M.aPosition2[0],M.aPosition2[1],M.aPosition2[2])),M.aExtension&&(M.extensionDirection=new c.Vector3(M.aExtension[0],M.aExtension[1],M.aExtension[2]))):M=C(t,n,o,r,u):E===i.GeometryType.SPHERE&&(S===i.GeometryType.PRODUCT?((M=_.measureBetweenWithProducts(_.MeasuredType.CENTER,o,t,N)).squaredDistance&&(M.distance=Math.sqrt(M.squaredDistance)),M.type2=l.ViewedType.SPHERE,M.type1=l.ViewedType.PRODUCT,M.aPosition1&&(M.position1=new c.Vector3(M.aPosition1[0],M.aPosition1[1],M.aPosition1[2])),M.aPosition2&&(M.position2=new c.Vector3(M.aPosition2[0],M.aPosition2[1],M.aPosition2[2])),M.aExtension&&(M.extensionDirection=new c.Vector3(M.aExtension[0],M.aExtension[1],M.aExtension[2]))):M=C(o,r,t,n,u),D=!0)}n===l.ViewedType.POINT&&r===l.ViewedType.POINT||A(S)&&A(E)&&(d=!1,S===i.GeometryType.SPHERE||E===i.GeometryType.SPHERE?d=!0:S===i.GeometryType.CYLINDER||S===i.GeometryType.CONE?d=R(t,o):E===i.GeometryType.CYLINDER||E===i.GeometryType.CONE?d=R(o,t):S===i.GeometryType.CIRCLE?d=w(t,o):E===i.GeometryType.CIRCLE&&(d=w(o,t)),d&&(t.extraPolateGeom=d)),"Distance"===u?function(){if(I(),void 0===M.product1){var i=t.getPathElement();i&&(M.product1=m(i).getLastElement())}if(void 0===M.product2){var a=o.getPathElement();a&&(M.product2=m(a).getLastElement())}var s;D&&M&&(M.aPosition1&&M.aPosition2&&(s=M.aPosition1,M.aPosition1=M.aPosition2,M.aPosition2=s),M.position1&&M.aPosition2&&(s=M.position1,M.position1=M.position2,M.position2=s)),void 0===M.distance&&(n!==l.ViewedType.POINT&&n!==l.ViewedType.AXIS&&n!==l.ViewedType.CENTER&&n!==l.ViewedType.INFPLANE||r!==l.ViewedType.POINT&&r!==l.ViewedType.AXIS&&r!==l.ViewedType.CENTER&&r!==l.ViewedType.INFPLANE||(M=e.measureBetweenInfinite(t,n,o,r)))}():"Angle"===u?M=e.measureBetweenInfinite(t,l.ViewedType.AXIS,o,l.ViewedType.AXIS):"MaximumDistance"===u||"LocalMaximumDistance"===u?function(){if("LocalMaximumDistance"===u||!V()){if(S===i.GeometryType.POINT||n===l.ViewedType.POINT){var e=t.getSelPoint().toArray();M=a._computePointMeshSquaredMaxDistance(e,o.getPrimitive(),o.getReferentialPosition(),0)}else if(E===i.GeometryType.POINT||r===l.ViewedType.POINT){var c=o.getSelPoint().toArray();M=a._computePointMeshSquaredMaxDistance(c,t.getPrimitive(),t.getReferentialPosition(),0)}else if(S===i.GeometryType.PRODUCT){N=0;var p=_.MeasuredType.MESH;E===i.GeometryType.PRODUCT&&(p=_.MeasuredType.PRODUCT),M=_.measureBetweenWithProducts(p,o,t,N,s,!0)}else E===i.GeometryType.PRODUCT?(N=0,M=_.measureBetweenWithProducts(_.MeasuredType.MESH,t,o,N,s,!0)):((M=a._computeTwoMeshesSquaredMaxDistance(t.getPrimitive(),t.getReferentialPosition(),o.getPrimitive(),o.getReferentialPosition())).type1=_.MeasuredType.MESH,M.type2=_.MeasuredType.MESH);M.squaredMaxDistance&&(M.distance=Math.sqrt(M.squaredMaxDistance))}}():function(){if("LocalMinimumDistance"===u||!V())if(n!==l.ViewedType.POINT&&n!==l.ViewedType.AXIS&&n!==l.ViewedType.CENTER&&n!==l.ViewedType.INFPLANE||r!==l.ViewedType.POINT&&r!==l.ViewedType.AXIS&&r!==l.ViewedType.CENTER&&r!==l.ViewedType.INFPLANE||n===l.ViewedType.INFPLANE&&r===l.ViewedType.INFPLANE)if(n===l.ViewedType.PRODUCT||r===l.ViewedType.PRODUCT)!function(){if(t.getSelPoint()&&o.getSelPoint()){var a=e.computeTwoPointsDistance(t.getSelPoint().toArray(),o.getSelPoint().toArray());N=a.distance*a.distance}if(n===l.ViewedType.PRODUCT&&r===l.ViewedType.PRODUCT)(M=_.measureBetweenWithProducts(_.MeasuredType.PRODUCT,t,o,N,s)).type1=n,M.type2=r;else if(n!==l.ViewedType.PRODUCT||r!==i.GeometryType.POINT&&r!==l.ViewedType.CENTER)if(r!==l.ViewedType.PRODUCT||n!==i.GeometryType.POINT&&n!==l.ViewedType.CENTER)if(n===l.ViewedType.PRODUCT){(M=_.measureBetweenWithProducts(_.MeasuredType.MESH,o,t,N,s)).type1=_.MeasuredType.MESH,M.type2=_.MeasuredType.MESH;var c=M.aPosition1;M.aPosition1=M.aPosition2,M.aPosition2=c;var u=M.product1;M.product1=M.product2,M.product2=u}else(M=_.measureBetweenWithProducts(_.MeasuredType.MESH,t,o,N,s)).type1=_.MeasuredType.MESH,M.type2=_.MeasuredType.MESH;else(M=_.measureBetweenWithProducts(_.MeasuredType.POINT,t,o,N,s)).type1=l.ViewedType.POINT,M.type2=r;else{(M=_.measureBetweenWithProducts(_.MeasuredType.POINT,o,t,N,s)).type1=n,M.type2=l.ViewedType.POINT;var p=M.aPosition1;M.aPosition1=M.aPosition2,M.aPosition2=p;var d=M.product1;M.product1=M.product2,M.product2=d}M.distance=Math.sqrt(M.squaredDistance)}();else{if(n!==l.ViewedType.POINT&&n!==l.ViewedType.CENTER||r!==l.ViewedType.CURVE&&r!==l.ViewedType.SURFACE&&r!==l.ViewedType.CIRCLE&&r!==l.ViewedType.CYCOSP)if(r!==l.ViewedType.POINT&&r!==l.ViewedType.CENTER||n!==l.ViewedType.CURVE&&n!==l.ViewedType.SURFACE&&n!==l.ViewedType.CIRCLE&&n!==l.ViewedType.CYCOSP){if(M=a.computeTwoMeshesSquaredDistance(t.getPrimitive(),t.getReferentialPosition(),o.getPrimitive(),o.getReferentialPosition()),t._normal&&o._normal){var p=new c.Vector3(M.aPosition1[0],M.aPosition1[1],M.aPosition1[2]),d=new c.Vector3(M.aPosition2[0],M.aPosition2[1],M.aPosition2[2]);Math.abs(t._normal.angleTo(d.clone().sub(p))-Math.PI/2)<h&&(M.aExtension=t._normal.clone().toArray())}M.type1=_.MeasuredType.MESH,M.type2=_.MeasuredType.MESH}else{var m=r===l.ViewedType.CENTER?o.getCenter().toArray():o.getSelPoint().toArray();(M=a.computePointMeshSquaredDistance(m,t.getPrimitive(),t.getReferentialPosition())).type1=_.MeasuredType.MESH,M.type2=l.ViewedType.POINT;var y=M.aPosition1;M.aPosition1=M.aPosition2,M.aPosition2=y}else{var g=n===l.ViewedType.CENTER?t.getCenter().toArray():t.getSelPoint().toArray();(M=a.computePointMeshSquaredDistance(g,o.getPrimitive(),o.getReferentialPosition())).type1=l.ViewedType.POINT,M.type2=_.MeasuredType.MESH}M.distance=Math.sqrt(M.squaredDistance)}else M=e.measureBetweenInfinite(t,n,o,r)}(),"MaximumDistance"!==u&&"MinimumDistance"!==u||function(){if(!M.angle){var a=!1;if(n===l.ViewedType.POINT||S!==i.GeometryType.LINE&&S!==i.GeometryType.PLANE&&S!==i.GeometryType.CYLINDER&&S!==i.GeometryType.CONE||(a=!0),a=!(!a||r===l.ViewedType.POINT||E!==i.GeometryType.LINE&&E!==i.GeometryType.PLANE&&E!==i.GeometryType.CYLINDER&&E!==i.GeometryType.CONE)){var s=n,c=r;S===i.GeometryType.LINE&&(s=l.ViewedType.AXIS),E===i.GeometryType.LINE&&(c=l.ViewedType.AXIS);var u=e.measureBetweenInfinite(t,s,o,c);u.angle&&(M.angle=u.angle)}}}();for(var x=[S,E],G=1;G<=x.length;G++){var L="type"+G;switch(x[G-1]){case i.GeometryType.POINT:M[L]=l.ViewedType.POINT;break;case i.GeometryType.CURVE:case i.GeometryType.LINE:M[L]=l.ViewedType.CURVE;break;case i.GeometryType.CIRCLE:M[L]=l.ViewedType.CIRCLE;break;case i.GeometryType.SURFACE:M[L]=l.ViewedType.SURFACE;break;case i.GeometryType.PLANE:M[L]=l.ViewedType.INFPLANE;break;case i.GeometryType.CYLINDER:case i.GeometryType.CONE:case i.GeometryType.SPHERE:M[L]=l.ViewedType.CYCOSP;break;case i.GeometryType.PRODUCT:M[L]=l.ViewedType.PRODUCT}}if(n!==l.ViewedType.POINT&&n!==l.ViewedType.CENTER||(M.type1=n),r!==l.ViewedType.POINT&&r!==l.ViewedType.CENTER||(M.type2=r),void 0===M.product1){var B=t.getPathElement();B&&(M.product1=m(B).getLastElement())}if(void 0===M.product2){var U=o.getPathElement();U&&(M.product2=m(U).getLastElement())}return M.aPosition1&&(M.position1=new c.Vector3(M.aPosition1[0],M.aPosition1[1],M.aPosition1[2])),M.aPosition2&&(M.position2=new c.Vector3(M.aPosition2[0],M.aPosition2[1],M.aPosition2[2])),M.aExtension&&(M.extensionDirection=new c.Vector3(M.aExtension[0],M.aExtension[1],M.aExtension[2])),M},measureThreepoints:function(e,t,i){var o={},r=e.getSelPoint(),a=t.getSelPoint(),s=i.getSelPoint();if(r&&a&&s){var l=r.toArray(),u=a.toArray(),p=s.toArray(),d=n.sub(l,u),h=n.sub(u,p);o.angle=Math.PI-n.angle(d,h);var m,y=n.cross(d,h);if(o.normal=new c.Vector3(y[0],y[1],y[2]),n.areEqual(l,u))m=n.multiply(n.add(l,p),.5);else if(n.areEqual(l,p))m=n.multiply(n.add(l,u),.5);else if(n.areEqual(u,p))m=n.multiply(n.add(l,u),.5);else{var g=n.squaredLength(y);if(g>1e-6){var P=(.5*n.squaredLength(h)+.5*n.dot(d,h))/g,f=n.multiplyAndAdd(d,.5,l);m=n.multiplyAndAdd(n.cross(d,y),-P,f)}}void 0!==m&&(o.radius=n.subAndLength(m,l),o.center=new c.Vector3(m[0],m[1],m[2]))}return o},measureBetweenWithProducts:function(e,n,r,a,s,l){var c,u={};s&&!0===s&&(c=(new Date).getTime());var p=a||Number.MAX_VALUE;l&&(p=0),u.squaredDistance=p;var d,h,y,g=e===_.MeasuredType.PRODUCT,P=n.getPathElement(),f=n.getLevel();f?(d=P.getElement(f-1),h=o.truncatePathElement(P,f)):(h=m(P),d=h.getLastElement());var v,T=r.getPathElement(),C=r.getLevel();C?(y=T.getElement(C-1),v=o.truncatePathElement(T,C)):(v=m(T),y=v.getLastElement());var M,S,E=!1;if(g){var N,D,b,A=h.externalPath.length,R=v.externalPath.length;A<R?(N=A,D=v,b=h):(N=R,D=h,b=v),E=!0;for(var w=0;E&&w<N;w++)E=D.externalPath[w]===b.externalPath[w]}var V=[],I=[];function x(e,i,a){var s,c,u,d,h=!g;if(g&&(M=_.retrieveProductAABB(e[a].getLastElement(!0),n.getReferentialPosition())),S=_.retrieveProductAABB(i[a].getLastElement(!0),r.getReferentialPosition()),M.AABB&&M.AABB[0]&&(M=M.AABB[0]),c=l?t.computeAABBSquaredMaxDistance(M,S):t.computeAABBSquaredDistance(M,S),!l&&c<p||l&&c>p)if(g&&(h=o.isLeaf(e[a].getLastElement(!0))),s=o.isLeaf(i[a].getLastElement(!0)),h&&s)g?V.push(e[a]):V.push(n),I.push(i[a]);else if(h||!s&&e[a].getLastElement(!0).bSphere.radius<i[a].getLastElement(!0).bSphere.radius){d=(u=i[a].getChildrenPathes()).length;for(var m=0;m<d;m++)o.isReferenceOrInstance(u[m].getLastElement())&&(g?e.push(e[a]):e.push(n),i.push(u[m]))}else{d=(u=e[a].getChildrenPathes()).length;for(var y=0;y<d;y++)o.isReferenceOrInstance(u[y].getLastElement())&&(e.push(u[y]),i.push(i[a]))}}return E?(u.squaredDistance=0,u.aPosition1=n.getSelPoint().toArray(),u.aPosition2=u.aPosition1,u.product1=d,u.product2=y):function(){s&&!0===s&&(g?window.console.log("Measure Products: "+d.name+" / "+y.name):window.console.log("Measure Products: "+e+" / "+y.name));var o=[],a=[],m=[],P=[],T=0;if(n.isPartial())for(T=0;T<n._partialPaths.length;T++)o.push(n._partialPaths[T]);else g||n.getType()===i.GeometryType.PRODUCT?o.push(h):o.push(n);if(r.isPartial())for(T=0;T<r._partialPaths.length;T++)a.push(r._partialPaths[T]);else a.push(v);for(T=0;T<o.length;T++)for(var S=0;S<a.length;S++)m.push(o[T]),P.push(a[S]);for(g||(M=e===_.MeasuredType.MESH?_.retrieveMeshPrimitivesAndAABB(n):_.MeasuredType.CENTER===e?t.computeAABBForPoint(n.getCenter().toArray()):t.computeAABBForPoint(n.getSelPoint().toArray())),T=0;T<m.length;T++)x(m,P,T);for(var E=V.length,N=(new Date).getTime()-c,D=0;D<E;D++){var b;b=V[D];var A=I[D],R=_.measureBetweenWithParts(e,b,A,p,s,l);(!l&&R.squaredDistance<p||l&&R.squaredMaxDistance>p)&&(R.squaredDistance?p=R.squaredDistance:R.squaredMaxDistance&&(p=R.squaredMaxDistance),(u=R).product1=V[D],u.product2=I[D])}!f&&g||(u.product1=d),C&&(u.product2=y),s&&!0===s&&window.console.log("Measure Products: Parts Couples="+E+" Scan duration="+N+" Duration="+((new Date).getTime()-c))}(),u},measureBetweenWithParts:function(e,i,n,o,r,a){var s={},l=null;switch(e){case _.MeasuredType.PRODUCT:s=_.retrievePartPrimitivesAndAABB(i),l=i.getWorldMatrix();break;case _.MeasuredType.MESH:s=_.retrieveMeshPrimitivesAndAABB(i),l=i.getReferentialPosition();break;case _.MeasuredType.POINT:s.primitives=[],s.primitives[0]=i.getSelPoint().toArray(),s.AABB=[],s.AABB[0]=t.computeAABBForPoint(s.primitives[0]),l=null;break;case _.MeasuredType.CENTER:s.primitives=[],s.primitives[0]=i.getCenter().toArray(),s.AABB=[],s.AABB[0]=t.computeAABBForPoint(s.primitives[0]),l=null}var c=_.retrievePartPrimitivesAndAABB(n),u=n.getWorldMatrix();return _.measureBetweenPrimitivesAABB(e,s,l,c,u,o,r,a)},retrieveProductAABB:function(e,t){var i=[],n=e.bBox.clone().applyMatrix4(t);return i[0]=n.min.x,i[1]=n.min.y,i[2]=n.min.z,i[3]=n.max.x,i[4]=n.max.y,i[5]=n.max.z,i},retrievePartPrimitivesAndAABB:function(e){for(var t={primitives:[]},i=o.getRenderables(e),n=i.length,a=0;a<n;a++)for(var s=i[a].geometry,l=s.length,u=0;u<l;u++){s[u].startIteration();for(var p=s[u].drawingGroups,h=p.length,m=0;m<h;m++)if(p[m]._geomType&&"FACE"===d.GeomTypeString[p[m]._geomType])for(var y=p[m].getPrimitivesCount(),g=0;g<y;g++){var P=new d.SGPrimitiveHelper;P.set(p[m],g),t.primitives.push(P)}s[u].endIteration()}if(0<t.primitives.length){var f=r.extractMeshVertices(t.primitives[0],void 0,1);0<f.length&&(t.vertice=new c.Vector3(f[0][0],f[0][1],f[0][2]));var v=r.extractMeshNormals(t.primitives[0],void 0,1);0<v.length&&(t.normal=new c.Vector3(v[0][0],v[0][1],v[0][2]))}t.AABB=[];for(var T=e.getWorldMatrix().elements,C=t.primitives.length,_=0;_<C;_++)t.AABB[_]=r.computeAABB(t.primitives[_],T);return t},retrieveMeshPrimitivesAndAABB:function(e){var t={primitives:[]};return t.primitives.push(e.getPrimitive()),t.AABB=[],t.AABB[0]=r.computeAABB(e.getPrimitive(),e.getReferentialPosition().elements),t},measureBetweenPrimitivesAABB:function(e,i,n,o,r,s,l,c){var u={},p=(new Date).getTime(),d=s||Number.MAX_VALUE;c&&(d=0),u.squaredDistance=d;var h,m=[],y=0,g=i.primitives.length,P=o.primitives.length,f=0;!function(){for(f=0;f<g;f++)for(var e=0;e<P;e++)h=c?t.computeAABBSquaredMaxDistance(i.AABB[f],o.AABB[e]):t.computeAABBSquaredDistance(i.AABB[f],o.AABB[e]),(!c&&h<d||c&&h>d)&&(m[y]=[f,e,h],y++)}();var v=m.length,T=0;if(e===_.MeasuredType.POINT||e===_.MeasuredType.CENTER){for(f=0;f<v&&d>1e-6;f++)if(m[f][2]<d){var C=a.computePointMeshSquaredDistance(i.primitives[m[f][0]],o.primitives[m[f][1]],r,d);C.squaredDistance<d&&(d=C.squaredDistance,u=C),T++}}else{var M=1e-6;for(c&&(M=0),f=0;f<v&&d>=M;f++){var S;if(!c&&m[f][2]<d||c&&m[f][2]>d)c?(d=0,S=a._computeTwoMeshesSquaredMaxDistance(i.primitives[m[f][0]],n,o.primitives[m[f][1]],r,d)):S=a.computeTwoMeshesSquaredDistance(i.primitives[m[f][0]],n,o.primitives[m[f][1]],r,d),(!c&&S.squaredDistance<d||c&&S.squaredMaxDistance>d)&&(S.squaredDistance?d=S.squaredDistance:S.squaredMaxDistance&&(d=S.squaredMaxDistance),u=S),T++}}return l&&!0===l&&window.console.log("Measure Parts: Primitives Couples="+g*P+" ("+g+"-"+P+")  Candidates="+m.length+"  MeasuredCandidates="+T+"  duration="+((new Date).getTime()-p)),u},MeasuredType:{POINT:0,MESH:1,PRODUCT:2,CENTER:3}};return _}),define("DS/DMUMeasurable/DMUMeshIntersection",["DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUMathsBoundingGeometry","DS/DMUMeasurable/DMUMeshServices","DS/DMUMeasurable/DMUMeshMeasure","DS/Visualization/ThreeJS_DS"],function(e,t,i,n,o){"use strict";var r=.001,a={computeSectionCurves:function(t,i,n){for(var o,r,s,l,c,u={returnCode:2,nbIntersections:0,nbTotTriangles:0},p=[n[12],n[13],n[14]],d=[n[8],n[9],n[10]],h=-e.dot(p,d),m=t.getCount(),y=t.getStart(),g=t.getGroup().geometry,P=g.vertexIndexArray,f=g.vertexPositionArray,v=[0,0,0],T=[0,0,0],C=[0,0,0],_=[],M=[0,0,0,0,0,0],S=m/3,E=0;E<S;E++){u.nbTotTriangles++,c=3*P[l=y+3*E],v[0]=f[c],v[1]=f[c+1],v[2]=f[c+2],c=3*P[l+1],T[0]=f[c],T[1]=f[c+1],T[2]=f[c+2],c=3*P[l+2],C[0]=f[c],C[1]=f[c+1],C[2]=f[c+2],o=v[0]*d[0]+v[1]*d[1]+v[2]*d[2]+h,r=T[0]*d[0]+T[1]*d[1]+T[2]*d[2]+h,s=C[0]*d[0]+C[1]*d[1]+C[2]*d[2]+h;var N=0,D=0;if(o>0?r>0?s<=0&&(N=1):s>0?N=2:(N=1,D=2):r>0?(s>0&&(N=1),D=2):s>0&&(N=1),0!==N||0!==D){u.nbIntersections++;var b,A=3-N-D;(b=0===A?a._computeIntersectionTrianglePlane(v,T,C,p,d,M):1===A?a._computeIntersectionTrianglePlane(T,C,v,p,d,M):a._computeIntersectionTrianglePlane(C,v,T,p,d,M))&&2===b.length&&_.push([b[0],b[1]])}}if(_.length>0){u.returnCode=0,a._mergePolylines(_);for(var R=0;R<_.length;R++)a._simplifyPolylinePerpendicularDistance(_[R],4e-4,M);for(var w=_.length,V=0;V<w;V++)for(var I=_[V].length,x=0;x<I;x++)_[V][x]=e.transformPoint(_[V][x],i,_[V][x]);u.aPolylines=_}return u},_computeIntersectionTrianglePlane:function(e,t,i,n,o,a){var s,l=a||[0,0,0,0,0,0];l[0]=e[0]-t[0],l[1]=e[1]-t[1],l[2]=e[2]-t[2],l[3]=e[0]-i[0],l[4]=e[1]-i[1],l[5]=e[2]-i[2];var c=l[0]*o[0]+l[1]*o[1]+l[2]*o[2],u=l[3]*o[0]+l[4]*o[1]+l[5]*o[2];if(Math.abs(c)>r&&Math.abs(u)>r){var p=(n[0]-e[0])*o[0]+(n[1]-e[1])*o[1]+(n[2]-e[2])*o[2],d=p/c,h=p/u,m=l[0]*d,y=l[1]*d,g=l[2]*d,P=l[3]*h,f=l[4]*h,v=l[5]*h;(Math.abs(m-P)>r||Math.abs(y-f)>r||Math.abs(g-v)>r)&&((s=[])[0]=[m+e[0],y+e[1],g+e[2]],s[1]=[P+e[0],f+e[1],v+e[2]])}return s},_mergePolylines:function(e){for(var t,i,n,o,r,a,s=!0;s;){s=!1;for(var l=0;l<e.length;l++){t=e[l][0],i=e[l][e[l].length-1];for(var c=l+1;c<e.length;c++)if(n=e[c][0],o=e[c][e[c].length-1],(t[0]-n[0])*(t[0]-n[0])+(t[1]-n[1])*(t[1]-n[1])+(t[2]-n[2])*(t[2]-n[2])<1e-6){for(r=1,a=e[c].length;r<a;r++)e[l].unshift(e[c][r]);t=e[l][0],e.splice(c,1),s=!0,c--}else if((t[0]-o[0])*(t[0]-o[0])+(t[1]-o[1])*(t[1]-o[1])+(t[2]-o[2])*(t[2]-o[2])<1e-6){for(r=e[c].length-2;0<=r;r--)e[l].unshift(e[c][r]);t=e[l][0],e.splice(c,1),s=!0,c--}else if((i[0]-n[0])*(i[0]-n[0])+(i[1]-n[1])*(i[1]-n[1])+(i[2]-n[2])*(i[2]-n[2])<1e-6){for(r=1,a=e[c].length;r<a;r++)e[l].push(e[c][r]);i=e[l][e[l].length-1],e.splice(c,1),s=!0,c--}else if((i[0]-o[0])*(i[0]-o[0])+(i[1]-o[1])*(i[1]-o[1])+(i[2]-o[2])*(i[2]-o[2])<1e-6){for(r=e[c].length-2;0<=r;r--)e[l].push(e[c][r]);i=e[l][e[l].length-1],e.splice(c,1),s=!0,c--}}}},_simplifyPolylinePerpendicularDistance:function(e,t,i){for(var n,o,r,a,s,l=i||[0,0,0,0,0,0],c=1;c<e.length-1;c++)if(n=e[c-1],o=e[c],r=e[c+1],l[0]=r[0]-n[0],l[1]=r[1]-n[1],l[2]=r[2]-n[2],(a=l[0]*l[0]+l[1]*l[1]+l[2]*l[2])>1e-6&&(s=((o[0]-n[0])*l[0]+(o[1]-n[1])*l[1]+(o[2]-n[2])*l[2])/a,l[3]=l[0]*s+n[0]-o[0],l[4]=l[1]*s+n[1]-o[1],l[5]=l[2]*s+n[2]-o[2],l[3]*l[3]+l[4]*l[4]+l[5]*l[5]<t)){for(var u=c+1;u<e.length;u++)e[u-1]=e[u];e.length=e.length-1,c--}},detectTwoMeshesInterference:function(e,t,o,r,a){var s=1,l=e&&e.getGroup()&&e.getGroup().geometry&&void 0!==e.getStart()&&void 0!==e.getCount()&&e.getCount()>0,c=o&&o.getGroup()&&o.getGroup().geometry&&void 0!==o.getStart()&&void 0!==o.getCount()&&o.getCount()>0;if(l&&c){s=0;var u=e.getGroup().glType,p=o.getGroup().glType;if(4===u&&4===p){var d=e.getCount(),h=i.extractMeshVertices(e,t.elements),m=d/3,y=o.getCount(),g=i.extractMeshVertices(o,r.elements),P=y/3,f=n._computeSurfaceSurfaceSquaredDistance(m,h,P,g,a);s=0===f.returnCode&&f.squaredDistance<1e-6?2:0}}return s},computeRayMeshIntersection:function(i,n,o){var a,s,l,c,u,p,d={returnCode:1,aParameters:[]};function h(t,o,h){if(t){for(a=e.dot(n,o),s=e.dot(e.sub(i,h[0]),o)/a,l&&(s=-s),c=d.aParameters.length,u=!0,p=0;u&&p<c;p++)u=Math.abs(d.aParameters[p]-s)>r;u&&d.aParameters.push(s)}}if(i&&n&&o&&o.getGroup()&&o.getGroup().glType&&4===o.getGroup().glType){d.returnCode=0;var m=o.getCount(),y=o.getStart(),g=o.getGroup().geometry,P=g.vertexIndexArray,f=g.vertexPositionArray,v=t.computeAABBForUnsortedPoints(m,y,P,f);if(t.intersectAABBWithRay(v,i,n)){var T,C,_,M,S,E,N,D,b,A,R,w,V,I,x=m/3,G=[],L=[0,0,0],B=[!0,!0,!0],U=[!0,!0,!0];for(T=0;T<x;T++)if(M=3*P[_=y+3*T],G[0]=[f[M],f[M+1],f[M+2]],M=3*P[_+1],G[1]=[f[M],f[M+1],f[M+2]],M=3*P[_+2],G[2]=[f[M],f[M+1],f[M+2]],G[3]=G[0],S=G[1][0]-G[0][0],E=G[1][1]-G[0][1],N=G[1][2]-G[0][2],D=G[2][0]-G[0][0],b=G[2][1]-G[0][1],A=G[2][2]-G[0][2],A=G[2][2]-G[0][2],L[0]=E*A-N*b,L[1]=N*D-S*A,L[2]=S*b-E*D,R=L[0]*n[0]+L[1]*n[1]+L[2]*n[2],Math.abs(R)>r&&(w=L[0]*(i[0]-G[0][0])+L[1]*(i[1]-G[0][1])+L[2]*(i[2]-G[0][2]),R>0&&w<0||R<0&&w>0)){for(C=0;C<3;C++)S=G[C][0]-i[0],E=G[C][1]-i[1],N=G[C][2]-i[2],D=G[C+1][0]-i[0],b=G[C+1][1]-i[1],V=(E*(A=G[C+1][2]-i[2])-N*b)*n[0]+(N*D-S*A)*n[1]+(S*b-E*D)*n[2],B[C]=Math.abs(V)<r,U[C]=V>0;I=!1,B[0]?(I=!0,l=B[1]?U[2]:B[2]?U[1]:U[1]&&U[2]):B[1]?(I=!0,l=B[2]?U[0]:U[2]&&U[0]):B[2]?(I=!0,l=U[0]&&U[1]):U[0]&&U[1]&&U[2]?(I=!0,l=!0):U[0]||U[1]||U[2]||(I=!0,l=!1),h(I,L,G)}}}return d},computeRayIntersection:function(e,t,i,n,r){for(var a=new o.Ray(e,t),s=a.intersectMeshInstances({object:i},n,a.origin,1),l=s[0].object.id,c=[],u=0;u<s.length;u++)l===s[u].object.id&&c.push(s[u]);return r?c:c[0]}};return a}),define("DS/DMUMeasurable/DMUToolsInterference",["DS/DMUMeasurable/DMUMathsBoundingGeometry","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUMeasurable/DMUMeshIntersection","DS/DMUMeasurable/DMUToolsMeasure","DS/DMUMeasurable/DMUMathsVector3D","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],function(e,t,i,n,o,r,a){"use strict";var s={detectInterference:function(i,o,r,a){var l,c={returnCode:0,interfering1:[],interfering2:[]};a&&!0===a&&(window.console.log("Clash Products: "+i.length+" / "+o.length),l=(new Date).getTime());for(var u=[],p=[],d=0;d<i.length;d++)for(var h=0;h<o.length;h++)u.push(i[d]),p.push(o[h]);for(var m,y,g,P,f=[],v=[],T=[],C=[],_=0;_<u.length;_++){var M=u[_].getLastElement(),S=p[_].getLastElement();if(m=n.retrieveProductAABB(M,u[_].getWorldMatrix()),y=n.retrieveProductAABB(S,p[_].getWorldMatrix()),e.computeAABBSquaredDistance(m,y)<2e-6)if(g=t.isLeaf(M),P=t.isLeaf(S),g&&P)f.push(M),v.push(S),T.push(u[_]),C.push(p[_]);else if(g||!P&&M.bSphere.radius<S.bSphere.radius){for(var E=S.children.length,N=0;N<E;N++)if(t.isReferenceOrInstance(S.children[N])){u.push(u[_]);var D=p[_].clone();D.addElement(S.children[N]),p.push(D)}}else for(var b=M.children,A=b.length,R=0;R<A;R++){var w=b[R];if(t.isReferenceOrInstance(w)){var V=u[_].clone();V.addElement(w),u.push(V),p.push(p[_])}}}for(var I=f.length,x=(new Date).getTime()-l,G=0;0===c.returnCode&&G<I;G++){var L=n.retrievePartPrimitivesAndAABB(T[G]),B=T[G].getWorldMatrix(),U=n.retrievePartPrimitivesAndAABB(C[G]),O=C[G].getWorldMatrix();if(2===s._detectInterferenceBetweenPrimitivesAABB(L,B,U,O,2e-6,a))c.returnCode=2,r&&(c.interfering1.push(T[G]),c.interfering2.push(C[G]));else if(L.vertice&&U.vertice){var z=s.computeRayProductInterferences(L.vertice.toArray(),[0,0,1],[C[G]]);0===z.returnCode&&z.iSide<0?(c.returnCode=2,r&&(c.interfering1.push(T[G]),c.interfering2.push(C[G]))):0===(z=s.computeRayProductInterferences(U.vertice.toArray(),[0,0,1],[T[G]])).returnCode&&z.iSide<0&&(c.returnCode=2,r&&(c.interfering1.push(T[G]),c.interfering2.push(C[G])))}}return a&&!0===a&&window.console.log("Clash Products: Parts Couples="+I+" Scan duration="+x+" Duration="+((new Date).getTime()-l)),c},_detectInterferenceBetweenPrimitivesAABB:function(t,n,o,r,a,s){var l=0,c=(new Date).getTime(),u=[],p=0,d=t.primitives.length,h=o.primitives.length,m=0;for(m=0;m<d;m++)for(var y=0;y<h;y++)e.computeAABBSquaredDistance(t.AABB[m],o.AABB[y])<1e-6&&(u[p]=[m,y],p++);var g=u.length,P=0;for(m=0;0===l&&m<g;m++)l=i.detectTwoMeshesInterference(t.primitives[u[m][0]],n,o.primitives[u[m][1]],r,a),P++;return s&&!0===s&&window.console.log("Clash Parts: Primitives Couples="+d*h+" ("+d+"-"+h+")  Candidates="+u.length+"  TestedCandidates="+P+"  duration="+((new Date).getTime()-c)),l},computeRayProductInterferences:function(n,s,l){for(var c={returnCode:0,iSide:0,aIntersections:[]},u=0;u<l.length;u++){var p=t.getRenderables(l[u]),d=[n[0],n[1],n[2]],h=[s[0],s[1],s[2]],m=l[u].getWorldMatrix();if(m&&!o.isIdentity(m.elements)){var y=(new r.Matrix4).getInverse(m).elements;d=o.transformPoint(n,y,d),h=o.transformVector(s,y,h)}for(var g=[],P=p.length,f=0;f<P;f++){var v=p[f].boundingBox.clone().applyMatrix4(m),T=[v.min.x,v.min.y,v.min.z,v.max.x,v.max.y,v.max.z];if(e.intersectAABBWithRay(T,n,s))for(var C=p[f].geometry,_=C.length,M=0;M<_;M++){C[M].startIteration();for(var S=C[M].drawingGroups,E=S.length,N=0;N<E;N++)if(S[N]._geomType&&"FACE"===a.GeomTypeString[S[N]._geomType])for(var D=S[N].getPrimitivesCount(),b=0;b<D;b++){var A=new a.SGPrimitiveHelper;A.set(S[N],b);var R=i.computeRayMeshIntersection(d,h,A);if(0===R.returnCode)for(var w=0;w<R.aParameters.length;w++){for(var V=g.length,I=!0,x=0;I&&x<V;x++)I=Math.abs(g[x]-R.aParameters[w])>.001;if(I){g.push(R.aParameters[w]),c.iSide+=R.aParameters[w]>0?1:-1;var G=o.multiplyAndAdd(s,Math.abs(R.aParameters[w]),n),L=new r.Vector3(G[0],G[1],G[2]);c.aIntersections.push({primitive:A,point:L,normal:null,distance:o.subAndLength(G,n),geometry:C[M],object:p[f]})}}}C[M].endIteration()}}}return c.aIntersections.sort(function(e,t){return e.distance-t.distance}),c}};return s}),define("DS/DMUMeasurable/DMUMeasurable",["UWA/Core","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUMeshServices","DS/DMUMeasurable/DMUMeshRecognition","DS/DMUMeasurable/DMUToolsMeasure","DS/DMUMeasurable/DMUMeasureEnums","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement"],function(e,t,i,n,o,r,a,s){"use strict";var l=e.Class.extend({init:function(e,o){var s=this;if(!o){s._bRealPathElement=!1;var l=function(e){var t;if(e.pathElement?(s._pathElement=e.pathElement.clone(),s._bRealPathElement=!0):s._matrix=e.position?e.position.clone():new a.Matrix4,e.selpoint){var i=(new a.Matrix4).getInverse(s._getMatrix());s._selPosition=e.selpoint.clone().applyMatrix4(i)}if(e.selnormal){var o=(new a.Matrix4).getInverse(s._getMatrix());s._selNormal=e.selnormal.clone().transformDirection(o)}return e.canonic?((t=e.canonic).exact=!e.isApprox,t.returnCode=0,s._length=e.canonic.length,s._cog=e.canonic.cog,s._area=e.canonic.area,s._SGPrimitive=e.canonic.primitive):e.primitive&&(s._SGPrimitive=e.primitive,t=e.bAvoidRecognition?{returnCode:1}:n.recognizeCanonicGeometry(s._SGPrimitive,new a.Matrix4,!0)),t}(e);if(0===l.returnCode){switch(s._type=l.type,l.type){case t.GeometryType.POINT:case t.GeometryType.PICKINGPT:s._selectedType=r.ViewedType.POINT,s._position=l.position,s._selPosition||(s._selPosition=l.position.clone());break;case t.GeometryType.LINE:s._selectedType=r.ViewedType.AXIS,s._point1=l.point1,s._point2=l.point2,s._selPosition||(s._selPosition=s._point1.clone());break;case t.GeometryType.CIRCLE:s._selectedType=r.ViewedType.CIRCLE,s._center=l.center,s._radius=l.radius,s._normal=l.normal;var c=i.extractMeshVertices(s._SGPrimitive),u=c.length-1;s._point1=new a.Vector3(c[0][0],c[0][1],c[0][2]),s._point2=new a.Vector3(c[u][0],c[u][1],c[u][2]);var p,d,h=0;c.length%2?(h=(c.length-1)/2-1,p=new a.Vector3(c[h][0],c[h][1],c[h][2]),d=new a.Vector3(c[h+2][0],c[h+2][1],c[h+2][2])):(h=c.length/2-1,p=new a.Vector3(c[h][0],c[h][1],c[h][2]),d=new a.Vector3(c[h+1][0],c[h+1][1],c[h+1][2]));var m=p.clone().add(d.clone()).multiplyScalar(.5).clone().sub(l.center.clone()).normalize().multiplyScalar(l.radius).clone().add(l.center.clone());s._arcMidPoint=new a.Vector3(m.x,m.y,m.z);var y=s._point1.clone().sub(s._center),g=s._point2.clone().sub(s._center),P=s._arcMidPoint.clone().sub(s._center);s._arcAngle=y.angleTo(P)+g.angleTo(P),l.arcLength||(l.arcLength=s._arcAngle*s._radius),l.length||(l.length=2*Math.PI*s._radius),s._arcLength=l.arcLength,s._length=l.length;break;case t.GeometryType.PLANE:s._selectedType=r.ViewedType.INFPLANE,s._origin=l.origin,s._normal=l.normal,s._selPosition||(s._selPosition=s._origin.clone());break;case t.GeometryType.CYLINDER:s._selectedType=r.ViewedType.CYCOSP,s._radius=l.radius,s._point1=l.point1,s._point2=l.point2;break;case t.GeometryType.CONE:s._selectedType=r.ViewedType.CYCOSP,s._apex=l.apex,s._semiAngle=l.semiAngle,s._axis=l.axis,s._point1=l.point1,s._point2=l.point2,l.topRadius&&l.topRadius>.001&&(s._minRadius=l.topRadius),l.baseRadius&&(s._maxRadius=l.baseRadius);break;case t.GeometryType.SPHERE:s._selectedType=r.ViewedType.CYCOSP,s._radius=l.radius,s._center=l.center;break;case t.GeometryType.PRODUCT:s._selectedType=r.ViewedType.PRODUCT,s._position=l.position,!s._selPosition&&l.position&&(s._selPosition=l.position.clone())}s._mode=l.exact?t.Mode.EXACT:t.Mode.FACETTED}else{switch(s._SGPrimitive.getGroup().glType){case 1:s._type=t.GeometryType.CURVE,s._selectedType=r.ViewedType.CURVE;var f=i.extractMeshVertices(s._SGPrimitive),v=f.length-1;s._point1=new a.Vector3(f[0][0],f[0][1],f[0][2]),s._point2=new a.Vector3(f[v][0],f[v][1],f[v][2]),s._selPosition||(s._selPosition=s._point1.clone());break;case 4:s._type=t.GeometryType.SURFACE,s._selectedType=r.ViewedType.SURFACE;var T=i.extractMeshVertices(s._SGPrimitive);s._selPosition||(s._selPosition=new a.Vector3(T[0][0],T[0][1],T[0][2]))}s._mode=t.Mode.FACETTED}s._isPartial=!1,s._partialPaths=[]}return this},clone:function(){var e=new l({},!0);if(e._type=this._type,e._mode=this._mode,this._SGPrimitive&&(e._SGPrimitive=this._SGPrimitive),this._pathElement&&(e._pathElement=this._pathElement.clone()),this._bRealPathElement&&(e._bRealPathElement=this._bRealPathElement),this._selPosition&&(e._selPosition=this._selPosition),this._selNormal&&(e._selNormal=this._selNormal),this._position&&(e._position=this._position),this._point1&&(e._point1=this._point1.clone()),this._point2&&(e._point2=this._point2.clone()),this._origin&&(e._origin=this._origin.clone()),this._normal&&(e._normal=this._normal.clone()),this._center&&(e._center=this._center.clone()),this._apex&&(e._apex=this._apex.clone()),this._axis&&(e._axis=this._axis.clone()),this._radius&&(e._radius=this._radius),this._semiAngle&&(e._semiAngle=this._semiAngle),this._length&&(e._length=this._length),this._area&&(e._area=this._area),this._cog&&(e._cog=this._cog),this._selectedType&&(e._selectedType=this._selectedType),this._isPartial&&(e._isPartial=this._isPartial),this._partialPaths&&(e._partialPaths=[],this._partialPaths.length>0))for(var t=0;t<this._partialPaths.length;t++)e._partialPaths.push(this._partialPaths[t].clone());return this._arcMidPoint&&(e._arcMidPoint=this._arcMidPoint.clone()),this._arcAngle&&(e._arcAngle=this._arcAngle),this._selectedTypeWithFilter&&(e._selectedTypeWithFilter=this._selectedTypeWithFilter),e},getType:function(){return this._type},setType:function(e){this._type=e},getTypeWithSelFilter:function(){return this._selectedTypeWithFilter},setTypeWithSelFilter:function(e){this._selectedTypeWithFilter=e},getMode:function(){return this._mode},getPrimitive:function(){return this._SGPrimitive},getPathElement:function(){return this._bRealPathElement?this._pathElement.clone():new s},setLevel:function(e){this._level=e},getLevel:function(){return this._level},setPartial:function(e){this._isPartial=e},isPartial:function(){return this._isPartial},setPartialPathElements:function(e){this._partialPaths=[],this._partialPaths=e},setReferentialPosition:function(e){!this._bRealPathElement&&e&&e instanceof a.Matrix4&&(this._matrix=e.clone())},getReferentialPosition:function(){return this._getMatrix().clone()},getPoint:function(){var e=null;return this._type===t.GeometryType.POINT&&this._position&&(e=this._position.clone().applyMatrix4(this._getMatrix())),e},getPoints:function(){var e=null;return this._type!==t.GeometryType.LINE&&this._type!==t.GeometryType.CURVE&&this._type!==t.GeometryType.CYLINDER&&this._type!==t.GeometryType.CONE&&this._type!==t.GeometryType.CIRCLE&&this._type!==t.GeometryType.PRODUCT||(e={},this._point1&&this._point2&&(e.beginPoint=this._point1.clone().applyMatrix4(this._getMatrix()),e.endPoint=this._point2.clone().applyMatrix4(this._getMatrix()))),e},getPlane:function(){var e=null;return this._type===t.GeometryType.PLANE&&((e={}).origin=this._origin.clone().applyMatrix4(this._getMatrix()),e.normal=this._normal.clone().transformDirection(this._getMatrix())),e},get2DScale:function(){return this._getMatrix().getScaleOnAxisX()},getRadius:function(){var e=null;return this._type!==t.GeometryType.CIRCLE&&this._type!==t.GeometryType.CYLINDER&&this._type!==t.GeometryType.SPHERE||(e=this._radius),e},getMaxRadius:function(){var e=null;return this._type===t.GeometryType.CONE&&(e=this._maxRadius),e},getMinRadius:function(){var e=null;return this._type===t.GeometryType.CONE&&(e=this._minRadius),e},getCenter:function(){var e=null;return this._type!==t.GeometryType.CIRCLE&&this._type!==t.GeometryType.SPHERE||(e=this._center.clone().applyMatrix4(this._getMatrix())),e},getAxis:function(){var e=null;return this._type===t.GeometryType.CIRCLE?e=this._normal.clone().transformDirection(this._getMatrix()):this._type!==t.GeometryType.LINE&&this._type!==t.GeometryType.CYLINDER&&this._type!==t.GeometryType.CONE||(e=this._point2.clone().sub(this._point1).normalize().transformDirection(this._getMatrix())),e},getAngle:function(){var e=null;return this._type===t.GeometryType.CIRCLE&&(e=2*Math.PI),e},getArcMidPoint:function(){var e=null;return this._type===t.GeometryType.CIRCLE&&(e=this._arcMidPoint.clone().applyMatrix4(this._getMatrix())),e},getArcAngle:function(){var e=null;return this._type===t.GeometryType.CIRCLE&&(e=this._arcAngle),e},getSemiAngle:function(){var e=null;return this._type===t.GeometryType.CONE&&(e=this._semiAngle),e},getApex:function(){var e=null;return this._type===t.GeometryType.CONE&&(e=this._apex.clone().applyMatrix4(this._getMatrix())),e},getLength:function(){var e=null;return this._type===t.GeometryType.LINE||this._type===t.GeometryType.CIRCLE||this._type===t.GeometryType.CURVE?(this._length||this._complete(),e=this._length):this._type===t.GeometryType.PRODUCT&&this._length&&(e=this._length),e},getArcLength:function(){var e=null;return this._type===t.GeometryType.CIRCLE&&(this._arcLength||this._complete(),e=this._arcLength),e},getCoG:function(){var e=null;return this._type!==t.GeometryType.SURFACE&&this._type!==t.GeometryType.CYLINDER&&this._type!==t.GeometryType.SPHERE&&this._type!==t.GeometryType.CONE&&this._type!==t.GeometryType.PLANE&&this._type!==t.GeometryType.PRODUCT||(this._cog||this._complete(),this._cog&&(e=this._cog.clone().applyMatrix4(this._getMatrix()))),e},getArea:function(){var e=null;return this._type!==t.GeometryType.SURFACE&&this._type!==t.GeometryType.CYLINDER&&this._type!==t.GeometryType.SPHERE&&this._type!==t.GeometryType.CONE&&this._type!==t.GeometryType.PLANE&&this._type!==t.GeometryType.PRODUCT||(this._area||this._complete(),this._area&&(e=this._area)),e},getVolume:function(){var e=null;return this.volume||this._complete(),this.volume&&(e=this.volume),e},getSelPoint:function(){var e;return this._type===t.GeometryType.POINT&&void 0!==this._position?e=this._position.clone().applyMatrix4(this._getMatrix()):void 0!==this._selPosition?e=this._selPosition.clone().applyMatrix4(this._getMatrix()):void 0!==this._point1&&(e=this._point1.clone().applyMatrix4(this._getMatrix())),e},getSelNormal:function(){return this._selNormal?this._selNormal.clone().transformDirection(this._getMatrix()):void 0},getOriginPoint:function(){var e=null;return this._originPoint&&this._type===t.GeometryType.PRODUCT&&(e=this._originPoint.clone().applyMatrix4(this._getMatrix())),e},getHeight:function(){var e=null;if((this._type===t.GeometryType.CYLINDER||this._type===t.GeometryType.CONE)&&this._point1&&this._point2){var i=this._point1.clone().applyMatrix4(this._getMatrix()),n=this._point2.clone().applyMatrix4(this._getMatrix());e=i.distanceTo(n)}return e},computeMinimumDistance:function(e){var t={returnCode:1};if(e){var i=o.measureBetween(this,this._selectedType,e,e._selectedType);i.position1&&(t.distance=i.distance,t.relationship=i.relationship,t.position1=i.position1,t.position2=i.position2,t.returnCode=0)}return t},computeAngle:function(e){var t={returnCode:1};if(e){var i=o.measureBetween(this,this._selectedType,e,e._selectedType);i.position1&&(t.angle=i.angle,t.returnCode=0)}return t},exportData:function(e){var i={canonic:{}};switch(i.canonic.type=e(this._type,"int"),i.canonic.mode=e(this._mode,"int"),i.canonic.selectedType=e(this._selectedType,"int"),i.canonic.matrix=e(this._getMatrix(),"Matrix4"),this._type){case t.GeometryType.POINT:case t.GeometryType.PICKINGPT:i.canonic.position=e(this._position,"Vector3");break;case t.GeometryType.LINE:i.canonic.point1=e(this._point1,"Vector3"),i.canonic.point2=e(this._point2,"Vector3"),this._length||this._complete(),i.canonic.length=e(this._length,"float");break;case t.GeometryType.CIRCLE:i.canonic.center=e(this._center,"Vector3"),i.canonic.radius=e(this._radius,"float"),i.canonic.normal=e(this._normal,"Vector3"),this._length&&this._arcLength||this._complete(),i.canonic.length=e(this._length,"float"),i.canonic.arcLength=e(this._arcLength,"float"),i.canonic.arcMidPoint=e(this._arcMidPoint,"Vector3"),i.canonic.point1=e(this._point1,"Vector3"),i.canonic.point2=e(this._point2,"Vector3"),i.canonic.arcAngle=e(this._arcAngle,"float");break;case t.GeometryType.PLANE:i.canonic.origin=e(this._origin,"Vector3"),i.canonic.normal=e(this._normal,"Vector3"),this._cog&&this._area||this._complete(),i.canonic.cog=e(this._cog,"Vector3"),i.canonic.area=e(this._area,"float");break;case t.GeometryType.CYLINDER:i.canonic.radius=e(this._radius,"float"),i.canonic.point1=e(this._point1,"Vector3"),i.canonic.point2=e(this._point2,"Vector3"),this._cog&&this._area||this._complete(),i.canonic.cog=e(this._cog,"Vector3"),i.canonic.area=e(this._area,"float");break;case t.GeometryType.CONE:i.canonic.apex=e(this._apex,"Vector3"),i.canonic.semiAngle=e(this._semiAngle,"float"),i.canonic.axis=e(this._axis,"Vector3"),i.canonic.point1=e(this._point1,"Vector3"),i.canonic.point2=e(this._point2,"Vector3"),this._cog&&this._area||this._complete(),i.canonic.cog=e(this._cog,"Vector3"),i.canonic.area=e(this._area,"float");break;case t.GeometryType.SPHERE:i.canonic.radius=e(this._radius,"float"),i.canonic.center=e(this._center,"Vector3"),this._cog&&this._area||this._complete(),i.canonic.cog=e(this._cog,"Vector3"),i.canonic.area=e(this._area,"float");break;case t.GeometryType.SURFACE:this._cog&&this._area||this._complete(),i.canonic.cog=e(this._cog,"Vector3"),i.canonic.area=e(this._area,"float");break;case t.GeometryType.CURVE:this._length||this._complete(),i.canonic.length=e(this._length,"float"),i.canonic.point1=e(this._point1,"Vector3"),i.canonic.point2=e(this._point2,"Vector3")}return i.selpoint=e(this._selPosition,"Vector3"),this._selNormal&&(i.selnormal=e(this._selNormal,"Vector3")),i},importData:function(e,t){return this._type=t(e.canonic.type,"int"),this._mode=t(e.canonic.mode,"int"),this._bRealPathElement=!1,this._pathElement={},this._matrix=e.canonic.matrix?t(e.canonic.matrix,"Matrix4"):new a.Matrix4,e.selpoint&&(this._selPosition=t(e.selpoint,"Vector3")),e.selnormal&&(this._selNormal=t(e.selnormal,"Vector3")),e.canonic.position&&(this._position=t(e.canonic.position,"Vector3")),e.canonic.point1&&(this._point1=t(e.canonic.point1,"Vector3")),e.canonic.point2&&(this._point2=t(e.canonic.point2,"Vector3")),e.canonic.origin&&(this._origin=t(e.canonic.origin,"Vector3")),e.canonic.normal&&(this._normal=t(e.canonic.normal,"Vector3")),e.canonic.center&&(this._center=t(e.canonic.center,"Vector3")),e.canonic.apex&&(this._apex=t(e.canonic.apex,"Vector3")),e.canonic.axis&&(this._axis=t(e.canonic.axis,"Vector3")),e.canonic.radius&&(this._radius=t(e.canonic.radius,"float")),e.canonic.semiAngle&&(this._semiAngle=t(e.canonic.semiAngle,"float")),e.canonic.length&&(this._length=t(e.canonic.length,"float")),e.canonic.area&&(this._area=t(e.canonic.area,"float")),e.canonic.cog&&(this._cog=t(e.canonic.cog,"Vector3")),e.canonic.selectedType&&(this._selectedType=t(e.canonic.selectedType,"int")),e.canonic.arcMidPoint&&(this._arcMidPoint=t(e.canonic.arcMidPoint,"Vector3")),e.canonic.arcLength&&(this._arcLength=t(e.canonic.arcLength,"float")),e.canonic.arcAngle&&(this._arcAngle=t(e.canonic.arcAngle,"float")),this},print:function(e){var i=void 0!==e?e:"Measurable";switch(window.console.log(i),this._type){case t.GeometryType.POINT:window.console.log("    type=POINT point=("+this._position.x+", "+this._position.y+", "+this._position.z+")");break;case t.GeometryType.CURVE:window.console.log("    type=CURVE point1=("+this._point1.x+", "+this._point1.y+", "+this._point1.z+") point2=("+this._point2.x+", "+this._point2.y+", "+this._point2.z+")");break;case t.GeometryType.LINE:window.console.log("    type=LINE point1=("+this._point1.x+", "+this._point1.y+", "+this._point1.z+") point2=("+this._point2.x+", "+this._point2.y+", "+this._point2.z+")");break;case t.GeometryType.CIRCLE:window.console.log("    type=CIRCLE radius="+this._radius+" center=("+this._center.x+", "+this._center.y+", "+this._center.z+") normal=("+this._normal.x+", "+this._normal.y+", "+this._normal.z+")");break;case t.GeometryType.SURFACE:window.console.log("    type=SURFACE area="+this._area+" cog=("+this._cog.x+", "+this._cog.y+", "+this._cog.z+")");break;case t.GeometryType.PLANE:window.console.log("    type=PLANE origin=("+this._origin.x+", "+this._origin.y+", "+this._origin.z+") normal=("+this._normal.x+", "+this._normal.y+", "+this._normal.z+")");break;case t.GeometryType.CYLINDER:window.console.log("    type=CYLINDER point1=("+this._point1.x+", "+this._point1.y+", "+this._point1.z+") point2=("+this._point2.x+", "+this._point2.y+", "+this._point2.z+")");break;case t.GeometryType.CONE:window.console.log("    type=CONE point1=("+this._point1.x+", "+this._point1.y+", "+this._point1.z+") point2=("+this._point2.x+", "+this._point2.y+", "+this._point2.z+")");break;case t.GeometryType.SPHERE:window.console.log("    type=SPHERE center=("+this._center.x+", "+this._center.y+", "+this._center.z+")")}var n=this._getMatrix().elements;window.console.log("    transformation=("+n[0]+", "+n[4]+", "+n[8]+"), ("+n[1]+", "+n[5]+", "+n[9]+"), ("+n[2]+", "+n[6]+", "+n[10]+"), ("+n[3]+", "+n[7]+", "+n[11]+")")},_complete:function(){if(this._type===t.GeometryType.PRODUCT)this.updateProductMeasurable();else{var e=n.recognizeNonCanonicGeometry(this._SGPrimitive,new a.Matrix4,!0);this._type===t.GeometryType.CIRCLE?(this._arcLength=e.arcLength,this._length=e.length):this._type===t.GeometryType.LINE?this._length=e.length:this._type===t.GeometryType.PLANE||this._type===t.GeometryType.CYLINDER||this._type===t.GeometryType.CONE||this._type===t.GeometryType.SPHERE?(this._area=e.area,this._cog=e.cog):this._type===t.GeometryType.CURVE?this._length=e.length:(this._area=e.area,this._cog=e.cog)}},_getMatrix:function(){var e=this._bRealPathElement?this._pathElement.getWorldMatrix():this._matrix;return e||(e=new a.Matrix4),e},getMatrix:function(){return this._getMatrix()},updateProductMeasurable:function(){var e=o.measureProduct(this);this.volume=void 0,this._area=void 0,this._cog=void 0,this._length=void 0,this._point1=void 0,this._point2=void 0,this._originPoint=void 0,void 0!==e.volume&&(this.volume=e.volume),void 0!==e.area&&(this._area=e.area),void 0!==e.length&&(this._length=e.length);var t=(new a.Matrix4).getInverse(this._getMatrix());void 0!==e.startpoint&&void 0!==e.endpoint&&(this._point1=e.startpoint.clone().applyMatrix4(t),this._point2=e.endpoint.clone().applyMatrix4(t)),void 0!==e.cog&&(this._cog=e.cog.clone().applyMatrix4(t),this._selPosition||(this._selPosition=this._cog.clone())),void 0!==e.originPoint&&(this._originPoint=e.originPoint)}});return l}),define("DS/DMUMeasurable/DMUSectionPosService",["DS/Visualization/ThreeJS_DS","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUMeasurable/DMUToolsMaths","DS/DMUMeasurable/DMUMeasurable"],function(e,t,i,n,o,r,a){"use strict";var s,l,c,u=function(t,i){var n;t.negate(),t.normalize();var r=o.getXYAxisDirFromZ(t.clone());return r.xDir&&r.yDir&&t&&i&&(n=(new e.Matrix4).makeBasis(r.xDir,r.yDir,t)).setPosition(i),n},p=function(t,i){if(t&&i.getSelPoint()){var n=new e.Vector3,o=new e.Vector3,r=new e.Vector3;t.extractBasis(n,o,r);var a=(new e.Vector3).getPositionFromMatrix(t),s=(new e.Plane).setFromNormalAndCoplanarPoint(r.clone(),a.clone());a=s.projectPoint(i.getSelPoint())}},d=function(e,t){var i=t.dot(e);return t.multiplyScalar(i>0?1:-1).negate()},h=function(i){if(i){var n=i.pathElement;if(n){var r;c=i.position?i.position:n.position;var s=i.isOOCTileSetNodeInPath?i.isOOCTileSetNodeInPath:o.isOOCTileSetNodeInPath(n);if(n.getLastElement().sgNode||s){if(s){var l=(new e.Matrix4).getInverse(n.getWorldMatrix()),u=c.clone().applyMatrix4(l);r=new a({canonic:{type:t.GeometryType.POINT,position:u},pathElement:n,selpoint:c})}else r=new a({primitive:n.getLastElement().sgNode,pathElement:n,selpoint:c,selnormal:i.normal?i.normal:n.normal});return r}}}},m=function(t,o,a,p,h,m){if(!(r.areEqual(t,o,"Vector3")||r.areEqual(o,a,"Vector3")||r.areEqual(a,t,"Vector3"))){(s=new e.Vector3).subVectors(o.clone(),a.clone()).normalize();var y=i.computePointLineDistance(t.clone().toArray(),o.clone().toArray(),s.clone().toArray());if(y&&0===y.returnCode&&y.distance>.001){if(l=(new e.Plane).setFromCoplanarPoints(t,o,a),h){var g=l.projectPoint(h);m(g)&&(c=g)}if(c||(c=n.add(t,o,a)),l&&l.normal)return{planeDef:u(d(p.sight,l.normal.clone()),c)}}}},y=function(n,o,r,a,s,p,h){if(n&&o&&r&&a){var y=i.computeTwoLinesDistance(n.beginPoint.clone().toArray(),o.clone().toArray(),r.clone().toArray(),a.clone().toArray());if(y&&0===y.returnCode)if(y.angle<.001){if(y.relationship!==t.Relationship.COINCIDENT)return m(r.clone(),n.beginPoint.clone(),n.endPoint.clone(),s,p,h)}else if(y.relationship===t.Relationship.INTERSECTING)return function(t,i,n,o,r){if(t&&i){if(l=(new e.Plane).setFromNormalAndCoplanarPoint(t,i),o){var a=l.projectPoint(o);r(a)&&(c=a)}if(c||(c=i),l&&l.normal)return{planeDef:u(d(n.sight,l.normal.clone()),c)}}}(o.clone().cross(a.clone()).normalize().clone(),r.clone(),s,p,h)}},g=function(i,n,o,r){var a;if(i.getType()===t.GeometryType.PLANE){if(l=i.getPlane(),s=l.normal.clone().normalize(),(a=i.getSelPoint())||(a=l.origin.clone()),l=(new e.Plane).setFromNormalAndCoplanarPoint(s,a),o){var p=l.projectPoint(o);r(p)&&(c=p)}return c||(c=a),{planeDef:u(d(n.sight,s),l.projectPoint(c)),treatOnlyPlane:!0}}},P={getSelMapName:function(e){if(null==e)return"";switch(e){case t.GeometryType.POINT:case t.GeometryType.SPHERE:return"Point";case t.GeometryType.LINE:return"Line";case t.GeometryType.PLANE:return"Normal";case t.GeometryType.CYLINDER:case t.GeometryType.CONE:case t.GeometryType.CIRCLE:return"Axis";default:return""}},getMeasurable:function(e){return h(e)},computePlaneDim:function(n,o,a){var s=[],l=o,c=n,u=Math.max(c.max.x-c.min.x,c.max.y-c.min.y,c.max.z-c.min.z),p=u,d=new e.Vector3(c.min.x,c.min.y,c.min.z),h=new e.Vector3(c.max.x,c.min.y,c.min.z),m=new e.Vector3(c.min.x,c.max.y,c.min.z),y=new e.Vector3(c.max.x,c.max.y,c.min.z),g=new e.Vector3(c.min.x,c.min.y,c.max.z),P=new e.Vector3(c.max.x,c.min.y,c.max.z),f=new e.Vector3(c.min.x,c.max.y,c.max.z),v=new e.Vector3(c.max.x,c.max.y,c.max.z),T=new e.Vector3,C=new e.Vector3,_=new e.Vector3;l.extractBasis(T,C,_);var M,S,E=(new e.Vector3).getPositionFromMatrix(l),N=[];M=(new e.Vector3).subVectors(h.clone(),d.clone()),S=(new e.Vector3).subVectors(g.clone(),d.clone()),N.push({normal:(new e.Vector3).crossVectors(S,M).normalize(),origin:d.clone()}),M=(new e.Vector3).subVectors(m.clone(),d.clone()),S=(new e.Vector3).subVectors(h.clone(),d.clone()),N.push({normal:(new e.Vector3).crossVectors(S,M).normalize(),origin:d.clone()}),M=(new e.Vector3).subVectors(m.clone(),d.clone()),S=(new e.Vector3).subVectors(g.clone(),d.clone()),N.push({normal:(new e.Vector3).crossVectors(S,M).normalize(),origin:d.clone()}),M=(new e.Vector3).subVectors(f.clone(),v.clone()),S=(new e.Vector3).subVectors(y.clone(),v.clone()),N.push({normal:(new e.Vector3).crossVectors(S,M).normalize(),origin:v.clone()}),M=(new e.Vector3).subVectors(P.clone(),v.clone()),S=(new e.Vector3).subVectors(y.clone(),v.clone()),N.push({normal:(new e.Vector3).crossVectors(S,M).normalize(),origin:v.clone()}),M=(new e.Vector3).subVectors(P.clone(),v.clone()),S=(new e.Vector3).subVectors(f.clone(),v.clone()),N.push({normal:(new e.Vector3).crossVectors(S,M).normalize(),origin:v.clone()});var D,b,A,R,w,V=E.clone(),I=T.normalize(),x=C.normalize(),G=[],L=[],B=[],U=[];N.forEach(function(n){(A=i.computeLinePlaneDistance(V.toArray(),I.toArray(),n.origin.toArray(),n.normal.toArray()))&&A.aPosition&&A.aPosition.length>2&&(w=new e.Vector3(A.aPosition[0],A.aPosition[1],A.aPosition[2]),A.relationship===t.Relationship.INTERSECTING&&(c.containsPoint(w)||c.distanceToPoint(w)<.001)&&(R=V.distanceTo(w),B.push(w),L.push(R),(void 0===b||b<R)&&(b=R))),(A=i.computeLinePlaneDistance(V.toArray(),x.toArray(),n.origin.toArray(),n.normal.toArray()))&&A.aPosition&&A.aPosition.length>2&&(w=new e.Vector3(A.aPosition[0],A.aPosition[1],A.aPosition[2]),A.relationship===t.Relationship.INTERSECTING&&(c.containsPoint(w)||c.distanceToPoint(w)<.001)&&(R=V.distanceTo(w),U.push(w),G.push(R),(void 0===D||D<R)&&(D=R)))});var O,z,q,k,F=E.clone();a&&(L&&2===L.length&&L[0]!==L[1]&&(b=(L[0]+L[1])/2,q=(O=B[0].clone().add(B[1].clone()).multiplyScalar(.5)).clone().sub(E),F=O),G&&2===G.length&&G[0]!==G[1]&&(D=(G[0]+G[1])/2,k=(z=U[0].clone().add(U[1].clone()).multiplyScalar(.5)).clone().sub(E),F=z),k&&q&&(F=k.add(q).add(E.clone())));return D&&(p=2*D),b&&(u=2*b),s.fPlaneSizeV=p,s.fPlaneSizeU=u,r.areEqual(F,E,"Vector3")||(l.setPosition(F),s.plane=l),s},sectionPosMap:{SingleSel:{getPos:function(n){return function(n){var r,a,p,m,y,g=n.info,P=n.measurable,f=n.selectedObject,v=n.viewer,T=f.pathElement,C=!0;if(T){var _=function(t){if(f&&f.event){var i=f.event.currentPosition?f.event.currentPosition:f.event.from?f.event.from[0].currentPosition:new e.Vector2(0,0);return(c=i?t.getMousePosition(i):void 0)?t.pick(c,"primHybrid",!0):void 0}};if(function(){var n,r=o.isOOCTileSetNodeInPath(T),c=T.getLastElement().sgNode;if(c||r)switch((y=P||h({pathElement:T,position:f.position,normal:f.normal,isOOCTileSetNodeInPath:r,primitive:c})).getType()){case t.GeometryType.POINT:C=!1,a=y.getSelPoint(),g&&g.sight&&(p=g.sight.clone().negate().normalize());break;case t.GeometryType.LINE:C=!1;var u=y.getPoints();(s=new e.Vector3).subVectors(u.beginPoint,u.endPoint).normalize(),p=d(g.sight,s),a=y.getSelPoint();break;case t.GeometryType.CURVE:var M;C=!1,a=y.getSelPoint(),M=f&&!f.tangent?(m=_(v))&&m.tangent?m.tangent.clone().transformDirection(y.getMatrix()).normalize():g.sight():f.tangent.clone().normalize(),p=d(g.sight,M);break;case t.GeometryType.CIRCLE:C=!1;var S=y.getAxis();a=y.getCenter(),p=d(g.sight,S);break;case t.GeometryType.SPHERE:g&&g.sight&&(p=g.sight.clone().negate().normalize()),a=y.getCenter();break;case t.GeometryType.SURFACE:var E=y.getSelNormal().clone().normalize();E||(E=(m=_(v))&&m.normal?m.normal.clone().transformDirection(y.getMatrix()).normalize():y.getNormal().clone().normalize()),p=E?d(g.sight,E):g.sight.clone().negate().normalize(),n=y.getSelPoint(),a=n||(f.position?f.position:y.getCoG());break;case t.GeometryType.PLANE:(l=y.getPlane())&&(p=l.normal?d(g.sight,l.normal.clone().normalize()):g.sight.clone().negate().normalize(),n=y.getSelPoint(),a=n||(f.position?f.position:l.origin));break;case t.GeometryType.CYLINDER:case t.GeometryType.CONE:!function(){var t=y.getPoints();n=y.getSelPoint();var o=y.getAxis().clone().toArray();if(!(p=y.getSelNormal()))if((m=_(v))&&m.normal)p=m.normal.clone().transformDirection(y.getMatrix()).normalize();else{var r=i.computePointLineDistance(n.clone().toArray(),t.beginPoint.clone().toArray(),o),s=new e.Vector3(r.aPosition[0],r.aPosition[1],r.aPosition[2]);p=s.clone().sub(n).normalize().negate()}var l=n.clone().toArray(),c=t.beginPoint.toArray(),u=p.toArray(),d=i.computeTwoLinesDistance(l,u,c,o).aPosition2;a=new e.Vector3(d[0],d[1],d[2])}();break;default:p=void 0,a=void 0}}(),p||a){if(l=(new e.Plane).setFromNormalAndCoplanarPoint(p.clone(),a.clone()),c=a,C&&n.boxCenterCB){var M=n.boxCenterCB();if(M){var S=l.projectPoint(M);n.isInBox(S)&&(c=S)}}r=u(p,c)}else{var E=o.isPathToAxisSystem(T);if(E){var N,D,b;T&&T.getWorldMatrix?N=T.getWorldMatrix():(N=(new e.Matrix4).makeBasis(new e.Vector3(1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,1))).setPosition(new e.Vector3(0,0,0));var A=T.externalPath[E+1];if(Boolean(A)&&Boolean(A.getMatrixWorld())){var R=A.getMatrixWorld();R&&(N=R)}var w=N.clone(),V=new e.Vector3,I=new e.Vector3,x=new e.Vector3;w.extractBasis(V,I,x),a=(new e.Vector3).getPositionFromMatrix(w),(p=o.findClosestLocalAxis(g.sight,V,I,x))&&(p.equals(V.clone())||p.equals(V.clone().negate())?(D=I,b=x):p.equals(I.clone())||p.equals(I.clone().negate())?(D=V,b=x):(p.equals(x.clone())||p.equals(x.clone().negate()))&&(D=I,b=V)),p.negate(),p.normalize(),D&&b&&p&&a&&(r=(new e.Matrix4).makeBasis(D,b,p)).setPosition(a)}}return n.retriveMeasureble?{plane:r,measurable:y}:r}}(n)}},PointLine:{getPos:function(e){if(e.measurables&&!(e.measurables.length<2)){var i=e.measurables[0],n=e.measurables[1],o=i.getType()===t.GeometryType.SPHERE?i.getCenter():i.getSelPoint(),r=n.getPoints(),a=r.beginPoint,l=r.endPoint,c=e.info;s=n.getAxis();var u=m(o,a,l,c,e.boxCenterCB(),e.isInBox);return u&&u.planeDef&&u.planeDef.setPosition&&u.planeDef.setPosition(o),u}}},PointAxis:{getPos:function(e){if(e.measurables&&!(e.measurables.length<2)){var i,n,o=e.measurables[0],r=e.measurables[1],a=o.getType(),l=r.getType(),c=e.info,u=a===t.GeometryType.SPHERE?o.getCenter():o.getSelPoint();if(s=r.getAxis(),l===t.GeometryType.CYLINDER||l===t.GeometryType.CONE){var p=r.getPoints();i=p.beginPoint,n=p.endPoint}else i=r.getCenter(),n=s.clone().multiplyScalar(r.getRadius()).add(i);var d=m(u,i,n,c,e.boxCenterCB(),e.isInBox);return d&&d.planeDef&&d.planeDef.setPosition&&d.planeDef.setPosition(u),d}}},PointNormal:{getPos:function(e){if(e.measurables&&!(e.measurables.length<2)){var i=e.measurables[0],n=e.measurables[1],o=i.getType()===t.GeometryType.SPHERE?i.getCenter():i.getSelPoint();n.getSelPoint=function(){return o.clone()};var r=g(n,e.info,e.boxCenterCB(),e.isInBox);return r&&r.planeDef&&r.planeDef.setPosition&&r.planeDef.setPosition(o),r}}},LineLine:{getPos:function(e){if(e.measurables&&!(e.measurables.length<2)){var t=e.measurables[0],i=e.measurables[1],n=e.info,o=t.getAxis(),r=t.getPoints(),a=i.getAxis(),s=i.getPoints().beginPoint,l=y(r,o,s,a,n,e.boxCenterCB(),e.isInBox);return l&&l.planeDef&&l.planeDef.setPosition&&l.planeDef.setPosition(t.getSelPoint()),l}}},LinePoint:{getPos:function(i){if(i.measurables&&!(i.measurables.length<2)){var n=i.measurables[0],o=i.measurables[1],r=o.getType()===t.GeometryType.SPHERE?o.getCenter():o.getSelPoint(),a=n.getPoints(),l=a.beginPoint,c=a.endPoint,u=i.info;(s=new e.Vector3).subVectors(l.clone(),c.clone()).normalize();var p=m(r,l,c,u,i.boxCenterCB(),i.isInBox);return p&&p.planeDef&&p.planeDef.setPosition&&p.planeDef.setPosition(n.getSelPoint()),p}}},LineAxis:{getPos:function(e){if(e.measurables&&!(e.measurables.length<2)){var i,n=e.measurables[0],o=e.measurables[1],r=o.getType(),a=e.info,s=n.getAxis(),l=n.getPoints(),c=o.getAxis();i=r===t.GeometryType.CYLINDER||r===t.GeometryType.CONE?o.getPoints().beginPoint:o.getCenter();var u=y(l,s,i,c,a,e.boxCenterCB(),e.isInBox);return u&&u.planeDef&&u.planeDef.setPosition&&u.planeDef.setPosition(n.getSelPoint()),u}}},AxisPoint:{getPos:function(e){if(e.measurables&&!(e.measurables.length<2)){var i,n,o=e.measurables[0],r=e.measurables[1],a=r.getType(),l=o.getType(),c=e.info,u=!1,d=a===t.GeometryType.SPHERE?r.getCenter():r.getSelPoint();if(s=o.getAxis(),l===t.GeometryType.CYLINDER||l===t.GeometryType.CONE){var h=o.getPoints();i=h.beginPoint,n=h.endPoint}else u=!0,i=o.getCenter(),n=s.clone().multiplyScalar(o.getRadius()).add(i);var y=m(d,i,n,c,e.boxCenterCB(),e.isInBox);if(y&&y.planeDef&&y.planeDef.setPosition){var g=u?o.getCenter().clone():p(y.planeDef,o);g&&y.planeDef.setPosition(g)}return y}}},AxisLine:{getPos:function(e){if(e.measurables&&!(e.measurables.length<2)){var i,n=e.measurables[1],o=e.measurables[0],r=o.getType(),a=e.info,s=n.getAxis(),l=n.getPoints(),c=o.getAxis(),u=!1;r===t.GeometryType.CYLINDER||r===t.GeometryType.CONE?i=o.getPoints().beginPoint:(u=!0,i=o.getCenter());var d=y(l,s,i,c,a,e.boxCenterCB(),e.isInBox);if(d&&d.planeDef&&d.planeDef.setPosition){var h=u?o.getCenter().clone():p(d.planeDef,o);h&&d.planeDef.setPosition(h)}return d}}},AxisNormal:{getPos:function(e){if(e.objectAction&&e.measurables&&!(e.measurables.length<2)){var i=e.measurables[1],n=e.measurables[0],o=!1;n.getType()===t.GeometryType.CIRCLE&&(o=!0);var r=g(i,e.info,e.boxCenterCB(),e.isInBox);if(r&&r.planeDef&&r.planeDef.setPosition){var a=o?n.getCenter().clone():p(r.planeDef,n);a&&r.planeDef.setPosition(a)}return r}}},AxisAxis:{getPos:function(e){if(e.measurables&&!(e.measurables.length<2)){var i,n,o=e.measurables[0],r=e.measurables[1],a=o.getType(),s=r.getType(),l=e.info,c=o.getAxis(),u=r.getAxis(),d=!1;a===t.GeometryType.CYLINDER||a===t.GeometryType.CONE?i=o.getPoints():(d=!0,(i=[]).beginPoint=o.getCenter(),i.endPoint=c.clone().multiplyScalar(o.getRadius()).add(i.beginPoint.clone())),n=s===t.GeometryType.CYLINDER||s===t.GeometryType.CONE?r.getPoints().beginPoint:r.getCenter();var h=y(i,c,n,u,l,e.boxCenterCB(),e.isInBox);if(h&&h.planeDef&&h.planeDef.setPosition){var m=d?o.getCenter().clone():p(h.planeDef,o);m&&h.planeDef.setPosition(m)}return h}}},NormalPoint:{getPos:function(e){if(e.measurables&&!(e.measurables.length<2)){var i=e.measurables[0],n=e.measurables[1],o=n.getType()===t.GeometryType.SPHERE?n.getCenter():n.getSelPoint();i.getSelPoint=function(){return o.clone()};var r=g(i,e.info,e.boxCenterCB(),e.isInBox);return r&&r.planeDef&&r.planeDef.setPosition&&r.planeDef.setPosition(i.getSelPoint()),r}}},NormalLine:{getPos:function(e){if(e.objectAction&&e.measurables&&e.measurables.length){var t=e.measurables[0],i=g(t,e.info,e.boxCenterCB(),e.isInBox);return i&&i.planeDef&&i.planeDef.setPosition&&i.planeDef.setPosition(t.getSelPoint()),i}}},LineNormal:{getPos:function(e){if(e.objectAction&&e.measurables&&!(e.measurables.length<2)){var t=e.measurables[1],i=e.measurables[0],n=g(t,e.info,e.boxCenterCB(),e.isInBox);return n&&n.planeDef&&n.planeDef.setPosition&&n.planeDef.setPosition(i.getSelPoint()),n}}},NormalAxis:{getPos:function(e){if(e.objectAction&&e.measurables&&e.measurables.length){var t=e.measurables[0],i=g(t,e.info,e.boxCenterCB(),e.isInBox);return i&&i.planeDef&&i.planeDef.setPosition&&i.planeDef.setPosition(t.getSelPoint()),i}}},Normal:{getPos2:function(e){if(e.objectAction&&e.measurable){var t=e.measurable,i=g(t,e.info,e.boxCenterCB(),e.isInBox);return i&&i.planeDef&&i.planeDef.setPosition&&i.planeDef.setPosition(t.getSelPoint()),i}}},PointPointPoint:{getPos:function(e){if(e.measurables&&!(e.measurables.length<3)){var i=e.measurables[0],n=e.measurables[1],o=e.measurables[2],r=i.getType(),a=n.getType(),s=o.getType(),l=e.info,c=r===t.GeometryType.SPHERE?i.getCenter():i.getSelPoint(),u=a===t.GeometryType.SPHERE?n.getCenter():n.getSelPoint(),p=s===t.GeometryType.SPHERE?o.getCenter():o.getSelPoint(),d=m(c,u,p,l,e.boxCenterCB(),e.isInBox);return d&&d.planeDef&&d.planeDef.setPosition&&d.planeDef.setPosition(c),d}}},PointPointLine:{getPos:function(i){if(i.measurables&&!(i.measurables.length<3)){var n,o=i.measurables[0],a=i.measurables[1],s=i.measurables[2],l=o.getType(),c=a.getType(),u=l===t.GeometryType.SPHERE?o.getCenter():o.getSelPoint(),p=c===t.GeometryType.SPHERE?a.getCenter():a.getSelPoint(),d=i.info,h=s.getPoints();if(r.areEqual(u,p,"Vector3"))n=m(u,h.beginPoint.clone(),h.endPoint.clone(),d,i.boxCenterCB(),i.isInBox);else{var g=s.getAxis(),P=new e.Vector3;P.subVectors(u.clone(),p.clone()).normalize();var f=u.clone();n=y(h,g,f,P,d,i.boxCenterCB(),i.isInBox)}return n&&n.planeDef&&n.planeDef.setPosition&&n.planeDef.setPosition(u),n}}},PointPointAxis:{getPos:function(i){if(i.measurables&&!(i.measurables.length<3)){var n,o=i.measurables[0],a=i.measurables[1],s=i.measurables[2],l=o.getType(),c=a.getType(),u=s.getType(),p=l===t.GeometryType.SPHERE?o.getCenter():o.getSelPoint(),d=c===t.GeometryType.SPHERE?a.getCenter():a.getSelPoint(),h=i.info,g=s.getAxis();u===t.GeometryType.CYLINDER||u===t.GeometryType.CONE?n=s.getPoints():((n=[]).beginPoint=s.getCenter(),n.endPoint=g.clone().multiplyScalar(s.getRadius()).add(n.beginPoint.clone()));var P=new e.Vector3;P.subVectors(p.clone(),d.clone()).normalize();var f,v=p.clone();return(f=r.areEqual(p,d,"Vector3")?m(p,n.beginPoint.clone(),n.endPoint.clone(),h,i.boxCenterCB(),i.isInBox):y(n,g,v,P,h,i.boxCenterCB(),i.isInBox))&&f.planeDef&&f.planeDef.setPosition&&f.planeDef.setPosition(p),f}}}}};return Object.freeze(P)});