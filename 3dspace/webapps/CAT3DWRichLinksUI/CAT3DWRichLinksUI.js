define("DS/CAT3DWRichLinksUI/CAT3DWExternalRichLinkProcessingUtils",["UWA/Data","UWA/Class","UWA/Promise"],function(t,e,n){"use strict";var i=e.extend({init:function(){},getURLInformation:function(t,e){return new n(function(n,i){var r=new URL(t),a={url:r.hostname};this.requestExternalUrl({url:t,responseType:"text",proxy:e}).then(function(t){var i=t.headers.get("content-type");if(i.match(/text\/html/g)||i.match(/application\/xhtml/g)){var o=(new DOMParser).parseFromString(t.data,"text/html"),s=o.getElementsByTagName("meta"),c=o.getElementsByTagName("link");a.title=o.title,a.description=null;var l=null,u=null,h=null,m=null;if(s){s.description&&(a.description=s.description.content);for(let t=0;t<s.length;t++)!a.title&&s[t].getAttribute("property")&&"og:title"===s[t].getAttribute("property")&&(a.title=s[t].getAttribute("content")),!a.description&&s[t].getAttribute("property")&&"og:description"===s[t].getAttribute("property")&&(a.description=s[t].getAttribute("content")),s[t].getAttribute("property")&&"og:image"===s[t].getAttribute("property")&&(l=s[t].getAttribute("content"))}if(c){for(let t=0;t<c.length;t++){if(c[t].getAttribute("rel")&&"icon"===c[t].getAttribute("rel")){if(c[t].getAttribute("sizes")&&h&&parseInt(c[t].getAttribute("sizes"))<h)continue;u=c[t].getAttribute("href"),h=c[t].getAttribute("sizes")?parseInt(c[t].getAttribute("sizes")):h}c[t].getAttribute("rel")&&"shortcut icon"===c[t].getAttribute("rel")&&(m=c[t].getAttribute("href")),c[t].getAttribute("rel")&&"icon shortcut"===c[t].getAttribute("rel")&&(m=c[t].getAttribute("href"))}var p=u||m}}a.title||(a.title=r.hash);var d=0;if(p&&d++,l&&d++,0===d)n(a);else{var f=0,g=function(){++f===d&&n(a)};l&&this.requestExternalUrl({url:l,responseType:"blob",proxy:e}).then(function(t){if(t.data.type.includes("image/")){var e=URL.createObjectURL(t.data);a.image=e}g()}).catch(function(){g()}),p&&this.requestExternalUrl({url:p,responseType:"blob",proxy:e}).then(function(t){if(t.data.type.includes("image/")){var e=URL.createObjectURL(t.data);a.favicon=e}g()}).catch(function(){g()})}}.bind(this)).catch(function(){n()})}.bind(this))},requestExternalUrl:function(t){return new n(function(e,n){var i=UWA.Data;UWA.Data.proxies.ajax.contains("netvibes")&&window.parent&&window.parent.UWA&&window.parent.UWA.Data&&window.parent.UWA.Data.proxies&&(i=window.parent.UWA.Data);var r=t.proxy?t.proxy:"ajax",a=t.responseType?t.responseType:"text",o=t.url;o.startsWith("//")&&(o="https:"+o),o.startsWith("http://")||o.startsWith("https://")||(o="https://"+o);var s=i.proxifyUrl(o,{proxy:r});i.request(s,{proxy:r,timeout:15e3,type:a,onComplete:function(t,n){var i=new Headers(n);e({data:t,headers:i})},onTimeout:function(){console.warn("request url timed out"),n()},onFailure:function(t){t&&console.warn(t),n()}})})}});return UWA.namespace("DS/CAT3DWRichLinksUI/CAT3DWExternalRichLinkProcessingUtils",i)}),define("DS/CAT3DWRichLinksUI/CAT3DWRichLinkHtmlView",["UWA/Class","i18n!DS/CAT3DWRichLinksUI/assets/nls/CAT3DWRichLinkHtmlView"],function(t,e){"use strict";var n=t.extend({init:function(t){this._mainContainer=new UWA.Element("div",{class:"rich-link-preview"}),this._imageContainer=new UWA.Element("div",{class:"preview-image-container"}).inject(this._mainContainer),this._dataContainer=new UWA.Element("div",{class:"preview-data-container"}).inject(this._mainContainer),this._build(t)},getHTML:function(){return this._mainContainer},_build:function(t){if(t||console.warn("[CAT3DWRichLinkHTMLView : no params to build link view]"),t.thumbnail)new UWA.Element("img",{class:"preview-thumbnail",src:t.thumbnail}).inject(this._imageContainer);if(t.favicon&&!t.type)new UWA.Element("img",{class:"preview-favicon",src:t.favicon}).inject(this._imageContainer);else{var n=this._getFonticon(t.type,t.mediaType);new UWA.Element("div",{class:"preview-icon",html:{tag:"span",class:"fonticon "+n.name},styles:{color:n.color,"background-color":n.bkcolor}}).inject(this._imageContainer)}if(t.title)new UWA.Element("span",{class:"preview-title",text:this._truncate(t.title,80)}).inject(this._dataContainer);if(t.url||t.author||t.community){var i=new UWA.Element("div",{class:"preview-domain"}).inject(this._dataContainer);if(t.url)new UWA.Element("a",{text:t.url}).inject(i);if(t.author&&t.community)new UWA.Element("div",{class:"preview-author-community",html:[{tag:"span",text:e.get("authorPrep")+" "},{tag:"a",text:t.author},{tag:"span",text:" "+e.get("communityPrep")+" "},{tag:"a",text:t.community}]}).inject(i)}if(t.description)new UWA.Element("span",{class:"preview-description",text:this._truncate(t.description,150)}).inject(this._dataContainer)},_truncate:function(t,e){return t.length>e?t.substr(0,e-1)+"...":t},_getFonticon:function(t,e){switch(t){case"posts":case"post":return{name:"fonticon-newspaper",color:"white",bkcolor:"#adadad"};case"idea":return{name:"fonticon-lightbulb",color:"white",bkcolor:"#00b8de"};case"iquestion":return{name:"fonticon-i-question",color:"white",bkcolor:"#ea4f37"};case"survey":return{name:"fonticon-clipboard",color:"white",bkcolor:"#e87b00"};case"WeDo":return{name:"fonticon-task",color:"white",bkcolor:"#005686"};case"media":var n=e;return"sketch"===e&&(n="app-3dsketch"),"whiteboard"===e&&(n="app-whiteboard"),"document"===e&&(n="doc"),"animatedPicture"===e&&(n="picture-animated"),"3d_model"===e&&(n="cube"),"story"===e&&(n="app-3dstory"),{name:"fonticon-"+n,color:"white",bkcolor:"#70036b"};case"wiki":return{name:"fonticon-book-open",color:"white",bkcolor:"#00aa86"};default:return{name:"fonticon-globe",color:"#77797c",bkcolor:"white"}}}});return UWA.namespace("DS/CAT3DWRichLinksUI/CAT3DWRichLinkHtmlView",n)}),define("DS/CAT3DWRichLinksUI/CAT3DWInternalRichLinkProcessingUtils",["UWA/Class","DS/CAT3DWInfra/CAT3DWPlateformServices","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWRichLinksUI/CAT3DWExternalRichLinkProcessingUtils","UWA/Promise"],function(t,e,n,i,r){"use strict";var a=t.extend({init:function(){this._externalRichLinkUtils=new i},getSwymContentData:function(t){return new r(function(n,i){var r,a,o={};t.contains("#app")?(a=t.match(/contentType=([^&]*)/i)[1],r=t.match(/contentId=([^&]*)/i)[1]):t.contains("post")?(a="posts",r=t.match(/post:([^/]{0,})/i)[1]):t.contains("iquestion")?(a="iquestion",r=t.match(/iquestion:([^/]{0,})/i)[1]):t.contains("idea")?(a="idea",r=t.match(/idea:([^/]{0,})/i)[1]):t.contains("wiki")?(a="wiki",r=t.match(/wiki:([^/]{0,})/i)[1]):t.contains("media")?(a="media",r=t.match(/media:([^/]{0,})/i)[1]):t.contains("survey")?(a="survey",r=t.match(/survey:([^/]{0,})/i)[1]):t.contains("wedo")&&(a="WeDo",r=t.match(/wedo:([^/]{0,})/i)[1]),a?(o.type=a,this.getSwymURL().then(e.getCsrfToken.bind(this)).then(function(i){e.search({url:i.url,token:i.token,legacyFormat:!1,query:"#all",contentType:a,refineUsingQuery:'id:"'+r+'"',nresults:1,start:0}).then(function(e){var i=!1;if(o.url=t,o.searchSucceeded=!0,o.searchNbResults=e.nhits,0!==e.nhits){for(var a=e.hits[0].metas,s=null,c=0;c<a.length;c++){if("id"===a[c].name&&r!==a[c].value)return;if("title"===a[c].name&&(o.title=a[c].value),"name"===a[c].name&&(o.author=a[c].value),"ds6w_58_community"===a[c].name&&(o.community=a[c].value),"ds6w_58_description"===a[c].name&&(o.description=a[c].value),"preview_media_type"===a[c].name&&(o.mediaType=a[c].value),"preview_url"===a[c].name&&a[c].value){s=a[c].value;var l=new URL(s);window.top.bundles.ifwe||window.top.dsResourceUrl&&!window.top.dsResourceUrl.includes(l.host)?(i=!0,this._externalRichLinkUtils.requestExternalUrl({url:s,responseType:"blob",proxy:"passport"}).then(function(t){if(t.data.type.includes("image/")){var e=URL.createObjectURL(t.data);o.image=e}n(o)}).catch(function(){n(o)})):o.image=s}}i||n(o)}else this._externalRichLinkUtils.getURLInformation(t,"passport").then(function(t){n(t)})}.bind(this)).catch(function(){this._externalRichLinkUtils.getURLInformation(t,"passport").then(function(t){n(t)})}.bind(this))}.bind(this))):this._externalRichLinkUtils.getURLInformation(t,"passport").then(function(t){n(t)})}.bind(this))},getSwymURL:function(){var t=n.getPreferenceValue("swymTenant");return t?(t=t.toUpperCase(),e.get3DSwym(t)):r.resolve(!1)}});return UWA.namespace("DS/CAT3DWRichLinksUI/CAT3DWInternalRichLinkProcessingUtils",a)}),define("DS/CAT3DWRichLinksUI/CAT3DWRichLinkPreviewGenerator",["UWA/Core","UWA/Class/Events","UWA/Class/Listener","DS/CAT3DWRichLinksUI/CAT3DWExternalRichLinkProcessingUtils","DS/CAT3DWRichLinksUI/CAT3DWInternalRichLinkProcessingUtils","DS/CAT3DWRichLinksUI/CAT3DWRichLinkHtmlView","UWA/Promise"],function(t,e,n,i,r,a,o){"use strict";return n.singleton(e,{init:function(){this._externalRichLinkUtils=new i,this._internalRichLinkUtils=new r},getContentFromUrl:function(t){return new Promise(function(e){return this._isSwymContentUrl(t).then(function(n){if(!n)return this._externalRichLinkUtils.getURLInformation(t,"ajax").then(function(t){e(t)});t&&this._internalRichLinkUtils.getSwymContentData(t).then(function(t){e(t)})}.bind(this)).catch(function(t){t&&console.log(t)})}.bind(this))},createLinkPreview:function(t){return new a({title:t.title,description:t.description,thumbnail:t.image,favicon:t.favicon,type:t.type,url:t.url,author:t.author,community:t.community,mediaType:t.mediaType}).getHTML()},createPreview:function(t){return new Promise(function(e){this.getContentFromUrl(t).then(function(t){if(t){var n=this.createLinkPreview(t);e(n)}else e(!1)}.bind(this))}.bind(this))},_isSwymContentUrl:function(t){return this._internalRichLinkUtils.getSwymURL().then(function(e){var n=!1,i=t.startsWith(e);if(!i){var r=null!==t.match("#app:X3DMCTY_AP")&&2===t.match(/content:url=(.*?(?=&))/i).length&&t.match(/content:url=(.*?(?=&))/i)[1].replace(/%3A/g,":").replace(/%2F/g,"/").replace(/%2e/g,".");n=e&&e===r}return n||i})}})});