define("DS/3DXMTiles/CopyViscaURLServices",function(){"use strict";var e=function(){};function t(e){for(var t=e.split("&"),n={},i=0;i<t.length;i++){var o=t[i].split("=");"s"===o[0]?n.source=o[1]:"t"===o[0]?n.tenant=o[1]:"id"===o[0]?n.boid=o[1]:"f"===o[0]?n.filename=o[1]:"fmt"===o[0]?n.format=o[1]:"v"===o[0]?n.version=o[1]:"ts"===o[0]?n.timestamp=o[1]:"type"===o[0]?n.type=o[1]:"sgn"===o[0]&&(n.signature=o[1])}return n}return e.prototype.CreateURLsRequestBody=function(e,t){if(void 0!==e&&0!==e.length){for(var n={},i={files:[]},o=0;o<e.length;o++){if(void 0===e[o])return;i.files.push(e[o])}return"object"==typeof t&&"boolean"==typeof t.fallback&&t.fallback&&(i.fallback=!0),n.body=JSON.stringify(i),n}},e.prototype.CreateBatchURLAndBody=function(e,n){if(void 0!==e&&0!==e.length){for(var i={},o={files:[]},r=0;r<e.length;r++){if(void 0===e[r])return;var s=e[r].toLowerCase().search("api/v1/rep?");if(-1===s)return;0===r&&(i.url=e[r].substring(0,s)+"api/v1/reps");var a=t(e[r].substring(s+"api/v1/rep?".length,e[r].length));o.files.push(a)}return"object"==typeof n&&"boolean"==typeof n.allowPartial&&n.allowPartial&&(o.allowPartial=!0),"object"==typeof n&&"boolean"==typeof n.fallback&&n.fallback&&(o.fallback=!0),"object"==typeof n&&"string"==typeof n.emptyFallback&&n.emptyFallback.length>0&&(o.emptyFallback=emptyFallback),"object"==typeof n&&"boolean"==typeof n.checkVersion&&n.checkVersion&&(o.checkVersion=!0),i.body=JSON.stringify(o),i}},e.prototype.CreateFetchURLAndBody=function(e,n,i){if(void 0!==e&&0!==e.length&&void 0!==n&&n.length===e.length){for(var o={},r={files:[]},s=0;s<e.length;s++){if(void 0===e[s])return;var a=e[s].toLowerCase().search("api/v1/rep?");if(-1===a)return;0===s&&(o.url=e[s].substring(0,a)+"api/v1/fetch");var d=t(e[s].substring(a+"api/v1/rep?".length,e[s].length));d.correlationID=n[s],r.files.push(d)}return"object"==typeof i&&"number"==typeof i.splitTargetedSize&&i.splitTargetedSize>0&&(r.splitTargetedSize=i.splitTargetedSize),"object"==typeof i&&"boolean"==typeof i.allowPartial&&i.allowPartial&&(r.allowPartial=!0),"object"==typeof i&&"boolean"==typeof i.checkVersion&&i.checkVersion&&(r.checkVersion=!0),o.body=JSON.stringify(r),o}},e}),define("DS/3DXMTiles/OOCQuickOverrideSet",[],function(){"use strict";function e(e,t){this.referenceId=e,this.overrideCB=t}var t=0,n=function(e){this.oocManager=e,this._overrides=new Map,this._active=!1,this._id="_quick_"+t,t++};return n.prototype.setOverrideCB=function(t,n){n=n||null;var i=this._overrides.get(t);n?i||(i=new e(t,n),this._overrides.set(t,i)):i&&this._overrides.delete(t),this._active&&this.oocManager.setOverrideCB(t,n,this._id)},n.prototype.removeOverrideCB=function(e){this.setOverrideCB(e,null)},n.prototype.hasOverrideCB=function(e){var t=this._overrides.get(e);return!!t&&null!==t.overrideCB},n.prototype.setActive=function(e){var t=this.oocManager,n=this._id;(e=!!e)!==this._active&&(this._active=e,e?(t.registerOverrideSet(n),this._overrides.forEach(function(e,i){t.setOverrideCB(e.referenceId,e.overrideCB,n)})):t.removeOverrideSet(n))},n}),define("DS/3DXMTiles/DSTilesForceLoadTransaction",[],function(){"use strict";var e=function({tileSet:e,onExploreCB:t,onLoadedCB:n,requestBoundingBox:i}){this.onExploreCB=t,this.onLoadedCB=n,this.tileSet=e,this.nodesToExplore=new Set,this.nodesToExplore.add(e.rootURI),this.toExpand=new Set,this.toDownload=new Set,this.forcedTileNodes=new Set,this.requestBoundingBox=i};function t(e,t,n,i){this.isError=e.isError(),this.uri=e.uri,this.geometricalError=e.geometricalError*i,this.isLeaf=e.isLeaf(),this.content=t?e.exportContent():null,this.hasContent=e.hasContent();var o,r=n?e.getDistanceToBoxCache():null;if(r)for(this.boundingBoxes=[],o=0;o<r.length;o++)this.boundingBoxes.push(r[o].boundingBox);else this.boundingBoxes=null}function n(){this.reset()}return e.prototype.update=function(){var e=[],i=[],o=this.nodesToExplore.size>0;for(this.tileSet.getRootNode().updateWorldMatrix();o;){for(o=!1,this.nodesToExplore.forEach(r=>{var s,a=this.tileSet.getTile(r),d=new n;if(a){if(d.reset(),this.onExploreCB(new t(a,!1,this.requestBoundingBox,this.tileSet.unitScale),d),d._exploreChildren&&a.hasExpand()){for(s=0;s<a.childrenURIs.length;s++)i.push(a.childrenURIs[s]);a.isExpandLoaded()?o=!0:this.toExpand.add(r)}d._forceLoad&&a.hasContent()&&(a.isContentLoaded()?this.forcedTileNodes.add(a):this.toDownload.add(r),a.lockUnload()),e.push(r)}}),r=0;r<e.length;r++)this.nodesToExplore.delete(e[r]);for(e.length=0,r=0;r<i.length;r++)this.nodesToExplore.add(i[r]);i.length=0}var r,s=[];for(this.toExpand.forEach(e=>{if(this.tileSet.canExpand()){var t=this.tileSet.getTile(e);t.isExpandLoading()||this.tileSet.expandTile(t)}else s.push(e)}),this.toExpand.clear(),r=0;r<s.length;r++)this.toExpand.add(s[r]);for(s=[],this.toDownload.forEach(e=>{if(this.tileSet.canLoadContent()){var t=this.tileSet.getTile(e);t.isContentLoading()||this.tileSet.loadTileContent(t),this.forcedTileNodes.add(t)}else s.push(e)}),this.toDownload.clear(),r=0;r<s.length;r++)this.toDownload.add(s[r]);var a=!0;return(this.nodesToExplore.size>0||this.toExpand.size>0||this.toDownload.size>0)&&(a=!1),a&&this.forcedTileNodes.forEach(e=>{e.isContentLoaded()||e.isError()||(a=!1)}),a&&this.onLoadingComplete(),a},e.prototype.onLoadingComplete=function(){var e=[];this.forcedTileNodes.forEach(n=>{e.push(new t(n,!0,this.requestBoundingBox,this.tileSet.unitScale))}),this.forcedTileNodes.clear(),this.onLoadedCB.call(null,e)},n.prototype.exploreChildren=function(){this._exploreChildren=!0},n.prototype.forceLoad=function(){this._forceLoad=!0},n.prototype.reset=function(){this._exploreChildren=!1,this._forceLoad=!1},e}),define("DS/3DXMTiles/DSTilesExpander",[],function(){"use strict";var e=function(){};return e.prototype.isReady=function(){return!0},e.prototype.isThereEnoughMemoryToExpand=function(e,t){return!0},e.prototype.expand=function(e,t){setTimeout(t.onNodeExpandError.bind(t,e),0)},e}),define("DS/3DXMTiles/LDHOcclusionStatus",[],function(){return{unknown:"unknown",visible:"visible"}}),define("DS/3DXMTiles/InstancingFactory",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory"],function(e,t){"use strict";var n=function(){};function i(e,t){if(0===t.length)return e;var n=new Float32Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n}return n.prototype.buildInstancingBox=function(t){var n=t.matrices.length,i=t.matrices,o=t.boxes,r=t.colors,s=t.attributes||{},a=this.buildBoxMesh(s),d=this.buildMaterial(t);a.setMaterial(d);new e.Box3;return this.setUpMeshInstancingParameters(a,n,i,o,r),a.setExcludeFromBounding(!0),a.setFrustumCulled(!1),a},n.prototype.updateInstancingBox=function(t){var n=t.mesh,o=t.instancingParams.matrices.length,r=t.instancingParams.matrices,s=t.instancingParams.boxes,a=t.instancingParams.colors,d=new e.Box3,h=this.buildInstancingParameters(o,r,s,a,d),l=n.nbInstances+o;n.nbInstances=l;var c=t.mesh.mesh3js;c._instancingInfos.nbInstances=l;var u,p=c._instancingInfos.instanceAttribArrays,f=new Float32Array(l);for(u=0;u<l;u++)f[u]=5+5*u;p.instanceId.array=f,p.instanceId.isDynamic=!0;var g=p.instanceMatrix;g.array=i(g.array,h[0].data),g.isDynamic=!0;var m=p.instanceColor;m.array=i(m.array,h[1].data),m.isDynamic=!0;var y,v=t.indexesToHide;for(u=0;u<v.length;u+=2)y=3*v[u],m.array[y]=0,m.array[y+1]=0,m.array[y+2]=0;for(v=t.indexesToHideTmp,u=0;u<v.length;u+=2)y=3*v[u],m.array[y]=0,m.array[y+1]=0,m.array[y+2]=0;var M,S,L,D=t.indexesToShow,T=new e.Color;for(u=0;u<D.length;u+=2)y=3*D[u],M=D[u+1],T.setHex(M),m.array[y]=T.r,m.array[y+1]=T.g,m.array[y+2]=T.b;for(S=0;S<n._occurrences.length;S++)(L=n._occurrences[S].renderable)._instancingInfos.instanceAttribArrays.instanceId.isDynamic=!0,L._instancingInfos.instanceAttribArrays.instanceMatrix.isDynamic=!0,L._instancingInfos.instanceAttribArrays.instanceColor.isDynamic=!0},n.prototype.buildBoxMesh=function(n){if(1===n.dimension){var i,o=[new e.Vector3(0,0,0),new e.Vector3(1,0,0),new e.Vector3(0,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,0),new e.Vector3(0,0,1),new e.Vector3(1,0,0),new e.Vector3(1,1,0),new e.Vector3(1,0,0),new e.Vector3(1,0,1),new e.Vector3(0,1,0),new e.Vector3(0,1,1),new e.Vector3(0,1,0),new e.Vector3(1,1,0),new e.Vector3(0,0,1),new e.Vector3(0,1,1),new e.Vector3(0,0,1),new e.Vector3(1,0,1),new e.Vector3(1,1,1),new e.Vector3(0,1,1),new e.Vector3(1,1,1),new e.Vector3(1,0,1),new e.Vector3(1,1,1),new e.Vector3(1,1,0)],r=[];for(i=0;i<o.length;i++)r.push(i);return t.createLineNode({points:o,drawMode:Mesh.ConnectivityTypeEnum.LINES,idx:r})}return t.createCuboidNodeFromBox3(new e.Box3(new e.Vector3(0,0,0),new e.Vector3(1,1,1)))},n.prototype.buildMaterial=function(t){var n=t.material,i=t.attributes;n||(n=1===i.dimension?new e.LineBasicMaterial({force:!0,opacity:i.opacity}):new e.MeshBasicMaterial({force:!0,opacity:i.opacity})),n.activatePDSFX();n.setPDSFXVaryings({vColor:{type:"v3"}});var o={ComputeObjectPosition:["vec3 ComputeObjectPosition() {","vec4 localPosition = vec4(vGetAttribPosition(), 1.0);","vec4 newPosition = instanceMatrix*localPosition;","return newPosition.xyz;","}"].join("\n"),ComputeVaryingValues:["void ComputeVaryingValues() {","vColor = instanceColor;","}"].join("\n")},r={ComputeAlbedo:["vec3 ComputeAlbedo() {","return vColor;","}"].join("\n"),ComputeSpecularReflectance:["vec3 ComputeSpecularReflectance() {","return vec3(1.0,1.0,1.0);","}"].join("\n"),ComputeDiscard:["bool ComputeDiscard() {","  return (vColor.x == 0.0 && vColor.y == 0.0 && vColor.z == 0.0);","}"].join("\n")},s=["float getDepth(in vec2 coord) {","vec4 rgba_depth = texture2D( depthBuffer, coord );","float depth = unpackRGBA(rgba_depth);","return depth > 1e-6 ? depth + 2.0* DEPTH_PRECISION : 1.0;","}","float depthSampleTest(in vec2 coord, in float delta, in float depth) {","float fDepth = getDepth(coord);","if ( fDepth < depth ) return delta;","return 0.0;","}","bool correctZFighting() {","vec4 occlusionCLipPosition = vGetClipSpacePosition();","vec2 coord = 0.5 + 0.5*occlusionCLipPosition.xy/occlusionCLipPosition.w;","float depth = 0.5 + 0.5 * occlusionCLipPosition.z / occlusionCLipPosition.w;","float delta = 1.0/9.0;","float test = 0.0;","test += depthSampleTest(coord,delta, depth);","if (test > 0.0) {","return true;","}","return false;","}"].join("\n"),a=[].join("\n");if(t.useDBuffer){r.ComputeDiscard="bool ComputeDiscard() { return (vColor.x == 0.0 && vColor.y == 0.0 && vColor.z == 0.0) || correctZFighting(); }";t.viewer.getRenderer();var d={depthBuffer:{type:"t2",value:t.depthBuffer}};n.setPDSFXUniforms(d),n.setPDSFXGlobalShaderCode(a,s),n.side=e.DoubleSide}return n.setPDSFXOverridableFunctions(o,r),n},n.prototype.buildInstancingParameters=function(t,n,i,o,r){var s,a,d,h,l,c,u,p=new Float32Array(16*t),f=new Float32Array(3*t),g=(new e.Matrix4,new e.Matrix4),m=new e.Vector3,y=new e.Matrix4,v=(new e.Matrix4,y);for(s=0;s<t;s++){for(d=n[s],c=i[s].clone(),m.set(c.max.x-c.min.x,c.max.y-c.min.y,c.max.z-c.min.z),g.makeTranslation(c.min.x,c.min.y,c.min.z),g.scale(m),y.multiplyMatrices(d,g),h=16*s,l=v.elements,a=0;a<16;a++)p[h+a]=l[a];h=3*s,u=o[s],f[h]=u.r,f[h+1]=u.g,f[h+2]=u.b}return[{data:p,type:"m4",attribName:"instanceMatrix",isFlattened:!0},{data:f,type:"v3",attribName:"instanceColor",isFlattened:!0}]},n.prototype.setUpMeshInstancingParameters=function(e,t,n,i,o,r){var s=this.buildInstancingParameters(t,n,i,o,r);e.setInstancingParameters(t,s)},new n}),define("DS/3DXMTiles/3DXMTilesUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/BufferGPUManager","DS/Visualization/Mesh3D"],function(e,t,n,i){"use strict";function o(t,n,i,o){this.center=t,this.radius=n,this.scale=i,null!==o?(this.matrixPosition=new e.Vector3,this.matrixPosition.getPositionFromMatrix(o)):this.matrixPosition=null}function r(e){this.boundingBox=e}function s(e){var t=n.mapGeomBufferSize.get(e.id);return t||(t=e.getBuffersMemorySize()),t}o.prototype.isNode3DCache=function(){return null!==this.matrixPosition},o.prototype.positionHasChanged=function(e){var t=e.elements;return t[12]!==this.matrixPosition.x||t[13]!==this.matrixPosition.y||t[14]!==this.matrixPosition.z},o.prototype.containsPoint=function(e){return this.center.distanceTo(e)<=this.radius};new e.Matrix4,new e.Vector3,new e.Vector3,new e.Matrix4;var a=e.MaterialUtils.createShinyFaceMaterial({color:"red",force:!0}),d=new Set;return{computeScreenRadius:function(n,i,o,r,s,h,l){var c,u=n.center,p=n.radius;if(!(l||o.performFrustumCullingNoNearFar(p,u)))return-1;if(i.isOrtho)c=p/r;else{var f=i.matrixWorldInverse.elements;c=p/(r*Math.abs(f[2]*u.x+f[6]*u.y+f[10]*u.z+f[14]))}if(s&&!d.has(s)){d.add(s);var g=new e.Matrix4;g.setPosition(u);var m=t.createSphereNode({matrix:g,radius:p*h});m.setNoZ(!0),m.setMaterial(a),m.showKey=s,debugWebGLV6Viewer.getRootNode().addChild(m)}return c},computeScreenRadiusCache:function(n,i,r,s,d){var h=n?n.getMaxScaleOnAxis():1,l=r.radius*h,c=new e.Vector3;if(c.copy(r.center),n&&c.applyMatrix4(n),i&&c.applyMatrix4(i),s){var u=new e.Matrix4;u.setPosition(c);var p=t.createSphereNode({matrix:u,radius:l});p.setMaterial(a),debugWebGLV6Viewer.getRootNode().addChild(p)}return new o(c,l,h,d?n:null)},computeScreenRadiusCstComponent:function(e,t){if(e.isOrtho)return e.getCameraConstant(1,t.SCREEN_HEIGHT);var n=.5*t.SCREEN_HEIGHT;return n/=Math.tan(.5*e.fov*Math.PI/180),e.fullWidth&&(n*=e.fullWidth/e.width),n=1/n},computeDistanceToBoxCache:function(e,t){var n=t.clone();return n.applyMatrix4(e),new r(n)},computeMeshSize:function(e){var t=new Set,n=new Set,o=0;e.traverse(function(e){if(e instanceof i&&!t.has(e)){var r;t.add(e);var a=e.mesh3js.geometry;for(r=0;r<a.length;r++){var d,h,l,c=a[r];for(o+=s(c),d=0;d<c.drawingGroups.length;d++){var u;if(h=(l=c.drawingGroups[d]).material?l.material._getTextures():null)for(u=0;u<h.length;u++)h[u]&&n.add(h[u])}}}});var r=0;return n.forEach(function(e){var t=e.image?e.image.width*e.image.height*4:0;r+=t}),o+=r}}}),define("DS/3DXMTiles/DSTilesChildLoader",[],function(){"use strict";return function(){}}),define("DS/3DXMTiles/LODSelector",["DS/Visualization/ThreeJS_DS","UWA/Class"],function(e,t){"use strict";return t.extend({init:function(){this.type=null,this.disableDowngrade=!1},setDisableDowngrade:function(e){this.disableDowngrade=!!e},getMaxLOD:function(){return 1},createJSON:function(e){return(e=e||{}).type=this.type,this.disableDowngrade&&(e.disableDowngrade=!0),e}})}),define("DS/3DXMTiles/OOCPath",[],function(){"use strict";var e=function(e,t){this.ids=[].concat(e),this._ldhReference=t};return e.prototype.isLeaf=function(e){var t=this.getLastId();return e.isLeaf(t)},e.prototype.isRoot=function(){return this.ids.length<=1},e.prototype.getLastId=function(){return this.ids[this.ids.length-1]},e.prototype.expandReference=function(e){var t=e.getInstRefJSON(this.getLastId());t.representation&&(this.ids.push(t.instanceId),this.ids.push(t.representation))},e.prototype.getLastInstanceId=function(){return this.ids.length>=3?this.ids[this.ids.length-2]:null},e.prototype.getParentReferenceId=function(){return this.ids.length>=3?this.ids[this.ids.length-3]:null},e.prototype.isCGR=function(){return-1!==this.ids[this.ids.length-1].indexOf(".cgr")},e.prototype.buildSubPath=function(t,n){var i=new e(this.ids,null);return i.ids.push(t),i.ids.push(n),i},e.buildFromReference=function(t,n,i,o){var r,s=null,a=-1;for(r=0;r<t._occurrences.length;r++){var d=t._occurrences[r];(i||d.viewpointTag!==o.viewpointTag&&(d._screenRadius>a||null===s))&&(a=d._screenRadius,s=d)}if(!s)return console.log("Could not find an occurrence for reference '"+t.referenceId+"'"),null;var h=[t.referenceId];n&&(s.viewpointTag=o.viewpointTag);var l=new e(h,t);return t.children.length>0&&(l.approximate=!0),l},e}),define("DS/3DXMTiles/AsyncCaller",function(){var e=null,t=[];function n(){var e,n;if(t.length>0){for(e=0;e<t.length;e++)(n=t[e])&&n.call(null);t.length=0}}return{call:function(i){t.push(i),null===e&&(e=setInterval(n,33))},multiCall:function(i){i&&(t=t.concat(i),null===e&&(e=setInterval(n,33)))}}}),define("DS/3DXMTiles/LDHReferenceUnloadStatus",[],function(){return{frozen:"frozen",unloadable:"unloadable",unloaded:"unloaded"}}),define("DS/3DXMTiles/UnloadManager",[],function(){"use strict";var e=-2,t=!1,n=window.performance.memory;n&&n.jsHeapSizeLimit>4e9&&(t=!0);var i={v0:{memoryLimitMb:512,memoryLimitGPUMb:512},full:{memoryLimitMb:t?512:256,memoryLimitGPUMb:t?2048:1024},medium:{memoryLimitMb:64,memoryLimitGPUMb:64},medium_plus:{memoryLimitMb:64,memoryLimitGPUMb:128},restricted:{memoryLimitMb:48,memoryLimitGPUMb:32}},o=function(t,n,o){var r,s=(r="string"!=typeof t?t:i[t]).memoryLimitMb,a=r.memoryLimitGPUMb;this.isRestricted="restricted"===t,this.oocManager=o,-2===e&&void 0!==window.OOCUnloadMemoryLimit&&(e=window.OOCUnloadMemoryLimit),this.config=t,this.unloadAlwaysTab=[!1,!1],this.hasUnloadAlways=!1,window.OOCUnloadAlways&&this.setUnloadAlwaysTab([!0,!0]),e>=0&&(s=e,a=e),this.memoryUsage=0,this.memoryUsageMeshInRAM=0,this.memoryUsageGPU=0,this.initialMemoryLimit=1024*s*1024,this.memoryLimit=this.initialMemoryLimit,this.meshInRAMRatio=0,this.memoryLimitMeshInRAM=0,this.memoryLimitGPU=1024*a*1024,this.usage=0,this.usageMeshInRAM=0,this.usageGPU=0,this.memoryPeak=0,this.memoryPeakGPU=0,this.flashMode=!1,this.flashUnload=!1,this.unloadThreshold=.95,this.emergencyUnloadThreshold=1.1,window.debugUnloadManager=this,this.hasMeshInRAM=!1,this.autoMeshInRAMChange=!1,this.autoMeshInRAM="auto"===n,this.meshInRAM="on"===n};return o.prototype.setHasMeshInRam=function(e){e&&!this.hasMeshInRAM&&(this.hasMeshInRAM=!0,this.meshInRAMRatio=.1,this.updateMeshInRAMLimits())},o.prototype.updateMeshInRAMLimits=function(){this.memoryLimitMeshInRAM=Math.floor(this.meshInRAMRatio*this.initialMemoryLimit),this.memoryLimit=this.initialMemoryLimit-this.memoryLimitMeshInRAM},o.prototype.setFlashMode=function(e){this.flashMode=e},o.prototype.tryToRaiseMeshInRAMLimit=function(){if(this.hasMeshInRAM&&.8*this.memoryLimitMeshInRAM<this.memoryUsageMeshInRAM){for(var e=this.meshInRAMRatio;e*this.initialMemoryLimit*.8<this.memoryUsageMeshInRAM&&(1-e)*this.initialMemoryLimit>this.memoryUsage&&e<.9;)e=1-.75*(1-e);this.meshInRAMRatio!==e&&(this.meshInRAMRatio=e,this.updateMeshInRAMLimits())}},o.prototype.restoreMemoryFromMeshInRAM=function(){var e=Math.min(this.memoryUsageMeshInRAM,this.memoryLimitMeshInRAM);0===this.memoryUsageMeshInRAM&&(this.hasMeshInRAM=!1),this.memoryLimit=this.initialMemoryLimit-e,this.memoryLimitMeshInRAM=e,this.meshInRAMRatio=this.memoryLimitMeshInRAM/this.initialMemoryLimit,this.tryToRaiseMeshInRAMLimit()},o.prototype.onReferenceMemoryDataChange=function(e,t,n){this.memoryUsage+=t.memory-e.memory,this.memoryUsageGPU+=t.memoryGPU-e.memoryGPU,(n||this.hasMeshInRAM)&&this.setHasMeshInRam(!0),this.memoryUsageMeshInRAM+=t.memoryMeshInRAM-e.memoryMeshInRAM,this.tryToRaiseMeshInRAMLimit(),this.autoMeshInRAM&&.25*this.initialMemoryLimit<this.memoryUsageMeshInRAM&&(this.autoMeshInRAM=!1,this.autoMeshInRAMChange=!0),this.updateUsage()},o.prototype.beforeLoadedNodesQueueTraversal=function(){this.flashUnload=!1,this.isUnloadNeeded()&&(this.flashUnload=!0,this.autoMeshInRAM&&(this.autoMeshInRAM=!1,this.autoMeshInRAMChange=!0))},o.prototype.afterLoadedNodesQueueTraversal=function(){this.flashUnload=!1},o.prototype.isLoadingAllowed=function(e){return this.tryToRaiseMeshInRAMLimit(),0===e?this.memoryUsageGPU<this.memoryLimitGPU&&(!this.hasMeshInRAM||this.memoryUsageMeshInRAM<this.memoryLimitMeshInRAM):this.memoryUsage<this.getMemoryLimit()},o.prototype.isUnloadSmalNodesRequired=function(){return this.memoryUsage>.9*this.getMemoryLimit()||this.memoryUsageGPU>.9*this.memoryLimitGPU||this.hasMeshInRAM&&this.memoryUsageMeshInRAM>.9*this.memoryLimitMeshInRAM},o.prototype.isEmergencyUnloadRequired=function(e,t){return 0===t?this.isEmergencyUnloadRequiredGPU(e):this.isEmergencyUnloadRequiredCPU(e)},o.prototype.isEmergencyUnloadRequiredCPU=function(e){return e=e||0,this.memoryUsage+e>=this.emergencyUnloadThreshold*this.getMemoryLimit()},o.prototype.isEmergencyUnloadRequiredGPU=function(e){e=e||0;var t=this.memoryUsageGPU+e>=this.emergencyUnloadThreshold*this.memoryLimitGPU;return this.hasMeshInRAM&&(t=t||this.memoryUsageMeshInRAM+e>=this.emergencyUnloadThreshold*this.memoryLimitMeshInRAM),t},o.prototype.isUnloadNeeded=function(e){return!!this.flashUnload||(void 0===e?this.isUnloadNeeded(0)||this.isUnloadNeeded(1):!!this.unloadAlwaysTab[e]||(this.tryToRaiseMeshInRAMLimit(),0===e?this.memoryUsageGPU>.8*this.memoryLimitGPU||this.hasMeshInRAM&&this.memoryUsageMeshInRAM>.8*this.memoryLimitMeshInRAM:this.memoryUsage>.8*this.getMemoryLimit()))},o.prototype.updateUsage=function(){this.usage=100*this.memoryUsage/this.getMemoryLimit(),this.usageGPU=100*this.memoryUsageGPU/this.memoryLimitGPU,this.usageMeshInRAM=100*this.memoryUsageMeshInRAM/this.memoryLimitMeshInRAM,this.memoryPeak=this.memoryUsage>this.memoryPeak?this.memoryUsage:this.memoryPeak,this.memoryPeakGPU=this.memoryUsageGPU>this.memoryPeakGPU?this.memoryUsageGPU:this.memoryPeakGPU},o.prototype.setUnloadAlwaysTab=function(e){this.unloadAlwaysTab=e,this.hasUnloadAlways=e[0]||e[1]},o.prototype.wouldDownloadCauseEmergencyUnload=function(e,t){if(0===t.type&&this.isRestricted){var n=t.getMemorizedReferenceSize(e);return n>=0&&this.isEmergencyUnloadRequired(n,0)}return!1},o.prototype.restoreAutoMeshInRAM=function(){this.autoMeshInRAM=!0,this.autoMeshInRAMChange=!1},o.prototype.getMemoryLimit=function(){return this.oocManager.getUsePickingAccelerationStructure()?this.memoryLimit-.05*this.memoryUsageGPU:this.memoryLimit},o}),define("DS/3DXMTiles/MemoryBudgetManager",[],function(){"use strict";var e=function(e){this.budgets=new Map,this.physicalLimits={cpu:e.initialMemoryLimit,gpu:e.memoryLimitGPU}};function t(e){this.name=e.name,this.memoryBudgetManager=e.memoryBudgetManager,this.physicalBudget=e.physicalBudget,this.currentLimit=0,this.theoreticalLimit=0,this.usage=0,this.active=!1,this.unloadFactor=e.unloadFactor||1,this.maxLimit=e.maxLimit||1/0,this.limitTarget=0,this.weight=e.weight||1,this.unloading=!1}return e.prototype.createBudget=function(e,n,i){var o=new t({name:e,memoryBudgetManager:this,physicalBudget:n,maxLimit:(i=i||{}).maxLimit,weight:i.weight,unloadFactor:i.unloadFactor});return this.budgets.set(e,o),o},e.prototype.getBudget=function(e){return this.budgets.get(e)||null},e.prototype.updateLimits=function(){var e={cpu:0,gpu:0},t={cpu:0,gpu:0};this.budgets.forEach((n,i)=>{if(n.active){var o=n.physicalBudget;e[o]+=n.weight,t[o]+=n.usage}});var n={cpu:this.physicalLimits.cpu-t.cpu,gpu:this.physicalLimits.gpu-t.gpu},i=!1,o={cpu:0,gpu:0};this.budgets.forEach((t,r)=>{if(t.active){var s=t.physicalBudget;t.theoreticalLimit=t.weight*t.memoryBudgetManager.physicalLimits[s]/e[s],t.currentLimit=n[s]<=0?t.theoreticalLimit:t.usage+t.weight*n[s]/e[s],t.currentLimit>t.maxLimit&&(i=!0,o[s]+=t.currentLimit-t.maxLimit,t.currentLimit=t.maxLimit)}else t.theoreticalLimit=0,t.currentLimit=0});for(var r={cpu:0,gpu:0};i;)e.cpu=0,e.gpu=0,r.cpu=o.cpu,r.gpu=o.gpu,o.cpu=0,o.gpu=0,i=!1,this.budgets.forEach((t,n)=>{if(t.active&&t.currentLimit!==t.maxLimit){var i=t.physicalBudget;e[i]+=t.weight}}),this.budgets.forEach((t,n)=>{if(t.active&&t.currentLimit!==t.maxLimit){var s=t.physicalBudget;t.currentLimit+=r[s]*t.weight/e[s],t.currentLimit>t.maxLimit&&(i=!0,o[s]+=t.currentLimit-t.maxLimit,t.currentLimit=t.maxLimit)}})},e.prototype.startUnload=function(){var e=!1,t=!1;this.budgets.forEach((e,n)=>{e.usage>=this.currentLimit&&(t=!0)}),t&&this.updateLimits();var n={cpu:!1,gpu:!1};return this.budgets.forEach((t,i)=>{t.active&&t.isUnloadNeeded()&&(e=!0,n[t.physicalBudget]=!0)}),this.budgets.forEach((e,t)=>{e.unloading=n[e.physicalBudget]}),e},e.prototype.endUnload=function(){this.budgets.forEach((e,t)=>{e.unloading=!1})},e.prototype.isLoadingAllowed=function(){var e=!0;return this.budgets.forEach((t,n)=>{t.isLoadingAllowed()||(e=!1)}),e},e.prototype.getMemoryUsageGPU=function(){var e=0;return this.budgets.forEach((t,n)=>{"gpu"===t.physicalBudget&&(e+=t.usage)}),e},t.prototype.updateUsage=function(e,t){this.active=!0,this.usage+=t-e},t.prototype.isLoadingAllowed=function(){return this.usage<this.currentLimit||(this.active=!0,this.memoryBudgetManager.updateLimits(),this.usage<this.currentLimit)},t.prototype.isUnloadNeeded=function(){return 1!=this.unloadFactor&&this.usage>=this.unloadFactor*this.memoryBudgetManager.physicalLimits[this.physicalBudget]||!this.isLoadingAllowed()},e}),define("DS/3DXMTiles/DSTilesNodeReplaceStatus",[],function(){"use strict";return{onHold:"onHold",commited:"commited",uncommited:"uncommited",reloadParent:"reloadParent"}}),define("DS/3DXMTiles/DSTilesScoreComputer",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=function(){this.tmpBoundingBox=new e.Box3};return t.prototype.getSortingMetric=function(){throw new Error("unimplemented")},t}),define("DS/3DXMTiles/DSTilesRootEntry",[],function(){"use strict";return function(e){this.node=e.node}}),define("DS/3DXMTiles/PriorityQueue",[],function(){"use strict";var e=function(){this.reset()};e.prototype.reset=function(){this.tileNode=null,this.parent=null,this.less=null,this.more=null},e.prototype.check=function(){var e=[];!function t(n){e.indexOf(n)>-1?console.log("argl"):(e.push(n),n.less&&t(n.less),n.more&&t(n.more))}(this)},e.prototype.checkMinMax=function(e,t){var n=!0;return this.tileNode&&(this.tileNode.getScore()<e||this.tileNode.getScore()>t)&&(console.log("ERRRRRRRRRRREUUUUUUR"),n=!1),this.less&&!this.less.checkMinMax(e,t)&&(n=!1),this.more&&!this.more.checkMinMax(e,t)&&(n=!1),n},e.prototype.removeMin=function(e){var t=this.less;null!==t&&(null===t.less?(this.less=t.more,null!==this.less&&(this.less.parent=this),e.releaseHeapNode(t)):t.removeMin(e))},e.prototype.removeMax=function(e){var t=this.more;null!==t&&(null===t.more?(this.more=t.less,null!==this.more&&(this.more.parent=this),e.releaseHeapNode(t)):t.removeMax(e))},e.prototype.insert=function(e){e.tileNode.getScore()<this.tileNode.getScore()?null!==this.less?this.less.insert(e):(this.less=e,e.parent=this):null!==this.more?this.more.insert(e):(this.more=e,e.parent=this)},e.prototype.getMin=function(){return null===this.less?this:this.less.getMin()},e.prototype.getMax=function(){return null===this.more?this:this.more.getMax()},e.prototype.getTileNodes=function(e){null!==this.tileNode&&e.push(this.tileNode),this.more&&this.more.getTileNodes(e),this.less&&this.less.getTileNodes(e)};var t=function(e){this.size=0,this.sizeLimit=e,this.root=null,this.firstFreeHeapNode=null,this.minHeapValue=-1/0,this.maxHeapValue=1/0};t.prototype.getTileNodes=function(){var e=[];return null!==this.root&&this.root.getTileNodes(e),e},t.prototype.tryToInsertTileNodeMax=function(e,t,n){if(this.size<this.sizeLimit){if(!n||this.minHeapValue<e.getScore()){this.insert(e),t.min=null;var i=this.root.getMin();return this.minHeapValue=i.tileNode.getScore(),!0}return!1}if(this.minHeapValue<e.getScore()){i=this.root.getMin();t.min=i.tileNode,this.insert(e),null!==i.parent?i.parent.removeMin(this):this.setRoot(i.more),this.size--;var o=this.root.getMin();return this.minHeapValue=o.tileNode.getScore(),!0}return!1},t.prototype.tryToInsertTileNodeMin=function(e,t,n){if(this.size<this.sizeLimit){if(!n||this.maxHeapValue>e.getScore()){this.insert(e),t.max=null;var i=this.root.getMax();return this.maxHeapValue=i.tileNode.getScore(),!0}return!1}if(this.maxHeapValue>e.getScore()){i=this.root.getMax();t.max=i.tileNode,this.insert(e),null!==i.parent?i.parent.removeMax(this):this.setRoot(i.less),this.size--;var o=this.root.getMax();return this.maxHeapValue=o.tileNode.getScore(),!0}return!1},t.prototype.setRoot=function(e){null!==this.root&&this.releaseHeapNode(this.root),this.root=e,null!==e&&(e.parent=null)},t.prototype.getAndRemoveMaxTileNode=function(){var e=this.root.getMax(),t=e.tileNode;return this.removeMaxHeapNode(e),t},t.prototype.removeMaxHeapNode=function(e){null!==e.parent?e.parent.removeMax(this):this.setRoot(e.less),this.size--},t.prototype.removeMinHeapNode=function(e){null!==e.parent?e.parent.removeMin(this):this.setRoot(e.more),this.size--},t.prototype.getAndRemoveMinTileNode=function(){var e=this.root.getMin(),t=e.tileNode;return this.removeMinHeapNode(e),t},t.prototype.getMinHeapNode=function(){return null!==this.root?this.root.getMin():null},t.prototype.getMaxHeapNode=function(){return null!==this.root?this.root.getMax():null},t.prototype.insert=function(e){var t=this.getHeapNode(e);null===this.root?this.setRoot(t):this.root.insert(t),this.size++},t.prototype.getHeapNode=function(t){var n;return this.firstFreeHeapNode?(n=this.firstFreeHeapNode,this.firstFreeHeapNode=n.more,n.reset()):n=new e,n.tileNode=t,n},t.prototype.releaseHeapNode=function(e,t){e.less=null,t&&t(e.tileNode),e.tileNode=null,e.more=this.firstFreeHeapNode,this.firstFreeHeapNode=e},t.prototype.releaseHeapNodeTree=function(e,t,n){null!==e.less&&(this.releaseHeapNodeTree(e.less,t+1,n),e.less=null),null!==e.more&&(this.releaseHeapNodeTree(e.more,t+1,n),e.more=null),this.releaseHeapNode(e,n)},t.prototype.reset=function(e){null!==this.root&&(this.releaseHeapNodeTree(this.root,0,e),this.root=null,this.minHeapValue=-1/0),this.size=0};var n=0,i=function(e){this.id=n++,this.nodeList=[],this.nbProcessedNodes=0,this.nodeListLength=0,this.listWasUpdated=!1,this.maxHeapNode=null,this.minHeapNode=null,this.negativeNodes=[],this.heap=new t(e||100)};i.prototype.fillHeapMax=function(e){var t,n,i,o={min:null},r=this.nodeListLength,s=this.heap,a=0,d=e?0:this.nbProcessedNodes;for(i=d;i<r;i++)null!==(t=this.nodeList[i])&&t.isAlive()?t.getScore()<0?(this.negativeNodes.push(t),this.nodeList[i]=null,a++):s.tryToInsertTileNodeMax(t,o,0!==d)&&(n=o.min,this.nodeList[i]=n,null===n&&a++):a++;this.nbProcessedNodes=i,a>=this.nodeListLength?(this.nodeListLength=0,this.nbProcessedNodes=0):a>200&&this.cleanNulls(!0)},i.prototype.fillHeapMin=function(e){var t,n,i,o={max:null},r=this.nodeListLength,s=this.heap,a=0,d=e?0:this.nbProcessedNodes;for(i=d;i<r;i++)null!==(t=this.nodeList[i])&&t.isAlive()?t.getScore()<0?(this.negativeNodes.push(t),this.nodeList[i]=null,a++):s.tryToInsertTileNodeMin(t,o,0!==d)&&(n=o.max,this.nodeList[i]=n,null===n&&a++):a++;this.nbProcessedNodes=i,a>=this.nodeListLength?(this.nodeListLength=0,this.nbProcessedNodes=0):a>200&&this.cleanNulls(!0)},i.prototype.getMaxNodeWithNoHeap=function(){if(null!==this.heap.root)throw new Error("Heap not empty");var e,t=this.nodeListLength,n=-1,i=-1/0,o=null,r=0;for(e=0;e<t;e++)null!==(o=this.nodeList[e])&&o.isAlive()?o.getScore()>i&&(n=e,i=o.getScore()):r++;return n>-1?(o=this.nodeList[n],this.nodeList[n]=null):o=null,r>=this.nodeListLength?this.nodeListLength=0:r>200&&this.cleanNulls(!1),o},i.prototype.peekMaxNode=function(){if(!this.maxHeapNode){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1);var e=null;this.heap.size>0?e=this.heap.root.getMax():this.negativeNodes.length>0&&(e=this.negativeNodes[this.negativeNodes.length-1]),this.maxHeapNode=e}return this.maxHeapNode?this.maxHeapNode.tileNode:null},i.prototype.peekMinNode=function(){if(!this.minHeapNode){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var e=null;this.heap.size>0&&(e=this.heap.root.getMin()),this.minHeapNode=e}return this.minHeapNode?this.minHeapNode.tileNode:null},i.prototype.removeMaxHeapNode=function(e){this.heap.removeMaxHeapNode(e)},i.prototype.getMaxNode=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1);var t=null;return this.heap.size>0?t=e?this.heap.getAndRemoveMaxTileNode():this.heap.getMaxNode():this.negativeNodes.length>0&&(t=this.negativeNodes.pop()),t},i.prototype.getMinNode=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var t=null;return this.negativeNodes.length>0?t=this.negativeNodes.pop():this.heap.size>0&&(t=e?this.heap.getAndRemoveMinTileNode():this.heap.getMinNode()),t},i.prototype.checkIntegrity=function(e){var t,n=-1/0,i=1/0;if(this.heap.size>0)for(n=this.heap.root.getMin().tileNode.getScore(),i=this.heap.root.getMax().tileNode.getScore(),this.heap.root.checkMinMax(n,i)||console.log("checkMinMax has failed!!!"),t=0;t<(void 0!==e?e:this.nodeListLength);t++)this.nodeList[t]&&this.nodeList[t].getScore()>n&&console.log("found probleme!!!")},i.prototype.getMinNodeWithNoHeap=function(){if(null!==this.heap.root)throw new Error("Heap not empty");var e,t=this.nodeListLength,n=-1,i=1/0,o=null,r=0;for(e=0;e<t;e++)null!==(o=this.nodeList[e])&&o.isAlive()?o.getScore()<i&&(n=e,i=o.getScore()):r++;return n>-1?(o=this.nodeList[n],this.nodeList[n]=null):o=null,r>=this.nodeListLength?this.nodeListLength=0:r>200&&this.cleanNulls(!1),o},i.prototype.cleanNulls=function(e){var t,n=this.nodeListLength,i=null,o=0;for(t=0;t<n;t++)null!==(i=this.nodeList[t])&&i.isAlive()?(this.nodeList[o]=i,o++):e&&t<this.nbProcessedNodes&&this.nbProcessedNodes--;this.nodeListLength=o,this.nodeList.length=this.nodeListLength},i.prototype.isEmpty=function(){return 0===this.heap.size&&0===this.nodeListLength&&0===this.negativeNodes.length},i.prototype.clear=function(e){var t;if(this.heap.reset(e),e)for(t=0;t<this.nodeListLength;t++)this.nodeList[t]&&e(this.nodeList[t]);this.nodeListLength=0,this.nbProcessedNodes=0,this.maxHeapNode=null,this.minHeapNode=null},i.prototype.resetOrder=function(e){var t,n=this.heap.getTileNodes();for(this.heap.reset(),t=0;t<n.length;t++)this.addNode(n[t]);for(t=0;t<this.negativeNodes.length;t++)this.addNode(this.negativeNodes[t]);if(this.negativeNodes.length=0,e){var i,o=0;for(t=0;t<this.nodeListLength;t++)(i=this.nodeList[t])&&e(i)&&(this.nodeList[o]=i,o++);this.nodeListLength=o}};var o=0;function r(e,t,n,i){if(i<=1)e[i-1]=t;else{var r=(a=o+=1831565813,a=Math.imul(a^a>>>15,1|a),(((a^=a+Math.imul(a^a>>>7,61|a))^a>>>14)>>>0)%(i-n)),s=n+(r=r<0?r+(i-n):r);isFinite(s)||(s=i-1),s>=i-1?e[i-1]=t:(e[i-1]=e[s],e[s]=t)}var a}return i.prototype.addNode=function(e,t){this.nodeListLength>=this.nodeList.length?(this.nodeList.push(null),this.nodeListLength=this.nodeList.length):this.nodeList[this.nodeListLength++]=null,t?this.nodeList[this.nodeListLength-1]=e:r(this.nodeList,e,this.nbProcessedNodes,this.nodeListLength),this.listWasUpdated=!0},i.prototype.peekMinHeapNode=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1),this.heap.getMinHeapNode()},i.prototype.peekMaxHeapNode=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1),this.heap.getMaxHeapNode()},i.prototype.traverseMin=function(e){var t,n,i;for((0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1),t=this.negativeNodes.length-1;t>=0;t--){if(!e(this.negativeNodes[t]))return;this.negativeNodes.length--}do{i=!0,null!==(n=this.peekMinHeapNode())&&e(n.tileNode)&&(this.heap.removeMinHeapNode(n),i=!1)}while(!i)},i.prototype.traverseMinPlus=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var t,n,i,o,r,s=[];function a(){i=!0}function d(){n=!0}for(n=!1,o=this.negativeNodes.length-1;o>=0&&!n;o--)r=this.negativeNodes[o],i=!1,n=!1,e(r,d,a),this.negativeNodes.length--,i&&s.push(r);for(;!n;)n=!1,i=!1,null!==(t=this.peekMinHeapNode())?(e(t.tileNode,d,a),n&&i||(i&&s.push(t.tileNode),this.heap.removeMinHeapNode(t))):n=!0;for(o=0;o<s.length;o++)this.addNode(s[o],!0)},i.prototype.traverseMax=function(e){var t,n;do{n=!0,null!==(t=this.peekMaxHeapNode())&&e(t.tileNode)&&(this.heap.removeMaxHeapNode(t),n=!1)}while(!n)},i.prototype.traverseMaxPlus=function(e){var t,n,i,o,r=[];function s(){i=!0}function a(){n=!0}do{n=!1,i=!1,null!==(t=this.peekMaxHeapNode())?(e(t.tileNode,a,s),n&&i||(i&&r.push(t.tileNode),this.heap.removeMaxHeapNode(t))):n=!0}while(!n);for(o=0;o<r.length;o++)this.addNode(r[o],!0)},i.prototype.removeNode=function(e){var t;for(this.resetOrder(),t=0;t<this.nodeListLength;t++)this.nodeList[t]===e&&(this.nodeList[t]=null)},i.prototype.getAllNodes=function(){var e,t,n=[];for(t=0;t<this.nodeListLength;t++)(e=this.nodeList[t])&&n.push(e);var i=this.heap.getTileNodes();return n.concat(i)},i.prototype.getMaxNodes=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1),this.heap.getTileNodes()},i.prototype.getSize=function(){return this.cleanNulls(),this.nodeListLength+this.heap.size},i}),define("DS/3DXMTiles/OOCInstanceIterator",[],function(){"use strict";var e=function(e,t){this._referenceIterator=e,this._childData=t};return e.prototype.getReferenceIterator=function(){return this._referenceIterator},e.prototype.getInstanceId=function(){return this._childData.instanceId},e.prototype.getMatrix=function(){var e=this._childData.matrix;return e&&e.clone()},e.prototype.getNode=function(){return this._childData.node},e}),define("DS/3DXMTiles/Debug3DXMTiles",[],function(){var e=-1;return window.OOCGetProbes=function(){var e=-1,t=[];return measures=window.top.performance.getEntriesByType("measure"),measures=measures.concat(window.top.performance.getEntriesByType("mark")),measures.forEach(function(n){-1===e&&(e=n.startTime),"measure"===n.entryType?t.push({name:n.name,duration:n.duration,startTime:n.startTime-e,entryType:n.entryType}):t.push({name:n.name,startTime:n.startTime-e,entryType:n.entryType})}),t},{setSceneGraphMode:function(e){if("flat"===e)this.sceneGraphMode=0;else{if("dual"!==e)throw new Error("Unknown mode");this.sceneGraphMode=1}},sceneGraphMode:1,configs:{1:{modelDir:"../airbus/assets/airbusnew4/",instrefDir:"../airbus/assets/instref2/",assetsDir:"../airbus/assets/",toReplace:[],root:"XWB-A350-900-RR.instref"},2:{modelDir:"../airbus2/assets/3DXM/",instrefDir:"../airbus2/assets/InstRef/",assetsDir:"../airbus2/assets/",toReplace:["../airbus2/assets/NewCGRs/"],root:"XWB-A350-900-RR.instref"},3:{modelDir:"../airbus3/3dxm/",instrefDir:"../airbus3/instref216/",assetsDir:"../airbus3/",toReplace:["../airbus3/CGR/A350DEVP/","../airbus3/CGR/COMEQLIB/","../airbus3/CGR/A350DEFN/","../airbus3/CGR/COMSTLIB/"],root:"A350.instref"},4:{modelDir:"../airbus3/CGR/",instrefDir:"../airbus3/instref216/",assetsDir:"../airbus3/",toReplace:["../airbus3/CGR/"],root:"A350.instref",cgr:!0},5:{modelDir:"../airbus3/3dxm/",instrefDir:"../airbus3/instref216/",assetsDir:"../airbus3/",toReplace:["../airbus3/CGR/A350DEVP/","../airbus3/CGR/COMEQLIB/","../airbus3/CGR/A350DEFN/","../airbus3/CGR/COMSTLIB/"],toReplaceAV1:"../airbus3/3dxm/",root:"A350.instref"}},probePrefix:"WebVisuOOC_",probeMap:new Map,probeIndex:0,startProbe:function(t){if(-1===e&&(e=window.OOCProbes?1:0),1===e){var n=this.probePrefix+t+"_"+this.probeIndex;this.probeIndex++,this.probeMap.set(t,n),window.top.performance.mark(n+"_begin")}},endProbe:function(t){if(1===e){var n=this.probeMap.get(t);this.probeMap.delete(t);var i=n+"_end";window.top.performance.mark(i);var o=n+"_begin";window.top.performance.measure(this.probePrefix+t,o,i)}}}}),define("DS/3DXMTiles/DSTilesConstantScoreComputer",[],function(){"use strict";var e=function(e){this.score=e.score||0,this.pixelError=e.pixelError||0};return e.prototype.computeScore=function(e,t,n){e.score=this.score,n&&(e.pixelError=this.pixelError)},e}),define("DS/3DXMTiles/LDHStats",[],function(){"use strict";var e={startNbLoadedModels:0,nbLoadedModels:0,startTime:0,nbBatches:0,bytesLoaded:0,history:[],occlusion:0,batchSize:0,flags:[],firstLoadTime:-1,endLoadingTime:-1,tts:-1,ttsTime:-1,onStartCGRLoading:function(){-1===this.firstLoadTime&&(this.firstLoadTime=Date.now())},init:function(){var e=window.localStorage.getItem("TileModelPreloadData");if(this.tts=-1,e){var t=JSON.parse(e);t.tts&&(this.tts=parseInt(t.tts))}0===this.startTime&&(this.startTime=Date.now(),this.history.push({time:this.startTime,nbLoadedModels:0,bytesLoaded:0}))},onNewViewpoint:function(){this.startNbLoadedModels=this.nbLoadedModels,this.firstLoadTime=-1,this.endLoadingTime=-1,this.ttsTime=-1},onEndLoading:function(){this.endLoadingTime=Date.now()},addFlag:function(e){this.flags.push(e)},onOcclusion:function(){this.occlusion++},computeInstantStats:function(){var e,t=Date.now(),n=0;for(e=0;e<this.history.length;e++)t-this.history[e].time>2e3&&(n=e);n>0&&this.history.splice(0,n);var i=this.history[0],o={mps:1e3*(this.nbLoadedModels-this.startNbLoadedModels)/(t-this.startTime),imps:(this.nbLoadedModels-i.nbLoadedModels)/(t-i.time)*1e3,batches:this.nbBatches,batchSize:this.nbBatches>0?this.batchSize/this.nbBatches:0,mbps:8e3*(this.bytesLoaded-i.bytesLoaded)/(1048576*(t-i.time)),occlusion:this.occlusion,flags:this.flags,modelLoadingTime:-1!==this.startLoadTime&&-1!==this.endLoadingTime?(this.endLoadingTime-this.firstLoadTime)/1e3:-1,ttsTime:this.ttsTime,firstLoadTime:this.firstLoadTime};return this.history.push({time:t,nbLoadedModels:this.nbLoadedModels,bytesLoaded:this.bytesLoaded}),o},onLoadedModel:function(e){e&&(this.bytesLoaded+=e),this.nbLoadedModels++,this.nbLoadedModels-this.startNbLoadedModels>=this.tts&&this.ttsTime<0&&(this.ttsTime=Date.now())},onStartBatch:function(e){this.nbBatches++,this.batchSize+=e},onEndBatch:function(e){this.nbBatches--,this.batchSize-=e}};return window.modelLoaderPoolStats=e,e}),define("DS/3DXMTiles/DSTilesChildLink",[],function(){"use strict";return function(){}}),define("DS/3DXMTiles/DSTilesNodeMemorySize",[],function(){"use strict";return function(e,t){this.memory=e||0,this.memoryGPU=t||0,this.memoryMeshInRAM=0}}),define("DS/3DXMTiles/ModelBank",["DS/QualityManager/QMController"],function(e){"use strict";var t=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB,n=function(){this.timeLimitDays=7,this.refreshTimeDays=1,this.debugData=window.ModelBank_debug_init,this.db=null,this.nbTickets=100,this.queue=[];var n=this;this.referenceSet=new Set,this.metaMap=new Map,this.maxSize=1024*e.getLocalCacheSize()*1024,this.size=0,this.debugData&&(void 0!==this.debugData.timeLimitDays&&(this.timeLimitDays=this.debugData.timeLimitDays),void 0!==this.debugData.refreshTimeDays&&(this.refreshTimeDays=this.debugData.refreshTimeDays),void 0!==this.debugData.maxSize&&(this.maxSize=this.debugData.maxSize));var i=t.open("modelsDBLocal",2);i.onerror=function(e){console.log("error creating/accessing models database"),t.deleteDatabase("modelsDBLocal")},i.onsuccess=function(e){n.db=i.result;var t=n.db.transaction(["models","meta"],"readonly");t.objectStore("models").getAllKeys().onsuccess=function(e){var t;if(e.target.result)for(t=0;t<e.target.result.length;t++)n.referenceSet.add(e.target.result[t])},t.objectStore("meta").openCursor().onsuccess=function(e){var t,i=e.target.result;i?(void 0!==i.key&&(t=i.value,n.metaMap.set(i.key,t),n.size+=t.size||0),i.continue()):(n.debugData&&n.debugData.beforeCheckSizeCB&&n.debugData.beforeCheckSizeCB(n),n.removeOldData(),n.checkSize())},n.db.onerror=n.onDbError.bind(n)},i.onupgradeneeded=function(e){var t,n;t=e.target.result,n=e.oldVersion,console.log("Updating objectstore"),n<1&&t.createObjectStore("models"),n<2&&t.createObjectStore("meta")}};n.prototype.onDbError=function(e){console.log("Db error")},n.prototype.removeOldData=function(){window.ModelBank_debug_init&&(window.ModelBank_debug_init.referenceSetSize=this.referenceSet.size,window.ModelBank_debug_init.metaMapSize=this.metaMap.size);var e=[],t=Date.now()-24*this.timeLimitDays*60*60*1e3;this.metaMap.forEach(function(n,i,o){n.time<t&&e.push(i)}),this.removeKeys(e)},n.prototype.removeKeys=function(e){if(e.length>0){var t,n,i,o,r=this.db.transaction(["models","meta"],"readwrite");for(n=0;n<e.length;n++)i=e[n],(t=this.metaMap.get(i))&&(this.size-=t.size),this.referenceSet.delete(i),this.metaMap.delete(i),r.objectStore("models").delete(i),o=r.objectStore("meta").delete(i),this.debugData&&this.debugData.onRemoveKeysCB&&(o.onsuccess=this.debugData.onRemoveKeysCB.bind(null,this))}},n.prototype.buildKey=function(e,t,n){return e+t.substring(7)+"@"+n},n.prototype.storeModelData=function(e,t,n,i,o){if(this.db)for(var r=this.db.transaction(["models","meta"],"readwrite"),s=0;s<e.length;++s){var a=t[s],d=e[s],h=this.buildKey(d,a,n);if(!this.referenceSet.has(h)){var l={time:Date.now(),wms:o[s],size:i[s].byteLength};r.objectStore("models").put(i[s],h),r.objectStore("meta").put(l,h),this.referenceSet.add(h),this.metaMap.set(h,l)}}},n.prototype.retrieveModelData=function(e,t,n,o,r,s){var a,d,h,l=[];if(!this.db)for(a=0;a<e.length;a++)setTimeout(s.bind(null,e[a]),0);var c=Date.now()-24*this.refreshTimeDays*60*60*1e3;for(a=0;a<e.length;++a){var u=e[a],p=e[a].referenceId;h=this.buildKey(p,t[a],n),(d=this.metaMap.get(h)).time<c&&l.push(h)}var f=0===l.length?this.db.transaction(["models"],"readonly"):this.db.transaction(["models","meta"],"readwrite");for(a=0;a<e.length;++a){u=e[a],p=e[a].referenceId;h=this.buildKey(p,t[a],n);var g=f.objectStore("models").get(h);g.onsuccess=function(e,t){return function(n){var i=n.target.result;o.onModelBankData(e,r,s,i||null,t)}}(u,h),g.onerror=function(e,t){return function(){i.removeKeys([t])}}(0,h)}var m=Date.now();for(a=0;a<l.length;a++)h=l[a],(d=this.metaMap.get(h))&&(d.time=m,f.objectStore("meta").put(d,h))},n.prototype.hasModelData=function(e,t,n,i){var o=this.buildKey(e,t,n),r=!1;if(this.referenceSet.has(o)){var s=this.metaMap.get(o);if(i&&s&&s.wms===i&&(r=!0),!r){this.referenceSet.delete(o),this.metaMap.delete(o);var a=this.db.transaction(["models","meta"],"readwrite");a.objectStore("models").delete(o),a.objectStore("meta").delete(o)}}return r},n.prototype.clear=function(){if(this.db){var e=this.db.transaction(["models","meta"],"readwrite");e.objectStore("models").clear(),e.objectStore("meta").clear(),this.referenceSet.clear(),this.metaMap.clear()}},n.prototype.checkSize=function(){if(this.maxSize>=0&&this.size>this.maxSize){var e=Array.from(this.metaMap);e.sort(function(e,t){return e[1].time-t[1].time});var t,n=.8*this.maxSize,i=this.size,o=[];for(t=0;t<e.length&&i>n;t++)i-=e[t][1].size||0,o.push(e[t][0]);this.removeKeys(o)}};var i=new n;return i}),define("DS/3DXMTiles/DSTilesNodeStatus",[],function(){"use strict";return{waiting:"waiting",toLoad:"toLoad",loading:"loading",loaded:"loaded",error:"error",dead:"dead"}}),define("DS/3DXMTiles/ModelLoaderSingleton",["DS/Visualization/ModelLoader","DS/VisuLoaders/ThreeDXLoader"],function(e,t){"use strict";var n=function(){this.nbLoading=0,this.maxNbLoading=1,this.modelLoader=null,this.threeDXLoader=null};return n.prototype.isReady=function(){return this.nbLoading<this.maxNbLoading},n.prototype.loadFromBuffer=function(e,t,n,i,o){if(null!==e)switch((n=n||"cgr").toLowerCase()){case"3dxc":return this.load3DX.apply(this,arguments);default:return this.loadGeneric.apply(this,arguments)}else setTimeout(i,0)},n.prototype.createModelLoader=function(){var t=new e;return t.setKeepLoaderMode(!0),t.sharedBuffers=!1,t},n.prototype.createThreeDXLoader=function(){return new t},n.prototype.load3DX=function(e,t,n,i,o){var r=new Blob([e]),s=URL.createObjectURL(r),a=this.threeDXLoader;a||(a=this.createThreeDXLoader(),this.threeDXLoader=a),this.nbLoading++;var d=!1,h=!1;a.load({url:s,destinationNode:t,zipped:!1,concat:!0,doneCallback:e=>{h=!0,(0===e.nbTextures||d)&&(this.nbLoading--,i())},onTexturesLoadedCallback:e=>{d=!0,h&&(this.nbLoading--,i())},errorCallback:()=>{this.nbLoading--,o()}})},n.prototype.loadGeneric=function(e,t,n,i,o){var r=this.modelLoader;r||(r=this.createModelLoader(),this.modelLoader=r),this.nbLoading++,r.setSceneGraph(t),r.setFileType(n);var s=this;r.setOnLoadedProductStructureCallback(function(e){s.nbLoading--,r.setTargetNode(null),i()}),r.setOnErrorCallback(function(){s.nbLoading--,r.setTargetNode(null),o()});r.loadModelFromBuffer(e,t,{})},new n}),define("DS/3DXMTiles/DSTilesWorldPosition",["DS/Visualization/ThreeJS_R57"],function(e){"use strict";var t=function(){this.matrixArray=[null],this.inverseMatrixArray=[null],this.inverseMatrixUpToDate=!1};return t.prototype.setFromOccurrences=function(t,n){var i,o;for(this.matrixArray.length=t.length,this.inverseMatrixArray.length=t.length,i=0;i<t.length;i++)(o=new e.Matrix4).copy(t[i].matrix),n&&o.multiplyMatrices(o,n),this.matrixArray[i]=o;this.inverseMatrixUpToDate=!1},t.prototype.update=function(t){var n,i=t.parent&&t.parent.worldPosition;for(i&&(this.matrixArray.length=i.matrixArray.length,this.inverseMatrixArray.length=i.matrixArray.length),this.inverseMatrixUpToDate=!1,n=0;n<this.matrixArray.length;n++){var o;o=i&&i.matrixArray[n],t.matrix?o?(this.matrixArray[n]=new e.Matrix4,this.matrixArray[n].multiplyMatrices(o,t.matrix)):this.matrixArray[n]=t.matrix:this.matrixArray[n]=o,this.inverseMatrixArray[n]=null}},t.prototype.updateInverseMatrix=function(t){if(!this.inverseMatrixUpToDate){var n,i=t.parent;for(n=0;n<this.matrixArray.length;n++){var o=this.matrixArray[n];i&&i.worldPosition.matrixArray[n]===o&&(i.worldPosition.updateInverseMatrix(i),r=i.worldPosition.inverseMatrixArray[n]);var r=new e.Matrix4;o&&r.getInverse(o),this.inverseMatrixArray[n]=r}}this.inverseMatrixUpToDate=!0},t.prototype._getInverseMatrix=function(e){return this.inverseMatrixUpToDate||this.updateInverseMatrix(e),this.inverseMatrixArray[0]},t}),define("DS/3DXMTiles/LDHSwitchRepresentationData",[],function(){"use strict";var e=function(e){this.rep=e,this.onSwitchRepCBArray=null};return e.prototype.setRep=function(e){this.rep=e},e.prototype.addOnSwitchRepCB=function(e){e&&(null===this.onSwitchRepCBArray&&(this.onSwitchRepCBArray=[]),this.onSwitchRepCBArray.push(e))},e}),define("DS/3DXMTiles/DSTilesContent",[],function(){"use strict";var e=function(){};return e.prototype.addToHSO=function(e){},e}),define("DS/3DXMTiles/LDHReferenceStatus",[],function(){return{loading:"loading",loaded:"loaded",toLoad:"toLoad",toUnload:"toUnload",freezeUnload:"freezeUnload",dead:"dead",waiting:"waiting",error:"error"}}),define("DS/3DXMTiles/DSTilesR2VOctree",[],function(){"use strict";function e({tileNode:e}){this.root=new n({tileNode:e,cellCoords:new t(0,0,0,0),tree:this,parent:null})}function t(e,t,n,i){this.x=e,this.y=t,this.z=n,this.depth=i}function n({tileNode:e,cellCoords:t,tree:n,parent:i}){this.tree=n,this.cellCoords=t,this.tileNode=e,this.children=null,this.childCount=0,this.maxDepth=0,this.parent=i||null}return e.prototype.getSizeData=function(){var e=this.getMaxDepth(),t=Math.pow(2,e),n=new Float32Array(t*t*t);return this.root.writeDataToBuffer_traverse(n,e),n},e.prototype.getMaxDepth=function(){return this.root.maxDepth},e.prototype.addTileNode=function(e,t){if(e!==this.root.tileNode){var n=this.root.getTileNodeCellCoords(e,t);this.root.addTileNode(e,n)}},e.prototype.removeTileNode=function(e,t){if(e!==this.root.tileNode){var n=this.root.getTileNodeCellCoords(e,t);this.root.removeTileNode(e,n)}},n.prototype.getTileNodeCellCoords=function(e,n){var i=this.tileNode.getBoundingBox(),o=Math.pow(2,n),r=(i.max.x-i.min.x)/o,s=(i.max.y-i.min.y)/o,a=(i.max.z-i.min.z)/o,d=e.getBoundingBox(),h=(d.max.x+d.min.x)/2,l=(d.max.y+d.min.y)/2,c=(d.max.z+d.min.z)/2;return new t(Math.floor((h-i.min.x)/r),Math.floor((l-i.min.y)/s),Math.floor((c-i.min.z)/a),n)},t.prototype.buildChildCoords=function(e){var n=e%2,i=2&e?1:0,o=4&e?1:0;return new t((this.x<<1)+n,(this.y<<1)+i,(this.z<<1)+o,this.depth+1)},n.prototype.writeDataToBuffer_traverse=function(e,t){var n,i;if(this.tileNode&&this.writeDataToBuffer(e,t),this.children)for(n=0;n<this.children.length;n++)(i=this.children[n])&&i.writeDataToBuffer_traverse(e,t)},n.prototype.writeDataToBuffer=function(e,t){var n,i,o,r=this.tileNode.geometricalError,s=Math.pow(2,t-this.cellCoords.depth),a=s*this.cellCoords.x,d=s*this.cellCoords.y,h=s*this.cellCoords.z,l=Math.pow(2,t),c=l*l-s*s,u=l-s,p=a+l*d+l*l*h;for(o=0;o<s;o++){for(i=0;i<s;i++){for(n=0;n<s;n++)e[p]=r,p++;p+=u}p+=c}return r},n.prototype.getChildIndex=function(e){var t=Math.pow(2,e.depth-this.cellCoords.depth);return Math.floor(2*(e.x/t-this.cellCoords.x))+(Math.floor(2*(e.y/t-this.cellCoords.y))<<1)+(Math.floor(2*(e.z/t-this.cellCoords.z))<<2)},n.prototype.addTileNode=function(e,t){var i=this.getChildIndex(t);this.children||(this.children=[null,null,null,null,null,null,null,null]),t.depth===this.cellCoords.depth+1?(this.children[i]?this.children[i].tileNode=e:(this.children[i]=new n({tileNode:e,cellCoords:t,tree:this.tree,parent:this}),this.childCount++),this.updateMaxDepth()):(this.children[i]||(this.children[i]=new n({tileNode:null,cellCoords:this.cellCoords.buildChildCoords(i),tree:this.tree,parent:this}),this.childCount++),this.children[i].addTileNode(e,t))},n.prototype.removeTileNode=function(e,t){if(this.children){var n=this.getChildIndex(t),i=this.children[n];i&&(t.depth===this.cellCoords.depth+1?i.tileNode=null:i.removeTileNode(e,t),0!==i.childCount||i.tileNode||(this.children[n]=null,this.childCount--,0===this.childCount&&(this.children=null),this.updateMaxDepth()))}},n.prototype.updateMaxDepth=function(){var e,t,n=0;if(this.children)for(e=0;e<this.children.length;e++)(t=this.children[e])&&t.maxDepth+1>n&&(n=t.maxDepth+1);n!==this.maxDepth&&(this.maxDepth=n,this.parent&&this.parent.updateMaxDepth())},e}),define("DS/3DXMTiles/LDHHandler",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";var n=function(e){this.type=e};n.prototype.handleReferences=function(e,t){},n.prototype.getBatchSize=function(){return 1},n.prototype.setRestricted=function(){},n.prototype.isReady=function(){return!1};var i=function(e){this.maxSize=e,this.references=[]};i.prototype.containsReference=function(e){return this.references.indexOf(e.referenceId)>=0},i.prototype.addReferenceIfPossible=function(e){return this.references.length<this.maxSize&&(this.references.push(e),!0)},i.prototype.isEmpty=function(){return 0===this.references.length},i.prototype.getSize=function(){return this.references.length},i.prototype.setReferencesLoading=function(e){var t,n,i=this.references;for(t=0;t<i.length;t++)(n=i[t]).isLoading()||n.setLoading(e)},n.prototype.handleBatch=function(e,t){this.handleReferences(e.references,t)},n.prototype.createBatch=function(){return new i(this.getBatchSize())},n.prototype.acceptsRepresentation=function(e,t){return!0},n.prototype.commitModelLoadedTransaction=function(e,t,n){var i=e.getActiveRepresentation();n&&n.nodes&&e.setCGRNodeNames(n.nodes,i);var o=t._ldhNodeManager;e.referenceId;e.showActiveRepresentation(o),e.setRepLoaded(!0),e.isAlive()&&o.onLeafReferenceLoadedCB&&o.onLeafReferenceLoadedCB(e.referenceId,n),i.updateMeshSize(e),e.updateMemorySizeNEW(o),t._startModelLoaderTransaction(),t._onRepLoaded(e),t.endInstRefGraphTransaction()};var o={red:new e.MeshPhongMaterial({color:"#ffaaaa"}),green:new e.MeshPhongMaterial({color:"#aaffaa"})},r="ON"===window.localStorage.getItem("OOCColorMode");return n.prototype.dbgSetupNodes=function(e,t){if(r&&e){var n,i=o[t];for(n=0;n<e.length;n++)e[n].traverse(function(e){if("Mesh3D"===e.getNodeType()&&e.mesh3js)for(var t=0;t<e.mesh3js.geometry.length;t++)for(var n=e.mesh3js.geometry[t],o=0;o<n.drawingGroups.length;o++){var r=n.drawingGroups[o];4===r.glType&&(r.gas=i)}})}},n.prototype.getNodeUsage=function(){switch(this.type){case n.Model3DHandler:return t.REPRESENTATION_NODE;case n.TileSetHandler:return t.TILESET_NODE;default:return t.REFERENCE_NODE}},n.Model3DHandler=0,n.InstRefHander=1,n.TileSetHandler=2,n}),define("DS/3DXMTiles/DSTilesPixelErrorScoreComputer",["DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesScoreComputer"],function(e,t,n){"use strict";var i=function(e){n.apply(this,arguments)};return(i.prototype=Object.create(n.prototype)).getSortingMetric=function(){return"pixelError"},i.prototype.computeScore=function(t,n,i){var o=t.screenRadiusCache,r=t.getBoundingSphere();if(r){o||(o=e.computeScreenRadiusCache(t._getWorldMatrix(),null,r,!1,!1),t.screenRadiusCache=o);var s=n.viewpoint,a=n.cst,d=s.getEyePosition().distanceTo(o.center),h=0,l=-1;if(d<o.radius||0===d)return h=1/0,t.score=h,void(i&&(t.pixelError=1/0));s._frustum.performFrustumCullingNoNearFar(o.radius,o.center)&&(h=e.computeScreenRadius(o,s.camera,s._frustum,a)>=5?l=this.computePixelError(t.geometricalError,o,n):-1),t.score=h,t.pixelError=l}else t.score=1/0},i}),define("DS/3DXMTiles/DSTilesContentLoader",["DS/3DXMTiles/DSTilesNodeMemorySize"],function(e){"use strict";var t=function(){};return t.prototype.isReady=function(){return!0},t.prototype.isThereEnoughMemoryToLoad=function(e,t){},t.prototype.loadContent=function(e,t){setTimeout(t.onLoadError.bind(t,e),0)},t.prototype.computeMemorySize=function(t){return new e(0,0)},t.prototype.showContent=function(e){},t.prototype.hideContent=function(e){},t.prototype.deleteContent=function(e){},t}),define("DS/3DXMTiles/LDHInstRefHandler",["DS/3DXMTiles/LDHHandler"],function(e){"use strict";var t=function(){e.call(this,e.InstRefHander)};return t.prototype=Object.create(e.prototype),t}),define("DS/3DXMTiles/DSTilesNode",["DS/3DXMTiles/DSTilesNodeStatus","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesNodeReplaceStatus","DS/3DXMTiles/DSTilesNodeMemorySize","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Selection/HSOManager","DS/3DXMTiles/DSTilesWorldPosition"],function(e,t,n,i,o,r,s,a){"use strict";var d=1,h=2,l=4,c=8,u={matrixUpdate:1,descendantMatrixUpdate:2,onHold:4,childrenOnHold:8,descendantToUnload:16,contentVisible:32,wished:64,toUnload:128,noWishedUnder:256,noVisibleUnder:512,dead:1024,noContent:2048},p=0,f=function(t){this.id=p++,this.tileSet=t.tileSet,this.uri=t.uri,this.handler=null,this.contentLoader=t.contentLoader||null,this.expander=t.expander||null,this.childrenURIs=t.childrenURIs||[],this.children=null,t.childrenURIs&&0===t.childrenURIs.length&&(this.children=[]),this.parent=t.parent||null,this.mode=t.mode||f.Mode.add,this.scoreComputer=t.scoreComputer||null,this.score=-2,this.pixelError=-1,this.occlusionStatus=-2,this.matrix=t.matrix||null,this.worldPosition=new a,t.worldMatrix&&(this.worldPosition.matrixArray[0]=t.worldMatrix),this._boundingSphere=t.boundingSphere||null,this._boundingBox=t.boundingBox||null,this.geometricalError=t.geometricalError||0,this.content=t.content||null,this._contentStatus=this.content?e.waiting:e.loaded,this._expandStatus=this.childrenURIs.length>0?e.waiting:null,this.flags=0,this.sgNode=null,this.contentToken=null,this.inListStatus=0,this.screenRadiusCache=null,this.distanceToBoxCache=null,this.lastUpdateIndex=-1,this.memorySize=new i,this.isLODMode()&&this.setChildrenOnHold(!0),this.queue=t.queue||null,this._debugBBox=null,this.lockLoadDate=0,this.unloadLock=0,this.descendantLocked=0,this.userData=t.userData,this.metaData=t.metaData,this.triggerMetric=t.triggerMetric||"pixelError"};f.prototype.computeScore=function(e,t){e>this.lastUpdateIndex&&(this.lastUpdateIndex=e,this.scoreComputer.computeScore(this,t,this.isLODMode()))},f.prototype.getScore=function(){return this.score},f.prototype.lockUnload=function(){this.unloadLock++;for(var e=this.parent;e;)e.descendantLocked=1,e=e.parent},f.prototype.unlockUnload=function(){this.unloadLock--;for(var e=this.parent;e;)e.descendantLocked=-1,e=e.parent},f.prototype.updateDescendantLocked=function(){var e;if(-1===this.descendantLocked)for(this.descendantLocked=0,e=0;e<this.children.length;e++){var t=this.children[e];t.updateDescendantLocked(),(t.unloadLock>0||t.descendantLocked)&&(this.descendantLocked=1)}},f.prototype.getTriggerMetric=function(){return this.triggerMetric},f.prototype.getSortingMetric=function(){return this.tileSet.getSortingMetric()},f.prototype.isMorePrioritaryThan=function(e){return this.score>e.score},f.prototype.isLessPrioritaryThan=function(e){return this.score<e.score},f.prototype.isLeaf=function(){return!(this.childrenURIs&&this.childrenURIs.length>0)},f.prototype.setContentToken=function(e){this.contentToken=e},f.prototype.isLODMode=function(){return this.mode===f.Mode.replaceLOD||this.mode===f.Mode.addLOD},f.prototype.isReplaceLODMode=function(){return this.mode===f.Mode.replaceLOD},f.prototype.isAddLODMode=function(){return this.mode===f.Mode.addLOD},f.prototype.needsSgNode=function(){return null!==this.matrix||this.content&&this.contentLoader.needsSgNodePerContent()},f.prototype.setSgNode=function(e){this.sgNode=e,e.setMatrix(this.matrix)},f.prototype.updateWorldPositionFromSgNode=function(){this.sgNode&&this.worldPosition.setFromOccurrences(this.sgNode._occurrences)},f.prototype.buildSgNode=function(){null===this.sgNode&&(this.needsSgNode()?(this.sgNode=new o,this.sgNode.setUserData({dsTilesNode:this}),this.matrix&&this.sgNode.setMatrix(this.matrix),this.parent&&(this.parent.buildSgNode(),this.parent.sgNode.addChild(this.sgNode))):this.parent&&(this.sgNode=this.parent.getSgNode()))},f.prototype.hasChildren=function(){return!!(this.children&&this.children.length>0)},f.prototype.getSgNode=function(){return this.buildSgNode(),this.sgNode},f.prototype.addChild=function(e,t){if(null!==e.parent)throw new Error("node already has a parent");null===this.children&&(this.children=[]),e.getDescendantToUnload()&&this.setDescendantToUnload(!0),void 0===t?this.children.push(e):this.children[t]=e,e.parent=this,e.setMatrixUpdate(!0),this.traverse(function(e){var t=!1;return e.getMatrixUpdate()?t=!0:e.setMatrixUpdate(!0),t}),(this.getChildrenOnHold()||this.getOnHold())&&e.setOnHoldTree(),this.getRoot()._dbgCheckConsistency()},f.prototype.setOnHoldTree=function(e){var t=this;this.traverse(function(n){if(n.setChildrenOnHold(!0),n!==t||!e)return n.parent&&n.setDescendantToUnload(!0),!!n.getOnHold()||(n.hideContent(),n.setOnHold(!0),!1)})},f.prototype.activateChildren=function(e){if(this.children){var t,n;for(t=0;t<this.children.length;t++)(n=this.children[t]).getOnHold()&&(n.setOnHold(!1),e.registerDSTilesNode(n,!0));this.setChildrenOnHold(!1)}},f.prototype.updateWorldMatrix=function(e,t){if(e){var n=this.getMatrixUpdate()||t;if(n&&(this.parent?this.worldPosition.update(this):this.updateWorldPositionFromSgNode(),this.screenRadiusCache=null,this.distanceToBoxCache=null,this.setMatrixUpdate(!1)),n||this.getDescendantMatrixUpdate()){var i;if(this.children)for(i=0;i<this.children.length;i++)this.children[i]&&this.children[i].updateWorldMatrix(!0,!!n);this.setDescendantMatrixUpdate(!1)}}else{for(var o=this;o.parent;)o=o.parent;o.updateWorldMatrix(!0)}},f.prototype._getWorldMatrix=function(){return this.worldPosition.matrixArray[0]},f.prototype.getWorldBoundingSphere=function(){this.updateWorldMatrix();var e=this.getBoundingSphere().clone();return e.applyMatrix4(this._getWorldMatrix()),e},f.prototype.setInList=function(e){this.inListStatus=e?this.inListStatus|d:this.inListStatus&65535-d},f.prototype.isInList=function(){return!!(this.inListStatus&d)},f.prototype.isInToBeLoaded=function(){return!!(this.inListStatus&h)},f.prototype.setInToBeLoaded=function(e){this.inListStatus=e?this.inListStatus|h:this.inListStatus&65535-h},f.prototype.isInUnload=function(){return!!(this.inListStatus&l)},f.prototype.setInUnload=function(e){this.inListStatus=e?this.inListStatus|l:this.inListStatus&65535-l},f.prototype.isInToExpand=function(){return!!(this.inListStatus&c)},f.prototype.setInToExpand=function(e){this.inListStatus=e?this.inListStatus|c:this.inListStatus&65535-c},f.prototype.getMatrixUpdate=function(){return!!(this.flags&u.matrixUpdate)},f.prototype.setMatrixUpdate=function(e){e?(this.flags=this.flags|u.matrixUpdate,this.parent&&this.parent.setDescendantMatrixUpdate(!0)):this.flags=this.flags&65535-u.matrixUpdate},f.prototype.getDescendantMatrixUpdate=function(){return!!(this.flags&u.descendantMatrixUpdate)},f.prototype.setDescendantMatrixUpdate=function(e){e?(this.flags=this.flags|u.descendantMatrixUpdate,this.parent&&!this.parent.getDescendantMatrixUpdate()&&this.parent.setDescendantMatrixUpdate(!0)):this.flags=this.flags&65535-u.descendantMatrixUpdate},f.prototype.checkConsistency=function(){if(this.parent&&this.parent.getChildrenOnHold()&&!this.getOnHold())throw new Error("inconsistency!!");var e;for(e=0;this.children&&e<this.children.length;e++)this.children[e].checkConsistency()},f.prototype.getDead=function(){return!!(this.flags&u.dead)},f.prototype.setDead=function(t){this.flags=this.flags|u.dead,t.registerDSTilesNode(this,!0),this._contentStatus=e.dead,this._expandStatus=e.dead},f.prototype.getOnHold=function(){return!!(this.flags&u.onHold)},f.prototype.setOnHold=function(e){this.flags=e?this.flags|u.onHold:this.flags&65535-u.onHold},f.prototype.getNoContent=function(){return!!(this.flags&u.noContent)},f.prototype.setNoContent=function(e){this.flags=e?this.flags|u.noContent:this.flags&65535-u.noContent},f.prototype.getChildrenOnHold=function(){return!!(this.flags&u.childrenOnHold)},f.prototype.setChildrenOnHold=function(e){this.flags=e?this.flags|u.childrenOnHold:this.flags&65535-u.childrenOnHold},f.prototype.getDescendantToUnload=function(){return!!(this.flags&u.descendantToUnload)},f.prototype.setDescendantToUnload=function(e){e?(this.flags=this.flags|u.descendantToUnload,this.parent&&!this.parent.getDescendantToUnload()&&this.parent.setDescendantToUnload(!0)):this.flags=this.flags&65535-u.descendantToUnload},f.prototype.getToUnload=function(){return!!(this.flags&u.toUnload)},f.prototype.setToUnload=function(e){e?(this.flags=this.flags|u.toUnload,this.parent&&!this.parent.getDescendantToUnload()&&this.parent.setDescendantToUnload(!0)):this.flags=this.flags&65535-u.toUnload},f.prototype.getWished=function(){return!!(this.flags&u.wished)},f.prototype.setWished=function(e){this.flags=e?this.flags|u.wished:this.flags&65535-u.wished},f.prototype.getNoWishedUnder=function(){return!!(this.flags&u.noWishedUnder)},f.prototype.setNoWishedUnder=function(e){this.flags=e?this.flags|u.noWishedUnder:this.flags&65535-u.noWishedUnder},f.prototype.getNoVisibleUnder=function(){return!!(this.flags&u.noVisibleUnder)},f.prototype.setNoVisibleUnder=function(e){this.flags=e?this.flags|u.noVisibleUnder:this.flags&65535-u.noVisibleUnder},f.prototype.getContentVisible=function(){return!!(this.flags&u.contentVisible)},f.prototype.setContentVisible=function(e){this.flags=e?this.flags|u.contentVisible:this.flags&65535-u.contentVisible},f.prototype.traverseParents=function(e){!e(this)&&this.parent&&this.parent.traverseParents(e)},f.prototype.traverse=function(e){var t;if(!e(this)&&this.children)for(t=0;t<this.children.length;t++)this.children[t]&&this.children[t].traverse(e)},f.prototype.traverseChildren=function(e){var t;if(this.children)for(t=0;t<this.children.length;t++)this.children[t]&&this.children[t].traverse(e)},f.prototype.hasContent=function(){return null!==this.content},f.prototype.getBoundingBox=function(){if(!this._boundingBox){var e=this._boundingSphere;if(!e)return null;var n=new t.Box3;n.min.x=e.center.x-e.radius,n.min.y=e.center.y-e.radius,n.min.z=e.center.z-e.radius,n.max.x=e.center.x+e.radius,n.max.y=e.center.y+e.radius,n.max.z=e.center.z+e.radius,this._boundingBox=n}return this._boundingBox};var g=new t.Sphere;f.prototype.getBoundingSphere=function(){return this._boundingSphere?this._boundingSphere:this._boundingBox?(this._boundingBox.getBoundingSphere(g),g):null},f.prototype.isContentToLoad=function(){return this._contentStatus===e.toLoad},f.prototype.isContentLoaded=function(){return this._contentStatus===e.loaded},f.prototype.isContentLoading=function(){return this._contentStatus===e.loading},f.prototype.isContentWaiting=function(){return this._contentStatus===e.waiting},f.prototype.isExpandToLoad=function(){return this._expandStatus===e.toLoad},f.prototype.isExpandLoaded=function(){return this._expandStatus===e.loaded},f.prototype.isExpandLoading=function(){return this._expandStatus===e.loading},f.prototype.isExpandWaiting=function(){return this._expandStatus===e.waiting},f.prototype.isAlive=function(){return!this.getDead()},f.prototype.isLoading=function(){return this._contentStatus===f.loading||this._expandStatus===f.loading},f.prototype.isError=function(){return this._contentStatus===e.error||this._expandStatus===e.error},f.prototype.isWaiting=function(){return!(null!==this._contentStatus&&this._contentStatus!==e.waiting||null!==this._expandStatus&&this._expandStatus!==e.waiting)},f.prototype.hasExpand=function(){return null!==this._expandStatus},f.prototype.setContentStatus=function(t,n){if(null!==this._contentStatus){var i=this._contentStatus,o=i!==t;if(this._contentStatus=t,o){var r=!0;i===e.waiting&&t===e.toLoad&&(r=!1),n.registerDSTilesNode(this,r)}this.getRoot()._dbgCheckConsistency()}},f.prototype.setExpandStatus=function(t,n){if(null!==this._expandStatus){var i=this._expandStatus,o=i!==t;if(this._expandStatus=t,o){var r=!0;i===e.waiting&&t===e.toLoad&&(r=!1),n.registerDSTilesNode(this,r)}this.getRoot()._dbgCheckConsistency()}},f.prototype.passVisibilityTest=function(){return 1===this.descendantLocked||this.unloadLock>0||this.score>0},f.prototype.passPixelErrorTest=function(){return 1!==this.descendantLocked&&(this.pixelError>=0&&this.pixelError<this.tileSet.maxPixelError)},f.prototype.showContent=function(){this.content?this.contentToken&&this.contentLoader&&!this.getContentVisible()&&(this.contentLoader.showContent(this.contentToken),this.setContentVisible(!0)):this.setContentVisible(!0)},f.prototype.hideContent=function(){this.content?this.contentToken&&this.contentLoader&&this.getContentVisible()&&(this.contentLoader.hideContent(this.contentToken),this.setContentVisible(!1)):this.setContentVisible(!1)},f.prototype.deleteContent=function(t){this.contentToken&&this.contentLoader&&(this.contentLoader.deleteContent(this.contentToken),this.setContentVisible(!1),this.setContentStatus(e.waiting,t),this.contentToken=null)},f.prototype.getRoot=function(){for(var e=this;e.parent;)e=e.parent;return e},f.prototype.addToHSO=function(e){if(e||s.empty(),this.handler)this.content&&this.content.addToHSO();else if(this.children){var t;for(t=0;t<this.children.length;t++)this.children[t].addToHSO(!0)}},f.prototype.checkVisibilityConsistency=function(){this.getContentVisible()?this.traverseChildren(e=>{if(e.getContentVisible())throw new Error("content visible inconsistency")}):this.traverseChildren(e=>{e.checkVisibilityConsistency()})},f.prototype._dbgCheckConsistency=function(){},f.prototype._dbgCheckOnHoldConsistency=function(){this.traverse(function(e){if(e.parent&&!e.getOnHold()&&e.parent.getChildrenOnHold())throw new Error("Inconsistency!!!")})},f.prototype.tryUnload=function(e){var t,n,i=[];for(this._dbgCheckConsistency(),this.tryUnload_internal(i,e),t=0;t<i.length;t++)(n=i[t].parent)&&n.setDescendantToUnload(!0);this.queue.cleanLists(),this._dbgCheckConsistency()},f.prototype.isUnloading=function(e){if(window.forceUnload)return!0;var t=this.contentLoader&&this.contentLoader.getBudget();return!t||t.unloading},f.prototype.isContentLoadingAllowed=function(e){return(this.contentLoader&&this.contentLoader.getBudget()).isLoadingAllowed()},f.prototype.isExpandLoadingAllowed=function(e){return!0},f.prototype.tryUnload_internal=function(e,t){var n=this.getDescendantToUnload()||this.getChildrenOnHold(),i=!1,o=0===this.unloadLock&&(this.getToUnload()||this.getOnHold())&&this.isUnloading(t);if(this.isWaiting())this.setToUnload(!1),i=!0;else if(o||n)if(this.isLoading())i=!1;else{var r,s=!0;if(this.children)for(r=0;r<this.children.length;r++)this.children[r].tryUnload_internal(e,t)||(s=!1);s?(this.setDescendantToUnload(!1),o&&(this.doUnload(),i=!0)):i=!1}else i=!1;return o&&!i&&e.push(this),i},f.prototype.doUnload=function(){var t=this.queue;if(this.handler&&this.getRepLoaded()&&this.handler.removeRepresentation(this),this.deleteContent(t),this.children&&this.children.length>0){var n,i;for(n=0;n<this.children.length;n++)(i=this.children[n]).setDead(t),i.tileSet.removeNode(i.uri),i.parent=null;this.children=null}this.setToUnload(!1),this.setExpandStatus(e.waiting,t),this.sgNode&&this.parent&&(this.parent.sgNode.removeChild(this.sgNode),this.sgNode=null)},f.prototype.destroy=function(){if(this.children&&this.children.length>0){var e;for(e=0;e<this.children.length;e++)this.children[e].destroy();this.children=null}var t=this.queue;this.handler&&this.getRepLoaded()&&this.handler.removeRepresentation(this),this.deleteContent(t),this.children=null,this.setDead(t),this.sgNode&&this.parent&&this.parent.sgNode.removeChild(this.sgNode),this.sgNode=null,this.parent=null},f.prototype.traverseUpdateNodes=function(e){if(!this.getOnHold()){var t,n=!1,i=[],o=this.tileSet.progressiveMode;for(this.traverse(e=>{var t=!1;if(e.passVisibilityTest()){e.setNoWishedUnder(!1);var r=!1;e.isAddLODMode()?r=!0:!e.passPixelErrorTest()&&e.hasChildren()||(r=!0);var s=e.isAddLODMode();o&&e.startLoading(s),r?(e.setWished(!0),o||e.startLoading(s)&&(n=!0),e.isReplaceLODMode()&&(e.traverseChildren(t=>!(!t.getNoWishedUnder()||e.getChildrenOnHold())||(t.setNoWishedUnder(!0),t.setWished(!1),t.setOnHold(!0),t.setChildrenOnHold(!0),!1)),e.setChildrenOnHold(!0),t=!0),e.isAddLODMode()&&e.passPixelErrorTest()&&(e.traverseChildren(t=>!(!t.getNoWishedUnder()||e.getChildrenOnHold())||(n=!0,t.hideContent(),t.setNoWishedUnder(!0),t.setWished(!1),t.setOnHold(!0),t.setChildrenOnHold(!0),!1)),e.setChildrenOnHold(!0),t=!0)):e.setWished(!1)}else e.getNoWishedUnder()||(i.push(e),t=!0);return t}),t=0;t<i.length;t++)i[t].setNoWishedUnder(!0),i[t].traverse(e=>{e.setNoWishedUnder(!0),e.setWished(!1)});n&&e.render(),this.isReplaceLODMode()&&this.traverseReplace(e)}},f.prototype.traverseReplace=function(e){if(!this.getOnHold())if(this.tileSet.progressiveMode)this.traverseReplaceProgressive(e);else{var t=!1;this.traverse(e=>{var n=!1;if(e.passVisibilityTest()){if(e.getContentVisible()&&!e.getWished()){var i,o=!0,r=[];if(e.traverse(e=>{if(e.getWished())return e.isContentLoaded()||(o=!1),r.push(e),!0}),o&&r.length>0)for(t=!0,e.hideContent(),i=0;i<r.length;i++)r[i].showContent();n=!0}e.getWished()&&(e.isContentLoaded()&&!e.getContentVisible()&&(t=!0,e.showContent(),e.traverseChildren(e=>{e.hideContent()})),n=!0)}return n}),t&&e.render()}},f.prototype.traverseReplaceProgressive=function(e){var t=new Set,n=new Set,i=new Set;(this.parent?this.parent:this).traverseReplaceProgressive_internal(t,n,i),t.forEach(e=>{e.showContent(),e.traverseChildren(e=>{var t=!1;return e.getNoVisibleUnder()&&(t=!0),e.setNoVisibleUnder(),e.getContentVisible()&&e.hideContent(),t})}),n.forEach(e=>{e.hideContent()}),i.forEach(e=>{e.traverse(e=>{var t=!1;return e.getNoVisibleUnder()&&(t=!0),e.getContentVisible()&&e.hideContent(),t})})},f.prototype.traverseReplaceProgressive_internal=function(e,t,n){if(this.setNoVisibleUnder(!1),this.hasContent()&&!this.getContentVisible()&&e.add(this),!this.passPixelErrorTest()&&this.children){var i,o,r=!0,s=!1;for(i=0;i<this.children.length;i++)(o=this.children[i]).passVisibilityTest()&&(s=!0,o.isContentLoaded()||(r=!1));if(this.hasContent()&&!r||!s)for(i=0;i<this.children.length;i++)o=this.children[i],n.add(o);else for(e.delete(this),this.hasContent()&&this.getContentVisible()&&t.add(this),i=0;i<this.children.length;i++)(o=this.children[i]).passVisibilityTest()?o.traverseReplaceProgressive_internal(e,t,n):n.add(o)}else if(this.children)for(i=0;i<this.children.length;i++)o=this.children[i],n.add(o)},f.prototype.startLoading=function(t){var n=this.queue,i=!1;return this.hasContent()&&!this.isError()&&(this.isContentLoaded()?t&&(this.showContent(),i=!0):this.hasContent()&&!this.isContentLoading()&&(this.setContentStatus(e.toLoad,n),this.isInToBeLoaded()||(n.nodesToLoadQueue.addNode(this),this.setInToBeLoaded(!0)))),i},f.prototype.exportContent=function(){return this.hasContent()&&this.isContentLoaded()&&this.contentToken?this.contentLoader.exportContent(this.contentToken):null},f.prototype.getBudgetId=function(){var e="cpu";return this.contentLoader&&(e=this.contentLoader.getBudgetId()),e},f.prototype.getDistanceToBoxCache=function(){return this.scoreComputer?this.scoreComputer.getDistanceToBoxCache(this):null};var m=t.MaterialUtils.createShinyFaceMaterial({color:"blue",transparent:!0,opacity:.2,force:!0}),y=null;return f.prototype.showBox=function(){y||(y=new o,window.debugWebGLV6Viewer.addNode(y));var e=this.getBoundingBox();y.removeChildren();var t=r.createCuboidNodeFromBox3(e,m),n=this._getWorldMatrix();n&&t.setMatrix(n),y.addChild(t),window.debugWebGLV6Viewer.render()},Object.defineProperty(f.prototype,"flagsStr",{get:function(){var e,t=null;for(e in u)this.flags&u[e]&&(null===t?t="":t+=" ",t+=e);return t},set:function(e){throw new Error("forbidden")}}),f.Mode={add:"add",addLOD:"addLOD",replaceLOD:"replaceLOD"},f.PlusInfinity=new f({}),f.PlusInfinity.score=1/0,f.PlusInfinity.priority=1/0,f.MinusInfinity=new f({}),f.MinusInfinity.score=-1/0,f.MinusInfinity.priority=-1/0,f}),define("DS/3DXMTiles/OOC3DTilesManager",["DS/3DXMTiles/DSTilesNode","DS/3DXMTiles/DSTilesConstantScoreComputer","DS/3DXMTiles/DSTilesPointCloudSeedContent"],function(e,t,n){"use strict"}),define("DS/3DXMTiles/PointCloudServices",["DS/Visualization/ThreeJS_DS","DS/WAFData/WAFData","DS/3DXMTiles/DSTilesNode"],function(e,t,n){"use strict";var i=65536,o=131072,r=327680;var s={_msgCount:0,timeOut:void 0,_OOCNodeSize:128,parseBigInt:function(e){var t;try{t=BigInt("0xFFFFFFFFFFFFFFFF")}catch{t=JSBI.BigInt("0xFFFFFFFFFFFFFFFF")}return t},getPointCloudHeader:function(e,n){return new Promise(function(i,o){let r=e+"/api/r2v/v1/ooc/header?"+("oocUrl="+n);t.authenticatedRequest(r,{method:"GET",type:"json",onComplete:function(e){let t=e.spacing,n=e.maxLODDepth;i({spacing:t,maxDepth:n})},onFailure:function(e){console.error("error getOOCHeader"),o(e)}})})},buildNodes:function(e){var i=e.source,o=e.uuid,r=e.nodesID,s=e.scoreComputer,a=e.seed;if(0===r.length)return console.log("empty"),Promise.resolve([]);let d=this;return new Promise(function(h,l){1==r.length&&BigInt("0xFFFFFFFFFFFFFFFF")==r[0]&&(r[0]=-1);let c=d._encodeQueryURI({oocUrl:o,ids:r,nblvl:0}),u=i+"/api/r2v/v1/ooc/hierarchy?"+c;t.authenticatedRequest(u,{method:"GET",type:"arraybuffer",onComplete:function(t){--d._msgCount;new DataView(t);let i=t.slice(8);var o=[],r=[];d._unstreamOOCNodes(i,type,o,r,e.DSTilesPointCloudNodeContent);let l,c,u,p,f=[],g=a.content.maxDepth,m=a.content.spacing;for(l=0;l<o.length;l++){o[l].seed=a;let t=(c=o[l]).depth>g?g:c.depth,i=m>0?m*Math.pow(2,g-t):0;u=c.points<65536&&0===c.oocChildren.length,p=c.depth<=a.content.maxDepth&&c.points>65536&&0!==c.oocChildren.length;var y=new n({handler:u||p?e.DSTilesPointCloudNodeHandlerSingleton:null,expander:e.DSTilesPointCloudNodeExpanderSingleton,mode:n.Mode.addLOD,scoreComputer:s,boundingBox:r[l],geometricalError:i,content:c});0===c.oocChildren.length&&(y.children=[]),f.push(y)}h(f)},onFailure:function(e){--d._msgCount,console.log("error getOOCNode"),l(e)},timeout:d.timeOut}),++d._msgCount})},_encodeQueryURI:function(e){let t="";for(const n in e)if(""!=t&&(t+="&"),Array.isArray(e[n]))for(let i=0;i<e[n].length;++i)i>0&&(t+="&"),t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n][i]);else t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n]);return t},_unstreamOOCNodes:function(t,n,s,a,d){const h=t.byteLength/this._OOCNodeSize;if(n==i||n==o||n==r){const n=new DataView(t);let i=0;for(let t=0;t<h;t++){const t=new d;t.id=n.getBigUint64(i,!0),i+=8,t.code=n.getBigUint64(i,!0),i+=8,t.depth=n.getInt32(i,!0),i+=4,t.points=n.getBigUint64(i,!0),i+=8,t.firstPoint=n.getBigUint64(i,!0),i+=8;for(let e=0;e<8;e++){const e=n.getBigUint64(i,!0);try{e<BigInt("0xFFFFFFFFFFFFFFFF")&&e!=t.id&&t.oocChildren.push(e)}catch{JSBI.LT(e,JSBI.BigInt("0xFFFFFFFFFFFFFFFF"))&&e!=t.id&&t.oocChildren.push(e)}i+=8}t.oocChildren.length||(t.children_loaded=!0);const o=n.getFloat32(i,!0);i+=4;const r=n.getFloat32(i,!0);i+=4;const h=n.getFloat32(i,!0);i+=4;const l=n.getFloat32(i,!0);i+=4;const c=n.getFloat32(i,!0);i+=4;const u=n.getFloat32(i,!0);i+=4;let p=new e.Box3(new e.Vector3(o,r,h),new e.Vector3(l,c,u));const f=n.getUint32(i,!0);4294967295>f&&(t.lodId=f),i+=4,s.push(t),a.push(p)}}},loadLODNode:function(e,n){performance.mark("ooc-start");let i=this;return new Promise(function(o,r){let s=i._encodeQueryURI({oocUrl:e.uuid,lodId:n.lodId}),a=e.source+"/api/r2v/v1/ooc/LODData?"+s;t.authenticatedRequest(a,{method:"GET",type:"arraybuffer",onComplete:function(e){--i._msgCount;let t=new DataView(e),r=0;t.getUint32(r,!0);r+=4;let s=t.getUint32(r,!0);r+=4;let a=e.slice(r),d=i._prepareGeometry(a,s);o(d),performance.mark("ooc-end"),performance.measure("ooc "+n.id,"ooc-start","ooc-end")},onFailure:function(e){--i._msgCount,console.log("error node "+n.id),r(n.id)},timeout:i.timeOut}),++i._msgCount})},loadNode:function(e,n){performance.mark("ic-start");var i=this;return new Promise(function(o,r){let s=i._encodeQueryURI({oocUrl:e.uuid,firstPoint:n.firstPoint,numPoints:n.points}),a=e.source+"/api/r2v/v1/ooc/nodeData?"+s;t.authenticatedRequest(a,{method:"GET",type:"arraybuffer",onComplete:function(e){--i._msgCount;let t=new DataView(e),r=0;t.getUint32(r,!0);r+=4;let s=t.getUint32(r,!0);r+=4;let a=e.slice(r),d=i._prepareGeometry(a,s);o(d),performance.mark("ic-end"),performance.measure("ic "+n.id,"ic-start","ic-end")},onFailure:function(e){--i._msgCount,console.log("error node"+n.id),r(e)},timeout:i.timeOut}),++i._msgCount})},loadTileContent:function(e){performance.mark("ic-start");var n=this;return new Promise(function(i,o){t.authenticatedRequest(e,{method:"GET",type:"arraybuffer",onComplete:function(e){--n._msgCount;var t=n.createTileContentFromBuffer(e);t?i(t):o()},onFailure:function(t){--n._msgCount,console.log("error url: "+e),o(t)},timeout:n.timeOut}),++n._msgCount})},createTileContentFromBuffer:function(e){let t=new DataView(e);const n=new Uint8Array(e);let i=0,o=s.oldUnstream?t.getUint32(i):t.getUint32(i,!0);if(i+=4,1===o){let n=s.oldUnstream?t.getUint32(i):t.getUint32(i,!0);i+=4;let r=e.slice(i);return{version:o,geometry:this._prepareGeometry(r,n)}}if(2===o){let r=t.getUint32(i,!0);i+=4;const s=new TextDecoder("utf-8"),a=JSON.parse(s.decode(n.subarray(i,i+r)));i+=r;let d=t.getUint32(i,!0);i+=4;let h=t.getFloat32(i,!0);i+=4;let l={buffer:e.slice(i),attributes:[],points:d,spacing:h},c=0;for(let e of a)c+=e.size;for(let e of a)"DEF_POSITION"===e.name?l.attributes.push(this._buildPosition(e,c)):"DEF_COLOR"===e.name?l.attributes.push(this._buildColor(e,c)):"Intensity"===e.name?l.attributes.push(this._buildFloatAttribute(e,c)):"Classification"===e.name&&l.attributes.push(this._buildUintAttribute(e,c));return{version:o,geometry:l}}return null},_buildPosition:function(t,n){return{name:"position",offset:t.offset,size:t.size,count:3,type:e.FloatType,normalize:!1,stride:n}},_buildColor:function(t,n){return{name:"color",offset:t.offset,size:t.size,count:4,type:e.UnsignedByteType,normalize:!0,stride:n}},_buildFloatAttribute:function(t,n){return{name:t.name,offset:t.offset,size:t.size,count:1,type:e.FloatType,normalize:!1,stride:n}},_buildUintAttribute:function(t,n){return{name:t.name,offset:t.offset,size:t.size,count:1,type:e.UnsignedIntType,normalize:!1,stride:n}},_buildUintByteAttribute:function(t,n){return{name:t.name,offset:t.offset,size:t.size,count:1,type:e.UnsignedByteType,normalize:!1,stride:n}},_prepareGeometry:function(t,n){return{buffer:t,attributes:[{name:"position",offset:0,size:12,count:3,type:e.FloatType,normalize:!1,stride:16},{name:"color",offset:12,size:4,count:4,type:e.UnsignedByteType,normalize:!0,stride:16}],points:n}},_buildPointCloudNode:function(e){}};return s.bigIntZero=s.parseBigInt("0"),s.oldUnstream=!1,s}),define("DS/3DXMTiles/LDHOccurrence",["DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/3DXMTiles/Debug3DXMTiles","DS/3DXMTiles/LDHReferenceStatus","DS/Visualization/PathElement","DS/Visualization/IdPath"],function(e,t,n,i,o,r,s){"use strict";var a=new t.Matrix4,d=function(e,t){var n=e.reference;this.reference=n||null,n._occurrences.length>0&&e.manager.forceUpdateNode(n),n._occurrences.push(this),this.node=e.node||null,this.parent=e.parent||null,this.instanceData=e.instanceData||null,this.updateMatrix(e.manager);for(var i=0;i<n.children.length;++i){var o=n.children[i];new d({reference:o.reference,boundingSphere:o.reference.boundingSphere,node:null,manager:e.manager,parent:this,instanceData:o},t)}this.reference.requestBuildSceneGraphHierarchy(),this.viewpointTag=-1,this.reference.updateMemorySizeNEW(e.manager),this.reference._optional&&this.reference._optional.hasOverride()&&t&&t.add(this.reference)};d.prototype.updateMatrix=function(e){var n=this.parent?this.parent.matrix:null,i=this.getLocalMatrix(e);null===i?this.matrix=n||a:(this.matrix=new t.Matrix4,n?this.matrix.multiplyMatrices(n,i):this.matrix.copy(i))},d.getOccurrenceMatrix=function(e,n){return null===n?e:(new t.Matrix4).multiplyMatrices(e,n)},d.prototype.getChildren=function(){var e,t,n,i,o=[],r=[];for(n=0;n<this.reference.children.length;n++)if(e=this.reference.children[n].reference,-1===r.indexOf(e)){for(i=0;i<e._occurrences.length;i++)null!==(t=e._occurrences[i])&&t.parent===this&&o.push(t);r.push(e)}return o},d.prototype.getIdPath=function(){if(this.parent){var e=this.parent.getIdPath();return e.push(this.instanceData.instanceId),e.push(this.reference.referenceId),e}return[this.reference.referenceId]},d.prototype.removeFromSceneGraph=function(){this.node&&this.reference.node&&this.reference.node.removeChild(this.node)},d.prototype.detach=function(e){e&&e.add(this.reference),this.reference._removeOccurrenceFromList(this);var t,n=this.getChildren();for(t=0;t<n.length;t++)n[t].detach(e);this.parent=null},d.prototype.buildPathElement=function(){if(this.reference.node){for(var e,t=[],n=this;n;){if(t.unshift(n.reference.node),e=null,n.parent){if(!(e=n.parent.reference.getChildInstanceNode(n.instanceData.instanceId)))return null;t.unshift(e)}n=n.parent}return new r(t)}return null},d.prototype.getBoundingSphere=function(){var e=this.reference.getBoundingSphere(),t=null;return e&&(t=e.clone()).applyMatrix4(this.matrix),t};var h=new t.Matrix4;return d.prototype.getLocalMatrix=function(e){var t=e.viewer.getSceneGraphOverrideSetManager(),n=e.viewer.getIdPathMatcher(),i=this.reference.referenceId,o=this.instanceData&&this.instanceData.instanceId,r=t._hasIdPathOverride(i),s=this.instanceData&&t._hasIdPathOverride(o),a=null,d=null,l=null,c=null;if(r||s){var u=this.buildIdPath(n,e);return r&&(a=t._getIdPathPositionOverride(u)),s&&(u.removeLastId(),d=t._getIdPathPositionOverride(u)),a&&(l=a.getPosition())&&l.isIdentity()&&(l=null),d&&(c=d.getPosition()),c?c.isIdentity()&&(c=null):c=this.instanceData&&this.instanceData.matrix,l&&c?(h.multiplyMatrices(c,l),h):l||(c||null)}return this.instanceData?this.instanceData.matrix:null},d.prototype.buildIdPath=function(e,t){for(var n=this,i=this.getIdPath();n.parent;)n=n.parent;var o=t.targetNode;return i.unshift(e.nodeToId(o)),new s(i)},d}),define("DS/3DXMTiles/DSTilesDistanceScoreComputer",["DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesScoreComputer"],function(e,t,n){"use strict";var i=function(){};return(i.prototype=Object.create(n.prototype)).computeScore=function(t,n,i){var o=t.screenRadiusCache,r=t.getBoundingSphere(),s=!1;if(r){o||(o=e.computeScreenRadiusCache(t._getWorldMatrix(),null,r,!1,!1),t.screenRadiusCache=o);var a=n.viewpoint,d=a.getEyePosition().distanceTo(o.center),h=0;if(d<o.radius||0===d)return h=1/0,t.score=h,void(i&&(t.pixelError=1/0));(s=a._frustum.performFrustumCullingNoNearFar(o.radius,o.center))&&(h=1/d),t.score=h}else t.score=1/0;t.pixelError=i&&s?this.computePixelError(t.geometricalError,o,n):-1},i}),define("DS/3DXMTiles/LDHReferenceRep",["DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/3DXMTiles/LDHHandler","DS/Visualization/BufferGPUManager","DS/3DXMTiles/3DXMTilesUtils"],function(e,t,n,i,o){"use strict";var r=-10,s=0,a=10,d=function(e){e=e||{},this.node=null,this.meshSize=-1,this.src=e.url||e.src||null,this.meshInRAMStatus=s,this.active=!1,this.type=e.type,this.nextRep=null,this.wms=e.wms||0};return d.prototype.clone=function(){var e=new d;return e.src=this.src,e.wms=this.wms,e.type=this.type,e},d.prototype.setWMS=function(e){this.wms=e||0},d.prototype.setSrc=function(e){this.src=e},d.prototype.setUrlAndType=function(e,t){this.src=e,this.type=t},d.prototype.updateUrl=function(e){this.src=e},d.prototype.equals=function(e){return this.src===e.src&&this.noMeshInRAM===e.noMeshInRAM&&this.wms===e.wms},d.prototype.hasMeshInRAM=function(){return this.meshInRAMStatus>0},d.prototype.copyMissingParams=function(e){e&&(null===this.src&&(this.src=e.src),0===this.wms&&(this.wms=e.wms),this.meshInRAMStatus===s&&(this.meshInRAMStatus=e.meshInRAMStatus))},d.prototype.forceMeshInRAM=function(e){this.meshInRAMStatus=e?a:r},d.prototype.setMeshInRAM=function(e){this.meshInRAMStatus=e?a:r},d.prototype.isPartiallyDefined=function(){return null===this.src||this.meshInRAMStatus===s},d.prototype.isClearMeshInRAMOnly=function(e){return!!(e&&e.meshInRAMStatus<0&&e.src===this.src&&this.meshInRAMStatus>0&&e.wms===this.wms)},d.prototype.buildNode=function(){return this.node||(this.node=new e),this.node},d.prototype.getJSON=function(){return{src:this.src,meshInRAM:!this.noMeshInRAM}},d.prototype.clearMeshInRAM=function(){this.node&&this.node.traverse(function(e){e instanceof t&&e.forceNoMeshInRAM()}),this.meshInRAMStatus>0&&(this.meshInRAMStatus*=-1)},d.prototype.getMeshSize=function(){return-1!==this.meshSize?this.meshSize:0},d.prototype.updateMeshSize=function(e){var t=0;this.node&&this.node.children.length>0&&e.handler.type===n.Model3DHandler&&(t=o.computeMeshSize(this.node)),this.meshSize=t},d.prototype.isAV1=function(){return this.type===d.RepType.av1},d.prototype.isPR=function(){return this.type===d.RepType.pr},d.prototype.getSrc=function(){return this.src},Object.defineProperty(d.prototype,"noMeshInRAM",{get:function(){return this.meshInRAMStatus<0},set:function(){throw new Error("patata")}}),Object.defineProperty(d.prototype,"url",{get:function(){return this.src},set:function(e){this.src=e}}),d.RepType={none:"RepType##NONE",av1:"RepType##AV1",pr:"RepType##PR",rr:"RepType##RR"},d}),define("DS/3DXMTiles/DSTilesGenericScoreComputer",["DS/3DXMTiles/DSTilesScoreComputer","DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/ThreeJS_DS"],function(e,t,n){"use strict";var o=function(e){this.minScreenRadius=e.minScreenRadius||5};return(o.prototype=Object.create(e.prototype)).getSortingMetric=function(){return this.sortingMetric},o.prototype.getScreenRadiusCache=function(e){var n=e.screenRadiusCache;if(!n){var i=e.getBoundingSphere();n=[];var o,r=e.worldPosition;for(o=0;o<r.matrixArray.length;o++)n.push(t.computeScreenRadiusCache(r.matrixArray[o],null,i,!1,!1));e.screenRadiusCache=n.length>0?n:null}return n},o.prototype.getDistanceToBoxCache=function(e){var n=e.distanceToBoxCache;if(!n||0===n.length){var i=e.getBoundingBox();n=[];var o,r=e.worldPosition;for(o=0;o<r.matrixArray.length;o++)n.push(t.computeDistanceToBoxCache(r.matrixArray[o],i));e.distanceToBoxCache=n.length>0?n:null}return n},o.prototype.computeScore=function(e,n,i){var o=e.getTriggerMetric(),r=e.getSortingMetric();if(e.getBoundingSphere()){var s,a,d,h=n.viewpoint,l=h.getEyePosition(),c=n.cst,u=this.getScreenRadiusCache(e),p=!1,f=-1/0;for(s=0;s<u.length;s++){if((d=u[s]).containsPoint(l))return e.score=1/0,void(e.pixelError=1/0);h._frustum.performFrustumCullingNoNearFar(d.radius,d.center)&&(a=t.computeScreenRadius(d,h.camera,h._frustum,c,!1,!1,!0))>=this.minScreenRadius&&(p=!0,f=a>f?a:f)}var g,m=0;if("pixelError"===r||i&&"pixelError"===o)for(m=-1/0,s=0;s<u.length;s++)m=(g=this.computePixelError(e.geometricalError,u[s],n))>m?g:m;var y=0;("distanceToBox"===r||i&&"distanceToBox"===o)&&(y=this.computeDistanceToBox(e,n));var v=1/0;if("distanceToSphere"===r){var M=1/0;for(s=0;s<u.length;s++)v=(d=u[s]).containsPoint(l)?0:v<(M=d.center.distanceTo(l)-d.radius)?v:M}var S=0,L=-1;if(p)switch(r){case"screenRadius":S=f;break;case"distanceToBox":S=1/y;break;case"distanceToSphere":S=1/v;break;case"pixelError":S=m}if(p&&i)switch(o){case"pixelError":L=m;break;case"distanceToBox":for(L=0,s=0;s<u.length;s++)d=u[s],y<e.geometricalError*d.scale&&(L=1/0)}e.score=S,e.pixelError=L}else e.score=1/0,i&&(e.pixelError=-1)},o.prototype.computeDistanceToBox=function(e,t){if(!e.getBoundingBox())return-1;var n,o=this.getDistanceToBoxCache(e),r=t.viewpoint.getEyePosition(),s=1/0;for(i=0;i<o.length;i++)s=(n=o[i].boundingBox.distanceToPoint(r))<s?n:s;return s},o.prototype.computePixelError=function(e,t,i){var o,r=i.viewpoint,s=t.radius,a=t.center,d=r.getEyePosition(),h=r.getSightDirection(),l=new n.Vector3(a.x-d.x,a.y-d.y,a.z-d.z),c=l.length();l.multiplyScalar((c-s)/c);var u=l.dot(h);if(u<0)o=1/0;else{var p=1/(u*i.cst);o=t.scale*e*p}return t.radius=s,t.center=a,o},o}),define("DS/3DXMTiles/DSTilesURLChildLink",["DS/3DXMTiles/DSTilesChildLink"],function(e){"use strict";var t=function(t){e.call(this,t),this.url=t.url};return t.prototype=Object.create(e.prototype),t}),define("DS/3DXMTiles/DSTilesScreenRadiusScoreComputer",["DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesScoreComputer"],function(e,t,n){"use strict";var i=function(e){n.apply(this,arguments)};return i.prototype=Object.create(n.prototype),n.prototype.getSortingMetric=function(){return"screenRadius"},i.prototype.computeScore=function(t,n,i){var o=t.screenRadiusCache,r=t.getBoundingSphere(),s=!1;if(r){o||(o=e.computeScreenRadiusCache(t._getWorldMatrix(),null,r,!1,!1),t.screenRadiusCache=o);var a=n.viewpoint,d=n.cst,h=a.getEyePosition().distanceTo(o.center),l=0;if(h<o.radius||0===h)return l=1/0,t.score=l,void(i&&(t.pixelError=1/0));if(s=a._frustum.performFrustumCullingNoNearFar(o.radius,o.center)){var c=e.computeScreenRadius(o,a.camera,a._frustum,d);l=c>=5?c:-1}t.score=l}else t.score=1/0;t.pixelError=i&&s?this.computePixelError(t.geometricalError,o,n):-1},i}),define("DS/3DXMTiles/DSTilesURLContent",["DS/3DXMTiles/DSTilesContent"],function(e){"use strict";var t=function(){e.call(this),this._url=null,this.childLinks=[]};return(t.prototype=Object.create(e.prototype)).getUrl=function(){return this._url},t.prototype.setUrl=function(e){this._url=e},t}),define("DS/3DXMTiles/DSTilesURLExpander",["DS/3DXMTiles/DSTilesExpander","DS/WAFData/WAFData","DS/3DXMTiles/DSTilesNode","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesURLContent","DS/3DXMTiles/DSTilesURLChildLink"],function(e,t,n,i,o,r){"use strict";var s=function(e){this.childLinks=[],this.modelLoaderHandler=e.modelLoaderHandler,this.scoreComputer=e.scoreComputer,this.baseURL=e.baseURL||"",this._dbg_onLoadedNodeCB=e._dbg_onLoadedNodeCB};return(s.prototype=Object.create(e.prototype)).isReady=function(){return!0},s.prototype.isThereEnoughMemoryToExpand=function(e,t){return!0},s.prototype.expand=function(e,t){var n,i,o=e.content.childLinks,r=o.length;function s(n,o){r--,i++,e.addChild(o,n),t.registerDSTilesNode(o),0===r&&t.onNodeExpanded(e)}function a(n){0===--r?i>0&&t.onNodeExpanded(e):t.onNodeExpandError(e)}for(n=0;n<r;n++)this.loadNodeFromLink(o[n],s.bind(null,n),a,t)},s.prototype.loadNodeFromLink=function(e,n,i,o){var r=this.baseURL+e.url,s=this;t.authenticatedRequest(r,{onComplete:function(t){var i=JSON.parse(t),r=s.createNodeFromJSON(i,o);n(r),s._dbg_onLoadedNodeCB&&s._dbg_onLoadedNodeCB(r,e.url)},onFailure:function(t){i&&i(e)}})},s.prototype.onExpandData=function(e,t,n){var i=this.createNodeFromJSON(n,e.queue);e.addChild(i,t)},s.prototype.createNodeFromJSON=function(e,t){var s=null,a=null,d=0,h=null;e.boundingSphere&&(s=new i.Sphere).setFromJSON(e.boundingSphere),e.boundingBox&&(a=new i.Box3).setFromJSON(e.boundingBox),e.geometricalError&&(d=parseFloat(e.geometricalError)),e.matrix&&(h=new i.Matrix4).setFromJSON(e.matrix);var l,c=null,u=new o;if("model"===e.type&&(c=this.modelLoaderHandler,u.setUrl(e.contentUrl)),e.children)for(l=0;l<e.children.length;l++)u.childLinks.push(new r({url:e.children[l]}));return new n({handler:c,expander:this,scoreComputer:this.scoreComputer,matrix:h,geometricalError:d,boundingBox:a,boundingSphere:s,content:u,queue:t})},s}),define("DS/3DXMTiles/DSTilesHandler",["DS/3DXMTiles/DSTilesNodeMemorySize"],function(e){"use strict";var t=function(){};return t.prototype.isReady=function(){return!0},t.prototype.isThereEnoughMemoryToLoad=function(e,t){return!0},t.prototype.load=function(e,t){setTimeout(t.onLoadError.bind(t,e),0)},t.prototype.computeMemorySize=function(t){return new e(0,0)},t.prototype.removeRepresentation=function(e){},t}),define("DS/3DXMTiles/DSTilesModelLoaderHandlerSingleton",["DS/3DXMTiles/DSTilesHandler","DS/Visualization/ModelLoader","DS/3DXMTiles/DSTilesNodeMemorySize"],function(e,t,n){"use strict";var i=function(){e.call(this),this.nbLoading=0,this.maxNbLoading=10,this.baseURL="";var n=new t;n.setKeepLoaderMode(!0),n.sharedBuffers=!1,this.modelLoader=n};return(i.prototype=Object.create(e.prototype)).isReady=function(){return this.nbLoading<this.maxNbLoading},i.prototype.isThereEnoughMemoryToLoad=function(e,t){return t.isLoadingAllowed()},i.prototype.computeMemorySize=function(e){return new n(0,0)},i.prototype.load=function(e,t){var n=this.modelLoader;this.nbLoading++;var i=this.baseURL+e.content.getUrl(),o=(t.getViewer(),e.getSgNode());n.setSceneGraph(o),n.setFileType("xmlv43"),n.setOnLoadedProductStructureCallback(function(i){n.setTargetNode(null),t.onNodeLoaded(e)}),n.setOnErrorCallback(function(){n.setTargetNode(null),t.onNodeLoadError(e)});var r={filename:i};n.loadModel(r)},i.prototype.removeRepresentation=function(e){e.sgNode&&e.sgNode.removeChildren()},new i}),define("DS/3DXMTiles/DSTilesJSONContent",["DS/3DXMTiles/DSTilesContent"],function(e){"use strict";var t=function(t){e.call(this),this.json=t.json||{}};return t.prototype=Object.create(e.prototype),t}),define("DS/3DXMTiles/DSTilesPointCloudNodeHandlerSingleton",["DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesHandler","DS/Visualization/ModelLoader","DS/3DXMTiles/DSTilesNodeMemorySize","DS/3DXMTiles/PointCloudServices","DS/Mesh/Mesh","DS/Visualization/Mesh3D"],function(e,t,n,i,o,r,s){"use strict";var a=function(){t.call(this),this.nbLoading=0,this.maxNbLoading=10};return(a.prototype=Object.create(t.prototype)).isReady=function(){return this.nbLoading<this.maxNbLoading},a.prototype.isThereEnoughMemoryToLoad=function(e,t){return t.isLoadingAllowed()},a.prototype.computeMemorySize=function(e){return e.content.mesh3D?new i(0,16*e.content.pointsCount):new i(0,0)},a.prototype.load=function(e,t){var n=e.content,i=n.seed,r=i.content;if(e.content.isLOD()){let a=o.loadLODNode(r,n);var s=this;a.then(o=>{e.content.pointsCount=o.points;var a=s.createNode3D(o,r.getLODMaterial(),e,!0);n.mesh3D=a,i.getSgNode().addChild(a),t.onNodeLoaded(e)}).catch(function(){t.onNodeLoadError(e)})}else{let a=o.loadNode(r,n);s=this;a.then(o=>{e.content.pointsCount=o.points;var a=s.createNode3D(o,r.getNodeMaterial(),e);n.mesh3D=a,i.getSgNode().addChild(a),t.onNodeLoaded(e)}).catch(function(){t.onNodeLoadError(e)})}},a.prototype.createNode3D=function(t,n,i,o){null!=this.geometry&&console.error(this.toString()+":geometry exist already !");var a=new e.BufferGeometryDS;if(a.noMeshInRAM=!0,a.buffers[0]=t.buffer,t.attributes.constructor===Array)for(let e of t.attributes)"position"===e.name&&3===e.count&&12===e.size?a.layout.set({ptPosition:{type:"float32x3",offset:e.offset,stride:16,bufferId:0}}):"color"===e.name&&4===e.count&&4===e.size?a.layout.set({ptCol:{type:"unorm8x3",offset:e.offset,stride:16,bufferId:0},ptSize:{type:"unorm8",offset:e.offset+3,stride:16,bufferId:0}}):console.error("Unknown attribute: "+e);else for(let e in t.attributes){const n=t.attributes[e];"position"===e&&(e="ptPosition"),a.layout.setAttribute(Object.assign({name:e},n,{bufferId:0}))}a.boundingBox=i.getBoundingBox().clone(),a.boundingSphere=i.getBoundingSphere().clone();let d=new r.DrawingGroup(null,n,0,0,t.points);d.geometry=a,d.nonIndexed=!0,a.drawingGroups=[d];let h=new e.Mesh(a,n);h.hasPoint=!0,h.frustumCulled=!1;var l=new s(void 0,"OOCNode");if(l.geometry=h,l.explicitBSphere.copy(a.boundingSphere),l.explicitBBox.copy(a.boundingBox),l.setUserData({dsTilesNode:i}),o){var c=i.content.seed.children[0].getBoundingBox(),u=[.5*(c.max.x+c.min.x),.5*(c.max.y+c.min.y),.5*(c.max.z+c.min.z)],p=(new e.Matrix4).makeTranslation(u[0],u[1],u[2]);l.applyMatrix(p)}var f=l._occurrences[0];return f.renderable=l.geometry,f.renderable.name=l.name,f.renderable._occurrence=f,l},a.prototype.removeRepresentation=function(e){e.content.seed.sgNode&&e.content.mesh3D&&(e.content.seed.sgNode.removeChild(e.content.mesh3D),e.content.mesh3D=null)},new a}),define("DS/3DXMTiles/DSTilesPointCloudNodeContent",["DS/3DXMTiles/DSTilesContent","DS/3DXMTiles/PointCloudServices"],function(e,t){"use strict";var n=function(n){e.call(this);var i=t.bigIntZero;this.id=i,this.code=i,this.depth=0,this.points=i,this.firstPoint=i,this.oocChildren=[],this.lodId=0,this.seed=null,this.mesh3D=null};return(n.prototype=Object.create(e.prototype)).isLOD=function(){var e=this.seed.content.maxDepth;return this.depth<=e&&this.points>65536&&0!==this.oocChildren.length},n}),define("DS/3DXMTiles/DSTilesR2VPointCloudContentLoader",["DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesNodeMemorySize","DS/Visualization/Node3D","DS/3DXMTiles/PointCloudServices","DS/Mesh/Mesh","DS/Visualization/Mesh3D","DS/3DXMTiles/LDHStats","DS/3DXMTiles/DSTilesR2VOctree"],function(e,t,n,i,o,r,s,a){"use strict";var d=function(e){this.rootSGNode=e.targetSGNode,this.buildUrlCB=e.buildUrlCB,this.budget=null,this._nodeMaterial=null,this._LODMaterial=null;let t=parseFloat(window.localStorage.getItem("OOCMinPointSize"))||4,n=parseFloat(window.localStorage.getItem("OOCMaxPointSize"))||255,i=parseFloat(window.localStorage.getItem("OOCMinLODPointSize"))||4,o=parseFloat(window.localStorage.getItem("OOCMaxLODPointSize"))||6;this._ptMinSize=t,this._ptMaxSize=n,this._LODMinSize=i,this._LODMaxSize=o,this._maxSpacing=0,this.nbTickets=10,this.materialsInitialized=!1,this._dbgNoPickParent=!!window.OOCTilesNoPickParent};d.prototype.init=function(e){this.budget=e.memoryManager.createBudget("pointCloud","gpu",{maxLimit:251658240})},d.prototype.isReady=function(){return this.nbTickets>0},d.prototype.isThereEnoughMemoryToLoad=function(e,t){return t.isLoadingAllowed()},d.prototype.getBudget=function(){return this.budget},d.prototype.loadContentFromBuffer=function(e,t,n,o){var r=t.queue;if(0===this._maxSpacing){var a=t.getBoundingBox(),d=a.min.distanceTo(a.max)/1e3;this._maxSpacing=d}var l=new h(t,r),c=t.tileSet,u=t.content.getUri(),p=(this.buildUrlCB?this.buildUrlCB(u):c.buildContentURL(u),i.createTileContentFromBuffer(e));if(p){s.onLoadedModel(0);var f=p.geometry,g=p.version;this.materialsInitialized||(2!==g&&console.log("bad r2v version"),this.initMaterialsV2()),this.materialsInitialized=!0,this._maxSpacing=f.spacing,this._nodeMaterial.updatePDSFXUniform("uMaxSpacing",this._maxSpacing),this.setupNode3D(l,f),l.computeMemorySize(),this.budget.updateUsage(0,l.size),n()}else o()},d.prototype.setupNode3D=function(e,t){var n,i=e.node;e.queue;i.isAlive()&&(e.size=t.buffer.byteLength,n=i.isLeaf()?this.getNodeMaterial():this.getLODMaterial(),e.mesh3D=this.createNode3D(t,n,i,!0),e.node.setContentToken(e))},d.prototype.getOctreeFromContent=function(e){var t=this.octreeMap.get(e.root);return t||(t=new a({tileNode:e.root}),this.octreeMap.set(e.root,t)),t},d.prototype.showContent=function(e){var t=e.mesh3D,n=e.node,i=n.getSgNode();0===t.parents.length&&i.addChild(t),e.mesh3D.setVisibilityFree(!1),this._dbgNoPickParent||t.setPickParent(!0),t.excludeFromPSO(!0),t.setVisibility(!0)},d.prototype.hideContent=function(e){e.mesh3D.setVisibilityFree(!0),e.mesh3D.setVisibility(!1)},d.prototype.deleteContent=function(e){e.node.getSgNode().removeChild(e.mesh3D),e.mesh3D=null,this.budget.updateUsage(e.size,0)},d.prototype.exportContent=function(e){return[e.mesh3D]},d.prototype.createNode3D=function(t,n,i,s){null!=this.geometry&&console.error(this.toString()+":geometry exist already !");var a=new e.BufferGeometryDS;if(a.noMeshInRAM=!0,a.buffers[0]=t.buffer,t.attributes.constructor===Array)for(let e of t.attributes)"position"===e.name&&3===e.count&&12===e.size?a.layout.set({position:{type:"float32x3",offset:e.offset,stride:16,bufferId:0}}):"color"===e.name&&4===e.count&&4===e.size?a.layout.set({ptCol:{type:"unorm8x3",offset:e.offset,stride:16,bufferId:0},ptSize:{type:"unorm8",offset:e.offset+3,stride:16,bufferId:0}}):console.error("Unknown attribute: "+e);else for(let e in t.attributes){const n=t.attributes[e];a.layout.setAttribute(Object.assign({name:e},n,{bufferId:0}))}a.boundingBox=i.getBoundingBox().clone(),a.boundingSphere=i.getBoundingSphere().clone();let d=new o.DrawingGroup(null,n,0,0,t.points);d.geometry=a,d.nonIndexed=!0,a.drawingGroups=[d];let h=new e.Mesh(a,n);h.hasPoint=!0;var l=new r(h,"OOCNode");l.explicitBSphere.copy(a.boundingSphere),l.explicitBBox.copy(a.boundingBox),l.setUserData({dsTilesNode:i}),l.setFrustumCulled(!1);i._getWorldMatrix();return l},d.prototype.getNodeMaterial=function(){return this._nodeMaterial},d.prototype.getLODMaterial=function(){return this._LODMaterial},d.prototype.initMaterialsV2=function(){this._nodeMaterial=new e.ParticleBasicMaterial({force:!0}),this._nodeMaterial.activatePDSFX();let t=["attribute vec3 ptCol;","attribute float ptSize;"].join("\n"),n=["vec3 temperature( float iT, float iMinRamp, float iMaxRamp ) {","float t_clamp = clamp(iT, iMinRamp, iMaxRamp);","float t = 0.0;","if(iMinRamp < iMaxRamp)","t = (t_clamp - iMinRamp) / (iMaxRamp - iMinRamp);","else {","return vec3(1.0,0.0,0.0);","}","float b = t < 0.25 ? smoothstep( -0.25, 0.25, t ) : 1.0 - smoothstep( 0.25, 0.5, t );","float g = t < 0.5 ? smoothstep( 0.0, 0.5, t ) : ( t < 0.75 ? 1.0 : 1.0 - smoothstep( 0.75, 1.0, t ) );","float r = smoothstep( 0.5, 0.75, t );","return vec3( r, g, b );","}","int modi( int x, int y ) { ","return x - y * ( x / y );","}"].join("\n");this._nodeMaterial.setPDSFXGlobalShaderCode(t,n);let i={uMinRamp:{type:"f",value:0},uMaxRamp:{type:"f",value:1},uMinPtSize:{type:"f",value:this._ptMinSize},uMaxPtSize:{type:"f",value:this._ptMaxSize},uMaxSpacing:{type:"f",value:this._maxSpacing},uDPR:{type:"f",value:e.getDevicePixelRatio()}};this._nodeMaterial.setPDSFXUniforms(i);this._nodeMaterial.setPDSFXVaryings({vScalar:{type:"f"},oocColor:{type:"v3"}});let o={ComputeVaryingValues:"void ComputeVaryingValues() { oocColor = pow( ptCol, vec3(2.2) ); }",ComputePointSize:["float ComputePointSize() {","   vec4 p = computeModelViewPosition(vec4( vGetAttribPosition(), 1.0 ));","   float spacingScale = ptSize*length(modelMatrix[0]);","   float spacing = spacingScale * uMaxSpacing;","   mat4 projMatrix = vGetProjectionMatrix();","   float topBottomComposant = projMatrix[1][1];","   float pixelSpacingProjection = (spacing)*float(vGetViewportSize().y)*(topBottomComposant/2.0);","   float perspectiveComposant = projMatrix[2][3];","   float orthographicComposant = projMatrix[3][3];","   float spacingInPixels = pixelSpacingProjection * ( perspectiveComposant/p.z + orthographicComposant);","spacingInPixels *= 1.3;","   return clamp( spacingInPixels, uMinPtSize, uMaxPtSize ) * uDPR;","}"].join("\n")};this._nodeMaterial.setPDSFXOverridableFunctions(o,{ComputeAlbedo:"vec3 ComputeAlbedo() { return oocColor; }"}),this._LODMaterial=this._nodeMaterial},d.prototype.needsSgNodePerContent=function(){return!1};var h=function(e,t){this.node=e,this.queue=t,this.mesh3D=null,this.size=0};return h.prototype.updateRootAndDepth=function(){var e=this.node;this.root=this.node,this.depth=-1;do{this.depth++,this.root=e,e=e.parent}while(e)},h.prototype.computeMemorySize=function(){return new t(0,this.size)},d}),define("DS/3DXMTiles/DSTilesMeshContentLoader",["DS/3DXMTiles/DSTilesNodeMemorySize","DS/3DXMTiles/ModelLoaderSingleton","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/3DXMTiles/3DXMTilesUtils"],function(e,t,n,i,o){"use strict";var r=function(e){e=e||{},this.budget=null,this.buildUrlCB=e.buildUrlCB};r.prototype.init=function(e){this.budget=e.memoryManager.createBudget("mesh","gpu",{})},r.prototype.getBudget=function(){return this.budget},r.prototype.isReady=function(){return t.isReady()},window.nodesToContent=[],r.prototype.loadContentFromBuffer=function(e,n,i,o){e&&window.nodesToContent.push(n);var r=n.queue,a=new s(n,r);t.loadFromBuffer(e,a.targetSGNode,n.content.getFormat(),this.onModelLoaded.bind(this,a,i),this.onModelError.bind(this,a,o))},r.prototype.onModelLoaded=function(e,t){var n=e.node;e.queue;n.isAlive()&&(e.node.setContentToken(e),e.computeMemorySize(),this.budget.updateUsage(0,e.geometrySize),t())},r.prototype.onModelError=function(e,t){e.node,e.queue;t()},r.prototype.getBudgetId=function(){return"mesh"},r.prototype.showContent=function(e){var t,n,i=e.node,o=e.targetSGNode,r=i.getSgNode();for(e.nodes.length=0,n=0;n<o.children.length;n++)t=o.children[n],r.addChild(t),e.nodes.push(t);o.removeChildren()},r.prototype.hideContent=function(e){var t,n,i=e.node,o=e.targetSGNode,r=i.getSgNode();for(n=0;n<e.nodes.length;n++)t=e.nodes[n],r.removeChild(t),o.addChild(t)},r.prototype.deleteContent=function(e){this.hideContent(e),this.budget.updateUsage(e.geometrySize,0),e.targetSGNode=null,e.geometrySize=0},r.prototype.exportContent=function(e){return e.nodes.length>0?[].concat(e.nodes):[].concat(e.targetSGNode.children)},r.prototype.needsSgNodePerContent=function(){return!0};var s=function(e,t){this.node=e,this.queue=t,this.targetSGNode=new n,this.nodes=[],this.visible=!1,this.geometrySize=0};return s.prototype.computeMemorySize=function(){this.geometrySize=o.computeMeshSize(this.targetSGNode)},r}),define("DS/3DXMTiles/BSScreenSizeLODSelector",["DS/3DXMTiles/LODSelector","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";new t.Vector3,new t.Matrix4;var n=e.extend({init:function(){this._parent(),this.type="BSScreenSize",this._debug_screenSize=-1},computeLOD:function(e,t){e.computeScreenRadius(t);var n=this._debug_screenSize>=0?this._debug_screenSize:t.pixelCulling;return e._screenRadius>=n?1:0},getLOD:function(e,t){return e>=(this._debug_screenSize>=0?this._debug_screenSize:t.pixelCulling)?1:0}});return n.createFromJSON=function(e){var t=e.screenSize;return new n(parseFloat(t))},n}),define("DS/3DXMTiles/LDHReference",["DS/3DXMTiles/BSScreenSizeLODSelector","DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/Mesh3D","DS/3DXMTiles/LDHOccurrence","DS/Visualization/ThreeJS_R57","DS/Visualization/Node3D","DS/3DXMTiles/Debug3DXMTiles","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/LDHHandler","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/3DXMTiles/LDHReferenceUnloadStatus","DS/3DXMTiles/LDHOcclusionStatus","DS/Visualization/SceneGraphFactory","DS/3DXMTiles/AsyncCaller","DS/3DXMTiles/LDHSwitchRepresentationData","DS/Visualization/PLMMaterialConnectionFactory"],function(e,t,n,o,r,s,a,d,h,l,c,u,p,f,g,m,y,v){"use strict";var M=1,S=1,L=2,D=4,T=8,R=16,x=24,C=32,w=64,b=128,N=256,_="requested",I="none",B="slave",O=new e,U=function(e,t,n){this.reference=e,this.node=null,this.matrix=t,this.instanceId=n,this.userData=null},P=-1,A=localStorage.getItem("OOCBoxDebug"),E=new Map,k=function(e){-1===P&&(P=window.OOCForceBoundingSphere?1:0),this.id=M++,this._occurrences=[],this._rep=null,this._boundingSphere=e.boundingSphere,this._boundingBox=e.boundingBox,this.updateBoundingSphere(),this.handler=e.handler,this._screenRadiusCache=[],this._screenRadius=0,this._rep=null,this.children=[],this._status=d.waiting,this._optional=null,this.parents=[],this.referenceId=e.referenceId,this.userData=null,this.unloadLockCounter=0,this.inListStatus=0,this.occlusionId=-1,this._occlusionScore=0,this.isRoot=!1,A&&(this.byteSize=0),this.memoryData=new z,this.sgFlag=e.leaf?B:I,v.hasLegacyUV(e.referenceId)&&this.setLegacyUV(),this.updateMemorySizeNEW(e.manager)};k.prototype.isLoading=function(){return this._status===d.loading},k.prototype.isToUnload=function(){return this._status===d.toUnload},k.prototype.isToLoad=function(){return this._status===d.toLoad},k.prototype.shouldBeExpanded=function(){return this._status!==d.dead&&(!(!this._rep||this._rep.active)||this._status!==d.error&&(this._status!==d.error&&!this.isRepLoaded()))},k.prototype.hasGoodRep=function(){return this._rep&&this._rep.active},k.prototype.setIsRoot=function(e,t){e!==this.isRoot&&(this.isRoot=e,e?this._rep.node&&t.targetNode.addChild(this._rep.node):this._rep.node&&t.targetNode.removeChild(this._rep.node))},k.prototype.getNbOccurrences=function(){return this.getOccurrences().length},k.prototype.hasNode3D=function(){return!(!this._rep||!this._rep.node)},k.prototype.getOccurrences=function(){return this.hasNode3D()?this._rep.node?this._rep.node._occurrences:null:this._occurrences},k.prototype.getLDHOccurrences=function(){return this._occurrences},k.prototype.isComplete=function(){return this.isLoaded()},k.prototype.isLoaded=function(){return this._status===d.loaded},k.prototype.forceLoad=function(e,t,n){var i=this.isForced();this._optional||(this._optional=new q),e?(this._optional._force||(this._optional._force=new G),!this.isLoading()&&this.isRepLoaded()&&(this.isLoaded()||this.isToUnload())&&this.hasGoodRep()?(m.call(t),this._optional._force=new G):this._optional._force.onForce(t)):this._optional._force=null;var o=this.isForced();i!==o&&(o?this.lockUnload(void 0,void 0,!0):this.unlockUnload(void 0,void 0,void 0,!0),n.registerTilesNode(this))},k.prototype.getMeshInRAM=function(){var e=this.getActiveRepresentation();return!!e&&!e.noMeshInRAM},k.prototype.setOverrideCB=function(e,t,n){t&&!this._optional&&(this._optional=new q),this._optional&&(this._optional.setOverride(e,t),this.updateOverride(n))},k.prototype.hasOverrideCB=function(e){return!!this._optional&&this._optional.hasOverride(e)},k.prototype.removeParentFromParentsArray=function(e){var t,n=0;for(t=0;t<this.parents.length;t++)this.parents[t]!==e&&(this.parents[n]=this.parents[t],n++);this.parents.length=n},k.prototype.removeParent=function(e,t){var n;t||this.removeParentFromParentsArray(e);var i,o=0;for(i=0;i<this._occurrences.length;i++)(n=this._occurrences[i]).parent&&n.parent.reference!==e?(this._occurrences[o]=n,o++):n.parent=null;this._occurrences.length=o,this.unloadLockCounter>0&&this.unlockUnload(this.unloadLockCounter,e)},k.prototype.removeChild=function(e,t){var n,i,o,r=0;for(n=0;n<this.children.length;n++)(o=this.children[n]).reference===e?(i=o.instanceId,t._unregisterInstance(i)):(this.children[r]=o,r++);this.children.length=r,this.updateMemorySizeNEW(t._ldhNodeManager)},k.prototype.removeFromParents=function(e){var t;for(t=0;t<this.parents.length;t++)this.parents[t].removeChild(this,e),this.removeParent(this.parents[t],!0);this.parents=[]},k.prototype.unregister=function(e){this.isAlive()&&e._unregisterReference(this.referenceId)},k.prototype.addToOcclusionChecker=function(e){if(!e.hasReference(this)){var t,n=[];if(this.hasNode3D()){var i,o=this._rep.node._occurrences;for(t=0;t<o.length;t++)i=o[t],n.push(i.matrix)}else{var r,s=this._occurrences;for(t=0;t<s.length;t++)r=s[t],n.push(r.matrix)}var a=this.getBoundingBox();this.occlusionId=e.addBox(a,n),e.addReference(this)}},k.prototype.setStatus=function(e,t){if(this._status!==d.dead){var n=this._status!==e;this._status=e,n&&t.registerTilesNode(this)}},k.prototype.setLoading=function(e){this.setStatus(d.loading,e)},k.prototype.hasUnloadFrozenParent=function(){return 0!==this.parents.length&&this.parents[0].isUnloadFrozen()},k.prototype.isUnloadFrozen=function(){return this._status===d.freezeUnload},k.prototype.isLeaf=function(){return this.handler.type===h.Model3DHandler||this.handler.type===h.TileSetHandler},k.prototype.freezeUnload=function(){this.traverse(function(e){return!(!e.isLeaf()&&!e.isUnloadFrozen())||(e._status=d.freezeUnload,!1)})},k.prototype.buildFlatList=function(){var e=[];this.traverse(function(t){return!(t.id>0)||(t.id*=-1,e.push(t),!1)});var t=0;for(t=0;t<e.length;t++)e[t].id*=-1;return e},k.prototype.addReferenceChild=function(e,t,n,i,r){var s,a,d=new U(e,t,n),h=this._occurrences.length;for(s=0;s<this._occurrences.length;s++)if(a=this._occurrences[s],new o({reference:e,matrix:t,manager:r,node:null,parent:a,instanceData:d},i),this._occurrences.length>h)return!1;return this.children.push(d),e.unloadLockCounter>0&&e.lockUnload(e.unloadLockCounter),-1===e.parents.indexOf(this)&&e.parents.push(this),null!==e._rep.node&&this.requestBuildSceneGraphHierarchy(!0),this.isLegacyUV()&&e.setLegacyUV(),this.updateMemorySizeNEW(r),!0},k.prototype.getOccurrencesFromInstanceId=function(e){var t,n=[];for(i=0;i<this._occurrences.length;i++)(t=this._occurrences[i]).instanceId===e&&n.push(t);return n},k.prototype.detachReference=function(e,t,n,i,o){var r,s,a,d,h,l=[],c=[],u=[];if(a=0,null===e){for(r=0;r<this._occurrences.length;r++)u=u.concat(this._occurrences[r].getChildren());if(0===this._occurrences.length&&o){var p=this;this.traverse(function(e){if(e!==p){if(e._occurrences.length>0)return!0;o.add(e)}})}if(l=this.children,n)for(r=0;r<l.length;r++)c.push(l[r].instanceId),l[r].reference.removeParentFromParentsArray(this);this.children=[]}else{for(d=!1,r=0;r<this.children.length;r++)(s=this.children[r]).reference!==e||null!==t&&s.instanceId!==t?(this.children[a]=this.children[r],s.reference===e&&(d=!0),a++):(l.push(s),c.push(s.instanceId));for(this.children.length=a,r=0;r<e._occurrences.length;r++)(h=e._occurrences[r]).parent.reference!==this||null!==t&&h.instanceData.instanceId!==t||-1!==u.indexOf(h)||u.push(h)}var f=new Set;for(r=0;r<u.length;r++)(h=u[r]).detach(f);f.forEach(function(e){e._removeNullsFromOccurrenceList(),o&&0===e._occurrences.length&&o.add(e)});var g=i._ldhNodeManager,m=this.getNode();for(r=0;r<l.length;r++){s=l[r],m&&m.removeChild(s.node);var y=s.reference.getNode();s.node&&(s.node.removeChild(y),s.node=null)}if(0===this.children.length&&this.removeFromSceneGraph(!1,g),!d&&e&&n){for(a=0,r=0;r<e.parents.length;r++)e.parents[r]!==this&&(e.parents[a]=e.parents[r],a++);e.parents.length=a}if(null!==t)i._unregisterInstance(t);else for(r=0;r<c.length;r++)i._unregisterInstance(c[r])},k.prototype.updateInstance=function(e,t,n){var i=this.getChild(e);t.instanceId&&(i.instanceId=t.instanceId,i.node&&i.node.setModelIdentification(t.instanceId)),t.matrix&&(i.node&&i.node.setMatrix(t.matrix),i.matrix?i.matrix.copy(t.matrix):i.matrix=t.matrix.clone(),this.updateOccurrencesPosition(n,i.instanceId))},k.prototype.addOnLoadedCB=function(e){this._optional||(this._optional=new q),this._optional.addOnLoadedCB(e)},k.prototype._onLoaded=function(){this._optional&&this._optional._force&&this._optional._force.onLoaded(),this._optional&&this._optional.onLoaded()},k.prototype._onOccluded=function(){this._optional&&this._optional.onLoaded()},k.prototype.computeLODValue=function(e){e.viewpoint,e.cst;var t=O.computeLOD(this,e);return null===this._boundingSphere&&(t=1),t},k.prototype.getLODValue=function(e){return O.getLOD(this._screenRadius,e)};var H=[];function z(){this.memory=0,this.memoryGPU=0,this.memoryMeshInRAM=0}k.prototype.computeScreenRadius=function(e){var n=e.cst,i=e.viewpoint,o=this.hasNode3D();if(this._topLoadPriority)return this._screenRadius=1/0,this._screenRadius;if(this._boundingSphere){var r,s,a,d,h,l=-1/0,c=0,u=this._screenRadiusCache;if(o){for(r=this._rep.node._occurrences,H.length=r.length,h=0;h<r.length;h++)H[h]=r[h].matrix;if(u){var p=!1;for(u.length!==r.length&&(p=!0),h=0;!p&&h<r.length;h++)(d=u[h]).positionHasChanged(r[h].matrix)&&(p=!0)}p&&(u=[],this._screenRadiusCache=u)}else for(s=this._occurrences,H.length=s.length,h=0;h<s.length;h++)H[h]=s[h].matrix;for(h=0;h<H.length;h++){var f=H[h];c>=u.length?(d=t.computeScreenRadiusCache(f,null,this._boundingSphere,void 0,o),u.push(d)):d=u[c],c++,l<(a=t.computeScreenRadius(d,i.camera,i._frustum,n))&&(l=a)}return this._screenRadius=l,l}return this._screenRadius=1,1},k.prototype.getAllMatrices=function(){var e,t,n,i=[];if(this.hasNode3D())for(t=this._rep.node._occurrences,i.length=t.length,e=0;e<t.length;e++)i[e]=t[e].matrix;else for(n=this._occurrences,i.length=n.length,e=0;e<n.length;e++)i[e]=n[e].matrix;return i},k.prototype.getScreenRadiusCache=function(e){var n=null,i=this.hasNode3D(),o=this.getBoundingSphere();if(o){var r,s,a,d;if(n=this._screenRadiusCache,i){for(a=this._rep.node._occurrences,e.length=a.length,s=0;s<a.length;s++)e[s]=a[s].matrix;if(n){var h=!1;for(n.length!==a.length&&(h=!0),s=0;!h&&s<a.length;s++)(r=n[s]).positionHasChanged(a[s].matrix)&&(h=!0)}h&&(n=[],this._screenRadiusCache=n)}else for(d=this._occurrences,e.length=d.length,s=0;s<d.length;s++)e[s]=d[s].matrix;for(s=n.length;s<e.length;s++){var l=e[s];0>=n.length&&(r=t.computeScreenRadiusCache(l,null,o,void 0,i),n.push(r))}}return n},k.prototype.isCollidingWithBox=function(e,t,n,i){var o,r,s=this.getScreenRadiusCache(i),a=!1,d=null;if(s)for(o=0;o<s.length;o++)if(r=s[o],n.center.x=r.center.x,n.center.y=r.center.y,n.center.z=r.center.z,n.radius=r.radius,t.intersectsSphere(n)&&(a||(a=!0,d=this.getBoundingBox()),d&&e.isIntersectingWith(d,i[o])))return!0;return!1},k.prototype.updateNodeLOD=function(e){var t;return this.isForced()?(t=1,this._screenRadius=1/0):t=this.computeLODValue(e),t},k.prototype.dumpAnyPath=function(){console.log(this.url),this.father[0]&&this.father[0].dumpAnyPath()},z.prototype.set=function(e){if(e.isAlive()){var t=e.getMeshSize();if(e.handler.type===h.Model3DHandler)this.memory=0;else{var n=e._rep&&e._rep.node,i=0;n&&(i=824+280*(n._occurrences.length-1)),this.memory=232+336*e._occurrences.length+336*e.children.length+i}this.memoryMeshInRAM=e._rep&&!e._rep.noMeshInRAM?t:0,this.memoryGPU=t}},z.prototype.equals=function(e){return this.memory===e.memory&&this.memoryGPU===e.memoryGPU&&this.memoryMeshInRAM===e.memoryMeshInRAM},z.bank=new Map,z.getFromBank=function(e){var t=null;if(0!==e.memory)if(t=z.bank.get(e.memory)){if(e.equals(t))return t}else z.bank.set(e.memory,e);return e},k.prototype.computeMemoryData=function(e){var t=null;return(t=new z).set(this),t=z.getFromBank(t)},k.prototype.getMeshSize=function(){return this._rep?this._rep.getMeshSize():0},k.prototype.updateMemorySizeNEW=function(e){var t=this.memoryData,n=e.unloadManager,i=this.computeMemoryData(),o=!1;if(0===this.handler.type){o=this.getMeshInRAM();var r=this.getLDHNodeManagerQueue(e);this.getMeshSize()>0&&r.memorizeReferenceSize(this.referenceId,this.getMeshSize())}n.onReferenceMemoryDataChange(t,i,o),this.isAlive()||E.delete(this),this.memoryData=i},k.prototype.requestBuildSceneGraphHierarchy=function(e){if(this.sgFlag===I){var t,n=e||!1;for(t=0;t<this.children.length&&!n;t++)this.children[t].reference.sgFlag!==I&&(n=!0);if(n)for(this.setSGFlag(_),t=0;t<this.parents.length;t++)this.parents[t].requestBuildSceneGraphHierarchy(!0)}},k.prototype.setSGFlag=function(e){this.sgFlag=e},k.prototype.tryBuildSceneGraphHierarchy=function(e,t){var n,i,o;if(this.sgFlag===_){this.clearScreenRadiusCache();var r=!!this._rep.node;if(!this._rep.node){if(this._rep.node=new s,this.userData&&this._rep.node.setUserData(this.userData),this._rep.node.setModelIdentification(this.referenceId),this._rep.node.setNodeUsage(this.handler.getNodeUsage()),this._boundingSphere&&P&&this._rep.node.forceBoundingElements(!0,{sphere:this._boundingSphere},null),this.isRoot&&(t.targetNode.addChild(this._rep.node),1===this._occurrences.length)){var a=this._occurrences[0];a.instanceData.matrix&&this._rep.node.setMatrix(a.instanceData.matrix)}this._optional&&this._optional.hasOverride()&&e.push(this),t.oocManager._onNodeCreate(this._rep.node)}for(n=0;n<this.children.length;n++)(o=(i=this.children[n]).reference).tryBuildSceneGraphHierarchy(e,t),!i.node&&o._rep.node&&(i.node=new s,i.userData&&i.node.setUserData(i.userData),i.node.setModelIdentification(i.instanceId),i.node.setNodeUsage(s.INSTANCE_NODE),t.oocManager._onNodeCreate(i.node),i.node.setMatrix(i.matrix),i.node.addChild(o._rep.node),this._rep.node.addChild(i.node));this.setSGFlag(I),this._rep.node&&!r&&this._optional&&this._optional.onAddedToSceneGraphCB&&this._optional.onAddedToSceneGraphCB.call(void 0,this.referenceId),this.updateMemorySizeNEW(t)}},k.prototype.recursiveUpdateMemorySize=function(e){if(0===this.handler.type)this.updateMemorySizeNEW(e);else{var t,n=this.buildFlatList();for(t=0;t<n.length;t++)n[t].updateMemorySizeNEW(e)}},k.prototype.updateOverride=function(e){var t=this._optional;t&&t.overrideData&&(t.overrideData.updateOverride(e,this._rep.node,this.referenceId),t.overrideData.isEmpty()&&(t.overrideData=null))},k.prototype.removeRepresentationChildren=function(e){if(-1===k.useRepNodeName&&(k.useRepNodeName=window.OOCEnableRepNodeName?1:0),e){var t,n,i=e.children;for(t=i.length-1;t>=0;t--)n=i[t],1===k.useRepNodeName?n.name===k.RepNodeName&&e.removeChild(n):k.RepNodeSet.has(n.id)&&(e.removeChild(n),k.RepNodeSet.delete(n.id))}},k.prototype.removeFromSceneGraph=function(e,t){if(this.isSlave())t.unloadLeafReferenceCB(this.referenceId);else{if(this.clearScreenRadiusCache(),0===this.parents.length&&!this.isLeaf())return;if(null!==this._rep.node)if(this.isUnloadLocked())e&&this.removeRepresentationChildren(this._rep.node);else{var n,i,o=t.oocManager;if(this._rep.node.children.length>0)for(this._rep.node.removeChildren(),n=0;n<this.children.length;n++)(i=this.children[n]).node&&(i.node.removeChildren(),i.node=null);if(this.parents.length>0){var r,s,a=this._rep.node.parents.concat([]);for(n=0;n<a.length;n++)s=(r=a[n]).parents[0],r.removeChild(this._rep.node),s.removeChild(r),o._onNodeRemove(r);for(n=0;n<this.parents.length;n++)this.parents[n].removeChildNode(this,t),this.parents[n]._rep.node&&0===this.parents[n]._rep.node.children.length&&this.parents[n].removeFromSceneGraph(!1,t)}o._onNodeRemove(this._rep.node),this._rep.node=null,this._optional&&this._optional.onRemovedFromSceneGraphCB&&this._optional.onRemovedFromSceneGraphCB.call(void 0,this.referenceId)}}this.setRepLoaded(!1),this._rep.updateMeshSize(this),this.updateMemorySizeNEW(t),this.updateOverride(t)},k.prototype.removeChildNode=function(e,t){var n,i;for(n=0;n<this.children.length;n++)(i=this.children[n]).reference===e&&(i.node=null);this.updateMemorySizeNEW(t)},k.prototype.getChildInstanceNode=function(e){var t,n;for(t=0;t<this.children.length;t++)if((n=this.children[t]).instanceId===e)return n.node;return null},k.prototype.traverse=function(e){var t;if(!e(this))for(t=0;t<this.children.length;t++)this.children[t].reference.traverse(e)},k.prototype.traverseParents=function(e,t){if(!t.has(this)){var n=new Set;n.add(this),this.traverseParents_internal(e,t,n)}},k.prototype.traverseParents_internal=function(e,t,n){var i,o;for(e(this),i=0;i<this.parents.length;i++)o=this.parents[i],n.has(o)||t&&t.has(o)||(n.add(o),o.traverseParents_internal(e,t,n))},k.prototype.createJSON=function(){var e={references:[]};this.traverse(function(e){e.visited=!1});var t,n,i,o,r=0;for(this.traverse(function(t){if(!t.visited){t.visited=!0,t.jsonIndex=r++;var n=t.createJSON_internal();e.references.push(n)}}),t=0;t<e.references.length;t++)for(i=e.references[t],n=0;n<i.c.length;n++)(o=i.c[n]).r=o.r.jsonIndex;return e},k.prototype.createJSON_internal=function(){var e,t,n,i={url:this.url,bs:this._boundingSphere?this._boundingSphere.createJSON():null,i:!!this._rep.node,c:[]};for(e=0;e<this.children.length;e++)t=this.children[e],(n={}).m=t.matrix.createJSON(),n.r=t.reference,n.i=!!t.node,i.c.push(n);return i},k.prototype._removeOccurrenceFromList=function(e){var t=this._occurrences.indexOf(e);t<0?console.log("Internal inconsistency"):this._occurrences[t]=null},k.prototype._removeNullsFromOccurrenceList=function(){var e,t=0;for(e=0;e<this._occurrences.length;e++){var n=this._occurrences[e];n&&(this._occurrences[t]=n,t++)}this._occurrences.length=t},k.prototype._isDetachPossible=function(){return 0===this._occurrences.length},k.prototype._detach=function(){if(-1===k.useRepNodeName&&(k.useRepNodeName=window.OOCEnableRepNodeName?1:0),this._rep.node){var e,t,n=this._rep.node.parents;for(e=0;e<n.length;e++){n[e].removeChild(this._rep.node)}if(0===k.useRepNodeName)for(e=0;e<this._rep.node.children.length;e++)t=this._rep.node.children[e],k.RepNodeSet.delete(t.id);this._rep.node.removeChildren(),this._rep.node=null}this.children=[],this.parents=[]},k.prototype.isWaiting=function(){return this._status===d.waiting},k.prototype.isUnknown=function(){return!this._boundingSphere&&!this.isLoaded()},k.prototype.isForced=function(){return!(!this._optional||!this._optional._force)},k.prototype.setOnRemovedFromSceneGraphCB=function(e){this._optional||(this._optional=new q),this._optional.onRemovedFromSceneGraphCB=e,!this._rep.node&&e&&e.call(void 0,this.referenceId)},k.prototype.setOnAddedToSceneGraphCB=function(e){this._optional||(this._optional=new q),this._optional.onAddedToSceneGraphCB=e,this._rep.node&&e&&e.call(void 0,this.referenceId)},k.prototype.isInList=function(){return!!(this.inListStatus&S)},k.prototype.setInList=function(e){this.inListStatus=e?this.inListStatus|S:this.inListStatus&65535-S},k.prototype.isInToBeLoaded=function(){return!!(this.inListStatus&L)},k.prototype.setInToBeLoaded=function(e){this.inListStatus=e?this.inListStatus|L:this.inListStatus&65535-L},k.prototype.isInLoaded=function(){return!!(this.inListStatus&D)},k.prototype.setInLoaded=function(e){this.inListStatus=e?this.inListStatus|D:this.inListStatus&65535-D},k.prototype.isInForced=function(){return!!(this.inListStatus&T)},k.prototype.setInForced=function(e){this.inListStatus=e?this.inListStatus|T:this.inListStatus&65535-T},k.prototype.isInUnknown=function(){return!!(this.inListStatus&R)},k.prototype.isInHighPriority=function(){return!!(this.inListStatus&x)},k.prototype.setInUnknown=function(e){this.inListStatus=e?this.inListStatus|R:this.inListStatus&65535-R},k.prototype.setOcclusionVisible=function(e){this.inListStatus=e?this.inListStatus|C:this.inListStatus&65535-C},k.prototype.isOcclusionVisible=function(){return!!(this.inListStatus&C)},k.prototype.setLoadingBoxVisible=function(e){this.inListStatus=e?this.inListStatus|w:this.inListStatus&65535-w},k.prototype.isLoadingBoxVisible=function(){return!!(this.inListStatus&w)},k.prototype.setRepLoaded=function(e){this.inListStatus=e?this.inListStatus|b:this.inListStatus&65535-b},k.prototype.isRepLoaded=function(){return!!(this.inListStatus&b)},k.prototype.setLegacyUV=function(){var e;if(!this.isLegacyUV())for(this.inListStatus=this.inListStatus|N,e=0;e<this.children.length;e++)this.children[e].reference.setLegacyUV()},k.prototype.isLegacyUV=function(){return!!(this.inListStatus&N)};function F(e,t){if(!e.isEmpty()){var n,i,o=e.get();for(n=0;n<o.length;n++){var r=o[n].pathElement,s=r&&r.externalPath;if(r)for(i=s.length-1;i>=0;i--)if(s[i]===t)return!0}}return!1}k.prototype.updateBoundingElementImpostor=function(){if(k.slaveBoxFix&&(this._boundingBox||this._boundingSphere)){var e,t,n=!1;for(e=0;!n&&e<this._rep.node.children.length;e++)"OOC##beImpostor"===(t=this._rep.node.children[e]).name&&(this._rep.node.removeChild(t),n=!0);var i=new s("OOC##beImpostor");this._rep.node.forceBoundingElements(!0,{sphere:this.getBoundingSphere(),box:this.getBoundingBox()}),this._rep.node.addChild(i)}},k.setScreenSize=function(e){O._debug_screenSize=e},k.getScreenSize=function(){return O._debug_screenSize},k.prototype.isAlive=function(){return this._status!==d.dead},k.prototype.isError=function(){return this._status===d.error},k.prototype.lockUnload=function(e,t,n){var i,o;if(e=e||1,this.unloadLockCounter+=e,!t||n)for(i=0;i<this._occurrences.length;i++)(o=this._occurrences[i].parent)&&o.reference.lockUnload(e,!0,n)},k.prototype.unlockUnload=function(e,t,n,i){var o,r;if(e=e||1,this.unloadLockCounter-=e,!n||i)for(o=0;o<this._occurrences.length;o++)!(r=this._occurrences[o].parent)||t&&t.reference!==t||r.reference.unlockUnload(e,void 0,!0,i)},k.prototype.isUnloadLocked=function(){return this.isForced()||this.unloadLockCounter>0},k.prototype.hasGrandChildren=function(){var e=0;for(e=0;e<this.children.length;e++)if(this.children[e].reference.children.length>0)return!0;return!1},k.prototype.getChild=function(e){var t;for(t=0;t<this.children.length;t++)if(this.children[t].instanceId===e)return this.children[t];return null},k.prototype.isSlave=function(){return this.sgFlag===B},k.prototype.isUnloadable=function(e){if(e){var t=this._rep.node;if(t&&(F(l,t)||F(c,t)||F(u,t)))return!1}return this._status!==d.freezeUnload},k.prototype.isLoading=function(){return this._status===d.loading},k.prototype.clearViewpointTags=function(){var e;for(e=0;e<this._occurrences.length;e++)this._occurrences[e].viewpointTag=-1},k.prototype.getLDHNodeManagerQueue=function(e){return e.queues[this.handler.type]},k.prototype.updateBoundingSphereFromNode=function(){if(this._rep.node){var e=this._rep.node.getBoundingSphere();e&&(this._boundingSphere=e.clone())}},k.prototype.hasDifferentViewpointTag=function(e){if(this._occurrences.length>0){var t;for(t=0;t<this._occurrences.length;t++)if(this._occurrences[t].viewpointTag!==e)return!0;return!1}return!0},k.prototype.buildDebugJSON=function(e,t){var n;var i,o={screenRadius:this._screenRadius,status:function(e){return t&&e._status===d.loaded?"complete":e._status}(this),unloadStatus:this._unloadStatus,handlerType:this.handler.type,parents:[]};for(e||(o.referenceId=this.referenceId),i=0;i<this.parents.length;i++)o.parents.push(this.parents[i].referenceId);if(this.children.length>0&&(o.nbChildren=this.children.length,this.children.length>0)){var r,s=[];for(n=0;n<this.children.length;n++)r=this.children[n],s.push({ref:r.reference.referenceId,inst:r.instanceId});o.children=s}return this.unloadLockCounter>0&&(o.unloadLockCounter=this.unloadLockCounter),this._rep.node&&(o.inSceneGraph=!0),o},k.prototype.setLoadModelOptions=function(e){this._optional||(this._optional=new q),this._optional.setLoadModelOptions(e)},k.prototype.getLoadModelOptions=function(){return this._optional?this._optional.getLoadModelOptions():null},k.prototype.getLoadModelOptions=function(){return this._optional?this._optional.loadModelOptions:null},k.prototype.userLockUnload=function(){this._optional||(this._optional=new q),this.lockUnload(),this._optional.addUserLockUnload()},k.prototype.userUnlockUnload=function(){this._optional&&this._optional.userLockUnload>0&&(this.unlockUnload(),this._optional.removeUserLockUnload())},k.prototype.needScreenRadiusSizeComputation=function(){return!(this._status!==d.waiting&&this._status!==d.loaded&&this._status!==d.toUnload&&this._status!==d.toLoad&&(this._status!==d.error||!this._rep||this._rep.active))},k.prototype.updateBoundingSphere=function(){!this._boundingSphere&&this._boundingBox&&(this._boundingSphere=this._boundingBox.getBoundingSphere())},k.prototype.getBoundingBox=function(){if(!this._boundingBox){var e=this._boundingSphere;if(!e)return null;var t=new r.Box3;t.min.x=e.center.x-e.radius,t.min.y=e.center.y-e.radius,t.min.z=e.center.z-e.radius,t.max.x=e.center.x+e.radius,t.max.y=e.center.y+e.radius,t.max.z=e.center.z+e.radius,this._boundingBox=t}return this._boundingBox},k.prototype.hasBoundingElement=function(){return this._boundingBox&&this._boundingSphere},k.prototype.setBoundingElements=function(e,t,n,i){e&&(this._boundingSphere=e.clone(),n&&this._boundingSphere.applyMatrix4(n)),t&&(this._boundingBox=t.clone(),n&&this._boundingBox.applyMatrix4(n))};var V=new r.Sphere;k.prototype.getBoundingSphere=function(e){return this._boundingSphere?this._boundingSphere:this._boundingBox?(this._boundingBox.getBoundingSphere(V),V):e?new r.Sphere:null};k.prototype.getScore=function(){return this._screenRadius};var X=new r.MeshBasicMaterial({color:"red"});k.prototype.displayBox=function(e){var t=e,n=t.newLoadingBoxes;if(n&&!this.isLoadingBoxVisible()&&this._rep&&this._rep.node||!n&&k.slaveBoxFix){var i,o,r,s,a=!1;if(t.queueRenderer){for(i=0;!a&&i<this._rep.node.children.length;i++)"OOC##Box"===this._rep.node.children[i].name&&(a=!0);a||(o=this.getBoundingBox(),s=n?t.queueRenderer.getMaterialApplication():t.queueRenderer.getRepMaterialApplication(),o&&((r=g.createCuboidNodeFromBox3(o,X)).setRenderPasses(["main"]),r.setModelIdentification(this.referenceId),r.setPickable(t.queueRenderer.pickable),r.setPickParent(!0),r.name="OOC##Box",r.setMaterialApplication(s),this._rep.node.addChild(r)))}this.setLoadingBoxVisible(!0)}},k.prototype.removeBox=function(e){var t=e.newLoadingBoxes;if(t&&this.isLoadingBoxVisible()&&this._rep&&this._rep.node||!t&&k.slaveBoxFix){var n,i,o=!1;for(n=0;!o&&n<this._rep.node.children.length;n++)"OOC##Box"===(i=this._rep.node.children[n]).name&&(this._rep.node.removeChild(i),o=!0)}this.setLoadingBoxVisible(!1)},k.lodSelector=O;var q=function(){this._force=null,this.onAddedToSceneGraphCB=null,this.onRemovedFromSceneGraphCB=null,this.onLoadedCallbacks=null,this.loadModelOptions=null,this.userLockUnload=0,this.overrideData=null};q.prototype.setOverride=function(e,t){this.overrideData||(this.overrideData=new Q),this.overrideData.setOverride(e,t),this.overrideData.isEmpty()&&(this.overrideData=null)},q.prototype.hasOverride=function(e){return void 0===e?null!==this.overrideData:this.overrideData&&this.overrideData.hasOverride(e)},q.prototype.addUserLockUnload=function(){this.userLockUnload++},q.prototype.removeUserLockUnload=function(){this.userLockUnload--},q.prototype.addOnLoadedCB=function(e){this.onLoadedCallbacks||(this.onLoadedCallbacks=[]),this.onLoadedCallbacks.push(e)},q.prototype.onLoaded=function(){if(this.onLoadedCallbacks){var e;for(e=0;e<this.onLoadedCallbacks.length;e++)this.onLoadedCallbacks[e]();this.onLoadedCallbacks=null}},q.prototype.setLoadModelOptions=function(e){this.loadModelOptions=e},q.prototype.getLoadModelOptions=function(){return this.loadModelOptions};var G=function(){this.callbacks=[]};G.prototype.onForce=function(e){e&&this.callbacks.push(e)},G.prototype.onLoaded=function(){var e;for(e=0;e<this.callbacks.length;e++)this.callbacks[e]();this.callbacks.length=0},G.prototype.clear=function(){this.callbacks.length=0};var W=function(){this.override=null,this.overrideCB=null},Q=function(){this.count=0,this.overrideMap={}};Q.prototype.setOverride=function(e,t){var n=this.overrideMap[e];n?n.overrideCB=t:t&&((n=new W).overrideCB=t,this.overrideMap[e]=n,this.count++)},Q.prototype.hasOverride=function(e){var t=this.overrideMap[e];return!(!t||!t.overrideCB)},Q.prototype.isEmpty=function(){return 0===this.count},Q.prototype.updateOverride=function(e,t,n){var i,o,r,s,a,d,h=null;for(i in this.overrideMap)o=e.getOverrideSet(i),r=(a=this.overrideMap[i]).override,s=a.overrideCB,t&&s?(r?r._forceOverrideUpdate():(r=o._createNodeOverride(t),a.override=r),s(n,r)):r&&(o.deleteOverride(r),a.override=null,s||(h=h||[]).push(i));for(d=0;h&&d<h.length;d++)delete this.overrideMap[h[d]],this.count--},k.prototype.updateOccurrencesPosition=function(e,t){var n;for(this.clearScreenRadiusCache(),n=0;n<this._occurrences.length;n++)this._occurrences[n].updateMatrix(e);var i,o,r=new Set;for(n=0;n<this.children.length;n++)o=this.children[n],null!==t&&o.instanceId!==t||(i=o.reference,r.has(i)||(r.add(i),i.updateOccurrencesPosition(e,null)))},k.prototype.clearScreenRadiusCache=function(){this._screenRadiusCache=[]},k.createChildData=function(e,t,n){return new U(e,t,n)},k.prototype.removeRep=function(e){if(this._rep===e)this._rep=e.nextRep;else for(var t=this._rep;t;)if(t.nextRep===e){t.nextRep=e.nextRep;break}},k.prototype.switchMeshInRAM=function(e,t){if(this.isLeaf()){var n=this.getActiveRepresentation();if(n.hasMeshInRAM()!==e)if(this.isLoading()){var i=t.switchRepresentationBuffer.get(this.referenceId);i||(i=new y(n.clone()),t.switchRepresentationBuffer.set(this.referenceId,i))}else{if(n!==this.getPrimaryRepresentation())n.setMeshInRAM(e);else{var o=n.clone();this.switchRepresentation(o,e,t)}}}},k.prototype.switchRepresentation=function(e,t,n,i,o){if(!this.isLoading())if(null===this._rep)e.active=!0,e.copyMissingParams(null),e.setMeshInRAM(t),this._rep=e;else if(this.isLeaf()){var r=this._rep,s=null,a=null,h=!1;e.isPartiallyDefined()&&(a=this.getActiveRepresentation(),e.copyMissingParams(a),a=null),e.setMeshInRAM(t);for(var l,c=this.getPrimaryRepresentation();r;)!o&&r.equals(e)&&(s=r),r.active&&(a=r),r=r.nextRep;if(s!==a?!o&&a.isClearMeshInRAMOnly(e)?(a.clearMeshInRAM(e),this.updateMemorySizeNEW(n),a===c&&(h=!0)):(this.clearScreenRadiusCache(),s||(e.nextRep=this._rep.nextRep,this._rep.nextRep=e,s=e),a.active=!1,s.active=!0,a!==e&&(this.isError()&&this.setStatus(d.waiting,n),n.forceUpdateNode(this))):a===c&&(h=!0),h)n.onSwitchRepCB&&m.call(n.onSwitchRepCB.bind(null,this.referenceId)),i&&m.multiCall(i);else if(i)for(l=0;l<i.length;l++)this.addOnLoadedCB(i[l])}},k.prototype.getActiveRepresentation=function(){for(var e=this._rep;e;){if(e.active)return e;e=e.nextRep}return e},k.prototype.getPrimaryRepresentation=function(){return this._rep},k.prototype.showActiveRepresentation=function(e){if(this.isAlive()){var t=this.getActiveRepresentation(),n=this.getPrimaryRepresentation();if(t!==n){var i,o=null,r=n.node,s=t.node,a=this.isSlave();if(a?e.unloadLeafReferenceCB&&e.unloadLeafReferenceCB.call(null,this.referenceId):this.removeRepresentationChildren(r),s&&(o=s.children.concat([]),s.removeChildren()),n.noMeshInRAM!==t.noMeshInRAM&&(n.noMeshInRAM||e.unloadManager.setHasMeshInRam(!0)),this.removeRep(t),t.nextRep=null,t.node=r,n.node=s,t.updateMeshSize(this),this._rep=t,r&&o)for(i=0;i<o.length;i++)r.addChild(o[i]);this.updateMemorySizeNEW(e),a&&e.onLeafReferenceLoadedCB&&e.onLeafReferenceLoadedCB.call(null,this.referenceId)}var d=e.onSwitchRepCB;d&&m.call(d.bind(null,this.referenceId))}},k.prototype.hasRootBoundingElement=function(){return!(!this._boundingBox&&this._boundingSphere&&0===this._boundingSphere.radius)},k.prototype.getNode=function(){return this._rep.node},k.weakCGRNodeMap=new WeakMap;var j=-1;return k.prototype.setCGRNodeNames=function(e,t){-1===k.useRepNodeName&&(k.useRepNodeName=window.OOCEnableRepNodeName?1:0);var n,i,o=!1;if(e)for(n=0;n<e.length&&!o;n++)i=e[n],1===k.useRepNodeName?i.name=k.RepNodeName:k.RepNodeSet.add(i.id),-1===j&&(j=!1!==window.OOCEnablePRPrimPicking),!j&&t.isPR()&&i.traverse(function(e){"Mesh3D"===e.getNodeType()&&e._setDisablePrimPicking(!0)}),t.node&&v.idPathWatcher&&i.internalSceneGraph&&(k.weakCGRNodeMap.set(i,"##REP##"+this.referenceId),v.idPathWatcher.onAddChild(t.node,i),o=!0)},k.prototype.getCGRNode=function(){var e,t,n=this.getActiveRepresentation().node;if(n)for(t=0;t<n.children.length;t++)if((e=n.children[t]).internalSceneGraph)return e;return null},k.slaveBoxFix=!1,Object.defineProperty(k.prototype,"manager",{get:function(){throw new Error("forbidden")},set:function(e){throw new Error("forbidden")}}),Object.defineProperty(k.prototype,"node",{get:function(){return this._rep&&this._rep.node},set:function(e){throw new Error("forbidden")}}),Object.defineProperty(k.prototype,"url",{get:function(){return this._rep&&this._rep.url},set:function(e){throw new Error("forbidden")}}),Object.defineProperty(k.prototype,"memorySize",{get:function(){return this.memoryData.memory},set:function(e){throw new Error("forbidden")}}),Object.defineProperty(k.prototype,"memorySizeGPU",{get:function(){return this.memoryData.memoryGPU},set:function(e){throw new Error("forbidden")}}),k.useRepNodeName=-1,k.RepNodeSet=new Set,k.RepNodeName="OOC##RepNode",k}),define("DS/3DXMTiles/LDHRepresentationLoader",["DS/Visualization/ModelLoader","DS/Visualization/LoaderUtils","DS/Visualization/Node3D","DS/3DXMTiles/Debug3DXMTiles","DS/3DXMTiles/LDHReference","DS/3DXMTiles/LDHStats","DS/Visualization/PLMMaterialConnectionFactory"],function(e,t,n,i,o,r,s){"use strict";var a=r,d={statsInit:function(){a.init()},statsOnLoadedModel:function(){a.onLoadedModel()},modelLoader:new e,modelLoader3dx:new e,debug:!1,setDebug:function(e){this.debug=e},_loadModel:function(e,n,o,r,s,h,l,c){function u(e){i.endProbe("load_"+n.referenceId),a.onLoadedModel(),n.updateMemorySizeNEW(c),n=null,p.setTargetNode(null),r(g)}this.debug&&(e=this.removeTag(e)),t.__storeCGRNames=0,h||(e.endsWith(".cgr")?h="cgr":e.endsWith(".3dxc")&&(h="3dxc"));var p="3dxc"===h?this.modelLoader3dx:this.modelLoader;p.setKeepLoaderMode(!0);var f=null,g=n.getActiveRepresentation(),m=n.getPrimaryRepresentation();if(n.requestBuildSceneGraphHierarchy(!0),c.tryBuildSceneGraphHierarchy(),g!==m&&(f=g.buildNode()),f=g.node){p.setSceneGraph(f),(c.newLoadingBoxes||n.isSlave())&&n.removeBox(c),s&&(p.activateSmartLoading(s.getRenderer()),p.setRenderCallback(s.render,1e3)),p.setFileType(h||"xmlv43"),(e.endsWith(".cgr")||"cgr"===h?p.setOnLoadedProductStructureCallback:p.setOnLoadedCallback).call(p,function(e){i.endProbe("load_"+n.referenceId),a.onLoadedModel(),p.setTargetNode(null),o(e,g),n=null}),p.setOnErrorCallback(u),a.init();var y,v={filename:e,format:h||void 0,loaderSettings:{gasSharing:!0}};if(l)for(y in l)v[y]=l[y];var M={};!1,d.setupModelLoaderOptions(p,M,n,g,m,c),i.startProbe("load_"+n.referenceId),p.loadModel(v,void 0,void 0,M)}else setTimeout(u,1)},setupModelLoaderOptions:function(e,t,n,i,o,r){var a=!1,d=!1,l=r.oocManager.getDefaultLoadModelOptions(),c=void 0;l&&(l.CGRWithSG&&(a=!0),l.CGRWithBlanking&&(d=!0),void 0!==l.noMeshInRAM&&(c=l.noMeshInRAM)),s.hasInternalPath(n.referenceId)&&(a=!0);var u=!1;n.isLegacyUV()&&(u=!0);var p,f=n.getLoadModelOptions();if(f)for(p in f)"CGRWithSG"===p?a=!!f[p]:"CGRWithBlanking"===p?d=!!f[p]:"noMeshInRAM"===p&&void 0!==f[p]?c=!!f[p]:"applicativeContainers"===p&&f[p]&&(t[p]=h(f[p]),t[p]&&(t[p].applicativeContainersNode=o.node));void 0!==c||i.noMeshInRAM,void 0!==c&&i.forceMeshInRAM(!c),e.setAccelerationStructure(r.oocManager.getUsePickingAccelerationStructure()),e.setCGRWithBlanking(d),e.setCGRWithSG(a),e.setNoMeshInRAM(n.getActiveRepresentation().noMeshInRAM),e.useDefaultTCSet=u},removeTag:function(e){var t=e.indexOf("#");if(t>=0){var n=e.lastIndexOf(".");return e.substring(0,t)+e.substring(n)}return e}};function h(e){var t,n={};for(t in e)n[t]=e[t];return n}return d.modelLoader.sharedBuffers=!1,d.modelLoader3dx.sharedBuffers=!1,d}),define("DS/3DXMTiles/LDHCandidateListRenderer",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/Visualization/PathElement","DS/Mesh/MeshUtils","DS/3DXMTiles/LDHOccurrence","DS/3DXMTiles/PriorityQueue"],function(e,t,n,i,o,r,s,a,d){"use strict";var h=function(e){this.references=[],this.node=null,this.root=e,this.occurrences=[],this.preserveReferences=null,this.material=null,this.previousDimension=-1,this.lastClusters=null,this.priorityQueue=null};h.prototype.createMesh=function(n){if(2===n.dimension)return t.createCuboidNode({cornerPoint:new e.Vector3(0,0,0),firstAxis:new e.Vector3(1,0,0),secondAxis:new e.Vector3(0,1,0),thirdAxis:new e.Vector3(0,0,1)});if(1===n.dimension){var i,o=[new e.Vector3(0,0,0),new e.Vector3(1,0,0),new e.Vector3(0,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,0),new e.Vector3(0,0,1),new e.Vector3(1,0,0),new e.Vector3(1,1,0),new e.Vector3(1,0,0),new e.Vector3(1,0,1),new e.Vector3(0,1,0),new e.Vector3(0,1,1),new e.Vector3(0,1,0),new e.Vector3(1,1,0),new e.Vector3(0,0,1),new e.Vector3(0,1,1),new e.Vector3(0,0,1),new e.Vector3(1,0,1),new e.Vector3(1,1,1),new e.Vector3(0,1,1),new e.Vector3(1,1,1),new e.Vector3(1,0,1),new e.Vector3(1,1,1),new e.Vector3(1,1,0)],r=[];for(i=0;i<o.length;i++)r.push(i);return t.createLineNode({points:o,drawMode:s.ConnectivityTypeEnum.LINES,idx:r})}},h.prototype.clearRepresentation=function(){this.node&&(this.root.removeChild(this.node),this.node=null)},h.prototype.dispose=function(){this.clearRepresentation(),this.material&&this.material.dispose()};h.prototype.updateRepresentation=function(e,t){this.previousDimension!==e.dimension&&this.material&&(this.material.dispose(),this.material=null),this.material||(this.material=this.buildMaterial(e)),this.clearRepresentation();var n=this.createMesh(e);this.occurrences=[],n.setMaterial(this.material);var i=null;i=-1===e.clusters?this.createInstancingData(e):this.createInstancingData_cluster(e,t),this.setUpMeshInstancingParameters(n,i.nbInstances,i.matrices,i.colors),n.forceBoundingElements(!0,{box:i.boundingBox}),this.node=n,i.nbInstances>0&&this.root.addChild(n)},h.prototype.createInstancingData=function(t){t=t||{};var n,i,o,r,s=new e.Box3,a=this.computeNbInstances(),h=new Float32Array(16*a),l=new Float32Array(3*a),c=0,u=this.references,p=t.count;if(p){for(this.priorityQueue||(this.priorityQueue=new d),this.priorityQueue.clear(),n=0;n<this.references.length;n++)this.priorityQueue.addNode(this.references[n]);u=[],this.priorityQueue.traverseMax(function(e,t,n){return u.push(e),!(u.length>=p)})}for(n=0;n<u.length;n++)if((o=u[n]).isAlive())for(r=o.getOccurrences(),i=0;null!==r&&i<r.length;i++)this.fillInstancingData(o,r[i],c,h,l,s,t)&&(this.occurrences.push(r[i]),c++);return{boundingBox:s,nbInstances:a,matrices:h,colors:l}},h.prototype.computeNbInstances=function(){var e,t,n,i=0;for(e=0;e<this.references.length;e++)n=(t=this.references[e]).getOccurrences(),t.isAlive()&&null!==n&&(i+=n.length);return i},h.prototype.buildMaterial=function(t){var n=1===t.dimension?new e.LineBasicMaterial({force:!0,opacity:t.opacity,depthWrite:!1}):new e.MeshBasicMaterial({force:!0,opacity:t.opacity,depthWrite:!1});n.activatePDSFX();n.setPDSFXVaryings({vColor:{type:"v3"}});var i={ComputeObjectPosition:["vec3 ComputeObjectPosition() {","vec4 localPosition = vec4(vGetAttribPosition(), 1.0);","vec4 newPosition = instanceMatrix*localPosition;","return newPosition.xyz;","}"].join("\n"),ComputeVaryingValues:["void ComputeVaryingValues() {","vColor = instanceColor;","}"].join("\n")},o={ComputeAlbedo:["vec3 ComputeAlbedo() {","return vColor;","}"].join("\n"),ComputeSpecularReflectance:["vec3 ComputeSpecularReflectance() {","return vec3(1.0,1.0,1.0);","}"].join("\n")};return n.setPDSFXOverridableFunctions(i,o),n},h.prototype.getOccurrencesInXSO=function(e){var t,n,i=e.get(),o=null;for(t=0;t<i.length;t++){var r;if(void 0!==(n=i[t].pathElement).instanceId&&n.getLastElement()===this.node)if(o||(o=[]),r=this.getOccurrenceFromInstanceId(n.instanceId)){var s=r.reference;o.push(r),this.preserveReferences||(this.preserveReferences=[]),-1===this.preserveReferences.indexOf(s)&&this.preserveReferences.push(s)}}return o},h.prototype.getOccurrenceFromInstanceId=function(e){var t=e/5-1;return this.occurrences[t]},h.prototype.getInstanceId=function(e){return 5*(this.occurrences.indexOf(e)+1)},h.prototype.createSelectionRestoringData=function(){return this.preserveReferences=null,[{xso:n,occurrences:this.getOccurrencesInXSO(n)},{xso:i,occurrences:this.getOccurrencesInXSO(i)},{xso:o,occurrences:this.getOccurrencesInXSO(o)}]},h.prototype.restoreSelection=function(e){var t;for(t=0;t<e.length;t++){var n=e[t].xso,i=e[t].occurrences;i&&this.addOccurrencesToXSO(n,i)}},h.prototype.addOccurrencesToXSO=function(e,t){var n,i,o,s;for(n=0;n<t.length;n++)s=null,i=t[n],(o=this.getInstanceId(i))>0?(s=new r([this.root,this.node])).instanceId=o:i instanceof a?i.reference.node&&(s=i.buildPathElement()):(s=new r).setFromOccurrence(i),s&&e.add({pathElement:s})};var l=new e.Matrix4,c=new e.Matrix4,u=new e.Matrix4,p=new e.Matrix4,f=new e.Vector3;function g(e,t){this.center=e.center(),this.bbox=e,this.bbox.applyMatrix4(t),this.matrix=t,this.center.applyMatrix4(t),this.clusterIndex=-1}function m(){this.center=new e.Vector3,this.nodes=[]}h.prototype.fillInstancingData=function(e,t,n,i,o,r,s){var a=e.getBoundingBox();if(!a)return!1;a=a.clone();var d=t.matrix;l.copy(d),f.set(a.max.x-a.min.x,a.max.y-a.min.y,a.max.z-a.min.z),u.identity(),p.identity(),u.translate(a.min),p.scale(f),l.multiplyMatrices(u,p),c.multiplyMatrices(d,l);var h,g=16*n,m=c.elements;for(h=0;h<16;h++)i[g+h]=m[h];var y=s.color.r,v=s.color.g,M=s.color.b;return o[g=3*n]=y,o[g+1]=v,o[g+2]=M,a.applyMatrix4(d),r.expandByPoint(a.min),r.expandByPoint(a.max),!0},h.prototype.getReferenceFromOccurrence=function(e){var t,n,i,o,r=0;for(t=0;t<this.references.length;t++)if((i=this.references[t]).isAlive())for(o=i.getOccurrences(),n=0;null!==o&&n<o.length;n++){if(this.occurrences[r]===e)return i.referenceId;r++}},h.prototype.setUpMeshInstancingParameters=function(e,t,n,i){var o={data:n,type:"m4",attribName:"instanceMatrix",isFlattened:!0},r={data:i,type:"v3",attribName:"instanceColor",isFlattened:!0};e.setInstancingParameters(t,[o,r])},g.prototype.selectCluster=function(e){var t,n,i=1/0,o=-1;for(t=0;t<e.length;t++)(n=e[t].center.distanceTo(this.center))<i&&(o=t,i=n);return o},window.myRnd=[];var y=void 0,v=0;function M(){var e;return void 0===y&&(y=window.WUXLDH_RndTable?window.WUXLDH_RndTable:null),y?(e=y[v],v=(v+1)%y.length,e):(e=Math.random(),window.myRnd.push(e),e)}return m.prototype.randomize=function(e){this.center.set(e.min.x+M()*(e.max.x-e.min.x),e.min.y+M()*(e.max.y-e.min.y),e.min.z+M()*(e.max.z-e.min.z))},m.prototype.resetNodes=function(){this.nodes=[]},m.prototype.updateCenter=function(){var e,t=this.nodes,n=this.center;if(t.length>0){for(n.set(0,0,0),e=0;e<t.length;e++)n.addVectors(n,t[e].center);n.multiplyScalar(1/t.length)}},m.prototype.buildBoundingBox=function(){var t,n,i=new e.Box3;for(t=0;t<this.nodes.length;t++)n=this.nodes[t],i.union(n.bbox);return i},h.prototype.createClusterData=function(e,t,n){var i=e.getBoundingBox(),o=t.matrix,r=new g(i.clone(),o);return r&&!r.bbox.containsPoint(n)?r:null},h.prototype.fillInstancingData_cluster=function(e,t,n,i,o,r,s,a){c.identity();var d=e.buildBoundingBox();if(d.containsPoint(a))return 0;s.union(d),d.size(t),c.scale(t),c.setPosition(d.min);var h,l=16*n,u=c.elements;for(h=0;h<16;h++)i[l+h]=u[h];var p=r.color.r,f=r.color.g,g=r.color.b;return o[l=3*n]=p,o[l+1]=f,o[l+2]=g,1},h.prototype.createInstancingData_cluster=function(t,n){var i,o,r=this.createClusters(t,n),s=new e.Box3,a=r.length,d=0,h=new Float32Array(16*a),l=new Float32Array(3*a),c=new e.Vector3(s.max.x-s.min.x,s.max.y-s.min.y,s.max.z-s.min.z);for(c.multiplyScalar(.02),c.set(100,100,100),i=0;i<r.length;i++)o=r[i],d+=this.fillInstancingData_cluster(o,c,d,h,l,t,s,n);return{boundingBox:s,nbInstances:a=d,matrices:h,colors:l}},h.prototype.createClusters=function(t,n){var i,o,r,s,a=[];for(i=0;i<this.references.length;i++)if((r=this.references[i]).isAlive())for(s=r.isSlave()?r.node._occurrences:r._occurrences,o=0;o<s.length;o++)(c=this.createClusterData(r,s[o],n))&&a.push(c);var d=new e.Box3;for(i=0;i<a.length;i++)d.expandByPoint(a[i].center);var h,l,c,u=t.clusters,p=this.lastClusters;if(!p||0===p.length&&a.length>0)for(p=[],i=0;i<u;i++)(h=new m).randomize(d),p.push(h);else for(i=0;i<p.length;i++)(h=p[i]).resetNodes();for(i=0;i<a.length;i++)p[l=(c=a[i]).selectCluster(p)].nodes.push(c),c.clusterIndex=l;for(var f=!!this.lastClusters;!f;){for(f=!0,i=0;i<p.length;i++)(h=p[i]).updateCenter(),h.nodes.length=0;for(i=0;i<a.length;i++)p[l=(c=a[i]).selectCluster(p)].nodes.push(c),c.clusterIndex!==l&&(f=!1,c.clusterIndex=l)}var g=[];for(i=0;i<p.length;i++)p[i].nodes.length>0&&g.push(p[i]);return this.lastClusters=g,g},h.prototype.clearClusters=function(){this.lastClusters=null},h}),define("DS/3DXMTiles/OOCManagerEntry",["DS/3DXMTiles/LDHReference"],function(e){"use strict";return function(t,n){this.id=t,this.reference=new e({handler:n.handler,manager:n.manager._ldhNodeManager,boundingSphere:n.boundingSphere&&n.boundingSphere.clone(),boundingBox:n.boundingBox&&n.boundingBox.clone(),urlOrId:n.url,referenceId:t,leaf:!!n.leaf,node:n.node||null}),n.loadModelOptions&&this.reference.setLoadModelOptions(n.loadModelOptions)}}),define("DS/3DXMTiles/LDHBatchModel3DHandlerBank",["DS/Visualization/ThreeJS_DS","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/3DXMTiles/LDHReferenceStatus","DS/Visualization/ModelLoader","DS/3DXMTiles/ModelBank"],function(e,t,n,i,o,r){"use strict";var s=function(e,n){t.call(this,t.Model3DHandler),this.loadModelOptions=null,this.manager=null,this.tenant=null,this.getSecurityParamsCB=e.getSecurityParamsCB||null,this.modelLoader=new o,this.modelLoader.setFileType("cgr"),this.modelLoader.setKeepLoaderMode(!0),this.modelLoader.sharedBuffers=!1,this.referenceToContext=new Map,this.toLoadQueue=[],this.maxNbLoading=40,this.nbTickets=120,this.nbLoading=0};(s.prototype=Object.create(t.prototype)).isReady=function(){return 0===this.nbLoading},s.prototype.setFileType=function(e){},s.prototype.setRedirectUrlCB=function(){},s.prototype.setAutoRedirect=function(){},s.prototype.setLoadModelOptions=function(e){this.loadModelOptions=e},s.prototype.updateTenant=function(){this.tenant=this.getSecurityParamsCB?this.getSecurityParamsCB().tenant:"#NONE#"},s.prototype.handleReferences=function(e,t){this.tenant||this.updateTenant(),this.manager=t.manager._ldhNodeManager;var n,i,o,s=this.manager,a=[];for(i=0;i<e.length;i++)n=e[i],this.referenceToContext.set(n,t),o=n.getActiveRepresentation(),n.requestBuildSceneGraphHierarchy(!0),a.push(o.type);s.tryBuildSceneGraphHierarchy();var d=this.onModelLoaded.bind(this),h=this.onModelError.bind(this);for(i=0;i<e.length;i++)(o=(n=e[i]).getActiveRepresentation())!==n.getPrimaryRepresentation()&&o.buildNode(),o.node,this.nbLoading++;r.retrieveModelData(e,a,this.tenant,this,d,h)},s.prototype.onModelBankData=function(e,t,i,o,s){if(o){var a=e.getActiveRepresentation().node;if(!a)return void i(e);this.modelLoader.setOnLoadedProductStructureCallback(function(n){t(e,n)}),this.modelLoader.setOnErrorCallback(function(){r.removeKeys([s]),i(e)});var d=e.getActiveRepresentation(),h=e.getPrimaryRepresentation(),l={};n.setupModelLoaderOptions(this.modelLoader,l,e,d,h,this.manager),this.modelLoader.loadModelFromBuffer(o,a,l)}else r.removeKeys([s]),i(e)},s.prototype.onModelLoaded=function(e,t){this.nbLoading--;e.getActiveRepresentation();t&&t.nodes&&this.dbgSetupNodes(t.nodes,"green"),n.statsInit(),n.statsOnLoadedModel();e.referenceId;var i=this.referenceToContext.get(e);this.referenceToContext.delete(e);var o=i.manager;this.commitModelLoadedTransaction(e,o,t),i.doneCB([e],[])},s.prototype.onModelError=function(e){this.nbLoading--;e.referenceId;var t=this.referenceToContext.get(e);this.referenceToContext.delete(e),t.doneCB([],[e])},s.prototype.acceptsRepresentation=function(e,t){return this.tenant||this.updateTenant(),!!r.hasModelData(t.referenceId,e.type,this.tenant,e.wms)};var a=function(e){this.handler=e,this.references=[]};return a.prototype.containsReference=function(e){return this.references.indexOf(e)>=0},a.prototype.addReferenceIfPossible=function(e,t){return t=t||e.getActiveRepresentation(),!!(r.hasModelData(e.referenceId,t.type,this.handler.tenant,t.wms)&&this.references.length<this.handler.nbTickets)&&(this.references.push(e),!0)},a.prototype.isEmpty=function(){return 0===this.references.length},a.prototype.getSize=function(){return this.references.length},a.prototype.setReferencesLoading=function(e){var t,n,i=this.references;for(t=0;t<i.length;t++)(n=i[t]).isLoading()||n.setLoading(e)},s.prototype.handleBatch=function(e,t){this.handleReferences(e.references,t)},s.prototype.createBatch=function(){return new a(this)},s}),define("DS/3DXMTiles/LDHBatchModel3DHandlerVISCANoStream",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/3DXMTiles/LDHReferenceStatus","DS/WAFData/WAFData","DS/Visualization/ModelLoader","DS/3DXMTiles/CopyViscaURLServices","DS/3DXMTiles/LDHReference","DS/3DXMTiles/LDHStats","DS/3DXMTiles/LDHReferenceRep","DS/3DXMTiles/ModelBank"],function(e,t,n,i,o,r,s,a,d,h){"use strict";var l=0;function c(e,t){this.index=l++,this.context=e,this.references=[],this.size=t}var u=function(t,n,i){e.call(this,e.Model3DHandler),this.loadModelOptions=null,this.debug=!!t.debug,this.debugSingleMode=!!t.debugSingleMode,this.manager=null,this.tenant=null,this.loadingInProgress=!1,this.saveToBank=t.saveToBank,this.nbTickets=n,this.batchSize=this.debugSingleMode?1:i,this.modelLoader=new o,this.modelLoader.sharedBuffers=!1,this.modelLoader.setFileType("cgr"),this.modelLoader.setKeepLoaderMode(!0),this.referenceToBatch=new Map,this.urlServices=new r,this.ODT=!1,this.maxTicketSize=t.maxTicketSize||0,this.getSecurityParamsCB=t.getSecurityParamsCB||null,this.batchAV1=void 0===t.batchAV1||t.batchAV1,this.datas=[]};(u.prototype=Object.create(e.prototype)).setFileType=function(e){this.fileType=e},u.prototype.setRestricted=function(){},u.prototype.isReady=function(){return this.nbTickets>0},u.prototype.setLoadModelOptions=function(e){this.loadModelOptions=e},u.prototype.setRedirectUrlCB=function(){},u.prototype.setAutoRedirect=function(){};var p=document.createElement("a");u.prototype.getParams=function(e){var t={};p.href=e;for(var n,i=p.search.substring(1).split("&"),o=0;o<i.length;o++){var r=i[o].split("=");t[r[0]]=(n=r[1],decodeURIComponent((n+"").replace(/\+/g,"%20")))}return t};var f={url:"/i3dx/services/xmql",verb:"POST"};function g(e,t,n){var i,o;for(i=t;i<e.length;i++){if(13===(o=e[i]))return{str:n.decode(e.subarray(t,i)),index:i+2};if(10===o)break}return{str:n.decode(e.subarray(t,i)),index:i+1}}u.prototype.getMQLUrl=function(){return this.getMCSUrl()+f.url},u.prototype.getMCSUrl=function(){return this.getSecurityParamsCB().service3DSpaceUrl},u.prototype.buildMQLRequest=function(e){var t,n,i,o,r="[";for(t=0;t<e.length;t++)i=e[t].getActiveRepresentation(),t>0&&(r+=","),r+='{"correlationId":"'+(o=t+1)+'","filename":"'+((n=this.getParams(i.url)).filename||n.f)+'","format":"'+(n.format||n.fmt)+'","path":"'+o+'","physicalid":"'+(n.boid||n.id)+'"}';return r+="]",['<?xml version="1.0" encoding="utf-8"?>','<executeSequence xmlns="http://www.3ds.com/xmql/query">',"  <execute>","    <function>get_checkout_ticket</function>","    <version>2.1.0</version>","    <params>",'      <param name="label">ticket</param>','      <param name="mcsurl">'+this.getMCSUrl()+"</param>",'      <param name="bops">[{"bops":'+r+',"store":"plmx"}]</param>',"    </params>","  </execute>","</executeSequence>"].join("\n")},u.prototype.buildMQLSizeRequest=function(e,t){var n,i,o,r='"';for(n=0;n<e.length;n++)o=e[n].getActiveRepresentation(),n>0&&(r+=","),n+1,r+=""+(i=this.getParams(o.url)).boid,t.push(i.filename);r+='" ","';this.getMCSUrl();return['<?xml version="1.0" encoding="utf-8"?>','<executeSequence xmlns="http://www.3ds.com/xmql/query">',"  <execute>","    <function>query_bus</function>","    <version>2.2.0</version>","    <params>",'      <param name="label">fetch</param>','      <param name="type">*</param>','      <param name="name">*</param>','      <param name="revision">*</param>','      <param name="vault">*</param>','      <param name="select">["physicalid","format.file.name","format.file.size"]</param>','      <param name="where">physicalid matchlist '+r+"</param>",'      <param name="dump">|</param>','      <param name="format">tcl</param>',"    </params>","  </execute>","</executeSequence>"].join("\n")},u.prototype.doDebugSingleLoad=function(e,t){var n=this,o={type:"arraybuffer",onComplete:function(i,o){n.parseMultiPartData(i,o,e,t,!1)},onFailure:function(){n.errorCallbackTest(e,t),console.log("checkout ERROR")}},r=t[0].getActiveRepresentation();i.authenticatedRequest(r.url,o)},u.prototype.doCheckoutMQL=function(e,t,n,o){var r=/\{\{([^\}]*)\}\{([^\}]*)\}\}/.exec(e);if(r){var s=r[1],a=r[2],d=this,h={cors:!0,timeout:36e5,method:this.ODT?"GET":"POST",data:{__fcs__jobTicket:s},type:"arraybuffer",async:!0,headers:{Accept:"text/plain"},onComplete:function(e,i){d.parseMultiPartData(e,i,t,n,!1,o)},onFailure:function(){d.errorCallbackTest(t,n),console.log("checkout ERROR")}};i.authenticatedRequest(a,h)}else this.errorCallbackTest(t,n)},u.prototype.loadPart=function(e,n,i,o){if(n){var r=n.getActiveRepresentation(),s=n.getPrimaryRepresentation(),a=r.node;if(a){var d=e.byteLength;this.modelLoader.setOnLoadedProductStructureCallback(function(e){i(n,e,d)}),this.modelLoader.setOnErrorCallback(function(){o(n)});var h={};t.setupModelLoaderOptions(this.modelLoader,h,n,r,s,this.manager),this.modelLoader.loadModelFromBuffer(e,a,h)}else o(n)}},u.prototype.parsePart=function(e,t,n,i,o,r,s){var a,d,h,l=new TextDecoder,c=t,u=-1;do{c=(a=g(e,c,l)).index,(h=a.str).startsWith("Content-length:")&&(d=h.split(" "),u=parseInt(d[1])),s&&h.startsWith("X-CorelationID:")&&(d=h.split("reference_"),r=parseInt(d[1]))}while(u<0&&c<e.length);var p=n[r];if(c=(a=g(e,c,l)).index,u>0){var f=e.buffer.slice(c,c+u);if(this.saveToBank){var m=e.buffer.slice(c,c+u);this.datas.push({data:m,referenceIndex:r})}this.loadPart(f,p,i,o)}return c+u};var m=localStorage.getItem("OOCBoxDebug");return u.prototype.parseMultiPartData=function(e,t,n,i,o,r,s){var d,l=0,c=t.__file_count__;if(c)l=parseInt(c);else for(d=0;d<i.length;d++)i[d]&&l++;var u=this;function p(e,t,n){m&&(e.byteSize=n),a.onLoadedModel(n),u.onModelLoaded(e,t,r)}function f(e){u.onModelError(e)}if(l>1){var g=0,y=0;for(d=0;d<l;d++){for(;!i[y]&&y<i.length-1;)y++;g=this.parsePart(new Int8Array(e),g,i,p,f,y,o),y++}var v,M=[],S=[],L=[],D=[];for(d=0;d<this.datas.length;d++)(R=i[this.datas[d].referenceIndex])&&(v=R.getActiveRepresentation(),M.push(R.referenceId),S.push(v.type),L.push(v.wms),D.push(this.datas[d].data));u.saveToBank&&(h.storeModelData(M,S,this.tenant,D,L),u.datas=[])}else{y=-1;if(s){var T=s.split("reference_");y=parseInt(T[1])}for(d=0;d<i.length;d++){var R,x;(R=i[d])&&(y<0||d===y)&&(this.saveToBank&&(x=R.getActiveRepresentation(),h.storeModelData([R.referenceId],[x.type],this.tenant,[e],[x.wms])),this.loadPart(e,R,p,f))}}},u.prototype.isViscaUrl=function(e){var t=e.toLowerCase(),n=t.indexOf("-visca.");if(n>=0&&n<t.indexOf("?"))return!0;return!1},u.prototype.updateTenant=function(){this.tenant=this.getSecurityParamsCB?this.getSecurityParamsCB().tenant:"#NONE#"},u.prototype.handleReferences=function(e,t){this.tenant||this.updateTenant(),this.manager=t.manager._ldhNodeManager;var n,i,o,r=this.manager;for(i=0;i<e.length;i++)o=(n=e[i]).getActiveRepresentation(),n.requestBuildSceneGraphHierarchy(!0);r.tryBuildSceneGraphHierarchy();var s=[],d=[],h=new c(t,e.length);for(i=0;i<e.length;i++)(o=(n=e[i]).getActiveRepresentation()).url?(o!==n.getPrimaryRepresentation()&&o.buildNode(),o.node,this.isViscaUrl(o.url)&&!this.debugSingleMode?d.push(n):s.push(n),h.references.push(n),this.referenceToBatch.set(n,h)):setTimeout(function(){t.doneCB([],[n])},0);(s.length>0||d.length>0)&&(this.nbTickets--,a.onStartBatch(h.references.length),s.length>0&&(this.debugSingleMode?this.doDebugSingleLoad(h,s):this.downloadReferencesMQL(s,h,!1)),d.length>0&&this.requestVISCACheckoutTicket(d,h))},u.prototype.downloadReferencesMQL=function(e,t,n){this.maxTicketSize>0?this.requestMQLCheckoutTicket_size(e,t,n,this.maxTicketSize):this.requestMQLCheckoutTicket(e,t,n)},u.prototype.requestMQLCheckoutTicket_size=function(e,t,n,o){var r=this,s=this.getMQLUrl(),a=[],d=this.getSecurityParamsCB(),h=d.securityCtx?d.securityCtx:"preferred",l=d.userLogin||"",c=this.buildMQLSizeRequest(e,a);i.authenticatedRequest(s,{data:c,authentication:"passport",method:"POST",headers:{"Content-type":"application/xml",Accept:"text/plain",SecurityToken:l+"|"+h},proxy:"passport",onComplete:function(i){var s,d,h,l,c=function(e){var t,n,i,o,r=[],s=r,a=[r],d=null;if(e&&e.startsWith("fetch: ")){for(t=e.substring("fetch: ".length),n=0;n<t.length;n++)switch(i=t[n]){case" ":case"\n":case"\t":case"\r":break;case"{":o=[],s.push(o),a.push(o),s=o;break;case"}":null!==d&&(s.push(d),d=null),a.pop(),s=a[a.length-1]||null;break;default:null===d?d=i:d+=i}if(1!==a.length)return null}return r}(i),u=new Map;for(h=0;h<c.length;h++)for(d=c[h],l=0;l<d[4].length;l++)u.set(d[4][l][0],parseInt(d[5][l][0]));var p,f=0,g=[];for(h=0;h<e.length;h++)s=e[h],f+(p=u.get(a[h])||0)<o||0===f?(g.push(s),f+=p):(r.requestMQLCheckoutTicket(g,t,n),g=[s],f=p);g.length>0&&r.requestMQLCheckoutTicket(g,t,n)},onFailure:function(i){console.log("mql size error"),r.requestMQLCheckoutTicket(e,t,n)}})},u.prototype.requestMQLCheckoutTicket=function(e,t,n){var i=this,o=this.getSecurityParamsCB(),r=o.securityCtx?o.securityCtx:"preferred",s=o.userLogin||"",a=this.getMQLUrl(),d=this.buildMQLRequest(e);this.authenticatedRequest_MQL(a,{data:d,authentication:"passport",method:"POST",headers:{"Content-type":"application/xml",Accept:"text/plain",SecurityToken:s+"|"+r},proxy:"passport",onComplete:function(o){i.doCheckoutMQL(o,t,e,n)},onFailure:function(n){i.errorCallbackTest(t,e)}})},u.prototype.authenticatedRequest_MQL=function(e,t){i.authenticatedRequest(e,t)},u.prototype.requestVISCACheckoutTicket=function(e,t){var n,i,o=[],r=[];for(n=0;n<e.length;n++)i=e[n].getActiveRepresentation(),o.push(i.url),r.push("reference_"+n);var s=this.urlServices.CreateFetchURLAndBody(o,r,{allowPartial:!0,splitTargetedSize:this.maxTicketSize>0?this.maxTicketSize:void 0}),a=this.getSecurityParamsCB(),d=a.securityCtx?a.securityCtx:"preferred",h=this,l=s.url.replace("//api","/api");this.authenticatedRequest_VISCA(l,{method:"POST",data:s.body,headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:d},onComplete:function(n){var i=JSON.parse(n);h.doCheckoutVISCA(i,t,e)},onFailure:function(n){h.errorCallbackTest(t,e)}})},u.prototype.authenticatedRequest_VISCA=function(e,t){i.authenticatedRequest(e,t)},u.prototype.doCheckoutVISCA=function(e,t,n){var i,o,r,s,a,d,h=e.ticketWrappers,l=e.filesNotFound,c=[];if(l){for(i=0;i<l.length;i++)(o=(d=l[i]).correlationID)&&(r=o.split("reference_"),a=n[s=parseInt(r[1])],n[s]=null),a&&(d.emptyReason?"EmptyDerivedObject"===d.emptyReason?this.onModelLoaded(a,null,0,!1):this.onModelError(a):c.push(a));c.length&&this.downloadReferencesMQL(c,t,!0)}if(h)for(i=0;i<h.length;i++)this.doTicketWrapperCheckout(h[i],t,n)},u.prototype.doTicketWrapperCheckout=function(e,t,n){var i=e.url,o=e.ticket,r=null;e.correlationIDs&&1===e.correlationIDs.length&&(r=e.correlationIDs[0]),this.doCheckoutVISCASingle(i,o,t,n,r)},u.prototype.doCheckoutVISCASingle=function(e,t,n,o,r){var s=this,a={cors:!0,timeout:36e5,method:this.ODT?"GET":"POST",data:{__fcs__jobTicket:t},type:"arraybuffer",async:!0,headers:{Accept:"text/plain"},onComplete:function(e,t){s.parseMultiPartData(e,t,n,o,!0,!1,r)},onFailure:function(){s.errorCallbackTest(n,o),console.log("checkout ERROR")}};i.authenticatedRequest(e,a)},u.prototype.errorCallbackTest=function(e,t){this.doneCB(e,t,!1)},u.prototype.onModelLoaded=function(e,t,n){var i=e.getActiveRepresentation();n&&(i.type=d.RepType.av1);var o=this.referenceToBatch.get(e),r=o.context.manager;this.commitModelLoadedTransaction(e,r,t),this.doneCB(o,[e],!0)},u.prototype.onModelError=function(e){var t=this.referenceToBatch.get(e);this.doneCB(t,[e],!1)},u.prototype.doneCB=function(e,t,n){var i,o,r=e.context,s=r.manager;for(i=0;i<t.length;i++)(o=t[i])&&(o.referenceId,this.referenceToBatch.delete(o),n?r.doneCB([o],[]):r.doneCB([],[o]),e.size--);0===e.size&&(this.nbTickets++,a.onEndBatch(e.references.length),s._ldhNodeManager.requestUpdate(!1,!1))},u.prototype.getBatchSize=function(){return this.batchSize},u.prototype.acceptsRepresentation=function(e,t){return!!this.batchAV1||!(!e||e.isAV1())},u}),define("DS/3DXMTiles/LDHBatchModel3DHandlerVISCA",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/3DXMTiles/LDHReferenceStatus","DS/WAFData/WAFData","DS/Visualization/ModelLoader","DS/3DXMTiles/CopyViscaURLServices","DS/3DXMTiles/LDHReference","DS/3DXMTiles/LDHStats"],function(e,t,n,i,o,r,s,a){"use strict";function d(e,t,n){var i,o,r=e.length;for(i=t;i<r&&(13!==(o=255&e.charCodeAt(i))&&10!==o);i++);return i+1<r?(13!==(o=255&e.charCodeAt(i+1))&&10!==o||i++,{str:e.slice(t,i),index:i+1}):null}var h=function(e,t){this.currentIndex=0,this.waitForSize=0,this.handler=e,this.onPartExtracted=t,this.nextReferenceIndex=0};h.prototype.onProgress=function(e){if(!(e.length<this.waitForSize))for(var t=!0;t;)t=this.tryToLoadPart(e)},h.prototype.tryToLoadPart=function(e){new TextDecoder;var t,n,i,o=this.nextReferenceIndex,r=this.currentIndex,s=-1;do{if(!(t=d(e,r)))return!1;r=t.index,(i=t.str).startsWith("Content-length:")&&(n=i.split(" "),s=parseInt(n[1])),i.startsWith("X-CorelationID:")&&(n=i.split("reference_"),o=parseInt(n[1]))}while(s<0&&r<e.length);if(!(t=d(e,r)))return!1;if(r=t.index,this.waitForSize=r+s,s>0&&r+s<e.length){for(var a=new Uint8Array(s),h=0;h<s;++h)a[h]=255&e.charCodeAt(r+h);return this.currentIndex=r+s,this.nextReferenceIndex++,this.onPartExtracted(o,a),!0}return!1};var l=0;function c(e,t){this.index=l++,this.context=e,this.references=[],this.size=t,this.startTime=performance.now()}var u={nbKO:0,nbOK:0,successRate:0,onKO:function(){this.nbKO++,this.successRate=this.nbOK/(this.nbKO+this.nbOK)},onOK:function(){this.nbOK++,this.successRate=this.nbOK/(this.nbKO+this.nbOK)}};window.OOCSuccessRate=u;var p=function(t,n,i){e.call(this,e.Model3DHandler),this.loadModelOptions=null,this.debug=!!t.debug,this.manager=null,this.loadingInProgress=!1,this.nbTickets=n,this.batchSize=i,this.modelLoader=new o,this.modelLoader.sharedBuffers=!1,this.modelLoader.setFileType("cgr"),this.modelLoader.setKeepLoaderMode(!0),this.referenceToBatch=new Map,this.urlServices=new r,this.getSecurityParamsCB=t.getSecurityParamsCB||null};(p.prototype=Object.create(e.prototype)).setFileType=function(e){this.fileType=e},p.prototype.setRestricted=function(){},p.prototype.isReady=function(){return this.nbTickets>0},p.prototype.setLoadModelOptions=function(e){this.loadModelOptions=e},p.prototype.setRedirectUrlCB=function(){},p.prototype.setAutoRedirect=function(){};var f=document.createElement("a");p.prototype.getParams=function(e){var t={};f.href=e;for(var n,i=f.search.substring(1).split("&"),o=0;o<i.length;o++){var r=i[o].split("=");t[r[0]]=(n=r[1],decodeURIComponent((n+"").replace(/\+/g,"%20")))}return t};var g={getfcsurls:{url:"/resources/enopad/getfcsurls",verb:"POST"},fileurls:{url:"/resources/fcsservices/fcs/fileurls",verb:"POST"},reps:{url:"/api/V1/reps",verb:"POST"},rep:{url:"/api/V1/rep",urlLower:"/api/v1/rep",verb:"POST"},xmql:{url:"/i3dx/services/xmql",verb:"POST"}};p.prototype.buildMQLRequest=function(e){var t,n,i,o,r="[";for(t=0;t<e.length;t++)i=e[t].getActiveRepresentation(),t>0&&(r+=","),r+='{"correlationId":"'+(o=t+1)+'","filename":"'+(n=this.getParams(i.url)).filename+'","format":"'+n.format+'","path":"'+o+'","physicalid":"'+n.boid+'"}';return r+="]",['<?xml version="1.0" encoding="utf-8"?>','<executeSequence xmlns="http://www.3ds.com/xmql/query">',"  <execute>","    <function>get_checkout_ticket</function>","    <version>2.1.0</version>","    <params>",'      <param name="label">ticket</param>','      <param name="mcsurl">'+function(e){var t=e.getActiveRepresentation().url,n=t.toLowerCase().indexOf("/resources/fcsservices/");return n>=0?t.substring(0,n):"##error##"}(e[0])+"</param>",'      <param name="bops">[{"bops":'+r+',"store":"plmx"}]</param>',"    </params>","  </execute>","</executeSequence>"].join("\n")};return p.prototype.doCheckoutMQL=function(e,t,n){var o=this;n=n;function r(e,t,n){o.onModelLoaded(e,t,n)}function s(e){o.onModelError(e)}var a=new h(this,function(e,t){var i=n[e];o.loadPart(t,i,r,s)}),d=1===n.length?"arraybuffer":"text/plain",l=1===n.length?null:"text/plain; charset=x-user-defined",c=/\{\{([^\}]*)\}\{([^\}]*)\}\}/.exec(e),u=c[1],p=c[2],f=(o=this,{cors:!0,timeout:1e5,method:"POST",data:{__fcs__jobTicket:u},type:d,mimeType:l,async:!0,headers:{Accept:"text/plain"},onComplete:function(e){if(1===n.length){var t=n[0];o.loadPart(e,t,r,s)}},onProgress:function(e){n.length>1&&a.onProgress(e.target.responseText,t)},onFailure:function(){console.log("checkout ERROR")}});i.authenticatedRequest(p,f)},p.prototype.loadPart=function(e,n,i,o){var r=n.getActiveRepresentation().node,s=e.byteLength;this.modelLoader.setOnLoadedProductStructureCallback(function(e){i(n,e,s)}),this.modelLoader.setOnErrorCallback(function(){o(n)}),t.setupModelLoader(this.modelLoader,n),this.modelLoader.loadModelFromBuffer(e,r,{})},window.myLength=[],p.prototype.isViscaUrl=function(e){var t=e.toLowerCase(),n=t.indexOf("-visca.");if(n>=0&&n<t.indexOf("?"))return!0;return!1},p.prototype.handleReferences=function(e,t){this.manager=t.manager._ldhNodeManager;var n,i,o,r=this.manager;for(i=0;i<e.length;i++)o=(n=e[i]).getActiveRepresentation(),n.requestBuildSceneGraphHierarchy(!0);r.tryBuildSceneGraphHierarchy();var s=[],d=[],h=new c(t,e.length);for(i=0;i<e.length;i++)(o=(n=e[i]).getActiveRepresentation())!==n.getPrimaryRepresentation()&&o.buildNode(),o.node,this.isViscaUrl(o.url)?d.push(n):s.push(n),h.references.push(n),this.referenceToBatch.has(n.referenceId)&&console.log("ben v'la aut' chose"),this.referenceToBatch.set(n.referenceId,h);this.nbTickets--,a.onStartBatch(h.references.length),s.length>0&&this.requestMQLCheckoutTicket(s,h),d.length>0&&this.requestVISCACheckoutTicket(d,h)},p.prototype.requestMQLCheckoutTicket=function(e,t){var n,o,r,s=this,a=this.buildMQLRequest(e),d=(n=e[0],o=n.getActiveRepresentation().url,(r=o.toLowerCase().indexOf("/resources/fcsservices/"))>=0?o.substring(0,r)+g.xmql.url:"##error##");i.authenticatedRequest(d,{data:a,authentication:"passport",method:"POST",headers:{"Content-type":"application/xml",Accept:"text/plain"},proxy:"passport",onComplete:function(n){s.doCheckoutMQL(n,t,e)},onFailure:function(n){s.errorCallbackTest(t,e)}})},p.prototype.requestVISCACheckoutTicket=function(e,t){var n,o,r=[],s=[];for(n=0;n<e.length;n++)o=e[n].getActiveRepresentation(),r.push(o.url),s.push("reference_"+n);var a=this.urlServices.CreateFetchURLAndBody(r,s,{allowPartial:!0}),d=this.getSecurityParamsCB(),h=d.securityCtx?d.securityCtx:"preferred",l=this,c=a.url.replace("//api","/api");i.authenticatedRequest(c,{method:"POST",data:a.body,headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:h},onComplete:function(n){var i=JSON.parse(n);l.doCheckoutVISCA(i,t,e)},onFailure:function(n){l.errorCallbackTest(t,e)}})},p.prototype.doCheckoutVISCA=function(e,t,n){var i,o,r,s=e.ticketWrappers;for(i=0;i<s.length;i++)o=s[i].url,r=s[i].ticket,this.doCheckoutVISCASingle(o,r,t,n)},p.prototype.doCheckoutVISCASingle=function(e,t,n,o){var r=this;o=o;function s(e,t,n){r.onModelLoaded(e,t,n)}function a(e){r.onModelError(e)}var d=new h(this,function(e,t){var n=o[e];r.loadPart(t,n,s,a)}),l={cors:!0,timeout:1e5,method:"POST",data:{__fcs__jobTicket:t},type:1===o.length?"arraybuffer":"text/plain",mimeType:1===o.length?null:"text/plain; charset=x-user-defined",async:!0,headers:{Accept:"text/plain"},onComplete:function(e){if(1===o.length){var t=o[0];r.loadPart(e,t,s,a)}},onProgress:function(e){o.length>1&&d.onProgress(e.target.responseText,n)},onFailure:function(){console.log("checkout ERROR")}};i.authenticatedRequest(e,l)},p.prototype.errorCallbackTest=function(e,t){this.doneCB(e,t,!1)},p.prototype.onModelLoaded=function(e,t,n){var i=e.getActiveRepresentation();t&&t.nodes&&e.setCGRNodeNames(t.nodes,i),u.onOK(),a.onLoadedModel(n);var o=e.referenceId,r=this.referenceToBatch.get(o),s=r.context.manager,d=s._ldhNodeManager;e.showActiveRepresentation(d),e.setRepLoaded(!0),d.onLeafReferenceLoadedCB&&d.onLeafReferenceLoadedCB(e.referenceId,t),i.updateMeshSize(e),e.updateMemorySizeNEW(d),s._startModelLoaderTransaction(),s._onRepLoaded(e),s.endInstRefGraphTransaction(),this.doneCB(r,[e],!0)},p.prototype.onModelError=function(e){u.onKO();var t=this.referenceToBatch.get(e.referenceId);this.doneCB(t,[e],!1)},window.myBatches=[],p.prototype.doneCB=function(e,t,n){var i,o,r,s=e.context,d=s.manager;for(i=0;i<t.length;i++)r=t[i].referenceId,this.referenceToBatch.delete(r),o=d._getLDHReference(r),n?s.doneCB([o],[]):s.doneCB([],[o]),e.size--;if(0===e.size){performance.now();this.nbTickets++,a.onEndBatch(e.references.length),d._ldhNodeManager.requestUpdate(!1,!1)}},p.prototype.getBatchSize=function(){return this.batchSize},p}),define("DS/3DXMTiles/LDHModel3DHandler2",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/3DXMTiles/LDHReferenceStatus","DS/WAFData/WAFData","DS/3DXMTiles/CopyViscaURLServices","DS/3DXMTiles/LDHReference","DS/3DXMTiles/LDHReferenceRep","DS/3DXMTiles/LDHStats"],function(e,t,n,i,o,r,s,a){"use strict";var d=function(e,t){this.references=e,this.nbRedirected=0,this.context=t,this.okReferences=[],this.koReferences=[]};d.prototype.addOkReference=function(e){var t=e.getReference();this.okReferences.push(t)},d.prototype.addKoReference=function(e){var t=e.getReference();this.koReferences.push(t)},d.prototype.isComplete=function(){return this.okReferences.length+this.koReferences.length>=this.references.length};var h=function(e,t,n){this.batch=e,this.index=t,this.newURL=n,this.newType=null};h.prototype.getUrl=function(){return this.batch.references[this.index].getActiveRepresentation().url},h.prototype.getReference=function(){return this.batch.references[this.index]};var l=function(t){e.call(this,e.Model3DHandler),this.fileType=null,this.redirectUrlCB=null,this.loadModelOptions=null,this.batches=[],this.toLoad=[],this.debug=!!t.debug,this.manager=null,this.minBatchSize=40,this.maxTickets=t.batchSize||100,this.maxRedirectTickets=t.redirectBatchSize||40,this.tickets=this.maxTickets,this.redirectTickets=this.maxRedirectTickets,this.nbLoadReferenceTickets=20,this.pauseInterval=null,this.getSecurityParamsCB=t.getSecurityParamsCB||null,this.autoRedirect=!1,this.urlServices=new o,this.debugLoadModelDelay=0,this.debugLockedReferences=null,this.debugModelLoaded=null};(l.prototype=Object.create(e.prototype)).setFileType=function(e){this.fileType=e},l.prototype.setRestricted=function(){this.minBatchSize=2,this.maxTickets=2,this.maxRedirectTickets=2,this.tickets=this.maxTickets,this.redirectTickets=this.maxRedirectTickets},l.prototype.isReady=function(){return this.tickets>=this.minBatchSize},l.prototype.setLoadModelOptions=function(e){this.loadModelOptions=e},l.prototype.redirectNeeded=function(){return!this.autoRedirect&&window.WUXForceAutoRedirect&&this.setAutoRedirect(!0),!(!this.redirectUrlCB&&!this.autoRedirect)},l.prototype.handleReferences=function(e,t){if(this.debugLoadModelDelay){var n=this;setTimeout(function(){n.handleReferences_internal(e,t)},this.debugLoadModelDelay)}else this.handleReferences_internal(e,t)},l.prototype.handleReferences_internal=function(e,t){if(this.debugLockedReferences){var n=[];for(o=0;o<e.length;o++)this.debugLockedReferences.indexOf(e[o].referenceId)>=0&&(n.push(e[o]),e[o]=null);var i=0;for(o=0;o<e.length;o++)null!==e[o]&&(e[i]=e[o],i++);e.length=i,n.length&&setTimeout(this.handleReferences.bind(this,n,t),100)}this.manager=t.manager._ldhNodeManager;var o,r,s=new d(e,t);if(this.batches.push(s),a.onStartBatch(e.length),this.incTickets(-e.length),this.redirectNeeded())this.redirectUrls();else{for(o=0;o<s.references.length;o++)r=s.references[o].getActiveRepresentation(),this.toLoad.push(new h(s,o,r.url));this.loadModels()}},l.prototype.redirectUrls=function(){if(this.redirectTickets>0){var e,t,n,i,o=[],r=[];for(e=0;e<this.batches.length;e++)for(i=(t=this.batches[e]).nbRedirected;this.redirectTickets>0&&i<t.references.length;i++)t.nbRedirected++,(n=new h(t,i,null)).getUrl()?(o.push(n),r.push(n.getUrl()),this.incRedirectTickets(-1)):this.toLoad.push(n);if(o.length>0){var s=this;this.incRedirectTickets(-this.redirectTickets),this.doRedirectUrls(r,function(e,t,n){var i;for(s.incRedirectTickets(-s.redirectTickets+s.maxRedirectTickets),i=0;i<e.length;i++){if(o[i].newURL=e[i],t&&(o[i].newType=t[i]),n&&n[i])o[i].batch.references[o[i].index].getActiveRepresentation().updateUrl(n[i]);s.toLoad.push(o[i])}s.redirectUrls(),s.loadModels()})}}},l.prototype.doRedirectUrls=function(e,t){this.redirectUrlCB&&!this.autoRedirect?this.redirectUrlCB(e,t):this.autoRedirectUrl(e,t)},l.prototype.loadModels=function(){if(!this.manager.getPauseLoading())return this.loadModels_internal();if(!this.pauseInterval){var e=this;this.pauseInterval=setInterval(function(){e.manager.getPauseLoading()||(clearInterval(e.pauseInterval),e.pauseInterval=null,e.loadModels_internal())},100)}},l.prototype.loadModels_internal=function(){var e;for(this.debug&&t.setDebug(!0);this.nbLoadReferenceTickets>0&&this.toLoad.length>0;)(e=this.toLoad.shift()).newURL?(this.nbLoadReferenceTickets--,t._loadModel(e.newURL,e.getReference(),this.onModelLoaded.bind(this,e),this.onModelError.bind(this,e),null,this.fileType,this.loadModelOptions,this.manager)):setTimeout(this.onModelError.bind(this,e),1)},l.prototype.onModelLoaded=function(e,t){this.incTickets(1),this.nbLoadReferenceTickets++;var n,i=e.batch,o=i.context;n=e.getReference(),this.debugModelLoaded&&this.debugModelLoaded(n);var r=n.getActiveRepresentation();e.newType&&"av1"===e.newType.toLowerCase()&&(r.type=s.RepType.av1),this.commitModelLoadedTransaction(n,o.manager,t),o.doneCB([n],[]),i.isComplete()&&this.onBatchComplete(i),this.loadModels()},l.prototype.onModelError=function(e){this.incTickets(1),this.nbLoadReferenceTickets++;var t,n=e.batch,i=n.context;t=e.getReference(),i.manager._startModelLoaderTransaction(),i.manager._onRepLoaded(t),i.manager.endInstRefGraphTransaction(),i.doneCB([],[t]),n.isComplete()&&this.onBatchComplete(n),this.loadModels()},l.prototype.onBatchComplete=function(e){a.onEndBatch(e.references.length);var t=this.batches.indexOf(e);this.batches.splice(t,1);e.context,e.okReferences;e.references=[],e.okReferences=[],e.koReferences=[]},l.prototype.getModelLoader=function(){return t.modelLoader},l.prototype.getBatchSize=function(){return this.tickets},l.prototype.setRedirectUrlCB=function(e){this.redirectUrlCB=e},l.prototype.setAutoRedirect=function(e){this.autoRedirect=!!e},l.prototype.incTickets=function(e){this.tickets+=e},l.prototype.incRedirectTickets=function(e){this.redirectTickets+=e},l.prototype.autoRedirectUrl=function(e,t){this._fcsFileurls({urls:e,callbacks:{onComplete:function(e,n){if(e){var i,o,r=[],s=[],a=[];for(i=0;i<e.length;i++)o=n[i],void 0!==e[i].checksum?(r[o]=e[i].url,s[o]=e[i].type,a[o]=e[i].updatedAccessUrl):0===e[i].status?(r[o]=e[i].fileurl,s[o]=null):r[o]=null;t(r,s,a)}},onFailure:function(n){for(var i=[],o=0;o<e.length;o++)i.push(null);t(i)}}})},l.prototype._fcsFileurls=function(e){var t;var n=function(e){var t={},n=document.createElement("a");n.href=e;for(var i,o=n.search.substring(1).split("&"),r=0;r<o.length;r++){var s=o[r].split("="),a=s[0];"boid"===a&&(a="id"),t[a]=(i=s[1],decodeURIComponent((i+"").replace(/\+/g,"%20")))}return t},i=[],o=0,r=[];function s(t,n){o--,i=i.concat(t),r=r.concat(n),0===o&&e.callbacks.onComplete(i,r)}var a,d,h=[],l=[],u={data:[],onComplete:function(e){try{s(UWA.is(e,"object")?e:JSON.parse(e),h)}catch(e){console.warn("Error while parsing results")}},onFailure:function(t){e.callbacks.onFailure(t)}},p={data:[],onComplete:function(e){try{s((UWA.is(e,"object")?e:JSON.parse(e)).files,l)}catch(e){console.warn("Error while parsing results")}},onFailure:function(t){e.callbacks.onFailure(t)}},f=null,g=[];for(t=0;t<e.urls.length;t++)if(a=e.urls[t],this.isViscaUrl(a)){if(this.urlServices)g.push(a);else{if(d=n(a),!f){var m=a.toLowerCase().indexOf(c.rep.urlLower);f=m>=0?a.substring(0,m)+c.reps.url:"##error##"}p.data.push(d)}l.push(t)}else(d=n(a)).id&&d.format&&d.filename&&u.data.push(d),h.push(t);u.data.length&&(o++,this.fileurls(u)),p.data.length&&(o++,this.reps(p,f)),g.length>0&&(o++,this.viscaQuery(g,p))};var c={getfcsurls:{url:"/resources/enopad/getfcsurls",verb:"POST"},fileurls:{url:"/resources/fcsservices/fcs/fileurls",verb:"POST"},reps:{url:"/api/V1/reps",verb:"POST"},rep:{url:"/api/V1/rep",urlLower:"/api/v1/rep",verb:"POST"}};return l.prototype.isViscaUrl=function(e){var t=e.toLowerCase(),n=t.indexOf("-visca.");if(n>=0&&n<t.indexOf("?"))return!0;return!1},l.prototype.buildDataWithGoodNames=function(e,t){var n,i={};for(n in e)i[e[n]]=t[n];return i},l.prototype.reps=function(e,t){var n,i={s:"source",t:"tenant",id:"boid",f:"filename",v:"version",ts:"timeStamp",type:"repType",sgn:"signature"};for(n=0;n<e.data.length;n++)e.data[n]=this.buildDataWithGoodNames(i,e.data[n]);return e.data=JSON.stringify(e.data),e.method="POST",e.headers={Accept:"application/json","Content-Type":"application/json"},this.finalExecuteRequest(t,e)},l.prototype.fileurls=function(e){var t,n=this.getSecurityParamsCB(),i=e;return t="onPremise"===n.tenant?n.service3DSpaceUrl+c.fileurls.url:n.service3DSpaceUrl+c.fileurls.url+"?tenant="+n.tenant,i.method=c.fileurls.verb,i.headers={Accept:"application/json","Content-Type":"application/json"},i.data=JSON.stringify(i.data),this.executeRequest_fileurls(t,i,void 0,void 0,n)},l.prototype.executeRequest_fileurls=function(e,t,n,i,o){var r=o.securityCtx?o.securityCtx:"preferred";return UWA.is(r,"string")&&!0!==n&&(t.headers.SecurityContext=r),this.finalExecuteRequest(e,t)},l.prototype.viscaQuery=function(e,t){var n=this.getSecurityParamsCB(),i=n.securityCtx?n.securityCtx:"preferred",o=this.urlServices.CreateBatchURLAndBody(e,{allowPartial:!0,fallback:!0});t.data=o.body,t.method="POST",t.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:i};var r=o.url.replace("//api","/api");return this.finalExecuteRequest(r,t)},l.prototype.finalExecuteRequest=function(e,t){return i.authenticatedRequest(e,t)},l}),define("DS/3DXMTiles/DSTilesStdContent",["DS/3DXMTiles/DSTilesContent","DS/3DXMTiles/PointCloudServices"],function(e,t){"use strict";var n=function(t){e.call(this),this.type=t.type,this.format=t.format,this.uri=t.uri;var n=t.fileSize?parseFloat(t.fileSize):0;isFinite(n)||(n=0),this.fileSize=n};return(n.prototype=Object.create(e.prototype)).getUri=function(){return this.uri},n.prototype.getFormat=function(){return this.format},n.createFromJSON=function(e){return e&&e.uri&&e.format?new n(e):null},n}),define("DS/3DXMTiles/DSTilesStdExpander",["DS/3DXMTiles/DSTilesExpander","DS/WAFData/WAFData","DS/3DXMTiles/DSTilesNode","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesURLContent","DS/3DXMTiles/DSTilesURLChildLink","DS/3DXMTiles/DSTilesStdContent","DS/3DXMTiles/DSTilesMeshContentLoader","DS/3DXMTiles/DSTilesScreenRadiusScoreComputer","DS/3DXMTiles/DSTilesR2VPointCloudContentLoader","DS/Visualization/Node3D","DS/3DXMTiles/DSTilesGenericScoreComputer","DS/3DXMTiles/DSTilesNodeStatus","DS/3DXMTiles/LDHStats"],function(e,t,n,o,r,s,a,d,h,l,c,u,p,f){"use strict";var g=function(e){this.tilesManager=null,this.meshContentLoader=e.meshContentLoader,this.r2vPointCloudContentLoader=e.r2vPointCloudContentLoader,this.volumeContentLoader=e.volumeContentLoader,this.buildUrlCB=e.buildUrlCB||null,this.scoreComputer=e.scoreComputer,this._dbg_onLoadedNodeCB=e._dbg_onLoadedNodeCB,this.nbTickets=20,this.jsonPreprocessCB=e.jsonPreprocessCB||null,this.worldMatrixMap=new WeakMap};return(g.prototype=Object.create(e.prototype)).init=function(e){null===this.tilesManager&&(this.tilesManager=e,this.meshContentLoader&&this.meshContentLoader.init(e),this.r2vPointCloudContentLoader&&this.r2vPointCloudContentLoader.init(e),this.volumeContentLoader&&this.volumeContentLoader.init(e))},g.prototype.isReady=function(){return this.nbTickets>0},g.prototype.isThereEnoughMemoryToExpand=function(e,t){return!0},g.prototype.expandNow=function(e){if(!e.isAlive())return!0;var t=e.queue,n=e.queue.queueSet,o=e.tileSet,r=e.childrenURIs,s=[],a=[];for(i=0;i<r.length;i++){var d=this.createNodeFromPreloaded(e,r[i],n,o,a);if(!d)return!1;s.push(d)}return function(){var n,i,o;for(e.tileSet.addNode(e),n=0;n<s.length;n++)(i=s[n]).tileSet.addNode(i),e.addChild(i),i.children&&i.children.length>0&&i.setExpandStatus(p.loaded,t),t.registerDSTilesNode(i);for(n=0;n<a.length;n++)(o=a[n]).tileSet.addNode(a[n]),o.children&&o.children.length>0?o.setExpandStatus(p.loaded,t):t.registerDSTilesNode(o)}(),!0},g.prototype.createNodeFromPreloaded=function(e,t,n,i,o){var r=i.preloadedJsonMap.get(t);return r?this.createNodeFromJSON(r,e,t,n,i,o):null},g.prototype.createNodeFromJSON=function(e,t,i,r,s,d){var h,l=null,c=null,u=1/0,p=null,f=[];if(e.children)for(h=0;h<e.children.length;h++)f.push(e.children[h]);var g=null;if(e.matrix)(p=new o.Matrix4).setFromJSON(e.matrix);else if(e.worldMatrix){var m=null;if((m=new o.Matrix4).setFromJSON(e.worldMatrix),g=m.clone(),t){var y=this.worldMatrixMap.get(t)||null;if(t.updateWorldMatrix(),y){var v=new o.Matrix4;v.getInverse(y),m.multiplyMatrices(v,m)}}p=m}var M=e.boundingVolume;M&&(M.sphere&&(l=new o.Sphere).setFromJSON(M.sphere),M.box&&(c=new o.Box3).setFromJSON(M.box));var S=e.triggerCondition,L=null;S&&(S.hasOwnProperty("geometricalError")?(u=parseFloat(S.geometricalError),L="pixelError"):S.hasOwnProperty("distanceToBox")&&(u=parseFloat(S.distanceToBox),L="distanceToBox"));var D=null;if(null===(D="add"===e.mode?n.Mode.addLOD:"ADD"==e.mode?n.Mode.addLOD:"replace"==e.mode?n.Mode.replaceLOD:t?t.mode:n.Mode.replaceLOD))throw new Error("mode is mandatory");var T=a.createFromJSON(e.content),R=null;if(null!==T)switch(T.type){case"mesh":R=this.meshContentLoader;break;case"pointCloud":case"POINTCLOUD":R=this.r2vPointCloudContentLoader;break;case"volume":R=this.volumeContentLoader}e.content&&this.modelLoaderHandler;var x=r.getQueueFromTileSet(s),C=new n({uri:i,tileSet:s,contentLoader:R,expander:this,childrenURIs:f,scoreComputer:this.scoreComputer,matrix:p&&!p.isIdentity()?p:null,geometricalError:u,boundingBox:c,boundingSphere:l,content:T,mode:D,queue:x,userData:e.userData,metaData:e.contentMetaData,triggerMetric:L});return C.setMatrixUpdate(!0),g&&this.worldMatrixMap.set(C,g),d&&this.completeNodeChildrenIfPossible(C,r,s,x,d),C},g.prototype.completeNodeChildrenIfPossible=function(e,t,n,i,o){var r,s=!1;for(r=0;e.childrenURIs&&r<e.childrenURIs.length&&!s;r++)n.preloadedJsonMap.has(e.childrenURIs[r])||(s=!0);if(!s){var a,d,h;for(r=0;e.childrenURIs&&r<e.childrenURIs.length&&!s;r++)h=e.childrenURIs[r],a=n.preloadedJsonMap.get(h),d=this.createNodeFromJSON(a,e,h,t,n,o),o.push(d),e.addChild(d);e.children||(e.children=[])}},g.create=function(e){function t(t){return e.baseContentURL+t}var n=new d({buildUrlCB:t}),i=new c;e.viewer.addNode(i);var o=new l({targetSGNode:i,buildUrlCB:t}),r=new DSTilesVolumeContentLoader({viewer:e.viewer,buildUrlCB:t});return new g({meshContentLoader:n,r2vPointCloudContentLoader:o,volumeContentLoader:r,scoreComputer:new u(e.scoreComputerParams),buildUrlCB:function(t){return e.baseTileURL+t}})},g}),define("DS/3DXMTiles/LDHHandlerOOCAdapter",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/OOCPath"],function(e,t){"use strict";var n=function(t){e.call(this,t.type),this.oocHandler=t};return(n.prototype=Object.create(e.prototype)).handleReferences=function(e,n,i,o){var r,s,a=[];for(r=0;r<e.length;r++){var d=e[r];(s=t.buildFromReference(d,!0,o,this.oocHandler.manager))&&a.push(s)}var h={viewpointTag:n.viewpointTag,doneCB:this.adapterDoneCB.bind(this,n),screenRadius:n.screenRadius};this.oocHandler.handlePathes(a,h,i)},n.prototype.isReady=function(){return this.oocHandler.isReady()},n.prototype.getBatchSize=function(){return this.oocHandler.getBatchSize()},n.prototype.adapterDoneCB=function(e,t,n){var i,o,r=[],s=[];for(i=0;i<t.length;i++)(o="string"==typeof t[i]?this.oocHandler.manager._getLDHReference(t[i],!0):t[i]._ldhReference)&&r.push(o);for(i=0;i<n.length;i++)o="string"==typeof n[i]?this.oocHandler.manager._getLDHReference(n[i]):n[i]._ldhReference,s.push(o);e.doneCB(r,s)},n}),define("DS/3DXMTiles/OOCHandler",["DS/3DXMTiles/LDHHandlerOOCAdapter"],function(e){"use strict";var t=0,n=function(n,i){this.type=n,this.id=t++,this.ldhHandler=i||new e(this)};return n.prototype.handlePathes=function(e,t){},n.prototype.getBatchSize=function(){return 1},n.Model3DHandler=0,n.InstRefHander=1,n.TileSetHandler=2,n}),define("DS/3DXMTiles/LDHHandlerMultiple",["DS/3DXMTiles/LDHHandler"],function(e){"use strict";var t=function(e){this.type=0,this.handlers=e.handlers,this.batchSize=e.batchSize||40,this.getSecurityParamsCB=e.getSecurityParamsCB||null};(t.prototype=Object.create(e.prototype)).setLoadModelOptions=function(e){var t;for(t=0;t<this.handlers.length;t++)this.handlers[t].setLoadModelOptions(e)},t.prototype.setFileType=function(e){var t;for(t=0;t<this.handlers.length;t++)this.handlers[t].setFileType(e)},t.prototype.setRedirectUrlCB=function(e){var t;for(t=0;t<this.handlers.length;t++)this.handlers[t].setRedirectUrlCB(e)},t.prototype.setAutoRedirect=function(e){var t;for(t=0;t<this.handlers.length;t++)this.handlers[t].setAutoRedirect(e)},t.prototype.handleBatch=function(e,t){var n,i,o=this.handlers;for(n=0;n<o.length;n++)(i=e.batches[n]).isEmpty()||o[n].handleBatch(i,t)},t.prototype.createBatch=function(){return new n(this,this.batchSize)},t.prototype.isReady=function(){var e,t=this.handlers;for(e=0;e<t.length;e++)if(!t[e].isReady())return!1;return!0};var n=function(e,t){this.maxSize=t,this.handler=e,this.batches=[];var n,i=this.handler.handlers;for(n=0;n<i.length;n++)this.batches.push(i[n].createBatch())};return n.prototype.containsReference=function(e){var t;for(t=0;t<this.batches.length;t++)if(this.batches[t].containsReference(e))return!0;return!1},n.prototype.addReferenceIfPossible=function(e,t){var n,i=this.handler.handlers;for(t=t||e.getActiveRepresentation(),n=0;n<i.length;n++)if(i[n].acceptsRepresentation(t,e))return!!this.batches[n].addReferenceIfPossible(e,t);return!1},n.prototype.isEmpty=function(){var e;for(e=0;e<this.batches.length;e++)if(!this.batches[e].isEmpty())return!1;return!0},n.prototype.getSize=function(){var e,t=0;for(e=0;e<this.batches.length;e++)t+=this.batches[e].getSize();return t},n.prototype.setReferencesLoading=function(e){var t;for(t=0;t<this.batches.length;t++)this.batches[t].setReferencesLoading(e)},t}),define("DS/3DXMTiles/OOCModel3DHandler",["DS/3DXMTiles/OOCHandler","DS/3DXMTiles/LDHModel3DHandler2","DS/3DXMTiles/LDHBatchModel3DHandlerVISCA","DS/3DXMTiles/LDHStats","DS/3DXMTiles/LDHBatchModel3DHandlerVISCANoStream","DS/QualityManager/QMController","DS/3DXMTiles/LDHHandlerMultiple","DS/3DXMTiles/LDHBatchModel3DHandlerBank"],function(e,t,n,i,o,r,s,a){var d=function(d){d=d||{};var h=window.OOCBatchMode||window.localStorage.getItem("OOCBatchMode"),l=r.getBatching();h?l="ON"===h:void 0!==d.batching&&(l=!!d.batching),void 0!==d.useBank?bankMode=d.useBank:bankMode=!(navigator.userAgent.match(/Android|iPhone|iPad|iPod|BlackBerry|Opera Mini|IEMobile/i)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1)&&r.getLocalCache(),"ON"===window.localStorage.getItem("OOCBankMode")&&(bankMode=!0),bankMode&&(d.saveToBank=!0,l=!0);var c=null,u="ON"===(window.OOCLiveBatchUnstream||window.localStorage.getItem("OOCLiveBatchUnstream"));if(i.addFlag(l?u?"batching live":"batching":"no batching"),l){d.maxTicketSize=void 0!==d.maxTicketSize?d.maxTicketSize:20971520;var p=window.localStorage.getItem("OOCMaxTicketSize");p&&(p=parseInt(p));c=u?new n(d,12,40):new o(d,12,40)}var f=new t(d);this.singleHandler=f;var g=c?[c,f]:[f];if(bankMode){g=[new a(d,40)].concat(g)}var m=new s({handlers:g,getSecurityParamsCB:d.getSecurityParamsCB});e.call(this,e.Model3DHandler,m)};return(d.prototype=Object.create(e.prototype)).setFileType=function(e){this.ldhHandler.setFileType(e)},d.prototype.setLoadModelOptions=function(e){this.ldhHandler.setLoadModelOptions(e)},d.prototype.getModelLoader=function(){return this.ldhHandler.getModelLoader()},d.prototype.setRedirectUrlCB=function(e){this.ldhHandler.setRedirectUrlCB(e)},d.prototype.setAutoRedirect=function(e){this.ldhHandler.setAutoRedirect(e)},d}),define("DS/3DXMTiles/LDHNodeManagerQueue",["DS/3DXMTiles/PriorityQueue","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/LDHOcclusionStatus","DS/3DXMTiles/Debug3DXMTiles","DS/3DXMTiles/LDHReference","DS/3DXMTiles/LDHStats","DS/Visualization/ThreeJS_R57"],function(e,t,n,i,o,r,s,a){"use strict";var d=function(t,n){this.type=t,this.handler=null,this.manager=n,this.newNodes=[],this.nodes=[],this.pendingNodes=[],this.nbNodesToRemoveFromList=0,this.viewpointData=null,this.enableOcclusionTest=!0,this.occlusionList=[],this.nodesToLoadQueue=new e,this.nodesToUpdateSet=new Set,this.loadedNodesQueue=new e,this.forcedReferences=[],this.unknownReferences=[],this.referenceSizeMap=new Map,this.nbLoading=0,this.nbLoaded=0,this.occlusionNbLoaded=0,this.renderingOccured=!1,this.nodesToLoadHasBeenReset=!1,this.unloadedReferenceIds=new Set,this.targetOcclusionNbLoaded=0};return d.prototype.registerNode=function(e){if(null==this.handler)this.handler=e.handler,this.manager.unloadManager.isRestricted&&this.handler.setRestricted();else if(this.handler!==e.handler)throw new Error("different handler found");this.addToLoadedNodesQueue(e);var t=!1;e.isForced()&&e.shouldBeExpanded()?e.isInForced()||(t=!0,e.setInForced(!0),this.forcedReferences.push(e)):e.isInForced()&&(this.removeForcedNode(e),e.setInForced(!1)),e.isUnknown()?e.isInUnknown()||t||(t=!0,e.setInUnknown(!0),this.unknownReferences.push(e)):e.isInUnknown()&&(this.removeUnknownNode(e),e.setInUnknown(!1),e.updateBoundingElementImpostor()),e.isInList()?this.forceUpdateNode(e):(e.setInList(!0),this.newNodes.push(e))},d.prototype.unregisterNode=function(e){e.isInUnknown()&&(this.removeUnknownNode(e),e.setInUnknown(!1)),e.isInForced()&&(this.removeForcedNode(e),e.setInForced(!1))},d.prototype.onReferenceUnloaded=function(){this.nodesToLoadQueue.cleanNulls()},d.prototype.removeUnknownNode=function(e){var t=this.unknownReferences.indexOf(e);t>=0&&this.unknownReferences.splice(t,1)},d.prototype.removeForcedNode=function(e){var t=this.forcedReferences.indexOf(e);t>=0&&this.forcedReferences.splice(t,1)},d.prototype.forceUpdateNode=function(e){e&&(this.nodesToUpdateSet.add(e),e.isForced()&&!e.isInForced()&&e.shouldBeExpanded()&&(this.forcedReferences.push(e),e.setInForced(!0)))},d.prototype.updateNodes=function(e,t){var n=!1;if(null===this.handler)return!1;t?this.viewpointData=t:t=this.viewpointData,e&&(this.unloadedReferenceIds=new Set);var i=e;i||this.nodesToLoadHasBeenReset||(this.updateNodesToLoad(this.newNodes,t),this.updateNodesToLoad(Array.from(this.nodesToUpdateSet),t),n=this.newNodes.length>0||this.nodesToUpdateSet.size>0);this.newNodes.length;return function(e,t){var n;for(n=0;n<t.length;n++)e.push(t[n])}(this.nodes,this.newNodes),this.newNodes.length=0,this.nodesToUpdateSet.clear(),this.removeUselessNodesFromList(this.nodes,e),i&&(this.resetNodesToLoad(),n=!0),(i||this.nodesToLoadHasBeenReset)&&this.updateNodesToLoad(this.nodes,t),n},d.prototype.updateNodesToLoad=function(e,t){var i,o,s,a=this.manager.enableUnload,d=this.manager.newLoadingBoxes,h=this.manager.occlusionChecker;for(i=0;i<e.length;i++)(o=e[i]).needScreenRadiusSizeComputation()&&(1===(s=o.updateNodeLOD(t))?o.shouldBeExpanded()&&!this.unloadedReferenceIds.has(o.referenceId)?o.isInToBeLoaded()||o.isInHighPriority()||(o.setInToBeLoaded(!0),this.enableOcclusionTest?(h&&h.showReference(o),this.occlusionList.push(o)):this.nodesToLoadQueue.addNode(o),o.setStatus(n.toLoad,this.manager)):o.isRepLoaded()?o.setStatus(n.loaded,this.manager):o.setStatus(n.waiting,this.manager):a&&(!o.isSlave()&&!o.hasUnloadFrozenParent()||o.isLoaded())&&(o.setStatus(n.toUnload,this.manager),this.unloadedReferenceIds.add(o.referenceId)),!d&&r.slaveBoxFix&&o.isSlave()&&!o.isComplete()&&(1===s?o.displayBox(this.manager):o.removeBox(this.manager)));this.nodesToLoadHasBeenReset=!1},d.prototype.requiresOcclusion=function(e,t){return!!(this.handler&&this.handler.isReady()&&this.occlusionList.length>0&&this.nodesToLoadQueue.isEmpty())||(this.isLoading()||!this.handler||this.handler.isReady()||this.manager.requestUpdate(!1,!1),!1)},d.prototype.hasOcclusionList=function(){return this.occlusionList.length>0},d.prototype.computeOcclusion=function(e,t){if(this.handler){if(o.startProbe("occlusion"+this.handler.type),this.renderingOccured=!1,!this.nodesToLoadQueue.isEmpty()){var n=this.nodesToLoadQueue.getAllNodes();this.occlusionList=n.concat(this.occlusionList)}var i,r;this.nodesToLoadQueue.clear();var s=!1;for(i=0;i<this.occlusionList.length;i++)(r=this.occlusionList[i])&&(r.addToOcclusionChecker(e),s=!0,0);if(s){e.computeVisibility();var a,d=0;for(i=0;i<this.occlusionList.length;i++)(r=this.occlusionList[i])&&(a=r.occlusionId)>=0&&r&&(e.getVisibility(a)||!r.hasGoodRep()?(r.setOcclusionVisible(!0),r._occlusionScore=e.scores[a],this.nodesToLoadQueue.addNode(r),this.occlusionList[i]=null,d++):(r.setOcclusionVisible(!1),r._onOccluded()));this.occlusionNbLoaded=this.nbLoaded+Math.floor(d/2)}o.endProbe("occlusion"+this.handler.type)}},d.prototype.resetNodesToLoad=function(){var e,t;for(this.nodesToLoadQueue.clear(function(e){e.setInToBeLoaded(!1),e.setOcclusionVisible(!1)}),e=0;e<this.occlusionList.length;e++)(t=this.occlusionList[e])&&(t.setInToBeLoaded(!1),t.setOcclusionVisible(!1));this.occlusionList=[],this.nodesToLoadHasBeenReset=!0},d.prototype.loadHighPriorityNodes=function(e,t){return this.loadNodeLists(e,[this.forcedReferences],t,!0)},d.prototype.loadUnknownNodes=function(e,t){return this.loadNodeLists(e,[this.unknownReferences],t,!1)},d.prototype.loadNodeLists=function(e,t,n,i){var o,r,s,a,d,h=this.handler,l=this.manager.unloadManager,c=this.manager,u=n||(h?h.createBatch():null);if(h&&h.isReady()){h.type;for(o=0;o<t.length;o++)for(s=t[o],r=0;r<s.length&&h.isReady();r++)(a=s[r]).isLoading()||u.containsReference(a)||a.isError()||(d=l.isLoadingAllowed(h.type),i&&!d&&(c.forceUnloadSmallNodes(1/0,e,h.type),d=l.isLoadingAllowed(h.type)),d&&(u.addReferenceIfPossible(a)||(this.loadBatch(u),u=h.createBatch())))}return u},d.prototype.loadNodes=function(e,t){var n=this.handler;if(n){var i=this.loadHighPriorityNodes(t,null),o=this.manager,r=!o.enableUnload||o.unloadManager.isLoadingAllowed(this.type),s=o.unloadManager,a=this;n.type;this.nodesToLoadQueue.traverseMaxPlus(function(e,d,h){if(e.isAlive()){if(s.wouldDownloadCauseEmergencyUnload(e.referenceId,a))return o.emergencyUnloadAvoided=!0,h(),void d();if(n.isReady()&&(!r&&o.unloadSmallNodesEnabled&&(a.manager.forceUnloadSmallNodes(e.getScore(),t,n.type),r=s.isLoadingAllowed(n.type)),r))return e.hasDifferentViewpointTag(o.viewpointTag)&&(e._occurrences.length>0||e.isSlave())&&!e.isInHighPriority()&&!i.addReferenceIfPossible(e)?(h(),a.loadBatch(i),void(i=n.createBatch())):(e.setInToBeLoaded(!1),void e.setOcclusionVisible(!1));d(),h()}}),i=this.loadUnknownNodes(t,i),this.loadBatch(i)}},d.prototype.addNextNodeToBatch=function(e){var t=this.removeMaxNodeFromQueue();return!!t&&(e.push(t),!0)},d.prototype.loadBatch=function(e){if(!e.isEmpty()){var t={viewpointTag:this.manager.viewpointTag,manager:this.manager.oocManager,doneCB:this.onHandlerDone.bind(this)};e.setReferencesLoading(this.manager),this.nbLoading+=e.getSize(),s.onStartCGRLoading(),this.handler.handleBatch(e,t)}},d.prototype.onHandlerDone=function(e,i){e=e||[];var o=(i=i||[]).length+e.length;this.nbLoaded+=o,0===this.handler.type?this.nbLoading-=o:this.nbLoading--;this.manager.enableUnload;var r,s,a,d,h=this.manager.occlusionChecker,l=e.concat(i);this.manager.unloadManager;if(this.manager.progressiveExpand)for(s=0;s<e.length;s++)(a=e[s]).setRepLoaded(!0);for(s=0;s<l.length;s++){if(a=l[s],h&&h.hideReference(a),a.isLoading()&&a.setStatus(n.loaded,this.manager),0===this.handler.type){var c=this.manager.switchRepresentationBuffer.get(a.referenceId);c&&(r=this.manager.oocManager,this.manager.switchRepresentationBuffer.delete(a.referenceId),a.switchRepresentation(c.rep,r.isMeshInRAMRequested(a.referenceId),this.manager,c.onSwitchRepCBArray,!0))}a._boundingSphere||a._boundingBox||this.handler.type!==t.Model3DHandler||(a.updateBoundingSphereFromNode(),d=!0),(a.isForced()||d)&&this.manager.registerTilesNode(a)}for(s=0;s<i.length;s++)this.handler.type===t.Model3DHandler||this.handler.type===t.TileSetHandler?(i[s].setStatus(n.error,this.manager),i[s].showActiveRepresentation(this.manager),i[s]._onLoaded(),this.onNodeToRemoveFromList()):this.forceUpdateNode(i[s]);this.handler.isReady()&&this.manager.requestUpdate(!1,!1),this.handler.type===t.Model3DHandler&&this.manager.viewer.render({budgeted:!0})},d.prototype.onNodeToRemoveFromList=function(){this.nbNodesToRemoveFromList++},d.prototype.removeMaxNodeFromQueue=function(){var e=this.nodesToLoadQueue.getMaxNode(!0);return e.setInToBeLoaded(!1),e.setOcclusionVisible(!1),e},d.prototype.removeUselessNodesFromList=function(e,t){if(this.nbNodesToRemoveFromList>200||t){var n,i;for(n=0;n<e.length;n++)(i=e[n]).isAlive()||(e[n]=null);var o=0;for(n=0;n<e.length;n++)null!==(i=e[n])&&(e[o]=i,o++);e.length=o,this.nbNodesToRemoveFromList=0}},d.prototype.isLoading=function(){return this.nbLoading>0},d.prototype.hasMoreToLoad=function(){return!this.nodesToLoadQueue.isEmpty()},d.prototype.fillDebugArray=function(e){var t,n,i,o;for(this.removeUselessNodesFromList(this.nodes,!0),t=0;t<this.nodes.length;t++){if(i={id:(n=this.nodes[t]).referenceId,screenRadius:n._screenRadius,status:n._status,unloadStatus:n._unloadStatus},n.children.length>0&&(i.nbChildren=n.children.length,n.children.length>0)){var r=[],s=[];for(o=0;o<n.children.length;o++)r.push(n.children[o].reference.referenceId),s.push(n.children[o].instanceId);i.children=r,i.instances=s}n.unloadLockCounter>0&&(i.unloadLockCounter=n.unloadLockCounter),e.push(i)}},d.prototype.memorizeReferenceSize=function(e,t){(!this.referenceSizeMap.has(e)||this.referenceSizeMap.get(e)<t)&&this.referenceSizeMap.set(e,t)},d.prototype.getMemorizedReferenceSize=function(e){return this.referenceSizeMap.has(e)?this.referenceSizeMap.get(e):-1},d.prototype.addToLoadedNodesQueue=function(e){e.isInLoaded()||(e.setInLoaded(!0),this.loadedNodesQueue.addNode(e))},d.prototype.unloadSmallNodes=function(e,t,n){var i=this.manager.unloadManager,o=this.loadedNodesQueue,r=this.manager,s=this.handler.type,a=this.unloadedReferenceIds;o.traverseMinPlus(function(n,o,d){var h=!1;!i.isLoadingAllowed(s)&&n.getScore()<e?n.isUnloadLocked()?h=!0:r.unloadNode(n,t,!0)?(a.add(n.referenceId),r.hasUnloadedSmallNodes=!0):h=!0:(o(),h=!0),h?d():n.setInLoaded(!1)})},d.prototype.updateLoadedNodes=function(e,t){var n=this.manager.unloadManager;if(this.handler&&n.isUnloadNeeded(this.handler.type)){e&&this.loadedNodesQueue.resetOrder(function(e){var t=e.isAlive();return t||e.setInLoaded(!1),t});var i=!1,o=this.manager;this.loadedNodesQueue.traverseMinPlus(function(r,s,a){var d=!1,h=r.handler;(e||r.isAlive()&&r.isUnloadable())&&r.isAlive()&&(n.isUnloadNeeded(h.type)&&r.isToUnload()?r.isUnloadLocked()?d=!0:(i=!0,o.unloadNode(r,t)||(d=!0)):(r.isLoaded()&&!r.isForced()&&s(),d=!0)),d?a():r.setInLoaded(!1)}),i&&this.onReferenceUnloaded()}e&&this.loadedNodesQueue.cleanNulls()},d.prototype.doEmergencyUnload=function(e){var t=this.manager,n=!1,i=this.type,o=this.unloadedReferenceIds;this.loadedNodesQueue.traverseMinPlus(function(r,s,a){if(t.unloadManager.isEmergencyUnloadRequired(void 0,i)){var d=!1;r.handler;r.isAlive()&&(r.isUnloadLocked()?d=!0:(n=!0,t.unloadNode(r,e,!0)?o.add(r.referenceId):d=!0)),d?a():r.setInLoaded(!1)}else a(),s()}),n&&this.onReferenceUnloaded()},d.prototype.hasMissingNodesToBeLoaded=function(){return!1},d.prototype.computeNodesCollidingWithBox=function(e){var t,n,i=[];i=(i=i.concat(this.nodes)).concat(this.newNodes);var o=e.getBoundingSphere(),r=new a.Sphere,s=[],d=[];for(t=0;t<i.length;t++)(n=i[t]).isCollidingWithBox(e,o,r,s)&&d.push(n.referenceId);return d},d}),define("DS/3DXMTiles/LDHCandidateQueueRenderer",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/3DXMTiles/LDHCandidateListRenderer","DS/3DXMTiles/LDHOccurrence","DS/Mesh/MeshUtils","DS/3DXMTiles/LDHReference","DS/Visualization/MaterialApplication"],function(e,t,n,i,o,r,s,a,d){"use strict";var h=function(t,i){this.manager=t,this.viewer=t.viewer,this.root=i||new n("CandidateQueueRenderer"),this.root.setRenderPasses(["main"]),this.viewer.addNode(this.root),this.displayIntermediateReferences=!1,this.preserveReferences=null,this.preserveSelection=!1,this.pickable=s.PICKABLE,this.attributes=[new l({dimension:2,color:new e.Color("red"),opacity:.1}),new l({dimension:1,color:new e.Color("black"),opacity:1})],this.repMaterial=null,this.repMaterialApplication=null,this.candidateListRenderers=[new o(this.root),new o(this.root)]};h.prototype.setPickable=function(e,t,n){this.pickable=e,this.root.setPickable(e),!t&&this.manager.isSlave()&&(this.removeSlaveBoxes(),this.displaySlaveBoxes(n))},h.prototype.setParams=function(e){e=e||{},this.repMaterial=null,this.repMaterialApplication=null,this.displayIntermediateReferences=!!e.displayIntermediateReferences,e.repRefAttributes&&this.attributes[0].setParams(e.repRefAttributes),e.refAttributes&&this.attributes[1].setParams(e.refAttributes)},h.prototype.dispose=function(){var e;for(e=0;e<this.candidateListRenderers.length;e++)this.candidateListRenderers[e].dispose();this.root=null},h.prototype.addNodeList=function(e,t,n){var i,o;for(i=0;i<e.length;i++)o=e[i],this.shouldDisplayReference(o,n)&&t.references.push(o)},h.prototype.shouldDisplayReference=function(e,t){var n=e.getNode();if(1===e.handler.type&&e.isRoot)return!0;if(a.slaveBoxFix){if(!n&&e.getLODValue(t)>0)return!0}else if((!n||e.isSlave()&&0===n.children.length)&&e.getLODValue(t)>0)return!0;return!!(this.preserveReferences&&this.preserveReferences.indexOf(e)>=0)},h.prototype.getNodesFromQueue=function(e,t){var n,i,o=[];for(n=0;n<e.nodes.length;n++)i=e.nodes[n],t?0===i.children.length&&o.push(i):i.isLoaded()||o.push(i);return o},h.prototype.getCandidateRoots=function(){return this.manager.getCandidateRoots()},h.prototype.updateRepresentation=function(e,t){var n=this.manager;if(!a.slaveBoxFix||n.isOOC()){var i,o,r,s=[];for(i=0;i<this.candidateListRenderers.length;i++)-1===(r=this.attributes[i]).clusters&&(o=this.candidateListRenderers[i],this.preserveSelection?s.push(o.createSelectionRestoringData()):s.push(null),o.references=[]);for(i=0;i<this.candidateListRenderers.length;i++){if(r=this.attributes[i],o=this.candidateListRenderers[i],this.displayIntermediateReferences||0===i){var d=n.queues[i],h=0===i?this.getNodesFromQueue(d,1===i):this.getCandidateRoots();this.addNodeList(h,o,t),o.updateRepresentation(r,e)}-1===r.clusters&&s[i]&&o.restoreSelection(s[i])}}},h.prototype.getPathFromPathElement=function(e){var t,n;for(t=0;t<this.candidateListRenderers.length;t++)if(n=this.candidateListRenderers[t],e.externalPath.indexOf(n.node)>=0){var i=n.getOccurrenceFromInstanceId(e.instanceId),o=null;if(i&&i instanceof r)for(o=[];i;)o.unshift(i.reference.referenceId),i.parent&&o.unshift(i.instanceData.instanceId),i=i.parent;return o}return null},h.prototype.getReferenceFromPathElement=function(e){var t,n;for(t=0;t<this.candidateListRenderers.length;t++)if(n=this.candidateListRenderers[t],e.externalPath.indexOf(n.node)>=0){var i=n.getOccurrenceFromInstanceId(e.instanceId);if(i)return i instanceof r?i.reference.referenceId:n.getReferenceFromOccurrence(i)}return null},h.prototype.clearClusters=function(){var e;for(e=0;e<this.candidateListRenderers.length;e++)this.candidateListRenderers[e].clearClusters()},h.prototype.displaySlaveBoxes=function(e){var t,n,i=this.manager,o=this.getNodesFromQueue(i.queues[0],!1);for(t=0;t<o.length;t++)(n=o[t]).getLODValue(e)>0&&n.displayBox(i)},h.prototype.removeSlaveBoxes=function(){var e,t=this.manager,n=t.queues[0].nodes;for(e=0;e<n.length;e++)n[e].removeBox(t)},h.prototype.getRepMaterial=function(){var t;return null===this.repMaterial&&(t=this.attributes[0],this.repMaterial=new e.MeshBasicMaterial({color:t.color,opacity:t.opacity,transparent:t.opacity<1,force:!0})),this.repMaterial},h.prototype.getRepMaterialApplication=function(){return null===this.repMaterialApplication&&(this.repMaterialApplication=new d({faceMaterial:this.getRepMaterial(),layer:-1/0})),this.repMaterialApplication};var l=function(e){this.color=e.color.clone(),this.opacity=e.opacity,this.dimension=e.dimension,this.clusters=e.clusters||-1,this.count=e.count||0};return l.prototype.setParams=function(e){e.color&&(this.color=e.color.clone()),void 0!==e.opacity&&(this.opacity=e.opacity),void 0!==e.dimension&&(this.dimension=e.dimension),void 0!==e.clusters&&(this.clusters=e.clusters||-1),void 0!==e.count&&(this.count=e.count||0)},h}),define("DS/3DXMTiles/LDHZipHandler",["DS/Visualization/ThreeJS_DS","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/3DXMTiles/LDHReferenceStatus","DS/Visualization/ModelLoader","DS/3DXMTiles/ModelBank"],function(e,t,n,i,o,r){"use strict";var s=function(e,n){t.call(this,t.Model3DHandler),this.manager=null,this.nbTickets=1,this.nbLoading=0,this.maxBatchSize=1,this.modelLoader=null,this.unzipLib=e.unzipLib||"zipjs2",this.loadModelCB=e.loadModelCB||this.CGRLoadCB.bind(this)};(s.prototype=Object.create(t.prototype)).isReady=function(){return this.nbLoading<this.nbTickets},s.prototype.handleReference=function(e,t){this.manager=t.manager._ldhNodeManager;var n=this.manager;e.requestBuildSceneGraphHierarchy(!0),n.tryBuildSceneGraphHierarchy();var i=e.getActiveRepresentation();i!==e.getPrimaryRepresentation()&&i.buildNode();var o=i.node;this.nbLoading++;var r=this.onModelLoaded.bind(this,e,t),s=this.onModelError.bind(this,e,t),a=i.src.zipArchive,d=i.src.path;"zipjs2"===this.unzipLib?a.find(d).getUint8Array().then(e=>{this.loadModelCB({targetNode:o,data:e,onLoadedCB:r,onErrorCB:s})}).catch(e=>{}):"zipjs1"===this.unzipLib&&a.find(d).getBlob("application/octet-stream",e=>{var t=new FileReader;t.onload=(e=>{this.loadModelCB({targetNode:o,data:e.target.result,onLoadedCB:r,onErrorCB:s})}),t.readAsArrayBuffer(e)})},s.prototype.onModelLoaded=function(e,t,i){this.nbLoading--;e.getActiveRepresentation();n.statsInit(),n.statsOnLoadedModel();e.referenceId;var o=t.manager;this.commitModelLoadedTransaction(e,o,i),t.doneCB([e],[])},s.prototype.onModelError=function(e,t){this.nbLoading--;e.referenceId,t=this.referenceToContext.get(e);this.referenceToContext.delete(e),t.doneCB([],[e])},s.prototype.acceptsRepresentation=function(e,t){return!0},s.prototype.CGRLoadCB=function(e){this.modelLoader||(this.modelLoader=new o,this.modelLoader.sharedBuffers=!1,this.modelLoader.setFileType("cgr"),this.modelLoader.setKeepLoaderMode(!0)),this.modelLoader.setOnLoadedProductStructureCallback(t=>{e.onLoadedCB(t)}),this.modelLoader.setOnErrorCallback(()=>{e.onErrorCB()});this.modelLoader.loadModelFromBuffer(e.data,e.targetNode,{})};var a=function(e){this.handler=e,this.reference=null};return a.prototype.containsReference=function(e){return this.reference&&this.reference.referenceId===e},a.prototype.addReferenceIfPossible=function(e,t){return!this.reference&&(this.reference=e,!0)},a.prototype.isEmpty=function(){return!this.reference},a.prototype.getSize=function(){return this.reference?1:0},a.prototype.setReferencesLoading=function(e){this.reference&&(this.reference.isLoading()||this.reference.setLoading(e))},s.prototype.handleBatch=function(e,t){this.handleReference(e.reference,t)},s.prototype.createBatch=function(){return new a(this)},s}),define("DS/3DXMTiles/OOCModel3DZipHandler",["DS/3DXMTiles/OOCHandler","DS/3DXMTiles/LDHZipHandler"],function(e,t){var n=function(n){var i=new t(n=n||{});e.call(this,e.Model3DHandler,i)};return n.prototype=Object.create(e.prototype),n}),define("DS/3DXMTiles/LDHUserQueue",["DS/3DXMTiles/PriorityQueue"],function(e){"use strict";var t=function(t,n){this.queue=new e,this.handler=t,this.manager=n};return t.prototype.addNode=function(e){this.queue.addNode(e)},t.prototype.computeOrder=function(e){var t,n;for(this.queue.resetOrder(),t=0;t<this.queue.nodeListLength;t++)!(n=this.queue.nodeList[t])||!n.isAlive()||n.isInList()&&n.needScreenRadiusSizeComputation()||n.updateNodeLOD(e)},t.prototype.handleViewpointChange=function(e){this.computeOrder(e)},t.prototype.traverseQueue=function(){var e=this.handler,t=[],n={doneCB:this.onHandlerDone.bind(this)};this.queue.traverseMax(function(i){return!i.isAlive()||!!(i._screenRadius>=0&&e.isReady())&&(t.push(i.referenceId),t.length>=e.getBatchSize()&&(e.handleReferences(t,n),t=[]),!0)}),t.length>0&&(e.handleReferences(t,n,this.queue.isEmpty()),t=[]),this.queue.isEmpty()&&this.manager.removeUserQueue(this.handler)},t.prototype.onHandlerDone=function(){this.manager.requestUpdate(!1,!1)},t}),define("DS/3DXMTiles/OOCManagerRootEntry",["DS/3DXMTiles/LDHReference"],function(e){"use strict";var t=function(e,t,n,i){this.occurrence=e,this.boundingBox=t&&t.clone(),this.enableExpand=!0,this.treeModified=!1,this.elasticLoading=!1,this.rootId=n,this.onLoadedCB=i||null,this.visible=!0};return t.prototype.computeSceneMin=function(){var e=this.boundingBox.clone();return e.applyMatrix4(this.occurrence.matrix),e.min.z},t}),define("DS/3DXMTiles/OOCTileSet",["DS/3DXMTiles/DSTilesForceLoadTransaction"],function(e){"use strict";var t=function(e,t){this._tileSet=e,this.oocManager=t};return t.prototype.forceLoadTraverse=function({onExploreCB:t,onLoadedCB:n,requestBoundingBox:i}){var o=new e({tileSet:this._tileSet,onExploreCB:t,onLoadedCB:n,requestBoundingBox:i});this._tileSet.addForceLoadTransaction(o),this.oocManager._ldhNodeManager.requestUpdate(!1,!1)},t.prototype.unlockNodeUnload=function(e){this._getDSTilesNode(e).unlockUnload()},t.prototype._setMaxPixelError=function(e){this._tileSet.setMaxPixelError(e),this.oocManager._ldhNodeManager.requestUpdate(!0,!0)},t.prototype._getDSTilesNode=function(e){return this._tileSet.getTile(e)},t.prototype._getRoot=function(){return this._getDSTilesNode(this._tileSet.rootURI)},t.prototype.getUnitValue=function(){return this._tileSet.getUnitValue()},t.prototype.refreshWorldMatrix=function(){this._getDSTilesNode(this._tileSet.rootURI).setMatrixUpdate(!0),this.oocManager._updateBoundingSphere(),this.oocManager._ldhNodeManager.requestUpdate(!0,!0)},t}),define("DS/3DXMTiles/OOCReferenceIterator",["DS/3DXMTiles/OOCInstanceIterator"],function(e){"use strict";var t=function(e){this._reference=e};return t.prototype.getReferenceId=function(){return this._reference.referenceId},t.prototype.getParents=function(){var e,n=[];for(e=0;e<this._reference.parents.length;e++)n.push(new t(this._reference.parents[e]));return n},t.prototype.getChildren=function(){var n,i,o=[];for(i=0;i<this._reference.children.length;i++)n=this._reference.children[i],o.push(new e(new t(n.reference),n));return o},t.prototype.getNode=function(){return this._reference.getNode()},t.prototype.equals=function(e){return!!e&&this._reference===e._reference},t.prototype.isRepRef=function(){return this._reference.isLeaf()},t.prototype.getParentInstanceIterators=function(){var n,i=[],o=this._reference.parents;for(n=0;n<o.length;n++){var r,s=o[n],a=null;for(r=0;s.children[r];r++){var d=s.children[r];d.reference===this._reference&&(null===a&&(a={referenceIterator:new t(s),instanceIterators:[]}),a.instanceIterators.push(new e(a.referenceIterator,d)))}null!==a&&i.push(a)}return i},t}),define("DS/3DXMTiles/DSTilesTileSet",["DS/3DXMTiles/DSTilesNode","DS/3DXMTiles/OOCTileSet","DS/WAFData/WAFData","DS/Usage/TrackerAPI","DS/3DXMTiles/DSTilesNodeStatus"],function(e,t,n,o,r){"use strict";var s=function(e,n){if(this.rootURI=e.rootURI||null,this.baseTileURL=e.baseTileURL||null,this.baseContentURL=e.baseContentURL||null,this.tileExtension=e.tilesExtension||null,this.loginURL=e.loginURL||null,this.urlPostfix=e.urlPostFix||e.urlPostfix||null,this.contentURLPostfix=e.contentURLPostfix||null,this.tileURLPostfix=e.tileURLPostfix||null,this.infoURL=e.infoURL||null,this.tileBatchingURL=e.tileBatchingURL||null,this.contentBatchingURL=e.contentBatchingURL||null,this.unit=e.unit||null,this.jsonPreprocessCB=e.jsonPreprocessCB||null,this.preloadedJsonMap=new Map,this.nodeMap=new Map,this.oocTileSet=new t(this,n),this.contentMetaData=e.contentMetaData||null,this.forceLoadTransactions=[],this.maxPixelError=window.WUXDefaultTileSetMaxPixelError||5,this.progressiveMode=!0,e.unit){var i=n._computeUnitValue(e.unit);this.unitScale=i/n.getUnitValue(),this.unit=i}else this.unitScale=1,this.unit=-1;this.sortingMetric=e.sortingMetric||"screenRadius",this.currentContentBatch=null,this.contentTickets=6,this.currentExpandBatch=new l,this.expandTickets=6,this.info={maxTileBatchSize:1,maxContentBatchSize:1}};s.odt=!1,s.prototype.getTile=function(e){return this.nodeMap.get(e)||null},s.prototype.getUnitValue=function(){return this.unit>0?this.unit:this.oocTileSet.oocManager.getUnitValue()},s.prototype.getSortingMetric=function(){return this.sortingMetric},s.prototype.getTriggerMetric=function(){return this.triggerMetric},s.prototype.removeNode=function(e){this.nodeMap.delete(e)},s.prototype.setMaxPixelError=function(e){this.maxPixelError=e},s.prototype.getMaxContentBatchSize=function(){return this.info.maxContentBatchSize},s.prototype.getMaxExpandBatchSize=function(){return this.info.maxTileBatchSize},s.prototype.dispose=function(){this.preloadedJsonMap=new Map,this.nodeMap=new Map,this.oocTileSet=null},s.prototype.buildTileURL=function(e){var t=e;return this.baseTileURL&&(t=this.baseTileURL+t),this.tileExtension&&(t+=this.tileExtension),this.tileURLPostfix&&(t+=this.tileURLPostfix),this.urlPostfix&&(t+=this.urlPostfix),t},s.prototype.addNode=function(e){this.nodeMap.set(e.uri,e)},s.prototype.buildContentURL=function(e){var t=e;return this.baseContentURL&&(t=this.baseContentURL+t),this.contentURLPostfix&&(t+=this.contentURLPostfix),this.urlPostfix&&(t+=this.urlPostfix),t},s.prototype.getRootNode=function(){return this.nodeMap.get(this.rootURI)},s.prototype.canLoadContent=function(){return this.contentTickets>0},s.prototype.loadTileContent=function(e){e.setContentStatus(r.loading,e.queue),this.contentBatchingURL&&this.info.maxContentBatchSize>1?this.loadTileContent_multi(e):this.loadTileContent_single(e)},s.prototype.loadTileContent_single=function(e){this.contentTickets--;var t=e.content.getUri(),i=this.buildContentURL(t),o=this;!function t(){n.authenticatedRequest(i,{method:"GET",timeout:36e5,type:"arraybuffer",onComplete:(n,i,r)=>{var s=r?r.status:200;r&&202===r.status?setTimeout(t,3e4):204===s?o.loadContentFromBuffer(null,e):o.loadContentFromBuffer(n,e)},onFailure:t=>{o.contentTickets++,e.queue.onNodeLoadError(e)}})}()},s.prototype.loadContentFromBuffer=function(e,t,n){t.contentLoader.loadContentFromBuffer(e,t,()=>{n?(n.onNodeLoaded(t),n.isFullyLoaded()&&this.contentTickets++):this.contentTickets++,t.queue.onNodeLoaded(t)},()=>{n?(n.onNodeLoaded(t),n.isFullyLoaded()&&this.contentTickets++):this.contentTickets++,t.queue.onNodeLoadError(t)})};var a=window.localStorage.getItem("OOCTilesTargetContentBatchFileSize")||2097152;function d(e,t,n){var i,o;for(i=t;i<e.length;i++){if(13===(o=e[i]))return{str:n.decode(e.subarray(t,i)),index:i+2};if(10===o)break}return{str:n.decode(e.subarray(t,i)),index:i+1}}function h(e,t){this.maxSize=e,this.targetFileSize=t,this.nodes=[],this.toLoadCount=0,this.fileSize=0}function l(){this.nodes=[],this.childrenURIs=[]}s.prototype.createContentBatch=function(){return new h(this.getMaxContentBatchSize(),a)},s.prototype.loadTileContent_multi=function(e){this.currentContentBatch||(this.currentContentBatch=this.createContentBatch()),this.currentContentBatch.addNode(e)&&(this.downloadMultiPart(this.currentContentBatch),this.currentContentBatch=this.createContentBatch())},s.prototype.flushLoadTileContent=function(){this.currentContentBatch&&!this.currentContentBatch.isEmpty()&&(this.downloadMultiPart(this.currentContentBatch),this.currentContentBatch=this.createContentBatch())},s.prototype.canExpand=function(){return this.expandTickets>0},s.prototype.expandTile=function(e){var t=e.expander,n=e.queue;if(e.setExpandStatus(r.loading,n),this.tileBatchingURL){if(!this.currentExpandBatch.tryToAdd(e,this.getMaxExpandBatchSize(),this,!1)){var i=this.currentExpandBatch;this.expandBatch(i),this.currentExpandBatch=new l,this.currentExpandBatch.tryToAdd(e,this.getMaxExpandBatchSize(),this,!0)}}else e.childrenURIs?(this.expandTickets--,this.downloadTilesJSON(e.childrenURIs,()=>{this.expandTickets++,t.expandNow(e)?n.onNodeExpanded(e):n.onNodeExpandError(e)})):n.onNodeExpanded(e)},s.prototype.expandBatch=function(e){var t=e.childrenURIs;function n(){var t;for(t=0;t<e.nodes.length;t++){var n=e.nodes[t],i=n.expander,o=n.queue;i.expandNow(n)?o.onNodeExpanded(n):o.onNodeExpandError(n)}}this.expandTickets--,t.length>0?this.downloadPerBatch(e.childrenURIs,()=>{this.expandTickets++,n()}):setTimeout(()=>{this.expandTickets++,n()},0)},s.prototype.downloadTilesJSON=function(e,t){if(this.tileBatchingURL){var n=e.length;function i(e){0===(n-=e)&&t()}var o,r=this.getMaxExpandBatchSize();for(o=0;o<n;o+=r){var s=e.slice(o,o+r);this.downloadPerBatch(s,i.bind(null,s.length))}}else this.downloadTilesOneByOne(e,t)},s.prototype.downloadPerBatch=function(e,t){e.length;var i=this.tileBatchingURL,o=null;s.odt&&(o=n,n=s.odt.FakeWAFData),n.authenticatedRequest(i,{cors:!0,timeout:36e5,method:"POST",data:JSON.stringify(e),async:!0,headers:{"Content-Type":"application/json"},onComplete:(e,n)=>{var i=JSON.parse(e);this.registerTileJSON(i),t()},onFailure:()=>{t()}}),o&&(n=o)},s.prototype.downloadTilesOneByOne=function(e,t){var i,o,r,s=e.length;function a(){0===--s&&t()}for(i=0;i<e.length;i++)r=e[i],this.preloadedJsonMap.has(r)?setTimeout(a,0):(o=this.buildTileURL(r),n.authenticatedRequest(o,{timeout:36e5,onComplete:e=>{var t=JSON.parse(e);this.registerTileJSON(t),a()},onFailure:e=>{a()}}))},s.prototype.registerTileJSON=function(e){var t;for(t=0;t<e.length;t++)this.preloadedJsonMap.set(e[t].uri,e[t].json)},s.prototype.flushExpandTile=function(){this.currentExpandBatch.nodes.length>0&&(this.expandBatch(this.currentExpandBatch),this.currentExpandBatch=new l)},s.prototype.init=function(e){this.infoURL?n.authenticatedRequest(this.infoURL,{cors:!0,timeout:36e5,method:"GET",onComplete:(t,n)=>{var i,o=JSON.parse(t);o&&o.maxTileBatchSize&&(i=parseFloat(o.maxTileBatchSize),isFinite(i)&&(this.info.maxTileBatchSize=i)),o&&o.maxContentBatchSize&&(i=parseFloat(o.maxContentBatchSize),isFinite(i)&&(this.info.maxContentBatchSize=i)),this.login(e)},onFailure:()=>{throw new Error("Login error")}}):this.login(e)},s.prototype.login=function(e){this.loginURL?n.authenticatedRequest(this.loginURL,{cors:!0,timeout:36e5,method:"GET",onComplete:(t,n)=>{e()},onFailure:()=>{throw new Error("Login error")}}):e()},s.prototype.downloadMultiPart=function(e){this.contentTickets--;var t=e.getContentUris(),r=this.contentBatchingURL,a=null;s.odt&&(a=n,n=s.odt.FakeContentWAFData),n.authenticatedRequest(r,{cors:!0,timeout:36e5,method:"POST",data:JSON.stringify(t),async:!0,type:"arraybuffer",headers:{"Content-Type":"application/json"},onComplete:(t,n,i)=>{o.trackPageEvent({eventCategory:"WebVisualization",eventAction:"3DXMTiles",eventLabel:i&&function(e){var t=e.split("/");if(t.length>5){var n=t[t.length-1],i=t[t.length-1].indexOf("?");-1!==i&&(n=n.substring(0,i),t[t.length-1]=n);let e=t.slice(4,t.length);return e.join("/")}return 0===t[t.length-1].length?t[t.length-2]:t[t.length-1]}(i.url),appID:p,persDim:{pd1:u,pd2:p},persVal:{pv1:i&&i.timeoutTimer,pv2:t.byteLength}});var r={contentData:0,nextIndex:0},s=0,a=new Int8Array(t);do{(r=this.extractNextData(a,r.nextIndex)).contentData&&this.loadContentFromBuffer(r.contentData,e.getNode(s),e),s++}while(r.contentData)},onFailure:()=>{this.contentTickets++;var t=e.nodes;for(i=0;i<t.length;i++){var n=t[i];n.queue.onNodeLoadError(n)}}}),a&&(n=a)},s.prototype.extractNextData=function(e,t){var n,i,o,r=new TextDecoder,s=t,a=-1;do{s=(n=d(e,s,r)).index,(o=n.str).toLowerCase().startsWith("content-length:")&&(i=o.split(" "),a=parseInt(i[1]))}while((o.length>0||a<0)&&s<e.length);var h=null;return s=n.index,a>0&&(h=e.buffer.slice(s,s+a)),{contentData:h,nextIndex:s+a}},s.prototype.addForceLoadTransaction=function(e){this.forceLoadTransactions.push(e)},s.prototype.removeForceLoadTransaction=function(e){var t=this.forceLoadTransaction.indexOf(e);this.forceLoadTransaction.splice(t,1)},s.prototype.updateForceLoad=function(){var e;for(e=0;e<this.forceLoadTransactions.length;e++)this.forceLoadTransactions[e].update()&&(this.forceLoadTransactions[e]=null);var t=0;for(e=0;e<this.forceLoadTransactions.length;e++)this.forceLoadTransactions[e]&&(this.forceLoadTransactions[t]=this.forceLoadTransactions[e],t++);this.forceLoadTransactions.length=t},h.prototype.addNode=function(e){return this.nodes.push(e),this.fileSize+=e.content.fileSize,this.toLoadCount++,this.nodes.length>=this.maxSize||this.fileSize>=this.targetFileSize},h.prototype.getSize=function(){return this.nodes.length},h.prototype.onNodeLoaded=function(e){this.toLoadCount--},h.prototype.isFullyLoaded=function(){return this.toLoadCount<=0},h.prototype.getNode=function(e){return this.nodes[e]},h.prototype.isEmpty=function(){return 0===this.nodes.length},h.prototype.getContentUris=function(){var e,t=[];for(e=0;e<this.nodes.length;e++)t.push(this.nodes[e].content.getUri());return t},l.prototype.tryToAdd=function(e,t,n,i){if(!e.childrenURIs)return this.nodes.push(e),!0;var o,r,s=[];for(o=0;o<e.childrenURIs.length;o++)r=e.childrenURIs[o],n.preloadedJsonMap.has(r)||s.push(r);if(this.childrenURIs.length+s.length<t||i){for(o=0;o<s.length;o++)this.childrenURIs.push(s[o]);return this.nodes.push(e),!0}return!1};var c="undefined"!=typeof widget&&null!==widget?widget:void 0,u=c?c.id:"no_widget",p=c?c.getValue("x3dAppId")?c.getValue("x3dAppId"):c.getValue("appId"):"no_widget_appid";return s}),define("DS/3DXMTiles/LDHLoadingBoxManager",["DS/Visualization/ThreeJS_R57","DS/Mesh/MeshUtils","DS/Visualization/MaterialApplication","DS/3DXMTiles/PriorityQueue"],function(e,t,n,i){"use strict";var o=function(n,i){this.oocManager=n,this.queue=i,this.lastReferences=[],this.attributes=new r({dimension:2,color:new e.Color("red"),opacity:.1}),this.material=null,this.materialApplication=null,this.pickable=t.PICKABLE,this.maxNbBoxes=o.maxNbBoxes};o.maxNbBoxes=1e3,o.prototype.updateLoadingBoxes=function(){var e,t,n=this.queue.manager.occlusionTestEnabled,i=new Set,o=this.computeReferenceList(n);for(t=0;t<o.length;t++)(e=o[t]).requestBuildSceneGraphHierarchy(!0),e.lockUnload(),i.add(e);var r=this.queue.manager;for(r.tryBuildSceneGraphHierarchy(),t=0;t<o.length;t++)(e=o[t]).displayBox(r);for(t=0;t<this.lastReferences.length;t++)e=this.lastReferences[t],i.has(e)||e.removeBox(r),e.unlockUnload();this.lastReferences=o},o.prototype.removeBoxes=function(){var e,t,n=this.queue.manager;for(e=0;e<this.lastReferences.length;e++)(t=this.lastReferences[e]).removeBox(n),t.unlockUnload();this.lastReferences=[]},o.prototype.getMaterial=function(){var t;return null===this.material&&(t=this.attributes,this.material=new e.MeshBasicMaterial({color:t.color,opacity:t.opacity,transparent:t.opacity<1,force:!0})),this.material},o.prototype.getMaterialApplication=function(){return null===this.materialApplication&&(this.materialApplication=new n({faceMaterial:this.getMaterial(),layer:-1/0})),this.materialApplication},o.prototype.computeReferenceList=function(e){var t,n,i=[],o=this.queue,r=0,s=this.oocManager._getActiveRootLDHReferences();for(t=0;t<s.length;t++)0!==(n=s[t]).children.length||n.isLeaf()||i.push(s[t]);for(t=0;t<o.nodes.length;t++)n=o.nodes[t],this.shouldDisplayBox(n,e)&&(r+=n.getNbOccurrences(),i.push(n));return r>this.maxNbBoxes&&(i=this.selectBiggestReferences(i,this.maxNbBoxes)),i},o.prototype.selectBiggestReferences=function(e,t){var n,o=new i(t);for(n=0;n<e.length;n++)o.addNode(e[n]);var r=[],s=0;return o.traverseMaxPlus(function(e,n,i){r.push(e),(s+=e.getNbOccurrences())>t&&n()}),r},o.prototype.shouldDisplayBox=function(e,t){return!(!e.isInToBeLoaded()||t&&!e.isOcclusionVisible())},o.prototype.setParams=function(e){e=e||{},this.material=null,this.materialApplication=null,this.attributes.setParams(e.repRefAttributes)},o.prototype.dispose=function(){this.removeBoxes()},o.prototype.updateBoxes=function(){var e,t,n=this.oocManager._ldhNodeManager;for(e=0;e<this.lastReferences.length;e++)(t=this.lastReferences[e]).removeBox(n),t.displayBox(n)},o.prototype.setPickable=function(e){this.pickable=e,this.updateBoxes()};var r=function(e){this.color=e.color.clone(),this.opacity=e.opacity,this.count=e.count||0};return r.prototype.setParams=function(e){e.color&&(this.color=e.color.clone()),void 0!==e.opacity&&(this.opacity=e.opacity),void 0!==e.count&&(this.count=e.count||0)},o}),define("DS/3DXMTiles/DSTilesVolumeContentLoader",["DS/3DXMTiles/DSTilesNodeMemorySize","DS/3DXMTiles/ModelLoaderSingleton","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory"],function(e,t,n,i,o,r){"use strict";var s=function(e){if(e=e||{},this.budget=null,this.buildUrlCB=e.buildUrlCB,this.viewer=e.viewer||debugWebGLV6Viewer,this.volumeManager=null,this.fromCGR=!1,this.needUpdateMetaData=!0,this.viewer){var t=this.viewer.getEffect("VolumeRendering");this.volumeManager=t?t.volumeManager:null}};s.prototype.init=function(e){this.budget=e.memoryManager.createBudget("volume","gpu",{})},s.prototype.needsSgNodePerContent=function(){return!1},s.prototype.getBudget=function(){return this.budget},s.prototype.isReady=function(){return t.isReady()},s.prototype.isThereEnoughMemoryToLoad=function(e,t){return t.isLoadingAllowed()},s.prototype.updateMetaData=function(e){var t=e.contentMetaData&&e.contentMetaData.volume;t&&(t.transferFunction&&this.volumeManager.updateTransferFunction(t.transferFunction),t.colorMap&&this.volumeManager.setColorMapRaw(t.colorMap))},s.prototype.loadContentFromBuffer=function(e,n,i,o){var r=n.queue,s=new a(n,r),d=n.tileSet,h=n.content.getUri();this.buildUrlCB?this.buildUrlCB(h):d.buildContentURL(h);"3dxc"===n.content.getFormat()||(this.fromCGR=!0),t.loadFromBuffer(e,s.targetSGNode,n.content.getFormat(),this.onModelLoaded.bind(this,s,i),this.onModelError.bind(this,s,o))},s.prototype.onModelLoaded=function(e,t){e.node,e.queue;(e.node.setContentToken(e),e.computeMemorySize(),this.volumeManager)&&this.volumeManager.getVolumeData(e,this.fromCGR);t()},s.prototype.onModelError=function(e,t){e.node,e.queue;t()},s.prototype.computeMemorySize=function(t){return new e(0,0)},s.prototype.showContent=function(e){if(this.volumeManager){e.node;var t=e.data.valueRange;if(t&&!this.volumeManager.isRangeVisible(t))return}this.volumeManager&&e.data&&(this.volumeManager.addChunk(e)&&0)},s.prototype.hideContent=function(e){this.volumeManager&&(this.volumeManager.removeChunk(e)&&0)},s.prototype.deleteContent=function(e){},s.prototype.exportContent=function(e){return null};var a=function(e,t){this.node=e,this.queue=t,this.targetSGNode=new n,this.nodes=[],this.visible=!1,this.memorySize=null};return a.prototype.computeMemorySize=function(){this.memorySize=new e(0,0)},s}),define("DS/3DXMTiles/MassiveOcclusionChecker",["DS/Visualization/ThreeJS_DS","DS/Plugins/ClearPass","DS/Plugins/RenderPass","DS/Plugins/ComposerContext","DS/3DXMTiles/InstancingFactory","DS/Plugins/EffectComposer","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory"],function(e,t,n,i,o,r,s,a){"use strict";var d=function(e,t,n){this.id=n,this.occurrenceIndex=-1,this.box=e,this.matrices=t},h=-1;d.prototype.fillInstancingParams=function(t,n){var i,o=new e.Color(n?0:this.id+1),r=this.matrices;for(i=0;i<r.length;i++)t.matrices.push(r[i]),t.boxes.push(this.box),t.colors.push(o)};var l=new e.Box3;d.prototype.isContainingPoint=function(e){var t;for(t=0;t<this.matrices.length;t++)if(l.copy(this.box),l.applyMatrix4(this.matrices[t]),l.containsPoint(e))return!0;return!1},d.prototype.addDebugBoxes=function(t){var n,i,o=this.matrices;for(i=0;i<o.length;i++)(n=a.createCuboidNodeFromBox3(this.box,e.MaterialUtils.createShinyFaceMaterial({color:"red",force:!0}))).setMatrix(this.matrices[i]),t.addChild(n)};var c=-1,u=function(o){-1===h&&(h=!!window.OOCDebugOcclusionChecker),this.viewer=o.viewer,this.debugId=-1,this.renderer=this.viewer.renderer.renderer,this.renderTargetPool=this.viewer.renderer.renderTargetPool,this.ratio=o.ratio||1,this.only=-1,this.renderList=o.renderList||"main",this.discoveryTarget=0,this.scoreTarget=1;this.composer=new r(this.renderer,void 0,this.renderTargetPool,["--\x3e(main)","clearPass","occlusionPass"]),this.clearPass=new t("clearPass"),this.clearPass.clearColor=new e.Color("black"),this.clearPass.clearAlpha=1,this.occlusionPass=new n(null,null,null,null,null,null,"occlusionPass"),this.occlusionPass.disableToneMapping=!0,this.width=Math.ceil(this.ratio*this.viewer.renderer.viewportWidth),this.height=Math.ceil(this.ratio*this.viewer.renderer.viewportHeight),this.lastBufferSize=0,this.lastBuffer=null;var s=new e.WebGLRenderTargetProperties(this.width,this.height,"uintNearest");this.occlusionComposerContext=new i(s,this.composer,"occlusionComposerContext"),this.occlusionComposerContext.keepResult=!0,this.composer.addPass(this.clearPass),this.composer.addPass(this.occlusionPass),this.boxes=[],this.occurrenceCount=0,this.visibilitySet=new Set,this.depthBuffer=null,this.debugInput=!1,this.scene=new e.Scene,this.material=new e.MeshBasicMaterial({color:"red",force:!0,side:e.DoubleSide}),this.alwaysVisibleIds=[],this.idsToHideSet=new Set,this.idsToHide=[],this.occurrencesToHide=[],this.idsToShowSet=new Set,this.idsToShow=[],this.occurrencesToShow=[],this.mesh=null,this.nextId=0,this.nbProcessedBoxes=0,this.idToReference=new Map,this.scores=[],this.needUpdateIdsTable=!1,this.dbgPng=[]};return u.prototype.dispose=function(){if(this.idToReference.forEach(function(e,t){e.occlusionId=-1}),this.idToReference=null,this.occlusionComposerContext.keepResult=!1,this.occlusionComposerContext.releaseRenderTargets(this.renderTargetPool,"main"),this.occlusionComposerContext.keepResult=!0,this.boxes=[],this.material.dispose(),this.material=null,this.mesh){var e=this.mesh._occurrences[0].renderable;this.viewer.renderer.renderer.__glResources__.removeGeometryList([e])}this.scene.dispose(),this.scene=null,this.mesh=null},u.prototype.hasReference=function(e){return e.occlusionId>=0&&this.idToReference.has(e.occlusionId)},u.prototype.addReference=function(e){this.idToReference.set(e.occlusionId,e)},u.prototype.hideReference=function(e){this.hasReference(e)&&this.hideId(e.occlusionId)},u.prototype.hideId=function(e){this.idsToHideSet.add(e),this.idsToShowSet.delete(e),this.needUpdateIdsTable=!0},u.prototype.updateIdsTables=function(){this.disabled=!1,this.idsToHide=[],this.idsToShow=[],this.occurrencesToHide=[],this.occurrencesToShow=[];var e=this;this.idsToHideSet.forEach(function(t){e.idsToHide.push(t);var n,i=e.boxes[t];if(i.occurrenceIndex>=0)for(n=0;n<i.matrices.length;n++)e.occurrencesToHide.push(i.occurrenceIndex+n),e.occurrencesToHide.push(i.id+1)}),this.idsToShowSet.forEach(function(t){e.idsToShow.push(t);var n,i=e.boxes[t];if(i.occurrenceIndex>=0)for(n=0;n<i.matrices.length;n++)e.occurrencesToShow.push(i.occurrenceIndex+n),e.occurrencesToShow.push(i.id+1)})},u.prototype.showReference=function(e){if(this.hasReference(e)){var t=e.occlusionId;this.idsToShowSet.add(t),this.idsToHideSet.delete(t),this.needUpdateIdsTable=!0}},u.prototype.clear=function(){this.boxes=[]},u.prototype.addBox=function(e,t){if(this.disabled=!1,!(t instanceof Array))throw new Error("invalid argument");var n=this.boxes.length,i=new d(e,t,n);return this.boxes.push(i),n},e.WebGLRenderTarget.prototype.readPixels=function(e){e.setRenderTarget(this),null!==this.lastBuffer&&this.lastBufferSize===this.width*this.height||(this.lastBuffer=new Uint8Array(4*this.width*this.height),this.lastBufferSize=this.width*this.height);var t=this.lastBuffer,n=e.getContext();return n.readPixels(0,0,this.width,this.height,n.RGBA,n.UNSIGNED_BYTE,t),t},u.prototype.getVisibility=function(e){return this.visibilitySet.has(e)},u.prototype.getVisibleReferences=function(){var e=[],t=this;return this.visibilitySet.forEach(function(n){var i=t.idToReference.get(n);i?e.push(i):console.log("problem")}),e},u.prototype.buildNode=function(e,t){return this.boxes[e].buildNode(t)},window.myOcclusion=[],window.myReferences=[],u.prototype.computeDepthBuffer=function(){var e,t=this.viewer.renderer,n=t.renderer.getContext(),i=this.viewer.internalSceneGraph.scene,o=this.viewer.internalSceneGraph,r=i.defaultRenderList;return i.defaultRenderList="ooc",e=t.renderOcclusionRealDepth("main",i,n,{main:this.viewer.currentViewpoint.camera},"main",!1,o),i.defaultRenderList=r,e},u.prototype.computeVisibility=function(){if(this.needUpdateIdsTable&&(this.updateIdsTables(),this.needUpdateIdsTable=!1),this.visibilitySet=new Set,!this.disabled){this.depthBuffer=this.computeDepthBuffer();var e,t,n,i,r=this.boxes,a=(window.performance.now(),null!==this.viewer.getSceneBoundingSphere(void 0,!0)),d={matrices:[],boxes:[],colors:[],material:this.material,useDBuffer:a,viewer:this.viewer,depthBuffer:this.depthBuffer},l=this.viewer.currentViewpoint.camera;for(e=this.nbProcessedBoxes;e<r.length;e++)n=(t=r[e]).id,l.isOrtho||!t.isContainingPoint(l.position)?(r[e].fillInstancingParams(d,this.idsToHide.indexOf(n)>=0||this.only>=0&&e!==this.only),t.occurrenceIndex=this.occurrenceCount,this.occurrenceCount+=t.matrices.length):this.alwaysVisibleIds.push(e);for(this.nbProcessedBoxes=r.length,e=0;e<this.alwaysVisibleIds.length;e++)i=this.alwaysVisibleIds[e],this.visibilitySet.add(i),this.scores[i]=1/0;if(this.debugInput){var c=new s;for(this.viewer.addNode(c),e=0;e<r.length;e++)t=r[e],(this.only<0||e===this.only)&&t.addDebugBoxes(c)}for(var u,p=!1,f=0,g=[],m=(this.idToReference,r=this.boxes,!0);!p;)this.compute(d,this.occurrencesToHide,g,this.occurrencesToShow,m),(u=this.visibilitySet.size-this.alwaysVisibleIds.length)===f||u>=this.discoveryTarget||u>=this.boxes.length?p=!0:(this.visibilitySet.forEach(function(e,t){var n,i=r[e];if(i.occurrenceIndex>=0)for(n=0;n<i.matrices.length;n++)g.push(i.occurrenceIndex+n),g.push(i.id+1)}),d={matrices:[],boxes:[],colors:[],material:this.material,useDBuffer:a,viewer:this.viewer,depthBuffer:this.depthBuffer}),f=u,m=!1,0;if(g.length>0){var y=this.mesh;o.updateInstancingBox({mesh:y,instancingParams:d,indexesToHide:[],indexesToHideTmp:[],indexesToShow:g})}0===u&&(this.disabled=!0),h&&window.myOcclusion.push(this.buildPNG())}},u.prototype.compute=function(t,n,i,r,s){this.scores=[];var a=this.scene,d=this.mesh;if(d)o.updateInstancingBox({mesh:d,instancingParams:t,indexesToHide:n,indexesToHideTmp:i,indexesToShow:r});else{(d=o.buildInstancingBox(t)).setVisibilityFree(!0);var l=d._occurrences[0].renderable;a.add(l),this.mesh=d}var u={main:this.viewer.currentViewpoint.camera};this.composer.updateScene(a),this.renderer.materialToUse=e.MaterialToUse.originalMaterial,this.composer.setComposerContext(this.occlusionComposerContext);window.performance.now();this.composer.render(void 0,void 0,u,"main");window.performance.now();for(var p,f,g=this.viewer,m=this.composer.getRenderResult("main").readPixels(g.renderer.renderer),y=(window.performance.now(),this.width),v=this.height,M=[],S=this.scoreTarget,L=0;L<v;L++)for(var D=0;D<y;D++){var T=4*(D+(v-L-1)*y);(p=(m[T]<<16)+(m[T+1]<<8)+m[T+2]-1)>=0&&(0,f=this.scores[p]?this.scores[p]+1:1,this.scores[p]=f,f===S&&(this.visibilitySet.add(p),h&&M.push(this.idToReference.get(p)),!0,0))}h&&window.myReferences.push(M),-1===c&&(c=Date.now())},u.prototype.buildPNG=function(){var e,t=this.viewer,n=this.composer.getRenderResult("main").readPixels(t.renderer.renderer),i=this.width,o=this.height,r=document.createElement("canvas");r.width=i,r.height=o;for(var s=r.getContext("2d"),a=s.createImageData(i,o),d=a.data,h=0;h<a.height;h++)for(var l=0;l<a.width;l++){var c=l+h*i,u=l+(o-h-1)*i;d[4*c]=n[4*u]?256-n[4*u]:0,d[4*c+1]=n[4*u+1]?256-n[4*u+1]:0,d[4*c+2]=n[4*u+2]?256-n[4*u+2]:0,d[4*c+3]=n[4*u+3]}return s.putImageData(a,0,0),e=r.toDataURL(),window.myDataURL=e,e},u}),define("DS/3DXMTiles/LDHTileSetHandler",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/DSTilesStdExpander","DS/3DXMTiles/DSTilesGenericScoreComputer","DS/3DXMTiles/DSTilesMeshContentLoader","DS/3DXMTiles/DSTilesTileSet","DS/3DXMTiles/DSTilesR2VPointCloudContentLoader","DS/3DXMTiles/DSTilesVolumeContentLoader","DS/WAFData/WAFData","DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS"],function(e,t,n,i,o,r,s,a,d,h){"use strict";var l=function(o){this.type=e.TileSetHandler;var a=new i({}),d=new s;this.expander=new t({meshContentLoader:a,volumeContentLoader:d,r2vPointCloudContentLoader:new r({}),scoreComputer:new n({})}),this.getSecurityParamsCB=o&&o.getSecurityParamsCB||null,this.getDataCB=o&&o.getDataCB};return(l.prototype=Object.create(e.prototype)).isReady=function(){return!0},l.prototype.handleResolvedReference=function(e,t){var n,i=t.manager._ldhNodeManager,o=t.manager,r=i.tilesManager;e.setRepLoaded(!0),e.requestBuildSceneGraphHierarchy(!0),e.tryBuildSceneGraphHierarchy(!0,i),i.tryBuildSceneGraphHierarchy();var s,a=[];if((n=e.getActiveRepresentation().getSrc()).tileSets)for(s=0;s<n.tileSets.length;s++)a.push(this.createSingleTileSet(n.tileSets[s],r,i,t.manager,e,!0));else a.push(this.createSingleTileSet(n,r,i,t.manager,e,!1));Promise.all(a).then(n=>{var r,s,a,d,l=null,c=null;for(r=0;r<n.length;r++){if(s=(d=(a=n[r]).getRootNode()).matrix,1!==a.unitScale){var u=new h.Matrix4;u.makeScale(a.unitScale,a.unitScale,a.unitScale),s?(s=s.clone()).multiplyMatrices(u,s):s=u}l=h.mergeBoundingSphereInto(l,d.getBoundingSphere(),s),c=h.mergeBoundingBoxInto(c,d.getBoundingBox(),s)}i.registerTileSets(e,n),e.hasBoundingElement()||(e.setBoundingElements(l,c,null),e.isRoot&&o._updateBoundingSphere()),o._startModelLoaderTransaction(),o._onRepLoaded(e),o.endInstRefGraphTransaction(),t.doneCB([e],[]),e.isRoot&&o._onRootReferenceLoaded(e.referenceId)}),e.lockUnload()},l.prototype.createSingleTileSet=function(e,t,n,i,r,s){return new Promise((n,a)=>{var l=new o(e,i),c=t.getQueueSet();l.init(()=>{l.downloadTilesOneByOne([l.rootURI],()=>{var e=l.rootURI,i=l.preloadedJsonMap.get(e),o=this.expander.createNodeFromJSON(i,null,e,c,l,null);l.addNode(o);var a=r.getNode(),u=a;if(s&&(u=new d,a.addChild(u)),1!==l.unitScale){var p=new d,f=new h.Matrix4;f.makeScale(l.unitScale,l.unitScale,l.unitScale),p.setMatrix(f),u.addChild(p);var g=new d;p.addChild(g),u=g}var m={expander:this.expander,targetSGNode:u,node:o};o.setSgNode(u),o.updateWorldMatrix(),t.registerDSTilesNode(o),t.registerRootNode(m),n(l)})})})},l.prototype.isReferenceResolved=function(e){var t=e.getActiveRepresentation().getSrc();return t.tileSets||null!=t.rootURI&&null!=t.rootURI},l.prototype.handleBatch=function(e,t){var n,i,o=t.manager._ldhNodeManager,r=(t.manager,o.tilesManager,[]);for(n=0;n<e.references.length;n++)i=e.references[n],this.isReferenceResolved(i)?this.handleResolvedReference(i,t):r.push(i);var s=[],a=[];for(n=0;n<r.length;n++)(i=r[n]).getActiveRepresentation().getSrc().sourceId?(a.push(i),this.handleReferenceWithSourceId(i,t)):s.push(i);if(s.length)if(this.getDataCB){var d=[];for(n=0;n<s.length;n++)d.push(s[n].referenceId);this.getDataCB(d).then(this.onReferenceData.bind(this,s,t)).catch(()=>{t.doneCB([],s)})}else t.doneCB([],s)},l.prototype.onReferenceData=function(e,t,n){var i,o,r,s;for(i=0;i<e.length;i++)o={sourceId:(r=n[e[0].referenceId]).sourceId,resourceId:r.resourceId},(s=e[i]).getActiveRepresentation().src=o,this.handleReferenceWithSourceId(s,t)},l.prototype.handleReferenceWithSourceId=function(e,t){var n=e.getActiveRepresentation().getSrc(),i=n.sourceId,o=t.manager._ldhNodeManager.getServiceUrl(i),r=n.resourceId,s=o+({r2vsurvey:"/enovia/resources/r2v/v1/modeler",globe:"/datasupplier/dataset/3dstile"}[i]||"")+"/tileset"+(this.getSecurityParamsCB?"?tenant="+this.getSecurityParamsCB().tenant:""),d={resourceId:r};a.authenticatedRequest(s,{cors:!0,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},data:JSON.stringify(d),onComplete:(n,i)=>{var o=JSON.parse(n);e.getActiveRepresentation().setSrc(o),this.handleResolvedReference(e,t)},onFailure:()=>{t.doneCB([],[e])}})},l}),define("DS/3DXMTiles/DSTilesPriorityQueue",["DS/3DXMTiles/DSTilesNode"],function(e){"use strict";var t=function(){this.reset()};t.prototype.reset=function(){this.tileNode=null,this.parent=null,this.less=null,this.more=null},t.prototype.check=function(){var e=[];!function t(n){e.indexOf(n)>-1?console.log("argl"):(e.push(n),n.less&&t(n.less),n.more&&t(n.more))}(this)},t.prototype.checkMinMax=function(e,t){var n=!0;return this.tileNode&&(this.tileNode.isLessPrioritaryThan(e)||this.tileNode.isMorePrioritaryThan(t))&&(console.log("ERRRRRRRRRRREUUUUUUR"),n=!1),this.less&&!this.less.checkMinMax(e,t)&&(n=!1),this.more&&!this.more.checkMinMax(e,t)&&(n=!1),n},t.prototype.removeMin=function(e){var t=this.less;null!==t&&(null===t.less?(this.less=t.more,null!==this.less&&(this.less.parent=this),e.releaseHeapNode(t)):t.removeMin(e))},t.prototype.removeMax=function(e){var t=this.more;null!==t&&(null===t.more?(this.more=t.less,null!==this.more&&(this.more.parent=this),e.releaseHeapNode(t)):t.removeMax(e))},t.prototype.insert=function(e){e.tileNode.isLessPrioritaryThan(this.tileNode)?null!==this.less?this.less.insert(e):(this.less=e,e.parent=this):null!==this.more?this.more.insert(e):(this.more=e,e.parent=this)},t.prototype.getMin=function(){return null===this.less?this:this.less.getMin()},t.prototype.getMax=function(){return null===this.more?this:this.more.getMax()},t.prototype.getTileNodes=function(e){null!==this.tileNode&&e.push(this.tileNode),this.more&&this.more.getTileNodes(e),this.less&&this.less.getTileNodes(e)};var n=function(t){this.size=0,this.sizeLimit=t,this.root=null,this.firstFreeHeapNode=null,this.minHeapNode=e.MinusInfinity,this.maxHeapNode=e.PlusInfinity};n.prototype.getTileNodes=function(){var e=[];return null!==this.root&&this.root.getTileNodes(e),e},n.prototype.tryToInsertTileNodeMax=function(e,t,n){if(this.size<this.sizeLimit){if(!n||this.minHeapNode.isLessPrioritaryThan(e)){this.insert(e),t.min=null;var i=this.root.getMin();return this.minHeapNode=i.tileNode,!0}return!1}if(this.minHeapNode.isLessPrioritaryThan(e)){i=this.root.getMin();t.min=i.tileNode,this.insert(e),null!==i.parent?i.parent.removeMin(this):this.setRoot(i.more),this.size--;var o=this.root.getMin();return this.minHeapNode=o.tileNode,!0}return!1},n.prototype.tryToInsertTileNodeMin=function(e,t,n){if(this.size<this.sizeLimit){if(!n||this.maxHeapNode.isMorePrioritaryThan(e)){this.insert(e),t.max=null;var i=this.root.getMax();return this.maxHeapNode=i.tileNode,!0}return!1}if(this.maxHeapNode.isMorePrioritaryThan(e)){i=this.root.getMax();t.max=i.tileNode,this.insert(e),null!==i.parent?i.parent.removeMax(this):this.setRoot(i.less),this.size--;var o=this.root.getMax();return this.maxHeapNode=o.tileNode,!0}return!1},n.prototype.setRoot=function(e){null!==this.root&&this.releaseHeapNode(this.root),this.root=e,null!==e&&(e.parent=null)},n.prototype.getAndRemoveMaxTileNode=function(){var e=this.root.getMax(),t=e.tileNode;return this.removeMaxHeapNode(e),t},n.prototype.removeMaxHeapNode=function(e){null!==e.parent?e.parent.removeMax(this):this.setRoot(e.less),this.size--},n.prototype.removeMinHeapNode=function(e){null!==e.parent?e.parent.removeMin(this):this.setRoot(e.more),this.size--},n.prototype.getAndRemoveMinTileNode=function(){var e=this.root.getMin(),t=e.tileNode;return this.removeMinHeapNode(e),t},n.prototype.getMinHeapNode=function(){return null!==this.root?this.root.getMin():null},n.prototype.getMaxHeapNode=function(){return null!==this.root?this.root.getMax():null},n.prototype.insert=function(e){var t=this.getHeapNode(e);null===this.root?this.setRoot(t):this.root.insert(t),this.size++},n.prototype.getHeapNode=function(e){var n;return this.firstFreeHeapNode?(n=this.firstFreeHeapNode,this.firstFreeHeapNode=n.more,n.reset()):n=new t,n.tileNode=e,n},n.prototype.releaseHeapNode=function(e,t){e.less=null,t&&t(e.tileNode),e.tileNode=null,e.more=this.firstFreeHeapNode,this.firstFreeHeapNode=e},n.prototype.releaseHeapNodeTree=function(e,t,n){null!==e.less&&(this.releaseHeapNodeTree(e.less,t+1,n),e.less=null),null!==e.more&&(this.releaseHeapNodeTree(e.more,t+1,n),e.more=null),this.releaseHeapNode(e,n)},n.prototype.reset=function(t){null!==this.root&&(this.releaseHeapNodeTree(this.root,0,t),this.root=null,this.minHeapNode=e.MinusInfinity),this.size=0};var i=0,o=function(e){this.id=i++,this.nodeList=[],this.nbProcessedNodes=0,this.nodeListLength=0,this.listWasUpdated=!1,this.maxHeapNode=null,this.minHeapNode=null,this.negativeNodes=[],this.heap=new n(e||100)};return o.prototype.fillHeapMax=function(e){var t,n,i,o={min:null},r=this.nodeListLength,s=this.heap,a=0,d=e?0:this.nbProcessedNodes;for(i=d;i<r;i++)null!==(t=this.nodeList[i])&&t.isAlive()?t.getScore()<0?(this.negativeNodes.push(t),this.nodeList[i]=null,a++):s.tryToInsertTileNodeMax(t,o,0!==d)&&(n=o.min,this.nodeList[i]=n,null===n&&a++):a++;this.nbProcessedNodes=i,a>=this.nodeListLength?(this.nodeListLength=0,this.nbProcessedNodes=0):a>200&&this.cleanNulls(!0)},o.prototype.fillHeapMin=function(e){var t,n,i,o={max:null},r=this.nodeListLength,s=this.heap,a=0,d=e?0:this.nbProcessedNodes;for(i=d;i<r;i++)null!==(t=this.nodeList[i])&&t.isAlive()?t.getScore()<0?(this.negativeNodes.push(t),this.nodeList[i]=null,a++):s.tryToInsertTileNodeMin(t,o,0!==d)&&(n=o.max,this.nodeList[i]=n,null===n&&a++):a++;this.nbProcessedNodes=i,a>=this.nodeListLength?(this.nodeListLength=0,this.nbProcessedNodes=0):a>200&&this.cleanNulls(!0)},o.prototype.getMaxNodeWithNoHeap=function(){if(null!==this.heap.root)throw new Error("Heap not empty");var t,n=this.nodeListLength,i=-1,o=e.MinusInfinity,r=null,s=0;for(t=0;t<n;t++)null!==(r=this.nodeList[t])&&r.isAlive()?r.isMorePrioritaryThan(o)&&(i=t,o=r):s++;return i>-1?(r=this.nodeList[i],this.nodeList[i]=null):r=null,s>=this.nodeListLength?this.nodeListLength=0:s>200&&this.cleanNulls(!1),r},o.prototype.peekMaxNode=function(){if(!this.maxHeapNode){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1);var e=null;this.heap.size>0?e=this.heap.root.getMax():this.negativeNodes.length>0&&(e=this.negativeNodes[this.negativeNodes.length-1]),this.maxHeapNode=e}return this.maxHeapNode?this.maxHeapNode.tileNode:null},o.prototype.peekMinNode=function(){if(!this.minHeapNode){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var e=null;this.heap.size>0&&(e=this.heap.root.getMin()),this.minHeapNode=e}return this.minHeapNode?this.minHeapNode.tileNode:null},o.prototype.removeMaxHeapNode=function(e){this.heap.removeMaxHeapNode(e)},o.prototype.getMaxNode=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1);var t=null;return this.heap.size>0?t=e?this.heap.getAndRemoveMaxTileNode():this.heap.getMaxNode():this.negativeNodes.length>0&&(t=this.negativeNodes.pop()),t},o.prototype.getMinNode=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var t=null;return this.negativeNodes.length>0?t=this.negativeNodes.pop():this.heap.size>0&&(t=e?this.heap.getAndRemoveMinTileNode():this.heap.getMinNode()),t},o.prototype.checkIntegrity=function(e){var t,n=-1/0,i=1/0;if(this.heap.size>0)for(n=this.heap.root.getMin().tileNode,i=this.heap.root.getMax().tileNode,this.heap.root.checkMinMax(n,i)||console.log("checkMinMax has failed!!!"),t=0;t<(void 0!==e?e:this.nodeListLength);t++)this.nodeList[t]&&this.nodeList[t].isMorePrioritaryThan(n)&&console.log("found probleme!!!")},o.prototype.getMinNodeWithNoHeap=function(){if(null!==this.heap.root)throw new Error("Heap not empty");var t,n=this.nodeListLength,i=-1,o=e.PlusInfinity,r=null,s=0;for(t=0;t<n;t++)null!==(r=this.nodeList[t])&&r.isAlive()?r.isLessPrioritaryThan(o)&&(i=t,o=r):s++;return i>-1?(r=this.nodeList[i],this.nodeList[i]=null):r=null,s>=this.nodeListLength?this.nodeListLength=0:s>200&&this.cleanNulls(!1),r},o.prototype.cleanNulls=function(e){var t,n=this.nodeListLength,i=null,o=0;for(t=0;t<n;t++)null!==(i=this.nodeList[t])&&i.isAlive()?(this.nodeList[o]=i,o++):e&&t<this.nbProcessedNodes&&this.nbProcessedNodes--;this.nodeListLength=o,this.nodeList.length=this.nodeListLength},o.prototype.isEmpty=function(){return 0===this.heap.size&&0===this.nodeListLength&&0===this.negativeNodes.length},o.prototype.clear=function(e){var t;if(this.heap.reset(e),e)for(t=0;t<this.nodeListLength;t++)this.nodeList[t]&&e(this.nodeList[t]);this.nodeListLength=0,this.nbProcessedNodes=0,this.maxHeapNode=null,this.minHeapNode=null},o.prototype.resetOrder=function(e){var t,n=this.heap.getTileNodes();for(this.heap.reset(),t=0;t<n.length;t++)this.addNode(n[t]);for(t=0;t<this.negativeNodes.length;t++)this.addNode(this.negativeNodes[t]);if(this.negativeNodes.length=0,e){var i,o=0;for(t=0;t<this.nodeListLength;t++)(i=this.nodeList[t])&&e(i)&&(this.nodeList[o]=i,o++);this.nodeListLength=o}},o.prototype.addNode=function(e){this.nodeListLength>=this.nodeList.length?(this.nodeList.push(e),this.nodeListLength=this.nodeList.length):this.nodeList[this.nodeListLength++]=e,this.listWasUpdated=!0},o.prototype.peekMinHeapNode=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1),this.heap.getMinHeapNode()},o.prototype.peekMaxHeapNode=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1),this.heap.getMaxHeapNode()},o.prototype.traverseMin=function(e){var t,n,i;for((0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1),t=this.negativeNodes.length-1;t>=0;t--){if(!e(this.negativeNodes[t]))return;this.negativeNodes.length--}do{i=!0,null!==(n=this.peekMinHeapNode())&&e(n.tileNode)&&(this.heap.removeMinHeapNode(n),i=!1)}while(!i)},o.prototype.traverseMinPlus=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var t,n,i,o,r,s=[];function a(){i=!0}function d(){n=!0}for(n=!1,o=this.negativeNodes.length-1;o>=0&&!n;o--)r=this.negativeNodes[o],i=!1,n=!1,e(r,d,a),this.negativeNodes.length--,i&&s.push(r);for(;!n;)n=!1,i=!1,null!==(t=this.peekMinHeapNode())?(e(t.tileNode,d,a),n&&i||(i&&s.push(t.tileNode),this.heap.removeMinHeapNode(t))):n=!0;for(o=0;o<s.length;o++)this.addNode(s[o])},o.prototype.traverseMax=function(e){var t,n;do{n=!0,null!==(t=this.peekMaxHeapNode())&&e(t.tileNode)&&(this.heap.removeMaxHeapNode(t),n=!1)}while(!n)},o.prototype.traverseMaxPlus=function(e){var t,n,i,o,r=[];function s(){i=!0}function a(){n=!0}do{n=!1,i=!1,null!==(t=this.peekMaxHeapNode())?(e(t.tileNode,a,s),n&&i||(i&&r.push(t.tileNode),this.heap.removeMaxHeapNode(t))):n=!0}while(!n);for(o=0;o<r.length;o++)this.addNode(r[o])},o.prototype.removeNode=function(e){var t;for(this.resetOrder(),t=0;t<this.nodeListLength;t++)this.nodeList[t]===e&&(this.nodeList[t]=null)},o.prototype.getAllNodes=function(){var e,t,n=[];for(t=0;t<this.nodeListLength;t++)(e=this.nodeList[t])&&n.push(e);var i=this.heap.getTileNodes();return n.concat(i)},o.prototype.getMaxNodes=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1),this.heap.getTileNodes()},o.prototype.getSize=function(){return this.cleanNulls(),this.nodeListLength+this.heap.size},o}),define("DS/3DXMTiles/OOCTileSetHandler",["DS/3DXMTiles/OOCHandler","DS/3DXMTiles/LDHTileSetHandler"],function(e,t){var n=function(n){var i=new t(n=n||{});e.call(this,e.TileSetHandler,i)};return n.prototype=Object.create(e.prototype),n}),define("DS/3DXMTiles/DSTilesQueue",["DS/3DXMTiles/DSTilesPriorityQueue","DS/3DXMTiles/DSTilesNodeStatus"],function(e,t){"use strict";var n=function(t,n){this.sortingMetric=n,this.nodes=[],this.newNodes=[],this.nodesToUpdateSet=new Set,this.nodesToLoadQueue=new e,this.nodesToExpandQueue=new e,this.unloadSmallNodesQueue=new e,this.tmpTraverseRoots=new Set,this.unloadSmallNodesInitNeeded=!0,this.queueSet=t,this.nbLoading=0,this.nbExpanding=0,this.updateIndex=0};return n.prototype.registerRootNodeFromLink=function(e,t,n){var i=e.expander,o=this;i.loadNodeFromLink(e.link,function(n){e.node=n,o.registerDSTilesNode(n),o.registerRootNode(e),t(n)},n,this)},n.prototype.registerDSTilesNode=function(e,t){if(e.isAlive())e.isInUnload()||e.setInUnload(!0),e.isInList()?t&&this.forceUpdateNode(e):(e.setInList(!0),this.newNodes.push(e)),this.getLDHManager().requestUpdate(!1,!1);else if(e.isInToBeLoaded()&&(e.setInToBeLoaded(!1),this.nodesToLoadQueue.removeNode(e)),e.isInToExpand()&&(this.nodesToExpandQueue.removeNode(e),e.setInToExpand(!1)),e.isInUnload()&&e.setInUnload(!1),e.isInList()){var n=this.newNodes.indexOf(e);n>=0&&(this.newNodes[n]=null),(n=this.nodes.indexOf(e))>=0&&(this.nodes[n]=null),e.setInList(!1)}},n.prototype.unloadSmallNodes=function(e){var t,n,i=this.getTilesManager().memoryManager;if(this.unloadSmallNodesInitNeeded)for(this.unloadSmallNodesInitNeeded=!1,t=0;t<this.nodes.length;t++)(n=this.nodes[t])&&n.isContentLoaded()&&!n.getToUnload()&&this.unloadSmallNodesQueue.addNode(n);var o=!1;return this.unloadSmallNodesQueue.traverseMinPlus((t,n,r)=>{t.getScore()<e||t.getOnHold()?(t.lockLoadDate=Date.now()+2e3,t.deleteContent(this),i.isLoadingAllowed()&&n()):(o=!0,n())}),o},n.prototype.getTilesManager=function(){return this.queueSet.tilesManager},n.prototype.getLDHManager=function(){return this.queueSet.tilesManager.ldhNodeManager},n.prototype.forceUpdateNode=function(e){this.nodesToUpdateSet.add(e)},n.prototype.updateNodes=function(e,t){var n;if(this.updateIndex++,!e)for(this.updateNodesToLoad(this.newNodes,t);this.nodesToUpdateSet.size>0;){var i=this.nodesToUpdateSet;this.nodesToUpdateSet=new Set,this.updateNodesToLoad(Array.from(i),t)}for(n=0;n<this.newNodes.length;n++)this.nodes.push(this.newNodes[n]);if(this.newNodes.length=0,this.nodesToUpdateSet.clear(),e&&this.resetNodesToLoad(),e)this.updateNodesToLoad(this.nodes,t);else{var o=this.getViewer();this.tmpTraverseRoots.forEach(e=>{e.traverseUpdateNodes(o)}),this.tmpTraverseRoots.clear()}},n.prototype.loadNodes=function(e,t){this.unloadSmallNodesInitNeeded=!0,this.unloadSmallNodesQueue.clear();var n=!1,i=this.getTilesManager().memoryManager,o=this,r=Date.now(),s=new Set;this.nodesToLoadQueue.traverseMaxPlus(function(e,t,a){if(e.isAlive()){var d=!1,h=(e.contentLoader,e.tileSet);h.canLoadContent()&&e.lockLoadDate<r&&(n||e.isContentLoadingAllowed(i)||(n=o.unloadSmallNodes(e.getScore())),e.isContentLoadingAllowed(i)&&e.isContentToLoad()&&!e.isError()&&(h.loadTileContent(e),s.add(h),o.nbLoading++,e.setInToBeLoaded(!1),d=!0)),d||(a(),t())}}),s.forEach(e=>{e.flushLoadTileContent()}),s=new Set,this.nodesToExpandQueue.traverseMaxPlus(function(e,t,n){if(e.isAlive()){var r=!1,a=(e.expander,e.tileSet);a.canExpand()&&e.isExpandLoadingAllowed(i)&&e.isExpandToLoad()&&!e.isError()&&(a.expandTile(e),s.add(a),o.nbExpanding++,e.setInToExpand(!1),r=!0),r||(n(),t())}}),s.forEach(e=>{e.flushExpandTile()})},n.prototype.cleanLists=function(){function e(e){var t,n=0;for(t=0;t<e.length;t++)null!==e[t]&&(e[n]=e[t],n++);e.length=n}e(this.nodes),e(this.newNodes)},n.prototype.onNodeLoaded=function(e){if(this.nbLoading--,e.isAlive()){e.setContentStatus(t.loaded,this);e.parent;e.isAddLODMode()&&e.getWished()&&e.showContent();var n=this.getLDHManager();if(e.isReplaceLODMode()){for(var i=e;i.parent;)i=i.parent;(i=i||e).traverseReplace(n.viewer)}n.requestUpdate(!1,!1),n.viewer.render({budgeted:!0})}},n.prototype.onNodeLoadError=function(e){(this.nbLoading--,e.isAlive())&&(e.setContentStatus(t.error,this),this.getLDHManager().requestUpdate(!1,!1))},n.prototype.onNodeExpanded=function(e){(this.nbExpanding--,e.isAlive())&&(this.tmpTraverseRoots.add(e),e.setExpandStatus(t.loaded,this),e.children||(e.children=[]),this.getLDHManager().requestUpdate(!1,!1))},n.prototype.onNodeExpandError=function(e){(this.nbExpanding--,e.isAlive())&&(e.setExpandStatus(t.error,this),e.children=[],this.getLDHManager().requestUpdate(!1,!1))},n.prototype.computeTilesScore=function(e,n,i){var o,r,s;for(o=0;o<e.length;o++)if((r=e[o])&&!r.getOnHold()&&!r.isError())if(r.computeScore(this.updateIndex,n),r.passVisibilityTest()){if(r.setToUnload(!1),r.getChildrenOnHold()&&!r.passPixelErrorTest()&&(r.setChildrenOnHold(!1),r.children))for(s=0;s<r.children.length;s++)i.add(r.children[s]),r.children[s].setOnHold(!1);!r.hasExpand()||r.isExpandLoading()||r.isExpandLoaded()||(r.setExpandStatus(t.toLoad,this),r.isInToExpand()||(this.nodesToExpandQueue.addNode(r),r.setInToExpand(!0)))}else r.setToUnload(!0)},n.prototype.updateNodesToLoad=function(e,t){for(var n=e;n.length;){var i=new Set;this.computeTilesScore(n,t,i),n=Array.from(i)}},n.prototype.updateNodesToLoad_OLD=function(e,n){var i,o,r=!1,s=[];for(i=0;i<e.length;i++)(o=e[i])&&o.isAlive()&&!o.getOnHold()&&!o.isError()&&o.lastUpdateIndex<this.updateIndex&&(o.lastUpdateIndex=this.updateIndex,o.scoreComputer.computeScore(o,n,o.isLODMode()),o.passVisibilityTest()?(o.setToUnload(!1),!o.hasContent()||o.isContentLoading()||o.isContentLoaded()||(o.setContentStatus(t.toLoad,this),o.isInToBeLoaded()||(this.nodesToLoadQueue.addNode(o),o.setInToBeLoaded(!0))),!o.hasExpand()||o.isExpandLoading()||o.isExpandLoaded()||(o.setExpandStatus(t.toLoad,this),o.isInToExpand()||(this.nodesToExpandQueue.addNode(o),o.setInToExpand(!0))),o.isLODMode()&&s.push(o)):o.setToUnload(!0));for(i=0;i<s.length;i++)(o=s[i]).updateLODHierarchy(this)&&(r=!0);r&&this.getLDHManager().requestUpdate(!1,!1)},n.prototype.resetNodesToLoad=function(){this.nodesToExpandQueue.clear(function(e){e.setInToExpand(!1)}),this.nodesToLoadQueue.clear(function(e){e.setInToBeLoaded(!1)})},n.prototype.getViewer=function(){return this.getLDHManager().viewer},n.prototype._dbgGetNodeFromURI=function(e){var t;for(t=0;t<this.nodes.length;t++)if(this.nodes[t].uri===e)return this.nodes[t];return null},n}),define("DS/3DXMTiles/DSTilesQueueSet",["DS/3DXMTiles/DSTilesQueue"],function(e){"use strict";var t=function(e){this.tilesManager=e,this.queues=[]};return t.prototype.getQueueFromTileSet=function(t){var n,i,o=t.getSortingMetric();for(n=0;n<this.queues.length;n++)if((i=this.queues[n]).sortingMetric===o)return i;return i=new e(this,o),this.queues.push(i),i},t.prototype.updateNodes=function(e,t){var n;for(n=0;n<this.queues.length;n++)this.queues[n].updateNodes(e,t)},t.prototype.loadNodes=function(e,t){var n;for(n=0;n<this.queues.length;n++)this.queues[n].loadNodes(e,t)},t.prototype.isLoading=function(){var e,t;for(t=0;t<this.queues.length;t++)if((e=this.queues[t]).nbLoading>0||e.nbExpanding>0)return!0;return!1},t.prototype.cleanLists=function(){for(i=0;i<this.queues.length;i++)this.queues[i].cleanLists()},t}),define("DS/3DXMTiles/DSTilesManager",["DS/3DXMTiles/DSTilesQueueSet","DS/3DXMTiles/MemoryBudgetManager","DS/3DXMTiles/DSTilesRootEntry"],function(e,t,n){"use strict";var i=function(e){this.memoryManager=new t(e.unloadManager),this.ldhNodeManager=e,this.rootEntries=[],this.queueSets=[]};return i.prototype.getQueueSet=function(t){return 0===this.queueSets.length&&this.queueSets.push(new e(this)),this.queueSets[0]},i.prototype.registerRootNode=function(e){e.expander.init(this);var t=e.node;t.sgNode||t.buildSgNode();var i=e.targetSGNode;i&&i!==t.sgNode&&i.addChild(t.sgNode);var o=new n({node:t});this.rootEntries.push(o)},i.prototype.removeTileSet=function(e){var t,n=e.getTile(e.rootURI);for(t=0;t<this.rootEntries.length;t++)if(this.rootEntries[t].node==n){this.rootEntries.splice(t,1);break}for(n.destroy(),t=0;t<this.queueSets.length;t++)this.queueSets[t].cleanLists();e.dispose()},i.prototype.registerDSTilesNode=function(e){e.queue.registerDSTilesNode(e)},i.prototype.updateNodes=function(e,t){var n,i;for(n=0;n<this.rootEntries.length;n++)this.rootEntries[n].node.updateDescendantLocked(),(i=this.rootEntries[n].node.tileSet).updateForceLoad();for(n=0;n<this.rootEntries.length;n++)this.rootEntries[n].node.updateWorldMatrix(!0);for(n=0;n<this.queueSets.length;n++)this.queueSets[n].updateNodes(e,t);if(e)for(n=0;n<this.rootEntries.length;n++)this.rootEntries[n].node.traverseUpdateNodes(this.ldhNodeManager.viewer);for(n=0;n<this.rootEntries.length;n++)(i=this.rootEntries[n].node.tileSet).flushLoadTileContent(),i.flushExpandTile()},i.prototype.loadNodes=function(e,t){var n,i=this.memoryManager;for(i.startUnload()&&(this.unloadNodes(),i.endUnload()),n=0;n<this.queueSets.length;n++)this.queueSets[n].loadNodes(e,t)},i.prototype.isLoading=function(){var e;for(e=0;e<this.queueSets.length;e++)if(this.queueSets[e].isLoading())return!0;return!1},i.prototype.unloadNodes=function(e){var t;for(e&&(window.forceUnload=!0),t=0;t<this.rootEntries.length;t++)this.rootEntries[t].node.tryUnload(this.memoryManager);e&&(window.forceUnload=!1)},i}),define("DS/3DXMTiles/LDHNodeManager",["DS/3DXMTiles/LDHNodeManagerQueue","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/3DXMTilesUtils","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/UnloadManager","DS/3DXMTiles/PriorityQueue","DS/3DXMTiles/LDHReferenceUnloadStatus","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/3DXMTiles/LDHUserQueue","DS/3DXMTiles/LDHCandidateQueueRenderer","DS/3DXMTiles/LDHLoadingBoxManager","DS/3DXMTiles/Debug3DXMTiles","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/3DXMTiles/MassiveOcclusionChecker","DS/CoreEvents/Events","DS/3DXMTiles/LDHStats","DS/Visualization/BufferGPUManager","DS/VisuTools/FPSCounter","DS/3DXMTiles/DSTilesManager"],function(e,t,n,i,o,r,s,a,d,h,l,c,u,p,f,g,m,y,v,M){"use strict";var S="ON"===window.localStorage.getItem("OOCPerfo"),L=function(n){m.init(),y.initAtLoading=!0,y.fillMapGeomBufferSize=!0,S&&(v.setAutoRefresh(!1),n.viewer.showPerfo(!0,!1)),this.getServiceUrlCB=n.getServiceUrlCB||null,this.tilesQueueSuperUpdate="OFF"!==localStorage.getItem("DSTilesSuperUpdate"),this.forceClientBox="ON"===localStorage.getItem("OOCClientBox"),this.enableUnload=void 0===window.OOCEnableUnload||window.OOCEnableUnload,this.viewer=n.viewer,this.bsNode=new p("ooc_bsNode"),this.bsNode.setVisibilityFree(!0),this.viewer.addNode(this.bsNode),this.fullVPToken=null,this.fullVPLoading=0,this.forceSceneMin=n.forceSceneMin,this.newLoadingBoxes=!!n.newLoadingBoxes,void 0!==n.maxNbBoxes&&(l.maxNbBoxes=n.maxNbBoxes);var i=this;this.alreadyCalledFullVP=!1,this.onViewpointMoveToken=this.viewer.currentViewpoint.onMove(function(){i.onViewpointMove()}),this.onSwapVisibleSpaceToken=this.viewer.onSwapVisibleSpace(function(){setTimeout(function(){i.onViewpointMove()},200)}),this.progressiveExpand=!!n.progressiveExpand,this.queues=[new e(t.Model3DHandler,this),null,new e(t.TileSetHandler,this)],this.progressiveExpand&&(this.queues[1]=new e(t.InstRefHandler,this),this.queues[1].enableOcclusionTest=!1),this.queues[2].enableOcclusionTest=!1,this.requestUpdateToken=null,this.fullVPPending=!1,this.updateOptions={viewpointChanged:!1,modelLoaded:!1},this.viewpointHasChanged=!0,this.targetNode=null,this.requestUpdate(!0,!0),this.unloadManager=new o(n.config,n.meshInRAM,n.oocManager),this.tilesManager=new M(this,n.config),this.previousIsLoading=!1,this.onStartLoadingCB=null,this.onEndLoadingCB=null,this.suspendedReferenceActions=[],this.debugThrottle=0,this.pauseLoadingMap=new Map,this.oocManager=n.oocManager,this.viewpointTag=0,this.debugMissingExpectedNbChildren=!!window.debugMissingExpectedNbChildren,this.unloadSmallNodesEnabled=!0,this.unloadLeafReferenceCB=null,this.onLeafReferenceLoadedCB=null,this.pauseLoadingDuringViewpointMove=!0,this._dbg_freezeViewpointTag=!1,this.overrideSetManager=null,this.overrideSetMap={},this.lastQueueRendererUpdateTime=0,this.queueRenderer=null,this.userQueues=[],this.rootAdded=!1,this.lastDeltaTime=-1,this.startLoadTime=null,this.hasUnloadedSmallNodes=!1,this.emergencyUnloadOccured=!1,this.emergencyUnloadAvoided=!1,this.instRefTransactionCPUMemoryFullOccurred=!1,this.boundingSphere=new u.Sphere,this.viewer.onPreRender(this.onPreRender.bind(this)),this.lastOcclusionTime=0,this.occlusionTestEnabled=void 0===n.enableOcclusionTest||n.enableOcclusionTest,this.occlusionTestEnabled||(this.queues[0].enableOcclusionTest=!1),this.fullVPHandler=null,this.switchRepresentationBuffer=new Map,this.globalMeshInRAMCounter=0,this.needGlobalSwitchNoMeshInRAM=!1,this.switchNoMeshInRAMReferences=new Set,this.loadingReferencesToSwitchToNoMeshInRAM=new Set,this.occlusionChecker=null,window.oocLDHNodeManager=this,this.needsOcclusion=!1,this.updateLoadingBoxesRequested=!1,this.tileSetMap=new Map,this.disableFullVP=!1,this.fullVPScreenRadius=0,this.loadingReferencesFromBox=0};L.prototype.registerTileSets=function(e,t){this.tileSetMap.set(e,t)},L.prototype.removeTileSets=function(e){var t,n=this.tileSetMap.get(e);for(this.tileSetMap.delete(e),t=0;n&&t<n.length;t++)this.tilesManager.removeTileSet(n[t])},L.prototype.getTileSets=function(e){return this.tileSetMap.get(e)},L.prototype.onSceneChange=function(){this.needsOcclusion=!0},L.prototype.isSlave=function(){return this.oocManager.isSlave()},L.prototype.isOOC=function(){return this.oocManager.isOOC()};var D=function(e,t){this.references=e,this.callback=t};function T(e,t,n,i){this.viewpoint=e,this.cst=t,this.bsRadius=n?n.radius:0,this.pixelCulling=Math.min(i.getPixelCulling("static"),i.getPixelCulling("dynamic"))}L.prototype.setUnloadSmallNodesEnabled=function(e){this.unloadSmallNodesEnabled=e},L.prototype.onPreRender=function(e){if(this.queues[0].renderingOccured=!0,e.viewpoint==this.viewer.currentViewpoint&&this.updateLoadingBoxesRequested){var t=this.createViewpointData(this.viewer.currentViewpoint);this.updateCandidateQueueRenderer(!1,t),this.updateLoadingBoxesRequested=!1}},L.prototype.tryBuildSceneGraphHierarchy=function(){var e,t=this.oocManager.getRootOccurrences(),n=[],i=this;for(t.forEach(function(e,t,o){e.occurrence.reference.tryBuildSceneGraphHierarchy(n,i)}),e=0;e<n.length;e++)n[e].updateOverride(this)},L.prototype.setPauseLoadingDuringViewpointMove=function(e){this.pauseLoadingDuringViewpointMove=e},L.prototype.tryToPerformReferenceAction=function(e,t){var n,i=!0;for(n=0;n<e.length;n++)e[n].isLoading()&&(i=!1);if(i){var o=this;return t.call(void 0,e,function(){o.requestUpdate(!0,!0)}),!0}return!1},L.prototype.executeReferenceAction=function(e,t){this.tryToPerformReferenceAction(e,t)||this.suspendedReferenceActions.push(new D(e,t))},L.prototype.setTargetNode=function(e){this.targetNode=e},L.prototype.registerTilesNode=function(e){if(this.alreadyCalledFullVP||this.onViewpointMove(),this.progressiveExpand||1!==e.handler.type){if(e._status!==i.loaded&&e._status!==i.loading&&e._status!==i.waiting&&e._status!==i.toUnload&&e._status!==i.toLoad&&e._status!==i.error)return;var t=e.handler;this.queues[t.type].registerNode(e),this.requestUpdate(!1,!1)}else this.fullVPHandler||(this.fullVPHandler=e.handler,this.onViewpointMove())},L.prototype.unregisterNode=function(e){if(!e.isAlive()){var t=e.handler,n=this.queues[t.type];n&&n.unregisterNode(e)}},L.prototype.forceUpdateNode=function(e){var t=e.handler;0===t.type&&(this.queues[t.type].forceUpdateNode(e),this.requestUpdate(!1,!1))},L.prototype.requestUpdate=function(e,t){this.updateOptions.viewpointChanged=this.updateOptions.viewpointChanged||e,this.updateOptions.modelLoaded=this.updateOptions.modelLoaded||t,null===this.requestUpdateToken&&(this.requestUpdateToken=setTimeout(this._updateNodes.bind(this),0))},L.prototype._updateNodes=function(){c.startProbe("updateNodes");var e,t,n,i=this.createViewpointData(this.viewer.currentViewpoint);if(this.suspendedReferenceActions.length>0){for(e=0;e<this.suspendedReferenceActions.length;e++)n=this.suspendedReferenceActions[e],this.tryToPerformReferenceAction(n.references,n.callback)&&(this.suspendedReferenceActions[e]=null);this.suspendedReferenceActions=this.suspendedReferenceActions.filter(function(e){return null!==e})}null!==this.requestUpdateToken&&(clearTimeout(this.requestUpdateToken),this.requestUpdateToken=null);var o=this.viewer.currentViewpoint.isMoving();if(this.pauseLoadingDuringViewpointMove&&o)return this.emergencyUnloadNodes(i),this.requestUpdate(!1,!1),void c.endProbe("updateNodes");if(this.viewpointHasChanged=this.viewpointHasChanged||this.updateOptions.viewpointChanged,this.viewpointHasChanged&&(this.hasUnloadedSmallNodes=!1,this.emergencyUnloadOccured=!1,this.emergencyUnloadAvoided=!1),(this.viewpointHasChanged||this.needsOcclusion)&&(this.occlusionChecker&&this.occlusionChecker.dispose(),this.occlusionChecker=null),this.clearMeshInRAMForLoadingReferences(),this.getPauseLoading()||2===this.debugThrottle)return this.updateUserQueues(this.viewpointHasChanged,i),this.checkAutoMeshInRAM(),this.emergencyUnloadNodes(i),this.updateLoadingStatus(),void c.endProbe("updateNodes");for(this.viewpointHasChanged&&!this._dbg_freezeViewpointTag&&this.viewpointTag++,!this.newLoadingBoxes&&this.viewpointHasChanged&&this.queueRenderer&&this.queueRenderer.clearClusters(),e=0;e<this.queues.length;e++)(t=this.queues[e])&&t.updateNodes(this.viewpointHasChanged,i);this.tilesManager.updateNodes(this.viewpointHasChanged,i),this.updateUserQueues(this.viewpointHasChanged,i),this.computeOcclusion(this.viewpointHasChanged||this.needsOcclusion),this.needsOcclusion=!1,this.checkAutoMeshInRAM(),this.enableUnload&&(this.unloadManager.isUnloadNeeded()&&this.removeMeshInRAMForUnload(),this.updateLoadedNodes(this.viewpointHasChanged,i),this.emergencyUnloadNodes(i)),this.debugThrottle<1&&(this.loadNodes(this.viewpointHasChanged,i),this.tilesManager.loadNodes(this.viewpointHasChanged,i)),this.viewpointHasChanged=!1,this.updateOptions.viewpointChanged=!1,this.updateOptions.modelLoaded=!1,this.updateLoadingStatus(),this.updateLoadingBoxesRequested=!0,c.endProbe("updateNodes")},L.prototype.removeMeshInRAMForUnload=function(){if(this.needGlobalSwitchNoMeshInRAM)this.globalMeshInRAMSwitch(!1),this.needGlobalSwitchNoMeshInRAM=!1;else{var e=this,t=this.oocManager;this.switchNoMeshInRAMReferences.forEach(function(n){if(!t.isMeshInRAMRequested(n)){var i=t._getLDHReference(n,!0);i&&i.switchMeshInRAM(!1,e)}}),0!==this.switchNoMeshInRAMReferences.size&&(this.switchNoMeshInRAMReferences=new Set)}},L.prototype.onViewpointMove=function(){if(this.requestUpdate(!0,!1),this.startLoadTime=(new Date).getTime(),this.getPauseLoading()||this.requestFullVP(1e3),!this.getPauseLoading()&&this.tilesQueueSuperUpdate){var e=this.createViewpointData(this.viewer.currentViewpoint);this.tilesManager.updateNodes(!0,e),this.tilesManager.loadNodes(!0,e),this.updateLoadingStatus()}},L.prototype.forceFullVP=function(){this.requestFullVP(0)},L.prototype.requestFullVP=function(e){if(!this.progressiveExpand&&!this.getPauseLoading()&&this.oocManager.hasActiveRoot()){var t=this;null!==t.fullVPToken&&(t.decFullVPLoading(),clearTimeout(t.fullVPToken),t.fullVPToken=null),this.incFullVPLoading(),this.fullVPToken=setTimeout(function(){t.fullVPToken=null,t.decFullVPLoading(),t.goFullVP()},e)}},L.prototype.getRootsToExpand=function(){var e=[];return this.oocManager.getRootOccurrences().forEach(function(t,n,i){(t.enableExpand||t.treeModified)&&(t.occurrence.reference.isLeaf()||e.push(t))}),e},L.prototype.goFullVP=function(){var e=this.fullVPHandler;if(!this.progressiveExpand&&null!==e&&!this.getPauseLoading()&&this.debugThrottle<1&&!this.disableFullVP)if(m.onNewViewpoint(),e.isReady()){this.fullVPPending=!1,this.alreadyCalledFullVP=!0;var t=this.getRootsToExpand();if(t.length>0){var n,i,o={viewpointTag:this.viewpointTag,manager:this.oocManager,doneCB:this.onFullVPDone.bind(this),screenRadius:this.fullVPScreenRadius};for(i=0;i<t.length;i++)(n=t[i]).treeModified=!1,this.incFullVPLoading(),e.handleReferences([n.occurrence.reference],o,[n.rootId],!0)}this.updateLoadingStatus()}else this.fullVPPending=!0;else this.updateLoadingStatus()},L.prototype.loadReferencesFromBox=function(e,t,n){var i,o=this.fullVPHandler,r=this.oocManager.getRootOccurrences(),s=[],a=[],d=this.forceClientBox;if(r.forEach(function(e,t,n){var i=e.occurrence.reference;i.isLeaf()||(e.elasticLoading&&e.enableExpand&&!d?s.push(i):a.push(i))}),s.length>0||a.length>0){var h,l=s.length,c=[],u=[],p={doneCB:e=>{if(l--,c=c.concat(e.representationsList),0===l){this.loadingReferencesFromBox--;var n=function(e,t){if(0===t.length)return e;if(0===e.length)return t;var n,i=new Set;for(n=0;n<e.length;n++)i.add(e[n]);for(n=0;n<t.length;n++)i.add(t[n]);return Array.from(i)}(c,u);t(n),this.updateLoadingStatus()}},errorCB:e=>{p.doneCB({representationsList:[]}),n&&n(e)}};for(this.loadingReferencesFromBox++,h=0;h<s.length;h++){var f=s[h].referenceId;o.oocHandler.handleBox(f,(void 0,{corner_min:[""+(i=e).min.x,""+i.min.y,""+i.min.z],corner_max:[""+i.max.x,""+i.max.y,""+i.max.z],transformation_matrix:["1.000","0.000","0.000","0.000","1.000","0.000","0.000","0.000","1.000","0.000","0.000","0.000"],intersection_mode:"partly_in",filter_only_on_bounding_box:1}),p)}if(a.length>0){var g=this.queues[0];g&&(u=g.computeNodesCollidingWithBox(e)),0===l&&setTimeout(t.bind(null,u))}}else setTimeout(t.bind(null,[]));this.updateLoadingStatus()},L.prototype.onFullVPDone=function(){this.decFullVPLoading(),this._updateNodes(),this.fullVPPending&&this.forceFullVP(),this.updateLoadingStatus(),this.requestUpdate(!1,!1)},L.prototype.computeOcclusion=function(e){var t=this.queues[0];if(t.enableOcclusionTest){e&&(this.occlusionChecker&&this.occlusionChecker.dispose(),this.occlusionChecker=null);var n=(new Date).getTime(),i=n-this.lastOcclusionTime>=50;(e||this.queues[0].requiresOcclusion(i))&&(this.occlusionChecker||(this.occlusionChecker=new f({viewer:this.viewer,ratio:.25,renderList:"ooc"})),m.onOcclusion(),t.computeOcclusion(this.occlusionChecker,e),i&&(this.lastOcclusionTime=n))}},L.prototype.updateUserQueues=function(e,t){var n;for(n=0;n<this.userQueues.length;n++){var i=this.userQueues[n];this.getPauseLoading()&&i.pauseSensitive||(e&&i.handleViewpointChange(t),i.traverseQueue())}},L.prototype.loadNodes=function(e,t){var n,i;if(this.debugThrottle<.5)for(n=0;n<this.queues.length;n++)(i=this.queues[n])&&i.loadNodes(e,t)},L.prototype.createViewpointData=function(e){return new T(e,n.computeScreenRadiusCstComponent(e.camera,this.viewer),this.boundingSphere,this.viewer)},L.prototype.removeRemovedNodes=function(){var e;for(e=0;e<this.queues.length;e++)this.queues[e]&&this.queues[e].removeUselessNodesFromList(this.queues[e].nodes)},L.prototype.updateLoadingStatus=function(){var e,t,n,i=!1,o=this.hasUnloadedSmallNodes;for(i=this.fullVPLoading>0||i||this.rootAdded||this.loadingReferencesFromBox>0,this.tilesManager.isLoading()&&(i=!0),this.rootAdded=!1,t=0;t<this.queues.length;t++)(n=this.queues[t])&&(i=i||n.isLoading(),o=o||n.hasMoreToLoad());var r=!this.unloadManager.isLoadingAllowed(0)||!this.unloadManager.isLoadingAllowed(1);if(!r&&!i&&this.previousIsLoading)for(t=0;t<this.queues.length;t++)if((n=this.queues[t])&&n.hasMissingNodesToBeLoaded()){this.requestUpdate(!1,!1),n.resetNodesToLoad(),i=!0;break}if(i!==this.previousIsLoading){var s={isLoading:i,memoryFull:r||this.emergencyUnloadOccured||this.emergencyUnloadAvoided||this.instRefTransactionCPUMemoryFullOccurred,emergencyUnload:this.emergencyUnloadOccured,emergencyUnloadAvoided:this.emergencyUnloadAvoided};if(i)c.startProbe("viewpoint"),this.startLoadTime=(new Date).getTime(),this.viewer.setRenderIteration(!1),this.onStartLoadingCB&&this.onStartLoadingCB.call(void 0,s);else{e=(new Date).getTime(),c.endProbe("viewpoint"),this.lastDeltaTime=e-this.startLoadTime;var a=this.createViewpointData(this.viewer.currentViewpoint);this.updateCandidateQueueRenderer(!0,a),this.viewer.setRenderIteration(!0),this.forceSceneMin?this.viewer.render():this.queues[0].nbLoaded>0&&(this.viewer._forceSceneMin(null),this.viewer.render({updateInfinitePlane:!0})),m.onEndLoading(),this.onEndLoadingCB&&this.onEndLoadingCB.call(void 0,s)}this.previousIsLoading=i}},L.prototype.addLoadedNode=function(e){e.isUnloadable()||console.log("inconsistency"),e.getLDHNodeManagerQueue(this).addToLoadedNodesQueue(e)},L.prototype.updateLoadedNodes=function(e,t){this.unloadManager.beforeLoadedNodesQueueTraversal(),this.queues[0].updateLoadedNodes(e,t),this.unloadManager.afterLoadedNodesQueueTraversal()},L.prototype.onReferenceUnloaded=function(){this.queues[0].onReferenceUnloaded()},L.prototype.unloadNode=function(e,t,n){if(e.isUnloadLocked()||!e.isUnloadable(!0))return!1;if(0===e.handler.type){if(!(e.isToUnload()||n&&e.isLoaded()))return!1}else if(e.isRoot||e.children.length>0)return!1;(this.newLoadingBoxes&&e.removeBox(this),e.removeFromSceneGraph(!1,this),e.recursiveUpdateMemorySize(this),e.isInList())&&e.getLDHNodeManagerQueue(this).onNodeToRemoveFromList();var o,r=e.parents;for(e.isSlave()||e.hasUnloadFrozenParent()?e.setStatus(i.waiting,this):(e.removeFromParents(this.oocManager),e.unregister(this.oocManager)),o=0;o<r.length;o++)this.unloadNode(r[o],t);return!0},L.prototype.setOnStartLoadingCB=function(e){this.onStartLoadingCB=e},L.prototype.setOnEndLoadingCB=function(e){this.onEndLoadingCB=e},L.prototype.onInstRefGraphTransactionEnd=function(e){var t,n;for(t=0;t<e.length;t++)(n=e[t]).isAlive()&&n.setStatus(i.loaded,this);for(t=0;t<e.length;t++)(n=e[t]).isAlive()&&0===n.handler.type&&(n.updateMemorySizeNEW(this),n._onLoaded(),n.isUnloadable()&&this.addLoadedNode(n));if(this.instRefTransactionCPUMemoryFullOccurred&&e.length&&!e[0].isLeaf()){var o=new Set;this.oocManager.getRootOccurrences().forEach(function(e,t,n){e.occurrence.reference.traverse(function(e){e.isLeaf()||0!==e.children.length||o.add(e)})});var r=this;o.forEach(function(e){r.unloadNode(e)})}this.tryBuildSceneGraphHierarchy(!1,this)},L.prototype.fillDebugJSON=function(e){return e.references={Model3DHandler:[],InstRefHandler:[]},this.queues[0].fillDebugArray(e.references.Model3DHandler),e},L.prototype.setPauseLoading=function(e,t){t=t||"default",this.pauseLoadingMap.set(t,e)},L.prototype.getPauseLoading=function(){var e=!1;return this.pauseLoadingMap.forEach(function(t,n,i){t&&(e=!0)}),e},L.prototype.registerOverrideSet=function(e){this.overrideSetManager||(this.overrideSetManager=this.viewer.getSceneGraphOverrideSetManager()),this.overrideSetMap[e]||(this.overrideSetMap[e]=new a(this.targetNode,void 0,!0),this.overrideSetManager.pushSceneGraphOverrideSet(this.overrideSetMap[e]))},L.prototype.removeOverrideSet=function(e){var t=this.overrideSetMap[e];t&&(this.overrideSetManager.removeSceneGraphOverrideSet(t),delete this.overrideSetMap[e])},L.prototype.getOverrideSet=function(e){return this.overrideSetMap[e]},L.prototype.getOverrideSetManager=function(){return this.overrideSetManager},L.prototype.addUserQueue=function(e){var t;for(t=0;t<this.userQueues.length;t++)if(this.userQueues[t].handler===e)throw new Error("duplicate handler");var n,i=e.getParams?e.getParams():{},o=(void 0===i.addLeaves||i.addLeaves,void 0!==i.addIntermediateNodes&&i.addIntermediateNodes),r=new d(e,this),s=new Set,a=this.queues[0];for(t=0;t<a.nodes.length;t++)(n=a.nodes[t])&&(o?s.has(n)||n.traverseParents(function(e){s.add(e),r.addNode(e)},s):r.addNode(n));var h=this.createViewpointData(this.viewer.currentViewpoint);r.computeOrder(h),this.requestUpdate(!1,!1),this.userQueues.push(r)},L.prototype.removeUserQueue=function(e){var t;for(t=this.userQueues.length-1;t>=0;t--)this.userQueues[t].handler===e&&this.userQueues.splice(t,1)},L.prototype.setCandidateQueueRendererParams=function(e,t){if(!this.newLoadingBoxes&&this.queueRenderer&&this.oocManager.isSlave()&&this.queueRenderer.removeSlaveBoxes(),e){var n=this.createViewpointData(this.viewer.currentViewpoint),i=this.queueRenderer;i||(i=this.newLoadingBoxes?new l(this.oocManager,this.queues[0]):new h(this,t.rootNode),this.queueRenderer=i,void 0!==t.pickable&&this.queueRenderer.setPickable(t.pickable,!this.newLoadingBoxes,n)),this.newLoadingBoxes||void 0===t.preserveSelection||(this.queueRenderer.preserveSelection=t.preserveSelection),i.setParams(t),this.newLoadingBoxes&&i.removeBoxes(),this.newLoadingBoxes&&i.updateLoadingBoxes(),!this.newLoadingBoxes&&this.oocManager.isSlave()&&i.displaySlaveBoxes(n)}else this.queueRenderer&&(this.queueRenderer.dispose(),this.queueRenderer=null,this.viewer.render({budgeted:!0}));this.requestUpdate(!1,!1)},L.prototype.getCandidateRoots=function(){var e=this.oocManager.getRootOccurrences(),t=[];return e.forEach(function(e,n,i){var o=e.occurrence.reference;0===o.children.length&&t.push(o)}),t},L.prototype.updateCandidateQueueRenderer=function(e,t){var n=this.queueRenderer,i=this.viewer.currentViewpoint.camera.position;if(n){var o=Date.now();(o-this.lastQueueRendererUpdateTime>500||e)&&(this.lastQueueRendererUpdateTime=o,this.newLoadingBoxes?n.updateLoadingBoxes():n.updateRepresentation(i,t),this.viewer.render({budgeted:!0}))}},L.prototype.emergencyUnloadNodes=function(e){var t=this.unloadManager.isEmergencyUnloadRequiredCPU(),n=this.unloadManager.isEmergencyUnloadRequiredGPU();(t||n)&&(this.emergencyUnloadOccured=!0,n&&this.queues[0].doEmergencyUnload(e))},L.prototype.forceUnloadSmallNodes=function(e,t,n){this.queues[n].unloadSmallNodes(e,t,n)},L.prototype.setBoundingSphere=function(e){this.boundingSphere=e,e?this.bsNode.forceBoundingElements(!0,{sphere:e.clone()}):this.bsNode.forceBoundingElements(!1),this.viewer.render()},L.prototype.onAddRoot=function(){this.rootAdded=!0,this.requestUpdate(!1,!1),this.updateLoadingStatus(),this.forceFullVP()},L.prototype.incFullVPLoading=function(){this.fullVPLoading++},L.prototype.decFullVPLoading=function(){this.fullVPLoading--};var R=-1;return L.prototype.getGlobalMeshInRAM=function(e,t){if(this.globalMeshInRAMCounter>0)return!0;if(e&&(this.unloadManager.autoMeshInRAM&&(-1===R&&(R=window.OOCEnableAutoMeshInRAM?1:0),t=t||e.getActiveRepresentation())))return 1===R||t.isAV1();return this.unloadManager.meshInRAM||this.unloadManager.autoMeshInRAM},L.prototype.lockGlobalMeshInRAM=function(){this.globalMeshInRAMCounter++,this.needGlobalSwitchNoMeshInRAM=!1,1===this.globalMeshInRAMCounter&&this.globalMeshInRAMSwitch(!0)},L.prototype.unlockGlobalMeshInRAM=function(){this.globalMeshInRAMCounter>0&&this.globalMeshInRAMCounter--,0===this.globalMeshInRAMCounter&&(this.needGlobalSwitchNoMeshInRAM=!0)},L.prototype.clearMeshInRAMForLoadingReferences=function(){var e,t=this.oocManager,n=this,i=[];for(this.loadingReferencesToSwitchToNoMeshInRAM.forEach(function(e){var o=t._getLDHReference(e,!0);o&&!o.isLoading()&&(t.isMeshInRAMRequested(e)||o.switchMeshInRAM(!1,n),i.push(e)),o||i.push(e)}),e=0;e<i.length;e++)this.loadingReferencesToSwitchToNoMeshInRAM.delete(i[e])},L.prototype.globalMeshInRAMSwitch=function(e){var t=this,n=this.oocManager;n._referenceTos.forEach(function(i,o){var r=i.reference;r.isLeaf()&&(!e&&r.isLoading()?t.loadingReferencesToSwitchToNoMeshInRAM.add(r.referenceId):e?r.switchMeshInRAM(!0,t):n._lockMeshInRAMTos.has(o)||r.switchMeshInRAM(!1,t))}),e||(this.switchNoMeshInRAMReferences=new Set,this.unloadManager.restoreMemoryFromMeshInRAM())},L.prototype.checkAutoMeshInRAM=function(){this.unloadManager.autoMeshInRAMChange&&(this.unloadManager.autoMeshInRAMChange=!1,0===this.globalMeshInRAMCounter&&this.globalMeshInRAMSwitch(this.unloadManager.autoMeshInRAMChange))},L.prototype.dispose=function(){this.viewer.currentViewpoint.unsubscribe(this.onViewpointMoveToken),this.onViewpointMoveToken=null},L.prototype.getServiceUrl=function(e){return this.getServiceUrlCB(e)},L}),define("DS/3DXMTiles/OOCManager",["DS/3DXMTiles/LDHNodeManager","DS/3DXMTiles/OOCManagerEntry","DS/3DXMTiles/LDHOccurrence","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/UnloadManager","DS/3DXMTiles/OOCReferenceIterator","DS/3DXMTiles/OOCManagerRootEntry","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/VisuTools/FPSCounter","DS/Mesh/MeshUtils","DS/Visualization/IdPathMatcher","DS/3DXMTiles/LDHReference","DS/Visualization/Node3D","DS/Visualization/PLMMaterialConnectionFactory","DS/3DXMTiles/LDHReferenceRep","DS/Visualization/IdPath","DS/3DXMTiles/LDHSwitchRepresentationData","DS/3DXMTiles/AsyncCaller","DS/3DXMTiles/DSTilesNode","DS/3DXMTiles/DSTilesScreenRadiusScoreComputer","DS/3DXMTiles/DSTilesDistanceScoreComputer","DS/3DXMTiles/DSTilesStdExpander","DS/3DXMTiles/OOCTileSetHandler","DS/3DXMTiles/Debug3DXMTiles","DS/CoreEvents/Events","DS/SceneGraphOverrides/SceneGraphOverrideSetManager"],function(e,t,n,i,o,r,s,a,d,h,l,c,u,p,f,g,m,y,v,M,S,L,D,T,R,x,C,w,b){"use strict";var N=1,_=function(t,n){n=n||{},function(){var e=window.localStorage.getItem("OOCDebug");if(e){var t,n=JSON.parse(e);for(t in n)window[t]=n[t]}}(),this._config=n.config||"v0";var i=n.meshInRAM?n.meshInRAM:"on";this._ldhNodeManager=new e({viewer:t,oocManager:this,config:this._config,enableOcclusionTest:n.enableOcclusionTest,fullVP:!!n.fullVP,meshInRAM:i,newLoadingBoxes:n.newLoadingBoxes,maxNbBoxes:n.maxNbBoxes,forceSceneMin:!!n.forceSceneMin,getServiceUrlCB:n.getServiceUrlCB||null,progressiveExpand:!!n.progressiveExpand}),t._setOOCManager(this);var o=void 0===n.fullOOC||!!n.fullOOC;this.disableSlaveBoxFix=!1===n.solution3BoxFix,this._ldhNodeManager.unloadManager.setFlashMode(!0),void 0!==n.unloadSmallNodes&&this._ldhNodeManager.setUnloadSmallNodesEnabled(!!n.unloadSmallNodes),this._referenceTos=new Map,this._instanceTos=new Map,this._rootOccurrenceTos=new Map,this._externalNodeIdToNode=new Map,this._externalNodeToNodeId=new Map,this._lockMeshInRAMTos=new Map,this._onCycleDetectedCB=null,this._cycleDetected=!1,this._instRefGraphTransaction=null,this._mode=o?_.Mode.ooc:_.Mode.slave,o&&this._initIdPathMatcher(),this._defaultLoadModelOptions=null,this._initialMeshInRAM=i,this._overrideSetMap=new Map,this._usePickingAccelerationStructure=!1,this._boxes=new Map,this._overrideSetManagerMap=null,this._unitValue=this._computeUnitValue(n.unit),this._handlers={repRef:null,ref:null,tileSet:null}};function I(e){var t,n,i=[];for(t=0;t<e.externalPath.length;t++)(n=e.externalPath[t].getModelIdentification())&&i.push(n);return i}function B(e){var t,n,i=e.getLastElement(!0),o=[];for(t=0;t<i.children.length;t++)"OOC##Box"===(n=i.children[t]).name&&o.push(n.getModelIdentification());return o}_.prototype.setTargetNode=function(e){e.setRenderPasses(["main","ooc"]),this._ldhNodeManager.setTargetNode(e)},_.prototype.setDefaultLoadModelOptions=function(e){this._defaultLoadModelOptions=e},_.prototype.getDefaultLoadModelOptions=function(){return this._defaultLoadModelOptions},_.prototype.registerReference=function(e,n){if(this._mode===_.Mode.slave)throw new Error("Cannot mix slave and OOC");var i=this._getOOCEntry(e,!0);if(!i){var o=n.handler||this._handlers[n.handlerType]||null;i=new t(e,{manager:this,handler:o.ldhHandler,boundingSphere:n.boundingSphere||null,boundingBox:n.boundingBox||null,loadModelOptions:n.loadModelOptions}),this._referenceTos.set(e,i),this._handleNewReference(i.reference,n),this._ldhNodeManager.onSceneChange()}},_.prototype.setOverrideCB=function(e,t,n){void 0===n&&(console.warn("Calling setOverrideCB(...) without 3rd argument is deprecated"),n="#undefined#",this.registerOverrideSet(n));var i=this._overrideSetMap.get(n);i&&(this._getLDHReference(e).setOverrideCB(n,t,this._ldhNodeManager),i.add(e))},_.prototype.hasOverrideCB=function(e,t){return!!this._overrideSetMap.get(t)&&!!this._getLDHReference(e).hasOverrideCB(t)},_.prototype.registerOverrideSet=function(e){"#undefined#"!==e&&(this._ldhNodeManager.registerOverrideSet(e),this._overrideSetMap.has(e)||this._overrideSetMap.set(e,new Set))},_.prototype.clearOverrideSet=function(e){if("#undefined#"!==e){var t=this._overrideSetMap.get(e),n=this;t&&t.forEach(function(t){var i=n._getLDHReference(t,!0);i&&i.setOverrideCB(e,null,n._ldhNodeManager)})}},_.prototype.removeOverrideSet=function(e){"#undefined#"!==e&&(this.clearOverrideSet(e),this._ldhNodeManager.removeOverrideSet(e),this._overrideSetMap.delete(e))},_.prototype.registerLeafReference=function(e,n){if(this._mode===_.Mode.ooc)throw new Error("Cannot mix slave and OOC");f.slaveBoxFix=!this.disableSlaveBoxFix;var i=this._getOOCEntry(e,!0);if(!i){var o=n.node.getModelIdentification();if(o&&this.isRegistered(o))throw new Error("illegal node: used for another OOC reference");i=new t(e,{manager:this,handler:n.handler.ldhHandler,boundingSphere:n.boundingSphere||null,boundingBox:n.boundingBox||null,leaf:!0,loadModelOptions:n.loadModelOptions}),this._referenceTos.set(e,i),n.node.setRenderPasses(["main","ooc"]),this._handleNewReference(i.reference,n),i.reference.updateBoundingElementImpostor(),this._ldhNodeManager.onSceneChange()}},_.prototype._handleNewReference=function(e,t){var n=new y({src:t.url||t.tileSet||t.src,noMeshInRAM:t.meshInRAM,active:!0,type:t.type||_.RepType.none,wms:t.wms});t.node&&(n.node=t.node);var i=e.referenceId,o=this._isMeshInRAMRequested(i,n);e.switchRepresentation(n,o,this._ldhNodeManager);var r=this._ldhNodeManager.switchRepresentationBuffer.get(i);r&&(r.rep.copyMissingParams(n),this._ldhNodeManager.switchRepresentationBuffer.delete(i),e.switchRepresentation(r.rep,o,this._ldhNodeManager,r.onSwitchRepCBArray)),this._ldhNodeManager.registerTilesNode(e)},_.prototype.switchRepresentation=function(e,t,n){var i=new y({url:t.url,type:t.type||_.RepType.none,wms:t.wms});if(i.url){var o=this._getLDHReference(e,!0),r=null;if(o&&!o.isLoading())return!o.isForced()&&o.isToUnload()||(r=n?[n]:null),o.switchRepresentation(i,this._isMeshInRAMRequested(e,i),this._ldhNodeManager,r,!0),this._ldhNodeManager.onSceneChange(),!r&&n&&S.call(n),!0;var s=this._ldhNodeManager.switchRepresentationBuffer.get(e);return s?(i.copyMissingParams(s.rep),s.setRep(i)):(s=new M(i),this._ldhNodeManager.switchRepresentationBuffer.set(e,s)),n&&(o?s.addOnSwitchRepCB(n):S.call(n)),!1}setTimeout(n)},_.prototype.lockGlobalMeshInRAM=function(){this._ldhNodeManager.lockGlobalMeshInRAM()},_.prototype.unlockGlobalMeshInRAM=function(){this._ldhNodeManager.unlockGlobalMeshInRAM(),this._ldhNodeManager.requestUpdate(!1,!1)},_.prototype.lockReferenceMeshInRAM=function(e){if(this._lockMeshInRAMTos.has(e)){var t=this._lockMeshInRAMTos.get(e);t++,this._lockMeshInRAMTos.set(e,t)}else{this._lockMeshInRAMTos.set(e,1);var n=this._getLDHReference(e,!0);n&&n.switchMeshInRAM(!0,this._ldhNodeManager)}this._ldhNodeManager.switchNoMeshInRAMReferences.delete(e)},_.prototype.unlockReferenceMeshInRAM=function(e,t){if(this._lockMeshInRAMTos.has(e)){var n=this._lockMeshInRAMTos.get(e);if(0===--n||t){this._lockMeshInRAMTos.delete(e);var i=this._getLDHReference(e,!0);this._ldhNodeManager.getGlobalMeshInRAM(i)||this._ldhNodeManager.switchNoMeshInRAMReferences.add(e)}else this._lockMeshInRAMTos.set(e,n)}this._ldhNodeManager.requestUpdate(!1,!1)},_.prototype.isRepresentationUpToDate=function(e){var t=this._getLDHReference(e,!0),n=t&&t.getPrimaryRepresentation();return!(!n||!n.active)},_.prototype.getRepresentation=function(e){var t=this._getLDHReference(e,!0),n=t&&t.getActiveRepresentation();return n&&n.getJSON()},_.prototype.unregisterLeafReference=function(e){var t=this._getOOCEntry(e).reference;t.isSlave()&&(t.getLDHNodeManagerQueue(this._ldhNodeManager).onNodeToRemoveFromList(),this._ldhNodeManager.unloadLeafReferenceCB&&this._ldhNodeManager.unloadLeafReferenceCB(e),t._rep.node=null,this._unregisterReference(e))},_.prototype.setUnloadLeafReferenceCB=function(e){this._ldhNodeManager.unloadLeafReferenceCB=e},_.prototype.setOnLeafReferenceLoadedCB=function(e){this._ldhNodeManager.onLeafReferenceLoadedCB=e},_.prototype.setOnSwitchRepCB=function(e){this._ldhNodeManager.onSwitchRepCB=e},_.prototype.setOnCycleDetectedCB=function(e){this._onCycleDetectedCB=e},_.prototype.isRegistered=function(e,t){var n=null!==this._getOOCEntry(e,!0),i=!!this._instanceTos.get(e);return n||!t&&i},_.prototype.isPLMReference=function(e){return null!==this._getOOCEntry(e,!0)},_.prototype.isPLMInstance=function(e){return!!this._instanceTos.get(e)},_.prototype.addRoot=function(e,t){if(this._mode===_.Mode.slave)throw new Error("Cannot mix slave and OOC");this._rootOccurrenceTos.forEach(function(t,n,i){if(t.occurrence.reference.referenceId===e)throw new Error("Multiple occurrences for root are unsupported")});var i=this._getLDHReference(e),o=new Set,r=new n({reference:i,manager:this._ldhNodeManager,instanceData:f.createChildData(i,t.matrix||null,t.instanceId)},o),a=this._ldhNodeManager;r.updateMatrix(a),o.forEach(function(e){e.updateOverride(a)});var d=N,h=new s(r,t.boundingBox,d,t.onLoadedCB);return h.elasticLoading=!!t.elasticLoading,this._rootOccurrenceTos.set(d,h),N++,this._updateSceneMin(),i.setIsRoot(!0,this._ldhNodeManager),this._updateBoundingSphere(),this._ldhNodeManager.onAddRoot(),d},_.prototype.getReframeBoundingSphere=function(){var e=this.getRootOccurrences(),t=new l.Sphere;return e.forEach(function(e,n,i){var o=e.occurrence,r=o.reference.getBoundingSphere(!0).clone();r.applyMatrix4(o.matrix);var s=t.clone();r.mergeWithSphere(t,s),t=s}),t},_.prototype.removeRoot=function(e){var t=this._rootOccurrenceTos.get(e),n=t&&t.occurrence,i=n.reference;if(this._rootOccurrenceTos.delete(e),i.setIsRoot(!1,this._ldhNodeManager),i._occurrences.length>1){var o=new Set;n.detach(o),o.forEach(function(e){e._removeNullsFromOccurrenceList()})}else this.removeReferenceTree(i.referenceId);this._ldhNodeManager.getTileSets(i)&&this._ldhNodeManager.removeTileSets(i),this._ldhNodeManager.removeRemovedNodes(),this._ldhNodeManager.requestUpdate(!0,!0),this._updateSceneMin();var r=this;this._overrideSetMap.forEach(function(e,t,n){var i,o=[];for(e.forEach(function(e){r._getLDHReference(e,!0)||o.push(e)}),i=0;i<o.length;i++)e.delete(o[i])}),this._updateBoundingSphere(),0===this._rootOccurrenceTos.size&&"auto"===this._initialMeshInRAM&&this._ldhNodeManager.unloadManager.restoreAutoMeshInRAM()},_.prototype.isRootAlive=function(e){return!!this._rootOccurrenceTos.get(e)},_.prototype.setRootEnabled=function(e,t){var n=this._rootOccurrenceTos.get(e);n?(t=!!t,n.enableExpand!==t&&(n.enableExpand=t,t&&this._ldhNodeManager.forceFullVP())):console.warn("Unknown rootId: '"+e+"'")},_.prototype.freezeRoot=function(e){this._rootOccurrenceTos.get(e).occurrence.reference.freezeUnload(),this.setRootEnabled(e,!1)},_.prototype.declareTreeModified=function(e){var t=this._rootOccurrenceTos.get(e);t&&(t.treeModified=!0,this._ldhNodeManager.forceFullVP())},_.prototype.isRepRef=function(e){var t=this._getLDHReference(e,!0);return!!t&&t.isLeaf()},_.prototype.createReferenceIterator=function(e){var t=this._getLDHReference(e,!0);return t&&new r(t)},_.prototype.notifyRootVisibilityChange=function(e,t){var n=this._rootOccurrenceTos.get(e);n&&(n.visible=!!t,this._updateBoundingSphere())},_.prototype.isCPUMemoryFull=function(){if(this._cycleDetected)return!0;var e=!this._ldhNodeManager.unloadManager.isLoadingAllowed(1);if(e&&this._instRefGraphTransaction){if(!this._instRefGraphTransaction.unloadTried){this._instRefGraphTransaction.unloadTried=!0;var t=this._ldhNodeManager.createViewpointData(this._ldhNodeManager.viewer.currentViewpoint);this._ldhNodeManager.updateLoadedNodes(!0,t),e=!this._ldhNodeManager.unloadManager.isLoadingAllowed(1)}e&&this._instRefGraphTransaction.onCPUMemoryFull(this)}return e},_.prototype._unregisterReference=function(e){var t=this._getLDHReference(e,!0);t&&(t.children.length>0&&console.log("_unregisterReference internal error"),t&&(t.setStatus(i.dead,this._ldhNodeManager),this._ldhNodeManager.unregisterNode(t),t.updateMemorySizeNEW(this._ldhNodeManager)),this._referenceTos.delete(e))},_.prototype._unregisterInstance=function(e){this._instanceTos.delete(e)},_.prototype.addChild=function(e,t,n){var i=this._getLDHReference(e,!0);if(i){var o=this._getLDHReference(t),r=n.instanceId,s=new Set,a=!1;this._instanceTos.get(r)||(i.addReferenceChild(o,n.matrix||null,r,s,this._ldhNodeManager)||(a=!0),r&&this._instanceTos.set(r,i)),a&&(this._cycleDetected=!0,this._onCycleDetectedCB&&this._onCycleDetectedCB()),null!==this._instRefGraphTransaction&&this._instRefGraphTransaction.onAddChild(i),this._ldhNodeManager.tryBuildSceneGraphHierarchy();var d=this._ldhNodeManager;s.forEach(function(e){e.updateOverride(d)}),i.isUnloadFrozen()&&o.freezeUnload(),this._ldhNodeManager.onSceneChange()}},_.prototype.createNodeIdOverrideSetManager=function(e){this._overrideSetManagerMap||(this._overrideSetManagerMap=new Map);var t=this._overrideSetManagerMap.get(e);if(!t){var n=this._ldhNodeManager.viewer.getIdPathMatcher().idToNode(e);n?((t=n.createOverrideSetManager()).nodeId=e,t._idPathOverrideWatcher=this._ldhNodeManager.viewer._getIdPathOverrideWatcher()):t=new b({active:!1,nodeId:e,idPathOverrideWatcher:this._ldhNodeManager.viewer._getIdPathOverrideWatcher()}),this._overrideSetManagerMap.set(e,t)}return t},_.prototype.removeNodeIdOverrideSetManager=function(e){this._overrideSetManagerMap||(this._overrideSetManagerMap=new Map),this._overrideSetManagerMap.has(e.nodeId)&&(this._overrideSetManagerMap.delete(e.nodeId),e._removeNodeId())},_.prototype.getOccurrencesMatrices=function(e){var t=this._getLDHReference(e,!0);if(t){var n,i,o=t.getAllMatrices(),r=[];for(i=0;i<o.length;i++)(n=o[i])&&r.push(n.clone());return r}return null},_.prototype._onRepLoaded=function(e){null!==this._instRefGraphTransaction&&this._instRefGraphTransaction.onAddChild(e)},_.prototype.getReferenceUrl=function(e){return this._getLDHReference(e)._rep.url},_.prototype.getReferenceBoundingSphere=function(e){var t=this._getLDHReference(e);return t.updateBoundingSphere(),t._boundingSphere&&t._boundingSphere.clone()},_.prototype.getReferenceBoundingBox=function(e){var t=this._getLDHReference(e).getBoundingBox();return t&&t.clone()},_.prototype._getOOCEntry=function(e,t){var n=this._referenceTos.get(e);if(!t&&!n)throw new Error("Unknown OOC referenceId: '"+e+"'");return n||null},_.prototype._getLDHReference=function(e,t){var n=this._getOOCEntry(e,t);return n?n.reference:null},_.prototype.getSceneGraphNode=function(e){var t,n=this._getLDHReference(e,!0);if(n)return n._rep.node;if(n=this._instanceTos.get(e))for(t=0;t<n.children.length;t++){var i=n.children[t];if(i.instanceId===e)return i.node}return null},_.prototype.forceReferenceLoad=function(e,t){this.setForceReferenceLoad(e,!0,t)},_.prototype.setForceReferenceLoad=function(e,t,n){var i=this,o=i._getLDHReference(e,!0);o&&!o.isError()?this._ldhNodeManager.executeReferenceAction([o],function(e){var o,r;for(o=0;o<e.length;o++)(r=e[o]).forceLoad(!!t,n,i._ldhNodeManager),i._ldhNodeManager.forceUpdateNode(r);i._ldhNodeManager.requestUpdate(!0,!0)}):setTimeout(n,0)},_.prototype.setUserData=function(e,t){var n,i,o=!1,r=this._getLDHReference(e,!0);if(r)r.userData=t,o=!0,(n=r.getNode())&&n.setUserData(t);else if(r=this._instanceTos.get(e))for(i=0;i<r.children.length;i++){var s=r.children[i];s.instanceId===e&&(s.userData=t,o=!0,s.node&&s.node.setUserData(t))}if(!o)throw new Error("unknown id")},_.prototype.getUserData=function(e){var t,n=this._getLDHReference(e,!0);if(n)return n.userData;if(n=this._instanceTos.get(e))for(t=0;t<n.children.length;t++){var i=n.children[t];if(i.instanceId===e)return i.userData}throw new Error("unknown id")},_.prototype.setOnStartLoadingCB=function(e){this._ldhNodeManager.setOnStartLoadingCB(e)},_.prototype.setOnEndLoadingCB=function(e){this._ldhNodeManager.setOnEndLoadingCB(e)},_.prototype.setOnAddedToSceneGraphCB=function(e,t){this._getLDHReference(e).setOnAddedToSceneGraphCB(t)},_.prototype.setOnRemovedFromSceneGraphCB=function(e,t){this._getLDHReference(e).setOnRemovedFromSceneGraphCB(t)},_.prototype.getAllReferences=function(){var e=[];return this._referenceTos.forEach(function(t,n,i){e.push(n)}),e},_.prototype.switchLOD=function(e,t,n,o,r){var s=this._getLDHReference(e),a=this._ldhNodeManager;this._ldhNodeManager.executeReferenceAction([s],function(e,s){var d,h,l=0;function c(){for(d=0;d<e.length;d++){e[d].userUnlockUnload()}0===--l&&n&&(n(),n=null)}for(d=0;d<e.length;d++){var u;(u=e[d]).isToUnload()||u.isWaiting()||(u.userLockUnload(),l++,u.addOnLoadedCB(c)),(h=u.getActiveRepresentation())&&(h.setUrlAndType(t,o||_.RepType.none),h.setWMS(r)),u.removeFromSceneGraph(!0,a),u.setStatus(i.waiting,a),a.registerTilesNode(u)}0===l&&setTimeout(n,1),s()}),this._ldhNodeManager.onSceneChange()},_.prototype.getNbChildren=function(e){return this._getLDHReference(e).children.length},_.prototype.isReferenceComplete=function(e){return this.isReferenceLoaded(e)},_.prototype.isReferenceLoaded=function(e){var t=this._getLDHReference(e,!0);return null!==t&&(t.isLoaded()||t.isToUnload())},_.prototype.dumpAllMemorySize=function(e){this._referenceTos.forEach(function(t,n,i){var o=t.reference;e&&o.updateMemorySize(),console.log(n+" "+o.memorySize)}),console.log("TOTAL "+this._ldhNodeManager.unloadManager.memoryUsage)},_.prototype.startInstRefGraphTransaction=function(){this._instRefGraphTransaction&&console.log("ERROR - A transaction already exists"),this._instRefGraphTransaction=new O,this._ldhNodeManager.instRefTransactionCPUMemoryFullOccurred=!1},_.prototype.endInstRefGraphTransaction=function(){this._instRefGraphTransaction.endTransaction(this),this._instRefGraphTransaction=null},_.prototype.addSceneGraphLock=function(e){var t=this._getLDHReference(e,!0);return!!t&&(t.requestBuildSceneGraphHierarchy(!0),t.userLockUnload(),this._ldhNodeManager.tryBuildSceneGraphHierarchy(),!0)},_.prototype.removeSceneGraphLock=function(e){var t=this._getLDHReference(e,!0);return!!t&&(t.userUnlockUnload(),!0)},_.prototype.isSceneGraphLocked=function(e){return this.getSceneGraphLockCounter(e)>0},_.prototype.getSceneGraphLockCounter=function(e){var t=this._getLDHReference(e,!1);return t._optional?t._optional.userLockUnload:0},_.prototype.getRootOccurrences=function(){return this._rootOccurrenceTos},_.prototype.getRoots=function(){var e=[];return this._rootOccurrenceTos.forEach(t=>{var n=t.occurrence.reference.referenceId;e.indexOf(n)<0&&e.push(n)}),e},_.prototype.getIdPathesLeadingToReference=function(e){var t=null,n=this._getLDHReference(e,!0);if(n){t=[];var i,o,r=n.getLDHOccurrences();for(i=0;i<r.length;i++)o=r[i].getIdPath(),t.push(new v(o))}return t},_.prototype.setDisableFullVP=function(e){!e&&this._ldhNodeManager.disableFullVP&&this._ldhNodeManager.forceFullVP(),this._ldhNodeManager.disableFullVP=e},_.prototype.setFullVPScreenRadius=function(e){this._ldhNodeManager.fullVPScreenRadius=e},_.prototype._getDebugJSON=function(){var e={references:{},roots:[]};return this._referenceTos.forEach(function(t,n,i){e.references[n]=t.reference.buildDebugJSON(!0,!0)}),this._rootOccurrenceTos.forEach(function(t,n,i){var o=t.occurrence;e.roots.push(o.reference.referenceId)}),e},_.prototype._getReferenceDebugJSON=function(e){var t=this._getLDHReference(e,!0);return t?t.buildDebugJSON():null},_.prototype._getAllInstancesDebugJSON=function(){var e={};return this._instanceTos.forEach(function(t,n,i){var o,r;for(o=0;o<t.children.length;o++)(r=t.children[o]).instanceId===n&&(e[n]={parent:t.referenceId,child:r.reference.referenceId})}),e},_.prototype._getSingleInstanceDebugJSON=function(e){var t,n,i=this._instanceTos.get(e);if(i)for(t=0;t<i.children.length;t++)if((n=i.children[t]).instanceId===e)return{instanceId:e,parent:i.referenceId,child:n.reference.referenceId};return null},_.prototype.setPauseLoading=function(e,t){var n=this._ldhNodeManager.getPauseLoading();this._ldhNodeManager.setPauseLoading(!!e,t),n&&!this._ldhNodeManager.getPauseLoading()&&(this._ldhNodeManager.forceFullVP(),this._ldhNodeManager.requestUpdate(!0,!0))},_.prototype.forceRefresh=function(){this._ldhNodeManager.forceFullVP(),this._ldhNodeManager.requestUpdate(!0,!0)},_.prototype.setReferenceLoadModelOptions=function(e,t){this._getLDHReference(e).setLoadModelOptions(t)},_.prototype.getReferenceLoadModelOptions=function(e){this._getLDHReference(e).setLoadModelOptions(loadModelOptions)},_.prototype.getReferenceLoadModelOptions=function(e){var t=this._getLDHReference(e);return t._optional&&t._optional.loadModelOptions},_.prototype.setPerformancesOptions=function(e){e.fullAlwaysUnload&&this._ldhNodeManager.unloadManager.setUnloadAlwaysTab([!0,!0]),e.repAlwaysUnload&&this._ldhNodeManager.unloadManager.setUnloadAlwaysTab([!0,!1]),e.noAlwaysUnload&&this._ldhNodeManager.unloadManager.setUnloadAlwaysTab([!1,!1]),void 0!==e.pauseLoadingDuringViewpointMove&&this._ldhNodeManager.setPauseLoadingDuringViewpointMove(!!e.pauseLoadingDuringViewpointMove)},_.prototype.getWorldMatrix=function(e,t){var n,i,o=this._rootOccurrenceTos.get(e).occurrence;o.reference;for(n=1;n<t.length;n+=2){i=o.getChildren();var r,s=!1;for(r=0;r<i.length;r++)i[r].instanceData.instanceId===t[n]&&(o=i[r],s=!0);if(!s)throw new Error("inconsistent path")}return o.matrix.clone()},_.prototype.addUserQueue=function(e){this._ldhNodeManager.addUserQueue(e)},_.prototype.removeUserQueue=function(e){this._ldhNodeManager.removeUserQueue(e)},_.prototype.setCandidateQueueRendererParams=function(e,t){this._ldhNodeManager.setCandidateQueueRendererParams(e,t)},_.prototype.setExpandAllowed=function(e,t){},_.prototype._updateSceneMin=function(){var e=0,t=!1;(this._rootOccurrenceTos.forEach(function(n,i,o){if(n.boundingBox){var r=n.computeSceneMin();(!t||r<e)&&(e=r,t=!0)}}),t)&&this._ldhNodeManager.viewer.forceSceneMin(e)},_.prototype.getSelectedPath=function(e){var t,n,i={hso:a,pso:d,cso:h}[e=e||"hso"].get(),o=[],r=[];for(t=0;t<i.length;t++)o=void 0!==(n=i[t].pathElement).instanceId&&this._ldhNodeManager.queueRenderer?this._ldhNodeManager.queueRenderer.getPathFromPathElement(n):I(n),r.push(o);return r&&1===r.length?r[0]:r},_.prototype.getSelectedReference=function(e){var t,n,i,o,r={hso:a,pso:d,cso:h}[e=e||"hso"].get(),s=[];for(t=0;t<r.length;t++)void 0!==(n=r[t].pathElement).instanceId&&this._ldhNodeManager.queueRenderer?o=this._ldhNodeManager.queueRenderer.getReferenceFromPathElement(n):(o=(i=this._mode===_.Mode.slave?B(n):I(n))[i.length-1],this.isRegistered(o,!0)||(o=null)),s.push(o);return s&&1===s.length?s[0]:s},_.prototype.registerExternalSceneGraphNode=function(e,t){if(null===t){var n=this._externalNodeIdToNode.get(e);this._externalNodeIdToNode.delete(e),this._externalNodeToNodeId.delete(n)}else this._externalNodeToNodeId.set(t,e),this._externalNodeIdToNode.set(e,t)},_.prototype.setLoadingBoxesPickable=function(e){if(this._ldhNodeManager.queueRenderer){var t=this._ldhNodeManager.createViewpointData(this._ldhNodeManager.viewer.currentViewpoint);this._ldhNodeManager.queueRenderer.setPickable(e,!1,t)}},_.prototype.showPerfos=function(){c.setAutoRefresh(!1),this._ldhNodeManager.viewer.showPerfo(!0,!1)},_.prototype._updateBoundingSphere=function(){var e=null;this._rootOccurrenceTos.forEach(function(t,n,i){var o=t.occurrence,r=null;t.visible&&o.reference.hasRootBoundingElement()&&(r=o.getBoundingSphere()),r&&(e?e.clone().mergeWithSphere(r,e):e=r.clone())});var t=this._ldhNodeManager.targetNode;if(e&&t&&1===t._occurrences.length){var n=t._occurrences[0].matrix;n&&!n.isIdentity()&&e.applyMatrix4(n)}this._ldhNodeManager.setBoundingSphere(e)},_.prototype.isSlave=function(){return this._mode===_.Mode.slave},_.prototype.isOOC=function(){return this._mode===_.Mode.ooc},_.prototype._debug_UnloadReference=function(e){var t=!1,n=this._ldhNodeManager.createViewpointData(this._ldhNodeManager.viewer.currentViewpoint),i=this._getLDHReference(e,!0);return i&&(t=this._ldhNodeManager.unloadNode(i,n),this.setPauseLoading(!0),this._ldhNodeManager.viewer.render()),t},_.prototype._startModelLoaderTransaction=function(){this._instRefGraphTransaction&&console.log("ERROR - A transaction already exists"),this._instRefGraphTransaction=new O},_.prototype._updateOccurrences=function(e){if(!this.isSlave()){var t,n,i,o=this._ldhNodeManager;for(t=0;t<e.length;t++)n=e[t].getLastId(),(i=this._getLDHReference(n,!0))?i.updateOccurrencesPosition(o,null):(i=this._instanceTos.get(n))&&i.updateOccurrencesPosition(o,n)}},_.prototype.hasMeshInRAM=function(e){var t=this._getLDHReference(e,!0),n=t&&t.getPrimaryRepresentation();return!!n&&(!(!n.node||!t.isLoaded()&&!t.isToUnload())&&n.hasMeshInRAM())},_.prototype.isMeshInRAMRequested=function(e){return this._isMeshInRAMRequested(e)},_.prototype.getRepType=function(e){var t=this._getLDHReference(e,!0),n=t&&t.getPrimaryRepresentation();return n?n.type:null},_.prototype.getRequestedRepType=function(e){var t=this._getLDHReference(e,!0),n=t&&t.getActiveRepresentation();return n?n.type:null},_.prototype.hasRoot=function(){return this._rootOccurrenceTos.size>0},_.prototype.hasActiveRoot=function(){return this._ldhNodeManager.getRootsToExpand().length>0},_.prototype.getInstanceParentReferenceId=function(e){var t=this._instanceTos.get(e);return t?t.referenceId:null},_.prototype.getInstanceChildReferenceId=function(e){var t=this._instanceTos.get(e),n=t?t.getChild(e):null;return n?n.reference.referenceId:null},_.prototype.removeInstance=function(e){var t=this._instanceTos.get(e);if(!t)throw new Error("Unknown instanceId");var n=t.getChild(e);if(!n)throw new Error("Bad instanceId");t.detachReference(n.reference,e,!0,this)},_.prototype.removeInstanceTree=function(e){var t=this._instanceTos.get(e);if(!t)throw new Error("Unknown instanceId");var n=t.getChild(e);if(!n)throw new Error("Bad instanceId");t.detachReference(n.reference,e,!0,this),0!==n.reference.parents.length||n.reference.isRoot||this.removeReferenceTree(n.reference.referenceId)},_.prototype.removeReference=function(e){var t=this._getLDHReference(e,!0);if(t){var n,i=t.parents;for(t.detachReference(null,null,!0,this),n=0;n<i.length;n++)i[n].detachReference(t,null,!1,this);t.parents.length=0,this._unregisterReference(e)}},_.prototype.removeReferenceTree=function(e){var t=this._getLDHReference(e,!0);if(t){var n,i=t.parents,o=new Set;for(t.detachReference(null,null,!0,this,o),n=0;n<i.length;n++)i[n].detachReference(t,null,!1,this);t.parents.length=0;var r=this;o.forEach(function(e){e.detachReference(null,null,!0,r),e.parents.length=0,r._unregisterReference(e.referenceId)}),this._unregisterReference(e)}},_.prototype.updateInstance=function(e,t){if(!t.instanceId||t.instanceId===e||!this._instanceTos.get(t.instanceId)){var n=this._instanceTos.get(e);if(!n)throw new Error("Unknown instanceId");n.updateInstance(e,t,this._ldhNodeManager),t.instanceId&&t.instanceId!==e&&(this._unregisterInstance(e),this._instanceTos.set(t.instanceId,n))}},_.prototype._initIdPathMatcher=function(){var e=this._ldhNodeManager.viewer,t=this;var n=new p({idToNodeCB:function(e){var n=t._externalNodeIdToNode.get(e);if(n)return n;if(e.startsWith("##REP##")){var i=e.substring(7),o=t._getLDHReference(i,!0);return o?o.getCGRNode():null}return t.getSceneGraphNode(e)},nodeToIdCB:function(e){if(!e)return null;var n=t._externalNodeToNodeId.get(e);return n||((n=e.getModelIdentification())||(n=f.weakCGRNodeMap.get(e)||null),n)},isNodeRepRefCB:function(e){var n,i=t._externalNodeToNodeId.get(e);return!i&&(i=e.getModelIdentification(),!!(n=t._getLDHReference(i,!0))&&n.isLeaf())}});e.setIdPathMatcher(n),m.setParams({useIdPathMatcher:!0,viewer:e,oocManager:this})},_.prototype.setUsePickingAccelerationStructure=function(e,t){var n=this._usePickingAccelerationStructure;this._usePickingAccelerationStructure=!!e,e&&n!==this._usePickingAccelerationStructure?this._doMassiveReload(t):t&&setTimeout(t,0)},_.prototype.getUsePickingAccelerationStructure=function(){return this._usePickingAccelerationStructure},_.prototype.loadBox=function(e,t,n,i){if(this._boxes.has(t))throw new Error("box with name "+t+" already exists");this._boxes.set(t,null),C.startProbe("box_"+t);var o,r,s,a,d=localStorage.getItem("OOCBoxDebug");let h=0;d&&(o=performance.now()),this._ldhNodeManager.loadReferencesFromBox(e,e=>{d&&(r=performance.now());let i=e.length,l=[];for(let t=0;t<i;t++){let n=this._getLDHReference(e[t]);l.push({obj:n,skip:!1})}var c,u,p=()=>{if(--c===h){var u;for(d&&(s=0,a=0),u=0;u<i;u++){let t=l[u];d&&(s+=t.obj.byteSize,t.skip&&(a+=t.obj.byteSize)),t.skip||(this.addSceneGraphLock(e[u]),this.setForceReferenceLoad(e[u],!1,null))}if(C.endProbe("box_"+t),d){var p=performance.now();console.log("skipped"+a+" of "+s+" bytes or "+a/s*100+"% of total size"),console.log("box query : "+(r-o)/1e3+" / "+i+" cgrs : "+(p-r)/1e3)}n(t)}};if(c=i,this._boxes.has(t))if(this._boxes.set(t,e),i>0){var f=localStorage.getItem("OOCBoxMinSize");for(u=0;u<i;u++){let t=l[u];if(null!=f){let e=t.obj.getBoundingSphere();if(e&&2*e.radius<f){h++,t.skip=!0;continue}}this.forceReferenceLoad(e[u],p)}h&&d&&console.log(h+" objects can be skipped")}else{if(C.endProbe("box_"+t),d){var g=performance.now();console.log("box query : "+(r-o)/1e3+" / "+i+" cgrs : "+(g-r)/1e3)}n(t)}},e=>{i(t,e)})},_.prototype.releaseBox=function(e){if(!this._boxes.has(e))throw new Error("box with name "+e+" does not exist");var t,n=this._boxes.get(e);if(this._boxes.delete(e),n)for(t=0;t<n.length;t++)this.removeSceneGraphLock(n[t])},_.prototype.getTileSet=function(e){var t=this._getLDHReference(e,!0),n=null;if(t){var i=this._ldhNodeManager.getTileSets(t);n=i?i[0].oocTileSet:null}return n},_.prototype.getTileSets=function(e){var t=this._getLDHReference(e,!0),n=null;if(t){var i,o=this._ldhNodeManager.getTileSets(t);if(o)for(n=[],i=0;i<o.length;i++)n.push(o[i].oocTileSet)}return n},_.prototype.registerHandlers=function({repRef:e,ref:t,tileSet:n}){this._handlers.repRef?console.warn("registerHandlers repRef ignored since already valued"):this._handlers.repRef=e,this._handlers.ref?console.warn("registerHandlers ref ignored since already valued"):this._handlers.ref=t,this._handlers.tileSet?console.warn("registerHandlers tileSet ignored since already valued"):this._handlers.tileSet=n},_.prototype._doMassiveReload=function(e){var t,n,i,o,r=this.getAllReferences(),s=r.length,a=function(){s--,e&&0===s&&e()};for(t=0;t<r.length;t++)n=r[t],(o=this._getLDHReference(n)).isLeaf()?(i=o.getActiveRepresentation(),n=r[t],this.switchLOD(n,i.url,a,i.type,i.wms)):s--},_.prototype._getActiveRootLDHReferences=function(){var e=[];return this._rootOccurrenceTos.forEach(function(t,n,i){(t.enableExpand||t.treeModified)&&e.push(t.occurrence.reference)}),e},_.prototype._dispose=function(){this._ldhNodeManager.dispose()},_.prototype._isMeshInRAMRequested=function(e,t){var n=this._getLDHReference(e,!0),i=n&&n.getLoadModelOptions();return i&&void 0!==i.noMeshInRAM?!i.noMeshInRAM:this._defaultLoadModelOptions&&void 0!==this._defaultLoadModelOptions.noMeshInRAM?!this._defaultLoadModelOptions.noMeshInRAM:!(!this._ldhNodeManager.getGlobalMeshInRAM(n,t)&&!this._lockMeshInRAMTos.has(e))},_.prototype._onRootReferenceLoaded=function(e){this._rootOccurrenceTos.forEach(function(t,n,i){t&&t.onLoadedCB&&t.occurrence.reference.referenceId===e&&t.onLoadedCB(e)}),this._updateBoundingSphere()},_.prototype._onNodeCreate=function(e){var t=e.getModelIdentification();this._activateOverrideSetManager(t,e)},_.prototype._onNodeRemove=function(e){var t=e.getModelIdentification(),n=this._overrideSetManagerMap&&this._overrideSetManagerMap.get(t);n&&n._deactivate()},_.prototype._activateOverrideSetManager=function(e,t){var n=this._overrideSetManagerMap&&this._overrideSetManagerMap.get(e);if(n){var i=t||this._ldhNodeManager.idPathMatcher.idToNode(e);i&&(n.node=i,i._setOverrideSetManager(n),n._activate())}},_.prototype._computeUnitValue=function(e){return e?_.unitsTable[e]:1},_.prototype.getUnitValue=function(){return this._unitValue},_.unitsTable={mm:1,cm:10,dm:100,m:1e3,dam:1e4,hm:1e5,km:1e6};var O=function(){this.updatedRefencesMap=new Map,this.unloadTried=!1};return O.prototype.onAddChild=function(e){this.updatedRefencesMap.set(e,!0)},O.prototype.endTransaction=function(e){var t=[];this.updatedRefencesMap.forEach(function(e,n,i){var o=n;o&&t.push(o)}),e._ldhNodeManager.onInstRefGraphTransactionEnd(t)},O.prototype.onCPUMemoryFull=function(e){e._ldhNodeManager.instRefTransactionCPUMemoryFullOccurred=!0},require(["DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Selection/HSOManager","DS/Visualization/PathElement"],function(e,t,n,i,o){var r=null;window.OOCShowReferenceBoundingSphere=function(i,o,s,a){var d=o._getLDHReference(i),h=d.getBoundingBox(),l=d.getNode(),c={cornerPoint:h.min,firstAxis:new t.Vector3(h.max.x-h.min.x,0,0),secondAxis:new t.Vector3(0,h.max.y-h.min.y,0),thirdAxis:new t.Vector3(0,0,h.max.z-h.min.z),material:new t.MeshBasicMaterial({color:"red",force:!0,opacity:.2,transparent:!0})};null===r&&(r=new n("##OOCDebugBBRoot"),s.addNode(r));var u,p,f=d.isSlave()?l._occurrences:d._occurrences;for(u=0;u<f.length;u++)p=f[u].matrix,(l=e.createCuboidNode(c)).setMatrix(p),a&&l.setNoZ(!0),r.addChild(l);debugWebGLV6Viewer.render()},window.OOCBuildTileModelPreloadData=function(e,t){e=e||window.oocLDHNodeManager.oocManager,t=t||window.debugWebGLV6Viewer;var n=e.getRootOccurrences().values().next().value.occurrence,i=n&&n.reference.referenceId,o={viewpoint:{pos:t.currentViewpoint.getEyePosition().createJSON(),sight:t.currentViewpoint.getSightDirection().createJSON(),up:t.currentViewpoint.getUpDirection(),distanceToTarget:t.currentViewpoint.getTargetDistance()},rootId:i};return JSON.stringify(o)},window.OOCHighlightReference=function(e,t,n){var r=(t=t||window.oocLDHNodeManager.oocManager).getSceneGraphNode(e);if(r){var s=new o([r]);!n&&i.empty(),i.add({pathElement:s})}else console.log("no node");return t._getLDHReference(e,!0)}}),_.Mode={unknown:"unknown",ooc:"ooc",slave:"slave"},_.RepType={none:y.RepType.none,av1:y.RepType.av1,pr:y.RepType.pr,rr:y.RepType.rr},_}),define("DS/3DXMTiles/DSTilesPointCloudNodeExpanderSingleton",["DS/3DXMTiles/DSTilesExpander","DS/3DXMTiles/DSTilesNode","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesJSONContent","DS/3DXMTiles/PointCloudServices","DS/3DXMTiles/DSTilesDistanceScoreComputer","DS/3DXMTiles/DSTilesPointCloudNodeContent","DS/3DXMTiles/DSTilesPointCloudNodeHandlerSingleton","DS/3DXMTiles/DSTilesPointCloudNodeExpanderSingleton"],function(e,t,n,i,o,r,s,a,d){"use strict";var h=function(){};return(h.prototype=Object.create(e.prototype)).isReady=function(){return!0},h.prototype.isThereEnoughMemoryToExpand=function(e,t){return!0},h.prototype.expand=function(e,t){var n=e.content,i=n.seed,r=i.content.uuid,h=i.content.source;o.buildNodes({source:h,uuid:r,nodesID:n.oocChildren,scoreComputer:i.scoreComputer,seed:i,DSTilesPointCloudNodeContent:s,DSTilesPointCloudNodeHandlerSingleton:a,DSTilesPointCloudNodeExpanderSingleton:d}).then(function(n){var i,o;for(i=0;i<n.length;i++)o=n[i],e.addChild(o),t.registerDSTilesNode(o);t.onNodeExpanded(e)}).catch(function(){t.onNodeExpandError(e)})},d=new h}),define("DS/3DXMTiles/DSTilesPointCloudSeedExpander",["DS/3DXMTiles/DSTilesExpander","DS/3DXMTiles/DSTilesNode","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesJSONContent","DS/3DXMTiles/PointCloudServices","DS/3DXMTiles/DSTilesDistanceScoreComputer","DS/3DXMTiles/DSTilesPointCloudNodeContent","DS/3DXMTiles/DSTilesPointCloudNodeHandlerSingleton","DS/3DXMTiles/DSTilesPointCloudNodeExpanderSingleton"],function(e,t,n,i,o,r,s,a,d){"use strict";var h=function(e){e=e||{},this.scoreComputer=e.scoreComputer||new r,this.baseURL=e.baseURL||"",this._dbg_onLoadedNodeCB=e._dbg_onLoadedNodeCB};return(h.prototype=Object.create(e.prototype)).isReady=function(){return!0},h.prototype.isThereEnoughMemoryToExpand=function(e,t){return!0},h.prototype.expand=function(e,t){var n=e.content,i=n.uuid,r=n.source;o.getPointCloudHeader(r,i).then(function(t){return n.spacing=t.spacing,n.maxDepth=t.maxDepth-2,o.buildNodes({source:r,uuid:i,nodesID:[o.parseBigInt("0xFFFFFFFFFFFFFFFF")],scoreComputer:e.scoreComputer,seed:e,DSTilesPointCloudNodeContent:s,DSTilesPointCloudNodeHandlerSingleton:a,DSTilesPointCloudNodeExpanderSingleton:d})}).then(function(i){var o,r,s=i[0].getBoundingBox(),a=s.min.distanceTo(s.max)/1e3;for(n._nodeMaterial.updatePDSFXUniform("uMaxSpacing",a),o=0;o<i.length;o++)r=i[o],e.addChild(r),t.registerDSTilesNode(r),t.onNodeExpanded(e)})},h});