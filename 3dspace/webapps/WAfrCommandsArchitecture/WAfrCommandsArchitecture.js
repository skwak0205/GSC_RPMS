define("DS/WAfrCommandsArchitecture/mod_CommandsManagerComponent",["DS/WAfrHandlers/private/private_CommandHandlerUtilities","DS/WAfrHandlers/mod_HandlerComponent","DS/CoreEvents/ModelEvents","DS/CoreEvents/Events","DS/CoreUtilities/ErrorManagement","UWA/Class/Promise"],function(e,n,a,t,r,d){"use strict";let c=[r.generateReturnValue("COMMAND_NOT_STARTED",!1)],i=r.getErrorManager(c,{merge:!1});var m={exclusiveCmdCalled:0,secondExecuteCalled:1,killedByInfra:2,askedByCmd:3},o=!1;function s(e,n){o&&console.log(n+" : "+e)}var l=!1;function _(e){if(e.commandHandlerId){if(!e.executionCtx)throw new Error("mod_commandsManagerComponent.js cannot execute a command without an execution context");var a=e.executionCtx.getComponent(n.DEFAULT_COMPONENT_NAME);if(!a)throw new Error("mod_commandsManagerComponent.js cannot execute a command without a handler component registered on the execution context");a.executeHandler({id:e.commandHandlerId})}}function u(n){if(n.cmdsManager._private._runningCmd)throw new Error("CmdsManager.runNextCmd a command is already running");if(n.cmdsManager._private._currentExecutionDone){var a;if(n.cmdsManager._private._executionChain.length>0&&(a=n.cmdsManager._private._executionChain[0].caller.cmdHandler),n.cmdsManager._private._pausedCmds.length>0&&(!n.cmdsManager._private._waitingExecution||a===n.cmdsManager._private._pausedCmds[0]||a.getMode()!==e.CmdMode.NESTED)){var t=Object.create(null);return t.cmdsManager=n.cmdsManager,t.cmdHandler=n.cmdsManager._private._pausedCmds.pop(),void function(n){s("resume",n.cmdHandler.getId()),n.cmdHandler.setStateAndSendEvent({state:e.HandlerState.EXECUTING,event:e.LifeCycleEvents.RESUME}),n.cmdsManager._private._runningCmd=n.cmdHandler,n.cmdHandler._private._command._instance.resumeExecute?(n.cmdHandler._private._command._instance.done=D.bind(n),h({callback:n.cmdHandler._private._command._instance.resumeExecute,caller:n.cmdHandler._private._command._instance})):h({callback:D,caller:n});h({callback:function(){n.cmdsManager._private._currentExecutionDone&&p(n.cmdHandler)&&H.call(n.cmdsManager)}}),n.cmdsManager._private._modelEvents.publish({event:n.cmdHandler.getId()+"/resume"}),n.cmdsManager._private._modelEvents.publish({event:"resume",data:n.cmdHandler.getId()})}(t)}if(0===n.cmdsManager._private._waitingExecution&&n.cmdsManager._private._currentExecutionDone){var r=n.cmdsManager.getDefaultCommand();r&&_({commandHandlerId:r,executionCtx:n.cmdsManager.getExecutionContext()})}setTimeout(function(){n.cmdsManager._private._waitingExecution?H.call(n.cmdsManager):n.cmdsManager._private._currentExecution&&n.cmdsManager._private._currentExecutionDone&&(n.cmdsManager._private._currentExecution=null)},0)}}function p(n){return n.getState()===e.HandlerState.EXECUTING}var v=new Array(50),g=0;function C(){for(var e=0;e<g;e+=3){var n=v[e],a=v[e+1],t=v[e+2];n.call(a,t),v[e]=void 0,v[e+1]=void 0,v[e+2]=void 0}g=0}function h(e){v[g]=e.callback,v[g+1]=e.caller,v[g+2]=e.arg,3===(g+=3)&&setTimeout(C,0)}function E(e){if(!e.caller.cmdsManager._private._currentExecutionDone)throw new Error("begin forbidden");return e.caller.cmdsManager._private._waitingExecution--,e.caller.cmdsManager._private._currentExecutionDone=!1,setTimeout(function(){e.callback.call(void 0,e.caller)},0),e.caller}function M(n){var a;if(n.caller.cmdHandler.getState()!==e.HandlerState.PAUSED)return n.caller.cmdsManager._private._runningCmd&&n.caller.cmdsManager._private._runningCmd!==n.caller.cmdHandler&&p(n.caller.cmdsManager._private._runningCmd)&&(n.caller.cmdsManager._private._waitingExecution++,(a=Object.create(null)).caller=Object.create(null),a.caller.cmdsManager=n.caller.cmdsManager,a.caller.cmdHandler=n.caller.cmdsManager._private._runningCmd,n.caller.cmdHandler.getMode()===e.CmdMode.EXCLUSIVE||!0===n.caller.cmdsManager._private._runningCmd._private._command._instance.cancelWhenPaused?(a.callback=A,a.caller.cmdHandler._private._command._instance.params=Object.create(null),a.caller.cmdHandler._private._command._instance.params.cancelReason=m.exclusiveCmdCalled):n.caller.cmdHandler.getMode()===e.CmdMode.NESTED&&(a.callback=b)),a}function H(){if(this._private._currentExecutionDone)if(0===this._private._executionChain.length)this._private._waitingExecution=0,this._private._executionChain=[],this._private._currentExecution=null,this._private._currentExecutionDone=!0,this._private._runningCmd||u({cmdsManager:this,cmdHandler:void 0});else{var e=M(this._private._executionChain[0]);e||(e=this._private._executionChain.shift()),this._private._currentExecution=E(e)}}function f(){this.cmdHandler._private._command._instance.done=function(){},s("paused",this.cmdHandler.getId()),this.cmdsManager._private._modelEvents.publish({event:this.cmdHandler.getId()+"/paused"}),this.cmdsManager._private._modelEvents.publish({event:"paused",data:this.cmdHandler.getId()}),this.cmdsManager._private._runningCmd=null,this.cmdsManager._private._currentExecution&&(this.cmdsManager._private._currentExecutionDone=!0);var e=this;setTimeout(function(){H.call(e.cmdsManager)},0)}function b(n){if(!n||!n.cmdsManager||!n.cmdHandler)throw new Error("pauseCmd require the parameter capsuleObject with a valid cmdsManager and cmdHandler with a valid command instance");if(n.cmdsManager._private._unstackingCommand&&n.cmdsManager._private._unstackingCommand.length>0)return n.cmdsManager._private._currentExecutionDone=!0,n.cmdsManager._private._unstackingCommand=[],void setTimeout(function(){H.call(n.cmdsManager)},0);p(n.cmdHandler)&&(s("pause",n.cmdHandler.getId()),n.cmdsManager._private._modelEvents.publish({event:n.cmdHandler.getId()+"/pause"}),n.cmdsManager._private._modelEvents.publish({event:"pause",data:n.cmdHandler.getId()}),n.cmdHandler.setStateAndSendEvent({state:e.HandlerState.PAUSED,event:e.LifeCycleEvents.PAUSE}),n.cmdsManager._private._pausedCmds.push(n.cmdHandler),n.cmdHandler._private._command._instance.pauseExecute?(n.cmdHandler._private._command._instance.done=f.bind(n),h({callback:n.cmdHandler._private._command._instance.pauseExecute,caller:n.cmdHandler._private._command._instance})):h({callback:f,caller:n}))}function x(n){var a,t=this.cmdsManager.getExecutionContext().getComponent("AFR_UndoRedoComponent");t&&!0===this.cmdsManager._private._runningCmd._private._command._instance._endUndoGroupingRequested&&(t._stopConcatenateUS(this.cmdsManager._private._runningCmd._private._command._instance._undoGroupID),this.cmdsManager._private._runningCmd._private._command._instance._endUndoGroupingRequested=!1);var d=this.cmdsManager._private._runningCmd._private._command._instance;if(a=function(e){var n=!1;if(!e._dirtyUndoStack)return n;var a=this.cmdsManager.getExecutionContext(),t=a.getComponent("AFR_UndoRedoComponent");if(t){var d=t.getLastStepId();if(e._previousUndoId<d){var c=!0;"shared"===e._mode&&e._executeUndoAtEnd&&(c=!1);var i=t._createUndoStep({undoTitle:e.getId(),exclusivity:c,redoEnabled:!e._executeUndoAtEnd});t.registerAction(i);var m=t.groupSteps(i.getId(),e._previousUndoId+1,a);if(r.hasSucceeded(m))n=!0;else{var o=t.removeStepWithId(t.getLastStepId());r.hasSucceeded(o)||r.logResult(o)}}}return n}.call(this,d),d.params&&d.params.undoOnEnd&&a){var c=!1;this.cmdsManager&&"WAFRRedoCmd"===this.cmdsManager.getRunningCommand()&&(c=!0),0===t.getUndoStack().getSize()||c||t.undo()}this.cmdsManager._private._runningCmd=null,this.cmdsManager._private._currentExecution&&(this.cmdsManager._private._currentExecutionDone=!0);var i=this.cmdHandler.getState()===e.HandlerState.CANCELED,m=this.cmdHandler.getRepeatMode()===e.RepeatMode.ALWAYS&&!i&&0===this.cmdsManager._private._waitingExecution;if(this.cmdHandler.setStateAndSendEvent({state:e.HandlerState.ENDED,event:e.LifeCycleEvents.END,repeated:m,canceled:i}),s("end",this.cmdHandler.getId()),this.cmdsManager._private._modelEvents.publish({event:this.cmdHandler.getId()+"/end",data:{repeated:m,canceled:i}}),this.cmdsManager._private._modelEvents.publish({event:"end",data:{handlerId:this.cmdHandler.getId(),repeated:m,canceled:i}}),this.cmdHandler._private._cb&&"function"==typeof this.cmdHandler._private._cb&&(this.cmdHandler._private._cb(n?n.error:void 0),m||(this.cmdHandler._private._appCB=[],this.cmdHandler._private._cbIfCommandNotStarted=null)),this.cmdHandler._private._command._instance.destroy&&this.cmdHandler._private._command._instance.destroy(),this.cmdHandler._private._command._instance=null,m)this.cmdHandler.execute(),H.call(this.cmdsManager);else{var o=this;setTimeout(function(){o.cmdsManager._private._runningCmd||u(o)},0)}}function S(n){n&&n.undoOnEnd&&(this.cmdsManager._private._runningCmd._private._command._instance.params||(this.cmdsManager._private._runningCmd._private._command._instance.params={}),this.cmdsManager._private._runningCmd._private._command._instance.params.undoOnEnd=n.undoOnEnd);var a=this.cmdsManager.getExecutionContext();if(this.cmdHandler._private._command._instance.done=function(){},this.cmdHandler.getState()!==e.HandlerState.CANCELED&&this.cmdHandler.setStateAndSendEvent({state:e.HandlerState.ENDING}),this.cmdHandler.isUsingComputeServer()){var t={from:this.cmdHandler._private._command._instance},r=a.getComponent("AFR_CSComponent");r&&r.sendStopCommand(t)}else{var d=this;setTimeout(function(){x.call(d,n)},0)}}function D(e){this.cmdHandler._private._command._instance.done=function(){},this.cmdsManager._private._runningCmd===this.cmdHandler&&p(this.cmdHandler)?(e&&e.error&&(this.cmdHandler._private._command._instance.params.error=e.error),e&&e.cancel?(this.cmdHandler._private._command._instance.params.cancelReason=m.askedByCmd,e.undoOnEnd&&(this.cmdHandler._private._command._instance.params.undoOnEnd=e.undoOnEnd),A(this)):S.call(this)):s("done execute callback called but command paused/canceled in between",this.cmdHandler.getId())}function I(e){if(!(e&&e.cmdsManager&&e.cmdHandler&&e.cmdHandler._private._command._instance&&e.cmdHandler._private._cb&&e.cmdHandler._private._cb))throw new Error("executeCmd require the parameter capsuleObject with a valid CommandsManager and cmdHandler with a valid command instance");if(s("begin",e.cmdHandler.getId()),e.cmdsManager._private._modelEvents.publish({event:e.cmdHandler.getId()+"/begin"}),e.cmdsManager._private._modelEvents.publish({event:"begin",data:e.cmdHandler.getId()}),e.cmdsManager._private._runningCmd=e.cmdHandler,!e.cmdHandler._private._command._instance.beginExecute&&!0!==e.cmdHandler._private._command._instance.stateGraph)throw new Error("mod_CommandsManagerComponent.executeCmd : Cannot execute a command without a beginExecute method defined on it. It has no sense. BAD Command : "+e.cmdHandler._private._command._module);var n=e.cmdsManager.getExecutionContext(),a=n.getComponent("AFR_UndoRedoComponent");if(a&&(e.cmdHandler._private._command._instance._previousUndoId=a.getLastCreatedUndoStepId()),e.cmdHandler.isUsingComputeServer()){var t={from:e.cmdHandler._private._command._instance},r=n.getComponent("AFR_CSComponent");r&&r.sendStartCommand(t)}!0!==e.cmdHandler._private._command._instance.stateGraph?(e.cmdHandler._private._command._instance.done=D.bind(e),h({callback:e.cmdHandler._private._command._instance.beginExecute,caller:e.cmdHandler._private._command._instance})):(!0===e.cmdHandler._private._command._instance.asyncGraph?e.cmdHandler._private._command._instance.done=function(){this.cmdHandler._private._command._instance.done=D.bind(this),this.cmdsManager._private._runningCmd===this.cmdHandler&&p(this.cmdHandler)?h({callback:this.cmdHandler._private._command._instance._initGraph,caller:this.cmdHandler._private._command._instance}):s("done execute callback called but command paused/canceled in between",this.cmdHandler.getId())}.bind(e):e.cmdHandler._private._command._instance.done=D.bind(e),h({callback:e.cmdHandler._private._command._instance.buildGraph,caller:e.cmdHandler._private._command._instance}),!0!==e.cmdHandler._private._command._instance.asyncGraph&&h({callback:e.cmdHandler._private._command._instance._initGraph,caller:e.cmdHandler._private._command._instance})),e.cmdsManager._private._currentExecution&&(e.cmdsManager._private._currentExecutionDone=!0),h({callback:function(){e.cmdsManager._private._currentExecutionDone&&p(e.cmdHandler)&&H.call(e.cmdsManager)}})}function A(n){if(!(n&&n.cmdsManager&&n.cmdHandler&&n.cmdHandler._private._cb))throw new Error("cancelCmd require the parameter capsuleObject with a valid cmdsManager and cmdHandler with a valid command instance");p(n.cmdHandler)&&(n.cmdHandler.setStateAndSendEvent({state:e.HandlerState.CANCELED,event:e.LifeCycleEvents.CANCEL}),s("canceling",n.cmdHandler.getId()),n.cmdsManager._private._modelEvents.publish({event:n.cmdHandler.getId()+"/canceling"}),n.cmdsManager._private._modelEvents.publish({event:"canceling",data:n.cmdHandler.getId()}),n.cmdHandler._private._command._instance.cancelExecute?(n.cmdHandler._private._command._instance.done=S.bind(n),h({callback:n.cmdHandler._private._command._instance.cancelExecute,caller:n.cmdHandler._private._command._instance,arg:n.cmdHandler._private._command._instance.params})):h({callback:S,caller:n}))}var w=Object.create(null);return w.CommandsManagerComponent=function(){var e=this;this._private||(this._private=Object.create(null)),this._private._defaultCommand=null,this._private._runningCmd=null,this._private._pausedCmds=[],this._private._executionChain=[],this._private._currentExecution=null,this._private._currentExecutionDone=!0,this._private._waitingExecution=0,this._private._modelEvents=new a,t.subscribe({event:"COMMAND_MANAGER/Ending_Commands"},function(){e.endAll(void 0)})},w.CommandsManagerComponent.DEFAULT_COMPONENT_NAME="AFR_CommandsManager",w.CommandsManagerComponent.prototype.initialize=function(e){return l=!1,e&&this.cmdsManager.getExecutionContext().setContext("usingCS",!0),d.resolve()},w.CommandsManagerComponent.prototype.clean=function(){var e=this;return l=!0,this.endAll().then(function(){e.setDefaultCommand(null)})},w.CommandsManagerComponent.prototype.isCmdExecuting=function(n){return n.getState()===e.HandlerState.EXECUTING},w.CommandsManagerComponent.prototype.setDefaultCommand=function(e){if(void 0===e||e&&"string"!=typeof e)throw new Error("CommandsManagerComponent.setDefaultCommand can only take null or a string (commandHandlerID) as input parameter");e&&null===this._private._runningCmd&&0===this._private._pausedCmds.length&&0===this._private._waitingExecution&&this._private._currentExecutionDone&&_({commandHandlerId:e,executionCtx:this._private._executionContext});this._private._defaultCommand=e},w.CommandsManagerComponent.prototype.getDefaultCommand=function(){return this._private._defaultCommand},w.CommandsManagerComponent.prototype.subscribeToCmdState=function(e,n,a){var t;return t=""===e?n:e+"/"+n,this._private._modelEvents.subscribe({event:t},function(e){a(e)})},w.CommandsManagerComponent.prototype.subscribeOnceToCmdState=function(e,n,a){var t;return t=""===e?n:e+"/"+n,this._private._modelEvents.subscribeOnce({event:t},function(e){a(e)})},w.CommandsManagerComponent.prototype.unsubscribeToCmdState=function(e){this._private._modelEvents.unsubscribe(e)},w.CommandsManagerComponent.prototype.getRunningCommand=function(){return this._private._runningCmd?this._private._runningCmd.getId():null},w.CommandsManagerComponent.prototype.getExposedComponentCtor=function(){function e(){this.cancelReason=m}return e.prototype.getDefaultCommand=this.getDefaultCommand.bind(this),e.prototype.getRunningCommand=this.getRunningCommand.bind(this),e.prototype.setDefaultCommand=this.setDefaultCommand.bind(this),e.prototype.isCmdExecuting=this.isCmdExecuting.bind(this),e.prototype.subscribeToCmdState=this.subscribeToCmdState.bind(this),e.prototype.unsubscribeToCmdState=this.unsubscribeToCmdState.bind(this),e.prototype.subscribeOnceToCmdState=this.subscribeOnceToCmdState.bind(this),e},w.CommandsManagerComponent.prototype.stackCommandExecutionRequest=function(n,a){var t=Object.create(null);t.cmdsManager=this,t.cmdHandler=a.handler;var d=a.cb;t.cmdHandler._private._cbIfCommandNotStarted=d,function(n){if(n.caller.cmdsManager._private._waitingExecution++,n.caller.cmdsManager._private._currentExecution||!n.caller.cmdsManager._private._currentExecutionDone||n.caller.cmdsManager._private._runningCmd&&!p(n.caller.cmdsManager._private._runningCmd))if(n.caller.cmdsManager._private._executionChain.length>0){n.caller.cmdsManager._private._waitingExecution--;var a=n.caller.cmdsManager._private._executionChain.pop();if(a.caller.cmdHandler.setStateAndSendEvent({state:e.HandlerState.ENDED,event:e.LifeCycleEvents.END,notStarted:!0}),a.caller.cmdHandler._private._cb&&"function"==typeof a.caller.cmdHandler._private._cb){const e=r.createReturnObject(i.COMMAND_NOT_STARTED,{description:"Can't start the command as another one has been started as the same time."});a.caller.cmdHandler._private._cbIfCommandNotStarted&&a.caller.cmdHandler._private._appCB.push(a.caller.cmdHandler._private._cbIfCommandNotStarted),a.caller.cmdHandler._private._cb(e),a.caller.cmdHandler._private._appCB=[]}a.caller.cmdHandler===n.caller.cmdHandler?n.caller.cmdsManager._private._waitingExecution--:(n.caller.cmdsManager._private._unstackingCommand=[],n.caller.cmdsManager._private._unstackingCommand.push({discardedCommand:a,newCommandToExecute:n}),n.caller.cmdsManager._private._executionChain.push(n))}else n.caller.cmdsManager._private._executionChain.push(n);else{var t=M(n);t?(n.caller.cmdsManager._private._executionChain.push(n),t.caller.cmdsManager._private._currentExecution=E(t)):n.caller.cmdsManager._private._currentExecution=E(n)}}({callback:function(t){if(!t)throw new Error("mod_CommandsManagerComponent.js callback in chainNewExecution cannot start a command is no capsuleObject is passed");if(!l){if(null!==d&&"function"==typeof d||(d=void 0),t.cmdHandler.getState()===e.HandlerState.PAUSED)return t.cmdsManager._private._currentExecution&&(t.cmdsManager._private._currentExecutionDone=!0),void setTimeout(function(){H.call(t.cmdsManager)},0);p(t.cmdHandler)?(t.cmdHandler._private._appCB||(t.cmdHandler._private._appCB=[]),d&&t.cmdHandler._private._appCB.push(d),t.cmdHandler._private._command._instance.params=Object.create(null),t.cmdHandler._private._command._instance.params.cancelReason=m.secondExecuteCalled,A(t)):(t.cmdHandler.setStateAndSendEvent({state:e.HandlerState.EXECUTING,event:e.LifeCycleEvents.BEGIN}),require([t.cmdHandler._private._command._module],function(e){if(!e)throw new Error("Failed to load the module related to the command",t.cmdHandler._private._id);var r=null,c=t.cmdsManager.getExecutionContext();c&&((r=c.applicationContext).ID=t.cmdsManager._private._executionContext.getId()),a.args||(a.args=Object.create(null)),a.args.cmdLifeCyleEventsChanel=t.cmdsManager._private._modelEvents,a.ID=t.cmdHandler.getId(),e.prototype.isNewInfraActivated=function(){return!0};var i=new e({args:a.args,executionContext:r,ID:a.ID});if(!i)throw H.call(t.cmdsManager),new Error("Call to "+t.cmdHandler._private._command._module+" constructor returned undefined");t.cmdHandler.isUsingComputeServer()&&(i.getCSIdentifier=function(){return i},i.hasDecalredCS=function(){return!0},i.onCmdEnded=function(e){return x.call(t,e)}),i.getId=function(){return t.cmdHandler.getId()},i.askForUndoGroupingAtEnd=function(e,n){i._endUndoGroupingRequested=!0,i._concatenateServerStep=n,i._undoGroupID=e},i._evtID=r.ID+a.ID,t.cmdHandler._private._command._instance=i,t.cmdHandler._private._command._instance.params={},t.cmdHandler._private._cb=n,t.cmdHandler._private._appCB||(t.cmdHandler._private._appCB=[]),d&&t.cmdHandler._private._appCB.push(d),I(t)},function(){var e=new Error("Require failed ("+t.cmdHandler._private._command._module+")");if(!d||"function"!=typeof d)throw e;d(e),H.call(t.cmdsManager)}))}},caller:t})},w.CommandsManagerComponent.prototype.endAll=function(){var e=this;return new UWA.Promise(function(n,a){var r=e._private._pausedCmds.length;if(r>0)var d=e.subscribeToCmdState("","resume",function(a){var c=Object.create(null);if(c.cmdsManager=e,c.cmdHandler=e._private._runningCmd,A(c),0===--r)return e.unsubscribeToCmdState(d),t.publish({event:"COMMAND_MANAGER/ALL_CMD_ENDED"}),n()});if(e._private._runningCmd&&("WAFRUndoCmd"!==e._private._runningCmd._private._id||"Undo"!==e._private._runningCmd._private._id)){var c=Object.create(null);c.cmdsManager=e,c.cmdHandler=e._private._runningCmd,A(c)}if(0===r)return t.publish({event:"COMMAND_MANAGER/ALL_CMD_ENDED"}),n()})},w}),define("DS/WAfrCommandsArchitecture/mod_CommandsInterpreter",["UWA/Class/Promise"],function(e){"use strict";var n=function(){};n.prototype.interpret=function(n,a){var t=!1,r=function(e,n){Object.keys(e).some(function(a){a===n&&!0===e[a]?t=!0:e[a]&&"object"==typeof e[a]&&r(e[a],n)})};return r(n,"computeServer"),t&&a.setContext("usingCS",!0),e.resolve(t)};var a=Object.create(null);return a.generateInterpreter=function(){return new n},a});