define("DS/DMUMarkerVisu/DMUMarkerVisuText",["UWA/Class"],function(e){"use strict";return e.extend({init:function(){this._parent();var e=null,t=null,i=12,a="sans-serif",o="normal";this.getTextContent=function(){return e},this.setTextContent=function(t){e=t},this.getTextToDisplay=function(){return t||e},this.setTextToDisplay=function(e){t=e},this.getFontSize=function(){return i},this.setFontSize=function(e){i=e},this.getFontStyle=function(){return o},this.setFontStyle=function(e){o=e},this.getFontName=function(){return a},this.setFontName=function(e){a=e}}})}),define("DS/DMUMarkerVisu/DMUMarkerVisuServices",["DS/Visualization/Node3D","DS/Formats/CGRFile","DS/Visualization/LoaderUtils","DS/Mesh/Mesh","DS/DMUBaseExperience/EXPToolsMaterial"],function(e,t,i,a,o){"use strict";var n,r=function(e){if(e.getNodeType&&"Mesh3D"===e.getNodeType())return e;for(var t=e.children,i=0;i<t.length;i++){var a=r(t[i]);if(a)return a}},l=function(e){e.setPickParent&&e.setPickParent(!0);for(var t=e.children,i=0;i<t.length;i++)l(t[i])};return{buildTessellatedRepresentationNode:function(a){var o;if(a&&a.length){let s;(o=new e).setPickParent(!0),n||(n=new t(void 0,void 0,void 0,!0)),a.forEach(function(t){s=new e,i.processData([s],n.openSceneGraph(new Uint8Array(function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var i=new ArrayBuffer(e.length/4*3);return function(e,i){var a,o,n,r,l,s,h,d=t.indexOf(e.charAt(e.length-1)),c=t.indexOf(e.charAt(e.length-2)),g=e.length/4*3;64===d&&g--,64===c&&g--;var p=0,f=0;for(a=i?new Uint8Array(i):new Uint8Array(g),e=e.replace(/[^A-Za-z0-9+/=]/g,""),p=0;p<g;p+=3)o=t.indexOf(e.charAt(f++))<<2|(l=t.indexOf(e.charAt(f++)))>>4,n=(15&l)<<4|(s=t.indexOf(e.charAt(f++)))>>2,r=(3&s)<<6|(h=t.indexOf(e.charAt(f++))),a[p]=o,64!==s&&(a[p+1]=n),64!==h&&(a[p+2]=r)}(e,i),i}(t)),function(){},{}),void 0,!0,{},function(){!function(e){e.disableClipping(!0);var t=r(e);t.setShadow(!1,!1),t.setSSAO(!1),t.setVisibilityInTree(!1),l(e)}(s)}),o.addChild(s)})}return o},getDashPattern:function(e){var t;switch(o.getDashType(e)){case a.LinePatternEnum.DOTTED:(t=new Float32Array(2))[0]=2,t[1]=2;break;case a.LinePatternEnum.DASHED:(t=new Float32Array(2))[0]=3,t[1]=1;break;case a.LinePatternEnum.DOTDASHED:(t=new Float32Array(4))[0]=3,t[1]=2,t[2]=1,t[3]=2;break;case a.LinePatternEnum.PHANTOM:(t=new Float32Array(6))[0]=6,t[1]=2,t[2]=2,t[3]=2,t[4]=2,t[5]=2;break;case a.LinePatternEnum.SMALLDOTTED:(t=new Float32Array(2))[0]=1,t[1]=1;break;case a.LinePatternEnum.JISAXIS:(t=new Float32Array(4))[0]=2,t[1]=1,t[2]=12,t[3]=2;break;default:(t=new Float32Array(1))[0]=-1}for(var i=0;i<t.length;i++)t[i]*=2;return t}}}),define("DS/DMUMarkerVisu/DMUMarkerVisuShapeBaseNode",["UWA/Core","DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/CanvasNodeTexture","DS/SceneGraphNodes/CanvasNode","DS/DMUBaseExperience/EXPToolsMaterial","DS/DMUBaseExperience/EXPUtils","DS/DMUBaseExperience/EXPToolsVisualization","DS/Mesh/Mesh","DS/DMUMarkerVisu/DMUMarkerVisuServices"],function(e,t,i,a,o,n,r,l,s,h,d,c,g){"use strict";return t.extend({init:function(p){this._parent();var f,v,u,m,x,w=p.window,M=w.getViewer(),S=this,P=e.createElement("canvas"),y={},C=window.devicePixelRatio,D=new Image,T=!1,z=1,k=new o({type:"Spherical"});k.setPickParent(!0),S.addChild(k);var I=new t;I.setPickParent(!0);var b,N=new t;N.setPickParent(!0),N.addChild(I);var R={anchorMode:"center",isFilled:!0,hasBorder:!1,graphicProperties:{padding:5,borderRadius:4,horizontalAlignement:"center",fontStyle:{height:12,familyName:"sans-serif",familyStyle:"normal",color:new i.Color(0)},fillStyle:{color:new i.Color(16777215),opacity:1},lineStyle:{thickness:1,pattern:"1",color:new i.Color(4013373)}},isHighlighted:!1};function U(e,t,i,a){t.scale(1/a,1/a);var o=t.canvas.width/(R.zoomMode?d.convertModelToPixels({sizeInMM:y.widthInMM+u,viewer:M}):y.width+u),n=o*y.width,r=o*y.height,l=(t.canvas.width-n)/2,s=(t.canvas.height-r)/2;if(R.isFilled)if(R.graphicProperties.fillStyle.gradient){var c;"leftToRight"===R.graphicProperties.fillStyle.gradient.type?c=t.createLinearGradient(l,s,t.canvas.width-l,s):"topToBottom"===R.graphicProperties.fillStyle.gradient.type?c=t.createLinearGradient(l,t.canvas.height,l,s):"topLeftToBottomRight"===R.graphicProperties.fillStyle.gradient.type?c=t.createLinearGradient(l,s,t.canvas.width-l,t.canvas.height):"bottomLeftToTopRight"===R.graphicProperties.fillStyle.gradient.type&&(c=t.createLinearGradient(l,t.canvas.height,t.canvas.width-l,s));for(var g=Object.keys(R.graphicProperties.fillStyle.gradient.specs),p=0;p<g.length;p++)c.addColorStop(parseFloat(g[p]),R.graphicProperties.fillStyle.gradient.specs[g[p]]);t.fillStyle=c}else t.fillStyle=h.colorToHex(R.graphicProperties.fillStyle.color),t.globalAlpha=R.graphicProperties.fillStyle.opacity*(T?.6:z);else t.globalAlpha=0;S.drawCanvasContent&&S.drawCanvasContent({appData:R,context:t,ratio:o,size:{width:n,height:r,minX:l,minY:s},isGhost:T,opacity:z,imageToDisplay:D,onCanvasRequestRedraw:function(){f&&f.canvasNodeTexture&&(f.canvasNodeTexture.requestRedraw(),M.render())}})}function H(e,t){e.mesh3js?e.mesh3js.geometry.forEach(function(e){e&&e.drawingGroups&&e.drawingGroups.forEach(function(e){e&&(e._noZPriority=t)})}):e.children.forEach(function(e){H(e,t)})}function E(e,t){k.setNoZ(!0);var o=function(){var e;if(R.markerImage){var t=new i.ImageUtils.loadTexture(R.markerImage,void 0,null,null,!0);if(t){var o=new i.MeshBasicMaterial({map:t,transparent:!0,enableClipPlanes:!1});o.force=!0,o.depthTest=!1;var n=R.zoomMode?d.convertPixelToModel({sizeInPixels:R.imageWidth}):R.imageWidth,r=R.zoomMode?d.convertPixelToModel({sizeInPixels:R.imageHeight}):R.imageHeight;(e=a.createRectangleNode({width:R.isPositionProportional?R.imageWidth:d.convertModelToPixels({sizeInMM:n}),height:R.isPositionProportional?R.imageHeight:d.convertModelToPixels({sizeInMM:r}),fill:!0,noEdge:!0})).setShadow(!1,!1),e.setPickParent(!0),e.setMaterial(o)}}return e}(),n=function(){var e;if(R.isFilled&&P&&R.graphicProperties.fillStyle.gradient){var t,a=P.getContext("2d"),o=a.canvas.width/(R.zoomMode?d.convertModelToPixels({sizeInMM:y.widthInMM+u,viewer:M}):y.width+u);a.clearRect(0,0,P.width,P.height);var n=(a.canvas.width-o*y.width)/2,r=(a.canvas.height-o*y.height)/2;"leftToRight"===R.graphicProperties.fillStyle.gradient.type?t=a.createLinearGradient(n,r,a.canvas.width-n,r):"topToBottom"===R.graphicProperties.fillStyle.gradient.type?t=a.createLinearGradient(n,a.canvas.height,n,r):"topLeftToBottomRight"===R.graphicProperties.fillStyle.gradient.type?t=a.createLinearGradient(n,r,a.canvas.width-n,a.canvas.height):"bottomLeftToTopRight"===R.graphicProperties.fillStyle.gradient.type&&(t=a.createLinearGradient(n,a.canvas.height,a.canvas.width-n,r));for(var l=Object.keys(R.graphicProperties.fillStyle.gradient.specs),h=0;h<l.length;h++)t.addColorStop(parseFloat(l[h]),R.graphicProperties.fillStyle.gradient.specs[l[h]]);a.fillStyle=t,a.fillRect(0,0,a.canvas.width,a.canvas.height);var c=new i.Texture(P);c.needsUpdate=!0,e=new i.MeshBasicMaterial({map:c,side:i.DoubleSide,opacity:R.isFilled?R.graphicProperties.fillStyle.opacity:0,transparent:!0,force:!0})}else e=new i.MeshBasicMaterial({color:R.graphicProperties.fillStyle.color,opacity:R.isFilled?R.graphicProperties.fillStyle.opacity:0,side:i.DoubleSide,transparent:!0,force:!0});return R.hasBorder&&(e.line=s.createLineMaterial({color:R.graphicProperties.lineStyle.color,opacity:R.graphicProperties.lineStyle.opacity,lineWidth:R.graphicProperties.lineStyle.thickness*window.devicePixelRatio,pattern:R.graphicProperties.lineStyle.pattern})),e}(),r=a.createRectangleNode({width:e,height:t,fill:!0,noEdge:!0!==R.hasBorder,material:n});r.setShadow(!1,!1),r.setPickParent(!0),H(r,0),H(b,1),o&&(H(o,1),I.addChild(o)),I.addChild(b),r.setMatrix((new i.Matrix4).makeTranslation(-e/2,-t/2,0));var l=d.convertModelToPixels({sizeInMM:1});if(R.isPositionProportional){var h=b.getBoundingBox(),c=d.convertModelToPixels({sizeInMM:Math.abs(h.max.x-h.min.x)}),g=0,p=2*d.convertModelToPixels({sizeInMM:1.5});R.markerImage&&(g=R.imageWidth,p=3*p/2);var f=R.boxWidth-g-p;l=d.convertModelToPixels({sizeInMM:f})/c}var v,x=R.zoomMode?1:l,w=R.mkvShape?R.mkvShape.getMarkUpGrid():null;if(w)for(var S,C=0;C<w.getNbofRows();C++){for(var D=0;D<w.getNbofColumns();D++)if((S=w.getMarkUpCell(C,D)).getCellText()){let a=R.isPositionProportional?S.getCellPos().x*window.devicePixelRatio:S.getCellPos().x/window.devicePixelRatio,o=R.zoomMode?d.convertPixelToModel({sizeInPixels:a}):a;v=(new i.Matrix4).makeTranslation(o-e/2,t/2,0);break}if(v)break}else R.content&&R.content.length&&(v=(new i.Matrix4).makeTranslation(-y.width/2,y.height/2,0));if(b.setMatrix(v.multiply((new i.Matrix4).makeScale(x,x,x))),o){var T=R.zoomMode?R.imageHeight:d.convertModelToPixels({sizeInMM:R.imageHeight}),z=R.isPositionProportional?R.imageHeight:T;v=(new i.Matrix4).makeTranslation(-e/2,t/2-z,0),o.setMatrix(v)}var N=(new i.Matrix4).makeRotationZ(m);"topleft"===R.anchorMode&&(N=(new i.Matrix4).makeTranslation(e/2,-t/2,0).multiply(N)),I.setMatrix(N),I.addChild(r)}function B(e,t,o,n){I.setNoHighlightNoZ(!0),e+=u/2,t+=!R.isPicture||R.shortDisplay?u/2:u/4,v||(v=s.createBasicMaterial({color:new i.Color(0),opacity:0}));var h,g,p,x,w,S=a.createNodeFromTHREEMesh((h=R.zoomMode?d.convertPixelToModel({sizeInPixels:R.graphicProperties.borderRadius+n/2}):R.graphicProperties.borderRadius+n/2,g=e+o,p=t+o,x=v,(w=new i.Shape).moveTo(-g/2,-p/2+h),w.lineTo(-g/2,p/2-h),h&&w.absarc(-g/2+h,p/2-h,h,Math.PI,.5*Math.PI,!0),w.lineTo(g/2-h,p/2),h&&w.absarc(g/2-h,p/2-h,h,.5*Math.PI,0,!0),w.lineTo(g/2,-p/2+h),h&&w.absarc(g/2-h,-p/2+h,h,2*Math.PI,1.5*Math.PI,!0),w.lineTo(-g/2+h,-p/2),h&&w.absarc(-g/2+h,-p/2+h,h,1.5*Math.PI,Math.PI,!0),new i.Mesh(new i.ShapeGeometry(w),x)));let P=new i.Matrix4;R.isPicture&&!R.shortDisplay&&(P=(new i.Matrix4).makeTranslation(0,u/8,0)),"topleft"===R.anchorMode&&P.makeTranslation((R.zoomMode?y.widthInMM:y.width)/2,-(R.zoomMode?y.heightInMM:y.height)/2,0),S.setMatrix(P),S.setShadow(!1,!1),S.setPickParent(!0);var C=(new i.Matrix4).makeRotationZ(m),D=new i.Matrix4;"topleft"===R.anchorMode&&D.makeTranslation((R.zoomMode?y.widthInMM:y.width)/2,-(R.zoomMode?y.heightInMM:y.height)/2,0),(f=function(e,t){var o,n=new r({width:e,height:t,webGLV6Viewer:M,drawCB:U,rectangleTexture:!0,materialParams:{depthTest:!1}});return(o=R.zoomMode||R.isPicture?new l({bottomLeftcorner:new i.Vector3(-e/2,-t/2,0),widthVector:new i.Vector3(e,0,0),heightVector:new i.Vector3(0,t,0),canvasNodeTexture:n},a):a.createCanvas2DNode({hotspot:new i.Vector2(e/2,t/2),canvasNodeTexture:n})).rectangle.setRenderDepth(10),o.rectangle.excludeFromHighlight(!0,!0),o.rectangle.setPickable(c.PICKTHROUGH),o}((R.zoomMode?y.widthInMM:y.width)+u,(R.zoomMode?y.heightInMM:y.height)+u)).setMatrix(D),m&&f.setAngle&&f.setAngle(m),N.setMatrix(C),I.addChild(f),I.addChild(S)}p.data&&(R=e.extend(R,p.data,!0)),this._createRoundedRectangle=function(e,t,i,a,o,n){e.beginPath(),e.moveTo(t+n,i),e.lineTo(t+a-n,i),n&&e.arc(t+a-n,i+n,n,1.5*Math.PI,2*Math.PI),e.lineTo(t+a,i+o-n),n&&e.arc(t+a-n,i+o-n,n,0,.5*Math.PI),e.lineTo(t+n,i+o),n&&e.arc(t+n,i+o-n,n,.5*Math.PI,Math.PI),e.lineTo(t,i+n),n&&e.arc(t+n,i+n,n,Math.PI,1.5*Math.PI)},this._drawImage=function(e,t,i,a,o,n,r,l){e.save(),e.translate(i+o/2,a+n/2),e.scale(r?-1:1,l?-1:1),e.drawImage(t,-o/2,-n/2,o,n),e.restore()},this.getAppData=function(){return R},this.updatePosition=function(e){e&&e.position&&(R.position=e.position.clone(),S.setMatrix((new i.Matrix4).setPosition(R.position)))},this.modify=function(e){if(S.updatePosition(e),!function(e){for(var t=function(e,t){return void 0===t||JSON.stringify(t)===JSON.stringify(e)},i=Object.keys(e),a=0;a<i.length;a++)if("graphicProperties"!==i[a]&&"breakPoint2D"!==i[a]&&"position"!==i[a]&&"pointingPoints"!==i[a]){if("markerImage"===i[a]){if(R[i[a]]&&!e[i[a]]||!R[i[a]]&&e[i[a]])return!1;if(R[i[a]]!==e[i[a]]||R[i[a]]&&e[i[a]]&&(R[i[a]].width!==e[i[a]].width||R[i[a]].height!==e[i[a]].height))return!1}else if(!t(R[i[a]],e[i[a]]))return!1}else if("graphicProperties"===i[a])for(var o=Object.keys(e[i[a]]),n=0;n<o.length;n++)if("fontStyle"===o[n]||"fillStyle"===o[n]||"lineStyle"===o[n]){for(var r=Object.keys(e[i[a]][o[n]]),l=0;l<r.length;l++)if(!t(R[i[a]][o[n]][r[l]],e[i[a]][o[n]][r[l]]))return!1}else if(!t(R[i[a]][o[n]],e[i[a]][o[n]]))return!1;return!0}(e)||!f||C!==window.devicePixelRatio){if(p=e,(c=R).markerImage&&!p.markerImage||!c.markerImage&&p.markerImage||c.markerImage&&p.markerImage&&(c.markerImage.width!==p.markerImage.width||c.markerImage.height!==p.markerImage.height)||"number"==typeof p.imageWidth&&"number"==typeof c.imageWidth&&p.imageWidth!==c.imageWidth||"number"==typeof p.imageHeight&&"number"==typeof c.imageHeight&&p.imageHeight!==c.imageHeight||p.imageInvertH!==c.imageInvertH||p.imageInvertV!==c.imageInvertV||m!==c.boxRotationAngle){var i=R.mkvShape?R.mkvShape.getMarkUpGrid():null;if(i)for(var a=0;a<i.getNbofRows();a++)for(var o=0;o<i.getNbofColumns();o++)i.getMarkUpCell(a,o)&&(i.getMarkUpCell(a,o).removeCellImageToDisplay(),D.src="",D.width=1,D.height=1,D.hasBeenLoaded=!1)}!function(e){for(var t=function(e){return null!=e&&e.clone?e.clone():e},i=Object.keys(e),a=0;a<i.length;a++)if("graphicProperties"!==i[a])R[i[a]]=t(e[i[a]]);else for(var o=Object.keys(e[i[a]]),n=0;n<o.length;n++)if("fontStyle"===o[n]||"fillStyle"===o[n]||"lineStyle"===o[n])for(var r=Object.keys(e[i[a]][o[n]]),l=0;l<r.length;l++)R[i[a]][o[n]][r[l]]=t(e[i[a]][o[n]][r[l]]);else R[i[a]][o[n]]=t(e[i[a]][o[n]])}(e),I.removeChildren(),b=null,R.mkvShape&&R.mkvShape.buildGrid("undefined"!==e.userDate?e.userDate:void 0),R.tessRep&&R.tessRep.length&&(b=g.buildTessellatedRepresentationNode(R.tessRep)),b?function(){if(y={},R.isPositionProportional)y.height=R.boxHeight,y.width=R.boxWidth;else{var e=b.getBoundingBox("visibleSpace");y.width=d.convertModelToPixels({sizeInMM:Math.abs(e.max.x-e.min.x)}),y.height=d.convertModelToPixels({sizeInMM:Math.abs(e.max.y-e.min.y)});var t=d.convertModelToPixels({sizeInMM:(R.mkvShape?.5:.3)*R.graphicProperties.fontStyle.fontSize});if(R.markerImage){var i=d.convertModelToPixels({sizeInMM:R.imageHeight});i>y.height?y.height=i+t:y.height+=2*t,y.width+=d.convertModelToPixels({sizeInMM:R.imageWidth})}else y.height+=2*t;y.width+=2*t}y.width=Math.round(y.width),y.height=Math.round(y.height),y.widthInMM=d.convertPixelToModel({sizeInPixels:y.width,viewer:M}),y.heightInMM=d.convertPixelToModel({sizeInPixels:y.height,viewer:M})}():y=S.computeBoxSize(R),x?"LabelFixedSizeNode"===x.getName()?(!0===R.zoomMode&&(k.removeChildren(),x.removeChildren(),x=new t("LabelNode3D"),k.addChild(x),x.setPickParent(!0),x.addChild(N)),C!==window.devicePixelRatio&&x.setRatio(1/window.devicePixelRatio)):!1===R.zoomMode&&"LabelNode3D"===x.getName()&&(k.removeChildren(),x.removeChildren(),x=new n({name:"LabelFixedSizeNode",ratio:1/window.devicePixelRatio}),k.addChild(x),x.setPickParent(!0),x.addChild(N)):(x=R.zoomMode?new t("LabelNode3D"):new n({name:"LabelFixedSizeNode",ratio:1/window.devicePixelRatio}),k.addChild(x),x.setPickParent(!0),x.addChild(N)),m=R.boxRotationAngle?R.boxRotationAngle:0;var r=R.hasBorder?R.graphicProperties.lineStyle.thickness*window.devicePixelRatio:0;u=R.zoomMode?d.convertPixelToModel({sizeInPixels:2*r}):2*r,S.updateShapeNode&&S.updateShapeNode(R);var l=R.zoomMode?d.convertPixelToModel({sizeInPixels:2*window.devicePixelRatio}):2*window.devicePixelRatio,s=R.zoomMode?y.widthInMM:y.width,h=R.zoomMode?y.heightInMM:y.height;b?E(s,h):B(s,h,l,r),C=window.devicePixelRatio}var c,p},this.getDimensions=function(){return{width:R.zoomMode?d.convertModelToPixels({sizeInMM:y.widthInMM,coords:R.position,viewer:M}):y.width,height:R.zoomMode?d.convertModelToPixels({sizeInMM:y.heightInMM,coords:R.position,viewer:M}):y.height,offsetWidth:y.widthInMM>0?y.widthInMM:1,offsetHeight:y.heightInMM>0?y.heightInMM:1}},this.setTransformation=function(e){if(f)if(f.setAngle)f.setAngle(e.rotationAngle);else{var t=(new i.Matrix4).makeRotationZ(e.rotationAngle?e.rotationAngle:0);if(e.scaleMatrix){if(1!==e.scaleMatrix.getScaleOnAxisY()&&R.mkvShape){var a=y.width*e.scaleMatrix.getScaleOnAxisX();R.mkvShape.buildTextGrid(!0,a)}f.setMatrix(e.scaleMatrix)}N.setMatrix(t)}},this.getLabelNode=function(){return N},this.getBackNode=function(){return I},this.setGhostMode=function(e){T!==e&&(T=e,f&&f.canvasNodeTexture&&f.canvasNodeTexture.requestRedraw())},this.getGhostMode=function(){return T},this.setOpacity=function(e){z!==e&&(z=e,f&&f.canvasNodeTexture&&f.canvasNodeTexture.requestRedraw())},this.getOpacity=function(){return z},this._cleanNode=function(){k.removeChildren(),v&&v.dispose(),S.removeChildren(),S=v=R=b=P=w=k=null}},remove:function(){this._cleanNode()}})}),define("DS/DMUMarkerVisu/DMUMarkerVisuPictureShapeNode",["UWA/Core","DS/DMUMarkerVisu/DMUMarkerVisuShapeBaseNode","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/CanvasNodeTexture","DS/SceneGraphNodes/CanvasNode","DS/DMUBaseExperience/EXPUtils","DS/SceneGraphNodes/CSS3DNode","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUMarkerVisu/DMUMarkerVisuServices","DS/Mesh/Mesh"],function(e,t,i,a,o,n,r,l,s,h,d){"use strict";return t.extend({init:function(t){this._parent(t);var c,g,p,f,v=t.window,u=v.getViewer(),m=this,x=e.createElement("canvas"),w=e.createElement("canvas"),M={};function S(e,t,a,o){var n,l;t.scale(1/o,1/o);var d=t.canvas.width/(M.width+f),c=m.getAppData(),g=s.convertModelToPixels({sizeInMM:c.graphicProperties.fontStyle.fontSize})||c.graphicProperties.fontStyle.height;g*=window.devicePixelRatio;var p=(c.pointedObjectId?.5:.3)*g,v=d*M.width,u=d*(g+2*p),x=(t.canvas.width-v)/2+p,w=(t.canvas.height-u)/2+p;c.isFilled?(t.fillStyle=r.colorToHex(c.graphicProperties.fillStyle.color),t.globalAlpha=c.graphicProperties.fillStyle.opacity*(m.getGhostMode()?.6:m.getOpacity())):t.globalAlpha=0;var S=c.graphicProperties.borderRadius*d;if(m._createRoundedRectangle(t,(t.canvas.width-v)/2,(t.canvas.height-u)/2,v,u,[0,0,S,S],{top:!1,right:!0,bottom:!0,left:!0}),t.fill(),t.globalAlpha=m.getGhostMode()?.6:m.getOpacity(),t.fillStyle=r.colorToHex(c.graphicProperties.fontStyle.color),c.elementIconType){var P=16*d,y=16/c.elementIconType.height*c.elementIconType.width*d;t.font="normal "+P+"px DSFontIcon",t.fillText("",x,u-(u-P)/2-p),x+=4*p,t.drawImage(c.elementIconType,x+p,(u-P)/2,y,P),x+=y+2*p}var C=c.mkvShape?c.mkvShape.getMarkUpGrid():null;if(C)for(var D=0;D<C.getNbofRows();D++)for(var T=0;T<C.getNbofColumns();T++){if(l=C.getMarkUpCell(D,T))if(!(l.getCellImageToDisplay()||l.getCellImage())){var z=(n=l.getCellText())?n.getTextToDisplay():null;if(z&&z.length){var k=n.getFontStyle()?n.getFontStyle()+" ":"",I=n.getFontName()||"sans-serif";I.split(" ").length>1&&(I='"'+I+'"'),t.font=k+d*n.getFontSize()*window.devicePixelRatio+"px "+I;for(var b=d*c.graphicProperties.padding,N=0;N<z.length;++N)t.fillText(z[N],x+d*(0===T?c.graphicProperties.padding+l.size.paddingX:l.size.paddingX),w+b+d*(l.size.paddingY+l.size.fontHeight)),b+=d*(2*l.size.paddingY+l.size.fontHeight)}}}c.hasBorder&&(t.strokeStyle=r.colorToHex(c.graphicProperties.lineStyle.color?c.graphicProperties.lineStyle.color:r.colorToHex(new i.Color(12775156))),t.lineWidth=c.graphicProperties.lineStyle.thickness*d,c.graphicProperties.lineStyle.pattern&&t.setLineDash(h.getDashPattern(c.graphicProperties.lineStyle.pattern)),t.stroke())}this._createRoundedRectangle=function(e,t,i,a,o,n,r){e.beginPath(),e.moveTo(t+n[0],i),e[r.top?"lineTo":"moveTo"](t+a-n[1],i),n[1]&&e.arc(t+a-n[1],i+n[1],n[1],1.5*Math.PI,2*Math.PI),e[r.right?"lineTo":"moveTo"](t+a,i+o-n[2]),n[2]&&e.arc(t+a-n[2],i+o-n[2],n[2],0,.5*Math.PI),e[r.bottom?"lineTo":"moveTo"](t+n[3],i+o),n[3]&&e.arc(t+n[3],i+o-n[3],n[3],.5*Math.PI,Math.PI),e[r.left?"lineTo":"moveTo"](t,i+n[0]),n[0]&&e.arc(t+n[0],i+n[0],n[0],Math.PI,1.5*Math.PI)};var P=this.setOpacity;this.setOpacity=function(e){P(e),g&&g.canvasNodeTexture&&g.canvasNodeTexture.requestRedraw()},this.drawCanvasContent=function(e){var t=e.appData.graphicProperties.borderRadius*e.ratio;m._createRoundedRectangle(e.context,(e.context.canvas.width-e.size.width)/2,(e.context.canvas.height-e.size.height)/2,e.size.width,e.size.height,[t,t,p||e.appData.shortDisplay?t:0,p||e.appData.shortDisplay?t:0],{top:!0,right:!0,bottom:!0,left:!0}),e.context.fill(),e.context.globalAlpha=m.getGhostMode()?.6:m.getOpacity(),e.context.fillStyle=r.colorToHex(e.appData.graphicProperties.fontStyle.color);var a=e.appData.mkvShape?e.appData.mkvShape.getMarkUpGrid():null,o=function(t){t.target.hasBeenLoaded=!0,t.target.removeEventListener("load",o),t.target.listenToLoadEvt=!1,e.onCanvasRequestRedraw()};if(a)for(var n=0;n<a.getNbofRows();n++)for(var l=0;l<a.getNbofColumns();l++){var s=a.getMarkUpCell(n,l);if(s){var d=s.getCellPos(),c=s.getCellImageToDisplay()||s.getCellImage();if(c){var g,f=e.ratio*s.getCellWd(),v=e.ratio*s.getCellHt();if(e.ratio*a.getRowHt(n)<v&&(v=e.ratio*a.getRowHt(n)),e.ratio*a.getColWd(l)<f&&(f=e.ratio*a.getColWd(l)),v=Math.round(v),f=Math.round(f),!e.appData.zoomMode&&c.width&&c.height&&(c.width!==f||c.height!==v)){var u=!1;if((f!==c.width||v!==c.height)&&(c.width>f||c.height>v))x.width=c.width,x.height=c.height,x.getContext("2d").drawImage(c,0,0),u=!0;var M=c.width>f||c.height>v?c:s.getCellImage();c=c.width<f||c.height<v?M:e.imageToDisplay,w.width=f,w.height=v,w.getContext("2d").drawImage(u?x:M,0,0,w.width,w.height),g=w.toDataURL("image/png"),c.width=w.width,c.height=w.height,s.setCellImageToDisplay(c)}c.hasBeenLoaded||(c.listenToLoadEvt&&(c.removeEventListener("load",o),c.listenToLoadEvt=!1),c.addEventListener("load",o),c.listenToLoadEvt=!0,g&&(c.src=g)),this._drawImage(e.context,c,e.size.minX+e.ratio*d.x+("center"===e.appData.graphicProperties.horizontalAlignement?(e.context.canvas.width-2*e.size.minX-f)/2:0),e.size.minY+e.ratio*d.y,f,v,e.appData.imageInvertH,e.appData.imageInvertV)}}}m._createRoundedRectangle(e.context,(e.context.canvas.width-e.size.width)/2,(e.context.canvas.height-e.size.height)/2,e.size.width,e.size.height,[t,t,p||e.appData.shortDisplay?t:0,p||e.appData.shortDisplay?t:0],{top:!0,right:!0,bottom:p||e.appData.shortDisplay,left:!0}),e.appData.hasBorder&&(e.context.strokeStyle=r.colorToHex(e.appData.graphicProperties.lineStyle.color?e.appData.graphicProperties.lineStyle.color:r.colorToHex(new i.Color(12775156))),e.context.lineWidth=e.appData.graphicProperties.lineStyle.thickness*e.ratio,e.appData.graphicProperties.lineStyle.pattern&&e.context.setLineDash(h.getDashPattern(e.appData.graphicProperties.lineStyle.pattern)),e.context.stroke())},this.computeBoxSize=function(e){M={};var t=null;if(e.mkvShape&&(t=e.mkvShape.getMarkUpGrid()),t){M.height=0,M.width=0,M.height+=t.getRowHt(0),isNaN(M.height)&&(M.height=1);for(var i=0;i<t.getNbofColumns();i++)M.width+=t.getColWd(i);isNaN(M.width)&&(M.width=1),t.getNbofColumns()>1&&(M.width-=e.graphicProperties.padding)}return M.width+=2*e.graphicProperties.padding,M.height+=2*e.graphicProperties.padding,M.width=Math.round(M.width),M.height=Math.round(M.height),M.widthInMM=s.convertPixelToModel({sizeInPixels:M.width,viewer:u}),M.heightInMM=s.convertPixelToModel({sizeInPixels:M.height,viewer:u}),M},this.updateShapeNode=function(r){p=!1;var h=r.hasBorder?r.graphicProperties.lineStyle.thickness*window.devicePixelRatio:0;f=r.zoomMode?s.convertPixelToModel({sizeInPixels:2*h}):2*h,c=r.shortDisplay;var v,x,w,P,y=m.getLabelNode();if(g&&(y.removeChild(g),g=null),!c){var C=s.convertModelToPixels({sizeInMM:r.graphicProperties.fontStyle.fontSize})||r.graphicProperties.fontStyle.height;C*=window.devicePixelRatio;var D=(r.pointedObjectId?.5:.3)*C;if(v=M.width+f,P=new o({width:v,height:x=C+2*D+f,webGLV6Viewer:u,drawCB:S,rectangleTexture:!0,materialParams:{depthTest:!1}}),(w=new n({bottomLeftcorner:new i.Vector3(-v/2,-x/2,0),widthVector:new i.Vector3(v,0,0),heightVector:new i.Vector3(0,x,0),canvasNodeTexture:P},a)).rectangle.setRenderDepth(10),w.rectangle.excludeFromHighlight(!0,!0),w.rectangle.setPickable(d.PICKTHROUGH),g=w,r.pointedObjectId){var T=e.createElement("div",{id:"DMUDraggablePictureDiv",draggable:!0,styles:{width:M.width-D-f/2,height:C+D-f/2,cursor:"grab"}});t.onDragStart&&T.addEventListener("dragstart",t.onDragStart),g.addChild(new l(T,1))}var z="topleft"===r.anchorMode?(new i.Matrix4).makeTranslation(M.width/2,-M.height-(C+2*D)/2,0):(new i.Matrix4).makeTranslation(0,-M.height/2-(C+2*D)/2,0);g.setMatrix(z),g.setNoZ(!0),y.addChild(g)}};var y=m.setTransformation;this.setTransformation=function(e){e.scaleMatrix&&1!==e.scaleMatrix.getScaleOnAxisY()&&(!g||c||p||(p=!0,g.setVisibility(!1))),y(e)};var C=m._cleanNode;this._cleanNode=function(){c=!1,m=v=x=w=null,C()}}})}),define("DS/DMUMarkerVisu/DMUMarkerVisuTextShapeNode",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/DMUMarkerVisu/DMUMarkerVisuShapeBaseNode","DS/DMUBaseExperience/EXPUtils","DS/DMUControls/DMUHTMLBox","DS/VisuEvents/EventsManager","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUMarkerVisu/DMUMarkerVisuServices"],function(e,t,i,a,o,n,r,l){"use strict";return i.extend({init:function(i){this._parent(i);var s,h,d,c,g=i.window,p=g.getViewer(),f=this,v=e.createElement("canvas"),u=e.createElement("canvas"),m={};this.drawCanvasContent=function(e){var i=e.appData.graphicProperties.borderRadius*e.ratio;f._createRoundedRectangle(e.context,(e.context.canvas.width-e.size.width)/2,(e.context.canvas.height-e.size.height)/2,e.size.width,e.size.height,i),e.context.fill(),e.context.globalAlpha=f.getGhostMode()?.6:e.opacity?e.opacity:1,e.context.fillStyle=a.colorToHex(e.appData.graphicProperties.fontStyle.color);var o=e.appData.mkvShape?e.appData.mkvShape.getMarkUpGrid():null,n=function(t){t.target.hasBeenLoaded=!0,t.target.removeEventListener("load",n),t.target.listenToLoadEvt=!1,e.onCanvasRequestRedraw()};if(o)for(var r=0;r<o.getNbofRows();r++)for(var s=0;s<o.getNbofColumns();s++){var h=o.getMarkUpCell(r,s);if(h){var d=h.getCellPos(),c=h.getCellImageToDisplay()||h.getCellImage();if(c){var g,p=e.ratio*h.getCellWd(),m=e.ratio*h.getCellHt();if(e.ratio*o.getRowHt(r)<m&&(m=e.ratio*o.getRowHt(r)),e.ratio*o.getColWd(s)<p&&(p=e.ratio*o.getColWd(s)),m=Math.round(m),p=Math.round(p),!e.appData.zoomMode&&c.width&&c.height&&(c.width!==p||c.height!==m)&&(c.width>300||c.height>300)){var x=!1;if(p!==c.width||m!==c.height)v.width=c.width,v.height=c.height,v.getContext("2d").drawImage(c,0,0),x=!0;var w=c;c=e.imageToDisplay,u.width=p,u.height=m,u.getContext("2d").drawImage(x?v:w,0,0,u.width,u.height),g=u.toDataURL("image/png"),c.width=u.width,c.height=u.height,h.setCellImageToDisplay(c)}c.hasBeenLoaded||(c.listenToLoadEvt&&(c.removeEventListener("load",n),c.listenToLoadEvt=!1),c.addEventListener("load",n),c.listenToLoadEvt=!0,g&&(c.src=g)),f._drawImage(e.context,c,e.size.minX+e.ratio*d.x+("center"===e.appData.graphicProperties.horizontalAlignement?(e.context.canvas.width-2*e.size.minX-p)/2:0),e.size.minY+e.ratio*d.y,p,m,e.appData.imageInvertH,e.appData.imageInvertV)}else{var M=h.getCellText(),S=M?M.getTextToDisplay():null;if(S&&S.length){var P=M.getFontStyle()?M.getFontStyle()+" ":"",y=M.getFontName()||"sans-serif";y.split(" ").length>1&&(y='"'+y+'"'),e.context.font=P+e.ratio*M.getFontSize()*window.devicePixelRatio+"px "+y;for(var C=e.ratio*e.appData.graphicProperties.padding,D=0;D<S.length;++D)e.context.fillText(S[D],e.size.minX+e.ratio*((0===s?e.appData.graphicProperties.padding+h.size.paddingX:h.size.paddingX)+d.x),e.size.minY+C+e.ratio*(h.size.paddingY+h.size.fontHeight+d.y)),C+=e.ratio*(2*h.size.paddingY+h.size.fontHeight)}}}}e.appData.hasBorder&&(e.context.strokeStyle=a.colorToHex(e.appData.graphicProperties.lineStyle.color?e.appData.graphicProperties.lineStyle.color:a.colorToHex(new t.Color(12775156))),e.context.lineWidth=e.appData.graphicProperties.lineStyle.thickness*e.ratio,e.appData.graphicProperties.lineStyle.pattern&&e.context.setLineDash(l.getDashPattern(e.appData.graphicProperties.lineStyle.pattern)),e.context.stroke())},this.computeBoxSize=function(e){var t;if(m={},e.mkvShape&&(t=e.mkvShape.getMarkUpGrid()),t){m.height=0,m.width=0;for(var i=0;i<t.getNbofRows();i++)m.height+=t.getRowHt(i);isNaN(m.height)&&(m.height=1);for(var a=0;a<t.getNbofColumns();a++)m.width+=t.getColWd(a);isNaN(m.width)&&(m.width=1),t.getNbofColumns()>1&&(m.width-=e.graphicProperties.padding)}return m.width+=2*e.graphicProperties.padding,m.height+=2*e.graphicProperties.padding,m.width=Math.round(m.width),m.height=Math.round(m.height),m.widthInMM=r.convertPixelToModel({sizeInPixels:m.width,viewer:p}),m.heightInMM=r.convertPixelToModel({sizeInPixels:m.height,viewer:p}),m},this.startEdition=function(e){if(f.setVisibility(!1),!s){c||(c=function(e){if(s){var t=e.force;if(!t){for(var a=e.from[0].view,o=!1;a&&!o;)a.className&&-1!==a.className.indexOf("DMUHTMLBox")&&(o=!0),a=a.parentNode;t=!o}t&&(i.onContentModifiedCB&&i.onContentModifiedCB({text:s.getText()}),f.stopEdition())}},p&&(p.setPicking({trapSelection:!1}),d||(d=p.onSwapVisibleSpace(function(){c({force:!0})}))),n.addEvent(p.canvas,"onLeftMouseDown",c),n.addEvent(p.canvas,"onTouch",c)),s=new o({parentNode:e,window:g,viewer:p,onTextModifiedCB:function(){i.onContentModifiedCB&&i.onContentModifiedCB({text:s.getText()})},onTextModificationEndCB:function(){i.onContentModifiedCB&&i.onContentModifiedCB({text:s.getText()}),f.stopEdition()}});var t={size:0,style:"",content:"",name:"sans-serif",lineHeight:"1.3em"},a=f.getAppData();if(a.mkvShape){var r=a.mkvShape.getMarkUpGrid();r&&(t=function(e){for(var t={size:null,style:null,content:null,name:null,lineHeight:null},i=0;i<e.getNbofColumns();i++)for(var a=0;a<e.getNbofRows();a++){var o=e.getMarkUpCell(a,i);if(o){var n=o.getCellText();n&&(t.size||(t.size=n.getFontSize()*window.devicePixelRatio),t.style||(t.style=n.getFontStyle()),t.content||(t.content=n.getTextContent()),t.name||(t.name=n.getFontName())),t.lineHeight||(t.lineHeight=o.size.fontHeight),t.paddingY||(t.paddingY=o.size.paddingY),t.paddingX||(t.paddingX=o.size.paddingX)}}return t}(r))}s.update({bEditable:!0,bHasALeader:!0,anchorMode:a.anchorMode,position:a.position.clone(),rotationAngle:a.boxRotationAngle,bIsFilled:a.isFilled,bHasBorder:a.hasBorder,cFontColor:a.graphicProperties.fontStyle.color,sFontName:t.name,iFontSize:t.size/window.devicePixelRatio+"px",sFontStyle:t.style,fOpacity:a.graphicProperties.fillStyle.opacity,cFillStyleColor:a.graphicProperties.fillStyle.color,cLineStyleColor:a.graphicProperties.lineStyle.color,fLineStyleThickness:a.graphicProperties.lineStyle.thickness+"px",sTextContents:t.content,lineHeight:(t.lineHeight+2*t.paddingY)/window.devicePixelRatio+"px",borderRadius:a.graphicProperties.borderRadius/window.devicePixelRatio+"px",padding:a.graphicProperties.padding/window.devicePixelRatio+"px "+(a.graphicProperties.padding+t.paddingX)/window.devicePixelRatio+"px"}),h=t.content,s.focusAndSelectText(),g&&g.getContextualUIManager().deactivateContextualBar(),i.onStartContentEditionCB&&i.onStartContentEditionCB(),p.render()}},this.stopEdition=function(){if(s){f.setVisibility(!0);var e,t=s.getText();for(s.remove(),s=null,e=t.length-1;e>=0&&(!t[e]||1===t[e].length&&10===t[e].charCodeAt());e--)t.splice(e,1);var a=!1;for(e=0;e<t.length;e++)if(t[e].length>1||1===t[e].length&&10!==t[e].charCodeAt()){a=!0;break}a||(t=h),i.onContentModifiedCB({text:t}),h=null,p.setPicking({trapSelection:!0}),i.onEndContentEditionCB&&i.onEndContentEditionCB(),d&&p&&(p.unsubscribe(d),d=0),c&&(n.removeEvent(p.canvas,"onLeftMouseDown",c),n.removeEvent(p.canvas,"onTouch",c),c=null),g&&g.getContextualUIManager().activateContextualBar()}};var x=f.updatePosition;this.updatePosition=function(e){x(e);var t=f.getAppData();e&&e.position&&t&&s&&s.update({position:t.position,anchorMode:e.anchorMode})};var w=f._cleanNode;this._cleanNode=function(){f.stopEdition(),f=s=g=v=u=c=null,w()}}})}),define("DS/DMUMarkerVisu/DMUMarkerVisuMeasureShapeNode",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/DMUMarkerVisu/DMUMarkerVisuShapeBaseNode","DS/DMUBaseExperience/EXPUtils","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUMarkerVisu/DMUMarkerVisuServices"],function(e,t,i,a,o,n){"use strict";return i.extend({init:function(i){this._parent(i);var r=i.window,l=r.getViewer(),s=this,h=e.createElement("canvas");h.width=1e3,h.height=300;var d={};function c(e,t){for(var i=e.getImageData(0,0,h.width,h.height).data,a=!1,o=!1,n=h.height,r=0,l=0;!o&&n;)for(n--,r=0;r<t;r++)if(i[n*h.width*4+4*r+3]){o=n;break}for(n=-1;n<h.height&&!a;){for(n++,r=0;r<t;r++)if(i[n*h.width*4+4*r+3]){a=n;break}a&&o&&(l=o-a)}return l}this.drawCanvasContent=function(e){var i=e.appData.graphicProperties.borderRadius*e.ratio;if(this._createRoundedRectangle(e.context,(e.context.canvas.width-e.size.width)/2,(e.context.canvas.height-e.size.height)/2,e.size.width,e.size.height,i),e.context.fill(),e.appData.hasBorder&&(e.context.strokeStyle=a.colorToHex(e.appData.graphicProperties.lineStyle.color?e.appData.graphicProperties.lineStyle.color:a.colorToHex(new t.Color(12775156))),e.context.lineWidth=e.appData.graphicProperties.lineStyle.thickness*e.ratio,e.appData.graphicProperties.lineStyle.pattern&&e.context.setLineDash(n.getDashPattern(e.appData.graphicProperties.lineStyle.pattern)),e.context.stroke()),e.context.globalAlpha=s.getGhostMode()?.6:s.getOpacity(),e.context.fillStyle=a.colorToHex(e.appData.graphicProperties.fontStyle.color),e.appData.content&&e.appData.content.length){var o=e.appData.graphicProperties.fontStyle.familyStyle?e.appData.graphicProperties.fontStyle.familyStyle+" ":"",r=e.appData.graphicProperties.fontStyle.familyName||"sans-serif";r.split(" ").length>1&&(r='"'+r+'"'),e.context.font=o+e.ratio*e.appData.graphicProperties.fontStyle.height*window.devicePixelRatio+"px "+r;for(var l=e.ratio*e.appData.graphicProperties.padding,h=0;h<e.appData.content.length;++h)e.context.fillText(e.appData.content[h],e.size.minX+e.ratio*(e.appData.graphicProperties.padding+d.paddingBorder),e.size.minY+l+e.ratio*((0===h?d.paddingBorder:d.paddingY)+d.fontHeight)),l+=e.ratio*((0===h?d.paddingBorder+d.paddingY:2*d.paddingY)+d.fontHeight);if(e.appData.commentContent&&e.appData.commentContent.length){var c=e.appData.graphicProperties.fontStyleComment.familyStyle?e.appData.graphicProperties.fontStyleComment.familyStyle+" ":"",g=e.appData.graphicProperties.fontStyleComment.familyName||"sans-serif";g.split(" ").length>1&&(g='"'+g+'"'),e.context.font=c+e.ratio*e.appData.graphicProperties.fontStyleComment.height*window.devicePixelRatio+"px "+g;for(var p=0;p<e.appData.commentContent.length;++p)e.context.fillText(e.appData.commentContent[p],e.size.minX+e.ratio*(e.appData.graphicProperties.padding+d.paddingBorder),e.size.minY+l+e.ratio*(d.paddingYComment+d.fontHeightComment)),l+=e.ratio*(2*d.paddingYComment+d.fontHeightComment)}}},this.computeBoxSize=function(e){if(d={},e.content&&e.content.length){var t=e.graphicProperties.fontStyle.familyStyle?e.graphicProperties.fontStyle.familyStyle+" ":"";t+=e.graphicProperties.fontStyle.height*window.devicePixelRatio+"px ",e.graphicProperties.fontStyle.familyName.split(" ").length>1?t+='"'+e.graphicProperties.fontStyle.familyName+'"':t+=e.graphicProperties.fontStyle.familyName,d.fontHeight=0,d.width=0,d.fontHeightComment=0;var i=h.getContext("2d");i.font=t;for(var a="",n=0,r=0;r<e.content.length;r++){a=e.content[r]?e.content[r]:"aA_{}",i.clearRect(0,0,h.width,h.height),i.fillText(a,0,h.height);var s=i.measureText(a).width;d.width=Math.max(s,d.width),d.fontHeight=Math.max(c(i,s),d.fontHeight)}if(e.commentContent&&e.commentContent.length){n=e.commentContent.length;var g=e.graphicProperties.fontStyleComment.familyStyle?e.graphicProperties.fontStyleComment.familyStyle+" ":"",p=e.graphicProperties.fontStyleComment.familyName?e.graphicProperties.fontStyleComment.familyName:"sans-serif";p.split(" ").length>1&&(p='"'+p+'"'),i.font=g+e.graphicProperties.fontStyleComment.height*window.devicePixelRatio+"px "+p;for(var f=0;f<e.commentContent.length;f++){a=e.commentContent[f]?e.commentContent[f]:"aA_{}",i.clearRect(0,0,h.width,h.height),i.fillText(a,0,h.height);var v=i.measureText(a).width;d.width=Math.max(v,d.width),d.fontHeightComment=Math.max(c(i,v),d.fontHeightComment)}}d.paddingY=Math.floor(.5*d.fontHeight),d.paddingYComment=Math.floor(.5*d.fontHeightComment),d.paddingBorder=Math.max(d.paddingY,d.paddingYComment),d.width+=2*d.paddingBorder,d.height=(d.fontHeight+2*d.paddingY)*e.content.length-d.paddingY,n?d.height+=(d.fontHeightComment+2*d.paddingYComment)*n-d.paddingYComment:d.height-=d.paddingY,d.height+=2*d.paddingBorder,isNaN(d.width)&&(d.width=1)}return d.width+=2*e.graphicProperties.padding,d.height+=2*e.graphicProperties.padding,d.width=Math.round(d.width),d.height=Math.round(d.height),d.widthInMM=o.convertPixelToModel({sizeInPixels:d.width,viewer:l}),d.heightInMM=o.convertPixelToModel({sizeInPixels:d.height,viewer:l}),d};var g=s._cleanNode;this._cleanNode=function(){s=r=h=null,g()}},remove:function(){this._cleanNode()}})}),define("DS/DMUMarkerVisu/DMUMarkerVisuStampShapeNode",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/EXPUtils","DS/DMUControls/DMUHTMLBox","DS/VisuEvents/EventsManager","DS/WebappsUtils/WebappsUtils","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUMarkerVisu/DMUMarkerVisuShapeBaseNode","DS/DMUMarkerVisu/DMUMarkerVisuServices","DS/DMUBaseUI/DMUToolsUsers"],function(e,t,i,a,o,n,r,l,s,h){"use strict";return l.extend({init:function(l){this._parent(l);var d,c,g,p,f=this,v=l.window,u=v.getViewer(),m=e.createElement("canvas"),x={};let w,M="";h.getImage(n.getWebappsAssetUrl("DMUBaseUI","icons/I_DefaultUserPic.png"),function(e,t){t||(M=e),w&&"function"==typeof w&&w()});var S=setInterval(function(){var e=f.getAppData();if(e&&e.mkvShape&&e.userDate&&e.userDate.length){var t=[e.userDate[0],h.formatDate(e.creationDate)];e.mkvShape&&e.mkvShape.buildGrid("undefined"!==t?t:void 0),w&&"function"==typeof w&&w()}},6e4);let P=0;this.computeBoxSize=function(e){var t;if(x={},e.mkvShape&&(t=e.mkvShape.getMarkUpGrid()),t){x.height=0,x.width=0;for(var i=0;i<t.getNbofRows();i++)t.getNbofRows()>1&&0===i&&30===t.getRowHt(i)?(x.height+=t.getMarkUpCell(0,1).size.height,P=30-t.getMarkUpCell(0,1).size.height):x.height+=t.getRowHt(i);isNaN(x.height)&&(x.height=1);for(var a=0;a<t.getNbofColumns();a++)x.width+=t.getColWd(a);isNaN(x.width)&&(x.width=1)}return x.width+=2*e.graphicProperties.padding,x.height+=2*e.graphicProperties.padding,x.width=Math.round(x.width+8),x.height=Math.round(x.height),x.widthInMM=r.convertPixelToModel({sizeInPixels:x.width,viewer:u}),x.heightInMM=r.convertPixelToModel({sizeInPixels:x.height,viewer:u}),x},this.startEdition=function(e){if(f.setVisibility(!1),!c){p||(p=function(e){if(c){var t=e.force;if(!t){for(var i=e.from[0].view,a=!1;i&&!a;)i.className&&-1!==i.className.indexOf("DMUHTMLBox")&&(a=!0),i=i.parentNode;t=!a}t&&(l.onContentModifiedCB&&l.onContentModifiedCB({text:c.getText()}),f.stopEdition())}},u&&(u.setPicking({trapSelection:!1}),g||(g=u.onSwapVisibleSpace(function(){p({force:!0})}))),o.addEvent(u.canvas,"onLeftMouseDown",p),o.addEvent(u.canvas,"onTouch",p)),c=new a({parentNode:e,window:v,viewer:u,onTextModifiedCB:function(){l.onContentModifiedCB&&l.onContentModifiedCB({text:c.getText()})},onTextModificationEndCB:function(){l.onContentModifiedCB&&l.onContentModifiedCB({text:c.getText()}),f.stopEdition()}});var t,i,n={size:0,style:"",content:"",name:"sans-serif",lineHeight:"1.3em"},r=f.getAppData();if(r.mkvShape){var s=r.mkvShape.getMarkUpGrid();s&&(n=function(e){var t={size:null,style:null,content:null,name:null,lineHeight:null},i=e.getMarkUpCell(e.getNbofRows()-1,e.getNbofColumns()-1);if(i){var a=i.getCellText();a&&(t.size||(t.size=a.getFontSize()*window.devicePixelRatio),t.style||(t.style=a.getFontStyle()),t.content||(t.content=a.getTextContent()),t.name||(t.name=a.getFontName())),t.lineHeight||(t.lineHeight=i.size.fontHeight),t.paddingY||(t.paddingY=i.size.paddingY),t.paddingX||(t.paddingX=i.size.paddingX)}return t}(s));var h=s.getMarkUpCell(1,1);if(h)t=h.getCellText().getFontStyle();(h=s.getMarkUpCell(0,0))&&(i=h.getCellImageToDisplay()||h.getCellImage())}var d=((n.lineHeight+2*n.paddingY)/window.devicePixelRatio!=0?(n.lineHeight+2*n.paddingY)/window.devicePixelRatio:(r.graphicProperties.fontStyle.height+2*r.graphicProperties.padding)/window.devicePixelRatio)+"px",m={owner:r.userDate,content:r.content,stampColor:"Rejected"===r.stampType?"#ff0000":"#008000",stampFontStyle:t,ownerColor:"#4796c7",dateColor:"#a8aaac",leftBorder:"Rejected"===r.stampType?"8px solid red":"8px solid green",imgURL:i&&i.src?i.src:M,dateFontSize:n.size/window.devicePixelRatio*.75+"px"};c.update({bEditable:!0,anchorMode:r.anchorMode,position:r.position.clone(),bIsFilled:r.isFilled,bHasBorder:r.hasBorder,cFontColor:r.graphicProperties.fontStyle.color,rotationAngle:r.boxRotationAngle,sFontName:n.name,iFontSize:n.size/window.devicePixelRatio+"px",sFontStyle:n.style,fOpacity:r.graphicProperties.fillStyle.opacity,cFillStyleColor:r.graphicProperties.fillStyle.color,cLineStyleColor:r.graphicProperties.lineStyle.color,fLineStyleThickness:r.graphicProperties.lineStyle.thickness+"px",sTextContents:n.content,lineHeight:d,lOwnerData:m,padding:r.graphicProperties.padding/window.devicePixelRatio+"px"}),c.focusAndSelectText(),v&&v.getContextualUIManager().deactivateContextualBar(),l.onStartContentEditionCB&&l.onStartContentEditionCB(),u.render()}},this.stopEdition=function(){if(c){f.setVisibility(!0);var e,t=c.getText();for(c.remove(),c=null,e=t.length-1;e>=0&&(!t[e]||1===t[e].length&&10===t[e].charCodeAt());e--)t.splice(e,1);var i=!1;for(e=0;e<t.length;e++)if(t[e].length>1||1===t[e].length&&10!==t[e].charCodeAt()){i=!0;break}i||(t=[""]),l.onContentModifiedCB({text:t}),u.setPicking({trapSelection:!0}),l.onEndContentEditionCB&&l.onEndContentEditionCB(),g&&u&&(u.unsubscribe(g),g=0),p&&(o.removeEvent(u.canvas,"onLeftMouseDown",p),o.removeEvent(u.canvas,"onTouch",p),p=null),v&&v.getContextualUIManager().activateContextualBar()}};var y=f.updatePosition;this.updatePosition=function(e){y(e);var t=f.getAppData();e&&e.position&&t&&c&&c.update({position:t.position,anchorMode:e.anchorMode})};var C=f._cleanNode;this._cleanNode=function(){f.stopEdition(),f=c=v=m=p=null,w=null,C(),clearInterval(S),S=null},this.drawCanvasContent=function(e){w=e.onCanvasRequestRedraw,d=e.appData.stampType,f._createRoundedRectangle(e.context,(e.context.canvas.width-e.size.width)/2,(e.context.canvas.height-e.size.height)/2,e.size.width,e.size.height,e.appData.graphicProperties.borderRadius*e.ratio),e.context.fill(),e.appData.hasBorder&&(e.context.strokeStyle=i.colorToHex(e.appData.graphicProperties.lineStyle.color?e.appData.graphicProperties.lineStyle.color:i.colorToHex(new t.Color(12775156))),e.context.lineWidth=e.appData.graphicProperties.lineStyle.thickness*e.ratio,e.appData.graphicProperties.lineStyle.pattern&&e.context.setLineDash(s.getDashPattern(e.appData.graphicProperties.lineStyle.pattern)),e.context.stroke()),e.context.globalAlpha=f.getGhostMode()?.6:e.opacity?e.opacity:1,e.context.save(),e.context.strokeStyle=null,e.context.lineWidth=0,e.context.globalAlpha=f.getGhostMode()?.6:f.getOpacity(),e.context.fillStyle="Rejected"===d?"#ff0000":"#008000",e.context.beginPath(),e.context.moveTo((e.context.canvas.width-e.size.width)/2+e.appData.graphicProperties.lineStyle.thickness/2,(e.context.canvas.height-e.size.height)/2),e.context.lineTo((e.context.canvas.width-e.size.width)/2+e.appData.graphicProperties.lineStyle.thickness/2+8,(e.context.canvas.height-e.size.height)/2),e.context.lineTo((e.context.canvas.width-e.size.width)/2+e.appData.graphicProperties.lineStyle.thickness/2+8,(e.context.canvas.height-e.size.height)/2+e.size.height),e.context.lineTo((e.context.canvas.width-e.size.width)/2+e.appData.graphicProperties.lineStyle.thickness/2,(e.context.canvas.height-e.size.height)/2+e.size.height),e.context.closePath(),e.context.fill(),e.context.restore(),e.context.fillStyle=i.colorToHex(e.appData.graphicProperties.fontStyle.color);var a=e.appData.mkvShape?e.appData.mkvShape.getMarkUpGrid():null;let o=e.size.minX+e.ratio*e.appData.graphicProperties.padding+8,n=e.size.minY+e.ratio*e.appData.graphicProperties.padding;var r=function(e){e.target.hasBeenLoaded=!0,e.target.removeEventListener("load",r),e.target.removeEventListener("error",r),e.target.listenToLoadEvt=!1,w&&"function"==typeof w&&w()};if(a){var l,h,c,g,p,v=a.getMarkUpCell(0,0);if(v){l=v.getCellPos();var u=v.getCellImageToDisplay()||v.getCellImage();if(u){var x=e.ratio*v.getCellWd(),S=e.ratio*v.getCellHt();e.ratio*a.getRowHt(0)<S&&(S=e.ratio*a.getRowHt(0)),e.ratio*a.getColWd(0)<x&&(x=e.ratio*a.getColWd(0)),S=Math.round(S),x=Math.round(x),u.hasBeenLoaded||(M&&u.listenToLoadEvt&&(u.removeEventListener("load",r),u.removeEventListener("error",r),u.listenToLoadEvt=!1),u.addEventListener("load",r),u.addEventListener("error",function(e){M&&(u.src=M,r(e))}),u.listenToLoadEvt=!0,u.src=u.src||M),m.width=x,m.height=S;let t=m.getContext("2d"),i=0,l=0,s=17*window.devicePixelRatio,h=x,d=S;t.beginPath(),t.moveTo(i+s,l),t.lineTo(i+h-s,l),t.quadraticCurveTo(i+h,l,i+h,l+s),t.lineTo(i+h,l+d-s),t.quadraticCurveTo(i+h,l+d,i+h-s,l+d),t.lineTo(i+s,l+d),t.quadraticCurveTo(i,l+d,i,l+d-s),t.lineTo(i,l+s),t.quadraticCurveTo(i,l,i+s,l),t.closePath(),t.clip(),f._drawImage(t,u,0,0,x,S),f._drawImage(e.context,m,o,n,x,S)}}if((v=a.getMarkUpCell(0,1))&&(l=v.getCellPos())&&(c=(h=v.getCellText())?h.getTextToDisplay():null)&&c.length){g=h.getFontStyle()?h.getFontStyle()+" ":"",(p=h.getFontName()||"sans-serif").split(" ").length>1&&(p='"'+p+'"'),e.context.font=g+e.ratio*h.getFontSize()*window.devicePixelRatio+"px "+p;var y=c;if(2===y.length){e.context.fillStyle="#4796c7";var C=y[0];e.context.fillText(C,o+e.ratio*v.size.paddingX+l.x,n+e.ratio*(v.size.paddingY+v.size.fontHeight+l.y));const t=e.context.measureText(C);var D=y[1];e.context.font=g+e.ratio*h.getFontSize()*window.devicePixelRatio*.75+"px "+p,e.context.fillStyle="#a8aaac",e.context.fillText(D,t.width+o+l.x+2*e.ratio*v.size.paddingX,n+e.ratio*(v.size.paddingY+v.size.fontHeight+l.y))}}if((v=a.getMarkUpCell(1,1))&&(l=v.getCellPos())&&(c=(h=v.getCellText())?h.getTextToDisplay():null)&&c.length&&(g=h.getFontStyle()?h.getFontStyle()+" ":"",(p=h.getFontName()||"sans-serif").split(" ").length>1&&(p='"'+p+'"'),e.context.font=g+e.ratio*h.getFontSize()*window.devicePixelRatio+"px "+p,e.context.fillStyle="Rejected"===d?"#ff0000":"#008000",e.context.fillText(c[0],o+e.ratio*v.size.paddingX+l.x,n+e.ratio*(v.size.paddingY+v.size.fontHeight+l.y-P))),(v=a.getMarkUpCell(2,1))&&(l=v.getCellPos())&&(c=(h=v.getCellText())?h.getTextToDisplay():null)&&c.length){g=h.getFontStyle()?h.getFontStyle()+" ":"",(p=h.getFontName()||"sans-serif").split(" ").length>1&&(p='"'+p+'"'),e.context.font=g+e.ratio*h.getFontSize()*window.devicePixelRatio+"px "+p,e.context.fillStyle=i.colorToHex(new t.Color(e.appData.graphicProperties.fontStyle.color));let a=0;for(var T=0;T<c.length;++T)e.context.fillText(c[T],o+e.ratio*v.size.paddingX+l.x,n+a+e.ratio*(v.size.paddingY+v.size.fontHeight+l.y-P)),a+=e.ratio*(2*v.size.paddingY+v.size.fontHeight)}}}}})}),define("DS/DMUMarkerVisu/DMUMarkerVisuCell",["UWA/Class","DS/DMUMarkerVisu/DMUMarkerVisuText"],function(e,t){"use strict";return e.extend({init:function(){var e=[1,1],i=null,a={x:0,y:0},o=0,n=0,r=null,l=null;this.getCellText=function(){return i||r||(i=new t),i},this.getCellImage=function(){return r},this.setCellImage=function(e){(!r||e&&e.src!==r.src)&&(r=e,l=null)},this.getCellImageToDisplay=function(){return l},this.setCellImageToDisplay=function(e){l&&(!e||e.width===l.width&&e.height===l.height&&e.src===l.src)||(l=e)},this.removeCellImageToDisplay=function(){l=null},this.setCellIndex=function(t,i){e[0]=t,e[1]=i},this.getCellIndex=function(){var t={};return t.row=e[0],t.col=e[1],t},this.getCellPos=function(){return a},this.setCellPos=function(e){a=e},this.getCellWd=function(){return o},this.setCellWd=function(e){o=e},this.getCellHt=function(){return n},this.setCellHt=function(e){n=e}}})}),define("DS/DMUMarkerVisu/DMUMarkerVisuGrid",["UWA/Core","UWA/Class","DS/DMUMarkerVisu/DMUMarkerVisuCell"],function(e,t,i){"use strict";return t.extend({init:function(){this._parent();var t=1,a=1,o=[],n=[0],r=[0],l=[0],s=e.createElement("canvas");s.width=1e3,s.height=300;var h=new i;h.setCellIndex(0,0),o.push(h);var d=this;function c(e,t){l[e]=t}function g(e,t){for(var i=e.getImageData(0,0,s.width,s.height).data,a=!1,o=!1,n=s.height,r=0,l=0;!o&&n;)for(n--,r=0;r<t;r++)if(i[n*s.width*4+4*r+3]){o=n;break}for(n=-1;n<s.height&&!a;){for(n++,r=0;r<t;r++)if(i[n*s.width*4+4*r+3]){a=n;break}a&&o&&(l=o-a)}return l}function p(e,t){var i=e.getCellText(),a=i?i.getTextToDisplay():null;if(function(e){if(e&&e.length)for(var t=0;t<e.length;t++)if(e[t].length)return!0;return!1}(a)){var o=i.getFontSize(),n=i.getFontName()||"sans-serif";n.split(" ").length>1&&(n='"'+n+'"');var r=i.getFontStyle()||"",l=void 0===e.size;if(l||(l=(l=(l=(l=o!==e.size.fontSize)||JSON.stringify(a)!==e.size.textContent)||r!==e.size.fontStyle)||n!==e.size.fontName),l){e.size={};var h=r?r+" ":"";h+=o*window.devicePixelRatio+"px ",h+=n,e.size.fontHeight=0,e.size.width=0;var d=s.getContext("2d");d.font=h;for(var c="",p=0,f=0;f<a.length;++f){c=a[f]?a[f]:"aA_{}",d.clearRect(0,0,s.width,s.height),d.fillText(c,0,s.height);var v=d.measureText(c).width;if(!0===t)v=p+=v,h=r?r+" ":"",h+=o*window.devicePixelRatio*.75+"px ",h+=n,d.font=h;e.size.width=Math.max(v,e.size.width),e.size.fontHeight=Math.max(g(d,v),e.size.fontHeight)}e.size.paddingY=Math.floor(.5*e.size.fontHeight),e.size.paddingX=Math.floor(.5*e.size.fontHeight),e.size.width+=(t?3:2)*e.size.paddingX,e.size.height=(e.size.fontHeight+2*e.size.paddingY)*(t?1:a.length),e.size.fontStyle=r,e.size.textContent=JSON.stringify(a),e.size.fontSize=o}}else e.size={},e.size.width=e.getCellWd(),e.size.height=e.getCellHt(),e.size.fontHeight=0;return e.size}function f(){o=[],n=[0],l=[0],r=[0],t=1,a=1;var e=new i;e.setCellIndex(0,0),o.push(e)}this.updateGrid=function(e){var i,o,l,s,h,g,f,v,u,m=!1;for(l=0;l<a;l++){for(i=0,s=0;s<t;s++)if(h=d.getMarkUpCell(s,l)){if(e&&e.length)for(f=0;f<e.length;f++)e[f].row===s&&e[f].column===l&&(m=!0);g=p(h,m),m=!1,i<g.width&&(i=g.width)}v=i,r[l]=v}for(m=!1,s=0;s<t;s++){o=0;var x=0;for(l=0;l<a;l++)if(h=d.getMarkUpCell(s,l)){if(e&&e.length)for(f=0;f<e.length;f++)e[f].row===s&&e[f].column===l&&(m=!0);g=p(h,m),m=!1,o=Math.max(g.height,o),x=Math.max(g.charHeight,x)}u=o,n[s]=u,c(s,x)}var w=0,M=0;for(l=0;l<t;l++){for(o=n[l],w=0,s=0;s<a;s++){if(i=r[s],h=d.getMarkUpCell(l,s)){var S={};S.x=w,S.y=M,h.setCellPos(S)}w+=i}M+=o}},this.getMarkUpCell=function(e,t){if(o.length>0)for(var i=0;i<o.length;i++){var a=o[i].getCellIndex();if(a.row===e&&a.col===t)return o[i]}},this.getNbofRows=function(){return t},this.setNbofRows=function(e){if(e!==t&&f(),e>t)for(var r=t,s=0;s<a;s++)for(var h=r;h<e;h++){var d=new i;d.setCellIndex(h,s),o.push(d),n[h]=0,l[h]=0}t=e},this.getNbofColumns=function(){return a},this.setNbofRowsAndColumns=function(e,r){e===t&&r===a||f();for(var s=0;s<r;s++)for(var h=0;h<e;h++){var d=new i;d.setCellIndex(h,s),o.push(d),n[h]=0,l[h]=0}a=r,t=e},this.setNbofColumns=function(e){if(e!==a&&f(),e>a)for(var n=a;n<e;n++){for(var l=0;l<t;l++){var s=new i;s&&(s.setCellIndex(l,n),o.push(s))}r[n]=0}a=e},this.getRowHt=function(e){return n[e]},this.getRowCharHt=function(e){return l[e]},this.getColWd=function(e){return r[e]}}})});