define("DS/3DPlayReviewExperience/3DPlayReviewExperience",["DS/Selection/PSOManager","DS/3DPlayExperienceModule/PlayExperience3D","DS/Visualization/ThreeJS_DS","DS/DMUReadPersistence/DMULoadMarkupServices","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMU2DSheetManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUPlaySlide/controllers/DMUSlideShowController","DS/ApplicationFrame/CommandsManager","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXComponents/CATWebUXUtils","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADProgressBar","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUReadPersistence/DMULoadingContextController","i18n!DS/3DPlayReviewExperience/assets/nls/3DPlayReviewExperience"],function(e,t,n,i,r,o,a,l,s,c,d,D,g,p,m,u,C,f,w,h,P,S,V,v,M){"use strict";var y;return t.extend({init:function(t){var y,U,R,b,x,A,E,I,T,W=!1,k=this,F=!0,_={},L="";let O,B,X;function N(){(T=C.getSelectionManager({context:k.pad3DViewer})).setActiveState(!0);let e=o.giveEventsController({viewer:k.pad3DViewer.getViewer()});if(I=u.getPreferenceManager({context:k.pad3DViewer.getFrameWindow()}))if(I.setUnitsPreferencesDisplayFlag(!0),I.setDisplayPreferencesDisplayFlag(!0),I.set3DSelectionPreferencesDisplayFlag(!0),I.set2DSelectionPreferencesDisplayFlag(!0),I.addPreferences([{nls:M.preferences.markupSectionTitle,id:"MarkupPreferences",type:"section",preferences:[{nls:M.preferences.SlideTitleDisplayLbl,id:"DMUDisplaySlideTitle",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("DMUDisplaySlideTitle")},getDefaultValue:function(){return!1},setValue:function(t){t!==("true"===localStorage.getItem("DMUDisplaySlideTitle"))&&(localStorage.setItem("DMUDisplaySlideTitle",t?"true":"false"),e&&e.fireEvent("onDMUPreferencesChanged",{DMUDisplaySlideTitle:t}))}}]},{nls:M.preferences.compareSectionTitle,id:"ComparePreferences",type:"section",preferences:[{nls:M.preferences.firstProductColor,id:"DMUCompareFirstColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompareFirstColor")?localStorage.getItem("DMUCompareFirstColor"):"#FF0000"},getDefaultValue:function(){return"#FF0000"},setValue:function(t){localStorage.setItem("DMUCompareFirstColor",t),e&&e.fireEvent("onDMUPreferencesChanged",{DMUCompareFirstColor:t})}},{nls:M.preferences.secondProductColor,id:"DMUCompareSecondColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompareSecondColor")?localStorage.getItem("DMUCompareSecondColor"):"#00FF00"},getDefaultValue:function(){return"#00FF00"},setValue:function(t){localStorage.setItem("DMUCompareSecondColor",t),e&&e.fireEvent("onDMUPreferencesChanged",{DMUCompareSecondColor:t})}},{nls:M.preferences.compare3DCommonColor,id:"DMUCompare3DCommonColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompare3DCommonColor")?localStorage.getItem("DMUCompare3DCommonColor"):"#D3D3D3"},getDefaultValue:function(){return"#D3D3D3"},setValue:function(t){localStorage.setItem("DMUCompare3DCommonColor",t),e&&e.fireEvent("onDMUPreferencesChanged",{DMUCompare3DCommonColor:t})}},{nls:M.preferences.compare2DCommonColor,id:"DMUCompare2DCommonColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompare2DCommonColor")?localStorage.getItem("DMUCompare2DCommonColor"):"#000000"},getDefaultValue:function(){return"#000000"},setValue:function(t){localStorage.setItem("DMUCompare2DCommonColor",t),e&&e.fireEvent("onDMUPreferencesChanged",{DMUCompare2DCommonColor:t})}}]}]),I.setPreferredPreferenceContainersOrder(["MarkupPreferences","MeasurePreferences","SectionPreferences","ComparePreferences"]),_.CATWebUXPreferences_GravitationalEffects=I.subscribe("CATWebUXPreferences_GravitationalEffects",function(e){k.pad3DViewer&&k.pad3DViewer.getViewer()&&k.pad3DViewer.getViewer().currentViewpoint&&k.pad3DViewer.getViewer().currentViewpoint.control&&(k.pad3DViewer.getViewer().currentViewpoint.getControl().setRotationRolling(!e),k.pad3DViewer.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!e))}),_.CATWebUXPreferences_ProjectionType=I.subscribe("CATWebUXPreferences_ProjectionType",function(e){k.pad3DViewer&&k.pad3DViewer.getViewer()&&k.pad3DViewer.getViewer().currentViewpoint&&k.pad3DViewer.getViewer().currentViewpoint.setProjectionType(e)}),_.CATWebUXPreferences_Select3DGeometry=I.subscribe("CATWebUXPreferences_Select3DGeometry",function(e){T&&!k.pad3DViewer.getViewer().get2DMode()&&T.setPicking(e?0:1)}),_.CATWebUXPreferences_Select2DGeometry=I.subscribe("CATWebUXPreferences_Select2DGeometry",function(e){T&&k.pad3DViewer.getViewer().get2DMode()&&T.setPicking(e?0:1)}),_.CATWebUXPreferences_SelectParentReferenceOr3DShape=I.subscribe("CATWebUXPreferences_SelectParentReferenceOr3DShape",function(e){T&&T.selectParentReference("select3DShape"!==e)}),k.pad3DViewer.getViewer().get2DMode()){var t=f.getPreference("CATWebUXPreferences_Select2DGeometry","boolean");T&&T.setPicking(t?0:1)}else{var n=f.getPreference("CATWebUXPreferences_GravitationalEffects","boolean");"boolean"==typeof n&&(k.pad3DViewer.getViewer().currentViewpoint.getControl().setRotationRolling(!n),k.pad3DViewer.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!n));var i=f.getPreference("CATWebUXPreferences_ProjectionType","int");0!==i&&1!==i||k.pad3DViewer.getViewer().currentViewpoint.setProjectionType(i);var r=f.getPreference("CATWebUXPreferences_Select3DGeometry","boolean");T&&T.setPicking(r?0:1);let e=f.getPreference("CATWebUXPreferences_SelectParentReferenceOr3DShape","string");T&&T.selectParentReference("select3DShape"!==e)}x||(x=new s({context:k.pad3DViewer})).subscribe("onActiveStateModified",function(e){F=!e.state})}function H(e){var t={lastCommand:[],currentCommand:null,defaultCommand:null},n=k.pad3DViewer.getCommandContext();n?c._commandsState[n]=t:c._commandsState=t,c.resetDefaultCommand(n),c._isCommandEnding=!1,c._ignoreCommandBeginWhileEndingCommand=!1,["_commands","_cmdCheckHeader"].forEach(function(e){var t=n&&c[e]?c[e][n]:c[e];t&&Object.keys(t).forEach(function(e){var n=t[e];n&&n._destroy&&n._destroy(),delete t[e]})});var i=k.pad3DViewer.getFrameWindow().getActionBar(),r=i.onActionBarReady(function(){i.removeCallback(r),setTimeout(e.actionBarReadyCb,500)});k.pad3DViewer.loadActionBar({file:e.file,module:e.module})}function G(e,t){var n=function(){if(k.pad3DViewer){var e=c.getCommandCheckHeader("WebDocumentBookmarksPanelCmdHdr",k.pad3DViewer.getCommandContext());if(e){let n=localStorage.getItem("DMUBookmarksPanelDisplayed");"true"!==n&&("false"===n||"Requirement"!==t&&"Requirement Specification"!==t)||e.setState(!0),R&&R.documentHasBookmarks()?e.enable():e.disable()}(e=c.getCommand("WebDocumentRotatePagesLeftCmdHdr",k.pad3DViewer.getCommandContext()))&&(R&&"Document"===R.getDocumentType()?e.enable():e.disable()),(e=c.getCommand("WebDocumentRotatePagesRightCmdHdr",k.pad3DViewer.getCommandContext()))&&(R&&"Document"===R.getDocumentType()?e.enable():e.disable()),(e=c.getCommand("DMUNextCommentCmdHdr",k.pad3DViewer.getCommandContext()))&&(E&&E.hasComments()?e.enable():e.disable()),(e=c.getCommand("DMUPreviousCommentCmdHdr",k.pad3DViewer.getCommandContext()))&&(E&&E.hasComments()?e.enable():e.disable())}};L!==e?("ITF"===e?H({file:"3DPlayReviewITFExperience.xml",module:"3DPlayReviewExperience",actionBarReadyCb:n}):"Document"===e?H({file:"3DPlayReviewDocumentExperience.xml",module:"3DPlayReviewExperience",actionBarReadyCb:n}):"3D"===e?H({file:"3DPlayReviewExperience.xml",module:"3DPlayReviewExperience",actionBarReadyCb:n}):"2D"===e?H({file:"3DPlayReviewDrawingExperience.xml",module:"3DPlayReviewExperience",actionBarReadyCb:n}):"MSR"===e&&H({file:"3DPlayReviewMSRExperience.xml",module:"3DPlayReviewExperience",actionBarReadyCb:n}),L=e):n()}function j(e){U||(U=m.getDMUApplicativeContextManager({context:k.pad3DViewer})).initApplicativeContainer(e,{onReady:function(e){e&&e.length&&e.forEach(function(e){"POI"!==e.getApplicativeContainerID()&&e.setActiveState(!0)})}})}function q(e){R&&R.load2DDocument({phyID:e.phyID,serverUrl:h.get3DSpaceUrl(),securityContext:P.getSetting("pad_security_ctx"),dataType:e.dataType,is2DCompareActive:O,parentNode:k.pad3DViewer.getRootBagPath().getChildrenPathes()[k.pad3DViewer.getRootBagPath().getChildrenPathes().length-1].getLastElement(!0),onLoadingStarted:e.onLoadingStarted,onComplete:e.onComplete,onFailure:e.onFailure})}d.doInitialize(),this.getSlideIDToActivate=function(e){let t;if(e){var n=e.getLoadedRepRefs();return n.length>0&&n[0].getMarkupContent()&&n[0].getMarkupContent().getSlides()&&n[0].getMarkupContent().getSlides().length&&(t=n[0].getMarkupContent().getSlides()[0].getAttribute("sUuid")),t}},this.internalLoad=function(e,t){if(o.removeReviewContext({context:k.pad3DViewer}),e){y=JSON.stringify(e);var n=e.asset.physicalid;if(e.asset&&e.asset.physicalid){var s=e.asset;let c,d;s.reviewId=e.asset.physicalid,s.context=k.pad3DViewer;let m,u=[],C=[],f=function(){if(c&&d&&u.length&&m){A||(A=g.giveDMUSlidesController({context:k.frmWindow}));let r=function(e,t){var n=o.giveEventsController({viewer:k.pad3DViewer.getViewer()});if(n){let i=n.addEvent("on2DDocumentLoadSuccess",function(){E&&E.applyComment({commentId:t,markupId:e}),n.removeEvent(i)})}};for(var e=0;e<u.length;e++){let o=null;for(var t=0;t<C.length;t++)C[t].getAttribute("sPresentationSlideID")===u[e].getAttribute("sUuid")&&((i={highlight:C[t],slide:u[e]})&&i.slide&&i.slide.setAssociatedHighlightData&&i.highlight&&i.slide.setAssociatedHighlightData(JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:h.getPlatformId(),serviceId:"3DSpace",contextId:P.getSetting("pad_security_ctx")?P.getSetting("pad_security_ctx"):void 0,objectId:i.highlight.getPlmID(),objectType:i.highlight.getType(),displayName:i.highlight.getName()}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0})),u[e].getAttribute("sUuid")===m&&(o=C[t]));if(u[e].getAttribute("sUuid")===m)if(k.autoReframe=!1,"DMUSlide"===u[e].getType())A&&A.setActiveSlide(u[e]);else if("DMUComment"===u[e].getType()){var n=u[e].getAttribute("sUuid");if(o)r(o.getAttribute("sRepRefMarkupID"),n)}}}var i};s.cbRootAdded=function(){let e=o.giveEventsController({viewer:k.pad3DViewer.getViewer()}),t=e.addEvent("onDXFLoadSuccess",function(){G("2D"),e.removeEvent(t)});var n;c=!0,k.pad3DViewer.getRootBagPath().getChildrenPathes()[0]&&(n=V.getNodeType(k.pad3DViewer.getRootBagPath().getChildrenPathes()[0].getLastElement(!0)));var i=k.pad3DViewer.getApplicativeData().getLoadedItfData&&k.pad3DViewer.getApplicativeData().getLoadedItfData().data.length?"ITF":"Drawing"===n||"DIFLayout"===n||"DIFSheet"===n?"2D":"Document"===n||"Requirement"===n||"Requirement Specification"===n?"Document":"DesignSight"===n?"MSR":"3D";if(!b||"DXF"!==b.getLoadMarkupCtxType()&&"DWG"!==b.getLoadMarkupCtxType()||(i="2D"),j(i),G(i,n),"Drawing"===n){let e=V.getNodeID(k.pad3DViewer.getRootBagPath().getChildrenPathes()[0].getLastElement(!0)),t=0;q({phyID:e,dataType:n,onLoadingStarted:function(){1===++t&&S.on()},onComplete:function(){O=!0,--t<=0&&(S.off(),t=0)},onFailure:function(){O=!0,k.pad3DViewer.removeRoots({pids:[e]}),--t<=0&&(S.off(),t=0)}}),B||(B=k.pad3DViewer.subscribe({event:"onRootAdded"},function(n){q({phyID:n.id,dataType:V.getNodeType(n.path.getLastElement(!0)),onLoadingStarted:function(){1===++t&&S.on()},onComplete:function(){--t<=0&&(S.off(),t=0)},onFailure:function(){k.pad3DViewer.removeRoots({pids:[e]}),--t<=0&&(S.off(),t=0)}})})),X||(X=k.pad3DViewer.subscribe({event:"onRootRemoved"},function(e){R&&R.clean2DDocument(e)}))}if("Document"===i&&(k.pad3DViewer.getViewpoint().setDefaultController(!0,"CATIA"),E||(E=p.giveDMUCommentsController({context:k.frmWindow,commandContext:k.pad3DViewer.getCommandContext()})),R&&!R.isADocumentDisplayed())){let t=e.addEvent("on2DDocumentLoadSuccess",()=>{e.removeEvent(t),G(i,n)})}N(),W||(r.setSlidePreferences({context:k.frmWindow,preferences:{playMode:!0,displayNominal:!1}}),W=!0),f()},s.cbOK=function(){if(d=!0,!A||t){var e,i=D.createReviewContext({context:k.pad3DViewer}),r=i.getValidation();let t=r.getHighlights();if(t&&t.length)for(e=0;e<t.length;e++)C.push(t[e]);if(i.getCurrentSessionMarkup()){if(r=i.getValidation()){var o=r.getLoadedRepRefs();for(e=0;e<o.length;e++){u=u.concat(o[e].getMarkupContent().getSlides());for(let t=0;t<o[e].getMarkupContent().getSlides().length;t++){var a=o[e].getMarkupContent().getSlides()[t].getDMUObjects();for(let e=0;e<a.length;e++)a[e].getDMUComments&&(u=u.concat(a[e].getDMUComments()))}}}m=k.getSlideIDToActivate(r,n),f()}}},s.cbFailed=function(){k.clearView()},(R=l.getManager({name:"DMU2DSheetManager",context:k.frmWindow}))||(R=new a({ctxViewer:k.pad3DViewer}),l.addManager({name:"DMU2DSheetManager",context:k.frmWindow,manager:R})),b||(b=v.getLoadingContextController({context:k.pad3DViewer})),function(e){let t=i.getLoadMarkupServices(e);t&&(delete e.context,e.readOnly=!0,r.setSlidePreferences({context:k.pad3DViewer.getFrameWindow(),preferences:{displayNominal:!1,displayInWork:!1}}),t.loadValidation(e))}(s)}}},this.internalClear=function(e){if(k.pad3DViewer&&B&&k.pad3DViewer.unsubscribe(B),B=null,k.pad3DViewer&&X&&k.pad3DViewer.unsubscribe(X),X=null,I){I.removePreferences(["MarkupPreferences"]);var t=Object.keys(_);for(let e=0;e<t.length;e++)I.unsubscribe(_[t[e]]);_={}}if(x&&(x.clean(),x=null),e){if(k.pad3DViewer.getRootBagPath().getChildrenPathes()[0]){var n=V.getNodeID(k.pad3DViewer.getRootBagPath().getChildrenPathes()[0].getLastElement(!0));k.pad3DViewer.getController().removeRoots({pids:[n]})}l.removeManager({name:"DMU2DSheetManager",context:k.frmWindow}),u.unreferencePreferenceManager({context:k.pad3DViewer.getFrameWindow()}),I=null,C.unreferenceSelectionManager({context:k.pad3DViewer}),T=null,o.removeReviewContext({context:k.pad3DViewer}),A=E=null}O=!1},this.internalDispose=function(e){y=null,k.frmWindow.getContextualUIManager().unregister("3DPlayReviewExperience"),r.removeSlidePreferences({context:k.frmWindow}),k.internalClear&&k.internalClear("ENOR3V_AP"!==e&&"ENOR3R_AP"!==e),W=!1},this.internalRefresh=function(){y&&(k.internalClear(!0),k.internalLoad(JSON.parse(y),!0))},this.internalPostCreate=function(){this.frmWindow.getContextualUIManager().register({subscriberId:"3DPlayReviewExperience",workbenchName:"3DPlayReviewExperience",context:k.pad3DViewer.getCommandContext(),cmdPrefix:"",fileName:"3DPlayReviewExperience.xml",module:"3DPlayReviewExperience",onContextualMenuReady:function(t,i){var r=[];if(F&&i&&i.XmousePosition){var o=new n.Vector2(i.XmousePosition,i.YmousePosition),a=k.frmWindow.getViewer().getMousePosition(o);if(0===k.frmWindow.getViewer().pick(a,"mesh",!0).path.length){var l=e.get(),s=l&&l[0]&&l[0].pathElement?l[0].pathElement.getLastElement(!0):null;if("DMUValidationExposedPresentation"===(s&&s.getDMUType?s.getDMUType():""))return{cmdList:r};w.isMobile()||(r=[{line:1,name:"DMU3DReviewDisplaySubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:["VisuQMCommand"]}]),r=r.concat([{line:1,name:"DMU3DReviewAmbiencesSubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]}])}}return{cmdList:r}}})},t.commandApplication=!1,t.workbenchs=t.workbenchs||[],t.options.pad3DViewer||t.workbenchs.push({name:"3DPlayReviewExperience",module:"3DPlayReviewExperience"}),this._parent(t),this.subscribe("ASSET/LOADINGFINISHED",()=>{var e;N(),k.pad3DViewer.getRootBagPath().getChildrenPathes()[0]&&(e=V.getNodeType(k.pad3DViewer.getRootBagPath().getChildrenPathes()[0].getLastElement(!0)));var t=k.pad3DViewer.getApplicativeData().getLoadedItfData&&k.pad3DViewer.getApplicativeData().getLoadedItfData().data.length?"ITF":"Drawing"===e||"DIFLayout"===e||"DIFSheet"===e?"2D":"Document"===e||"Requirement"===e||"Requirement Specification"===e?"Document":"DesignSight"===e?"MSR":"3D";!b||"DXF"!==b.getLoadMarkupCtxType()&&"DWG"!==b.getLoadMarkupCtxType()||(t="2D"),j(t),G(t)},!0)},clearView:function(){this.internalClear&&this.internalClear(!0),this._parent()},onPostCreate:function(){this.pad3DViewer.getViewer().setPrePicking({activated:!0,displayHL:!0}),window.widget.setMetas({helpPath:"3DPlayReviewExperience/assets/help"}),window.widget.dispatchEvent("onPlayExperienceReady",[{pad3DViewer:this.pad3DViewer}]),this.internalPostCreate&&this.internalPostCreate()},dispose:function(e){window.widget.setMetas({helpPath:void 0}),this.internalDispose&&this.internalDispose(y),y=null,this._parent(e)},refresh:function(){return this.internalRefresh&&this.internalRefresh(),!0},loadAsset:function(e){e&&e.asset&&e.asset.physicalid&&this.internalLoad&&(this.clearView(),this.internalLoad(e))},acceptSwitch:function(e){var t=!1;return e&&e.options&&e.options.id&&("ENOR3V_AP"!==(y=e.options.id)&&"ENOR3R_AP"!==y||(t=!0)),t}})}),define("DS/3DPlayReviewExperience/3DPlayHighlightExperience",["DS/3DPlayReviewExperience/3DPlayReviewExperience"],function(e){"use strict";return e.extend({init:function(e){this._parent(e);let t=this.getSlideIDToActivate;this.getSlideIDToActivate=function(e,n){let i;if(!e||!n)return;let r=e.getHighlights();if(r&&r.length)for(let e=0;e<r.length;e++)r[e].getPlmID()===n&&(i=r[e].getPresentationSlideID());return i||t(e,n)}}})});