define("DS/3DPlayDrawingExperience/DrawingAnnotationManager",["UWA/Class","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/3DPlayAnnotationUtils/AnnotationAbbreviations","DS/3DPlayAnnotation3D/AnnotationShapes","DS/3DPlayAnnotation3D/AnnotationUtils"],function(e,t,n,i,r,o,a,s){"use strict";var h=null,l=null,c=function(){var e=h.getViewpoint();if(e)return{eyePosition:e.getEyePosition(),upDirection:e.getUpDirection(),sightDirection:e.getSightDirection(),targetDistance:e.getTargetDistance()}};return e.extend({init:function(e){this._parent(e),this._annotCount=0,h=e.frameWindow,l=h.getViewer(),h.experience,this.frameWindow=e.frameWindow,this.exp=this.frameWindow.experience,this._rootNode=this.exp.getRootBag(),this._annotGroupNode=new n("annotGroupNode"),this._rootNode.add(this._annotGroupNode),this.AnnotationAbbreviations=new o,this.sheetList=[]},getVisibleAndOnModelAnnotationGroups:function(){return[this.exp.getCurrentSheet()]},getAnnotationBag:function(){return this._annotGroupNode},getModel:function(){var e=this.exp.getCurrentSheet();if(e)return e.node},deleteAllAnnotations:function(){for(var e=this.exp.sheets,t=0;t<e.length;t++)for(var n=e[t].annotList,i=0;i<n.length;i++)n[i].dispose(),n.splice(i,1);this.exp&&this.exp.publish("3DPLAY/ANNONATION/NOTINSESSION",{})},dispose:function(){this.deleteAllAnnotations(),this._rootNode.remove(this._annotGroupNode),this._annotGroupNode=void 0,this._model=void 0,this._rootNode=void 0,this.exp=void 0,this.frameWindow=void 0},addAnnotViewpointToList:function(e){return this.exp.getCurrentSheet().index},updateViewPoint:function(e){var t=!1,n=this.exp.getCurrentSheet().index;if("left"===e.direction){for(var i=n-1;i>=0;i--)if(this.exp.sheets[i].annotList.length>0){this.exp.setCurrentSheet(i),t=!0;break}if(!t)for(i=this.exp.sheets.length-1;i>n;i--)if(this.exp.sheets[i].annotList.length>0){this.exp.setCurrentSheet(i);break}}else if("right"===e.direction){for(i=n+1;i<this.exp.sheets.length;i++)if(this.exp.sheets[i].annotList.length>0){this.exp.setCurrentSheet(i),t=!0;break}if(!t)for(i=0;i<n;i++)if(this.exp.sheets[i].annotList.length>0){this.exp.setCurrentSheet(i);break}}},hideAnnotationsOfCurrentSheet:function(){for(var e=this.exp.getCurrentSheet().annotList,t=0;t<e.length;t++)e[t].repBag.setVisibility(!1)},showAnnotationsOfCurrentSheet:function(){for(var e=this.exp.getCurrentSheet().annotList,t=0;t<e.length;t++)e[t].repBag.setVisibility(!0)},deleteAnnotationWithID:function(e){for(var t=this.exp.sheets,n=!1,i=0;i<t.length;i++){for(var r=t[i].annotList,o=0;o<r.length;o++)if(r[o].id===e){this._annotGroupNode.remove(r[o].repBag),r[o].dispose(),r.splice(o,1),n=!0,this._annotCount-=1;break}if(0===this._annotCount&&this.exp&&this.exp.publish("3DPLAY/ANNONATION/NOTINSESSION",{}),n)return}},getAnnotationWithID:function(e){for(var t=this.exp.sheets,n=0;n<t.length;n++)for(var i=t[n].annotList,r=0;r<i.length;r++)if(i[r].id===e)return i[r]},getAnnotationTypeWithID:function(e){for(var t="",n=this.exp.sheets,i=0;i<n.length;i++)for(var r=n[i].annotList,o=0;o<r.length;o++)if(r[o].id===e)return t=r[o].type;return t},changeAnnotPropertyWithID:function(e,t){for(var n=this.exp.sheets,i=0;i<n.length;i++)for(var r=n[i].annotList,o=0;o<r.length;o++)if(r[o].id===e)return void(t.color&&(r[o].graphicalProp.color=t.color))},getAnnotColorWithID:function(e){for(var t=this.exp.sheets,n=0;n<t.length;n++)for(var i=t[n].annotList,r=0;r<i.length;r++)if(i[r].id===e)return i[r].graphicalProp.color},setLowlightAnnotationID:function(e){for(var t=this.exp.sheets,n=0;n<t.length;n++)for(var r=t[n].annotList,o=0;o<r.length;o++){var a=r[o];if(a.id===e)return void("text"===a.type?a.repBag.children[0].mesh3js.material.setValues({color:"#A9A9A9"}):a.repBag.children[0].mesh3js.material.updatePDSFXUniform("Color",new i.Color("#A9A9A9")))}},addToAnnotGroupNode:function(e,t){var n=t||this.exp.getCurrentSheet();n.annotList.push(e);var r=!1;this.PreviousSheet=t;var o,a,s=(o=Date.now(),a=c(),{id:o,eyePosition:a.eyePosition instanceof i.Vector3?a.eyePosition:new i.Vector3(a.eyePosition.x,a.eyePosition.y,a.eyePosition.z),upDirection:a.upDirection instanceof i.Vector3?a.upDirection:new i.Vector3(a.upDirection.x,a.upDirection.y,a.upDirection.z),sightDirection:a.sightDirection instanceof i.Vector3?a.sightDirection:new i.Vector3(a.sightDirection.x,a.sightDirection.y,a.sightDirection.z),targetDistance:a.targetDistance,annotList:a.annotList||[]});e.viewpoint=s;for(var h=0;h<this.sheetList.length;h++)if(n.index===this.sheetList[h].index){r=!0;break}r||this.sheetList.push(n),this._annotGroupNode.addChild(e.repBag),this.exp.getCurrentSheet().index!==n.index&&e.repBag.setVisibility(!1),this.frameWindow.getViewer().render(),this._annotCount+=1,this._annotCount>=1&&this.exp.sheets.length>1&&this.exp&&this.exp.publish("3DPLAY/ANNONATION/INSESSION",{})},getCurrentAnnotViewpoint:function(){return this.exp.getCurrentSheet()},saveAnnotationsToJSON:function(e){for(var t={ver:"1.0",sheets:[]},n=0;n<this.sheetList.length;n++){for(var i=[],r=0;r<this.sheetList[n].annotList.length;r++){var o=this.sheetList[n].annotList[r];e&&e!==o.id||i.push(o.getJSON())}t.sheets.push({id:this.sheetList[n].index,annotations:i})}var a=this.AnnotationAbbreviations.processJSON(t,"minify");return JSON.stringify(a)},compareAnnotViewpointWithCurrent:function(e){for(var t,n=!1,i=c(),r=this.exp.sheets,o=0;o<r.length;o++){for(var a=r[o].annotList,h=0;h<a.length;h++)if(a[h].id===e){t=a[h].viewpoint;break}if(t)break}return t&&s._areAlmostSameViewpoints(t,i)&&(n=!0),n},updateViewPointOfInputAnnotation:function(e){for(var t,n,i,r=this.exp.sheets,o=0;o<r.length;o++){for(var a=r[o].annotList,s=0;s<a.length;s++)if(a[s].id===e){t=a[s].viewpoint;break}if(t)break}t&&(i=t,(n=200)&&(i.duration=n),i.distanceToTarget=i.targetDistance,h.getViewpoint().moveTo(i),l.render())},repaintAnnotation:function(e,t){for(var n=this.exp.sheets,r=0;r<n.length;r++)for(var o=n[r].annotList,a=0;a<o.length;a++){var s,h=o[a];if(h.id===e)return s=1==t?"#00BFFF":h.graphicalProp.color,void("text"===h.type?h.repBag.children[0].mesh3js.material.setValues({color:new i.Color(s)}):h.repBag.children[0].mesh3js.material.updatePDSFXUniform("Color",new i.Color(s)))}},drawAnnotationsFromJSON:function(e,t){t&&this.deleteAllAnnotations();var n=JSON.parse(e);if(n.ver)for(var i=this.AnnotationAbbreviations.processJSON(n,"expand").sheets,r=0;r<i.length;r++){for(var o=this.exp.getSheet(i[r].id),s=!1,h=0;h<this.sheetList.length;h++)if(o.index===this.sheetList[h].index){s=!0;break}s||this.sheetList.push(o);for(var l=i[r].annotations,c={frameWindow:this.frameWindow,annotationManager:this},d=null,p=0;p<l.length;p++){switch(l[p].type){case"circle":d=new a.circle(c);break;case"ellipse":d=new a.ellipse(c);break;case"line":d=new a.line(c);break;case"rectangle":case"square":d=new a.rectangle(c);break;case"triangle":d=new a.triangle(c);break;case"unknownOpen":d=new a.unknownOpen(c);break;case"text":d=new a.text(c);break;case"arrow":d=new a.arrow(c);break;case"curvedArrow":d=new a.curvedArrow(c);break;case"doubleHeadedArrow":d=new a.doubleHeadedArrow(c);break;case"curvedDoubleHeadedArrow":d=new a.curvedDoubleHeadedArrow(c);break;default:d=new a.unknownOpen(c)}d.createFromJSON(l[p]),d.draw(),this.addToAnnotGroupNode(d,o)}}else console.log("3DPlay: Invalid annotation JSON!")}})}),define("DS/3DPlayDrawingExperience/CmdScrollSheet",["DS/ApplicationFrame/Command"],function(e){"use strict";return e.extend({init:function(e){for(var t in this._parent(e,{isAsynchronous:!1}),e.arguments)"ScrollSheet"==e.arguments[t].ID&&(this.scrollDir=e.arguments[t].Value);var n=this;this._exp=this.getFrameWindow().experience,this.loadingCompletedToken=this._exp.subscribe("ASSET/LOADINGFINISHED/",function(){n._exp&&n._exp.sheets&&n._exp.sheets.length>1?n.enable():n.disable()})},execute:function(){"Previous"===this.scrollDir?this._exp.scrollToPreviousSheet():"Next"===this.scrollDir&&this._exp.scrollToNextSheet()},_destroy:function(){this._exp&&(this._exp.unsubscribe(this.loadingCompletedToken),this.loadingCompletedToken=void 0,this._exp=void 0,this._parent())}})}),define("DS/3DPlayDrawingExperience/CmdScale",["UWA/Core","DS/ApplicationFrame/Command"],function(e,t){"use strict";var n=[25,50,75,100,125,150,200,300,400,500];return t.extend({init:function(e){for(var t in this._parent(e,{isAsynchronous:!1}),e.arguments)"Scale"==e.arguments[t].ID&&(this.scaleMode=e.arguments[t].Value)},execute:function(){var e=this.getFrameWindow();if(e&&e.experience){var t=e.experience.getZoomScale(),n=this.getScale(t);e.experience.setZoomScale(n)}},getScale:function(e){var t;if(t=e>500?500:e<25?25:e,"+"==this.scaleMode)for(var i=0;i<n.length-1;++i){if(e<n[i]){t=n[i];break}if(e===n[i]){t=n[++i];break}}else for(var r=n.length-1;r>=1;--r){if(e>n[r]){t=n[r];break}if(e===n[r]){t=n[--r];break}}return t}})});var t=["DS/PADUtils/PADUtilsServices"];define("DS/3DPlayDrawingExperience/3DPlayDrawingExperience",["DS/3DPlayExperienceModule/PlayExperience3D","DS/SVGLoader/SVGNode","DS/WebSystem/Settings","DS/3DPlay/3DPlay","DS/WebSystem/Nls","DS/CoreEvents/Events","DS/3DPlayDrawingExperience/DrawingAnnotationManager","DS/WebUtils/ContextedSingleton","DS/WebUtils/ProbesManager","i18n!DS/3DPlay/assets/nls/3DPlay"].concat(t),function(e,t,n,i,r,o,a,s,h,l,c){"use strict";var d;return e.extend({init:function(e){this._parent(e),e.workbenchs=[],e.workbenchs.unshift({name:"3DPlayDocumentViewerPrint",module:"3DPlay2DExperience"}),e.workbenchs.unshift({name:"3DPlayDrawingExperience",module:"3DPlayDrawingExperience"}),d=this,this.loadingCompletedToken=this.subscribe("ASSET/LOADINGFINISHED",function(){d.sheetCameraDistance=d.frmWindow.getViewpoint().getTargetDistance(),d.zoomScale=100,d.annotationManager=new a({frameWindow:d.frmWindow,context:d.ctx}),s.add(d.ctx,"ANNOTATION_MANAGER",d.annotationManager)}),this.viewpointChangedToken=o.subscribe({event:"/VISU/"},function(e){if(d.sheetCameraDistance&&d.zoomScale&&("@onViewpointEndMove"===e.eventType||"@onViewpointChange"===e.eventType)){var t=d.frmWindow.getViewpoint().getTargetDistance();d.zoomScale=Math.floor(d.sheetCameraDistance/t*100)}})},getSheet:function(e){return this.sheets.length>0&&e<this.sheets.length?this.sheets[e]:void console.log("Invalid sheet index!!!")},onPreCreate:function(){this._parent(),this.mabModel={speeddial:[{id:"AnnotationCommands",rsc:"3DPlay/3DPlayExperience3D"},{id:"Reframe",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"Share",icon:"3DPlay/assets/icons/32/I_3DSHAREShare.png",flyout:[]}],sections:[{id:"ScaleP",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience",nls:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"ScaleM",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience",nls:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"Previous",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience",nls:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"Next",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience",nls:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"AnnotationTour",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D"},{id:"Print2DRealSize",rsc:"3DPlay2DExperience/3DPlay2DExperience",nls:"3DPlay2DExperience/3DPlay2DExperience"}]},this._iOS?this.mabModel.speeddial[2].flyout=[{id:"ShareTo3DSwYm",rsc:"3DPlay/3DPlay"},{id:"SharePrint",rsc:"3DPlay/3DPlay"}]:this.mabModel.speeddial[2].flyout=[{id:"ShareTo3DSwYm",rsc:"3DPlay/3DPlay"},{id:"ShareDownload",rsc:"3DPlay/3DPlay"},{id:"SharePrint",rsc:"3DPlay/3DPlay"}]},dispose:function(){this.viewpointChangedToken&&(o.unsubscribe(this.viewpointChangedToken),this.viewpointChangedToken=void 0),this.loadingCompletedToken&&(this.unsubscribe(this.loadingCompletedToken),this.loadingCompletedToken=void 0),this.annotationManager&&(this.annotationManager=void 0),d=void 0,this._parent()},loadModel:function(e){"V6Drawing"===e.asset.type&&e.asset.backup_type&&(e.asset.type=e.asset.backup_type,e.asset.backup_type=void 0),"V6Drawing"===e.asset.dtype&&e.asset.backup_dtype&&(e.asset.dtype=e.asset.backup_dtype,e.asset.backup_dtype=void 0);var t=e.asset.physicalid;e&&(this.onModelLoadingStarted(),c.updatePlatformId(e.asset.tenant),this.loadingAsset.Load_Infra=h.createProbe("Load_Infra").begin(),this.pad3DViewer.getController().getAttributes({ids:[t],attributes:["svg"],callbacks:{onComplete:function(e){if(e[t]&&e[t].svg&&""!==e[t].svg){d.loadingAsset.Load_Infra.end();var n=new XMLHttpRequest;n.onprogress=function(e){d.loadingAsset.size=0!==e.total?e.total:e.loaded},n.onload=h.createFunctionProbe("Download",d._loadSvg),n.open("GET",e[t].svg,!0),n.send(null)}else i.displayNotification({ctx:d.ctx,msg:l.LoadingError_NO_2D_GEOMETRY})},onFailure:function(){i.displayNotification({ctx:d.ctx,msg:l.LoadingError_NO_2D_GEOMETRY})}}}))},_loadSvg:function(e){d.loadingAsset.Load_Session=h.createProbe("Load_Session").begin();var i=d.frmWindow.experience.getRootBag(),r=new DOMParser;d.rawSVG=e.currentTarget.responseText;var o=r.parseFromString(e.currentTarget.responseText,"image/svg+xml"),a=o.children?o.children[0]:o.childNodes[1],s=!1,l=0;d.sheets=[],d.currentSheetIndex=0;for(var c=function(e,t){var n=this;this.id=e,this.index=e,this.node=t,this.annotList=[],this.onClickCB=function(){d.setCurrentSheet(n.index)}},p=a.children?a.children:a.childNodes,u=0;u<p.length;u++)if("svg"===p[u].nodeName){s=!0;var g=new t(p[u],p[u].id);i.addChild(g),d.sheets.push(new c(l,g)),l++}if(!s){g=new t(a,0);i.addChild(g),d.sheets.push(new c(u,g))}n.get("3DPlay.ShowLeftPanelForDrawings")&&require(["DS/3DPlayUtils/LeftPanel"],function(e){d.listOfSheets=new e({items:d.sheets,container:d.frmWindow.getUIFrame()})}),d.updateView(),d.modelLoader.onLoadedCB()},getSource:function(){return this.rawSVG},getCurrentSheetIndex:function(){return this.currentSheetIndex},getNumberOfSheets:function(){return this.sheets.length},scrollToNextSheet:function(){this.currentSheetIndex<this.sheets.length-1&&(this.annotationManager.hideAnnotationsOfCurrentSheet(),this.currentSheetIndex=this.currentSheetIndex+1,this.annotationManager.showAnnotationsOfCurrentSheet(),this.updateView())},scrollToPreviousSheet:function(){this.currentSheetIndex>0&&(this.annotationManager.hideAnnotationsOfCurrentSheet(),this.currentSheetIndex=this.currentSheetIndex-1,this.annotationManager.showAnnotationsOfCurrentSheet(),this.updateView())},setCurrentSheet:function(e){e>=0&&e<this.sheets.length&&(this.annotationManager.hideAnnotationsOfCurrentSheet(),this.currentSheetIndex=e,this.annotationManager.showAnnotationsOfCurrentSheet(),this.updateView())},getCurrentSheet:function(){return this.sheets[this.currentSheetIndex]},setZoomScale:function(e){this.zoomScale=e;var t=this.frmWindow.getViewpoint(),n=100*this.sheetCameraDistance/this.zoomScale;t.moveTo({distanceToTarget:n,duration:200}),this.frmWindow.getViewer().render()},getZoomScale:function(){return this.zoomScale},updateView:function(){for(var e=0;e<this.sheets.length;e++)e===this.currentSheetIndex?this.sheets[e].node.setVisibility(!0):this.sheets[e].node.setVisibility(!1);this.frmWindow.getViewer().render()},onPostCreate:function(){var e=this.frmWindow.getViewer();this.pad3DViewer.displayStatusBar(!1),e.setPicking({activated:!1,trapSelection:!1,displayHL:!1}),e.setPrePicking({activated:!1,displayHL:!1}),e.set2DMode(!0),this._parent()}})}),define("DS/3DPlayDrawingExperience/3DPlayDrawingPreview",["DS/3DPlayDrawingExperience/3DPlayDrawingExperience"],function(e){"use strict";return e.extend({init:function(e){this._parent(e),e.workbenchs=[],e.workbenchs.unshift({name:"3DPlayDrawingPreview",module:"3DPlayDrawingExperience"})},dispose:function(){this._parent()},onPreCreate:function(){this.args.visu={picking:!1},this._parent();var e=this;this.args.ui={keepActionbarClosed:!0,onActionBarReady:function(){e&&e.frmWindow&&(e.frmWindow.getActionBar().close(),e=void 0)}},this.mabModel={speeddial:[{id:"Reframe",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"Previous",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"Next",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience"}]}}})});