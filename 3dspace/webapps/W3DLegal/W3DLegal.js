define("DS/W3DLegal/W3DLegal",["UWA/Core","UWA/Element","UWA/Utils","UWA/Utils/Client","UWA/Event","UWA/Class/View","DS/WAFData/WAFData","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Button","DS/UIKIT/Modal","DS/UIKIT/SuperModal","DS/UIKIT/DropdownMenu","DS/TopBarProxy/TopBarProxy","i18n!DS/W3DLegal/assets/nls/W3DLegal","css!DS/W3DLegal/W3DLegal"],function(e,t,n,o,i,s,a,l,c,r,d,p,u,f){"use strict";var h={superModal:null,messages:Object.create(null),elements:{},viewportWidth:0,init:function(t){h.elements.container=e.createElement("div",{class:"alert-legal"}).inject(t),h.intResizeEvent()},intResizeEvent:function(){t.addEvent.call(window,"resize",h.updatePositions)},removeResizeEvent:function(){t.removeEvent.call(window,"resize",h.updatePositions)},notify:function(e,t){var n=k._legal,o=h.superModal;o||(o=new d({className:"legal-notifier"}),h.superModal=o),n.grantModal&&n.grantModal.hide(),o.alert(t||e,function(){n.grantModal&&n.grantModal.show()})},createBottomMessage:function(t){var n,o,i,s,a=h,l=t.msg,c=a.messages,r=t||{},d=Object.keys(c).length,p=a.elements.container,u=t.envId;if(!c[u])return(n=e.createElement("div",{class:"alert-legal-message",text:l,styles:{zIndex:d}})).inject(p),s={id:u=t.envId,element:n},c[u]=s,(o=e.createElement("span",{class:"fonticon fonticon-cancel-circled icon-close"})).inject(n,"bottom"),o.addEvent("click",a.onMessageClose.bind(null,s,r)),e.is(r.onInfo,"function")&&((i=e.createElement("span",{class:"fonticon fonticon-info-circled icon-info"})).inject(n,"top"),i.addEvent("click",a.onMessageInfo.bind(null,s,r))),a.updatePositions({force:!0}),s},removeMessage:function(e){var t=h,n=t.messages;t.messages[e.id].element.destroy(),delete n[e.id],t.updatePositions({force:!0})},onMessageInfo:function(t,n){e.is(n.onInfo,"function")&&n.onInfo(n)},onMessageClose:function(t,n){h.removeMessage(t),e.is(n.onClose,"function")&&n.onClose(n)},updatePositions:function(e){var t=h,n=t.messages,o=e||{},i=Object.keys(n),s=window.innerWidth||document.documentElement.clientWidth,a=0;(t.viewportWidth!==s||o.force)&&(i.forEach(function(e){var t=n[e].element;t.setStyle("bottom",Math.round(a)),a+=t.getDimensions().outerHeight}),t.viewportWidth=s)}},m={checkoutticket:"/resources/AppsMngt/environment/checkoutticket",failurePage:"/resources/AppsMngt/uploadfile/message?error=true",eServiceError:"/enovia/eServiceError.jsp",init:function(e){m.initUrls(e.myAppsUrl)},initUrls:function(t){m.myAppsBaseUrl=t&&"string"===e.typeOf(t)?t:""},buildCheckoutForm:function(t,n){var o=e.createElement("form",{method:"POST",action:n.fcsUrl,enctype:"application/x-www-form-urlencoded",style:{display:"none"}});return e.createElement("input",{type:"hidden",value:m.myAppsBaseUrl+m.failurePage,name:"__fcs__failurePage",id:"__fcs__failurePage"}).inject(o),e.createElement("input",{type:"hidden",value:n.fcsJobTicket,name:"__fcs__jobTicket",id:"__fcs__jobTicket"}).inject(o),e.createElement("input",{type:"hidden",value:t,name:"file_0_name",id:"file_0_name"}).inject(o),o},doCheckout:function(e){var t={envid:e.envid,file:e.file},i=e.file;"url"===(e&&e.ressourceType)?window.open(e.file,"_blank"):m.doRequest(m.myAppsBaseUrl+m.checkoutticket,t,{onComplete:function(e){var t=window&&window.ds&&window.ds.env&&"MOBILE"===window.ds.env;if(o.Platform.android&&!t){var s=m.buildCheckoutForm(i,e);s.inject(document.body),s.submit(),n.setImmediate(s.destroy)}else{var a=n.toQueryString({__fcs__failurePage:m.myAppsBaseUrl+m.failurePage,__fcs__jobTicket:e.fcsJobTicket,file_0_name:i,__fcs__attachment:!0});window.location=e.fcsUrl+"?"+a}}})},doRequest:function(t,o,i){var s={Accept:"application/json","Accept-Language":k._legal.language};o=(o=n.toQueryString(o)).length>0?"?"+o:"",a.authenticatedRequest(t+o,{timeout:15e3,method:"GET",type:"json",headers:s,data:void 0,cache:-1,onComplete:function(t){v.isResultValid(t)?e.is(i.onComplete,"function")&&i.onComplete(t):(h.notify(f.errorMsg),e.is(i.onFailure,"function")&&i.onFailure(t))},onFailure:function(t){"function"==typeof i.onFailure?i.onFailure(t):e.log(t.error?t.error:t)}})}},g=s.extend({tagName:"footer",className:"w3dfooter",elements:null,items:null,domEvents:{"click .list-itm-wrap":"onItemClick"},setup:function(e){this.items=e.items,this._parent(e)},render:function(){var t=this,n={},o=t.getContent(),i=e.createElement;return o=t.getContent(),n.list=i("ul",{class:t.className+"-list"}).inject(o),t.items.forEach(function(e){t._buildItem(e).inject(n.list)}),n.toggler=i("span",{class:t.className+"-toggler fonticon fonticon-2x",events:{click:function(){t.container.toggleClassName("full")}}}).inject(o).hide(),t.elements=n,t.container.addEvent("resize",t._updateTogglerVisibility.bind(t)),t},_updateTogglerVisibility:function(){if(this.container.clientWidth!==this._previousContainerWidth){var e=this.elements.list,t=parseInt(window.getComputedStyle(this.container).minHeight),n=this.elements.toggler;e.scrollHeight>t?n.show():n.hide(),this._previousContainerWidth=this.container.clientWidth}},_buildItem:function(t){var n,o=e.createElement,i=o("li",{class:this.className+"-list-itm",name:t.name}),s={class:"list-itm-wrap",text:t.text};return t.html&&(s.html=t.html),n=o("span",s).inject(i),e.merge(t,{clickable:!0}),t.clickable&&i.addClassName("clickable"),t.icon&&o("div",{class:"fonticon "+t.icon}).inject(n),i},onItemClick:function(e){var t=i.getElement(e);this.dispatchEvent("onClick",[this,e,t.parentElement])},destroy:function(){this._parent()}}),v={_baseURL:"",APPS_MNGT:"/resources/AppsMngt/",GET_LEGAL:"user/startup",SET_LEGAL:"user/setlegal",isResultValid:function(t){var n,o=!1;return t&&(t.code&&"0"!==t.code||t.error||t.status?(n=t.message&&""!==t.message?t.message:t.error&&t.error.type?t.error.type:t.error?t.error:t.status?t.status:t,e.log(n)):o=!0),o},init:function(t){var n=t.myAppsUrl||"";e.is(n,"string")&&(v._baseURL=n.replace(/\/$/g,""))},fetchUserLegal:function(t){var n=v._baseURL+v.APPS_MNGT+v.GET_LEGAL,o=t.params?e.Utils.toQueryString(t.params):"";a.authenticatedRequest(o?n+"?"+o:n,{timeout:11e3,method:"GET",type:"json",cache:-1,headers:{Accept:"application/json","Accept-Language":k._legal.language},onComplete:t.onComplete,onFailure:t.onFailure})},setUserLegal:function(e,t){var n=t||{},o=v._baseURL+v.APPS_MNGT+v.SET_LEGAL+(n.isCookie?"/cookie":"");a.authenticatedRequest(o,{method:"POST",type:"json",data:{envids:e.join(",")},onComplete:n.onComplete,onFailure:n.onFailure,cache:-1})}},y=e.Class.extend({chineseTenantRegex:/aph7|apc2/i,nonAcceptedTerms:null,nonAcceptedCookies:null,acceptedTerms:null,allEnvs:null,acceptedCbList:[],grantModal:null,grants:[],isAccessValid:!1,myAppsBaseUrl:null,aboutHandler:null,footerEventHandler:null,dropdownEventHandler:null,isReady:!1,language:null,COOKIE_KEY:"swymlang",config:null,acceptedTou:null,acceptedDp:null,acceptedCookies:null,legalInfos:null,swymTenants:null,elements:{},dsCn:"达索析统（上海）信息技术有限公司",icpReordal:"沪ICP备14051708号",cnMinistry:"http://www.beian.miit.gov.cn",defaultOptions:{onAccept:function(){},onFailure:function(){},renderFooter:!0,footerContainer:document.body,onAboutClick:null,legal:null,swym:null,tenandId:null,myAppsBaseUrl:""},filterEnvironments:function(e){var t=this,n=[],o=[],i=[],s=[],a=[],l=[],c=[],r=[],d=[],p=!1;return e.forEach(function(e){var u,h,m,g=e.cookie,v=t.isValid(e.tos),y=t.isValid(e.dp);u={id:e.id,tou:e.tos,name:e.displayName,type:f.termsOfUse,env:e},h={id:e.id,dp:e.dp,name:e.displayName,type:f.dataPrivacy,env:e},v&&(t.isValidNotAccepted(e.tos,e.acceptedTOS)?a.push(u):s.push(u)),y&&(t.isValidNotAccepted(e.dp,e.acceptedDP)?l.push(h):i.push(h)),(v||y)&&(e.accepted&&e.acceptedDP&&e.acceptedTOS?n.push(e):(!e.acceptedDP&&y||!e.acceptedTOS&&v)&&o.push(e)),e.footerDisplay&&(p=!0),g&&g.message&&(m={id:e.id,cookie:e.cookie.file,name:e.displayName,message:e.cookie.message,type:"Cookie",env:e},g.accepted?r.push(m):c.push(m)),e.legalInfo&&d.push({id:e.id,legalInfo:e.legalInfo,name:e.displayName,type:f.legalInfo,env:e})}),{acceptedTerms:n,nonAcceptedTerms:o,acceptedTou:s,nonAcceptedTou:a,acceptedDp:i,nonAcceptedDp:l,acceptedCookies:r,nonAcceptedCookies:c,legalInfos:d,envDisplayFooter:p}},mergeTos:function(e,t){var n=e.concat(t);return n.forEach(function(e){return-1!==t.indexOf(e)&&(e.acceptedDP=!!e.dp,e.acceptedTOS=!!e.tos),e.tos||e.dp}),n},isValidNotAccepted:function(e,t){return this.isValid(e)&&!t},isValid:function(t){return t&&e.is(t,"string")},buildTermsToAccept:function(e){var t=this,n=[];return e.forEach(function(e){n.push(t.buildEnvToAccept(e))}),n},buildEnvToAccept:function(t){var n=e.createElement("div",{class:"w3dlegal-env",html:'<div class="w3dlegal-env-title" name="'+t.id+'">'+t.displayName+'</div><div class="w3dlegal-env-msg"><p></p><div class="w3dlegal-env-links"></div></div>'}),o=n.getElement(".w3dlegal-env-links"),i=n.getElement(".w3dlegal-env-msg"),s=new l({type:"checkbox",checked:!1,value:"",label:"",className:"w3dlegal-toggle primary",name:t.displayName,events:{onChange:this.updateAcceptButtonState.bind(this)}});return e.is(t.message,"string")&&i.getElement("p").appendText(t.message),this.isValidNotAccepted(t.tos,t.acceptedTOS)&&this.buildLink(t,!0).inject(o),this.isValidNotAccepted(t.dp,t.acceptedDP)&&this.buildLink(t).inject(o),s.elements.container.inject(i,"before"),this.grants.push(s),n},buildLink:function(t,n){var o=this,i=t,s=!!n,a=e.createElement("span",{class:"w3dlegal-link-ctn",html:'<span class="fonticon fonticon-doc-text"></span><a class="w3dlegal-link">'+(n?f.termsOfUse:f.dataPrivacy)+"</a>"});return a.addEvent("click",function(){o.checkOut.doCheckout({envid:i.id,file:s?i.tos:i.dp})}),a},acceptHandler:function(){0===this.getNonValid().length?(this.acceptButton.disable(),this.sendTos()):this.notifier.notify(f.warning,f.notValid)},isTenantTypePresent:function(e,t){return t.some(function(t){return t&&t.url&&t.url.test(e)})},onReceivedTos:function(t,n){var o,i,s=this.filterEnvironments(t);this.allEnvs=t,e.extend(this,s),this.swymTenants=n,this.nonAcceptedTerms.length?(i=new r({header:"<h4>"+f.legalNotice+"</h4>",body:this.buildTermsToAccept(this.nonAcceptedTerms),closable:!1,escapeToClose:!1,className:"w3dlegal-modal",renderTo:document.body}),(o=new c({value:f.okBtn,className:"primary",events:{onClick:this.acceptHandler.bind(this)}})).inject(i.getFooter()),this.grantModal=i,this.acceptButton=o,this.updateAcceptButtonState(),i.show()):this.onAcceptedTerms()},getNonValid:function(){return this.grants.filter(function(e){return!e.isChecked()})},updateAcceptButtonState:function(){this.getNonValid().length?this.acceptButton.disable():this.acceptButton.enable()},sendTos:function(){var t=this;t.platformAccess.setUserLegal(t.nonAcceptedTerms.map(function(e){return e.id}),{onComplete:function(n){e.is(n.code)&&"0"===n.code.toString()?(t.isAccessValid=!0,t.grantModal.hide(),t.onAcceptedTerms()):function(){this.notifier.notify(f.error,f.errorMsg),e.log("Legal: Could not set user grants.")}()},onFailure:function(){t.acceptButton.enable(),t.notifier.notify(f.error,f.errorMsg),e.log("Legal: Could not set user grants.")}})},onAcceptedTerms:function(){this.acceptedTerms=this.mergeTos(this.acceptedTerms,this.nonAcceptedTerms),this.nonAcceptedTerms=[],this.acceptedTou=this.acceptedTou.concat(this.nonAcceptedTou),this.nonAcceptedTou=[],this.acceptedDp=this.acceptedDp.concat(this.nonAcceptedDp),this.nonAcceptedDp=[],this.acceptedCookies=this.acceptedCookies.concat(this.nonAcceptedCookies),this.callAcceptedCbs(),this.onAccept.call(null,{legal:e.clone(this.allEnvs),isFooterRendered:this.renderFooter&&this.envDisplayFooter&&this.footerContainer}),this.isReady=!0,this.renderHelpLegal=!(!this.acceptedTou.length&&!this.acceptedDp.length),this.renderHelpLegal&&this.addHelpMenuLegal(),this.renderFooter&&this.displayFooter(),this.acceptButton&&this.acceptButton.destroy(),this.grantModal&&this.grantModal.destroy(),this.displayCookies(this.nonAcceptedCookies),this.grantModal=null,this.acceptButton=null},callAcceptedCbs:function(){var e,t;for(e=0,t=this.acceptedCbList.length;e<t;e++)this.acceptedCbList[e].call(null,this.acceptedTerms)},initUrls:function(e){this.myAppsBaseUrl=e.replace(/\/$/g,""),this.checkOut.init({myAppsUrl:this.myAppsBaseUrl}),this.platformAccess.init({myAppsUrl:this.myAppsBaseUrl})},fetchAcceptedTerms:function(e){this.acceptedTerms?e.call(null,this.acceptedTerms):this.acceptedCbList.push(e)},displayCookies:function(e){var t=this,n=t.checkOut,o=t.platformAccess;function i(e){var n=e.cookie;n.accepted||o.setUserLegal([e.envId],{isCookie:!0,onComplete:function(){n.accepted=!0;var e=t.nonAcceptedCookies.indexOf(n);t.nonAcceptedCookies.splice(e,1)}})}function s(e){var t=e||{},o=t.cookie;o&&o.cookie&&t.envId&&n.doCheckout({envid:t.envId,file:o.cookie})}e.forEach(function(e){t.notifier.createBottomMessage({msg:e.message,envId:e.id,cookie:e,onClose:i,onInfo:e.cookie?s:null})})},displayFooter:function(t,n){var o;if((t=t||this.footerContainer)&&this.envDisplayFooter)return this.footer&&this.footer.destroy(),o=this.getFilteredLegalInfos(function(e){return e.env&&e.env.footerDisplay}),this.footer=this.buildFooter(e.merge(o,{aboutHandler:this.aboutHandler})),this.footer.inject(t,n)},buildFooter:function(t){var n,o=e.merge(t||{},{acceptedTou:[],acceptedDp:[],acceptedCookies:[],legalInfos:[],aboutHandler:null,others:[]});return(n=new g({items:this.getFooterItems(o).concat(o.others),legalInfo:o,events:{onClick:this.footerEventHandler}})).render(),this.dropdownEventHandler=this.footerEventHandler.bind(this,n),this.buildDropdowns(n,o),n},addHelpMenuLegal:function(){var e=this.getFilteredLegalInfos(function(e){return e});this.addHelpMenuLegalElements(e)},addHelpMenuLegalElements:function(e){var t,n,o=this,i=[],s={legalInfos:{label:"legalInfo",nlsLabel:"legalInfo",order:1},acceptedTou:{label:"tou",nlsLabel:"termsOfUse",order:2},acceptedDp:{label:"dp",nlsLabel:"dataPrivacy",order:3},acceptedCookies:{label:"cookie",nlsLabel:"cookies",order:4},others:{order:5}};function a(e,t){var n,o=s[e].label;"cookie"!==(n={file:t[o],envid:t.id,type:o,ressourceType:t.env&&t.env.ressourceType}).type.toLowerCase()||n.file?n&&m.doCheckout(n):this.displayCookies([t])}o.topBarProxyInstance=o.topBarProxyInstance||new u({id:"helpMenu"}),Object.keys(e).sort(function(e,t){return s[e].order<s[t].order?-1:1}).forEach(function(l){t=e[l]||[],n=s[l].nlsLabel,"others"===l&&t.length>0?i.push({label:t[0].text,submenu:[{label:t[1].text,onExecute:function(){window.open(t[1].link)}}]}):1===t.length?i.push({label:f[n],onExecute:a.bind(o,l,t[0])}):t.length>1&&i.push({label:f[n],submenu:t.map(function(e){return{label:e.type&&"cookie"!==e.type.toLowerCase()?e.type+" - "+e.name:e.name,onExecute:a.bind(o,l,e)}})})}),o.topBarProxyInstance.empty(),o.topBarProxyInstance.addContent({help:i})},buildDropdowns:function(e,t){var n="legal-dropdown",o="[name={name}] .list-itm-wrap",i={onClick:this.dropdownEventHandler},s=t.acceptedTou,a=t.acceptedDp,l=t.acceptedCookies,c=t.legalInfos,r=e.getContent();s.length>1&&(this.touDropdown=new p({position:"top left",className:n,items:this.getDropdownItems(s),target:r.getElement(o.replace("{name}","tou")),zindex:1050,events:i})),a.length>1&&(this.dpDropdown=new p({position:"top left",className:n,items:this.getDropdownItems(a),target:r.getElement(o.replace("{name}","dp")),zindex:1050,events:i})),l.length>1&&(this.cookieDropdown=new p({position:"top left",className:n,items:this.getDropdownItems(l),target:r.getElement(o.replace("{name}","cookies")),zindex:1050,events:i})),c.length>1&&(this.legalInfosDropdown=new p({position:"top left",className:n,items:this.getDropdownItems(c),target:r.getElement(o.replace("{name}","legalinfo")),zindex:1050,events:i}))},onFooterItemClick:function(t,n,o){var i,s,a=this.checkOut,l=t.options.legalInfo;if(e.is(o,"element"))switch(o.getAttribute("name")){case"tou":if(l.acceptedTou.length>1)return;s={file:(i=l.acceptedTou[0]).tou,envid:i.id,type:"tou",ressourceType:i.env&&i.env.ressourceType};break;case"dp":if(l.acceptedDp.length>1)return;s={file:(i=l.acceptedDp[0]).dp,envid:i.id,type:"dp",ressourceType:i.env&&i.env.ressourceType};break;case"cookies":if(l.acceptedCookies.length>1)return;s={file:(i=l.acceptedCookies[0]).cookie,envid:i.id,type:"cookie",ressourceType:i.env&&i.env.ressourceType};break;case"about":this.aboutHandler&&this.aboutHandler();break;case"legalinfo":if(l.legalInfos.length>1)return;s={file:(i=l.legalInfos[0]).legalInfo,envid:i.id,type:"legalinfo",ressourceType:i.env&&i.env.ressourceType}}else o.id&&o.icon&&(s={file:o.file,envid:o.envid,type:o.type,ressourceType:o.ref&&o.ref.env&&o.ref.env.ressourceType});s&&s.type&&"cookie"===s.type.toLowerCase()&&!s.file?this.displayCookies([i||o.ref]):s&&a.doCheckout(s)},getFilteredLegalInfos:function(t){var n=[];return this.isTenantTypePresent(this.chineseTenantRegex,this.swymTenants)&&(n=[{text:this.dsCn,name:"dsCn",clickable:!1},{html:'<a target="_blank" href='+this.cnMinistry+">"+this.icpReordal+"</>",name:"icpReordal",text:this.icpReordal,link:this.cnMinistry,env:{footerDisplay:!0}}]),e.clone({acceptedTou:this.acceptedTou.filter(t),acceptedDp:this.acceptedDp.filter(t),acceptedCookies:this.acceptedCookies.filter(t),legalInfos:this.legalInfos.filter(t),others:n.filter(t)})},getFooterItems:function(e){var t=[],n="fonticon-down-open",o=e.legalInfos.length,i=e.acceptedTou.length,s=e.acceptedDp.length,a=e.acceptedCookies.length;return o>=1&&t.push({text:f.legalInfo+" ",name:"legalinfo",icon:o>1?n:null}),e.aboutHandler&&t.push({text:f.about3DExp+" ",name:"about",handler:this.aboutHandler}),i>=1&&t.push({text:f.termsOfUse+" ",name:"tou",icon:i>1?n:null}),s>=1&&t.push({text:f.dataPrivacy+" ",name:"dp",icon:s>1?n:null}),a>=1&&t.push({text:f.cookies+" ",name:"cookies",icon:a>1?n:null}),t},getDropdownItems:function(e){return e.map(function(e){return{text:e.type&&"cookie"!==e.type.toLowerCase()?e.type+" - "+e.name:e.name,icon:"fonticon fonticon-doc-text",ref:e,type:e.type,file:e.tou||e.dp||e.cookie||e.legalInfo,envid:e.id}})},getCurrentLanguage:function(){var e,t,n=this.COOKIE_KEY,i=[];return e=null,t=document.cookie.split(";"),(i=t.filter(function(e){return e.toLowerCase().indexOf(n.toLowerCase())>=0})).length>0&&(e=i[0].split("=")[1]),e||window.dsLang||o.Locale.lang},init:function(t){var n=this,o=e.merge(t||{},n.defaultOptions);n.checkOut=m,n.platformAccess=v,n.notifier=h,n.language=n.getCurrentLanguage(),n.initUrls(o.myAppsBaseUrl),n.onAccept=o.onAccept,n.onFailure=o.onFailure,n.renderFooter=o.renderFooter,n.footerContainer=o.footerContainer,n.aboutHandler=o.onAboutClick,n.swymTenants=o.swym,n.footerEventHandler=n.onFooterItemClick.bind(n),n.notifier.init(document.body),Array.isArray(o.legal)&&Array.isArray(o.swym)?n.onReceivedTos(o.legal,o.swym):n.platformAccess.fetchUserLegal({params:o.tenantId?{platform:o.tenantId}:null,onComplete:function(e){n.platformAccess.isResultValid(e)?n.onReceivedTos(e.legal,e.swym):(n.notifier.notify(f.errorMsg),n.onFailure())},onFailure:function(){e.log("Legal: Startup parameters could not be fetched"),n.onFailure()}})}}),k={_legal:null,init:function(t){this._legal?e.log("Legal: bad parameters for Legal module initialization"):(this._legal=y.singleton({uninitializedCalls:"throw"}),this._legal.init(t))},isAccessValid:function(){return!!this._legal.isAccessValid},displayFooter:function(){var e=this._legal;return e.isReady&&e.displayFooter.apply(e,arguments)},fetchAcceptedTerms:function(){return this._legal.fetchAcceptedTerms()}};return k});