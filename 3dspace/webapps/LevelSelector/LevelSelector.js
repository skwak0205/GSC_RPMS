/*! Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/LevelSelector/LevelSelector",["UWA/Core","UWA/Class","UWA/Element","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","css!DS/LevelSelector/LevelSelector.css"],function(e,t,n,l,o){"use strict";var i,r,a=t.extend({init:function(){var t,r,a,s,c,d,v=e.createElement("div",{id:"LevelSelector"}),u=e.createElement("div",{id:"selector-indic",class:"levelselector-indic"}),p=e.createElement("div",{id:"selector-name",class:"levelselector-info levelSelectorTextProperties"}),f=e.createElement("div",{class:"transparent"});f.setStyle("position","absolute");var m,y,h,b,g,S,C,w,E,T,k=0,N=!1,x=!1,W=function(e){var t=!1;return e&&e.type&&("touchmove"===e.type||"touchstart"===e.type||"touchend"===e.type)&&(t=!0),t};function I(e){return x?10*(e+1)+5:14*e+10}function P(){if(E&&E.backgroundColor){var e=new o.Color(E.backgroundColor);255*e.getHSL().l>120?p.removeClassName("white"):p.addClassName("white"),p.setStyle("background-color","rgb("+255*e.r+","+255*e.g+","+255*e.b+")")}}var L,A,V=function(){var e;function t(e,t,n,l){e.forEach(function(e){n?e.addClassName(t):e.removeClassName(t)}),l&&l()}return function(n,l,o){clearTimeout(e),e=void 0,l?(t(n,"transparent",l),!0!==i?e=setTimeout(function(){t(n,"hidden",l,o)},100):t(n,"hidden",l,o)):(t(n,"hidden",l),!0!==i?setTimeout(function(){t(n,"transparent",l,o)},10):t(n,"transparent",l,o))}}(),j=function(t){if(t&&s){var n=parseInt(t.id.replace("levelSelector-",""),10),l=t.getElement("canvas");if(!l)return;var o=I(n),i=l.getContext("2d");i.clearRect(0,0,20,o),i.lineWidth=C!==n||h&&h===b?1:2,i.strokeStyle=C===n?c:"#bebebe",i.fillStyle=s[n-1].canvasColor?s[n-1].canvasColor:"#dcdcdc";var r=s[n-1].selection;if(t===b){i.lineWidth=1,i.strokeStyle="#bebebe",i.fillStyle="notSelectable"===r?"#c0c0c0":"#82bedc",i.fillStyle=C===n?d:i.fillStyle,t===h&&(i.fillStyle="notCurrent"===r?"#285a78":"notSelectable"===r?"#c0c0c0":c);var a=e.is(y);u.setStyles({"border-bottom-color":a?i.fillStyle:"","border-top-color":a?"":i.fillStyle}),p.setStyle("border-color",i.fillStyle)}else h&&h===b&&h!==t&&(i.strokeStyle="#bebebe");i.beginPath(),i.moveTo(19,1),i.lineTo(19,o-1),i.lineTo(1,o-6),i.lineTo(1,x?1:6),i.lineTo(19,1),i.fill(),i.beginPath(),i.moveTo(19,1),i.lineTo(19,o-1),i.lineTo(1,o-6),i.lineTo(1,x?1:6),i.lineTo(19,1),i.stroke()}},D=function(e,t){if(t&&e){var n=parseInt(e.id.replace("levelSelector-",""),10);t({pathElement:s[n-1].pathElement})}},H=function(t){if(!(t.labelWidth&&t.iconWidth||t.labelWidth&&!t.iconWidth&&!t.icon||!t.labelWidth&&t.iconWidth&&!t.name)){if(!t.labelWidth&&t.name){var n=e.createElement("span",{class:"levelSelectorTextProperties transparent"});n.innerText=t.name,n.inject(f);var l=setInterval(function(){s?n.offsetWidth>0&&(t.labelWidth=n.offsetWidth,n.destroy(),clearInterval(l)):(n.destroy(),clearInterval(l))},10)}if(!t.iconWidth&&t.icon){var o,i=e.createElement("img",{class:"transparent"});i.src=t.icon,i.inject(f),i.onerror=function(){t.icon="",i.destroy(),clearInterval(o)},o=setInterval(function(){s?i.naturalWidth>0&&(t.iconWidth=i.naturalWidth,i.destroy(),clearInterval(o)):(i.destroy(),clearInterval(o))},10)}}},q=function(){function t(){k=0,V([u,p],!0,function(){p.empty(!0),p.innerText="",p.removeAttribute("style"),P()})}return function(n){if(s){for(var l=0;l<s.length;l++)H(s[l]);var o=b&&n===b?n:w?v.querySelector("#levelSelector-"+C):null;if(o){var i=parseInt(o.id.replace("levelSelector-",""),10),r=s[i-1],a=r.name,c=r.icon,d=e.is(y),f=a&&"string"==typeof a&&a.trim(),h=c&&"string"==typeof c&&c.trim();if(f||h){var g=I(s.length),S=[p];if(x||S.push(u),V(S,!1),x||(u.style.left=30*(i-1)+10+5-u.offsetWidth/2+"px",u.style.top=d?"-15px":g+13+"px",d?u.setStyles({"border-bottom-width":"16px","border-bottom-style":"solid","border-top-width":"","border-top-style":""}):u.setStyles({"border-top-width":"16px","border-top-style":"solid","border-bottom-width":"","border-bottom-style":""})),x||p.setStyles({top:d?"-53px":g+35+"px"}),f){p.innerText=a;var E=r.labelWidth||8*a.length;if(E+=16,h){var T=r.iconWidth||16;p.setStyle("background-image","url("+c+")"),p.setStyle("padding-left",T+10+"px"),E+=T+5}else p.setStyles({"background-image":"","padding-left":""});if(!x){var k=v.offsetLeft,N=k+15-E/2,W=k+30*(i-1)-2+15+E/2,P=30*(i-1)+15-E/2;if(N<0)P-=N;else{var L=m.getParent().getSize().width;W>L&&(P-=W-L)}p.setStyle("left",P+"px")}}else p.innerText="",p.setStyles({"background-image":"","padding-left":""}),e.createElement("img",{class:"levelselector-info-icon",src:c}).inject(p),p.setStyle("left",30*(i-1)-2+"px");var A=v.querySelector(".levels");A&&x&&A.setStyle("top",p.offsetHeight+"px")}else t()}else t()}}}(),M=!1,O=function(e){S&&"@onViewpointBeginMove"===e.eventType?M=!0:S&&"@onViewpointChange"===e.eventType&&M?v.addClassName("hidden"):S&&"@onViewpointEndMove"===e.eventType?(v.removeClassName("hidden"),M=!1):N&&"@onMoveEvent"===e.eventType&&e.event&&e.event.deltaPosition&&(0!==e.event.deltaPosition.x||0!==e.event.deltaPosition.y)&&++k>=5&&(j(b),D(b,a),b=null,q())},U=function(e){var t=null,n=e.changedTouches[0].clientX,l=e.changedTouches[0].clientY,o=v.getBoundingClientRect();return v.getElements('div[id^="levelSelector"]').some(function(e){var i=e.getPosition(),r=e.getDimensions(),a=i.x+o.left,s=a+r.width,c=i.y+o.top,d=c+r.height;return a<=n&&n<=s&&c<=l&&l<=d&&(t=e,!0)}),t},B=function(e){var n="keydown"===e.type;N=!0,k=0,y=void 0;var l=e.key||e.keyIdentifier,o=e.which||e.keyCode,i=null;if(!n||39!==o&&38!==o&&"ArrowRight"!==l&&"ArrowUp"!==l)if(!n||37!==o&&40!==o&&"ArrowLeft"!==l&&"ArrowDown"!==l){if(13===o||"Enter"===l){if(b)if(n)h=b,j(b);else{var c=h;if(h=null,c&&c===b){if(!c.hasClassName("notselectable")){if(C){var d=parseInt(c.id.replace("levelSelector-",""),10);if("notCurrent"!==s[d-1].selection&&C!==d){var u=v.querySelector("#levelSelector-"+C);C=d,j(u)}}D(c,t)}j(c)}}return}}else b?(i=parseInt(b.id.replace("levelSelector-",""),10),--i<1&&(i=1)):i=s.length;else b?(i=parseInt(b.id.replace("levelSelector-",""),10),++i>s.length&&(i=s.length)):i=1;if(i&&v.querySelector("#levelSelector-"+i)!==b){var p=b;b=v.querySelector("#levelSelector-"+i),j(p),D(p,a),j(b),q(b),D(b,r)}},X=function(e){if(N=!1,0===e.button&&1===e.buttons){if(L=l.subscribe({event:"/VISU/onLeftMouseUp"},function(e){l.unsubscribe(L),L=void 0,e&&e.from&&0!==e.from.length&&e.from[0].view&&e.from[0].view.className&&(0===e.from[0].view.className.search("level")||0===e.from[0].view.className.search("canvas"))||(h=null)}),y=void 0,j(h=this),!h.hasClassName("notselectable")&&C){var t=v.getElement("div#levelSelector-"+C);if(t!==h){var n=parseInt(h.id.replace("levelSelector-",""),10);"notCurrent"!==s[n-1].selection&&j(t)}}}else h=null},Y=function(e){N=!1,1===e.touches.length&&(y=e.touches[0].identifier,e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),b=U(e),D(b,r),j(b),q(b))},z=function(t){N=!1;var n,l=this;if(W(t)&&(t.preventDefault(),t.stopPropagation(),l=U(t)),l!==b){var o=b;if(b=l,j(o),D(o,a),h&&o===h&&C&&(n=v.getElement("div#levelSelector-"+C))!==h&&j(n),W(t)&&(!l||!e.is(y)||1!==t.changedTouches.length||y!==t.changedTouches[0].identifier))return q(l),void(b=void 0);D(l,r),j(l),h&&C&&!l.hasClassName("notselectable")&&(n=v.getElement("div#levelSelector-"+C))!==h&&n!==l&&j(n),q(l)}},R=function(){y=void 0,N=!1;var e=b;if(b=void 0,j(e),h&&e===h&&C){var t=v.getElement("div#levelSelector-"+C);t!==h&&j(t)}D(e,a),q()},F=function(e){if(N=!1,0===e.button&&0===e.buttons){var n=h;if(h=null,n&&n===this){if(!n.hasClassName("notselectable")){if(C){var l=v.querySelector("#levelSelector-"+C),o=parseInt(n.id.replace("levelSelector-",""),10);"notCurrent"!==s[o-1].selection&&(C=o),j(l)}D(n,t)}j(n)}else j(n)}},K=function(n){N=!1,n.preventDefault(),n.stopPropagation();var l=U(n);if(l&&e.is(y)&&1===n.changedTouches.length&&y===n.changedTouches[0].identifier){if(h=l,j(l),C){var o=v.getElement("div#levelSelector-"+C);o!==h&&j(o)}setTimeout(function(){var e=h;b=h=void 0,j(e),D(e,a),e.hasClassName("notselectable")||(D(e,t),C&&(C=parseInt(e.id.replace("levelSelector-",""),10))),j(e),q()},100)}};this.createView=function(o){if(A&&(clearTimeout(A),A=void 0,v.remove(),v.empty(!0)),g&&(v.remove(),v.empty(!0),t=r=a=s=void 0,m=y=b=C=h=void 0,l.unsubscribe(g),g=void 0,E&&(E.unsubscribe(T),T=E=void 0),n.removeEvent.call(document,"keydown",B),n.removeEvent.call(document,"keyup",B)),!(!o.uiFrame||!o.hasOwnProperty("display")&&("number"!=typeof o.positionX||"number"!=typeof o.positionY)||o.hasOwnProperty("display")&&(!o.display||!o.display.type||"position"!==o.display.type&&"docked"!==o.display.type||"position"===o.display.type&&("number"!=typeof o.display.x||"number"!=typeof o.display.y)||"docked"===o.display.type&&o.hasOwnProperty("marginW")&&"number"!=typeof o.display.marginW||"docked"===o.display.type&&o.hasOwnProperty("marginH")&&"number"!=typeof o.display.marginH)||!o.getLevels||"function"!=typeof o.getLevels||!o.onSelect||"function"!=typeof o.onSelect||o.onHover&&"function"!=typeof o.onHover||o.onLeave&&"function"!=typeof o.onLeave)){var k;x=o.display&&"docked"===o.display.type,s=null,C=null,w=!1,c="#285a78",d="#558caa";var N=o.getLevels(function(){q(b),k&&s&&k.getChildren().forEach(function(e){j(e)})});if(N instanceof Array?(s=N,C=w=void 0):N instanceof Object&&(s=N.levels,(C="number"==typeof N.currentLevel?N.currentLevel+1:void 0)&&(C<=0||C>s.length)&&(C=void 0),C&&(c="string"==typeof N.selectColor?N.selectColor:c,d="string"==typeof N.selectOverColor?N.selectOverColor:d),w=C&&x),s instanceof Array&&!(s.length<=0)&&s.every(function(e){return e&&null!==e.pathElement&&void 0!==e.pathElement})){m=o.uiFrame,t=o.onSelect,r=o.onHover,a=o.onLeave,v.addClassName("animatable"),v.removeAttribute("style"),v.removeClassName("hidden"),!0===i&&v.removeClassName("animatable"),u.removeAttribute("style"),u.addClassName("transparent"),u.addClassName("hidden"),p.removeAttribute("style"),p.addClassName("transparent"),p.addClassName("hidden"),p.removeClassName("white"),p.empty(!0);var W=s.length;if(x)v.addClassName("docked"),"number"==typeof o.display.marginW&&v.setStyle("margin-right",o.display.marginW+"px"),"number"==typeof o.display.marginH&&v.setStyle("margin-top",o.display.marginH+"px");else{v.removeClassName("docked");var L=m.getParent().getSize(),V=L.width,D=L.height,H=I(W),M="number"==typeof o.positionX?o.positionX+10:o.display.x-15,U="number"==typeof o.positionY?o.positionY-H/2:o.display.y-H/2-7;M+30*W>V?M=V-30*W:M<0&&(M=0),U+H+60>D&&(U=D-60-H),U<0&&(U=0),v.setStyles({left:M,top:U})}k=e.createElement("div",{class:"levels"}).inject(v);for(var _=1;_<=W;_++){var J=I(_),G=e.createElement("div",{id:"levelSelector-"+_,class:"level"});G.setStyle("height",J+14+"px"),x||G.setStyle("top",7*(W-_)+"px"),G.addEvents({mouseenter:z,mouseleave:R,mouseup:F,mousedown:X}),G.addEvents({touchstart:Y,touchmove:z,touchend:K}),"notSelectable"===s[_-1].selection&&G.addClassName("notselectable");var Q=e.createElement("canvas",{id:"canvas"+_,class:"canvas"});Q.inject(G),Q.setAttributes({width:"20px",height:J+"px"}),j(G),!0!==i&&Q.addClassName("transparent"),G.inject(k)}E=void 0,x&&o.background&&o.background.backgroundColor&&(E=o.background,P()),v.inject(m),k.inject(v),x||u.inject(v),p.inject(v),f.inject(v),w&&q();var Z=1;if(!0!==i)var $=setInterval(function(){var e=k.querySelector("#canvas"+Z);e?(e.removeClassName("transparent"),Z++):clearInterval($)},50/W);return S=!0!==o.displayWhileViewpointIsManipulated,!0===o.displayWhileViewpointIsManipulated&&!0===o.disableKeyboard||(g=l.subscribe({event:"/VISU/"},O)),E&&E.onBackgroundModify&&E.unsubscribe&&(T=E.onBackgroundModify(P)),!0!==o.disableKeyboard&&(n.addEvent.call(document,"keydown",B),n.addEvent.call(document,"keyup",B)),0}s=void 0}},this.destroyView=function(){if(!A){if(!0!==i){if(v){for(var e=v.querySelectorAll(".canvas"),o=0;o<e.length;++o)e[o].addClassName("transparent");u.addClassName("transparent"),p.addClassName("transparent"),A=setTimeout(function(){v.remove(),v.empty(!0),A=void 0},100)}}else v.remove(),v.empty(!0);t=r=a=s=void 0,m=y=b=C=h=void 0,l.unsubscribe(g),g=void 0,E&&(E.unsubscribe(T),T=E=void 0),n.removeEvent.call(document,"keydown",B),n.removeEvent.call(document,"keyup",B)}}}}),s=t.singleton({init:function(){Object.defineProperty(this,"_noAnim",{get:function(){return i},set:function(e){i=!0===e||void 0}})},createView:function(e){return r||(r=new a),r.createView(e)},destroyView:function(){if(r)return r.destroyView()}});return s.init(),s});