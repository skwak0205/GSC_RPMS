define("DS/ImageManager/SortManager",[],function(){return{alphaAsc:function(e){return localStorage.setItem("sort","alphaAsc"),e.sort(function(e,t){return e.options.label.localeCompare(t.options.label.toLocaleLowerCase())})},alphaDesc:function(e){return localStorage.setItem("sort","alphaDesc"),e.sort(function(e,t){return t.options.label.localeCompare(e.options.label.toLocaleLowerCase())})},dateAtoB:function(e){return localStorage.setItem("sort","dateAtoB"),e.sort(function(e,t){return new Date(e.options.propertiesList[0])-new Date(t.options.propertiesList[0])})},dateBtoA:function(e){return localStorage.setItem("sort","dateBtoA"),e.sort(function(e,t){return new Date(t.options.propertiesList[0])-new Date(e.options.propertiesList[0])})},sizeAsc:function(e){localStorage.setItem("sort","sizeAsc");var t=this;return e.sort(function(e,n){return t._formatSizes(e.options.propertiesList[1])-t._formatSizes(n.options.propertiesList[1])})},sizeDesc:function(e){localStorage.setItem("sort","sizeDesc");var t=this;return e.sort(function(e,n){return t._formatSizes(n.options.propertiesList[1])-t._formatSizes(e.options.propertiesList[1])})},_formatSizes:function(e){switch(e.match(/[A-z]*$/)[0]){case"MB":return 1e6*parseFloat(e.match(/^[0-9].[0-9]*/)[0]);case"KB":return 1e3*parseFloat(e.match(/^[0-9].[0-9]*/)[0])}}}}),define("DS/ImageManager/SortView",["UWA/Core","UWA/Class/Debug","UWA/Controls/Abstract","DS/WebappsUtils/Performance","i18n!DS/ImageManager/assets/nls/imageManager","DS/UIKIT/Iconbar"],function(e,t,n,o,i,a){"use strict";return n.extend(t,{_view:null,_container:null,_body:null,_defaultItem:[{dataIndex:"size",type:"num",nlsName:i.get("sort_size")},{dataIndex:"title",type:"alpha",nlsName:i.get("sort_title")},{dataIndex:"date",type:"num",nlsName:i.get("sort_date")}],_default_sort:{dataIndex:"date",order:"desc",type:"alpha"},_listItemExtend:[],_activedItem:"",_activedItemId:"",_activedItemOrder:"",_menuIcon:"",init:function(e){this._parent(e);e&&e.container&&(this._container=e.container,this.options=e,e.defaultSort||(this.options.defaultSort=this._default_sort),this._setByDefaultSort(),this.render())},render:function(e){var t=this;this._view=new a({renderTo:t._container,styles:{padding:"0px",marginBottom:"0px",height:"45px"},events:{onClick:function(e){t.getDropdown()?(t.getDropdown().elements.container.setHTML(""),t.getDropdown().setBody(t._getBody())):setTimeout(function(){t.getDropdown().elements.container.setHTML(""),t.getDropdown().setBody(t._getBody()),t.updateStateInPanel()},50),t.updateStateInPanel()}},items:[{fonticon:t._menuIcon?t._menuIcon:t._getIconByTypeAndOrder("alpha","asc"),text:i.get("sortMenuLabel"),content:{type:"dropdown",tag:"ul",options:{className:"dropdown-menu dropdown-menu-root dropdown dropdown-root props_dropdown",events:{onClick:function(e){var n=e.target||e.srcElement;n.id&&(t._activedItemId=n.id,t._activedItem=n.getAttribute("dataIndex"),t._activedItemOrder=n.getAttribute("order"),t._menuIcon=n.className,this.options.target.children[0].className=n.className,t.options.onClick&&t.options.onClick instanceof Function&&t.options.onClick({dataIndex:t._activedItem,order:t._activedItemOrder}))}},body:this._getBody()}}}]})},updateStateInPanel:function(){if(this.getDropdown())for(var e=this.getDropdown().elements.container.children[0].children,t=0;t<e.length;t++)for(var n=e[t].children[1].children,o=0;o<n.length;o++)n[o].removeClassName("sortActived"),n[o].id===this._activedItemId&&n[o].addClassName("sortActived")},updateMenu:function(){this._hide(),this._i=this._i?this._i+1:1;var e=this;setTimeout(function(){0!==e._i&&(e._i=0,e.getDropdown()&&e.getDropdown().setBody(e._getBody()))},1e3)},reinitMenu:function(){this._hide(),this._view,this.emptyItemExtend(),this._setByDefaultSort(),this.getDropdown()&&this.getDropdown().setBody(this._getBody())},getDropdown:function(){if(this._view)return this._view.menu.getItem(0).content.component},_hide:function(){this.getDropdown()&&this.getDropdown().hide()},_getBody:function(){return this._body={html:[]},this._initDefaultItems(),this._addFromListExtend(),this._body},addItemExtend:function(e){var t=this._listItemExtend.map(function(e){return e.dataIndex}),n=[];(Array.isArray(e)?e:[e]).forEach(function(e){-1===t.indexOf(e.dataIndex)&&n.push(e)}),this._listItemExtend=this._listItemExtend.concat(n)},removeItemExtend:function(e){var t=this._listItemExtend.map(function(e){return e.dataIndex}),n=[];(Array.isArray(e)?e:[e]).forEach(function(e,o){-1!==t.indexOf(e.dataIndex)&&n.push(e.dataIndex)}),this._listItemExtend=this._listItemExtend.filter(function(e){return-1===n.indexOf(e.dataIndex)})},emptyItemExtend:function(){this._listItemExtend=[]},_setByDefaultSort:function(){this.options.defaultSort&&this.options.defaultSort.dataIndex&&this.options.defaultSort.order&&(this._activedItemId=this.options.defaultSort.dataIndex+"-"+this.options.defaultSort.order,this._activedItem=this.options.defaultSort.dataIndex,this._activedItemOrder=this.options.defaultSort.order,this._menuIcon=this._getIconByTypeAndOrder(this.options.defaultSort.type,this.options.defaultSort.order))},_setOrder:function(e,t,n){this._activedItemId=this._getIdByTypeIndexAndOrder(t,e,n),this._activedItem=e,this._activedItemOrder=this.options.defaultSort.order,this._menuIcon=this._getIconByTypeAndOrder(t,n),this._view&&this._view.elements.container&&this._view.elements.container.children[0]&&this._view.elements.container.children[0].children[0]&&this._view.elements.container.children[0].children[0].children[0]&&(this._view.elements.container.children[0].children[0].children[0].className=this._menuIcon),this._hide()},setOrderByExt:function(e){this._hide();if(e.order_field&&e.order_by){var t=this._defaultItem.filter(function(t){return-1!==t.dataIndex.indexOf("/")?t.dataIndex.split("/")[1]===e.order_field:t.dataIndex===e.order_field});(t=t?t[0]:"")&&this._setOrder(t.dataIndex,t.type,e.order_by)}},_addFromListExtend:function(){var e=this,t=this._defaultItem.map(function(e){return e.dataIndex});this._listItemExtend.forEach(function(n){-1===t.indexOf(n.dataIndex)&&e._addItem(n.dataIndex,n.type,n.nlsName)})},_addItem:function(e,t,n){var o={tag:"li",class:"item item-template sortPanelRow",html:[{tag:"span",class:"item-text",text:n},{tag:"div",class:"item-text item-icon-group",html:[]}]};switch(t){case"alpha":case"num":o.html[1].html=[{tag:"span",title:i.get("tooltip_SortAsc"),id:e+"-asc",order:"asc",dataIndex:e,class:this._getIconByTypeAndOrder(t,"asc")},{tag:"span",title:i.get("tooltip_SortDesc"),id:e+"-desc",order:"desc",dataIndex:e,class:this._getIconByTypeAndOrder(t,"desc")}];break;case"group":o.html[1].html=[{tag:"span",title:i.get("tooltip_SortGroup"),id:e+"-group",order:"asc",dataIndex:e,class:this._getIconByTypeAndOrder(t,"asc")}];break;default:o.html[1].html=[{tag:"span",title:i.get("tooltip_SortAsc"),id:e+"-asc",order:"asc",dataIndex:e,class:this._getIconByTypeAndOrder(t,"asc")},{tag:"span",title:i.get("tooltip_SortDesc"),id:e+"-desc",order:"desc",dataIndex:e,class:this._getIconByTypeAndOrder(t,"desc")}]}this._body&&this._body.html&&this._body.html.push(o)},_getIconByTypeAndOrder:function(e,t){switch(e){case"alpha":return"fonticon fonticon-sort-alpha-"+t;case"num":return"fonticon fonticon-sort-num-"+t;case"group":return"fonticon fonticon-tag-sorting";default:return t?"fonticon fonticon-sort-alpha-"+t:"fonticon fonticon-sort-alpha-asc"}},_getIdByTypeIndexAndOrder:function(e,t,n){switch(e){case"group":return t+"-group";default:return t+"-"+n}},_initDefaultItems:function(){var e=this;[].concat(this._defaultItem).forEach(function(t){e._addItem(t.dataIndex,t.type,t.nlsName)})},destroy:function(){e.is(this._view)&&e.is(this._view.destroy,"function")&&(this._view.destroy(),delete this._view),this._parent()}})}),define("DS/ImageManager/ImageManager",["UWA/Core","UWA/Controls/Abstract","DS/UIKIT/Alert","DS/UIKIT/Input/File","DS/UIKIT/Input/Text","DS/UIKIT/Mask","DS/UIKIT/Form","DS/WAFData/WAFData","DS/WidgetServices/securityContextServices/SecurityContextServices","DS/WidgetServices/WidgetServices","DS/ErrorWidget/ErrorWidget","DS/UIKIT/SuperModal","DS/Tree/TreeDocument","DS/Tree/TreeNodeModel","DS/CollectionView/ResponsiveThumbnailsCollectionView","DS/CollectionView/ResponsiveTilesCollectionView","DS/UIKIT/IconDropdown","DS/UIKIT/Tooltip","DS/Windows/Dialog","DS/Controls/Button","DS/Windows/ImmersiveFrame","DS/ImageManager/SortManager","DS/ImageManager/SortView","DS/UIKIT/Input/Button","DS/UIKIT/Iconbar","DS/UIKIT/Modal","i18n!DS/ImageManager/assets/nls/imageManager","css!DS/UIKIT/UIKIT","css!DS/ImageManager/ImageManager"],function(e,t,n,o,i,a,r,s,l,c,d,u,m,h,p,g,f,I,y,_,v,b,w,S,D,x,C){var A=function(e){var t={};if(e){var n=e.options;n&&(t.url=n.thumbnail,t.name=n.name)}return t};return t.extend({currentView:"",_defaultView:"thumbnail",init:function(e){if(!e.modelId)throw new Error(C.SubmitModelId);this._parent(e),this._modelId=e.modelId,e.tenantId&&(this._tenantId=e.tenantId),this._currentRequest={number:0,handler:null},this.currentView=this._defaultView},getModelId:function(){return this._modelId},onDeleteKeyPressed:function(e){this._prepareImageDeletion(e)},_buildGrid:function(t){var n=this;this.currentView=t||this.currentView;var o,i={height:"inherit",displayedOptionalCellProperties:["All"],selectionBehavior:{canMultiSelect:!0,canInteractiveMultiselectWithCheckboxClick:!0,enableShiftSelection:!0,toggle:!0}};"tile"===(t=this.currentView)?o=this.elements.tile=new g(i):"thumbnail"===t&&(o=this.elements.thumbnail=new p(i)),o.onDeleteKeyPressed(n.onDeleteKeyPressed.bind(n)),o.onContextualEvent={callback:function(e){var t=[];return e&&e.cellInfos&&e.cellInfos.cellModel&&(e.cellInfos.cellModel.getTreeDocument(),t.push({type:"PushItem",title:C["Display image"],fonticon:{family:"entypo",content:"fonticon-eye"},action:{callback:function(){n.displayImage(e.cellInfos.cellID)}}}),n.accessRight&&!e.cellInfos.nodeModel.options.primaryImage&&t.push({type:"PushItem",title:C["Set Primary"],fonticon:{family:"entypo",content:"fonticon-favorite-on"},action:{callback:function(){n.setAsPrimaryImage(e.cellInfos.nodeModel.options.name).then(function(){n._changePrimaryImageAttributes(e.cellInfos.nodeModel._id)})}}}),t.push({type:"PushItem",title:C["Download Image"],fonticon:{family:"entypo",content:"fonticon-download"},action:{callback:function(){n._downloadImage(e.cellInfos.nodeModel)}}}),t.push({type:"SeparatorItem"}),n.accessRight&&t.push({type:"PushItem",title:C["Delete image"],action:{callback:function(){n._prepareImageDeletion(e.cellInfos.nodeModel)}},fonticon:{family:"entypo",content:"fonticon-trash"}})),t}},this.treeDocument=this.treeDocument||new m({useAsyncPreExpand:!0}),o.model=this.treeDocument,this.elements.gridContainer=this.elements.gridContainer||e.createElement("div",{class:"imageManagerGrid"}),this.elements.gridContainer.inject(this.elements.container),o.getContent().inject(this.elements.gridContainer),o.onStatusbarIconPointerDown=function(e){var t=e.cellInfos;switch(e.clickedIconIndex){case 0:n.displayImage(t.cellID);break;case 1:n.setAsPrimaryImage(t.nodeModel.options.name).then(function(){n._changePrimaryImageAttributes(e.cellInfos.nodeModel._id)});break;case 2:n._downloadImage(t.nodeModel);break;case 3:n._prepareImageDeletion(t.nodeModel)}}},getFileExtension:function(e){return e.split(".").pop()},_uploadFiles:function(e){var t=this,n=[];e.target.files&&e.target.files.length>0&&Array.prototype.forEach.call(e.target.files,function(e){n.push(e.name)});var o=t._checkImagesExist(n),i=Array.from(e.target.files);Array.from(e.target.files).forEach(function(n){-1!==o.indexOf(n.name)&&(t.elements.notificationManager.addWarning(C.replace(C.get("fileAlreadyExists"),{objName:n.name})),i.splice(i.indexOf(i.filter(function(e){return e.name===n.name})[0]),1),1===e.target.files.length&&a.unmask(t.elements.container))}),a.mask(t.elements.container),t.fetchTypes().then(function(e){Array.from(i).forEach(function(n){-1===e.indexOf(t.getFileExtension(n.name))&&-1===e.indexOf(t.getFileExtension(n.name).toLowerCase())&&(i.splice(i.indexOf(n),1),t.elements.notificationManager.addError(C.replace(C.get("InvalidFileType"),{filename:n.name,types:e})))}),0===i.length&&a.unmask(t.elements.container),t.uploadImages(i).then(function(e){a.unmask(t.elements.container),!1===e.success?t.elements.notificationManager.addError(e.message):(t.elements.browseFile.value="",e.forEach(function(e){t._getImageFromServerAnswer(e,function(){t._addImageToCollection(this,0===t.treeDocument.getAllDescendants().length),t.elements.container.querySelector(".drop-component")&&t.elements.container.querySelector(".imageManagerGrid").removeChild(t.elements.container.querySelector(".drop-component"))})}))}).catch(function(e){a.unmask(t.elements.container),t._onFailure.apply(t,arguments)})}).catch(function(e){t._onFailure.apply(t,arguments)})},_buildToolbar:function(){var t,n,l,d=this,u=e.createElement("div",{class:"toolbar",styles:{top:0,height:"auto",padding:"10px",width:"100%",backgroundColor:"white","text-align":"right",display:"flex"}}).inject(this.elements.container),m=e.createElement("img",{id:"imagePreview",styles:{height:"38px",margin:"0 10px",border:"none"}}).inject(u);this.elements.browseFile=new o({input:!1,multiple:!0,events:{onChange:function(e){t.enable();var o=e.target.files;n.setValue(Array.from(o).map(function(e){return e.name}));var i=Array.from(o).map(function(e){return e.name});d.elements.inputTooltip.setBody(i.toString().replace(/,/g," \n")),n.getContent().setAttribute("readonly",!0),n.setValue(i);var a=new FileReader;a.readAsDataURL(o[0]),a.onload=function(){document.querySelector("#imagePreview").setAttribute("src",a.result)},t["data-target"]=e,t.warning=Array.from(o).filter(function(e){return e.size>=5e6}),a.onerror=function(e){d.elements.notificationManager.addError(e)}}}}).inject(u),l=e.createElement("div",{id:"inputContainer",styles:{width:"100%"}}).inject(u),n=new i({placeholder:C.PickOrCopy,attributes:{events:{change:function(e){e.target.value?(document.querySelector("#imagePreview").setAttribute("src",e.target.value),t.enable()):(document.querySelector("#imagePreview").removeAttribute("src"),t.disable())}}}}).inject(l),this.elements.inputTooltip=new I({position:"top",target:n.getContent(),body:n.getValue()}),t=new S({icon:"upload",className:"validate-input",attributes:{title:C.uploadImage},events:{onClick:function(){var e,t=this;if(c.isReplayedODT()&&this.elements.input.getAttribute("data-target"))var o=JSON.parse(this.elements.input.getAttribute("data-target")).e;this["data-target"]||o?this.warning.length>0||this.elements.input.getAttribute("data-target")&&JSON.parse(this.elements.input.getAttribute("data-target")).warning.length>0?((e=new x({className:"site-reset",closable:!0,header:"<h4>"+C.Validate+"</h4>",body:C.moreThan5MB+"<br/><code>"+(this.warning||JSON.parse(this.elements.input.getAttribute("data-target"))).map(function(e){return e.name+" - "+d._formatImageWeight(e.size)}).toString()+"</code>",footer:'<button type="button" class="btn btn-primary btn-submit-warn">'+C.Confirm+'</button> <button type="button" class="btn btn-default btn-cancel-warn">'+C.Cancel+"</button>"}).inject(d.elements.container).show()).getContent().getElements(".btn-submit-warn").forEach(function(i){i.addEvent("click",function(){e.destroy(),d._uploadFiles(t["data-target"]||o),delete t["data-target"],c.isReplayedODT()&&this.elements.input.removeAttribute("data-target"),n.setValue(null),m.removeAttribute("src")})}),e.getContent().getElements(".btn-cancel-warn").forEach(function(n){n.addEvent("click",function(){e.destroy(),delete t["data-target"]})})):(d._uploadFiles(this["data-target"]||o),delete this["data-target"],c.isReplayedODT()&&this.elements.input.removeAttribute("data-target"),n.setValue(null),n.elements.input.removeAttribute("readonly"),d.elements.inputTooltip.setBody(""),d.elements.browseFile.setValue(null),m.removeAttribute("src")):n.getValue().match(/^(http|https):*\/\//)&&(d.modal=d.modal||new x({className:"site-reset",closable:!0,header:"<h4>"+C.Validate+"</h4>",body:"",footer:""}).inject(d.elements.container),d.modalForm?d.modalForm.setValue("url",n.getValue()):d.modalForm=new r({fields:[{type:"text",label:"URL",disabled:!0,name:"url",value:n.getValue()},{type:"text",label:C.Name,placeholder:"Name",name:"name",className:"url-name",required:!0,events:{onChange:function(e){var t=d.treeDocument.getChildren().map(function(e){return e.options.name});t.indexOf(e.target.value+".jpeg")>-1||t.indexOf(e.target.value+".png")>-1?d.modalForm.buttons[0].disable():d.modalForm.buttons[0].enable()}}},{type:"select",label:C.ImageType,pattern:"/.*S.*/",required:!0,placeholder:C.PickType,className:"url-type",name:"type",options:[{label:"JPG/JPEG",value:"jpeg"},{label:"PNG",value:"png"}]}],buttons:[{type:"submit",value:C.Submit,className:"primary url-submit"}],events:{onSubmit:function(){var e=this;a.mask(d.elements.container);var t=[];e.getFields().forEach(function(e){t.push(e.value)}),d.modal.hide(),d._currentRequest.handler=s.authenticatedRequest(d.fullServerUrl+"/resources/v1/collabServices/images/op/"+d._modelId+"/images/uploadByUrl?tenant="+d._determineTenantId("onPremise"),{method:"POST",type:"json",data:JSON.stringify({url:t[0],name:t[1]+"."+t[2],type:t[2]}),timeout:6e5,headers:{SecurityContext:encodeURIComponent(d.securityContext.SecurityContext),"content-type":"application/json"},onComplete:function(t){!1===t.success?(e.reset(),d.elements.notificationManager.addError(t.message),a.unmask(d.elements.container)):(t.forEach(function(e){d._getImageFromServerAnswer(e,function(){d.elements.container.querySelector(".drop-component")&&d.elements.container.querySelector(".imageManagerGrid").removeChild(d.elements.container.querySelector(".drop-component")),d._addImageToCollection(this,0===d.treeDocument.getAllDescendants().length),a.unmask(d.elements.container)})}),n.setValue(null),m.removeAttribute("src"))},onFailure:function(e){d._onFailure.bind(d),d.elements.notificationManager.addError(e.message),a.unmask(d.elements.container)},ontimeout:function(){d._onTimeout.bind(d),a.unmask(d.elements.container)}})}}}).inject(document.querySelector(".modal-body")),d.modal.show())}}}).inject(u),new I({position:"right",target:t.getContent()}),c.isReplayedODT()||t.disable(),d.elements.sortView=new w({container:u,onClick:function(e){console.log(e);var t=e.dataIndex+"_"+e.order;switch(d.treeDocument.prepareUpdate(),t){case"size_asc":b.sizeAsc(d.treeDocument.getChildren());break;case"size_desc":b.sizeDesc(d.treeDocument.getChildren());break;case"title_asc":b.alphaAsc(d.treeDocument.getChildren());break;case"title_desc":b.alphaDesc(d.treeDocument.getChildren());break;case"date_asc":b.dateAtoB(d.treeDocument.getChildren());break;case"date_desc":b.dateBtoA(d.treeDocument.getChildren())}d.treeDocument.pushUpdate()}}),new D({renderTo:u,items:[{fonticon:"trash",text:C.Delete,handler:function(){var e=d.treeDocument.getSelectedNodes();d._prepareImageDeletion(e)}}]}),new D({renderTo:u,items:[{fonticon:"view-small-thb",className:"switchBtn",text:C.SwitchView,content:{type:"dropdownmenu",options:{items:[{fonticon:"view-small-thb",text:C.Thumbnail,name:"thumbnail",selectable:!0},{fonticon:"view-small-tile",text:C.Tile,name:"tile",selectable:!0}],events:{onClick:function(e,t){this.currentView!==t.name&&(d.switchView(t.name),0===d.treeDocument.getAllDescendants().length&&d._initDropComponent()),document.querySelector(".switchBtn span").className="fonticon fonticon-"+t.fonticon}}}}}]})},switchView:function(e){this.elements[this.currentView]&&this.elements[this.currentView].hide(),this.currentView=e,this.elements[e]?this.elements[e].show():this._buildGrid(e)},_compareLabels:function(e,t){for(var n=e&&"string"==typeof e?e.toLocaleLowerCase():"",o=t&&"string"==typeof t?t.toLocaleLowerCase():"",i=Math.min(n.length,o.length),a=0,r=0;r<i&&0===(a=n[r].localeCompare(o[r]));r++);return 0===a&&(a=n.length===o.length?0:n.length<o.length?-1:1),a},_getImageFromServerAnswer:function(e,t){var n=new Image;n.name=e.name,n.weight=e.size,n.primaryImage=e.isPrimaryImage,n.details=e,n.onload=t,n.src=e.medium,n.large=e.large,n.generic=e.generic},compute:function(){this.images=[];var e=this;a.mask(this.elements.container);var t=this._currentRequest.number+1;this._currentRequest.number=t,this._currentRequest.handler&&(this._currentRequest.handler.cancel(),this._currentRequest.handler=null),this.getModelImages("mxMedium").then(function(n){if(e._currentRequest.number===t)if(e.treeDocument.removeRoots(),0===Object.keys(n).length)a.unmask(e.elements.container),e.accessRight?e._initDropComponent():e._initNoContent();else{var o=n.length;n.forEach(function(n){e._getImageFromServerAnswer(n,function(){if(e._currentRequest.number===t&&(e._addImageToCollection(this),e.treeDocument.getChildren().length>=o)){a.unmask(e.elements.container);var n="undefined"!=localStorage.getItem("sort")&&localStorage.getItem("sort")?localStorage.getItem("sort"):"alphaAsc";e.elements.sortView.setOrderByExt({order_field:-1!==n.indexOf("date")?"date":-1!==n.indexOf("alpha")?"title":"size",order_by:-1!==n.indexOf("Asc")?"asc":"desc"}),e.treeDocument.prepareUpdate(),b[n](e.treeDocument.getChildren()),e.treeDocument.pushUpdate()}})})}})},_determine3DspaceUrl:function(e){var t=this;return new Promise(function(n,o){e&&e.fullServerUrl?n(e.fullServerUrl):t._currentRequest.handler=c.get3DSpaceUrlAsync({onComplete:function(e){n(e)},onFailure:o})})},_determineSecurityContext:function(e){var t=this;return new Promise(function(n,o){e&&e.securityContext?n(e.securityContext):t._getSecurityContext(e).then(n).catch(function(e){o(e)})})},_getSecurityContext:function(e){return new Promise(function(t,n){l.getInstance(e).getSecurityContext({alwaysUpdate:!0,onFailure:n,onSuccess:t})})},getModelImages:function(e){var t=this;return new Promise(function(n){t._currentRequest.handler=s.authenticatedRequest(t.fullServerUrl+"/resources/v1/collabServices/images/op/"+t._modelId+"/images/"+e+"?tenant="+t._determineTenantId("onPremise"),{method:"GET",type:"json",timeout:6e5,headers:{SecurityContext:encodeURIComponent(t.securityContext.SecurityContext)},onComplete:n,onFailure:t._onFailure.bind(t),ontimeout:t._onTimeout.bind(t)})})},_displaySuperModal:function(e){var t=new u({renderTo:this.elements.container});return new Promise(function(n,o){t.confirm(e.modalText,C.modalConfirmation,function(e){e?n(e):o(!1)})})},deleteImages:function(t){var n=this;return new Promise(function(o,i){s.authenticatedRequest(n.fullServerUrl+"/resources/v1/collabServices/images/op/image/"+n._modelId+"?tenant="+n._determineTenantId(),{method:"POST",timeout:6e5,headers:{SecurityContext:encodeURIComponent(n.securityContext.SecurityContext),Accept:"application/json","content-type":"application/json"},data:e.Json.encode({images:t}),onComplete:o,onFailure:i,ontimeout:i})})},_prepareImageDeletion:function(e){if(e&&(Array.isArray(e)||(e=[e]),0!==e.length)){var t=this,n=C.deleteMultiple;1===e.length&&(n=C.replace(C.get("objDelete"),{objName:e.length?e[0].options.name:e.options.name})),this._displaySuperModal({modalText:n}).then(function(){var n=[],o=!1;e.forEach(function(e){n.push(e.options.name),e.options.primaryImage&&(o=!0)}),a.mask(t.elements.container),t.deleteImages(n).then(function(n){t.treeDocument.prepareUpdate(),t.dispatchEvent("onDeletion",A(e)),e.forEach(function(e){t.treeDocument.removeRoot(e)}),n="string"==typeof n?JSON.parse(n):n,o&&t._changePrimaryImageAttributes(null,n.primaryImage),t.treeDocument.pushUpdate(),0===t.treeDocument.getAllDescendants().length&&t._initDropComponent(),a.unmask(t.elements.container)}).catch(function(e){t._onFailure.apply(t,arguments),a.unmask(t.elements.container)})})}},setAsPrimaryImage:function(e){var t=this;return new Promise(function(n){s.authenticatedRequest(t.fullServerUrl+"/resources/v1/collabServices/images/op/image/"+t._modelId+"/primaryImage/"+e+"?tenant="+t._determineTenantId(),{method:"PUT",timeout:6e5,headers:{SecurityContext:encodeURIComponent(t.securityContext.SecurityContext)},onComplete:n,onFailure:t._onFailure.bind(t),ontimeout:t._onTimeout.bind(t)})})},_closeFullSize:function(){this.elements.fullSizeOverlay&&(this.elements.fullSizeOverlay.destroy(),delete this.elements.fullSizeModal),this.elements.fullSizeImg&&(this.elements.fullSizeImg.destroy(),delete this.elements.fullSizeImg)},displayImage:function(e){this.treeDocument.getXSO().empty(),this.treeDocument.getNthRoot(e).select();var t=this;require(["DS/Tree/LightBoxView"],function(e){t._LightBoxPanel=new e({target:t.elements.container,treeDocument:t.treeDocument,height:"auto",bigPicturePath:function(e){return e.nodeModel.options.large}}),t._LightBoxPanel.getGridView().options.onContextualEvent={callback:function(e){var n=[];return e&&e.cellInfos&&e.cellInfos.cellModel&&(n.push({type:"PushItem",title:C["Download Image"],fonticon:{family:"entypo",content:"fonticon-download"},action:{callback:function(){t._downloadImage(e.cellInfos.nodeModel)}}}),t.accessRight&&!e.cellInfos.nodeModel.options.primaryImage&&(n.push({type:"SeparatorItem"}),n.push({type:"PushItem",title:C["Set Primary"],fonticon:{family:"entypo",content:"fonticon-favorite-on"},action:{callback:function(){t.setAsPrimaryImage(e.cellInfos.nodeModel.options.name).then(function(){t._changePrimaryImageAttributes(e.cellInfos.nodeModel._id)})}}}))),n}};var n=t._LightBoxPanel.getRightDockingElement();n&&(n.collapsibleFlag=!1,n.dockingZoneSize=420,n.minSize=250,n.visibleDockingZoneFlag=!1)})},_initDropComponent:function(){var t=this;if(!t.elements.dropContainer){t.elements.dropContainer=e.createElement("div",{class:"drop-component",events:{dragleave:function(){this.hide()},drop:function(e){e.preventDefault(),e.stopPropagation(),this.hide(),a.mask(t.elements.container);var n=[],o=Array.from(e.dataTransfer.files);t.fetchTypes().then(function(e){Array.from(o).forEach(function(n){-1===e.indexOf(t.getFileExtension(n.name))&&-1===e.indexOf(t.getFileExtension(n.name).toLowerCase())&&(o.splice(o.indexOf(n),1),t.elements.notificationManager.addError(C.replace(C.get("InvalidFileType"),{filename:n.name})))}),o&&o.length>0&&o.forEach(function(e){n.push(e.name)});var i=t._checkImagesExist(n),r=[];o.forEach(function(e){-1!==i.indexOf(e.name)?t.elements.notificationManager.addWarning(C.replace(C.get("fileAlreadyExists"),{objName:e.name})):r.push(e)}),(o=r).length<1?a.unmask(t.elements.container):t.uploadImages(o).then(function(e){!1===e.success?(t.elements.notificationManager.addError(e.message),a.unmask(t.elements.container)):(0===e.length&&a.unmask(t.elements.container),e.forEach(function(e){t._getImageFromServerAnswer(e,function(){t._addImageToCollection(this,0===t.treeDocument.getAllDescendants().length),a.unmask(t.elements.container)})}))}).catch(function(e){t.elements.notificationManager.addError(e),a.unmask(t.elements.container)})})}}});var n=e.createElement("div",{class:"text-icon-container"});e.createElement("span",{class:"fonticon fonticon-drag-drop",events:{click:function(){document.querySelector("input[type=file]").click()}}}).inject(n),e.createElement("span",{class:"drop-here-text",text:C.DropHere}).inject(n),n.inject(t.elements.dropContainer)}t.elements.dropContainer.inject(t.elements.container.querySelector(".imageManagerGrid")),t.elements.dropContainer.show()},_initNoContent:function(){this.elements.container.addEventListener("dragover",function(e){(e=e||event).preventDefault()},!1),this.elements.container.addEventListener("drop",function(e){(e=e||event).preventDefault()},!1);var t=e.createElement("div",{styles:{position:"absolute","font-size":"10vh",height:"100%",width:"100%",display:"flex"},class:"drop-component"}),n=e.createElement("div",{class:"text-icon-container"});e.createElement("span",{class:"fonticon fonticon-block"}).inject(n),e.createElement("span",{class:"drop-here-text",text:C.NoContent}).inject(n),n.inject(t),t.inject(this.elements.container.querySelector(".imageManagerGrid"))},_changePrimaryImageAttributes:function(e,t){var n=this,o=null;(e||t)&&this.treeDocument.getChildren().forEach(function(i){var a=null;null===e&&i.options.name===t||i._id===e?(a={primaryImage:!0,subLabel:C["Primary Image"],statusbarIcons:["eye",n.accessRight?"favorite-on":null,"download",n.accessRight?"trash":null],statusbarIconsTooltips:[C.FullSizeImage,"",C["Download Image"],n.accessRight?C["Delete image"]:null],contextualMenu:[C.FullSize,n.accessRight?C["Delete Image"]:null,C["Download Image"]]},o=i):i.options.primaryImage&&(a={primaryImage:!1,subLabel:"",statusbarIcons:["eye",n.accessRight?"favorite-off":null,"download",n.accessRight?"trash":null],statusbarIconsTooltips:[C.FullSizeImage,n.accessRight?C["Set Primary"]:"",C["Download Image"],n.accessRight?C["Delete image"]:""],contextualMenu:[C.FullSize,n.accessRight?C.Delete:null,C["Download Image"],n.accessRight?C["Set Primary"]:null]}),a&&i.updateOptions(a)}),setTimeout(function(){n.dispatchEvent("onPrimaryChange",o?A(o):null)})},_checkImagesExist:function(e){var t=[];return e&&e.length>0&&this.treeDocument.getChildren().forEach(function(n){e.indexOf(n.options.name)>=0&&t.push(n.options.name)}),t},fetchTypes:function(){var e=this;return new Promise(function(t,n){e.supportedTypes?t(e.supportedTypes):s.authenticatedRequest(e.fullServerUrl+"/resources/v1/collabServices/images/op/validTypes",{method:"GET",type:"json",timeout:6e5,headers:{SecurityContext:encodeURIComponent(e.securityContext.SecurityContext)},onComplete:function(n){e.supportedTypes=n,t(e.supportedTypes)},onFailure:n,ontimeout:n})})},uploadImages:function(e){var t=this,n=new FormData,o=0;return Array.prototype.forEach.call(e,function(e){0===e.size?t.elements.notificationManager.addError(C.replace(C.get("InvalidFileSize"),{size:e.size})):(n.append(e.name,e),o++)}),new Promise(function(e,i){0===o?e([]):s.authenticatedRequest(t.fullServerUrl+"/resources/v1/collabServices/images/op/"+t._modelId+"/images/upload?tenant="+t._determineTenantId(),{method:"POST",type:"json",timeout:6e5,headers:{SecurityContext:encodeURIComponent(t.securityContext.SecurityContext)},data:n,onComplete:e,onFailure:i,ontimeout:i})})},_formatImageWeight:function(e){if(e&&"number"!=typeof e)throw new TypeError(C.SetNumber);return e<=999?e.toFixed(2)+"B":e<=999999?(e/1e3).toFixed(2)+"KB":e?(e/1e6).toFixed(2)+"MB":""},_getIndexForNode:function(e){var t=this,n=null;return this.treeDocument.getChildren().every(function(o,i){return t._compareLabels(o.options.name,e.options.name)>0&&(n=i),null==n}),n=null==n?this.treeDocument.getChildren().length:n},_determineFavoriteOn:function(e){return this.accessRight?e.primaryImage?"favorite-on":"favorite-off":null},_addImageToCollection:function(e,t){var n=e.details&&e.details.modifiedAt?e.details.modifiedAt:new Date,o=c.formatDate(n,!0),i=new h({label:e.name,thumbnail:e.src,generic:e.generic,large:e.large,name:e.name,subLabel:e.primaryImage?C["Primary Image"]:void 0,statusbarIcons:["eye",this._determineFavoriteOn(e),"download",this.accessRight?"trash":null].filter(function(e){return null!==e}),statusbarIconsTooltips:["Display full-sized Image","favorite-off"===this._determineFavoriteOn(e)?C["Set Primary"]:null,"Download",this.accessRight?"Delete image":null],multipleTitleLineNumber:!1,icons:["picture"],primaryImage:e.primaryImage?"Primary Image":void 0,contextualMenu:["Display full-sized","Delete",e.primaryImage?C["Primary Image"]:C["Set Primary"],C["Download Image"]].filter(function(e){return null!==e}),propertiesList:[o,this._formatImageWeight(e.weight)]});this._addNodeToCollection(i),e.primaryImage&&t&&this._changePrimaryImageAttributes(null,i.options.name)},_addNodeToCollection:function(e){this._getIndexForNode(e),this.treeDocument.prepareUpdate(),this.treeDocument.addChild(e),this.treeDocument.pushUpdate()},close:function(){this.elements._dialogImg&&this.elements._dialogImg.close()},_close:function(){this._closeFullSize(),this.elements._dialogImg.content=null,this.elements._dialogImg.destroy(),delete this.elements._dialogImg},_onTimeout:function(){this.elements.notificationManager.addWarning(C.onTimeout,"timeout")},_onFailure:function(e,t,n,o){var i={};i=null!=t&&t.hasOwnProperty("error")?t.error:{message:C.get("An error occurred"),code:"ERROR"},(this.elements.notificationManager||new d(null,this.elements.container||widget.body,"imageManagerNotifs")).addError(i.message)},execute:function(t){var n=this,o=this._currentRequest.number+1;this._currentRequest.number=o,this._currentRequest.handler&&(this._currentRequest.handler.cancel(),this._currentRequest.handler=null),Promise.all([this._determine3DspaceUrl(t),this._determineSecurityContext(t)]).then(function(o){n.fullServerUrl=o[0],n.securityContext=o[1],n._hasAccessRight().then(function(o){n.accessRight="true"===o,n.elements.container||(n.elements.container=e.createElement("div",{class:"imgManagerContainer"}),n.elements.notificationManager=new d(null,n.elements.container,"imageManagerNotifs"),n.accessRight&&n._buildToolbar(),n._buildGrid()),n.elements.container.addEventListener("dragover",function(e){(e=e||event).preventDefault()},!1),n.elements.container.addEventListener("drop",function(e){(e=e||event).preventDefault()},!1),n.accessRight&&n.elements.container.addEventListener("dragover",function(e){(e=e||event).preventDefault(),n._initDropComponent()},!1),n.elements._dialogImg||(n.elements._dialogImg=new y({title:C.imgManagerTitle,content:n.elements.container,immersiveFrame:new v,maximizedFlag:!0,movableFlag:!1,autoCloseFlag:!1,buttons:{Close:new _({onClick:n.close.bind(n)})}}).inject(c.getWidgetBody()),n.elements._dialogImg.addEventListener("close",n._close.bind(n))),n.compute(t)})})},_downloadImage:function(e){var t=window.navigator&&void 0!==window.navigator.msSaveOrOpenBlob,n=this;a.mask(this.elements.container);var o=new XMLHttpRequest,i=e.options.label;i=i||"image.jpg",t||(o.responseType="blob");var r=c.isReplayedODT()?URL.createObjectURL(new Blob):e.options.generic;o.open("GET",r,!0),t&&(o.responseType="blob"),o.send(null),o.onload=function(){if(4===o.readyState)if(200===o.status){if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(o.response,i);else{var e=document.createElement("a");e.setAttribute("href",URL.createObjectURL(o.response)),e.setAttribute("download",i),document.body.appendChild(e),c.isReplayedODT()||e.click(),document.body.removeChild(e)}a.unmask(n.elements.container)}else n.elements.notificationManager.addWarning(C.get("cannotDownloadImage"),{objName:el.name})}},_determineTenantId:function(e){return this._tenantId?this._tenantId:c.getTenantID(e)},_hasAccessRight:function(){var e=this;return new Promise(function(t){e._currentRequest.handler=s.authenticatedRequest(e.fullServerUrl+"/resources/v1/collabServices/images/op/"+e._modelId+"/accessRight?tenant="+e._determineTenantId("onPremise"),{method:"GET",timeout:6e5,headers:{SecurityContext:encodeURIComponent(e.securityContext.SecurityContext)},onComplete:t,onFailure:e._onFailure.bind(e),ontimeout:e._onTimeout.bind(e)})})}})}),Array.from||(Array.from=function(){var e=Object.prototype.toString,t=function(t){return"function"==typeof t||"[object Function]"===e.call(t)},n=Math.pow(2,53)-1,o=function(e){var t=function(e){var t=Number(e);return isNaN(t)?0:0!==t&&isFinite(t)?(t>0?1:-1)*Math.floor(Math.abs(t)):t}(e);return Math.min(Math.max(t,0),n)};return function(e){var n=Object(e);if(null==e)throw new TypeError("Array.from requires an array-like object - not null or undefined");var i,a=arguments.length>1?arguments[1]:void 0;if(void 0!==a){if(!t(a))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(i=arguments[2])}for(var r,s=o(n.length),l=t(this)?Object(new this(s)):new Array(s),c=0;c<s;)r=n[c],l[c]=a?void 0===i?a(r,c):a.call(i,r,c):r,c+=1;return l.length=s,l}}());