define("UWA/Services/Upload",["UWA/Core","UWA/Utils","UWA/Class","UWA/Class/Options","UWA/Json"],function(t,e,i,o,s){"use strict";var n=i.extend(o,{intervalId:null,timeoutId:null,defaultOptions:{isUploadSuccess:function(t){return"uploaded"===t.status},isUploadFailed:function(t){return"failed"===t.status},formElement:"undefined",onUpload:"",onUploadSuccess:"",onUploadFailed:"",frameIdPrefix:"",timeout:1e4,polling:1e3,urls:{statusScript:"",uploadScript:""}},init:function(e){this.setOptions(e),this.options.formElement=t.extendElement(e.formElement);var i=this.buildIframe();this.buildFormRequirements(i),this.options.formElement.addEvent("submit",function(t){void 0!==e.urls.statusScript&&this.setTimer(t),this.options.onUpload()}.bind(this,i))},buildIframe:function(){var i=this.options,o=i.frameIdPrefix+e.random(1,1e5),s=t.createElement("div"),n=!1;return t.createElement("iframe",{src:"about:blank",id:o,name:o,styles:{position:"absolute",top:"-2000px",left:"0px"}}).inject(s).addEvent("load",function(){n&&i.onUploadSuccess(),n=!0}),document.body.appendChild(s),o},buildFormRequirements:function(e){var i=this.options.formElement;i.setAttributes({target:e,method:"post",enctype:"multipart/form-data",action:this.options.urls.uploadScript}),t.createElement("input",{type:"hidden",name:"frameId",value:e}).inject(i)},setTimer:function(t){this.intervalId=setInterval(this.checkStatus.bind(this,t),this.options.polling),this.timeoutId=setTimeout(function(){clearInterval(this.intervalId),this.options.onUploadFailed({status:"failed",details:{errors:{TimeoutError:"Upload timeout after "+this.options.timeout+"ms."}}})}.bind(this),this.options.timeout)},checkStatus:function(t){s.request(this.options.urls.statusScript+"?format=jsonp&frameId="+t,{onComplete:function(t){if(this.options.isUploadSuccess(t))this.options.onUploadSuccess(t);else{if(!this.options.isUploadFailed(t))return;this.options.onUploadFailed(t)}clearTimeout(this.timeoutId),clearInterval(this.intervalId)}.bind(this)})}});return t.namespace("Services/Upload",n,t)});