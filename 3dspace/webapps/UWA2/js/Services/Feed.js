define("UWA/Services/Feed",["UWA/Core","UWA/Class","UWA/Class/Options","UWA/Utils","UWA/Json","UWA/Data","UWA/Internal/StringMap"],function(e,t,i,n,s,r,a){"use strict";var l,o=t.extend(i,{id:null,timeOffset:null,lastFetchedDate:null,error:null,defaultOptions:{id:0,timeOffset:0,readOnly:!0,bufferItemMaxLen:30,itemLinkFilters:[],itemEnclosureFilters:[(l=/feedads|icon|button|addthis|feed|feedburner/,function(e){return!l.test(e)})]},init:function(e){this.data={dir:"ltr",flags:{read:0,unread:0},items:[]},this.setOptions(e)},setOptions:function(e){return this._parent(e),e=this.options,this.id=e.id,this.timeOffset=e.timeOffset,e.error?this.setError(e.error):e.data&&(this.setData(e.data),delete e.data),this},setError:function(e){return this.error=e,this},getError:function(){return this.error},isReadOnly:function(){return!0===this.options.readOnly},setLastFetchedDate:function(e){return this.lastFetchedDate=parseInt(e,10),this},getLastFetchedDate:function(){return parseInt(this.lastFetchedDate,10)},setData:function(t,i){i=i||{};var s,r=t.server_time||Math.round(Date.now()/1e3),a=t.items,l=this.getItemsLength();return delete t.items,i.last_update?(this.addItems(a,"before"),this.setLastFetchedDate(r)):i.published_before?this.addItems(a,"after"):(e.extend(this.data,t,!0),this.addItems(a),this.setLastFetchedDate(r),t.url&&(this.ownerURL=t.url,this.feedSiteUrlDomain=n.parseUrl(t.url).domain)),s={data:e.clone(this.data),addedItem:l-this.data.length},i.callback&&(i.onComplete=i.callback,delete i.callback),e.is(i.onComplete,"function")&&i.onComplete(s),s},addItems:function(e,t){if(Array.isArray(e)&&e.length>0){var i,n,s,r=this.getItems();if("before"===t){for(i=e.length-1;i>=0;i--)s=this.preProcessItem(e[i]),r.unshift(s);this.setItemsIndexes()}else if("after"===t){for(i=0,n=e.length;i<n;i++)s=this.preProcessItem(e[i]),r.push(s);this.setItemsIndexes()}else{for(i=0,n=e.length;i<n;i++)s=this.preProcessItem(e[i]),r.push(s);this.sortItemsByDate()}}},sortItemsByDate:function(e){this.getItems().sort(function(t,i){var n=new Date(t.date).getTime(),s=new Date(i.date).getTime();return"asc"===e?n-s:s-n}),this.setItemsIndexes()},setItemsIndexes:function(){var e,t=this.getItemsLength();for(e=0;e<t;e++)this.getItem(e).index=e},preProcessItem:function(e){return e.__preProcessed||(e.content=e.content||"",e.title=e.title||"",e.flags=e.flags||{},this.preProcessItemEnclosures(e),this.applyItemLinkFilters(e),this.applyItemEnclosureFilters(e),e.__preProcessed=!0),e},preProcessItemEnclosures:function(){function e(e,t,i){var n,s,r,a,l=[],o=e.getElementsByTagName(t);for(n=0,s=o.length;n<s;n++)a=o[n],(r=o[n].getAttribute(i))&&("img"===t&&(!a.height||a.height>1)&&(!a.width||a.width>1)||"a"===t&&a.href&&a.href.indexOf("#")>1)&&l.push(r);return l}return function(t){var i,s,r,a,l,o,d,u,h=/\.(jpeg|gif|jpg|bmp|png)$/i,c=/\.(m4a|ogg|mp3|acc)$/i,m=/\.(flv|mp4|h264|avi|mpeg|mpg)$/i,f=this.options,g=this.getUrl(),p=t.enclosures,I=f.itemEnclosureFilters,v=[],y={image:[],video:[],audio:[]};for(Array.isArray(p)&&p.forEach(function(e){var t=e.url,i=e.type;t&&(i&&/^image\/(jpeg|gif|jpg|bmp|png)$/.test(i)||h.test(t)?y.image.push(t):i&&/^audio\/mpeg$/.test(i)||c.test(t)?y.audio.push(t):(i&&/^video/.test(i)||m.test(t))&&y.video.push(t))}),l=n.loadHtml(t.content),i=0,s=(v=(v=v.concat(e(l,"img","src"))).concat(e(l,"a","href"))).length;i<s;i++)o=v[i],!t.image&&h.test(o)?y.image.push(o):!t.audio&&c.test(o)?y.audio.push(o):!t.video&&m.test(o)&&y.video.push(o);for(d in t.image&&t.video||(v=t.content.match(/http:\/\/www.youtube.com\/v\/([\w|\-]+)/))&&v.length>0&&(t.video=v[0],t.image="https://i2.ytimg.com/vi/"+v[1]+"/hqdefault.jpg"),y)for(i=0,s=(v=y[d]).length;i<s;i++){if(o=v[i],u=!0,Array.isArray(I))for(r=0,a=I.length;r<a&&u;r++)u=(0,I[r])(o,t);u&&(t[d]=n.buildUrl(g,o))}return t.thumbnail=t.image,t.watchable=Boolean(t.video),t}}(),addItemLinkFilter:function(t){var i=this.options;e.is(i.itemLinkFilters,"array")||(i.itemLinkFilters=[]),e.is(t,"function")&&i.itemLinkFilters.push(t)},applyItemLinkFilters:function(t){var i,n,s,r=this.options.itemLinkFilters;if(Array.isArray(r)&&!t.__linksFiltered){for(n=0,s=r.length;n<s;n++)i=r[n],e.is(i,"function")&&t.link&&(t.link=i(t.link,t,this));t.__linksFiltered=!0}},addItemEnclosureFilter:function(t){var i=this.options;e.is(i.itemEnclosureFilters,"array")||(i.itemEnclosureFilters=[]),e.is(t,"function")&&i.itemEnclosureFilters.push(t)},applyItemEnclosureFilters:function(t){var i,n,s,r,a,l,o=this.options.itemEnclosureFilters,d=["image","audio","video"];if(Array.isArray(o)&&!t.__enclosuresFiltered){for(i=0,n=o.length;i<n;i++)if(l=o[i],e.is(l,"function"))for(s=0,r=d.length;s<r;s++)t[a=d[s]]&&!l(t[a],t)&&delete t[a];t.__enclosuresFiltered=!0}},getTitle:function(){return this.data.title},getDir:function(){return this.data.dir},getUrl:function(){return this.data.url},getLink:function(){return this.data.link},getType:function(){return this.data.type},getItems:function(){return this.data.items},getItem:function(e){return this.getItems()[e]},getItemByGuid:function(e){return this.getItemByProperty("guid",e)},getItemByProperty:function(e,t){var i,n,s=this.getItemsLength();for(n=0;i<s&&(i=this.getItem(n))[e]!==t;n++);return i},getLastItemId:function(){var e=this.getItem(this.getItemsLength()-1);return e&&e.id},getItemsLength:function(){return this.data.items.length},getUnread:function(e){e=e||{};var t,i,n,s,r=0,a=0,l=this.data,o=this.infos,d=this.getItemsLength();if(o&&d>0&&(s=(n=l.flags)&&n.read?n.read:0,a=o.item_count-s,e.onlyNFirst)){for(e.onlyNFirst=e.onlyNFirst<=d?e.onlyNFirst:d,t=0,i=e.onlyNFirst;t<i;t++)this.isItemRead(t)||r++;a=r}return a>=0?a:0},isItemRead:function(e){var t=this.getItem(e);return Boolean(t&&t.flags&&t.flags.read)},setItemRead:function(e,t){this.isItemRead(e)||(this.data.flags.read++,this.setItemsFlag({indexes:[e],flag:"read",value:Math.ceil(Date.now()/1e3),save:t}))},setItemUnread:function(e,t){this.isItemRead(e)&&(this.data.flags.read--,this.setItemsFlag({indexes:[e],flag:"read",value:!1,save:t}))},setAllItemsRead:function(e){var t,i=this.getItemsLength();for(t=0;t<i;t++)this.setItemRead(t,!1),(void 0).push(t);this.setItemsFlag({indexes:void 0,flag:"read",value:Math.ceil(Date.now()/1e3),save:e})},setAllItemsUnread:function(e){var t,i=this.getItemsLength(),n=[];for(t=0;t<i;t++)this.setItemRead(t,!1),n.push(t);this.setItemsFlag({indexes:n,flag:"read",value:!1,save:e})},setItemsFlag:function(e){var t,i,n,s=[],r=!this.isReadOnly()&&(e.save||!0);for(e.index&&(e.indexes=[e.index]),t=0,i=e.indexes.length;t<i;t++)n=this.getItem(t),s.push(n.id),e.value&&!1!==e.value?n.flags[e.flag]=e.value:delete n.flags[e.flag];r&&o.Adapter.Netvibes.feedApiRequest({readState:e.value&&!1!==e.value?"add":"remove",feedIds:this.id,feedItemIds:s})}});return o.Utils={adapterName:r.allowCrossOriginRequest?"Ajax":"Proxy",load:function(e,t){return t=t||this.adapterName,(e=e||{}).callback&&(e.onComplete=e.callback,delete e.callback),o.Adapter.Cache.load(e,t)},getIdFromUrl:function(e){return Math.abs(parseInt(n.getCRC32(e),10)).toString(36)},cleanFeedUrl:function(t){return t.contains("flvProxy.php")?t=n.getQueryString(t,"url"):t.contains("commeaucinemaProxy.php")?t="http://www.commeaucinema.com/rssfile.php?feed=netvibes_"+n.getQueryString(t,"id"):/^feed:\/\/(.*)/.test(t)&&(t=t.replace("feed:",""),/^http(s)?:\/\/(.*)/.test(t)||(t="http://"+t)),/^http(s)?:\/\/(.*)/.test(t)||(t=e.hosts.netvibes+t),t}},o.Adapter={Cache:{load:function(t,i){var n,s,r,a,l={},d=t.urls||[],u=[];for(n=0,s=d.length;n<s;n++)r=o.Utils.cleanFeedUrl(d[n]),(a=this.getFromCache(r))?l[r]=new o(a):u.push(r);u.length>0?(t.urls=u,o.Adapter[i].load(t,l)):e.is(t.onComplete,"function")&&t.onComplete(l)},getCache:function(){return this.data||(this.data=new a),this.data},storeInCache:function(e,t){return this.getCache().set(e,t)},getFromCache:function(e){return this.getCache().get(e)}},Proxy:{load:function(t,i){var n,s,a=0,l=t.urls||[];function d(n,s){var r={url:n,readOnly:!0,data:{title:s.title,dir:s.dir,url:s.url,link:s.link,type:s.type,items:s.items}};i[n]=new o(r),o.Adapter.Cache.storeInCache(n,r),a++,l.length===a&&e.is(t.onComplete,"function")&&t.onComplete(i)}function u(n,s){i[n]=new o({url:n,readOnly:!0,error:s}),a++,l.length===a&&e.is(t.onComplete,"function")&&t.onComplete(i)}for(i=i||{},n=0,s=l.length;n<s;n++){var h=o.Utils.cleanFeedUrl(l[n]);r.request(h,{proxy:"feed",type:"json",onComplete:d.bind(null,h),onFailure:u.bind(null,h)})}}},Ajax:{load:function(){function t(e){var t,i,n,s;if(Array.isArray(e.link))for(n=e.link[0].href||e.link[0],i=0,t=e.link.length;i<t;i++)(s=e.link[i]).rel&&-1!==["self","alternate"].indexOf(s.rel)&&(n=s.href);else n=e.link.href||e.link;return n}function i(t){var i=t.toString?t.toString():t;return e.is(i)&&i.length>0?i:""}function a(e){return new Date(Date.parse(e)).toGMTString()}return function(l,d){d=d||{};var u,h,c=0,m=l.urls||[];function f(r,u){var h,f=function(r,l){var o,d,u,h,c={dir:"ltr",url:l,items:[]};if((r=s.xmlToJson(r)).feed)for(e.extend(c,{title:i(r.feed.title),link:t(r.feed)}),u=0,h=(o=n.splat(r.feed.entry)).length;u<h;u++)d=o[u],c.items[u]={id:u,title:i(d.title),link:t(d),content:i(d.content),date:a(d.updated)},d["media:thumbnail"]&&d["media:thumbnail"].url&&(c.items[u].image=d["media:thumbnail"].url);else if(r["rdf:RDF"])for(r.rdf=r["rdf:RDF"],e.extend(c,{title:i(r.rdf.channel.title),link:t(r.rdf.channel)}),u=0,h=(o=n.splat(r.rss.channel.item)).length;u<h;u++)d=o[u],c.items[u]={id:u,title:i(d.title),link:t(d),content:i(d.description),date:a(d["dc:date"])},d["media:content"]&&d["media:content"].url&&(c.items[u].image=d["media:content"].url);else{if(!r.rss)throw new Error("Unable to Parse Feed using Ajax Adapter.");for(e.extend(c,{title:i(r.rss.channel.title),link:t(r.rss.channel)}),u=0,h=(o=n.splat(r.rss.channel.item)).length;u<h;u++)d=o[u],c.items[u]={id:u,title:i(d.title),link:t(d),content:i(d["content:encoded"]||d.description),date:a(d.pubDate)},"string"!=typeof c.items[u].content&&(c.items[u].content=""),d.enclosure&&(c.items[u].enclosures=[d.enclosure]),d["media:thumbnail"]&&d["media:thumbnail"].url&&(c.items[u].image=i(d["media:thumbnail"].url))}return c}(u,r);h=new o({url:r,readOnly:!0,data:f}),d[r]=new o(h),o.Adapter.Cache.storeInCache(r,h),c++,m.length===c&&e.is(l.onComplete,"function")&&l.onComplete(d)}function g(t,i){d[t]=new o({url:t,readOnly:!0,error:i}),c++,m.length===c&&e.is(l.onComplete,"function")&&l.onComplete(d)}for(u=0,h=m.length;u<h;u++){var p=o.Utils.cleanFeedUrl(m[u]);r.request(p,{method:"GET",onComplete:f.bind(null,p),onFailure:g.bind(null,p)})}}}()},Netvibes:{load:function(){}}},e.namespace("Services/Feed",o,e)});