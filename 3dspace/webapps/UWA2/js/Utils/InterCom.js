define("UWA/Utils/InterCom",["UWA/Core","UWA/String","UWA/Utils","UWA/Class","UWA/Dispatcher","UWA/Class/Events","UWA/Class/Options","UWA/Class/Timed","UWA/Class/Debug","UWA/Json"],function(e,t,s,n,r,i,o,a,c,u){"use strict";function d(e,t){var s,n,r,i;for(s=0,n=e.length;s<n;s++)for(r=0,i=t.length;r<i;r++)if(t[r]===e[s])return!0;return!1}function v(e){return Boolean(e.UWA&&e.UWA.Utils&&e.UWA.Utils.InterCom)&&!e.UWA.Utils.InterCom._listener&&(e.UWA.Utils.InterCom._listener=new i),e.UWA.Utils.InterCom._listener}var h,l=e.getGlobal();return(h={getAdapter:function(e){var t,n,r,i=h.Adapters,o=e?s.splat(e):Object.keys(i);for(t=0,n=o.length;t<n&&!r;t++){if(e=o[t],!i.hasOwnProperty(e))throw new Error('Unable to get InterCom Adapter with name "'+e+'"');if(i[e].isAvailable(r)){r=i[e];break}}if(!r)throw new Error("Unable to get InterCom Adapter");return r}}).Adapters={PostMessage:function(){var e,n="uwa-intercom";function i(t){var s;try{s="string"==typeof t.data&&"{"===t.data[0]&&JSON.parse(t.data)}catch(e){}s&&s.type===n&&e.dispatch([s.payload,{origin:t.origin,source:t.source}])}return{isAvailable:function(){return l.postMessage&&l.location&&l.location.protocol&&t.contains(l.location.protocol,"http")},removeListener:function(t){e&&(e.remove(t),0===e.getNumListeners()&&(e.dispose(),e=void 0,l.addEventListener?l.removeEventListener("message",i,!1):l.attachEvent&&l.detachEvent("onmessage",i)))},addListener:function(t){e||(e=e||new r,l.addEventListener?l.addEventListener("message",i,!1):l.attachEvent&&l.attachEvent("onmessage",i)),e.add(t)},dispatchEvent:function(e,t,r){var i;if(t||(t=(i=l.parent).postMessage?i:i.document.postMessage?i.document:void 0),r=r&&"*"!==r?s.buildUrl(l.location,r):"*",t&&t.postMessage){var o={type:n,payload:e};t.postMessage(JSON.stringify(o),r)}}}}(),FrameCallback:function(){var e,t=0,n=[],r=!0,i=l.document;function o(){r&&i.body&&n.length>0&&i.body.appendChild(n.shift()),n.length>0&&setTimeout(o,10)}return{isAvailable:function(){return e=v(l),Boolean(e)},removeListener:function(t){e.removeEvent("message",t)},addListener:function(t){e.addEvent("message",t)},dispatchEvent:function(e,a,c){!function(e){try{return e===l||e.location.host===l.location.host&&e.location.protocol===l.location.protocol}catch(e){}}(a)?function(e,a,c){var d,v,h=l.location.toString(),g=s.parseUrl(c),p=g.protocol+"://"+g.domain+"/intercom.html",f={info:e,origin:h};d="#"+Date.now()+t+++"&"+u.encode(f),(v=i.createElement("iframe")).setAttribute("src",p+d),v.style.position="absolute",v.style.top="-2000px",v.style.left="0px",v.onload=function(){r=!0,v.parentNode.removeChild(v)},n.push(v),setTimeout(o,10)}(e,0,c):function(e,t){var s=v(t);setTimeout(function(){s.dispatchEvent("message",[e,{origin:l.location.toString(),source:l}])})}(e,a)}}}()},h.Server=n.extend(o,c,{id:null,uuid:null,sockets:null,listeners:null,defaultOptions:{adapter:null,autoconnect:!0},init:function(e,t){this.setServerId(e),this.sockets={},this.listeners=new i,this.setOptions(t),this.options.autoconnect&&this.connect()},setServerId:function(e){var t=h.Server.Instances=h.Server.Instances||{};return this.uuid=this.uuid||s.getUUID(),t[e=e||this.uuid]&&(t[e].disconnect(),delete t[e]),this.id=e,t[e]=this,this},connect:function(){return this.handleEvent=this.handleEvent.bind(this),this.adapter=h.getAdapter(this.options.adapter),this.adapter.addListener(this.handleEvent),this},disconnect:function(){var e=this;return e.adapter&&(Object.keys(e.sockets).forEach(function(t){e.unsubscribeSocket(t)}),e.adapter.removeListener(e.handleEvent)),e},handleEvent:function(e,t){var s,n,r,i=this.id,o=this.sockets,a=Object.keys(o);n=(s=t&&t.source&&t.origin&&e.event&&e.target&&e.origin&&e.target.servers&&Array.isArray(e.target.servers)&&e.target.sockets&&Array.isArray(e.target.sockets))&&o[e.origin.socket]&&o[e.origin.socket].uuid===e.uuid,r=s&&0===e.target.sockets.length&&-1!==e.target.servers.indexOf(i),s?r?(this.log('SERVER: server "'+i+'" accept message for event "'+e.event+'"'),"subscribe"===e.event?n||this.subscribeSocket(e.origin.socket,t.source,t.origin,e.uuid):n&&("unSubscribe"===e.event?this.unsubscribeSocket(e.origin.socket):this.dispatchEvent(e.event,e.data,e.origin.socket,e.target.sockets))):n&&d(e.target.sockets,a)&&d([e.origin.socket],a)?(this.log('SERVER PREDISPATCH: server "'+i+'" dispatch event "'+e.event+'" from "'+e.origin.socket+'"'),this.dispatchEvent(e.event,e.data,e.origin.socket,e.target.sockets)):this.log('SERVER: server "'+i+'" refuse message for event "'+e.event+'"'):this.log('SERVER: server "'+i+'" refuse invalid message for event "'+e.event+'"')},subscribeSocket:function(e,t,s,n){var r=this.id;return this.log('SERVER: server "'+r+'" register new socket "'+e+'"'),this.sockets[e]={source:t,origin:s,uuid:n},this.dispatchEvent("subscribe",{},void 0,e),this},unsubscribeSocket:function(e){var t=this.id;return this.sockets[e]&&(this.log('SERVER: server "'+t+'" unregister socket "'+e+'"'),this.dispatchEvent("unSubscribe",{},void 0,e),delete this.sockets[e]),this},addListener:function(e,t){return this.listeners.addEvent(e,t),this},removeListener:function(e,t){return this.listeners.removeEvent(e,t),this},dispatchEvent:function(e,t,n,r){var i=this,o=i.id,a=i.sockets,c=i.adapter,u={event:e,data:t,target:{sockets:r},origin:{socket:n,server:o},uuid:i.uuid};return r&&r.length?r=s.splat(r):-1!==(r=Object.keys(i.sockets)).indexOf(n)&&r.splice(r.indexOf(n),1),c||(i.connect(),c=i.adapter),0===r.length?i.log('SERVER: server "'+o+'" has no target socket for dispatchEvent "'+e+'"'):r.forEach(function(s){var r=a[s],u={event:e,data:t,target:{sockets:[s]},origin:{socket:n,server:o},uuid:i.uuid};i.log('SERVER: server "'+o+'" dispatchEvent "'+u.event+'" to "'+s+'"');try{c.dispatchEvent(u,r.source,r.origin)}catch(e){l.console&&l.console.error('InterCom server "'+o+'": error while dispatching to socket '+s+": "+e+"\nDeleting socket"),delete a[s]}}),i.listeners.dispatchEvent(e,[t,u]),i}}),h.Socket=n.extend(o,c,{id:null,uuid:null,servers:null,listeners:null,defaultOptions:{adapter:null,autoconnect:!1},init:function(e,t){this.setSocketId(e),this.servers={},this.listeners=new i,this.setOptions(t)},setSocketId:function(e){var t=h.Socket.Instances=h.Socket.Instances||{};return this.uuid=this.uuid||s.getUUID(),t[e=e||this.uuid]&&(t[e].disconnect(),delete t[e]),this.id=e,t[e]=this,this},connect:function(){return this.handleEvent=this.handleEvent.bind(this),this.adapter=h.getAdapter(this.options.adapter),this.adapter.addListener(this.handleEvent),this},disconnect:function(){var e=this;return e.adapter&&(Object.keys(e.servers).forEach(function(t){e.unsubscribeServer(t)}),e.adapter.removeListener(e.handleEvent)),e},handleEvent:function(e,t){var s,n,r,i,o=this,a=o.id,c=o.servers;n=(r=t&&t.source&&t.origin&&e&&e.event&&e.target&&e.origin&&e.origin.server&&c[e.origin.server]&&e.target.sockets&&Array.isArray(e.target.sockets))&&c[e.origin.server]&&c[e.origin.server].uuid===e.uuid,i=r&&0!==e.target.sockets.length&&-1!==e.target.sockets.indexOf(a),r?i?(s=o.servers[e.origin.server],o.log('SOCKET: socket "'+a+'" accept message for event "'+e.event+'"'),"subscribe"===e.event?(n||(s.waiting=!1,s.uuid=e.uuid,s.queue.length&&(s.queue.forEach(function(e){o.adapter.dispatchEvent(e,s.source,s.origin)}),o.log('SOCKET: socket dispatch "'+s.queue.length+'" events in the queue for serverId "'+e.origin.server+'".'),s.queue=[])),o.listeners.dispatchEvent(e.event,[e.data,e])):n?"unSubscribe"===e.event?delete o.servers[e.origin.server]:o.listeners.dispatchEvent(e.event,[e.data,e]):o.log('SOCKET: socket "'+a+'" refuse invalid uuid for event "'+e.event+'"')):o.log('SOCKET: socket "'+a+'" refuse message for event "'+e.event+'"'):o.log('SOCKET: socket "'+a+'" refuse invalid message for event "'+e.event+'"')},subscribeServer:function(e,t,s){return t=t||l.parent,s=s||l.location.toString(),this.servers[e]={waiting:!0,queue:[],source:t,origin:s},this.dispatchEvent("subscribe",void 0,void 0,e),this},unsubscribeServer:function(e){var t=this.id;return this.servers[e]&&(this.log('SOCKET: socket "'+t+'" unregister server "'+e+'"'),this.dispatchEvent("unSubscribe",{},void 0,e),delete this.servers[e]),this},addListener:function(e,t){return this.listeners.addEvent(e,t),this},removeListener:function(e,t){return this.listeners.removeEvent(e,t),this},dispatchEvent:function(e,t,n,r){var i=this,o=i.id,a=i.servers,c=i.adapter;return r=r&&r.length?s.splat(r):Object.keys(i.servers),n=s.splat(n),c||(i.connect(),c=i.adapter),t=u.prune(t),r.forEach(function(s){var r=a[s],u={event:e,data:t,target:{servers:[s],sockets:n},origin:{socket:o},uuid:i.uuid};0===r.queue.length&&!r.waiting||"subscribe"===e||"unSubscribe"===e?(i.log('SOCKET: socket "'+o+'" dispatch event "'+e+'"'),c.dispatchEvent(u,r.source,r.origin)):(i.log('SOCKET: socket "'+o+'" queue event "'+e+'" for serverId "'+s+'"'),r.queue.push(u))}),i}}),e.namespace("Utils/InterCom",h,e)});