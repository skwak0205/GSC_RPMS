define("UWA/Class/Collection",["UWA/Core","UWA/Array","UWA/Utils","UWA/Class","UWA/Class/Debug","UWA/Class/Events","UWA/Class/Listener","UWA/Class/Model"],function(t,e,i,n,r,s,o,h){"use strict";var l,u,c,d;return l={add:!0,remove:!0,merge:!0},u={add:!0,remove:!1},c=function(e){return t.is(e,"function")?e:function(t){return t.get(e)}},d=n.extend(s,o,{init:function(e,i){t.is(i)||(i={}),i.url&&(this.url=i.url),i.model&&(this.model=i.model),void 0!==i.comparator&&(this.comparator=i.comparator),this._reset(),this._modelListener=function(t,e,i,n){return this._onModelEvent(t,e,i,n)},this.setup(e,i),e&&this.reset(e,t.extend({silent:!0},i))},clone:function(){return new this.constructor(this._models)},setup:function(){},sync:function(){return h.prototype.sync.apply(this,arguments)},parse:function(t){return t},model:h,add:function(e,i){return this.set(e,t.extend(t.extend({merge:!1},i),u))},push:function(e,i){return this.add(e,t.merge({at:this.length},i))},unshift:function(e,i){return this.add(e,t.merge({at:0},i))},remove:function(e,i){var n,r,s,o,h;for(t.is(i)||(i={}),s=0,o=(e=(h=!Array.isArray(e))?[e]:t.clone(e,!1)).length;s<o;s++)(r=e[s]=this.get(e[s]))&&(delete this._byId[r.id],delete this._byId[r.cid],n=this.indexOf(r),this._models.splice(n,1),this.length--,i.silent||(i.index=n,r.dispatchEvent("onRemove",[r,this,i])),this._removeReference(r));return h?e[0]:e},pop:function(t){var e;return e=this.at(this.length-1),this.remove(e,t),e},shift:function(t){var e;return e=this.at(0),this.remove(e,t),e},sort:function(e){if(t.is(e)||(e={}),!this.comparator)throw new Error("Cannot sort a collection without a comparator");return t.is(this.comparator,"string")||1===this.comparator.length?this._models=this.sortBy(this.comparator,this):this._models.sort(this.comparator.bind(this)),e.silent||this.dispatchEvent("onSort",[this,e]),this},set:function(e,i){var n,r,s,o,u,c,d,a,f,m,p,v,_,g,y,E,A,b,x,C,I,w;for((i=t.merge(t.merge({},i),l)).parse&&(e=this.parse(e,i)),e=(w=!Array.isArray(e))?e?[e]:[]:t.clone(e,!1),n=i.at,g=this.model,r=this.comparator&&!t.is(n)&&!1!==i.sort,s="string"===t.typeOf(this.comparator)?this.comparator:null,o=[],u=[],c={},d=i.add,a=i.merge,f=i.remove,m=!(r||!d||!f)&&[],p=0,v=e.length;p<v;p++){_=(E=e[p])instanceof h?y=E:E[g.prototype.idAttribute],(A=this.get(_))?(f&&(c[A.cid]=!0),a&&(E=E===y?y._attributes:E,i.parse&&(E=A.parse(E,i)),A.set(E,i),r&&!b&&A.hasChanged(s)&&(b=!0)),e[p]=A):d&&(y=e[p]=this._prepareModel(E,i))&&(e[p]=y,o.push(y),y.addEvent("onAnyEvent",this._modelListener,this),this._byId[y.cid]=y,t.is(y.id)&&(this._byId[y.id]=y));var O=A||y;if(m&&O){var U=m.indexOf(O);U>=0&&m.splice(U,1),m.push(A||y)}}if(f){for(p=0,v=this.length;p<v;++p)c[(y=this._models[p]).cid]||u.push(y);u.length&&this.remove(u,i)}if(o.length||m&&m.length)if(r&&(b=!0),this.length+=o.length,t.is(n))for(C=0,I=o.length;C<I;C++)this._models.splice(n+C,0,o[C]);else for(m&&(this._models.length=0),C=0,I=(x=m||o).length;C<I;C++)this._models.push(x[C]);if(b&&this.sort({silent:!0}),!i.silent){for(p=0,v=o.length;p<v;p++)(y=o[p]).dispatchEvent("onAdd",[y,this,i]);(b||m&&m.length)&&this.dispatchEvent("onSort",[this,i])}return w?e[0]:e},reset:function(e,i){var n,r,s,o;for(i=i?t.clone(i,!1):{},r=0,s=(o=this._models).length;r<s;r++)n=o[r],this._removeReference(n);return i.previousModels=this._models,this._reset(),e=this.add(e,t.extend({silent:!0},i)),i.silent||this.dispatchEvent("onReset",[this,i]),e},get:function(e){if(t.is(e))return this._byId[e.id]||this._byId[e.cid]||this._byId[e]},at:function(t){return this._models[t]},first:function(e,i){return t.is(e)&&!i?this._models.slice(0,e):this._models[0]},last:function(e,i){return t.is(e)&&!i?this._models.slice(Math.max(this._models.length-e,0)):this._models[this._models.length-1]},toArray:function(){return this.slice()},slice:function(t,e){return this._models.slice(t,e)},rest:function(e,i){return this._models.slice(!t.is(e)||i?1:e)},initial:function(e,i){return this._models.slice(0,this._models.length-(!t.is(e)||i?1:e))},without:function(){var t;return t=Array.prototype.concat.apply([],Array.prototype.slice.call(arguments)),this._models.filter(function(e){return-1===t.indexOf(e)})},indexOf:function(t,e){return this._models.indexOf(t,e)},lastIndexOf:function(t,e){return this._models.lastIndexOf(t,e)},contains:function(t){return-1!==this.indexOf(t)},size:function(){return this._models.length},isEmpty:function(){return 0===this._models.length},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},pluck:function(t){return this._models.map(function(e){return e.get(t)})},shuffle:function(){var t,e;return e=[],this.forEach(function(n,r){t=i.random(r),e[r]=e[t],e[t]=n}),e},where:function(e,i){return t.is(e)?this[i?"find":"filter"](function(t){var i;for(i in e)if(e[i]!==t.get(i))return!1;return!0}):i?void 0:[]},findWhere:function(t){return this.where(t,!0)},invoke:function(){var t=Array.prototype.slice.call(arguments);return t.unshift(this._models),e.invoke.apply(null,t)},forEach:function(t,e){return this._models.forEach(t,e)},map:function(t,e){return this._models.map(t,e)},every:function(t,e){return this._models.every(t,e)},some:function(t,e){return this._models.some(t,e)},sortBy:function(t,e){var i,n;return i=c(t),(n=this._models.map(function(t,n,r){return{model:t,index:n,criteria:i.call(e,t,n,r)}})).sort(function(t,e){var i,n;if((i=t.criteria)!==(n=e.criteria)){if(i>n||void 0===i)return 1;if(i<n||void 0===n)return-1}return t.index<e.index?-1:1}),n.map(function(t){return t.model})},groupBy:function(e,i){var n,r,s=this._models;return n=c(e),r={},this.forEach(function(e,o){var h=n.call(i,e,o,s);t.owns(r,h)||(r[h]=[]),r[h].push(e)}),r},countBy:function(e,i){var n,r,s=this._models;return n=c(e),r={},this.forEach(function(e,o){var h=n.call(i,e,o,s);t.owns(r,h)||(r[h]=0),r[h]++}),r},find:function(t,e){var i;return this.some(function(n,r,s){if(t.call(e,n,r,s))return i=n,!0}),i},filter:function(t,e){return this._models.filter(t,e)},reject:function(t,e){return this.filter(function(e,i,n){return!t(e,i,n)},e)},reduce:function(t,e,i){var n=t;return i&&(n=n.bind(i)),arguments.length>1?this._models.reduce(n,e):this._models.reduce(n)},reduceRight:function(t,e,i){var n=t;return i&&(n=n.bind(i)),arguments.length>1?this._models.reduceRight(n,e):this._models.reduceRight(n)},max:function(t,e){var i,n;if(t&&!this.isEmpty())return n=c(t),i={computed:-1/0,model:void 0},this.forEach(function(t,r,s){var o;if((o=n.call(e,t,r,s))>=i.computed)return i={model:t,computed:o}}),i.model},min:function(t,e){var i,n;if(t&&!this.isEmpty())return n=c(t),i={computed:1/0,model:void 0},this.forEach(function(t,r,s){var o;if((o=n.call(e,t,r,s))<i.computed)return i={model:t,computed:o}}),i.model},fetch:function(e){var i,n,r=this;return void 0===(e=e?t.clone(e,!1):{}).parse&&(e.parse=!0),i=e.onComplete,e.onComplete=function(t){var n;return n=e.reset?"reset":"set",r[n](t,e),i&&i(r,t,e),r.dispatchEvent("onSync",[r,t,e])},n=e.onFailure,e.onFailure=function(t){n&&n(r,t,e),r.dispatchEvent("onError",[r,t,e])},r.sync("read",r,e)},create:function(e,i){var n,r,s=this;return i=i?t.clone(i,!1):{},!!(n=s._prepareModel(e,i))&&(i.wait||s.add(n,i),r=i.onComplete,i.onComplete=function(t,e){if(i.wait&&s.add(t,i),r)return r(t,e,i)},n.save(null,i),n)},_reset:function(){return this.length=0,this._models=[],this._byId={},this._byId},_prepareModel:function(e,i){var n;return e instanceof h?(e.collection||(e.collection=this),e):((i=t.is(i)?t.clone(i,!1):{}).collection=this,(n=new this.model(e,i)).validationError?(this.dispatchEvent("onValidationFailure",[this,n.validationError,i]),!1):n)},_removeReference:function(t){return this===t.collection&&delete t.collection,t.removeEvent("onAnyEvent",this._modelListener,this)},_onModelEvent:function(e,i,n,r){if("onAdd"!==e&&"onRemove"!==e||n===this)return"onDestroy"===e&&this.remove(i,r),i&&e==="onChange:"+i.idAttribute&&(delete this._byId[i.previous(i.idAttribute)],t.is(i.id)&&(this._byId[i.id]=i)),this.dispatchEvent(e,[i,n,r])}}),t.namespace("Collection",d,n)});