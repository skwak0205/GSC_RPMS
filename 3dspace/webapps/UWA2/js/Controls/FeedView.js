define("UWA/Controls/FeedView",["UWA/Core","UWA/Class","UWA/Event","UWA/String","UWA/Controls/Abstract","UWA/Controls/Ellipsis","UWA/Controls/Scroller","UWA/Controls/Pager"],function(e,t,i,s,n,o,r,a){"use strict";var l=n.extend({defaultOptions:{nbItems:10,showDate:!0,messages:{noItem:"There is no news in this feed.",loadMore:"Load more news.",websiteLink:"Go to website",readMore:"Read more"},images:{loader:e.hosts.uwa+e.paths.css+"base/img/loader.gif",image:e.hosts.uwa+e.paths.css+"base/img/article.png"},scroller:{lockDirection:!0,momentum:!0,bounce:!0},pager:{type:0,showMoreLink:!0}},pagerPosition:"bottom",scrollPosition:"top",itemPerPage:0,init:function(e){this._parent(e),this.itemsEllipsis=[],this.itemsImages={loaded:[],loading:[],waiting:[],maxLoading:2},this.buildSkeleton()},buildSkeleton:function(){var t=this.pagerPosition;return this.container=e.createElement("div",{class:"uwa-feedview content uwa-feedview-"+this.viewName.replace(/ /g," uwa-feedview-"),events:{resize:this.dispatchAsEventListener("onResize"),mousedown:this.dispatchAsEventListener("onMouseDown")}}),this.buildItems(),this.buildScroller(),t&&(-1!==["top","both"].indexOf(t)&&this.buildPager("top"),-1!==["bottom","both"].indexOf(t)&&this.buildPager("bottom")),this.container},buildItems:function(){var t=this.options.messages,i=this.elements;return i.item=[],i.items=e.createElement("div",{class:"items"}),i.itemsActions=e.createElement("div",{class:"actions",html:[{tag:"div",class:"loadMore action",html:{tag:"a",href:"#",text:e.i18n(t.loadMore)},styles:{display:"none"}},{tag:"div",class:"noItem action",text:e.i18n(t.noItem),styles:{display:"none"}},{tag:"div",class:"websiteLink action",html:{tag:"a",href:"#",text:e.i18n(t.websiteLink)},styles:{display:"none"}}]}).inject(i.items),i.items.inject(this.container),i.items},buildScroller:function(){var t=this,i=t.elements,s=e.merge({events:{onRefresh:function(){t.refreshPager(),t.loadItemsImages()},onScrollEnd:function(){t.loadItemsImages()}}},t.options.scroller);i.scrollarea=e.createElement("div",{class:"scrollarea"}).grab(i.items).inject(t.container,"top"),t.scroller=new r(t.elements.items,s)},setScrollerHeight:function(e){this.pager&&(e-=this.pager.getContent().getDimensions().outerHeight),this.elements.top&&(e-=this.elements.top.getDimensions().outerHeight),this.elements.scrollarea?this.elements.scrollarea.setStyle("height",e+"px"):this.container.setStyle("height",e+"px"),this.refreshScroller()},refreshScroller:function(){var e=this.scroller;e&&e.dispatchEvent("onRefresh")},buildPager:function(t){var i=this,s=e.merge({_root:!1,events:{onOffsetChange:function(e){var t=i.options.source.getItems();i.showItem(t[e])}}},i.options.pager);i.pager=new a(s),i.pager.inject(i.container,t)},refreshPager:function(){var e,t,i,s=this.pager,n=this.options.source;s&&(e=n.getItems(),i=this.getItemsPerPage(),t=e.indexOf(this.currentItem),s.options.moreLink=n.getLink(),s.setLength(e.length),s.setLimit(i),s.setOffset(-1===t?0:t),s.dispatchEvent("onRefresh"))},getItemsPerPage:function(){var e,t,i=0,s=this.elements.item;for(e=0,t=s.length;e<t;e++)this.scroller.isInViewport(s[e])&&i++;return this.itemPerPage=i,this.itemPerPage},buildItem:function(t){var i,n=this.options,o=n.source.isItemRead(t),r=!(!n.showDate||!t.date)&&s.parseRelativeTime(t.date.toString());return i=e.createElement("div",{class:"item "+(o?"read":"unread"),html:{tag:"div",class:"content",html:{tag:"div",class:"infos",html:[{tag:"div",class:"title",html:[{tag:"a",class:"link ellipsis",href:t.link,html:s.stripTags(t.title)},{tag:"div",class:"separator"}]},r&&{tag:"div",class:"date",html:[{tag:"span",html:r},{tag:"div",class:"separator"}]}]}},events:{click:this.dispatchAsEventListener("onItemClick",t)}}),this.addEllipsis({reference:i.getElement(".content"),element:i.getElement(".ellipsis")}),i.setData("href",t.link),i.setData("item-index",t.index),i},getItem:function(e){var t=e.index,i=this.elements.item;return i[t]||(i[t]=this.buildItem(e)),i[t]},getItems:function(e){return e.map(this.getItem,this)},refreshItems:function(){var e=this.options.source.getItems();this.injectItems(e)},injectItems:function(e){var t=this.getItems(e),i=t.length,s=this.elements,n=this.options,o=n.source,r=o.getItems().length,a=o.hasMore(s.items.length);s.itemsActions.getElement(".loadMore").toggle(a),s.itemsActions.getElement(".noItem").toggle(!r),(t=t.splice(0,n.nbItems)).push(s.itemsActions),t.forEach(function(e,t){0===t?e.addClassName("first"):t===i-1&&e.addClassName("last"),e.addClassName(t%2==0?"odd":"even")}),s.items.addContent(t),!this.currentItem&&e[0]&&this.showItem(e[0])},showItem:function(e){var t=this.currentItem,i=this.options.source;t!==e&&(t&&this.getItem(t).removeClassName("active"),this.getItem(e).removeClassName("unread").addClassName("read").addClassName("active"),i.setItemRead(e),this.currentItem=e,this.scroller&&this.scroller.scrollToElement(this.getItem(e),this.scrollPosition))},loadMore:function(e){var t=this.options,i=t.source.getLoaded();e=e||t.nbItems,this.injectItems(i.splice(this.elements.items.length,e))},destroy:function(){this.container&&this.container.destroy()},addEllipsis:function(e){this.itemsEllipsis.push(e)},loadEllipsis:function(){var e,t,i,s=this.itemsEllipsis;for(e=0,t=s.length;e<t;e++)(i=s[e]).ellipsis||(i.ellipsis=new o(i.element,{_root:!1,reference:i.element.getParent()}));this.refreshEllipsis()},refreshEllipsis:function(){var e,t,i,s=this.itemsEllipsis;for(e=0,t=s.length;e<t;e++)(i=s[e]).ellipsis&&i.ellipsis.dispatchEvent("onRefresh")},resizeItemImage:function(e){var t,i,s,n,o,r=e&&e.getElement("img");(e=r&&r.getParent())&&e.offsetWidth>0&&e.isInjected()&&(t={width:"auto",height:"auto",marginTop:0,marginLeft:0},r.setStyles(t),i={width:r.offsetWidth,height:r.offsetHeight},o=(s={width:e.offsetWidth,height:e.offsetHeight}).width/s.height,n=i.width/i.height,this.options.images.loader===r.src&&(s.width>i.width||s.height>i.height)?(t.marginLeft=s.width/2-i.width/2+"px",t.marginTop=s.height/2-i.height/2+"px"):o<n?(t.height="100%",t.marginLeft=-(s.height*n-s.width)/2+"px"):(t.width="100%",t.marginTop=-(s.width/n-s.height)/2+"px"),r.setStyles(t))},buildItemImage:function(t,i){var n=this.options.images,o=n[i],r=t[i]||o,a=e.createElement("img"),l=e.createElement("div",{class:"image",html:{tag:"a",title:s.stripTags(t.title),href:t.link,html:a}}),h=this.resizeItemImage.bind(this,l);return this.addItemImage({item:t,container:l,src:r,onLoad:function(){a.setAttribute("src",r),h()},onError:function(){a.setAttribute("src",o),h()},onLoading:function(){a.setAttribute("src",n.loader),h()}}),l},addItemImage:function(e){this.itemsImages.waiting.push(e)},loadItemsImages:function(){var e,t,i,s=[],n=this.itemsImages;for(e=0,t=n.waiting.length;e<t;e++)((i=n.waiting[e]).item===this.currentItem||this.scroller.isInViewport(i.container,!0))&&s.push(i);for(e=0,t=s.length;e<t;e++)this.loadItemImage(s[e])},loadItemImage:function(t){var i,s=this,n=s.itemsImages,o=function(){var e,i,o,r,a=[];if(-1!==(o=n.loading.indexOf(t))&&n.loading.splice(o,1),-1===(o=n.loaded.indexOf(t))){for(n.loaded.push(t),e=0,i=n.waiting.length;e<i;e++)r=n.waiting[e],t.src===r.src&&(a.push(r),n.loaded.push(r));for(e=0,i=a.length;e<i;e++)s.loadItemImage(a[e])}};-1!==(i=n.waiting.indexOf(t))&&n.waiting.splice(i,1),-1!==n.loaded.indexOf(t)?(t.onLoad(),o()):(t.onLoading(),n.loading.push(t),e.createElement("img",{styles:{display:"none"},events:{load:function(){t.onLoad(),this.destroy(),o()},error:function(){t.onError(),this.destroy(),o()}}}).inject(document.body).setAttribute("src",t.src))},onPostInject:function(){this.refreshItems()},onResize:function(){this.itemPerPage=0,this.refreshScroller()},onItemClick:function(e,t){t&&this.showItem(t)&&i.stop(e),this.refreshPager()},onMouseDown:function(e){i.preventDefault(e)}});return l.Full=l.extend({buildItem:function(t){var i,n=this._parent(t),o=n.getElement(".content");return i=e.createElement("div",{class:"description ellipsis",html:{tag:"div",html:s.stripTags(t.content)}}).inject(o),this.addEllipsis({reference:i,element:i.getElement("div")}),this.buildItemImage(t,"image").inject(n,"top"),n}}),l.Presentable=l.Full.extend({presentedItem:null,buildSkeleton:function(){return this._parent().grab(this.buildItemTop(),"top")},buildItemTop:function(){return this.elements.top=e.createElement("div",{class:"top",html:{tag:"div",class:"actions",html:{tag:"div",class:"readMore action",html:{tag:"a",text:e.i18n(this.options.messages.readMore)}}}}),this.elements.top},showItem:function(e){var t,i=this.elements.top;if(this._parent(e),!this.presentedItem||this.presentedItem.getData("item-index")!==e.index)return this.presentedItem&&this.presentedItem.remove(),(t=this.buildItem(e)).inject(i,"top"),i.getElement(".readMore").getElement("a").setAttribute("href",e.link),this.presentedItem=t,this.loadItemsImages(),!0}}),l.Adapter={},l.Adapter.Abstract=t.extend({init:function(e){this.object=e},hasMore:function(){return!1},isItemRead:function(){return!1},setItemRead:function(){return!1},getItems:function(){return[]},getLink:function(){return null}}),l.Adapter.Feed=l.Adapter.Abstract.extend({getItems:function(){return this.object.getItems()},isItemRead:function(e){return this.object.isItemRead(e.index)},setItemRead:function(e){return this.object.setItemRead(e.index)},getLink:function(){return this.object.getLink()}}),e.namespace("Controls/FeedView",l,e,!0)});