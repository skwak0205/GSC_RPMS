define("UWA/Controls/Calendar",["UWA/Core","UWA/Date","UWA/Event","UWA/Controls/Abstract","UWA/String"],function(e,t,i,n,s){"use strict";var a,r=e.i18n;function l(e,t){var i=!e;return i===!t&&(i||e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate())}function h(e,t,i){var n=e.getDate();if(void 0===i&&(i=1),"year"===t?(i*=12,t="month"):"week"===t&&(i*=7,t="day"),"month"===t)e.setDate(1),e.setMonth(e.getMonth()+i+1),e.setDate(0),n<e.getDate()&&e.setDate(n);else{if("day"!==t)throw new Error('Unknown unit "'+t+'"');e.setDate(n+i)}}return a=n.extend({name:"uwa-calendar",defaultOptions:{view:"month",weekFirstDay:"monday",limit:{}},weekOffset:{monday:1,sunday:0,saturday:6},init:function(e){this._parent(e),this.buildSkeleton(),this.bound={refreshLimit:this.refreshLimit.bind(this)},this.setLimit(this.options.limit),this.setDate(this.options.date),this.displayView(this.options.view)},getWeekOffset:function(){return this.weekOffset[this.options.weekFirstDay]||0},getMonthFirstDay:function(){var e=this.displayDate;return(new Date(e.getFullYear(),e.getMonth(),1).getDay()-this.getWeekOffset()+7)%7},getWeekFirstDay:function(){var e=this.displayDate;return e.getDate()-(7+e.getDay()-this.getWeekOffset())%7},iterateWeek:function(e,t){var i,n=this.displayDate,s=new Date(n.getFullYear(),n.getMonth(),this.getWeekFirstDay()),a=s.getDate();for(i=0;i<7;i+=1){var r=new Date(s);r.setDate(a+i),e.call(t,i,r)}return this},displayView:function(e){if(["month","week"].indexOf(e)<0)throw new Error("Unknown view "+e+"options");return e!==this.currentView&&(this.container.setContent(this["build"+s.ucfirst(e)+"View"]()),this.currentView=e,this.dispatchEvent("onRefresh")),this},setDate:function(e,t){t||(e||((e=new Date).setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0)),t=e);var i=!l(e,this.selectDate);return!i&&l(t,this.displayDate)||(this.selectDate=e,this.displayDate=t,this.dispatchEvent("onRefresh"),i&&this.dispatchEvent("onDateChange",[e])),this},getDate:function(){return this.selectDate||null},setLimit:function(e){e||(e={});var t=this.options.limit;return this.options.limit=e,[t.max,t.min,e.max,e.min].forEach(function(e,t){e instanceof a&&e[t<2?"removeEvent":"addEvent"]("onDateChange",this.bound.refreshLimit)},this),this.refreshLimit(),this},getLimit:function(){var e,t,i,n=this.options.limit||{},s={};for(e=0;e<2;e+=1)i=n[t=e?"max":"min"],s[t]=i&&new Date((i.getTime||i.getDate||i).call(i)).getTime()||(e?1/0:-1/0);return s.min-=864e5,s},refreshLimit:function(){var e=this.getLimit();if(e.end<e.start)throw new Error("Bad limit specified");return this.selectDate&&(this.preventRefresh(),this.setDate(new Date(Math.max(Math.min(e.max,this.selectDate),e.min))),this.allowRefresh()),this.dispatchEvent("onRefresh")},preventRefresh:function(){return this.doNotRefresh=this.doNotRefresh+1||1,this},allowRefresh:function(){return this.doNotRefresh=this.doNotRefresh-1||0,this},buildSkeleton:function(){this.container=e.createElement("div",{class:this.getClassNames(),events:{click:this.onClick.bind(this),mousedown:i.preventDefault}})},buildMonthView:function(){var i,n,s,a=e.createElement("div",{class:"monthView"}),r=e.createElement("div",{class:"top"}).inject(a),l=e.createElement("table").inject(a),h=e.createElement("tbody").inject(l),o=e.createElement("tr").inject(h);for(this.iterateWeek(function(i,n){e.createElement("th",{text:t.strftime(n,"%a")[0]}).inject(o)}),n=0;n<42;n+=1)n%7==0&&(i=e.createElement("tr").inject(h)),s=e.createElement("td").inject(i),e.createElement("div",{class:"day"}).inject(s);return e.createElement("span",{class:"previous uwa-icon","data-icon":"l"}).inject(r),e.createElement("span",{class:"title"}).inject(r),e.createElement("span",{class:"next uwa-icon","data-icon":"m"}).inject(r),this.elements.monthView=a,a},buildWeekView:function(){var i,n,s=e.createElement("div",{class:"weekView"}),a=e.createElement("div",{class:"top"}).inject(s),r=e.createElement("table").inject(s),l=e.createElement("tbody").inject(r),h=e.createElement("tr").inject(l);for(this.iterateWeek(function(i,n){e.createElement("th",{text:t.strftime(n,"%a")[0]}).inject(h)}),n=0;n<7;n+=1)n%7==0&&(i=e.createElement("tr").inject(l)),e.createElement("td",{html:{tag:"div",class:"day"}}).inject(i);return e.createElement("span",{class:"previous",text:"←"}).inject(a),e.createElement("span",{class:"title"}).inject(a),e.createElement("span",{class:"next",text:"→"}).inject(a),this.elements.weekView=s,s},refreshMonthView:function(){var e,i,n=this.displayDate,s=new Date(n.getFullYear(),n.getMonth(),-this.getMonthFirstDay()),a=this.elements.monthView,l=a.getElements(".day");for(e=0,i=l.length;e<i;e+=1)s.setDate(s.getDate()+1),l[e]=this.buildDay(l[e],s);a.getElement("tbody").getElements("tr")[6][s.getDate()>6?"hide":"show"](),a.getElement(".title").setText(t.strftime(n,r("%B %Y")))},refreshWeekView:function(){var e,i,n,s=this.displayDate,a=new Date(s.getFullYear(),s.getMonth(),this.getWeekFirstDay()),l=t.strftime(a,r("%e %B")),h=this.elements.weekView,o=h.getElements(".day");for(e=0,i=o.length;e<i;e+=1)o[e]=this.buildDay(o[e],a),a.setDate(a.getDate()+1);a.setDate(a.getDate()-1),n=t.strftime(a,r("%e %B %Y")),h.getElement(".title").setText(l+" - "+n)},buildDay:function(e,t){var i=new Date,n=this.displayDate,s=this.getLimit();return e.getClosest("td").toggleClassName("currentDay",l(t,n)).toggleClassName("selectDate",l(t,this.selectDate)).toggleClassName("today",l(t,i)).toggleClassName("currentMonth",t.getMonth()===n.getMonth()).toggleClassName("disabled",t<s.min||t>s.max),e.setText(t.getDate()),e},onRefresh:function(){var e=this.currentView;e&&!this.doNotRefresh&&this["refresh"+s.ucfirst(e)+"View"]()},onClick:function(e){var t,n=this.container,s=i.getElement(e),a=s.hasClassName("next")?1:s.hasClassName("previous")?-1:0,r=new Date(this.displayDate);s.getClosest(".disabled")||(s.hasClassName("day")?(h(r,"day",(t=n.getElements(".day")).indexOf(s)-t.indexOf(n.getElement(".currentDay .day"))),this.setDate(r),this.dispatchEvent("onDateSelect",[r])):a&&(h(r,this.currentView,a),this.setDate(this.selectDate,r)))}}),e.namespace("Controls/Calendar",a,e)});