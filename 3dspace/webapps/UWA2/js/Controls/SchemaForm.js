define("UWA/Controls/SchemaForm",["UWA/Core","UWA/Array","UWA/Class","UWA/Promise","UWA/Controls/Abstract","UWA/Controls/ToolTip","UWA/Controls/SchemaForm/Inputs","UWA/Controls/SchemaForm/Sanitizers","UWA/Controls/SchemaForm/Validators","UWA/Controls/Input"],function(t,e,i,s,n,a,o,l,h,r){"use strict";var c,d;return c=n.extend({name:"uwa-schemaform",fields:null,onChangePaused:!1,isPropagatingChanges:!1,options:{schema:null,initialValue:{},inputs:o,sanitizers:l,validators:h,submitButton:!0,clearButton:!1,data:null,baseInputOptions:{}},init:function(t){this._parent(t),this._initFields()},_initFields:function(){this.fields={},Object.keys(this.options.schema.fields).forEach(function(t){var e=this.options.initialValue&&this.options.initialValue[t];this.fields[t]=new d(this,t,this.options.schema.fields[t],e)},this)},getContent:function(){return this.elements.container||this._buildContent(),this.elements.container},buildNotice:function(e,i,s){i=i||"tooltip",this.notices[s]?this.notices[s].setAttribute("uwa-tooltip",e):this.notices[s]=t.createElement("div",{class:this.getClassNames("-notice uwa-icon "+i),"uwa-tooltip":e,"uwa-tooltip-delay":"10"}),this.notices[s].inject(s?this.fields[s].getContent():this.elements.container)},_buildContent:function(){var e=this;return this.elements.container=t.createElement("div",{class:this.getClassNames()}),this.notices={},this.options.schema.notice&&this.buildNotice(this.options.schema.notice.text,this.options.schema.notice.icon),Object.keys(this.fields).forEach(function(t){this.elements.container.addContent(this.fields[t].getContent()),this.fields[t].schema.input.options&&this.fields[t].schema.input.options.hidden&&this.fields[t].getContent().hide()},this),(this.options.submitButton||this.options.clearButton)&&(this.elements.buttonContainer=t.createElement("div",{class:this.getClassNames("-buttons")}).inject(this.elements.container),this.options.clearButton&&(this.elements.clearButton=new r.Button(t.merge({_root:!1,value:"Clear",events:{onClick:function(){e.clearValue()}}},this.options.baseInputOptions)).inject(this.elements.buttonContainer)),this.options.submitButton&&(this.elements.submitButton=new r.Button(t.merge({_root:!1,value:"Submit",events:{onClick:function(){e.isValid().then(function(){e.dispatchEvent("onSubmit",[{value:e.getValue()}])})}}},this.options.baseInputOptions)).inject(this.elements.buttonContainer))),this.elements.container},getValue:function(){var e={};return Object.keys(this.fields).forEach(function(i){var s=this.fields[i].getValue();s||t.is(s,"boolean")||(s=null),e[i]=s},this),e},getDisplayValue:function(){var t={};return Object.keys(this.fields).forEach(function(e){t[e]=this.fields[e].getDisplayValue()},this),t},getFieldValue:function(t){var e=this.fields[t];return e?e.getValue():null},getAllFieldsName:function(){return Object.keys(this.fields)},setFieldValue:function(t,e){this.fields[t]&&(this.fields[t].setValue(e),this._onFieldChanged(t))},setFieldTitle:function(t,e){this.fields[t]&&this.fields[t].setTitle(e)},getValidatedValue:function(){var t=this.getValue();return this.isValid().then(function(){return t})},getValidatedFieldValue:function(t){var e=this.fields[t];return e.isValid().then(function(){return e.getValue()})},setValue:function(t){this.onChangePaused=!0,t=t||{},Object.keys(this.fields).forEach(function(e){t.hasOwnProperty(e)&&this.fields[e].setValue(t[e])},this),this.updateValidityMessages(),this.onChangePaused=!1},clearValue:function(){this.onChangePaused=!0,Object.keys(this.fields).forEach(function(t){this.fields[t].setValue(null)},this),this.updateValidityMessages(),this.onChangePaused=!1},isValid:function(){return s.allSettled(Object.keys(this.fields).map(function(t){return this.fields[t].isValid().fail(function(e){return s.reject(Object.assign(e,{fieldName:t}))})},this)).then(function(t){var e={};if(t.forEach(function(t){"rejected"===t.state&&(e[t.reason.fieldName]=t.reason)}),0!==Object.keys(e).length)throw Object.assign(new Error("There is an error within a field"),{fieldErrors:e})})},updateValidityMessages:function(){Object.keys(this.fields).forEach(function(t){this.fields[t].updateValidityMessage({forceValidation:!0})},this)},getSchemaformData:function(){return this.options.data},_createContextForField:function(){return{getFieldValue:this.getFieldValue.bind(this),setFieldValue:this.setFieldValue.bind(this),getAllFieldsName:this.getAllFieldsName.bind(this),getValidatedFieldValue:this.getValidatedFieldValue.bind(this),getSchemaformData:this.getSchemaformData.bind(this),hideField:this.hideField.bind(this),showField:this.showField.bind(this),buildNotice:this.buildNotice.bind(this),addValidityMessage:this.addValidityMessage.bind(this),hideValidityMessage:this.hideValidityMessage.bind(this),setFieldTitle:this.setFieldTitle.bind(this)}},addValidityMessage:function(t,e){this.fields[t]&&this.fields[t].addValidityMessage(e)},hideValidityMessage:function(t){this.fields[t]&&this.fields[t].hideValidityMessage()},hideField:function(t){this.fields[t]&&this.fields[t].getContent().hide()},showField:function(t){this.fields[t]&&this.fields[t].getContent().show()},_executeSanitizers:function(t,e,i){var s=this,n=i;return this._getSanitizersFor(t).forEach(function(t){var i=s._evaluateOptions(t,e),a=s.options.sanitizers[t.id];n=a(n,i)}),n},_executeValidators:function(t,e,i){var n=this,a=this._getValidatorsFor(t);return s.all(a.map(function(a){var o=n._evaluateOptions(a,e),l=n.options.validators[a.id].bind(null,i,o,t);return s.resolve().then(l)}))},_getSanitizersFor:function(t){return t.sanitizers?t.sanitizers:t.sanitizer?[t.sanitizer]:[]},_getValidatorsFor:function(t){return t.validators?t.validators:t.validator?[t.validator]:[]},_evaluateOptions:function(e,i){var s;if(e.computedOptions){s={};var n=e.computedOptions;for(var a in n)if(n.hasOwnProperty(a)){var o=n[a],l=o.sourceFieldName,h=this.getFieldValue(l);h=this._executeSanitizers(o,i,h),s[a]=h}e.options&&(s=t.merge(s,e.options))}else s=e.options?e.options:{};return s=t.merge(s,{context:i})},_findDependencies:function(t){if(!t)return[];var e=[];if(t.computedOptions){var i=t.computedOptions;for(var s in i)if(i.hasOwnProperty(s)){var n=i[s],a=this._getSanitizersFor(n);if("string"==typeof n.sourceFieldName&&""!==n.sourceFieldName&&e.push(n.sourceFieldName),a)for(var o=0;o<a.length;o++){var l=a[o],h=this._findDependencies(l);e=e.concat(h)}}}return e},_onFieldChanged:function(t){this.isPropagatingChanges||(this._propagateChanges([t]),this.onChangePaused||this.dispatchEvent("onChange",[{value:this.getValue()}]))},_propagateChanges:function(t){this.isPropagatingChanges=!0;for(var e=0;t.length;){for(var i=[],s=0;s<Object.keys(this.fields).length;s++){var n=Object.keys(this.fields)[s];this.fields[n].onFieldsChanged(t)&&i.push(n)}if(t=i,++e>500)throw new Error("I reckon there might be some good old cyclical references in your computedOptions, partner.")}this.isPropagatingChanges=!1},destroy:function(){Object.keys(this.fields).forEach(function(t){this.fields[t].destroy()},this),this._parent()}}),d=i.extend({host:null,schema:null,elements:null,fallbackValue:void 0,context:null,dependencies:null,validationCacheIsFor:null,cachedValidationPromise:null,init:function(t,e,i,s){var n=this;function a(t){var e=[];return t.forEach(function(t){e=e.concat(n.host._findDependencies(t))}),e}this.host=t,this.schema=i,this.name=e,this.elements={},this.fallbackValue=s,this.context=t._createContextForField(this),this.dependencies={input:this.host._findDependencies(this.schema.input),sanitizer:a(this.host._getSanitizersFor(this.schema)),validator:a(this.host._getValidatorsFor(this.schema))}},getContent:function(){return this.elements.container||this._buildContent(),this.elements.container},_buildContent:function(){this.elements.container=t.createElement("div",{class:this.host.getClassNames("-field")+" input-"+this.schema.input.id}),this.elements.validityMessage=t.createElement("div",{class:this.host.getClassNames("-field-validity-message")}).inject(this.elements.container),this.elements.title=t.createElement("div",{class:this.host.getClassNames("-field-title"),text:this.schema.title}).inject(this.elements.container),this.elements.inputWrapper=t.createElement("div",{class:this.host.getClassNames("-field-wrapper")}).inject(this.elements.container),this._buildInput(),this.schema.notice&&this.context.buildNotice(this.schema.notice.text,this.schema.notice.icon,this.name)},setTitle:function(t){this.elements.title&&this.elements.title.setText(t)},_buildInput:function(){this.elements.control&&(this.elements.control.destroy(),this.elements.inputWrapper.empty());var e=this.host.options.inputs[this.schema.input.id],i=t.clone(this.host._evaluateOptions(this.schema.input,this.context));i=Object.assign({},this.host.options.baseInputOptions,i,{_root:!1,context:this.context,schema:this.schema,name:this.name}),this.fallbackValue&&Object.assign(i,{value:this.fallbackValue}),this.elements.control=new e(i).inject(this.elements.inputWrapper),this.elements.control.addEvent&&this.elements.control.addEvent("onChange",function(){this.fallbackValue=this.elements.control.getValue(),this.updateValidityMessage(),this.host._onFieldChanged(this.name)},this)},_isValidationCacheUpToDate:function(){return this.cachedValidationPromise&&this.validationCacheIsFor===this._getRawValue()},getValue:function(){return this._sanitize(this._getRawValue())},getDisplayValue:function(){return this.elements.control&&this.elements.control.getDisplayValue?this.elements.control.getDisplayValue():this._getRawValue()},_getRawValue:function(){return this.elements.control?this.elements.control.getValue():this.fallbackValue},_sanitize:function(t){return this.host._executeSanitizers(this.schema,this.context,t)},setValue:function(t){this.elements.control?this.elements.control.setValue(t):this.fallbackValue=t},isEmpty:function(){return!this.elements.control||this.elements.control.isEmpty()},isValid:function(){var t=this.host._getValidatorsFor(this.schema).filter(function(t){return"one-of"===t.id}).length;return this._isValidationCacheUpToDate()&&!t||(this.validationCacheIsFor=this._getRawValue(),this.cachedValidationPromise=this.host._executeValidators(this.schema,this.context,this.getValue())),this.cachedValidationPromise},updateValidityMessage:function(t){var e=this;(void 0!==this.fallbackValue||t&&t.forceValidation)&&this.isValid().then(function(){e.hideValidityMessage()},function(t){e.addValidityMessage(t)})},addValidityMessage:function(t){this.elements.validityMessage&&(this.elements.validityMessage.textContent=t.message,this.elements.container.addClassName("invalid"))},hideValidityMessage:function(){this.elements.validityMessage&&(this.elements.validityMessage.textContent="",this.elements.container.removeClassName("invalid"))},onFieldsChanged:function(t){var e=this,i=!1;function s(i){var s=e.dependencies[i];return t.some(function(t){return s.indexOf(t)>-1})}return s("input")&&this.elements.container&&(i=!0,this._buildInput()),s("sanitizer")&&(i=!0),s("validator")&&(this.validationCacheIsFor=null,this.updateValidityMessage()),i},destroy:function(){this.elements.container&&(this.elements.container.destroy(),this.elements.control.destroy&&this.elements.control.destroy())}}),t.namespace("Controls/SchemaForm",c,t,"replace")});