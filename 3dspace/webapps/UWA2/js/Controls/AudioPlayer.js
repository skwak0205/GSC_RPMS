define("UWA/Controls/AudioPlayer",["UWA/Core","UWA/Utils","UWA/Utils/Client","UWA/Event","UWA/Element","UWA/Controls/Abstract","UWA/Controls/Slider"],function(t,e,a,s,i,o,n){"use strict";var r,l=0;function d(t){var a,s,i=r.Adapter,o=e.parseUrl(t);for(a in i)i.hasOwnProperty(a)&&!s&&i[a].isAvailable(o.fileName)&&(s=i[a]);return s}return(r=o.extend({name:"uwa-audioplayer",defaultOptions:{url:"",autoPlay:!1,handleButton:!0,closeButton:!0,preload:"none",className:"",isTouch:a.Features.touchEvents,player:{html:[{tag:"div",class:"uwa-icon play-pause"},{tag:"div",class:"controls-times",html:[{tag:"span",class:"played",text:"00:00"},{tag:"span",class:"duration duration-hide",text:"00:00"}]},{tag:"div",class:"controls-slider"},{tag:"div",class:"controls-right",html:{tag:"div",class:"uwa-icon close close-hide"}}],playPauseClass:"play-pause",timeClass:"time",durationClass:"duration",playedClass:"played",errorMessageClass:"error-message",playingClass:"playing",waitingClass:"waiting",errorClass:"error",closeClass:"close"}},adapter:null,init:function(e){var a=this;this.id=l,l++,t.Controls.AudioPlayer.Instances["x"+this.id]=this,e=e||{},this._parent(e),this.eventNames={start:this.options.isTouch?"touchstart":"mousedown",move:this.options.isTouch?"touchmove":"mousemove",end:this.options.isTouch?"touchend":"mouseup"},this.body=e.body||document.body,this.buildSkeleton(),this.attachEvents(),this.reset(),this.options.url&&this[this.options.autoPlay?"play":"load"](),this.container.addEvent("resize",function(){var t,e,s,i,o,n,r;(t=a.elements).slider.show(),t.controlsTimes.show(),t.controlsRight.show(),e=a.container.getSize().width,s=t.playPause.getSize().width,i=t.slider.getSize().width,o=t.controlsTimes.getSize().width,n=t.controlsRight.getSize().width,i<30&&(t.slider.hide(),(r=s+o+n)>e-10&&(t.controlsTimes.hide(),(r-=o)>e-7&&t.controlsRight.hide()))})},getAdapter:function(t){var e=d(t);if(e)return this.adapter||(this.adapter=e.build(this)),this.adapter.setUrl(t),this.adapter;window.open(t)},buildSkeleton:function(){var e,a,s=this.options,i=s.player;return a=(e=t.createElement("div",{class:this.getClassNames(),html:s.player.html})).getElement.bind(e),this.elements={playPause:a(".play-pause"),slider:null,controlsTimes:a(".controls-times"),controlsRight:a(".controls-right"),played:a("."+i.playedClass),duration:a("."+i.durationClass),play:a("."+i.playPauseClass),close:a("."+i.closeClass)},this.options.closeButton&&this.elements.close.removeClassName("close-hide"),this.container=e,this},attachEvents:function(){var t=this,e=t.elements,a=t.dispatchEvent.bind(t);return e.play.addEvent("click",a.bind(t,"onPlayPause")),this.options.closeButton&&e.close.addEvent("click",a.bind(t,"close")),t.slider=new n({_root:!1,container:t.container,events:{onChange:function(a){var s=a*t.adapter.getDuration()/100;t.adapter.setCurrentTime(s),e.played.setText(t.formatTime(s))}}}),t.elements.slider=t.slider.elements.scrubber,this},reset:function(){var t=this.elements;this.loadedPercent=0,this.canPlay=!1,this.shouldPlay=!1,t.duration.setText(this.formatTime(0)),t.played.setText(this.formatTime(0))},load:function(t){t=t||this.options.url,this.stop(),this.reset(),this.show(),this.adapter=this.getAdapter(t)},play:function(t,e){this.load(t,e),this.adapter&&(this.adapter.play(),this.shouldPlay=!0)},pause:function(){this.adapter&&this.adapter.pause(),this.shouldPlay=!1},stop:function(){this.adapter&&(this.adapter.stop(),this.slider.reset())},close:function(){this.stop(),this.slider.reset(),this.hide()},onPlayPause:function(){this.adapter&&this.adapter[this.adapter.isPaused()?"play":"pause"]()},onPlay:function(){this.container.addClassName(this.options.player.playingClass).removeClassName("paused"),this.canPlay||this.container.addClassName(this.options.player.waitingClass),this.shouldPlay=!0},onPause:function(){this.container.removeClassName(this.options.player.waitingClass).removeClassName(this.options.player.playingClass).addClassName("paused"),this.shouldPlay=!1},onCanPlay:function(){(this.options.preload||"none"!==this.options.preload)&&this.trackLoadProgress(),this.container.removeClassName(this.options.player.waitingClass),this.canPlay=!0,this.shouldPlay&&this.adapter&&this.adapter.isPaused()&&this.adapter.play()},onMetadataLoaded:function(){this.elements.duration.setText(this.formatTime(this.adapter.getDuration()))},onTimeUpdate:function(){this.elements.played.setText(this.formatTime(this.adapter.getCurrentTime()));var t=100*this.adapter.getCurrentTime()/this.adapter.getDuration();this.slider.setValue(t)},trackLoadProgress:function(){this.loadTimer&&clearTimeout(this.loadTimer),this.loadedPercent<1&&(this.loadTimer=setTimeout(function(){this.onLoadProgress(),this.trackLoadProgress()}.bind(this),400))},onLoadProgress:function(){this.loadedPercent=this.adapter?this.adapter.getLoadProgress():0,this.loadedPercent&&this.slider.setLoadedValue(this.loadedPercent)},formatTime:function(t){var e=parseInt(t,10),a=Math.floor(e/60,10),s=e-60*a;return s=isNaN(s)?0:s,(a=isNaN(a)?0:a)+":"+(s<10?"0"+s:s)}})).canPlay=function(t){return Boolean(d(t))},r.Instances={},r.Adapter={audio:{audioTag:null,isAvailable:function(t){var e=document.createElement("audio");return!!e.canPlayType&&(/\.mp3$/.test(t)&&""!==e.canPlayType("audio/mpeg")||/\.m4a$/.test(t)&&""!==e.canPlayType("audio/x-m4a")||/\.ogg$/.test(t)&&""!==e.canPlayType('audio/ogg; codecs="vorbis"'))},build:function(e){return this.audioTag=t.createElement("audio",{id:"uwa-audioplayer-audio-"+e.id,preload:e.options.preload,events:{play:e.onPlay.bind(e),pause:e.onPause.bind(e),ended:function(){e.pause(),e.elements.played.setText(e.formatTime(0)),e.slider.reset()},timeupdate:function(){e.dispatchEvent("onTimeUpdate"),e.onLoadProgress()},loadedmetadata:e.onMetadataLoaded.bind(e),canplay:e.dispatchEvent.bind(e,"onCanPlay")}}).setStyles({position:"absolute",top:"-100000px"}),this.audioTag.inject(e.container),this},isPaused:function(){return this.audioTag.paused},play:function(){this.audioTag.play()},pause:function(){this.audioTag.pause()},stop:function(){this.audioTag.pause()},setCurrentTime:function(t){try{this.audioTag.currentTime=t}catch(t){}},getCurrentTime:function(){return this.audioTag.currentTime},getDuration:function(){return this.audioTag.duration},getLoadProgress:function(){var t=0,e=this.audioTag;return e&&e.buffered&&e.buffered.length>0&&e.buffered.end&&e.duration?t=e.buffered.end(0)/e.duration:e&&void 0!==e.bytesTotal&&e.bytesTotal>0&&void 0!==e.bufferedBytes&&(t=e.bufferedBytes/e.bytesTotal),100*t},setVolume:function(t){this.audioTag.volume=parseFloat(t/200)},getVolume:function(){return 200*this.audioTag.volume},setUrl:function(t){this.audioTag.src=t,this.audioTag.load()}}},t.namespace("Controls/AudioPlayer",r,t)});