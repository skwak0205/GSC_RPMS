define("UWA/Controls/DataGrid",["UWA/Core","UWA/Event","UWA/String","UWA/Element","UWA/Controls/Abstract","UWA/Controls/Scroller"],function(t,e,s,i,r,a){"use strict";var o=new WeakMap;function l(e){var s=t.createElement(e.tag||"th",{class:e.dataIndex,html:{tag:"span",html:e.text}});if(e.sortable){var i=t.createElement("span",{class:"sort",text:""}).inject(s);s.addClassName("sortable"),e.isSorted&&i.setText(e.sortReverse?"D":"E")}else s.addClassName("no-sortable"),e.text||s.addClassName("empty");return e.className&&s.addClassName(e.className),e.isFirst&&s.addClassName("first"),e.color&&s.setStyles({"background-color":e.color,color:"#FFFFFF"}),s}function n(e){var i=t.createElement(e.tag||"td",{class:e.dataIndex,"data-itemId":e.itemId,html:e.format?e.format(e.text):e.text});if(e.className&&i.addClassName(e.className),e.isFixed&&i.addClassName("is-fixed"),e.isFirst?i.addClassName("first"):i.addClassName("grid-data"),e.color){var r=s.hexToRgb(e.color,!0);i.setStyle("background-color","rgba("+r.toString()+",0.2)")}return i}var d=r.extend({defaultOptions:{className:"",data:null,columns:null,sortable:!1,orderBy:"",sortReverse:!1,scrollerOptions:{}},name:"uwa-datagrid",dataGrid:null,columns:null,init:function(t){this._parent(t),this.dataGrid=t.data,this.columns=t.columns,this.buildSkeleton(),this.fillGrid(),this.initEvents()},setScrollerSize:function(t){this.scroller&&this.scroller.setSize(t)},buildSkeleton:function(){var e=this.options,s=this.elements;s.container=t.createElement("div",{class:this.getClassNames()}),s.grid=t.createElement("table",{class:this.getClassNames("-table")}).inject(s.container),e.sortable&&s.grid.addClassName("sortable")},initEvents:function(){this.elements.container.addEvent("click",this.handleEvent.bind(this))},handleEvent:function(t){var s=e.getElement(t).getClosest("th");this.options.sortable&&s&&!s.hasClassName("no-sortable")&&this.onOrderColumn(s.className.split(" ")[0])},fillGrid:function(){this.fillHeader(),this.fillBody()},fillHeader:function(){var e,s,i,r=this.elements,a=this.columns;for(r.grid.empty(),i=t.createElement("tr").inject(r.grid),e=0,s=a.length;e<s;e++)l({isSorted:this.options.orderBy===a[e].dataIndex,sortReverse:this.options.sortReverse,className:a[e].className,dataIndex:a[e].dataIndex,text:a[e].text,isFirst:a[e].isFirst,sortable:this.options.sortable&&!a[e].noSortable,color:a[e].color}).inject(i)},fillBody:function(){var e,s,i,r,a,o=this.elements,l=this.options,d=this.columns,c=this.dataGrid;for(l.sortable&&l.orderBy&&(c=this.sortData()),e=0,s=c.length;e<s;e++)for(a=t.createElement("tr").inject(o.grid),i=0,r=d.length;i<r;i++){var h=c[e][d[i].dataIndex];n({text:h,isFixed:c[e].isFixed||d[i].isFixed,className:(c[e].className||"")+" "+(d[i].className||""),dataIndex:d[i].dataIndex,itemId:t.is(h,"object")&&h.itemId,format:d[i].format,isFirst:d[i].isFirst,color:d[i].color}).inject(a)}},sortData:function(){var t=this.options,e=this.dataGrid,s=this.columns.filter(function(e){return e.dataIndex===t.orderBy})[0];if(!s)throw new Error("Sort column was not found : "+t.orderBy);return e.sort(function(e,i){var r,a;return(r=s.sortKey?s.sortKey(e[t.orderBy]):e[t.orderBy])<(a=s.sortKey?s.sortKey(i[t.orderBy]):i[t.orderBy])?t.sortReverse?1:-1:r>a?t.sortReverse?-1:1:0}),e},onOrderColumn:function(t){var e=this.options;e.orderBy===t?e.sortReverse=!e.sortReverse:e.sortReverse=!1,e.orderBy=t,this.fillGrid(),this.scroller&&this.scroller.updateFixedHeaders(this.elements.grid),this.dispatchEvent("updateSortOptions",e)},updateData:function(t,e){this.dataGrid=e,this.columns=t,this.fillGrid(),this.scroller&&this.updateScroller()},addScroller:function(){this.scroller=new d.GridScroller(this.elements.grid,t.extend({_root:!1},this.options.scrollerOptions)),this.scroller.addEvent("onRefresh",function(t){t&&t.target===this.elements.grid&&this.scroller.setFixedHeaderSizes()}.bind(this))},updateScroller:function(){this.scroller&&this.scroller.destroy(),this.addScroller()}});return d.GridScroller=a.extend({defaultOptions:{lockDirection:!1},init:function(t){this._parent.apply(this,arguments),this.updateFixedHeaders(t)},_buildFixedHeaders:function(t){var e=this._getFixedHeadersSize(t),s=e.top,i=e.left;e.left&&(e.left=this._buildFixedHeader(t,e.left,1/0)),e.bottom&&(e.bottom=this._buildFixedHeader(t,1/0,-e.bottom)),e.right&&(e.right=this._buildFixedHeader(t,-e.right,1/0)),e.top&&(e.top=this._buildFixedHeader(t,1/0,e.top),e.left&&(e.topLeft=this._buildFixedHeader(t,i,s))),this._fixedHeaders=e},_isHeaderCell:function(t){return"th"===i.getTagName.call(t)||i.hasClassName.call(t,"is-fixed")},_getFixedHeadersSize:function(t){var e={top:0,bottom:0,left:1/0,right:1/0},s=!0,r=this;return i.getElements.call(t,"tr").forEach(function(t){var a=0,o=0,l=!0;i.getChildren.call(t).forEach(function(t){r._isHeaderCell(t)?(l&&a++,o++):(l=!1,o=0)}),e.left=Math.min(e.left,a),e.right=Math.min(e.right,o),l?(s&&e.top++,e.bottom++):(s=!1,e.bottom=0)}),e},setFixedHeaderSizes:function(){var t=[];Object.keys(this._fixedHeaders).forEach(function(e){var s=this._fixedHeaders[e];if(s){var r={width:0,height:0};i.getElements.call(s,"tr").forEach(function(e,s){var a=i.getDimensions.call(o.get(e));r.height+=a.outerHeight,i.getChildren.call(e).forEach(function(e){var a=i.getDimensions.call(o.get(e));t.push({element:e,size:{width:a.innerWidth,height:a.innerHeight}}),0!==s||e.isHidden()||(r.width+=a.outerWidth)})}),t.push({element:s,size:r})}},this),t.forEach(function(t){i.setStyles.call(t.element,t.size)})},_buildFixedHeader:function(e,s,r){function a(t,e){return e<0?t.slice(e):t.slice(0,e)}var l,n={tag:"tbody",html:[]};return a(i.getElements.call(e,"tr"),r).forEach(function(e){var r=t.createElement("tr");o.set(r,e),n.html.push(r),a(i.getChildren.call(e),s).forEach(function(t){var e=t.cloneNode(!0);o.set(e,t),r.grab(e)})}),l=e.cloneNode(),i.setHTML.call(l,n),i.addClassName.call(l,"fixed-column"),this.elements.scroller.grab(l),l},_updateHeaderPositions:function(t){var e=this._fixedHeaders;e.top&&i.setPosition.call(e.top,{y:0,x:t.x}),e.left&&i.setPosition.call(e.left,{y:t.y,x:0}),e.right&&i.setPosition.call(e.right,{y:t.y,x:this.scroll.width-i.getSize.call(e.right).width}),e.bottom&&i.setPosition.call(e.bottom,{x:t.x,y:this.scroll.height-i.getSize.call(e.bottom).height}),e.topLeft&&i.setPosition.call(e.topLeft,{y:0,x:0})},updateFixedHeaders:function(t){var e;if(this._fixedHeaders)for(e in this._fixedHeaders)this._fixedHeaders[e]&&i.destroy.call(this._fixedHeaders[e]);this._buildFixedHeaders(t),this.setFixedHeaderSizes(),this._updateHeaderPositions(this.position)},onScroll:function(){this._parent.apply(this,arguments),this._updateHeaderPositions(this.getPosition(!0))}}),t.namespace("Controls/DataGrid",d,t)});