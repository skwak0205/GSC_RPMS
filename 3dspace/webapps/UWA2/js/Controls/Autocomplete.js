define("UWA/Controls/Autocomplete",["UWA/Core","UWA/Array","UWA/Class/Timed","UWA/Promise","UWA/Utils/Scroll","UWA/Controls/AutocompleteAdaptors/Data","UWA/Controls/Abstract","UWA/Controls/EnhancedTextarea","UWA/Controls/Input","UWA/Controls/DropDown","UWA/Controls/ThemedScroller","UWA/Event"],function(t,e,n,s,i,o,u,g,l,a,r,h){"use strict";var d,p;return d=g.extend({setInlineText:function(t){this.elements.inlineText.setText(t)},getInlineText:function(){return this.elements.inlineText.getText()},buildSkeleton:function(){this._parent(),this.elements.inlineText=t.createElement("span",{class:this.getClassNames("-inline-text")})},buildContentMimic:function(){return[this._parent(),"â€‹",this.elements.inlineText]}}),p=u.extend(n,{name:"uwa-autocomplete",options:{typeDelay:500,adaptor:null,adaptorOptions:{},inputOptions:{attributes:{autocomplete:"off"}},multiline:!1,floatingSuggestions:!1,previewSuggestion:!1,minLength:1,suggestFormat:"{name}",suggestUrl:null,dataParser:null,placeholder:""},init:function(t){this._parent(t)},isFloating:function(){return this.options.multiline&&this.options.floatingSuggestions},getAdaptor:function(){if(!this._adaptor){var e=this.options,n=t.typeOf(e.adaptor);this._adaptor="class"===n?new e.adaptor(e.adaptorOptions):"object"===n?e.adaptor:new o(t.merge({format:e.suggestFormat,url:e.suggestUrl,dataParser:e.dataParser,minLength:e.minLength},e.adaptorOptions))}return this._adaptor},getContent:function(){return this.elements.container||this.buildSkeleton(),this.elements.container},getInputControl:function(){return this.elements.input||this.buildSkeleton(),this.elements.input},getInputElement:function(){return this.getInputControl().getInputElement()},buildSkeleton:function(){var e=this,n=e.options,s=e.elements,i=t.clone(n.inputOptions),o=this.isFloating();n.placeholder&&(i.attributes||(i.attributes={}),i.attributes.placeholder=n.placeholder),i._root=!1,s.input=n.multiline?new d(i):new l.Text(i),n.multiline&&s.input.addEvent("onResize",function(){s.dropdown.updatePosition()}),s.input.addEvents({onKeyDown:this.dispatchEvent.bind(this,"onKeyDown"),onChange:this.dispatchEvent.bind(this,"onChange")}),s.input.getInputElement().addEvents({blur:function(){this.elements.container.removeClassName("focus"),this.setDelayed("blur-hide-suggestions",this.hideSuggestions,1)}.bind(this),focus:function(){this.elements.container.addClassName("focus"),this.setDelayed("focus-update-suggestion",this.updateSuggestions,400)}.bind(this)}),s.dropdown=o?new a.Pointy({_root:!1,target:s.input.getCaretElement(),className:this.getClassNames("-floating-dropdown"),autoPosition:["below-center","above-center"],positionOptions:{fit:"resize-max"}}):new a({_root:!1,className:this.getClassNames("-dropdown"),position:function(){return{x:0,y:s.input.getContent().getSize().height}},positionOptions:{fit:"resize-max",relative:s.container,boundaryMargin:4}}),s.suggestions=t.createElement("div",{class:this.getClassNames("-suggestions"),events:{click:this._selectionMouseHandler.bind(this),mousedown:function(t){h.preventDefault(t)},mouseover:this._selectionMouseHandler.bind(this)}}),s.scroller=new r({_root:!1}),s.scroller.getInnerElement().setContent(s.suggestions),s.dropdown.getInnerElement().setContent(s.scroller),s.dropdown.addEvents({onHide:function(){e.dispatchEvent("onHideSuggestions")},onPreUpdatePosition:function(){this.getContent().setStyles({"max-height":null,"max-width":null})},onShow:function(){var t=Math.min(s.suggestions.scrollHeight,200);s.dropdown.getContent().setStyle("height",t),e.dispatchEvent("onShowSuggestions")}}),s.container=t.createElement("div",{class:this.getClassNames()+(o?" floating":" not-floating")+(n.multiline?" multiline":" singleline"),html:[s.input,s.dropdown]})},updateSuggestions:function(e){var n=this.getValue(),i=s.deferred(),o=this.getInputElement(),u=o.selectionStart,g=n+"-"+u,l=e&&e.resetInput,a=e&&t.is(e.typeDelay)?e.typeDelay:this.options.typeDelay;return o.getDocument().activeElement!==o?(this.hideSuggestions({resetInput:l}),this.clearDelayed("getSuggestions"),i.resolve()):this._updateSuggestionRun&&g===this._updateSuggestionRun.key?this._updateSuggestionRun&&this._updateSuggestionRun.promise.then(i.resolve,i.reject):(this._updateSuggestionRun={promise:i.promise,key:g},this.setDelayed("hideSuggestionsIfGettingThemIsToSlow",function(){this.hideSuggestions({resetInput:l,cancelUpdateSuggestions:!1})},100),this.setDelayed("getSuggestions",function(){this.getSuggestions(n,u).done(function(t){this._updateSuggestionRun&&g===this._updateSuggestionRun.key?(t.length?this.displaySuggestions(t):this.hideSuggestions({resetInput:!1,cancelUpdateSuggestions:!1}),this.clearDelayed("hideSuggestionsIfGettingThemIsToSlow"),i.resolve()):i.reject(new Error("Aborted by another call to updateSuggestion"))}.bind(this))},a)),i.promise},getSuggestions:function(t,e){return s.cast(this.getAdaptor().getSuggestions(t,e)).then(function(t){return(t||[]).map(function(t){return"string"==typeof t?{fullValue:t}:t})})},areSuggestionsDisplayed:function(){return Boolean(this._displayedSuggestions)},displaySuggestions:function(t){this._displayedSuggestions=t,this._currentSuggestionIndex=null;var e=this.elements.dropdown;this.elements.suggestions.setContent(this.getAdaptor().renderSuggestions(t)),e.show();var n=t[0];!this._isInlineSuggestionAvailable(n)&&this.options.previewSuggestion||this._highlightSuggestion(n)},hideSuggestions:function(t){this._resetSuggestion(!t||t.resetInput),t&&!1===t.cancelUpdateSuggestions||(this._updateSuggestionRun=null),this._displayedSuggestions=null,this.elements.dropdown.hide()},getValue:function(){return this.getInputControl().getValue()},setValue:function(t){this.getInputControl().setValue(t),this.updateSuggestions({resetInput:!1})},_selectionMouseHandler:function(t){var e,n=h.findElement(t,".suggestion");n&&(e=this._getSuggestion(n))&&("click"===t.type?this._setSuggestion(e):this._highlightSuggestion(e),h.stop(t))},_getParts:function(t,e){var n=this.getInputElement();return void 0===t&&(t=n.selectionStart),void 0===e&&(e=n.selectionEnd),{before:n.value.slice(0,t),between:n.value.slice(t,e),after:n.value.slice(e)}},_setParts:function(t,e){var n=this.getInputElement();n.value=t.before+t.between+t.after;var s=t.before.length,i=s+t.between.length;switch(e){case"start":i=s;break;case"end":s=i}n.selectionStart=s,n.selectionEnd=i},_getSuggestionIndex:function(e){if(t.is(e)||(e=this._currentSuggestionIndex,t.is(e)))return e.nodeType?e=this.elements.suggestions.getElements(".suggestion").indexOf(e):"object"==typeof e&&(e=this._displayedSuggestions.indexOf(e)),t.is(e,"number")&&e>=0?e:void 0},_getSuggestion:function(t){if(void 0!==(t=this._getSuggestionIndex(t)))return this._displayedSuggestions?this._displayedSuggestions[t]:void 0},_getSuggestionElement:function(t){if(void 0!==(t=this._getSuggestionIndex(t)))return this.elements.suggestions.getElements(".suggestion")[t]},_resetSuggestion:function(t){if(this._getSuggestion()){if(e.invoke(this.elements.suggestions.getElements(".current"),"removeClassName","current"),this.options.multiline&&this.elements.input.setInlineText(""),!1!==t&&this.options.previewSuggestion){var n=this._previousValue||"",s=this._getParts();s.between=n,this._setParts(s,"end")}this._previousValue=null,this._currentSuggestionIndex=null}},_getSuggestionParts:function(t){var e,n=this.getInputElement();return t.inlineValue?((e=this._getParts()).previous=e.between,e.between=t.inlineValue):t.fullValue&&((e=this._getParts(void 0!==t.start?t.start:0,void 0!==t.end?t.end:n.value.length+t.fullValue.length)).previous=e.between,e.between=t.fullValue),e},_highlightSuggestion:function(t){if(void 0!==(t=this._getSuggestion(t))){this._resetSuggestion(),this._currentSuggestionIndex=this._getSuggestionIndex(t);var e=this._getSuggestionElement(t),n=e.getParent(".category");e.addClassName("current"),i.scrollToElement(e),n&&n.addClassName("current");var s=this._getSuggestionParts(t);this._isInlineSuggestionAvailable(t)?this.elements.input.setInlineText(s.between):this.options.previewSuggestion&&this._setParts(s,"around"),this._previousValue=s.previous}},_isInlineSuggestionAvailable:function(t){var e=this.getInputElement();return t.inlineValue&&this.options.multiline&&e.selectionStart===e.value.length},_setSuggestion:function(t,e){(t=this._getSuggestion(t))&&(this._resetSuggestion(),this._setParts(this._getSuggestionParts(t),e&&e.selectionAtStart?"start":"end"),this.hideSuggestions(),this.dispatchEvent("onSetSuggestion",[t]),this.getInputControl()._dispatchOnChange())},onHideSuggestions:function(){this.elements.container.removeClassName("suggestions-displayed")},onShowSuggestions:function(){this.elements.container.addClassName("suggestions-displayed")},onClick:function(){this.elements.input.focus()},onKeyDown:function(t){var e=this,n=h.whichKey(t),s=null!==this._currentSuggestionIndex,i=!0;function o(){return Array.prototype.indexOf.call(arguments,n)>=0}function u(){e.setDelayed("updateSuggestions",e.updateSuggestions.bind(e,{resetInput:!1}),5)}function g(){e.dispatchEvent("onSubmit",[e.getValue()])}function l(t){var n=e._currentSuggestionIndex,s=e._displayedSuggestions.length;null===n&&(n=t<0?s:-1),e._highlightSuggestion(e._getSuggestion((n+t+s)%s))}this.areSuggestionsDisplayed()?o("up","shift+tab")?l(-1):o("down","tab")?l(1):o("return")&&s?this._setSuggestion(null,{selectionAtStart:o("left")}):o("return")&&this.hasEvent("onSubmit")?(this.hideSuggestions({resetInput:!1}),g()):o("esc")?this.hideSuggestions():o("shift")||(u(),i=!1):o("return")&&this.hasEvent("onSubmit")?g():(u(),i=!1),i&&h.stop(t)}}),t.namespace("Controls/Autocomplete",p,t)});