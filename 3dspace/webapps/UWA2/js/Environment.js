define("UWA/Environment",["UWA/Core","UWA/String","UWA/Array","UWA/Class","UWA/Class/Timed","UWA/Class/Events","UWA/Class/Debug","UWA/Class/Options","UWA/Utils","UWA/Element","UWA/Event","UWA/Json","UWA/Data","UWA/Internal/StringMap","UWA/Widget","UWA/Controls/Form","UWA/Controls/WidgetPopupMenu","UWA/Embedded","UWA/Promise","UWA/Utils/Client","UWA/Utils/Asset"],function(e,t,n,i,s,o,r,a,c,l,d,u,h,f,p,v,m,g,w,E,y){"use strict";function b(t){var n=e.hosts.netvibes+"/subscribe.php",i={module:"UWA",moduleUrl:t.getUrl()};return t.getPreferences().forEach(function(e){i[e.name]=e.value}),n+"?"+c.toQueryString(i)}var W=Object.create(null),U=i.extend(s,o,r,a,{name:null,inited:!1,registered:!1,launched:!1,widget:null,html:null,features:{},views:{},menuClass:m,defaultOptions:{formOptions:{nativeInputs:!1},defaultView:{type:"windowed"},initialView:null},init:function(e){this.setOptions(e),this.html={},this.view={},this.dispatchInit()},dispatchInit:function(){var e=this;e.setPeriodical("init",function(){document.body&&!e.inited&&(e.clearPeriodical("init"),e.dispatchEvent("onInit"),e.inited=!0)},100,!0)},hasFeature:function(t,n){var i,s=e.owns(this.features,t)&&this.features[t];if(!s)return!1;if(n)for(i in n)if(e.owns(n,i)&&(!e.owns(s,i)||n[i]!==s[i]))return!1;return!0},getWidget:function(){var e=this.widget||new p;return this.widget||this.registerWidget(e),e},registerWidget:function(t){var n=this;n.widget=t,n.setPeriodical("register",function(){if(n.inited&&!n.registered){var i,s=n.html;for(i in n.clearPeriodical("register"),t.environment=n,s)s.hasOwnProperty(i)&&s[i]!==window&&(t.elements[i]=e.extendElement(s[i]));t.body=s.body,e.Widgets=e.Widgets||{},e.Widgets.instances=e.Widgets.instances||[],e.Widgets.instances.push(t),n.dispatchEvent("onRegisterWidget"),n.registerMenus(),n.registered=!0}},100,!0)},launchWidget:function(e,t){var n=this;n.setPeriodical("launch",function(){n.isDataReady()&&n.registered&&(n.clearPeriodical("launch"),n.getWidget().launch(e,t))},100,!0)},destroy:function(){var t,n,i=this.html,s=this.widget;for(t in s&&(e.Widgets.instances.splice(e.Widgets.instances.indexOf(s),1),s.destroy(),this.widget=null),this.clearDelayed(),this.clearPeriodical(),i)i.hasOwnProperty(t)&&l.destroy.call(i[t]);for(n in this.view)this.view.hasOwnProperty(n)&&this.view[n]&&this.view[n].destroy();this.removeEvent(),this.registered=!1,this.launched=!1},onInit:function(){},onRegisterWidget:function(){var e=this,t=e.html,n=e.widget;e.data=new f,t.menus&&l.addEvent.call(t.menus,"click",function(t){var n=d.getElement(t),i=e.widget.getMenu(n.getAttribute("data-name"));i&&(e.dispatchEvent("onMenuExecute",[i]),i.items&&(e.popupMenu||(e.popupMenu=new e.menuClass(e).inject(document.body)),e.popupMenu.setTarget(n).setItems(i.items).toggle()))}),t.editAction&&(l.show.call(t.editAction),l.addEvent.call(t.editAction,"click",function(t){d.stop(t),e.dispatchEvent("toggleEdit")})),t.refreshAction&&(l.show.call(t.refreshAction),l.addEvent.call(t.refreshAction,"click",function(t){d.stop(t),e.dispatchEvent("onRefresh")})),t.shareAction&&(t.shareAction.href=b(n),l.addEvent.call(t.shareAction,"click",function(t){d.stop(t),e.dispatchEvent("onOpenURL",b(n))})),t.wrapper&&l.handleExternalLinks.call(t.wrapper,function(t,n){e.dispatchEvent("onOpenURL",[t,n])}),(t.viewport||t.wrapper)&&l.addEvent.call(t.viewport||t.wrapper,"resize",function(){e.dispatchEvent("onResize")}),l.addEvent.call(document,"keydown",function(t){var n=t.which||t.keyCode;e.dispatchEvent("onKeyboardAction",[n,t])}),t.body&&[E.Engine.name,E.Engine.name+E.Engine.version,E.Platform.name,E.Features.touchEvents?"touch":"no-touch",n.readOnly&&"readonly",e.name&&"environment-"+e.name].forEach(function(e){e&&l.addClassName.call(t.body,e)}),e.dispatchEvent("onResize"),e.dispatchEvent("onViewRequest",[e.options.initialView])},registerMenus:function(){var t=this.getWidget();t.setMenu({name:"options",icon:"options"}),t.readOnly||t.setMenu({name:"options/preferences",icon:"cogwheel",label:e.i18n("Settings"),onExecute:"toggleEdit"}),t.setMenu({name:"options/refresh",icon:"refresh",label:e.i18n("Refresh"),onExecute:"onRefresh"})},onUpdateMenu:function(n){var i=this.html;i.menus&&(n||(n=this.widget.menus),i.menus.empty(),n.forEach(function(n){var s;!1!==(e.is(n.visible,"function")?n.visible():!1!==n.visible)&&(s=e.createElement("span",{class:"uwa-widget-menu-button","data-name":n.name}),n.help&&(s.set("title",n.help),s.set("uwa-tooltip",t.escapeHTML(n.help))),n.icon&&s.addClassName("uwa-icon "+n.icon),n.className&&s.addClassName(n.className),s.inject(i.menus),i.header&&i.header.set("data-menus-items",i.menus.childNodes.length))}))},onMenuExecute:function(t){e.is(t.onExecute,"string")&&this.widget.dispatchEvent(t.onExecute,[t])},isDataReady:function(){return!e.Storage||e.Storage.allInstancesReady()},getAllData:function(){return this.data.getAll()},getData:function(e){return this.log("getData:"+e),this.data.get(e)},setData:function(e,t){return this.log("setData:"+e+","+t),this.data.set(e,t)},deleteData:function(e){return this.log("deleteData:"+e),this.data.remove(e)},dispatchEvent:function(e,t,n,i){this.log("environment.event:"+e);var s=this.widget;!i&&s&&this.addEventOnce(e,s.dispatchEvent.bind(s,e,t,n,!0)),this._parent(e,t,n)},loadWidget:function(t,n){return n=e.extend({onFailure:function(e){throw e},onTimeout:function(e){throw e},onComplete:function(){}},n),t=c.buildUrl(window.location.toString(),t),n.embedded?this.loadEmbeddedWidget(t,n):this.loadInlinedWidget(t,n),this},loadInlinedWidget:function(){var t,i={};function s(e,t,s){i[e]&&(n.invoke(i[e],t,s),delete i[e])}return t=function(t,o){var r=o.expositionError||o.error||o.errors;if(!r||e.is(r,"array")&&0===r.length){(o=this.convertSourceToJson(o)).className||(o.checksum||(o.checksum=c.getCRC32(t)),o.className="w-"+o.checksum),o.style&&(c.setCss(o.className,o.style,"."+o.className,t),delete o.style),"string"==typeof o.script&&(o.script=new Function("widget",o.script)),o.styles=this.filterExternalResources("style",o.styles||[]),o.scripts=this.filterExternalResources("script",o.scripts||[]);for(var a=[];o.styles.length;)a.push(y.css(c.buildUrl(t,o.styles.shift())));for(;o.scripts.length;)a.push(y.js(c.buildUrl(t,o.scripts.shift())));w.all(a).done(function(){var s=i[t];i[t]=o,e.is(s,"array")&&n.invoke(s,"onComplete",o)},function(e){s(t,"onFailure",e)})}else s(t,"onFailure",r)},function(n,o){var r=i[n],a=o.fetcher||"XML",c=o.onComplete,l=this;return o.onComplete=function(e){var t=l.getWidget();t.uwaUrl=n,t.setTitle(e.title),t.setIcon(e.icon),t.setMetas(e.metas),t.setPreferences(e.preferences),t.setPlugins(e.plugins),t.setBody(e.body),l.html.wrapper.addClassName(e.className),e.script&&e.script(t),c(t,l)},e.is(r,"object")?o.onComplete(r):(e.is(r,"array")?r.push(o):i[n]=[o],o=e.merge({onComplete:t.bind(this,n),onTimeout:s.bind(this,n,"onTimeout"),onFailure:s.bind(this,n,"onFailure")},o),e.is(a,"function")?a.call(this,n,o):!e.is(a,"string")||a.length>4?o.onComplete(a):"JSON"===(a=a.toUpperCase())?this.fetchJsonWidget(n,o):this.fetchXmlWidget(n,o)),this}}(),loadEmbeddedWidget:function(t,n){var i,s,o=this,r=l.setStyle,a={cache:n.cache,container:o.html.body,displayHeader:!1,displayFooter:!1,displayEdit:!0,autoLaunch:!1};return e.is(n.embedded,"object")&&e.extend(a,n.embedded),i=new g(t,a),r.call(o.html.body,"padding",0),r.call(i.elements.body,"padding",0),o.addEvent("onRegisterWidget",function(){var e={},t={onUpdateValue:!0,onRefresh:!0,onUpdateTitle:!0,onUpdateIcon:!0,onUpdateCounter:!0,onSearch:!0,onResetSearch:!0,onShowEdit:!0,onKeyboardAction:!0,onViewError:!0,onViewChange:!0,onEdit:!0,endEdit:!0,onLoad:function(){i.launch(o.getAllData(),o.getWidget().readOnly)}};Object.keys(t).forEach(function(n){var s=t[n];!0===s&&(s=i.sendRemote.bind(i,n)),e[n]=s}),o.addEvents(e)}),s=o.getWidget(),i.addEvent("onRegisterWidget",function(){var t={},r={onRefresh:!0,onUpdateTitle:!0,onUpdateIcon:!0,onUpdateCounter:!0,onSearch:!0,onResetSearch:!0,onHideEdit:!0,onShowEdit:!0,onOpenURL:!0,onViewRequest:!0,onInitConfig:function(e){e.preferences&&s.setPreferences(e.preferences),e.plugins&&s.setPlugins(e.plugins),e.metas&&s.setMetas(e.metas)},onUpdatePreferences:function(e){s.setPreferences(e)},onUpdateValue:function(e,t){s.setValue(e,t)}};a.displayEdit||e.merge(r,{onEdit:!0,endEdit:!0}),Object.keys(r).forEach(function(e){var n=r[e];!0===n&&(n=function(){s.dispatchEvent(e,arguments)}),t[e]=n}),i.addEvents(t),n.onComplete(s,o)}),o.embedded=i,o},convertSourceToJson:function(){var t=["name","defaultValue","type","label","step","min","max"],n=["label","value"],i=/(java|ecma)script$/i;function s(e,t,n){var i,s,o,r=[].slice.call(e.childNodes);for(i=0,s=r.length;i<s;i++)o=r[i],n&&1!==o.nodeType||t(o,o.nodeValue)}function o(e,t){var n,i,s,o=e.attributes||[];for(n=0,i=o.length;n<i;n++)t((s=o[n]).name,s.value)}var r={"widget:preferences":function(e,i){s(i,function(i){var r,a={};o(i,function(e,n){-1!==t.indexOf(e)&&(a[e]=n)}),a.name&&("list"!==a.type&&"checklist"!==a.type||(r=[],s(i,function(e){var t={};o(e,function(e,i){-1!==n.indexOf(e)&&(t[e]=i)}),t.label&&r.push(t)},!0),a.options=r),e.preferences.push(a))},!0)},"widget:plugins":function(e,t){s(t,function(n){var i={name:t.getAttribute("name"),options:{}};o(n,function(e,t){i[e]=t}),s(n,function(e){var t=e.getAttribute("name"),n=e.getAttribute("value");"widget:options"===e.tagName?(i.options[t]={},s(e,function(e){var n=e.getAttribute("name"),s=e.getAttribute("value");n&&(i.options[t][n]=s)},!0)):t&&(i.options[t]=n)},!0),i.name&&e.plugins.push(i)})},link:function(e,t,n){if(n.href){var i=n.rel;"icon"===i?e.icon=n.href:"stylesheet"!==i||n.href.contains("UWA/assets")||n.href.contains("standalone.css")||n.href.contains("uwa/style.css")||e.styles.push(n.href)}},meta:function(e,t,n){var i=n.content;i="false"!==i&&("true"===i||i),e.metas[n.name]=i},script:function(e,t,n){if(n.src||(n.language||n.type)&&!i.test(n.type)&&!n.language){if(!n.src||n.src.contains("Standalone")||n.src.contains("load.js.php"))return t;e.scripts.push(n.src)}else{var o="";s(t,function(e,t){o+=t}),/UWA(\s+)?=/.test(o)||(e.script+=o)}},title:function(e,t){s(t,function(t,n){e.title+=n})},style:function(e,t){s(t,function(t,n){e.style+=n})},fallback:function(e,t,n,i){var r;return"body"===i?((r=document.createElement("div")).className=t.className,e.body=r):r=document.createElement(i),o(t,function(e,t){r.setAttribute(e,t)}),s(t,function(t,n){switch(t.nodeType){case 1:var i=a(t,e);i&&r.appendChild(i);break;case 4:case 3:r.appendChild(document.createTextNode(n))}}),r}};function a(e,t){9===e.nodeType&&(e=e.childNodes[0]);var n=e.nodeName.toLowerCase(),i={};return o(e,function(e,t){i[e]=t}),r[r.hasOwnProperty(n)?n:"fallback"](t,e,i,n)}return function(t){if(e.is(t,"string"))try{t=c.loadXml(t)}catch(n){e.log("Invalid UWA XHTML source detected, fallback on HTML parsor."),t=c.loadHtml(t)}var n;return e.is(t,"object")?n=t:a(t,n={title:"",icon:"",preferences:[],plugins:[],metas:{},body:[],script:"",scripts:[],style:"",styles:[]}),n}}(),fetchJsonWidget:function(t,n){t in W||(W[t]=new w(function(i,s){var o,r={mode:"full",uwaUrl:t};e.debug&&(r.flush=1,r.mode="full_debug"),o=(n.server||e.hosts.exposition)+"/widget/json",u.request(o,{data:r,onComplete:i,onFailure:s,useJsonpRequest:!0,callback:t})})),W[t].then(n.onComplete,n.onError)},fetchXmlWidget:function(e,t){h.request(e,{cache:t.cache,type:"text",onFailure:t.onFailure,onTimeout:t.onTimeout,onComplete:t.onComplete})},filterExternalResources:function(e,t){return t},onRefresh:function(){var e=this.getWidget();e.data={},e.hasEvent("onRefresh")||e.dispatchEvent("onLoad",void 0,void 0,!0)},onUpdateIcon:function(t){var n=this.html;function i(){n.iconLoader.destroy(),delete n.iconLoader}n.icon&&(n.iconLoader&&i(),n.iconLoader=e.createElement("img",{styles:{display:"none"},events:{load:function(){n.icon.getElement("img").setAttribute("src",t),i()},error:function(){i()}}}).inject(this.html.wrapper),n.iconLoader.setAttribute("src",t))},onUpdateTitle:function(e){var t=this.html.title;t&&t.setHTML(e)},onUpdateCounter:function(e){var t=this.html.counter;t&&t.setText(e?"("+(!0===e?"â—":e)+")":"")},onEdit:function(){var t=this,n=t.html,i=t.getWidget(),s=i.metas,o=i.getPreferences();if(n.edit){if(n.edit.empty(),i.hasPreferences()){if(n.preferences){var r=n.preferences.getFormValues();o.forEach(function(t){e.is(r[t.name])&&(t.value=r[t.name])})}o.push({type:"submit",name:"endEdit",value:e.i18n("Done")}),n.preferences&&n.preferences.destroy(),n.preferences=new v({nativeInputs:this.options.formOptions.nativeInputs,darkBackground:this.options.formOptions.darkBackground,fields:o,events:{onChange:function(e,n,s){i.setValue(n,s),t.embedded?t.embedded.sendRemote("dispatchEvent",e,n,s):t.dispatchEvent(e,[n,s])},onSubmit:function(e,n){var s=!1;t.addEventOnce("onUpdateValue",function(){s=!0}),Object.keys(n).forEach(function(e){i.setValue(e,n[e])}),t.dispatchEvent("endEdit"),s&&t.dispatchEvent("onRefresh")}}}).inject(n.edit)}s.author&&n.edit.addContent({tag:"div",class:"moduleInfos",html:[{tag:"p",html:[e.i18n("Widget by")+" ",{tag:"strong",html:s.website?{tag:"a",href:s.website,text:s.author}:{tag:"span",text:s.author}}]}]})}t.dispatchEvent("onShowEdit")},onShowEdit:function(){var e=this.html;e.wrapper&&e.wrapper.addClassName("onEdit")},endEdit:function(){this.dispatchEvent("onHideEdit")},onHideEdit:function(){var e=this.html;e.wrapper&&e.wrapper.removeClassName("onEdit")},onCloseEdit:function(){this.html.preferences.destroy(),this.html.preferences=null},onOpenURL:function(n){if(n=c.parseUrl(n),!window.open(n.source,"_blank"))return window.alert(t.format(e.i18n('Unable to open "{0}", Please turn off your popup blocker and try again.'),t.truncate(n.source,50))),!1},onViewRequest:function(){function t(e,t,n){n&&(t.error=n),e.dispatchEvent(n?"onViewError":"onViewChange",[t])}function n(e,t,n){e[t]&&e[t].destroy(),e[t]=n}return function(i){var s;i||(i=this.options.defaultView),i=e.clone(i),this.view.current&&this.view.current.event&&(i.previous=e.clone(this.view.current.event),delete i.previous.previous),this.view.current&&this.view.current.matchEvent(i)?t(this,i,"This view is already active."):(s=function e(i,s){var o=i.views[s.type],r=o&&new o(i,s);return r&&r.addEvents({onEnter:function(){i.view.next===this&&(n(i.view,"current",this),this.isSingle()&&(U._currentSingleView=this),i.view.next=null,t(i,this.event))},onLeave:function(){i.view.current===this&&(U._currentSingleView===this&&(U._currentSingleView=null),i.view.next||(i.view.next=e(i,i.options.defaultView)),i.view.next.enter())},onError:function(e){i.view.next===this&&(n(i.view,"next"),i.view.current.enter()),t(i,this.event,e)}})}(this,i))?s.isSingle()&&U._currentSingleView&&U._currentSingleView!==this.view.current?(t(this,i,"An environment is already in single view."),s.destroy()):(n(this.view,"next",s),this.view.current?this.view.current.leave():this.view.next.enter()):t(this,i,'No implementation available for the view "'+i.type+'".')}}(),onViewChange:function(e){this.getWidget()._view=e},onViewError:function(e){this.log("View error: "+u.encode(e))}});return U.AbstractView=i.extend(o,{event:null,environment:null,init:function(e,t){this.environment=e,this.event=t},destroy:function(){this.removeEvents(),U._currentSingleView===this&&(U._currentSingleView=null)},enter:function(){this.dispatchEvent("onEnter")},leave:function(){this.dispatchEvent("onLeave")},isSingle:function(){return!1},matchEvent:function(e){return this.event.type===e.type},onEnter:function(){var e=this.environment.html;e.wrapper&&e.body&&n.invoke([e.wrapper,e.body],"addClassName",this.event.type+"-view")},onLeave:function(){var e=this.environment.html;e.wrapper&&e.body&&n.invoke([e.wrapper,e.body],"removeClassName",this.event.type+"-view")}}),U.prototype.views.windowed=U.AbstractView.extend({}),E.Features.fullscreen&&(U.prototype.views.fullscreen=U.AbstractView.extend({enter:function(){var e,t=this,n=t.getTarget();e={fullscreenchange:function(){document.fullscreenElement===n?t.dispatchEvent("onEnter"):(t.dispatchEvent("onLeave"),l.removeEvents.call(document,e))},fullscreenerror:function(){t.dispatchEvent("onError",["Error while trying to set the fullscreen"]),l.removeEvents.call(document,e)}},l.addEvents.call(document,e),n.requestFullscreen()},leave:function(){document.fullscreenElement===this.getTarget()?document.exitFullscreen():this.dispatchEvent("onLeave")},isSingle:function(){return!0},getTarget:function(){var e=this.environment.html;return e.content||e.body}})),e.namespace("Environment",U,e)});