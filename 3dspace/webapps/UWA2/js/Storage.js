define("UWA/Storage",["UWA/Internal/Deprecate","UWA/Core","UWA/Class","UWA/Class/Options","UWA/Class/Debug","UWA/Json"],function(e,t,a,r,s,n){"use strict";var i=a.extend(r,s,{AdaptersInstances:null,currentAdapter:null,defaultOptions:{database:"default",adapter:null,adapterOptions:{},availableAdapters:[]},internalKeys:{keysIndex:"_keysIndex",lastUpdate:"_lastUpdate"},isReady:!1,init:function(t){e.warn("UWA/Storage");var a;this.AdaptersInstances={},i.Instances.push(this),this.setOptions(t),(a=this.options.adapter)&&"auto"!==a?this.setCurrentAdapter(a):this.setCurrentAdapterFromDetected()},initAvailableAdapters:function(){var e,t=this,a=t.options.availableAdapters,r=i.Adapter;if(0===a.length)for(e in r)r.hasOwnProperty(e)&&"Abstract"!==e&&a.push(e);a.forEach(function(e){t.getAdapterInstance(e)})},isAvailableAdapter:function(e){var t,a=!1;try{(t=this.getAdapterInstance(e))&&t.isAvailable()?(a=!0,this.log('UWA.Storage:detectAvailableAdapter: "'+e+'" is available')):this.log('UWA.Storage:detectAvailableAdapter: "'+e+'" is not available')}catch(t){this.log('UWA.Storage:detectAvailableAdapter: "'+e+'" is not available cause: '+t)}return a},getAdapterInstance:function(e){var t=this.AdaptersInstances;if("string"!=typeof e)throw new Error('Bad adapterName param value "'+e+'" for getAdapterInstance.');if(!(t[e]||(t[e]=new i.Adapter[e](this,this.options.adapterOptions),t[e]instanceof i.Adapter.Abstract)))throw new Error("UWA.Storage.Adapter."+e+" is not an instance of UWA.Storage.Adapter.Abstract");return t[e]},detectAvailableAdapter:function(){var e=this,t=e.options,a=[];e.initAvailableAdapters(),t.availableAdapters.forEach(function(t){e.isAvailableAdapter(t)&&a.push(t)}),t.availableAdapters=a},setCurrentAdapterFromDetected:function(){var e=this.options;if(this.detectAvailableAdapter(),!(e.availableAdapters.length>0))throw new Error("UWA.Storage: No adapter available detected.");this.setCurrentAdapter(e.availableAdapters[0])},setCurrentAdapter:function(e){var t;if("string"!=typeof e)throw new Error('Bad adapterName param value "'+e+'" for setCurrentAdapter.');this.isAvailableAdapter(e)?((t=this.getAdapterInstance(e)).connect(this.options.database),this.log("UWA.Storage:setCurrentAdapter: "+e+";"),this.adapter=e,this.currentAdapter=t):(this.log('UWA.Storage:setCurrentAdapter: "'+e+'" fail fallback in auto detect mode'),this.setCurrentAdapterFromDetected())},store:function(e,t){var a,r=this.currentAdapter;return r&&(a=this.safeResurrect(r.get(e)),1===arguments.length?this.log('Get Key "'+e+'" with value "'+a+'"'):a!==t&&(a=this.safeStore(t),this.log('Update Key "'+e+'" with value "'+t+'" and stored value "'+a+'"'),a=r.set(e,a))),a},remove:function(e){return!!this.currentAdapter&&(this._updateLastUpdateDate(),this._removeKeyFromKeysIndex(e),this.safeResurrect(this.currentAdapter.rem(e)))},get:function(e,t){var a,r;return t?(a=this._getKeysIndex()).hasOwnProperty(e)&&Date.now()-a[e]<=t&&(r=this.store(e)):r=this.store(e),r},set:function(e,t){return this._updateLastUpdateDate(),this._addKeyToKeysIndex(e),this.store(e,t)},getAll:function(){var e=this,t=Object.keys(this._getKeysIndex()),a={};return t.forEach(function(t){a[t]=e.get(t)}),a},safeStore:function(e){return n.encode(e)},safeResurrect:function(e){if(!t.is(e,"undefined"))try{n.isJson(e)&&(e=n.decode(e))}catch(a){t.log("unsafe Resurrect JSON with value: "+e),t.log(a)}return e},getLastUpdateDate:function(e){var t;return t=e?this._getKeysIndex()[e]:this.get(this.internalKeys.lastUpdate),(new Date).setTime(t)},_getKeysIndex:function(){var e,a,r=this,s=r.safeResurrect(r.currentAdapter.get(this.internalKeys.keysIndex)),n=t.typeOf(s);return r.log("Get all keys from keysIndex"),"array"===n?(e={},a=r.getLastUpdateDate(),s.forEach(function(t){e[t]=a}),s=e):"object"!==n&&(s={}),s},_removeKeyFromKeysIndex:function(e){var t,a=this._getKeysIndex(),r={};for(t in this.log('Remove key "'+e+'" from keysIndex'),a)a.hasOwnProperty(t)&&t!==e&&(r[t]=a[t]);this._storeKeysIndex(r)},_addKeyToKeysIndex:function(e){var t=this._getKeysIndex();this.log('Add key "'+e+'" to keysIndex'),t[e]=Date.now(),this._storeKeysIndex(t)},_storeKeysIndex:function(e){this.currentAdapter.set(this.internalKeys.keysIndex,this.safeStore(e))},_updateLastUpdateDate:function(){var e=Date.now();return this.currentAdapter.set(this.internalKeys.lastUpdate,this.safeStore(e)),e}});return i.Instances=[],t.merge(i,{allInstancesReady:function(){return i.Instances.every(function(e){return e.isReady})}}),t.namespace("Storage",i,t)});