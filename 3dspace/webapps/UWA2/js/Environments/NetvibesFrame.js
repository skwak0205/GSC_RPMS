/*!
  Script: NetvibesFrame.js

    This file is part of UWA JS Runtime.

  About: License

    Copyright 2006-2012 Netvibes, a Dassault SystÃ¨mes company.
    All rights reserved.
*/
define("UWA/Environments/NetvibesFrame",["UWA/Core","UWA/Utils","UWA/Utils/Client","UWA/Utils/InterCom","UWA/Element","UWA/Environment","UWA/Controls/Scroller","UWA/Storage/Adapter/Object"],function(e,t,i,n,o,s,a){"use strict";var d=s.extend({name:"netvibesFrame",disableRemote:!0,communicationType:null,onInit:function(){var e=document.body,t=o.getElement.bind(e);t(".moduleFrame")||this.buildSkeleton(e),this.html={wrapper:t(".module"),header:t(".moduleHeader"),content:t(".moduleWrapper"),body:t(".moduleContent"),edit:t(".moduleEdit"),footer:t(".moduleFooter"),counter:t(".counter"),title:t(".title"),icon:t(".icon"),shareAction:t(".share"),refreshAction:t(".refresh"),editAction:t(".edit")},this.onResize()},buildSkeleton:function(t){var i=e.i18n,n=[];n.push({tag:"div",class:"moduleWrapper",html:[{tag:"div",class:"moduleContent",html:i("Loading...")}]}),o.setContent.call(t,{tag:"div",class:["module moduleUwa"].join(" "),html:n})},onRegisterWidget:function(){this._parent(),this.sendRemote("onRegisterWidget")},onUpdateCounter:function(e,t){this.sendRemote("setCounter",e,t)},onUpdateTitle:function(e){this.sendRemote("setTitle",!1,e)},onUpdateIcon:function(e,t){this.sendRemote("setIcon",!1,e)},onUpdateValue:function(e,t){this.sendRemote("setValue",e,t)},onUpdatePreferences:function(){this.sendRemote("onUpdatePreferences",this.widget.getPreferences())},addStar:function(t){this.sendRemote("addStar",!1,e.Json.encode(t))},onResize:function(){var e,t=this.html.wrapper,i=t.offsetWidth,n=t.offsetHeight;if(n>0&&n!==this.prevHeight&&(e=this.prevHeight?n>100||n>this.prevHeight?150:250:500,this.setDelayed("resizeHeight",function(e){this.sendRemote("resizeHeight",!1,e),this.prevHeight=e}.bind(this,n),e,this)),this.prevWidth===i)return!1;this.prevWidth=i,this.dispatchEvent("onResize")},openURL:function(t){var i,n,o=e.Utils.parseUrl(t);return"feed"===o.subprotocol?(n=String(o.anchor)||0,o.subprotocol=o.anchor=null,i=e.Utils.composeUrl(o),e.Services.Feed.Utils.load({readOnly:!0,urls:[i],callback:function(e){var t,i;for(i in e)if(e.hasOwnProperty(i)){t=e[i];break}this.sendRemote("feedReader","open",{index:n,feedData:t.data})}.bind(this)})):window.open(o.source),!0},sendRemote:function(t,i,n){var o,s,a=this.communicationType;if("HTML5postMessage"===a)(o=parent.postMessage?parent:parent.document.postMessage?parent.document:void 0)&&o.postMessage?(s=e.Json.encode({id:this.widget.id,action:t,name:i,value:n}),o.postMessage(s,"*")):this.log("Unable to sendRemote cause: postMessage interface not available");else if("TUApolling"===a||"TMUpolling"===a)try{s=e.Json.encode({id:this.widget.id,action:t,name:i,value:n}),this.widget.widgetObject.poll.push(s)}catch(e){this.log("Unable to sendRemote cause: parent widget object not ready on widget #"+this.widget.id+": ("+t+","+i+","+n+")")}},publicInterface:function(e,t,i){if(this.log("Received publicInterface call on widget #"+this.widget.id+": ("+e+","+t+","+i+")"),e)switch(e){case"onUpdateTheme":this.updateTheme(i);break;case"launchModule":this.launchWidget(i);break;case"setValue":this.widget.setValue(t,i);break;case"deleteValue":this.widget.deleteValue(t);break;case"onEdit":case"endEdit":case"onRefresh":case"onSearch":case"onResetSearch":case"onResetUnreadCount":case"onKeyboardAction":this.widget.dispatchEvent(e,i)}},initRemote:function(e){switch(this.communicationType=e||this.communicationType,this.log("Init Remote using "+this.communicationType+" as communication layer."),this.widget.publicInterface=this.publicInterface.bind(this),this.communicationType){case"HTML5postMessage":this.initHTML5postMessage();break;case"TUApolling":this.initTUApolling();break;case"TMUpolling":this.initTMUpolling();break;default:throw'Unable to init Remote for unknown "'+this.communicationType+'" communication layer.'}},initHTML5postMessage:function(){var t=function(t){var i=String(t.origin),n=e.Json.decode(t.data);!1===i.contains(this.widget.subspaceDomain)?e.log("No relay for message from "+i):n&&this.publicInterface(n.action,n.name,n.value)}.bind(this);window.addEventListener?window.addEventListener("message",t,!1):window.attachEvent&&window.attachEvent("onmessage",t),this.sendRemote("widgetIsReady")},initTUApolling:function(){this.createRemoteframe(),this.initRemotePolling()},initTMUpolling:function(){document.domain=this.widget.subspaceDomain,this.widget.widgetObject=parent.widgetObject,this.widget.widgetObject.widget=this.widget,this.initRemotePolling(),this.widget.widgetObject.poll.push('{"action":"widgetIsReady"}')},createRemoteframe:function(){var t=e.createElement("iframe",{src:"http://"+location.hostname+"/tuaproxy.html#id="+this.widget.id+"&subspaceDomain="+this.widget.subspaceDomain,styles:{position:"absolute",width:"100px",left:"-300px"}});document.body.appendChild(t)},initRemotePolling:function(){this.widget.poll=[],this.setPeriodical("poll",function(){if(e.Json.isJson(this.widget.poll[0])){var t=e.Json.decode(this.widget.poll[0]);t&&(this.publicInterface(t.action,t.name,t.value),this.widget.poll.shift())}},250)}});return e.namespace("Environments/NetvibesFrame",d,e)});