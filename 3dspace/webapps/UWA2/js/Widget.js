define("UWA/Widget",["UWA/Core","UWA/String","UWA/Array","UWA/Class","UWA/Class/Options","UWA/Class/Timed","UWA/Class/Events","UWA/Class/Debug","UWA/Utils","UWA/Utils/Client","UWA/Data","UWA/Element"],function(e,t,n,i,r,s,a,o,h,u,l,d){"use strict";function c(e){if(!Array.isArray(e))throw new Error(e+" should be an array");e.forEach(function(e){if("string"!=typeof e)throw new Error(e+" should be a string")})}function f(e,t){if(e){if(e.multiple||"checklist"===e.type)try{t=function(e){if(!e)return[];var t;if(Array.isArray(e))t=e;else try{t=JSON.parse(e)}catch(t){throw new Error("While parsing JSON value `"+e+"`: "+t)}return c(t),t}(t)}catch(t){throw new Error("While decoding value for preference "+e.name+": "+t)}"boolean"===e.type&&"boolean"!=typeof t&&void 0!==t&&(t="false"!==t&&Boolean(t))}return t}var m,p=i.extend(r,s,a,o,{init:function(){var e=u.Locale;this.id=null,this.environment=null,this.launched=!1,this.title=null,this.icon=null,this.counter=0,this.counterType=null,this.metas={},this.preferences=[],this.defaultData=Object.create(null),this.data={},this.plugins=[],this.events={},this.menus=[],this.elements={},this.body=null,this.lang=e.lang,this.locale=e.locale,this.dir=e.dir,this.readOnly=!1,this.isEdit=!1},launch:function(e,t){var n=this;return n.launched=!1,void 0!==t&&(n.readOnly=Boolean(t)),n.initPreferences(),n.initPlugins(),n.setValues(e),n.dispatchEvent("onInitConfig",{metas:n.metas,plugins:n.plugins,preferences:n.getPreferences()}),n.dispatchEvent("beforeLoad"),n.addEventOnce("onLoad",function(){n.launched=!0},n,1),n.dispatchEvent("onLoad"),n.launched&&n.dispatchEvent("afterLoad"),n.launched},destroy:function(){var e,t=this.elements;for(e in this.clearDelayed(),this.clearPeriodical(),t)t.hasOwnProperty(e)&&t[e].destroy();this.removeEvent(),this.launched=!1},setOptions:function(n){var i,r;for(i in n)r="set"+t.capitalize(i),e.is(this[r],"function")&&this[r](n[i]);return this._parent(n)},setAutoRefresh:function(e){(e=parseInt(e,10))&&e>0?this.setPeriodical("autoRefresh",this.dispatchEvent.bind(this,"onRefresh"),1e3*e*60):this.clearPeriodical("autoRefresh"),this.metas.autoRefresh=e},setCounter:function(t,n){(this.counter!==t||e.is(n)&&this.counterType!==n)&&(this.counter=t,this.counterType=n,this.dispatchEvent("onUpdateCounter",[t,n]))},getTitle:function(){return e.is(this.title,"string")?t.stripTags(this.title):""},setTitle:function(t,n){return(e.is(t,"string")||n&&this._titleUrl!==n)&&(this.title=t,this._titleUrl=n,this.dispatchEvent("onUpdateTitle",[t,n])),this.title},setIcon:function(t,n){return t&&e.is(t,"string")&&(n&&(t=l.proxifyUrl(t,{proxy:"icon"})),this.icon!==t&&(this.icon=t,this.dispatchEvent("onUpdateIcon",[t]))),this.icon},setMenu:function(t){var n,i,r,s=this.environment,a=t.name.split("/"),o=a[0];if(a.length>2)throw new Error("Adding more than one submenu level is not supported by setMenu");(r=this.getMenu(t.name))?e.extend(r,t):(a.length>1?((n=this.getMenu(o))||(n={label:o},this.menus.push(n)),n.items||(n.items=[]),i=n.items):i=this.menus,i.push(t)),this.setDelayed("onUpdateMenu",function(){s.dispatchEvent("onUpdateMenu",[this.menus])},20)},getMenu:function(t){var i,r;return e.is(t,"string")&&(r=t.split("/"),(i=n.detect(this.menus,function(e){return e.name===r[0]}))&&r.length>1&&(i=i.items&&n.detect(i.items,function(e){return e.name===t}))),i},removeMenu:function(e){var t,n,i,r;for(r=function(t){return t.name!==e},t=0,n=this.menus.length;t<n;t++){if((i=this.menus[t]).name===e){this.menus.remove(i);break}i.items&&(i.items=i.items.filter(r))}},setDir:function(e){var t=this.dir,n=this.elements.wrapper;return e="rtl"===e?"rtl":"ltr",n&&t!==e&&(n.setAttribute("dir",e),n.addClassName(e),n.removeClassName(t)),this.dir=e,e},setMetas:function(t){return e.extend(this.metas,t),e.is(t.debugMode)&&(this.setDebugMode(t.debugMode),this.environment&&this.environment.setDebugMode(t.debugMode)),e.is(t.autoRefresh)&&this.setAutoRefresh(t.autoRefresh),this.metas},setBody:function(e){if(!this.body)throw new Error("Widget.body is not yet available");this.body.setContent(e)},addBody:function(e){this.body.addContent(e)},getElements:function(e){return this.body.getElements(e)},getElement:function(e){return this.body.getElement(e)},createElement:function(t,n){return e.createElement(t,n)},setStyle:function(e){var t=this.id?"#m_"+this.id:".moduleWrapper";this.id&&this.elements.wrapper.setAttribute("id","m_"+this.id),h.setCss(!1,e,t,this.getUrl())},mutate:function(e,t){var n=this.environment;if(!e)throw new Error("Missing or empty first param on widget.mutate");if(!n||!n.mutate)throw new Error("Current Environment do not support widget.mutate");n.mutate(e,t)},getUrl:function(){var e=window.location.href;return this.uwaUrl?this.uwaUrl:h.getQueryString(e,"uwaUrl",e)},addStar:function(e){var t=this.environment;t&&t.addStar&&t.addStar(e)},getViewportDimensions:function(){var e,t,n=this.elements,i=n.body,r=d.getDimensions,s=d.isInjected,a=d.getComputedSize,o=u.getSize(),h=r.call(n.wrapper),l=r.call(i),c=o.height,f=h.width;["header","footer"].forEach(function(t){(e=n[t])&&s.call(e)&&(c-=r.call(e).outerHeight)}),e=i,t=n.wrapper.parentNode;do{e!==n.wrapper?f-=a.call(e,"innerWidth","outerWidth"):f-=a.call(e,"innerWidth"),c-=a.call(e,"innerHeight","outerHeight"),e=e.parentNode}while(e&&e!==t);return l.maxHeight>0&&c>l.maxHeight?c=l.maxHeight:l.minHeight>0&&c<l.minHeight&&(c=l.minHeight),{height:c<0?240+c:c,width:f<0?320+f:f}},setPlugins:function(e){this.plugins=e},initPlugins:function(){var t,n,i,r=e.clone(this.plugins);for(t=0,n=r.length;t<n;t++)i=r[t],e.Plugins[i.name]&&(i.instance=new e.Plugins[i.name](this,i.options))},initPreferences:function(){this.setPreferences(this.preferences)},hasPreferences:function(){var e=this.preferences;return!this.readOnly&&e.length>0&&e.some(function(e){return"hidden"!==e.type})},_getRawPreference:function(e){return n.detect(this.preferences,function(t){return t.name===e})},getPreference:function(t){var n=this._getRawPreference(t);return n&&((n=e.clone(n)).value=this.getValue(t)),n},hasPreference:function(e){return this.preferences.some(function(t){return t.name===e})},addPreference:function(){var t=["hidden","text","list","checklist","range","password","boolean"];return function(n){var i,r=-1,s=this.preferences;(function(e){return e.name&&e.type&&-1!==t.indexOf(e.type)})(n)&&(i=void 0!==(n=e.clone(n)).defaultValue,n.multiple&&"boolean"!=typeof n.multiple&&(n.multiple="true"===n.multiple),i&&(n.defaultValue=f(n,n.defaultValue)),s.forEach(function(e,t){n.name===e.name&&(r=t)}),n.label||(n.label=n.name),-1!==r?s[r]=n:s.push(n),this.defaultData[n.name]=n.defaultValue,this.launched&&this.dispatchEvent("onUpdatePreferences",[this.getPreferences()]))}}(),setPreferences:function(e){var t,n;for(this.preferences=[],this.defaultData={},this.launched&&0===e.length&&this.dispatchEvent("onUpdatePreferences",[this.getPreferences()]),t=0,n=e.length;t<n;t++)this.addPreference(e[t])},mergePreferences:function(e){var t,n;for(t=0,n=e.length;t<n;t++)this.hasPreference(e[t].name)||this.addPreference(e[t])},getPreferences:function(){var t,n,i,r,s,a,o=e.clone(this.preferences);for(t=0,n=o.length;t<n;t++)if((s=o[t]).value=this.getValue(s.name),s.label=e.i18n(s.label),e.is(s.options,"array"))for(i=0,r=s.options.length;i<r;i++)(a=s.options[i]).label=e.i18n(a.label);return o},getValue:function(t){var n=this.environment,i=this.data[t];return!e.is(i)&&n&&n.getData&&(i=f(this._getRawPreference(t),n.getData(t))),e.is(i)||(i=this.defaultData[t]),e.is(i)?this.data[t]=i:(i=void 0,delete this.data[t]),i},getInt:function(e){var t=this.getValue(e);return t="true"===t||!0===t?1:parseInt(t,10),isNaN(t)?0:t},getBool:(m=[1,"1","true",!0],function(e){return-1!==m.indexOf(this.getValue(e))}),setValue:function(t,n){var i=this.environment,r=this._getRawPreference(t),s=!0;return n=f(r,n),e.equals(this.data[t],n)||(e.is(n)?(n=e.clone(n),this.data[t]=n,i&&i.setData&&i.setData(t,function(e,t){return e&&(e.multiple||"checklist"===e.type)&&(c(t),t=JSON.stringify(t)),t}(r,n),!!r&&e.equals(r.defaultValue,n))):(this.data.hasOwnProperty(t)?delete this.data[t]:s=!1,i&&i.deleteData?i.deleteData(t):i&&i.setData&&i.setData(t,void 0)),s&&this.dispatchEvent("onUpdateValue",[t,n])),n},setValues:function(e){var t;for(t in e)e.hasOwnProperty(t)&&this.setValue(t,e[t])},deleteValue:function(e){return this.setValue(e)},toggleEdit:function(){this.dispatchEvent(this.isEdit?"endEdit":"onEdit")},dispatchEvent:function(e,t,n,i){var r=this.environment,s=!i&&r||"onLoad"===e||this.launched;return!i&&r?r.dispatchEvent(e,t,n):s&&this._parent(e,t,n),this},addEvent:function(e,t,n,i){var r=this,s="onLoad"===e&&r.launched;return r._parent(e,t,n,i),s&&(r.addEventOnce("_onLoadImmediate",t,n,i),this.setImmediate("_onLoadImmediate",function(){r.dispatchEvent("_onLoadImmediate")})),r},addEventOnce:function(e,t,n,i){var r=this;return"onLoad"===e&&r.launched?(r.addEventOnce("_onLoadImmediate",t,n,i),this.setImmediate("_onLoadImmediate",function(){r.dispatchEvent("_onLoadImmediate")})):r._parent(e,t,n,i),r},requestView:function(t){return e.is(t,"string")&&(t={type:t}),this.dispatchEvent("onViewRequest",[t]),this},getView:function(){return this._view||{type:"windowed"}},getAvailableViews:function(){var e=this.metas.availableViews||"";return n.invoke(e.split(";"),"trim").filter(function(e){return e}).map(function(e){var t,n=e.match(/\S*/)[0],i=e.slice(n.length).trim();if(i)try{t=JSON.parse(i)}catch(e){this.log("Failed to parse availableViews options")}return t||(t={}),t.type=n,t},this)},onEdit:function(){this.isEdit=!0},endEdit:function(){this.isEdit=!1}});return e.namespace("Widget",p,e)});