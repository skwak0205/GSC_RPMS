define("DS/DMUReadPersistence/DMUReadPersistence",[],function(){}),define("DS/DMUReadPersistence/DMUReadServices",["require","exports","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPImportServices"],function(e,t,n,o){"use strict";return class{static importModel(e){if(e&&"object"==typeof e&&e.dataJson&&"object"==typeof e.dataJson&&e.dataJson.Model&&"object"==typeof e.dataJson.Model){let t=n.getReviewContext({viewer:e.viewer}),a=new o({viewer:e.viewer,experience:t,appType:e.appType,markupRepRef:e.mkpRepRef});a.importDataModel(e.dataJson,function(t){a.postImport(),e.onImportCompleted&&e.onImportCompleted(t)})}else e.onImportFailed&&e.onImportFailed()}}}),define("DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting",["UWA/Core","UWA/Class","UWA/Class/Options","DS/Logger/Logger","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/WAFData/WAFData","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices"],function(e,t,n,o,a,r,i,s){"use strict";var l=t.singleton(n,{init:function(){var t=o.getLogger(l);t.log("init"),this.setOptions({navigate_opts:{timeout:2e4}});var n=this,d=!1;function c(e){if(null===e&&void 0===e)return"";var t="";if(Array.isArray(e))for(var n=e.length/2,o=0;o<n;o++)t+=0===o?"?":"&",t+=e[2*o]+"="+e[2*o+1];return encodeURI(t)}this.sendWebServiceCall=function(o){if(o){if(!d)return s=function(){n.sendWebServiceCall(o)},l=o.onFailure,t.log("app_initialization"),void a.getPlatformServices({onComplete:function(e){n.setOption("platform_services",e),d=!0,s()},onFailure:function(){t.warn("Cannot retrieve the Platform Services"),d=!0,l()}});var s,l;if(Array.isArray(n.getOption("platform_services"))){var u=e.clone(o.config,!1);u.onComplete=o.onSuccess,u.onFailure=o.onFailure,u.method=u.verb,u.headers={Accept:"application/json","Content-Type":"application/json","Accept-Language":o.platform?o.platform.getLang():i.getSetting("lang"),SecurityContext:o.platform?o.platform.getSecurityContext():i.getSetting("pad_security_ctx")},"object"==typeof u.data&&(u.data=JSON.stringify(u.data));var p=[];p.push("securityContext"),p.push(o.platform?o.platform.getSecurityContext():i.getSetting("pad_security_ctx")),p.push("tenant"),p.push(o.platform?o.platform.getPlatformId():n.getOption("platform_services")[function(){var t,o=n.getOption("platform_services"),a=n.getTenant();if(e.is(a)){var r=a.value?a.value:a;if(Array.isArray(n.getOption("platform_services")))for(var i=0;i<o.length&&!e.is(t);i++)o[i].platformId===r&&(t=i)}return e.is(t)||(window.console.warn("Tenant not found => Tenant idx by default is 0"),t=0),t}()].platformId),r.authenticatedRequest(o.platform?o.platform.get3DSpaceUrl()+"/"+o.url+c(p):n.get3DSpaceUrl()+"/"+o.url+c(p),u)}else o.onFailure&&o.onFailure()}},this.getServerContext=function(e){if(!e||"function"!=typeof e.onComplete||"function"!=typeof e.onFailure)return;let t=i.getSetting("pad_security_ctx");t?e.onComplete(t):e.onFailure()},this.get3DSpaceUrl=function(){return s.get3DSpaceUrl()},this.getTenant=function(){return i.getSetting("x3dPlatformId")}},doInitialize:function(){}});return l.doInitialize(),l}),define("DS/DMUReadPersistence/DMUPasswordDialog",["UWA/Core","UWA/Class","DS/Windows/Dialog","DS/Controls/Button","DS/Utilities/TouchUtils","DS/Controls/LineEditor","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"],function(e,t,n,o,a,r,i){"use strict";return t.extend({init:function(t){this._parent(t);var s,l,d,c=(t||{}).ctxViewer;this.build=function(t,u){if(!s){var p=e.createElement("div",{id:"DMUPasswordDialogContent"});e.createElement("p",{id:"DMUPasswordDialogDescription",text:i.documentPasswordMessage}).inject(p);var f=e.createElement("div",{styles:{display:"flex","justify-content":"space-evenly","align-items":"center"}}).inject(p);l=new r({placeholder:i.documentPassword,selectAllOnFocus:!0,displayStyle:"password"}).inject(f);var m=new o({label:"Display Password",showLabelFlag:!1,icon:{iconName:"eye",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"1x"},type:"check",displayStyle:"icon"}).inject(f);m.getContent().setStyle("margin-left","10px"),d=e.createElement("p",{styles:{color:"#EA4F37",margin:"5px"}}).inject(p),m.getContent().addEventListener("change",function(){m.checkFlag?(m.setProperties({icon:{iconName:"eye-off",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"1x"}}),l.displayStyle="text"):(m.setProperties({icon:{iconName:"eye",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"1x"}}),l.displayStyle="password")});var g={Ok:new o({emphasize:"primary",label:"OK",onClick:function(){l.value?(l.disabled=!0,d.innerText="",g.Ok.disabled=!0,t(l.value)):d.innerText=i.documentPasswordRequired}}),Cancel:new o({label:"Cancel",onClick:u})};l.addEventListener("uncommittedChange",function(){d&&d.innerText&&(d.innerText="")}),s=new n({modalFlag:!0,ensureHeightDefinitionOnHierarchy:!0,title:i.documentPasswordRequired,content:p,closeButtonFlag:!1,position:a.getTouchMode()?{my:"center bottom"}:void 0,immersiveFrame:c.getFrameWindow().getImmersiveFrame(),buttons:g})}},this.onIncorrectPassword=function(){s&&l&&(l.disabled=!1,s.buttons.Ok.disabled=!1,d.innerText=i.documentIncorrectPassword)},this.getValue=function(){return l?l.value:""},this.close=function(){c&&(s&&s.close(),c=s=null,l=null,d=null)}}})}),define("DS/DMUReadPersistence/DMUXCADSupport",["UWA/Core","DS/WebUtils/WebServices","DS/WebUtils/Network","DS/Logger/Logger","DS/WAFData/WAFData","DS/WebSystem/Environment","DS/CSICommandBinder/CSICommandBinder","DS/SPAContentOptimizer/ConvertV1","DS/SPAContentOptimizer/COConvertOption","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"],function(e,t,n,o,a,r,i,s,l,d){"use strict";var c={},u={},p=o.getLogger("DS/DMUReadPersistence/DMUXCADSupport");p.log("init");var f=0;return{returnSpaConvertUri:function(t){var n=e.Utils.parseUrl(t);return n.authority+n.directoryPath},execConvertCmd:function(t,n){var o=t.asset;!function(){var a,r=new s(n);r.onResultFile=function(n,a){if(p.log("launchConvert.onResultFile",n),"Success"!==n||!a)return!0;var r=new Blob([a]),i=e.clone(o);t.onConvertSuccess(e.extend(i,{provider:"FILE",filename:window.URL.createObjectURL(r),proxyurl:"none",requiredAuth:null,serverurl:"",originalType:o.type,mimetype:o.dataFormat||o.mimetype,format:o.dataFormat||o.mimetype,type:o.dataFormat||o.mimetype}))},r.onErrors=function(e){if(p.error("Conversion error"),e&&e[0]&&e[0].split("\n")){var n=e[0].split("\n");"Please check the documentation for supported file versions and resave the file in one of supported versions if possible"===n[2]?(p.error(e),this.onErrorsVisited=!0):"InterOp Diagnostic: The input Parasolid file is Bare binary file which is an unsupported format."===n[1]?(p.error(e),this.onErrorsVisited=!0):"Error : The input file is saved in Civil3D. Output might be incomplete."===n[0]&&p.warn(e)}t.onConvertError(d.contentOptimizerNotSupport)},r.onMissingFiles=function(e){p.error("Missing Files domain"),p.error(e),t.onConvertError&&t.onConvertError()},r.onProgress=function(e){p.log("launchConvert.onProgress",e)},t.ConversionOpts&&(a=new l,Object.keys(t.ConversionOpts).forEach(function(e){void 0!==t.ConversionOpts[e]&&a["Set"+e](t.ConversionOpts[e])}));var i=o.url,c=o.filename;p.log("_execConvertCmd.convertUrl",c,i,o.dataFormat,a),r.convertUrl(c,i,o.dataFormat,a)}()},startConvert:function(e){var o=this,a=e.asset,r="Not initialized";new Promise(function(n){t.getServiceUrl({serviceName:"SPAContentOptimizer",logger:p,platformId:a.tenant,onSuccess:function(e){c[a.tenant]=o.returnSpaConvertUri(e.url),n()},onError:function(t){p.error("Ooops, missing Service : ",t.serviceName,"Reason : ",t.error),e.onConvertError("Missing Service")}})}).then(function(){var t=!1,s={onHypervisorDisconnect:function(){p.log("XCADSpatialSupport._startConvert: CSIServer Hypervisor Disconnected"),t?t=!1:(p.error("Unable to connect"),e.onConvertError(e.asset))},onHypervisorConnect:function(){t=!0,p.log("CSIServer Connected")},onDisconnect:function(){p.log("CSIServer Node Disconnected")},authentication:function(e,t,o){var a=encodeURIComponent(r).replace(/'/g,"%27").replace(/"/g,"%22");n.authenticatedRequest(e.passportURL+"/login?service="+a,{method:"GET",headers:{Accept:"application/json"},onComplete:function(e){try{var n=JSON.parse(e).access_token;t(r,n)}catch(e){o("Failed to parse ticket")}},onFailure:function(e,t){o("Failed to retrieve ticket"),p.log("CSIServer authentication onFailure"),p.error("Failed to retrieve ticket: "+t+e)}})}},l=c[a.tenant];""!==l&&void 0!==l&&(s.hypervisorUrl=l,s.ssl=!0,r="https://"+s.hypervisorUrl);var d=i.getPool("application.webWidget").createNode(s),u=d.select("ContentOptimizer");o.execConvertCmd(e,d,u)})},startLocate:function(t,n){var o=this,i=t.asset;this.located=!1,p.log("XCADSpatialSupport._startLocate");var s=t.asset.originalAsset.contextid?t.asset.originalAsset.contextid:"preferred";r.get("PreferredCredentials")&&(s=r.get("PreferredCredentials"));var l="/api/v2/modeler/dsdo/DerivedOutputs/locate?withSyncStatus=yes";"EV6"!==t.asset.originalAsset.provider.toUpperCase()&&"3DSPACE"!==t.asset.originalAsset.provider.toUpperCase()||(l+="&SecurityContext="+encodeURIComponent(s)),"asm"===i.dataFormat&&(i.dataFormat="3dxml");var d=u[i.tenant]+l,c={specificationFilter:[{format:i.dataFormat,filterConversionParams:[{key:"streamId",value:"visualization"}]}],referencedObject:[{source:"EV6"===t.asset.originalAsset.provider.toUpperCase()?"3DSpace":t.computedInfos.provider,id:t.asset.originalAsset.physicalid,type:t.asset.originalAsset.type}]};!0===n&&(c.specificationFilter[0].notifyIfMissing=!0),a.authenticatedRequest(d,{method:"POST",headers:{"Content-Type":"application/json",SecurityContext:s},type:"json",data:JSON.stringify(c),onComplete:function(n){if(console.log("onComplete locate"),n.derivedOutputs&&n.derivedOutputs[0]&&n.derivedOutputs[0].derivedOutputFormats&&n.derivedOutputs[0].derivedOutputFormats[0]&&n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult&&!0===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.isSync&&"OK"===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.status){f=0;var r=u[i.tenant]+"/api/v2/modeler/dsdo/DerivedOutputs/"+n.derivedOutputs[0].id+"/DerivedOutputFiles/"+n.derivedOutputs[0].derivedOutputFormats[0].id+"/DownloadTicket";a.authenticatedRequest(r,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(n){console.log("onComplete download ticket");var o=n.data[0].dataelements,a=o.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(o.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true",r=e.clone(i);t.onConvertSuccess(e.extend(r,{provider:"FILE",filename:a,proxyurl:"none",requiredAuth:null,serverurl:"",originalType:i.type,mimetype:i.dataFormat||i.mimetype,format:i.dataFormat||i.mimetype,type:i.dataFormat||i.mimetype})),console.log("Loading from DFA : "+a)},onFailure:function(e){console.log("onFailure download ticket"+e)}})}else if(f<=10){var s=f++<5?1e3:3e3;console.log(" restart locate in "+s+" ms"),setTimeout(o.startLocate.bind(o,t,!1),s)}else console.log("locate service is not available")},onFailure:function(e){console.log("onFailure locate"+e)}})},convertDFA:function(e){var n=this,o=e.asset;t.getServiceUrl({serviceName:"derivedformataccess",logger:p,platformId:o.tenant,onSuccess:function(t){u[o.tenant]||(u[o.tenant]=t.url),t.platformId!==o.tenant&&p.warn("DerivedFileAccess desired Tenant:",o.tenant,"got ",t.platformId),p.log("DerivedFileAccess : URL found > ",u[o.tenant]),n.startLocate(e,!0),n=null},onError:function(t){p.error("Ooops, missing Service : ",t.serviceName,"Reason : ",t.error),e.onConvertError("Missing Service"),n=null}})}}}),define("DS/DMUReadPersistence/DMUReviewPersistenceServices",["UWA/Class","DS/WAFData/WAFData","DS/DMUBaseExperience/EXPUtils","DS/PlatformAPI/PlatformAPI","DS/3DSpaceDocumentConnector/3DSpaceDocumentConnector","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/DocumentManagement/DocumentManagement","DS/VisuDataAccess/Ox4StreamLoader","UWA/Utils"],function(e,t,n,o,a,r,i,s,l){"use strict";return e.extend({init:function(){let e=!0;var d=new a;this.updateReviewAndJSONFile=function(e,t,n){r.getServerContext({onComplete:function(o){var a=e.markupName,s=e.markupType,l=(new Date).getTime(),d="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(l+16*Math.random())%16|0;return l=Math.floor(l/16),("x"===e?t:3&t|8).toString(16)}),c=new Blob([JSON.stringify(e.json)],{type:"application/json"}),u=null;c&&((u=c).name=d,u.fileName=d);var p={fileInfo:{file:u,title:d,newFile:e.newFile,fileName:d},id:e.reviewPhysicalId},f={onComplete:function(e){t&&t({reviewId:e.data[0].id,reviewName:a,reviewType:s})},onFailure:function(){n&&n({reviewName:a,reviewType:s})},securityContext:o,tenant:r.getTenant(),tenantUrl:r.get3DSpaceUrl()};i.modifyDocument(p,f)},onFailure:n})},this.updateMarkupStream=function(e,t,n){var o,a=e.markupName,i=e.markupType,s=new Blob([e.json],{type:"application/json"}),d=l.getUUID().toString();(o="DMUMarkupRepReference",new Promise(function(e){r.sendWebServiceCall({url:"resources/markup/service/getCheckinTicket",config:{verb:"POST",data:JSON.stringify({sObjectType:o})},onSuccess:function(t){e(t?JSON.parse(t):{})}})})).then(function(o){var l,c=o.checkinTicket,u=o.actionURL;c&&u&&(l={file:s,ticket:c,URL:u,correlationId:d,fileName:"WebReviewContent.json"},new Promise(function(e){var t=new FormData;t.append("__fcs__jobTicket",l.ticket),t.append("file_0",l.file,l.fileName);var n=new XMLHttpRequest;n.open("POST",l.URL,!0),n.onload=function(){200===n.status&&e(n.responseText)},n.send(t)})).then(function(o){var s=o;s&&function(e){return new Promise(function(t){r.sendWebServiceCall({url:"resources/markup/service/checkinStreamInfo",config:{verb:"POST",data:JSON.stringify({sObjectId:e.ObjectId,sReceipt:e.receipt,sJsonStream:e.stream,sFileName:e.fileName,sPersistencyType:e.persistencyType,sPersistencyName:e.persistencyName})},onSuccess:function(e){t(e?JSON.parse(e):{})}})})}({ObjectId:e.reviewPhysicalId,receipt:s,stream:e.json,fileName:"WebReviewContent.json",persistencyName:"WebReviewContent",persistencyType:"json"}).then(function(o){o&&!o.error?t&&t({reviewId:e.reviewPhysicalId,reviewName:a,reviewType:i}):n()})})})},this.getDnDReviewAndJSONFile=function(e,a,s){e.serverurl||(e.serverurl=r.get3DSpaceUrl()),e.tenant||(e.tenant=r.getTenant()),r.getServerContext({onComplete:function(r){var l={onComplete:function(r){!function(e,a,r){var i=e?e.MarkupReservedby:null;if(null!==i&&d){var s=e.MarkupID,l=e.MarkupType,c=e.MarkupName?e.MarkupName:e.MarkupTitle,u=e.MarkupDescription,p={onComplete:function(e){var d={url:e[0].downloadUrl,responseType:"json",onComplete:function(e){var t={reviewPid:s,reviewType:l,reviewName:c,reviewDescription:u,jsonObj:JSON.parse(n.cleanJSONString(e)),modifiable:!i||""===i||i===o.getUser().login};a(t),window.widget&&window.widget.dispatchEvent("onDMUMarkupLoaded",s)},onFailure:r};t.request(d.url,{responseType:d.responseType,method:"GET",onComplete:d.onComplete,onFailure:d.onFailure,timeout:0})},onFailure:r};d.downloadDocuments([e.MarkupID],p)}else r()}({MarkupID:e.markupId,MarkupType:e.markupType,MarkupJsonFileID:r&&r.data&&r.data.length&&r.data[0].relateddata&&r.data[0].relateddata.files&&r.data[0].relateddata.files.length?r.data[0].relateddata.files[0].id:void 0,MarkupReservedby:r&&r.data&&r.data.length&&r.data[0].dataelements?r.data[0].dataelements.reservedby:null,MarkupName:r&&r.data&&r.data.length&&r.data[0].dataelements?r.data[0].dataelements.title:null,MarkupDescription:r&&r.data&&r.data.length&&r.data[0].dataelements?r.data[0].dataelements.description:null},a,s)},onFailure:s,securityContext:r,additionalURLParams:"$include=parents",tenantUrl:e.serverurl,tenant:e.tenant,relInfo:{parentRelName:"Markup",parentDirection:"from"}};i.getDocuments([e.markupId],l)},onFailure:s})},this.getProductByMarkerId=function(e,t,n){e&&e.physicalid&&(e.serverurl||(e.serverurl=r.get3DSpaceUrl()),e.tenant||(e.tenant=r.getTenant()),r.getServerContext({onComplete:function(o){var a={onComplete:function(e){if(0===e.data.length)n(e);else{var o={MarkupContext:{}};e.data[0].relateddata.parents&&e.data[0].relateddata.parents.length?o.MarkupContext.contexts=e.data[0].relateddata.parents:e.data[0].dataelements&&e.data[0].dataelements.parentId&&(o.MarkupContext.contexts=[],o.MarkupContext.contexts.push({id:e.data[0].dataelements.parentId})),t(o)}},onFailure:n,securityContext:o,tenantUrl:e.serverurl,tenant:e.tenant,additionalURLParams:"$include=parents",relInfo:{parentRelName:"Markup",parentDirection:"from"}};i.getDocuments([e.physicalid],a)},onFailure:n}))},this.getMarkupInfos=function(t,n,a){t&&t.physicalid&&r.sendWebServiceCall({url:"resources/markup/service/getMarkup",config:{verb:"POST",data:JSON.stringify({sMarkupId:t.physicalid})},onSuccess:function(t){if(t){let a=JSON.parse(t);if(n(a),a.reservedby){let t=a.reservedby;e=!t||""===t||t===o.getUser().login}else e=!0}else n({})},onFailure:a})},this.getMarkupStream=function(t,o,a){var i={IRPC:!0,serverUrl:r.get3DSpaceUrl(),physicalid:t.markupId,boType:"DMUMarkupRepReference",format:"1",persistancyType:"json",streamType:"string",onStreamLoaded:function(a){window.console.log("getMarkupJson::success:"+a.byteLength),o({jsonObj:JSON.parse(n.cleanJSONString(a)),reviewPid:t.markupId,reviewType:t.markupType,reviewName:t.markupTitle,owner:t.markupOwner,modifiable:e})},onError:function(e){window.console.log("getMarkupJson::erreur:"+e),a(e="NOSTREAM")}};s.Load(i)}}})}),define("DS/DMUReadPersistence/DMUWebServicesUtils",["UWA/Class","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting"],function(e,t){"use strict";return e.singleton({init:function(){},getParentTypes:function(e){return new Promise((n,o)=>{t.sendWebServiceCall({url:"resources/markup/service/getParentTypes",config:{verb:"POST",data:JSON.stringify({sType:e})},onSuccess:function(e){let t=JSON.parse(e);n(t.parentTypes)},onFailure:function(e){o(e)}})})}})}),define("DS/DMUReadPersistence/DMULoadingContextController",["UWA/Class","DS/DMUBaseExperience/DMUContextManager","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DocumentManagement/DocumentManagement","DS/DMUControls/EXPNotify","DS/DMUControls/panels/DMUDocumentPanel","DS/PADUtils/views/PADProgressBar","DS/DMUReadPersistence/DMUPasswordDialog","DS/DMUBaseExperience/EXPManagerSet","DS/CoreEvents/ModelEvents","DS/ApplicationFrame/CommandsManager","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/DMUBaseUIControllers/DMU2DSheetManager","DS/WAFData/WAFData","DS/DMUBaseExperience/EXPToolsContext","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"],function(e,t,n,o,a,r,i,s,l,d,c,u,p,f,m,g,v){"use strict";let D={isr:"DS/PIMwebViewController/PIMwebItfCtrl",difAnnotSet:"DS/CAT3DAnnotControllerForReview/CATDIFAnnotSetLoader",msr:"DS/SMAMpw3DMarkupImpl/SMAMpwMSRLoadCtrl"},h=e.extend({init:function(e){this._parent(e);let h,I,S,y,C,M,b,w,x,P,R,F=this,k=(e||{}).ctxViewer,T=null,U=null,O={},L={},j=new d,A=null,N=null,E=!0,V=t.getEventsController({viewer:k.getViewer()}),_=null,W={icon:null,title:null},q=null,J=!0,B=null,K=[],X=["doc","docx","docm","dot","dotm","dotx","rtf","ppt","pptx","pot","potm","potx","pps","ppsm","ppsx","pptm"];function G(e,t,n){I&&I.destroy(),I=new a({body:k.getFrameWindow().getUIFrame(),type:e,message:t}),"successful"===n&&F.publish("on2DDocumentLoadSuccess")}function z(e){let t;b&&(b.close(),b=null),k.removeRoots({pids:[S]}),e&&"InvalidPDFException"===e.name&&(t=v.documentNotSupported),k.displayNotification({msg:t||v.documentLoadKO,eventID:"error"}),S=null;let n=i._counter;for(let e=0;e<n;e++)i.off();F.publish("onDocumentLoadFailure")}function H(){let e=i._counter;for(let t=0;t<e;t++)i.off();G("info","Document"===(n.getNodeType(k.getRootBagPath().getChildrenPathes()[0])?n.getNodeType(k.getRootBagPath().getChildrenPathes()[0].getLastElement(!0)):null)||"Document"===B?v.documentLoadCancel:v.requirementLoadCancel);let t=c.getCommand("CleanAll",k.getCommandContext());t&&t.begin()}function $(e,t){return new Promise(n=>{x&&x[e]?n(x[e]):m.authenticatedRequest(t,{proxy:"none",type:"blob",timeout:18e4,onComplete:function(t){let o=new FileReader;o.onload=function(){x||(x={}),x[e]=o.result,n(x[e])},o.readAsDataURL(t)},onFailure:function(){n(t)},onTimeout:function(){n(t)}})})}function Q(){let e=t.giveEventsController({viewer:k.getViewer()});e&&e.fireEvent("onLoadedReviewContext",{rootType:A})}const Y=function(e){let t=document.createElement("textarea");return t.innerText=e,t.innerHTML};async function Z(e){let t="Requirement Specification"===e.parentElement.type?[]:[e.parentElement],n=[],o=[],a=function(e){let t="";for(let o=1;o<=e&&n[o];o++)1!==o&&(t+="."),t+=n[o];return t};for(let r=1;r<e.dataObj.length;r++){const i=e.dataObj[r];g.getParentType(i.type)||g.setParentType(i.type,i["type.kindof"]);let s={phyId:i.physicalid,typeIconUrl:await $(i["type.kindof"],i.type_icon_url),level:parseInt(i.level)};if(o.length-1>s.level&&(o=o.slice(0,s.level+1)),o[i.level]?o[i.level]++:o[i.level]=1,"Chapter"===i["type.kindof"])n[i.level]?n[i.level]++:n[i.level]=1,n.length-1>s.level&&(n=n.slice(0,s.level+1)),s.content=i["attribute[Title]"],s.title=i["attribute[Title]"],s.type=i["type.kindof"],s.chapterLevelTag=a(s.level),s.fontSize=34-2*s.level;else if("Comment"===i["type.kindof"]||"Requirement"===i["type.kindof"]){s.content=i["attribute[Content Data]"],s.title=i["attribute[Title]"],s.type=i["type.kindof"],"1"===i.level?s.chapterLevelTag="0":s.chapterLevelTag=a(s.level-1)||"0";let e="",t=Math.max(0,n.length-1>=s.level?s.level-1:n.length-1);for(let n=t+1;n<=s.level;n++)n!==t+1&&(e+="."),o[n]||(o[n]=1),e+=o[n];s.subLevelTag=e}t.push(s)}x=null;let r=l.getManager({name:"DMU2DSheetManager",context:k.getFrameWindow()});r&&r.loadDocumentStream({documentID:S,type:"Requirement",elementsToLoad:t,fatherNode:k.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),onComplete:function(){h&&h(),M&&M();let e=i._counter;for(let t=0;t<e;t++)i.off();G("info",v.documentLoadOK,"successful"),Q()},onFailure:z})}function ee(e){m.authenticatedRequest(u.get3DSpaceUrl()+"/resources/trm/streaming/structure/"+e.parentElement.phyId,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:e.securityData},timeout:6e4,onComplete:function(t){let n=JSON.parse(t);e.onComplete(n)},onFailure:z,onTimeout:z})}function te(e){let t=p.getSetting("pad_security_ctx");var n,o;i.on(),(n=e.phyID,o=t,new Promise(function(e,t){let a=encodeURI(`${u.get3DSpaceUrl()}/resources/trm/dictionary/info?pid=${n}&select=type,attribute[Content Data],attribute[Title]`);m.authenticatedRequest(a,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:o},timeout:6e4,onComplete:function(t){let o=JSON.parse(t);o&&"success"===o.status&&o.results[0]?e({phyId:n,content:Y(o.results[0]["attribute[Content Data]"]||""),title:o.results[0]["attribute[Title]"],type:o.results[0].type.value}):e({phyId:n})},onFailure:function(){t(new Error("Requirement content Request Failed"))},onTimeout:function(){t(new Error("Requirement content Request Timeout"))}})})).then(function(n){let o={phyId:n.phyId,content:n.content,title:n.title,type:g.getParentType(n.type)?g.getParentType(n.type):n.type};"Requirement"===o.type?k.getController().getAttributes({ids:[e.phyID],attributes:["type_icon_url"],callbacks:{onComplete:function(n){o.level=0,o.chapterLevelTag=0,o.subLevelTag=0,$(o.type,n[e.phyID].type_icon_url).then(e=>{o.typeIconUrl=e,ee({parentElement:o,securityData:t,onComplete:function(e){R=[o.phyId],Z({parentElement:o,dataObj:e})}})})},onFailure:z}}):ee({parentElement:o,securityData:t,onComplete:function(e){R=[o.phyId],e.length>0&&e.forEach(e=>{R.push(e.physicalid)}),Z({parentElement:o,dataObj:e})}})})}function ne(e){let a,d;e.path&&(a=n.getNodeID(e.path.getLastElement(!0)),d=n.getNodeType(e.path.getLastElement(!0))),"Document"===d?function(e){let n,a,d=function(e,t){let o=l.getManager({name:"DMU2DSheetManager",context:k.getFrameWindow()});o||(o=new f({ctxViewer:k}),l.addManager({name:"DMU2DSheetManager",context:k.getFrameWindow(),manager:o})),o&&o.loadDocumentStream({documentID:S,dataBuffer:e,type:"Document",password:t,fatherNode:k.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),onComplete:function(){h&&h(),M&&M();let e=i._counter;for(let t=0;t<e;t++)i.off();G("info",v.documentLoadOK,"successful"),Q()},onPasswordOk:function(){b&&(b.close(),b=null)},onIncorrectPassword:function(){b?b.onIncorrectPassword():(b=new s({ctxViewer:k})).build(function(t){d(e,t)},function(){if(C&&n&&a){b&&(b.close(),b=null);let e=i._counter;for(let t=0;t<e;t++)i.off();C.build(n,a,H)}else H()})},onFailure:z})},g={proxy:"none",type:"arraybuffer",timeout:18e4,onComplete:function(e){d(e)},onFailure:z,onTimeout:z};a=function(n,a){i.on(),y={fileId:n,versions:a},o.downloadDocuments([a[0]],{onComplete:function(n){const o=n[0].fileName.split(".").pop().toLowerCase();if("pdf"===n[0].fileName.split(".").pop().toLowerCase())A="PDF",m.authenticatedRequest(n[0].downloadUrl,g);else if("dxf"===o||"dwg"===o){A=n[0].fileName.split(".").pop().toUpperCase();let o={dataFormat:"udl",dtype:"Document",filename:n[0].fileName,format:n[0].fileName.split(".").pop().toLowerCase(),mimetype:n[0].fileName.split(".").pop().toLowerCase(),provider:"FILE",requestsOptions:{authentication:"passport",proxy:"none",method:"POST"},tenant:p.getSetting("x3dPlatformId"),type:n[0].fileName.split(".").pop().toLowerCase(),url:n[0].downloadUrl};require(["DS/DMUReadPersistence/DMUXCADSupport"],function(n){n.startConvert({asset:o,onConvertError:function(e){if("Missing Service"===e){G("warning",v.documentTypeNotSupported);for(let e=0;e<i._counter;e++)i.off()}else G(e)},onConvertSuccess:function(n){require(["DS/DibUDLWebLoader/DraftingUDLWebLoader"],function(o){if(o){let r=new o;if(r.set3DAccuracy(.001),r.set2DAccuracy(.001),n){let o={provider:"FILE",serverurl:"",proxyurl:"none",requiredAuth:null};o.filename=n.filename;let s={serverUrl:u.get3DSpaceUrl(),securityContext:p.getSetting("pad_security_ctx"),UDLObjURL:o,onComplete:function(n){P=n;let o=k.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),s=l.getManager({name:"DMU2DSheetManager",context:k.getFrameWindow()});s||(s=new f({ctxViewer:k}),l.addManager({name:"DMU2DSheetManager",context:k.getFrameWindow(),manager:s}));let d=[];for(let t=0;t<n.sheetIDList.length;t++)d.push({modelID:n.sheetIDList[t],sheetID:"Drw."+e.phyID+"_"+n.sheetIDList[t],label:r.getSheetName(n.sheetIDList[t])});s.load2DDocument({loadedSheetInformations:n,phyID:a[0],dataType:"DXF/DWG",sheetNodes:d,parentNode:o,getSheet3DNode:function(e){let t=r.getSheetBackgroundColor(e.modelID);r.getSheet3DNode({sheetID:e.modelID,onSheetNodeCreated:function(n){o.addChild(n),k.getViewer().render(),e.cb(t)},onSheetLoaded:function(){e.noUdlMessage.includes(e.sheetID)&&e.noUdlWarningMessage(),r.setSheetPickingByView({sheetID:e.modelID,pickingByView:!0}),k.getViewer().render(),k.getViewpoint().reframe(),e.end();for(let e=0;e<i._counter;e++)i.off()},onFailure:function(){e.noUdlMessage.push(e.sheetID),e.noUdlWarningMessage(),e.end()}})},onComplete:function(){for(let e=0;e<i._counter;e++)i.off();h&&h();let e=t.giveEventsController({viewer:k.getViewer()});e&&e.fireEvent("onDXFLoadSuccess"),M&&M(),Q()},onFailure:function(){k.removeRoots({pids:[o]}),k.displayNotification({msg:v.fileWithNoSVG,eventID:"error"}),F.publish("on2DDocumentLoadFailure")}})},onFailure:function(){window.console.log("Unexpected error!! Failed to Load UDL via _UDLLoader.loadModel!!")}};r&&r.loadModel(s)}}})}})})}else if(X.includes(o.toLowerCase())){A=n[0].fileName.split(".").pop().toUpperCase();let e={ConversionOpts:{},dataFormat:"pdf",dtype:"Document",filename:n[0].fileName,format:n[0].fileName.split(".").pop().toLowerCase(),mimetype:n[0].fileName.split(".").pop().toLowerCase(),provider:"FILE",requestsOptions:{authentication:"passport",proxy:"none",method:"POST"},originalAsset:{contextid:"ctx::VPLMProjectLeader.Company Name.Common Space",displayname:n[0].fileName,dtype:"Document",physicalid:S,provider:"EV6",requiredAuth:"passport",serverurl:u.get3DSpaceUrl(),serviceId:"3DSpace",tenant:p.getSetting("x3dPlatformId"),type:"Document"},tenant:p.getSetting("x3dPlatformId"),type:n[0].fileName.split(".").pop().toLowerCase(),url:n[0].downloadUrl};require(["DS/DMUReadPersistence/DMUXCADSupport"],function(t){t.convertDFA({asset:e,onConvertError:function(e){if("Missing Service"===e){G("warning",v.documentTypeNotSupported);for(let e=0;e<i._counter;e++)i.off()}else G(e)},onConvertSuccess:function(e){let t={proxy:"none",type:"arraybuffer",timeout:18e4,onComplete:function(e){d(e)},onFailure:z,onTimeout:z};m.authenticatedRequest(e.filename,t)}})})}else G("error",v.documentNotSupported)}})};let D={onComplete:function(e){if(e&&e.data&&e.data[0]&&e.data[0].relateddata.files){W.icon=e.data[0].dataelements.typeicon?e.data[0].dataelements.typeicon:null,W.title=e.data[0].dataelements.title?e.data[0].dataelements.title:null;let o=t.giveEventsController({viewer:k.getViewer()});o&&o.fireEvent("onGetDocumentsCompleted");let s=["pdf","dxf","dwg"].concat(X);if(T){let t,o,l,d,c={},u=[];if(T&&(t=0),e.data[0].relateddata.files.forEach(function(e){-1!==s.indexOf(e.dataelements.title.split(".").pop().toLowerCase())&&e.dataelements.title.split(".").pop().toUpperCase()===N&&(c.versions=[],c.versions.push(e.id),e.relateddata.versions.length&&e.relateddata.versions.forEach(function(e){c.versions.push(e.id)}),c.fileId=e.relId,T&&T===e.relId&&(t++,o=e.dataelements.title.split(".").pop().toLowerCase(),l=e.dataelements.title,d=c.versions),c.title=e.dataelements.title,c.creationDate=new Date(e.dataelements.originated),c.modifiedDate=new Date(e.dataelements.modified),u.push(c),c={})}),!t&&e.data[0].relateddata.files.length>0)if("X3DPLAW_AP"===U)G("error",v.documentDeleted);else{w="delete";let e=i._counter;for(let t=0;t<e;t++)i.off();n={title:v.documentPanel.deleteFile,data:u,mode:"delete"},C||(C=new r({immersiveFrame:k.getFrameWindow().getImmersiveFrame()})),C.build(n,a,H)}else e.data[0].relateddata.files.length?t&&X.includes(o)&&e.data[0].relateddata.files.length>1?(k.displayNotification({msg:`${v.markupDocmultioffice} ${l}`,eventID:"error"}),H()):(w="normal",a(T,d)):(k.displayNotification({msg:v.documentNofile,eventID:"warning"}),H())}else if(1===e.data[0].relateddata.files.length)if(-1===s.indexOf(e.data[0].relateddata.files[0].dataelements.title.split(".").pop().toLowerCase())){G("warning",v.documentTypeNotSupported);let e=c.getCommand("CleanAll",k.getCommandContext());e&&e.begin()}else{let t,n=[];e.data[0].relateddata.files[0].relateddata.versions.length?(t=e.data[0].relateddata.files[0].relId,n.push(e.data[0].relateddata.files[0].id),e.data[0].relateddata.files[0].relateddata.versions.forEach(function(e){n.push(e.id)})):(t=e.data[0].relateddata.files[0].relId,n.push(e.data[0].relateddata.files[0].id)),a(t,n)}else{let t={},o=[],i=0,s=0;e.data[0].relateddata.files.forEach(function(e){-1!==["pdf","dxf","dwg"].indexOf(e.dataelements.title.split(".").pop().toLowerCase())?(i++,t.versions=[],t.versions.push(e.id),e.relateddata.versions.length&&e.relateddata.versions.forEach(function(e){t.versions.push(e.id)}),t.fileId=e.relId,t.title=e.dataelements.title,t.creationDate=new Date(e.dataelements.originated),t.modifiedDate=new Date(e.dataelements.modified),o.push(t),t={}):X.includes(e.dataelements.title.split(".").pop().toLowerCase())&&(s++,i++)}),!i&&e.data[0].relateddata.files.length>0?G("warning",v.documentTypeNotSupported):e.data[0].relateddata.files.length?s===i?G("warning",v.documentMultiOfficeNotSupported):(n={title:v.documentPanel.selectFile,data:o,mode:"select"},C||(C=new r({immersiveFrame:k.getFrameWindow().getImmersiveFrame()})),C.build(n,a,H)):G("warning",v.documentNofile)}}else z()},onFailure:z,securityContext:p.getSetting("pad_security_ctx"),tenantUrl:u.get3DSpaceUrl(),tenant:p.getSetting("x3dPlatformId"),getVersions:!0};o.getDocuments([e.phyID],D)}({phyID:a}):"Requirement"!==d&&"Requirement Specification"!==d||(te({phyID:a}),A=d)}function oe(e){let t=k.getRootBagPath().getChildrenPathes();if(1===t.length&&h)h();else{if(E){let e=k.subscribe({event:"onRootRemoved"},()=>{k.unsubscribe(e),function(e){_&&e&&e.id===_.objectId?_=null:h&&h()}()})}t.forEach(function(t){n.getNodeID(t.getLastElement(!0))!==e&&k.removeRoots({pids:[n.getNodeID(t.getLastElement(!0))]})})}}function ae(e){let n=e.data.objectType,o=e.data.objectParentType,a=e.data.loadMode,r=e.data.objectId,s=e.data.objectName,d=e.data.serviceId;function c(){k.setAutomaticReframePolicy(!1);let e=p.getSetting("enopad3dviewer_lightNodeModel")?[{rootID:r,validForServerCall:!0,structure:{rootStats:{infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:r,"ds6w:type":o,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part","ds6w:label":s,boundingbox:{max:[-1,-1,-1],min:[1,1,1]}},{synthesis:{name:"ProgressiveExpand_FlatSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_OccSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_LeafSynthesis",value:1}}]},infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:r,"ds6w:type":o,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part",nbchildren:"0"}]},refreshDelegationCB:function(){return new Promise(function(e){e()})}}]:[{rootID:r,validForServerCall:!0,structure:{rootId:o,results:[{attributes:[{name:"did",value:r},{name:"physicalid",value:r},{name:"ds6w:type",value:o}]},{path:[r]}]}}];k.loadJSON({data:e})}if(g.getParentType(n)||g.setParentType(n,o),"PLMPIMMetricReference"===o||"SIMItfSimulation"===o)require([D.isr],function(n){let i=n.getLoaderForMarkup({context:k});function s(){if(k.getApplicativeData().getLoadedItfData&&k.getApplicativeData().getLoadedItfData().data.length){let e=k.getApplicativeData().getLoadedItfData();e.data[0].prd&&oe(e.data[0].prd[0])}e.data.cbOK&&e.data.cbOK()}let l=i.subscribe("onDMUCtxtAlreadyLoaded",function(){i.unsubscribe(l),s()}),d=i.subscribe("onDMUCtxtLoadingSuccess",function(){l&&i.unsubscribe(l),i.unsubscribe(d),s(),Q()}),c=t.getReviewContext({context:k});c&&c.getCurrentSessionMarkup()&&"X3DPLAW_AP"!==e.data.appInfo?"SIMItfSimulation"===o?(r===S?A="ITF":_&&_.objectId===r&&(_.type="ITF"),k.getApplicativeData().getLoadedItfData&&k.getApplicativeData().getLoadedItfData().data.length?r===k.getApplicativeData().getLoadedItfData().data[0].isrID?i.load({data:{isrID:[r],loadMode:a}}):(c.getCurrentSessionMarkup().setActiveFlag(!1),i.remove({data:{objectType:"SIMItfSimulation",objectId:k.getApplicativeData().getLoadedItfData().data[0].isrID}}),i.load({data:{isrID:[r],loadMode:a}})):(c.getValidation()||c.getCurrentSessionMarkup().setActiveFlag(!1),i.load({data:{isrID:[r],loadMode:a}}))):(r===S?A="ISR":_&&_.objectId===r&&(_.type="ISR"),i.getIsrPointingToMetric([r]).then(function(e){let t=e[r][0];k.getApplicativeData().getLoadedItfData&&k.getApplicativeData().getLoadedItfData().data.length?t===k.getApplicativeData().getLoadedItfData().data[0].isrID?i.load({data:{metricID:[r]},loadMode:a}):(c.getCurrentSessionMarkup().setActiveFlag(!1),i.remove(k.getApplicativeData().getLoadedItfData().data[0].isrID),i.load({data:{metricID:[r]},loadMode:a})):(c.getValidation()||c.getCurrentSessionMarkup().setActiveFlag(!1),i.load({data:{metricID:[r],loadMode:a}}))})):"SIMItfSimulation"===o?(r===S?A="ITF":_&&_.objectId===r&&(_.type="ITF"),i.load({data:{isrID:[r],loadMode:a}})):(r===S?A="ISR":_&&_.objectId===r&&(_.type="ISR"),i.load({data:{metricID:[r]},loadMode:a}))});else if("DIFLayout"===o||"DIFSheet"===o)require(["DS/DibUDLWebLoader/CATDibUDLWebLoader"],function(t){if(t){let o=new t,a={data:{physicalid:r,dataType:n},contextViewer:k,serverUrl:u.get3DSpaceUrl(),securityContext:p.getSetting("pad_security_ctx"),onComplete:function(t){P=t;let a=l.getManager({name:"DMU2DSheetManager",context:k.getFrameWindow()});a||(a=new f({ctxViewer:k}),l.addManager({name:"DMU2DSheetManager",context:k.getFrameWindow(),manager:a}));let s=[];for(let e=0;e<t.sheetIDList.length;e++)s.push({modelID:t.sheetIDList[e],sheetID:"Drw."+r+"_"+t.sheetIDList[e],label:o.getSheetName(t.sheetIDList[e])});a.load2DDocument({loadedSheetInformations:t,phyID:r,dataType:n,sheetNodes:s,getSheet3DNode:function(e){let t=o.getSheetBackgroundColor(e.modelID);o.setDisplaySheet({sheetID:e.modelID,onSheetNodeCreated:function(){k.getViewer().render(),e.cb(t)},onSheetLoaded:function(){e.noUdlMessage.includes(e.modelID)&&e.noUdlWarningMessage(),_&&r===_.objectId||o.setSheetPickingByView({sheetID:e.modelID,pickingByView:!0}),k.getViewer().render(),_||k.getViewpoint().reframe(),e.end();for(let e=0;e<i._counter;e++)i.off()},onFailure:function(){e.noUdlMessage.push(e.sheetID),e.noUdlWarningMessage(),e.end()}})},onComplete:function(){Q();for(let e=0;e<i._counter;e++)i.off();h&&h(),e.data.cbOK&&e.data.cbOK()},onFailure:function(){k.displayNotification({msg:v.fileWithNoSVG,eventID:"error"}),F.publish("on2DDocumentLoadFailure")}})},onFailure:function(){window.console.log("Unexpected error!! Failed to Load UDL via _UDLLoader.loadModel!!")}};o&&o.loadModel(a)}}),A="FLDiagram",_||oe(r);else if("DIFAnnotationSet"===o)require([D.difAnnotSet],function(t){new t({context:k}).load({id:r}).then(()=>{e.data.cbOK&&e.data.cbOK()})});else if("DesignSight"===o)require([D.msr],e=>{let t=e.getLoaderForMarkup({context:k});t&&J&&(A="MSR",r!==q?(t.load({data:{msrID:r},onComplete:()=>{J=!0,q=r,h&&h();let e=k.subscribe({event:"onRootRemoved"},()=>{k.unsubscribe(e),q&&(q=null)})},onFailure:()=>{J=!0}}),J=!1):k.displayNotification({msg:v.msrAlreayLoaded,eventID:"info"}))}),E=!1,oe(r);else if("Document"===o||"Requirement"===o||"Requirement Specification"===o){if(k.getRootBagPath().getChildrenPathes().length){let e=k.subscribe({event:"onEndRootRemoved"},function(t){k.unsubscribe(e),e=-1,t&&t.ids&&t.ids.includes(S)||c()})}else c();E=!1,oe(r)}else"R2V_FeatureState"===o&&(A="R2V_FeatureState",function(e){return new Promise((t,n)=>{require("DS/WAFData/WAFData").authenticatedRequest(u.getPlatformURL(e.serviceId)+"/enovia/resources/r2v/v1/modeler/featurestate/fetch",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":p.getSetting("lang")},data:JSON.stringify({ids:[e.objectId]}),timeout:6e4,onComplete:function(e){let n=JSON.parse(e);t(n)},onFailure:n,onTimeout:n})})}(m={serviceId:d,objectId:r}).then(e=>{K.push({id:m.objectId,info:e.result})}));var m;let I=t.giveEventsController({viewer:k.getViewer()});I&&I.fireEvent("onLoadedReviewContext",{rootType:o})}this.getLoadedID=function(){return S},this.setLoadedID=function(e){S=e},this.getIsrContext=function(e){return new Promise(function(t){require([D.isr],function(n){n.getLoaderForMarkup({context:k}).getIsrContext(e).then(t)})})},this.load=function(e){U=e.data.appInfo,S=e.data.objectId instanceof Array?e.data.objectId[0]:e.data.objectId,M=e.data.cbOK,T=e.data.fileId;const t=e.data.serviceId;e.data.documentType&&(N=e.data.documentType),B=e.data.objectType,h=e.data.loadMarkup?e.data.loadMarkup:null,ae({data:{appInfo:U,objectId:S,objectType:e.data.objectType,objectParentType:e.data.objectParentType?e.data.objectParentType:e.data.objectType,objectName:e.data.displayName,loadMode:e.data.loadMode,cbOK:M,fileId:T,documentType:N,loadMarkup:h,serviceId:t}})},this.clean=function(e){k&&(b&&(b.close(),b=null),C&&C.destroy(),U=A=C=x=P=R=null,E=!0,e&&(S=null,O.onRootAdded&&k.unsubscribe(O.onRootAdded),O.onRootAdded=null,O.widgetReresh&&k.unsubscribe(O.widgetReresh),O.widgetReresh=null),L={},W={},k.getViewer().render())};this.getLoadMarkupDocumentMode=function(){return w},this.getLoadMarkupCtxType=function(){return A},this.getLoadedSheetInformations=(()=>P),this.getTempObjectInformations=(()=>W),this.getLoadedR2VInformations=(()=>K),this.setLoadedR2VInformations=(e=>{K=e}),this.getDocumentVersionInfos=function(){return y},this.subscribe=function(e,t){if(e&&t&&j)return j.subscribe({event:e},t)},this.unsubscribe=function(e){j&&e&&j.unsubscribe(e)},this.publish=function(e,t){j&&j.publish({event:e,data:t})},L.on2DDocumentLoadRequired=V.addEvent("on2DDocumentLoadRequired",e=>{e&&ae({data:_={objectType:e.documentType,objectId:e.rootID,objectParentType:e.documentType}})}),O.onRootAdded=k.subscribe({event:"onRootAdded"},function(e){ne({path:e.path})}),O.widgetReresh=k.subscribe({event:"widgetReresh"},e=>{"DesignSight"===e.objectType&&(e.objectParentType=e.objectParentType?e.objectParentType:e.objectType,ae({data:e}))}),L.onGetLoadedSheetInformations=V.addEvent("onGetLoadedSheetInformations",e=>{e.cb&&e.cb(P)}),L.onGetLoadedReqSpecInformations=V.addEvent("onGetLoadedReqSpecInformations",e=>{e.cb&&e.cb(R)})}}),I=[];return e.singleton({init:function(){},giveLoadingContextController:function(e){if(e&&e.context)for(let t=0;t<I.length;t++)if(I[t].context===e.context)return I[t].controller},getLoadingContextController:function(e){let t;if(e&&e.context&&!(t=this.giveLoadingContextController(e))){let n=new h({ctxViewer:e.context});t=Object.freeze({load:function(e){n&&n.load(e)},getLoadedID:function(){if(n)return n.getLoadedID()},setLoadedID:function(e){if(n)return n.setLoadedID(e)},getDocumentVersionInfos:function(){if(n)return n.getDocumentVersionInfos()},getIsrContext:function(e){if(n)return n.getIsrContext(e)},clean:function(e){if(n)return n.clean(e)},getLoadMarkupDocumentMode:function(){if(n)return n.getLoadMarkupDocumentMode()},getLoadMarkupCtxType:function(){if(n)return n.getLoadMarkupCtxType()},getLoadedSheetInformations:function(){if(n)return n.getLoadedSheetInformations()},getTempObjectInformations:function(){if(n)return n.getTempObjectInformations()},setLoadedR2VInformations:function(e){if(n)return n.setLoadedR2VInformations(e)},getLoadedR2VInformations:function(){if(n)return n.getLoadedR2VInformations()}}),I.push({context:e.context,controller:t})}return t},unreferenceLoadingContextController:function(e){if(e&&e.context)for(let t=0;t<I.length;t++)I[t].context===e.context&&(I[t].controller.clean(!0),I.splice(t,1))}})}),define("DS/DMUReadPersistence/DMUValidationReadServices",["UWA/Class","DS/DMUBaseExperience/EXPUtils","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/VisuDataAccess/Ox4StreamLoader"],function(e,t,n,o){"use strict";return e.extend({init:function(){this.getProductByValidationId=function(e,t,o){n.sendWebServiceCall({url:"resources/validation/service/getPrdIdByValidationId",config:{verb:"POST",data:{sValidationId:e}},onSuccess:function(e){var n=JSON.parse(e);t(n)},onFailure:function(){o()}})},this.getAllElementsByValidationId=function(e){n.sendWebServiceCall({url:"resources/validation/service/getAll",config:{verb:"POST",data:{sValidationId:e.validationId}},onSuccess:function(t){var n=JSON.parse(t);e.onSuccess(n)},onFailure:function(){e.onFailure()},platform:e.platform})},this.getMarkupJson=function(e,a,r,i){var s={IRPC:!0,serverUrl:n.get3DSpaceUrl(),physicalid:e.markupId,boType:"VALReview",format:"1",persistancyType:"json",streamType:"string",onStreamLoaded:function(n){window.console.log("getMarkupJson::success:"+n.byteLength),a({jsonObj:JSON.parse(t.cleanJSONString(n)),reviewPid:e.markupId,reviewName:e.markupName,modifiable:!0},i)},onError:function(e){window.console.log("getMarkupJson::erreur:"+e),r(e="NOSTREAM")}};window.console.log("Loading streams"),o.Load(s)},this.getValidationFromHighlightId=function(e){n.sendWebServiceCall({url:"resources/validation/service/getValidationFromHighlightId",config:{verb:"POST",data:{sHighlightId:e.highlightId}},onSuccess:function(t){var n=JSON.parse(t);e.onSuccess(n)},onFailure:function(){e.onFailure()},platform:e.platform})},this.getValidationsFromObjectsIds=function(e){n.sendWebServiceCall({url:"resources/validation/service/getValidationsFromObjectsIds",config:{verb:"POST",data:{listHighlights:e.highlightIds,listChecks:e.checkIds,listValidations:e.validationIds}},onSuccess:function(t){var n=JSON.parse(t);e.onSuccess(n)},onFailure:function(){e.onFailure()},platform:e.platform})}}})}),define("DS/DMUReadPersistence/DMULoadMarkupServices",["UWA/Class","DS/DMUControls/EXPNotify","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUReadPersistence/DMUReviewPersistenceServices","DS/DMUReadPersistence/DMUValidationReadServices","DS/DMUBaseWebValidation/EXPValImporter","DS/DMUReadPersistence/DMUReadServices","DS/ApplicationFrame/CommandsManager","DS/Mesh/MeshUtils","DS/CoreEvents/ModelEvents","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUReadPersistence/DMULoadingContextController","DS/PADUtils/views/PADProgressBar","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/DMUReadPersistence/DMUWebServicesUtils","DS/DMUBaseExperience/EXPToolsContext","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"],function(e,t,n,o,a,r,i,s,l,d,c,u,p,f,m,g,v,D,h,I){"use strict";var S=e.extend({init:function(S){var y,C,M,b,w,x,P=this,R=!0,F=new d,k=S.ctxViewer,T=[],U=[],O=0,L=new o,j=new a;function A(){var e=u.getReviewContext({context:k});e&&e.getCurrentSessionMarkup()&&e.getCurrentSessionMarkup().setReadOnly(!0);var t=s.getCommand("DMUMarkupHdr",k.getCommandContext());t&&t.enable();var n=s.getCommand("CleanAll",k.getCommandContext());n&&n.enable()}function N(e,t){F&&F.publish({event:e,data:t,context:P})}function E(e){if(k&&e!==R){R=e;var t=u.getReviewContext({context:k});R?(k&&(T&&(T.forEach(function(e){var t=s.getCommand(e._id,k.getCommandContext());t&&(e._isEnabled?t.enable():t.disable())}),T=[]),U&&(U.forEach(function(e){var t=s.getCommandCheckHeader(e._id,k.getCommandContext());e&&(e._isEnabled?t.enable():t.disable())}),U=[])),t&&t.getNode()&&t.getNode().setPickable(l.PICKABLE)):(!function(){if(k){var e,t,n=s.getCommands(k.getCommandContext());for(e in n)n.hasOwnProperty(e)&&(t=n[e],T.push({_id:t._id,_isEnabled:t._isEnabled}));var o=s.getCommandCheckHeaders(k.getCommandContext());for(e in o)o.hasOwnProperty(e)&&(t=o[e],U.push({_id:t._id,_isEnabled:t._isEnabled}));s.disableAll(k.getCommandContext())}}(),t&&t.getNode()&&t.getNode().setPickable(l.PICKTHROUGH)),k.getViewer().render()}}function V(e,n){y&&(y.destroy(),y=null),y=new t({body:k.getFrameWindow().getUIFrame(),type:e,message:n})}function _(e){k&&(O>0&&(m.off(),O--),E(!0),e&&V("error",e),N("onDMUMarkupLoadFailed"))}function W(e){if(k){O>0&&(m.off(),O--);var t=u.getReviewContext({context:k});_("Cancel"!==e?"NoMarkup"===e?I.loadNoMarkup:I.loadError:void 0),t&&t.getCurrentSessionMarkup()&&t.getCurrentSessionMarkup().isReadOnly()&&A()}}function q(e){E(!0),O>0&&(m.off(),O--),u.removeReviewContext({context:k}),n.createReviewContext({context:k}),i.importModel({dataJson:e.jsonObj,appType:e.ID,viewer:k.getViewer(),onImportCompleted:function(t){if(!k)return;var n=x?x.getLoadMarkupCtxType():C,o=x?x.getTempObjectInformations():void 0,a=u.getReviewContext({context:k});const r=e.jsonObj&&e.jsonObj.ApplicativeContext?e.jsonObj.ApplicativeContext:null;t[0]&&t[0].setApplicativeContext&&t[0].setApplicativeContext(r),a.setCurrentSessionMarkup(t[0].getMarkupContent?t[0].getMarkupContent():t[0]),a.setReviewCtxInformation({contextId:e.contextId,contextType:n,reviewId:e.reviewPid,reviewName:e.reviewName,reviewDescription:e.reviewDescription,reviewType:e.reviewType,owner:e.owner,modifiable:e.modifiable,tempObjectInfo:o}),p.setSlidePreferences({context:k.getFrameWindow(),preferences:{panelTitle:e.reviewName}}),e.modifiable||A(),V("info",e.modifiable?I.loadOK:I.ReviewReserved),N("onDMUMarkupLoadSucceeded",{id:e.reviewPid})},onImportFailed:W})}function J(e,t){D.getParentTypes(e).then(function(n){t([e].concat(n))}).catch(function(){t([e])})}function B(e,t,n){return k?new Promise(function(n){"SIMItfSimulation"===t?(x||(x=f.getLoadingContextController({context:k})),x.getIsrContext(e).then(function(e){n({contextID:e&&e.length?e[0]:null})})):n({contextID:e})}).then(function(e){var t,o,a,r=k.getRootBagPath().getChildrenPathes();if(0===r.length)n.loadProductAllowed=!0,n.loadMarkupAllowed=!0;else for(let i=0;i<r.length;i++){if(a=c.getNodeID(r[i].getLastElement(!0)),k.getController().isFiltered(a).filterId?t=k.getController().isFiltered(a).filterId:o=a,o&&o===e.contextID){n.loadMarkupAllowed=!0;break}if(t&&a===e.contextID){n.removeFilterAllowed=!0,n.loadProductAllowed=!0,n.loadMarkupAllowed=!0;break}}return Promise.resolve({conditions:n,sessionFilterId:t,sessionProductId:o,sessionRootId:a})}):Promise.resolve()}function K(e,t,n,o,a){var r=e.conditions,i=e.sessionRootId,s=null,l=null,d={};J(a,function(e){if(e&&e.length)if(-1!==e.indexOf("DesignSight")||-1!==e.indexOf("SIMItfSimulation")||-1!==e.indexOf("Document")||-1!==e.indexOf("Requirement Specification")||-1!==e.indexOf("Requirement"))if(r.loadMarkupAllowed||-1!==e.indexOf("SIMItfSimulation")){let o;x||(x=f.getLoadingContextController({context:k})),(o="Markup"===t.objectType?L.getDnDReviewAndJSONFile:L.getMarkupStream)({markupId:t.objectId,markupType:t.objectType,markupTitle:t.displayName,markupOwner:t.owner},function(t){t.jsonObj.Contexts?-1!==e.indexOf("Document")?(t.jsonObj.Contexts[0].documentVersionInfos&&(M=t.jsonObj.Contexts[0].documentVersionInfos),d.objectId=n,d.objectType=a,d.objectParentType="Document",d.fileId=M.fileId,d.versionId=M.versions[0],d.versions=M.versions,d.documentType=t.jsonObj.Contexts[0].documentType,d.loadMarkup=function(){x.getDocumentVersionInfos().versions[0]!==M.versions[0]&&("normal"===x.getLoadMarkupDocumentMode()?V("info",I.loadMarkupWithNewVersionFile):"delete"===x.getLoadMarkupDocumentMode()&&V("info",I.loadMarkupWithNewFile)),t.contextId=n,q(t)},r.loadProductAllowed?x.load({data:d}):r.loadMarkupAllowed&&d.loadMarkup()):-1!==e.indexOf("SIMItfSimulation")&&(s=t.jsonObj.Contexts[0].listData,l=t.jsonObj.Contexts[0].loadingInfos,s&&0!==s.length?(d.objectId=s,d.objectType="PLMPIMMetricReference",d.loadMode=l,d.loadMarkup=function(){t.contextId=n,q(t)},x.load({data:d})):(d.objectId=n,d.objectType=a,d.objectParentType="SIMItfSimulation",d.loadMode=l,d.loadMarkup=function(){t.contextId=n,q(t)},x.load({data:d}))):-1!==e.indexOf("Requirement")||-1!==e.indexOf("Requirement Specification")?(d.objectId=n,d.objectType=a,d.objectParentType=-1!==e.indexOf("Requirement")?"Requirement":"Requirement Specification",d.loadMarkup=function(){t.contextId=n,q(t)},x.load({data:d})):-1!==e.indexOf("DesignSight")&&(d.objectId=n,d.objectType=a,d.objectParentType="DesignSight",d.loadMode=l,d.loadMarkup=function(){t.contextId=n,q(t)},r.loadProductAllowed?x.load({data:d}):r.loadMarkupAllowed&&d.loadMarkup())},W)}else _(I.DragAndDropError);else{if((r.removeFilterAllowed||r.removeProductAllowed)&&k.getController().removeRoots({pids:[i]}),r.loadFilterAllowed&&k.addFilter([{objectId:o}]),r.loadProductAllowed){var c=k.getAutomaticReframePolicy();k.setAutomaticReframePolicy(!1),-1!==e.indexOf("DIFLayout")||-1!==e.indexOf("DIFSheet")?(x||(x=f.getLoadingContextController({context:k})),d.objectId=n,d.objectType=a,d.objectParentType=-1!==e.indexOf("DIFLayout")?"DIFLayout":"DIFSheet",x.load({data:d})):"R2V_FeatureState"===a?k.addR2Vs({objects:[{displayName:"r2vName",objectId:n,objectType:"R2V_FeatureState",path:[{resourceid:n,type:"R2V_FeatureState"}],serviceId:"r2vsurvey"}],reframe:!1,displayNotif:!0,dispatch:!0}):k.addRoots({objects:[{path:[n]}]}),k.setAutomaticReframePolicy(c)}if(r.loadMarkupAllowed){let e;(e="Markup"===t.objectType?L.getDnDReviewAndJSONFile:L.getMarkupStream)({markupId:t.objectId,markupType:t.objectType,markupTitle:t.displayName,markupOwner:t.owner},function(e){e.contextId="ENOStrRefinementSpecification"===a?o:n,q(e)},W)}else _(I.DragAndDropError)}})}function X(t){return new e.Promise(function(e){function n(){e({status:"KO",msg:I.loadError})}if(!t||!t.objectId||!t.objectType)return void n();let o;(o="Markup"===t.objectType?L.getProductByMarkerId:L.getMarkupInfos)({physicalid:t.objectId},function(t){if(k){var n,o,a,r,i,s={loadProductAllowed:!1,removeProductAllowed:!1,loadFilterAllowed:!1,removeFilterAllowed:!1,loadMarkupAllowed:!1};if(t&&t.MarkupContext&&t.MarkupContext.contexts&&t.MarkupContext.contexts.length?(n=t.MarkupContext.contexts[0].type,C=n):"r2vsurvey"===t.MarkupContext.serviceID?n=C="R2V_FeatureState":e({status:"NoContextFound"}),t&&t.name&&(i=t.name),n&&"ENOStrRefinementSpecification"===n){var l=[a=t.MarkupContext.contexts[0].id];k.getController().getPrdIdFromFilterId(l).then(function(t){r=function(e,t,n){if(k){var o,a,r,i=k.getRootBagPath().getChildrenPathes();if(0===i.length)n.loadFilterAllowed=!0,n.loadMarkupAllowed=!0;else for(let s=0;s<i.length;s++){if(r=c.getNodeID(i[s].getLastElement(!0)),k.getController().isFiltered(r).filterId?o=k.getController().isFiltered(r).filterId:a=r,o&&o===e){n.loadMarkupAllowed=!0;break}if(o&&o!==e&&r===t){n.removeFilterAllowed=!0,n.loadFilterAllowed=!0,n.loadMarkupAllowed=!0;break}if(a&&t===a){n.removeProductAllowed=!0,n.loadFilterAllowed=!0,n.loadMarkupAllowed=!0;break}}return{conditions:n,sessionFilterId:o,sessionProductId:a,sessionRootId:r}}}(a,o=t,s),e({status:"OK",valMarkup:r,mkpName:i,relatedRootId:o,relatedFilterId:a,relatedObjectType:n})}).catch(function(t){window.console.log(t),e({status:"KO",msg:I.loadError})})}else"R2V_FeatureState"===n?B(o=t.MarkupContext.contextId,n,s).then(function(t){e({status:"OK",valMarkup:t,mkpName:i,relatedRootId:o,relatedFilterId:a,relatedObjectType:n})}):B(o=t.MarkupContext.contexts[0].id,n,s).then(function(r){e({status:"OK",valMarkup:r,mkpName:i,relatedRootId:o,relatedFilterId:a,relatedObjectType:n,mkpOwner:t.owner})})}},n)})}function G(e){j.getMarkupJson({markupId:e.markup.getPlmID(),markupName:e.markup.getName()},e.onLoadingCompleted,e.onLoadingFailed,e.markup)}function z(e){i.importModel({dataJson:e.asset.jsonObj,appType:e.asset.ID,mkpRepRef:e.asset.markupCtx,viewer:k.getViewer(),onImportFailed:e.onImportFailed,onImportCompleted:e.onImportCompleted})}this.subscribe=function(e,t){if(F&&e&&t)return F.subscribe({event:e},t)},this.unsubscribe=function(e){F&&e&&F.unsubscribe(e)},this.load=function(e){e.objectId&&k&&(m.on(I.LoadingPanel,null),O++,X(e).then(function(t){"KO"===t.status?_(I.loadError):"NoContextFound"===t.status?_(I.loadMarkupNoContext):(e.displayName=t.mkpName,e.owner=t.mkpOwner,K(t.valMarkup,e,t.relatedRootId,t.relatedFilterId,t.relatedObjectType))}))},this.loadIfContextLoaded=function(e){if(k)return new Promise(function(t){X(e).then(function(n){if(k){var o=n.valMarkup.conditions;"OK"!==n.status||o.removeFilterAllowed||o.removeProductAllowed||o.loadFilterAllowed||o.loadProductAllowed||!o.loadMarkupAllowed?t(!1):(K(n.valMarkup,e,n.relatedRootId,n.relatedFilterId,n.relatedObjectType),t(!0))}})})},this.getMarkupContextType=function(){return C},this.getDocumentVersionInfos=function(){return M},this.loadValidation=function(e){let t,o,a,i=0,s=["Requirement Specification","Requirement","DIFLayout","DIFSheet","Document","SIMItfSimulation","PLMPIMMetricReference","DesignSight"];if(x||(x=f.getLoadingContextController({context:k})),k){var l,d=u.getReviewContext({context:k});if(d&&(l=d.getValidation()),e.reviewId){var m=u.giveEventsController({viewer:k.getViewer()}),D=null,S=function(e){return new Promise(function(n,r){if(e){var l=e.getRepRef();l?m.fireEvent("onGetMarkupJsonEvt",{markup:l,onLoadingCompleted:function(e,r){let l=()=>{e.markupCtx=r,m.fireEvent("onImportModelEvt",{asset:e,onImportCompleted:function(e){if(e&&e[0]){var t=e[0].getMarkupContent?e[0].getMarkupContent():e[0];t&&(r.setMarkupContent(t),t.setMarkupOwner(r),D&&t.setReadOnly(D.isReadOnly()||r.isReadOnly()))}n()}})},d=a||o;if(-1!==s.indexOf(d))if(0!==i||k.getRoots().length)k.getRoots().length&&m.fireEvent("onLoadedReviewContext",{rootType:d}),l();else{let n=k.subscribe({event:"onRootAdded"},function(){k.unsubscribe(n),l()});i++;let a={};if(e.jsonObj.Contexts){if("Document"===d){if(e.jsonObj.Contexts[0].documentVersionInfos&&(M=e.jsonObj.Contexts[0].documentVersionInfos),a.objectId=t,a.objectType=o,a.objectParentType="Document",a.fileId=M.fileId,a.versionId=M.versions[0],a.versions=M.versions,a.documentType=e.jsonObj.Contexts[0].documentType,x.load({data:a}),m)var c=m.addEvent("onGetDocumentsCompleted",function(){m.removeEvent(c);let e=u.getReviewContext({context:k});if(e){let t=e.getReviewCtxInformation();t.tempObjectInfo=x.getTempObjectInformations(),e.setReviewCtxInformation(t)}})}else if("SIMItfSimulation"===d){let n=e.jsonObj.Contexts[0].listData,r=e.jsonObj.Contexts[0].loadingInfos;n&&0!==n.length?(a.objectId=n,a.objectType="PLMPIMMetricReference",a.loadMode=r,x.load({data:a})):(a.objectId=t,a.objectType=o,a.objectParentType="SIMItfSimulation",a.loadMode=r,x.load({data:a}))}}else a.objectId=t,a.objectType=o,a.objectParentType=d,x.load({data:a})}else l()},onLoadingFailed:function(){r(e)}}):r(e)}else r(e)})},y=function(i){var d,y,C,M;new Promise(e=>{if(i&&i.children){x||(x=f.getLoadingContextController({context:k}));let t=0;i.children.forEach(n=>{n&&"DMUValidationContext"===n.type?"r2vsurvey"===n.serviceID?function(e){return new Promise((t,n)=>{require("DS/WAFData/WAFData").authenticatedRequest(g.getPlatformURL(e.serviceId)+"/enovia/resources/r2v/v1/modeler/featurestate/fetch",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":v.getSetting("lang")},data:JSON.stringify({ids:[e.objectId]}),timeout:6e4,onComplete:function(e){let n=JSON.parse(e);t(n)},onFailure:n,onTimeout:n})})}({serviceId:n.serviceID,objectId:n.contextId}).then(t=>{M=t.result[0]["ds6w:label"],n.contexts=[{id:n.contextId,name:t.result[0]["ds6w:label"],type:t.result[0].type,loadedR2VInfo:[{id:n.contextId,info:t.result}]}],d=n.contexts,C=n.serviceID,i.children.forEach(e=>{e&&"DMUValidationValidated"===e.type&&(e.validatedObjects=[{PathElements:[n.contextId],referenceName:M,instanceName:M}])}),e()}):(d=n.contexts,e()):++t===i.children.length&&e()})}}).then(()=>{let f,g;if(k.getApplicativeData().getLoadedItfData&&k.getApplicativeData().getLoadedItfData().data.length?f=k.getApplicativeData().getLoadedItfData().data[0].isrID:k.getRootBagPath().getChildrenPathes().length>0&&(f=c.getNodeID(k.getRootBagPath().getChildrenPathes()[0].getLastElement(!0))),t=d?d[0].id:void 0,o=d?d[0].type:void 0,k.getController().isFiltered(f).filterId&&(g=k.getController().isFiltered(f).filterId),f&&f!==t&&g!==t)V("error",I.valDragAndDropError),e.cbFailed();else{f&&l&&(u.removeReviewContext({context:k}),m&&m.fireEvent("onDMURemoveSessionReview")),(D=n.createReviewContext({context:k,typeObject:"Review"})).setReadOnly(e.readOnly);var v=new r({viewer:k,DMUExperience:D}),P=null;b||w||(b=m.addEvent("onGetMarkupJsonEvt",G),w=m.addEvent("onImportModelEvt",z));var R=function(){var r=(P=v.importValidationFromJSON(i,e.editionMode)).getContext()&&P.getContext()&&P.getContext().getJsonContextIDs()&&P.getContext().getJsonContextIDs().length?P.getContext().getJsonContextIDs()[0]:void 0;n.createReviewContext({context:k}).setReviewCtxInformation({reviewId:P.getPlmID(),highlightId:e.type&&"DMUValidationExposedPresentation"===e.type?e.reviewId:void 0,reviewName:e.displayName?e.displayName:P.getName(),reviewType:e.type?e.type:P.getType(),contextId:r,modifiable:e.readOnly?e.readOnly:P.isReadOnly(),owner:P.getOwner()}),p.setSlidePreferences({context:k.getFrameWindow(),preferences:{panelTitle:i.name}});var l=null;if(l=k.subscribe({event:"onRootAdded"},function(){e.cbRootAdded(),k.unsubscribe(l)}),t&&f!==t&&"refreshMode"!==e.loadMode){var g=P.getContext().getJsonContextIDs();-1===s.indexOf(a)&&("R2V_FeatureState"===a?k.addR2Vs({objects:[{displayName:M,objectId:r,objectType:"R2V_FeatureState",path:[{resourceid:r,type:"R2V_FeatureState"}],serviceId:C}],reframe:!1,displayNotif:!0,dispatch:!0}):k.addRoots({objects:[{path:g}]}))}var D=[],h=[],y=function(e,t){e.getReplies().forEach(function(e){t.push(e),y(e,t)})};P.getMarkups().forEach(function(e){y(e,h),D.push(S(e))}),h.forEach(function(e){D.push(S(e))});var b=function(t){var n=P.getLoadedRepRefs();if(n.length>0){if(P.setCurrentMarkup(n[0]),P.refreshNode(),k.getViewer().render(),t?V("warning",I.loadValSomeMkup):V("success",I.loadValSuccess),!d){let e=u.getReviewContext({context:k}).getValidation().getMarkups();m.fireEvent("reviewNoContextModeOn",{markups:e});let t=k.subscribe({event:"onRootAdded"},function(e){let n=c.getNodeType(e.path.getLastElement(!0));m.fireEvent("reviewNoContextModeOff",{rootType:n}),k.unsubscribe(t)})}m.fireEvent("OnReviewMarkupLoaded"),e.cbOK()}else e.cbFailed()};if(D.length>0)Promise.all(D).then(function(){b()},function(){b(!0)});else{let e={};e.objectId=t,e.objectType=o,e.objectParentType=a||o,x.load({data:e}),V("warning",I.loadValNoMarkup)}};d&&1===d.length?J(d[0].type,function(t){const n=["VPMReference","Document","Requirement","Requirement Specification","Drawing","SIMItfSimulation","PLMPIMMetricReference","DIFLayout","DIFSheet","DesignSight","R2V_FeatureState"];let o=!1;if(t)for(y=0;y<t.length;y++){if(n.includes(t[y])&&(o=!0,a=t[y],h.setParentType(d[0].type,a)),"PPRContext"===t[y]){o=!1;break}if("Requirement"===t[y]||"Drawing"===t[y]||"DIFSheet"===t[y]||"DIFLayout"===t[y]){if(o=!0,i.children)for(let e=0;e<i.children.length;e++)if("Markup"===i.children[e].type&&i.children[e].children){for(let t=0;t<i.children[e].children.length;t++)if("false"===i.children[e].children[t].webMarkup){o=!1;break}if(!1===o)break}if(!1===o)break}}if(o)R();else if(t&&-1!==t.indexOf("ENOStrRefinementSpecification")){if(i&&i.children)for(y=0;y<i.children.length;y++)if(i.children[y]&&"DMUValidationContext"===i.children[y].type){d=i.children[y].contexts;break}k.getController().getPrdIdFromFilterId([d[0].id]).then(function(){"refreshMode"!==e.loadMode&&k.addFilter([{objectId:d[0].id}]),function(e){var t=e.valImporter.importValidationFromJSON(e.jsonNode,e.editionMode);p.setSlidePreferences({context:k.getFrameWindow(),preferences:{panelTitle:e.jsonNode.name}});var n=[],o=[],a=function(e,t){e.getReplies().forEach(function(e){t.push(e),a(e,t)})};t.getMarkups().forEach(function(t){a(t,o),n.push(e.loadMarkup(t))}),o.forEach(function(t){n.push(e.loadMarkup(t))});var r=function(n){var o=t.getLoadedRepRefs();o.length>0?(t.setCurrentMarkup(o[0]),t.refreshNode(),k.getViewer().render(),n?V("warning",I.loadValSomeMkup):V("success",I.loadValSuccess),e.cbOK(),u.giveEventsController({viewer:k.getViewer()}).fireEvent("OnReviewMarkupLoaded")):e.cbFailed()};n.length>0?Promise.all(n).then(function(){r()},function(){r(!0)}):V("warning",I.loadValNoMarkup)}({jsonNode:i,editionMode:e.editionMode,valImporter:v,loadMarkup:S,cbOK:e.cbOK})})}else e.cbFailed(),V("error",I.loadValContextError)}):f||d?(V("error",I.valDragAndDropError),e.cbFailed()):R()}})},C=function(){V("error",I.loadValError),e.cbFailed()};"DMUValidationValidation"===e.type&&j.getAllElementsByValidationId({validationId:e.reviewId,onSuccess:y,onFailure:C}),"DMUValidationExposedPresentation"===e.type&&j.getValidationFromHighlightId({highlightId:e.reviewId,onSuccess:function(t){t&&l&&l.getPlmID()===t.id?e.cbOK({sameReview:!0}):y(t)},onFailure:C})}else V("error",I.valDragAndDropError)}},this.clearController=function(){if(y&&y.destroy(),b&&w){var e=u.giveEventsController({viewer:k.getViewer()});e.removeEvent(b),e.removeEvent(w),b=w=null}k=y=F=L=C=null}}}),y=[];return e.singleton({init:function(){},giveLoadMarkupServices:function(e){if(e&&e.context)for(var t=0;t<y.length;t++)if(y[t].context===e.context)return y[t].controller},getLoadMarkupServices:function(e){var t;if(e&&e.context&&!(t=this.giveLoadMarkupServices(e))){var n=new S({ctxViewer:e.context});t=Object.freeze({load:function(e){n&&n.load(e)},loadValidation:function(e,t,o){if(n)return n.loadValidation(e,t,o)},loadIfContextLoaded:function(e){if(n)return n.loadIfContextLoaded(e)},subscribe:function(e,t){if(n)return n.subscribe(e,t)},unsubscribe:function(e){n&&n.unsubscribe(e)},getMarkupContextType:function(){if(n)return n.getMarkupContextType()},clearController:function(){n&&(n.clearController(),n=null)},getDocumentVersionInfos:function(){if(n)return n.getMarkupContextType()}}),y.push({context:e.context,controller:t})}return t},unreferenceLoadMarkupServices:function(e){if(e&&e.context)for(var t=0;t<y.length;t++)if(y[t].context===e.context){y[t].controller.clearController(),y.splice(t,1);break}}})});