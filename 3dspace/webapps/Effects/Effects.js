define("DS/Effects/SaveAsHDR",[],function(){"use strict";return{writeHDRHeader:function(e,s){var t=function(e,s,t){for(var i=0;i<s.length;i++)e[t++]=s.charCodeAt(i);return t},i="# Made with Dassault Systemes HDR mipmap roughness generator - TZW",a="-Y "+s+" +X "+e,r=new Uint8Array("#?RADIANCE".length+1+i.length+1+"FORMAT=32-bit_rle_rgbe".length+2+a.length+1+e*s*4),n=0;return n=t(r,"#?RADIANCE",n),r[n++]=10,n=t(r,i,n),r[n++]=10,n=t(r,"FORMAT=32-bit_rle_rgbe",n),r[n++]=10,r[n++]=10,n=t(r,a,n),r[n++]=10,{buffer:r,offset:n,width:e,height:s}},writeTexture:function(e,s,t,i){for(var a=4*s.width*i,r=4*t,n=e.height-1,h=0;h<e.height;h++){for(var o=e.width-1,l=0;l<e.width;l++){for(var p=0;p<4;p++)s.buffer[s.offset+a+r+4*l+p]=255*e.buffer[4*(e.width*n+o)+p];o--}a+=4*s.width,n--}},compressHDR:function(e){for(var s=function(e){for(var s=new Uint8Array(2*e.length),t=0;t<e.length;t++)s[t]=e[t];return s},t=e.offset,i=t,a=new Uint8Array(e.buffer.length),r=0;r<t;r++)a[r]=e.buffer[r];for(var n=new Uint8Array(4+5*e.width),h=0;h<e.height;h++){var o=0;n[o++]=2,n[o++]=2,n[o++]=e.width>>8,n[o++]=255&e.width;for(var l=0;l<4;l++){var p=[];for(r=0;r<e.width;){for(var u=0,c=e.buffer[t+4*(h*e.width+r)+l],d=c;r<e.width&&d===c&&u<127;)u++,r++,c=d,d=e.buffer[t+4*(h*e.width+r)+l];if(u>3){if(p.length){n[o++]=p.length;for(var m=0;m<p.length;m++)n[o++]=p[m];p=[]}n[o++]=128+u,n[o++]=c}else{if(p.length+u>127){n[o++]=p.length;for(m=0;m<p.length;m++)n[o++]=p[m];p=[]}p.push(c),u>1&&p.push(c),u>2&&p.push(c)}}if(p.length){n[o++]=p.length;for(m=0;m<p.length;m++)n[o++]=p[m]}}i+o>=a.length&&(a=s(a));for(var f=0;f<o;f++)a[i++]=n[f]}var g=new Uint8Array(i);for(r=0;r<i;r++)g[r]=a[r];e.buffer=g}}}),define("DS/Effects/PreHighlightMobileNonEffect",["DS/Visualization/ThreeJS_DS","DS/Plugins/RenderPass","DS/Plugins/ClearPass","DS/Visualization/PickingMode"],function(e,s,t,i){"use strict";return class{constructor(e){this.preHighlightSinglePass=null,this.Canvas2DpreHighlightSinglePass=null,this.renderer=e,this.enabled=!0,this._initPasses()}_initPasses(){var t=this.renderer.mainComposer;this.preHighlightSinglePass=new s(null,null,null,void 0,void 0,void 0,"preHighlightSinglePass"),this.preHighlightSinglePass.setRenderPluginsPre(!1),this.preHighlightSinglePass.setRenderPluginsPost(!1),this.preHighlightSinglePass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.preHighlightSinglePass.setDisableBackFaceCulling(!0),this.preHighlightSinglePass.setDisableDepthTest(!0),this.preHighlightSinglePass.setDisableDepthWrite(!0),this.preHighlightSinglePass.lockScene=!0,t.addPass(this.preHighlightSinglePass),this.Canvas2DpreHighlightSinglePass=new s(null,null,null,void 0,void 0,void 0,"Canvas2DpreHighlightSinglePass"),this.Canvas2DpreHighlightSinglePass.setRenderPluginsPre(!1),this.Canvas2DpreHighlightSinglePass.setRenderPluginsPost(!1),this.Canvas2DpreHighlightSinglePass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.Canvas2DpreHighlightSinglePass.setDisableBackFaceCulling(!0),this.Canvas2DpreHighlightSinglePass.setDisableDepthTest(!0),this.Canvas2DpreHighlightSinglePass.setDisableDepthWrite(!0),this.Canvas2DpreHighlightSinglePass.lockScene=!0,this.Canvas2DpreHighlightSinglePass.idString="canvas2D",t.addPass(this.Canvas2DpreHighlightSinglePass)}setEnabled(e){this.enableb&&e||(this.enabled||e)&&(this.renderer.__enablePassOnAllComposerContexts(this.preHighlightSinglePass,!1),this.renderer.__enablePassOnAllComposerContexts(this.Canvas2DpreHighlightSinglePass,!1),this.renderer.compForwardComposerContext&&(this.renderer.compForwardComposerContext.enablePass(this.preHighlightSinglePass,e),this.renderer.compForwardComposerContext.enablePass(this.Canvas2DpreHighlightSinglePass,e)))}disableOnComposer(e){e.enablePass(this.preHighlightSinglePass,!1),e.enablePass(this.Canvas2DpreHighlightSinglePass,!1)}_sortScenes(e){this._scenesToRender=[],e.selectionPreHL.enabled&&this._scenesToRender.push(e.selectionPreHL.sceneHL);var s=this;this.preHighlightSinglePass.setMultiRenderCB(function(e,t){return t<s._scenesToRender.length&&(e.scene=s._scenesToRender[t],!0)}),this.Canvas2DpreHighlightSinglePass.setMultiRenderCB(function(e,t){return t<s._scenesToRender.length&&(e.scene=s._scenesToRender[t],!0)})}_setRenderModes(){var e=this.renderer.renderer,[s,t,i]=e.getRenderMode().getMasks();this.preHighlightSinglePass.renderFaceMode=s,this.preHighlightSinglePass.renderLineMode=t,this.preHighlightSinglePass.renderPointMode=i,this.Canvas2DpreHighlightSinglePass.renderFaceMode=s,this.Canvas2DpreHighlightSinglePass.renderLineMode=t,this.Canvas2DpreHighlightSinglePass.renderPointMode=i}_updateScene(e){this.preHighlightSinglePass.scene=e.selectionPreHL.sceneHL,this.Canvas2DpreHighlightSinglePass.scene=e.selectionPreHL.sceneHL}_checkPolite(e){var s=this.renderer.renderer,t=e.selectionPreHL.sceneHL;t.highlightData._needsDepth&&t.getNbAllWebGLObjects()+t.__objectsAdded.size>0&&s.requestPoliteDepthBuffer()}update(e){this._sortScenes(e),this._setRenderModes(),this._updateScene(e),this._checkPolite(e)}}}),define("DS/Effects/HighlightMobileNonEffect",["DS/Visualization/ThreeJS_DS","DS/Plugins/RenderPass","DS/Plugins/ClearPass","DS/Visualization/PickingMode"],function(e,s,t,i){"use strict";return class{constructor(e){this.highlightSinglePass=null,this.Canvas2DhighlightSinglePass=null,this.scenes=[],this._scenesToRender=[],this.renderer=e,this.enabled=!0,this._initPasses()}_initPasses(){var i=this.renderer.mainComposer;this.highlightClearPass=new t("highlightClearPass"),i.addPass(this.highlightClearPass),this.highlightSinglePass=new s(null,null,null,void 0,void 0,void 0,"highlightSinglePass"),this.highlightSinglePass.setRenderPluginsPre(!1),this.highlightSinglePass.setRenderPluginsPost(!1),this.highlightSinglePass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.highlightSinglePass.setDisableBackFaceCulling(!0),this.highlightSinglePass.setDisableDepthTest(!0),this.highlightSinglePass.setDisableDepthWrite(!0),this.highlightSinglePass.lockScene=!0,i.addPass(this.highlightSinglePass),this.Canvas2DhighlightClearPass=new t("Canvas2DhighlightClearPass"),i.addPass(this.Canvas2DhighlightClearPass),this.Canvas2DhighlightSinglePass=new s(null,null,null,void 0,void 0,void 0,"Canvas2DhighlightSinglePass"),this.Canvas2DhighlightSinglePass.setRenderPluginsPre(!1),this.Canvas2DhighlightSinglePass.setRenderPluginsPost(!1),this.Canvas2DhighlightSinglePass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.Canvas2DhighlightSinglePass.setDisableBackFaceCulling(!0),this.Canvas2DhighlightSinglePass.setDisableDepthTest(!0),this.Canvas2DhighlightSinglePass.setDisableDepthWrite(!0),this.Canvas2DhighlightSinglePass.idString="canvas2D",this.Canvas2DhighlightSinglePass.lockScene=!0,i.addPass(this.Canvas2DhighlightSinglePass)}setEnabled(e){this.enableb&&e||(this.enabled||e)&&(this.renderer.__enablePassOnAllComposerContexts(this.preHighlightSinglePass,!1),this.renderer.__enablePassOnAllComposerContexts(this.Canvas2DpreHighlightSinglePass,!1),this.renderer.__enablePassOnAllComposerContexts(this.Canvas2DhighlightClearPass,!1),this.renderer.__enablePassOnAllComposerContexts(this.highlightClearPass,!1),this.renderer.compForwardComposerContext&&(this.renderer.compForwardComposerContext.enablePass(this.preHighlightSinglePass,e),this.renderer.compForwardComposerContext.enablePass(this.Canvas2DpreHighlightSinglePass,e),this.renderer.compForwardComposerContext.enablePass(this.Canvas2DhighlightClearPass,e),this.renderer.compForwardComposerContext.enablePass(this.highlightClearPass,e)))}hide(e){if(this.enabled){var s=this.renderer;s.compForwardComposerContext.enablePass(this.highlightSinglePass,!e),s.compForwardComposerContext.enablePass(this.Canvas2DhighlightSinglePass,!e)}}disableOnComposer(e){e.enablePass(this.highlightClearPass,!1),e.enablePass(this.highlightSinglePass,!1),e.enablePass(this.Canvas2DhighlightClearPass,!1),e.enablePass(this.Canvas2DhighlightSinglePass,!1)}_sortScenes(e){this._scenesToRender=[],e.selectionHL.enabled&&this._scenesToRender.push(e.selectionHL.sceneHL);for(var s=0;s<this.scenes.length;s++){var t=this.scenes[s];t.enabled&&this._scenesToRender.push(t.sceneHL)}var i=this._scenesToRender.length;this._scenesToRender.sort(function(e,s){return e.highlightData.priority-s.highlightData.priority});var a=this;this.highlightSinglePass.setMultiRenderCB(function(e,s){return s<a._scenesToRender.length&&(e.scene=a._scenesToRender[s],!0)}),this.Canvas2DhighlightSinglePass.setMultiRenderCB(function(e,s){return s<a._scenesToRender.length&&(e.scene=a._scenesToRender[s],!0)}),Object.keys(this.highlightSinglePass.stateSortingResults).length>i&&(this.highlightSinglePass.stateSortingResults={}),Object.keys(this.Canvas2DhighlightSinglePass.stateSortingResults).length>i&&(this.Canvas2DhighlightSinglePass.stateSortingResults={})}_setRenderModes(){var e=this.renderer.renderer,[s,t,i]=e.getRenderMode().getMasks();this.highlightSinglePass.renderFaceMode=s,this.highlightSinglePass.renderLineMode=t,this.highlightSinglePass.renderPointMode=i,this.Canvas2DhighlightSinglePass.renderFaceMode=s,this.Canvas2DhighlightSinglePass.renderLineMode=t,this.Canvas2DhighlightSinglePass.renderPointMode=i}_updateScene(s){var t=this.renderer;t.renderer,t.compForwardComposerContext.setPassClear(this.highlightClearPass,!1,new e.Color(0),0),t.compForwardComposerContext.setPassClearDepth(this.highlightClearPass,!0),this.highlightSinglePass.scene=s.selectionHL.sceneHL,t.compForwardComposerContext.setPassClear(this.Canvas2DhighlightClearPass,!1,new e.Color(0),0),t.compForwardComposerContext.setPassClearDepth(this.Canvas2DhighlightClearPass,!0),this.Canvas2DhighlightSinglePass.scene=s.selectionHL.sceneHL}_checkPolite(e){var s=this.renderer.renderer,t=e.selectionHL.sceneHL,i=t.highlightData;if(i._needsDepth&&t.getNbAllWebGLObjects()+t.__objectsAdded.size>0&&s.requestPoliteDepthBuffer(),this.scenes&&!s._politeDBufferNextFrame)for(var a=0;a<this.scenes.length;a++)(i=(t=this.scenes[a].sceneHL).highlightData)._needsDepth&&t.getNbAllWebGLObjects()+t.__objectsAdded.size>0&&s.requestPoliteDepthBuffer()}update(e){this._sortScenes(e),this._setRenderModes(),this._updateScene(e),this._checkPolite(e)}addScene(e){return this.scenes.push(e),!0}removeScene(e){for(var s=e.highlightData,t=0;t<this.scenes.length;t++)if(this.scenes[t].highlightData.isEqual(s))return this.scenes.splice(t,1),!0;return!1}}}),define("DS/Effects/BasicEffect",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,s){"use strict";return e.extend({init:function(e){return this.enabled=!0,this.composers=[],this.mixPass=null,this.width=2,this.height=2,this.renderer=e,this},initEffect:function(e,s){},update:function(e,s,t){},setSize:function(e,s){return(this.width!==e||this.height!==s)&&(this.width=Math.max(2,e),this.height=Math.max(2,s),!0)},updateComposersName:function(e){var s;for(s=0;s<this.composers.length;s++)this.composers[s].composerContext.name||(this.composers[s].composerContext.name=e+"#"+s)},setEnabled:function(e){var s;for(this.enabled=e,s=0;s<this.composers.length;s++)this.composers[s].enabled=e;if(null!==this.mixPass){var t=this.mixPass.composer;t&&t.contexts.length&&t.contexts[0].enablePass(this.mixPass,e)}},getMaxIteration:function(){return 0},dispose:function(){var e;for(e=0;e<this.composers.length;e++)this.composers[e].composerContext&&this.composers[e].composerContext.dispose(),this.composers[e].dispose()}})}),define("Effects/BasicEffect",["DS/Effects/BasicEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/BasicEffect"),e}),define("DS/Effects/ExtractLightFromIBL",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/ExtractIBLLightShader"],function(e,s,t,i,a){"use strict";var r=function(e,s,t){for(var i=new Float32Array(e*s),a=function(e,t){return e<0||t<0?0:i[e*s+t]},r=0;r<e;r++)for(var n=0;n<s;n++){var h=s*r+n,o=t[4*h+3];i[h]=o+a(r-1,n)+a(r,n-1)-a(r-1,n-1)}this.sum=function(e,s,t,i,r,n,h,o){return a(r,n)+a(e,s)-a(t,i)-a(h,o)}},n=function(e,s,t){if(e.width<2||e.height<2||0==s){if(0==e.width||0==e.height)return;t.push(e)}else{var i=new h,a=new h;e.width>e.height?e.split2V(i,a):e.split2H(i,a),n(i,s-1,t),n(a,s-1,t)}},h=function(){};return h.prototype.set=function(e,s,t,i,a,r){this.yStart=s,this.xStart=e,this.width=t,this.height=i,this.summedATable=a,this.sum=r>-1?r:a.sum(e,s,e+(t-1),s,e+(t-1),s+(i-1),e,s+(i-1))},h.prototype.splitV=function(e){for(var s=1;s<=this.width&&(e.set(this.xStart,this.yStart,s,this.height,this.summedATable,-1),!(2*e.sum>=this.sum));++s);},h.prototype.split2V=function(e,s){this.splitV(e),s.set(this.xStart+(e.width-1),this.yStart,this.width-e.width,this.height,this.summedATable,this.sum-e.sum)},h.prototype.splitH=function(e){for(var s=1;s<=this.height&&(e.set(this.xStart,this.yStart,this.width,s,this.summedATable,-1),!(2*e.sum>=this.sum));++s);},h.prototype.split2H=function(e,s){this.splitH(e),s.set(this.xStart,this.yStart+(e.height-1),this.width,this.height-e.height,this.summedATable,this.sum-e.sum)},h.prototype.getCentroid=function(s,t){var i=new h;this.splitV(i);var a=i.xStart+(i.width-1);this.splitH(i);var r=i.yStart+(i.height-1),n=2*(a/s-.5)*Math.PI,o=-(r/t-1)*Math.PI;return new e.Vector3(Math.cos(o)*Math.sin(n),Math.sin(o)*Math.sin(n),Math.cos(n))},s.extend({init:function(e,s){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=s,this.texture=null,this.passIntensity=null,this},setEnvMap:function(s){this.texture=s;var r=s.composerContext&&s.composerContext.width,n=s.composerContext&&s.composerContext.height;if(s instanceof e.Texture?(r=s.image.width,n=s.image.height):s instanceof e.WebGLRenderTarget&&(r=s.width,n=s.height),this.width=parseInt(r),this.height=parseInt(n),this.composers.length)this.composers[0].setSize(this.width,this.height);else{var h=new e.WebGLRenderTargetProperties(this.width,this.height,"halfLinear");h.generateMipmaps=!1,this.composers[0]=new t(this.renderer,h,this.renderTargetPool),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.noIdCheck=!0;var o=a.ExtractIBLIntensityShader;this.texture instanceof t||this.texture.rgbHdr||(o=a.ExtractIBLIntensityShaderRGBE),this.passIntensity=new i({uniforms:o.uniforms,vertexShader:o.vertexShader,fragmentShader:o.fragmentShader},void 0,"IBL Intensity"),this.composers[0].addPass(this.passIntensity)}this.texture instanceof e.Texture||this.texture instanceof e.WebGLRenderTarget?this.passIntensity.uniforms.map.value=this.texture:this.texture.linkToShaderPassUniform(this.passIntensity,this.passIntensity.uniforms.map),this.passIntensity.uniforms.size.value=new e.Vector2(this.width,this.height)},execute:function(s){if(s||!this.renderer.supportsFloatTextures()&&!this.renderer.supportsHalfFloatTextures())return(m=new e.DirectionalIBLLight(new e.Color,0)).castShadow=!1,{light:m,dirLight:new e.Vector3(1,1,1)};this.composers[0].render();var t=new Float32Array(4*this.width*this.height);this.gl.readPixels(0,0,this.width,this.height,this.gl.RGBA,this.gl.FLOAT,t);for(var i=0,a=1e20,o=0;o<this.width;o++)for(var l=0;l<this.height;l++){var p=t[4*(this.height*o+l)+3];p>i&&(i=p,o,l),p<a&&(a=p)}if(0===i||1e20===a||(i-a)/i<.025)return(m=new e.DirectionalIBLLight(new e.Color,0)).castShadow=!1,{light:m,dirLight:new e.Vector3(1,1,1)};var u=new r(this.width,this.height,t),c=new h;c.set(0,0,this.width,this.height,u,-1);var d=[];n(c,9,d),d.sort(function(e,s){return e.sum<s.sum?1:-1});var m,f=d[0].getCentroid(this.width,this.height);return(m=new e.DirectionalIBLLight(new e.Color(16777215),1)).shadowMapWidth=2048,m.shadowMapHeight=2048,{light:m,dirLight:f}}})}),define("DS/Effects/ComputeSDFFontMergeTiles",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/NothingShader","DS/Shaders/PreComputeSDFFontIterativeShaders"],function(e,s,t,i,a,r){"use strict";return s.extend({init:function(s,t){return this._parent(s),this.renderer=s,this.rtPool=t,this.width=512,this.height=512,this.tileMin=new e.Vector2,this.tileMax=new e.Vector2,this.realTileMax=new e.Vector2,this.map=null,this.passMergeTile=null,this.passNothing=null,this},setSize:function(e,s){this.width=parseInt(e),this.height=parseInt(s)},setTileInfos:function(e,s,t,i,a,r){this.tileMin.set(e/this.width,s/this.height),this.tileMax.set((e+t)/this.width,(s+i)/this.height),this.realTileMax.set((e+a)/this.width,(s+r)/this.height),this.passMergeTile&&(this.passMergeTile.uniforms.tileMin.value=this.tileMin,this.passMergeTile.uniforms.tileMax.value=this.tileMax,this.passMergeTile.uniforms.realTileMax.value=this.realTileMax)},setInput:function(s){if(s){if(this.map=s,this.composers[0])this.composers[0].setSize(this.width,this.height);else{var n=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers[0]=new t(this.renderer,n,this.rtPool),this.composers[0].composerContext.keepResult=!0,this.passMergeTile=new i(r.MergeTiles),this.passMergeTile.renderToScreen=!1,this.passNothing=new i(a),this.composers[0].addPass(this.passMergeTile),this.composers[0].addPass(this.passNothing)}this.map.linkToShaderPassUniform(this.passMergeTile,this.passMergeTile.uniforms.tDiffuse2)}},execute:function(){this.composers[0].render()}})}),define("DS/Effects/GenerateMipMaps",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/DownSamplingShaders","DS/Shaders/DisplayIrradianceMapShader"],function(e,s,t,i,a,r){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.renderer=e,this.rtPool=s,this.map=null,this.nbIterations=9,this.passMip=[],this.passMergeMips=null,this.passDisplayMap=null,this},setSize:function(s,t){this.width="string"==typeof s?parseInt(s):s,this.height="string"==typeof t?parseInt(t):t,this.nbIterations=Math.min(Math.round(Math.log(Math.min(this.width,this.height))/Math.log(2)),e.supportedExtensions.fragmentTextureUnits)-1},setInput:function(s){if(s){this.map=s;var n=.5;if(this.composers[0]){for(var h=0;h<this.nbIterations;h++)this.composers[h].setSize(n*this.width,n*this.height),this.passMip[h].uniforms.invSize.value.set(1/(n*this.width),1/(n*this.height)),n*=.5;this.composers[this.nbIterations].setSize(this.width,2*this.height)}else{for(h=0;h<this.nbIterations;h++){var o=new e.WebGLRenderTargetProperties(n*this.width,n*this.height,"iblLinear");this.composers[h]=new t(this.renderer,o,this.rtPool),this.composers[h].composerContext.keepResult=!1,this.composers[h].composerContext.noIdCheck=!0,this.passMip[h]=new i(a.DownSamplingBlur,void 0,"GenerateMips"+h),this.passMip[h].uniforms.invSize.value.set(1/(n*this.width),1/(n*this.height)),this.passMip[h].material.needsUpdate=!0,this.passMip[h].renderToScreen=!1,this.composers[h].addPass(this.passMip[h]),n*=.5}var l=new e.WebGLRenderTargetProperties(this.width,2*this.height,"iblLinear");this.composers[this.nbIterations]=new t(this.renderer,l,this.rtPool),this.composers[this.nbIterations].composerContext.keepResult=!1,this.composers[this.nbIterations].composerContext.noIdCheck=!0,this.passMergeMips=new i(a.MergeMips(this.nbIterations),void 0,"MergeMips"),this.passMergeMips.renderToScreen=!1,this.composers[this.nbIterations].addPass(this.passMergeMips);for(h=1;h<this.nbIterations;h++)this.passMip[h].addRequiredComposer(this.composers[h-1]),this.composers[h-1].linkToShaderPassUniform(this.passMip[h],this.passMip[h].uniforms.tDiffuse2);this.passMergeMips.addRequiredComposer(this.composers[this.nbIterations-1]),this.map.linkToShaderPassUniform(this.passMergeMips,this.passMergeMips.uniforms.tDiffuse1);for(h=0;h<this.nbIterations;h++)this.composers[h].linkToShaderPassUniform(this.passMergeMips,this.passMergeMips.uniforms["tDiffuse"+(h+2)])}this.map.linkToShaderPassUniform(this.passMip[0],this.passMip[0].uniforms.tDiffuse2);var p=this.nbIterations+1;if(this.composers[p])this.composers[p].setSize(this.width,2*this.height);else{var u=new e.WebGLRenderTargetProperties(this.width,2*this.height,"uint");u.generateMipmaps=!1,this.composers[p]=new t(this.renderer,u,this.rtPool),this.composers[p].composerContext.keepResult=!1,this.composers[p].composerContext.noIdCheck=!0,this.passDisplayMap=new i(r,void 0,"DisplayMips"),this.composers[p].composerContext.setPassRenderToCanvas(this.passDisplayMap,!0),this.composers[p].addPass(this.passDisplayMap),this.composers[this.nbIterations].linkToShaderPassUniform(this.passDisplayMap,this.passDisplayMap.uniforms.tDiffuse1)}}},execute:function(){this.composers[this.nbIterations].render()},getResult:function(){return this.composers[this.nbIterations]},renderToScreen:function(){this.composers[this.nbIterations+1].render()}})}),define("DS/Effects/VolumeRenderingEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Node3D","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/VolumeRenderingShaders","DS/Shaders/NothingShader"],function(e,s,t,i,a,r,n,h){"use strict";var o=function(e,s){for(var t=s||1;t<e;)t*=2;return t},l=function(s,t){for(var i=new Uint8Array(16),a=0;a<4;a++)i[4*a]=0,i[4*a+1]=0,i[4*a+2]=0,i[4*a+3]=t?0:255;var r=new e.DataTexture(i,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter);return r.generateMipmaps=!1,r.needsUpdate=!0,s.setTexture(r,0),r};return i.extend({init:function(s,t,i){this._parent(s);this.debugInfos=!1,this.renderIsoSurface=!1,this.viewMatrix=new e.Matrix4,this.viewpoint=null;var h=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");return this.composers.push(new a(s,h,t)),this.composers[0].composerContext.keepResult=!0,this.initShaderPasses(i),this.mixPass=new r(n.Transfer,void 0,"VolumeRenderingEffect"),this.initTexture=l(this.renderer,!1),this.initTextureIso=l(this.renderer,!0),this.volumeManager=null,this.tmpResult=null,this.renderTargetPool=t,this.debugChunkBox=!1,this.debugChunkRepartition=[0,0,0,0,0,0,0],this.minDensity=0,this.maxDensity=0,this.avgDensity=0,this.costScore=0,this},initShaderPasses:function(t){var i=s.getWebappsAssetUrl("Effects",""),a=new e.ImageUtils.loadTexture(i+"SSAORandom.png",void 0,null,null,e.ImageUtils.crossOriginPolicy);a.minFilter=e.LinearFilter,a.magFilter=e.LinearFilter;var h=4;this.effectVolumePasses=[];for(var l=0;l<7;l++){var p=h*o(Math.ceil(Math.sqrt(h))),u=new r(n.RenderChunk),c=u.material.defines;c.MAX_STEPS=Math.min(4*h,256),c.CHUNK_SIZE=h+".0",c.MAP_INVSIZE=1/p,c.USE_CLIP_PLANE=!1,c.RANDOM_STEP=!t,u.uniforms.tRandomTexture.value=a,u.compileShader(this.renderer),this.effectVolumePasses.push(u),this.composers[0].addPass(u),h*=2}},initEffect:function(e,s){for(var t=s.getComposer("normalDepth"),i=0;i<this.effectVolumePasses.length;i++){var a=this.effectVolumePasses[i];t.linkToShaderPassUniform(a,a.uniforms.tNormalDepth)}s.insertComposer(null,this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2)},setRenderType:function(e){if(e!==this.renderIsoSurface){this.renderIsoSurface=e;for(var s=0;s<7;s++){var t=this.effectVolumePasses[s];t.material.defines.ISO_SURFACE=e?1:0,t.compileShader(this.renderer)}this.mixPass.material.defines.ISO_SURFACE=e?1:0,this.mixPass.compileShader(this.renderer)}},update:function(s,t,i,a){this.volumeManager.update(i),this.viewpoint=i,i._renderedCamera.matrixWorldInverse.getInverse(i._renderedCamera.matrixWorld),i._renderedCamera.projectionMatrixInverse.getInverse(i._renderedCamera.projectionMatrix);for(var r=0;r<this.effectVolumePasses.length;r++){var n=this.effectVolumePasses[r];if(n.uniforms.realProjectionMatrix.value.copy(i._renderedCamera.projectionMatrix),n.uniforms.realProjectionMatrixInverse.value.copy(i._renderedCamera.projectionMatrixInverse),this.viewMatrix.copy(i._renderedCamera.matrixWorldInverse),n.uniforms.colorMap.value=this.volumeManager.colorMap,n.uniforms.transferFctMap.value=this.volumeManager.transferFunctionMap,n.uniforms.renderIteration.value=a,null!==this.volumeManager.clipPlane){var h=(new e.Plane).copy(this.volumeManager.clipPlane);h.applyMatrix4(i._renderedCamera.matrixWorldInverse),n.uniforms.clipPlaneEquation.value.set(h.normal.x,h.normal.y,h.normal.z,h.constant)}}},setAttenuation:function(e){for(var s=0;s<this.effectVolumePasses.length;s++){this.effectVolumePasses[s].uniforms.attenuationCoeff.value=e}},setAttenuationScale:function(e){for(var s=0;s<this.effectVolumePasses.length;s++){this.effectVolumePasses[s].uniforms.attenuationScale.value=e}},setIsoValue:function(e){for(var s=0;s<this.effectVolumePasses.length;s++){this.effectVolumePasses[s].uniforms.isoValue.value=e}},setDebugInfos:function(e){this.debugInfos=e},addChunkToRepartition:function(e){this.volumeManager.updateBinnedValues(e);for(var s=0,t=4;e.data.mapDim.x>t||e.data.mapDim.y>t||e.data.mapDim.z>t;)s++,t*=2;this.debugChunkRepartition[s]++;var i=0;if(this.volumeManager.camera){var a=this.volumeManager.computeChunkVoxelDensity(this.volumeManager.camera,e);i=Math.PI*a*a}1/e.data._voxelDensity>this.maxDensity&&(this.maxDensity=1/e.data._voxelDensity),1/e.data._voxelDensity<this.minDensity&&(this.minDensity=1/e.data._voxelDensity),this.avgDensity+=1/e.data._voxelDensity;var r=e.data.chunkSize;Math.log2(r);this.costScore+=i*Math.min(256,4*e.data.chunkSize)},execute:function(){var s=new e.Matrix4;if(this.debugChunkRepartition=[0,0,0,0,0,0,0],this.minDensity=1/0,this.maxDensity=-1/0,this.avgDensity=0,this.costScore=0,this.debugInfos&&this.volumeManager){for(var t=0;t<256;t++)this.volumeManager.binnedValues[t]=0;this.volumeManager.binnedMaxValue=0}var i=this.viewpoint?this.viewpoint._renderedCamera:null;if(i){var a=new e.Frustum,r=new e.Matrix4;r.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),a.setFromMatrix(r);for(t=0;t<this.volumeManager.volumeChunks.length;t++){var n=this.volumeManager.volumeChunks[t],h=n.data;if(h)if(a.performFrustumCullingNoNearFar(h.radius,h.position)){this.debugInfos&&this.addChunkToRepartition(n);var o=n.data.chunkSize,l=(n.lod,h.modelMatrix),p=Math.log2(o)-2,u=this.effectVolumePasses[p];if(u.uniforms.gridSize.value.copy(h.gridSize),s.multiplyMatrices(this.viewMatrix,l),u.uniforms.realModelViewMatrix.value.copy(s),u.uniforms.realModelViewMatrixInverse.value.getInverse(s),h.map||(h.map=this.volumeManager.getFreeTexture(n),h.map.image=h.mapData,h.map.needsUpdate=!0),u.uniforms.map0.value=h.map,u.uniforms.minDisplayValue.value=this.volumeManager.minValue,u.uniforms.maxDisplayValue.value=this.volumeManager.maxValue,u.uniforms.rangeDisplayValue.value=this.volumeManager.maxValue-this.volumeManager.minValue,u.uniforms.minTileValue.value=n.data.tileSetRange.min,u.uniforms.maxTileValue.value=n.data.tileSetRange.max,u.uniforms.rangeTileValue.value=n.data.tileSetRange.max-n.data.tileSetRange.min,u.uniforms.mapDim.value.copy(h.mapDim),u.uniforms.nbCol.value=h.nbCol,this.debugChunkBox){u.uniforms.debugChunkBox.value.set(.01,.01,.01,.05)}else u.uniforms.debugChunkBox.value.set(0,0,0,0);t?(this.tmpResult=this.composers[0].composerContext.getResult("main",!0),u.uniforms.prevMap.value=this.tmpResult):u.uniforms.prevMap.value=this.renderIsoSurface?this.initTextureIso:this.initTexture,this.activatePass(u),this.composers[0].render(void 0,void 0,void 0,"main"),this.tmpResult&&(this.renderTargetPool.pushRenderTarget(this.tmpResult),this.tmpResult=null)}}this.avgDensity/=this.volumeManager.volumeChunks.length,this.debugInfos&&this.volumeManager&&this.volumeManager.updateBinnedMap()}},activatePass:function(e){for(var s=0;s<this.effectVolumePasses.length;s++){var t=this.effectVolumePasses[s];this.composers[0].enablePass(t,t===e)}},setSize:function(e,s){this._parent(e,s)&&this.composers[0].setSize(this.width,this.height)}})}),define("DS/Effects/ComputeMipMapRoughness",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/PreComputeShaders","DS/Shaders/DisplayMipsRoughnessShader","DS/Shaders/EncodeHDRShader","DS/Shaders/FlipXShader"],function(e,s,t,i,a,r,n,h){"use strict";var o=s.extend({init:function(s,t){return this._parent(s),this.gl=this.renderer.context,this.renderTargetPool=t,this.nbSamples=64,this.nbIterations=32,this._nbSamplerPerIteration=e._mobileDevice?4:e.IsIE11?2:32,this._sizeRatio=e._mobileDevice?.5:1,this.passFilterEnvMap=[],this.passMergeMips=null,this.passFlipX=null,this.modeValue=0,this.shader=null,this.texture=null,this.nbMipMaps=7,this.inputLods=10,this},setSize:function(s,t){this.width="string"==typeof s?parseInt(s):s,this.height="string"==typeof t?parseInt(t):t,this.inputLods=Math.min(Math.round(Math.log(Math.min(this.width,this.height))/Math.log(2)),e.supportedExtensions.fragmentTextureUnits)},_updatePassFilter:function(e){var s=this.getCoeff(e+1);this.passFilterEnvMap[e].material.defines.NB_SAMPLES=s*this.nbSamples,this.passFilterEnvMap[e].material.defines.NB_SAMPLES_IT=s*this._nbSamplerPerIteration,this.passFilterEnvMap[e].uniforms.tEnvMap.value=this.texture,this.passFilterEnvMap[e].material.defines.MAX_LOD=this.inputLods,this.passFilterEnvMap[e].material.defines.MODE=6===e?3:this.modeValue,this.passFilterEnvMap[e].material.defines.LOD_CST=(.5*Math.log(this.width*this.height/(s*this.nbSamples))/Math.log(2)).toFixed(8),this.passFilterEnvMap[e].material.needsUpdate=!0,this.passFilterEnvMap[e].uniforms.roughness.value=this.getRoughness(e+1)},setNbSamples:function(e){this.nbSamples=e,this.nbIterations=this.nbSamples/this._nbSamplerPerIteration;for(var s=1;s<=this.nbMipMaps;s++)this._updatePassFilter(s-1)},getCoeff:function(e){return 1===this.modeValue||4===this.modeValue?e<3?3:2:e>3?4:1},getRoughness:function(e){var s=0;switch(this.modeValue){case 0:case 3:s=Math.pow(2,(e-6)/1.15);break;case 1:case 4:s=1-(e-1)/5;break;case 2:s=(e-1)/5;break;default:throw"invalid mode in compute mip map roughness effect"}return s},setMode:function(s){switch(this.modeValue=0,s){case e._BRDFS.ASHIKMIN:this.modeValue=1;break;case e._BRDFS.BECKMANN:this.modeValue=2;break;case e._BRDFS.ESTEVEZKULLA:this.modeValue=4}for(var t=1;t<=this.nbMipMaps;t++)this._updatePassFilter(t-1)},setInput:function(s){if(!this.texture){this.texture=s,this.hasOwnProperty("iter")&&(this.iter=0);for(var a=[1,1,.5,.5,.25,.25,.25,.25],r=1;r<=this.nbMipMaps;r++){var n=r-1,h=this._sizeRatio*a[r]*this.width,o=this._sizeRatio*a[r]*this.height;if(this.composers[n])this.composers[n].setSize(h,o);else{var l=new e.WebGLRenderTargetProperties(h,o,"iblLinear");l.generateMipmaps=!1,l.mapping=this.texture.mapping,this.composers[n]=new t(this.renderer,l,this.renderTargetPool),this.composers[n].composerContext.keepResult=!0,this.composers[n].composerContext.noIdCheck=!0;var p={};Object.assign(p,this.shader),this.passFilterEnvMap[n]=new i(p),this.composers[n].addPass(this.passFilterEnvMap[n])}this._updatePassFilter(n)}this.setComposers()}},setComposers:function(){var s=this.nbMipMaps;if(this.composers[s])this.composers[s].setSize(this._sizeRatio*this.width,2*this._sizeRatio*this.height);else{var a=new e.WebGLRenderTargetProperties(this._sizeRatio*this.width,2*this._sizeRatio*this.height,"uintNearest");a.generateMipmaps=!1,this.composers[s]=new t(this.renderer,a,this.renderTargetPool),this.composers[s].composerContext.keepResult=!0,this.composers[s].composerContext.noIdCheck=!0,this.passMergeMips=new i(r.MergeMipsRGBE),this.passMergeMips.renderToScreen=!1,this.passFlipX=new i(h),this.composers[s].addPass(this.passMergeMips),this.composers[s].addPass(this.passFlipX);for(var n=1;n<=this.nbMipMaps;n++){var o=n-1;this.composers[o].linkToShaderPassUniform(this.passMergeMips,this.passMergeMips.uniforms["tDiffuse"+n])}}},dispose:function(){s.prototype.dispose.call(this),this.texture&&this.texture.dispose()},_saveResult:function(){var s=this._sizeRatio*this.width,t=2*this._sizeRatio*this.height,i=new Uint8Array(s*t*4);this.gl.readPixels(0,0,s,t,this.gl.RGBA,this.gl.UNSIGNED_BYTE,i);var a=e.ImageUtils.streamHDRFormat(i,s,t),r=URL.createObjectURL(a),n=document.createElement("a");n.download="generated_rmips.hdr",n.href=r,e._DownloadGeneratedRoughnessMaps&&n.click()}});return{ComputeMipMapRoughnessFIS:o.extend({init:function(e,s){return this._parent(e,s),this.shader=a.ComputeMipMapRoughnessFIS,this},execute:function(e){if(void 0!==e)this.composers[e].render();else{for(var s=0;s<this.nbMipMaps;s++)this.modeValue>0&&6===s||this.execute(s);this.composers[this.nbMipMaps].render()}}}),ComputeMipMapRoughnessIterative:o.extend({init:function(s,t){this._parent(s,t),this.iter=0,this.shader=a.ComputeMipMapRoughnessIterative;for(var i=new Uint8Array(16),r=0;r<16;r++)i[r]=0;return this.initTexture=new e.DataTexture(i,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter),this.initTexture.generateMipmaps=!1,this.initTexture.needsUpdate=!0,this.renderer.setTexture(this.initTexture,0),this},execute:function(e){if(!(this.iter>=this.nbIterations)){var s=this.iter;if(void 0!==e){var t=this.composers[e].composerContext.getResult(void 0,!0);this.passFilterEnvMap[e].uniforms.prevMap.value=s?t:this.initTexture,this.passFilterEnvMap[e].uniforms.firstSample.value=s*this.passFilterEnvMap[e].defines.NB_SAMPLES_IT,this.composers[e].render(),t&&(s===this.nbIterations-1?t.dispose():this.renderTargetPool.pushRenderTarget(t))}else{for(var i=0;i<this.nbMipMaps;i++)this.modeValue>0&&6===i||this.execute(i);this.iter++,this.composers[this.nbMipMaps].render()}}}})}}),define("DS/Effects/BloomsEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/BloomShaders","DS/Plugins/ClearPass"],function(e,s,t,i,a,r,n){"use strict";return s.extend({init:function(s,t,r){this._parent(s),this.renderer=s,this.rtPool=t,this._initBloom=0,this.useOldBloom=!!r,this.nbIterations=r?5:4,this.nbBlurs=2,this.nbBlurSamples=6,this.bloomFactor=r?.9:.4,this.threshold=r?.626:.9,this.kernels=[],this.kernels[0]=[.02275,.9545,.02275],this.kernels[1]=[.00135,.157305,.68269,.157305,.00135],this.kernels[2]=[428e-6,.022321,.229743,.495016,.229743,.022321,428e-6],this.kernels[3]=[229e-6,.005977,.060598,.241732,.382928,.241732,.060598,.005977,229e-6],this.kernels[4]=[154e-6,.002396,.020195,.092321,.229511,.310847,.229511,.092321,.020195,.002396,154e-6],this.kernels[5]=[116e-6,.001227,.008466,.037976,.110867,.210789,.261121,.210789,.110867,.037976,.008466,.001227,116e-6],this.kernels[6]=[93e-6,735e-6,.004228,.017686,.053815,.119121,.191869,.224907,.191869,.119121,.053815,.017686,.004228,735e-6,93e-6],this.kernels[7]=[78e-6,489e-6,.002403,.009245,.027835,.065592,.12098,.17467,.197417,.17467,.12098,.065592,.027835,.009245,.002403,489e-6,78e-6],this.kernels[8]=[67e-6,35e-5,.001504,.005321,.015497,.037158,.073355,.119235,.159582,.175863,.159582,.119235,.073355,.037158,.015497,.005321,.001504,35e-5,67e-6],this.mixPass=new i(a.MixShader,void 0,"bloomPass"),this.mixPass.material.blending=e.NoBlending,this.mixPass.gammaCorrectionPass=!0,this.passBlurH=null,this.passBlurV=null,this.passDownScale=null,this.passUpScale=null,this.finalBloomPass=null,this.passThreshold=null,this.sharedRTParams=[],this.sharedRT=[];var n=new e.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear");return this.mixPass.changeRenderTargetProperties=n,this.defines={USE_BLOOM:1},this.mixPass.material.defines=this.defines,this._buildBloomRT(),this.updateRequiredComposers(),this.setBloomFactor(this.bloomFactor),this.setBloomThreshold(this.threshold),this},initEffect:function(e,s){s.insertComposer(null,this.mixPass)},update:function(e,s,t){},updateRequiredComposers:function(){this.mixPass.requiredComposers=[],this.useOldBloom?this.mixPass.addRequiredComposer(this.composers[5]):this.mixPass.addRequiredComposer(this.composers[2*this.nbIterations])},setBeforeRenderCallback:function(){var e,s=this;e=function(e){s.passThreshold.uniforms.tDiffuse2.value=e},this.mixPass.beforeRenderCB=e},setOldBloomUse:function(e){this.useOldBloom!=e&&(this.useOldBloom=e,this.nbIterations=this.useOldBloom?5:4,this.bloomFactor=this.useOldBloom?.9:.4,this.threshold=this.useOldBloom?.626:.9,this.defines.USE_BLOOM=this.useOldBloom?2:1,this.mixPass.material.defines=this.defines,this.mixPass.material.needsUpdate=!0,this.setBloomFactor(this.bloomFactor),this.setBloomThreshold(this.threshold),this._buildBloomRT(),this.updateRequiredComposers())},_setBloom:function(e){var s=e.nbIterations?e.nbIterations:4;this.nbIterations!=s&&(this.nbIterations=s,this._initBloom&&(this._initBloom=0,this._buildBloomRT(),this.updateRequiredComposers())),this.bloomFactor=e.bloomFactor?e.bloomFactor:.4,this.threshold=e.threshold?e.threshold:.9,this.setBloomFactor(this.bloomFactor),this.setBloomThreshold(this.threshold)},setBloomFactor:function(e){this.bloomFactor=e,this.useOldBloom?this.mixPass.uniforms.bloomFactor.value=e:this.mixPass.uniforms.bloomFactor.value=this.bloomFactor/(this.nbIterations+1)},setBloomThreshold:function(e){this.useOldBloom&&(e=Math.min(e,1)),this.passThreshold&&(this.passThreshold.uniforms.threshold.value=e),this.threshold=e},setSize:function(e,s){if(this._parent(e,s)){var t,i=.5,a=Math.max(1,i*this.width),r=Math.max(1,i*this.height);if(this.useOldBloom)for(this.composers[0].setSize(a,r),t=1;t<=this.nbIterations;t++)this.composers[t].setSize(a,r),this.passBlurH[t].uniforms.invSize.value.set(1/a,1/r),this.passBlurV[t].uniforms.invSize.value.set(1/a,1/r),i*=.5,a=Math.max(1,i*this.width),r=Math.max(1,i*this.height);else for(this.composers[0].setSize(this.width,this.height),this.composers[2*this.nbIterations].setSize(this.width,this.height),this.passThreshold.uniforms.invSize.value.set(1/this.width,1/this.height),this.finalBloomPass.uniforms.invSize.value.set(1/a,1/r),t=1;t<=this.nbIterations;t++){if(t!=this.nbIterations){var n=this.sharedRTParams[t-1];n.width=a,n.height=r}else this.composers[t].setSize(a,r);if(this.passDownScale[t-1].uniforms.invSize.value.set(1/(2*a),1/(2*r)),i*=.5,a=Math.max(1,i*this.width),r=Math.max(1,i*this.height),t!=this.nbIterations&&this.passUpScale[this.nbIterations-t-1].uniforms.invSize.value.set(1/a,1/r),t==this.nbIterations)for(var h=0;h<this.nbBlurs;h++)this.passBlurH[h].uniforms.ratio.value=this.width>this.height?this.height/this.width:1,this.passBlurV[h].uniforms.ratio.value=this.width>this.height?1:this.width/this.height}}},_buildBloomRT:function(s){if(!(this._initBloom>0&&(2==this._initBloom&&this.useOldBloom||1==this._initBloom&&!this.useOldBloom))){if(this._initBloom=this.useOldBloom?2:1,this.useOldBloom){var r=.5;this.passBlurH=[],this.passBlurV=[];var n=Math.max(1,r*this.width),h=Math.max(1,r*this.height),o=new e.WebGLRenderTargetProperties(n,h,"uint");this.composers[0]=new t(this.renderer,o,this.rtPool),this.composers[0].composerContext.name="ThresholdComposerContext",this.passThreshold=new i(a.Threshold,void 0,"Threshold"),this.passThreshold.uniforms.threshold.value=this.threshold,this.passThreshold.material.defines={OLD_BLOOM:1},this.composers[0].addPass(this.passThreshold);for(var l=1;l<=this.nbIterations;l++){o=new e.WebGLRenderTargetProperties(n,r*this.height,"uint");this.composers[l]=new t(this.renderer,o,this.rtPool),this.composers[l].composerContext.name="Blur"+l+"ComposerContext",this.passBlurH[l]=new i(a.BlurH2,void 0,"BlurH2"+l),this.passBlurV[l]=new i(a.BlurV,void 0,"BlurV"+l),this.passBlurH[l].material.defines={LEVEL:l},this.passBlurV[l].material.defines={LEVEL:l},this.passBlurH[l].uniforms.invSize.value.set(1/n,1/h),this.passBlurV[l].uniforms.invSize.value.set(1/n,1/h),this.passBlurH[l].material.needsUpdate=!0,this.passBlurV[l].material.needsUpdate=!0,this.composers[l].addPass(this.passBlurH[l]),this.composers[l].addPass(this.passBlurV[l]),r*=.5,n=Math.max(1,r*this.width),h=Math.max(1,r*this.height)}this.passBlurH[1].addRequiredComposer(this.composers[0]),this.passBlurH[2].addRequiredComposer(this.composers[1]),this.passBlurH[3].addRequiredComposer(this.composers[2]),this.passBlurH[4].addRequiredComposer(this.composers[3]),this.passBlurH[5].addRequiredComposer(this.composers[4]),this.composers[0].linkToShaderPassUniform(this.passBlurH[1],this.passBlurH[1].uniforms.tDiffuse2),this.composers[1].linkToShaderPassUniform(this.passBlurH[2],this.passBlurH[2].uniforms.tDiffuse2),this.composers[2].linkToShaderPassUniform(this.passBlurH[3],this.passBlurH[3].uniforms.tDiffuse2),this.composers[3].linkToShaderPassUniform(this.passBlurH[4],this.passBlurH[4].uniforms.tDiffuse2),this.composers[4].linkToShaderPassUniform(this.passBlurH[5],this.passBlurH[5].uniforms.tDiffuse2),this.composers[1].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.composers[2].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse3),this.composers[3].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse4),this.composers[4].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse5),this.composers[5].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse6)}else{r=.5,n=Math.max(1,r*this.width),h=Math.max(1,r*this.height);var p=2*this.nbIterations;this.passDownScale=[],this.passBlurH=[],this.passBlurV=[],this.passUpScale=[];o=new e.WebGLRenderTargetProperties(this.width,this.height,"halfLinear");this.composers[0]=new t(this.renderer,o,this.rtPool),this.composers[0].composerContext.name="ThresholdComposerContext",this.passThreshold=new i(a.Threshold,void 0,"Threshold"),this.passThreshold.uniforms.threshold.value=this.threshold,this.passThreshold.uniforms.invSize.value.set(1/this.width,1/this.height),this.composers[0].addPass(this.passThreshold),this.composers[p]=new t(this.renderer,o,this.rtPool),this.composers[p].composerContext.name="UpReplaceComposerContext",this.finalBloomPass=new i(a.UpReplace,void 0,"UpReplace"),this.finalBloomPass.uniforms.invSize.value.set(1/n,1/h),this.composers[p].addPass(this.finalBloomPass);var u=function(e,s,t){e.composers[s].composerContext.setBeforeRenderCB(function(e){e.writeBuffer=S.sharedRT[t]})},c=function(e,s,t){e.composers[s].composerContext.setBeforeRenderCB(function(s){var i=e.sharedRTParams[t];e.sharedRT[t]=e.rtPool.buildRenderTarget(i.width,i.height,i.options),s.writeBuffer=S.sharedRT[t]})};for(l=1;l<=this.nbIterations;l++){var d=l,m=l-1,f=p-l,g=this.nbIterations-l-1;this.passDownScale[m]=new i(a.Down,void 0,"Downscale"+m),this.passDownScale[m].uniforms.invSize.value.set(1/(2*n),1/(2*h));o=new e.WebGLRenderTargetProperties(n,h,"halfLinear");this.sharedRTParams[m]=o,this.composers[d]=new t(this.renderer,o,this.rtPool),this.composers[d].composerContext.name="Downscale"+m+"ComposerContext";var S=this;if(d!=this.nbIterations&&(this.composers[d].composerContext.renderTargetProperties=null,this.composers[d].composerContext.originalRenderTargetProperties=null,u(this,d,m)),this.composers[d].addPass(this.passDownScale[m]),d==this.nbIterations)for(var P=0;P<this.nbBlurs;P++)this.passBlurH[P]=new i(a.Blur,void 0,"BlurH"+P),this.passBlurV[P]=new i(a.Blur,void 0,"BlurV"+P),this.passBlurH[P].material.defines={LEVEL:this.nbBlurSamples-1},this.passBlurV[P].material.defines={LEVEL:this.nbBlurSamples-1},this.passBlurH[P].uniforms.ratio.value=this.width>this.height?this.height/this.width:1,this.passBlurV[P].uniforms.ratio.value=this.width>this.height?1:this.width/this.height,this.passBlurH[P].uniforms.blurSize.value=.1,this.passBlurV[P].uniforms.blurSize.value=.1,this.passBlurH[P].uniforms.direction.value.set(1,0),this.passBlurV[P].uniforms.direction.value.set(0,1),this.passBlurH[P].uniforms.kernel.value=this.kernels[this.nbBlurSamples-2],this.passBlurV[P].uniforms.kernel.value=this.kernels[this.nbBlurSamples-2],this.passBlurH[P].material.needsUpdate=!0,this.passBlurV[P].material.needsUpdate=!0,this.composers[d].addPass(this.passBlurH[P]),this.composers[d].addPass(this.passBlurV[P]);else r*=.5,n=Math.max(1,r*this.width),h=Math.max(1,r*this.height),this.passUpScale[g]=new i(a.UpReplace,void 0,"UpReplace"+g),this.passUpScale[g].material.blending=e.CustomBlending,this.passUpScale[g].material.blendEquation=e.AddEquation,this.passUpScale[g].material.blendSrc=e.OneFactor,this.passUpScale[g].material.blendDst=e.OneFactor,this.passUpScale[g].material.useBlending=!0,this.passUpScale[g].uniforms.invSize.value.set(1/n,1/h),this.composers[f]=new t(this.renderer,o,this.rtPool),this.composers[f].composerContext.renderTargetProperties=null,this.composers[f].composerContext.originalRenderTargetProperties=null,this.composers[f].composerContext.name="UpReplace"+g+"ComposerContext",c(this,f,m),this.composers[f].addPass(this.passUpScale[g]);this.passDownScale[m].addRequiredComposer(this.composers[d-1]),this.composers[d-1].linkToShaderPassUniform(this.passDownScale[m],this.passDownScale[m].uniforms.tDiffuse2)}for(l=1;l<this.nbIterations;l++){f=p-l,g=this.nbIterations-l-1;this.passUpScale[g].addRequiredComposer(this.composers[f-1]),this.composers[f-1].linkToShaderPassUniform(this.passUpScale[g],this.passUpScale[g].uniforms.tDiffuse2)}this.finalBloomPass.addRequiredComposer(this.composers[p-1]),this.composers[p-1].linkToShaderPassUniform(this.finalBloomPass,this.finalBloomPass.uniforms.tDiffuse2),this.composers[p].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2)}this.setBeforeRenderCallback()}}})}),define("DS/Effects/ConvertLatLongToDualParaboloid",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/ConvertLatLongToDualParaboloidShader","DS/Shaders/DisplayIrradianceMapShader"],function(e,s,t,i,a,r){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=s,this.passConvert=null,this.texture=null,this.passDualParaboloidMap=null,this},setSize:function(e,s){this.width="string"==typeof e?parseInt(e):e,this.height="string"==typeof s?parseInt(s):s},setEnvMap:function(s){if(this.texture=s,this.texture instanceof e.Texture){var r=parseInt(this.texture.image.width),n=parseInt(this.texture.image.height);this.width=r,this.height=n}if(this.composers[0])this.composers[0].setSize(this.width,this.height);else{var h=new e.WebGLRenderTargetProperties(this.width,this.height,"iblLinear");h.generateMipmaps=!1,h.mapping=e.LatLongReflectionMapping,this.composers[0]=new t(this.renderer,h,this.renderTargetPool),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.noIdCheck=!0;var o=this.texture.sRGB?a.ConvertLatLongToDualParaboloidsRGB:a.ConvertLatLongToDualParaboloid;this.texture instanceof t||this.texture.rgbHdr||(o=this.texture.sRGB?a.ConvertLatLongRGBEToDualParaboloidsRGB:a.ConvertLatLongRGBEToDualParaboloid),this.passConvert=new i({defines:{SCALE:1.2},uniforms:o.uniforms,vertexShader:o.vertexShader,fragmentShader:o.fragmentShader},void 0,"Convert"),this.composers[0].addPass(this.passConvert)}this.texture instanceof e.Texture||this.texture instanceof e.WebGLRenderTarget?this.passConvert.uniforms.map.value=this.texture:this.texture.linkToShaderPassUniform(this.passConvert,this.passConvert.uniforms.map),this.passConvert.uniforms.size.value=new e.Vector2(this.width,this.height)},execute:function(){this.composers[0].render()}})}),define("DS/Effects/DownSamplingEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/DownSamplingShaders","DS/Plugins/ClearPass"],function(e,s,t,i,a,r){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.renderer=e,this.rtPool=s,this.map=null,this.nbIterations=3,this.passBlurH=[],this},setSize:function(e,s){this.width=parseInt(e),this.height=parseInt(s)},setInput:function(s){if(s){this.map=s;var r=.5;if(this.composers[0])for(var n=0;n<this.nbIterations;n++)this.composers[n].setSize(r*this.width,r*this.height),this.passBlurH[n].uniforms.invSize.value.set(1/(r*this.width),1/(r*this.height)),r*=.5;else{for(n=0;n<this.nbIterations;n++){var h=new e.WebGLRenderTargetProperties(r*this.width,r*this.height,"uint");this.composers[n]=new t(this.renderer,h,this.rtPool),this.composers[n].composerContext.keepResult=!1,this.passBlurH[n]=new i(a.DownSampling),this.passBlurH[n].uniforms.invSize.value.set(1/(r*this.width),1/(r*this.height)),this.passBlurH[n].material.needsUpdate=!0,this.passBlurH[n].renderToScreen=!1,this.composers[n].addPass(this.passBlurH[n]),r*=.5}this.composers[this.nbIterations-1].composerContext.keepResult=!1;for(n=1;n<this.nbIterations;n++)this.passBlurH[n].addRequiredComposer(this.composers[n-1]),this.composers[n-1].linkToShaderPassUniform(this.passBlurH[n],this.passBlurH[n].uniforms.tDiffuse2)}this.map.linkToShaderPassUniform(this.passBlurH[0],this.passBlurH[0].uniforms.tDiffuse2)}},execute:function(){this.composers[this.nbIterations-1].render()}})}),define("DS/Effects/MergeMainMipsEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/DisplayMipsRoughnessShader"],function(e,s,t,i,a){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=s,this.passMerge=null,this},setTextures:function(s,r,n,h){var o=r.composerContext&&r.composerContext.width,l=r.composerContext&&r.composerContext.height;if(r instanceof e.Texture?(o=r.image.width,l=r.image.height):r instanceof e.WebGLRenderTarget&&(o=r.width,l=r.height),this.width=parseInt(o),this.height=parseInt(l),this.composers.length)this.composers[0].setSize(this.width,2*this.height);else{var p=new e.WebGLRenderTargetProperties(this.width,2*this.height,"uint");p.generateMipmaps=!1,this.composers[0]=new t(this.renderer,p,this.renderTargetPool),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.noIdCheck=!0;var u=a.MergeCustomMips;this.passMerge=new i({defines:u.defines,uniforms:u.uniforms,vertexShader:u.vertexShader,fragmentShader:u.fragmentShader},void 0,"Merge Main Roughness Map"),this.composers[0].addPass(this.passMerge)}this.passMerge.uniforms.size0.value.set(this.width,this.height),this.passMerge.uniforms.tDiffuse0.value=r;for(var c=0;c<s.length;c++)this.passMerge.uniforms["tDiffuse"+(c+1)].value=s[c],this.passMerge.uniforms["size"+(c+1)].value.set(parseInt(s[c].image.width),parseInt(s[c].image.height));this.passMerge.defines.MIP_OFFSET=n?0:1,this.passMerge.defines.ZERO_RBGE=r instanceof t||r.rgbHdr?0:1,"LINEAR"===h&&(this.passMerge.defines.MAPPING=0),"NON_LINEAR"===h&&(this.passMerge.defines.MAPPING=1),"INVERSE_LINEAR"===h&&(this.passMerge.defines.MAPPING=2),"INVERSE_NON_LINEAR"===h&&(this.passMerge.defines.MAPPING=3),this.passMerge.material.needsUpdate=!0},execute:function(){this.composers[0].render();var s=this.composers[0].composerContext.getResult(void 0,!0);return s.hdr=!0,s.hasDiffuse=!0,s.mapping=new e.LatLongReflectionMapping,s}})}),define("DS/Effects/BlurShadowEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/BloomShaders","DS/Plugins/ClearPass"],function(e,s,t,i,a,r){"use strict";var n={uniforms:{tDiffuse2:{type:"t",value:null},shadowMatrix:{type:"m4",value:new e.Matrix4},intensity:{type:"f",value:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;",e._DefaultShaderChunk.model_view_projection_transformation_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse2;","uniform mat4 shadowMatrix;","uniform float intensity;","varying vec2 vUv;","float unpackDepth( const in vec4 rgba_depth ) {","float depth=1.0;","#if IS_ESM == 1","   #ifdef USE_UINT_ESM","\t    depth = log(unpackRGB( rgba_depth.xyz) * pow(10.0,rgba_depth.w*255.0))/80.0;","   #else","       depth = log(rgba_depth.x)/80.0;","  #endif","#else","       depth = unpackRGBA(rgba_depth);","#endif","return depth;","}","void main() {","gl_FragColor = vec4(1.0);","vec4 mpos = vec4(vUv, 0.0, 1.0);","vec4 shadowCoord = shadowMatrix * mpos;","shadowCoord.xyz /= shadowCoord.w;","float shadowDepth = unpackDepth(texture2D(tDiffuse2, shadowCoord.xy));","if (shadowDepth < 1.0) {","  gl_FragColor.x = intensity;","}","}"].join("\n")};return s.extend({init:function(e,s){return this._parent(e),this.renderer=e,this.rtPool=s,n.defines={IS_ESM:0},this.map=null,this.intensity=.5,this.passShadow=null,this.passBlurH=null,this.passBlurV=null,this},setSize:function(e,s){this.width=parseInt(e),this.height=parseInt(s)},setIntensity:function(e){this.intensity=1-e,this.passShadow.uniforms.intensity.value=this.intensity},setInput:function(s,h){if(s){if(this.map=s,this.composers[0])this.composers[0].setSize(this.width,this.height),this.passBlurH.uniforms.invSize.value.set(1/this.width,1/this.height),this.passBlurV.uniforms.invSize.value.set(1/this.width,1/this.height);else{var o=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers[0]=new t(this.renderer,o,this.rtPool),this.composers[0].composerContext.keepResult=!1,this.clearPass=new r("groundShadowClearPass"),this.passShadow=new i(n,void 0,"GroundShadowEffect"),this.passBlurH=new i(a.BlurH,void 0,"GroundShadowEffectBlurH"),this.passBlurV=new i(a.BlurV,void 0,"GroundShadowEffectBlurV"),this.passBlurH.material.defines={LEVEL:5},this.passBlurV.material.defines={LEVEL:5},this.passBlurH.uniforms.invSize.value.set(1/this.width,1/this.height),this.passBlurV.uniforms.invSize.value.set(1/this.width,1/this.height),this.passBlurH.material.needsUpdate=!0,this.passBlurV.material.needsUpdate=!0,this.passBlurH.renderToScreen=!1,this.passBlurV.renderToScreen=!1,this.composers[0].addPass(this.clearPass),this.composers[0].addPass(this.passShadow),this.composers[0].addPass(this.passBlurH),this.composers[0].addPass(this.passBlurV),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.setPassClear(this.clearPass,!0,new e.Color(16777215),1)}this.passShadow.uniforms.tDiffuse2.value=this.map,this.passShadow.uniforms.shadowMatrix.value.copy(h)}},execute:function(){var s=this.renderer.shadowMapType===e.ESMShadowMap||this.renderer.shadowMapType===e.ESMImprovedShadowMap;s&&1!=this.passShadow.material.defines.IS_ESM&&(this.passShadow.material.defines.IS_ESM=1,this.passShadow.material.needsUpdate=!0),s||1!=this.passShadow.material.defines.IS_ESM||(this.passShadow.material.defines.IS_ESM=0,this.passShadow.material.needsUpdate=!0),this.composers[0].render(0,void 0,void 0,"toto")},getResult:function(){return this.composers[0].getRenderResult("toto")}})}),define("DS/Effects/ConvertCubemapToLatlong",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/NothingShader","DS/Shaders/ConvertCubemapToLatlongShader","DS/Shaders/DisplayIrradianceMapShader","DS/Shaders/EncodeHDRShader"],function(e,s,t,i,a,r,n,h){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=s,this.passConvert=null,this.texture=null,this.passDisplayLatlongMap=null,this.saveComposer=null,this.passEncodeHDR=null,this},setEnvMap:function(s,a){this.texture=s;var h;(this.width=2048,this.height=1024,this.composers[1])?this.composers[1].setSize(2048,1024):((h=new e.WebGLRenderTargetProperties(2048,1024,"linear")).generateMipmaps=!1,h.mapping=this.texture.mapping,this.composers[1]=new t(this.renderer,h,this.renderTargetPool),this.composers[1].composerContext.keepResult=!0,r.ConvertCubemapToLatlong.defines.ORIENTATION=a||0,this.passConvert=new i(r.ConvertCubemapToLatlong),this.composers[1].addPass(this.passConvert));(this.passConvert.uniforms.cubemap.value=this.texture,this.composers[0])?this.composers[0].setSize(this.width,this.height):((h=new e.WebGLRenderTargetProperties(this.width,this.height,"uint")).generateMipmaps=!1,h.mapping=this.texture.mapping,this.composers[0]=new t(this.renderer,h,this.renderTargetPool),this.composers[0].composerContext.keepResult=!1,this.passDisplayLatlongMap=new i(n),this.composers[0].composerContext.setPassRenderToCanvas(this.passDisplayLatlongMap,!0),this.composers[0].addPass(this.passDisplayLatlongMap),this.composers[1].linkToShaderPassUniform(this.passDisplayLatlongMap,this.passDisplayLatlongMap.uniforms.tDiffuse1))},execute:function(){this.composers[1].render()},getResult:function(s){var t=this.composers[1].composerContext.getResult(void 0,s);return t.hdr=!0,t.mapping=new e.LatLongReflectionMapping,t},getResultRGBE:function(s){this.encodeRGBE();var t=this.saveComposer.composerContext.getResult(void 0,s);return t.hdr=!0,t.mapping=new e.LatLongReflectionMapping,t},encodeRGBE:function(){var s=this.composers[1],a=s.composerContext.renderTargetProperties.width,r=s.composerContext.renderTargetProperties.height;if(this.saveComposer)this.saveComposer.setSize(a,r);else{var n=new e.WebGLRenderTargetProperties(a,r,"uintNearest");n.generateMipmaps=!1,n.mapping=this.texture.mapping,this.saveComposer=new t(this.renderer,n,this.renderTargetPool),this.saveComposer.composerContext.keepResult=!0,this.passEncodeHDR=new i(h),this.saveComposer.composerContext.setPassRenderToCanvas(this.passEncodeHDR,!1),this.saveComposer.addPass(this.passEncodeHDR)}this.passEncodeHDR.uniforms.map.value=s.composerContext.renderTarget2,this.saveComposer.render()}})}),define("DS/Effects/ESMEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/ESMBlurShader","DS/Plugins/ClearPass"],function(e,s,t,i,a,r){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.renderer=e,this.rtPool=s,this.map=null,this.passBlurH=null,this.passBlurV=null,this},setSize:function(e,s){this.width=parseInt(e),this.height=parseInt(s)},setInput:function(s){if(s){if(this.map=s,this.composers[0])this.composers[0].setSize(this.width,this.height),this.passBlurH.uniforms.invSize.value.set(1/this.width,1/this.height),this.passBlurV.uniforms.invSize.value.set(1/this.width,1/this.height);else{var r=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");this.composers[0]=new t(this.renderer,r,this.rtPool),this.composers[0].composerContext.keepResult=!0,this.passBlurH=new i(a.BlurH2),this.passBlurV=new i(a.BlurV);var n={LEVEL:3};this.passBlurH.material.defines=n,this.passBlurV.material.defines=n,this.passBlurH.uniforms.invSize.value.set(1/this.width,1/this.height),this.passBlurV.uniforms.invSize.value.set(1/this.width,1/this.height),this.passBlurH.material.needsUpdate=!0,this.passBlurV.material.needsUpdate=!0,this.passBlurH.renderToScreen=!1,this.passBlurV.renderToScreen=!1,this.composers[0].addPass(this.passBlurH),this.composers[0].addPass(this.passBlurV)}this.passBlurH.uniforms.tDiffuse2.value=this.map}},execute:function(){this.composers[0].render(0,void 0,void 0,"toto")},getResult:function(){return this.composers[0].getRenderResult("toto")}})}),define("DS/Effects/ComputeSkyScattering",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/SkyScatteringShaders","DS/Plugins/ClearPass"],function(e,s,t,i,a,r,n){"use strict";return t.extend({init:function(s,t){this._parent(s),this.renderer=s,this.rtPool=t,this.transmittanceWidth=256,this.transmittanceHeight=64,this.IrradianceWidth=1024,this.IrradianceHeight=1024,this.envmapWidth=2048,this.envmapHeight=1024,this.atmParams=null,this.loadTextureCallBacks=[],this.skyTransmittanceMap=null,this.skyScatteringMap=null,this.skyIrradianceMap=null,this.allTexturesReady=0,this.passTransmittance=null,this.passScattering=null,this.skyPass=null,this.mixPass=null;var n=new e.WebGLRenderTargetProperties(this.transmittanceWidth,this.transmittanceHeight,"linear");this.composers[0]=new i(this.renderer,n,this.rtPool),this.composers[0].composerContext.keepResult=!0;var h=new e.WebGLRenderTargetProperties(this.IrradianceWidth,this.IrradianceHeight,"linear");this.composers[1]=new i(this.renderer,h,this.rtPool),this.composers[1].composerContext.keepResult=!0;var o=new e.WebGLRenderTargetProperties(this.envmapWidth,this.envmapHeight,"linear");return this.composers[2]=new i(this.renderer,o,this.rtPool),this.composers[2].composerContext.keepResult=!0,this.composers[2].composerContext.beforeRenderCB=function(e){e.writeBuffer.minFilter=1003,e.writeBuffer.magFilter=1003,e.writeBuffer.wrapS=1001,e.writeBuffer.wrapT=1001},this.passTransmittance=new a(r.ComputeTransmittance),this.passTransmittance.material.needsUpdate=!0,this.passTransmittance.renderToScreen=!1,this.passScattering=new a(r.ComputeScattering),this.passScattering.material.needsUpdate=!0,this.passScattering.renderToScreen=!1,this.skyPass=new a(r.RenderSky),this.skyPass.material.needsUpdate=!0,this.skyPass.renderToScreen=!1,this.mixPass=new a(r.PostProcessScattering,void 0,"skyScatteringPass"),this.mixPass.material.needsUpdate=!0,this.mixPass.renderToScreen=!1,this.mixPass.changeRenderTargetProperties=new e.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear"),this.composers[0].addPass(this.passTransmittance),this.composers[1].addPass(this.passScattering),this.composers[2].addPass(this.skyPass),this.composers[0].linkToShaderPassUniform(this.passScattering,this.passScattering.uniforms.tTrans),this.composers[0].linkToShaderPassUniform(this.skyPass,this.skyPass.uniforms.tTrans),this.composers[1].linkToShaderPassUniform(this.skyPass,this.skyPass.uniforms.tScatter),this},initEffect:function(e,s){this.loadTextureCallBacks.push(function(e){e.skyPass.uniforms.tTrans.value=e.skyTransmittanceMap,e.mixPass.uniforms.tTrans.value=e.skyTransmittanceMap,e.skyPass.uniforms.tScatter.value=e.skyScatteringMap,e.mixPass.uniforms.tScatter.value=e.skyScatteringMap,e.skyPass.uniforms.tIrr.value=e.skyIrradianceMap,e.mixPass.uniforms.tIrr.value=e.skyIrradianceMap,e.executeWaiting&&e.execute(!0,e.executeWaiting)}),this.loadTextures(),s.insertComposer(null,this.mixPass)},update:function(s,t,i){var a=i.camera;this.mixPass.uniforms.near.value=a.near,this.mixPass.uniforms.far.value=a.far,this.mixPass.uniforms.invView.value=a.matrixWorld,this.mixPass.uniforms.texturesLoaded.value=this.allTexturesReady;var r=new e.Vector4,n=new e.Frustum;n.setFromMatrix(a.projectionMatrix);var h=a.near*Math.abs(n.planes[0].normal.z)/n.planes[0].normal.x,o=a.near*Math.abs(n.planes[1].normal.z)/n.planes[1].normal.x,l=-a.near*Math.abs(n.planes[2].normal.z)/n.planes[2].normal.y,p=-a.near*Math.abs(n.planes[3].normal.z)/n.planes[3].normal.y;r.x=h,r.y=l,r.z=o-h,r.w=p-l,this.mixPass.uniforms.screenToView.value=r,this.mixPass.uniforms.tDepth.value=this.renderer.dBuffer},setSize:function(e,s){this._parent(e,s)},setGenerationInput:function(e){if(e){if(this.atmParams=e,null!=e.viewAltitude){var s=Math.max(e.viewAltitude,.001);this.skyPass.uniforms.viewAltitude.value=s,this.mixPass.uniforms.viewAltitude.value=s}null!=e.sunDirection&&(this.skyPass.uniforms.sunDirection.value=e.sunDirection,this.mixPass.uniforms.sunDirection.value=e.sunDirection)}},_downloadTexture:function(e,s,t){var i=new Float32Array(s*t*4);this.renderer.context.readPixels(0,0,s,t,this.renderer.context.RGBA,this.renderer.context.FLOAT,i);var a=i,r=document.createElement("canvas");r.width=s,r.height=t;for(var n=r.getContext("2d"),h=n.createImageData(s,t),o=0;o<h.height;o++)for(var l=0;l<h.width;l++)h.data[4*(o*h.width+l)]=Math.round(255*a[4*(o*h.width+l)]),h.data[4*(o*h.width+l)+1]=Math.round(255*a[4*(o*h.width+l)+1]),h.data[4*(o*h.width+l)+2]=Math.round(255*a[4*(o*h.width+l)+2]),h.data[4*(o*h.width+l)+3]=Math.round(255*a[4*(o*h.width+l)+3]);n.putImageData(h,0,0);var p=document.createElement("a");p.download=e+".png",n.canvas.toBlob(function(e){p.href=URL.createObjectURL(e),p.click()})},loadTextures:function(){var t=0,i=this,a=function(){if(3==++t){for(var e=0;e<i.loadTextureCallBacks.length;e++)i.loadTextureCallBacks[e](i);i.allTexturesReady=1,i.loadTextureCallBacks=[]}},r=s.getWebappsAssetUrl("Ambiances","");if(this.skyTransmittanceMap||(this.skyTransmittanceMap=e.ImageUtils.loadCompressedTexture(r+"Sky/SkyTransmittance.dds",null,a,null,!1),this.skyTransmittanceMap.minFilter=e.LinearFilter,this.skyTransmittanceMap.magFilter=e.LinearFilter),this.skyIrradianceMap||(this.skyIrradianceMap=e.ImageUtils.loadCompressedTexture(r+"Sky/SkyIrradiance.dds",null,a,null,!1),this.skyIrradianceMap.minFilter=e.LinearFilter,this.skyIrradianceMap.magFilter=e.LinearFilter),this.skyScatteringMap||(this.skyScatteringMap=e.ImageUtils.loadCompressedTexture(r+"Sky/SkyInscatter.dds",null,a,null,!1),this.skyScatteringMap.minFilter=e.LinearFilter,this.skyScatteringMap.magFilter=e.LinearFilter),this.skyTransmittanceMap.loadEndStatus==e.AssetLoadingStatus.READY&&this.skyIrradianceMap.loadEndStatus==e.AssetLoadingStatus.READY&&this.skyScatteringMap.loadEndStatus==e.AssetLoadingStatus.READY){for(var n=0;n<this.loadTextureCallBacks.length;n++)this.loadTextureCallBacks[n](this);i.allTexturesReady=1,this.loadTextureCallBacks=[]}},execute:function(s,t,i,a,r){var n=function(s){s.renderer.materialToUse=e.MaterialToUse.originalMaterial,s.skyTransmittanceMap?(s.passScattering.uniforms.tTrans.value=s.skyTransmittanceMap,s.skyPass.uniforms.tTrans.value=s.skyTransmittanceMap):(s.composers[0].render(),i&&s._downloadTexture("transmittance",s.transmittanceWidth,s.transmittanceHeight)),s.skyScatteringMap?s.skyPass.uniforms.tScatter.value=s.skyScatteringMap:(s.composers[1].render(),a&&s._downloadTexture("scattering",s.IrradianceWidth,s.IrradianceHeight)),s.skyPass.uniforms.tIrr.value=s.skyIrradianceMap,s.composers[2].render(),r&&s._downloadTexture("envmap",s.envmapWidth,s.envmapHeight);var n=s.composers[2].composerContext.getResult(void 0,!1);t&&t(n)};s?(this.loadTextureCallBacks.push(n),this.loadTextures()):n(this)}})}),define("DS/Effects/TAAEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/TAAShaders","DS/Shaders/NothingShader"],function(e,s,t,i,a,r,n){"use strict";return t.extend({init:function(s,t){this._parent(s);var h=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");h.generateMipmaps=!1,this.composers[0]=new i(s,h,t),this.composers[0].composerContext.keepResult=!0,this.passTAA=new a(r.TAA);var o=new a(n);this.composers[0].addPass(this.passTAA),this.composers[0].addPass(o),this.mixPass=new a(r.Transfer,void 0,"MSAAEffect"),this.tmpResult=null,this.renderTargetPool=t;for(var l=new Uint8Array(16),p=0;p<4;p++)l[4*p]=0,l[4*p+1]=0,l[4*p+2]=0,l[4*p+3]=255;this.initTexture=new e.DataTexture(l,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter),this.initTexture.generateMipmaps=!1,this.initTexture.needsUpdate=!0,this.renderer.setTexture(this.initTexture,0),this.maxIteration=128,this.msaaOffset=[];for(var u=0;u<this.maxIteration;u++){var c=e.RandomLib.LowDiscrepancy2D(u);this.msaaOffset.push({x:c.x-.5,y:c.y-.5})}return this.previousViewProjectionMatrix=null,this.currentViewProjectionMatrix=null,this},initEffect:function(e,s){s.getComposer("normalDepth").linkToShaderPassUniform(this.passTAA,this.passTAA.uniforms.tNormalDepth),s.insertComposer(null,this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composers[0])},update:function(s,t,i,a){var r=i._renderedCamera;r.projectionMatrixInverse.getInverse(r.projectionMatrix),r.matrixWorldInverse.getInverse(r.matrixWorld),this.previousViewProjectionMatrix||(this.previousViewProjectionMatrix=new e.Matrix4,this.previousViewProjectionMatrix.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse)),this.passTAA.uniforms.screenSize.value.set(this.width,this.height),this.passTAA.uniforms.numIteration.value=a,this.passTAA.uniforms.prevMap.value=this.composers[0].composerContext.renderTarget2,this.passTAA.uniforms.previousViewProjectionMatrix.value.copy(this.previousViewProjectionMatrix),this.passTAA.uniforms.currentViewProjectionMatrix.value.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),this.passTAA.uniforms.currentProjectionMatrixInverse.value.copy(r.projectionMatrixInverse),this.passTAA.uniforms.currentViewMatrixInverse.value.copy(r.matrixWorld),this.currentViewProjectionMatrix=this.passTAA.uniforms.currentViewProjectionMatrix.value;var n=this;this.mixPass.beforeRenderCB=function(e){n.tmpResult=n.composers[0].composerContext.getResult("main",!0),n.passTAA.uniforms.prevMap.value=n.tmpResult},this.mixPass.afterRenderCB=function(){n.tmpResult&&(n.renderTargetPool.pushRenderTarget(n.tmpResult),n.tmpResult=null,n.previousViewProjectionMatrix.copy(n.currentViewProjectionMatrix))},a>=this.getMaxIteration()?this.mixPass.requiredComposers=[]:this.mixPass.requiredComposers.length||this.mixPass.addRequiredComposer(this.composers[0])},getMaxIteration:function(){return this.maxIteration},computeJitterCamera:function(e,s){var t=e.clone();t._renderingRole=e._renderingRole;var i=Math.min(this.getMaxIteration()-1,s);return t.updateProjectionMatrix(this.msaaOffset[i].x/this.width,this.msaaOffset[i].y/this.height),t},computeJitterValues:function(s,t){var i=Math.min(this.getMaxIteration()-1,t);return new e.Vector2(this.msaaOffset[i].x/this.width,this.msaaOffset[i].y/this.height)},setSize:function(e,s){this._parent(e,s)&&this.composers[0].setSize(this.width,this.height)}})}),define("DS/Effects/ComputeSDFFontIterative",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/NothingShader","DS/Shaders/PreComputeSDFFontIterativeShaders","DS/Shaders/EncodeHDRShader"],function(e,s,t,i,a,r,n){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=s,this.__renderer=e,this.passComputeSDFFontSeed=null,this.passComputeSDFFontFlood=null,this.passComputeSDFFontMerge=null,this.OutputRatio=.25,this.texture=null,this.passDisplayMap=null,this.passNothing=null,this},setMap:function(s,n){if(this.texture=s,this.width=parseInt(s.image.width),this.height=parseInt(s.image.height),this.composers[1])this.composers[1].setSize(this.width,this.height),this.passComputeSDFFontSeed.uniforms.prevMap.value=this.texture;else{(o=new e.WebGLRenderTargetProperties(this.width,this.height,"maxPrecisionNearest")).generateMipmaps=!1,o.mapping=this.texture.mapping,this.composers[1]=new t(this.renderer,o,this.renderTargetPool),this.composers[1].composerContext.keepResult=!0,this.passComputeSDFFontSeed=new i(r.ComputeSDFFontSeed),this.passComputeSDFFontSeed.compileShader(this.__renderer),this.passComputeSDFFontSeed.uniforms.prevMap.value=this.texture,this.passComputeSDFFontFlood=new i(r.ComputeSDFFontFlood),this.passComputeSDFFontMerge=new i(r.ComputeSDFFontMerge);var h=new i(a);this.composers[1].addPass(this.passComputeSDFFontSeed),this.composers[1].addPass(this.passComputeSDFFontFlood),this.composers[1].addPass(this.passComputeSDFFontMerge),this.composers[1].addPass(h)}var o,l=this.getOutputSize();this.composers[0]?this.composers[0].setSize(l.width,l.height):((o=new e.WebGLRenderTargetProperties(l.width,l.height,"uint")).generateMipmaps=!1,o.mapping=this.texture.mapping,this.composers[0]=new t(this.renderer,o,this.renderTargetPool),this.composers[0].composerContext.keepResult=!1,this.passDisplayMap=new i(r.ComputeSDFFontDisplay),this.passDisplayMap.renderToScreen=!1,this.composers[0].addPass(this.passDisplayMap),this.composers[1].linkToShaderPassUniform(this.passDisplayMap,this.passDisplayMap.uniforms.tDiffuse));this.passComputeSDFFontFlood.uniforms.invSize.value.set(1/this.width,1/this.height)},executeStep:function(s,t){var i=null;if(t)this.composers[1].enablePass(this.passComputeSDFFontSeed,!1),this.composers[1].enablePass(this.passComputeSDFFontFlood,!1),this.composers[1].enablePass(this.passComputeSDFFontMerge,!0),i=this.composers[1].composerContext.getResult(void 0,!0),this.passComputeSDFFontMerge.uniforms.prevMap.value=i;else if(s>0){this.composers[1].enablePass(this.passComputeSDFFontSeed,!1),this.composers[1].enablePass(this.passComputeSDFFontFlood,!0),this.composers[1].enablePass(this.passComputeSDFFontMerge,!1),i=this.composers[1].composerContext.getResult(void 0,!0),this.passComputeSDFFontFlood.uniforms.prevMap.value=i;this.passComputeSDFFontFlood.uniforms.invSize.value.set(1/this.width,1/this.height)}else this.composers[1].enablePass(this.passComputeSDFFontSeed,!0),this.composers[1].enablePass(this.passComputeSDFFontFlood,!1),this.composers[1].enablePass(this.passComputeSDFFontMerge,!1),this.passComputeSDFFontFlood.uniforms.prevMap.value=this.texture;this.__renderer.materialToUse=e.MaterialToUse.originalMaterial,this.composers[1].render(),i&&(this.renderTargetPool.pushRenderTarget(i),i=null)},renderToScreen:function(){this.passDisplayMap.renderToScreen=!0,this.composers[0].render()},renderOffscreen:function(){this.passDisplayMap.renderToScreen=!1,this.composers[0].render()},getOutputSize:function(){return{width:Math.floor(this.width*this.OutputRatio),height:Math.floor(this.height*this.OutputRatio)}}})}),define("DS/Effects/NativeOnTopEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Plugins/ClearPass","DS/Visualization/RenderMode","DS/Shaders/DecodeDepthShader"],function(e,s,t,i,a,r,n,h){"use strict";return s.extend({init:function(s,t,r){if(this._parent(s),this.v6Renderer=null,this.idString="onTop",e.supportedExtensions.fragDepth){let e=h;this.mixPass=new a(e,void 0,"onTopDepthSetPass"),this.mixPass.disableDepthTest=!1,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0,this.onTopPass=new i(null,null,null,void 0,void 0,void 0,"onTopPass"),this.onTopPass.idString=this.idString}else this.fallBackPass=new i(null,null,null,void 0,void 0,void 0,"fallBackOnTopPass"),this.fallBackPass.idString=this.idString;return this},initEffect:function(e,s){this.v6Renderer=s,this.fallBackPass?(s.mainComposer.addPass(this.fallBackPass),s.compForwardComposerContext.enablePass(this.fallBackPass,!0)):(this.mixPass.needsSwap=!1,s.mainComposer.addPass(this.mixPass),s.__enablePassOnAllComposerContexts(this.mixPass,!1),s.compForwardComposerContext.enablePass(this.mixPass,!0),s.mainComposer.addPass(this.onTopPass),s.__enablePassOnAllComposerContexts(this.onTopPass,!1),s.compForwardComposerContext.enablePass(this.onTopPass,!0))},update:function(e,s,t,i){var a=this.v6Renderer;this.fallBackPass||(s.scene.getNbWebGLObjects(this.idString)?(this.renderer.requestPoliteDepthBuffer(),a.compForwardComposerContext.enablePass(this.mixPass,!0),this.mixPass.material.uniforms.tDepth.value=this.renderer.politeDepthBuffer):a.compForwardComposerContext.enablePass(this.mixPass,!1))},disablePasses:function(e){this.fallBackPass?e.enablePass(this.fallBackPass,!1):(e.enablePass(this.mixPass,!1),e.enablePass(this.onTopPass,!1))},setSize:function(e,s){this._parent(e,s)},setEnabled:function(e){var s=this.v6Renderer;this.fallBackPass?s.compForwardComposerContext.enablePass(this.fallBackPass,e):(s.compForwardComposerContext.enablePass(this.mixPass,e),s.compForwardComposerContext.enablePass(this.onTopPass,e)),e&&this._parent(e)}})}),define("DS/Effects/NoPowerOfTwoEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/ResizeShaders"],function(e,s,t,i,a){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=s,this.passMerge=null,this},setTextures:function(s){var r=s.image.width,n=s.image.height;if(this.width=r,this.height=n,e.ImageUtils.is_pow2(r)||(this.width=e.ImageUtils.nearest_pow2(r)),e.ImageUtils.is_pow2(n)||(this.height=e.ImageUtils.nearest_pow2(n)),this.composers.length)this.composers[0].setSize(this.width,2*this.height);else{var h=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");h.generateMipmaps=!1,this.composers[0]=new t(this.renderer,h,this.renderTargetPool),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.noIdCheck=!0;var o=a.Resize;this.passMerge=new i({defines:o.defines,uniforms:o.uniforms,vertexShader:o.vertexShader,fragmentShader:o.fragmentShader},void 0,"Resize texture"),this.composers[0].addPass(this.passMerge)}this.passMerge.uniforms.tDiffuse.value=s,this.passMerge.material.needsUpdate=!0},copyToDataTexture:function(e,s){this.composers[0].render();var t=this.composers[0].composerContext.getResult(void 0,!0),i=new Uint8Array(4*this.width*this.height);return e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,i),s.mipmaps.length&&(s.mipmaps=[],s.generateMipmaps=!0),s.image.data=i,s.image.height=this.height,s.image.width=this.width,t}})}),define("DS/Effects/ToneMappingEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/CompositeShader","DS/Shaders/AutoExposureShaders","DS/Plugins/ClearPass"],function(e,s,t,i,a,r,n){"use strict";return s.extend({init:function(s,t){this._parent(s),this.renderer=s,this.rtPool=t,this.tonemapping=1,this.gamma=2.2,this.brightness=0,this._AEfinalRTSize=2,this._AEsumPasses=2,this._AEinit=!1,this._autoExposure=!1,this._AEregionOfInterestTexture=null,this._AEclampMin=-10,this._AEclampMax=20,this._AEComposers=[],this._AEWeightedLuminancePass=null,this._AEPixelSumPasses=[],this.colorGrading=null,this.mixPass=new i(a,void 0,"compositePass"),this.mixPass.material.blending=e.NoBlending,this.mixPass.gammaCorrectionPass=!0;var r=new e.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint");return this.mixPass.changeRenderTargetProperties=r,this.defines={GAMMA_SIMPLE:!0,USE_AUTO_EXPOSURE:0},this.autoExposureParams=null,this},initEffect:function(e,s){s.insertComposer(null,this.mixPass)},update:function(s,t,i){var a=24,r=38.6;i.camera instanceof e.PerspectiveCamera&&(a=i.camera.sensorSizeHeight,r=i.camera.focalLength),this.mixPass.uniforms.sensorSize.value=a,this.mixPass.uniforms.screenRatio.value=1/i.camera.aspect,this.mixPass.uniforms.focalLength.value=r},updateRequiredComposers:function(){this.mixPass.requiredComposers=[],this._autoExposure&&this.mixPass.addRequiredComposer(this._AEComposers[this._AEsumPasses])},setBeforeRenderCallback:function(){var e=null,s=this;this._autoExposure&&(e=function(e){s._AEWeightedLuminancePass.uniforms.tDiffuse2.value=e}),this.mixPass.beforeRenderCB=e,this._autoExposure},setVignettingPower:function(e){this.power=e||0,this.mixPass.uniforms.power.value=this.power},setToneMapping:function(e,s){var t={};switch(this._autoExposure?t.USE_AUTO_EXPOSURE=this._AEfinalRTSize:t.USE_AUTO_EXPOSURE=0,this.tonemapping=e,this.renderer._setToneMapping(this.tonemapping),e>1&&(2.2==this.gamma?t.SRGB_CORRECTION=!0:t.GAMMA_CORRECTION=!0),e){case 1:t.GAMMA_SIMPLE=!0;break;case 2:break;case 3:t.TONEMAP_REINHARD=!0;break;case 4:t.TONEMAP_FILMIC=!0;break;case 5:t.TONEMAP_UNCHARTED=!0;break;case 6:t.TONEMAP_PHOTOGRAPHIC=!0,s&&(null!=s.crushblacks&&(this.mixPass.uniforms.crushblacks.value=s.crushblacks),null!=s.burnhighlights&&(this.mixPass.uniforms.burnhighlights.value=s.burnhighlights),null!=s.saturation&&(this.mixPass.uniforms.saturation.value=s.saturation),s.colorCorrection&&(this.mixPass.uniforms.colorCorrection.value=s.colorCorrection))}this.defines=t,this.mixPass.material.defines=t,this.mixPass.material.needsUpdate=!0},setGamma:function(e){this.gamma=e,this.mixPass.uniforms.gamma.value=e,this.setToneMapping(this.tonemapping)},setBrightness:function(e){this.brightness=e,this.mixPass.uniforms.brightness.value=e},setAutoExposure:function(e,s,t,i){this.autoExposureParams={isActive:e,weightTexture:s,clampMin:t,clampMax:i};var a=this.renderer.supportsFloatTextures();this._autoExposure!=e&&a&&(this._autoExposure=e,this._AEregionOfInterestTexture=s,this._AEclampMin=null!=t?t:-10,this._AEclampMax=null!=i?i:20,this._autoExposure?(this.defines.USE_AUTO_EXPOSURE=this._AEfinalRTSize,this._buildAutoExposureRT(),this._updateAutoExposureUniforms()):this.defines.USE_AUTO_EXPOSURE=0,this.updateRequiredComposers(),this.mixPass.material.defines=this.defines,this.mixPass.material.needsUpdate=!0)},setColorGrading:function(e){e?(this.colorGrading=e,this.mixPass.uniforms.gradingMap.value=this.colorGrading,this.mixPass.uniforms.gradingDepth.value=this.colorGrading.image.width/this.colorGrading.image.height):this.colorGrading=null,this.defines.COLOR_GRADING=!!this.colorGrading,this.mixPass.material.defines=this.defines,this.mixPass.material.needsUpdate=!0},_getQAParams:function(){return{tonemapping:this.tonemapping,gamma:this.gamma,brightness:this.brightness,autoExposure:this.autoExposureParams,colorGrading:this.colorGrading,power:this.power}},_applyQAParams:function(e){this.setToneMapping(e.tonemapping),this.setGamma(e.gamma),this.setBrightness(e.brightness),e.autoExposure?this.setAutoExposure(e.autoExposure.isActive,e.autoExposure.weightTexture,e.autoExposure.clampMin,e.autoExposure.clampMax):this.setAutoExposure(!1),this.setColorGrading(e.colorGrading),this.setVignettingPower(this.power)},setSize:function(e,s){if(this._parent(e,s)&&this._AEinit){this._AEComposers[0].setSize(this.width,this.height),this._AEPixelSumPasses[0].uniforms.tDiffuseSize.value.set(this.width,this.height);var t=this._AEPixelSumPasses[0].uniforms.currentSize.value,i=Math.ceil(this.width/t.x),a=Math.ceil(this.height/t.y);this._AEPixelSumPasses[0].material.defines={LOOP_SIZE_X:i,LOOP_SIZE_Y:a,LOOP_SIZE_X_FINAL:this.width-i*(t.x-1),LOOP_SIZE_Y_FINAL:this.height-a*(t.y-1)},this._AEPixelSumPasses[0].material.needsUpdate=!0}},_updateAutoExposureUniforms:function(){this._AEinit&&(this._AEWeightedLuminancePass.uniforms.clampMin.value=this._AEclampMin,this._AEWeightedLuminancePass.uniforms.clampMax.value=this._AEclampMax,this._AEregionOfInterestTexture?(this._AEWeightedLuminancePass.uniforms.tWeight.value=this._AEregionOfInterestTexture,this._AEWeightedLuminancePass.material.defines||(this._AEWeightedLuminancePass.material.defines={USE_WEIGHT_TEXTURE:1},this._AEWeightedLuminancePass.material.needsUpdate=!0)):(this._AEWeightedLuminancePass.uniforms.tWeight.value=null,this._AEWeightedLuminancePass.material.defines&&(this._AEWeightedLuminancePass.material.defines=null,this._AEWeightedLuminancePass.material.needsUpdate=!0)))},_buildAutoExposureRT:function(){if(!this._AEinit){this._AEinit=!0;var s=new e.WebGLRenderTargetProperties(this.width,this.height,"nearest");this._AEComposers[0]=new t(this.renderer,s,this.rtPool),this._AEWeightedLuminancePass=new i(r.WeightedLuminance),this._AEPixelSumPasses=[],this._AEComposers[0].addPass(this._AEWeightedLuminancePass);for(var a=this.width,n=this.height,h=[256,this._AEfinalRTSize],o=0;o<this._AEsumPasses;o++){var l=h[o],p=new e.WebGLRenderTargetProperties(l,l,"nearest");this._AEComposers[o+1]=new t(this.renderer,p,this.rtPool),this._AEPixelSumPasses[o]=new i(r.PixelSum),this._AEPixelSumPasses[o].uniforms.currentSize.value=new e.Vector2(l,l),this._AEPixelSumPasses[o].uniforms.tDiffuseSize.value=new e.Vector2(a,n);var u=Math.ceil(a/l),c=Math.ceil(n/l);this._AEPixelSumPasses[o].material.defines={LOOP_SIZE_X:u,LOOP_SIZE_Y:c,LOOP_SIZE_X_FINAL:a-u*(l-1),LOOP_SIZE_Y_FINAL:n-c*(l-1)};a=l,n=l;this._AEPixelSumPasses[o].material.needsUpdate=!0,this._AEComposers[o+1].addPass(this._AEPixelSumPasses[o]),this._AEPixelSumPasses[o].addRequiredComposer(this._AEComposers[o]),this._AEComposers[o].linkToShaderPassUniform(this._AEPixelSumPasses[o],this._AEPixelSumPasses[o].uniforms.tDiffuse)}this.setBeforeRenderCallback(),this._AEComposers[this._AEsumPasses].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tAutoExposure)}}})}),define("DS/Effects/MSAAEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/MSAAShaders","DS/Shaders/NothingShader"],function(e,s,t,i,a,r,n){"use strict";return t.extend({init:function(s,t){this._parent(s),this.mode=1;var h=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");h.generateMipmaps=!1,this.composers[0]=new i(s,h,t),this.composers[0].composerContext.keepResult=!0,this.passBlend=new a(r.Blending);var o=new a(n);this.composers[0].addPass(this.passBlend),this.composers[0].addPass(o),this.mixPass=new a(r.Transfer,void 0,"MSAAEffect"),this.tmpResult=null,this.renderTargetPool=t;for(var l=new Uint8Array(16),p=0;p<4;p++)l[4*p]=0,l[4*p+1]=0,l[4*p+2]=0,l[4*p+3]=255;this.initTexture=new e.DataTexture(l,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter),this.initTexture.generateMipmaps=!1,this.initTexture.needsUpdate=!0,this.renderer.setTexture(this.initTexture,0),this.maxIteration=128,this.msaaOffset=[];for(var u=0;u<this.maxIteration;u++){var c=e.RandomLib.LowDiscrepancy2D(u);this.msaaOffset.push({x:c.x-.5,y:c.y-.5})}return this},initEffect:function(e,s){s.insertComposer(null,this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,s,t,i){this.mode?i-=1:i=0,this.passBlend.uniforms.numIteration.value=i,this.passBlend.uniforms.prevMap.value=i?this.composers[0].composerContext.renderTarget2:this.initTexture;var a=this;this.mixPass.beforeRenderCB=function(e){0===i?a.passBlend.uniforms.prevMap.value=a.initTexture:i>0&&(a.tmpResult=a.composers[0].composerContext.getResult("main",!0),a.passBlend.uniforms.prevMap.value=a.tmpResult)},this.mixPass.afterRenderCB=function(){a.tmpResult&&(a.renderTargetPool.pushRenderTarget(a.tmpResult),a.tmpResult=null)},i>=this.getMaxIteration()?this.mixPass.requiredComposers=[]:this.mixPass.requiredComposers.length||this.mixPass.addRequiredComposer(this.composers[0])},getMaxIteration:function(){return this.mode?this.maxIteration:1},computeJitterCamera:function(e,s){var t=e.clone();t._renderingRole=e._renderingRole;var i=Math.min(this.getMaxIteration()-1,s);return t.updateProjectionMatrix(this.msaaOffset[i].x/this.width,this.msaaOffset[i].y/this.height),t},computeJitterValues:function(s,t){var i=Math.min(this.getMaxIteration()-1,t);return new e.Vector2(this.msaaOffset[i].x/this.width,this.msaaOffset[i].y/this.height)},setSize:function(e,s){this._parent(e,s)&&this.composers[0].setSize(this.width,this.height)}})}),define("DS/Effects/AbstractHighlightEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/AdvancedHighlightShader","DS/Plugins/ClearPass","DS/Visualization/RenderMode"],function(e,s,t,i,a,r,n,h){"use strict";return s.extend({init:function(s,i,r,n,h,o){this._parent(s),this.sceneGraphSelection=null,this.idString=n||"main",this.prefix=h;var l=new e.WebGLRenderTargetProperties(this.width,this.height,"uintNearest");this.effectComp=new t(s,l,i),this.effectComp.keepResult=!0,this.effectComp.composerContext.name=r+"ComposerContext",this.composers.push(this.effectComp),this.hlClearPass=null,this.hlRenderPass=null,this.mixPass=new a(o,void 0,r);var p=[];return p[0]=-.326212,p[1]=-.405805,p[2]=-.840144,p[3]=-.07358,p[4]=-.695914,p[5]=.457137,p[6]=-.203345,p[7]=.620716,p[8]=.96234,p[9]=-.194983,p[10]=.473434,p[11]=-.480026,p[12]=.519456,p[13]=.767022,p[14]=.185461,p[15]=-.893124,p[16]=.507431,p[17]=.064425,p[18]=.530992,p[19]=.412458,p[20]=-.32194,p[21]=-.871945,p[22]=-.791559,p[23]=.597705,this.mixPass.uniforms.poisson.value=p,this},initEffect:function(e,s){e&&(this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0),s.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tAdd),this.mixPass.addRequiredComposer(this.composers[0])},updateUniforms:function(e){var s=new Array(e.length+1),t=s.length;s[0]=this.sceneGraphSelection.sceneHL;for(var i=1;i<t;i++)s[i]=e[i-1].sceneHL;var a=this.mixPass.defines,r=this.mixPass.uniforms,n=a.NB_CONFIG,h=a.HALO_THICKNESS,o=a.HAS_POLITE,l=this.composers[0].renderer,p=l.isQAAutomationMode()?1:0,u=a.QA_AUTOMATION,c=0;t!==n&&(this._updateMixPassShader(t),r.iHaloColors.value=new Array(3*t),r.iLineicHaloColors.value=new Array(3*t),r.iHaloIntensities.value=new Array(t),r.iColors.value=new Array(3*t),r.iColorIntensities.value=new Array(2*t),r.iOutlineColors.value=new Array(3*t),r.iLineicOutlineColors.value=new Array(3*t),r.iOutlineAlphas.value=new Array(t),r.iOutlineThicknesses.value=new Array(t));for(i=0;i<t;i++){var d=s[i],m=d.highlightData,f=d.getNbWebGLObjects(this.idString)+d.__objectsAdded.size;c+=f,m._needsDepth&&f>0&&l.requestPoliteDepthBuffer(),a.HALO_THICKNESS=Math.max(Math.ceil(l._renderScale*l._renderScale*m.haloThickness),1),m._updateMixPassUniforms(r,i+1)}a.NB_CONFIG=t,a.QA_AUTOMATION=p,a.HAS_POLITE=l._politeDBufferNextFrame&&"true"===localStorage.getItem("__WEBVISU_NEWHL_POC__")&&!p?1:0,r.empty.value=c>0?1:0,(a.NB_CONFIG!==n||a.HALO_THICKNESS!==h||a.HAS_POLITE!==o||a.QA_AUTOMATION!==u)&&this.mixPass.compileShader(l)},_updateMixPassShader:function(e){},setSize:function(e,s){this._parent(e,s)&&(this.composers[0].setSize(this.width,this.height),this.mixPass.uniforms.h.value=1/this.width,this.mixPass.uniforms.v.value=1/this.height)},setEnabled:function(e){this.composers[0].composerContext.enablePass(this.hlRenderPass,e),e&&this._parent(e)}})}),define("Effects/AbstractHighlightEffect",["DS/Effects/AbstractHighlightEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/AbstractHighlightEffect"),e}),define("DS/Effects/AbstractSSAOEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/SSAOShader","DS/Shaders/AdaptativeBlurShader","DS/Shaders/MultiplicativeBlendShader","DS/Plugins/ClearPass"],function(e,s,t,i,a,r,n,h,o){"use strict";return t.extend({init:function(s,t,r,n){this._parent(s);this.__renderer=s,this._randomTexture=null,this._samplingPoints=null,this.shaderName=r,this.effectName=n,this.effectSSAO=null,this.effectSSAOBlurH=null,this.effectSSAOBlurV=null;var o=new e.WebGLRenderTargetProperties(this.width,this.height,"uintRGBLinearNoStencil"),l=new i(s,o,t);return l.composerContext.keepResult=!0,l.composerContext.name=r+n+"ComposerContext",this.composers.push(l),this.isDynamicRadius=!0,this.isAdaptativeRadius=!0,this.influenceRadius=.04,this.minPixelRadius=14,this.maxPixelRadius=400,this.minRadius=.01,this.maxRadius=.12,this.slotAngle=1.35,this.contrast=1.4,this.attenuation=1,this.nbSamples=-1,this.mixPass=new a(h,void 0,n),this.mixPass.defines.SSAO=1,this.mixPass.compileShader(s),this.__compNormalDepth=null,this._initPasses(),this.setStrength(.95),this.influenceRadius=.2,this.setNbSamples(16),this.setSize(this.width,this.height,!0),this},getRandomTexture:function(){return this._randomTexture},getSamplingPoints:function(){return this._samplingPoints},initEffect:function(e,s){e&&(this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0),this.__compNormalDepth=s.getComposer("normalDepth"),this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAO,this.effectSSAO.uniforms.tNormalDepth),this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAOBlurH,this.effectSSAOBlurH.uniforms.tNormalDepth),this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAOBlurV,this.effectSSAOBlurV.uniforms.tNormalDepth),s.getComposer("normalDepthIoRRoughness").linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tNormalDepthIoRRoughness),s.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,s,t,i,a,r){var n=t._renderedCamera;n.projectionMatrixInverse.getInverse(n.projectionMatrix);var h=s.getBoundingSphere(),o=this.isDynamicRadius?this.influenceRadius*h.radius:this.influenceRadius,l=Math.max(this.minPixelRadius/this.width,this.minRadius),p=Math.min(this.maxPixelRadius/this.width,this.maxRadius);this.effectSSAO.uniforms.realProjectionMatrix.value=n.projectionMatrix,this.effectSSAO.uniforms.realProjectionMatrixInverse.value=n.projectionMatrixInverse,this.effectSSAO.uniforms.radius.value=o,this.effectSSAO.uniforms.minRadius.value=l,this.effectSSAO.uniforms.maxRadius.value=p;var u=this.contrast,c=this.attenuation;this.mixPass.uniforms.contrast.value=u,this.effectSSAO.uniforms.attenuation.value=c,this.effectSSAOBlurH.uniforms.radius.value=o,this.effectSSAOBlurV.uniforms.radius.value=o},setDynamicRadius:function(e){this.isDynamicRadius=e},setAdaptativeRadius:function(e){this.isAdaptativeRadius!==e&&(this.isAdaptativeRadius=e,this.effectSSAO.material.defines.ADAPTATIVE_RADIUS=e,this.effectSSAO.material.needsUpdate=!0)},setRadius:function(e){this.influenceRadius=Math.max(0,e)},setRadiusRange:function(e,s){this.minRadius=Math.min(Math.max(0,e),1),this.maxRadius=Math.min(Math.max(0,s),1)},setMinPixelRadius:function(e){this.minPixelRadius=Math.max(0,e)},setAttenuation:function(e){this.effectSSAO&&(this.attenuation=Math.max(0,e),this.effectSSAO.uniforms.attenuation.value=this.attenuation)},setContrast:function(e){this.contrast=Math.max(0,e),this.mixPass.uniforms.contrast.value=this.contrast},setStrength:function(e){this.setPower(e)},setPower:function(e){this.mixPass.uniforms.power.value=Math.max(0,e)},setThresholdAngle:function(e){this.slotAngle=e,this.effectSSAO.uniforms.thresholdAngle.value=Math.cos(e)},setNbSamples:function(e){e!==this.nbSamples&&(this.nbSamples=e,this.effectSSAO.uniforms.tau.value=this.tau[this.effectSSAO.uniforms.nbSamples.value],this.effectSSAO.uniforms.nbSamples.value=Math.min(e,32))},setSize:function(e,s,t){(this._parent(e,s)||t)&&(this.composers[0].setSize(this.width,this.height),this.effectSSAO.uniforms.screenRatio.value=this.height/this.width,this.effectSSAO.uniforms.screenSize.value.set(this.width,this.height),this.effectSSAO.uniforms.invSize.value.set(1/this.width,1/this.height),this.effectSSAOBlurH.uniforms.invSize.value.set(1/this.width,1/this.height),this.effectSSAOBlurV.uniforms.invSize.value.set(1/this.width,1/this.height))},_initPasses:function(){if(!this.tau){var e=[];e[0]=0,e[1]=1,e[2]=1,e[3]=2,e[4]=3,e[5]=3,e[6]=5,e[7]=5,e[8]=5,e[9]=7,e[10]=7,e[11]=7,e[12]=7,e[13]=7,e[14]=11,e[15]=11,e[16]=11,e[17]=13,e[18]=13,e[19]=13,e[20]=17,e[21]=17,e[22]=17,e[23]=17,e[24]=19,e[25]=19,e[26]=19,e[27]=23,e[28]=23,e[29]=23,e[30]=23,e[31]=27,e[32]=27,e[48]=43,e[64]=59,this.tau=e}if(!this.effectSSAO){this.effectSSAO=new a(r[this.shaderName],void 0,this.shaderName+this.effectName),this.effectSSAO.order=10,this.effectSSAO.compileShader(this.__renderer),this.effectSSAO.uniforms.tRandomTexture.value=this.getRandomTexture();var s=this.getSamplingPoints();s&&(this.effectSSAO.uniforms.samplingPoints.value=s),this.composers[0].addPass(this.effectSSAO),this.__compNormalDepth&&this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAO,this.effectSSAO.uniforms.tNormalDepth),n.H.defines.NB_SAMPLES=3,n.V.defines.NB_SAMPLES=3,n.H.defines.STEP="1.5",n.V.defines.STEP="1.5"}this.effectSSAOBlurH?(this.effectSSAOBlurH.compileShader(this.__renderer),this.effectSSAOBlurV.compileShader(this.__renderer)):(this.effectSSAOBlurH=new a(n.H,void 0,this.shaderName+this.effectName+"BlurH"),this.effectSSAOBlurV=new a(n.V,void 0,this.shaderName+this.effectName+"BlurV"),this.effectSSAOBlurH.order=100,this.effectSSAOBlurV.order=110,this.effectSSAOBlurH.compileShader(this.__renderer),this.effectSSAOBlurV.compileShader(this.__renderer),this.composers[0].addPass(this.effectSSAOBlurH),this.composers[0].addPass(this.effectSSAOBlurV),this.__compNormalDepth&&this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAOBlurH,this.effectSSAOBlurH.uniforms.tNormalDepth),this.__compNormalDepth&&this.__compNormalDepth.linkToShaderPassUniform(this.effectSSAOBlurV,this.effectSSAOBlurV.uniforms.tNormalDepth)),this.composers[0].enablePass(this.effectSSAOBlurH,!0),this.composers[0].enablePass(this.effectSSAOBlurV,!0),this.composers[0].enablePass(this.effectSSAO,!0)},getMaxIteration:function(){return 0}})}),define("Effects/AbstractSSAOEffect",["DS/Effects/AbstractSSAOEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/AbstractSSAOEffect"),e}),define("DS/Effects/SSAOIterativeEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/AbstractSSAOEffect"],function(e,s){"use strict";return s.extend({init:function(s,t){this._parent(s,t,"Iterative","SSAOIterativeEffect");this.tmpResult=null,this.renderTargetPool=t;for(var i=new Uint8Array(16),a=0;a<4;a++)i[4*a]=255,i[4*a+1]=255,i[4*a+2]=255,i[4*a+3]=255;return this.initTexture=new e.DataTexture(i,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter),this.initTexture.generateMipmaps=!1,this.initTexture.needsUpdate=!0,this.renderer.setTexture(this.initTexture,0),this},getRandomTexture:function(){if(!this._randomTexture){var s=e.RandomLib.computeHaltonSequence4D(64);s.minFilter=e.NearestFilter,s.magFilter=e.NearestFilter,s.needsUpdate=!0,this._randomTexture=s}return this._randomTexture},update:function(e,s,t,i,a,r){this._parent(e,s,t,i,a,r),i--,this.mixPass.composer.contexts[0].enablePass(this.mixPass,i>=0),this.composers[0].enablePass(this.effectSSAO,i>=0),this.composers[0].enablePass(this.effectSSAOBlurH,126===i),this.composers[0].enablePass(this.effectSSAOBlurV,126===i),this.effectSSAO.uniforms.numIteration.value=i,this.effectSSAO.uniforms.firstSample.value=this.nbSamples*i,this.effectSSAO.uniforms.prevMap.value=i?this.composers[0].composerContext.renderTarget2:this.initTexture;var n=this;this.mixPass.beforeRenderCB=function(e){0===i?n.effectSSAO.uniforms.prevMap.value=n.initTexture:i>0&&(n.tmpResult=n.composers[0].composerContext.getResult("main",!0),n.effectSSAO.uniforms.prevMap.value=n.tmpResult)},this.mixPass.afterRenderCB=function(){n.tmpResult&&(n.renderTargetPool.pushRenderTarget(n.tmpResult),n.tmpResult=null)}},getMaxIteration:function(){return 128}})}),define("DS/Effects/AbstractSSRayMarchingEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/SSLRShaders","DS/Shaders/DownSamplingShaders"],function(e,s,t,i,a,r,n){"use strict";return t.extend({init:function(s,t,h,o){this._parent(s);this.nbMips=7;var l=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");this.composers.push(new i(s,l,t)),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.name=h+"RayMarchingComposerContext",this.passRayMarching=new a(r[h],void 0,h+"RayMarching"),this.composers[0].addPass(this.passRayMarching);var p=.5;this.passMip=new Array(this.nbMips);for(var u=0;u<this.nbMips;u++){var c=new e.WebGLRenderTargetProperties(p*this.width,p*this.height,"linear");this.composers[u+1]=new i(s,c,t),this.composers[u+1].composerContext.keepResult=!1,this.composers[u+1].composerContext.name=h+"GenerateMips"+u+"ComposerContext",this.composers[u+1].composerContext.noIdCheck=!0,this.passMip[u]=new a(n.DownSamplingBlurWithAlpha,void 0,h+"GenerateMips"+u),this.passMip[u].uniforms.invSize.value.set(1/(p*this.width),1/(p*this.height)),this.passMip[u].material.needsUpdate=!0,this.passMip[u].renderToScreen=!1,this.composers[u+1].addPass(this.passMip[u]),p*=.5}this.composers[this.nbMips+1]=new i(this.renderer,l,t),this.composers[this.nbMips+1].composerContext.keepResult=!0,this.composers[this.nbMips+1].composerContext.name=h+"SolverComposerContext",this.passSolver=new a(r[o],void 0,h+"Solver"),this.composers[this.nbMips+1].addPass(this.passSolver),this.passMip[0].addRequiredComposer(this.composers[0]),this.composers[0].linkToShaderPassUniform(this.passMip[0],this.passMip[0].uniforms.tDiffuse2);for(u=1;u<this.nbMips;u++)this.passMip[u].addRequiredComposer(this.composers[u]),this.composers[u].linkToShaderPassUniform(this.passMip[u],this.passMip[u].uniforms.tDiffuse2);this.passSolver.addRequiredComposer(this.composers[this.nbMips]),this.composers[0].linkToShaderPassUniform(this.passSolver,this.passSolver.uniforms.tMip0);for(u=0;u<this.nbMips;u++)this.composers[u+1].linkToShaderPassUniform(this.passSolver,this.passSolver.uniforms["tMip"+(u+1)]);return this},update:function(s,t,i,a){i._renderedCamera.projectionMatrixInverse.getInverse(i._renderedCamera.projectionMatrix),this.passRayMarching.uniforms.realProjectionMatrixInverse.value=i._renderedCamera.projectionMatrixInverse,this.passSolver.uniforms.realProjectionMatrixInverse.value=i._renderedCamera.projectionMatrixInverse,this.passRayMarching.uniforms.realProjectionMatrix.value=i._renderedCamera.projectionMatrix,this.passRayMarching.uniforms.renderIteration.value=a,this.passSolver.uniforms.renderIteration.value=a;var r=t.getBoundingSphere();this.passRayMarching.uniforms.sceneSize.value=r.radius,this.passSolver.uniforms.sceneSize.value=r.radius;var n=new e.Frustum;n.setFromMatrix(i._renderedCamera.projectionMatrix);var h=this.passRayMarching.uniforms.frustumPlanes.value;h||(h=[],this.passRayMarching.uniforms.frustumPlanes.value=h);for(var o=0;o<6;o++){var l=n.planes[o],p=l.normal;h[4*o]=p.x,h[4*o+1]=p.y,h[4*o+2]=p.z,h[4*o+3]=l.constant}},execute:function(){return this.composers[this.nbMips+1].render(),this.composers[this.nbMips+1].composerContext},setSize:function(e,s){if(this._parent(e,s)){this.composers[0].setSize(this.width,this.height),this.passRayMarching.uniforms.screenSize.value.set(this.width,this.height);for(var t=.5,i=0;i<this.nbMips;i++)this.composers[i+1].setSize(this.width,this.height),this.passMip[i].uniforms.invSize.value.set(1/(t*this.width),1/(t*this.height)),t*=.5;this.composers[this.nbMips+1].setSize(this.width,this.height)}}})}),define("DS/Effects/SSLRefractionEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/AbstractSSRayMarchingEffect"],function(e,s,t){"use strict";return t.extend({init:function(e,s){return this._parent(e,s,"SSLRefraction","SSLRefractionMipSolver"),this},initEffect:function(e,s){var t=s.getComposer("normalDepthIoRRoughness");t.linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.uniforms.tNormalDepthIoRRoughness),t.linkToShaderPassUniform(this.passSolver,this.passSolver.uniforms.tNormalDepthIoRRoughness),s.getComposer("normalDepth").linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.uniforms.tColorNormalDepth),s.getComposer("opaque").linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.uniforms.tColor)}})}),define("DS/Effects/SSLReflectionEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/AbstractSSRayMarchingEffect"],function(e,s,t){"use strict";return t.extend({init:function(e,s){return this._parent(e,s,"SSLReflection","SSLReflectionMipSolver"),this},initEffect:function(e,s){var t=s.getComposer("normalDepthIoRRoughness");t.linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.uniforms.tNormalDepthIoRRoughness),t.linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.uniforms.tColorNormalDepth),t.linkToShaderPassUniform(this.passSolver,this.passSolver.uniforms.tNormalDepthIoRRoughness),s.getComposer("color").linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.uniforms.tColor)}})}),define("DS/Effects/HighlightEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/AbstractHighlightEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/AdvancedHighlightShader","DS/Plugins/ClearPass","DS/Visualization/PickingMode"],function(e,s,t,i,a,r,n,h){"use strict";var o=function(e){e.clear(!1,!0,!1)};return s.extend({init:function(e,s,t,i,a){return a=a||null,this._parent(e,s,i+"HighlightEffect",t,i,a||r.FinalBlending),this.scenes=[],this.mixPass.enableWarmStart=null===t,this},update:function(s,t,a,r,h){var l=this.composers[0].renderer;this.sceneGraphSelection=t.selectionHL,null===this.hlRenderPass&&(this.hlClearPass=new n(this.prefix+"hlClearPass"),this.hlRenderPass=new i(t.selectionHL.sceneHL,null,null,void 0,void 0,void 0,this.prefix+"hlRenderPass"),this.hlRenderPass.setDisableBackFaceCulling(!0),this.hlRenderPass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.hlRenderPass.cameraName="mainNoJittering",this.hlRenderPass.idString=this.idString,this.composers[0].addPass(this.hlClearPass),this.composers[0].addPass(this.hlRenderPass),this.composers[0].composerContext.setPassClear(this.hlClearPass,!0,new e.Color(0),0));var p=l.isQAAutomationMode(),u=this.scenes,c=[];this.sceneGraphSelection.enabled&&c.push(this.sceneGraphSelection.sceneHL);for(var d=0;d<u.length;d++){var m=u[d];m.enabled&&c.push(m.sceneHL)}var f=c.length;c.sort(function(e,s){return e.highlightData.priority-s.highlightData.priority}),this.hlRenderPass.setMultiRenderCB(function(e,s){if(s<f){e.scene=c[s];var t=e.scene.highlightData;return e._postRenderCB=null,e._preRenderCB=null,t.clearDepth&&!p&&(t.priority>0&&(e._preRenderCB=o),t.priority<0&&(e._postRenderCB=o)),!0}return!1}),Object.keys(this.hlRenderPass.stateSortingResults).length>f&&(this.hlRenderPass.stateSortingResults={});var[g,S,P]=l.getRenderMode().getMasks();this.hlRenderPass.renderFaceMode=g,this.hlRenderPass.renderLineMode=S,this.hlRenderPass.renderPointMode=P,this.composers[0].composerContext.needsUpdate=0===r||h,this.updateUniforms(u)},addScene:function(e){this.scenes.push(e)},removeScene:function(e){for(var s=[],t=0;t<this.scenes.length;t++)this.scenes[t]!==e?s.push(this.scenes[t]):this.scenes[t].clearAll();this.scenes=s}})}),define("Effects/HighlightEffect",["DS/Effects/HighlightEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/HighlightEffect"),e}),define("DS/Effects/PreHighlightEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/AbstractHighlightEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/AdvancedHighlightShader","DS/Plugins/ClearPass","DS/Visualization/PickingMode"],function(e,s,t,i,a,r,n,h){"use strict";return s.extend({init:function(e,s,t,i){return this._parent(e,s,i+"PreHighlightEffect",t,i,r.FinalBlending),this},update:function(s,t,a,r,h){var o=this.composers[0].renderer;this.sceneGraphSelection=t.selectionPreHL,null===this.hlRenderPass&&(this.hlClearPass=new n(this.prefix+"prehlClearPass"),this.hlRenderPass=new i(t.selectionPreHL.sceneHL,a._renderedCamera,this.prefix+"prehlRenderPass"),this.hlRenderPass.setDisableBackFaceCulling(!0),this.hlRenderPass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.hlRenderPass.cameraName="mainNoJittering",this.hlRenderPass.idString=this.idString,this.composers[0].composerContext.setPassClear(this.hlClearPass,!0,new e.Color(0),0),this.composers[0].addPass(this.hlClearPass),this.composers[0].addPass(this.hlRenderPass));var l=[];this.sceneGraphSelection.enabled&&l.push(this.sceneGraphSelection.sceneHL);var p=l.length;this.hlRenderPass.setMultiRenderCB(function(e,s){return s<p&&(e.scene=l[s],!0)});var[u,c,d]=o.getRenderMode().getMasks();this.hlRenderPass.renderFaceMode=u,this.hlRenderPass.renderLineMode=c,this.hlRenderPass.renderPointMode=d,this.composers[0].composerContext.needsUpdate=!0,this.updateUniforms([])}})}),define("Effects/PreHighlightEffect",["DS/Effects/PreHighlightEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/PreHighlightEffect"),e}),define("DS/Effects/SSAOEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/AbstractSSAOEffect","DS/Plugins/ShaderPass","DS/Shaders/AdaptativeBlurShader"],function(e,s,t,i){"use strict";return s.extend({init:function(e,s){this._parent(e,s,"Direct","SSAOEffect");return this},getRandomTexture:function(){if(!this._randomTexture){for(var s=[.960296,.274776,-.0482711,0,-.0217867,.999033,-.0381943,0,-.0281167,.280583,.959418,0,-.0622982,-.0498126,-.996814,0,.762197,.178997,.622106,0,-.610721,.38519,-.691844,0,.209116,-.106236,-.972103,0,-.971866,.0766489,-.222714,0,-.321656,.280776,-.904269,0,.836284,-.48659,.252705,0,-.924106,-.109391,-.366145,0,.110424,.149603,.982561,0,.92149,-.376162,.0967352,0,-.592781,-.0588162,.803213,0,.238876,-.0463654,.969942,0,.728274,-.299609,-.61632,0,-.389309,-.215351,.895579,0,.775002,-.220267,-.59233,0,-.681002,-.359332,-.638056,0,-.13823,-.980038,.142888,0,.860016,-.165527,-.482673,0,-.599353,-.659337,.453928,0,.416823,-.908951,-.00818423,0,-.793046,-.0722135,.604866,0,-.188499,.945449,.265696,0],t=new Float32Array(100),i=0;i<100;i++)t[i]=s[i];this._randomTexture=new e.DataTexture(t,5,5,e.RGBAFormat,e.FloatType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter),this._randomTexture.generateMipmaps=!1,this._randomTexture.needsUpdate=!0}return this._randomTexture},getSamplingPoints:function(){return this._samplingPoints||(this._samplingPoints=[.334033,-.00485205,-.00401396,-.453196,-.267136,.16953,-.147833,.413971,-.106289,.0909656,-.10026,-.646145,.150717,.422825,.407178,-.141224,-.0126533,.671199,-.568417,.123185,-.109986,-.0231788,-.733836,.0740228,-.00159637,-498002e-9,.00229559,.411656,-.16241,.505242,-.373892,.115395,-.594764,.236072,.72466,.0524527,-.0849139,-.231345,-.121562,-.0492975,-.409624,.508015,.363041,-.233737,-.358279,.209588,.103554,-.290493,.401735,-.318318,.174997,-.436293,.0988326,.230372,-.00129735,-.00939224,-.102806,.0474442,.094537,-.0300616,-.180245,.307443,.33575,.0280045,.00316191,.201276,-.487838,-.48419,-.148956,-.207171,-.0813871,-.133753,.43206,.435895,-.210157,-.333923,-.35392,-.450399,.314904,-.343625,-.0974952,.0534175,-.0530132,-.0137891,-.0964412,.115755,.0301087,.659795,-.251509,-.00948616,.284603,-.679033,.192659,-.594049,-.128511,-.149513]),this._samplingPoints}})}),define("Effects/SSAOEffect",["DS/Effects/SSAOEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/SSAOEffect"),e}),define("DS/Effects/SpatialOccupationEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ClearPass"],function(e,s,t,i,a){"use strict";return s.extend({init:function(s,r){var n;switch(this._parent(s.renderer.renderer),r.filtering){case"linear":n="uint";break;case"nearest":default:n="uintNearest"}var h=r.name?r.name:"offScreenPass";this.viewer=s,this.renderer=s.renderer.renderer;var o=s.renderer.renderTargetPool;return this.sceneGraph=s.internalSceneGraph,this.viewpoint=s.viewpoints[0],this.width=r.targetWidth?r.targetWidth:s.SCREEN_WIDTH,this.height=r.targetHeight?r.targetHeight:s.SCREEN_HEIGHT,this.renderTarget=new e.WebGLRenderTargetProperties(this.width,this.height,n),this.composers.push(new t(this.renderer,this.renderTarget,o)),this.composers[0].composerContext.keepResult=!1,this.renderPass=new i(null,null,null,void 0,void 0,void 0,h),this.renderPass.idString=h,this.renderPass.setMaterialToUse(e.MaterialToUse.pickingMaterial),this.clearPass=new a("customClearPass"),this.composers[0].addPass(this.clearPass),this.composers[0].addPass(this.renderPass),this.composers[0].composerContext.enablePass(this.renderPass,!0),this.renderPass.setScene(this.sceneGraph.scene),this.composers[0].composerContext.setPassClear(this.clearPass,!0,new e.Color(0),1),this.renderPass.renderFaceMode=this.renderer.renderFaceMode,this.renderPass.renderLineMode=this.renderer.renderLineMode,this.renderPass.renderPointMode=this.renderer.renderPointMode,this.renderPass.renderSurfacicPoints=this.renderer.renderSurfacicPoints,this},renderResult:function(e){this._setSize(this.width,this.height),this.composers[0].updateScene(this.sceneGraph.scene);var s=this.renderer.context,t={main:this.viewpoint._renderedCamera,connectedRobotCamera:this.viewpoint.connectedRobotCamera,robotCameraOrtho:this.viewpoint.robotCameraOrtho},i=this.viewpoint._renderedCamera.pixelCulling;this.viewpoint.setPixelCulling(i*Math.min(this.width/this.viewer.SCREEN_WIDTH,this.height/this.viewer.SCREEN_HEIGHT)),this.composers[0].render(void 0,void 0,t,"main"),this.viewpoint.setPixelCulling(i);var a=new Uint8Array(4*this.width*this.height);if(s.readPixels(0,0,this.width,this.height,s.RGBA,s.UNSIGNED_BYTE,a),e.flipImage){for(var r=this.width,n=this.height,h=new Array,o=0;o<n;o++)for(var l=0;l<r;l++)for(var p=0;p<4;p++)h.push(a[4*r*(n-1-o)+4*l+p]);return{data:h,width:r,height:n}}return{data:a,width:this.width,height:this.height}},_setSize:function(e,s){this._parent(e,s),this.composers[0].setSize(e,s),this.width=e,this.height=s}})}),define("Effects/SpatialOccupationEffect",["DS/Effects/SpatialOccupationEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/SpatialOccupationEffect"),e}),define("DS/Effects/SSLREffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/SSLRShader","DS/Shaders/BloomShaders","DS/Shaders/SSLRBlendShader"],function(e,s,t,i,a,r,n,h){"use strict";return t.extend({init:function(t,o){var l=this._parent(t),p=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers.push(new i(t,p,o)),this.effectSSLR=new a(r),this.effectSSLRBlurH=new a(n.BlurH),this.effectSSLRBlurV=new a(n.BlurV),this.composers[0].addPass(this.effectSSLR),this.composers[0].addPass(this.effectSSLRBlurH),this.composers[0].addPass(this.effectSSLRBlurV),this.composers[0].enablePass(this.effectSSLRBlurH,!1),this.composers[0].enablePass(this.effectSSLRBlurV,!1);var u=s.getWebappsAssetUrl("Effects",""),c=new e.ImageUtils.loadTexture(u+"SSAORandom.png",void 0,null,null,e.ImageUtils.crossOriginPolicy);c.minFilter=e.LinearFilter,c.magFilter=e.LinearFilter,this.effectSSLR.uniforms.tRandomTex.value=c,this.mixPass=new a(h,void 0,"SSLREffect");l=this;return this.mixPass.beforeRenderCB=function(e){l.effectSSLR.uniforms.tDiffuse2.value=e},this},initEffect:function(e,s){s.getComposer("normalDepthIoRRoughness").linkToShaderPassUniform(this.effectSSLR,this.effectSSLR.uniforms.tNormalDepthIoRRoughness),s.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composers[0])},update:function(s,t,i){i._renderedCamera.projectionMatrixInverse.getInverse(i._renderedCamera.projectionMatrix),this.effectSSLR.uniforms.realProjectionMatrixInverse.value=i._renderedCamera.projectionMatrixInverse,this.effectSSLR.uniforms.realProjectionMatrix.value=i._renderedCamera.projectionMatrix;var a=.2*t.getBoundingSphere().radius,r=.2*(new e.Vector3).subVectors(i.target,i._renderedCamera.position).length()*Math.tan(.5*i._renderedCamera.fov*(Math.PI/180));a=a>r?r:a,this.effectSSLR.uniforms.radius.value=a},setSize:function(e,s){this._parent(e,s)&&(this.composers[0].setSize(this.width,this.height),this.effectSSLRBlurH.uniforms.invSize.value.set(1/this.width,1/this.height),this.effectSSLRBlurV.uniforms.invSize.value.set(1/this.width,1/this.height),this.effectSSLR.uniforms.size.value.set(this.width,this.height))}})}),define("Effects/SSLREffect",["DS/Effects/SSLREffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/SSLREffect"),e}),define("DS/Effects/DebugShadowMapsEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/ReplaceBlendShader","DS/Shaders/DisplayShadowMapsShader"],function(e,s,t,i,a,r,n){"use strict";return s.extend({init:function(s,i){this._parent(s);var n=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");return this.composers.push(new t(s,n,i)),this.debugPass=null,this.mixPass=new a(r,void 0,"DebugShadowMapsEffect"),this.nbLights=0,this},initEffect:function(e,s){null===this.debugPass&&(this.debugPass=new a(n),this.composers[0].addPass(this.debugPass)),s.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,s,t){var i=s.scene,a=i.__lights.length;if(a!==this.nbLights)for(var r=2,n=0;n<a;n++){var h=i.__lights[n];if(h.shadowMap){var o="tDiffuse"+r;void 0!==this.debugPass.uniforms[o]&&(this.debugPass.uniforms[o].value=h.shadowMap),r++}}},setSize:function(e,s){this._parent(e,s)&&this.composers[0].setSize(this.width,this.height)}})}),define("Effects/DebugShadowMapsEffect",["DS/Effects/DebugShadowMapsEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/DebugShadowMapsEffect"),e}),define("DS/Effects/OITEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ComposerContext","DS/Plugins/EffectComposer","DS/Plugins/ClearPass","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/OITShader","DS/Shaders/FXAAShader"],function(e,s,t,i,a,r,n,h,o){"use strict";return s.extend({init:function(s,t,a,r){this._parent(s),this.stateSortingResultFrom=a,this.rtPool=t,this.name=r;var n=new e.WebGLRenderTargetProperties(this.width,this.height,"oitAccumLinear");n.generateMipmaps=!1;var h=new e.WebGLRenderTargetProperties(this.width,this.height,"oitRevealLinear");return h.generateMipmaps=!1,this.composerAccum=new i(s,n,t),this.composerAccum.needsCameraUpdate=!0,this.composerAccum.composerContext.name=r+"AccumComposerContext",this.composers.push(this.composerAccum),this.composerReveal=new i(s,h,t),this.composerReveal.needsCameraUpdate=!0,this.composerReveal.composerContext.name=r+"RevealComposerContext",this.composers.push(this.composerReveal),this.mixPass=null,this.clearAccumPass=null,this.accumPass=null,this.clearRevealPass=null,this.revealPass=null,this.fxaaPass=null,this.idString=null,this},initEffect:function(s,t){var i=function(e){return!e.canOIT},o=this.name;this.rtPool;s?(this.mixPass=new n(h.SolveAndBlendShader,void 0,o),this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0,this.mixPass.material.depthTest=!1,this.mixPass.compileShader(this.renderer),this.composerAccum.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tAccum),this.composerReveal.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tReveal),this.mixPass.addRequiredComposer(this.composerAccum),this.mixPass.addRequiredComposer(this.composerReveal),i=null):(this.mixPass=new n(h.SolveAndBlendShader,"tOpaque",o),this.mixPass.compileShader(this.renderer),this.composerAccum.bShareDepth=!0,this.composerReveal.bShareDepth=!0,this.composerAccum.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tAccum),this.composerReveal.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tReveal),this.mixPass.addRequiredComposer(this.composerAccum),this.mixPass.addRequiredComposer(this.composerReveal)),this.clearAccumPass=new a(o+"ClearAccum"),this.clearAccumPass.clearColor=new e.Color(0),this.clearAccumPass.clearbColor=!0,this.clearAccumPass.clear=!1,this.clearAccumPass.clearDepth=s,this.clearAccumPass.defaults.clear=!1,this.clearAccumPass.defaults.doClearDepth=s,this.clearAccumPass.clearAlpha=0,this.clearAccumPass.disabledByDefault=!0,this.clearAccumPass.idString=this.idString,this.accumPass=new r(t.scene,null,null,null,null,null,o+"Accum"),this.accumPass.setStateSortingResultFrom(this.stateSortingResultFrom,!1),this.accumPass.isOITPass=!0,this.accumPass.setMaterialToUse(e.MaterialToUse.oitAccumMaterial),this.accumPass.setDLsToDisableFunc(i),this.accumPass.disabledByDefault=!0,this.accumPass.setDisableBackFaceCulling(!1),this.accumPass.idString=this.idString,this.composerAccum.addPass(this.clearAccumPass),this.composerAccum.addPass(this.accumPass),this.composerAccum.enablePass(this.clearAccumPass,!0),this.composerAccum.enablePass(this.accumPass,!0),this.clearRevealPass=new a(o+"ClearReveal"),this.clearRevealPass.clearColor=new e.Color(16711680),this.clearRevealPass.clear=!1,this.clearRevealPass.clearbColor=!0,this.clearRevealPass.clearDepth=s,this.clearRevealPass.defaults.clear=!1,this.clearRevealPass.defaults.doClearDepth=s,this.clearRevealPass.clearAlpha=0,this.clearRevealPass.disabledByDefault=!0,this.clearRevealPass.idString=this.idString,this.revealPass=new r(t.scene,null,null,null,null,null,o+"Reveal"),this.revealPass.setStateSortingResultFrom(this.stateSortingResultFrom,!1),this.revealPass.setMaterialToUse(e.MaterialToUse.oitRevealMaterial),this.revealPass.isOITPass=!0,this.revealPass.setDLsToDisableFunc(i),this.revealPass.disabledByDefault=!0,this.revealPass.setDisableBackFaceCulling(!1),this.revealPass.idString=this.idString,this.composerReveal.addPass(this.clearRevealPass),this.composerReveal.addPass(this.revealPass),this.composerReveal.enablePass(this.clearRevealPass,!0),this.composerReveal.enablePass(this.revealPass,!0),t.insertComposer(null,this.mixPass)},update:function(e,s,t){},setSize:function(e,s){if(this._parent(e,s)){for(var t=0;t<this.composers.length;t++)this.composers[t].setSize(e,s);this.fxaaPass&&this.fxaaPass.uniforms.resolution.value.set(1/e,1/s)}}})}),define("Effects/OITEffect",["DS/Effects/OITEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/OITEffect"),e}),define("DS/Effects/SMAAEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/SMAAShader","DS/Plugins/ClearPass"],function(e,s,t,i,a,r,n){"use strict";return t.extend({init:function(t,n){this._parent(t);var h=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composer=new i(t,h,n),this.composer.composerContext.name="SMAAEffect",this.composers.push(this.composer),this.pass1=new a(r.EdgeDetection),this.pass1.compileShader(t),this.pass2=new a(r.BlendingWeights),this.pass2.compileShader(t),this.mixPass=new a(r.FinalBlending,void 0,"SMAAEffect"),this.mixPass.compileShader(t),this.composer.addPass(this.pass1),this.composer.addPass(this.pass2);var o=s.getWebappsAssetUrl("Effects",""),l=new e.ImageUtils.loadTexture(o+"AreaTexSMAA.png",void 0,null,null,e.ImageUtils.crossOriginPolicy);l.minFilter=e.LinearFilter,l.magFilter=e.LinearFilter,this.pass2.uniforms.areaTex.value=l;var p=new e.ImageUtils.loadTexture(o+"SearchTexSMAA.png",void 0,null,null,e.ImageUtils.crossOriginPolicy);return p.minFilter=e.NearestFilter,p.magFilter=e.NearestFilter,this.pass2.uniforms.searchTex.value=p,this.areaTexture=l,this.searchTexture=p,this},initEffect:function(e,s){s.insertComposer(this.composer,this.mixPass),this.composer.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composer)},update:function(e,s,t){},setSize:function(e,s){this._parent(e,s)&&(this.composer.setSize(this.width,this.height),this.pass1.uniforms.screenWidth.value=this.width,this.pass1.uniforms.screenHeight.value=this.height,this.pass2.uniforms.screenWidth.value=this.width,this.pass2.uniforms.screenHeight.value=this.height,this.mixPass.uniforms.screenWidth.value=this.width,this.mixPass.uniforms.screenHeight.value=this.height)},dispose:function(){this._parent(),this.areaTexture.dispose(),this.searchTexture.dispose()}})}),define("Effects/SMAAEffect",["DS/Effects/SMAAEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/SMAAEffect"),e}),define("DS/Effects/CompareModelsEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ComposerContext","DS/Plugins/ClearPass","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/CompareModelsShader","DS/Visualization/RenderMode"],function(e,s,t,i,a,r,n,h){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.mixPass=new r(n,void 0,"compareModelPass"),this.mixPass.compileShader(e),this.tolerance=.02,this.composerEffects=[],this.forwardContext=null,this.passClearOld=null,this.passColorOld=null,this.passDepthOld=null,this.passDepthNew=null,this.passAll=null,this.passSectionCappingFrontFaces1=null,this.passSectionCappingFrontFaces2=null,this.passSectionCappingFrontFaces3=null,this.v6renderer=null,this.forwardPass=null,this},initEffect:function(s,r){r.compareSettings&&(this.tolerance=r.compareSettings.tolerance);var n=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");n.generateMipmaps=!1;var o=new t(n,r.mainComposer,"colorOldComposerContext");o.keepResult=!0;var l=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");l.generateMipmaps=!1;var p=new t(l,r.mainComposer,"depthOldComposerContext");p.keepResult=!0;var u=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");u.generateMipmaps=!1;var c=new t(u,r.mainComposer,"depthNewComposerContext");c.keepResult=!0,this.composerEffects.push(o),this.composerEffects.push(p),this.composerEffects.push(c),r.customComposerContexts=[],r.customComposerContexts[0]=o,r.customComposerContexts[1]=p,r.customComposerContexts[2]=c;var d=new i("depth_clear_old");d.clearColor=new e.Color(0),d.clearAlpha=0,d.disabledByDefault=!0,this.passClearOld=d;var m=new a(null,null,null,h.facesMask,!1,!1,"color_old");m.idString="compareOld",m.disabledByDefault=!0,this.passColorOld=m;var f=new a(null,null,null,h.facesMask,!1,!1,"depth_old");f.idString="compareOld",f.disabledByDefault=!0,f.setMaterialToUse(e.MaterialToUse.depthRGBAMaterial),this.passDepthOld=f;var g=new a(null,null,null,h.facesMask,!1,!1,"depth_new");g.idString="compareNew",g.disabledByDefault=!0,g.setMaterialToUse(e.MaterialToUse.depthRGBAMaterial),this.passDepthNew=g;var S=new a(null,null,null,h.facesMask,!1,!1,"all_models");S.disabledByDefault=!0,this.passAll=S,this.passSectionCappingFrontFaces1=new a(null,null,null,h.facesMask,!1,!1,"colorOldCapping"),this.passSectionCappingFrontFaces1.setRenderCuttingElements(!0),this.passSectionCappingFrontFaces1.idString="compareOld",this.passSectionCappingFrontFaces1.setEnableStencilTest(!0),this.passSectionCappingFrontFaces1.setEnableStencilWrite(!0),this.passSectionCappingFrontFaces1.setDisableColorWrite(!0),this.passSectionCappingFrontFaces1.setDisableDepthWrite(!0),this.passSectionCappingFrontFaces1.setStencilFunc("ALWAYS"),this.passSectionCappingFrontFaces1.setStencilOps("INCR_WRAP","DECR_WRAP"),this.passSectionCappingFrontFaces1.setDisableBackFaceCulling(!0),this.passSectionCappingFrontFaces1.setHideSurfacesAndUnclippedMeshes(!0),this.passSectionCappingFrontFaces1.setDisableBackFaceClipPlanes(1),this.passSectionCappingFrontFaces1.setRenderPluginsPre(!1),this.passSectionCappingFrontFaces1.setRenderPluginsPost(!1),this.passSectionCappingFrontFaces1.ignoreNoZ=!0,this.passSectionCappingFrontFaces1.scene=r.scene,this.passSectionCappingFrontFaces1.disabledByDefault=!0,this.passSectionCappingFrontFaces2=new a(null,null,null,h.facesMask,!1,!1,"depthOldCapping"),this.passSectionCappingFrontFaces2.setRenderCuttingElements(!0),this.passSectionCappingFrontFaces2.idString="compareOld",this.passSectionCappingFrontFaces2.setEnableStencilTest(!0),this.passSectionCappingFrontFaces2.setEnableStencilWrite(!0),this.passSectionCappingFrontFaces2.setDisableColorWrite(!0),this.passSectionCappingFrontFaces2.setDisableDepthWrite(!0),this.passSectionCappingFrontFaces2.setStencilFunc("ALWAYS"),this.passSectionCappingFrontFaces2.setStencilOps("INCR_WRAP","DECR_WRAP"),this.passSectionCappingFrontFaces2.setDisableBackFaceCulling(!0),this.passSectionCappingFrontFaces2.setHideSurfacesAndUnclippedMeshes(!0),this.passSectionCappingFrontFaces2.setDisableBackFaceClipPlanes(1),this.passSectionCappingFrontFaces2.setRenderPluginsPre(!1),this.passSectionCappingFrontFaces2.setRenderPluginsPost(!1),this.passSectionCappingFrontFaces2.ignoreNoZ=!0,this.passSectionCappingFrontFaces2.scene=r.scene,this.passSectionCappingFrontFaces2.setMaterialToUse(e.MaterialToUse.depthRGBAMaterial),this.passSectionCappingFrontFaces2.disabledByDefault=!0,this.passSectionCappingFrontFaces3=new a(null,null,null,h.facesMask,!1,!1,"depthNewCapping"),this.passSectionCappingFrontFaces3.setRenderCuttingElements(!0),this.passSectionCappingFrontFaces3.idString="compareNew",this.passSectionCappingFrontFaces3.setEnableStencilTest(!0),this.passSectionCappingFrontFaces3.setEnableStencilWrite(!0),this.passSectionCappingFrontFaces3.setDisableColorWrite(!0),this.passSectionCappingFrontFaces3.setDisableDepthWrite(!0),this.passSectionCappingFrontFaces3.setStencilFunc("ALWAYS"),this.passSectionCappingFrontFaces3.setStencilOps("INCR_WRAP","DECR_WRAP"),this.passSectionCappingFrontFaces3.setDisableBackFaceCulling(!0),this.passSectionCappingFrontFaces3.setHideSurfacesAndUnclippedMeshes(!0),this.passSectionCappingFrontFaces3.setDisableBackFaceClipPlanes(1),this.passSectionCappingFrontFaces3.setRenderPluginsPre(!1),this.passSectionCappingFrontFaces3.setRenderPluginsPost(!1),this.passSectionCappingFrontFaces3.ignoreNoZ=!0,this.passSectionCappingFrontFaces3.scene=r.scene,this.passSectionCappingFrontFaces3.setMaterialToUse(e.MaterialToUse.depthRGBAMaterial),this.passSectionCappingFrontFaces3.disabledByDefault=!0,r.mainComposer.insertCustomPassAfterPass(d,null),r.mainComposer.insertCustomPassAfterPass(m,d),r.mainComposer.insertCustomPassAfterPass(this.passSectionCappingFrontFaces1,m),r.mainComposer.insertCustomPassAfterPass(f,this.passSectionCappingFrontFaces1),r.mainComposer.insertCustomPassAfterPass(this.passSectionCappingFrontFaces2,f),r.mainComposer.insertCustomPassAfterPass(g,this.passSectionCappingFrontFaces2),r.mainComposer.insertCustomPassAfterPass(this.passSectionCappingFrontFaces3,g),r.mainComposer.insertCustomPassAfterPass(S,this.passSectionCappingFrontFaces3),this.v6renderer=r,this.forwardContext=r.compForwardComposerContext,this.forwardPass=r.forwardPass,s&&(this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0),r.insertComposer(null,this.mixPass),o.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tCommonColor),p.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDepthOld),c.linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDepthNew)},update:function(e,s,t){var i=!!this.v6renderer.clippingScene;this.composerEffects[0].enablePass(this.passSectionCappingFrontFaces1,i),this.composerEffects[1].enablePass(this.passSectionCappingFrontFaces2,i),this.composerEffects[2].enablePass(this.passSectionCappingFrontFaces3,i);var a=t._renderedCamera;a.projectionMatrixInverse.getInverse(a.projectionMatrix),this.mixPass.uniforms.realProjectionMatrixInverse.value=a.projectionMatrixInverse,this.mixPass.uniforms.tolerance.value=this.tolerance},setTolerance:function(e){this.tolerance=e},set2DMode:function(e){e!==this.is2DMode&&(this.is2DMode=e,this.mixPass.defines.MODE=this.is2DMode?1:0,this.mixPass.compileShader(this.renderer))},setSize:function(e,s){if(this._parent(e,s))for(var t=0;t<this.composerEffects.length;t++)this.composerEffects[t].setSize(e,s)},setEnabled:function(e){this._parent(e);var s=!!this.v6renderer.clippingScene;this.composerEffects[0].setPassClear(this.passClearOld,e),this.composerEffects[0].setPassClearDepth(this.passClearOld,e),this.composerEffects[0].enablePass(this.passClearOld,e),this.composerEffects[0].enablePass(this.passColorOld,e),this.composerEffects[0].enablePass(this.passSectionCappingFrontFaces1,s&&e),this.composerEffects[1].setPassClear(this.passClearOld,e),this.composerEffects[1].setPassClearDepth(this.passClearOld,e),this.composerEffects[1].enablePass(this.passClearOld,e),this.composerEffects[1].enablePass(this.passDepthOld,e),this.composerEffects[1].enablePass(this.passSectionCappingFrontFaces2,s&&e),this.composerEffects[2].setPassClear(this.passClearOld,e),this.composerEffects[2].setPassClearDepth(this.passClearOld,e),this.composerEffects[2].enablePass(this.passClearOld,e),this.composerEffects[2].enablePass(this.passDepthNew,e),this.composerEffects[2].enablePass(this.passSectionCappingFrontFaces3,s&&e);for(var t=0;t<3;t++)this.composerEffects[t].enablePass(this.forwardPass,!1),this.composerEffects[t].needsUpdate=e,this.composerEffects[t].enablePass(this.v6renderer.infPlanePass,!1),this.composerEffects[t].enablePass(this.v6renderer.mirrorBlendPass,!1)}})}),define("Effects/CompareModelsEffect",["DS/Effects/CompareModelsEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/CompareModelsEffect"),e}),define("DS/Effects/HighlightMobileEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/HighlightEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/AdvancedHighlightShader","DS/Plugins/ClearPass","DS/Visualization/RenderMode"],function(e,s,t,i,a,r,n,h){"use strict";return s.extend({init:function(e,s,t,i){return this._parent(e,s,t,i,r.FinalMobileBlending(0)),this},_updateMixPassShader:function(e){this.mixPass._updateMaterialShader(r.FinalMobileBlending(e))}})}),define("Effects/HighlightMobileEffect",["DS/Effects/HighlightMobileEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/HighlightMobileEffect"),e}),define("DS/Effects/FlareEffect",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/BloomShaders","DS/Shaders/FlareShaders"],function(e,s,t,i,a,r,n){"use strict";return t.extend({init:function(t,h){this._parent(t),this.threshold=1,this.passThreshold,this.passBlurH,this.passBlurV,this.passThreshold=new a(r.Threshold);var o;o=new s.WebGLRenderTargetProperties(.5*this.width,.5*this.height,"uint"),this.composers[0]=new i(t,o,h),this.passBlurH=new a(r.BlurH),this.passBlurV=new a(r.BlurV),this.composers[0].addPass(this.passThreshold),this.composers[0].addPass(this.passBlurH),this.composers[0].addPass(this.passBlurV),this.passThreshold.uniforms.threshold.value=this.threshold,this.mixPass=new a(n.FinalBlending,void 0,"FlareEffect");var l=e.getWebappsAssetUrl("Effects",""),p=new s.ImageUtils.loadTexture(l+"lenscolor.png",void 0,null,null,s.ImageUtils.crossOriginPolicy);p.minFilter=s.LinearFilter,p.magFilter=s.LinearFilter;var u=new s.ImageUtils.loadTexture(l+"lensdirt.png",void 0,null,null,s.ImageUtils.crossOriginPolicy);return u.minFilter=s.LinearFilter,u.magFilter=s.LinearFilter,this.mixPass.uniforms.tLensColor.value=p,this.mixPass.uniforms.tLensDirt.value=u,this},initEffect:function(e,s){s.getComposer("result").linkToShaderPassUniform(this.passThreshold,this.passThreshold.uniforms.tDiffuse2),s.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tBlur),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,s,t){},setSize:function(e,s){if(this._parent(e,s)){this.composers[0].setSize(.5*this.width,.5*this.height),this.passBlurH.uniforms.invSize.value.set(1/(.5*this.width),1/(.5*this.height)),this.passBlurV.uniforms.invSize.value.set(1/(.5*this.width),1/(.5*this.height)),this.mixPass.uniforms.invSize.value.set(1/(.5*this.width),1/(.5*this.height))}}})}),define("Effects/FlareEffect",["DS/Effects/FlareEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/FlareEffect"),e}),define("DS/Effects/XRevealStructureEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ShaderPass","DS/Shaders/TextureBlendingShader"],function(e,s,t,i){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.rtPool=s,this.name="xRevealStructurePass",this.mixPass=null,this},initEffect:function(e,s){var a=this.name;e?(this.mixPass=new t(i.AlphaBlendingShader,void 0,a),this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0,this.mixPass.material.depthTest=!1):this.mixPass=new t(i.AlphaBlendingShader,"tScene",a),s.insertComposer(null,this.mixPass)},update:function(s,t,i){if(i.camera.fullWidth){var a=-i.camera.x/i.camera.width,r=-(i.camera.fullHeight-i.camera.height-i.camera.y)/i.camera.height;this.mixPass.uniforms.offset.value=new e.Vector2(a,r);var n=i.camera.width/i.camera.fullWidth,h=i.camera.height/i.camera.fullHeight;this.mixPass.uniforms.invSize.value=new e.Vector2(n,h)}else this.mixPass.uniforms.offset.value=new e.Vector2(0,0),this.mixPass.uniforms.invSize.value=new e.Vector2(1,1)},updateTexture:function(e){this.mixPass&&(this.mixPass.uniforms.tTexture.value=e)},setSize:function(e,s){this._parent(e,s)}})}),define("Effects/XRevealStructureEffect",["DS/Effects/XRevealStructureEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/XRevealStructureEffect"),e}),define("DS/Effects/MLAAEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Shaders/MLAAShaders"],function(e,s,t,i,a,r){"use strict";return t.extend({init:function(t,n){this._parent(t);var h=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers.push(new i(t,h,n)),this.pass1=new a(r.EdgeDetection),this.pass2=new a(r.BlendingWeights),this.mixPass=new a(r.FinalBlending,void 0,"MLAAEffect"),this.composers[0].addPass(this.pass1),this.composers[0].addPass(this.pass2);var o=s.getWebappsAssetUrl("Effects",""),l=new e.ImageUtils.loadTexture(o+"AreaTexMLAA.png",void 0,null,null,e.ImageUtils.crossOriginPolicy);return l.minFilter=e.LinearFilter,l.magFilter=e.LinearFilter,this.pass2.uniforms.areaTex.value=l,this},initEffect:function(e,s){s.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,s,t){},setSize:function(e,s){this._parent(e,s)&&(this.composers[0].setSize(this.width,this.height),this.pass1.uniforms.screenWidth.value=this.width,this.pass1.uniforms.screenHeight.value=this.height,this.pass2.uniforms.screenWidth.value=this.width,this.pass2.uniforms.screenHeight.value=this.height,this.mixPass.uniforms.screenWidth.value=this.width,this.mixPass.uniforms.screenHeight.value=this.height)}})}),define("Effects/MLAAEffect",["DS/Effects/MLAAEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/MLAAEffect"),e}),define("DS/Effects/BokehDOFEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ShaderPass","DS/Shaders/BokehDOFShader"],function(e,s,t,i){"use strict";return s.extend({init:function(s,a){var r;this._parent(s),this.behaviour=0,this.useCameraInfo=!1,this.mixPass=new t(i,void 0,"BokehDOFEffect"),this.mixPass.uniforms.focusCoords.value.set(.5,.5),this.defines={RINGS:3,SAMPLES:8,DOF_BEHAVIOUR:this.behaviour,PHYSIC:1},this.mixPass.material.defines=this.defines,this.autofocus=!0,this.distanceToTarget=100,this.lensRadius=1,this.sceneScale=1,this.maxCoC=1,this.iterative=!1,this.maxIteration=128,this.dofOffset=[];var n=0;for(r=0;r<this.maxIteration;r++){var h;do{(h=e.RandomLib.LowDiscrepancy2D(n)).x=2*h.x-1,h.y=2*h.y-1,n++}while(h.length()>1);this.dofOffset.push({x:h.x,y:h.y})}return this.dofOffset.sort(function(e,s){return e.x*e.x+e.y*e.y<s.x*s.x+s.y*s.y?-1:1}),this},initEffect:function(e,s){s.insertComposer(null,this.mixPass),s.getComposer("normalDepth").linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tNormalDepth)},update:function(s,t,i){if(i._renderedCamera.projectionMatrixInverse.getInverse(i._renderedCamera.projectionMatrix),this.mixPass.uniforms.realProjectionMatrixInverse.value=i._renderedCamera.projectionMatrixInverse,this.useCameraInfo){var a=i.camera;if(a instanceof e.PerspectiveCamera){var r=a.focalLength;this.mixPass.uniforms.focalLength.value=r,this.lensRadius=r,this.mixPass.uniforms.fstop.value=a.aperture,this.mixPass.uniforms.sensorSize.value=a.sensorSizeHeight}}this.autofocus&&(this.distanceToTarget=i.getTargetDistance(),this.mixPass.uniforms.focalDepth.value=this.distanceToTarget*this.sceneScale)},updateFocalPlane:function(e){this.distanceToTarget=e,this.mixPass.uniforms.focalDepth.value=e},updateFocalLength:function(e){this.mixPass.uniforms.focalLength.value=e,this.lensRadius=e},updateFStop:function(e){this.mixPass.uniforms.fstop.value=e},updateAperture:function(e){this.mixPass.uniforms.fstop.value=0==e?999999999:this.mixPass.uniforms.focalLength.value/e},setSceneScale:function(e){this.sceneScale=e,this.mixPass.uniforms.sceneScale.value=e},setMaximumCircleOfConfusion:function(e){this.maxCoC=Math.max(Math.min(e,1),0),this.mixPass.uniforms.maxCoC.value=e},setAutoFocus:function(e){this.autofocus=e},setSize:function(e,s){this._parent(e,s)&&(this.mixPass.uniforms.textureWidth.value=e,this.mixPass.uniforms.textureHeight.value=s)},setIterative:function(e){if(e!==this.iterative&&(this.iterative=e,this.mixPass)){var s=this.mixPass.composer;s&&s.contexts.length&&s.contexts[0].enablePass(this.mixPass,this.enabled&&!this.iterative)}},getMaxIteration:function(){return this.maxIteration},computeJitterCamera:function(s,t,i){var a=this.width/this.height,r=s.clone();r._renderingRole=s._renderingRole;var n=r.near*Math.tan(e.Math.degToRad(.5*r.fov)),h=a*n,o=Math.min(this.getMaxIteration()-1,t),l=r.near*this.lensRadius*this.dofOffset[o].x/this.mixPass.uniforms.focalDepth.value,p=r.near*this.lensRadius*this.dofOffset[o].y/this.mixPass.uniforms.focalDepth.value,u=h-l,c=-(h+l),d=n-p,m=-(n+p);i&&(i.x*=2*Math.abs(h),i.y*=2*Math.abs(n),c+=i.x,u+=i.x,m+=i.y,d+=i.y);var f=r.getLookAt().cross(r.up);return r.position.add(r.up.clone().multiplyScalar(this.lensRadius*this.dofOffset[o].y)),r.position.add(f.clone().multiplyScalar(this.lensRadius*this.dofOffset[o].x)),r.projectionMatrix.makeFrustum(c,u,m,d,r.near,r.far),r},Behaviours:{LOW:0,MEDIUM:1,HIGH:2,ARTISTIC:3},setBehaviour:function(e){null!=e&&this.behaviour!=e&&(this.behaviour=e,this.defines.DOF_BEHAVIOUR=this.behaviour,this.defines.RINGS=0==this.behaviour?3:5,this.defines.SAMPLES=0==this.behaviour?8:15,this.mixPass.material.needsUpdate=!0)}})}),define("Effects/BokehDOFEffect",["DS/Effects/BokehDOFEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/BokehDOFEffect"),e}),define("DS/Effects/DebugPassEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/ReplaceBlendShader","DS/Shaders/DisplayPassShader"],function(e,s,t,i,a,r,n){"use strict";return s.extend({init:function(s,i){this._parent(s);var n=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");return this.composers.push(new t(s,n,i)),this.debugPass=null,this.mixPass=new a(r,void 0,"DebugPassEffect"),this},initEffect:function(e,s){null===this.debugPass&&(this.debugPass=new a(n),this.composers[0].addPass(this.debugPass),null!==s.HighlightEffect?s.HighlightEffect.composers[0].linkToShaderPassUniform(this.debugPass,this.debugPass.uniforms.tDiffuse2):s.composers[0]&&s.composers[0].linkToShaderPassUniform(this.debugPass,this.debugPass.uniforms.tDiffuse2),s.pickingGPUComposerContext||s.initComposer("PickingGPU"),s.pickingGPUComposerContext.linkToShaderPassUniform(this.debugPass,this.debugPass.uniforms.tDiffuse3),s.getComposer("normalDepth").linkToShaderPassUniform(this.debugPass,this.debugPass.uniforms.tDiffuse4));s.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tDiffuse2),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,s,t){},setSize:function(e,s){this._parent(e,s)&&this.composers[0].setSize(this.width,this.height)}})}),define("Effects/DebugPassEffect",["DS/Effects/DebugPassEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/DebugPassEffect"),e}),define("DS/Effects/FXAAEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ShaderPass","DS/Shaders/FXAAShader"],function(e,s,t,i){"use strict";return s.extend({init:function(e){return this._parent(e),this.mixPass=new t(i.FXAAShader,void 0,"FXAAEffect"),this},initEffect:function(e,s){s.insertComposer(null,this.mixPass)},update:function(e,s,t){},setSize:function(e,s){this._parent(e,s)&&this.mixPass.uniforms.resolution.value.set(1/e,1/s)}})}),define("Effects/FXAAEffect",["DS/Effects/FXAAEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/FXAAEffect"),e});