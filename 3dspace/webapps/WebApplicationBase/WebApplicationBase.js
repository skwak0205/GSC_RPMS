define("DS/WebApplicationBase/W3AASGNodeHolder",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement"],function(e,t,n){"use strict";return e.extend({init:function(){this._sgNode=null},buildSGNode:function(){console.error("Should be overridden and parent not called")},giveSGNode:function(){return this._sgNode},getSGNode:function(){return this._sgNode||(this._pathElement?this._sgNode=this._pathElement.getLastElement():this._sgNode=this.buildSGNode()),this._sgNode},update:function(e){return!(!this._sgNode||!this._sgNode.update)&&(this._sgNode.update(e),this._sgNode.Dirty)},preRender:function(e){if(this._sgNode&&this._sgNode.preRender)return this._sgNode.preRender(e)},postRender:function(e){if(this._sgNode&&this._sgNode.postRender)return this._sgNode.postRender(e)},postUpdate:function(e){if(this._sgNode)return!(!this._sgNode||!this._sgNode.postUpdate)&&this._sgNode.postUpdate(e)},unreferenceSGNode:function(){this._pathElement=null,this._sgNode=null},Dispose:function(){this.unreferenceSGNode()},setSGNodeDirty:function(e){var t=e;void 0===t&&(t=!0),this._sgNode&&(this._sgNode.Dirty=t)},isSGNodeUpToDate:function(){if(this._sgNode)return!this._sgNode.Dirty},setPathElement:function(e){this.isSelfManagedPathElement()?console.warn("isSelfManagedPathElement is set. This method shouldn't be used. Instead, set _pathElement directly"):this._pathElement=e},getPathElement:function(){return this._pathElement?this._pathElement:null},getRelativePathElement:function(e){var t=e.QueryInterface("W3AISGNodeHolder");if(t){var i,r=t.getPathElement(),o=this._pathElement.externalPath.concat([]),s=r.externalPath;o.indexOf(s[s.length-1]);for(i=0;i<s.length;i++)if(s[i]!==o[i])return this._pathElement;o.splice(0,s.length);var a=new n;return a.setFromArray(o),a}return this._pathElement},getMatrix:function(e){return e||console.warn("without a viewer getMatrix method could return unexpected result"),this.getPathElement().getMatrix(e)},getWorldMatrix:function(e){return this.getPathElement()?(e||console.error("without a viewer getWorldMatrix method could return unexpected result"),this.getPathElement().getWorldMatrix(e)):null},getMatrixInLCS:function(e,n,i){return this.getPathElement()?n?(i&&this._invWorldMatrix||(this._invWorldMatrix=(new t.Matrix4).getInverse(this.getWorldMatrix(e))),(new t.Matrix4).multiplyMatrices(this._invWorldMatrix,n)):this.getMatrix(e):null},getPositionInLCS:function(e,n,i){return this.getPathElement()?n?(i&&this._invWorldMatrix||(this._invWorldMatrix=(new t.Matrix4).getInverse(this.getWorldMatrix(e))),n.clone().applyMatrix4(this._invWorldMatrix)):(new t.Vector3).getPositionFromMatrix(this.getMatrix(e)):null},getDirectionInLCS:function(e,n,i){return this.getPathElement()?(n||console.error("You have to provide an input direction"),i&&this._invWorldMatrix3||(this._invWorldMatrix3=(new t.Matrix3).getInverse(this.getWorldMatrix(e))),n.clone().applyMatrix3(this._invWorldMatrix3)):null},getMatrixInWCS:function(e,t){if(!this.getPathElement())return null;if(!t)return this.getWorldMatrix(e);var n=this.getWorldMatrix(e);return n?n.clone().multiply(t):t.clone()},getPositionInWCS:function(e,n){return this.getPathElement()?n?n.clone().applyMatrix4(this.getWorldMatrix(e)):(new t.Vector3).getPositionFromMatrix(this.getWorldMatrix(e)):null},getDirectionInWCS:function(e,n){return this.getPathElement()?(n||console.error("You have to provide an input direction"),n.clone().applyMatrix3((new t.Matrix3).copy(this.getWorldMatrix(e)))):null},isSelfManagedPathElement:function(){return!1}})}),define("DS/WebApplicationBase/W3AISGNodeHolder",["DS/WebComponentModeler/CATWebInterface"],function(e){"use strict";return e.singleton({interfaceName:"W3AISGNodeHolder",required:{buildSGNode:function(){},giveSGNode:function(){},getSGNode:function(){},update:function(e){},unreferenceSGNode:function(){},setSGNodeDirty:function(e){},isSGNodeUpToDate:function(){},getPathElement:function(){},getRelativePathElement:function(e){},getMatrix:function(e){},getWorldMatrix:function(e){},getMatrixInLCS:function(e,t){},getPositionInLCS:function(e,t){},getDirectionInLCS:function(e,t){},getMatrixInWCS:function(e,t){},getPositionInWCS:function(e,t){},getDirectionInWCS:function(e,t){},isSelfManagedPathElement:function(){}},optional:{setPathElement:function(e){},preRender:function(e){},postRender:function(e){},postUpdate:function(e){}}})}),define("DS/WebApplicationBase/VCXIReadiness",["DS/WebComponentModeler/CATWebInterface"],function(e){"use strict";return e.singleton({interfaceName:"VCXIReadiness",required:{registerObject:function(e){},clearObjects:function(){},registerPromise:function(e){},clearPromises:function(){},isReady:function(){}},optional:{}})}),define("DS/WebApplicationBase/W3AIManager",["DS/WebComponentModeler/CATWebInterface"],function(e){"use strict";return e.singleton({interfaceName:"W3AIManager",required:{getUpdatePriority:function(){},getInitPhase:function(){},initialize:function(){},unInitialize:function(){},postInitialize:function(){},update:function(e){},preRender:function(e){},postRender:function(e){},postUpdate:function(e){},getVersion:function(){},getAdditionalActionBarSections:function(e){}}})}),define("DS/WebApplicationBase/W3AAManager",["UWA/Class"],function(e){"use strict";var t=e.extend({init:function(){},getUpdatePriority:function(){return this.GetObject&&this.GetObject()!==this&&this.GetObject().getUpdatePriority?this.GetObject().getUpdatePriority():0},getInitPhase:function(){if(this.GetObject&&this.GetObject()!==this&&this.GetObject().getInitPhase)return this.GetObject().getInitPhase()},initialize:function(){if(this.GetObject&&this.GetObject()!==this&&this.GetObject().initialize)return this.GetObject().initialize()},unInitialize:function(){if(this.GetObject&&this.GetObject()!==this&&this.GetObject().unInitialize)return this.GetObject().unInitialize()},postInitialize:function(){if(this.GetObject&&this.GetObject()!==this&&this.GetObject().postInitialize)return this.GetObject().postInitialize()},GetType:function(){return this.GetObject&&this.GetObject()&&this.GetObject()!==this&&this.GetObject().GetType?this.GetObject().GetType():this.GetObject&&this.GetObject()&&this.GetObject().componentType||this.componentType},update:function(e){if(this.GetObject&&this.GetObject()!==this&&this.GetObject().update)return this.GetObject().update(e)},preRender:function(e){if(this.GetObject&&this.GetObject()!==this&&this.GetObject().preRender)return this.GetObject().preRender(e)},postRender:function(e){if(this.GetObject&&this.GetObject()!==this&&this.GetObject().postRender)return this.GetObject().postRender(e)},postUpdate:function(e){if(this.GetObject&&this.GetObject()!==this&&this.GetObject().postUpdate)return this.GetObject().postUpdate(e)},getVersion:function(){return this.GetObject&&this.GetObject()!==this&&this.GetObject().getVersion?this.GetObject().getVersion():"0.0"},getAdditionalActionBarSections:function(e){if(this.GetObject&&this.GetObject()!==this&&this.GetObject().getAdditionalActionBarSections)return this.GetObject().getAdditionalActionBarSections(e)}});return Object.defineProperty(t.prototype,"componentType",{enumerable:!0,get:function(){return"W3AAManager"}}),t}),define("DS/WebApplicationBase/VCXIModelNavigable",["DS/WebComponentModeler/CATWebInterface"],function(e){"use strict";return e.singleton({interfaceName:"VCXIModelNavigable",required:{getParent:function(){},setParent:function(e){},setInternalParent:function(e){},addChild:function(e){},addChildren:function(e){},removeChild:function(e){},setWorkingRoot:function(e){},getWorkingRoot:function(){},getAssetNavigable:function(){},setAssetNavigable:function(e){},isSelfOrganized:function(){},traverse:function(e,t,n){},clear:function(){}},optional:{}})}),define("DS/WebApplicationBase/VCXAModelNavigable",["UWA/Class","UWA/Utils"],function(e,t){"use strict";return e.extend({init:function(){this._father=null,this._childrenList=[]},getParent:function(){return this._father},setParent:function(e){this.getParent()&&this.getParent().removeChild(this),e&&e.addChild(this)},setInternalParent:function(e){this._father=e},getChildren:function(){return this._childrenList},isAncestorOf:function(e){if(e&&e.QueryInterface("VCXIModelNavigable")===e){if(this===e)return!0;for(var t=e.getParent();t;){if(this===t)return!0;t=t.getParent()}return!1}},addChild:function(e){this.getChildren().push(e),e.setInternalParent(this)},addChildren:function(e){this._childrenList=this._childrenList.concat(e);for(var t=0;t<e.length;t++){var n=e[t];n&&n.setInternalParent(this)}},removeChild:function(e){if(e){for(var t=-1,n=this.getChildren(),i=0;i<n.length;i++){var r=n[i];if(r){var o=r.GetObject().GetID();e.GetObject().GetID()===o&&(t=i)}}t>=0&&(this.getChildren()[t].setInternalParent(null),this.getChildren().splice(t,1))}},setWorkingRoot:function(e){this._workingRoot=e},getWorkingRoot:function(){return!this._workingRoot&&this.getParent()&&(this._workingRoot=this.getParent().getWorkingRoot()),this._workingRoot},setAssetNavigable:function(e){this._assetNavigable=e},getAssetNavigable:function(){return!this._assetNavigable&&this.getParent()&&(this._assetNavigable=this.getParent().getAssetNavigable()),this._assetNavigable},isSelfOrganized:function(){return!1},traverse:function(e,t,n){n&&n.childrenFirst||e(this,t,n);var i=this.getChildren(),r=i.length;let o=!0;for(let s=0;s<r&&o;++s){i[s].traverse(e,t,n),o=!n||!n.stop}n&&n.childrenFirst&&e(this,t,n)},Dispose:function(){this._father&&this._father.removeChild(this),this._father=null,this._childrenList=[],this._workingRoot=null,this._assetNavigable=null},clear:function(e){for(var t=this.getChildren(),n=t.length,i=0;i<n;++i){var r=t[i];r&&"function"==typeof r.clear&&r.clear(!0)}var o=this.GetObject();if(o){var s=o.QueryInterface("CATI3DExperienceObject");s&&s._GetExpDataObject()?this.Dispose():o.CallDispose()}}})}),define("DS/WebApplicationBase/W3AManagerSet",["UWA/Class","DS/CoreEvents/Events"],function(e,t){"use strict";return e.extend({init:function(){this._UpdateArray=[],this._InitArray=[],this._ManagerSet={}},dealWithInitArray:function(e,t,n,i){var r=this._InitArray;return n&&(r=this._InitArray.reverse()),t?r.reduce((t,n)=>t.then(()=>{var t,r=[],o=[];for(t=0;t<n.length;t++)n[t][e]&&(r.push(UWA.Promise.resolve(n[t][e](i))),o.push(n[t].componentType));return UWA.Promise.allSettled(r).then(t=>{if(t&&t.length)for(var n=0;n<t.length;n++){var i=t[n];i&&"rejected"===i.state&&(console.error("Error in "+e+" of manager "+o[n]),console.error(i.reason))}return UWA.Promise.resolve()})}),UWA.Promise.resolve()):(r.every(t=>(t.every(t=>(t[e]&&t[e](i),!0)),!0)),UWA.Promise.resolve())},initialize:function(e){return this.initializePromise=this.dealWithInitArray("initialize",e),this.initializePromise},postInitialize:function(e){return this._firstStep=!0,this.postInitializePromise=this.dealWithInitArray("postInitialize",e).then(()=>{this._loopReady=!0}),this.postInitializePromise},unInitialize:function(e){return this._loopReady=!1,this.unInitializePromise=this.dealWithInitArray("unInitialize",e,!0),this.unInitializePromise},getManager:function(e){var t=this._ManagerSet[e];return t&&t.GetObject()},addManager:function(e,t,n){if(e){var i=t.QueryInterface("W3AIManager");if(i){var r=i.getInitPhase&&i.getInitPhase()||n||5;return this._ManagerSet[e]?(console.warn("The manager "+e+" already exists!"),2):(this._ManagerSet[e]=i,this._InitArray[r]||(this._InitArray[r]=[]),this._InitArray[r].push(i),this._UpdateArray.push(i),i.GetObject()._ManagerSet=this,i._ManagerSet=this,i._experienceBase=i.GetObject()._experienceBase,i._experienceBase&&void 0===this._experienceBase&&(this._experienceBase=i._experienceBase),this._UpdateArray.sort((e,t)=>e.getUpdatePriority()>t.getUpdatePriority()?1:e.getUpdatePriority()<t.getUpdatePriority()?-1:0),this._InitArray[r].sort((e,t)=>e.getUpdatePriority()>t.getUpdatePriority()?1:e.getUpdatePriority()<t.getUpdatePriority()?-1:0),0)}}return console.warn("The manager "+e+" have not been added to the managerSet!"),1},removeManager:function(e){if(e){var t=this._ManagerSet[e];if(t){var n=!1;this._InitArray.every(e=>{for(var i=0;i<e.length&&!n;i++)t===e[i]&&(e.splice(i,1),n=!0);return!n}),n=!1;for(var i=0;i<this._UpdateArray.length&&!n;i++)t===this._UpdateArray[i]&&(this._UpdateArray.splice(i,1),n=!0);t.unInitialize(),delete this._ManagerSet[e]}}},update:function(e){if(this._firstStep&&(this._firstStep=!1,t.publish({event:"/W3A/ManagerSet/RunLoopStarted"})),this._loopReady){if(e&&e.viewer&&!e.viewpoint)if(e.viewer.currentViewpoint)e.viewpoint=e.viewer.currentViewpoint;else{var n=e.viewer.getViewpoints();n&&(e.viewpoint=n[0],e.viewer.currentViewpoint=n[0])}var i;for(i=0;i<this._UpdateArray.length;i++){var r=this._UpdateArray[i];r.update&&r.update(e)}}else console.warn("Loop is not ready!")},preRender:function(e){var t;if(this._loopReady){if(!(e.viewer&&e.viewer.div&&e.viewer.div.style&&"hidden"===e.viewer.div.style.visibility))for(t=0;t<this._UpdateArray.length;t++){var n=this._UpdateArray[t];n.preRender&&n.preRender(e)}}else console.warn("Loop is not ready!")},postRender:function(e){var t;if(this._loopReady)for(t=this._UpdateArray.length-1;t>=0;t--){var n=this._UpdateArray[t];n.postRender&&n.postRender(e)}else console.warn("Loop is not ready!")},postUpdate:function(e){var t;if(this._loopReady)for(t=this._UpdateArray.length-1;t>=0;t--){var n=this._UpdateArray[t];n.postUpdate&&n.postUpdate(e)}else console.warn("Loop is not ready!")},getVersions:function(){var e,t=[];for(e=0;e<this._UpdateArray.length;e++){var n=this._UpdateArray[e];if(n&&n.QueryInterface&&n.GetType){var i=n.QueryInterface("W3AIManager");i&&i.getVersion&&i.getUpdatePriority&&t.push({Type:n.GetType(),Version:i.getVersion(),Priority:i.getUpdatePriority()})}}return t}})}),define("DS/WebApplicationBase/WebComponentsMap",["UWA/Class","UWA/Utils"],function(e,t){"use strict";return e.extend({init:function(){this._ComponentTable={},this._maxID=0,this._hashTable={},this._hashTableValid=!1,this._ComponentsToDispose={}},Clean:function(){for(var e in console.log(">> CallDispose on TOS_ComponentTable"),this._ComponentTable)if(this._ComponentTable.hasOwnProperty(e)){var t=this._ComponentTable[e];t.CallDispose&&t.CallDispose()}this._ComponentTable={},this._maxID=0,this._hashTable={},this._hashTableValid=!1,this.CallDispose()},GetComponentTable:function(){return this._ComponentTable},GetComponentsToDispose:function(){var e=[];for(var t in this._ComponentsToDispose)if(this._ComponentsToDispose.hasOwnProperty(t)){var n=this._ComponentsToDispose[t];e.push(n)}return e},CallDispose:function(){for(var e in console.log(">> CallDispose on TOS_ComponentsToDispose"),this._ComponentsToDispose)if(this._ComponentsToDispose.hasOwnProperty(e)){var t=this._ComponentsToDispose[e];t.CallDispose&&t.CallDispose()}this._ComponentsToDispose={}},AddComponent:function(e){if(this._hashTableValid=!1,e){var n=e.GetID();if(n){if(this._ComponentTable[n])return}else n=t.getUUID().substr(0,18),e.SetID(n.toString());this._ComponentTable[n]=e,delete this._ComponentsToDispose[n]}else console.warn("WARNING -> WebComponentsMap::AddComponent FAILED")},RemoveComponent:function(e){this._hashTableValid=!1,this._ComponentTable[e]?(this._ComponentsToDispose[e]=this._ComponentTable[e],delete this._ComponentTable[e]):console.log("RemoveComponent: this ID is not in the TOS "+e)},GetComponentFromID:function(e){var t=this._ComponentTable[e];return void 0===t?null:t},GetComponentsFromIDs:function(e){for(var t=[],n=0;n<e.length;++n){var i=e[n],r=this.GetComponentFromID(i);r&&t.push(r)}return t},GetComponentFromType:function(e,t){var n=[];for(var i in this._ComponentTable)if(this._ComponentTable.hasOwnProperty(i)){var r=this._ComponentTable[i];r.IsKindOf(e)?t||n.push(r):t&&n.push(r)}return n},GetComponentsFromFilterMethod:function(e){if("function"==typeof e){var t=[];for(var n in this._ComponentTable)if(this._ComponentTable.hasOwnProperty(n)){var i=this._ComponentTable[n];e(i)&&t.push(i)}return t}console.warn("GetComponentsFromFilterMethod needs a function as unique argument.")},GetComponentFromLink:function(e){if(e){var t=e.GetValue();return this.GetComponentFromID(t)}return null},InitHashTable:function(){for(var e in this._ComponentTable)if(this._ComponentTable.hasOwnProperty(e)){var t=this._ComponentTable[e];if(t.QueryInterface("W3AISGNodeHolder")&&t.QueryInterface("W3AISGNodeHolder").getPathElement){var n=t.QueryInterface("W3AISGNodeHolder").getPathElement(),i=this.BuildHashingFromPathElement(n);this._hashTable[i]=t}}this._hashTableValid=!0},BuildHashingFromPathElement:function(e){return e?this.BuildHashingFromExternalPath(e.externalPath):null},BuildHashingFromExternalPath:function(e){for(var t="",n=e.length,i=0;i<n;i++){var r=e[i];r&&(t+=r.id),i<n-1&&(t+=".")}return t},GetComponentFromPathElement:function(e){return this.GetComponentFromExternalPath(e.externalPath)},GetComponentsFromPathElements:function(e){if(Array.isArray(e)){for(var t=[],n=0;n<e.length;++n){var i=e[n],r=i&&this.GetComponentFromPathElement(i);t.push(r)}return t}},GetComponentFromExternalPath:function(e){this._hashTableValid||this.InitHashTable();for(var t,n=e;n.length;){var i=this.BuildHashingFromExternalPath(n),r=this._hashTable[i];if(r)return r;t||(n=t=e.slice()),n.pop()}}})}),define("DS/WebApplicationBase/VCXAReadiness",["UWA/Class"],function(e){"use strict";return e.extend({init:function(){this._promises=[],this._objects=[]},Dispose:function(){delete this._promises,delete this._objects},getObjects:function(){return this._objects},registerObject:function(e){this._objects.push(e)},clearObjects:function(){this._objects=[]},registerPromise:function(e){this._promises.push(e),e.then(()=>{if(this._promises){let t=this._promises.indexOf(e);this._promises.splice(t,1)}})},clearPromises:function(){this._promises=[]},isReady:function(){var e=[];return this._promises.length&&e.push(Promise.allSettled(this._promises)),this.getObjects().forEach(t=>{var n=t&&t.QueryInterface&&t.QueryInterface("VCXIReadiness")&&t.QueryInterface("VCXIReadiness").isReady();n&&e.push(n)}),e.length?Promise.allSettled(e):null}})}),define("DS/WebApplicationBase/WebApplicationBase",["DS/WebApplicationBase/WebComponentsMap","DS/WebComponentModeler/WebComponentModelerBase","DS/WebApplicationBase/W3AManagerSet"],function(e,t,n){"use strict";return t.extend({init:function(){this._parent(),this._ManagerSet=new n;var t=new e;Object.defineProperty(this,"ComponentsMap",{enumerable:!0,get:function(){return t}})},Clean:function(){this._parent(),this.ComponentsMap.Clean()},BuildComponentsFromNode:function(e,t){!0!==this.deprecatedDisplayed&&(console.warn("BuildComponentsFromNode is DEPRECATED since R420 please use BuildComponentsFromNodeEXT instead"),this.deprecatedDisplayed=!0);for(var n=e.getChildren(),i=0;i<n.length;i++){var r=n[i],o=t.clone();if(o.addElement(r),"Reference3D"!==r.productType&&"InstanceRep"!==r.productType)(s=this.Factory.BuildComponent("VCXWebComponentOccurrence"))&&(s.QueryInterface("W3AISGNodeHolder").setPathElement(o),this.ComponentsMap.AddComponent(s));else if("Experience"===r.name){var s;(s=this.Factory.BuildComponent("VCXWebComponentOccurrence"))&&(s.QueryInterface("W3AISGNodeHolder").setPathElement(o),s.SetID("VCX_Root"),s.SetPersistency(0)),this.ComponentsMap.AddComponent(s)}"InstanceRep"!==r.productType&&this.BuildComponentsFromNode(r,o)}},BuildComponentsFromNodeEXT:function(e,t,n,i){for(var r=e.getChildren(),o=0;o<r.length;o++){var s=r[o],a=t.clone();a.addElement(s);var h=null;void 0!==s.VCX_ROOT_ID||(h=i.componentTypeFromFunction?i.componentTypeFromFunction(s):void 0!==s[i.attributeToUse]&&""!==s[i.attributeToUse]?i[s[i.attributeToUse]]:i.defaultType);var l=null;if(null!=h){var c=!1;"VCXComponentMesh"===h&&(h="VCXComponentOccurrenceComposer",c=!0);var u=this.Factory.BuildComponent(h);if(u){c&&u.SetIsMesh&&u.SetIsMesh(c);var p=s.name;p&&(u.name=p),(l=u.QueryInterface("VCXIModelNavigable"))&&n&&l.setParent(n);var d=u.QueryInterface("W3AISGNodeHolder");d&&d.setPathElement(a),this.ComponentsMap.AddComponent(u)}}l?this.BuildComponentsFromNodeEXT(s,a,l,i):this.BuildComponentsFromNodeEXT(s,a,n,i)}},getManager:function(e){return this._ManagerSet&&this._ManagerSet.getManager(e)}})});