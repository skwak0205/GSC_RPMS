define("DS/DMUBaseUIManipulators/DMUManipulatorsHelper",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/DMUBaseExperience/EXPToolsMaterial","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/EXPManagerSet","DS/DMUBaseExperience/DMUContextManager","DS/Mesh/Mesh"],function(e,t,n,r,o,i,a,s,c){"use strict";return e.extend({init:function(e){if(e){var l,u,d,v,f,g,M=e,p=[];this.ROTATION_SNAP_THRESHOLD=i.convertModelToPixels({sizeInMM:5});for(var C=new t.Color(15235840),h=M.getNodes(),m=0;m<h.length;m++)if("DecorationBag"===h[m].name){v=h[m];break}this.createHVAxis=function(e,a,s){if(e&&a.key&&a.keyCode){p||(p=[]);var l=new n;l.setPickable(c.PICKTHROUGH),l.setNoHighlightNoZ(!0),d||(d=o.createLineMaterial({color:C,opacity:1,lineWidth:window.devicePixelRatio,pattern:"6"})),l.setMatrix((new t.Matrix4).extractRotation(M.currentViewpoint.camera.matrix).setPosition(e));var u=i.getMMPerPixelRatio(M,e),v=i.getViewerPositionFromPoint(M,e);l.addChild(r.createLineNode({points:[new t.Vector3(-v.left*u,0,0),new t.Vector3((M.SCREEN_WIDTH-v.left)*u,0,0)],fill:!1,material:d})),l.addChild(r.createLineNode({points:[new t.Vector3(0,v.top*u,0),new t.Vector3(0,-(M.SCREEN_HEIGHT-v.top)*u,0)],fill:!1,material:d})),p.push({key:a.key,keyCode:a.keyCode,node:l,cb:s})}},this.displayAxis=function(e,a,s){if(e&&"number"==typeof a&&v){p||(p=[]),u?u.removeChildren():((u=new n).setPickable(c.PICKTHROUGH),u.setNoHighlightNoZ(!0),u.setMatrix((new t.Matrix4).extractRotation(M.currentViewpoint.camera.matrix).setPosition(e))),d||(d=o.createLineMaterial({color:C,opacity:1,lineWidth:window.devicePixelRatio,pattern:"6"}));var l=i.getMMPerPixelRatio(M,e),f=r.createLineNode({points:[new t.Vector3,new t.Vector3(s*l,0,0)],fill:!1,material:d}),g=r.createPointsNode({positions:[0,0,0,2*l,3*l,0,4*l,6*l,0,-4*l,-6*l,0,-2*l,-3*l,0,4*l,-6*l,0,2*l,-3*l,0,-4*l,6*l,0,-2*l,3*l,0],color:C,size:2});f.addChild(g),f.setMatrix((new t.Matrix4).makeRotationZ(a)),u.addChild(f),v.addChild(u)}},this.removeAxis=function(){u&&v&&v.removeChild(u)},this.addToListener=function(e,t){var n,r;"Shift"===e?(n="Shift",r=16):"Control"===e&&(n="Control",r=17),p||(p=[]),p.push({key:n,keyCode:r,cb:t})},this.updateManipulationData=function(e){l=e},this.activate=function(){document.addEventListener("keydown",D),document.addEventListener("keyup",y)},this.getPointedElem=function(){var t=s.getContextViewer({viewer:e}),n=t?a.getManager({name:"DMU2DSheetManager",context:t.getFrameWindow()}):null;return n?n.getPointedElem():M.canvas},this.setTextSelectionFlag=function(t){var n=s.getContextViewer({viewer:e}),r=n?a.getManager({name:"DMU2DSheetManager",context:n.getFrameWindow()}):null;r&&r.setTextSelectionFlag(t)},this.getPageNumber=function(t){var n=s.getContextViewer({viewer:e}),r=n?a.getManager({name:"DMU2DSheetManager",context:n.getFrameWindow()}):null;return r?r.getPageNumber(r.getElementToDraw(t)):null},this.isCanvasToDraw=function(t){if(t){var n=s.getContextViewer({viewer:e});if(n){var r=a.getManager({name:"DMU2DSheetManager",context:n.getFrameWindow()});if(r){var o=r.getElementToDraw(t);if(t===o)return!0;for(var i=t.parentNode;i&&"___view___1"!==i.id;){if(i===o)return!0;i=i.parentElement}return!1}if(t&&t===M.canvas)return!0}}return!1},this.setTouchPanActive=function(t){var n=s.getContextViewer({viewer:e}),r=n?a.getManager({name:"DMU2DSheetManager",context:n.getFrameWindow()}):null;r&&r.setTouchPanActive(t)},this.remove=function(){if(document.removeEventListener("keydown",D),document.removeEventListener("keyup",y),p&&p.length)for(var e=0;e<p.length;e++)p[e].node&&v&&v.removeChild(p[e].node);d&&(d.dispose(),d=null),u&&v&&(v.removeChild(u),u.remove()),u=p=null,f=!1,g=!1}}function D(e){if(p&&l){var t=!1;if("Shift"!==e.key&&16!==e.keyCode||f?"Control"!==e.key&&17!==e.keyCode||g||(l.ctrlKey=!0,g=!0,t=!0):(l.shiftKey=!0,f=!0,t=!0),t)for(var n=0;n<p.length;n++)e.key!==p[n].key&&e.keyCode!==p[n].keyCode||(p[n].node&&v&&v.addChild(p[n].node),p[n].cb&&p[n].cb(l))}}function y(e){if(p&&l){"Shift"===e.key||16===e.keyCode?(l.shiftKey=!1,f=!1):"Control"!==e.key&&17!==e.keyCode||(l.ctrlKey=!1,g=!1);for(var t=0;t<p.length;t++)e.key!==p[t].key&&e.keyCode!==p[t].keyCode||(p[t].node&&v&&v.removeChild(p[t].node),p[t].cb&&p[t].cb(l))}}}})}),define("DS/DMUBaseUIManipulators/DMUCursorsController",["UWA/Class","DS/DMUBaseExperience/DMUContextManager"],function(e,t){"use strict";var n=e.extend({init:function(e){this._parent(e);var n=e||{},r=t.getContextViewer({viewer:n.context.getViewer()}),o="",i={};this.setCursors=function(e){i=e||{};var t=r.getViewer();t.canvas.style.cursor=i.canvas||t.canvas.style.cursor,t.divCssElement.style.cursor=i.pages||t.divCssElement.style.cursor,o=i.preHLMarkers||""},this.getPHMarkerCursor=function(){return o},this.resetCursors=function(){i||(i={});var e=r.getViewer();e.canvas.style.cursor=i.canvas||"",e.divCssElement.style.cursor=i.pages||"",o=i.preHLMarkers||""},this.restoreCursors=function(){i={};var e=r.getViewer();e.canvas.style.cursor="",e.divCssElement.style.cursor="",o=""},this.clear=function(){var e=r.getViewer();e.canvas.style.cursor="",e.divCssElement.style.cursor="",o=i=r=null}}}),r=[];return e.singleton({init:function(){},getDMUCursorsController:function(e){var t;if(e&&e.context)for(var o=0;o<r.length;o++)if(r[o].context===e.context){r[o].counter++,t=r[o].commentsController;break}if(e&&e.context&&!t){var i=new n(e);t={setCursors:function(e){i&&i.setCursors(e)},getPHMarkerCursor:function(){if(i)return i.getPHMarkerCursor()},resetCursors:function(){i&&i.resetCursors()},restoreCursors:function(){i&&i.restoreCursors()},clear:function(){if(i)return i.clear()}},r.push({context:e.context,commentsController:t,counter:1})}return t?Object.freeze(t):t},giveDMUCursorsController:function(e){var t;if(e&&e.context)for(var n=0;n<r.length;n++)if(r[n].context===e.context){t=r[n].commentsController;break}return t?Object.freeze(t):t},unreferenceDMUCursorsController:function(e){if(e&&e.context)for(var t=0;t<r.length;t++)if(r[t].context===e.context){r[t].counter--,r[t].counter<=0&&(r[t].commentsController.clear(),r.splice(t,1));break}}})}),define("DS/DMUBaseUIManipulators/DMUBaseRepManipulator",["require","exports","DS/Manipulators/ScreenPlaneManipulator","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Selection/CSOManager","DS/DMUBaseUIManipulators/DMUCursorsController","DS/CoreEvents/ModelEvents","DS/Visualization/ThreeJS_DS","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/WebappsUtils/WebappsUtils","DS/Utilities/TouchUtils","DS/DMUBaseExperience/EXPToolsVisualization"],function(e,t,n,r,o,i,a,s,c,l,u,d){"use strict";return class{constructor(e){let t,v,f,g=new n;g.setExclusive(!0);let M,p,C,h,m,D,y,P=e,w=!1,k={pathElement:r.buildPathElement(P.getNode())},x=new a,b=!1,S="DMUMarker3DText"===P.getType()||"DMUMarker3DStamp"===P.getType()||"DMUMarker2DText"===P.getType()||"DMUMarker2DPicture"===P.getType()||"DMUMarker3DPicture"===P.getType()||"DMUMeasure"===P.getType(),U=new c(P.getViewer()),E=U.getPointedElem(),V=l.getWebappsAssetUrl("DMUMarkerManipulators","icons/32/"),T=i.giveDMUCursorsController({context:P.getFrameWindow()});function H(e){!P.isReadOnly()&&P.isEditable()&&(U.updateManipulationData(e),e&&e.event&&e.event.from&&e.event.from.length&&e.event.from[0].event&&e.event.from[0].event.ctrlKey?E.setStyle("cursor",T&&T.getPHMarkerCursor()?T.getPHMarkerCursor():"copy"):E.setStyle("cursor",T&&T.getPHMarkerCursor()?T.getPHMarkerCursor():"url("+V+"DMUPositionCursorHL.png) 10 10, auto"))}this.onBeginManipulateCB=function(e){e&&(D=P.getManipulationData().position,y=d.getViewerPositionFromPoint(P.getViewer(),D),y=new s.Vector2(y.left,y.top))},this.onManipulateCB=function(e){e&&e.translationVector2D&&(e.translationVector2D&&(M=d.getPositionFromIntersection(P.getViewer(),y.clone().add(e.translationVector2D),D)),P.updateRepresentation&&P.updateRepresentation({position:M},!1))},this.onEndManipulateCB=function(e){var t=null;e&&e.event&&e.event.from&&e.event.from.length>0&&(t=e.event.from[e.event.from.length-1].getCurrentPosition()),P.updateRepresentation&&P.updateRepresentation({position:M,mousePosition:t},!0)},P&&P.getNode().onBeginPreactivateCB&&g.subscribe("BeginPreactivate",function(e){P.getNode().onBeginPreactivateCB(e)}),P&&P.getNode().onEndPreactivateCB&&g.subscribe("EndPreactivate",function(e){P.getNode().onEndPreactivateCB(e)}),g.subscribe("BeginManipulate",function(e){if(p=0,v=!1,f=!1,o.isIn(k)||P.getNode().onClickCB||(e&&!e.event.from[0].event.ctrlKey&&o.empty(),o.add(k),w=!0),S){let t=P.getNode().getLabelDimensions(),n={offsetWidth:d.convertModelToPixels({sizeInMM:t.offsetWidth}),offsetHeight:d.convertModelToPixels({sizeInMM:t.offsetHeight})},r=d.getViewerPositionFromPoint(e.viewer,t.position);if(r){let t=new s.Vector2(Math.round((r.left||0)-n.offsetWidth/2),Math.round((r.top||0)-n.offsetHeight/2));h=t.clone().sub(e.event.from[0].getCurrentPosition(e.viewer.canvas)),C=t}}else C=e.event.from[0].getCurrentPosition(e.viewer.canvas);U.remove(),x.publish({event:"onMarkerRepBegingManipulate",data:e}),u.getTouchMode()||(m=setTimeout(function(){v=!0},100))}),g.subscribe("Manipulate",function e(t){if(clearTimeout(m),v=!1,f=!1,!P.isReadOnly()&&P.isEditable()&&U.isCanvasToDraw(t.event.from[0].getView())&&++p>3){let n;b||(T&&T.setCursors({pages:E!==P.getViewer().canvas?"move":null,canvas:E===P.getViewer().canvas?"move":null}),b=!0,U.createHVAxis(d.get3DPositionFromScreenCoordinates({coords:C,viewer:t.viewer}),{key:"Shift",keyCode:16},e),U.activate()),U.updateManipulationData(t),n=S?d.get2DSnappedPosition(t.event.from[0].getCurrentPosition(t.viewer.canvas).clone().add(h)):d.get2DSnappedPosition(t.event.from[0].getCurrentPosition(t.viewer.canvas)),t.translationVector2D=n.sub(C),(t.shiftKey||void 0===t.shiftKey&&t.event.from&&t.event.from.length&&t.event.from[0].event&&t.event.from[0].event.shiftKey)&&(Math.abs(t.translationVector2D.y)>=Math.abs(t.translationVector2D.x)?t.translationVector2D.setX(0):t.translationVector2D.setY(0)),x.publish({event:"onMarkerRepManipulate",data:t})}}),g.subscribe("EndManipulate",function(e){if(clearTimeout(m),p<=3)if(P.getNode().onClickCB)P.getNode().onClickCB(e);else if(f||w)v&&w&&!e.event.from[0].event.ctrlKey&&(o.empty(),o.add(k));else{let t=o.isIn(k);e&&e.event.from[0].event.ctrlKey?t&&o.remove(k):t&&P.startEdition?P.startEdition():(o.empty(),o.add(k))}w=!1,b&&(T&&T.restoreCursors(),U.remove(),x.publish({event:"onMarkerRepEndManipulate",data:e}),b=!1)}),g.subscribe("EndPreactivate",function(){T&&T.resetCursors(),U.remove()}),g.subscribe("BeginPreactivate",function(e){!P.isReadOnly()&&P.isEditable()&&(U.addToListener("Control",H),U.activate(),e&&e.event&&e.event.from&&e.event.from.length&&e.event.from[0].event&&e.event.from[0].event.ctrlKey?E.setStyle("cursor",T&&T.getPHMarkerCursor()?T.getPHMarkerCursor():"copy"):E.setStyle("cursor",T&&T.getPHMarkerCursor()?T.getPHMarkerCursor():"url("+V+"DMUPositionCursorHL.png) 10 10, auto"))}),g.subscribe("Preactivate",H),u.getTouchMode()&&(g.HandleLongHold=function(){f=!0}),g.setPrePickingDuringManipulation(!1),g.setPreActivationDuringManipulation(!1),g.setPickingDuringManipulation(!1),g.noCursorChange=!0,this.subscribe=function(e,t){if(e&&t&&x)return x.subscribe({event:e},t)},this.unsubscribe=function(e){x&&e&&x.unsubscribe(e)},this.activate=function(){t&&g.activate(t)},this.deactivate=function(){t&&g.deactivate(t)},this.linkToNode=function(e){t=g.linkToNode(e)},this.destroy=function(){U&&U.remove(),U=C=x=M=null,b=!1,t&&g.unlink(t),t=g=D=y=null}}}});