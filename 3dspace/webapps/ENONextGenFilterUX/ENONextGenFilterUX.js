function ENONextGenFilterUX(e){"use strict";var t={widget:null,init:function(e){this._widget=e.widget,this._widget.addEvent("onLoad",this._onLoad.bind(this)),this._widget.addEvent("onRefresh",this._onRefresh.bind(this)),this._widget.addEvent("onDestroy",this._onDestroy.bind(this)),this._controller=void 0},_onRefresh:function(){},_onLoad:function(){},_onDestroy:function(){}};return t.init(e),t}define("DS/ENONextGenFilterUX/views/StrDropView",["UWA/Core","UWA/Class/View"],function(e,t){"use strict";return t.extend({name:"Str-drop",_zonesCounter:{add:0,replace:0},className:function(){return this.getClassNames("-container")},setup:function(){this._addContentDiv=e.createElement("div",{class:"drop-zone add-content",html:{tag:"div",html:[{tag:"span",class:"fonticon fonticon-popup"},{tag:"p",html:"dropAddContent"}]}}),this._addContentDiv.addEventListener("drop",this._onDrop.bind(this)),this.container.addEventListener("dragover",this._onDragOver),this.container.setContent(this._addContentDiv)},show:function(e,t){console.log("RCIII show de StrDropView"),"none"===this.container.getStyle("display")&&(this.container.setStyle("width",e+"px"),"extract"===sessionStorage.getItem("ENOStr_currentDrag")||!0===t?this._addContentDiv.addClassName("full"):this._addContentDiv.removeClassName("full")),this.container.show()},hide:function(){console.log("RCIII hide de StrDropView"),this.container.hide(),this._zonesCounter.add=0,this._zonesCounter.replace=0,this.dispatchEvent("ENOStr_hide",[])},updateHeight:function(e){console.log("RCIII updateheight de StrDropView"),this._addContentDiv.setStyle("height",e+"px")},_onDragOver:function(e){console.log("RCIII dragOver de StrDropView"),e.stopPropagation(),e.preventDefault()},_onDrop:function(e){e.stopPropagation(),e.preventDefault(),this.hide();for(var t,i,n,s="function"==typeof e.dataTransfer.types.indexOf?"indexOf":"contains",o="",r=["text/searchitems","text/plain","Text"],a=e.currentTarget.hasClassName("add-content")?"add":"replace",l=0;l<r.length&&""===o;l++)("number"==typeof(n=e.dataTransfer.types[s](r[l]))&&n>=0||"boolean"==typeof n&&!0===n)&&(o=r[l]);(i=e.dataTransfer.getData(o)).length&&(a=(t=JSON.parse(i)).action?t.action:a),this.dispatchEvent("ENOStr_drop",[a,t]),sessionStorage.removeItem("ENOStr_currentDrag")}})}),define("DS/ENONextGenFilterUX/views/FilterActiveCriteria",["UWA/Core","UWA/Class","DS/WebappsUtils/WebappsUtils","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/TagNavigator/ActiveTagView"],function(e,t,i,n,s){"use strict";return t.extend({init:function(e){},setActiveCriteria:function(e,t){return{localfilters:e}},criteriaToHTML:function(t,i){var o="";i.widgetId=i.widgetId||this._widgetId,i.proxyId=i.proxyId||this._proxyId;var r=void 0;if(void 0===(r=i.getProxyFilters(t,i))&&(i.proxyId=this._proxyId,r=i.getProxyFilters(t,i)),r){var a=r.filterName;if(a){var l=i.contextId||"",d=i.widgetId||"",c="NGFilter-_-"+l,u=n.get("filterPredicate"),h="",p=a+"_"+d+"_"+Date.now().toString();if(i.isSimplified)h='<div id="'+c+'" class="appCriteria"><ul class="active-predicate-list">'+e.createElement().grab(new s({id:p,text:a,isSimplified:!0,icon:"fonticon-filter"}).render().container).getHTML()+"</ul></div>";else h='<div id="'+c+'" class="appCriteria"><ul class="active-predicate-list"><li class="predicate selected"><div class="predicate-header"><div class="predicate-label"><span class="fonticon fonticon-filter"></span>'+u+'</div></div></li><li class="tag selected" id="'+p+'"><div class="tag-label">'+a+"</div></li></ul></div>";o='<div class="NGFilter_'+d+'">'+h+"</div>"}}return this._widgetId=i.widgetId,this._proxyId=i.proxyId,o}})}),define("DS/ENONextGenFilterUX/utils/NGFSecurityCtxConverter",["UWA/Class","UWA/Promise"],function(e,t){"use strict";return e.singleton({init:function(){},getSecurityContext:function(e){var t="string"==typeof e?JSON.parse(e):e;return this._prepareForStorage(t)},getPrefixedSecurityContext:function(e){return-1===e.indexOf("ctx::")?"ctx::"+e:e},_prepareForStorage:function(e){var t,i,n,s=e.pid;for(var o in e.preferredcredentials)if(e.preferredcredentials.hasOwnProperty(o)){var r=e.preferredcredentials[o];switch(o){case"collabspace":t=r.name,r.title?r.title:t;break;case"organization":i=r.name;break;case"role":n=r.name}}for(var a=this._buildSecurityContext(t,i,n),l=[],d=0;d<Object.keys(e.collabspaces).length;d++)for(var c=e.collabspaces[d],u=0;u<c.couples.length;u++){var h=this._extractCouple(c.couples[u]);l.push(h.org)}var p=1===(l=l.filter((e,t)=>l.indexOf(e)===t)).length?1:0,_=[];for(var f in e.collabspaces)if(e.collabspaces.hasOwnProperty(f)){c=e.collabspaces[f];for(var m=0;m<c.couples.length;m++){h=this._extractCouple(c.couples[m]);var g=this._buildSecurityContext(c.name,h.org,h.role),v=c.title?c.title:c.name,b={csName:v,label:this._buildDisplayString(v,p?"":h.orgNls,h.roleNls),value:g};a===g&&(b.isDefault=!0),_.push(b)}}return{userId:s,securityContext:a,cspaces:_}},_extractCouple:function(e){var t="",i="",n="";for(var s in e)if(e.hasOwnProperty(s)){var o=e[s];switch(s){case"organization":t=o.name,o.title||t;break;case"role":i=o.name,n=o.nls||i}}return{org:t,role:i,roleNls:n}},_buildSecurityContext:function(e,t,i){return i+"."+t+"."+e},_buildDisplayString:function(e,t,i){return e+" ● "+(t?t+" ● ":"")+i}})}),define("DS/ENONextGenFilterUX/utils/FilterUIService",["UWA/Class","UWA/Core","UWA/Class/Options","UWA/Promise","UWA/Date","DS/WAFData/WAFData","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/ENONextGenFilterUX/utils/NGFSecurityCtxConverter","DS/ENOFilterBIUX/NGFServices","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","text!DS/ENONextGenFilterUX/assets/ENOStrRefinementUX_supportedTypes.json","DS/Logger/Logger","DS/PlatformAPI/PlatformAPI","DS/FedDictionaryAccess/FedDictionaryAccessAPI","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/FBISettings","text!DS/ENONextGenFilterUX/assets/ENOStrRefinementUX_require.json","DS/Utilities/TouchUtils"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,f,m,g,v,b){"use strict";var C=e.singleton(i,{TOUCH_MODE:!0,FILTER_TOUCH_CLASSNAME:"filter-no-touch-mode",MAX_DEEP_ATTRIBUTE_GROUP:4,MAX_FILTER_SPECIFICATION:4,MAX_CAR_FOR_CONFIG:100,MAX_DEEP_VOLUME_GROUP:2,ATTRIBUTE_NOT_VALUATED:"NotValuated",MAX_MRU_VALUE:5,MAX_SELECTION_PATH:50,XSS_NOT_ALLOWED:["<",">","/","@"],NAME_RULES:{notAllowedChars:['"',"#","$","%","*",",","?","\\","[","]","|",":","'",";"],maxLength:127},FILTER_RELATED_TO_ROOT:"toRoot",FILTER_RELATED_TO_ALL_REVISIONS:"toAllRevisions",FILTER_RELATED_TO_ANY_ROOT:"toAnyRoot",FILTER_ANY_OBJECT:"anyObject",init:function(){this.FILTER_TOUCH_CLASS=this.TOUCH_MODE?"":" "+this.FILTER_TOUCH_CLASSNAME,this.NAME_RULES.notAllowedChars=this.XSS_NOT_ALLOWED.concat(this.NAME_RULES.notAllowedChars),this._vocabURL=null,this._nlsNames=[],this._notificationsManager=a,l.setNotificationManager(this._notificationsManager),l.setStackingPolicy(5),this._easyAttributeDisplay=c.isActivated("easyAttribute")},updateTouchMode:function(e){b.setTouchMode(e),C.TOUCH_MODE=e,C.FILTER_TOUCH_CLASS=this.TOUCH_MODE?"":" "+this.FILTER_TOUCH_CLASSNAME},isEasyAttributeDisplayMode:function(){return this._easyAttributeDisplay},setEasyAttributeDisplayMode:function(e){this._easyAttributeDisplay=e?1:0},getPlatformServices:function(e){var t=this;return m.getOption("fromWebInWin")?new n(function(e){e()}):new n(function(i,n){m.getPlatformServices(e).then(function(){t.setOption("str_platformServices",m.getOption("str_platformServices")),i()},function(e){console.debug(" => FilterUIService / Get Platform Services failed!"),console.debug(" Error = "+e),n()})})},getPlatformServiceUrl:function(e,t){var i=this._getPlatformUrlAccordingToTenant(e);return i?i[t||"3DSpace"]:i},_getPlatformUrlAccordingToTenant:function(e){for(var t,i=e||c.getTenant(),n=this.getOption("str_platformServices"),s=0;s<n.length;s++)if(i===n[s].platformId){t=n[s];break}return t},_getURL:function(e,t){if(Array.isArray(C.getOption("str_platformServices")))return this.getPlatformServiceUrl(void 0,e)+t;throw new Error("Platform services not initialize yet")},getExpandUrl:function(e){return this._getURL(e,"/cvservlet/expand")},getFetchUrl:function(e){return this._getURL(e,"/cvservlet/fetch/v2")},getMultiExpandUrl:function(e){return this._getURL(e,"/cvservlet/multiexpand")},getCRSFTokenUrl:function(e){return this._getURL(e,"/resources/v1/application/E6WFoundation/CSRF")},getMaturityNextStatesUrl:function(e){return this._getURL(e,"/resources/v1/modeler/dslc/maturity/getNextStates")},getMaturityChangeStateUrl:function(e){return this._getURL(e,"/resources/v1/modeler/dslc/maturity/changeState")},getMaturityStatesAttributesUrl:function(e){return this._getURL(e,"/resources/lifecycle/maturity/getStatesAttributes")},getVersioningUrl:function(e){return this._getURL(e,"/resources/v1/modeler/dslc/version/create")},getOwnershipUrl:function(e){return this._getURL(e,"/resources/v1/modeler/dslc/ownership/transfer")},getVocabularyClassesUrl:function(e){return this._getURL(e,"/resources/6WVocab/access/VocabularyClasses?name=ds6wg")},getAllSecurityContextsUrl:function(e){return this._getURL(e,"/resources/modeler/pno/person?current=true&select=preferredcredentials&select=collabspaces")},getAllSecurityContexts:function(e){return new n(function(t,i){o.authenticatedRequest(C.getAllSecurityContextsUrl(e),{headers:C.getRESTHeaders(),method:"GET",type:"json",proxy:"passport",onComplete:function(e){null!==e&&t(d.getSecurityContext(e))},onFailure:function(e){i(e)}})})},displayNotification:function(e){e.sticky=e.sticky||!1,this._notificationsManager.addNotif(e)},getPlatformId:function(){return this._getPlatformUrlAccordingToTenant().platformId},getRESTHeaders:function(){return{Accept:"application/json","Content-Type":"application/json","Accept-Language":m.getLanguage().toLowerCase()}},isFilterCmdHeaderActivated:function(){return c.isDebugActive("extendedCmds")},isDelayedSynthesisActive:function(){return g.getOption("delayedSynthesis")||0},checkAndGetListOfAttributesFromSelectedFilter:function(e){for(var t=[],i=[],s=[],o=[],r=c.getFilterUIComponents(e),a=r.length,l=1;l<a;l++){r[l].toFeedUI.forEach(e=>{if("attribute"===e.criteriaType)"null"!==e.extension&&void 0!==e.extension||(e.extension="",e.nlsExtension=""),s.push(e.type),o.push(e.extension);else if("Sequence"===e.criteriaType){if("attribute"===e.sequenceType)e.allAttributes.forEach(e=>{"null"!==e.extension&&void 0!==e.extension||(e.extension="",e.nlsExtension=""),s.push(e.type),o.push(e.extension)})}})}for(var d=function(e,t){return new n(function(i,n){var s=c.getTenant(),o=m.getLanguage().toLowerCase();f.getExtensionsForClass(e,{tenantId:s,lang:o,apiVersion:"R2019x",onComplete:function(e){if(e&&e.extensions&&e.extensions.length){if(e.extensions.find(function(e){var i=e.curi;return i=i.substring(i.indexOf(":")+1),t===i})){var n="ds6wg:"+t;f.getPropertiesForClass(n,{tenantId:s,lang:o,apiVersion:"R2019x",onComplete:function(e){var n=e.length?e[0].properties:[];i({type:t,attributes:n})},onFailure:function(e){i({type:t,attributes:[]})}})}}else i({type:t,attributes:[]})},onFailure:function(e){n(e)}})})},u=function(e){return new n(function(t,i){var n="ds6wg:"+e;f.getPropertiesForClass(n,{tenantId:c.getTenant(),lang:m.getLanguage().toLowerCase(),apiVersion:"R2019x",onComplete:function(i){var n=[];if(i)for(var s=i.length,o=0;o<s;o++)n=n.concat(i[o].properties);t({type:e,attributes:n})},onFailure:function(e){i(e)}})})},h=0;h<s.length;h++)s[h]&&(i.push(u(s[h])),o[h]&&i.push(d(s[h],o[h])));return n.all(i).then(function(e){return e.forEach(e=>{t[e.type]=e.attributes}),t})},checkForBadCharacters:function(e){var t=!0;if("string"==typeof e){var i="[\\"+C.NAME_RULES.notAllowedChars.join("\\")+"]";t=!e.match(i)}return t},getAttributeButtonStyle:function(e){return{touchMode:C.TOUCH_MODE,displayStyle:"normal",showLabelFlag:!1,icon:this.getIconByName(e)}},getAttributeValidateButtonStyle:function(){var e=C.getAttributeButtonStyle("check");return e.displayStyle="normal",e},getExpandSynthesisInfos:function(e,t){var i=1===g.getOption("ProgressiveSynthesisOn")?1:0;return c.isProgressiveExpandActive()&&i?this._getProgressiveExpandSynthesis(e,t):this._getMultiExpandSynthesis(e,t)},refreshExpandSynthesisInfos:function(e,t){var i=this,s=1===g.getOption("ProgressiveSynthesisOn")?1:0;return c.isProgressiveExpandActive()&&s?new n(function(n,s){i._getProgressiveExpandSynthesis(e,{},t.CVQueryV2).then(function(e){e&&0===e.length&&i.displayNotification({level:"info",message:u.get("ExpandSynthesisWithEmptyResult")}),n(e)},function(e){s(e)})}):new n(function(n,s){i._getMultiExpandSynthesis(e,{},t.CVQuery).then(function(e){e&&0===e.length&&i.displayNotification({level:"info",message:u.get("ExpandSynthesisWithEmptyResult")}),n(e)},function(e){s(e)})})},_getMultiExpandSynthesis:function(e,i,r){var a=C.getMultiExpandUrl(e.pfServiceId);return new n(function(n,l){var d=i||{no_type_filter_bo:["PLMPort","PLMConnection"]},u="FilterUI_ExpandSynthesis_"+t.Date.strftime(new s,"%Y-%m-%d-%H:%M:%S"),h={};if(h.label=u,h.synthesis_mode="flat",h.max_count_path="1",r)t.merge(h,r);else{var p={expand_iter:"-1"};p.root_physicalid=e.rootID,t.merge(p,d),h.union={},h.union.expand=[],h.union.expand.push(p)}var _=C.getRESTHeaders();_.SecurityContext=e.securityContext;var f=Date.now(),v="Expand_synthesis_duration",b=function(t,i){var n=Array.isArray(t)?t:[t],s=Array.isArray(i)?i:[i],o={};n.forEach(function(e,t){o[e]=s[t]}),c.setPerformanceTracker(e.widgetId,"NGF-Progressive_Expand_Synthesis","NGFilter_UX",o,1)},y=g.getOption("timeoutExpandSynthesis")||12e4;o.authenticatedRequest(a,{label:u,headers:_,method:"POST",data:JSON.stringify(h),type:"json",proxy:"passport",timeout:y,onComplete:function(e){var t=e.facets||[];if(0===t.length)if(e.error){var i=e.error.errors;console.log(" ==> Expand synthesis failed : "+u),i.forEach(function(e){console.log("     . "+e)}),b(v,-1),l()}else b(v,Date.now()-f),n([]);else m.getNlsInfosForFacets(t).then(function(e){for(var t=[],i=0;i<e.length;i++){var s=e[i];if(s.sixw){var o=s.sixw.split("/"),r=o.length-1;t[o[r]]||(t[o[r]]=[]),t[o[r]].push({value:s.object,nlsvalue:s.dispValue})}}var a=[];for(var l in t)t.hasOwnProperty(l)&&a.push({property:l,values:t[l].sort(function(e,t){return e&&t?e.nlsvalue<=t.nlsvalue?-1:1:0})});b(v,Date.now()-f),n(a)})},onFailure:function(e){console.log(" ==> Expand synthesis failed : "+u),console.log("     . "+e),b(v,-1),l()}})})},_getProgressiveExpandSynthesis:function(e,t,i){var r=c.getProgressiveExpandUrl(c.getTenant(),e.pfServiceId),a={},l=e.rootID,d=g.getOption("ProgressiveExpandLimitMaxPath");if(d&&-1!==d&&(a.parameters={},a.parameters.limit_max_path=d),a.label="Root_"+l,a.root={physical_id:l},a.filter={},a.filter.and_not={},i?a.filter.and_not.left=i.filter:t&&t.filter?a.filter.and_not.left=t.filter:a.filter.and_not.left={all:1},t)a.filter=a.filter.and_not.left;else{a.filter.and_not.right=JSON.parse('{"sequence_filter":{"sequence":[{"uql": "((flattenedtaxonomies:\\"types/PLMPort\\") OR (flattenedtaxonomies:\\"types/PLMConnection\\"))"}]}}')}var u=[],h=g.getOption("ProgressiveSynthesisDepth")||-1;-1!==h&&u.push({truncate:{max_distance_from_prefix:h,prefix_filter:{prefix_path:[{physical_id_path:Array.isArray(l)?l:[l]}]}}}),i&&i.aggregation_processors&&i.aggregation_processors.forEach(e=>{u.push(e)});var p={synthesis:{name:"NGF_ProgressiveExpand_Synthesis",mode:"flat",group_by_facet:1,synthesis_only:1}};1===c.isRootExcludedFromSynthesis()&&(p.synthesis.exclude_root_from_count=!0),u.push(p),a.aggregation_processors=u;var _=c.buildV2GraphProperty(t);_&&(a.graph=_);var f=m.getProgressiveQueryTemplate();f.batch.expands=[a],f.outputs={synthesis:["NGF_ProgressiveExpand_Synthesis"]};var v=1===c.arePredicatesExcludedFromSynthesis()?"exclude_predicates":"facet_name";return f.outputs[v]=c.getPredicatesFacetValue(),new n(function(t,i){var n=Date.now(),a=["Expand_synthesis_duration","Expand_synthesis_count"],l=function(t,i){var n=Array.isArray(t)?t:[t],s=Array.isArray(i)?i:[i],o={};n.forEach(function(e,t){o[e]=s[t]}),c.setPerformanceTracker(e.widgetId,"NGF-Progressive_Expand_Synthesis","NGFilter_UX",o,1)},d="ProgressiveExpandSynthesis_"+s.strftime(new s,"%Y-%m-%d-%H:%M:%S"),u=m.getRESTHeaders();u.SecurityContext=e.securityContext;var h=g.getOption("timeoutExpandSynthesis")||12e4;o.authenticatedRequest(r,{label:d,headers:u,method:"POST",data:JSON.stringify(f),type:"json",proxy:"passport",timeout:h,onComplete:function(e){if(e.errors)console.log(" ==> Expand synthesis failed : "+d),e.errors.forEach(function(e){console.log("     . "+e.code+": "+e.reason)}),l(a,[-1,0]),i();else{var s=e.results.find(function(e){return!!e.synthesis}),o=s?s.synthesis.facets:[],r=s?s.synthesis.value:0;0===(o=o||[]).length?(l(a,[Date.now()-n,0]),t([])):m.getNlsInfosForFacets(o).then(function(e){for(var i=function(e){var t={};e.forEach(e=>{var i=e.nlsvalue;t[i]?(t[i].count+=1,t[i].values.push(e.value)):(t[i]={},t[i].count=1,t[i].values=[e.value])});var i=[];return Object.keys(t).forEach(function(e){i.push({nlsvalue:e,value:1===t[e].values.length?t[e].values[0]:t[e].values,isAggregate:1===t[e].count?0:1})}),i},s={},o=0;o<e.length;o++){var d=e[o];if(d.sixw){var c=d.sixw.split("/"),u=c.length-1;s[c[u]]||(s[c[u]]=[]),s[c[u]].push({value:d.object,nlsvalue:d.dispValue})}}var h=[];for(var p in s)s.hasOwnProperty(p)&&h.push({property:p,values:i(s[p]).sort(function(e,t){return e&&t?e.nlsvalue<=t.nlsvalue?-1:1:0})});l(a,[Date.now()-n,r]),t(h)})}},onFailure:function(e){console.log(" ==> Expand synthesis / Failure : "+d),console.log("   . "+e),l(a,[-1,0]),i()}})})},getTypesOfSynthesis:function(e){var t=[];if(e)for(var i=0;i<e.length;i++)if("ds6w:type"===e[i].property)for(var n=0;n<e[i].values.length;n++)t.push({name:e[i].values[n].value,nlsName:e[i].values[n].nlsvalue,uri:e[i].property});return t},upgradeAndCompleteQuery:function(e){return c.upgradeAndCompleteQuery(e)},resetSelectedVolumeOf3D:function(e,t,i){if(e&&t){var n={NGFUXId:e,appId:e,widgetId:t,filteredRoot:i};_.publish("NGFilter_Volume",n)}},isModelActivated:function(e){return!(!e||"1"!==e.get("isActivated"))},isCustomizedAttribute:function(e){var t=e.automatic||e.Automatic;return!(!t||"Yes"!==t)},_getRootFilterContainer:function(e){var i=document.getElementById("NGF_"+e)||document.getElementsByClassName(".f-globalFilter-container")[0];return i&&!i.getElement&&t.extendElement(i),i},getGlobalEditContainer:function(e){var t,i=this._getRootFilterContainer(e);return i&&(t=i.getElement("#globalEditContainer_"+e)||i.getElement(".globalEdit-container")),t},showFilterContainer:function(e,i){var n=this._getRootFilterContainer(e);if(n){var s=n.getElement(".globalEdit-container"),o=n.getElement(".filter-Commands"),r=n.getElement(".ActiveCriteria-container"),a=n.getElement(".globalFilterView-container");s&&o&&r&&a&&(i?(t.extendElement(s).hide(),t.extendElement(o).show(),t.extendElement(r).show(),t.extendElement(a).show()):(t.extendElement(s).show(),t.extendElement(o).hide(),t.extendElement(r).hide(),t.extendElement(a).hide()))}},executeFetchLogicalID:function(e,t){return this.executeFetch(e,["icon","thumbnail_2d","thumbnail_3d"],["logicalid","type","coretype","ds6w:label","flattenedtaxonomies","ds6wg:revision"],t)},executeFetch:function(e,t,i,s){return new n(function(n,r){var a={headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",type:"json",proxy:"passport",data:JSON.stringify({label:"NGF_ExecuteFetch",physicalid:e,select_file:t||[],select_predicate:i||["logicalid","type","coretype","ds6w:label","flattenedtaxonomies"]}),onComplete:function(e){n(e)},onFailure:function(e){r(e)}};o.authenticatedRequest(C.getFetchUrl(s),a)})},isSafe:function(e){var t=1;if("string"==typeof e){var i="[\\"+this.XSS_NOT_ALLOWED.join("\\")+"]";t=e.match(i)?0:1}return t},isTimeInDateActivated:function(){if(void 0===this._displayTimeInDateAttribute){var e=g.getOption("TimeInDateAttribute");this._displayTimeInDateAttribute=!(e||!c.isActivated("timeInDate"))||e}return this._displayTimeInDateAttribute},isSearchEditorActive:function(){return 0<(g.getOption("SearchEditorOn")||0)},isSearchEditorForAllActive:function(){var e=1<=g.getOption("SearchEditorForAll")?1:0;return this.isSearchEditorActive()&&e?1:0},isAsynchronousValidation:function(){if(void 0===this._isAsynchronousValidation){var e=g.getOption("AsynchronousValidation");this._isAsynchronousValidation=1===e?1:0}return this._isAsynchronousValidation},setReferenceTime:function(e){this._referenceTime=e||0},getReferenceTime:function(){return this._referenceTime||0},_setInternalReferenceTime:function(e){this._currentReferenceTime=e||0},_getInternalReferenceTime:function(){return void 0===this._currentReferenceTime?Date.now():this._currentReferenceTime},displayInternalTimeTrace:function(e,t){if(c.isDebugActive("elapsedTime")){var i=Date.now();console.log("=====> "+t+" / elapsed time (ms) = "+(i-C.getReferenceTime())+" ... "+(i-this._getInternalReferenceTime())),e&&this._setInternalReferenceTime(i)}},displayInternalDurationTrace:function(e,t){c.isDebugActive("elapsedTime")&&console.log("=====> "+e+" / elapsed time (ms) = "+t)},computeAttributesFromSynthesis:function(e){return new n(function(t,i){var n=[],s=[];e&&e.forEach(function(e){s.push(e.property)});var o=g.getOption("PredicatesForEasyAttribute",["dsw:label"]);1===c.arePredicatesExcludedFromSynthesis()&&(o=o.concat(g.getOption("PredicatesForEasyAttributeOptions",[]))),s=s.concat(o),s=[...new Set(s)],f.getResourcesInfo(s.toString(),{tenantId:c.getTenant(),lang:m.getLanguage().toLowerCase(),apiVersion:"R2019x",onComplete:function(i){n=[],i.forEach(function(e){n.push(e)}),e.length?e.forEach(function(e){var t=n.findIndex(function(t){var i=t.curi||t.uri;return e.property===i}),i=-1!==t?n[t]:void 0;i&&(i.rangeValues={editable:!0,literalInfo:e.values})}):n.forEach(function(e){e.rangeValues&&(e.rangeValues=void 0)}),t(n)},onFailure:function(e){i(e)}})})},checkCompatibiltyFilterRules:function(e,i,s,o,r){var a=this;return new n(function(n,l){var d=t.clone(s),u=d.rootPhysicalId;i===u?n({filterSpec:d,result:{error:0}}):C.executeFetch([i],r).then(function(t){C.executeFetch([u]).then(function(s){var h={};h.results=(t.results||[]).concat(s.results||[]);var p="",_="";h.results.forEach(e=>{var t=e.attributes,n=t.find(function(e){return"resourceid"===e.name&&i===e.value});n&&(n=t.find(function(e){return"type"===e.name}),p=n.value),(n=t.find(function(e){return"resourceid"===e.name&&u===e.value}))&&(n=t.find(function(e){return"type"===e.name}),_=n.value)});var f=[];c.getFilterUIComponents(d).forEach((e,t)=>{0<t&&e.toFeedUI.forEach(e=>{"config"===e.criteriaType&&f.push(e)})});var m=p===_,g=f.length;if(g){var b=JSON.parse(v).conf;require([b],function(t){var s={rootid:i,tenant:c.getTenant(),url3DSpace:C.getPlatformServiceUrl(void 0,r),securitycontext:e};t.areConfigurationFiltersCompatible(s,f,function(e){var t=Array.isArray(e)?1:0,i=t?1:0,s=t?e:[],r=Array(g).fill(i);s.forEach(e=>{r[e]=0});var c={defined:f,compatibility:r};a._updateFilterWithCompatibilityRules(d,m,c,o).then(function(e){n({filterSpec:d,result:e})},function(){l()})})})}else{a._updateFilterWithCompatibilityRules(d,m,{},o).then(function(e){n({filterSpec:d,result:e})},function(){l()})}})})})},_updateFilterWithCompatibilityRules:function(e,i,s,o){var r=this;return new n(function(n,a){for(var l=c.getFilterUIComponents(e),d=[],h=0,p=l.length-1;p>=1;p--){for(var _=l[p].toFeedUI,f=p-1,m=s.compatibility?s.compatibility[f]:0,g=_.length-1;g>=0;g--){var v=_[g],b=v.criteriaType;if(h++,"attribute"===b&&i);else if("Sequence"===b&&i)v.sequenceType;else if("config"===b&&m);else if("volume"===b&&i){if(r._removeVolumeProximity(v)){0===v.allVolumes.length&&_.splice(g,1);var y=u.get(b)+"("+u.get("proximity")+")";d.push(y)}}else if("tag"===b);else{_.splice(g,1);y=u.get(b);d.push(y)}}0===_.length&&l.splice(p,1)}var A=h===d.length,F={};if(F.error=d.length?A?2:1:0,0<F.error&&(F.notApplied=d),o&&F.error){var I=A?u.get("FilterCanNotBeAppplied")+"<br>":"";I+="<span>"+u.get("ListOfCriteriaIgnored")+"</span>",d.forEach(e=>{I+="<br><span>"+t.String.format(u.get("CriterionNotSupported"),u.get(e))+"</span>"}),C.displayNotification({level:A?"error":"warning",message:I}),n(F)}else n(F)})},_removeVolumeProximity:function(e){for(var t=!1,i=e.allVolumes||[],n=i.length-1;n>=0;n--){var s=i[n];s.allVolumes?(t=this._removeVolumeProximity(s),0===s.allVolumes.length&&i.splice(n,1)):"proximity"===s.parameters.type&&(t=!0,i.splice(n,1))}return t},getRootTitle:function(e,t){var i=e;if(!e.endsWith(t)){var n=c.getDisplaySeparator();i+=t?n+t:""}return i},getIconByName:function(e){return{iconName:e,fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"1x"}},displayAttrNotFoundNotif:function(e){if(e.length){var t=function(e){var t="<span>"+u.get("ListOfAttributeIgnored")+"</span>";e.forEach(e=>{t+="<br><span> - "+(e.label?e.label:e)+"</span>"}),C.displayNotification({level:"warning",message:t})};f.getResourcesInfo(e.toString(),{tenantId:c.getTenant(),lang:m.getLanguage().toLowerCase(),apiVersion:"R2019x",onComplete:function(e){t(e)},onFailure:function(i){console.log(i),t(e)}})}},getAliasesFromFetched:function(e,t){var i=[];return e.forEach(e=>{t.results.forEach(t=>{var n=t.attributes,s=n.find(t=>"resourceid"===t.name&&e===t.value);if(s){var o=n.find(e=>"ds6wg:revision"===e.name);(s=n.find(e=>"ds6w:label"===e.name))&&i.push((s.dispValue||s.value)+(o?" - "+o.value:""))}})}),i},openFilterPanel:function(e){_.publish("Frame3DXInfra.Open",{identifier:e})},getInterfacesUrl:function(e){},getPredicatesUrl:function(e){},cancelValidationAsynchronous:function(){this._isAsynchronousValidation=0}});return C}),define("DS/ENONextGenFilterUX/utils/FilterPersistencyServices",["UWA/Class","UWA/Core","UWA/Class/Options","UWA/Promise","UWA/Date","DS/WAFData/WAFData","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENOFilterBIUX/NGFServices","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/ENOFilterBIUX/FBIServices"],function(e,t,i,n,s,o,r,a,l,d,c){"use strict";var u=e.singleton(i,{init:function(){},namesRetrievedFiltersOnRoot:[],getCreateFilterUrl:function(){var e;return Array.isArray(a.getOption("str_platformServices"))&&(e=a.getPlatformServiceUrl()+"/resources/FilterBIAPI/Filter/createFilter"),e},getUpdateFilterUrl:function(){var e;return Array.isArray(a.getOption("str_platformServices"))&&(e=a.getPlatformServiceUrl()+"/resources/FilterBIAPI/Filter/updateFilter"),e},getDefaultFilterNameUrl:function(e){var t;return Array.isArray(a.getOption("str_platformServices"))&&(t=a.getPlatformServiceUrl()+"/resources/FilterBIAPI/Filter/getDefaultName"),t},getCheckExistingFilterNameUrl:function(){var e;return Array.isArray(a.getOption("str_platformServices"))&&(e=a.getPlatformServiceUrl()+"/resources/FilterBIAPI/Filter/checkExistingFilterName"),e},saveFilter:function(e,t,i,s,r,a,l,d){var c=this,u={filterName:t,filterDescription:i,rootPhysicalId:r,filterUIComponents:l,filterTitle:s,rootServiceId:d};return new n(function(t,i){o.authenticatedRequest(c.getCreateFilterUrl(),{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:e},method:"POST",data:JSON.stringify(u),type:"json",proxy:"passport",onComplete:function(e){t(e)},onFailure:function(e){t(e)}})})},updateFilter:function(e,t,i,s,r,a,l){var d=this,c={filterName:t,filterDescription:i,filterUIComponents:a,filterTitle:s,filterId:l};return new n(function(t,i){o.authenticatedRequest(d.getUpdateFilterUrl(),{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:e},method:"POST",data:JSON.stringify(c),type:"json",proxy:"passport",onComplete:function(e){t(e)},onFailure:function(e){t(e)}})})},getDefaultFilterName:function(e){var t=this;return new n(function(i,n){o.authenticatedRequest(t.getDefaultFilterNameUrl()+"?filterName="+encodeURIComponent(e),{headers:{Accept:"application/json","Content-Type":"application/json"},method:"GET",type:"json",proxy:"passport",onComplete:function(e){i(e.defaultName)},onFailure:function(e){n(e)}})})},checkExistingFilterName:function(e){var t=this;return new n(function(i,n){if(t.namesRetrievedFiltersOnRoot&&t.namesRetrievedFiltersOnRoot.length)for(var s=0;s<t.namesRetrievedFiltersOnRoot.length;s++)if(e===t.namesRetrievedFiltersOnRoot[s]){i(!0);break}o.authenticatedRequest(t.getCheckExistingFilterNameUrl()+"?filterName="+encodeURIComponent(e),{headers:{Accept:"application/json","Content-Type":"application/json"},method:"GET",type:"json",proxy:"passport",onComplete:function(n){n&&t.namesRetrievedFiltersOnRoot.push(e),i(n)},onFailure:function(e){n(e)}})})},keepToFeedConfig:function(e){var t={};return t.criteriaType=e.get("criteriaType"),t.displayExpression=e.get("displayExpression"),t.expression=e.get("expression"),e.has("config_filter_id")?t.config_filter_id=e.get("config_filter_id"):t.config_filter=e.get("config_filter"),a.isModelActivated(e)||(t.isActivated=e.get("isActivated")),t},keepToFeedAttr:function(e,t){var i={};i.criteriaType=e.get("criteriaType"),i.type=e.get("type"),!1===e.get("Keep")&&(i.Keep=e.get("Keep")),a.isModelActivated(e)||(i.isActivated=e.get("isActivated")),""!==e.get("extension")&&(i.extension=e.get("extension"));var n=e.get("allAttributes");if(n&&n.length){var s=this._keepToFeedAttr(n[0],t);i.allAttributes=[],i.allAttributes.push(s)}return i},_keepToFeedAttr:function(e,t){for(var i=e.get("allAttributes")||[],n=i.length,s=[],o=0;o<n;o++){var r,a=i[o];a.get("allAttributes")?r=this._keepToFeedAttr(a,t):a.get("attribute")?(r={type:a.get("attribute").type,uri:a.get("attribute").uri,attrOp:a.get("attrOp")},a.get("attrValue")?r.attrValue=a.get("attrValue"):a.get("attrValue_1")&&(r.attrValue_1=a.get("attrValue_1"),r.attrValue_2=a.get("attrValue_2"))):t&&t.keepEmpty&&(r={}),r&&s.push(r)}return{combination:e.get("combination"),allAttributes:s}},keepToFeedContext:function(e,t){var i={},n=e.get("addedNodesList")&&e.get("addedNodesList").length,s=e.get("excludedNodesList")&&e.get("excludedNodesList").length;return n||s?(i.criteriaType=e.get("criteriaType"),a.isModelActivated(e)||(i.isActivated=e.get("isActivated")),n&&(!1===e.get("AddNodeActivated")&&(i.AddNodeActivated=e.get("AddNodeActivated")),i.addedNodesList=e.get("addedNodesList")),s&&(!1===e.get("ExcludeNodeActivated")&&(i.ExcludeNodeActivated=e.get("ExcludeNodeActivated")),i.excludedNodesList=e.get("excludedNodesList"))):t&&t.keepEmpty&&(i.criteriaType=e.get("criteriaType"),i.AddNodeActivated=e.get("AddNodeActivated"),i.addedNodesList=e.get("addedNodesList"),i.ExcludeNodeActivated=e.get("ExcludeNodeActivated"),i.excludedNodesList=e.get("excludedNodesList")),i},keepToFeedTag:function(e){var t={},i=e.get("tagData")||void 0;if(i){var n=i.allfilters?Object.keys(i.allfilters):[],s=i.localfilters?Object.keys(i.localfilters):[],o=n.length,r=s.length;(o||r)&&(t.criteriaType=e.get("criteriaType"),o&&(t.allfilters={},t.allfilters=i.allfilters),r&&(t.localfilters={},t.localfilters=i.localfilters))}return t},keepToFeedVolume:function(e){var t={};t.criteriaType=e.get("criteriaType"),a.isModelActivated(e)||(t.isActivated=e.get("isActivated"));var i=e.get("allVolumes");if(i&&i.length){var n=this._keepToFeedVolume(i[0]);t.allVolumes=[],t.allVolumes.push(n)}return t},_keepToFeedVolume:function(e){for(var t=d.get("defaultVolumeName"),i=e.get("allVolumes")||[],n=i.length,s=[],o=0;o<n;o++){var r,l=i[o];if(l.get("allVolumes"))r=this._keepToFeedVolume(l);else{r={parameters:l.get("parameters")},a.isModelActivated(l)||(r.isActivated=l.get("isActivated"));var c=l.get("displayName");-1!==c.startsWith(t+" ")&&(r.displayName=c),r.parameters&&delete r.parameters.root_path_alias}s.push(r)}return{combination:e.get("combination"),allVolumes:s}},keepToFeedSequence:function(e,t){var i={};return"attribute"===e.get("sequenceType")&&(i=this._keepToFeedAttrSeq(e,t)),i},_keepToFeedAttrSeq:function(e,t){var i=[],n=e.get("subGroupCollection")._models;n&&n.forEach(function(e){var n=u.keepToFeedAttr(e,t);i.push(n)});var s={};return s.criteriaType=e.get("criteriaType"),s.sequenceType=e.get("sequenceType"),s.allAttributes=i,s},retrieveAllRoots:function(e){var i={label:"NGF_GetAllRevisions_"+t.Date.strftime(new s,"%Y-%m-%d-%H:%M:%S"),query:"(logicalid:"+e.join(" OR logicalid:")+")",with_indexing_date:!0,with_synthesis:!1,with_nls:!1,tenant:l.getTenant()};return new n(function(e,t){o.authenticatedRequest(l.getFederateSearchUrl(l.getTenant()),{headers:c.getRESTHeaders(),method:"POST",data:JSON.stringify(i),type:"json",proxy:"passport",onComplete:function(t){var i=[];t.infos.nresults&&t.results.forEach(function(e){e.attributes.forEach(function(e){"resourceid"===e.name&&i.push(e.value)})}),e(i)},onFailure:function(e){t(e)}})})},retrieveAllFilters:function(e){var t={relations:["advancedfilter_root_from"],attributes_for_detailview:["physicalid"],countmanagement:!1,debug:!1,ids:e,trueREST:!0,displayTime:!1};return new n(function(e,i){o.authenticatedRequest(l.getGetEcoSystemUrl(l.getTenant()),{headers:c.getRESTHeaders(),method:"POST",data:JSON.stringify(t),type:"json",proxy:"passport",onComplete:function(t){var i=[];t.New.Objects&&t.New.Objects.forEach((e,t)=>{"ENOStrRefinementSpecification"===e.type&&i.push({filterId:e.id,name:e["ds6w:identifier"],filterTitle:e.name})}),e(i)},onFailure:function(e){i(e)}})})}});return u}),define("DS/ENONextGenFilterUX/utils/EditToReadManager",["UWA/Core","UWA/Class","UWA/Class/Options","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/ENONextGenFilterUX/utils/FilterUIService","UWA/Date","DS/ENOFilterBIUX/NGFServices"],function(e,t,i,n,s,o,r){"use strict";return t.singleton(i,{init:function(){},toStringAttribute:function(e){var t,i,s=this.getAttributeValues(e),o="";if(s.inSequence||(o=!0===s.Keep?"Keep":"Remove"),!s.nlsType)return e.set("state","edit"),{level:"error",message:n.get("attrNotCompleted"),sticky:!1};t=s.nlsType,s.nlsExtension&&(i=s.nlsExtension);var r=e.get("allAttributes")[0],a=this._buildAttributeString(r),l=n.get(o.toLowerCase())+" "+n.get(t);i&&(l+=" ("+n.get("extension")+" : "+i+") ");var d=[];d.push(l);var c=a.length;if(0<c){if(1<c||1===c&&Array.isArray(a[0]))if(0===this._isSingleGroupOfAttribute(r)){var u=" "+("all"===r.get("combination")?n.get("AllCombination"):n.get("AnyCombination"));u+=" "+n.get("FollowingCombination"),l+=" "+n.get("with")+" "+u}else{u=a[0].shift();var h=[];a[0].forEach(function(e){h.push(e)});for(var p=1;p<a.length;p++)h.push(a[p]);c=(a=h).length,l+=" "+u}else l+=" "+n.get("with")+" :";if(d[0]=l,1!==c||Array.isArray(a[0])){var _=d.concat(a);d=_}else d[0]+=" "+a[0]}return d},toStringContext:function(t){var i=t.get("addedNodesList"),s=t.get("excludedNodesList"),o=i.length,a=s.length;if(o||a){var l,d;r.isActivated("newSelectionRead")?(l="",d=""):(l='<span class="f-criterion-deactivated">',d="</span>");var c=1===o?"ContextReadViewSingleAdd":"ContextReadViewMultiAdd",u=o+" "+n.get(c);u=t.get("AddNodeActivated")?u:l+u+d;var h=1===a?"ContextReadViewSingleExclude":"ContextReadViewMultiExclude",p=a+" "+n.get(h);p=t.get("ExcludeNodeActivated")?p:l+p+d;var _=" ( ";o>0&&a>0?_+=u+", "+p:o>0?_+=u:a>0&&(_+=p),_+=" )"}e.createElement("span",{}).addClassName("fonticon fonticon-dropbox");var f=[];return f.push(_),f},_isSingleGroupOfAttribute:function(e){var t=0,i=this.getAttributeValues(e).allAttributes||[];return 1===i.length&&this.getAttributeValues(i[0]).allAttributes&&(t=1),t},configToString:function(e){return e.get("displayExpression")},volumeToString:function(e){var t=e.get("allVolumes")[0],i=this._volumeAsString(t),s=[],o=i.length;if(0<o){var r=n.get("with");if(1<o||1===o&&Array.isArray(i[0]))if(0===this._isSingleGroupOfVolume(t)){var a=" "+("all"===t.get("combination")?n.get("AllCombination"):n.get("AnyCombination"));r+=a+=" "+n.get("FollowingCombination")}else{o=i[0].length;a=i[0].shift();var l=[];i[0].forEach(function(e){l.push(e)});for(var d=1;d<i.length;d++)l.push(i[d]);i=l,r=a}if(s[0]=r,1!==o||Array.isArray(i[0])){var c=s.concat(i);s=c}else s[0]+=" "+i[0]}return s},_volumeAsString:function(e){for(var t=[],i=e.get("allVolumes")||[],s=0;s<i.length;s++){var o=i[s];if(0,o.get("allVolumes")){var r=n.get("with")+" ";r+="all"===o.get("combination")?n.get("AllCombination"):n.get("AnyCombination"),r+=" "+n.get("FollowingCombination");var a=this._volumeAsString(o);a.unshift(r),t.push(a)}else{var l=o.get("displayName");l&&l.length&&t.push(l)}}return t},_isSingleGroupOfVolume:function(e){var t=0,i=e.get("allVolumes")||[];return 1===i.length&&i[0].get("allVolumes")&&(t=1),t},groupToString:function(e){var t=e.get("subGroupCollection"),i=[];return t.forEach(function(e,t){i.push(e.criterionToHTML())}),i.join("")},_buildAttributeString:function(e){for(var t=[],i=this.getAttributeValues(e),s=i.allAttributes||[],o=0;o<s.length;o++){var r=s[o];if(void 0===(i=this.getAttributeValues(r)).allAttributes){var a=this._buildSingleAttribute(r);a.length&&t.push(a)}else{var l=n.get("with")+" ";l+="all"===i.combination?n.get("AllCombination"):n.get("AnyCombination"),l+=" "+n.get("FollowingCombination");var d=this._buildAttributeString(r);d.unshift(l),t.push(d)}}return t},getAttributeValues:function(e){var t={};return void 0!==e&&(t={Keep:e.get("Keep"),type:e.get("type"),nlsType:e.get("nlsType"),extension:e.get("extension"),nlsExtension:e.get("nlsExtension"),inSequence:e.get("inSequence")},void 0===e.get("combination")?(t.attribute=e.get("attribute"),t.nlsAttribute=e.get("nlsAttribute"),t.attrOp=e.get("attrOp"),t.nlsAttrOp=e.get("nlsAttrOp"),t.attrValue=e.get("attrValue"),t.attrValue_1=e.get("attrValue_1"),t.attrValue_2=e.get("attrValue_2")):(t.combination=e.get("combination"),t.allAttributes=e.get("allAttributes"))),t},setAttributeValues:function(e,t){void 0!==e&&void 0!==t&&(e.set("Keep",t.Keep),e.set("type",t.type),e.set("nlsType",t.nlsType),e.set("extension",t.extension),e.set("nlsExtension",t.nlsExtension),e.set("inSequence",t.inSequence),void 0===t.combination?(e.set("attribute",t.attribute),e.set("nlsAttribute",t.nlsAttribute),e.set("attrOp",t.attrOp),e.set("nlsAttrOp",t.nlsAttrOp),e.set("attrValue",t.attrValue),e.set("attrValue_1",t.attrValue_1),e.set("attrValue_2",t.attrValue_2)):(e.set("combination",t.combination),e.set("allAttributes",t.allAttributes)))},_buildSingleAttribute:function(e){var t="",i=this.getAttributeValues(e),s=i.attribute?i.attribute.type:void 0,o=i.nlsAttribute||"",r=i.attrOp||"",a="";if(void 0!==i.attrValue){a=i.attrValue;var l=i.attribute.rangeValues;a=l?this._buildAttributeValue(s,a,l,r,", "):"boolean"===s?"true"===a?n.get("true"):n.get("false"):this._buildAttributeValue(s,a,l,r,", "),"string"===s&&(a=a.replaceAll?a.replaceAll("<","&lt;"):a.split("<").join("&lt;"))}if(r&&"between"===r&&void 0!==i.attrValue_1){var d=[i.attrValue_1,i.attrValue_2],c=" "+n.get("AND").toLowerCase()+" ";a=this._buildAttributeValue(s,d,i.attribute.rangeValues,r,c)}return void 0!==o&&o.length&&(t=o+" "+n.get(r),-1===["isEmpty","isNotEmpty"].indexOf(r)&&(t+=a?" "+a:"<span class=f-criterion-unset> "+n.get("NoValueEntered")+"</span>")),t},_buildAttributeValue:function(t,i,r,a,l){var d=Array.isArray(i)?i:[i],c=d.length,u=[];if(r)for(var h=r.literalInfo?r.literalInfo:r,p=h.length,_=0;_<c;_++){for(var f=0,m=0;m<p;m++){var g=h[m],v="integer"===t||"real"===t?String(d[_]):d[_];if(g.isAggregate&&Array.isArray(v)?g.value.sort().toString()===v.sort().toString()?1:0:g.value===v?1:0){var b=g.nlsValue||g.nlsvalue;u.push(b||g.value),f=1;break}}s.isSearchEditorActive()&&"string"===t&&(f||u.push(d[_]))}if(0===u.length){var C={year:"numeric",month:"short",day:"numeric"};s.isTimeInDateActivated()&&"on"!==a&&(C=e.merge(C,{hour:"2-digit",minute:"2-digit",second:"2-digit"}));for(_=0;_<c;_++){var y=d[_];if("dateTime"===t)y=new o(o.parse(y)).toLocaleString(void 0,C);u.push(y)}}var A=u.join(l);return 1<u.length&&"between"!==a&&(A=n.get("AnyOf")+"  "+A),A}})}),define("DS/ENONextGenFilterUX/utils/CVManager",["UWA/Core","UWA/Class","UWA/Class/Options","DS/ENONextGenFilterUX/utils/FilterUIService","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","UWA/Date"],function(e,t,i,n,s,o){"use strict";return t.singleton(i,{init:function(){},buildCVQueryForContext:function(e,t){var i;if("root_path_physicalid"==t){if(i=!1,e.get("AddNodeActivated")){var n=e.get("addedNodesList");if(a=n.length){for(var s="[",o=0;o<a;o++)s+='["'+n[o].toString().split(",").join('","')+'"],';i=s=s.slice(0,-1)+"]"}}}else{i="";var r=[];if(e.get("ExcludeNodeActivated")){var a=(r=e.get("excludedNodesList")).length,l="[";for(o=0;o<a;o++)l+='["'+r[o].toString().split(",").join('","')+'"],';l=l.endsWith(",")?l.slice(0,-1):l,l+="]",r.length>0&&(i='"find_path_filter":[{"option": ["remove"],"path_physicalid":'+l+"}]")}}return i},buildCVQueryForAttribute:function(e,t){var i="";i=e.get("Keep")?!1===t||"false"===t?"seq_cut":"seq_keep":"seq_remove";var n=e.get("type"),s="";e.get("extension")&&(s=e.get("extension"));var o="",r=e.get("allAttributes");r&&r.length&&(o=(o=this._buildAttributeQuery(r[0])).length?o:"#all");var a="";return o.length&&(a='{"option":["'+i+'"],"definition":[{"type_filter_bo":["'+n+'"],"type_filter_rel":["'+n+'"],"q.query":"'+o,s.length&&(a+=" AND [ds6w:kind]:"+s),a+='"}]}'),a},buildCVQueryForConfig:function(e){var t="";return e&&(t='"config_filter":"'+e+'"'),t},buildCVQueryForGroup:function(e,t){var i="",s=e.get("subGroupCollection")._models;if("attribute"===e.get("sequenceType")){var o=s&&s.length?s[0]:void 0;if(o){var r='{"option":["'+(o.get("Keep")?"false"===t?"seq_cut":"seq_keep":"seq_remove")+'"],"definition":[',a=this,l="";s.forEach(function(e){if(n.isModelActivated(e)){var t=e.get("type"),i=e.get("extension")||"",s="",o=e.get("allAttributes");o&&o.length&&(s=(s=a._buildAttributeQuery(o[0])).length?s:"#all"),s.length&&(l+='{"type_filter_bo":["'+t+'"],"type_filter_rel":["'+t+'"],"q.query":"'+s,i.length&&(l+=" AND [ds6w:kind]:"+i),l+='"},')}}),l.length&&(i=r+(l=l.slice(0,-1))+"]}")}}return i},buildCVQueryForVolume:function(e){var t="",i="",n=e.get("allVolumes");return n&&n.length&&(i=this._buildVolumeQuery(n[0])),i.length&&(t='"volume_filter":{'+i+"}"),t},buildCVQueryForTags:function(e){var t=[],i=e.get("tagData")||{allfilters:e.get("allfilters")||void 0};if(Object.keys(i.allfilters).length||Object.keys(i.localfilters).length)for(var n in i.allfilters)if(i.allfilters.hasOwnProperty(n)){var s={option:["seq_keep"],definition:[]},o="",r=Object.keys(i.allfilters[n]).length,a=0;for(var l in i.allfilters[n]){var d;if(i.allfilters[n].hasOwnProperty(l))-1!==n.lastIndexOf("/")&&(d=n.substring(n.lastIndexOf("/")+1)),o+="["+d+"]:"+(Array.isArray(i.allfilters[n][l].object)?i.allfilters[n][l].object.join("/"):i.allfilters[n][l].object),o+=++a<r?" OR ":""}s.definition.push({"q.query":o}),t.push(s)}return t},_buildVolumeQuery:function(e){var t="",i="",s="",o=e.get("combination");o&&(t='"'+("all"===o?"and":"or")+'":[',i="{",s="}");for(var r,a=e.get("allVolumes")||[],l=a.length,d=0;d<l;d++){var c=(h=a[d]).get("parameters");if(c&&void 0!==c.maybe3d&&n.isModelActivated(h)){r=c.maybe3d;break}}var u=0;for(d=0;d<l;d++){var h=a[d];if(n.isModelActivated(h))u++,t+=h.get("allVolumes")?i+this._buildVolumeQuery(h,r)+s:i+this._buildSingleVolumeQuery(h,r)+s,t+=","}return u?(t=t.slice(0,t.length-1),o&&(t+="]")):t="",t},_buildSingleVolumeQuery:function(e,t){var i="",n=e.get("parameters");if(n){var s="";switch(n.type){case"box":s='"box":{',s+='"corner_min":["'+n.corner_min.toString().split(",").join('","')+'"],',s+='"corner_max":["'+n.corner_max.toString().split(",").join('","')+'"],',s+='"transformation_matrix":["'+n.transformation_matrix.toString().split(",").join('","')+'"],';break;case"sphere":s='"sphere":{',s+='"center":["'+n.center.toString().split(",").join('","')+'"],',s+='"radius":"'+n.radius+'",';break;case"proximity":var o=n.root_path_physicalid[0];s='"assemblyshape":{',s+='"root_path_physicalid":[["'+(o=Array.isArray(o)?o:[o]).toString().split(",").join('","')+'"]],',s+='"distance":"'+n.distance+'",';break;case"space":o=n.root_path_physicalid[0];o=Array.isArray(o)?o:[o];var r=n.distance?n.distance:"0.000";s='"assemblyshape":{',s+='"root_path_physicalid":[["'+o.toString().split(",").join('","')+'"]],',s+='"distance":"'+r+'",'}if(""!==s){if(s+='"intersection_mode":"'+n.intersection_mode+'"',void 0!==t)s+=",",s+='"maybe3d":"'+(1===t?"true":"false")+'"';s+="}"}i=s}return i},_buildAttributeQuery:function(e){for(var t=e.get("allAttributes")||[],i=t.length,n="all"===e.get("combination")?" AND ":" OR ",s=i?"":"#all",o=0;o<i;o++){var r,a=t[o];void 0===a.get("allAttributes")?(r=this._buildSingleAttribute(a)).length&&(s+=r):(r=this._buildAttributeQuery(a)).length&&(s+=" ("+r+")"),r.length&&(s+=n)}return s=s.endsWith(n)?s.slice(0,-n.length):s},_buildSingleAttribute:function(e){var t="",i=!0;if(void 0===e.get("attrValue")&&void 0===e.get("attrValue_1")&&void 0===e.get("attrValue_2")&&(i=!1),i)switch(e.get("attribute")?e.get("attribute").type:e.get("type")){case"string":t+=this._buildStringAttr(e);break;case"boolean":t+=this._buildBooleanAttr(e);break;case"number":case"integer":case"real":t+=this._buildNumericalAttr(e);break;case"dateTime":case"timestamp":t+=this._buildDateAttr(e)}return t},_buildDateAttr:function(e){var t="",i=e.get("attribute")?e.get("attribute").uri:e.get("uri"),s=e.get("attrOp"),o=[];if("between"!==s){var r=e.get("attrValue")||n.ATTRIBUTE_NOT_VALUATED;o=Array.isArray(r)?r:[r]}else{var a=e.get("attrValue_1")||n.ATTRIBUTE_NOT_VALUATED,l=e.get("attrValue_2")||n.ATTRIBUTE_NOT_VALUATED;o.push(a),o.push(l)}for(var d="",c=o.length,u=0;u<c;u++){var h='\\"'+o[u]+'\\"';switch(d=" OR ",s){case"on":t+="["+i+"] = "+h;break;case"after":t+="["+i+"] >= "+h;break;case"strictlyAfter":t+="["+i+"] > "+h;break;case"before":t+="["+i+"] <= "+h;break;case"strictlyBefore":t+="["+i+"] < "+h;break;case"between":0===u?(t+="["+i+"] >= "+h,d=" AND "):t+="["+i+"] <= "+h}t+=d}return t.length&&(t="("+(t=t.endsWith(d)?t.slice(0,-d.length):t)+")"),t},_buildNumericalAttr:function(e){var t="",i=e.get("attribute")?e.get("attribute").uri:e.get("uri"),s=e.get("attrOp"),o=[];if("between"!==s){var r=e.get("attrValue")||n.ATTRIBUTE_NOT_VALUATED;o=Array.isArray(r)?r:[r]}else{var a=e.get("attrValue_1")||n.ATTRIBUTE_NOT_VALUATED,l=e.get("attrValue_2")||n.ATTRIBUTE_NOT_VALUATED;o.push(a),o.push(l)}for(var d="",c=o.length,u=0;u<c;u++){var h=o[u];switch(d=" OR ",s){case"equals":t+="["+i+"] = "+h;break;case"notEqual":t+="["+i+"] != "+h;break;case"lowerThan":t+="["+i+"] <= "+h;break;case"greaterThan":t+="["+i+"] >= "+h;break;case"strictlyLowerThan":t+="["+i+"] < "+h;break;case"strictlyGreaterThan":t+="["+i+"] > "+h;break;case"between":0===u?(t+="["+i+"] >= "+h,d=" AND "):t+="["+i+"] <= "+h}t+=d}return t.length&&(t="("+(t=t.endsWith(d)?t.slice(0,-d.length):t)+")"),t},_buildBooleanAttr:function(e){return"("+("["+(e.get("attribute")?e.get("attribute").uri:e.get("uri"))+"]:"+(e.get("attrValue")||n.ATTRIBUTE_NOT_VALUATED))+")"},_buildStringAttr:function(e){for(var t="",i=e.get("attribute")?e.get("attribute").uri:e.get("uri"),s=e.get("attrOp"),o=e.get("attrValue")||n.ATTRIBUTE_NOT_VALUATED,r=Array.isArray(o)?o:[o],a=" OR ",l=r.length,d=0;d<l;d++){var c=r[d];switch(s){case"equals":t+="["+i+']:\\"'+c+'\\"';break;case"notEqual":t+="(NOT ["+i+"]:("+c+"))";break;case"contains":t+="["+i+"]:*"+c+"*";break;case"notContains":t+="(NOT ["+i+"]:(*"+c+"*))";break;case"startsWith":t+="["+i+"]:"+c+"*";break;case"endsWith":t+="["+i+"]:*"+c}t+=a}return t.length&&(t="("+(t=t.endsWith(a)?t.slice(0,-a.length):t)+")"),t}})}),define("DS/ENONextGenFilterUX/models/CriterionModel",["UWA/Core","UWA/Data","UWA/Class/Model","DS/ENONextGenFilterUX/utils/CVManager","DS/ENONextGenFilterUX/utils/EditToReadManager","DS/ENONextGenFilterUX/utils/FilterPersistencyServices"],function(e,t,i,n,s,o){"use strict";return i.extend({defaults:{name:"elementaryCriteria-model",isActivated:"1"},setup:function(){},toCVQuery:function(e){var t,i=this.get("criteriaType");return"attribute"===i?t=n.buildCVQueryForAttribute(this,e):"config"===i?t=n.buildCVQueryForConfig(this.get("config_filter")):"context"===i?t=n.buildCVQueryForContext(this,e):"tag"===i?t=n.buildCVQueryForTags(this):"volume"===i?t=n.buildCVQueryForVolume(this,e):console.log(" !! CriterionModel.toCVQuery : non supported case - "+i),t},criterionToString:function(){var e,t=this.get("criteriaType");return"attribute"===t?e=s.toStringAttribute(this):"config"===t?e=s.configToString(this):"context"===t?e=s.toStringContext(this):"volume"===t?e=s.volumeToString(this):console.log(" !! CriterionModel.criterionToString : non supported case - "+t),e},criterionToHTML:function(){var e="",t=this.get("criteriaType");if("attribute"===t){var i=this.criterionToString(this),n=this.get("isActivated"),o="0"===n?"f-criterion-deactivated":"";e+="1"===n?"<li>"+i[0]+'<ul class="attrRead-multi-attr"><div>':'<li><span class="'+o+'">'+i[0]+'</span><ul class="attrRead-multi-attr '+o+'"><div>',1<i.length&&(i.shift(),e+=this._getAttributeHTML(i)),e+="</div></ul></li>"}else"config"===t?e=s.configToString(this):"context"===t?e=s.toStringContext(this):"volume"===t?e=s.volumeToString(this):console.log(" !! CriterionModel.criterionToString : non supported case - "+t);return e},keepComponentsToFeedUI:function(e,t){var i={},n=this.get("criteriaType");return"attribute"===n?i=o.keepToFeedAttr(this,t):"config"===n?i=o.keepToFeedConfig(this):"context"===n?i=o.keepToFeedContext(this,t):"volume"===n?i=o.keepToFeedVolume(this):"tag"===n?i=o.keepToFeedTag(this):console.log(" !! CriterionModel.keepToFeed : non supported case - "+n),i},_getAttributeHTML:function(e){for(var t="",i=0;i<e.length;i++)if(Array.isArray(e[i])){var n=e[i];t+="<li>"+n[0],t+="<ul>",n.shift(),t+=this._getAttributeHTML(n),t+="</ul></li>"}else t+="<li>"+e[i]+"</li>";return t}})}),define("DS/ENONextGenFilterUX/views/CriteriaAbstractView",["UWA/Core","UWA/Class/View","UWA/Promise","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/Handlebars/Handlebars4","DS/ENONextGenFilterUX/models/CriterionModel","text!DS/ENONextGenFilterUX/templates/configurationViewTemplate.html","text!DS/ENONextGenFilterUX/assets/ENOStrRefinementUX_require.json","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENOFilterBIUX/NGFServices","DS/Menu/Menu"],function(e,t,i,n,s,o,r,a,l,d,c,u){"use strict";return t.extend({isCriterionValidate:function(){return 0===d.isAsynchronousValidation()||new i(function(e){e(!0)})},viewFromMdl:function(e){},isThereCriteria:function(){return!1},setEditable:function(e){this._isEditable=e},_getCallbackToEditCriterion:function(){},isCriterionValid:function(){return!0},_getDOMElementToUpdateOnActivateChange:function(){return[]},updateModelFromRepair:function(e){return!1},buildViewFromRepairModel:function(e){},tagName:"li",setup:function(e){this._childGroupId=e.childGroupId,this._UXId=e.UXId,this._NGFUXId=e.NGFUXId,this._widgetId=e.widgetId,this._viewId="activeSubgroup_"+this._childGroupId,this.container.setAttribute("id",this._viewId),this._isEditable=e.isEditable,this._pfServiceId=e.pfServiceId||"3DSpace",this.listenTo(this.model,"onChange:isActivated",this._onActivateChange.bind(this))},isViewEdited:function(){return"edit"===this.model.get("state")},_getId:function(){return this._viewId},_checkBeforeEdit:function(){if(this._isEditable){var t=this._getCallbackToEditCriterion();t&&this.dispatchEvent("NGF_Criterion_ValidateEdited",{callback:t})}else{this.getElement('[class*="-read"]').addClassName("filter-not-editable");var i=e.String.format(n.get("FilterIsNotEditableInContext"),n.get(this.model.get("criteriaType")));d.displayNotification({level:"info",message:i})}},_createCriterionCtxMenuWUX:function(e){if(e&&!this._critContextualMenu){var t={type:"PushItem",recId:"delete-item-DDCtx",title:n.get("deleteCriteria"),icon:d.getIconByName("trash"),action:{this:this,callback:this.destroy}};this._abstractActivateItem={type:"PushItem",recId:"activate-item-DDCtx",title:n.get("activatedCriteria"),icon:d.getIconByName("eye"),action:{this:this,callback:this._switchCriterionState}},this._abstractDeactivateItem={type:"PushItem",recId:"activate-item-DDCtx",title:n.get("deactivatedCriteria"),icon:d.getIconByName("eye-off"),action:{this:this,callback:this._switchCriterionState}},this._abstractCtxMenuRead=[{type:"PushItem",recId:"edit-item-DDCtx",title:n.get("editCriteria"),icon:d.getIconByName("pencil"),action:{this:this,callback:this._checkBeforeEdit}},this._abstractDeactivateItem,t],this._abstractCtxMenuEdit=[{type:"PushItem",recId:"cancel-item-DDCtx",title:n.get("cancelEditCriteria"),icon:d.getIconByName("undo"),action:{this:this,callback:this._cancelEditCriteria}},t],this._critContextualMenu=this._abstractCtxMenuRead;var i=this;e.addEventListener("click",function(e){e.stopPropagation();var t=e.target.getBoundingClientRect();u.show(i._critContextualMenu,{position:{x:t.left,y:t.bottom}})})}},_switchCriterionState:function(){var e=d.isModelActivated(this.model)?"0":"1";this.model.set("isActivated",e)},_onActivateChange:function(e,t){var i=d.isModelActivated(this.model);if(this._critContextualMenu){var n=this._critContextualMenu.findIndex(e=>"activate-item-DDCtx"===e.recId);-1!==n&&(this._critContextualMenu[n]=d.isModelActivated(this.model)?this._abstractDeactivateItem:this._abstractActivateItem)}for(var s=this._getDOMElementToUpdateOnActivateChange(),o=s.length,r=0;r<o;r++)s[r]&&(i?s[r].removeClassName("f-criterion-deactivated"):s[r].addClassName("f-criterion-deactivated"));this.dispatchEvent("NGF_Criterion_Activated",{})},_hideFilterContainer:function(){d.showFilterContainer(this._UXId,!1)},_showFilterContainer:function(){d.showFilterContainer(this._UXId,!0)},_setContextualMenu:function(e){this._critContextualMenu&&("read"===e?(this._critContextualMenu=this._abstractCtxMenuRead,this._critContextualMenu[1]=d.isModelActivated(this.model)?this._abstractDeactivateItem:this._abstractActivateItem):"edit"===e&&(this._critContextualMenu=this._abstractCtxMenuEdit))}})}),define("DS/ENONextGenFilterUX/models/GlobalFilterModel",["UWA/Class/Model","DS/ENONextGenFilterUX/utils/CVManager"],function(e,t){"use strict";return e.extend({name:"globalFilter-model",setup:function(){}})}),define("DS/ENONextGenFilterUX/models/GroupModel",["UWA/Class/Model","DS/ENONextGenFilterUX/utils/CVManager","DS/ENONextGenFilterUX/utils/EditToReadManager","DS/ENONextGenFilterUX/utils/FilterPersistencyServices"],function(e,t,i,n){"use strict";return e.extend({defaults:{state:"edit",operatorCV:"AND",isActivated:"1"},setup:function(){},toCVQuery:function(e){var i="";return"Sequence"===this.get("criteriaType")&&(i=t.buildCVQueryForGroup(this,e)),i},groupToString:function(){return i.groupToString(this)},keepComponentsToFeedUI:function(e,t){var i={};return"Sequence"===this.get("criteriaType")&&(i=n.keepToFeedSequence(this,t)),i}})}),define("DS/ENONextGenFilterUX/collections/FilterUIGroupCollection",["UWA/Core","UWA/Class/Collection","DS/ENONextGenFilterUX/models/CriterionModel","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX"],function(e,t,i,n){"use strict";return t.extend({model:i,setup:function(e,t){this.add(e),this._widgetId=t.widgetId||null,this._isActivated="1",this._filterSpecificationName=n.get("defaultGroupName"),this._rootId=""},sync:function(){return this.model.prototype.sync.apply(this,arguments)},setActivated:function(e){this._isActivated=e},isActivated:function(){return this._isActivated},setFilterSpecificationName:function(e){this._filterSpecificationName=e},getFilterSpecificationName:function(){return this._filterSpecificationName},setFilterSpecificationRoot:function(e){this._rootId=e},getFilterSpecificationRoot:function(){return this._rootId}})}),define("DS/ENONextGenFilterUX/collections/FilterUIGlobalFilterCollection",["UWA/Core","UWA/Class/Collection","UWA/Promise","UWA/Date","DS/ENONextGenFilterUX/models/GlobalFilterModel","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENOFilterBIUX/NGFServices","DS/WAFData/WAFData","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/ENONextGenFilterUX/utils/FilterPersistencyServices","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/ExpandV2FormatServices","DS/PlatformAPI/PlatformAPI"],function(e,t,i,n,s,o,r,a,l,d,c,u,h){"use strict";return t.extend({model:s,setup:function(e,t){this.add(e),this._widgetId=t.widgetId||null,this._groupCollectionArray=[],this.model=t.model},addGroupCollection:function(e){this._groupCollectionArray.push(e)},removeGroupCollection:function(e){var t=this._groupCollectionArray.indexOf(e);-1!==t&&this._groupCollectionArray.splice(t,1)},getGroupCollectionCount:function(e){return this._groupCollectionArray.length},getActiveGroupCollection:function(e){var t=[];return this._groupCollectionArray.forEach(e=>{"1"===e.isActivated()&&t.push(e)}),t},buildCVQuery:function(e,t,n,s,o){if(0===c.getCVQueryBuildMode()){var a=e,l=t;return this._buildCVQuery(a,l)}var d=this;return new i(function(i,a){var l=d.keepComponentsToFeedUI(n,s,o);d.buildCVQueryFromFilterSpec(e,t,n,s,l).then(function(e){r.isProgressiveExpandActive()||(e.CVQueryV2=u.fromNGFV1ToV2(n,e.CVQuery));var t=JSON.stringify(e);r.isDebugActive("ngf")&&console.log(" CV queries = "+t),i(t)},function(e){a("")})})},buildCVQueryFromFilterSpec:function(e,t,n,s,l){return new i(function(i,s){var d=Date.now(),c=t||r.getQueryFormat();-1!==decodeURIComponent(window.location.href).indexOf("NGFDebugMultiRoot=1")&&(c|=8),a.authenticatedRequest(r.getGetFilterQueryUrl(),{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:e},method:"POST",type:"json",proxy:"passport",data:JSON.stringify({rootID:n,specification:l,queryFormat:c,excludeRoot:r.isRootExcludedFromSynthesis()?1:0}),onComplete:function(e){o.displayInternalDurationTrace("buildCVQueryFromFilterSpec.onComplete("+c+")",Date.now()-d),i(e)},onFailure:function(e){console.log("=====> Build CVQuery from FilterSpecification failed, error  = "+e),s(e)}})})},keepComponentsToFeedUI:function(e,t,i,n){var s=[];s.push({toFeedUI:{combinationOfSpecification:this.model.get("combinationOfSpecification"),minusIndex:this.model.get("minusIndex"),keepChildren:t,specVersion:r.getCurrentSpecificationVersion()}});var o=[],a=l.get("defaultGroupName");this._groupCollectionArray.forEach(e=>{if(e){o.push(e.getFilterSpecificationRoot());var r=[];e.toArray().forEach(e=>{var s={};if(i?"tag"===e.get("criteriaType")&&(s=e.keepComponentsToFeedUI(t)):s=e.keepComponentsToFeedUI(t,n),Object.keys(s).length)for(var o=Array.isArray(s)?s:[s],a=0;a<o.length;a++)r.push(o[a])});var l={toFeedUI:r};"0"===e.isActivated()&&(l.isActivated="0"),-1===e.getFilterSpecificationName().indexOf(a)&&(l.filterSpecificationName=e.getFilterSpecificationName()),s.push(l)}});var d=[...new Set(o)];return 1===d.length&&e!=o[0]?s[0].toFeedUI.rootIds=o:1<d.length&&(s[0].toFeedUI.rootIds=o),s},sync:function(e,t,i){try{switch(e){case"read":a.authenticatedRequest(i.url,{headers:o.getRESTHeaders(),method:"POST",data:i.data,type:"json",onComplete:i.onComplete,onFailure:function(e){console.log(e)}});break;case"create":break;case"update":case"patch":case"delete":break;default:throw new Error('Unsupported method "{0}"'.format(e))}}catch(e){e.message}return{cancel:function(){}}},_buildCVQuery:function(e,t){var i=[],n=0,s=this.model.get("combinationOfSpecification")||"union",a=0,l=!0,d=this._groupCollectionArray.length;"minus"===s&&"0"===this.model.get("minusIndex")&&(a=d-1,l=!1);for(var c=!1;0<=a&&!c;){var u=a,h="",p=[],_=[],f=[],m=[],g=[];if("1"===this._groupCollectionArray[u].isActivated()){for(var v=this._groupCollectionArray[u]._models,b=0;b<v.length;b++){var C=v[b];if("1"===C.get("isActivated")){var y=C.get("criteriaType");"attribute"===y?p.push(C.toCVQuery(t)):"config"===y?_.push(C.toCVQuery()):"Sequence"===y||"subGroup"===y?p.push(C.toCVQuery(t)):"context"===y?(f.push(C.toCVQuery()),f.push(C.toCVQuery("root_path_physicalid"))):"tag"===y&&C.toCVQuery()?m=C.toCVQuery():"volume"===y&&g.push(C.toCVQuery())}}var A=f.length,F=f[A-1];h+='{"root_path_physicalid":',h+=F&&!1!==F?F:'[["'+e+'"]]',(p.length||m.length)&&(h+=',"sequence_filter": ['+p.toString()+"]"),_.length&&(h+=","+_[_.length-1]),A&&f[A-2]&&(h+=","+f[A-2]);var I=g.length;if(n=n||I,I&&g[0].length&&(h+=","+g[0]),h+="}",m.length){for(var S=JSON.parse(h),E=0;E<m.length;E++)S.sequence_filter.push(m[E]);h=JSON.stringify(S)}i.push(h)}l?a++:a--;c=d===a||-1===a}var N=n?"expand3d":"expand",w="{";w+='"specVersion":"'+r.getCurrentSpecificationVersion()+'"',w+=', "'+s+'":{"'+N+'":['+i.toString()+"]}",w+="}";var x={};x.CVQuery=w;var V=o.upgradeAndCompleteQuery(x);return w=JSON.stringify(V),console.log("CVQuery = "+w),w}})}),define("DS/ENONextGenFilterUX/views/FilterRepairView",["UWA/Core","DS/ENOFilterExplicitWebInWin/views/filterRepairUI","UWA/Promise","UWA/Class/View","DS/WAFData/WAFData","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/Handlebars/Handlebars4","DS/ENONextGenFilterUX/models/CriterionModel","text!DS/ENONextGenFilterUX/templates/filterRepairViewTemplate.html","i18n!DS/ENOFilterExplicitWebInWin/assets/nls/ENOStrRefinementUX.json","DS/PlatformAPI/PlatformAPI","DS/ENONextGenFilterUX/utils/FilterUIService"],function(e,t,i,n,s,o,r,a,l,d,c,u){"use strict";return n.extend({setup:function(e){this._parent(e),this._template=r.compile(l),this.container.addEvent("click",function(e){return e.stopPropagation(),!1})},render:function(){var e=this;return e.DisplayFilterPanel(!1),"object"==typeof e._brokenPaths&&(this.container.setContent(this._template({stateClass:"Read"})),e._filterUIObj.render().inject(e.getElement(".filterRepairView-mainContainer")),e.listenTo(e._filterUIObj,"NGF_RepairFilter",function(t){e._repairFilter(t)}),e.listenTo(e._filterUIObj,"NGF_CancelRepairFilter",function(t){"CancelRepair"==t.listOfList&&e.DisplayFilterPanel(!0),e.dispatchEvent("NGF_CancelRepairFilter",t)})),this},logWebServiceOptions:function(e){this._optionsWebservice=e},fetchRepairedPathsFromWebService:function(e){var n=this;return this._brokenPaths=e,this._filterUIObj=new t({brokenPaths:n._brokenPaths,url:n._optionsWebservice.url,ctx:n._optionsWebservice.ctx}),this._filterUIObj.RepairFilterInWidget(),new i(function(e){n._filterUIObj.fetchData().then(function(t){e(t)})})},logBrokenFiltersInfo:function(e){this._toFeedUI=e},checkForBrokenLinksInFilter:function(e){var t,n=this;return t=e.filterUIComponents?e.filterUIComponents:e.filterData[e.filterNames[0]].filterUIComponents,new i(function(i,s){for(var o=[],r=[],a=1;a<t.length;a++)for(var l=t[a].toFeedUI||[],d=l.length,c=0;c<d;c++){var u=l[c].criteriaType;"context"===u?(o.push(l[c]),r.push(a)):"volume"===u&&(l[c].proximityPath=n._getProximityPath(l[c]),o.push(l[c]),r.push(a))}0===o.length?i("NoContextFilter"):n._checkForBrokenLinksInEachGroupView(o).then(function(t){if("PathsOK"===t)i(t);else{var n=[];t.results.forEach(function(e){var t=e.attributes.findIndex(function(e){return"resourceid"===e.name});-1!==t&&n.push(e.attributes[t].value)});for(var s=function(e,i){for(var s=[],o=[],r=[],a=0;a<e.length;a++){for(var l=e[a],d=l.length,c=!1,u="",h=0;h<d;h++){var p=l[h],_=n.indexOf(p);if(-1===_)c=!0;else{var f=t.results[_].attributes.find(function(e){return"logicalid"===e.name});u=f?f.value:""}}if(c){s.push(l),o.push(u);var m=l[d-1],g=i.physical.findIndex(function(e){return-1!==e.lastIndexOf(m)});-1!==g&&r.push(i.logical[g])}}return{physical:s,logical:o,logicalDB:r}},a=[],l=[],d=0;d<o.length;d++){var c=[],u=[],h=[],p=[];if(o[d].addedNodesList){var _=s(o[d].addedNodesList,e.pathDB.added);a=a.concat(_.physical),c=c.concat(_.logical),h=h.concat(_.logicalDB)}if(o[d].excludedNodesList){_=s(o[d].excludedNodesList,e.pathDB.excluded);a=a.concat(_.physical),u=u.concat(_.logical),p=p.concat(_.logicalDB)}o[d].proximityPath&&(l=s(o[d].proximityPath,e.pathDB.proximity));for(var f=[],m=[],g=0;g<a.length;g++){if(o[d].addedNodesList){var v=o[d].addedNodesList.indexOf(a[g]);-1!==v&&m.push(o[d].addedNodesList.splice(v,1))}if(o[d].excludedNodesList){var b=o[d].excludedNodesList.indexOf(a[g]);-1!==b&&f.push(o[d].excludedNodesList.splice(b,1))}}var C={};o[d].addedNodesList||o[d].excludedNodesList?C={brokenAddedNodes:m,brokenAddedLabels:[],brokenExcludedNodes:f,brokenExcludedLabels:[],allPathsInfo:t,logicalID_OfAddedPaths:c,logicalID_OfExcludedPaths:u,brokenAddedLogicalDB:h,brokenExcludedLogicalDB:p}:o[d].proximityPath&&(C={brokenProximity:[l.physical],brokenLogicalDB:l.logicalDB,allPathsInfo:t}),o[d].repairFilterInfo=C}i({pathsToFeedUI:o,indexOfGroupViewToRepair:r})}})})},_checkForBrokenLinksInEachGroupView:function(e){var t=this;return new i(function(i){var n=[];e.forEach(function(e){e.addedNodesList&&(n=n.concat(e.addedNodesList.flat())),e.excludedNodesList&&(n=n.concat(e.excludedNodesList.flat())),e.proximityPath&&(n=n.concat(e.proximityPath.flat()))}),n.length?(n=[...new Set(n)],u.executeFetchLogicalID(n,t.options.pfServiceId).then(function(e){e.results.length===n.length?i("PathsOK"):i(e)})):i("PathsOK")})},_createJSONForRepairWebservice:function(){for(var e=[],t=function(e,t){for(var i=[],n=0;n<e.length;n++){for(var o=e[n][0],r=[],a=0;a<o.length;a++){for(var l=o[a],d=!1,c={},u=0;u<s.length;u++){var h=s[u].attributes.findIndex(e=>"resourceid"===e.name);if(l===(-1!==h?s[u].attributes[h].value:"")){var p=s[u].attributes,_="",f="",m="",g="",v="",b="";p.forEach(function(e){var t=e.value.split("/");corpeType=t[t.length-1];var i=e.name;"resourceid"===i?f=e.value:"logicalid"===i?_=e.value:"ds6w:label"===i?m=e.value:"type_icon_url"===i?g=e.value:"preview_url"===i?b=e.value:"type"===i&&(v=e.value)}),c={coretype:"",logicalid:_,name:m,physicalid:f,type_icon_url:g,preview_url:b,trueType:v},d=!0}}if(!d){var C=t&&t[n]&&t[n].length?t[n][a]:void 0;c={coretype:"PLMCoreInstance",logicalid:C=C||l,name:"",physicalid:C}}r.push(c)}i.push(r)}return i},i=0;i<this._toFeedUI.length;i++){var n=this._toFeedUI[i].repairFilterInfo,s=n.allPathsInfo.results,o=n.brokenAddedNodes;if(o&&o.length>0){var r=n.brokenAddedLogicalDB;e=e.concat(t(o,r))}var a=n.brokenExcludedNodes;if(a&&a.length>0){var l=n.brokenExcludedLogicalDB;e=e.concat(t(a,l))}var d=n.brokenProximity;if(d&&d.length>0){var c=n.brokenLogicalDB;e=e.concat(t(d,c))}}return{paths:e}},_repairFilter:function(e){var t=this;if("CancelRepair"==e.listOfList)t.DisplayFilterPanel(!0);else if(t.DisplayFilterPanel(!0),t.removeInvalidPaths(e.listOfList),e.listOfList.length>0){var i=[];e.listOfList.forEach(function(e){i=i.concat(e.flat())}),1===(i=[...new Set(i)]).length&&"null"===i[0]||u.executeFetchLogicalID(i,t.options.pfServiceId).then(function(i){var n=i.results,s=[];s.push(e.listOfList),s.push(n);var o={data:s};t.dispatchEvent("RepairFilter_UpdateContextUI",o)})}else{t.dispatchEvent("RepairFilter_UpdateContextUI",{data:[[],[]]})}},removeInvalidPaths:function(e){for(var t=0;t<e.length;t++){-1==e[t].indexOf("null")&&0!=e[t].length||(e.splice(t,1),t--)}},IsPathPresent:function(e,t){for(var i=!1,n=0;n<e.length;n++){i=!0;for(var s=0;s<e[n].length;s++)e[n][s]!=t[s]&&(i=!1);if(1==i)return i}return i},DisplayFilterPanel:function(e){var t=this.options.options?this.options.options.UXId:void 0;u.showFilterContainer(t,e)},_getProximityPath:function(e){for(var t=[],i=e.allVolumes||[],n=i.length,s=0;s<n;s++){var o=i[s];if(o.allVolumes){var r=this._getProximityPath(o);t=t.concat(r.flat())}else"proximity"===o.parameters.type&&t.push(o.parameters.root_path_physicalid)}return t}})}),define("DS/ENONextGenFilterUX/views/CriteriaTagView",["DS/ENONextGenFilterUX/views/CriteriaAbstractView","UWA/Core","UWA/Class/View","UWA/Promise","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/Handlebars/Handlebars4","DS/ENONextGenFilterUX/models/CriterionModel","text!DS/ENONextGenFilterUX/templates/configurationViewTemplate.html","text!DS/ENONextGenFilterUX/assets/ENOStrRefinementUX_require.json","DS/ENONextGenFilterUX/utils/FilterUIService"],function(e,t,i,n,s,o,r,a,l,d,c){"use strict";return e.extend({className:"tagCriterion",setup:function(e){this._parent(e)},render:function(){return this},isCriterionValidate:function(){return 0===c.isAsynchronousValidation()||new n(function(e){e(!0)})},viewFromMdl:function(e){console.log("RCIIIII CriteriaTagView.veiwFromMMdl")},isThereCriteria:function(){var e=!1,t=this.model.get("tagData");if(t)return(Object.keys(t.allfilters).length||Object.keys(t.localfilters).length)&&(e=!0),e}})}),define("DS/ENONextGenFilterUX/views/CriteriaConfigurationView",["DS/ENONextGenFilterUX/views/CriteriaAbstractView","UWA/Core","UWA/Class/View","UWA/Promise","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/Handlebars/Handlebars4","DS/ENONextGenFilterUX/models/CriterionModel","text!DS/ENONextGenFilterUX/templates/configurationViewTemplate.html","text!DS/ENONextGenFilterUX/assets/ENOStrRefinementUX_require.json","DS/ENONextGenFilterUX/utils/FilterUIService","DS/Controls/Button","DS/Controls/LineEditor","DS/Controls/TooltipModel","DS/Controls/Toggle","DS/ENOFilterBIUX/NGFServices"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,f){"use strict";return e.extend({className:"configurationCriterion",tagName:"li",domEvents:{"click .configCriterion-read .confRead":"_checkBeforeEdit","click .configCriterion-read .confReadIcon":"_checkBeforeEdit"},setup:function(e){this._parent(e),this._configFactory=void 0,this._rootID=e.rootId,this._template=r.compile(l),this._hasConf=!1,this._initWithConfig=e.initWithConfig||!1,this.listenTo(this.model,"onChange:state",this.onStateChange.bind(this))},render:function(){return this.container.setContent(this._template({stateClass:this.model.get("state"),titleClass:s.get("titleConfigurationUX"),iconHeader:o.getWebappsAssetUrl("ENONextGenFilterUX","icons/22/I_ConfigurationFilter.png")})),this._createHeaderCtxMenu(),this},onStateChange:function(e,t){this.getElement(".f-configuration-container").setAttribute("class","f-configuration-container "+t);if("read"===t){var i=this.model.criterionToString()||"",n=i,o=c.MAX_CAR_FOR_CONFIG,r=this.getElement(".confRead");if(o<n.length){if(!this._extensionText){this._extensionText=new u({touchMode:c.TOUCH_MODE,displayStyle:"lite",label:s.get("ShowLess"),id:"ShowMoreOrLess_"+this._childGroupId,checkFlag:!0}),this._extensionText.inject(r,"after"),this._extensionText.getContent().addClassName("filter-anchor-style");var a=this;this._extensionText.addEventListener("buttonclick",function(e){e.dsModel.checkFlag=!e.dsModel.checkFlag}),this._extensionText.addEventListener("change",function(e){var t=a.model.criterionToString(),i=t;e.dsModel.checkFlag?(e.dsModel.label="("+s.get("ShowLess")+")",i+="  "):(e.dsModel.label="("+s.get("ShowMore")+")",i=i.substr(0,o)+" ... "),a._displayConfigValue(r,i,t)})}this._extensionText.checkFlag=!1,this._extensionText.show()}else this._extensionText&&this._extensionText.hide(),this._displayConfigValue(r,n,i);this._setContextualMenu("read")}else this.dispatchEvent("NGF_Criterion_SwitchedToEdit"),this._initWithConfig||this._launchCfgFactory(),this._setContextualMenu("edit")},_displayConfigValue:function(e,t,i){e.setContent([{tag:"span",html:t}]),e.tooltipInfos?e.tooltipInfos.shortHelp=i:e.tooltipInfos=new p({shortHelp:i,mouseRelativePosition:!0})},_getDOMElementToUpdateOnActivateChange:function(){var e=[];return this.getElement("#"+this._getId()+" .configCriterion-read").getChildren().forEach(t=>e.push(t)),e},destroy:function(){this._hasConf=!1,this.dispatchEvent("NGF_RemoveCriterion",{idxView:this.cid,criteriaType:this.model.get("criteriaType"),hasConf:this._hasConf}),this.stopListening(),this.model=null,this._parent(),this.container=null},_getCallbackToEditCriterion:function(){return this.editConfiguration.bind(this)},editConfiguration:function(){this.model.set("state","edit")},launchCfgFactoryWithConfig:function(e){var t=this;return t._initWithConfig=!1,new n(function(i,n){var s=JSON.parse(d).conf;require([s],function(n){t._configFactory=n;var s=c.getPlatformId(),o={rootId:t._rootID,callback:function(e){t._onConfigFilterCB(e),i()}.bind(t),expression:t._hasConf?t.model.get("expression"):{},config_filter_id:t.model.has("config_filter_id")?t.model.get("config_filter_id"):"",tenant:s,platformUrl:c.getPlatformServiceUrl(s,t._pfServiceId),renderTo:t.getElement(".configCriterion-edit"),renderToApp:c.getGlobalEditContainer(t._UXId),hideFilter:t._hideFilterContainer.bind(t),showFilter:t._showFilterContainer.bind(t),displayCompactMode:("1"===localStorage.getItem("NGF_DisplayDensity")?0:1)||0,configData:e,securityContext:t.options.securityContext};if(f.isDebugActive("config")){t._debugConfigFilter(o,1),i()}else t._configFactory.begin(o),i()})})},_launchCfgFactory:function(){var e=this,t=JSON.parse(d).conf;require([t],function(t){e._configFactory=t;var i=c.getPlatformId(),n={rootId:e._rootID,callback:e._onConfigFilterCB.bind(e),expression:e._hasConf?e.model.get("expression"):{},config_filter_id:e.model.has("config_filter_id")?e.model.get("config_filter_id"):"",tenant:i,platformUrl:c.getPlatformServiceUrl(i,e._pfServiceId),renderTo:e.getElement(".configCriterion-edit"),renderToApp:c.getGlobalEditContainer(e._UXId),hideFilter:e._hideFilterContainer.bind(e),showFilter:e._showFilterContainer.bind(e),displayCompactMode:("1"===localStorage.getItem("NGF_DisplayDensity")?0:1)||0,securityContext:e.options.securityContext};if(f.isDebugActive("config")){e._debugConfigFilter(n,0)}else e._configFactory.begin(n)})},_onConfigFilterCB:function(e){if(0===e.length){var t={criteriaType:this.model.get("criteriaType"),action:"remove"};this.dispatchEvent("NGF_Criterion_Config",t)}else{var i=e[0][this._rootID],n=this.model;n.set("displayExpression",i.displayExpression),n.set("expression",i.expression),i.config_filter_id?(n.set("config_filter_id",i.config_filter_id),n.unset("config_filter")):(n.set("config_filter",i.compiledBinary),n.unset("config_filter_id"));this._hasConf=!0;t={criteriaType:n.get("criteriaType"),cfgType:n.get("config_filter_id")?"configId":"binary",action:"update",hasConf:this._hasConf};this.dispatchEvent("NGF_Criterion_Config",t),c.isModelActivated(n)||!0!==this._isCriterionModified()||this._switchCriterionState(),this.dispatchEvent("NGF_Criterion_Validation",{criteriaType:n.get("criteriaType")}),"none"!==c.getGlobalEditContainer(this._UXId).getStyle("display")&&c.showFilterContainer(!0)}},_isCriterionModified:function(){return!0},isCriterionValidate:function(){if(0===c.isAsynchronousValidation())return t=this._configFactory&&this._configFactory.validateConfigurationFilter?"edit"!==this.model.get("state")||this._configFactory.validateConfigurationFilter():"read"===this.model.get("state");var e=this;if(f.isDebugActive("config"))return"edit"===this.model.get("state")?new n(function(t){e._dbgDefineConfig({callback:e._onConfigFilterCB.bind(e)}),t(!0)}):new n(function(e){e(!0)});if(this._configFactory&&this._configFactory.validateConfigurationFilter)return"edit"===this.model.get("state")?new n(function(t){e._configFactory.validateConfigurationFilter().then(function(e){t(e)})}):new n(function(e){e(!0)});var t="read"===this.model.get("state");return new n(function(e){e(t)})},viewFromMdl:function(e){this.model.set("displayExpression",e.displayExpression),this.model.set("filterName",e.filterName),this.model.set("expression",e.expression),e.config_filter_id?(this.model.set("config_filter_id",e.config_filter_id),this._hasConf=!(!e.config_filter_id||0===Object.keys(e.config_filter_id))):(this.model.set("config_filter",e.config_filter),this._hasConf=!(!e.config_filter||!e.config_filter.length)),"0"===e.isActivated&&this._switchCriterionState()},isThereCriteria:function(){return this._hasConf},_createHeaderCtxMenu:function(){this._createCriterionCtxMenuWUX(this.getElement(".criterionDropDown")),this._setContextualMenu("edit")},_cancelEditCriteria:function(){if(!this._hasConf){var e=this.model;e.unset("displayExpression"),e.unset("filterName"),e.unset("expression"),e.unset("config_filter"),e.unset("config_filter_id")}this._launchCfgFactory()},_debugConfigFilter:function(e,i){var n=this,s=i?"launchCfgFactoryWithConfig":"launchCfgFactory";if(1===i&&1===e.configData.createDummyCfg)n._dbgDefineConfig(e,s);else{if(!n._hasConf||!n._dbgConfigValue){var o="1"===localStorage.getItem("NGF_DisplayDensity"),r=t.createElement("div",{id:"xDiv"});r.inject(e.renderTo),r.style.border="thin dashed #368ec4",r.style.borderRadius="5px",r.style.padding="10px",n._dbgConfigValue=new h({touchMode:o,placeholder:"Enter a Configuration value"});var a=new u({touchMode:o,displayStyle:"normal",showLabelFlag:!1,icon:c.getIconByName("check")}),l=new u({touchMode:o,displayStyle:"normal",showLabelFlag:!1,icon:c.getIconByName("wrong")}),d=new u({touchMode:o,label:"Click to Display User-Panel",icon:c.getIconByName("forward")});n._toggle1=new _({touchMode:o,type:"switch",label:"Use ProdConf",checkFlag:!!e.config_filter_id}),n._dbgConfigValue.inject(r),d.inject(r),n._toggle1.inject(r);var p=t.createElement("div",{id:"xDiv2"});p.inject(r),p.setAttribute("style","text-align:right"),a.inject(p),l.inject(p),a.getContent().addClassName("attribute-edit-button-style attributeCriterion-edit-validate colorized"+(o?"":" filter-no-touch-mode")),l.getContent().addClassName("attribute-edit-button-style"+(o?"":" filter-no-touch-mode")),a.getContent().style.marginLeft=o?"10px":"5px",l.getContent().style.marginLeft=o?"10px":"5px",a.getContent().style.marginTop="10px",d.getContent().style.marginTop="10px",l.getContent().style.marginTop="10px",n._toggle1.getContent().style.marginTop="10px",d.addEventListener("buttonclick",function(t){e.hideFilter.call()}),a.addEventListener("buttonclick",function(t){var i=n._dbgConfigValue.value||"xDisplayExpression";n._dbgDefineConfig(e,i,n._toggle1.checkFlag)}),l.addEventListener("buttonclick",function(t){e.callback([])});var f=e.renderToApp.getElement("#topDiv");f&&e.renderToApp.removeChild(f);var m=t.createElement("div",{id:"topDiv"});m.inject(e.renderToApp),m.style.height="100%",m.style.display="flex",m.style.border="thin solid #368ec4",m.style.borderRadius="5px";var g=new u({touchMode:o,domId:"go-back-filter-panel",label:"Click to exit User-Panel",icon:c.getIconByName("reply")});g.inject(m),g.getContent().style.margin="auto",g.addEventListener("buttonclick",function(t){e.showFilter.call()})}n._dbgConfigValue&&n.model&&(n._dbgConfigValue.value=n.model.get("displayExpression"))}},_dbgDefineConfig:function(e,t,i){var n;n=t||(this._hasConf&&this._dbgConfigValue?this._dbgConfigValue.value:"xDisplayExpression");var s=[];s[this._rootID]={},s[this._rootID].displayExpression=n,s[this._rootID].expression={label:"xExpression-"+this.cid},i?s[this._rootID].config_filter_id={physical_id:'"'+this._rootID+'"'}:s[this._rootID].compiledBinary="xCompiledBinary_"+this.cid+"_"+n,-1!==n.indexOf("Revision")&&(s[this._rootID].expression.configurationRevision={name:"xConfigurationRevision-"+this.cid}),e.callback([s])}})}),define("DS/ENONextGenFilterUX/utils/FilterCollectionServices",["UWA/Class","UWA/Core","UWA/Class/Options","DS/ENOFilterBIUX/NGFServices","DS/ENONextGenFilterUX/collections/FilterUIGlobalFilterCollection","DS/ENONextGenFilterUX/collections/FilterUIGroupCollection","DS/ENONextGenFilterUX/models/GlobalFilterModel","DS/ENONextGenFilterUX/models/GroupModel","DS/ENONextGenFilterUX/models/CriterionModel","DS/ENOFilterBIUX/FBIServices"],function(e,t,i,n,s,o,r,a,l,d){"use strict";return e.singleton(i,{init:function(){},buildCVQueryFromModel:function(e){var t=this._buildCVQueryFromModel(e);return e.filterCVQuery===t?e.filterCVQuery=t:(n.isDebugActive("ngf")&&(console.log("---------------------------------------  buildCVQueryFromModel  ----------------------------------------"),console.log("filterCVQuery = "+e.filterCVQuery),console.log(" "),console.log("Computed filterCVQuery = "+t),console.log("------------------------------------------------------------------------------------------------------")),e.filterCVQuery=t),t},_buildCVQueryFromModel:function(e){var t=this,i=n.getFilterUIComponents(e),d=i.length,c=new r({state:"init"}),u=new s(null,{model:c}),h=i[0];c.set("combinationOfSpecification",h.toFeedUI.combinationOfSpecification),c.set("minusIndex",h.toFeedUI.minusIndex),c.set("keepChildren",h.toFeedUI.keepChildren||!0),c.set("specVersion",h.toFeedUI.specVersion||n.getCurrentSpecificationVersion());for(var p=1;p<d;p++){var _=i[p],f=new o([],{});f.setActivated(_.isActivated||"1");for(var m=_.toFeedUI,g=m.length,v=0;v<g;v++){var b,C=m[v],y=C.criteriaType;if("config"===y||"tag"===y)b=new l,Object.keys(C).forEach(function(e){var t="null"===C[e]?"":C[e];b.set(e,t)}),b.get("isActivated")||b.set("isActivated","1");else if("context"===y){b=new l,Object.keys(C).forEach(function(e){var t="null"===C[e]?"":C[e];b.set(e,t)}),void 0===b.get("addedNodesList")&&b.set("addedNodesList",[]),void 0===b.get("excludedNodesList")&&b.set("excludedNodesList",[]),void 0===b.get("AddNodeActivated")&&b.set("AddNodeActivated",!0),void 0===b.get("ExcludeNodeActivated")&&b.set("ExcludeNodeActivated",!0)}else if("attribute"===y){b=new l,Object.keys(C).forEach(function(e){if("allAttributes"===e){var i=t._buildForComplexAttribute(e,C[e]);b.set(e,i)}else{var n="null"===C[e]?"":C[e];b.set(e,n)}}),b.get("isActivated")||b.set("isActivated","1"),void 0===b.get("Keep")&&b.set("Keep",!0),b.get("extension")||b.set("extension","")}else if("volume"===y){b=new l,Object.keys(C).forEach(function(e){if("allVolumes"===e){var i=t._buildForComplexVolume(e,C[e]);b.set(e,i)}else{var n="null"===C[e]?"":C[e];b.set(e,n)}}),b.get("isActivated")||b.set("isActivated","1")}else if("Sequence"===y){var A=new o([],{});if(b=new a({subGroupCollection:A}),"attribute"===C.sequenceType)Object.keys(C).forEach(function(e){if("allAttributes"===e){var i=t._buildForComplexAttribute(e,C[e]);void 0===i[0].get("Keep")&&i[0].set("Keep",!0),b.get("subGroupCollection").add(i)}else{var n="null"===C[e]?"":C[e];b.set(e,n)}})}b&&f.add(b)}u.addGroupCollection(f)}var F=c.get("keepChildren"),I=e.rootPhysicalId;return u.buildCVQuery(I,F)},_buildForComplexAttribute:function(e,t){for(var i=[],n=t.length,s=0;s<n;s++){var o=t[s],r=new l,a=Object.keys(t[s]),d=this;a.forEach(function(t){if(e===t){var i=d._buildForComplexAttribute(t,o[t]);r.set(t,i)}else{var n="null"===o[t]?"":o[t];r.set(t,n)}}),i.push(r)}return i},_buildForComplexVolume:function(e,t){for(var i=[],n=t.length,s=0;s<n;s++){var o=t[s],r=new l,a=Object.keys(t[s]),d=this;a.forEach(function(t){if(e===t){var i=d._buildForComplexVolume(t,o[t]);r.set(t,i)}else{var n="null"===o[t]?"":o[t];r.set(t,n),r.get("isActivated")||r.set("isActivated","1")}}),i.push(r)}return i}})}),define("DS/ENONextGenFilterUX/views/AdvFilterIDCard",["UWA/Core","UWA/Class","UWA/Class/View","UWA/Class/Model","UWA/Promise","DS/WAFData/WAFData","DS/CoreEvents/ModelEvents","DS/ENOXIDCard/js/IDCard","DS/i3DXCompassPlatformServices/OpenWith","DS/Controls/Label","DS/Controls/Button","DS/Controls/ComboBox","DS/ControlsEx/IDCard","DS/ENOFilterBIUX/NGFServices","DS/ENOFilterBIUX/FBIServices","DS/PlatformAPI/PlatformAPI","DS/Menu/Menu","DS/ENONextGenFilterUX/utils/FilterUIService","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/UIKIT/Mask"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,f,m,g,v,b,C){"use strict";return t.extend({init:function(e){this._container=e.parent,this._pfServiceId=e.serviceId,this._defaultSC=e.securityContext,this._widgetId=e.widgetId;var t=decodeURIComponent(window.location.href);this._isOwnerContainer=-1!==t.indexOf("NGFDebugIC=1"),this._isReviseActive=this._isOwnerContainer,this._isMaturityContainer=!0,this._isFilterModified=0},setContext:function(e){this._pfServiceId=e.serviceId||this._pfServiceId,this._defaultSC=e.securityContext||this._defaultSC},displayUnsavedChangesPanel:function(e){var t=this._container.getElement("#ngf-idcard-unsaved-values");t&&(e?(t.show(),this._isFilterModified=1):(t.hide(),this._isFilterModified=0))},isFilterModified:function(e){return this._isFilterModified},remove:function(e){this._subscriptionRefreshEvent&&this._subscriptionRefreshEvent.unsubscribe("DS/PADUtils/PADCommandProxy/refresh");var t=this._container.getElement(".global-header-idcard");if(t){var i=t.getElement("#ngf-idcard-id");i&&i.remove()}},updateIDCard:function(e,t){var i=this;return this._activeFilter=e||this._activeFilter,new s(function(n){i._computeOpenWithAppsList(i._activeFilter).then(s=>{i._openWithApps=s,i._initMaturityStateGraph(e).then(s=>{(i._maturityStateGraph=s,i._IDCardModel&&i._container.getElement("#ngf-idcard-id"))||(i._container.getElements("#ngf-idcard-unsaved-values").forEach(e=>{e.remove()}),i._createIDCardTemplate());i.displayUnsavedChangesPanel(!1),i._updateIDCard(e,t).then(()=>{n()})})})})},_createIDCardTemplate:function(){var t=this,i=t._container.getElement(".global-header-idcard"),s=new r;s.addEventListener("ngf-open-actions-menu-event",function(e){var n=i.getElement(".xapp-id-card-container .fonticon-open-down").getBoundingClientRect();e&&(e.stopPropagation(),n=e.target.getBoundingClientRect()),m.show(t._idCardActionsSubMenu,{position:{x:n.left,y:n.bottom}})}),s.addEventListener("ngf-show-version-explorer-event",function(e){t._isReviseActive&&t._reviseFilter().then(function(e){t._activeFilter=e,t._updateIDCard(t._activeFilter).then(()=>{})})}),s.addEventListener("idcard-minified",function(e){}),s.addEventListener("idcard-expanded",function(e){p.setUsageTracker(t._widgetId,"NGF-IDCard","expand")}),t._IDCardModel=new n({name:"?",version:"?",thumbnail:b.getWebappsAssetUrl("ENONextGenFilterCmd","icons/32/I_DefineFilter.png"),withHomeButton:!1,withExpandCollapseButton:!1,withActionsButton:!0,withInformationButton:!1,withToggleMinifiedButton:!0,modelEvents:s,attributes:t._getAttributes(),minified:!0,customEvents:{versionLabelClick:{event:"ngf-show-version-explorer-event"},actionsMenuClick:{event:"ngf-open-actions-menu-event"}}});var o=new a({id:"ngf-idcard-id",touchMode:g.TOUCH_MODE,model:t._IDCardModel});o.render().inject(i),o.attachResizeSensor();var l=e.Element("div",{id:"ngf-idcard-unsaved-values",class:"ngf-idcard-unsaved-changes"}),d=e.createElement("img",{id:"ngf-idcard-unsaved-icon",src:b.getWebappsAssetUrl("ENONextGenFilterUX","icons/20/filterWarning.png")}),c=e.Element("label",{id:"ngf-idcard-unsaved-msg",text:v.get("ChangesNotSaved")});if(d.inject(l),c.inject(l),l.inject(o.getContent(),"after"),l.hide(),!this._isReviseActive){var u=o.getElement(".version");u&&u.addClassName("ngf-idcard-revision")}i.addEventListener("dragstart",function(e){e.target.style.opacity=.5,e.dataTransfer.effectAllowed="copy",e.dataTransfer.setData("text/plain",t._getDraggedFilterData())}),i.addEventListener("dragend",function(e){p.setUsageTracker(t._widgetId,"NGF-IDCard","dragEnd"),e.target.style.opacity="",e.dataTransfer.clearData("text/plain")}),t._subscriptionRefreshEvent=f.subscribe("DS/PADUtils/PADCommandProxy/refresh",e=>{for(var i=e.data&&e.data.authored?e.data.authored.modified:[],n=i.length,s=0;s<n;s++){var o=i[s];if(t._activeFilter===o||t._activeFilter===o.physicalid){p.getFilterBasics(t._activeFilter).then(function(e){var i=e[0][t._activeFilter];t._updateIDCard(t._activeFilter,i),g.openFilterPanel("NGF_IDCard_"+Date.now())},function(e){console.log("=> Edit Properties failed, error ="+e)});break}}}),t._buildAttributesAsContainer(t._container)},_getAttributes:function(){return[{id:"ngf-attr-idcard-maturity",name:v.get("maturityStateIDCardAttr"),value:this._isMaturityContainer?'<div id="ngf-idcard-maturity"></div>':"?",displayWhenMinified:!0,editable:!1,container:!!this._isMaturityContainer,classname:this._isMaturityContainer?"ngf-idcard-maturity-container":""},{id:"ngf-attr-idcard-owner",name:v.get("ownerIDCardAttr"),value:this._isOwnerContainer?'<div id="ngf-idcard-owner"></div>':"?",editable:!!this._isOwnerContainer,container:!!this._isOwnerContainer},{id:"ngf-attr-idcard-collab-space",name:v.get("collabSpaceIDCardAttr"),value:"?",type:"type-text",editable:!1}]},_buildAttributesAsContainer:function(t){var i=this;if(i._isMaturityContainer){var n=t.getElements("#ngf-idcard-maturity"),s=n[0],o=n[1];for(s.addClassName("ngf-idcard-maturity"),o.addClassName("ngf-idcard-maturity");s.firstChild;)s.removeChild(s.firstChild);for(;o.firstChild;)o.removeChild(o.firstChild);var r=e.Element("label",{id:"ngf-idcard-maturity-state",text:"?",class:"ngf-idcard-maturity-state"});s.appendChild(r),o.appendChild(r.cloneNode(!0)),(l=e.Element("a",{id:"ngf-idcard-maturity-next-state-anchor",text:"?"})).inject(o);var a=e.Element("span",{id:"ngf-idcard-maturity-submenu",class:"wux-ui-3ds fonticon fonticon-chevron-down ngf-idcard-maturity-submenu","font-family":WUXManagedFontIcons.Font3DSs});a.inject(o),l.addEventListener("click",function(e){var t=e.target.getText(),n=Object.keys(i._maturityStateGraph).find(e=>-1!==t.indexOf(i._maturityStateGraph[e].label));n&&i._onSetMaturity({context:{url:g.getMaturityChangeStateUrl(),state:i._maturityStateGraph[n].value}})}),a.addEventListener("click",function(e){var t=e.target.getBoundingClientRect();e&&(e.stopPropagation(),t=e.target.getBoundingClientRect());var n=v.get("setMaturityToIDCardItem"),s=i._idCardActionsSubMenu.filter(e=>-1!==e.title.indexOf(n));m.show(s,{position:{x:t.left,y:t.bottom}})})}if(i._isOwnerContainer){var l,d=t.getElement("#ngf-idcard-owner");(l=e.Element("a",{id:"ngf-idcard-owner-value",text:"?"})).inject(d);var c=["Yves","Maïlys","Raphaële","Alexis"],h=[];["ycn","yxy","rci","ajt3"].forEach((e,t)=>{h.push({valueItem:e,labelItem:c[t]})});var p=new u({touchMode:g.TOUCH_MODE,actionOnClickFlag:!0,elementsList:h,preselectedIndex:0,placeholder:"Select a user ...",autocompleteFlag:!1,generateRegexpString:function(e){return e}});p.inject(d),p.hide(),l.addEventListener("click",function(e){l.hide(),p.show()}),p.addEventListener("change",function(e){var t=e.dsModel.value;t?i._changeOwner(t).then(()=>{i._updateIDCard(i._activeFilter),l.show(),p.hide()},function(e){l.show(),p.hide()}):(l.show(),p.hide())})}},_computeOpenWithAppsList:function(e){var t=this;return this._openWithApps=[],new s(function(i){t._openWith=new l,t._openWith.set3DXContent({data:{items:[{serviceId:t._pfServiceId,envId:p.getTenant(),objectId:e,objectType:"ENOStrRefinementSpecification"}]}}),t._openWith.retrieveCompatibleApps(function(e){i(e)})})},_initMaturityStateGraph:function(){var e=this;return new s(function(t,i){o.authenticatedRequest(g.getMaturityStatesAttributesUrl(),{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:e._defaultSC},method:"POST",data:JSON.stringify({objectids:[e._activeFilter]}),type:"json",proxy:"passport",onComplete:function(e){e.policies.policyName;var i=e.policies.states,n=[];i.forEach(e=>{n.push(e.stateSysName)});var s={};_.getNlsOfPropertiesValues({"ds6w:status":n}).then(e=>{i.forEach(t=>{var i=t.stateSysName;s[i]={value:i,label:e["ds6w:status"][t.stateSysName]||i};var n=t.activeColor,o="white",r="";"Obsolete"===i&&(o=r="#BABABA"),s[i].colors={background:n,font:o,border:r}}),t(s)})},onFailure:function(e){console.log(" ==> Get Maturity State Graph failed: "+e),i(e)}})})},_buildIDCardSubmenu:function(e){var t=this,i=[],n=[];this._openWithApps.forEach(function(e){n.push({type:"PushItem",title:e.text,fonticon:e.fonticon&&e.fonticon.length>0?{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-"+e.fonticon,family:WUXManagedFontIcons.Font3DS}:void 0,icon:e.icon?e.icon:"",action:{this:t,callback:t._onOpenWith,context:{handler:e.handler,name:e.name}}})}),n.length&&i.push({type:"PushItem",title:v.get("openWithIDCardItem"),icon:g.getIconByName("open-menu-dot"),submenu:n});var s=v.get("setMaturityToIDCardItem"),o=e[1];o&&i.push({type:"PushItem",recId:"global-header-idcard-maturity-demote",title:s+this._maturityStateGraph[o].label,icon:b.getWebappsAssetUrl("ENONextGenFilterUX","icons/16/demote_"+o.toLowerCase()+".png")||g.getIconByName("double-chevron-left"),action:{this:t,callback:t._onSetMaturity,context:{url:g.getMaturityChangeStateUrl(),state:o}}});var r=e[0];return r&&i.push({type:"PushItem",recId:"global-header-idcard-maturity-promote",title:s+this._maturityStateGraph[r].label,icon:b.getWebappsAssetUrl("ENONextGenFilterUX","icons/16/promote_"+r.toLowerCase()+".png")||g.getIconByName("double-chevron-right"),action:{this:t,callback:t._onSetMaturity,context:{url:g.getMaturityChangeStateUrl(),state:r}}}),i.push({type:"PushItem",recId:"global-header-idcard-properties",title:v.get("informartionIDCardItem"),icon:g.getIconByName("info-open-in-a-new-window"),action:{this:t,callback:t._launchEditProperties}}),i},_onSetMaturity:function(e){var t=this,i=this._container.getElement("#ngf-idcard-id")||t._container.getContent();C.mask(i),t._getCSRFToken().then(n=>{var s=e.context.state,r=e.context.url;o.authenticatedRequest(r,{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:t._defaultSC,ENO_CSRF_TOKEN:n},method:"POST",data:JSON.stringify({data:[{id:t._activeFilter,nextState:s}]}),type:"json",proxy:"passport",onComplete:function(e){o.authenticatedRequest(g.getMaturityNextStatesUrl(),{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:t._defaultSC,ENO_CSRF_TOKEN:n},method:"POST",data:JSON.stringify({data:[{id:t._activeFilter}]}),type:"json",proxy:"passport",onComplete:function(e){C.unmask(i),p.setUsageTracker(t._widgetId,"NGF-IDCard","maturity"),t._updateIDCard(t._activeFilter,{maturity:s})},onFailure:function(e){C.unmask(i),console.log(" ==> _onSetMaturity / Get Next Maturity State failed: ("+e.errorReport[0].errorCode+") "+e.errorReport[0].errorMessage)}})},onFailure:function(e){C.unmask(i),console.log(" ==> _onSetMaturity / Change Maturity failed: ("+e.errorReport[0].errorCode+") "+e.errorReport[0].errorMessage)}})},function(e){C.unmask(i),console.log(" ==> _onSetMaturity / getCRSFTokenUrl() failed: "+e)})},_updateMaturityUI:function(e){var t=this._getSurroundingMaturityStates(e);this._idCardActionsSubMenu=this._buildIDCardSubmenu(t);var i=this._container.getElement(".global-header-idcard"),n=this._isMaturityContainer?"#ngf-idcard-maturity-state":"#ngf-attr-idcard-maturity",s=i.getElements(n),o=this._maturityStateGraph[e].colors;if(s.forEach(e=>{var t=o.border?"border: 1px solid "+o.border+";":"",i="background-color:"+o.background+";"+t+"color:"+o.font+";";e.setAttribute("style",i)}),this._isMaturityContainer){var r=t[0]||"Obsolete",a=(s=i.getElements("#ngf-idcard-maturity-next-state-anchor"),v.get("setMaturityToIDCardItem")+this._maturityStateGraph[r].label);s.forEach(e=>{e.setText(a)}),void 0===t[0]&&(s&&s[0].hide(),(s=i.getElements("#ngf-idcard-maturity-submenu"))&&s[0].hide())}},_onOpenWith:function(e){e=e.context;p.setUsageTracker(this._widgetId,"NGF-IDCard-OpenWith",e.name),e.handler.call()},_launchEditProperties:function(e){var t=this;try{require(["DS/EditPropWidget/EditPropComponent","DS/EditPropWidget/constants/EditPropConstants","DS/EditPropWidget/models/EditPropModel"],function(e,i,n){var s=new e({typeOfDisplay:i.ALL,selectionType:i.ALL_SELECTION,displayType:i.POPUP,setCloseButton:!0,setEditButton:!0,readOnly:!1,extraNotif:!1,editMode:!1,events:{onCancel:function(){t._subscriptionRefreshEvent.unsubscribe("DS/PADUtils/PADCommandProxy/refresh")}}}),o=new n({tenant:p.getTenant(),objectId:t._activeFilter});p.setUsageTracker(t._widgetId,"NGF-IDCard","properties"),s.show([o])}.bind(this))}catch(e){console.error(e)}},_getSurroundingMaturityStates:function(e){var t=[void 0,void 0],i=Object.keys(this._maturityStateGraph),n=i.indexOf(e);if("Obsolete"!==e){var s=0<=n-1?i[n-1]:void 0;s&&"Released"!==e&&(t[1]=s);var o=i.length-1>=n+1?i[n+1]:void 0;o&&(t[0]=o)}return t},_reviseFilter:function(){var e=this,t=this._container.getElement("#ngf-idcard-id")||e._container.getContent();return C.mask(t),new s(function(i,n){e._getCSRFToken().then(s=>{var r=g.getVersioningUrl(),a=g.getPlatformServiceUrl(p.getTenant(),e._pfServiceId),l={data:[{id:e._activeFilter,identifier:e._activeFilter,type:"ENOStrRefinementSpecification",source:a,relativePath:"/resources/v1/modeler/dsadvfilter/dsadvfilter:AdvFilter/"+e._activeFilter}]};o.authenticatedRequest(r,{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:e._defaultSC,ENO_CSRF_TOKEN:s},method:"POST",data:JSON.stringify(l),type:"json",proxy:"passport",onComplete:function(e){C.unmask(t),i(e.results[0].id)},onFailure:function(e){C.unmask(t),console.log(" ==> _reviseFilter / Versioning failed: ("+e.errorReport[0].errorCode+") "+e.errorReport[0].errorMessage),n(e)}})},function(e){C.unmask(t),console.log(" ==> _reviseFilter / getCRSFTokenUrl() failed: "+e),n(e)})})},_changeOwner:function(e){var t=this,i=this._container.getElement("#ngf-idcard-id")||t._container.getContent();return C.mask(i),new s(function(n,s){var r=t._defaultSC.split("."),a={owner:e,organization:r[1],collabspace:r[2],data:[{id:t._activeFilter}]};t._getCSRFToken().then(e=>{o.authenticatedRequest(g.getOwnershipUrl(),{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:t._defaultSC,ENO_CSRF_TOKEN:e},method:"POST",data:JSON.stringify(a),type:"json",proxy:"passport",onComplete:function(e){C.unmask(i),n()},onFailure:function(e){C.unmask(i),console.log(" ==> _changeOwner / Change Owner failed: ("+ +e.errorReport[0].errorCode+") "+e.errorReport[0].errorMessage),s(e)}})},function(e){C.unmask(i),console.log(" ==> _changeOwner / getCRSFTokenUrl() failed: "+e),s(e)})})},_updateIDCard:function(e,t){var i=this;return new s(function(n,s){var o=i._IDCardModel.get("name")||"?",r=i._IDCardModel.get("version")||"?",a=i._IDCardModel.get("attributes"),l="?",d="?",c="?",u=i._getAttributes(),h=function(){var e=i._maturityStateGraph[l]?i._maturityStateGraph[l].label:l;i._isMaturityContainer||(u[0].value=e),i._isOwnerContainer||(u[1].value=d),u[2].value=c,i._IDCardModel.set({name:o,version:r,attributes:u}),i._buildAttributesAsContainer(i._container),i._isMaturityContainer&&i._container.getElements("#ngf-idcard-maturity-state").forEach(t=>{t.setText(e)}),i._isOwnerContainer&&i._container.getElement("#ngf-idcard-owner-value").setText(d),i._updateMaturityUI(l),n()};if(t&&Object.keys(t).length){if(l=t.filterMaturity||t.maturity,i._isMaturityContainer||(l=a[0].value),d=t.filterOwner||t.owner,i._isOwnerContainer)d=i._container.getElement("#ngf-idcard-owner-value").getText();else if(t.filterOwner||t.owner){var p=f.getUser();d=p.firstName+" "+p.lastName}else d=a[1].value;o=t.filterTitle||t.title||i._IDCardModel.get("name"),r=t.filterRevision||t.revision||i._IDCardModel.get("version"),c=t.filterProject||t.project||a[2].value,h()}else if(e){g.executeFetch([e],[],["ds6w:label","ds6wg:revision","ds6w:status","ds6w:responsible","ds6w:project"]).then(function(e){e&&e.results?(e.results.forEach(e=>{e.attributes.forEach(e=>{"ds6w:status"===e.name?l=e.value.substring(e.value.lastIndexOf(".")+1):"ds6w:responsible"===e.name?d=e.value:"ds6w:project"===e.name?c=e.value:"ds6wg:revision"===e.name?r=e.value:"ds6w:label"===e.name&&(o=e.value)})}),h()):console.log(" => Fetch provide NO results / fetched = "+e)},function(e){console.log(" => Refresh Filter IDCard failed / err = "+e),h()})}else h()})},_getDraggedFilterData:function(){return JSON.stringify({protocol:"3DXContent",version:"1.1",source:"ENOREFS_AP",data:{items:[{envId:p.getTenant(),serviceId:this._pfServiceId,contextId:this._defaultSC,objectId:this._activeFilter,objectType:"ENOStrRefinementSpecification",displayName:this._filterTitle}]}})},_getCSRFToken:function(){var e=this;return new s(function(t,i){o.authenticatedRequest(g.getCRSFTokenUrl(),{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:e._defaultSC},method:"GET",type:"json",proxy:"passport",onComplete:function(e){t(e.csrf.value)},onFailure:function(e){console.log(" ==> _getCSRFToken / getCRSFTokenUrl() failed: "+e),i(e)}})})},_changeOwnerAndCollab:function(e){var t=this;require(["DS/ENOCollabSharingCmds/commands/TransferOwnershipCmd/ActionBar_ChangeOwnerCmd"],function(i){var n={_selectedItems:[],getSelectedNodes:function(){return this._selectedItems},addSelection:function(t,i){this._selectedItems=[{physicalid:e,getID:function(){return e},getLabel:function(){return"ycnFilter"}}]},getReference:function(e){return getID()},getParent:function(e){return e.getParent()},getType:function(e){return getType()},getName:function(e){return getLabel()}},s=[],o=[{SecurityContext:t._defaultSC}];o.forEach(e=>{var t=UWA.extend(o[e],{getID:function(){return e.id},getLabel:function(){return e.name},getOwner:function(){return e.owner},getType:function(){return e.type},getDisplayName:function(){return e.name},object:{revision:"-"}});s.push(t)}),n.addSelection(s),new i({context:n,ID:"ActionBar_ChangeOwner"}).execute()})}})}),define("DS/ENONextGenFilterUX/views/WelcomePageFilterView",["UWA/Class","UWA/Class/View","UWA/Core","UWA/Utils","UWA/Promise","UWA/Date","DS/WAFData/WAFData","css!DS/ENONextGenFilterUX/ENONextGenFilterUX.css","DS/WebappsUtils/WebappsUtils","DS/ENOFilterBIUX/NGFServices","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/ENOFilterBIUX/FBIServices","DS/Controls/Button","DS/Controls/TooltipModel","text!DS/ENONextGenFilterUX/templates/welcomePageViewTemplate.html","DS/Handlebars/Handlebars4","DS/ENONextGenFilterUX/utils/FilterUIService"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,f,m){"use strict";return t.extend({domEvents:{},setup:function(e){this._template=f.compile(_),this._rootID=e.rootID,this._rootAlias=e.rootAlias,this._rootRevision=e.rootRevision,this.render()},render:function(){this.container.setContent(this._template({filterOnRoot:c.get("OpenFilter"),newFilter:c.get("NewFilter"),newFilterFromExisting:c.get("NewFilterFromExisting")}));var e=this.getElement("#WelcomePageNGF-RetrieveFilter");return this._createOpenFilterUI(e),e=this.getElement("#WelcomePageNGF-NewFilter"),this._createAddCriterionUI(e),e=this.getElement("#WelcomePageNGF-NewFilterFromExisting"),this._createFromExistingUI(e),this},_createAddCriterionUI:function(e){var t=e.getElement(".welcomepage-action-container");this.options.contextUsed&&this._createAddCriterionButton("context",t),this.options.attributeUsed&&this._createAddCriterionButton("attribute",t),this.options.configUsed&&this._createAddCriterionButton("config",t),this.options.volumeUsed&&this._createAddCriterionButton("volume",t)},_createAddCriterionButton:function(e,t){var i,n,s,o;switch(e){case"attribute":i="add_attr_criterion",n=c.get("addAttributeCriterion"),s=c.get("addAttributeCriterionTooltip"),o=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterAddAttribute.png");break;case"config":i="add_config_criterion",n=c.get("addConfigurationCriterion"),s=c.get("addConfigurationCriterionTooltip"),o=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterAddConfiguration.png");break;case"volume":i="add_volume_criterion",n=c.get("addVolumeCriterion"),s=c.get("addVolumeCriterionTooltip"),o=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterAddVolume.png");break;case"context":i="add_context_criterion",n=c.get("addContextCriterion"),s=c.get("addContextCriterionTooltip"),o=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterAddSelection.png")}var r=new h({touchMode:!0,displayStyle:"normal",showLabelFlag:!0,domId:i,label:n,icon:o});r.inject(t),r.getContent().addClassName("welcomepage-button"),r.tooltipInfos=new p({shortHelp:s,mouseRelativePosition:!0});var a=this;return r.addEventListener("click",function(t){a.dispatchEvent("NGF_WLC_AddCriterion",{type:e})}),r},_createOpenFilterUI:function(e){var t=e.getElement(".welcomepage-action-container");this._createSearchButton(m.FILTER_RELATED_TO_ROOT,t)},_createFromExistingUI:function(e){var t=e.getElement(".welcomepage-action-container");this._createSearchButton(m.FILTER_RELATED_TO_ALL_REVISIONS,t).disabled="3DSpace"!==this.options.pfServiceId,this._createSearchButton("AnyFilter",t)},_createSearchButton:function(e,t){var n,s,o,r,a=m.getRootTitle(this._rootAlias,this._rootRevision);switch(e){case m.FILTER_RELATED_TO_ROOT:n="Search_On_Root",s=i.String.format(c.get("SearchOnRoot"),a),o=i.String.format(c.get("SearchOnRootTooltip"),a),r=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterOpenFilter.png");break;case m.FILTER_RELATED_TO_ALL_REVISIONS:n="Search_On_All_Revisions",s=i.String.format(c.get("SearchOnAllRevisions"),a),o=i.String.format(c.get("SearchOnAllRevisionsTooltip"),a),r=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterCopyFilter.png");break;case"AnyFilter":n="Search_Any",s=c.get("SearchAny"),o=c.get("SearchAnyTooltip"),r=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterCopyFilter.png")}var d=new h({touchMode:!0,displayStyle:"normal",showLabelFlag:!0,domId:n,label:s,value:n,icon:r});d.inject(t),d.getContent().addClassName("welcomepage-button"),d.tooltipInfos=new p({shortHelp:o,mouseRelativePosition:!0});var u=this;return d.addEventListener("buttonclick",function(e){"Search_On_Root"===e.dsModel.value?u.dispatchEvent("NGF_WLC_RetrieveFilter",{type:m.FILTER_RELATED_TO_ROOT,rootIDs:[u._rootID]}):"Search_On_All_Revisions"===e.dsModel.value?u.dispatchEvent("NGF_WLC_RetrieveFilter",{type:m.FILTER_RELATED_TO_ALL_REVISIONS,rootIDs:[u._rootID]}):"Search_Any"===e.dsModel.value&&u.dispatchEvent("NGF_WLC_RetrieveFilter",{type:m.FILTER_RELATED_TO_ANY_ROOT,query:"[ds6w:type]:ENOStrRefinementSpecification"})}),d}})}),define("DS/ENONextGenFilterUX/utils/AttributeChecker",["UWA/Class","UWA/Core","UWA/Class/Options","DS/Controls/ComboBox","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/ENOFilterBIUX/FBISettings","DS/ENONextGenFilterUX/utils/FilterUIService"],function(e,t,i,n,s,o,r){"use strict";var a=s.get("equals"),l=s.get("notEqual"),d=s.get("contains"),c=s.get("notContains"),u=s.get("startsWith"),h=s.get("endsWith"),p=s.get("lowerThan"),_=s.get("greaterThan"),f=s.get("strictlyLowerThan"),m=s.get("strictlyGreaterThan"),g=s.get("between"),v=(s.get("notBetween"),s.get("on")),b=s.get("before"),C=s.get("after"),y=s.get("strictlyBefore"),A=s.get("strictlyAfter"),F=s.get("isEmpty"),I=s.get("isNotEmpty");return e.singleton(i,{init:function(){},getAttributeOperators:function(e,t){var i;switch(t.type){case"string":i={elementsList:[{labelItem:a,valueItem:"equals"},{labelItem:l,valueItem:"notEqual"},{labelItem:d,valueItem:"contains"},{labelItem:c,valueItem:"notContains"},{labelItem:u,valueItem:"startsWith"},{labelItem:h,valueItem:"endsWith"}],selectedIndex:2};break;case"boolean":i={elementsList:[{labelItem:a,valueItem:"equals"}],selectedIndex:0};break;case"real":case"integer":i={elementsList:[{labelItem:a,valueItem:"equals"},{labelItem:p,valueItem:"lowerThan"},{labelItem:_,valueItem:"greaterThan"},{labelItem:f,valueItem:"strictlyLowerThan"},{labelItem:m,valueItem:"strictlyGreaterThan"},{labelItem:g,valueItem:"between"}],placeholder:s.get("selectOp"),selectedIndex:0};break;case"dateTime":case"timestamp":i={elementsList:[{labelItem:v,valueItem:"on"},{labelItem:C,valueItem:"after"},{labelItem:A,valueItem:"strictlyAfter"},{labelItem:b,valueItem:"before"},{labelItem:y,valueItem:"strictlyBefore"},{labelItem:g,valueItem:"between"}],placeholder:s.get("selectOp"),selectedIndex:0};break;case"enumeration":i={elementsList:[{labelItem:a,valueItem:"equals"}],selectedIndex:0}}return i.domId="attrOp",i.touchMode=r.TOUCH_MODE,i.enableSearchFlag=!1,1===(o.getOption("enableEmptyOperator")||0)&&i.elementsList.push({labelItem:F,valueItem:"isEmpty"},{labelItem:I,valueItem:"isNotEmpty"}),new n(i)},getForbiddenCharacter:function(e,t,i){var n=[];switch(e){case"string":n=['"',"[","]"]}return n},checkOperatorAndValue:function(e,t,i,n){var s=!0,o="",r=this.getForbiddenCharacterAsRegExp(e,t,n);switch(e){case"string":for(var a,l=RegExp(r,"g");null!==(a=l.exec(i));)o+=a[0];s=!o.length}return{isValid:s,forbidden:o}},getForbiddenCharacterAsRegExp:function(e,t,i){var n="\0$",s=this.getForbiddenCharacter(e,t,i);if(s.length){n="[\\"+s.join("\\")+"\\u0000-\\u001F]"}return n}})}),define("DS/ENONextGenFilterUX/views/VolumeView",["UWA/Core","UWA/Class/View","UWA/Class/Model","DS/ENONextGenFilterUX/utils/FilterUIService","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/Controls/Button","DS/Controls/LineEditor","css!DS/ENONextGenFilterUX/ENONextGenFilterUX.css","DS/Controls/TooltipModel","DS/UIKIT/DropdownMenu","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/PlatformAPI/PlatformAPI","DS/ENOFilterBIUX/NGFServices","DS/Menu/Menu"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_){"use strict";return t.extend({domEvents:{"click .innerVolumeFilterHeader":"_onVolumeSelected","click .innerVolumeFilter":"_onVolumeSelected"},tagName:"div",className:"attr-edit-inputs-Volume-Master",setup:function(t){this._filterSpecId=t.filterSpecId,this._volSetId=t.volSetId||0,this._idVol=t.idVol,this._volumeId="volume_"+this._filterSpecId+"-"+this._volSetId+"-"+this._idVol;var i=u.getCurrentUnit("Length");this._currentUnit={unit:i.unit||"mm",nls:i.nls||"mm",decimal:3},this._masterDiv=this.container,this._masterDiv.id=this._volumeId,this._volDiv=e.createElement("div",{class:"attr-edit-inputs-Attribute"}),this._volDiv.inject(this._masterDiv),this.container.addEvent("click",function(e){return e.stopPropagation(),!1}),this.listenTo(this.model,"onChange:isActivated",this._onActivateChange.bind(this)),this.listenTo(this.model,"onChange:state",this._onStateChange.bind(this)),this.listenTo(this.model,"onChange:displayName",this._onFilterNameChange.bind(this)),h.subscribe("onWidgetPreferenceModified",this._onWidgetPreferenceChange.bind(this))},render:function(){this._createVolumeUI();var t=e.createElement("div",{class:"volume-edit-command"});return t.inject(this._masterDiv),this._createVolumeCriterionCtxMenuWUX(t),this},getValues:function(){return{filterSpecId:this._filterSpecId,setId:this._volSetId,id:this.model.get("id"),displayName:this.model.get("displayName"),parameters:this.model.get("parameters")}},_createVolumeUI:function(){this.model.set("id",this._volumeId);var t=s.get("defaultVolumeName");t+="-"+(this._idVol+1),this.model.set("displayName",t),this._volumeUL=e.createElement("ul",{}),this._volumeUL.inject(this._volDiv),this._volumeName=e.createElement("label",{class:"innerVolumeFilterHeader",html:this.model.get("displayName"),id:"name_"+this._volumeId}),this._volumeName.inject(this._volumeUL),this._waitingForDiv=e.createElement("div",{class:"volume-edit-WaitingFor",id:"waitngForDiv_"+this._volumeId}),this._waitingForDiv.inject(this._volumeUL);var i=e.createElement("label",{class:"volume-edit-WaitingFor-Label",html:s.get("WaitingForVolumeSpecifications")+" (",id:"labelVolSpec1_"+this._volumeId});i.inject(this._waitingForDiv);var n=new r({touchMode:!0,displayStyle:"lite",label:s.get("CancelVolumeSpecifications"),id:"cancelVolSpec_"+this._volumeId});n.getContent().addClassName("filter-anchor-style"),n.inject(this._waitingForDiv),(i=e.createElement("label",{class:"volume-edit-WaitingFor-Label",html:")",id:"labelVolSpec2_"+this._volumeId})).inject(this._waitingForDiv);var o=this;n.addEventListener("buttonclick",function(e){o._cancelEditVolume()}),this._renameEditor=this._createRenameVolumeUI(this._volumeName),this._renameEditor.hide()},_onWidgetPreferenceChange:function(e){var t=JSON.parse(e);if("CATWebUXPreferences_UnitsAndDecimalPlace"===t.name){var i=t.value.Length;if(i&&this._currentUnit.unit!==i.unit){this._currentUnit.unit=i.unit||"mm",this._currentUnit.nls=u.Length[this._currentUnit.unit].nls||this._currentUnit.unit,this._currentUnit.decimal=i.decimalPlaceRO||3;var n=this.model.get("parameters");this._displayVolumeAsRead(n)}}},_onStateChange:function(e,t){var i=this;if("read"===t){var s=this.model.get("parameters");if(s){var o=s.type;if("proximity"===o||"space"===o)if(s.root_path_alias)this._displayVolumeAsRead(s);else{var r=s.root_path_physicalid[0];n.executeFetch(r,[],["ds6w:label","ds6wg:revision"]).then(function(e){var t=n.getAliasesFromFetched(r,e);s.root_path_alias=t,i._displayVolumeAsRead(s)})}else this._displayVolumeAsRead(s);n.isModelActivated(this.model)||this._switchCriterionState()}this._waitingForDiv.hide(),this._contextualMenuWUX=[],this._contextualMenuWUX.push(this._ctxMenuRead[0]),this._contextualMenuWUX.push(this._ctxMenuRead[1]),this._contextualMenuWUX.push(n.isModelActivated(this.model)?this._deactivateItem:this._activateItem),this._contextualMenuWUX.push(this._deleteItem)}else{for(var a=this._volumeUL.getElements("li"),l=a.length-1;l>=0;l--)a[l].addClassName("f-group-deactivated");this._waitingForDiv.show(),this._contextualMenuWUX=this._ctxMenuEdit}},_displayVolumeAsRead:function(t){for(var i=this._volumeUL.getElements("li"),n=i.length-1;n>=0;n--)i[n].remove(),i[n].removeClassName("f-group-deactivated");if(t){var o=s.get(t.type)+",  "+s.get(t.intersection_mode),r=e.createElement("li",{class:"innerVolumeFilter",text:o});r.inject(this._waitingForDiv,"before");var a=" "+this._currentUnit.nls;t.transformation_matrix&&t.transformation_matrix;switch(t.type){case"box":var l=[parseFloat(t.transformation_matrix[9]),parseFloat(t.transformation_matrix[10]),parseFloat(t.transformation_matrix[11])],d=this._currentUnit.decimal,c=[(parseFloat(t.corner_max[0])+l[0]).toFixed(d),(parseFloat(t.corner_max[1])+l[1]).toFixed(d),(parseFloat(t.corner_max[2])+l[2]).toFixed(d)];(r=e.createElement("li",{class:"innerVolumeFilter",text:s.get("corner_min")+this._convertValue(l).join(a+", ")+a})).inject(this._waitingForDiv,"before"),(r=e.createElement("li",{class:"innerVolumeFilter",text:s.get("corner_max")+this._convertValue(c).join(a+", ")+a})).inject(this._waitingForDiv,"before");break;case"sphere":(r=e.createElement("li",{class:"innerVolumeFilter",text:s.get("center")+this._convertValue(t.center).join(a+", ")+a})).inject(this._waitingForDiv,"before"),(r=e.createElement("li",{class:"innerVolumeFilter",text:s.get("radius")+this._convertValue(t.radius)+a})).inject(this._waitingForDiv,"before");break;case"proximity":var u=" ...";if(t.root_path_alias){var h=t.root_path_alias.length;u=t.root_path_alias[h-1]||" ..."}(r=e.createElement("li",{class:"innerVolumeFilter volume-li-reference",text:s.get("reference")})).inject(this._waitingForDiv,"before");var p=e.createElement("div",{});e.createElement("label",{class:"innerVolumeFilter volume-li-reference-alias",html:u}).inject(p),p.inject(r),(r=e.createElement("li",{class:"innerVolumeFilter",text:s.get("distance")+this._convertValue(t.distance)+a})).inject(this._waitingForDiv,"before");break;case"space":u=" ...";if(t.root_path_alias){h=t.root_path_alias.length;u=t.root_path_alias[h-1]||" ..."}(r=e.createElement("li",{class:"innerVolumeFilter volume-li-reference",text:s.get("reference")})).inject(this._waitingForDiv,"before");p=e.createElement("div",{});e.createElement("label",{class:"innerVolumeFilter volume-li-reference-alias",html:u}).inject(p),p.inject(r),t.maybe3d&&(r=e.createElement("li",{class:"innerVolumeFilter",text:s.get("maybe3d")+t.maybe3d})).inject(this._waitingForDiv,"before")}}},_convertValue:function(e){var t,i=this._currentUnit.unit,n=this._currentUnit.decimal;if(Array.isArray(e))t=[],e.forEach(function(e){var s=u.convert(Number(e),"Length","mm",i);t.push(s.toFixed(n))});else{var s=u.convert(Number(e),"Length","mm",i);t=s.toFixed(n)}return t},_onVolumeSelected:function(){this.dispatchEvent("NGF_VolumeSelected",{filterSpecId:this._filterSpecId,setId:this._volSetId,id:this.model.get("id"),displayName:this.model.get("displayName"),parameters:this.model.get("parameters")}),this.model.set("state","edit")},isEmpty:function(){return!this.model.get("parameters")},setFocus:function(){},showAddButtons:function(e){},showRemoveButton:function(e){},_createVolumeCriterionCtxMenuWUX:function(t){var i=e.createElement("span",{});i.addClassName("fonticon fonticon-chevron-down volume-ctx-menu"),i.addClassName("attribute-edit-remove-btn"),i.inject(t),this._activateItem={type:"PushItem",recId:"volume-activate-item-DDCtx",title:s.get("activatedCriteria"),icon:n.getIconByName("eye"),action:{this:this,callback:this._switchCriterionState}},this._deactivateItem={type:"PushItem",recId:"volume-activate-item-DDCtx",title:s.get("deactivatedCriteria"),icon:n.getIconByName("eye-off"),action:{this:this,callback:this._switchCriterionState}},this._deleteItem={type:"PushItem",recId:"volume-delete-item-DDCtx",title:s.get("deleteCriteria"),icon:n.getIconByName("close"),action:{this:this,callback:this._removeVolume}},this._ctxMenuRead=[{type:"PushItem",recId:"volume-edit-item-DDCtx",title:s.get("editCriteria"),icon:n.getIconByName("pencil"),action:{this:this,callback:this._onVolumeSelected}},{type:"PushItem",recId:"volume-rename-item-DDCtx",title:s.get("renameVolume"),icon:n.getIconByName("rename"),action:{this:this,callback:this._renameVolume}},this._deactivateItem,this._deleteItem],this._ctxMenuEdit=[{type:"PushItem",recId:"volume-cancel-item-DDCtx",title:s.get("cancelEdit"),icon:n.getIconByName("undo"),action:{this:this,callback:this._cancelEditVolume}},this._deleteItem],this._contextualMenuWUX=this._ctxMenuRead;var o=this;i.addEventListener("click",function(e){var t=e.target.getBoundingClientRect();_.show(o._contextualMenuWUX,{position:{x:t.left,y:t.bottom}})})},_renameVolume:function(){this._volumeName.hide(),this._renameEditor.show(),this._renameEditor._giveFocus()},_cancelEditVolume:function(){this.model.set("state","read"),this.model.get("parameters")||this._removeVolume({volId:this._volumeId})},_removeVolume:function(){this.dispatchEvent("NGF_RemoveVolume",{volId:this._volumeId})},_switchCriterionState:function(){var e=n.isModelActivated(this.model)?"0":"1";this.model.set("isActivated",e)},_onActivateChange:function(e,t){n.isModelActivated(this.model);var i=this._contextualMenuWUX.findIndex(e=>"volume-activate-item-DDCtx"===e.recId);-1!==i&&(this._contextualMenuWUX[i]=n.isModelActivated(this.model)?this._deactivateItem:this._activateItem);var s=this.getContent();"1"===t?s.removeClassName("f-criterion-deactivated"):s.addClassName("f-criterion-deactivated")},_onFilterNameChange:function(){this._volumeName&&this._volumeName.setHTML(this.model.get("displayName"))},_createRenameVolumeUI:function(e){var t=new a({touchMode:!0,class:"innerVolumeFilterHeader",placeholder:s.get("placeHolderVolumeName"),domId:"rename_"+this._volumeId});t.value=this.model.get("displayName"),t.inject(e,"after");var i=this;t.addEventListener("focus",function(e){e.target.value=i.model.get("displayName")});var n=function(e){e.target.hide(),""!==e.dsModel.value&&i.model.set("displayName",e.dsModel.value),i._volumeName.show()};return t.addEventListener("change",n),t.addEventListener("blur",n),t},volumeViewFromMdl:function(e){this.model.set("displayName",e.displayName),e.parameters&&e.parameters.isRepaired&&(delete e.parameters.isRepaired,this.model.set("state","edit")),this.model.set("parameters",e.parameters),this.model.set("state","read"),"0"===e.isActivated&&this._switchCriterionState()}})}),define("DS/ENONextGenFilterUX/views/AttributeView",["UWA/Core","UWA/Class/View","UWA/Class/Model","UWA/Date","DS/Controls/DatePicker","DS/ENONextGenFilterUX/utils/FilterUIService","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/ENONextGenFilterUX/utils/AttributeChecker","DS/Controls/ComboBox","DS/Controls/LineEditor","DS/Controls/SpinBox","DS/Controls/Button","css!DS/ENONextGenFilterUX/ENONextGenFilterUX.css","DS/Controls/TooltipModel","DS/ENOFilterBIUX/FBISettings","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/WUXAutoComplete/AutoComplete","DS/ENONextGenFilterUX/utils/EditToReadManager","DS/ENOFilterBIUX/NGFServices"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,f,m,g,v,b,C){"use strict";return t.extend({domEvents:{},tagName:"div",className:"attr-edit-inputs-Attribute-Master",setup:function(e){this._widgetId=e.widgetId,this.idAttr=e.idAttr,this.selectedType=e.selectedType,this.selectedExtension=e.selectedExtension,this.attributes=e.xAttributes,this.model.set("attrSetId",e.attrSetId),this._isMultiSelActivated=f.getOption("attribute_MultiSelOnValue")||0,this._maxSuggestedValue=f.getOption("attribute_MaxSuggestedValue")||100,this._maxSuggestedValue=Number.MAX_VALUE,this._displayTimeInDate=!!o.isTimeInDateActivated(),this._iconHistoryValue="navigation-history",this._iconCustoValue="pencil",this._updateMRUMode=0,this._mruPropertyAttributes="attributes",this._mruPropertySearchEditor="searchEditor",this._separatorMRU={labelItem:"",iconItem:{iconName:"list"}},this.displayRemoveButton=e.displayRemoveButton,this._disableAddGroupButton=e.disableAddGroupButton,this._lastSelectedIndex=-1,this._attrDiv=this.getContent(),this._attrDiv.id=this._getId(),o.TOUCH_MODE?this._attrDiv.removeClassName(o.FILTER_TOUCH_CLASSNAME):this._attrDiv.addClassName(o.FILTER_TOUCH_CLASSNAME),this.container.addEvent("click",function(e){return e.stopPropagation(),!1}),this._isAttrBeingEdited=!1,this._isOperatorBeingEdited=!1,this._hierarchicalItems=[],this._isHierachicalTag=0},render:function(){o.isEasyAttributeDisplayMode()&&this.getContent().setAttribute("filter-easy-attribute",""),this._cmdDiv=e.createElement("div",{class:"attribute-edit-command"}),this._cmdDiv.inject(this._attrDiv);var t=this._cmdDiv;return this.selectedType&&this.attributes&&this._createAttributeUI(),o.TOUCH_MODE?t.removeClassName(o.FILTER_TOUCH_CLASSNAME):t.addClassName(o.FILTER_TOUCH_CLASSNAME),this._addAttributeBtn=this._createAddAttributeButton(t),this.displayAddButtons||this._addAttributeBtn.hide(),this._addAttributeGroupBtn=this._createAddAttributeGroupButton(t),this.displayAddGroupButtons||this._addAttributeGroupBtn.hide(),this._addAttributeGroupBtn.disabled=!!this._disableAddGroupButton,this._addAttributeGroupBtn.active=!this._addAttributeGroupBtn.disabled,this._removeAttributeBtn=this._createRemoveAttributeButton(t),this.displayRemoveButton,this},_getId:function(e){return"attribute_"+(void 0===e?this.idAttr:e)},_cleanAttributes:function(){this.attributeCombo&&this.attributeCombo.elements&&(this.attributeCombo.elements.container.remove(),delete this.attributeCombo,this._anyObjectAttrType&&this._anyObjectAttrTypeAnchor.setText(""),this._cleanOperator())},_cleanOperator:function(){this.opCombo&&this.opCombo.elements&&(this.opCombo.elements.container.remove(),delete this.opCombo,this._anyObjectAttrOp&&this._anyObjectAttrOpAnchor.setText(""),this._cleanAttrValuation())},_createAttributeUI:function(){var e=this;e._cleanAttributes(),e.attributeCombo=e._buildAndFeedCombo("attribute",e.attributes,e.idAttr),C.isActivated("easyAttribute")&&!e._anyObjectAttrType&&(e._anyObjectAttrType=e._buildEasyUI("type",e.attributeCombo.currentLabel,e.attributeCombo),e._anyObjectAttrTypeAnchor=e._anyObjectAttrType,o.isEasyAttributeDisplayMode()&&!1!==e._isAttrBeingEdited||e._anyObjectAttrType.hide()),e.attributeCombo.addEventListener("change",function(t){if(e._badCharInValue&&(e._badCharInValue.remove(),e._badCharInValue=void 0),1!==e._getMRUMode()){var i=e.attributeCombo.elementsList[t.dsModel.selectedIndex];if(i&&e._separatorMRU.labelItem===i.labelItem&&e._separatorMRU.iconItem.iconName===i.iconItem.iconName)e._setMRUMode(1),e.attributeCombo.selectedIndex=e._lastSelectedIndex,e._setMRUMode(0);else{e._lastSelectedIndex=t.dsModel.selectedIndex;var n=t.dsModel.currentLabel,s=e.keepAttrInfosFromLabel[n];if(s){if(!e.model.get("attribute")){var r=s.rangeValues?s.rangeValues.literalInfo:void 0,a=r&&r.length?" / enum":"";C.setUsageTracker(e._widgetId,"NGF-Attribute-Type",s.type+a)}e.model.set("attribute",s),e.model.set("nlsAttribute",n),o.isEasyAttributeDisplayMode()&&!1===e._isAttrBeingEdited&&(t.target.hide(),e._anyObjectAttrType&&e._anyObjectAttrTypeAnchor.show()),e._anyObjectAttrType&&e._anyObjectAttrTypeAnchor.setText(n),e.buildAttrOperator(n,s),e.dispatchEvent("NGF_AttributeSelected",{attrSetId:e._attrSetId})}else e._cleanOperator(),e.model.set("attribute",""),e.model.set("nlsAttribute",""),e.attributeCombo.selectedIndex=-1}}})},buildAttrOperator:function(e,t){var i=this,n=t.type,s=t.rangeValues||[];this._cleanOperator(),this.opCombo=l.getAttributeOperators(this.model,t),this.opCombo.inject(this._cmdDiv,"before"),this.opCombo.getContent().addClassName("filter-anyobject-off");var r=this.opCombo.currentValue,a=this.opCombo.currentLabel;(this._anyObjectAttrOp?this._anyObjectAttrOpAnchor.setText(a):C.isActivated("easyAttribute")&&(this._anyObjectAttrOp=this._buildEasyUI("operator",a,this.opCombo),this._anyObjectAttrOpAnchor=this._anyObjectAttrOp,o.isEasyAttributeDisplayMode()||this._anyObjectAttrOp.hide()),o.isEasyAttributeDisplayMode())&&(!0===this._isOperatorBeingEdited?this._anyObjectAttrOp:this.opCombo).hide();return r&&(this.model.set("attrOp",r),this.model.set("nlsAttrOp",a),this._buildAttrValue(n,s,r,!0)),this.opCombo.addEventListener("change",function(e){var t=i.model.get("attrOp"),o=e.dsModel.currentValue,r=e.dsModel.currentLabel;i.model.set("attrOp",o),i.model.set("nlsAttrOp",r),i._anyObjectAttrOp&&i._anyObjectAttrOpAnchor.setText(r);var a=!1;"between"!==t&&"between"===o?a=!0:"between"===t&&"between"!==o&&(a=!0),i._buildAttrValue(n,s,o,a,void 0)}),this.opCombo},_cleanAttrValuation:function(){var e=this._attrDiv,t=[];this.attrValuation?t=["attrValue"]:this.attrValuation1&&(t=["attrValue_1","attrValue_2"]);var i=this;t.forEach(function(t){var n="#"+t,s=i.getContent().getElement(n);if(s){try{e.removeChild(s)}catch(t){t.message;try{e.removeChild(s)}catch(e){e.message}}i.model.set(t,void 0)}}),this.attrValuation=null,this.attrValuation1=null,this.attrValuation2=null,this._anyObjectAttrValue&&this._anyObjectAttrValueAnchor.setText("")},_buildAttrValue:function(e,t,i,n,s){var a=this;if(-1!==["isEmpty","isNotEmpty"].indexOf(i))this.attrValuation?this.attrValuation.getContent().hide():this.attrValuation1&&(this.attrValuation1.getContent().hide(),this.attrValuation2.getContent().hide()),this._EmptyOperator=!0;else if(this._EmptyOperator&&(this._EmtyOperator=!1,n=!0),void 0===n||n){switch(this._cleanAttrValuation(),e){case"string":if(0===a._isEnumeration(t,s))if(o.isSearchEditorForAllActive()){var l=t;Array.isArray(t)&&(l={editable:!0,literalInfo:t}),this.attrValuation=this._buildEnumComboBox(e,"attrValue",l,s)}else{this.attrValuation=new c({touchMode:o.TOUCH_MODE,placeholder:r.get("placeHolderAttrValue"),domId:"attrValue"}),this.attrValuation.inject(this._cmdDiv,"before"),s&&(this.attrValuation.value=s,this.model.set("attrValue",s));var d=(l=t.literalInfo?t.literalInfo:t)?l.length:0;this._maxSuggestedValue<d&&this.attrValuation.getContent().addClassName("max-suggested-value"),this.attrValuation.addEventListener("change",function(e){var t=void 0!==e.dsModel.value?e.dsModel.value:e.dsModel.currentValue;t=void 0!==t?t:void 0,a.model.set("attrValue",t)}),this.attrValuation.addEventListener("uncommittedChange",function(t){var i=t.dsModel.valueToCommit;if(void 0!==i){var n=a.opCombo.currentValue;a._checkForbiddenCharacter(e,n,i)}})}else this.attrValuation=this._buildEnumComboBox(e,"attrValue",t,s);break;case"boolean":this.attrValuation=this._buildEnumComboBox(e,"attrValue",t,s);break;case"integer":case"real":-1!==i.indexOf("between")?(this.attrValuation1=this._buildNumSection(e,"attrValue_1",t,s?s[0]:void 0),this.attrValuation2=this._buildNumSection(e,"attrValue_2",t,s?s[1]:void 0)):this.attrValuation=this._buildNumSection(e,"attrValue",t,s);break;case"dateTime":case"timestamp":this._displayTimeInDate=!o.isTimeInDateActivated()||"on"!==i,"between"===i?(this.attrValuation1=this._buildDateSection("attrValue_1",i,s?s[0]:void 0),this.attrValuation2=this._buildDateSection("attrValue_2",i,s?s[1]:void 0)):this.attrValuation=this._buildDateSection("attrValue",i,s)}this.attrValuation?(this.attrValuation.getContent().addClassName("filter-anyobject-off"),o.isEasyAttributeDisplayMode()&&this.attrValuation.getContent().focus()):this.attrValuation1&&(this.attrValuation1.getContent().addClassName("filter-anyobject-off"),this.attrValuation2.getContent().addClassName("filter-anyobject-off"),o.isEasyAttributeDisplayMode()&&this.attrValuation1.getContent().focus())}else switch(e){case"string":if(0===a._isEnumeration(t,s)){i=a.opCombo.currentValue;var u=a.attrValuation.value;a._checkForbiddenCharacter(e,i,u)}break;case"dateTime":case"timestamp":this._cleanAttrValuation(),this._displayTimeInDate=!o.isTimeInDateActivated()||"on"!==i,"between"===i?(this.attrValuation1=this._buildDateSection("attrValue_1",i,s?s[0]:this._currentDateTime),this.attrValuation2=this._buildDateSection("attrValue_2",i,s?s[1]:this._currentDateTime)):this.attrValuation=this._buildDateSection("attrValue",i,s||this._currentDateTime)}},_isEnumeration:function(e,t){var i=e.literalInfo?e.literalInfo:e,n=i?i.length:0,s=0;return 0===(this._maxSuggestedValue>=n?0:1)&&(s=0===n?t&&Array.isArray(t)?1:s:1),s},_checkForbiddenCharacter:function(t,i,n){for(var s=l.getForbiddenCharacterAsRegExp(t,i),o=Array.isArray(n)?n:[n||""],a=o.length,d=!1,c=0;c<a;c++)"string"==typeof o[c]&&(d=d||o[c].match(s));if(d){this.attrValuation.getContent().addClassName("attr-edit-inputs-Attribute-Error");var u=l.getForbiddenCharacter(t,i).join(" "),h="<p>"+r.get("BadCharacters")+": "+u+"</p>";this._badCharInValue?(this._badCharInValue.setHTML(h),this._badCharInValue.show()):this._badCharInValue=new e.Element("div",{class:"attr-edit-inputs-Attribute-Error-BadCharacter",html:h}).inject(this.getContent(),"after")}else this.attrValuation&&this.attrValuation.getContent().removeClassName("attr-edit-inputs-Attribute-Error"),this._badCharInValue&&this._badCharInValue.hide();return!!d},_resetTimeOfDate:function(e){var t=new Date(e);return t.setHours(0,0,0,0),t},_buildDateSection:function(e,t,i){var r,a=this;r=i?new n(n.parse(i)):this._resetTimeOfDate(new Date(Date.now()));var l=new s({touchMode:o.TOUCH_MODE,domId:e,timePickerFlag:this._displayTimeInDate,timePickerPrecision:"sec",value:r});function d(t,i){var n;a._currentDateTime=i,n=o.isTimeInDateActivated()&&"on"!==t?(n=a._currentDateTime.toISOString()).substring(0,n.lastIndexOf("."))+"Z":a._currentDateTime.strftime("%F"),a.model.set(e,n)}return l.inject(this._cmdDiv,"before"),d(t,l.value),l.getContent().addEventListener("change",function(e){d(a.opCombo?a.opCombo.value:"on",e.dsModel.value)}),l},_buildNumSection:function(e,t,i,n){var s;if(0===this._isEnumeration(i,n)){(s=new u({touchMode:o.TOUCH_MODE,domId:t,value:0,stepValue:1,decimals:"integer"===e?0:8,pageStepValue:1})).inject(this._cmdDiv,"before");var r=this;s.addEventListener("change",function(e){var i=void 0!==e.dsModel.value?e.dsModel.value:e.dsModel.currentValue;i=void 0!==i?i:void 0,r.model.set(t,i)}),n&&(s.value=n),this.model.set(t,s.value)}else s=this._buildEnumComboBox(e,t,i,n);return s},_buildAndFeedCombo:function(e,t,i){var n=this._buildAttributesComboItems(t),s=new d({domId:"attrType",touchMode:o.TOUCH_MODE,elementsList:n.items,preselectedIndex:n.indexToSelect,placeholder:UWA.String.format(r.get("placeHolderSelectEntity"),r.get(e)),autocompleteFlag:!1,generateRegexpString:function(e){return e}});return s.inject(this._cmdDiv,"before"),s.getContent().addClassName("filter-anyobject-off"),s},_alphabeticSort:function(e,t){var i=0;return void 0!==e&&void 0!==t&&(i=e.labelItem<=t.labelItem?-1:1),i},destroy:function(){this.stopListening(),this.model=null,this._parent(),this.container=null},_buildEnumComboBox:function(e,t,i,n){var s=[],a=!1,l=!1,c=!!o.isSearchEditorActive();"boolean"!==e||void 0!==i&&0!==i.length?(this._isHierachicalTag=0,(T=i.literalInfo?i.literalInfo:i).forEach(t=>{var i;Array.isArray(t.value)&&0===t.isAggregate?(i=t.value.join("/"),this._isHierachicalTag=1):(i=t.value,"integer"!==e&&"real"!==e||(i=Number.isNaN(Number(i))?o.ATTRIBUTE_NOT_VALUATED:Number(i)));var n=t.nlsValue||t.nlsvalue||i,r={valueItem:i,labelItem:Array.isArray(n)?n.join("/"):n};s.push(r)}),a=i.editable||!1,1===f.getOption("attribute_MultiSelOnValue")&&this.opCombo&&"between"!==this.opCombo.currentValue&&(a=!(l=1<s.length)&&a)):(s=[{labelItem:r.get("true"),valueItem:"true"},{labelItem:r.get("false"),valueItem:"false"}],a=!0,c=!1);var u,h=this,p=a?r.get("placeHolderAttrValue"):r.get("placeHolderSelectAttrValue");if(c&&"string"===e){var _=new m({}),b=[],C=this._getMRUProperty(this._mruPropertySearchEditor);if(C&&(C.reverse(),C.forEach(function(e){var t=new g({label:e.label,value:e.value,icons:[{iconName:h._iconHistoryValue}],grid:{label:e.label,value:e.value}});b.push(t)})),1===h._isHierachicalTag){function y(e,t,i){var n=[];if(e.children.length>0)for(var s=0;s<e.children.length;s++){var o=t+"/"+e.children[s].name;N.push(e.children[s].name),w.push(o),n[s]=new g({label:e.children[s].name,value:o,grid:{label:e.children[s].name,value:o}}),i.addChild(n[s]),h._hierarchicalItems.push(o),y(e.children[s],o,n[s])}}for(var A=[],F=0;F<s.length;F++){var I=[],S=(s[F].labelItem.split("/"),s[F].valueItem.split("/"));A.push(S)}for(var E=h._arrangeIntoTree(A),N=[],w=[],x=0;x<E.length;x++)N.push(E[x].name),w.push(E[x].name),h._hierarchicalItems.push(E[x].name),I[x]=new g({label:E[x].name,value:E[x].name,grid:{label:E[x].name,value:E[x].name}}),E[x].children.length>0&&y(E[x],E[x].name,I[x]),b.push(I[x])}else for(F=0;F<s.length;F++){var V=new g({label:s[F].labelItem,value:s[F].valueItem,grid:{label:s[F].labelItem,value:s[F].valueItem}});b.push(V)}_.prepareUpdate(),b.forEach(function(e){1===h._isHierachicalTag?_.addRoot(e):_.addChild(e)}),_.pushUpdate();p=a?r.get("placeHolderEnterOrSelectAttrValue"):p,(u=1===h._isHierachicalTag?new v({touchMode:o.TOUCH_MODE,domId:t,placeholder:p,multiSearchMode:!0,elementsTree:_,filterCB:e=>{u.filterItems(e,{filterId:"stringRegexp",filterOptions:{ensureVisible:!0,keepChildren:!0}})},getChipInfo:function(e){let t=e.getAttributeValue("value");return void 0===t&&(t=this.getDefaultChipInfo(e).label),{label:t}},displayCustomNodeInDropDown:!0}):new v({touchMode:o.TOUCH_MODE,domId:t,placeholder:p,multiSearchMode:!0,elementsTree:_,displayCustomNodeInDropDown:!0})).getContent().addClassName("attribute-edit-combo-enum-SearchEditor"),u.inject(this._cmdDiv,"before"),o.TOUCH_MODE?u.getContent().removeClassName("filter-no-touch-mode-no-height"):u.getContent().addClassName("filter-no-touch-mode-no-height"),u.addEventListener("change",function(i){var n=[],s=i.dsModel.elementsTree;if(s){var o=s.getRoots(),r=o.findIndex(function(e){var t=e.getIcons();return!t.length||h._iconHistoryValue!==t[0].iconName});i.dsModel.selectedItems.forEach(function(t){var i=t.getAttributeValue("label"),a=t.getAttributeValue("value");1===h._isHierachicalTag&&void 0!==a&&(i=a);var l,d=0;if(h._checkForbiddenCharacter(e,h.opCombo.currentValue,i))(l=t).setAttribute("value",i);else{var c=-1===r?0:r,u=0;if(1!==h._isHierachicalTag){for(var p=u=c;p<o.length;p++)if(o[p].getAttributeValue("label")===i){l=o[p];break}}else for(p=u;p<h._hierarchicalItems.length;p++)if(void 0!==a){if(h._hierarchicalItems[p]===a){l=t,d=1;break}}else if(h._hierarchicalItems[p]===i){l=t;break}if(!l){for(p=0;p<r;p++)if(o[p].getAttributeValue("label")===i){l=o[p];break}var _;if(l)_=l,l=new g({label:i,value:i,icons:[{iconName:h._iconCustoValue}],grid:{label:i,value:i}});else{(l=t).setIcons([{iconName:h._iconCustoValue}]);var f=l.getLabel();void 0!==a?(l.setAttribute("label",a),l.setAttribute("value",a)):(l.setAttribute("label",f),l.setAttribute("value",f))}_&&_.unselect(),1===h._isHierachicalTag?void 0!==a?h._hierarchicalItems.push(f):h._hierarchicalItems.push(l.getAttributeValue("value")):s.insertBefore(l,o[r]),l.select(!1),delete l.options.customNode}}var m="";m=1===d&&void 0!==a?a:l.getAttributeValue("value"),n.push(m)})}h.model.set(t,n)})}else(u=new d({domId:t,touchMode:o.TOUCH_MODE,placeholder:p,elementsList:s,enableSearchFlag:a,autocompleteFlag:!1,multiSelFlag:l,_validateOnBlurForTMCAndFilterApp:!0})).inject(this._cmdDiv,"before"),a&&(u.generateRegexpString=function(e){return e}),l&&u.getContent().addClassName("attribute-edit-combo-enum"),u.addEventListener("change",function(i){var n=void 0!==i.dsModel.value?i.dsModel.value:i.dsModel.currentValue;n=void 0!==n?n:void 0;h._checkForbiddenCharacter(e,h.opCombo.currentValue,n);h.model.set(t,n)});if(n)if(c&&"string"===e){var T=(i=this.model.get("attribute").rangeValues||[]).literalInfo?i.literalInfo:i,D=[];(Array.isArray(n)?n:[n]).forEach(function(e){var t=T.find(function(t){return t.isAggregate&&Array.isArray(e)?e.sort().toString()===t.value.sort().toString():e===t.value});t?D.push(t.nlsValue||t.nlsvalue):D.push(e)});var O=u.elementsTree,U=O.getRoots(),G=U.findIndex(function(e){var t=e.getIcons();return!t.length||h._iconHistoryValue!==t[0].iconName});O.prepareUpdate(),D.forEach(function(e){var t=U.find(function(t,i){return G<=i&&t.getAttributeValue("label")===e});t||(t=U.find(function(t,i){return G>i&&t.getAttributeValue("label")===e}))||(t=new g({label:e,value:e,icons:[{iconName:h._iconCustoValue}],grid:{label:e,value:e}}),O.insertBefore(t,U[G])),t.select(!1)}),O.pushUpdate()}else u.value=l?Array.isArray(n)?n:[n]:Array.isArray(n)&&n.length?n[0]:n;return u},_setMRUMode:function(e){this._updateMRUMode=e||0,this._updateMRUMode=0!==this._updateMRUMode?1:0},_getMRUMode:function(){return this._updateMRUMode},_updateMRU:function(){var e=this.selectedType||"",t=this.model.get("nlsAttribute")||"";if(0!==e.length&&0!==t.length){var i=this.model.get("attribute")?this.model.get("attribute").value:"",n={label:t.length?t:i,value:i};this._updateMRUProperty(this._mruPropertyAttributes,n,o.MAX_MRU_VALUE);var s=this.model.get("attribute"),r=this.attrValuation?this.attrValuation.elementsTree:"";if(o.isSearchEditorActive()&&"string"===s.type&&r){var a=s.rangeValues||[],l=a.literalInfo?a.literalInfo:a,d=this.model.get("attrValue")||[];d=Array.isArray(d)?d:[d];var c=[];d.forEach(function(e){var t=l.find(function(t){return e.toString()===t.value.toString()});c.push({label:t?t.nlsvalue||t.nlsValue:e,value:e})}),this._updateMRUProperty(this._mruPropertySearchEditor,c,o.MAX_MRU_VALUE)}}},_updateMRUProperty:function(e,t,i){for(var n=Array.isArray(t)?t:[t],s=this._getMRUProperty(e),o=s,r=n?n.length:0,a=0;a<r;a++){var l=s.findIndex(function(e){var t=n[a].value,i=e.value;return t&&i?t.toString()===i.toString():t===i});if(-1===l){var d={label:n[a].label?n[a].label:n[a].value,value:n[a].value};o.push(d),o.length>i&&o.shift()}else o.push(s[l]),o.splice(l,1)}this._setMRUProperty(e,o)},_getMRUProperty:function(e){var t,i=(JSON.parse(window.localStorage.getItem("NGF_Most-Recent-Used"))||{})[this.selectedType+"_"+(this.selectedExtension?this.selectedExtension:"NoExtension")]||{};if(this._mruPropertyAttributes===e)t=i.attributes||[];else if(this._mruPropertySearchEditor===e){t=(i.searchEditor||{})[this.getAttrParam().name]||[]}return t},_setMRUProperty:function(e,t){var i="NGF_Most-Recent-Used",n=JSON.parse(window.localStorage.getItem(i))||{},s=this.selectedType+"_"+(this.selectedExtension?this.selectedExtension:"NoExtension"),o=n[s]||{};if(this._mruPropertyAttributes===e)o[e]=t;else if(this._mruPropertySearchEditor===e){var r=this.getAttrParam().name;o[e]||(o[e]={});var a=o[e];a[r]||(a[r]={}),a[r]=t}n[s]=o,window.localStorage.setItem(i,JSON.stringify(n))},updateMRUOfAttrCombo:function(){var e=this;if(0!==(this.selectedType||"").length&&this.attributeCombo){for(var t=this.attributeCombo.elementsList.slice(),i=-1!==this.attributeCombo.selectedIndex?t[this.attributeCombo.selectedIndex]:"",n=-1,s=this._separatorMRU.labelItem,r=this._separatorMRU.iconItem.iconName,a=0;a<o.MAX_MRU_VALUE+1;a++)if(a<t.length&&s===t[a].labelItem&&r===t[a].iconItem.iconName){n=a;break}var l=this._getMRUProperty(this._mruPropertyAttributes);for(a=0;a<l.length;a++){var d={labelItem:l[a].label,iconItem:{iconName:this._iconHistoryValue}};t.unshift(d)}0<n&&t.splice(l.length,n),this._setMRUMode(1),this.attributeCombo.elementsList=t;var c=-1;for(a=0;a<t.length;a++)if(i.labelItem===t[a].labelItem){c=a;break}this.attributeCombo.selectedIndex=c;var u=this.getAttrParam(),h=this.attrValuation?this.attrValuation.elementsTree:"";if(o.isSearchEditorActive()&&"string"===u.type&&h){var p=this._getMRUProperty(this._mruPropertySearchEditor);if(p){var _=this.model.get("attrValue");_=Array.isArray(_)?_:[_];var f=this.attrValuation.elementsTree,m=f.getRoots();f.prepareUpdate();var v=-1,b=-1;m.forEach(function(t,i){var n=t.getIcons();v=n.length&&e._iconHistoryValue===n[0].iconName?i:v,b=n.length&&e._iconCustoValue===n[0].iconName?i:b}),b=v;for(a=Math.max(v,b);a>=0;a--)f.removeRoot(m[a]);this.attrValuation.selectedItems=[],p.forEach(function(t){var i=new g({label:t.label,value:t.value,icons:[{iconName:e._iconHistoryValue}],grid:{label:t.label,value:t.value}});f.addChild(i,0)}),f.unselectAll(),m=f.getRoots(),_.forEach(function(e){var t=m.findIndex(t=>e===t.getAttributeValue("value"));-1!==t&&m[t].select(!1)}),f.pushUpdate()}}}this._setMRUMode(0)},_checkBounds:function(){var e=!0;if(this.model.get("attrValue"));else if(this.model.get("attrValue_1")){var t=this.model.get("attrValue_1")||this.attrValuation1.value,i=this.model.get("attrValue_2")||this.attrValuation2.value;switch(this.model.get("attribute").type){case"string":break;case"integer":case"real":parseFloat(i)<parseFloat(t)&&(e=!1);break;case"dateTime":case"timestamp":new n(i).getTime()<new Date(t).getTime()&&(e=!1)}e||(this.attrValuation1.value=i,this.attrValuation2.value=t,e=!0)}return e},_createAddAttributeButton:function(e){var t=new h(o.getAttributeButtonStyle("plus"));t.inject(e||this._attrDiv),t.tooltipInfos=new _({shortHelp:r.get("AddAttribute"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attribute-edit-add-btn");var n=this;return t.addEventListener("click",function(e){n.dispatchEvent("NGF_AddAttribute",{})}),t},_createAddAttributeGroupButton:function(e){var t=new h(o.getAttributeButtonStyle("group-add"));t.inject(e||this._attrDiv),t.tooltipInfos=new _({shortHelp:r.get("AddAttributeGroup"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attribute-edit-addGroup-btn");var n=this;return t.addEventListener("click",function(e){n._disableAddGroupButton||n.dispatchEvent("NGF_AddAttributeGroup",{})}),t},_createRemoveAttributeButton:function(e){var t=new h(o.getAttributeButtonStyle("close"));t.inject(e||this._attrDiv),t.tooltipInfos=new _({shortHelp:r.get("RemoveAttribute"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attribute-edit-remove-btn");var n=this;return t.addEventListener("click",function(e){n._badCharInValue&&(n._badCharInValue.remove(),n._badCharInValue=void 0),n.dispatchEvent("NGF_RemoveAttribute",{attrId:n._getId(),idx:n.idAttr})}),t},attrViewFromMdl:function(e){var t="";if("object"==typeof e){var i=e.attribute?e.attribute.uri:e.uri;if(this.attributeCombo){var n=this.keepAttrInfosFromName[i];this.attributeCombo.currentValue=n||"",t=n?t:i}this.opCombo&&e.attrOp&&(this.opCombo.currentValue=e.attrOp);var s=o.ATTRIBUTE_NOT_VALUATED;this.attrValuation&&e.attrValue?s!==e.attrValue&&(this.attrValuation.value=Array.isArray(e.attrValue)&&1===e.attrValue.length?e.attrValue[0]:e.attrValue):this.attrValuation1&&e.attrValue_1||this.attrValuation2&&e.attrValue_2?void 0===this.attrValuation1.value&&void 0===this.attrValuation2.value||(this.attrValuation1&&e.attrValue_1&&s!==e.attrValue_1&&(this.attrValuation1.value=e.attrValue_1),this.attrValuation2&&e.attrValue_2&&s!==e.attrValue_2&&(this.attrValuation2.value=e.attrValue_2)):!this.opCombo||this.opCombo&&"between"!==this.opCombo.currentValue?this.attrValuation&&(this.attrValuation.value=void 0):this.attrValuation1&&(this.attrValuation1.value=void 0,this.attrValuation2.value=void 0)}return t},isAttrValid:function(){for(var e="",t="",i=this.getAttrParam(),n=!1,s=i.values.length,a=r.get("InvalidCharInLabel"),d=0;d<s;d++){var c=Array.isArray(i.values[d])?i.values[d].join(""):i.values[d],u=l.checkOperatorAndValue(i.type,i.op,c,i.synthesisValue);if(!u.isValid){e="InvalidCharInValue",t="' "+u.forbidden+" '  "+a+"  "+i.nlsName+" "+i.nlsOp+" "+i.values[0],n=!0;break}}var h=this._checkBounds();h||("boolean"===i.type?(e="badValueDefinedForBoolean",t=i.nlsName+" "+i.nlsOp+" "+i.values[0]):(e="badValueDefined",t=i.nlsName+" "+i.nlsOp+" "+i.values[0]+" "+i.values[1]));var p={isValid:!n&&h,errorKey:e,errorMsg:t},_=this.getElement("#attrValue")||this.getElement("#attrValue_2");if(p.isValid){if(this._isAttrBeingEdited=!1,this._isOperatorBeingEdited=!1,this._updateMRU(),_&&(_.removeClassName("attr-edit-inputs-Attribute-Error"),this._badCharInValue&&this._badCharInValue.hide()),C.isActivated("easyAttribute")){o.setEasyAttributeDisplayMode(!0);var f="",m=this.model.get("attribute");if(m){var g=", ",v=this.model.get("attrOp"),y=this.model.get("attrValue");if(v&&"between"===v&&this.attrValuation1&&(y=[this.model.get("attrValue_1"),this.model.get("attrValue_2")],g=" "+r.get("AND").toLowerCase()+" "),y&&(f=b._buildAttributeValue(m.type,y,m.rangeValues,v,g)),this._anyObjectAttrValue);else{var A=this.attrValuation?this.attrValuation:this.attrValuation2;this._anyObjectAttrValue=this._buildEasyUI("value",f,A),this._anyObjectAttrValueAnchor=this._anyObjectAttrValue}this._anyObjectAttrType.show(),this._anyObjectAttrOp.show(),f=""===f?r.get("NoValueEntered"):f,this._anyObjectAttrValueAnchor.setText(f),this._anyObjectAttrValue.hide(),this.attributeCombo.getContent().hide()}this.opCombo&&this.opCombo.getContent().hide()}}else _&&_.addClassName("attr-edit-inputs-Attribute-Error");return p},getAttrParam:function(){var e=[];void 0!==this.model.get("attrValue")?e.push(this.model.get("attrValue")):void 0!==this.model.get("attrValue_1")&&(e.push(this.model.get("attrValue_1")),e.push(this.model.get("attrValue_2")));var t=this.model.get("nlsAttribute")?this.model.get("nlsAttribute"):"",i=this.keepAttrInfosFromLabel[t],n=t.length?i.type:"",s=i&&i.rangeValues?i.rangeValues.editable:void 0;return{type:n,name:this.model.get("attribute")?this.model.get("attribute").value:"",nlsName:t,op:this.model.get("attrOp"),nlsOp:this.model.get("nlsAttrOp"),values:e,synthesisValue:s}},isAttrEmpty:function(){var e=this.model.get("attribute");return void 0===e||""===e},setFocus:function(){void 0!==this.attributeCombo&&this.attributeCombo._getMainElement().focus()},initParams:function(){this.attributeCombo.selectedIndex=-1},getParams:function(){return{attribute:this.model.get("attribute"),attrOp:this.model.get("attrOp"),attrValue:this.model.get("attrValue"),attrValue1:this.model.get("attrValue_1"),attrValue2:this.model.get("attrValue_2"),attributes:this.attributes,elementsList:this.attributeCombo.elementsList,keepAttrInfosFromLabel:this.keepAttrInfosFromLabel}},setParams:function(e){if(this.attributes=e.attributes,this.keepAttrInfosFromLabel=e.keepAttrInfosFromLabel,this.attributeCombo.elementsList=e.elementsList,void 0===e.attribute)this.attributeCombo.selectedIndex=-1;else{for(var t=Object.keys(this.keepAttrInfosFromLabel),i=0;i<t.length;i++)if(e.attribute.label===this.keepAttrInfosFromLabel[t[i]].label){this.attributeCombo.currentValue=t[i];break}this.opCombo&&(this.opCombo.currentValue=e.attrOp),this.attrValuation?(this.attrValuation.value=e.attrValue,this.getElement("#attrValue_1")&&(this.attrEditInputs.removeChild(this.getElement("#attrValue_1")),this.attrEditInputs.removeChild(this.getElement("#attrValue_2")))):void 0!==this.attrValuation1&&(this.attrValuation1.value=e.attrValue1,this.attrValuation2.value=e.attrValue2,this.getElement("#attrValue")&&this.attrEditInputs.removeChild(this.getElement("#attrValue")))}},compareParams:function(e){var t=!1;return t||(e.attribute&&this.model.get("attribute")?this.model.get("attribute").value!==e.attribute.value&&(t=!0):(e.attribute||this.model.get("attribute"))&&(t=!0)),t||(e.attrOp&&this.model.get("attrOp")?this.model.get("attrOp")!==e.attrOp&&(t=!0):(e.attrOp||this.model.get("attrOp"))&&(t=!0)),t||(e.attrValue&&this.model.get("attrValue")?this.model.get("attrValue")!==e.attrValue&&(t=!0):e.attrValue||this.model.get("attrValue")?t=!0:e.attrValue1&&this.model.get("attrValue_1")?this.model.get("attrValue_1")===e.attrValue1&&this.model.get("attrValue_2")===e.attrValue2||(t=!0):(e.attrValue1||this.model.get("attrValue_1"))&&(t=!0)),t},showAddButtons:function(e){e?(this._addAttributeBtn.show(),this._addAttributeGroupBtn.show()):(this._addAttributeBtn.hide(),this._addAttributeGroupBtn.hide())},showRemoveButton:function(e){e?this._removeAttributeBtn.show():this._removeAttributeBtn.hide()},reBuildAttributesInfos:function(e,t){this.selectedType=t||this.selectedType;var i,n,s=this.attributeCombo.currentValue;s&&(i=this.opCombo?this.opCombo.currentValue:i,this.model.get("attrValue")?n=this.model.get("attrValue"):this.model.get("attrValue_1")&&((n=[]).push(this.model.get("attrValue_1")),n.push(this.model.get("attrValue_2"))));var r=this._buildAttributesComboItems(e);if(this.attributeCombo.elementsList=r.items,s&&s.length){var a=this.keepAttrInfosFromLabel[s];a?(this.attributeCombo.currentValue=s,this.opCombo.currentValue=i,this._buildAttrValue(a.type,a.rangeValues,i,!0,n)):(this.attributeCombo.selectedIndex=-1,o.isEasyAttributeDisplayMode()&&(this._anyObjectAttrType.hide(),this.attributeCombo.show()))}},_buildAttributesComboItems:function(e){var t=this._buildAttributesInfos(e);this.keepAttrInfosFromLabel=t.infosFromLabel||{},this.keepAttrInfosFromName=t.infosFromName||{};var i=t.maxItemLength,n=t.items,s=[],o=this._getMRUProperty(this._mruPropertyAttributes);if(0!==o.length){o.reverse();var r=this;o.forEach(function(e){var t=r.keepAttrInfosFromName[e.value]||r.keepAttrInfosFromName[e.name];t&&s.push({labelItem:t,iconItem:{iconName:r._iconHistoryValue}})})}this._separatorMRU.labelItem="-".repeat(i),s.push(this._separatorMRU);var a=1===n.length?0:-1;return{items:s.concat(n.sort(this._alphabeticSort)),indexToSelect:a}},_buildAttributesInfos:function(e){var t=[],i=0,n={},s={};return e.forEach(function(e){var o;o=e.range&&e.range.dataTypes[0]?e.range.dataTypes[0].split("#")[1]:e.dataTypes?e.dataTypes:e.dataType?e.dataType.split("#")[1]||e.dataType:"string";var r=e.label||e.nlsName,a=e.curi||e.uri,l=a,d=1,c=r;if(s[c]){d=0;var u=s[c];if(u&&u.uri!==a){c=u.label+"("+u.uri+")",s[c]={type:u.type,uri:u.uri,label:u.label,value:u.value,rangeValues:u.rangeValues||[]},delete s[r];for(var h=0;h<t.length;h++)if(t[h].labelItem===u.label){t[h].labelItem=c;break}c=r+"("+a+")",d=1}}else s[c]={};1===d&&(s[c]={type:o,uri:a,label:r,value:l,rangeValues:e.rangeValues||[]},n[l]=c,t.push({labelItem:c}),i=Math.max(i,c.length))}),{infosFromLabel:s,infosFromName:n,items:t,maxItemLength:i}},_buildEasyUI:function(t,i,n){var s=this,r=e.createElement("a",{touchMode:o.TOUCH_MODE,class:"innerfiltertypecombo filter-anyobject-on",text:i}),a=r;switch(a.inject(n.getContent(),"after"),t){case"type":r.id="anyObject_attribute",r.addEventListener("click",function(e){a.hide(),s._isAttrBeingEdited=!0,s._isOperatorBeingEdited=!0,s._anyObjectAttrOp&&s._anyObjectAttrOp.hide(),s._anyObjectAttrValue&&s._anyObjectAttrValue.hide(),s.attributeCombo.show(),s.opCombo.show(),s.attrValuation?s.attrValuation.show():(s.attrValuation1.show(),s.attrValuation2.show())});break;case"operator":r.id="anyObject_operator",r.addEventListener("click",function(e){s._isOperatorBeingEdited=!0,a.hide(),s.opCombo.show()});break;case"value":r.id="anyObject_value",r.addEventListener("click",function(e){a.hide(),s.attrValuation?s.attrValuation.show():(s.attrValuation1.show(),s.attrValuation2.show())})}return a},_arrangeIntoTree:function(e){for(var t=[],i=0;i<e.length;i++)for(var n=e[i],s=t,o=0;o<n.length;o++){var r=n[o],a=d(s,"name",r);if(a)s=a.children;else{var l={name:r,children:[]};s.push(l),s=l.children}}return t;function d(e,t,i){for(var n=0;n<e.length&&e[n][t]!==i;)n++;return n<e.length&&e[n]}}})}),define("DS/ENONextGenFilterUX/views/VolumeCombinationView",["UWA/Core","UWA/Event","UWA/Class/View","UWA/Class/Model","DS/ENONextGenFilterUX/views/VolumeView","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/Controls/ComboBox","DS/Controls/Button","DS/Controls/TooltipModel","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENONextGenFilterUX/models/CriterionModel","DS/PlatformAPI/PlatformAPI","DS/ENOFilterBIUX/NGFServices"],function(e,t,i,n,s,o,r,a,l,d,c,u,h){"use strict";var p=0,_=0,f=i.extend({domEvents:{},tagName:"div",className:"attribute-edit-group",setup:function(e){this._UXId=e.UXId,this._rootId=e.rootId,this._NGFUXId=e.NGFUXId,this._widgetId=e.widgetId,this._filterSpecId=e.filterSpecId,this._volSetId=e.volSetId||0,this._deepGroup=e.deepGroup||0,this._displayMode=e.displayMode||"light",this._sendEvent=e.sendEvent,this._initCombination=e.initCombination||0,this._volEditInputs=e.volEditInputs,this._listOfVolumes=[],this._subscribe0=u.subscribe("NGFilter_VolumeDefined",this._onVolumeDefined.bind(this)),this._subscribe1=u.subscribe("NGFilter_VolumeDefined_Init",this._onVolumeDefinedInit.bind(this)),this._subscribe2=u.subscribe("NGFilter_CancelVolumeDefined",this._onCancelVolumeDefined.bind(this))},render:function(){var t="combinationVolume_"+this._filterSpecId+this._volSetId;this.container.setAttribute("id",t);var i=this.getContent();this._divCombination=e.createElement("div",{class:"attribute-edit-group-Combination"+(d.TOUCH_MODE?"":" filter-no-touch-mode")}),this._divCombination.inject(this._volEditInputs||i);var n="withAttribute";return this._withLabel=this._createCombinationLabel(n,"with"),this._withLabel.inject(this._divCombination),this._combinationCombo=this._createCombinationCombo(this._initCombination),this._combinationCombo.inject(this._divCombination),n="FollowingCombination",this._followingLabel=this._createCombinationLabel(n,"following"),this._followingLabel.inject(this._divCombination),this._removeBtn=this._createRemoveGroupButton(),this._removeBtn.inject(this._divCombination),this._setDisplayMode(this._displayMode||"light"),this._createVolume(),this},destroy:function(){this._divCombination.destroy(),this._removeVolume(),0!==this._deepGroup||this._listOfVolumes.length||(p=0===this._deepGroup?0:p,_=0,this._subscribe0&&(this._subscribe0.unsubscribe("NGFilter_VolumeDefined"),this._subscribe0=void 0),this._subscribe1&&(this._subscribe1.unsubscribe("NGFilter_VolumeDefined_Init"),this._subscribe1=void 0),this._subscribe2&&(this._subscribe2.unsubscribe("NGFilter_CancelVolumeDefined"),this._subscribe2=void 0)),this.stopListening(),this.model=null,this._parent(),this.container=null},_setDisplayMode:function(e){switch(e){case"none":case"light":this._divCombination.hide();break;case"middle":this._divCombination.show(),this._withLabel.show(),this._combinationCombo.show(),this._followingLabel.show(),this._removeBtn.hide();break;case"full":this._divCombination.show(),this._withLabel.show(),this._combinationCombo.show(),this._followingLabel.show()}},_createCombinationLabel:function(t,i){return e.createElement("label",{class:"innerfiltertypecombo",text:o.get(t),id:"combination-"+i+"_"+this._volSetId})},_createCombinationCombo:function(e){var t=[{labelItem:o.get("AllCombination"),valueItem:"all"},{labelItem:o.get("AnyCombination"),valueItem:"any"}],i=new r({touchMode:d.TOUCH_MODE,elementsList:t,enableSearchFlag:!1,domId:"combination-combo_"+this._volSetId}),n=this;return i.addEventListener("change",function(e){var t=e.dsModel.currentValue;n.model.set("combination",t),n._initCombination=e.dsModel.selectedIndex}),this.model.set("combination",t[e].valueItem),i.selectedIndex=e,i},_createRemoveGroupButton:function(){var e=new a(d.getAttributeButtonStyle("group-delete"));e.tooltipInfos=new l({shortHelp:o.get("RemoveVolumeGroup"),mouseRelativePosition:!0}),e.getContent().addClassName("attribute-edit-button-style attribute-edit-group-remove-btn"+(d.TOUCH_MODE?"":" filter-no-touch-mode"));var t=this;return e.addEventListener("click",function(e){t.dispatchEvent("NGF_RemoveVolumeGroup",{volId:t.container.getAttribute("id")})}),e},_createVolume:function(e){var t=1,i=this.getElement("#actions_"+this._volSetId);i||(t=0,i=this.getContent()),0===this._deepGroup&&this._updateVolumeUI("volume");var n=new c,o=this.model.get("allVolumes")||[];o.push(n),this.model.set("allVolumes",o),this.model.set("state","edit");var r=new s({model:n,filterSpecId:this._filterSpecId,volSetId:this._volSetId,idVol:p});p++,r.render().inject(i,t?"before":""),r.setFocus(),this._showAddButtons(!1),this._listOfVolumes.push(r),this._highlightVolumeGroup(),this.listenTo(r,"NGF_RemoveVolume",this._onRemoveVolume.bind(this)),this.listenTo(r,"NGF_VolumeSelected",this._onSelectedVolume.bind(this)),e?(r.model.set("parameters",e.volume),r.model.set("state","read")):this._sendEvent&&(this._onSelectedVolume(r.getValues()),r.model.set("state","edit"))},_highlightVolumeGroup:function(){var e=document.body.getElement(".f-volume-container.edit");if(e){var t=e.getElement(".attribute-edit-group-selected");t&&t.removeClassName("attribute-edit-group-selected")}0!==this._deepGroup&&this.getContent().addClassName("attribute-edit-group-selected")},_onAddVolumeGroup:function(){this._onValidateEditedVolume();var t=1,i=this.getElement("#actions_"+this._volSetId);i||(t=0,i=this.getContent()),0===this._deepGroup&&this._updateVolumeUI("group");var s=new n;s.set("isActivated","1"),s.set("state","edit");var o=this.model.get("allVolumes")||[];o.push(s),this.model.set("allVolumes",o),this.model.set("state","read"),_++;var r=new f({UXId:this._UXId,NGFUXId:this._NGFUXId,widgetId:this._widgetId,model:s,volSetId:_,initCombination:this._initCombination?0:1,displayMode:"full",deepGroup:this._deepGroup+1,sendEvent:this._sendEvent,filterSpecId:this._filterSpecId});r.render().inject(i,t?"before":""),this._showAddButtons(!0),r.getContent().addClassName("subgroupdivborder"),r._highlightVolumeGroup();var a=r._listOfVolumes.length;a&&r._listOfVolumes[a-1].setFocus(),this._listOfVolumes.push(r),this.listenTo(r,"NGF_RemoveVolumeGroup",this._onRemoveVolume.bind(this)),this.listenTo(r,"NGF_ValidateEditedVolume",this._onValidateEditedVolume.bind(this)),r._divAction=e.createElement("div",{class:"attr-edit-actions"+d.FILTER_TOUCH_CLASS,id:"actions_"+_}),r._divAction.inject(r.getContent()),r.addVolumeBtn=r._createAddVolumeButton(r),r.addVolumeBtn.inject(r._divAction),r.addVolumeGroupBtn=r._createAddVolumeGroupButton(r),r.addVolumeGroupBtn.inject(r._divAction)},_showAddButtons:function(e){0===this._deepGroup&&this.dispatchEvent("NGF_DisplayAddActions",{display:e})},_onRemoveVolume:function(e){this._onValidateEditedVolume(),this._removeVolumeAndUpdateUI(e),d.resetSelectedVolumeOf3D(this._NGFUXId,this._widgetId,this._rootId)},_removeVolumeAndUpdateUI:function(e){for(var t=e.volId,i=0;i<this._listOfVolumes.length;i++)if(this._listOfVolumes[i].container.id===t){this._removeVolume(i),1>=this._listOfVolumes.length&&0===this._deepGroup&&this._switchToSingleVolume(),0===this._listOfVolumes.length&&(0!==this._deepGroup?this.dispatchEvent("NGF_RemoveVolumeGroup",{volId:this.getContent().id}):(p=0,this._setDisplayMode("none"),this.dispatchEvent("NGF_RemoveCriterion",{})));break}var n=this._listOfVolumes.length;if(1<=n){var s=this._listOfVolumes[n-1];this._isGroup(s)||0===this._deepGroup?this._showAddButtons(!1):(s.showAddButtons(!0),this._highlightVolumeGroup())}},_removeVolume:function(e){for(var t=e||0,i=e+1||this._listOfVolumes.length,n=i-1;n>=t;n--)this._listOfVolumes[n].destroy();this._listOfVolumes.splice(t,i-t);var s=this.model.get("allVolumes");s&&s.splice(t,i-t),this.model.set("allVolumes",s)},_onVolumeDefinedInit:function(e){this._onVolumeDefined(e)},_onCancelVolumeDefined:function(){0===this._deepGroup&&(this.removeEmptyVolume(),this.model.set("state","edit"),d.resetSelectedVolumeOf3D(this._NGFUXId,this._widgetId,this._rootId))},_onVolumeDefined:function(e){if(this._UXId===e.UXId){var t=this,i=function(e){h.setUsageTracker(t._widgetId,"NGF-Volume-Type",e)};if("edit"===this.model.get("state")){if(!(void 0!==e.specId&&this._filterSpecId!==e.specId||void 0!==e.setId&&this._volSetId!==e.setId)){var n,s=e.action;if(e.id)for(var o=this._listOfVolumes.length,r=0;r<o;r++){if((c=this._listOfVolumes[r])&&c.model.get("id")===e.id&&(n=c.model,"add"===s&&"edit"===n.get("state")&&c.isEmpty())){s="update";break}}"add"===s?(i(e.volume.type),this._onValidateEditedVolume(),this.createVolume(e),d.resetSelectedVolumeOf3D(this._NGFUXId,this._widgetId,this._rootId)):"update"===s&&(n||1!==this._listOfVolumes.length||(n=this._listOfVolumes[0].model),n.get("parameters")&&n.get("parameters").type===e.volume.type||i(e.volume.type),n.set("state","edit"),n.set("parameters",e.volume),n.set("state","read")),d.openFilterPanel("volume_"+Date.now())}}else if("add"===e.action&&0===this._deepGroup){i(e.volume.type);var a,l=this._listOfVolumes.length;for(r=0;r<l;r++){var c;if((c=this._listOfVolumes[r])&&"edit"===c.model.get("state")){a=c;break}}a||(this.dispatchEvent("NGF_SwitchToEdit",{}),this.createVolume(e),d.resetSelectedVolumeOf3D(this._NGFUXId,this._widgetId,this._rootId),d.openFilterPanel("volume_"+Date.now()))}}},_onValidateEditedVolume:function(){if(0===this._deepGroup){var e=this.model;this._validateEditedVolume_X(e)}else this.dispatchEvent("NGF_ValidateEditedVolume",{})},_validateEditedVolume_X:function(e){var t=0;if(e){for(var i=e.get("allVolumes")||[],n=i.length,s=0;s<n&&!t;s++){var o=i[s];o.get("allVolumes")?t=this._validateEditedVolume_X(o):"edit"===o.get("state")&&(o.set("state","read"),t=1)}e.set("state","read")}},_onSelectedVolume:function(e){this._onValidateEditedVolume(),this.model.set("state","edit");var t={NGFUXId:this._NGFUXId,appId:this._NGFUXId,widgetId:this._widgetId,action:"update",id:e.id,displayName:e.displayName,filteredRoot:this._rootId,volume:e.parameters};u.publish("NGFilter_Volume",t)},_updateVolumeUI:function(e){0===this._listOfVolumes.length?"volume"===e?this._setDisplayMode("light"):"group"===e&&(this._divCombination.addClassName("attribute-edit-group"),this.getContent().removeClassName("attribute-edit-group"),this._setDisplayMode("none"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:1,combination:this._divCombination,view:this})):1!==this._listOfVolumes.length||this._isGroup(this._listOfVolumes[0])?this._setDisplayMode("full"):(this._divCombination.addClassName("attribute-edit-group"),this.getContent().removeClassName("attribute-edit-group"),this._listOfVolumes[0].showRemoveButton(!0),this._listOfVolumes[0].showAddButtons(!1),this._setDisplayMode("middle"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:1,combination:this._divCombination,view:this}))},_switchToSingleVolume:function(){if(0===this._listOfVolumes.length)this._divCombination.removeClassName("attribute-edit-group"),this.getContent().addClassName("attribute-edit-group"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:0,view:this});else if(1===this._listOfVolumes.length)if(this._isGroup(this._listOfVolumes[0]))this._setDisplayMode("none");else{this._divCombination.removeClassName("attribute-edit-group"),this.getContent().addClassName("attribute-edit-group");var e=this._listOfVolumes[0];e.showRemoveButton(!0),e.showAddButtons(!1),this._setDisplayMode("light"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:0,view:this})}},isVolumeValid:function(){for(var e=[],t=this._listOfVolumes.length,i=0;i<t;i++){var n=this._listOfVolumes[i];if(this._isGroup(n))e=n.isVolumeValid();else{var s=n.isVolumeValid();if(!s.isValid){var o=s.errorKey;void 0===e[o]&&(e[o]=""),e[o]+="<br>   "+s.errorMsg}}}return e},_isGroup:function(e){return!!e._listOfVolumes},removeEmptyVolume:function(){this._onValidateEditedVolume(),this._removeEmptyVolume_X()},_removeEmptyVolume_X:function(){for(var e=this._listOfVolumes.length-1;e>=0;e--){var t=this._listOfVolumes[e];this._isGroup(t)?t._removeEmptyVolume_X():t.isEmpty()&&this._removeVolumeAndUpdateUI({volId:this._listOfVolumes[e].getContent().id})}},viewFromMdl:function(e){var t=this._sendEvent;this._sendEvent=0;var i=e.allVolumes;this._buildVolumeFromModel(i[0]),this._sendEvent=t},_buildVolumeFromModel:function(e){var t=e.allVolumes;this._combinationCombo.currentValue=e.combination;for(var i=t.length,n=0;n<i;n++){if(t[n].allVolumes)this._listOfVolumes.length<n+1&&this._onAddVolumeGroup(),this._listOfVolumes[n]._buildVolumeFromModel(t[n]);else this._listOfVolumes.length<n+1&&this._createVolume(),this._listOfVolumes[n].volumeViewFromMdl(t[n])}},createVolume:function(e){this._createVolume(e)},createVolumeGroup:function(){this._onAddVolumeGroup()},_createAddVolumeButton:function(e){var t=new a(d.getAttributeButtonStyle("plus"));t.tooltipInfos=new l({shortHelp:o.get("AddVolume"),mouseRelativePosition:!0}),t.getContent().addClassName("attribute-edit-button-style attribute-edit-add-btn2"+(d.TOUCH_MODE?"":" filter-no-touch-mode"));var i=e;return t.addEventListener("click",function(e){i._createVolume()}),t},_createAddVolumeGroupButton:function(e){var t=new a(d.getAttributeButtonStyle("group-add"));return t.tooltipInfos=new l({shortHelp:o.get("AddVolumeGroup"),mouseRelativePosition:!0}),t.getContent().addClassName("attribute-edit-button-style attribute-edit-addGroup-btn2"+(d.TOUCH_MODE?"":" filter-no-touch-mode")),d.MAX_DEEP_VOLUME_GROUP==e._deepGroup?(t.disabled=!0,t.active=!1):t.addEventListener("click",function(t){e._onAddVolumeGroup()}),t}});return f}),define("DS/ENONextGenFilterUX/views/CriteriaContextMgmtView",["DS/ENONextGenFilterUX/views/CriteriaAbstractView","UWA/Core","UWA/Class/View","UWA/Class/Model","UWA/Promise","DS/UIKIT/DropdownMenu","DS/ENONextGenFilterUX/utils/FilterUIService","DS/Handlebars/Handlebars4","text!DS/ENONextGenFilterUX/templates/contextMgmtViewTemplate.html","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/Controls/Button","DS/PlatformAPI/PlatformAPI","css!DS/ENONextGenFilterUX/ENONextGenFilterUX.css","DS/ENOFilterBIUX/NGFServices","DS/Controls/Expander","DS/Controls/TooltipModel","DS/Menu/Menu"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,f,m,g){"use strict";return e.extend({className:"contextCriterion",tagName:"li",domEvents:{"click .contextCriterion-read .contextRead":"_checkBeforeEdit"},setup:function(e){this._parent(e),this._rootID=e.rootId,this._template=a.compile(l),this.listenTo(this.model,"onChange:state",this._onStateChange.bind(this)),h.subscribe("NGFilter.OccPath",this._onPathSelect.bind(this)),this.container.addEvent("click",function(e){return e.stopPropagation(),!1}),this._allAddedNodes=[],this._allExcludedNodes=[],this._allAddedNodesLabels=[],this._allExcludedNodesLabels=[],this.model.set("addedNodesList",this._allAddedNodes),this.model.set("excludedNodesList",this._allExcludedNodes),this.model.set("addedNodesLabels",this._allAddedNodesLabels),this.model.set("excludedNodesLabels",this._allExcludedNodesLabels),this.listenTo(this,"updateAddDisplay",this._updateAddDisplay.bind(this)),this.listenTo(this,"updateExcludeDisplay",this._updateExcludeDisplay.bind(this)),this.model.set("AddNodeActivated",!0),this.model.set("ExcludeNodeActivated",!0)},render:function(){this.container.setContent(this._template({stateClass:this.model.get("state"),titleClass:d.get("titleContextUX"),iconHeader:c.getWebappsAssetUrl("ENONextGenFilterUX","icons/22/I_SelectionFilter.png"),maxPath:"For optimal performance, select less than 50 objects. Use attributes, configuration, or volume filtering instead of specific object selection for the best results."}));var e=d.get("SelectNodesOnAppSide");return this.getElement(".nodesAddedList").setContent(e),this.getElement(".nodesExcludedList").setContent(e),this._maxPathContainer=this.getElement("#MaxPathContainer").hide(),this._createContextFilterUI(),this._createHeaderCtxMenu(),this._editContext(),this},destroy:function(){this._saveBeforeEdit={},this.dispatchEvent("NGF_RemoveCriterion",{idxView:this.cid,criteriaType:this.model.get("criteriaType")}),this.stopListening(),this.model=null,this._parent(),this.container=null},_createHeaderCtxMenu:function(){this._createCriterionCtxMenuWUX(this.getElement(".criterionDropDown")),this._setContextualMenu("edit")},_editContext:function(){this._saveBeforeEdit={},this._saveBeforeEdit.AddNodeActivated=t.clone(this.model.get("AddNodeActivated")),this._saveBeforeEdit.addedNodesList=t.clone(this.model.get("addedNodesList")),this._saveBeforeEdit.addedNodesLabels=t.clone(this.model.get("addedNodesLabels")),this._saveBeforeEdit.ExcludeNodeActivated=t.clone(this.model.get("ExcludeNodeActivated")),this._saveBeforeEdit.excludedNodesList=t.clone(this.model.get("excludedNodesList")),this._saveBeforeEdit.excludedNodesLabels=t.clone(this.model.get("excludedNodesLabels")),this._saveBeforeEdit.asString=JSON.stringify(this.model.keepComponentsToFeedUI(!0)),this.model.set("state","edit"),this.dispatchEvent("NGF_Criterion_SwitchedToEdit"),this._manageExpandCollapseNodes()},_manageExpandCollapseNodes:function(){var e=this._allAddedNodes.length,t=this._allExcludedNodes.length;(e||0===e&&0===t?this._addExpander:this._excludeExpander).expandedFlag=!0},_onPathSelect:function(e){if(e.NGFUXId&&this._NGFUXId===e.NGFUXId&&"edit"===this.model.get("state")){var t=e;if(this._addExpander.expandedFlag&&this.model.get("AddNodeActivated"))for(var i=this.getElement(".nodesAddedList"),n=1===t.path.length,s=0;s<t.path.length;s++){var o=this._checkIfPathIsAlreadyAdded(t.path[s],n)||this._checkIfPathIsAlreadyExcluded(t.path[s]);if(1<t.path[s].length&&!o){var a=t.label&&t.label.length&&t.label[s].length?t.label[s]:"Added-"+s,l=t.revision&&t.revision.length&&t.revision[s].length?t.revision[s]:"";a=r.getRootTitle(a,l),this._allAddedNodes.push(t.path[s]),this._allAddedNodesLabels.push(a),i&&this._InsertPathInDiv({selectedPath:t.path[s],pathAlias:a})}}else if(this._excludeExpander.expandedFlag&&this.model.get("ExcludeNodeActivated")){var d=this.getElement(".nodesExcludedList");for(n=1===t.path.length,s=0;s<t.path.length;s++){o=this._checkIfPathIsAlreadyAdded(t.path[s])||this._checkIfPathIsAlreadyExcluded(t.path[s],n);if(1<t.path[s].length&&!o){a=t.label&&t.label.length&&t.label[s].length?t.label[s]:"Excluded-"+s,l=t.revision&&t.revision.length&&t.revision[s].length?t.revision[s]:"";a=r.getRootTitle(a,l),this._allExcludedNodes.push(t.path[s]),this._allExcludedNodesLabels.push(a),d&&this._InsertExcludedPathInDiv({selectedPath:t.path[s],pathAlias:a})}}}}},_checkIfPathIsAlreadyAdded:function(e,t){var i=!1,n="string"==typeof e?e.split(","):e;if(this._checkRootAndPath(n)){for(var s=!1,o=!1,a=0;a<this._allAddedNodes.length;a++){for(var l=!1,c=0;c<=n.length&&!l;c++)n[c]&&n[c]!==this._allAddedNodes[a][c]&&(l=!0);if(!l&&n.length<this._allAddedNodes[a].length)s=!0;else if(!l){o=!0;break}}o?(!1!==t&&r.displayNotification({level:"info",message:d.get("AlreadyAdded"),sticky:!1}),i=!0):s&&(i=!1)}else r.displayNotification({level:"info",message:d.get("ObjectNotUnderRoot"),sticky:!1}),i=!0;return i},_checkIfPathIsAlreadyExcluded:function(e,t){var i=!1,n="string"==typeof e?e.split(","):e;if(this._checkRootAndPath(n))for(var s=0;s<this._allExcludedNodes.length;s++){for(var o=!1,a=0;a<=n.length;a++)this._allExcludedNodes[s][a]&&n[a]!==this._allExcludedNodes[s][a]&&(o=!0);if(!o){!1!==t&&r.displayNotification({level:"info",message:d.get("AlreadyExcluded"),sticky:!1}),i=!0;break}}else r.displayNotification({level:"info",message:d.get("ObjectNotUnderRoot"),sticky:!1}),i=!0;return i},_checkRootAndPath:function(e){return this._rootID===e[0]},_InsertPathInDiv:function(e,t){var i,n=this.getContent();n.querySelector(".wux-chip-cell-addlabel")||n.querySelector(".nodesAddedList")&&n.querySelector(".nodesAddedList").empty(),i="InsertAllPathsAtOnce"===t?{addedNodesLabels:e.addedNodesLabels?e.addedNodesLabels:e.get("addedNodesLabels")||[],addedNodesList:e.addedNodesList?e.addedNodesList:e.get("addedNodesList")||[]}:{addedNodesLabels:[e.pathAlias],addedNodesList:[e.selectedPath]};for(var s=this.getElement(".nodesAddedList"),o=0;o<i.addedNodesLabels.length;o++){var r=new UWA.Element("div",{class:"wux-chip-cell-container"}),a=new UWA.Element("span",{class:"wux-chip-cell-close fonticon fonticon-wrong","font-family":"DSFontIcon"});a.onclick=this._removePathFromSelectionList.bind(this);var l=new UWA.Element("span",{class:"wux-chip-cell-addlabel",html:i.addedNodesLabels[o]});l.setAttribute("occid",i.addedNodesList[o]),l.inject(r),a.inject(r),s.addContent(r),s.removeClassName("nodes-color")}this.dispatchEvent("updateAddDisplay")},_removePathFromSelectionList:function(e){if(this.model.get("AddNodeActivated"))for(var t=e.target.parentElement,i=t.getElement(".wux-chip-cell-addlabel").getAttribute("occid").split(","),n=0;n<this._allAddedNodes.length;n++){var s=!0;if(i.length===this._allAddedNodes[n].length){for(var o=0;o<i.length&&!0===s;o++)i[o]!=this._allAddedNodes[n][o]&&(s=!1);s&&(this._allAddedNodes.splice(n,1),this._allAddedNodesLabels.splice(n,1),t.remove(),this.dispatchEvent("updateAddDisplay"))}}},_updateAddDisplay:function(){var e=this._allAddedNodes.length,t=e<=1?"AddSingleNode":"AddMultiNode";if(this._addExpander.header=e+" "+d.get(t),0===e){var i="<i>"+d.get("SelectNodesOnAppSide")+"</i>";this.getElement(".nodesAddedList").setContent(i),this.getElement(".nodesAddedList").addClassName("nodes-color")}var n=this._addExpander.getContent().getElement(".wux-controls-expander-header");r.MAX_SELECTION_PATH<e?n.addClassName("contextCriterion-edit-header-maxPath"):r.MAX_SELECTION_PATH>=e&&n.removeClassName("contextCriterion-edit-header-maxPath"),r.MAX_SELECTION_PATH<e||r.MAX_SELECTION_PATH<this._allExcludedNodes.length?this._maxPathContainer.show():r.MAX_SELECTION_PATH>=e&&r.MAX_SELECTION_PATH>=this._allExcludedNodes.length&&this._maxPathContainer.hide()},_InsertExcludedPathInDiv:function(e,t){var i,n=this.getContent();n.querySelector(".wux-chip-cell-excludelabel")||n.querySelector(".nodesExcludedList")&&n.querySelector(".nodesExcludedList").empty(),i="InsertAllPathsAtOnce"===t?{excludedNodesLabels:e.excludedNodesLabels?e.excludedNodesLabels:e.get("excludedNodesLabels")||[],excludedNodesList:e.excludedNodesList?e.excludedNodesList:e.get("excludedNodesList")||[]}:{excludedNodesLabels:[e.pathAlias],excludedNodesList:[e.selectedPath]};for(var s=this.getElement(".nodesExcludedList"),o=0;o<i.excludedNodesLabels.length;o++){var r=new UWA.Element("div",{class:"wux-chip-cell-container"}),a=new UWA.Element("span",{class:"wux-chip-cell-close fonticon fonticon-wrong","font-family":"DSFontIcon"});a.onclick=this._removePathFromExcludedList.bind(this);var l=new UWA.Element("span",{class:"wux-chip-cell-excludelabel",html:i.excludedNodesLabels[o]});l.setAttribute("occid",i.excludedNodesList[o]),l.inject(r),a.inject(r),s.addContent(r),s.removeClassName("nodes-color")}this.dispatchEvent("updateExcludeDisplay")},_removePathFromExcludedList:function(e){if(this.model.get("ExcludeNodeActivated"))for(var t=e.target.parentElement,i=t.getElement(".wux-chip-cell-excludelabel").getAttribute("occid").split(","),n=0;n<this._allExcludedNodes.length;n++){var s=!0;if(i.length===this._allExcludedNodes[n].length){for(var o=0;o<i.length&&!0===s;o++)i[o]!=this._allExcludedNodes[n][o]&&(s=!1);s&&(this._allExcludedNodes.splice(n,1),this._allExcludedNodesLabels.splice(n,1),t.remove(),this.dispatchEvent("updateExcludeDisplay"))}}},_updateExcludeDisplay:function(){var e=this._allExcludedNodes.length,t=e<=1?"ExcludeSingleNode":"ExcludeMultiNode";if(this._excludeExpander.header=e+" "+d.get(t),0===e){var i="<i>"+d.get("SelectNodesOnAppSide")+"</i>";this.getElement(".nodesExcludedList").setContent(i),this.getElement(".nodesExcludedList").addClassName("nodes-color")}var n=this._excludeExpander.getContent().getElement(".wux-controls-expander-header");r.MAX_SELECTION_PATH<e?n.addClassName("contextCriterion-edit-header-maxPath"):r.MAX_SELECTION_PATH>=e&&n.removeClassName("contextCriterion-edit-header-maxPath"),r.MAX_SELECTION_PATH<e||r.MAX_SELECTION_PATH<this._allAddedNodes.length?this._maxPathContainer.show():r.MAX_SELECTION_PATH>=e&&r.MAX_SELECTION_PATH>=this._allAddedNodes.length&&this._maxPathContainer.hide()},_createContextFilterUI:function(){var e=this,i=t.createElement("div",{}),n=new u(r.getAttributeButtonStyle("chevron-down"));n.domId="keepCtxMenu",n.displayStyle="lite",n.inject(i),this._ctxMenuAddWUX=this._createContextualMenuWUX(n.getContent(),"Add");e=this;n.getContent().addEventListener("click",function(t){t.stopPropagation();var i=t.target.getBoundingClientRect();g.show(e._ctxMenuAddWUX,{position:{x:i.left,y:i.bottom}})});var s=e._allAddedNodes.length,o=e._allExcludedNodes.length,a=0>=s&&0>=o||0>=s,l=this.getElement(".contextCriterion-edit .nodesAddDisplay");this._addExpander=new f({domId:"keepExpander",header:d.get("AddNodesTitle"),expandedFlag:a,customHeader:i,style:"filled-separate"}),this._addExpander.inject(l,"before"),this._addExpander.body=l,this._addExpander.addEventListener("expand",function(t){t.stopPropagation(),e._excludeExpander.expandedFlag=!1});var c=t.createElement("div",{}),h=new u(r.getAttributeButtonStyle("chevron-down"));h.domId="excludeCtxMenu",h.displayStyle="lite",h.inject(c),this._ctxMenuExcludeWUX=this._createContextualMenuWUX(h.getContent(),"Exclude");e=this;h.getContent().addEventListener("click",function(t){t.stopPropagation();var i=t.target.getBoundingClientRect();g.show(e._ctxMenuExcludeWUX,{position:{x:i.left,y:i.bottom}})});var p=this.getElement(".contextCriterion-edit .nodesExcludeDisplay");this._excludeExpander=new f({domId:"excludeExpander",header:d.get("ExcludeNodesTitle"),expandedFlag:!a,customHeader:c,style:"filled-separate"}),this._excludeExpander.inject(p,"before"),this._excludeExpander.body=p,this._excludeExpander.addEventListener("expand",function(t){t.stopPropagation(),e._addExpander.expandedFlag=!1}),this.ConfirmCxtFilterButton=new u(r.getAttributeValidateButtonStyle());var v="attribute-edit-button-style"+r.FILTER_TOUCH_CLASS;this.ConfirmCxtFilterButton.getContent().addClassName(v),this.ConfirmCxtFilterButton.inject(this.getElement("#"+this._getId()+" .buttonToValidate")),this.ConfirmCxtFilterButton.tooltipInfos=new m({shortHelp:d.get("ValidateCriteria"),mouseRelativePosition:!0}),this.ConfirmCxtFilterButton.addEventListener("buttonclick",function(t){var i=e._allAddedNodes.length,n=e._allExcludedNodes.length;0!==i&&_.setUsageTracker(e._widgetId,"NGF-Context-Add",{label:"Nb Added",value:e.model.get("AddNodeActivated")?i:-1}),0!==n&&_.setUsageTracker(e._widgetId,"NGF-Context-Exclude",{label:"Nb Excluded",value:e.model.get("ExcludeNodeActivated")?n:-1}),this._saveBeforeEdit={},e.isThereCriteria()?(r.isModelActivated(e.model)||!0!==e._isCriterionModified()||e._switchCriterionState(),e.dispatchEvent("NGF_Criterion_Validation",{criteriaType:e.model.get("criteriaType")})):e.destroy()})},_cancelEditCriteria:function(){this._resetAddedNodes(),this._resetExcludedNodes(),this._allAddedNodes=t.clone(this._saveBeforeEdit.addedNodesList),this._allAddedNodesLabels=t.clone(this._saveBeforeEdit.addedNodesLabels),this._allExcludedNodes=t.clone(this._saveBeforeEdit.excludedNodesList),this._allExcludedNodesLabels=t.clone(this._saveBeforeEdit.excludedNodesLabels),this.model.set("AddNodeActivated",t.clone(this._saveBeforeEdit.AddNodeActivated)),this.model.set("addedNodesList",this._allAddedNodes),this.model.set("addedNodesLabels",this._allAddedNodesLabels),this.model.set("ExcludeNodeActivated",t.clone(this._saveBeforeEdit.ExcludeNodeActivated)),this.model.set("excludedNodesList",this._allExcludedNodes),this.model.set("excludedNodesLabels",this._allExcludedNodesLabels),this._InsertPathInDiv(this._saveBeforeEdit,"InsertAllPathsAtOnce"),this._setStateOfAddNodes(!this._saveBeforeEdit.AddNodeActivated),this._updateContextualmenuFromModel("Add"),this._InsertExcludedPathInDiv(this._saveBeforeEdit,"InsertAllPathsAtOnce"),this._setStateOfExcludeNodes(!this._saveBeforeEdit.ExcludeNodeActivated),this._updateContextualmenuFromModel("Exclude"),this._manageExpandCollapseNodes()},_onStateChange:function(e,i){var n=this.model.criterionToString();if("string"==typeof n||Array.isArray(n)){this.getElement(".f-context-container").setAttribute("class","f-context-container "+i);if("read"===i){var s=Array.isArray(n)?n:[n];if(_.isActivated("newSelectionRead")){var o=s[0].replace("(","").replace(")","").split(",");this.getElement(".contextRead").setContent([{tag:"span",html:d.get("titleContextUX")}]);var r=this.getElement(".contextCriterion-read");this.getElements(".contextCriterion-read .wux-controls-expander").forEach(e=>{e.destroy()});var a=this,l=function(e,i,n,s){var o=t.createElement("div",{class:"selectablesDivCSSread"});a.model.get(n).forEach(e=>{t.createElement("div",{html:e}).inject(o)});var r=new f({header:i,expandedFlag:!1,style:"simple",body:o});r.inject(e),r.getContent().style.marginLeft="20px",s?r.getContent().removeClassName("f-criterion-deactivated"):r.getContent().addClassName("f-criterion-deactivated")},c="addedNodesLabels",u=0;if(this.model.get(c).length){var h=this.model.get("AddNodeActivated");l(r,d.get(o[u]),c,h),u++}if(c="excludedNodesLabels",this.model.get(c).length){h=this.model.get("ExcludeNodeActivated");l(r,d.get(o[u]),c,h)}}else{this.getElement(".contextRead").setContent([{tag:"span",html:d.get("titleContextUX")+s[0]}])}this._setContextualMenu("read")}else this._setContextualMenu("edit"),this._manageExpandCollapseNodes()}else"object"==typeof n&&console.log("Criteria Selection Error / Invalid expected type on state change")},viewFromMdl:function(e){var t=this,i=e.get("AddNodeActivated")||!0;this._allAddedNodes=e.get("addedNodesList")||[];var n=e.get("ExcludeNodeActivated")||!0;this._allExcludedNodes=e.get("excludedNodesList")||[],this.model.set("AddNodeActivated",i),this.model.set("addedNodesList",this._allAddedNodes),this.model.set("ExcludeNodeActivated",n),this.model.set("excludedNodesList",this._allExcludedNodes);var s=[];this._allAddedNodes.length&&this._allAddedNodes.forEach(e=>{s.push(e[e.length-1])});var o=[];this._allExcludedNodes.length&&this._allExcludedNodes.forEach(e=>{o.push(e[e.length-1])});var a=[...new Set(s.concat(o))];a.length&&r.executeFetch(a,[],["ds6w:label","ds6wg:revision"]).then(function(i){t._allAddedNodesLabels=r.getAliasesFromFetched(s,i),t.model.set("addedNodesLabels",t._allAddedNodesLabels),t._InsertPathInDiv(e,"InsertAllPathsAtOnce"),t._allExcludedNodesLabels=r.getAliasesFromFetched(o,i),t.model.set("excludedNodesLabels",t._allExcludedNodesLabels),t._InsertExcludedPathInDiv(e,"InsertAllPathsAtOnce"),t._setStateOfNodesFromModel(),t._updateContextualmenuFromModel("Add"),t._updateContextualmenuFromModel("Exclude")})},_getDOMElementToUpdateOnActivateChange:function(){var e=[];return this.getElement("#"+this._getId()+" .contextCriterion-read").getChildren().forEach(t=>e.push(t)),e},_getCallbackToEditCriterion:function(){return this._editContext.bind(this)},isCriterionValidate:function(){if(0===r.isAsynchronousValidation())return!0;var e=this;return new s(function(t){e.isThereCriteria()?r.isModelActivated(e.model)||!0!==e._isCriterionModified()||e._switchCriterionState():e.destroy(),t(!0)})},_isCriterionModified:function(){var e=JSON.stringify(this.model.keepComponentsToFeedUI(!0));return this._saveBeforeEdit.asString!==e},isThereCriteria:function(){var e=this.model.get("addedNodesList")||[],t=this.model.get("excludedNodesList")||[];return!(!e.length&&!t.length)},_resetAddedNodes:function(){this._allAddedNodes.splice(0),this._allAddedNodesLabels.splice(0),this._addExpander.getContent().removeClassName("f-criterion-deactivated"),this.getElement(".nodesAddedList").getElements(".wux-chip-cell-container").forEach(function(e){e.remove()}),this.dispatchEvent("updateAddDisplay"),this.model.set("AddNodeActivated",!0),this._updateContextualmenuFromModel("Add")},_resetExcludedNodes:function(){this._allExcludedNodes.splice(0),this._allExcludedNodesLabels.splice(0),this._excludeExpander.getContent().removeClassName("f-criterion-deactivated"),this.getElement(".nodesExcludedList").getElements(".wux-chip-cell-container").forEach(function(e){e.remove()}),this.dispatchEvent("updateExcludeDisplay"),this.model.set("ExcludeNodeActivated",!0),this._updateContextualmenuFromModel("Exclude")},_createContextualMenuWUX:function(e,t){var i=function(e){var t,i,n=e.context.action;"Add"===n?(t="AddNodeActivated",i=this._setStateOfAddNodes.bind(this)):(t="ExcludeNodeActivated",i=this._setStateOfExcludeNodes.bind(this));var s=this.model.get(t);i(s),this.model.set(t,!s),this._updateContextualmenuFromModel(n)},n={type:"PushItem",recId:"activate-item-DDCtx",title:d.get("activatedCriteria"),icon:r.getIconByName("eye"),action:{this:this,callback:i,context:{action:t}}},s={type:"PushItem",recId:"activate-item-DDCtx",title:d.get("deactivatedCriteria"),icon:r.getIconByName("eye-off"),action:{this:this,callback:i,context:{action:t}}},o={type:"PushItem",recId:"reset-item-DDCtx",title:d.get("ResetNodes"),icon:r.getIconByName("clear"),action:{this:this,callback:"Add"===t?this._resetAddedNodes:this._resetExcludedNodes}};return"Add"===t?(this._activateAddItem=n,this._deactivateAddItem=s):(this._activateExcludeItem=n,this._deactivateExcludeItem=s),[s,o]},_setStateOfNodesFromModel:function(){var e=this.model.get("AddNodeActivated");this._setStateOfAddNodes(!e),this.dispatchEvent("updateAddDisplay"),e=this.model.get("ExcludeNodeActivated"),this._setStateOfExcludeNodes(!e),this.dispatchEvent("updateExcludeDisplay")},_setStateOfAddNodes:function(e){var t=this._addExpander.getContent().getElement(".headerTitle"),i=this.getElement(".nodesAddedList").getElements(".wux-chip-cell-container");i.push(t),i.forEach(function(t){e?t.addClassName("f-criterion-deactivated"):t.removeClassName("f-criterion-deactivated")})},_setStateOfExcludeNodes:function(e){var t=this._excludeExpander.getContent().getElement(".headerTitle"),i=this.getElement(".nodesExcludedList").getElements(".wux-chip-cell-container");i.push(t),i.forEach(function(t){e?t.addClassName("f-criterion-deactivated"):t.removeClassName("f-criterion-deactivated")})},_updateContextualmenuFromModel:function(e){if("Add"===e){var t=this.model.get("AddNodeActivated");this._ctxMenuAddWUX[0]=t?this._deactivateAddItem:this._activateAddItem}else if("Exclude"===e){t=this.model.get("ExcludeNodeActivated");this._ctxMenuExcludeWUX[0]=t?this._deactivateExcludeItem:this._activateExcludeItem}},buildViewFromRepairModel:function(e){this.model.set("state","edit"),this.viewFromMdl(e),this.model.set("state","read");var t=this.model.get("addedNodesList")||[],i=this.model.get("excludedNodesList")||[];0===t.length&&0===i.length&&this.destroy()},updateModelFromRepair:function(e){var t,i=this,n=e[0],s=[];e[1].length&&e[1].forEach(function(e){e.attributes.forEach(function(e){"logicalid"===e.name&&s.push(e.value)})});var o=this.model.get("repairFilterInfo"),r=function(t,o,r){for(var a=!1,l=t.length,d=0;d<l;d++){var c=t[d],u=s.indexOf(c);if(-1===u)a=!0;else{var h=e[1][u].attributes[0].value,p=e[1][u].attributes.findIndex(function(e){return"ds6w:label"===e.name}),_=e[1][u].attributes[p].value;_+=-1===(p=e[1][u].attributes.findIndex(function(e){return"ds6wg:revision"===e.name}))?"":" "+e[1][u].attributes[p].value;for(var f=0;f<n.length;f++)-1!==n[f].indexOf(h)&&!1===i.IsPathPresent(o,n[f])&&(o.push(n[f]),r.push(_),a=!0)}}return a},a=this.model.get("addedNodesList"),l=this.model.get("addedNodesLabels"),d=r(o.logicalID_OfAddedPaths,a,l),c=this.model.get("excludedNodesList"),u=this.model.get("excludedNodesLabels"),h=r(o.logicalID_OfExcludedPaths,c,u);return{modelUpdated:t=d||h,attributes:t?this.model:void 0}},IsPathPresent:function(e,t){for(var i=!1,n=0;n<e.length;n++){i=!0;for(var s=0;s<e[n].length;s++)e[n][s]!=t[s]&&(i=!1);if(!0===i)return i}return i}})}),define("DS/ENONextGenFilterUX/views/AttributeCombinationView",["UWA/Core","UWA/Event","UWA/Class/View","UWA/Class/Model","DS/ENONextGenFilterUX/views/AttributeView","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/Controls/ComboBox","DS/Controls/Button","DS/Controls/TooltipModel","DS/ENONextGenFilterUX/utils/FilterUIService"],function(e,t,i,n,s,o,r,a,l,d){"use strict";var c=i.extend({domEvents:{},tagName:"div",className:"attribute-edit-group",setup:function(e){this._widgetId=e.widgetId,this._attrSetId=e.attrSetId||0,this._combinationId=this._attrSetId,this._deepGroup=e.deepGroup||0,this._displayMode=e.displayMode||"light",this._selectedType=e.selectedType,this._selectedSubType=e.selectedSubType,this._attributes=e.attributesUsed,this._initCombination=e.initCombination||0,this._attrEditInputs=e.attrEditInputs,this._idAttr=0,this._listOfAttributes=[]},render:function(){var t="combinationAttribute_"+this._combinationId;this.container.setAttribute("id",t);var i=this.getContent();this._divCombination=e.createElement("div",{class:"attribute-edit-group-Combination"+(d.TOUCH_MODE?"":" filter-no-touch-mode")}),this._divCombination.inject(this._attrEditInputs||i);var n="withAttribute";return this._withLabel=this._createCombinationLabel(n,"with"),this._withLabel.inject(this._divCombination),this._combinationCombo=this._createCombinationCombo(this._initCombination),this._combinationCombo.inject(this._divCombination),this._anyObjectCombination.inject(this._combinationCombo.getContent(),"after"),n="FollowingCombination",this._followingLabel=this._createCombinationLabel(n,"following"),this._followingLabel.inject(this._divCombination),this._removeBtn=this._createRemoveGroupButton(),this._removeBtn.inject(this._divCombination),this._setCombinationDisplayMode(this._displayMode),this.createAttribute(),this},destroy:function(){this.cleanAttributes(),this.stopListening(),this.model=null,this._parent(),this.container=null},_setCombinationDisplayMode:function(e){switch(this._displayMode=e,e){case"none":this._divCombination.hide();break;case"light":this._divCombination.show(),this._withLabel.show(),this._combinationCombo.getContent().addClassName("filter-anyobject-off-display-off"),d.isEasyAttributeDisplayMode(),this._anyObjectCombination.hide(),this._followingLabel.hide(),this._removeBtn.hide();break;case"middle":this._divCombination.show(),this._withLabel.show(),this._combinationCombo.getContent().removeClassName("filter-anyobject-off-display-off"),d.isEasyAttributeDisplayMode(),this._anyObjectCombination.show(),this._followingLabel.show(),this._removeBtn.hide();break;case"full":this._divCombination.show(),this._withLabel.show(),this._combinationCombo.getContent().removeClassName("filter-anyobject-off-display-off"),d.isEasyAttributeDisplayMode(),this._anyObjectCombination.show(),this._followingLabel.show(),this._removeBtn.show()}},createAttribute:function(){this._onAddAttribute()},createAttributeGroup:function(){this._onAddAttributeGroup()},_createCombinationLabel:function(t,i){return e.createElement("label",{class:"innerfiltertypecombo",text:o.get(t),id:"combination-"+i+"_"+this._combinationId})},_createCombinationCombo:function(t){var i=[{labelItem:o.get("AllCombination"),valueItem:"all"},{labelItem:o.get("AnyCombination"),valueItem:"any"}],n=new r({touchMode:d.TOUCH_MODE,elementsList:i,enableSearchFlag:!1,domId:"combination-combo_"+this._combinationId});n.getContent().addClassName("filter-anyobject-off filter-anyobject-off-display-off");var s=this;return n.addEventListener("change",function(e){var t=e.dsModel.currentValue;s.model.set("combination",t),s._initCombination=e.dsModel.selectedIndex,s._anyObjectCombinationAnchor.setText(o.get("all"===t?"AllCombination":"AnyCombination"))}),this._anyObjectCombination=e.createElement("label",{class:"innerfiltertypecombo filter-anyobject-on"}),this._anyObjectCombinationAnchor=e.createElement("a",{text:n.currentLabel,id:"anyObject_combination"}),this._anyObjectCombinationAnchor.inject(this._anyObjectCombination),this._anyObjectCombinationAnchor.addEventListener("click",function(e){var t="all"===s.model.get("combination")?"any":"all";s.model.set("combination",t),e.target.setText(o.get("all"===t?"AllCombination":"AnyCombination")),n.currentValue=t}),n.getContent().removeClassName("filter-anyobject-off"),n.hide(),this._anyObjectCombination.removeClassName("filter-anyobject-on"),this._anyObjectCombination.show(),this.model.set("combination",i[t].valueItem),n.selectedIndex=t,n},_createRemoveGroupButton:function(){var e=new a(d.getAttributeButtonStyle("group-delete"));e.tooltipInfos=new l({shortHelp:o.get("RemoveAttributeGroup"),mouseRelativePosition:!0});var t="attribute-edit-button-style"+d.FILTER_TOUCH_CLASS;e.getContent().addClassName(t+" attribute-edit-group-remove-btn");var i=this;return e.addEventListener("click",function(e){var t=i.getContent().getAttribute("id");i.dispatchEvent("NGF_Remove_AttributeGroup",{attrId:t})}),e},_createAttribute:function(){var e=this.getContent();0===this._deepGroup&&this._switchDisplayToMultiAttribute("attribute");var t=new n,i=this.model.get("allAttributes")||[];i.push(t),this.model.set("allAttributes",i);var o=new s({model:t,widgetId:this._widgetId,attrSetId:this._attrSetId,idAttr:this._idAttr,selectedType:this._selectedType,selectedExtension:this._selectedSubType,displayRemoveButton:this._attrSetId||this._listOfAttributes.length?1:0,disableAddGroupButton:d.MAX_DEEP_ATTRIBUTE_GROUP===this._deepGroup?1:0,xAttributes:this._attributes});this._idAttr+=1,o.render().inject(e),o.setFocus(),this._showAddButtons(!1),this._listOfAttributes.push(o),this._highlightAttributeGroup();var r=this._listOfAttributes.length;if(0!==this._deepGroup){if(2<=r)for(var a=r-2;a>=0;a--)if(!this._isGroup(this._listOfAttributes[a])){this._listOfAttributes[a].showAddButtons(!1);break}this._listOfAttributes[r-1].showAddButtons(!0)}this.listenTo(o,"NGF_AddAttribute",this._onAddAttribute.bind(this)),this.listenTo(o,"NGF_AddAttributeGroup",this._onAddAttributeGroup.bind(this)),this.listenTo(o,"NGF_RemoveAttribute",this._onRemoveAttribute.bind(this)),this.listenTo(o,"NGF_AttributeSelected",this._onSelectedAttribute.bind(this))},_onAddAttribute:function(){this._createAttribute()},_highlightAttributeGroup:function(){var e=document.body.getElement(".f-attribute-container.edit");if(e){var t=e.getElement(".attribute-edit-group-selected");t&&t.removeClassName("attribute-edit-group-selected")}0!==this._deepGroup&&this.getContent().addClassName("attribute-edit-group-selected")},_onAddAttributeGroup:function(){var e=this.getContent();0===this._deepGroup&&this._switchDisplayToMultiAttribute("group");var t=new n,i=this.model.get("allAttributes")||[];i.push(t),this.model.set("allAttributes",i),this._attrSetId+=1;var s=new c({model:t,widgetId:this._widgetId,attrSetId:this._attrSetId,selectedType:this._selectedType,selectedExtension:this._selectedSubType,attributesUsed:this._attributes,initCombination:this._initCombination?0:1,displayMode:"full",deepGroup:this._deepGroup+1});s.render().inject(e),s._highlightAttributeGroup(),this._showAddButtons(!0),this.listenTo(s,"NGF_Remove_AttributeGroup",this._onRemoveAttribute.bind(this));var o=s._listOfAttributes.length;o&&s._listOfAttributes[o-1].setFocus(),this._listOfAttributes.push(s),0===this._deepGroup&&2===this._listOfAttributes.length&&!this._isGroup(this._listOfAttributes[0])&&this._listOfAttributes[0].isAttrEmpty()&&(this._onRemoveAttribute({attrId:this._listOfAttributes[0].getContent().id}),this._setCombinationDisplayMode("none"))},_showAddButtons:function(e){0===this._deepGroup&&this.dispatchEvent("NGF_DisplayAddActions",{display:e})},_onRemoveAttribute:function(e){for(var t=e.attrId,i=0;i<this._listOfAttributes.length;i++)if(t===this._listOfAttributes[i].container.id){this._removeAttribute(i),1>=this._listOfAttributes.length&&0===this._deepGroup&&this._switchDisplayToSingleAttribute(),0===this._listOfAttributes.length&&(0!==this._deepGroup?this.dispatchEvent("NGF_Remove_AttributeGroup",{attrId:this.getContent().id}):(this._idAttr=0,this._setCombinationDisplayMode("none"),this.createAttribute(),this._switchDisplayToSingleAttribute()));break}var n=this._listOfAttributes.length;if(1<=n){var s=this._listOfAttributes[n-1];this._isGroup(s)||0===this._deepGroup?this._showAddButtons(!1):(s.showAddButtons(!0),this._highlightAttributeGroup())}},_removeAttribute:function(e){for(var t=e||0,i=e+1||this._listOfAttributes.length,n=i-1;n>=t;n--)this._listOfAttributes[n].destroy();this._listOfAttributes.splice(t,i-t);var s=this.model.get("allAttributes");void 0!==s&&s.splice(t,i-t),this.model.set("allAttributes",s)},_onSelectedAttribute:function(e){},_switchDisplayToMultiAttribute:function(e){0===this._listOfAttributes.length?"attribute"===e?this._setCombinationDisplayMode("light"):"group"===e&&(this._divCombination.addClassName("attribute-edit-group"),this.getContent().removeClassName("attribute-edit-group"),this._setCombinationDisplayMode("none"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:1,combination:this._divCombination,view:this})):1!==this._listOfAttributes.length||this._isGroup(this._listOfAttributes[0])?this._setCombinationDisplayMode("middle"):(this._divCombination.addClassName("attribute-edit-group"),this.getContent().removeClassName("attribute-edit-group"),this._listOfAttributes[0].showRemoveButton(!0),this._listOfAttributes[0].showAddButtons(!1),this._setCombinationDisplayMode("middle"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:1,combination:this._divCombination,view:this}))},_switchDisplayToSingleAttribute:function(){if(0===this._listOfAttributes.length)this._divCombination.removeClassName("attribute-edit-group"),this.getContent().addClassName("attribute-edit-group"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:0,view:this});else if(1===this._listOfAttributes.length)if(this._isGroup(this._listOfAttributes[0]))this._setCombinationDisplayMode("none");else{this._divCombination.removeClassName("attribute-edit-group"),this.getContent().addClassName("attribute-edit-group");var e=this._listOfAttributes[0];e.showRemoveButton(!0),e.showAddButtons(!1),this._setCombinationDisplayMode("light"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:0,view:this})}},isAttrValid:function(){for(var e=[],t=this._listOfAttributes.length,i=0;i<t;i++){var n=this._listOfAttributes[i];if(this._isGroup(n))e=n.isAttrValid();else{var s=n.isAttrValid();if(!s.isValid){var o=s.errorKey;void 0===e[o]&&(e[o]=""),e[o]+="<br>   "+s.errorMsg}}}return!d.isEasyAttributeDisplayMode()||"middle"!==this._displayMode&&"full"!==this._displayMode||(this._combinationCombo.getContent().hide(),this._anyObjectCombination.show()),e},_isGroup:function(e){return!!e._listOfAttributes},removeEmptyAttribute:function(){this._removeEmptyAttribute()},_removeEmptyAttribute:function(){for(var e=this._listOfAttributes.length-1;e>=0;e--){var t=this._listOfAttributes[e];this._isGroup(t)?t._removeEmptyAttribute():t.isAttrEmpty()&&this._onRemoveAttribute({attrId:this._listOfAttributes[e].getContent().id})}},updateMRUOfAttribute:function(){for(var e=this._listOfAttributes.length,t=0;t<e;t++){var i=this._listOfAttributes[t];this._isGroup(i)?i.updateMRUOfAttribute():i.updateMRUOfAttrCombo()}},cleanAttributes:function(){this._divCombination.destroy(),this._removeAttribute()},viewFromMdl:function(e){var t=e.allAttributes,i=[];if(1<t.length||1===t.length&&void 0===t[0].allAttributes){var n={};n.allAttributes=t,n.combination="all",i=this._buildAttributeFromModel(n)}else i=this._buildAttributeFromModel(t[0]);return i},_buildAttributeFromModel:function(e){var t=e.allAttributes;this._combinationCombo.currentValue=e.combination;var i=[];if(void 0!==t)for(var n=t.length,s=0;s<n;s++){if(void 0===t[s].allAttributes){this._listOfAttributes.length<s+1&&this._createAttribute(),(o=this._listOfAttributes[s].attrViewFromMdl(t[s]))&&i.push(o)}else{this._listOfAttributes.length<s+1&&this._onAddAttributeGroup();var o=this._listOfAttributes[s]._buildAttributeFromModel(t[s]);i=i.concat(o)}}return i},saveBeforeEdit:function(){return this._saveBeforeEdit(this)},_saveBeforeEdit:function(e){for(var t=[],i=e._listOfAttributes.length,n=0;n<i;n++){var s=e._listOfAttributes[n];if(this._isGroup(s)){var o=this.model.get("combination"),r=this._saveBeforeEdit(s);t.push({combination:o,attributes:r})}else t.push({combination:this.model.get("combination"),attributes:s.getParams()})}return t},restoreBeforeEdit:function(e){this._restoreBeforeEdit(this,e)},_restoreBeforeEdit:function(e,t){if(e._removeAttribute(),void 0===t)e.createAttribute();else{for(var i=0;i<t.length;i++)Array.isArray(t[i].attributes)?e._onAddAttributeGroup():e.createAttribute();var n=e._listOfAttributes.length;for(i=0;i<n;i++){var s=e._listOfAttributes[i];this._isGroup(s)?(this.model.set("combination",t[i].combination),this._restoreBeforeEdit(s,t[i].attributes)):(this.model.set("combination",t[i].combination),s.setParams(t[i].attributes))}}},updateAttributes:function(e,t){this._selectedType=t||this._selectedType,this._attributes=e,this._updateAttributes(e,t)},_updateAttributes:function(e,t){for(var i=this._listOfAttributes.length-1;i>=0;i--){var n=this._listOfAttributes[i];this._isGroup(n)?n.updateAttributes(e,t):n.reBuildAttributesInfos(e,t)}},isThereCriteria:function(){return!!this._listOfAttributes.length}});return c}),define("DS/ENONextGenFilterUX/views/CriteriaVolumeView",["DS/ENONextGenFilterUX/views/CriteriaAbstractView","UWA/Core","UWA/Class/View","UWA/Class/Model","UWA/Promise","DS/ENONextGenFilterUX/utils/FilterUIService","DS/Handlebars/Handlebars4","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/Controls/Button","css!DS/ENONextGenFilterUX/ENONextGenFilterUX.css","DS/Controls/TooltipModel","DS/ENONextGenFilterUX/views/VolumeCombinationView","text!DS/ENONextGenFilterUX/templates/volumeViewTemplate.html","DS/PlatformAPI/PlatformAPI","DS/ENOFilterBIUX/NGFServices"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,f){"use strict";return e.extend({className:"volumeCriterion",tagName:"li",domEvents:{"click .volumeCriterion-read .volumeRead":"_checkBeforeEdit","click .volumeCriterion-read .volumeRead-multi-attr":"_checkBeforeEdit"},setup:function(e){this._parent(e),this._filterSpecId=e.filterSpecId,this._rootId=e.rootId,this._template=r.compile(p),this.listenTo(this.model,"onChange:state",this.onStateChange.bind(this)),this._sendEvent=e.sendEvent,this._volumeFilterIcon=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/22/I_VolumeFilter.png"),this._volumeTypeIcons=[],this._volumeTypeIcons.box=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/16/Box.png"),this._volumeTypeIcons.sphere=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/16/Sphere.png"),this._volumeTypeIcons.proximity=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/16/Proximity.png"),this._volumeTypeIcons.space=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/16/Space.png")},render:function(){return this.container.setContent(this._template({stateClass:this.model.get("state"),titleClass:a.get("titleVolumeUX"),touchMode:o.FILTER_TOUCH_CLASS})),this._createHeaderCtxMenu(),this._createHeaderIcon(),this.attrEditInputs=this.getElement(".attributeCriterion-edit .attr-edit-inputs"),this.attrEditInputsAttr=this.getElement(".attributeCriterion-edit .attr-edit-inputs-allAttributes"),this.attrEditActions=this.getElement(".attributeCriterion-edit .attr-edit-actions"),this.attrEditInputsAttr.hide(),this.addVolumeBtn=this._createAddVolumeButton(this.attrEditActions),this.addVolumeGroupBtn=this._createAddVolumeGroupButton(this.attrEditActions),this._validateButton=this._createValidateButton(),this._createVolumeCombination(),this.listenTo(this._combinationView,"NGF_RemoveCriterion",this.destroy.bind(this)),this},destroy:function(){o.resetSelectedVolumeOf3D(this._NGFUXId,this._widgetId,this._rootId),this._combinationView&&this._combinationView.destroy(),this.dispatchEvent("NGF_RemoveCriterion",{idxView:this.cid,criteriaType:this.model.get("criteriaType")}),this.stopListening(),this.model=null,this._parent(),this.container=null},_createHeaderIcon:function(){t.createElement("img",{src:this._volumeFilterIcon,height:"22px"}).inject(this.getElement(".attributeCriterion-edit .criteriaIcon"))},_createHeaderCtxMenu:function(){this._createCriterionCtxMenuWUX(this.getElement(".criterionDropDown")),this._setContextualMenu("edit")},_cancelEditCriteria:function(){this._createVolumeCombination(),this.listenTo(this._combinationView,"NGF_RemoveCriterion",this.destroy.bind(this)),this._savedBeforeEdit&&this.viewFromMdl(this._savedBeforeEdit)},onStateChange:function(e,t){this.getElement(".f-volume-container").setAttribute("class","f-volume-container "+t);if("read"===t){var i="",n="",s=this._isThereVolumeActivated(this._combinationView.model);if(s){var o=this.model.criterionToString();i=a.get("volume")+" "+o.shift(),n=this._getVolumeHTML(o)}else i=a.get("noVolumeActivated");var r=[];r.push({tag:"img",src:this._volumeFilterIcon}),r.push({tag:"span",html:i}),this.getElement(".volumeRead").setContent(r),this.getElement(".volumeRead-multi-attr").setContent([{html:n}]),this._setContextualMenu("read"),s||this._switchCriterionState()}else this._savedBeforeEdit=this.model.keepComponentsToFeedUI(!0),this._setContextualMenu("edit"),this.dispatchEvent("NGF_Criterion_SwitchedToEdit")},_isThereVolumeActivated:function(e){for(var t=0,i=e.get("allVolumes")||[],n=i.length,s=0;s<n&&!t;s++){var o=i[s];o.get("allVolumes")?t=this._isThereVolumeActivated(o):"1"===o.get("isActivated")&&(t=1)}return t},_getVolumeHTML:function(e){for(var t="",i=0;i<e.length;i++)if(Array.isArray(e[i])){var n=e[i];t+="<li>"+n[0],t+='<ul class="volumeRead-multi-attr"><div>',n.shift(),t+=this._getVolumeHTML(n),t+="</div></ul></li>"}else{var s=this._getInfosVolumeFromName(e[i],this._combinationView.model),o=s.type?'<img src="'+this._volumeTypeIcons[s.type]+'">':"";t+="<li"+("0"===s.isActivated?' class="f-criterion-deactivated"':"")+">"+o+e[i]+"</li>"}return t},_getInfosVolumeFromName:function(e,t){for(var i={},n=t.get("allVolumes")||[],s=n.length,o=0;o<s&&!i.type;o++){var r=n[o];if(r.get("allVolumes"))i=this._getInfosVolumeFromName(e,r);else if(r.get("displayName")===e){var a=r.get("parameters");i={isActivated:r.get("isActivated"),type:a?a.type:void 0}}}return i},_getDOMElementToUpdateOnActivateChange:function(){var e=[];return e.push(this.getElement("#"+this._getId()+" .volumeCriterion-read .volumeRead")),e.push(this.getElement("#"+this._getId()+" .volumeCriterion-read .volumeRead-multi-attr")),e},_getCallbackToEditCriterion:function(){return this._editVolume.bind(this)},_editVolume:function(){this.model.set("state","edit"),this._combinationView.model.set("state","edit")},_isCriterionModified:function(){var e=!1;if(this.model){var t=this.model.keepComponentsToFeedUI(!0).toString();e=this._savedBeforeEdit!==t}return e},isCriterionValidate:function(){var e=this;if(0===o.isAsynchronousValidation()){this.model.get("state");return!0,e._combinationView.removeEmptyVolume(),o.resetSelectedVolumeOf3D(e._NGFUXId,e._widgetId,e._rootId),o.isModelActivated(e.model)||!0!==e._isCriterionModified()||e._switchCriterionState(),!0}return new s(function(t){e._combinationView.removeEmptyVolume(),o.resetSelectedVolumeOf3D(e._NGFUXId,e._widgetId,e._rootId),o.isModelActivated(e.model)||!0!==e._isCriterionModified()||e._switchCriterionState(),e._savedBeforeEdit=void 0,t(!0)})},viewFromMdl:function(e){this._combinationView.viewFromMdl(e),this._repairInfos=e.repairFilterInfo?{proximityPath:e.proximityPath,repairInfo:e.repairFilterInfo}:{},"0"===e.isActivated&&this._switchCriterionState()},_createVolumeCombination:function(){this._combinationView&&(this._combinationView.destroy(),this.model.set("allVolumes",[]));var e=new n;e.set("isActivated","1"),e.set("state","edit");var t=[];t.push(e),this.model.set("allVolumes",t),this._combinationView=new h({UXId:this._UXId,NGFUXId:this._NGFUXId,widgetId:this._widgetId,rootId:this._rootId,model:e,attrEditInputs:this.attrEditInputs,attrEditInputsAttr:this.attrEditInputsAttr,sendEvent:this._sendEvent,filterSpecId:this._filterSpecId}),this._combinationView.render().inject(this.attrEditInputs),this.listenTo(this._combinationView,"NGF_SwitchDisplayContext",this._onSwitchDisplayContext.bind(this)),this.listenTo(this._combinationView,"NGF_DisplayAddActions",this._onDisplayAddActions.bind(this)),this.listenTo(this._combinationView,"NGF_SwitchToEdit",this._checkBeforeEdit.bind(this)),this._combinationView._sendEvent=1,this._sendEvent=1},_onSwitchDisplayContext:function(e){1===e.context?(e.combination.inject(this.attrEditInputs),e.view.inject(this.attrEditInputsAttr),this.attrEditInputsAttr.show()):(e.view.inject(this.attrEditInputs),this.attrEditInputsAttr.hide());var t=this.getElement(".attribute-edit-add-btn2");t.inject(this.attrEditActions),(t=this.getElement(".attribute-edit-addGroup-btn2")).inject(this.attrEditActions),(t=this.getElement(".attributeCriterion-edit-validate")).inject(this.attrEditActions)},_onDisplayAddActions:function(e){var t=this.attrEditActions.getElement(".attribute-edit-add-btn2"),i=this.attrEditActions.getElement(".attribute-edit-addGroup-btn2");t&&i&&e.display&&(t.show(),i.show())},_createAddVolumeButton:function(e){if(this.addVolumeBtn)return this.addVolumeBtn;var t=new d(o.getAttributeButtonStyle("plus"));t.inject(e),t.tooltipInfos=new u({shortHelp:a.get("AddVolume"),mouseRelativePosition:!0});var i="attribute-edit-button-style attribute-edit-add-btn2"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i);var n=this;return t.addEventListener("click",function(e){n._cleanSelected(),n._combinationView.createVolume()}),t},_createAddVolumeGroupButton:function(e){if(this.addVolumeGroupBtn)return this.addVolumeGroupBtn;var t=new d(o.getAttributeButtonStyle("group-add"));t.inject(e),t.tooltipInfos=new u({shortHelp:a.get("AddVolumeGroup"),mouseRelativePosition:!0});var i="attribute-edit-button-style attribute-edit-addGroup-btn2"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i);var n=this;return t.addEventListener("click",function(e){n._cleanSelected(),n._combinationView.createVolumeGroup()}),t},_cleanSelected:function(){var e=this.getElement(".attribute-edit-group-selected");e&&e.removeClassName("attribute-edit-group-selected")},_createValidateButton:function(){var e=new d(o.getAttributeValidateButtonStyle());e.inject(this.attrEditActions),e.tooltipInfos=new u({shortHelp:a.get("ValidateCriteria"),mouseRelativePosition:!0});var t="attribute-edit-button-style  attributeCriterion-edit-validate";t+=(this.sequenceMode?"":" colorized")+o.FILTER_TOUCH_CLASS,e.getContent().addClassName(t);var i=this;return e.addEventListener("buttonclick",function(){0===o.isAsynchronousValidation()?i.isCriterionValidate()&&i.model&&i.dispatchEvent("NGF_Criterion_Validation",{criteriaType:i.model.get("criteriaType")}):i.isCriterionValidate().then(function(e){e&&i.model&&i.dispatchEvent("NGF_Criterion_Validation",{criteriaType:i.model.get("criteriaType")})})}),e},isThereCriteria:function(){return!!this._combinationView&&function(e){for(var t=0,i=e.get("allVolumes")||[],n=i.length,s=0;s<n&&!t;s++){var o=i[s];t=o.get("allVolumes")?this._isThereCriteria(o):o.get("parameters")?1:0}return t}(this._combinationView.model)},getEditedVolume:function(){var e=function(t){for(var i,n=t.get("allVolumes")||[],s=n.length,o=0;o<s&&!i;o++){var r=n[o];r.get("allVolumes")?i=e(r):"edit"===r.get("state")&&(i=r)}return i};return e(this._combinationView.model)},setVolumeAsEdited:function(e){this.getElement("#"+e.get("id")+" .innerVolumeFilterHeader").click()},updateModelFromRepair:function(e){e[0];var t=this._repairInfos.repairInfo.brokenProximity,i=this._repairInfos.repairInfo.brokenLogicalDB,n=[],s=[],o=[];e[1].forEach(function(e){e.attributes.forEach(function(t){if("resourceid"===t.name)n.push(t.value);else if("logicalid"===t.name)s.push(t.value);else if("ds6w:label"===t.name){var i=e.attributes.findIndex(e=>"ds6wg:revision"===e.name);o.push(t.dispValue+(-1===i?"":" - "+e.attributes[i].value))}})});var r=function(e,a){for(var l=!1,d=e.get("allVolumes")||[],c=d.length,u=0;u<c;u++){var h=d[u];if(h.get("allVolumes"))l=r(h,a);else{var p=h.get("parameters");if("proximity"===p.type){var _=p.root_path_physicalid,f=(_=_.length?_[0]:[]).toString();t.forEach((e,t)=>{if(f===e[t].toString()){var r=e[t].length;p.root_path_physicalid.splice(0),p.root_path_alias.splice(0);var a=[],d=[];i.forEach(e=>{e.forEach(e=>{var t=s.indexOf(e);-1!==t&&(a.push(n[t]),d.push(o[t]))})}),r===a.length?(p.root_path_physicalid.push(a),p.root_path_alias=d,p.isRepaired=1):h.set("parameters",void 0),l=!0}})}}}return l},a=r(this.model,e);return{modelUpdated:a,attributes:a?this.model:void 0}},buildViewFromRepairModel:function(e){this._combinationView.removeEmptyVolume(),this.model&&(this.model.unset("repairFilterInfo"),this._repairInfos=void 0,this.model.set("state","edit"),this.viewFromMdl(e.keepComponentsToFeedUI()),this.model.set("state","read"))}})}),define("DS/ENONextGenFilterUX/views/CriteriaAttributeView",["DS/ENONextGenFilterUX/views/CriteriaAbstractView","UWA/Core","UWA/Class/View","UWA/Class/Model","UWA/Promise","DS/ENONextGenFilterUX/utils/FilterUIService","DS/Handlebars/Handlebars4","text!DS/ENONextGenFilterUX/templates/attributeViewTemplate.html","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/ENONextGenFilterUX/utils/EditToReadManager","DS/Controls/ComboBox","DS/Controls/Button","DS/UIKIT/Mask","DS/Controls/Loader","css!DS/ENONextGenFilterUX/ENONextGenFilterUX.css","DS/ENONextGenFilterUX/views/AttributeCombinationView","DS/Controls/TooltipModel","DS/FedDictionaryAccess/FedDictionaryAccessAPI","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/NGFServices"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,f,m,g,v,b,C){"use strict";return e.extend({domEvents:{"click .attributeCriterion-read .attrRead":"_checkBeforeEdit","click .attributeCriterion-read .attrRead-multi-attr":"_checkBeforeEdit"},className:"attributeCriterion",tagName:"li",setup:function(e){this._parent(e),this._loaderContainer=document&&document.body?document.body.getElement(".f-globalFilter-container"):void 0,this.types=e.types,this._synthesisInfos=e.synthesisInfos,this._synthesisState=e.synthesisState||-1,this.customizeCtxMenu=e.customizeCtxMenu,this.sequenceMode=e.sequenceMode,this.keepValue=!1===e.keepValue||0===e.keepValue?0:1,this._template=r.compile(a),this.listenTo(this.model,"onChange:state",this.onStateChange.bind(this)),this.listenTo(this.model,"onChange:Keep",this.onKeepChange.bind(this)),this.listenTo(this.model,"onChange:type",this.onTypeChange.bind(this)),this.container.addEvent("click",function(e){return e.stopPropagation(),!1}),this._selectedType="",this._selectedSubType="",this._needToQueryServer=!0,this.isCancelEditCrteriaActivated=!1,this._attributesOfType=[],this._attributesOfExtension=[],e.listAttrFromType&&(this.subTypes=e.fromCriterionMdl.subTypes,this._attributesOfType=e.listAttrFromType,this._needToQueryServer=!1,this._keepRemoveCombo=e.fromCriterionMdl.Keep,this._selectedType=e.fromCriterionMdl.type,this._selectedSubType=e.fromCriterionMdl.extension,e.listAttrFromSubType&&(this._attributesOfExtension=e.listAttrFromSubType),this.attributes=this._attributesOfType.concat(this._attributesOfExtension),this._updateAttributesWithSynthesis(this.attributes,this._synthesisInfos)),this._savedBeforeEdit={},this._isTrackerOnTypeSet=0,o.setEasyAttributeDisplayMode(C.isActivated("easyAttribute"))},render:function(){return this.container.setContent(this._template({stateClass:this.model.get("state"),titleClass:l.get("titleAttributeUX"),touchMode:o.FILTER_TOUCH_CLASS})),this.attrEditInputs=this.getElement(".attributeCriterion-edit .attr-edit-inputs"),this.attrEditInputsAttr=this.getElement(".attributeCriterion-edit .attr-edit-inputs-allAttributes"),this.attrEditActions=this.getElement(".attributeCriterion-edit .attr-edit-actions"),o.TOUCH_MODE?this.attrEditActions.removeClassName(o.FILTER_TOUCH_CLASSNAME):this.attrEditActions.addClassName(o.FILTER_TOUCH_CLASSNAME),this.attrEditInputsAttr.hide(),this._loaderContainer=this._loaderContainer||this.attrEditInputs,this._createHeaderCtxMenu(),this._createHeaderIcon(),this.addAttributeBtn=this._createAddAttributeButton(this.attrEditActions),this.addAttributeGroupBtn=this._createAddAttributeGroupButton(this.attrEditActions),this._addAttributeSequenceBtn=this._createAddAttrSequenceButton(this.attrEditActions),this._validateButton=this._createValidateButton(),this._setEnableButtons(!1),this.sequenceMode&&this._addAttributeSequenceBtn.hide(),this.createKeepRemoveDropDown(this.keepValue),this.setSequenceMode(this.sequenceMode),this},onTypeChange:function(e,t){this._validateButton&&t&&(this._validateButton.disabled=!1)},_createValidateButton:function(){var e=new h(o.getAttributeValidateButtonStyle());e.inject(this.attrEditActions),e.tooltipInfos=new g({shortHelp:l.get("ValidateCriteria"),mouseRelativePosition:!0});var t="attribute-edit-button-style"+o.FILTER_TOUCH_CLASS;e.getContent().addClassName(t+" attributeCriterion-edit-validate"+(this.sequenceMode?"":" colorized"));var i=this;return e.addEventListener("buttonclick",function(){0===o.isAsynchronousValidation()?i.isCriterionValidate()&&(i._savedBeforeEdit={},i.dispatchEvent("NGF_Criterion_Validation",{criteriaType:i.model.get("criteriaType")})):i.isCriterionValidate().then(function(e){e&&(C.setUsageTracker(i._widgetId,"NGF-Attribute-OnType",i.typeCombo.currentValue),i._isTrackerOnTypeSet=1,i._savedBeforeEdit={},i.dispatchEvent("NGF_Criterion_Validation",{criteriaType:i.model.get("criteriaType")}))})}),e},_createAddAttrSequenceButton:function(e){var t=new h(o.getAttributeButtonStyle("list-ordered"));t.inject(e),t.tooltipInfos=new g({shortHelp:l.get("AddAttributeSequence"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attributeCriterion-edit-addSequence-btn");var n=this;return t.addEventListener("buttonclick",function(e){C.setUsageTracker(n._widgetId,"NGF-Attribute","Create_Sequence"),n.dispatchEvent("NGF_SwitchCriterionToSequence",{type:n.model.get("criteriaType"),idxView:n.cid,attributeKeep:n.model.get("Keep")})}),t},isCriterionValid:function(){var e="read"!==this.model.get("state"),t=!e;if(e){var i=this._attrCombinationView.isAttrValid(),n=Object.keys(i);if(t=!n.length)o.isEasyAttributeDisplayMode()?(this._anyObjectObject.show(),this._anyObjectKeep.show(),this._keepRemoveCombo.getContent().hide(),this.typeCombo.getContent().hide(),o.FILTER_ANY_OBJECT!==this._selectedType&&(this._extensionLabel.show(),this._extensionBtn.show(),this.subTypeCombo.getContent().hide())):(this._anyObjectObject&&this._anyObjectObject.hide(),this.typeCombo.getContent().show());else{for(var s="",r=0;r<n.length;r++){var a=n[r];s+=0===r?l.get(a)+i[a]:"<br><br>"+(r+1)+". "+l.get(a)+i[a]}s.length&&(s=1<n.length?"1. "+s:s,o.displayNotification({level:"error",message:s}))}}return t},isCriterionValidate:function(){var e,t=this;if(0===o.isAsynchronousValidation())return(e="read"===this.model.get("state"))||(e=this.isCriterionValid())&&(t._attrCombinationView.removeEmptyAttribute(),o.isModelActivated(t.model)||!0!==t._isCriterionModified()||t._switchCriterionState()),e;if(e="read"===this.model.get("state"))return new s(function(e){e(!0)});var i=this.isCriterionValid();return new s(i?function(e){t._attrCombinationView.removeEmptyAttribute(),o.isModelActivated(t.model)||!0!==t._isCriterionModified()||t._switchCriterionState(),e(!0)}:function(e){e(!1)})},_getCallbackToEditCriterion:function(){return this.editAttribute.bind(this)},editAttribute:function(){this._savedBeforeEdit=c.getAttributeValues(this.model),this._savedBeforeEdit.types=this.types,this._savedBeforeEdit.subTypes=this.subTypes,this._savedBeforeEdit.attributes=this.attributes,this.subTypeCombo&&(this._savedBeforeEdit.elementsListExtension=this.subTypeCombo.elementsList),this._savedBeforeEdit.typeInfosLabel=this._keepTypeInfosFromLabel,this._savedBeforeEdit.subTypeInfosLabel=this._keepExtensionInfosFromLabel;var e=this._attrCombinationView.saveBeforeEdit();this._savedBeforeEdit.saveAttributes=e,this._savedBeforeEdit.asString=JSON.stringify(this.model.keepComponentsToFeedUI(!0)),this.model.set("state","edit"),this.dispatchEvent("NGF_Criterion_SwitchedToEdit")},_cancelEditCriteria:function(){if(this._isCriterionModified()){if(this.isCancelEditCrteriaActivated=!0,void 0===this._savedBeforeEdit.type)C.isActivated("easyAttribute")?this.typeCombo.currentValue="anyObject":(this.typeCombo.selectedIndex=0,this._extensionBtn.show()),this._keepRemoveCombo.currentValue=!0,this._extensionBtn&&(this.subTypeCombo.selectedIndex=-1,this.subTypeCombo.hide()),this._attrCombinationView.restoreBeforeEdit(this._savedBeforeEdit.saveAttributes);else{this._keepRemoveCombo.currentValue=void 0===this._savedBeforeEdit.Keep||this._savedBeforeEdit.Keep,this.types=this._savedBeforeEdit.types,this._keepTypeInfosFromLabel=this._savedBeforeEdit.typeInfosLabel;for(var e=Object.keys(this._keepTypeInfosFromLabel),t=0;t<e.length;t++)if(this._savedBeforeEdit.type===this._keepTypeInfosFromLabel[e[t]].value){this.typeCombo.currentValue=this._keepTypeInfosFromLabel[e[t]].value;break}if(this.subTypes=this._savedBeforeEdit.subTypes,this._keepExtensionInfosFromLabel=this._savedBeforeEdit.subTypeInfosLabel,this.subTypeCombo.elementsList=this._savedBeforeEdit.elementsListExtension,void 0===this._savedBeforeEdit.extension)this._extensionBtn.show(),this.subTypeCombo.hide(),this.subTypeCombo.selectedIndex=-1;else for(e=Object.keys(this._keepExtensionInfosFromLabel),t=0;t<e.length;t++)if(this._savedBeforeEdit.extension===this._keepExtensionInfosFromLabel[e[t]].value){this.subTypeCombo.currentValue=this._keepExtensionInfosFromLabel[e[t]].value;break}this._attrCombinationView.restoreBeforeEdit(this._savedBeforeEdit.saveAttributes),this._savedBeforeEdit&&c.setAttributeValues(this.model,this._savedBeforeEdit)}this.isCancelEditCrteriaActivated=!1}},_createHeaderIcon:function(){t.createElement("img",{src:d.getWebappsAssetUrl("ENONextGenFilterUX","icons/22/I_AttributeFilter.png"),height:"22px"}).inject(this.getElement(".attributeCriterion-edit .criteriaIcon"))},_createHeaderCtxMenu:function(){this._createCriterionCtxMenuWUX(this.getElement(".criterionDropDown")),this._setContextualMenu("edit")},onKeepChange:function(e){!1===e.get("Keep")?this.dispatchEvent("NGF_AttrKeepToRemoveMode"):this.dispatchEvent("NGF_AttrRemoveToKeepMode")},_onDelayedEditAttribute:function(){this.onStateChange(this.model,"edit")},onStateChange:function(e,t){var i=this.model.criterionToString();if("string"==typeof i||Array.isArray(i)){this._isTrackerOnTypeSet||(C.setUsageTracker(this._widgetId,"NGF-Attribute-OnType",this.typeCombo.currentValue),this._isTrackerOnTypeSet=1),this.getElement(".f-attribute-container").setAttribute("class","f-attribute-container "+t);this.customizeCtxMenu;if("read"===t){var n=Array.isArray(i)?i:[i],s=n[0];n.shift();var o=this._getAttributeHTML(n),r=[];r.push({tag:"img",src:d.getWebappsAssetUrl("ENONextGenFilterUX","icons/22/I_AttributeFilter.png")}),r.push({tag:"span",html:s});var a=this.getElement(".attrRead");a.setContent(r),this.sequenceMode?a.getElement("img").hide():a.getElement("img").show(),this.getElement(".attrRead-multi-attr").setContent([{html:o}]),this._setContextualMenu("read")}else if(-1===this._synthesisState)this.dispatchEvent("NGF_ComputeSynthesis",{callback:this._onDelayedEditAttribute.bind(this)});else{this.isThereCriteria()&&!this._attrCombinationView.isThereCriteria()&&this._attrCombinationView.createAttribute();var l=this.getElement("#"+this._getId()+" .criteriaIcon");this.sequenceMode?l.hide():l.show(),this._setContextualMenu("edit"),C.isActivated("easyAttribute")||this._buildOldExtensionUI(),this._attrCombinationView.updateMRUOfAttribute()}}else"object"==typeof i&&console.log("Criteria Attribute Error / Invalid expected type on state change")},_getAttributeHTML:function(e){for(var t="",i=0;i<e.length;i++)if(Array.isArray(e[i])){var n=e[i];t+="<li>"+n[0],t+='<ul class="attrRead-multi-attr"><div>',n.shift(),t+=this._getAttributeHTML(n),t+="</div></ul></li>"}else t+="<li>"+e[i]+"</li>";return t},createKeepRemoveDropDown:function(e){var i=[{labelItem:l.get("keep"),valueItem:!0},{labelItem:l.get("remove"),valueItem:!1}];this._keepRemoveCombo=new u({touchMode:o.TOUCH_MODE,elementsList:i,placeholder:l.get("keepRemoveLabel"),enableSearchFlag:!1,selectedIndex:e?0:1}),this._keepRemoveCombo.inject(this.attrEditInputs),this._keepRemoveCombo.getContent().addClassName("filter-anyobject-off"),this.model.set("Keep",!!e);var n=this;this._keepRemoveCombo.addEventListener("change",function(e){n.model.set("Keep",e.dsModel.currentValue),n._anyObjectKeepAnchor&&n._anyObjectKeepAnchor.setText(e.dsModel.currentLabel)}),(n=this)._anyObjectKeep=t.createElement("label",{class:"innerfiltertypecombo filter-anyobject-on"}),n._anyObjectKeep.inject(n._keepRemoveCombo.getContent(),"after"),n._anyObjectKeepAnchor=t.createElement("a",{text:l.get(e?"keep":"remove"),id:"anyObject_keep"}),n._anyObjectKeepAnchor.inject(n._anyObjectKeep),n._anyObjectKeepAnchor.addEventListener("click",function(e){if(!e.target.disabled){var t=!n.model.get("Keep");n.model.set("Keep",t),e.target.setText(l.get(t?"keep":"remove")),n._keepRemoveCombo.currentValue=t}});var s=!this.sequenceMode;this.setEnableKeepRemove(s),n._keepRemoveCombo.getContent().removeClassName("filter-anyobject-off"),n._keepRemoveCombo.hide(),n._anyObjectKeep.removeClassName("filter-anyobject-on")},selectTypes:function(e,i){if(this.types=e?t.clone(e):void 0,this.types){var n=o.isEasyAttributeDisplayMode(),s=-1;if(n&&-1===(s=this.types.findIndex(e=>o.FILTER_ANY_OBJECT===e.name))&&(this.types.push({nlsName:l.get("anyObject"),name:o.FILTER_ANY_OBJECT}),s=this.types.length-1),this.typeCombo=this._buildAndFeedCombo("type",this.types,this._childGroupId),this.typeCombo.addEventListener("change",this._onSelectType.bind(this)),n&&!this._anyObjectObject&&(this._buildEasyUI(),this._anyObjectObject.show(),this._anyObjectKeep.show(),this._keepRemoveCombo.getContent().hide(),this.typeCombo.getContent().hide()),void 0===i)if(n)i=s;else i=-1,i=-1===(i=this.types.findIndex(function(e){return!(!e||"VPMReference"!==e.name)}))?0:i;this.typeCombo.selectedIndex=i}},_onSelectType:function(e){var t=e.dsModel.currentLabel,i=this._keepTypeInfosFromLabel[t];if(i){this._isTrackerOnTypeSet=0;var n=this.model.get("type");if(i=i.value,this._needToQueryServer=!this.isCancelEditCrteriaActivated&&this._selectedType!==i,this._selectedType=i,this.model.set("type",i),this.model.set("nlsType",t),this._anyObjectObject&&this._anyObjectObjectAnchor.setText(t),o.setEasyAttributeDisplayMode(!1),o.FILTER_ANY_OBJECT===i)o.setEasyAttributeDisplayMode(!0),this.getElements(".filter-anyobject-off").forEach(e=>e.hide()),this.getElements(".filter-anyobject-on").forEach(e=>e.show());o.FILTER_ANY_OBJECT===n&&this._switchUIFromObjectsToType(i),this._cleanSubTypes(),C.isActivated("easyAttribute")?this._buildExtensionUI():this._buildOldExtensionUI(),this._selectAttributes(i),this._setEnableButtons(!0)}else this._cleanTypes(),this._setEnableButtons(!1);this._selectedSubType="",this._attributesOfExtension=[],this.model.set("extension",""),this.model.set("nlsExtension","")},_buildEasyUI:function(){var e=this;e.getElements(".filter-anyobject-on").forEach(e=>e.remove()),e._anyObjectObject=t.createElement("label",{class:"innerfiltertypecombo filter-anyobject-on"}),e._anyObjectObject.inject(e.typeCombo.getContent(),"after"),e._anyObjectObjectAnchor=t.createElement("a",{text:l.get("anyObject"),id:"anyObject_object"}),e._anyObjectObjectAnchor.inject(e._anyObjectObject),e._anyObjectObjectAnchor.addEventListener("click",function(t){e._anyObjectObject.hide(),e.typeCombo.show()})},_getAttributesOfType:function(e){return new s(function(t,i){var n=[];n.push("ds6wg:"+e);var s=[];v.getPropertiesForClass(n,{tenantId:C.getTenant(),lang:b.getLanguage().toLowerCase(),apiVersion:"R2019x",onComplete:function(e){e.forEach(function(e){var t=e.properties;t.forEach(function(e){e.rangeValues&&(e.rangeValues={literalInfo:e.rangeValues})}),s=s.concat(t)}),t(s)},onFailure:function(e){i(s)}})})},_switchUIFromObjectsToType:function(e){var t=this;this._getAttributesOfType(e).then(function(e){t._attributesOfType=e,t._attributesOfExtension=[],t.attributes=t._attributesOfType,t.updateSynthesis(),t.getElements(".filter-anyobject-on").forEach(e=>e.hide()),t.getElements(".filter-anyobject-off").forEach(e=>e.show()),t.getElements(".filter-anyobject-off-display-off").forEach(e=>e.hide())},function(e){})},_setEnableButtons:function(e){var t=!e;this.addAttributeBtn.disabled=t,this.addAttributeGroupBtn.disabled=t,this._addAttributeSequenceBtn.disabled=t,this._validateButton.disabled=t},_buildExtensionUI:function(){var e=this;void 0===this.subTypeCombo?(this._extensionLabel=t.createElement("label",{class:"innerfiltertypecombo",text:l.get("without"),id:"with_extension_"+this._childGroupId}),this._extensionLabel.inject(this.attrEditInputs),this._extensionLabel.addClassName("filter-anyobject-off"),this._extensionBtn=new h({touchMode:o.TOUCH_MODE,displayStyle:"lite",label:l.get("SelectExtension"),domId:"SelectExtension_"+this._childGroupId}),this._extensionBtn.inject(this.attrEditInputs),this._extensionBtn.getContent().addClassName("attributeCriterion-edit-SelectExtension filter-anyobject-off"),o.isEasyAttributeDisplayMode()&&o.FILTER_ANY_OBJECT===this._selectedType&&(this._extensionLabel.hide(),this._extensionBtn.hide()),this._extensionBtn.addEventListener("buttonclick",function(t){t.target.hide(),e.subTypeCombo&&e.subTypeCombo.show("slow"),e._selectedSubType||e._computeExtensionsAndUpdateUI(e._keepTypeInfosFromLabel[e.typeCombo.currentLabel].value)}),this.subTypeCombo=this._buildAndFeedCombo("extension",[],this._childGroupId),this.subTypeCombo.getContent().addClassName("filter-anyobject-off filter-anyobject-off-display-off"),this.subTypeCombo.hide(),this.subTypeCombo.addEventListener("change",function(t){var i="",n="",s=t.dsModel.currentLabel,o=e._keepExtensionInfosFromLabel[s];if(o&&(n=i=o.value,e._needToQueryServer=!e.isCancelEditCrteriaActivated&&e._selectedSubType!==i),e._selectedSubType=i,e.model.set("extension",i),e.model.set("nlsExtension",""===i?i:s),i?e._extensionBtn.label=s:(e._extensionBtn.label=l.get("SelectExtension"),e._extensionLabel.setText(l.get("without"))),!e.isCancelEditCrteriaActivated)if(e._selectedSubType){var r="ds6wg:"+n;v.getPropertiesForClass(r,{tenantId:C.getTenant(),lang:b.getLanguage().toLowerCase(),apiVersion:"R2019x",onComplete:function(t){e._attributesOfExtension=t.length?t[0].properties:[],e.attributes=e._attributesOfType.concat(e._attributesOfExtension),e.updateSynthesis()},onFailure:function(e){}})}else e._attributesOfExtension=[],e.attributes=e._attributesOfType,e.updateSynthesis()})):this._extensionBtn&&0===o.isEasyAttributeDisplayMode()&&(this._extensionLabel.setText(l.get("without")),this._extensionLabel.show(),this._extensionBtn.label=l.get("SelectExtension"),this._extensionBtn.show(),this.subTypeCombo||(this.subTypeCombo=this._buildAndFeedCombo("extension",[],this._childGroupId)),this.subTypeCombo.hide(),this.subTypeCombo.getContent().addClassName("filter-anyobject-off-display-off"))},_computeExtensionsAndUpdateUI:function(e){if(e)if(!1===this._needToQueryServer&&this.subTypes)C.isActivated("easyAttribute")?this._updateExtensionUI():this._updateOldExtensionUI();else{this.subTypeCombo&&p.mask(this._loaderContainer,t.String.format(l.get("LoaderForExtensions"),this.model.get("nlsType")));var i=this,n=e;v.getExtensionsForClass(n,{tenantId:C.getTenant(),lang:b.getLanguage().toLowerCase(),onComplete:function(e){i.subTypes=[];var t=e.extensions;t&&t.length&&(i.subTypes=i._updateExtensionWithSynthesis(t,i._synthesisInfos)),C.isActivated("easyAttribute")?i._updateExtensionUI():i._updateOldExtensionUI(),1===i.subTypes.length&&i.subTypeCombo&&(i.subTypeCombo.selectedIndex=0)},onFailure:function(e){i.subTypes=[]}})}},_updateExtensionUI:function(){var e=this.getContent().getElement("#No_Extension_Available");if(e&&e.remove(),0===this.subTypes.length){if(this._extensionBtn.hide(),this.subTypeCombo.hide(),e=this.getContent().getElement("#"+this._extensionBtn.domId)){var i=t.createElement("label",{class:"innerfiltertypecombo",text:l.get("SelectExtension"),id:"No_Extension_Available"});e.parentNode.replaceChild(i,e)}o.displayNotification({level:"info",message:l.get("NoExtensionAvailable")}),p.unmask(this._loaderContainer)}else(e=this.getContent().getElement("#with_extension_"+this._childGroupId))&&e.setText(l.get("with")),this.subTypeCombo&&(this._buildAndFeedCombo("extension",this.subTypes,this._childGroupId,this.subTypeCombo),p.unmask(this._loaderContainer)),(e=this.getContent().getElement("#"+this._extensionBtn.domId))&&e.hide()},_cleanTypes:function(){this.typeCombo&&this.typeCombo.elements&&(this.typeCombo.selectedIndex=-1,this._cleanSubTypes(),this._attrCombinationView&&this._attrCombinationView.cleanAttributes())},_cleanSubTypes:function(){this.subTypeCombo&&this.subTypeCombo.elements&&(this.subTypeCombo.elements.container.remove(),delete this.subTypeCombo),this._extensionLabel&&(this._extensionLabel.remove(),delete this._extensionLabel),this._extensionBtn&&(this._extensionBtn.remove(),delete this._extensionBtn)},_displayLoader:function(e){this.loaderAttributes?"on"===e?this.loaderAttributes.on():this.loaderAttributes.off():"on"===e?p.mask(this._loaderContainer,t.String.format(l.get("LoaderForAttributes"),this.model.get("nlsType"))):p.unmask(this._loaderContainer)},_selectAttributes:function(e){if(e)if(!1===this._needToQueryServer&&this.attributes)this._createAttributeCombinationView();else{var t=this;0,this._displayLoader("on");var i=function(e){t._displayLoader("off"),t._attributesOfType=e,t.attributes=t._attributesOfType,t._needToQueryServer=t.isCancelEditCrteriaActivated,t._updateAttributesWithSynthesis(e,t._synthesisInfos),t._createAttributeCombinationView(),t.subTypeCombo.hide(),o.isEasyAttributeDisplayMode()||t._extensionBtn.show(),t.subTypes=void 0},n=function(e){t._displayLoader("off"),t._updateAttributesWithSynthesis(t.attributes,t._synthesisInfos),t._createAttributeCombinationView()};o.FILTER_ANY_OBJECT===e?o.computeAttributesFromSynthesis(this._synthesisInfos).then(function(e){i(e)},function(e){n()}):this._getAttributesOfType(e).then(function(e){i(e)},function(e){n()})}},_buildAndFeedCombo:function(e,i,n,s){var r=[],a=0;switch(e){case"type":this._keepTypeInfosFromLabel={};break;case"extension":this._keepExtensionInfosFromLabel={},a=1}var d=this;if(i.forEach(function(t){var i,n;switch(e){case"type":i=t.nlsName,n=t.name,d._keepTypeInfosFromLabel[i]||(d._keepTypeInfosFromLabel[i]={}),d._keepTypeInfosFromLabel[i]={value:n};break;case"extension":i=t.label||t.nlsName,n=(n=t.curi||t.name).substring(n.indexOf(":")+1),d._keepExtensionInfosFromLabel[i]||(d._keepExtensionInfosFromLabel[i]={}),d._keepExtensionInfosFromLabel[i]={value:n}}r.push({valueItem:n,labelItem:i})}),!s){var c=1===r.length?0:-1,h=t.String.format(l.get("placeHolderSelectEntity"),l.get(e)),p=new u({touchMode:o.TOUCH_MODE,actionOnClickFlag:!0,elementsList:a?r.sort(d._alphabeticSort):r,preselectedIndex:c,placeholder:h,autocompleteFlag:!1,generateRegexpString:function(e){return e}});return p.inject(this.attrEditInputs),p.getContent().addClassName("attributeCriterion-edit-"+e+("type"===e?" filter-anyobject-off":"")),p}s.elementsList=a?r.sort(d._alphabeticSort):r},_alphabeticSort:function(e,t){var i=0;return void 0!==e&&void 0!==t&&(i=e.labelItem<=t.labelItem?-1:1),i},_getDOMElementToUpdateOnActivateChange:function(){var e=[];return e.push(this.getElement("#"+this._getId()+" .attributeCriterion-read .attrRead")),e.push(this.getElement("#"+this._getId()+" .attributeCriterion-read .attrRead-multi-attr")),e},destroy:function(){this._attrCombinationView&&this._attrCombinationView.destroy(),this.dispatchEvent("NGF_RemoveCriterion",{idxView:this.cid,criteriaType:this.model.get("criteriaType")}),this.stopListening(),this.model=null,this._parent(),this.container=null},_isCriterionModified:function(){var e=JSON.stringify(this.model.keepComponentsToFeedUI(!0));return this._savedBeforeEdit.asString!==e},viewFromMdl:function(e){void 0===e.Keep&&(e.Keep=this.model.get("Keep")),e.isActivated||(e.isActivated=this.model.get("isActivated")),e.extension||(e.extension=this.model.get("extension")),void 0!==this._keepRemoveCombo&&(this._keepRemoveCombo.currentValue=e.Keep,this._anyObjectKeepAnchor&&this._anyObjectKeepAnchor.setText(l.get(!1===e.Keep?"remove":"keep"))),this.typeCombo.currentValue=e.type,e.extension&&(this._extensionBtn.hide(),this.subTypeCombo.show(),this._computeExtensionsAndUpdateUI(e.type),this.subTypeCombo.currentValue=e.extension);var t=this._attrCombinationView.viewFromMdl(e);return t.length&&this._attrCombinationView.removeEmptyAttribute(),"0"===e.isActivated&&this._switchCriterionState(),o.isEasyAttributeDisplayMode()?(this._anyObjectObject.show(),this._anyObjectKeep.show(),this._keepRemoveCombo.getContent().hide(),this.typeCombo.getContent().hide(),o.FILTER_ANY_OBJECT!==this._selectedType&&(this._extensionLabel.show(),this._extensionBtn.show(),this.subTypeCombo.getContent().hide())):(this._anyObjectObject&&this._anyObjectObject.hide(),this.typeCombo.getContent().show()),t},_createAttributeCombinationView:function(){this._attrCombinationView&&(this._attrCombinationView.destroy(),(e=this.model.get("allAttributes")||[]).splice(0),this.model.set("allAttributes",e));var e,t=new n;(e=this.model.get("allAttributes")||[]).push(t),this.model.set("allAttributes",e),this._attrCombinationView=new m({model:t,widgetId:this._widgetId,selectedType:void 0!==this.model.get("nlsType")&&void 0!==this._keepTypeInfosFromLabel?this._keepTypeInfosFromLabel[this.model.get("nlsType")].value:"",selectedExtension:this._selectedSubType,attributesUsed:this.attributes,attrEditInputs:this.attrEditInputs,attrEditInputsAttr:this.attrEditInputsAttr}),this._attrCombinationView.render().inject(this.attrEditInputs);var i=this._attrCombinationView._listOfAttributes.length;i&&this._attrCombinationView._listOfAttributes[i-1].setFocus(),this.listenTo(this._attrCombinationView,"NGF_SwitchDisplayContext",this._onSwitchDisplayContext.bind(this)),this.listenTo(this._attrCombinationView,"NGF_DisplayAddActions",this._onDisplayAddActions.bind(this))},_onSwitchDisplayContext:function(e){1===e.context?(e.combination.inject(this.attrEditInputs),e.view.inject(this.attrEditInputsAttr),this.attrEditInputsAttr.show()):(e.view.inject(this.attrEditInputs),this.attrEditInputsAttr.hide())},_onDisplayAddActions:function(e){var t=this.attrEditActions.getElement(".attribute-edit-add-btn2"),i=this.attrEditActions.getElement(".attribute-edit-addGroup-btn2");t&&i&&e.display&&(t.show(),i.show())},_createRefeshSynthesisButton:function(e){var t=new h(o.getAttributeButtonStyle("refresh"));t.inject(e||this._Div),t.tooltipInfos=new g({shortHelp:l.get("RefreshSynthesisInfosTooltip"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attributeCriterion-edit-refresh-btn");var n=this;return t.addEventListener("buttonclick",function(e){C.setUsageTracker(n._widgetId,"NGF-Attribute","Refresh"),n.dispatchEvent("NGF_RefreshSynthesis")}),t},_createAddAttributeButton:function(e){if(this.addAttributeBtn)return this.addAttributeBtn;var t=new h(o.getAttributeButtonStyle("plus"));t.inject(e||this._Div),t.tooltipInfos=new g({shortHelp:l.get("AddAttribute"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attribute-edit-add-btn2");var n=this;return t.addEventListener("buttonclick",function(e){C.setUsageTracker(n._widgetId,"NGF-Attribute","Create_Attribute"),(!o.isEasyAttributeDisplayMode()||n.isCriterionValid())&&(n._cleanSelected(),n._attrCombinationView.createAttribute())}),t},_createAddAttributeGroupButton:function(e){if(this.addAttributeGroupBtn)return this.addAttributeGroupBtn;var t=new h(o.getAttributeButtonStyle("group-add"));t.inject(e||this._Div),t.tooltipInfos=new g({shortHelp:l.get("AddAttributeGroup"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attribute-edit-addGroup-btn2");var n=this;return t.addEventListener("buttonclick",function(e){C.setUsageTracker(n._widgetId,"NGF-Attribute","Create_Group"),(!o.isEasyAttributeDisplayMode()||n.isCriterionValid())&&(n._cleanSelected(),n._attrCombinationView.createAttributeGroup())}),t},_cleanSelected:function(){var e=this.getElement(".attribute-edit-group-selected");e&&e.removeClassName("attribute-edit-group-selected")},reDrawCriterion:function(){"read"===this.model.get("state")?(this.model.set("state","edit"),this.model.set("state","read")):(this.model.set("state","read"),this.model.set("state","edit")),this._validateButton&&this._validateButton.getContent().addClassName("attributeCriterion-edit-validate"+(this.sequenceMode?"":" colorized"))},setSequenceMode:function(e){var t;this.sequenceMode=!!e,this.model.set("inSequence",this.sequenceMode),this.sequenceMode?(this._addAttributeSequenceBtn.hide(),t="close"):(this._addAttributeSequenceBtn.show(),t="trash");var i=this._critContextualMenu.length-1;this._critContextualMenu[i].icon.iconName=t;var n=this.getElement(".criteriaIcon img");n&&(this.sequenceMode?n.hide():n.show())},setEnableKeepRemove:function(e){this._keepRemoveCombo&&(this._keepRemoveCombo.disabled=!e),this._anyObjectKeepAnchor&&(this._anyObjectKeepAnchor.disabled=!e,e?this._anyObjectKeepAnchor.removeClassName("attr-keep-remove-disabled"):this._anyObjectKeepAnchor.addClassName("attr-keep-remove-disabled"))},initKeepRemove:function(e){var t="Keep"===e?0:1;this._keepRemoveCombo.selectedIndex=t,this._anyObjectKeepAnchor&&this._anyObjectKeepAnchor.setText(l.get(0===t?"keep":"remove")),this.reDrawCriterion()},switchCriterionToSequence:function(){this.setSequenceMode(!0),this.setEnableKeepRemove(!0),this.reDrawCriterion()},switchSequenceToCriterion:function(){this.setSequenceMode(!1),this.setEnableKeepRemove(!0),this.reDrawCriterion()},updateSynthesis:function(e){var t=0;e&&(this._synthesisInfos=e.synthesis||this._synthesisInfos,t=this._synthesisState!==e.state?1:0,this._synthesisState=e.state||this._synthesisState,o.FILTER_ANY_OBJECT===this._selectedType&&(this._attributesOfType=e.attributes||this._attributesOfType,this.attributes=this._attributesOfType)),1===t&&this._rebuildAvailableTypeUI(),this._updateAttributesWithSynthesis(this.attributes,this._synthesisInfos),this._attrCombinationView&&this._attrCombinationView.updateAttributes(this.attributes)},_rebuildAvailableTypeUI:function(){var e=this,i=o.getTypesOfSynthesis(this._synthesisInfos).concat(C.isActivated("easyAttribute")?{name:o.FILTER_ANY_OBJECT,nlsName:l.get("anyObject")}:[]),n=this._selectedType,s=-1,r=[];this._keepTypeInfosFromLabel=[],i.forEach((t,i)=>{r.push({labelItem:t.nlsName,valueItem:t.name}),e._keepTypeInfosFromLabel[t.nlsName]={value:t.name},s=n===t.name?i:s});var a=new u({touchMode:o.TOUCH_MODE,actionOnClickFlag:!0,elementsList:r,preselectedIndex:s,placeholder:t.String.format(l.get("placeHolderSelectEntity"),l.get("type")),autocompleteFlag:!1,generateRegexpString:function(e){return e}});a.getContent().setAttribute("style",this.typeCombo.getContent().getAttribute("style")),a.getContent().addClassName(this.typeCombo.getContent().getAttribute("class")),this.typeCombo.getContent().parentNode.replaceChild(a.getContent(),this.typeCombo.getContent()),this.typeCombo=a,this.typeCombo.selectedIndex=s,this.typeCombo.addEventListener("change",this._onSelectType.bind(this))},_updateAttributesWithSynthesis:function(e,t){t&&e&&e.length&&(t.length?t.forEach(function(t){var i=e.findIndex(function(e){var i=e.curi||e.uri;return t.property===i}),n=-1!==i?e[i]:void 0;n&&(n.rangeValues={editable:!0,literalInfo:t.values})}):e.forEach(function(e){e.rangeValues&&(e.rangeValues=void 0)}))},_updateExtensionWithSynthesis:function(e,t){var i=[];if(e&&e.length&&t){var n=t.find(function(e){return"ds6w:kind"===e.property});n&&n.values&&n.values.forEach(function(t){var n=e.find(function(e){var i=e.curi||e.name;return i=i.substring(i.indexOf(":")+1),t.value===i});n&&i.push(n)}),C.isDebugActive("extension")&&(i.splice(0),i=[...e])}return i},isThereCriteria:function(){return!!this._attrCombinationView},_buildOldExtensionUI:function(){var e=this;if(void 0===this.subTypeCombo||-1===this.subTypeCombo.selectedIndex){var t=document.getElementById("No_Extension_Available");if(t&&t.remove(),this._extensionBtn)this._extensionBtn.show(),this.subTypeCombo||(this.subTypeCombo=this._buildAndFeedCombo("extension",[],this._childGroupId)),this.subTypeCombo.hide();else{this._extensionBtn=new h({touchMode:o.TOUCH_MODE,displayStyle:"lite",label:l.get("Select")+" "+l.get("SelectExtension"),domId:"SelectExtension_"+this._childGroupId}),this._extensionBtn.inject(this.attrEditInputs),this._extensionBtn.getContent().addClassName("attributeCriterion-edit-SelectExtension"),this._extensionBtn.addEventListener("buttonclick",function(t){e._extensionBtn.hide(),e.subTypeCombo&&e.subTypeCombo.show("slow"),e._computeExtensionsAndUpdateUI(e._keepTypeInfosFromLabel[e.typeCombo.currentLabel].value)}),this.subTypeCombo=this._buildAndFeedCombo("extension",[],this._childGroupId),this.subTypeCombo.hide();e=this;this.subTypeCombo.addEventListener("change",function(t){var i="",n=e._selectedType,s=t.dsModel.currentLabel,o=e._keepExtensionInfosFromLabel[s];if(o&&(n=i=o.value,e._needToQueryServer=!e.isCancelEditCrteriaActivated&&e._selectedSubType!==i),e._selectedSubType=i,e.model.set("extension",i),e.model.set("nlsExtension",""===i?i:s),!e.isCancelEditCrteriaActivated){var r="ds6wg:"+n;v.getPropertiesForClass(r,{tenantId:C.getTenant(),lang:b.getLanguage().toLowerCase(),apiVersion:"R2019x",onComplete:function(t){e._attributesOfExtension=t.length?t[0].properties:[],e.attributes=e._attributesOfType.concat(e._attributesOfExtension),e.updateSynthesis()},onFailure:function(e){}})}})}}},_updateOldExtensionUI:function(){var e=document.getElementById("No_Extension_Available");if(e&&e.remove(),this.subTypes.length)this.subTypeCombo&&(this._buildAndFeedCombo("extension",this.subTypes,this._childGroupId,this.subTypeCombo),p.unmask(this._loaderContainer));else{if(this._extensionBtn.hide(),this.subTypeCombo.hide(),e=document.getElementById(this._extensionBtn.domId))t.createElement("label",{class:"innerfiltertypecombo No-Extension-Available",text:l.get("NoExtensionAvailable"),id:"No_Extension_Available"}).inject(e,"after");p.unmask(this._loaderContainer)}}})}),define("DS/ENONextGenFilterUX/views/GroupView",["UWA/Core","UWA/Class/View","UWA/Class/Model","DS/WAFData/WAFData","UWA/Promise","DS/UIKIT/Mask","DS/ENONextGenFilterUX/utils/FilterUIService","DS/Handlebars/Handlebars4","text!DS/ENONextGenFilterUX/templates/groupViewTemplate.html","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/ENONextGenFilterUX/views/CriteriaAttributeView","DS/ENONextGenFilterUX/models/CriterionModel","DS/ENONextGenFilterUX/collections/FilterUIGroupCollection","DS/WebappsUtils/WebappsUtils","DS/ENONextGenFilterUX/views/CriteriaTagView","DS/ENONextGenFilterUX/models/GroupModel","css!DS/ENONextGenFilterUX/ENONextGenFilterUX.css","DS/ENONextGenFilterUX/views/CriteriaConfigurationView","DS/Logger/Logger","DS/Controls/Button","DS/Controls/TooltipModel","DS/Controls/LineEditor","DS/Controls/ComboBox","DS/ENONextGenFilterUX/views/CriteriaContextMgmtView","DS/PlatformAPI/PlatformAPI","DS/ENONextGenFilterUX/views/CriteriaVolumeView","DS/ENOFilterBIUX/NGFServices","DS/Controls/Expander","DS/Menu/Menu"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,f,m,g,v,b,C,y,A,F,I,S,E,N,w){"use strict";var x=t.extend({className:"filtergroup-topdiv",domEvents:{"click .f-group-container .Sequence-read":"_onEditSubGroup","click .f-group-container .group-header2":"_onEditSubGroup"},setup:function(e){r.displayInternalTimeTrace(1,"GroupView"),this._hasConf=!1,this._UXId=e.UXId||"",this._NGFUXId=e.NGFUXId,this._widgetId=e.widgetId,this._groupId=e.groupId||0,this._childGroupId=e.childGroupId||0,this.types=e.types||null,this._synthesisInfos=e.synthesisInfos||null,this._synthesisInfos&&!this.types&&(this.types=r.getTypesOfSynthesis(this._synthesisInfos)),this._synthesisState=e.synthesisState||-1,this._securityContext=e.securityContext,this._rootID=e.rootID||d.get("root"),this._rootAlias=e.rootAlias||"?",this._rootRevision=e.rootRevision||"",this.collection.setFilterSpecificationRoot(this._rootID),this._subGroupId=e.subGroup||0,this._savedRootID=e.savedRootID,this._template=a.compile(l),this.listenTo(this.model,"onChange:state",this.onStateChange.bind(this)),this.listenTo(this.model,"onChange:isActivated",this._onActivateChange.bind(this)),this._isConfigurationAvailable=e.configAvailable,this._isVolumeAvailable=e.volumeAvailable,this._isContextAvailable=e.contextAvailable,this._isAttributeAvailable=e.attributeAvailable,this._cfgView=null,this._volumeView=null,this._contextMgmtView=null,this._listView=[],this._listViewId=[],this.filterViewToClone=e.filterViewToClone,this._subGroupKeepRemoveMode=1,this._defaultSpecName=d.get("defaultGroupName"),this._defaultSpecName===this.collection.getFilterSpecificationName()&&(this._groupId&&(this._defaultSpecName=UWA.String.format(d.get("defaultGroupNameWithValue"),this._groupId)),this.collection.setFilterSpecificationName(this._defaultSpecName)),e.tagData&&0===this._subGroupId&&this.createTagNGF(e.tagData),this._subscribe0=I.subscribe("NGFilter_WidgetRemoved",this._onWidgetRemoved.bind(this)),this._subscribe1=I.subscribe("NGFilter_VolumeDefined",this._onVolumeDefined.bind(this)),this._subscribe2=I.subscribe("NGFilter_ConfigDefined",this._onUpdateFilterWithConfig.bind(this)),this._globalFilterState="New"},render:function(){var t=this;this.container.setAttribute("id","topgroupdiv"+this._getId()),this.container.setContent(this._template({stateClass:this.model.get("state"),filterAppliesTo:d.get("filterAppliesTo"),groupId:this._getId(),subGroup:this._subGroupId?"sequence":"",groupName:0===this._subGroupId?this._defaultSpecName:d.get("headerAttributeSequenceEdit"),iconHeader:0===this._subGroupId?"filter":p.getWebappsAssetUrl("ENONextGenFilterUX","icons/22/I_AttributeFilter.png")}));var i=this.getElement("div.filter-applies"),n=this.options.linkedRoots;if(n){var s=[];n.forEach(e=>{s.push({label:e.alias,value:e.id,description:e.alias})}),this._appliesToCombo=new A({touchMode:r.TOUCH_MODE,elementsList:s,enableSearchFlag:!1,selectedIndex:0}),this._appliesToCombo.inject(i),this._appliesToCombo.getContent().addClassName("filter-applies-combo"),this._dispatchChangeRootEvent=1,this._appliesToCombo.addEventListener("change",e=>{t._dispatchChangeRootEvent?t.dispatchEvent("NGF_ChangeRootOfSpecifcation",{specId:t.cid,rootId:t._rootID,newRootId:e.dsModel.value,callback:t._onChangeRoot.bind(this)}):t._onChangeRoot(e.dsModel.value),t._dispatchChangeRootEvent=1})}else{if(0===this._subGroupId)this._dispatchChangeRootEvent=0,e.createElement("span",{class:"filter-applies filter-applies-root",id:"multi_root_"+this._groupId,text:r.getRootTitle(this._rootAlias,this._rootRevision)}).inject(i)}if(0===this._subGroupId){var o=e.createElement("div",{}),a=new b(r.getAttributeButtonStyle("chevron-down"));a.displayStyle="lite",a.inject(o),this._SpecExpander=new N({touchMode:r.TOUCH_MODE,domId:"SpecExpander-"+this._groupId,header:this._defaultSpecName,expandedFlag:!0,customHeader:o,style:"filled-separate"});var l=this.getElement(".tree-v2");this._SpecExpander.inject(l,"before"),this._SpecExpander.body=l,this._SpecExpander.getContent().getElement(".wux-controls-expander-header").addClassName("group-header"+r.FILTER_TOUCH_CLASS),this._createContextualMenuWUX(a.getContent()),this._createAddCriterionButtons()}else{var c=this.getElement(this._getCSSId()+" .subGroup-edit-actions");!1===r.TOUCH_MODE&&c.addClassName(r.FILTER_TOUCH_CLASSNAME),this.addAttributeButton=this._createAddAttributeSequenceButton(c),this._createValidateButton(c),this._createContextualMenuWUX()}return this._filterSpecNameEditor=this._createRenameFilterSpecLineEditor(),this._filterSpecNameEditor.hide(),0===this._subGroupId&&(r.displayInternalTimeTrace(0,"GroupView(end of render)"),E.setPerformanceTracker(this._widgetId,"NGF-Filter-Render","NGFilter_UX",{Render_duration:Date.now()-r.getReferenceTime()},1)),this},_onChangeRoot:function(e){this.collection.setFilterSpecificationRoot(e)},clearCriteria:function(){for(var e=this._listView.length-1;e>=0;e--){var t=this._listView[e];t&&t.destroy()}},_onWidgetRemoved:function(e){this._NGFUXId===e.NGFUXId&&this.updateCriteriaAvailibility({attributeUsed:!1===e.attributeAvailable?e.attributeAvailable:void 0,contextUsed:!1===e.contextAvailable?e.contextAvailable:void 0,volumeUsed:!1===e.volumeAvailable?e.volumeAvailable:void 0})},_getId:function(e){var t="grp_"+this._groupId;return t+=e||0===this._subGroupId?"":this._subGroupId},_getCSSId:function(e){return"#"+this._getId(e)},isThereCriteria:function(){for(var e=!1,t=this._listView.length,i=0;i<t;i++)if(this._listView[i].isThereCriteria()){e=!0;break}return e},_getListCriteriaType:function(){var e=[];return this._listView.forEach(t=>{e.push(t.model.get("criteriaType"))}),e=[...new Set(e)]},getCriteriaViewsByType:function(e){var t=[];return this._listView.forEach(i=>{e===i.model.get("criteriaType")&&t.push(i)}),t},getConfigRevision:function(){var e=this.getCriteriaViewsByType("config"),t=[];return e.forEach(e=>{if(r.isModelActivated(e.model)){var i=e.model.get("expression");i&&i.configurationRevision&&t.push(i.configurationRevision)}}),t},_onEditCriterion:function(){this.switchToEdit(),this.dispatchEvent("NGF_UpdateApplySaveSaveAsState",{status:"ValidOK"})},_onComputeSynthesis:function(e){this.dispatchEvent("NGF_ComputeSynthesis",e)},_feedViewWithFilter:function(e){var t=this;return new s(function(i){if(e){var n=e.specification.type,s=e.specification.data;"NGFilter_VolumeDefined"===n?(t._onVolumeDefined(s),i()):t._isConfigurationAvailable&&"NGFilter_ConfigDefined"===n&&t._initFilterWithConfig(e.data).then(function(){i()})}else i()})},switchToEdit:function(){"read"===this.model.get("state")?(this.model.set("state","edit"),this.model.set("isActivated","1"),0!==this._subGroupId?this.dispatchEvent("NGF_Criterion_SwitchedToEdit"):this.dispatchEvent("NGF_Group_SwitchedToEdit",{groupId:this.cid})):this.dispatchEvent("NGF_Group_SwitchedToEdit",{groupId:this.cid})},setFilterState:function(e){this._globalFilterState=e},_editReadMgt:function(e){if(this.collection){var t,i=this.collection.findWhere({state:"edit"});void 0!==i&&(t="Sequence"===i.get("criteriaType")?i.groupToString():i.criterionToString(),this._onCriterionActivated()),"string"==typeof t||Array.isArray(t)?(i.set("state","read"),this.dispatchEvent("NGF_UpdateApplySaveSaveAsState",{status:"ValidOK"})):"object"==typeof t&&r.displayNotification(t),this.dispatchEvent("NGF_AddSpecificationState")}},setTypes:function(e){this.types=e},setSynthesisInfos:function(e){e&&e.synthesis?(this._updateSynthesis(e,this),this._setEnableAddCriterionButtons(!0),this._onDelayedCreateAttribute()):(o.unmask(this.container),this._isAttributeBeingCreatedBeforeEndSynthesis=!1)},_updateSynthesis:function(e,t){t._synthesisInfos=e.synthesis||t._synthesisInfos,t._synthesisState=e.state||t._synthesisState,t.types=r.getTypesOfSynthesis(t._synthesisInfos);for(var i=!!t._createAttributeBtn&&t._createAttributeBtn.disabled,n=t._listView.length,s=0;s<n;s++){var a=t._listView[s],l=a.model.get("criteriaType"),d=a.model.get("sequenceType");"attribute"!==l&&"attribute"!==d||("Sequence"===l?this._updateSynthesis(e,a):a.updateSynthesis(e),i&&(a.selectTypes(t.types),o.unmask(a.getElement(".f-attribute-container"))))}},_setEnableAddCriterionButtons:function(e){var t=!1===e,i=!1!==e;this._createAttributeBtn&&(this._createAttributeBtn.disabled=t,this._createAttributeBtn.active=i),this._createConfigBtn&&!this._createConfigBtn.disabled&&(this._createConfigBtn.disabled=t,this._createConfigBtn.active=i),this._createVolumeBtn&&!this._createVolumeBtn.disabled&&(this._createVolumeBtn.disabled=t,this._createVolumeBtn.active=i),this._createContextBtn&&!this._createContextBtn.disabled&&(this._createContextBtn.disabled=t,this._createContextBtn.active=i)},onStateChange:function(e,t){var i=this.getElement(this._getCSSId()),n=" "+t,s=this._subGroupId?" sequence":"",o=i.hasClassName("group-collapse")?" group-collapse":"";if(i.setAttribute("class","f-group-container"+n+s+o),0!==this._subGroupId){var a=this._getCSSId();if(this._GroupContextualMenu=[],"read"===t){var l=this.collection.findWhere({isActivated:"1"}),c=this.getElement(this._getCSSId()+" .Sequence-read .subGroup-read-criterion");c&&(l?c.removeClassName("f-criterion-deactivated"):c.addClassName("f-criterion-deactivated"));var u=this.model.groupToString();this.getElement(a+" .Sequence-read .subGroup-read-criterion").setContent([{html:u}]),this._GroupContextualMenu.push(this._editSequenceItem),this._GroupContextualMenu.push(r.isModelActivated(this.model)?this._deactivateItem:this._activateItem),this._GroupContextualMenu.push(this._deleteItem)}else this._GroupContextualMenu.push(this._deleteItem);var h="";if("read"===t)h=(this._subGroupKeepRemoveMode?d.get("keep"):d.get("remove"))+" "+d.get("headerAttributeSequenceRead");else h=d.get("headerAttributeSequenceEdit");(0===this._subGroupId?this._SpecExpander.getContent().getElement(".wux-controls-expander-container").getElement(".headerTitle"):this.getElement(".group-name")).setContent({tag:"span",html:h})}},createTagNGF:function(e){var t=this.collection.findWhere({criteriaType:"tag"});t&&this._rootID===t.get("rootID")?Object.keys(e.allfilters).length||Object.keys(e.localfilters).length?t.set("tagData",e):this._onRemoveCriterion({criteriaType:"tag",idxView:this.tagView.cid}):(t=new u({criteriaType:"tag",tagData:e,rootID:this._rootID,widget:this._UXId}),this.collection.add(t),this.tagView=new _({UXId:this._UXId,NGFUXId:this._NGFUXId,widgetId:this._widgetId,childGroupId:this._childGroupId,model:t}),this._listView.push(this.tagView),this._listViewId.push(this.tagView.cid),E.setUsageTracker(this._widgetId,"NGF-Create_Criterion","tag"))},createAttribute:function(e,t,i){var n=r.isDelayedSynthesisActive();if(0===n&&0===this._subGroupId&&-1===this._synthesisState&&void 0===this._isAttributeBeingCreatedBeforeEndSynthesis)this._attrView=void 0,o.mask(this.container,d.get("LoaderForAttributes")),this._isAttributeBeingCreatedBeforeEndSynthesis=!0;else if(1!==n||i||0!==this._subGroupId||-1!==this._synthesisState)if(e)if("create"===t){var s=new u({criteriaType:"attribute",state:"edit"});if(this.collection.add(s),this._attrView=new c({UXId:this._UXId,NGFUXId:this._NGFUXId,widgetId:this._widgetId,childGroupId:this._childGroupId,model:s,types:e,fromCriterionMdl:i?i.model:void 0,listAttrFromType:i?i.listAttr:void 0,listAttrFromSubType:i?i.listAttrExtension:void 0,customizeCtxMenu:!1,sequenceMode:0!==this._subGroupId,keepValue:i?i.model.Keep:this._subGroupKeepRemoveMode,synthesisInfos:this._synthesisInfos,synthesisState:this._synthesisState,isEditable:this._isAttributeAvailable}),0===this._subGroupId){var a=this._SpecExpander.getContent().getElement(".wux-controls-expander-body>ul>.criterionButtonLi");this._attrView.render().inject(a,"before"),this.dispatchEvent("NGF_AttributeCommandsState",{enable:1})}else{var l=this.getElement(this._getCSSId()+" .Sequence-edit>ul");this._attrView.render().inject(l),this._attrView.getElement(".criteriaIcon").hide()}this._addCriterionView(this._attrView),this._attrView.selectTypes(e,this._selectedTypeIndex)}else"update"===t?this._attrView&&this._attrView.selectTypes(e,this._selectedTypeIndex):console.log("RCI - GroupView : unknown status for createAttribute: "+t);else this._attrView=void 0,this.dispatchEvent("NGF_RefreshSynthesis",{onErrorMsg:d.get("ExpandSynthesisFailed"),refresh:!0});else this._attrView=void 0,this._isAttributeBeingCreatedBeforeEndSynthesis=!0,this._onComputeSynthesis({callback:this._onDelayedCreateAttribute.bind(this)});return this._attrView},_onDelayedCreateAttribute:function(){this._isAttributeBeingCreatedBeforeEndSynthesis&&(o.unmask(this.container),this._isAttributeBeingCreatedBeforeEndSynthesis=!1,this.createAttribute(this.types,"create"))},_createContextMgmtView:function(e){if(!this._contextMgmtView){var t=new u({criteriaType:"context",state:"read"});this.collection.add(t),this._contextMgmtView=new F({UXId:this._UXId,NGFUXId:this._NGFUXId,widgetId:this._widgetId,childGroupId:this._childGroupId,rootId:this._rootID,model:t,groupView:this,fromModel:e,isEditable:this._isContextAvailable}),this._addCriterionView(this._contextMgmtView);var i=this._SpecExpander.getContent().getElement(".wux-controls-expander-body>ul>.criterionButtonLi");this._contextMgmtView.render().inject(i,"before"),this._createContextBtn&&(this._createContextBtn.disabled=!0,this._createContextBtn.active=!1)}return this._contextMgmtView},_onSwitchCriterionToSequence:function(t){var i=this;0===r.isAsynchronousValidation()?i._onSwitchCriterionToSequenceSync(i,t):this.areCriteriaValidate(t).then(function(n){if(n){var s=i._createSubGroupView(t.type),o=i._listViewId.indexOf(t.idxView),r=i._listView[o],a=r.container,l=a.getElement(".colorized");l&&l.removeClassName("colorized"),s.collection.add(r.model),s._listView[0]=r,s._listViewId[0]=r.cid,s._subGroupKeepRemoveMode=t.attributeKeep?1:0,i.stopListening(r),s._initCriterionViewEvents(r);var d=i.collection.indexOf(r.model);i.collection.remove(r.model),i.collection.add(s.model,{at:d}),i._listView[o]=s,i._listViewId[o]=s.cid,i._listView.pop(),i._listViewId.pop();var c=e.createElement("li").inject(a,"after");s.render().inject(c),a.remove().inject(s.getElement(".Sequence-edit>ul")),"function"==typeof r.switchCriterionToSequence&&r.switchCriterionToSequence(),s._addNewCriterion({type:r.model.get("criteriaType")})}})},_onSwitchSequenceToCriterion:function(e){var t=this._listViewId.indexOf(e.idxView),i=this._listView[t],n=i.container.getParent(),s=i._listView[0];this.stopListening(i),this._initCriterionViewEvents(s);var o=this.collection.indexOf(i.model);this.collection.remove(i.model),this.collection.add(s.model,{at:o}),this._listView[t]=s,this._listViewId[t]=s.cid,s.container.remove().inject(n,"after"),"function"==typeof s.switchSequenceToCriterion&&s.switchSequenceToCriterion(),i.stopListening(),i._listView.splice(0),i._listViewId.splice(0),i.collection.reset(),n.remove()},_createSubGroup:function(t){var i=this._createSubGroupView(t);if(i){var n=e.createElement("li").inject(this.getElement(this._getCSSId(this._groupId)+" .criterionButtonLi"),"before");i.render().inject(n)}return i},_createSubGroupView:function(e){var t;if(e){this.nbGroup=void 0===this.nbGroup?1:this.nbGroup+1;var i=new h([],{widgetId:this._bodyContainer}),n=new f({subGroupCollection:i,criteriaType:"Sequence",sequenceType:e,subGroupId:this.nbGroup});this.collection.add(n),t=new x({appId:this._NGFUXId,widgetId:this.options.widgetId,groupId:this._groupId,childGroupId:this._childGroupId,collection:i,subGroup:this.nbGroup,model:n,types:this.types,rootID:this._rootID,savedRootID:this._savedRootID,synthesisInfos:this._synthesisInfos,securityCtx:this._securityContext,NGFUXId:this.options.NGFUXId,configAvailable:this._isConfigAvailable,volumeAvailable:this._isVolumeAvailable,contextAvailable:this._isContextAvailable,attributeAvailable:this._isAttributeAvailable}),this._addCriterionView(t),this.listenTo(t,"NGF_SwitchSequenceToCriterion",this._onSwitchSequenceToCriterion.bind(this))}return t},_onCriterionActivated:function(){0!==this._subGroupId&&"edit"===this.model.get("state")&&(this.collection.findWhere({isActivated:"1"})&&r.isModelActivated(this.model)||this._toggleActivatedState({updateChildren:!1}))},_createAddCriterionButtons:function(){var t=this.getElement(this._getCSSId(this._groupId)+" .criterionButtonLi"),i=e.createElement("div",{class:"filter-groups-cmd",id:"actions_gv_"+this._groupId});i.inject(t),this._createContextBtn=this._createAddCriterionButton("context",i),!this._isContextAvailable&&this._createContextBtn.hide(),this._createAttributeBtn=this._createAddCriterionButton("attribute",i),!this._isAttributeAvailable&&this._createAttributeBtn.hide(),this._createConfigBtn=this._createAddCriterionButton("config",i),!this._isConfigurationAvailable&&this._createConfigBtn.hide(),this._createVolumeBtn=this._createAddCriterionButton("volume",i),!this._isVolumeAvailable&&this._createVolumeBtn.hide()},_createAddCriterionButton:function(e,t){var i,n,s,o;switch(e){case"attribute":n="add_attr_criterion",d.get("addAttributeCriterion"),o=d.get("addAttributeCriterionTooltip"),s=p.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterAddAttribute.png");break;case"config":n="add_config_criterion",d.get("addConfigurationCriterion"),o=d.get("addConfigurationCriterionTooltip"),s=p.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterAddConfiguration.png");break;case"volume":n="add_volume_criterion",d.get("addVolumeCriterion"),o=d.get("addVolumeCriterionTooltip"),s=p.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterAddVolume.png");break;case"context":n="add_Context_criterion",d.get("addContextCriterion"),o=d.get("addContextCriterionTooltip"),s=p.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterAddSelection.png")}if(void 0!==n){(i=new b({touchMode:!0,domId:n,displayStyle:"normal",showLabelFlag:!0,id:n,icon:s})).inject(t),i.getContent().addClassName(r.FILTER_TOUCH_CLASS),i.tooltipInfos=new C({shortHelp:o,mouseRelativePosition:!0});var a=this;i.addEventListener("click",function(t){a._checkBeforeAdd(e)})}return i},_onRenameSpecification:function(e){this._SpecExpander.getContent().getElement(".wux-controls-expander-container").getElement(".headerTitle").hide(),this._filterSpecNameEditor.show(),this._filterSpecNameEditor._giveFocus()},_onEditSubGroup:function(e){0!==this._subGroupId&&this._checkBeforeEdit({callback:this._editSubGroup.bind(this)})},_editSubGroup:function(e){this.switchToEdit()},_addNewCriterion:function(e){"attribute"===e.type?this.types&&this._savedRootID===this._rootID?this._addAnyCriterion(e):(this._savedRootID=this._rootID,this._addAnyCriterion(e)):this._addAnyCriterion(e)},_onVolumeDefined:function(e){if(!1===(!!this._createVolumeBtn&&this._createVolumeBtn.disabled)&&this._UXId===e.UXId&&!this._volumeView&&(void 0===e.specId||this._groupId===e.specId)){var t=this._volumeView?0:1;this._createVolume(0),e.action=t?"update":e.action,I.publish("NGFilter_VolumeDefined_Init",e),t&&(r.openFilterPanel("First_Volume_Defined_"+this._groupId),this.dispatchEvent("NGF_DisplayGlobalFilterView"))}},_onUpdateFilterWithConfig:function(e){var t=this;if(this.isViewEdited()&&this._UXId===e.UXId){var i=e.filterToApply;E.isDebugActive("config")&&(i.specification.data.createDummyCfg=1),this._initFilterWithConfig(i).then(function(){t.dispatchEvent("NGF_EndSetFilterSpecification",{applyFilter:void 0===i.applyFilter?0:i.applyFilter,displayFilter:void 0===i.displayFilter?1:i.displayFilter})})}},_initFilterWithConfig:function(t){var i=this,n=t.specification.data;return new s(function(s,o){var a=i._getListCriteriaType().findIndex(e=>"config"===e);-1===a||t.forceUpdate?i._checkBeforeEdit({callback:function(){-1===a?i._createConfig(!1,!!n):(i._cfgView._initWithConfig=!0,i._cfgView.editConfiguration()),i._cfgView.launchCfgFactoryWithConfig(n).then(function(){s()})}}):(r.displayNotification({level:"info",message:e.String.format(d.get("CriterionNotAppliedAsAlreadyDefined"),d.get("config"))}),o())})},_addAnyCriterion:function(e){this.switchToEdit();var t=e.type;switch(t){case"attribute":this.createAttribute(this.types,"create");break;case"config":this._createConfig(!1);break;case"volume":this._createVolume();break;case"context":this._createContextMgmtView()}this.dispatchEvent("NGF_UpdateApplySaveSaveAsState",{status:"ValidOK"}),E.setUsageTracker(this._widgetId,"NGF-Create_Criterion",t)},_checkBeforeAdd:function(e){this._checkBeforeEdit({type:e,callback:this._addNewCriterion.bind(this)})},_checkBeforeEdit:function(e){this.dispatchEvent("NGF_Criterion_ValidateEdited",e)},areCriteriaValidate:function(e){var t=this;if(0===r.isAsynchronousValidation())return this.areCriteriaValidateSync(this);var i=this._listView?this._listView.length:0,n=!i;if(i){n=!0;for(var o=[],a=[],l=0;l<i&&n;l++){var d=this._listView[l];null!==d&&"edit"===d.model.get("state")&&(o.push(d),void 0===d._subGroupId||0===d._subGroupId?a.push(d.isCriterionValidate()):a.push(this._isSequenceValidate(d)))}return s.all(a).then(function(e){n=!0;for(var i=e.length,s=0;s<i;s++){n=n?e[s]:n;var r=o[s],a=e[s];if((void 0===r._subGroupId||0===r._subGroupId)&&a&&r.model){r.model.set("state","read");var l=r.model.get("criteriaType"),d=r.model.get("sequenceType");("attribute"===l||"Sequence"===l&&"attribute"===d)&&t.dispatchEvent("NGF_AttributeCommandsState",{enable:1})}}return n})}return new s(function(e){e(n)})},_isSequenceValidate:function(e){return new s(function(t,i){e.areCriteriaValidate().then(function(i){i&&e.dispatchEvent("NGF_Criterion_Validation",{criteriaType:e.model.get("criteriaType"),viewId:e._getCSSId()}),t(i)})})},areCriteriaValid:function(){for(var e=!0,t=this._listView?this._listView.length:0,i=0;i<t&&e;i++){var n=this._listView[i];null!==n&&"edit"===n.model.get("state")&&(void 0===n._subGroupId||0===n._subGroupId?"function"==typeof n.isCriterionValid&&(e=n.isCriterionValid()):e=n.areCriteriaValid())}return e},setDeactivateVisible:function(e){var t=this._GroupContextualMenu.findIndex(e=>"activate-item-DDCtx"===e.recId);e?-1===t&&(this._GroupContextualMenu=[],this._GroupContextualMenu.push(0===this._subGroupId?this._renameItem:this._editSequenceItem),this._duplicateItem&&this._GroupContextualMenu.push(this._duplicateItem),this._GroupContextualMenu.push(this._deactivateItem),this._GroupContextualMenu.push(this._deleteItem)):0===this._subGroupId&&(this._GroupContextualMenu=[],this._GroupContextualMenu.push(this._renameItem),this._duplicateItem&&this._GroupContextualMenu.push(this._duplicateItem),this._GroupContextualMenu.push(this._deleteItem))},_createContextualMenuWUX:function(e){if(e||!this._GroupContextualMenu){this._renameItem={type:"PushItem",recId:"rename-item-DDCtx",title:d.get("renameFilterSpecification"),icon:r.getIconByName("rename"),action:{this:this,callback:this._onRenameSpecification}},this._editSequenceItem={type:"PushItem",recId:"editSequence-item-DDCtx",title:d.get("editCriteria"),icon:r.getIconByName("pencil"),action:{this:this,callback:this._onEditSubGroup}},this._duplicateItem={type:"PushItem",recId:"duplicate-item-DDCtx",title:d.get("duplicateFilterGroup"),icon:r.getIconByName("duplicate"),action:{this:this,callback:this._duplicateSpecification}},this._activateItem={type:"PushItem",recId:"activate-item-DDCtx",title:d.get("activatedCriteria"),icon:r.getIconByName("eye"),action:{this:this,callback:this._checkBeforeChangeState}},this._deactivateItem={type:"PushItem",recId:"activate-item-DDCtx",title:d.get("deactivatedCriteria"),icon:r.getIconByName("eye-off"),action:{this:this,callback:this._checkBeforeChangeState}},this._deleteItem={type:"PushItem",recId:"delete-item-DDCtx",title:d.get("deleteFilterGroup"),icon:r.getIconByName("trash"),action:{this:this,callback:this._removeGroup}},this._GroupContextualMenu=[],0===this._subGroupId&&this._GroupContextualMenu.push(this._renameItem),this._duplicateItem&&0===this._subGroupId&&this._GroupContextualMenu.push(this._duplicateItem),this._GroupContextualMenu.push(this._deleteItem);var t=this;(e||this.getElement(this._getCSSId()+" .ctx-group-menu")).addEventListener("click",function(e){e.stopPropagation();var i=e.target.getBoundingClientRect();w.show(t._GroupContextualMenu,{position:{x:i.left,y:i.bottom}})})}},_createConfig:function(e,t){if(!this._cfgView){var i=new u({criteriaType:"config",state:e?"edit":"read"});this.collection.add(i),this._cfgView=new g({UXId:this._UXId,NGFUXId:this._NGFUXId,widgetId:this._widgetId,childGroupId:this._childGroupId,model:i,rootId:this._rootID,initWithConfig:t||!1,isEditable:this._isConfigurationAvailable,pfServiceId:this.options.pfServiceId,securityContext:this._securityContext}),this.listenTo(this._cfgView,"NGF_Criterion_Config",this._onConfigCriterionCB.bind(this));var n=this._SpecExpander.getContent().getElement(".wux-controls-expander-body>ul>.criterionButtonLi");this._cfgView.render().inject(n,"before"),this._addCriterionView(this._cfgView),e||this._cfgView.editConfiguration(),this._createConfigBtn&&(this._createConfigBtn.disabled=!0,this._createConfigBtn.active=!1)}},_onConfigCriterionCB:function(e){e.displayMode;switch(e.action){case"remove":this._cfgView&&this._cfgView.destroy(),this._hasConf=!1;break;case"update":this._hasConf=e.hasConf;var t=e.cfgType||e.model&&e.model.config_filter_id?"configId":"binary";E.setUsageTracker(this._widgetId,"NGF-Configuration",t)}},_createVolume:function(e){if(!this._volumeView){var t=new u({criteriaType:"volume",state:"edit"});this.collection.add(t),this._volumeView=new S({UXId:this._UXId,NGFUXId:this._NGFUXId,widgetId:this._widgetId,rootId:this._rootID,childGroupId:this._childGroupId,model:t,sendEvent:0!==e?1:0,filterSpecId:this._groupId,isEditable:this._isVolumeAvailable}),this._createVolumeBtn&&(this._createVolumeBtn.disabled=!0,this._createVolumeBtn.active=!1);var i=this._SpecExpander.getContent().getElement(".wux-controls-expander-body>ul>.criterionButtonLi");this._volumeView.render().inject(i,"before"),this._addCriterionView(this._volumeView)}return this._volumeView},_duplicateSpecification:function(){this.dispatchEvent("NGF_DuplicateSpecifcation",{specId:this.cid,rootSpec:this._appliesToCombo?this._appliesToCombo.value:this._rootID})},updateDuplicatedView:function(e){this._appliesToCombo&&(this._appliesToCombo.value=e.rootSpec)},setEnableDuplication:function(e){var t=this._GroupContextualMenu.findIndex(e=>"duplicate-item-DDCtx"===e.recId);e?-1===t&&this._GroupContextualMenu.splice(-1,0,this._duplicateItem):-1!==t&&this._GroupContextualMenu.splice(t,1)},_removeGroup:function(){0!==this._subGroupId?this._onRemoveCriterion({idxView:this.cid,subgGroupId:this._subGroupId}):this.dispatchEvent("NGF_RemoveGroup",{groupId:this.cid,initFilterUI:1})},destroy:function(){for(var e=this._listView.length,t=e-1;t>=0;t--){var i=this._listView[t];null!=i&&i.destroy()}if(0===this._subGroupId){this._listView.splice(0,e),this._listViewId.splice(0,e);var n=this.collection.toArray();this.collection.remove(n),this._subscribe1&&(this._subscribe1.unsubscribe("NGFilter_VolumeDefined"),this._subscribe1=void 0),this._volumeView=void 0,this.stopListening(),this.model=null,this._parent(),this.container=null,this._subscribe0.unsubscribe("NGFilter_WidgetRemoved"),this._subscribe2.unsubscribe("NGFilter_ConfigDefined")}},_onRemoveCriterion:function(e){if(0===this._subGroupId){if(this._listViewId.length,-1!==(s=this._listViewId.indexOf(e.idxView))){var t=this._listView[s].model;this.collection.remove(t),this._listView.splice(s,1),this._listViewId.splice(s,1),1}if(e.criteriaType&&"attribute"===e.criteriaType||"Sequence"===e.criteriaType){var i=this.getCriteriaViewsByType("attribute").concat(this.getCriteriaViewsByType("Sequence"));this.dispatchEvent("NGF_AttributeCommandsState",{enable:i.length?1:0})}if(e.criteriaType&&"config"===e.criteriaType&&(this._hasConf=e.hasConf,!1===this._hasConf&&(this._createConfigBtn&&(this._createConfigBtn.disabled=!1,this._createConfigBtn.active=!0),this._cfgView=void 0)),e.criteriaType&&"context"===e.criteriaType&&(this._contextMgmtView=null,this._createContextBtn&&(this._createContextBtn.disabled=!1,this._createContextBtn.active=!0)),e.criteriaType&&"volume"===e.criteriaType)this.collection.findWhere({criteriaType:"volume"})||(this._volumeView=void 0,this._createVolumeBtn&&(this._createVolumeBtn.disabled=!1,this._createVolumeBtn.active=!0));var n=document.getElementsByClassName(".keepChildren");void 0!==n[0]&&n.hide(),this.dispatchEvent("NGF_AddSpecificationState")}else{var s,o,r,a;if(-1!==(s=this._listViewId.indexOf(e.idxView))?(a=[this._listView[s].model],o=s,r=1):(a=this.collection.toArray(),o=0,r=this._listView.length),this.collection.remove(a),this._listView.splice(o,r),this._listViewId.splice(o,r),0!==this._listView.length){var l=this._listView[0].model.get("criteriaType"),d=this._listView[0].model.get("sequenceType");("attribute"===l||"Sequence"===l&&"attribute"===d)&&this._listView[0].setEnableKeepRemove(!0),1===this._listView.length&&this.dispatchEvent("NGF_SwitchSequenceToCriterion",{idxView:this.cid})}else this.dispatchEvent("NGF_RemoveCriterion",{idxView:e.idxView}),this.stopListening(),this.model=null,this._parent(),this.container.getParent().remove()}},_checkBeforeChangeState:function(){this.dispatchEvent("NGF_Criterion_ValidateEdited",{callback:this._toggleActivatedState.bind(this)})},setActivatedState:function(e,t){this._setActivatedState(e,t)},_toggleActivatedState:function(e){var t=r.isModelActivated(this.model)?0:1;this._setActivatedState(t,e)},_setActivatedState:function(e,t){var i=0===e?"0":"1";if(this.model.set("isActivated",i),this.collection.setActivated(i),(!t||t&&!1!==t.updateChildren)&&this.collection.forEach(function(e){e.set("isActivated",i)}),0===this._subGroupId)this.dispatchEvent("NGF_SpecificationActivateChange",{viewId:this._getId()});else{var n=r.isModelActivated(this.model)?this._deactivateItem:this._activateItem,s=this._GroupContextualMenu.findIndex(e=>n.recId===e.recId);this._GroupContextualMenu[s]=n;var o=this.getElement(this._getCSSId()+" .Sequence-read .subGroup-read-criterion");o&&("1"===i?o.removeClassName("f-criterion-deactivated"):o.addClassName("f-criterion-deactivated"))}},_onActivateChange:function(e,t){if(0===this._subGroupId){var i=r.isModelActivated(e)?this._deactivateItem:this._activateItem,n=this._GroupContextualMenu.findIndex(e=>i.recId===e.recId);this._GroupContextualMenu[n]=i;var s=this._SpecExpander.getContent().getElement(" .tree-v2"),o=(a=this._SpecExpander.getContent().getElement(".wux-controls-expander-header")).getElement(".headerTitle");this.getElement(".filter-applies"),this.getElement(".filter-groups-cmd");"1"===t?(s.removeClassName("f-group-deactivated"),o.removeClassName("f-group-deactivated")):(s.addClassName("f-group-deactivated"),o.addClassName("f-group-deactivated"))}else{var a=this.getElement(this._getCSSId()+" .group-header2");"1"===t?a.removeClassName("f-group-deactivated"):a.addClassName("f-group-deactivated")}},_addCriterionView:function(e){this._listView.push(e),this._listViewId.push(e.cid),this._childGroupId++,this._initCriterionViewEvents(e)},_initCriterionViewEvents:function(e){this.listenTo(e,"NGF_RemoveCriterion",this._onRemoveCriterion.bind(this)),this.listenTo(e,"NGF_Criterion_SwitchedToEdit",this._onEditCriterion.bind(this)),this.listenTo(e,"NGF_Criterion_Validation",this._editReadMgt.bind(this)),this.listenTo(e,"NGF_Criterion_ValidateEdited",this._checkBeforeEdit.bind(this));var t=this,i=e.model.get("criteriaType"),n=e.model.get("sequenceType");("attribute"===i||"Sequence"===i&&"attribute"===n)&&(this.listenTo(e,"NGF_AttrKeepToRemoveMode",function(){if(t._subGroupId){t._subGroupKeepRemoveMode=0;for(var e=t._listView.length,i=1;i<e;i++)t._listView[i].initKeepRemove("Remove")}this.dispatchEvent("NGF_AttrKeepToRemoveMode")}),this.listenTo(e,"NGF_AttrRemoveToKeepMode",function(){if(t._subGroupId){t._subGroupKeepRemoveMode=1;for(var e=t._listView.length,i=1;i<e;i++)t._listView[i].initKeepRemove("Keep")}this.dispatchEvent("NGF_AttrRemoveToKeepMode")}),this.listenTo(e,"NGF_ComputeSynthesis",this._onComputeSynthesis.bind(this)),"attribute"===i&&(this.listenTo(e,"NGF_SwitchCriterionToSequence",this._onSwitchCriterionToSequence.bind(this)),0!==this._subGroupId&&this.listenTo(e,"NGF_Criterion_Activated",this._onCriterionActivated.bind(this))))},filterViewFromModel:function(e,t,i,n){var s=!1;this._appliesToCombo&&(this._dispatchChangeRootEvent=0,this._appliesToCombo.value=e||this._rootID),this.switchToEdit(),t.isActivated&&"0"===t.isActivated&&this._toggleActivatedState({updateChildren:!0});for(var o=[],a=0;a<t.toFeedUI.length;a++){var l=t.toFeedUI[a];if(null!==l){var d=l.criteriaType,c=null;if("attribute"===d){this.types=n;for(var u=[],h=0;h<this.types.length;h++)u.push(this.types[h].name);if(r.isEasyAttributeDisplayMode()&&r.FILTER_ANY_OBJECT===l.type?this._selectedTypeIndex=void 0:this._selectedTypeIndex=u.indexOf(l.type),c=this.createAttribute(this.types,"create",{model:l,listAttr:i[l.type],listAttrExtension:i[l.extension]})){var p=c.viewFromMdl(l);o=o.concat(p)}else console.log("\n\n ==> filterViewFromModel / attribute = "+this._rootAlias+"\n\n")}else if("config"===d)this._createConfig(!0),(c=this._cfgView).viewFromMdl(l),this._onConfigCriterionCB({hasConf:!0,action:"update",model:l});else if("Sequence"===d){var _=l.sequenceType;if("attribute"===_){var f=l.allAttributes;if(f){var m=[];f.forEach(function(e){m.push(e.isActivated||"1"),e.isActivated="1"}),c=this._createSubGroup(_);var g={filterSpecificationName:this.collection.getFilterSpecificationName(),isActivated:"1",toFeedUI:f};c.filterViewFromModel(e,g,i,n),c.collection.forEach(function(e,t){e.set("isActivated",m[t])}),c._subGroupKeepRemoveMode=g.toFeedUI[0].Keep,c._listView[0].setEnableKeepRemove(!0)}}}else if("context"===d){var v=(c=this._createContextMgmtView(!1)).model;Object.keys(l).forEach(function(e){v.set(e,l[e])}),!v.get("repairFilterInfo")&&c.viewFromMdl(v)}else if("volume"===d){(c=this._createVolume(0)).viewFromMdl(l)}else"tag"===d&&(s=l,this.createTagNGF(l));c&&c.model&&c.model.set("state","read")}}return t.filterSpecificationName?this.updateFilterSpecificationName(t.filterSpecificationName):this.updateFilterSpecificationName(this._defaultSpecName),{retrievedTags:s,attrNotFound:o}},_createRefeshSynthesisButton:function(e){var t=new b(r.getAttributeButtonStyle("refresh"));t.inject(e||this._Div),t.tooltipInfos=new C({shortHelp:d.get("RefreshSynthesisInfosTooltip"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+r.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attributeCriterion-edit-refresh-btn");var n=this;return t.addEventListener("click",function(e){E.setUsageTracker(n._widgetId,"NGF-Attribute","Refresh"),n.dispatchEvent("NGF_RefreshSynthesis")}),t},_createAddAttributeSequenceButton:function(e){var t=new b(r.getAttributeButtonStyle("list-ordered"));t.inject(e),t.tooltipInfos=new C({shortHelp:d.get("addAttributeInSeqenceTooltip"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+r.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attributeCriterion-edit-addSequence-btn");var n=this;return t.addEventListener("click",function(e){E.setUsageTracker(n._widgetId,"NGF-Attribute","Create_Sequence");var t=n._listView?n._listView.length:0,i=!t;if(t){i=!0;for(var s=0;s<t;s++){var o=n._listView[s];if(null!==o&&"edit"===o.model.get("state")&&(void 0===o._subGroupId||0===o._subGroupId)){if("function"!=typeof o.isCriterionValidate){i=!1,r.displayNotification({level:"error",message:d.get("NeedToValidateCrirerion")});break}(i=o.isCriterionValidate())&&o.model.set("state","read")}}}i&&n._addNewCriterion({type:"attribute"})}),t},_createValidateButton:function(e){if(0===r.isAsynchronousValidation())this._createValidateButtonSync(this,e);else{this._validateButton=new b(r.getAttributeValidateButtonStyle()),this._validateButton.inject(e),this._validateButton.tooltipInfos=new C({shortHelp:d.get("validateAttributeSequenceCriterionTooltip"),mouseRelativePosition:!0});var t="attribute-edit-button-style"+r.FILTER_TOUCH_CLASS;this._validateButton.getContent().addClassName(t+" attributeCriterion-edit-validate colorized");var i=this;this._validateButton.addEventListener("buttonclick",function(){i.areCriteriaValidate().then(function(e){e&&i.dispatchEvent("NGF_Criterion_Validation",{criteriaType:i.model.get("criteriaType"),viewId:i._getCSSId()})})})}},_createRenameFilterSpecLineEditor:function(){var e,t=new y({touchMode:r.TOUCH_MODE,placeholder:d.get("placeHolderFilterName")});t.value=this.collection.getFilterSpecificationName()||d.get("defaultGroupName"),e=0===this._subGroupId?this._SpecExpander.getContent().getElement(".wux-controls-expander-container").getElement(".headerTitle"):this.getElement(".group-name"),t.inject(e,"after");var i=this,n=function(e){var t=e.dsModel.value;t=""===t?i._defaultSpecName:t,i.updateFilterSpecificationName(t)};return t.addEventListener("focus",function(e){t.value=i.collection.getFilterSpecificationName()}),t.addEventListener("change",n),t.addEventListener("blur",n),t},updateFilterSpecificationName:function(e){if(this.collection.setFilterSpecificationName(e),this._filterSpecNameEditor.hide(),this._SpecExpander){var t=this._SpecExpander.getContent().getElement(".wux-controls-expander-container").getElement(".headerTitle");t.setText(" "+e),t.show()}this.dispatchEvent("NGF_UpdateSpecificationName",{name:e})},isViewEdited:function(){var e=this.collection.findWhere({state:"edit"});return!(!("edit"===this.model.get("state")?1:0)&&!e)},updateUIWithDisplayDensity:function(e){var t=this.getElement(".wux-controls-expander-header");t&&(0===e?t.addClassName(r.FILTER_TOUCH_CLASSNAME):1===e&&t.removeClassName(r.FILTER_TOUCH_CLASSNAME));var i=this.getElements(".f-attribute-container .attributeCriterion-edit")||[],n=this.getElement(".f-volume-container .attributeCriterion-edit")||[],s=this.getElement(".Sequence-edit .subGroup-edit-actions"),o=this.getElement(".f-context-container.edit .contextCriterion-edit-action"),a=i.concat(n).concat(s||[]).concat(o);s&&0===e&&s.addClassName(r.FILTER_TOUCH_CLASSNAME);for(var l=a.length,d=0;d<l;d++){var c=a[d];if(c)if(0===e)c.getElements("[touch-mode]").forEach(function(e){e.setAttribute("no-touch-mode",""),e.removeAttribute("touch-mode")}),c.getElements(".attr-edit-inputs-Attribute-Master, .attr-edit-inputs-Attribute-Master .attribute-edit-command, .attributeCriterion-edit .attr-edit-inputs, .attributeCriterion-edit .attr-edit-actions, .attribute-edit-group-Combination, .attribute-edit-button-style").forEach(function(e){e.addClassName(r.FILTER_TOUCH_CLASSNAME)}),c.getElements(".wux-controls-autoComplete").forEach(function(e){e.addClassName("filter-no-touch-mode-no-height")});else if(1===e){c.getElements(".wux-controls-abstract").forEach(function(e){e.setAttribute("touch-mode",""),e.removeAttribute("no-touch-mode")}),c.getElements(".filter-no-touch-mode").forEach(function(e){e.removeClassName(r.FILTER_TOUCH_CLASSNAME)}),c.getElements(".wux-controls-autoComplete").forEach(function(e){e.removeClassName("filter-no-touch-mode-no-height")})}}s&&1===e&&s.removeClassName(r.FILTER_TOUCH_CLASSNAME)},buildViewsFromRepairModel:function(e){this._listView.forEach(t=>{t.buildViewFromRepairModel(e)})},updateModelsFromRepair:function(e){var t=[];return this._listView.forEach(i=>{t.push(i.updateModelFromRepair(e))}),t},getEditedCriterion:function(){var e,t=[];this._listView.forEach(e=>{t.push(e)});var i=-1,n=t.findIndex(t=>{var n="edit"===t.model.get("state");return n&&(t._subGroupId&&0!==t._subGroupId?i=t._listView.findIndex(e=>"edit"===e.model.get("state")):"volume"===t.model.get("criteriaType")&&(e=t.getEditedVolume())),n});return-1===n&&-1===i?void 0:{inView:n,inSubView:i,volumeEdited:e}},setCrtierionAsEdited:function(e){if(void 0!==e.inView&&void 0!==e.inSubView){var t=this._listView[e.inView];t.model.set("state","edit"),-1!==e.inSubView?t._listView[e.inSubView].model.set("state","edit"):e.volumeEdited&&t.setVolumeAsEdited(e.volumeEdited)}this.switchToEdit()},checkDisplayKeepChildren:function(){for(var e=!1,t=this.collection.toArray(),i=0;i<t.length;i++)if("attribute"===t[i].get("criteriaType")&&!0===t[i].get("Keep")){e=!0;break}return e},updateCriteriaAvailibility:function(e){void 0!==e.volumeUsed&&(e.volumeUsed?(this._createVolumeBtn.show(),this._volumeView&&this._volumeView.setEditable(!0)):(this._createVolumeBtn.hide(),this._volumeView&&this._volumeView.setEditable(!1))),void 0!==e.contextUsed&&(e.contextUsed?(this._createContextBtn.show(),this._contextMgmtView&&this._contextMgmtView.setEditable(!0)):(this._createContextBtn.hide(),this._contextMgmtView&&this._contextMgmtView.setEditable(!1))),void 0!==e.attributeUsed&&(e.attributeUsed?this._createAttributeBtn.show():this._createVolumeBtn.hide(),this._listView.forEach(t=>{var i=t.model.get("criteriaType"),n=t.model.get("sequenceType");"attribute"!==i&&"attribute"!==n||t.setEditable(!!e.attributeUsed)}))},_onSwitchCriterionToSequenceSync:function(t,i){var n=t;if(n.areCriteriaValidateSync(n)){var s=n._createSubGroupView(i.type),o=n._listViewId.indexOf(i.idxView),r=n._listView[o],a=r.container,l=a.getElement(".colorized");l&&l.removeClassName("colorized"),s.collection.add(r.model),s._listView[0]=r,s._listViewId[0]=r.cid,s._subGroupKeepRemoveMode=i.attributeKeep?1:0,n.stopListening(r),s._initCriterionViewEvents(r);var d=n.collection.indexOf(r.model);n.collection.remove(r.model),n.collection.add(s.model,{at:d}),n._listView[o]=s,n._listViewId[o]=s.cid,n._listView.pop(),n._listViewId.pop();var c=e.createElement("li").inject(a,"after");s.render().inject(c),a.remove().inject(s.getElement(".Sequence-edit>ul")),"function"==typeof r.switchCriterionToSequence&&r.switchCriterionToSequence(),s._addNewCriterion({type:r.model.get("criteriaType")})}},areCriteriaValidateSync:function(e){var t=e,i=t._listView?t._listView.length:0,n=!i;if(i){n=!0;for(var s=0;s<i;s++){var o=t._listView[s];if(null!==o&&"edit"===o.model.get("state"))if(void 0===o._subGroupId||0===o._subGroupId){if("function"!=typeof o.isCriterionValidate){n=!1,r.displayNotification({level:"error",message:d.get("NeedToValidateCrirerion")});break}(n=o.isCriterionValidate())&&o.model&&o.model.set("state","read")}else(n=o.areCriteriaValidateSync(t))&&o.dispatchEvent("NGF_Criterion_Validation",{criteriaType:o.model.get("criteriaType"),viewId:o._getCSSId()})}}return n},_createValidateButtonSync:function(e,t){var i=e;i._validateButton=new b(r.getAttributeValidateButtonStyle()),i._validateButton.inject(t),i._validateButton.tooltipInfos=new C({shortHelp:d.get("validateAttributeSequenceCriterionTooltip"),mouseRelativePosition:!0});var n="attribute-edit-button-style"+r.FILTER_TOUCH_CLASS;i._validateButton.getContent().addClassName(n+" attributeCriterion-edit-validate colorized"),i._validateButton.addEventListener("buttonclick",function(){i.areCriteriaValidateSync(i)&&i.dispatchEvent("NGF_Criterion_Validation",{criteriaType:i.model.get("criteriaType"),viewId:i._getCSSId()})})}});return x}),define("DS/ENONextGenFilterUX/views/GlobalFilterView",["UWA/Class","UWA/Class/View","UWA/Core","UWA/Promise","UWA/Utils/InterCom","DS/WAFData/WAFData","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/Handlebars/Handlebars4","text!DS/ENONextGenFilterUX/templates/globalViewTemplate.html","DS/ENONextGenFilterUX/views/StrDropView","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENONextGenFilterUX/utils/FilterPersistencyServices","DS/ENONextGenFilterUX/views/GroupView","DS/ENONextGenFilterUX/views/FilterRepairView","DS/ENONextGenFilterUX/collections/FilterUIGlobalFilterCollection","DS/ENONextGenFilterUX/collections/FilterUIGroupCollection","DS/ENONextGenFilterUX/models/GroupModel","css!DS/ENONextGenFilterUX/ENONextGenFilterUX.css","DS/ENOFilterBIUX/NGFServices","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/FBISettings","DS/PlatformAPI/PlatformAPI","DS/TagNavigator/ActiveCriteria","DS/Windows/Dialog","DS/Windows/ImmersiveFrame","DS/Controls/LineEditor","DS/Controls/Button","DS/Controls/Toggle","DS/Controls/ComboBox","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/WebappsUtils/WebappsUtils","DS/Controls/TooltipModel","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/ENOFilterBIUX/FBIProxyServices","DS/Controls/Editor","DS/ENONextGenFilterUX/utils/FilterCollectionServices","text!DS/ENONextGenFilterUX/assets/ENOStrRefinementUX_require.json","DS/Utilities/TouchUtils","DS/Menu/Menu","DS/ENONextGenFilterUX/utils/NGFSecurityCtxConverter","DS/ENONextGenFilterUX/views/AdvFilterIDCard"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,f,m,g,v,b,C,y,A,F,I,S,E,N,w,x,V,T,D,O,U,G,M,R,L,k,B,P,X){"use strict";var j="";return t.extend({_filterACProxy:null,domEvents:{"click .global-header-filtername":"_renameFilterCmd"},setup:function(e){c.displayInternalTimeTrace(1,"GlobalFilterView");var t=decodeURIComponent(window.location.href);this._isNewRepairActive=-1===t.indexOf("NGFDebugRepairOnDrop=0");var n=this;this._currentMenuClass="Filter-menu",this._template=a.compile(l),this._filterSpec=v._getFilterSpecification(this.options)?i.clone(v._getFilterSpecification(this.options)):void 0,this._filterSpec&&this._filterSpec.data&&this._filterSpec.data.filterMdl&&this._filterSpec.data.filterMdl.length?(this._droppedFilterData=[this._filterSpec.data],this._filterState=this._filterSpec.data.share?"ValidOK":"SaveOK"):this._filterState="New",this._defaultServiceId="3DSpace",this._pfServiceId=e.pfServiceId,this._appId=this.options.NGFUXId,this._widgetId=this.options.widgetId||this.options.widget,this._UXId=this.options.UXId,this._NGFUXId=this.options.NGFUXId,this._appQueryParam=this.options.appQueryParam,this._securityContext=this.options.securityContext,this._queryFormat=this._getQueryFormat(this._NGFUXId),this._appliedFilterTitle="",this._filterName="",this._filterDescription="",this._activeFilter="",this._hasAppliedNGF=!1,this._types=null,this._rootID=e.rootID,this._rootAlias=e.rootAlias||"?",this._rootRevision=e.rootRevision||"",this._displayDensity=-1;var s,o=localStorage.getItem("NGF_DisplayDensity");s=null===o?void 0===k.getTouchMode()?1:k.getTouchMode()?1:0:Number(o),this._setDensity(s),this._isConfigAvailable=!1!==e.configUsed,this._isVolumeAvailable=!1!==e.volumeUsed,this._isContextAvailable=!1!==e.contextUsed,this._isAttributeAvailable=!1!==e.attributeUsed,this._filterToApply=e.filterToApply,this._listGroupView=[],this._listGroupViewId=[],this.nbGroupView=0,this.idxGFV=e.idxGFV,this.collection=new _(null,{appId:this._appId,widgetId:this._widgetId,model:this.model}),this._filterRepairView=new p({options:this.options}),this.listenTo(this._filterRepairView,"RepairFilter_UpdateContextUI",function(e){n._updateContextFilterModel_FromRepairPanel(e.data),n._isNewRepairActive&&(n._isFilterBroken&&n._buildCVQueryOfSelectedFilter(n._retrievedTags),delete n._retrievedTags)}),this.listenTo(this._filterRepairView,"NGF_CancelRepairFilter",function(e){y.publish("Frame3DXInfra.Close"),n._cancelRepairFilter()}),this._isFilterBroken=!1,this._dropOption=this._filterSpec?this._filterSpec.data.dropOption:this.options.dropOption,this._tagData="dropOnFilter"!==this._dropOption&&this._filterSpec&&this._filterSpec.data?i.clone(this._filterSpec.data.tagData):void 0,this._tagsInMdl=i.clone(this._tagData),this._tagsOnly=!1,this._keepAttributeChildren=!0,this._keepFilters={},x.mask(n.container),!n._rootID&&e.filterToApply&&(n._rootID=e.filterToApply.rootID,n._rootAlias=e.filterToApply.rootAlias||this._rootAlias),n._rootID&&n._getDefaultFilterName().then(function(e){n._updateFilterTitle(n._defaultFilterName),x.unmask(n.container)}),n.render(),null===this._filterACProxy&&(this._filterACProxy=A.setupActiveCriteria({id:"NGFilter",container:"FilterActiveCriteria_"+this._UXId,appId:this._appId,widgetId:this._widgetId,module:"DS/ENONextGenFilterUX/views/FilterActiveCriteria"}),null!==this._filterACProxy&&(this._filterACProxy.addEvent("onTrashClick",this._onACTrash.bind(this)),this._filterACProxy.addEvent("onCriteriaClick",this._onACCriteria.bind(this)))),this._filterIDCard=new X({parent:this,serviceId:this._defaultServiceId,securityContext:this._securityContext,widgetId:this._widgetId}),this.listenTo(this.model,"onChange:state",this._onStateChange.bind(this)),this._subscribeRemoveFilter=y.subscribe("NGFilter.RemoveFilter",this._onRemoveFilter.bind(this)),this._subscribeRedraw=y.subscribe("NGFilter.Redraw",this._onRedraw.bind(this)),this._subscribeSecurityContext=y.subscribe("NGFilter.SetDefaultSecurityContext",this._onSetSecurityContext.bind(this)),this._subscribeWidgetRemoved=y.subscribe("NGFilter_WidgetRemoved",this._onWidgetRemoved.bind(this)),this._synthesisState=1===c.isDelayedSynthesisActive()?-1:1,this._isFilteredSynthesis=!1},render:function(){var e=this;this.container.setContent(this._template({attributeChildrenHiddenLabel:r.get("AttributeChildrenHidden")}));var t=this.getElement(".global-footer");this._applyFilterButton=new E({touchMode:!0,domId:"applyFilterButton",label:r.get("applyFilterButtonLabel"),emphasize:"primary",disabled:!0}),this._applyFilterButton.inject(t),this._applyFilterButton.getContent().addClassName("applyFilterButtonLabel"),this._applyFilterButton.addEventListener("buttonclick",this.onApplyFilter.bind(this)),this._saveFilterButton=new E({touchMode:!0,domId:"saveFilterButton",label:r.get("saveFilterButtonLabel"),emphasize:"secondary",disabled:!0}),this._saveFilterButton.inject(t),this._saveFilterButton.getContent().addClassName("saveFilterButtonLabel"),this._saveFilterButton.addEventListener("buttonclick",this._onSaveFilter.bind(this)),this._saveAsFilterButton=new E({touchMode:!0,domId:"saveAsFilterButton",label:r.get("saveAsFilterButtonLabel"),emphasize:"secondary",disabled:!0}),this._saveAsFilterButton.inject(t),this._saveAsFilterButton.getContent().addClassName("saveAsFilterButtonLabel"),this._saveAsFilterButton.addEventListener("buttonclick",this._onSaveAsFilter.bind(this)),this._attrFromSynthesis=[];this._initSecurityContext(this._securityContext).then(function(t){e._defaultSC=t.default,e._scForSaveFilter=P.getPrefixedSecurityContext(e._defaultSC),e._filterIDCard.setContext({securityContext:e._defaultSC}),e._linkedRoots=void 0,function(){if(c.displayInternalTimeTrace(1,"GlobalFilterView Before Expand Synthesis"),e._droppedFilterData)e._getLinkedRootsFromModel(e._droppedFilterData).then(t=>{e._linkedRoots=t;var i=function(t,i){e._synthesisInfos=t,e._initFilterGroup(),e._buildViewFromDroppedFilter(i),e._removeSynthesisAlert(),c.computeAttributesFromSynthesis(t).then(function(t){e._attrFromSynthesis=t},function(t){e._attrFromSynthesis=t}),c.displayInternalTimeTrace(0,"GlobalFilterView After Expand Synthesis")};-1===e._synthesisState?e._computeSynthesisFromModel(e._droppedFilterData[0]).then(t=>{i(t,e._droppedFilterData)}):c.getExpandSynthesisInfos(e._getExpandContext(),e._appQueryParam).then(function(t){i(t,e._droppedFilterData)},function(t){e._synthesisInfos=[],e._synthesisState=-1,e._initFilterGroup(),e._buildViewFromDroppedFilter(e._droppedFilterData),e._displaySynthesisAlert()})});else{var t=function(){var t=function(){e._updateActiveCriteria("",!1),sessionStorage.setItem("NGF_isUXBuilt_"+e._UXId,!0),e._initFilterGroup(),e._onRedraw({filterId:e._UXId})};e._getLinkedRoots().then(i=>{e._linkedRoots=i||void 0,t()},function(e){console.log(" ==> _getLinkedRoots / Retrieve root failed, err = "+e),t()})};if(-1===e._synthesisState)t(),e._removeSynthesisAlert();else{var i=function(t){e._synthesisInfos=t,c.computeAttributesFromSynthesis(e._synthesisInfos).then(function(t){e._attrFromSynthesis=t},function(t){e._attrFromSynthesis=t}),e.groupView.setSynthesisInfos({synthesis:e._synthesisInfos,state:e._synthesisState}),c.displayInternalTimeTrace(0,"GlobalFilterView After Expand Synthesis")};c.getExpandSynthesisInfos(e._getExpandContext(),e._appQueryParam).then(function(t){i(t),e._removeSynthesisAlert()},function(t){e._synthesisState=-1,i([]),e._displaySynthesisAlert()}),t()}}}()});var i=this.getElement(".global-header-filtername");i.setHTML(this._getFilterTitle()),i.tooltipInfos=new D({shortHelp:r.get("ClickToRenameFilter")+" "+this._filterName,mouseRelativePosition:!0});var n=c._getRootFilterContainer(this._UXId);this._cmdsContainer=n.getElement(".global-filter-commands"),this._createRenameFilterUI(),this._createGlobalFilterCommandWUX(),this._createKeepAttributeChildrenUI(),this._updateKeepAttributeChildrenUI(this._keepAttributeChildren),this._divCombination=this._createCombination(),this._divCombination.hide();var s=this.getElement("#filter-groups-cmd");this._addNewSpecBtn=this._createNewSpecificationBtn(s),this._addExistingSpecBtn=this._createExistingSpecificationBtnWUX(s),this._addNewSpecBtn.hide(),this._addExistingSpecBtn.hide();var o=new E({domId:"go-WelcomePage",showLabelFlag:!1,icon:c.getIconByName("home"),displayStyle:"lite"});o.inject(this._cmdsContainer),o.getContent().addClassName("go-WelcomePage"),o.addEventListener("buttonclick",this._onGoBackWelcomePage.bind(this)),o.tooltipInfos=new D({shortHelp:r.get("GoBackWelcomePageTooltip"),mouseRelativePosition:!0});var a=this.options.buildFilterContainer;return a&&a.remove(),this},_onWidgetRemoved:function(e){this._NGFUXId===e.NGFUXId&&(this._queryFormat=this._getQueryFormat(this._NGFUXId))},_getQueryFormat:function(e){for(var t=0,i=sessionStorage.length,n=0;n<i;n++){var s=sessionStorage.key(n);-1!==s.indexOf("NGFilter_ExpandType_"+e)&&(t|=sessionStorage.getItem(s))}var o=1===C.getOption("ProgressiveSynthesisOn")?1:0;return v.isProgressiveExpandActive()&&o?t|=v.EXPAND_SERVICES.progressive:t&v.EXPAND_SERVICES.expand||t&v.EXPAND_SERVICES.expand3d||(t|=v.EXPAND_SERVICES.expand),t},_initSecurityContext:function(e){var t=this;return new n(function(i,n){e?i({default:e}):c.getAllSecurityContexts(t._defaultServiceId).then(function(e){var t=e.cspaces.findIndex(e=>e.isDefault);t=-1===t?0:t,i({default:e.cspaces[t].value})})})},_onSetSecurityContext:function(e){this._NGFUXId===e.NGFUXId&&this._defaultSC!==e.securityContext&&(this._defaultSC=e.securityContext,this._scForSaveFilter=P.getPrefixedSecurityContext(this._defaultSC),this._filterIDCard&&this._filterIDCard.setContext({securityContext:this._defaultSC}))},_cancelRepairFilter:function(){this._onResetFilter(),this._onACCriteria(this._getFilterTitle()),this._isNewRepairActive&&(delete this._retrievedTags,this.options.droppedInfos&&y.publish("NGFilter.ApplyDroppedFilters/"+this._UXId,{success:[],failure:[{rootId:this._rootID,evt:"info",msg:i.String.format(r.get("DropBorkenFilterCancelled"),this._droppedFilterData[0].filterTitle)}]}))},setAppQueryParam:function(e){this._appQueryParam=e},_onGoBackWelcomePage:function(){if(v.setUsageTracker(this._widgetId,"NGF-HomePage","homePage"),this._isFilterFromModel)if(this._filterIDCard.isFilterModified())this._displaySaveDialogForSavedFilter();else{var e=JSON.stringify(this.getFilterSpecification(this._rootID,this._keepAttributeChildren));!(!this._currentFilterSpecification||this._currentFilterSpecification===e)?this._displaySaveDialogForSavedFilter():this._displaySaveDialogForVolatileFilter()}else this._displaySaveDialogForVolatileFilter()},_displaySaveDialogForSavedFilter:function(){var e=this,t=i.createElement("div",{class:"ngf-save-dialog"});i.createElement("img",{src:T.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterWarning.png")}).inject(t);var n="<span>"+r.get("SaveSavedFilterBeforeGoHome")+"<span>",s="<span>"+r.get("LostModificationsOnSavedFilter")+"<span>";i.createElement("div",{class:"ngf-save-dialog-margin",html:"<span>"+n+"<br>"+s+"<br><span>"}).inject(t);var o=new I({identifier:"NGF_ConfirmRequest"});o.inject(document.body);var a=new F({domId:"dialog-goBack-WelcomePage",touchMode:!0,modalFlag:!0,title:r.get("HomeFilteringTitle")+" - "+this._filterTitle,content:t,immersiveFrame:o,buttons:{Cancel:new E({domId:"cancel-goBack",onClick:function(e){a.close()}}),Apply:new E({domId:"ok-goBack",label:r.get("DontSaveBeforeGoHome"),emphasize:"secondary",onClick:function(t){a.close(),e._goToHomePage(e._getFilterTitle())}}),Ok:new E({label:r.get("SaveBeforeGoHome"),emphasize:"primary",onClick:function(t){a.close();var i=e.getFilterSpecification(e._rootID,e._keepAttributeChildren);e._displayRenameDialogAndCreateFilter("SaveTitle","{}",i,{filterName:e._defaultFilterName,onOk:function(){e._goToHomePage(e._getFilterTitle())},onCancel:function(){}})}})}});e._addMenuClass(e._currentMenuClass),a.addEventListener("close",function(t){e._removeMenuClass(e._currentMenuClass)})},_displaySaveDialogForVolatileFilter:function(){var e=this;if("true"===sessionStorage.getItem("NGF_ToggleHomePage"))this._goToHomePage(this._getFilterTitle());else{var t=i.createElement("div",{class:"ngf-save-dialog"}),n="<span>"+r.get("SaveVolatileFilterBeforeGoHome")+"<span>",s="<span>"+r.get("LostModificationsOnVolatileFilter")+"<span>";i.createElement("div",{html:"<span>"+n+"<br>"+s+"<br><span>"}).inject(t);var o=new I({identifier:"NGF_ConfirmRequest"});o.inject(document.body);var a=new F({domId:"dialog-goBack-WelcomePage",touchMode:!0,modalFlag:!0,title:r.get("HomePageTitle"),content:t,immersiveFrame:o,buttons:{Cancel:new E({domId:"cancel-goBack",onClick:function(e){a.close()}}),Ok:new E({label:r.get("GoToHomePageButton"),emphasize:"primary",onClick:function(t){a.close(),e._goToHomePage(e._getFilterTitle())}})},checkboxInfos:{label:r.get("DoNotShowAgain"),checkFlag:!1}});e._addMenuClass(e._currentMenuClass),a.addEventListener("close",function(t){sessionStorage.setItem("NGF_ToggleHomePage",a.checkboxInfos.checkFlag),e._removeMenuClass(e._currentMenuClass)})}},_isThereCriteriaDefined:function(){for(var e=!1,t=this._listGroupView.length,i=0;i<t;i++)if(this._listGroupView[i].isThereCriteria()){e=!0;break}return e},_displaySynthesisAlert:function(e,t){var i=this;if(!this._alertSynthesisFailed){this._alertSynthesisFailed=new V({visible:!0,closeOnClick:!1,events:{onRemoveMessage:function(){i._removeSynthesisAlert()}}}),this._alertSynthesisFailed.inject(this.getElement(".global-header"),"before");var n=t||r.get("ExpandSynthesisFailed"),s="<a> ("+r.get("RefreshSynthesis")+")</a>";this._alertSynthesisFailed.add({className:"primary",message:n+" "+s}),this._alertSynthesisFailed.getContent().getElement("a").addEventListener("click",function(t){i._refreshSynthesisInfos(e||!0,!0,n)})}},_removeSynthesisAlert:function(){this._alertSynthesisFailed&&this._alertSynthesisFailed.isVisible&&(this._alertSynthesisFailed.getContent().remove(),this._alertSynthesisFailed=void 0)},_buildViewFromDroppedFilter:function(e){var t=this;this.retrieveFilter=!0,this.droppedFilter=!0,e.share?this._filterState="ValidOK":this._filterState="SaveOK",t.setGlobalButtonsStatus(this._filterState),this.groupView&&this.groupView.setFilterState(this._filterState),this._keepFilters={},this._keepFilterNames=[],this._initFiltersToKeep(e,this.retrieveFilter).then(function(i){t._keepFilters=i.filters,t._keepFilterNames=i.names;var n=t._keepFilters,s=e.length;t._filterDescription=s?e[s-1].filterDescription:"";s=n.length;var o=0;for(var r in n)t._setFilterTitle(n[r].filterTitle),o++,c.checkAndGetListOfAttributesFromSelectedFilter(n[r]).then(function(e){t.groupView.setFilterState(t._filterState),t.groupView.setSynthesisInfos({synthesis:t._synthesisInfos,state:t._synthesisState}),t._buildFilterUIFromSelectedFilter(r,e,c.getTypesOfSynthesis(t._synthesisInfos));var i=t._getFilterTitle();t._updateFilterTitle(i),s-1===o&&(t._updateCombinationCombo(),t._updateAddSpecificationButton())}),t._activeFilter=n[r].filterPhysicalId||n[r].filterId,"dropOnFilter"!==t._dropOption&&(t._updateActiveCriteria(t._getFilterTitle(),!0),j=t._UXId,t._hasAppliedNGF=!0);t._onDisplayGlobalFilterView()},function(e){t._displayNotifOnActionFilterFailed("FilterCanNotBeRestored",e)})},_getDefaultFilterName:function(){var e=this;return this._defaultFilterName||(this._defaultFilterName=r.get("defaultFilterName")+"-"+this.idxGFV),new n(function(t){u.getDefaultFilterName(e._defaultFilterName).then(function(i){e._defaultFilterName=i,t(i)})})},_initFilterGroup:function(){this._setApplySelectable(!1),this._setSaveSelectable(!1),this._setSaveAsSelectable(!1),this._addGroupView()},_addGroupView:function(){var e=this,t=new f([],{widgetId:this._bodyContainer});this.groupView=new h({NGFUXId:this._NGFUXId,appId:this._appId,widgetId:this._widgetId,collection:t,groupId:this.nbGroupView,rootID:this._rootID,rootAlias:this._rootAlias,rootRevision:this._rootRevision,model:new m({}),UXId:this._UXId,synthesisInfos:this._synthesisInfos,synthesisState:this._synthesisState,securityContext:this._defaultSC,configAvailable:this._isConfigAvailable,volumeAvailable:this._isVolumeAvailable,contextAvailable:this._isContextAvailable,attributeAvailable:this._isAttributeAvailable,tagData:this._tagData,pfServiceId:this._pfServiceId,linkedRoots:this._linkedRoots}),this.nbGroupView+=1,this.groupView.render().inject(this.getElement("#filter-groups")),this.collection.addGroupCollection(t),this.listenTo(this.groupView,"NGF_AttrKeepToRemoveMode",function(){!1===this._checkDisplayKeepChildren()&&this._updateKeepAttributeChildrenUI()}),this.listenTo(this.groupView,"NGF_AttrRemoveToKeepMode",function(){this._updateKeepAttributeChildrenUI(this._keepAttributeChildren)}),this.listenTo(this.groupView,"NGF_RefreshSynthesis",function(t){t&&t.refresh?e._refreshSynthesisInfos(!1,!0,t.onErrorMsg):c.displayNotification({level:"warning",message:r.get("RefreshOnCriteriaNotValid")})}),this._listGroupView.push(this.groupView),this._listGroupViewId.push(this.groupView.cid),this.listenTo(this.groupView,"NGF_RemoveGroup",this._onRemoveGroup.bind(this)),this.listenTo(this.groupView,"NGF_Criterion_ValidateEdited",this.validateEditedCriterion.bind(this)),this.listenTo(this.groupView,"NGF_Group_SwitchedToEdit",this._onEditGroup.bind(this)),this.listenTo(this.groupView,"NGF_AddSpecificationState",this._updateAddSpecificationButton.bind(this)),this.listenTo(this.groupView,"NGF_AttributeCommandsState",this._onAttributeCommandsState.bind(this)),this.listenTo(this.groupView,"NGF_UpdateSpecificationName",this._buildCombinationComboWithMinusAndSpec.bind(this)),this.listenTo(this.groupView,"NGF_UpdateApplySaveSaveAsState",this._updateApplySaveSaveAsState.bind(this)),this.listenTo(this.groupView,"NGF_SpecificationActivateChange",this._onSpecificationStateChange.bind(this)),this.listenTo(this.groupView,"NGF_DisplayGlobalFilterView",this._onDisplayGlobalFilterView.bind(this)),this.listenTo(this.groupView,"NGF_EndSetFilterSpecification",this._onEndSetFilterSpecification.bind(this)),this.listenTo(this.groupView,"NGF_ComputeSynthesis",this._onComputeSynthesis.bind(this)),this.listenTo(this.groupView,"NGF_DuplicateSpecifcation",this._onDuplicateSpecification.bind(this)),this.listenTo(this.groupView,"NGF_ChangeRootOfSpecifcation",this._onChangeRootOfSpecification.bind(this)),1<this._listGroupView.length&&(this._listGroupView.forEach(function(e){e.setDeactivateVisible(!0)}),this._divCombination&&this._divCombination.show()),this._filterToApply&&(this._filterSpec&&this._feedViewWithFilter(this._filterSpec),this._filterSpec=void 0,this._filterToApply=void 0)},_feedViewWithFilter:function(e){var t=this,i=e&&e.type?e.type:"";if("NGFilter_CopyFromAnyFilterToRoots"===i){if(!this._isThereCriteriaDefined()){var n=e.data;this._filterToApply=void 0,this.buildFilterUIFromFilterRelatedToQuery(n.filterData,n.listAttr,n.rootId,n.options).then(function(){t.onApplyFilter()})}}else if("NGFilter_VolumeDefined"===i)y.publish(i,e.data);else if("NGFilter_ConfigDefined"===i)y.publish(i,e.data);else if("NGFilter_RetrieveFilter"===i||"NGFilter_ShareFilterSpec"===i||"NGFilter_RetrieveRoot"===i)this._dropOption=e.data.dropOption,this._dropedFilterIds=[],this._dropedFilterIds=Array.isArray(e.data.filterId)?e.data.filterId:[e.data.filterId];else if("NGFilter_createFromTag"===i){var s="NGF_tagMgtRunning_"+this._UXId;sessionStorage.setItem(s,!0),this.setTagsDataOnNGF(e.data)}else"NGFilter_Unlink"===i?t._computeSynthesisFromModel(e.data).then(i=>{t._synthesisInfos=i,c.computeAttributesFromSynthesis(i).then(function(i){var n=c.getTypesOfSynthesis(t._synthesisInfos);t._attrFromSynthesis=i;var s=[];s[c.FILTER_ANY_OBJECT]=t._attrFromSynthesis;t._buildFilterViewFromFilterModel(e.data,s,n);t._onDisplayGlobalFilterView(),t.onApplyFilter()})}):this.groupView&&this.groupView._feedViewWithFilter(filter).then(function(){t._updateApplySaveSaveAsState({status:"ValidOK"}),t._onDisplayGlobalFilterView(),1===filter.data.applyFilter&&t.onApplyFilter(),0!==filter.data.displayFilter&&c.openFilterPanel(t._UXId)})},_onEndSetFilterSpecification:function(e){this._updateApplySaveSaveAsState({status:"ValidOK"}),this._onDisplayGlobalFilterView(),1===e.applyFilter&&this.onApplyFilter(),0!==e.displayFilter&&c.openFilterPanel("NGF_EndSetFilterSpecification_"+Date.now())},_onDuplicateSpecification:function(e){this._onAddNewFilterSpecification(e)},_onChangeRootOfSpecification:function(e){var t=this;this.validateEditedCriterion().then(function(i){if(i){t.groupView.model.set("state","read");var n=t.collection.keepComponentsToFeedUI(t._rootID,t._keepAttributeChildren,void 0,{keepEmpty:!0}),s=t._listGroupViewId.indexOf(e.specId),o=[];o.push(n[0]),o.push(n[s+1]),c.checkCompatibiltyFilterRules(t._securityContext,e.rootId,{rootPhysicalId:e.newRootId,filterUIComponents:o},1,t.options.pfServiceId).then(function(i){i.result.error?c.checkAndGetListOfAttributesFromSelectedFilter(i.filterSpec).then(function(n){n[c.FILTER_ANY_OBJECT]=t._attrFromSynthesis;var o=c.getTypesOfSynthesis(t._synthesisInfos);t._listGroupView[s].clearCriteria(),t._listGroupView[s].filterViewFromModel(e.rootId,i.filterSpec.filterUIComponents[1],n,o),e.callback&&e.callback.call(t,e.newRootId)}):e.callback&&e.callback.call(t,e.newRootId)})}})},_onComputeSynthesis:function(e){var t=this;x.mask(this.container),c.getExpandSynthesisInfos(this._getExpandContext(),this._appQueryParam).then(function(i){c.computeAttributesFromSynthesis(i).then(function(n){x.unmask(t.container),t._synthesisInfos=i,t._synthesisState=1,t._attrFromSynthesis=n,t._listGroupView.forEach(function(e){e.setSynthesisInfos({synthesis:t._synthesisInfos,state:t._synthesisState,attributes:t._attrFromSynthesis})}),"function"==typeof e.callback&&e.callback(e.options),t._removeSynthesisAlert()},function(e){console.log("_onComputeSynthesis / computeAttributesFromSynthesis failed, err = "+e),x.unmask(t.container),t._displaySynthesisAlert()})},function(e){console.log("_onComputeSynthesis / getExpandSynthesisInfos failed, err = "+e),x.unmask(t.container),t._displaySynthesisAlert()})},_refreshSynthesisInfos:function(e,t,i){var n=void 0===t||t;n&&x.mask(this.container);var s=this,o=function(e,t){s._synthesisInfos=e,s._synthesisState=1,s._attrFromSynthesis=t,s._listGroupView.forEach(function(e){e.setSynthesisInfos({synthesis:s._synthesisInfos,state:s._synthesisState,attributes:s._attrFromSynthesis})}),n&&x.unmask(s.container),s._removeSynthesisAlert()},r=function(e,t){t&&x.unmask(s.container),s._displaySynthesisAlert(e,i)};if(e)if(0===b.getCVQueryBuildMode()){var a=this.collection.buildCVQuery(this._rootID,this._keepAttributeChildren),l=G.completeCVQueryWithAppParams(JSON.parse(a),this._appQueryParam,void 0,!1);c.refreshExpandSynthesisInfos(this._getExpandContext(),l).then(function(e){o(e),s._isFilteredSynthesis=!0},function(t){r(e,n)})}else this.buildCVQuery().then(function(t){var i=G.completeCVQueryWithAppParams(JSON.parse(t),s._appQueryParam,void 0,!1);c.refreshExpandSynthesisInfos(s._getExpandContext(),i).then(function(e){c.computeAttributesFromSynthesis(e).then(function(t){o(e,t),s._isFilteredSynthesis=!0})},function(t){r(e,n)})});else c.getExpandSynthesisInfos(this._getExpandContext(),this._appQueryParam).then(function(e){c.computeAttributesFromSynthesis(e).then(function(t){o(e,t)})},function(t){r(e,n)})},_setKeepChildrenItemVisibilty:function(e,t){if(e||t){if(this._isHideShowAttributeChildrenItemRemoved)(i=this._hideAttrChildren.getOption("isActive")?this._hideAttrChildren:this._showAttrChildren).disabled=!1,i.show();else e?(this._hideAttrChildren.show(),this._hideAttrChildren.setOption("isActive",!0),this._showAttrChildren.hide(),this._showAttrChildren.setOption("isActive",!1)):(this._hideAttrChildren.hide(),this._hideAttrChildren.setOption("isActive",!1),this._showAttrChildren.show(),this._showAttrChildren.setOption("isActive",!0));this._isHideShowAttributeChildrenItemRemoved=0}else{var i;this._isHideShowAttributeChildrenItemRemoved=1,(i=this._hideAttrChildren.getOption("isActive")?this._hideAttrChildren:this._showAttrChildren).disabled=!0}},_checkDisplayKeepChildren:function(){for(var e=!1,t=0;t<this._listGroupView.length&&!e;t++)e=this._listGroupView[t].checkDisplayKeepChildren();return e},_onSelectObject:function(e){this._rootID=e.rootID,this._rootAlias=e.rootAlias,this.groupView&&(this.groupView._rootID=this._rootID,this.groupView._rootAlias=this._rootAlias),this.getElement(".filter-applies")&&this.getElement(".filter-applies-root").setContent(this._rootAlias)},_onSaveFilter:function(){var e=this;0===c.isAsynchronousValidation()?e._onSaveFilterSync(e):this.validateEditedCriterion().then(function(t){if(t){var i="{}";0===b.getCVQueryBuildMode()&&(i=e.collection.buildCVQuery(e._rootID,e._keepAttributeChildren));var n=e.getFilterSpecification(e._rootID,e._keepAttributeChildren);"ValidOK"===e._filterState?e._displayRenameDialogAndCreateFilter("SaveTitle",i,n):e._isFilterFromModel?e._checkFilterNameAndUpdateFilter(e._defaultFilterName,i,n):e._displayRenameDialogAndCreateFilter("SaveTitle",i,n),e.groupView.switchToEdit()}else e.groupView.switchToEdit()})},_onSaveAsFilter:function(){var e=this;0===c.isAsynchronousValidation()?e._onSaveAsFilterSync(e):this.validateEditedCriterion().then(function(t){if(t){var i="{}";0===b.getCVQueryBuildMode()&&(i=e.collection.buildCVQuery(e._rootID,e._keepAttributeChildren));var n=e.getFilterSpecification(e._rootID,e._keepAttributeChildren);e._displayRenameDialogAndCreateFilter("SaveAsTitle",i,n),e.groupView.switchToEdit()}})},_checkFilterNameAndUpdateFilter:function(e,t,n){var s=this;s._invalidFilterName&&(s._invalidFilterName.destroy(),s._invalidFilterName=null),s._invalidFilterDescription&&(s._invalidFilterDescription.destroy(),s._invalidFilterDescription=null);var o=i.createElement("div",{class:"ngf-save-dialog"});i.createElement("img",{src:T.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterWarning.png")}).inject(o);var a=r.get("OverwriteExistingFilter"),l=r.get("ProceedValidation");i.createElement("div",{class:"ngf-save-dialog-margin",html:"<span>"+a+"</span><br><span>"+l+"</span>"}).inject(o);var d=new I({identifier:"NGF_ConfirmRequest"});d.inject(document.body);var c=new F({touchMode:!0,modalFlag:!0,title:r.get("SaveTitle")+" - "+s._filterTitle,content:o,immersiveFrame:d,buttons:{Cancel:new E({label:r.get("CancelSaveUI"),emphasize:"secondary",onClick:function(e){c.close()}}),Apply:new E({domId:"saveAsFilterButton",label:r.get("saveAsFilterButtonLabel"),emphasize:"secondary",onClick:function(e){c.close(),s._onSaveAsFilter()}}),Ok:new E({label:r.get("SaveButton"),emphasize:"primary",onClick:function(i){s._updateFilter(s._scForSaveFilter,e,s._filterDescription,s._filterTitle,t,n,s._activeFilter).then(function(e){e&&c.close()})}})}});s._addMenuClass(s._currentMenuClass),c.addEventListener("close",function(e){s._removeMenuClass(s._currentMenuClass)})},_displayRenameDialogAndCreateFilter:function(e,t,n,s){var o=this,a=new i.Element("div",{class:"wux-element-Save-content"}),l=new i.Element("div",{class:"wux-element-Save-filterName",html:"<p>"+r.get("FilterNameToSave")+"</p>"}).inject(a,"top"),d=r.get("placeHolderFilterName"),u=new S({touchMode:c.TOUCH_MODE,placeholder:d,domId:"SaveName"});u.inject(l);var h=new i.Element("div",{class:"wux-element-Save-filterName",html:"<p>"+i.String.format(r.get("FilterDescriptionToSave"),256)+"</p>"});h.inject(a),d=r.get("FilterDescriptionToSavePlaceHolder");var p=new M({touchMode:c.TOUCH_MODE,nbRows:3,newLineMode:"enter",domId:"SaveDescription",value:this._filterDescription});p.inject(h),p.addEventListener("change",function(e){if(o._isFilterNameAllowed()&&o._isFilterDescriptionAllowed()){var t=e.dsModel.value.slice(0,255),i=e.target;void 0===i.tooltipInfos?i.tooltipInfos=new D({shortHelp:t,mouseRelativePosition:!0}):i.tooltipInfos.shortHelp=t,o._filterDescription=t}}),p.addEventListener("uncommittedChange",function(e){var t=e.dsModel.valueToCommit,n=o.saveUIModal.getContent().getElement("#SaveDescription"),s=t.slice(0,255),a=c.isSafe(s);if(a&&256>=t.length)n.removeClassName("attr-edit-inputs-Attribute-Error"),o._invalidFilterDescription&&o._invalidFilterDescription.hide();else{n.addClassName("attr-edit-inputs-Attribute-Error");var l=a?void 0:r.get("BadCharacters")+": "+c.XSS_NOT_ALLOWED.join(" "),d=256<t.length?r.get("FilterDescriptionTooLong"):void 0,u=l?'<p style="margin:0px">'+l+"</p>":"";u+=d?'<p style="margin:0px">'+d+"</p>":"",o._invalidFilterDescription?(o._invalidFilterDescription.setHTML(u),o._invalidFilterDescription.show()):o._invalidFilterDescription=new i.Element("div",{class:"wux-control-inline-saveName",html:u}).inject(n,"bottom")}if(o.saveUIModal){var h=!a||!o._isFilterNameAllowed();o.saveUIModal.getContent().getElement(".wux-ui-state-primary").dsModel.disabled=h}}),this._getDefaultFilterName().then(function(t){u.value="SaveAsTitle"===e?o._defaultFilterName:s&&s.filterName?s.filterName:o._getFilterTitle(),m=u.value,u.addEventListener("focus",function(e){}),u.addEventListener("change",function(e){if(o._isFilterNameAllowed()&&o._isFilterDescriptionAllowed()){o.saveUIModal.getContent().getElement("#SaveName");m=e.dsModel.value}}),u.addEventListener("uncommittedChange",function(e){var t=e.dsModel.valueToCommit,n=o.saveUIModal.getContent().getElement("#SaveName"),s=c.checkForBadCharacters(t),a=!t.length;if(!1===s||a){var l="";l=a?'<p style="margin:0px">'+r.get("FilterNameMustBeFeed")+"</p>":'<p style="margin:0px">'+r.get("BadCharacters")+": "+c.NAME_RULES.notAllowedChars.join(" ")+"</p>",n.addClassName("attr-edit-inputs-Attribute-Error"),o._invalidFilterName?(o._invalidFilterName.setHTML(l),o._invalidFilterName.show()):o._invalidFilterName=new i.Element("div",{class:"wux-control-inline-saveName",html:l}).inject(n,"bottom")}else n.removeClassName("attr-edit-inputs-Attribute-Error"),o._invalidFilterName&&o._invalidFilterName.hide();if(o.saveUIModal){var d=!(s&&!a&&o._isFilterDescriptionAllowed());o.saveUIModal.getContent().getElement(".wux-ui-state-primary").dsModel.disabled=d}})});var _=new i.Element("div",{class:"wux-element-Save-filterName"}).inject(a,"bottom"),f=new i.Element("p",{}).inject(_);i.createElement("span",{text:r.get("getCurrentSecurityContext")}).inject(f),this._getListSecurityContext().then(function(e){o._securityContextCombo=new w({touchMode:c.TOUCH_MODE,elementsList:e,enableSearchFlag:!1}).inject(_,"bottom"),o._scForSaveFilter=o._securityContextCombo.currentValue,o._securityContextCombo.addEventListener("change",function(e){o._scForSaveFilter=e.dsModel.currentValue});var t=e.findIndex(e=>-1!==e.valueItem.indexOf(o._defaultSC));o._securityContextCombo.selectedIndex=-1===t?0:t;var n=i.createElement("span",{class:"fonticon fonticon-help wux-element-Save-SecutiryContext-Help"});n.inject(f),n.tooltipInfos=new D({shortHelp:r.get("SecurityContextTooltip"),mouseRelativePosition:!0})});var m=this._getFilterTitle();this._invalidFilterName&&(this._invalidFilterName.destroy(),this._invalidFilterName=null),this._invalidFilterDescription&&(this._invalidFilterDescription.destroy(),this._invalidFilterDescription=null);var g=new I({identifier:"NGF_ConfirmRequest"});return g.inject(document.body),this.saveUIModal=new F({touchMode:!0,modalFlag:!0,title:r.get(e),domId:"NGF_SavePanel",content:a,immersiveFrame:g,buttons:{Cancel:new E({label:r.get("CancelSaveUI"),emphasize:"secondary",onClick:function(e){o.saveUIModal.close(),o.setGlobalButtonsStatus(o._filterState),s&&s.onCancel&&s.onCancel.call()}}),Ok:new E({label:r.get("SaveButton"),emphasize:"primary",onClick:function(i){m?(o._filterState="New",o._saveFilter(o._scForSaveFilter,o._defaultFilterName,o._filterDescription,m,t,n).then(function(t){if(t){if(o._filterState="SaveOK",s&&s.onOk&&s.onOk.call(),v.setUsageTracker(o._widgetId,"NGF-Save-Filter",{label:"save",value:"SaveAsTitle"===e?2:1}),v.setUsageTracker(o._widgetId,"NGF-Save-Filter-SpecificationCount",{label:"count",value:o._listGroupView.length}),1<o._listGroupView.length){var i=o._combinationCombo.currentValue;i="union"===i?"any":"intersection"===i?"all":"except",v.setUsageTracker(o._widgetId,"NGF-Multi-Specification-Combination",i)}}else o._filterState="ValidOK";o.saveUIModal.close(),o.setGlobalButtonsStatus(o._filterState),o.groupView.setFilterState(o._filterState)})):(o.saveUIModal.getContent().getElement("#SaveName").addClassName("attr-edit-inputs-Attribute-Error"),o._removeMenuClass(o._currentMenuClass))}})}}),o._addMenuClass(o._currentMenuClass),o.saveUIModal.addEventListener("close",function(e){o._removeMenuClass(o._currentMenuClass)}),this.saveUIModal},_isFilterNameAllowed:function(){return!!(!this._invalidFilterName||this._invalidFilterName&&this._invalidFilterName.isHidden())},_isFilterDescriptionAllowed:function(){return!!(!this._invalidFilterDescription||this._invalidFilterDescription&&this._invalidFilterDescription.isHidden())},_getListSecurityContext:function(){var e=this;return new n(function(t,i){sessionStorage.removeItem("NGF_listSecurityContext"),e._listSecurityContext?t(e._listSecurityContext):c.getAllSecurityContexts(e._defaultServiceId).then(function(i){var n=[],s=i.cspaces;if(Array.isArray(s)){for(var o=0;o<s.length;o++)n[o]={labelItem:s[o].label,valueItem:P.getPrefixedSecurityContext(s[o].value)};e._listSecurityContext=n}t(n)})})},onApplyFilter:function(){var e=this;0===c.isAsynchronousValidation()?e.onApplyFilterSync(e):this.validateEditedCriterion().then(function(t){if(t)if(1===e._synthesisState&&e._isFilteredSynthesis&&(e._refreshSynthesisInfos(!1,!1),e._isFilteredSynthesis=!1),j=e._UXId,e._hasAppliedNGF=!0,e._appliedFilterTitle=e._getFilterTitle(),e._tagsOnly=!1,0===b.getCVQueryBuildMode()){var i=e.collection.buildCVQuery(e._rootID,e._keepAttributeChildren,!1);e._applyFilter({CVQuery:i,isEmpty:!1}),e.groupView.switchToEdit(),e._updateAddSpecificationButton()}else e.buildCVQuery().then(function(t){e._applyFilter({CVQuery:t,isEmpty:!1,tagsInMdl:e._tagsToApply}),e.groupView.switchToEdit(),e._updateAddSpecificationButton()},function(t){e._displayNotifOnActionFilterFailed("FilterCanNotBeApplied",t)});else e.groupView.switchToEdit()})},_onRemoveFilter:function(e){var t=e.NGFUXId;if(t){var i=0;if(e.rootIds)for(var n=Array.isArray(e.rootIds)?e.rootIds:[e.rootIds],s=0;s<n.length;s++){if(t+"_"+n[s]===this._UXId){i=1;break}}else i=-1!==this._UXId.indexOf(t)?1:i;i&&(this._resetFilter({initFilterUI:0}),this._updateActiveCriteria("",!1),this.dispatchConfigRevision(!0),null!==this._filterACProxy&&(this._filterACProxy.removeEvent("onTrashClick"),this._filterACProxy.removeEvent("onCriteriaClick")),this._subscribeRemoveFilter&&this._subscribeRemoveFilter.unsubscribe("NGFilter.RemoveFilter"),this._subscribeRemoveFilter&&this._subscribeRedraw.unsubscribe("NGFilter.Redraw"),this._subscribeSecurityContext&&this._subscribeSecurityContext.unsubscribe("NGFilter.SetDefaultSecurityContext"),this._filterIDCard&&this._filterIDCard.remove())}},_emptyFilter:function(e){var t=this._listGroupView.length;if(0!==t)for(var i=e&&e.initFilterUI?e.initFilterUI:void 0,n=t-1;n>=0;n--){var s=this._listGroupView[n];null!=s&&this._removeGroup({groupId:s.cid},i)}this._addNewSpecBtn&&(this._addNewSpecBtn.hide(),this._addExistingSpecBtn.hide()),this._filterState="New",this.groupView&&this.groupView.setFilterState(this._filterState),this.setGlobalButtonsStatus(this._filterState)},_saveFilter:function(e,t,s,o,a,l){var d=this;return new n(function(n,h){d._setFilterTitle(o);var p="3DSpace"!==d._pfServiceId?d._pfServiceId:"";u.saveFilter(e,t,s,o,d._rootID,a,l,p).then(function(e){e&&e.filter?(c.displayNotification({level:"success",message:r.get("FilterCreationSuccessfull")}),d._updateFilterTitleAndAC(o),e.filterId&&(d._activeFilter=e.filterId,y.publish("NGFilter_saved",{rootID:d._rootID,filterId:e.filterId})),d._displayFilterIDCard(!0,e.filterId,e.filter[0]),d._isFilterFromModel=1,d._unsavedChangesMsgDisplayed=!1,n(!0)):(c.displayNotification({level:"error",subtitle:i.String.format(r.get("FilterCreationFailed"),"Advanced Filter"),message:"<p>"+r.get("FilterAccessFailed-1")+"<br>"+r.get("FilterAccessFailed-2")+"</p>"}),d._setFilterTitle(d._defaultFilterName),n(!1))})})},_updateFilter:function(e,t,i,s,o,a,l){var d=this;return new n(function(n,h){u.updateFilter(e,t,i,s,o,a,l).then(function(e){e&&e.filter?(c.displayNotification({level:"success",message:r.get("FilterUpdateSuccessfull")}),d._filterIDCard&&d._filterIDCard.displayUnsavedChangesPanel(!1),d._unsavedChangesMsgDisplayed=!1,d._updateFilterTitleAndAC(s),n(!0)):(c.displayNotification({level:"error",subtitle:r.get("FilterUpdateFailed"),message:"<p>"+r.get("FilterAccessFailed-1")+"<br>"+r.get("FilterAccessFailed-2")+"</p>"}),n(!1))})})},_applyFilter:function(e){var t,i,n=e.CVQuery,s=e.isEmpty,o=this._appliedFilterTitle,a=!1;s||(t=this.getFilterSpecification(this._rootID,this._keepAttributeChildren),i=JSON.stringify(t),a=!(!this._currentFilterSpecification||this._currentFilterSpecification===i),this._isFilterFromModel?a?(o+=r.get("WithUnsavedChanges"),this._unsavedChangesMsgDisplayed=!0):o+=this._unsavedChangesMsgDisplayed?r.get("WithUnsavedChanges"):"":o+="",a&&this._filterIDCard.displayUnsavedChangesPanel(!0)),this._currentFilterSpecification=i;!0!==this._tagsOnly||s?this._updateActiveCriteria(o,!0):a&&this._updateActiveCriteria(o,!0),n&&(n="string"==typeof n?JSON.parse(n):n);var l={empty:s,appId:this._appId,widget:this._widgetId,CVQuery:n.CVQuery,CVQuery3D:n.CVQuery3D,CVQueryV2:n.CVQueryV2,filterMdl:t,filterRootIds:[this._rootID],filterRootAlias:[this._rootAlias],filterTitle:this._getFilterTitle(),filterId:this._activeFilter?this._activeFilter:void 0,tagsInMdl:e.tagsInMdl};this._removeUselessQueries(l),y.publish("onApplyNGFilter/"+this._NGFUXId,l),this.dispatchConfigRevision(s),sessionStorage.setItem("NGF_isUXBuilt_"+this._UXId,!0)},_removeUselessQueries:function(e){this._queryFormat&v.EXPAND_SERVICES.progressive||delete e.CVQueryV2,this._queryFormat&v.EXPAND_SERVICES.expand||delete e.CVQuery,this._queryFormat&v.EXPAND_SERVICES.expand3d||delete e.CVQuery3D},dispatchConfigRevision:function(e){var t={NGFUXId:this._NGFUXId,widgertId:this._widgetId,rootId:this._rootID},i=[];if(e||this._listGroupView.forEach(e=>{if(c.isModelActivated(e.model)){var t=e.getConfigRevision();i=i.concat(t)}}),i.length){this._filterAppliedWithConfigRevision=1;var n="NGFilter.SetConfigurationRevision_"+this._widgetId;t.configRevision=i,y.publish(n,t)}else if(this._filterAppliedWithConfigRevision){this._filterAppliedWithConfigRevision=0;n="NGFilter.RemoveConfigurationRevision_"+this._widgetId;y.publish(n,t)}},_onRedraw:function(e){this._filterACProxy&&this._UXId===e.filterId&&(this._isFilterBroken&&void 0!==this._isFilterBroken||this._filterACProxy.redrawCriteria({proxyId:this._UXId,widgetId:this._widgetId}),j=this._UXId)},_updateActiveCriteria:function(e,t){if(null!==this._filterACProxy){var i={filterName:e,appId:this._appId,widgetId:this._widgetId,widgetIdent:this._UXId},n={proxyId:this._UXId};this._filterACProxy.setActiveCriteria(i,n),!0===t?this._filterACProxy.redrawCriteria(n):!0===this._filterACProxy.getDisplayStatus()&&this._filterACProxy.redrawCriteria(n)}},_onACTrash:function(e){j===this._UXId&&(this._hasTag()&&(this._tagsToApply=void 0,this._fromACTrash=!0),this._onACEvent())},_onACCriteria:function(e){e&&this._appliedFilterTitle&&-1!==e.indexOf(this._appliedFilterTitle)&&this._onACEvent()},_hasTag:function(){return!(!this._tagsInMdl||!Object.keys(this._tagsInMdl.allfilters).length&&!Object.keys(this._tagsInMdl.localfilters).length)},_onACEvent:function(){if(this._appliedFilterTitle="",this._fromACTrash);else if(this._hasTag()){var e=this,t=this._tagsOnly;if(this._tagsOnly=!0,0===b.getCVQueryBuildMode()){var i=this.collection.buildCVQuery(this._rootID,this._keepAttributeChildren.toString());this._applyFilter({CVQuery:i,isEmpty:!1})}else this.buildCVQuery().then(function(t){e._applyFilter({CVQuery:t,isEmpty:!1})});this._tagsOnly=t}else this._applyFilter({CVQuery:v.buildEmptyFilter(this._rootID),isEmpty:!0});j="",this._hasAppliedNGF=!1,this.groupView&&this.groupView.setFilterState(this._filterState),sessionStorage.setItem("NGF_tagMgtRunning_"+this._UXID,!1),this._fromACTrash=!1},_onResetFilterCmd:function(e){v.setUsageTracker(this._widgetId,"NGF-ResetFilter","reset"),this._onResetFilter()},_onResetFilter:function(e){this._resetFilter({initFilterUI:1,updateAC:e&&e.context?e.context.updateAC:1}),this._keepAttributeChildren=!1,this._onKeepAttributeChildren(),this._filterIDCard&&this._filterIDCard.remove(),this._displayFilterIDCard(!1),this._isFilterFromModel=0,this._unsavedChangesMsgDisplayed=!1},_resetFilter:function(e){var t=this,i=e&&e.widgetIdent?e.widgetIdent:this._UXId;this._UXId===i&&this._emptyFilter(e),this._filterState="New",this.groupView&&this.groupView.setFilterState(this._filterState),this.setGlobalButtonsStatus(this._filterState),this._getDefaultFilterName().then(function(e){t._updateFilterTitle(e)}),e&&(void 0===e.updateAC||e.updateAC)&&t._updateActiveCriteria("",!1),this._activeFilter="",this._filterDescription=""},_onRemoveGroup:function(e){this._removeGroup(e,e.initFilterUI)},_removeGroup:function(e,t){var i=this._listGroupViewId.indexOf(e.groupId);if(-1!==i){var n=this._listGroupView[i];this._listGroupView.splice(i,1),this._listGroupViewId.splice(i,1);var s=n.collection;this.collection.removeGroupCollection(s),n.destroy();var o=this._listGroupView.length;if(0!==o){for(var r=-1,a=o-1;a>=0;a--)if(c.isModelActivated(this._listGroupView[a].model)){this.groupView=this._listGroupView[a],r=a;break}-1===r&&(this.groupView=this._listGroupView[o-1],this.groupView.setActivatedState(1)),this.groupView.setDeactivateVisible(1!==o),this.groupView.switchToEdit(),1===o&&this._divCombination&&this._divCombination.hide()}else{var l=this.getElement("#filter-groups");if(null!==l)for(;l.hasChildNodes();)l.removeChild(l.firstChild);delete this.groupView,this.nbGroupView=0,1===t&&(this._updateFilterTitle(this._defaultFilterName),this._filterState="New",this.setGlobalButtonsStatus(this._filterState),this._synthesisState=-1,this._synthesisInfos=void 0,this._initFilterGroup(),this._removeSynthesisAlert())}this._buildCombinationComboWithMinusAndSpec(),this._updateCombinationCombo(),this._updateAddSpecificationButton(),this._updateAttributeCommandsState()}},_renameFilterCmd:function(){"SaveOK"!==this._filterState?this.model.set("state","edit"):c.displayNotification({level:"info",message:r.get("UseSaveAsToRenameExistingFilter")})},_onStateChange:function(e,t){"edit"===t?(this.getElement(".global-header").addClassName("global-header-edit"),null!==this._renameFilterLineEditor&&this._renameFilterLineEditor._giveFocus()):this.getElement(".global-header").removeClassName("global-header-edit")},_createRenameFilterUI:function(){this._renameFilterLineEditor=this._createRenameFilterLineEditor()},_createRenameFilterLineEditor:function(){var e=this,t=new S({touchMode:c.TOUCH_MODE,placeholder:r.get("placeHolderFilterName")});t.value=e._defaultFilterName,t.inject(this.getElement(".global-header-filtername"),"after");var i=function(t){var i=c.checkForBadCharacters(t);return i?e._renameFilterLineEditor.getContent().removeClassName("attr-edit-inputs-Attribute-Error"):(c.displayNotification({level:"error",message:UWA.String.format(r.get("InvalidCharacters"),c.NAME_RULES.notAllowedChars.join(" "))}),e._renameFilterLineEditor.getContent().addClassName("attr-edit-inputs-Attribute-Error")),i};return t.addEventListener("focus",function(t){e._renameFilterLineEditor.getContent().hasClassName("attr-edit-inputs-Attribute-Error")||(e._renameFilterLineEditor.value=e._getFilterTitle())}),t.addEventListener("change",function(t){var n=t.dsModel.value;i(n)&&e._updateFilterTitleAndAC(n)}),t.addEventListener("blur",function(t){var n=t.dsModel.value;i(n)?e._updateFilterTitleAndAC(n):e._renameFilterLineEditor._giveFocus()}),t.addEventListener("uncommittedChange",function(e){var t=e.dsModel.valueToCommit;i(t)}),t},_updateFilterTitleAndAC:function(e){this._updateFilterTitle(e),this.model.set("state","read"),this._updateActiveCriteria(e,!1)},_updateFilterTitle:function(e){this._setFilterTitle(e),this._appliedFilterTitle&&(this._appliedFilterTitle=e);var t=this.getElement(".global-header-filtername");t.setHTML(this._getFilterTitle()),t.tooltipInfos=new D({shortHelp:r.get("ClickToRenameFilter")+" "+this._getFilterTitle(),mouseRelativePosition:!0})},_setFilterTitle:function(e){this._filterTitle=e},_getFilterTitle:function(){return this._filterTitle?this._filterTitle:this._defaultFilterName},_displayFilterIDCard:function(e,t,i){var n=this;e&&t?this._filterIDCard.updateIDCard(t,i).then(function(){n.getElement(".global-header-name-edit").hide(),n.getElement(".global-header-idcard").show()}):(this.getElement(".global-header-name-edit").show(),this.getElement(".global-header-idcard").hide())},_createGlobalFilterCommandWUX:function(){var e=this,t=this._cmdsContainer;this._densityBtn=new E({domId:"global-density-filter",touchMode:c.TOUCH_MODE,showLabelFlag:!1,displayStyle:"lite",icon:c.getIconByName(1===e._displayDensity?"view-big-tile":"view-small-tile")}),this._densityBtn.inject(t),this._densityBtn.tooltipInfos=new D({shortHelp:r.get("densityFilterTooltip"),mouseRelativePosition:!0});var i=[{type:"RadioItem",recId:"global-density-comfortable-item2-DDCtx",title:r.get("DisplayDensityComfortableItem"),icon:c.getIconByName("view-big-tile"),action:{this:this,callback:this._setDisplayDensityCmd,context:{density:1}}},{type:"RadioItem",recId:"global-density-compact-item2-DDCtx",title:r.get("DisplayDensityCompactItem"),icon:c.getIconByName("view-small-tile"),action:{this:this,callback:this._setDisplayDensityCmd,context:{density:0}}}];this._densityBtn.addEventListener("buttonclick",function(t){t.stopPropagation();var n=t.target.getBoundingClientRect();i[0].state=1===e._displayDensity?"selected|enabled":"unselected|enabled",i[1].state=0===e._displayDensity?"selected|enabled":"unselected|enabled",B.show(i,{position:{x:n.left,y:n.bottom}})});var n=new E({domId:"global-reset-filter",touchMode:c.TOUCH_MODE,showLabelFlag:!1,displayStyle:"lite",icon:c.getIconByName("reset")});n.inject(t),n.tooltipInfos=new D({shortHelp:r.get("resetFilterTooltip"),mouseRelativePosition:!0}),n.addEventListener("buttonclick",this._onResetFilterCmd.bind(this)),this._hideAttrChildren=new E({domId:"global-hide-attribute-children",touchMode:c.TOUCH_MODE,showLabelFlag:!1,displayStyle:"lite",icon:c.getIconByName("flow-children-eye-off")}),this._hideAttrChildren.setOption("isActive",!0),this._hideAttrChildren.inject(t),this._hideAttrChildren.disabled=!0,this._hideAttrChildren.tooltipInfos=new D({shortHelp:r.get("HideAttributeChildrenItem"),mouseRelativePosition:!0}),this._hideAttrChildren.addEventListener("buttonclick",this._onHideAttributeChildrenCmd.bind(this)),this._showAttrChildren=new E({domId:"global-show-attribute-children",touchMode:c.TOUCH_MODE,showLabelFlag:!1,displayStyle:"lite",icon:c.getIconByName("flow-children-eye")}),this._showAttrChildren.setOption("isActive",!1),this._showAttrChildren.inject(t),this._showAttrChildren.disabled=!0,this._showAttrChildren.tooltipInfos=new D({shortHelp:r.get("ShowAttributeChildrenItem"),mouseRelativePosition:!0}),this._showAttrChildren.addEventListener("buttonclick",this._onShowAttributeChildrenCmd.bind(this)),this._showAttrChildren.hide(),this._refineBtn=new E({domId:"global-refine-suggested-values",touchMode:c.TOUCH_MODE,showLabelFlag:!1,displayStyle:"lite",icon:c.getIconByName("list-filter")}),this._refineBtn.inject(t),this._refineBtn.tooltipInfos=new D({shortHelp:r.get("RefreshSynthesisInfosTooltip"),mouseRelativePosition:!0}),this._refineBtn.disabled=!0,this._refineBtn.addEventListener("buttonclick",function(t){v.setUsageTracker(e._widgetId,"NGF-Refine-Values","Refresh"),e._refreshSynthesisInfos(!0,!0),e._refineBtn.disabled=!0}),this._renameFilterBtn=new E({domId:"global-rename-filter",touchMode:c.TOUCH_MODE,showLabelFlag:!1,displayStyle:"lite",icon:c.getIconByName("rename")}),this._renameFilterBtn.inject(t),this._renameFilterBtn.tooltipInfos=new D({shortHelp:r.get("renameFilterTooltip"),mouseRelativePosition:!0}),this._renameFilterBtn.addEventListener("buttonclick",this._renameFilterCmd.bind(this))},_createRefeshSynthesisButton:function(e){var t=new E(c.getAttributeButtonStyle("refresh"));t.inject(e||this._Div),t.tooltipInfos=new D({shortHelp:r.get("RefreshSynthesisInfosTooltip"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+c.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attributeCriterion-edit-refresh-btn");var n=this;return t.addEventListener("buttonclick",function(e){v.setUsageTracker(n._widgetId,"NGF-Attribute","Refresh"),n.dispatchEvent("NGF_RefreshSynthesis")}),t},_createKeepAttributeChildrenUI:function(){this._showKeepAttrChildren=new E({touchMode:c.TOUCH_MODE,displayStyle:"lite",label:r.get("ShowAttributeChildren"),id:"ShowKeepAttrChildren"}),this._showKeepAttrChildren.tooltipInfos=new D({shortHelp:r.get("ShowAttributeChildrenItem"),mouseRelativePosition:!0}),this._showKeepAttrChildren.inject(this.getElement("#keepAttributeChildren")),this._showKeepAttrChildren.getContent().addClassName("keepAttributeChildrenShowButton");var e=this;this._showKeepAttrChildren.addEventListener("buttonclick",function(t){e._onShowAttributeChildrenCmd()})},_onHideAttributeChildrenCmd:function(){v.setUsageTracker(this._widgetId,"NGF-HideChildren","hideChildren"),this._onKeepAttributeChildren()},_onShowAttributeChildrenCmd:function(){this._onKeepAttributeChildren()},_onKeepAttributeChildren:function(){this._keepAttributeChildren=!0!==this._keepAttributeChildren,this.model.set("isKeepChildrenChecked",this._keepAttributeChildren),this._updateKeepAttributeChildrenUI(this._keepAttributeChildren)},_updateKeepAttributeChildrenUI:function(e){void 0===e?(this.getElement("#keepAttributeChildren").hide(),this._setKeepChildrenItemVisibilty(!1,!1)):!0===e?(this.getElement("#keepAttributeChildren").hide(),this._setKeepChildrenItemVisibilty(!0,!1)):(this.getElement("#keepAttributeChildren").show(),this._setKeepChildrenItemVisibilty(!1,!0))},_buildFilterUIFromSelectedFilter:function(e,t,i){var n=this._keepFilters[e];this._setFilterTitle(n.filterTitle);var s=this._buildFilterViewFromFilterModel(n,t,i);this._retrievedTags=s,this._isNewRepairActive&&this._isFilterBroken||(this._buildCVQueryOfSelectedFilter(s),delete this._retrievedTags)},_buildCVQueryOfSelectedFilter:function(e){var t=this;if(this._isFilterBroken||"drop"!==t._dropOption||(t._appliedFilterTitle=t._getFilterTitle(),t._updateActiveCriteria(t._getFilterTitle(),!0)),e&&0===b.getCVQueryBuildMode()){var i=this.collection.buildCVQuery(this._rootID,this._keepAttributeChildren.toString());this._appliedFilterTitle=this._filterTitle,this._applyFilter({CVQuery:i,isEmpty:!1})}else{var n=t.options.droppedInfos;n&&t.buildCVQuery().then(function(i){var s=JSON.parse(i);s&&(s.filterTitle=t._getFilterTitle(),e&&(s.tagsInMdl=e,t._tagsToApply=e)),t._applyDroppedFilters(n.retrieveFilters,n.filterId,s),delete t.options.droppedInfos})}},_buildFilterViewFromFilterModel:function(e,t,n){var s=this;this._scForSaveFilter||this._initSecurityContext(this._securityContext).then(function(e){s._defaultSC=e.default,s._scForSaveFilter=P.getPrefixedSecurityContext(s._defaultSC),s._filterIDCard.setContext({securityContext:s._defaultSC})});var o=v.getFilterUIComponents(e),a=o.length,l=o[0].toFeedUI.combinationOfSpecification||"union";l+="minus"===l?"-"+o[0].toFeedUI.minusIndex:"";var d=o[0].toFeedUI.rootIds;d=["-"].concat(o[0].toFeedUI.rootIds);t[c.FILTER_ANY_OBJECT]=this._attrFromSynthesis;for(var u=[],h={},p=1;p<a;p++){var _=this.groupView.filterViewFromModel(d[p],o[p],t,n);if(u=u.concat(_.attrNotFound),_.retrievedTags&&(_.retrievedTags.localfilters||(_.retrievedTags.localfilters={},_.retrievedTags.localfilters=_.retrievedTags.allfilters),h=_.retrievedTags,this._tagsInMdl=_.retrievedTags,this._tagsToApply=this._tagsInMdl,"dropOnFilter"===this._dropOption&&c.displayNotification({level:"info",message:r.get("filterWithNonAppliedTag")})),p!==a-1){var f=this._listGroupView.length-1;this._listGroupView[f].model.set("state","read"),this._addGroupView()}}if(this._updateAddSpecificationButton(),x.unmask(s.container),u.length&&(u=[...new Set(u)],c.displayAttrNotFoundNotif(u)),s._isFilterBroken){x.mask(s.container);var m=new i.Element("div",{html:"<p>"+r.get("BrokenFilterWarning")+"</p>"}),g=new I({identifier:"NGF_ConfirmRequest"});g.inject(document.body);var b=new F({touchMode:!0,modalFlag:!0,title:r.get("RepairFilterTitle"),content:m,immersiveFrame:g,buttons:{Cancel:new E({class:"repair-cancel",label:r.get("CancelSolveUI"),emphasize:"secondary",onClick:function(e){b.close(),function(){x.unmask(s.container),s._onRedraw({filterId:s.options.UXId}),s._cancelRepairFilter()}.call()}}),Ok:new E({class:"repair-solve",label:r.get("SolveButton"),emphasize:"primary",onClick:function(e){b.close(),function(){s.BrokenPathForRender=s._filterRepairView._createJSONForRepairWebservice();var e={url:c.getPlatformServiceUrl(),ctx:s._defaultSC},t=c.getGlobalEditContainer(s._UXId);null!==t&&(s._filterRepairView.logWebServiceOptions(e),s._filterRepairView.fetchRepairedPathsFromWebService(s.BrokenPathForRender).then(function(e){"RepairFilterFetchData_FAILURE"!==e&&(t.empty(),s._filterRepairView.render().getContent().inject(t)),x.unmask(s.container)})),s._onRedraw({filterId:s.options.UXId}),s._onACCriteria(s._getFilterTitle()),s.droppedFilter&&c.openFilterPanel(s.options.UXId)}.call()}})}});s._addMenuClass(s._currentMenuClass),b.addEventListener("close",function(e){s._removeMenuClass(s._currentMenuClass)})}if(this._combinationCombo&&(this._combinationCombo.currentValue=l),1===this.collection.getGroupCollectionCount()){var C=o[0].toFeedUI.keepChildren;void 0!==C&&this._keepAttributeChildren!==C&&this._onKeepAttributeChildren()}return this._displayFilterIDCard(!0,this._activeFilter),this._isFilterFromModel=1,this._currentFilterSpecification=JSON.stringify(s.getFilterSpecification(s._rootID,s._keepAttributeChildren)),this._unsavedChangesMsgDisplayed=!1,this._updateAttributeCommandsState(),h},_updateAttributeCommandsState:function(e){for(var t=this._listGroupView.length,i=0;i<t;i++){var n=this._listGroupView[i].getCriteriaViewsByType("attribute").concat(this._listGroupView[i].getCriteriaViewsByType("Sequence"));if(n.length){var s=1===n.length&&n[0].isViewEdited()?0:1;this._onAttributeCommandsState({enable:s});break}}},_cancelSearch:function(e){},_initFiltersToKeep:function(e,t){var s=this;return new n(function(n,o){var r={},a=[],l=function(e){e.forEach(function(e){(e=v._getFilterSpecification(e)?i.clone(v._getFilterSpecification(e).data):e).filterName=e&&e.filterName?e.filterName:s._defaultFilterName;var t=e.filterName;r[t]||(r[t]={}),r[t].rootPhysicalId=e.rootPhysicalId||e.rootID,r[t].filterUIComponents=e.filterUIComponents||e.filterMdl,r[t].filterDescription=e.filterDescription,r[t].filterTitle=e.filterTitle?e.filterTitle:s._defaultFilterName,r[t].filterPhysicalId=e.filterPhysicalId||e.filterId,r[t].pathDB={added:{physical:e.addedNodesList_PhysicalID?JSON.parse(e.addedNodesList_PhysicalID):[],logical:e.addedNodesList_LogicalID?JSON.parse(e.addedNodesList_LogicalID):[]},excluded:{physical:e.excludedNodesList_PhysicalID?JSON.parse(e.excludedNodesList_PhysicalID):[],logical:e.excludedNodesList_LogicalID?JSON.parse(e.excludedNodesList_LogicalID):[]},proximity:{physical:e.proximityNodesList_PhysicalID?JSON.parse(e.proximityNodesList_PhysicalID):[],logical:e.proximityNodesList_LogicalID?JSON.parse(e.proximityNodesList_LogicalID):[]}},a.push(t),0===b.getCVQueryBuildMode()&&R.buildCVQueryFromModel(e),r[t].filterCVQuery=e.filterCVQuery})},d=function(e,t){t?s._checkAndRepairFilterIfNeeded(e).then(function(){n({filters:r,names:a})}):n({filters:r,names:a})};Array.isArray(e)&&"object"==typeof e[0]?(l(e),d(r[a[0]],t)):b.getPlatformServices(v.getTenant()).then(function(){x.mask(s.container),v.getAllDataFromFilterIds("object"==typeof e?e.filterId:e,v.getTenant()).then(function(e){e&&e.success?(l(e.success),d(r[a[0]],t)):(x.unmask(s.container),o({filters:r,names:a,failure:e?e.failure:[]}))})})})},_buildViewFromSearch:function(e,t,i){var n,s,o=this,a=i&&!i.resetFilter?0:1;a&&(this._resetFilter({initFilterUI:1}),this._filterState="SaveOK");for(var l=0;l<e.length;l++)for(var d=0;d<e[l].length;d++)if(t===e[l][d].filterId){n=e[l][d].filterId,s=e[l][d].name,e[l][d].filterTitle;break}if(void 0===n){var u=t;v.getFilterDataFromFilterId(u,v.getTenant()).then(function(e){if(e.success){n=u,s=e.success[0].filterName,e.success[0].filterTitle;var t=e.success[0].rootPhysicalId;o._rootID!==t?c.displayNotification({level:"error",message:r.get("RecentFilterKO")}):o._buildFromSelectedFilterData(n,s,i,a)}else c.displayNotification({level:"warning",message:r.get("invalidFilterId")})},function(e){})}else o._buildFromSelectedFilterData(n,s,i,a)},_buildFromSelectedFilterData:function(e,t,i,n){var s=this,o=e;this._keepFilters={},this._keepFilterNames=[],this._initFiltersToKeep(o,this.retrieveFilter).then(function(o){s._keepFilters=o.filters,s._keepFilterNames=o.names,t!==o.names[0]&&(s._keepFilters[t]=o.filters[o.names[0]],s._keepFilterNames=[t]);var a=s._keepFilters[t];s._filterDescription=a.filterDescription;var l=function(o){c.checkAndGetListOfAttributesFromSelectedFilter(o).then(function(a){var l;0===b.getCVQueryBuildMode()&&(l=c.upgradeAndCompleteQuery(JSON.parse(o.filterCVQuery))),l=JSON.parse(o.filterCVQuery),o.filterCVQuery=l;var d=s._listGroupView.length,u=o.filterUIComponents.length-1,h=o.filterUIComponents;h&&1>=h&&!h[1].filterSpecificationName&&u--;var p=d+u-(i?0:1);if(c.MAX_FILTER_SPECIFICATION>=p){var _=h[0].toFeedUI.rootIds||[];if(_.length&&s._linkedRoots){var f=[];s._linkedRoots.forEach(e=>{-1===_.findIndex(t=>e.id===t)&&f.push(e.alias)}),f.length&&c.displayNotification({level:"warning",message:r.get("RestoreFilterWithAnotherLinkedRoot")+f.toString()})}o.filterTitle=i&&i.addExisting?s._getFilterTitle():o.filterTitle,n?-1===s._synthesisState?(s._buildFromSelectedFilter(e,t,a,s._synthesisInfos,n,p,o.filterTitle),s.setGlobalButtonsStatus(s._filterState),s._removeSynthesisAlert()):c.getExpandSynthesisInfos(s._getExpandContext(),s._appQueryParam).then(function(i){s._synthesisInfos=i,s._buildFromSelectedFilter(e,t,a,s._synthesisInfos,n,p,o.filterTitle),s.setGlobalButtonsStatus(s._filterState),s._removeSynthesisAlert()},function(i){s._buildFromSelectedFilter(e,t,a,s._synthesisInfos,n,p,o.filterTitle),s.setGlobalButtonsStatus(s._filterState),s._displaySynthesisAlert()}):s._buildFromSelectedFilter(e,t,a,s._synthesisInfos,n,p,o.filterTitle)}else{if(!n){var m=i.editedModel;m&&m.set("state","edit")}var g=UWA.String.format(r.get("maxFilterSpecOnRetrieveFilter"),c.MAX_FILTER_SPECIFICATION);c.displayNotification({level:"warning",message:g})}s.setGlobalButtonsStatus(s._filterState),s.groupView&&s.groupView.setFilterState(s._filterState)})};-1===s._synthesisState?s._computeSynthesisFromModel(a).then(e=>{s._synthesisInfos=e,c.computeAttributesFromSynthesis(s._synthesisInfos).then(function(e){s._attrFromSynthesis=e,l(a)},function(e){s._attrFromSynthesis=e,l(a)})}):l(a)},function(e){s._filterState="New",s._displayNotifOnActionFilterFailed("FilterCanNotBeRestored",e)})},_displayNotifOnActionFilterFailed:function(e,t){var n=[];t&&t.failure&&t.failure.forEach(e=>{e.filterTitle&&n.push(e.filterTitle)}),c.displayNotification({level:"error",message:i.String.format(r.get(e),n.toString())})},_buildFromSelectedFilter:function(e,t,i,n,s,o,a){s||(this._addGroupView(),this._updateCombinationCombo()),this.groupView.setSynthesisInfos({synthesis:n,state:this._synthesisState});var l=this._activeFilter;if(this._activeFilter=s?e:this._activeFilter,this._buildFilterUIFromSelectedFilter(t,i,c.getTypesOfSynthesis(n)),s?(this._activeFilter=e,this._updateFilterTitle(a)):this._activeFilter=l,c.MAX_FILTER_SPECIFICATION===o){var d=UWA.String.format(r.get("maxFilterSpecDefined"),c.MAX_FILTER_SPECIFICATION);c.displayNotification({level:"info",message:d})}this._updateAddSpecificationButton()},in_apps_search:function(e){var t=this;this._internals={registrationOpts:function(){return{title:r.get("SearchFilters"),mode:"furtive",default_with_precond:!0,show_precond:!1,widget_id:t._widgetId,app_socket_id:"NGFilter_"+t._widgetId,idcard_activated:!1,tenant:v.getTenant(),multiSel:!!v.isDebugActive("extendedCmds")&&(e.multiSel||!0),recent_search:{types:["ENOStrRefinementSpecification"]},UXOptions:{dnD:!1,localActions:!1,searchRecentContent:!0,globalToolbarActions:{saveAsFavorite:!1,export:!1,print:!1}}}}};var n=i.extend(this._internals.registrationOpts(),e),o=new s.Socket(n.app_socket_id,{dispacthRetryInterval:0});!0===e.debug_mode&&o.setDebugMode(!0),e.parent_window?o.subscribeServer("SearchComServer",window):o.subscribeServer("SearchComServer"),o.dispatchEvent("RegisterContext",n),e.context_name&&(n.context_title=e.context_name),n.default_search_criteria=e.fts_value,o.dispatchEvent("InContextSearch",n),o.addListener("Selected_Objects_search",function(i){if(i.length>1)if(v.isDebugActive("extendedCmds")&&e.multiSel){if("function"==typeof e.callback){var n=[];i.forEach(e=>{n.push(e.resourceid_value)}),e.callback.call(t,n)}}else console.log("No MultiSel allowed");else"function"==typeof e.callback&&e.callback.call(t,i[0].resourceid_value);o.removeListener("onCloseTransient"),o.disconnect()}),o.addListener("onCloseTransient",function(t){"function"==typeof e.cancel&&e.cancel(null),o.dispatchEvent("UnregisterContext",n.widget_id),o.removeListener("onCloseTransient"),o.disconnect()})},_onEditGroup:function(e){if(this.groupView.cid!==e.groupId){for(var t=this._listGroupView.length,i=0;i<t;i++)if(this._listGroupView[i].cid===e.groupId){this.groupView.model.set("state","read"),this.groupView=this._listGroupView[i];break}this.setGlobalButtonsStatus(this._filterState)}},_isFilterValid:function(){for(var e=!0,t=this._listGroupView.length,i=0;i<t&&e;i++){var n=this._listGroupView[i];null!==n&&n.isViewEdited()&&"function"==typeof n.areCriteriaValid&&(e=n.areCriteriaValid())}return e},validateEditedCriterion:function(e){if(0===c.isAsynchronousValidation())return this.validateEditedCriterionSync(this,e);var t=this._listGroupView.length,i=!t;if(t){i=!0;for(var s=[],o=0;o<t&&i;o++){var r=this._listGroupView[o];r&&r.isViewEdited()&&s.push(r.areCriteriaValidate(e))}return n.all(s).then(function(t){i=!0;for(var n=t.length,s=0;s<n&&i;s++)i=t[s];return i&&e&&"function"==typeof e.callback&&e.callback(e),i})}return new n(function(e){e(i)})},_onAddNewFilterSpecification:function(e){var t=this;0===c.isAsynchronousValidation()?t._onAddNewFilterSpecificationSync(t):this.validateEditedCriterion().then(function(n){if(n){if(t.groupView.model.set("state","read"),t._addGroupView(),e){var s=t.collection.keepComponentsToFeedUI(t._rootID,t._keepAttributeChildren,void 0,{keepEmpty:!0}),o=t._listGroupViewId.indexOf(e.specId),a=[];a.push(i.clone(s[0])),a.push(i.clone(s[o+1])),c.checkAndGetListOfAttributesFromSelectedFilter({filterUIComponents:a}).then(function(i){var n=c.getTypesOfSynthesis(t._synthesisInfos);i[c.FILTER_ANY_OBJECT]=t._attrFromSynthesis,t.groupView.filterViewFromModel(e.rootId,a[1],i,n),t.groupView.updateDuplicatedView(e)})}if(t._buildCombinationComboWithMinusAndSpec(),t._updateCombinationCombo(),c.MAX_FILTER_SPECIFICATION===t._listGroupView.length){t._updateAddSpecificationButton();var l=UWA.String.format(r.get("maxFilterSpecDefined"),c.MAX_FILTER_SPECIFICATION);c.displayNotification({level:"info",message:l})}}})},_onAddExistingFilterSpecificationWUX:function(e){var t=e.context.relatedTo,i=-1;c.FILTER_RELATED_TO_ROOT===t?i=1:c.FILTER_RELATED_TO_ALL_REVISIONS===t?i=2:c.FILTER_RELATED_TO_ANY_ROOT===t&&(i=3),v.setUsageTracker(this._widgetId,"NGF-Multi-Specification",{label:"existing",value:i}),c.setReferenceTime(Date.now()),this._onAddExistingFilterSpecification(t)},_onAddExistingFilterSpecification:function(e){var t=this;if(0===c.isAsynchronousValidation())t._onAddExistingFilterSpecificationSync(t);else{var i=t._listGroupView.find(function(e){return"edit"===e.model.get("state")}),n=i?i.model:void 0;n&&this.validateEditedCriterion().then(function(i){if(i){var s={resetFilter:!1,editedModel:n,addExisting:1};t.retrieveFiltersRelatedTo({type:e,rootIDs:[t._rootID]},s)}})}},_createCombination:function(){var e=i.createElement("div",{class:"filter-groups-Combination"});return e.inject(this.getElement("#filter-groups"),"before"),this._followingLabel=this._createCombinationLabel(),this._followingLabel.inject(e),this._combinationCombo=this._createCombinationComboWithMinus(),this._combinationCombo.inject(e),e},_createCombinationLabel:function(){return i.createElement("label",{class:"innerfiltertypecombo",text:r.get("FollowingCombination"),id:"global-combination-specification-label"})},_createCombinationComboWithMinus:function(e,t){var i=e;i||(t=void 0!==t?t:1,t=Math.min(t,1),i=[{labelItem:r.get("AllCombination"),valueItem:"intersection"},{labelItem:r.get("AnyCombination"),valueItem:"union"}]);var n=this._buildCombinationCombo("combination-specification",i);return n.selectedIndex=void 0!==t?t:1,n.getContent().addClassName(c.FILTER_TOUCH_CLASS),2<i.length?n.getContent().addClassName("minus-items"):n.getContent().removeClassName("minus-items"),n},_buildCombinationCombo:function(e,t){var i=new w({touchMode:c.TOUCH_MODE,elementsList:t,preselectedIndex:-1,enableSearchFlag:!1,domId:e}),n=this;return i.addEventListener("change",function(e){var t=e.dsModel.currentValue;if(-1===t.indexOf("minus"))n.model.set("combinationOfSpecification",t),n.model.unset("minusIndex"),n._followingLabel.show(),"union"===t?1:2;else{var i=t.split("-");n.model.set("combinationOfSpecification",i[0]),n.model.set("minusIndex",i[1]),n._followingLabel.hide(),i[0],3}n._updateAddSpecificationButton(t)}),i},_createNewSpecificationBtn:function(e){var t=new E({domId:"addNewSpec",touchMode:!0,displayStyle:"normal",label:r.get("addNewSpecification"),icon:"plus"});t.inject(e),t.tooltipInfos=new D({shortHelp:r.get("addNewSpecificationTooltip"),mouseRelativePosition:!0});var i=this;return t.addEventListener("buttonclick",function(e){v.setUsageTracker(i._widgetId,"NGF-Multi-Specification","new"),c.setReferenceTime(Date.now()),i._onAddNewFilterSpecification()}),t},_createExistingSpecificationBtnWUX:function(e){var t=new E({domId:"addExistingSpec",touchMode:!0,displayStyle:"normal",label:r.get("addExistingSpecification"),icon:"plus"});t.inject(e),t.tooltipInfos=new D({shortHelp:r.get("addExistingSpecificationTooltip"),mouseRelativePosition:!0}),this._ExistingContextualMenu=[{type:"PushItem",title:i.String.format(r.get("SearchOnRoot"),this._rootAlias),tooltip:i.String.format(r.get("SearchOnRootTooltip"),this._rootAlias),icon:T.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterOpenFilter.png"),action:{this:this,callback:this._onAddExistingFilterSpecificationWUX,context:{relatedTo:c.FILTER_RELATED_TO_ROOT}}},{type:"PushItem",title:i.String.format(r.get("SearchOnAllRevisions"),this._rootAlias),tooltip:i.String.format(r.get("SearchOnAllRevisionsTooltip"),this._rootAlias),icon:T.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterCopyFilter.png"),state:"3DSpace"===this._pfServiceId?"enabled":"disabled",action:{this:this,callback:this._onAddExistingFilterSpecificationWUX,context:{relatedTo:c.FILTER_RELATED_TO_ALL_REVISIONS}}},{type:"PushItem",title:r.get("CopyFromAnyFilters"),tooltip:r.get("SearchAnyTooltip"),icon:T.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterCopyFilter.png"),action:{this:this,callback:this._onAddExistingFilterSpecificationWUX,context:{relatedTo:c.FILTER_RELATED_TO_ANY_ROOT}}}];var n=this;return t.addEventListener("buttonclick",function(e){e.stopPropagation();var t=e.target.getBoundingClientRect();B.show(n._ExistingContextualMenu,{position:{x:t.left,y:t.bottom}})}),this._fakeAddExistingSpecBtn=new E({domId:"addExistingSpec",touchMode:!0,displayStyle:"normal",label:r.get("addExistingSpecification"),icon:"plus"}),this._fakeAddExistingSpecBtn.inject(e),this._fakeAddExistingSpecBtn.disabled=!0,this._fakeAddExistingSpecBtn.hide(),t},_updateCombinationCombo:function(){this._combinationCombo&&this._combinationCombo.show()},_buildCombinationComboWithMinusAndSpec:function(){var e=void 0,t=this.collection.getActiveGroupCollection();if(2===t.length){e=[{labelItem:r.get("AllCombination"),valueItem:"intersection"},{labelItem:r.get("AnyCombination"),valueItem:"union"}];var i=r.get("MinusCombination")+" ";t.forEach((t,n)=>{e.push({labelItem:i+t.getFilterSpecificationName(),valueItem:"minus-"+n})})}var n=0;this._combinationCombo&&(n=this._combinationCombo.selectedIndex,this._combinationCombo.remove(),delete this._combinationCombo),this._combinationCombo=this._createCombinationComboWithMinus(e,n),this._combinationCombo.inject(this._followingLabel,"before")},_onAttributeCommandsState:function(e){var t=!e||!e.enable;this._refineBtn.disabled=t,this._hideAttrChildren.disabled=t,this._showAttrChildren.disabled=t},_updateAddSpecificationButton:function(e){this._addNewSpecBtn&&this._addExistingSpecBtn&&(this._isThereCriteriaDefined()?(this._addNewSpecBtn.show(),this._fakeAddExistingSpecBtn.visibleFlag||this._addExistingSpecBtn.show(),this._updateApplySaveSaveAsState({status:"ValidOK"})):(this._addNewSpecBtn.hide(),this._addExistingSpecBtn.hide(),this._updateApplySaveSaveAsState({status:"NewOK"})),2===this._listGroupView.length?e&&-1!==e.indexOf("minus")?(this._addNewSpecBtn.disabled=!0,this._addExistingSpecBtn.hide(),this._fakeAddExistingSpecBtn.show()):(this._addNewSpecBtn.disabled=!1,this._addExistingSpecBtn.show(),this._fakeAddExistingSpecBtn.hide()):c.MAX_FILTER_SPECIFICATION===this._listGroupView.length?(this._addNewSpecBtn.disabled=!0,this._addExistingSpecBtn.hide(),this._fakeAddExistingSpecBtn.show(),this._duplicateSpecDisabled||(this._listGroupView.forEach(e=>{e.setEnableDuplication(!1)}),this._duplicateSpecDisabled=1)):(this._addNewSpecBtn.disabled=!1,this._fakeAddExistingSpecBtn.hide(),this._duplicateSpecDisabled&&(this._duplicateSpecDisabled=0,this._listGroupView.forEach(e=>{e.setEnableDuplication(!0)}))))},setTagsDataOnNGF:function(e){if(e&&this._listGroupView){j&&this._hasAppliedNGF||("createFromTag"===e.dropOption?this._tagsOnly=!0:"drop"===e.dropOption?this._tagsOnly=!1:"dropOnFilter"!==e.dropOption?this._tagsOnly=!0:console.log("FilterViewManager.get3DXView, unknown case of dropOption"+options.dropOption)),this._tagsInMdl=i.clone(e.tagData);for(var t=0;t<this._listGroupView.length;t++)this._listGroupView[t].createTagNGF(e.tagData);if("createFromTag"===e.dropOption)if(this._hasAppliedNGF||this._hasTag()){var n=this;if(0===b.getCVQueryBuildMode()){var s=this.collection.buildCVQuery(this._rootID,this._keepAttributeChildren.toString());this._applyFilter({CVQuery:s,isEmpty:!1})}else this.buildCVQuery().then(function(e){n._applyFilter({CVQuery:e,isEmpty:!1,tagsInMdl:n._tagsInMdl})})}else this._applyFilter({CVQuery:v.buildEmptyFilter(this._rootID),isEmpty:!0,tagsInMdl:this._tagsInMdl})}else console.log("RCIII GlobalFilterView : should have group view in existing GlobalFilterView")},updateDataOnNGF:function(e){var t={};t.rootID=e.rootID,t.rootAlias=e.rootAlias,this._onSelectObject(t)},_onSpecificationStateChange:function(){for(var e,t=this._listGroupView.length,i=0;i<t;i++){var n=this._listGroupView[i].model;if(c.isModelActivated(n)){e=n;break}}this._setApplySelectable(!!e),this._buildCombinationComboWithMinusAndSpec()},setGlobalButtonsStatus:function(e){switch(this._renameFilterBtn.disabled="SaveOK"===e,e){case"New":this._setApplySelectable(!1),this._setSaveSelectable(!1),this._setSaveAsSelectable(!1);break;case"ValidOK":this._setApplySelectable(!0),this._setSaveSelectable(!0),this._setSaveAsSelectable(!1);break;case"SaveOK":this._setApplySelectable(!0),this._setSaveSelectable(!0),this._setSaveAsSelectable(!0)}},_setApplySelectable:function(e){this._applyFilterButton.disabled=0==e},_setSaveSelectable:function(e){this._saveFilterButton.disabled=0==e},_setSaveAsSelectable:function(e){this._saveAsFilterButton.disabled=0==e},_updateApplySaveSaveAsState:function(e){var t=e.status;this._filterState="ValidOK"===t&&"SaveOK"===this._filterState?this._filterState:t,this.groupView&&(this.groupView.setFilterState(this._filterState),this.setGlobalButtonsStatus(this._filterState))},_getExpandContext:function(){return{rootID:this._rootID,securityContext:this._defaultSC,tenant:v.getTenant(),widgetId:this._widgetId,pfServiceId:this._pfServiceId}},_setDisplayDensityCmd:function(e){var t=e.context.density;this._setDensity(t),this._densityBtn.icon=c.getIconByName(1===this._displayDensity?"view-big-tile":"view-small-tile")},_setDensity:function(e){if(this._displayDensity!==e&&(v.setUsageTracker(this._widgetId,"NGF-Density",1===e?"comfortable":"compact"),this._displayDensity=e,localStorage.setItem("NGF_DisplayDensity",e),c.updateTouchMode(!!e),this.collection)){var t,i=this._listGroupView.findIndex(e=>!!(t=e.getEditedCriterion())),n=this.getFilterSpecification(this._rootID,this._keepAttributeChildren,void 0,{keepEmpty:!0}),s={filterUIComponents:n},o=this;c.checkAndGetListOfAttributesFromSelectedFilter(s).then(function(e){var s=c.getTypesOfSynthesis(o._synthesisInfos);e[c.FILTER_ANY_OBJECT]=o._attrFromSynthesis,o._emptyFilter(),n.shift();var r=n[0].toFeedUI.rootIds||[o._rootID];n.forEach((t,i)=>{o._initFilterGroup(),o.groupView.filterViewFromModel(r[i],t,e,s)}),-1!==i&&o._listGroupView[i].setCrtierionAsEdited(t)})}},_checkAndRepairFilterIfNeeded:function(e){var t=this;return t._isFilterBroken=!1,new n(function(i){var n;if(e)n={filterUIComponents:e.filterUIComponents,pathDB:e.pathDB};else if(t._keepFilterNames&&t._keepFilterNames.length){var s=t._keepFilterNames[0];n={filterUIComponents:t._keepFilters[s].filterUIComponents,pathDB:t._keepFilters[s].pathDB}}else n={filterUIComponents:t.options.filterUIComponents};t._filterRepairView.checkForBrokenLinksInFilter(n).then(function(e){if(Array.isArray(e.pathsToFeedUI))if("3DSpace"!==t._pfServiceId){var s=r.get("RepairFilterNotAvailableOutOf3DSpace");console.log("==> _checkAndRepairFilterIfNeeded() /  "+s),i()}else e.indexOfGroupViewToRepair.forEach(t=>{(n.filterUIComponents[t].toFeedUI||[]).forEach(i=>{var n=i.criteriaType;"context"===n?i=e.pathsToFeedUI[t]:"volume"===n&&(i=e.pathsToFeedUI[t])})}),t._isFilterBroken=!0,t._filterRepairView.logBrokenFiltersInfo(e.pathsToFeedUI),i(n);else"PathsOK"!==e&&"NoContextFilter"!==e||i()})})},_updateContextFilterModel_FromRepairPanel:function(e){for(var t=this,i=!1,n=0;n<this._listGroupView.length;n++){this._listGroupView[n].updateModelsFromRepair(e).forEach(e=>{e.modelUpdated&&(i=i||e.modelUpdated,t._listGroupView[n].buildViewsFromRepairModel(e.attributes))})}i&&(t._filterState="SaveOK",t.setGlobalButtonsStatus(t._filterState),t.groupView&&t.groupView.setFilterState(t._filterState))},buildCVQuery:function(){var e=this;return new n(function(t,i){e.collection.buildCVQuery(e._defaultSC,e._queryFormat,e._rootID,e._keepAttributeChildren.toString(),e._tagsOnly).then(function(e){t(e)},function(e){})})},buildCVQueryFromFilterSpec:function(e){var t=this;return new n(function(i,n){t.collection.buildCVQueryFromFilterSpec(t._defaultSC,t._queryFormat,t._rootID,t._keepAttributeChildren.toString(),e).then(function(e){i(e)},function(e){})})},_addMenuClass:function(e){if(e){var t=document.body;t.addClassName(e);var i=t.querySelector(".column.left");i&&i.addClassName(e)}},_removeMenuClass:function(e){if(e){var t=document.body;t.removeClassName(e);var i=t.querySelector(".column.left");i&&i.removeClassName(e)}},addNewCriterion:function(e){!this._cmdsContainer.visibleFlag&&this._cmdsContainer.show(),this.groupView._addNewCriterion(e)},retrieveFiltersRelatedTo:function(e,t){this.retrieveFilter=!0,this.droppedFilter=!1;var i=e.type;if("3DSpace"!==this._pfServiceId&&(c.FILTER_RELATED_TO_ROOT===i||c.FILTER_RELATED_TO_ANY_ROOT===i)){var n=r.get("only3DSpaceResults");console.log("==> retrieveFiltersRelatedTo() /  "+n)}var s=this;b.getPlatformServices(v.getTenant()).then(function(){c.FILTER_RELATED_TO_ROOT===i?s._retrieveFiltersRelatedToRoots(e.rootIDs,t):c.FILTER_RELATED_TO_ALL_REVISIONS===i?s._retrieveFiltersRelatedToAllRevisions(e.rootIDs,t):c.FILTER_RELATED_TO_ANY_ROOT===i&&s._retrieveFiltersRelatedToQuery(e.query,t)})},_retrieveFiltersRelatedToRoots:function(e,t){var i=this,n=Date.now(),s=e||[this._rootID];u.retrieveAllFilters(s).then(function(e){if(v.setPerformanceTracker(i._widgetId,"NGF-Search_Filters","NGFilter_UX",{Retrieve_Filters_duration:Date.now()-n,Retrieved_Filters:e.length},1),e.length>=0){var s=[];e.forEach(function(e){s.push(e.filterId)});var o="(physicalid:"+(s.length?s.join(" OR physicalid:"):"null")+")";i.in_apps_search({precond:o,title:r.get("SearchFilters"),callback:function(n){i.groupView.model.set("state","read"),i._dropOption="dropOnFilter",c.setReferenceTime(Date.now()),i._buildViewFromSearch.call(i,[e],n,t),i._onDisplayGlobalFilterView(),c.openFilterPanel("NGF_Search_"+Date.now())},cancel:function(){i._cancelSearch.call(i,i.options),c.openFilterPanel("NGF_Search_"+Date.now())}})}else c.displayNotification({level:"info",message:r.get("NoFilterFound")})})},_retrieveFiltersRelatedToAllRevisions:function(e,t){var i=this,n=Date.now(),s=e||[this._rootID];s="string"==typeof s?[s]:s;var o=[];c.executeFetch(s).then(function(e){e.results.forEach(e=>{var t=e.attributes.find(function(e){return"logicalid"===e.name});t&&-1===o.indexOf(t.value)&&o.push(t.value)}),u.retrieveAllRoots(o).then(function(e){(e=e.filter(function(e){return-1===s.indexOf(e)})).length?u.retrieveAllFilters(e).then(function(e){if(v.setPerformanceTracker(i._widgetId,"NGF-Search_Filters","NGFilter_UX",{Retrieve_Filters_duration:Date.now()-n,Retrieved_Filters:e.length},1),e.length){var s=[];e.forEach(function(e){s.push(e.filterId)});var o=s.join(" OR physicalid:");o="(physicalid:"+o+")",i._retrieveFiltersRelatedToQuery(o,t)}else c.displayNotification({level:"info",message:r.get("NoFilterFound")})}):c.displayNotification({level:"info",message:r.get("NoRevisonFound")})},function(e){console.log(" Retrieve All Roots failed, error = "+e)})},function(e){console.log("Retrieve logical IDs failed, error = "+e)})},_retrieveFiltersRelatedToQuery:function(e,t){var i=this;(t=t||{}).displayNotif=1,t.resetFilter=void 0===t.resetFilter||t.resetFilter,this.in_apps_search({precond:e||"[ds6w:type]:ENOStrRefinementSpecification",title:r.get("SearchFilters"),callback:function(e){c.setReferenceTime(Date.now()),v.getAllDataFromFilterIds(e,v.getTenant()).then(function(e){if(e&&e.success){var n=e.success[0];c.checkAndGetListOfAttributesFromSelectedFilter(n).then(function(e){i._buildFilterUIFromFilterRelatedToQuery(n,e,i._rootID,t)})}else i._displayNotifOnActionFilterFailed("FilterCanNotBeRestored",e)}),c.openFilterPanel("NGF_Search_"+Date.now())},cancel:function(){i._cancelSearch.call(i,i.options),c.openFilterPanel("NGF_Search_"+Date.now())}})},buildFilterUIFromFilterRelatedToQuery:function(e,t,i,n){this.groupView&&this.groupView.isThereCriteria()&&(this._onACCriteria(this._getFilterTitle()),this._onResetFilter());var s=this;return new Promise(function(o){s._buildFilterUIFromFilterRelatedToQuery(e,t,i,n).then(function(e){o(e)})})},_buildFilterUIFromFilterRelatedToQuery:function(e,t,n,s){var o=this;return new Promise(function(n){var a=o._listGroupView.length,l=e.filterUIComponents.length-1,d=e.filterUIComponents;d&&1>=d&&!d[1].filterSpecificationName&&l--;var u=a+l-(s?0:1),h=s&&!s.resetFilter?0:1;if(c.MAX_FILTER_SPECIFICATION>=u)0===h&&(o.groupView&&o.groupView.model.set("state","read"),o._addGroupView(),o._buildCombinationComboWithMinusAndSpec(),o._updateCombinationCombo()),c.checkCompatibiltyFilterRules(o._defaultSC,o._rootID,e,s?s.displayNotif:1,o._pfServiceId).then(function(e){o._dropOption="dropOnFilter";var s=function(e,s){var r=c.getTypesOfSynthesis(s||o._synthesisInfos);o._buildFilterViewFromFilterModel(e.filterSpec,t,r),o._onDisplayGlobalFilterView(),n(i.merge({rootID:o._rootID,rootAlias:o._rootAlias},e.result))};-1===o._synthesisState?o._computeSynthesisFromModel(e.filterSpec).then(i=>{c.computeAttributesFromSynthesis(i).then(function(n){o._attrFromSynthesis=n,t[c.FILTER_ANY_OBJECT]=o._attrFromSynthesis,s(e,i)})}):c.getExpandSynthesisInfos(o._getExpandContext(),o._appQueryParam).then(function(t){s(e,t)})},function(){o._goToHomePage()});else{if(0===h){var p=s.editedModel;p&&p.set("state","edit")}var _=UWA.String.format(r.get("maxFilterSpecOnRetrieveFilter"),c.MAX_FILTER_SPECIFICATION);c.displayNotification({level:"warning",message:_})}})},_goToHomePage:function(e){e?this._onACCriteria(e):this._onACTrash(),this._onResetFilter(),this._onAttributeCommandsState({enable:0}),this._cmdsContainer.hide(),this.dispatchEvent("NGF_GoToWelcomePage")},_onDisplayGlobalFilterView:function(e){!this._cmdsContainer.visibleFlag&&this._cmdsContainer.show(),this.dispatchEvent("NGF_DisplayGlobalFilterView")},_applyDroppedFilters:function(e,t,n){var s=this,o={success:[],failure:[]};if(e.failure&&o.failure.push(e.failure[0]),e.success){var r=e.success[0];n.appId=s._appId,n.widget=s._widgetId,n.filterRootIds=[r.rootPhysicalId||r.rootID],sessionStorage.setItem("NGF_isUXBuilt_"+s._UXId,!0),this._removeUselessQueries(n);var a=function(e){s.dispatchConfigRevision(!1),y.publish("NGFilter.ApplyDroppedFilters/"+s._UXId,e)};if(this._isFilterBroken)if(0===b.getCVQueryBuildMode()){var l=s._updateDataForAppCB(e);a(l)}else s._updateDataForAppCBAsync(e).then(function(e){a(e)});else{var d=v._getFilterSpecification(r)?i.clone(v._getFilterSpecification(r).data):void 0;o.success.push({rootId:r.rootPhysicalId||r.rootID,rootAlias:r.rootAlias,filterId:t,filterTitle:d?d.filterTitle:void 0,filterMdl:d?d.filterMdl:void 0,filter:n,fromDropOnFilter:"dropOnFilter"===(d?d.dropOption:void 0),tagsInMdl:"dropOnFilter"===(d?d.dropOption:void 0)?void 0:n.tagsInMdl}),a(o)}}},_updateDataForAppCB:function(e){var t={success:[],failure:[]};if(e&&e.success)for(var i=0;i<e.success.length;i++){var n=e.success[i],s=R.buildCVQueryFromModel(n),o=c.upgradeAndCompleteQuery(JSON.parse(s));o.appId=this._appId,o.widget=this._widgetId,o.filterRootIds=[n.rootPhysicalId];var r={rootId:n.rootPhysicalId,filterId:n.filterId,filterName:n.filterName,filter:o,fromDropOnFilter:this.options.fromDropOnFilter};t.success.push(r)}return t},_updateDataForAppCBAsync:function(e){var t=this,i={};if(e&&e.success){i.success=[],i.failure=[];for(var s=[],o=function(e){return new n(function(i,n){t.buildCVQueryFromFilterSpec(e.filterUIComponents).then(function(n){var s=n;s.appId=t._appId,s.widget=t._widgetId,s.filterRootIds=[e.rootPhysicalId||e.rootID],t._removeUselessQueries(s);var o={rootId:e.rootPhysicalId||e.rootID,rootAlias:e.rootAlias,filterId:e.filterId,filterName:e.filterName,filterTitle:e.filterTitle,filterMdl:e.filterMdl,filter:s,fromDropOnFilter:"dropOnFilter"===t.options.dropOption};o.fromDropOnFilter=!1===o.fromDropOnFilter||o.fromDropOnFilter,c.displayNotification({level:"info",message:r.get("filterWithNonAppliedTag")}),i(o)})})},a=0;a<e.success.length;a++){var l=e.success[a];s.push(o(l))}return n.all(s).then(function(e){return e.forEach(function(e){i.success.push(e)}),i})}},updateView:function(e){this._appQueryParam=e.appQueryParam||{};var t=i.clone(v._getFilterSpecification(e)),n=e.dropOption||(t?t.data.dropOption:void 0),s=e.filterId||(t?t.data.filterId:void 0),o=e.filterTitle||(t?t.data.filterTitle:void 0);if("drop"!==n&&"dropOnFilter"!==n)this._onRedraw({filterId:e.UXId}),t&&t.type&&t.data&&(this._feedViewWithFilter(t),e.filterToApply=void 0);else{var r={success:[{rootId:e.rootID,filter:"tbd",filterId:Array.isArray(s)?s:[s],filterTitle:o||void 0,fromDropOnFilter:"dropOnFilter"===n}],failure:[]};y.publish("NGFilter.ApplyDroppedFilters/"+e.UXId,r)}},_computeSynthesisFromModel:function(e){for(var t={"ds6w:type":[],"ds6w:kind":[]},i=v.getFilterUIComponents(e),s=i.length,o=function(e){void 0!==e&&e.forEach(e=>{e.criteriaType&&e.type&&-1===t["ds6w:type"].indexOf(e.type)&&t["ds6w:type"].push(e.type);var i=e.allAttributes;if(void 0===i){var n=e.uri;t[n]||(t[n]=[]),e.attrValue&&(t[n]=t[n].concat(e.attrValue))}else o(i)})},a=1;a<s;a++){i[a].toFeedUI.forEach(e=>{if(null!==e){var i=e.criteriaType;if("attribute"===i){var n=e.type;n&&(-1===t["ds6w:type"].indexOf(n)&&t["ds6w:type"].push(n),e.extension&&e.extension.length&&-1===t["ds6w:kind"].indexOf(e.extension)&&t["ds6w:kind"].push(e.extension)),o(e.allAttributes)}else"Sequence"===i&&"attribute"===e.sequenceType&&o(e.allAttributes)}})}return new n((e,i)=>{b.getNlsOfPropertiesValues(t).then(function(i){var n=[],s=c.FILTER_ANY_OBJECT;for(var o in t)if(t.hasOwnProperty(o)){var a=[];t[o].forEach(e=>{a.push({nlsvalue:i[o]&&i[o][e]?s===e?r.get(s):i[o][e]:e,value:e,isAggregate:0})}),n.push({property:o,values:a})}e(n)})})},getFilterSpecification:function(e,t,i,n){var s=e||this._rootID,o=t||this._keepAttributeChildren;return this.collection.keepComponentsToFeedUI(s,o,i,n)},updateOnLinkUnlinkWith:function(e){this._queryFormat=this._getQueryFormat(e.NGFUXId),this._listGroupView.forEach(t=>{t.updateCriteriaAvailibility(e)})},_getLinkedRoots:function(){var e=this;return new n(function(t,i){-1===decodeURIComponent(window.location.href).indexOf("NGFDebugMultiRoot=1")?t():e.in_apps_search({refine:{"ds6w:what/ds6w:contentStructure":[{type:"string",object:"Root",disptext:"Root",field:["implicit"]}]},multiSel:!0,precond:'flattenedtaxonomies:"types/VPMReference"',title:"Select Root(s) to link to "+e._rootAlias,callback:function(i){var n=[e._rootID,i];c.executeFetch([n,i],[],["ds6w:label","ds6wg:revision"]).then(function(e){var i=c.getAliasesFromFetched(n,e),s=[];n.forEach((e,t)=>{s.push({id:e,alias:i[t]})}),t(s)},function(n){var s=[{id:e._rootID,alias:e._rootAlias},{id:i,alias:"Root #2"}];t(s)})},cancel:function(){t()}})})},_getLinkedRootsFromModel:function(e){return new n(t=>{var i=e[0].filterMdl[0].toFeedUI.rootIds||[];1<i.length?c.executeFetch(i,[],["ds6w:label","ds6wg:revision"]).then(function(e){var n=c.getAliasesFromFetched(i,e),s=[];i.forEach((e,t)=>{s.push({id:e,alias:n[t]})}),t(s)},function(e){console.log(" ==> _getLinkedRootsFromModel / Retrieve root from model failed, err = "+e);var n=[];i.forEach((e,t)=>{n.push({id:e.id,alias:"Root #"+t})}),t(n)}):t()})},_onSaveFilterSync:function(e){var t=e;if(!(t.groupView&&"edit"===t.groupView.model.get("state")?1:0)||t.validateEditedCriterion())if(0===b.getCVQueryBuildMode()){var i=t.collection.buildCVQuery(t._rootID,t._keepAttributeChildren),n=t.getFilterSpecification(t._rootID,t._keepAttributeChildren);"ValidOK"===t._filterState?t._displayRenameDialogAndCreateFilter("SaveTitle",i,n):t._checkFilterNameAndUpdateFilter(t._defaultFilterName,i,n),t.groupView.switchToEdit()}else{n=t.getFilterSpecification(t._rootID,t._keepAttributeChildren);"ValidOK"===t._filterState?t._displayRenameDialogAndCreateFilter("SaveTitle","{}",n):t._checkFilterNameAndUpdateFilter(t._defaultFilterName,"{}",n),t.groupView.switchToEdit()}else t.groupView.switchToEdit()},_onSaveAsFilterSync:function(e){var t=e;if(!(t.groupView&&"edit"===t.groupView.model.get("state")?1:0)||t.validateEditedCriterion())if(0===b.getCVQueryBuildMode()){var i=t.collection.buildCVQuery(t._rootID,t._keepAttributeChildren),n=t.getFilterSpecification(t._rootID,t._keepAttributeChildren);t._displayRenameDialogAndCreateFilter("SaveAsTitle",i,n),t.groupView.switchToEdit()}else{n=t.getFilterSpecification(t._rootID,t._keepAttributeChildren);t._displayRenameDialogAndCreateFilter("SaveAsTitle","{}",n),t.groupView.switchToEdit()}},onApplyFilterSync:function(e){var t=e;if(!(t.groupView&&"edit"===t.groupView.model.get("state")?1:0)||t.validateEditedCriterion())if(1===this._synthesisState&&this._isFilteredSynthesis&&(t._refreshSynthesisInfos(!1,!1),t._isFilteredSynthesis=!1),j=t._UXId,t._hasAppliedNGF=!0,t._appliedFilterTitle=t._getFilterTitle(),0===b.getCVQueryBuildMode()){var i=t.collection.buildCVQuery(t._rootID,t._keepAttributeChildren);t._applyFilter({CVQuery:i,isEmpty:!1}),t.groupView.switchToEdit(),t._updateAddSpecificationButton()}else t.buildCVQuery().then(function(e){t._applyFilter({CVQuery:e,isEmpty:!1}),t.groupView.switchToEdit(),t._updateAddSpecificationButton()});else t.groupView.switchToEdit()},validateEditedCriterionSync:function(e,t){var i=e,n=i._listGroupView.length,s=!n;if(n){s=!0;for(var o=0;o<n&&s;o++){var a=i._listGroupView[o];if(null!==a&&a.isViewEdited())if("function"==typeof a.areCriteriaValidate){var l=a.areCriteriaValidate(t);l?a.model.set("state","read"):s=l}else s=!1,c.displayNotification({level:"error",message:r.get("NeedToValidateCrirerion")})}s&&t&&"function"==typeof t.callback&&t.callback(t)}return s},_onAddNewFilterSpecificationSync:function(e){var t=e;if(t.validateEditedCriterion()&&(t._addGroupView(),t._buildCombinationComboWithMinusAndSpec(),t._updateCombinationCombo(),c.MAX_FILTER_SPECIFICATION===t._listGroupView.length)){t._updateAddSpecificationButton();var i=UWA.String.format(r.get("maxFilterSpecDefined"),c.MAX_FILTER_SPECIFICATION);c.displayNotification({level:"info",message:i})}},_onAddExistingFilterSpecificationSync:function(e){for(var t=e,i=void 0,n=0;n<t._listGroupView.length;n++)if("edit"===t._listGroupView[n].model.get("state")){i=t._listGroupView[n].model;break}if(t.validateEditedCriterion()){var s={resetFilter:!1,editedModel:i};t._retrieveFilters(t._rootID,s)}},_retrieveFilters:function(e,t){this.retrieveFilter=!0,this.droppedFilter=!1,this.retrieveFiltersRelatedTo({type:c.FILTER_RELATED_TO_ROOT,rootIDs:e},t)}})}),define("DS/ENONextGenFilterUX/views/ContainerFilterView",["UWA/Class","UWA/Class/View","UWA/Core","UWA/Utils","UWA/Promise","DS/WAFData/WAFData","DS/ENONextGenFilterUX/views/GlobalFilterView","DS/ENONextGenFilterUX/models/GlobalFilterModel","DS/ENONextGenFilterUX/utils/FilterPersistencyServices","DS/Handlebars/Handlebars4","text!DS/ENONextGenFilterUX/templates/containerViewTemplate.html","css!DS/ENONextGenFilterUX/ENONextGenFilterUX.css","DS/PlatformAPI/PlatformAPI","DS/WebappsUtils/WebappsUtils","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENOFilterBIUX/NGFServices","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/ENOFilterBIUX/FBIServices","DS/ENONextGenFilterUX/views/WelcomePageFilterView","DS/Menu/Menu"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,f,m,g,v,b,C){"use strict";var y=1;return t.extend({domEvents:{"click #filter-cmd-close":"_onCloseFilterPanel","click #filter-extra-commands":"_onDisplayExtraCommands"},setup:function(){_.displayInternalTimeTrace(0,"ContainerView"),this._isWebInWin=this.options.isWebInWin,this.appId=this.options.appId,this._widgetId=this.options.widgetId||this.options.widget,this._UXId=this.options.UXId,this.rootID=this.options.rootID,this.rootAlias=this.options.rootAlias||"?",this._NGFUXId=this.options.NGFUXId,this._appQueryParam=this.options.appQueryParam||{},this._template=d.compile(c),this._filterToApply=this.options.filterToApply,this._dropedFilterNames=[],this.options.filterNames&&(this._dropedFilterNames=Array.isArray(this.options.filterNames)?this.options.filterNames:[this.options.filterNames]),this._dropedFilterIds=[];var e,t,i,n=f._getFilterSpecification(this.options)?f._getFilterSpecification(this.options).data.filterId:void 0;n&&(this._dropedFilterIds=Array.isArray(n)?n:[n]),this.options.tagData&&(this._tagData=this.options.tagData),void 0===this.options.configUsed&&(this.options.configUsed="1"===this._isWebInWin?1:0);for(var s=sessionStorage.length,o=0;o<s;o++){var r=sessionStorage.key(o),a=sessionStorage.getItem(r);-1!==r.indexOf("NGFilter_Volume_"+this._NGFUXId)?e="true"===a||(e||!1):-1!==r.indexOf("NGFilter_Context_"+this._NGFUXId)?t="false"!==a||(t||!1):-1!==r.indexOf("NGFilter_Attribute_"+this._NGFUXId)&&(i="false"!==a||(i||!1))}this.options.volumeUsed=void 0!==e&&e,this.options.contextUsed=void 0===t||t,this.options.attributeUsed=void 0===i||i,void 0===this.options.configUsed&&(this.options.configUsed="1"===this._isWebInWin?1:0),this.render()},render:function(){var e=this;this.container.setContent(this._template({filterId:this._UXId,closeFilterPanel:m.get("CloseFilterPanel"),containerHeightClass:"f-globalFilter-container-height"+("safari"===n.Client.Engine.name?"-Safari":""),otherCmds:_.isFilterCmdHeaderActivated()})),this._globalMdl=new a({state:"init"});var t=f.getTenant();return _.getPlatformServices(t).then(function(){var t=f._getFilterSpecification(e.options)?f._getFilterSpecification(e.options).data:void 0;if(t&&t.filterMdl&&t.filterMdl.length)e._dropedFilterIds=[],e._dropedFilterIds=t?Array.isArray(t.filterId)?t.filterId:[t.filterId]:void 0,e._fromFilterDataToAppAndUXView({success:[e.options]});else{var i={model:e._globalMdl,appId:e.appId,widget:e._widgetId,UXId:e._UXId,rootID:e.rootID,rootAlias:e.rootAlias,rootRevision:e.options.rootRevision,configUsed:e.options.configUsed,volumeUsed:e.options.volumeUsed,contextUsed:e.options.contextUsed,attributeUsed:e.options.attributeUsed,filterToApply:e._filterToApply,idxGFV:y++,fromDropOnFilter:t?t.fromDropOnFilter:void 0,dropOption:t?t.dropOption:void 0,filterMdl:t?t.filterMdl:void 0,NGFUXId:e._NGFUXId,appQueryParam:e._appQueryParam,securityContext:e.options.securityContext,queryFormat:e.options.queryFormat,pfServiceId:e.options.pfServiceId,buildFilterContainer:e.options.buildFilterContainer};i.tagData=e._tagData,e._createViews(i),e._filterToApply=void 0}}),this},updateView:function(e){this._appQueryParam=e.appQueryParam||{},this.globalViewFilter&&this.globalViewFilter.updateView(e)},getFilteringContext:function(){return{NGFUXId:this._NGFUXId,widgetId:this._widgetId}},_fromFilterDataToAppAndUXView:function(e){if(e.success){var t=e.success[0],n={model:this._globalMdl,idxGFV:y++,widget:this._widgetId,filterUIComponents:t.filterMdl,droppedInfos:{retrieveFilters:e,filterId:this._dropedFilterIds[0]}},s=i.merge(t,n);this._createViews(s),this._welcomeView.hide()}},_onCloseFilterPanel:function(){"1"===this._isWebInWin&&sendNotificationToWin("NGFClose","Close"),""!==this._widgetId&&h.publish("Frame3DXInfra.Close",{appId:this.appId,widgetId:this._widgetId,rootID:this.rootID,NGFUXId:this._NGFUXId}),sessionStorage.setItem("NGF_tagMgtRunning_"+this._UXId,!1)},setTagsDataOnNGF:function(e){this.globalViewFilter.setTagsDataOnNGF(e)},updateDataOnNGF:function(e){this.globalViewFilter.updateDataOnNGF(e)},_createViews:function(e){var t=this;e.container=t.getElement(".welcomepage-container"),t._welcomeView=new b(e),e.container=t.getElement(".globalFilterView-container"),t.globalViewFilter=new r(e),t.listenTo(t._welcomeView,"NGF_WLC_AddCriterion",function(e){t._welcomeView.hide(),t.globalViewFilter.show(),t.globalViewFilter.addNewCriterion(e)}),t.listenTo(t._welcomeView,"NGF_WLC_RetrieveFilter",function(e){var i=e.type,n=-1;_.FILTER_RELATED_TO_ROOT===i?n=1:_.FILTER_RELATED_TO_ALL_REVISIONS===i?n=2:_.FILTER_RELATED_TO_ANY_ROOT===i&&(n=3),f.setUsageTracker(this._widgetId,"NGF-Retrieve_Filters_Related_To",{label:i,value:n}),t.globalViewFilter.retrieveFiltersRelatedTo(e)}),t.listenTo(t.globalViewFilter,"NGF_GoToWelcomePage",function(e){t.globalViewFilter.hide(),t._welcomeView.show()}),t.listenTo(t.globalViewFilter,"NGF_DisplayGlobalFilterView",function(e){t._welcomeView.hide(),t.globalViewFilter.show()})},getFilterSpecification:function(){return{filterUIComponents:this.globalViewFilter.getFilterSpecification()}},updateOnLinkUnlinkWith:function(e){this.options.queryFormat=e.queryFormat,this.options.volumeUsed=e.volumeUsed,this.options.contextUsed=e.contextUsed,this.options.attributeUsed=e.attributeUsed,this.globalViewFilter.updateOnLinkUnlinkWith(e)},_onDisplayExtraCommands:function(){if(!this._debugContextualMenu){this._debugContextualMenu=[{type:"PushItem",recId:"ExtraCommands-ExpandFilterPanel-item",title:"Expand filter panel",icon:_.getIconByName("width-full"),action:{this:this,callback:this._onDebugExpandFilterPanel}},{type:"SeparatorItem"},{type:"PushItem",title:"NGF Debug",icon:_.getIconByName("menu"),submenu:[{type:"PushItem",recId:"ExtraCommands-CopyFromAnyFilterOnRoots-item",title:"Copy from Any Filter on several Roots",icon:_.getIconByName("list-filter"),action:{this:this,callback:this._onDebugCopyFromAnyFilterOnRoots}},{type:"PushItem",recId:"ExtraCommands-SetConfigFilter-item",title:"Set Config Filter",icon:_.getIconByName("configuration"),action:{this:this,callback:this._onDebugSetConfigFilter}},{type:"PushItem",recId:"ExtraCommands-UpdateTenant-item",title:"Simulate Update Tenant",icon:_.getIconByName("update"),action:{this:this,callback:this._onDebugUpdateTenant}},{type:"PushItem",recId:"ExtraCommands-SetDefaultSecurityContext-item",title:"Simulate Set Default Security-Context",icon:_.getIconByName("lock-open"),action:{this:this,callback:this._onDebugSetDefaultSecurityContext}},{type:"PushItem",recId:"ExtraCommands-ExecuteFilter-item",title:"Simulate an Execute Filter",icon:_.getIconByName("run"),action:{this:this,callback:this._onDebugExecuteFilter}},{type:"PushItem",title:"Link / Unlink",icon:_.getIconByName("link"),submenu:[{type:"PushItem",recId:"ExtraCommands-Link-item",title:"Link",icon:_.getIconByName("link-add"),action:{this:this,callback:this._onDebugLinkUnlink,context:{type:"Link"}}},{type:"PushItem",recId:"ExtraCommands-Unlink-item",title:"Unlink",icon:_.getIconByName("link-delete"),action:{this:this,callback:this._onDebugLinkUnlink,context:{type:"Unlink"}}}]}]}];var e=this.getElement("#filter-extra-commands"),t=this;e.addEventListener("click",function(e){e.stopPropagation();var i=e.target.getBoundingClientRect();C.show(t._debugContextualMenu,{position:{x:i.left,y:i.bottom}})}),e.click()}},_onDebugExpandFilterPanel:function(){function e(e){var t=document.querySelector(".column.left"),i=t.firstChild,n=-parseInt(t.style.transform.replace("translateX(",""));0!==e?(t.style.width=e+n+"px",i.style.width=e+"px"):(t.style.width="",i.style.width="")}var t=this._debugContextualMenu[0].icon;"width-full"===t.iconName?(t.iconName="width-small",e(950)):(t.iconName="width-full",e(0))},_onDebugSetConfigFilter:function(){var e={specification:{type:"NGFilter_ConfigDefined",data:{prodConf:this.rootID}},rootID:this.rootID,rootAlias:this.rootAlias,displayFilter:1,forceUpdate:1,NGFUXId:this._NGFUXId,widgetId:this._widgetId};h.publish("NGFilter_Dbg_SetConfigFilter",e)},_onDebugCopyFromAnyFilterOnRoots:function(){var e=this,t='flattenedtaxonomies:"types/ENOStrRefinementSpecification"';this.globalViewFilter.in_apps_search({precond:t,title:m.get("SearchFilters"),callback:function(i){var n=i;t='flattenedtaxonomies:"types/VPMReference"',setTimeout(function(){e.globalViewFilter.in_apps_search({multiSel:!0,precond:t,title:m.get("SearchFilters"),callback:function(t){var i={};i.eventName="NGFilter_CopyFromAnyFilterOnRoots_"+e._UXId,t=Array.isArray(t)?t:[t],h.publish("NGFilter_Dbg_SetCopyFromAnyFilterOnRoots",{appId:e._NGFUXId,widgetId:e._widgetId,filterID:n,rootIDs:t,options:i,NGFUXId:e._NGFUXId})},cancel:function(){}})},1500)},cancel:function(){}})},_onDebugUpdateTenant:function(){h.publish("NGFilter_Dbg_UpdateTenant",{NGFUXId:this._NGFUXId,widgetId:this._widgetId,tenant:"xxx"})},_onDebugSetDefaultSecurityContext:function(){h.publish("NGFilter_Dbg_SetDefaultSecurityContext",{NGFUXId:this._NGFUXId,widgetId:this._widgetId,sc:"VPLMProjectLeader.MyCompany.3DS Private Collab Space"})},_onDebugExecuteFilter:function(){var e=this;this.globalViewFilter.in_apps_search({precond:'flattenedtaxonomies:"types/ENOStrRefinementSpecification"',title:m.get("SearchFilters"),callback:function(t){var i=v.getRESTHeaders();i.SecurityContext=e.options.securityContext;var n=_.getPlatformServiceUrl()+"/resources/FilterBIAPI/Filter/executeFilter";o.authenticatedRequest(n,{headers:i,method:"POST",type:"json",proxy:"passport",data:JSON.stringify({filterId:t,appQueryParam:{select_bo:["ds6w:label"],select_rel:["ds6w:label"],no_type_filter_bo:["PLMPort"],expand_iter:"2"}}),onComplete:function(e){e.filterRoot;var t=e.filtered.results,i=[];t.forEach(e=>{e.path&&i.push(e.path)}),i.forEach((e,i)=>{console.log("---------------------------------  Path("+i+")  ---------------------------------");var n="";e.forEach(e=>{for(var i=0;i<t.length;i++){var s=t[i].attributes,o=void 0;if(s)if(s.find(t=>"did"===t.name&&e===Number(t.value))&&(o=s.find(e=>"ds6w:label"===e.name)),o){console.log(n+o.value),n+="  ";break}}})})},onFailure:function(e){console.log("--------------------------  Execute Filter failed  ---------------------------------"),console.log("error = "+e)}})},cancel:function(){}})},_onDebugLinkUnlink:function(e){var t="Link"===e.context.type?"NGFilter_Link":"NGFilter_Unlink";"NGFilter_Link"===t?(this._savedVolumeUsed=this.options.volumeUsed,this._savedContextUsed=this.options.contextUsed,this._savedAttributeUsed=this.options.attributeUsed,this._savedQueryFormat=this.options.queryFormat):(this.options.volumeUsed=this._savedVolumeUsed,this.options.contextUsed=this._savedContextUsed,this.options.attributeUsed=this._savedAttributeUsed,this.options.queryFormat=this._savedQueryFormat,delete this._savedVolumeUsed,delete this._savedContextUsed,delete this._savedAttributeUsed,delete this._savedQueryFormat);var i={rootID:this.rootID,rootAlias:this.rootAlias,specification:{type:t,data:{NGFUXId:this._NGFUXId,widgetId:this._widgetId,rootID:this.options.rootID,rootAlias:this.options.rootAlias,volumeUsed:this.options.volumeUsed,contextUsed:this.options.contextUsed,attributeUsed:this.options.attributeUsed,queryFormat:this.options.queryFormat}},applyFilter:1,displayFilter:1};h.publish("NGFilter_Dbg_LinkUnlink",i)}})}),define("DS/ENONextGenFilterUX/views/FilterViewManager",["UWA/Class","UWA/Core","UWA/Promise","DS/PlatformAPI/PlatformAPI","DS/Logger/Logger","DS/ENONextGenFilterUX/views/ContainerFilterView","DS/ENOFilterBIUX/NGFServices","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENOFilterBIUX/FBIServices"],function(e,t,i,n,s,o,r,a,l){"use strict";var d=null;return e.extend({init:function(e){var t=Date.now();a.setReferenceTime(e.referenceTime||t);var i=t-a.getReferenceTime();a.displayInternalTimeTrace(1,"FilterViewManager Loading"),r.setFilteringContext({tenant:e.widgetTenant||"OnPremise"});var s=e.widgetId||e.widget;r.setPerformanceTracker(s,"NGF-Loading","NGFilter_UX",{Loading_duration:i},1),null===d&&(d=this._initManager()),this._initDisplay=e.display,this._viewChangeData=void 0,n.subscribe("NGFilter.RemoveFilter",this._onRemoveFilter.bind(this)),n.subscribe("NGFilter_ViewChange",this._onViewChange.bind(this)),n.subscribe("Frame3DXInfra.ViewChange",this._onViewChange.bind(this))},get3DXViewAsync:function(e){var t=this;return new i(function(i){if(e&&e.filterToApply){var n=e.filterToApply,s=n&&n.specification?n.specification.type:"";i("NGFilter_CopyFromAnyFilterToRoots"===s?t._onCopyFromAnyFilterToRoots(e):"NGFilter_Link"===s||"NGFilter_Unlink"===s?t._onLinkOrUnlinkWith(e):t._get3DXView(e))}else i(t._get3DXView(e))})},_get3DXViewAsync:function(e){var t=this;return new i(function(i,n){i(t._get3DXView(e))})},_get3DXView:function(e){var t;if(void 0===e.createFilterView||e.createFilterView){a.setReferenceTime(Date.now()),a.displayInternalTimeTrace(1,"FilterViewManager 3DXView"),r.updateFilteringContext({tenant:e.widgetTenant||"OnPremise"}),e.NGFUXId=e.NGFUXId||e.appId;var i=e.widgetId||e.widget;e.UXId=e.NGFUXId&&e.rootID?r.computeUXId(e.NGFUXId,e.rootID):e.UXId||i;var n=e.UXId,s="NGF_isUXBuilt_"+n,l="NGF_tagMgtRunning_"+n;if(null===(t=d.get(n))){e.pfServiceId=e.rootServiceId||e.serviceId||"3DSpace",delete e.rootServiceId,sessionStorage.setItem(s,!1),e.tagData&&sessionStorage.setItem(l,!0);var c=new o(e);e.buildFilterContainer?(c.inject(e.buildFilterContainer),d.add(n,c)):(d.add(n,c),d.display(n)),t=d.get(n)}else{if("false"===sessionStorage.getItem(s))return;if("true"===sessionStorage.getItem(l))return;t.updateView(e),(void 0===e.display||e.display)&&d.display(n)}}return t},_onViewChange:function(e){if("maximized"===e.type){this._viewChangeData?this._viewChangeData=this._viewChangeData.NGFUXId?this._viewChangeData:e:this._viewChangeData=e;var t=this;setTimeout(function(){t._viewChangeData&&!1===d.isThereViewWithId(t._viewChangeData.NGFUXId,t._viewChangeData.widgetId||t._viewChangeData.id)&&n.publish("Frame3DXInfra.Close",{}),t._viewChangeData=void 0},1e3)}},_onRemoveFilter:function(e){d.remove(e.NGFUXId,e.rootIds),n.publish("Frame3DXInfra.Close",{})},_onCopyFromAnyFilterToRoots:function(e){var s,o=this,l=e.NGFUXId,c=e.widgetTenant||"OnPremise",u=e.securityContext||"OnPremise",h=e.filterToApply.specification.data;r.getAllDataFromFilterIds(h.filterId,c).then(function(c){var p=c.success[0];a.checkAndGetListOfAttributesFromSelectedFilter(p).then(function(c){var _=h.options?h.options.displayNotif:1,f=[],m=e;return h.rootInfos.forEach(function(e){m.rootID=e.id,m.rootAlias=e.alias,m.rootRevision=e.revisions,f.push(function(e,i){var n=e.rootID,s=e.rootAlias;return new Promise(function(e){var o={rootID:n};r.isDebugActive("ngf")&&(o.rootAlias=s);var c=r.computeUXId(l,n);d.get(c)&&!h.options.resetFilter?(o.error=-1,e(o)):a.checkCompatibiltyFilterRules(u,n,p,_,i).then(function(i){o=t.merge(o,i.result),e(o)})})}(m,e.service))}),i.all(f).then(function(e){var a=t.clone(h.options);a.resetFilter=1;var u=[];return h.rootInfos.forEach(function(e){var i=r.computeUXId(l,e.id),n=t.createElement("div",{id:"NGF-CopyFromAnyFilterToRoots_"+i});n.inject(document.body),n.hide();var s=d.get(i);(!s||s&&h.options.resetFilter)&&(m.rootID=e.id,m.rootAlias=e.alias,m.rootRevision=e.revision,m.rootServiceId=e.service,m.display=!1,m.buildFilterContainer=n,m.filterToApply={specification:{type:"NGFilter_CopyFromAnyFilterToRoots",data:{filterData:p,listAttr:c,rootId:e.id,options:a}}},u.push(o._get3DXViewAsync(m)))}),i.all(u).then(t=>{s=t&&t.length?t[t.length-1]:void 0;var i=h.options&&h.options.eventName?h.options.eventName:"";if(i){var o={};o.results=e,n.publish(i,o)}}),s})},function(e){return console.log(" ==> onCopyFromAnyFilterToRoots / Retrieve List Of Attribute,  err = "+e),s})},function(e){return console.log(" ==> onCopyFromAnyFilterToRoots / Retrieve Data Filter,  err = "+e),s})},_onLinkOrUnlinkWith:function(e){var s;if(!(e&&e.filterToApply&&e.filterToApply.specification))return console.log(" => Link / Unlink : No specification defined"),s;var o=e.filterToApply,a=o.specification.type,l=o.specification.data||{},c=[];if(l&&(c=Array.isArray(l.rootID)?l.rootID:[l.rootID]),c.length&&("NGFilter_Link"===a||"NGFilter_Unlink"===a)){var u=Array.isArray(e.rootID)?e.rootID:[e.rootID];if(u.forEach(t=>{d.get(r.computeUXId(e.NGFUXId,t))&&d.remove(e.NGFUXId,t)}),"NGFilter_Link"===a){var h={};h.attributeUsed=e.attributeUsed||l.attributeUsed,h.contextUsed=e.contextUsed||l.contextUsed,h.volumeUsed=e.volumeUsed||l.volumeUsed,h.queryFormat=e.queryFormat|Number.parseInt(l.queryFormat),c.forEach(e=>{var t=d.get(r.computeUXId(l.NGFUXId,e));t&&(t.updateOnLinkUnlinkWith(h),s=t)});var p=l&&l.eventName?l.eventName:"";if(p){var _={results:"OK"};n.publish(p+"/"+l.widgetId,_)}return s}if("NGFilter_Unlink"===a){var f=Array.isArray(e.rootAlias)?e.rootAlias:[e.rootAlias],m=o,g=[];delete e.filterToApply,u.forEach((i,n)=>{e.rootID=i,e.rootAlias=f[n],e.UXId=r.computeUXId(e.NGFUXId,i);var s=t.createElement("div",{id:"NGF-BuildFilter_"+e.UXId});s.inject(document.body),s.hide(),e.buildFilterContainer=s,g.push(this._get3DXViewAsync(e))}),i.all(g).then(function(t){var i={};c.forEach(e=>{var t=d.get(r.computeUXId(l.NGFUXId,e));t&&(i[e]=t.getFilterSpecification(),t.updateOnLinkUnlinkWith(l)),s=t}),u.forEach((t,n)=>{var s=i[t]||i[c[0]];s&&(e.rootID=t,e.rootAlias=f[n],e.UXId=r.computeUXId(e.NGFUXId,t),m.specification.data=s,e.filterToApply=m,d.get(e.UXId).updateView(e))});var o=l&&l.eventName?l.eventName:"";if(o){var a={results:"OK"};n.publish(o+"/"+l.widgetId,a)}return s})}}},_initManager:function(){return{_listView:{},_currentUXId:"",get:function(e){return e&&this._listView[e]?this._listView[e]:null},getCurrentUXId:function(){return this._currentUXId||""},isThereViewWithId:function(e,t){var i=this,n=Object.keys(this._listView);return!!(e?n.find(function(t){var n=i._listView[t].getFilteringContext();return-1!==e.indexOf(n.NGFUXId)}):n.find(function(e){var n=i._listView[e].getFilteringContext();return-1!==t.indexOf(n.widgetId)}))},add:function(e,t){e&&t&&(this._listView[e]||(this._listView[e]=t))},display:function(e){if(e){var t=this._currentUXId;t!==e&&(""!==t&&this._listView[t]&&this._listView[t].hide(),this._listView[e]&&(this._currentUXId=e,this._listView[e].show()))}},remove:function(e,t){if(e){if(t)for(var i=Array.isArray(t)?t:[t],n=i.length-1;n>=0;n--){var s=r.computeUXId(e,i[n]);this._remove(s)}else{var o=Object.keys(this._listView);for(n=o.length-1;n>=0;n--)-1!==o[n].indexOf(e)&&this._remove(o[n])}0!==Object.keys(this._listView).length&&this._listView[this._currentUXId]||(this._currentUXId="")}},_remove:function(e){var t=d.get(e);t&&(t.remove(),delete this._listView[e])}}}})}),define("DS/ENONextGenFilterUX/utils/FilterAdvServicesWebInWin",["UWA/Core","UWA/Class","UWA/Widget","UWA/Class/Options","DS/ENOFilterBIUX/NGFServices","DS/ENOFilterBIUX/FBISettings","DS/ENONextGenFilterUX/views/FilterViewManager","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENOFilterBIUX/FBIServices","DS/PlatformAPI/PlatformAPI"],function(e,t,i,n,s,o,r,a,l,d){"use strict";return t.singleton(n,{initServices:function(e){var t=e.filterSettings.platform_services;l.setOption("fromWebInWin",1),l.setOption("str_platformServices",t),a.setOption("str_platformServices",t)},renderFilterViewInWin:function(){var e=new i,t=e.getValue("X3DContentId")?JSON.parse(e.getValue("X3DContentId")):null,n=(e.getView&&e.getView().type,"[");if(null===t||void 0!==e.getValue("lastRootNodeID")||e.getValue("clearInPreview"))n=null;else{var s=t.data;if(null!==s&&s.items.length>0){for(var o=s.items,a=0;a<o.length;a++)n+='"'+o[a].objectId+'"',n+=o.length-1===a?"]":",";e.setValue("lastRootNodeID",n)}}var l=null;"function"==typeof(l=new r(options)).get3DXViewAsync&&l.get3DXViewAsync(options).then(function(e){e.inject(document.body)})},addRemovePaths:function(e){console.log("In addOrRemovePaths"),d.publish("NGFilter.OccPath",{selectedPath:e.selectedPaths,pathAlias:e.pathAlias})}})}),define("DS/ENONextGenFilterUX/ENONextGenFilterUXWIW",["DS/ENONextGenFilterUX/views/FilterViewManager","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENONextGenFilterUX/utils/FilterAdvServicesWebInWin","DS/ENOFilterBIUX/FBIServices","UWA/Class","UWA/Core","UWA/Widget","DS/PlatformAPI/PlatformAPI"],function(e,t,i,n,s,o,r,a){"use strict";return s.extend({init:function(e){this.options=e,i.initServices(e),i.renderFilterViewInWin()},addOrRemovePaths:function(e){console.log("In addOrRemovePaths"),a.publish("NGFilter.OccPath",{selectedPath:e.selectedPaths,pathAlias:e.pathAlias})}})});