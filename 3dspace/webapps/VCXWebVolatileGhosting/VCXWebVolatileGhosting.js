define("DS/VCXWebVolatileGhosting/VCXVolatileGhostingManager",["DS/CoreEvents/Events","UWA/Class","DS/VisuEvents/EventsManager","DS/VCXWebExperienceBase/VCXOverridesChangeServices","DS/Visualization/ThreeJS_DS","DS/VCXWebModifiablesServices/VCXModifiablesAccess","DS/VCXWebExperienceBase/VCXSceneGraphOverridesServices","DS/VCXWebVisibility/VCXIVisibility"],function(e,t,i,n,s,o,h,a){"use strict";var r=0,l=1,u=2,v=0,d=1,c=2,_=t.extend({init:function(){this._keepGhostCommand=!1,this._allowTAB=!1,this._allowMouseClick=!1},initialize:function(){this._SceneGraphOverrideSet=null,this._setGhost=[],this._mode=r,this._shooting=!1,this._timeStart=null,this._keyState=v,this._tokenCmdChange=null,this._tokenCSOChange=null,this._mouseEvent=null,this._mouseMoveWhileLeftButtonPressed=!1,this._mouseMoveWhileRightButtonPressed=!1,this._keepGhostCommand=!1,this._LMBx=-1,this._LMBy=-1,this._RMBx=-1,this._RMBy=-1,this._zoomCBToken=null,this._allowTAB=!1,this._allowMouseClick=!1},postInitialize:function(){var e=this._experienceBase.getManager("VCXContextManager").getMainViewer();e&&e.setPrePicking({activated:!0,displayHL:!0,gpu:!0,computeNormalDepth:!1,primitive:!1}),this.addCallbacks()},addCallbacks:function(){var t=this;this._onKeydownEvent=function(e){t.onKeydownEvent(e)},this._onKeyupEvent=function(e){t.onKeyupEvent(e)},this._onMousedownEvent=function(e){t.onMousedownEvent(e)},this._onMouseupEvent=function(e){t.onMouseupEvent(e)},this._onMousemoveEvent=function(e){t.onMousemoveEvent(e)},this._onMousewheelEvent=function(e){t.onMousewheelEvent(e)};var i=this._experienceBase.getManager("VCXContextManager").getMainViewer();if(i){this._tokenCmdChange=e.subscribe({event:"GHOSTABLE_CHANGE"},function(e){t.onGhostableChange(e)}),addEventListener("keydown",this._onKeydownEvent),addEventListener("mousemove",this._onMousemoveEvent);var n="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";"mousewheel"==n?window.addEventListener(n,this._onMousewheelEvent,!0):addEventListener(n,this._onMousewheelEvent,!0);var s=i.currentViewpoint;if(s&&s.control){this._zoomCBToken=s.control._modelEvent.subscribe({event:"Zoom"},function(e){e&&e.factor&&e.evt&&e.evt.event&&e.evt.event.altKey&&(e.defaultBehavior=!1)})}}},unInitialize:function(){this.removeCallbacks();var e=this._experienceBase.getManager("VCXContextManager").getMainViewer();e&&e.setPrePicking({activated:!1,displayHL:!0,gpu:!0,computeNormalDepth:!1,primitive:!1})},removeCallbacks:function(){if(this._zoomCBToken){var t=this._experienceBase.getManager("VCXContextManager").getMainViewer();if(t){var i=t.currentViewpoint;i&&i.control&&i.control._modelEvent.unsubscribe(this._zoomCBToken)}}e.unsubscribe(this._tokenCmdChange),this._tokenCmdChange=null,removeEventListener("keydown",this._onKeydownEvent),removeEventListener("keyup",this._onKeyupEvent),removeEventListener("mousedown",this._onMousedownEvent),removeEventListener("mouseup",this._onMouseupEvent),removeEventListener("mousemove",this._onMousemoveEvent);var n="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";"mousewheel"==n?window.removeEventListener(n,this._onMousewheelEvent,!0):removeEventListener(n,this._onMousewheelEvent,!0)},setKeepGhostCommand:function(e){this._keepGhostCommand=e},setAllowTAB:function(e){this._allowTAB=e},setAllowMouseClick:function(e){this._allowMouseClick=e},hasVolatileGhostingToRestore:function(){return void 0===this._setGhost?(console.error("Volatile Ghosting: Initialize() was not called before use"),!1):0!==this._setGhost.length},resetVolatileGhosting:function(e){if(void 0===e&&(e=!1),this.hasVolatileGhostingToRestore())if(h.removeSceneGraphOverrideSet(this._experienceBase,this._SceneGraphOverrideSet),this._SceneGraphOverrideSet=null,e)for(var t=this._setGhost.length;t>0;){var i=this._setGhost[this._setGhost.length-1],n=o.GetModifiableFromPathElement(i,this._experienceBase);if(n){var s=n.GetObject();if(s){var l=s.QueryInterface("VCXIVisibility");l&&l.SetVisibility(a.EVisState.Hidden)}this._setGhost.pop(),t--}}else this._setGhost=[];this._allowMouseClick&&(removeEventListener("mousedown",this._onMousedownEvent),removeEventListener("mouseup",this._onMouseupEvent)),this._mode=r,this._experienceBase.getManager("VCXContextManager").renderAll()},pick:function(e){if(void 0===e&&(e={}),void 0===e.invalidatePickingBuffer&&(e.invalidatePickingBuffer=!1),void 0===e.x){if(!this._mouseEvent)return null;e.x=this._mouseEvent.clientX}if(void 0===e.y){if(!this._mouseEvent)return null;e.y=this._mouseEvent.clientY}var t=this._experienceBase.getManager("VCXContextManager").getMainViewer();if(!t)return null;var i=t.canvas.getBoundingClientRect(),n=new s.Vector2(e.x-i.left,e.y-i.top);e.invalidatePickingBuffer&&t.invalidatePickingBuffer();var h=t.pick(t.getMousePosition(n),"mesh",!1);e.invalidatePickingBuffer&&t.invalidatePickingBuffer();var a=null;return h&&h.path&&h.path.length>0&&h.path[0]&&(a=h.path[0],!1===t.multiViewerFix&&a.externalPath.splice(0,1),a=o.BuildCleanedPathElement(a)),a},ghostAndRefreshFromEvent:function(e){var t=this.pick({x:e.clientX,y:e.clientY});t&&this.ghostAndRefresh(t)},ghostAndRefresh:function(e){if(void 0!==e||(e=this.pick())){for(var t=0;t<this._setGhost.length;t++)if(this._setGhost[t]===e)return!1;this._SceneGraphOverrideSet||(this._SceneGraphOverrideSet=h.createAndPushSceneGraphOverrideSet(this._experienceBase));var i=n.Ghost(this._SceneGraphOverrideSet,e);return i&&(this._setGhost.push(e),this.updatePreHighlight(),this._experienceBase.getManager("VCXContextManager").renderAll()),i}},unGhostAndRefresh:function(){if(!this.hasVolatileGhostingToRestore())return!1;var e=this._setGhost.pop(),t=!1;return e&&(t=n.UnGhost(this._SceneGraphOverrideSet,e))&&(this.updatePreHighlight(),this._experienceBase.getManager("VCXContextManager").renderAll()),t},updatePreHighlight:function(){WUX.Selection.PSOManager.empty();var e=this.pick({invalidatePickingBuffer:!0});e&&WUX.Selection.PSOManager.add({pathElement:e})},onKeydownEvent:function(e){if(18===e.keyCode||(71===e.keyCode||103===e.keyCode)&&e.altKey||this._allowTAB&&9===e.keyCode){if(this._mode===u)return;if(e.preventDefault(),this._mode!==l&&(this._mode=l,this._allowMouseClick&&this._allowTAB&&9===e.keyCode&&(addEventListener("mousedown",this._onMousedownEvent),addEventListener("mouseup",this._onMouseupEvent))),18!==e.keyCode){if(!this._shooting)if(this._timeStart&&this._keyState===v)(new Date).getTime()-this._timeStart<200&&(this._shooting=!0),this._timeStart=null;this._keyState===v?this._keyState=d:this._keyState===d&&(this._keyState=c,this._experienceBase.getManager("VCXContextManager").getMainViewer().setPicking({activated:!1})),(this._keyState!==c||this._shooting)&&(e.shiftKey?this._allowTAB&&9===e.keyCode&&this.unGhostAndRefresh():this.ghostAndRefresh()),this._shooting||this._timeStart||(this._timeStart=(new Date).getTime())}addEventListener("keyup",this._onKeyupEvent)}else this._keepGhostCommand&&75===e.keyCode&&(this.resetVolatileGhosting(!0),this.updatePreHighlight(),this._experienceBase.getManager("VCXContextManager").renderAll())},onKeyupEvent:function(e){this._mode!==u&&(18===e.keyCode||71===e.keyCode||103===e.keyCode||this._allowTAB&&9===e.keyCode)&&(this._keyState===c&&(this._shooting=!1,this._timeStart=null,this._experienceBase.getManager("VCXContextManager").getMainViewer().setPicking({activated:!0})),18!==e.keyCode&&(this._keyState=v),e.altKey||this._allowTAB&&this._keyState!==v||e.buttons||this.isOnGhostableObject()||this.resetVolatileGhosting())},onMousewheelEvent:function(e){e.altKey&&(e.preventDefault(),(e.wheelDelta?e.wheelDelta/120:-(e.detail||e.deltaY||0)/3)>0?this.ghostAndRefreshFromEvent(e):this.unGhostAndRefresh())},onMousemoveEvent:function(e){this._mouseEvent=e,this._mode===l&&(this._keyState!==v&&(1&e.buttons&&(this._LMBx===e.clientX&&this._LMBy===e.clientY||(this._mouseMoveWhileLeftButtonPressed=!0)),2&e.buttons&&(this._RMBx===e.clientX&&this._RMBy===e.clientY||(this._mouseMoveWhileRightButtonPressed=!0))),e.altKey||this._allowTAB&&this._keyState!==v||e.buttons||this.isOnGhostableObject()||this.resetVolatileGhosting())},onMousedownEvent:function(e){this._mode===l&&this._keyState===v||(1===e.which?(this._mouseMoveWhileLeftButtonPressed=!1,this._LMBx=e.clientX,this._LMBy=e.clientY):3===e.which&&(this._mouseMoveWhileRightButtonPressed=!1,this._RMBx=e.clientX,this._RMBy=e.clientY))},onMouseupEvent:function(e){this._mode===l&&this._keyState===v||(1!==e.which||this._mouseMoveWhileLeftButtonPressed?3!==e.which||this._mouseMoveWhileRightButtonPressed||this.unGhostAndRefresh():this.ghostAndRefreshFromEvent(e))},isOnGhostableObject:function(){if(!this._SceneGraphOverrideSet)return!1;for(var e=this._setGhost.length,t=0;t<e;t++){var i=this._setGhost[t];n.Ghost(this._SceneGraphOverrideSet,i,!1,void 0,1)}var s=this.pick({invalidatePickingBuffer:!0});for(e=this._setGhost.length,t=0;t<e;t++){i=this._setGhost[t];n.Ghost(this._SceneGraphOverrideSet,i,!1,void 0,2)}return!!s},doubleTapCallback:function(e){this.ghostAndRefreshFromEvent(e)},pointerUpCallback:function(e){return this._functToCallpointerUp=function(t){e.ghostAndRefreshFromEvent(t)},this._functToCallpointerUp},onGhostableChange:function(e){this._mode!==l&&(e?(this._mode=u,addEventListener("mouseup",this._onMouseupEvent),removeEventListener("keydown",this._onKeydownEvent)):(this.resetVolatileGhosting(),addEventListener("keydown",this._onKeydownEvent)))},processGhostableClic:function(){}});return Object.defineProperty(_.prototype,"componentType",{enumerable:!0,get:function(){return"VCXVolatileGhostingManager"}}),_}),define("DS/VCXWebVolatileGhosting/VCXVolatileGhostingCmd",["DS/CoreEvents/Events","DS/ApplicationFrame/CommandCheckHeader"],function(e,t){"use strict";return t.extend({init:function(t){this._parent(t,{});var i=this;this.onStateChange(function(){e.publish({event:"GHOSTABLE_CHANGE",data:i.getState()})})},GetState:function(){return!0}})});