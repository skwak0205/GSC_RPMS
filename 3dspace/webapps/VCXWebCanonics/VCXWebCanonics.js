define("DS/VCXWebCanonics/VCXAMeasurableHolder",["require","exports"],function(e,t){"use strict";return class{async getMeasurables(){return null}async populateMagnets(e,t){let i=this.GetObject()._experienceBase.getManager("VCXContextManager"),n=1e5,a=1e5;if(i&&i.isSupported("VCXCanonicsV2")){let e=parseInt(localStorage.getItem("VCXCanonicsCutableMaxMeasurables"));isNaN(e)||(n=e),e=parseInt(localStorage.getItem("VCXCanonicsTotalMaxMeasurables")),isNaN(e)||(a=e)}var s=await this.getMeasurables();let r={};for(let t in s)r[s[t].ref]||(r[s[t].ref]=[]),r[s[t].ref].push({id:t,size:s[t].getSize(e),ref:s[t].ref});var o=Object.keys(r);o.sort();let l=0;for(let i=o.length-1;i>=0&&n>l;i--){let n=o[i];r[n].sort(function(e,t){return t.size-e.size});for(let i=0;i<r[n].length&&a>l;i++)l++,s[r[n][i].id].populateMagnets(e,t)}}}}),define("DS/VCXWebCanonics/VCXIMeasurableHolder",["DS/WebComponentModeler/CATWebInterface"],function(e){"use strict";return e.singleton({interfaceName:"VCXIMeasurableHolder",required:{getMeasurables:async function(){},populateMagnets:async function(e,t){}}})}),define("DS/VCXWebCanonics/VCXMagnet",["require","exports","DS/Mesh/MeshUtils"],function(e,t,i){"use strict";class n{constructor(e){this._active=!0,this._nodes={0:null,1:null,2:null};for(let t in e)this[t]=e[t];this.from=e.d,this.measurable&&this.setDefaultProperties()}insertIntoArray(e){e[this.getType()]||(e[this.getType()]=[]),e[this.getType()].push(this)}setDefaultProperties(){this.measurable&&(this.measurableID=this.measurable.getID(),this.pathElement=this.measurable.getPathElement(),this.associatedObject=this.measurable.getHolder())}createAndGetRootDecoration(e){return this.associatedObject.GetObject()._experienceBase.getManager("VCXCanonicsManager").createAndGetRootDecoration(e,this.getType())}updateFromRay(e,t){return this}getNode(e){return null}getCachedNode(e){if(e.createIfMissing&&!this._nodes[e.nodeType]){let t=this.getNode(e);t&&(this._nodes[e.nodeType]=t,t.setName("VCXCanonic"+this.getType()+"_"+this.measurableID+"_"+e.nodeType),this.update(e),e.nodeType===n.ENodeType.picking?this.createAndGetRootDecoration(e).add(this._nodes[e.nodeType]):t.setPickable(i.PICKTHROUGH))}return this._nodes&&this._nodes[e.nodeType]}_setNodeOptions(e){if(!e)return this;let t=this.associatedObject.GetObject()._experienceBase.getManager("VCXVisuManager");return e.setRenderPasses([t.getRenderList("VCXPre3DManipulators"),t.getRenderList("VCX3DManipulators")]),e.setFrustumCulled&&e.setFrustumCulled(!1),e.setShadow&&e.setShadow(!1,!1),e.setMirror&&e.setMirror(!1),e.exludeFromBounding&&e.exludeFromBounding(!0),e.handle=this.associatedObject,e.measurableID=this.measurableID,e.magnet=this,this}setVisibility(e,t){let i=this.getCachedNode(e);if(!i)return i;let a=t;return e.nodeType===n.ENodeType.feedbackLive&&(a=a&&this.isActive()),a?(i.parents[0]||this.createAndGetRootDecoration(e).add(i),i&&i.setVisibility(a)):i&&i.setVisibility(!1),i}update(e){var t=this.getCachedNode(e);if(t){let i=this.measurable&&this.measurable.isActive(),a=this.associatedObject&&this.associatedObject.GetObject()._experienceBase.getManager("VCXCanonicsManager"),s=a&&a.getDefaultMaterial(e,this.getLineType(),i?30:5,t._text&&(e.nodeType!==n.ENodeType.picking||a._debugDisplay),"D"===this.measurable.from,e.iIsUnactive);s!==t.getMaterial()&&t.setMaterial(s);let r="VCXMagnet"+this.getType()+(i?"Active":"");t.setPickingPriorityId(r)}return this}isActive(){return this._active}setActive(e){return this._active!==e&&(this._active=e),this._active}getLineType(){return"Plain"}getType(){return"Basic"}}return function(e){let t;!function(e){e[e.picking=0]="picking",e[e.feedback=1]="feedback",e[e.feedbackLive=2]="feedbackLive"}(t=e.ENodeType||(e.ENodeType={}))}(n||(n={})),n}),define("DS/VCXWebCanonics/VCXCanonicsManagerEnum",["require","exports"],function(e,t){"use strict";var i;return function(e){let t;!function(e){e[e.None=0]="None",e[e.Point=1]="Point",e[e.Center=2]="Center",e[e.Axis=4]="Axis",e[e.Line=8]="Line",e[e.Circle=16]="Circle",e[e.Plane=32]="Plane",e[e.Cylinder=64]="Cylinder",e[e.Cone=128]="Cone",e[e.Object=256]="Object"}(t=e.Canonic||(e.Canonic={}))}(i||(i={})),i}),define("DS/VCXWebCanonics/VCXMeasurable",["require","exports","DS/Visualization/Node3D","DS/VCXWebCanonics/VCXMagnet"],function(e,t,i,n){"use strict";return class{constructor(e){this._type=e.type,this.from=e.d}async populateMagnets(e,t){this._magnets&&this._magnets.forEach(e=>{e.insertIntoArray(t)})}getType(){return this._type}getPathElement(){return this._pathElement}setPathElement(e){return this._pathElement=e,this._pathElement}getID(){return this._ID}setID(e){return this._ID=e,this._ID}getHolder(){return this._holder}setHolder(e){return this._holder=e,this._holder}getHolderMatrix(e){return this._pathElement.getWorldMatrix(e,null)}isActive(){return this._active}getNode(e){return e.createIfMissing&&!this._node&&(this._node=new i,this._magnets.forEach(t=>{let i=t.getCachedNode(e);i&&this._node.add(i)})),this._node}setActive(e,t){if(this._active!==e){this._active=e,this._magnets&&this._magnets.forEach(e=>{e.update({createIfMissing:this._active,nodeType:n.ENodeType.picking})});var i=this.getHolder().GetObject()._experienceBase.getManager("VCXCanonicsManager");let a=this.getNode({createIfMissing:this._active,nodeType:n.ENodeType.feedback}),s=this.getNode({createIfMissing:this._active,nodeType:n.ENodeType.feedbackLive});s&&s.setVisibility(this._active),this._magnets&&this._magnets.forEach(e=>{let i=this._active;e.setActive(i),e.setVisibility({createIfMissing:i,nodeType:n.ENodeType.feedback},i),e.setVisibility({createIfMissing:i&&t===e,nodeType:n.ENodeType.feedbackLive},i&&t===e),i&&(e.update({createIfMissing:i,nodeType:n.ENodeType.feedback,iIsUnactive:t!==e}),t===e&&e.update({createIfMissing:i&&t===e,nodeType:n.ENodeType.feedbackLive}))}),this._active&&i.setFeedbackNode({static:a,live:s})}return this}getSize(e){return 0}}}),define("DS/VCXWebCanonics/VCXMagnetPoint",["require","exports","DS/VCXWebKernelTools/VCXMeshServices","DS/VCXWebCanonics/VCXMagnet","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/VCXWebKernelTools/VCXMathTools","DS/Visualization/Node3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D"],function(e,t,i,n,a,s,r,o,l,c){"use strict";return class extends n{updateFromRay(e,t){return this.point=this.position.clone(),this}update(e){if(e.nodeType===n.ENodeType.feedback)return null;var t=this.getCachedNode(e);if(e.nodeType===n.ENodeType.feedbackLive)if(this.position&&this.normal&&t){let e=r.getMatrixFromOVz(this.position,this.normal);t.setMatrix(e)}else console.warn(new Error("Error"));else if(e.nodeType===n.ENodeType.picking)if(this.position&&this.normal&&t){let e=r.getMatrixFromOVz(this.position,this.normal);t.setMatrix(e)}else console.warn(new Error("Error"));return super.update(e)}getNode(e){if(e.nodeType===n.ENodeType.feedback)return new o;if(e.nodeType===n.ENodeType.picking){let e=2;this.associatedObject&&this.associatedObject.GetObject()._experienceBase.getManager("VCXGUIManager").isTouchActivated()&&(e*=1.5);let t=i.buildLineStripSet([-.001,-.001,-.001,.001,.001,.001],[2],[0,1],null,e,null);return this._setNodeOptions(t),t}if(e.nodeType===n.ENodeType.feedbackLive){let e=a.createRectangleNode({width:1,height:1,cornerPoint:new s.Vector2(-.5,-.5),fill:!0,noEdge:!0,layerNb:1});this._setNodeOptions(e);let t=15;this.associatedObject&&this.associatedObject.GetObject()._experienceBase.getManager("VCXGUIManager").isTouchActivated()&&(t*=1.5);let i=new l({name:"fixedSizePoint",ratio:t});i.add(e);let n=new c({name:"billBoardPoint",type:"Spherical"});n.add(i),n.setBillboardType("Spherical");let r=new o("VCXCanonicPoint");return r.add(n),r._text=!0,r}return null}getType(){return"Point"}}}),define("DS/VCXWebCanonics/VCXMagnetCenter",["require","exports","DS/VCXWebCanonics/VCXMagnetPoint"],function(e,t,i){"use strict";return class extends i{getType(){return"Center"}}}),define("DS/VCXWebCanonics/VCXMagnetCircle",["require","exports","DS/VCXWebCanonics/VCXMagnet","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/VCXWebKernelTools/VCXMathTools","DS/VCXWebCanonics/VCXMagnetPoint"],function(e,t,i,n,a,s,r){"use strict";return class extends i{constructor(e){super(e)}updateFromRay(e,t){let i=(new a.Plane).setFromNormalAndCoplanarPoint(this.axis,this.position),n=e.intersectPlane(i);return this.xAxis=n.sub(this.position).normalize(),this.feedbackPoint=this.position.clone().add(this.xAxis.clone().multiplyScalar(this.radius)),1===t.snappingBehavior?(this.point=this.position.clone(),this.normal=this.axis.clone(),this):(this.point=this.feedbackPoint.clone(),this.normal=this.xAxis.clone(),this.xAxis=(new a.Vector3).crossVectors(this.axis,this.xAxis),this)}update(e){var t=this.getCachedNode(e);if(e.nodeType===i.ENodeType.feedbackLive)if(this.feedbackPoint&&this.normal&&t){let e=s.getMatrixFromOVz(this.feedbackPoint,this.normal);t.setMatrix(e)}else console.warn(new Error("Error"));else if(this.position&&this.axis&&this.radius&&t){let e=new a.Vector3(this.radius,0,0),i=new a.Vector3(0,this.radius,0),n=new a.Vector3(0,0,1),r=(new a.Matrix4).makeBasis(e,i,n),o=s.getMatrixFromOVz(this.position,this.axis);t.setMatrix((new a.Matrix4).multiplyMatrices(o,r))}else console.warn(new Error("Error"));return super.update(e)}getNode(e){if(e.nodeType===i.ENodeType.feedbackLive)return r.prototype.getNode.call(this,e);if(this.position&&this.axis&&this.radius){var t=n.createCircleNode({radius:1,fill:!1});return this._setNodeOptions(t),t}return console.warn(new Error("Error")),null}getType(){return"Circle"}}}),define("DS/VCXWebCanonics/VCXMeasurableSphere",["require","exports","DS/Visualization/Measurable","DS/VCXWebCanonics/VCXMeasurable","DS/VCXWebCanonics/VCXMagnetCenter","DS/VCXWebCanonics/VCXMagnetCircle","DS/VCXWebKernelTools/VCXMathTools"],function(e,t,i,n,a,s,r){"use strict";return class extends n{constructor(e){super(e),this._type=i.TYPESPHERE,this.center=e.center,this.radius=e.radius}getSize(e){return 2*this.radius}async populateMagnets(e,t){let i=this.getHolderMatrix(e),n=this.center.clone().applyMatrix4(i),o=this.radius,l=r.getVzFromMatrix(this._pathElement.getWorldMatrix(e,null)),c=0;this._magnets||(this._magnets=[],this._magnets.push(new a({measurable:this,magnetID:c++})),this._magnets.push(new s({measurable:this,magnetID:c++}))),c=0;let h=this._magnets[c];h.position=n,h.radius=o,h.normal=l,c++;let d=this._magnets[c];return d.position=n,d.radius=o,d.axis=l,super.populateMagnets(e,t)}}}),define("DS/VCXWebCanonics/VCXMagnetAxis",["require","exports","DS/VCXWebCanonics/VCXMagnet","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/VCXWebKernelTools/VCXMathTools","DS/VCXWebCanonics/VCXMagnetPoint"],function(e,t,i,n,a,s,r){"use strict";return class extends i{constructor(){super(...arguments),this.worldSizeScale=10}isABetterCandidate(e){if(this.point&&this.center&&this.normal&&e.center&&e.normal){let t=s.sideOperatorFromPointsNormal(this.center,this.normal,e.center,e.normal);if(this.point&&Math.abs(t)<1e-5&&new a.Ray(e.start,e.normal).distanceToPoint(this.point)<1e-5&&this.point.distanceToSquared(e.center)<this.point.distanceToSquared(this.center))return!0}return!1}updateFromRay(e,t){let i=this.start.clone().add(this.normal.clone().multiplyScalar(this.getWorldSize()*this.worldSizeScale));return this.point=new a.Vector3,e.distanceSqToSegment(this.start,i,void 0,this.point),this}getWorldSize(){let e=this.associatedObject.GetObject()._experienceBase.getManager("VCXContextManager"),t=(e?e.getRootPathElement():null).getBoundingSphere(e.getMainViewer());return 2*(t?t.radius:1e3)}update(e){let t=this.getCachedNode(e);if(e.nodeType===i.ENodeType.feedbackLive)if(this.point&&this.normal&&t){let e=s.getMatrixFromOVz(this.point,this.normal);t.setMatrix(e)}else console.warn(new Error("Error"));else if(this.start&&this.normal&&t){let e=new a.Vector3(1,0,0),i=new a.Vector3(0,1,0),n=new a.Vector3(0,0,this.getWorldSize()*this.worldSizeScale),r=(new a.Matrix4).makeBasis(e,i,n),o=s.getMatrixFromOVz(this.start,this.normal);t.setMatrix((new a.Matrix4).multiplyMatrices(o,r))}else console.warn(new Error("Error"));return super.update(e)}getNode(e){if(e.nodeType===i.ENodeType.feedbackLive)return r.prototype.getNode.call(this,e);if(this.center&&this.normal){let e=n.createLineNode({points:[new a.Vector3(0,0,0),new a.Vector3(0,0,1)]});return this._setNodeOptions(e),e}return null}getLineType(){return"Dotted"}getType(){return"Axis"}}}),define("DS/VCXWebCanonics/VCXMeasurableCone",["require","exports","DS/Visualization/Measurable","DS/VCXWebCanonics/VCXMeasurable","DS/VCXWebCanonics/VCXMagnetPoint","DS/VCXWebCanonics/VCXMagnetCenter","DS/VCXWebCanonics/VCXMagnetAxis","DS/VCXWebCanonics/VCXMagnetCircle","DS/Visualization/ThreeJS_DS"],function(e,t,i,n,a,s,r,o,l){"use strict";return class extends n{constructor(e){super(e),this._type=i.TYPECONE,this.axis=e.axis,this.apex=e.apex,this.semiAngle=e.semiAngle,this.extremity1=e.extremity1,this.extremity2=e.extremity2,this.center=e.center||(new l.Vector3).addVectors(this.extremity1,this.extremity2).multiplyScalar(.5)}getSize(e){let t=this.getHolderMatrix(e),i=this.extremity1.clone().applyMatrix4(t),n=this.extremity2.clone().applyMatrix4(t),a=Math.tan(this.semiAngle),s=this.apex.distanceTo(i)*a,r=this.apex.distanceTo(n)*a;return 2*Math.max(s,r)}async populateMagnets(e,t){let i=this.getHolderMatrix(e),n=this.extremity1.clone().applyMatrix4(i),c=this.extremity2.clone().applyMatrix4(i),h=this.axis.clone().transformDirection(i).normalize(),d=Math.tan(this.semiAngle),u=this.apex.distanceTo(n),p=new l.Vector3(this.apex.x+u*h.x,this.apex.y+u*h.y,this.apex.z+u*h.z),g=u*d,C=this.apex.distanceTo(c),m=new l.Vector3(this.apex.x+C*h.x,this.apex.y+C*h.y,this.apex.z+C*h.z),_=C*d;{let e=(new l.Vector3).addVectors(p,m).multiplyScalar(.5),t=0;this._magnets||(this._magnets=[],this._magnets.push(new r({measurable:this,magnetID:t++})),this._magnets.push(new r({measurable:this,magnetID:t++})),this._magnets.push(new a({measurable:this,magnetID:t++})),this._magnets.push(new a({measurable:this,magnetID:t++})),this._magnets.push(new s({measurable:this,magnetID:t++})),this._magnets.push(new o({measurable:this,magnetID:t++})),this._magnets.push(new o({measurable:this,magnetID:t++}))),t=0;let i=this._magnets[t];i.center=p,i.start=e,i.radius=g,i.normal=h,t++;let n=this._magnets[t];n.center=m,n.start=e,n.radius=_,n.normal=h.clone().negate(),t++;let c=this._magnets[t];c.position=p,c.radius=g,c.normal=h,t++;let d=this._magnets[t];d.position=m,d.radius=_,d.normal=h.clone().negate(),t++;let u=this._magnets[t];u.position=e,u.radius=.5*(_+g),u.normal=h.clone().negate(),t++;let C=this._magnets[t];C.position=p,C.radius=g,C.axis=h,t++;let b=this._magnets[t];b.position=m,b.radius=_,b.axis=h.clone().negate()}return super.populateMagnets(e,t)}}}),define("DS/VCXWebCanonics/VCXMeasurableCircle",["require","exports","DS/Visualization/Measurable","DS/VCXWebCanonics/VCXMeasurable","DS/VCXWebCanonics/VCXMagnetCenter","DS/VCXWebCanonics/VCXMagnetAxis","DS/VCXWebCanonics/VCXMagnetCircle"],function(e,t,i,n,a,s,r){"use strict";return class extends n{constructor(e){super(e),this._type=i.TYPECIRCLE,this.center=e.center,this.axis=e.axis,this.radius=e.radius}getSize(e){return 2*this.radius}async populateMagnets(e,t){{let t=this.getHolderMatrix(e),i=this.center.clone().applyMatrix4(t),n=this.radius,o=this.axis.clone().transformDirection(t).normalize(),l=0;this._magnets||(this._magnets=[],this._magnets.push(new a({measurable:this,magnetID:l++})),this._magnets.push(new r({measurable:this,magnetID:l++})),this._magnets.push(new s({measurable:this,magnetID:l++})),this._magnets.push(new s({measurable:this,magnetID:l++}))),l=0;let c=this._magnets[l];c.position=i,c.radius=n,c.normal=o,l++;let h=this._magnets[l];h.position=i,h.radius=n,h.axis=o,l++;let d=this._magnets[l];d.center=i,d.start=i,d.radius=n,d.normal=o,l++;let u=this._magnets[l];u.center=i,u.start=i,u.radius=n,u.normal=o.clone().negate()}return super.populateMagnets(e,t)}}}),define("DS/VCXWebCanonics/VCXMeasurableTorus",["require","exports","DS/Visualization/Measurable","DS/VCXWebCanonics/VCXMeasurable","DS/VCXWebCanonics/VCXMagnetCenter","DS/VCXWebCanonics/VCXMagnetAxis","DS/VCXWebCanonics/VCXMagnetCircle"],function(e,t,i,n,a,s,r){"use strict";return class extends n{constructor(e){super(e),this._type=i.TYPETORUS,this.center=e.center,this.axis=e.axis,this.minRadius=e.minRadius,this.maxRadius=e.maxRadius}getSize(e){return 2*Math.max(this.minRadius,this.maxRadius)}async populateMagnets(e,t){let i=this.getHolderMatrix(e),n=this.center.clone().applyMatrix4(i),o=this.axis.clone().transformDirection(i).normalize(),l=this.minRadius,c=this.maxRadius,h=0;this._magnets||(this._magnets=[],this._magnets.push(new a({measurable:this,magnetID:h++})),this._magnets.push(new r({measurable:this,magnetID:h++})),this._magnets.push(new r({measurable:this,magnetID:h++})),this._magnets.push(new s({measurable:this,magnetID:h++})),this._magnets.push(new s({measurable:this,magnetID:h++}))),h=0;let d=this._magnets[h];d.position=n,d.radius=c,d.normal=o,h++;let u=this._magnets[h];u.position=n,u.radius=l,u.axis=o,h++;let p=this._magnets[h];p.position=n,p.radius=c,p.axis=o,h++;let g=this._magnets[h];g.start=n,g.center=n,g.radius=l,g.normal=o,h++;let C=this._magnets[h];return C.start=n,C.center=n,C.radius=c,C.normal=o.clone().negate(),super.populateMagnets(e,t)}}}),define("DS/VCXWebCanonics/VCXMeasurableCylinder",["require","exports","DS/Visualization/Measurable","DS/VCXWebCanonics/VCXMeasurable","DS/VCXWebCanonics/VCXMagnetCenter","DS/VCXWebCanonics/VCXMagnetPoint","DS/VCXWebCanonics/VCXMagnetAxis","DS/VCXWebCanonics/VCXMagnetCircle","DS/Visualization/ThreeJS_DS"],function(e,t,i,n,a,s,r,o,l){"use strict";return class extends n{constructor(e){super(e),this._type=i.TYPECYLINDER,this.center=e.center,this.axis=e.axis,this.radius=e.radius,this.extremity1=e.extremity1,this.extremity2=e.extremity2,this.center=e.center||(new l.Vector3).addVectors(this.extremity1,this.extremity2).multiplyScalar(.5)}getSize(e){return 2*this.radius}async populateMagnets(e,t){let i=this.getHolderMatrix(e),n=this.radius,c=this.center.clone().applyMatrix4(i),h=this.extremity1.clone().applyMatrix4(i),d=this.extremity2.clone().applyMatrix4(i),u=this.axis.clone().transformDirection(i).normalize(),p=h.distanceTo(d);{let e=new l.Vector3(c.x+.5*p*u.x,c.y+.5*p*u.y,c.z+.5*p*u.z),t=new l.Vector3(c.x-.5*p*u.x,c.y-.5*p*u.y,c.z-.5*p*u.z),i=(new l.Vector3).addVectors(e,t).multiplyScalar(.5),h=0;this._magnets||(this._magnets=[],this._magnets.push(new r({measurable:this,magnetID:h++})),this._magnets.push(new r({measurable:this,magnetID:h++})),this._magnets.push(new s({measurable:this,magnetID:h++})),this._magnets.push(new s({measurable:this,magnetID:h++})),this._magnets.push(new a({measurable:this,magnetID:h++})),this._magnets.push(new o({measurable:this,magnetID:h++})),this._magnets.push(new o({measurable:this,magnetID:h++}))),h=0;let d=this._magnets[h];d.center=e,d.start=i,d.radius=n,d.normal=u,h++;let g=this._magnets[h];g.center=c,g.start=i,g.radius=n,g.normal=u.clone().negate(),h++;let C=this._magnets[h];C.position=e,C.radius=n,C.normal=u,h++;let m=this._magnets[h];m.position=t,m.radius=n,m.normal=u.clone().negate(),h++;let _=this._magnets[h];_.position=i,_.radius=n,_.normal=u.clone().negate(),h++;let b=this._magnets[h];b.position=e,b.radius=n,b.axis=u,h++;let M=this._magnets[h];M.position=t,M.radius=n,M.axis=u.clone().negate()}return super.populateMagnets(e,t)}}}),define("DS/VCXWebCanonics/VCXMagnetLine",["require","exports","DS/VCXWebKernelTools/VCXMeshServices","DS/VCXWebCanonics/VCXMagnet","DS/Visualization/ThreeJS_DS","DS/VCXWebKernelTools/VCXMathTools","DS/VCXWebCanonics/VCXMagnetPoint"],function(e,t,i,n,a,s,r){"use strict";return class extends n{updateFromRay(e,t){return this.point=new a.Vector3,e.distanceSqToSegment(this.extremity1,this.extremity2,null,this.point),this}update(e){var t=this.getCachedNode(e);if(e.nodeType===n.ENodeType.feedbackLive)if(this.point&&this.normal&&t){let e=s.getMatrixFromOVz(this.point,this.normal);t.setMatrix(e)}else console.warn(new Error("Error"));if(this.extremity1&&this.extremity2&&t){var i=new a.Vector3(1,0,0),r=new a.Vector3(0,1,0),o=new a.Vector3(0,0,this.extremity1.distanceTo(this.extremity2)),l=(new a.Matrix4).makeBasis(i,r,o),c=(new a.Vector3).subVectors(this.extremity2,this.extremity1),h=s.getMatrixFromOVz(this.extremity1,c);t.setMatrix((new a.Matrix4).multiplyMatrices(h,l))}else console.warn(new Error("Error"));return super.update(e)}getNode(e){if(this.extremity1&&this.extremity2){if(e.nodeType===n.ENodeType.feedbackLive)return r.prototype.getNode.call(this,e);var t=i.buildLineStripSet([0,0,0,0,0,1],[2],[0,1],null,2,null);return this._setNodeOptions(t),t}return console.warn(new Error("Error")),t}getType(){return"Line"}}}),define("DS/VCXWebCanonics/VCXMeasurableLine",["require","exports","DS/Visualization/Measurable","DS/VCXWebCanonics/VCXMeasurable","DS/VCXWebCanonics/VCXMagnetLine","DS/VCXWebCanonics/VCXMagnetPoint","DS/VCXWebCanonics/VCXMagnetCenter","DS/Visualization/ThreeJS_DS"],function(e,t,i,n,a,s,r,o){"use strict";return class extends n{constructor(e){super(e),this._type=i.TYPELINE,this.startPosition=e.startPosition,this.endPosition=e.endPosition,this.direction=(new o.Vector3).subVectors(this.endPosition,this.startPosition).normalize()}getSize(e){let t=this.getHolderMatrix(e),i=this.startPosition.clone().applyMatrix4(t),n=this.endPosition.clone().applyMatrix4(t);return i.distanceTo(n)}async populateMagnets(e,t){let i=this.getHolderMatrix(e),n=this.startPosition.clone().applyMatrix4(i),l=this.endPosition.clone().applyMatrix4(i),c=this.direction.clone().transformDirection(i),h=(new o.Vector3).addVectors(n,l).multiplyScalar(.5),d=0;this._magnets||(this._magnets=[],this._magnets.push(new a({measurable:this,magnetID:d++})),this._magnets.push(new s({measurable:this,magnetID:d++})),this._magnets.push(new s({measurable:this,magnetID:d++})),this._magnets.push(new r({measurable:this,magnetID:d++}))),d=0;let u=this._magnets[d];u.extremity1=n,u.extremity2=l,u.normal=c,d++;let p=this._magnets[d];p.position=n,p.normal=c,d++;let g=this._magnets[d];g.position=l,g.normal=c.clone().negate(),d++;let C=this._magnets[d];return C.position=h,C.normal=c,super.populateMagnets(e,t)}}}),define("DS/VCXWebCanonics/VCXMagnetPlane",["require","exports","DS/VCXWebCanonics/VCXMagnet","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/VCXWebKernelTools/VCXMathTools","DS/Visualization/Node3D"],function(e,t,i,n,a,s,r){"use strict";return class extends i{updateFromRay(e,t){return this.point=new a.Vector3,e.intersectPlane((new a.Plane).setFromNormalAndCoplanarPoint(this.normal,this.origin),this.point),this}update(e){var t=this.getCachedNode(e);if(this.origin&&this.normal&&this.width&&this.height&&t){let n=this.width,r=this.height,o=this.origin;if(e.nodeType===i.ENodeType.feedbackLive){let e=(this.associatedObject&&this.associatedObject.GetObject()._experienceBase.getManager("VCXContextManager")).getMainViewer().currentViewpoint.getEyePosition().distanceTo(this.point)/20;n=e,r=e,o=this.point}let l=new a.Vector3(n,0,0),c=new a.Vector3(0,r,0),h=new a.Vector3(0,0,1),d=(new a.Matrix4).makeBasis(l,c,h),u=new a.Matrix4;u.setPosition(new a.Vector3(-.5,-.5,0));let p=s.getMatrixFromOVz(o,this.normal);t.setMatrix((new a.Matrix4).multiplyMatrices(p,(new a.Matrix4).multiplyMatrices(d,u)))}else console.warn(new Error("Error"));return super.update(e)}getNode(e){if(e.nodeType===i.ENodeType.feedback)return new r;if(this.origin&&this.normal&&this.width&&this.height){var t=n.createRectangleNode({width:1,height:1,fill:!0});return this._setNodeOptions(t),t}return console.warn(new Error("Error")),null}getType(){return"Plane"}}}),define("DS/VCXWebCanonics/VCXMeasurablePlane",["require","exports","DS/Visualization/Measurable","DS/VCXWebCanonics/VCXMeasurable","DS/VCXWebCanonics/VCXMagnetPlane"],function(e,t,i,n,a){"use strict";return class extends n{constructor(e){super(e),this._type=i.TYPEPLANE,this.normal=e.normal,this.position=e.position,this.width=e.width,this.height=e.height}getSize(e){return Math.max(this.width,this.height)}async populateMagnets(e,t){let i=this.getHolderMatrix(e),n=0;this._magnets||(this._magnets=[],this._magnets.push(new a({measurable:this,magnetID:n++}))),n=0;let s=this._magnets[n];return s.origin=this.position.clone().applyMatrix4(i),s.normal=this.normal.clone().transformDirection(i).normalize(),s.width=this.width,s.height=this.height,super.populateMagnets(e,t)}}}),define("DS/VCXWebCanonics/VCXCanonicsManagerArcBar",["DS/VCXWebGUIInfra/VCXArcBar","DS/VCXWebCanonics/VCXCanonicsManagerEnum","DS/WebappsUtils/WebappsUtils","i18n!DS/VCXWebVisualization/assets/nls/VCXWebVisualization"],function(e,t,i,n){"use strict";var a=e.extend({init:function(e){if(this.canonicsManager=e&&e.canonicsManager,this._experienceBase=this.canonicsManager&&this.canonicsManager._experienceBase,this.AvailableFilter=e&&e.availableFilter,!this.canonicsManager||!this.AvailableFilter)return null;var t=this._experienceBase.getManager("VCXContextManager").getUIFrame();if(!t)return null;var i=-10;this._experienceBase.getManager("VCXContextManager").isTouchCompliantDevice()&&(i+=25);var n=this._createButtons();return n&&n.length?this._parent({experienceBase:this._experienceBase,body:t,frmWindow:this._experienceBase.getManager("VCXContextManager").getFrameWindow(),title:"Filter Control",typeSeparator:"bubble",actionBar:this._experienceBase.getManager("VCXContextManager").getActionBar(),heightOffset:i,lJsonElement:n,heightElem:38,widthElem:38,minOpacity:.4,padding:7}):null},_createButtons:function(){var e=[],a=this.canonicsManager._canonicsMode;for(var s in t.Canonic)if(this.AvailableFilter&t.Canonic[s]){if(!s||""===s){console.log("[ARC BAR][NLS] Geometry can't be identified");continue}var r=n["Canonic."+s];if(!r||""===r){console.log("[ARC BAR][NLS] Geometry translation can't be identified from the input string");continue}var o=i.getWebappsAssetUrl("VCXWebCanonics","icons/I_VCX_Canonics_"+s+".png");if(!o||""===o){console.log("[ARC BAR][URL] Geometry icon url can't be identified from the input string");continue}var l=t.Canonic[s];if(!l){console.log("[ARC BAR][ENUM] Geometry enum can't be identified from the input string");continue}this.canonicsManager.detectableCanonics&l&&(a|=l);var c={nls:r,url:o,id:"id_Canonic_"+s,type:"element",userdata:l,check:this.canonicsManager.detectableCanonics&l,callback:e=>{var t=this.canonicsManager.detectableCanonics;t&e?t&=~e:t|=e,this.canonicsManager.detectableCanonics=t},callbackUpdate:(e,t)=>{var i=this.canonicsManager.detectableCanonics;e.check=!!(i&t);var n=this.canonicsManager._canonicsMode;e.enable=!!(n&t)}};e.push(c),this.canonicsManager._canonicsMode=a}return e}});return Object.defineProperty(a.prototype,"componentType",{enumerable:!0,get:function(){return"VCXCanonicsManagerArcBar"}}),Object.defineProperty(a.prototype,"AvailableFilter",{enumerable:!0,get:function(){return this._AvailableFilter},set:function(e){this._AvailableFilter=e}}),Object.defineProperty(a.prototype,"ActiveFilter",{enumerable:!0,get:function(){return this._ActiveFilter},set:function(e){this._ActiveFilter=e}}),a}),define("DS/VCXWebCanonics/VCXCanonicsManager",["require","exports","DS/VCXWebKernelTools/VCXMeshServices","DS/Mesh/MeshUtils","DS/VCXWebVisualization/VCXInteractor","WebappsUtils/WebappsUtils","DS/VCXWebCanonics/VCXCanonicsManagerArcBar","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Visualization/Node3D","DS/VCXWebKernelTools/VCXMathTools","DS/VCXWebCanonics/VCXMagnet","DS/VCXWebCanonics/VCXCanonicsManagerEnum"],function(e,t,i,n,a,s,r,o,l,c,h,d,u){"use strict";class p{constructor(){this.pixelsEpsilon=10,this.canonicMat={}}init(){this._canonicsMode=u.Canonic.None,this.detectableCanonics=u.Canonic.None,this._redoDetection=!0}clearVisu(){var e=this._experienceBase?this._experienceBase.getManager("VCXContextManager").getMainViewer():null;if(e){for(let e in this._decorationNode)this._decorationNode.hasOwnProperty(e)&&this._decorationNode[e].removeChildren();this._rootDecoration&&this._rootDecoration.removeChildren(),e.removeNode(this._rootDecoration),this._rootFeedback&&this._rootFeedback.removeChildren(),e.removeNode(this._rootFeedback),this._rootFeedbackLive&&this._rootFeedbackLive.removeChildren(),e.removeNode(this._rootFeedbackLive)}this._verticalLineNode=null,this._horizontalLineNode=null,this._rootDecoration=null,this._decorationNode=null,this._rootFeedback=null,this._rootFeedbackLive=null}clear(){delete this._detectedObject,delete this._magnets,this.detectedCanonic=null,this._redoDetection=!0,this.clearVisu()}postInitialize(){var e=this._experienceBase.getManager("VCXContextManager");e&&e.isSupported("CanonicsDetection")&&(this._WUXEventTokens={},this._WUXEventTokens.VCX_TEMPORARILY_HIDE_DECORATION=l.subscribe({event:"VCX_TEMPORARILY_HIDE_DECORATION"},e=>{if(this._rootDecoration&&this._rootDecoration.setVisibility(!1),this._peHighlightSet){var t=this._peHighlightSet.getHighlightData();t.colorEnabled=!1,t.haloEnabled=!1,t.outlineEnabled=!1,this._peHighlightSet.setHighlightData(!0,t)}}),this._WUXEventTokens.VCX_RESTORE_TEMPORARILY_HIDDEN_DECORATION=l.subscribe({event:"VCX_RESTORE_TEMPORARILY_HIDDEN_DECORATION"},e=>{if(this._rootDecoration&&this._rootDecoration.setVisibility(!0),this._peHighlightSet){var t=this._peHighlightSet.getHighlightData();t.colorEnabled=!0,t.haloEnabled=!0,t.outlineEnabled=!0,this._peHighlightSet.setHighlightData(!0,t)}}),this._WUXEventTokens.VCX_INTERACTOR_BEGIN_MANIPULATE=l.subscribe({event:"VCX_INTERACTOR_BEGIN_MANIPULATE"},e=>{if(!e||!this.detectableCanonics)return;let t=e.attachedOccurrence;t||(t=e.attachedOccurrences&&e.attachedOccurrences[0]),t&&this.activateOccurrenceMagnets(t)}))}unInitialize(){for(var e in this.canonicMat={},this.clear(),this._arcBar&&this._arcBar.clear(),this._arcBar=null,this._WUXEventTokens)this._WUXEventTokens.hasOwnProperty(e)&&this._WUXEventTokens[e]&&(l.unsubscribe(this._WUXEventTokens[e]),this._WUXEventTokens[e]=null)}_shouldDisplayArcBar(){var e=this._experienceBase.getManager("VCXContextManager");if(!(e&&e.isSupported("CanonicsDetection")))return 0;var t=0,i=this._experienceBase.getManager("VCXManipulatorManager");return i&&i._activeManipulables&&i._activeManipulables.forEach(e=>{if(e.GetObject().IsKindOf("VCXDressup_Spec")&&e){var i=e.getActiveInteractors();for(var n in i)if(i.hasOwnProperty(n)){var a=i[n];if(a.isManipulated())return void(t=a.canonicsDetection);a.active&&a.tag&&a.tag.Canonic&&(t|=a.canonicsDetection)}}}),t}getPreHighlightSet(){if(!this._peHighlightSet){var e=this._experienceBase.getManager("VCXContextManager").getMainViewer();this.peHighlightColor=new o.AdvancedPoliteHighlightData({polite:!0,priority:-4,colorEnabled:!0,color:new o.Color(16777215),intensity:.5,visibleAlpha:.3,occludedAlpha:.3,haloEnabled:!0,haloColor:new o.Color(16777215),lineicHaloColor:new o.Color(16777215),haloIntensity:1,haloThickness:4,outlineEnabled:!0,outlineColor:new o.Color(16777215),lineicOutlineColor:new o.Color(16777215),outlineAlpha:.3,outlineThickness:.5}),this._peHighlightSet=e.createHighlightSet(this.peHighlightColor,!1,!0,!0)}return this._peHighlightSet}getDefaultMaterial(e,t="Plain",i,n=!1,a=!0,r=!1){let l=e.nodeType===d.ENodeType.feedback||e.nodeType===d.ENodeType.feedbackLive;var c=l?2:i||3,h=t+"_"+c+"_"+e.nodeType+"_"+(n?1:0)+"_"+(a?1:0)+"_"+(r?1:0);if(!this.canonicMat[h])if(n){let e=s.getWebappsAssetUrl("VCXWebVisualization","texture"),t=new o.ImageUtils.loadTexture(e+"/VCX_Point_dot.png");t.flipY=!1,t.minFilter=o.LinearMipMapLinearFilter,this.canonicMat[h]=new o.MeshBasicMaterial({map:t,side:o.DoubleSide,alphaTest:.005,enableClipPlanes:!1,opacity:1,force:!0})}else{this.canonicMat[h]=new o.MeshBasicMaterial({side:o.DoubleSide,opacity:l?.3:this._debugDisplay?.1:0,color:"#FFFFFF",force:!0});let e=new o.Color("#E87B00");r&&(e=new o.Color("#FFFFFF")),!a&&this._debugDisplay&&(e=new o.Color("#080B99"));let i=l?this._debugDisplay?.5:r?.5:.9:this._debugDisplay?.3:0;r&&"Dotted"===t&&(i=0);let n=new o.LineBasicMaterial({dashType:t,isCPUPattern:!0});n=this._experienceBase.getManager("VCXMaterialManager").getLineMaterialFromParams({lineWidth:c,color:e,opacity:i},n),this.canonicMat[h].line=n}return this.canonicMat[h]}async activateOccurrenceMagnets(e){this.clear(),this._magnets={},this._magnetDirty=!0,this._detectedObject=e;let t=this._detectedObject.QueryInterface("VCXIMeasurableHolder");t&&await this._analyseMeasurableHolder(t),this._magnetDirty=!0}update(e){if(this.askDetection(),this._magnets)if(this._experienceBase.getManager("VCXVisuManager").HasViewpointMoved||this._magnetCreated){if(this._magnetDirty=!0,this._magnetCreated=!1,this._magnetDisplayed){this._magnetDisplayed=!1;for(let e in this._magnets)this._magnets.hasOwnProperty(e)&&this._decorationNode&&this._decorationNode[e]&&this._decorationNode[e].setVisibility(!1);this._experienceBase.getManager("VCXContextManager").getMainViewer().render()}}else if(this._magnetDirty){this._magnetDisplayed=!0,this._magnetDirty=!1;for(let e in this._magnets)if(this._magnets.hasOwnProperty(e)){let i=this.detectableCanonics&u.Canonic[e];if(i){var t=this._magnets[e];t&&t.forEach(e=>{let t=!1;e.associatedObject.GetObject().BuildGraphicPropertiesStructure({getVisibility:!0})[0].visible.Visibility&&(t=!0),e.setVisibility({createIfMissing:t,nodeType:d.ENodeType.picking},t),t&&e.update({createIfMissing:!!i,nodeType:d.ENodeType.picking})})}this._decorationNode&&this._decorationNode[e]&&this._decorationNode[e].setVisibility(i)}this._experienceBase.getManager("VCXContextManager").getMainViewer().render()}var i=this._experienceBase.getManager("VCXContextManager");i&&i.partHasMoved&&(this._redoDetection=!0),this._visuDirty&&(this._visuDirty=!1,this.detectedCanonic&&this.detectedCanonic.update({createIfMissing:!0,nodeType:d.ENodeType.feedbackLive}),this.detectedCanonic&&this.detectedCanonic.update({createIfMissing:!0,nodeType:d.ENodeType.feedback}))}snap2D(e,t,i,n){var s,r=t&&t.manipulatorType!==a.EManipulatorType.None;if(this._showVerticalLine=!1,this._showHorizontalLine=!1,n&&(n.snapX=null,n.snapY=null),!r){var l=i.viewer.currentViewpoint.project(t.manipulator.initial3dIntersectionPoint);if(n.translationVector){var c=i.viewer.currentViewpoint.project(t.manipulator.initial3dIntersectionPoint.clone().add(n.translationVector));s=(new o.Vector3).subVectors(c,l)}else s=l}let h=this.check2DSnapping(e,t,i,s);if(h&&(h.X||h.Y)){if(h.X){let e=h.X.screenCoord2[0];if(r){let t=e.x-i.mouse.xPix;Math.abs(t)<this.pixelsEpsilon&&(i.mouse.xPix=e.x,i.mouse.snapX=t,this._showVerticalLine=!0)}else{let t=h.X.screenCoord1[0],i=e.x-t.x;Math.abs(i)<this.pixelsEpsilon&&(n.snapX=i,this._showVerticalLine=!0)}}if(h.Y){let e=h.Y.screenCoord2[0];if(r){let t=e.y-i.mouse.yPix;Math.abs(t)<this.pixelsEpsilon&&(i.mouse.yPix=e.y,i.mouse.snapY=t,this._showHorizontalLine=!0)}else{let t=h.Y.screenCoord1[0],i=e.y-t.y;Math.abs(i)<this.pixelsEpsilon&&(n.snapY=i,this._showHorizontalLine=!0)}}}this._update2DLineFeedback("vertical",this._showVerticalLine,h&&h.X,i),this._update2DLineFeedback("horizontal",this._showHorizontalLine,h&&h.Y,i)}static check2DCandidate(e,t,i,n,a){var s=Math.max(Math.abs(i.x-t.x),Math.abs(n.x-t.x),Math.abs(n.x-i.x)),r=Math.max(Math.abs(i.y-t.y),Math.abs(n.y-t.y),Math.abs(n.y-i.y));return s<a&&(!e.X||s<e.X.minDistX+.01)&&(e.X&&(s<e.X.minDistX-.01?e.X=null:Math.abs(i.x-e.X.screenCoord2[0].x)<.01&&(e.X.screenCoord1.includes(t)||e.X.screenCoord1.push(t),e.X.screenCoord2.includes(i)||e.X.screenCoord2.push(i))),e.X||(e.X={minDistX:s,screenCoord1:[t],screenCoord2:[i]})),r<a&&(!e.Y||r<e.Y.minDistY+.01)&&(e.Y&&(r<e.Y.minDistY-.01?e.Y=null:Math.abs(i.y-e.Y.screenCoord2[0].y)<.01&&(e.Y.screenCoord1.includes(t)||e.Y.screenCoord1.push(t),e.Y.screenCoord2.includes(i)||e.Y.screenCoord2.push(i))),e.Y||(e.Y={minDistY:r,screenCoord1:[t],screenCoord2:[i]})),e}check2DSnapping(e,t,i,n){var s=this._experienceBase.getManager("VCXDressupManager");if(e&&e.IsKindOf("VCXMarkup_Spec")){var r=e.QueryInterface("VCXIModifiable");if(r&&1e3===r.GetPropertyValue("Collab.3D.Paper.Positioning.Type")){var l=e.QueryInterface("VCXIManipulable").getActiveInteractors(),c={};for(var d in l)if(l.hasOwnProperty(d)){var u=l[d];if(u.manipulatorType!==a.EManipulatorType.None&&u.tag&&u.tag.Snap2D){var g,C;n?((g=i.viewer.currentViewpoint.project(h.getOFromMatrix(u.initialMatrix))).add(n),C=g.clone()):((C=(g=i.viewer.currentViewpoint.project(h.getOFromMatrix(u.matrix))).clone()).x=i.mouse.xPix,C.y=i.mouse.yPix);var m=this._experienceBase.getManager("VCXPaperManager");if(m){var _=m.MMToPixel2(null,new o.Vector2(0,0));p.check2DCandidate(c,g,_,C,this.pixelsEpsilon),_=m.MMToPixel2(null,m.Size),p.check2DCandidate(c,g,_,C,this.pixelsEpsilon),_=m.MMToPixel2(null,new o.Vector2(.5*m.Size.x,.5*m.Size.y)),p.check2DCandidate(c,g,_,C,this.pixelsEpsilon)}var b=s.getDressups();for(var M in b)if(b.hasOwnProperty(M)){var V=b[M];if(e!==V&&V.IsKindOf("VCXMarkup_Spec")){var x=V.QueryInterface("VCXIVisibility");if(x&&x.GetVisibility()){var y=this._experienceBase.getManager("VCXSelectionManager");if(y&&!y.GetComponentsFromSelection("CSO").includes(V)){var f=V.QueryInterface("VCXIModifiable");if(f&&1e3===f.GetPropertyValue("Collab.3D.Paper.Positioning.Type")){var D=V.QueryInterface("VCXIManipulable").getActiveInteractors();for(var X in D)if(D.hasOwnProperty(X)){var S=D[X];if(S.manipulatorType!==a.EManipulatorType.None&&S.tag&&S.tag.Snap2D){var v=i.viewer.currentViewpoint.project(h.getOFromMatrix(S.matrix));p.check2DCandidate(c,g,v,C,this.pixelsEpsilon)}}}}}}}}}return c}}return null}_update2DLineFeedback(e,t,a,s){if(t&&!this._lineChoice(e)){let t={createIfMissing:!0,nodeType:d.ENodeType.feedback};var r=i.buildLineStripSet([0,0,0,0,0,1],[2],[0,1],null,1,null,this.getDefaultMaterial(t,"Plain",1,!1,!1));let a=this._experienceBase.getManager("VCXVisuManager");r.setNoZ(!0),r.setPickable(n.PICKTHROUGH),r.setRenderPasses([a.getRenderList("VCXPreManipulators"),a.getRenderList("VCXManipulators")]),r.setFrustumCulled&&r.setFrustumCulled(!1),r.setShadow&&r.setShadow(!1,!1),r.setMirror&&r.setMirror(!1),r.exludeFromBounding&&r.exludeFromBounding(!0);var l=new c;l.add(r),l.name="VCXSnappingLine"+e,this.createAndGetRootDecoration(t,"VCXCanonic2DLines").add(l),"vertical"===e?this._verticalLineNode=l:"horizontal"===e&&(this._horizontalLineNode=l)}if(t&&this._lineChoice(e)&&a&&a.screenCoord2&&a.screenCoord1){for(var u=null,p=null,g=null,C=null,m=null,_=0;_<a.screenCoord2.length;_++){var b=a.screenCoord2[_];(null===g||g>b.x)&&(g=b.x),(null===u||u<b.x)&&(u=b.x),(null===C||C>b.y)&&(C=b.y),(null===p||p<b.y)&&(p=b.y),(null===m||m>b.z)&&(m=b.z)}for(_=0;_<a.screenCoord1.length;_++){b=a.screenCoord1[_];"horizontal"==e?((null===g||g>b.x)&&(g=b.x),(null===u||u<b.x)&&(u=b.x)):((null===C||C>b.y)&&(C=b.y),(null===p||p<b.y)&&(p=b.y))}var M=new o.Vector3(g,C,m),V=new o.Vector3(u,p,m);"horizontal"==e?(M.x=g-30,V.x=u+30):(M.y=C-30,V.y=p+30);var x=s.viewer.currentViewpoint.unProject(M),y=s.viewer.currentViewpoint.unProject(V),f=new o.Vector3(1,0,0),D=new o.Vector3(0,1,0),X=new o.Vector3(0,0,y.distanceTo(x)),S=(new o.Matrix4).makeBasis(f,D,X),v=(new o.Vector3).subVectors(y,x),w=h.getMatrixFromOVz(x,v);this._lineChoice(e).setMatrix((new o.Matrix4).multiplyMatrices(w,S))}this._lineChoice(e)&&this._lineChoice(e).setVisibility(t)}async _analyseMeasurableHolder(e){if(e.QueryInterface("VCXIVisibility").GetVisibility()){var t=this._experienceBase.getManager("VCXContextManager").getMainViewer();await e.populateMagnets(t,this._magnets),this._magnetCreated=!0}}askDetection(){if(this._debugDisplay=this._experienceBase.getManager("VCXContextManager").isSupported("VCXCanonicsDebugDisplay"),this._visuDirty=!0,this._canonicsMode=this._shouldDisplayArcBar(),this._canonicsMode){if(this._arcBar){if(this._arcBar.AvailableFilter===this._canonicsMode)return;this.clear(),this._arcBar&&this._arcBar.clear(),this._arcBar=null}this._arcBar=new r({canonicsManager:this,availableFilter:this._canonicsMode}),this._magnetDirty=!0}else this._canonicsMode=u.Canonic.None,this._arcBar&&this._arcBar.clear(),this._arcBar=null}_lineChoice(e){return"vertical"===e?this._verticalLineNode:"horizontal"===e?this._horizontalLineNode:void 0}setFeedbackNode(e){if(e&&e.static&&!this._rootFeedback){let e=this._experienceBase.getManager("VCXContextManager").getMainViewer();e&&(this._rootFeedback=new c("VCXCanonicFeedback"),e.addNode(this._rootFeedback))}if(this._rootFeedback&&this._rootFeedback.removeChildren(),e&&e.static&&this._rootFeedback.add(e.static),e&&e.live&&!this._rootFeedbackLive){let e=this._experienceBase.getManager("VCXContextManager").getMainViewer();e&&(this._rootFeedbackLive=new c("VCXCanonicFeedbackLive"),e.addNode(this._rootFeedbackLive))}this._rootFeedbackLive&&this._rootFeedbackLive.removeChildren(),e&&e.live&&this._rootFeedbackLive.add(e.live)}createAndGetRootDecoration(e,t){if(e.createIfMissing&&!this._decorationNode&&(this._decorationNode=[]),e.createIfMissing&&!this._decorationNode[t]){if(!this._rootDecoration){var i=this._experienceBase.getManager("VCXContextManager").getMainViewer();i&&(this._rootDecoration=new c("VCXCanonics"),i.addNode(this._rootDecoration))}this._decorationNode[t]=new c("VCXCanonics"+t),this._rootDecoration.add(this._decorationNode[t]),this._magnetCreated=!0}return this._decorationNode&&this._decorationNode[t]}async pickCanonics(e,t,i){if(!e)return;var n=this.detectableCanonics&this._canonicsMode&(t&&t.canonicsDetection);if(n&&(n|=u.Canonic.Object),n===u.Canonic.None)return;this._redoDetection&&n!==u.Canonic.Object&&n!==u.Canonic.None&&(this._redoDetection=!1);var a=e.viewer;if(!a||!a.currentViewpoint)return;var s=e.modifiable?e.modifiable.QueryInterface("W3AISGNodeHolder"):null,r=s?s.getPathElement():null,l=r?r.getWorldMatrix(a):new o.Matrix4;let c;if(l||(l=new o.Matrix4),e.pathElement&&e.pathElement.getLastElement(!0).magnet){let i=e.pathElement.getLastElement(!0).magnet;c=i.updateFromRay(e.ray,t),i.isActive()||"Axis"!==i.getType()||this._magnets.Axis.forEach(e=>{c.isABetterCandidate(e)&&(e.point=c.point,c=e)})}if(e.magnet=c,!c&&n&u.Canonic.Object&&e.modifiable){this._detectedObject!==e.modifiable&&await this.activateOccurrenceMagnets(e.modifiable);var h=e.globalNormal&&e.globalNormal.normalize();c=new d({type:u.Canonic.Object,point:e.globalPosition,normal:h,xAxis:null,id:"SimpleObject",pathElement:e.pathElement,associatedObject:e.modifiable.GetObject()})}if(this.detectedCanonic=c,this._visuDirty=!0,c&&(c.pathElement&&(e.pathElement=c.pathElement),i)){if(c.point&&(e.globalPosition=c.point.clone(),e.viewer&&e.viewer.currentViewpoint)){var p=e.viewer.currentViewpoint.project(c.point);e.smartMouse.x=Math.round(p.x),e.smartMouse.y=Math.round(p.y)}c.normal&&(e.globalNormal=c.normal.clone()),c.xAxis&&(e.globalXAxis=c.xAxis)}}getVersion(){return"3.1.2"}get detectableCanonics(){return this._canonicsButtonState}set detectableCanonics(e){"record"===this._experienceBase.odt&&this._experienceBase.getManager("VCXODTManager").LogAPI("CanonicsChangeDetectable",{detectableCanonics:e}),this._magnetDirty=!0,this._canonicsButtonState=e}get detectedCanonic(){return this._detectedCanonic}set detectedCanonic(e){let t=this._detectedCanonic&&this._detectedCanonic.measurable,i=e&&e.measurable;t===i&&this._detectedCanonic===e||(this.setFeedbackNode(null),t&&t.setActive(!1,this._detectedCanonic),i&&i.setActive(!0,e));let n=this._detectedCanonic&&this._detectedCanonic.associatedObject,a=e&&e.associatedObject;n!==a&&(this.getPreHighlightSet().clearAll(),a&&this.getPreHighlightSet().add(a.QueryInterface("W3AISGNodeHolder").getPathElement(),{highlightColor:this.peHighlightColor},!0)),this._detectedCanonic=e,this._experienceBase.getManager("VCXContextManager").getMainViewer().render()}get componentType(){return"VCXCanonicsManager"}}return p});