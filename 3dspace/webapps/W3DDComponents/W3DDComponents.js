define("DS/W3DDComponents/Views/AnnotationView/Graphics/History",["UWA/Class"],function(t){"use strict";return t.extend({init:function(t){this._content=[],this._ctx=t.context},repaint:function(){this.clear(),this.forEach(function(t){t.paint()})},clear:function(){this._ctx.clearRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height)},commit:function(t){this._content.push(t)},erase:function(t){var e=this._content.indexOf(t);-1!==e&&(this._content.splice(e,1),this.repaint())},forEach:function(t,e){this._content.forEach(function(i){t.call(e,i)})}})}),define("DS/W3DDComponents/Views/AnnotationView/Graphics/Graphics",["UWA/Class"],function(t){"use strict";return t.extend({init:function(t){this._ctx=t.context,this._sharedState=t.sharedState,this._commitState=null,this._history=t.history,this._p0=null,this._p1=null},intersects:function(){return!1},start:function(t){this._p1=Object.assign({},t)},draw:function(t){this._p0=this._p1,this._p1=Object.assign({},t)},commit:function(){this._commitState=Object.assign({},this._sharedState),this._history.commit(this)},paint:function(){}})}),define("DS/W3DDComponents/Views/AnnotationView/Toolbox/ColorPicker",["UWA/Core","UWA/Class/View"],function(t,e){"use strict";function i(t){var e=function(t){return t.match(/([0-9]+)/g).map(function(t){return parseInt(t)})}(t);return.299*e[0]+.587*e[1]+.114*e[2]}function n(t){return i(t)>=192}return e.extend({tagName:"div",className:"annotation-color-picker",init:function(e){var i;this._colors=e.colors,this._sharedState=e.sharedState,i=this.getColor(),this._dot=t.createElement("div",{class:this.className+"-dot "+this.className+"-color"}),this._palette=t.createElement("div",{class:this.className+"-palette",styles:{pointerEvents:"none",opacity:"0"},html:this._colors.map(function(t){return'<div data-color="'+t+'" style="background-color: '+t+';" class="fonticon fonticon-check '+this.className+"-color"+(i===t?" "+this.className+"-color-active":"")+(n(t)?" "+this.className+"-color-light":"")+'"></div>'},this).join("")}),this._setupEvents(),this._updateDotColor(),this._parent.apply(this,arguments)},setup:function(){this._dot.inject(this.container),this._palette.inject(this.container),this._parent.apply(this,arguments)},_setupEvents:function(){var t=this,e=this.className+"-color",i=e+"-active";t._dot.addEvent("click",function(){t._togglePalette()}),t._palette.getElements("."+e).forEach(function(e,n,s){e.addEvent("click",function(){s.forEach(function(t){t.removeClassName(i)}),e.addClassName(i),t.setColor(e.dataset.color)})})},_togglePalette:function(){"0"===this._palette.style.opacity?this._palette.setStyles({pointerEvents:"",opacity:"1"}):this._palette.setStyles({pointerEvents:"none",opacity:"0"})},getColor:function(){return this._sharedState.color||this._colors[0]},setColor:function(t){this._sharedState.color=t,this._updateDotColor()},_updateDotColor:function(){var t=this.getColor();this._dot.setStyle("background-color",t),this._dot.toggleClassName(this.className+"-color-light",n(t))}})}),define("DS/W3DDComponents/Views/PinView",["UWA/Core","UWA/Utils","UWA/Class/View","css!DS/W3DDComponents/Views/PinView"],function(t,e,i){"use strict";var n="function";return i.extend({tagName:"div",name:"pin-view",defaultOptions:{widgetIdOrUrl:"",widgetAppId:"",widgetTitle:"",widgetData:{},success:null,failure:null},setup:function(){this.container.addClassName(this.getClassNames())},render:function(){var e,i="clicked",s="added",o=this.container,a=this.options;return e=t.createElement("div",{class:this.getClassNames("-btn"),html:{tag:"div",class:"icon"},events:{click:function(){function o(){t.is(a.failure,n)&&a.failure()}e.addClassName(i),setTimeout(function(){this.removeClassName(i)}.bind(e),1e3);try{top.require(["DS/Dashboard/DashboardManager"],function(i){i.addModule({url:a.widgetIdOrUrl,appId:a.widgetAppId,data:a.widgetData,title:a.widgetTitle,success:function(){e.addClassName(s),t.is(a.success,n)&&a.success()},failure:o})})}catch(e){o(),t.log("Error while requiring top DS/Dashboard/DashboardManager from PinView.")}}}}),o.setContent(e),this},destroy:function(){this._parent.apply(this,arguments)}})}),define("DS/W3DDComponents/Views/AnnotationView/Toolbox/Tool",["UWA/Class/View"],function(t){"use strict";return t.extend({tagName:"div",className:"annotation-tool",domEvents:{click:"_setActive"},mode:"drawing",graphicsClass:null,init:function(t){this._icon=t.icon,this._name=t.name,this._sharedState=t.sharedState,this._parent.apply(this,arguments)},_setActive:function(){this._sharedState.activeTool=this._name},_isActive:function(){return this._sharedState.activeTool===this._name},getCursor:function(){return"auto"},render:function(){return this.container.setAttribute("class",this.className+" fonticon fonticon-"+this._icon+(this._isActive()?" "+this.className+"-active":"")),this._isActive()&&(this._sharedState.cursor=this.getCursor()),this}})}),define("DS/W3DDComponents/Views/RadioListView",["UWA/Core","UWA/Utils","UWA/Event","UWA/Class/View","DS/UIKIT/Input/Toggle","css!DS/W3DDComponents/Views/RadioListView"],function(t,e,i,n,s){"use strict";var o="checked";return n.extend({tagName:"div",name:"radiolist-view",defaultOptions:{name:"",displayRadio:!1,items:[],events:{onCheckItem:null}},items:[],setup:function(t){return t.name||(this.options.name="name-"+e.getUUID()),this.items=[],this.container.addClassName(this.getClassNames()),this},render:function(){var e=this,n=e.container,a=e.options,r=a.items;return n.empty(),r.forEach(function(r){!function(r){var h,c={};h=(r=r||{}).value,c.name=r.name||t.is(h,"string")?h:"",c.className=r.className||"",c.value=h||"",c.text=r.text||"",c.icon=r.icon||"",c.checked=r.checked||!1,e.items.push(c),function(r){var h,c=t.createElement;h=r.el=c("div",{class:"radio-el-ctn "+(r.checked?o:""),events:{click:function(t){i.preventDefault(t),e.checkItem(r)}}}),r.text&&h.addContent({tag:"div",class:"text",text:r.text}),r.icon&&h.addContent({tag:"div",class:"icon "+r.icon}),r.radio=new s({className:"rl-input-radio primary "+r.className,name:a.name,checked:r.checked,label:" "}).inject(h),a.displayRadio&&r.radio.getContent().setStyle("display","inline"),h.inject(n)}(c)}(r)}),e},checkItem:function(t){return t&&t.radio?(t.radio.check(!0),this.items.forEach(function(t){t.el.removeClassName(o)}),t.el.addClassName(o),this.dispatchEvent("onCheckItem",t),this):this},getChecked:function(){var t,e,i;for(t=0,e=this.items.length;t<e&&!(i=this.items[t]).radio.isChecked();t++);return i||this.items[0]||{}},setChecked:function(t){var e,i,n;for(e=0,i=this.items.length;e<i;e++)if((n=this.items[e]).name===t){this.checkItem(n);break}return this},destroy:function(){this.items=null,this._parent.apply(this,arguments)}})}),define("DS/W3DDComponents/Views/AnnotationView/Toolbox/Textarea",["UWA/Core","UWA/Class/View"],function(t,e){"use strict";return e.extend({tagName:"div",className:"annotation-textarea",init:function(e){this._sharedState=e.sharedState,this._boundary=e.boundary,this._onMove=e.onMove,this._computedStyle=null,this._position={x:0,y:0},this._textarea=t.createElement("textarea"),this._dragGrip=t.createElement("span",{class:this.className+"-drag-grip fonticon fonticon-drag-grip"}),this._parent.apply(this,arguments)},setup:function(){this._textarea.inject(this.container),this._dragGrip.inject(this.container),this._computedStyle=window.getComputedStyle(this._textarea),this._setupDrag(),this._parent.apply(this,arguments)},_setupDrag:function(){var t=this;t._dragGrip.addEvent("mousedown",function(e){var i=!1,n=t._boundary.getBoundingClientRect();function s(e){if(i||(i=!0,t._boundary.style.cursor=t._dragGrip.style.cursor=t.container.style.cursor="grabbing"),e.clientX<n.left||e.clientY<n.top||e.clientX>n.right||e.clientY>n.bottom)return o();t._move({x:t._position.x+e.movementX,y:t._position.y+e.movementY}),e.preventDefault(),e.stopPropagation()}function o(){i&&(i=!1,t._boundary.style.cursor=t._dragGrip.style.cursor=t.container.style.cursor=""),document.removeEvent("mousemove",s,!0),document.removeEvent("mouseup",o,!0)}document.addEvent("mousemove",s,!0),document.addEvent("mouseup",o,!0),e.preventDefault(),e.stopPropagation()})},_move:function(t){var e=this._boundary.getBoundingClientRect(),i=this.container.getBoundingClientRect(),n=Object.assign({},this._position),s=this._getCaretOffset();this._position.x=Math.max(0,Math.min(e.width-i.width,t.x)),this._position.y=Math.max(0,Math.min(e.height-i.height,t.y)),this._position.x===n.x&&this._position.y===n.y||(this.container.style.left=Math.round(this._position.x)+"px",this.container.style.top=Math.round(this._position.y)+"px",this._onMove({x:(this._position.x+s.x)/e.width,y:(this._position.y+s.y)/e.height}))},updatePosition:function(t){var e=this._boundary.getBoundingClientRect(),i=this._getCaretOffset();this._move({x:t.x*e.width-i.x,y:t.y*e.height-i.y})},updateStyles:function(){var t=this._textarea.style,e=this._sharedState;t.caretColor=t.color=e.color,t.fontWeight=e.fontWeight,t.fontSize=e.fontSize+"px",t.fontFamily=e.fontFamily,t.lineHeight=e.lineHeight+"px"},getContent:function(){return this._textarea.value},enable:function(){this.container.show(),this._textarea.focus()},disable:function(){this.container.hide(),this._textarea.value=""},_getCaretOffset:function(){var t=this._computedStyle;return{x:parseInt(t.paddingLeft)+parseInt(t.borderLeftWidth),y:parseInt(t.paddingTop)+parseInt(t.borderTopWidth)}}})}),define("DS/W3DDComponents/Views/DragView",["UWA/Core","UWA/Event","UWA/Utils","UWA/Utils/Client","UWA/Element","UWA/Json","UWA/Class/View","UWA/Controls/Drag","DS/WebappsUtils/WebappsUtils","css!DS/W3DDComponents/Views/DragView"],function(t,e,i,n,s,o,a,r,h){"use strict";var c;try{top.require(["DS/UWPClientCode/PublicAPI"],function(t){c=t})}catch(e){t.log("Error while requiring top DS/UWPClientCode/PublicAPI from DragView.")}return a.extend({DRAG_CLASS:"drag-handle",CREATE_WIDGET_CLASS:"create-widget",NO_USER_SELECT_CSS:{"-webkit-tap-highlight-color":"rgba(0, 0, 0, 0)","-webkit-touch-callout":"none","-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none"},DEFAULT_DRAG_ICON:"",name:"drag-view",tagName:"div",defaultOptions:{element:null,sourceWidgetId:"",widgetAppId:"",widgetIdOrUrl:"",widgetTitle:"",widgetData:{},widgetIcon:""},_inIframe:!1,_env:null,_resetUserSelectTimeout:null,_drag:null,_browserIsTouch:!1,_isDragging:!1,_fakeEl:null,setup:function(t){var e,i,s;if(this._inIframe=self.location!==top.location,this._inIframe){for(this.DEFAULT_DRAG_ICON=h.getWebappsAssetUrl("W3DDComponents","DragView_DefaultDragIcon.png"),e=parent.UWA.Widgets.instances,i=0;i<e.length&&(!(s=e[i].environment).embedded||s.embedded.id!==t.sourceWidgetId);i++);this._env=s}this._browserIsTouch=n.Features.touchEvents,this.container.addClassName(this.getClassNames())},render:function(){var t,e=this.container,n=this.options;return e.setContent(n.element),e.setStyles(this.NO_USER_SELECT_CSS),this._inIframe?(t=this.DRAG_CLASS+"-"+i.getUUID(),e.addClassName(t),this._drag=new r.Move({snap:20,delegate:"."+t+", ."+t+" *",delay:this._browserIsTouch?20:0,centerHandles:!0,handles:this._onDragHandles.bind(this),start:this._onDragStart.bind(this),leave:this._onDragLeave.bind(this),stop:this._onDragStop.bind(this),drop:this._onDragDrop.bind(this),cancel:this._onDragCancel.bind(this)})):(e.addClassName(this.CREATE_WIDGET_CLASS),this._setWidgetAttributes(e)),this},destroy:function(){this._fakeEl&&this._fakeEl.destroy(),this._fakeEl=null,this._env=this._resetUserSelectTimeout=this._drag=null,this._browserIsTouch=this._isDragging=this._inIframe=!1,this._parent.apply(this,arguments)},_setWidgetAttributes:function(t){var e=this.options;c.enableDragAndInstantiation({element:t,title:e.widgetTitle,url:e.widgetIdOrUrl,appId:e.appId,data:o.encode(e.widgetData),icon:e.widgetIcon,trusted:!0})},_resetUserSelect:function(){s.setStyles.call(document.body,{"-webkit-tap-highlight-color":"","-webkit-touch-callout":"","-webkit-user-select":"","-moz-user-select":"","-ms-user-select":"","user-select":""}),this._resetUserSelectTimeout=null},_clearDragBeforeEnd:function(t){t.handles&&t.handles.destroy(),this._isDragging=!1,this._resetUserSelectTimeout=setTimeout(this._resetUserSelect.bind(this),1e3)},_onDragHandles:function(i){return e.stop(i),this._resetUserSelectTimeout?clearTimeout(this._resetUserSelectTimeout):s.setStyles.call(document.body,this.NO_USER_SELECT_CSS),t.createElement("img",{class:this.getClassNames()+"-ghost",src:this.options.widgetIcon||this.DEFAULT_DRAG_ICON}).inject(document.body)},_onDragStart:function(t){e.stop(t),this._isDragging=!0},_onDragLeave:function(i){var n,s,o,a,r,h,c,l,d,u,_={};e.stop(i),this._isDragging&&(this._onDragStop(i),this._clearDragBeforeEnd(i),r=this._fakeEl,u=this._browserIsTouch,t.is(r,"element")||(this._fakeEl=r=t.createElement("div",{class:this.CREATE_WIDGET_CLASS}),(a=top.document.body.getElement(".wi-"+this._env.widget.id)).addContent(r)),this._setWidgetAttributes(r),u&&(n=a.getPosition(top.document.body),s=i.currentEvent.touches[0],h=document.createTouch(window,s.target,s.identifier,s.pageX+n.x+15,s.pageY+n.y+50,s.screenX,s.screenY),c=document.createTouchList(h),l=document.createTouchList(h),d=document.createTouchList(h),(o=document.createEvent("TouchEvent")).initTouchEvent("touchstart",!0,!0,top.window,null,0,0,0,0,!1,!1,!1,!1,c,l,d,1,0),_={eventType:o.type,canBubble:o.bubbles,cancelable:o.cancelable,view:o.view,detail:o.detail,screenX:o.layerX,screenY:o.layerY,clientX:o.pageX,clientY:o.pageY,ctrlKey:o.ctrlKey,altKey:o.altKey,shiftKey:o.shiftKey,metaKey:o.metaKey,touches:o.touches,targetTouches:o.targetTouches,changedTouches:o.changedTouches,scale:o.scale,rotation:o.rotation}),e.dispatchEvent(r,u?"touchstart":"mousedown",_))},_onDragStop:function(t){e.stop(t),this._clearDragBeforeEnd(t)},_onDragDrop:function(t){this._onDragStop(t)},_onDragCancel:function(t){this._onDragStop(t)}})}),define("DS/W3DDComponents/Views/AnnotationView/Graphics/Eraser",["DS/W3DDComponents/Views/AnnotationView/Graphics/Graphics"],function(t){"use strict";return t.extend({start:function(){this._parent.apply(this,arguments),this._erase({a:this._p1,b:this._p1})},draw:function(){this._parent.apply(this,arguments),this._erase({a:this._p0,b:this._p1})},commit:function(){},_erase:function(t){this._history.forEach(function(e){e.intersects(t)&&this._history.erase(e)},this)}})}),define("DS/W3DDComponents/Views/AnnotationView/Graphics/Pencil",["DS/W3DDComponents/Views/AnnotationView/Graphics/Graphics"],function(t){"use strict";function e(t,e){return{x:t.x*e.width,y:t.y*e.height}}function i(t,e){return{x:t.x-e/2,y:t.y-e/2,w:e,h:e}}function n(t,e){return t.x+t.w>=e.x&&e.x+e.w>=t.x&&t.y+t.h>=e.y&&e.y+e.h>=t.y}return t.extend({init:function(){this._parent.apply(this,arguments),this._points=[]},intersects:function(t){for(var s,o,a,r,h,c,l,d,u=this._ctx.canvas,_=this._commitState.drawingWidth,p={a:e(t.a,u),b:e(t.b,u)},m=0;m<this._points.length;++m){if(n(o=i(s=e(this._points[m],u),_),i(p.a,_))||n(o,i(p.b,_)))return!0;if(this._points[m+1]&&(a=e(this._points[m+1],u),h=p,c=void 0,l=void 0,d=void 0,0!=(c=((r={a:s,b:a}).b.x-r.a.x)*(h.b.y-h.a.y)-(h.b.x-h.a.x)*(r.b.y-r.a.y))&&(d=((h.b.y-h.a.y)*(h.b.x-r.a.x)+(h.a.x-h.b.x)*(h.b.y-r.a.y))/c,l=((r.a.y-r.b.y)*(h.b.x-r.a.x)+(r.b.x-r.a.x)*(h.b.y-r.a.y))/c,d>0&&d<1&&l>0&&l<1)))return!0}return!1},start:function(){this._parent.apply(this,arguments),this._points.push(this._p1),this._drawLineStart(this._p1,this._sharedState)},draw:function(){this._parent.apply(this,arguments),this._points.push(this._p1),this._drawLine({a:this._p0,b:this._p1},this._sharedState)},paint:function(){this._drawLineStart(this._points[0],this._commitState);for(var t=1;t<this._points.length;++t)this._drawLine({a:this._points[t-1],b:this._points[t]},this._commitState)},_drawLineStart:function(t,e){var i=e.drawingWidth;this._ctx.beginPath(),this._ctx.fillStyle=e.color,this._ctx.fillRect(t.x*this._ctx.canvas.width-i/2,t.y*this._ctx.canvas.height-i/2,i,i),this._ctx.closePath()},_drawLine:function(t,e){var i=this._ctx.canvas.width,n=this._ctx.canvas.height;this._ctx.beginPath(),this._ctx.moveTo(t.a.x*i,t.a.y*n),this._ctx.lineTo(t.b.x*i,t.b.y*n),this._ctx.strokeStyle=e.color,this._ctx.lineWidth=e.drawingWidth,this._ctx.stroke(),this._ctx.closePath()}})}),define("DS/W3DDComponents/Views/AnnotationView/Toolbox/Eraser",["DS/W3DDComponents/Views/AnnotationView/Toolbox/Tool","DS/W3DDComponents/Views/AnnotationView/Graphics/Eraser"],function(t,e){"use strict";return t.extend({graphicsClass:e,init:function(t){this._parent({name:"eraser",icon:"eraser",sharedState:t.sharedState})},getCursor:function(){var t=document.createElement("canvas"),e=t.getContext("2d"),i=window.getComputedStyle(this.container,"::before").content.replace(/"/g,"");return t.width=t.height=24,e.fillStyle="rgb(72, 72, 74)",e.textBaseline="top",e.font="normal 24px entypo",e.fillText(i,0,0),"url("+t.toDataURL("image/png")+") 0 23, auto"}})}),define("DS/W3DDComponents/Views/AnnotationView/Toolbox/Pencil",["DS/W3DDComponents/Views/AnnotationView/Toolbox/Tool","DS/W3DDComponents/Views/AnnotationView/Graphics/Pencil"],function(t,e){"use strict";return t.extend({graphicsClass:e,init:function(t){this._parent({name:"pencil",icon:"pencil",sharedState:t.sharedState})},getCursor:function(){var t=document.createElement("canvas"),e=t.getContext("2d"),i=this._sharedState.drawingWidth,n=Math.floor(i/2);return t.width=t.height=i,e.beginPath(),e.fillStyle=this._sharedState.color,e.fillRect(0,0,i,i),e.closePath(),"url("+t.toDataURL("image/png")+") "+n+" "+n+", auto"}})}),define("DS/W3DDComponents/Views/AnnotationView/Graphics/Text",["DS/W3DDComponents/Views/AnnotationView/Graphics/Graphics"],function(t){"use strict";return t.extend({init:function(){this._parent.apply(this,arguments),this._location={x:-1,y:-1},this._bbox={x:1/0,y:1/0,w:-1/0,h:-1/0}},intersects:function(t){var e=this._ctx.canvas;return t.b.x*e.width>=this._location.x*e.width+this._bbox.x&&t.b.x*e.width<this._location.x*e.width+this._bbox.x+this._bbox.w&&t.b.y*e.height>=this._location.y*e.height+this._bbox.y&&t.b.y*e.height<this._location.y*e.height+this._bbox.y+this._bbox.h},commit:function(){this._parent.apply(this,arguments),this._location=Object.assign({},this._p1),this.paint(),this._commitState.text.split("\n").forEach(function(t,e){var i=this._ctx.measureText(t);this._bbox.x=Math.min(this._bbox.x,i.actualBoundingBoxLeft),this._bbox.y=0===e?i.actualBoundingBoxAscent:this._bbox.y,this._bbox.w=Math.max(this._bbox.w,i.actualBoundingBoxRight-i.actualBoundingBoxLeft),this._bbox.h=e*this._commitState.lineHeight+i.actualBoundingBoxDescent},this)},paint:function(){var t=this._location.x*this._ctx.canvas.width,e=this._location.y*this._ctx.canvas.height;this._parent.apply(this,arguments),this._ctx.fillStyle=this._commitState.color,this._ctx.textBaseline="top",this._ctx.font=this._commitState.fontWeight+" "+this._commitState.fontSize+"px "+this._commitState.fontFamily,this._commitState.text.split("\n").forEach(function(i,n){this._ctx.fillText(i,t,e+n*this._commitState.lineHeight)},this)}})}),define("DS/W3DDComponents/Views/AnnotationView/Toolbox/Text",["DS/W3DDComponents/Views/AnnotationView/Toolbox/Tool","DS/W3DDComponents/Views/AnnotationView/Graphics/Text"],function(t,e){"use strict";return t.extend({mode:"text",graphicsClass:e,init:function(t){this._parent({name:"text",icon:"text",sharedState:t.sharedState})},getCursor:function(){return"text"}})}),define("DS/W3DDComponents/Views/AnnotationView",["UWA/Core","UWA/Class/View","DS/W3DDComponents/Views/AnnotationView/Toolbox/ColorPicker","DS/W3DDComponents/Views/AnnotationView/Toolbox/Textarea","DS/W3DDComponents/Views/AnnotationView/Toolbox/Pencil","DS/W3DDComponents/Views/AnnotationView/Toolbox/Text","DS/W3DDComponents/Views/AnnotationView/Toolbox/Eraser","DS/W3DDComponents/Views/AnnotationView/Graphics/History","css!DS/W3DDComponents/Views/AnnotationView"],function(t,e,i,n,s,o,a,r){"use strict";function h(t,e){return{x:t.x/e.width,y:t.y/e.height}}var c=["rgb(255, 0, 0)","rgb(255, 153, 0)","rgb(255, 255, 0)","rgb(0, 204, 0)","rgb(0, 51, 255)","rgb(102, 0, 153)","rgb(0, 0, 0)","rgb(255, 255, 255)"],l=void 0;return e.extend({tagName:"div",className:"annotation-view",init:function(e){this._annotated=t.extendElement(e.annotated),this._sharedState={},this._canvas=t.createElement("canvas",{class:"annotation-canvas"}),this._ctx=this._canvas.getContext("2d"),this._textarea=new n({sharedState:this._sharedState,boundary:this._canvas,onMove:this._onTextareaMove.bind(this)}),this._toolbox=t.createElement("div",{class:"annotation-toolbox"}),this._colorPicker=new i({colors:c,sharedState:this._sharedState}),this._tools={pencil:new s({sharedState:this._sharedState}),text:new o({sharedState:this._sharedState}),eraser:new a({sharedState:this._sharedState})},this._graphics=null,this._history=new r({context:this._ctx}),this._p0=null,this._p1=null,this._drawing=!1,this._writing=null,this._inbounds=!0,this._resizeHandler=this._onResize.bind(this),this._initSharedState(),this._setupEvents(),this._onResize(),this._parent.apply(this,arguments)},setup:function(){this._canvas.inject(this.container),this._colorPicker.container.inject(this._toolbox),this._tools.pencil.container.inject(this._toolbox),this._tools.text.container.inject(this._toolbox),this._tools.eraser.container.inject(this._toolbox),this._toolbox.inject(this.container),this._textarea.container.inject(this.container),this.container.inject(this._annotated),this._parent.apply(this,arguments)},destroy:function(){this._annotated.removeEvent("resize",this._resizeHandler),this._parent.apply(this,arguments)},_initSharedState:function(){function t(t){return{get:function(){return i[t]},set:function(n){i[t]=n,e._textarea.updateStyles(),i.activeTool&&e.render()},enumerable:!0}}var e=this,i={},n=t("color");Object.defineProperties(this._sharedState,{color:Object.assign({},n,{set:function(t){i.color!==t&&(n.set(t),e._colorPicker.setColor(t),l=t)}}),drawingWidth:t("drawingWidth"),fontWeight:t("fontWeight"),fontSize:t("fontSize"),fontFamily:t("fontFamily"),lineHeight:t("lineHeight"),activeTool:{get:function(){return i.activeTool},set:function(t){i.activeTool=t,"text"!==e._getMode()&&(e._textarea.disable(),e._writing=null),e.render()},enumerable:!0},cursor:{get:function(){return i.cursor},set:function(t){i.cursor=t,e._canvas.style.cursor=t},enumerable:!0},text:{get:function(){return e._textarea.getContent()},enumerable:!0}}),this._sharedState.color=l||c[0],this._sharedState.drawingWidth=4,this._sharedState.fontWeight="bold",this._sharedState.fontSize=28,this._sharedState.fontFamily="Arial",this._sharedState.lineHeight=32,this._sharedState.activeTool="pencil"},_onResize:function(){var t=this._annotated.getBoundingClientRect();this._canvas.width=t.width,this._canvas.height=t.height,this._writing&&this._textarea.updatePosition(this._writing),this._history.repaint()},_setupEvents:function(){var t,e=this;t={mouseenter:"in",mousedown:"down",touchstart:"down",mousemove:"move",touchmove:"move",mouseout:"out",mouseup:"up",touchend:"up"},Object.keys(t).forEach(function(i){e._canvas.addEvent(i,function(n){e._handleEvent(t[i],{x:n.offsetX,y:n.offsetY})},!1)}),[{name:"mousedown",pointerEvents:"none"},{name:"touchstart",pointerEvents:"none"},{name:"mouseup",pointerEvents:"all"},{name:"touchend",pointerEvents:"all"}].forEach(function(t){e._canvas.addEvent(t.name,function(){e._toolbox.style.pointerEvents=t.pointerEvents})}),e._annotated.addEvent("resize",e._resizeHandler)},_handleEvent:function(t,e){var i=this._getMode();"down"===t&&(this._updateCoordinates(e),"text"===i?this._drawing=!1:this._drawing||(this._drawing=!0,this._writing=null,this._startGraphics())),"up"===t&&(this._drawing=!1,"text"===i?this._writing?(this._commitGraphics(),this._writing=null):(this._writing=h(e,this._canvas),this._startGraphics()):this._commitGraphics()),"move"===t&&this._drawing&&this._inbounds&&(this._updateCoordinates(e),this._drawGraphics()),"in"===t&&(this._inbounds=!0,this._updateCoordinates(e),this._drawing&&this._startGraphics()),"out"===t&&(this._inbounds=!1,this._drawing&&this._commitGraphics())},_updateCoordinates:function(t){this._p0=this._p1,this._p1=h(t,this._canvas)},_onTextareaMove:function(t){this._writing&&(this._writing=t,this._drawGraphics())},_startGraphics:function(){this._graphics=new this._tools[this._sharedState.activeTool].graphicsClass({history:this._history,context:this._ctx,sharedState:this._sharedState}),this._graphics.start(this._writing||this._p1),this._writing?(this._textarea.updatePosition(this._writing),this._textarea.enable()):this._textarea.disable()},_drawGraphics:function(){this._graphics.draw(this._writing||this._p1)},_commitGraphics:function(){this._writing?(this._sharedState.text&&this._graphics.commit(),this._textarea.disable()):this._graphics.commit()},_getMode:function(){return this._tools[this._sharedState.activeTool].mode},render:function(){return this._colorPicker.render(),this._tools.pencil.render(),this._tools.text.render(),this._tools.eraser.render(),this._history.repaint(),this}})});